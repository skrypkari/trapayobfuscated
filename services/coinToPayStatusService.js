'use strict';const a37_0x27bc26=a37_0x4b05;(function(_0x43b19d,_0x5dd396){const _0x74edde=a37_0x4b05,_0x55b922=_0x43b19d();while(!![]){try{const _0x49ddd2=-parseInt(_0x74edde(0x222))/0x1*(-parseInt(_0x74edde(0x18b))/0x2)+parseInt(_0x74edde(0x1e3))/0x3+parseInt(_0x74edde(0x1ba))/0x4+-parseInt(_0x74edde(0x20e))/0x5+parseInt(_0x74edde(0x186))/0x6*(-parseInt(_0x74edde(0x1d3))/0x7)+parseInt(_0x74edde(0x1f3))/0x8+-parseInt(_0x74edde(0x20d))/0x9;if(_0x49ddd2===_0x5dd396)break;else _0x55b922['push'](_0x55b922['shift']());}catch(_0x6bc2e3){_0x55b922['push'](_0x55b922['shift']());}}}(a37_0x1904,0x63cea));var __importDefault=this&&this[a37_0x27bc26(0x1ca)]||function(_0x22c1ab){const _0x1ff0a1=a37_0x27bc26;return _0x22c1ab&&_0x22c1ab[_0x1ff0a1(0x18f)]?_0x22c1ab:{'default':_0x22c1ab};};function a37_0x1904(){const _0x5eee16=['⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','push','description','POST','\x20is\x20older\x20than\x20','toFixed','50070jcNCYn','✅\x20[EXPIRY]\x20Payment\x20','\x20expired','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','⏰\x20[GLOBAL]\x20Payment\x20','\x20\x20\x20📅\x20Time:\x20','map','-day\x20timeout','getServiceStats','transactionId','\x20\x20\x20-\x20GatewayPaymentId:\x20','currency','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','timestamp','h),\x20skipping\x20global\x20check','\x20details:','3869704sYCxTr','\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','message','\x20\x20\x20-\x20ShopId:\x20','has','\x20status\x20is\x20','payment','not\x20confirmed','CoinToPayService','FAILED','adminNotes','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','PAID','Payment\x20older\x20than\x20','📊\x20[CHECK]\x20Payment\x20','webhookUrl','🧹\x20[DEBUG]\x20Clearing\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','Success','\x20\x20\x20📝\x20Context:','TesSoft\x20Payment\x20System/1.0','paymentDetails','Payment\x20not\x20found','gatewayPaymentId','1179423uhVnHX','2871630CwEXDN','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','default','\x20days\x20without\x20payment\x20confirmation','💰\x20[CHECK]\x20Payment\x20','update','\x20individual\x20payment\x20timers','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','setDate','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','createdOn','2\x20minutes','cointopay_auto_expired','includes','checkPaymentById','length','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','schedule_created','orderId','17OVmGNR','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','paidAt','shop','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','\x20not\x20found,\x20clearing\x20timers','shopId','checkSinglePayment','./loggerService','values','\x20(after\x20','❌\x20[HOURLY]\x20Payment\x20','logShopWebhookSent','catch','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20status\x20unchanged\x20(','../config/database','\x20status:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🛑\x20[SHUTDOWN]\x20Cleared\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20\x20\x20-\x20paymentId:\x20','toISOString','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','CoinToPayStatusService','stringify','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','🪙\x20CoinToPayStatusService\x20initialized','clearPaymentTimers','telegramBotService','payment.pending','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','payment.failed','⏰\x20[GLOBAL]\x20Found\x20','checkExpiredPayments','Shop\x20webhook\x20sent\x20to\x20','\x20(age:\x20','gatewayOrderId','\x20->\x20','logCoinToPayStatus','PENDING','0100','size','set','auto_expire','loggerService','customerEmail','bankDetails','createdAt','globalCheckInterval','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','⚠️\x20[CHECK]\x20Payment\x20',',\x20stopping\x20individual\x20checks','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20\x20\x20📊\x20Status:\x20','floor','\x20current\x20status:\x20','GLOBAL_CHECK_INTERVAL_MS','\x20to\x20clear','\x20triggered\x20for\x20payment\x20','\x20updated\x20successfully','EXPIRY_DAYS','\x20\x20\x20-\x20Gateway:\x20','❌\x20[CHECK]\x20Payment\x20','\x20seconds\x20(','54MPEsaR','\x20days','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Failed\x20to\x20send\x20shop\x20webhook:','38546HyrJci','coinToPayService','paymentId','unknown','__esModule','./telegramBotService','failed','sendShopWebhook','\x20\x20\x20📍\x20Source:\x20','\x20\x20\x20📝\x20Details:','/status/','\x20\x20\x20❌\x20Error:\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','payment.success','\x20has\x20no\x20gatewayPaymentId','\x20timers\x20for\x20payment\x20','error','\x20initial\x20timers\x20for\x20payment\x20','create','defineProperty','iban','Failed\x20to\x20mark\x20payment\x20as\x20expired','./gateways/coinToPayService','✅\x20[CHECK]\x20Payment\x20','checkAllPendingPayments','🪙\x20[GLOBAL]\x20Found\x20','stopPeriodicStatusCheck','COINTOPAY_STATUS_CHANGE','delay','created','logShopWebhookError','application/json','getPaymentTimerInfo','log','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','amount','\x20\x20\x20-\x20Amount:\x20','settings','gateway','status','expired','findUnique','\x20days\x20(created\x20before\x20','Bank\x20Details:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','EXPIRED','\x20skipped,\x20','1544732YdNSHZ','timers','schedulePaymentChecks','\x20pending\x20CoinToPay\x20payments','confirmedOn','getTime','\x20status\x20from\x20','\x20to\x20','toLowerCase','sendPaymentStatusNotification','\x20with\x20status\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','checkSinglePaymentById','cointopay','coinToPayStatusService','✅\x20[TIMER]\x20Individual\x20check\x20#','__importDefault','🔄\x20[CHECK]\x20Updating\x20payment\x20','webhookLog','forEach','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','status_check','⏰\x20[EXPIRY]\x20Payment\x20','cointopay_status_check_','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','77812SxVlMF','⏰\x20[HOURLY]\x20Payment\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','paymentTimers','now','startPeriodicStatusCheck','\x20is\x20too\x20new\x20(','logCoinToPayError'];a37_0x1904=function(){return _0x5eee16;};return a37_0x1904();}Object[a37_0x27bc26(0x19e)](exports,a37_0x27bc26(0x18f),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x27bc26(0x23e)]=void 0x0;function a37_0x4b05(_0x48900e,_0x5212e5){const _0x1904c0=a37_0x1904();return a37_0x4b05=function(_0x4b0547,_0x58bf5d){_0x4b0547=_0x4b0547-0x186;let _0x38ce0c=_0x1904c0[_0x4b0547];return _0x38ce0c;},a37_0x4b05(_0x48900e,_0x5212e5);}const coinToPayService_1=require(a37_0x27bc26(0x1a1)),database_1=__importDefault(require(a37_0x27bc26(0x236))),telegramBotService_1=require(a37_0x27bc26(0x190)),loggerService_1=require(a37_0x27bc26(0x22e));class CoinToPayStatusService{constructor(){const _0xb6d2c2=a37_0x27bc26;this[_0xb6d2c2(0x258)]=null,this[_0xb6d2c2(0x262)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0xb6d2c2(0x1d6)]=new Map(),this[_0xb6d2c2(0x18c)]=new coinToPayService_1[(_0xb6d2c2(0x1fc))](),console[_0xb6d2c2(0x1ac)](_0xb6d2c2(0x241));}[a37_0x27bc26(0x1bc)](_0x585388,_0x2ed0dd){const _0x1739bc=a37_0x27bc26;console['log'](_0x1739bc(0x1ce)),console[_0x1739bc(0x1ac)](_0x1739bc(0x23b)+_0x585388),console[_0x1739bc(0x1ac)]('\x20\x20\x20-\x20gatewayPaymentId:\x20'+_0x2ed0dd),this[_0x1739bc(0x242)](_0x585388);const _0x4af606=[],_0x32c159=new Date(),_0x9d48b9=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x1739bc(0x21a)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x1739bc(0x1ac)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x9d48b9[_0x1739bc(0x21e)]+_0x1739bc(0x19c)+_0x585388);let _0x241245=0x0;_0x9d48b9[_0x1739bc(0x1cd)]((_0x8bf429,_0xf8a8a3)=>{const _0x496925=_0x1739bc;_0x241245+=_0x8bf429[_0x496925(0x1a7)];const _0x28c123=setTimeout(async()=>{const _0xd3568c=_0x496925;console[_0xd3568c(0x1ac)]('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0xf8a8a3+0x1)+_0xd3568c(0x264)+_0x585388+_0xd3568c(0x230)+_0x8bf429['description']+')');try{await this['checkSinglePaymentById'](_0x585388),console['log'](_0xd3568c(0x1c9)+(_0xf8a8a3+0x1)+'\x20completed\x20for\x20payment\x20'+_0x585388);}catch(_0x536fcd){console[_0xd3568c(0x19b)](_0xd3568c(0x228)+(_0xf8a8a3+0x1)+'\x20for\x20payment\x20'+_0x585388+':',_0x536fcd),this['logCoinToPayError'](_0x585388,_0x2ed0dd,_0x536fcd,_0xd3568c(0x1cf),{'checkNumber':_0xf8a8a3+0x1,'scheduledAfter':_0x8bf429[_0xd3568c(0x1df)],'isIndividualCheck':!![]});}},_0x241245);_0x4af606[_0x496925(0x1de)](_0x28c123),console[_0x496925(0x1ac)](_0x496925(0x1db)+(_0xf8a8a3+0x1)+'\x20for\x20payment\x20'+_0x585388+'\x20in\x20'+_0x241245/0x3e8+_0x496925(0x269)+_0x8bf429['description']+')');});const _0x52fad6=setInterval(async()=>{const _0x322c52=_0x1739bc;console[_0x322c52(0x1ac)](_0x322c52(0x20f)+_0x585388);try{const _0x149a3f=await database_1[_0x322c52(0x211)][_0x322c52(0x1fa)]['findUnique']({'where':{'id':_0x585388},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x149a3f){console[_0x322c52(0x1ac)](_0x322c52(0x231)+_0x585388+_0x322c52(0x22b)),this[_0x322c52(0x242)](_0x585388);return;}console[_0x322c52(0x1ac)]('📊\x20[HOURLY]\x20Payment\x20'+_0x585388+_0x322c52(0x261)+_0x149a3f[_0x322c52(0x1b2)]);if(_0x149a3f[_0x322c52(0x1b2)]!==_0x322c52(0x24f)){console[_0x322c52(0x1ac)]('✅\x20[HOURLY]\x20Payment\x20'+_0x585388+_0x322c52(0x1f9)+_0x149a3f[_0x322c52(0x1b2)]+_0x322c52(0x25b)),this[_0x322c52(0x242)](_0x585388);return;}const _0x55d7cf=Math['floor']((Date[_0x322c52(0x1d7)]()-_0x149a3f[_0x322c52(0x257)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x55d7cf>=this['EXPIRY_DAYS']){console['log'](_0x322c52(0x1d4)+_0x585388+_0x322c52(0x1e1)+this[_0x322c52(0x266)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x585388);return;}await this[_0x322c52(0x1c6)](_0x585388),console[_0x322c52(0x1ac)](_0x322c52(0x259)+_0x585388);}catch(_0x3ab841){console[_0x322c52(0x19b)](_0x322c52(0x1ff)+_0x585388+':',_0x3ab841),this[_0x322c52(0x1da)](_0x585388,_0x2ed0dd,_0x3ab841,'status_check',{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x4af606[_0x1739bc(0x1de)](_0x52fad6),this[_0x1739bc(0x1d6)][_0x1739bc(0x252)](_0x585388,{'timers':_0x4af606,'paymentId':_0x585388,'gatewayPaymentId':_0x2ed0dd,'createdAt':_0x32c159}),console[_0x1739bc(0x1ac)](_0x1739bc(0x240)+_0x9d48b9['length']+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x585388),console[_0x1739bc(0x1ac)]('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this['paymentTimers'][_0x1739bc(0x251)]),this[_0x1739bc(0x24e)](_0x585388,_0x2ed0dd,_0x1739bc(0x24f),_0x1739bc(0x24f),_0x1739bc(0x1cf),{'action':_0x1739bc(0x220),'scheduledChecks':_0x9d48b9[_0x1739bc(0x21e)],'firstCheckIn':_0x9d48b9[0x0][_0x1739bc(0x1a7)]/0x3e8,'totalTimers':this[_0x1739bc(0x1d6)][_0x1739bc(0x251)]});}[a37_0x27bc26(0x242)](_0x3a87fb){const _0x5f56c5=a37_0x27bc26,_0x3162a7=this[_0x5f56c5(0x1d6)]['get'](_0x3a87fb);_0x3162a7?(console[_0x5f56c5(0x1ac)](_0x5f56c5(0x205)+_0x3162a7[_0x5f56c5(0x1bb)][_0x5f56c5(0x21e)]+_0x5f56c5(0x19a)+_0x3a87fb),_0x3162a7[_0x5f56c5(0x1bb)][_0x5f56c5(0x1cd)]((_0x53ff9d,_0x3ad059)=>{const _0x2c0c32=_0x5f56c5;_0x53ff9d&&(clearTimeout(_0x53ff9d),clearInterval(_0x53ff9d),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x3ad059+0x1)+_0x2c0c32(0x1f4)+_0x3a87fb));}),this[_0x5f56c5(0x1d6)]['delete'](_0x3a87fb),console[_0x5f56c5(0x1ac)](_0x5f56c5(0x197)+_0x3a87fb+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x5f56c5(0x1d6)]['size'])):console['log'](_0x5f56c5(0x1d2)+_0x3a87fb+_0x5f56c5(0x263));}async[a37_0x27bc26(0x1c6)](_0x32b52f){const _0x38333c=a37_0x27bc26;console[_0x38333c(0x1ac)]('🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x32b52f);const _0x44f50c=await database_1[_0x38333c(0x211)][_0x38333c(0x1fa)][_0x38333c(0x1b4)]({'where':{'id':_0x32b52f},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x44f50c){console[_0x38333c(0x1ac)](_0x38333c(0x268)+_0x32b52f+'\x20not\x20found\x20in\x20database');return;}console[_0x38333c(0x1ac)](_0x38333c(0x203)+_0x32b52f+'\x20found:'),console[_0x38333c(0x1ac)](_0x38333c(0x267)+_0x44f50c[_0x38333c(0x1b1)]),console[_0x38333c(0x1ac)]('\x20\x20\x20-\x20Status:\x20'+_0x44f50c[_0x38333c(0x1b2)]),console[_0x38333c(0x1ac)](_0x38333c(0x1ed)+_0x44f50c['gatewayPaymentId']),console[_0x38333c(0x1ac)](_0x38333c(0x1af)+_0x44f50c['amount']+'\x20'+_0x44f50c['currency']),console[_0x38333c(0x1ac)](_0x38333c(0x1f7)+_0x44f50c[_0x38333c(0x22c)]);if(_0x44f50c[_0x38333c(0x1b1)]!==_0x38333c(0x1c7)){console[_0x38333c(0x1ac)](_0x38333c(0x25a)+_0x32b52f+_0x38333c(0x25e)+_0x44f50c[_0x38333c(0x1b1)]+')');return;}if(_0x44f50c[_0x38333c(0x1b2)]!==_0x38333c(0x24f)){console[_0x38333c(0x1ac)](_0x38333c(0x25a)+_0x32b52f+_0x38333c(0x1f9)+_0x44f50c[_0x38333c(0x1b2)]+_0x38333c(0x25b)),this['clearPaymentTimers'](_0x32b52f);return;}if(!_0x44f50c[_0x38333c(0x20c)]){console[_0x38333c(0x1ac)](_0x38333c(0x25a)+_0x32b52f+_0x38333c(0x199));return;}console['log'](_0x38333c(0x1a2)+_0x32b52f+_0x38333c(0x1c5)),await this[_0x38333c(0x22d)](_0x44f50c);}[a37_0x27bc26(0x24e)](_0x28f8c4,_0x406b42,_0x398f0b,_0x14ee3b,_0x2222b7,_0x144994){const _0x25857f=a37_0x27bc26,_0x1c13e4={'type':_0x25857f(0x1a6),'paymentId':_0x28f8c4,'gatewayPaymentId':_0x406b42,'oldStatus':_0x398f0b,'newStatus':_0x14ee3b,'source':_0x2222b7,'timestamp':new Date()['toISOString'](),'details':_0x144994||{}};loggerService_1[_0x25857f(0x254)][_0x25857f(0x24e)](_0x1c13e4),console[_0x25857f(0x1ac)](_0x25857f(0x227)+_0x28f8c4+'\x20('+_0x406b42+')'),console[_0x25857f(0x1ac)](_0x25857f(0x25f)+_0x398f0b+_0x25857f(0x24d)+_0x14ee3b),console[_0x25857f(0x1ac)]('\x20\x20\x20📍\x20Source:\x20'+_0x2222b7),console['log'](_0x25857f(0x1e8)+_0x1c13e4[_0x25857f(0x1f0)]),_0x144994&&console[_0x25857f(0x1ac)](_0x25857f(0x194),_0x144994);}[a37_0x27bc26(0x1da)](_0x566c05,_0x25ae30,_0x3d20e8,_0x4970cf,_0x519827){const _0xfb4083=a37_0x27bc26,_0x37bdb5={'type':'COINTOPAY_ERROR','paymentId':_0x566c05,'gatewayPaymentId':_0x25ae30,'error':_0x3d20e8 instanceof Error?{'message':_0x3d20e8[_0xfb4083(0x1f6)],'stack':_0x3d20e8['stack']}:_0x3d20e8,'source':_0x4970cf,'timestamp':new Date()[_0xfb4083(0x23c)](),'context':_0x519827||{}};loggerService_1[_0xfb4083(0x254)][_0xfb4083(0x1da)](_0x37bdb5),console[_0xfb4083(0x19b)](_0xfb4083(0x223)+_0x566c05+'\x20('+_0x25ae30+')'),console[_0xfb4083(0x19b)](_0xfb4083(0x196)+(_0x3d20e8 instanceof Error?_0x3d20e8[_0xfb4083(0x1f6)]:_0x3d20e8)),console[_0xfb4083(0x19b)](_0xfb4083(0x193)+_0x4970cf),console[_0xfb4083(0x19b)]('\x20\x20\x20📅\x20Time:\x20'+_0x37bdb5[_0xfb4083(0x1f0)]),_0x519827&&console[_0xfb4083(0x19b)](_0xfb4083(0x208),_0x519827);}[a37_0x27bc26(0x1d8)](){const _0x45689a=a37_0x27bc26;console['log'](_0x45689a(0x25c)),this[_0x45689a(0x1a3)]()[_0x45689a(0x233)](_0x16e8a0=>{const _0x428296=_0x45689a;console[_0x428296(0x19b)](_0x428296(0x189),_0x16e8a0);}),this['globalCheckInterval']=setInterval(async()=>{const _0xbf9ca1=_0x45689a;try{console[_0xbf9ca1(0x1ac)](_0xbf9ca1(0x1b7)),await this['checkAllPendingPayments'](),console['log'](_0xbf9ca1(0x245));}catch(_0xc500c0){console[_0xbf9ca1(0x19b)](_0xbf9ca1(0x238),_0xc500c0);}},this[_0x45689a(0x262)]),console[_0x45689a(0x1ac)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x27bc26(0x1a5)](){const _0x188e0=a37_0x27bc26;console[_0x188e0(0x1ac)](_0x188e0(0x1ef));this[_0x188e0(0x258)]&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x188e0(0x1ac)](_0x188e0(0x226)));const _0x2bc083=this[_0x188e0(0x1d6)][_0x188e0(0x251)];for(const [_0x226662]of this[_0x188e0(0x1d6)]){this[_0x188e0(0x242)](_0x226662);}console[_0x188e0(0x1ac)](_0x188e0(0x239)+_0x2bc083+_0x188e0(0x215));}async['checkAllPendingPayments'](){const _0x2fa173=a37_0x27bc26;try{console[_0x2fa173(0x1ac)](_0x2fa173(0x1dc));const _0x5ba667=await database_1[_0x2fa173(0x211)][_0x2fa173(0x1fa)]['findMany']({'where':{'gateway':_0x2fa173(0x1c7),'status':_0x2fa173(0x24f),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x2fa173(0x1ac)](_0x2fa173(0x1a4)+_0x5ba667['length']+_0x2fa173(0x1bd));if(_0x5ba667[_0x2fa173(0x21e)]===0x0){console[_0x2fa173(0x1ac)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x9a002c=await this[_0x2fa173(0x249)](_0x5ba667);console['log'](_0x2fa173(0x248)+_0x9a002c[_0x2fa173(0x21e)]+'\x20expired\x20CoinToPay\x20payments');let _0x3e7e24=0x0,_0x157016=0x0;for(const _0xbda90c of _0x5ba667){try{if(_0x9a002c[_0x2fa173(0x21c)](_0xbda90c['id'])){console['log'](_0x2fa173(0x1e7)+_0xbda90c['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x157016++;continue;}if(this[_0x2fa173(0x1d6)][_0x2fa173(0x1f8)](_0xbda90c['id'])){console[_0x2fa173(0x1ac)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0xbda90c['id']+_0x2fa173(0x216)),_0x157016++;continue;}const _0x4155f1=(Date['now']()-_0xbda90c[_0x2fa173(0x257)][_0x2fa173(0x1bf)]())/(0x3e8*0x3c*0x3c);if(_0x4155f1<0x1){console[_0x2fa173(0x1ac)](_0x2fa173(0x1e7)+_0xbda90c['id']+_0x2fa173(0x1d9)+_0x4155f1['toFixed'](0x1)+_0x2fa173(0x1f1)),_0x157016++;continue;}console['log']('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0xbda90c['id']+_0x2fa173(0x24b)+_0x4155f1[_0x2fa173(0x1e2)](0x1)+'h)'),await this[_0x2fa173(0x22d)](_0xbda90c),_0x3e7e24++,await new Promise(_0x51c4c6=>setTimeout(_0x51c4c6,0x7d0));}catch(_0x3e3c9e){console[_0x2fa173(0x19b)](_0x2fa173(0x229)+_0xbda90c['id']+':',_0x3e3c9e),this[_0x2fa173(0x1da)](_0xbda90c['id'],_0xbda90c[_0x2fa173(0x20c)]||_0x2fa173(0x18e),_0x3e3c9e,_0x2fa173(0x1cf),{'isGlobalCheck':!![],'paymentAmount':_0xbda90c[_0x2fa173(0x1ae)],'paymentCurrency':_0xbda90c[_0x2fa173(0x1ee)],'shopId':_0xbda90c['shopId'],'createdAt':_0xbda90c[_0x2fa173(0x257)]}),loggerService_1['loggerService']['logWhiteDomainError'](_0x2fa173(0x1c7),_0x2fa173(0x195)+_0xbda90c[_0x2fa173(0x20c)],_0x3e3c9e);}}console[_0x2fa173(0x1ac)](_0x2fa173(0x1dd)+_0x3e7e24+'\x20checked,\x20'+_0x157016+_0x2fa173(0x1b9)+_0x9a002c[_0x2fa173(0x21e)]+_0x2fa173(0x1e5));}catch(_0x52bb47){console[_0x2fa173(0x19b)](_0x2fa173(0x1e6),_0x52bb47);}}async['checkExpiredPayments'](_0x57d87e){const _0x1f4b2a=a37_0x27bc26,_0x27d666=[],_0x2cdd8d=new Date();_0x2cdd8d[_0x1f4b2a(0x217)](_0x2cdd8d['getDate']()-this[_0x1f4b2a(0x266)]),console[_0x1f4b2a(0x1ac)](_0x1f4b2a(0x1d5)+this['EXPIRY_DAYS']+_0x1f4b2a(0x1b5)+_0x2cdd8d[_0x1f4b2a(0x23c)]()+')');for(const _0x44c15b of _0x57d87e){if(_0x44c15b[_0x1f4b2a(0x257)]<_0x2cdd8d){console['log'](_0x1f4b2a(0x1d0)+_0x44c15b['id']+'\x20is\x20older\x20than\x20'+this[_0x1f4b2a(0x266)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x1f4b2a(0x24e)](_0x44c15b['id'],_0x44c15b['gatewayPaymentId']||_0x1f4b2a(0x18e),'PENDING',_0x1f4b2a(0x1b8),_0x1f4b2a(0x253),{'reason':'Payment\x20older\x20than\x20'+this[_0x1f4b2a(0x266)]+_0x1f4b2a(0x187),'createdAt':_0x44c15b['createdAt'],'daysSinceCreation':Math[_0x1f4b2a(0x260)]((Date[_0x1f4b2a(0x1d7)]()-_0x44c15b[_0x1f4b2a(0x257)][_0x1f4b2a(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x44c15b[_0x1f4b2a(0x1ae)],'paymentCurrency':_0x44c15b[_0x1f4b2a(0x1ee)],'shopId':_0x44c15b[_0x1f4b2a(0x22c)]}),await database_1[_0x1f4b2a(0x211)]['payment'][_0x1f4b2a(0x214)]({'where':{'id':_0x44c15b['id']},'data':{'status':_0x1f4b2a(0x1b8),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x1f4b2a(0x266)]+_0x1f4b2a(0x212)}}),await database_1[_0x1f4b2a(0x211)][_0x1f4b2a(0x1cc)][_0x1f4b2a(0x19d)]({'data':{'paymentId':_0x44c15b['id'],'shopId':_0x44c15b['shopId'],'event':_0x1f4b2a(0x21b),'statusCode':0xc8,'responseBody':JSON[_0x1f4b2a(0x23f)]({'reason':_0x1f4b2a(0x202)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x44c15b['createdAt'],'expiredAt':new Date()[_0x1f4b2a(0x23c)](),'daysSinceCreation':Math[_0x1f4b2a(0x260)]((Date[_0x1f4b2a(0x1d7)]()-_0x44c15b[_0x1f4b2a(0x257)][_0x1f4b2a(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x44c15b,'EXPIRED'),await this[_0x1f4b2a(0x1c3)](_0x44c15b,_0x1f4b2a(0x1b8)),this['clearPaymentTimers'](_0x44c15b['id']),_0x27d666[_0x1f4b2a(0x1de)](_0x44c15b['id']),console[_0x1f4b2a(0x1ac)](_0x1f4b2a(0x1e4)+_0x44c15b['id']+_0x1f4b2a(0x210)+this[_0x1f4b2a(0x266)]+_0x1f4b2a(0x1ea));}catch(_0x16ad95){console[_0x1f4b2a(0x19b)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x44c15b['id']+':',_0x16ad95),this[_0x1f4b2a(0x1da)](_0x44c15b['id'],_0x44c15b[_0x1f4b2a(0x20c)]||_0x1f4b2a(0x18e),_0x16ad95,_0x1f4b2a(0x253),{'reason':_0x1f4b2a(0x1a0),'createdAt':_0x44c15b[_0x1f4b2a(0x257)],'daysSinceCreation':Math[_0x1f4b2a(0x260)]((Date[_0x1f4b2a(0x1d7)]()-_0x44c15b[_0x1f4b2a(0x257)][_0x1f4b2a(0x1bf)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x27d666;}async[a37_0x27bc26(0x22d)](_0x572879){const _0x127ece=a37_0x27bc26;if(!_0x572879[_0x127ece(0x20c)]){console[_0x127ece(0x1ac)](_0x127ece(0x25a)+_0x572879['id']+_0x127ece(0x25d));return;}console['log'](_0x127ece(0x23d)+_0x572879['id']+'\x20('+_0x572879['gatewayPaymentId']+')');try{const _0x2d4df9=await this[_0x127ece(0x18c)]['checkPaymentStatus'](_0x572879['gatewayPaymentId']);console[_0x127ece(0x1ac)](_0x127ece(0x203)+_0x572879['id']+_0x127ece(0x237)+_0x2d4df9['status']);_0x2d4df9[_0x127ece(0x20a)]&&console[_0x127ece(0x1ac)](_0x127ece(0x203)+_0x572879['id']+_0x127ece(0x1f2),{'iban':_0x2d4df9[_0x127ece(0x20a)][_0x127ece(0x19f)]||'not\x20found','transactionId':_0x2d4df9['paymentDetails'][_0x127ece(0x1ec)],'createdOn':_0x2d4df9['paymentDetails'][_0x127ece(0x219)],'confirmedOn':_0x2d4df9[_0x127ece(0x20a)][_0x127ece(0x1be)]||_0x127ece(0x1fb)});if(_0x2d4df9[_0x127ece(0x1b2)]!==_0x572879[_0x127ece(0x1b2)]){console[_0x127ece(0x1ac)](_0x127ece(0x1cb)+_0x572879['id']+_0x127ece(0x1c0)+_0x572879[_0x127ece(0x1b2)]+_0x127ece(0x1c1)+_0x2d4df9[_0x127ece(0x1b2)]),this[_0x127ece(0x24e)](_0x572879['id'],_0x572879['gatewayPaymentId'],_0x572879['status'],_0x2d4df9[_0x127ece(0x1b2)],'status_check',{'paymentDetails':_0x2d4df9[_0x127ece(0x20a)],'amount':_0x2d4df9[_0x127ece(0x1ae)],'currency':_0x2d4df9['currency'],'shopId':_0x572879['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x46ab20={'status':_0x2d4df9[_0x127ece(0x1b2)],'updatedAt':new Date()};_0x2d4df9['status']===_0x127ece(0x201)&&_0x572879[_0x127ece(0x1b2)]!==_0x127ece(0x201)&&(_0x46ab20[_0x127ece(0x224)]=new Date(),console[_0x127ece(0x1ac)](_0x127ece(0x213)+_0x572879['id']+_0x127ece(0x1f5)+_0x46ab20['paidAt']['toISOString']()));if(_0x2d4df9[_0x127ece(0x20a)]){const _0x2c9b41=_0x2d4df9[_0x127ece(0x20a)];_0x2c9b41['iban']&&(_0x46ab20['remitterIban']=_0x2c9b41['iban'],console['log'](_0x127ece(0x21f)+_0x2c9b41[_0x127ece(0x19f)]));if(_0x2c9b41[_0x127ece(0x256)]){const _0x322c95=_0x572879[_0x127ece(0x1fe)]||'',_0x5437ae=_0x127ece(0x1b6)+_0x2c9b41[_0x127ece(0x256)];_0x46ab20['adminNotes']=_0x322c95?_0x322c95+'\x0a\x0a'+_0x5437ae:_0x5437ae,console[_0x127ece(0x1ac)]('🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x2c9b41[_0x127ece(0x1ec)]&&console['log'](_0x127ece(0x234)+_0x2c9b41[_0x127ece(0x1ec)]),_0x2c9b41[_0x127ece(0x1be)]&&console[_0x127ece(0x1ac)](_0x127ece(0x246)+_0x2c9b41[_0x127ece(0x1be)]);}await database_1[_0x127ece(0x211)][_0x127ece(0x1fa)][_0x127ece(0x214)]({'where':{'id':_0x572879['id']},'data':_0x46ab20}),await database_1[_0x127ece(0x211)][_0x127ece(0x1cc)][_0x127ece(0x19d)]({'data':{'paymentId':_0x572879['id'],'shopId':_0x572879[_0x127ece(0x22c)],'event':_0x127ece(0x1d1)+_0x2d4df9[_0x127ece(0x1b2)][_0x127ece(0x1c2)](),'statusCode':0xc8,'responseBody':JSON[_0x127ece(0x23f)]({'oldStatus':_0x572879['status'],'newStatus':_0x2d4df9['status'],'paymentDetails':_0x2d4df9[_0x127ece(0x20a)],'checkedAt':new Date()[_0x127ece(0x23c)]()})}}),await this[_0x127ece(0x192)](_0x572879,_0x2d4df9[_0x127ece(0x1b2)]),await this[_0x127ece(0x1c3)](_0x572879,_0x2d4df9[_0x127ece(0x1b2)]),_0x2d4df9[_0x127ece(0x1b2)]!==_0x127ece(0x24f)&&(console['log']('🧹\x20[CHECK]\x20Payment\x20'+_0x572879['id']+'\x20status\x20changed\x20to\x20'+_0x2d4df9[_0x127ece(0x1b2)]+',\x20clearing\x20individual\x20timers'),this[_0x127ece(0x242)](_0x572879['id'])),console[_0x127ece(0x1ac)](_0x127ece(0x1a2)+_0x572879['id']+_0x127ece(0x265));}else console[_0x127ece(0x1ac)](_0x127ece(0x203)+_0x572879['id']+_0x127ece(0x235)+_0x2d4df9[_0x127ece(0x1b2)]+')'),this[_0x127ece(0x24e)](_0x572879['id'],_0x572879['gatewayPaymentId'],_0x572879[_0x127ece(0x1b2)],_0x2d4df9[_0x127ece(0x1b2)],_0x127ece(0x1cf),{'statusUnchanged':!![],'paymentDetails':_0x2d4df9['paymentDetails'],'amount':_0x2d4df9[_0x127ece(0x1ae)],'currency':_0x2d4df9['currency'],'shopId':_0x572879['shopId'],'checkTimestamp':new Date()[_0x127ece(0x23c)]()});}catch(_0x30c170){console['error'](_0x127ece(0x1ad)+_0x572879['id']+':',_0x30c170),this[_0x127ece(0x1da)](_0x572879['id'],_0x572879[_0x127ece(0x20c)],_0x30c170,_0x127ece(0x1cf),{'paymentAmount':_0x572879[_0x127ece(0x1ae)],'paymentCurrency':_0x572879[_0x127ece(0x1ee)],'shopId':_0x572879[_0x127ece(0x22c)],'createdAt':_0x572879[_0x127ece(0x257)]}),await database_1[_0x127ece(0x211)]['webhookLog'][_0x127ece(0x19d)]({'data':{'paymentId':_0x572879['id'],'shopId':_0x572879[_0x127ece(0x22c)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x127ece(0x23f)]({'error':_0x30c170 instanceof Error?_0x30c170[_0x127ece(0x1f6)]:'Unknown\x20error','gatewayPaymentId':_0x572879['gatewayPaymentId'],'checkedAt':new Date()[_0x127ece(0x23c)]()})}});}}async[a37_0x27bc26(0x192)](_0x425650,_0x31e54c){const _0x36d595=a37_0x27bc26,_0x653c49=Date[_0x36d595(0x1d7)]();try{const _0x13a058=_0x425650[_0x36d595(0x225)],_0xafa2b4=_0x13a058[_0x36d595(0x1b0)];if(!_0xafa2b4?.[_0x36d595(0x204)]){console[_0x36d595(0x1ac)](_0x36d595(0x188)+_0x13a058['id']);return;}const _0xe3c38=_0x31e54c==='PAID'?_0x36d595(0x198):_0x31e54c===_0x36d595(0x1fd)?_0x36d595(0x247):_0x31e54c==='EXPIRED'?'payment.failed':_0x36d595(0x244);if(!_0xafa2b4['webhookEvents']?.[_0x36d595(0x21c)](_0xe3c38)){console['log']('Webhook\x20event\x20'+_0xe3c38+_0x36d595(0x22a)+_0x13a058['id']);return;}const _0x3f8e7d={'event':_0xe3c38,'payment':{'id':_0x425650['id'],'order_id':_0x425650[_0x36d595(0x221)],'gateway_order_id':_0x425650[_0x36d595(0x24c)],'gateway':_0x36d595(0x250),'amount':_0x425650[_0x36d595(0x1ae)],'currency':_0x425650[_0x36d595(0x1ee)],'status':_0x31e54c[_0x36d595(0x1c2)](),'customer_email':_0x425650[_0x36d595(0x255)],'customer_name':_0x425650['customerName'],'created_at':_0x425650[_0x36d595(0x257)],'updated_at':new Date()}},_0x328161=await fetch(_0xafa2b4[_0x36d595(0x204)],{'method':_0x36d595(0x1e0),'headers':{'Content-Type':_0x36d595(0x1aa),'User-Agent':_0x36d595(0x209)},'body':JSON[_0x36d595(0x23f)](_0x3f8e7d)}),_0x53a573=Date[_0x36d595(0x1d7)]()-_0x653c49,_0x4a9398=_0x328161['ok']?_0x36d595(0x207):await _0x328161['text']();loggerService_1['loggerService'][_0x36d595(0x232)](_0x425650[_0x36d595(0x22c)],_0xafa2b4[_0x36d595(0x204)],_0xe3c38,_0x328161[_0x36d595(0x1b2)],_0x53a573,_0x3f8e7d),console[_0x36d595(0x1ac)](_0x36d595(0x24a)+_0xafa2b4[_0x36d595(0x204)]+_0x36d595(0x1c4)+_0x328161[_0x36d595(0x1b2)]+'\x20('+_0x53a573+'ms)');}catch(_0x3ada26){console[_0x36d595(0x19b)](_0x36d595(0x18a),_0x3ada26),loggerService_1[_0x36d595(0x254)][_0x36d595(0x1a9)](_0x425650[_0x36d595(0x22c)],_0x425650['shop']?.[_0x36d595(0x1b0)]?.[_0x36d595(0x204)]||_0x36d595(0x18e),'webhook_send',_0x3ada26,{});}}async[a37_0x27bc26(0x1c3)](_0x356d16,_0x750ba){const _0x319ca9=a37_0x27bc26;try{const _0xcf1f6a={'PENDING':_0x319ca9(0x1a8),'PAID':'paid','FAILED':_0x319ca9(0x191),'EXPIRED':_0x319ca9(0x1b3)},_0x5bff99=_0xcf1f6a[_0x750ba];if(!_0x5bff99||_0x5bff99===_0x319ca9(0x1a8))return;await telegramBotService_1[_0x319ca9(0x243)]['sendPaymentNotification'](_0x356d16['shopId'],_0x356d16,_0x5bff99);}catch(_0x4257a3){console['error'](_0x319ca9(0x23a),_0x4257a3);}}async[a37_0x27bc26(0x21d)](_0x41f329){const _0x2cc5b8=a37_0x27bc26;console['log'](_0x2cc5b8(0x218)+_0x41f329);const _0x219464=await database_1[_0x2cc5b8(0x211)][_0x2cc5b8(0x1fa)][_0x2cc5b8(0x1b4)]({'where':{'id':_0x41f329},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x219464)throw new Error(_0x2cc5b8(0x20b));if(_0x219464['gateway']!=='cointopay')throw new Error(_0x2cc5b8(0x200));console[_0x2cc5b8(0x1ac)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x41f329),await this[_0x2cc5b8(0x22d)](_0x219464),console[_0x2cc5b8(0x1ac)](_0x2cc5b8(0x206)+_0x41f329);}[a37_0x27bc26(0x1eb)](){const _0x540a3c=a37_0x27bc26,_0x515180=this['globalCheckInterval']?this[_0x540a3c(0x262)]:undefined,_0x24e6e2=Array['from'](this[_0x540a3c(0x1d6)][_0x540a3c(0x22f)]())[_0x540a3c(0x1e9)](_0x305d83=>({'paymentId':_0x305d83[_0x540a3c(0x18d)],'gatewayPaymentId':_0x305d83['gatewayPaymentId'],'createdAt':_0x305d83['createdAt'],'timersCount':_0x305d83[_0x540a3c(0x1bb)][_0x540a3c(0x21e)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x540a3c(0x262)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x540a3c(0x1d6)][_0x540a3c(0x251)],'nextGlobalCheckIn':_0x515180,'paymentTimersDetails':_0x24e6e2};}[a37_0x27bc26(0x1ab)](_0x528e6d){const _0x5af9e5=a37_0x27bc26,_0x2a05ce=this[_0x5af9e5(0x1d6)]['get'](_0x528e6d);if(_0x2a05ce)return{'hasTimers':!![],'timersCount':_0x2a05ce[_0x5af9e5(0x1bb)][_0x5af9e5(0x21e)],'createdAt':_0x2a05ce[_0x5af9e5(0x257)],'gatewayPaymentId':_0x2a05ce['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x27bc26(0x23e)]=CoinToPayStatusService,exports[a37_0x27bc26(0x1c8)]=new CoinToPayStatusService();