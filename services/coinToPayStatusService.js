'use strict';const a38_0x288775=a38_0x10c1;(function(_0x4ae651,_0xa44d36){const _0x15e1eb=a38_0x10c1,_0x8edf05=_0x4ae651();while(!![]){try{const _0x325478=-parseInt(_0x15e1eb(0x19c))/0x1*(parseInt(_0x15e1eb(0x1cf))/0x2)+-parseInt(_0x15e1eb(0xd3))/0x3+parseInt(_0x15e1eb(0x1d1))/0x4+-parseInt(_0x15e1eb(0xbb))/0x5*(parseInt(_0x15e1eb(0xc3))/0x6)+parseInt(_0x15e1eb(0xf5))/0x7+-parseInt(_0x15e1eb(0x16a))/0x8*(parseInt(_0x15e1eb(0x10b))/0x9)+parseInt(_0x15e1eb(0x11f))/0xa;if(_0x325478===_0xa44d36)break;else _0x8edf05['push'](_0x8edf05['shift']());}catch(_0x4cfb6d){_0x8edf05['push'](_0x8edf05['shift']());}}}(a38_0x49d6,0x1d954));var __importDefault=this&&this[a38_0x288775(0x16c)]||function(_0xd0c7a9){const _0xaba390=a38_0x288775;return _0xd0c7a9&&_0xd0c7a9[_0xaba390(0x1bb)]?_0xd0c7a9:{'default':_0xd0c7a9};};function a38_0x49d6(){const _0xe6cb58=['../types/gateway','getDate','⏰\x20[HOURLY]\x20Payment\x20','❌\x20[HOURLY]\x20Payment\x20','Payment\x20not\x20found','🧹\x20[CHECK]\x20Payment\x20','customerName','✅\x20[EXPIRY]\x20Payment\x20','logShopWebhookSent','184bsemoF','\x20\x20\x20Amount:\x20','__importDefault','./currencyService','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','message','shop','status_check','gatewayCommissionRate','type','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','commission','timers','schedule_created','coinToPayStatusService','2\x20minutes','COINTOPAY_ERROR','created','\x20current\x20status:\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','confirmedOn','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','📊\x20[CHECK]\x20Payment\x20','settings','\x20has\x20no\x20gatewayPaymentId','checkAllPendingPayments','cointopay','\x20for\x20payment\x20','./gateways/coinToPay2Service','\x20expired','Failed\x20to\x20send\x20shop\x20webhook:','getGatewayIdByName','getTime','amountAfterGatewayCommissionUSDT','EXPIRED','currency','\x20\x20\x20📝\x20Details:','push','../config/database','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20expired\x20CoinToPay\x20payments','remitterIban','📈\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','defineProperty','has','set','🧹\x20[DEBUG]\x20Clearing\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','payment.failed','117004XRjiFs','log','getGatewayCommission','cointopay_auto_expired','globalCheckInterval','webhookEvents','-day\x20timeout','⚠️\x20[CHECK]\x20Payment\x20','CoinToPayService','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','cointopay_status_check_','PENDING','paymentLinkId','⏰\x20[GLOBAL]\x20Payment\x20',',\x20stopping\x20individual\x20checks',',\x20gateway\x20','\x20commission:\x20','\x20status\x20unchanged\x20(','transactionId','\x20days\x20without\x20payment\x20confirmation','\x20\x20\x20📊\x20Status:\x20','default','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20found:','payment','coinToPay2Service','entries','toISOString','create','\x20\x20\x20❌\x20Error:\x20','__esModule','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','stopPeriodicStatusCheck',',\x20using\x20default\x20commission\x2010%','auto_expire','forEach','status','\x20status\x20from\x20','findUnique','checkSinglePayment','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20\x20\x20-\x20Status:\x20','Shop\x20webhook\x20sent\x20to\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','telegramBotService','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20in\x20shop\x20','shopId','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','./loggerService','2oCbXLu','checkPaymentById','618816RbWyax','createdAt','logCoinToPayError','application/json','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','checkPaymentStatus','currentPayments','values','5labnZx','\x20days\x20(created\x20before\x20','update',',\x20status=','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','payment.success','\x20marked\x20as\x20paid\x20at:\x20',',\x20currentPayments=','705576TdEHzG','gateway','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20timers\x20for\x20payment\x20','1\x20minute','description','paidAt','Bank\x20Details:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20pending\x20CoinToPay\x20payments','./telegramBotService','\x20status\x20changed\x20to\x20','paymentLink','\x20updated\x20successfully','includes','bankDetails','160035acvHGu','clearPaymentTimers','getServiceStats','startPeriodicStatusCheck','🪙\x20[TIMER]\x20Individual\x20check\x20#','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','webhookUrl','⏰\x20[EXPIRY]\x20Payment\x20','\x20USDT','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','EXPIRY_DAYS','now','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','📊\x20[HOURLY]\x20Payment\x20','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','✅\x20[HOURLY]\x20Payment\x20','floor','Automatically\x20expired\x20after\x20','\x20\x20\x20-\x20Amount:\x20','TesSoft\x20Payment\x20System/1.0','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','payment.pending','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','📊\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20is\x20older\x20than\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','paid','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','toFixed','\x20skipped,\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','1053563cOIcKU','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','gatewayPaymentId','📈\x20[COINTOPAY]\x20Payment\x20','\x20(after\x20','catch','\x20status:\x20','not\x20found','\x20has\x20no\x20gatewayPaymentId,\x20skipping','PAID','sendPaymentStatusNotification','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','Success','\x20\x20\x20-\x20ShopId:\x20','orderId','coinToPayService','get','\x20to\x20','iban','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','checkSinglePaymentById','53748NuhAmG','currencyService','🪙\x20[DEBUG]\x20Creating\x20','paymentId','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','loggerService','\x20not\x20found\x20in\x20database','amount','\x20days','COINTOPAY_STATUS_CHANGE','CoinToPayStatusService','🔍\x20[CHECK]\x20Checking\x20','not\x20confirmed','\x20\x20\x20📝\x20Context:','delay','webhook_send','convertToUSDT','expired',':\x20type=','sendShopWebhook','2412600gclBuv','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','customerEmail','schedulePaymentChecks','delete','🛑\x20[SHUTDOWN]\x20Cleared\x20','stack','toLowerCase','\x20payment\x20','\x20commission\x20for\x20shop\x20','\x20with\x20status\x20','COMPLETED','h),\x20skipping\x20global\x20check','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','from','✅\x20[COINTOPAY]\x20Payment\x20link\x20',',\x20using\x20default\x2010%','stringify','\x20amounts\x20calculated:','error','FAILED','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20-\x20GatewayPaymentId:\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','.\x20Remaining\x20active\x20timers:\x20','Payment\x20older\x20than\x20','webhookLog','paymentTimers','CoinToPay2Service','getPaymentTimerInfo','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','size','unknown','checkExpiredPayments','length','GLOBAL_CHECK_INTERVAL_MS','\x20\x20\x20-\x20gatewayPaymentId:\x20','gatewaySettings','✅\x20[CHECK]\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cointopay_status_check_error','\x20\x20\x20📅\x20Time:\x20','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20(age:\x20','/status/','\x20status\x20is\x20','\x20\x20\x20Gateway\x20','logCoinToPayStatus','paymentDetails','\x20not\x20found,\x20clearing\x20timers','\x20in\x20','5\x20minutes','cointopay2','adminNotes','timestamp','\x20\x20\x20-\x20paymentId:\x20','\x20updated:\x20currentPayments=','map','❌\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','gatewayOrderId','\x20days,\x20marking\x20as\x20EXPIRED','failed','\x20\x20\x20📍\x20Source:\x20','\x20->\x20'];a38_0x49d6=function(){return _0xe6cb58;};return a38_0x49d6();}Object[a38_0x288775(0x196)](exports,a38_0x288775(0x1bb),{'value':!![]}),exports[a38_0x288775(0x179)]=exports[a38_0x288775(0x115)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a38_0x288775(0x187)),gateway_1=require(a38_0x288775(0x161)),database_1=__importDefault(require(a38_0x288775(0x191))),telegramBotService_1=require(a38_0x288775(0xcd)),loggerService_1=require(a38_0x288775(0x1ce)),currencyService_1=require(a38_0x288775(0x16d));function a38_0x10c1(_0x598c71,_0x416d06){const _0x49d685=a38_0x49d6();return a38_0x10c1=function(_0x10c114,_0x1e7b43){_0x10c114=_0x10c114-0xb8;let _0x50599c=_0x49d685[_0x10c114];return _0x50599c;},a38_0x10c1(_0x598c71,_0x416d06);}class CoinToPayStatusService{constructor(){const _0x5eec68=a38_0x288775;this['globalCheckInterval']=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x5eec68(0xdd)]=0x5,this[_0x5eec68(0x13c)]=new Map(),this[_0x5eec68(0x104)]=new coinToPayService_1[(_0x5eec68(0x1a4))](),this[_0x5eec68(0x1b6)]=new coinToPay2Service_1[(_0x5eec68(0x13d))](),console['log'](_0x5eec68(0xbf));}[a38_0x288775(0x123)](_0x306f94,_0x518d7f){const _0x3f9b70=a38_0x288775;console[_0x3f9b70(0x19d)](_0x3f9b70(0x1c8)),console[_0x3f9b70(0x19d)](_0x3f9b70(0x158)+_0x306f94),console['log'](_0x3f9b70(0x145)+_0x518d7f),this['clearPaymentTimers'](_0x306f94);const _0x224862=[],_0x41a269=new Date(),_0x1018a0=[{'delay':0x1*0x3c*0x3e8,'description':_0x3f9b70(0xc7)},{'delay':0x2*0x3c*0x3e8,'description':_0x3f9b70(0x17a)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x3f9b70(0x154)}];console[_0x3f9b70(0x19d)](_0x3f9b70(0x10d)+_0x1018a0[_0x3f9b70(0x143)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x306f94);let _0x558219=0x0;_0x1018a0[_0x3f9b70(0x1c0)]((_0x566707,_0x3958ae)=>{const _0x1ff619=_0x3f9b70;_0x558219+=_0x566707[_0x1ff619(0x119)];const _0x311f56=setTimeout(async()=>{const _0x557dbc=_0x1ff619;console[_0x557dbc(0x19d)](_0x557dbc(0xd7)+(_0x3958ae+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x306f94+_0x557dbc(0xf9)+_0x566707[_0x557dbc(0xc8)]+')');try{await this[_0x557dbc(0x10a)](_0x306f94),console[_0x557dbc(0x19d)](_0x557dbc(0x136)+(_0x3958ae+0x1)+'\x20completed\x20for\x20payment\x20'+_0x306f94);}catch(_0x5c7b23){console[_0x557dbc(0x134)](_0x557dbc(0xf0)+(_0x3958ae+0x1)+_0x557dbc(0x186)+_0x306f94+':',_0x5c7b23),this[_0x557dbc(0x1d3)](_0x306f94,_0x518d7f,_0x5c7b23,_0x557dbc(0x171),{'checkNumber':_0x3958ae+0x1,'scheduledAfter':_0x566707['description'],'isIndividualCheck':!![]});}},_0x558219);_0x224862['push'](_0x311f56),console['log'](_0x1ff619(0x10f)+(_0x3958ae+0x1)+'\x20for\x20payment\x20'+_0x306f94+_0x1ff619(0x153)+_0x558219/0x3e8+'\x20seconds\x20('+_0x566707[_0x1ff619(0xc8)]+')');});const _0x2a750a=setInterval(async()=>{const _0x1eb436=_0x3f9b70;console[_0x1eb436(0x19d)](_0x1eb436(0xe1)+_0x306f94);try{const _0xfdb1d4=await database_1[_0x1eb436(0x1b1)][_0x1eb436(0x1b5)][_0x1eb436(0x1c3)]({'where':{'id':_0x306f94},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0xfdb1d4){console[_0x1eb436(0x19d)](_0x1eb436(0x164)+_0x306f94+_0x1eb436(0x152)),this[_0x1eb436(0xd4)](_0x306f94);return;}console['log'](_0x1eb436(0xe0)+_0x306f94+_0x1eb436(0x17d)+_0xfdb1d4[_0x1eb436(0x1c1)]);if(_0xfdb1d4[_0x1eb436(0x1c1)]!==_0x1eb436(0x1a7)){console[_0x1eb436(0x19d)](_0x1eb436(0xe2)+_0x306f94+_0x1eb436(0x14e)+_0xfdb1d4[_0x1eb436(0x1c1)]+_0x1eb436(0x1aa)),this['clearPaymentTimers'](_0x306f94);return;}const _0x3bca57=Math[_0x1eb436(0xe3)]((Date[_0x1eb436(0xde)]()-_0xfdb1d4[_0x1eb436(0x1d2)][_0x1eb436(0x18b)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3bca57>=this[_0x1eb436(0xdd)]){console[_0x1eb436(0x19d)](_0x1eb436(0x163)+_0x306f94+_0x1eb436(0xed)+this[_0x1eb436(0xdd)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x1eb436(0xd4)](_0x306f94);return;}await this[_0x1eb436(0x10a)](_0x306f94),console['log'](_0x1eb436(0x108)+_0x306f94);}catch(_0x2ef178){console['error'](_0x1eb436(0x12d)+_0x306f94+':',_0x2ef178),this[_0x1eb436(0x1d3)](_0x306f94,_0x518d7f,_0x2ef178,_0x1eb436(0x171),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x224862[_0x3f9b70(0x190)](_0x2a750a),this[_0x3f9b70(0x13c)][_0x3f9b70(0x198)](_0x306f94,{'timers':_0x224862,'paymentId':_0x306f94,'gatewayPaymentId':_0x518d7f,'createdAt':_0x41a269}),console[_0x3f9b70(0x19d)](_0x3f9b70(0x1ca)+_0x1018a0[_0x3f9b70(0x143)]+_0x3f9b70(0x1d5)+_0x306f94),console[_0x3f9b70(0x19d)](_0x3f9b70(0x192)+this['paymentTimers'][_0x3f9b70(0x140)]),this['logCoinToPayStatus'](_0x306f94,_0x518d7f,_0x3f9b70(0x1a7),_0x3f9b70(0x1a7),'status_check',{'action':_0x3f9b70(0x178),'scheduledChecks':_0x1018a0['length'],'firstCheckIn':_0x1018a0[0x0]['delay']/0x3e8,'totalTimers':this[_0x3f9b70(0x13c)]['size']});}[a38_0x288775(0xd4)](_0x2e6eb0){const _0x33e117=a38_0x288775,_0x31cf34=this[_0x33e117(0x13c)][_0x33e117(0x105)](_0x2e6eb0);_0x31cf34?(console[_0x33e117(0x19d)](_0x33e117(0x199)+_0x31cf34['timers'][_0x33e117(0x143)]+_0x33e117(0xc6)+_0x2e6eb0),_0x31cf34[_0x33e117(0x177)]['forEach']((_0x5aa5b2,_0x2bd071)=>{const _0x131c6b=_0x33e117;_0x5aa5b2&&(clearTimeout(_0x5aa5b2),clearInterval(_0x5aa5b2),console[_0x131c6b(0x19d)](_0x131c6b(0xeb)+(_0x2bd071+0x1)+'\x20for\x20payment\x20'+_0x2e6eb0));}),this['paymentTimers'][_0x33e117(0x124)](_0x2e6eb0),console['log']('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x2e6eb0+_0x33e117(0x139)+this[_0x33e117(0x13c)][_0x33e117(0x140)])):console['log'](_0x33e117(0x174)+_0x2e6eb0+'\x20to\x20clear');}async[a38_0x288775(0x10a)](_0x2d9c26){const _0xbb14a8=a38_0x288775;console[_0xbb14a8(0x19d)](_0xbb14a8(0x1a5)+_0x2d9c26);const _0x2154a2=await database_1[_0xbb14a8(0x1b1)][_0xbb14a8(0x1b5)][_0xbb14a8(0x1c3)]({'where':{'id':_0x2d9c26},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2154a2){console[_0xbb14a8(0x19d)]('❌\x20[CHECK]\x20Payment\x20'+_0x2d9c26+_0xbb14a8(0x111));return;}console[_0xbb14a8(0x19d)](_0xbb14a8(0x181)+_0x2d9c26+_0xbb14a8(0x1b4)),console[_0xbb14a8(0x19d)]('\x20\x20\x20-\x20Gateway:\x20'+_0x2154a2[_0xbb14a8(0xc4)]),console['log'](_0xbb14a8(0x1c6)+_0x2154a2[_0xbb14a8(0x1c1)]),console[_0xbb14a8(0x19d)](_0xbb14a8(0x137)+_0x2154a2[_0xbb14a8(0xf7)]),console['log'](_0xbb14a8(0xe5)+_0x2154a2[_0xbb14a8(0x112)]+'\x20'+_0x2154a2[_0xbb14a8(0x18e)]),console['log'](_0xbb14a8(0x102)+_0x2154a2['shopId']);if(_0x2154a2[_0xbb14a8(0xc4)]!==_0xbb14a8(0x185)&&_0x2154a2[_0xbb14a8(0xc4)]!==_0xbb14a8(0x155)){console[_0xbb14a8(0x19d)](_0xbb14a8(0x1a3)+_0x2d9c26+_0xbb14a8(0xe7)+_0x2154a2[_0xbb14a8(0xc4)]+')');return;}if(_0x2154a2['status']!==_0xbb14a8(0x1a7)){console[_0xbb14a8(0x19d)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x2d9c26+_0xbb14a8(0x14e)+_0x2154a2[_0xbb14a8(0x1c1)]+_0xbb14a8(0x1aa)),this[_0xbb14a8(0xd4)](_0x2d9c26);return;}if(!_0x2154a2[_0xbb14a8(0xf7)]){console[_0xbb14a8(0x19d)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x2d9c26+_0xbb14a8(0x183));return;}console[_0xbb14a8(0x19d)]('✅\x20[CHECK]\x20Payment\x20'+_0x2d9c26+_0xbb14a8(0x1b3)),await this[_0xbb14a8(0x1c4)](_0x2154a2);}[a38_0x288775(0x150)](_0x5e064a,_0x527690,_0x28bbb5,_0x528553,_0x31f425,_0x1f5d67){const _0x3269fb=a38_0x288775,_0x269c89={'type':_0x3269fb(0x114),'paymentId':_0x5e064a,'gatewayPaymentId':_0x527690,'oldStatus':_0x28bbb5,'newStatus':_0x528553,'source':_0x31f425,'timestamp':new Date()[_0x3269fb(0x1b8)](),'details':_0x1f5d67||{}};loggerService_1[_0x3269fb(0x110)]['logCoinToPayStatus'](_0x269c89),console['log'](_0x3269fb(0x175)+_0x5e064a+'\x20('+_0x527690+')'),console['log'](_0x3269fb(0x1b0)+_0x28bbb5+_0x3269fb(0x160)+_0x528553),console[_0x3269fb(0x19d)]('\x20\x20\x20📍\x20Source:\x20'+_0x31f425),console[_0x3269fb(0x19d)](_0x3269fb(0x14a)+_0x269c89[_0x3269fb(0x157)]),_0x1f5d67&&console[_0x3269fb(0x19d)](_0x3269fb(0x18f),_0x1f5d67);}[a38_0x288775(0x1d3)](_0x46b84e,_0x2130a4,_0xfe9690,_0x399c4b,_0x573ab2){const _0x407e4a=a38_0x288775,_0x530796={'type':_0x407e4a(0x17b),'paymentId':_0x46b84e,'gatewayPaymentId':_0x2130a4,'error':_0xfe9690 instanceof Error?{'message':_0xfe9690[_0x407e4a(0x16f)],'stack':_0xfe9690[_0x407e4a(0x126)]}:_0xfe9690,'source':_0x399c4b,'timestamp':new Date()[_0x407e4a(0x1b8)](),'context':_0x573ab2||{}};loggerService_1[_0x407e4a(0x110)][_0x407e4a(0x1d3)](_0x530796),console[_0x407e4a(0x134)](_0x407e4a(0x138)+_0x46b84e+'\x20('+_0x2130a4+')'),console[_0x407e4a(0x134)](_0x407e4a(0x1ba)+(_0xfe9690 instanceof Error?_0xfe9690[_0x407e4a(0x16f)]:_0xfe9690)),console[_0x407e4a(0x134)](_0x407e4a(0x15f)+_0x399c4b),console['error'](_0x407e4a(0x14a)+_0x530796[_0x407e4a(0x157)]),_0x573ab2&&console['error'](_0x407e4a(0x118),_0x573ab2);}[a38_0x288775(0xd6)](){const _0x73ce97=a38_0x288775;console[_0x73ce97(0x19d)](_0x73ce97(0xc5)),this['checkAllPendingPayments']()[_0x73ce97(0xfa)](_0x76f4f7=>{const _0x1c2612=_0x73ce97;console[_0x1c2612(0x134)](_0x1c2612(0x121),_0x76f4f7);}),this[_0x73ce97(0x1a0)]=setInterval(async()=>{const _0x13debd=_0x73ce97;try{console[_0x13debd(0x19d)](_0x13debd(0xf1)),await this[_0x13debd(0x184)](),console[_0x13debd(0x19d)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x2765c3){console[_0x13debd(0x134)](_0x13debd(0xe9),_0x2765c3);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x73ce97(0x19d)](_0x73ce97(0x1bc));}[a38_0x288775(0x1bd)](){const _0x5078b5=a38_0x288775;console[_0x5078b5(0x19d)](_0x5078b5(0xee));this[_0x5078b5(0x1a0)]&&(clearInterval(this[_0x5078b5(0x1a0)]),this[_0x5078b5(0x1a0)]=null,console[_0x5078b5(0x19d)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x71df06=this[_0x5078b5(0x13c)][_0x5078b5(0x140)];for(const [_0x293481]of this[_0x5078b5(0x13c)]){this[_0x5078b5(0xd4)](_0x293481);}console[_0x5078b5(0x19d)](_0x5078b5(0x125)+_0x71df06+'\x20individual\x20payment\x20timers');}async[a38_0x288775(0x184)](){const _0x93a3b8=a38_0x288775;try{console[_0x93a3b8(0x19d)](_0x93a3b8(0xcb));const _0x4b83d2=await database_1[_0x93a3b8(0x1b1)]['payment']['findMany']({'where':{'gateway':{'in':[_0x93a3b8(0x185),_0x93a3b8(0x155)]},'status':_0x93a3b8(0x1a7),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x93a3b8(0x19d)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x4b83d2[_0x93a3b8(0x143)]+_0x93a3b8(0xcc));if(_0x4b83d2['length']===0x0){console['log']('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x4abdbe=await this[_0x93a3b8(0x142)](_0x4b83d2);console[_0x93a3b8(0x19d)]('⏰\x20[GLOBAL]\x20Found\x20'+_0x4abdbe[_0x93a3b8(0x143)]+_0x93a3b8(0x193));let _0x2c01ee=0x0,_0x39999a=0x0;for(const _0x38b0a7 of _0x4b83d2){try{if(_0x4abdbe[_0x93a3b8(0xd1)](_0x38b0a7['id'])){console[_0x93a3b8(0x19d)](_0x93a3b8(0x1a9)+_0x38b0a7['id']+_0x93a3b8(0x16e)),_0x39999a++;continue;}if(this[_0x93a3b8(0x13c)][_0x93a3b8(0x197)](_0x38b0a7['id'])){console[_0x93a3b8(0x19d)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x38b0a7['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x39999a++;continue;}const _0x3f1b84=(Date[_0x93a3b8(0xde)]()-_0x38b0a7[_0x93a3b8(0x1d2)]['getTime']())/(0x3e8*0x3c*0x3c);if(_0x3f1b84<0x1){console['log'](_0x93a3b8(0x1a9)+_0x38b0a7['id']+'\x20is\x20too\x20new\x20('+_0x3f1b84[_0x93a3b8(0xf2)](0x1)+_0x93a3b8(0x12c)),_0x39999a++;continue;}console[_0x93a3b8(0x19d)](_0x93a3b8(0x19a)+_0x38b0a7['id']+_0x93a3b8(0x14c)+_0x3f1b84[_0x93a3b8(0xf2)](0x1)+'h)'),await this[_0x93a3b8(0x1c4)](_0x38b0a7),_0x2c01ee++,await new Promise(_0x33e557=>setTimeout(_0x33e557,0x7d0));}catch(_0xbad3d){console[_0x93a3b8(0x134)](_0x93a3b8(0xd8)+_0x38b0a7['id']+':',_0xbad3d),this[_0x93a3b8(0x1d3)](_0x38b0a7['id'],_0x38b0a7['gatewayPaymentId']||'unknown',_0xbad3d,_0x93a3b8(0x171),{'isGlobalCheck':!![],'paymentAmount':_0x38b0a7[_0x93a3b8(0x112)],'paymentCurrency':_0x38b0a7['currency'],'shopId':_0x38b0a7['shopId'],'createdAt':_0x38b0a7['createdAt']}),loggerService_1[_0x93a3b8(0x110)]['logWhiteDomainError']('cointopay',_0x93a3b8(0x14d)+_0x38b0a7[_0x93a3b8(0xf7)],_0xbad3d);}}console[_0x93a3b8(0x19d)](_0x93a3b8(0x1c5)+_0x2c01ee+'\x20checked,\x20'+_0x39999a+_0x93a3b8(0xf3)+_0x4abdbe[_0x93a3b8(0x143)]+_0x93a3b8(0x188));}catch(_0x82e241){console[_0x93a3b8(0x134)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x82e241);}}async['checkExpiredPayments'](_0x33cd56){const _0x1f1552=a38_0x288775,_0x4c4409=[],_0x5b2429=new Date();_0x5b2429['setDate'](_0x5b2429[_0x1f1552(0x162)]()-this[_0x1f1552(0xdd)]),console['log'](_0x1f1552(0xf4)+this[_0x1f1552(0xdd)]+_0x1f1552(0xbc)+_0x5b2429[_0x1f1552(0x1b8)]()+')');for(const _0x28f21e of _0x33cd56){if(_0x28f21e[_0x1f1552(0x1d2)]<_0x5b2429){console['log'](_0x1f1552(0xda)+_0x28f21e['id']+_0x1f1552(0xed)+this[_0x1f1552(0xdd)]+_0x1f1552(0x15d));try{this[_0x1f1552(0x150)](_0x28f21e['id'],_0x28f21e['gatewayPaymentId']||_0x1f1552(0x141),'PENDING','EXPIRED',_0x1f1552(0x1bf),{'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x1f1552(0x113),'createdAt':_0x28f21e[_0x1f1552(0x1d2)],'daysSinceCreation':Math[_0x1f1552(0xe3)]((Date['now']()-_0x28f21e[_0x1f1552(0x1d2)][_0x1f1552(0x18b)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x28f21e[_0x1f1552(0x112)],'paymentCurrency':_0x28f21e[_0x1f1552(0x18e)],'shopId':_0x28f21e[_0x1f1552(0x1cc)]}),await database_1[_0x1f1552(0x1b1)][_0x1f1552(0x1b5)][_0x1f1552(0xbd)]({'where':{'id':_0x28f21e['id']},'data':{'status':_0x1f1552(0x18d),'updatedAt':new Date(),'adminNotes':_0x1f1552(0xe4)+this[_0x1f1552(0xdd)]+_0x1f1552(0x1af)}}),await database_1['default'][_0x1f1552(0x13b)][_0x1f1552(0x1b9)]({'data':{'paymentId':_0x28f21e['id'],'shopId':_0x28f21e[_0x1f1552(0x1cc)],'event':_0x1f1552(0x19f),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x1f1552(0x13a)+this['EXPIRY_DAYS']+_0x1f1552(0x113),'createdAt':_0x28f21e[_0x1f1552(0x1d2)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math['floor']((Date[_0x1f1552(0xde)]()-_0x28f21e[_0x1f1552(0x1d2)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x28f21e,_0x1f1552(0x18d)),await this[_0x1f1552(0xff)](_0x28f21e,_0x1f1552(0x18d)),this[_0x1f1552(0xd4)](_0x28f21e['id']),_0x4c4409[_0x1f1552(0x190)](_0x28f21e['id']),console['log'](_0x1f1552(0x168)+_0x28f21e['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x1f1552(0xdd)]+_0x1f1552(0x1a2));}catch(_0x599f06){console[_0x1f1552(0x134)](_0x1f1552(0x180)+_0x28f21e['id']+':',_0x599f06),this['logCoinToPayError'](_0x28f21e['id'],_0x28f21e[_0x1f1552(0xf7)]||_0x1f1552(0x141),_0x599f06,_0x1f1552(0x1bf),{'reason':_0x1f1552(0x14b),'createdAt':_0x28f21e['createdAt'],'daysSinceCreation':Math[_0x1f1552(0xe3)]((Date['now']()-_0x28f21e[_0x1f1552(0x1d2)][_0x1f1552(0x18b)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4c4409;}async[a38_0x288775(0x1c4)](_0x4f5530){const _0x9f47aa=a38_0x288775;if(!_0x4f5530[_0x9f47aa(0xf7)]){console[_0x9f47aa(0x19d)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x4f5530['id']+_0x9f47aa(0xfd));return;}console[_0x9f47aa(0x19d)](_0x9f47aa(0x116)+_0x4f5530['gateway']+_0x9f47aa(0x128)+_0x4f5530['id']+'\x20('+_0x4f5530['gatewayPaymentId']+')');try{let _0x3670fe;_0x4f5530[_0x9f47aa(0xc4)]===_0x9f47aa(0x155)?(_0x3670fe=await this[_0x9f47aa(0x1b6)][_0x9f47aa(0xb8)](_0x4f5530[_0x9f47aa(0xf7)]),console[_0x9f47aa(0x19d)]('📊\x20[CHECK]\x20CoinToPay2\x20payment\x20'+_0x4f5530['id']+_0x9f47aa(0xfb)+_0x3670fe[_0x9f47aa(0x1c1)])):(_0x3670fe=await this[_0x9f47aa(0x104)][_0x9f47aa(0xb8)](_0x4f5530[_0x9f47aa(0xf7)]),console[_0x9f47aa(0x19d)](_0x9f47aa(0xec)+_0x4f5530['id']+'\x20status:\x20'+_0x3670fe[_0x9f47aa(0x1c1)]));_0x3670fe[_0x9f47aa(0x151)]&&console[_0x9f47aa(0x19d)](_0x9f47aa(0x181)+_0x4f5530['id']+'\x20details:',{'iban':_0x3670fe['paymentDetails'][_0x9f47aa(0x107)]||_0x9f47aa(0xfc),'transactionId':_0x3670fe[_0x9f47aa(0x151)]['transactionId'],'createdOn':_0x3670fe[_0x9f47aa(0x151)]['createdOn'],'confirmedOn':_0x3670fe['paymentDetails']['confirmedOn']||_0x9f47aa(0x117)});if(_0x3670fe[_0x9f47aa(0x1c1)]!==_0x4f5530[_0x9f47aa(0x1c1)]){console[_0x9f47aa(0x19d)](_0x9f47aa(0x17e)+_0x4f5530['id']+_0x9f47aa(0x1c2)+_0x4f5530[_0x9f47aa(0x1c1)]+_0x9f47aa(0x106)+_0x3670fe['status']),this[_0x9f47aa(0x150)](_0x4f5530['id'],_0x4f5530[_0x9f47aa(0xf7)],_0x4f5530[_0x9f47aa(0x1c1)],_0x3670fe[_0x9f47aa(0x1c1)],'status_check',{'paymentDetails':_0x3670fe[_0x9f47aa(0x151)],'amount':_0x3670fe[_0x9f47aa(0x112)],'currency':_0x3670fe[_0x9f47aa(0x18e)],'shopId':_0x4f5530[_0x9f47aa(0x1cc)],'checkTimestamp':new Date()[_0x9f47aa(0x1b8)]()});const _0x4c61fa={'status':_0x3670fe['status'],'updatedAt':new Date()};if(_0x3670fe['status']===_0x9f47aa(0xfe)&&_0x4f5530[_0x9f47aa(0x1c1)]!==_0x9f47aa(0xfe)){_0x4c61fa[_0x9f47aa(0xc9)]=new Date();if(!_0x4f5530['amountUSDT']){const _0x26d768=await currencyService_1[_0x9f47aa(0x10c)][_0x9f47aa(0x11b)](_0x4f5530['amount'],_0x4f5530[_0x9f47aa(0x18e)]);_0x4c61fa['amountUSDT']=_0x26d768;const _0x20f57e=await this[_0x9f47aa(0x19e)](_0x4f5530[_0x9f47aa(0x1cc)],_0x4f5530[_0x9f47aa(0xc4)]),_0x33ffdb=_0x26d768*(0x1-_0x20f57e/0x64);_0x4c61fa[_0x9f47aa(0x18c)]=_0x33ffdb,_0x4c61fa[_0x9f47aa(0x172)]=_0x20f57e,console[_0x9f47aa(0x19d)]('💰\x20[CHECK]\x20Payment\x20'+_0x4f5530['id']+_0x9f47aa(0x133)),console[_0x9f47aa(0x19d)](_0x9f47aa(0x16b)+_0x4f5530['amount']+'\x20'+_0x4f5530['currency']+_0x9f47aa(0x160)+_0x26d768[_0x9f47aa(0xf2)](0x6)+_0x9f47aa(0xdb)),console[_0x9f47aa(0x19d)](_0x9f47aa(0x14f)+_0x4f5530['gateway']+_0x9f47aa(0x1ac)+_0x20f57e+'%'),console[_0x9f47aa(0x19d)]('\x20\x20\x20Amount\x20after\x20commission:\x20'+_0x33ffdb[_0x9f47aa(0xf2)](0x6)+_0x9f47aa(0xdb));}console[_0x9f47aa(0x19d)]('💰\x20[CHECK]\x20Payment\x20'+_0x4f5530['id']+_0x9f47aa(0xc1)+_0x4c61fa['paidAt']['toISOString']());}if(_0x3670fe[_0x9f47aa(0x151)]){const _0x506480=_0x3670fe[_0x9f47aa(0x151)];_0x506480[_0x9f47aa(0x107)]&&(_0x4c61fa[_0x9f47aa(0x194)]=_0x506480[_0x9f47aa(0x107)],console[_0x9f47aa(0x19d)](_0x9f47aa(0xf6)+_0x506480[_0x9f47aa(0x107)]));if(_0x506480[_0x9f47aa(0xd2)]){const _0x464524=_0x4f5530[_0x9f47aa(0x156)]||'',_0xec008a=_0x9f47aa(0xca)+_0x506480[_0x9f47aa(0xd2)];_0x4c61fa[_0x9f47aa(0x156)]=_0x464524?_0x464524+'\x0a\x0a'+_0xec008a:_0xec008a,console[_0x9f47aa(0x19d)](_0x9f47aa(0x1b2));}_0x506480[_0x9f47aa(0x1ae)]&&console[_0x9f47aa(0x19d)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x506480[_0x9f47aa(0x1ae)]),_0x506480['confirmedOn']&&console[_0x9f47aa(0x19d)](_0x9f47aa(0xe8)+_0x506480[_0x9f47aa(0x17f)]);}await database_1[_0x9f47aa(0x1b1)][_0x9f47aa(0x1b5)]['update']({'where':{'id':_0x4f5530['id']},'data':_0x4c61fa});if(_0x3670fe[_0x9f47aa(0x1c1)]===_0x9f47aa(0xfe)&&_0x4f5530[_0x9f47aa(0x1c1)]!==_0x9f47aa(0xfe)){console[_0x9f47aa(0x19d)](_0x9f47aa(0xf8)+_0x4f5530['id']+_0x9f47aa(0xdf));const _0x1a9746=await database_1[_0x9f47aa(0x1b1)][_0x9f47aa(0x1b5)][_0x9f47aa(0x1c3)]({'where':{'id':_0x4f5530['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x1a9746?.[_0x9f47aa(0x1a8)]&&_0x1a9746[_0x9f47aa(0xcf)])try{const _0xcb2e6d=_0x1a9746[_0x9f47aa(0xcf)];console[_0x9f47aa(0x19d)](_0x9f47aa(0x195)+_0xcb2e6d['id']+_0x9f47aa(0x11d)+_0xcb2e6d['type']+_0x9f47aa(0xc2)+_0xcb2e6d['currentPayments']+_0x9f47aa(0xbe)+_0xcb2e6d[_0x9f47aa(0x1c1)]);const _0x3cb84a=_0xcb2e6d['currentPayments']+0x1,_0x1065b5=_0xcb2e6d[_0x9f47aa(0x173)]==='SINGLE'?_0x9f47aa(0x12b):_0xcb2e6d[_0x9f47aa(0x1c1)];await database_1[_0x9f47aa(0x1b1)]['paymentLink']['update']({'where':{'id':_0xcb2e6d['id']},'data':{'currentPayments':_0x3cb84a,'status':_0x1065b5,'updatedAt':new Date()}}),console[_0x9f47aa(0x19d)](_0x9f47aa(0x130)+_0xcb2e6d['id']+_0x9f47aa(0x159)+_0xcb2e6d[_0x9f47aa(0xb9)]+_0x9f47aa(0x160)+_0x3cb84a+_0x9f47aa(0xbe)+_0xcb2e6d[_0x9f47aa(0x1c1)]+_0x9f47aa(0x160)+_0x1065b5);}catch(_0x4c0d3f){console[_0x9f47aa(0x134)](_0x9f47aa(0x15b),_0x4c0d3f);}else console[_0x9f47aa(0x19d)](_0x9f47aa(0xf8)+_0x4f5530['id']+_0x9f47aa(0x120));}await database_1[_0x9f47aa(0x1b1)][_0x9f47aa(0x13b)]['create']({'data':{'paymentId':_0x4f5530['id'],'shopId':_0x4f5530[_0x9f47aa(0x1cc)],'event':_0x9f47aa(0x1a6)+_0x3670fe[_0x9f47aa(0x1c1)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x9f47aa(0x132)]({'oldStatus':_0x4f5530[_0x9f47aa(0x1c1)],'newStatus':_0x3670fe[_0x9f47aa(0x1c1)],'paymentDetails':_0x3670fe[_0x9f47aa(0x151)],'checkedAt':new Date()[_0x9f47aa(0x1b8)]()})}}),await this[_0x9f47aa(0x11e)](_0x4f5530,_0x3670fe[_0x9f47aa(0x1c1)]),await this['sendPaymentStatusNotification'](_0x4f5530,_0x3670fe[_0x9f47aa(0x1c1)]),_0x3670fe[_0x9f47aa(0x1c1)]!==_0x9f47aa(0x1a7)&&(console[_0x9f47aa(0x19d)](_0x9f47aa(0x166)+_0x4f5530['id']+_0x9f47aa(0xce)+_0x3670fe['status']+',\x20clearing\x20individual\x20timers'),this[_0x9f47aa(0xd4)](_0x4f5530['id'])),console[_0x9f47aa(0x19d)](_0x9f47aa(0x147)+_0x4f5530['id']+_0x9f47aa(0xd0));}else console[_0x9f47aa(0x19d)]('📊\x20[CHECK]\x20Payment\x20'+_0x4f5530['id']+_0x9f47aa(0x1ad)+_0x3670fe[_0x9f47aa(0x1c1)]+')'),this[_0x9f47aa(0x150)](_0x4f5530['id'],_0x4f5530[_0x9f47aa(0xf7)],_0x4f5530[_0x9f47aa(0x1c1)],_0x3670fe[_0x9f47aa(0x1c1)],_0x9f47aa(0x171),{'statusUnchanged':!![],'paymentDetails':_0x3670fe[_0x9f47aa(0x151)],'amount':_0x3670fe[_0x9f47aa(0x112)],'currency':_0x3670fe[_0x9f47aa(0x18e)],'shopId':_0x4f5530[_0x9f47aa(0x1cc)],'checkTimestamp':new Date()[_0x9f47aa(0x1b8)]()});}catch(_0x523dfc){console[_0x9f47aa(0x134)](_0x9f47aa(0x1cd)+_0x4f5530['id']+':',_0x523dfc),this[_0x9f47aa(0x1d3)](_0x4f5530['id'],_0x4f5530[_0x9f47aa(0xf7)],_0x523dfc,_0x9f47aa(0x171),{'paymentAmount':_0x4f5530[_0x9f47aa(0x112)],'paymentCurrency':_0x4f5530['currency'],'shopId':_0x4f5530[_0x9f47aa(0x1cc)],'createdAt':_0x4f5530[_0x9f47aa(0x1d2)]}),await database_1[_0x9f47aa(0x1b1)][_0x9f47aa(0x13b)][_0x9f47aa(0x1b9)]({'data':{'paymentId':_0x4f5530['id'],'shopId':_0x4f5530[_0x9f47aa(0x1cc)],'event':_0x9f47aa(0x149),'statusCode':0x1f4,'responseBody':JSON[_0x9f47aa(0x132)]({'error':_0x523dfc instanceof Error?_0x523dfc['message']:'Unknown\x20error','gatewayPaymentId':_0x4f5530[_0x9f47aa(0xf7)],'checkedAt':new Date()[_0x9f47aa(0x1b8)]()})}});}}async['sendShopWebhook'](_0x3f6b08,_0x18b99c){const _0x5c3971=a38_0x288775,_0x43319d=Date['now']();try{const _0x63f079=_0x3f6b08[_0x5c3971(0x170)],_0x18bcad=_0x63f079[_0x5c3971(0x182)];if(!_0x18bcad?.[_0x5c3971(0xd9)]){console[_0x5c3971(0x19d)](_0x5c3971(0x12e)+_0x63f079['id']);return;}const _0x4e4a68=_0x18b99c===_0x5c3971(0xfe)?_0x5c3971(0xc0):_0x18b99c===_0x5c3971(0x135)?'payment.failed':_0x18b99c===_0x5c3971(0x18d)?_0x5c3971(0x19b):_0x5c3971(0xea);if(!_0x18bcad[_0x5c3971(0x1a1)]?.['includes'](_0x4e4a68)){console[_0x5c3971(0x19d)]('Webhook\x20event\x20'+_0x4e4a68+'\x20not\x20enabled\x20for\x20shop\x20'+_0x63f079['id']);return;}const _0x351b17=(0x0,gateway_1[_0x5c3971(0x18a)])(_0x3f6b08[_0x5c3971(0xc4)])||_0x3f6b08[_0x5c3971(0xc4)],_0x170a84={'event':_0x4e4a68,'payment':{'id':_0x3f6b08['id'],'order_id':_0x3f6b08[_0x5c3971(0x103)],'gateway_order_id':_0x3f6b08[_0x5c3971(0x15c)],'gateway':_0x351b17,'amount':_0x3f6b08['amount'],'currency':_0x3f6b08[_0x5c3971(0x18e)],'status':_0x18b99c['toLowerCase'](),'customer_email':_0x3f6b08[_0x5c3971(0x122)],'customer_name':_0x3f6b08[_0x5c3971(0x167)],'created_at':_0x3f6b08[_0x5c3971(0x1d2)],'updated_at':new Date()}},_0x98ea90=await fetch(_0x18bcad['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x5c3971(0x1d4),'User-Agent':_0x5c3971(0xe6)},'body':JSON[_0x5c3971(0x132)](_0x170a84)}),_0x1e6ab6=Date[_0x5c3971(0xde)]()-_0x43319d,_0x522806=_0x98ea90['ok']?_0x5c3971(0x101):await _0x98ea90['text']();loggerService_1[_0x5c3971(0x110)][_0x5c3971(0x169)](_0x3f6b08['shopId'],_0x18bcad[_0x5c3971(0xd9)],_0x4e4a68,_0x98ea90[_0x5c3971(0x1c1)],_0x1e6ab6,_0x170a84),console[_0x5c3971(0x19d)](_0x5c3971(0x1c7)+_0x18bcad['webhookUrl']+_0x5c3971(0x12a)+_0x98ea90[_0x5c3971(0x1c1)]+'\x20('+_0x1e6ab6+'ms)');}catch(_0x2d05f3){console[_0x5c3971(0x134)](_0x5c3971(0x189),_0x2d05f3),loggerService_1['loggerService']['logShopWebhookError'](_0x3f6b08[_0x5c3971(0x1cc)],_0x3f6b08[_0x5c3971(0x170)]?.[_0x5c3971(0x182)]?.[_0x5c3971(0xd9)]||_0x5c3971(0x141),_0x5c3971(0x11a),_0x2d05f3,{});}}async[a38_0x288775(0xff)](_0x1d3514,_0xbae8f6){const _0x4abedb=a38_0x288775;try{const _0x126504={'PENDING':'created','PAID':_0x4abedb(0xef),'FAILED':_0x4abedb(0x15e),'EXPIRED':_0x4abedb(0x11c)},_0x5ac789=_0x126504[_0xbae8f6];if(!_0x5ac789||_0x5ac789===_0x4abedb(0x17c))return;await telegramBotService_1[_0x4abedb(0x1c9)]['sendPaymentNotification'](_0x1d3514[_0x4abedb(0x1cc)],_0x1d3514,_0x5ac789);}catch(_0x294cc0){console['error'](_0x4abedb(0x148),_0x294cc0);}}async[a38_0x288775(0x1d0)](_0x1fec60){const _0x1582f2=a38_0x288775;console[_0x1582f2(0x19d)](_0x1582f2(0x100)+_0x1fec60);const _0x22091c=await database_1[_0x1582f2(0x1b1)]['payment'][_0x1582f2(0x1c3)]({'where':{'id':_0x1fec60},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22091c)throw new Error(_0x1582f2(0x165));if(_0x22091c[_0x1582f2(0xc4)]!==_0x1582f2(0x185)&&_0x22091c[_0x1582f2(0xc4)]!==_0x1582f2(0x155))throw new Error(_0x1582f2(0xdc));console[_0x1582f2(0x19d)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x22091c['gateway']+_0x1582f2(0x128)+_0x1fec60),await this['checkSinglePayment'](_0x22091c),console[_0x1582f2(0x19d)]('✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20'+_0x1fec60);}[a38_0x288775(0xd5)](){const _0x18bec8=a38_0x288775,_0x6c8578=this[_0x18bec8(0x1a0)]?this[_0x18bec8(0x144)]:undefined,_0x2959eb=Array[_0x18bec8(0x12f)](this[_0x18bec8(0x13c)][_0x18bec8(0xba)]())[_0x18bec8(0x15a)](_0x37cefd=>({'paymentId':_0x37cefd[_0x18bec8(0x10e)],'gatewayPaymentId':_0x37cefd[_0x18bec8(0xf7)],'createdAt':_0x37cefd['createdAt'],'timersCount':_0x37cefd['timers'][_0x18bec8(0x143)]}));return{'isActive':!!this[_0x18bec8(0x1a0)],'globalCheckIntervalMinutes':this[_0x18bec8(0x144)]/(0x3e8*0x3c),'expiryDays':this[_0x18bec8(0xdd)],'activeIndividualTimers':this[_0x18bec8(0x13c)][_0x18bec8(0x140)],'nextGlobalCheckIn':_0x6c8578,'paymentTimersDetails':_0x2959eb};}[a38_0x288775(0x13e)](_0x1ef237){const _0x32f4b9=a38_0x288775,_0x3f1925=this[_0x32f4b9(0x13c)][_0x32f4b9(0x105)](_0x1ef237);if(_0x3f1925)return{'hasTimers':!![],'timersCount':_0x3f1925[_0x32f4b9(0x177)]['length'],'createdAt':_0x3f1925[_0x32f4b9(0x1d2)],'gatewayPaymentId':_0x3f1925[_0x32f4b9(0xf7)]};return{'hasTimers':![]};}async[a38_0x288775(0x19e)](_0xc5c090,_0xe6fed){const _0x4effab=a38_0x288775;try{const _0x50a261=await database_1[_0x4effab(0x1b1)][_0x4effab(0x170)]['findUnique']({'where':{'id':_0xc5c090},'select':{'gatewaySettings':!![]}});if(!_0x50a261?.[_0x4effab(0x146)])return console[_0x4effab(0x19d)](_0x4effab(0x13f)+_0xc5c090+_0x4effab(0x1be)),0xa;const _0x487392=JSON['parse'](_0x50a261[_0x4effab(0x146)]);for(const [_0x4790e4,_0x460d44]of Object[_0x4effab(0x1b7)](_0x487392)){if(_0x4790e4[_0x4effab(0x127)]()===_0xe6fed['toLowerCase']()){const _0x3b01d4=_0x460d44[_0x4effab(0x176)]||0xa;return console['log']('Gateway\x20'+_0xe6fed+_0x4effab(0x129)+_0xc5c090+':\x20'+_0x3b01d4+'%'),_0x3b01d4;}}return console[_0x4effab(0x19d)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0xe6fed+_0x4effab(0x1cb)+_0xc5c090+_0x4effab(0x131)),0xa;}catch(_0x15a88a){return console[_0x4effab(0x134)](_0x4effab(0x109)+_0xc5c090+_0x4effab(0x1ab)+_0xe6fed+':',_0x15a88a),0xa;}}}exports[a38_0x288775(0x115)]=CoinToPayStatusService,exports[a38_0x288775(0x179)]=new CoinToPayStatusService();