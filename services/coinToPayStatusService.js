'use strict';const a35_0x27ece4=a35_0x5544;(function(_0x71d206,_0x2e534a){const _0xd8f37f=a35_0x5544,_0x351f32=_0x71d206();while(!![]){try{const _0x55a2cb=parseInt(_0xd8f37f(0xb5))/0x1+parseInt(_0xd8f37f(0xf3))/0x2+parseInt(_0xd8f37f(0xd8))/0x3+parseInt(_0xd8f37f(0x113))/0x4+-parseInt(_0xd8f37f(0xee))/0x5+-parseInt(_0xd8f37f(0xbb))/0x6*(parseInt(_0xd8f37f(0xc9))/0x7)+parseInt(_0xd8f37f(0x122))/0x8*(-parseInt(_0xd8f37f(0x10c))/0x9);if(_0x55a2cb===_0x2e534a)break;else _0x351f32['push'](_0x351f32['shift']());}catch(_0x5e4bb6){_0x351f32['push'](_0x351f32['shift']());}}}(a35_0x3e9d,0x6a8b5));function a35_0x5544(_0x593e02,_0x5914ab){const _0x3e9d46=a35_0x3e9d();return a35_0x5544=function(_0x5544ea,_0x44e712){_0x5544ea=_0x5544ea-0xac;let _0x5ecf6f=_0x3e9d46[_0x5544ea];return _0x5ecf6f;},a35_0x5544(_0x593e02,_0x5914ab);}var __importDefault=this&&this[a35_0x27ece4(0xd5)]||function(_0x3f5545){const _0x58db69=a35_0x27ece4;return _0x3f5545&&_0x3f5545[_0x58db69(0x12a)]?_0x3f5545:{'default':_0x3f5545};};Object[a35_0x27ece4(0xe5)](exports,a35_0x27ece4(0x12a),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x27ece4(0xcd)]=void 0x0;const coinToPayService_1=require(a35_0x27ece4(0x111)),database_1=__importDefault(require(a35_0x27ece4(0x123))),telegramBotService_1=require(a35_0x27ece4(0x117)),loggerService_1=require(a35_0x27ece4(0xed));function a35_0x3e9d(){const _0x527df7=['not\x20confirmed','checkPaymentStatus','CHECK_INTERVAL_MS','EXPIRY_DAYS','amount','âœ…\x20Completed\x20checking\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','\x20status\x20unchanged\x20(','sendPaymentStatusNotification','log','Periodic\x20CoinToPay\x20status\x20check\x20failed:','Automatically\x20expired\x20after\x20','7cHVntj','ðŸ“Š\x20Payment\x20','telegramBotService','âš ï¸\x20Payment\x20','CoinToPayStatusService','\x20with\x20status\x20','0100','\x20status:\x20','loggerService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','gateway','bankDetails','__importDefault','status','created','1068249iIOsHy','â°\x20Found\x20','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','stringify','toISOString','checkPaymentById','FAILED','\x20days,\x20marking\x20as\x20EXPIRED','payment.success','\x20updated\x20successfully','toLowerCase','checkInterval','shopId','defineProperty','checkSinglePayment','âœ…\x20Payment\x20','error','-day\x20timeout','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','ðŸª™\x20Checking\x20','unknown','./loggerService','3575670pSNcGw','logShopWebhookError','getTime','Failed\x20to\x20check\x20payment\x20','createdAt','910628exkvqE','\x20expired\x20CoinToPay\x20payments','Bank\x20Details:\x20','length','expired','remitterIban','failed','startPeriodicStatusCheck','update','\x20days\x20(created\x20before\x20','not\x20found','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','sendShopWebhook','ðŸ”„\x20Updating\x20payment\x20','getDate','CoinToPayService','PENDING','Payment\x20not\x20found','message','confirmedOn','settings','Webhook\x20event\x20','includes','shop','gatewayOrderId','6057tLJJjF','coinToPayService','catch','checkAllPendingPayments','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','./gateways/coinToPayService','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','2072824YcNgyM','adminNotes','application/json','checkExpiredPayments','./telegramBotService','webhookLog','ðŸ’°\x20Payment\x20','transactionId','payment.pending','cointopay','webhookUrl','\x20is\x20older\x20than\x20','now','â°\x20Payment\x20','EXPIRED','1816gqgHFG','../config/database','cointopay_auto_expired','gatewayPaymentId','payment','ms)','floor','paymentDetails','__esModule','\x20pending\x20CoinToPay\x20payments','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','create','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','\x20to\x20','coinToPayStatusService','cointopay_status_check_error','currency','payment.failed','iban','Success','customerEmail','PAID','\x20details:','\x20days','setDate','Payment\x20older\x20than\x20','webhookEvents','287269eEfkvj','webhook_send','Unknown\x20error','Failed\x20to\x20expire\x20payment\x20','logShopWebhookSent','default','1875372wQcqfO','Failed\x20to\x20send\x20shop\x20webhook:'];a35_0x3e9d=function(){return _0x527df7;};return a35_0x3e9d();}class CoinToPayStatusService{constructor(){const _0x3c63d3=a35_0x27ece4;this[_0x3c63d3(0xe3)]=null,this[_0x3c63d3(0xbf)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x3c63d3(0x10d)]=new coinToPayService_1[(_0x3c63d3(0x102))]();}[a35_0x27ece4(0xfa)](){const _0x5b22aa=a35_0x27ece4;console[_0x5b22aa(0xc6)](_0x5b22aa(0x112)),this['checkAllPendingPayments']()[_0x5b22aa(0x10e)](_0x1e88cc=>{console['error']('Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x1e88cc);}),this['checkInterval']=setInterval(async()=>{const _0x5a3419=_0x5b22aa;try{await this[_0x5a3419(0x10f)]();}catch(_0x3fb523){console[_0x5a3419(0xe8)](_0x5a3419(0xc7),_0x3fb523);}},this[_0x5b22aa(0xbf)]),console[_0x5b22aa(0xc6)]('âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)');}['stopPeriodicStatusCheck'](){const _0x2869b1=a35_0x27ece4;this[_0x2869b1(0xe3)]&&(clearInterval(this[_0x2869b1(0xe3)]),this[_0x2869b1(0xe3)]=null,console[_0x2869b1(0xc6)](_0x2869b1(0x12c)));}async[a35_0x27ece4(0x10f)](){const _0x44849f=a35_0x27ece4;try{const _0x2a6eec=await database_1[_0x44849f(0xba)][_0x44849f(0x126)]['findMany']({'where':{'gateway':_0x44849f(0x11c),'status':_0x44849f(0x103),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x2a6eec['length']===0x0){console[_0x44849f(0xc6)](_0x44849f(0xda));return;}console['log'](_0x44849f(0xeb)+_0x2a6eec[_0x44849f(0xf6)]+_0x44849f(0x12b));const _0x348b8e=await this[_0x44849f(0x116)](_0x2a6eec);console['log'](_0x44849f(0xd9)+_0x348b8e['length']+_0x44849f(0xf4));for(const _0xcb3645 of _0x2a6eec){try{if(_0x348b8e[_0x44849f(0x109)](_0xcb3645['id'])){console[_0x44849f(0xc6)](_0x44849f(0x120)+_0xcb3645['id']+_0x44849f(0xc3));continue;}await this[_0x44849f(0xe6)](_0xcb3645),await new Promise(_0x3e8b1b=>setTimeout(_0x3e8b1b,0x7d0));}catch(_0x168745){console[_0x44849f(0xe8)](_0x44849f(0x110)+_0xcb3645['id']+':',_0x168745),loggerService_1['loggerService']['logWhiteDomainError'](_0x44849f(0x11c),'/status/'+_0xcb3645[_0x44849f(0x125)],_0x168745);}}console[_0x44849f(0xc6)](_0x44849f(0xc2)+_0x2a6eec[_0x44849f(0xf6)]+'\x20CoinToPay\x20payments');}catch(_0x214ec1){console[_0x44849f(0xe8)]('Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x214ec1);}}async[a35_0x27ece4(0x116)](_0x42392f){const _0x2a61ad=a35_0x27ece4,_0x325391=[],_0x541abf=new Date();_0x541abf[_0x2a61ad(0xb2)](_0x541abf[_0x2a61ad(0x101)]()-this[_0x2a61ad(0xc0)]),console['log'](_0x2a61ad(0xfe)+this[_0x2a61ad(0xc0)]+_0x2a61ad(0xfc)+_0x541abf[_0x2a61ad(0xdc)]()+')');for(const _0x5cf30c of _0x42392f){if(_0x5cf30c[_0x2a61ad(0xf2)]<_0x541abf){console[_0x2a61ad(0xc6)](_0x2a61ad(0x120)+_0x5cf30c['id']+_0x2a61ad(0x11e)+this[_0x2a61ad(0xc0)]+_0x2a61ad(0xdf));try{await database_1['default']['payment'][_0x2a61ad(0xfb)]({'where':{'id':_0x5cf30c['id']},'data':{'status':_0x2a61ad(0x121),'updatedAt':new Date(),'adminNotes':_0x2a61ad(0xc8)+this[_0x2a61ad(0xc0)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1[_0x2a61ad(0xba)][_0x2a61ad(0x118)]['create']({'data':{'paymentId':_0x5cf30c['id'],'shopId':_0x5cf30c[_0x2a61ad(0xe4)],'event':_0x2a61ad(0x124),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x2a61ad(0xb3)+this[_0x2a61ad(0xc0)]+_0x2a61ad(0xb1),'createdAt':_0x5cf30c[_0x2a61ad(0xf2)],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x2a61ad(0x128)]((Date[_0x2a61ad(0x11f)]()-_0x5cf30c[_0x2a61ad(0xf2)][_0x2a61ad(0xf0)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x2a61ad(0xff)](_0x5cf30c,_0x2a61ad(0x121)),await this[_0x2a61ad(0xc5)](_0x5cf30c,_0x2a61ad(0x121)),_0x325391['push'](_0x5cf30c['id']),console[_0x2a61ad(0xc6)](_0x2a61ad(0xe7)+_0x5cf30c['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x2a61ad(0xc0)]+_0x2a61ad(0xe9));}catch(_0x3f51b6){console[_0x2a61ad(0xe8)](_0x2a61ad(0xb8)+_0x5cf30c['id']+':',_0x3f51b6);}}}return _0x325391;}async[a35_0x27ece4(0xe6)](_0x479ab9){const _0x3dcc4c=a35_0x27ece4;if(!_0x479ab9['gatewayPaymentId']){console[_0x3dcc4c(0xc6)](_0x3dcc4c(0xcc)+_0x479ab9['id']+_0x3dcc4c(0xd2));return;}console[_0x3dcc4c(0xc6)](_0x3dcc4c(0x12e)+_0x479ab9['id']+'\x20('+_0x479ab9[_0x3dcc4c(0x125)]+')');try{const _0x36c474=await this[_0x3dcc4c(0x10d)][_0x3dcc4c(0xbe)](_0x479ab9[_0x3dcc4c(0x125)]);console[_0x3dcc4c(0xc6)]('ðŸ“Š\x20Payment\x20'+_0x479ab9['id']+_0x3dcc4c(0xd0)+_0x36c474[_0x3dcc4c(0xd6)]);_0x36c474[_0x3dcc4c(0x129)]&&console['log'](_0x3dcc4c(0xca)+_0x479ab9['id']+_0x3dcc4c(0xb0),{'iban':_0x36c474[_0x3dcc4c(0x129)][_0x3dcc4c(0xac)]||_0x3dcc4c(0xfd),'transactionId':_0x36c474[_0x3dcc4c(0x129)]['transactionId'],'createdOn':_0x36c474[_0x3dcc4c(0x129)]['createdOn'],'confirmedOn':_0x36c474['paymentDetails'][_0x3dcc4c(0x106)]||_0x3dcc4c(0xbd)});if(_0x36c474[_0x3dcc4c(0xd6)]!==_0x479ab9[_0x3dcc4c(0xd6)]){console['log'](_0x3dcc4c(0x100)+_0x479ab9['id']+'\x20status\x20from\x20'+_0x479ab9[_0x3dcc4c(0xd6)]+_0x3dcc4c(0x12f)+_0x36c474['status']);const _0x765406={'status':_0x36c474[_0x3dcc4c(0xd6)],'updatedAt':new Date()};_0x36c474[_0x3dcc4c(0xd6)]===_0x3dcc4c(0xaf)&&_0x479ab9[_0x3dcc4c(0xd6)]!==_0x3dcc4c(0xaf)&&(_0x765406['paidAt']=new Date(),console['log'](_0x3dcc4c(0x119)+_0x479ab9['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x765406['paidAt'][_0x3dcc4c(0xdc)]()));if(_0x36c474[_0x3dcc4c(0x129)]){const _0x2ed845=_0x36c474['paymentDetails'];_0x2ed845['iban']&&(_0x765406[_0x3dcc4c(0xf8)]=_0x2ed845[_0x3dcc4c(0xac)],console[_0x3dcc4c(0xc6)]('ðŸ¦\x20Saved\x20IBAN:\x20'+_0x2ed845[_0x3dcc4c(0xac)]));if(_0x2ed845[_0x3dcc4c(0xd4)]){const _0x4b970c=_0x479ab9[_0x3dcc4c(0x114)]||'',_0x4c79f4=_0x3dcc4c(0xf5)+_0x2ed845[_0x3dcc4c(0xd4)];_0x765406['adminNotes']=_0x4b970c?_0x4b970c+'\x0a\x0a'+_0x4c79f4:_0x4c79f4,console[_0x3dcc4c(0xc6)]('ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x2ed845['transactionId']&&console[_0x3dcc4c(0xc6)]('ðŸ†”\x20Transaction\x20ID:\x20'+_0x2ed845[_0x3dcc4c(0x11a)]),_0x2ed845[_0x3dcc4c(0x106)]&&console[_0x3dcc4c(0xc6)]('âœ…\x20Transaction\x20confirmed\x20on:\x20'+_0x2ed845[_0x3dcc4c(0x106)]);}await database_1[_0x3dcc4c(0xba)][_0x3dcc4c(0x126)]['update']({'where':{'id':_0x479ab9['id']},'data':_0x765406}),await database_1[_0x3dcc4c(0xba)]['webhookLog'][_0x3dcc4c(0x12d)]({'data':{'paymentId':_0x479ab9['id'],'shopId':_0x479ab9[_0x3dcc4c(0xe4)],'event':'cointopay_status_check_'+_0x36c474[_0x3dcc4c(0xd6)][_0x3dcc4c(0xe2)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x479ab9[_0x3dcc4c(0xd6)],'newStatus':_0x36c474[_0x3dcc4c(0xd6)],'paymentDetails':_0x36c474[_0x3dcc4c(0x129)],'checkedAt':new Date()[_0x3dcc4c(0xdc)]()})}}),await this[_0x3dcc4c(0xff)](_0x479ab9,_0x36c474[_0x3dcc4c(0xd6)]),await this[_0x3dcc4c(0xc5)](_0x479ab9,_0x36c474[_0x3dcc4c(0xd6)]),console[_0x3dcc4c(0xc6)]('âœ…\x20Payment\x20'+_0x479ab9['id']+_0x3dcc4c(0xe1));}else console[_0x3dcc4c(0xc6)]('ðŸ“Š\x20Payment\x20'+_0x479ab9['id']+_0x3dcc4c(0xc4)+_0x36c474[_0x3dcc4c(0xd6)]+')');}catch(_0xacca01){console[_0x3dcc4c(0xe8)](_0x3dcc4c(0xf1)+_0x479ab9['id']+':',_0xacca01),await database_1[_0x3dcc4c(0xba)]['webhookLog']['create']({'data':{'paymentId':_0x479ab9['id'],'shopId':_0x479ab9[_0x3dcc4c(0xe4)],'event':_0x3dcc4c(0x131),'statusCode':0x1f4,'responseBody':JSON[_0x3dcc4c(0xdb)]({'error':_0xacca01 instanceof Error?_0xacca01[_0x3dcc4c(0x105)]:_0x3dcc4c(0xb7),'gatewayPaymentId':_0x479ab9[_0x3dcc4c(0x125)],'checkedAt':new Date()['toISOString']()})}});}}async[a35_0x27ece4(0xff)](_0x4f5021,_0xd4fcb3){const _0x5cbe9d=a35_0x27ece4,_0x5c4306=Date[_0x5cbe9d(0x11f)]();try{const _0x3f41c3=_0x4f5021[_0x5cbe9d(0x10a)],_0xe7ec9=_0x3f41c3[_0x5cbe9d(0x107)];if(!_0xe7ec9?.[_0x5cbe9d(0x11d)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3f41c3['id']);return;}const _0x197560=_0xd4fcb3===_0x5cbe9d(0xaf)?_0x5cbe9d(0xe0):_0xd4fcb3===_0x5cbe9d(0xde)?_0x5cbe9d(0x133):_0xd4fcb3==='EXPIRED'?_0x5cbe9d(0x133):_0x5cbe9d(0x11b);if(!_0xe7ec9[_0x5cbe9d(0xb4)]?.[_0x5cbe9d(0x109)](_0x197560)){console[_0x5cbe9d(0xc6)](_0x5cbe9d(0x108)+_0x197560+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3f41c3['id']);return;}const _0x46fd38={'event':_0x197560,'payment':{'id':_0x4f5021['id'],'order_id':_0x4f5021['orderId'],'gateway_order_id':_0x4f5021[_0x5cbe9d(0x10b)],'gateway':_0x5cbe9d(0xcf),'amount':_0x4f5021[_0x5cbe9d(0xc1)],'currency':_0x4f5021[_0x5cbe9d(0x132)],'status':_0xd4fcb3[_0x5cbe9d(0xe2)](),'customer_email':_0x4f5021[_0x5cbe9d(0xae)],'customer_name':_0x4f5021['customerName'],'created_at':_0x4f5021[_0x5cbe9d(0xf2)],'updated_at':new Date()}},_0x5df590=await fetch(_0xe7ec9['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x5cbe9d(0x115),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x5cbe9d(0xdb)](_0x46fd38)}),_0x1093e5=Date[_0x5cbe9d(0x11f)]()-_0x5c4306,_0x57afe=_0x5df590['ok']?_0x5cbe9d(0xad):await _0x5df590['text']();loggerService_1['loggerService'][_0x5cbe9d(0xb9)](_0x4f5021[_0x5cbe9d(0xe4)],_0xe7ec9['webhookUrl'],_0x197560,_0x5df590[_0x5cbe9d(0xd6)],_0x1093e5,_0x46fd38),console[_0x5cbe9d(0xc6)]('Shop\x20webhook\x20sent\x20to\x20'+_0xe7ec9[_0x5cbe9d(0x11d)]+_0x5cbe9d(0xce)+_0x5df590['status']+'\x20('+_0x1093e5+_0x5cbe9d(0x127));}catch(_0x133de9){console[_0x5cbe9d(0xe8)](_0x5cbe9d(0xbc),_0x133de9),loggerService_1[_0x5cbe9d(0xd1)][_0x5cbe9d(0xef)](_0x4f5021[_0x5cbe9d(0xe4)],_0x4f5021['shop']?.[_0x5cbe9d(0x107)]?.[_0x5cbe9d(0x11d)]||_0x5cbe9d(0xec),_0x5cbe9d(0xb6),_0x133de9,{});}}async[a35_0x27ece4(0xc5)](_0x45da19,_0x2bbea2){const _0x3d0690=a35_0x27ece4;try{const _0x27fbe8={'PENDING':_0x3d0690(0xd7),'PAID':'paid','FAILED':_0x3d0690(0xf9),'EXPIRED':_0x3d0690(0xf7)},_0x4ab0a0=_0x27fbe8[_0x2bbea2];if(!_0x4ab0a0||_0x4ab0a0===_0x3d0690(0xd7))return;await telegramBotService_1[_0x3d0690(0xcb)]['sendPaymentNotification'](_0x45da19[_0x3d0690(0xe4)],_0x45da19,_0x4ab0a0);}catch(_0xa3f5f0){console[_0x3d0690(0xe8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xa3f5f0);}}async[a35_0x27ece4(0xdd)](_0x423c0b){const _0x2f6ec3=a35_0x27ece4,_0x11fafb=await database_1[_0x2f6ec3(0xba)][_0x2f6ec3(0x126)]['findUnique']({'where':{'id':_0x423c0b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x11fafb)throw new Error(_0x2f6ec3(0x104));if(_0x11fafb[_0x2f6ec3(0xd3)]!==_0x2f6ec3(0x11c))throw new Error(_0x2f6ec3(0xea));await this['checkSinglePayment'](_0x11fafb);}['getServiceStats'](){const _0x514d6c=a35_0x27ece4,_0x398dd2=this[_0x514d6c(0xe3)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x514d6c(0xe3)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'nextCheckIn':_0x398dd2};}}exports[a35_0x27ece4(0xcd)]=CoinToPayStatusService,exports[a35_0x27ece4(0x130)]=new CoinToPayStatusService();