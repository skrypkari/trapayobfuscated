'use strict';const a35_0x1f7993=a35_0x291e;function a35_0x291e(_0x592009,_0x594157){const _0x4ed995=a35_0x4ed9();return a35_0x291e=function(_0x291e3f,_0x107e15){_0x291e3f=_0x291e3f-0x1ef;let _0x52932c=_0x4ed995[_0x291e3f];return _0x52932c;},a35_0x291e(_0x592009,_0x594157);}(function(_0x5c91ee,_0x2e512e){const _0x283e07=a35_0x291e,_0x5992d3=_0x5c91ee();while(!![]){try{const _0x496d02=-parseInt(_0x283e07(0x22e))/0x1*(parseInt(_0x283e07(0x1fb))/0x2)+parseInt(_0x283e07(0x202))/0x3*(-parseInt(_0x283e07(0x257))/0x4)+parseInt(_0x283e07(0x200))/0x5+-parseInt(_0x283e07(0x20f))/0x6*(parseInt(_0x283e07(0x210))/0x7)+parseInt(_0x283e07(0x251))/0x8*(parseInt(_0x283e07(0x227))/0x9)+parseInt(_0x283e07(0x215))/0xa*(-parseInt(_0x283e07(0x262))/0xb)+parseInt(_0x283e07(0x25b))/0xc;if(_0x496d02===_0x2e512e)break;else _0x5992d3['push'](_0x5992d3['shift']());}catch(_0x4c50a6){_0x5992d3['push'](_0x5992d3['shift']());}}}(a35_0x4ed9,0x760da));var __importDefault=this&&this['__importDefault']||function(_0x2f94f2){const _0x1da47d=a35_0x291e;return _0x2f94f2&&_0x2f94f2[_0x1da47d(0x1f0)]?_0x2f94f2:{'default':_0x2f94f2};};Object[a35_0x1f7993(0x1f2)](exports,'__esModule',{'value':!![]}),exports[a35_0x1f7993(0x26a)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a35_0x1f7993(0x240)),database_1=__importDefault(require(a35_0x1f7993(0x278))),telegramBotService_1=require(a35_0x1f7993(0x217)),loggerService_1=require('./loggerService');function a35_0x4ed9(){const _0x45175e=['Initial\x20CoinToPay\x20status\x20check\x20failed:','Payment\x20older\x20than\x20','not\x20confirmed','customerName','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','../config/database','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','findMany','stopPeriodicStatusCheck','webhookUrl','paidAt','\x20updated\x20successfully','__esModule','toISOString','defineProperty','length','CHECK_INTERVAL_MS','confirmedOn','shop','application/json','\x20status:\x20','âœ…\x20Payment\x20','logShopWebhookSent','225260VwHByd','findUnique','-day\x20timeout','toLowerCase','\x20marked\x20as\x20paid\x20at:\x20','4065535mbQLyy','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','41589qHqyfw','createdOn','ðŸ†”\x20Transaction\x20ID:\x20','catch','unknown','Unknown\x20error','checkExpiredPayments','â°\x20Found\x20','checkAllPendingPayments','\x20days\x20without\x20payment\x20confirmation','stringify','Bank\x20Details:\x20','update','36uxsggB','213703NIRCJq','checkInterval','Periodic\x20CoinToPay\x20status\x20check\x20failed:','TesSoft\x20Payment\x20System/1.0','ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','8458090GPTkKA','sendShopWebhook','./telegramBotService','currency','checkPaymentStatus','âœ…\x20Transaction\x20confirmed\x20on:\x20','ðŸ¦\x20Saved\x20IBAN:\x20','Shop\x20webhook\x20sent\x20to\x20','\x20not\x20enabled\x20for\x20shop\x20','default','/status/','cointopay_status_check_','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','Automatically\x20expired\x20after\x20','gatewayPaymentId','\x20pending\x20CoinToPay\x20payments','created','ðŸ’°\x20Payment\x20','2207484vvmOWZ','remitterIban','adminNotes','create','ðŸ“Š\x20Payment\x20','not\x20found','settings','8PMsUFn','\x20days','amount','Payment\x20not\x20found','\x20is\x20older\x20than\x20','âœ…\x20Completed\x20checking\x20','CoinToPayService','0100','Success','paid','setDate','\x20has\x20no\x20gatewayPaymentId,\x20skipping','iban','log','POST','webhookLog','customerEmail','telegramBotService','./gateways/coinToPayService','logWhiteDomainError','transactionId','Failed\x20to\x20check\x20payment\x20','createdAt','\x20to\x20','PENDING','\x20days,\x20marking\x20as\x20EXPIRED','error','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','cointopay_status_check_error','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','now','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','loggerService','EXPIRY_DAYS','shopId','16cPGFcd','webhookEvents','payment.failed','â°\x20Payment\x20','\x20status\x20from\x20','payment.success','132eSJakU','webhook_send','checkPaymentById','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','18808668mlEmPG','status','sendPaymentStatusNotification','ðŸª™\x20Checking\x20','paymentDetails','checkSinglePayment','orderId','11WCnWlQ','payment','\x20CoinToPay\x20payments','FAILED','startPeriodicStatusCheck','PAID','coinToPayService','cointopay','coinToPayStatusService','EXPIRED','message','bankDetails','sendPaymentNotification','push','\x20with\x20status\x20','includes'];a35_0x4ed9=function(){return _0x45175e;};return a35_0x4ed9();}class CoinToPayStatusService{constructor(){const _0x29d531=a35_0x1f7993;this[_0x29d531(0x211)]=null,this[_0x29d531(0x1f4)]=0x3c*0x3c*0x3e8,this[_0x29d531(0x24f)]=0x5,this[_0x29d531(0x268)]=new coinToPayService_1[(_0x29d531(0x234))]();}[a35_0x1f7993(0x266)](){const _0x5b6c49=a35_0x1f7993;console[_0x5b6c49(0x23b)]('ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)'),this[_0x5b6c49(0x20a)]()[_0x5b6c49(0x205)](_0x47dff4=>{const _0x5b40c9=_0x5b6c49;console[_0x5b40c9(0x248)](_0x5b40c9(0x272),_0x47dff4);}),this[_0x5b6c49(0x211)]=setInterval(async()=>{const _0x2c45dd=_0x5b6c49;try{await this[_0x2c45dd(0x20a)]();}catch(_0x52423a){console[_0x2c45dd(0x248)](_0x2c45dd(0x212),_0x52423a);}},this['CHECK_INTERVAL_MS']),console['log'](_0x5b6c49(0x201));}[a35_0x1f7993(0x27b)](){const _0x5d433=a35_0x1f7993;this[_0x5d433(0x211)]&&(clearInterval(this[_0x5d433(0x211)]),this[_0x5d433(0x211)]=null,console[_0x5d433(0x23b)](_0x5d433(0x24d)));}async['checkAllPendingPayments'](){const _0x414006=a35_0x1f7993;try{const _0x2c53fb=await database_1[_0x414006(0x21e)]['payment'][_0x414006(0x27a)]({'where':{'gateway':'cointopay','status':_0x414006(0x246),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x2c53fb[_0x414006(0x1f3)]===0x0){console['log'](_0x414006(0x24b));return;}console[_0x414006(0x23b)](_0x414006(0x25e)+_0x2c53fb[_0x414006(0x1f3)]+_0x414006(0x224));const _0x10ee52=await this[_0x414006(0x208)](_0x2c53fb);console[_0x414006(0x23b)](_0x414006(0x209)+_0x10ee52[_0x414006(0x1f3)]+'\x20expired\x20CoinToPay\x20payments');for(const _0x2551d5 of _0x2c53fb){try{if(_0x10ee52[_0x414006(0x271)](_0x2551d5['id'])){console[_0x414006(0x23b)](_0x414006(0x254)+_0x2551d5['id']+_0x414006(0x221));continue;}await this[_0x414006(0x260)](_0x2551d5),await new Promise(_0xd0789=>setTimeout(_0xd0789,0x7d0));}catch(_0x46c219){console['error']('Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x2551d5['id']+':',_0x46c219),loggerService_1['loggerService'][_0x414006(0x241)](_0x414006(0x269),_0x414006(0x21f)+_0x2551d5[_0x414006(0x223)],_0x46c219);}}console[_0x414006(0x23b)](_0x414006(0x233)+_0x2c53fb[_0x414006(0x1f3)]+_0x414006(0x264));}catch(_0x508cb4){console[_0x414006(0x248)](_0x414006(0x249),_0x508cb4);}}async[a35_0x1f7993(0x208)](_0x1ef10e){const _0xdb13b=a35_0x1f7993,_0x49f143=[],_0x340a7c=new Date();_0x340a7c[_0xdb13b(0x238)](_0x340a7c['getDate']()-this[_0xdb13b(0x24f)]),console[_0xdb13b(0x23b)](_0xdb13b(0x276)+this[_0xdb13b(0x24f)]+'\x20days\x20(created\x20before\x20'+_0x340a7c[_0xdb13b(0x1f1)]()+')');for(const _0x18127d of _0x1ef10e){if(_0x18127d[_0xdb13b(0x244)]<_0x340a7c){console[_0xdb13b(0x23b)]('â°\x20Payment\x20'+_0x18127d['id']+_0xdb13b(0x232)+this[_0xdb13b(0x24f)]+_0xdb13b(0x247));try{await database_1['default'][_0xdb13b(0x263)]['update']({'where':{'id':_0x18127d['id']},'data':{'status':_0xdb13b(0x26b),'updatedAt':new Date(),'adminNotes':_0xdb13b(0x222)+this[_0xdb13b(0x24f)]+_0xdb13b(0x20b)}}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x18127d['id'],'shopId':_0x18127d[_0xdb13b(0x250)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0xdb13b(0x20c)]({'reason':_0xdb13b(0x273)+this[_0xdb13b(0x24f)]+_0xdb13b(0x22f),'createdAt':_0x18127d['createdAt'],'expiredAt':new Date()[_0xdb13b(0x1f1)](),'daysSinceCreation':Math['floor']((Date[_0xdb13b(0x24c)]()-_0x18127d[_0xdb13b(0x244)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x18127d,_0xdb13b(0x26b)),await this[_0xdb13b(0x25d)](_0x18127d,_0xdb13b(0x26b)),_0x49f143[_0xdb13b(0x26f)](_0x18127d['id']),console[_0xdb13b(0x23b)](_0xdb13b(0x1f9)+_0x18127d['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0xdb13b(0x24f)]+_0xdb13b(0x1fd));}catch(_0x3ffc57){console[_0xdb13b(0x248)]('Failed\x20to\x20expire\x20payment\x20'+_0x18127d['id']+':',_0x3ffc57);}}}return _0x49f143;}async[a35_0x1f7993(0x260)](_0x1cc54b){const _0x296e24=a35_0x1f7993;if(!_0x1cc54b[_0x296e24(0x223)]){console['log']('âš ï¸\x20Payment\x20'+_0x1cc54b['id']+_0x296e24(0x239));return;}console[_0x296e24(0x23b)](_0x296e24(0x277)+_0x1cc54b['id']+'\x20('+_0x1cc54b[_0x296e24(0x223)]+')');try{const _0x4b90c9=await this[_0x296e24(0x268)][_0x296e24(0x219)](_0x1cc54b[_0x296e24(0x223)]);console[_0x296e24(0x23b)](_0x296e24(0x22b)+_0x1cc54b['id']+_0x296e24(0x1f8)+_0x4b90c9[_0x296e24(0x25c)]);_0x4b90c9[_0x296e24(0x25f)]&&console[_0x296e24(0x23b)](_0x296e24(0x22b)+_0x1cc54b['id']+'\x20details:',{'iban':_0x4b90c9[_0x296e24(0x25f)][_0x296e24(0x23a)]||_0x296e24(0x22c),'transactionId':_0x4b90c9['paymentDetails'][_0x296e24(0x242)],'createdOn':_0x4b90c9[_0x296e24(0x25f)][_0x296e24(0x203)],'confirmedOn':_0x4b90c9[_0x296e24(0x25f)][_0x296e24(0x1f5)]||_0x296e24(0x274)});if(_0x4b90c9[_0x296e24(0x25c)]!==_0x1cc54b[_0x296e24(0x25c)]){console['log']('ðŸ”„\x20Updating\x20payment\x20'+_0x1cc54b['id']+_0x296e24(0x255)+_0x1cc54b[_0x296e24(0x25c)]+_0x296e24(0x245)+_0x4b90c9['status']);const _0x1c25f2={'status':_0x4b90c9['status'],'updatedAt':new Date()};_0x4b90c9['status']===_0x296e24(0x267)&&_0x1cc54b[_0x296e24(0x25c)]!==_0x296e24(0x267)&&(_0x1c25f2[_0x296e24(0x27d)]=new Date(),console['log'](_0x296e24(0x226)+_0x1cc54b['id']+_0x296e24(0x1ff)+_0x1c25f2['paidAt'][_0x296e24(0x1f1)]()));if(_0x4b90c9['paymentDetails']){const _0x25fb82=_0x4b90c9[_0x296e24(0x25f)];_0x25fb82['iban']&&(_0x1c25f2[_0x296e24(0x228)]=_0x25fb82[_0x296e24(0x23a)],console[_0x296e24(0x23b)](_0x296e24(0x21b)+_0x25fb82[_0x296e24(0x23a)]));if(_0x25fb82[_0x296e24(0x26d)]){const _0x2cda9f=_0x1cc54b['adminNotes']||'',_0xceb376=_0x296e24(0x20d)+_0x25fb82[_0x296e24(0x26d)];_0x1c25f2[_0x296e24(0x229)]=_0x2cda9f?_0x2cda9f+'\x0a\x0a'+_0xceb376:_0xceb376,console['log'](_0x296e24(0x214));}_0x25fb82[_0x296e24(0x242)]&&console[_0x296e24(0x23b)](_0x296e24(0x204)+_0x25fb82[_0x296e24(0x242)]),_0x25fb82['confirmedOn']&&console[_0x296e24(0x23b)](_0x296e24(0x21a)+_0x25fb82['confirmedOn']);}await database_1[_0x296e24(0x21e)]['payment'][_0x296e24(0x20e)]({'where':{'id':_0x1cc54b['id']},'data':_0x1c25f2}),await database_1[_0x296e24(0x21e)][_0x296e24(0x23d)][_0x296e24(0x22a)]({'data':{'paymentId':_0x1cc54b['id'],'shopId':_0x1cc54b[_0x296e24(0x250)],'event':_0x296e24(0x220)+_0x4b90c9[_0x296e24(0x25c)][_0x296e24(0x1fe)](),'statusCode':0xc8,'responseBody':JSON[_0x296e24(0x20c)]({'oldStatus':_0x1cc54b['status'],'newStatus':_0x4b90c9['status'],'paymentDetails':_0x4b90c9['paymentDetails'],'checkedAt':new Date()['toISOString']()})}}),await this[_0x296e24(0x216)](_0x1cc54b,_0x4b90c9[_0x296e24(0x25c)]),await this[_0x296e24(0x25d)](_0x1cc54b,_0x4b90c9[_0x296e24(0x25c)]),console['log'](_0x296e24(0x1f9)+_0x1cc54b['id']+_0x296e24(0x1ef));}else console['log'](_0x296e24(0x22b)+_0x1cc54b['id']+'\x20status\x20unchanged\x20('+_0x4b90c9[_0x296e24(0x25c)]+')');}catch(_0x4144eb){console[_0x296e24(0x248)](_0x296e24(0x243)+_0x1cc54b['id']+':',_0x4144eb),await database_1[_0x296e24(0x21e)][_0x296e24(0x23d)][_0x296e24(0x22a)]({'data':{'paymentId':_0x1cc54b['id'],'shopId':_0x1cc54b[_0x296e24(0x250)],'event':_0x296e24(0x24a),'statusCode':0x1f4,'responseBody':JSON[_0x296e24(0x20c)]({'error':_0x4144eb instanceof Error?_0x4144eb[_0x296e24(0x26c)]:_0x296e24(0x207),'gatewayPaymentId':_0x1cc54b[_0x296e24(0x223)],'checkedAt':new Date()[_0x296e24(0x1f1)]()})}});}}async[a35_0x1f7993(0x216)](_0x20ae67,_0xacf405){const _0x48868c=a35_0x1f7993,_0x476225=Date['now']();try{const _0x5c2b12=_0x20ae67[_0x48868c(0x1f6)],_0x51dfef=_0x5c2b12[_0x48868c(0x22d)];if(!_0x51dfef?.[_0x48868c(0x27c)]){console[_0x48868c(0x23b)](_0x48868c(0x25a)+_0x5c2b12['id']);return;}const _0x25a06b=_0xacf405===_0x48868c(0x267)?_0x48868c(0x256):_0xacf405===_0x48868c(0x265)?'payment.failed':_0xacf405===_0x48868c(0x26b)?_0x48868c(0x253):'payment.pending';if(!_0x51dfef[_0x48868c(0x252)]?.[_0x48868c(0x271)](_0x25a06b)){console[_0x48868c(0x23b)]('Webhook\x20event\x20'+_0x25a06b+_0x48868c(0x21d)+_0x5c2b12['id']);return;}const _0xf319ac={'event':_0x25a06b,'payment':{'id':_0x20ae67['id'],'order_id':_0x20ae67[_0x48868c(0x261)],'gateway_order_id':_0x20ae67['gatewayOrderId'],'gateway':_0x48868c(0x235),'amount':_0x20ae67[_0x48868c(0x230)],'currency':_0x20ae67[_0x48868c(0x218)],'status':_0xacf405['toLowerCase'](),'customer_email':_0x20ae67[_0x48868c(0x23e)],'customer_name':_0x20ae67[_0x48868c(0x275)],'created_at':_0x20ae67[_0x48868c(0x244)],'updated_at':new Date()}},_0x95c573=await fetch(_0x51dfef['webhookUrl'],{'method':_0x48868c(0x23c),'headers':{'Content-Type':_0x48868c(0x1f7),'User-Agent':_0x48868c(0x213)},'body':JSON['stringify'](_0xf319ac)}),_0x31892d=Date['now']()-_0x476225,_0x446798=_0x95c573['ok']?_0x48868c(0x236):await _0x95c573['text']();loggerService_1[_0x48868c(0x24e)][_0x48868c(0x1fa)](_0x20ae67['shopId'],_0x51dfef[_0x48868c(0x27c)],_0x25a06b,_0x95c573['status'],_0x31892d,_0xf319ac),console[_0x48868c(0x23b)](_0x48868c(0x21c)+_0x51dfef['webhookUrl']+_0x48868c(0x270)+_0x95c573[_0x48868c(0x25c)]+'\x20('+_0x31892d+'ms)');}catch(_0x449f5d){console[_0x48868c(0x248)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x449f5d),loggerService_1[_0x48868c(0x24e)]['logShopWebhookError'](_0x20ae67[_0x48868c(0x250)],_0x20ae67['shop']?.[_0x48868c(0x22d)]?.['webhookUrl']||_0x48868c(0x206),_0x48868c(0x258),_0x449f5d,{});}}async[a35_0x1f7993(0x25d)](_0x3709c3,_0x2d0dcf){const _0x327246=a35_0x1f7993;try{const _0x49e825={'PENDING':_0x327246(0x225),'PAID':_0x327246(0x237),'FAILED':'failed','EXPIRED':'expired'},_0x56e33a=_0x49e825[_0x2d0dcf];if(!_0x56e33a||_0x56e33a===_0x327246(0x225))return;await telegramBotService_1[_0x327246(0x23f)][_0x327246(0x26e)](_0x3709c3['shopId'],_0x3709c3,_0x56e33a);}catch(_0xd3ef57){console[_0x327246(0x248)](_0x327246(0x279),_0xd3ef57);}}async[a35_0x1f7993(0x259)](_0x628918){const _0x56256d=a35_0x1f7993,_0x50a06e=await database_1['default'][_0x56256d(0x263)][_0x56256d(0x1fc)]({'where':{'id':_0x628918},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50a06e)throw new Error(_0x56256d(0x231));if(_0x50a06e['gateway']!==_0x56256d(0x269))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0x56256d(0x260)](_0x50a06e);}['getServiceStats'](){const _0x1dd943=a35_0x1f7993,_0x1a351a=this[_0x1dd943(0x211)]?this['CHECK_INTERVAL_MS']:undefined;return{'isActive':!!this[_0x1dd943(0x211)],'checkIntervalMinutes':this[_0x1dd943(0x1f4)]/(0x3e8*0x3c),'expiryDays':this[_0x1dd943(0x24f)],'nextCheckIn':_0x1a351a};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a35_0x1f7993(0x26a)]=new CoinToPayStatusService();