'use strict';function a35_0x8d01(){const _0x22be4e=['findMany','gatewayPaymentId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','CoinToPayStatusService','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','settings','Webhook\x20event\x20','EXPIRY_DAYS','iban','toLowerCase','\x20updated\x20successfully','orderId','telegramBotService','__importDefault','Unknown\x20error','\x20status:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Payment\x20not\x20found','webhookLog','createdAt','6988300VHQPjw','sendPaymentStatusNotification','\x20expired\x20CoinToPay\x20payments','checkInterval','./gateways/coinToPayService','push','7zcelMM','\x20with\x20status\x20','âœ…\x20Transaction\x20confirmed\x20on:\x20','\x20to\x20','gateway','defineProperty','ms)','\x20status\x20unchanged\x20(','-day\x20timeout','create','âš ï¸\x20Payment\x20','Payment\x20older\x20than\x20','checkPaymentStatus','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','4058103jckyka','Initial\x20CoinToPay\x20status\x20check\x20failed:','failed','\x20days\x20without\x20payment\x20confirmation','log','floor','cointopay','cointopay_auto_expired','catch','checkExpiredPayments','0100','\x20marked\x20as\x20paid\x20at:\x20','webhook_send','\x20details:','getTime','includes','ðŸ†”\x20Transaction\x20ID:\x20','expired','created','PAID','default','checkAllPendingPayments','text','Periodic\x20CoinToPay\x20status\x20check\x20failed:','ðŸ¦\x20Saved\x20IBAN:\x20','application/json','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','confirmedOn','remitterIban','paid','Success','\x20pending\x20CoinToPay\x20payments','\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check','getDate','error','logShopWebhookSent','customerEmail','âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)','toISOString','amount','bankDetails','checkSinglePayment','startPeriodicStatusCheck','âœ…\x20Payment\x20','2466290hkkwVN','stringify','TesSoft\x20Payment\x20System/1.0','Shop\x20webhook\x20sent\x20to\x20','gatewayOrderId','CoinToPayService','2160690syjvNc','paidAt','webhookEvents','ðŸ’°\x20Payment\x20','944940FXftNH','POST','status','2340830fSDQzu','findUnique','EXPIRED','cointopay_status_check_','length','CHECK_INTERVAL_MS','getServiceStats','\x20days\x20(created\x20before\x20','2730472NvoudW','update','__esModule','loggerService','logShopWebhookError','checkPaymentById','./telegramBotService','4ruUxfi','Failed\x20to\x20send\x20shop\x20webhook:','not\x20found','payment','now','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','18CcREjX','Automatically\x20expired\x20after\x20','shopId','\x20status\x20from\x20','ðŸ“Š\x20Payment\x20','â°\x20Payment\x20','\x20is\x20older\x20than\x20','transactionId','webhookUrl','coinToPayService','sendShopWebhook','shop','â°\x20Found\x20','/status/','\x20not\x20enabled\x20for\x20shop\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20CoinToPay\x20payments','cointopay_status_check_error','payment.pending','Failed\x20to\x20expire\x20payment\x20','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','paymentDetails'];a35_0x8d01=function(){return _0x22be4e;};return a35_0x8d01();}const a35_0x3a4b34=a35_0x13b8;(function(_0xd88545,_0x3a1aab){const _0x493415=a35_0x13b8,_0xa3936=_0xd88545();while(!![]){try{const _0x47e2d1=parseInt(_0x493415(0x12c))/0x1+-parseInt(_0x493415(0x122))/0x2+-parseInt(_0x493415(0xf6))/0x3*(-parseInt(_0x493415(0x13e))/0x4)+-parseInt(_0x493415(0x16f))/0x5+parseInt(_0x493415(0x128))/0x6+parseInt(_0x493415(0x175))/0x7*(parseInt(_0x493415(0x137))/0x8)+parseInt(_0x493415(0x144))/0x9*(parseInt(_0x493415(0x12f))/0xa);if(_0x47e2d1===_0x3a1aab)break;else _0xa3936['push'](_0xa3936['shift']());}catch(_0x1cdece){_0xa3936['push'](_0xa3936['shift']());}}}(a35_0x8d01,0xcc34a));function a35_0x13b8(_0x315a86,_0x3e9568){const _0x8d01e4=a35_0x8d01();return a35_0x13b8=function(_0x13b850,_0x1e517a){_0x13b850=_0x13b850-0xf6;let _0x44bfdc=_0x8d01e4[_0x13b850];return _0x44bfdc;},a35_0x13b8(_0x315a86,_0x3e9568);}var __importDefault=this&&this[a35_0x3a4b34(0x168)]||function(_0x55face){const _0x1267c1=a35_0x3a4b34;return _0x55face&&_0x55face[_0x1267c1(0x139)]?_0x55face:{'default':_0x55face};};Object[a35_0x3a4b34(0x17a)](exports,a35_0x3a4b34(0x139),{'value':!![]}),exports['coinToPayStatusService']=exports[a35_0x3a4b34(0x15e)]=void 0x0;const coinToPayService_1=require(a35_0x3a4b34(0x173)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a35_0x3a4b34(0x13d)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x5f2afe=a35_0x3a4b34;this['checkInterval']=null,this[_0x5f2afe(0x134)]=0x3c*0x3c*0x3e8,this[_0x5f2afe(0x162)]=0x5,this['coinToPayService']=new coinToPayService_1[(_0x5f2afe(0x127))]();}[a35_0x3a4b34(0x120)](){const _0x4930a7=a35_0x3a4b34;console[_0x4930a7(0xfa)](_0x4930a7(0x15f)),this['checkAllPendingPayments']()[_0x4930a7(0xfe)](_0x43db64=>{const _0x160958=_0x4930a7;console[_0x160958(0x118)](_0x160958(0xf7),_0x43db64);}),this['checkInterval']=setInterval(async()=>{const _0x39b9bc=_0x4930a7;try{await this[_0x39b9bc(0x10b)]();}catch(_0x2a20d0){console['error'](_0x39b9bc(0x10d),_0x2a20d0);}},this[_0x4930a7(0x134)]),console[_0x4930a7(0xfa)](_0x4930a7(0x11b));}['stopPeriodicStatusCheck'](){const _0x388132=a35_0x3a4b34;this[_0x388132(0x172)]&&(clearInterval(this[_0x388132(0x172)]),this[_0x388132(0x172)]=null,console['log']('ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped'));}async[a35_0x3a4b34(0x10b)](){const _0x5896e5=a35_0x3a4b34;try{const _0x3cf247=await database_1[_0x5896e5(0x10a)]['payment'][_0x5896e5(0x15b)]({'where':{'gateway':_0x5896e5(0xfc),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x3cf247[_0x5896e5(0x133)]===0x0){console[_0x5896e5(0xfa)](_0x5896e5(0x154));return;}console[_0x5896e5(0xfa)]('ðŸª™\x20Checking\x20'+_0x3cf247['length']+_0x5896e5(0x115));const _0x3a1d52=await this[_0x5896e5(0xff)](_0x3cf247);console['log'](_0x5896e5(0x150)+_0x3a1d52['length']+_0x5896e5(0x171));for(const _0x3ce545 of _0x3cf247){try{if(_0x3a1d52[_0x5896e5(0x105)](_0x3ce545['id'])){console[_0x5896e5(0xfa)](_0x5896e5(0x149)+_0x3ce545['id']+_0x5896e5(0x116));continue;}await this[_0x5896e5(0x11f)](_0x3ce545),await new Promise(_0xb7e0af=>setTimeout(_0xb7e0af,0x7d0));}catch(_0x4c053c){console[_0x5896e5(0x118)]('Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x3ce545['id']+':',_0x4c053c),loggerService_1[_0x5896e5(0x13a)]['logWhiteDomainError'](_0x5896e5(0xfc),_0x5896e5(0x151)+_0x3ce545[_0x5896e5(0x15c)],_0x4c053c);}}console['log']('âœ…\x20Completed\x20checking\x20'+_0x3cf247[_0x5896e5(0x133)]+_0x5896e5(0x155));}catch(_0x3dc73d){console[_0x5896e5(0x118)](_0x5896e5(0x182),_0x3dc73d);}}async[a35_0x3a4b34(0xff)](_0x580ab4){const _0x1c3dd5=a35_0x3a4b34,_0x1360b8=[],_0x1147d3=new Date();_0x1147d3['setDate'](_0x1147d3[_0x1c3dd5(0x117)]()-this[_0x1c3dd5(0x162)]),console[_0x1c3dd5(0xfa)](_0x1c3dd5(0x159)+this[_0x1c3dd5(0x162)]+_0x1c3dd5(0x136)+_0x1147d3[_0x1c3dd5(0x11c)]()+')');for(const _0x126d20 of _0x580ab4){if(_0x126d20[_0x1c3dd5(0x16e)]<_0x1147d3){console[_0x1c3dd5(0xfa)](_0x1c3dd5(0x149)+_0x126d20['id']+_0x1c3dd5(0x14a)+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{await database_1[_0x1c3dd5(0x10a)][_0x1c3dd5(0x141)]['update']({'where':{'id':_0x126d20['id']},'data':{'status':_0x1c3dd5(0x131),'updatedAt':new Date(),'adminNotes':_0x1c3dd5(0x145)+this[_0x1c3dd5(0x162)]+_0x1c3dd5(0xf9)}}),await database_1[_0x1c3dd5(0x10a)]['webhookLog'][_0x1c3dd5(0x17e)]({'data':{'paymentId':_0x126d20['id'],'shopId':_0x126d20[_0x1c3dd5(0x146)],'event':_0x1c3dd5(0xfd),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x1c3dd5(0x180)+this[_0x1c3dd5(0x162)]+'\x20days','createdAt':_0x126d20['createdAt'],'expiredAt':new Date()[_0x1c3dd5(0x11c)](),'daysSinceCreation':Math[_0x1c3dd5(0xfb)]((Date[_0x1c3dd5(0x142)]()-_0x126d20[_0x1c3dd5(0x16e)][_0x1c3dd5(0x104)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1c3dd5(0x14e)](_0x126d20,_0x1c3dd5(0x131)),await this[_0x1c3dd5(0x170)](_0x126d20,'EXPIRED'),_0x1360b8[_0x1c3dd5(0x174)](_0x126d20['id']),console[_0x1c3dd5(0xfa)](_0x1c3dd5(0x121)+_0x126d20['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x1c3dd5(0x162)]+_0x1c3dd5(0x17d));}catch(_0x6833ba){console[_0x1c3dd5(0x118)](_0x1c3dd5(0x158)+_0x126d20['id']+':',_0x6833ba);}}}return _0x1360b8;}async[a35_0x3a4b34(0x11f)](_0x1f25de){const _0x45f0af=a35_0x3a4b34;if(!_0x1f25de[_0x45f0af(0x15c)]){console[_0x45f0af(0xfa)](_0x45f0af(0x17f)+_0x1f25de['id']+_0x45f0af(0x15d));return;}console[_0x45f0af(0xfa)](_0x45f0af(0x143)+_0x1f25de['id']+'\x20('+_0x1f25de[_0x45f0af(0x15c)]+')');try{const _0x241cc6=await this[_0x45f0af(0x14d)][_0x45f0af(0x181)](_0x1f25de[_0x45f0af(0x15c)]);console[_0x45f0af(0xfa)]('ðŸ“Š\x20Payment\x20'+_0x1f25de['id']+_0x45f0af(0x16a)+_0x241cc6['status']);_0x241cc6[_0x45f0af(0x15a)]&&console[_0x45f0af(0xfa)](_0x45f0af(0x148)+_0x1f25de['id']+_0x45f0af(0x103),{'iban':_0x241cc6['paymentDetails']['iban']||_0x45f0af(0x140),'transactionId':_0x241cc6[_0x45f0af(0x15a)][_0x45f0af(0x14b)],'createdOn':_0x241cc6[_0x45f0af(0x15a)]['createdOn'],'confirmedOn':_0x241cc6[_0x45f0af(0x15a)][_0x45f0af(0x111)]||'not\x20confirmed'});if(_0x241cc6[_0x45f0af(0x12e)]!==_0x1f25de[_0x45f0af(0x12e)]){console[_0x45f0af(0xfa)]('ðŸ”„\x20Updating\x20payment\x20'+_0x1f25de['id']+_0x45f0af(0x147)+_0x1f25de[_0x45f0af(0x12e)]+_0x45f0af(0x178)+_0x241cc6[_0x45f0af(0x12e)]);const _0x4ec5bc={'status':_0x241cc6['status'],'updatedAt':new Date()};_0x241cc6[_0x45f0af(0x12e)]===_0x45f0af(0x109)&&_0x1f25de[_0x45f0af(0x12e)]!=='PAID'&&(_0x4ec5bc['paidAt']=new Date(),console['log'](_0x45f0af(0x12b)+_0x1f25de['id']+_0x45f0af(0x101)+_0x4ec5bc[_0x45f0af(0x129)]['toISOString']()));if(_0x241cc6[_0x45f0af(0x15a)]){const _0x1d94e0=_0x241cc6[_0x45f0af(0x15a)];_0x1d94e0[_0x45f0af(0x163)]&&(_0x4ec5bc[_0x45f0af(0x112)]=_0x1d94e0[_0x45f0af(0x163)],console[_0x45f0af(0xfa)](_0x45f0af(0x10e)+_0x1d94e0[_0x45f0af(0x163)]));if(_0x1d94e0[_0x45f0af(0x11e)]){const _0x783304=_0x1f25de['adminNotes']||'',_0x26d434='Bank\x20Details:\x20'+_0x1d94e0[_0x45f0af(0x11e)];_0x4ec5bc['adminNotes']=_0x783304?_0x783304+'\x0a\x0a'+_0x26d434:_0x26d434,console[_0x45f0af(0xfa)]('ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x1d94e0['transactionId']&&console[_0x45f0af(0xfa)](_0x45f0af(0x106)+_0x1d94e0[_0x45f0af(0x14b)]),_0x1d94e0[_0x45f0af(0x111)]&&console[_0x45f0af(0xfa)](_0x45f0af(0x177)+_0x1d94e0[_0x45f0af(0x111)]);}await database_1['default'][_0x45f0af(0x141)][_0x45f0af(0x138)]({'where':{'id':_0x1f25de['id']},'data':_0x4ec5bc}),await database_1['default'][_0x45f0af(0x16d)][_0x45f0af(0x17e)]({'data':{'paymentId':_0x1f25de['id'],'shopId':_0x1f25de[_0x45f0af(0x146)],'event':_0x45f0af(0x132)+_0x241cc6[_0x45f0af(0x12e)][_0x45f0af(0x164)](),'statusCode':0xc8,'responseBody':JSON[_0x45f0af(0x123)]({'oldStatus':_0x1f25de[_0x45f0af(0x12e)],'newStatus':_0x241cc6[_0x45f0af(0x12e)],'paymentDetails':_0x241cc6[_0x45f0af(0x15a)],'checkedAt':new Date()[_0x45f0af(0x11c)]()})}}),await this[_0x45f0af(0x14e)](_0x1f25de,_0x241cc6[_0x45f0af(0x12e)]),await this[_0x45f0af(0x170)](_0x1f25de,_0x241cc6[_0x45f0af(0x12e)]),console[_0x45f0af(0xfa)](_0x45f0af(0x121)+_0x1f25de['id']+_0x45f0af(0x165));}else console[_0x45f0af(0xfa)](_0x45f0af(0x148)+_0x1f25de['id']+_0x45f0af(0x17c)+_0x241cc6[_0x45f0af(0x12e)]+')');}catch(_0x3cc210){console[_0x45f0af(0x118)]('Failed\x20to\x20check\x20payment\x20'+_0x1f25de['id']+':',_0x3cc210),await database_1[_0x45f0af(0x10a)][_0x45f0af(0x16d)][_0x45f0af(0x17e)]({'data':{'paymentId':_0x1f25de['id'],'shopId':_0x1f25de[_0x45f0af(0x146)],'event':_0x45f0af(0x156),'statusCode':0x1f4,'responseBody':JSON[_0x45f0af(0x123)]({'error':_0x3cc210 instanceof Error?_0x3cc210['message']:_0x45f0af(0x169),'gatewayPaymentId':_0x1f25de[_0x45f0af(0x15c)],'checkedAt':new Date()[_0x45f0af(0x11c)]()})}});}}async[a35_0x3a4b34(0x14e)](_0x262adb,_0x4fd52b){const _0x421711=a35_0x3a4b34,_0x4e6e62=Date[_0x421711(0x142)]();try{const _0x108231=_0x262adb[_0x421711(0x14f)],_0x394d4a=_0x108231[_0x421711(0x160)];if(!_0x394d4a?.[_0x421711(0x14c)]){console['log'](_0x421711(0x153)+_0x108231['id']);return;}const _0x599976=_0x4fd52b===_0x421711(0x109)?'payment.success':_0x4fd52b==='FAILED'?'payment.failed':_0x4fd52b==='EXPIRED'?'payment.failed':_0x421711(0x157);if(!_0x394d4a[_0x421711(0x12a)]?.[_0x421711(0x105)](_0x599976)){console[_0x421711(0xfa)](_0x421711(0x161)+_0x599976+_0x421711(0x152)+_0x108231['id']);return;}const _0x4fe16b={'event':_0x599976,'payment':{'id':_0x262adb['id'],'order_id':_0x262adb[_0x421711(0x166)],'gateway_order_id':_0x262adb[_0x421711(0x126)],'gateway':_0x421711(0x100),'amount':_0x262adb[_0x421711(0x11d)],'currency':_0x262adb['currency'],'status':_0x4fd52b[_0x421711(0x164)](),'customer_email':_0x262adb[_0x421711(0x11a)],'customer_name':_0x262adb['customerName'],'created_at':_0x262adb[_0x421711(0x16e)],'updated_at':new Date()}},_0x474e7f=await fetch(_0x394d4a[_0x421711(0x14c)],{'method':_0x421711(0x12d),'headers':{'Content-Type':_0x421711(0x10f),'User-Agent':_0x421711(0x124)},'body':JSON[_0x421711(0x123)](_0x4fe16b)}),_0x53bc0a=Date['now']()-_0x4e6e62,_0x3ddfb2=_0x474e7f['ok']?_0x421711(0x114):await _0x474e7f[_0x421711(0x10c)]();loggerService_1[_0x421711(0x13a)][_0x421711(0x119)](_0x262adb[_0x421711(0x146)],_0x394d4a[_0x421711(0x14c)],_0x599976,_0x474e7f['status'],_0x53bc0a,_0x4fe16b),console['log'](_0x421711(0x125)+_0x394d4a[_0x421711(0x14c)]+_0x421711(0x176)+_0x474e7f[_0x421711(0x12e)]+'\x20('+_0x53bc0a+_0x421711(0x17b));}catch(_0x20f9d1){console[_0x421711(0x118)](_0x421711(0x13f),_0x20f9d1),loggerService_1['loggerService'][_0x421711(0x13b)](_0x262adb[_0x421711(0x146)],_0x262adb[_0x421711(0x14f)]?.['settings']?.[_0x421711(0x14c)]||'unknown',_0x421711(0x102),_0x20f9d1,{});}}async[a35_0x3a4b34(0x170)](_0x26301d,_0x6bc8bd){const _0x13d207=a35_0x3a4b34;try{const _0x40b729={'PENDING':_0x13d207(0x108),'PAID':_0x13d207(0x113),'FAILED':_0x13d207(0xf8),'EXPIRED':_0x13d207(0x107)},_0x3860d1=_0x40b729[_0x6bc8bd];if(!_0x3860d1||_0x3860d1==='created')return;await telegramBotService_1[_0x13d207(0x167)]['sendPaymentNotification'](_0x26301d[_0x13d207(0x146)],_0x26301d,_0x3860d1);}catch(_0x27f223){console[_0x13d207(0x118)](_0x13d207(0x110),_0x27f223);}}async[a35_0x3a4b34(0x13c)](_0x42e8b2){const _0x5840d6=a35_0x3a4b34,_0xcd41f3=await database_1[_0x5840d6(0x10a)][_0x5840d6(0x141)][_0x5840d6(0x130)]({'where':{'id':_0x42e8b2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xcd41f3)throw new Error(_0x5840d6(0x16c));if(_0xcd41f3[_0x5840d6(0x179)]!==_0x5840d6(0xfc))throw new Error(_0x5840d6(0x16b));await this[_0x5840d6(0x11f)](_0xcd41f3);}[a35_0x3a4b34(0x135)](){const _0x2cf69e=a35_0x3a4b34,_0x949867=this['checkInterval']?this[_0x2cf69e(0x134)]:undefined;return{'isActive':!!this[_0x2cf69e(0x172)],'checkIntervalMinutes':this[_0x2cf69e(0x134)]/(0x3e8*0x3c),'expiryDays':this[_0x2cf69e(0x162)],'nextCheckIn':_0x949867};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();