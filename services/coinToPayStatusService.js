'use strict';const a37_0x5bd8a6=a37_0x4613;function a37_0x4613(_0x5055ae,_0x237ffe){const _0x4e4690=a37_0x4e46();return a37_0x4613=function(_0x4613ef,_0x445246){_0x4613ef=_0x4613ef-0x1b5;let _0x34c608=_0x4e4690[_0x4613ef];return _0x34c608;},a37_0x4613(_0x5055ae,_0x237ffe);}(function(_0x2dd22c,_0x5cc646){const _0x4be5a5=a37_0x4613,_0x4c809a=_0x2dd22c();while(!![]){try{const _0x55b3d2=-parseInt(_0x4be5a5(0x285))/0x1+-parseInt(_0x4be5a5(0x1fe))/0x2+parseInt(_0x4be5a5(0x1d5))/0x3*(-parseInt(_0x4be5a5(0x1cd))/0x4)+parseInt(_0x4be5a5(0x1b8))/0x5*(-parseInt(_0x4be5a5(0x1f3))/0x6)+parseInt(_0x4be5a5(0x243))/0x7+-parseInt(_0x4be5a5(0x1c5))/0x8*(parseInt(_0x4be5a5(0x1e4))/0x9)+-parseInt(_0x4be5a5(0x1c1))/0xa*(-parseInt(_0x4be5a5(0x290))/0xb);if(_0x55b3d2===_0x5cc646)break;else _0x4c809a['push'](_0x4c809a['shift']());}catch(_0x11886a){_0x4c809a['push'](_0x4c809a['shift']());}}}(a37_0x4e46,0xb50be));var __importDefault=this&&this[a37_0x5bd8a6(0x274)]||function(_0x3158a4){const _0x2d03b9=a37_0x5bd8a6;return _0x3158a4&&_0x3158a4[_0x2d03b9(0x1c3)]?_0x3158a4:{'default':_0x3158a4};};Object[a37_0x5bd8a6(0x228)](exports,a37_0x5bd8a6(0x1c3),{'value':!![]}),exports[a37_0x5bd8a6(0x1da)]=exports[a37_0x5bd8a6(0x1d1)]=void 0x0;const coinToPayService_1=require(a37_0x5bd8a6(0x280)),database_1=__importDefault(require(a37_0x5bd8a6(0x234))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require(a37_0x5bd8a6(0x28d));function a37_0x4e46(){const _0x54fa24=['-day\x20timeout','🪙\x20[GLOBAL]\x20Found\x20','576836dAgUiD','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','webhook_send','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20in\x20','currency','./loggerService','toISOString','Success','44173063YnQzcv','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','clearPaymentTimers','checkPaymentStatus','\x20\x20\x20-\x20Amount:\x20','\x20days\x20(created\x20before\x20','40eOFxNA','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20status\x20unchanged\x20(','\x20\x20\x20-\x20Gateway:\x20','customerName','message','default','10XKoSeF','📊\x20[CHECK]\x20Payment\x20','__esModule','orderId','32UyoNkQ','push','createdOn','findUnique','loggerService','payment.pending','cointopay_status_check_error','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','4414268SCXzRs','CoinToPayService','getDate','forEach','CoinToPayStatusService','gatewayPaymentId','\x20\x20\x20📍\x20Source:\x20','\x20is\x20too\x20new\x20(','3JrtRZs','application/json','🪙\x20CoinToPayStatusService\x20initialized','🔄\x20[CHECK]\x20Updating\x20payment\x20','get','coinToPayStatusService','createdAt','cointopay','shopId','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','⏰\x20[GLOBAL]\x20Payment\x20','payment','has','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','2689110erXJwj','length','0100','checkAllPendingPayments','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','COINTOPAY_STATUS_CHANGE','\x20\x20\x20-\x20gatewayPaymentId:\x20','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','bankDetails','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','cointopay_auto_expired','✅\x20[HOURLY]\x20Payment\x20','\x20\x20\x20-\x20Status:\x20','iban','Shop\x20webhook\x20sent\x20to\x20','6822EGSuJi','log','GLOBAL_CHECK_INTERVAL_MS','COINTOPAY_ERROR','paidAt','TesSoft\x20Payment\x20System/1.0','\x20timers\x20for\x20payment\x20','\x20skipped,\x20','coinToPayService','not\x20found','webhookUrl','2876864ZrLjGl','error','includes','\x20status\x20is\x20','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','now','transactionId','timers','schedulePaymentChecks','catch','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','PENDING','text','not\x20confirmed','toLowerCase','\x20\x20\x20📊\x20Status:\x20','5\x20minutes','webhookLog','created','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','create','stopPeriodicStatusCheck','delay','PAID','checkPaymentById','paymentId','logCoinToPayError','getTime','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20expired\x20CoinToPay\x20payments','ms)','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','size','\x20days','logShopWebhookSent','sendShopWebhook','\x20\x20\x20📅\x20Time:\x20','settings','\x20for\x20payment\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','defineProperty','⚠️\x20[CHECK]\x20Payment\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20expired','logShopWebhookError','Payment\x20not\x20found','timestamp','\x20seconds\x20(','2\x20minutes','🧹\x20[DEBUG]\x20Clearing\x20','floor','findMany','../config/database','payment.failed','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20completed\x20for\x20payment\x20','Payment\x20older\x20than\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','gateway','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','delete','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','confirmedOn','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','shop','map','7342468wSkhSH','telegramBotService','auto_expire','customerEmail','\x20\x20\x20📝\x20Context:','amount','getServiceStats','✅\x20[CHECK]\x20Payment\x20','stringify','unknown','Automatically\x20expired\x20after\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','status','paid','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','\x20current\x20status:\x20','setDate','update','EXPIRY_DAYS','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','logCoinToPayStatus','\x20updated\x20successfully','\x20\x20\x20❌\x20Error:\x20','\x20triggered\x20for\x20payment\x20','\x20is\x20older\x20than\x20','globalCheckInterval','checkSinglePaymentById','description','Webhook\x20event\x20','sendPaymentStatusNotification','🪙\x20[TIMER]\x20Individual\x20check\x20#','sendPaymentNotification','⏰\x20[GLOBAL]\x20Found\x20','\x20pending\x20CoinToPay\x20payments','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','\x20status\x20changed\x20to\x20','\x20not\x20found,\x20clearing\x20timers','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20to\x20','paymentTimers','values','EXPIRED','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20status\x20from\x20','status_check','schedule_created','h),\x20skipping\x20global\x20check','adminNotes','__importDefault','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','toFixed',',\x20stopping\x20individual\x20checks','checkSinglePayment','\x20\x20\x20-\x20ShopId:\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Failed\x20to\x20mark\x20payment\x20as\x20expired','gatewayOrderId','\x20individual\x20payment\x20timers','startPeriodicStatusCheck','❌\x20[CHECK]\x20Payment\x20','./gateways/coinToPayService','paymentDetails','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'];a37_0x4e46=function(){return _0x54fa24;};return a37_0x4e46();}class CoinToPayStatusService{constructor(){const _0x53d538=a37_0x5bd8a6;this[_0x53d538(0x25d)]=null,this[_0x53d538(0x1f5)]=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this[_0x53d538(0x1fb)]=new coinToPayService_1[(_0x53d538(0x1ce))](),console['log'](_0x53d538(0x1d7));}[a37_0x5bd8a6(0x208)](_0x4afe07,_0x319261){const _0x2bb476=a37_0x5bd8a6;console['log'](_0x2bb476(0x213)),console[_0x2bb476(0x1f4)]('\x20\x20\x20-\x20paymentId:\x20'+_0x4afe07),console[_0x2bb476(0x1f4)](_0x2bb476(0x1ea)+_0x319261),this[_0x2bb476(0x292)](_0x4afe07);const _0x40aaf9=[],_0xa313ff=new Date(),_0x2fb13a=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x2bb476(0x230)},{'delay':0x5*0x3c*0x3e8,'description':_0x2bb476(0x210)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x2bb476(0x1f4)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x2fb13a[_0x2bb476(0x1e5)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x4afe07);let _0x44bf6a=0x0;_0x2fb13a[_0x2bb476(0x1d0)]((_0x1fbf65,_0x477000)=>{const _0x51001c=_0x2bb476;_0x44bf6a+=_0x1fbf65[_0x51001c(0x216)];const _0x332bf5=setTimeout(async()=>{const _0x5dc088=_0x51001c;console[_0x5dc088(0x1f4)](_0x5dc088(0x262)+(_0x477000+0x1)+_0x5dc088(0x25b)+_0x4afe07+'\x20(after\x20'+_0x1fbf65[_0x5dc088(0x25f)]+')');try{await this[_0x5dc088(0x25e)](_0x4afe07),console[_0x5dc088(0x1f4)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x477000+0x1)+_0x5dc088(0x237)+_0x4afe07);}catch(_0x823cc1){console['error'](_0x5dc088(0x286)+(_0x477000+0x1)+'\x20for\x20payment\x20'+_0x4afe07+':',_0x823cc1),this[_0x5dc088(0x21a)](_0x4afe07,_0x319261,_0x823cc1,_0x5dc088(0x270),{'checkNumber':_0x477000+0x1,'scheduledAfter':_0x1fbf65[_0x5dc088(0x25f)],'isIndividualCheck':!![]});}},_0x44bf6a);_0x40aaf9['push'](_0x332bf5),console[_0x51001c(0x1f4)]('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x477000+0x1)+'\x20for\x20payment\x20'+_0x4afe07+_0x51001c(0x28b)+_0x44bf6a/0x3e8+_0x51001c(0x22f)+_0x1fbf65['description']+')');});const _0x661bd7=setInterval(async()=>{const _0xfd6348=_0x2bb476;console['log']('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x4afe07);try{const _0x22b3ef=await database_1[_0xfd6348(0x1c0)]['payment']['findUnique']({'where':{'id':_0x4afe07},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x22b3ef){console['log']('❌\x20[HOURLY]\x20Payment\x20'+_0x4afe07+_0xfd6348(0x268)),this[_0xfd6348(0x292)](_0x4afe07);return;}console[_0xfd6348(0x1f4)]('📊\x20[HOURLY]\x20Payment\x20'+_0x4afe07+_0xfd6348(0x252)+_0x22b3ef[_0xfd6348(0x24f)]);if(_0x22b3ef[_0xfd6348(0x24f)]!==_0xfd6348(0x20b)){console['log'](_0xfd6348(0x1ef)+_0x4afe07+'\x20status\x20is\x20'+_0x22b3ef[_0xfd6348(0x24f)]+_0xfd6348(0x277)),this['clearPaymentTimers'](_0x4afe07);return;}const _0x3b2dde=Math['floor']((Date['now']()-_0x22b3ef[_0xfd6348(0x1db)][_0xfd6348(0x21b)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x3b2dde>=this['EXPIRY_DAYS']){console[_0xfd6348(0x1f4)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x4afe07+_0xfd6348(0x25c)+this[_0xfd6348(0x255)]+_0xfd6348(0x20a)),this[_0xfd6348(0x292)](_0x4afe07);return;}await this[_0xfd6348(0x25e)](_0x4afe07),console[_0xfd6348(0x1f4)](_0xfd6348(0x236)+_0x4afe07);}catch(_0x3b8388){console['error'](_0xfd6348(0x21f)+_0x4afe07+':',_0x3b8388),this['logCoinToPayError'](_0x4afe07,_0x319261,_0x3b8388,_0xfd6348(0x270),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x40aaf9[_0x2bb476(0x1c6)](_0x661bd7),this[_0x2bb476(0x26b)]['set'](_0x4afe07,{'timers':_0x40aaf9,'paymentId':_0x4afe07,'gatewayPaymentId':_0x319261,'createdAt':_0xa313ff}),console['log'](_0x2bb476(0x1ed)+_0x2fb13a[_0x2bb476(0x1e5)]+_0x2bb476(0x1e3)+_0x4afe07),console[_0x2bb476(0x1f4)](_0x2bb476(0x1ba)+this[_0x2bb476(0x26b)][_0x2bb476(0x220)]),this['logCoinToPayStatus'](_0x4afe07,_0x319261,'PENDING','PENDING',_0x2bb476(0x270),{'action':_0x2bb476(0x271),'scheduledChecks':_0x2fb13a['length'],'firstCheckIn':_0x2fb13a[0x0]['delay']/0x3e8,'totalTimers':this[_0x2bb476(0x26b)]['size']});}['clearPaymentTimers'](_0xace477){const _0x51a126=a37_0x5bd8a6,_0x526d1f=this[_0x51a126(0x26b)]['get'](_0xace477);_0x526d1f?(console['log'](_0x51a126(0x231)+_0x526d1f[_0x51a126(0x207)][_0x51a126(0x1e5)]+_0x51a126(0x1f9)+_0xace477),_0x526d1f[_0x51a126(0x207)]['forEach']((_0x34513f,_0x140ada)=>{const _0x1c3498=_0x51a126;_0x34513f&&(clearTimeout(_0x34513f),clearInterval(_0x34513f),console['log'](_0x1c3498(0x1bb)+(_0x140ada+0x1)+_0x1c3498(0x226)+_0xace477));}),this[_0x51a126(0x26b)][_0x51a126(0x23c)](_0xace477),console[_0x51a126(0x1f4)](_0x51a126(0x21c)+_0xace477+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x51a126(0x26b)][_0x51a126(0x220)])):console[_0x51a126(0x1f4)](_0x51a126(0x1b9)+_0xace477+'\x20to\x20clear');}async[a37_0x5bd8a6(0x25e)](_0x348bfb){const _0x22b8a9=a37_0x5bd8a6;console[_0x22b8a9(0x1f4)](_0x22b8a9(0x282)+_0x348bfb);const _0x4744ee=await database_1[_0x22b8a9(0x1c0)][_0x22b8a9(0x1e0)]['findUnique']({'where':{'id':_0x348bfb},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4744ee){console[_0x22b8a9(0x1f4)](_0x22b8a9(0x27f)+_0x348bfb+'\x20not\x20found\x20in\x20database');return;}console[_0x22b8a9(0x1f4)](_0x22b8a9(0x1c2)+_0x348bfb+'\x20found:'),console['log'](_0x22b8a9(0x1bd)+_0x4744ee[_0x22b8a9(0x23a)]),console[_0x22b8a9(0x1f4)](_0x22b8a9(0x1f0)+_0x4744ee[_0x22b8a9(0x24f)]),console[_0x22b8a9(0x1f4)](_0x22b8a9(0x28a)+_0x4744ee['gatewayPaymentId']),console[_0x22b8a9(0x1f4)](_0x22b8a9(0x1b6)+_0x4744ee['amount']+'\x20'+_0x4744ee['currency']),console['log'](_0x22b8a9(0x279)+_0x4744ee[_0x22b8a9(0x1dd)]);if(_0x4744ee[_0x22b8a9(0x23a)]!=='cointopay'){console[_0x22b8a9(0x1f4)](_0x22b8a9(0x229)+_0x348bfb+_0x22b8a9(0x1e2)+_0x4744ee[_0x22b8a9(0x23a)]+')');return;}if(_0x4744ee[_0x22b8a9(0x24f)]!==_0x22b8a9(0x20b)){console[_0x22b8a9(0x1f4)](_0x22b8a9(0x229)+_0x348bfb+_0x22b8a9(0x201)+_0x4744ee[_0x22b8a9(0x24f)]+_0x22b8a9(0x277)),this[_0x22b8a9(0x292)](_0x348bfb);return;}if(!_0x4744ee[_0x22b8a9(0x1d2)]){console[_0x22b8a9(0x1f4)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x348bfb+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x22b8a9(0x1f4)](_0x22b8a9(0x24a)+_0x348bfb+_0x22b8a9(0x256)),await this[_0x22b8a9(0x278)](_0x4744ee);}[a37_0x5bd8a6(0x258)](_0x493451,_0x26fc90,_0x189957,_0x4faa2a,_0x4eff34,_0x15a14b){const _0x244f97=a37_0x5bd8a6,_0x1fb4c8={'type':_0x244f97(0x1e9),'paymentId':_0x493451,'gatewayPaymentId':_0x26fc90,'oldStatus':_0x189957,'newStatus':_0x4faa2a,'source':_0x4eff34,'timestamp':new Date()[_0x244f97(0x28e)](),'details':_0x15a14b||{}};loggerService_1[_0x244f97(0x1c9)][_0x244f97(0x258)](_0x1fb4c8),console[_0x244f97(0x1f4)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x493451+'\x20('+_0x26fc90+')'),console['log'](_0x244f97(0x20f)+_0x189957+'\x20->\x20'+_0x4faa2a),console[_0x244f97(0x1f4)](_0x244f97(0x1d3)+_0x4eff34),console[_0x244f97(0x1f4)]('\x20\x20\x20📅\x20Time:\x20'+_0x1fb4c8[_0x244f97(0x22e)]),_0x15a14b&&console['log']('\x20\x20\x20📝\x20Details:',_0x15a14b);}[a37_0x5bd8a6(0x21a)](_0x6432dd,_0x6f1388,_0x3f55fb,_0x5016f8,_0x415aa3){const _0x804444=a37_0x5bd8a6,_0x45fe3d={'type':_0x804444(0x1f6),'paymentId':_0x6432dd,'gatewayPaymentId':_0x6f1388,'error':_0x3f55fb instanceof Error?{'message':_0x3f55fb[_0x804444(0x1bf)],'stack':_0x3f55fb['stack']}:_0x3f55fb,'source':_0x5016f8,'timestamp':new Date()['toISOString'](),'context':_0x415aa3||{}};loggerService_1[_0x804444(0x1c9)][_0x804444(0x21a)](_0x45fe3d),console[_0x804444(0x1ff)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x6432dd+'\x20('+_0x6f1388+')'),console[_0x804444(0x1ff)](_0x804444(0x25a)+(_0x3f55fb instanceof Error?_0x3f55fb['message']:_0x3f55fb)),console[_0x804444(0x1ff)](_0x804444(0x1d3)+_0x5016f8),console[_0x804444(0x1ff)](_0x804444(0x224)+_0x45fe3d[_0x804444(0x22e)]),_0x415aa3&&console[_0x804444(0x1ff)](_0x804444(0x247),_0x415aa3);}[a37_0x5bd8a6(0x27e)](){const _0x577d73=a37_0x5bd8a6;console[_0x577d73(0x1f4)](_0x577d73(0x239)),this[_0x577d73(0x1e7)]()[_0x577d73(0x209)](_0x3f0b5b=>{const _0x473801=_0x577d73;console[_0x473801(0x1ff)](_0x473801(0x291),_0x3f0b5b);}),this[_0x577d73(0x25d)]=setInterval(async()=>{const _0x4ae3e4=_0x577d73;try{console[_0x4ae3e4(0x1f4)](_0x4ae3e4(0x257)),await this[_0x4ae3e4(0x1e7)](),console[_0x4ae3e4(0x1f4)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x6788fa){console[_0x4ae3e4(0x1ff)](_0x4ae3e4(0x287),_0x6788fa);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log']('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x5bd8a6(0x215)](){const _0x14ca47=a37_0x5bd8a6;console[_0x14ca47(0x1f4)](_0x14ca47(0x1eb));this[_0x14ca47(0x25d)]&&(clearInterval(this[_0x14ca47(0x25d)]),this[_0x14ca47(0x25d)]=null,console[_0x14ca47(0x1f4)]('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x137df2=this['paymentTimers']['size'];for(const [_0x4a79bf]of this[_0x14ca47(0x26b)]){this['clearPaymentTimers'](_0x4a79bf);}console[_0x14ca47(0x1f4)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x137df2+_0x14ca47(0x27d));}async[a37_0x5bd8a6(0x1e7)](){const _0x4dbb6e=a37_0x5bd8a6;try{console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x288));const _0x429fe1=await database_1[_0x4dbb6e(0x1c0)]['payment'][_0x4dbb6e(0x233)]({'where':{'gateway':'cointopay','status':_0x4dbb6e(0x20b),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x284)+_0x429fe1[_0x4dbb6e(0x1e5)]+_0x4dbb6e(0x265));if(_0x429fe1[_0x4dbb6e(0x1e5)]===0x0){console['log'](_0x4dbb6e(0x23b));return;}const _0x1ae6e4=await this['checkExpiredPayments'](_0x429fe1);console['log'](_0x4dbb6e(0x264)+_0x1ae6e4[_0x4dbb6e(0x1e5)]+_0x4dbb6e(0x21d));let _0x33f4b8=0x0,_0x266fcb=0x0;for(const _0x3124b9 of _0x429fe1){try{if(_0x1ae6e4[_0x4dbb6e(0x200)](_0x3124b9['id'])){console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x1df)+_0x3124b9['id']+_0x4dbb6e(0x269)),_0x266fcb++;continue;}if(this[_0x4dbb6e(0x26b)][_0x4dbb6e(0x1e1)](_0x3124b9['id'])){console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x1df)+_0x3124b9['id']+_0x4dbb6e(0x266)),_0x266fcb++;continue;}const _0xa249a8=(Date[_0x4dbb6e(0x205)]()-_0x3124b9[_0x4dbb6e(0x1db)][_0x4dbb6e(0x21b)]())/(0x3e8*0x3c*0x3c);if(_0xa249a8<0x1){console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x1df)+_0x3124b9['id']+_0x4dbb6e(0x1d4)+_0xa249a8[_0x4dbb6e(0x276)](0x1)+_0x4dbb6e(0x272)),_0x266fcb++;continue;}console[_0x4dbb6e(0x1f4)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x3124b9['id']+'\x20(age:\x20'+_0xa249a8['toFixed'](0x1)+'h)'),await this['checkSinglePayment'](_0x3124b9),_0x33f4b8++,await new Promise(_0x39e135=>setTimeout(_0x39e135,0x7d0));}catch(_0x539093){console[_0x4dbb6e(0x1ff)](_0x4dbb6e(0x275)+_0x3124b9['id']+':',_0x539093),this[_0x4dbb6e(0x21a)](_0x3124b9['id'],_0x3124b9[_0x4dbb6e(0x1d2)]||_0x4dbb6e(0x24c),_0x539093,_0x4dbb6e(0x270),{'isGlobalCheck':!![],'paymentAmount':_0x3124b9[_0x4dbb6e(0x248)],'paymentCurrency':_0x3124b9[_0x4dbb6e(0x28c)],'shopId':_0x3124b9[_0x4dbb6e(0x1dd)],'createdAt':_0x3124b9[_0x4dbb6e(0x1db)]}),loggerService_1[_0x4dbb6e(0x1c9)]['logWhiteDomainError']('cointopay','/status/'+_0x3124b9[_0x4dbb6e(0x1d2)],_0x539093);}}console[_0x4dbb6e(0x1f4)](_0x4dbb6e(0x203)+_0x33f4b8+'\x20checked,\x20'+_0x266fcb+_0x4dbb6e(0x1fa)+_0x1ae6e4[_0x4dbb6e(0x1e5)]+_0x4dbb6e(0x22b));}catch(_0x3678b9){console[_0x4dbb6e(0x1ff)](_0x4dbb6e(0x26e),_0x3678b9);}}async['checkExpiredPayments'](_0x38f82e){const _0x1ea086=a37_0x5bd8a6,_0x3e8bbb=[],_0x1398eb=new Date();_0x1398eb[_0x1ea086(0x253)](_0x1398eb[_0x1ea086(0x1cf)]()-this[_0x1ea086(0x255)]),console[_0x1ea086(0x1f4)](_0x1ea086(0x202)+this[_0x1ea086(0x255)]+_0x1ea086(0x1b7)+_0x1398eb[_0x1ea086(0x28e)]()+')');for(const _0x46b78f of _0x38f82e){if(_0x46b78f[_0x1ea086(0x1db)]<_0x1398eb){console[_0x1ea086(0x1f4)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x46b78f['id']+_0x1ea086(0x25c)+this[_0x1ea086(0x255)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x1ea086(0x258)](_0x46b78f['id'],_0x46b78f[_0x1ea086(0x1d2)]||'unknown','PENDING',_0x1ea086(0x26d),'auto_expire',{'reason':'Payment\x20older\x20than\x20'+this[_0x1ea086(0x255)]+_0x1ea086(0x221),'createdAt':_0x46b78f[_0x1ea086(0x1db)],'daysSinceCreation':Math['floor']((Date[_0x1ea086(0x205)]()-_0x46b78f[_0x1ea086(0x1db)][_0x1ea086(0x21b)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x46b78f[_0x1ea086(0x248)],'paymentCurrency':_0x46b78f[_0x1ea086(0x28c)],'shopId':_0x46b78f[_0x1ea086(0x1dd)]}),await database_1['default']['payment'][_0x1ea086(0x254)]({'where':{'id':_0x46b78f['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1ea086(0x24d)+this[_0x1ea086(0x255)]+'\x20days\x20without\x20payment\x20confirmation'}}),await database_1['default'][_0x1ea086(0x211)][_0x1ea086(0x214)]({'data':{'paymentId':_0x46b78f['id'],'shopId':_0x46b78f['shopId'],'event':_0x1ea086(0x1ee),'statusCode':0xc8,'responseBody':JSON[_0x1ea086(0x24b)]({'reason':_0x1ea086(0x238)+this['EXPIRY_DAYS']+_0x1ea086(0x221),'createdAt':_0x46b78f['createdAt'],'expiredAt':new Date()['toISOString'](),'daysSinceCreation':Math[_0x1ea086(0x232)]((Date[_0x1ea086(0x205)]()-_0x46b78f[_0x1ea086(0x1db)][_0x1ea086(0x21b)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x46b78f,_0x1ea086(0x26d)),await this[_0x1ea086(0x261)](_0x46b78f,_0x1ea086(0x26d)),this[_0x1ea086(0x292)](_0x46b78f['id']),_0x3e8bbb[_0x1ea086(0x1c6)](_0x46b78f['id']),console[_0x1ea086(0x1f4)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x46b78f['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x1ea086(0x255)]+_0x1ea086(0x283));}catch(_0x54c624){console[_0x1ea086(0x1ff)](_0x1ea086(0x240)+_0x46b78f['id']+':',_0x54c624),this[_0x1ea086(0x21a)](_0x46b78f['id'],_0x46b78f[_0x1ea086(0x1d2)]||_0x1ea086(0x24c),_0x54c624,_0x1ea086(0x245),{'reason':_0x1ea086(0x27b),'createdAt':_0x46b78f[_0x1ea086(0x1db)],'daysSinceCreation':Math[_0x1ea086(0x232)]((Date[_0x1ea086(0x205)]()-_0x46b78f['createdAt'][_0x1ea086(0x21b)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x3e8bbb;}async[a37_0x5bd8a6(0x278)](_0x239ec5){const _0x5279e2=a37_0x5bd8a6;if(!_0x239ec5[_0x5279e2(0x1d2)]){console[_0x5279e2(0x1f4)](_0x5279e2(0x229)+_0x239ec5['id']+_0x5279e2(0x227));return;}console[_0x5279e2(0x1f4)]('🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20'+_0x239ec5['id']+'\x20('+_0x239ec5[_0x5279e2(0x1d2)]+')');try{const _0x3e8552=await this['coinToPayService'][_0x5279e2(0x1b5)](_0x239ec5[_0x5279e2(0x1d2)]);console[_0x5279e2(0x1f4)](_0x5279e2(0x1c2)+_0x239ec5['id']+'\x20status:\x20'+_0x3e8552[_0x5279e2(0x24f)]);_0x3e8552['paymentDetails']&&console[_0x5279e2(0x1f4)]('📊\x20[CHECK]\x20Payment\x20'+_0x239ec5['id']+'\x20details:',{'iban':_0x3e8552['paymentDetails'][_0x5279e2(0x1f1)]||_0x5279e2(0x1fc),'transactionId':_0x3e8552[_0x5279e2(0x281)][_0x5279e2(0x206)],'createdOn':_0x3e8552[_0x5279e2(0x281)][_0x5279e2(0x1c7)],'confirmedOn':_0x3e8552[_0x5279e2(0x281)][_0x5279e2(0x23f)]||_0x5279e2(0x20d)});if(_0x3e8552[_0x5279e2(0x24f)]!==_0x239ec5[_0x5279e2(0x24f)]){console['log'](_0x5279e2(0x1d8)+_0x239ec5['id']+_0x5279e2(0x26f)+_0x239ec5[_0x5279e2(0x24f)]+_0x5279e2(0x26a)+_0x3e8552[_0x5279e2(0x24f)]),this[_0x5279e2(0x258)](_0x239ec5['id'],_0x239ec5['gatewayPaymentId'],_0x239ec5['status'],_0x3e8552[_0x5279e2(0x24f)],_0x5279e2(0x270),{'paymentDetails':_0x3e8552['paymentDetails'],'amount':_0x3e8552[_0x5279e2(0x248)],'currency':_0x3e8552[_0x5279e2(0x28c)],'shopId':_0x239ec5['shopId'],'checkTimestamp':new Date()[_0x5279e2(0x28e)]()});const _0x289a45={'status':_0x3e8552[_0x5279e2(0x24f)],'updatedAt':new Date()};_0x3e8552[_0x5279e2(0x24f)]===_0x5279e2(0x217)&&_0x239ec5['status']!==_0x5279e2(0x217)&&(_0x289a45[_0x5279e2(0x1f7)]=new Date(),console[_0x5279e2(0x1f4)]('💰\x20[CHECK]\x20Payment\x20'+_0x239ec5['id']+_0x5279e2(0x22a)+_0x289a45[_0x5279e2(0x1f7)][_0x5279e2(0x28e)]()));if(_0x3e8552[_0x5279e2(0x281)]){const _0x491722=_0x3e8552['paymentDetails'];_0x491722[_0x5279e2(0x1f1)]&&(_0x289a45['remitterIban']=_0x491722[_0x5279e2(0x1f1)],console[_0x5279e2(0x1f4)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x491722['iban']));if(_0x491722[_0x5279e2(0x1ec)]){const _0x8d9d5d=_0x239ec5[_0x5279e2(0x273)]||'',_0x1b677a='Bank\x20Details:\x20'+_0x491722['bankDetails'];_0x289a45[_0x5279e2(0x273)]=_0x8d9d5d?_0x8d9d5d+'\x0a\x0a'+_0x1b677a:_0x1b677a,console[_0x5279e2(0x1f4)](_0x5279e2(0x1cc));}_0x491722[_0x5279e2(0x206)]&&console[_0x5279e2(0x1f4)](_0x5279e2(0x251)+_0x491722[_0x5279e2(0x206)]),_0x491722[_0x5279e2(0x23f)]&&console[_0x5279e2(0x1f4)](_0x5279e2(0x1de)+_0x491722[_0x5279e2(0x23f)]);}await database_1[_0x5279e2(0x1c0)][_0x5279e2(0x1e0)][_0x5279e2(0x254)]({'where':{'id':_0x239ec5['id']},'data':_0x289a45}),await database_1['default'][_0x5279e2(0x211)][_0x5279e2(0x214)]({'data':{'paymentId':_0x239ec5['id'],'shopId':_0x239ec5[_0x5279e2(0x1dd)],'event':'cointopay_status_check_'+_0x3e8552[_0x5279e2(0x24f)][_0x5279e2(0x20e)](),'statusCode':0xc8,'responseBody':JSON[_0x5279e2(0x24b)]({'oldStatus':_0x239ec5[_0x5279e2(0x24f)],'newStatus':_0x3e8552[_0x5279e2(0x24f)],'paymentDetails':_0x3e8552[_0x5279e2(0x281)],'checkedAt':new Date()[_0x5279e2(0x28e)]()})}}),await this[_0x5279e2(0x223)](_0x239ec5,_0x3e8552['status']),await this['sendPaymentStatusNotification'](_0x239ec5,_0x3e8552[_0x5279e2(0x24f)]),_0x3e8552['status']!=='PENDING'&&(console[_0x5279e2(0x1f4)]('🧹\x20[CHECK]\x20Payment\x20'+_0x239ec5['id']+_0x5279e2(0x267)+_0x3e8552[_0x5279e2(0x24f)]+',\x20clearing\x20individual\x20timers'),this[_0x5279e2(0x292)](_0x239ec5['id'])),console[_0x5279e2(0x1f4)](_0x5279e2(0x24a)+_0x239ec5['id']+_0x5279e2(0x259));}else console[_0x5279e2(0x1f4)]('📊\x20[CHECK]\x20Payment\x20'+_0x239ec5['id']+_0x5279e2(0x1bc)+_0x3e8552[_0x5279e2(0x24f)]+')'),this[_0x5279e2(0x258)](_0x239ec5['id'],_0x239ec5['gatewayPaymentId'],_0x239ec5['status'],_0x3e8552[_0x5279e2(0x24f)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x3e8552[_0x5279e2(0x281)],'amount':_0x3e8552['amount'],'currency':_0x3e8552['currency'],'shopId':_0x239ec5[_0x5279e2(0x1dd)],'checkTimestamp':new Date()[_0x5279e2(0x28e)]()});}catch(_0x1645cc){console[_0x5279e2(0x1ff)](_0x5279e2(0x24e)+_0x239ec5['id']+':',_0x1645cc),this[_0x5279e2(0x21a)](_0x239ec5['id'],_0x239ec5[_0x5279e2(0x1d2)],_0x1645cc,_0x5279e2(0x270),{'paymentAmount':_0x239ec5[_0x5279e2(0x248)],'paymentCurrency':_0x239ec5[_0x5279e2(0x28c)],'shopId':_0x239ec5[_0x5279e2(0x1dd)],'createdAt':_0x239ec5['createdAt']}),await database_1[_0x5279e2(0x1c0)][_0x5279e2(0x211)][_0x5279e2(0x214)]({'data':{'paymentId':_0x239ec5['id'],'shopId':_0x239ec5['shopId'],'event':_0x5279e2(0x1cb),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x1645cc instanceof Error?_0x1645cc[_0x5279e2(0x1bf)]:'Unknown\x20error','gatewayPaymentId':_0x239ec5[_0x5279e2(0x1d2)],'checkedAt':new Date()[_0x5279e2(0x28e)]()})}});}}async[a37_0x5bd8a6(0x223)](_0x231344,_0x1b059d){const _0x4d4958=a37_0x5bd8a6,_0x3902e3=Date['now']();try{const _0x143461=_0x231344['shop'],_0x5b9d38=_0x143461[_0x4d4958(0x225)];if(!_0x5b9d38?.[_0x4d4958(0x1fd)]){console[_0x4d4958(0x1f4)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x143461['id']);return;}const _0x47907c=_0x1b059d===_0x4d4958(0x217)?'payment.success':_0x1b059d==='FAILED'?'payment.failed':_0x1b059d===_0x4d4958(0x26d)?_0x4d4958(0x235):_0x4d4958(0x1ca);if(!_0x5b9d38['webhookEvents']?.['includes'](_0x47907c)){console[_0x4d4958(0x1f4)](_0x4d4958(0x260)+_0x47907c+'\x20not\x20enabled\x20for\x20shop\x20'+_0x143461['id']);return;}const _0x526787={'event':_0x47907c,'payment':{'id':_0x231344['id'],'order_id':_0x231344[_0x4d4958(0x1c4)],'gateway_order_id':_0x231344[_0x4d4958(0x27c)],'gateway':_0x4d4958(0x1e6),'amount':_0x231344[_0x4d4958(0x248)],'currency':_0x231344[_0x4d4958(0x28c)],'status':_0x1b059d[_0x4d4958(0x20e)](),'customer_email':_0x231344[_0x4d4958(0x246)],'customer_name':_0x231344[_0x4d4958(0x1be)],'created_at':_0x231344[_0x4d4958(0x1db)],'updated_at':new Date()}},_0x1ac939=await fetch(_0x5b9d38[_0x4d4958(0x1fd)],{'method':'POST','headers':{'Content-Type':_0x4d4958(0x1d6),'User-Agent':_0x4d4958(0x1f8)},'body':JSON[_0x4d4958(0x24b)](_0x526787)}),_0xee5787=Date[_0x4d4958(0x205)]()-_0x3902e3,_0x358547=_0x1ac939['ok']?_0x4d4958(0x28f):await _0x1ac939[_0x4d4958(0x20c)]();loggerService_1[_0x4d4958(0x1c9)][_0x4d4958(0x222)](_0x231344[_0x4d4958(0x1dd)],_0x5b9d38['webhookUrl'],_0x47907c,_0x1ac939['status'],_0xee5787,_0x526787),console[_0x4d4958(0x1f4)](_0x4d4958(0x1f2)+_0x5b9d38['webhookUrl']+'\x20with\x20status\x20'+_0x1ac939[_0x4d4958(0x24f)]+'\x20('+_0xee5787+_0x4d4958(0x21e));}catch(_0x5d83de){console[_0x4d4958(0x1ff)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x5d83de),loggerService_1[_0x4d4958(0x1c9)][_0x4d4958(0x22c)](_0x231344[_0x4d4958(0x1dd)],_0x231344[_0x4d4958(0x241)]?.[_0x4d4958(0x225)]?.[_0x4d4958(0x1fd)]||_0x4d4958(0x24c),_0x4d4958(0x289),_0x5d83de,{});}}async[a37_0x5bd8a6(0x261)](_0x4c3b76,_0x3846f5){const _0x440b19=a37_0x5bd8a6;try{const _0x2450ba={'PENDING':_0x440b19(0x212),'PAID':_0x440b19(0x250),'FAILED':'failed','EXPIRED':'expired'},_0x3c3396=_0x2450ba[_0x3846f5];if(!_0x3c3396||_0x3c3396===_0x440b19(0x212))return;await telegramBotService_1[_0x440b19(0x244)][_0x440b19(0x263)](_0x4c3b76[_0x440b19(0x1dd)],_0x4c3b76,_0x3c3396);}catch(_0x4a6aa6){console[_0x440b19(0x1ff)](_0x440b19(0x23d),_0x4a6aa6);}}async[a37_0x5bd8a6(0x218)](_0x45204b){const _0x2b007f=a37_0x5bd8a6;console[_0x2b007f(0x1f4)](_0x2b007f(0x23e)+_0x45204b);const _0x285e9b=await database_1[_0x2b007f(0x1c0)]['payment'][_0x2b007f(0x1c8)]({'where':{'id':_0x45204b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x285e9b)throw new Error(_0x2b007f(0x22d));if(_0x285e9b[_0x2b007f(0x23a)]!==_0x2b007f(0x1dc))throw new Error(_0x2b007f(0x27a));console[_0x2b007f(0x1f4)](_0x2b007f(0x1e8)+_0x45204b),await this[_0x2b007f(0x278)](_0x285e9b),console[_0x2b007f(0x1f4)](_0x2b007f(0x204)+_0x45204b);}[a37_0x5bd8a6(0x249)](){const _0x2c4c4a=a37_0x5bd8a6,_0x5e1344=this[_0x2c4c4a(0x25d)]?this[_0x2c4c4a(0x1f5)]:undefined,_0x20f4a4=Array['from'](this[_0x2c4c4a(0x26b)][_0x2c4c4a(0x26c)]())[_0x2c4c4a(0x242)](_0x5c7001=>({'paymentId':_0x5c7001[_0x2c4c4a(0x219)],'gatewayPaymentId':_0x5c7001[_0x2c4c4a(0x1d2)],'createdAt':_0x5c7001['createdAt'],'timersCount':_0x5c7001[_0x2c4c4a(0x207)][_0x2c4c4a(0x1e5)]}));return{'isActive':!!this[_0x2c4c4a(0x25d)],'globalCheckIntervalMinutes':this[_0x2c4c4a(0x1f5)]/(0x3e8*0x3c),'expiryDays':this['EXPIRY_DAYS'],'activeIndividualTimers':this[_0x2c4c4a(0x26b)]['size'],'nextGlobalCheckIn':_0x5e1344,'paymentTimersDetails':_0x20f4a4};}['getPaymentTimerInfo'](_0x219821){const _0x248717=a37_0x5bd8a6,_0x51ad99=this[_0x248717(0x26b)][_0x248717(0x1d9)](_0x219821);if(_0x51ad99)return{'hasTimers':!![],'timersCount':_0x51ad99['timers'][_0x248717(0x1e5)],'createdAt':_0x51ad99[_0x248717(0x1db)],'gatewayPaymentId':_0x51ad99['gatewayPaymentId']};return{'hasTimers':![]};}}exports[a37_0x5bd8a6(0x1d1)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();