'use strict';const a37_0x72ed71=a37_0x1756;function a37_0x1756(_0x2225c8,_0x3781a2){const _0x1d4b01=a37_0x1d4b();return a37_0x1756=function(_0x1756bd,_0xcae42b){_0x1756bd=_0x1756bd-0xfd;let _0x53acc7=_0x1d4b01[_0x1756bd];return _0x53acc7;},a37_0x1756(_0x2225c8,_0x3781a2);}(function(_0x3f75ae,_0xb8389e){const _0x22b50a=a37_0x1756,_0x2054e4=_0x3f75ae();while(!![]){try{const _0x10a0e4=parseInt(_0x22b50a(0x1a0))/0x1+-parseInt(_0x22b50a(0x1bb))/0x2+parseInt(_0x22b50a(0x122))/0x3*(parseInt(_0x22b50a(0x10a))/0x4)+parseInt(_0x22b50a(0x185))/0x5+parseInt(_0x22b50a(0x103))/0x6+-parseInt(_0x22b50a(0x140))/0x7+-parseInt(_0x22b50a(0x100))/0x8*(parseInt(_0x22b50a(0x1b8))/0x9);if(_0x10a0e4===_0xb8389e)break;else _0x2054e4['push'](_0x2054e4['shift']());}catch(_0x44281b){_0x2054e4['push'](_0x2054e4['shift']());}}}(a37_0x1d4b,0x396a3));var __importDefault=this&&this[a37_0x72ed71(0x134)]||function(_0x1df5a7){const _0x19aa49=a37_0x72ed71;return _0x1df5a7&&_0x1df5a7[_0x19aa49(0xff)]?_0x1df5a7:{'default':_0x1df5a7};};Object[a37_0x72ed71(0xfe)](exports,a37_0x72ed71(0xff),{'value':!![]}),exports[a37_0x72ed71(0x1b3)]=exports[a37_0x72ed71(0x1be)]=void 0x0;const coinToPayService_1=require(a37_0x72ed71(0x1af)),paymentLinkService_1=require(a37_0x72ed71(0x18a)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x72ed71(0x163)),loggerService_1=require(a37_0x72ed71(0x19b));function a37_0x1d4b(){const _0x257fc9=['stack','\x20status\x20is\x20','getDate','createdOn','⚠️\x20[CHECK]\x20Payment\x20','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','🪙\x20[GLOBAL]\x20Found\x20','status','status_check','cointopay_status_check_','EXPIRY_DAYS','amount','paymentDetails','gateway','now','default','./telegramBotService',',\x20stopping\x20individual\x20checks','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','auto_expire','paid','✅\x20[CHECK]\x20Payment\x20','Unknown\x20error','description','logShopWebhookSent','🪙\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20expired','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','application/json','cointopay','\x20\x20\x20📍\x20Source:\x20','gatewayPaymentId','telegramBotService','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','2\x20minutes','FAILED','text','cointopay_auto_expired','\x20\x20\x20-\x20Status:\x20','\x20to\x20clear',',\x20clearing\x20individual\x20timers','h),\x20skipping\x20global\x20check','\x20status\x20changed\x20to\x20','sendPaymentNotification','🛑\x20[SHUTDOWN]\x20Cleared\x20','logCoinToPayError','\x20initial\x20timers\x20for\x20payment\x20','⏰\x20[EXPIRY]\x20Payment\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','1265560BfNNqC','checkPaymentById','transactionId','PaymentLinkService','length','./paymentLinkService','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','delay','not\x20found','bankDetails','from','Payment\x20older\x20than\x20','forEach','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','toISOString','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','ms)','create','\x20\x20\x20-\x20GatewayPaymentId:\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','paymentTimers','\x20skipped,\x20','./loggerService','cointopay_status_check_error','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','timestamp','\x20checked,\x20','309246RhXaWT','\x20status:\x20','\x20is\x20older\x20than\x20','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Failed\x20to\x20mark\x20payment\x20as\x20expired','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20days\x20without\x20payment\x20confirmation','❌\x20[CHECK]\x20Payment\x20','\x20is\x20too\x20new\x20(','not\x20confirmed','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','iban','coinToPayService','expired','failed','./gateways/coinToPayService','message','🧹\x20[CHECK]\x20Payment\x20','unknown','coinToPayStatusService','📊\x20[CHECK]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','\x20in\x20','\x20pending\x20CoinToPay\x20payments','3343608lXLUad','createdAt','5\x20minutes','194444ePMunQ','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','catch','CoinToPayStatusService','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','globalCheckInterval','\x20marked\x20as\x20paid\x20at:\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','payment.failed','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','❌\x20[HOURLY]\x20Payment\x20','\x20days\x20(created\x20before\x20','Automatically\x20expired\x20after\x20','get','sendPaymentStatusNotification','toFixed','webhookUrl','clearPaymentTimers','log','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','stringify','\x20to\x20','\x20->\x20','PAID','COINTOPAY_ERROR','logCoinToPayStatus','✅\x20[EXPIRY]\x20Payment\x20','shop','\x20\x20\x20❌\x20Error:\x20','created','\x20\x20\x20-\x20Amount:\x20','\x20\x20\x20📅\x20Time:\x20','floor','paymentId','set','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','Webhook\x20event\x20','defineProperty','__esModule','8lYWZhB','\x20expired\x20CoinToPay\x20payments','confirmedOn','1656000UGTKAW','\x20\x20\x20-\x20Gateway:\x20','📊\x20[HOURLY]\x20Payment\x20','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','Failed\x20to\x20send\x20shop\x20webhook:','has','getServiceStats','4hbwAKJ','checkExpiredPayments','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','payment.pending','PENDING','logWhiteDomainError','sendShopWebhook','\x20seconds\x20(','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','schedule_created','currency','webhookLog','checkSinglePaymentById','payment.success','\x20status\x20from\x20','map','📈\x20[CHECK]\x20Payment\x20link\x20counter\x20updated\x20for\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','\x20not\x20found\x20in\x20database','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','toLowerCase','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','logShopWebhookError','webhookEvents','542358BiTcoN','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','schedulePaymentChecks','adminNotes','payment','error','\x20not\x20enabled\x20for\x20shop\x20','timers','shopId','getTime','webhook_send','push','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','findMany','CoinToPayService','\x20(age:\x20','\x20\x20\x20-\x20ShopId:\x20','GLOBAL_CHECK_INTERVAL_MS','__importDefault','checkAllPendingPayments','1\x20minute','update','paidAt','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20\x20\x20📊\x20Status:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','startPeriodicStatusCheck','EXPIRED','\x20completed\x20for\x20payment\x20','\x20current\x20status:\x20','2206673vSgBfu','\x20updated\x20successfully','size','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','delete','POST','checkSinglePayment','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','loggerService','includes','settings','\x20for\x20payment\x20','\x20with\x20status\x20','\x20has\x20no\x20gatewayPaymentId','✅\x20[HOURLY]\x20Payment\x20','\x20days','findUnique','Bank\x20Details:\x20','\x20not\x20found,\x20clearing\x20timers'];a37_0x1d4b=function(){return _0x257fc9;};return a37_0x1d4b();}class CoinToPayStatusService{constructor(){const _0xc61f2c=a37_0x72ed71;this['globalCheckInterval']=null,this[_0xc61f2c(0x133)]=0x3c*0x3c*0x3e8,this[_0xc61f2c(0x15d)]=0x5,this['paymentTimers']=new Map(),this[_0xc61f2c(0x1ac)]=new coinToPayService_1[(_0xc61f2c(0x130))](),this['paymentLinkService']=new paymentLinkService_1[(_0xc61f2c(0x188))](),console[_0xc61f2c(0x1cd)]('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x72ed71(0x124)](_0x1a847a,_0x23fefd){const _0x3603f1=a37_0x72ed71;console[_0x3603f1(0x1cd)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x3603f1(0x1cd)]('\x20\x20\x20-\x20paymentId:\x20'+_0x1a847a),console[_0x3603f1(0x1cd)](_0x3603f1(0x139)+_0x23fefd),this['clearPaymentTimers'](_0x1a847a);const _0x1737ec=[],_0x290364=new Date(),_0xbc8a4a=[{'delay':0x1*0x3c*0x3e8,'description':_0x3603f1(0x136)},{'delay':0x2*0x3c*0x3e8,'description':_0x3603f1(0x176)},{'delay':0x5*0x3c*0x3e8,'description':_0x3603f1(0x1ba)},{'delay':0x5*0x3c*0x3e8,'description':_0x3603f1(0x1ba)}];console[_0x3603f1(0x1cd)]('🪙\x20[DEBUG]\x20Creating\x20'+_0xbc8a4a[_0x3603f1(0x189)]+_0x3603f1(0x182)+_0x1a847a);let _0x1f4c96=0x0;_0xbc8a4a[_0x3603f1(0x191)]((_0x10de5c,_0x19f2a3)=>{const _0x18874f=_0x3603f1;_0x1f4c96+=_0x10de5c[_0x18874f(0x18c)];const _0x3057d7=setTimeout(async()=>{const _0x75c901=_0x18874f;console[_0x75c901(0x1cd)](_0x75c901(0x16c)+(_0x19f2a3+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x1a847a+'\x20(after\x20'+_0x10de5c[_0x75c901(0x16a)]+')');try{await this[_0x75c901(0x116)](_0x1a847a),console[_0x75c901(0x1cd)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x19f2a3+0x1)+_0x75c901(0x13e)+_0x1a847a);}catch(_0x416db8){console[_0x75c901(0x127)](_0x75c901(0x143)+(_0x19f2a3+0x1)+_0x75c901(0x14b)+_0x1a847a+':',_0x416db8),this[_0x75c901(0x181)](_0x1a847a,_0x23fefd,_0x416db8,_0x75c901(0x15b),{'checkNumber':_0x19f2a3+0x1,'scheduledAfter':_0x10de5c[_0x75c901(0x16a)],'isIndividualCheck':!![]});}},_0x1f4c96);_0x1737ec[_0x18874f(0x12d)](_0x3057d7),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x19f2a3+0x1)+_0x18874f(0x14b)+_0x1a847a+_0x18874f(0x1b6)+_0x1f4c96/0x3e8+_0x18874f(0x111)+_0x10de5c[_0x18874f(0x16a)]+')');});const _0x3b1c8f=setInterval(async()=>{const _0x402682=_0x3603f1;console[_0x402682(0x1cd)](_0x402682(0x16d)+_0x1a847a);try{const _0x63f9ec=await database_1['default'][_0x402682(0x126)][_0x402682(0x150)]({'where':{'id':_0x1a847a},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x63f9ec){console[_0x402682(0x1cd)](_0x402682(0x1c5)+_0x1a847a+_0x402682(0x152)),this['clearPaymentTimers'](_0x1a847a);return;}console[_0x402682(0x1cd)](_0x402682(0x105)+_0x1a847a+_0x402682(0x13f)+_0x63f9ec['status']);if(_0x63f9ec[_0x402682(0x15a)]!==_0x402682(0x10e)){console[_0x402682(0x1cd)](_0x402682(0x14e)+_0x1a847a+_0x402682(0x154)+_0x63f9ec[_0x402682(0x15a)]+_0x402682(0x164)),this[_0x402682(0x1cc)](_0x1a847a);return;}const _0x1e9cc5=Math[_0x402682(0x1db)]((Date[_0x402682(0x161)]()-_0x63f9ec[_0x402682(0x1b9)][_0x402682(0x12b)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x1e9cc5>=this['EXPIRY_DAYS']){console['log']('⏰\x20[HOURLY]\x20Payment\x20'+_0x1a847a+_0x402682(0x1a2)+this[_0x402682(0x15d)]+_0x402682(0x1c4)),this['clearPaymentTimers'](_0x1a847a);return;}await this[_0x402682(0x116)](_0x1a847a),console[_0x402682(0x1cd)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x1a847a);}catch(_0x42f6c4){console[_0x402682(0x127)](_0x402682(0x123)+_0x1a847a+':',_0x42f6c4),this[_0x402682(0x181)](_0x1a847a,_0x23fefd,_0x42f6c4,_0x402682(0x15b),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x1737ec[_0x3603f1(0x12d)](_0x3b1c8f),this[_0x3603f1(0x199)][_0x3603f1(0x1dd)](_0x1a847a,{'timers':_0x1737ec,'paymentId':_0x1a847a,'gatewayPaymentId':_0x23fefd,'createdAt':_0x290364}),console[_0x3603f1(0x1cd)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0xbc8a4a['length']+_0x3603f1(0x1bf)+_0x1a847a),console['log'](_0x3603f1(0x165)+this[_0x3603f1(0x199)][_0x3603f1(0x142)]),this[_0x3603f1(0x1d4)](_0x1a847a,_0x23fefd,'PENDING',_0x3603f1(0x10e),_0x3603f1(0x15b),{'action':_0x3603f1(0x113),'scheduledChecks':_0xbc8a4a[_0x3603f1(0x189)],'firstCheckIn':_0xbc8a4a[0x0][_0x3603f1(0x18c)]/0x3e8,'totalTimers':this[_0x3603f1(0x199)][_0x3603f1(0x142)]});}[a37_0x72ed71(0x1cc)](_0x3dea74){const _0x3a67a2=a37_0x72ed71,_0x2f3182=this[_0x3a67a2(0x199)]['get'](_0x3dea74);_0x2f3182?(console['log']('🧹\x20[DEBUG]\x20Clearing\x20'+_0x2f3182[_0x3a67a2(0x129)]['length']+'\x20timers\x20for\x20payment\x20'+_0x3dea74),_0x2f3182[_0x3a67a2(0x129)]['forEach']((_0xf801f5,_0x25862e)=>{const _0x52cb84=_0x3a67a2;_0xf801f5&&(clearTimeout(_0xf801f5),clearInterval(_0xf801f5),console[_0x52cb84(0x1cd)](_0x52cb84(0x1de)+(_0x25862e+0x1)+'\x20for\x20payment\x20'+_0x3dea74));}),this[_0x3a67a2(0x199)][_0x3a67a2(0x144)](_0x3dea74),console[_0x3a67a2(0x1cd)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x3dea74+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x3a67a2(0x199)][_0x3a67a2(0x142)])):console[_0x3a67a2(0x1cd)](_0x3a67a2(0x11f)+_0x3dea74+_0x3a67a2(0x17b));}async[a37_0x72ed71(0x116)](_0x40cdaf){const _0x2a2e93=a37_0x72ed71;console[_0x2a2e93(0x1cd)](_0x2a2e93(0x1ce)+_0x40cdaf);const _0x464f31=await database_1[_0x2a2e93(0x162)]['payment'][_0x2a2e93(0x150)]({'where':{'id':_0x40cdaf},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x464f31){console['log'](_0x2a2e93(0x1a7)+_0x40cdaf+_0x2a2e93(0x11c));return;}console[_0x2a2e93(0x1cd)]('📊\x20[CHECK]\x20Payment\x20'+_0x40cdaf+'\x20found:'),console['log'](_0x2a2e93(0x104)+_0x464f31[_0x2a2e93(0x160)]),console[_0x2a2e93(0x1cd)](_0x2a2e93(0x17a)+_0x464f31['status']),console[_0x2a2e93(0x1cd)](_0x2a2e93(0x197)+_0x464f31['gatewayPaymentId']),console[_0x2a2e93(0x1cd)](_0x2a2e93(0x1d9)+_0x464f31[_0x2a2e93(0x15e)]+'\x20'+_0x464f31[_0x2a2e93(0x114)]),console[_0x2a2e93(0x1cd)](_0x2a2e93(0x132)+_0x464f31[_0x2a2e93(0x12a)]);if(_0x464f31[_0x2a2e93(0x160)]!==_0x2a2e93(0x171)){console['log'](_0x2a2e93(0x157)+_0x40cdaf+_0x2a2e93(0x184)+_0x464f31[_0x2a2e93(0x160)]+')');return;}if(_0x464f31[_0x2a2e93(0x15a)]!=='PENDING'){console[_0x2a2e93(0x1cd)](_0x2a2e93(0x157)+_0x40cdaf+_0x2a2e93(0x154)+_0x464f31[_0x2a2e93(0x15a)]+_0x2a2e93(0x164)),this[_0x2a2e93(0x1cc)](_0x40cdaf);return;}if(!_0x464f31[_0x2a2e93(0x173)]){console[_0x2a2e93(0x1cd)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x40cdaf+_0x2a2e93(0x14d));return;}console[_0x2a2e93(0x1cd)]('✅\x20[CHECK]\x20Payment\x20'+_0x40cdaf+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x2a2e93(0x146)](_0x464f31);}[a37_0x72ed71(0x1d4)](_0x37cff9,_0x19b231,_0xa55139,_0x1d81fc,_0x5d1f3a,_0x111465){const _0x353e0f=a37_0x72ed71,_0x36fe81={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x37cff9,'gatewayPaymentId':_0x19b231,'oldStatus':_0xa55139,'newStatus':_0x1d81fc,'source':_0x5d1f3a,'timestamp':new Date()[_0x353e0f(0x193)](),'details':_0x111465||{}};loggerService_1[_0x353e0f(0x148)][_0x353e0f(0x1d4)](_0x36fe81),console['log'](_0x353e0f(0x192)+_0x37cff9+'\x20('+_0x19b231+')'),console[_0x353e0f(0x1cd)](_0x353e0f(0x13a)+_0xa55139+_0x353e0f(0x1d1)+_0x1d81fc),console[_0x353e0f(0x1cd)](_0x353e0f(0x172)+_0x5d1f3a),console[_0x353e0f(0x1cd)](_0x353e0f(0x1da)+_0x36fe81[_0x353e0f(0x19e)]),_0x111465&&console[_0x353e0f(0x1cd)]('\x20\x20\x20📝\x20Details:',_0x111465);}['logCoinToPayError'](_0x691866,_0x48e8df,_0x5d6f61,_0x4c4dea,_0x4f8fa6){const _0x16e975=a37_0x72ed71,_0x5cc8ab={'type':_0x16e975(0x1d3),'paymentId':_0x691866,'gatewayPaymentId':_0x48e8df,'error':_0x5d6f61 instanceof Error?{'message':_0x5d6f61['message'],'stack':_0x5d6f61[_0x16e975(0x153)]}:_0x5d6f61,'source':_0x4c4dea,'timestamp':new Date()[_0x16e975(0x193)](),'context':_0x4f8fa6||{}};loggerService_1[_0x16e975(0x148)][_0x16e975(0x181)](_0x5cc8ab),console['error']('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x691866+'\x20('+_0x48e8df+')'),console[_0x16e975(0x127)](_0x16e975(0x1d7)+(_0x5d6f61 instanceof Error?_0x5d6f61['message']:_0x5d6f61)),console['error']('\x20\x20\x20📍\x20Source:\x20'+_0x4c4dea),console[_0x16e975(0x127)](_0x16e975(0x1da)+_0x5cc8ab[_0x16e975(0x19e)]),_0x4f8fa6&&console[_0x16e975(0x127)]('\x20\x20\x20📝\x20Context:',_0x4f8fa6);}[a37_0x72ed71(0x13c)](){const _0x252cf9=a37_0x72ed71;console['log'](_0x252cf9(0x175)),this[_0x252cf9(0x135)]()[_0x252cf9(0x1bd)](_0x3dc0de=>{const _0x5b2707=_0x252cf9;console[_0x5b2707(0x127)](_0x5b2707(0x1bc),_0x3dc0de);}),this['globalCheckInterval']=setInterval(async()=>{const _0x43f5ff=_0x252cf9;try{console[_0x43f5ff(0x1cd)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x43f5ff(0x1cd)](_0x43f5ff(0x1aa));}catch(_0x3a011f){console[_0x43f5ff(0x127)](_0x43f5ff(0x18b),_0x3a011f);}},this['GLOBAL_CHECK_INTERVAL_MS']),console['log'](_0x252cf9(0x19d));}['stopPeriodicStatusCheck'](){const _0xd01162=a37_0x72ed71;console[_0xd01162(0x1cd)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0xd01162(0x1c0)]&&(clearInterval(this[_0xd01162(0x1c0)]),this[_0xd01162(0x1c0)]=null,console['log']('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x161b90=this['paymentTimers'][_0xd01162(0x142)];for(const [_0x2d39bc]of this[_0xd01162(0x199)]){this[_0xd01162(0x1cc)](_0x2d39bc);}console[_0xd01162(0x1cd)](_0xd01162(0x180)+_0x161b90+'\x20individual\x20payment\x20timers');}async[a37_0x72ed71(0x135)](){const _0xd0fb=a37_0x72ed71;try{console[_0xd0fb(0x1cd)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x407559=await database_1[_0xd0fb(0x162)][_0xd0fb(0x126)][_0xd0fb(0x12f)]({'where':{'gateway':_0xd0fb(0x171),'status':_0xd0fb(0x10e),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0xd0fb(0x159)+_0x407559['length']+_0xd0fb(0x1b7));if(_0x407559[_0xd0fb(0x189)]===0x0){console[_0xd0fb(0x1cd)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x518687=await this['checkExpiredPayments'](_0x407559);console['log'](_0xd0fb(0x1b5)+_0x518687['length']+_0xd0fb(0x101));let _0x534483=0x0,_0x28eff4=0x0;for(const _0x296d80 of _0x407559){try{if(_0x518687[_0xd0fb(0x149)](_0x296d80['id'])){console[_0xd0fb(0x1cd)](_0xd0fb(0x11b)+_0x296d80['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check'),_0x28eff4++;continue;}if(this[_0xd0fb(0x199)][_0xd0fb(0x108)](_0x296d80['id'])){console['log']('⏰\x20[GLOBAL]\x20Payment\x20'+_0x296d80['id']+_0xd0fb(0x106)),_0x28eff4++;continue;}const _0x259f83=(Date[_0xd0fb(0x161)]()-_0x296d80['createdAt']['getTime']())/(0x3e8*0x3c*0x3c);if(_0x259f83<0x1){console[_0xd0fb(0x1cd)](_0xd0fb(0x11b)+_0x296d80['id']+_0xd0fb(0x1a8)+_0x259f83[_0xd0fb(0x1ca)](0x1)+_0xd0fb(0x17d)),_0x28eff4++;continue;}console[_0xd0fb(0x1cd)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x296d80['id']+_0xd0fb(0x131)+_0x259f83[_0xd0fb(0x1ca)](0x1)+'h)'),await this[_0xd0fb(0x146)](_0x296d80),_0x534483++,await new Promise(_0x41d1b2=>setTimeout(_0x41d1b2,0x7d0));}catch(_0x3e7c43){console[_0xd0fb(0x127)]('❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x296d80['id']+':',_0x3e7c43),this[_0xd0fb(0x181)](_0x296d80['id'],_0x296d80['gatewayPaymentId']||_0xd0fb(0x1b2),_0x3e7c43,_0xd0fb(0x15b),{'isGlobalCheck':!![],'paymentAmount':_0x296d80['amount'],'paymentCurrency':_0x296d80[_0xd0fb(0x114)],'shopId':_0x296d80['shopId'],'createdAt':_0x296d80[_0xd0fb(0x1b9)]}),loggerService_1[_0xd0fb(0x148)][_0xd0fb(0x10f)]('cointopay','/status/'+_0x296d80['gatewayPaymentId'],_0x3e7c43);}}console[_0xd0fb(0x1cd)](_0xd0fb(0x198)+_0x534483+_0xd0fb(0x19f)+_0x28eff4+_0xd0fb(0x19a)+_0x518687[_0xd0fb(0x189)]+_0xd0fb(0x16e));}catch(_0x21fd2c){console[_0xd0fb(0x127)](_0xd0fb(0x13b),_0x21fd2c);}}async[a37_0x72ed71(0x10b)](_0x25d3e2){const _0x1fd24b=a37_0x72ed71,_0x424c81=[],_0x1f56d3=new Date();_0x1f56d3['setDate'](_0x1f56d3[_0x1fd24b(0x155)]()-this[_0x1fd24b(0x15d)]),console['log'](_0x1fd24b(0x1a5)+this[_0x1fd24b(0x15d)]+_0x1fd24b(0x1c6)+_0x1f56d3[_0x1fd24b(0x193)]()+')');for(const _0xa68e31 of _0x25d3e2){if(_0xa68e31['createdAt']<_0x1f56d3){console[_0x1fd24b(0x1cd)](_0x1fd24b(0x183)+_0xa68e31['id']+_0x1fd24b(0x1a2)+this[_0x1fd24b(0x15d)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x1fd24b(0x1d4)](_0xa68e31['id'],_0xa68e31[_0x1fd24b(0x173)]||_0x1fd24b(0x1b2),_0x1fd24b(0x10e),_0x1fd24b(0x13d),_0x1fd24b(0x166),{'reason':_0x1fd24b(0x190)+this['EXPIRY_DAYS']+_0x1fd24b(0x14f),'createdAt':_0xa68e31[_0x1fd24b(0x1b9)],'daysSinceCreation':Math['floor']((Date['now']()-_0xa68e31['createdAt'][_0x1fd24b(0x12b)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0xa68e31[_0x1fd24b(0x15e)],'paymentCurrency':_0xa68e31[_0x1fd24b(0x114)],'shopId':_0xa68e31[_0x1fd24b(0x12a)]}),await database_1[_0x1fd24b(0x162)][_0x1fd24b(0x126)][_0x1fd24b(0x137)]({'where':{'id':_0xa68e31['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1fd24b(0x1c7)+this[_0x1fd24b(0x15d)]+_0x1fd24b(0x1a6)}}),await database_1[_0x1fd24b(0x162)][_0x1fd24b(0x115)][_0x1fd24b(0x196)]({'data':{'paymentId':_0xa68e31['id'],'shopId':_0xa68e31['shopId'],'event':_0x1fd24b(0x179),'statusCode':0xc8,'responseBody':JSON[_0x1fd24b(0x1cf)]({'reason':_0x1fd24b(0x190)+this[_0x1fd24b(0x15d)]+_0x1fd24b(0x14f),'createdAt':_0xa68e31[_0x1fd24b(0x1b9)],'expiredAt':new Date()[_0x1fd24b(0x193)](),'daysSinceCreation':Math[_0x1fd24b(0x1db)]((Date['now']()-_0xa68e31[_0x1fd24b(0x1b9)][_0x1fd24b(0x12b)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1fd24b(0x110)](_0xa68e31,'EXPIRED'),await this['sendPaymentStatusNotification'](_0xa68e31,_0x1fd24b(0x13d)),this[_0x1fd24b(0x1cc)](_0xa68e31['id']),_0x424c81[_0x1fd24b(0x12d)](_0xa68e31['id']),console[_0x1fd24b(0x1cd)](_0x1fd24b(0x1d5)+_0xa68e31['id']+_0x1fd24b(0x16f)+this[_0x1fd24b(0x15d)]+'-day\x20timeout');}catch(_0x26584e){console[_0x1fd24b(0x127)](_0x1fd24b(0x11d)+_0xa68e31['id']+':',_0x26584e),this[_0x1fd24b(0x181)](_0xa68e31['id'],_0xa68e31[_0x1fd24b(0x173)]||'unknown',_0x26584e,'auto_expire',{'reason':_0x1fd24b(0x1a4),'createdAt':_0xa68e31['createdAt'],'daysSinceCreation':Math[_0x1fd24b(0x1db)]((Date['now']()-_0xa68e31['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x424c81;}async[a37_0x72ed71(0x146)](_0x1222b9){const _0x49c206=a37_0x72ed71;if(!_0x1222b9['gatewayPaymentId']){console[_0x49c206(0x1cd)](_0x49c206(0x157)+_0x1222b9['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x49c206(0x1cd)](_0x49c206(0x12e)+_0x1222b9['id']+'\x20('+_0x1222b9[_0x49c206(0x173)]+')');try{const _0x1c2057=await this[_0x49c206(0x1ac)]['checkPaymentStatus'](_0x1222b9[_0x49c206(0x173)]);console[_0x49c206(0x1cd)]('📊\x20[CHECK]\x20Payment\x20'+_0x1222b9['id']+_0x49c206(0x1a1)+_0x1c2057[_0x49c206(0x15a)]);_0x1c2057[_0x49c206(0x15f)]&&console[_0x49c206(0x1cd)]('📊\x20[CHECK]\x20Payment\x20'+_0x1222b9['id']+'\x20details:',{'iban':_0x1c2057[_0x49c206(0x15f)][_0x49c206(0x1ab)]||_0x49c206(0x18d),'transactionId':_0x1c2057[_0x49c206(0x15f)][_0x49c206(0x187)],'createdOn':_0x1c2057['paymentDetails'][_0x49c206(0x156)],'confirmedOn':_0x1c2057[_0x49c206(0x15f)][_0x49c206(0x102)]||_0x49c206(0x1a9)});if(_0x1c2057[_0x49c206(0x15a)]!==_0x1222b9[_0x49c206(0x15a)]){console[_0x49c206(0x1cd)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x1222b9['id']+_0x49c206(0x118)+_0x1222b9['status']+_0x49c206(0x1d0)+_0x1c2057[_0x49c206(0x15a)]),this[_0x49c206(0x1d4)](_0x1222b9['id'],_0x1222b9[_0x49c206(0x173)],_0x1222b9[_0x49c206(0x15a)],_0x1c2057[_0x49c206(0x15a)],'status_check',{'paymentDetails':_0x1c2057[_0x49c206(0x15f)],'amount':_0x1c2057[_0x49c206(0x15e)],'currency':_0x1c2057[_0x49c206(0x114)],'shopId':_0x1222b9[_0x49c206(0x12a)],'checkTimestamp':new Date()[_0x49c206(0x193)]()});const _0x5f12ca={'status':_0x1c2057[_0x49c206(0x15a)],'updatedAt':new Date()};_0x1c2057[_0x49c206(0x15a)]===_0x49c206(0x1d2)&&_0x1222b9[_0x49c206(0x15a)]!==_0x49c206(0x1d2)&&(_0x5f12ca[_0x49c206(0x138)]=new Date(),console['log']('💰\x20[CHECK]\x20Payment\x20'+_0x1222b9['id']+_0x49c206(0x1c1)+_0x5f12ca[_0x49c206(0x138)]['toISOString']()));if(_0x1c2057[_0x49c206(0x15f)]){const _0xf57524=_0x1c2057['paymentDetails'];_0xf57524[_0x49c206(0x1ab)]&&(_0x5f12ca['remitterIban']=_0xf57524[_0x49c206(0x1ab)],console[_0x49c206(0x1cd)]('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0xf57524[_0x49c206(0x1ab)]));if(_0xf57524[_0x49c206(0x18e)]){const _0x402734=_0x1222b9['adminNotes']||'',_0x4d3236=_0x49c206(0x151)+_0xf57524['bankDetails'];_0x5f12ca[_0x49c206(0x125)]=_0x402734?_0x402734+'\x0a\x0a'+_0x4d3236:_0x4d3236,console['log'](_0x49c206(0x158));}_0xf57524['transactionId']&&console[_0x49c206(0x1cd)]('🆔\x20[CHECK]\x20Transaction\x20ID:\x20'+_0xf57524[_0x49c206(0x187)]),_0xf57524[_0x49c206(0x102)]&&console[_0x49c206(0x1cd)](_0x49c206(0x10c)+_0xf57524[_0x49c206(0x102)]);}await database_1[_0x49c206(0x162)]['payment'][_0x49c206(0x137)]({'where':{'id':_0x1222b9['id']},'data':_0x5f12ca}),await database_1[_0x49c206(0x162)][_0x49c206(0x115)][_0x49c206(0x196)]({'data':{'paymentId':_0x1222b9['id'],'shopId':_0x1222b9['shopId'],'event':_0x49c206(0x15c)+_0x1c2057[_0x49c206(0x15a)][_0x49c206(0x11e)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1222b9[_0x49c206(0x15a)],'newStatus':_0x1c2057[_0x49c206(0x15a)],'paymentDetails':_0x1c2057['paymentDetails'],'checkedAt':new Date()[_0x49c206(0x193)]()})}}),await this[_0x49c206(0x110)](_0x1222b9,_0x1c2057['status']),await this[_0x49c206(0x1c9)](_0x1222b9,_0x1c2057['status']);if(_0x1c2057[_0x49c206(0x15a)]===_0x49c206(0x1d2)&&_0x1222b9[_0x49c206(0x15a)]!==_0x49c206(0x1d2))try{await this['paymentLinkService']['handleSuccessfulPayment'](_0x1222b9['id']),console['log'](_0x49c206(0x11a)+_0x1222b9['id']);}catch(_0x11877a){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20payment\x20'+_0x1222b9['id']+':',_0x11877a);}_0x1c2057[_0x49c206(0x15a)]!==_0x49c206(0x10e)&&(console['log'](_0x49c206(0x1b1)+_0x1222b9['id']+_0x49c206(0x17e)+_0x1c2057[_0x49c206(0x15a)]+_0x49c206(0x17c)),this[_0x49c206(0x1cc)](_0x1222b9['id'])),console['log'](_0x49c206(0x168)+_0x1222b9['id']+_0x49c206(0x141));}else console[_0x49c206(0x1cd)](_0x49c206(0x1b4)+_0x1222b9['id']+'\x20status\x20unchanged\x20('+_0x1c2057[_0x49c206(0x15a)]+')'),this[_0x49c206(0x1d4)](_0x1222b9['id'],_0x1222b9[_0x49c206(0x173)],_0x1222b9[_0x49c206(0x15a)],_0x1c2057[_0x49c206(0x15a)],_0x49c206(0x15b),{'statusUnchanged':!![],'paymentDetails':_0x1c2057[_0x49c206(0x15f)],'amount':_0x1c2057[_0x49c206(0x15e)],'currency':_0x1c2057['currency'],'shopId':_0x1222b9['shopId'],'checkTimestamp':new Date()[_0x49c206(0x193)]()});}catch(_0x294c1){console[_0x49c206(0x127)]('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x1222b9['id']+':',_0x294c1),this[_0x49c206(0x181)](_0x1222b9['id'],_0x1222b9['gatewayPaymentId'],_0x294c1,_0x49c206(0x15b),{'paymentAmount':_0x1222b9[_0x49c206(0x15e)],'paymentCurrency':_0x1222b9[_0x49c206(0x114)],'shopId':_0x1222b9[_0x49c206(0x12a)],'createdAt':_0x1222b9[_0x49c206(0x1b9)]}),await database_1['default'][_0x49c206(0x115)][_0x49c206(0x196)]({'data':{'paymentId':_0x1222b9['id'],'shopId':_0x1222b9[_0x49c206(0x12a)],'event':_0x49c206(0x19c),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x294c1 instanceof Error?_0x294c1[_0x49c206(0x1b0)]:_0x49c206(0x169),'gatewayPaymentId':_0x1222b9[_0x49c206(0x173)],'checkedAt':new Date()[_0x49c206(0x193)]()})}});}}async['sendShopWebhook'](_0x51025c,_0x23dc4d){const _0x3f9300=a37_0x72ed71,_0x1eff3c=Date[_0x3f9300(0x161)]();try{const _0x282a4a=_0x51025c[_0x3f9300(0x1d6)],_0x1033d8=_0x282a4a[_0x3f9300(0x14a)];if(!_0x1033d8?.[_0x3f9300(0x1cb)]){console[_0x3f9300(0x1cd)](_0x3f9300(0x112)+_0x282a4a['id']);return;}const _0x3f06ae=_0x23dc4d===_0x3f9300(0x1d2)?_0x3f9300(0x117):_0x23dc4d===_0x3f9300(0x177)?'payment.failed':_0x23dc4d===_0x3f9300(0x13d)?_0x3f9300(0x1c3):_0x3f9300(0x10d);if(!_0x1033d8[_0x3f9300(0x121)]?.[_0x3f9300(0x149)](_0x3f06ae)){console['log'](_0x3f9300(0xfd)+_0x3f06ae+_0x3f9300(0x128)+_0x282a4a['id']);return;}const _0x2bdf1c={'event':_0x3f06ae,'payment':{'id':_0x51025c['id'],'order_id':_0x51025c['orderId'],'gateway_order_id':_0x51025c['gatewayOrderId'],'gateway':'0100','amount':_0x51025c[_0x3f9300(0x15e)],'currency':_0x51025c[_0x3f9300(0x114)],'status':_0x23dc4d[_0x3f9300(0x11e)](),'customer_email':_0x51025c['customerEmail'],'customer_name':_0x51025c['customerName'],'created_at':_0x51025c[_0x3f9300(0x1b9)],'updated_at':new Date()}},_0xd2fc80=await fetch(_0x1033d8[_0x3f9300(0x1cb)],{'method':_0x3f9300(0x145),'headers':{'Content-Type':_0x3f9300(0x170),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x3f9300(0x1cf)](_0x2bdf1c)}),_0x18b7e1=Date[_0x3f9300(0x161)]()-_0x1eff3c,_0x83043b=_0xd2fc80['ok']?'Success':await _0xd2fc80[_0x3f9300(0x178)]();loggerService_1[_0x3f9300(0x148)][_0x3f9300(0x16b)](_0x51025c[_0x3f9300(0x12a)],_0x1033d8[_0x3f9300(0x1cb)],_0x3f06ae,_0xd2fc80['status'],_0x18b7e1,_0x2bdf1c),console[_0x3f9300(0x1cd)]('Shop\x20webhook\x20sent\x20to\x20'+_0x1033d8[_0x3f9300(0x1cb)]+_0x3f9300(0x14c)+_0xd2fc80[_0x3f9300(0x15a)]+'\x20('+_0x18b7e1+_0x3f9300(0x195));}catch(_0xcc092b){console[_0x3f9300(0x127)](_0x3f9300(0x107),_0xcc092b),loggerService_1[_0x3f9300(0x148)][_0x3f9300(0x120)](_0x51025c[_0x3f9300(0x12a)],_0x51025c[_0x3f9300(0x1d6)]?.[_0x3f9300(0x14a)]?.[_0x3f9300(0x1cb)]||'unknown',_0x3f9300(0x12c),_0xcc092b,{});}}async[a37_0x72ed71(0x1c9)](_0x56972a,_0x3b3e5e){const _0x3010b0=a37_0x72ed71;try{const _0xddff8e={'PENDING':'created','PAID':_0x3010b0(0x167),'FAILED':_0x3010b0(0x1ae),'EXPIRED':_0x3010b0(0x1ad)},_0x3fe686=_0xddff8e[_0x3b3e5e];if(!_0x3fe686||_0x3fe686===_0x3010b0(0x1d8))return;await telegramBotService_1[_0x3010b0(0x174)][_0x3010b0(0x17f)](_0x56972a[_0x3010b0(0x12a)],_0x56972a,_0x3fe686);}catch(_0x22b97c){console[_0x3010b0(0x127)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x22b97c);}}async[a37_0x72ed71(0x186)](_0x5a9e76){const _0x4680a0=a37_0x72ed71;console[_0x4680a0(0x1cd)](_0x4680a0(0x1c2)+_0x5a9e76);const _0x15fc58=await database_1[_0x4680a0(0x162)][_0x4680a0(0x126)]['findUnique']({'where':{'id':_0x5a9e76},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15fc58)throw new Error('Payment\x20not\x20found');if(_0x15fc58[_0x4680a0(0x160)]!==_0x4680a0(0x171))throw new Error(_0x4680a0(0x1a3));console[_0x4680a0(0x1cd)](_0x4680a0(0x147)+_0x5a9e76),await this[_0x4680a0(0x146)](_0x15fc58),console[_0x4680a0(0x1cd)](_0x4680a0(0x194)+_0x5a9e76);}[a37_0x72ed71(0x109)](){const _0x5169dd=a37_0x72ed71,_0x273734=this[_0x5169dd(0x1c0)]?this[_0x5169dd(0x133)]:undefined,_0x38772b=Array[_0x5169dd(0x18f)](this[_0x5169dd(0x199)]['values']())[_0x5169dd(0x119)](_0x2270b9=>({'paymentId':_0x2270b9[_0x5169dd(0x1dc)],'gatewayPaymentId':_0x2270b9[_0x5169dd(0x173)],'createdAt':_0x2270b9[_0x5169dd(0x1b9)],'timersCount':_0x2270b9['timers']['length']}));return{'isActive':!!this[_0x5169dd(0x1c0)],'globalCheckIntervalMinutes':this[_0x5169dd(0x133)]/(0x3e8*0x3c),'expiryDays':this[_0x5169dd(0x15d)],'activeIndividualTimers':this[_0x5169dd(0x199)][_0x5169dd(0x142)],'nextGlobalCheckIn':_0x273734,'paymentTimersDetails':_0x38772b};}['getPaymentTimerInfo'](_0x32a6c4){const _0x38769a=a37_0x72ed71,_0x1a05d0=this[_0x38769a(0x199)][_0x38769a(0x1c8)](_0x32a6c4);if(_0x1a05d0)return{'hasTimers':!![],'timersCount':_0x1a05d0[_0x38769a(0x129)]['length'],'createdAt':_0x1a05d0[_0x38769a(0x1b9)],'gatewayPaymentId':_0x1a05d0[_0x38769a(0x173)]};return{'hasTimers':![]};}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();