'use strict';const a37_0x1c7fd4=a37_0x214c;(function(_0x2bf202,_0x5dbe49){const _0xa02caf=a37_0x214c,_0x997ad8=_0x2bf202();while(!![]){try{const _0x77cc35=parseInt(_0xa02caf(0xe5))/0x1+-parseInt(_0xa02caf(0x161))/0x2*(parseInt(_0xa02caf(0x135))/0x3)+parseInt(_0xa02caf(0x90))/0x4+parseInt(_0xa02caf(0xf9))/0x5*(parseInt(_0xa02caf(0x10f))/0x6)+-parseInt(_0xa02caf(0xc7))/0x7+parseInt(_0xa02caf(0x12c))/0x8+-parseInt(_0xa02caf(0xf0))/0x9;if(_0x77cc35===_0x5dbe49)break;else _0x997ad8['push'](_0x997ad8['shift']());}catch(_0x5832db){_0x997ad8['push'](_0x997ad8['shift']());}}}(a37_0xe81d,0xe18fd));function a37_0xe81d(){const _0x8cf24a=['10403964SqvlrA','\x20\x20\x20üìù\x20Details:','payment.failed','forEach','logCoinToPayStatus','status_check','webhookLog','\x20is\x20valid\x20for\x20checking,\x20proceeding...','payment.success','958565VyoZou','catch','transactionId',',\x20clearing\x20individual\x20timers','PENDING','1\x20minute','log','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','EXPIRY_DAYS','üßπ\x20[CHECK]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','EXPIRED','schedulePaymentChecks','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','üí∞\x20[CHECK]\x20Payment\x20','gateway','bankDetails','‚úÖ\x20[CHECK]\x20Payment\x20','text','36pSxGte','Failed\x20to\x20mark\x20payment\x20as\x20expired','\x20(after\x20','failed','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','set','\x20\x20\x20‚ùå\x20Error:\x20','‚úÖ\x20[HOURLY]\x20Payment\x20','ü™ô\x20[DEBUG]\x20Creating\x20','CoinToPayService','cointopay','sendPaymentNotification','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','created','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20-\x20GatewayPaymentId:\x20','coinToPayService','default','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','‚ùå\x20[HOURLY]\x20Payment\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','iban','\x20status\x20unchanged\x20(','‚è∞\x20[HOURLY]\x20Payment\x20','stringify','checkExpiredPayments','settings','13359072CbusLS','delete','paymentId','Automatically\x20expired\x20after\x20','amount','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','.\x20Remaining\x20active\x20timers:\x20','\x20days\x20(created\x20before\x20','paymentDetails','237981zNTiqc','floor','checkAllPendingPayments','\x20for\x20payment\x20','getPaymentTimerInfo','auto_expire','\x20to\x20','\x20in\x20','confirmedOn','\x20expired\x20CoinToPay\x20payments','get','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','\x20days','payment','\x20\x20\x20-\x20gatewayPaymentId:\x20','‚úÖ\x20[EXPIRY]\x20Payment\x20','includes','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','shop','checkPaymentStatus','\x20skipped,\x20','\x20initial\x20timers\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20is\x20older\x20than\x20','logShopWebhookError','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','startPeriodicStatusCheck','Payment\x20older\x20than\x20','clearPaymentTimers','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','‚è∞\x20[GLOBAL]\x20Found\x20','__esModule','\x20updated\x20successfully','POST','description','gatewayOrderId','\x20has\x20no\x20gatewayPaymentId,\x20skipping','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','findMany','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20checked,\x20','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20status:\x20','\x20days\x20without\x20payment\x20confirmation','18cJTttP','getServiceStats','üìä\x20[CHECK]\x20Payment\x20','currency','toISOString','PAID','\x20(age:\x20','stack','COINTOPAY_ERROR','message','push','length','setDate','\x20status\x20changed\x20to\x20','\x20pending\x20CoinToPay\x20payments','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','paidAt','cointopay_status_check_','telegramBotService','ü™ô\x20[GLOBAL]\x20Found\x20','status','size','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','1126792RBeuOi','orderId','findUnique','\x20\x20\x20-\x20Amount:\x20','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','coinToPayStatusService','createdOn','error','\x20not\x20found\x20in\x20database','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','cointopay_status_check_error','checkSinglePaymentById','now','\x20\x20\x20üìç\x20Source:\x20','toFixed','ms)','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','Payment\x20not\x20found','logCoinToPayError','checkSinglePayment','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','./telegramBotService','COINTOPAY_STATUS_CHANGE','sendPaymentStatusNotification','loggerService','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','\x20details:','create','‚ùå\x20[CHECK]\x20Payment\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','Webhook\x20event\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','\x20has\x20no\x20gatewayPaymentId','2\x20minutes','Bank\x20Details:\x20','sendShopWebhook','5\x20minutes','CoinToPayStatusService','\x20timers\x20for\x20payment\x20','createdAt','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','\x20\x20\x20-\x20ShopId:\x20','TesSoft\x20Payment\x20System/1.0','__importDefault','values','\x20seconds\x20(','\x20status\x20is\x20','\x20to\x20clear','\x20\x20\x20üìÖ\x20Time:\x20','webhookEvents','5835627wXQvBL','gatewayPaymentId','Failed\x20to\x20send\x20shop\x20webhook:','‚è∞\x20[GLOBAL]\x20Payment\x20','payment.pending',',\x20stopping\x20individual\x20checks','paymentTimers','customerName','h),\x20skipping\x20global\x20check','update','toLowerCase','GLOBAL_CHECK_INTERVAL_MS','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','üîç\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20\x20\x20-\x20Status:\x20','logWhiteDomainError','checkPaymentById','\x20status\x20from\x20','\x20\x20\x20-\x20paymentId:\x20','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','getDate','Success','has','paid','./gateways/coinToPayService','webhookUrl','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20expired','-day\x20timeout','shopId','525641vCscAd','adminNotes','getTime','timers','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','webhook_send','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20\x20\x20üìù\x20Context:','unknown','globalCheckInterval'];a37_0xe81d=function(){return _0x8cf24a;};return a37_0xe81d();}var __importDefault=this&&this[a37_0x1c7fd4(0xc0)]||function(_0x3d514d){const _0x5cb8fc=a37_0x1c7fd4;return _0x3d514d&&_0x3d514d[_0x5cb8fc(0x154)]?_0x3d514d:{'default':_0x3d514d};};Object['defineProperty'](exports,a37_0x1c7fd4(0x154),{'value':!![]}),exports[a37_0x1c7fd4(0x95)]=exports[a37_0x1c7fd4(0xb9)]=void 0x0;function a37_0x214c(_0x3c89a2,_0x579567){const _0xe81d77=a37_0xe81d();return a37_0x214c=function(_0x214c0c,_0x44ece5){_0x214c0c=_0x214c0c-0x8d;let _0x533307=_0xe81d77[_0x214c0c];return _0x533307;},a37_0x214c(_0x3c89a2,_0x579567);}const coinToPayService_1=require(a37_0x1c7fd4(0xdf)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x1c7fd4(0xa8)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x4adc32=a37_0x1c7fd4;this[_0x4adc32(0xef)]=null,this[_0x4adc32(0xd2)]=0x3c*0x3c*0x3e8,this[_0x4adc32(0x101)]=0x5,this[_0x4adc32(0xcd)]=new Map(),this[_0x4adc32(0x11f)]=new coinToPayService_1[(_0x4adc32(0x118))](),console[_0x4adc32(0xff)]('ü™ô\x20CoinToPayStatusService\x20initialized');}[a37_0x1c7fd4(0x106)](_0x1dae82,_0x288d3e){const _0x457077=a37_0x1c7fd4;console[_0x457077(0xff)](_0x457077(0x8e)),console[_0x457077(0xff)](_0x457077(0xd9)+_0x1dae82),console[_0x457077(0xff)](_0x457077(0x143)+_0x288d3e),this['clearPaymentTimers'](_0x1dae82);const _0x44f04c=[],_0x5e7f37=new Date(),_0x284721=[{'delay':0x1*0x3c*0x3e8,'description':_0x457077(0xfe)},{'delay':0x2*0x3c*0x3e8,'description':_0x457077(0xb5)},{'delay':0x5*0x3c*0x3e8,'description':_0x457077(0xb8)},{'delay':0x5*0x3c*0x3e8,'description':_0x457077(0xb8)}];console['log'](_0x457077(0x117)+_0x284721[_0x457077(0x16c)]+_0x457077(0x14a)+_0x1dae82);let _0x265d06=0x0;_0x284721['forEach']((_0x1ba341,_0x507c13)=>{const _0x4b7507=_0x457077;_0x265d06+=_0x1ba341['delay'];const _0x225491=setTimeout(async()=>{const _0x3ec9f1=a37_0x214c;console[_0x3ec9f1(0xff)](_0x3ec9f1(0x146)+(_0x507c13+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x1dae82+_0x3ec9f1(0x111)+_0x1ba341[_0x3ec9f1(0x157)]+')');try{await this[_0x3ec9f1(0x9c)](_0x1dae82),console[_0x3ec9f1(0xff)](_0x3ec9f1(0x11d)+(_0x507c13+0x1)+'\x20completed\x20for\x20payment\x20'+_0x1dae82);}catch(_0x3f91c7){console[_0x3ec9f1(0x97)](_0x3ec9f1(0xeb)+(_0x507c13+0x1)+_0x3ec9f1(0x138)+_0x1dae82+':',_0x3f91c7),this[_0x3ec9f1(0xa5)](_0x1dae82,_0x288d3e,_0x3f91c7,_0x3ec9f1(0xf5),{'checkNumber':_0x507c13+0x1,'scheduledAfter':_0x1ba341['description'],'isIndividualCheck':!![]});}},_0x265d06);_0x44f04c[_0x4b7507(0x16b)](_0x225491),console[_0x4b7507(0xff)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x507c13+0x1)+_0x4b7507(0x138)+_0x1dae82+_0x4b7507(0x13c)+_0x265d06/0x3e8+_0x4b7507(0xc2)+_0x1ba341['description']+')');});const _0x38b893=setInterval(async()=>{const _0x15ea56=_0x457077;console['log'](_0x15ea56(0x15c)+_0x1dae82);try{const _0x4f01ec=await database_1[_0x15ea56(0x120)][_0x15ea56(0x142)]['findUnique']({'where':{'id':_0x1dae82},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4f01ec){console[_0x15ea56(0xff)](_0x15ea56(0x124)+_0x1dae82+'\x20not\x20found,\x20clearing\x20timers'),this[_0x15ea56(0x151)](_0x1dae82);return;}console[_0x15ea56(0xff)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x1dae82+'\x20current\x20status:\x20'+_0x4f01ec[_0x15ea56(0x175)]);if(_0x4f01ec[_0x15ea56(0x175)]!==_0x15ea56(0xfd)){console[_0x15ea56(0xff)](_0x15ea56(0x116)+_0x1dae82+_0x15ea56(0xc3)+_0x4f01ec[_0x15ea56(0x175)]+_0x15ea56(0xcc)),this[_0x15ea56(0x151)](_0x1dae82);return;}const _0x227ae4=Math[_0x15ea56(0x136)]((Date['now']()-_0x4f01ec[_0x15ea56(0xbb)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x227ae4>=this[_0x15ea56(0x101)]){console['log'](_0x15ea56(0x128)+_0x1dae82+_0x15ea56(0x14c)+this['EXPIRY_DAYS']+_0x15ea56(0xb3)),this[_0x15ea56(0x151)](_0x1dae82);return;}await this[_0x15ea56(0x9c)](_0x1dae82),console[_0x15ea56(0xff)](_0x15ea56(0xe1)+_0x1dae82);}catch(_0x230e94){console['error'](_0x15ea56(0x15e)+_0x1dae82+':',_0x230e94),this[_0x15ea56(0xa5)](_0x1dae82,_0x288d3e,_0x230e94,_0x15ea56(0xf5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x44f04c[_0x457077(0x16b)](_0x38b893),this['paymentTimers'][_0x457077(0x114)](_0x1dae82,{'timers':_0x44f04c,'paymentId':_0x1dae82,'gatewayPaymentId':_0x288d3e,'createdAt':_0x5e7f37}),console[_0x457077(0xff)]('‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x284721['length']+_0x457077(0x152)+_0x1dae82),console[_0x457077(0xff)](_0x457077(0xa2)+this[_0x457077(0xcd)]['size']),this['logCoinToPayStatus'](_0x1dae82,_0x288d3e,'PENDING',_0x457077(0xfd),_0x457077(0xf5),{'action':'schedule_created','scheduledChecks':_0x284721[_0x457077(0x16c)],'firstCheckIn':_0x284721[0x0]['delay']/0x3e8,'totalTimers':this[_0x457077(0xcd)][_0x457077(0x8d)]});}[a37_0x1c7fd4(0x151)](_0x300717){const _0x5b911f=a37_0x1c7fd4,_0x5f4062=this['paymentTimers'][_0x5b911f(0x13f)](_0x300717);_0x5f4062?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x5f4062[_0x5b911f(0xe8)]['length']+_0x5b911f(0xba)+_0x300717),_0x5f4062[_0x5b911f(0xe8)][_0x5b911f(0xf3)]((_0x2f066a,_0x4060a4)=>{const _0x48df9a=_0x5b911f;_0x2f066a&&(clearTimeout(_0x2f066a),clearInterval(_0x2f066a),console[_0x48df9a(0xff)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x4060a4+0x1)+_0x48df9a(0x138)+_0x300717));}),this[_0x5b911f(0xcd)][_0x5b911f(0x12d)](_0x300717),console[_0x5b911f(0xff)](_0x5b911f(0x11b)+_0x300717+_0x5b911f(0x132)+this[_0x5b911f(0xcd)]['size'])):console[_0x5b911f(0xff)](_0x5b911f(0x140)+_0x300717+_0x5b911f(0xc4));}async['checkSinglePaymentById'](_0x22407){const _0x23f76c=a37_0x1c7fd4;console[_0x23f76c(0xff)](_0x23f76c(0x131)+_0x22407);const _0x2d8458=await database_1[_0x23f76c(0x120)]['payment']['findUnique']({'where':{'id':_0x22407},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2d8458){console['log'](_0x23f76c(0xaf)+_0x22407+_0x23f76c(0x98));return;}console[_0x23f76c(0xff)](_0x23f76c(0x163)+_0x22407+'\x20found:'),console[_0x23f76c(0xff)]('\x20\x20\x20-\x20Gateway:\x20'+_0x2d8458[_0x23f76c(0x10b)]),console[_0x23f76c(0xff)](_0x23f76c(0xd5)+_0x2d8458[_0x23f76c(0x175)]),console[_0x23f76c(0xff)](_0x23f76c(0x11e)+_0x2d8458[_0x23f76c(0xc8)]),console[_0x23f76c(0xff)](_0x23f76c(0x93)+_0x2d8458[_0x23f76c(0x130)]+'\x20'+_0x2d8458[_0x23f76c(0x164)]),console['log'](_0x23f76c(0xbe)+_0x2d8458[_0x23f76c(0xe4)]);if(_0x2d8458[_0x23f76c(0x10b)]!==_0x23f76c(0x119)){console['log'](_0x23f76c(0x15a)+_0x22407+'\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20'+_0x2d8458[_0x23f76c(0x10b)]+')');return;}if(_0x2d8458['status']!=='PENDING'){console[_0x23f76c(0xff)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x22407+_0x23f76c(0xc3)+_0x2d8458[_0x23f76c(0x175)]+_0x23f76c(0xcc)),this[_0x23f76c(0x151)](_0x22407);return;}if(!_0x2d8458['gatewayPaymentId']){console[_0x23f76c(0xff)](_0x23f76c(0x15a)+_0x22407+_0x23f76c(0xb4));return;}console[_0x23f76c(0xff)](_0x23f76c(0x10d)+_0x22407+_0x23f76c(0xf7)),await this['checkSinglePayment'](_0x2d8458);}[a37_0x1c7fd4(0xf4)](_0x399a09,_0x4ec7ac,_0x19508e,_0x3219ab,_0x4d3236,_0x5e2bf4){const _0x4bfc1b=a37_0x1c7fd4,_0x588077={'type':_0x4bfc1b(0xa9),'paymentId':_0x399a09,'gatewayPaymentId':_0x4ec7ac,'oldStatus':_0x19508e,'newStatus':_0x3219ab,'source':_0x4d3236,'timestamp':new Date()[_0x4bfc1b(0x165)](),'details':_0x5e2bf4||{}};loggerService_1[_0x4bfc1b(0xab)][_0x4bfc1b(0xf4)](_0x588077),console[_0x4bfc1b(0xff)](_0x4bfc1b(0xda)+_0x399a09+'\x20('+_0x4ec7ac+')'),console[_0x4bfc1b(0xff)]('\x20\x20\x20üìä\x20Status:\x20'+_0x19508e+'\x20->\x20'+_0x3219ab),console[_0x4bfc1b(0xff)]('\x20\x20\x20üìç\x20Source:\x20'+_0x4d3236),console[_0x4bfc1b(0xff)](_0x4bfc1b(0xc5)+_0x588077['timestamp']),_0x5e2bf4&&console[_0x4bfc1b(0xff)](_0x4bfc1b(0xf1),_0x5e2bf4);}[a37_0x1c7fd4(0xa5)](_0x5deb85,_0x4040e6,_0x3cb482,_0x211058,_0x3afad2){const _0x473ffc=a37_0x1c7fd4,_0x3a255f={'type':_0x473ffc(0x169),'paymentId':_0x5deb85,'gatewayPaymentId':_0x4040e6,'error':_0x3cb482 instanceof Error?{'message':_0x3cb482[_0x473ffc(0x16a)],'stack':_0x3cb482[_0x473ffc(0x168)]}:_0x3cb482,'source':_0x211058,'timestamp':new Date()[_0x473ffc(0x165)](),'context':_0x3afad2||{}};loggerService_1[_0x473ffc(0xab)]['logCoinToPayError'](_0x3a255f),console[_0x473ffc(0x97)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x5deb85+'\x20('+_0x4040e6+')'),console[_0x473ffc(0x97)](_0x473ffc(0x115)+(_0x3cb482 instanceof Error?_0x3cb482['message']:_0x3cb482)),console[_0x473ffc(0x97)](_0x473ffc(0x9e)+_0x211058),console['error'](_0x473ffc(0xc5)+_0x3a255f['timestamp']),_0x3afad2&&console[_0x473ffc(0x97)](_0x473ffc(0xed),_0x3afad2);}[a37_0x1c7fd4(0x14f)](){const _0x5c359b=a37_0x1c7fd4;console[_0x5c359b(0xff)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x5c359b(0x137)]()[_0x5c359b(0xfa)](_0x4775bd=>{const _0x37ec01=_0x5c359b;console[_0x37ec01(0x97)](_0x37ec01(0xb0),_0x4775bd);}),this[_0x5c359b(0xef)]=setInterval(async()=>{const _0x44d803=_0x5c359b;try{console[_0x44d803(0xff)](_0x44d803(0xe9)),await this[_0x44d803(0x137)](),console[_0x44d803(0xff)](_0x44d803(0x9a));}catch(_0x159d22){console[_0x44d803(0x97)](_0x44d803(0x100),_0x159d22);}},this[_0x5c359b(0xd2)]),console[_0x5c359b(0xff)](_0x5c359b(0xac));}['stopPeriodicStatusCheck'](){const _0x386c9e=a37_0x1c7fd4;console[_0x386c9e(0xff)](_0x386c9e(0x94));this['globalCheckInterval']&&(clearInterval(this['globalCheckInterval']),this['globalCheckInterval']=null,console[_0x386c9e(0xff)](_0x386c9e(0x109)));const _0x105883=this[_0x386c9e(0xcd)][_0x386c9e(0x8d)];for(const [_0x34aac0]of this[_0x386c9e(0xcd)]){this['clearPaymentTimers'](_0x34aac0);}console[_0x386c9e(0xff)](_0x386c9e(0x125)+_0x105883+'\x20individual\x20payment\x20timers');}async[a37_0x1c7fd4(0x137)](){const _0x5e8a30=a37_0x1c7fd4;try{console['log']('ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x57561a=await database_1[_0x5e8a30(0x120)]['payment'][_0x5e8a30(0x15b)]({'where':{'gateway':_0x5e8a30(0x119),'status':_0x5e8a30(0xfd),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x5e8a30(0xff)](_0x5e8a30(0x174)+_0x57561a['length']+_0x5e8a30(0x16f));if(_0x57561a[_0x5e8a30(0x16c)]===0x0){console[_0x5e8a30(0xff)](_0x5e8a30(0xbc));return;}const _0x13ddfe=await this[_0x5e8a30(0x12a)](_0x57561a);console[_0x5e8a30(0xff)](_0x5e8a30(0x153)+_0x13ddfe[_0x5e8a30(0x16c)]+_0x5e8a30(0x13e));let _0x2c5f55=0x0,_0x433190=0x0;for(const _0x250863 of _0x57561a){try{if(_0x13ddfe[_0x5e8a30(0x145)](_0x250863['id'])){console['log']('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x250863['id']+_0x5e8a30(0x14e)),_0x433190++;continue;}if(this[_0x5e8a30(0xcd)][_0x5e8a30(0xdd)](_0x250863['id'])){console['log'](_0x5e8a30(0xca)+_0x250863['id']+_0x5e8a30(0xd3)),_0x433190++;continue;}const _0x5c2469=(Date[_0x5e8a30(0x9d)]()-_0x250863[_0x5e8a30(0xbb)][_0x5e8a30(0xe7)]())/(0x3e8*0x3c*0x3c);if(_0x5c2469<0x1){console[_0x5e8a30(0xff)](_0x5e8a30(0xca)+_0x250863['id']+'\x20is\x20too\x20new\x20('+_0x5c2469[_0x5e8a30(0x9f)](0x1)+_0x5e8a30(0xcf)),_0x433190++;continue;}console['log'](_0x5e8a30(0xa3)+_0x250863['id']+_0x5e8a30(0x167)+_0x5c2469[_0x5e8a30(0x9f)](0x1)+'h)'),await this[_0x5e8a30(0xa6)](_0x250863),_0x2c5f55++,await new Promise(_0x44e5c2=>setTimeout(_0x44e5c2,0x7d0));}catch(_0x580692){console[_0x5e8a30(0x97)](_0x5e8a30(0x8f)+_0x250863['id']+':',_0x580692),this['logCoinToPayError'](_0x250863['id'],_0x250863[_0x5e8a30(0xc8)]||'unknown',_0x580692,_0x5e8a30(0xf5),{'isGlobalCheck':!![],'paymentAmount':_0x250863[_0x5e8a30(0x130)],'paymentCurrency':_0x250863['currency'],'shopId':_0x250863[_0x5e8a30(0xe4)],'createdAt':_0x250863[_0x5e8a30(0xbb)]}),loggerService_1[_0x5e8a30(0xab)][_0x5e8a30(0xd6)](_0x5e8a30(0x119),'/status/'+_0x250863[_0x5e8a30(0xc8)],_0x580692);}}console[_0x5e8a30(0xff)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x2c5f55+_0x5e8a30(0x15d)+_0x433190+_0x5e8a30(0x149)+_0x13ddfe[_0x5e8a30(0x16c)]+_0x5e8a30(0xe2));}catch(_0x579d29){console[_0x5e8a30(0x97)](_0x5e8a30(0x104),_0x579d29);}}async[a37_0x1c7fd4(0x12a)](_0x4b778f){const _0x124cca=a37_0x1c7fd4,_0x17dc8e=[],_0x64c423=new Date();_0x64c423[_0x124cca(0x16d)](_0x64c423[_0x124cca(0xdb)]()-this[_0x124cca(0x101)]),console[_0x124cca(0xff)](_0x124cca(0x113)+this[_0x124cca(0x101)]+_0x124cca(0x133)+_0x64c423[_0x124cca(0x165)]()+')');for(const _0x57a031 of _0x4b778f){if(_0x57a031[_0x124cca(0xbb)]<_0x64c423){console[_0x124cca(0xff)]('‚è∞\x20[EXPIRY]\x20Payment\x20'+_0x57a031['id']+_0x124cca(0x14c)+this[_0x124cca(0x101)]+_0x124cca(0x103));try{this[_0x124cca(0xf4)](_0x57a031['id'],_0x57a031[_0x124cca(0xc8)]||_0x124cca(0xee),_0x124cca(0xfd),_0x124cca(0x105),_0x124cca(0x13a),{'reason':'Payment\x20older\x20than\x20'+this[_0x124cca(0x101)]+'\x20days','createdAt':_0x57a031['createdAt'],'daysSinceCreation':Math[_0x124cca(0x136)]((Date[_0x124cca(0x9d)]()-_0x57a031[_0x124cca(0xbb)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x57a031[_0x124cca(0x130)],'paymentCurrency':_0x57a031[_0x124cca(0x164)],'shopId':_0x57a031[_0x124cca(0xe4)]}),await database_1[_0x124cca(0x120)][_0x124cca(0x142)]['update']({'where':{'id':_0x57a031['id']},'data':{'status':_0x124cca(0x105),'updatedAt':new Date(),'adminNotes':_0x124cca(0x12f)+this[_0x124cca(0x101)]+_0x124cca(0x160)}}),await database_1[_0x124cca(0x120)][_0x124cca(0xf6)][_0x124cca(0xae)]({'data':{'paymentId':_0x57a031['id'],'shopId':_0x57a031[_0x124cca(0xe4)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x124cca(0x150)+this[_0x124cca(0x101)]+_0x124cca(0x141),'createdAt':_0x57a031[_0x124cca(0xbb)],'expiredAt':new Date()[_0x124cca(0x165)](),'daysSinceCreation':Math[_0x124cca(0x136)]((Date[_0x124cca(0x9d)]()-_0x57a031[_0x124cca(0xbb)][_0x124cca(0xe7)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x124cca(0xb7)](_0x57a031,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x57a031,'EXPIRED'),this[_0x124cca(0x151)](_0x57a031['id']),_0x17dc8e[_0x124cca(0x16b)](_0x57a031['id']),console[_0x124cca(0xff)](_0x124cca(0x144)+_0x57a031['id']+_0x124cca(0xbd)+this[_0x124cca(0x101)]+_0x124cca(0xe3));}catch(_0x342942){console[_0x124cca(0x97)](_0x124cca(0x108)+_0x57a031['id']+':',_0x342942),this[_0x124cca(0xa5)](_0x57a031['id'],_0x57a031[_0x124cca(0xc8)]||_0x124cca(0xee),_0x342942,_0x124cca(0x13a),{'reason':_0x124cca(0x110),'createdAt':_0x57a031[_0x124cca(0xbb)],'daysSinceCreation':Math['floor']((Date[_0x124cca(0x9d)]()-_0x57a031[_0x124cca(0xbb)][_0x124cca(0xe7)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x17dc8e;}async[a37_0x1c7fd4(0xa6)](_0xbff348){const _0x2127a3=a37_0x1c7fd4;if(!_0xbff348[_0x2127a3(0xc8)]){console[_0x2127a3(0xff)](_0x2127a3(0x15a)+_0xbff348['id']+_0x2127a3(0x159));return;}console[_0x2127a3(0xff)](_0x2127a3(0xd4)+_0xbff348['id']+'\x20('+_0xbff348['gatewayPaymentId']+')');try{const _0x27c862=await this[_0x2127a3(0x11f)][_0x2127a3(0x148)](_0xbff348[_0x2127a3(0xc8)]);console[_0x2127a3(0xff)](_0x2127a3(0x163)+_0xbff348['id']+_0x2127a3(0x15f)+_0x27c862['status']);_0x27c862[_0x2127a3(0x134)]&&console[_0x2127a3(0xff)]('üìä\x20[CHECK]\x20Payment\x20'+_0xbff348['id']+_0x2127a3(0xad),{'iban':_0x27c862['paymentDetails']['iban']||'not\x20found','transactionId':_0x27c862[_0x2127a3(0x134)][_0x2127a3(0xfb)],'createdOn':_0x27c862['paymentDetails'][_0x2127a3(0x96)],'confirmedOn':_0x27c862[_0x2127a3(0x134)][_0x2127a3(0x13d)]||'not\x20confirmed'});if(_0x27c862[_0x2127a3(0x175)]!==_0xbff348[_0x2127a3(0x175)]){console['log'](_0x2127a3(0xa7)+_0xbff348['id']+_0x2127a3(0xd8)+_0xbff348[_0x2127a3(0x175)]+_0x2127a3(0x13b)+_0x27c862['status']),this[_0x2127a3(0xf4)](_0xbff348['id'],_0xbff348['gatewayPaymentId'],_0xbff348['status'],_0x27c862[_0x2127a3(0x175)],'status_check',{'paymentDetails':_0x27c862[_0x2127a3(0x134)],'amount':_0x27c862[_0x2127a3(0x130)],'currency':_0x27c862['currency'],'shopId':_0xbff348[_0x2127a3(0xe4)],'checkTimestamp':new Date()[_0x2127a3(0x165)]()});const _0x3a06f1={'status':_0x27c862['status'],'updatedAt':new Date()};_0x27c862[_0x2127a3(0x175)]===_0x2127a3(0x166)&&_0xbff348[_0x2127a3(0x175)]!==_0x2127a3(0x166)&&(_0x3a06f1[_0x2127a3(0x171)]=new Date(),console[_0x2127a3(0xff)](_0x2127a3(0x10a)+_0xbff348['id']+_0x2127a3(0x14b)+_0x3a06f1[_0x2127a3(0x171)][_0x2127a3(0x165)]()));if(_0x27c862[_0x2127a3(0x134)]){const _0x3d1311=_0x27c862[_0x2127a3(0x134)];_0x3d1311[_0x2127a3(0x126)]&&(_0x3a06f1['remitterIban']=_0x3d1311['iban'],console['log']('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x3d1311[_0x2127a3(0x126)]));if(_0x3d1311[_0x2127a3(0x10c)]){const _0x31a577=_0xbff348[_0x2127a3(0xe6)]||'',_0xaec89d=_0x2127a3(0xb6)+_0x3d1311[_0x2127a3(0x10c)];_0x3a06f1[_0x2127a3(0xe6)]=_0x31a577?_0x31a577+'\x0a\x0a'+_0xaec89d:_0xaec89d,console[_0x2127a3(0xff)](_0x2127a3(0x122));}_0x3d1311['transactionId']&&console[_0x2127a3(0xff)](_0x2127a3(0x121)+_0x3d1311[_0x2127a3(0xfb)]),_0x3d1311['confirmedOn']&&console['log'](_0x2127a3(0x107)+_0x3d1311['confirmedOn']);}await database_1[_0x2127a3(0x120)][_0x2127a3(0x142)][_0x2127a3(0xd0)]({'where':{'id':_0xbff348['id']},'data':_0x3a06f1}),await database_1[_0x2127a3(0x120)][_0x2127a3(0xf6)][_0x2127a3(0xae)]({'data':{'paymentId':_0xbff348['id'],'shopId':_0xbff348[_0x2127a3(0xe4)],'event':_0x2127a3(0x172)+_0x27c862['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xbff348[_0x2127a3(0x175)],'newStatus':_0x27c862[_0x2127a3(0x175)],'paymentDetails':_0x27c862[_0x2127a3(0x134)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x2127a3(0xb7)](_0xbff348,_0x27c862[_0x2127a3(0x175)]),await this['sendPaymentStatusNotification'](_0xbff348,_0x27c862[_0x2127a3(0x175)]),_0x27c862[_0x2127a3(0x175)]!=='PENDING'&&(console['log'](_0x2127a3(0x102)+_0xbff348['id']+_0x2127a3(0x16e)+_0x27c862[_0x2127a3(0x175)]+_0x2127a3(0xfc)),this['clearPaymentTimers'](_0xbff348['id'])),console[_0x2127a3(0xff)](_0x2127a3(0x10d)+_0xbff348['id']+_0x2127a3(0x155));}else console[_0x2127a3(0xff)]('üìä\x20[CHECK]\x20Payment\x20'+_0xbff348['id']+_0x2127a3(0x127)+_0x27c862[_0x2127a3(0x175)]+')'),this[_0x2127a3(0xf4)](_0xbff348['id'],_0xbff348[_0x2127a3(0xc8)],_0xbff348[_0x2127a3(0x175)],_0x27c862['status'],_0x2127a3(0xf5),{'statusUnchanged':!![],'paymentDetails':_0x27c862[_0x2127a3(0x134)],'amount':_0x27c862[_0x2127a3(0x130)],'currency':_0x27c862[_0x2127a3(0x164)],'shopId':_0xbff348['shopId'],'checkTimestamp':new Date()[_0x2127a3(0x165)]()});}catch(_0x12cb42){console[_0x2127a3(0x97)](_0x2127a3(0x99)+_0xbff348['id']+':',_0x12cb42),this[_0x2127a3(0xa5)](_0xbff348['id'],_0xbff348[_0x2127a3(0xc8)],_0x12cb42,_0x2127a3(0xf5),{'paymentAmount':_0xbff348['amount'],'paymentCurrency':_0xbff348[_0x2127a3(0x164)],'shopId':_0xbff348[_0x2127a3(0xe4)],'createdAt':_0xbff348['createdAt']}),await database_1[_0x2127a3(0x120)]['webhookLog'][_0x2127a3(0xae)]({'data':{'paymentId':_0xbff348['id'],'shopId':_0xbff348['shopId'],'event':_0x2127a3(0x9b),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x12cb42 instanceof Error?_0x12cb42[_0x2127a3(0x16a)]:'Unknown\x20error','gatewayPaymentId':_0xbff348[_0x2127a3(0xc8)],'checkedAt':new Date()[_0x2127a3(0x165)]()})}});}}async[a37_0x1c7fd4(0xb7)](_0x531188,_0x2919b8){const _0x59dd9c=a37_0x1c7fd4,_0x156be1=Date[_0x59dd9c(0x9d)]();try{const _0x585fe6=_0x531188[_0x59dd9c(0x147)],_0x15fb04=_0x585fe6[_0x59dd9c(0x12b)];if(!_0x15fb04?.[_0x59dd9c(0xe0)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x585fe6['id']);return;}const _0xa3527d=_0x2919b8===_0x59dd9c(0x166)?_0x59dd9c(0xf8):_0x2919b8==='FAILED'?'payment.failed':_0x2919b8===_0x59dd9c(0x105)?_0x59dd9c(0xf2):_0x59dd9c(0xcb);if(!_0x15fb04[_0x59dd9c(0xc6)]?.[_0x59dd9c(0x145)](_0xa3527d)){console[_0x59dd9c(0xff)](_0x59dd9c(0xb2)+_0xa3527d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x585fe6['id']);return;}const _0x52c277={'event':_0xa3527d,'payment':{'id':_0x531188['id'],'order_id':_0x531188[_0x59dd9c(0x91)],'gateway_order_id':_0x531188[_0x59dd9c(0x158)],'gateway':'0100','amount':_0x531188['amount'],'currency':_0x531188[_0x59dd9c(0x164)],'status':_0x2919b8[_0x59dd9c(0xd1)](),'customer_email':_0x531188['customerEmail'],'customer_name':_0x531188[_0x59dd9c(0xce)],'created_at':_0x531188[_0x59dd9c(0xbb)],'updated_at':new Date()}},_0x115e59=await fetch(_0x15fb04[_0x59dd9c(0xe0)],{'method':_0x59dd9c(0x156),'headers':{'Content-Type':'application/json','User-Agent':_0x59dd9c(0xbf)},'body':JSON[_0x59dd9c(0x129)](_0x52c277)}),_0xabb9e0=Date[_0x59dd9c(0x9d)]()-_0x156be1,_0x40caa2=_0x115e59['ok']?_0x59dd9c(0xdc):await _0x115e59[_0x59dd9c(0x10e)]();loggerService_1[_0x59dd9c(0xab)]['logShopWebhookSent'](_0x531188[_0x59dd9c(0xe4)],_0x15fb04[_0x59dd9c(0xe0)],_0xa3527d,_0x115e59[_0x59dd9c(0x175)],_0xabb9e0,_0x52c277),console['log']('Shop\x20webhook\x20sent\x20to\x20'+_0x15fb04[_0x59dd9c(0xe0)]+'\x20with\x20status\x20'+_0x115e59['status']+'\x20('+_0xabb9e0+_0x59dd9c(0xa0));}catch(_0x36322a){console[_0x59dd9c(0x97)](_0x59dd9c(0xc9),_0x36322a),loggerService_1['loggerService'][_0x59dd9c(0x14d)](_0x531188[_0x59dd9c(0xe4)],_0x531188['shop']?.[_0x59dd9c(0x12b)]?.[_0x59dd9c(0xe0)]||_0x59dd9c(0xee),_0x59dd9c(0xea),_0x36322a,{});}}async[a37_0x1c7fd4(0xaa)](_0x2ae8ae,_0x308718){const _0x4a9e5b=a37_0x1c7fd4;try{const _0x3a51c9={'PENDING':_0x4a9e5b(0x11c),'PAID':_0x4a9e5b(0xde),'FAILED':_0x4a9e5b(0x112),'EXPIRED':'expired'},_0x36455a=_0x3a51c9[_0x308718];if(!_0x36455a||_0x36455a==='created')return;await telegramBotService_1[_0x4a9e5b(0x173)][_0x4a9e5b(0x11a)](_0x2ae8ae[_0x4a9e5b(0xe4)],_0x2ae8ae,_0x36455a);}catch(_0x56afa1){console[_0x4a9e5b(0x97)](_0x4a9e5b(0xec),_0x56afa1);}}async[a37_0x1c7fd4(0xd7)](_0x5c3117){const _0x2a7397=a37_0x1c7fd4;console['log'](_0x2a7397(0x123)+_0x5c3117);const _0x2ff555=await database_1[_0x2a7397(0x120)][_0x2a7397(0x142)][_0x2a7397(0x92)]({'where':{'id':_0x5c3117},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ff555)throw new Error(_0x2a7397(0xa4));if(_0x2ff555[_0x2a7397(0x10b)]!==_0x2a7397(0x119))throw new Error(_0x2a7397(0xb1));console['log'](_0x2a7397(0xa1)+_0x5c3117),await this['checkSinglePayment'](_0x2ff555),console[_0x2a7397(0xff)](_0x2a7397(0x170)+_0x5c3117);}[a37_0x1c7fd4(0x162)](){const _0x407c54=a37_0x1c7fd4,_0x1a911c=this['globalCheckInterval']?this[_0x407c54(0xd2)]:undefined,_0x5b8cf5=Array['from'](this[_0x407c54(0xcd)][_0x407c54(0xc1)]())['map'](_0x443ad5=>({'paymentId':_0x443ad5[_0x407c54(0x12e)],'gatewayPaymentId':_0x443ad5[_0x407c54(0xc8)],'createdAt':_0x443ad5[_0x407c54(0xbb)],'timersCount':_0x443ad5[_0x407c54(0xe8)][_0x407c54(0x16c)]}));return{'isActive':!!this[_0x407c54(0xef)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x407c54(0x101)],'activeIndividualTimers':this[_0x407c54(0xcd)][_0x407c54(0x8d)],'nextGlobalCheckIn':_0x1a911c,'paymentTimersDetails':_0x5b8cf5};}[a37_0x1c7fd4(0x139)](_0x1474c2){const _0x3cf83c=a37_0x1c7fd4,_0x44f74b=this[_0x3cf83c(0xcd)]['get'](_0x1474c2);if(_0x44f74b)return{'hasTimers':!![],'timersCount':_0x44f74b[_0x3cf83c(0xe8)][_0x3cf83c(0x16c)],'createdAt':_0x44f74b['createdAt'],'gatewayPaymentId':_0x44f74b[_0x3cf83c(0xc8)]};return{'hasTimers':![]};}}exports[a37_0x1c7fd4(0xb9)]=CoinToPayStatusService,exports[a37_0x1c7fd4(0x95)]=new CoinToPayStatusService();