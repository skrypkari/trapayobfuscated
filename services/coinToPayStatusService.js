'use strict';const a37_0x12143d=a37_0x2b62;(function(_0x3d62bd,_0x5311cb){const _0x18ffb6=a37_0x2b62,_0x447e4d=_0x3d62bd();while(!![]){try{const _0x665fb4=parseInt(_0x18ffb6(0x1b1))/0x1*(-parseInt(_0x18ffb6(0x130))/0x2)+parseInt(_0x18ffb6(0x1e3))/0x3*(parseInt(_0x18ffb6(0x176))/0x4)+-parseInt(_0x18ffb6(0x102))/0x5+-parseInt(_0x18ffb6(0x179))/0x6*(parseInt(_0x18ffb6(0x168))/0x7)+-parseInt(_0x18ffb6(0x19f))/0x8+parseInt(_0x18ffb6(0x10e))/0x9+parseInt(_0x18ffb6(0x16d))/0xa;if(_0x665fb4===_0x5311cb)break;else _0x447e4d['push'](_0x447e4d['shift']());}catch(_0x47ff8b){_0x447e4d['push'](_0x447e4d['shift']());}}}(a37_0x4042,0xab682));function a37_0x2b62(_0x3c8825,_0x48e31c){const _0x4042bf=a37_0x4042();return a37_0x2b62=function(_0x2b62a5,_0x3c9328){_0x2b62a5=_0x2b62a5-0x102;let _0x441c74=_0x4042bf[_0x2b62a5];return _0x441c74;},a37_0x2b62(_0x3c8825,_0x48e31c);}var __importDefault=this&&this[a37_0x12143d(0x188)]||function(_0x2df724){return _0x2df724&&_0x2df724['__esModule']?_0x2df724:{'default':_0x2df724};};Object[a37_0x12143d(0x193)](exports,a37_0x12143d(0x171),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x12143d(0x1b3)]=void 0x0;const coinToPayService_1=require(a37_0x12143d(0x146)),database_1=__importDefault(require(a37_0x12143d(0x145))),telegramBotService_1=require('./telegramBotService'),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x3cad99=a37_0x12143d;this[_0x3cad99(0x15d)]=null,this[_0x3cad99(0x1d7)]=0x3c*0x3c*0x3e8,this[_0x3cad99(0x12b)]=0x5,this[_0x3cad99(0x199)]=new Map(),this[_0x3cad99(0x14b)]=new coinToPayService_1['CoinToPayService'](),console[_0x3cad99(0x1e9)](_0x3cad99(0x19a));}['schedulePaymentChecks'](_0x47223b,_0x5aca02){const _0x2115c8=a37_0x12143d;console[_0x2115c8(0x1e9)]('🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console['log'](_0x2115c8(0x109)+_0x47223b),console['log'](_0x2115c8(0x16c)+_0x5aca02),this[_0x2115c8(0x12c)](_0x47223b);const _0x204f3c=[],_0x476209=new Date(),_0x58d7b0=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x2115c8(0x156)},{'delay':0x5*0x3c*0x3e8,'description':_0x2115c8(0x174)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x2115c8(0x1e9)](_0x2115c8(0x1c7)+_0x58d7b0[_0x2115c8(0x159)]+_0x2115c8(0x194)+_0x47223b);let _0x3f1546=0x0;_0x58d7b0[_0x2115c8(0x119)]((_0x17d82b,_0xcc185c)=>{const _0x53a5de=_0x2115c8;_0x3f1546+=_0x17d82b['delay'];const _0x1daf3d=setTimeout(async()=>{const _0x2c8f68=a37_0x2b62;console['log']('🪙\x20[TIMER]\x20Individual\x20check\x20#'+(_0xcc185c+0x1)+_0x2c8f68(0x169)+_0x47223b+_0x2c8f68(0x17d)+_0x17d82b['description']+')');try{await this[_0x2c8f68(0x150)](_0x47223b),console['log'](_0x2c8f68(0x141)+(_0xcc185c+0x1)+_0x2c8f68(0x184)+_0x47223b);}catch(_0x5f3ef0){console['error'](_0x2c8f68(0x1d6)+(_0xcc185c+0x1)+_0x2c8f68(0x191)+_0x47223b+':',_0x5f3ef0),this[_0x2c8f68(0x1a9)](_0x47223b,_0x5aca02,_0x5f3ef0,_0x2c8f68(0x1ad),{'checkNumber':_0xcc185c+0x1,'scheduledAfter':_0x17d82b[_0x2c8f68(0x182)],'isIndividualCheck':!![]});}},_0x3f1546);_0x204f3c[_0x53a5de(0x128)](_0x1daf3d),console[_0x53a5de(0x1e9)](_0x53a5de(0x157)+(_0xcc185c+0x1)+_0x53a5de(0x191)+_0x47223b+_0x53a5de(0x1b8)+_0x3f1546/0x3e8+_0x53a5de(0x1b9)+_0x17d82b[_0x53a5de(0x182)]+')');});const _0x480869=setInterval(async()=>{const _0x11dd83=_0x2115c8;console['log'](_0x11dd83(0x1ae)+_0x47223b);try{const _0x50cfe2=await database_1[_0x11dd83(0x172)][_0x11dd83(0x17f)]['findUnique']({'where':{'id':_0x47223b},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x50cfe2){console['log']('❌\x20[HOURLY]\x20Payment\x20'+_0x47223b+_0x11dd83(0x1c3)),this['clearPaymentTimers'](_0x47223b);return;}console['log'](_0x11dd83(0x1cd)+_0x47223b+_0x11dd83(0x180)+_0x50cfe2['status']);if(_0x50cfe2[_0x11dd83(0x1e2)]!=='PENDING'){console['log'](_0x11dd83(0x127)+_0x47223b+_0x11dd83(0x18a)+_0x50cfe2['status']+_0x11dd83(0x136)),this[_0x11dd83(0x12c)](_0x47223b);return;}const _0x388760=Math[_0x11dd83(0x110)]((Date[_0x11dd83(0x18f)]()-_0x50cfe2[_0x11dd83(0x1db)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x388760>=this[_0x11dd83(0x12b)]){console['log'](_0x11dd83(0x198)+_0x47223b+'\x20is\x20older\x20than\x20'+this[_0x11dd83(0x12b)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this['clearPaymentTimers'](_0x47223b);return;}await this['checkSinglePaymentById'](_0x47223b),console[_0x11dd83(0x1e9)](_0x11dd83(0x13c)+_0x47223b);}catch(_0xf92dab){console[_0x11dd83(0x1a4)](_0x11dd83(0x19e)+_0x47223b+':',_0xf92dab),this[_0x11dd83(0x1a9)](_0x47223b,_0x5aca02,_0xf92dab,_0x11dd83(0x1ad),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x204f3c[_0x2115c8(0x128)](_0x480869),this['paymentTimers']['set'](_0x47223b,{'timers':_0x204f3c,'paymentId':_0x47223b,'gatewayPaymentId':_0x5aca02,'createdAt':_0x476209}),console[_0x2115c8(0x1e9)](_0x2115c8(0x16a)+_0x58d7b0[_0x2115c8(0x159)]+_0x2115c8(0x1a2)+_0x47223b),console[_0x2115c8(0x1e9)](_0x2115c8(0x13b)+this[_0x2115c8(0x199)]['size']),this[_0x2115c8(0x1e4)](_0x47223b,_0x5aca02,'PENDING',_0x2115c8(0x144),_0x2115c8(0x1ad),{'action':'schedule_created','scheduledChecks':_0x58d7b0[_0x2115c8(0x159)],'firstCheckIn':_0x58d7b0[0x0][_0x2115c8(0x11f)]/0x3e8,'totalTimers':this['paymentTimers'][_0x2115c8(0x10a)]});}[a37_0x12143d(0x12c)](_0x38152c){const _0x55c977=a37_0x12143d,_0x464437=this[_0x55c977(0x199)][_0x55c977(0x165)](_0x38152c);_0x464437?(console[_0x55c977(0x1e9)](_0x55c977(0x10b)+_0x464437[_0x55c977(0x1e5)][_0x55c977(0x159)]+_0x55c977(0x1ac)+_0x38152c),_0x464437[_0x55c977(0x1e5)][_0x55c977(0x119)]((_0x3beed2,_0x2df15a)=>{const _0x149c17=_0x55c977;_0x3beed2&&(clearTimeout(_0x3beed2),clearInterval(_0x3beed2),console['log'](_0x149c17(0x19d)+(_0x2df15a+0x1)+_0x149c17(0x191)+_0x38152c));}),this['paymentTimers']['delete'](_0x38152c),console[_0x55c977(0x1e9)]('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x38152c+_0x55c977(0x117)+this[_0x55c977(0x199)]['size'])):console[_0x55c977(0x1e9)](_0x55c977(0x153)+_0x38152c+_0x55c977(0x12d));}async[a37_0x12143d(0x150)](_0x2c01af){const _0x155d06=a37_0x12143d;console[_0x155d06(0x1e9)](_0x155d06(0x178)+_0x2c01af);const _0x57eab5=await database_1['default'][_0x155d06(0x17f)][_0x155d06(0x1c1)]({'where':{'id':_0x2c01af},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x57eab5){console[_0x155d06(0x1e9)]('❌\x20[CHECK]\x20Payment\x20'+_0x2c01af+_0x155d06(0x187));return;}console[_0x155d06(0x1e9)](_0x155d06(0x1d0)+_0x2c01af+_0x155d06(0x13f)),console['log']('\x20\x20\x20-\x20Gateway:\x20'+_0x57eab5[_0x155d06(0x1a0)]),console['log'](_0x155d06(0x19c)+_0x57eab5[_0x155d06(0x1e2)]),console[_0x155d06(0x1e9)](_0x155d06(0x166)+_0x57eab5[_0x155d06(0x14f)]),console['log']('\x20\x20\x20-\x20Amount:\x20'+_0x57eab5['amount']+'\x20'+_0x57eab5[_0x155d06(0x1d5)]),console[_0x155d06(0x1e9)](_0x155d06(0x1b6)+_0x57eab5[_0x155d06(0x19b)]);if(_0x57eab5[_0x155d06(0x1a0)]!==_0x155d06(0x149)){console[_0x155d06(0x1e9)](_0x155d06(0x186)+_0x2c01af+_0x155d06(0x103)+_0x57eab5[_0x155d06(0x1a0)]+')');return;}if(_0x57eab5[_0x155d06(0x1e2)]!==_0x155d06(0x144)){console['log'](_0x155d06(0x186)+_0x2c01af+'\x20status\x20is\x20'+_0x57eab5[_0x155d06(0x1e2)]+_0x155d06(0x136)),this['clearPaymentTimers'](_0x2c01af);return;}if(!_0x57eab5[_0x155d06(0x14f)]){console['log'](_0x155d06(0x186)+_0x2c01af+_0x155d06(0x17e));return;}console[_0x155d06(0x1e9)](_0x155d06(0x1da)+_0x2c01af+_0x155d06(0x126)),await this[_0x155d06(0x12f)](_0x57eab5);}[a37_0x12143d(0x1e4)](_0x22cf3e,_0x510dee,_0x12fb0c,_0x1daa41,_0x6d8800,_0x1064b8){const _0x5f2356=a37_0x12143d,_0x1e4da9={'type':_0x5f2356(0x167),'paymentId':_0x22cf3e,'gatewayPaymentId':_0x510dee,'oldStatus':_0x12fb0c,'newStatus':_0x1daa41,'source':_0x6d8800,'timestamp':new Date()[_0x5f2356(0x104)](),'details':_0x1064b8||{}};loggerService_1[_0x5f2356(0x163)][_0x5f2356(0x1e4)](_0x1e4da9),console[_0x5f2356(0x1e9)](_0x5f2356(0x15e)+_0x22cf3e+'\x20('+_0x510dee+')'),console[_0x5f2356(0x1e9)]('\x20\x20\x20📊\x20Status:\x20'+_0x12fb0c+_0x5f2356(0x124)+_0x1daa41),console[_0x5f2356(0x1e9)](_0x5f2356(0x1a7)+_0x6d8800),console[_0x5f2356(0x1e9)](_0x5f2356(0x1de)+_0x1e4da9['timestamp']),_0x1064b8&&console['log'](_0x5f2356(0x10c),_0x1064b8);}['logCoinToPayError'](_0x27534a,_0x66416,_0x47f1bf,_0x541202,_0x38a95a){const _0x150aaa=a37_0x12143d,_0x14b9ac={'type':_0x150aaa(0x1c4),'paymentId':_0x27534a,'gatewayPaymentId':_0x66416,'error':_0x47f1bf instanceof Error?{'message':_0x47f1bf[_0x150aaa(0x162)],'stack':_0x47f1bf['stack']}:_0x47f1bf,'source':_0x541202,'timestamp':new Date()['toISOString'](),'context':_0x38a95a||{}};loggerService_1[_0x150aaa(0x163)][_0x150aaa(0x1a9)](_0x14b9ac),console['error']('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x27534a+'\x20('+_0x66416+')'),console[_0x150aaa(0x1a4)](_0x150aaa(0x1c6)+(_0x47f1bf instanceof Error?_0x47f1bf[_0x150aaa(0x162)]:_0x47f1bf)),console['error'](_0x150aaa(0x1a7)+_0x541202),console[_0x150aaa(0x1a4)](_0x150aaa(0x1de)+_0x14b9ac[_0x150aaa(0x1c5)]),_0x38a95a&&console['error'](_0x150aaa(0x133),_0x38a95a);}[a37_0x12143d(0x1dc)](){const _0x37c5b5=a37_0x12143d;console['log'](_0x37c5b5(0x1b7)),this[_0x37c5b5(0x14c)]()[_0x37c5b5(0x143)](_0x3e6b26=>{const _0x32053a=_0x37c5b5;console['error'](_0x32053a(0x170),_0x3e6b26);}),this[_0x37c5b5(0x15d)]=setInterval(async()=>{const _0x10c573=_0x37c5b5;try{console['log'](_0x10c573(0x125)),await this[_0x10c573(0x14c)](),console['log'](_0x10c573(0x17c));}catch(_0x5009bc){console[_0x10c573(0x1a4)](_0x10c573(0x112),_0x5009bc);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x37c5b5(0x1e9)](_0x37c5b5(0x105));}['stopPeriodicStatusCheck'](){const _0x1f2b7b=a37_0x12143d;console[_0x1f2b7b(0x1e9)](_0x1f2b7b(0x15b));this[_0x1f2b7b(0x15d)]&&(clearInterval(this[_0x1f2b7b(0x15d)]),this[_0x1f2b7b(0x15d)]=null,console[_0x1f2b7b(0x1e9)](_0x1f2b7b(0x1a1)));const _0x31143c=this[_0x1f2b7b(0x199)][_0x1f2b7b(0x10a)];for(const [_0x1cb9a8]of this['paymentTimers']){this[_0x1f2b7b(0x12c)](_0x1cb9a8);}console[_0x1f2b7b(0x1e9)](_0x1f2b7b(0x132)+_0x31143c+'\x20individual\x20payment\x20timers');}async[a37_0x12143d(0x14c)](){const _0x32a10d=a37_0x12143d;try{console[_0x32a10d(0x1e9)](_0x32a10d(0x1d2));const _0x2ace75=await database_1[_0x32a10d(0x172)]['payment'][_0x32a10d(0x10d)]({'where':{'gateway':_0x32a10d(0x149),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x32a10d(0x1e9)](_0x32a10d(0x108)+_0x2ace75[_0x32a10d(0x159)]+'\x20pending\x20CoinToPay\x20payments');if(_0x2ace75[_0x32a10d(0x159)]===0x0){console['log']('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x95e6e2=await this[_0x32a10d(0x18c)](_0x2ace75);console['log']('⏰\x20[GLOBAL]\x20Found\x20'+_0x95e6e2['length']+_0x32a10d(0x15f));let _0x409892=0x0,_0x54cced=0x0;for(const _0x1a5e36 of _0x2ace75){try{if(_0x95e6e2['includes'](_0x1a5e36['id'])){console['log'](_0x32a10d(0x113)+_0x1a5e36['id']+_0x32a10d(0x1bf)),_0x54cced++;continue;}if(this[_0x32a10d(0x199)][_0x32a10d(0x1a8)](_0x1a5e36['id'])){console[_0x32a10d(0x1e9)](_0x32a10d(0x113)+_0x1a5e36['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x54cced++;continue;}const _0x38aa28=(Date[_0x32a10d(0x18f)]()-_0x1a5e36['createdAt'][_0x32a10d(0x181)]())/(0x3e8*0x3c*0x3c);if(_0x38aa28<0x1){console[_0x32a10d(0x1e9)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x1a5e36['id']+'\x20is\x20too\x20new\x20('+_0x38aa28[_0x32a10d(0x1bc)](0x1)+'h),\x20skipping\x20global\x20check'),_0x54cced++;continue;}console[_0x32a10d(0x1e9)](_0x32a10d(0x140)+_0x1a5e36['id']+_0x32a10d(0x1cc)+_0x38aa28['toFixed'](0x1)+'h)'),await this[_0x32a10d(0x12f)](_0x1a5e36),_0x409892++,await new Promise(_0x8c241b=>setTimeout(_0x8c241b,0x7d0));}catch(_0x37f735){console[_0x32a10d(0x1a4)](_0x32a10d(0x123)+_0x1a5e36['id']+':',_0x37f735),this['logCoinToPayError'](_0x1a5e36['id'],_0x1a5e36[_0x32a10d(0x14f)]||_0x32a10d(0x1ce),_0x37f735,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x1a5e36[_0x32a10d(0x1b0)],'paymentCurrency':_0x1a5e36[_0x32a10d(0x1d5)],'shopId':_0x1a5e36[_0x32a10d(0x19b)],'createdAt':_0x1a5e36[_0x32a10d(0x1db)]}),loggerService_1[_0x32a10d(0x163)][_0x32a10d(0x116)](_0x32a10d(0x149),_0x32a10d(0x11e)+_0x1a5e36['gatewayPaymentId'],_0x37f735);}}console[_0x32a10d(0x1e9)](_0x32a10d(0x139)+_0x409892+'\x20checked,\x20'+_0x54cced+_0x32a10d(0x11a)+_0x95e6e2[_0x32a10d(0x159)]+_0x32a10d(0x118));}catch(_0xcef04c){console[_0x32a10d(0x1a4)](_0x32a10d(0x164),_0xcef04c);}}async['checkExpiredPayments'](_0x323ec4){const _0x2fc4e9=a37_0x12143d,_0x28b9e2=[],_0x541907=new Date();_0x541907[_0x2fc4e9(0x13d)](_0x541907[_0x2fc4e9(0x154)]()-this[_0x2fc4e9(0x12b)]),console[_0x2fc4e9(0x1e9)](_0x2fc4e9(0x18e)+this[_0x2fc4e9(0x12b)]+'\x20days\x20(created\x20before\x20'+_0x541907[_0x2fc4e9(0x104)]()+')');for(const _0x57fc0d of _0x323ec4){if(_0x57fc0d[_0x2fc4e9(0x1db)]<_0x541907){console['log'](_0x2fc4e9(0x121)+_0x57fc0d['id']+_0x2fc4e9(0x1dd)+this[_0x2fc4e9(0x12b)]+_0x2fc4e9(0x138));try{this['logCoinToPayStatus'](_0x57fc0d['id'],_0x57fc0d[_0x2fc4e9(0x14f)]||'unknown',_0x2fc4e9(0x144),_0x2fc4e9(0x1aa),'auto_expire',{'reason':'Payment\x20older\x20than\x20'+this[_0x2fc4e9(0x12b)]+_0x2fc4e9(0x1e6),'createdAt':_0x57fc0d[_0x2fc4e9(0x1db)],'daysSinceCreation':Math[_0x2fc4e9(0x110)]((Date['now']()-_0x57fc0d[_0x2fc4e9(0x1db)][_0x2fc4e9(0x181)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x57fc0d[_0x2fc4e9(0x1b0)],'paymentCurrency':_0x57fc0d[_0x2fc4e9(0x1d5)],'shopId':_0x57fc0d[_0x2fc4e9(0x19b)]}),await database_1[_0x2fc4e9(0x172)][_0x2fc4e9(0x17f)]['update']({'where':{'id':_0x57fc0d['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x2fc4e9(0x14a)+this[_0x2fc4e9(0x12b)]+_0x2fc4e9(0x13a)}}),await database_1['default'][_0x2fc4e9(0x148)][_0x2fc4e9(0x1c0)]({'data':{'paymentId':_0x57fc0d['id'],'shopId':_0x57fc0d[_0x2fc4e9(0x19b)],'event':_0x2fc4e9(0x134),'statusCode':0xc8,'responseBody':JSON[_0x2fc4e9(0x196)]({'reason':'Payment\x20older\x20than\x20'+this['EXPIRY_DAYS']+_0x2fc4e9(0x1e6),'createdAt':_0x57fc0d[_0x2fc4e9(0x1db)],'expiredAt':new Date()[_0x2fc4e9(0x104)](),'daysSinceCreation':Math[_0x2fc4e9(0x110)]((Date[_0x2fc4e9(0x18f)]()-_0x57fc0d[_0x2fc4e9(0x1db)][_0x2fc4e9(0x181)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x57fc0d,'EXPIRED'),await this[_0x2fc4e9(0x190)](_0x57fc0d,'EXPIRED'),this[_0x2fc4e9(0x12c)](_0x57fc0d['id']),_0x28b9e2[_0x2fc4e9(0x128)](_0x57fc0d['id']),console[_0x2fc4e9(0x1e9)](_0x2fc4e9(0x1e8)+_0x57fc0d['id']+_0x2fc4e9(0x16f)+this['EXPIRY_DAYS']+_0x2fc4e9(0x114));}catch(_0x5262ec){console[_0x2fc4e9(0x1a4)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x57fc0d['id']+':',_0x5262ec),this[_0x2fc4e9(0x1a9)](_0x57fc0d['id'],_0x57fc0d[_0x2fc4e9(0x14f)]||'unknown',_0x5262ec,_0x2fc4e9(0x1d9),{'reason':_0x2fc4e9(0x12e),'createdAt':_0x57fc0d['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x2fc4e9(0x18f)]()-_0x57fc0d[_0x2fc4e9(0x1db)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x28b9e2;}async['checkSinglePayment'](_0x44473f){const _0x5e4d31=a37_0x12143d;if(!_0x44473f[_0x5e4d31(0x14f)]){console['log'](_0x5e4d31(0x186)+_0x44473f['id']+_0x5e4d31(0x158));return;}console[_0x5e4d31(0x1e9)](_0x5e4d31(0x111)+_0x44473f['id']+'\x20('+_0x44473f[_0x5e4d31(0x14f)]+')');try{const _0x325256=await this[_0x5e4d31(0x14b)]['checkPaymentStatus'](_0x44473f['gatewayPaymentId']);console[_0x5e4d31(0x1e9)]('📊\x20[CHECK]\x20Payment\x20'+_0x44473f['id']+_0x5e4d31(0x161)+_0x325256['status']);_0x325256[_0x5e4d31(0x106)]&&console[_0x5e4d31(0x1e9)](_0x5e4d31(0x1d0)+_0x44473f['id']+_0x5e4d31(0x14d),{'iban':_0x325256[_0x5e4d31(0x106)]['iban']||'not\x20found','transactionId':_0x325256['paymentDetails'][_0x5e4d31(0x16e)],'createdOn':_0x325256[_0x5e4d31(0x106)][_0x5e4d31(0x142)],'confirmedOn':_0x325256['paymentDetails'][_0x5e4d31(0x15c)]||_0x5e4d31(0x1cf)});if(_0x325256[_0x5e4d31(0x1e2)]!==_0x44473f[_0x5e4d31(0x1e2)]){console[_0x5e4d31(0x1e9)](_0x5e4d31(0x131)+_0x44473f['id']+'\x20status\x20from\x20'+_0x44473f[_0x5e4d31(0x1e2)]+'\x20to\x20'+_0x325256[_0x5e4d31(0x1e2)]),this[_0x5e4d31(0x1e4)](_0x44473f['id'],_0x44473f[_0x5e4d31(0x14f)],_0x44473f['status'],_0x325256[_0x5e4d31(0x1e2)],_0x5e4d31(0x1ad),{'paymentDetails':_0x325256[_0x5e4d31(0x106)],'amount':_0x325256[_0x5e4d31(0x1b0)],'currency':_0x325256[_0x5e4d31(0x1d5)],'shopId':_0x44473f[_0x5e4d31(0x19b)],'checkTimestamp':new Date()[_0x5e4d31(0x104)]()});const _0x2e8436={'status':_0x325256[_0x5e4d31(0x1e2)],'updatedAt':new Date()};_0x325256[_0x5e4d31(0x1e2)]===_0x5e4d31(0x18d)&&_0x44473f[_0x5e4d31(0x1e2)]!=='PAID'&&(_0x2e8436[_0x5e4d31(0x10f)]=new Date(),console[_0x5e4d31(0x1e9)](_0x5e4d31(0x1e1)+_0x44473f['id']+_0x5e4d31(0x192)+_0x2e8436[_0x5e4d31(0x10f)][_0x5e4d31(0x104)]()));if(_0x325256[_0x5e4d31(0x106)]){const _0x2a8f40=_0x325256[_0x5e4d31(0x106)];_0x2a8f40[_0x5e4d31(0x107)]&&(_0x2e8436['remitterIban']=_0x2a8f40[_0x5e4d31(0x107)],console[_0x5e4d31(0x1e9)](_0x5e4d31(0x1bb)+_0x2a8f40[_0x5e4d31(0x107)]));if(_0x2a8f40[_0x5e4d31(0x1a3)]){const _0x3c7888=_0x44473f[_0x5e4d31(0x122)]||'',_0x3247c3=_0x5e4d31(0x1ba)+_0x2a8f40[_0x5e4d31(0x1a3)];_0x2e8436[_0x5e4d31(0x122)]=_0x3c7888?_0x3c7888+'\x0a\x0a'+_0x3247c3:_0x3247c3,console[_0x5e4d31(0x1e9)](_0x5e4d31(0x135));}_0x2a8f40[_0x5e4d31(0x16e)]&&console['log'](_0x5e4d31(0x1d4)+_0x2a8f40[_0x5e4d31(0x16e)]),_0x2a8f40['confirmedOn']&&console['log'](_0x5e4d31(0x1af)+_0x2a8f40[_0x5e4d31(0x15c)]);}await database_1['default'][_0x5e4d31(0x17f)][_0x5e4d31(0x1c2)]({'where':{'id':_0x44473f['id']},'data':_0x2e8436}),await database_1[_0x5e4d31(0x172)][_0x5e4d31(0x148)][_0x5e4d31(0x1c0)]({'data':{'paymentId':_0x44473f['id'],'shopId':_0x44473f[_0x5e4d31(0x19b)],'event':_0x5e4d31(0x1b5)+_0x325256[_0x5e4d31(0x1e2)][_0x5e4d31(0x120)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x44473f[_0x5e4d31(0x1e2)],'newStatus':_0x325256['status'],'paymentDetails':_0x325256['paymentDetails'],'checkedAt':new Date()[_0x5e4d31(0x104)]()})}}),await this[_0x5e4d31(0x11c)](_0x44473f,_0x325256['status']),await this[_0x5e4d31(0x190)](_0x44473f,_0x325256['status']),_0x325256['status']!==_0x5e4d31(0x144)&&(console[_0x5e4d31(0x1e9)]('🧹\x20[CHECK]\x20Payment\x20'+_0x44473f['id']+'\x20status\x20changed\x20to\x20'+_0x325256[_0x5e4d31(0x1e2)]+_0x5e4d31(0x1d8)),this[_0x5e4d31(0x12c)](_0x44473f['id'])),console[_0x5e4d31(0x1e9)](_0x5e4d31(0x1da)+_0x44473f['id']+'\x20updated\x20successfully');}else console[_0x5e4d31(0x1e9)](_0x5e4d31(0x1d0)+_0x44473f['id']+_0x5e4d31(0x152)+_0x325256[_0x5e4d31(0x1e2)]+')'),this[_0x5e4d31(0x1e4)](_0x44473f['id'],_0x44473f[_0x5e4d31(0x14f)],_0x44473f['status'],_0x325256[_0x5e4d31(0x1e2)],_0x5e4d31(0x1ad),{'statusUnchanged':!![],'paymentDetails':_0x325256[_0x5e4d31(0x106)],'amount':_0x325256[_0x5e4d31(0x1b0)],'currency':_0x325256[_0x5e4d31(0x1d5)],'shopId':_0x44473f[_0x5e4d31(0x19b)],'checkTimestamp':new Date()[_0x5e4d31(0x104)]()});}catch(_0x30a387){console[_0x5e4d31(0x1a4)](_0x5e4d31(0x197)+_0x44473f['id']+':',_0x30a387),this[_0x5e4d31(0x1a9)](_0x44473f['id'],_0x44473f[_0x5e4d31(0x14f)],_0x30a387,_0x5e4d31(0x1ad),{'paymentAmount':_0x44473f['amount'],'paymentCurrency':_0x44473f[_0x5e4d31(0x1d5)],'shopId':_0x44473f['shopId'],'createdAt':_0x44473f[_0x5e4d31(0x1db)]}),await database_1[_0x5e4d31(0x172)][_0x5e4d31(0x148)]['create']({'data':{'paymentId':_0x44473f['id'],'shopId':_0x44473f[_0x5e4d31(0x19b)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x5e4d31(0x196)]({'error':_0x30a387 instanceof Error?_0x30a387[_0x5e4d31(0x162)]:'Unknown\x20error','gatewayPaymentId':_0x44473f[_0x5e4d31(0x14f)],'checkedAt':new Date()[_0x5e4d31(0x104)]()})}});}}async[a37_0x12143d(0x11c)](_0x30cd39,_0x1da8d5){const _0x112c39=a37_0x12143d,_0x4e9980=Date[_0x112c39(0x18f)]();try{const _0x32e3e1=_0x30cd39[_0x112c39(0x11b)],_0x3c5f91=_0x32e3e1[_0x112c39(0x15a)];if(!_0x3c5f91?.[_0x112c39(0x1b4)]){console[_0x112c39(0x1e9)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x32e3e1['id']);return;}const _0x5ec3a9=_0x1da8d5===_0x112c39(0x18d)?_0x112c39(0x137):_0x1da8d5===_0x112c39(0x189)?_0x112c39(0x1e7):_0x1da8d5==='EXPIRED'?_0x112c39(0x1e7):_0x112c39(0x17b);if(!_0x3c5f91[_0x112c39(0x155)]?.[_0x112c39(0x14e)](_0x5ec3a9)){console[_0x112c39(0x1e9)](_0x112c39(0x177)+_0x5ec3a9+_0x112c39(0x1bd)+_0x32e3e1['id']);return;}const _0x80e32d={'event':_0x5ec3a9,'payment':{'id':_0x30cd39['id'],'order_id':_0x30cd39['orderId'],'gateway_order_id':_0x30cd39[_0x112c39(0x1ab)],'gateway':_0x112c39(0x1cb),'amount':_0x30cd39[_0x112c39(0x1b0)],'currency':_0x30cd39['currency'],'status':_0x1da8d5[_0x112c39(0x120)](),'customer_email':_0x30cd39[_0x112c39(0x183)],'customer_name':_0x30cd39['customerName'],'created_at':_0x30cd39[_0x112c39(0x1db)],'updated_at':new Date()}},_0x3acad2=await fetch(_0x3c5f91['webhookUrl'],{'method':_0x112c39(0x1e0),'headers':{'Content-Type':_0x112c39(0x18b),'User-Agent':'TesSoft\x20Payment\x20System/1.0'},'body':JSON[_0x112c39(0x196)](_0x80e32d)}),_0x11e006=Date[_0x112c39(0x18f)]()-_0x4e9980,_0x4fcdff=_0x3acad2['ok']?_0x112c39(0x1ca):await _0x3acad2[_0x112c39(0x175)]();loggerService_1[_0x112c39(0x163)][_0x112c39(0x185)](_0x30cd39['shopId'],_0x3c5f91[_0x112c39(0x1b4)],_0x5ec3a9,_0x3acad2['status'],_0x11e006,_0x80e32d),console[_0x112c39(0x1e9)](_0x112c39(0x17a)+_0x3c5f91['webhookUrl']+_0x112c39(0x1a6)+_0x3acad2[_0x112c39(0x1e2)]+'\x20('+_0x11e006+_0x112c39(0x13e));}catch(_0x27a5d2){console[_0x112c39(0x1a4)]('Failed\x20to\x20send\x20shop\x20webhook:',_0x27a5d2),loggerService_1[_0x112c39(0x163)][_0x112c39(0x1b2)](_0x30cd39[_0x112c39(0x19b)],_0x30cd39[_0x112c39(0x11b)]?.[_0x112c39(0x15a)]?.['webhookUrl']||_0x112c39(0x1ce),_0x112c39(0x151),_0x27a5d2,{});}}async[a37_0x12143d(0x190)](_0x37d51d,_0x56206c){const _0x180eeb=a37_0x12143d;try{const _0x203a72={'PENDING':_0x180eeb(0x1d3),'PAID':_0x180eeb(0x195),'FAILED':'failed','EXPIRED':'expired'},_0x3f8f4a=_0x203a72[_0x56206c];if(!_0x3f8f4a||_0x3f8f4a==='created')return;await telegramBotService_1[_0x180eeb(0x147)][_0x180eeb(0x129)](_0x37d51d['shopId'],_0x37d51d,_0x3f8f4a);}catch(_0x18fa87){console[_0x180eeb(0x1a4)](_0x180eeb(0x1be),_0x18fa87);}}async[a37_0x12143d(0x1d1)](_0x2396b2){const _0x1d154e=a37_0x12143d;console[_0x1d154e(0x1e9)](_0x1d154e(0x11d)+_0x2396b2);const _0x112734=await database_1[_0x1d154e(0x172)][_0x1d154e(0x17f)][_0x1d154e(0x1c1)]({'where':{'id':_0x2396b2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x112734)throw new Error(_0x1d154e(0x160));if(_0x112734[_0x1d154e(0x1a0)]!==_0x1d154e(0x149))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x1d154e(0x1e9)](_0x1d154e(0x1a5)+_0x2396b2),await this[_0x1d154e(0x12f)](_0x112734),console[_0x1d154e(0x1e9)](_0x1d154e(0x1c8)+_0x2396b2);}[a37_0x12143d(0x1df)](){const _0x14fa55=a37_0x12143d,_0x381e91=this[_0x14fa55(0x15d)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x22577e=Array[_0x14fa55(0x1c9)](this['paymentTimers'][_0x14fa55(0x115)]())[_0x14fa55(0x12a)](_0x3877e8=>({'paymentId':_0x3877e8[_0x14fa55(0x173)],'gatewayPaymentId':_0x3877e8[_0x14fa55(0x14f)],'createdAt':_0x3877e8[_0x14fa55(0x1db)],'timersCount':_0x3877e8['timers'][_0x14fa55(0x159)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x14fa55(0x1d7)]/(0x3e8*0x3c),'expiryDays':this[_0x14fa55(0x12b)],'activeIndividualTimers':this[_0x14fa55(0x199)]['size'],'nextGlobalCheckIn':_0x381e91,'paymentTimersDetails':_0x22577e};}[a37_0x12143d(0x16b)](_0x50d334){const _0x7fe756=a37_0x12143d,_0x427f61=this[_0x7fe756(0x199)]['get'](_0x50d334);if(_0x427f61)return{'hasTimers':!![],'timersCount':_0x427f61[_0x7fe756(0x1e5)][_0x7fe756(0x159)],'createdAt':_0x427f61[_0x7fe756(0x1db)],'gatewayPaymentId':_0x427f61['gatewayPaymentId']};return{'hasTimers':![]};}}function a37_0x4042(){const _0x5e8363=['🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes',',\x20stopping\x20individual\x20checks','payment.success','\x20days,\x20marking\x20as\x20EXPIRED','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20days\x20without\x20payment\x20confirmation','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','setDate','ms)','\x20found:','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','createdOn','catch','PENDING','../config/database','./gateways/coinToPayService','telegramBotService','webhookLog','cointopay','Automatically\x20expired\x20after\x20','coinToPayService','checkAllPendingPayments','\x20details:','includes','gatewayPaymentId','checkSinglePaymentById','webhook_send','\x20status\x20unchanged\x20(','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getDate','webhookEvents','2\x20minutes','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','\x20has\x20no\x20gatewayPaymentId,\x20skipping','length','settings','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','confirmedOn','globalCheckInterval','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20expired\x20CoinToPay\x20payments','Payment\x20not\x20found','\x20status:\x20','message','loggerService','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','get','\x20\x20\x20-\x20GatewayPaymentId:\x20','COINTOPAY_STATUS_CHANGE','7fwgSTK','\x20triggered\x20for\x20payment\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','getPaymentTimerInfo','\x20\x20\x20-\x20gatewayPaymentId:\x20','47003770zVFvHH','transactionId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','__esModule','default','paymentId','5\x20minutes','text','436OzDIKF','Webhook\x20event\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','7481346JoSVyp','Shop\x20webhook\x20sent\x20to\x20','payment.pending','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','\x20(after\x20','\x20has\x20no\x20gatewayPaymentId','payment','\x20current\x20status:\x20','getTime','description','customerEmail','\x20completed\x20for\x20payment\x20','logShopWebhookSent','⚠️\x20[CHECK]\x20Payment\x20','\x20not\x20found\x20in\x20database','__importDefault','FAILED','\x20status\x20is\x20','application/json','checkExpiredPayments','PAID','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','now','sendPaymentStatusNotification','\x20for\x20payment\x20','\x20marked\x20as\x20paid\x20at:\x20','defineProperty','\x20initial\x20timers\x20for\x20payment\x20','paid','stringify','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','⏰\x20[HOURLY]\x20Payment\x20','paymentTimers','🪙\x20CoinToPayStatusService\x20initialized','shopId','\x20\x20\x20-\x20Status:\x20','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','5212648zDRBba','gateway','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','bankDetails','error','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','\x20with\x20status\x20','\x20\x20\x20📍\x20Source:\x20','has','logCoinToPayError','EXPIRED','gatewayOrderId','\x20timers\x20for\x20payment\x20','status_check','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','amount','1CAHYXc','logShopWebhookError','CoinToPayStatusService','webhookUrl','cointopay_status_check_','\x20\x20\x20-\x20ShopId:\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20in\x20','\x20seconds\x20(','Bank\x20Details:\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','toFixed','\x20not\x20enabled\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','create','findUnique','update','\x20not\x20found,\x20clearing\x20timers','COINTOPAY_ERROR','timestamp','\x20\x20\x20❌\x20Error:\x20','🪙\x20[DEBUG]\x20Creating\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','from','Success','0100','\x20(age:\x20','📊\x20[HOURLY]\x20Payment\x20','unknown','not\x20confirmed','📊\x20[CHECK]\x20Payment\x20','checkPaymentById','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','created','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','currency','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','GLOBAL_CHECK_INTERVAL_MS',',\x20clearing\x20individual\x20timers','auto_expire','✅\x20[CHECK]\x20Payment\x20','createdAt','startPeriodicStatusCheck','\x20is\x20older\x20than\x20','\x20\x20\x20📅\x20Time:\x20','getServiceStats','POST','💰\x20[CHECK]\x20Payment\x20','status','123imEgzi','logCoinToPayStatus','timers','\x20days','payment.failed','✅\x20[EXPIRY]\x20Payment\x20','log','6978320xlvxGW','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','toISOString','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','paymentDetails','iban','🪙\x20[GLOBAL]\x20Found\x20','\x20\x20\x20-\x20paymentId:\x20','size','🧹\x20[DEBUG]\x20Clearing\x20','\x20\x20\x20📝\x20Details:','findMany','2240325HLuUYP','paidAt','floor','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','⏰\x20[GLOBAL]\x20Payment\x20','-day\x20timeout','values','logWhiteDomainError','.\x20Remaining\x20active\x20timers:\x20','\x20expired','forEach','\x20skipped,\x20','shop','sendShopWebhook','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','/status/','delay','toLowerCase','⏰\x20[EXPIRY]\x20Payment\x20','adminNotes','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20->\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','\x20is\x20valid\x20for\x20checking,\x20proceeding...','✅\x20[HOURLY]\x20Payment\x20','push','sendPaymentNotification','map','EXPIRY_DAYS','clearPaymentTimers','\x20to\x20clear','Failed\x20to\x20mark\x20payment\x20as\x20expired','checkSinglePayment','1915106QrsTPL','🔄\x20[CHECK]\x20Updating\x20payment\x20','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20\x20\x20📝\x20Context:','cointopay_auto_expired'];a37_0x4042=function(){return _0x5e8363;};return a37_0x4042();}exports['CoinToPayStatusService']=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();