'use strict';const a37_0x4b9066=a37_0x2f48;(function(_0x43b000,_0x868942){const _0x559f0c=a37_0x2f48,_0x3e088b=_0x43b000();while(!![]){try{const _0x50a055=-parseInt(_0x559f0c(0x1a8))/0x1*(-parseInt(_0x559f0c(0x10a))/0x2)+-parseInt(_0x559f0c(0xd4))/0x3+-parseInt(_0x559f0c(0x10f))/0x4*(-parseInt(_0x559f0c(0x192))/0x5)+parseInt(_0x559f0c(0x19b))/0x6*(parseInt(_0x559f0c(0x19d))/0x7)+-parseInt(_0x559f0c(0x194))/0x8+-parseInt(_0x559f0c(0x13b))/0x9*(parseInt(_0x559f0c(0x163))/0xa)+-parseInt(_0x559f0c(0x181))/0xb;if(_0x50a055===_0x868942)break;else _0x3e088b['push'](_0x3e088b['shift']());}catch(_0x1778de){_0x3e088b['push'](_0x3e088b['shift']());}}}(a37_0x1e81,0x52729));function a37_0x2f48(_0x14da0b,_0x54b821){const _0x1e81dc=a37_0x1e81();return a37_0x2f48=function(_0x2f4845,_0x4aee44){_0x2f4845=_0x2f4845-0xcf;let _0xfbe428=_0x1e81dc[_0x2f4845];return _0xfbe428;},a37_0x2f48(_0x14da0b,_0x54b821);}var __importDefault=this&&this[a37_0x4b9066(0x100)]||function(_0xea1579){const _0x404c49=a37_0x4b9066;return _0xea1579&&_0xea1579[_0x404c49(0x142)]?_0xea1579:{'default':_0xea1579};};Object[a37_0x4b9066(0xe1)](exports,a37_0x4b9066(0x142),{'value':!![]}),exports['coinToPayStatusService']=exports[a37_0x4b9066(0xdd)]=void 0x0;const coinToPayService_1=require(a37_0x4b9066(0x1af)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x4b9066(0xd0)),loggerService_1=require(a37_0x4b9066(0x144));class CoinToPayStatusService{constructor(){const _0x4ab529=a37_0x4b9066;this[_0x4ab529(0x15e)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x4ab529(0x119)]=new Map(),this[_0x4ab529(0x17c)]=new coinToPayService_1[(_0x4ab529(0xf3))](),console[_0x4ab529(0x138)](_0x4ab529(0xd2));}['schedulePaymentChecks'](_0x240e78,_0x186b28){const _0x1fde83=a37_0x4b9066;console[_0x1fde83(0x138)](_0x1fde83(0xe8)),console['log']('\x20\x20\x20-\x20paymentId:\x20'+_0x240e78),console[_0x1fde83(0x138)](_0x1fde83(0x110)+_0x186b28),this['clearPaymentTimers'](_0x240e78);const _0x340564=[],_0x546de9=new Date(),_0x325468=[{'delay':0x1*0x3c*0x3e8,'description':_0x1fde83(0x178)},{'delay':0x2*0x3c*0x3e8,'description':_0x1fde83(0x16e)},{'delay':0x5*0x3c*0x3e8,'description':_0x1fde83(0x153)},{'delay':0x5*0x3c*0x3e8,'description':_0x1fde83(0x153)}];console[_0x1fde83(0x138)](_0x1fde83(0x106)+_0x325468[_0x1fde83(0x147)]+_0x1fde83(0x159)+_0x240e78);let _0x5503b4=0x0;_0x325468[_0x1fde83(0x11e)]((_0x9e537b,_0x4cce18)=>{const _0x3d7591=_0x1fde83;_0x5503b4+=_0x9e537b[_0x3d7591(0x164)];const _0x5604d5=setTimeout(async()=>{const _0x2bc123=_0x3d7591;console[_0x2bc123(0x138)](_0x2bc123(0x152)+(_0x4cce18+0x1)+_0x2bc123(0xd7)+_0x240e78+'\x20(after\x20'+_0x9e537b[_0x2bc123(0x135)]+')');try{await this[_0x2bc123(0x14c)](_0x240e78),console['log'](_0x2bc123(0x1b2)+(_0x4cce18+0x1)+_0x2bc123(0x183)+_0x240e78);}catch(_0x3a6924){console[_0x2bc123(0x19c)](_0x2bc123(0x1a0)+(_0x4cce18+0x1)+'\x20for\x20payment\x20'+_0x240e78+':',_0x3a6924),this[_0x2bc123(0x141)](_0x240e78,_0x186b28,_0x3a6924,_0x2bc123(0xeb),{'checkNumber':_0x4cce18+0x1,'scheduledAfter':_0x9e537b[_0x2bc123(0x135)],'isIndividualCheck':!![]});}},_0x5503b4);_0x340564[_0x3d7591(0x15c)](_0x5604d5),console['log'](_0x3d7591(0xea)+(_0x4cce18+0x1)+'\x20for\x20payment\x20'+_0x240e78+_0x3d7591(0x12a)+_0x5503b4/0x3e8+_0x3d7591(0x1ad)+_0x9e537b[_0x3d7591(0x135)]+')');});const _0xfdb255=setInterval(async()=>{const _0x4feebc=_0x1fde83;console[_0x4feebc(0x138)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x240e78);try{const _0x36151e=await database_1[_0x4feebc(0xf9)][_0x4feebc(0x162)][_0x4feebc(0x189)]({'where':{'id':_0x240e78},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x36151e){console[_0x4feebc(0x138)](_0x4feebc(0x17d)+_0x240e78+_0x4feebc(0x166)),this[_0x4feebc(0xfb)](_0x240e78);return;}console[_0x4feebc(0x138)](_0x4feebc(0xfc)+_0x240e78+'\x20current\x20status:\x20'+_0x36151e[_0x4feebc(0x15d)]);if(_0x36151e['status']!==_0x4feebc(0x184)){console[_0x4feebc(0x138)]('✅\x20[HOURLY]\x20Payment\x20'+_0x240e78+_0x4feebc(0x108)+_0x36151e[_0x4feebc(0x15d)]+_0x4feebc(0x140)),this['clearPaymentTimers'](_0x240e78);return;}const _0x3debeb=Math[_0x4feebc(0x11a)]((Date[_0x4feebc(0xdc)]()-_0x36151e[_0x4feebc(0x12e)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x3debeb>=this[_0x4feebc(0x15b)]){console[_0x4feebc(0x138)](_0x4feebc(0x18c)+_0x240e78+'\x20is\x20older\x20than\x20'+this[_0x4feebc(0x15b)]+_0x4feebc(0x19f)),this[_0x4feebc(0xfb)](_0x240e78);return;}await this['checkSinglePaymentById'](_0x240e78),console['log']('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x240e78);}catch(_0x32043){console[_0x4feebc(0x19c)](_0x4feebc(0x13f)+_0x240e78+':',_0x32043),this[_0x4feebc(0x141)](_0x240e78,_0x186b28,_0x32043,_0x4feebc(0xeb),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x340564['push'](_0xfdb255),this[_0x1fde83(0x119)]['set'](_0x240e78,{'timers':_0x340564,'paymentId':_0x240e78,'gatewayPaymentId':_0x186b28,'createdAt':_0x546de9}),console[_0x1fde83(0x138)](_0x1fde83(0x121)+_0x325468[_0x1fde83(0x147)]+_0x1fde83(0x16f)+_0x240e78),console[_0x1fde83(0x138)](_0x1fde83(0x145)+this['paymentTimers'][_0x1fde83(0x14e)]),this[_0x1fde83(0x10d)](_0x240e78,_0x186b28,_0x1fde83(0x184),'PENDING',_0x1fde83(0xeb),{'action':_0x1fde83(0x187),'scheduledChecks':_0x325468[_0x1fde83(0x147)],'firstCheckIn':_0x325468[0x0]['delay']/0x3e8,'totalTimers':this[_0x1fde83(0x119)][_0x1fde83(0x14e)]});}[a37_0x4b9066(0xfb)](_0x46027f){const _0x2a6cc2=a37_0x4b9066,_0x12c8e1=this[_0x2a6cc2(0x119)]['get'](_0x46027f);_0x12c8e1?(console[_0x2a6cc2(0x138)](_0x2a6cc2(0x1a2)+_0x12c8e1[_0x2a6cc2(0x13d)]['length']+'\x20timers\x20for\x20payment\x20'+_0x46027f),_0x12c8e1[_0x2a6cc2(0x13d)][_0x2a6cc2(0x11e)]((_0x3a859d,_0xc0ebb2)=>{const _0xb434ad=_0x2a6cc2;_0x3a859d&&(clearTimeout(_0x3a859d),clearInterval(_0x3a859d),console[_0xb434ad(0x138)]('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0xc0ebb2+0x1)+_0xb434ad(0x101)+_0x46027f));}),this[_0x2a6cc2(0x119)][_0x2a6cc2(0x126)](_0x46027f),console['log']('✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20'+_0x46027f+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x2a6cc2(0x119)][_0x2a6cc2(0x14e)])):console[_0x2a6cc2(0x138)]('⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20'+_0x46027f+'\x20to\x20clear');}async[a37_0x4b9066(0x14c)](_0x591389){const _0x4f7f8c=a37_0x4b9066;console[_0x4f7f8c(0x138)](_0x4f7f8c(0x12b)+_0x591389);const _0x2698f0=await database_1[_0x4f7f8c(0xf9)]['payment']['findUnique']({'where':{'id':_0x591389},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2698f0){console[_0x4f7f8c(0x138)](_0x4f7f8c(0xd5)+_0x591389+_0x4f7f8c(0x143));return;}console[_0x4f7f8c(0x138)]('📊\x20[CHECK]\x20Payment\x20'+_0x591389+_0x4f7f8c(0x17a)),console[_0x4f7f8c(0x138)](_0x4f7f8c(0x124)+_0x2698f0['gateway']),console[_0x4f7f8c(0x138)](_0x4f7f8c(0xd3)+_0x2698f0[_0x4f7f8c(0x15d)]),console[_0x4f7f8c(0x138)](_0x4f7f8c(0xdb)+_0x2698f0[_0x4f7f8c(0x15f)]),console[_0x4f7f8c(0x138)](_0x4f7f8c(0x148)+_0x2698f0[_0x4f7f8c(0x18a)]+'\x20'+_0x2698f0[_0x4f7f8c(0x174)]),console[_0x4f7f8c(0x138)](_0x4f7f8c(0x157)+_0x2698f0[_0x4f7f8c(0x185)]);if(_0x2698f0[_0x4f7f8c(0x15a)]!==_0x4f7f8c(0x171)){console[_0x4f7f8c(0x138)](_0x4f7f8c(0x109)+_0x591389+_0x4f7f8c(0x199)+_0x2698f0['gateway']+')');return;}if(_0x2698f0[_0x4f7f8c(0x15d)]!==_0x4f7f8c(0x184)){console[_0x4f7f8c(0x138)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x591389+_0x4f7f8c(0x108)+_0x2698f0['status']+_0x4f7f8c(0x140)),this['clearPaymentTimers'](_0x591389);return;}if(!_0x2698f0[_0x4f7f8c(0x15f)]){console[_0x4f7f8c(0x138)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x591389+_0x4f7f8c(0x177));return;}console[_0x4f7f8c(0x138)](_0x4f7f8c(0x12f)+_0x591389+_0x4f7f8c(0x115)),await this[_0x4f7f8c(0x160)](_0x2698f0);}[a37_0x4b9066(0x10d)](_0xf90027,_0x496c1a,_0x4097a2,_0x458f74,_0x178f7e,_0x1161b8){const _0x18a05a=a37_0x4b9066,_0x4bcffe={'type':_0x18a05a(0x130),'paymentId':_0xf90027,'gatewayPaymentId':_0x496c1a,'oldStatus':_0x4097a2,'newStatus':_0x458f74,'source':_0x178f7e,'timestamp':new Date()[_0x18a05a(0x127)](),'details':_0x1161b8||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x4bcffe),console[_0x18a05a(0x138)]('🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0xf90027+'\x20('+_0x496c1a+')'),console[_0x18a05a(0x138)](_0x18a05a(0x197)+_0x4097a2+'\x20->\x20'+_0x458f74),console['log'](_0x18a05a(0x1a6)+_0x178f7e),console['log']('\x20\x20\x20📅\x20Time:\x20'+_0x4bcffe['timestamp']),_0x1161b8&&console[_0x18a05a(0x138)](_0x18a05a(0x1b3),_0x1161b8);}['logCoinToPayError'](_0x1ac770,_0x57b330,_0x27320c,_0xef9487,_0x3ce6d0){const _0x3ed6a1=a37_0x4b9066,_0x561a31={'type':'COINTOPAY_ERROR','paymentId':_0x1ac770,'gatewayPaymentId':_0x57b330,'error':_0x27320c instanceof Error?{'message':_0x27320c[_0x3ed6a1(0x13c)],'stack':_0x27320c[_0x3ed6a1(0x17b)]}:_0x27320c,'source':_0xef9487,'timestamp':new Date()[_0x3ed6a1(0x127)](),'context':_0x3ce6d0||{}};loggerService_1['loggerService'][_0x3ed6a1(0x141)](_0x561a31),console['error'](_0x3ed6a1(0x1a4)+_0x1ac770+'\x20('+_0x57b330+')'),console['error'](_0x3ed6a1(0xfe)+(_0x27320c instanceof Error?_0x27320c['message']:_0x27320c)),console[_0x3ed6a1(0x19c)](_0x3ed6a1(0x1a6)+_0xef9487),console[_0x3ed6a1(0x19c)](_0x3ed6a1(0x191)+_0x561a31['timestamp']),_0x3ce6d0&&console[_0x3ed6a1(0x19c)](_0x3ed6a1(0x182),_0x3ce6d0);}['startPeriodicStatusCheck'](){const _0x15b81d=a37_0x4b9066;console[_0x15b81d(0x138)]('🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x15b81d(0x1ae)]()[_0x15b81d(0x1a7)](_0x17123a=>{const _0x21da87=_0x15b81d;console['error'](_0x21da87(0x139),_0x17123a);}),this[_0x15b81d(0x15e)]=setInterval(async()=>{const _0x43c8ea=_0x15b81d;try{console[_0x43c8ea(0x138)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x43c8ea(0x138)](_0x43c8ea(0x137));}catch(_0x1ede82){console[_0x43c8ea(0x19c)](_0x43c8ea(0x195),_0x1ede82);}},this[_0x15b81d(0x17e)]),console[_0x15b81d(0x138)](_0x15b81d(0x16c));}[a37_0x4b9066(0x117)](){const _0x35e6e1=a37_0x4b9066;console[_0x35e6e1(0x138)](_0x35e6e1(0xed));this[_0x35e6e1(0x15e)]&&(clearInterval(this[_0x35e6e1(0x15e)]),this[_0x35e6e1(0x15e)]=null,console['log'](_0x35e6e1(0x193)));const _0x20e8a1=this['paymentTimers'][_0x35e6e1(0x14e)];for(const [_0x28e39f]of this[_0x35e6e1(0x119)]){this['clearPaymentTimers'](_0x28e39f);}console['log'](_0x35e6e1(0x19e)+_0x20e8a1+_0x35e6e1(0x154));}async[a37_0x4b9066(0x1ae)](){const _0x7981a1=a37_0x4b9066;try{console[_0x7981a1(0x138)]('🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...');const _0x42bfdc=await database_1[_0x7981a1(0xf9)][_0x7981a1(0x162)]['findMany']({'where':{'gateway':'cointopay','status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x7981a1(0x138)](_0x7981a1(0x125)+_0x42bfdc[_0x7981a1(0x147)]+_0x7981a1(0x158));if(_0x42bfdc['length']===0x0){console[_0x7981a1(0x138)](_0x7981a1(0xf4));return;}const _0x3d416c=await this[_0x7981a1(0x176)](_0x42bfdc);console[_0x7981a1(0x138)](_0x7981a1(0x173)+_0x3d416c['length']+_0x7981a1(0x13a));let _0x148b41=0x0,_0x1d7e5c=0x0;for(const _0x4a1e31 of _0x42bfdc){try{if(_0x3d416c[_0x7981a1(0x196)](_0x4a1e31['id'])){console[_0x7981a1(0x138)](_0x7981a1(0x155)+_0x4a1e31['id']+_0x7981a1(0x168)),_0x1d7e5c++;continue;}if(this['paymentTimers'][_0x7981a1(0x18b)](_0x4a1e31['id'])){console[_0x7981a1(0x138)](_0x7981a1(0x155)+_0x4a1e31['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0x1d7e5c++;continue;}const _0x2f5bc1=(Date[_0x7981a1(0xdc)]()-_0x4a1e31['createdAt'][_0x7981a1(0xdf)]())/(0x3e8*0x3c*0x3c);if(_0x2f5bc1<0x1){console['log'](_0x7981a1(0x155)+_0x4a1e31['id']+_0x7981a1(0xe0)+_0x2f5bc1['toFixed'](0x1)+_0x7981a1(0x170)),_0x1d7e5c++;continue;}console[_0x7981a1(0x138)]('🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x4a1e31['id']+'\x20(age:\x20'+_0x2f5bc1[_0x7981a1(0x16b)](0x1)+'h)'),await this[_0x7981a1(0x160)](_0x4a1e31),_0x148b41++,await new Promise(_0x12c2cd=>setTimeout(_0x12c2cd,0x7d0));}catch(_0x1c25d8){console[_0x7981a1(0x19c)](_0x7981a1(0x118)+_0x4a1e31['id']+':',_0x1c25d8),this[_0x7981a1(0x141)](_0x4a1e31['id'],_0x4a1e31['gatewayPaymentId']||'unknown',_0x1c25d8,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x4a1e31['amount'],'paymentCurrency':_0x4a1e31[_0x7981a1(0x174)],'shopId':_0x4a1e31[_0x7981a1(0x185)],'createdAt':_0x4a1e31['createdAt']}),loggerService_1['loggerService']['logWhiteDomainError'](_0x7981a1(0x171),_0x7981a1(0x128)+_0x4a1e31[_0x7981a1(0x15f)],_0x1c25d8);}}console['log'](_0x7981a1(0x151)+_0x148b41+'\x20checked,\x20'+_0x1d7e5c+'\x20skipped,\x20'+_0x3d416c[_0x7981a1(0x147)]+_0x7981a1(0xe4));}catch(_0x23c869){console[_0x7981a1(0x19c)](_0x7981a1(0x198),_0x23c869);}}async['checkExpiredPayments'](_0x466c35){const _0x30c6ed=a37_0x4b9066,_0x227fbf=[],_0x4a3005=new Date();_0x4a3005[_0x30c6ed(0x136)](_0x4a3005[_0x30c6ed(0xe3)]()-this[_0x30c6ed(0x15b)]),console[_0x30c6ed(0x138)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x30c6ed(0x15b)]+_0x30c6ed(0x116)+_0x4a3005['toISOString']()+')');for(const _0x61e95c of _0x466c35){if(_0x61e95c[_0x30c6ed(0x12e)]<_0x4a3005){console[_0x30c6ed(0x138)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x61e95c['id']+_0x30c6ed(0xda)+this[_0x30c6ed(0x15b)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this['logCoinToPayStatus'](_0x61e95c['id'],_0x61e95c[_0x30c6ed(0x15f)]||_0x30c6ed(0x14a),'PENDING',_0x30c6ed(0x18e),_0x30c6ed(0xff),{'reason':_0x30c6ed(0x14d)+this[_0x30c6ed(0x15b)]+_0x30c6ed(0xf0),'createdAt':_0x61e95c[_0x30c6ed(0x12e)],'daysSinceCreation':Math['floor']((Date[_0x30c6ed(0xdc)]()-_0x61e95c[_0x30c6ed(0x12e)]['getTime']())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x61e95c['amount'],'paymentCurrency':_0x61e95c['currency'],'shopId':_0x61e95c['shopId']}),await database_1[_0x30c6ed(0xf9)][_0x30c6ed(0x162)][_0x30c6ed(0x112)]({'where':{'id':_0x61e95c['id']},'data':{'status':_0x30c6ed(0x18e),'updatedAt':new Date(),'adminNotes':_0x30c6ed(0x18f)+this[_0x30c6ed(0x15b)]+_0x30c6ed(0x188)}}),await database_1[_0x30c6ed(0xf9)]['webhookLog']['create']({'data':{'paymentId':_0x61e95c['id'],'shopId':_0x61e95c[_0x30c6ed(0x185)],'event':_0x30c6ed(0x132),'statusCode':0xc8,'responseBody':JSON[_0x30c6ed(0x1ab)]({'reason':_0x30c6ed(0x14d)+this['EXPIRY_DAYS']+'\x20days','createdAt':_0x61e95c[_0x30c6ed(0x12e)],'expiredAt':new Date()[_0x30c6ed(0x127)](),'daysSinceCreation':Math[_0x30c6ed(0x11a)]((Date['now']()-_0x61e95c[_0x30c6ed(0x12e)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x30c6ed(0x161)](_0x61e95c,_0x30c6ed(0x18e)),await this[_0x30c6ed(0xe6)](_0x61e95c,_0x30c6ed(0x18e)),this[_0x30c6ed(0xfb)](_0x61e95c['id']),_0x227fbf[_0x30c6ed(0x15c)](_0x61e95c['id']),console[_0x30c6ed(0x138)](_0x30c6ed(0x1b1)+_0x61e95c['id']+_0x30c6ed(0x150)+this[_0x30c6ed(0x15b)]+_0x30c6ed(0x11d));}catch(_0x12a698){console['error'](_0x30c6ed(0x122)+_0x61e95c['id']+':',_0x12a698),this[_0x30c6ed(0x141)](_0x61e95c['id'],_0x61e95c['gatewayPaymentId']||_0x30c6ed(0x14a),_0x12a698,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x61e95c[_0x30c6ed(0x12e)],'daysSinceCreation':Math[_0x30c6ed(0x11a)]((Date[_0x30c6ed(0xdc)]()-_0x61e95c[_0x30c6ed(0x12e)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x227fbf;}async[a37_0x4b9066(0x160)](_0x43ef6c){const _0x192cc5=a37_0x4b9066;if(!_0x43ef6c[_0x192cc5(0x15f)]){console['log'](_0x192cc5(0x109)+_0x43ef6c['id']+'\x20has\x20no\x20gatewayPaymentId,\x20skipping');return;}console[_0x192cc5(0x138)](_0x192cc5(0x10e)+_0x43ef6c['id']+'\x20('+_0x43ef6c[_0x192cc5(0x15f)]+')');try{const _0x9e0dbd=await this['coinToPayService'][_0x192cc5(0x10b)](_0x43ef6c[_0x192cc5(0x15f)]);console['log'](_0x192cc5(0xd1)+_0x43ef6c['id']+_0x192cc5(0x114)+_0x9e0dbd[_0x192cc5(0x15d)]);_0x9e0dbd[_0x192cc5(0x113)]&&console[_0x192cc5(0x138)](_0x192cc5(0xd1)+_0x43ef6c['id']+'\x20details:',{'iban':_0x9e0dbd[_0x192cc5(0x113)][_0x192cc5(0x18d)]||_0x192cc5(0x10c),'transactionId':_0x9e0dbd[_0x192cc5(0x113)][_0x192cc5(0xde)],'createdOn':_0x9e0dbd[_0x192cc5(0x113)][_0x192cc5(0x123)],'confirmedOn':_0x9e0dbd[_0x192cc5(0x113)][_0x192cc5(0xe5)]||_0x192cc5(0x1aa)});if(_0x9e0dbd['status']!==_0x43ef6c[_0x192cc5(0x15d)]){console[_0x192cc5(0x138)](_0x192cc5(0x1a5)+_0x43ef6c['id']+_0x192cc5(0xd6)+_0x43ef6c[_0x192cc5(0x15d)]+_0x192cc5(0x146)+_0x9e0dbd[_0x192cc5(0x15d)]),this[_0x192cc5(0x10d)](_0x43ef6c['id'],_0x43ef6c['gatewayPaymentId'],_0x43ef6c['status'],_0x9e0dbd['status'],'status_check',{'paymentDetails':_0x9e0dbd['paymentDetails'],'amount':_0x9e0dbd['amount'],'currency':_0x9e0dbd[_0x192cc5(0x174)],'shopId':_0x43ef6c[_0x192cc5(0x185)],'checkTimestamp':new Date()[_0x192cc5(0x127)]()});const _0x3121c7={'status':_0x9e0dbd['status'],'updatedAt':new Date()};_0x9e0dbd[_0x192cc5(0x15d)]===_0x192cc5(0x11f)&&_0x43ef6c[_0x192cc5(0x15d)]!=='PAID'&&(_0x3121c7['paidAt']=new Date(),console[_0x192cc5(0x138)]('💰\x20[CHECK]\x20Payment\x20'+_0x43ef6c['id']+_0x192cc5(0x13e)+_0x3121c7['paidAt'][_0x192cc5(0x127)]()));if(_0x9e0dbd['paymentDetails']){const _0x5ecc97=_0x9e0dbd['paymentDetails'];_0x5ecc97[_0x192cc5(0x18d)]&&(_0x3121c7[_0x192cc5(0x167)]=_0x5ecc97[_0x192cc5(0x18d)],console[_0x192cc5(0x138)](_0x192cc5(0x190)+_0x5ecc97[_0x192cc5(0x18d)]));if(_0x5ecc97[_0x192cc5(0x104)]){const _0x24a3e8=_0x43ef6c['adminNotes']||'',_0x303dc2=_0x192cc5(0x1b4)+_0x5ecc97[_0x192cc5(0x104)];_0x3121c7[_0x192cc5(0x179)]=_0x24a3e8?_0x24a3e8+'\x0a\x0a'+_0x303dc2:_0x303dc2,console['log'](_0x192cc5(0x1b0));}_0x5ecc97['transactionId']&&console['log'](_0x192cc5(0xf6)+_0x5ecc97[_0x192cc5(0xde)]),_0x5ecc97['confirmedOn']&&console['log'](_0x192cc5(0xfa)+_0x5ecc97[_0x192cc5(0xe5)]);}await database_1[_0x192cc5(0xf9)][_0x192cc5(0x162)][_0x192cc5(0x112)]({'where':{'id':_0x43ef6c['id']},'data':_0x3121c7}),await database_1['default'][_0x192cc5(0x103)]['create']({'data':{'paymentId':_0x43ef6c['id'],'shopId':_0x43ef6c[_0x192cc5(0x185)],'event':'cointopay_status_check_'+_0x9e0dbd[_0x192cc5(0x15d)][_0x192cc5(0x149)](),'statusCode':0xc8,'responseBody':JSON[_0x192cc5(0x1ab)]({'oldStatus':_0x43ef6c[_0x192cc5(0x15d)],'newStatus':_0x9e0dbd[_0x192cc5(0x15d)],'paymentDetails':_0x9e0dbd[_0x192cc5(0x113)],'checkedAt':new Date()[_0x192cc5(0x127)]()})}}),await this[_0x192cc5(0x161)](_0x43ef6c,_0x9e0dbd[_0x192cc5(0x15d)]),await this[_0x192cc5(0xe6)](_0x43ef6c,_0x9e0dbd['status']),_0x9e0dbd['status']!==_0x192cc5(0x184)&&(console[_0x192cc5(0x138)](_0x192cc5(0x111)+_0x43ef6c['id']+'\x20status\x20changed\x20to\x20'+_0x9e0dbd['status']+_0x192cc5(0x165)),this[_0x192cc5(0xfb)](_0x43ef6c['id'])),console['log'](_0x192cc5(0x12f)+_0x43ef6c['id']+'\x20updated\x20successfully');}else console[_0x192cc5(0x138)](_0x192cc5(0xd1)+_0x43ef6c['id']+_0x192cc5(0x156)+_0x9e0dbd['status']+')'),this[_0x192cc5(0x10d)](_0x43ef6c['id'],_0x43ef6c['gatewayPaymentId'],_0x43ef6c[_0x192cc5(0x15d)],_0x9e0dbd[_0x192cc5(0x15d)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x9e0dbd['paymentDetails'],'amount':_0x9e0dbd[_0x192cc5(0x18a)],'currency':_0x9e0dbd['currency'],'shopId':_0x43ef6c[_0x192cc5(0x185)],'checkTimestamp':new Date()[_0x192cc5(0x127)]()});}catch(_0x33f10d){console['error']('❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x43ef6c['id']+':',_0x33f10d),this['logCoinToPayError'](_0x43ef6c['id'],_0x43ef6c[_0x192cc5(0x15f)],_0x33f10d,'status_check',{'paymentAmount':_0x43ef6c[_0x192cc5(0x18a)],'paymentCurrency':_0x43ef6c[_0x192cc5(0x174)],'shopId':_0x43ef6c[_0x192cc5(0x185)],'createdAt':_0x43ef6c['createdAt']}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x43ef6c['id'],'shopId':_0x43ef6c[_0x192cc5(0x185)],'event':_0x192cc5(0xf2),'statusCode':0x1f4,'responseBody':JSON[_0x192cc5(0x1ab)]({'error':_0x33f10d instanceof Error?_0x33f10d[_0x192cc5(0x13c)]:_0x192cc5(0x134),'gatewayPaymentId':_0x43ef6c[_0x192cc5(0x15f)],'checkedAt':new Date()['toISOString']()})}});}}async[a37_0x4b9066(0x161)](_0x21568d,_0x439e62){const _0x2bb656=a37_0x4b9066,_0x1f34fa=Date[_0x2bb656(0xdc)]();try{const _0x222fc0=_0x21568d[_0x2bb656(0x1a3)],_0x2c6961=_0x222fc0[_0x2bb656(0xe9)];if(!_0x2c6961?.['webhookUrl']){console[_0x2bb656(0x138)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x222fc0['id']);return;}const _0x36cfd0=_0x439e62===_0x2bb656(0x11f)?_0x2bb656(0xd8):_0x439e62==='FAILED'?_0x2bb656(0x12c):_0x439e62==='EXPIRED'?_0x2bb656(0x12c):_0x2bb656(0x133);if(!_0x2c6961[_0x2bb656(0x12d)]?.['includes'](_0x36cfd0)){console[_0x2bb656(0x138)]('Webhook\x20event\x20'+_0x36cfd0+'\x20not\x20enabled\x20for\x20shop\x20'+_0x222fc0['id']);return;}const _0x24ad87={'event':_0x36cfd0,'payment':{'id':_0x21568d['id'],'order_id':_0x21568d['orderId'],'gateway_order_id':_0x21568d['gatewayOrderId'],'gateway':'0100','amount':_0x21568d[_0x2bb656(0x18a)],'currency':_0x21568d[_0x2bb656(0x174)],'status':_0x439e62['toLowerCase'](),'customer_email':_0x21568d[_0x2bb656(0xcf)],'customer_name':_0x21568d['customerName'],'created_at':_0x21568d[_0x2bb656(0x12e)],'updated_at':new Date()}},_0x18cb7a=await fetch(_0x2c6961[_0x2bb656(0xec)],{'method':_0x2bb656(0x11b),'headers':{'Content-Type':_0x2bb656(0x16d),'User-Agent':_0x2bb656(0x1a9)},'body':JSON[_0x2bb656(0x1ab)](_0x24ad87)}),_0x16813d=Date[_0x2bb656(0xdc)]()-_0x1f34fa,_0x4a1185=_0x18cb7a['ok']?_0x2bb656(0xf1):await _0x18cb7a[_0x2bb656(0x105)]();loggerService_1[_0x2bb656(0x16a)][_0x2bb656(0x14f)](_0x21568d[_0x2bb656(0x185)],_0x2c6961[_0x2bb656(0xec)],_0x36cfd0,_0x18cb7a[_0x2bb656(0x15d)],_0x16813d,_0x24ad87),console[_0x2bb656(0x138)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2c6961[_0x2bb656(0xec)]+_0x2bb656(0x131)+_0x18cb7a['status']+'\x20('+_0x16813d+_0x2bb656(0x186));}catch(_0x2bacb7){console['error'](_0x2bb656(0x107),_0x2bacb7),loggerService_1['loggerService'][_0x2bb656(0x180)](_0x21568d[_0x2bb656(0x185)],_0x21568d[_0x2bb656(0x1a3)]?.['settings']?.[_0x2bb656(0xec)]||'unknown',_0x2bb656(0xee),_0x2bacb7,{});}}async[a37_0x4b9066(0xe6)](_0x36e2e0,_0x1b86f){const _0x1cda82=a37_0x4b9066;try{const _0x293dac={'PENDING':_0x1cda82(0x175),'PAID':_0x1cda82(0x11c),'FAILED':_0x1cda82(0xe7),'EXPIRED':_0x1cda82(0x19a)},_0xbd5361=_0x293dac[_0x1b86f];if(!_0xbd5361||_0xbd5361==='created')return;await telegramBotService_1[_0x1cda82(0x172)][_0x1cda82(0x14b)](_0x36e2e0[_0x1cda82(0x185)],_0x36e2e0,_0xbd5361);}catch(_0x535e81){console[_0x1cda82(0x19c)](_0x1cda82(0x1b5),_0x535e81);}}async[a37_0x4b9066(0xef)](_0x3241c0){const _0xb60170=a37_0x4b9066;console[_0xb60170(0x138)](_0xb60170(0x102)+_0x3241c0);const _0x23bcfa=await database_1[_0xb60170(0xf9)][_0xb60170(0x162)][_0xb60170(0x189)]({'where':{'id':_0x3241c0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x23bcfa)throw new Error(_0xb60170(0x169));if(_0x23bcfa[_0xb60170(0x15a)]!==_0xb60170(0x171))throw new Error(_0xb60170(0xf8));console['log'](_0xb60170(0x17f)+_0x3241c0),await this[_0xb60170(0x160)](_0x23bcfa),console['log'](_0xb60170(0xfd)+_0x3241c0);}[a37_0x4b9066(0xe2)](){const _0x3c1710=a37_0x4b9066,_0x53bcbe=this['globalCheckInterval']?this[_0x3c1710(0x17e)]:undefined,_0x314be7=Array[_0x3c1710(0x129)](this[_0x3c1710(0x119)][_0x3c1710(0xf7)]())[_0x3c1710(0xd9)](_0x2531f2=>({'paymentId':_0x2531f2[_0x3c1710(0x120)],'gatewayPaymentId':_0x2531f2[_0x3c1710(0x15f)],'createdAt':_0x2531f2[_0x3c1710(0x12e)],'timersCount':_0x2531f2['timers'][_0x3c1710(0x147)]}));return{'isActive':!!this[_0x3c1710(0x15e)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x3c1710(0x15b)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x53bcbe,'paymentTimersDetails':_0x314be7};}[a37_0x4b9066(0xf5)](_0x6d76d1){const _0x484988=a37_0x4b9066,_0x33280b=this[_0x484988(0x119)][_0x484988(0x1a1)](_0x6d76d1);if(_0x33280b)return{'hasTimers':!![],'timersCount':_0x33280b['timers'][_0x484988(0x147)],'createdAt':_0x33280b['createdAt'],'gatewayPaymentId':_0x33280b[_0x484988(0x15f)]};return{'hasTimers':![]};}}exports[a37_0x4b9066(0xdd)]=CoinToPayStatusService,exports[a37_0x4b9066(0x1ac)]=new CoinToPayStatusService();function a37_0x1e81(){const _0x26e82a=['\x20days\x20(created\x20before\x20','stopPeriodicStatusCheck','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','paymentTimers','floor','POST','paid','-day\x20timeout','forEach','PAID','paymentId','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','createdOn','\x20\x20\x20-\x20Gateway:\x20','🪙\x20[GLOBAL]\x20Found\x20','delete','toISOString','/status/','from','\x20in\x20','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','payment.failed','webhookEvents','createdAt','✅\x20[CHECK]\x20Payment\x20','COINTOPAY_STATUS_CHANGE','\x20with\x20status\x20','cointopay_auto_expired','payment.pending','Unknown\x20error','description','setDate','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','log','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20expired\x20CoinToPay\x20payments','8334BLYlUf','message','timers','\x20marked\x20as\x20paid\x20at:\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20',',\x20stopping\x20individual\x20checks','logCoinToPayError','__esModule','\x20not\x20found\x20in\x20database','./loggerService','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20to\x20','length','\x20\x20\x20-\x20Amount:\x20','toLowerCase','unknown','sendPaymentNotification','checkSinglePaymentById','Payment\x20older\x20than\x20','size','logShopWebhookSent','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','5\x20minutes','\x20individual\x20payment\x20timers','⏰\x20[GLOBAL]\x20Payment\x20','\x20status\x20unchanged\x20(','\x20\x20\x20-\x20ShopId:\x20','\x20pending\x20CoinToPay\x20payments','\x20initial\x20timers\x20for\x20payment\x20','gateway','EXPIRY_DAYS','push','status','globalCheckInterval','gatewayPaymentId','checkSinglePayment','sendShopWebhook','payment','110FTreJk','delay',',\x20clearing\x20individual\x20timers','\x20not\x20found,\x20clearing\x20timers','remitterIban','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','Payment\x20not\x20found','loggerService','toFixed','✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','application/json','2\x20minutes','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','h),\x20skipping\x20global\x20check','cointopay','telegramBotService','⏰\x20[GLOBAL]\x20Found\x20','currency','created','checkExpiredPayments','\x20has\x20no\x20gatewayPaymentId','1\x20minute','adminNotes','\x20found:','stack','coinToPayService','❌\x20[HOURLY]\x20Payment\x20','GLOBAL_CHECK_INTERVAL_MS','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','logShopWebhookError','2171488TtcfMj','\x20\x20\x20📝\x20Context:','\x20completed\x20for\x20payment\x20','PENDING','shopId','ms)','schedule_created','\x20days\x20without\x20payment\x20confirmation','findUnique','amount','has','⏰\x20[HOURLY]\x20Payment\x20','iban','EXPIRED','Automatically\x20expired\x20after\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20\x20\x20📅\x20Time:\x20','5GVykBF','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','4585856MYLiNu','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','includes','\x20\x20\x20📊\x20Status:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','expired','162fXMZwB','error','93947yAapOp','🛑\x20[SHUTDOWN]\x20Cleared\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','get','🧹\x20[DEBUG]\x20Clearing\x20','shop','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','🔄\x20[CHECK]\x20Updating\x20payment\x20','\x20\x20\x20📍\x20Source:\x20','catch','406634WomFrk','TesSoft\x20Payment\x20System/1.0','not\x20confirmed','stringify','coinToPayStatusService','\x20seconds\x20(','checkAllPendingPayments','./gateways/coinToPayService','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','✅\x20[EXPIRY]\x20Payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20\x20\x20📝\x20Details:','Bank\x20Details:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerEmail','./telegramBotService','📊\x20[CHECK]\x20Payment\x20','🪙\x20CoinToPayStatusService\x20initialized','\x20\x20\x20-\x20Status:\x20','320196FppTUe','❌\x20[CHECK]\x20Payment\x20','\x20status\x20from\x20','\x20triggered\x20for\x20payment\x20','payment.success','map','\x20is\x20older\x20than\x20','\x20\x20\x20-\x20GatewayPaymentId:\x20','now','CoinToPayStatusService','transactionId','getTime','\x20is\x20too\x20new\x20(','defineProperty','getServiceStats','getDate','\x20expired','confirmedOn','sendPaymentStatusNotification','failed','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','settings','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','status_check','webhookUrl','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','webhook_send','checkPaymentById','\x20days','Success','cointopay_status_check_error','CoinToPayService','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','getPaymentTimerInfo','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','values','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','default','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','clearPaymentTimers','📊\x20[HOURLY]\x20Payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20\x20\x20❌\x20Error:\x20','auto_expire','__importDefault','\x20for\x20payment\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','webhookLog','bankDetails','text','🪙\x20[DEBUG]\x20Creating\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20status\x20is\x20','⚠️\x20[CHECK]\x20Payment\x20','2PuXfAs','checkPaymentStatus','not\x20found','logCoinToPayStatus','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','1825048TFvzHQ','\x20\x20\x20-\x20gatewayPaymentId:\x20','🧹\x20[CHECK]\x20Payment\x20','update','paymentDetails','\x20status:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...'];a37_0x1e81=function(){return _0x26e82a;};return a37_0x1e81();}