'use strict';function a37_0x18cf(){const _0x1226fc=['defineProperty','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','\x20days\x20(created\x20before\x20','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','gatewayPaymentId','\x20days\x20without\x20payment\x20confirmation','Bank\x20Details:\x20','schedule_created','\x20updated\x20successfully','toFixed','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','timers','checkPaymentStatus','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','logCoinToPayError','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','📊\x20[CHECK]\x20Payment\x20','status_check','orderId','update','Success','failed','Payment\x20not\x20found','1\x20minute','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','❌\x20[HOURLY]\x20Payment\x20','logShopWebhookError','\x20\x20\x20-\x20ShopId:\x20','\x20marked\x20as\x20paid\x20at:\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','sendShopWebhook','\x20(after\x20','logShopWebhookSent','✅\x20[CHECK]\x20Payment\x20','468237nWwFzR','\x20\x20\x20-\x20Amount:\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','description','\x20status\x20unchanged\x20(','715RKeiMz','Payment\x20older\x20than\x20','shopId',',\x20stopping\x20individual\x20checks','has','\x20individual\x20payment\x20timers','findUnique','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','\x20timers\x20for\x20payment\x20','set','stopPeriodicStatusCheck','cointopay','shop','cointopay_auto_expired','CoinToPayStatusService','EXPIRED','\x20for\x20payment\x20','payment','17148HhpiPS','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','checkPaymentById','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20status:\x20','forEach','delay','stack','\x20\x20\x20-\x20Status:\x20','payment.success','checkAllPendingPayments','\x20\x20\x20📝\x20Context:','logCoinToPayStatus','PAID','message','\x20status\x20is\x20','toISOString','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','sendPaymentNotification','auto_expire','from','255876DXIStx','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','settings','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20to\x20clear','\x20with\x20status\x20','\x20->\x20','catch','map','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','⏰\x20[GLOBAL]\x20Found\x20','2725860CfrZgZ','length','⏰\x20[DEBUG]\x20Scheduled\x20check\x20#','2\x20minutes',',\x20clearing\x20individual\x20timers','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','webhookUrl','5ARrQJP','🧹\x20[CHECK]\x20Payment\x20','\x20details:','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','cointopay_status_check_error','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','application/json','amount','webhookLog','customerEmail','telegramBotService','\x20has\x20no\x20gatewayPaymentId','\x20seconds\x20(','POST','./telegramBotService','CoinToPayService','-day\x20timeout','includes','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','gatewayOrderId','h),\x20skipping\x20global\x20check','paymentDetails','delete','GLOBAL_CHECK_INTERVAL_MS','COINTOPAY_ERROR','transactionId','TesSoft\x20Payment\x20System/1.0','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','globalCheckInterval','created','__esModule','floor','PENDING','Automatically\x20expired\x20after\x20','\x20completed\x20for\x20payment\x20','status','7290fnixhd','log','\x20not\x20found\x20in\x20database','bankDetails','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20pending\x20CoinToPay\x20payments','coinToPayService','2354331YfDDwk','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','gateway','error','checkSinglePaymentById','values','push','checkExpiredPayments','paymentId','Unknown\x20error','paymentTimers','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20\x20\x20📍\x20Source:\x20','clearPaymentTimers','⏰\x20[GLOBAL]\x20Payment\x20','✅\x20[TIMER]\x20Individual\x20check\x20#','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20\x20\x20-\x20Gateway:\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','\x20is\x20older\x20than\x20','\x20status\x20changed\x20to\x20','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','ms)','not\x20found','payment.failed','\x20found:','coinToPayStatusService','remitterIban','\x20\x20\x20📅\x20Time:\x20','\x20in\x20','webhookEvents','createdAt','schedulePaymentChecks','📊\x20[HOURLY]\x20Payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','sendPaymentStatusNotification','🔄\x20[CHECK]\x20Updating\x20payment\x20','cointopay_status_check_','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','1992296SlYCoe','logWhiteDomainError','\x20not\x20found,\x20clearing\x20timers','checkSinglePayment','findMany','\x20\x20\x20📊\x20Status:\x20','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','currency','loggerService','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','getTime','\x20not\x20enabled\x20for\x20shop\x20','EXPIRY_DAYS','get','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','adminNotes','size','toLowerCase','0100','⚠️\x20[CHECK]\x20Payment\x20','confirmedOn','iban','webhook_send','Failed\x20to\x20send\x20shop\x20webhook:','\x20skipped,\x20','createdOn','../config/database','payment.pending','stringify','\x20current\x20status:\x20','default','text','\x20\x20\x20📝\x20Details:','now','getDate','\x20days','paidAt','17910QaVIwq','\x20initial\x20timers\x20for\x20payment\x20','__importDefault','create','💰\x20[CHECK]\x20Payment\x20','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20expired\x20CoinToPay\x20payments','\x20status\x20from\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','unknown','expired'];a37_0x18cf=function(){return _0x1226fc;};return a37_0x18cf();}function a37_0x4812(_0x1f2150,_0x56a1ae){const _0x18cf8b=a37_0x18cf();return a37_0x4812=function(_0x481204,_0x54f313){_0x481204=_0x481204-0x1d4;let _0x1fb6af=_0x18cf8b[_0x481204];return _0x1fb6af;},a37_0x4812(_0x1f2150,_0x56a1ae);}const a37_0x55f3a3=a37_0x4812;(function(_0x3fc645,_0x5dfda6){const _0x1cef32=a37_0x4812,_0x3d008b=_0x3fc645();while(!![]){try{const _0x55cbae=parseInt(_0x1cef32(0x1f8))/0x1*(parseInt(_0x1cef32(0x1e4))/0x2)+-parseInt(_0x1cef32(0x223))/0x3+-parseInt(_0x1cef32(0x1f0))/0x4+parseInt(_0x1cef32(0x2a5))/0x5*(-parseInt(_0x1cef32(0x2b7))/0x6)+parseInt(_0x1cef32(0x2a0))/0x7+parseInt(_0x1cef32(0x24c))/0x8+parseInt(_0x1cef32(0x21c))/0x9*(parseInt(_0x1cef32(0x273))/0xa);if(_0x55cbae===_0x5dfda6)break;else _0x3d008b['push'](_0x3d008b['shift']());}catch(_0x4570a4){_0x3d008b['push'](_0x3d008b['shift']());}}}(a37_0x18cf,0x81bc0));var __importDefault=this&&this[a37_0x55f3a3(0x275)]||function(_0x383607){const _0x4102a5=a37_0x55f3a3;return _0x383607&&_0x383607[_0x4102a5(0x216)]?_0x383607:{'default':_0x383607};};Object[a37_0x55f3a3(0x27e)](exports,'__esModule',{'value':!![]}),exports[a37_0x55f3a3(0x23f)]=exports[a37_0x55f3a3(0x2b3)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),database_1=__importDefault(require(a37_0x55f3a3(0x268))),telegramBotService_1=require(a37_0x55f3a3(0x206)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x2e06dd=a37_0x55f3a3;this[_0x2e06dd(0x214)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this[_0x2e06dd(0x22d)]=new Map(),this[_0x2e06dd(0x222)]=new coinToPayService_1[(_0x2e06dd(0x207))](),console['log']('🪙\x20CoinToPayStatusService\x20initialized');}[a37_0x55f3a3(0x245)](_0x14f9ff,_0x242222){const _0x102c6d=a37_0x55f3a3;console[_0x102c6d(0x21d)](_0x102c6d(0x1e7)),console[_0x102c6d(0x21d)]('\x20\x20\x20-\x20paymentId:\x20'+_0x14f9ff),console[_0x102c6d(0x21d)](_0x102c6d(0x256)+_0x242222),this[_0x102c6d(0x231)](_0x14f9ff);const _0x3cfe6a=[],_0x29f951=new Date(),_0x5ba78e=[{'delay':0x1*0x3c*0x3e8,'description':_0x102c6d(0x295)},{'delay':0x2*0x3c*0x3e8,'description':_0x102c6d(0x1f3)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x102c6d(0x21d)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x5ba78e[_0x102c6d(0x1f1)]+_0x102c6d(0x274)+_0x14f9ff);let _0x3a3449=0x0;_0x5ba78e[_0x102c6d(0x1d4)]((_0x3a2c69,_0x188d08)=>{const _0x440704=_0x102c6d;_0x3a3449+=_0x3a2c69[_0x440704(0x1d5)];const _0x3789be=setTimeout(async()=>{const _0x5bb98f=_0x440704;console[_0x5bb98f(0x21d)](_0x5bb98f(0x27b)+(_0x188d08+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x14f9ff+_0x5bb98f(0x29d)+_0x3a2c69[_0x5bb98f(0x2a3)]+')');try{await this[_0x5bb98f(0x227)](_0x14f9ff),console[_0x5bb98f(0x21d)](_0x5bb98f(0x233)+(_0x188d08+0x1)+_0x5bb98f(0x21a)+_0x14f9ff);}catch(_0x4524c4){console['error']('❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x188d08+0x1)+'\x20for\x20payment\x20'+_0x14f9ff+':',_0x4524c4),this[_0x5bb98f(0x28c)](_0x14f9ff,_0x242222,_0x4524c4,_0x5bb98f(0x28f),{'checkNumber':_0x188d08+0x1,'scheduledAfter':_0x3a2c69['description'],'isIndividualCheck':!![]});}},_0x3a3449);_0x3cfe6a[_0x440704(0x229)](_0x3789be),console[_0x440704(0x21d)](_0x440704(0x1f2)+(_0x188d08+0x1)+_0x440704(0x2b5)+_0x14f9ff+_0x440704(0x242)+_0x3a3449/0x3e8+_0x440704(0x204)+_0x3a2c69[_0x440704(0x2a3)]+')');});const _0xdc6c7d=setInterval(async()=>{const _0x5d2b4b=_0x102c6d;console[_0x5d2b4b(0x21d)]('🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20'+_0x14f9ff);try{const _0x4b6739=await database_1[_0x5d2b4b(0x26c)][_0x5d2b4b(0x2b6)][_0x5d2b4b(0x2ab)]({'where':{'id':_0x14f9ff},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4b6739){console[_0x5d2b4b(0x21d)](_0x5d2b4b(0x297)+_0x14f9ff+_0x5d2b4b(0x24e)),this[_0x5d2b4b(0x231)](_0x14f9ff);return;}console[_0x5d2b4b(0x21d)](_0x5d2b4b(0x246)+_0x14f9ff+_0x5d2b4b(0x26b)+_0x4b6739['status']);if(_0x4b6739[_0x5d2b4b(0x21b)]!==_0x5d2b4b(0x218)){console[_0x5d2b4b(0x21d)]('✅\x20[HOURLY]\x20Payment\x20'+_0x14f9ff+_0x5d2b4b(0x1de)+_0x4b6739['status']+_0x5d2b4b(0x2a8)),this[_0x5d2b4b(0x231)](_0x14f9ff);return;}const _0x2147cb=Math[_0x5d2b4b(0x217)]((Date['now']()-_0x4b6739['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x2147cb>=this[_0x5d2b4b(0x25a)]){console[_0x5d2b4b(0x21d)]('⏰\x20[HOURLY]\x20Payment\x20'+_0x14f9ff+_0x5d2b4b(0x238)+this[_0x5d2b4b(0x25a)]+_0x5d2b4b(0x2a2)),this[_0x5d2b4b(0x231)](_0x14f9ff);return;}await this[_0x5d2b4b(0x227)](_0x14f9ff),console['log'](_0x5d2b4b(0x23a)+_0x14f9ff);}catch(_0x341ac9){console[_0x5d2b4b(0x226)](_0x5d2b4b(0x27f)+_0x14f9ff+':',_0x341ac9),this[_0x5d2b4b(0x28c)](_0x14f9ff,_0x242222,_0x341ac9,_0x5d2b4b(0x28f),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x3cfe6a[_0x102c6d(0x229)](_0xdc6c7d),this['paymentTimers'][_0x102c6d(0x2ae)](_0x14f9ff,{'timers':_0x3cfe6a,'paymentId':_0x14f9ff,'gatewayPaymentId':_0x242222,'createdAt':_0x29f951}),console[_0x102c6d(0x21d)](_0x102c6d(0x252)+_0x5ba78e[_0x102c6d(0x1f1)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x14f9ff),console['log']('📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20'+this[_0x102c6d(0x22d)]['size']),this[_0x102c6d(0x1db)](_0x14f9ff,_0x242222,'PENDING','PENDING',_0x102c6d(0x28f),{'action':_0x102c6d(0x285),'scheduledChecks':_0x5ba78e[_0x102c6d(0x1f1)],'firstCheckIn':_0x5ba78e[0x0][_0x102c6d(0x1d5)]/0x3e8,'totalTimers':this[_0x102c6d(0x22d)][_0x102c6d(0x25e)]});}[a37_0x55f3a3(0x231)](_0x4f097c){const _0x3ab96a=a37_0x55f3a3,_0x52ecfe=this[_0x3ab96a(0x22d)]['get'](_0x4f097c);_0x52ecfe?(console[_0x3ab96a(0x21d)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x52ecfe[_0x3ab96a(0x289)][_0x3ab96a(0x1f1)]+_0x3ab96a(0x2ad)+_0x4f097c),_0x52ecfe[_0x3ab96a(0x289)][_0x3ab96a(0x1d4)]((_0x12168a,_0x1ceac8)=>{const _0xb245b6=_0x3ab96a;_0x12168a&&(clearTimeout(_0x12168a),clearInterval(_0x12168a),console[_0xb245b6(0x21d)](_0xb245b6(0x24b)+(_0x1ceac8+0x1)+_0xb245b6(0x2b5)+_0x4f097c));}),this[_0x3ab96a(0x22d)][_0x3ab96a(0x20e)](_0x4f097c),console[_0x3ab96a(0x21d)](_0x3ab96a(0x278)+_0x4f097c+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x3ab96a(0x22d)][_0x3ab96a(0x25e)])):console[_0x3ab96a(0x21d)](_0x3ab96a(0x1f5)+_0x4f097c+_0x3ab96a(0x1e9));}async[a37_0x55f3a3(0x227)](_0x857692){const _0x41c7d1=a37_0x55f3a3;console['log'](_0x41c7d1(0x2b8)+_0x857692);const _0x114647=await database_1[_0x41c7d1(0x26c)][_0x41c7d1(0x2b6)][_0x41c7d1(0x2ab)]({'where':{'id':_0x857692},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x114647){console[_0x41c7d1(0x21d)]('❌\x20[CHECK]\x20Payment\x20'+_0x857692+_0x41c7d1(0x21e));return;}console['log'](_0x41c7d1(0x28e)+_0x857692+_0x41c7d1(0x23e)),console[_0x41c7d1(0x21d)](_0x41c7d1(0x235)+_0x114647[_0x41c7d1(0x225)]),console[_0x41c7d1(0x21d)](_0x41c7d1(0x1d7)+_0x114647[_0x41c7d1(0x21b)]),console['log'](_0x41c7d1(0x255)+_0x114647[_0x41c7d1(0x282)]),console['log'](_0x41c7d1(0x2a1)+_0x114647['amount']+'\x20'+_0x114647['currency']),console[_0x41c7d1(0x21d)](_0x41c7d1(0x299)+_0x114647[_0x41c7d1(0x2a7)]);if(_0x114647[_0x41c7d1(0x225)]!==_0x41c7d1(0x2b0)){console[_0x41c7d1(0x21d)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x857692+_0x41c7d1(0x236)+_0x114647[_0x41c7d1(0x225)]+')');return;}if(_0x114647[_0x41c7d1(0x21b)]!=='PENDING'){console[_0x41c7d1(0x21d)](_0x41c7d1(0x261)+_0x857692+_0x41c7d1(0x1de)+_0x114647[_0x41c7d1(0x21b)]+_0x41c7d1(0x2a8)),this['clearPaymentTimers'](_0x857692);return;}if(!_0x114647['gatewayPaymentId']){console[_0x41c7d1(0x21d)](_0x41c7d1(0x261)+_0x857692+_0x41c7d1(0x203));return;}console[_0x41c7d1(0x21d)](_0x41c7d1(0x29f)+_0x857692+_0x41c7d1(0x237)),await this['checkSinglePayment'](_0x114647);}[a37_0x55f3a3(0x1db)](_0x2a763b,_0x132f24,_0x2c18e7,_0x13b9ea,_0x102992,_0x515f36){const _0x468146=a37_0x55f3a3,_0x313acf={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x2a763b,'gatewayPaymentId':_0x132f24,'oldStatus':_0x2c18e7,'newStatus':_0x13b9ea,'source':_0x102992,'timestamp':new Date()[_0x468146(0x1df)](),'details':_0x515f36||{}};loggerService_1['loggerService']['logCoinToPayStatus'](_0x313acf),console[_0x468146(0x21d)](_0x468146(0x281)+_0x2a763b+'\x20('+_0x132f24+')'),console[_0x468146(0x21d)](_0x468146(0x251)+_0x2c18e7+_0x468146(0x1eb)+_0x13b9ea),console[_0x468146(0x21d)]('\x20\x20\x20📍\x20Source:\x20'+_0x102992),console[_0x468146(0x21d)](_0x468146(0x241)+_0x313acf['timestamp']),_0x515f36&&console[_0x468146(0x21d)](_0x468146(0x26e),_0x515f36);}[a37_0x55f3a3(0x28c)](_0x11b1ba,_0x1fa3c5,_0x44a32e,_0x1f1d4b,_0x59ced6){const _0x43c4a9=a37_0x55f3a3,_0x2e6508={'type':_0x43c4a9(0x210),'paymentId':_0x11b1ba,'gatewayPaymentId':_0x1fa3c5,'error':_0x44a32e instanceof Error?{'message':_0x44a32e[_0x43c4a9(0x1dd)],'stack':_0x44a32e[_0x43c4a9(0x1d6)]}:_0x44a32e,'source':_0x1f1d4b,'timestamp':new Date()['toISOString'](),'context':_0x59ced6||{}};loggerService_1[_0x43c4a9(0x254)][_0x43c4a9(0x28c)](_0x2e6508),console[_0x43c4a9(0x226)]('🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x11b1ba+'\x20('+_0x1fa3c5+')'),console[_0x43c4a9(0x226)]('\x20\x20\x20❌\x20Error:\x20'+(_0x44a32e instanceof Error?_0x44a32e[_0x43c4a9(0x1dd)]:_0x44a32e)),console['error'](_0x43c4a9(0x230)+_0x1f1d4b),console['error'](_0x43c4a9(0x241)+_0x2e6508['timestamp']),_0x59ced6&&console[_0x43c4a9(0x226)](_0x43c4a9(0x1da),_0x59ced6);}['startPeriodicStatusCheck'](){const _0x5eb82b=a37_0x55f3a3;console[_0x5eb82b(0x21d)](_0x5eb82b(0x2ac)),this[_0x5eb82b(0x1d9)]()[_0x5eb82b(0x1ec)](_0x3b644d=>{const _0x2b6a56=_0x5eb82b;console[_0x2b6a56(0x226)](_0x2b6a56(0x20a),_0x3b644d);}),this[_0x5eb82b(0x214)]=setInterval(async()=>{const _0x19f0e2=_0x5eb82b;try{console[_0x19f0e2(0x21d)]('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x19f0e2(0x21d)]('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x24c013){console[_0x19f0e2(0x226)](_0x19f0e2(0x296),_0x24c013);}},this[_0x5eb82b(0x20f)]),console[_0x5eb82b(0x21d)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x55f3a3(0x2af)](){const _0x31398a=a37_0x55f3a3;console[_0x31398a(0x21d)]('🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...');this[_0x31398a(0x214)]&&(clearInterval(this[_0x31398a(0x214)]),this['globalCheckInterval']=null,console[_0x31398a(0x21d)](_0x31398a(0x1ee)));const _0x1fcef2=this['paymentTimers']['size'];for(const [_0x1195b0]of this[_0x31398a(0x22d)]){this[_0x31398a(0x231)](_0x1195b0);}console[_0x31398a(0x21d)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x1fcef2+_0x31398a(0x2aa));}async[a37_0x55f3a3(0x1d9)](){const _0xbc4282=a37_0x55f3a3;try{console[_0xbc4282(0x21d)](_0xbc4282(0x220));const _0x47a8fb=await database_1[_0xbc4282(0x26c)]['payment'][_0xbc4282(0x250)]({'where':{'gateway':_0xbc4282(0x2b0),'status':_0xbc4282(0x218),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0xbc4282(0x21d)]('🪙\x20[GLOBAL]\x20Found\x20'+_0x47a8fb[_0xbc4282(0x1f1)]+_0xbc4282(0x221));if(_0x47a8fb['length']===0x0){console[_0xbc4282(0x21d)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x1045db=await this['checkExpiredPayments'](_0x47a8fb);console[_0xbc4282(0x21d)](_0xbc4282(0x1ef)+_0x1045db['length']+_0xbc4282(0x279));let _0x4e7256=0x0,_0xabd74e=0x0;for(const _0x41f91e of _0x47a8fb){try{if(_0x1045db[_0xbc4282(0x209)](_0x41f91e['id'])){console[_0xbc4282(0x21d)](_0xbc4282(0x232)+_0x41f91e['id']+_0xbc4282(0x1fb)),_0xabd74e++;continue;}if(this[_0xbc4282(0x22d)][_0xbc4282(0x2a9)](_0x41f91e['id'])){console[_0xbc4282(0x21d)](_0xbc4282(0x232)+_0x41f91e['id']+_0xbc4282(0x28d)),_0xabd74e++;continue;}const _0x14932a=(Date[_0xbc4282(0x26f)]()-_0x41f91e[_0xbc4282(0x244)][_0xbc4282(0x258)]())/(0x3e8*0x3c*0x3c);if(_0x14932a<0x1){console['log'](_0xbc4282(0x232)+_0x41f91e['id']+'\x20is\x20too\x20new\x20('+_0x14932a[_0xbc4282(0x287)](0x1)+_0xbc4282(0x20c)),_0xabd74e++;continue;}console[_0xbc4282(0x21d)](_0xbc4282(0x288)+_0x41f91e['id']+'\x20(age:\x20'+_0x14932a[_0xbc4282(0x287)](0x1)+'h)'),await this[_0xbc4282(0x24f)](_0x41f91e),_0x4e7256++,await new Promise(_0x304536=>setTimeout(_0x304536,0x7d0));}catch(_0x16ae78){console[_0xbc4282(0x226)](_0xbc4282(0x1fd)+_0x41f91e['id']+':',_0x16ae78),this[_0xbc4282(0x28c)](_0x41f91e['id'],_0x41f91e[_0xbc4282(0x282)]||_0xbc4282(0x27c),_0x16ae78,_0xbc4282(0x28f),{'isGlobalCheck':!![],'paymentAmount':_0x41f91e[_0xbc4282(0x1ff)],'paymentCurrency':_0x41f91e[_0xbc4282(0x253)],'shopId':_0x41f91e[_0xbc4282(0x2a7)],'createdAt':_0x41f91e[_0xbc4282(0x244)]}),loggerService_1[_0xbc4282(0x254)][_0xbc4282(0x24d)](_0xbc4282(0x2b0),'/status/'+_0x41f91e[_0xbc4282(0x282)],_0x16ae78);}}console[_0xbc4282(0x21d)](_0xbc4282(0x1f6)+_0x4e7256+'\x20checked,\x20'+_0xabd74e+_0xbc4282(0x266)+_0x1045db[_0xbc4282(0x1f1)]+'\x20expired');}catch(_0x310c97){console[_0xbc4282(0x226)](_0xbc4282(0x22e),_0x310c97);}}async[a37_0x55f3a3(0x22a)](_0x50952d){const _0x31ca45=a37_0x55f3a3,_0x14d39d=[],_0x29e6fe=new Date();_0x29e6fe['setDate'](_0x29e6fe[_0x31ca45(0x270)]()-this[_0x31ca45(0x25a)]),console[_0x31ca45(0x21d)](_0x31ca45(0x1e8)+this[_0x31ca45(0x25a)]+_0x31ca45(0x280)+_0x29e6fe[_0x31ca45(0x1df)]()+')');for(const _0x253b2c of _0x50952d){if(_0x253b2c[_0x31ca45(0x244)]<_0x29e6fe){console[_0x31ca45(0x21d)]('⏰\x20[EXPIRY]\x20Payment\x20'+_0x253b2c['id']+'\x20is\x20older\x20than\x20'+this[_0x31ca45(0x25a)]+_0x31ca45(0x247));try{this[_0x31ca45(0x1db)](_0x253b2c['id'],_0x253b2c[_0x31ca45(0x282)]||'unknown',_0x31ca45(0x218),_0x31ca45(0x2b4),_0x31ca45(0x1e2),{'reason':_0x31ca45(0x2a6)+this[_0x31ca45(0x25a)]+_0x31ca45(0x271),'createdAt':_0x253b2c[_0x31ca45(0x244)],'daysSinceCreation':Math['floor']((Date['now']()-_0x253b2c['createdAt'][_0x31ca45(0x258)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x253b2c[_0x31ca45(0x1ff)],'paymentCurrency':_0x253b2c['currency'],'shopId':_0x253b2c[_0x31ca45(0x2a7)]}),await database_1[_0x31ca45(0x26c)][_0x31ca45(0x2b6)][_0x31ca45(0x291)]({'where':{'id':_0x253b2c['id']},'data':{'status':_0x31ca45(0x2b4),'updatedAt':new Date(),'adminNotes':_0x31ca45(0x219)+this[_0x31ca45(0x25a)]+_0x31ca45(0x283)}}),await database_1[_0x31ca45(0x26c)]['webhookLog'][_0x31ca45(0x276)]({'data':{'paymentId':_0x253b2c['id'],'shopId':_0x253b2c['shopId'],'event':_0x31ca45(0x2b2),'statusCode':0xc8,'responseBody':JSON[_0x31ca45(0x26a)]({'reason':_0x31ca45(0x2a6)+this[_0x31ca45(0x25a)]+'\x20days','createdAt':_0x253b2c[_0x31ca45(0x244)],'expiredAt':new Date()[_0x31ca45(0x1df)](),'daysSinceCreation':Math[_0x31ca45(0x217)]((Date['now']()-_0x253b2c[_0x31ca45(0x244)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x31ca45(0x29c)](_0x253b2c,'EXPIRED'),await this[_0x31ca45(0x248)](_0x253b2c,'EXPIRED'),this['clearPaymentTimers'](_0x253b2c['id']),_0x14d39d[_0x31ca45(0x229)](_0x253b2c['id']),console[_0x31ca45(0x21d)]('✅\x20[EXPIRY]\x20Payment\x20'+_0x253b2c['id']+_0x31ca45(0x29b)+this[_0x31ca45(0x25a)]+_0x31ca45(0x208));}catch(_0x1d704d){console[_0x31ca45(0x226)](_0x31ca45(0x224)+_0x253b2c['id']+':',_0x1d704d),this[_0x31ca45(0x28c)](_0x253b2c['id'],_0x253b2c[_0x31ca45(0x282)]||_0x31ca45(0x27c),_0x1d704d,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x253b2c[_0x31ca45(0x244)],'daysSinceCreation':Math[_0x31ca45(0x217)]((Date[_0x31ca45(0x26f)]()-_0x253b2c[_0x31ca45(0x244)][_0x31ca45(0x258)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x14d39d;}async[a37_0x55f3a3(0x24f)](_0x358d6c){const _0x465e56=a37_0x55f3a3;if(!_0x358d6c[_0x465e56(0x282)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x358d6c['id']+_0x465e56(0x234));return;}console['log'](_0x465e56(0x1e0)+_0x358d6c['id']+'\x20('+_0x358d6c[_0x465e56(0x282)]+')');try{const _0x3e87a6=await this[_0x465e56(0x222)][_0x465e56(0x28a)](_0x358d6c[_0x465e56(0x282)]);console[_0x465e56(0x21d)](_0x465e56(0x28e)+_0x358d6c['id']+_0x465e56(0x2bb)+_0x3e87a6['status']);_0x3e87a6[_0x465e56(0x20d)]&&console['log']('📊\x20[CHECK]\x20Payment\x20'+_0x358d6c['id']+_0x465e56(0x1fa),{'iban':_0x3e87a6['paymentDetails']['iban']||_0x465e56(0x23c),'transactionId':_0x3e87a6['paymentDetails']['transactionId'],'createdOn':_0x3e87a6[_0x465e56(0x20d)][_0x465e56(0x267)],'confirmedOn':_0x3e87a6[_0x465e56(0x20d)][_0x465e56(0x262)]||'not\x20confirmed'});if(_0x3e87a6[_0x465e56(0x21b)]!==_0x358d6c[_0x465e56(0x21b)]){console[_0x465e56(0x21d)](_0x465e56(0x249)+_0x358d6c['id']+_0x465e56(0x27a)+_0x358d6c[_0x465e56(0x21b)]+'\x20to\x20'+_0x3e87a6['status']),this[_0x465e56(0x1db)](_0x358d6c['id'],_0x358d6c[_0x465e56(0x282)],_0x358d6c[_0x465e56(0x21b)],_0x3e87a6[_0x465e56(0x21b)],_0x465e56(0x28f),{'paymentDetails':_0x3e87a6[_0x465e56(0x20d)],'amount':_0x3e87a6[_0x465e56(0x1ff)],'currency':_0x3e87a6[_0x465e56(0x253)],'shopId':_0x358d6c[_0x465e56(0x2a7)],'checkTimestamp':new Date()[_0x465e56(0x1df)]()});const _0x5af521={'status':_0x3e87a6[_0x465e56(0x21b)],'updatedAt':new Date()};_0x3e87a6[_0x465e56(0x21b)]===_0x465e56(0x1dc)&&_0x358d6c[_0x465e56(0x21b)]!==_0x465e56(0x1dc)&&(_0x5af521[_0x465e56(0x272)]=new Date(),console[_0x465e56(0x21d)](_0x465e56(0x277)+_0x358d6c['id']+_0x465e56(0x29a)+_0x5af521[_0x465e56(0x272)][_0x465e56(0x1df)]()));if(_0x3e87a6[_0x465e56(0x20d)]){const _0x5076bb=_0x3e87a6['paymentDetails'];_0x5076bb[_0x465e56(0x263)]&&(_0x5af521[_0x465e56(0x240)]=_0x5076bb[_0x465e56(0x263)],console['log']('🏦\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x5076bb[_0x465e56(0x263)]));if(_0x5076bb[_0x465e56(0x21f)]){const _0x2e8631=_0x358d6c[_0x465e56(0x25d)]||'',_0x2463e3=_0x465e56(0x284)+_0x5076bb['bankDetails'];_0x5af521[_0x465e56(0x25d)]=_0x2e8631?_0x2e8631+'\x0a\x0a'+_0x2463e3:_0x2463e3,console[_0x465e56(0x21d)](_0x465e56(0x25c));}_0x5076bb[_0x465e56(0x211)]&&console[_0x465e56(0x21d)](_0x465e56(0x1e5)+_0x5076bb['transactionId']),_0x5076bb['confirmedOn']&&console[_0x465e56(0x21d)](_0x465e56(0x22f)+_0x5076bb['confirmedOn']);}await database_1[_0x465e56(0x26c)][_0x465e56(0x2b6)][_0x465e56(0x291)]({'where':{'id':_0x358d6c['id']},'data':_0x5af521}),await database_1[_0x465e56(0x26c)]['webhookLog'][_0x465e56(0x276)]({'data':{'paymentId':_0x358d6c['id'],'shopId':_0x358d6c[_0x465e56(0x2a7)],'event':_0x465e56(0x24a)+_0x3e87a6['status'][_0x465e56(0x25f)](),'statusCode':0xc8,'responseBody':JSON[_0x465e56(0x26a)]({'oldStatus':_0x358d6c[_0x465e56(0x21b)],'newStatus':_0x3e87a6[_0x465e56(0x21b)],'paymentDetails':_0x3e87a6[_0x465e56(0x20d)],'checkedAt':new Date()[_0x465e56(0x1df)]()})}}),await this['sendShopWebhook'](_0x358d6c,_0x3e87a6['status']),await this[_0x465e56(0x248)](_0x358d6c,_0x3e87a6[_0x465e56(0x21b)]),_0x3e87a6['status']!==_0x465e56(0x218)&&(console['log'](_0x465e56(0x1f9)+_0x358d6c['id']+_0x465e56(0x239)+_0x3e87a6[_0x465e56(0x21b)]+_0x465e56(0x1f4)),this[_0x465e56(0x231)](_0x358d6c['id'])),console[_0x465e56(0x21d)](_0x465e56(0x29f)+_0x358d6c['id']+_0x465e56(0x286));}else console[_0x465e56(0x21d)]('📊\x20[CHECK]\x20Payment\x20'+_0x358d6c['id']+_0x465e56(0x2a4)+_0x3e87a6[_0x465e56(0x21b)]+')'),this[_0x465e56(0x1db)](_0x358d6c['id'],_0x358d6c[_0x465e56(0x282)],_0x358d6c[_0x465e56(0x21b)],_0x3e87a6[_0x465e56(0x21b)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x3e87a6['paymentDetails'],'amount':_0x3e87a6[_0x465e56(0x1ff)],'currency':_0x3e87a6[_0x465e56(0x253)],'shopId':_0x358d6c[_0x465e56(0x2a7)],'checkTimestamp':new Date()[_0x465e56(0x1df)]()});}catch(_0x219130){console[_0x465e56(0x226)](_0x465e56(0x213)+_0x358d6c['id']+':',_0x219130),this[_0x465e56(0x28c)](_0x358d6c['id'],_0x358d6c[_0x465e56(0x282)],_0x219130,_0x465e56(0x28f),{'paymentAmount':_0x358d6c['amount'],'paymentCurrency':_0x358d6c[_0x465e56(0x253)],'shopId':_0x358d6c[_0x465e56(0x2a7)],'createdAt':_0x358d6c[_0x465e56(0x244)]}),await database_1[_0x465e56(0x26c)][_0x465e56(0x200)][_0x465e56(0x276)]({'data':{'paymentId':_0x358d6c['id'],'shopId':_0x358d6c[_0x465e56(0x2a7)],'event':_0x465e56(0x1fc),'statusCode':0x1f4,'responseBody':JSON[_0x465e56(0x26a)]({'error':_0x219130 instanceof Error?_0x219130[_0x465e56(0x1dd)]:_0x465e56(0x22c),'gatewayPaymentId':_0x358d6c[_0x465e56(0x282)],'checkedAt':new Date()[_0x465e56(0x1df)]()})}});}}async[a37_0x55f3a3(0x29c)](_0x12cd7d,_0x892017){const _0x1bc513=a37_0x55f3a3,_0xeb21ab=Date[_0x1bc513(0x26f)]();try{const _0x28b686=_0x12cd7d['shop'],_0x237728=_0x28b686[_0x1bc513(0x1e6)];if(!_0x237728?.[_0x1bc513(0x1f7)]){console[_0x1bc513(0x21d)](_0x1bc513(0x2ba)+_0x28b686['id']);return;}const _0x30f6d7=_0x892017===_0x1bc513(0x1dc)?_0x1bc513(0x1d8):_0x892017==='FAILED'?'payment.failed':_0x892017===_0x1bc513(0x2b4)?_0x1bc513(0x23d):_0x1bc513(0x269);if(!_0x237728[_0x1bc513(0x243)]?.[_0x1bc513(0x209)](_0x30f6d7)){console[_0x1bc513(0x21d)]('Webhook\x20event\x20'+_0x30f6d7+_0x1bc513(0x259)+_0x28b686['id']);return;}const _0x30b19c={'event':_0x30f6d7,'payment':{'id':_0x12cd7d['id'],'order_id':_0x12cd7d[_0x1bc513(0x290)],'gateway_order_id':_0x12cd7d[_0x1bc513(0x20b)],'gateway':_0x1bc513(0x260),'amount':_0x12cd7d[_0x1bc513(0x1ff)],'currency':_0x12cd7d[_0x1bc513(0x253)],'status':_0x892017[_0x1bc513(0x25f)](),'customer_email':_0x12cd7d[_0x1bc513(0x201)],'customer_name':_0x12cd7d['customerName'],'created_at':_0x12cd7d[_0x1bc513(0x244)],'updated_at':new Date()}},_0x486ed4=await fetch(_0x237728[_0x1bc513(0x1f7)],{'method':_0x1bc513(0x205),'headers':{'Content-Type':_0x1bc513(0x1fe),'User-Agent':_0x1bc513(0x212)},'body':JSON[_0x1bc513(0x26a)](_0x30b19c)}),_0x5d1b67=Date[_0x1bc513(0x26f)]()-_0xeb21ab,_0x2f2356=_0x486ed4['ok']?_0x1bc513(0x292):await _0x486ed4[_0x1bc513(0x26d)]();loggerService_1['loggerService'][_0x1bc513(0x29e)](_0x12cd7d[_0x1bc513(0x2a7)],_0x237728[_0x1bc513(0x1f7)],_0x30f6d7,_0x486ed4[_0x1bc513(0x21b)],_0x5d1b67,_0x30b19c),console[_0x1bc513(0x21d)]('Shop\x20webhook\x20sent\x20to\x20'+_0x237728[_0x1bc513(0x1f7)]+_0x1bc513(0x1ea)+_0x486ed4[_0x1bc513(0x21b)]+'\x20('+_0x5d1b67+_0x1bc513(0x23b));}catch(_0x120668){console['error'](_0x1bc513(0x265),_0x120668),loggerService_1[_0x1bc513(0x254)][_0x1bc513(0x298)](_0x12cd7d[_0x1bc513(0x2a7)],_0x12cd7d[_0x1bc513(0x2b1)]?.[_0x1bc513(0x1e6)]?.[_0x1bc513(0x1f7)]||_0x1bc513(0x27c),_0x1bc513(0x264),_0x120668,{});}}async[a37_0x55f3a3(0x248)](_0x111df1,_0x3caa19){const _0x353445=a37_0x55f3a3;try{const _0x3bd814={'PENDING':'created','PAID':'paid','FAILED':_0x353445(0x293),'EXPIRED':_0x353445(0x27d)},_0x27a80c=_0x3bd814[_0x3caa19];if(!_0x27a80c||_0x27a80c===_0x353445(0x215))return;await telegramBotService_1[_0x353445(0x202)][_0x353445(0x1e1)](_0x111df1[_0x353445(0x2a7)],_0x111df1,_0x27a80c);}catch(_0x2c4def){console[_0x353445(0x226)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2c4def);}}async[a37_0x55f3a3(0x2b9)](_0x5eb975){const _0x3b7a34=a37_0x55f3a3;console[_0x3b7a34(0x21d)](_0x3b7a34(0x28b)+_0x5eb975);const _0x5e7823=await database_1[_0x3b7a34(0x26c)]['payment'][_0x3b7a34(0x2ab)]({'where':{'id':_0x5eb975},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5e7823)throw new Error(_0x3b7a34(0x294));if(_0x5e7823[_0x3b7a34(0x225)]!==_0x3b7a34(0x2b0))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');console[_0x3b7a34(0x21d)]('✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20'+_0x5eb975),await this[_0x3b7a34(0x24f)](_0x5e7823),console['log'](_0x3b7a34(0x257)+_0x5eb975);}['getServiceStats'](){const _0x13d94d=a37_0x55f3a3,_0x2f2426=this['globalCheckInterval']?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x3ac36f=Array[_0x13d94d(0x1e3)](this[_0x13d94d(0x22d)][_0x13d94d(0x228)]())[_0x13d94d(0x1ed)](_0x1de7c9=>({'paymentId':_0x1de7c9[_0x13d94d(0x22b)],'gatewayPaymentId':_0x1de7c9[_0x13d94d(0x282)],'createdAt':_0x1de7c9[_0x13d94d(0x244)],'timersCount':_0x1de7c9[_0x13d94d(0x289)][_0x13d94d(0x1f1)]}));return{'isActive':!!this['globalCheckInterval'],'globalCheckIntervalMinutes':this[_0x13d94d(0x20f)]/(0x3e8*0x3c),'expiryDays':this[_0x13d94d(0x25a)],'activeIndividualTimers':this['paymentTimers'][_0x13d94d(0x25e)],'nextGlobalCheckIn':_0x2f2426,'paymentTimersDetails':_0x3ac36f};}['getPaymentTimerInfo'](_0x2ad38c){const _0x5358de=a37_0x55f3a3,_0x245f49=this['paymentTimers'][_0x5358de(0x25b)](_0x2ad38c);if(_0x245f49)return{'hasTimers':!![],'timersCount':_0x245f49[_0x5358de(0x289)]['length'],'createdAt':_0x245f49['createdAt'],'gatewayPaymentId':_0x245f49[_0x5358de(0x282)]};return{'hasTimers':![]};}}exports[a37_0x55f3a3(0x2b3)]=CoinToPayStatusService,exports[a37_0x55f3a3(0x23f)]=new CoinToPayStatusService();