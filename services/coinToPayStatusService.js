'use strict';const a37_0x53f84b=a37_0xf525;(function(_0x298664,_0x208d67){const _0x13503b=a37_0xf525,_0x4178f6=_0x298664();while(!![]){try{const _0x3ff810=-parseInt(_0x13503b(0x213))/0x1+-parseInt(_0x13503b(0x1fb))/0x2*(-parseInt(_0x13503b(0x25c))/0x3)+-parseInt(_0x13503b(0x23f))/0x4+-parseInt(_0x13503b(0x2b0))/0x5*(parseInt(_0x13503b(0x212))/0x6)+parseInt(_0x13503b(0x280))/0x7+-parseInt(_0x13503b(0x259))/0x8+parseInt(_0x13503b(0x1ed))/0x9;if(_0x3ff810===_0x208d67)break;else _0x4178f6['push'](_0x4178f6['shift']());}catch(_0x61c2c6){_0x4178f6['push'](_0x4178f6['shift']());}}}(a37_0x55bc,0x53f79));var __importDefault=this&&this[a37_0x53f84b(0x1fc)]||function(_0x8b9da6){const _0x4a55f2=a37_0x53f84b;return _0x8b9da6&&_0x8b9da6[_0x4a55f2(0x1f6)]?_0x8b9da6:{'default':_0x8b9da6};};function a37_0x55bc(){const _0x14a546=['\x20individual\x20payment\x20timers','508548GRmvBo','442243MbyuYi','⏰\x20[HOURLY]\x20Payment\x20','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','.\x20Remaining\x20active\x20timers:\x20','🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','sendPaymentStatusNotification','create','auto_expire','get','-day\x20timeout','remitterIban','\x20days','FAILED','\x20(after\x20','\x20pending\x20CoinToPay\x20payments','Payment\x20is\x20not\x20a\x20CoinToPay\x20payment','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','./loggerService','default','orderId','push','\x20\x20\x20❌\x20Error:\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','⏰\x20[GLOBAL]\x20Payment\x20','\x20with\x20status\x20','clearPaymentTimers','\x20completed\x20for\x20payment\x20','cointopay','⚠️\x20[CHECK]\x20Payment\x20','\x20seconds\x20(','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20CoinToPay\x20payment\x20','payment.success','Failed\x20to\x20mark\x20payment\x20as\x20expired','🪙\x20CoinToPayStatusService\x20initialized','✅\x20[HOURLY]\x20Payment\x20','\x20not\x20enabled\x20for\x20shop\x20','adminNotes','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','🪙\x20[TIMER]\x20Individual\x20check\x20#','\x20status:\x20','5\x20minutes','values','2538356vdFJUg','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','text','toISOString','\x20\x20\x20-\x20ShopId:\x20','../config/database','customerName','COINTOPAY_STATUS_CHANGE','\x20marked\x20as\x20paid\x20at:\x20','createdAt','\x20days\x20without\x20payment\x20confirmation','✅\x20[EXPIRY]\x20Payment\x20','sendPaymentNotification','payment.pending','EXPIRED','telegramBotService','loggerService','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','payment','shopId','logWhiteDomainError','webhookEvents','sendShopWebhook','./telegramBotService','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','4152296cunsWd','logCoinToPayError','\x20status\x20unchanged\x20(','218619MkVioK','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','./gateways/coinToPayService','getDate','map','✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','h),\x20skipping\x20global\x20check','Failed\x20to\x20send\x20shop\x20webhook:','\x20in\x20','gatewayPaymentId','checkSinglePaymentById','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PAID','\x20expired','toLowerCase','schedulePaymentChecks','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','confirmedOn','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','paymentDetails','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','\x20current\x20status:\x20','\x20\x20\x20-\x20Gateway:\x20','includes','logCoinToPayStatus','Bank\x20Details:\x20','delete','floor','GLOBAL_CHECK_INTERVAL_MS','\x20triggered\x20for\x20payment\x20','expired','\x20status\x20changed\x20to\x20','coinToPayStatusService','customerEmail','logShopWebhookSent','checkPaymentById','3117835NFGyTd','\x20\x20\x20-\x20GatewayPaymentId:\x20','Unknown\x20error','\x20is\x20older\x20than\x20','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','defineProperty','\x20status\x20is\x20','checkAllPendingPayments','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','cointopay_status_check_','now','gateway','\x20\x20\x20📊\x20Status:\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','forEach','\x20\x20\x20📅\x20Time:\x20','settings','❌\x20[HOURLY]\x20Payment\x20','⏰\x20[GLOBAL]\x20Found\x20','🧹\x20[DEBUG]\x20Clearing\x20','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','currency','log','\x20for\x20payment\x20','\x20to\x20',',\x20stopping\x20individual\x20checks','transactionId','findMany','\x20found:','failed','Payment\x20not\x20found','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','paymentTimers','ms)','webhook_send','\x20is\x20too\x20new\x20(','⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20updated\x20successfully','timers','iban','coinToPayService','size','status_check','findUnique','\x20\x20\x20-\x20paymentId:\x20','EXPIRY_DAYS','✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','webhookUrl','10TezBdL','delay','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','catch','\x20checked,\x20','\x20\x20\x20-\x20Amount:\x20','❌\x20[CHECK]\x20Payment\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','description','checkSinglePayment','set','webhookLog','getTime','TesSoft\x20Payment\x20System/1.0','message','shop','📊\x20[CHECK]\x20Payment\x20','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','amount','length','\x20has\x20no\x20gatewayPaymentId,\x20skipping','getServiceStats','Payment\x20older\x20than\x20','\x20is\x20not\x20a\x20CoinToPay\x20payment\x20(gateway:\x20','2\x20minutes','unknown','Webhook\x20event\x20','9728325bDYsPi','paidAt','\x20details:','stack','⏰\x20[EXPIRY]\x20Payment\x20','Success','🔍\x20[CHECK]\x20Checking\x20CoinToPay\x20payment\x20','\x20\x20\x20📍\x20Source:\x20','createdOn','__esModule','error','\x20initial\x20timers\x20for\x20payment\x20','PENDING','stringify','16HKDadV','__importDefault','\x20\x20\x20📝\x20Details:','created','1\x20minute','\x20expired\x20CoinToPay\x20payments','CoinToPayStatusService','update','\x20(age:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','bankDetails','globalCheckInterval','payment.failed','logShopWebhookError','POST','\x20not\x20found\x20in\x20database','status','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','toFixed','checkExpiredPayments'];a37_0x55bc=function(){return _0x14a546;};return a37_0x55bc();}Object[a37_0x53f84b(0x285)](exports,a37_0x53f84b(0x1f6),{'value':!![]}),exports[a37_0x53f84b(0x27c)]=exports[a37_0x53f84b(0x201)]=void 0x0;const coinToPayService_1=require(a37_0x53f84b(0x25e)),database_1=__importDefault(require(a37_0x53f84b(0x244))),telegramBotService_1=require(a37_0x53f84b(0x257)),loggerService_1=require(a37_0x53f84b(0x226));class CoinToPayStatusService{constructor(){const _0x475174=a37_0x53f84b;this['globalCheckInterval']=null,this[_0x475174(0x278)]=0x3c*0x3c*0x3e8,this[_0x475174(0x2ad)]=0x5,this[_0x475174(0x2a0)]=new Map(),this[_0x475174(0x2a8)]=new coinToPayService_1['CoinToPayService'](),console[_0x475174(0x296)](_0x475174(0x236));}[a37_0x53f84b(0x26b)](_0x3bedc7,_0x3d50cf){const _0x35cbed=a37_0x53f84b;console[_0x35cbed(0x296)](_0x35cbed(0x29f)),console[_0x35cbed(0x296)](_0x35cbed(0x2ac)+_0x3bedc7),console[_0x35cbed(0x296)](_0x35cbed(0x20e)+_0x3d50cf),this[_0x35cbed(0x22e)](_0x3bedc7);const _0x6de64a=[],_0x3ee24a=new Date(),_0x3698c3=[{'delay':0x1*0x3c*0x3e8,'description':_0x35cbed(0x1ff)},{'delay':0x2*0x3c*0x3e8,'description':_0x35cbed(0x1ea)},{'delay':0x5*0x3c*0x3e8,'description':_0x35cbed(0x23d)},{'delay':0x5*0x3c*0x3e8,'description':_0x35cbed(0x23d)}];console[_0x35cbed(0x296)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x3698c3[_0x35cbed(0x1e5)]+_0x35cbed(0x1f8)+_0x3bedc7);let _0x3856ed=0x0;_0x3698c3[_0x35cbed(0x28e)]((_0x4494e6,_0x4a0be2)=>{const _0x3ac9f7=_0x35cbed;_0x3856ed+=_0x4494e6['delay'];const _0x147f84=setTimeout(async()=>{const _0x493202=a37_0xf525;console['log'](_0x493202(0x23b)+(_0x4a0be2+0x1)+_0x493202(0x279)+_0x3bedc7+_0x493202(0x221)+_0x4494e6[_0x493202(0x1da)]+')');try{await this[_0x493202(0x266)](_0x3bedc7),console[_0x493202(0x296)]('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x4a0be2+0x1)+_0x493202(0x22f)+_0x3bedc7);}catch(_0x48bc55){console[_0x493202(0x1f7)](_0x493202(0x225)+(_0x4a0be2+0x1)+_0x493202(0x297)+_0x3bedc7+':',_0x48bc55),this[_0x493202(0x25a)](_0x3bedc7,_0x3d50cf,_0x48bc55,_0x493202(0x2aa),{'checkNumber':_0x4a0be2+0x1,'scheduledAfter':_0x4494e6[_0x493202(0x1da)],'isIndividualCheck':!![]});}},_0x3856ed);_0x6de64a[_0x3ac9f7(0x229)](_0x147f84),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x4a0be2+0x1)+_0x3ac9f7(0x297)+_0x3bedc7+_0x3ac9f7(0x264)+_0x3856ed/0x3e8+_0x3ac9f7(0x232)+_0x4494e6[_0x3ac9f7(0x1da)]+')');});const _0x3d1ac0=setInterval(async()=>{const _0x658bcf=_0x35cbed;console[_0x658bcf(0x296)](_0x658bcf(0x240)+_0x3bedc7);try{const _0x2f61f8=await database_1[_0x658bcf(0x227)][_0x658bcf(0x252)][_0x658bcf(0x2ab)]({'where':{'id':_0x3bedc7},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x2f61f8){console['log'](_0x658bcf(0x291)+_0x3bedc7+'\x20not\x20found,\x20clearing\x20timers'),this[_0x658bcf(0x22e)](_0x3bedc7);return;}console[_0x658bcf(0x296)]('📊\x20[HOURLY]\x20Payment\x20'+_0x3bedc7+_0x658bcf(0x271)+_0x2f61f8[_0x658bcf(0x20c)]);if(_0x2f61f8[_0x658bcf(0x20c)]!=='PENDING'){console[_0x658bcf(0x296)](_0x658bcf(0x237)+_0x3bedc7+_0x658bcf(0x286)+_0x2f61f8[_0x658bcf(0x20c)]+_0x658bcf(0x299)),this[_0x658bcf(0x22e)](_0x3bedc7);return;}const _0x41c44f=Math[_0x658bcf(0x277)]((Date[_0x658bcf(0x28a)]()-_0x2f61f8['createdAt'][_0x658bcf(0x1de)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x41c44f>=this[_0x658bcf(0x2ad)]){console['log'](_0x658bcf(0x214)+_0x3bedc7+_0x658bcf(0x283)+this[_0x658bcf(0x2ad)]+'\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check'),this[_0x658bcf(0x22e)](_0x3bedc7);return;}await this[_0x658bcf(0x266)](_0x3bedc7),console[_0x658bcf(0x296)]('✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20'+_0x3bedc7);}catch(_0x22ff09){console[_0x658bcf(0x1f7)](_0x658bcf(0x251)+_0x3bedc7+':',_0x22ff09),this[_0x658bcf(0x25a)](_0x3bedc7,_0x3d50cf,_0x22ff09,_0x658bcf(0x2aa),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x6de64a[_0x35cbed(0x229)](_0x3d1ac0),this[_0x35cbed(0x2a0)][_0x35cbed(0x1dc)](_0x3bedc7,{'timers':_0x6de64a,'paymentId':_0x3bedc7,'gatewayPaymentId':_0x3d50cf,'createdAt':_0x3ee24a}),console[_0x35cbed(0x296)]('✅\x20[DEBUG]\x20Successfully\x20scheduled\x20'+_0x3698c3['length']+_0x35cbed(0x1d8)+_0x3bedc7),console[_0x35cbed(0x296)](_0x35cbed(0x1d3)+this['paymentTimers'][_0x35cbed(0x2a9)]),this['logCoinToPayStatus'](_0x3bedc7,_0x3d50cf,_0x35cbed(0x1f9),_0x35cbed(0x1f9),_0x35cbed(0x2aa),{'action':'schedule_created','scheduledChecks':_0x3698c3[_0x35cbed(0x1e5)],'firstCheckIn':_0x3698c3[0x0][_0x35cbed(0x1d2)]/0x3e8,'totalTimers':this['paymentTimers']['size']});}[a37_0x53f84b(0x22e)](_0x38c790){const _0x370905=a37_0x53f84b,_0x4624c4=this[_0x370905(0x2a0)]['get'](_0x38c790);_0x4624c4?(console[_0x370905(0x296)](_0x370905(0x293)+_0x4624c4['timers']['length']+'\x20timers\x20for\x20payment\x20'+_0x38c790),_0x4624c4[_0x370905(0x2a6)][_0x370905(0x28e)]((_0x378069,_0x42ec37)=>{_0x378069&&(clearTimeout(_0x378069),clearInterval(_0x378069),console['log']('🧹\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x42ec37+0x1)+'\x20for\x20payment\x20'+_0x38c790));}),this['paymentTimers'][_0x370905(0x276)](_0x38c790),console[_0x370905(0x296)](_0x370905(0x20d)+_0x38c790+_0x370905(0x217)+this[_0x370905(0x2a0)][_0x370905(0x2a9)])):console[_0x370905(0x296)](_0x370905(0x250)+_0x38c790+'\x20to\x20clear');}async[a37_0x53f84b(0x266)](_0x2825cf){const _0x658392=a37_0x53f84b;console[_0x658392(0x296)](_0x658392(0x23a)+_0x2825cf);const _0x40c8aa=await database_1[_0x658392(0x227)][_0x658392(0x252)][_0x658392(0x2ab)]({'where':{'id':_0x2825cf},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40c8aa){console['log'](_0x658392(0x1d7)+_0x2825cf+_0x658392(0x20b));return;}console[_0x658392(0x296)]('📊\x20[CHECK]\x20Payment\x20'+_0x2825cf+_0x658392(0x29c)),console['log'](_0x658392(0x272)+_0x40c8aa['gateway']),console[_0x658392(0x296)]('\x20\x20\x20-\x20Status:\x20'+_0x40c8aa[_0x658392(0x20c)]),console[_0x658392(0x296)](_0x658392(0x281)+_0x40c8aa[_0x658392(0x265)]),console[_0x658392(0x296)](_0x658392(0x1d6)+_0x40c8aa['amount']+'\x20'+_0x40c8aa[_0x658392(0x295)]),console[_0x658392(0x296)](_0x658392(0x243)+_0x40c8aa[_0x658392(0x253)]);if(_0x40c8aa['gateway']!==_0x658392(0x230)){console[_0x658392(0x296)](_0x658392(0x231)+_0x2825cf+_0x658392(0x1e9)+_0x40c8aa['gateway']+')');return;}if(_0x40c8aa['status']!=='PENDING'){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x2825cf+_0x658392(0x286)+_0x40c8aa[_0x658392(0x20c)]+_0x658392(0x299)),this[_0x658392(0x22e)](_0x2825cf);return;}if(!_0x40c8aa[_0x658392(0x265)]){console[_0x658392(0x296)]('⚠️\x20[CHECK]\x20Payment\x20'+_0x2825cf+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x658392(0x296)]('✅\x20[CHECK]\x20Payment\x20'+_0x2825cf+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this[_0x658392(0x1db)](_0x40c8aa);}[a37_0x53f84b(0x274)](_0x65cd46,_0x270def,_0x329037,_0x521058,_0x51813d,_0x9b59ff){const _0x479085=a37_0x53f84b,_0x5a1bde={'type':_0x479085(0x246),'paymentId':_0x65cd46,'gatewayPaymentId':_0x270def,'oldStatus':_0x329037,'newStatus':_0x521058,'source':_0x51813d,'timestamp':new Date()[_0x479085(0x242)](),'details':_0x9b59ff||{}};loggerService_1['loggerService'][_0x479085(0x274)](_0x5a1bde),console['log'](_0x479085(0x288)+_0x65cd46+'\x20('+_0x270def+')'),console['log'](_0x479085(0x28c)+_0x329037+'\x20->\x20'+_0x521058),console[_0x479085(0x296)](_0x479085(0x1f4)+_0x51813d),console['log'](_0x479085(0x28f)+_0x5a1bde['timestamp']),_0x9b59ff&&console[_0x479085(0x296)](_0x479085(0x1fd),_0x9b59ff);}[a37_0x53f84b(0x25a)](_0x3ff53f,_0x4866cc,_0x2e5cd6,_0x4cbbe8,_0x251a98){const _0x4c8d20=a37_0x53f84b,_0x5e739c={'type':'COINTOPAY_ERROR','paymentId':_0x3ff53f,'gatewayPaymentId':_0x4866cc,'error':_0x2e5cd6 instanceof Error?{'message':_0x2e5cd6['message'],'stack':_0x2e5cd6[_0x4c8d20(0x1f0)]}:_0x2e5cd6,'source':_0x4cbbe8,'timestamp':new Date()[_0x4c8d20(0x242)](),'context':_0x251a98||{}};loggerService_1[_0x4c8d20(0x24f)]['logCoinToPayError'](_0x5e739c),console[_0x4c8d20(0x1f7)](_0x4c8d20(0x26c)+_0x3ff53f+'\x20('+_0x4866cc+')'),console[_0x4c8d20(0x1f7)](_0x4c8d20(0x22a)+(_0x2e5cd6 instanceof Error?_0x2e5cd6[_0x4c8d20(0x1e0)]:_0x2e5cd6)),console[_0x4c8d20(0x1f7)]('\x20\x20\x20📍\x20Source:\x20'+_0x4cbbe8),console[_0x4c8d20(0x1f7)](_0x4c8d20(0x28f)+_0x5e739c['timestamp']),_0x251a98&&console[_0x4c8d20(0x1f7)]('\x20\x20\x20📝\x20Context:',_0x251a98);}['startPeriodicStatusCheck'](){const _0x34f1ed=a37_0x53f84b;console[_0x34f1ed(0x296)](_0x34f1ed(0x28d)),this[_0x34f1ed(0x287)]()[_0x34f1ed(0x1d4)](_0x36c72a=>{const _0x1af5b3=_0x34f1ed;console[_0x1af5b3(0x1f7)]('❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:',_0x36c72a);}),this['globalCheckInterval']=setInterval(async()=>{const _0x361a55=_0x34f1ed;try{console[_0x361a55(0x296)](_0x361a55(0x218)),await this[_0x361a55(0x287)](),console[_0x361a55(0x296)](_0x361a55(0x2ae));}catch(_0x388f39){console[_0x361a55(0x1f7)]('❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x388f39);}},this[_0x34f1ed(0x278)]),console[_0x34f1ed(0x296)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}['stopPeriodicStatusCheck'](){const _0x4a460e=a37_0x53f84b;console['log'](_0x4a460e(0x258));this[_0x4a460e(0x207)]&&(clearInterval(this[_0x4a460e(0x207)]),this[_0x4a460e(0x207)]=null,console['log']('🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped'));const _0x539111=this['paymentTimers'][_0x4a460e(0x2a9)];for(const [_0x12a970]of this[_0x4a460e(0x2a0)]){this[_0x4a460e(0x22e)](_0x12a970);}console[_0x4a460e(0x296)]('🛑\x20[SHUTDOWN]\x20Cleared\x20'+_0x539111+_0x4a460e(0x211));}async[a37_0x53f84b(0x287)](){const _0x337f2a=a37_0x53f84b;try{console[_0x337f2a(0x296)](_0x337f2a(0x216));const _0x458c38=await database_1[_0x337f2a(0x227)]['payment'][_0x337f2a(0x29b)]({'where':{'gateway':'cointopay','status':_0x337f2a(0x1f9),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log']('🪙\x20[GLOBAL]\x20Found\x20'+_0x458c38[_0x337f2a(0x1e5)]+_0x337f2a(0x222));if(_0x458c38[_0x337f2a(0x1e5)]===0x0){console[_0x337f2a(0x296)]('🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check');return;}const _0x328f75=await this[_0x337f2a(0x210)](_0x458c38);console[_0x337f2a(0x296)](_0x337f2a(0x292)+_0x328f75[_0x337f2a(0x1e5)]+_0x337f2a(0x200));let _0x20f619=0x0,_0xa202e0=0x0;for(const _0x142ecd of _0x458c38){try{if(_0x328f75[_0x337f2a(0x273)](_0x142ecd['id'])){console[_0x337f2a(0x296)](_0x337f2a(0x22c)+_0x142ecd['id']+_0x337f2a(0x26e)),_0xa202e0++;continue;}if(this[_0x337f2a(0x2a0)]['has'](_0x142ecd['id'])){console['log'](_0x337f2a(0x22c)+_0x142ecd['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0xa202e0++;continue;}const _0x4c9993=(Date[_0x337f2a(0x28a)]()-_0x142ecd[_0x337f2a(0x248)][_0x337f2a(0x1de)]())/(0x3e8*0x3c*0x3c);if(_0x4c9993<0x1){console[_0x337f2a(0x296)](_0x337f2a(0x22c)+_0x142ecd['id']+_0x337f2a(0x2a3)+_0x4c9993[_0x337f2a(0x20f)](0x1)+_0x337f2a(0x262)),_0xa202e0++;continue;}console[_0x337f2a(0x296)](_0x337f2a(0x1e3)+_0x142ecd['id']+_0x337f2a(0x203)+_0x4c9993['toFixed'](0x1)+'h)'),await this[_0x337f2a(0x1db)](_0x142ecd),_0x20f619++,await new Promise(_0x2f906=>setTimeout(_0x2f906,0x7d0));}catch(_0x487a8a){console[_0x337f2a(0x1f7)](_0x337f2a(0x204)+_0x142ecd['id']+':',_0x487a8a),this[_0x337f2a(0x25a)](_0x142ecd['id'],_0x142ecd['gatewayPaymentId']||_0x337f2a(0x1eb),_0x487a8a,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x142ecd[_0x337f2a(0x1e4)],'paymentCurrency':_0x142ecd[_0x337f2a(0x295)],'shopId':_0x142ecd['shopId'],'createdAt':_0x142ecd[_0x337f2a(0x248)]}),loggerService_1[_0x337f2a(0x24f)][_0x337f2a(0x254)](_0x337f2a(0x230),'/status/'+_0x142ecd[_0x337f2a(0x265)],_0x487a8a);}}console[_0x337f2a(0x296)](_0x337f2a(0x215)+_0x20f619+_0x337f2a(0x1d5)+_0xa202e0+'\x20skipped,\x20'+_0x328f75[_0x337f2a(0x1e5)]+_0x337f2a(0x269));}catch(_0x319624){console[_0x337f2a(0x1f7)]('❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x319624);}}async[a37_0x53f84b(0x210)](_0x20ea6a){const _0x3beda4=a37_0x53f84b,_0x5101f5=[],_0x362398=new Date();_0x362398['setDate'](_0x362398[_0x3beda4(0x25f)]()-this[_0x3beda4(0x2ad)]),console['log'](_0x3beda4(0x2a4)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x362398[_0x3beda4(0x242)]()+')');for(const _0x943903 of _0x20ea6a){if(_0x943903['createdAt']<_0x362398){console[_0x3beda4(0x296)](_0x3beda4(0x1f1)+_0x943903['id']+'\x20is\x20older\x20than\x20'+this[_0x3beda4(0x2ad)]+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x3beda4(0x274)](_0x943903['id'],_0x943903['gatewayPaymentId']||_0x3beda4(0x1eb),'PENDING',_0x3beda4(0x24d),_0x3beda4(0x21b),{'reason':_0x3beda4(0x1e8)+this[_0x3beda4(0x2ad)]+_0x3beda4(0x21f),'createdAt':_0x943903[_0x3beda4(0x248)],'daysSinceCreation':Math[_0x3beda4(0x277)]((Date[_0x3beda4(0x28a)]()-_0x943903[_0x3beda4(0x248)][_0x3beda4(0x1de)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x943903['amount'],'paymentCurrency':_0x943903['currency'],'shopId':_0x943903[_0x3beda4(0x253)]}),await database_1['default'][_0x3beda4(0x252)][_0x3beda4(0x202)]({'where':{'id':_0x943903['id']},'data':{'status':_0x3beda4(0x24d),'updatedAt':new Date(),'adminNotes':'Automatically\x20expired\x20after\x20'+this[_0x3beda4(0x2ad)]+_0x3beda4(0x249)}}),await database_1[_0x3beda4(0x227)]['webhookLog']['create']({'data':{'paymentId':_0x943903['id'],'shopId':_0x943903[_0x3beda4(0x253)],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x3beda4(0x1fa)]({'reason':_0x3beda4(0x1e8)+this[_0x3beda4(0x2ad)]+_0x3beda4(0x21f),'createdAt':_0x943903[_0x3beda4(0x248)],'expiredAt':new Date()[_0x3beda4(0x242)](),'daysSinceCreation':Math['floor']((Date['now']()-_0x943903['createdAt'][_0x3beda4(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x943903,_0x3beda4(0x24d)),await this[_0x3beda4(0x219)](_0x943903,'EXPIRED'),this[_0x3beda4(0x22e)](_0x943903['id']),_0x5101f5[_0x3beda4(0x229)](_0x943903['id']),console[_0x3beda4(0x296)](_0x3beda4(0x24a)+_0x943903['id']+_0x3beda4(0x224)+this[_0x3beda4(0x2ad)]+_0x3beda4(0x21d));}catch(_0x37e208){console[_0x3beda4(0x1f7)]('❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x943903['id']+':',_0x37e208),this[_0x3beda4(0x25a)](_0x943903['id'],_0x943903[_0x3beda4(0x265)]||_0x3beda4(0x1eb),_0x37e208,_0x3beda4(0x21b),{'reason':_0x3beda4(0x235),'createdAt':_0x943903[_0x3beda4(0x248)],'daysSinceCreation':Math['floor']((Date[_0x3beda4(0x28a)]()-_0x943903[_0x3beda4(0x248)][_0x3beda4(0x1de)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x5101f5;}async[a37_0x53f84b(0x1db)](_0x2ce077){const _0x342de8=a37_0x53f84b;if(!_0x2ce077['gatewayPaymentId']){console[_0x342de8(0x296)](_0x342de8(0x231)+_0x2ce077['id']+_0x342de8(0x1e6));return;}console[_0x342de8(0x296)](_0x342de8(0x1f3)+_0x2ce077['id']+'\x20('+_0x2ce077['gatewayPaymentId']+')');try{const _0xd647b1=await this[_0x342de8(0x2a8)]['checkPaymentStatus'](_0x2ce077[_0x342de8(0x265)]);console[_0x342de8(0x296)](_0x342de8(0x1e2)+_0x2ce077['id']+_0x342de8(0x23c)+_0xd647b1[_0x342de8(0x20c)]);_0xd647b1[_0x342de8(0x26f)]&&console[_0x342de8(0x296)](_0x342de8(0x1e2)+_0x2ce077['id']+_0x342de8(0x1ef),{'iban':_0xd647b1[_0x342de8(0x26f)][_0x342de8(0x2a7)]||'not\x20found','transactionId':_0xd647b1[_0x342de8(0x26f)][_0x342de8(0x29a)],'createdOn':_0xd647b1['paymentDetails'][_0x342de8(0x1f5)],'confirmedOn':_0xd647b1[_0x342de8(0x26f)]['confirmedOn']||'not\x20confirmed'});if(_0xd647b1[_0x342de8(0x20c)]!==_0x2ce077[_0x342de8(0x20c)]){console[_0x342de8(0x296)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x2ce077['id']+'\x20status\x20from\x20'+_0x2ce077[_0x342de8(0x20c)]+_0x342de8(0x298)+_0xd647b1['status']),this[_0x342de8(0x274)](_0x2ce077['id'],_0x2ce077[_0x342de8(0x265)],_0x2ce077[_0x342de8(0x20c)],_0xd647b1[_0x342de8(0x20c)],_0x342de8(0x2aa),{'paymentDetails':_0xd647b1[_0x342de8(0x26f)],'amount':_0xd647b1['amount'],'currency':_0xd647b1[_0x342de8(0x295)],'shopId':_0x2ce077[_0x342de8(0x253)],'checkTimestamp':new Date()['toISOString']()});const _0x4d7952={'status':_0xd647b1[_0x342de8(0x20c)],'updatedAt':new Date()};_0xd647b1['status']===_0x342de8(0x268)&&_0x2ce077[_0x342de8(0x20c)]!==_0x342de8(0x268)&&(_0x4d7952[_0x342de8(0x1ee)]=new Date(),console[_0x342de8(0x296)]('💰\x20[CHECK]\x20Payment\x20'+_0x2ce077['id']+_0x342de8(0x247)+_0x4d7952[_0x342de8(0x1ee)][_0x342de8(0x242)]()));if(_0xd647b1['paymentDetails']){const _0x4017c1=_0xd647b1[_0x342de8(0x26f)];_0x4017c1['iban']&&(_0x4d7952[_0x342de8(0x21e)]=_0x4017c1['iban'],console[_0x342de8(0x296)](_0x342de8(0x205)+_0x4017c1[_0x342de8(0x2a7)]));if(_0x4017c1[_0x342de8(0x206)]){const _0x1b9e26=_0x2ce077[_0x342de8(0x239)]||'',_0x3c471c=_0x342de8(0x275)+_0x4017c1[_0x342de8(0x206)];_0x4d7952['adminNotes']=_0x1b9e26?_0x1b9e26+'\x0a\x0a'+_0x3c471c:_0x3c471c,console[_0x342de8(0x296)](_0x342de8(0x270));}_0x4017c1[_0x342de8(0x29a)]&&console[_0x342de8(0x296)](_0x342de8(0x294)+_0x4017c1[_0x342de8(0x29a)]),_0x4017c1[_0x342de8(0x26d)]&&console[_0x342de8(0x296)](_0x342de8(0x261)+_0x4017c1[_0x342de8(0x26d)]);}await database_1[_0x342de8(0x227)][_0x342de8(0x252)]['update']({'where':{'id':_0x2ce077['id']},'data':_0x4d7952}),await database_1[_0x342de8(0x227)]['webhookLog'][_0x342de8(0x21a)]({'data':{'paymentId':_0x2ce077['id'],'shopId':_0x2ce077[_0x342de8(0x253)],'event':_0x342de8(0x289)+_0xd647b1[_0x342de8(0x20c)][_0x342de8(0x26a)](),'statusCode':0xc8,'responseBody':JSON[_0x342de8(0x1fa)]({'oldStatus':_0x2ce077[_0x342de8(0x20c)],'newStatus':_0xd647b1[_0x342de8(0x20c)],'paymentDetails':_0xd647b1['paymentDetails'],'checkedAt':new Date()['toISOString']()})}}),await this[_0x342de8(0x256)](_0x2ce077,_0xd647b1[_0x342de8(0x20c)]),await this[_0x342de8(0x219)](_0x2ce077,_0xd647b1[_0x342de8(0x20c)]),_0xd647b1[_0x342de8(0x20c)]!==_0x342de8(0x1f9)&&(console[_0x342de8(0x296)]('🧹\x20[CHECK]\x20Payment\x20'+_0x2ce077['id']+_0x342de8(0x27b)+_0xd647b1[_0x342de8(0x20c)]+',\x20clearing\x20individual\x20timers'),this[_0x342de8(0x22e)](_0x2ce077['id'])),console[_0x342de8(0x296)]('✅\x20[CHECK]\x20Payment\x20'+_0x2ce077['id']+_0x342de8(0x2a5));}else console[_0x342de8(0x296)]('📊\x20[CHECK]\x20Payment\x20'+_0x2ce077['id']+_0x342de8(0x25b)+_0xd647b1[_0x342de8(0x20c)]+')'),this[_0x342de8(0x274)](_0x2ce077['id'],_0x2ce077[_0x342de8(0x265)],_0x2ce077[_0x342de8(0x20c)],_0xd647b1[_0x342de8(0x20c)],_0x342de8(0x2aa),{'statusUnchanged':!![],'paymentDetails':_0xd647b1['paymentDetails'],'amount':_0xd647b1[_0x342de8(0x1e4)],'currency':_0xd647b1[_0x342de8(0x295)],'shopId':_0x2ce077[_0x342de8(0x253)],'checkTimestamp':new Date()[_0x342de8(0x242)]()});}catch(_0x5b8459){console[_0x342de8(0x1f7)](_0x342de8(0x22b)+_0x2ce077['id']+':',_0x5b8459),this[_0x342de8(0x25a)](_0x2ce077['id'],_0x2ce077[_0x342de8(0x265)],_0x5b8459,_0x342de8(0x2aa),{'paymentAmount':_0x2ce077['amount'],'paymentCurrency':_0x2ce077[_0x342de8(0x295)],'shopId':_0x2ce077[_0x342de8(0x253)],'createdAt':_0x2ce077[_0x342de8(0x248)]}),await database_1[_0x342de8(0x227)][_0x342de8(0x1dd)][_0x342de8(0x21a)]({'data':{'paymentId':_0x2ce077['id'],'shopId':_0x2ce077[_0x342de8(0x253)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x342de8(0x1fa)]({'error':_0x5b8459 instanceof Error?_0x5b8459[_0x342de8(0x1e0)]:_0x342de8(0x282),'gatewayPaymentId':_0x2ce077[_0x342de8(0x265)],'checkedAt':new Date()[_0x342de8(0x242)]()})}});}}async[a37_0x53f84b(0x256)](_0x3c7ae8,_0x44b88b){const _0x4766d8=a37_0x53f84b,_0x1f5ac1=Date[_0x4766d8(0x28a)]();try{const _0x3ad905=_0x3c7ae8[_0x4766d8(0x1e1)],_0x2c6680=_0x3ad905['settings'];if(!_0x2c6680?.[_0x4766d8(0x2af)]){console['log'](_0x4766d8(0x267)+_0x3ad905['id']);return;}const _0x149a18=_0x44b88b==='PAID'?_0x4766d8(0x234):_0x44b88b===_0x4766d8(0x220)?_0x4766d8(0x208):_0x44b88b===_0x4766d8(0x24d)?_0x4766d8(0x208):_0x4766d8(0x24c);if(!_0x2c6680[_0x4766d8(0x255)]?.[_0x4766d8(0x273)](_0x149a18)){console[_0x4766d8(0x296)](_0x4766d8(0x1ec)+_0x149a18+_0x4766d8(0x238)+_0x3ad905['id']);return;}const _0xf56dbc={'event':_0x149a18,'payment':{'id':_0x3c7ae8['id'],'order_id':_0x3c7ae8[_0x4766d8(0x228)],'gateway_order_id':_0x3c7ae8['gatewayOrderId'],'gateway':'0100','amount':_0x3c7ae8[_0x4766d8(0x1e4)],'currency':_0x3c7ae8['currency'],'status':_0x44b88b[_0x4766d8(0x26a)](),'customer_email':_0x3c7ae8[_0x4766d8(0x27d)],'customer_name':_0x3c7ae8[_0x4766d8(0x245)],'created_at':_0x3c7ae8[_0x4766d8(0x248)],'updated_at':new Date()}},_0x160ab4=await fetch(_0x2c6680['webhookUrl'],{'method':_0x4766d8(0x20a),'headers':{'Content-Type':'application/json','User-Agent':_0x4766d8(0x1df)},'body':JSON[_0x4766d8(0x1fa)](_0xf56dbc)}),_0x4057cc=Date[_0x4766d8(0x28a)]()-_0x1f5ac1,_0x5e7780=_0x160ab4['ok']?_0x4766d8(0x1f2):await _0x160ab4[_0x4766d8(0x241)]();loggerService_1[_0x4766d8(0x24f)][_0x4766d8(0x27e)](_0x3c7ae8['shopId'],_0x2c6680['webhookUrl'],_0x149a18,_0x160ab4['status'],_0x4057cc,_0xf56dbc),console[_0x4766d8(0x296)]('Shop\x20webhook\x20sent\x20to\x20'+_0x2c6680['webhookUrl']+_0x4766d8(0x22d)+_0x160ab4[_0x4766d8(0x20c)]+'\x20('+_0x4057cc+_0x4766d8(0x2a1));}catch(_0x2a029b){console[_0x4766d8(0x1f7)](_0x4766d8(0x263),_0x2a029b),loggerService_1[_0x4766d8(0x24f)][_0x4766d8(0x209)](_0x3c7ae8[_0x4766d8(0x253)],_0x3c7ae8['shop']?.[_0x4766d8(0x290)]?.[_0x4766d8(0x2af)]||_0x4766d8(0x1eb),_0x4766d8(0x2a2),_0x2a029b,{});}}async[a37_0x53f84b(0x219)](_0x53baff,_0x5b4205){const _0x50b8aa=a37_0x53f84b;try{const _0xe6bc7f={'PENDING':_0x50b8aa(0x1fe),'PAID':'paid','FAILED':_0x50b8aa(0x29d),'EXPIRED':_0x50b8aa(0x27a)},_0x5df2ad=_0xe6bc7f[_0x5b4205];if(!_0x5df2ad||_0x5df2ad===_0x50b8aa(0x1fe))return;await telegramBotService_1[_0x50b8aa(0x24e)][_0x50b8aa(0x24b)](_0x53baff[_0x50b8aa(0x253)],_0x53baff,_0x5df2ad);}catch(_0x3c9eef){console['error'](_0x50b8aa(0x25d),_0x3c9eef);}}async[a37_0x53f84b(0x27f)](_0x1f918c){const _0x2ed39d=a37_0x53f84b;console[_0x2ed39d(0x296)](_0x2ed39d(0x284)+_0x1f918c);const _0x257e1c=await database_1[_0x2ed39d(0x227)][_0x2ed39d(0x252)][_0x2ed39d(0x2ab)]({'where':{'id':_0x1f918c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x257e1c)throw new Error(_0x2ed39d(0x29e));if(_0x257e1c[_0x2ed39d(0x28b)]!==_0x2ed39d(0x230))throw new Error(_0x2ed39d(0x223));console[_0x2ed39d(0x296)](_0x2ed39d(0x233)+_0x1f918c),await this[_0x2ed39d(0x1db)](_0x257e1c),console[_0x2ed39d(0x296)](_0x2ed39d(0x1d9)+_0x1f918c);}[a37_0x53f84b(0x1e7)](){const _0x49dae3=a37_0x53f84b,_0x3a6b4f=this[_0x49dae3(0x207)]?this[_0x49dae3(0x278)]:undefined,_0x2e46b8=Array['from'](this['paymentTimers'][_0x49dae3(0x23e)]())[_0x49dae3(0x260)](_0x27216f=>({'paymentId':_0x27216f['paymentId'],'gatewayPaymentId':_0x27216f[_0x49dae3(0x265)],'createdAt':_0x27216f[_0x49dae3(0x248)],'timersCount':_0x27216f[_0x49dae3(0x2a6)]['length']}));return{'isActive':!!this[_0x49dae3(0x207)],'globalCheckIntervalMinutes':this[_0x49dae3(0x278)]/(0x3e8*0x3c),'expiryDays':this[_0x49dae3(0x2ad)],'activeIndividualTimers':this[_0x49dae3(0x2a0)][_0x49dae3(0x2a9)],'nextGlobalCheckIn':_0x3a6b4f,'paymentTimersDetails':_0x2e46b8};}['getPaymentTimerInfo'](_0x928729){const _0xd0f50c=a37_0x53f84b,_0x20d8ec=this[_0xd0f50c(0x2a0)][_0xd0f50c(0x21c)](_0x928729);if(_0x20d8ec)return{'hasTimers':!![],'timersCount':_0x20d8ec[_0xd0f50c(0x2a6)]['length'],'createdAt':_0x20d8ec[_0xd0f50c(0x248)],'gatewayPaymentId':_0x20d8ec['gatewayPaymentId']};return{'hasTimers':![]};}}function a37_0xf525(_0xc39a6e,_0x2f257d){const _0x55bc72=a37_0x55bc();return a37_0xf525=function(_0xf5250f,_0x1c2409){_0xf5250f=_0xf5250f-0x1d2;let _0x409874=_0x55bc72[_0xf5250f];return _0x409874;},a37_0xf525(_0xc39a6e,_0x2f257d);}exports[a37_0x53f84b(0x201)]=CoinToPayStatusService,exports[a37_0x53f84b(0x27c)]=new CoinToPayStatusService();