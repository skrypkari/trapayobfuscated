'use strict';function a42_0x1081(_0x1ad1ea,_0x2ebd60){const _0x578335=a42_0x5783();return a42_0x1081=function(_0x10818d,_0x2d5c70){_0x10818d=_0x10818d-0xf2;let _0x1982c2=_0x578335[_0x10818d];return _0x1982c2;},a42_0x1081(_0x1ad1ea,_0x2ebd60);}const a42_0x468436=a42_0x1081;(function(_0x42ffef,_0x5f3d0a){const _0x569449=a42_0x1081,_0xa0a2f=_0x42ffef();while(!![]){try{const _0x52b9f0=parseInt(_0x569449(0x1ba))/0x1*(parseInt(_0x569449(0x1a5))/0x2)+parseInt(_0x569449(0x18a))/0x3+parseInt(_0x569449(0x1c3))/0x4*(-parseInt(_0x569449(0x17c))/0x5)+parseInt(_0x569449(0x164))/0x6*(-parseInt(_0x569449(0xfc))/0x7)+-parseInt(_0x569449(0x155))/0x8+-parseInt(_0x569449(0x170))/0x9+parseInt(_0x569449(0x106))/0xa;if(_0x52b9f0===_0x5f3d0a)break;else _0xa0a2f['push'](_0xa0a2f['shift']());}catch(_0x26e57c){_0xa0a2f['push'](_0xa0a2f['shift']());}}}(a42_0x5783,0xbb65d));var __importDefault=this&&this['__importDefault']||function(_0x28b2e3){const _0x198656=a42_0x1081;return _0x28b2e3&&_0x28b2e3[_0x198656(0xf9)]?_0x28b2e3:{'default':_0x28b2e3};};function a42_0x5783(){const _0x2f2d00=['üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','\x20with\x20status\x20','webhook_send','delete','error','from','ü™ô\x20[GLOBAL]\x20Found\x20','SINGLE','üßπ\x20[CHECK]\x20Payment\x20','paymentTimers','sendShopWebhook','checkSinglePayment','\x20status\x20unchanged\x20(','\x20\x20\x20üìç\x20Source:\x20','getGatewayCommission','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','coinToPay2Service','update','\x20\x20\x20-\x20ShopId:\x20','paymentId','size','currency','gateway','EXPIRED','findUnique','defineProperty',',\x20gateway\x20','adminNotes','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','7277160YkCxMQ','Failed\x20to\x20mark\x20payment\x20as\x20expired','getServiceStats','-day\x20timeout','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','\x20expired\x20CoinToPay\x20payments','paymentLinkId','Webhook\x20event\x20','\x20expired',':\x20type=','\x20(after\x20','\x20not\x20enabled\x20for\x20shop\x20','coinToPayStatusService','‚è∞\x20[GLOBAL]\x20Found\x20','558342wbZBFJ','\x20completed\x20for\x20payment\x20','‚ùå\x20[CHECK]\x20Payment\x20','Payment\x20not\x20found','gatewayPaymentId','logWhiteDomainError','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','not\x20found','convertToUSDT','\x20days','./gateways/coinToPayService','11161179yYVQps','payment.failed','iban','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','logShopWebhookSent','\x20seconds\x20(','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','Payment\x20System/1.0','\x20updated:\x20currentPayments=','\x20is\x20too\x20new\x20(','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','5PvtFtY','./currencyService','\x20payment\x20','cointopay_auto_expired','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','../types/gateway','forEach','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','\x20updated\x20successfully','webhookUrl','expired','\x20\x20\x20-\x20Amount:\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','3705306WGxmUZ','paidAt','PAID','failed','length','created','\x20for\x20payment\x20','timers','gatewaySettings','logCoinToPayError','\x20\x20\x20üìÖ\x20Time:\x20','default','\x20is\x20valid\x20for\x20checking,\x20proceeding...','paid','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','\x20commission:\x20',',\x20status=','globalCheckInterval','cointopay','getPaymentTimerInfo','not\x20confirmed','logShopWebhookError','sendPaymentNotification','COMPLETED','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','orderId','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','322100ufzMaZ','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','auto_expire','‚úÖ\x20[HOURLY]\x20Payment\x20','\x20in\x20shop\x20','\x20USDT','payment.pending','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','EXPIRY_DAYS','entries','\x20days\x20without\x20payment\x20confirmation','get','application/json','values','stopPeriodicStatusCheck','\x20status:\x20','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','./loggerService','üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','8nwxiba','stringify','\x20(age:\x20','settings','\x20\x20\x20-\x20GatewayPaymentId:\x20','‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','paymentDetails','amount','\x20\x20\x20Amount\x20after\x20commission:\x20','3994792FixIdo','1\x20minute','GLOBAL_CHECK_INTERVAL_MS','gatewayOrderId','.\x20Remaining\x20active\x20timers:\x20','\x20is\x20older\x20than\x20','type','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','createdAt','\x20to\x20clear','map','\x20status\x20from\x20','\x20\x20\x20Amount:\x20','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','floor','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','FAILED','status_check','toFixed','\x20\x20\x20Gateway\x20',',\x20using\x20default\x2010%','‚úÖ\x20[CHECK]\x20Payment\x20','/status/','getDate','\x20checked,\x20','2\x20minutes','\x20\x20\x20-\x20paymentId:\x20','üìä\x20[CHECK]\x20Payment\x20','./telegramBotService','\x20status\x20is\x20','\x20marked\x20as\x20paid\x20at:\x20','delay','toISOString','ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','Success','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','loggerService','‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20','checkPaymentStatus','payment','log','ms)','Automatically\x20expired\x20after\x20','getGatewayIdByName','webhookEvents','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','remitterIban','logCoinToPayStatus','‚ùå\x20[HOURLY]\x20Payment\x20','currentPayments','confirmedOn','create','\x20current\x20status:\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20',',\x20stopping\x20individual\x20checks',',\x20clearing\x20individual\x20timers','ü™ô\x20[DEBUG]\x20Creating\x20','checkSinglePaymentById','Unknown\x20error','currencyService','has','5\x20minutes','setDate','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','status','\x20details:','clearPaymentTimers','‚è∞\x20[GLOBAL]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','includes','__esModule','set','getTime','70ENdmdM','shopId','h),\x20skipping\x20global\x20check','Bank\x20Details:\x20','\x20\x20\x20üìù\x20Details:','text','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','schedule_created','\x20not\x20found,\x20clearing\x20timers','paymentLink','23231230wLKKKX','telegramBotService','‚è∞\x20[EXPIRY]\x20Payment\x20','CoinToPayService','\x20has\x20no\x20gatewayPaymentId','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','now','‚úÖ\x20[EXPIRY]\x20Payment\x20','message','unknown','transactionId','amountUSDT','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20amounts\x20calculated:','PENDING','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','bankDetails','webhookLog','\x20->\x20','createdOn','cointopay2','üí∞\x20[CHECK]\x20Payment\x20','timestamp','checkExpiredPayments','schedulePaymentChecks','toLowerCase','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','\x20found:','cointopay_status_check_error','Failed\x20to\x20send\x20shop\x20webhook:','Payment\x20older\x20than\x20','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','./gateways/coinToPay2Service','push','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','payment.success','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','description','shop','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','üìà\x20[COINTOPAY]\x20Payment\x20','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link','checkAllPendingPayments',',\x20currentPayments=','stack','sendPaymentStatusNotification','\x20has\x20no\x20gatewayPaymentId,\x20skipping','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','üîç\x20[CHECK]\x20Checking\x20'];a42_0x5783=function(){return _0x2f2d00;};return a42_0x5783();}Object[a42_0x468436(0x151)](exports,a42_0x468436(0xf9),{'value':!![]}),exports[a42_0x468436(0x162)]=exports['CoinToPayStatusService']=void 0x0;const coinToPayService_1=require(a42_0x468436(0x16f)),coinToPay2Service_1=require(a42_0x468436(0x126)),gateway_1=require(a42_0x468436(0x182)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a42_0x468436(0x1e0)),loggerService_1=require(a42_0x468436(0x1b8)),currencyService_1=require(a42_0x468436(0x17d));class CoinToPayStatusService{constructor(){const _0x2020ea=a42_0x468436;this[_0x2020ea(0x19b)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x2020ea(0x1ae)]=0x5,this[_0x2020ea(0x141)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x2020ea(0x109))](),this[_0x2020ea(0x148)]=new coinToPay2Service_1['CoinToPay2Service'](),console[_0x2020ea(0x1ec)](_0x2020ea(0x1d1));}[a42_0x468436(0x11e)](_0x3d0421,_0xc02db6){const _0x324bc6=a42_0x468436;console[_0x324bc6(0x1ec)](_0x324bc6(0x1ca)),console[_0x324bc6(0x1ec)](_0x324bc6(0x1de)+_0x3d0421),console[_0x324bc6(0x1ec)](_0x324bc6(0x1fb)+_0xc02db6),this[_0x324bc6(0xf5)](_0x3d0421);const _0x5a3acb=[],_0x50a604=new Date(),_0x37359b=[{'delay':0x1*0x3c*0x3e8,'description':_0x324bc6(0x1c4)},{'delay':0x2*0x3c*0x3e8,'description':_0x324bc6(0x1dd)},{'delay':0x5*0x3c*0x3e8,'description':_0x324bc6(0x203)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'}];console[_0x324bc6(0x1ec)](_0x324bc6(0x1fe)+_0x37359b[_0x324bc6(0x18e)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x3d0421);let _0x735e5c=0x0;_0x37359b[_0x324bc6(0x183)]((_0x5062b2,_0x980112)=>{const _0x209376=_0x324bc6;_0x735e5c+=_0x5062b2[_0x209376(0x1e3)];const _0x529673=setTimeout(async()=>{const _0x5114d0=_0x209376;console['log']('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x980112+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x3d0421+_0x5114d0(0x160)+_0x5062b2[_0x5114d0(0x12b)]+')');try{await this['checkSinglePaymentById'](_0x3d0421),console[_0x5114d0(0x1ec)]('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x980112+0x1)+_0x5114d0(0x165)+_0x3d0421);}catch(_0x31c437){console[_0x5114d0(0x13c)]('‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#'+(_0x980112+0x1)+'\x20for\x20payment\x20'+_0x3d0421+':',_0x31c437),this[_0x5114d0(0x193)](_0x3d0421,_0xc02db6,_0x31c437,_0x5114d0(0x1d5),{'checkNumber':_0x980112+0x1,'scheduledAfter':_0x5062b2[_0x5114d0(0x12b)],'isIndividualCheck':!![]});}},_0x735e5c);_0x5a3acb['push'](_0x529673),console[_0x209376(0x1ec)](_0x209376(0x1a2)+(_0x980112+0x1)+_0x209376(0x190)+_0x3d0421+'\x20in\x20'+_0x735e5c/0x3e8+_0x209376(0x175)+_0x5062b2[_0x209376(0x12b)]+')');});const _0x54f541=setInterval(async()=>{const _0x335f55=_0x324bc6;console[_0x335f55(0x1ec)](_0x335f55(0x12d)+_0x3d0421);try{const _0x4dee2b=await database_1[_0x335f55(0x195)]['payment'][_0x335f55(0x150)]({'where':{'id':_0x3d0421},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x4dee2b){console[_0x335f55(0x1ec)](_0x335f55(0x1f5)+_0x3d0421+_0x335f55(0x104)),this['clearPaymentTimers'](_0x3d0421);return;}console[_0x335f55(0x1ec)]('üìä\x20[HOURLY]\x20Payment\x20'+_0x3d0421+_0x335f55(0x1f9)+_0x4dee2b[_0x335f55(0xf3)]);if(_0x4dee2b['status']!=='PENDING'){console[_0x335f55(0x1ec)](_0x335f55(0x1a8)+_0x3d0421+_0x335f55(0x1e1)+_0x4dee2b[_0x335f55(0xf3)]+',\x20stopping\x20individual\x20checks'),this[_0x335f55(0xf5)](_0x3d0421);return;}const _0x5d8c9c=Math[_0x335f55(0x1d2)]((Date[_0x335f55(0x10c)]()-_0x4dee2b['createdAt'][_0x335f55(0xfb)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x5d8c9c>=this['EXPIRY_DAYS']){console[_0x335f55(0x1ec)]('‚è∞\x20[HOURLY]\x20Payment\x20'+_0x3d0421+_0x335f55(0x1c8)+this[_0x335f55(0x1ae)]+_0x335f55(0xf2)),this[_0x335f55(0xf5)](_0x3d0421);return;}await this[_0x335f55(0x1ff)](_0x3d0421),console[_0x335f55(0x1ec)](_0x335f55(0x184)+_0x3d0421);}catch(_0xdb4e11){console[_0x335f55(0x13c)](_0x335f55(0x128)+_0x3d0421+':',_0xdb4e11),this[_0x335f55(0x193)](_0x3d0421,_0xc02db6,_0xdb4e11,_0x335f55(0x1d5),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5a3acb['push'](_0x54f541),this[_0x324bc6(0x141)][_0x324bc6(0xfa)](_0x3d0421,{'timers':_0x5a3acb,'paymentId':_0x3d0421,'gatewayPaymentId':_0xc02db6,'createdAt':_0x50a604}),console['log'](_0x324bc6(0x1b6)+_0x37359b[_0x324bc6(0x18e)]+_0x324bc6(0x176)+_0x3d0421),console['log'](_0x324bc6(0x1fa)+this['paymentTimers'][_0x324bc6(0x14c)]),this[_0x324bc6(0x1f4)](_0x3d0421,_0xc02db6,'PENDING',_0x324bc6(0x114),_0x324bc6(0x1d5),{'action':_0x324bc6(0x103),'scheduledChecks':_0x37359b[_0x324bc6(0x18e)],'firstCheckIn':_0x37359b[0x0][_0x324bc6(0x1e3)]/0x3e8,'totalTimers':this[_0x324bc6(0x141)][_0x324bc6(0x14c)]});}[a42_0x468436(0xf5)](_0x268ad6){const _0x186b6c=a42_0x468436,_0x513177=this[_0x186b6c(0x141)][_0x186b6c(0x1b1)](_0x268ad6);_0x513177?(console[_0x186b6c(0x1ec)](_0x186b6c(0xf7)+_0x513177[_0x186b6c(0x191)][_0x186b6c(0x18e)]+'\x20timers\x20for\x20payment\x20'+_0x268ad6),_0x513177['timers'][_0x186b6c(0x183)]((_0x36ad3,_0x9c9df6)=>{const _0x2e11ca=_0x186b6c;_0x36ad3&&(clearTimeout(_0x36ad3),clearInterval(_0x36ad3),console[_0x2e11ca(0x1ec)](_0x2e11ca(0x138)+(_0x9c9df6+0x1)+_0x2e11ca(0x190)+_0x268ad6));}),this['paymentTimers'][_0x186b6c(0x13b)](_0x268ad6),console['log'](_0x186b6c(0x1f2)+_0x268ad6+_0x186b6c(0x1c7)+this[_0x186b6c(0x141)]['size'])):console[_0x186b6c(0x1ec)](_0x186b6c(0x16a)+_0x268ad6+_0x186b6c(0x1cd));}async['checkSinglePaymentById'](_0x388c63){const _0x4b4e18=a42_0x468436;console[_0x4b4e18(0x1ec)](_0x4b4e18(0x1b9)+_0x388c63);const _0x22dca5=await database_1['default']['payment'][_0x4b4e18(0x150)]({'where':{'id':_0x388c63},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22dca5){console['log'](_0x4b4e18(0x166)+_0x388c63+'\x20not\x20found\x20in\x20database');return;}console[_0x4b4e18(0x1ec)]('üìä\x20[CHECK]\x20Payment\x20'+_0x388c63+_0x4b4e18(0x121)),console[_0x4b4e18(0x1ec)]('\x20\x20\x20-\x20Gateway:\x20'+_0x22dca5[_0x4b4e18(0x14e)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x22dca5[_0x4b4e18(0xf3)]),console[_0x4b4e18(0x1ec)](_0x4b4e18(0x1be)+_0x22dca5[_0x4b4e18(0x168)]),console[_0x4b4e18(0x1ec)](_0x4b4e18(0x188)+_0x22dca5[_0x4b4e18(0x1c1)]+'\x20'+_0x22dca5[_0x4b4e18(0x14d)]),console[_0x4b4e18(0x1ec)](_0x4b4e18(0x14a)+_0x22dca5[_0x4b4e18(0xfd)]);if(_0x22dca5['gateway']!=='cointopay'&&_0x22dca5[_0x4b4e18(0x14e)]!==_0x4b4e18(0x11a)){console['log'](_0x4b4e18(0x189)+_0x388c63+_0x4b4e18(0x1ac)+_0x22dca5[_0x4b4e18(0x14e)]+')');return;}if(_0x22dca5[_0x4b4e18(0xf3)]!==_0x4b4e18(0x114)){console['log']('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x388c63+_0x4b4e18(0x1e1)+_0x22dca5[_0x4b4e18(0xf3)]+_0x4b4e18(0x1fc)),this[_0x4b4e18(0xf5)](_0x388c63);return;}if(!_0x22dca5['gatewayPaymentId']){console[_0x4b4e18(0x1ec)](_0x4b4e18(0x189)+_0x388c63+_0x4b4e18(0x10a));return;}console['log'](_0x4b4e18(0x1d9)+_0x388c63+_0x4b4e18(0x196)),await this[_0x4b4e18(0x143)](_0x22dca5);}[a42_0x468436(0x1f4)](_0x5d262e,_0x57ec71,_0x582315,_0x213435,_0x80ad34,_0x1f7c19){const _0x3d7077=a42_0x468436,_0x5b1590={'type':'COINTOPAY_STATUS_CHANGE','paymentId':_0x5d262e,'gatewayPaymentId':_0x57ec71,'oldStatus':_0x582315,'newStatus':_0x213435,'source':_0x80ad34,'timestamp':new Date()[_0x3d7077(0x1e4)](),'details':_0x1f7c19||{}};loggerService_1[_0x3d7077(0x1e8)][_0x3d7077(0x1f4)](_0x5b1590),console[_0x3d7077(0x1ec)](_0x3d7077(0x159)+_0x5d262e+'\x20('+_0x57ec71+')'),console[_0x3d7077(0x1ec)]('\x20\x20\x20üìä\x20Status:\x20'+_0x582315+_0x3d7077(0x118)+_0x213435),console['log'](_0x3d7077(0x145)+_0x80ad34),console[_0x3d7077(0x1ec)](_0x3d7077(0x194)+_0x5b1590[_0x3d7077(0x11c)]),_0x1f7c19&&console[_0x3d7077(0x1ec)](_0x3d7077(0x100),_0x1f7c19);}[a42_0x468436(0x193)](_0x2ed8a6,_0x290542,_0x153b85,_0x5f21b4,_0x2e75d4){const _0xed83a7=a42_0x468436,_0xd36e3d={'type':'COINTOPAY_ERROR','paymentId':_0x2ed8a6,'gatewayPaymentId':_0x290542,'error':_0x153b85 instanceof Error?{'message':_0x153b85[_0xed83a7(0x10e)],'stack':_0x153b85[_0xed83a7(0x133)]}:_0x153b85,'source':_0x5f21b4,'timestamp':new Date()[_0xed83a7(0x1e4)](),'context':_0x2e75d4||{}};loggerService_1['loggerService'][_0xed83a7(0x193)](_0xd36e3d),console[_0xed83a7(0x13c)]('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x2ed8a6+'\x20('+_0x290542+')'),console[_0xed83a7(0x13c)]('\x20\x20\x20‚ùå\x20Error:\x20'+(_0x153b85 instanceof Error?_0x153b85[_0xed83a7(0x10e)]:_0x153b85)),console[_0xed83a7(0x13c)](_0xed83a7(0x145)+_0x5f21b4),console['error']('\x20\x20\x20üìÖ\x20Time:\x20'+_0xd36e3d[_0xed83a7(0x11c)]),_0x2e75d4&&console[_0xed83a7(0x13c)]('\x20\x20\x20üìù\x20Context:',_0x2e75d4);}['startPeriodicStatusCheck'](){const _0x1e2262=a42_0x468436;console[_0x1e2262(0x1ec)](_0x1e2262(0x1e5)),this[_0x1e2262(0x131)]()['catch'](_0x379525=>{const _0xb5c789=_0x1e2262;console[_0xb5c789(0x13c)](_0xb5c789(0x112),_0x379525);}),this[_0x1e2262(0x19b)]=setInterval(async()=>{const _0x34060f=_0x1e2262;try{console[_0x34060f(0x1ec)]('ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this['checkAllPendingPayments'](),console[_0x34060f(0x1ec)](_0x34060f(0x10b));}catch(_0x2a2b59){console[_0x34060f(0x13c)](_0x34060f(0x1e7),_0x2a2b59);}},this['GLOBAL_CHECK_INTERVAL_MS']),console[_0x1e2262(0x1ec)](_0x1e2262(0x12a));}[a42_0x468436(0x1b4)](){const _0x3e649f=a42_0x468436;console[_0x3e649f(0x1ec)](_0x3e649f(0x154));this[_0x3e649f(0x19b)]&&(clearInterval(this[_0x3e649f(0x19b)]),this[_0x3e649f(0x19b)]=null,console[_0x3e649f(0x1ec)](_0x3e649f(0x15a)));const _0x1ac40c=this[_0x3e649f(0x141)][_0x3e649f(0x14c)];for(const [_0x1e2f92]of this[_0x3e649f(0x141)]){this[_0x3e649f(0xf5)](_0x1e2f92);}console[_0x3e649f(0x1ec)](_0x3e649f(0x16b)+_0x1ac40c+'\x20individual\x20payment\x20timers');}async[a42_0x468436(0x131)](){const _0x442f37=a42_0x468436;try{console[_0x442f37(0x1ec)](_0x442f37(0x120));const _0x18fbbe=await database_1[_0x442f37(0x195)]['payment']['findMany']({'where':{'gateway':{'in':['cointopay',_0x442f37(0x11a)]},'status':_0x442f37(0x114),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x442f37(0x13e)+_0x18fbbe[_0x442f37(0x18e)]+'\x20pending\x20CoinToPay\x20payments');if(_0x18fbbe[_0x442f37(0x18e)]===0x0){console[_0x442f37(0x1ec)](_0x442f37(0x102));return;}const _0x133394=await this[_0x442f37(0x11d)](_0x18fbbe);console['log'](_0x442f37(0x163)+_0x133394[_0x442f37(0x18e)]+_0x442f37(0x15b));let _0x1d4766=0x0,_0xcdd297=0x0;for(const _0x2925e5 of _0x18fbbe){try{if(_0x133394[_0x442f37(0xf8)](_0x2925e5['id'])){console[_0x442f37(0x1ec)](_0x442f37(0xf6)+_0x2925e5['id']+_0x442f37(0x1f1)),_0xcdd297++;continue;}if(this[_0x442f37(0x141)][_0x442f37(0x202)](_0x2925e5['id'])){console[_0x442f37(0x1ec)](_0x442f37(0xf6)+_0x2925e5['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0xcdd297++;continue;}const _0x5da520=(Date[_0x442f37(0x10c)]()-_0x2925e5['createdAt'][_0x442f37(0xfb)]())/(0x3e8*0x3c*0x3c);if(_0x5da520<0x1){console[_0x442f37(0x1ec)](_0x442f37(0xf6)+_0x2925e5['id']+_0x442f37(0x17a)+_0x5da520['toFixed'](0x1)+_0x442f37(0xfe)),_0xcdd297++;continue;}console[_0x442f37(0x1ec)]('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x2925e5['id']+_0x442f37(0x1bc)+_0x5da520[_0x442f37(0x1d6)](0x1)+'h)'),await this[_0x442f37(0x143)](_0x2925e5),_0x1d4766++,await new Promise(_0x568f10=>setTimeout(_0x568f10,0x7d0));}catch(_0x248628){console[_0x442f37(0x13c)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x2925e5['id']+':',_0x248628),this[_0x442f37(0x193)](_0x2925e5['id'],_0x2925e5[_0x442f37(0x168)]||'unknown',_0x248628,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x2925e5[_0x442f37(0x1c1)],'paymentCurrency':_0x2925e5['currency'],'shopId':_0x2925e5[_0x442f37(0xfd)],'createdAt':_0x2925e5['createdAt']}),loggerService_1[_0x442f37(0x1e8)][_0x442f37(0x169)]('cointopay',_0x442f37(0x1da)+_0x2925e5[_0x442f37(0x168)],_0x248628);}}console[_0x442f37(0x1ec)]('‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20'+_0x1d4766+_0x442f37(0x1dc)+_0xcdd297+'\x20skipped,\x20'+_0x133394[_0x442f37(0x18e)]+_0x442f37(0x15e));}catch(_0x308444){console[_0x442f37(0x13c)](_0x442f37(0x147),_0x308444);}}async['checkExpiredPayments'](_0x126b4c){const _0x1596ba=a42_0x468436,_0x47f98b=[],_0x2c9697=new Date();_0x2c9697[_0x1596ba(0x204)](_0x2c9697[_0x1596ba(0x1db)]()-this[_0x1596ba(0x1ae)]),console[_0x1596ba(0x1ec)]('‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x1596ba(0x1ae)]+'\x20days\x20(created\x20before\x20'+_0x2c9697[_0x1596ba(0x1e4)]()+')');for(const _0x17a586 of _0x126b4c){if(_0x17a586['createdAt']<_0x2c9697){console[_0x1596ba(0x1ec)](_0x1596ba(0x108)+_0x17a586['id']+'\x20is\x20older\x20than\x20'+this['EXPIRY_DAYS']+'\x20days,\x20marking\x20as\x20EXPIRED');try{this[_0x1596ba(0x1f4)](_0x17a586['id'],_0x17a586['gatewayPaymentId']||'unknown','PENDING',_0x1596ba(0x14f),_0x1596ba(0x1a7),{'reason':_0x1596ba(0x124)+this[_0x1596ba(0x1ae)]+_0x1596ba(0x16e),'createdAt':_0x17a586[_0x1596ba(0x1cc)],'daysSinceCreation':Math['floor']((Date['now']()-_0x17a586['createdAt'][_0x1596ba(0xfb)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x17a586[_0x1596ba(0x1c1)],'paymentCurrency':_0x17a586[_0x1596ba(0x14d)],'shopId':_0x17a586['shopId']}),await database_1['default'][_0x1596ba(0x1eb)][_0x1596ba(0x149)]({'where':{'id':_0x17a586['id']},'data':{'status':_0x1596ba(0x14f),'updatedAt':new Date(),'adminNotes':_0x1596ba(0x1ee)+this['EXPIRY_DAYS']+_0x1596ba(0x1b0)}}),await database_1[_0x1596ba(0x195)]['webhookLog'][_0x1596ba(0x1f8)]({'data':{'paymentId':_0x17a586['id'],'shopId':_0x17a586[_0x1596ba(0xfd)],'event':_0x1596ba(0x17f),'statusCode':0xc8,'responseBody':JSON[_0x1596ba(0x1bb)]({'reason':_0x1596ba(0x124)+this[_0x1596ba(0x1ae)]+_0x1596ba(0x16e),'createdAt':_0x17a586[_0x1596ba(0x1cc)],'expiredAt':new Date()[_0x1596ba(0x1e4)](),'daysSinceCreation':Math['floor']((Date[_0x1596ba(0x10c)]()-_0x17a586['createdAt'][_0x1596ba(0xfb)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1596ba(0x142)](_0x17a586,_0x1596ba(0x14f)),await this['sendPaymentStatusNotification'](_0x17a586,'EXPIRED'),this['clearPaymentTimers'](_0x17a586['id']),_0x47f98b[_0x1596ba(0x127)](_0x17a586['id']),console[_0x1596ba(0x1ec)](_0x1596ba(0x10d)+_0x17a586['id']+_0x1596ba(0x1a4)+this[_0x1596ba(0x1ae)]+_0x1596ba(0x158));}catch(_0x54314f){console[_0x1596ba(0x13c)](_0x1596ba(0x1bf)+_0x17a586['id']+':',_0x54314f),this[_0x1596ba(0x193)](_0x17a586['id'],_0x17a586[_0x1596ba(0x168)]||'unknown',_0x54314f,_0x1596ba(0x1a7),{'reason':_0x1596ba(0x156),'createdAt':_0x17a586[_0x1596ba(0x1cc)],'daysSinceCreation':Math['floor']((Date['now']()-_0x17a586[_0x1596ba(0x1cc)][_0x1596ba(0xfb)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x47f98b;}async[a42_0x468436(0x143)](_0xe7c60f){const _0x5cfa13=a42_0x468436;if(!_0xe7c60f[_0x5cfa13(0x168)]){console['log'](_0x5cfa13(0x189)+_0xe7c60f['id']+_0x5cfa13(0x135));return;}console[_0x5cfa13(0x1ec)](_0x5cfa13(0x137)+_0xe7c60f[_0x5cfa13(0x14e)]+_0x5cfa13(0x17e)+_0xe7c60f['id']+'\x20('+_0xe7c60f[_0x5cfa13(0x168)]+')');try{let _0x38a067;_0xe7c60f[_0x5cfa13(0x14e)]==='cointopay2'?(_0x38a067=await this[_0x5cfa13(0x148)]['checkPaymentStatus'](_0xe7c60f['gatewayPaymentId']),console[_0x5cfa13(0x1ec)](_0x5cfa13(0x136)+_0xe7c60f['id']+_0x5cfa13(0x1b5)+_0x38a067[_0x5cfa13(0xf3)])):(_0x38a067=await this['coinToPayService'][_0x5cfa13(0x1ea)](_0xe7c60f['gatewayPaymentId']),console['log'](_0x5cfa13(0x1b7)+_0xe7c60f['id']+_0x5cfa13(0x1b5)+_0x38a067[_0x5cfa13(0xf3)]));_0x38a067['paymentDetails']&&console['log'](_0x5cfa13(0x1df)+_0xe7c60f['id']+_0x5cfa13(0xf4),{'iban':_0x38a067[_0x5cfa13(0x1c0)][_0x5cfa13(0x172)]||_0x5cfa13(0x16c),'transactionId':_0x38a067['paymentDetails']['transactionId'],'createdOn':_0x38a067[_0x5cfa13(0x1c0)][_0x5cfa13(0x119)],'confirmedOn':_0x38a067['paymentDetails'][_0x5cfa13(0x1f7)]||_0x5cfa13(0x19e)});if(_0x38a067['status']!==_0xe7c60f[_0x5cfa13(0xf3)]){console['log'](_0x5cfa13(0x177)+_0xe7c60f['id']+_0x5cfa13(0x1cf)+_0xe7c60f[_0x5cfa13(0xf3)]+'\x20to\x20'+_0x38a067[_0x5cfa13(0xf3)]),this['logCoinToPayStatus'](_0xe7c60f['id'],_0xe7c60f[_0x5cfa13(0x168)],_0xe7c60f[_0x5cfa13(0xf3)],_0x38a067['status'],_0x5cfa13(0x1d5),{'paymentDetails':_0x38a067[_0x5cfa13(0x1c0)],'amount':_0x38a067[_0x5cfa13(0x1c1)],'currency':_0x38a067[_0x5cfa13(0x14d)],'shopId':_0xe7c60f[_0x5cfa13(0xfd)],'checkTimestamp':new Date()[_0x5cfa13(0x1e4)]()});const _0x26ac52={'status':_0x38a067[_0x5cfa13(0xf3)],'updatedAt':new Date()};if(_0x38a067['status']===_0x5cfa13(0x18c)&&_0xe7c60f[_0x5cfa13(0xf3)]!=='PAID'){_0x26ac52[_0x5cfa13(0x18b)]=new Date();if(!_0xe7c60f['amountUSDT']){const _0x3a2e9d=await currencyService_1[_0x5cfa13(0x201)][_0x5cfa13(0x16d)](_0xe7c60f['amount'],_0xe7c60f['currency']);_0x26ac52[_0x5cfa13(0x111)]=_0x3a2e9d;const _0x990fb6=await this[_0x5cfa13(0x146)](_0xe7c60f[_0x5cfa13(0xfd)],_0xe7c60f['gateway']),_0xdb5055=_0x3a2e9d*(0x1-_0x990fb6/0x64);_0x26ac52['amountAfterGatewayCommissionUSDT']=_0xdb5055,_0x26ac52['gatewayCommissionRate']=_0x990fb6,console[_0x5cfa13(0x1ec)](_0x5cfa13(0x11b)+_0xe7c60f['id']+_0x5cfa13(0x113)),console[_0x5cfa13(0x1ec)](_0x5cfa13(0x1d0)+_0xe7c60f[_0x5cfa13(0x1c1)]+'\x20'+_0xe7c60f['currency']+'\x20->\x20'+_0x3a2e9d[_0x5cfa13(0x1d6)](0x6)+_0x5cfa13(0x1aa)),console[_0x5cfa13(0x1ec)](_0x5cfa13(0x1d7)+_0xe7c60f[_0x5cfa13(0x14e)]+_0x5cfa13(0x199)+_0x990fb6+'%'),console['log'](_0x5cfa13(0x1c2)+_0xdb5055[_0x5cfa13(0x1d6)](0x6)+_0x5cfa13(0x1aa));}console[_0x5cfa13(0x1ec)](_0x5cfa13(0x11b)+_0xe7c60f['id']+_0x5cfa13(0x1e2)+_0x26ac52['paidAt'][_0x5cfa13(0x1e4)]());}if(_0x38a067[_0x5cfa13(0x1c0)]){const _0x25bc2e=_0x38a067[_0x5cfa13(0x1c0)];_0x25bc2e[_0x5cfa13(0x172)]&&(_0x26ac52[_0x5cfa13(0x1f3)]=_0x25bc2e[_0x5cfa13(0x172)],console[_0x5cfa13(0x1ec)](_0x5cfa13(0x12f)+_0x25bc2e[_0x5cfa13(0x172)]));if(_0x25bc2e['bankDetails']){const _0xa2487=_0xe7c60f['adminNotes']||'',_0xecab7a=_0x5cfa13(0xff)+_0x25bc2e[_0x5cfa13(0x116)];_0x26ac52[_0x5cfa13(0x153)]=_0xa2487?_0xa2487+'\x0a\x0a'+_0xecab7a:_0xecab7a,console['log'](_0x5cfa13(0x1d3));}_0x25bc2e[_0x5cfa13(0x110)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x25bc2e[_0x5cfa13(0x110)]),_0x25bc2e['confirmedOn']&&console[_0x5cfa13(0x1ec)]('‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x25bc2e[_0x5cfa13(0x1f7)]);}await database_1['default'][_0x5cfa13(0x1eb)][_0x5cfa13(0x149)]({'where':{'id':_0xe7c60f['id']},'data':_0x26ac52});if(_0x38a067['status']===_0x5cfa13(0x18c)&&_0xe7c60f[_0x5cfa13(0xf3)]!==_0x5cfa13(0x18c)){console[_0x5cfa13(0x1ec)](_0x5cfa13(0x12e)+_0xe7c60f['id']+_0x5cfa13(0x17b));const _0x325a0f=await database_1['default']['payment'][_0x5cfa13(0x150)]({'where':{'id':_0xe7c60f['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x325a0f?.[_0x5cfa13(0x15c)]&&_0x325a0f[_0x5cfa13(0x105)])try{const _0x39f755=_0x325a0f[_0x5cfa13(0x105)];console['log']('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x39f755['id']+_0x5cfa13(0x15f)+_0x39f755[_0x5cfa13(0x1c9)]+_0x5cfa13(0x132)+_0x39f755['currentPayments']+',\x20status='+_0x39f755['status']);const _0x1d8f3e=_0x39f755[_0x5cfa13(0x1f6)]+0x1,_0x4d39e5=_0x39f755[_0x5cfa13(0x1c9)]===_0x5cfa13(0x13f)?_0x5cfa13(0x1a1):_0x39f755[_0x5cfa13(0xf3)];await database_1[_0x5cfa13(0x195)]['paymentLink'][_0x5cfa13(0x149)]({'where':{'id':_0x39f755['id']},'data':{'currentPayments':_0x1d8f3e,'status':_0x4d39e5,'updatedAt':new Date()}}),console[_0x5cfa13(0x1ec)](_0x5cfa13(0x1e9)+_0x39f755['id']+_0x5cfa13(0x179)+_0x39f755[_0x5cfa13(0x1f6)]+_0x5cfa13(0x118)+_0x1d8f3e+_0x5cfa13(0x19a)+_0x39f755[_0x5cfa13(0xf3)]+_0x5cfa13(0x118)+_0x4d39e5);}catch(_0x46f70c){console[_0x5cfa13(0x13c)](_0x5cfa13(0x1cb),_0x46f70c);}else console[_0x5cfa13(0x1ec)](_0x5cfa13(0x12e)+_0xe7c60f['id']+_0x5cfa13(0x130));}await database_1[_0x5cfa13(0x195)][_0x5cfa13(0x117)]['create']({'data':{'paymentId':_0xe7c60f['id'],'shopId':_0xe7c60f[_0x5cfa13(0xfd)],'event':'cointopay_status_check_'+_0x38a067[_0x5cfa13(0xf3)][_0x5cfa13(0x11f)](),'statusCode':0xc8,'responseBody':JSON[_0x5cfa13(0x1bb)]({'oldStatus':_0xe7c60f[_0x5cfa13(0xf3)],'newStatus':_0x38a067['status'],'paymentDetails':_0x38a067['paymentDetails'],'checkedAt':new Date()[_0x5cfa13(0x1e4)]()})}}),await this[_0x5cfa13(0x142)](_0xe7c60f,_0x38a067[_0x5cfa13(0xf3)]),await this['sendPaymentStatusNotification'](_0xe7c60f,_0x38a067['status']),_0x38a067[_0x5cfa13(0xf3)]!=='PENDING'&&(console[_0x5cfa13(0x1ec)](_0x5cfa13(0x140)+_0xe7c60f['id']+'\x20status\x20changed\x20to\x20'+_0x38a067[_0x5cfa13(0xf3)]+_0x5cfa13(0x1fd)),this[_0x5cfa13(0xf5)](_0xe7c60f['id'])),console[_0x5cfa13(0x1ec)](_0x5cfa13(0x1d9)+_0xe7c60f['id']+_0x5cfa13(0x185));}else console[_0x5cfa13(0x1ec)](_0x5cfa13(0x1df)+_0xe7c60f['id']+_0x5cfa13(0x144)+_0x38a067['status']+')'),this['logCoinToPayStatus'](_0xe7c60f['id'],_0xe7c60f[_0x5cfa13(0x168)],_0xe7c60f['status'],_0x38a067[_0x5cfa13(0xf3)],_0x5cfa13(0x1d5),{'statusUnchanged':!![],'paymentDetails':_0x38a067[_0x5cfa13(0x1c0)],'amount':_0x38a067[_0x5cfa13(0x1c1)],'currency':_0x38a067[_0x5cfa13(0x14d)],'shopId':_0xe7c60f[_0x5cfa13(0xfd)],'checkTimestamp':new Date()[_0x5cfa13(0x1e4)]()});}catch(_0x1693ef){console[_0x5cfa13(0x13c)](_0x5cfa13(0x180)+_0xe7c60f['id']+':',_0x1693ef),this[_0x5cfa13(0x193)](_0xe7c60f['id'],_0xe7c60f[_0x5cfa13(0x168)],_0x1693ef,_0x5cfa13(0x1d5),{'paymentAmount':_0xe7c60f['amount'],'paymentCurrency':_0xe7c60f['currency'],'shopId':_0xe7c60f[_0x5cfa13(0xfd)],'createdAt':_0xe7c60f[_0x5cfa13(0x1cc)]}),await database_1[_0x5cfa13(0x195)][_0x5cfa13(0x117)][_0x5cfa13(0x1f8)]({'data':{'paymentId':_0xe7c60f['id'],'shopId':_0xe7c60f[_0x5cfa13(0xfd)],'event':_0x5cfa13(0x122),'statusCode':0x1f4,'responseBody':JSON[_0x5cfa13(0x1bb)]({'error':_0x1693ef instanceof Error?_0x1693ef[_0x5cfa13(0x10e)]:_0x5cfa13(0x200),'gatewayPaymentId':_0xe7c60f[_0x5cfa13(0x168)],'checkedAt':new Date()[_0x5cfa13(0x1e4)]()})}});}}async[a42_0x468436(0x142)](_0xcfe705,_0x45ad9c){const _0x16467d=a42_0x468436,_0x4e2544=Date['now']();try{const _0x5990fc=_0xcfe705[_0x16467d(0x12c)],_0x3ccd76=_0x5990fc[_0x16467d(0x1bd)];if(!_0x3ccd76?.[_0x16467d(0x186)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5990fc['id']);return;}const _0x46d563=_0x45ad9c==='PAID'?_0x16467d(0x129):_0x45ad9c===_0x16467d(0x1d4)?_0x16467d(0x171):_0x45ad9c===_0x16467d(0x14f)?_0x16467d(0x171):_0x16467d(0x1ab);if(!_0x3ccd76[_0x16467d(0x1f0)]?.[_0x16467d(0xf8)](_0x46d563)){console[_0x16467d(0x1ec)](_0x16467d(0x15d)+_0x46d563+_0x16467d(0x161)+_0x5990fc['id']);return;}const _0x18967d=(0x0,gateway_1[_0x16467d(0x1ef)])(_0xcfe705['gateway'])||_0xcfe705[_0x16467d(0x14e)],_0xece23c={'event':_0x46d563,'payment':{'id':_0xcfe705['id'],'order_id':_0xcfe705[_0x16467d(0x1a3)],'gateway_order_id':_0xcfe705[_0x16467d(0x1c6)],'gateway':_0x18967d,'amount':_0xcfe705[_0x16467d(0x1c1)],'currency':_0xcfe705[_0x16467d(0x14d)],'status':_0x45ad9c[_0x16467d(0x11f)](),'customer_email':_0xcfe705['customerEmail'],'customer_name':_0xcfe705['customerName'],'created_at':_0xcfe705[_0x16467d(0x1cc)],'updated_at':new Date()}},_0x3aa478=await fetch(_0x3ccd76[_0x16467d(0x186)],{'method':'POST','headers':{'Content-Type':_0x16467d(0x1b2),'User-Agent':_0x16467d(0x178)},'body':JSON['stringify'](_0xece23c)}),_0x25c9d1=Date[_0x16467d(0x10c)]()-_0x4e2544,_0x20d8bf=_0x3aa478['ok']?_0x16467d(0x1e6):await _0x3aa478[_0x16467d(0x101)]();loggerService_1[_0x16467d(0x1e8)][_0x16467d(0x174)](_0xcfe705['shopId'],_0x3ccd76[_0x16467d(0x186)],_0x46d563,_0x3aa478[_0x16467d(0xf3)],_0x25c9d1,_0xece23c),console[_0x16467d(0x1ec)]('Shop\x20webhook\x20sent\x20to\x20'+_0x3ccd76[_0x16467d(0x186)]+_0x16467d(0x139)+_0x3aa478['status']+'\x20('+_0x25c9d1+_0x16467d(0x1ed));}catch(_0x3b2d62){console[_0x16467d(0x13c)](_0x16467d(0x123),_0x3b2d62),loggerService_1[_0x16467d(0x1e8)][_0x16467d(0x19f)](_0xcfe705[_0x16467d(0xfd)],_0xcfe705[_0x16467d(0x12c)]?.[_0x16467d(0x1bd)]?.[_0x16467d(0x186)]||_0x16467d(0x10f),_0x16467d(0x13a),_0x3b2d62,{});}}async[a42_0x468436(0x134)](_0x4e59a2,_0x375263){const _0x1c76c2=a42_0x468436;try{const _0x277031={'PENDING':'created','PAID':_0x1c76c2(0x197),'FAILED':_0x1c76c2(0x18d),'EXPIRED':_0x1c76c2(0x187)},_0x3bb448=_0x277031[_0x375263];if(!_0x3bb448||_0x3bb448===_0x1c76c2(0x18f))return;await telegramBotService_1[_0x1c76c2(0x107)][_0x1c76c2(0x1a0)](_0x4e59a2[_0x1c76c2(0xfd)],_0x4e59a2,_0x3bb448);}catch(_0x568652){console[_0x1c76c2(0x13c)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x568652);}}async['checkPaymentById'](_0x1363a4){const _0x49c539=a42_0x468436;console[_0x49c539(0x1ec)](_0x49c539(0x1a6)+_0x1363a4);const _0x4e66a6=await database_1[_0x49c539(0x195)]['payment'][_0x49c539(0x150)]({'where':{'id':_0x1363a4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4e66a6)throw new Error(_0x49c539(0x167));if(_0x4e66a6[_0x49c539(0x14e)]!==_0x49c539(0x19c)&&_0x4e66a6[_0x49c539(0x14e)]!==_0x49c539(0x11a))throw new Error(_0x49c539(0x173));console[_0x49c539(0x1ec)](_0x49c539(0x181)+_0x4e66a6[_0x49c539(0x14e)]+'\x20payment\x20'+_0x1363a4),await this[_0x49c539(0x143)](_0x4e66a6),console[_0x49c539(0x1ec)](_0x49c539(0x198)+_0x1363a4);}[a42_0x468436(0x157)](){const _0x5c24c5=a42_0x468436,_0x1fd726=this[_0x5c24c5(0x19b)]?this[_0x5c24c5(0x1c5)]:undefined,_0x2bb117=Array[_0x5c24c5(0x13d)](this[_0x5c24c5(0x141)][_0x5c24c5(0x1b3)]())[_0x5c24c5(0x1ce)](_0x4f6e95=>({'paymentId':_0x4f6e95[_0x5c24c5(0x14b)],'gatewayPaymentId':_0x4f6e95[_0x5c24c5(0x168)],'createdAt':_0x4f6e95[_0x5c24c5(0x1cc)],'timersCount':_0x4f6e95[_0x5c24c5(0x191)][_0x5c24c5(0x18e)]}));return{'isActive':!!this[_0x5c24c5(0x19b)],'globalCheckIntervalMinutes':this[_0x5c24c5(0x1c5)]/(0x3e8*0x3c),'expiryDays':this[_0x5c24c5(0x1ae)],'activeIndividualTimers':this['paymentTimers'][_0x5c24c5(0x14c)],'nextGlobalCheckIn':_0x1fd726,'paymentTimersDetails':_0x2bb117};}[a42_0x468436(0x19d)](_0x594d5d){const _0x4a92ba=a42_0x468436,_0x3f4648=this[_0x4a92ba(0x141)]['get'](_0x594d5d);if(_0x3f4648)return{'hasTimers':!![],'timersCount':_0x3f4648[_0x4a92ba(0x191)][_0x4a92ba(0x18e)],'createdAt':_0x3f4648[_0x4a92ba(0x1cc)],'gatewayPaymentId':_0x3f4648[_0x4a92ba(0x168)]};return{'hasTimers':![]};}async[a42_0x468436(0x146)](_0x5def0b,_0x5276f8){const _0x2a831f=a42_0x468436;try{const _0x58a731=await database_1[_0x2a831f(0x195)][_0x2a831f(0x12c)][_0x2a831f(0x150)]({'where':{'id':_0x5def0b},'select':{'gatewaySettings':!![]}});if(!_0x58a731?.[_0x2a831f(0x192)])return console[_0x2a831f(0x1ec)](_0x2a831f(0x1ad)+_0x5def0b+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x36e0c1=JSON['parse'](_0x58a731[_0x2a831f(0x192)]);for(const [_0x2b19a7,_0x42695e]of Object[_0x2a831f(0x1af)](_0x36e0c1)){if(_0x2b19a7[_0x2a831f(0x11f)]()===_0x5276f8[_0x2a831f(0x11f)]()){const _0x1715d7=_0x42695e['commission']||0xa;return console['log']('Gateway\x20'+_0x5276f8+'\x20commission\x20for\x20shop\x20'+_0x5def0b+':\x20'+_0x1715d7+'%'),_0x1715d7;}}return console['log'](_0x2a831f(0x115)+_0x5276f8+_0x2a831f(0x1a9)+_0x5def0b+_0x2a831f(0x1d8)),0xa;}catch(_0x2ce834){return console[_0x2a831f(0x13c)](_0x2a831f(0x125)+_0x5def0b+_0x2a831f(0x152)+_0x5276f8+':',_0x2ce834),0xa;}}}exports['CoinToPayStatusService']=CoinToPayStatusService,exports[a42_0x468436(0x162)]=new CoinToPayStatusService();