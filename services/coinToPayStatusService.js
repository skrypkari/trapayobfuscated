'use strict';const a50_0x45f70d=a50_0x1e29;function a50_0x4af6(){const _0x5d2402=['update','text','schedulePaymentChecks','timers','amount','495266qqMLeG','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','settings','\x20completed\x20for\x20payment\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','error','Shop\x20webhook\x20sent\x20to\x20','createdOn','length','commission','\x20marked\x20as\x20paid\x20at:\x20','iban','-day\x20timeout','coinToPayService','customerEmail','ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','\x20\x20\x20-\x20GatewayPaymentId:\x20','\x20is\x20older\x20than\x20','status','parse','8944842riRSFF','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20\x20\x20üìÖ\x20Time:\x20','\x20for\x20payment\x20','getTime','failed','EXPIRED','\x20pending\x20CoinToPay\x20payments','\x20status\x20changed\x20to\x20','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','description','timestamp','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','../types/gateway',',\x20stopping\x20individual\x20checks','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','ü™ô\x20[DEBUG]\x20Creating\x20','\x20amounts\x20calculated:','paymentLink','2\x20minutes','üìä\x20[CHECK]\x20Payment\x20','checkPaymentStatus','cointopay','delay','\x20days,\x20marking\x20as\x20EXPIRED','\x20USDT','üîç\x20[CHECK]\x20Checking\x20','\x20skipped,\x20','delete','amountAfterGatewayCommissionUSDT','üÜî\x20[CHECK]\x20Transaction\x20ID:\x20','gateway','cointopay_status_check_error','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','12368468akcoai','paidAt','COMPLETED','toFixed','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','\x20(after\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','gatewayOrderId','\x20expired','‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:','getGatewayIdByName','\x20to\x20','EXPIRY_DAYS','../config/database','logCoinToPayStatus','checkSinglePaymentById','loggerService','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20',',\x20status=','‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','.\x20Remaining\x20active\x20timers:\x20','getGatewayCommission',':\x20type=','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','\x20(age:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentLinkId','\x20with\x20status\x20','\x20has\x20no\x20gatewayPaymentId,\x20skipping','unknown','Failed\x20to\x20mark\x20payment\x20as\x20expired','default','payment','currency','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','log','\x20\x20\x20üìù\x20Details:','COINTOPAY_ERROR','\x20to\x20clear','‚è∞\x20[HOURLY]\x20Payment\x20','setDate','coinToPay2Service','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','162yIbrjV','has','\x20updated:\x20currentPayments=','CoinToPay2Service','gatewaySettings','\x20has\x20no\x20gatewayPaymentId','getDate','‚ùå\x20[HOURLY]\x20Payment\x20','üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#','‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#','üí∞\x20[CHECK]\x20Payment\x20','./currencyService','values','paymentTimers','Webhook\x20event\x20','\x20->\x20','telegramBotService','includes','webhook_send','__esModule','createdAt','cointopay_auto_expired','PAID','orderId','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','paymentId','POST','\x20status:\x20','stack','get','\x20commission\x20for\x20shop\x20','\x20is\x20valid\x20for\x20checking,\x20proceeding...','findUnique','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','toISOString','‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','paid','\x20\x20\x20Amount:\x20','webhookUrl','coinToPayStatusService','\x20in\x20shop\x20','\x20updated\x20successfully','created','checkPaymentById','catch','logWhiteDomainError','\x20\x20\x20‚ùå\x20Error:\x20','\x20not\x20found,\x20clearing\x20timers','checkExpiredPayments','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','status_check','ü™ô\x20[GLOBAL]\x20Found\x20','expired','Unknown\x20error','convertToUSDT','\x20in\x20','No\x20gateway\x20settings\x20found\x20for\x20shop\x20','gatewayCommissionRate','üßπ\x20[CHECK]\x20Payment\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','/status/','25561566QbtyQJ','findMany','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','‚úÖ\x20[CHECK]\x20Payment\x20','getServiceStats','checkAllPendingPayments','clearPaymentTimers','currentPayments','globalCheckInterval','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','./telegramBotService','sendPaymentStatusNotification','PENDING','\x20current\x20status:\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','\x20\x20\x20üìä\x20Status:\x20','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','not\x20confirmed',',\x20using\x20default\x2010%','./gateways/coinToPay2Service','webhookEvents','bankDetails','\x20\x20\x20-\x20Amount:\x20','\x20is\x20too\x20new\x20(','7986hQAmiY','\x20not\x20enabled\x20for\x20shop\x20','shopId','size','cointopay2','\x20seconds\x20(','__importDefault','\x20\x20\x20üìç\x20Source:\x20','logShopWebhookError','FAILED','\x20status\x20is\x20','sendPaymentNotification','logShopWebhookSent','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20\x20\x20üìù\x20Context:','\x20initial\x20timers\x20for\x20payment\x20','startPeriodicStatusCheck','CoinToPayService','floor','‚è∞\x20[GLOBAL]\x20Found\x20','\x20expired\x20CoinToPay\x20payments','type','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','confirmedOn','\x20not\x20found\x20in\x20database','paymentDetails','\x20\x20\x20-\x20paymentId:\x20',',\x20gateway\x20','\x20commission:\x20','./loggerService','GLOBAL_CHECK_INTERVAL_MS','COINTOPAY_STATUS_CHANGE','amountUSDT','üìà\x20[COINTOPAY]\x20Payment\x20','forEach','üè¶\x20[CHECK]\x20Bank\x20details\x20provided:\x20','Failed\x20to\x20send\x20shop\x20webhook:','Success','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','auto_expire','CoinToPayStatusService','sendShopWebhook','5\x20minutes','\x20payment\x20','create','now','\x20found:','4062760dgzBlE','shop','logCoinToPayError','push','gatewayPaymentId','transactionId','Gateway\x20','stopPeriodicStatusCheck','defineProperty','\x20status\x20unchanged\x20(','6946832ZeRppx','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','webhookLog','\x20days','toLowerCase','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','entries','payment.failed','checkSinglePayment','stringify','‚è∞\x20[EXPIRY]\x20Payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','getPaymentTimerInfo','5uEDqdM','\x20\x20\x20Amount\x20after\x20commission:\x20'];a50_0x4af6=function(){return _0x5d2402;};return a50_0x4af6();}(function(_0x4987e2,_0xf6be36){const _0x474652=a50_0x1e29,_0x3fc02a=_0x4987e2();while(!![]){try{const _0x452dad=-parseInt(_0x474652(0x186))/0x1+-parseInt(_0x474652(0x1e9))/0x2*(-parseInt(_0x474652(0x242))/0x3)+-parseInt(_0x474652(0x271))/0x4+-parseInt(_0x474652(0x288))/0x5*(parseInt(_0x474652(0x19a))/0x6)+parseInt(_0x474652(0x1bc))/0x7+-parseInt(_0x474652(0x27b))/0x8+parseInt(_0x474652(0x229))/0x9;if(_0x452dad===_0xf6be36)break;else _0x3fc02a['push'](_0x3fc02a['shift']());}catch(_0x5f343a){_0x3fc02a['push'](_0x3fc02a['shift']());}}}(a50_0x4af6,0xe891b));var __importDefault=this&&this[a50_0x45f70d(0x248)]||function(_0x5774e4){const _0x4ad909=a50_0x45f70d;return _0x5774e4&&_0x5774e4[_0x4ad909(0x1fc)]?_0x5774e4:{'default':_0x5774e4};};function a50_0x1e29(_0x28e49d,_0x14c176){_0x28e49d=_0x28e49d-0x184;const _0x4af6ff=a50_0x4af6();let _0x1e2930=_0x4af6ff[_0x28e49d];return _0x1e2930;}Object[a50_0x45f70d(0x279)](exports,a50_0x45f70d(0x1fc),{'value':!![]}),exports[a50_0x45f70d(0x213)]=exports[a50_0x45f70d(0x26a)]=void 0x0;const coinToPayService_1=require('./gateways/coinToPayService'),coinToPay2Service_1=require(a50_0x45f70d(0x23d)),gateway_1=require(a50_0x45f70d(0x1a7)),database_1=__importDefault(require(a50_0x45f70d(0x1ca))),telegramBotService_1=require(a50_0x45f70d(0x234)),loggerService_1=require(a50_0x45f70d(0x25f)),currencyService_1=require(a50_0x45f70d(0x1f4));class CoinToPayStatusService{constructor(){const _0x70c3ba=a50_0x45f70d;this[_0x70c3ba(0x231)]=null,this['GLOBAL_CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this['EXPIRY_DAYS']=0x5,this['paymentTimers']=new Map(),this[_0x70c3ba(0x193)]=new coinToPayService_1[(_0x70c3ba(0x253))](),this[_0x70c3ba(0x1e7)]=new coinToPay2Service_1[(_0x70c3ba(0x1ec))](),console['log']('ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2');}[a50_0x45f70d(0x28c)](_0x46cecf,_0xdbfd07){const _0x249caa=a50_0x45f70d;console['log'](_0x249caa(0x195)),console[_0x249caa(0x1e1)](_0x249caa(0x25c)+_0x46cecf),console[_0x249caa(0x1e1)](_0x249caa(0x1c3)+_0xdbfd07),this['clearPaymentTimers'](_0x46cecf);const _0x5f41ae=[],_0x40c6ff=new Date(),_0x677f2f=[{'delay':0x1*0x3c*0x3e8,'description':'1\x20minute'},{'delay':0x2*0x3c*0x3e8,'description':_0x249caa(0x1ad)},{'delay':0x5*0x3c*0x3e8,'description':_0x249caa(0x26c)},{'delay':0x5*0x3c*0x3e8,'description':_0x249caa(0x26c)}];console[_0x249caa(0x1e1)](_0x249caa(0x1aa)+_0x677f2f[_0x249caa(0x18e)]+_0x249caa(0x251)+_0x46cecf);let _0x37cf89=0x0;_0x677f2f[_0x249caa(0x264)]((_0x6697f3,_0x1042e5)=>{const _0x2f7544=_0x249caa;_0x37cf89+=_0x6697f3[_0x2f7544(0x1b1)];const _0x48726b=setTimeout(async()=>{const _0x1a7a28=_0x2f7544;console[_0x1a7a28(0x1e1)]('ü™ô\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1042e5+0x1)+'\x20triggered\x20for\x20payment\x20'+_0x46cecf+_0x1a7a28(0x1c1)+_0x6697f3[_0x1a7a28(0x1a4)]+')');try{await this[_0x1a7a28(0x1cc)](_0x46cecf),console['log']('‚úÖ\x20[TIMER]\x20Individual\x20check\x20#'+(_0x1042e5+0x1)+_0x1a7a28(0x189)+_0x46cecf);}catch(_0x54a86d){console[_0x1a7a28(0x18b)](_0x1a7a28(0x202)+(_0x1042e5+0x1)+_0x1a7a28(0x19d)+_0x46cecf+':',_0x54a86d),this[_0x1a7a28(0x273)](_0x46cecf,_0xdbfd07,_0x54a86d,_0x1a7a28(0x21e),{'checkNumber':_0x1042e5+0x1,'scheduledAfter':_0x6697f3[_0x1a7a28(0x1a4)],'isIndividualCheck':!![]});}},_0x37cf89);_0x5f41ae['push'](_0x48726b),console[_0x2f7544(0x1e1)](_0x2f7544(0x1f2)+(_0x1042e5+0x1)+_0x2f7544(0x19d)+_0x46cecf+_0x2f7544(0x223)+_0x37cf89/0x3e8+_0x2f7544(0x247)+_0x6697f3[_0x2f7544(0x1a4)]+')');});const _0x401bbc=setInterval(async()=>{const _0x4ab3bc=_0x249caa;console[_0x4ab3bc(0x1e1)](_0x4ab3bc(0x1a6)+_0x46cecf);try{const _0x54751a=await database_1[_0x4ab3bc(0x1dc)][_0x4ab3bc(0x1dd)]['findUnique']({'where':{'id':_0x46cecf},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x54751a){console[_0x4ab3bc(0x1e1)](_0x4ab3bc(0x1f0)+_0x46cecf+_0x4ab3bc(0x21b)),this[_0x4ab3bc(0x22f)](_0x46cecf);return;}console['log']('üìä\x20[HOURLY]\x20Payment\x20'+_0x46cecf+_0x4ab3bc(0x237)+_0x54751a['status']);if(_0x54751a[_0x4ab3bc(0x198)]!==_0x4ab3bc(0x236)){console[_0x4ab3bc(0x1e1)]('‚úÖ\x20[HOURLY]\x20Payment\x20'+_0x46cecf+_0x4ab3bc(0x24c)+_0x54751a[_0x4ab3bc(0x198)]+_0x4ab3bc(0x1a8)),this[_0x4ab3bc(0x22f)](_0x46cecf);return;}const _0x198544=Math[_0x4ab3bc(0x254)]((Date[_0x4ab3bc(0x26f)]()-_0x54751a[_0x4ab3bc(0x1fd)]['getTime']())/(0x3e8*0x3c*0x3c*0x18));if(_0x198544>=this[_0x4ab3bc(0x1c9)]){console[_0x4ab3bc(0x1e1)](_0x4ab3bc(0x1e5)+_0x46cecf+_0x4ab3bc(0x197)+this[_0x4ab3bc(0x1c9)]+_0x4ab3bc(0x18a)),this['clearPaymentTimers'](_0x46cecf);return;}await this[_0x4ab3bc(0x1cc)](_0x46cecf),console[_0x4ab3bc(0x1e1)](_0x4ab3bc(0x22b)+_0x46cecf);}catch(_0x27a53a){console[_0x4ab3bc(0x18b)](_0x4ab3bc(0x1ce)+_0x46cecf+':',_0x27a53a),this[_0x4ab3bc(0x273)](_0x46cecf,_0xdbfd07,_0x27a53a,_0x4ab3bc(0x21e),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x5f41ae[_0x249caa(0x274)](_0x401bbc),this[_0x249caa(0x1f6)]['set'](_0x46cecf,{'timers':_0x5f41ae,'paymentId':_0x46cecf,'gatewayPaymentId':_0xdbfd07,'createdAt':_0x40c6ff}),console[_0x249caa(0x1e1)](_0x249caa(0x20b)+_0x677f2f[_0x249caa(0x18e)]+_0x249caa(0x24f)+_0x46cecf),console[_0x249caa(0x1e1)](_0x249caa(0x1a9)+this[_0x249caa(0x1f6)]['size']),this[_0x249caa(0x1cb)](_0x46cecf,_0xdbfd07,_0x249caa(0x236),_0x249caa(0x236),_0x249caa(0x21e),{'action':'schedule_created','scheduledChecks':_0x677f2f[_0x249caa(0x18e)],'firstCheckIn':_0x677f2f[0x0][_0x249caa(0x1b1)]/0x3e8,'totalTimers':this[_0x249caa(0x1f6)]['size']});}[a50_0x45f70d(0x22f)](_0x4cb560){const _0x1afde8=a50_0x45f70d,_0x190809=this[_0x1afde8(0x1f6)]['get'](_0x4cb560);_0x190809?(console['log']('üßπ\x20[DEBUG]\x20Clearing\x20'+_0x190809['timers'][_0x1afde8(0x18e)]+'\x20timers\x20for\x20payment\x20'+_0x4cb560),_0x190809[_0x1afde8(0x184)][_0x1afde8(0x264)]((_0x733791,_0x57ef9e)=>{const _0x366672=_0x1afde8;_0x733791&&(clearTimeout(_0x733791),clearInterval(_0x733791),console[_0x366672(0x1e1)](_0x366672(0x1f1)+(_0x57ef9e+0x1)+_0x366672(0x19d)+_0x4cb560));}),this['paymentTimers'][_0x1afde8(0x1b6)](_0x4cb560),console[_0x1afde8(0x1e1)](_0x1afde8(0x232)+_0x4cb560+_0x1afde8(0x1d1)+this[_0x1afde8(0x1f6)][_0x1afde8(0x245)])):console[_0x1afde8(0x1e1)](_0x1afde8(0x21d)+_0x4cb560+_0x1afde8(0x1e4));}async[a50_0x45f70d(0x1cc)](_0x133b17){const _0x5bc4a5=a50_0x45f70d;console['log']('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x133b17);const _0x5f7c4c=await database_1[_0x5bc4a5(0x1dc)][_0x5bc4a5(0x1dd)][_0x5bc4a5(0x20a)]({'where':{'id':_0x133b17},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5f7c4c){console[_0x5bc4a5(0x1e1)]('‚ùå\x20[CHECK]\x20Payment\x20'+_0x133b17+_0x5bc4a5(0x25a));return;}console['log']('üìä\x20[CHECK]\x20Payment\x20'+_0x133b17+_0x5bc4a5(0x270)),console[_0x5bc4a5(0x1e1)]('\x20\x20\x20-\x20Gateway:\x20'+_0x5f7c4c[_0x5bc4a5(0x1b9)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x5f7c4c[_0x5bc4a5(0x198)]),console['log'](_0x5bc4a5(0x196)+_0x5f7c4c[_0x5bc4a5(0x275)]),console[_0x5bc4a5(0x1e1)](_0x5bc4a5(0x240)+_0x5f7c4c['amount']+'\x20'+_0x5f7c4c['currency']),console[_0x5bc4a5(0x1e1)]('\x20\x20\x20-\x20ShopId:\x20'+_0x5f7c4c[_0x5bc4a5(0x244)]);if(_0x5f7c4c['gateway']!==_0x5bc4a5(0x1b0)&&_0x5f7c4c['gateway']!=='cointopay2'){console[_0x5bc4a5(0x1e1)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x133b17+_0x5bc4a5(0x238)+_0x5f7c4c[_0x5bc4a5(0x1b9)]+')');return;}if(_0x5f7c4c[_0x5bc4a5(0x198)]!==_0x5bc4a5(0x236)){console[_0x5bc4a5(0x1e1)](_0x5bc4a5(0x1a3)+_0x133b17+_0x5bc4a5(0x24c)+_0x5f7c4c[_0x5bc4a5(0x198)]+_0x5bc4a5(0x1a8)),this[_0x5bc4a5(0x22f)](_0x133b17);return;}if(!_0x5f7c4c[_0x5bc4a5(0x275)]){console[_0x5bc4a5(0x1e1)]('‚ö†Ô∏è\x20[CHECK]\x20Payment\x20'+_0x133b17+_0x5bc4a5(0x1ee));return;}console[_0x5bc4a5(0x1e1)](_0x5bc4a5(0x22c)+_0x133b17+_0x5bc4a5(0x209)),await this[_0x5bc4a5(0x283)](_0x5f7c4c);}['logCoinToPayStatus'](_0x12465d,_0x177ba6,_0xe77334,_0xf323ab,_0x1fcf65,_0x187c6b){const _0x48604c=a50_0x45f70d,_0x4a1b6a={'type':_0x48604c(0x261),'paymentId':_0x12465d,'gatewayPaymentId':_0x177ba6,'oldStatus':_0xe77334,'newStatus':_0xf323ab,'source':_0x1fcf65,'timestamp':new Date()['toISOString'](),'details':_0x187c6b||{}};loggerService_1[_0x48604c(0x1cd)]['logCoinToPayStatus'](_0x4a1b6a),console['log']('ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20'+_0x12465d+'\x20('+_0x177ba6+')'),console[_0x48604c(0x1e1)](_0x48604c(0x239)+_0xe77334+_0x48604c(0x1f8)+_0xf323ab),console[_0x48604c(0x1e1)](_0x48604c(0x249)+_0x1fcf65),console[_0x48604c(0x1e1)](_0x48604c(0x19c)+_0x4a1b6a[_0x48604c(0x1a5)]),_0x187c6b&&console[_0x48604c(0x1e1)](_0x48604c(0x1e2),_0x187c6b);}[a50_0x45f70d(0x273)](_0x4d3a2b,_0x2906ab,_0x3924f6,_0x46b0c3,_0x499230){const _0x58a591=a50_0x45f70d,_0xe5df82={'type':_0x58a591(0x1e3),'paymentId':_0x4d3a2b,'gatewayPaymentId':_0x2906ab,'error':_0x3924f6 instanceof Error?{'message':_0x3924f6['message'],'stack':_0x3924f6[_0x58a591(0x206)]}:_0x3924f6,'source':_0x46b0c3,'timestamp':new Date()[_0x58a591(0x20e)](),'context':_0x499230||{}};loggerService_1[_0x58a591(0x1cd)]['logCoinToPayError'](_0xe5df82),console['error']('ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20'+_0x4d3a2b+'\x20('+_0x2906ab+')'),console['error'](_0x58a591(0x21a)+(_0x3924f6 instanceof Error?_0x3924f6['message']:_0x3924f6)),console[_0x58a591(0x18b)]('\x20\x20\x20üìç\x20Source:\x20'+_0x46b0c3),console[_0x58a591(0x18b)](_0x58a591(0x19c)+_0xe5df82[_0x58a591(0x1a5)]),_0x499230&&console['error'](_0x58a591(0x250),_0x499230);}[a50_0x45f70d(0x252)](){const _0x428a3e=a50_0x45f70d;console[_0x428a3e(0x1e1)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this['checkAllPendingPayments']()[_0x428a3e(0x218)](_0x2f70e6=>{const _0x2efca1=_0x428a3e;console[_0x2efca1(0x18b)](_0x2efca1(0x23a),_0x2f70e6);}),this['globalCheckInterval']=setInterval(async()=>{const _0x1bc68e=_0x428a3e;try{console[_0x1bc68e(0x1e1)](_0x1bc68e(0x280)),await this['checkAllPendingPayments'](),console[_0x1bc68e(0x1e1)](_0x1bc68e(0x286));}catch(_0x4b4512){console[_0x1bc68e(0x18b)](_0x1bc68e(0x20f),_0x4b4512);}},this[_0x428a3e(0x260)]),console['log']('‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a50_0x45f70d(0x278)](){const _0x1653e1=a50_0x45f70d;console[_0x1653e1(0x1e1)](_0x1653e1(0x1c0));this[_0x1653e1(0x231)]&&(clearInterval(this[_0x1653e1(0x231)]),this[_0x1653e1(0x231)]=null,console[_0x1653e1(0x1e1)](_0x1653e1(0x268)));const _0x413149=this[_0x1653e1(0x1f6)][_0x1653e1(0x245)];for(const [_0x22592f]of this[_0x1653e1(0x1f6)]){this[_0x1653e1(0x22f)](_0x22592f);}console[_0x1653e1(0x1e1)]('üõë\x20[SHUTDOWN]\x20Cleared\x20'+_0x413149+'\x20individual\x20payment\x20timers');}async[a50_0x45f70d(0x22e)](){const _0x194671=a50_0x45f70d;try{console[_0x194671(0x1e1)](_0x194671(0x258));const _0x53c8b3=await database_1[_0x194671(0x1dc)][_0x194671(0x1dd)][_0x194671(0x22a)]({'where':{'gateway':{'in':[_0x194671(0x1b0),_0x194671(0x246)]},'status':_0x194671(0x236),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x194671(0x21f)+_0x53c8b3['length']+_0x194671(0x1a1));if(_0x53c8b3[_0x194671(0x18e)]===0x0){console[_0x194671(0x1e1)](_0x194671(0x227));return;}const _0x21dd4b=await this[_0x194671(0x21c)](_0x53c8b3);console[_0x194671(0x1e1)](_0x194671(0x255)+_0x21dd4b[_0x194671(0x18e)]+_0x194671(0x256));let _0x5f0306=0x0,_0x5eacef=0x0;for(const _0x273ce8 of _0x53c8b3){try{if(_0x21dd4b[_0x194671(0x1fa)](_0x273ce8['id'])){console[_0x194671(0x1e1)](_0x194671(0x20d)+_0x273ce8['id']+_0x194671(0x1e0)),_0x5eacef++;continue;}if(this[_0x194671(0x1f6)][_0x194671(0x1ea)](_0x273ce8['id'])){console[_0x194671(0x1e1)]('‚è∞\x20[GLOBAL]\x20Payment\x20'+_0x273ce8['id']+_0x194671(0x27c)),_0x5eacef++;continue;}const _0x22d3e5=(Date[_0x194671(0x26f)]()-_0x273ce8[_0x194671(0x1fd)][_0x194671(0x19e)]())/(0x3e8*0x3c*0x3c);if(_0x22d3e5<0x1){console['log'](_0x194671(0x20d)+_0x273ce8['id']+_0x194671(0x241)+_0x22d3e5[_0x194671(0x1bf)](0x1)+'h),\x20skipping\x20global\x20check'),_0x5eacef++;continue;}console['log']('üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20'+_0x273ce8['id']+_0x194671(0x1d5)+_0x22d3e5[_0x194671(0x1bf)](0x1)+'h)'),await this[_0x194671(0x283)](_0x273ce8),_0x5f0306++,await new Promise(_0x6f9932=>setTimeout(_0x6f9932,0x7d0));}catch(_0xc018c1){console[_0x194671(0x18b)]('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20'+_0x273ce8['id']+':',_0xc018c1),this[_0x194671(0x273)](_0x273ce8['id'],_0x273ce8[_0x194671(0x275)]||_0x194671(0x1da),_0xc018c1,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x273ce8['amount'],'paymentCurrency':_0x273ce8[_0x194671(0x1de)],'shopId':_0x273ce8[_0x194671(0x244)],'createdAt':_0x273ce8[_0x194671(0x1fd)]}),loggerService_1[_0x194671(0x1cd)][_0x194671(0x219)](_0x194671(0x1b0),_0x194671(0x228)+_0x273ce8['gatewayPaymentId'],_0xc018c1);}}console[_0x194671(0x1e1)](_0x194671(0x19b)+_0x5f0306+'\x20checked,\x20'+_0x5eacef+_0x194671(0x1b5)+_0x21dd4b[_0x194671(0x18e)]+_0x194671(0x1c5));}catch(_0x1b1d6c){console['error'](_0x194671(0x1d4),_0x1b1d6c);}}async[a50_0x45f70d(0x21c)](_0x56b01f){const _0x1636e8=a50_0x45f70d,_0x4729f6=[],_0x25dec7=new Date();_0x25dec7[_0x1636e8(0x1e6)](_0x25dec7[_0x1636e8(0x1ef)]()-this[_0x1636e8(0x1c9)]),console[_0x1636e8(0x1e1)](_0x1636e8(0x233)+this['EXPIRY_DAYS']+'\x20days\x20(created\x20before\x20'+_0x25dec7[_0x1636e8(0x20e)]()+')');for(const _0x38b45c of _0x56b01f){if(_0x38b45c[_0x1636e8(0x1fd)]<_0x25dec7){console[_0x1636e8(0x1e1)](_0x1636e8(0x285)+_0x38b45c['id']+_0x1636e8(0x197)+this[_0x1636e8(0x1c9)]+_0x1636e8(0x1b2));try{this[_0x1636e8(0x1cb)](_0x38b45c['id'],_0x38b45c['gatewayPaymentId']||_0x1636e8(0x1da),'PENDING',_0x1636e8(0x1a0),_0x1636e8(0x269),{'reason':'Payment\x20older\x20than\x20'+this[_0x1636e8(0x1c9)]+'\x20days','createdAt':_0x38b45c[_0x1636e8(0x1fd)],'daysSinceCreation':Math[_0x1636e8(0x254)]((Date[_0x1636e8(0x26f)]()-_0x38b45c[_0x1636e8(0x1fd)][_0x1636e8(0x19e)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x38b45c[_0x1636e8(0x185)],'paymentCurrency':_0x38b45c[_0x1636e8(0x1de)],'shopId':_0x38b45c['shopId']}),await database_1[_0x1636e8(0x1dc)]['payment']['update']({'where':{'id':_0x38b45c['id']},'data':{'status':'EXPIRED','updatedAt':new Date()}}),await database_1['default'][_0x1636e8(0x27d)][_0x1636e8(0x26e)]({'data':{'paymentId':_0x38b45c['id'],'shopId':_0x38b45c[_0x1636e8(0x244)],'event':_0x1636e8(0x1fe),'statusCode':0xc8,'responseBody':JSON[_0x1636e8(0x284)]({'reason':'Payment\x20older\x20than\x20'+this[_0x1636e8(0x1c9)]+_0x1636e8(0x27e),'createdAt':_0x38b45c[_0x1636e8(0x1fd)],'expiredAt':new Date()[_0x1636e8(0x20e)](),'daysSinceCreation':Math[_0x1636e8(0x254)]((Date['now']()-_0x38b45c[_0x1636e8(0x1fd)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x1636e8(0x26b)](_0x38b45c,_0x1636e8(0x1a0)),await this[_0x1636e8(0x235)](_0x38b45c,_0x1636e8(0x1a0)),this[_0x1636e8(0x22f)](_0x38b45c['id']),_0x4729f6[_0x1636e8(0x274)](_0x38b45c['id']),console[_0x1636e8(0x1e1)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x38b45c['id']+'\x20marked\x20as\x20EXPIRED\x20due\x20to\x20'+this[_0x1636e8(0x1c9)]+_0x1636e8(0x192));}catch(_0x48b47a){console[_0x1636e8(0x18b)]('‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20'+_0x38b45c['id']+':',_0x48b47a),this[_0x1636e8(0x273)](_0x38b45c['id'],_0x38b45c[_0x1636e8(0x275)]||_0x1636e8(0x1da),_0x48b47a,_0x1636e8(0x269),{'reason':_0x1636e8(0x1db),'createdAt':_0x38b45c['createdAt'],'daysSinceCreation':Math['floor']((Date[_0x1636e8(0x26f)]()-_0x38b45c[_0x1636e8(0x1fd)][_0x1636e8(0x19e)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x4729f6;}async['checkSinglePayment'](_0x35852){const _0x364e9e=a50_0x45f70d;if(!_0x35852[_0x364e9e(0x275)]){console['log'](_0x364e9e(0x1a3)+_0x35852['id']+_0x364e9e(0x1d9));return;}console[_0x364e9e(0x1e1)](_0x364e9e(0x1b4)+_0x35852[_0x364e9e(0x1b9)]+_0x364e9e(0x26d)+_0x35852['id']+'\x20('+_0x35852['gatewayPaymentId']+')');try{let _0x56deef;_0x35852[_0x364e9e(0x1b9)]===_0x364e9e(0x246)?(_0x56deef=await this[_0x364e9e(0x1e7)]['checkPaymentStatus'](_0x35852[_0x364e9e(0x275)]),console[_0x364e9e(0x1e1)](_0x364e9e(0x20c)+_0x35852['id']+_0x364e9e(0x205)+_0x56deef['status'])):(_0x56deef=await this['coinToPayService'][_0x364e9e(0x1af)](_0x35852[_0x364e9e(0x275)]),console[_0x364e9e(0x1e1)](_0x364e9e(0x1c2)+_0x35852['id']+'\x20status:\x20'+_0x56deef[_0x364e9e(0x198)]));_0x56deef[_0x364e9e(0x25b)]&&console[_0x364e9e(0x1e1)](_0x364e9e(0x1ae)+_0x35852['id']+'\x20details:',{'iban':_0x56deef[_0x364e9e(0x25b)][_0x364e9e(0x191)]||'not\x20found','transactionId':_0x56deef[_0x364e9e(0x25b)]['transactionId'],'createdOn':_0x56deef[_0x364e9e(0x25b)][_0x364e9e(0x18d)],'confirmedOn':_0x56deef['paymentDetails'][_0x364e9e(0x259)]||_0x364e9e(0x23b)});if(_0x56deef[_0x364e9e(0x198)]!==_0x35852[_0x364e9e(0x198)]){console[_0x364e9e(0x1e1)]('üîÑ\x20[CHECK]\x20Updating\x20payment\x20'+_0x35852['id']+'\x20status\x20from\x20'+_0x35852[_0x364e9e(0x198)]+_0x364e9e(0x1c8)+_0x56deef[_0x364e9e(0x198)]),this[_0x364e9e(0x1cb)](_0x35852['id'],_0x35852[_0x364e9e(0x275)],_0x35852[_0x364e9e(0x198)],_0x56deef[_0x364e9e(0x198)],_0x364e9e(0x21e),{'paymentDetails':_0x56deef['paymentDetails'],'amount':_0x56deef[_0x364e9e(0x185)],'currency':_0x56deef[_0x364e9e(0x1de)],'shopId':_0x35852[_0x364e9e(0x244)],'checkTimestamp':new Date()[_0x364e9e(0x20e)]()});const _0x5ee671={'status':_0x56deef[_0x364e9e(0x198)],'updatedAt':new Date()};if(_0x56deef[_0x364e9e(0x198)]===_0x364e9e(0x1ff)&&_0x35852[_0x364e9e(0x198)]!==_0x364e9e(0x1ff)){_0x5ee671[_0x364e9e(0x1bd)]=new Date();if(!_0x35852['amountUSDT']){const _0x199b7a=await currencyService_1['currencyService'][_0x364e9e(0x222)](_0x35852['amount'],_0x35852[_0x364e9e(0x1de)]);_0x5ee671[_0x364e9e(0x262)]=_0x199b7a;const _0x1f1caf=await this[_0x364e9e(0x1d2)](_0x35852[_0x364e9e(0x244)],_0x35852[_0x364e9e(0x1b9)]),_0x58d6bf=_0x199b7a*(0x1-_0x1f1caf/0x64);_0x5ee671[_0x364e9e(0x1b7)]=_0x58d6bf,_0x5ee671[_0x364e9e(0x225)]=_0x1f1caf,console[_0x364e9e(0x1e1)]('üí∞\x20[CHECK]\x20Payment\x20'+_0x35852['id']+_0x364e9e(0x1ab)),console[_0x364e9e(0x1e1)](_0x364e9e(0x211)+_0x35852[_0x364e9e(0x185)]+'\x20'+_0x35852[_0x364e9e(0x1de)]+_0x364e9e(0x1f8)+_0x199b7a[_0x364e9e(0x1bf)](0x6)+_0x364e9e(0x1b3)),console[_0x364e9e(0x1e1)]('\x20\x20\x20Gateway\x20'+_0x35852[_0x364e9e(0x1b9)]+_0x364e9e(0x25e)+_0x1f1caf+'%'),console[_0x364e9e(0x1e1)](_0x364e9e(0x289)+_0x58d6bf[_0x364e9e(0x1bf)](0x6)+_0x364e9e(0x1b3));}console[_0x364e9e(0x1e1)](_0x364e9e(0x1f3)+_0x35852['id']+_0x364e9e(0x190)+_0x5ee671[_0x364e9e(0x1bd)][_0x364e9e(0x20e)]());}if(_0x56deef[_0x364e9e(0x25b)]){const _0x4cfc0b=_0x56deef[_0x364e9e(0x25b)];_0x4cfc0b[_0x364e9e(0x191)]&&(_0x5ee671['remitterIban']=_0x4cfc0b[_0x364e9e(0x191)],console[_0x364e9e(0x1e1)]('üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20'+_0x4cfc0b[_0x364e9e(0x191)])),_0x4cfc0b[_0x364e9e(0x23f)]&&console[_0x364e9e(0x1e1)](_0x364e9e(0x265)+_0x4cfc0b[_0x364e9e(0x23f)]),_0x4cfc0b[_0x364e9e(0x276)]&&console[_0x364e9e(0x1e1)](_0x364e9e(0x1b8)+_0x4cfc0b[_0x364e9e(0x276)]),_0x4cfc0b[_0x364e9e(0x259)]&&console[_0x364e9e(0x1e1)](_0x364e9e(0x1df)+_0x4cfc0b[_0x364e9e(0x259)]);}await database_1[_0x364e9e(0x1dc)][_0x364e9e(0x1dd)][_0x364e9e(0x28a)]({'where':{'id':_0x35852['id']},'data':_0x5ee671});if(_0x56deef[_0x364e9e(0x198)]===_0x364e9e(0x1ff)&&_0x35852[_0x364e9e(0x198)]!==_0x364e9e(0x1ff)){console[_0x364e9e(0x1e1)](_0x364e9e(0x263)+_0x35852['id']+_0x364e9e(0x1e8));const _0x4f1a15=await database_1[_0x364e9e(0x1dc)]['payment'][_0x364e9e(0x20a)]({'where':{'id':_0x35852['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x4f1a15?.[_0x364e9e(0x1d7)]&&_0x4f1a15['paymentLink'])try{const _0x3a3df3=_0x4f1a15[_0x364e9e(0x1ac)];console[_0x364e9e(0x1e1)]('üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20'+_0x3a3df3['id']+_0x364e9e(0x1d3)+_0x3a3df3[_0x364e9e(0x257)]+',\x20currentPayments='+_0x3a3df3[_0x364e9e(0x230)]+_0x364e9e(0x1cf)+_0x3a3df3[_0x364e9e(0x198)]);const _0x423294=_0x3a3df3[_0x364e9e(0x230)]+0x1,_0x2fffdc=_0x3a3df3[_0x364e9e(0x257)]==='SINGLE'?_0x364e9e(0x1be):_0x3a3df3[_0x364e9e(0x198)];await database_1[_0x364e9e(0x1dc)][_0x364e9e(0x1ac)]['update']({'where':{'id':_0x3a3df3['id']},'data':{'currentPayments':_0x423294,'status':_0x2fffdc,'updatedAt':new Date()}}),console[_0x364e9e(0x1e1)]('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x3a3df3['id']+_0x364e9e(0x1eb)+_0x3a3df3[_0x364e9e(0x230)]+_0x364e9e(0x1f8)+_0x423294+',\x20status='+_0x3a3df3[_0x364e9e(0x198)]+'\x20->\x20'+_0x2fffdc);}catch(_0x382c2f){console[_0x364e9e(0x18b)](_0x364e9e(0x1c6),_0x382c2f);}else console[_0x364e9e(0x1e1)](_0x364e9e(0x263)+_0x35852['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x364e9e(0x1dc)][_0x364e9e(0x27d)][_0x364e9e(0x26e)]({'data':{'paymentId':_0x35852['id'],'shopId':_0x35852[_0x364e9e(0x244)],'event':'cointopay_status_check_'+_0x56deef['status'][_0x364e9e(0x27f)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x35852[_0x364e9e(0x198)],'newStatus':_0x56deef[_0x364e9e(0x198)],'paymentDetails':_0x56deef[_0x364e9e(0x25b)],'checkedAt':new Date()[_0x364e9e(0x20e)]()})}}),await this[_0x364e9e(0x26b)](_0x35852,_0x56deef[_0x364e9e(0x198)]),await this['sendPaymentStatusNotification'](_0x35852,_0x56deef[_0x364e9e(0x198)]),_0x56deef[_0x364e9e(0x198)]!==_0x364e9e(0x236)&&(console[_0x364e9e(0x1e1)](_0x364e9e(0x226)+_0x35852['id']+_0x364e9e(0x1a2)+_0x56deef[_0x364e9e(0x198)]+',\x20clearing\x20individual\x20timers'),this[_0x364e9e(0x22f)](_0x35852['id'])),console[_0x364e9e(0x1e1)]('‚úÖ\x20[CHECK]\x20Payment\x20'+_0x35852['id']+_0x364e9e(0x215));}else console['log'](_0x364e9e(0x1ae)+_0x35852['id']+_0x364e9e(0x27a)+_0x56deef[_0x364e9e(0x198)]+')'),this[_0x364e9e(0x1cb)](_0x35852['id'],_0x35852['gatewayPaymentId'],_0x35852[_0x364e9e(0x198)],_0x56deef[_0x364e9e(0x198)],_0x364e9e(0x21e),{'statusUnchanged':!![],'paymentDetails':_0x56deef[_0x364e9e(0x25b)],'amount':_0x56deef[_0x364e9e(0x185)],'currency':_0x56deef[_0x364e9e(0x1de)],'shopId':_0x35852['shopId'],'checkTimestamp':new Date()[_0x364e9e(0x20e)]()});}catch(_0x205b4){console[_0x364e9e(0x18b)](_0x364e9e(0x1d0)+_0x35852['id']+':',_0x205b4),this['logCoinToPayError'](_0x35852['id'],_0x35852[_0x364e9e(0x275)],_0x205b4,_0x364e9e(0x21e),{'paymentAmount':_0x35852[_0x364e9e(0x185)],'paymentCurrency':_0x35852[_0x364e9e(0x1de)],'shopId':_0x35852[_0x364e9e(0x244)],'createdAt':_0x35852[_0x364e9e(0x1fd)]}),await database_1[_0x364e9e(0x1dc)][_0x364e9e(0x27d)][_0x364e9e(0x26e)]({'data':{'paymentId':_0x35852['id'],'shopId':_0x35852[_0x364e9e(0x244)],'event':_0x364e9e(0x1ba),'statusCode':0x1f4,'responseBody':JSON['stringify']({'error':_0x205b4 instanceof Error?_0x205b4['message']:_0x364e9e(0x221),'gatewayPaymentId':_0x35852['gatewayPaymentId'],'checkedAt':new Date()['toISOString']()})}});}}async[a50_0x45f70d(0x26b)](_0x5324c0,_0x417344){const _0x1fa240=a50_0x45f70d,_0x5d0da5=Date[_0x1fa240(0x26f)]();try{const _0x4162d3=_0x5324c0[_0x1fa240(0x272)],_0x44705a=_0x4162d3[_0x1fa240(0x188)];if(!_0x44705a?.[_0x1fa240(0x212)]){console[_0x1fa240(0x1e1)](_0x1fa240(0x1bb)+_0x4162d3['id']);return;}const _0x5043d7=_0x417344===_0x1fa240(0x1ff)?'payment.success':_0x417344===_0x1fa240(0x24b)?_0x1fa240(0x282):_0x417344===_0x1fa240(0x1a0)?_0x1fa240(0x282):'payment.pending';if(!_0x44705a[_0x1fa240(0x23e)]?.[_0x1fa240(0x1fa)](_0x5043d7)){console['log'](_0x1fa240(0x1f7)+_0x5043d7+_0x1fa240(0x243)+_0x4162d3['id']);return;}const _0x174e49=(0x0,gateway_1[_0x1fa240(0x1c7)])(_0x5324c0[_0x1fa240(0x1b9)])||_0x5324c0[_0x1fa240(0x1b9)],_0x5b8a73={'event':_0x5043d7,'payment':{'id':_0x5324c0['id'],'order_id':_0x5324c0[_0x1fa240(0x200)],'gateway_order_id':_0x5324c0[_0x1fa240(0x1c4)],'gateway':_0x174e49,'amount':_0x5324c0[_0x1fa240(0x185)],'currency':_0x5324c0['currency'],'status':_0x417344[_0x1fa240(0x27f)](),'customer_email':_0x5324c0[_0x1fa240(0x194)],'customer_name':_0x5324c0['customerName'],'created_at':_0x5324c0[_0x1fa240(0x1fd)],'updated_at':new Date()}},_0x20637e=await fetch(_0x44705a[_0x1fa240(0x212)],{'method':_0x1fa240(0x204),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0'},'body':JSON[_0x1fa240(0x284)](_0x5b8a73)}),_0x49101e=Date[_0x1fa240(0x26f)]()-_0x5d0da5,_0x14dc55=_0x20637e['ok']?_0x1fa240(0x267):await _0x20637e[_0x1fa240(0x28b)]();loggerService_1['loggerService'][_0x1fa240(0x24e)](_0x5324c0[_0x1fa240(0x244)],_0x44705a[_0x1fa240(0x212)],_0x5043d7,_0x20637e[_0x1fa240(0x198)],_0x49101e,_0x5b8a73),console[_0x1fa240(0x1e1)](_0x1fa240(0x18c)+_0x44705a[_0x1fa240(0x212)]+_0x1fa240(0x1d8)+_0x20637e[_0x1fa240(0x198)]+'\x20('+_0x49101e+'ms)');}catch(_0x4ec9c6){console[_0x1fa240(0x18b)](_0x1fa240(0x266),_0x4ec9c6),loggerService_1[_0x1fa240(0x1cd)][_0x1fa240(0x24a)](_0x5324c0['shopId'],_0x5324c0[_0x1fa240(0x272)]?.[_0x1fa240(0x188)]?.[_0x1fa240(0x212)]||_0x1fa240(0x1da),_0x1fa240(0x1fb),_0x4ec9c6,{});}}async[a50_0x45f70d(0x235)](_0x5c1c90,_0x1a34cd){const _0x36793c=a50_0x45f70d;try{const _0x1e3f72={'PENDING':_0x36793c(0x216),'PAID':_0x36793c(0x210),'FAILED':_0x36793c(0x19f),'EXPIRED':_0x36793c(0x220)},_0x34ded0=_0x1e3f72[_0x1a34cd];if(!_0x34ded0||_0x34ded0===_0x36793c(0x216))return;await telegramBotService_1[_0x36793c(0x1f9)][_0x36793c(0x24d)](_0x5c1c90[_0x36793c(0x244)],_0x5c1c90,_0x34ded0);}catch(_0x3b99aa){console[_0x36793c(0x18b)](_0x36793c(0x1d6),_0x3b99aa);}}async[a50_0x45f70d(0x217)](_0x45d65f){const _0x55dec4=a50_0x45f70d;console[_0x55dec4(0x1e1)](_0x55dec4(0x187)+_0x45d65f);const _0x3a1425=await database_1[_0x55dec4(0x1dc)][_0x55dec4(0x1dd)]['findUnique']({'where':{'id':_0x45d65f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3a1425)throw new Error('Payment\x20not\x20found');if(_0x3a1425['gateway']!==_0x55dec4(0x1b0)&&_0x3a1425[_0x55dec4(0x1b9)]!==_0x55dec4(0x246))throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x55dec4(0x1e1)]('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x3a1425[_0x55dec4(0x1b9)]+'\x20payment\x20'+_0x45d65f),await this['checkSinglePayment'](_0x3a1425),console[_0x55dec4(0x1e1)](_0x55dec4(0x201)+_0x45d65f);}[a50_0x45f70d(0x22d)](){const _0x1e0321=a50_0x45f70d,_0x24d033=this[_0x1e0321(0x231)]?this[_0x1e0321(0x260)]:undefined,_0x462a21=Array['from'](this[_0x1e0321(0x1f6)][_0x1e0321(0x1f5)]())['map'](_0x17bd44=>({'paymentId':_0x17bd44[_0x1e0321(0x203)],'gatewayPaymentId':_0x17bd44[_0x1e0321(0x275)],'createdAt':_0x17bd44['createdAt'],'timersCount':_0x17bd44[_0x1e0321(0x184)][_0x1e0321(0x18e)]}));return{'isActive':!!this[_0x1e0321(0x231)],'globalCheckIntervalMinutes':this[_0x1e0321(0x260)]/(0x3e8*0x3c),'expiryDays':this[_0x1e0321(0x1c9)],'activeIndividualTimers':this[_0x1e0321(0x1f6)][_0x1e0321(0x245)],'nextGlobalCheckIn':_0x24d033,'paymentTimersDetails':_0x462a21};}[a50_0x45f70d(0x287)](_0x4e7f5b){const _0x5e6e98=a50_0x45f70d,_0xc3a03=this['paymentTimers'][_0x5e6e98(0x207)](_0x4e7f5b);if(_0xc3a03)return{'hasTimers':!![],'timersCount':_0xc3a03[_0x5e6e98(0x184)][_0x5e6e98(0x18e)],'createdAt':_0xc3a03[_0x5e6e98(0x1fd)],'gatewayPaymentId':_0xc3a03[_0x5e6e98(0x275)]};return{'hasTimers':![]};}async[a50_0x45f70d(0x1d2)](_0x483fa6,_0x5c602f){const _0x5db184=a50_0x45f70d;try{const _0x3355ac=await database_1[_0x5db184(0x1dc)][_0x5db184(0x272)]['findUnique']({'where':{'id':_0x483fa6},'select':{'gatewaySettings':!![]}});if(!_0x3355ac?.['gatewaySettings'])return console[_0x5db184(0x1e1)](_0x5db184(0x224)+_0x483fa6+',\x20using\x20default\x20commission\x2010%'),0xa;const _0x2accf0=JSON[_0x5db184(0x199)](_0x3355ac[_0x5db184(0x1ed)]);for(const [_0x18c8eb,_0x589550]of Object[_0x5db184(0x281)](_0x2accf0)){if(_0x18c8eb[_0x5db184(0x27f)]()===_0x5c602f[_0x5db184(0x27f)]()){const _0x1e39aa=_0x589550[_0x5db184(0x18f)]||0xa;return console[_0x5db184(0x1e1)](_0x5db184(0x277)+_0x5c602f+_0x5db184(0x208)+_0x483fa6+':\x20'+_0x1e39aa+'%'),_0x1e39aa;}}return console[_0x5db184(0x1e1)]('No\x20specific\x20commission\x20found\x20for\x20gateway\x20'+_0x5c602f+_0x5db184(0x214)+_0x483fa6+_0x5db184(0x23c)),0xa;}catch(_0x4cc57c){return console[_0x5db184(0x18b)]('Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20'+_0x483fa6+_0x5db184(0x25d)+_0x5c602f+':',_0x4cc57c),0xa;}}}exports[a50_0x45f70d(0x26a)]=CoinToPayStatusService,exports[a50_0x45f70d(0x213)]=new CoinToPayStatusService();