'use strict';const a42_0x11adb6=a42_0x5b2a;(function(_0x333f40,_0x16447e){const _0x37ecca=a42_0x5b2a,_0x5a11f3=_0x333f40();while(!![]){try{const _0x5b6fc8=-parseInt(_0x37ecca(0x130))/0x1*(-parseInt(_0x37ecca(0x1b6))/0x2)+-parseInt(_0x37ecca(0xda))/0x3*(parseInt(_0x37ecca(0x112))/0x4)+-parseInt(_0x37ecca(0xc7))/0x5*(parseInt(_0x37ecca(0x1a7))/0x6)+-parseInt(_0x37ecca(0x110))/0x7*(-parseInt(_0x37ecca(0xed))/0x8)+parseInt(_0x37ecca(0x199))/0x9*(parseInt(_0x37ecca(0x126))/0xa)+parseInt(_0x37ecca(0x1c0))/0xb*(parseInt(_0x37ecca(0x1af))/0xc)+-parseInt(_0x37ecca(0x172))/0xd;if(_0x5b6fc8===_0x16447e)break;else _0x5a11f3['push'](_0x5a11f3['shift']());}catch(_0x31d1fc){_0x5a11f3['push'](_0x5a11f3['shift']());}}}(a42_0x46f7,0xdc6a0));function a42_0x5b2a(_0x533b31,_0x8319d9){const _0x46f7b0=a42_0x46f7();return a42_0x5b2a=function(_0x5b2ab2,_0xa478a5){_0x5b2ab2=_0x5b2ab2-0xc4;let _0x5c7c4c=_0x46f7b0[_0x5b2ab2];return _0x5c7c4c;},a42_0x5b2a(_0x533b31,_0x8319d9);}function a42_0x46f7(){const _0x5c0130=['‚ùå\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','‚è∞\x20[GLOBAL]\x20Payment\x20','\x20became\x20PAID\x20via\x20status\x20check,\x20updating\x20payment\x20link','\x20for\x20payment\x20',',\x20status=','5985PuGckM','globalCheckInterval','coinToPay2Service','\x20payment\x20','-day\x20timeout','unknown','üßπ\x20[CHECK]\x20Payment\x20','cointopay2','‚úÖ\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)','set','findUnique','\x20skipped,\x20','paymentLink','‚ùå\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','Webhook\x20event\x20','\x20triggered\x20for\x20payment\x20','push','Payment\x20System/1.0','amountUSDT','3848rbYIaO','üîç\x20[CHECK]\x20Checking\x20','No\x20specific\x20commission\x20found\x20for\x20gateway\x20','stopPeriodicStatusCheck',',\x20currentPayments=','\x20days\x20(created\x20before\x20','CoinToPay2Service','\x20\x20\x20-\x20GatewayPaymentId:\x20','üìä\x20[CHECK]\x20CoinToPay\x20payment\x20','‚úÖ\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','checkExpiredPayments','iban',',\x20stopping\x20individual\x20checks','webhookLog','/status/','gatewayPaymentId','type','coinToPayService','üè¶\x20[CHECK]\x20Saved\x20IBAN:\x20','gatewayOrderId','‚ùå\x20[TIMER]\x20Failed\x20individual\x20check\x20#','includes','shop','\x20days\x20without\x20payment\x20confirmation','‚úÖ\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20','logCoinToPayStatus','schedule_created','error','\x20has\x20individual\x20timers,\x20skipping\x20global\x20check','customerEmail','\x20found:','paidAt','\x20with\x20status\x20','üìä\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','ü™ô\x20[DEBUG]\x20Creating\x20','10773uvvcsY','CoinToPayStatusService','1304NGcxel','transactionId','5\x20minutes','bankDetails','sendPaymentNotification','length','Shop\x20webhook\x20sent\x20to\x20','‚ùå\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','üìä\x20[CHECK]\x20CoinToPay2\x20payment\x20','PENDING','EXPIRED','currencyService','orderId','\x20days','cointopay','\x20\x20\x20üìù\x20Context:',':\x20type=','auto_expire','findMany','\x20\x20\x20üìÖ\x20Time:\x20','269650CFlCWP','getTime','checkPaymentStatus','\x20has\x20no\x20gatewayPaymentId,\x20skipping','\x20amounts\x20calculated:','SINGLE','üîç\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','üìà\x20[COINTOPAY]\x20Found\x20payment\x20link\x20','amountAfterGatewayCommissionUSDT','COINTOPAY_STATUS_CHANGE','6065SPZfuZ','1\x20minute','payment','Failed\x20to\x20send\x20shop\x20webhook:','‚ö†Ô∏è\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','coinToPayStatusService','üè¶\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes',',\x20using\x20default\x20commission\x2010%','ü™ô\x20[ERROR]\x20CoinToPay\x20Error:\x20','\x20(age:\x20','‚è∞\x20[HOURLY]\x20Payment\x20','stack','\x20\x20\x20-\x20ShopId:\x20','./gateways/coinToPayService','\x20is\x20older\x20than\x20','POST','paymentTimers','‚úÖ\x20[CHECK]\x20Payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed','Unknown\x20error','\x20days,\x20marking\x20as\x20EXPIRED','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','not\x20found','\x20timers\x20for\x20payment\x20','‚úÖ\x20[TIMER]\x20Individual\x20check\x20#','entries','catch','webhook_send','startPeriodicStatusCheck','üîç\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','payment.failed','forEach','\x20not\x20found\x20in\x20database','\x20to\x20clear','created','expired','confirmedOn','\x20not\x20enabled\x20for\x20shop\x20','currency','\x20commission\x20for\x20shop\x20','ü™ô\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','PAID','amount','default','failed','‚ö†Ô∏è\x20[CHECK]\x20Payment\x20','\x20checked,\x20','ü™ô\x20[TIMER]\x20Individual\x20check\x20#','text','‚è∞\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20updated\x20successfully','timestamp','toISOString','loggerService','settings','\x20(after\x20','‚è∞\x20[GLOBAL]\x20Found\x20','\x20in\x20shop\x20','üí∞\x20[CHECK]\x20Payment\x20','h),\x20skipping\x20global\x20check','üìä\x20[CHECK]\x20Payment\x20','clearPaymentTimers','‚ùå\x20[CHECK]\x20Payment\x20','‚úÖ\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','\x20to\x20','sendShopWebhook','8019830GYppMz','../types/gateway','Bank\x20Details:\x20','gateway','Payment\x20older\x20than\x20','ü™ô\x20[GLOBAL]\x20Found\x20','cointopay_auto_expired','\x20\x20\x20‚ùå\x20Error:\x20','ü™ô\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','from','cointopay_status_check_error','status','\x20\x20\x20-\x20gatewayPaymentId:\x20','\x20\x20\x20Amount\x20after\x20commission:\x20','GLOBAL_CHECK_INTERVAL_MS','createdAt','\x20\x20\x20üìù\x20Details:','currentPayments','paymentLinkId','timers','logWhiteDomainError','üìä\x20[HOURLY]\x20Payment\x20','üßπ\x20[DEBUG]\x20Clearing\x20','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','status_check','ü™ô\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...','adminNotes','has','parse','paid','\x20expired\x20CoinToPay\x20payments','message','\x20seconds\x20(','checkAllPendingPayments','ü™ô\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','__esModule','\x20not\x20found,\x20clearing\x20timers','\x20current\x20status:\x20','\x20\x20\x20-\x20Gateway:\x20','261sFKEgV','‚úÖ\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','map','üõë\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped',',\x20gateway\x20','logCoinToPayError','createdOn','Automatically\x20expired\x20after\x20','customerName','toFixed','gatewaySettings','\x20->\x20','schedulePaymentChecks','üîÑ\x20[CHECK]\x20Updating\x20payment\x20','90MpXKlk','Success','webhookUrl','sendPaymentStatusNotification','Error\x20getting\x20gateway\x20commission\x20for\x20shop\x20','üõë\x20[SHUTDOWN]\x20Cleared\x20','\x20USDT','./gateways/coinToPay2Service','40212IKSBvd','COINTOPAY_ERROR','\x20commission:\x20','\x20\x20\x20üìç\x20Source:\x20','update','now','./telegramBotService','350ERGcMw','‚úÖ\x20[DEBUG]\x20Successfully\x20scheduled\x20','toLowerCase','description','ü™ô\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','\x20marked\x20as\x20paid\x20at:\x20','COMPLETED','stringify','‚è∞\x20[EXPIRY]\x20Payment\x20','\x20status\x20changed\x20to\x20','1012EotOEK','log','\x20status:\x20','‚úÖ\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','shopId','CoinToPayService','getPaymentTimerInfo','\x20is\x20too\x20new\x20(','\x20in\x20',',\x20clearing\x20individual\x20timers','\x20status\x20unchanged\x20(','\x20status\x20from\x20','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','getGatewayCommission','floor','logShopWebhookError','\x20\x20\x20-\x20paymentId:\x20','./currencyService','payment.success','size','FAILED','checkSinglePaymentById','./loggerService','get','240605hXckAp','paymentDetails','\x20\x20\x20-\x20Amount:\x20','logShopWebhookSent','checkSinglePayment','‚ùå\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20','create','üõë\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','EXPIRY_DAYS','\x20\x20\x20Amount:\x20','ü™ô\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','telegramBotService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','‚úÖ\x20[HOURLY]\x20Payment\x20'];a42_0x46f7=function(){return _0x5c0130;};return a42_0x46f7();}var __importDefault=this&&this['__importDefault']||function(_0x29da52){const _0x2d5041=a42_0x5b2a;return _0x29da52&&_0x29da52[_0x2d5041(0x195)]?_0x29da52:{'default':_0x29da52};};Object['defineProperty'](exports,a42_0x11adb6(0x195),{'value':!![]}),exports[a42_0x11adb6(0x135)]=exports[a42_0x11adb6(0x111)]=void 0x0;const coinToPayService_1=require(a42_0x11adb6(0x13d)),coinToPay2Service_1=require(a42_0x11adb6(0x1ae)),gateway_1=require(a42_0x11adb6(0x173)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a42_0x11adb6(0x1b5)),loggerService_1=require(a42_0x11adb6(0xc5)),currencyService_1=require(a42_0x11adb6(0x1d1));class CoinToPayStatusService{constructor(){const _0x3a525a=a42_0x11adb6;this[_0x3a525a(0xdb)]=null,this[_0x3a525a(0x180)]=0x3c*0x3c*0x3e8,this[_0x3a525a(0xcf)]=0x5,this[_0x3a525a(0x140)]=new Map(),this['coinToPayService']=new coinToPayService_1[(_0x3a525a(0x1c5))](),this[_0x3a525a(0xdc)]=new coinToPay2Service_1[(_0x3a525a(0xf3))](),console['log'](_0x3a525a(0x17a));}[a42_0x11adb6(0x1a5)](_0x2b1e2b,_0x2510ad){const _0x4bb5e2=a42_0x11adb6;console['log']('ü™ô\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:'),console[_0x4bb5e2(0x1c1)](_0x4bb5e2(0x1d0)+_0x2b1e2b),console[_0x4bb5e2(0x1c1)](_0x4bb5e2(0x17e)+_0x2510ad),this[_0x4bb5e2(0x16d)](_0x2b1e2b);const _0x2a73d8=[],_0x4525d2=new Date(),_0x58feba=[{'delay':0x1*0x3c*0x3e8,'description':_0x4bb5e2(0x131)},{'delay':0x2*0x3c*0x3e8,'description':'2\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x4bb5e2(0x114)}];console[_0x4bb5e2(0x1c1)](_0x4bb5e2(0x10f)+_0x58feba[_0x4bb5e2(0x117)]+'\x20initial\x20timers\x20for\x20payment\x20'+_0x2b1e2b);let _0x3701fe=0x0;_0x58feba[_0x4bb5e2(0x14f)]((_0x39457f,_0x2e8712)=>{const _0x129d11=_0x4bb5e2;_0x3701fe+=_0x39457f['delay'];const _0x51eab8=setTimeout(async()=>{const _0x164f91=a42_0x5b2a;console[_0x164f91(0x1c1)](_0x164f91(0x15f)+(_0x2e8712+0x1)+_0x164f91(0xe9)+_0x2b1e2b+_0x164f91(0x167)+_0x39457f[_0x164f91(0x1b9)]+')');try{await this['checkSinglePaymentById'](_0x2b1e2b),console[_0x164f91(0x1c1)](_0x164f91(0x148)+(_0x2e8712+0x1)+'\x20completed\x20for\x20payment\x20'+_0x2b1e2b);}catch(_0x1ce38a){console[_0x164f91(0x108)](_0x164f91(0x101)+(_0x2e8712+0x1)+_0x164f91(0xd8)+_0x2b1e2b+':',_0x1ce38a),this['logCoinToPayError'](_0x2b1e2b,_0x2510ad,_0x1ce38a,_0x164f91(0x18a),{'checkNumber':_0x2e8712+0x1,'scheduledAfter':_0x39457f[_0x164f91(0x1b9)],'isIndividualCheck':!![]});}},_0x3701fe);_0x2a73d8[_0x129d11(0xea)](_0x51eab8),console[_0x129d11(0x1c1)]('‚è∞\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x2e8712+0x1)+_0x129d11(0xd8)+_0x2b1e2b+_0x129d11(0x1c8)+_0x3701fe/0x3e8+_0x129d11(0x192)+_0x39457f[_0x129d11(0x1b9)]+')');});const _0x24b47c=setInterval(async()=>{const _0x215a7d=_0x4bb5e2;console[_0x215a7d(0x1c1)](_0x215a7d(0x194)+_0x2b1e2b);try{const _0x3834f9=await database_1[_0x215a7d(0x15b)]['payment'][_0x215a7d(0xe4)]({'where':{'id':_0x2b1e2b},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x3834f9){console[_0x215a7d(0x1c1)]('‚ùå\x20[HOURLY]\x20Payment\x20'+_0x2b1e2b+_0x215a7d(0x196)),this[_0x215a7d(0x16d)](_0x2b1e2b);return;}console[_0x215a7d(0x1c1)](_0x215a7d(0x187)+_0x2b1e2b+_0x215a7d(0x197)+_0x3834f9['status']);if(_0x3834f9[_0x215a7d(0x17d)]!==_0x215a7d(0x11b)){console[_0x215a7d(0x1c1)](_0x215a7d(0xd4)+_0x2b1e2b+'\x20status\x20is\x20'+_0x3834f9[_0x215a7d(0x17d)]+_0x215a7d(0xf9)),this[_0x215a7d(0x16d)](_0x2b1e2b);return;}const _0x5b49ad=Math['floor']((Date[_0x215a7d(0x1b4)]()-_0x3834f9['createdAt'][_0x215a7d(0x127)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x5b49ad>=this[_0x215a7d(0xcf)]){console[_0x215a7d(0x1c1)](_0x215a7d(0x13a)+_0x2b1e2b+'\x20is\x20older\x20than\x20'+this[_0x215a7d(0xcf)]+_0x215a7d(0x1cc)),this[_0x215a7d(0x16d)](_0x2b1e2b);return;}await this[_0x215a7d(0xc4)](_0x2b1e2b),console[_0x215a7d(0x1c1)](_0x215a7d(0x19a)+_0x2b1e2b);}catch(_0x5d7822){console['error'](_0x215a7d(0xcc)+_0x2b1e2b+':',_0x5d7822),this['logCoinToPayError'](_0x2b1e2b,_0x2510ad,_0x5d7822,_0x215a7d(0x18a),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x2a73d8[_0x4bb5e2(0xea)](_0x24b47c),this[_0x4bb5e2(0x140)][_0x4bb5e2(0xe3)](_0x2b1e2b,{'timers':_0x2a73d8,'paymentId':_0x2b1e2b,'gatewayPaymentId':_0x2510ad,'createdAt':_0x4525d2}),console[_0x4bb5e2(0x1c1)](_0x4bb5e2(0x1b7)+_0x58feba[_0x4bb5e2(0x117)]+'\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20'+_0x2b1e2b),console['log'](_0x4bb5e2(0x10e)+this[_0x4bb5e2(0x140)][_0x4bb5e2(0x1d3)]),this[_0x4bb5e2(0x106)](_0x2b1e2b,_0x2510ad,_0x4bb5e2(0x11b),_0x4bb5e2(0x11b),_0x4bb5e2(0x18a),{'action':_0x4bb5e2(0x107),'scheduledChecks':_0x58feba[_0x4bb5e2(0x117)],'firstCheckIn':_0x58feba[0x0]['delay']/0x3e8,'totalTimers':this['paymentTimers'][_0x4bb5e2(0x1d3)]});}[a42_0x11adb6(0x16d)](_0x11de36){const _0x2cf293=a42_0x11adb6,_0x3d6d21=this[_0x2cf293(0x140)][_0x2cf293(0xc6)](_0x11de36);_0x3d6d21?(console[_0x2cf293(0x1c1)](_0x2cf293(0x188)+_0x3d6d21['timers'][_0x2cf293(0x117)]+_0x2cf293(0x147)+_0x11de36),_0x3d6d21[_0x2cf293(0x185)]['forEach']((_0x521068,_0x3407f8)=>{const _0x5ce1d1=_0x2cf293;_0x521068&&(clearTimeout(_0x521068),clearInterval(_0x521068),console[_0x5ce1d1(0x1c1)]('üßπ\x20[DEBUG]\x20Cleared\x20timer\x20#'+(_0x3407f8+0x1)+_0x5ce1d1(0xd8)+_0x11de36));}),this[_0x2cf293(0x140)]['delete'](_0x11de36),console[_0x2cf293(0x1c1)](_0x2cf293(0x1c3)+_0x11de36+'.\x20Remaining\x20active\x20timers:\x20'+this[_0x2cf293(0x140)]['size'])):console[_0x2cf293(0x1c1)](_0x2cf293(0x134)+_0x11de36+_0x2cf293(0x151));}async['checkSinglePaymentById'](_0x4fbe1e){const _0x3d07ae=a42_0x11adb6;console[_0x3d07ae(0x1c1)]('üîç\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20'+_0x4fbe1e);const _0x3f832c=await database_1['default'][_0x3d07ae(0x132)][_0x3d07ae(0xe4)]({'where':{'id':_0x4fbe1e},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f832c){console['log'](_0x3d07ae(0x16e)+_0x4fbe1e+_0x3d07ae(0x150));return;}console[_0x3d07ae(0x1c1)](_0x3d07ae(0x16c)+_0x4fbe1e+_0x3d07ae(0x10b)),console[_0x3d07ae(0x1c1)](_0x3d07ae(0x198)+_0x3f832c[_0x3d07ae(0x175)]),console['log']('\x20\x20\x20-\x20Status:\x20'+_0x3f832c[_0x3d07ae(0x17d)]),console[_0x3d07ae(0x1c1)](_0x3d07ae(0xf4)+_0x3f832c['gatewayPaymentId']),console['log'](_0x3d07ae(0xc9)+_0x3f832c[_0x3d07ae(0x15a)]+'\x20'+_0x3f832c['currency']),console[_0x3d07ae(0x1c1)](_0x3d07ae(0x13c)+_0x3f832c[_0x3d07ae(0x1c4)]);if(_0x3f832c['gateway']!==_0x3d07ae(0x120)&&_0x3f832c[_0x3d07ae(0x175)]!==_0x3d07ae(0xe1)){console[_0x3d07ae(0x1c1)](_0x3d07ae(0x15d)+_0x4fbe1e+'\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20'+_0x3f832c[_0x3d07ae(0x175)]+')');return;}if(_0x3f832c[_0x3d07ae(0x17d)]!==_0x3d07ae(0x11b)){console[_0x3d07ae(0x1c1)](_0x3d07ae(0x15d)+_0x4fbe1e+'\x20status\x20is\x20'+_0x3f832c['status']+_0x3d07ae(0xf9)),this[_0x3d07ae(0x16d)](_0x4fbe1e);return;}if(!_0x3f832c[_0x3d07ae(0xfc)]){console[_0x3d07ae(0x1c1)](_0x3d07ae(0x15d)+_0x4fbe1e+'\x20has\x20no\x20gatewayPaymentId');return;}console[_0x3d07ae(0x1c1)](_0x3d07ae(0x141)+_0x4fbe1e+'\x20is\x20valid\x20for\x20checking,\x20proceeding...'),await this['checkSinglePayment'](_0x3f832c);}[a42_0x11adb6(0x106)](_0x5b719a,_0x1f1618,_0x2e0096,_0x18c338,_0xa2c61c,_0x37466c){const _0x4e8fd2=a42_0x11adb6,_0x30f9c6={'type':_0x4e8fd2(0x12f),'paymentId':_0x5b719a,'gatewayPaymentId':_0x1f1618,'oldStatus':_0x2e0096,'newStatus':_0x18c338,'source':_0xa2c61c,'timestamp':new Date()['toISOString'](),'details':_0x37466c||{}};loggerService_1['loggerService'][_0x4e8fd2(0x106)](_0x30f9c6),console[_0x4e8fd2(0x1c1)](_0x4e8fd2(0x1ba)+_0x5b719a+'\x20('+_0x1f1618+')'),console['log']('\x20\x20\x20üìä\x20Status:\x20'+_0x2e0096+_0x4e8fd2(0x1a4)+_0x18c338),console[_0x4e8fd2(0x1c1)](_0x4e8fd2(0x1b2)+_0xa2c61c),console[_0x4e8fd2(0x1c1)](_0x4e8fd2(0x125)+_0x30f9c6[_0x4e8fd2(0x163)]),_0x37466c&&console[_0x4e8fd2(0x1c1)](_0x4e8fd2(0x182),_0x37466c);}[a42_0x11adb6(0x19e)](_0x57ab4c,_0x22097e,_0x48c40b,_0xa255f8,_0x73e06b){const _0x2fc786=a42_0x11adb6,_0x35cb15={'type':_0x2fc786(0x1b0),'paymentId':_0x57ab4c,'gatewayPaymentId':_0x22097e,'error':_0x48c40b instanceof Error?{'message':_0x48c40b['message'],'stack':_0x48c40b[_0x2fc786(0x13b)]}:_0x48c40b,'source':_0xa255f8,'timestamp':new Date()[_0x2fc786(0x164)](),'context':_0x73e06b||{}};loggerService_1[_0x2fc786(0x165)][_0x2fc786(0x19e)](_0x35cb15),console[_0x2fc786(0x108)](_0x2fc786(0x138)+_0x57ab4c+'\x20('+_0x22097e+')'),console[_0x2fc786(0x108)](_0x2fc786(0x179)+(_0x48c40b instanceof Error?_0x48c40b[_0x2fc786(0x191)]:_0x48c40b)),console[_0x2fc786(0x108)](_0x2fc786(0x1b2)+_0xa255f8),console['error'](_0x2fc786(0x125)+_0x35cb15[_0x2fc786(0x163)]),_0x73e06b&&console[_0x2fc786(0x108)](_0x2fc786(0x121),_0x73e06b);}[a42_0x11adb6(0x14c)](){const _0x56b8cd=a42_0x11adb6;console[_0x56b8cd(0x1c1)]('ü™ô\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)'),this[_0x56b8cd(0x193)]()[_0x56b8cd(0x14a)](_0x2b936e=>{const _0x469e26=_0x56b8cd;console[_0x469e26(0x108)](_0x469e26(0xe7),_0x2b936e);}),this[_0x56b8cd(0xdb)]=setInterval(async()=>{const _0x5d5875=_0x56b8cd;try{console[_0x5d5875(0x1c1)](_0x5d5875(0x18b)),await this[_0x5d5875(0x193)](),console['log'](_0x5d5875(0x142));}catch(_0x583062){console[_0x5d5875(0x108)]('‚ùå\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:',_0x583062);}},this[_0x56b8cd(0x180)]),console[_0x56b8cd(0x1c1)](_0x56b8cd(0xe2));}[a42_0x11adb6(0xf0)](){const _0x385263=a42_0x11adb6;console['log'](_0x385263(0xce));this['globalCheckInterval']&&(clearInterval(this[_0x385263(0xdb)]),this[_0x385263(0xdb)]=null,console[_0x385263(0x1c1)](_0x385263(0x19c)));const _0x44748a=this[_0x385263(0x140)]['size'];for(const [_0x5c17f6]of this['paymentTimers']){this[_0x385263(0x16d)](_0x5c17f6);}console[_0x385263(0x1c1)](_0x385263(0x1ac)+_0x44748a+'\x20individual\x20payment\x20timers');}async['checkAllPendingPayments'](){const _0x41a9bf=a42_0x11adb6;try{console['log'](_0x41a9bf(0xd1));const _0x2431b9=await database_1['default'][_0x41a9bf(0x132)][_0x41a9bf(0x124)]({'where':{'gateway':{'in':[_0x41a9bf(0x120),'cointopay2']},'status':_0x41a9bf(0x11b),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console['log'](_0x41a9bf(0x177)+_0x2431b9['length']+'\x20pending\x20CoinToPay\x20payments');if(_0x2431b9[_0x41a9bf(0x117)]===0x0){console[_0x41a9bf(0x1c1)](_0x41a9bf(0x158));return;}const _0x378567=await this['checkExpiredPayments'](_0x2431b9);console[_0x41a9bf(0x1c1)](_0x41a9bf(0x168)+_0x378567[_0x41a9bf(0x117)]+_0x41a9bf(0x190));let _0x2acac9=0x0,_0xffce10=0x0;for(const _0x132ba5 of _0x2431b9){try{if(_0x378567['includes'](_0x132ba5['id'])){console['log'](_0x41a9bf(0xd6)+_0x132ba5['id']+_0x41a9bf(0x145)),_0xffce10++;continue;}if(this[_0x41a9bf(0x140)][_0x41a9bf(0x18d)](_0x132ba5['id'])){console['log'](_0x41a9bf(0xd6)+_0x132ba5['id']+_0x41a9bf(0x109)),_0xffce10++;continue;}const _0x3e3241=(Date[_0x41a9bf(0x1b4)]()-_0x132ba5[_0x41a9bf(0x181)][_0x41a9bf(0x127)]())/(0x3e8*0x3c*0x3c);if(_0x3e3241<0x1){console[_0x41a9bf(0x1c1)](_0x41a9bf(0xd6)+_0x132ba5['id']+_0x41a9bf(0x1c7)+_0x3e3241[_0x41a9bf(0x1a2)](0x1)+_0x41a9bf(0x16b)),_0xffce10++;continue;}console[_0x41a9bf(0x1c1)](_0x41a9bf(0x12c)+_0x132ba5['id']+_0x41a9bf(0x139)+_0x3e3241[_0x41a9bf(0x1a2)](0x1)+'h)'),await this[_0x41a9bf(0xcb)](_0x132ba5),_0x2acac9++,await new Promise(_0x248908=>setTimeout(_0x248908,0x7d0));}catch(_0x4f5bdf){console['error'](_0x41a9bf(0x119)+_0x132ba5['id']+':',_0x4f5bdf),this[_0x41a9bf(0x19e)](_0x132ba5['id'],_0x132ba5[_0x41a9bf(0xfc)]||_0x41a9bf(0xdf),_0x4f5bdf,_0x41a9bf(0x18a),{'isGlobalCheck':!![],'paymentAmount':_0x132ba5['amount'],'paymentCurrency':_0x132ba5[_0x41a9bf(0x156)],'shopId':_0x132ba5['shopId'],'createdAt':_0x132ba5[_0x41a9bf(0x181)]}),loggerService_1['loggerService'][_0x41a9bf(0x186)](_0x41a9bf(0x120),_0x41a9bf(0xfb)+_0x132ba5[_0x41a9bf(0xfc)],_0x4f5bdf);}}console[_0x41a9bf(0x1c1)](_0x41a9bf(0x16f)+_0x2acac9+_0x41a9bf(0x15e)+_0xffce10+_0x41a9bf(0xe5)+_0x378567[_0x41a9bf(0x117)]+'\x20expired');}catch(_0x1d2710){console['error']('‚ùå\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:',_0x1d2710);}}async[a42_0x11adb6(0xf7)](_0x45840d){const _0x3e7b0f=a42_0x11adb6,_0x214569=[],_0x184289=new Date();_0x184289['setDate'](_0x184289['getDate']()-this[_0x3e7b0f(0xcf)]),console[_0x3e7b0f(0x1c1)](_0x3e7b0f(0x161)+this[_0x3e7b0f(0xcf)]+_0x3e7b0f(0xf2)+_0x184289[_0x3e7b0f(0x164)]()+')');for(const _0x14f6ef of _0x45840d){if(_0x14f6ef['createdAt']<_0x184289){console[_0x3e7b0f(0x1c1)](_0x3e7b0f(0x1be)+_0x14f6ef['id']+_0x3e7b0f(0x13e)+this[_0x3e7b0f(0xcf)]+_0x3e7b0f(0x144));try{this['logCoinToPayStatus'](_0x14f6ef['id'],_0x14f6ef[_0x3e7b0f(0xfc)]||_0x3e7b0f(0xdf),_0x3e7b0f(0x11b),'EXPIRED',_0x3e7b0f(0x123),{'reason':_0x3e7b0f(0x176)+this[_0x3e7b0f(0xcf)]+'\x20days','createdAt':_0x14f6ef['createdAt'],'daysSinceCreation':Math[_0x3e7b0f(0x1ce)]((Date['now']()-_0x14f6ef['createdAt'][_0x3e7b0f(0x127)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x14f6ef['amount'],'paymentCurrency':_0x14f6ef[_0x3e7b0f(0x156)],'shopId':_0x14f6ef[_0x3e7b0f(0x1c4)]}),await database_1[_0x3e7b0f(0x15b)][_0x3e7b0f(0x132)][_0x3e7b0f(0x1b3)]({'where':{'id':_0x14f6ef['id']},'data':{'status':_0x3e7b0f(0x11c),'updatedAt':new Date(),'adminNotes':_0x3e7b0f(0x1a0)+this['EXPIRY_DAYS']+_0x3e7b0f(0x104)}}),await database_1['default'][_0x3e7b0f(0xfa)][_0x3e7b0f(0xcd)]({'data':{'paymentId':_0x14f6ef['id'],'shopId':_0x14f6ef[_0x3e7b0f(0x1c4)],'event':_0x3e7b0f(0x178),'statusCode':0xc8,'responseBody':JSON['stringify']({'reason':_0x3e7b0f(0x176)+this[_0x3e7b0f(0xcf)]+_0x3e7b0f(0x11f),'createdAt':_0x14f6ef[_0x3e7b0f(0x181)],'expiredAt':new Date()[_0x3e7b0f(0x164)](),'daysSinceCreation':Math[_0x3e7b0f(0x1ce)]((Date[_0x3e7b0f(0x1b4)]()-_0x14f6ef['createdAt'][_0x3e7b0f(0x127)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x3e7b0f(0x171)](_0x14f6ef,_0x3e7b0f(0x11c)),await this[_0x3e7b0f(0x1aa)](_0x14f6ef,'EXPIRED'),this[_0x3e7b0f(0x16d)](_0x14f6ef['id']),_0x214569[_0x3e7b0f(0xea)](_0x14f6ef['id']),console[_0x3e7b0f(0x1c1)]('‚úÖ\x20[EXPIRY]\x20Payment\x20'+_0x14f6ef['id']+_0x3e7b0f(0x189)+this[_0x3e7b0f(0xcf)]+_0x3e7b0f(0xde));}catch(_0x510feb){console[_0x3e7b0f(0x108)](_0x3e7b0f(0xd5)+_0x14f6ef['id']+':',_0x510feb),this['logCoinToPayError'](_0x14f6ef['id'],_0x14f6ef[_0x3e7b0f(0xfc)]||_0x3e7b0f(0xdf),_0x510feb,'auto_expire',{'reason':'Failed\x20to\x20mark\x20payment\x20as\x20expired','createdAt':_0x14f6ef[_0x3e7b0f(0x181)],'daysSinceCreation':Math[_0x3e7b0f(0x1ce)]((Date[_0x3e7b0f(0x1b4)]()-_0x14f6ef['createdAt'][_0x3e7b0f(0x127)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x214569;}async[a42_0x11adb6(0xcb)](_0x4e94a4){const _0x25678e=a42_0x11adb6;if(!_0x4e94a4[_0x25678e(0xfc)]){console[_0x25678e(0x1c1)](_0x25678e(0x15d)+_0x4e94a4['id']+_0x25678e(0x129));return;}console[_0x25678e(0x1c1)](_0x25678e(0xee)+_0x4e94a4[_0x25678e(0x175)]+_0x25678e(0xdd)+_0x4e94a4['id']+'\x20('+_0x4e94a4[_0x25678e(0xfc)]+')');try{let _0x1d5a20;_0x4e94a4[_0x25678e(0x175)]==='cointopay2'?(_0x1d5a20=await this['coinToPay2Service'][_0x25678e(0x128)](_0x4e94a4[_0x25678e(0xfc)]),console['log'](_0x25678e(0x11a)+_0x4e94a4['id']+_0x25678e(0x1c2)+_0x1d5a20[_0x25678e(0x17d)])):(_0x1d5a20=await this[_0x25678e(0xfe)]['checkPaymentStatus'](_0x4e94a4[_0x25678e(0xfc)]),console[_0x25678e(0x1c1)](_0x25678e(0xf5)+_0x4e94a4['id']+_0x25678e(0x1c2)+_0x1d5a20[_0x25678e(0x17d)]));_0x1d5a20[_0x25678e(0xc8)]&&console[_0x25678e(0x1c1)](_0x25678e(0x16c)+_0x4e94a4['id']+'\x20details:',{'iban':_0x1d5a20[_0x25678e(0xc8)][_0x25678e(0xf8)]||_0x25678e(0x146),'transactionId':_0x1d5a20[_0x25678e(0xc8)][_0x25678e(0x113)],'createdOn':_0x1d5a20[_0x25678e(0xc8)][_0x25678e(0x19f)],'confirmedOn':_0x1d5a20[_0x25678e(0xc8)][_0x25678e(0x154)]||'not\x20confirmed'});if(_0x1d5a20[_0x25678e(0x17d)]!==_0x4e94a4[_0x25678e(0x17d)]){console[_0x25678e(0x1c1)](_0x25678e(0x1a6)+_0x4e94a4['id']+_0x25678e(0x1cb)+_0x4e94a4['status']+_0x25678e(0x170)+_0x1d5a20[_0x25678e(0x17d)]),this[_0x25678e(0x106)](_0x4e94a4['id'],_0x4e94a4[_0x25678e(0xfc)],_0x4e94a4[_0x25678e(0x17d)],_0x1d5a20[_0x25678e(0x17d)],_0x25678e(0x18a),{'paymentDetails':_0x1d5a20[_0x25678e(0xc8)],'amount':_0x1d5a20[_0x25678e(0x15a)],'currency':_0x1d5a20[_0x25678e(0x156)],'shopId':_0x4e94a4['shopId'],'checkTimestamp':new Date()['toISOString']()});const _0x3e2c66={'status':_0x1d5a20[_0x25678e(0x17d)],'updatedAt':new Date()};if(_0x1d5a20['status']==='PAID'&&_0x4e94a4[_0x25678e(0x17d)]!==_0x25678e(0x159)){_0x3e2c66[_0x25678e(0x10c)]=new Date();if(!_0x4e94a4[_0x25678e(0xec)]){const _0x1b87d1=await currencyService_1[_0x25678e(0x11d)]['convertToUSDT'](_0x4e94a4[_0x25678e(0x15a)],_0x4e94a4['currency']);_0x3e2c66['amountUSDT']=_0x1b87d1;const _0xee9d55=await this[_0x25678e(0x1cd)](_0x4e94a4[_0x25678e(0x1c4)],_0x4e94a4[_0x25678e(0x175)]),_0x5926f4=_0x1b87d1*(0x1-_0xee9d55/0x64);_0x3e2c66[_0x25678e(0x12e)]=_0x5926f4,_0x3e2c66['gatewayCommissionRate']=_0xee9d55,console[_0x25678e(0x1c1)](_0x25678e(0x16a)+_0x4e94a4['id']+_0x25678e(0x12a)),console[_0x25678e(0x1c1)](_0x25678e(0xd0)+_0x4e94a4[_0x25678e(0x15a)]+'\x20'+_0x4e94a4[_0x25678e(0x156)]+_0x25678e(0x1a4)+_0x1b87d1[_0x25678e(0x1a2)](0x6)+_0x25678e(0x1ad)),console[_0x25678e(0x1c1)]('\x20\x20\x20Gateway\x20'+_0x4e94a4['gateway']+_0x25678e(0x1b1)+_0xee9d55+'%'),console['log'](_0x25678e(0x17f)+_0x5926f4[_0x25678e(0x1a2)](0x6)+_0x25678e(0x1ad));}console['log'](_0x25678e(0x16a)+_0x4e94a4['id']+_0x25678e(0x1bb)+_0x3e2c66[_0x25678e(0x10c)][_0x25678e(0x164)]());}if(_0x1d5a20[_0x25678e(0xc8)]){const _0x4f4b3d=_0x1d5a20['paymentDetails'];_0x4f4b3d[_0x25678e(0xf8)]&&(_0x3e2c66['remitterIban']=_0x4f4b3d['iban'],console[_0x25678e(0x1c1)](_0x25678e(0xff)+_0x4f4b3d[_0x25678e(0xf8)]));if(_0x4f4b3d[_0x25678e(0x115)]){const _0x28b13a=_0x4e94a4['adminNotes']||'',_0x2aec97=_0x25678e(0x174)+_0x4f4b3d[_0x25678e(0x115)];_0x3e2c66[_0x25678e(0x18c)]=_0x28b13a?_0x28b13a+'\x0a\x0a'+_0x2aec97:_0x2aec97,console[_0x25678e(0x1c1)](_0x25678e(0x136));}_0x4f4b3d[_0x25678e(0x113)]&&console['log']('üÜî\x20[CHECK]\x20Transaction\x20ID:\x20'+_0x4f4b3d[_0x25678e(0x113)]),_0x4f4b3d['confirmedOn']&&console[_0x25678e(0x1c1)](_0x25678e(0x105)+_0x4f4b3d[_0x25678e(0x154)]);}await database_1[_0x25678e(0x15b)][_0x25678e(0x132)][_0x25678e(0x1b3)]({'where':{'id':_0x4e94a4['id']},'data':_0x3e2c66});if(_0x1d5a20[_0x25678e(0x17d)]===_0x25678e(0x159)&&_0x4e94a4[_0x25678e(0x17d)]!=='PAID'){console[_0x25678e(0x1c1)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x4e94a4['id']+_0x25678e(0xd7));const _0x17ab7a=await database_1[_0x25678e(0x15b)][_0x25678e(0x132)][_0x25678e(0xe4)]({'where':{'id':_0x4e94a4['id']},'select':{'id':!![],'paymentLinkId':!![],'paymentLink':{'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}}}});if(_0x17ab7a?.[_0x25678e(0x184)]&&_0x17ab7a[_0x25678e(0xe6)])try{const _0x2167ad=_0x17ab7a['paymentLink'];console['log'](_0x25678e(0x12d)+_0x2167ad['id']+_0x25678e(0x122)+_0x2167ad[_0x25678e(0xfd)]+_0x25678e(0xf1)+_0x2167ad['currentPayments']+',\x20status='+_0x2167ad[_0x25678e(0x17d)]);const _0x2d0408=_0x2167ad[_0x25678e(0x183)]+0x1,_0x5bc530=_0x2167ad[_0x25678e(0xfd)]===_0x25678e(0x12b)?_0x25678e(0x1bc):_0x2167ad[_0x25678e(0x17d)];await database_1['default'][_0x25678e(0xe6)]['update']({'where':{'id':_0x2167ad['id']},'data':{'currentPayments':_0x2d0408,'status':_0x5bc530,'updatedAt':new Date()}}),console[_0x25678e(0x1c1)]('‚úÖ\x20[COINTOPAY]\x20Payment\x20link\x20'+_0x2167ad['id']+'\x20updated:\x20currentPayments='+_0x2167ad['currentPayments']+'\x20->\x20'+_0x2d0408+_0x25678e(0xd9)+_0x2167ad[_0x25678e(0x17d)]+_0x25678e(0x1a4)+_0x5bc530);}catch(_0x45532f){console['error']('‚ùå\x20[COINTOPAY]\x20Failed\x20to\x20update\x20payment\x20link:',_0x45532f);}else console[_0x25678e(0x1c1)]('üìà\x20[COINTOPAY]\x20Payment\x20'+_0x4e94a4['id']+'\x20is\x20not\x20linked\x20to\x20a\x20payment\x20link');}await database_1[_0x25678e(0x15b)][_0x25678e(0xfa)]['create']({'data':{'paymentId':_0x4e94a4['id'],'shopId':_0x4e94a4[_0x25678e(0x1c4)],'event':'cointopay_status_check_'+_0x1d5a20[_0x25678e(0x17d)][_0x25678e(0x1b8)](),'statusCode':0xc8,'responseBody':JSON[_0x25678e(0x1bd)]({'oldStatus':_0x4e94a4[_0x25678e(0x17d)],'newStatus':_0x1d5a20[_0x25678e(0x17d)],'paymentDetails':_0x1d5a20[_0x25678e(0xc8)],'checkedAt':new Date()[_0x25678e(0x164)]()})}}),await this[_0x25678e(0x171)](_0x4e94a4,_0x1d5a20['status']),await this['sendPaymentStatusNotification'](_0x4e94a4,_0x1d5a20[_0x25678e(0x17d)]),_0x1d5a20[_0x25678e(0x17d)]!==_0x25678e(0x11b)&&(console[_0x25678e(0x1c1)](_0x25678e(0xe0)+_0x4e94a4['id']+_0x25678e(0x1bf)+_0x1d5a20[_0x25678e(0x17d)]+_0x25678e(0x1c9)),this['clearPaymentTimers'](_0x4e94a4['id'])),console['log'](_0x25678e(0x141)+_0x4e94a4['id']+_0x25678e(0x162));}else console[_0x25678e(0x1c1)](_0x25678e(0x16c)+_0x4e94a4['id']+_0x25678e(0x1ca)+_0x1d5a20['status']+')'),this[_0x25678e(0x106)](_0x4e94a4['id'],_0x4e94a4[_0x25678e(0xfc)],_0x4e94a4['status'],_0x1d5a20['status'],_0x25678e(0x18a),{'statusUnchanged':!![],'paymentDetails':_0x1d5a20[_0x25678e(0xc8)],'amount':_0x1d5a20[_0x25678e(0x15a)],'currency':_0x1d5a20[_0x25678e(0x156)],'shopId':_0x4e94a4[_0x25678e(0x1c4)],'checkTimestamp':new Date()[_0x25678e(0x164)]()});}catch(_0x1285f5){console[_0x25678e(0x108)]('‚ùå\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20'+_0x4e94a4['id']+':',_0x1285f5),this['logCoinToPayError'](_0x4e94a4['id'],_0x4e94a4[_0x25678e(0xfc)],_0x1285f5,_0x25678e(0x18a),{'paymentAmount':_0x4e94a4['amount'],'paymentCurrency':_0x4e94a4['currency'],'shopId':_0x4e94a4[_0x25678e(0x1c4)],'createdAt':_0x4e94a4[_0x25678e(0x181)]}),await database_1['default'][_0x25678e(0xfa)][_0x25678e(0xcd)]({'data':{'paymentId':_0x4e94a4['id'],'shopId':_0x4e94a4[_0x25678e(0x1c4)],'event':_0x25678e(0x17c),'statusCode':0x1f4,'responseBody':JSON[_0x25678e(0x1bd)]({'error':_0x1285f5 instanceof Error?_0x1285f5['message']:_0x25678e(0x143),'gatewayPaymentId':_0x4e94a4['gatewayPaymentId'],'checkedAt':new Date()[_0x25678e(0x164)]()})}});}}async[a42_0x11adb6(0x171)](_0x25c81c,_0x1a4752){const _0x265ee2=a42_0x11adb6,_0x24babc=Date[_0x265ee2(0x1b4)]();try{const _0x243145=_0x25c81c[_0x265ee2(0x103)],_0x415623=_0x243145[_0x265ee2(0x166)];if(!_0x415623?.[_0x265ee2(0x1a9)]){console[_0x265ee2(0x1c1)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x243145['id']);return;}const _0x420b3c=_0x1a4752===_0x265ee2(0x159)?_0x265ee2(0x1d2):_0x1a4752===_0x265ee2(0x1d4)?_0x265ee2(0x14e):_0x1a4752===_0x265ee2(0x11c)?'payment.failed':'payment.pending';if(!_0x415623['webhookEvents']?.[_0x265ee2(0x102)](_0x420b3c)){console['log'](_0x265ee2(0xe8)+_0x420b3c+_0x265ee2(0x155)+_0x243145['id']);return;}const _0x2f4ade=(0x0,gateway_1['getGatewayIdByName'])(_0x25c81c[_0x265ee2(0x175)])||_0x25c81c[_0x265ee2(0x175)],_0x3aa8dc={'event':_0x420b3c,'payment':{'id':_0x25c81c['id'],'order_id':_0x25c81c[_0x265ee2(0x11e)],'gateway_order_id':_0x25c81c[_0x265ee2(0x100)],'gateway':_0x2f4ade,'amount':_0x25c81c[_0x265ee2(0x15a)],'currency':_0x25c81c['currency'],'status':_0x1a4752[_0x265ee2(0x1b8)](),'customer_email':_0x25c81c[_0x265ee2(0x10a)],'customer_name':_0x25c81c[_0x265ee2(0x1a1)],'created_at':_0x25c81c[_0x265ee2(0x181)],'updated_at':new Date()}},_0x5acde0=await fetch(_0x415623[_0x265ee2(0x1a9)],{'method':_0x265ee2(0x13f),'headers':{'Content-Type':'application/json','User-Agent':_0x265ee2(0xeb)},'body':JSON[_0x265ee2(0x1bd)](_0x3aa8dc)}),_0x162177=Date['now']()-_0x24babc,_0x80058f=_0x5acde0['ok']?_0x265ee2(0x1a8):await _0x5acde0[_0x265ee2(0x160)]();loggerService_1['loggerService'][_0x265ee2(0xca)](_0x25c81c[_0x265ee2(0x1c4)],_0x415623['webhookUrl'],_0x420b3c,_0x5acde0[_0x265ee2(0x17d)],_0x162177,_0x3aa8dc),console[_0x265ee2(0x1c1)](_0x265ee2(0x118)+_0x415623[_0x265ee2(0x1a9)]+_0x265ee2(0x10d)+_0x5acde0['status']+'\x20('+_0x162177+'ms)');}catch(_0x58739e){console[_0x265ee2(0x108)](_0x265ee2(0x133),_0x58739e),loggerService_1[_0x265ee2(0x165)][_0x265ee2(0x1cf)](_0x25c81c[_0x265ee2(0x1c4)],_0x25c81c[_0x265ee2(0x103)]?.[_0x265ee2(0x166)]?.[_0x265ee2(0x1a9)]||_0x265ee2(0xdf),_0x265ee2(0x14b),_0x58739e,{});}}async['sendPaymentStatusNotification'](_0x60582f,_0x1ff348){const _0x426487=a42_0x11adb6;try{const _0x161c7a={'PENDING':_0x426487(0x152),'PAID':_0x426487(0x18f),'FAILED':_0x426487(0x15c),'EXPIRED':_0x426487(0x153)},_0x23ab1d=_0x161c7a[_0x1ff348];if(!_0x23ab1d||_0x23ab1d===_0x426487(0x152))return;await telegramBotService_1[_0x426487(0xd2)][_0x426487(0x116)](_0x60582f[_0x426487(0x1c4)],_0x60582f,_0x23ab1d);}catch(_0x421b68){console[_0x426487(0x108)](_0x426487(0xd3),_0x421b68);}}async['checkPaymentById'](_0x248740){const _0x16cebc=a42_0x11adb6;console[_0x16cebc(0x1c1)](_0x16cebc(0x14d)+_0x248740);const _0x27ff6c=await database_1[_0x16cebc(0x15b)]['payment']['findUnique']({'where':{'id':_0x248740},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x27ff6c)throw new Error('Payment\x20not\x20found');if(_0x27ff6c[_0x16cebc(0x175)]!=='cointopay'&&_0x27ff6c[_0x16cebc(0x175)]!=='cointopay2')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment');console[_0x16cebc(0x1c1)]('‚úÖ\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20'+_0x27ff6c['gateway']+_0x16cebc(0xdd)+_0x248740),await this[_0x16cebc(0xcb)](_0x27ff6c),console['log'](_0x16cebc(0xf6)+_0x248740);}['getServiceStats'](){const _0x5736e2=a42_0x11adb6,_0x4e322c=this[_0x5736e2(0xdb)]?this['GLOBAL_CHECK_INTERVAL_MS']:undefined,_0x46cd80=Array[_0x5736e2(0x17b)](this[_0x5736e2(0x140)]['values']())[_0x5736e2(0x19b)](_0x5ce713=>({'paymentId':_0x5ce713['paymentId'],'gatewayPaymentId':_0x5ce713[_0x5736e2(0xfc)],'createdAt':_0x5ce713[_0x5736e2(0x181)],'timersCount':_0x5ce713[_0x5736e2(0x185)]['length']}));return{'isActive':!!this[_0x5736e2(0xdb)],'globalCheckIntervalMinutes':this[_0x5736e2(0x180)]/(0x3e8*0x3c),'expiryDays':this[_0x5736e2(0xcf)],'activeIndividualTimers':this['paymentTimers']['size'],'nextGlobalCheckIn':_0x4e322c,'paymentTimersDetails':_0x46cd80};}[a42_0x11adb6(0x1c6)](_0x20e80d){const _0x373d8d=a42_0x11adb6,_0x438da5=this['paymentTimers'][_0x373d8d(0xc6)](_0x20e80d);if(_0x438da5)return{'hasTimers':!![],'timersCount':_0x438da5[_0x373d8d(0x185)][_0x373d8d(0x117)],'createdAt':_0x438da5[_0x373d8d(0x181)],'gatewayPaymentId':_0x438da5[_0x373d8d(0xfc)]};return{'hasTimers':![]};}async[a42_0x11adb6(0x1cd)](_0x305a8a,_0x189870){const _0x7cf021=a42_0x11adb6;try{const _0x278abe=await database_1[_0x7cf021(0x15b)][_0x7cf021(0x103)]['findUnique']({'where':{'id':_0x305a8a},'select':{'gatewaySettings':!![]}});if(!_0x278abe?.[_0x7cf021(0x1a3)])return console[_0x7cf021(0x1c1)]('No\x20gateway\x20settings\x20found\x20for\x20shop\x20'+_0x305a8a+_0x7cf021(0x137)),0xa;const _0x483904=JSON[_0x7cf021(0x18e)](_0x278abe['gatewaySettings']);for(const [_0x2a856b,_0x42cfe0]of Object[_0x7cf021(0x149)](_0x483904)){if(_0x2a856b['toLowerCase']()===_0x189870[_0x7cf021(0x1b8)]()){const _0x2311cb=_0x42cfe0['commission']||0xa;return console[_0x7cf021(0x1c1)]('Gateway\x20'+_0x189870+_0x7cf021(0x157)+_0x305a8a+':\x20'+_0x2311cb+'%'),_0x2311cb;}}return console[_0x7cf021(0x1c1)](_0x7cf021(0xef)+_0x189870+_0x7cf021(0x169)+_0x305a8a+',\x20using\x20default\x2010%'),0xa;}catch(_0x5c4071){return console[_0x7cf021(0x108)](_0x7cf021(0x1ab)+_0x305a8a+_0x7cf021(0x19d)+_0x189870+':',_0x5c4071),0xa;}}}exports[a42_0x11adb6(0x111)]=CoinToPayStatusService,exports[a42_0x11adb6(0x135)]=new CoinToPayStatusService();