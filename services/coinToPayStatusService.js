'use strict';const a37_0x4f705d=a37_0x5088;(function(_0x5f5c56,_0x5dcc4e){const _0x312fd4=a37_0x5088,_0x574d86=_0x5f5c56();while(!![]){try{const _0x5c4af3=-parseInt(_0x312fd4(0x1f3))/0x1+parseInt(_0x312fd4(0x16b))/0x2+parseInt(_0x312fd4(0x1b0))/0x3*(parseInt(_0x312fd4(0x139))/0x4)+parseInt(_0x312fd4(0x192))/0x5*(parseInt(_0x312fd4(0x1f5))/0x6)+-parseInt(_0x312fd4(0x182))/0x7+-parseInt(_0x312fd4(0x18f))/0x8*(-parseInt(_0x312fd4(0x1e5))/0x9)+-parseInt(_0x312fd4(0x1ce))/0xa;if(_0x5c4af3===_0x5dcc4e)break;else _0x574d86['push'](_0x574d86['shift']());}catch(_0x3d29f9){_0x574d86['push'](_0x574d86['shift']());}}}(a37_0x1be3,0x76570));var __importDefault=this&&this[a37_0x4f705d(0x158)]||function(_0x2d9dd9){const _0x302645=a37_0x4f705d;return _0x2d9dd9&&_0x2d9dd9[_0x302645(0x1e0)]?_0x2d9dd9:{'default':_0x2d9dd9};};Object[a37_0x4f705d(0x1ee)](exports,a37_0x4f705d(0x1e0),{'value':!![]}),exports[a37_0x4f705d(0x1e8)]=exports[a37_0x4f705d(0x1a3)]=void 0x0;function a37_0x5088(_0xddf217,_0x3080ec){const _0x1be38b=a37_0x1be3();return a37_0x5088=function(_0x5088d1,_0x27f965){_0x5088d1=_0x5088d1-0x135;let _0x1a4658=_0x1be38b[_0x5088d1];return _0x1a4658;},a37_0x5088(_0xddf217,_0x3080ec);}function a37_0x1be3(){const _0x4ca1fe=['globalCheckInterval','paymentTimers','stack','❌\x20[GLOBAL]\x20Failed\x20to\x20check\x20CoinToPay\x20payment\x20','Failed\x20to\x20send\x20shop\x20webhook:','\x20\x20\x20📝\x20Details:','findUnique','5\x20minutes','\x20triggered\x20for\x20payment\x20','checkPaymentStatus','cointopay_status_check_','PAID','845172KQZaYb','\x20has\x20no\x20gatewayPaymentId','\x20is\x20too\x20new\x20(','getDate','\x20\x20\x20-\x20GatewayPaymentId:\x20','from','cointopay','✅\x20[DEBUG]\x20All\x20timers\x20cleared\x20for\x20payment\x20','currency','map','push','webhookLog','includes','✅\x20[CHECK]\x20Payment\x20','\x20payment\x20','❌\x20[INIT]\x20Initial\x20CoinToPay\x20status\x20check\x20failed:','\x20is\x20valid\x20for\x20checking,\x20proceeding...','🪙\x20[GLOBAL]\x20Found\x20','findMany','\x20status\x20is\x20','\x20(age:\x20','gatewayPaymentId','1\x20minute','6736072BgcirJ','✅\x20[GLOBAL]\x20Global\x20check\x20completed:\x20','status_check','paymentId','\x20in\x20','\x20\x20\x20❌\x20Error:\x20','\x20\x20\x20-\x20paymentId:\x20','timers','./telegramBotService','\x20has\x20no\x20gatewayPaymentId,\x20skipping','PENDING','confirmedOn','Failed\x20to\x20mark\x20payment\x20as\x20expired','6981704AaMMdp','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','amount','76285dzFIdP','📊\x20[CHECK]\x20Payment\x20','stopPeriodicStatusCheck','\x20status:\x20','\x20initial\x20checks\x20+\x20hourly\x20checks\x20for\x20payment\x20','\x20current\x20status:\x20','orderId','remitterIban','\x20completed\x20for\x20payment\x20','2\x20minutes','default','./loggerService','checkPaymentById','timestamp','checkAllPendingPayments','coinToPayService','❌\x20[EXPIRY]\x20Failed\x20to\x20expire\x20payment\x20','CoinToPayStatusService','adminNotes','🪙\x20[TIMER]\x20Individual\x20check\x20#','🪙\x20[HOURLY]\x20Hourly\x20check\x20triggered\x20for\x20payment\x20','\x20not\x20found,\x20clearing\x20timers','length','paymentDetails','\x20days,\x20marking\x20as\x20EXPIRED','log','⏰\x20[GLOBAL]\x20Payment\x20','delay','\x20days\x20(created\x20before\x20','transactionId','398610RPvGjt',',\x20stopping\x20individual\x20checks','webhookEvents','\x20not\x20enabled\x20for\x20shop\x20','\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment\x20(gateway:\x20','schedulePaymentChecks','floor','Payment\x20is\x20not\x20a\x20CoinToPay/CoinToPay2\x20payment','payment','\x20timers\x20for\x20payment\x20','❌\x20[TIMER]\x20Failed\x20individual\x20check\x20#','🪙\x20[GLOBAL]\x20Getting\x20all\x20pending\x20CoinToPay\x20payments...','⏰\x20[HOURLY]\x20Payment\x20','getPaymentTimerInfo','unknown','\x20to\x20clear','now','cointopay_auto_expired','✅\x20[EXPIRY]\x20Payment\x20','startPeriodicStatusCheck','✅\x20[HOURLY]\x20Hourly\x20check\x20completed\x20for\x20payment\x20','🪙\x20[ERROR]\x20CoinToPay\x20Error:\x20','getTime','auto_expire','shop','🪙\x20CoinToPayStatusService\x20initialized\x20with\x20support\x20for\x20both\x20CoinToPay\x20and\x20CoinToPay2','update','Payment\x20older\x20than\x20','⚠️\x20[DEBUG]\x20No\x20timers\x20found\x20for\x20payment\x20','getServiceStats','8122160ppdAEV','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paid','🔍\x20[CHECK]\x20Starting\x20check\x20for\x20payment\x20ID:\x20','Shop\x20webhook\x20sent\x20to\x20','\x20expired','\x20days,\x20will\x20be\x20handled\x20by\x20global\x20expiry\x20check','schedule_created','settings','COINTOPAY_STATUS_CHANGE','./gateways/coinToPay2Service','sendPaymentNotification','EXPIRED','webhook_send','failed','🏦\x20[CHECK]\x20Saved\x20bank\x20details\x20to\x20admin\x20notes','🛑\x20[SHUTDOWN]\x20CoinToPay\x20global\x20status\x20checking\x20stopped','🔍\x20[MANUAL]\x20Manual\x20check\x20requested\x20for\x20payment:\x20','__esModule','cointopay2','EXPIRY_DAYS','create','paidAt','9hgbhhw','coinToPay2Service','\x20status\x20from\x20','coinToPayStatusService','🪙\x20[GLOBAL]\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','\x20checked,\x20','\x20status\x20changed\x20to\x20','\x20days','webhookUrl','defineProperty','🧹\x20[CHECK]\x20Payment\x20','getGatewayIdByName','logShopWebhookError','size','631094DJriNM','h),\x20skipping\x20global\x20check','366aZBhkv','stringify',',\x20clearing\x20individual\x20timers','📊\x20[CHECK]\x20CoinToPay2\x20payment\x20','\x20found:','ms)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Bank\x20Details:\x20','createdAt','\x20status\x20unchanged\x20(','\x20already\x20marked\x20as\x20expired,\x20skipping\x20global\x20check','\x20marked\x20as\x20paid\x20at:\x20','CoinToPayService','✅\x20[MANUAL]\x20Manual\x20check\x20completed\x20for\x20payment\x20','🪙\x20[DEBUG]\x20schedulePaymentChecks\x20called\x20with:','Webhook\x20event\x20','✅\x20[MANUAL]\x20Starting\x20manual\x20check\x20for\x20','\x20for\x20payment\x20','FAILED','\x20initial\x20timers\x20for\x20payment\x20','\x20details:','./gateways/coinToPayService','logCoinToPayStatus','\x20seconds\x20(','⚠️\x20[CHECK]\x20Payment\x20','\x20\x20\x20-\x20gatewayPaymentId:\x20','⏰\x20[GLOBAL]\x20Found\x20','TesSoft\x20Payment\x20System/1.0','\x20not\x20found\x20in\x20database','loggerService','💰\x20[CHECK]\x20Payment\x20','createdOn','sendShopWebhook','🔍\x20[GLOBAL]\x20Checking\x20old\x20payment\x20','clearPaymentTimers','iban','created','-day\x20timeout','\x20expired\x20CoinToPay\x20payments','gateway','.\x20Remaining\x20active\x20timers:\x20','not\x20found','expired','toLowerCase','sendPaymentStatusNotification','\x20updated\x20successfully','customerEmail','forEach','Automatically\x20expired\x20after\x20','❌\x20[HOURLY]\x20Payment\x20','/status/','message','\x20\x20\x20📅\x20Time:\x20','🏦\x20[CHECK]\x20Saved\x20IBAN:\x20','❌\x20[GLOBAL]\x20Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','🛑\x20[SHUTDOWN]\x20Stopping\x20CoinToPay\x20status\x20checking\x20service...','📊\x20[HOURLY]\x20Payment\x20','shopId','\x20days\x20without\x20payment\x20confirmation','checkSinglePayment','status','20aBaFTU','🧹\x20[DEBUG]\x20Cleared\x20timer\x20#','error','checkExpiredPayments','delete','text','application/json','toFixed','checkSinglePaymentById','telegramBotService','description','GLOBAL_CHECK_INTERVAL_MS','🛑\x20[SHUTDOWN]\x20Cleared\x20','Unknown\x20error','POST','payment.failed','🪙\x20[LOG]\x20CoinToPay\x20Status\x20Change:\x20','setDate','values','\x20(after\x20','🪙\x20[INIT]\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(global\x20checks\x20every\x201\x20hour)','Success','\x20\x20\x20📍\x20Source:\x20','❌\x20[CHECK]\x20Failed\x20to\x20check\x20payment\x20','❌\x20[GLOBAL]\x20Periodic\x20CoinToPay\x20status\x20check\x20failed:','⏰\x20[EXPIRY]\x20Payment\x20','toISOString','🆔\x20[CHECK]\x20Transaction\x20ID:\x20','../types/gateway','❌\x20[CHECK]\x20Payment\x20','📊\x20[DEBUG]\x20Total\x20active\x20payment\x20timers:\x20','__importDefault','payment.pending','CoinToPay2Service','logCoinToPayError','\x20\x20\x20📝\x20Context:','✅\x20[DEBUG]\x20Successfully\x20scheduled\x20','\x20\x20\x20-\x20Gateway:\x20'];a37_0x1be3=function(){return _0x4ca1fe;};return a37_0x1be3();}const coinToPayService_1=require(a37_0x4f705d(0x20a)),coinToPay2Service_1=require(a37_0x4f705d(0x1d8)),gateway_1=require(a37_0x4f705d(0x155)),database_1=__importDefault(require('../config/database')),telegramBotService_1=require(a37_0x4f705d(0x18a)),loggerService_1=require(a37_0x4f705d(0x19d));class CoinToPayStatusService{constructor(){const _0xdcadac=a37_0x4f705d;this[_0xdcadac(0x15f)]=null,this[_0xdcadac(0x144)]=0x3c*0x3c*0x3e8,this[_0xdcadac(0x1e2)]=0x5,this[_0xdcadac(0x160)]=new Map(),this[_0xdcadac(0x1a1)]=new coinToPayService_1[(_0xdcadac(0x201))](),this[_0xdcadac(0x1e6)]=new coinToPay2Service_1[(_0xdcadac(0x15a))](),console['log'](_0xdcadac(0x1c9));}[a37_0x4f705d(0x1b5)](_0x269303,_0x388813){const _0x379c85=a37_0x4f705d;console[_0x379c85(0x1ab)](_0x379c85(0x203)),console[_0x379c85(0x1ab)](_0x379c85(0x188)+_0x269303),console[_0x379c85(0x1ab)](_0x379c85(0x20e)+_0x388813),this[_0x379c85(0x217)](_0x269303);const _0x30d306=[],_0x1f670b=new Date(),_0x25ea34=[{'delay':0x1*0x3c*0x3e8,'description':_0x379c85(0x181)},{'delay':0x2*0x3c*0x3e8,'description':_0x379c85(0x19b)},{'delay':0x5*0x3c*0x3e8,'description':'5\x20minutes'},{'delay':0x5*0x3c*0x3e8,'description':_0x379c85(0x166)}];console[_0x379c85(0x1ab)]('🪙\x20[DEBUG]\x20Creating\x20'+_0x25ea34[_0x379c85(0x1a8)]+_0x379c85(0x208)+_0x269303);let _0x4dda6a=0x0;_0x25ea34[_0x379c85(0x224)]((_0xd0638c,_0x288c8f)=>{const _0x179d60=_0x379c85;_0x4dda6a+=_0xd0638c[_0x179d60(0x1ad)];const _0x18ef9c=setTimeout(async()=>{const _0x1def8=_0x179d60;console[_0x1def8(0x1ab)](_0x1def8(0x1a5)+(_0x288c8f+0x1)+_0x1def8(0x167)+_0x269303+_0x1def8(0x14c)+_0xd0638c[_0x1def8(0x143)]+')');try{await this[_0x1def8(0x141)](_0x269303),console['log']('✅\x20[TIMER]\x20Individual\x20check\x20#'+(_0x288c8f+0x1)+_0x1def8(0x19a)+_0x269303);}catch(_0x11cf6f){console[_0x1def8(0x13b)](_0x1def8(0x1ba)+(_0x288c8f+0x1)+_0x1def8(0x206)+_0x269303+':',_0x11cf6f),this['logCoinToPayError'](_0x269303,_0x388813,_0x11cf6f,_0x1def8(0x184),{'checkNumber':_0x288c8f+0x1,'scheduledAfter':_0xd0638c[_0x1def8(0x143)],'isIndividualCheck':!![]});}},_0x4dda6a);_0x30d306[_0x179d60(0x175)](_0x18ef9c),console['log']('⏰\x20[DEBUG]\x20Scheduled\x20check\x20#'+(_0x288c8f+0x1)+'\x20for\x20payment\x20'+_0x269303+_0x179d60(0x186)+_0x4dda6a/0x3e8+_0x179d60(0x20c)+_0xd0638c[_0x179d60(0x143)]+')');});const _0x5c8a37=setInterval(async()=>{const _0x23694d=_0x379c85;console['log'](_0x23694d(0x1a6)+_0x269303);try{const _0x7eda26=await database_1[_0x23694d(0x19c)][_0x23694d(0x1b8)]['findUnique']({'where':{'id':_0x269303},'select':{'id':!![],'status':!![],'createdAt':!![],'gatewayPaymentId':!![]}});if(!_0x7eda26){console[_0x23694d(0x1ab)](_0x23694d(0x226)+_0x269303+_0x23694d(0x1a7)),this['clearPaymentTimers'](_0x269303);return;}console[_0x23694d(0x1ab)](_0x23694d(0x22d)+_0x269303+_0x23694d(0x197)+_0x7eda26[_0x23694d(0x138)]);if(_0x7eda26['status']!==_0x23694d(0x18c)){console['log']('✅\x20[HOURLY]\x20Payment\x20'+_0x269303+_0x23694d(0x17e)+_0x7eda26[_0x23694d(0x138)]+_0x23694d(0x1b1)),this[_0x23694d(0x217)](_0x269303);return;}const _0x375ece=Math[_0x23694d(0x1b6)]((Date[_0x23694d(0x1c0)]()-_0x7eda26[_0x23694d(0x1fd)][_0x23694d(0x1c6)]())/(0x3e8*0x3c*0x3c*0x18));if(_0x375ece>=this[_0x23694d(0x1e2)]){console[_0x23694d(0x1ab)](_0x23694d(0x1bc)+_0x269303+'\x20is\x20older\x20than\x20'+this[_0x23694d(0x1e2)]+_0x23694d(0x1d4)),this[_0x23694d(0x217)](_0x269303);return;}await this[_0x23694d(0x141)](_0x269303),console[_0x23694d(0x1ab)](_0x23694d(0x1c4)+_0x269303);}catch(_0x2687d5){console['error']('❌\x20[HOURLY]\x20Failed\x20hourly\x20check\x20for\x20payment\x20'+_0x269303+':',_0x2687d5),this[_0x23694d(0x15b)](_0x269303,_0x388813,_0x2687d5,_0x23694d(0x184),{'isHourlyCheck':!![],'isIndividualCheck':!![]});}},0x3c*0x3c*0x3e8);_0x30d306[_0x379c85(0x175)](_0x5c8a37),this[_0x379c85(0x160)]['set'](_0x269303,{'timers':_0x30d306,'paymentId':_0x269303,'gatewayPaymentId':_0x388813,'createdAt':_0x1f670b}),console[_0x379c85(0x1ab)](_0x379c85(0x15d)+_0x25ea34[_0x379c85(0x1a8)]+_0x379c85(0x196)+_0x269303),console['log'](_0x379c85(0x157)+this['paymentTimers'][_0x379c85(0x1f2)]),this[_0x379c85(0x20b)](_0x269303,_0x388813,_0x379c85(0x18c),_0x379c85(0x18c),_0x379c85(0x184),{'action':_0x379c85(0x1d5),'scheduledChecks':_0x25ea34[_0x379c85(0x1a8)],'firstCheckIn':_0x25ea34[0x0][_0x379c85(0x1ad)]/0x3e8,'totalTimers':this[_0x379c85(0x160)]['size']});}[a37_0x4f705d(0x217)](_0x26a60a){const _0x232511=a37_0x4f705d,_0x10d674=this[_0x232511(0x160)]['get'](_0x26a60a);_0x10d674?(console[_0x232511(0x1ab)]('🧹\x20[DEBUG]\x20Clearing\x20'+_0x10d674['timers']['length']+_0x232511(0x1b9)+_0x26a60a),_0x10d674[_0x232511(0x189)][_0x232511(0x224)]((_0x43433f,_0x3a7bbe)=>{const _0x1d45a4=_0x232511;_0x43433f&&(clearTimeout(_0x43433f),clearInterval(_0x43433f),console[_0x1d45a4(0x1ab)](_0x1d45a4(0x13a)+(_0x3a7bbe+0x1)+_0x1d45a4(0x206)+_0x26a60a));}),this[_0x232511(0x160)][_0x232511(0x13d)](_0x26a60a),console['log'](_0x232511(0x172)+_0x26a60a+_0x232511(0x21d)+this[_0x232511(0x160)][_0x232511(0x1f2)])):console[_0x232511(0x1ab)](_0x232511(0x1cc)+_0x26a60a+_0x232511(0x1bf));}async[a37_0x4f705d(0x141)](_0x2ac054){const _0x210bf5=a37_0x4f705d;console[_0x210bf5(0x1ab)](_0x210bf5(0x1d1)+_0x2ac054);const _0x22b38f=await database_1[_0x210bf5(0x19c)][_0x210bf5(0x1b8)][_0x210bf5(0x165)]({'where':{'id':_0x2ac054},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'gateway':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22b38f){console[_0x210bf5(0x1ab)](_0x210bf5(0x156)+_0x2ac054+_0x210bf5(0x211));return;}console['log'](_0x210bf5(0x193)+_0x2ac054+_0x210bf5(0x1f9)),console[_0x210bf5(0x1ab)](_0x210bf5(0x15e)+_0x22b38f[_0x210bf5(0x21c)]),console[_0x210bf5(0x1ab)]('\x20\x20\x20-\x20Status:\x20'+_0x22b38f[_0x210bf5(0x138)]),console[_0x210bf5(0x1ab)](_0x210bf5(0x16f)+_0x22b38f[_0x210bf5(0x180)]),console[_0x210bf5(0x1ab)]('\x20\x20\x20-\x20Amount:\x20'+_0x22b38f[_0x210bf5(0x191)]+'\x20'+_0x22b38f[_0x210bf5(0x173)]),console[_0x210bf5(0x1ab)]('\x20\x20\x20-\x20ShopId:\x20'+_0x22b38f[_0x210bf5(0x135)]);if(_0x22b38f[_0x210bf5(0x21c)]!==_0x210bf5(0x171)&&_0x22b38f[_0x210bf5(0x21c)]!==_0x210bf5(0x1e1)){console[_0x210bf5(0x1ab)](_0x210bf5(0x20d)+_0x2ac054+_0x210bf5(0x1b4)+_0x22b38f[_0x210bf5(0x21c)]+')');return;}if(_0x22b38f['status']!==_0x210bf5(0x18c)){console[_0x210bf5(0x1ab)](_0x210bf5(0x20d)+_0x2ac054+_0x210bf5(0x17e)+_0x22b38f[_0x210bf5(0x138)]+_0x210bf5(0x1b1)),this[_0x210bf5(0x217)](_0x2ac054);return;}if(!_0x22b38f[_0x210bf5(0x180)]){console['log']('⚠️\x20[CHECK]\x20Payment\x20'+_0x2ac054+_0x210bf5(0x16c));return;}console['log']('✅\x20[CHECK]\x20Payment\x20'+_0x2ac054+_0x210bf5(0x17b)),await this[_0x210bf5(0x137)](_0x22b38f);}[a37_0x4f705d(0x20b)](_0x22b558,_0x447787,_0xea4760,_0x257c63,_0x3cdab7,_0xcb5454){const _0x2345e2=a37_0x4f705d,_0x371b3b={'type':_0x2345e2(0x1d7),'paymentId':_0x22b558,'gatewayPaymentId':_0x447787,'oldStatus':_0xea4760,'newStatus':_0x257c63,'source':_0x3cdab7,'timestamp':new Date()['toISOString'](),'details':_0xcb5454||{}};loggerService_1[_0x2345e2(0x212)][_0x2345e2(0x20b)](_0x371b3b),console['log'](_0x2345e2(0x149)+_0x22b558+'\x20('+_0x447787+')'),console[_0x2345e2(0x1ab)]('\x20\x20\x20📊\x20Status:\x20'+_0xea4760+'\x20->\x20'+_0x257c63),console[_0x2345e2(0x1ab)](_0x2345e2(0x14f)+_0x3cdab7),console[_0x2345e2(0x1ab)](_0x2345e2(0x229)+_0x371b3b[_0x2345e2(0x19f)]),_0xcb5454&&console[_0x2345e2(0x1ab)](_0x2345e2(0x164),_0xcb5454);}[a37_0x4f705d(0x15b)](_0x2e429e,_0x1238ae,_0x3d29bd,_0x525a38,_0x4ff9dd){const _0x3490d8=a37_0x4f705d,_0x150b56={'type':'COINTOPAY_ERROR','paymentId':_0x2e429e,'gatewayPaymentId':_0x1238ae,'error':_0x3d29bd instanceof Error?{'message':_0x3d29bd[_0x3490d8(0x228)],'stack':_0x3d29bd[_0x3490d8(0x161)]}:_0x3d29bd,'source':_0x525a38,'timestamp':new Date()[_0x3490d8(0x153)](),'context':_0x4ff9dd||{}};loggerService_1['loggerService']['logCoinToPayError'](_0x150b56),console['error'](_0x3490d8(0x1c5)+_0x2e429e+'\x20('+_0x1238ae+')'),console[_0x3490d8(0x13b)](_0x3490d8(0x187)+(_0x3d29bd instanceof Error?_0x3d29bd[_0x3490d8(0x228)]:_0x3d29bd)),console[_0x3490d8(0x13b)](_0x3490d8(0x14f)+_0x525a38),console[_0x3490d8(0x13b)](_0x3490d8(0x229)+_0x150b56[_0x3490d8(0x19f)]),_0x4ff9dd&&console['error'](_0x3490d8(0x15c),_0x4ff9dd);}[a37_0x4f705d(0x1c3)](){const _0x205428=a37_0x4f705d;console['log'](_0x205428(0x14d)),this['checkAllPendingPayments']()['catch'](_0x310057=>{const _0x282637=_0x205428;console[_0x282637(0x13b)](_0x282637(0x17a),_0x310057);}),this[_0x205428(0x15f)]=setInterval(async()=>{const _0x10a3e2=_0x205428;try{console['log']('🪙\x20[GLOBAL]\x20Starting\x20global\x20check\x20cycle...'),await this[_0x10a3e2(0x1a0)](),console['log']('✅\x20[GLOBAL]\x20Global\x20check\x20cycle\x20completed');}catch(_0x6dfca1){console[_0x10a3e2(0x13b)](_0x10a3e2(0x151),_0x6dfca1);}},this[_0x205428(0x144)]),console[_0x205428(0x1ab)]('✅\x20[INIT]\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(global\x20hourly\x20checks\x20+\x20individual\x20payment\x20timers)');}[a37_0x4f705d(0x194)](){const _0x1ddd95=a37_0x4f705d;console['log'](_0x1ddd95(0x22c));this[_0x1ddd95(0x15f)]&&(clearInterval(this[_0x1ddd95(0x15f)]),this['globalCheckInterval']=null,console['log'](_0x1ddd95(0x1de)));const _0x2652ab=this[_0x1ddd95(0x160)][_0x1ddd95(0x1f2)];for(const [_0x1878a6]of this['paymentTimers']){this[_0x1ddd95(0x217)](_0x1878a6);}console['log'](_0x1ddd95(0x145)+_0x2652ab+'\x20individual\x20payment\x20timers');}async[a37_0x4f705d(0x1a0)](){const _0x25185b=a37_0x4f705d;try{console[_0x25185b(0x1ab)](_0x25185b(0x1bb));const _0x19a1ae=await database_1[_0x25185b(0x19c)][_0x25185b(0x1b8)][_0x25185b(0x17d)]({'where':{'gateway':{'in':[_0x25185b(0x171),_0x25185b(0x1e1)]},'status':_0x25185b(0x18c),'gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'remitterIban':!![],'customerIp':!![],'customerUa':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});console[_0x25185b(0x1ab)](_0x25185b(0x17c)+_0x19a1ae[_0x25185b(0x1a8)]+'\x20pending\x20CoinToPay\x20payments');if(_0x19a1ae[_0x25185b(0x1a8)]===0x0){console[_0x25185b(0x1ab)](_0x25185b(0x1e9));return;}const _0xea69e6=await this[_0x25185b(0x13c)](_0x19a1ae);console[_0x25185b(0x1ab)](_0x25185b(0x20f)+_0xea69e6[_0x25185b(0x1a8)]+_0x25185b(0x21b));let _0x31dab9=0x0,_0xec7e45=0x0;for(const _0x81353a of _0x19a1ae){try{if(_0xea69e6[_0x25185b(0x177)](_0x81353a['id'])){console[_0x25185b(0x1ab)]('⏰\x20[GLOBAL]\x20Payment\x20'+_0x81353a['id']+_0x25185b(0x1ff)),_0xec7e45++;continue;}if(this['paymentTimers']['has'](_0x81353a['id'])){console['log'](_0x25185b(0x1ac)+_0x81353a['id']+'\x20has\x20individual\x20timers,\x20skipping\x20global\x20check'),_0xec7e45++;continue;}const _0x537d1d=(Date[_0x25185b(0x1c0)]()-_0x81353a[_0x25185b(0x1fd)][_0x25185b(0x1c6)]())/(0x3e8*0x3c*0x3c);if(_0x537d1d<0x1){console['log'](_0x25185b(0x1ac)+_0x81353a['id']+_0x25185b(0x16d)+_0x537d1d[_0x25185b(0x140)](0x1)+_0x25185b(0x1f4)),_0xec7e45++;continue;}console[_0x25185b(0x1ab)](_0x25185b(0x216)+_0x81353a['id']+_0x25185b(0x17f)+_0x537d1d[_0x25185b(0x140)](0x1)+'h)'),await this[_0x25185b(0x137)](_0x81353a),_0x31dab9++,await new Promise(_0x26782e=>setTimeout(_0x26782e,0x7d0));}catch(_0x192854){console[_0x25185b(0x13b)](_0x25185b(0x162)+_0x81353a['id']+':',_0x192854),this[_0x25185b(0x15b)](_0x81353a['id'],_0x81353a[_0x25185b(0x180)]||_0x25185b(0x1be),_0x192854,'status_check',{'isGlobalCheck':!![],'paymentAmount':_0x81353a[_0x25185b(0x191)],'paymentCurrency':_0x81353a[_0x25185b(0x173)],'shopId':_0x81353a['shopId'],'createdAt':_0x81353a[_0x25185b(0x1fd)]}),loggerService_1['loggerService']['logWhiteDomainError']('cointopay',_0x25185b(0x227)+_0x81353a[_0x25185b(0x180)],_0x192854);}}console[_0x25185b(0x1ab)](_0x25185b(0x183)+_0x31dab9+_0x25185b(0x1ea)+_0xec7e45+'\x20skipped,\x20'+_0xea69e6['length']+_0x25185b(0x1d3));}catch(_0x4de53c){console['error'](_0x25185b(0x22b),_0x4de53c);}}async['checkExpiredPayments'](_0x48d015){const _0x4e69f7=a37_0x4f705d,_0x15cfc9=[],_0x5e2a18=new Date();_0x5e2a18[_0x4e69f7(0x14a)](_0x5e2a18[_0x4e69f7(0x16e)]()-this['EXPIRY_DAYS']),console[_0x4e69f7(0x1ab)]('⏰\x20[EXPIRY]\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20'+this[_0x4e69f7(0x1e2)]+_0x4e69f7(0x1ae)+_0x5e2a18[_0x4e69f7(0x153)]()+')');for(const _0x16df89 of _0x48d015){if(_0x16df89['createdAt']<_0x5e2a18){console[_0x4e69f7(0x1ab)](_0x4e69f7(0x152)+_0x16df89['id']+'\x20is\x20older\x20than\x20'+this[_0x4e69f7(0x1e2)]+_0x4e69f7(0x1aa));try{this[_0x4e69f7(0x20b)](_0x16df89['id'],_0x16df89[_0x4e69f7(0x180)]||_0x4e69f7(0x1be),_0x4e69f7(0x18c),_0x4e69f7(0x1da),_0x4e69f7(0x1c7),{'reason':'Payment\x20older\x20than\x20'+this[_0x4e69f7(0x1e2)]+'\x20days','createdAt':_0x16df89[_0x4e69f7(0x1fd)],'daysSinceCreation':Math['floor']((Date[_0x4e69f7(0x1c0)]()-_0x16df89[_0x4e69f7(0x1fd)][_0x4e69f7(0x1c6)]())/(0x3e8*0x3c*0x3c*0x18)),'paymentAmount':_0x16df89['amount'],'paymentCurrency':_0x16df89[_0x4e69f7(0x173)],'shopId':_0x16df89[_0x4e69f7(0x135)]}),await database_1[_0x4e69f7(0x19c)][_0x4e69f7(0x1b8)][_0x4e69f7(0x1ca)]({'where':{'id':_0x16df89['id']},'data':{'status':_0x4e69f7(0x1da),'updatedAt':new Date(),'adminNotes':_0x4e69f7(0x225)+this['EXPIRY_DAYS']+_0x4e69f7(0x136)}}),await database_1['default'][_0x4e69f7(0x176)][_0x4e69f7(0x1e3)]({'data':{'paymentId':_0x16df89['id'],'shopId':_0x16df89[_0x4e69f7(0x135)],'event':_0x4e69f7(0x1c1),'statusCode':0xc8,'responseBody':JSON[_0x4e69f7(0x1f6)]({'reason':_0x4e69f7(0x1cb)+this['EXPIRY_DAYS']+_0x4e69f7(0x1ec),'createdAt':_0x16df89[_0x4e69f7(0x1fd)],'expiredAt':new Date()[_0x4e69f7(0x153)](),'daysSinceCreation':Math['floor']((Date[_0x4e69f7(0x1c0)]()-_0x16df89[_0x4e69f7(0x1fd)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))})}}),await this[_0x4e69f7(0x215)](_0x16df89,'EXPIRED'),await this['sendPaymentStatusNotification'](_0x16df89,_0x4e69f7(0x1da)),this[_0x4e69f7(0x217)](_0x16df89['id']),_0x15cfc9[_0x4e69f7(0x175)](_0x16df89['id']),console['log'](_0x4e69f7(0x1c2)+_0x16df89['id']+_0x4e69f7(0x190)+this[_0x4e69f7(0x1e2)]+_0x4e69f7(0x21a));}catch(_0x583761){console[_0x4e69f7(0x13b)](_0x4e69f7(0x1a2)+_0x16df89['id']+':',_0x583761),this[_0x4e69f7(0x15b)](_0x16df89['id'],_0x16df89[_0x4e69f7(0x180)]||_0x4e69f7(0x1be),_0x583761,_0x4e69f7(0x1c7),{'reason':_0x4e69f7(0x18e),'createdAt':_0x16df89[_0x4e69f7(0x1fd)],'daysSinceCreation':Math[_0x4e69f7(0x1b6)]((Date[_0x4e69f7(0x1c0)]()-_0x16df89[_0x4e69f7(0x1fd)][_0x4e69f7(0x1c6)]())/(0x3e8*0x3c*0x3c*0x18))});}}}return _0x15cfc9;}async['checkSinglePayment'](_0x2b1caf){const _0x4ea556=a37_0x4f705d;if(!_0x2b1caf[_0x4ea556(0x180)]){console[_0x4ea556(0x1ab)](_0x4ea556(0x20d)+_0x2b1caf['id']+_0x4ea556(0x18b));return;}console[_0x4ea556(0x1ab)]('🔍\x20[CHECK]\x20Checking\x20'+_0x2b1caf['gateway']+'\x20payment\x20'+_0x2b1caf['id']+'\x20('+_0x2b1caf['gatewayPaymentId']+')');try{let _0x222c44;_0x2b1caf[_0x4ea556(0x21c)]==='cointopay2'?(_0x222c44=await this[_0x4ea556(0x1e6)][_0x4ea556(0x168)](_0x2b1caf[_0x4ea556(0x180)]),console[_0x4ea556(0x1ab)](_0x4ea556(0x1f8)+_0x2b1caf['id']+_0x4ea556(0x195)+_0x222c44['status'])):(_0x222c44=await this[_0x4ea556(0x1a1)][_0x4ea556(0x168)](_0x2b1caf[_0x4ea556(0x180)]),console[_0x4ea556(0x1ab)]('📊\x20[CHECK]\x20CoinToPay\x20payment\x20'+_0x2b1caf['id']+_0x4ea556(0x195)+_0x222c44[_0x4ea556(0x138)]));_0x222c44[_0x4ea556(0x1a9)]&&console['log'](_0x4ea556(0x193)+_0x2b1caf['id']+_0x4ea556(0x209),{'iban':_0x222c44[_0x4ea556(0x1a9)][_0x4ea556(0x218)]||_0x4ea556(0x21e),'transactionId':_0x222c44[_0x4ea556(0x1a9)][_0x4ea556(0x1af)],'createdOn':_0x222c44['paymentDetails'][_0x4ea556(0x214)],'confirmedOn':_0x222c44[_0x4ea556(0x1a9)][_0x4ea556(0x18d)]||'not\x20confirmed'});if(_0x222c44[_0x4ea556(0x138)]!==_0x2b1caf[_0x4ea556(0x138)]){console[_0x4ea556(0x1ab)]('🔄\x20[CHECK]\x20Updating\x20payment\x20'+_0x2b1caf['id']+_0x4ea556(0x1e7)+_0x2b1caf[_0x4ea556(0x138)]+'\x20to\x20'+_0x222c44[_0x4ea556(0x138)]),this[_0x4ea556(0x20b)](_0x2b1caf['id'],_0x2b1caf['gatewayPaymentId'],_0x2b1caf['status'],_0x222c44['status'],_0x4ea556(0x184),{'paymentDetails':_0x222c44['paymentDetails'],'amount':_0x222c44[_0x4ea556(0x191)],'currency':_0x222c44[_0x4ea556(0x173)],'shopId':_0x2b1caf[_0x4ea556(0x135)],'checkTimestamp':new Date()['toISOString']()});const _0x5de9bc={'status':_0x222c44[_0x4ea556(0x138)],'updatedAt':new Date()};_0x222c44['status']===_0x4ea556(0x16a)&&_0x2b1caf['status']!==_0x4ea556(0x16a)&&(_0x5de9bc[_0x4ea556(0x1e4)]=new Date(),console['log'](_0x4ea556(0x213)+_0x2b1caf['id']+_0x4ea556(0x200)+_0x5de9bc[_0x4ea556(0x1e4)]['toISOString']()));if(_0x222c44[_0x4ea556(0x1a9)]){const _0x1cf916=_0x222c44[_0x4ea556(0x1a9)];_0x1cf916[_0x4ea556(0x218)]&&(_0x5de9bc[_0x4ea556(0x199)]=_0x1cf916[_0x4ea556(0x218)],console[_0x4ea556(0x1ab)](_0x4ea556(0x22a)+_0x1cf916['iban']));if(_0x1cf916['bankDetails']){const _0x33bb0e=_0x2b1caf[_0x4ea556(0x1a4)]||'',_0x1085e1=_0x4ea556(0x1fc)+_0x1cf916['bankDetails'];_0x5de9bc[_0x4ea556(0x1a4)]=_0x33bb0e?_0x33bb0e+'\x0a\x0a'+_0x1085e1:_0x1085e1,console[_0x4ea556(0x1ab)](_0x4ea556(0x1dd));}_0x1cf916[_0x4ea556(0x1af)]&&console[_0x4ea556(0x1ab)](_0x4ea556(0x154)+_0x1cf916[_0x4ea556(0x1af)]),_0x1cf916['confirmedOn']&&console['log']('✅\x20[CHECK]\x20Transaction\x20confirmed\x20on:\x20'+_0x1cf916['confirmedOn']);}await database_1[_0x4ea556(0x19c)]['payment']['update']({'where':{'id':_0x2b1caf['id']},'data':_0x5de9bc}),await database_1[_0x4ea556(0x19c)][_0x4ea556(0x176)][_0x4ea556(0x1e3)]({'data':{'paymentId':_0x2b1caf['id'],'shopId':_0x2b1caf[_0x4ea556(0x135)],'event':_0x4ea556(0x169)+_0x222c44[_0x4ea556(0x138)][_0x4ea556(0x220)](),'statusCode':0xc8,'responseBody':JSON[_0x4ea556(0x1f6)]({'oldStatus':_0x2b1caf[_0x4ea556(0x138)],'newStatus':_0x222c44[_0x4ea556(0x138)],'paymentDetails':_0x222c44[_0x4ea556(0x1a9)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x4ea556(0x215)](_0x2b1caf,_0x222c44['status']),await this[_0x4ea556(0x221)](_0x2b1caf,_0x222c44[_0x4ea556(0x138)]),_0x222c44[_0x4ea556(0x138)]!==_0x4ea556(0x18c)&&(console[_0x4ea556(0x1ab)](_0x4ea556(0x1ef)+_0x2b1caf['id']+_0x4ea556(0x1eb)+_0x222c44[_0x4ea556(0x138)]+_0x4ea556(0x1f7)),this[_0x4ea556(0x217)](_0x2b1caf['id'])),console[_0x4ea556(0x1ab)](_0x4ea556(0x178)+_0x2b1caf['id']+_0x4ea556(0x222));}else console[_0x4ea556(0x1ab)](_0x4ea556(0x193)+_0x2b1caf['id']+_0x4ea556(0x1fe)+_0x222c44[_0x4ea556(0x138)]+')'),this[_0x4ea556(0x20b)](_0x2b1caf['id'],_0x2b1caf['gatewayPaymentId'],_0x2b1caf['status'],_0x222c44[_0x4ea556(0x138)],'status_check',{'statusUnchanged':!![],'paymentDetails':_0x222c44[_0x4ea556(0x1a9)],'amount':_0x222c44[_0x4ea556(0x191)],'currency':_0x222c44[_0x4ea556(0x173)],'shopId':_0x2b1caf[_0x4ea556(0x135)],'checkTimestamp':new Date()[_0x4ea556(0x153)]()});}catch(_0x2151a7){console[_0x4ea556(0x13b)](_0x4ea556(0x150)+_0x2b1caf['id']+':',_0x2151a7),this[_0x4ea556(0x15b)](_0x2b1caf['id'],_0x2b1caf['gatewayPaymentId'],_0x2151a7,_0x4ea556(0x184),{'paymentAmount':_0x2b1caf[_0x4ea556(0x191)],'paymentCurrency':_0x2b1caf['currency'],'shopId':_0x2b1caf[_0x4ea556(0x135)],'createdAt':_0x2b1caf[_0x4ea556(0x1fd)]}),await database_1[_0x4ea556(0x19c)][_0x4ea556(0x176)]['create']({'data':{'paymentId':_0x2b1caf['id'],'shopId':_0x2b1caf[_0x4ea556(0x135)],'event':'cointopay_status_check_error','statusCode':0x1f4,'responseBody':JSON[_0x4ea556(0x1f6)]({'error':_0x2151a7 instanceof Error?_0x2151a7[_0x4ea556(0x228)]:_0x4ea556(0x146),'gatewayPaymentId':_0x2b1caf[_0x4ea556(0x180)],'checkedAt':new Date()[_0x4ea556(0x153)]()})}});}}async[a37_0x4f705d(0x215)](_0x51b2c2,_0x5c63ff){const _0x5069ce=a37_0x4f705d,_0xd7dd9c=Date[_0x5069ce(0x1c0)]();try{const _0x15089b=_0x51b2c2[_0x5069ce(0x1c8)],_0x40279d=_0x15089b[_0x5069ce(0x1d6)];if(!_0x40279d?.['webhookUrl']){console[_0x5069ce(0x1ab)](_0x5069ce(0x1fb)+_0x15089b['id']);return;}const _0x2ca89b=_0x5c63ff===_0x5069ce(0x16a)?'payment.success':_0x5c63ff===_0x5069ce(0x207)?_0x5069ce(0x148):_0x5c63ff===_0x5069ce(0x1da)?_0x5069ce(0x148):_0x5069ce(0x159);if(!_0x40279d[_0x5069ce(0x1b2)]?.['includes'](_0x2ca89b)){console[_0x5069ce(0x1ab)](_0x5069ce(0x204)+_0x2ca89b+_0x5069ce(0x1b3)+_0x15089b['id']);return;}const _0x4f25c3=(0x0,gateway_1[_0x5069ce(0x1f0)])(_0x51b2c2['gateway'])||_0x51b2c2['gateway'],_0x3804c6={'event':_0x2ca89b,'payment':{'id':_0x51b2c2['id'],'order_id':_0x51b2c2[_0x5069ce(0x198)],'gateway_order_id':_0x51b2c2['gatewayOrderId'],'gateway':_0x4f25c3,'amount':_0x51b2c2[_0x5069ce(0x191)],'currency':_0x51b2c2[_0x5069ce(0x173)],'status':_0x5c63ff[_0x5069ce(0x220)](),'customer_email':_0x51b2c2[_0x5069ce(0x223)],'customer_name':_0x51b2c2['customerName'],'created_at':_0x51b2c2['createdAt'],'updated_at':new Date()}},_0x56f8c5=await fetch(_0x40279d[_0x5069ce(0x1ed)],{'method':_0x5069ce(0x147),'headers':{'Content-Type':_0x5069ce(0x13f),'User-Agent':_0x5069ce(0x210)},'body':JSON[_0x5069ce(0x1f6)](_0x3804c6)}),_0x352f40=Date[_0x5069ce(0x1c0)]()-_0xd7dd9c,_0x5940f5=_0x56f8c5['ok']?_0x5069ce(0x14e):await _0x56f8c5[_0x5069ce(0x13e)]();loggerService_1[_0x5069ce(0x212)]['logShopWebhookSent'](_0x51b2c2[_0x5069ce(0x135)],_0x40279d[_0x5069ce(0x1ed)],_0x2ca89b,_0x56f8c5['status'],_0x352f40,_0x3804c6),console[_0x5069ce(0x1ab)](_0x5069ce(0x1d2)+_0x40279d['webhookUrl']+'\x20with\x20status\x20'+_0x56f8c5['status']+'\x20('+_0x352f40+_0x5069ce(0x1fa));}catch(_0xda1818){console[_0x5069ce(0x13b)](_0x5069ce(0x163),_0xda1818),loggerService_1[_0x5069ce(0x212)][_0x5069ce(0x1f1)](_0x51b2c2[_0x5069ce(0x135)],_0x51b2c2[_0x5069ce(0x1c8)]?.['settings']?.[_0x5069ce(0x1ed)]||_0x5069ce(0x1be),_0x5069ce(0x1db),_0xda1818,{});}}async[a37_0x4f705d(0x221)](_0x2c787b,_0xc2edf6){const _0x4258a1=a37_0x4f705d;try{const _0x2d3211={'PENDING':_0x4258a1(0x219),'PAID':_0x4258a1(0x1d0),'FAILED':_0x4258a1(0x1dc),'EXPIRED':_0x4258a1(0x21f)},_0x11522b=_0x2d3211[_0xc2edf6];if(!_0x11522b||_0x11522b==='created')return;await telegramBotService_1[_0x4258a1(0x142)][_0x4258a1(0x1d9)](_0x2c787b[_0x4258a1(0x135)],_0x2c787b,_0x11522b);}catch(_0x3bc79c){console[_0x4258a1(0x13b)](_0x4258a1(0x1cf),_0x3bc79c);}}async[a37_0x4f705d(0x19e)](_0x9ab85c){const _0xfa762b=a37_0x4f705d;console['log'](_0xfa762b(0x1df)+_0x9ab85c);const _0x5711f3=await database_1[_0xfa762b(0x19c)][_0xfa762b(0x1b8)]['findUnique']({'where':{'id':_0x9ab85c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5711f3)throw new Error('Payment\x20not\x20found');if(_0x5711f3['gateway']!=='cointopay'&&_0x5711f3['gateway']!=='cointopay2')throw new Error(_0xfa762b(0x1b7));console['log'](_0xfa762b(0x205)+_0x5711f3[_0xfa762b(0x21c)]+_0xfa762b(0x179)+_0x9ab85c),await this[_0xfa762b(0x137)](_0x5711f3),console['log'](_0xfa762b(0x202)+_0x9ab85c);}[a37_0x4f705d(0x1cd)](){const _0x2a84ed=a37_0x4f705d,_0x46ecf7=this[_0x2a84ed(0x15f)]?this[_0x2a84ed(0x144)]:undefined,_0x1a1e93=Array[_0x2a84ed(0x170)](this['paymentTimers'][_0x2a84ed(0x14b)]())[_0x2a84ed(0x174)](_0x5c8be8=>({'paymentId':_0x5c8be8[_0x2a84ed(0x185)],'gatewayPaymentId':_0x5c8be8[_0x2a84ed(0x180)],'createdAt':_0x5c8be8[_0x2a84ed(0x1fd)],'timersCount':_0x5c8be8['timers']['length']}));return{'isActive':!!this[_0x2a84ed(0x15f)],'globalCheckIntervalMinutes':this['GLOBAL_CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x2a84ed(0x1e2)],'activeIndividualTimers':this[_0x2a84ed(0x160)]['size'],'nextGlobalCheckIn':_0x46ecf7,'paymentTimersDetails':_0x1a1e93};}[a37_0x4f705d(0x1bd)](_0x5d462e){const _0x3298b7=a37_0x4f705d,_0x237aec=this['paymentTimers']['get'](_0x5d462e);if(_0x237aec)return{'hasTimers':!![],'timersCount':_0x237aec[_0x3298b7(0x189)][_0x3298b7(0x1a8)],'createdAt':_0x237aec['createdAt'],'gatewayPaymentId':_0x237aec[_0x3298b7(0x180)]};return{'hasTimers':![]};}}exports[a37_0x4f705d(0x1a3)]=CoinToPayStatusService,exports['coinToPayStatusService']=new CoinToPayStatusService();