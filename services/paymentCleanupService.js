'use strict';const a57_0xd5dc4f=a57_0x106d;function a57_0x106d(_0x5e3ac0,_0x1b1da2){const _0x519df7=a57_0x519d();return a57_0x106d=function(_0x106d47,_0x268fc9){_0x106d47=_0x106d47-0xec;let _0x56e46d=_0x519df7[_0x106d47];return _0x56e46d;},a57_0x106d(_0x5e3ac0,_0x1b1da2);}function a57_0x519d(){const _0x5b4f33=['toISOString','FAILED','stale','runCleanupWithReport','PROCESSING_TIMEOUT_DAYS','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','currency','1303490kvuhxF','2718lOGnud','PaymentCleanupService','../config/database','loggerService','admin','payment_cleanup','🧹\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','setDate','amount','./loggerService','🚀\x20Starting\x20payment\x20cleanup\x20service...','9VwLhQI','recent','\x20stale\x20PROCESSING\x20payments','getDate','default','update','errors','cleanupStaleProcessingPayments','getTime','processed','byAge','🔍\x20Found\x20','getProcessingPaymentsStats','length','📊\x20PROCESSING\x20payments\x20after\x20cleanup:','📊\x20','\x20\x20\x20By\x20gateway:','__esModule','\x20\x20\x20Total:\x20','log','\x20\x20\x20Age:\x20','username','\x20failed\x20to\x20update','gateway','system','floor','expired','shop','\x20days','createdAt','POST','Cleanup\x20completed:\x20','Failed\x20to\x20update\x20payment\x20','\x20\x20\x20✅\x20Successfully\x20processed:\x20','1302LVLDVe','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','💥\x20','📊\x20PROCESSING\x20payments\x20before\x20cleanup:','📈\x20Cleanup\x20Summary:','Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20','5852248cdnJLj','4671UPaBEQ','__importDefault','497180xpaehf','fresh','Cleanup\x20service\x20error:\x20','\x20\x20\x20Stale\x20(3-5\x20days):\x20','total','18660059oMyxYn','failed','Failed\x20to\x20get\x20processing\x20payments\x20stats:','\x20\x20\x20❌\x20Failed\x20to\x20process:\x20','PROCESSING','PaymentStatus','@prisma/client','auto_timeout','message','payment','🏁\x20Payment\x20cleanup\x20service\x20completed','📅\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','\x20\x20\x20\x20\x20\x20','\x20from\x20PROCESSING\x20to\x20FAILED','2610znZHMV','\x20payments\x20updated\x20to\x20FAILED,\x20','paymentCleanupService','\x20\x20\x20⚠️\x20Errors\x20encountered:','findMany','375dBTMju','byGateway','logWebhookError','Unknown\x20error','logWebhookProcessed','\x20\x20\x20📉\x20Total\x20PROCESSING\x20payments\x20reduced\x20by:\x20','6853XaRxAD','\x20\x20\x20Shop:\x20','error'];a57_0x519d=function(){return _0x5b4f33;};return a57_0x519d();}(function(_0x5a1f8a,_0x256883){const _0xb4a6b2=a57_0x106d,_0x3f3acd=_0x5a1f8a();while(!![]){try{const _0x388b29=parseInt(_0xb4a6b2(0x12c))/0x1*(-parseInt(_0xb4a6b2(0x13d))/0x2)+-parseInt(_0xb4a6b2(0x148))/0x3*(parseInt(_0xb4a6b2(0x114))/0x4)+parseInt(_0xb4a6b2(0x13c))/0x5+-parseInt(_0xb4a6b2(0x10b))/0x6*(-parseInt(_0xb4a6b2(0x132))/0x7)+-parseInt(_0xb4a6b2(0x111))/0x8+-parseInt(_0xb4a6b2(0x112))/0x9*(parseInt(_0xb4a6b2(0x127))/0xa)+parseInt(_0xb4a6b2(0x119))/0xb;if(_0x388b29===_0x256883)break;else _0x3f3acd['push'](_0x3f3acd['shift']());}catch(_0x16bb7f){_0x3f3acd['push'](_0x3f3acd['shift']());}}}(a57_0x519d,0x668aa));var __importDefault=this&&this[a57_0xd5dc4f(0x113)]||function(_0x127914){return _0x127914&&_0x127914['__esModule']?_0x127914:{'default':_0x127914};};Object['defineProperty'](exports,a57_0xd5dc4f(0xfa),{'value':!![]}),exports[a57_0xd5dc4f(0x129)]=exports[a57_0xd5dc4f(0x13e)]=void 0x0;const database_1=__importDefault(require(a57_0xd5dc4f(0x13f))),client_1=require(a57_0xd5dc4f(0x11f)),loggerService_1=require(a57_0xd5dc4f(0x146));class PaymentCleanupService{constructor(){const _0x252793=a57_0xd5dc4f;this[_0x252793(0x139)]=0x5;}async[a57_0xd5dc4f(0xf0)](){const _0x335648=a57_0xd5dc4f,_0x2b98ea=[];let _0x3349b8=0x0,_0x416ea9=0x0;try{console[_0x335648(0xfc)](_0x335648(0x143));const _0x4c2742=new Date();_0x4c2742[_0x335648(0x144)](_0x4c2742[_0x335648(0xec)]()-this[_0x335648(0x139)]),console[_0x335648(0xfc)](_0x335648(0x124)+_0x4c2742[_0x335648(0x135)]());const _0x9b2782=await database_1[_0x335648(0xed)]['payment'][_0x335648(0x12b)]({'where':{'status':client_1[_0x335648(0x11e)][_0x335648(0x11d)],'createdAt':{'lt':_0x4c2742}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x335648(0xfc)](_0x335648(0xf4)+_0x9b2782['length']+_0x335648(0x14a));if(_0x9b2782[_0x335648(0xf6)]===0x0)return console[_0x335648(0xfc)]('✅\x20No\x20stale\x20PROCESSING\x20payments\x20found'),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x1c5e71 of _0x9b2782){try{console[_0x335648(0xfc)]('⏱️\x20Processing\x20stale\x20payment:\x20'+_0x1c5e71['id']+'\x20('+_0x1c5e71[_0x335648(0x100)]+',\x20'+_0x1c5e71[_0x335648(0x145)]+'\x20'+_0x1c5e71[_0x335648(0x13b)]+')'),console[_0x335648(0xfc)](_0x335648(0x133)+_0x1c5e71[_0x335648(0x104)]['name']+'\x20('+_0x1c5e71['shop'][_0x335648(0xfe)]+')'),console[_0x335648(0xfc)]('\x20\x20\x20Created:\x20'+_0x1c5e71[_0x335648(0x106)]['toISOString']()),console[_0x335648(0xfc)](_0x335648(0xfd)+Math[_0x335648(0x102)]((Date['now']()-_0x1c5e71['createdAt']['getTime']())/(0x3e8*0x3c*0x3c*0x18))+_0x335648(0x105));const _0x21b686=await database_1[_0x335648(0xed)][_0x335648(0x122)][_0x335648(0xee)]({'where':{'id':_0x1c5e71['id']},'data':{'status':client_1['PaymentStatus'][_0x335648(0x136)],'statusChangedBy':_0x335648(0x101),'statusChangedAt':new Date(),'adminNotes':'Automatically\x20failed\x20due\x20to\x20being\x20in\x20PROCESSING\x20status\x20for\x20more\x20than\x20'+this[_0x335648(0x139)]+_0x335648(0x105),'failureMessage':_0x335648(0x10c)+this[_0x335648(0x139)]+'\x20days'}});console[_0x335648(0xfc)]('✅\x20Updated\x20payment\x20'+_0x1c5e71['id']+_0x335648(0x126)),loggerService_1[_0x335648(0x140)][_0x335648(0x130)](_0x1c5e71['gateway'],_0x1c5e71['id'],_0x335648(0x11d),_0x335648(0x136),{'reason':_0x335648(0x120),'timeoutDays':this[_0x335648(0x139)]}),_0x3349b8++;}catch(_0x318c6c){const _0x3a3a92=_0x335648(0x109)+_0x1c5e71['id']+':\x20'+(_0x318c6c instanceof Error?_0x318c6c[_0x335648(0x121)]:_0x335648(0x12f));console[_0x335648(0x134)]('❌\x20'+_0x3a3a92),_0x2b98ea['push'](_0x3a3a92),_0x416ea9++;}}const _0x571e29=_0x335648(0x108)+_0x3349b8+_0x335648(0x128)+_0x416ea9+_0x335648(0xff);return console[_0x335648(0xfc)](_0x335648(0xf8)+_0x571e29),loggerService_1[_0x335648(0x140)]['logApiCall'](_0x335648(0x142),_0x335648(0x107),_0x335648(0x101),_0x335648(0x141),{'processed':_0x3349b8,'failed':_0x416ea9,'errors':_0x2b98ea,'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),{'processed':_0x3349b8,'failed':_0x416ea9,'errors':_0x2b98ea};}catch(_0x5ae2df){const _0x15d037=_0x335648(0x116)+(_0x5ae2df instanceof Error?_0x5ae2df[_0x335648(0x121)]:_0x335648(0x12f));return console[_0x335648(0x134)](_0x335648(0x10d)+_0x15d037),_0x2b98ea['push'](_0x15d037),loggerService_1[_0x335648(0x140)][_0x335648(0x12e)](_0x335648(0x142),_0x15d037,{'timeoutDays':this[_0x335648(0x139)]}),{'processed':_0x3349b8,'failed':_0x416ea9,'errors':_0x2b98ea};}}async[a57_0xd5dc4f(0xf5)](){const _0x3af251=a57_0xd5dc4f;try{const _0x163205=new Date(),_0x31264a=new Date(_0x163205['getTime']()-0x1*0x18*0x3c*0x3c*0x3e8),_0x518d87=new Date(_0x163205[_0x3af251(0xf1)]()-0x3*0x18*0x3c*0x3c*0x3e8),_0x27041d=new Date(_0x163205['getTime']()-0x5*0x18*0x3c*0x3c*0x3e8),_0x4b8864=await database_1[_0x3af251(0xed)][_0x3af251(0x122)][_0x3af251(0x12b)]({'where':{'status':client_1[_0x3af251(0x11e)][_0x3af251(0x11d)]},'select':{'id':!![],'gateway':!![],'createdAt':!![]}}),_0x4da7b9={'total':_0x4b8864[_0x3af251(0xf6)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{}};for(const _0x34ecd2 of _0x4b8864){if(_0x34ecd2[_0x3af251(0x106)]>_0x31264a)_0x4da7b9['byAge'][_0x3af251(0x115)]++;else{if(_0x34ecd2[_0x3af251(0x106)]>_0x518d87)_0x4da7b9['byAge']['recent']++;else _0x34ecd2['createdAt']>_0x27041d?_0x4da7b9[_0x3af251(0xf3)][_0x3af251(0x137)]++:_0x4da7b9[_0x3af251(0xf3)][_0x3af251(0x103)]++;}!_0x4da7b9[_0x3af251(0x12d)][_0x34ecd2[_0x3af251(0x100)]]&&(_0x4da7b9['byGateway'][_0x34ecd2['gateway']]=0x0),_0x4da7b9['byGateway'][_0x34ecd2[_0x3af251(0x100)]]++;}return _0x4da7b9;}catch(_0xf11794){console[_0x3af251(0x134)](_0x3af251(0x11b),_0xf11794);throw new Error(_0x3af251(0x110)+(_0xf11794 instanceof Error?_0xf11794[_0x3af251(0x121)]:_0x3af251(0x12f)));}}async[a57_0xd5dc4f(0x138)](){const _0x3a9e4f=a57_0xd5dc4f;console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x147));const _0x2bb4a9=await this[_0x3a9e4f(0xf5)]();console['log'](_0x3a9e4f(0x10e)),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0xfb)+_0x2bb4a9[_0x3a9e4f(0x118)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x13a)+_0x2bb4a9[_0x3a9e4f(0xf3)][_0x3a9e4f(0x115)]),console[_0x3a9e4f(0xfc)]('\x20\x20\x20Recent\x20(1-3\x20days):\x20'+_0x2bb4a9[_0x3a9e4f(0xf3)][_0x3a9e4f(0x149)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x117)+_0x2bb4a9['byAge'][_0x3a9e4f(0x137)]),console[_0x3a9e4f(0xfc)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x2bb4a9[_0x3a9e4f(0xf3)][_0x3a9e4f(0x103)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0xf9),_0x2bb4a9['byGateway']);const _0x2eb48d=await this[_0x3a9e4f(0xf0)](),_0x5c91d0=await this['getProcessingPaymentsStats']();console[_0x3a9e4f(0xfc)](_0x3a9e4f(0xf7)),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0xfb)+_0x5c91d0[_0x3a9e4f(0x118)]),console[_0x3a9e4f(0xfc)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x5c91d0[_0x3a9e4f(0xf3)][_0x3a9e4f(0x103)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x10f)),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x10a)+_0x2eb48d[_0x3a9e4f(0xf2)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x11c)+_0x2eb48d[_0x3a9e4f(0x11a)]),console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x131)+(_0x2bb4a9[_0x3a9e4f(0x118)]-_0x5c91d0[_0x3a9e4f(0x118)])),_0x2eb48d[_0x3a9e4f(0xef)][_0x3a9e4f(0xf6)]>0x0&&(console[_0x3a9e4f(0xfc)](_0x3a9e4f(0x12a)),_0x2eb48d[_0x3a9e4f(0xef)]['forEach']((_0x494dff,_0xcd6c45)=>{const _0x344d29=_0x3a9e4f;console[_0x344d29(0xfc)](_0x344d29(0x125)+(_0xcd6c45+0x1)+'.\x20'+_0x494dff);})),console['log'](_0x3a9e4f(0x123));}}exports[a57_0xd5dc4f(0x13e)]=PaymentCleanupService,exports[a57_0xd5dc4f(0x129)]=new PaymentCleanupService();