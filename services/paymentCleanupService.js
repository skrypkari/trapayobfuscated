'use strict';const a68_0xaf2b1c=a68_0xd488;(function(_0x65f519,_0xcd7e31){const _0x2ba889=a68_0xd488,_0x247234=_0x65f519();while(!![]){try{const _0x831431=-parseInt(_0x2ba889(0x8d))/0x1+parseInt(_0x2ba889(0x8f))/0x2*(-parseInt(_0x2ba889(0xd2))/0x3)+parseInt(_0x2ba889(0xa9))/0x4+-parseInt(_0x2ba889(0x9e))/0x5*(-parseInt(_0x2ba889(0x70))/0x6)+parseInt(_0x2ba889(0x97))/0x7+parseInt(_0x2ba889(0x93))/0x8*(parseInt(_0x2ba889(0x80))/0x9)+-parseInt(_0x2ba889(0xb1))/0xa;if(_0x831431===_0xcd7e31)break;else _0x247234['push'](_0x247234['shift']());}catch(_0x1731ff){_0x247234['push'](_0x247234['shift']());}}}(a68_0x20be,0x7eb27));function a68_0x20be(){const _0x5f1b2c=['byGateway','push','runPendingCleanupOnly','üìä\x20','704020LRNztH','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','processed','PENDING','getDate','errors','\x20\x20\x20‚ö†Ô∏è\x20Errors\x20encountered:','update','Cleanup\x20completed:\x20','üìä\x20PENDING\x20payments\x20after\x20cleanup:\x20','cleanupStaleProcessingPayments','1085720eyrtZV','\x20days','\x20\x20\x20By\x20gateway:','amount','payment_cleanup','stale','shop','../config/database','5053650PpdjvA','\x20from\x20PENDING\x20to\x20EXPIRED','\x20\x20\x20Age:\x20','log','PaymentCleanupService','toISOString','üèÅ\x20PENDING\x20cleanup\x20completed','PaymentStatus','üìä\x20PROCESSING\x20payments\x20before\x20cleanup:\x20','‚è±Ô∏è\x20Processing\x20stale\x20payment:\x20','\x20\x20\x20üìâ\x20Total\x20stale\x20payments\x20reduced\x20by:\x20','logWebhookProcessed','auto_timeout_pending','runCleanupWithReport','POST','auto_timeout','\x0aüìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:','loggerService','PENDING_TIMEOUT_DAYS','username','\x20payments\x20updated\x20to\x20FAILED,\x20','üèÅ\x20PROCESSING\x20cleanup\x20completed','total','üöÄ\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...','__esModule','logWebhookError','expired','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','forEach','üöÄ\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...','default','Failed\x20to\x20update\x20payment\x20','length','17811FPOQqr','./loggerService','logApiCall','floor','system','\x20\x20\x20‚ùå\x20Total\x20failed\x20to\x20process:\x20','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','now','üí•\x20','PENDING\x20cleanup\x20service\x20error:\x20','getProcessingPaymentsStats','gateway','PROCESSING','\x20stale\x20PROCESSING\x20payments','pending_payment_cleanup','Unknown\x20error','PROCESSING_TIMEOUT_DAYS','\x20stale\x20PENDING\x20payments','name','admin','byAge','üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','failed','‚úÖ\x20PROCESSING\x20payments\x20processed:\x20','‚úÖ\x20Updated\x20payment\x20','EXPIRED','üìÖ\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','30gapFaR','üîç\x20Found\x20','recent','FAILED','paymentCleanupService','\x20\x20\x20‚è∞\x20PENDING\x20‚Üí\x20EXPIRED:\x20','\x20\x20\x20Total:\x20','Cleanup\x20service\x20error:\x20','__importDefault','üèÅ\x20Payment\x20cleanup\x20service\x20completed','Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20','üìä\x20PENDING\x20payments\x20before\x20cleanup:\x20','error','\x20failed\x20to\x20update','message','getTime','64161VQZVtI','\x20\x20\x20By\x20status:','createdAt','status','setDate','\x20\x20\x20Created:\x20','üöÄ\x20Starting\x20payment\x20cleanup\x20service...','cleanupStalePendingPayments','\x20\x20\x20Recent\x20(1-3\x20days):\x20','\x0aüîÑ\x20Running\x20PENDING\x20payments\x20cleanup...','‚úÖ\x20No\x20stale\x20PENDING\x20payments\x20found','üìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','\x20\x20\x20Expired\x20(>\x205\x20days):\x20','376152nBScSD','\x20\x20\x20‚úÖ\x20Total\x20successfully\x20processed:\x20','122aRWoRI','findMany','byStatus','\x20\x20\x20Shop:\x20','112yrQVag','currency','payment','‚úÖ\x20No\x20stale\x20PROCESSING\x20payments\x20found','4811583Cphyns','\x0aüîÑ\x20Running\x20PROCESSING\x20payments\x20cleanup...','fresh'];a68_0x20be=function(){return _0x5f1b2c;};return a68_0x20be();}var __importDefault=this&&this[a68_0xaf2b1c(0x78)]||function(_0x2b6237){const _0x519eb3=a68_0xaf2b1c;return _0x2b6237&&_0x2b6237[_0x519eb3(0xc9)]?_0x2b6237:{'default':_0x2b6237};};function a68_0xd488(_0x2c9d84,_0x3ae16b){_0x2c9d84=_0x2c9d84-0x6b;const _0x20be13=a68_0x20be();let _0xd4880c=_0x20be13[_0x2c9d84];return _0xd4880c;}Object['defineProperty'](exports,a68_0xaf2b1c(0xc9),{'value':!![]}),exports[a68_0xaf2b1c(0x74)]=exports[a68_0xaf2b1c(0xb5)]=void 0x0;const database_1=__importDefault(require(a68_0xaf2b1c(0xb0))),client_1=require('@prisma/client'),loggerService_1=require(a68_0xaf2b1c(0xd3));class PaymentCleanupService{constructor(){const _0xb07b5=a68_0xaf2b1c;this[_0xb07b5(0xe2)]=0x5,this[_0xb07b5(0xc3)]=0x5;}async[a68_0xaf2b1c(0xa8)](){const _0x24085b=a68_0xaf2b1c,_0x5adb79=[];let _0x2312e5=0x0,_0x5dbed7=0x0;try{console['log'](_0x24085b(0xe7));const _0x968c67=new Date();_0x968c67['setDate'](_0x968c67['getDate']()-this[_0x24085b(0xe2)]),console['log'](_0x24085b(0x6f)+_0x968c67[_0x24085b(0xb6)]());const _0x26a3f5=await database_1[_0x24085b(0xcf)][_0x24085b(0x95)][_0x24085b(0x90)]({'where':{'status':client_1[_0x24085b(0xb8)][_0x24085b(0xde)],'createdAt':{'lt':_0x968c67}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x24085b(0xb4)]('üîç\x20Found\x20'+_0x26a3f5['length']+_0x24085b(0xdf));if(_0x26a3f5['length']===0x0)return console[_0x24085b(0xb4)](_0x24085b(0x96)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x55d890 of _0x26a3f5){try{console['log'](_0x24085b(0xba)+_0x55d890['id']+'\x20('+_0x55d890[_0x24085b(0xdd)]+',\x20'+_0x55d890[_0x24085b(0xac)]+'\x20'+_0x55d890[_0x24085b(0x94)]+')'),console['log'](_0x24085b(0x92)+_0x55d890[_0x24085b(0xaf)][_0x24085b(0xe4)]+'\x20('+_0x55d890[_0x24085b(0xaf)][_0x24085b(0xc4)]+')'),console[_0x24085b(0xb4)](_0x24085b(0x85)+_0x55d890['createdAt']['toISOString']()),console[_0x24085b(0xb4)](_0x24085b(0xb3)+Math[_0x24085b(0xd5)]((Date[_0x24085b(0xd9)]()-_0x55d890[_0x24085b(0x82)][_0x24085b(0x7f)]())/(0x3e8*0x3c*0x3c*0x18))+_0x24085b(0xaa));const _0x4d5172=await database_1[_0x24085b(0xcf)][_0x24085b(0x95)][_0x24085b(0xa5)]({'where':{'id':_0x55d890['id']},'data':{'status':client_1[_0x24085b(0xb8)][_0x24085b(0x73)],'statusChangedBy':_0x24085b(0xd6),'statusChangedAt':new Date(),'failureMessage':_0x24085b(0xcc)+this[_0x24085b(0xe2)]+_0x24085b(0xaa)}});console[_0x24085b(0xb4)](_0x24085b(0x6d)+_0x55d890['id']+'\x20from\x20PROCESSING\x20to\x20FAILED'),loggerService_1[_0x24085b(0xc2)]['logWebhookProcessed'](_0x55d890[_0x24085b(0xdd)],_0x55d890['id'],_0x24085b(0xde),_0x24085b(0x73),{'reason':_0x24085b(0xc0),'timeoutDays':this[_0x24085b(0xe2)]}),_0x2312e5++;}catch(_0x1de4b2){const _0x2671c8=_0x24085b(0xd0)+_0x55d890['id']+':\x20'+(_0x1de4b2 instanceof Error?_0x1de4b2[_0x24085b(0x7e)]:'Unknown\x20error');console[_0x24085b(0x7c)]('‚ùå\x20'+_0x2671c8),_0x5adb79[_0x24085b(0x9b)](_0x2671c8),_0x5dbed7++;}}const _0x467383=_0x24085b(0xa6)+_0x2312e5+_0x24085b(0xc5)+_0x5dbed7+'\x20failed\x20to\x20update';return console[_0x24085b(0xb4)](_0x24085b(0x9d)+_0x467383),loggerService_1[_0x24085b(0xc2)][_0x24085b(0xd4)]('payment_cleanup',_0x24085b(0xbf),_0x24085b(0xd6),_0x24085b(0xe5),{'processed':_0x2312e5,'failed':_0x5dbed7,'errors':_0x5adb79,'timeoutDays':this[_0x24085b(0xe2)]}),{'processed':_0x2312e5,'failed':_0x5dbed7,'errors':_0x5adb79};}catch(_0x538fa9){const _0x4f348e=_0x24085b(0x77)+(_0x538fa9 instanceof Error?_0x538fa9[_0x24085b(0x7e)]:'Unknown\x20error');return console[_0x24085b(0x7c)](_0x24085b(0xda)+_0x4f348e),_0x5adb79['push'](_0x4f348e),loggerService_1[_0x24085b(0xc2)][_0x24085b(0xca)](_0x24085b(0xad),_0x4f348e,{'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),{'processed':_0x2312e5,'failed':_0x5dbed7,'errors':_0x5adb79};}}async['cleanupStalePendingPayments'](){const _0x26e22f=a68_0xaf2b1c,_0x2658fe=[];let _0x17326e=0x0,_0x168890=0x0;try{console['log']('üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...');const _0x3a3a29=new Date();_0x3a3a29[_0x26e22f(0x84)](_0x3a3a29[_0x26e22f(0xa2)]()-this[_0x26e22f(0xc3)]),console[_0x26e22f(0xb4)]('üìÖ\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20'+_0x3a3a29[_0x26e22f(0xb6)]());const _0x5235d9=await database_1['default'][_0x26e22f(0x95)][_0x26e22f(0x90)]({'where':{'status':client_1[_0x26e22f(0xb8)][_0x26e22f(0xa1)],'createdAt':{'lt':_0x3a3a29}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log'](_0x26e22f(0x71)+_0x5235d9[_0x26e22f(0xd1)]+_0x26e22f(0xe3));if(_0x5235d9[_0x26e22f(0xd1)]===0x0)return console[_0x26e22f(0xb4)](_0x26e22f(0x8a)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x5d02a2 of _0x5235d9){try{console[_0x26e22f(0xb4)]('‚è∞\x20Processing\x20stale\x20PENDING\x20payment:\x20'+_0x5d02a2['id']+'\x20('+_0x5d02a2[_0x26e22f(0xdd)]+',\x20'+_0x5d02a2['amount']+'\x20'+_0x5d02a2[_0x26e22f(0x94)]+')'),console[_0x26e22f(0xb4)](_0x26e22f(0x92)+_0x5d02a2['shop']['name']+'\x20('+_0x5d02a2[_0x26e22f(0xaf)]['username']+')'),console[_0x26e22f(0xb4)](_0x26e22f(0x85)+_0x5d02a2['createdAt'][_0x26e22f(0xb6)]()),console[_0x26e22f(0xb4)](_0x26e22f(0xb3)+Math[_0x26e22f(0xd5)]((Date['now']()-_0x5d02a2[_0x26e22f(0x82)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))+_0x26e22f(0xaa));const _0x5b9db7=await database_1[_0x26e22f(0xcf)][_0x26e22f(0x95)][_0x26e22f(0xa5)]({'where':{'id':_0x5d02a2['id']},'data':{'status':client_1['PaymentStatus'][_0x26e22f(0x6e)],'statusChangedBy':_0x26e22f(0xd6),'statusChangedAt':new Date(),'failureMessage':_0x26e22f(0x9f)+this[_0x26e22f(0xc3)]+_0x26e22f(0xaa)}});console[_0x26e22f(0xb4)]('‚úÖ\x20Updated\x20payment\x20'+_0x5d02a2['id']+_0x26e22f(0xb2)),loggerService_1[_0x26e22f(0xc2)][_0x26e22f(0xbc)](_0x5d02a2[_0x26e22f(0xdd)],_0x5d02a2['id'],_0x26e22f(0xa1),_0x26e22f(0x6e),{'reason':_0x26e22f(0xbd),'timeoutDays':this[_0x26e22f(0xc3)]}),_0x17326e++;}catch(_0x57461d){const _0xee2059='Failed\x20to\x20update\x20PENDING\x20payment\x20'+_0x5d02a2['id']+':\x20'+(_0x57461d instanceof Error?_0x57461d[_0x26e22f(0x7e)]:'Unknown\x20error');console['error']('‚ùå\x20'+_0xee2059),_0x2658fe[_0x26e22f(0x9b)](_0xee2059),_0x168890++;}}const _0x2767ed='PENDING\x20cleanup\x20completed:\x20'+_0x17326e+'\x20payments\x20updated\x20to\x20EXPIRED,\x20'+_0x168890+_0x26e22f(0x7d);return console[_0x26e22f(0xb4)](_0x26e22f(0x9d)+_0x2767ed),loggerService_1['loggerService']['logApiCall'](_0x26e22f(0xe0),'POST',_0x26e22f(0xd6),_0x26e22f(0xe5),{'processed':_0x17326e,'failed':_0x168890,'errors':_0x2658fe,'timeoutDays':this[_0x26e22f(0xc3)]}),{'processed':_0x17326e,'failed':_0x168890,'errors':_0x2658fe};}catch(_0x324992){const _0x58bb16=_0x26e22f(0xdb)+(_0x324992 instanceof Error?_0x324992[_0x26e22f(0x7e)]:_0x26e22f(0xe1));return console[_0x26e22f(0x7c)](_0x26e22f(0xda)+_0x58bb16),_0x2658fe['push'](_0x58bb16),loggerService_1['loggerService'][_0x26e22f(0xca)](_0x26e22f(0xe0),_0x58bb16,{'timeoutDays':this[_0x26e22f(0xc3)]}),{'processed':_0x17326e,'failed':_0x168890,'errors':_0x2658fe};}}async[a68_0xaf2b1c(0xdc)](){const _0x51e696=a68_0xaf2b1c;try{const _0x5c2fb3=new Date(),_0x51ef7b=new Date(_0x5c2fb3[_0x51e696(0x7f)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x57800f=new Date(_0x5c2fb3['getTime']()-0x3*0x18*0x3c*0x3c*0x3e8),_0x3dd256=new Date(_0x5c2fb3[_0x51e696(0x7f)]()-0x5*0x18*0x3c*0x3c*0x3e8),_0xbac047=await database_1[_0x51e696(0xcf)][_0x51e696(0x95)]['findMany']({'where':{'status':{'in':[client_1['PaymentStatus']['PROCESSING'],client_1[_0x51e696(0xb8)][_0x51e696(0xa1)]]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x56746f={'total':_0xbac047[_0x51e696(0xd1)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0x4710ce of _0xbac047){if(_0x4710ce[_0x51e696(0x82)]>_0x51ef7b)_0x56746f[_0x51e696(0xe6)][_0x51e696(0x99)]++;else{if(_0x4710ce[_0x51e696(0x82)]>_0x57800f)_0x56746f[_0x51e696(0xe6)]['recent']++;else _0x4710ce[_0x51e696(0x82)]>_0x3dd256?_0x56746f[_0x51e696(0xe6)][_0x51e696(0xae)]++:_0x56746f['byAge'][_0x51e696(0xcb)]++;}!_0x56746f['byGateway'][_0x4710ce[_0x51e696(0xdd)]]&&(_0x56746f['byGateway'][_0x4710ce['gateway']]=0x0);_0x56746f['byGateway'][_0x4710ce[_0x51e696(0xdd)]]++;const _0x3c847e=_0x4710ce[_0x51e696(0x83)];!_0x56746f[_0x51e696(0x91)][_0x3c847e]&&(_0x56746f['byStatus'][_0x3c847e]=0x0),_0x56746f['byStatus'][_0x3c847e]++;}return _0x56746f;}catch(_0x509a55){console['error']('Failed\x20to\x20get\x20processing\x20payments\x20stats:',_0x509a55);throw new Error(_0x51e696(0x7a)+(_0x509a55 instanceof Error?_0x509a55[_0x51e696(0x7e)]:'Unknown\x20error'));}}async[a68_0xaf2b1c(0xbe)](){const _0x180962=a68_0xaf2b1c;console[_0x180962(0xb4)](_0x180962(0x86));const _0x33171f=await this['getProcessingPaymentsStats']();console[_0x180962(0xb4)](_0x180962(0x8b)),console[_0x180962(0xb4)](_0x180962(0x76)+_0x33171f[_0x180962(0xc7)]),console[_0x180962(0xb4)](_0x180962(0xd8)+_0x33171f[_0x180962(0xe6)][_0x180962(0x99)]),console[_0x180962(0xb4)](_0x180962(0x88)+_0x33171f['byAge'][_0x180962(0x72)]),console[_0x180962(0xb4)]('\x20\x20\x20Stale\x20(3-5\x20days):\x20'+_0x33171f[_0x180962(0xe6)][_0x180962(0xae)]),console[_0x180962(0xb4)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x33171f[_0x180962(0xe6)][_0x180962(0xcb)]),console[_0x180962(0xb4)](_0x180962(0xab),_0x33171f[_0x180962(0x9a)]),console[_0x180962(0xb4)]('\x20\x20\x20By\x20status:',_0x33171f[_0x180962(0x91)]),console['log'](_0x180962(0x98));const _0x5d4c42=await this[_0x180962(0xa8)]();console[_0x180962(0xb4)](_0x180962(0x89));const _0x43a0d1=await this[_0x180962(0x87)](),_0x2b94c0=await this[_0x180962(0xdc)]();console[_0x180962(0xb4)](_0x180962(0xc1)),console[_0x180962(0xb4)]('\x20\x20\x20Total:\x20'+_0x2b94c0[_0x180962(0xc7)]),console[_0x180962(0xb4)](_0x180962(0x8c)+_0x2b94c0[_0x180962(0xe6)][_0x180962(0xcb)]),console[_0x180962(0xb4)](_0x180962(0x81),_0x2b94c0[_0x180962(0x91)]);const _0x213d6a=_0x5d4c42[_0x180962(0xa0)]+_0x43a0d1['processed'],_0x3cc284=_0x5d4c42['failed']+_0x43a0d1[_0x180962(0x6b)],_0x66b929=[..._0x5d4c42[_0x180962(0xa3)],..._0x43a0d1['errors']];console['log']('\x0aüìà\x20Cleanup\x20Summary:'),console[_0x180962(0xb4)]('\x20\x20\x20üîÑ\x20PROCESSING\x20‚Üí\x20FAILED:\x20'+_0x5d4c42[_0x180962(0xa0)]),console[_0x180962(0xb4)](_0x180962(0x75)+_0x43a0d1['processed']),console[_0x180962(0xb4)](_0x180962(0x8e)+_0x213d6a),console['log'](_0x180962(0xd7)+_0x3cc284),console[_0x180962(0xb4)](_0x180962(0xbb)+(_0x33171f[_0x180962(0xc7)]-_0x2b94c0[_0x180962(0xc7)])),_0x66b929[_0x180962(0xd1)]>0x0&&(console[_0x180962(0xb4)](_0x180962(0xa4)),_0x66b929[_0x180962(0xcd)]((_0x41ad24,_0x297617)=>{const _0x303d4e=_0x180962;console[_0x303d4e(0xb4)]('\x20\x20\x20\x20\x20\x20'+(_0x297617+0x1)+'.\x20'+_0x41ad24);})),console['log'](_0x180962(0x79));}async['runProcessingCleanupOnly'](){const _0x38f6b4=a68_0xaf2b1c;console[_0x38f6b4(0xb4)](_0x38f6b4(0xce));const _0x47f16c=await this[_0x38f6b4(0xdc)](),_0x544411=_0x47f16c[_0x38f6b4(0x91)]['PROCESSING']||0x0;console[_0x38f6b4(0xb4)](_0x38f6b4(0xb9)+_0x544411);const _0x407de7=await this[_0x38f6b4(0xa8)](),_0x14fb96=await this['getProcessingPaymentsStats'](),_0x24a32d=_0x14fb96[_0x38f6b4(0x91)]['PROCESSING']||0x0;console[_0x38f6b4(0xb4)]('üìä\x20PROCESSING\x20payments\x20after\x20cleanup:\x20'+_0x24a32d),console[_0x38f6b4(0xb4)](_0x38f6b4(0x6c)+_0x407de7[_0x38f6b4(0xa0)]),console[_0x38f6b4(0xb4)](_0x38f6b4(0xc6));}async[a68_0xaf2b1c(0x9c)](){const _0x5bece3=a68_0xaf2b1c;console['log'](_0x5bece3(0xc8));const _0x4768b2=await this[_0x5bece3(0xdc)](),_0x23fecd=_0x4768b2[_0x5bece3(0x91)][_0x5bece3(0xa1)]||0x0;console[_0x5bece3(0xb4)](_0x5bece3(0x7b)+_0x23fecd);const _0x2a5d8f=await this[_0x5bece3(0x87)](),_0x17c4d9=await this[_0x5bece3(0xdc)](),_0x3d3c9d=_0x17c4d9[_0x5bece3(0x91)][_0x5bece3(0xa1)]||0x0;console['log'](_0x5bece3(0xa7)+_0x3d3c9d),console[_0x5bece3(0xb4)]('‚úÖ\x20PENDING\x20payments\x20processed:\x20'+_0x2a5d8f['processed']),console[_0x5bece3(0xb4)](_0x5bece3(0xb7));}}exports[a68_0xaf2b1c(0xb5)]=PaymentCleanupService,exports[a68_0xaf2b1c(0x74)]=new PaymentCleanupService();