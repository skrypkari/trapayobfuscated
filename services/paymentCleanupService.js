'use strict';const a60_0x1d7037=a60_0x5d27;function a60_0x5d27(_0x1d0ebc,_0xc50f48){const _0x52bec4=a60_0x52be();return a60_0x5d27=function(_0x5d27d1,_0x2d493b){_0x5d27d1=_0x5d27d1-0xbd;let _0x1400f1=_0x52bec4[_0x5d27d1];return _0x1400f1;},a60_0x5d27(_0x1d0ebc,_0xc50f48);}(function(_0x4b9328,_0x1694fe){const _0x1ad80b=a60_0x5d27,_0x1bbf76=_0x4b9328();while(!![]){try{const _0x38ec92=-parseInt(_0x1ad80b(0x114))/0x1+parseInt(_0x1ad80b(0x12d))/0x2*(-parseInt(_0x1ad80b(0xdc))/0x3)+-parseInt(_0x1ad80b(0x121))/0x4+parseInt(_0x1ad80b(0xf0))/0x5+-parseInt(_0x1ad80b(0xe0))/0x6+-parseInt(_0x1ad80b(0xe3))/0x7*(-parseInt(_0x1ad80b(0xfc))/0x8)+parseInt(_0x1ad80b(0x11a))/0x9*(parseInt(_0x1ad80b(0xbe))/0xa);if(_0x38ec92===_0x1694fe)break;else _0x1bbf76['push'](_0x1bbf76['shift']());}catch(_0x1cbd76){_0x1bbf76['push'](_0x1bbf76['shift']());}}}(a60_0x52be,0x9995c));var __importDefault=this&&this['__importDefault']||function(_0x2b1678){const _0xa0ba48=a60_0x5d27;return _0x2b1678&&_0x2b1678[_0xa0ba48(0xcc)]?_0x2b1678:{'default':_0x2b1678};};function a60_0x52be(){const _0x42136a=['⏱️\x20Processing\x20stale\x20payment:\x20','shop','🧹\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','error','📊\x20','amount','\x20\x20\x20Shop:\x20','paymentCleanupService','Automatically\x20failed\x20due\x20to\x20being\x20in\x20PROCESSING\x20status\x20for\x20more\x20than\x20','\x20\x20\x20🔄\x20PROCESSING\x20→\x20FAILED:\x20','\x20\x20\x20Age:\x20','📊\x20PROCESSING\x20payments\x20before\x20cleanup:\x20','\x20\x20\x20⚠️\x20Errors\x20encountered:','total','\x20payments\x20updated\x20to\x20EXPIRED,\x20','\x20payments\x20updated\x20to\x20FAILED,\x20','\x20\x20\x20✅\x20Total\x20successfully\x20processed:\x20','\x20\x20\x20Created:\x20','logWebhookProcessed','expired','logWebhookError','386075cXuLca','pending_payment_cleanup','now','📊\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','💥\x20','./loggerService','81OZPKvi','✅\x20No\x20stale\x20PENDING\x20payments\x20found','📊\x20PENDING\x20payments\x20before\x20cleanup:\x20','\x20stale\x20PENDING\x20payments','🧹\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...','runProcessingCleanupOnly','📊\x20PROCESSING\x20payments\x20after\x20cleanup:\x20','3857108zkOdXr','\x20\x20\x20Total:\x20','findMany','defineProperty','status','EXPIRED','log','default','\x20\x20\x20By\x20gateway:','loggerService','\x20stale\x20PROCESSING\x20payments','\x20\x20\x20By\x20status:','402266hLisxQ','payment','currency','../config/database','message','cleanupStaleProcessingPayments','failed','length','createdAt','1825670HIEvpW','🏁\x20PROCESSING\x20cleanup\x20completed','forEach','PENDING\x20cleanup\x20service\x20error:\x20','floor','Unknown\x20error','getDate','admin','processed','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','logApiCall','push','PROCESSING','\x20\x20\x20Expired\x20(>\x205\x20days):\x20','__esModule','PROCESSING_TIMEOUT_DAYS','PaymentCleanupService','\x20days','🚀\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...','POST','PaymentStatus','stale','username','🔍\x20Found\x20','\x0a🔄\x20Running\x20PROCESSING\x20payments\x20cleanup...','gateway','Failed\x20to\x20update\x20PENDING\x20payment\x20','auto_timeout_pending','runPendingCleanupOnly','errors','6XGoPjX','byGateway','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','recent','2062200xHsBlf','PENDING','system','949963PEOBoV','byAge','toISOString','byStatus','PENDING\x20cleanup\x20completed:\x20','setDate','\x20failed\x20to\x20update','PENDING_TIMEOUT_DAYS','name','📅\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20','🏁\x20PENDING\x20cleanup\x20completed','Automatically\x20expired\x20due\x20to\x20being\x20in\x20PENDING\x20status\x20for\x20more\x20than\x20','fresh','4732950rkuhHx','🚀\x20Starting\x20payment\x20cleanup\x20service...','📅\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','getProcessingPaymentsStats','cleanupStalePendingPayments','\x20\x20\x20\x20\x20\x20','✅\x20No\x20stale\x20PROCESSING\x20payments\x20found','update','\x20\x20\x20Recent\x20(1-3\x20days):\x20','getTime','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','payment_cleanup','8ToTXqW','✅\x20Updated\x20payment\x20','\x20\x20\x20⏰\x20PENDING\x20→\x20EXPIRED:\x20'];a60_0x52be=function(){return _0x42136a;};return a60_0x52be();}Object[a60_0x1d7037(0x124)](exports,a60_0x1d7037(0xcc),{'value':!![]}),exports[a60_0x1d7037(0x106)]=exports[a60_0x1d7037(0xce)]=void 0x0;const database_1=__importDefault(require(a60_0x1d7037(0x130))),client_1=require('@prisma/client'),loggerService_1=require(a60_0x1d7037(0x119));class PaymentCleanupService{constructor(){const _0x3f930c=a60_0x1d7037;this[_0x3f930c(0xcd)]=0x5,this[_0x3f930c(0xea)]=0x5;}async[a60_0x1d7037(0x132)](){const _0x185055=a60_0x1d7037,_0x4b41f4=[];let _0x324bf5=0x0,_0x148d5c=0x0;try{console['log'](_0x185055(0x101));const _0x54efb4=new Date();_0x54efb4['setDate'](_0x54efb4[_0x185055(0xc4)]()-this[_0x185055(0xcd)]),console[_0x185055(0x127)](_0x185055(0xf2)+_0x54efb4['toISOString']());const _0x529d1a=await database_1[_0x185055(0x128)][_0x185055(0x12e)][_0x185055(0x123)]({'where':{'status':client_1[_0x185055(0xd2)][_0x185055(0xca)],'createdAt':{'lt':_0x54efb4}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log'](_0x185055(0xd5)+_0x529d1a['length']+_0x185055(0x12b));if(_0x529d1a[_0x185055(0x134)]===0x0)return console[_0x185055(0x127)](_0x185055(0xf6)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x4a5167 of _0x529d1a){try{console[_0x185055(0x127)](_0x185055(0xff)+_0x4a5167['id']+'\x20('+_0x4a5167[_0x185055(0xd7)]+',\x20'+_0x4a5167['amount']+'\x20'+_0x4a5167[_0x185055(0x12f)]+')'),console[_0x185055(0x127)](_0x185055(0x105)+_0x4a5167[_0x185055(0x100)][_0x185055(0xeb)]+'\x20('+_0x4a5167[_0x185055(0x100)][_0x185055(0xd4)]+')'),console[_0x185055(0x127)]('\x20\x20\x20Created:\x20'+_0x4a5167[_0x185055(0xbd)][_0x185055(0xe5)]()),console[_0x185055(0x127)](_0x185055(0x109)+Math[_0x185055(0xc2)]((Date[_0x185055(0x116)]()-_0x4a5167[_0x185055(0xbd)][_0x185055(0xf9)]())/(0x3e8*0x3c*0x3c*0x18))+'\x20days');const _0x258efd=await database_1[_0x185055(0x128)][_0x185055(0x12e)][_0x185055(0xf7)]({'where':{'id':_0x4a5167['id']},'data':{'status':client_1[_0x185055(0xd2)]['FAILED'],'statusChangedBy':'system','statusChangedAt':new Date(),'adminNotes':_0x185055(0x107)+this[_0x185055(0xcd)]+_0x185055(0xcf),'failureMessage':_0x185055(0xc7)+this[_0x185055(0xcd)]+_0x185055(0xcf)}});console[_0x185055(0x127)](_0x185055(0xfd)+_0x4a5167['id']+'\x20from\x20PROCESSING\x20to\x20FAILED'),loggerService_1[_0x185055(0x12a)][_0x185055(0x111)](_0x4a5167['gateway'],_0x4a5167['id'],_0x185055(0xca),'FAILED',{'reason':'auto_timeout','timeoutDays':this[_0x185055(0xcd)]}),_0x324bf5++;}catch(_0x35615f){const _0x1e4fe9='Failed\x20to\x20update\x20payment\x20'+_0x4a5167['id']+':\x20'+(_0x35615f instanceof Error?_0x35615f[_0x185055(0x131)]:'Unknown\x20error');console[_0x185055(0x102)]('❌\x20'+_0x1e4fe9),_0x4b41f4[_0x185055(0xc9)](_0x1e4fe9),_0x148d5c++;}}const _0x2fed39='Cleanup\x20completed:\x20'+_0x324bf5+_0x185055(0x10e)+_0x148d5c+'\x20failed\x20to\x20update';return console['log'](_0x185055(0x103)+_0x2fed39),loggerService_1[_0x185055(0x12a)][_0x185055(0xc8)](_0x185055(0xfb),_0x185055(0xd1),_0x185055(0xe2),_0x185055(0xc5),{'processed':_0x324bf5,'failed':_0x148d5c,'errors':_0x4b41f4,'timeoutDays':this[_0x185055(0xcd)]}),{'processed':_0x324bf5,'failed':_0x148d5c,'errors':_0x4b41f4};}catch(_0xc8c03b){const _0x167a3e='Cleanup\x20service\x20error:\x20'+(_0xc8c03b instanceof Error?_0xc8c03b[_0x185055(0x131)]:_0x185055(0xc3));return console[_0x185055(0x102)]('💥\x20'+_0x167a3e),_0x4b41f4['push'](_0x167a3e),loggerService_1[_0x185055(0x12a)][_0x185055(0x113)](_0x185055(0xfb),_0x167a3e,{'timeoutDays':this[_0x185055(0xcd)]}),{'processed':_0x324bf5,'failed':_0x148d5c,'errors':_0x4b41f4};}}async[a60_0x1d7037(0xf4)](){const _0x47045d=a60_0x1d7037,_0x3ff5b8=[];let _0x59de4d=0x0,_0x231216=0x0;try{console[_0x47045d(0x127)](_0x47045d(0x11e));const _0x6fe0e9=new Date();_0x6fe0e9[_0x47045d(0xe8)](_0x6fe0e9[_0x47045d(0xc4)]()-this[_0x47045d(0xea)]),console[_0x47045d(0x127)](_0x47045d(0xec)+_0x6fe0e9['toISOString']());const _0x18ced3=await database_1[_0x47045d(0x128)][_0x47045d(0x12e)][_0x47045d(0x123)]({'where':{'status':client_1['PaymentStatus'][_0x47045d(0xe1)],'createdAt':{'lt':_0x6fe0e9}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log'](_0x47045d(0xd5)+_0x18ced3[_0x47045d(0x134)]+_0x47045d(0x11d));if(_0x18ced3[_0x47045d(0x134)]===0x0)return console['log'](_0x47045d(0x11b)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x426058 of _0x18ced3){try{console[_0x47045d(0x127)]('⏰\x20Processing\x20stale\x20PENDING\x20payment:\x20'+_0x426058['id']+'\x20('+_0x426058[_0x47045d(0xd7)]+',\x20'+_0x426058[_0x47045d(0x104)]+'\x20'+_0x426058[_0x47045d(0x12f)]+')'),console[_0x47045d(0x127)](_0x47045d(0x105)+_0x426058[_0x47045d(0x100)][_0x47045d(0xeb)]+'\x20('+_0x426058[_0x47045d(0x100)][_0x47045d(0xd4)]+')'),console['log'](_0x47045d(0x110)+_0x426058[_0x47045d(0xbd)][_0x47045d(0xe5)]()),console[_0x47045d(0x127)](_0x47045d(0x109)+Math['floor']((Date[_0x47045d(0x116)]()-_0x426058[_0x47045d(0xbd)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))+'\x20days');const _0x3455a4=await database_1[_0x47045d(0x128)][_0x47045d(0x12e)][_0x47045d(0xf7)]({'where':{'id':_0x426058['id']},'data':{'status':client_1['PaymentStatus'][_0x47045d(0x126)],'statusChangedBy':_0x47045d(0xe2),'statusChangedAt':new Date(),'adminNotes':_0x47045d(0xee)+this[_0x47045d(0xea)]+_0x47045d(0xcf),'failureMessage':_0x47045d(0xde)+this[_0x47045d(0xea)]+_0x47045d(0xcf)}});console[_0x47045d(0x127)](_0x47045d(0xfd)+_0x426058['id']+'\x20from\x20PENDING\x20to\x20EXPIRED'),loggerService_1['loggerService'][_0x47045d(0x111)](_0x426058[_0x47045d(0xd7)],_0x426058['id'],'PENDING',_0x47045d(0x126),{'reason':_0x47045d(0xd9),'timeoutDays':this[_0x47045d(0xea)]}),_0x59de4d++;}catch(_0x4987a4){const _0x51ac00=_0x47045d(0xd8)+_0x426058['id']+':\x20'+(_0x4987a4 instanceof Error?_0x4987a4[_0x47045d(0x131)]:'Unknown\x20error');console[_0x47045d(0x102)]('❌\x20'+_0x51ac00),_0x3ff5b8[_0x47045d(0xc9)](_0x51ac00),_0x231216++;}}const _0x5b3952=_0x47045d(0xe7)+_0x59de4d+_0x47045d(0x10d)+_0x231216+_0x47045d(0xe9);return console[_0x47045d(0x127)]('📊\x20'+_0x5b3952),loggerService_1[_0x47045d(0x12a)]['logApiCall'](_0x47045d(0x115),_0x47045d(0xd1),_0x47045d(0xe2),_0x47045d(0xc5),{'processed':_0x59de4d,'failed':_0x231216,'errors':_0x3ff5b8,'timeoutDays':this[_0x47045d(0xea)]}),{'processed':_0x59de4d,'failed':_0x231216,'errors':_0x3ff5b8};}catch(_0x53bcd9){const _0x5674d4=_0x47045d(0xc1)+(_0x53bcd9 instanceof Error?_0x53bcd9[_0x47045d(0x131)]:_0x47045d(0xc3));return console[_0x47045d(0x102)](_0x47045d(0x118)+_0x5674d4),_0x3ff5b8[_0x47045d(0xc9)](_0x5674d4),loggerService_1[_0x47045d(0x12a)][_0x47045d(0x113)](_0x47045d(0x115),_0x5674d4,{'timeoutDays':this[_0x47045d(0xea)]}),{'processed':_0x59de4d,'failed':_0x231216,'errors':_0x3ff5b8};}}async[a60_0x1d7037(0xf3)](){const _0x2486e6=a60_0x1d7037;try{const _0x5486d6=new Date(),_0xa909a0=new Date(_0x5486d6[_0x2486e6(0xf9)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x12e431=new Date(_0x5486d6[_0x2486e6(0xf9)]()-0x3*0x18*0x3c*0x3c*0x3e8),_0x3bc898=new Date(_0x5486d6[_0x2486e6(0xf9)]()-0x5*0x18*0x3c*0x3c*0x3e8),_0x87fb6f=await database_1[_0x2486e6(0x128)][_0x2486e6(0x12e)][_0x2486e6(0x123)]({'where':{'status':{'in':[client_1[_0x2486e6(0xd2)][_0x2486e6(0xca)],client_1[_0x2486e6(0xd2)][_0x2486e6(0xe1)]]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x2f1356={'total':_0x87fb6f['length'],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0x219223 of _0x87fb6f){if(_0x219223[_0x2486e6(0xbd)]>_0xa909a0)_0x2f1356[_0x2486e6(0xe4)][_0x2486e6(0xef)]++;else{if(_0x219223[_0x2486e6(0xbd)]>_0x12e431)_0x2f1356[_0x2486e6(0xe4)][_0x2486e6(0xdf)]++;else _0x219223[_0x2486e6(0xbd)]>_0x3bc898?_0x2f1356[_0x2486e6(0xe4)]['stale']++:_0x2f1356[_0x2486e6(0xe4)][_0x2486e6(0x112)]++;}!_0x2f1356[_0x2486e6(0xdd)][_0x219223[_0x2486e6(0xd7)]]&&(_0x2f1356[_0x2486e6(0xdd)][_0x219223[_0x2486e6(0xd7)]]=0x0);_0x2f1356['byGateway'][_0x219223[_0x2486e6(0xd7)]]++;const _0x3b210d=_0x219223[_0x2486e6(0x125)];!_0x2f1356[_0x2486e6(0xe6)][_0x3b210d]&&(_0x2f1356[_0x2486e6(0xe6)][_0x3b210d]=0x0),_0x2f1356[_0x2486e6(0xe6)][_0x3b210d]++;}return _0x2f1356;}catch(_0x5cdeec){console[_0x2486e6(0x102)]('Failed\x20to\x20get\x20processing\x20payments\x20stats:',_0x5cdeec);throw new Error('Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20'+(_0x5cdeec instanceof Error?_0x5cdeec['message']:'Unknown\x20error'));}}async['runCleanupWithReport'](){const _0x40c987=a60_0x1d7037;console[_0x40c987(0x127)](_0x40c987(0xf1));const _0x20df14=await this[_0x40c987(0xf3)]();console['log'](_0x40c987(0x117)),console[_0x40c987(0x127)](_0x40c987(0x122)+_0x20df14['total']),console['log'](_0x40c987(0xfa)+_0x20df14[_0x40c987(0xe4)][_0x40c987(0xef)]),console[_0x40c987(0x127)](_0x40c987(0xf8)+_0x20df14['byAge'][_0x40c987(0xdf)]),console[_0x40c987(0x127)]('\x20\x20\x20Stale\x20(3-5\x20days):\x20'+_0x20df14['byAge'][_0x40c987(0xd3)]),console[_0x40c987(0x127)](_0x40c987(0xcb)+_0x20df14[_0x40c987(0xe4)]['expired']),console['log'](_0x40c987(0x129),_0x20df14[_0x40c987(0xdd)]),console[_0x40c987(0x127)](_0x40c987(0x12c),_0x20df14['byStatus']),console[_0x40c987(0x127)](_0x40c987(0xd6));const _0x1e2df5=await this[_0x40c987(0x132)]();console[_0x40c987(0x127)]('\x0a🔄\x20Running\x20PENDING\x20payments\x20cleanup...');const _0x378b2e=await this[_0x40c987(0xf4)](),_0x8671b2=await this[_0x40c987(0xf3)]();console[_0x40c987(0x127)]('\x0a📊\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:'),console['log'](_0x40c987(0x122)+_0x8671b2['total']),console[_0x40c987(0x127)](_0x40c987(0xcb)+_0x8671b2[_0x40c987(0xe4)][_0x40c987(0x112)]),console[_0x40c987(0x127)](_0x40c987(0x12c),_0x8671b2[_0x40c987(0xe6)]);const _0x491701=_0x1e2df5[_0x40c987(0xc6)]+_0x378b2e[_0x40c987(0xc6)],_0xce3455=_0x1e2df5['failed']+_0x378b2e[_0x40c987(0x133)],_0x425991=[..._0x1e2df5[_0x40c987(0xdb)],..._0x378b2e['errors']];console[_0x40c987(0x127)]('\x0a📈\x20Cleanup\x20Summary:'),console[_0x40c987(0x127)](_0x40c987(0x108)+_0x1e2df5['processed']),console[_0x40c987(0x127)](_0x40c987(0xfe)+_0x378b2e[_0x40c987(0xc6)]),console['log'](_0x40c987(0x10f)+_0x491701),console[_0x40c987(0x127)]('\x20\x20\x20❌\x20Total\x20failed\x20to\x20process:\x20'+_0xce3455),console[_0x40c987(0x127)]('\x20\x20\x20📉\x20Total\x20stale\x20payments\x20reduced\x20by:\x20'+(_0x20df14[_0x40c987(0x10c)]-_0x8671b2['total'])),_0x425991[_0x40c987(0x134)]>0x0&&(console[_0x40c987(0x127)](_0x40c987(0x10b)),_0x425991[_0x40c987(0xc0)]((_0x305006,_0x1e6f7c)=>{const _0x182103=_0x40c987;console['log'](_0x182103(0xf5)+(_0x1e6f7c+0x1)+'.\x20'+_0x305006);})),console['log']('🏁\x20Payment\x20cleanup\x20service\x20completed');}async[a60_0x1d7037(0x11f)](){const _0x46e401=a60_0x1d7037;console[_0x46e401(0x127)]('🚀\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...');const _0x28e896=await this[_0x46e401(0xf3)](),_0x3e6fe7=_0x28e896['byStatus'][_0x46e401(0xca)]||0x0;console[_0x46e401(0x127)](_0x46e401(0x10a)+_0x3e6fe7);const _0x3a1fdf=await this['cleanupStaleProcessingPayments'](),_0x2cbdea=await this['getProcessingPaymentsStats'](),_0x2909cb=_0x2cbdea[_0x46e401(0xe6)][_0x46e401(0xca)]||0x0;console[_0x46e401(0x127)](_0x46e401(0x120)+_0x2909cb),console[_0x46e401(0x127)]('✅\x20PROCESSING\x20payments\x20processed:\x20'+_0x3a1fdf[_0x46e401(0xc6)]),console[_0x46e401(0x127)](_0x46e401(0xbf));}async[a60_0x1d7037(0xda)](){const _0x99ed98=a60_0x1d7037;console[_0x99ed98(0x127)](_0x99ed98(0xd0));const _0x35e686=await this['getProcessingPaymentsStats'](),_0x2e58b4=_0x35e686[_0x99ed98(0xe6)][_0x99ed98(0xe1)]||0x0;console['log'](_0x99ed98(0x11c)+_0x2e58b4);const _0x29f435=await this[_0x99ed98(0xf4)](),_0x2ef4c5=await this[_0x99ed98(0xf3)](),_0x42122e=_0x2ef4c5[_0x99ed98(0xe6)][_0x99ed98(0xe1)]||0x0;console['log']('📊\x20PENDING\x20payments\x20after\x20cleanup:\x20'+_0x42122e),console[_0x99ed98(0x127)]('✅\x20PENDING\x20payments\x20processed:\x20'+_0x29f435[_0x99ed98(0xc6)]),console['log'](_0x99ed98(0xed));}}exports[a60_0x1d7037(0xce)]=PaymentCleanupService,exports[a60_0x1d7037(0x106)]=new PaymentCleanupService();