'use strict';const a68_0x55856c=a68_0x158b;function a68_0x158b(_0x22a31e,_0x59b60e){_0x22a31e=_0x22a31e-0x9e;const _0x584a11=a68_0x584a();let _0x158bd0=_0x584a11[_0x22a31e];return _0x158bd0;}(function(_0x17e72e,_0x14bcd4){const _0xbcff93=a68_0x158b,_0x24d4d1=_0x17e72e();while(!![]){try{const _0x46d248=parseInt(_0xbcff93(0xcf))/0x1*(parseInt(_0xbcff93(0xc3))/0x2)+-parseInt(_0xbcff93(0xe2))/0x3*(parseInt(_0xbcff93(0x9f))/0x4)+parseInt(_0xbcff93(0xec))/0x5*(parseInt(_0xbcff93(0xb5))/0x6)+-parseInt(_0xbcff93(0xe7))/0x7+parseInt(_0xbcff93(0xe1))/0x8+parseInt(_0xbcff93(0xab))/0x9+-parseInt(_0xbcff93(0x113))/0xa;if(_0x46d248===_0x14bcd4)break;else _0x24d4d1['push'](_0x24d4d1['shift']());}catch(_0x36d3de){_0x24d4d1['push'](_0x24d4d1['shift']());}}}(a68_0x584a,0xa4411));var __importDefault=this&&this[a68_0x55856c(0x9e)]||function(_0x4c4717){const _0x58f957=a68_0x55856c;return _0x4c4717&&_0x4c4717[_0x58f957(0xc7)]?_0x4c4717:{'default':_0x4c4717};};Object[a68_0x55856c(0xc5)](exports,a68_0x55856c(0xc7),{'value':!![]}),exports[a68_0x55856c(0xcd)]=exports[a68_0x55856c(0xf2)]=void 0x0;const database_1=__importDefault(require(a68_0x55856c(0x101))),client_1=require('@prisma/client'),loggerService_1=require(a68_0x55856c(0xc1));function a68_0x584a(){const _0x5912a9=['üí•\x20','defineProperty','getTime','__esModule','gateway','üìä\x20PENDING\x20payments\x20after\x20cleanup:\x20','\x20\x20\x20Age:\x20','auto_timeout','message','paymentCleanupService','payment_cleanup','1FPmHoa','logWebhookProcessed','runPendingCleanupOnly','\x0aüîÑ\x20Running\x20PENDING\x20payments\x20cleanup...','system','createdAt','log','failed','üìä\x20PENDING\x20payments\x20before\x20cleanup:\x20','\x20payments\x20updated\x20to\x20FAILED,\x20','üìä\x20PROCESSING\x20payments\x20before\x20cleanup:\x20','\x20\x20\x20‚è∞\x20PENDING\x20‚Üí\x20EXPIRED:\x20','PENDING\x20cleanup\x20service\x20error:\x20','byGateway','update','‚è∞\x20Processing\x20stale\x20PENDING\x20payment:\x20','‚úÖ\x20Updated\x20payment\x20','üìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','7975776XqeTvL','555dJeuQM','üìä\x20PROCESSING\x20payments\x20after\x20cleanup:\x20','byAge','\x20\x20\x20Shop:\x20','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','2156889rnqeVi','admin','setDate','loggerService','\x20stale\x20PENDING\x20payments','2297770RKKmeH','pending_payment_cleanup','now','\x20\x20\x20\x20\x20\x20','\x20failed\x20to\x20update','total','PaymentCleanupService','Cleanup\x20completed:\x20','currency','\x20days','üìä\x20','\x20\x20\x20Stale\x20(3-5\x20days):\x20','default','logApiCall','Unknown\x20error','\x20\x20\x20Expired\x20(>\x205\x20days):\x20','cleanupStalePendingPayments','Failed\x20to\x20update\x20PENDING\x20payment\x20','\x20\x20\x20Created:\x20','PaymentStatus','‚úÖ\x20PROCESSING\x20payments\x20processed:\x20','../config/database','stale','length','amount','Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20','\x20from\x20PENDING\x20to\x20EXPIRED','getDate','PENDING\x20cleanup\x20completed:\x20','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','push','‚úÖ\x20No\x20stale\x20PENDING\x20payments\x20found','\x0aüìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:','forEach','PENDING_TIMEOUT_DAYS','üèÅ\x20Payment\x20cleanup\x20service\x20completed','üöÄ\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...','üöÄ\x20Starting\x20payment\x20cleanup\x20service...','\x20\x20\x20‚ùå\x20Total\x20failed\x20to\x20process:\x20','20783790oKCpBR','PENDING','__importDefault','1900ChPeUJ','floor','EXPIRED','payment','Failed\x20to\x20get\x20processing\x20payments\x20stats:','\x0aüîÑ\x20Running\x20PROCESSING\x20payments\x20cleanup...','errors','POST','\x20\x20\x20üìâ\x20Total\x20stale\x20payments\x20reduced\x20by:\x20','fresh','error','üîç\x20Found\x20','8528409VSToal','‚è±Ô∏è\x20Processing\x20stale\x20payment:\x20','processed','getProcessingPaymentsStats','byStatus','toISOString','cleanupStaleProcessingPayments','recent','\x20\x20\x20Total:\x20','findMany','12dmphai','expired','\x20\x20\x20‚úÖ\x20Total\x20successfully\x20processed:\x20','PROCESSING','PROCESSING_TIMEOUT_DAYS','üìÖ\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20','runProcessingCleanupOnly','üèÅ\x20PROCESSING\x20cleanup\x20completed','shop','\x0aüìà\x20Cleanup\x20Summary:','üìÖ\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','FAILED','./loggerService','\x20\x20\x20By\x20status:','566970WTEOTh'];a68_0x584a=function(){return _0x5912a9;};return a68_0x584a();}class PaymentCleanupService{constructor(){const _0x1d96a7=a68_0x55856c;this['PROCESSING_TIMEOUT_DAYS']=0x5,this[_0x1d96a7(0x10e)]=0x5;}async[a68_0x55856c(0xb1)](){const _0x4c25c4=a68_0x55856c,_0x30f55f=[];let _0x2d6b02=0x0,_0x21d47a=0x0;try{console[_0x4c25c4(0xd5)]('üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...');const _0x5c59f1=new Date();_0x5c59f1['setDate'](_0x5c59f1[_0x4c25c4(0x107)]()-this[_0x4c25c4(0xb9)]),console[_0x4c25c4(0xd5)](_0x4c25c4(0xbf)+_0x5c59f1[_0x4c25c4(0xb0)]());const _0xb5747=await database_1['default'][_0x4c25c4(0xa2)][_0x4c25c4(0xb4)]({'where':{'status':client_1['PaymentStatus'][_0x4c25c4(0xb8)],'createdAt':{'lt':_0x5c59f1}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x4c25c4(0xd5)](_0x4c25c4(0xaa)+_0xb5747['length']+'\x20stale\x20PROCESSING\x20payments');if(_0xb5747[_0x4c25c4(0x103)]===0x0)return console[_0x4c25c4(0xd5)]('‚úÖ\x20No\x20stale\x20PROCESSING\x20payments\x20found'),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x358265 of _0xb5747){try{console[_0x4c25c4(0xd5)](_0x4c25c4(0xac)+_0x358265['id']+'\x20('+_0x358265[_0x4c25c4(0xc8)]+',\x20'+_0x358265[_0x4c25c4(0x104)]+'\x20'+_0x358265[_0x4c25c4(0xf4)]+')'),console[_0x4c25c4(0xd5)](_0x4c25c4(0xe5)+_0x358265['shop']['name']+'\x20('+_0x358265[_0x4c25c4(0xbd)]['username']+')'),console[_0x4c25c4(0xd5)](_0x4c25c4(0xfe)+_0x358265[_0x4c25c4(0xd4)][_0x4c25c4(0xb0)]()),console[_0x4c25c4(0xd5)]('\x20\x20\x20Age:\x20'+Math[_0x4c25c4(0xa0)]((Date[_0x4c25c4(0xee)]()-_0x358265[_0x4c25c4(0xd4)][_0x4c25c4(0xc6)]())/(0x3e8*0x3c*0x3c*0x18))+_0x4c25c4(0xf5));const _0x2bc98=await database_1[_0x4c25c4(0xf8)]['payment'][_0x4c25c4(0xdd)]({'where':{'id':_0x358265['id']},'data':{'status':client_1['PaymentStatus'][_0x4c25c4(0xc0)],'statusChangedBy':_0x4c25c4(0xd3),'statusChangedAt':new Date(),'failureMessage':'Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20'+this[_0x4c25c4(0xb9)]+_0x4c25c4(0xf5)}});console[_0x4c25c4(0xd5)](_0x4c25c4(0xdf)+_0x358265['id']+'\x20from\x20PROCESSING\x20to\x20FAILED'),loggerService_1[_0x4c25c4(0xea)][_0x4c25c4(0xd0)](_0x358265[_0x4c25c4(0xc8)],_0x358265['id'],_0x4c25c4(0xb8),'FAILED',{'reason':_0x4c25c4(0xcb),'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),_0x2d6b02++;}catch(_0x2b4059){const _0x5e8075='Failed\x20to\x20update\x20payment\x20'+_0x358265['id']+':\x20'+(_0x2b4059 instanceof Error?_0x2b4059[_0x4c25c4(0xcc)]:_0x4c25c4(0xfa));console['error']('‚ùå\x20'+_0x5e8075),_0x30f55f[_0x4c25c4(0x10a)](_0x5e8075),_0x21d47a++;}}const _0x5e1bed=_0x4c25c4(0xf3)+_0x2d6b02+_0x4c25c4(0xd8)+_0x21d47a+_0x4c25c4(0xf0);return console[_0x4c25c4(0xd5)](_0x4c25c4(0xf6)+_0x5e1bed),loggerService_1['loggerService']['logApiCall'](_0x4c25c4(0xce),'POST','system',_0x4c25c4(0xe8),{'processed':_0x2d6b02,'failed':_0x21d47a,'errors':_0x30f55f,'timeoutDays':this[_0x4c25c4(0xb9)]}),{'processed':_0x2d6b02,'failed':_0x21d47a,'errors':_0x30f55f};}catch(_0xb5c90){const _0x583cdc='Cleanup\x20service\x20error:\x20'+(_0xb5c90 instanceof Error?_0xb5c90[_0x4c25c4(0xcc)]:'Unknown\x20error');return console[_0x4c25c4(0xa9)]('üí•\x20'+_0x583cdc),_0x30f55f[_0x4c25c4(0x10a)](_0x583cdc),loggerService_1[_0x4c25c4(0xea)]['logWebhookError'](_0x4c25c4(0xce),_0x583cdc,{'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),{'processed':_0x2d6b02,'failed':_0x21d47a,'errors':_0x30f55f};}}async['cleanupStalePendingPayments'](){const _0x2ba080=a68_0x55856c,_0xc02a1=[];let _0xdb33fa=0x0,_0x4cac86=0x0;try{console[_0x2ba080(0xd5)]('üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...');const _0x128d18=new Date();_0x128d18[_0x2ba080(0xe9)](_0x128d18['getDate']()-this['PENDING_TIMEOUT_DAYS']),console[_0x2ba080(0xd5)](_0x2ba080(0xba)+_0x128d18[_0x2ba080(0xb0)]());const _0x2b414c=await database_1[_0x2ba080(0xf8)]['payment'][_0x2ba080(0xb4)]({'where':{'status':client_1[_0x2ba080(0xff)][_0x2ba080(0x114)],'createdAt':{'lt':_0x128d18}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x2ba080(0xd5)](_0x2ba080(0xaa)+_0x2b414c[_0x2ba080(0x103)]+_0x2ba080(0xeb));if(_0x2b414c[_0x2ba080(0x103)]===0x0)return console[_0x2ba080(0xd5)](_0x2ba080(0x10b)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x441e6d of _0x2b414c){try{console[_0x2ba080(0xd5)](_0x2ba080(0xde)+_0x441e6d['id']+'\x20('+_0x441e6d[_0x2ba080(0xc8)]+',\x20'+_0x441e6d[_0x2ba080(0x104)]+'\x20'+_0x441e6d[_0x2ba080(0xf4)]+')'),console[_0x2ba080(0xd5)](_0x2ba080(0xe5)+_0x441e6d[_0x2ba080(0xbd)]['name']+'\x20('+_0x441e6d[_0x2ba080(0xbd)]['username']+')'),console['log'](_0x2ba080(0xfe)+_0x441e6d['createdAt']['toISOString']()),console[_0x2ba080(0xd5)](_0x2ba080(0xca)+Math['floor']((Date['now']()-_0x441e6d['createdAt'][_0x2ba080(0xc6)]())/(0x3e8*0x3c*0x3c*0x18))+_0x2ba080(0xf5));const _0x5bc5f8=await database_1['default']['payment'][_0x2ba080(0xdd)]({'where':{'id':_0x441e6d['id']},'data':{'status':client_1['PaymentStatus'][_0x2ba080(0xa1)],'statusChangedBy':_0x2ba080(0xd3),'statusChangedAt':new Date(),'failureMessage':_0x2ba080(0xe6)+this['PENDING_TIMEOUT_DAYS']+'\x20days'}});console['log'](_0x2ba080(0xdf)+_0x441e6d['id']+_0x2ba080(0x106)),loggerService_1['loggerService'][_0x2ba080(0xd0)](_0x441e6d[_0x2ba080(0xc8)],_0x441e6d['id'],'PENDING',_0x2ba080(0xa1),{'reason':'auto_timeout_pending','timeoutDays':this[_0x2ba080(0x10e)]}),_0xdb33fa++;}catch(_0x1de274){const _0xa2ad5f=_0x2ba080(0xfd)+_0x441e6d['id']+':\x20'+(_0x1de274 instanceof Error?_0x1de274[_0x2ba080(0xcc)]:_0x2ba080(0xfa));console[_0x2ba080(0xa9)]('‚ùå\x20'+_0xa2ad5f),_0xc02a1['push'](_0xa2ad5f),_0x4cac86++;}}const _0x33fea5=_0x2ba080(0x108)+_0xdb33fa+'\x20payments\x20updated\x20to\x20EXPIRED,\x20'+_0x4cac86+'\x20failed\x20to\x20update';return console[_0x2ba080(0xd5)](_0x2ba080(0xf6)+_0x33fea5),loggerService_1[_0x2ba080(0xea)][_0x2ba080(0xf9)](_0x2ba080(0xed),_0x2ba080(0xa6),'system',_0x2ba080(0xe8),{'processed':_0xdb33fa,'failed':_0x4cac86,'errors':_0xc02a1,'timeoutDays':this[_0x2ba080(0x10e)]}),{'processed':_0xdb33fa,'failed':_0x4cac86,'errors':_0xc02a1};}catch(_0x1df964){const _0x341359=_0x2ba080(0xdb)+(_0x1df964 instanceof Error?_0x1df964[_0x2ba080(0xcc)]:'Unknown\x20error');return console[_0x2ba080(0xa9)](_0x2ba080(0xc4)+_0x341359),_0xc02a1[_0x2ba080(0x10a)](_0x341359),loggerService_1[_0x2ba080(0xea)]['logWebhookError'](_0x2ba080(0xed),_0x341359,{'timeoutDays':this[_0x2ba080(0x10e)]}),{'processed':_0xdb33fa,'failed':_0x4cac86,'errors':_0xc02a1};}}async[a68_0x55856c(0xae)](){const _0x538ef7=a68_0x55856c;try{const _0x25a187=new Date(),_0x14b918=new Date(_0x25a187['getTime']()-0x1*0x18*0x3c*0x3c*0x3e8),_0x3abf88=new Date(_0x25a187['getTime']()-0x3*0x18*0x3c*0x3c*0x3e8),_0xee64c6=new Date(_0x25a187[_0x538ef7(0xc6)]()-0x5*0x18*0x3c*0x3c*0x3e8),_0x496c5b=await database_1[_0x538ef7(0xf8)]['payment'][_0x538ef7(0xb4)]({'where':{'status':{'in':[client_1['PaymentStatus'][_0x538ef7(0xb8)],client_1[_0x538ef7(0xff)][_0x538ef7(0x114)]]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x2c296a={'total':_0x496c5b[_0x538ef7(0x103)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0x429595 of _0x496c5b){if(_0x429595[_0x538ef7(0xd4)]>_0x14b918)_0x2c296a[_0x538ef7(0xe4)][_0x538ef7(0xa8)]++;else{if(_0x429595[_0x538ef7(0xd4)]>_0x3abf88)_0x2c296a[_0x538ef7(0xe4)][_0x538ef7(0xb2)]++;else _0x429595[_0x538ef7(0xd4)]>_0xee64c6?_0x2c296a[_0x538ef7(0xe4)][_0x538ef7(0x102)]++:_0x2c296a['byAge'][_0x538ef7(0xb6)]++;}!_0x2c296a[_0x538ef7(0xdc)][_0x429595[_0x538ef7(0xc8)]]&&(_0x2c296a[_0x538ef7(0xdc)][_0x429595[_0x538ef7(0xc8)]]=0x0);_0x2c296a[_0x538ef7(0xdc)][_0x429595[_0x538ef7(0xc8)]]++;const _0x1b5179=_0x429595['status'];!_0x2c296a[_0x538ef7(0xaf)][_0x1b5179]&&(_0x2c296a[_0x538ef7(0xaf)][_0x1b5179]=0x0),_0x2c296a['byStatus'][_0x1b5179]++;}return _0x2c296a;}catch(_0x3019e3){console[_0x538ef7(0xa9)](_0x538ef7(0xa3),_0x3019e3);throw new Error(_0x538ef7(0x105)+(_0x3019e3 instanceof Error?_0x3019e3[_0x538ef7(0xcc)]:_0x538ef7(0xfa)));}}async['runCleanupWithReport'](){const _0x61171a=a68_0x55856c;console['log'](_0x61171a(0x111));const _0x21ce7f=await this[_0x61171a(0xae)]();console[_0x61171a(0xd5)](_0x61171a(0xe0)),console[_0x61171a(0xd5)](_0x61171a(0xb3)+_0x21ce7f[_0x61171a(0xf1)]),console[_0x61171a(0xd5)](_0x61171a(0x109)+_0x21ce7f[_0x61171a(0xe4)][_0x61171a(0xa8)]),console[_0x61171a(0xd5)]('\x20\x20\x20Recent\x20(1-3\x20days):\x20'+_0x21ce7f[_0x61171a(0xe4)]['recent']),console['log'](_0x61171a(0xf7)+_0x21ce7f['byAge']['stale']),console['log'](_0x61171a(0xfb)+_0x21ce7f[_0x61171a(0xe4)][_0x61171a(0xb6)]),console['log']('\x20\x20\x20By\x20gateway:',_0x21ce7f[_0x61171a(0xdc)]),console[_0x61171a(0xd5)](_0x61171a(0xc2),_0x21ce7f[_0x61171a(0xaf)]),console[_0x61171a(0xd5)](_0x61171a(0xa4));const _0x216eab=await this['cleanupStaleProcessingPayments']();console[_0x61171a(0xd5)](_0x61171a(0xd2));const _0x11f9ba=await this[_0x61171a(0xfc)](),_0x9d3d9d=await this[_0x61171a(0xae)]();console[_0x61171a(0xd5)](_0x61171a(0x10c)),console[_0x61171a(0xd5)]('\x20\x20\x20Total:\x20'+_0x9d3d9d['total']),console['log'](_0x61171a(0xfb)+_0x9d3d9d['byAge'][_0x61171a(0xb6)]),console[_0x61171a(0xd5)](_0x61171a(0xc2),_0x9d3d9d['byStatus']);const _0x4e0ed1=_0x216eab['processed']+_0x11f9ba['processed'],_0xf76107=_0x216eab[_0x61171a(0xd6)]+_0x11f9ba[_0x61171a(0xd6)],_0xd112c5=[..._0x216eab[_0x61171a(0xa5)],..._0x11f9ba[_0x61171a(0xa5)]];console[_0x61171a(0xd5)](_0x61171a(0xbe)),console['log']('\x20\x20\x20üîÑ\x20PROCESSING\x20‚Üí\x20FAILED:\x20'+_0x216eab[_0x61171a(0xad)]),console[_0x61171a(0xd5)](_0x61171a(0xda)+_0x11f9ba['processed']),console[_0x61171a(0xd5)](_0x61171a(0xb7)+_0x4e0ed1),console['log'](_0x61171a(0x112)+_0xf76107),console[_0x61171a(0xd5)](_0x61171a(0xa7)+(_0x21ce7f['total']-_0x9d3d9d[_0x61171a(0xf1)])),_0xd112c5['length']>0x0&&(console[_0x61171a(0xd5)]('\x20\x20\x20‚ö†Ô∏è\x20Errors\x20encountered:'),_0xd112c5[_0x61171a(0x10d)]((_0x570657,_0x4c44b9)=>{const _0x409869=_0x61171a;console['log'](_0x409869(0xef)+(_0x4c44b9+0x1)+'.\x20'+_0x570657);})),console[_0x61171a(0xd5)](_0x61171a(0x10f));}async[a68_0x55856c(0xbb)](){const _0x33c97c=a68_0x55856c;console['log'](_0x33c97c(0x110));const _0x188774=await this[_0x33c97c(0xae)](),_0x385db6=_0x188774[_0x33c97c(0xaf)][_0x33c97c(0xb8)]||0x0;console[_0x33c97c(0xd5)](_0x33c97c(0xd9)+_0x385db6);const _0x553935=await this[_0x33c97c(0xb1)](),_0x1caf27=await this['getProcessingPaymentsStats'](),_0x393a7f=_0x1caf27[_0x33c97c(0xaf)][_0x33c97c(0xb8)]||0x0;console[_0x33c97c(0xd5)](_0x33c97c(0xe3)+_0x393a7f),console[_0x33c97c(0xd5)](_0x33c97c(0x100)+_0x553935[_0x33c97c(0xad)]),console[_0x33c97c(0xd5)](_0x33c97c(0xbc));}async[a68_0x55856c(0xd1)](){const _0xaad031=a68_0x55856c;console[_0xaad031(0xd5)]('üöÄ\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...');const _0x3779b5=await this[_0xaad031(0xae)](),_0x4727e0=_0x3779b5[_0xaad031(0xaf)]['PENDING']||0x0;console[_0xaad031(0xd5)](_0xaad031(0xd7)+_0x4727e0);const _0x2b2aa0=await this[_0xaad031(0xfc)](),_0x28243f=await this[_0xaad031(0xae)](),_0x270170=_0x28243f[_0xaad031(0xaf)][_0xaad031(0x114)]||0x0;console[_0xaad031(0xd5)](_0xaad031(0xc9)+_0x270170),console[_0xaad031(0xd5)]('‚úÖ\x20PENDING\x20payments\x20processed:\x20'+_0x2b2aa0[_0xaad031(0xad)]),console['log']('üèÅ\x20PENDING\x20cleanup\x20completed');}}exports['PaymentCleanupService']=PaymentCleanupService,exports[a68_0x55856c(0xcd)]=new PaymentCleanupService();