'use strict';const a68_0x25deec=a68_0x24c8;(function(_0x5d0f44,_0x2c4a57){const _0x1bfbc4=a68_0x24c8,_0x2c16a5=_0x5d0f44();while(!![]){try{const _0x4908ec=-parseInt(_0x1bfbc4(0xf5))/0x1+-parseInt(_0x1bfbc4(0x130))/0x2+-parseInt(_0x1bfbc4(0xfa))/0x3+-parseInt(_0x1bfbc4(0xe6))/0x4+parseInt(_0x1bfbc4(0xdd))/0x5*(-parseInt(_0x1bfbc4(0x104))/0x6)+parseInt(_0x1bfbc4(0xf6))/0x7*(parseInt(_0x1bfbc4(0x127))/0x8)+parseInt(_0x1bfbc4(0x139))/0x9*(parseInt(_0x1bfbc4(0x115))/0xa);if(_0x4908ec===_0x2c4a57)break;else _0x2c16a5['push'](_0x2c16a5['shift']());}catch(_0x27c596){_0x2c16a5['push'](_0x2c16a5['shift']());}}}(a68_0x4aa5,0x85771));function a68_0x24c8(_0x431702,_0x1f73b2){_0x431702=_0x431702-0xd7;const _0x4aa5f5=a68_0x4aa5();let _0x24c855=_0x4aa5f5[_0x431702];return _0x24c855;}var __importDefault=this&&this[a68_0x25deec(0x13b)]||function(_0x526339){return _0x526339&&_0x526339['__esModule']?_0x526339:{'default':_0x526339};};Object[a68_0x25deec(0x120)](exports,a68_0x25deec(0xec),{'value':!![]}),exports[a68_0x25deec(0xff)]=exports[a68_0x25deec(0xf8)]=void 0x0;const database_1=__importDefault(require('../config/database')),client_1=require(a68_0x25deec(0x142)),loggerService_1=require('./loggerService');class PaymentCleanupService{constructor(){const _0x2c5223=a68_0x25deec;this[_0x2c5223(0x133)]=0x5,this[_0x2c5223(0x11d)]=0x5;}async[a68_0x25deec(0xe7)](){const _0x616fbf=a68_0x25deec,_0x1ea0be=[];let _0x8d8813=0x0,_0x53ee5a=0x0;try{console[_0x616fbf(0x13c)](_0x616fbf(0x13d));const _0x39a096=new Date();_0x39a096[_0x616fbf(0x121)](_0x39a096['getDate']()-this[_0x616fbf(0x133)]),console['log'](_0x616fbf(0x12b)+_0x39a096[_0x616fbf(0x10e)]());const _0x4fcc45=await database_1['default']['payment']['findMany']({'where':{'status':client_1[_0x616fbf(0x14c)][_0x616fbf(0xd7)],'createdAt':{'lt':_0x39a096}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log'](_0x616fbf(0x107)+_0x4fcc45[_0x616fbf(0x118)]+_0x616fbf(0xfd));if(_0x4fcc45[_0x616fbf(0x118)]===0x0)return console[_0x616fbf(0x13c)](_0x616fbf(0x11b)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x27c41c of _0x4fcc45){try{console[_0x616fbf(0x13c)]('‚è±Ô∏è\x20Processing\x20stale\x20payment:\x20'+_0x27c41c['id']+'\x20('+_0x27c41c[_0x616fbf(0x11e)]+',\x20'+_0x27c41c[_0x616fbf(0x12d)]+'\x20'+_0x27c41c[_0x616fbf(0x141)]+')'),console[_0x616fbf(0x13c)]('\x20\x20\x20Shop:\x20'+_0x27c41c[_0x616fbf(0xee)][_0x616fbf(0x119)]+'\x20('+_0x27c41c[_0x616fbf(0xee)][_0x616fbf(0x10f)]+')'),console[_0x616fbf(0x13c)](_0x616fbf(0xfe)+_0x27c41c[_0x616fbf(0xd8)][_0x616fbf(0x10e)]()),console[_0x616fbf(0x13c)](_0x616fbf(0x145)+Math['floor']((Date[_0x616fbf(0x137)]()-_0x27c41c[_0x616fbf(0xd8)][_0x616fbf(0xe9)]())/(0x3e8*0x3c*0x3c*0x18))+_0x616fbf(0x147));const _0x51a626=await database_1[_0x616fbf(0x102)]['payment'][_0x616fbf(0xde)]({'where':{'id':_0x27c41c['id']},'data':{'status':client_1[_0x616fbf(0x14c)][_0x616fbf(0x136)],'statusChangedBy':'system','statusChangedAt':new Date(),'failureMessage':'Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20'+this['PROCESSING_TIMEOUT_DAYS']+_0x616fbf(0x147)}});console['log'](_0x616fbf(0xf9)+_0x27c41c['id']+_0x616fbf(0x132)),loggerService_1[_0x616fbf(0x140)][_0x616fbf(0x129)](_0x27c41c[_0x616fbf(0x11e)],_0x27c41c['id'],_0x616fbf(0xd7),_0x616fbf(0x136),{'reason':_0x616fbf(0xfb),'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),_0x8d8813++;}catch(_0x5945bf){const _0x516013=_0x616fbf(0xdf)+_0x27c41c['id']+':\x20'+(_0x5945bf instanceof Error?_0x5945bf[_0x616fbf(0x13f)]:_0x616fbf(0x146));console[_0x616fbf(0x138)]('‚ùå\x20'+_0x516013),_0x1ea0be['push'](_0x516013),_0x53ee5a++;}}const _0x430436=_0x616fbf(0x12f)+_0x8d8813+'\x20payments\x20updated\x20to\x20FAILED,\x20'+_0x53ee5a+_0x616fbf(0x110);return console[_0x616fbf(0x13c)](_0x616fbf(0xeb)+_0x430436),loggerService_1[_0x616fbf(0x140)]['logApiCall']('payment_cleanup',_0x616fbf(0x12a),_0x616fbf(0x134),'admin',{'processed':_0x8d8813,'failed':_0x53ee5a,'errors':_0x1ea0be,'timeoutDays':this[_0x616fbf(0x133)]}),{'processed':_0x8d8813,'failed':_0x53ee5a,'errors':_0x1ea0be};}catch(_0x1acdd9){const _0x4f83a1=_0x616fbf(0x109)+(_0x1acdd9 instanceof Error?_0x1acdd9['message']:_0x616fbf(0x146));return console['error'](_0x616fbf(0xe2)+_0x4f83a1),_0x1ea0be['push'](_0x4f83a1),loggerService_1['loggerService']['logWebhookError']('payment_cleanup',_0x4f83a1,{'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),{'processed':_0x8d8813,'failed':_0x53ee5a,'errors':_0x1ea0be};}}async[a68_0x25deec(0xf4)](){const _0x2faefb=a68_0x25deec,_0xcc11f1=[];let _0x52b385=0x0,_0x523b61=0x0;try{console[_0x2faefb(0x13c)](_0x2faefb(0xe8));const _0x15b804=new Date();_0x15b804[_0x2faefb(0x121)](_0x15b804[_0x2faefb(0xf0)]()-this[_0x2faefb(0x11d)]),console['log'](_0x2faefb(0x13e)+_0x15b804[_0x2faefb(0x10e)]());const _0x351368=await database_1[_0x2faefb(0x102)][_0x2faefb(0xf7)]['findMany']({'where':{'status':client_1['PaymentStatus']['PENDING'],'createdAt':{'lt':_0x15b804}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x2faefb(0x13c)](_0x2faefb(0x107)+_0x351368[_0x2faefb(0x118)]+'\x20stale\x20PENDING\x20payments');if(_0x351368['length']===0x0)return console[_0x2faefb(0x13c)](_0x2faefb(0xd9)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x4919ba of _0x351368){try{console[_0x2faefb(0x13c)]('‚è∞\x20Processing\x20stale\x20PENDING\x20payment:\x20'+_0x4919ba['id']+'\x20('+_0x4919ba[_0x2faefb(0x11e)]+',\x20'+_0x4919ba[_0x2faefb(0x12d)]+'\x20'+_0x4919ba[_0x2faefb(0x141)]+')'),console[_0x2faefb(0x13c)](_0x2faefb(0x122)+_0x4919ba['shop'][_0x2faefb(0x119)]+'\x20('+_0x4919ba['shop'][_0x2faefb(0x10f)]+')'),console['log']('\x20\x20\x20Created:\x20'+_0x4919ba[_0x2faefb(0xd8)][_0x2faefb(0x10e)]()),console[_0x2faefb(0x13c)](_0x2faefb(0x145)+Math['floor']((Date[_0x2faefb(0x137)]()-_0x4919ba[_0x2faefb(0xd8)][_0x2faefb(0xe9)]())/(0x3e8*0x3c*0x3c*0x18))+_0x2faefb(0x147));const _0x5717c4=await database_1[_0x2faefb(0x102)][_0x2faefb(0xf7)]['update']({'where':{'id':_0x4919ba['id']},'data':{'status':client_1['PaymentStatus'][_0x2faefb(0xf3)],'statusChangedBy':_0x2faefb(0x134),'statusChangedAt':new Date(),'failureMessage':_0x2faefb(0x106)+this[_0x2faefb(0x11d)]+_0x2faefb(0x147)}});console['log']('‚úÖ\x20Updated\x20payment\x20'+_0x4919ba['id']+_0x2faefb(0x131)),loggerService_1[_0x2faefb(0x140)][_0x2faefb(0x129)](_0x4919ba[_0x2faefb(0x11e)],_0x4919ba['id'],_0x2faefb(0xf1),_0x2faefb(0xf3),{'reason':'auto_timeout_pending','timeoutDays':this['PENDING_TIMEOUT_DAYS']}),_0x52b385++;}catch(_0x3b4039){const _0x8b825=_0x2faefb(0xfc)+_0x4919ba['id']+':\x20'+(_0x3b4039 instanceof Error?_0x3b4039[_0x2faefb(0x13f)]:_0x2faefb(0x146));console[_0x2faefb(0x138)]('‚ùå\x20'+_0x8b825),_0xcc11f1[_0x2faefb(0x10d)](_0x8b825),_0x523b61++;}}const _0x4f519e=_0x2faefb(0x11f)+_0x52b385+_0x2faefb(0x13a)+_0x523b61+_0x2faefb(0x110);return console['log'](_0x2faefb(0xeb)+_0x4f519e),loggerService_1[_0x2faefb(0x140)][_0x2faefb(0x149)](_0x2faefb(0xed),'POST',_0x2faefb(0x134),_0x2faefb(0x143),{'processed':_0x52b385,'failed':_0x523b61,'errors':_0xcc11f1,'timeoutDays':this[_0x2faefb(0x11d)]}),{'processed':_0x52b385,'failed':_0x523b61,'errors':_0xcc11f1};}catch(_0x260cba){const _0x38040e=_0x2faefb(0x125)+(_0x260cba instanceof Error?_0x260cba['message']:'Unknown\x20error');return console[_0x2faefb(0x138)](_0x2faefb(0xe2)+_0x38040e),_0xcc11f1[_0x2faefb(0x10d)](_0x38040e),loggerService_1[_0x2faefb(0x140)][_0x2faefb(0xda)](_0x2faefb(0xed),_0x38040e,{'timeoutDays':this[_0x2faefb(0x11d)]}),{'processed':_0x52b385,'failed':_0x523b61,'errors':_0xcc11f1};}}async[a68_0x25deec(0x123)](){const _0x3ace91=a68_0x25deec;try{const _0x3c227b=new Date(),_0x10445c=new Date(_0x3c227b[_0x3ace91(0xe9)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x14edbf=new Date(_0x3c227b[_0x3ace91(0xe9)]()-0x3*0x18*0x3c*0x3c*0x3e8),_0x3f6dbe=new Date(_0x3c227b['getTime']()-0x5*0x18*0x3c*0x3c*0x3e8),_0x1969dd=await database_1[_0x3ace91(0x102)]['payment'][_0x3ace91(0x124)]({'where':{'status':{'in':[client_1['PaymentStatus'][_0x3ace91(0xd7)],client_1[_0x3ace91(0x14c)]['PENDING']]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x5b6243={'total':_0x1969dd[_0x3ace91(0x118)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0x97e886 of _0x1969dd){if(_0x97e886[_0x3ace91(0xd8)]>_0x10445c)_0x5b6243[_0x3ace91(0x116)][_0x3ace91(0x112)]++;else{if(_0x97e886['createdAt']>_0x14edbf)_0x5b6243[_0x3ace91(0x116)]['recent']++;else _0x97e886['createdAt']>_0x3f6dbe?_0x5b6243[_0x3ace91(0x116)][_0x3ace91(0x11c)]++:_0x5b6243[_0x3ace91(0x116)][_0x3ace91(0x10c)]++;}!_0x5b6243['byGateway'][_0x97e886['gateway']]&&(_0x5b6243[_0x3ace91(0x10a)][_0x97e886[_0x3ace91(0x11e)]]=0x0);_0x5b6243[_0x3ace91(0x10a)][_0x97e886[_0x3ace91(0x11e)]]++;const _0x36967=_0x97e886[_0x3ace91(0x101)];!_0x5b6243[_0x3ace91(0x100)][_0x36967]&&(_0x5b6243[_0x3ace91(0x100)][_0x36967]=0x0),_0x5b6243[_0x3ace91(0x100)][_0x36967]++;}return _0x5b6243;}catch(_0x3d0eec){console[_0x3ace91(0x138)](_0x3ace91(0x10b),_0x3d0eec);throw new Error('Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20'+(_0x3d0eec instanceof Error?_0x3d0eec['message']:_0x3ace91(0x146)));}}async[a68_0x25deec(0xe1)](){const _0x55fb51=a68_0x25deec;console[_0x55fb51(0x13c)](_0x55fb51(0x103));const _0x5cb78b=await this['getProcessingPaymentsStats']();console[_0x55fb51(0x13c)](_0x55fb51(0x14b)),console['log'](_0x55fb51(0x105)+_0x5cb78b[_0x55fb51(0x14a)]),console[_0x55fb51(0x13c)](_0x55fb51(0x126)+_0x5cb78b[_0x55fb51(0x116)]['fresh']),console['log']('\x20\x20\x20Recent\x20(1-3\x20days):\x20'+_0x5cb78b[_0x55fb51(0x116)]['recent']),console[_0x55fb51(0x13c)]('\x20\x20\x20Stale\x20(3-5\x20days):\x20'+_0x5cb78b[_0x55fb51(0x116)]['stale']),console['log']('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x5cb78b[_0x55fb51(0x116)][_0x55fb51(0x10c)]),console[_0x55fb51(0x13c)](_0x55fb51(0xe5),_0x5cb78b[_0x55fb51(0x10a)]),console[_0x55fb51(0x13c)](_0x55fb51(0x11a),_0x5cb78b['byStatus']),console[_0x55fb51(0x13c)](_0x55fb51(0xe3));const _0x416d44=await this[_0x55fb51(0xe7)]();console['log']('\x0aüîÑ\x20Running\x20PENDING\x20payments\x20cleanup...');const _0x5d9e4f=await this[_0x55fb51(0xf4)](),_0x189519=await this[_0x55fb51(0x123)]();console[_0x55fb51(0x13c)](_0x55fb51(0xea)),console[_0x55fb51(0x13c)](_0x55fb51(0x105)+_0x189519[_0x55fb51(0x14a)]),console[_0x55fb51(0x13c)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x189519['byAge'][_0x55fb51(0x10c)]),console[_0x55fb51(0x13c)]('\x20\x20\x20By\x20status:',_0x189519[_0x55fb51(0x100)]);const _0x2b48d9=_0x416d44[_0x55fb51(0xef)]+_0x5d9e4f[_0x55fb51(0xef)],_0x1e26eb=_0x416d44['failed']+_0x5d9e4f[_0x55fb51(0x113)],_0x2f5412=[..._0x416d44[_0x55fb51(0xe0)],..._0x5d9e4f[_0x55fb51(0xe0)]];console[_0x55fb51(0x13c)](_0x55fb51(0x117)),console[_0x55fb51(0x13c)]('\x20\x20\x20üîÑ\x20PROCESSING\x20‚Üí\x20FAILED:\x20'+_0x416d44[_0x55fb51(0xef)]),console['log'](_0x55fb51(0x108)+_0x5d9e4f['processed']),console['log'](_0x55fb51(0x144)+_0x2b48d9),console[_0x55fb51(0x13c)](_0x55fb51(0xf2)+_0x1e26eb),console[_0x55fb51(0x13c)](_0x55fb51(0x114)+(_0x5cb78b[_0x55fb51(0x14a)]-_0x189519[_0x55fb51(0x14a)])),_0x2f5412[_0x55fb51(0x118)]>0x0&&(console[_0x55fb51(0x13c)](_0x55fb51(0x12c)),_0x2f5412[_0x55fb51(0x135)]((_0x25e71c,_0x1d5572)=>{const _0x1638f4=_0x55fb51;console[_0x1638f4(0x13c)]('\x20\x20\x20\x20\x20\x20'+(_0x1d5572+0x1)+'.\x20'+_0x25e71c);})),console[_0x55fb51(0x13c)](_0x55fb51(0xdb));}async['runProcessingCleanupOnly'](){const _0x2a9216=a68_0x25deec;console[_0x2a9216(0x13c)]('üöÄ\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...');const _0x255130=await this[_0x2a9216(0x123)](),_0x4d1a9a=_0x255130[_0x2a9216(0x100)][_0x2a9216(0xd7)]||0x0;console[_0x2a9216(0x13c)](_0x2a9216(0x111)+_0x4d1a9a);const _0x4fc927=await this[_0x2a9216(0xe7)](),_0x1bffbe=await this['getProcessingPaymentsStats'](),_0x2899a6=_0x1bffbe[_0x2a9216(0x100)]['PROCESSING']||0x0;console[_0x2a9216(0x13c)](_0x2a9216(0xe4)+_0x2899a6),console[_0x2a9216(0x13c)]('‚úÖ\x20PROCESSING\x20payments\x20processed:\x20'+_0x4fc927[_0x2a9216(0xef)]),console['log'](_0x2a9216(0x148));}async['runPendingCleanupOnly'](){const _0x5d5997=a68_0x25deec;console[_0x5d5997(0x13c)](_0x5d5997(0x12e));const _0x26807c=await this['getProcessingPaymentsStats'](),_0xd23f61=_0x26807c[_0x5d5997(0x100)][_0x5d5997(0xf1)]||0x0;console[_0x5d5997(0x13c)](_0x5d5997(0x128)+_0xd23f61);const _0x4a74ee=await this[_0x5d5997(0xf4)](),_0x38c481=await this[_0x5d5997(0x123)](),_0xb01620=_0x38c481[_0x5d5997(0x100)][_0x5d5997(0xf1)]||0x0;console[_0x5d5997(0x13c)]('üìä\x20PENDING\x20payments\x20after\x20cleanup:\x20'+_0xb01620),console[_0x5d5997(0x13c)](_0x5d5997(0xdc)+_0x4a74ee[_0x5d5997(0xef)]),console[_0x5d5997(0x13c)]('üèÅ\x20PENDING\x20cleanup\x20completed');}}exports[a68_0x25deec(0xf8)]=PaymentCleanupService,exports['paymentCleanupService']=new PaymentCleanupService();function a68_0x4aa5(){const _0x15a143=['getProcessingPaymentsStats','findMany','PENDING\x20cleanup\x20service\x20error:\x20','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','697264UcLYgS','üìä\x20PENDING\x20payments\x20before\x20cleanup:\x20','logWebhookProcessed','POST','üìÖ\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','\x20\x20\x20‚ö†Ô∏è\x20Errors\x20encountered:','amount','üöÄ\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...','Cleanup\x20completed:\x20','413476YFcQBs','\x20from\x20PENDING\x20to\x20EXPIRED','\x20from\x20PROCESSING\x20to\x20FAILED','PROCESSING_TIMEOUT_DAYS','system','forEach','FAILED','now','error','27QShylb','\x20payments\x20updated\x20to\x20EXPIRED,\x20','__importDefault','log','üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','üìÖ\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20','message','loggerService','currency','@prisma/client','admin','\x20\x20\x20‚úÖ\x20Total\x20successfully\x20processed:\x20','\x20\x20\x20Age:\x20','Unknown\x20error','\x20days','üèÅ\x20PROCESSING\x20cleanup\x20completed','logApiCall','total','üìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','PaymentStatus','PROCESSING','createdAt','‚úÖ\x20No\x20stale\x20PENDING\x20payments\x20found','logWebhookError','üèÅ\x20Payment\x20cleanup\x20service\x20completed','‚úÖ\x20PENDING\x20payments\x20processed:\x20','990655GkNtVC','update','Failed\x20to\x20update\x20payment\x20','errors','runCleanupWithReport','üí•\x20','\x0aüîÑ\x20Running\x20PROCESSING\x20payments\x20cleanup...','üìä\x20PROCESSING\x20payments\x20after\x20cleanup:\x20','\x20\x20\x20By\x20gateway:','3776884oDpMzb','cleanupStaleProcessingPayments','üßπ\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...','getTime','\x0aüìä\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:','üìä\x20','__esModule','pending_payment_cleanup','shop','processed','getDate','PENDING','\x20\x20\x20‚ùå\x20Total\x20failed\x20to\x20process:\x20','EXPIRED','cleanupStalePendingPayments','488804BFNtsl','49CyYZar','payment','PaymentCleanupService','‚úÖ\x20Updated\x20payment\x20','1145415WbPLgG','auto_timeout','Failed\x20to\x20update\x20PENDING\x20payment\x20','\x20stale\x20PROCESSING\x20payments','\x20\x20\x20Created:\x20','paymentCleanupService','byStatus','status','default','üöÄ\x20Starting\x20payment\x20cleanup\x20service...','12koXFFI','\x20\x20\x20Total:\x20','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','üîç\x20Found\x20','\x20\x20\x20‚è∞\x20PENDING\x20‚Üí\x20EXPIRED:\x20','Cleanup\x20service\x20error:\x20','byGateway','Failed\x20to\x20get\x20processing\x20payments\x20stats:','expired','push','toISOString','username','\x20failed\x20to\x20update','üìä\x20PROCESSING\x20payments\x20before\x20cleanup:\x20','fresh','failed','\x20\x20\x20üìâ\x20Total\x20stale\x20payments\x20reduced\x20by:\x20','7847990cIQDrk','byAge','\x0aüìà\x20Cleanup\x20Summary:','length','name','\x20\x20\x20By\x20status:','‚úÖ\x20No\x20stale\x20PROCESSING\x20payments\x20found','stale','PENDING_TIMEOUT_DAYS','gateway','PENDING\x20cleanup\x20completed:\x20','defineProperty','setDate','\x20\x20\x20Shop:\x20'];a68_0x4aa5=function(){return _0x15a143;};return a68_0x4aa5();}