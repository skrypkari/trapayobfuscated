'use strict';const a60_0x33cd84=a60_0x33f0;(function(_0x26b9be,_0xf9011e){const _0x13fd78=a60_0x33f0,_0x3ed81c=_0x26b9be();while(!![]){try{const _0x2ab060=-parseInt(_0x13fd78(0xe5))/0x1*(-parseInt(_0x13fd78(0x8a))/0x2)+parseInt(_0x13fd78(0xbd))/0x3*(-parseInt(_0x13fd78(0xb9))/0x4)+-parseInt(_0x13fd78(0xa0))/0x5+parseInt(_0x13fd78(0xca))/0x6*(parseInt(_0x13fd78(0xc5))/0x7)+parseInt(_0x13fd78(0xc8))/0x8+parseInt(_0x13fd78(0x7f))/0x9+parseInt(_0x13fd78(0x7e))/0xa*(-parseInt(_0x13fd78(0xa3))/0xb);if(_0x2ab060===_0xf9011e)break;else _0x3ed81c['push'](_0x3ed81c['shift']());}catch(_0x4299f3){_0x3ed81c['push'](_0x3ed81c['shift']());}}}(a60_0x572d,0x71cd2));function a60_0x33f0(_0x195709,_0x2e9be0){const _0x572df4=a60_0x572d();return a60_0x33f0=function(_0x33f074,_0x484705){_0x33f074=_0x33f074-0x79;let _0xc251f6=_0x572df4[_0x33f074];return _0xc251f6;},a60_0x33f0(_0x195709,_0x2e9be0);}var __importDefault=this&&this['__importDefault']||function(_0x46715d){const _0x6d96d4=a60_0x33f0;return _0x46715d&&_0x46715d[_0x6d96d4(0xa2)]?_0x46715d:{'default':_0x46715d};};Object[a60_0x33cd84(0x97)](exports,a60_0x33cd84(0xa2),{'value':!![]}),exports[a60_0x33cd84(0x99)]=exports[a60_0x33cd84(0xb5)]=void 0x0;function a60_0x572d(){const _0x37baef=['✅\x20PENDING\x20payments\x20processed:\x20','./loggerService','⏰\x20Processing\x20stale\x20PENDING\x20payment:\x20','findMany','📊\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','cleanupStalePendingPayments','forEach','7FeWjxG','auto_timeout','\x20stale\x20PENDING\x20payments','231256PnBUcv','\x0a🔄\x20Running\x20PENDING\x20payments\x20cleanup...','2714574iMYVqf','pending_payment_cleanup','amount','\x20\x20\x20By\x20gateway:','FAILED','push','@prisma/client','\x20\x20\x20Recent\x20(1-3\x20days):\x20','📊\x20PENDING\x20payments\x20after\x20cleanup:\x20','gateway','🚀\x20Starting\x20payment\x20cleanup\x20service...','PaymentStatus','expired','PROCESSING_TIMEOUT_DAYS','EXPIRED','\x20days','shop','update','payment','logApiCall','failed','default','\x20\x20\x20🔄\x20PROCESSING\x20→\x20FAILED:\x20','PENDING\x20cleanup\x20completed:\x20','\x20\x20\x20Stale\x20(3-5\x20days):\x20','\x20failed\x20to\x20update','payment_cleanup','1EGDEGT','getProcessingPaymentsStats','✅\x20Updated\x20payment\x20','🔍\x20Found\x20','recent','loggerService','Cleanup\x20completed:\x20','byAge','createdAt','system','🚀\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...','message','byStatus','total','207010rSpUJl','7195788wzoEme','Unknown\x20error','\x20from\x20PENDING\x20to\x20EXPIRED','Cleanup\x20service\x20error:\x20','admin','\x20\x20\x20⚠️\x20Errors\x20encountered:','PENDING','\x20\x20\x20⏰\x20PENDING\x20→\x20EXPIRED:\x20','🧹\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...','username','🧹\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','506138bJKYjs','\x20stale\x20PROCESSING\x20payments','toISOString','\x20\x20\x20❌\x20Total\x20failed\x20to\x20process:\x20','stale','📊\x20PROCESSING\x20payments\x20before\x20cleanup:\x20','📅\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20','PENDING_TIMEOUT_DAYS','errors','getTime','\x0a📈\x20Cleanup\x20Summary:','PROCESSING','length','defineProperty','✅\x20No\x20stale\x20PROCESSING\x20payments\x20found','paymentCleanupService','🏁\x20Payment\x20cleanup\x20service\x20completed','✅\x20PROCESSING\x20payments\x20processed:\x20','cleanupStaleProcessingPayments','auto_timeout_pending','\x20\x20\x20Age:\x20','processed','108845WbyBQL','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','__esModule','154ARVKxT','\x20\x20\x20Total:\x20','error','💥\x20','byGateway','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','POST','getDate','\x20from\x20PROCESSING\x20to\x20FAILED','runProcessingCleanupOnly','\x20\x20\x20By\x20status:','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','✅\x20No\x20stale\x20PENDING\x20payments\x20found','currency','floor','\x20\x20\x20Created:\x20','\x20\x20\x20Shop:\x20','\x20\x20\x20✅\x20Total\x20successfully\x20processed:\x20','PaymentCleanupService','📊\x20PENDING\x20payments\x20before\x20cleanup:\x20','logWebhookError','📊\x20','896DPfNJV','📊\x20PROCESSING\x20payments\x20after\x20cleanup:\x20','log','\x20payments\x20updated\x20to\x20FAILED,\x20','10128kBVJfo'];a60_0x572d=function(){return _0x37baef;};return a60_0x572d();}const database_1=__importDefault(require('../config/database')),client_1=require(a60_0x33cd84(0xd0)),loggerService_1=require(a60_0x33cd84(0xbf));class PaymentCleanupService{constructor(){const _0x4f3346=a60_0x33cd84;this[_0x4f3346(0xd7)]=0x5,this[_0x4f3346(0x91)]=0x5;}async['cleanupStaleProcessingPayments'](){const _0x5d8974=a60_0x33cd84,_0x59bc94=[];let _0x23f319=0x0,_0xdc21df=0x0;try{console['log'](_0x5d8974(0x89));const _0x5a5f4d=new Date();_0x5a5f4d['setDate'](_0x5a5f4d[_0x5d8974(0xaa)]()-this['PROCESSING_TIMEOUT_DAYS']),console[_0x5d8974(0xbb)]('📅\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20'+_0x5a5f4d['toISOString']());const _0x21f1a3=await database_1[_0x5d8974(0xdf)]['payment'][_0x5d8974(0xc1)]({'where':{'status':client_1[_0x5d8974(0xd5)]['PROCESSING'],'createdAt':{'lt':_0x5a5f4d}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x5d8974(0xbb)](_0x5d8974(0xe8)+_0x21f1a3[_0x5d8974(0x96)]+_0x5d8974(0x8b));if(_0x21f1a3[_0x5d8974(0x96)]===0x0)return console['log'](_0x5d8974(0x98)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x23cbaf of _0x21f1a3){try{console[_0x5d8974(0xbb)]('⏱️\x20Processing\x20stale\x20payment:\x20'+_0x23cbaf['id']+'\x20('+_0x23cbaf[_0x5d8974(0xd3)]+',\x20'+_0x23cbaf[_0x5d8974(0xcc)]+'\x20'+_0x23cbaf[_0x5d8974(0xb0)]+')'),console['log'](_0x5d8974(0xb3)+_0x23cbaf[_0x5d8974(0xda)]['name']+'\x20('+_0x23cbaf[_0x5d8974(0xda)][_0x5d8974(0x88)]+')'),console['log'](_0x5d8974(0xb2)+_0x23cbaf[_0x5d8974(0xed)]['toISOString']()),console[_0x5d8974(0xbb)](_0x5d8974(0x9e)+Math['floor']((Date['now']()-_0x23cbaf['createdAt'][_0x5d8974(0x93)]())/(0x3e8*0x3c*0x3c*0x18))+'\x20days');const _0x4bb454=await database_1['default'][_0x5d8974(0xdc)][_0x5d8974(0xdb)]({'where':{'id':_0x23cbaf['id']},'data':{'status':client_1[_0x5d8974(0xd5)][_0x5d8974(0xce)],'statusChangedBy':'system','statusChangedAt':new Date(),'failureMessage':_0x5d8974(0xae)+this[_0x5d8974(0xd7)]+_0x5d8974(0xd9)}});console[_0x5d8974(0xbb)](_0x5d8974(0xe7)+_0x23cbaf['id']+_0x5d8974(0xab)),loggerService_1[_0x5d8974(0xea)]['logWebhookProcessed'](_0x23cbaf['gateway'],_0x23cbaf['id'],'PROCESSING',_0x5d8974(0xce),{'reason':_0x5d8974(0xc6),'timeoutDays':this[_0x5d8974(0xd7)]}),_0x23f319++;}catch(_0x299103){const _0x2c5057='Failed\x20to\x20update\x20payment\x20'+_0x23cbaf['id']+':\x20'+(_0x299103 instanceof Error?_0x299103[_0x5d8974(0x7b)]:_0x5d8974(0x80));console[_0x5d8974(0xa5)]('❌\x20'+_0x2c5057),_0x59bc94[_0x5d8974(0xcf)](_0x2c5057),_0xdc21df++;}}const _0x4b9185=_0x5d8974(0xeb)+_0x23f319+_0x5d8974(0xbc)+_0xdc21df+_0x5d8974(0xe3);return console[_0x5d8974(0xbb)](_0x5d8974(0xb8)+_0x4b9185),loggerService_1[_0x5d8974(0xea)][_0x5d8974(0xdd)](_0x5d8974(0xe4),'POST','system',_0x5d8974(0x83),{'processed':_0x23f319,'failed':_0xdc21df,'errors':_0x59bc94,'timeoutDays':this[_0x5d8974(0xd7)]}),{'processed':_0x23f319,'failed':_0xdc21df,'errors':_0x59bc94};}catch(_0x356277){const _0x140cf1=_0x5d8974(0x82)+(_0x356277 instanceof Error?_0x356277[_0x5d8974(0x7b)]:'Unknown\x20error');return console[_0x5d8974(0xa5)]('💥\x20'+_0x140cf1),_0x59bc94[_0x5d8974(0xcf)](_0x140cf1),loggerService_1[_0x5d8974(0xea)][_0x5d8974(0xb7)](_0x5d8974(0xe4),_0x140cf1,{'timeoutDays':this[_0x5d8974(0xd7)]}),{'processed':_0x23f319,'failed':_0xdc21df,'errors':_0x59bc94};}}async[a60_0x33cd84(0xc3)](){const _0x218d60=a60_0x33cd84,_0x15f566=[];let _0x522ada=0x0,_0x119b9f=0x0;try{console[_0x218d60(0xbb)](_0x218d60(0x87));const _0x195812=new Date();_0x195812['setDate'](_0x195812[_0x218d60(0xaa)]()-this[_0x218d60(0x91)]),console[_0x218d60(0xbb)](_0x218d60(0x90)+_0x195812[_0x218d60(0x8c)]());const _0x247687=await database_1[_0x218d60(0xdf)][_0x218d60(0xdc)][_0x218d60(0xc1)]({'where':{'status':client_1['PaymentStatus'][_0x218d60(0x85)],'createdAt':{'lt':_0x195812}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log']('🔍\x20Found\x20'+_0x247687[_0x218d60(0x96)]+_0x218d60(0xc7));if(_0x247687[_0x218d60(0x96)]===0x0)return console[_0x218d60(0xbb)](_0x218d60(0xaf)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x240517 of _0x247687){try{console[_0x218d60(0xbb)](_0x218d60(0xc0)+_0x240517['id']+'\x20('+_0x240517[_0x218d60(0xd3)]+',\x20'+_0x240517[_0x218d60(0xcc)]+'\x20'+_0x240517['currency']+')'),console[_0x218d60(0xbb)]('\x20\x20\x20Shop:\x20'+_0x240517[_0x218d60(0xda)]['name']+'\x20('+_0x240517['shop'][_0x218d60(0x88)]+')'),console[_0x218d60(0xbb)](_0x218d60(0xb2)+_0x240517[_0x218d60(0xed)][_0x218d60(0x8c)]()),console[_0x218d60(0xbb)](_0x218d60(0x9e)+Math[_0x218d60(0xb1)]((Date['now']()-_0x240517[_0x218d60(0xed)]['getTime']())/(0x3e8*0x3c*0x3c*0x18))+_0x218d60(0xd9));const _0x2f52bd=await database_1['default'][_0x218d60(0xdc)]['update']({'where':{'id':_0x240517['id']},'data':{'status':client_1[_0x218d60(0xd5)][_0x218d60(0xd8)],'statusChangedBy':_0x218d60(0x79),'statusChangedAt':new Date(),'failureMessage':_0x218d60(0xa8)+this[_0x218d60(0x91)]+'\x20days'}});console['log']('✅\x20Updated\x20payment\x20'+_0x240517['id']+_0x218d60(0x81)),loggerService_1[_0x218d60(0xea)]['logWebhookProcessed'](_0x240517[_0x218d60(0xd3)],_0x240517['id'],_0x218d60(0x85),'EXPIRED',{'reason':_0x218d60(0x9d),'timeoutDays':this['PENDING_TIMEOUT_DAYS']}),_0x522ada++;}catch(_0xc6e0cf){const _0x3c3f8f='Failed\x20to\x20update\x20PENDING\x20payment\x20'+_0x240517['id']+':\x20'+(_0xc6e0cf instanceof Error?_0xc6e0cf[_0x218d60(0x7b)]:_0x218d60(0x80));console[_0x218d60(0xa5)]('❌\x20'+_0x3c3f8f),_0x15f566[_0x218d60(0xcf)](_0x3c3f8f),_0x119b9f++;}}const _0x22ec5f=_0x218d60(0xe1)+_0x522ada+'\x20payments\x20updated\x20to\x20EXPIRED,\x20'+_0x119b9f+_0x218d60(0xe3);return console[_0x218d60(0xbb)]('📊\x20'+_0x22ec5f),loggerService_1[_0x218d60(0xea)][_0x218d60(0xdd)](_0x218d60(0xcb),_0x218d60(0xa9),_0x218d60(0x79),'admin',{'processed':_0x522ada,'failed':_0x119b9f,'errors':_0x15f566,'timeoutDays':this[_0x218d60(0x91)]}),{'processed':_0x522ada,'failed':_0x119b9f,'errors':_0x15f566};}catch(_0x41b96d){const _0x281bc2='PENDING\x20cleanup\x20service\x20error:\x20'+(_0x41b96d instanceof Error?_0x41b96d[_0x218d60(0x7b)]:'Unknown\x20error');return console[_0x218d60(0xa5)](_0x218d60(0xa6)+_0x281bc2),_0x15f566[_0x218d60(0xcf)](_0x281bc2),loggerService_1[_0x218d60(0xea)][_0x218d60(0xb7)](_0x218d60(0xcb),_0x281bc2,{'timeoutDays':this[_0x218d60(0x91)]}),{'processed':_0x522ada,'failed':_0x119b9f,'errors':_0x15f566};}}async['getProcessingPaymentsStats'](){const _0x3d61be=a60_0x33cd84;try{const _0x587cd7=new Date(),_0x337a5f=new Date(_0x587cd7[_0x3d61be(0x93)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x47f368=new Date(_0x587cd7[_0x3d61be(0x93)]()-0x3*0x18*0x3c*0x3c*0x3e8),_0x12dbab=new Date(_0x587cd7[_0x3d61be(0x93)]()-0x5*0x18*0x3c*0x3c*0x3e8),_0x11d887=await database_1[_0x3d61be(0xdf)][_0x3d61be(0xdc)][_0x3d61be(0xc1)]({'where':{'status':{'in':[client_1[_0x3d61be(0xd5)][_0x3d61be(0x95)],client_1['PaymentStatus'][_0x3d61be(0x85)]]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x8d2b9={'total':_0x11d887[_0x3d61be(0x96)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0x3db1cd of _0x11d887){if(_0x3db1cd[_0x3d61be(0xed)]>_0x337a5f)_0x8d2b9[_0x3d61be(0xec)]['fresh']++;else{if(_0x3db1cd[_0x3d61be(0xed)]>_0x47f368)_0x8d2b9[_0x3d61be(0xec)][_0x3d61be(0xe9)]++;else _0x3db1cd[_0x3d61be(0xed)]>_0x12dbab?_0x8d2b9[_0x3d61be(0xec)][_0x3d61be(0x8e)]++:_0x8d2b9[_0x3d61be(0xec)][_0x3d61be(0xd6)]++;}!_0x8d2b9[_0x3d61be(0xa7)][_0x3db1cd[_0x3d61be(0xd3)]]&&(_0x8d2b9[_0x3d61be(0xa7)][_0x3db1cd[_0x3d61be(0xd3)]]=0x0);_0x8d2b9[_0x3d61be(0xa7)][_0x3db1cd[_0x3d61be(0xd3)]]++;const _0x59586b=_0x3db1cd['status'];!_0x8d2b9[_0x3d61be(0x7c)][_0x59586b]&&(_0x8d2b9[_0x3d61be(0x7c)][_0x59586b]=0x0),_0x8d2b9['byStatus'][_0x59586b]++;}return _0x8d2b9;}catch(_0x16c725){console[_0x3d61be(0xa5)]('Failed\x20to\x20get\x20processing\x20payments\x20stats:',_0x16c725);throw new Error('Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20'+(_0x16c725 instanceof Error?_0x16c725['message']:_0x3d61be(0x80)));}}async['runCleanupWithReport'](){const _0x356543=a60_0x33cd84;console[_0x356543(0xbb)](_0x356543(0xd4));const _0x4987eb=await this['getProcessingPaymentsStats']();console[_0x356543(0xbb)](_0x356543(0xc2)),console[_0x356543(0xbb)](_0x356543(0xa4)+_0x4987eb['total']),console[_0x356543(0xbb)](_0x356543(0xa1)+_0x4987eb['byAge']['fresh']),console[_0x356543(0xbb)](_0x356543(0xd1)+_0x4987eb['byAge'][_0x356543(0xe9)]),console['log'](_0x356543(0xe2)+_0x4987eb[_0x356543(0xec)][_0x356543(0x8e)]),console[_0x356543(0xbb)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x4987eb[_0x356543(0xec)][_0x356543(0xd6)]),console[_0x356543(0xbb)](_0x356543(0xcd),_0x4987eb[_0x356543(0xa7)]),console['log'](_0x356543(0xad),_0x4987eb['byStatus']),console['log']('\x0a🔄\x20Running\x20PROCESSING\x20payments\x20cleanup...');const _0x5d90eb=await this[_0x356543(0x9c)]();console[_0x356543(0xbb)](_0x356543(0xc9));const _0x24aab9=await this[_0x356543(0xc3)](),_0x38a7f2=await this['getProcessingPaymentsStats']();console[_0x356543(0xbb)]('\x0a📊\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:'),console[_0x356543(0xbb)]('\x20\x20\x20Total:\x20'+_0x38a7f2[_0x356543(0x7d)]),console[_0x356543(0xbb)]('\x20\x20\x20Expired\x20(>\x205\x20days):\x20'+_0x38a7f2[_0x356543(0xec)][_0x356543(0xd6)]),console[_0x356543(0xbb)]('\x20\x20\x20By\x20status:',_0x38a7f2['byStatus']);const _0x234b5b=_0x5d90eb[_0x356543(0x9f)]+_0x24aab9[_0x356543(0x9f)],_0x3096f4=_0x5d90eb[_0x356543(0xde)]+_0x24aab9['failed'],_0x56ae2d=[..._0x5d90eb[_0x356543(0x92)],..._0x24aab9['errors']];console[_0x356543(0xbb)](_0x356543(0x94)),console[_0x356543(0xbb)](_0x356543(0xe0)+_0x5d90eb[_0x356543(0x9f)]),console[_0x356543(0xbb)](_0x356543(0x86)+_0x24aab9[_0x356543(0x9f)]),console[_0x356543(0xbb)](_0x356543(0xb4)+_0x234b5b),console['log'](_0x356543(0x8d)+_0x3096f4),console[_0x356543(0xbb)]('\x20\x20\x20📉\x20Total\x20stale\x20payments\x20reduced\x20by:\x20'+(_0x4987eb[_0x356543(0x7d)]-_0x38a7f2[_0x356543(0x7d)])),_0x56ae2d[_0x356543(0x96)]>0x0&&(console[_0x356543(0xbb)](_0x356543(0x84)),_0x56ae2d[_0x356543(0xc4)]((_0x742ec8,_0x54b0c6)=>{const _0x21eb20=_0x356543;console[_0x21eb20(0xbb)]('\x20\x20\x20\x20\x20\x20'+(_0x54b0c6+0x1)+'.\x20'+_0x742ec8);})),console[_0x356543(0xbb)](_0x356543(0x9a));}async[a60_0x33cd84(0xac)](){const _0x12b214=a60_0x33cd84;console[_0x12b214(0xbb)]('🚀\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...');const _0x3367fe=await this[_0x12b214(0xe6)](),_0x23a7c8=_0x3367fe[_0x12b214(0x7c)][_0x12b214(0x95)]||0x0;console[_0x12b214(0xbb)](_0x12b214(0x8f)+_0x23a7c8);const _0x1a0105=await this['cleanupStaleProcessingPayments'](),_0x1ed39b=await this[_0x12b214(0xe6)](),_0x58f6a6=_0x1ed39b[_0x12b214(0x7c)]['PROCESSING']||0x0;console['log'](_0x12b214(0xba)+_0x58f6a6),console['log'](_0x12b214(0x9b)+_0x1a0105['processed']),console[_0x12b214(0xbb)]('🏁\x20PROCESSING\x20cleanup\x20completed');}async['runPendingCleanupOnly'](){const _0xfb1e60=a60_0x33cd84;console[_0xfb1e60(0xbb)](_0xfb1e60(0x7a));const _0xe29610=await this[_0xfb1e60(0xe6)](),_0x4fdb2a=_0xe29610[_0xfb1e60(0x7c)][_0xfb1e60(0x85)]||0x0;console['log'](_0xfb1e60(0xb6)+_0x4fdb2a);const _0x14d077=await this['cleanupStalePendingPayments'](),_0x1fb43f=await this['getProcessingPaymentsStats'](),_0x543a0a=_0x1fb43f[_0xfb1e60(0x7c)][_0xfb1e60(0x85)]||0x0;console[_0xfb1e60(0xbb)](_0xfb1e60(0xd2)+_0x543a0a),console['log'](_0xfb1e60(0xbe)+_0x14d077[_0xfb1e60(0x9f)]),console['log']('🏁\x20PENDING\x20cleanup\x20completed');}}exports[a60_0x33cd84(0xb5)]=PaymentCleanupService,exports['paymentCleanupService']=new PaymentCleanupService();