'use strict';const a71_0x41646a=a71_0x263a;(function(_0x3ed4a7,_0x43381e){const _0xbe99ff=a71_0x263a,_0x38deea=_0x3ed4a7();while(!![]){try{const _0x12f81d=parseInt(_0xbe99ff(0x1ba))/0x1*(-parseInt(_0xbe99ff(0x16e))/0x2)+-parseInt(_0xbe99ff(0x150))/0x3*(parseInt(_0xbe99ff(0x181))/0x4)+parseInt(_0xbe99ff(0x163))/0x5*(parseInt(_0xbe99ff(0x169))/0x6)+parseInt(_0xbe99ff(0x179))/0x7+-parseInt(_0xbe99ff(0x1b5))/0x8+parseInt(_0xbe99ff(0x156))/0x9+parseInt(_0xbe99ff(0x18f))/0xa;if(_0x12f81d===_0x43381e)break;else _0x38deea['push'](_0x38deea['shift']());}catch(_0x5a9f1b){_0x38deea['push'](_0x38deea['shift']());}}}(a71_0x27fe,0x6d056));function a71_0x27fe(){const _0x15c1ac=['\x20\x20\x20Expired\x20(>\x205\x20days):\x20','PENDING','total','message','log','getDate','\x20\x20\x20âš ï¸\x20Errors\x20encountered:','PENDING\x20cleanup\x20service\x20error:\x20','logApiCall','FAILED','\x20days','system','6542664xlHraw','payment_cleanup','âœ…\x20PROCESSING\x20payments\x20processed:\x20','ðŸ§¹\x20Starting\x20cleanup\x20of\x20stale\x20PENDING\x20payments...','__importDefault','1BiMnEN','cleanupStalePendingPayments','ðŸ“Š\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20before\x20cleanup:','gateway','status','logWebhookProcessed','runCleanupWithReport','stale','â°\x20Processing\x20stale\x20PENDING\x20payment:\x20','cleanupStaleProcessingPayments','__esModule','getProcessingPaymentsStats','ðŸ”\x20Found\x20','./loggerService','POST','expired','Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20','ðŸ\x20PROCESSING\x20cleanup\x20completed','amount','\x20from\x20PROCESSING\x20to\x20FAILED','15kaRlFO','update','\x20failed\x20to\x20update','error','processed','fresh','4360248nAFYSO','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','\x20\x20\x20ðŸ“‰\x20Total\x20stale\x20payments\x20reduced\x20by:\x20','setDate','ðŸ“Š\x20','username','\x0aðŸ”„\x20Running\x20PROCESSING\x20payments\x20cleanup...','Failed\x20to\x20update\x20PENDING\x20payment\x20','push','PaymentStatus','payment','byAge','\x20stale\x20PROCESSING\x20payments','2330WozIUe','recent','Failed\x20to\x20get\x20processing\x20payments\x20stats:','Unknown\x20error','admin','ðŸ“Š\x20PENDING\x20payments\x20before\x20cleanup:\x20','2850PUIDts','âœ…\x20Updated\x20payment\x20','pending_payment_cleanup','@prisma/client','\x0aðŸ“Š\x20Stale\x20payments\x20(PROCESSING\x20+\x20PENDING)\x20after\x20cleanup:','1256514zbuhFG','errors','Cleanup\x20service\x20error:\x20','\x0aðŸ“ˆ\x20Cleanup\x20Summary:','getTime','\x20\x20\x20\x20\x20\x20','\x20\x20\x20â°\x20PENDING\x20â†’\x20EXPIRED:\x20','length','byStatus','failed','\x20payments\x20updated\x20to\x20EXPIRED,\x20','5438230Hvpuxj','findMany','PROCESSING','\x20\x20\x20Shop:\x20','now','loggerService','paymentCleanupService','auto_timeout','642364pdqExy','createdAt','Payment\x20timeout:\x20No\x20payment\x20action\x20received\x20for\x20','âœ…\x20No\x20stale\x20PROCESSING\x20payments\x20found','PaymentCleanupService','ðŸš€\x20Starting\x20PROCESSING\x20payments\x20cleanup\x20only...','\x20\x20\x20Age:\x20','byGateway','\x20\x20\x20Stale\x20(3-5\x20days):\x20','â±ï¸\x20Processing\x20stale\x20payment:\x20','Failed\x20to\x20update\x20payment\x20','floor','\x0aðŸ”„\x20Running\x20PENDING\x20payments\x20cleanup...','currency','12128830zhBrQq','EXPIRED','ðŸš€\x20Starting\x20payment\x20cleanup\x20service...','\x20\x20\x20By\x20status:','ðŸ\x20PENDING\x20cleanup\x20completed','\x20\x20\x20Recent\x20(1-3\x20days):\x20','PENDING_TIMEOUT_DAYS','\x20\x20\x20Total:\x20','\x20\x20\x20Created:\x20','shop','toISOString','logWebhookError','name','\x20stale\x20PENDING\x20payments','default','\x20payments\x20updated\x20to\x20FAILED,\x20','PENDING\x20cleanup\x20completed:\x20','\x20\x20\x20âœ…\x20Total\x20successfully\x20processed:\x20','âœ…\x20PENDING\x20payments\x20processed:\x20','PROCESSING_TIMEOUT_DAYS','auto_timeout_pending','ðŸ§¹\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...','ðŸ\x20Payment\x20cleanup\x20service\x20completed','ðŸ“…\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','ðŸ’¥\x20','forEach'];a71_0x27fe=function(){return _0x15c1ac;};return a71_0x27fe();}var __importDefault=this&&this[a71_0x41646a(0x1b9)]||function(_0x49c6c8){const _0x590c8e=a71_0x41646a;return _0x49c6c8&&_0x49c6c8[_0x590c8e(0x1c4)]?_0x49c6c8:{'default':_0x49c6c8};};function a71_0x263a(_0x321e23,_0x2f6695){_0x321e23=_0x321e23-0x150;const _0x27fe38=a71_0x27fe();let _0x263add=_0x27fe38[_0x321e23];return _0x263add;}Object['defineProperty'](exports,a71_0x41646a(0x1c4),{'value':!![]}),exports[a71_0x41646a(0x17f)]=exports[a71_0x41646a(0x185)]=void 0x0;const database_1=__importDefault(require('../config/database')),client_1=require(a71_0x41646a(0x16c)),loggerService_1=require(a71_0x41646a(0x1c7));class PaymentCleanupService{constructor(){this['PROCESSING_TIMEOUT_DAYS']=0x5,this['PENDING_TIMEOUT_DAYS']=0x5;}async[a71_0x41646a(0x1c3)](){const _0x5d763a=a71_0x41646a,_0x2db474=[];let _0x319317=0x0,_0x2990b1=0x0;try{console[_0x5d763a(0x1ad)](_0x5d763a(0x1a4));const _0x1f26b3=new Date();_0x1f26b3[_0x5d763a(0x159)](_0x1f26b3[_0x5d763a(0x1ae)]()-this['PROCESSING_TIMEOUT_DAYS']),console[_0x5d763a(0x1ad)](_0x5d763a(0x1a6)+_0x1f26b3[_0x5d763a(0x199)]());const _0x2fd34f=await database_1[_0x5d763a(0x19d)]['payment'][_0x5d763a(0x17a)]({'where':{'status':client_1[_0x5d763a(0x15f)][_0x5d763a(0x17b)],'createdAt':{'lt':_0x1f26b3}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x5d763a(0x1ad)]('ðŸ”\x20Found\x20'+_0x2fd34f[_0x5d763a(0x175)]+_0x5d763a(0x162));if(_0x2fd34f[_0x5d763a(0x175)]===0x0)return console[_0x5d763a(0x1ad)](_0x5d763a(0x184)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x5767d5 of _0x2fd34f){try{console[_0x5d763a(0x1ad)](_0x5d763a(0x18a)+_0x5767d5['id']+'\x20('+_0x5767d5[_0x5d763a(0x1bd)]+',\x20'+_0x5767d5[_0x5d763a(0x1cc)]+'\x20'+_0x5767d5[_0x5d763a(0x18e)]+')'),console[_0x5d763a(0x1ad)](_0x5d763a(0x17c)+_0x5767d5[_0x5d763a(0x198)][_0x5d763a(0x19b)]+'\x20('+_0x5767d5[_0x5d763a(0x198)][_0x5d763a(0x15b)]+')'),console[_0x5d763a(0x1ad)]('\x20\x20\x20Created:\x20'+_0x5767d5[_0x5d763a(0x182)][_0x5d763a(0x199)]()),console[_0x5d763a(0x1ad)](_0x5d763a(0x187)+Math[_0x5d763a(0x18c)]((Date['now']()-_0x5767d5[_0x5d763a(0x182)][_0x5d763a(0x172)]())/(0x3e8*0x3c*0x3c*0x18))+_0x5d763a(0x1b3));const _0x2079ef=await database_1[_0x5d763a(0x19d)]['payment'][_0x5d763a(0x151)]({'where':{'id':_0x5767d5['id']},'data':{'status':client_1[_0x5d763a(0x15f)][_0x5d763a(0x1b2)],'statusChangedBy':_0x5d763a(0x1b4),'statusChangedAt':new Date(),'failureMessage':_0x5d763a(0x157)+this[_0x5d763a(0x1a2)]+_0x5d763a(0x1b3)}});console['log']('âœ…\x20Updated\x20payment\x20'+_0x5767d5['id']+_0x5d763a(0x1cd)),loggerService_1['loggerService'][_0x5d763a(0x1bf)](_0x5767d5['gateway'],_0x5767d5['id'],_0x5d763a(0x17b),_0x5d763a(0x1b2),{'reason':_0x5d763a(0x180),'timeoutDays':this[_0x5d763a(0x1a2)]}),_0x319317++;}catch(_0x5ca43c){const _0x4ca7a7=_0x5d763a(0x18b)+_0x5767d5['id']+':\x20'+(_0x5ca43c instanceof Error?_0x5ca43c[_0x5d763a(0x1ac)]:_0x5d763a(0x166));console[_0x5d763a(0x153)]('âŒ\x20'+_0x4ca7a7),_0x2db474['push'](_0x4ca7a7),_0x2990b1++;}}const _0x491d62='Cleanup\x20completed:\x20'+_0x319317+_0x5d763a(0x19e)+_0x2990b1+_0x5d763a(0x152);return console[_0x5d763a(0x1ad)](_0x5d763a(0x15a)+_0x491d62),loggerService_1[_0x5d763a(0x17e)][_0x5d763a(0x1b1)]('payment_cleanup','POST','system',_0x5d763a(0x167),{'processed':_0x319317,'failed':_0x2990b1,'errors':_0x2db474,'timeoutDays':this[_0x5d763a(0x1a2)]}),{'processed':_0x319317,'failed':_0x2990b1,'errors':_0x2db474};}catch(_0x2a21a0){const _0x4677b4=_0x5d763a(0x170)+(_0x2a21a0 instanceof Error?_0x2a21a0['message']:_0x5d763a(0x166));return console[_0x5d763a(0x153)](_0x5d763a(0x1a7)+_0x4677b4),_0x2db474[_0x5d763a(0x15e)](_0x4677b4),loggerService_1[_0x5d763a(0x17e)]['logWebhookError'](_0x5d763a(0x1b6),_0x4677b4,{'timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),{'processed':_0x319317,'failed':_0x2990b1,'errors':_0x2db474};}}async[a71_0x41646a(0x1bb)](){const _0x30f954=a71_0x41646a,_0x597c68=[];let _0x344225=0x0,_0x19d5bb=0x0;try{console['log'](_0x30f954(0x1b8));const _0x46d005=new Date();_0x46d005[_0x30f954(0x159)](_0x46d005[_0x30f954(0x1ae)]()-this[_0x30f954(0x195)]),console[_0x30f954(0x1ad)]('ðŸ“…\x20Looking\x20for\x20PENDING\x20payments\x20older\x20than:\x20'+_0x46d005[_0x30f954(0x199)]());const _0x49a826=await database_1['default'][_0x30f954(0x160)][_0x30f954(0x17a)]({'where':{'status':client_1[_0x30f954(0x15f)]['PENDING'],'createdAt':{'lt':_0x46d005}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console[_0x30f954(0x1ad)](_0x30f954(0x1c6)+_0x49a826[_0x30f954(0x175)]+_0x30f954(0x19c));if(_0x49a826[_0x30f954(0x175)]===0x0)return console[_0x30f954(0x1ad)]('âœ…\x20No\x20stale\x20PENDING\x20payments\x20found'),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x542a80 of _0x49a826){try{console[_0x30f954(0x1ad)](_0x30f954(0x1c2)+_0x542a80['id']+'\x20('+_0x542a80['gateway']+',\x20'+_0x542a80[_0x30f954(0x1cc)]+'\x20'+_0x542a80[_0x30f954(0x18e)]+')'),console['log'](_0x30f954(0x17c)+_0x542a80[_0x30f954(0x198)]['name']+'\x20('+_0x542a80['shop']['username']+')'),console['log'](_0x30f954(0x197)+_0x542a80[_0x30f954(0x182)][_0x30f954(0x199)]()),console[_0x30f954(0x1ad)](_0x30f954(0x187)+Math[_0x30f954(0x18c)]((Date[_0x30f954(0x17d)]()-_0x542a80[_0x30f954(0x182)][_0x30f954(0x172)]())/(0x3e8*0x3c*0x3c*0x18))+'\x20days');const _0x47e526=await database_1[_0x30f954(0x19d)][_0x30f954(0x160)][_0x30f954(0x151)]({'where':{'id':_0x542a80['id']},'data':{'status':client_1[_0x30f954(0x15f)][_0x30f954(0x190)],'statusChangedBy':'system','statusChangedAt':new Date(),'failureMessage':_0x30f954(0x183)+this[_0x30f954(0x195)]+'\x20days'}});console['log'](_0x30f954(0x16a)+_0x542a80['id']+'\x20from\x20PENDING\x20to\x20EXPIRED'),loggerService_1[_0x30f954(0x17e)][_0x30f954(0x1bf)](_0x542a80[_0x30f954(0x1bd)],_0x542a80['id'],_0x30f954(0x1aa),_0x30f954(0x190),{'reason':_0x30f954(0x1a3),'timeoutDays':this['PENDING_TIMEOUT_DAYS']}),_0x344225++;}catch(_0x55582c){const _0x4016d2=_0x30f954(0x15d)+_0x542a80['id']+':\x20'+(_0x55582c instanceof Error?_0x55582c[_0x30f954(0x1ac)]:_0x30f954(0x166));console[_0x30f954(0x153)]('âŒ\x20'+_0x4016d2),_0x597c68['push'](_0x4016d2),_0x19d5bb++;}}const _0x57b11c=_0x30f954(0x19f)+_0x344225+_0x30f954(0x178)+_0x19d5bb+_0x30f954(0x152);return console['log'](_0x30f954(0x15a)+_0x57b11c),loggerService_1['loggerService'][_0x30f954(0x1b1)](_0x30f954(0x16b),_0x30f954(0x1c8),_0x30f954(0x1b4),_0x30f954(0x167),{'processed':_0x344225,'failed':_0x19d5bb,'errors':_0x597c68,'timeoutDays':this[_0x30f954(0x195)]}),{'processed':_0x344225,'failed':_0x19d5bb,'errors':_0x597c68};}catch(_0x24702a){const _0xd2f1fc=_0x30f954(0x1b0)+(_0x24702a instanceof Error?_0x24702a[_0x30f954(0x1ac)]:_0x30f954(0x166));return console[_0x30f954(0x153)](_0x30f954(0x1a7)+_0xd2f1fc),_0x597c68['push'](_0xd2f1fc),loggerService_1[_0x30f954(0x17e)][_0x30f954(0x19a)]('pending_payment_cleanup',_0xd2f1fc,{'timeoutDays':this[_0x30f954(0x195)]}),{'processed':_0x344225,'failed':_0x19d5bb,'errors':_0x597c68};}}async[a71_0x41646a(0x1c5)](){const _0x2b3423=a71_0x41646a;try{const _0xb0aaee=new Date(),_0x4c9912=new Date(_0xb0aaee[_0x2b3423(0x172)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x2bb2d8=new Date(_0xb0aaee['getTime']()-0x3*0x18*0x3c*0x3c*0x3e8),_0x44c9e1=new Date(_0xb0aaee[_0x2b3423(0x172)]()-0x5*0x18*0x3c*0x3c*0x3e8),_0x319016=await database_1['default'][_0x2b3423(0x160)][_0x2b3423(0x17a)]({'where':{'status':{'in':[client_1[_0x2b3423(0x15f)][_0x2b3423(0x17b)],client_1[_0x2b3423(0x15f)]['PENDING']]}},'select':{'id':!![],'gateway':!![],'status':!![],'createdAt':!![]}}),_0x178bcc={'total':_0x319016[_0x2b3423(0x175)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{},'byStatus':{}};for(const _0xda61d8 of _0x319016){if(_0xda61d8['createdAt']>_0x4c9912)_0x178bcc['byAge'][_0x2b3423(0x155)]++;else{if(_0xda61d8[_0x2b3423(0x182)]>_0x2bb2d8)_0x178bcc['byAge'][_0x2b3423(0x164)]++;else _0xda61d8[_0x2b3423(0x182)]>_0x44c9e1?_0x178bcc['byAge']['stale']++:_0x178bcc[_0x2b3423(0x161)]['expired']++;}!_0x178bcc[_0x2b3423(0x188)][_0xda61d8['gateway']]&&(_0x178bcc['byGateway'][_0xda61d8[_0x2b3423(0x1bd)]]=0x0);_0x178bcc[_0x2b3423(0x188)][_0xda61d8[_0x2b3423(0x1bd)]]++;const _0x534735=_0xda61d8[_0x2b3423(0x1be)];!_0x178bcc[_0x2b3423(0x176)][_0x534735]&&(_0x178bcc[_0x2b3423(0x176)][_0x534735]=0x0),_0x178bcc[_0x2b3423(0x176)][_0x534735]++;}return _0x178bcc;}catch(_0x2d669f){console[_0x2b3423(0x153)](_0x2b3423(0x165),_0x2d669f);throw new Error(_0x2b3423(0x1ca)+(_0x2d669f instanceof Error?_0x2d669f[_0x2b3423(0x1ac)]:'Unknown\x20error'));}}async[a71_0x41646a(0x1c0)](){const _0x470c97=a71_0x41646a;console[_0x470c97(0x1ad)](_0x470c97(0x191));const _0x2b3890=await this[_0x470c97(0x1c5)]();console[_0x470c97(0x1ad)](_0x470c97(0x1bc)),console['log'](_0x470c97(0x196)+_0x2b3890['total']),console['log']('\x20\x20\x20Fresh\x20(<\x201\x20day):\x20'+_0x2b3890[_0x470c97(0x161)][_0x470c97(0x155)]),console['log'](_0x470c97(0x194)+_0x2b3890['byAge'][_0x470c97(0x164)]),console['log'](_0x470c97(0x189)+_0x2b3890[_0x470c97(0x161)][_0x470c97(0x1c1)]),console[_0x470c97(0x1ad)](_0x470c97(0x1a9)+_0x2b3890[_0x470c97(0x161)][_0x470c97(0x1c9)]),console['log']('\x20\x20\x20By\x20gateway:',_0x2b3890['byGateway']),console[_0x470c97(0x1ad)](_0x470c97(0x192),_0x2b3890[_0x470c97(0x176)]),console['log'](_0x470c97(0x15c));const _0x5b0f14=await this[_0x470c97(0x1c3)]();console[_0x470c97(0x1ad)](_0x470c97(0x18d));const _0x123392=await this[_0x470c97(0x1bb)](),_0x371082=await this['getProcessingPaymentsStats']();console[_0x470c97(0x1ad)](_0x470c97(0x16d)),console['log'](_0x470c97(0x196)+_0x371082[_0x470c97(0x1ab)]),console[_0x470c97(0x1ad)](_0x470c97(0x1a9)+_0x371082[_0x470c97(0x161)][_0x470c97(0x1c9)]),console[_0x470c97(0x1ad)](_0x470c97(0x192),_0x371082[_0x470c97(0x176)]);const _0x5796e7=_0x5b0f14[_0x470c97(0x154)]+_0x123392['processed'],_0xffe53e=_0x5b0f14[_0x470c97(0x177)]+_0x123392[_0x470c97(0x177)],_0x404d41=[..._0x5b0f14[_0x470c97(0x16f)],..._0x123392[_0x470c97(0x16f)]];console['log'](_0x470c97(0x171)),console['log']('\x20\x20\x20ðŸ”„\x20PROCESSING\x20â†’\x20FAILED:\x20'+_0x5b0f14[_0x470c97(0x154)]),console['log'](_0x470c97(0x174)+_0x123392[_0x470c97(0x154)]),console[_0x470c97(0x1ad)](_0x470c97(0x1a0)+_0x5796e7),console[_0x470c97(0x1ad)]('\x20\x20\x20âŒ\x20Total\x20failed\x20to\x20process:\x20'+_0xffe53e),console['log'](_0x470c97(0x158)+(_0x2b3890[_0x470c97(0x1ab)]-_0x371082['total'])),_0x404d41[_0x470c97(0x175)]>0x0&&(console['log'](_0x470c97(0x1af)),_0x404d41[_0x470c97(0x1a8)]((_0x1534af,_0x18b5dc)=>{const _0x8dc309=_0x470c97;console['log'](_0x8dc309(0x173)+(_0x18b5dc+0x1)+'.\x20'+_0x1534af);})),console[_0x470c97(0x1ad)](_0x470c97(0x1a5));}async['runProcessingCleanupOnly'](){const _0x3a7ea9=a71_0x41646a;console[_0x3a7ea9(0x1ad)](_0x3a7ea9(0x186));const _0x44d1c5=await this[_0x3a7ea9(0x1c5)](),_0x3948dc=_0x44d1c5[_0x3a7ea9(0x176)][_0x3a7ea9(0x17b)]||0x0;console['log']('ðŸ“Š\x20PROCESSING\x20payments\x20before\x20cleanup:\x20'+_0x3948dc);const _0x4154a5=await this['cleanupStaleProcessingPayments'](),_0x24ffa8=await this[_0x3a7ea9(0x1c5)](),_0x3f73cf=_0x24ffa8['byStatus'][_0x3a7ea9(0x17b)]||0x0;console[_0x3a7ea9(0x1ad)]('ðŸ“Š\x20PROCESSING\x20payments\x20after\x20cleanup:\x20'+_0x3f73cf),console['log'](_0x3a7ea9(0x1b7)+_0x4154a5[_0x3a7ea9(0x154)]),console[_0x3a7ea9(0x1ad)](_0x3a7ea9(0x1cb));}async['runPendingCleanupOnly'](){const _0x219221=a71_0x41646a;console['log']('ðŸš€\x20Starting\x20PENDING\x20payments\x20cleanup\x20only...');const _0x2e747d=await this['getProcessingPaymentsStats'](),_0x912691=_0x2e747d['byStatus'][_0x219221(0x1aa)]||0x0;console[_0x219221(0x1ad)](_0x219221(0x168)+_0x912691);const _0x56437e=await this[_0x219221(0x1bb)](),_0x272d48=await this[_0x219221(0x1c5)](),_0x41e67b=_0x272d48[_0x219221(0x176)][_0x219221(0x1aa)]||0x0;console[_0x219221(0x1ad)]('ðŸ“Š\x20PENDING\x20payments\x20after\x20cleanup:\x20'+_0x41e67b),console['log'](_0x219221(0x1a1)+_0x56437e[_0x219221(0x154)]),console[_0x219221(0x1ad)](_0x219221(0x193));}}exports[a71_0x41646a(0x185)]=PaymentCleanupService,exports[a71_0x41646a(0x17f)]=new PaymentCleanupService();