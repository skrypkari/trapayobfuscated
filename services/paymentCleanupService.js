'use strict';const a57_0x5b02c0=a57_0x4270;(function(_0x16278a,_0x465b08){const _0x1da9ab=a57_0x4270,_0x48a2ed=_0x16278a();while(!![]){try{const _0x2195ed=parseInt(_0x1da9ab(0x144))/0x1*(parseInt(_0x1da9ab(0x137))/0x2)+parseInt(_0x1da9ab(0x161))/0x3*(parseInt(_0x1da9ab(0x13b))/0x4)+-parseInt(_0x1da9ab(0x128))/0x5+-parseInt(_0x1da9ab(0x133))/0x6*(parseInt(_0x1da9ab(0x164))/0x7)+parseInt(_0x1da9ab(0x15d))/0x8+parseInt(_0x1da9ab(0x146))/0x9+parseInt(_0x1da9ab(0x16e))/0xa*(-parseInt(_0x1da9ab(0x16c))/0xb);if(_0x2195ed===_0x465b08)break;else _0x48a2ed['push'](_0x48a2ed['shift']());}catch(_0x1a499f){_0x48a2ed['push'](_0x48a2ed['shift']());}}}(a57_0x2045,0xa057c));function a57_0x2045(){const _0x38f9b5=['setDate','🚀\x20Starting\x20payment\x20cleanup\x20service...','\x20\x20\x20Stale\x20(3-5\x20days):\x20','shop','📊\x20PROCESSING\x20payments\x20before\x20cleanup:','✅\x20No\x20stale\x20PROCESSING\x20payments\x20found','11oBkKgX','error','9520780uQtUgC','__esModule','PaymentCleanupService','gateway','createdAt','update','📅\x20Looking\x20for\x20PROCESSING\x20payments\x20older\x20than:\x20','total','logApiCall','payment_cleanup','\x20from\x20PROCESSING\x20to\x20FAILED','Cleanup\x20service\x20error:\x20','processed','\x20\x20\x20Recent\x20(1-3\x20days):\x20','stale','5215590XFklrp','length','loggerService','📈\x20Cleanup\x20Summary:','@prisma/client','now','Payment\x20timeout:\x20No\x20status\x20update\x20received\x20for\x20','\x20\x20\x20✅\x20Successfully\x20processed:\x20','../config/database','\x20days','default','69912uiHYVL','message','🔍\x20Found\x20','✅\x20Updated\x20payment\x20','754678MgOBnk','name','\x20\x20\x20Fresh\x20(<\x201\x20day):\x20','findMany','4uuIsyh','\x20\x20\x20Expired\x20(>\x205\x20days):\x20','system','paymentCleanupService','PROCESSING_TIMEOUT_DAYS','Unknown\x20error','currency','fresh','PROCESSING','3VpsoIH','\x20\x20\x20Created:\x20','4152402tBfCcE','PaymentStatus','Cleanup\x20completed:\x20','payment','FAILED','toISOString','⏱️\x20Processing\x20stale\x20payment:\x20','byGateway','Failed\x20to\x20update\x20payment\x20','getProcessingPaymentsStats','log','cleanupStaleProcessingPayments','defineProperty','logWebhookError','__importDefault','push','Failed\x20to\x20get\x20processing\x20payments\x20stats:\x20','username','💥\x20','errors','amount','expired','\x20\x20\x20Shop:\x20','8002552adrXsq','\x20\x20\x20Total:\x20','\x20failed\x20to\x20update','failed','2237142KpJmHa','byAge','getTime','413MXuLXA','🏁\x20Payment\x20cleanup\x20service\x20completed'];a57_0x2045=function(){return _0x38f9b5;};return a57_0x2045();}var __importDefault=this&&this[a57_0x5b02c0(0x154)]||function(_0x31654c){return _0x31654c&&_0x31654c['__esModule']?_0x31654c:{'default':_0x31654c};};Object[a57_0x5b02c0(0x152)](exports,a57_0x5b02c0(0x16f),{'value':!![]}),exports[a57_0x5b02c0(0x13e)]=exports['PaymentCleanupService']=void 0x0;const database_1=__importDefault(require(a57_0x5b02c0(0x130))),client_1=require(a57_0x5b02c0(0x12c)),loggerService_1=require('./loggerService');function a57_0x4270(_0x38ec60,_0x18c2fe){const _0x2045dd=a57_0x2045();return a57_0x4270=function(_0x4270c7,_0x34ad6a){_0x4270c7=_0x4270c7-0x11b;let _0x50def1=_0x2045dd[_0x4270c7];return _0x50def1;},a57_0x4270(_0x38ec60,_0x18c2fe);}class PaymentCleanupService{constructor(){const _0x2f3c8a=a57_0x5b02c0;this[_0x2f3c8a(0x13f)]=0x5;}async[a57_0x5b02c0(0x151)](){const _0x144399=a57_0x5b02c0,_0x4a4f91=[];let _0x1f7f35=0x0,_0x4b93d7=0x0;try{console['log']('🧹\x20Starting\x20cleanup\x20of\x20stale\x20PROCESSING\x20payments...');const _0x2ae33c=new Date();_0x2ae33c[_0x144399(0x166)](_0x2ae33c['getDate']()-this[_0x144399(0x13f)]),console[_0x144399(0x150)](_0x144399(0x11f)+_0x2ae33c[_0x144399(0x14b)]());const _0x48a43d=await database_1[_0x144399(0x132)]['payment']['findMany']({'where':{'status':client_1[_0x144399(0x147)][_0x144399(0x143)],'createdAt':{'lt':_0x2ae33c}},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});console['log'](_0x144399(0x135)+_0x48a43d['length']+'\x20stale\x20PROCESSING\x20payments');if(_0x48a43d[_0x144399(0x129)]===0x0)return console[_0x144399(0x150)](_0x144399(0x16b)),{'processed':0x0,'failed':0x0,'errors':[]};for(const _0x2451c5 of _0x48a43d){try{console[_0x144399(0x150)](_0x144399(0x14c)+_0x2451c5['id']+'\x20('+_0x2451c5['gateway']+',\x20'+_0x2451c5[_0x144399(0x15a)]+'\x20'+_0x2451c5[_0x144399(0x141)]+')'),console[_0x144399(0x150)](_0x144399(0x15c)+_0x2451c5['shop'][_0x144399(0x138)]+'\x20('+_0x2451c5[_0x144399(0x169)][_0x144399(0x157)]+')'),console[_0x144399(0x150)](_0x144399(0x145)+_0x2451c5[_0x144399(0x11d)][_0x144399(0x14b)]()),console[_0x144399(0x150)]('\x20\x20\x20Age:\x20'+Math['floor']((Date[_0x144399(0x12d)]()-_0x2451c5['createdAt'][_0x144399(0x163)]())/(0x3e8*0x3c*0x3c*0x18))+_0x144399(0x131));const _0xe9d88c=await database_1[_0x144399(0x132)][_0x144399(0x149)][_0x144399(0x11e)]({'where':{'id':_0x2451c5['id']},'data':{'status':client_1['PaymentStatus'][_0x144399(0x14a)],'statusChangedBy':_0x144399(0x13d),'statusChangedAt':new Date(),'adminNotes':'Automatically\x20failed\x20due\x20to\x20being\x20in\x20PROCESSING\x20status\x20for\x20more\x20than\x20'+this[_0x144399(0x13f)]+_0x144399(0x131),'failureMessage':_0x144399(0x12e)+this[_0x144399(0x13f)]+_0x144399(0x131)}});console['log'](_0x144399(0x136)+_0x2451c5['id']+_0x144399(0x123)),loggerService_1['loggerService']['logWebhookProcessed'](_0x2451c5['gateway'],_0x2451c5['id'],_0x144399(0x143),_0x144399(0x14a),{'reason':'auto_timeout','timeoutDays':this['PROCESSING_TIMEOUT_DAYS']}),_0x1f7f35++;}catch(_0x38d85c){const _0x2bd340=_0x144399(0x14e)+_0x2451c5['id']+':\x20'+(_0x38d85c instanceof Error?_0x38d85c[_0x144399(0x134)]:_0x144399(0x140));console[_0x144399(0x16d)]('❌\x20'+_0x2bd340),_0x4a4f91[_0x144399(0x155)](_0x2bd340),_0x4b93d7++;}}const _0x189d9e=_0x144399(0x148)+_0x1f7f35+'\x20payments\x20updated\x20to\x20FAILED,\x20'+_0x4b93d7+_0x144399(0x15f);return console[_0x144399(0x150)]('📊\x20'+_0x189d9e),loggerService_1[_0x144399(0x12a)][_0x144399(0x121)](_0x144399(0x122),'POST','system','admin',{'processed':_0x1f7f35,'failed':_0x4b93d7,'errors':_0x4a4f91,'timeoutDays':this[_0x144399(0x13f)]}),{'processed':_0x1f7f35,'failed':_0x4b93d7,'errors':_0x4a4f91};}catch(_0x1f2ff5){const _0x5212bf=_0x144399(0x124)+(_0x1f2ff5 instanceof Error?_0x1f2ff5[_0x144399(0x134)]:'Unknown\x20error');return console[_0x144399(0x16d)](_0x144399(0x158)+_0x5212bf),_0x4a4f91[_0x144399(0x155)](_0x5212bf),loggerService_1[_0x144399(0x12a)][_0x144399(0x153)]('payment_cleanup',_0x5212bf,{'timeoutDays':this[_0x144399(0x13f)]}),{'processed':_0x1f7f35,'failed':_0x4b93d7,'errors':_0x4a4f91};}}async[a57_0x5b02c0(0x14f)](){const _0x2e2481=a57_0x5b02c0;try{const _0x2f917e=new Date(),_0x4526aa=new Date(_0x2f917e[_0x2e2481(0x163)]()-0x1*0x18*0x3c*0x3c*0x3e8),_0x28cad8=new Date(_0x2f917e['getTime']()-0x3*0x18*0x3c*0x3c*0x3e8),_0x20cfe4=new Date(_0x2f917e['getTime']()-0x5*0x18*0x3c*0x3c*0x3e8),_0x2b0293=await database_1[_0x2e2481(0x132)][_0x2e2481(0x149)][_0x2e2481(0x13a)]({'where':{'status':client_1[_0x2e2481(0x147)][_0x2e2481(0x143)]},'select':{'id':!![],'gateway':!![],'createdAt':!![]}}),_0x27bee8={'total':_0x2b0293[_0x2e2481(0x129)],'byAge':{'fresh':0x0,'recent':0x0,'stale':0x0,'expired':0x0},'byGateway':{}};for(const _0x7a0e92 of _0x2b0293){if(_0x7a0e92['createdAt']>_0x4526aa)_0x27bee8[_0x2e2481(0x162)][_0x2e2481(0x142)]++;else{if(_0x7a0e92[_0x2e2481(0x11d)]>_0x28cad8)_0x27bee8['byAge']['recent']++;else _0x7a0e92[_0x2e2481(0x11d)]>_0x20cfe4?_0x27bee8[_0x2e2481(0x162)][_0x2e2481(0x127)]++:_0x27bee8[_0x2e2481(0x162)][_0x2e2481(0x15b)]++;}!_0x27bee8[_0x2e2481(0x14d)][_0x7a0e92[_0x2e2481(0x11c)]]&&(_0x27bee8['byGateway'][_0x7a0e92[_0x2e2481(0x11c)]]=0x0),_0x27bee8[_0x2e2481(0x14d)][_0x7a0e92['gateway']]++;}return _0x27bee8;}catch(_0x2c96e9){console[_0x2e2481(0x16d)]('Failed\x20to\x20get\x20processing\x20payments\x20stats:',_0x2c96e9);throw new Error(_0x2e2481(0x156)+(_0x2c96e9 instanceof Error?_0x2c96e9[_0x2e2481(0x134)]:_0x2e2481(0x140)));}}async['runCleanupWithReport'](){const _0x480db5=a57_0x5b02c0;console['log'](_0x480db5(0x167));const _0x83f343=await this[_0x480db5(0x14f)]();console[_0x480db5(0x150)](_0x480db5(0x16a)),console['log'](_0x480db5(0x15e)+_0x83f343[_0x480db5(0x120)]),console[_0x480db5(0x150)](_0x480db5(0x139)+_0x83f343[_0x480db5(0x162)][_0x480db5(0x142)]),console[_0x480db5(0x150)](_0x480db5(0x126)+_0x83f343['byAge']['recent']),console[_0x480db5(0x150)](_0x480db5(0x168)+_0x83f343[_0x480db5(0x162)][_0x480db5(0x127)]),console['log'](_0x480db5(0x13c)+_0x83f343[_0x480db5(0x162)][_0x480db5(0x15b)]),console['log']('\x20\x20\x20By\x20gateway:',_0x83f343[_0x480db5(0x14d)]);const _0x518c5d=await this['cleanupStaleProcessingPayments'](),_0x42592d=await this[_0x480db5(0x14f)]();console[_0x480db5(0x150)]('📊\x20PROCESSING\x20payments\x20after\x20cleanup:'),console[_0x480db5(0x150)](_0x480db5(0x15e)+_0x42592d[_0x480db5(0x120)]),console[_0x480db5(0x150)](_0x480db5(0x13c)+_0x42592d[_0x480db5(0x162)][_0x480db5(0x15b)]),console[_0x480db5(0x150)](_0x480db5(0x12b)),console['log'](_0x480db5(0x12f)+_0x518c5d[_0x480db5(0x125)]),console['log']('\x20\x20\x20❌\x20Failed\x20to\x20process:\x20'+_0x518c5d[_0x480db5(0x160)]),console['log']('\x20\x20\x20📉\x20Total\x20PROCESSING\x20payments\x20reduced\x20by:\x20'+(_0x83f343['total']-_0x42592d[_0x480db5(0x120)])),_0x518c5d['errors'][_0x480db5(0x129)]>0x0&&(console[_0x480db5(0x150)]('\x20\x20\x20⚠️\x20Errors\x20encountered:'),_0x518c5d[_0x480db5(0x159)]['forEach']((_0x32d1d4,_0x4ed850)=>{console['log']('\x20\x20\x20\x20\x20\x20'+(_0x4ed850+0x1)+'.\x20'+_0x32d1d4);})),console[_0x480db5(0x150)](_0x480db5(0x165));}}exports[a57_0x5b02c0(0x11b)]=PaymentCleanupService,exports[a57_0x5b02c0(0x13e)]=new PaymentCleanupService();