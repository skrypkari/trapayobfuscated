'use strict';function a47_0x33af(){const _0x397926=['create','updateNotifications','notificationRefund','findUnique','default','updateWebhookSettings','ensureSettingsExist','Shop\x20not\x20found','notificationPaymentSuccess','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','login','parseWebhookEvents','telegramBotApiKey','3662560qrUrAw','607719QwLKTH','updateTelegramSettings','210500boVuRh','payment_success','3eSgure','shop','refund','notificationApiError','hex','settings','284415vDOsub','hash','api_error','6fCTBBh','parse','compare','notificationPaymentFailed','2840310hNVDwe','length','shopSettings','SettingsService','toString','isArray','crypto','botApiKey','chatId','repeat','webhookEvents','changePassword','__esModule','1519526vRsqMS','1EJiHLf','maskApiKey','__importDefault','notificationLogin','string','1922644nTkhxF','webhookUrl','Current\x20password\x20is\x20incorrect','substring','randomBytes','telegram','bcryptjs','update','defineProperty','616uNhLxm','password','payment_failed','telegramChatId'];a47_0x33af=function(){return _0x397926;};return a47_0x33af();}function a47_0x26da(_0x7d9ce1,_0x1b9206){const _0x33af0d=a47_0x33af();return a47_0x26da=function(_0x26da28,_0xc3fea3){_0x26da28=_0x26da28-0x139;let _0x35587b=_0x33af0d[_0x26da28];return _0x35587b;},a47_0x26da(_0x7d9ce1,_0x1b9206);}const a47_0x2fa584=a47_0x26da;(function(_0x3cb298,_0x44c4c4){const _0x418014=a47_0x26da,_0x2c60e4=_0x3cb298();while(!![]){try{const _0x2590ed=-parseInt(_0x418014(0x16f))/0x1*(-parseInt(_0x418014(0x16e))/0x2)+-parseInt(_0x418014(0x154))/0x3*(parseInt(_0x418014(0x174))/0x4)+parseInt(_0x418014(0x15a))/0x5+parseInt(_0x418014(0x15d))/0x6*(-parseInt(_0x418014(0x150))/0x7)+-parseInt(_0x418014(0x14f))/0x8+-parseInt(_0x418014(0x161))/0x9+-parseInt(_0x418014(0x152))/0xa*(-parseInt(_0x418014(0x13e))/0xb);if(_0x2590ed===_0x44c4c4)break;else _0x2c60e4['push'](_0x2c60e4['shift']());}catch(_0x150995){_0x2c60e4['push'](_0x2c60e4['shift']());}}}(a47_0x33af,0x9fcde));var __importDefault=this&&this[a47_0x2fa584(0x171)]||function(_0x11fdb6){const _0x2810b6=a47_0x2fa584;return _0x11fdb6&&_0x11fdb6[_0x2810b6(0x16d)]?_0x11fdb6:{'default':_0x11fdb6};};Object[a47_0x2fa584(0x13d)](exports,a47_0x2fa584(0x16d),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x2fa584(0x13b))),crypto_1=__importDefault(require(a47_0x2fa584(0x167))),database_1=__importDefault(require('../config/database'));class SettingsService{[a47_0x2fa584(0x170)](_0x3b9a69){const _0x491152=a47_0x2fa584;if(!_0x3b9a69)return'';if(_0x3b9a69[_0x491152(0x162)]<=0x8)return _0x3b9a69;const _0x5d03a0=_0x3b9a69[_0x491152(0x177)](0x0,0x8),_0x379c15='*'[_0x491152(0x16a)](Math['max'](0x0,_0x3b9a69[_0x491152(0x162)]-0x8));return _0x5d03a0+_0x379c15;}[a47_0x2fa584(0x14d)](_0x44887f){const _0x58c730=a47_0x2fa584;if(!_0x44887f)return[];if(Array[_0x58c730(0x166)](_0x44887f))return _0x44887f;if(typeof _0x44887f===_0x58c730(0x173))try{const _0x57b423=JSON[_0x58c730(0x15e)](_0x44887f);return Array[_0x58c730(0x166)](_0x57b423)?_0x57b423:[];}catch{return[];}return[];}async['getShopSettings'](_0xcc92f6){const _0x40a44e=a47_0x2fa584,_0x4c9f1d=await database_1[_0x40a44e(0x146)][_0x40a44e(0x155)][_0x40a44e(0x145)]({'where':{'id':_0xcc92f6},'include':{'settings':!![]}});if(!_0x4c9f1d)throw new Error(_0x40a44e(0x149));let _0x2ede90=_0x4c9f1d[_0x40a44e(0x159)];return!_0x2ede90&&(_0x2ede90=await database_1[_0x40a44e(0x146)][_0x40a44e(0x163)][_0x40a44e(0x142)]({'data':{'shopId':_0x4c9f1d['id']}})),{'fullName':_0x4c9f1d['name'],'brand':_0x4c9f1d['name'],'merchantUrl':_0x4c9f1d['shopUrl'],'telegramUsername':_0x4c9f1d[_0x40a44e(0x13a)],'telegramBotApiKey':_0x2ede90['telegramBotApiKey']?this[_0x40a44e(0x170)](_0x2ede90[_0x40a44e(0x14e)]):null,'telegramChatId':_0x2ede90[_0x40a44e(0x141)],'webhookUrl':_0x2ede90[_0x40a44e(0x175)],'webhookEvents':this['parseWebhookEvents'](_0x2ede90[_0x40a44e(0x16b)]),'notifications':{'payment_success':_0x2ede90[_0x40a44e(0x14a)],'payment_failed':_0x2ede90[_0x40a44e(0x160)],'refund':_0x2ede90[_0x40a44e(0x144)],'payout':_0x2ede90['notificationPayout'],'login':_0x2ede90[_0x40a44e(0x172)],'api_error':_0x2ede90[_0x40a44e(0x157)]}};}async[a47_0x2fa584(0x16c)](_0x4730a6,_0x4560a5){const _0x20ddfb=a47_0x2fa584,{currentPassword:_0x3aee46,newPassword:_0x4805a2,confirmNewPassword:_0x7249b6}=_0x4560a5;if(_0x4805a2!==_0x7249b6)throw new Error(_0x20ddfb(0x14b));if(_0x4805a2[_0x20ddfb(0x162)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x4f24a1=await database_1[_0x20ddfb(0x146)][_0x20ddfb(0x155)][_0x20ddfb(0x145)]({'where':{'id':_0x4730a6},'select':{'password':!![]}});if(!_0x4f24a1)throw new Error(_0x20ddfb(0x149));const _0x21a38a=await bcryptjs_1['default']['compare'](_0x3aee46,_0x4f24a1[_0x20ddfb(0x13f)]);if(!_0x21a38a)throw new Error(_0x20ddfb(0x176));const _0x161fe4=await bcryptjs_1[_0x20ddfb(0x146)][_0x20ddfb(0x15b)](_0x4805a2,0xc);await database_1[_0x20ddfb(0x146)][_0x20ddfb(0x155)]['update']({'where':{'id':_0x4730a6},'data':{'password':_0x161fe4}});}async[a47_0x2fa584(0x143)](_0x50d42f,_0x1623de){const _0x4b3bd7=a47_0x2fa584;await this[_0x4b3bd7(0x148)](_0x50d42f);const _0x547489={};_0x1623de[_0x4b3bd7(0x153)]!==undefined&&(_0x547489[_0x4b3bd7(0x14a)]=_0x1623de['payment_success']),_0x1623de[_0x4b3bd7(0x140)]!==undefined&&(_0x547489[_0x4b3bd7(0x160)]=_0x1623de[_0x4b3bd7(0x140)]),_0x1623de['refund']!==undefined&&(_0x547489[_0x4b3bd7(0x144)]=_0x1623de[_0x4b3bd7(0x156)]),_0x1623de['payout']!==undefined&&(_0x547489['notificationPayout']=_0x1623de['payout']),_0x1623de[_0x4b3bd7(0x14c)]!==undefined&&(_0x547489[_0x4b3bd7(0x172)]=_0x1623de[_0x4b3bd7(0x14c)]),_0x1623de[_0x4b3bd7(0x15c)]!==undefined&&(_0x547489[_0x4b3bd7(0x157)]=_0x1623de[_0x4b3bd7(0x15c)]),await database_1[_0x4b3bd7(0x146)][_0x4b3bd7(0x163)]['update']({'where':{'shopId':_0x50d42f},'data':_0x547489});}async[a47_0x2fa584(0x151)](_0x2b2a7f,_0x518de2){const _0xa26e45=a47_0x2fa584;await this[_0xa26e45(0x148)](_0x2b2a7f);const _0x326802={};_0x518de2[_0xa26e45(0x168)]!==undefined&&(_0x326802[_0xa26e45(0x14e)]=_0x518de2[_0xa26e45(0x168)]||null),_0x518de2[_0xa26e45(0x169)]!==undefined&&(_0x326802['telegramChatId']=_0x518de2['chatId']||null),await database_1[_0xa26e45(0x146)][_0xa26e45(0x163)]['update']({'where':{'shopId':_0x2b2a7f},'data':_0x326802});}async[a47_0x2fa584(0x147)](_0x17b3f0,_0x3336a7){const _0x424cf8=a47_0x2fa584;await this['ensureSettingsExist'](_0x17b3f0);const _0x4122e1={};_0x3336a7['webhookUrl']!==undefined&&(_0x4122e1['webhookUrl']=_0x3336a7[_0x424cf8(0x175)]||null),_0x3336a7['webhookEvents']!==undefined&&(_0x4122e1['webhookEvents']=_0x3336a7[_0x424cf8(0x16b)]||[]),await database_1[_0x424cf8(0x146)][_0x424cf8(0x163)][_0x424cf8(0x13c)]({'where':{'shopId':_0x17b3f0},'data':_0x4122e1});}async['revokeAllApiKeys'](_0x3fbaf6){const _0x2056c3=a47_0x2fa584,_0x16a816='pk_'+crypto_1[_0x2056c3(0x146)][_0x2056c3(0x139)](0x20)[_0x2056c3(0x165)](_0x2056c3(0x158)),_0x5bdf20='sk_'+crypto_1['default'][_0x2056c3(0x139)](0x20)[_0x2056c3(0x165)](_0x2056c3(0x158));await database_1[_0x2056c3(0x146)]['shop'][_0x2056c3(0x13c)]({'where':{'id':_0x3fbaf6},'data':{'publicKey':_0x16a816,'secretKey':_0x5bdf20}});}async['deleteAccount'](_0x43fd58,_0x294037){const _0x44ef00=a47_0x2fa584,{passwordConfirmation:_0x5cb4ec}=_0x294037,_0x4036fc=await database_1['default'][_0x44ef00(0x155)][_0x44ef00(0x145)]({'where':{'id':_0x43fd58},'select':{'password':!![]}});if(!_0x4036fc)throw new Error('Shop\x20not\x20found');const _0x1a1c39=await bcryptjs_1[_0x44ef00(0x146)][_0x44ef00(0x15f)](_0x5cb4ec,_0x4036fc[_0x44ef00(0x13f)]);if(!_0x1a1c39)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x44ef00(0x146)][_0x44ef00(0x155)]['delete']({'where':{'id':_0x43fd58}});}async['ensureSettingsExist'](_0x46d7e4){const _0xfb700e=a47_0x2fa584,_0xa38e78=await database_1[_0xfb700e(0x146)][_0xfb700e(0x163)][_0xfb700e(0x145)]({'where':{'shopId':_0x46d7e4}});!_0xa38e78&&await database_1['default'][_0xfb700e(0x163)][_0xfb700e(0x142)]({'data':{'shopId':_0x46d7e4}});}}exports[a47_0x2fa584(0x164)]=SettingsService;