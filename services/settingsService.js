'use strict';function a64_0x7eb8(_0x1aa43a,_0x5869e8){const _0x436abd=a64_0x436a();return a64_0x7eb8=function(_0x7eb87c,_0x248b7d){_0x7eb87c=_0x7eb87c-0xa3;let _0x6b123=_0x436abd[_0x7eb87c];return _0x6b123;},a64_0x7eb8(_0x1aa43a,_0x5869e8);}const a64_0x394ef3=a64_0x7eb8;(function(_0x250006,_0x1cf6b7){const _0xd2cc69=a64_0x7eb8,_0x357c6b=_0x250006();while(!![]){try{const _0x519ef8=parseInt(_0xd2cc69(0xd0))/0x1+-parseInt(_0xd2cc69(0xda))/0x2*(-parseInt(_0xd2cc69(0xdd))/0x3)+-parseInt(_0xd2cc69(0xcd))/0x4+parseInt(_0xd2cc69(0xb0))/0x5*(parseInt(_0xd2cc69(0xc8))/0x6)+-parseInt(_0xd2cc69(0xb5))/0x7*(parseInt(_0xd2cc69(0xca))/0x8)+parseInt(_0xd2cc69(0xcb))/0x9+parseInt(_0xd2cc69(0xaa))/0xa*(-parseInt(_0xd2cc69(0xd6))/0xb);if(_0x519ef8===_0x1cf6b7)break;else _0x357c6b['push'](_0x357c6b['shift']());}catch(_0x2b1643){_0x357c6b['push'](_0x357c6b['shift']());}}}(a64_0x436a,0xb8942));function a64_0x436a(){const _0x4f0c46=['refund','toString','isArray','update','updateTelegramSettings','updateWebhookSettings','notificationPayout','__esModule','notificationPaymentFailed','70udnYSk','SettingsService','deleteAccount','notificationLogin','changePassword','Current\x20password\x20is\x20incorrect','12590sLmSzo','__importDefault','parseWebhookEvents','getShopSettings','shopUrl','1799mnZmGN','shop','../config/database','webhookUrl','login','compare','telegramChatId','notificationApiError','telegram','ensureSettingsExist','maskApiKey','revokeAllApiKeys','webhookEvents','pk_','length','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','randomBytes','payout','crypto','3378SYcNko','default','30656iTrYDG','1551735SDIOHA','name','1886852czfXex','hash','shopSettings','1230076nrKrhy','hex','findUnique','notificationPaymentSuccess','repeat','Shop\x20not\x20found','3323551MEOUjT','payment_failed','settings','notificationRefund','298WDtfZk','payment_success','string','30351jouNAy','telegramBotApiKey','password'];a64_0x436a=function(){return _0x4f0c46;};return a64_0x436a();}var __importDefault=this&&this[a64_0x394ef3(0xb1)]||function(_0x429c17){const _0x980492=a64_0x394ef3;return _0x429c17&&_0x429c17[_0x980492(0xa8)]?_0x429c17:{'default':_0x429c17};};Object['defineProperty'](exports,a64_0x394ef3(0xa8),{'value':!![]}),exports[a64_0x394ef3(0xab)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a64_0x394ef3(0xc7))),database_1=__importDefault(require(a64_0x394ef3(0xb7)));class SettingsService{[a64_0x394ef3(0xbf)](_0x3d785d){const _0x5c57ee=a64_0x394ef3;if(!_0x3d785d)return'';if(_0x3d785d[_0x5c57ee(0xc3)]<=0x8)return _0x3d785d;const _0x5c297a=_0x3d785d['substring'](0x0,0x8),_0x4a63a2='*'[_0x5c57ee(0xd4)](Math['max'](0x0,_0x3d785d[_0x5c57ee(0xc3)]-0x8));return _0x5c297a+_0x4a63a2;}[a64_0x394ef3(0xb2)](_0x15dfe7){const _0x1a7823=a64_0x394ef3;if(!_0x15dfe7)return[];if(Array['isArray'](_0x15dfe7))return _0x15dfe7;if(typeof _0x15dfe7===_0x1a7823(0xdc))try{const _0x5ad491=JSON['parse'](_0x15dfe7);return Array[_0x1a7823(0xa3)](_0x5ad491)?_0x5ad491:[];}catch{return[];}return[];}async[a64_0x394ef3(0xb3)](_0x9e831){const _0x1c51d2=a64_0x394ef3,_0x4a8100=await database_1[_0x1c51d2(0xc9)][_0x1c51d2(0xb6)][_0x1c51d2(0xd2)]({'where':{'id':_0x9e831},'include':{'settings':!![]}});if(!_0x4a8100)throw new Error('Shop\x20not\x20found');let _0x5d2fb3=_0x4a8100[_0x1c51d2(0xd8)];return!_0x5d2fb3&&(_0x5d2fb3=await database_1[_0x1c51d2(0xc9)][_0x1c51d2(0xcf)]['create']({'data':{'shopId':_0x4a8100['id']}})),{'fullName':_0x4a8100[_0x1c51d2(0xcc)],'brand':_0x4a8100['name'],'merchantUrl':_0x4a8100[_0x1c51d2(0xb4)],'telegramUsername':_0x4a8100[_0x1c51d2(0xbd)],'telegramBotApiKey':_0x5d2fb3[_0x1c51d2(0xde)]?this['maskApiKey'](_0x5d2fb3[_0x1c51d2(0xde)]):null,'telegramChatId':_0x5d2fb3['telegramChatId'],'webhookUrl':_0x5d2fb3[_0x1c51d2(0xb8)],'webhookEvents':this['parseWebhookEvents'](_0x5d2fb3['webhookEvents']),'notifications':{'payment_success':_0x5d2fb3['notificationPaymentSuccess'],'payment_failed':_0x5d2fb3[_0x1c51d2(0xa9)],'refund':_0x5d2fb3['notificationRefund'],'payout':_0x5d2fb3[_0x1c51d2(0xa7)],'login':_0x5d2fb3[_0x1c51d2(0xad)],'api_error':_0x5d2fb3['notificationApiError']}};}async[a64_0x394ef3(0xae)](_0x32dd98,_0x1f842c){const _0x3ac49d=a64_0x394ef3,{currentPassword:_0x1f586f,newPassword:_0x2d59be,confirmNewPassword:_0x3bd0a8}=_0x1f842c;if(_0x2d59be!==_0x3bd0a8)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x2d59be['length']<0x6)throw new Error(_0x3ac49d(0xc4));const _0x509e3c=await database_1[_0x3ac49d(0xc9)][_0x3ac49d(0xb6)][_0x3ac49d(0xd2)]({'where':{'id':_0x32dd98},'select':{'password':!![]}});if(!_0x509e3c)throw new Error(_0x3ac49d(0xd5));const _0xbbddbc=await bcryptjs_1[_0x3ac49d(0xc9)][_0x3ac49d(0xba)](_0x1f586f,_0x509e3c[_0x3ac49d(0xdf)]);if(!_0xbbddbc)throw new Error(_0x3ac49d(0xaf));const _0x104af9=await bcryptjs_1[_0x3ac49d(0xc9)][_0x3ac49d(0xce)](_0x2d59be,0xc);await database_1['default'][_0x3ac49d(0xb6)]['update']({'where':{'id':_0x32dd98},'data':{'password':_0x104af9}});}async['updateNotifications'](_0x33b8f9,_0x59f945){const _0x4af3be=a64_0x394ef3;await this[_0x4af3be(0xbe)](_0x33b8f9);const _0x53b8d8={};_0x59f945[_0x4af3be(0xdb)]!==undefined&&(_0x53b8d8[_0x4af3be(0xd3)]=_0x59f945[_0x4af3be(0xdb)]),_0x59f945[_0x4af3be(0xd7)]!==undefined&&(_0x53b8d8[_0x4af3be(0xa9)]=_0x59f945[_0x4af3be(0xd7)]),_0x59f945['refund']!==undefined&&(_0x53b8d8[_0x4af3be(0xd9)]=_0x59f945[_0x4af3be(0xe0)]),_0x59f945[_0x4af3be(0xc6)]!==undefined&&(_0x53b8d8[_0x4af3be(0xa7)]=_0x59f945[_0x4af3be(0xc6)]),_0x59f945[_0x4af3be(0xb9)]!==undefined&&(_0x53b8d8['notificationLogin']=_0x59f945['login']),_0x59f945['api_error']!==undefined&&(_0x53b8d8[_0x4af3be(0xbc)]=_0x59f945['api_error']),await database_1['default']['shopSettings']['update']({'where':{'shopId':_0x33b8f9},'data':_0x53b8d8});}async[a64_0x394ef3(0xa5)](_0x293dc1,_0x2f0fc3){const _0x2c944c=a64_0x394ef3;await this[_0x2c944c(0xbe)](_0x293dc1);const _0x1ded72={};_0x2f0fc3['botApiKey']!==undefined&&(_0x1ded72[_0x2c944c(0xde)]=_0x2f0fc3['botApiKey']||null),_0x2f0fc3['chatId']!==undefined&&(_0x1ded72[_0x2c944c(0xbb)]=_0x2f0fc3['chatId']||null),await database_1[_0x2c944c(0xc9)]['shopSettings'][_0x2c944c(0xa4)]({'where':{'shopId':_0x293dc1},'data':_0x1ded72});}async[a64_0x394ef3(0xa6)](_0x4e249b,_0x5004ee){const _0x309c61=a64_0x394ef3;await this[_0x309c61(0xbe)](_0x4e249b);const _0x67c6e1={};_0x5004ee[_0x309c61(0xb8)]!==undefined&&(_0x67c6e1['webhookUrl']=_0x5004ee[_0x309c61(0xb8)]||null),_0x5004ee['webhookEvents']!==undefined&&(_0x67c6e1['webhookEvents']=_0x5004ee[_0x309c61(0xc1)]||[]),await database_1['default'][_0x309c61(0xcf)][_0x309c61(0xa4)]({'where':{'shopId':_0x4e249b},'data':_0x67c6e1});}async[a64_0x394ef3(0xc0)](_0x36cbe1){const _0x480c5a=a64_0x394ef3,_0x43b026=_0x480c5a(0xc2)+crypto_1[_0x480c5a(0xc9)][_0x480c5a(0xc5)](0x20)[_0x480c5a(0xe1)](_0x480c5a(0xd1)),_0x20a81d='sk_'+crypto_1[_0x480c5a(0xc9)][_0x480c5a(0xc5)](0x20)[_0x480c5a(0xe1)](_0x480c5a(0xd1));await database_1[_0x480c5a(0xc9)][_0x480c5a(0xb6)][_0x480c5a(0xa4)]({'where':{'id':_0x36cbe1},'data':{'publicKey':_0x43b026,'secretKey':_0x20a81d}});}async[a64_0x394ef3(0xac)](_0x734848,_0x36b4f8){const _0x12d49e=a64_0x394ef3,{passwordConfirmation:_0x9acbd2}=_0x36b4f8,_0x2b2524=await database_1[_0x12d49e(0xc9)]['shop'][_0x12d49e(0xd2)]({'where':{'id':_0x734848},'select':{'password':!![]}});if(!_0x2b2524)throw new Error(_0x12d49e(0xd5));const _0x26aa9e=await bcryptjs_1[_0x12d49e(0xc9)][_0x12d49e(0xba)](_0x9acbd2,_0x2b2524[_0x12d49e(0xdf)]);if(!_0x26aa9e)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x12d49e(0xc9)]['shop']['delete']({'where':{'id':_0x734848}});}async['ensureSettingsExist'](_0x49d5fa){const _0x5af67f=a64_0x394ef3,_0x561128=await database_1[_0x5af67f(0xc9)][_0x5af67f(0xcf)][_0x5af67f(0xd2)]({'where':{'shopId':_0x49d5fa}});!_0x561128&&await database_1[_0x5af67f(0xc9)][_0x5af67f(0xcf)]['create']({'data':{'shopId':_0x49d5fa}});}}exports['SettingsService']=SettingsService;