'use strict';const a85_0x59092d=a85_0x36c1;(function(_0x290c0a,_0x19b14e){const _0x48b4b7=a85_0x36c1,_0x152c54=_0x290c0a();while(!![]){try{const _0x15b1f6=parseInt(_0x48b4b7(0x14f))/0x1*(parseInt(_0x48b4b7(0x144))/0x2)+parseInt(_0x48b4b7(0x17d))/0x3*(-parseInt(_0x48b4b7(0x183))/0x4)+parseInt(_0x48b4b7(0x141))/0x5+parseInt(_0x48b4b7(0x155))/0x6*(parseInt(_0x48b4b7(0x174))/0x7)+-parseInt(_0x48b4b7(0x13a))/0x8+parseInt(_0x48b4b7(0x16c))/0x9+-parseInt(_0x48b4b7(0x185))/0xa;if(_0x15b1f6===_0x19b14e)break;else _0x152c54['push'](_0x152c54['shift']());}catch(_0x31d105){_0x152c54['push'](_0x152c54['shift']());}}}(a85_0x3bae,0x83343));var __importDefault=this&&this['__importDefault']||function(_0x32cce1){const _0x3e8ae1=a85_0x36c1;return _0x32cce1&&_0x32cce1[_0x3e8ae1(0x145)]?_0x32cce1:{'default':_0x32cce1};};function a85_0x36c1(_0x435410,_0x330ff6){_0x435410=_0x435410-0x133;const _0x3bae9a=a85_0x3bae();let _0x36c150=_0x3bae9a[_0x435410];return _0x36c150;}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a85_0x59092d(0x148)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a85_0x59092d(0x147))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a85_0x59092d(0x182)));class SettingsService{[a85_0x59092d(0x134)](_0x17daa2){const _0x2b623d=a85_0x59092d;if(!_0x17daa2)return'';if(_0x17daa2[_0x2b623d(0x13f)]<=0x8)return _0x17daa2;const _0x2af77a=_0x17daa2[_0x2b623d(0x150)](0x0,0x8),_0xc12b8c='*'[_0x2b623d(0x16a)](Math[_0x2b623d(0x156)](0x0,_0x17daa2[_0x2b623d(0x13f)]-0x8));return _0x2af77a+_0xc12b8c;}[a85_0x59092d(0x161)](_0xa27fa3){const _0x46a9a8=a85_0x59092d;if(!_0xa27fa3)return[];if(Array[_0x46a9a8(0x17f)](_0xa27fa3))return _0xa27fa3;if(typeof _0xa27fa3===_0x46a9a8(0x163))try{const _0x7f625=JSON[_0x46a9a8(0x176)](_0xa27fa3);return Array[_0x46a9a8(0x17f)](_0x7f625)?_0x7f625:[];}catch{return[];}return[];}async['getShopSettings'](_0x1e57f5){const _0x3a92c6=a85_0x59092d,_0x1b8b74=await database_1['default']['shop'][_0x3a92c6(0x172)]({'where':{'id':_0x1e57f5},'select':{'id':!![],'name':!![],'shopUrl':!![],'shopUrl2':!![],'shopUrl3':!![],'shopUrl4':!![],'telegram':!![],'twoFactorEnabled':!![],'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x1b8b74)throw new Error(_0x3a92c6(0x138));let _0x32023b=_0x1b8b74[_0x3a92c6(0x157)];return!_0x32023b&&(_0x32023b=await database_1[_0x3a92c6(0x154)][_0x3a92c6(0x14e)][_0x3a92c6(0x139)]({'data':{'shopId':_0x1b8b74['id']}})),{'fullName':_0x1b8b74['name'],'brand':_0x1b8b74[_0x3a92c6(0x167)],'merchantUrl':_0x1b8b74[_0x3a92c6(0x14c)],'merchantUrl2':_0x1b8b74[_0x3a92c6(0x140)],'merchantUrl3':_0x1b8b74[_0x3a92c6(0x143)],'merchantUrl4':_0x1b8b74[_0x3a92c6(0x142)],'telegramUsername':_0x1b8b74[_0x3a92c6(0x178)],'telegramBotApiKey':_0x32023b[_0x3a92c6(0x16b)]?this[_0x3a92c6(0x134)](_0x32023b['telegramBotApiKey']):null,'telegramChatId':_0x32023b[_0x3a92c6(0x15e)],'telegramUsersCount':_0x1b8b74['_count']['telegramUsers'],'webhookUrl':_0x32023b[_0x3a92c6(0x188)],'webhookEvents':this[_0x3a92c6(0x161)](_0x32023b['webhookEvents']),'twoFactorEnabled':_0x1b8b74['twoFactorEnabled']||![],'notifications':{'payment_success':_0x32023b['notificationPaymentSuccess'],'payment_failed':_0x32023b[_0x3a92c6(0x171)],'refund':_0x32023b[_0x3a92c6(0x15c)],'payout':_0x32023b['notificationPayout'],'login':_0x32023b[_0x3a92c6(0x160)],'api_error':_0x32023b[_0x3a92c6(0x187)]}};}async[a85_0x59092d(0x13e)](_0x22ed8c,_0x1c17fc){const _0x25526f=a85_0x59092d,{currentPassword:_0x2cfb8c,newPassword:_0x2f2197,confirmNewPassword:_0x538cd8,twoFactorToken:_0xe92dfe}=_0x1c17fc;if(_0x2f2197!==_0x538cd8)throw new Error(_0x25526f(0x166));if(_0x2f2197['length']<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x53a1fc=await database_1[_0x25526f(0x154)][_0x25526f(0x177)][_0x25526f(0x172)]({'where':{'id':_0x22ed8c},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x53a1fc)throw new Error(_0x25526f(0x138));if(_0x53a1fc[_0x25526f(0x180)]){if(!_0xe92dfe)throw new Error(_0x25526f(0x146));const _0x439cfa=speakeasy_1[_0x25526f(0x154)]['totp'][_0x25526f(0x158)]({'secret':_0x53a1fc[_0x25526f(0x16f)],'encoding':_0x25526f(0x17b),'token':_0xe92dfe,'window':0x2});if(!_0x439cfa){let _0x6a7011=![];if(_0x53a1fc[_0x25526f(0x15d)]){const _0x2f88b9=JSON[_0x25526f(0x176)](_0x53a1fc[_0x25526f(0x15d)]);for(let _0x3b8eae=0x0;_0x3b8eae<_0x2f88b9['length'];_0x3b8eae++){const _0x3b89bd=await bcryptjs_1[_0x25526f(0x154)]['compare'](_0xe92dfe,_0x2f88b9[_0x3b8eae]);if(_0x3b89bd){_0x6a7011=!![],_0x2f88b9[_0x25526f(0x168)](_0x3b8eae,0x1),await database_1[_0x25526f(0x154)][_0x25526f(0x177)][_0x25526f(0x15b)]({'where':{'id':_0x22ed8c},'data':{'backupCodes':JSON['stringify'](_0x2f88b9)}});break;}}}if(!_0x6a7011)throw new Error(_0x25526f(0x17c));}}const _0x82e971=await bcryptjs_1[_0x25526f(0x154)]['compare'](_0x2cfb8c,_0x53a1fc[_0x25526f(0x13c)]);if(!_0x82e971)throw new Error(_0x25526f(0x159));const _0x4a462e=await bcryptjs_1['default'][_0x25526f(0x169)](_0x2f2197,0xc);await database_1['default']['shop'][_0x25526f(0x15b)]({'where':{'id':_0x22ed8c},'data':{'password':_0x4a462e}});}async[a85_0x59092d(0x16d)](_0x21b1db,_0x5ae3b3){const _0xc236db=a85_0x59092d;await this['ensureSettingsExist'](_0x21b1db);const _0x198d2={};_0x5ae3b3[_0xc236db(0x15a)]!==undefined&&(_0x198d2[_0xc236db(0x173)]=_0x5ae3b3[_0xc236db(0x15a)]),_0x5ae3b3[_0xc236db(0x13b)]!==undefined&&(_0x198d2['notificationPaymentFailed']=_0x5ae3b3[_0xc236db(0x13b)]),_0x5ae3b3['refund']!==undefined&&(_0x198d2['notificationRefund']=_0x5ae3b3[_0xc236db(0x165)]),_0x5ae3b3['payout']!==undefined&&(_0x198d2[_0xc236db(0x136)]=_0x5ae3b3['payout']),_0x5ae3b3[_0xc236db(0x164)]!==undefined&&(_0x198d2[_0xc236db(0x160)]=_0x5ae3b3[_0xc236db(0x164)]),_0x5ae3b3[_0xc236db(0x16e)]!==undefined&&(_0x198d2[_0xc236db(0x187)]=_0x5ae3b3['api_error']),await database_1[_0xc236db(0x154)][_0xc236db(0x14e)]['update']({'where':{'shopId':_0x21b1db},'data':_0x198d2});}async[a85_0x59092d(0x135)](_0x53dd7b,_0x2c10bc){const _0x520465=a85_0x59092d;await this['ensureSettingsExist'](_0x53dd7b);const _0xca9605={};_0x2c10bc[_0x520465(0x17a)]!==undefined&&(_0xca9605['telegramBotApiKey']=_0x2c10bc[_0x520465(0x17a)]||null),_0x2c10bc['chatId']!==undefined&&(_0xca9605[_0x520465(0x15e)]=_0x2c10bc['chatId']||null),await database_1[_0x520465(0x154)]['shopSettings'][_0x520465(0x15b)]({'where':{'shopId':_0x53dd7b},'data':_0xca9605});}async['updateWebhookSettings'](_0x3f6deb,_0x48ea1e){const _0x18b848=a85_0x59092d;await this['ensureSettingsExist'](_0x3f6deb);const _0x267c63={};_0x48ea1e[_0x18b848(0x188)]!==undefined&&(_0x267c63['webhookUrl']=_0x48ea1e[_0x18b848(0x188)]||null),_0x48ea1e[_0x18b848(0x151)]!==undefined&&(_0x267c63[_0x18b848(0x151)]=_0x48ea1e['webhookEvents']||[]),await database_1[_0x18b848(0x154)][_0x18b848(0x14e)][_0x18b848(0x15b)]({'where':{'shopId':_0x3f6deb},'data':_0x267c63});}async[a85_0x59092d(0x186)](_0x35b924,_0xeb3b03){const _0x3e2c2e=a85_0x59092d,_0x217cb8=await database_1[_0x3e2c2e(0x154)][_0x3e2c2e(0x177)][_0x3e2c2e(0x172)]({'where':{'id':_0x35b924},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x217cb8)throw new Error('Shop\x20not\x20found');if(_0x217cb8['twoFactorEnabled']){if(!_0xeb3b03)throw new Error('2FA\x20token\x20is\x20required');const _0x572f3f=speakeasy_1[_0x3e2c2e(0x154)][_0x3e2c2e(0x14d)][_0x3e2c2e(0x158)]({'secret':_0x217cb8[_0x3e2c2e(0x16f)],'encoding':'base32','token':_0xeb3b03,'window':0x2});if(!_0x572f3f){let _0x532750=![];if(_0x217cb8[_0x3e2c2e(0x15d)]){const _0x4ffb53=JSON['parse'](_0x217cb8['backupCodes']);for(let _0x266a26=0x0;_0x266a26<_0x4ffb53[_0x3e2c2e(0x13f)];_0x266a26++){const _0x42c89a=await bcryptjs_1[_0x3e2c2e(0x154)][_0x3e2c2e(0x153)](_0xeb3b03,_0x4ffb53[_0x266a26]);if(_0x42c89a){_0x532750=!![],_0x4ffb53['splice'](_0x266a26,0x1),await database_1['default']['shop']['update']({'where':{'id':_0x35b924},'data':{'backupCodes':JSON['stringify'](_0x4ffb53)}});break;}}}if(!_0x532750)throw new Error(_0x3e2c2e(0x17c));}}const _0x2288ba=_0x3e2c2e(0x184)+crypto_1[_0x3e2c2e(0x154)][_0x3e2c2e(0x175)](0x20)[_0x3e2c2e(0x137)](_0x3e2c2e(0x179)),_0x5c21df=_0x3e2c2e(0x152)+crypto_1[_0x3e2c2e(0x154)]['randomBytes'](0x20)[_0x3e2c2e(0x137)]('hex');await database_1[_0x3e2c2e(0x154)][_0x3e2c2e(0x177)][_0x3e2c2e(0x15b)]({'where':{'id':_0x35b924},'data':{'publicKey':_0x2288ba,'secretKey':_0x5c21df}});}async[a85_0x59092d(0x15f)](_0x57d06d,_0x582402){const _0x3ad3f7=a85_0x59092d,{passwordConfirmation:_0x72f1c0}=_0x582402,_0x22945=await database_1[_0x3ad3f7(0x154)][_0x3ad3f7(0x177)]['findUnique']({'where':{'id':_0x57d06d},'select':{'password':!![]}});if(!_0x22945)throw new Error(_0x3ad3f7(0x138));const _0x458e0d=await bcryptjs_1[_0x3ad3f7(0x154)]['compare'](_0x72f1c0,_0x22945[_0x3ad3f7(0x13c)]);if(!_0x458e0d)throw new Error(_0x3ad3f7(0x14b));await database_1[_0x3ad3f7(0x154)][_0x3ad3f7(0x177)][_0x3ad3f7(0x17e)]({'where':{'id':_0x57d06d}});}async[a85_0x59092d(0x13d)](_0x3bd4b6){const _0x19e5ab=a85_0x59092d,_0x259003=await database_1['default'][_0x19e5ab(0x170)][_0x19e5ab(0x162)]({'where':{'shopId':_0x3bd4b6,'isVerified':!![]},'orderBy':{'createdAt':_0x19e5ab(0x181)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x259003;}async['disconnectTelegramSession'](_0xd3309f,_0x3e1473){const _0x28d0c9=a85_0x59092d,_0x570cfa=await database_1[_0x28d0c9(0x154)][_0x28d0c9(0x170)]['findUnique']({'where':{'id':_0x3e1473},'select':{'shopId':!![]}});if(!_0x570cfa)throw new Error('Telegram\x20session\x20not\x20found');if(_0x570cfa[_0x28d0c9(0x149)]!==_0xd3309f)throw new Error(_0x28d0c9(0x14a));await database_1[_0x28d0c9(0x154)]['telegramUser']['update']({'where':{'id':_0x3e1473},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x59092d(0x133)](_0x5ba460){const _0xdbb42=a85_0x59092d,_0x535382=await database_1[_0xdbb42(0x154)]['shopSettings'][_0xdbb42(0x172)]({'where':{'shopId':_0x5ba460}});!_0x535382&&await database_1[_0xdbb42(0x154)][_0xdbb42(0x14e)][_0xdbb42(0x139)]({'data':{'shopId':_0x5ba460}});}}function a85_0x3bae(){const _0x1566c1=['maskApiKey','updateTelegramSettings','notificationPayout','toString','Shop\x20not\x20found','create','7279240bKMLjp','payment_failed','password','getTelegramSessions','changePassword','length','shopUrl2','4230320WpxCgO','shopUrl4','shopUrl3','13798zSJhGv','__esModule','2FA\x20token\x20is\x20required','crypto','SettingsService','shopId','Unauthorized\x20to\x20disconnect\x20this\x20session','Password\x20confirmation\x20is\x20incorrect','shopUrl','totp','shopSettings','9etxTbD','substring','webhookEvents','sk_','compare','default','12CqBOuP','max','settings','verify','Current\x20password\x20is\x20incorrect','payment_success','update','notificationRefund','backupCodes','telegramChatId','deleteAccount','notificationLogin','parseWebhookEvents','findMany','string','login','refund','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','name','splice','hash','repeat','telegramBotApiKey','6323634cGGEec','updateNotifications','api_error','twoFactorSecret','telegramUser','notificationPaymentFailed','findUnique','notificationPaymentSuccess','2153823yGXxLA','randomBytes','parse','shop','telegram','hex','botApiKey','base32','Invalid\x202FA\x20token\x20or\x20backup\x20code','300xnLiHc','delete','isArray','twoFactorEnabled','desc','../config/database','7792PKRCac','pk_','5840430kIduRK','revokeAllApiKeys','notificationApiError','webhookUrl','ensureSettingsExist'];a85_0x3bae=function(){return _0x1566c1;};return a85_0x3bae();}exports[a85_0x59092d(0x148)]=SettingsService;