'use strict';const a78_0x40d4ef=a78_0x2a86;(function(_0x970c36,_0x5bd1f3){const _0x5690bc=a78_0x2a86,_0x394a8b=_0x970c36();while(!![]){try{const _0x16f930=-parseInt(_0x5690bc(0x1be))/0x1+parseInt(_0x5690bc(0x1d2))/0x2*(parseInt(_0x5690bc(0x1bc))/0x3)+-parseInt(_0x5690bc(0x200))/0x4+parseInt(_0x5690bc(0x1fb))/0x5+parseInt(_0x5690bc(0x1c9))/0x6+-parseInt(_0x5690bc(0x1e3))/0x7+parseInt(_0x5690bc(0x1c3))/0x8;if(_0x16f930===_0x5bd1f3)break;else _0x394a8b['push'](_0x394a8b['shift']());}catch(_0x4575e2){_0x394a8b['push'](_0x394a8b['shift']());}}}(a78_0x154e,0x43a03));function a78_0x154e(){const _0x1630b0=['notificationPaymentSuccess','6AgTIFn','base32','502207kxhyZF','telegramUsers','__esModule','ensureSettingsExist','parseWebhookEvents','8079720oLyjdr','Unauthorized\x20to\x20disconnect\x20this\x20session','crypto','password','twoFactorSecret','substring','3106026LMNUUq','desc','Shop\x20not\x20found','getTelegramSessions','speakeasy','parse','length','Telegram\x20session\x20not\x20found','shopUrl','8486WIEvhk','getShopSettings','telegramChatId','payment_success','compare','telegram','toString','name','create','notificationPayout','telegramUser','backupCodes','deleteAccount','webhookEvents','randomBytes','shopSettings','stringify','2916732TmxJlM','shop','default','pk_','max','findUnique','api_error','../config/database','updateWebhookSettings','2FA\x20token\x20is\x20required','_count','webhookUrl','shopId','isArray','verify','twoFactorEnabled','refund','login','notificationRefund','splice','notificationApiError','SettingsService','revokeAllApiKeys','telegramBotApiKey','806815hqsBgH','totp','update','hex','maskApiKey','2006428XJhBSy','repeat','__importDefault','Invalid\x202FA\x20token\x20or\x20backup\x20code','botApiKey','payout','payment_failed','notificationPaymentFailed','sk_','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long'];a78_0x154e=function(){return _0x1630b0;};return a78_0x154e();}var __importDefault=this&&this[a78_0x40d4ef(0x1b3)]||function(_0x2cc5a8){const _0x512b46=a78_0x40d4ef;return _0x2cc5a8&&_0x2cc5a8[_0x512b46(0x1c0)]?_0x2cc5a8:{'default':_0x2cc5a8};};function a78_0x2a86(_0x58f6c5,_0xfeba9){_0x58f6c5=_0x58f6c5-0x1b3;const _0x154e3d=a78_0x154e();let _0x2a869f=_0x154e3d[_0x58f6c5];return _0x2a869f;}Object['defineProperty'](exports,a78_0x40d4ef(0x1c0),{'value':!![]}),exports[a78_0x40d4ef(0x1f8)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a78_0x40d4ef(0x1c5))),speakeasy_1=__importDefault(require(a78_0x40d4ef(0x1cd))),database_1=__importDefault(require(a78_0x40d4ef(0x1ea)));class SettingsService{[a78_0x40d4ef(0x1ff)](_0x318918){const _0x2fe9c1=a78_0x40d4ef;if(!_0x318918)return'';if(_0x318918[_0x2fe9c1(0x1cf)]<=0x8)return _0x318918;const _0x39d557=_0x318918[_0x2fe9c1(0x1c8)](0x0,0x8),_0x19853a='*'[_0x2fe9c1(0x201)](Math[_0x2fe9c1(0x1e7)](0x0,_0x318918[_0x2fe9c1(0x1cf)]-0x8));return _0x39d557+_0x19853a;}[a78_0x40d4ef(0x1c2)](_0x1c65a5){const _0x1f6de6=a78_0x40d4ef;if(!_0x1c65a5)return[];if(Array[_0x1f6de6(0x1f0)](_0x1c65a5))return _0x1c65a5;if(typeof _0x1c65a5==='string')try{const _0x119644=JSON[_0x1f6de6(0x1ce)](_0x1c65a5);return Array[_0x1f6de6(0x1f0)](_0x119644)?_0x119644:[];}catch{return[];}return[];}async[a78_0x40d4ef(0x1d3)](_0x20c2d6){const _0x297271=a78_0x40d4ef,_0x1e0d70=await database_1[_0x297271(0x1e5)][_0x297271(0x1e4)][_0x297271(0x1e8)]({'where':{'id':_0x20c2d6},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x1e0d70)throw new Error('Shop\x20not\x20found');let _0x7b6404=_0x1e0d70['settings'];return!_0x7b6404&&(_0x7b6404=await database_1[_0x297271(0x1e5)][_0x297271(0x1e1)][_0x297271(0x1da)]({'data':{'shopId':_0x1e0d70['id']}})),{'fullName':_0x1e0d70[_0x297271(0x1d9)],'brand':_0x1e0d70['name'],'merchantUrl':_0x1e0d70[_0x297271(0x1d1)],'telegramUsername':_0x1e0d70[_0x297271(0x1d7)],'telegramBotApiKey':_0x7b6404[_0x297271(0x1fa)]?this['maskApiKey'](_0x7b6404['telegramBotApiKey']):null,'telegramChatId':_0x7b6404['telegramChatId'],'telegramUsersCount':_0x1e0d70[_0x297271(0x1ed)][_0x297271(0x1bf)],'webhookUrl':_0x7b6404[_0x297271(0x1ee)],'webhookEvents':this[_0x297271(0x1c2)](_0x7b6404[_0x297271(0x1df)]),'twoFactorEnabled':_0x1e0d70[_0x297271(0x1f2)]||![],'notifications':{'payment_success':_0x7b6404[_0x297271(0x1bb)],'payment_failed':_0x7b6404[_0x297271(0x1b8)],'refund':_0x7b6404[_0x297271(0x1f5)],'payout':_0x7b6404['notificationPayout'],'login':_0x7b6404['notificationLogin'],'api_error':_0x7b6404[_0x297271(0x1f7)]}};}async['changePassword'](_0x3effc5,_0x3c6c15){const _0xdbc0ff=a78_0x40d4ef,{currentPassword:_0x33d5f4,newPassword:_0x2c8284,confirmNewPassword:_0x190012,twoFactorToken:_0x3a8337}=_0x3c6c15;if(_0x2c8284!==_0x190012)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x2c8284[_0xdbc0ff(0x1cf)]<0x6)throw new Error(_0xdbc0ff(0x1ba));const _0xadf520=await database_1['default'][_0xdbc0ff(0x1e4)][_0xdbc0ff(0x1e8)]({'where':{'id':_0x3effc5},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0xadf520)throw new Error('Shop\x20not\x20found');if(_0xadf520[_0xdbc0ff(0x1f2)]){if(!_0x3a8337)throw new Error(_0xdbc0ff(0x1ec));const _0x407ee7=speakeasy_1[_0xdbc0ff(0x1e5)][_0xdbc0ff(0x1fc)]['verify']({'secret':_0xadf520[_0xdbc0ff(0x1c7)],'encoding':_0xdbc0ff(0x1bd),'token':_0x3a8337,'window':0x2});if(!_0x407ee7){let _0x4cabd4=![];if(_0xadf520['backupCodes']){const _0x2393e3=JSON[_0xdbc0ff(0x1ce)](_0xadf520[_0xdbc0ff(0x1dd)]);for(let _0x2f4061=0x0;_0x2f4061<_0x2393e3[_0xdbc0ff(0x1cf)];_0x2f4061++){const _0x434a15=await bcryptjs_1[_0xdbc0ff(0x1e5)][_0xdbc0ff(0x1d6)](_0x3a8337,_0x2393e3[_0x2f4061]);if(_0x434a15){_0x4cabd4=!![],_0x2393e3[_0xdbc0ff(0x1f6)](_0x2f4061,0x1),await database_1[_0xdbc0ff(0x1e5)][_0xdbc0ff(0x1e4)][_0xdbc0ff(0x1fd)]({'where':{'id':_0x3effc5},'data':{'backupCodes':JSON[_0xdbc0ff(0x1e2)](_0x2393e3)}});break;}}}if(!_0x4cabd4)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x134f58=await bcryptjs_1['default'][_0xdbc0ff(0x1d6)](_0x33d5f4,_0xadf520[_0xdbc0ff(0x1c6)]);if(!_0x134f58)throw new Error('Current\x20password\x20is\x20incorrect');const _0x369353=await bcryptjs_1['default']['hash'](_0x2c8284,0xc);await database_1[_0xdbc0ff(0x1e5)][_0xdbc0ff(0x1e4)]['update']({'where':{'id':_0x3effc5},'data':{'password':_0x369353}});}async['updateNotifications'](_0x589713,_0x23c996){const _0x32b6e4=a78_0x40d4ef;await this[_0x32b6e4(0x1c1)](_0x589713);const _0x163728={};_0x23c996[_0x32b6e4(0x1d5)]!==undefined&&(_0x163728[_0x32b6e4(0x1bb)]=_0x23c996[_0x32b6e4(0x1d5)]),_0x23c996[_0x32b6e4(0x1b7)]!==undefined&&(_0x163728[_0x32b6e4(0x1b8)]=_0x23c996[_0x32b6e4(0x1b7)]),_0x23c996[_0x32b6e4(0x1f3)]!==undefined&&(_0x163728[_0x32b6e4(0x1f5)]=_0x23c996['refund']),_0x23c996[_0x32b6e4(0x1b6)]!==undefined&&(_0x163728[_0x32b6e4(0x1db)]=_0x23c996['payout']),_0x23c996[_0x32b6e4(0x1f4)]!==undefined&&(_0x163728['notificationLogin']=_0x23c996[_0x32b6e4(0x1f4)]),_0x23c996[_0x32b6e4(0x1e9)]!==undefined&&(_0x163728[_0x32b6e4(0x1f7)]=_0x23c996['api_error']),await database_1[_0x32b6e4(0x1e5)]['shopSettings'][_0x32b6e4(0x1fd)]({'where':{'shopId':_0x589713},'data':_0x163728});}async['updateTelegramSettings'](_0x11670b,_0x461b36){const _0x290038=a78_0x40d4ef;await this[_0x290038(0x1c1)](_0x11670b);const _0x11f74c={};_0x461b36[_0x290038(0x1b5)]!==undefined&&(_0x11f74c['telegramBotApiKey']=_0x461b36[_0x290038(0x1b5)]||null),_0x461b36['chatId']!==undefined&&(_0x11f74c[_0x290038(0x1d4)]=_0x461b36['chatId']||null),await database_1[_0x290038(0x1e5)][_0x290038(0x1e1)][_0x290038(0x1fd)]({'where':{'shopId':_0x11670b},'data':_0x11f74c});}async[a78_0x40d4ef(0x1eb)](_0x30811a,_0x3c752d){const _0x589cb6=a78_0x40d4ef;await this[_0x589cb6(0x1c1)](_0x30811a);const _0x24e104={};_0x3c752d[_0x589cb6(0x1ee)]!==undefined&&(_0x24e104['webhookUrl']=_0x3c752d[_0x589cb6(0x1ee)]||null),_0x3c752d[_0x589cb6(0x1df)]!==undefined&&(_0x24e104['webhookEvents']=_0x3c752d[_0x589cb6(0x1df)]||[]),await database_1[_0x589cb6(0x1e5)][_0x589cb6(0x1e1)]['update']({'where':{'shopId':_0x30811a},'data':_0x24e104});}async[a78_0x40d4ef(0x1f9)](_0x80da96,_0x4bb097){const _0x1021c5=a78_0x40d4ef,_0x2c946e=await database_1['default'][_0x1021c5(0x1e4)]['findUnique']({'where':{'id':_0x80da96},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x2c946e)throw new Error(_0x1021c5(0x1cb));if(_0x2c946e[_0x1021c5(0x1f2)]){if(!_0x4bb097)throw new Error(_0x1021c5(0x1ec));const _0x5cf3f4=speakeasy_1[_0x1021c5(0x1e5)][_0x1021c5(0x1fc)][_0x1021c5(0x1f1)]({'secret':_0x2c946e['twoFactorSecret'],'encoding':_0x1021c5(0x1bd),'token':_0x4bb097,'window':0x2});if(!_0x5cf3f4){let _0x1a7e0b=![];if(_0x2c946e[_0x1021c5(0x1dd)]){const _0x546f2f=JSON[_0x1021c5(0x1ce)](_0x2c946e[_0x1021c5(0x1dd)]);for(let _0xc3a575=0x0;_0xc3a575<_0x546f2f[_0x1021c5(0x1cf)];_0xc3a575++){const _0x2578ad=await bcryptjs_1['default']['compare'](_0x4bb097,_0x546f2f[_0xc3a575]);if(_0x2578ad){_0x1a7e0b=!![],_0x546f2f[_0x1021c5(0x1f6)](_0xc3a575,0x1),await database_1['default'][_0x1021c5(0x1e4)][_0x1021c5(0x1fd)]({'where':{'id':_0x80da96},'data':{'backupCodes':JSON['stringify'](_0x546f2f)}});break;}}}if(!_0x1a7e0b)throw new Error(_0x1021c5(0x1b4));}}const _0x1f439a=_0x1021c5(0x1e6)+crypto_1[_0x1021c5(0x1e5)]['randomBytes'](0x20)['toString'](_0x1021c5(0x1fe)),_0x55b523=_0x1021c5(0x1b9)+crypto_1[_0x1021c5(0x1e5)][_0x1021c5(0x1e0)](0x20)[_0x1021c5(0x1d8)](_0x1021c5(0x1fe));await database_1['default'][_0x1021c5(0x1e4)][_0x1021c5(0x1fd)]({'where':{'id':_0x80da96},'data':{'publicKey':_0x1f439a,'secretKey':_0x55b523}});}async[a78_0x40d4ef(0x1de)](_0x389e04,_0x4c502f){const _0x1b4658=a78_0x40d4ef,{passwordConfirmation:_0xf4a599}=_0x4c502f,_0x126651=await database_1[_0x1b4658(0x1e5)]['shop'][_0x1b4658(0x1e8)]({'where':{'id':_0x389e04},'select':{'password':!![]}});if(!_0x126651)throw new Error('Shop\x20not\x20found');const _0x2f5b2b=await bcryptjs_1['default'][_0x1b4658(0x1d6)](_0xf4a599,_0x126651[_0x1b4658(0x1c6)]);if(!_0x2f5b2b)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x1b4658(0x1e5)][_0x1b4658(0x1e4)]['delete']({'where':{'id':_0x389e04}});}async[a78_0x40d4ef(0x1cc)](_0x36cc48){const _0x47a275=a78_0x40d4ef,_0x24736f=await database_1['default'][_0x47a275(0x1dc)]['findMany']({'where':{'shopId':_0x36cc48,'isVerified':!![]},'orderBy':{'createdAt':_0x47a275(0x1ca)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x24736f;}async['disconnectTelegramSession'](_0x25c071,_0x1bad76){const _0x3b0366=a78_0x40d4ef,_0x314acc=await database_1[_0x3b0366(0x1e5)][_0x3b0366(0x1dc)][_0x3b0366(0x1e8)]({'where':{'id':_0x1bad76},'select':{'shopId':!![]}});if(!_0x314acc)throw new Error(_0x3b0366(0x1d0));if(_0x314acc[_0x3b0366(0x1ef)]!==_0x25c071)throw new Error(_0x3b0366(0x1c4));await database_1[_0x3b0366(0x1e5)][_0x3b0366(0x1dc)][_0x3b0366(0x1fd)]({'where':{'id':_0x1bad76},'data':{'shopId':null,'isVerified':![]}});}async[a78_0x40d4ef(0x1c1)](_0x4201ff){const _0x53e2f7=a78_0x40d4ef,_0xf215b0=await database_1[_0x53e2f7(0x1e5)][_0x53e2f7(0x1e1)][_0x53e2f7(0x1e8)]({'where':{'shopId':_0x4201ff}});!_0xf215b0&&await database_1[_0x53e2f7(0x1e5)][_0x53e2f7(0x1e1)][_0x53e2f7(0x1da)]({'data':{'shopId':_0x4201ff}});}}exports[a78_0x40d4ef(0x1f8)]=SettingsService;