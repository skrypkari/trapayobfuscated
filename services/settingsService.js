'use strict';const a75_0x273772=a75_0x15d3;function a75_0x555e(){const _0x1163ba=['max','telegramBotApiKey','pk_','webhookUrl','password','updateTelegramSettings','__importDefault','update','notificationLogin','6114836HpVMiZ','1665848Rlpocl','toString','api_error','length','crypto','delete','notificationPaymentSuccess','1377416JMZdJL','create','webhookEvents','chatId','Password\x20confirmation\x20is\x20incorrect','settings','notificationApiError','10ZYLBHE','string','725202rfZDzQ','revokeAllApiKeys','__esModule','maskApiKey','isArray','SettingsService','substring','botApiKey','telegram','Shop\x20not\x20found','changePassword','80wPpeIZ','sk_','parseWebhookEvents','findUnique','parse','22472659kFGovv','refund','shopSettings','ensureSettingsExist','repeat','notificationRefund','3CvvBJr','telegramChatId','shop','name','login','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','compare','updateNotifications','default','Current\x20password\x20is\x20incorrect','deleteAccount','251742kRQASZ','1324409EnntMj','defineProperty','getShopSettings','notificationPaymentFailed','32NMGvCZ','hash','hex','payment_success'];a75_0x555e=function(){return _0x1163ba;};return a75_0x555e();}(function(_0xf93a28,_0x54399c){const _0x5dc8ca=a75_0x15d3,_0x4b91f5=_0xf93a28();while(!![]){try{const _0x362ac7=-parseInt(_0x5dc8ca(0x8b))/0x1+-parseInt(_0x5dc8ca(0xa4))/0x2+-parseInt(_0x5dc8ca(0x7f))/0x3*(parseInt(_0x5dc8ca(0x9d))/0x4)+-parseInt(_0x5dc8ca(0xb8))/0x5*(-parseInt(_0x5dc8ca(0x8a))/0x6)+parseInt(_0x5dc8ca(0x9c))/0x7+parseInt(_0x5dc8ca(0x8f))/0x8*(-parseInt(_0x5dc8ca(0xad))/0x9)+parseInt(_0x5dc8ca(0xab))/0xa*(parseInt(_0x5dc8ca(0xbd))/0xb);if(_0x362ac7===_0x54399c)break;else _0x4b91f5['push'](_0x4b91f5['shift']());}catch(_0x4c6550){_0x4b91f5['push'](_0x4b91f5['shift']());}}}(a75_0x555e,0xcc162));var __importDefault=this&&this[a75_0x273772(0x99)]||function(_0x32a713){const _0xb56a89=a75_0x273772;return _0x32a713&&_0x32a713[_0xb56a89(0xaf)]?_0x32a713:{'default':_0x32a713};};function a75_0x15d3(_0x5f3b44,_0x11f816){_0x5f3b44=_0x5f3b44-0x7c;const _0x555ecf=a75_0x555e();let _0x15d33c=_0x555ecf[_0x5f3b44];return _0x15d33c;}Object[a75_0x273772(0x8c)](exports,a75_0x273772(0xaf),{'value':!![]}),exports[a75_0x273772(0xb2)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a75_0x273772(0xa1))),database_1=__importDefault(require('../config/database'));class SettingsService{[a75_0x273772(0xb0)](_0x351b7b){const _0x552012=a75_0x273772;if(!_0x351b7b)return'';if(_0x351b7b['length']<=0x8)return _0x351b7b;const _0x5b5a81=_0x351b7b[_0x552012(0xb3)](0x0,0x8),_0x58c193='*'[_0x552012(0x7d)](Math[_0x552012(0x93)](0x0,_0x351b7b[_0x552012(0xa0)]-0x8));return _0x5b5a81+_0x58c193;}[a75_0x273772(0xba)](_0x53470b){const _0x385bd4=a75_0x273772;if(!_0x53470b)return[];if(Array[_0x385bd4(0xb1)](_0x53470b))return _0x53470b;if(typeof _0x53470b===_0x385bd4(0xac))try{const _0xafea80=JSON[_0x385bd4(0xbc)](_0x53470b);return Array[_0x385bd4(0xb1)](_0xafea80)?_0xafea80:[];}catch{return[];}return[];}async[a75_0x273772(0x8d)](_0x1fad30){const _0x4e2c04=a75_0x273772,_0x101581=await database_1['default'][_0x4e2c04(0x81)][_0x4e2c04(0xbb)]({'where':{'id':_0x1fad30},'include':{'settings':!![]}});if(!_0x101581)throw new Error('Shop\x20not\x20found');let _0x57b954=_0x101581[_0x4e2c04(0xa9)];return!_0x57b954&&(_0x57b954=await database_1['default']['shopSettings'][_0x4e2c04(0xa5)]({'data':{'shopId':_0x101581['id']}})),{'fullName':_0x101581[_0x4e2c04(0x82)],'brand':_0x101581['name'],'merchantUrl':_0x101581['shopUrl'],'telegramUsername':_0x101581[_0x4e2c04(0xb5)],'telegramBotApiKey':_0x57b954[_0x4e2c04(0x94)]?this[_0x4e2c04(0xb0)](_0x57b954['telegramBotApiKey']):null,'telegramChatId':_0x57b954[_0x4e2c04(0x80)],'webhookUrl':_0x57b954[_0x4e2c04(0x96)],'webhookEvents':this['parseWebhookEvents'](_0x57b954[_0x4e2c04(0xa6)]),'notifications':{'payment_success':_0x57b954[_0x4e2c04(0xa3)],'payment_failed':_0x57b954[_0x4e2c04(0x8e)],'refund':_0x57b954[_0x4e2c04(0x7e)],'payout':_0x57b954['notificationPayout'],'login':_0x57b954[_0x4e2c04(0x9b)],'api_error':_0x57b954[_0x4e2c04(0xaa)]}};}async[a75_0x273772(0xb7)](_0xb24322,_0xb45e61){const _0x14c5a7=a75_0x273772,{currentPassword:_0x376249,newPassword:_0x4475c,confirmNewPassword:_0x852b0a}=_0xb45e61;if(_0x4475c!==_0x852b0a)throw new Error(_0x14c5a7(0x84));if(_0x4475c['length']<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x44ceb9=await database_1[_0x14c5a7(0x87)][_0x14c5a7(0x81)][_0x14c5a7(0xbb)]({'where':{'id':_0xb24322},'select':{'password':!![]}});if(!_0x44ceb9)throw new Error('Shop\x20not\x20found');const _0x27c858=await bcryptjs_1[_0x14c5a7(0x87)][_0x14c5a7(0x85)](_0x376249,_0x44ceb9['password']);if(!_0x27c858)throw new Error(_0x14c5a7(0x88));const _0x53fe5f=await bcryptjs_1[_0x14c5a7(0x87)][_0x14c5a7(0x90)](_0x4475c,0xc);await database_1[_0x14c5a7(0x87)][_0x14c5a7(0x81)][_0x14c5a7(0x9a)]({'where':{'id':_0xb24322},'data':{'password':_0x53fe5f}});}async[a75_0x273772(0x86)](_0x4501d4,_0x1329a3){const _0x5c13dd=a75_0x273772;await this['ensureSettingsExist'](_0x4501d4);const _0xd2ef3={};_0x1329a3[_0x5c13dd(0x92)]!==undefined&&(_0xd2ef3[_0x5c13dd(0xa3)]=_0x1329a3['payment_success']),_0x1329a3['payment_failed']!==undefined&&(_0xd2ef3['notificationPaymentFailed']=_0x1329a3['payment_failed']),_0x1329a3[_0x5c13dd(0xbe)]!==undefined&&(_0xd2ef3[_0x5c13dd(0x7e)]=_0x1329a3[_0x5c13dd(0xbe)]),_0x1329a3['payout']!==undefined&&(_0xd2ef3['notificationPayout']=_0x1329a3['payout']),_0x1329a3[_0x5c13dd(0x83)]!==undefined&&(_0xd2ef3[_0x5c13dd(0x9b)]=_0x1329a3[_0x5c13dd(0x83)]),_0x1329a3[_0x5c13dd(0x9f)]!==undefined&&(_0xd2ef3['notificationApiError']=_0x1329a3[_0x5c13dd(0x9f)]),await database_1[_0x5c13dd(0x87)][_0x5c13dd(0xbf)][_0x5c13dd(0x9a)]({'where':{'shopId':_0x4501d4},'data':_0xd2ef3});}async[a75_0x273772(0x98)](_0x5e01f4,_0x4c677f){const _0x14fb3a=a75_0x273772;await this[_0x14fb3a(0x7c)](_0x5e01f4);const _0x3cbce8={};_0x4c677f['botApiKey']!==undefined&&(_0x3cbce8[_0x14fb3a(0x94)]=_0x4c677f[_0x14fb3a(0xb4)]||null),_0x4c677f[_0x14fb3a(0xa7)]!==undefined&&(_0x3cbce8[_0x14fb3a(0x80)]=_0x4c677f[_0x14fb3a(0xa7)]||null),await database_1['default'][_0x14fb3a(0xbf)]['update']({'where':{'shopId':_0x5e01f4},'data':_0x3cbce8});}async['updateWebhookSettings'](_0x4b3be7,_0x5c9f21){const _0x596969=a75_0x273772;await this[_0x596969(0x7c)](_0x4b3be7);const _0x1ce5de={};_0x5c9f21['webhookUrl']!==undefined&&(_0x1ce5de[_0x596969(0x96)]=_0x5c9f21[_0x596969(0x96)]||null),_0x5c9f21[_0x596969(0xa6)]!==undefined&&(_0x1ce5de['webhookEvents']=_0x5c9f21[_0x596969(0xa6)]||[]),await database_1[_0x596969(0x87)][_0x596969(0xbf)][_0x596969(0x9a)]({'where':{'shopId':_0x4b3be7},'data':_0x1ce5de});}async[a75_0x273772(0xae)](_0x3bfad1){const _0x3a280d=a75_0x273772,_0x241c5b=_0x3a280d(0x95)+crypto_1[_0x3a280d(0x87)]['randomBytes'](0x20)[_0x3a280d(0x9e)](_0x3a280d(0x91)),_0x26f9dd=_0x3a280d(0xb9)+crypto_1[_0x3a280d(0x87)]['randomBytes'](0x20)[_0x3a280d(0x9e)]('hex');await database_1[_0x3a280d(0x87)][_0x3a280d(0x81)]['update']({'where':{'id':_0x3bfad1},'data':{'publicKey':_0x241c5b,'secretKey':_0x26f9dd}});}async[a75_0x273772(0x89)](_0x9d3ee5,_0x568441){const _0x4551d0=a75_0x273772,{passwordConfirmation:_0x543310}=_0x568441,_0x3c2334=await database_1[_0x4551d0(0x87)][_0x4551d0(0x81)][_0x4551d0(0xbb)]({'where':{'id':_0x9d3ee5},'select':{'password':!![]}});if(!_0x3c2334)throw new Error(_0x4551d0(0xb6));const _0x297b9d=await bcryptjs_1['default']['compare'](_0x543310,_0x3c2334[_0x4551d0(0x97)]);if(!_0x297b9d)throw new Error(_0x4551d0(0xa8));await database_1[_0x4551d0(0x87)][_0x4551d0(0x81)][_0x4551d0(0xa2)]({'where':{'id':_0x9d3ee5}});}async[a75_0x273772(0x7c)](_0x29aedb){const _0x126394=a75_0x273772,_0x349fa9=await database_1[_0x126394(0x87)][_0x126394(0xbf)]['findUnique']({'where':{'shopId':_0x29aedb}});!_0x349fa9&&await database_1['default'][_0x126394(0xbf)][_0x126394(0xa5)]({'data':{'shopId':_0x29aedb}});}}exports[a75_0x273772(0xb2)]=SettingsService;