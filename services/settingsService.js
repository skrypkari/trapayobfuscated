'use strict';const a85_0x5e375c=a85_0x3e0e;(function(_0x2f803c,_0x1debcd){const _0x5bf224=a85_0x3e0e,_0x371814=_0x2f803c();while(!![]){try{const _0x481867=-parseInt(_0x5bf224(0xd4))/0x1+parseInt(_0x5bf224(0xd0))/0x2*(-parseInt(_0x5bf224(0xf6))/0x3)+-parseInt(_0x5bf224(0xd1))/0x4*(parseInt(_0x5bf224(0x11b))/0x5)+-parseInt(_0x5bf224(0x117))/0x6+-parseInt(_0x5bf224(0xde))/0x7*(parseInt(_0x5bf224(0xfc))/0x8)+parseInt(_0x5bf224(0xff))/0x9*(-parseInt(_0x5bf224(0xf0))/0xa)+parseInt(_0x5bf224(0x108))/0xb*(parseInt(_0x5bf224(0xe2))/0xc);if(_0x481867===_0x1debcd)break;else _0x371814['push'](_0x371814['shift']());}catch(_0x118b21){_0x371814['push'](_0x371814['shift']());}}}(a85_0x3094,0x5c3f8));function a85_0x3094(){const _0x380e24=['desc','1456034TGdEbM','12EkThzc','length','create','528361jtjbFZ','shopSettings','deleteAccount','chatId','maskApiKey','Shop\x20not\x20found','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','shopUrl3','parseWebhookEvents','isArray','1155RzBpCg','webhookUrl','substring','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','12IwBHLZ','notificationApiError','compare','splice','shop','changePassword','findMany','telegramUser','findUnique','login','max','twoFactorSecret','Telegram\x20session\x20not\x20found','api_error','1723070uRbXJu','name','telegram','telegramChatId','speakeasy','backupCodes','3OkcKDI','webhookEvents','__esModule','update','updateWebhookSettings','shopUrl2','15016nYDrOk','payment_failed','disconnectTelegramSession','27igHIPZ','telegramUsers','ensureSettingsExist','delete','notificationLogin','payout','settings','sk_','../config/database','39334273Btwhzw','Invalid\x202FA\x20token\x20or\x20backup\x20code','base32','password','notificationPayout','2FA\x20token\x20is\x20required','Password\x20confirmation\x20is\x20incorrect','Unauthorized\x20to\x20disconnect\x20this\x20session','refund','SettingsService','bcryptjs','botApiKey','telegramBotApiKey','notificationPaymentFailed','updateNotifications','4016370UtNGvx','pk_','Current\x20password\x20is\x20incorrect','notificationPaymentSuccess','742660KnxmUq','notificationRefund','getShopSettings','getTelegramSessions','defineProperty','verify','payment_success','hash','toString','default','shopUrl4','twoFactorEnabled','randomBytes','shopUrl','totp','parse','__importDefault'];a85_0x3094=function(){return _0x380e24;};return a85_0x3094();}var __importDefault=this&&this[a85_0x5e375c(0xce)]||function(_0x23c95b){const _0x218de5=a85_0x5e375c;return _0x23c95b&&_0x23c95b[_0x218de5(0xf8)]?_0x23c95b:{'default':_0x23c95b};};Object[a85_0x5e375c(0xc2)](exports,'__esModule',{'value':!![]}),exports[a85_0x5e375c(0x111)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x5e375c(0x112))),crypto_1=__importDefault(require('crypto')),speakeasy_1=__importDefault(require(a85_0x5e375c(0xf4))),database_1=__importDefault(require(a85_0x5e375c(0x107)));class SettingsService{['maskApiKey'](_0x546703){const _0x2aead3=a85_0x5e375c;if(!_0x546703)return'';if(_0x546703[_0x2aead3(0xd2)]<=0x8)return _0x546703;const _0x5cf457=_0x546703[_0x2aead3(0xe0)](0x0,0x8),_0x2da2eb='*'['repeat'](Math[_0x2aead3(0xec)](0x0,_0x546703[_0x2aead3(0xd2)]-0x8));return _0x5cf457+_0x2da2eb;}[a85_0x5e375c(0xdc)](_0x386ed9){const _0x127ac2=a85_0x5e375c;if(!_0x386ed9)return[];if(Array['isArray'](_0x386ed9))return _0x386ed9;if(typeof _0x386ed9==='string')try{const _0x2cb583=JSON[_0x127ac2(0xcd)](_0x386ed9);return Array[_0x127ac2(0xdd)](_0x2cb583)?_0x2cb583:[];}catch{return[];}return[];}async[a85_0x5e375c(0xc0)](_0x180a5a){const _0x5561eb=a85_0x5e375c,_0x2f6528=await database_1[_0x5561eb(0xc7)][_0x5561eb(0xe6)][_0x5561eb(0xea)]({'where':{'id':_0x180a5a},'select':{'id':!![],'name':!![],'shopUrl':!![],'shopUrl2':!![],'shopUrl3':!![],'shopUrl4':!![],'telegram':!![],'twoFactorEnabled':!![],'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2f6528)throw new Error(_0x5561eb(0xd9));let _0x2296cc=_0x2f6528[_0x5561eb(0x105)];return!_0x2296cc&&(_0x2296cc=await database_1[_0x5561eb(0xc7)][_0x5561eb(0xd5)]['create']({'data':{'shopId':_0x2f6528['id']}})),{'fullName':_0x2f6528[_0x5561eb(0xf1)],'brand':_0x2f6528[_0x5561eb(0xf1)],'merchantUrl':_0x2f6528[_0x5561eb(0xcb)],'merchantUrl2':_0x2f6528[_0x5561eb(0xfb)],'merchantUrl3':_0x2f6528[_0x5561eb(0xdb)],'merchantUrl4':_0x2f6528[_0x5561eb(0xc8)],'telegramUsername':_0x2f6528[_0x5561eb(0xf2)],'telegramBotApiKey':_0x2296cc[_0x5561eb(0x114)]?this[_0x5561eb(0xd8)](_0x2296cc[_0x5561eb(0x114)]):null,'telegramChatId':_0x2296cc[_0x5561eb(0xf3)],'telegramUsersCount':_0x2f6528['_count'][_0x5561eb(0x100)],'webhookUrl':_0x2296cc[_0x5561eb(0xdf)],'webhookEvents':this['parseWebhookEvents'](_0x2296cc[_0x5561eb(0xf7)]),'twoFactorEnabled':_0x2f6528[_0x5561eb(0xc9)]||![],'notifications':{'payment_success':_0x2296cc[_0x5561eb(0x11a)],'payment_failed':_0x2296cc[_0x5561eb(0x115)],'refund':_0x2296cc['notificationRefund'],'payout':_0x2296cc[_0x5561eb(0x10c)],'login':_0x2296cc['notificationLogin'],'api_error':_0x2296cc[_0x5561eb(0xe3)]}};}async[a85_0x5e375c(0xe7)](_0x37dd20,_0x15cfe6){const _0x5ebf9e=a85_0x5e375c,{currentPassword:_0x5521e1,newPassword:_0x34dac0,confirmNewPassword:_0x1a418e,twoFactorToken:_0x4326a4}=_0x15cfe6;if(_0x34dac0!==_0x1a418e)throw new Error(_0x5ebf9e(0xda));if(_0x34dac0[_0x5ebf9e(0xd2)]<0x6)throw new Error(_0x5ebf9e(0xe1));const _0xec252c=await database_1[_0x5ebf9e(0xc7)][_0x5ebf9e(0xe6)][_0x5ebf9e(0xea)]({'where':{'id':_0x37dd20},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0xec252c)throw new Error(_0x5ebf9e(0xd9));if(_0xec252c[_0x5ebf9e(0xc9)]){if(!_0x4326a4)throw new Error(_0x5ebf9e(0x10d));const _0x71a27a=speakeasy_1['default'][_0x5ebf9e(0xcc)][_0x5ebf9e(0xc3)]({'secret':_0xec252c[_0x5ebf9e(0xed)],'encoding':'base32','token':_0x4326a4,'window':0x2});if(!_0x71a27a){let _0x1f549a=![];if(_0xec252c[_0x5ebf9e(0xf5)]){const _0x1cd06d=JSON[_0x5ebf9e(0xcd)](_0xec252c[_0x5ebf9e(0xf5)]);for(let _0x3aed14=0x0;_0x3aed14<_0x1cd06d[_0x5ebf9e(0xd2)];_0x3aed14++){const _0x22598c=await bcryptjs_1[_0x5ebf9e(0xc7)][_0x5ebf9e(0xe4)](_0x4326a4,_0x1cd06d[_0x3aed14]);if(_0x22598c){_0x1f549a=!![],_0x1cd06d[_0x5ebf9e(0xe5)](_0x3aed14,0x1),await database_1[_0x5ebf9e(0xc7)]['shop'][_0x5ebf9e(0xf9)]({'where':{'id':_0x37dd20},'data':{'backupCodes':JSON['stringify'](_0x1cd06d)}});break;}}}if(!_0x1f549a)throw new Error(_0x5ebf9e(0x109));}}const _0x20964e=await bcryptjs_1[_0x5ebf9e(0xc7)][_0x5ebf9e(0xe4)](_0x5521e1,_0xec252c['password']);if(!_0x20964e)throw new Error(_0x5ebf9e(0x119));const _0x3e3406=await bcryptjs_1['default'][_0x5ebf9e(0xc5)](_0x34dac0,0xc);await database_1['default'][_0x5ebf9e(0xe6)][_0x5ebf9e(0xf9)]({'where':{'id':_0x37dd20},'data':{'password':_0x3e3406}});}async[a85_0x5e375c(0x116)](_0x3ba166,_0x1cc630){const _0x46a702=a85_0x5e375c;await this[_0x46a702(0x101)](_0x3ba166);const _0x215ac7={};_0x1cc630[_0x46a702(0xc4)]!==undefined&&(_0x215ac7[_0x46a702(0x11a)]=_0x1cc630[_0x46a702(0xc4)]),_0x1cc630[_0x46a702(0xfd)]!==undefined&&(_0x215ac7[_0x46a702(0x115)]=_0x1cc630['payment_failed']),_0x1cc630['refund']!==undefined&&(_0x215ac7[_0x46a702(0xbf)]=_0x1cc630[_0x46a702(0x110)]),_0x1cc630[_0x46a702(0x104)]!==undefined&&(_0x215ac7[_0x46a702(0x10c)]=_0x1cc630['payout']),_0x1cc630[_0x46a702(0xeb)]!==undefined&&(_0x215ac7[_0x46a702(0x103)]=_0x1cc630['login']),_0x1cc630[_0x46a702(0xef)]!==undefined&&(_0x215ac7['notificationApiError']=_0x1cc630[_0x46a702(0xef)]),await database_1[_0x46a702(0xc7)]['shopSettings'][_0x46a702(0xf9)]({'where':{'shopId':_0x3ba166},'data':_0x215ac7});}async['updateTelegramSettings'](_0x9c038a,_0x2f3ff4){const _0x4f04d2=a85_0x5e375c;await this['ensureSettingsExist'](_0x9c038a);const _0x4ef839={};_0x2f3ff4[_0x4f04d2(0x113)]!==undefined&&(_0x4ef839['telegramBotApiKey']=_0x2f3ff4[_0x4f04d2(0x113)]||null),_0x2f3ff4[_0x4f04d2(0xd7)]!==undefined&&(_0x4ef839['telegramChatId']=_0x2f3ff4[_0x4f04d2(0xd7)]||null),await database_1[_0x4f04d2(0xc7)][_0x4f04d2(0xd5)][_0x4f04d2(0xf9)]({'where':{'shopId':_0x9c038a},'data':_0x4ef839});}async[a85_0x5e375c(0xfa)](_0x5991bf,_0x53e867){const _0x4b6a03=a85_0x5e375c;await this['ensureSettingsExist'](_0x5991bf);const _0xe76708={};_0x53e867[_0x4b6a03(0xdf)]!==undefined&&(_0xe76708[_0x4b6a03(0xdf)]=_0x53e867[_0x4b6a03(0xdf)]||null),_0x53e867[_0x4b6a03(0xf7)]!==undefined&&(_0xe76708[_0x4b6a03(0xf7)]=_0x53e867['webhookEvents']||[]),await database_1['default']['shopSettings']['update']({'where':{'shopId':_0x5991bf},'data':_0xe76708});}async['revokeAllApiKeys'](_0x17fb8f,_0x5c5cc7){const _0x1e9bef=a85_0x5e375c,_0x215aa2=await database_1[_0x1e9bef(0xc7)][_0x1e9bef(0xe6)][_0x1e9bef(0xea)]({'where':{'id':_0x17fb8f},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x215aa2)throw new Error('Shop\x20not\x20found');if(_0x215aa2[_0x1e9bef(0xc9)]){if(!_0x5c5cc7)throw new Error('2FA\x20token\x20is\x20required');const _0x2eda8b=speakeasy_1[_0x1e9bef(0xc7)][_0x1e9bef(0xcc)][_0x1e9bef(0xc3)]({'secret':_0x215aa2['twoFactorSecret'],'encoding':_0x1e9bef(0x10a),'token':_0x5c5cc7,'window':0x2});if(!_0x2eda8b){let _0x155903=![];if(_0x215aa2['backupCodes']){const _0x573804=JSON[_0x1e9bef(0xcd)](_0x215aa2[_0x1e9bef(0xf5)]);for(let _0xa4058e=0x0;_0xa4058e<_0x573804[_0x1e9bef(0xd2)];_0xa4058e++){const _0x1d60d7=await bcryptjs_1[_0x1e9bef(0xc7)][_0x1e9bef(0xe4)](_0x5c5cc7,_0x573804[_0xa4058e]);if(_0x1d60d7){_0x155903=!![],_0x573804[_0x1e9bef(0xe5)](_0xa4058e,0x1),await database_1['default'][_0x1e9bef(0xe6)][_0x1e9bef(0xf9)]({'where':{'id':_0x17fb8f},'data':{'backupCodes':JSON['stringify'](_0x573804)}});break;}}}if(!_0x155903)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x551cca=_0x1e9bef(0x118)+crypto_1[_0x1e9bef(0xc7)][_0x1e9bef(0xca)](0x20)[_0x1e9bef(0xc6)]('hex'),_0x415eb3=_0x1e9bef(0x106)+crypto_1[_0x1e9bef(0xc7)][_0x1e9bef(0xca)](0x20)[_0x1e9bef(0xc6)]('hex');await database_1[_0x1e9bef(0xc7)][_0x1e9bef(0xe6)][_0x1e9bef(0xf9)]({'where':{'id':_0x17fb8f},'data':{'publicKey':_0x551cca,'secretKey':_0x415eb3}});}async[a85_0x5e375c(0xd6)](_0x4c3c2e,_0x1f5661){const _0x24941b=a85_0x5e375c,{passwordConfirmation:_0x115841}=_0x1f5661,_0x4ab210=await database_1['default'][_0x24941b(0xe6)]['findUnique']({'where':{'id':_0x4c3c2e},'select':{'password':!![]}});if(!_0x4ab210)throw new Error(_0x24941b(0xd9));const _0x592e72=await bcryptjs_1[_0x24941b(0xc7)][_0x24941b(0xe4)](_0x115841,_0x4ab210[_0x24941b(0x10b)]);if(!_0x592e72)throw new Error(_0x24941b(0x10e));await database_1[_0x24941b(0xc7)][_0x24941b(0xe6)][_0x24941b(0x102)]({'where':{'id':_0x4c3c2e}});}async[a85_0x5e375c(0xc1)](_0x3b4064){const _0x4838a3=a85_0x5e375c,_0x2d88a5=await database_1[_0x4838a3(0xc7)][_0x4838a3(0xe9)][_0x4838a3(0xe8)]({'where':{'shopId':_0x3b4064,'isVerified':!![]},'orderBy':{'createdAt':_0x4838a3(0xcf)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x2d88a5;}async[a85_0x5e375c(0xfe)](_0x595965,_0x5c9f0a){const _0x16f451=a85_0x5e375c,_0x42760=await database_1[_0x16f451(0xc7)][_0x16f451(0xe9)][_0x16f451(0xea)]({'where':{'id':_0x5c9f0a},'select':{'shopId':!![]}});if(!_0x42760)throw new Error(_0x16f451(0xee));if(_0x42760['shopId']!==_0x595965)throw new Error(_0x16f451(0x10f));await database_1[_0x16f451(0xc7)][_0x16f451(0xe9)]['update']({'where':{'id':_0x5c9f0a},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x5e375c(0x101)](_0x1189c3){const _0x4db401=a85_0x5e375c,_0x545eb4=await database_1[_0x4db401(0xc7)]['shopSettings'][_0x4db401(0xea)]({'where':{'shopId':_0x1189c3}});!_0x545eb4&&await database_1['default']['shopSettings'][_0x4db401(0xd3)]({'data':{'shopId':_0x1189c3}});}}function a85_0x3e0e(_0x3f2c17,_0x3c5c21){_0x3f2c17=_0x3f2c17-0xbf;const _0x30948d=a85_0x3094();let _0x3e0eeb=_0x30948d[_0x3f2c17];return _0x3e0eeb;}exports[a85_0x5e375c(0x111)]=SettingsService;