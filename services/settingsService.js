'use strict';function a47_0xca86(){const _0x3dcd90=['telegramBotApiKey','1229031kAlHsB','refund','updateNotifications','../config/database','__esModule','max','string','notificationPayout','167793xVsegt','create','notificationPaymentSuccess','repeat','notificationPaymentFailed','password','ensureSettingsExist','56RaPpBu','webhookEvents','telegram','payout','4864251omLHdS','4190160hjAfrQ','api_error','updateWebhookSettings','4rGiLKy','1367172LQhAlO','shopUrl','6693220nptfGc','isArray','name','webhookUrl','chatId','notificationLogin','Shop\x20not\x20found','6uaSXxc','compare','length','findUnique','defineProperty','688020wVegQh','settings','maskApiKey','crypto','login','default','getShopSettings','__importDefault','botApiKey','notificationRefund','bcryptjs','telegramChatId','parseWebhookEvents','randomBytes','update','11iRqdBK','Password\x20confirmation\x20is\x20incorrect','notificationApiError','hash','payment_success','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','toString','shopSettings','parse','sk_','changePassword','shop','hex'];a47_0xca86=function(){return _0x3dcd90;};return a47_0xca86();}const a47_0x2da502=a47_0x3cbd;(function(_0x12070e,_0x51457b){const _0x14efe2=a47_0x3cbd,_0x3912b2=_0x12070e();while(!![]){try{const _0x1a447a=-parseInt(_0x14efe2(0x1c2))/0x1+-parseInt(_0x14efe2(0x1b4))/0x2+parseInt(_0x14efe2(0x1a4))/0x3*(parseInt(_0x14efe2(0x1b3))/0x4)+parseInt(_0x14efe2(0x1b0))/0x5+parseInt(_0x14efe2(0x1bd))/0x6*(parseInt(_0x14efe2(0x1af))/0x7)+-parseInt(_0x14efe2(0x1ab))/0x8*(-parseInt(_0x14efe2(0x19c))/0x9)+-parseInt(_0x14efe2(0x1b6))/0xa*(parseInt(_0x14efe2(0x18e))/0xb);if(_0x1a447a===_0x51457b)break;else _0x3912b2['push'](_0x3912b2['shift']());}catch(_0x323cea){_0x3912b2['push'](_0x3912b2['shift']());}}}(a47_0xca86,0x7b021));var __importDefault=this&&this[a47_0x2da502(0x1c9)]||function(_0x3eb8a5){const _0x1e4d21=a47_0x2da502;return _0x3eb8a5&&_0x3eb8a5[_0x1e4d21(0x1a0)]?_0x3eb8a5:{'default':_0x3eb8a5};};Object[a47_0x2da502(0x1c1)](exports,'__esModule',{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x2da502(0x1cc))),crypto_1=__importDefault(require(a47_0x2da502(0x1c5))),database_1=__importDefault(require(a47_0x2da502(0x19f)));function a47_0x3cbd(_0x12bf95,_0x31f3b7){const _0xca8683=a47_0xca86();return a47_0x3cbd=function(_0x3cbdec,_0x3dc9ac){_0x3cbdec=_0x3cbdec-0x18c;let _0x594d65=_0xca8683[_0x3cbdec];return _0x594d65;},a47_0x3cbd(_0x12bf95,_0x31f3b7);}class SettingsService{[a47_0x2da502(0x1c4)](_0x38c7e7){const _0x12ec48=a47_0x2da502;if(!_0x38c7e7)return'';if(_0x38c7e7[_0x12ec48(0x1bf)]<=0x8)return _0x38c7e7;const _0xa28eaf=_0x38c7e7['substring'](0x0,0x8),_0x598bc8='*'[_0x12ec48(0x1a7)](Math[_0x12ec48(0x1a1)](0x0,_0x38c7e7[_0x12ec48(0x1bf)]-0x8));return _0xa28eaf+_0x598bc8;}[a47_0x2da502(0x1ce)](_0x499064){const _0x20191b=a47_0x2da502;if(!_0x499064)return[];if(Array[_0x20191b(0x1b7)](_0x499064))return _0x499064;if(typeof _0x499064===_0x20191b(0x1a2))try{const _0x5ab09f=JSON[_0x20191b(0x196)](_0x499064);return Array['isArray'](_0x5ab09f)?_0x5ab09f:[];}catch{return[];}return[];}async[a47_0x2da502(0x1c8)](_0x4e7bc1){const _0x36d207=a47_0x2da502,_0x211bb8=await database_1['default'][_0x36d207(0x199)][_0x36d207(0x1c0)]({'where':{'id':_0x4e7bc1},'include':{'settings':!![]}});if(!_0x211bb8)throw new Error('Shop\x20not\x20found');let _0x18efa6=_0x211bb8[_0x36d207(0x1c3)];return!_0x18efa6&&(_0x18efa6=await database_1[_0x36d207(0x1c7)][_0x36d207(0x195)]['create']({'data':{'shopId':_0x211bb8['id']}})),{'fullName':_0x211bb8[_0x36d207(0x1b8)],'brand':_0x211bb8[_0x36d207(0x1b8)],'merchantUrl':_0x211bb8[_0x36d207(0x1b5)],'telegramUsername':_0x211bb8[_0x36d207(0x1ad)],'telegramBotApiKey':_0x18efa6['telegramBotApiKey']?this[_0x36d207(0x1c4)](_0x18efa6[_0x36d207(0x19b)]):null,'telegramChatId':_0x18efa6[_0x36d207(0x1cd)],'webhookUrl':_0x18efa6[_0x36d207(0x1b9)],'webhookEvents':this['parseWebhookEvents'](_0x18efa6[_0x36d207(0x1ac)]),'notifications':{'payment_success':_0x18efa6['notificationPaymentSuccess'],'payment_failed':_0x18efa6['notificationPaymentFailed'],'refund':_0x18efa6[_0x36d207(0x1cb)],'payout':_0x18efa6[_0x36d207(0x1a3)],'login':_0x18efa6[_0x36d207(0x1bb)],'api_error':_0x18efa6[_0x36d207(0x190)]}};}async[a47_0x2da502(0x198)](_0x3ae1ac,_0x148951){const _0x1041df=a47_0x2da502,{currentPassword:_0x1199fb,newPassword:_0x56029b,confirmNewPassword:_0x4f3565}=_0x148951;if(_0x56029b!==_0x4f3565)throw new Error(_0x1041df(0x193));if(_0x56029b[_0x1041df(0x1bf)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x27c75b=await database_1[_0x1041df(0x1c7)][_0x1041df(0x199)][_0x1041df(0x1c0)]({'where':{'id':_0x3ae1ac},'select':{'password':!![]}});if(!_0x27c75b)throw new Error(_0x1041df(0x1bc));const _0x21cc6c=await bcryptjs_1['default']['compare'](_0x1199fb,_0x27c75b['password']);if(!_0x21cc6c)throw new Error('Current\x20password\x20is\x20incorrect');const _0x5c193e=await bcryptjs_1[_0x1041df(0x1c7)][_0x1041df(0x191)](_0x56029b,0xc);await database_1['default'][_0x1041df(0x199)][_0x1041df(0x18d)]({'where':{'id':_0x3ae1ac},'data':{'password':_0x5c193e}});}async[a47_0x2da502(0x19e)](_0x3b18de,_0x10f7e1){const _0x2ec7d1=a47_0x2da502;await this[_0x2ec7d1(0x1aa)](_0x3b18de);const _0x8f6bca={};_0x10f7e1[_0x2ec7d1(0x192)]!==undefined&&(_0x8f6bca[_0x2ec7d1(0x1a6)]=_0x10f7e1['payment_success']),_0x10f7e1['payment_failed']!==undefined&&(_0x8f6bca[_0x2ec7d1(0x1a8)]=_0x10f7e1['payment_failed']),_0x10f7e1[_0x2ec7d1(0x19d)]!==undefined&&(_0x8f6bca[_0x2ec7d1(0x1cb)]=_0x10f7e1['refund']),_0x10f7e1[_0x2ec7d1(0x1ae)]!==undefined&&(_0x8f6bca[_0x2ec7d1(0x1a3)]=_0x10f7e1[_0x2ec7d1(0x1ae)]),_0x10f7e1[_0x2ec7d1(0x1c6)]!==undefined&&(_0x8f6bca[_0x2ec7d1(0x1bb)]=_0x10f7e1['login']),_0x10f7e1[_0x2ec7d1(0x1b1)]!==undefined&&(_0x8f6bca['notificationApiError']=_0x10f7e1[_0x2ec7d1(0x1b1)]),await database_1[_0x2ec7d1(0x1c7)][_0x2ec7d1(0x195)][_0x2ec7d1(0x18d)]({'where':{'shopId':_0x3b18de},'data':_0x8f6bca});}async['updateTelegramSettings'](_0x386d30,_0x118fad){const _0x22f717=a47_0x2da502;await this[_0x22f717(0x1aa)](_0x386d30);const _0xcedab4={};_0x118fad[_0x22f717(0x1ca)]!==undefined&&(_0xcedab4[_0x22f717(0x19b)]=_0x118fad[_0x22f717(0x1ca)]||null),_0x118fad[_0x22f717(0x1ba)]!==undefined&&(_0xcedab4[_0x22f717(0x1cd)]=_0x118fad[_0x22f717(0x1ba)]||null),await database_1['default'][_0x22f717(0x195)][_0x22f717(0x18d)]({'where':{'shopId':_0x386d30},'data':_0xcedab4});}async[a47_0x2da502(0x1b2)](_0x56a809,_0x852b7b){const _0x19dc1f=a47_0x2da502;await this[_0x19dc1f(0x1aa)](_0x56a809);const _0x2c50c7={};_0x852b7b[_0x19dc1f(0x1b9)]!==undefined&&(_0x2c50c7[_0x19dc1f(0x1b9)]=_0x852b7b[_0x19dc1f(0x1b9)]||null),_0x852b7b[_0x19dc1f(0x1ac)]!==undefined&&(_0x2c50c7[_0x19dc1f(0x1ac)]=_0x852b7b['webhookEvents']||[]),await database_1[_0x19dc1f(0x1c7)][_0x19dc1f(0x195)][_0x19dc1f(0x18d)]({'where':{'shopId':_0x56a809},'data':_0x2c50c7});}async['revokeAllApiKeys'](_0x5e81e6){const _0x42d4c5=a47_0x2da502,_0xc6cc17='pk_'+crypto_1['default']['randomBytes'](0x20)[_0x42d4c5(0x194)]('hex'),_0x1ebba6=_0x42d4c5(0x197)+crypto_1[_0x42d4c5(0x1c7)][_0x42d4c5(0x18c)](0x20)[_0x42d4c5(0x194)](_0x42d4c5(0x19a));await database_1[_0x42d4c5(0x1c7)][_0x42d4c5(0x199)][_0x42d4c5(0x18d)]({'where':{'id':_0x5e81e6},'data':{'publicKey':_0xc6cc17,'secretKey':_0x1ebba6}});}async['deleteAccount'](_0x1d921c,_0x7c3c51){const _0x1c527f=a47_0x2da502,{passwordConfirmation:_0x4e1d5c}=_0x7c3c51,_0x55753f=await database_1[_0x1c527f(0x1c7)][_0x1c527f(0x199)]['findUnique']({'where':{'id':_0x1d921c},'select':{'password':!![]}});if(!_0x55753f)throw new Error(_0x1c527f(0x1bc));const _0x19f60d=await bcryptjs_1[_0x1c527f(0x1c7)][_0x1c527f(0x1be)](_0x4e1d5c,_0x55753f[_0x1c527f(0x1a9)]);if(!_0x19f60d)throw new Error(_0x1c527f(0x18f));await database_1[_0x1c527f(0x1c7)][_0x1c527f(0x199)]['delete']({'where':{'id':_0x1d921c}});}async[a47_0x2da502(0x1aa)](_0x305a29){const _0x5bebcf=a47_0x2da502,_0x34ff19=await database_1[_0x5bebcf(0x1c7)]['shopSettings'][_0x5bebcf(0x1c0)]({'where':{'shopId':_0x305a29}});!_0x34ff19&&await database_1[_0x5bebcf(0x1c7)][_0x5bebcf(0x195)][_0x5bebcf(0x1a5)]({'data':{'shopId':_0x305a29}});}}exports['SettingsService']=SettingsService;