'use strict';const a76_0x26f8d7=a76_0x4e6e;(function(_0x3656b0,_0x125461){const _0x2b9220=a76_0x4e6e,_0x19a1f1=_0x3656b0();while(!![]){try{const _0x2321cb=parseInt(_0x2b9220(0x16e))/0x1*(-parseInt(_0x2b9220(0x187))/0x2)+-parseInt(_0x2b9220(0x196))/0x3+-parseInt(_0x2b9220(0x163))/0x4+parseInt(_0x2b9220(0x17e))/0x5+-parseInt(_0x2b9220(0x18b))/0x6*(parseInt(_0x2b9220(0x17c))/0x7)+parseInt(_0x2b9220(0x19b))/0x8+parseInt(_0x2b9220(0x15a))/0x9;if(_0x2321cb===_0x125461)break;else _0x19a1f1['push'](_0x19a1f1['shift']());}catch(_0x34ca27){_0x19a1f1['push'](_0x19a1f1['shift']());}}}(a76_0x4d7a,0x9cae5));var __importDefault=this&&this['__importDefault']||function(_0x466bf6){return _0x466bf6&&_0x466bf6['__esModule']?_0x466bf6:{'default':_0x466bf6};};function a76_0x4e6e(_0x4d5b1b,_0x1413fc){_0x4d5b1b=_0x4d5b1b-0x14e;const _0x4d7ab1=a76_0x4d7a();let _0x4e6e44=_0x4d7ab1[_0x4d5b1b];return _0x4e6e44;}Object['defineProperty'](exports,a76_0x26f8d7(0x151),{'value':!![]}),exports[a76_0x26f8d7(0x17d)]=void 0x0;const bcryptjs_1=__importDefault(require(a76_0x26f8d7(0x170))),crypto_1=__importDefault(require('crypto')),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a76_0x26f8d7(0x185)));class SettingsService{[a76_0x26f8d7(0x156)](_0x4b2359){const _0x71730e=a76_0x26f8d7;if(!_0x4b2359)return'';if(_0x4b2359['length']<=0x8)return _0x4b2359;const _0x4bfb54=_0x4b2359[_0x71730e(0x165)](0x0,0x8),_0x2ee583='*'[_0x71730e(0x16c)](Math[_0x71730e(0x182)](0x0,_0x4b2359[_0x71730e(0x199)]-0x8));return _0x4bfb54+_0x2ee583;}[a76_0x26f8d7(0x152)](_0x482e0c){const _0x51606c=a76_0x26f8d7;if(!_0x482e0c)return[];if(Array[_0x51606c(0x17a)](_0x482e0c))return _0x482e0c;if(typeof _0x482e0c===_0x51606c(0x176))try{const _0x51825a=JSON[_0x51606c(0x18f)](_0x482e0c);return Array[_0x51606c(0x17a)](_0x51825a)?_0x51825a:[];}catch{return[];}return[];}async[a76_0x26f8d7(0x178)](_0x15d2b2){const _0x12735b=a76_0x26f8d7,_0x56ff46=await database_1[_0x12735b(0x154)][_0x12735b(0x157)][_0x12735b(0x19a)]({'where':{'id':_0x15d2b2},'include':{'settings':!![]}});if(!_0x56ff46)throw new Error(_0x12735b(0x16d));let _0x5ddc98=_0x56ff46[_0x12735b(0x160)];return!_0x5ddc98&&(_0x5ddc98=await database_1[_0x12735b(0x154)][_0x12735b(0x191)][_0x12735b(0x18a)]({'data':{'shopId':_0x56ff46['id']}})),{'fullName':_0x56ff46[_0x12735b(0x197)],'brand':_0x56ff46['name'],'merchantUrl':_0x56ff46['shopUrl'],'telegramUsername':_0x56ff46[_0x12735b(0x155)],'telegramBotApiKey':_0x5ddc98[_0x12735b(0x188)]?this[_0x12735b(0x156)](_0x5ddc98[_0x12735b(0x188)]):null,'telegramChatId':_0x5ddc98[_0x12735b(0x15e)],'webhookUrl':_0x5ddc98[_0x12735b(0x14e)],'webhookEvents':this['parseWebhookEvents'](_0x5ddc98[_0x12735b(0x18e)]),'twoFactorEnabled':_0x56ff46[_0x12735b(0x180)]||![],'notifications':{'payment_success':_0x5ddc98[_0x12735b(0x174)],'payment_failed':_0x5ddc98[_0x12735b(0x189)],'refund':_0x5ddc98['notificationRefund'],'payout':_0x5ddc98['notificationPayout'],'login':_0x5ddc98[_0x12735b(0x193)],'api_error':_0x5ddc98[_0x12735b(0x169)]}};}async[a76_0x26f8d7(0x166)](_0x1006e1,_0x2e4b56){const _0x5f136f=a76_0x26f8d7,{currentPassword:_0x3543f5,newPassword:_0x5cbb9c,confirmNewPassword:_0x3ff959,twoFactorToken:_0x51b2de}=_0x2e4b56;if(_0x5cbb9c!==_0x3ff959)throw new Error(_0x5f136f(0x167));if(_0x5cbb9c[_0x5f136f(0x199)]<0x6)throw new Error(_0x5f136f(0x16b));const _0x275441=await database_1[_0x5f136f(0x154)][_0x5f136f(0x157)][_0x5f136f(0x19a)]({'where':{'id':_0x1006e1},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x275441)throw new Error(_0x5f136f(0x16d));if(_0x275441[_0x5f136f(0x180)]){if(!_0x51b2de)throw new Error('2FA\x20token\x20is\x20required');const _0x1a401a=speakeasy_1[_0x5f136f(0x154)][_0x5f136f(0x168)][_0x5f136f(0x15b)]({'secret':_0x275441['twoFactorSecret'],'encoding':_0x5f136f(0x190),'token':_0x51b2de,'window':0x2});if(!_0x1a401a){let _0x2b376c=![];if(_0x275441['backupCodes']){const _0x2ca92d=JSON[_0x5f136f(0x18f)](_0x275441['backupCodes']);for(let _0xd57bc7=0x0;_0xd57bc7<_0x2ca92d['length'];_0xd57bc7++){const _0x435d1a=await bcryptjs_1[_0x5f136f(0x154)][_0x5f136f(0x15c)](_0x51b2de,_0x2ca92d[_0xd57bc7]);if(_0x435d1a){_0x2b376c=!![],_0x2ca92d[_0x5f136f(0x192)](_0xd57bc7,0x1),await database_1['default'][_0x5f136f(0x157)][_0x5f136f(0x159)]({'where':{'id':_0x1006e1},'data':{'backupCodes':JSON[_0x5f136f(0x164)](_0x2ca92d)}});break;}}}if(!_0x2b376c)throw new Error(_0x5f136f(0x15f));}}const _0x111224=await bcryptjs_1[_0x5f136f(0x154)]['compare'](_0x3543f5,_0x275441[_0x5f136f(0x175)]);if(!_0x111224)throw new Error(_0x5f136f(0x17f));const _0x552f7b=await bcryptjs_1['default'][_0x5f136f(0x171)](_0x5cbb9c,0xc);await database_1[_0x5f136f(0x154)][_0x5f136f(0x157)]['update']({'where':{'id':_0x1006e1},'data':{'password':_0x552f7b}});}async[a76_0x26f8d7(0x183)](_0xdc5f84,_0xd99290){const _0x3b85a9=a76_0x26f8d7;await this[_0x3b85a9(0x150)](_0xdc5f84);const _0x1e8720={};_0xd99290[_0x3b85a9(0x153)]!==undefined&&(_0x1e8720[_0x3b85a9(0x174)]=_0xd99290[_0x3b85a9(0x153)]),_0xd99290[_0x3b85a9(0x17b)]!==undefined&&(_0x1e8720['notificationPaymentFailed']=_0xd99290['payment_failed']),_0xd99290[_0x3b85a9(0x194)]!==undefined&&(_0x1e8720[_0x3b85a9(0x179)]=_0xd99290[_0x3b85a9(0x194)]),_0xd99290['payout']!==undefined&&(_0x1e8720['notificationPayout']=_0xd99290[_0x3b85a9(0x184)]),_0xd99290[_0x3b85a9(0x195)]!==undefined&&(_0x1e8720[_0x3b85a9(0x193)]=_0xd99290[_0x3b85a9(0x195)]),_0xd99290['api_error']!==undefined&&(_0x1e8720[_0x3b85a9(0x169)]=_0xd99290[_0x3b85a9(0x18c)]),await database_1[_0x3b85a9(0x154)]['shopSettings'][_0x3b85a9(0x159)]({'where':{'shopId':_0xdc5f84},'data':_0x1e8720});}async[a76_0x26f8d7(0x158)](_0x253c57,_0x2b6685){const _0x5bb503=a76_0x26f8d7;await this['ensureSettingsExist'](_0x253c57);const _0x451722={};_0x2b6685[_0x5bb503(0x19c)]!==undefined&&(_0x451722['telegramBotApiKey']=_0x2b6685['botApiKey']||null),_0x2b6685[_0x5bb503(0x18d)]!==undefined&&(_0x451722['telegramChatId']=_0x2b6685[_0x5bb503(0x18d)]||null),await database_1[_0x5bb503(0x154)]['shopSettings'][_0x5bb503(0x159)]({'where':{'shopId':_0x253c57},'data':_0x451722});}async['updateWebhookSettings'](_0xadb43,_0x5c23f6){const _0x3e265c=a76_0x26f8d7;await this['ensureSettingsExist'](_0xadb43);const _0x13d950={};_0x5c23f6[_0x3e265c(0x14e)]!==undefined&&(_0x13d950[_0x3e265c(0x14e)]=_0x5c23f6['webhookUrl']||null),_0x5c23f6[_0x3e265c(0x18e)]!==undefined&&(_0x13d950['webhookEvents']=_0x5c23f6[_0x3e265c(0x18e)]||[]),await database_1[_0x3e265c(0x154)][_0x3e265c(0x191)]['update']({'where':{'shopId':_0xadb43},'data':_0x13d950});}async[a76_0x26f8d7(0x173)](_0x8260c1,_0x789afd){const _0x51d083=a76_0x26f8d7,_0x38a353=await database_1[_0x51d083(0x154)][_0x51d083(0x157)]['findUnique']({'where':{'id':_0x8260c1},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x38a353)throw new Error(_0x51d083(0x16d));if(_0x38a353[_0x51d083(0x180)]){if(!_0x789afd)throw new Error(_0x51d083(0x161));const _0x5d1ecb=speakeasy_1[_0x51d083(0x154)]['totp']['verify']({'secret':_0x38a353[_0x51d083(0x198)],'encoding':_0x51d083(0x190),'token':_0x789afd,'window':0x2});if(!_0x5d1ecb){let _0xe21152=![];if(_0x38a353[_0x51d083(0x181)]){const _0x10c103=JSON[_0x51d083(0x18f)](_0x38a353[_0x51d083(0x181)]);for(let _0x3a2102=0x0;_0x3a2102<_0x10c103['length'];_0x3a2102++){const _0x31e23a=await bcryptjs_1['default'][_0x51d083(0x15c)](_0x789afd,_0x10c103[_0x3a2102]);if(_0x31e23a){_0xe21152=!![],_0x10c103[_0x51d083(0x192)](_0x3a2102,0x1),await database_1[_0x51d083(0x154)][_0x51d083(0x157)][_0x51d083(0x159)]({'where':{'id':_0x8260c1},'data':{'backupCodes':JSON[_0x51d083(0x164)](_0x10c103)}});break;}}}if(!_0xe21152)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x278385=_0x51d083(0x172)+crypto_1[_0x51d083(0x154)][_0x51d083(0x16a)](0x20)[_0x51d083(0x14f)]('hex'),_0x4bd480=_0x51d083(0x186)+crypto_1['default'][_0x51d083(0x16a)](0x20)[_0x51d083(0x14f)](_0x51d083(0x16f));await database_1[_0x51d083(0x154)][_0x51d083(0x157)][_0x51d083(0x159)]({'where':{'id':_0x8260c1},'data':{'publicKey':_0x278385,'secretKey':_0x4bd480}});}async[a76_0x26f8d7(0x162)](_0x4f189f,_0x1fdec2){const _0x4df451=a76_0x26f8d7,{passwordConfirmation:_0x3e0865}=_0x1fdec2,_0x54ddb9=await database_1[_0x4df451(0x154)][_0x4df451(0x157)][_0x4df451(0x19a)]({'where':{'id':_0x4f189f},'select':{'password':!![]}});if(!_0x54ddb9)throw new Error(_0x4df451(0x16d));const _0x5ddb10=await bcryptjs_1['default'][_0x4df451(0x15c)](_0x3e0865,_0x54ddb9[_0x4df451(0x175)]);if(!_0x5ddb10)throw new Error(_0x4df451(0x15d));await database_1[_0x4df451(0x154)][_0x4df451(0x157)][_0x4df451(0x177)]({'where':{'id':_0x4f189f}});}async[a76_0x26f8d7(0x150)](_0x18a48a){const _0x3c0903=a76_0x26f8d7,_0x4494e8=await database_1[_0x3c0903(0x154)]['shopSettings']['findUnique']({'where':{'shopId':_0x18a48a}});!_0x4494e8&&await database_1[_0x3c0903(0x154)][_0x3c0903(0x191)][_0x3c0903(0x18a)]({'data':{'shopId':_0x18a48a}});}}exports[a76_0x26f8d7(0x17d)]=SettingsService;function a76_0x4d7a(){const _0x156733=['ensureSettingsExist','__esModule','parseWebhookEvents','payment_success','default','telegram','maskApiKey','shop','updateTelegramSettings','update','16814151abRcjr','verify','compare','Password\x20confirmation\x20is\x20incorrect','telegramChatId','Invalid\x202FA\x20token\x20or\x20backup\x20code','settings','2FA\x20token\x20is\x20required','deleteAccount','1164352FDRcBg','stringify','substring','changePassword','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','totp','notificationApiError','randomBytes','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','repeat','Shop\x20not\x20found','4765TDVGQY','hex','bcryptjs','hash','pk_','revokeAllApiKeys','notificationPaymentSuccess','password','string','delete','getShopSettings','notificationRefund','isArray','payment_failed','378ThLxyh','SettingsService','1770245fYlkfm','Current\x20password\x20is\x20incorrect','twoFactorEnabled','backupCodes','max','updateNotifications','payout','../config/database','sk_','214CrujaN','telegramBotApiKey','notificationPaymentFailed','create','42888RGjdeL','api_error','chatId','webhookEvents','parse','base32','shopSettings','splice','notificationLogin','refund','login','1571223MDfMlb','name','twoFactorSecret','length','findUnique','1041224Wdcsik','botApiKey','webhookUrl','toString'];a76_0x4d7a=function(){return _0x156733;};return a76_0x4d7a();}