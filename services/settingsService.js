'use strict';const a81_0x2beccf=a81_0x1c0c;function a81_0x2bbf(){const _0x3b19f5=['../config/database','refund','findMany','pk_','crypto','update','94789abuEHQ','compare','webhookUrl','toString','15ZThDQs','3799948IyQvEe','updateNotifications','__esModule','notificationPayout','shopSettings','settings','string','notificationRefund','telegramUser','randomBytes','5094972BQaJmO','1208988wYcSIc','botApiKey','2312200MQNBcl','stringify','__importDefault','length','SettingsService','defineProperty','Unauthorized\x20to\x20disconnect\x20this\x20session','isArray','disconnectTelegramSession','3140720IkXGRR','Shop\x20not\x20found','splice','shopUrl','verify','shopId','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','api_error','6032250MtWClf','chatId','login','backupCodes','3TnFatH','desc','payment_success','changePassword','updateWebhookSettings','sk_','default','_count','twoFactorSecret','webhookEvents','findUnique','parse','notificationPaymentFailed','revokeAllApiKeys','notificationPaymentSuccess','Telegram\x20session\x20not\x20found','twoFactorEnabled','2FA\x20token\x20is\x20required','getTelegramSessions','notificationLogin','hex','shop','deleteAccount','delete','parseWebhookEvents','telegramBotApiKey','maskApiKey','payout','payment_failed','totp','telegramChatId','name','ensureSettingsExist','base32','telegram','substring','telegramUsers','getShopSettings','2IbUiid'];a81_0x2bbf=function(){return _0x3b19f5;};return a81_0x2bbf();}(function(_0xdf2425,_0x35968e){const _0x3527ca=a81_0x1c0c,_0x4f82af=_0xdf2425();while(!![]){try{const _0x5d9ea4=parseInt(_0x3527ca(0x23d))/0x1*(parseInt(_0x3527ca(0x236))/0x2)+parseInt(_0x3527ca(0x210))/0x3*(-parseInt(_0x3527ca(0x242))/0x4)+parseInt(_0x3527ca(0x241))/0x5*(-parseInt(_0x3527ca(0x1f9))/0x6)+parseInt(_0x3527ca(0x20c))/0x7+parseInt(_0x3527ca(0x1fb))/0x8+parseInt(_0x3527ca(0x1f8))/0x9+parseInt(_0x3527ca(0x204))/0xa;if(_0x5d9ea4===_0x35968e)break;else _0x4f82af['push'](_0x4f82af['shift']());}catch(_0xac4231){_0x4f82af['push'](_0x4f82af['shift']());}}}(a81_0x2bbf,0x8b77f));var __importDefault=this&&this[a81_0x2beccf(0x1fd)]||function(_0x35b697){const _0x53daf=a81_0x2beccf;return _0x35b697&&_0x35b697[_0x53daf(0x244)]?_0x35b697:{'default':_0x35b697};};Object[a81_0x2beccf(0x200)](exports,a81_0x2beccf(0x244),{'value':!![]}),exports[a81_0x2beccf(0x1ff)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a81_0x2beccf(0x23b))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a81_0x2beccf(0x237)));class SettingsService{[a81_0x2beccf(0x22a)](_0x3c3c19){const _0xa2b45b=a81_0x2beccf;if(!_0x3c3c19)return'';if(_0x3c3c19['length']<=0x8)return _0x3c3c19;const _0x46684b=_0x3c3c19[_0xa2b45b(0x233)](0x0,0x8),_0x13b74a='*'['repeat'](Math['max'](0x0,_0x3c3c19[_0xa2b45b(0x1fe)]-0x8));return _0x46684b+_0x13b74a;}[a81_0x2beccf(0x228)](_0x4446b8){const _0x240b3d=a81_0x2beccf;if(!_0x4446b8)return[];if(Array[_0x240b3d(0x202)](_0x4446b8))return _0x4446b8;if(typeof _0x4446b8===_0x240b3d(0x1f4))try{const _0x17d92b=JSON[_0x240b3d(0x21b)](_0x4446b8);return Array[_0x240b3d(0x202)](_0x17d92b)?_0x17d92b:[];}catch{return[];}return[];}async[a81_0x2beccf(0x235)](_0x52ad41){const _0x3dfae6=a81_0x2beccf,_0xb7ebf8=await database_1[_0x3dfae6(0x216)]['shop']['findUnique']({'where':{'id':_0x52ad41},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0xb7ebf8)throw new Error(_0x3dfae6(0x205));let _0x5aa1cd=_0xb7ebf8[_0x3dfae6(0x1f3)];return!_0x5aa1cd&&(_0x5aa1cd=await database_1[_0x3dfae6(0x216)][_0x3dfae6(0x1f2)]['create']({'data':{'shopId':_0xb7ebf8['id']}})),{'fullName':_0xb7ebf8[_0x3dfae6(0x22f)],'brand':_0xb7ebf8[_0x3dfae6(0x22f)],'merchantUrl':_0xb7ebf8[_0x3dfae6(0x207)],'telegramUsername':_0xb7ebf8[_0x3dfae6(0x232)],'telegramBotApiKey':_0x5aa1cd['telegramBotApiKey']?this['maskApiKey'](_0x5aa1cd[_0x3dfae6(0x229)]):null,'telegramChatId':_0x5aa1cd['telegramChatId'],'telegramUsersCount':_0xb7ebf8[_0x3dfae6(0x217)][_0x3dfae6(0x234)],'webhookUrl':_0x5aa1cd[_0x3dfae6(0x23f)],'webhookEvents':this['parseWebhookEvents'](_0x5aa1cd[_0x3dfae6(0x219)]),'twoFactorEnabled':_0xb7ebf8[_0x3dfae6(0x220)]||![],'notifications':{'payment_success':_0x5aa1cd[_0x3dfae6(0x21e)],'payment_failed':_0x5aa1cd[_0x3dfae6(0x21c)],'refund':_0x5aa1cd[_0x3dfae6(0x1f5)],'payout':_0x5aa1cd[_0x3dfae6(0x1f1)],'login':_0x5aa1cd[_0x3dfae6(0x223)],'api_error':_0x5aa1cd['notificationApiError']}};}async[a81_0x2beccf(0x213)](_0x34c25b,_0x501d4c){const _0x406dab=a81_0x2beccf,{currentPassword:_0x52a561,newPassword:_0x283765,confirmNewPassword:_0x2c1b4a,twoFactorToken:_0x5976b0}=_0x501d4c;if(_0x283765!==_0x2c1b4a)throw new Error(_0x406dab(0x20a));if(_0x283765['length']<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x274549=await database_1['default']['shop'][_0x406dab(0x21a)]({'where':{'id':_0x34c25b},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x274549)throw new Error('Shop\x20not\x20found');if(_0x274549[_0x406dab(0x220)]){if(!_0x5976b0)throw new Error(_0x406dab(0x221));const _0x2f48ff=speakeasy_1['default'][_0x406dab(0x22d)][_0x406dab(0x208)]({'secret':_0x274549[_0x406dab(0x218)],'encoding':'base32','token':_0x5976b0,'window':0x2});if(!_0x2f48ff){let _0x4830b3=![];if(_0x274549[_0x406dab(0x20f)]){const _0x4bfcbb=JSON[_0x406dab(0x21b)](_0x274549[_0x406dab(0x20f)]);for(let _0x548bc7=0x0;_0x548bc7<_0x4bfcbb[_0x406dab(0x1fe)];_0x548bc7++){const _0x31213f=await bcryptjs_1[_0x406dab(0x216)][_0x406dab(0x23e)](_0x5976b0,_0x4bfcbb[_0x548bc7]);if(_0x31213f){_0x4830b3=!![],_0x4bfcbb[_0x406dab(0x206)](_0x548bc7,0x1),await database_1[_0x406dab(0x216)][_0x406dab(0x225)][_0x406dab(0x23c)]({'where':{'id':_0x34c25b},'data':{'backupCodes':JSON[_0x406dab(0x1fc)](_0x4bfcbb)}});break;}}}if(!_0x4830b3)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x3b22ee=await bcryptjs_1[_0x406dab(0x216)][_0x406dab(0x23e)](_0x52a561,_0x274549['password']);if(!_0x3b22ee)throw new Error('Current\x20password\x20is\x20incorrect');const _0x1a8084=await bcryptjs_1[_0x406dab(0x216)]['hash'](_0x283765,0xc);await database_1['default'][_0x406dab(0x225)]['update']({'where':{'id':_0x34c25b},'data':{'password':_0x1a8084}});}async[a81_0x2beccf(0x243)](_0x2a7530,_0x110454){const _0x26d770=a81_0x2beccf;await this[_0x26d770(0x230)](_0x2a7530);const _0x334088={};_0x110454[_0x26d770(0x212)]!==undefined&&(_0x334088[_0x26d770(0x21e)]=_0x110454['payment_success']),_0x110454[_0x26d770(0x22c)]!==undefined&&(_0x334088[_0x26d770(0x21c)]=_0x110454[_0x26d770(0x22c)]),_0x110454[_0x26d770(0x238)]!==undefined&&(_0x334088[_0x26d770(0x1f5)]=_0x110454[_0x26d770(0x238)]),_0x110454[_0x26d770(0x22b)]!==undefined&&(_0x334088[_0x26d770(0x1f1)]=_0x110454[_0x26d770(0x22b)]),_0x110454[_0x26d770(0x20e)]!==undefined&&(_0x334088[_0x26d770(0x223)]=_0x110454[_0x26d770(0x20e)]),_0x110454[_0x26d770(0x20b)]!==undefined&&(_0x334088['notificationApiError']=_0x110454[_0x26d770(0x20b)]),await database_1['default']['shopSettings'][_0x26d770(0x23c)]({'where':{'shopId':_0x2a7530},'data':_0x334088});}async['updateTelegramSettings'](_0x25edf6,_0x4c5c03){const _0x9ee6b5=a81_0x2beccf;await this[_0x9ee6b5(0x230)](_0x25edf6);const _0x47c42a={};_0x4c5c03[_0x9ee6b5(0x1fa)]!==undefined&&(_0x47c42a[_0x9ee6b5(0x229)]=_0x4c5c03['botApiKey']||null),_0x4c5c03[_0x9ee6b5(0x20d)]!==undefined&&(_0x47c42a[_0x9ee6b5(0x22e)]=_0x4c5c03[_0x9ee6b5(0x20d)]||null),await database_1[_0x9ee6b5(0x216)][_0x9ee6b5(0x1f2)]['update']({'where':{'shopId':_0x25edf6},'data':_0x47c42a});}async[a81_0x2beccf(0x214)](_0x5ee406,_0x5bd3ac){const _0x3918af=a81_0x2beccf;await this[_0x3918af(0x230)](_0x5ee406);const _0x53b756={};_0x5bd3ac['webhookUrl']!==undefined&&(_0x53b756[_0x3918af(0x23f)]=_0x5bd3ac['webhookUrl']||null),_0x5bd3ac[_0x3918af(0x219)]!==undefined&&(_0x53b756[_0x3918af(0x219)]=_0x5bd3ac[_0x3918af(0x219)]||[]),await database_1[_0x3918af(0x216)][_0x3918af(0x1f2)]['update']({'where':{'shopId':_0x5ee406},'data':_0x53b756});}async[a81_0x2beccf(0x21d)](_0x27d338,_0x4b4a4d){const _0x5cc700=a81_0x2beccf,_0x12cafe=await database_1['default'][_0x5cc700(0x225)][_0x5cc700(0x21a)]({'where':{'id':_0x27d338},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x12cafe)throw new Error(_0x5cc700(0x205));if(_0x12cafe['twoFactorEnabled']){if(!_0x4b4a4d)throw new Error('2FA\x20token\x20is\x20required');const _0x4109c3=speakeasy_1[_0x5cc700(0x216)][_0x5cc700(0x22d)]['verify']({'secret':_0x12cafe[_0x5cc700(0x218)],'encoding':_0x5cc700(0x231),'token':_0x4b4a4d,'window':0x2});if(!_0x4109c3){let _0x5dd4c4=![];if(_0x12cafe[_0x5cc700(0x20f)]){const _0x594a70=JSON['parse'](_0x12cafe[_0x5cc700(0x20f)]);for(let _0x57f162=0x0;_0x57f162<_0x594a70[_0x5cc700(0x1fe)];_0x57f162++){const _0x48fea6=await bcryptjs_1[_0x5cc700(0x216)][_0x5cc700(0x23e)](_0x4b4a4d,_0x594a70[_0x57f162]);if(_0x48fea6){_0x5dd4c4=!![],_0x594a70[_0x5cc700(0x206)](_0x57f162,0x1),await database_1[_0x5cc700(0x216)][_0x5cc700(0x225)][_0x5cc700(0x23c)]({'where':{'id':_0x27d338},'data':{'backupCodes':JSON[_0x5cc700(0x1fc)](_0x594a70)}});break;}}}if(!_0x5dd4c4)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x58f45f=_0x5cc700(0x23a)+crypto_1[_0x5cc700(0x216)]['randomBytes'](0x20)[_0x5cc700(0x240)](_0x5cc700(0x224)),_0x468b97=_0x5cc700(0x215)+crypto_1[_0x5cc700(0x216)][_0x5cc700(0x1f7)](0x20)[_0x5cc700(0x240)](_0x5cc700(0x224));await database_1['default'][_0x5cc700(0x225)][_0x5cc700(0x23c)]({'where':{'id':_0x27d338},'data':{'publicKey':_0x58f45f,'secretKey':_0x468b97}});}async[a81_0x2beccf(0x226)](_0x4056a3,_0x5533c4){const _0x3be71c=a81_0x2beccf,{passwordConfirmation:_0x190137}=_0x5533c4,_0x17dab6=await database_1[_0x3be71c(0x216)][_0x3be71c(0x225)][_0x3be71c(0x21a)]({'where':{'id':_0x4056a3},'select':{'password':!![]}});if(!_0x17dab6)throw new Error('Shop\x20not\x20found');const _0xd21e64=await bcryptjs_1[_0x3be71c(0x216)][_0x3be71c(0x23e)](_0x190137,_0x17dab6['password']);if(!_0xd21e64)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x3be71c(0x216)][_0x3be71c(0x225)][_0x3be71c(0x227)]({'where':{'id':_0x4056a3}});}async[a81_0x2beccf(0x222)](_0x4986d8){const _0xc335c=a81_0x2beccf,_0xda06f7=await database_1['default'][_0xc335c(0x1f6)][_0xc335c(0x239)]({'where':{'shopId':_0x4986d8,'isVerified':!![]},'orderBy':{'createdAt':_0xc335c(0x211)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0xda06f7;}async[a81_0x2beccf(0x203)](_0x2b6731,_0x4627fa){const _0x5a181d=a81_0x2beccf,_0x5033ec=await database_1[_0x5a181d(0x216)]['telegramUser'][_0x5a181d(0x21a)]({'where':{'id':_0x4627fa},'select':{'shopId':!![]}});if(!_0x5033ec)throw new Error(_0x5a181d(0x21f));if(_0x5033ec[_0x5a181d(0x209)]!==_0x2b6731)throw new Error(_0x5a181d(0x201));await database_1[_0x5a181d(0x216)][_0x5a181d(0x1f6)][_0x5a181d(0x23c)]({'where':{'id':_0x4627fa},'data':{'shopId':null,'isVerified':![]}});}async[a81_0x2beccf(0x230)](_0x2d0428){const _0x19c1a0=a81_0x2beccf,_0x2fc50f=await database_1[_0x19c1a0(0x216)]['shopSettings'][_0x19c1a0(0x21a)]({'where':{'shopId':_0x2d0428}});!_0x2fc50f&&await database_1[_0x19c1a0(0x216)][_0x19c1a0(0x1f2)]['create']({'data':{'shopId':_0x2d0428}});}}function a81_0x1c0c(_0x3d5bd0,_0x38ffe8){_0x3d5bd0=_0x3d5bd0-0x1f1;const _0x2bbf7b=a81_0x2bbf();let _0x1c0cc4=_0x2bbf7b[_0x3d5bd0];return _0x1c0cc4;}exports[a81_0x2beccf(0x1ff)]=SettingsService;