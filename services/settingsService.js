'use strict';const a53_0x30193d=a53_0x322c;function a53_0x3c1f(){const _0x40ac9b=['api_error','__importDefault','notificationRefund','payment_success','updateTelegramSettings','compare','getShopSettings','create','794847vCRblQ','update','crypto','deleteAccount','sk_','626244NLPCbv','length','notificationPaymentFailed','default','chatId','toString','2122778fZWaqW','botApiKey','352MrWpvw','1740MyhAbL','notificationPaymentSuccess','2997nQNXIg','hash','26259SWqkQB','ensureSettingsExist','updateWebhookSettings','randomBytes','password','login','string','shopSettings','notificationLogin','name','maskApiKey','payment_failed','10sopvMY','notificationApiError','2336ydiocQ','shop','Current\x20password\x20is\x20incorrect','1427730TOEBPg','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','__esModule','telegramChatId','webhookUrl','SettingsService','72204tDnXoA','defineProperty','parseWebhookEvents','max','notificationPayout','refund','isArray','Shop\x20not\x20found','webhookEvents','substring','payout','changePassword','revokeAllApiKeys','parse','telegramBotApiKey'];a53_0x3c1f=function(){return _0x40ac9b;};return a53_0x3c1f();}(function(_0x3451c7,_0x473114){const _0x5b0b3b=a53_0x322c,_0x5db9fd=_0x3451c7();while(!![]){try{const _0x42546b=-parseInt(_0x5b0b3b(0x1c1))/0x1+-parseInt(_0x5b0b3b(0x1c6))/0x2+parseInt(_0x5b0b3b(0x193))/0x3*(parseInt(_0x5b0b3b(0x18e))/0x4)+parseInt(_0x5b0b3b(0x19f))/0x5*(-parseInt(_0x5b0b3b(0x1a4))/0x6)+parseInt(_0x5b0b3b(0x1cc))/0x7+-parseInt(_0x5b0b3b(0x1a1))/0x8*(parseInt(_0x5b0b3b(0x191))/0x9)+parseInt(_0x5b0b3b(0x18f))/0xa*(parseInt(_0x5b0b3b(0x1aa))/0xb);if(_0x42546b===_0x473114)break;else _0x5db9fd['push'](_0x5db9fd['shift']());}catch(_0x439a64){_0x5db9fd['push'](_0x5db9fd['shift']());}}}(a53_0x3c1f,0x8280b));var __importDefault=this&&this[a53_0x30193d(0x1ba)]||function(_0x680bc7){const _0xdd775c=a53_0x30193d;return _0x680bc7&&_0x680bc7[_0xdd775c(0x1a6)]?_0x680bc7:{'default':_0x680bc7};};Object[a53_0x30193d(0x1ab)](exports,a53_0x30193d(0x1a6),{'value':!![]}),exports[a53_0x30193d(0x1a9)]=void 0x0;function a53_0x322c(_0x16c3ce,_0x31c1bb){const _0x3c1fc8=a53_0x3c1f();return a53_0x322c=function(_0x322c46,_0x493d56){_0x322c46=_0x322c46-0x18d;let _0x2b59e4=_0x3c1fc8[_0x322c46];return _0x2b59e4;},a53_0x322c(_0x16c3ce,_0x31c1bb);}const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a53_0x30193d(0x1c3))),database_1=__importDefault(require('../config/database'));class SettingsService{[a53_0x30193d(0x19d)](_0xcea244){const _0x3e51ee=a53_0x30193d;if(!_0xcea244)return'';if(_0xcea244[_0x3e51ee(0x1c7)]<=0x8)return _0xcea244;const _0x2793a2=_0xcea244[_0x3e51ee(0x1b3)](0x0,0x8),_0x379ae7='*'['repeat'](Math[_0x3e51ee(0x1ad)](0x0,_0xcea244[_0x3e51ee(0x1c7)]-0x8));return _0x2793a2+_0x379ae7;}[a53_0x30193d(0x1ac)](_0x6552c9){const _0x1dfe06=a53_0x30193d;if(!_0x6552c9)return[];if(Array[_0x1dfe06(0x1b0)](_0x6552c9))return _0x6552c9;if(typeof _0x6552c9===_0x1dfe06(0x199))try{const _0x4377a6=JSON[_0x1dfe06(0x1b7)](_0x6552c9);return Array[_0x1dfe06(0x1b0)](_0x4377a6)?_0x4377a6:[];}catch{return[];}return[];}async[a53_0x30193d(0x1bf)](_0x18ad8c){const _0x4f074b=a53_0x30193d,_0x234e87=await database_1[_0x4f074b(0x1c9)][_0x4f074b(0x1a2)]['findUnique']({'where':{'id':_0x18ad8c},'include':{'settings':!![]}});if(!_0x234e87)throw new Error(_0x4f074b(0x1b1));let _0x17a08f=_0x234e87['settings'];return!_0x17a08f&&(_0x17a08f=await database_1[_0x4f074b(0x1c9)]['shopSettings'][_0x4f074b(0x1c0)]({'data':{'shopId':_0x234e87['id']}})),{'fullName':_0x234e87['name'],'brand':_0x234e87[_0x4f074b(0x19c)],'merchantUrl':_0x234e87['shopUrl'],'telegramUsername':_0x234e87['telegram'],'telegramBotApiKey':_0x17a08f['telegramBotApiKey']?this['maskApiKey'](_0x17a08f[_0x4f074b(0x1b8)]):null,'telegramChatId':_0x17a08f[_0x4f074b(0x1a7)],'webhookUrl':_0x17a08f['webhookUrl'],'webhookEvents':this[_0x4f074b(0x1ac)](_0x17a08f[_0x4f074b(0x1b2)]),'notifications':{'payment_success':_0x17a08f[_0x4f074b(0x190)],'payment_failed':_0x17a08f['notificationPaymentFailed'],'refund':_0x17a08f['notificationRefund'],'payout':_0x17a08f['notificationPayout'],'login':_0x17a08f[_0x4f074b(0x19b)],'api_error':_0x17a08f[_0x4f074b(0x1a0)]}};}async[a53_0x30193d(0x1b5)](_0xcb6982,_0x120be3){const _0x77c1f7=a53_0x30193d,{currentPassword:_0x1ab836,newPassword:_0x352ad6,confirmNewPassword:_0x124c19}=_0x120be3;if(_0x352ad6!==_0x124c19)throw new Error(_0x77c1f7(0x1a5));if(_0x352ad6[_0x77c1f7(0x1c7)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x442cde=await database_1[_0x77c1f7(0x1c9)][_0x77c1f7(0x1a2)]['findUnique']({'where':{'id':_0xcb6982},'select':{'password':!![]}});if(!_0x442cde)throw new Error('Shop\x20not\x20found');const _0x2c21cb=await bcryptjs_1[_0x77c1f7(0x1c9)]['compare'](_0x1ab836,_0x442cde[_0x77c1f7(0x197)]);if(!_0x2c21cb)throw new Error(_0x77c1f7(0x1a3));const _0x1c9554=await bcryptjs_1['default'][_0x77c1f7(0x192)](_0x352ad6,0xc);await database_1['default']['shop']['update']({'where':{'id':_0xcb6982},'data':{'password':_0x1c9554}});}async['updateNotifications'](_0x48563d,_0x555d0f){const _0x17ab31=a53_0x30193d;await this['ensureSettingsExist'](_0x48563d);const _0x3ebbb4={};_0x555d0f['payment_success']!==undefined&&(_0x3ebbb4[_0x17ab31(0x190)]=_0x555d0f[_0x17ab31(0x1bc)]),_0x555d0f[_0x17ab31(0x19e)]!==undefined&&(_0x3ebbb4[_0x17ab31(0x1c8)]=_0x555d0f['payment_failed']),_0x555d0f[_0x17ab31(0x1af)]!==undefined&&(_0x3ebbb4[_0x17ab31(0x1bb)]=_0x555d0f['refund']),_0x555d0f[_0x17ab31(0x1b4)]!==undefined&&(_0x3ebbb4[_0x17ab31(0x1ae)]=_0x555d0f[_0x17ab31(0x1b4)]),_0x555d0f[_0x17ab31(0x198)]!==undefined&&(_0x3ebbb4[_0x17ab31(0x19b)]=_0x555d0f[_0x17ab31(0x198)]),_0x555d0f[_0x17ab31(0x1b9)]!==undefined&&(_0x3ebbb4['notificationApiError']=_0x555d0f[_0x17ab31(0x1b9)]),await database_1['default']['shopSettings'][_0x17ab31(0x1c2)]({'where':{'shopId':_0x48563d},'data':_0x3ebbb4});}async[a53_0x30193d(0x1bd)](_0x13acc9,_0x5d36cc){const _0x4cad51=a53_0x30193d;await this['ensureSettingsExist'](_0x13acc9);const _0x37198e={};_0x5d36cc['botApiKey']!==undefined&&(_0x37198e[_0x4cad51(0x1b8)]=_0x5d36cc[_0x4cad51(0x18d)]||null),_0x5d36cc[_0x4cad51(0x1ca)]!==undefined&&(_0x37198e[_0x4cad51(0x1a7)]=_0x5d36cc['chatId']||null),await database_1[_0x4cad51(0x1c9)][_0x4cad51(0x19a)][_0x4cad51(0x1c2)]({'where':{'shopId':_0x13acc9},'data':_0x37198e});}async[a53_0x30193d(0x195)](_0xf54b97,_0x1dcc16){const _0x35532b=a53_0x30193d;await this[_0x35532b(0x194)](_0xf54b97);const _0x5c5c59={};_0x1dcc16[_0x35532b(0x1a8)]!==undefined&&(_0x5c5c59[_0x35532b(0x1a8)]=_0x1dcc16[_0x35532b(0x1a8)]||null),_0x1dcc16[_0x35532b(0x1b2)]!==undefined&&(_0x5c5c59['webhookEvents']=_0x1dcc16['webhookEvents']||[]),await database_1['default'][_0x35532b(0x19a)][_0x35532b(0x1c2)]({'where':{'shopId':_0xf54b97},'data':_0x5c5c59});}async[a53_0x30193d(0x1b6)](_0x282057){const _0x40e9b7=a53_0x30193d,_0x4a4c16='pk_'+crypto_1[_0x40e9b7(0x1c9)][_0x40e9b7(0x196)](0x20)['toString']('hex'),_0x51a543=_0x40e9b7(0x1c5)+crypto_1[_0x40e9b7(0x1c9)][_0x40e9b7(0x196)](0x20)[_0x40e9b7(0x1cb)]('hex');await database_1[_0x40e9b7(0x1c9)][_0x40e9b7(0x1a2)][_0x40e9b7(0x1c2)]({'where':{'id':_0x282057},'data':{'publicKey':_0x4a4c16,'secretKey':_0x51a543}});}async[a53_0x30193d(0x1c4)](_0x1ad7ae,_0x31e493){const _0x51b077=a53_0x30193d,{passwordConfirmation:_0x156e04}=_0x31e493,_0xebf87=await database_1[_0x51b077(0x1c9)][_0x51b077(0x1a2)]['findUnique']({'where':{'id':_0x1ad7ae},'select':{'password':!![]}});if(!_0xebf87)throw new Error(_0x51b077(0x1b1));const _0x108721=await bcryptjs_1[_0x51b077(0x1c9)][_0x51b077(0x1be)](_0x156e04,_0xebf87[_0x51b077(0x197)]);if(!_0x108721)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x51b077(0x1c9)][_0x51b077(0x1a2)]['delete']({'where':{'id':_0x1ad7ae}});}async['ensureSettingsExist'](_0x5cf859){const _0x50c0ea=a53_0x30193d,_0x19813c=await database_1['default'][_0x50c0ea(0x19a)]['findUnique']({'where':{'shopId':_0x5cf859}});!_0x19813c&&await database_1[_0x50c0ea(0x1c9)][_0x50c0ea(0x19a)][_0x50c0ea(0x1c0)]({'data':{'shopId':_0x5cf859}});}}exports[a53_0x30193d(0x1a9)]=SettingsService;