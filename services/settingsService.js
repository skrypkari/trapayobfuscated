'use strict';const a85_0x22626d=a85_0x296e;(function(_0x40080a,_0x20997e){const _0x5991ed=a85_0x296e,_0x3404bb=_0x40080a();while(!![]){try{const _0xaacf1b=-parseInt(_0x5991ed(0x1ef))/0x1+parseInt(_0x5991ed(0x1d7))/0x2+parseInt(_0x5991ed(0x201))/0x3*(-parseInt(_0x5991ed(0x1d9))/0x4)+-parseInt(_0x5991ed(0x1e9))/0x5+parseInt(_0x5991ed(0x1e7))/0x6+-parseInt(_0x5991ed(0x1ed))/0x7+parseInt(_0x5991ed(0x1bd))/0x8;if(_0xaacf1b===_0x20997e)break;else _0x3404bb['push'](_0x3404bb['shift']());}catch(_0x13e088){_0x3404bb['push'](_0x3404bb['shift']());}}}(a85_0x32e0,0x5e3c2));var __importDefault=this&&this[a85_0x22626d(0x1c6)]||function(_0x515c4f){const _0x503f6c=a85_0x22626d;return _0x515c4f&&_0x515c4f[_0x503f6c(0x1c4)]?_0x515c4f:{'default':_0x515c4f};};function a85_0x32e0(){const _0x172697=['9980440qXSaXM','Password\x20confirmation\x20is\x20incorrect','settings','../config/database','bcryptjs','telegramChatId','findUnique','__esModule','telegram','__importDefault','maskApiKey','name','length','disconnectTelegramSession','updateTelegramSettings','string','refund','api_error','chatId','toString','webhookEvents','deleteAccount','repeat','payout','notificationPaymentSuccess','revokeAllApiKeys','81946RLIDjj','2FA\x20token\x20is\x20required','55472NtOrxx','delete','webhookUrl','parseWebhookEvents','twoFactorEnabled','getTelegramSessions','password','totp','shop','twoFactorSecret','isArray','Unauthorized\x20to\x20disconnect\x20this\x20session','stringify','updateWebhookSettings','710742hoHcVi','update','1362700WpYJDQ','SettingsService','notificationApiError','telegramUser','2383234sFYYpd','randomBytes','366393TlQLlh','shopSettings','backupCodes','defineProperty','getShopSettings','crypto','hex','Current\x20password\x20is\x20incorrect','payment_success','telegramBotApiKey','compare','base32','_count','Invalid\x202FA\x20token\x20or\x20backup\x20code','Shop\x20not\x20found','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','parse','desc','9UnJnfp','sk_','default','splice','ensureSettingsExist','max','verify','notificationRefund','create','login','notificationPaymentFailed','payment_failed','notificationLogin','pk_','shopUrl'];a85_0x32e0=function(){return _0x172697;};return a85_0x32e0();}Object[a85_0x22626d(0x1f2)](exports,a85_0x22626d(0x1c4),{'value':!![]}),exports[a85_0x22626d(0x1ea)]=void 0x0;function a85_0x296e(_0x1073a7,_0x2bcdf0){_0x1073a7=_0x1073a7-0x1bd;const _0x32e0f6=a85_0x32e0();let _0x296efa=_0x32e0f6[_0x1073a7];return _0x296efa;}const bcryptjs_1=__importDefault(require(a85_0x22626d(0x1c1))),crypto_1=__importDefault(require(a85_0x22626d(0x1f4))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a85_0x22626d(0x1c0)));class SettingsService{[a85_0x22626d(0x1c7)](_0x2291a6){const _0xa79970=a85_0x22626d;if(!_0x2291a6)return'';if(_0x2291a6[_0xa79970(0x1c9)]<=0x8)return _0x2291a6;const _0x26fb21=_0x2291a6['substring'](0x0,0x8),_0x51cea9='*'[_0xa79970(0x1d3)](Math[_0xa79970(0x206)](0x0,_0x2291a6[_0xa79970(0x1c9)]-0x8));return _0x26fb21+_0x51cea9;}[a85_0x22626d(0x1dc)](_0x21a5dc){const _0x12a432=a85_0x22626d;if(!_0x21a5dc)return[];if(Array[_0x12a432(0x1e3)](_0x21a5dc))return _0x21a5dc;if(typeof _0x21a5dc===_0x12a432(0x1cc))try{const _0x28d0ea=JSON[_0x12a432(0x1ff)](_0x21a5dc);return Array[_0x12a432(0x1e3)](_0x28d0ea)?_0x28d0ea:[];}catch{return[];}return[];}async[a85_0x22626d(0x1f3)](_0x25fefb){const _0x30adbd=a85_0x22626d,_0x7500e8=await database_1['default'][_0x30adbd(0x1e1)]['findUnique']({'where':{'id':_0x25fefb},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x7500e8)throw new Error('Shop\x20not\x20found');let _0x5e5a27=_0x7500e8[_0x30adbd(0x1bf)];return!_0x5e5a27&&(_0x5e5a27=await database_1[_0x30adbd(0x203)][_0x30adbd(0x1f0)][_0x30adbd(0x209)]({'data':{'shopId':_0x7500e8['id']}})),{'fullName':_0x7500e8[_0x30adbd(0x1c8)],'brand':_0x7500e8['name'],'merchantUrl':_0x7500e8[_0x30adbd(0x20f)],'telegramUsername':_0x7500e8[_0x30adbd(0x1c5)],'telegramBotApiKey':_0x5e5a27[_0x30adbd(0x1f8)]?this[_0x30adbd(0x1c7)](_0x5e5a27[_0x30adbd(0x1f8)]):null,'telegramChatId':_0x5e5a27[_0x30adbd(0x1c2)],'telegramUsersCount':_0x7500e8[_0x30adbd(0x1fb)]['telegramUsers'],'webhookUrl':_0x5e5a27[_0x30adbd(0x1db)],'webhookEvents':this[_0x30adbd(0x1dc)](_0x5e5a27[_0x30adbd(0x1d1)]),'twoFactorEnabled':_0x7500e8[_0x30adbd(0x1dd)]||![],'notifications':{'payment_success':_0x5e5a27['notificationPaymentSuccess'],'payment_failed':_0x5e5a27[_0x30adbd(0x20b)],'refund':_0x5e5a27[_0x30adbd(0x208)],'payout':_0x5e5a27['notificationPayout'],'login':_0x5e5a27[_0x30adbd(0x20d)],'api_error':_0x5e5a27[_0x30adbd(0x1eb)]}};}async['changePassword'](_0x53bad4,_0x10484c){const _0x4a085c=a85_0x22626d,{currentPassword:_0x3e25b7,newPassword:_0x338bc3,confirmNewPassword:_0x350faa,twoFactorToken:_0x487b59}=_0x10484c;if(_0x338bc3!==_0x350faa)throw new Error(_0x4a085c(0x1fe));if(_0x338bc3['length']<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x5c8716=await database_1[_0x4a085c(0x203)][_0x4a085c(0x1e1)][_0x4a085c(0x1c3)]({'where':{'id':_0x53bad4},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x5c8716)throw new Error('Shop\x20not\x20found');if(_0x5c8716[_0x4a085c(0x1dd)]){if(!_0x487b59)throw new Error(_0x4a085c(0x1d8));const _0x2ce023=speakeasy_1[_0x4a085c(0x203)][_0x4a085c(0x1e0)]['verify']({'secret':_0x5c8716['twoFactorSecret'],'encoding':'base32','token':_0x487b59,'window':0x2});if(!_0x2ce023){let _0x39ddca=![];if(_0x5c8716['backupCodes']){const _0x3a4b23=JSON['parse'](_0x5c8716[_0x4a085c(0x1f1)]);for(let _0x37de51=0x0;_0x37de51<_0x3a4b23['length'];_0x37de51++){const _0x2b914b=await bcryptjs_1['default'][_0x4a085c(0x1f9)](_0x487b59,_0x3a4b23[_0x37de51]);if(_0x2b914b){_0x39ddca=!![],_0x3a4b23[_0x4a085c(0x204)](_0x37de51,0x1),await database_1[_0x4a085c(0x203)][_0x4a085c(0x1e1)][_0x4a085c(0x1e8)]({'where':{'id':_0x53bad4},'data':{'backupCodes':JSON[_0x4a085c(0x1e5)](_0x3a4b23)}});break;}}}if(!_0x39ddca)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x54f8bd=await bcryptjs_1[_0x4a085c(0x203)]['compare'](_0x3e25b7,_0x5c8716[_0x4a085c(0x1df)]);if(!_0x54f8bd)throw new Error(_0x4a085c(0x1f6));const _0x562a33=await bcryptjs_1[_0x4a085c(0x203)]['hash'](_0x338bc3,0xc);await database_1[_0x4a085c(0x203)]['shop'][_0x4a085c(0x1e8)]({'where':{'id':_0x53bad4},'data':{'password':_0x562a33}});}async['updateNotifications'](_0x1ee85c,_0x3235f1){const _0x51a5e0=a85_0x22626d;await this[_0x51a5e0(0x205)](_0x1ee85c);const _0xead1b2={};_0x3235f1['payment_success']!==undefined&&(_0xead1b2[_0x51a5e0(0x1d5)]=_0x3235f1[_0x51a5e0(0x1f7)]),_0x3235f1[_0x51a5e0(0x20c)]!==undefined&&(_0xead1b2[_0x51a5e0(0x20b)]=_0x3235f1[_0x51a5e0(0x20c)]),_0x3235f1[_0x51a5e0(0x1cd)]!==undefined&&(_0xead1b2[_0x51a5e0(0x208)]=_0x3235f1[_0x51a5e0(0x1cd)]),_0x3235f1[_0x51a5e0(0x1d4)]!==undefined&&(_0xead1b2['notificationPayout']=_0x3235f1['payout']),_0x3235f1[_0x51a5e0(0x20a)]!==undefined&&(_0xead1b2[_0x51a5e0(0x20d)]=_0x3235f1[_0x51a5e0(0x20a)]),_0x3235f1[_0x51a5e0(0x1ce)]!==undefined&&(_0xead1b2[_0x51a5e0(0x1eb)]=_0x3235f1[_0x51a5e0(0x1ce)]),await database_1['default'][_0x51a5e0(0x1f0)][_0x51a5e0(0x1e8)]({'where':{'shopId':_0x1ee85c},'data':_0xead1b2});}async[a85_0x22626d(0x1cb)](_0x4aaaf8,_0x18291a){const _0x40bd33=a85_0x22626d;await this[_0x40bd33(0x205)](_0x4aaaf8);const _0xc949ba={};_0x18291a['botApiKey']!==undefined&&(_0xc949ba[_0x40bd33(0x1f8)]=_0x18291a['botApiKey']||null),_0x18291a[_0x40bd33(0x1cf)]!==undefined&&(_0xc949ba[_0x40bd33(0x1c2)]=_0x18291a['chatId']||null),await database_1[_0x40bd33(0x203)][_0x40bd33(0x1f0)][_0x40bd33(0x1e8)]({'where':{'shopId':_0x4aaaf8},'data':_0xc949ba});}async[a85_0x22626d(0x1e6)](_0x5e2f32,_0x55cec5){const _0x97cf2b=a85_0x22626d;await this[_0x97cf2b(0x205)](_0x5e2f32);const _0x533798={};_0x55cec5[_0x97cf2b(0x1db)]!==undefined&&(_0x533798[_0x97cf2b(0x1db)]=_0x55cec5['webhookUrl']||null),_0x55cec5[_0x97cf2b(0x1d1)]!==undefined&&(_0x533798[_0x97cf2b(0x1d1)]=_0x55cec5['webhookEvents']||[]),await database_1[_0x97cf2b(0x203)][_0x97cf2b(0x1f0)][_0x97cf2b(0x1e8)]({'where':{'shopId':_0x5e2f32},'data':_0x533798});}async[a85_0x22626d(0x1d6)](_0x24a94b,_0x23489f){const _0x1e3f46=a85_0x22626d,_0xa5d06a=await database_1['default']['shop'][_0x1e3f46(0x1c3)]({'where':{'id':_0x24a94b},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0xa5d06a)throw new Error(_0x1e3f46(0x1fd));if(_0xa5d06a[_0x1e3f46(0x1dd)]){if(!_0x23489f)throw new Error(_0x1e3f46(0x1d8));const _0x2f8de5=speakeasy_1[_0x1e3f46(0x203)]['totp'][_0x1e3f46(0x207)]({'secret':_0xa5d06a[_0x1e3f46(0x1e2)],'encoding':_0x1e3f46(0x1fa),'token':_0x23489f,'window':0x2});if(!_0x2f8de5){let _0x35c9bf=![];if(_0xa5d06a[_0x1e3f46(0x1f1)]){const _0x4b701e=JSON[_0x1e3f46(0x1ff)](_0xa5d06a[_0x1e3f46(0x1f1)]);for(let _0x41cd8a=0x0;_0x41cd8a<_0x4b701e[_0x1e3f46(0x1c9)];_0x41cd8a++){const _0x5f117e=await bcryptjs_1['default'][_0x1e3f46(0x1f9)](_0x23489f,_0x4b701e[_0x41cd8a]);if(_0x5f117e){_0x35c9bf=!![],_0x4b701e[_0x1e3f46(0x204)](_0x41cd8a,0x1),await database_1[_0x1e3f46(0x203)][_0x1e3f46(0x1e1)][_0x1e3f46(0x1e8)]({'where':{'id':_0x24a94b},'data':{'backupCodes':JSON[_0x1e3f46(0x1e5)](_0x4b701e)}});break;}}}if(!_0x35c9bf)throw new Error(_0x1e3f46(0x1fc));}}const _0x25d6a6=_0x1e3f46(0x20e)+crypto_1[_0x1e3f46(0x203)][_0x1e3f46(0x1ee)](0x20)[_0x1e3f46(0x1d0)](_0x1e3f46(0x1f5)),_0x6f21a8=_0x1e3f46(0x202)+crypto_1[_0x1e3f46(0x203)][_0x1e3f46(0x1ee)](0x20)[_0x1e3f46(0x1d0)]('hex');await database_1['default'][_0x1e3f46(0x1e1)][_0x1e3f46(0x1e8)]({'where':{'id':_0x24a94b},'data':{'publicKey':_0x25d6a6,'secretKey':_0x6f21a8}});}async[a85_0x22626d(0x1d2)](_0x3b5406,_0xa38f0e){const _0x29ab8b=a85_0x22626d,{passwordConfirmation:_0x1c04ca}=_0xa38f0e,_0xc6d2c7=await database_1[_0x29ab8b(0x203)][_0x29ab8b(0x1e1)][_0x29ab8b(0x1c3)]({'where':{'id':_0x3b5406},'select':{'password':!![]}});if(!_0xc6d2c7)throw new Error('Shop\x20not\x20found');const _0x2dbf38=await bcryptjs_1[_0x29ab8b(0x203)][_0x29ab8b(0x1f9)](_0x1c04ca,_0xc6d2c7[_0x29ab8b(0x1df)]);if(!_0x2dbf38)throw new Error(_0x29ab8b(0x1be));await database_1[_0x29ab8b(0x203)]['shop'][_0x29ab8b(0x1da)]({'where':{'id':_0x3b5406}});}async[a85_0x22626d(0x1de)](_0x1e6f94){const _0x8a475a=a85_0x22626d,_0xe185bb=await database_1[_0x8a475a(0x203)]['telegramUser']['findMany']({'where':{'shopId':_0x1e6f94,'isVerified':!![]},'orderBy':{'createdAt':_0x8a475a(0x200)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0xe185bb;}async[a85_0x22626d(0x1ca)](_0x54e7a7,_0x571c5a){const _0x4309ae=a85_0x22626d,_0x466056=await database_1['default']['telegramUser']['findUnique']({'where':{'id':_0x571c5a},'select':{'shopId':!![]}});if(!_0x466056)throw new Error('Telegram\x20session\x20not\x20found');if(_0x466056['shopId']!==_0x54e7a7)throw new Error(_0x4309ae(0x1e4));await database_1['default'][_0x4309ae(0x1ec)]['update']({'where':{'id':_0x571c5a},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x22626d(0x205)](_0x3ae9a9){const _0x541e9b=a85_0x22626d,_0x3c8999=await database_1['default'][_0x541e9b(0x1f0)]['findUnique']({'where':{'shopId':_0x3ae9a9}});!_0x3c8999&&await database_1[_0x541e9b(0x203)][_0x541e9b(0x1f0)]['create']({'data':{'shopId':_0x3ae9a9}});}}exports[a85_0x22626d(0x1ea)]=SettingsService;