'use strict';function a47_0x416a(){const _0x139743=['changePassword','payment_success','botApiKey','Shop\x20not\x20found','2470892wsAwyo','toString','max','length','findUnique','notificationPaymentFailed','repeat','notificationApiError','maskApiKey','1293582iyxAfo','substring','1971462jFZJpD','16eXvfUR','api_error','377318UPwvJg','Current\x20password\x20is\x20incorrect','string','SettingsService','chatId','defineProperty','hex','shopSettings','778225FbVqSC','parse','1WBOkTd','notificationRefund','notificationLogin','telegramBotApiKey','deleteAccount','sk_','password','isArray','refund','crypto','shopUrl','Password\x20confirmation\x20is\x20incorrect','webhookEvents','login','notificationPaymentSuccess','542213VuhxmN','payment_failed','ensureSettingsExist','delete','pk_','notificationPayout','parseWebhookEvents','telegramChatId','webhookUrl','../config/database','default','payout','14843763Hpphlo','bcryptjs','revokeAllApiKeys','__esModule','telegram','create','shop','updateTelegramSettings','update','compare','hash'];a47_0x416a=function(){return _0x139743;};return a47_0x416a();}const a47_0x26c611=a47_0x3bd9;(function(_0x1a16ad,_0x5d0a41){const _0xc6b95=a47_0x3bd9,_0x4704d7=_0x1a16ad();while(!![]){try{const _0x7114de=-parseInt(_0xc6b95(0x213))/0x1*(-parseInt(_0xc6b95(0x209))/0x2)+-parseInt(_0xc6b95(0x206))/0x3+-parseInt(_0xc6b95(0x1fb))/0x4+-parseInt(_0xc6b95(0x211))/0x5+-parseInt(_0xc6b95(0x204))/0x6+-parseInt(_0xc6b95(0x222))/0x7*(-parseInt(_0xc6b95(0x207))/0x8)+parseInt(_0xc6b95(0x22e))/0x9;if(_0x7114de===_0x5d0a41)break;else _0x4704d7['push'](_0x4704d7['shift']());}catch(_0x1c7abf){_0x4704d7['push'](_0x4704d7['shift']());}}}(a47_0x416a,0x54a8d));function a47_0x3bd9(_0x4fa184,_0x474e){const _0x416a1a=a47_0x416a();return a47_0x3bd9=function(_0x3bd9b6,_0x34e7e9){_0x3bd9b6=_0x3bd9b6-0x1ed;let _0x521b1b=_0x416a1a[_0x3bd9b6];return _0x521b1b;},a47_0x3bd9(_0x4fa184,_0x474e);}var __importDefault=this&&this['__importDefault']||function(_0x4807df){const _0x3363d0=a47_0x3bd9;return _0x4807df&&_0x4807df[_0x3363d0(0x1ef)]?_0x4807df:{'default':_0x4807df};};Object[a47_0x26c611(0x20e)](exports,a47_0x26c611(0x1ef),{'value':!![]}),exports[a47_0x26c611(0x20c)]=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x26c611(0x1ed))),crypto_1=__importDefault(require(a47_0x26c611(0x21c))),database_1=__importDefault(require(a47_0x26c611(0x22b)));class SettingsService{['maskApiKey'](_0x1de932){const _0x25cc01=a47_0x26c611;if(!_0x1de932)return'';if(_0x1de932[_0x25cc01(0x1fe)]<=0x8)return _0x1de932;const _0x4489dd=_0x1de932[_0x25cc01(0x205)](0x0,0x8),_0x187a44='*'[_0x25cc01(0x201)](Math[_0x25cc01(0x1fd)](0x0,_0x1de932[_0x25cc01(0x1fe)]-0x8));return _0x4489dd+_0x187a44;}['parseWebhookEvents'](_0x113faa){const _0x52e4e5=a47_0x26c611;if(!_0x113faa)return[];if(Array[_0x52e4e5(0x21a)](_0x113faa))return _0x113faa;if(typeof _0x113faa===_0x52e4e5(0x20b))try{const _0x585564=JSON[_0x52e4e5(0x212)](_0x113faa);return Array[_0x52e4e5(0x21a)](_0x585564)?_0x585564:[];}catch{return[];}return[];}async['getShopSettings'](_0x52ceb8){const _0xa7fbbe=a47_0x26c611,_0xf6a354=await database_1[_0xa7fbbe(0x22c)]['shop'][_0xa7fbbe(0x1ff)]({'where':{'id':_0x52ceb8},'include':{'settings':!![]}});if(!_0xf6a354)throw new Error(_0xa7fbbe(0x1fa));let _0x469186=_0xf6a354['settings'];return!_0x469186&&(_0x469186=await database_1[_0xa7fbbe(0x22c)][_0xa7fbbe(0x210)]['create']({'data':{'shopId':_0xf6a354['id']}})),{'fullName':_0xf6a354['name'],'brand':_0xf6a354['name'],'merchantUrl':_0xf6a354[_0xa7fbbe(0x21d)],'telegramUsername':_0xf6a354[_0xa7fbbe(0x1f0)],'telegramBotApiKey':_0x469186[_0xa7fbbe(0x216)]?this[_0xa7fbbe(0x203)](_0x469186[_0xa7fbbe(0x216)]):null,'telegramChatId':_0x469186['telegramChatId'],'webhookUrl':_0x469186['webhookUrl'],'webhookEvents':this[_0xa7fbbe(0x228)](_0x469186['webhookEvents']),'notifications':{'payment_success':_0x469186[_0xa7fbbe(0x221)],'payment_failed':_0x469186[_0xa7fbbe(0x200)],'refund':_0x469186[_0xa7fbbe(0x214)],'payout':_0x469186[_0xa7fbbe(0x227)],'login':_0x469186[_0xa7fbbe(0x215)],'api_error':_0x469186[_0xa7fbbe(0x202)]}};}async[a47_0x26c611(0x1f7)](_0x3b4bfc,_0x393059){const _0x259edb=a47_0x26c611,{currentPassword:_0xdc4ae8,newPassword:_0x8a263e,confirmNewPassword:_0x534a55}=_0x393059;if(_0x8a263e!==_0x534a55)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x8a263e[_0x259edb(0x1fe)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x5d0a7b=await database_1[_0x259edb(0x22c)][_0x259edb(0x1f2)][_0x259edb(0x1ff)]({'where':{'id':_0x3b4bfc},'select':{'password':!![]}});if(!_0x5d0a7b)throw new Error(_0x259edb(0x1fa));const _0x21fa1c=await bcryptjs_1[_0x259edb(0x22c)][_0x259edb(0x1f5)](_0xdc4ae8,_0x5d0a7b[_0x259edb(0x219)]);if(!_0x21fa1c)throw new Error(_0x259edb(0x20a));const _0x2f3eb3=await bcryptjs_1[_0x259edb(0x22c)][_0x259edb(0x1f6)](_0x8a263e,0xc);await database_1['default'][_0x259edb(0x1f2)][_0x259edb(0x1f4)]({'where':{'id':_0x3b4bfc},'data':{'password':_0x2f3eb3}});}async['updateNotifications'](_0x63d8fa,_0x1b8ebb){const _0x5b628b=a47_0x26c611;await this[_0x5b628b(0x224)](_0x63d8fa);const _0x3a3973={};_0x1b8ebb[_0x5b628b(0x1f8)]!==undefined&&(_0x3a3973[_0x5b628b(0x221)]=_0x1b8ebb[_0x5b628b(0x1f8)]),_0x1b8ebb[_0x5b628b(0x223)]!==undefined&&(_0x3a3973[_0x5b628b(0x200)]=_0x1b8ebb['payment_failed']),_0x1b8ebb['refund']!==undefined&&(_0x3a3973[_0x5b628b(0x214)]=_0x1b8ebb[_0x5b628b(0x21b)]),_0x1b8ebb[_0x5b628b(0x22d)]!==undefined&&(_0x3a3973[_0x5b628b(0x227)]=_0x1b8ebb[_0x5b628b(0x22d)]),_0x1b8ebb['login']!==undefined&&(_0x3a3973[_0x5b628b(0x215)]=_0x1b8ebb[_0x5b628b(0x220)]),_0x1b8ebb[_0x5b628b(0x208)]!==undefined&&(_0x3a3973[_0x5b628b(0x202)]=_0x1b8ebb[_0x5b628b(0x208)]),await database_1[_0x5b628b(0x22c)][_0x5b628b(0x210)]['update']({'where':{'shopId':_0x63d8fa},'data':_0x3a3973});}async[a47_0x26c611(0x1f3)](_0xd2bc05,_0x1db940){const _0x274a45=a47_0x26c611;await this['ensureSettingsExist'](_0xd2bc05);const _0x1bef1e={};_0x1db940[_0x274a45(0x1f9)]!==undefined&&(_0x1bef1e[_0x274a45(0x216)]=_0x1db940[_0x274a45(0x1f9)]||null),_0x1db940[_0x274a45(0x20d)]!==undefined&&(_0x1bef1e[_0x274a45(0x229)]=_0x1db940[_0x274a45(0x20d)]||null),await database_1[_0x274a45(0x22c)][_0x274a45(0x210)]['update']({'where':{'shopId':_0xd2bc05},'data':_0x1bef1e});}async['updateWebhookSettings'](_0x48138d,_0x35dbfb){const _0x36466e=a47_0x26c611;await this[_0x36466e(0x224)](_0x48138d);const _0x531379={};_0x35dbfb[_0x36466e(0x22a)]!==undefined&&(_0x531379['webhookUrl']=_0x35dbfb[_0x36466e(0x22a)]||null),_0x35dbfb['webhookEvents']!==undefined&&(_0x531379[_0x36466e(0x21f)]=_0x35dbfb[_0x36466e(0x21f)]||[]),await database_1['default']['shopSettings'][_0x36466e(0x1f4)]({'where':{'shopId':_0x48138d},'data':_0x531379});}async[a47_0x26c611(0x1ee)](_0x50f3a0){const _0x348df4=a47_0x26c611,_0x34458e=_0x348df4(0x226)+crypto_1[_0x348df4(0x22c)]['randomBytes'](0x20)[_0x348df4(0x1fc)](_0x348df4(0x20f)),_0x539843=_0x348df4(0x218)+crypto_1['default']['randomBytes'](0x20)[_0x348df4(0x1fc)](_0x348df4(0x20f));await database_1[_0x348df4(0x22c)]['shop'][_0x348df4(0x1f4)]({'where':{'id':_0x50f3a0},'data':{'publicKey':_0x34458e,'secretKey':_0x539843}});}async[a47_0x26c611(0x217)](_0x45a8e4,_0x49a7a6){const _0x3ce483=a47_0x26c611,{passwordConfirmation:_0x5d21fe}=_0x49a7a6,_0x418da9=await database_1['default'][_0x3ce483(0x1f2)][_0x3ce483(0x1ff)]({'where':{'id':_0x45a8e4},'select':{'password':!![]}});if(!_0x418da9)throw new Error('Shop\x20not\x20found');const _0x58a167=await bcryptjs_1[_0x3ce483(0x22c)]['compare'](_0x5d21fe,_0x418da9[_0x3ce483(0x219)]);if(!_0x58a167)throw new Error(_0x3ce483(0x21e));await database_1['default']['shop'][_0x3ce483(0x225)]({'where':{'id':_0x45a8e4}});}async[a47_0x26c611(0x224)](_0x2f8888){const _0x37f8a6=a47_0x26c611,_0x11f04c=await database_1[_0x37f8a6(0x22c)][_0x37f8a6(0x210)][_0x37f8a6(0x1ff)]({'where':{'shopId':_0x2f8888}});!_0x11f04c&&await database_1[_0x37f8a6(0x22c)][_0x37f8a6(0x210)][_0x37f8a6(0x1f1)]({'data':{'shopId':_0x2f8888}});}}exports['SettingsService']=SettingsService;