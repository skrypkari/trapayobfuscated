'use strict';const a55_0xcf9710=a55_0x1075;function a55_0x1075(_0x584e8d,_0xc6fb4a){const _0x10f7ad=a55_0x10f7();return a55_0x1075=function(_0x1075dc,_0x450b3f){_0x1075dc=_0x1075dc-0x1bb;let _0x15ebab=_0x10f7ad[_0x1075dc];return _0x15ebab;},a55_0x1075(_0x584e8d,_0xc6fb4a);}function a55_0x10f7(){const _0x499c0c=['1546835xigDoo','telegram','SettingsService','string','notificationPaymentSuccess','settings','deleteAccount','payment_success','1511688RNHPRE','updateTelegramSettings','2KrJBrx','login','botApiKey','create','__importDefault','update','payout','findUnique','length','pk_','hex','parseWebhookEvents','telegramChatId','8aMtqUS','bcryptjs','parse','notificationPaymentFailed','isArray','refund','Shop\x20not\x20found','sk_','compare','Password\x20confirmation\x20is\x20incorrect','default','shop','api_error','1465488munZmt','1843002OceFZv','notificationLogin','webhookUrl','name','401987tmXzXV','repeat','telegramBotApiKey','1160400CVuEtR','substring','toString','__esModule','shopSettings','notificationRefund','notificationPayout','2342601xUEyTV','randomBytes','webhookEvents','ensureSettingsExist','revokeAllApiKeys','payment_failed','chatId','delete','password','shopUrl','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long'];a55_0x10f7=function(){return _0x499c0c;};return a55_0x10f7();}(function(_0x531de8,_0x493f27){const _0x5f717e=a55_0x1075,_0x2eb89f=_0x531de8();while(!![]){try{const _0x33e7b4=parseInt(_0x5f717e(0x1c3))/0x1*(parseInt(_0x5f717e(0x1e2))/0x2)+-parseInt(_0x5f717e(0x1c6))/0x3+-parseInt(_0x5f717e(0x1e0))/0x4+parseInt(_0x5f717e(0x1d8))/0x5+-parseInt(_0x5f717e(0x1be))/0x6+-parseInt(_0x5f717e(0x1bf))/0x7*(-parseInt(_0x5f717e(0x1ef))/0x8)+parseInt(_0x5f717e(0x1cd))/0x9;if(_0x33e7b4===_0x493f27)break;else _0x2eb89f['push'](_0x2eb89f['shift']());}catch(_0x2a4f73){_0x2eb89f['push'](_0x2eb89f['shift']());}}}(a55_0x10f7,0x372a7));var __importDefault=this&&this[a55_0xcf9710(0x1e6)]||function(_0x30c10d){const _0x22da2e=a55_0xcf9710;return _0x30c10d&&_0x30c10d[_0x22da2e(0x1c9)]?_0x30c10d:{'default':_0x30c10d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a55_0xcf9710(0x1da)]=void 0x0;const bcryptjs_1=__importDefault(require(a55_0xcf9710(0x1f0))),crypto_1=__importDefault(require('crypto')),database_1=__importDefault(require('../config/database'));class SettingsService{['maskApiKey'](_0x3bbe53){const _0x1fbe01=a55_0xcf9710;if(!_0x3bbe53)return'';if(_0x3bbe53['length']<=0x8)return _0x3bbe53;const _0x133e52=_0x3bbe53[_0x1fbe01(0x1c7)](0x0,0x8),_0xb4d8f1='*'[_0x1fbe01(0x1c4)](Math['max'](0x0,_0x3bbe53[_0x1fbe01(0x1ea)]-0x8));return _0x133e52+_0xb4d8f1;}[a55_0xcf9710(0x1ed)](_0xd3424d){const _0x59135a=a55_0xcf9710;if(!_0xd3424d)return[];if(Array[_0x59135a(0x1f3)](_0xd3424d))return _0xd3424d;if(typeof _0xd3424d===_0x59135a(0x1db))try{const _0x595190=JSON[_0x59135a(0x1f1)](_0xd3424d);return Array[_0x59135a(0x1f3)](_0x595190)?_0x595190:[];}catch{return[];}return[];}async['getShopSettings'](_0x44a9d8){const _0x224321=a55_0xcf9710,_0xa8d999=await database_1[_0x224321(0x1bb)][_0x224321(0x1bc)][_0x224321(0x1e9)]({'where':{'id':_0x44a9d8},'include':{'settings':!![]}});if(!_0xa8d999)throw new Error(_0x224321(0x1f5));let _0x5cace0=_0xa8d999[_0x224321(0x1dd)];return!_0x5cace0&&(_0x5cace0=await database_1[_0x224321(0x1bb)][_0x224321(0x1ca)][_0x224321(0x1e5)]({'data':{'shopId':_0xa8d999['id']}})),{'fullName':_0xa8d999[_0x224321(0x1c2)],'brand':_0xa8d999['name'],'merchantUrl':_0xa8d999[_0x224321(0x1d6)],'telegramUsername':_0xa8d999[_0x224321(0x1d9)],'telegramBotApiKey':_0x5cace0[_0x224321(0x1c5)]?this['maskApiKey'](_0x5cace0['telegramBotApiKey']):null,'telegramChatId':_0x5cace0[_0x224321(0x1ee)],'webhookUrl':_0x5cace0[_0x224321(0x1c1)],'webhookEvents':this[_0x224321(0x1ed)](_0x5cace0[_0x224321(0x1cf)]),'notifications':{'payment_success':_0x5cace0[_0x224321(0x1dc)],'payment_failed':_0x5cace0[_0x224321(0x1f2)],'refund':_0x5cace0[_0x224321(0x1cb)],'payout':_0x5cace0[_0x224321(0x1cc)],'login':_0x5cace0[_0x224321(0x1c0)],'api_error':_0x5cace0['notificationApiError']}};}async['changePassword'](_0xc10f8f,_0x205ea8){const _0x52f716=a55_0xcf9710,{currentPassword:_0x48dc1a,newPassword:_0x3aeb0c,confirmNewPassword:_0x5a545d}=_0x205ea8;if(_0x3aeb0c!==_0x5a545d)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x3aeb0c['length']<0x6)throw new Error(_0x52f716(0x1d7));const _0x2521a0=await database_1[_0x52f716(0x1bb)][_0x52f716(0x1bc)]['findUnique']({'where':{'id':_0xc10f8f},'select':{'password':!![]}});if(!_0x2521a0)throw new Error(_0x52f716(0x1f5));const _0x57990b=await bcryptjs_1[_0x52f716(0x1bb)][_0x52f716(0x1f7)](_0x48dc1a,_0x2521a0['password']);if(!_0x57990b)throw new Error('Current\x20password\x20is\x20incorrect');const _0x7582bd=await bcryptjs_1[_0x52f716(0x1bb)]['hash'](_0x3aeb0c,0xc);await database_1[_0x52f716(0x1bb)][_0x52f716(0x1bc)][_0x52f716(0x1e7)]({'where':{'id':_0xc10f8f},'data':{'password':_0x7582bd}});}async['updateNotifications'](_0x3c05ca,_0x4ae8cc){const _0x18506d=a55_0xcf9710;await this[_0x18506d(0x1d0)](_0x3c05ca);const _0x3dfb14={};_0x4ae8cc['payment_success']!==undefined&&(_0x3dfb14[_0x18506d(0x1dc)]=_0x4ae8cc[_0x18506d(0x1df)]),_0x4ae8cc[_0x18506d(0x1d2)]!==undefined&&(_0x3dfb14[_0x18506d(0x1f2)]=_0x4ae8cc[_0x18506d(0x1d2)]),_0x4ae8cc['refund']!==undefined&&(_0x3dfb14[_0x18506d(0x1cb)]=_0x4ae8cc[_0x18506d(0x1f4)]),_0x4ae8cc[_0x18506d(0x1e8)]!==undefined&&(_0x3dfb14[_0x18506d(0x1cc)]=_0x4ae8cc[_0x18506d(0x1e8)]),_0x4ae8cc[_0x18506d(0x1e3)]!==undefined&&(_0x3dfb14[_0x18506d(0x1c0)]=_0x4ae8cc[_0x18506d(0x1e3)]),_0x4ae8cc[_0x18506d(0x1bd)]!==undefined&&(_0x3dfb14['notificationApiError']=_0x4ae8cc['api_error']),await database_1['default'][_0x18506d(0x1ca)][_0x18506d(0x1e7)]({'where':{'shopId':_0x3c05ca},'data':_0x3dfb14});}async[a55_0xcf9710(0x1e1)](_0x475345,_0x1f5e4f){const _0x4cd779=a55_0xcf9710;await this[_0x4cd779(0x1d0)](_0x475345);const _0x214d16={};_0x1f5e4f[_0x4cd779(0x1e4)]!==undefined&&(_0x214d16['telegramBotApiKey']=_0x1f5e4f[_0x4cd779(0x1e4)]||null),_0x1f5e4f[_0x4cd779(0x1d3)]!==undefined&&(_0x214d16[_0x4cd779(0x1ee)]=_0x1f5e4f[_0x4cd779(0x1d3)]||null),await database_1[_0x4cd779(0x1bb)][_0x4cd779(0x1ca)][_0x4cd779(0x1e7)]({'where':{'shopId':_0x475345},'data':_0x214d16});}async['updateWebhookSettings'](_0x85c53e,_0x588d8d){const _0x197157=a55_0xcf9710;await this[_0x197157(0x1d0)](_0x85c53e);const _0x13a112={};_0x588d8d[_0x197157(0x1c1)]!==undefined&&(_0x13a112[_0x197157(0x1c1)]=_0x588d8d[_0x197157(0x1c1)]||null),_0x588d8d[_0x197157(0x1cf)]!==undefined&&(_0x13a112[_0x197157(0x1cf)]=_0x588d8d['webhookEvents']||[]),await database_1[_0x197157(0x1bb)][_0x197157(0x1ca)][_0x197157(0x1e7)]({'where':{'shopId':_0x85c53e},'data':_0x13a112});}async[a55_0xcf9710(0x1d1)](_0x5ade49){const _0x472713=a55_0xcf9710,_0x522632=_0x472713(0x1eb)+crypto_1[_0x472713(0x1bb)][_0x472713(0x1ce)](0x20)[_0x472713(0x1c8)]('hex'),_0xeae8e0=_0x472713(0x1f6)+crypto_1[_0x472713(0x1bb)][_0x472713(0x1ce)](0x20)[_0x472713(0x1c8)](_0x472713(0x1ec));await database_1[_0x472713(0x1bb)][_0x472713(0x1bc)]['update']({'where':{'id':_0x5ade49},'data':{'publicKey':_0x522632,'secretKey':_0xeae8e0}});}async[a55_0xcf9710(0x1de)](_0x2ccebd,_0xf3e86e){const _0x6371c9=a55_0xcf9710,{passwordConfirmation:_0x49baea}=_0xf3e86e,_0xc1139a=await database_1['default'][_0x6371c9(0x1bc)][_0x6371c9(0x1e9)]({'where':{'id':_0x2ccebd},'select':{'password':!![]}});if(!_0xc1139a)throw new Error(_0x6371c9(0x1f5));const _0x26e18a=await bcryptjs_1[_0x6371c9(0x1bb)][_0x6371c9(0x1f7)](_0x49baea,_0xc1139a[_0x6371c9(0x1d5)]);if(!_0x26e18a)throw new Error(_0x6371c9(0x1f8));await database_1[_0x6371c9(0x1bb)]['shop'][_0x6371c9(0x1d4)]({'where':{'id':_0x2ccebd}});}async[a55_0xcf9710(0x1d0)](_0x3c52fe){const _0x1c8288=a55_0xcf9710,_0x2d8b64=await database_1[_0x1c8288(0x1bb)][_0x1c8288(0x1ca)]['findUnique']({'where':{'shopId':_0x3c52fe}});!_0x2d8b64&&await database_1['default']['shopSettings'][_0x1c8288(0x1e5)]({'data':{'shopId':_0x3c52fe}});}}exports[a55_0xcf9710(0x1da)]=SettingsService;