'use strict';const a52_0x587cff=a52_0x17a2;(function(_0x1dfb18,_0x33545d){const _0x4b817b=a52_0x17a2,_0x3af242=_0x1dfb18();while(!![]){try{const _0x4d02f7=parseInt(_0x4b817b(0x170))/0x1+parseInt(_0x4b817b(0x165))/0x2*(-parseInt(_0x4b817b(0x142))/0x3)+parseInt(_0x4b817b(0x176))/0x4*(-parseInt(_0x4b817b(0x14b))/0x5)+parseInt(_0x4b817b(0x140))/0x6*(-parseInt(_0x4b817b(0x157))/0x7)+parseInt(_0x4b817b(0x167))/0x8+parseInt(_0x4b817b(0x16b))/0x9+-parseInt(_0x4b817b(0x149))/0xa*(-parseInt(_0x4b817b(0x171))/0xb);if(_0x4d02f7===_0x33545d)break;else _0x3af242['push'](_0x3af242['shift']());}catch(_0x3780f7){_0x3af242['push'](_0x3af242['shift']());}}}(a52_0x434e,0x7615c));var __importDefault=this&&this[a52_0x587cff(0x174)]||function(_0x437a01){const _0x2cb195=a52_0x587cff;return _0x437a01&&_0x437a01[_0x2cb195(0x17a)]?_0x437a01:{'default':_0x437a01};};Object[a52_0x587cff(0x153)](exports,a52_0x587cff(0x17a),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a52_0x587cff(0x160))),database_1=__importDefault(require('../config/database'));function a52_0x17a2(_0x4220ba,_0x5ba364){const _0x434e10=a52_0x434e();return a52_0x17a2=function(_0x17a2a1,_0x1e08b1){_0x17a2a1=_0x17a2a1-0x140;let _0x14ba72=_0x434e10[_0x17a2a1];return _0x14ba72;},a52_0x17a2(_0x4220ba,_0x5ba364);}function a52_0x434e(){const _0x8d313d=['shop','__importDefault','toString','736KYcLcK','api_error','botApiKey','Password\x20confirmation\x20is\x20incorrect','__esModule','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','delete','90SaUBIK','create','3435tCpTGs','telegram','telegramBotApiKey','pk_','shopUrl','default','changePassword','5010BAlOZX','sk_','18805WpKHrk','ensureSettingsExist','revokeAllApiKeys','telegramChatId','notificationPaymentSuccess','notificationApiError','deleteAccount','compare','defineProperty','parseWebhookEvents','findUnique','isArray','260771NszOCb','string','shopSettings','parse','webhookEvents','login','password','updateNotifications','notificationPayout','crypto','substring','maskApiKey','repeat','hex','38sbgtlB','webhookUrl','4622352uqiDLa','settings','SettingsService','length','1568259exEIvg','Shop\x20not\x20found','payout','refund','update','395490euwlmX','13365Sfqefp','updateWebhookSettings'];a52_0x434e=function(){return _0x8d313d;};return a52_0x434e();}class SettingsService{['maskApiKey'](_0x48a729){const _0x58b687=a52_0x587cff;if(!_0x48a729)return'';if(_0x48a729['length']<=0x8)return _0x48a729;const _0x4d8a49=_0x48a729[_0x58b687(0x161)](0x0,0x8),_0x26366b='*'[_0x58b687(0x163)](Math['max'](0x0,_0x48a729[_0x58b687(0x16a)]-0x8));return _0x4d8a49+_0x26366b;}[a52_0x587cff(0x154)](_0x93045b){const _0x306f99=a52_0x587cff;if(!_0x93045b)return[];if(Array[_0x306f99(0x156)](_0x93045b))return _0x93045b;if(typeof _0x93045b===_0x306f99(0x158))try{const _0x395976=JSON[_0x306f99(0x15a)](_0x93045b);return Array[_0x306f99(0x156)](_0x395976)?_0x395976:[];}catch{return[];}return[];}async['getShopSettings'](_0x421ecc){const _0x353863=a52_0x587cff,_0xcb951d=await database_1[_0x353863(0x147)][_0x353863(0x173)][_0x353863(0x155)]({'where':{'id':_0x421ecc},'include':{'settings':!![]}});if(!_0xcb951d)throw new Error(_0x353863(0x16c));let _0x46daf3=_0xcb951d[_0x353863(0x168)];return!_0x46daf3&&(_0x46daf3=await database_1[_0x353863(0x147)][_0x353863(0x159)][_0x353863(0x141)]({'data':{'shopId':_0xcb951d['id']}})),{'fullName':_0xcb951d['name'],'brand':_0xcb951d['name'],'merchantUrl':_0xcb951d[_0x353863(0x146)],'telegramUsername':_0xcb951d[_0x353863(0x143)],'telegramBotApiKey':_0x46daf3[_0x353863(0x144)]?this[_0x353863(0x162)](_0x46daf3[_0x353863(0x144)]):null,'telegramChatId':_0x46daf3['telegramChatId'],'webhookUrl':_0x46daf3[_0x353863(0x166)],'webhookEvents':this['parseWebhookEvents'](_0x46daf3['webhookEvents']),'notifications':{'payment_success':_0x46daf3[_0x353863(0x14f)],'payment_failed':_0x46daf3['notificationPaymentFailed'],'refund':_0x46daf3['notificationRefund'],'payout':_0x46daf3['notificationPayout'],'login':_0x46daf3['notificationLogin'],'api_error':_0x46daf3['notificationApiError']}};}async[a52_0x587cff(0x148)](_0x4b025c,_0xfce6c5){const _0x1aaba0=a52_0x587cff,{currentPassword:_0x369e52,newPassword:_0x5168fd,confirmNewPassword:_0x461044}=_0xfce6c5;if(_0x5168fd!==_0x461044)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x5168fd[_0x1aaba0(0x16a)]<0x6)throw new Error(_0x1aaba0(0x17b));const _0x1ea673=await database_1[_0x1aaba0(0x147)][_0x1aaba0(0x173)][_0x1aaba0(0x155)]({'where':{'id':_0x4b025c},'select':{'password':!![]}});if(!_0x1ea673)throw new Error('Shop\x20not\x20found');const _0x7beece=await bcryptjs_1[_0x1aaba0(0x147)][_0x1aaba0(0x152)](_0x369e52,_0x1ea673[_0x1aaba0(0x15d)]);if(!_0x7beece)throw new Error('Current\x20password\x20is\x20incorrect');const _0x314e26=await bcryptjs_1[_0x1aaba0(0x147)]['hash'](_0x5168fd,0xc);await database_1['default'][_0x1aaba0(0x173)]['update']({'where':{'id':_0x4b025c},'data':{'password':_0x314e26}});}async[a52_0x587cff(0x15e)](_0x1a66ee,_0x29b077){const _0x143705=a52_0x587cff;await this[_0x143705(0x14c)](_0x1a66ee);const _0x54024d={};_0x29b077['payment_success']!==undefined&&(_0x54024d[_0x143705(0x14f)]=_0x29b077['payment_success']),_0x29b077['payment_failed']!==undefined&&(_0x54024d['notificationPaymentFailed']=_0x29b077['payment_failed']),_0x29b077[_0x143705(0x16e)]!==undefined&&(_0x54024d['notificationRefund']=_0x29b077[_0x143705(0x16e)]),_0x29b077[_0x143705(0x16d)]!==undefined&&(_0x54024d[_0x143705(0x15f)]=_0x29b077[_0x143705(0x16d)]),_0x29b077[_0x143705(0x15c)]!==undefined&&(_0x54024d['notificationLogin']=_0x29b077[_0x143705(0x15c)]),_0x29b077[_0x143705(0x177)]!==undefined&&(_0x54024d[_0x143705(0x150)]=_0x29b077[_0x143705(0x177)]),await database_1[_0x143705(0x147)][_0x143705(0x159)][_0x143705(0x16f)]({'where':{'shopId':_0x1a66ee},'data':_0x54024d});}async['updateTelegramSettings'](_0x3a1b69,_0x429dac){const _0xe6843f=a52_0x587cff;await this[_0xe6843f(0x14c)](_0x3a1b69);const _0x3808ef={};_0x429dac[_0xe6843f(0x178)]!==undefined&&(_0x3808ef['telegramBotApiKey']=_0x429dac[_0xe6843f(0x178)]||null),_0x429dac['chatId']!==undefined&&(_0x3808ef[_0xe6843f(0x14e)]=_0x429dac['chatId']||null),await database_1[_0xe6843f(0x147)]['shopSettings'][_0xe6843f(0x16f)]({'where':{'shopId':_0x3a1b69},'data':_0x3808ef});}async[a52_0x587cff(0x172)](_0x1da7a5,_0x5df45d){const _0x2574cb=a52_0x587cff;await this[_0x2574cb(0x14c)](_0x1da7a5);const _0x10a8a3={};_0x5df45d[_0x2574cb(0x166)]!==undefined&&(_0x10a8a3['webhookUrl']=_0x5df45d[_0x2574cb(0x166)]||null),_0x5df45d[_0x2574cb(0x15b)]!==undefined&&(_0x10a8a3[_0x2574cb(0x15b)]=_0x5df45d[_0x2574cb(0x15b)]||[]),await database_1[_0x2574cb(0x147)][_0x2574cb(0x159)][_0x2574cb(0x16f)]({'where':{'shopId':_0x1da7a5},'data':_0x10a8a3});}async[a52_0x587cff(0x14d)](_0x2b13f2){const _0x5d6047=a52_0x587cff,_0x3dfec9=_0x5d6047(0x145)+crypto_1[_0x5d6047(0x147)]['randomBytes'](0x20)[_0x5d6047(0x175)](_0x5d6047(0x164)),_0x183d64=_0x5d6047(0x14a)+crypto_1[_0x5d6047(0x147)]['randomBytes'](0x20)['toString'](_0x5d6047(0x164));await database_1[_0x5d6047(0x147)][_0x5d6047(0x173)][_0x5d6047(0x16f)]({'where':{'id':_0x2b13f2},'data':{'publicKey':_0x3dfec9,'secretKey':_0x183d64}});}async[a52_0x587cff(0x151)](_0x5c523d,_0x1dfc17){const _0x2f584a=a52_0x587cff,{passwordConfirmation:_0x27b0b1}=_0x1dfc17,_0x97cdbe=await database_1[_0x2f584a(0x147)][_0x2f584a(0x173)][_0x2f584a(0x155)]({'where':{'id':_0x5c523d},'select':{'password':!![]}});if(!_0x97cdbe)throw new Error(_0x2f584a(0x16c));const _0x2a2ad1=await bcryptjs_1[_0x2f584a(0x147)]['compare'](_0x27b0b1,_0x97cdbe[_0x2f584a(0x15d)]);if(!_0x2a2ad1)throw new Error(_0x2f584a(0x179));await database_1['default'][_0x2f584a(0x173)][_0x2f584a(0x17c)]({'where':{'id':_0x5c523d}});}async[a52_0x587cff(0x14c)](_0x51b7f7){const _0x5e555f=a52_0x587cff,_0x250c0f=await database_1[_0x5e555f(0x147)]['shopSettings']['findUnique']({'where':{'shopId':_0x51b7f7}});!_0x250c0f&&await database_1[_0x5e555f(0x147)][_0x5e555f(0x159)]['create']({'data':{'shopId':_0x51b7f7}});}}exports[a52_0x587cff(0x169)]=SettingsService;