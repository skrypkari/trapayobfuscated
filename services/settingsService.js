'use strict';const a52_0x51f4bd=a52_0x3076;function a52_0x3076(_0x5892e7,_0x449467){const _0x5d1c0f=a52_0x5d1c();return a52_0x3076=function(_0x307658,_0x2e1644){_0x307658=_0x307658-0x1e7;let _0x2a737c=_0x5d1c0f[_0x307658];return _0x2a737c;},a52_0x3076(_0x5892e7,_0x449467);}(function(_0x5640e7,_0x354417){const _0x1af8ce=a52_0x3076,_0x5900e3=_0x5640e7();while(!![]){try{const _0x355012=-parseInt(_0x1af8ce(0x1fd))/0x1+-parseInt(_0x1af8ce(0x21f))/0x2+-parseInt(_0x1af8ce(0x21b))/0x3+parseInt(_0x1af8ce(0x20e))/0x4+parseInt(_0x1af8ce(0x1ed))/0x5+-parseInt(_0x1af8ce(0x201))/0x6*(parseInt(_0x1af8ce(0x216))/0x7)+-parseInt(_0x1af8ce(0x213))/0x8*(-parseInt(_0x1af8ce(0x221))/0x9);if(_0x355012===_0x354417)break;else _0x5900e3['push'](_0x5900e3['shift']());}catch(_0x46709d){_0x5900e3['push'](_0x5900e3['shift']());}}}(a52_0x5d1c,0xd9a52));var __importDefault=this&&this['__importDefault']||function(_0x56909a){const _0x57cf9b=a52_0x3076;return _0x56909a&&_0x56909a[_0x57cf9b(0x206)]?_0x56909a:{'default':_0x56909a};};function a52_0x5d1c(){const _0x321706=['randomBytes','5114130vNGPnB','notificationLogin','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','name','2181156tVPumN','shopUrl','9jFUUTH','Password\x20confirmation\x20is\x20incorrect','crypto','create','notificationPaymentFailed','api_error','password','../config/database','defineProperty','shop','hex','SettingsService','Current\x20password\x20is\x20incorrect','130420Xqniww','string','parseWebhookEvents','maskApiKey','parse','updateTelegramSettings','chatId','Shop\x20not\x20found','findUnique','shopSettings','revokeAllApiKeys','isArray','updateWebhookSettings','notificationApiError','default','payment_failed','68571gwkQur','compare','refund','botApiKey','6ljHgOf','notificationPaymentSuccess','delete','payout','ensureSettingsExist','__esModule','pk_','webhookUrl','payment_success','notificationPayout','login','substring','webhookEvents','519748AvovpQ','sk_','update','max','getShopSettings','34820872uTftjY','telegramBotApiKey','length','5273079iFIPfH','toString','telegramChatId','hash'];a52_0x5d1c=function(){return _0x321706;};return a52_0x5d1c();}Object[a52_0x51f4bd(0x1e8)](exports,a52_0x51f4bd(0x206),{'value':!![]}),exports[a52_0x51f4bd(0x1eb)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a52_0x51f4bd(0x223))),database_1=__importDefault(require(a52_0x51f4bd(0x1e7)));class SettingsService{[a52_0x51f4bd(0x1f0)](_0x59f4b9){const _0xbe5f37=a52_0x51f4bd;if(!_0x59f4b9)return'';if(_0x59f4b9[_0xbe5f37(0x215)]<=0x8)return _0x59f4b9;const _0x234a3f=_0x59f4b9[_0xbe5f37(0x20c)](0x0,0x8),_0x29b3db='*'['repeat'](Math[_0xbe5f37(0x211)](0x0,_0x59f4b9[_0xbe5f37(0x215)]-0x8));return _0x234a3f+_0x29b3db;}[a52_0x51f4bd(0x1ef)](_0x2568fd){const _0x3cd945=a52_0x51f4bd;if(!_0x2568fd)return[];if(Array[_0x3cd945(0x1f8)](_0x2568fd))return _0x2568fd;if(typeof _0x2568fd===_0x3cd945(0x1ee))try{const _0xb8d33d=JSON[_0x3cd945(0x1f1)](_0x2568fd);return Array[_0x3cd945(0x1f8)](_0xb8d33d)?_0xb8d33d:[];}catch{return[];}return[];}async[a52_0x51f4bd(0x212)](_0x5b2998){const _0x4a1522=a52_0x51f4bd,_0x444d35=await database_1['default'][_0x4a1522(0x1e9)][_0x4a1522(0x1f5)]({'where':{'id':_0x5b2998},'include':{'settings':!![]}});if(!_0x444d35)throw new Error('Shop\x20not\x20found');let _0x5dbcc5=_0x444d35['settings'];return!_0x5dbcc5&&(_0x5dbcc5=await database_1[_0x4a1522(0x1fb)][_0x4a1522(0x1f6)]['create']({'data':{'shopId':_0x444d35['id']}})),{'fullName':_0x444d35[_0x4a1522(0x21e)],'brand':_0x444d35[_0x4a1522(0x21e)],'merchantUrl':_0x444d35[_0x4a1522(0x220)],'telegramUsername':_0x444d35['telegram'],'telegramBotApiKey':_0x5dbcc5['telegramBotApiKey']?this['maskApiKey'](_0x5dbcc5['telegramBotApiKey']):null,'telegramChatId':_0x5dbcc5[_0x4a1522(0x218)],'webhookUrl':_0x5dbcc5[_0x4a1522(0x208)],'webhookEvents':this[_0x4a1522(0x1ef)](_0x5dbcc5[_0x4a1522(0x20d)]),'notifications':{'payment_success':_0x5dbcc5[_0x4a1522(0x202)],'payment_failed':_0x5dbcc5[_0x4a1522(0x225)],'refund':_0x5dbcc5['notificationRefund'],'payout':_0x5dbcc5[_0x4a1522(0x20a)],'login':_0x5dbcc5[_0x4a1522(0x21c)],'api_error':_0x5dbcc5[_0x4a1522(0x1fa)]}};}async['changePassword'](_0x41d44b,_0x25459c){const _0x46db6f=a52_0x51f4bd,{currentPassword:_0x15e021,newPassword:_0x268b8b,confirmNewPassword:_0x3bdebb}=_0x25459c;if(_0x268b8b!==_0x3bdebb)throw new Error(_0x46db6f(0x21d));if(_0x268b8b['length']<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x2723c1=await database_1[_0x46db6f(0x1fb)][_0x46db6f(0x1e9)][_0x46db6f(0x1f5)]({'where':{'id':_0x41d44b},'select':{'password':!![]}});if(!_0x2723c1)throw new Error(_0x46db6f(0x1f4));const _0x330e0a=await bcryptjs_1[_0x46db6f(0x1fb)][_0x46db6f(0x1fe)](_0x15e021,_0x2723c1[_0x46db6f(0x227)]);if(!_0x330e0a)throw new Error(_0x46db6f(0x1ec));const _0x351b8d=await bcryptjs_1[_0x46db6f(0x1fb)][_0x46db6f(0x219)](_0x268b8b,0xc);await database_1[_0x46db6f(0x1fb)][_0x46db6f(0x1e9)][_0x46db6f(0x210)]({'where':{'id':_0x41d44b},'data':{'password':_0x351b8d}});}async['updateNotifications'](_0x326d40,_0x293e8d){const _0xa6c35b=a52_0x51f4bd;await this[_0xa6c35b(0x205)](_0x326d40);const _0x477b92={};_0x293e8d['payment_success']!==undefined&&(_0x477b92[_0xa6c35b(0x202)]=_0x293e8d[_0xa6c35b(0x209)]),_0x293e8d['payment_failed']!==undefined&&(_0x477b92[_0xa6c35b(0x225)]=_0x293e8d[_0xa6c35b(0x1fc)]),_0x293e8d[_0xa6c35b(0x1ff)]!==undefined&&(_0x477b92['notificationRefund']=_0x293e8d[_0xa6c35b(0x1ff)]),_0x293e8d[_0xa6c35b(0x204)]!==undefined&&(_0x477b92[_0xa6c35b(0x20a)]=_0x293e8d[_0xa6c35b(0x204)]),_0x293e8d[_0xa6c35b(0x20b)]!==undefined&&(_0x477b92['notificationLogin']=_0x293e8d['login']),_0x293e8d['api_error']!==undefined&&(_0x477b92[_0xa6c35b(0x1fa)]=_0x293e8d[_0xa6c35b(0x226)]),await database_1['default'][_0xa6c35b(0x1f6)]['update']({'where':{'shopId':_0x326d40},'data':_0x477b92});}async[a52_0x51f4bd(0x1f2)](_0x3f439b,_0x1dad88){const _0x5e863a=a52_0x51f4bd;await this[_0x5e863a(0x205)](_0x3f439b);const _0x4d273d={};_0x1dad88[_0x5e863a(0x200)]!==undefined&&(_0x4d273d[_0x5e863a(0x214)]=_0x1dad88['botApiKey']||null),_0x1dad88[_0x5e863a(0x1f3)]!==undefined&&(_0x4d273d[_0x5e863a(0x218)]=_0x1dad88['chatId']||null),await database_1[_0x5e863a(0x1fb)][_0x5e863a(0x1f6)][_0x5e863a(0x210)]({'where':{'shopId':_0x3f439b},'data':_0x4d273d});}async[a52_0x51f4bd(0x1f9)](_0x118fd7,_0x3fd0b2){const _0x52c4a5=a52_0x51f4bd;await this['ensureSettingsExist'](_0x118fd7);const _0x2534be={};_0x3fd0b2[_0x52c4a5(0x208)]!==undefined&&(_0x2534be[_0x52c4a5(0x208)]=_0x3fd0b2['webhookUrl']||null),_0x3fd0b2['webhookEvents']!==undefined&&(_0x2534be[_0x52c4a5(0x20d)]=_0x3fd0b2[_0x52c4a5(0x20d)]||[]),await database_1[_0x52c4a5(0x1fb)][_0x52c4a5(0x1f6)][_0x52c4a5(0x210)]({'where':{'shopId':_0x118fd7},'data':_0x2534be});}async[a52_0x51f4bd(0x1f7)](_0x221d7e){const _0x544324=a52_0x51f4bd,_0x690ff7=_0x544324(0x207)+crypto_1[_0x544324(0x1fb)]['randomBytes'](0x20)['toString']('hex'),_0x2473cf=_0x544324(0x20f)+crypto_1['default'][_0x544324(0x21a)](0x20)[_0x544324(0x217)](_0x544324(0x1ea));await database_1[_0x544324(0x1fb)][_0x544324(0x1e9)][_0x544324(0x210)]({'where':{'id':_0x221d7e},'data':{'publicKey':_0x690ff7,'secretKey':_0x2473cf}});}async['deleteAccount'](_0x30c2bf,_0x29ee2){const _0x5a5c5c=a52_0x51f4bd,{passwordConfirmation:_0x5337fa}=_0x29ee2,_0x2365cc=await database_1[_0x5a5c5c(0x1fb)][_0x5a5c5c(0x1e9)]['findUnique']({'where':{'id':_0x30c2bf},'select':{'password':!![]}});if(!_0x2365cc)throw new Error(_0x5a5c5c(0x1f4));const _0x2d4c7b=await bcryptjs_1[_0x5a5c5c(0x1fb)][_0x5a5c5c(0x1fe)](_0x5337fa,_0x2365cc['password']);if(!_0x2d4c7b)throw new Error(_0x5a5c5c(0x222));await database_1[_0x5a5c5c(0x1fb)][_0x5a5c5c(0x1e9)][_0x5a5c5c(0x203)]({'where':{'id':_0x30c2bf}});}async[a52_0x51f4bd(0x205)](_0x3545d2){const _0x57dd74=a52_0x51f4bd,_0x2a7c3a=await database_1['default']['shopSettings'][_0x57dd74(0x1f5)]({'where':{'shopId':_0x3545d2}});!_0x2a7c3a&&await database_1[_0x57dd74(0x1fb)][_0x57dd74(0x1f6)][_0x57dd74(0x224)]({'data':{'shopId':_0x3545d2}});}}exports[a52_0x51f4bd(0x1eb)]=SettingsService;