'use strict';function a78_0x11aa(){const _0x2d54f9=['Current\x20password\x20is\x20incorrect','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','notificationApiError','crypto','shop','botApiKey','defineProperty','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','__esModule','splice','default','telegram','9276NrDMGD','notificationRefund','Shop\x20not\x20found','update','findUnique','backupCodes','SettingsService','notificationPaymentFailed','bcryptjs','changePassword','hash','304hQggXo','Password\x20confirmation\x20is\x20incorrect','getShopSettings','toString','sk_','__importDefault','3595930dWZolp','name','686802CVkOjv','api_error','isArray','parseWebhookEvents','58bJApgJ','telegramChatId','password','../config/database','telegramBotApiKey','1869ZDQrVq','telegramUser','updateNotifications','Unauthorized\x20to\x20disconnect\x20this\x20session','1910230lrBgKF','payout','shopUrl','getTelegramSessions','randomBytes','notificationPaymentSuccess','2FA\x20token\x20is\x20required','length','totp','deleteAccount','pk_','verify','base32','332541FXBurB','revokeAllApiKeys','string','stringify','payment_success','parse','findMany','webhookUrl','refund','notificationPayout','webhookEvents','Invalid\x202FA\x20token\x20or\x20backup\x20code','payment_failed','create','twoFactorSecret','chatId','ensureSettingsExist','64cJBvua','shopSettings','disconnectTelegramSession','settings','hex','2381918fvFxVb','updateTelegramSettings','_count','twoFactorEnabled','login','notificationLogin','maskApiKey','compare'];a78_0x11aa=function(){return _0x2d54f9;};return a78_0x11aa();}const a78_0x313f49=a78_0x4a6d;(function(_0x3dd7a7,_0x5558a7){const _0x40ddc5=a78_0x4a6d,_0x5e0e83=_0x3dd7a7();while(!![]){try{const _0x598432=-parseInt(_0x40ddc5(0xb6))/0x1*(parseInt(_0x40ddc5(0xb1))/0x2)+-parseInt(_0x40ddc5(0x9a))/0x3*(parseInt(_0x40ddc5(0xa5))/0x4)+-parseInt(_0x40ddc5(0xba))/0x5+-parseInt(_0x40ddc5(0xad))/0x6+parseInt(_0x40ddc5(0x86))/0x7+parseInt(_0x40ddc5(0x81))/0x8*(parseInt(_0x40ddc5(0xc7))/0x9)+parseInt(_0x40ddc5(0xab))/0xa;if(_0x598432===_0x5558a7)break;else _0x5e0e83['push'](_0x5e0e83['shift']());}catch(_0x1a5e76){_0x5e0e83['push'](_0x5e0e83['shift']());}}}(a78_0x11aa,0x33359));var __importDefault=this&&this[a78_0x313f49(0xaa)]||function(_0x4ee205){const _0x1ecad4=a78_0x313f49;return _0x4ee205&&_0x4ee205[_0x1ecad4(0x96)]?_0x4ee205:{'default':_0x4ee205};};Object[a78_0x313f49(0x94)](exports,a78_0x313f49(0x96),{'value':!![]}),exports[a78_0x313f49(0xa0)]=void 0x0;function a78_0x4a6d(_0x200f8f,_0x5f216d){_0x200f8f=_0x200f8f-0x71;const _0x11aa3d=a78_0x11aa();let _0x4a6d93=_0x11aa3d[_0x200f8f];return _0x4a6d93;}const bcryptjs_1=__importDefault(require(a78_0x313f49(0xa2))),crypto_1=__importDefault(require(a78_0x313f49(0x91))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a78_0x313f49(0xb4)));class SettingsService{[a78_0x313f49(0x8c)](_0x484169){const _0x4c1756=a78_0x313f49;if(!_0x484169)return'';if(_0x484169[_0x4c1756(0xc1)]<=0x8)return _0x484169;const _0x3952ac=_0x484169['substring'](0x0,0x8),_0x41ed69='*'['repeat'](Math['max'](0x0,_0x484169[_0x4c1756(0xc1)]-0x8));return _0x3952ac+_0x41ed69;}[a78_0x313f49(0xb0)](_0x2faeb9){const _0x35e905=a78_0x313f49;if(!_0x2faeb9)return[];if(Array[_0x35e905(0xaf)](_0x2faeb9))return _0x2faeb9;if(typeof _0x2faeb9===_0x35e905(0x72))try{const _0x183947=JSON[_0x35e905(0x75)](_0x2faeb9);return Array['isArray'](_0x183947)?_0x183947:[];}catch{return[];}return[];}async[a78_0x313f49(0xa7)](_0xb923b){const _0x40db47=a78_0x313f49,_0x5bb342=await database_1[_0x40db47(0x98)][_0x40db47(0x92)][_0x40db47(0x9e)]({'where':{'id':_0xb923b},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x5bb342)throw new Error(_0x40db47(0x9c));let _0x36f74b=_0x5bb342[_0x40db47(0x84)];return!_0x36f74b&&(_0x36f74b=await database_1[_0x40db47(0x98)]['shopSettings'][_0x40db47(0x7d)]({'data':{'shopId':_0x5bb342['id']}})),{'fullName':_0x5bb342[_0x40db47(0xac)],'brand':_0x5bb342[_0x40db47(0xac)],'merchantUrl':_0x5bb342[_0x40db47(0xbc)],'telegramUsername':_0x5bb342[_0x40db47(0x99)],'telegramBotApiKey':_0x36f74b[_0x40db47(0xb5)]?this[_0x40db47(0x8c)](_0x36f74b[_0x40db47(0xb5)]):null,'telegramChatId':_0x36f74b['telegramChatId'],'telegramUsersCount':_0x5bb342[_0x40db47(0x88)]['telegramUsers'],'webhookUrl':_0x36f74b[_0x40db47(0x77)],'webhookEvents':this['parseWebhookEvents'](_0x36f74b[_0x40db47(0x7a)]),'twoFactorEnabled':_0x5bb342[_0x40db47(0x89)]||![],'notifications':{'payment_success':_0x36f74b['notificationPaymentSuccess'],'payment_failed':_0x36f74b[_0x40db47(0xa1)],'refund':_0x36f74b[_0x40db47(0x9b)],'payout':_0x36f74b[_0x40db47(0x79)],'login':_0x36f74b[_0x40db47(0x8b)],'api_error':_0x36f74b[_0x40db47(0x90)]}};}async[a78_0x313f49(0xa3)](_0x312a92,_0x1a57e9){const _0x34c517=a78_0x313f49,{currentPassword:_0x3ef370,newPassword:_0x2cdf8d,confirmNewPassword:_0x239886,twoFactorToken:_0x493fa7}=_0x1a57e9;if(_0x2cdf8d!==_0x239886)throw new Error(_0x34c517(0x95));if(_0x2cdf8d['length']<0x6)throw new Error(_0x34c517(0x8f));const _0x6fddba=await database_1[_0x34c517(0x98)]['shop']['findUnique']({'where':{'id':_0x312a92},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x6fddba)throw new Error(_0x34c517(0x9c));if(_0x6fddba[_0x34c517(0x89)]){if(!_0x493fa7)throw new Error('2FA\x20token\x20is\x20required');const _0x34af23=speakeasy_1[_0x34c517(0x98)]['totp']['verify']({'secret':_0x6fddba[_0x34c517(0x7e)],'encoding':_0x34c517(0xc6),'token':_0x493fa7,'window':0x2});if(!_0x34af23){let _0x1a16b1=![];if(_0x6fddba[_0x34c517(0x9f)]){const _0x2008f5=JSON[_0x34c517(0x75)](_0x6fddba[_0x34c517(0x9f)]);for(let _0x588770=0x0;_0x588770<_0x2008f5[_0x34c517(0xc1)];_0x588770++){const _0x2e29d5=await bcryptjs_1[_0x34c517(0x98)][_0x34c517(0x8d)](_0x493fa7,_0x2008f5[_0x588770]);if(_0x2e29d5){_0x1a16b1=!![],_0x2008f5[_0x34c517(0x97)](_0x588770,0x1),await database_1[_0x34c517(0x98)][_0x34c517(0x92)][_0x34c517(0x9d)]({'where':{'id':_0x312a92},'data':{'backupCodes':JSON[_0x34c517(0x73)](_0x2008f5)}});break;}}}if(!_0x1a16b1)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x1dedfe=await bcryptjs_1[_0x34c517(0x98)][_0x34c517(0x8d)](_0x3ef370,_0x6fddba[_0x34c517(0xb3)]);if(!_0x1dedfe)throw new Error(_0x34c517(0x8e));const _0x4b9f85=await bcryptjs_1[_0x34c517(0x98)][_0x34c517(0xa4)](_0x2cdf8d,0xc);await database_1[_0x34c517(0x98)][_0x34c517(0x92)][_0x34c517(0x9d)]({'where':{'id':_0x312a92},'data':{'password':_0x4b9f85}});}async[a78_0x313f49(0xb8)](_0xe1db0d,_0x24fbfd){const _0x2956b6=a78_0x313f49;await this[_0x2956b6(0x80)](_0xe1db0d);const _0x25521d={};_0x24fbfd['payment_success']!==undefined&&(_0x25521d[_0x2956b6(0xbf)]=_0x24fbfd[_0x2956b6(0x74)]),_0x24fbfd[_0x2956b6(0x7c)]!==undefined&&(_0x25521d[_0x2956b6(0xa1)]=_0x24fbfd[_0x2956b6(0x7c)]),_0x24fbfd['refund']!==undefined&&(_0x25521d[_0x2956b6(0x9b)]=_0x24fbfd[_0x2956b6(0x78)]),_0x24fbfd[_0x2956b6(0xbb)]!==undefined&&(_0x25521d[_0x2956b6(0x79)]=_0x24fbfd[_0x2956b6(0xbb)]),_0x24fbfd['login']!==undefined&&(_0x25521d[_0x2956b6(0x8b)]=_0x24fbfd[_0x2956b6(0x8a)]),_0x24fbfd[_0x2956b6(0xae)]!==undefined&&(_0x25521d['notificationApiError']=_0x24fbfd[_0x2956b6(0xae)]),await database_1[_0x2956b6(0x98)][_0x2956b6(0x82)][_0x2956b6(0x9d)]({'where':{'shopId':_0xe1db0d},'data':_0x25521d});}async[a78_0x313f49(0x87)](_0x3d885d,_0x4ed099){const _0x433fff=a78_0x313f49;await this[_0x433fff(0x80)](_0x3d885d);const _0x312987={};_0x4ed099['botApiKey']!==undefined&&(_0x312987[_0x433fff(0xb5)]=_0x4ed099[_0x433fff(0x93)]||null),_0x4ed099['chatId']!==undefined&&(_0x312987[_0x433fff(0xb2)]=_0x4ed099[_0x433fff(0x7f)]||null),await database_1[_0x433fff(0x98)]['shopSettings']['update']({'where':{'shopId':_0x3d885d},'data':_0x312987});}async['updateWebhookSettings'](_0x400a0e,_0x1f7c2d){const _0x42772a=a78_0x313f49;await this[_0x42772a(0x80)](_0x400a0e);const _0x260090={};_0x1f7c2d[_0x42772a(0x77)]!==undefined&&(_0x260090['webhookUrl']=_0x1f7c2d[_0x42772a(0x77)]||null),_0x1f7c2d['webhookEvents']!==undefined&&(_0x260090[_0x42772a(0x7a)]=_0x1f7c2d[_0x42772a(0x7a)]||[]),await database_1[_0x42772a(0x98)][_0x42772a(0x82)][_0x42772a(0x9d)]({'where':{'shopId':_0x400a0e},'data':_0x260090});}async[a78_0x313f49(0x71)](_0x5afe35,_0x3dac89){const _0x45ab27=a78_0x313f49,_0x302deb=await database_1['default']['shop'][_0x45ab27(0x9e)]({'where':{'id':_0x5afe35},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x302deb)throw new Error(_0x45ab27(0x9c));if(_0x302deb[_0x45ab27(0x89)]){if(!_0x3dac89)throw new Error(_0x45ab27(0xc0));const _0x1aaf3f=speakeasy_1['default'][_0x45ab27(0xc2)][_0x45ab27(0xc5)]({'secret':_0x302deb[_0x45ab27(0x7e)],'encoding':_0x45ab27(0xc6),'token':_0x3dac89,'window':0x2});if(!_0x1aaf3f){let _0x2672f5=![];if(_0x302deb[_0x45ab27(0x9f)]){const _0x1de086=JSON[_0x45ab27(0x75)](_0x302deb[_0x45ab27(0x9f)]);for(let _0x528c2b=0x0;_0x528c2b<_0x1de086[_0x45ab27(0xc1)];_0x528c2b++){const _0x1b28c5=await bcryptjs_1[_0x45ab27(0x98)][_0x45ab27(0x8d)](_0x3dac89,_0x1de086[_0x528c2b]);if(_0x1b28c5){_0x2672f5=!![],_0x1de086[_0x45ab27(0x97)](_0x528c2b,0x1),await database_1['default'][_0x45ab27(0x92)][_0x45ab27(0x9d)]({'where':{'id':_0x5afe35},'data':{'backupCodes':JSON['stringify'](_0x1de086)}});break;}}}if(!_0x2672f5)throw new Error(_0x45ab27(0x7b));}}const _0x59e387=_0x45ab27(0xc4)+crypto_1[_0x45ab27(0x98)]['randomBytes'](0x20)[_0x45ab27(0xa8)]('hex'),_0x2179db=_0x45ab27(0xa9)+crypto_1['default'][_0x45ab27(0xbe)](0x20)['toString'](_0x45ab27(0x85));await database_1[_0x45ab27(0x98)][_0x45ab27(0x92)][_0x45ab27(0x9d)]({'where':{'id':_0x5afe35},'data':{'publicKey':_0x59e387,'secretKey':_0x2179db}});}async[a78_0x313f49(0xc3)](_0x205907,_0x3f07d8){const _0x237b78=a78_0x313f49,{passwordConfirmation:_0x3f8b6a}=_0x3f07d8,_0x4e6e43=await database_1[_0x237b78(0x98)][_0x237b78(0x92)][_0x237b78(0x9e)]({'where':{'id':_0x205907},'select':{'password':!![]}});if(!_0x4e6e43)throw new Error(_0x237b78(0x9c));const _0x5a4c30=await bcryptjs_1[_0x237b78(0x98)][_0x237b78(0x8d)](_0x3f8b6a,_0x4e6e43[_0x237b78(0xb3)]);if(!_0x5a4c30)throw new Error(_0x237b78(0xa6));await database_1[_0x237b78(0x98)]['shop']['delete']({'where':{'id':_0x205907}});}async[a78_0x313f49(0xbd)](_0x248a6b){const _0x2e998a=a78_0x313f49,_0x261d0a=await database_1[_0x2e998a(0x98)]['telegramUser'][_0x2e998a(0x76)]({'where':{'shopId':_0x248a6b,'isVerified':!![]},'orderBy':{'createdAt':'desc'},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x261d0a;}async[a78_0x313f49(0x83)](_0x441083,_0x450e84){const _0x65ac6d=a78_0x313f49,_0x5b7a19=await database_1[_0x65ac6d(0x98)][_0x65ac6d(0xb7)]['findUnique']({'where':{'id':_0x450e84},'select':{'shopId':!![]}});if(!_0x5b7a19)throw new Error('Telegram\x20session\x20not\x20found');if(_0x5b7a19['shopId']!==_0x441083)throw new Error(_0x65ac6d(0xb9));await database_1[_0x65ac6d(0x98)]['telegramUser'][_0x65ac6d(0x9d)]({'where':{'id':_0x450e84},'data':{'shopId':null,'isVerified':![]}});}async[a78_0x313f49(0x80)](_0x3ae12a){const _0x525e10=a78_0x313f49,_0x57825c=await database_1[_0x525e10(0x98)][_0x525e10(0x82)][_0x525e10(0x9e)]({'where':{'shopId':_0x3ae12a}});!_0x57825c&&await database_1[_0x525e10(0x98)][_0x525e10(0x82)][_0x525e10(0x7d)]({'data':{'shopId':_0x3ae12a}});}}exports[a78_0x313f49(0xa0)]=SettingsService;