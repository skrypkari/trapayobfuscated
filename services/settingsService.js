'use strict';const a85_0x1ba883=a85_0x3096;function a85_0x3096(_0x557b09,_0xe07b6){_0x557b09=_0x557b09-0x19a;const _0x4a614c=a85_0x4a61();let _0x3096fd=_0x4a614c[_0x557b09];return _0x3096fd;}(function(_0x1e4b69,_0x37e227){const _0x207422=a85_0x3096,_0x1b4c23=_0x1e4b69();while(!![]){try{const _0x3c2199=parseInt(_0x207422(0x1ea))/0x1*(parseInt(_0x207422(0x1e8))/0x2)+-parseInt(_0x207422(0x1cf))/0x3*(parseInt(_0x207422(0x1d5))/0x4)+parseInt(_0x207422(0x1e1))/0x5+parseInt(_0x207422(0x1c0))/0x6+-parseInt(_0x207422(0x1bc))/0x7*(parseInt(_0x207422(0x1ac))/0x8)+-parseInt(_0x207422(0x1a2))/0x9+parseInt(_0x207422(0x1a5))/0xa;if(_0x3c2199===_0x37e227)break;else _0x1b4c23['push'](_0x1b4c23['shift']());}catch(_0x5bda1b){_0x1b4c23['push'](_0x1b4c23['shift']());}}}(a85_0x4a61,0x7ef3e));var __importDefault=this&&this['__importDefault']||function(_0xd797ec){const _0x547a79=a85_0x3096;return _0xd797ec&&_0xd797ec[_0x547a79(0x1f2)]?_0xd797ec:{'default':_0xd797ec};};Object[a85_0x1ba883(0x1ab)](exports,a85_0x1ba883(0x1f2),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a85_0x1ba883(0x1c8))),speakeasy_1=__importDefault(require(a85_0x1ba883(0x1a1))),database_1=__importDefault(require(a85_0x1ba883(0x1b6)));function a85_0x4a61(){const _0x330a45=['updateNotifications','Current\x20password\x20is\x20incorrect','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','ensureSettingsExist','changePassword','crypto','password','getTelegramSessions','hex','2FA\x20token\x20is\x20required','notificationPaymentSuccess','notificationApiError','113670FuwoOi','notificationLogin','shop','max','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','delete','92GbIACZ','twoFactorEnabled','toString','telegram','telegramChatId','webhookUrl','shopSettings','length','notificationRefund','notificationPayout','desc','maskApiKey','4172400PdEiLC','telegramUsers','sk_','shopUrl','twoFactorSecret','Shop\x20not\x20found','pk_','518742GkkoSX','settings','4DRjPgX','compare','repeat','notificationPaymentFailed','telegramUser','parse','deleteAccount','updateWebhookSettings','__esModule','update','name','findUnique','substring','create','getShopSettings','api_error','SettingsService','speakeasy','8126964xjJaBj','splice','disconnectTelegramSession','6293460HPacJR','_count','updateTelegramSettings','verify','parseWebhookEvents','refund','defineProperty','28232cpzpsn','isArray','stringify','backupCodes','payment_failed','payout','payment_success','findMany','shopId','default','../config/database','totp','randomBytes','base32','Invalid\x202FA\x20token\x20or\x20backup\x20code','webhookEvents','756jFVvaG','telegramBotApiKey','login','chatId','1045716IgkWdj','Unauthorized\x20to\x20disconnect\x20this\x20session','botApiKey'];a85_0x4a61=function(){return _0x330a45;};return a85_0x4a61();}class SettingsService{[a85_0x1ba883(0x1e0)](_0x28dd79){const _0x11c678=a85_0x1ba883;if(!_0x28dd79)return'';if(_0x28dd79[_0x11c678(0x1dc)]<=0x8)return _0x28dd79;const _0x1795c9=_0x28dd79[_0x11c678(0x19c)](0x0,0x8),_0x399195='*'[_0x11c678(0x1ec)](Math[_0x11c678(0x1d2)](0x0,_0x28dd79[_0x11c678(0x1dc)]-0x8));return _0x1795c9+_0x399195;}['parseWebhookEvents'](_0x2c348a){const _0x3b193a=a85_0x1ba883;if(!_0x2c348a)return[];if(Array[_0x3b193a(0x1ad)](_0x2c348a))return _0x2c348a;if(typeof _0x2c348a==='string')try{const _0x153d66=JSON['parse'](_0x2c348a);return Array[_0x3b193a(0x1ad)](_0x153d66)?_0x153d66:[];}catch{return[];}return[];}async[a85_0x1ba883(0x19e)](_0x13f559){const _0x5d0ea1=a85_0x1ba883,_0x5ac311=await database_1[_0x5d0ea1(0x1b5)][_0x5d0ea1(0x1d1)][_0x5d0ea1(0x19b)]({'where':{'id':_0x13f559},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x5ac311)throw new Error('Shop\x20not\x20found');let _0x57cf1a=_0x5ac311[_0x5d0ea1(0x1e9)];return!_0x57cf1a&&(_0x57cf1a=await database_1[_0x5d0ea1(0x1b5)][_0x5d0ea1(0x1db)][_0x5d0ea1(0x19d)]({'data':{'shopId':_0x5ac311['id']}})),{'fullName':_0x5ac311[_0x5d0ea1(0x19a)],'brand':_0x5ac311[_0x5d0ea1(0x19a)],'merchantUrl':_0x5ac311[_0x5d0ea1(0x1e4)],'telegramUsername':_0x5ac311[_0x5d0ea1(0x1d8)],'telegramBotApiKey':_0x57cf1a[_0x5d0ea1(0x1bd)]?this[_0x5d0ea1(0x1e0)](_0x57cf1a['telegramBotApiKey']):null,'telegramChatId':_0x57cf1a[_0x5d0ea1(0x1d9)],'telegramUsersCount':_0x5ac311[_0x5d0ea1(0x1a6)][_0x5d0ea1(0x1e2)],'webhookUrl':_0x57cf1a[_0x5d0ea1(0x1da)],'webhookEvents':this[_0x5d0ea1(0x1a9)](_0x57cf1a[_0x5d0ea1(0x1bb)]),'twoFactorEnabled':_0x5ac311[_0x5d0ea1(0x1d6)]||![],'notifications':{'payment_success':_0x57cf1a[_0x5d0ea1(0x1cd)],'payment_failed':_0x57cf1a[_0x5d0ea1(0x1ed)],'refund':_0x57cf1a[_0x5d0ea1(0x1dd)],'payout':_0x57cf1a[_0x5d0ea1(0x1de)],'login':_0x57cf1a['notificationLogin'],'api_error':_0x57cf1a[_0x5d0ea1(0x1ce)]}};}async[a85_0x1ba883(0x1c7)](_0x5c5a93,_0x13ebf9){const _0x40a72b=a85_0x1ba883,{currentPassword:_0x5e9d76,newPassword:_0x3bba66,confirmNewPassword:_0x2578d7,twoFactorToken:_0x46587b}=_0x13ebf9;if(_0x3bba66!==_0x2578d7)throw new Error(_0x40a72b(0x1c5));if(_0x3bba66[_0x40a72b(0x1dc)]<0x6)throw new Error(_0x40a72b(0x1d3));const _0xb4958e=await database_1[_0x40a72b(0x1b5)]['shop'][_0x40a72b(0x19b)]({'where':{'id':_0x5c5a93},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0xb4958e)throw new Error(_0x40a72b(0x1e6));if(_0xb4958e[_0x40a72b(0x1d6)]){if(!_0x46587b)throw new Error(_0x40a72b(0x1cc));const _0x53a0ae=speakeasy_1['default'][_0x40a72b(0x1b7)][_0x40a72b(0x1a8)]({'secret':_0xb4958e[_0x40a72b(0x1e5)],'encoding':_0x40a72b(0x1b9),'token':_0x46587b,'window':0x2});if(!_0x53a0ae){let _0x1ab60b=![];if(_0xb4958e['backupCodes']){const _0x10f70f=JSON[_0x40a72b(0x1ef)](_0xb4958e[_0x40a72b(0x1af)]);for(let _0x1c7984=0x0;_0x1c7984<_0x10f70f[_0x40a72b(0x1dc)];_0x1c7984++){const _0x4de950=await bcryptjs_1[_0x40a72b(0x1b5)][_0x40a72b(0x1eb)](_0x46587b,_0x10f70f[_0x1c7984]);if(_0x4de950){_0x1ab60b=!![],_0x10f70f[_0x40a72b(0x1a3)](_0x1c7984,0x1),await database_1[_0x40a72b(0x1b5)][_0x40a72b(0x1d1)][_0x40a72b(0x1f3)]({'where':{'id':_0x5c5a93},'data':{'backupCodes':JSON['stringify'](_0x10f70f)}});break;}}}if(!_0x1ab60b)throw new Error(_0x40a72b(0x1ba));}}const _0x3eaf47=await bcryptjs_1[_0x40a72b(0x1b5)][_0x40a72b(0x1eb)](_0x5e9d76,_0xb4958e[_0x40a72b(0x1c9)]);if(!_0x3eaf47)throw new Error(_0x40a72b(0x1c4));const _0x134137=await bcryptjs_1[_0x40a72b(0x1b5)]['hash'](_0x3bba66,0xc);await database_1[_0x40a72b(0x1b5)]['shop'][_0x40a72b(0x1f3)]({'where':{'id':_0x5c5a93},'data':{'password':_0x134137}});}async[a85_0x1ba883(0x1c3)](_0x366426,_0x59bb03){const _0x1013ee=a85_0x1ba883;await this[_0x1013ee(0x1c6)](_0x366426);const _0x487d79={};_0x59bb03[_0x1013ee(0x1b2)]!==undefined&&(_0x487d79[_0x1013ee(0x1cd)]=_0x59bb03[_0x1013ee(0x1b2)]),_0x59bb03[_0x1013ee(0x1b0)]!==undefined&&(_0x487d79[_0x1013ee(0x1ed)]=_0x59bb03[_0x1013ee(0x1b0)]),_0x59bb03[_0x1013ee(0x1aa)]!==undefined&&(_0x487d79['notificationRefund']=_0x59bb03[_0x1013ee(0x1aa)]),_0x59bb03[_0x1013ee(0x1b1)]!==undefined&&(_0x487d79[_0x1013ee(0x1de)]=_0x59bb03[_0x1013ee(0x1b1)]),_0x59bb03[_0x1013ee(0x1be)]!==undefined&&(_0x487d79[_0x1013ee(0x1d0)]=_0x59bb03[_0x1013ee(0x1be)]),_0x59bb03[_0x1013ee(0x19f)]!==undefined&&(_0x487d79[_0x1013ee(0x1ce)]=_0x59bb03['api_error']),await database_1[_0x1013ee(0x1b5)][_0x1013ee(0x1db)][_0x1013ee(0x1f3)]({'where':{'shopId':_0x366426},'data':_0x487d79});}async[a85_0x1ba883(0x1a7)](_0xa492fb,_0x38d1c4){const _0x1ce892=a85_0x1ba883;await this[_0x1ce892(0x1c6)](_0xa492fb);const _0x3bc775={};_0x38d1c4[_0x1ce892(0x1c2)]!==undefined&&(_0x3bc775[_0x1ce892(0x1bd)]=_0x38d1c4['botApiKey']||null),_0x38d1c4[_0x1ce892(0x1bf)]!==undefined&&(_0x3bc775[_0x1ce892(0x1d9)]=_0x38d1c4[_0x1ce892(0x1bf)]||null),await database_1[_0x1ce892(0x1b5)][_0x1ce892(0x1db)][_0x1ce892(0x1f3)]({'where':{'shopId':_0xa492fb},'data':_0x3bc775});}async[a85_0x1ba883(0x1f1)](_0x1c0347,_0x424dd8){const _0x12e015=a85_0x1ba883;await this[_0x12e015(0x1c6)](_0x1c0347);const _0x405646={};_0x424dd8[_0x12e015(0x1da)]!==undefined&&(_0x405646[_0x12e015(0x1da)]=_0x424dd8[_0x12e015(0x1da)]||null),_0x424dd8[_0x12e015(0x1bb)]!==undefined&&(_0x405646[_0x12e015(0x1bb)]=_0x424dd8[_0x12e015(0x1bb)]||[]),await database_1[_0x12e015(0x1b5)][_0x12e015(0x1db)][_0x12e015(0x1f3)]({'where':{'shopId':_0x1c0347},'data':_0x405646});}async['revokeAllApiKeys'](_0x294253,_0x37fd54){const _0x12cfa0=a85_0x1ba883,_0x2e87e5=await database_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1d1)][_0x12cfa0(0x19b)]({'where':{'id':_0x294253},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x2e87e5)throw new Error('Shop\x20not\x20found');if(_0x2e87e5[_0x12cfa0(0x1d6)]){if(!_0x37fd54)throw new Error(_0x12cfa0(0x1cc));const _0x5cf795=speakeasy_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1b7)][_0x12cfa0(0x1a8)]({'secret':_0x2e87e5[_0x12cfa0(0x1e5)],'encoding':_0x12cfa0(0x1b9),'token':_0x37fd54,'window':0x2});if(!_0x5cf795){let _0x2523c4=![];if(_0x2e87e5[_0x12cfa0(0x1af)]){const _0x5e1113=JSON[_0x12cfa0(0x1ef)](_0x2e87e5[_0x12cfa0(0x1af)]);for(let _0x307929=0x0;_0x307929<_0x5e1113['length'];_0x307929++){const _0x3df93f=await bcryptjs_1['default'][_0x12cfa0(0x1eb)](_0x37fd54,_0x5e1113[_0x307929]);if(_0x3df93f){_0x2523c4=!![],_0x5e1113[_0x12cfa0(0x1a3)](_0x307929,0x1),await database_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1d1)]['update']({'where':{'id':_0x294253},'data':{'backupCodes':JSON[_0x12cfa0(0x1ae)](_0x5e1113)}});break;}}}if(!_0x2523c4)throw new Error(_0x12cfa0(0x1ba));}}const _0x1cf83e=_0x12cfa0(0x1e7)+crypto_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1b8)](0x20)[_0x12cfa0(0x1d7)]('hex'),_0x4dedb2=_0x12cfa0(0x1e3)+crypto_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1b8)](0x20)[_0x12cfa0(0x1d7)](_0x12cfa0(0x1cb));await database_1[_0x12cfa0(0x1b5)][_0x12cfa0(0x1d1)][_0x12cfa0(0x1f3)]({'where':{'id':_0x294253},'data':{'publicKey':_0x1cf83e,'secretKey':_0x4dedb2}});}async[a85_0x1ba883(0x1f0)](_0x52d0f8,_0x5c601c){const _0xdd3e4c=a85_0x1ba883,{passwordConfirmation:_0x1a6a68}=_0x5c601c,_0x29ce94=await database_1['default'][_0xdd3e4c(0x1d1)][_0xdd3e4c(0x19b)]({'where':{'id':_0x52d0f8},'select':{'password':!![]}});if(!_0x29ce94)throw new Error('Shop\x20not\x20found');const _0x1aff24=await bcryptjs_1[_0xdd3e4c(0x1b5)][_0xdd3e4c(0x1eb)](_0x1a6a68,_0x29ce94[_0xdd3e4c(0x1c9)]);if(!_0x1aff24)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1['default'][_0xdd3e4c(0x1d1)][_0xdd3e4c(0x1d4)]({'where':{'id':_0x52d0f8}});}async[a85_0x1ba883(0x1ca)](_0x24bb7e){const _0xd43ea3=a85_0x1ba883,_0x1b0540=await database_1['default'][_0xd43ea3(0x1ee)][_0xd43ea3(0x1b3)]({'where':{'shopId':_0x24bb7e,'isVerified':!![]},'orderBy':{'createdAt':_0xd43ea3(0x1df)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x1b0540;}async[a85_0x1ba883(0x1a4)](_0x4c5e91,_0x18b629){const _0x56eb6d=a85_0x1ba883,_0x4b529d=await database_1[_0x56eb6d(0x1b5)][_0x56eb6d(0x1ee)][_0x56eb6d(0x19b)]({'where':{'id':_0x18b629},'select':{'shopId':!![]}});if(!_0x4b529d)throw new Error('Telegram\x20session\x20not\x20found');if(_0x4b529d[_0x56eb6d(0x1b4)]!==_0x4c5e91)throw new Error(_0x56eb6d(0x1c1));await database_1['default'][_0x56eb6d(0x1ee)][_0x56eb6d(0x1f3)]({'where':{'id':_0x18b629},'data':{'shopId':null,'isVerified':![]}});}async['ensureSettingsExist'](_0x5c76d5){const _0x5661c1=a85_0x1ba883,_0x1b832c=await database_1['default'][_0x5661c1(0x1db)]['findUnique']({'where':{'shopId':_0x5c76d5}});!_0x1b832c&&await database_1[_0x5661c1(0x1b5)]['shopSettings'][_0x5661c1(0x19d)]({'data':{'shopId':_0x5c76d5}});}}exports[a85_0x1ba883(0x1a0)]=SettingsService;