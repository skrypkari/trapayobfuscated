'use strict';const a81_0x4d316=a81_0x4da7;function a81_0x4da7(_0xf2b48d,_0x5f623e){_0xf2b48d=_0xf2b48d-0x1ec;const _0x35c3bf=a81_0x35c3();let _0x4da7e3=_0x35c3bf[_0xf2b48d];return _0x4da7e3;}(function(_0x55f5aa,_0x44ef35){const _0x31534a=a81_0x4da7,_0x2004dd=_0x55f5aa();while(!![]){try{const _0x2194c5=parseInt(_0x31534a(0x228))/0x1*(-parseInt(_0x31534a(0x23a))/0x2)+parseInt(_0x31534a(0x236))/0x3+-parseInt(_0x31534a(0x232))/0x4*(parseInt(_0x31534a(0x226))/0x5)+-parseInt(_0x31534a(0x1f8))/0x6+-parseInt(_0x31534a(0x1ee))/0x7+parseInt(_0x31534a(0x225))/0x8+parseInt(_0x31534a(0x210))/0x9;if(_0x2194c5===_0x44ef35)break;else _0x2004dd['push'](_0x2004dd['shift']());}catch(_0x461de5){_0x2004dd['push'](_0x2004dd['shift']());}}}(a81_0x35c3,0xebaf3));var __importDefault=this&&this[a81_0x4d316(0x1f6)]||function(_0x1c3cc0){return _0x1c3cc0&&_0x1c3cc0['__esModule']?_0x1c3cc0:{'default':_0x1c3cc0};};Object['defineProperty'](exports,a81_0x4d316(0x21d),{'value':!![]}),exports[a81_0x4d316(0x20f)]=void 0x0;const bcryptjs_1=__importDefault(require(a81_0x4d316(0x21b))),crypto_1=__importDefault(require(a81_0x4d316(0x229))),speakeasy_1=__importDefault(require(a81_0x4d316(0x207))),database_1=__importDefault(require(a81_0x4d316(0x231)));function a81_0x35c3(){const _0x53aff5=['__esModule','notificationPayout','parse','updateWebhookSettings','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','telegramUser','disconnectTelegramSession','desc','10251704NEZGkG','5148215vFOHTY','api_error','2746IHmABf','crypto','deleteAccount','getTelegramSessions','payment_success','chatId','notificationPaymentFailed','botApiKey','name','../config/database','4WVApAw','payout','Shop\x20not\x20found','stringify','2496849JvDZsX','webhookUrl','payment_failed','default','312qnYJUz','refund','Password\x20confirmation\x20is\x20incorrect','twoFactorSecret','notificationPaymentSuccess','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','getShopSettings','7996849BPpDdy','shopUrl','string','telegramUsers','parseWebhookEvents','revokeAllApiKeys','findUnique','Unauthorized\x20to\x20disconnect\x20this\x20session','__importDefault','create','8311470CXfcJY','2FA\x20token\x20is\x20required','Invalid\x202FA\x20token\x20or\x20backup\x20code','delete','compare','shopSettings','length','shop','totp','update','webhookEvents','isArray','telegramBotApiKey','login','maskApiKey','speakeasy','password','settings','ensureSettingsExist','telegram','Current\x20password\x20is\x20incorrect','shopId','base32','SettingsService','25535592KQmJTu','updateNotifications','backupCodes','changePassword','twoFactorEnabled','notificationApiError','verify','notificationLogin','updateTelegramSettings','splice','notificationRefund','bcryptjs','findMany'];a81_0x35c3=function(){return _0x53aff5;};return a81_0x35c3();}class SettingsService{[a81_0x4d316(0x206)](_0x1be9eb){const _0x3561ab=a81_0x4d316;if(!_0x1be9eb)return'';if(_0x1be9eb[_0x3561ab(0x1fe)]<=0x8)return _0x1be9eb;const _0x5906db=_0x1be9eb['substring'](0x0,0x8),_0x44631e='*'['repeat'](Math['max'](0x0,_0x1be9eb['length']-0x8));return _0x5906db+_0x44631e;}[a81_0x4d316(0x1f2)](_0x542f0d){const _0x31cbc8=a81_0x4d316;if(!_0x542f0d)return[];if(Array['isArray'](_0x542f0d))return _0x542f0d;if(typeof _0x542f0d===_0x31cbc8(0x1f0))try{const _0x15e18c=JSON[_0x31cbc8(0x21f)](_0x542f0d);return Array[_0x31cbc8(0x203)](_0x15e18c)?_0x15e18c:[];}catch{return[];}return[];}async[a81_0x4d316(0x1ed)](_0x477e73){const _0xb03f1b=a81_0x4d316,_0x6d7549=await database_1['default'][_0xb03f1b(0x1ff)]['findUnique']({'where':{'id':_0x477e73},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x6d7549)throw new Error(_0xb03f1b(0x234));let _0x2395e6=_0x6d7549[_0xb03f1b(0x209)];return!_0x2395e6&&(_0x2395e6=await database_1[_0xb03f1b(0x239)][_0xb03f1b(0x1fd)][_0xb03f1b(0x1f7)]({'data':{'shopId':_0x6d7549['id']}})),{'fullName':_0x6d7549[_0xb03f1b(0x230)],'brand':_0x6d7549['name'],'merchantUrl':_0x6d7549[_0xb03f1b(0x1ef)],'telegramUsername':_0x6d7549[_0xb03f1b(0x20b)],'telegramBotApiKey':_0x2395e6[_0xb03f1b(0x204)]?this[_0xb03f1b(0x206)](_0x2395e6[_0xb03f1b(0x204)]):null,'telegramChatId':_0x2395e6['telegramChatId'],'telegramUsersCount':_0x6d7549['_count'][_0xb03f1b(0x1f1)],'webhookUrl':_0x2395e6[_0xb03f1b(0x237)],'webhookEvents':this[_0xb03f1b(0x1f2)](_0x2395e6[_0xb03f1b(0x202)]),'twoFactorEnabled':_0x6d7549['twoFactorEnabled']||![],'notifications':{'payment_success':_0x2395e6[_0xb03f1b(0x23e)],'payment_failed':_0x2395e6[_0xb03f1b(0x22e)],'refund':_0x2395e6[_0xb03f1b(0x21a)],'payout':_0x2395e6[_0xb03f1b(0x21e)],'login':_0x2395e6[_0xb03f1b(0x217)],'api_error':_0x2395e6[_0xb03f1b(0x215)]}};}async[a81_0x4d316(0x213)](_0x29530c,_0xdf28d1){const _0x2429a9=a81_0x4d316,{currentPassword:_0xa050e5,newPassword:_0x1e28b2,confirmNewPassword:_0x46a098,twoFactorToken:_0x6d9c7}=_0xdf28d1;if(_0x1e28b2!==_0x46a098)throw new Error(_0x2429a9(0x221));if(_0x1e28b2[_0x2429a9(0x1fe)]<0x6)throw new Error(_0x2429a9(0x1ec));const _0x47e83c=await database_1[_0x2429a9(0x239)]['shop']['findUnique']({'where':{'id':_0x29530c},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x47e83c)throw new Error('Shop\x20not\x20found');if(_0x47e83c['twoFactorEnabled']){if(!_0x6d9c7)throw new Error(_0x2429a9(0x1f9));const _0xd010d=speakeasy_1['default'][_0x2429a9(0x200)]['verify']({'secret':_0x47e83c[_0x2429a9(0x23d)],'encoding':'base32','token':_0x6d9c7,'window':0x2});if(!_0xd010d){let _0x55959f=![];if(_0x47e83c[_0x2429a9(0x212)]){const _0x4ae869=JSON[_0x2429a9(0x21f)](_0x47e83c[_0x2429a9(0x212)]);for(let _0x34118b=0x0;_0x34118b<_0x4ae869[_0x2429a9(0x1fe)];_0x34118b++){const _0x3cdd0a=await bcryptjs_1[_0x2429a9(0x239)][_0x2429a9(0x1fc)](_0x6d9c7,_0x4ae869[_0x34118b]);if(_0x3cdd0a){_0x55959f=!![],_0x4ae869[_0x2429a9(0x219)](_0x34118b,0x1),await database_1[_0x2429a9(0x239)][_0x2429a9(0x1ff)][_0x2429a9(0x201)]({'where':{'id':_0x29530c},'data':{'backupCodes':JSON[_0x2429a9(0x235)](_0x4ae869)}});break;}}}if(!_0x55959f)throw new Error(_0x2429a9(0x1fa));}}const _0x1f397d=await bcryptjs_1[_0x2429a9(0x239)]['compare'](_0xa050e5,_0x47e83c[_0x2429a9(0x208)]);if(!_0x1f397d)throw new Error(_0x2429a9(0x20c));const _0x2f7e22=await bcryptjs_1[_0x2429a9(0x239)]['hash'](_0x1e28b2,0xc);await database_1[_0x2429a9(0x239)][_0x2429a9(0x1ff)][_0x2429a9(0x201)]({'where':{'id':_0x29530c},'data':{'password':_0x2f7e22}});}async[a81_0x4d316(0x211)](_0xa8a84f,_0x4afb51){const _0x24520c=a81_0x4d316;await this[_0x24520c(0x20a)](_0xa8a84f);const _0x528045={};_0x4afb51[_0x24520c(0x22c)]!==undefined&&(_0x528045[_0x24520c(0x23e)]=_0x4afb51[_0x24520c(0x22c)]),_0x4afb51[_0x24520c(0x238)]!==undefined&&(_0x528045['notificationPaymentFailed']=_0x4afb51[_0x24520c(0x238)]),_0x4afb51[_0x24520c(0x23b)]!==undefined&&(_0x528045[_0x24520c(0x21a)]=_0x4afb51['refund']),_0x4afb51[_0x24520c(0x233)]!==undefined&&(_0x528045[_0x24520c(0x21e)]=_0x4afb51[_0x24520c(0x233)]),_0x4afb51[_0x24520c(0x205)]!==undefined&&(_0x528045[_0x24520c(0x217)]=_0x4afb51['login']),_0x4afb51[_0x24520c(0x227)]!==undefined&&(_0x528045[_0x24520c(0x215)]=_0x4afb51['api_error']),await database_1[_0x24520c(0x239)][_0x24520c(0x1fd)][_0x24520c(0x201)]({'where':{'shopId':_0xa8a84f},'data':_0x528045});}async[a81_0x4d316(0x218)](_0x2eb5d4,_0x56ec28){const _0x2a1ae8=a81_0x4d316;await this[_0x2a1ae8(0x20a)](_0x2eb5d4);const _0xde120c={};_0x56ec28[_0x2a1ae8(0x22f)]!==undefined&&(_0xde120c[_0x2a1ae8(0x204)]=_0x56ec28['botApiKey']||null),_0x56ec28[_0x2a1ae8(0x22d)]!==undefined&&(_0xde120c['telegramChatId']=_0x56ec28[_0x2a1ae8(0x22d)]||null),await database_1['default'][_0x2a1ae8(0x1fd)][_0x2a1ae8(0x201)]({'where':{'shopId':_0x2eb5d4},'data':_0xde120c});}async[a81_0x4d316(0x220)](_0xe12d14,_0x1386c9){const _0x4f88a9=a81_0x4d316;await this[_0x4f88a9(0x20a)](_0xe12d14);const _0x51eec1={};_0x1386c9[_0x4f88a9(0x237)]!==undefined&&(_0x51eec1['webhookUrl']=_0x1386c9[_0x4f88a9(0x237)]||null),_0x1386c9['webhookEvents']!==undefined&&(_0x51eec1[_0x4f88a9(0x202)]=_0x1386c9[_0x4f88a9(0x202)]||[]),await database_1[_0x4f88a9(0x239)][_0x4f88a9(0x1fd)][_0x4f88a9(0x201)]({'where':{'shopId':_0xe12d14},'data':_0x51eec1});}async[a81_0x4d316(0x1f3)](_0x449f43,_0x82e966){const _0xadb2f8=a81_0x4d316,_0x576f5c=await database_1[_0xadb2f8(0x239)][_0xadb2f8(0x1ff)]['findUnique']({'where':{'id':_0x449f43},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x576f5c)throw new Error(_0xadb2f8(0x234));if(_0x576f5c[_0xadb2f8(0x214)]){if(!_0x82e966)throw new Error(_0xadb2f8(0x1f9));const _0x39d3e5=speakeasy_1['default'][_0xadb2f8(0x200)][_0xadb2f8(0x216)]({'secret':_0x576f5c[_0xadb2f8(0x23d)],'encoding':_0xadb2f8(0x20e),'token':_0x82e966,'window':0x2});if(!_0x39d3e5){let _0x37a0ff=![];if(_0x576f5c['backupCodes']){const _0x3b9e39=JSON['parse'](_0x576f5c['backupCodes']);for(let _0x441cbe=0x0;_0x441cbe<_0x3b9e39[_0xadb2f8(0x1fe)];_0x441cbe++){const _0x30997a=await bcryptjs_1[_0xadb2f8(0x239)][_0xadb2f8(0x1fc)](_0x82e966,_0x3b9e39[_0x441cbe]);if(_0x30997a){_0x37a0ff=!![],_0x3b9e39[_0xadb2f8(0x219)](_0x441cbe,0x1),await database_1['default'][_0xadb2f8(0x1ff)][_0xadb2f8(0x201)]({'where':{'id':_0x449f43},'data':{'backupCodes':JSON[_0xadb2f8(0x235)](_0x3b9e39)}});break;}}}if(!_0x37a0ff)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x3325f8='pk_'+crypto_1[_0xadb2f8(0x239)]['randomBytes'](0x20)['toString']('hex'),_0x4415e7='sk_'+crypto_1[_0xadb2f8(0x239)]['randomBytes'](0x20)['toString']('hex');await database_1[_0xadb2f8(0x239)][_0xadb2f8(0x1ff)][_0xadb2f8(0x201)]({'where':{'id':_0x449f43},'data':{'publicKey':_0x3325f8,'secretKey':_0x4415e7}});}async[a81_0x4d316(0x22a)](_0x48a619,_0x3a2f4a){const _0x8f6c08=a81_0x4d316,{passwordConfirmation:_0x5b35b1}=_0x3a2f4a,_0x4bfa57=await database_1[_0x8f6c08(0x239)][_0x8f6c08(0x1ff)]['findUnique']({'where':{'id':_0x48a619},'select':{'password':!![]}});if(!_0x4bfa57)throw new Error(_0x8f6c08(0x234));const _0x215bc6=await bcryptjs_1[_0x8f6c08(0x239)][_0x8f6c08(0x1fc)](_0x5b35b1,_0x4bfa57[_0x8f6c08(0x208)]);if(!_0x215bc6)throw new Error(_0x8f6c08(0x23c));await database_1['default']['shop'][_0x8f6c08(0x1fb)]({'where':{'id':_0x48a619}});}async[a81_0x4d316(0x22b)](_0x6de23f){const _0x3e65c2=a81_0x4d316,_0x46690d=await database_1[_0x3e65c2(0x239)][_0x3e65c2(0x222)][_0x3e65c2(0x21c)]({'where':{'shopId':_0x6de23f,'isVerified':!![]},'orderBy':{'createdAt':_0x3e65c2(0x224)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x46690d;}async[a81_0x4d316(0x223)](_0x22e28f,_0x3484b8){const _0x111220=a81_0x4d316,_0x20b43f=await database_1[_0x111220(0x239)][_0x111220(0x222)][_0x111220(0x1f4)]({'where':{'id':_0x3484b8},'select':{'shopId':!![]}});if(!_0x20b43f)throw new Error('Telegram\x20session\x20not\x20found');if(_0x20b43f[_0x111220(0x20d)]!==_0x22e28f)throw new Error(_0x111220(0x1f5));await database_1[_0x111220(0x239)][_0x111220(0x222)][_0x111220(0x201)]({'where':{'id':_0x3484b8},'data':{'shopId':null,'isVerified':![]}});}async['ensureSettingsExist'](_0x50b8ca){const _0x34ad1d=a81_0x4d316,_0x15a8e=await database_1['default'][_0x34ad1d(0x1fd)][_0x34ad1d(0x1f4)]({'where':{'shopId':_0x50b8ca}});!_0x15a8e&&await database_1[_0x34ad1d(0x239)][_0x34ad1d(0x1fd)]['create']({'data':{'shopId':_0x50b8ca}});}}exports[a81_0x4d316(0x20f)]=SettingsService;