'use strict';const a72_0x239b22=a72_0x118e;(function(_0x2d4dce,_0x447b77){const _0x369988=a72_0x118e,_0xca8793=_0x2d4dce();while(!![]){try{const _0xaa6e7b=-parseInt(_0x369988(0x17a))/0x1*(-parseInt(_0x369988(0x16c))/0x2)+parseInt(_0x369988(0x17b))/0x3+parseInt(_0x369988(0x159))/0x4*(parseInt(_0x369988(0x16b))/0x5)+parseInt(_0x369988(0x189))/0x6+-parseInt(_0x369988(0x170))/0x7*(-parseInt(_0x369988(0x15a))/0x8)+parseInt(_0x369988(0x177))/0x9*(-parseInt(_0x369988(0x176))/0xa)+parseInt(_0x369988(0x161))/0xb*(-parseInt(_0x369988(0x17d))/0xc);if(_0xaa6e7b===_0x447b77)break;else _0xca8793['push'](_0xca8793['shift']());}catch(_0x4c7ea2){_0xca8793['push'](_0xca8793['shift']());}}}(a72_0x2652,0xabdd7));function a72_0x2652(){const _0x47aea7=['changePassword','5700876JMBwJc','delete','chatId','compare','SettingsService','max','Current\x20password\x20is\x20incorrect','payout','shopSettings','pk_','create','shop','4785078gHiseB','api_error','telegramChatId','repeat','notificationPaymentSuccess','ensureSettingsExist','update','notificationLogin','webhookEvents','hex','password','notificationRefund','settings','parse','botApiKey','__esModule','length','defineProperty','488868GUcXOk','8ETfmRL','Shop\x20not\x20found','bcryptjs','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','string','maskApiKey','updateWebhookSettings','55oNUNWW','webhookUrl','isArray','findUnique','login','refund','notificationPayout','notificationPaymentFailed','substring','toString','10sVutGi','6cMnplD','hash','sk_','getShopSettings','6188581DecVAh','default','randomBytes','__importDefault','parseWebhookEvents','name','11630PpVAim','4581yLTsdr','telegramBotApiKey','notificationApiError','227718Ipheim','3186321ERqZhZ'];a72_0x2652=function(){return _0x47aea7;};return a72_0x2652();}var __importDefault=this&&this[a72_0x239b22(0x173)]||function(_0x58eb79){const _0x489f62=a72_0x239b22;return _0x58eb79&&_0x58eb79[_0x489f62(0x156)]?_0x58eb79:{'default':_0x58eb79};};function a72_0x118e(_0x564c13,_0xd1198d){_0x564c13=_0x564c13-0x156;const _0x265297=a72_0x2652();let _0x118e51=_0x265297[_0x564c13];return _0x118e51;}Object[a72_0x239b22(0x158)](exports,a72_0x239b22(0x156),{'value':!![]}),exports[a72_0x239b22(0x181)]=void 0x0;const bcryptjs_1=__importDefault(require(a72_0x239b22(0x15c))),crypto_1=__importDefault(require('crypto')),database_1=__importDefault(require('../config/database'));class SettingsService{[a72_0x239b22(0x15f)](_0x111c3d){const _0x526ba3=a72_0x239b22;if(!_0x111c3d)return'';if(_0x111c3d[_0x526ba3(0x157)]<=0x8)return _0x111c3d;const _0x1ac147=_0x111c3d[_0x526ba3(0x169)](0x0,0x8),_0x2c7e46='*'[_0x526ba3(0x18c)](Math[_0x526ba3(0x182)](0x0,_0x111c3d['length']-0x8));return _0x1ac147+_0x2c7e46;}[a72_0x239b22(0x174)](_0x5e01a0){const _0x163f22=a72_0x239b22;if(!_0x5e01a0)return[];if(Array[_0x163f22(0x163)](_0x5e01a0))return _0x5e01a0;if(typeof _0x5e01a0===_0x163f22(0x15e))try{const _0x36100b=JSON[_0x163f22(0x196)](_0x5e01a0);return Array[_0x163f22(0x163)](_0x36100b)?_0x36100b:[];}catch{return[];}return[];}async[a72_0x239b22(0x16f)](_0x59b240){const _0x291a29=a72_0x239b22,_0x2d16b6=await database_1[_0x291a29(0x171)][_0x291a29(0x188)][_0x291a29(0x164)]({'where':{'id':_0x59b240},'include':{'settings':!![]}});if(!_0x2d16b6)throw new Error('Shop\x20not\x20found');let _0x4eb4a7=_0x2d16b6[_0x291a29(0x195)];return!_0x4eb4a7&&(_0x4eb4a7=await database_1[_0x291a29(0x171)][_0x291a29(0x185)]['create']({'data':{'shopId':_0x2d16b6['id']}})),{'fullName':_0x2d16b6[_0x291a29(0x175)],'brand':_0x2d16b6['name'],'merchantUrl':_0x2d16b6['shopUrl'],'telegramUsername':_0x2d16b6['telegram'],'telegramBotApiKey':_0x4eb4a7[_0x291a29(0x178)]?this[_0x291a29(0x15f)](_0x4eb4a7[_0x291a29(0x178)]):null,'telegramChatId':_0x4eb4a7[_0x291a29(0x18b)],'webhookUrl':_0x4eb4a7['webhookUrl'],'webhookEvents':this[_0x291a29(0x174)](_0x4eb4a7[_0x291a29(0x191)]),'notifications':{'payment_success':_0x4eb4a7[_0x291a29(0x18d)],'payment_failed':_0x4eb4a7[_0x291a29(0x168)],'refund':_0x4eb4a7[_0x291a29(0x194)],'payout':_0x4eb4a7[_0x291a29(0x167)],'login':_0x4eb4a7['notificationLogin'],'api_error':_0x4eb4a7[_0x291a29(0x179)]}};}async[a72_0x239b22(0x17c)](_0x219769,_0x22eca4){const _0xf1ce8d=a72_0x239b22,{currentPassword:_0x68ac90,newPassword:_0x31de1f,confirmNewPassword:_0x39c7d1}=_0x22eca4;if(_0x31de1f!==_0x39c7d1)throw new Error(_0xf1ce8d(0x15d));if(_0x31de1f[_0xf1ce8d(0x157)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0xd48df2=await database_1[_0xf1ce8d(0x171)][_0xf1ce8d(0x188)][_0xf1ce8d(0x164)]({'where':{'id':_0x219769},'select':{'password':!![]}});if(!_0xd48df2)throw new Error(_0xf1ce8d(0x15b));const _0x414e63=await bcryptjs_1[_0xf1ce8d(0x171)][_0xf1ce8d(0x180)](_0x68ac90,_0xd48df2[_0xf1ce8d(0x193)]);if(!_0x414e63)throw new Error(_0xf1ce8d(0x183));const _0x28839d=await bcryptjs_1[_0xf1ce8d(0x171)][_0xf1ce8d(0x16d)](_0x31de1f,0xc);await database_1[_0xf1ce8d(0x171)][_0xf1ce8d(0x188)][_0xf1ce8d(0x18f)]({'where':{'id':_0x219769},'data':{'password':_0x28839d}});}async['updateNotifications'](_0x2dcfa4,_0x117171){const _0x1ab61d=a72_0x239b22;await this[_0x1ab61d(0x18e)](_0x2dcfa4);const _0x4b2c60={};_0x117171['payment_success']!==undefined&&(_0x4b2c60[_0x1ab61d(0x18d)]=_0x117171['payment_success']),_0x117171['payment_failed']!==undefined&&(_0x4b2c60['notificationPaymentFailed']=_0x117171['payment_failed']),_0x117171['refund']!==undefined&&(_0x4b2c60[_0x1ab61d(0x194)]=_0x117171[_0x1ab61d(0x166)]),_0x117171[_0x1ab61d(0x184)]!==undefined&&(_0x4b2c60['notificationPayout']=_0x117171[_0x1ab61d(0x184)]),_0x117171[_0x1ab61d(0x165)]!==undefined&&(_0x4b2c60[_0x1ab61d(0x190)]=_0x117171['login']),_0x117171['api_error']!==undefined&&(_0x4b2c60['notificationApiError']=_0x117171[_0x1ab61d(0x18a)]),await database_1['default'][_0x1ab61d(0x185)][_0x1ab61d(0x18f)]({'where':{'shopId':_0x2dcfa4},'data':_0x4b2c60});}async['updateTelegramSettings'](_0x4995f6,_0x196113){const _0x392ffd=a72_0x239b22;await this[_0x392ffd(0x18e)](_0x4995f6);const _0x5ea79a={};_0x196113[_0x392ffd(0x197)]!==undefined&&(_0x5ea79a[_0x392ffd(0x178)]=_0x196113['botApiKey']||null),_0x196113['chatId']!==undefined&&(_0x5ea79a[_0x392ffd(0x18b)]=_0x196113[_0x392ffd(0x17f)]||null),await database_1['default'][_0x392ffd(0x185)][_0x392ffd(0x18f)]({'where':{'shopId':_0x4995f6},'data':_0x5ea79a});}async[a72_0x239b22(0x160)](_0x47c332,_0x64c4f0){const _0x237a7f=a72_0x239b22;await this['ensureSettingsExist'](_0x47c332);const _0xcb640a={};_0x64c4f0[_0x237a7f(0x162)]!==undefined&&(_0xcb640a['webhookUrl']=_0x64c4f0[_0x237a7f(0x162)]||null),_0x64c4f0['webhookEvents']!==undefined&&(_0xcb640a[_0x237a7f(0x191)]=_0x64c4f0['webhookEvents']||[]),await database_1['default']['shopSettings']['update']({'where':{'shopId':_0x47c332},'data':_0xcb640a});}async['revokeAllApiKeys'](_0xbad70d){const _0x5cd721=a72_0x239b22,_0xec9315=_0x5cd721(0x186)+crypto_1[_0x5cd721(0x171)][_0x5cd721(0x172)](0x20)[_0x5cd721(0x16a)]('hex'),_0x4f9935=_0x5cd721(0x16e)+crypto_1[_0x5cd721(0x171)]['randomBytes'](0x20)[_0x5cd721(0x16a)](_0x5cd721(0x192));await database_1[_0x5cd721(0x171)][_0x5cd721(0x188)]['update']({'where':{'id':_0xbad70d},'data':{'publicKey':_0xec9315,'secretKey':_0x4f9935}});}async['deleteAccount'](_0x3b8ce4,_0x58efd2){const _0x592e5b=a72_0x239b22,{passwordConfirmation:_0x1bbf14}=_0x58efd2,_0x3c68d6=await database_1['default']['shop'][_0x592e5b(0x164)]({'where':{'id':_0x3b8ce4},'select':{'password':!![]}});if(!_0x3c68d6)throw new Error(_0x592e5b(0x15b));const _0x150c3d=await bcryptjs_1[_0x592e5b(0x171)]['compare'](_0x1bbf14,_0x3c68d6[_0x592e5b(0x193)]);if(!_0x150c3d)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x592e5b(0x171)][_0x592e5b(0x188)][_0x592e5b(0x17e)]({'where':{'id':_0x3b8ce4}});}async[a72_0x239b22(0x18e)](_0x148c3b){const _0x31029d=a72_0x239b22,_0x5f5a36=await database_1[_0x31029d(0x171)][_0x31029d(0x185)]['findUnique']({'where':{'shopId':_0x148c3b}});!_0x5f5a36&&await database_1['default'][_0x31029d(0x185)][_0x31029d(0x187)]({'data':{'shopId':_0x148c3b}});}}exports[a72_0x239b22(0x181)]=SettingsService;