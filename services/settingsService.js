'use strict';function a53_0x520c(_0x33ff73,_0x23c2d8){const _0x5b5227=a53_0x5b52();return a53_0x520c=function(_0x520cdb,_0x34035e){_0x520cdb=_0x520cdb-0xa0;let _0x582d19=_0x5b5227[_0x520cdb];return _0x582d19;},a53_0x520c(_0x33ff73,_0x23c2d8);}const a53_0x390f37=a53_0x520c;(function(_0x3fd7fe,_0x25c0e4){const _0x31b91d=a53_0x520c,_0x3fc8ca=_0x3fd7fe();while(!![]){try{const _0x160ae9=-parseInt(_0x31b91d(0xac))/0x1+-parseInt(_0x31b91d(0xa1))/0x2+parseInt(_0x31b91d(0xbc))/0x3*(-parseInt(_0x31b91d(0xbb))/0x4)+parseInt(_0x31b91d(0xca))/0x5+parseInt(_0x31b91d(0xc9))/0x6+parseInt(_0x31b91d(0xa4))/0x7*(parseInt(_0x31b91d(0xaa))/0x8)+-parseInt(_0x31b91d(0xd9))/0x9*(parseInt(_0x31b91d(0xaf))/0xa);if(_0x160ae9===_0x25c0e4)break;else _0x3fc8ca['push'](_0x3fc8ca['shift']());}catch(_0x1a7778){_0x3fc8ca['push'](_0x3fc8ca['shift']());}}}(a53_0x5b52,0x4eb38));function a53_0x5b52(){const _0x341686=['repeat','SettingsService','payment_success','chatId','1234790xnllTf','randomBytes','parse','28hxSILP','Shop\x20not\x20found','refund','settings','notificationLogin','payment_failed','641064keHvSX','api_error','245910IGWbvS','hash','updateNotifications','430tAaPeA','deleteAccount','Current\x20password\x20is\x20incorrect','password','shopUrl','getShopSettings','default','notificationPayout','updateWebhookSettings','isArray','updateTelegramSettings','length','368580yPMcDQ','3xtoqHc','string','ensureSettingsExist','compare','update','parseWebhookEvents','bcryptjs','webhookEvents','create','pk_','notificationPaymentFailed','delete','login','3657672VokGev','1874425dGOCSx','notificationPaymentSuccess','defineProperty','payout','toString','telegramBotApiKey','findUnique','webhookUrl','maskApiKey','name','telegramChatId','__esModule','revokeAllApiKeys','hex','../config/database','5697xAQdTK','telegram','shop','notificationApiError','notificationRefund','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','shopSettings'];a53_0x5b52=function(){return _0x341686;};return a53_0x5b52();}var __importDefault=this&&this['__importDefault']||function(_0x3a64cd){const _0x4a8c48=a53_0x520c;return _0x3a64cd&&_0x3a64cd[_0x4a8c48(0xd5)]?_0x3a64cd:{'default':_0x3a64cd};};Object[a53_0x390f37(0xcc)](exports,a53_0x390f37(0xd5),{'value':!![]}),exports[a53_0x390f37(0xe1)]=void 0x0;const bcryptjs_1=__importDefault(require(a53_0x390f37(0xc2))),crypto_1=__importDefault(require('crypto')),database_1=__importDefault(require(a53_0x390f37(0xd8)));class SettingsService{[a53_0x390f37(0xd2)](_0x10ff5f){const _0x49c390=a53_0x390f37;if(!_0x10ff5f)return'';if(_0x10ff5f[_0x49c390(0xba)]<=0x8)return _0x10ff5f;const _0x1d73db=_0x10ff5f['substring'](0x0,0x8),_0x5423a2='*'[_0x49c390(0xe0)](Math['max'](0x0,_0x10ff5f[_0x49c390(0xba)]-0x8));return _0x1d73db+_0x5423a2;}['parseWebhookEvents'](_0xf71b46){const _0x5da986=a53_0x390f37;if(!_0xf71b46)return[];if(Array[_0x5da986(0xb8)](_0xf71b46))return _0xf71b46;if(typeof _0xf71b46===_0x5da986(0xbd))try{const _0x3cb82f=JSON[_0x5da986(0xa3)](_0xf71b46);return Array['isArray'](_0x3cb82f)?_0x3cb82f:[];}catch{return[];}return[];}async[a53_0x390f37(0xb4)](_0x755859){const _0x8cbf58=a53_0x390f37,_0x32aa9c=await database_1[_0x8cbf58(0xb5)][_0x8cbf58(0xdb)][_0x8cbf58(0xd0)]({'where':{'id':_0x755859},'include':{'settings':!![]}});if(!_0x32aa9c)throw new Error(_0x8cbf58(0xa5));let _0x46995f=_0x32aa9c[_0x8cbf58(0xa7)];return!_0x46995f&&(_0x46995f=await database_1[_0x8cbf58(0xb5)][_0x8cbf58(0xdf)][_0x8cbf58(0xc4)]({'data':{'shopId':_0x32aa9c['id']}})),{'fullName':_0x32aa9c[_0x8cbf58(0xd3)],'brand':_0x32aa9c[_0x8cbf58(0xd3)],'merchantUrl':_0x32aa9c[_0x8cbf58(0xb3)],'telegramUsername':_0x32aa9c[_0x8cbf58(0xda)],'telegramBotApiKey':_0x46995f[_0x8cbf58(0xcf)]?this[_0x8cbf58(0xd2)](_0x46995f[_0x8cbf58(0xcf)]):null,'telegramChatId':_0x46995f[_0x8cbf58(0xd4)],'webhookUrl':_0x46995f[_0x8cbf58(0xd1)],'webhookEvents':this[_0x8cbf58(0xc1)](_0x46995f['webhookEvents']),'notifications':{'payment_success':_0x46995f[_0x8cbf58(0xcb)],'payment_failed':_0x46995f[_0x8cbf58(0xc6)],'refund':_0x46995f[_0x8cbf58(0xdd)],'payout':_0x46995f[_0x8cbf58(0xb6)],'login':_0x46995f[_0x8cbf58(0xa8)],'api_error':_0x46995f[_0x8cbf58(0xdc)]}};}async['changePassword'](_0x5a51ec,_0x4754c4){const _0x4b12cc=a53_0x390f37,{currentPassword:_0x47d2c5,newPassword:_0x3abb3d,confirmNewPassword:_0x1de5d3}=_0x4754c4;if(_0x3abb3d!==_0x1de5d3)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x3abb3d[_0x4b12cc(0xba)]<0x6)throw new Error(_0x4b12cc(0xde));const _0x141da8=await database_1[_0x4b12cc(0xb5)][_0x4b12cc(0xdb)][_0x4b12cc(0xd0)]({'where':{'id':_0x5a51ec},'select':{'password':!![]}});if(!_0x141da8)throw new Error(_0x4b12cc(0xa5));const _0x384970=await bcryptjs_1[_0x4b12cc(0xb5)][_0x4b12cc(0xbf)](_0x47d2c5,_0x141da8[_0x4b12cc(0xb2)]);if(!_0x384970)throw new Error(_0x4b12cc(0xb1));const _0x27caf9=await bcryptjs_1['default'][_0x4b12cc(0xad)](_0x3abb3d,0xc);await database_1['default'][_0x4b12cc(0xdb)]['update']({'where':{'id':_0x5a51ec},'data':{'password':_0x27caf9}});}async[a53_0x390f37(0xae)](_0x2ec431,_0x28e1b1){const _0x3e290b=a53_0x390f37;await this[_0x3e290b(0xbe)](_0x2ec431);const _0x2eb0f4={};_0x28e1b1[_0x3e290b(0xe2)]!==undefined&&(_0x2eb0f4[_0x3e290b(0xcb)]=_0x28e1b1['payment_success']),_0x28e1b1[_0x3e290b(0xa9)]!==undefined&&(_0x2eb0f4[_0x3e290b(0xc6)]=_0x28e1b1[_0x3e290b(0xa9)]),_0x28e1b1[_0x3e290b(0xa6)]!==undefined&&(_0x2eb0f4['notificationRefund']=_0x28e1b1['refund']),_0x28e1b1[_0x3e290b(0xcd)]!==undefined&&(_0x2eb0f4['notificationPayout']=_0x28e1b1[_0x3e290b(0xcd)]),_0x28e1b1[_0x3e290b(0xc8)]!==undefined&&(_0x2eb0f4[_0x3e290b(0xa8)]=_0x28e1b1['login']),_0x28e1b1['api_error']!==undefined&&(_0x2eb0f4[_0x3e290b(0xdc)]=_0x28e1b1[_0x3e290b(0xab)]),await database_1[_0x3e290b(0xb5)]['shopSettings']['update']({'where':{'shopId':_0x2ec431},'data':_0x2eb0f4});}async[a53_0x390f37(0xb9)](_0x3c8168,_0x5b4231){const _0x152289=a53_0x390f37;await this['ensureSettingsExist'](_0x3c8168);const _0x2f6bb3={};_0x5b4231['botApiKey']!==undefined&&(_0x2f6bb3[_0x152289(0xcf)]=_0x5b4231['botApiKey']||null),_0x5b4231[_0x152289(0xa0)]!==undefined&&(_0x2f6bb3[_0x152289(0xd4)]=_0x5b4231[_0x152289(0xa0)]||null),await database_1[_0x152289(0xb5)]['shopSettings'][_0x152289(0xc0)]({'where':{'shopId':_0x3c8168},'data':_0x2f6bb3});}async[a53_0x390f37(0xb7)](_0x153424,_0x207854){const _0xa819db=a53_0x390f37;await this[_0xa819db(0xbe)](_0x153424);const _0x111dc4={};_0x207854['webhookUrl']!==undefined&&(_0x111dc4[_0xa819db(0xd1)]=_0x207854[_0xa819db(0xd1)]||null),_0x207854[_0xa819db(0xc3)]!==undefined&&(_0x111dc4[_0xa819db(0xc3)]=_0x207854[_0xa819db(0xc3)]||[]),await database_1[_0xa819db(0xb5)]['shopSettings'][_0xa819db(0xc0)]({'where':{'shopId':_0x153424},'data':_0x111dc4});}async[a53_0x390f37(0xd6)](_0x338757){const _0x3315b0=a53_0x390f37,_0x3e8c03=_0x3315b0(0xc5)+crypto_1[_0x3315b0(0xb5)][_0x3315b0(0xa2)](0x20)['toString'](_0x3315b0(0xd7)),_0x281e0a='sk_'+crypto_1[_0x3315b0(0xb5)][_0x3315b0(0xa2)](0x20)[_0x3315b0(0xce)]('hex');await database_1[_0x3315b0(0xb5)]['shop'][_0x3315b0(0xc0)]({'where':{'id':_0x338757},'data':{'publicKey':_0x3e8c03,'secretKey':_0x281e0a}});}async[a53_0x390f37(0xb0)](_0x240f02,_0x1c06ac){const _0x1c1356=a53_0x390f37,{passwordConfirmation:_0x3a4364}=_0x1c06ac,_0x6e6eec=await database_1[_0x1c1356(0xb5)][_0x1c1356(0xdb)][_0x1c1356(0xd0)]({'where':{'id':_0x240f02},'select':{'password':!![]}});if(!_0x6e6eec)throw new Error(_0x1c1356(0xa5));const _0x17cf67=await bcryptjs_1[_0x1c1356(0xb5)][_0x1c1356(0xbf)](_0x3a4364,_0x6e6eec[_0x1c1356(0xb2)]);if(!_0x17cf67)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1['default'][_0x1c1356(0xdb)][_0x1c1356(0xc7)]({'where':{'id':_0x240f02}});}async[a53_0x390f37(0xbe)](_0x1ba60d){const _0x5aedb8=a53_0x390f37,_0xec2b25=await database_1[_0x5aedb8(0xb5)]['shopSettings'][_0x5aedb8(0xd0)]({'where':{'shopId':_0x1ba60d}});!_0xec2b25&&await database_1[_0x5aedb8(0xb5)][_0x5aedb8(0xdf)][_0x5aedb8(0xc4)]({'data':{'shopId':_0x1ba60d}});}}exports[a53_0x390f37(0xe1)]=SettingsService;