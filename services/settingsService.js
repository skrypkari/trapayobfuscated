'use strict';const a85_0x184e08=a85_0x558e;function a85_0x558e(_0x1e0150,_0x13ad5f){_0x1e0150=_0x1e0150-0x1a4;const _0xcc6dfd=a85_0xcc6d();let _0x558eee=_0xcc6dfd[_0x1e0150];return _0x558eee;}(function(_0x45de6a,_0x4b3281){const _0x52c9a5=a85_0x558e,_0x36cf0d=_0x45de6a();while(!![]){try{const _0x4cade1=-parseInt(_0x52c9a5(0x1ca))/0x1*(-parseInt(_0x52c9a5(0x1e0))/0x2)+-parseInt(_0x52c9a5(0x1dd))/0x3*(parseInt(_0x52c9a5(0x1ce))/0x4)+parseInt(_0x52c9a5(0x1c2))/0x5+-parseInt(_0x52c9a5(0x1f2))/0x6+-parseInt(_0x52c9a5(0x1be))/0x7*(-parseInt(_0x52c9a5(0x1fa))/0x8)+parseInt(_0x52c9a5(0x1ab))/0x9+-parseInt(_0x52c9a5(0x1b7))/0xa*(-parseInt(_0x52c9a5(0x1b5))/0xb);if(_0x4cade1===_0x4b3281)break;else _0x36cf0d['push'](_0x36cf0d['shift']());}catch(_0x5e59a3){_0x36cf0d['push'](_0x36cf0d['shift']());}}}(a85_0xcc6d,0xf35ab));function a85_0xcc6d(){const _0x5d185=['2599940mxABhk','crypto','twoFactorSecret','stringify','Invalid\x202FA\x20token\x20or\x20backup\x20code','findMany','totp','shop','1374158PVRpRE','Unauthorized\x20to\x20disconnect\x20this\x20session','shopId','__importDefault','5832688arhHjf','base32','telegramBotApiKey','compare','notificationLogin','desc','refund','max','pk_','isArray','updateNotifications','Shop\x20not\x20found','notificationApiError','backupCodes','notificationPaymentSuccess','3hIRCoP','SettingsService','Current\x20password\x20is\x20incorrect','2MobWga','updateWebhookSettings','api_error','bcryptjs','twoFactorEnabled','payout','substring','speakeasy','webhookUrl','payment_failed','ensureSettingsExist','notificationPaymentFailed','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','login','deleteAccount','2FA\x20token\x20is\x20required','revokeAllApiKeys','findUnique','10888266nepWSu','hex','_count','name','Telegram\x20session\x20not\x20found','getShopSettings','notificationPayout','changePassword','10016lhLSIn','repeat','payment_success','telegramChatId','shopUrl','length','chatId','parse','string','maskApiKey','verify','update','5862987vBLCsz','botApiKey','parseWebhookEvents','telegramUser','splice','randomBytes','Password\x20confirmation\x20is\x20incorrect','shopSettings','webhookEvents','defineProperty','3781943QWfHWn','password','50BndOmV','notificationRefund','toString','create','settings','__esModule','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','28pkiPZY','telegramUsers','default','updateTelegramSettings'];a85_0xcc6d=function(){return _0x5d185;};return a85_0xcc6d();}var __importDefault=this&&this[a85_0x184e08(0x1cd)]||function(_0x226092){const _0x2b9bb5=a85_0x184e08;return _0x226092&&_0x226092[_0x2b9bb5(0x1bc)]?_0x226092:{'default':_0x226092};};Object[a85_0x184e08(0x1b4)](exports,a85_0x184e08(0x1bc),{'value':!![]}),exports[a85_0x184e08(0x1de)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x184e08(0x1e3))),crypto_1=__importDefault(require(a85_0x184e08(0x1c3))),speakeasy_1=__importDefault(require(a85_0x184e08(0x1e7))),database_1=__importDefault(require('../config/database'));class SettingsService{[a85_0x184e08(0x1a8)](_0x44d328){const _0x548e08=a85_0x184e08;if(!_0x44d328)return'';if(_0x44d328[_0x548e08(0x1a4)]<=0x8)return _0x44d328;const _0x307312=_0x44d328[_0x548e08(0x1e6)](0x0,0x8),_0x4da0bd='*'[_0x548e08(0x1fb)](Math[_0x548e08(0x1d5)](0x0,_0x44d328['length']-0x8));return _0x307312+_0x4da0bd;}[a85_0x184e08(0x1ad)](_0x43eb1c){const _0x4292c3=a85_0x184e08;if(!_0x43eb1c)return[];if(Array['isArray'](_0x43eb1c))return _0x43eb1c;if(typeof _0x43eb1c===_0x4292c3(0x1a7))try{const _0x42e340=JSON[_0x4292c3(0x1a6)](_0x43eb1c);return Array[_0x4292c3(0x1d7)](_0x42e340)?_0x42e340:[];}catch{return[];}return[];}async[a85_0x184e08(0x1f7)](_0x107b04){const _0x4aab28=a85_0x184e08,_0x2b2e38=await database_1[_0x4aab28(0x1c0)]['shop'][_0x4aab28(0x1f1)]({'where':{'id':_0x107b04},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2b2e38)throw new Error(_0x4aab28(0x1d9));let _0x2c1792=_0x2b2e38[_0x4aab28(0x1bb)];return!_0x2c1792&&(_0x2c1792=await database_1[_0x4aab28(0x1c0)][_0x4aab28(0x1b2)][_0x4aab28(0x1ba)]({'data':{'shopId':_0x2b2e38['id']}})),{'fullName':_0x2b2e38[_0x4aab28(0x1f5)],'brand':_0x2b2e38[_0x4aab28(0x1f5)],'merchantUrl':_0x2b2e38[_0x4aab28(0x1fe)],'telegramUsername':_0x2b2e38['telegram'],'telegramBotApiKey':_0x2c1792[_0x4aab28(0x1d0)]?this[_0x4aab28(0x1a8)](_0x2c1792['telegramBotApiKey']):null,'telegramChatId':_0x2c1792['telegramChatId'],'telegramUsersCount':_0x2b2e38[_0x4aab28(0x1f4)][_0x4aab28(0x1bf)],'webhookUrl':_0x2c1792['webhookUrl'],'webhookEvents':this[_0x4aab28(0x1ad)](_0x2c1792[_0x4aab28(0x1b3)]),'twoFactorEnabled':_0x2b2e38[_0x4aab28(0x1e4)]||![],'notifications':{'payment_success':_0x2c1792[_0x4aab28(0x1dc)],'payment_failed':_0x2c1792[_0x4aab28(0x1eb)],'refund':_0x2c1792['notificationRefund'],'payout':_0x2c1792['notificationPayout'],'login':_0x2c1792[_0x4aab28(0x1d2)],'api_error':_0x2c1792['notificationApiError']}};}async[a85_0x184e08(0x1f9)](_0x63792b,_0x506bb7){const _0x1aea46=a85_0x184e08,{currentPassword:_0x20db8a,newPassword:_0x2c6bbc,confirmNewPassword:_0x57a25b,twoFactorToken:_0x53f618}=_0x506bb7;if(_0x2c6bbc!==_0x57a25b)throw new Error(_0x1aea46(0x1bd));if(_0x2c6bbc[_0x1aea46(0x1a4)]<0x6)throw new Error(_0x1aea46(0x1ec));const _0x2d13e7=await database_1['default'][_0x1aea46(0x1c9)][_0x1aea46(0x1f1)]({'where':{'id':_0x63792b},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x2d13e7)throw new Error(_0x1aea46(0x1d9));if(_0x2d13e7[_0x1aea46(0x1e4)]){if(!_0x53f618)throw new Error(_0x1aea46(0x1ef));const _0x39d699=speakeasy_1[_0x1aea46(0x1c0)][_0x1aea46(0x1c8)][_0x1aea46(0x1a9)]({'secret':_0x2d13e7['twoFactorSecret'],'encoding':_0x1aea46(0x1cf),'token':_0x53f618,'window':0x2});if(!_0x39d699){let _0x618ea4=![];if(_0x2d13e7[_0x1aea46(0x1db)]){const _0x2d2190=JSON[_0x1aea46(0x1a6)](_0x2d13e7[_0x1aea46(0x1db)]);for(let _0x310d06=0x0;_0x310d06<_0x2d2190[_0x1aea46(0x1a4)];_0x310d06++){const _0x3d00ad=await bcryptjs_1['default'][_0x1aea46(0x1d1)](_0x53f618,_0x2d2190[_0x310d06]);if(_0x3d00ad){_0x618ea4=!![],_0x2d2190[_0x1aea46(0x1af)](_0x310d06,0x1),await database_1[_0x1aea46(0x1c0)][_0x1aea46(0x1c9)]['update']({'where':{'id':_0x63792b},'data':{'backupCodes':JSON['stringify'](_0x2d2190)}});break;}}}if(!_0x618ea4)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x42c081=await bcryptjs_1['default']['compare'](_0x20db8a,_0x2d13e7[_0x1aea46(0x1b6)]);if(!_0x42c081)throw new Error(_0x1aea46(0x1df));const _0x5d8e8e=await bcryptjs_1['default']['hash'](_0x2c6bbc,0xc);await database_1[_0x1aea46(0x1c0)]['shop']['update']({'where':{'id':_0x63792b},'data':{'password':_0x5d8e8e}});}async[a85_0x184e08(0x1d8)](_0x9b527c,_0x538525){const _0x3ce226=a85_0x184e08;await this[_0x3ce226(0x1ea)](_0x9b527c);const _0x46da92={};_0x538525['payment_success']!==undefined&&(_0x46da92[_0x3ce226(0x1dc)]=_0x538525[_0x3ce226(0x1fc)]),_0x538525[_0x3ce226(0x1e9)]!==undefined&&(_0x46da92[_0x3ce226(0x1eb)]=_0x538525[_0x3ce226(0x1e9)]),_0x538525[_0x3ce226(0x1d4)]!==undefined&&(_0x46da92[_0x3ce226(0x1b8)]=_0x538525[_0x3ce226(0x1d4)]),_0x538525[_0x3ce226(0x1e5)]!==undefined&&(_0x46da92[_0x3ce226(0x1f8)]=_0x538525[_0x3ce226(0x1e5)]),_0x538525[_0x3ce226(0x1ed)]!==undefined&&(_0x46da92[_0x3ce226(0x1d2)]=_0x538525['login']),_0x538525['api_error']!==undefined&&(_0x46da92[_0x3ce226(0x1da)]=_0x538525[_0x3ce226(0x1e2)]),await database_1[_0x3ce226(0x1c0)][_0x3ce226(0x1b2)][_0x3ce226(0x1aa)]({'where':{'shopId':_0x9b527c},'data':_0x46da92});}async[a85_0x184e08(0x1c1)](_0x5f42a3,_0x2840a4){const _0x15226c=a85_0x184e08;await this[_0x15226c(0x1ea)](_0x5f42a3);const _0x522044={};_0x2840a4[_0x15226c(0x1ac)]!==undefined&&(_0x522044[_0x15226c(0x1d0)]=_0x2840a4['botApiKey']||null),_0x2840a4[_0x15226c(0x1a5)]!==undefined&&(_0x522044[_0x15226c(0x1fd)]=_0x2840a4[_0x15226c(0x1a5)]||null),await database_1['default'][_0x15226c(0x1b2)]['update']({'where':{'shopId':_0x5f42a3},'data':_0x522044});}async[a85_0x184e08(0x1e1)](_0x507b9d,_0x97db59){const _0xe76699=a85_0x184e08;await this[_0xe76699(0x1ea)](_0x507b9d);const _0x2f198b={};_0x97db59['webhookUrl']!==undefined&&(_0x2f198b[_0xe76699(0x1e8)]=_0x97db59[_0xe76699(0x1e8)]||null),_0x97db59[_0xe76699(0x1b3)]!==undefined&&(_0x2f198b[_0xe76699(0x1b3)]=_0x97db59['webhookEvents']||[]),await database_1[_0xe76699(0x1c0)][_0xe76699(0x1b2)][_0xe76699(0x1aa)]({'where':{'shopId':_0x507b9d},'data':_0x2f198b});}async[a85_0x184e08(0x1f0)](_0xec3728,_0xaa4fa5){const _0x302769=a85_0x184e08,_0x35b42a=await database_1[_0x302769(0x1c0)][_0x302769(0x1c9)][_0x302769(0x1f1)]({'where':{'id':_0xec3728},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x35b42a)throw new Error(_0x302769(0x1d9));if(_0x35b42a[_0x302769(0x1e4)]){if(!_0xaa4fa5)throw new Error(_0x302769(0x1ef));const _0xee879d=speakeasy_1[_0x302769(0x1c0)][_0x302769(0x1c8)]['verify']({'secret':_0x35b42a[_0x302769(0x1c4)],'encoding':_0x302769(0x1cf),'token':_0xaa4fa5,'window':0x2});if(!_0xee879d){let _0x1d129f=![];if(_0x35b42a['backupCodes']){const _0x1bf465=JSON['parse'](_0x35b42a[_0x302769(0x1db)]);for(let _0x59ff97=0x0;_0x59ff97<_0x1bf465[_0x302769(0x1a4)];_0x59ff97++){const _0x291b5c=await bcryptjs_1[_0x302769(0x1c0)]['compare'](_0xaa4fa5,_0x1bf465[_0x59ff97]);if(_0x291b5c){_0x1d129f=!![],_0x1bf465[_0x302769(0x1af)](_0x59ff97,0x1),await database_1[_0x302769(0x1c0)][_0x302769(0x1c9)][_0x302769(0x1aa)]({'where':{'id':_0xec3728},'data':{'backupCodes':JSON[_0x302769(0x1c5)](_0x1bf465)}});break;}}}if(!_0x1d129f)throw new Error(_0x302769(0x1c6));}}const _0x3a965a=_0x302769(0x1d6)+crypto_1['default'][_0x302769(0x1b0)](0x20)['toString'](_0x302769(0x1f3)),_0x75025e='sk_'+crypto_1['default'][_0x302769(0x1b0)](0x20)[_0x302769(0x1b9)](_0x302769(0x1f3));await database_1[_0x302769(0x1c0)][_0x302769(0x1c9)][_0x302769(0x1aa)]({'where':{'id':_0xec3728},'data':{'publicKey':_0x3a965a,'secretKey':_0x75025e}});}async[a85_0x184e08(0x1ee)](_0x5347f5,_0x741db6){const _0x333687=a85_0x184e08,{passwordConfirmation:_0x5df3d5}=_0x741db6,_0x44a358=await database_1[_0x333687(0x1c0)]['shop'][_0x333687(0x1f1)]({'where':{'id':_0x5347f5},'select':{'password':!![]}});if(!_0x44a358)throw new Error('Shop\x20not\x20found');const _0x3c55c1=await bcryptjs_1[_0x333687(0x1c0)]['compare'](_0x5df3d5,_0x44a358[_0x333687(0x1b6)]);if(!_0x3c55c1)throw new Error(_0x333687(0x1b1));await database_1[_0x333687(0x1c0)][_0x333687(0x1c9)]['delete']({'where':{'id':_0x5347f5}});}async['getTelegramSessions'](_0x1f238f){const _0x2a7283=a85_0x184e08,_0x113847=await database_1[_0x2a7283(0x1c0)][_0x2a7283(0x1ae)][_0x2a7283(0x1c7)]({'where':{'shopId':_0x1f238f,'isVerified':!![]},'orderBy':{'createdAt':_0x2a7283(0x1d3)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x113847;}async['disconnectTelegramSession'](_0x415156,_0x29078e){const _0x3fe669=a85_0x184e08,_0x1bb945=await database_1[_0x3fe669(0x1c0)]['telegramUser'][_0x3fe669(0x1f1)]({'where':{'id':_0x29078e},'select':{'shopId':!![]}});if(!_0x1bb945)throw new Error(_0x3fe669(0x1f6));if(_0x1bb945[_0x3fe669(0x1cc)]!==_0x415156)throw new Error(_0x3fe669(0x1cb));await database_1[_0x3fe669(0x1c0)][_0x3fe669(0x1ae)][_0x3fe669(0x1aa)]({'where':{'id':_0x29078e},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x184e08(0x1ea)](_0x5e8cd7){const _0x25eb92=a85_0x184e08,_0x2ddedb=await database_1[_0x25eb92(0x1c0)][_0x25eb92(0x1b2)][_0x25eb92(0x1f1)]({'where':{'shopId':_0x5e8cd7}});!_0x2ddedb&&await database_1['default'][_0x25eb92(0x1b2)][_0x25eb92(0x1ba)]({'data':{'shopId':_0x5e8cd7}});}}exports['SettingsService']=SettingsService;