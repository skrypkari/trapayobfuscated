'use strict';const a47_0x4ce0f1=a47_0x3bbd;function a47_0x2b17(){const _0x4dcc15=['376wGmlLt','string','create','toString','notificationPaymentFailed','deleteAccount','defineProperty','__esModule','notificationPayout','220716vxKCnL','webhookEvents','pk_','updateTelegramSettings','length','update','webhookUrl','hex','updateWebhookSettings','notificationApiError','notificationRefund','9tSOxTb','crypto','bcryptjs','hash','randomBytes','password','findUnique','SettingsService','178263zsjgyr','chatId','1504548stvRcB','shop','api_error','default','Shop\x20not\x20found','221204mHkPnz','parseWebhookEvents','519345sHFvgQ','getShopSettings','changePassword','name','compare','maskApiKey','../config/database','telegramChatId','login','max','19922bLpEWk','ensureSettingsExist','sk_','parse','shopSettings','repeat','notificationLogin','payment_success','botApiKey','payout','isArray','177437HdUiCK','Password\x20confirmation\x20is\x20incorrect','telegramBotApiKey','substring','payment_failed'];a47_0x2b17=function(){return _0x4dcc15;};return a47_0x2b17();}(function(_0x313886,_0x4a71c3){const _0x5418e2=a47_0x3bbd,_0xc821c9=_0x313886();while(!![]){try{const _0x1e0b83=-parseInt(_0x5418e2(0x8c))/0x1+-parseInt(_0x5418e2(0x9a))/0x2+parseInt(_0x5418e2(0x66))/0x3*(parseInt(_0x5418e2(0x75))/0x4)+-parseInt(_0x5418e2(0x77))/0x5+parseInt(_0x5418e2(0x70))/0x6+parseInt(_0x5418e2(0x81))/0x7*(parseInt(_0x5418e2(0x91))/0x8)+-parseInt(_0x5418e2(0x6e))/0x9;if(_0x1e0b83===_0x4a71c3)break;else _0xc821c9['push'](_0xc821c9['shift']());}catch(_0x3ce5ff){_0xc821c9['push'](_0xc821c9['shift']());}}}(a47_0x2b17,0x21ec8));var __importDefault=this&&this['__importDefault']||function(_0x16eb6d){const _0x93fda6=a47_0x3bbd;return _0x16eb6d&&_0x16eb6d[_0x93fda6(0x98)]?_0x16eb6d:{'default':_0x16eb6d};};Object[a47_0x4ce0f1(0x97)](exports,a47_0x4ce0f1(0x98),{'value':!![]}),exports[a47_0x4ce0f1(0x6d)]=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x4ce0f1(0x68))),crypto_1=__importDefault(require(a47_0x4ce0f1(0x67))),database_1=__importDefault(require(a47_0x4ce0f1(0x7d)));function a47_0x3bbd(_0x292a92,_0x402aff){const _0x2b17b1=a47_0x2b17();return a47_0x3bbd=function(_0x3bbdef,_0x5442a4){_0x3bbdef=_0x3bbdef-0x65;let _0x4e9232=_0x2b17b1[_0x3bbdef];return _0x4e9232;},a47_0x3bbd(_0x292a92,_0x402aff);}class SettingsService{[a47_0x4ce0f1(0x7c)](_0x296648){const _0xdc7281=a47_0x4ce0f1;if(!_0x296648)return'';if(_0x296648['length']<=0x8)return _0x296648;const _0x32f9b9=_0x296648[_0xdc7281(0x8f)](0x0,0x8),_0x7c9fc5='*'[_0xdc7281(0x86)](Math[_0xdc7281(0x80)](0x0,_0x296648[_0xdc7281(0x9e)]-0x8));return _0x32f9b9+_0x7c9fc5;}['parseWebhookEvents'](_0x2c4c81){const _0x257364=a47_0x4ce0f1;if(!_0x2c4c81)return[];if(Array[_0x257364(0x8b)](_0x2c4c81))return _0x2c4c81;if(typeof _0x2c4c81===_0x257364(0x92))try{const _0x29a870=JSON[_0x257364(0x84)](_0x2c4c81);return Array[_0x257364(0x8b)](_0x29a870)?_0x29a870:[];}catch{return[];}return[];}async[a47_0x4ce0f1(0x78)](_0x46c59b){const _0x5ae856=a47_0x4ce0f1,_0x10ec3a=await database_1[_0x5ae856(0x73)]['shop'][_0x5ae856(0x6c)]({'where':{'id':_0x46c59b},'include':{'settings':!![]}});if(!_0x10ec3a)throw new Error(_0x5ae856(0x74));let _0x4551f3=_0x10ec3a['settings'];return!_0x4551f3&&(_0x4551f3=await database_1[_0x5ae856(0x73)][_0x5ae856(0x85)][_0x5ae856(0x93)]({'data':{'shopId':_0x10ec3a['id']}})),{'fullName':_0x10ec3a[_0x5ae856(0x7a)],'brand':_0x10ec3a[_0x5ae856(0x7a)],'merchantUrl':_0x10ec3a['shopUrl'],'telegramUsername':_0x10ec3a['telegram'],'telegramBotApiKey':_0x4551f3[_0x5ae856(0x8e)]?this[_0x5ae856(0x7c)](_0x4551f3[_0x5ae856(0x8e)]):null,'telegramChatId':_0x4551f3[_0x5ae856(0x7e)],'webhookUrl':_0x4551f3[_0x5ae856(0xa0)],'webhookEvents':this[_0x5ae856(0x76)](_0x4551f3[_0x5ae856(0x9b)]),'notifications':{'payment_success':_0x4551f3['notificationPaymentSuccess'],'payment_failed':_0x4551f3[_0x5ae856(0x95)],'refund':_0x4551f3[_0x5ae856(0x65)],'payout':_0x4551f3[_0x5ae856(0x99)],'login':_0x4551f3[_0x5ae856(0x87)],'api_error':_0x4551f3[_0x5ae856(0xa3)]}};}async[a47_0x4ce0f1(0x79)](_0x287360,_0x2394c0){const _0x109d02=a47_0x4ce0f1,{currentPassword:_0x4a647e,newPassword:_0x25aa64,confirmNewPassword:_0x5929b3}=_0x2394c0;if(_0x25aa64!==_0x5929b3)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x25aa64[_0x109d02(0x9e)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x1d0250=await database_1['default'][_0x109d02(0x71)][_0x109d02(0x6c)]({'where':{'id':_0x287360},'select':{'password':!![]}});if(!_0x1d0250)throw new Error(_0x109d02(0x74));const _0x519918=await bcryptjs_1[_0x109d02(0x73)][_0x109d02(0x7b)](_0x4a647e,_0x1d0250[_0x109d02(0x6b)]);if(!_0x519918)throw new Error('Current\x20password\x20is\x20incorrect');const _0x29ece9=await bcryptjs_1['default'][_0x109d02(0x69)](_0x25aa64,0xc);await database_1[_0x109d02(0x73)][_0x109d02(0x71)][_0x109d02(0x9f)]({'where':{'id':_0x287360},'data':{'password':_0x29ece9}});}async['updateNotifications'](_0x59b761,_0x13158e){const _0x174fd4=a47_0x4ce0f1;await this['ensureSettingsExist'](_0x59b761);const _0x2c92ce={};_0x13158e[_0x174fd4(0x88)]!==undefined&&(_0x2c92ce['notificationPaymentSuccess']=_0x13158e[_0x174fd4(0x88)]),_0x13158e[_0x174fd4(0x90)]!==undefined&&(_0x2c92ce[_0x174fd4(0x95)]=_0x13158e[_0x174fd4(0x90)]),_0x13158e['refund']!==undefined&&(_0x2c92ce['notificationRefund']=_0x13158e['refund']),_0x13158e[_0x174fd4(0x8a)]!==undefined&&(_0x2c92ce[_0x174fd4(0x99)]=_0x13158e[_0x174fd4(0x8a)]),_0x13158e[_0x174fd4(0x7f)]!==undefined&&(_0x2c92ce[_0x174fd4(0x87)]=_0x13158e['login']),_0x13158e['api_error']!==undefined&&(_0x2c92ce['notificationApiError']=_0x13158e[_0x174fd4(0x72)]),await database_1[_0x174fd4(0x73)]['shopSettings']['update']({'where':{'shopId':_0x59b761},'data':_0x2c92ce});}async[a47_0x4ce0f1(0x9d)](_0xe7e0e6,_0x19cad6){const _0x3a0810=a47_0x4ce0f1;await this[_0x3a0810(0x82)](_0xe7e0e6);const _0x3274f4={};_0x19cad6[_0x3a0810(0x89)]!==undefined&&(_0x3274f4['telegramBotApiKey']=_0x19cad6[_0x3a0810(0x89)]||null),_0x19cad6[_0x3a0810(0x6f)]!==undefined&&(_0x3274f4['telegramChatId']=_0x19cad6[_0x3a0810(0x6f)]||null),await database_1[_0x3a0810(0x73)][_0x3a0810(0x85)][_0x3a0810(0x9f)]({'where':{'shopId':_0xe7e0e6},'data':_0x3274f4});}async[a47_0x4ce0f1(0xa2)](_0x53df1c,_0x678e10){const _0x4c2d81=a47_0x4ce0f1;await this[_0x4c2d81(0x82)](_0x53df1c);const _0x3c93be={};_0x678e10[_0x4c2d81(0xa0)]!==undefined&&(_0x3c93be[_0x4c2d81(0xa0)]=_0x678e10[_0x4c2d81(0xa0)]||null),_0x678e10[_0x4c2d81(0x9b)]!==undefined&&(_0x3c93be['webhookEvents']=_0x678e10[_0x4c2d81(0x9b)]||[]),await database_1['default'][_0x4c2d81(0x85)]['update']({'where':{'shopId':_0x53df1c},'data':_0x3c93be});}async['revokeAllApiKeys'](_0x26b717){const _0x5b8958=a47_0x4ce0f1,_0x31cb9f=_0x5b8958(0x9c)+crypto_1[_0x5b8958(0x73)][_0x5b8958(0x6a)](0x20)[_0x5b8958(0x94)](_0x5b8958(0xa1)),_0x3ab9ea=_0x5b8958(0x83)+crypto_1[_0x5b8958(0x73)][_0x5b8958(0x6a)](0x20)[_0x5b8958(0x94)](_0x5b8958(0xa1));await database_1[_0x5b8958(0x73)][_0x5b8958(0x71)][_0x5b8958(0x9f)]({'where':{'id':_0x26b717},'data':{'publicKey':_0x31cb9f,'secretKey':_0x3ab9ea}});}async[a47_0x4ce0f1(0x96)](_0x12cae2,_0x89ad6a){const _0x1c6695=a47_0x4ce0f1,{passwordConfirmation:_0x1d4537}=_0x89ad6a,_0x543ed7=await database_1[_0x1c6695(0x73)][_0x1c6695(0x71)][_0x1c6695(0x6c)]({'where':{'id':_0x12cae2},'select':{'password':!![]}});if(!_0x543ed7)throw new Error('Shop\x20not\x20found');const _0x22aefe=await bcryptjs_1['default'][_0x1c6695(0x7b)](_0x1d4537,_0x543ed7['password']);if(!_0x22aefe)throw new Error(_0x1c6695(0x8d));await database_1[_0x1c6695(0x73)][_0x1c6695(0x71)]['delete']({'where':{'id':_0x12cae2}});}async[a47_0x4ce0f1(0x82)](_0xfa3cc3){const _0xe62727=a47_0x4ce0f1,_0x495eef=await database_1[_0xe62727(0x73)]['shopSettings'][_0xe62727(0x6c)]({'where':{'shopId':_0xfa3cc3}});!_0x495eef&&await database_1[_0xe62727(0x73)]['shopSettings']['create']({'data':{'shopId':_0xfa3cc3}});}}exports[a47_0x4ce0f1(0x6d)]=SettingsService;