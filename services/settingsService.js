'use strict';const a47_0x10a072=a47_0x2f3f;function a47_0x1846(){const _0x18e3fc=['sk_','notificationPaymentSuccess','notificationLogin','Shop\x20not\x20found','406992wpwakS','changePassword','payout','1393324kcLHAl','update','api_error','toString','319011RcKDtJ','parse','deleteAccount','telegramChatId','notificationPaymentFailed','136184iWCCmz','6915352NghhxO','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','getShopSettings','delete','crypto','shop','notificationPayout','default','updateNotifications','12tPzaCQ','create','pk_','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','../config/database','repeat','notificationApiError','password','chatId','2219125iIgdhw','maskApiKey','bcryptjs','SettingsService','findUnique','randomBytes','length','webhookUrl','parseWebhookEvents','payment_failed','__importDefault','name','payment_success','updateTelegramSettings','ensureSettingsExist','shopSettings','webhookEvents','telegramBotApiKey','telegram','refund','revokeAllApiKeys','isArray','botApiKey','login','__esModule','notificationRefund','string','244701jNRlhq'];a47_0x1846=function(){return _0x18e3fc;};return a47_0x1846();}(function(_0x15d6d3,_0x186dcc){const _0x36052d=a47_0x2f3f,_0x4cbb71=_0x15d6d3();while(!![]){try{const _0xfdfddc=-parseInt(_0x36052d(0x212))/0x1+-parseInt(_0x36052d(0x209))/0x2+-parseInt(_0x36052d(0x201))/0x3+-parseInt(_0x36052d(0x206))/0x4+parseInt(_0x36052d(0x1e6))/0x5+-parseInt(_0x36052d(0x21c))/0x6*(-parseInt(_0x36052d(0x20d))/0x7)+parseInt(_0x36052d(0x213))/0x8;if(_0xfdfddc===_0x186dcc)break;else _0x4cbb71['push'](_0x4cbb71['shift']());}catch(_0x5b8a18){_0x4cbb71['push'](_0x4cbb71['shift']());}}}(a47_0x1846,0x5d8fd));var __importDefault=this&&this[a47_0x10a072(0x1f0)]||function(_0xb6e72c){const _0x31f514=a47_0x10a072;return _0xb6e72c&&_0xb6e72c[_0x31f514(0x1fe)]?_0xb6e72c:{'default':_0xb6e72c};};Object['defineProperty'](exports,a47_0x10a072(0x1fe),{'value':!![]}),exports['SettingsService']=void 0x0;function a47_0x2f3f(_0x3c8e55,_0x39ae93){const _0x1846b9=a47_0x1846();return a47_0x2f3f=function(_0x2f3fdc,_0x334361){_0x2f3fdc=_0x2f3fdc-0x1e2;let _0xadb397=_0x1846b9[_0x2f3fdc];return _0xadb397;},a47_0x2f3f(_0x3c8e55,_0x39ae93);}const bcryptjs_1=__importDefault(require(a47_0x10a072(0x1e8))),crypto_1=__importDefault(require(a47_0x10a072(0x217))),database_1=__importDefault(require(a47_0x10a072(0x220)));class SettingsService{['maskApiKey'](_0x2acbfd){const _0x1248b0=a47_0x10a072;if(!_0x2acbfd)return'';if(_0x2acbfd['length']<=0x8)return _0x2acbfd;const _0xd7187a=_0x2acbfd['substring'](0x0,0x8),_0x127ca3='*'[_0x1248b0(0x1e2)](Math['max'](0x0,_0x2acbfd[_0x1248b0(0x1ec)]-0x8));return _0xd7187a+_0x127ca3;}[a47_0x10a072(0x1ee)](_0x1d23f0){const _0x40d04c=a47_0x10a072;if(!_0x1d23f0)return[];if(Array[_0x40d04c(0x1fb)](_0x1d23f0))return _0x1d23f0;if(typeof _0x1d23f0===_0x40d04c(0x200))try{const _0x2336c8=JSON[_0x40d04c(0x20e)](_0x1d23f0);return Array[_0x40d04c(0x1fb)](_0x2336c8)?_0x2336c8:[];}catch{return[];}return[];}async[a47_0x10a072(0x215)](_0x2d9c37){const _0x7141=a47_0x10a072,_0x2463d9=await database_1[_0x7141(0x21a)]['shop']['findUnique']({'where':{'id':_0x2d9c37},'include':{'settings':!![]}});if(!_0x2463d9)throw new Error('Shop\x20not\x20found');let _0x3aedc1=_0x2463d9['settings'];return!_0x3aedc1&&(_0x3aedc1=await database_1[_0x7141(0x21a)]['shopSettings'][_0x7141(0x21d)]({'data':{'shopId':_0x2463d9['id']}})),{'fullName':_0x2463d9[_0x7141(0x1f1)],'brand':_0x2463d9[_0x7141(0x1f1)],'merchantUrl':_0x2463d9['shopUrl'],'telegramUsername':_0x2463d9[_0x7141(0x1f8)],'telegramBotApiKey':_0x3aedc1[_0x7141(0x1f7)]?this[_0x7141(0x1e7)](_0x3aedc1[_0x7141(0x1f7)]):null,'telegramChatId':_0x3aedc1['telegramChatId'],'webhookUrl':_0x3aedc1[_0x7141(0x1ed)],'webhookEvents':this[_0x7141(0x1ee)](_0x3aedc1[_0x7141(0x1f6)]),'notifications':{'payment_success':_0x3aedc1[_0x7141(0x203)],'payment_failed':_0x3aedc1[_0x7141(0x211)],'refund':_0x3aedc1[_0x7141(0x1ff)],'payout':_0x3aedc1[_0x7141(0x219)],'login':_0x3aedc1[_0x7141(0x204)],'api_error':_0x3aedc1[_0x7141(0x1e3)]}};}async[a47_0x10a072(0x207)](_0x40ff58,_0x26a7af){const _0x492301=a47_0x10a072,{currentPassword:_0x14c51f,newPassword:_0x14041c,confirmNewPassword:_0x4e2199}=_0x26a7af;if(_0x14041c!==_0x4e2199)throw new Error(_0x492301(0x214));if(_0x14041c[_0x492301(0x1ec)]<0x6)throw new Error(_0x492301(0x21f));const _0x50e363=await database_1[_0x492301(0x21a)][_0x492301(0x218)][_0x492301(0x1ea)]({'where':{'id':_0x40ff58},'select':{'password':!![]}});if(!_0x50e363)throw new Error(_0x492301(0x205));const _0x28fd2e=await bcryptjs_1['default']['compare'](_0x14c51f,_0x50e363[_0x492301(0x1e4)]);if(!_0x28fd2e)throw new Error('Current\x20password\x20is\x20incorrect');const _0x2d0990=await bcryptjs_1[_0x492301(0x21a)]['hash'](_0x14041c,0xc);await database_1[_0x492301(0x21a)][_0x492301(0x218)]['update']({'where':{'id':_0x40ff58},'data':{'password':_0x2d0990}});}async[a47_0x10a072(0x21b)](_0x4ce721,_0x492bc3){const _0x8f6b95=a47_0x10a072;await this['ensureSettingsExist'](_0x4ce721);const _0x5011dd={};_0x492bc3[_0x8f6b95(0x1f2)]!==undefined&&(_0x5011dd[_0x8f6b95(0x203)]=_0x492bc3['payment_success']),_0x492bc3[_0x8f6b95(0x1ef)]!==undefined&&(_0x5011dd[_0x8f6b95(0x211)]=_0x492bc3[_0x8f6b95(0x1ef)]),_0x492bc3[_0x8f6b95(0x1f9)]!==undefined&&(_0x5011dd['notificationRefund']=_0x492bc3[_0x8f6b95(0x1f9)]),_0x492bc3['payout']!==undefined&&(_0x5011dd[_0x8f6b95(0x219)]=_0x492bc3[_0x8f6b95(0x208)]),_0x492bc3[_0x8f6b95(0x1fd)]!==undefined&&(_0x5011dd[_0x8f6b95(0x204)]=_0x492bc3[_0x8f6b95(0x1fd)]),_0x492bc3[_0x8f6b95(0x20b)]!==undefined&&(_0x5011dd[_0x8f6b95(0x1e3)]=_0x492bc3[_0x8f6b95(0x20b)]),await database_1[_0x8f6b95(0x21a)][_0x8f6b95(0x1f5)]['update']({'where':{'shopId':_0x4ce721},'data':_0x5011dd});}async[a47_0x10a072(0x1f3)](_0x38af5b,_0x435f20){const _0x384cf=a47_0x10a072;await this[_0x384cf(0x1f4)](_0x38af5b);const _0x17a404={};_0x435f20[_0x384cf(0x1fc)]!==undefined&&(_0x17a404[_0x384cf(0x1f7)]=_0x435f20['botApiKey']||null),_0x435f20[_0x384cf(0x1e5)]!==undefined&&(_0x17a404[_0x384cf(0x210)]=_0x435f20[_0x384cf(0x1e5)]||null),await database_1[_0x384cf(0x21a)][_0x384cf(0x1f5)][_0x384cf(0x20a)]({'where':{'shopId':_0x38af5b},'data':_0x17a404});}async['updateWebhookSettings'](_0x5d7da5,_0xf36460){const _0x5ac5da=a47_0x10a072;await this[_0x5ac5da(0x1f4)](_0x5d7da5);const _0x25c32a={};_0xf36460[_0x5ac5da(0x1ed)]!==undefined&&(_0x25c32a[_0x5ac5da(0x1ed)]=_0xf36460['webhookUrl']||null),_0xf36460[_0x5ac5da(0x1f6)]!==undefined&&(_0x25c32a[_0x5ac5da(0x1f6)]=_0xf36460[_0x5ac5da(0x1f6)]||[]),await database_1[_0x5ac5da(0x21a)][_0x5ac5da(0x1f5)]['update']({'where':{'shopId':_0x5d7da5},'data':_0x25c32a});}async[a47_0x10a072(0x1fa)](_0x5ce64e){const _0x3bc73d=a47_0x10a072,_0xb8fa8f=_0x3bc73d(0x21e)+crypto_1['default'][_0x3bc73d(0x1eb)](0x20)[_0x3bc73d(0x20c)]('hex'),_0x53fe84=_0x3bc73d(0x202)+crypto_1[_0x3bc73d(0x21a)][_0x3bc73d(0x1eb)](0x20)[_0x3bc73d(0x20c)]('hex');await database_1['default'][_0x3bc73d(0x218)][_0x3bc73d(0x20a)]({'where':{'id':_0x5ce64e},'data':{'publicKey':_0xb8fa8f,'secretKey':_0x53fe84}});}async[a47_0x10a072(0x20f)](_0x27015f,_0xe3b127){const _0x2dfeb3=a47_0x10a072,{passwordConfirmation:_0x47ce86}=_0xe3b127,_0x33449d=await database_1[_0x2dfeb3(0x21a)]['shop']['findUnique']({'where':{'id':_0x27015f},'select':{'password':!![]}});if(!_0x33449d)throw new Error(_0x2dfeb3(0x205));const _0x5b1c0c=await bcryptjs_1[_0x2dfeb3(0x21a)]['compare'](_0x47ce86,_0x33449d[_0x2dfeb3(0x1e4)]);if(!_0x5b1c0c)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1['default'][_0x2dfeb3(0x218)][_0x2dfeb3(0x216)]({'where':{'id':_0x27015f}});}async[a47_0x10a072(0x1f4)](_0x2a0914){const _0x1ce1e1=a47_0x10a072,_0x17dbba=await database_1[_0x1ce1e1(0x21a)]['shopSettings'][_0x1ce1e1(0x1ea)]({'where':{'shopId':_0x2a0914}});!_0x17dbba&&await database_1[_0x1ce1e1(0x21a)][_0x1ce1e1(0x1f5)][_0x1ce1e1(0x21d)]({'data':{'shopId':_0x2a0914}});}}exports[a47_0x10a072(0x1e9)]=SettingsService;