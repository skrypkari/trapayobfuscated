'use strict';const a76_0x21e804=a76_0x117d;(function(_0x4ea18a,_0x46b4ae){const _0x1e4422=a76_0x117d,_0x91aa9c=_0x4ea18a();while(!![]){try{const _0x34028d=-parseInt(_0x1e4422(0x13f))/0x1*(parseInt(_0x1e4422(0x139))/0x2)+parseInt(_0x1e4422(0x128))/0x3+-parseInt(_0x1e4422(0x11f))/0x4*(-parseInt(_0x1e4422(0x14d))/0x5)+-parseInt(_0x1e4422(0x147))/0x6+-parseInt(_0x1e4422(0x12a))/0x7*(parseInt(_0x1e4422(0x13b))/0x8)+parseInt(_0x1e4422(0x125))/0x9*(-parseInt(_0x1e4422(0x14e))/0xa)+parseInt(_0x1e4422(0x130))/0xb;if(_0x34028d===_0x46b4ae)break;else _0x91aa9c['push'](_0x91aa9c['shift']());}catch(_0x45075d){_0x91aa9c['push'](_0x91aa9c['shift']());}}}(a76_0x264a,0x23ee3));var __importDefault=this&&this[a76_0x21e804(0x12f)]||function(_0x4f4f70){const _0x37aa9d=a76_0x21e804;return _0x4f4f70&&_0x4f4f70[_0x37aa9d(0x109)]?_0x4f4f70:{'default':_0x4f4f70};};Object[a76_0x21e804(0x11b)](exports,'__esModule',{'value':!![]}),exports[a76_0x21e804(0x149)]=void 0x0;const bcryptjs_1=__importDefault(require(a76_0x21e804(0x136))),crypto_1=__importDefault(require(a76_0x21e804(0x12c))),speakeasy_1=__importDefault(require(a76_0x21e804(0x151))),database_1=__importDefault(require('../config/database'));function a76_0x117d(_0x8bb8ff,_0x25eac5){_0x8bb8ff=_0x8bb8ff-0x105;const _0x264ae3=a76_0x264a();let _0x117d4c=_0x264ae3[_0x8bb8ff];return _0x117d4c;}class SettingsService{[a76_0x21e804(0x134)](_0x29fa1c){const _0x27752a=a76_0x21e804;if(!_0x29fa1c)return'';if(_0x29fa1c[_0x27752a(0x116)]<=0x8)return _0x29fa1c;const _0x197cc0=_0x29fa1c[_0x27752a(0x127)](0x0,0x8),_0xaa825c='*'['repeat'](Math['max'](0x0,_0x29fa1c[_0x27752a(0x116)]-0x8));return _0x197cc0+_0xaa825c;}[a76_0x21e804(0x106)](_0x136405){const _0x477f6c=a76_0x21e804;if(!_0x136405)return[];if(Array['isArray'](_0x136405))return _0x136405;if(typeof _0x136405==='string')try{const _0x3bd381=JSON[_0x477f6c(0x142)](_0x136405);return Array[_0x477f6c(0x117)](_0x3bd381)?_0x3bd381:[];}catch{return[];}return[];}async[a76_0x21e804(0x14a)](_0x5f5fca){const _0x5f48bf=a76_0x21e804,_0x591d0c=await database_1['default'][_0x5f48bf(0x123)][_0x5f48bf(0x138)]({'where':{'id':_0x5f5fca},'include':{'settings':!![]}});if(!_0x591d0c)throw new Error(_0x5f48bf(0x118));let _0x2ff21f=_0x591d0c[_0x5f48bf(0x112)];return!_0x2ff21f&&(_0x2ff21f=await database_1[_0x5f48bf(0x140)]['shopSettings'][_0x5f48bf(0x141)]({'data':{'shopId':_0x591d0c['id']}})),{'fullName':_0x591d0c['name'],'brand':_0x591d0c[_0x5f48bf(0x14f)],'merchantUrl':_0x591d0c['shopUrl'],'telegramUsername':_0x591d0c['telegram'],'telegramBotApiKey':_0x2ff21f[_0x5f48bf(0x145)]?this['maskApiKey'](_0x2ff21f[_0x5f48bf(0x145)]):null,'telegramChatId':_0x2ff21f[_0x5f48bf(0x11d)],'webhookUrl':_0x2ff21f[_0x5f48bf(0x152)],'webhookEvents':this[_0x5f48bf(0x106)](_0x2ff21f['webhookEvents']),'twoFactorEnabled':_0x591d0c[_0x5f48bf(0x132)]||![],'notifications':{'payment_success':_0x2ff21f[_0x5f48bf(0x10f)],'payment_failed':_0x2ff21f[_0x5f48bf(0x143)],'refund':_0x2ff21f[_0x5f48bf(0x11e)],'payout':_0x2ff21f['notificationPayout'],'login':_0x2ff21f['notificationLogin'],'api_error':_0x2ff21f['notificationApiError']}};}async[a76_0x21e804(0x10a)](_0xf17d2c,_0x1f331c){const _0x2583d5=a76_0x21e804,{currentPassword:_0xa8af74,newPassword:_0x2eebe4,confirmNewPassword:_0x1a7b91,twoFactorToken:_0x48a567}=_0x1f331c;if(_0x2eebe4!==_0x1a7b91)throw new Error(_0x2583d5(0x121));if(_0x2eebe4[_0x2583d5(0x116)]<0x6)throw new Error(_0x2583d5(0x150));const _0x221c2f=await database_1['default'][_0x2583d5(0x123)][_0x2583d5(0x138)]({'where':{'id':_0xf17d2c},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x221c2f)throw new Error(_0x2583d5(0x118));if(_0x221c2f[_0x2583d5(0x132)]){if(!_0x48a567)throw new Error(_0x2583d5(0x120));const _0x339a88=speakeasy_1[_0x2583d5(0x140)][_0x2583d5(0x11a)]['verify']({'secret':_0x221c2f[_0x2583d5(0x107)],'encoding':_0x2583d5(0x12b),'token':_0x48a567,'window':0x2});if(!_0x339a88){let _0x44ea3a=![];if(_0x221c2f['backupCodes']){const _0x561bf5=JSON[_0x2583d5(0x142)](_0x221c2f['backupCodes']);for(let _0x50d76a=0x0;_0x50d76a<_0x561bf5[_0x2583d5(0x116)];_0x50d76a++){const _0x306b77=await bcryptjs_1[_0x2583d5(0x140)]['compare'](_0x48a567,_0x561bf5[_0x50d76a]);if(_0x306b77){_0x44ea3a=!![],_0x561bf5[_0x2583d5(0x129)](_0x50d76a,0x1),await database_1[_0x2583d5(0x140)][_0x2583d5(0x123)][_0x2583d5(0x124)]({'where':{'id':_0xf17d2c},'data':{'backupCodes':JSON[_0x2583d5(0x110)](_0x561bf5)}});break;}}}if(!_0x44ea3a)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x239263=await bcryptjs_1[_0x2583d5(0x140)]['compare'](_0xa8af74,_0x221c2f[_0x2583d5(0x111)]);if(!_0x239263)throw new Error(_0x2583d5(0x13d));const _0x25efdc=await bcryptjs_1[_0x2583d5(0x140)][_0x2583d5(0x13c)](_0x2eebe4,0xc);await database_1['default'][_0x2583d5(0x123)][_0x2583d5(0x124)]({'where':{'id':_0xf17d2c},'data':{'password':_0x25efdc}});}async['updateNotifications'](_0x23347e,_0x4225c7){const _0xe3f32a=a76_0x21e804;await this[_0xe3f32a(0x12e)](_0x23347e);const _0xc92797={};_0x4225c7[_0xe3f32a(0x108)]!==undefined&&(_0xc92797[_0xe3f32a(0x10f)]=_0x4225c7['payment_success']),_0x4225c7[_0xe3f32a(0x133)]!==undefined&&(_0xc92797[_0xe3f32a(0x143)]=_0x4225c7[_0xe3f32a(0x133)]),_0x4225c7[_0xe3f32a(0x126)]!==undefined&&(_0xc92797[_0xe3f32a(0x11e)]=_0x4225c7['refund']),_0x4225c7['payout']!==undefined&&(_0xc92797[_0xe3f32a(0x14b)]=_0x4225c7[_0xe3f32a(0x13a)]),_0x4225c7[_0xe3f32a(0x144)]!==undefined&&(_0xc92797['notificationLogin']=_0x4225c7[_0xe3f32a(0x144)]),_0x4225c7[_0xe3f32a(0x105)]!==undefined&&(_0xc92797[_0xe3f32a(0x14c)]=_0x4225c7[_0xe3f32a(0x105)]),await database_1[_0xe3f32a(0x140)][_0xe3f32a(0x10e)]['update']({'where':{'shopId':_0x23347e},'data':_0xc92797});}async[a76_0x21e804(0x114)](_0x5638b7,_0x384e41){const _0xefc8c6=a76_0x21e804;await this[_0xefc8c6(0x12e)](_0x5638b7);const _0x428f8b={};_0x384e41[_0xefc8c6(0x113)]!==undefined&&(_0x428f8b[_0xefc8c6(0x145)]=_0x384e41['botApiKey']||null),_0x384e41[_0xefc8c6(0x148)]!==undefined&&(_0x428f8b[_0xefc8c6(0x11d)]=_0x384e41['chatId']||null),await database_1['default'][_0xefc8c6(0x10e)]['update']({'where':{'shopId':_0x5638b7},'data':_0x428f8b});}async[a76_0x21e804(0x122)](_0x48200f,_0x11b477){const _0x41de09=a76_0x21e804;await this[_0x41de09(0x12e)](_0x48200f);const _0x1efca7={};_0x11b477[_0x41de09(0x152)]!==undefined&&(_0x1efca7[_0x41de09(0x152)]=_0x11b477[_0x41de09(0x152)]||null),_0x11b477[_0x41de09(0x135)]!==undefined&&(_0x1efca7['webhookEvents']=_0x11b477[_0x41de09(0x135)]||[]),await database_1['default']['shopSettings'][_0x41de09(0x124)]({'where':{'shopId':_0x48200f},'data':_0x1efca7});}async[a76_0x21e804(0x137)](_0x11dea9,_0x223015){const _0x2833d2=a76_0x21e804,_0x5cdfe6=await database_1[_0x2833d2(0x140)][_0x2833d2(0x123)][_0x2833d2(0x138)]({'where':{'id':_0x11dea9},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x5cdfe6)throw new Error(_0x2833d2(0x118));if(_0x5cdfe6[_0x2833d2(0x132)]){if(!_0x223015)throw new Error(_0x2833d2(0x120));const _0x45ba82=speakeasy_1['default'][_0x2833d2(0x11a)][_0x2833d2(0x10c)]({'secret':_0x5cdfe6[_0x2833d2(0x107)],'encoding':'base32','token':_0x223015,'window':0x2});if(!_0x45ba82){let _0x5a9de8=![];if(_0x5cdfe6[_0x2833d2(0x131)]){const _0xe7687d=JSON[_0x2833d2(0x142)](_0x5cdfe6['backupCodes']);for(let _0x5df3d8=0x0;_0x5df3d8<_0xe7687d[_0x2833d2(0x116)];_0x5df3d8++){const _0x5a4322=await bcryptjs_1[_0x2833d2(0x140)][_0x2833d2(0x13e)](_0x223015,_0xe7687d[_0x5df3d8]);if(_0x5a4322){_0x5a9de8=!![],_0xe7687d[_0x2833d2(0x129)](_0x5df3d8,0x1),await database_1[_0x2833d2(0x140)][_0x2833d2(0x123)][_0x2833d2(0x124)]({'where':{'id':_0x11dea9},'data':{'backupCodes':JSON['stringify'](_0xe7687d)}});break;}}}if(!_0x5a9de8)throw new Error(_0x2833d2(0x146));}}const _0x3d5541=_0x2833d2(0x10d)+crypto_1['default'][_0x2833d2(0x12d)](0x20)[_0x2833d2(0x119)](_0x2833d2(0x10b)),_0x124674='sk_'+crypto_1[_0x2833d2(0x140)][_0x2833d2(0x12d)](0x20)['toString'](_0x2833d2(0x10b));await database_1['default']['shop'][_0x2833d2(0x124)]({'where':{'id':_0x11dea9},'data':{'publicKey':_0x3d5541,'secretKey':_0x124674}});}async['deleteAccount'](_0x323926,_0x134cc1){const _0x16c0c6=a76_0x21e804,{passwordConfirmation:_0x34a5a0}=_0x134cc1,_0x4c45aa=await database_1[_0x16c0c6(0x140)][_0x16c0c6(0x123)]['findUnique']({'where':{'id':_0x323926},'select':{'password':!![]}});if(!_0x4c45aa)throw new Error(_0x16c0c6(0x118));const _0x4c21cb=await bcryptjs_1[_0x16c0c6(0x140)]['compare'](_0x34a5a0,_0x4c45aa['password']);if(!_0x4c21cb)throw new Error(_0x16c0c6(0x11c));await database_1[_0x16c0c6(0x140)][_0x16c0c6(0x123)][_0x16c0c6(0x115)]({'where':{'id':_0x323926}});}async[a76_0x21e804(0x12e)](_0xe5cb97){const _0x2163dc=a76_0x21e804,_0x44af54=await database_1['default']['shopSettings']['findUnique']({'where':{'shopId':_0xe5cb97}});!_0x44af54&&await database_1['default'][_0x2163dc(0x10e)][_0x2163dc(0x141)]({'data':{'shopId':_0xe5cb97}});}}exports[a76_0x21e804(0x149)]=SettingsService;function a76_0x264a(){const _0x4695aa=['pk_','shopSettings','notificationPaymentSuccess','stringify','password','settings','botApiKey','updateTelegramSettings','delete','length','isArray','Shop\x20not\x20found','toString','totp','defineProperty','Password\x20confirmation\x20is\x20incorrect','telegramChatId','notificationRefund','900244QGjLpG','2FA\x20token\x20is\x20required','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','updateWebhookSettings','shop','update','124263lphctc','refund','substring','244614HKGGMW','splice','2604LJgpWT','base32','crypto','randomBytes','ensureSettingsExist','__importDefault','2588520iyzBVJ','backupCodes','twoFactorEnabled','payment_failed','maskApiKey','webhookEvents','bcryptjs','revokeAllApiKeys','findUnique','126826odpxyG','payout','5608ItElqt','hash','Current\x20password\x20is\x20incorrect','compare','1CYsKhL','default','create','parse','notificationPaymentFailed','login','telegramBotApiKey','Invalid\x202FA\x20token\x20or\x20backup\x20code','92010XsNeDP','chatId','SettingsService','getShopSettings','notificationPayout','notificationApiError','5YHFJBY','40eCrXcf','name','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','speakeasy','webhookUrl','api_error','parseWebhookEvents','twoFactorSecret','payment_success','__esModule','changePassword','hex','verify'];a76_0x264a=function(){return _0x4695aa;};return a76_0x264a();}