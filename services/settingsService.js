'use strict';const a85_0x37ad3f=a85_0x3238;(function(_0x173495,_0x194ffc){const _0x2d5db0=a85_0x3238,_0x12f66a=_0x173495();while(!![]){try{const _0x1bd7de=parseInt(_0x2d5db0(0xaa))/0x1*(-parseInt(_0x2d5db0(0xb4))/0x2)+parseInt(_0x2d5db0(0xdd))/0x3*(parseInt(_0x2d5db0(0xc3))/0x4)+parseInt(_0x2d5db0(0xc6))/0x5+parseInt(_0x2d5db0(0xdb))/0x6+parseInt(_0x2d5db0(0xcc))/0x7+parseInt(_0x2d5db0(0xb3))/0x8+-parseInt(_0x2d5db0(0xe4))/0x9;if(_0x1bd7de===_0x194ffc)break;else _0x12f66a['push'](_0x12f66a['shift']());}catch(_0x42a2cb){_0x12f66a['push'](_0x12f66a['shift']());}}}(a85_0x1636,0xd75ee));var __importDefault=this&&this['__importDefault']||function(_0x1c7436){const _0x55cbde=a85_0x3238;return _0x1c7436&&_0x1c7436[_0x55cbde(0xbf)]?_0x1c7436:{'default':_0x1c7436};};Object['defineProperty'](exports,a85_0x37ad3f(0xbf),{'value':!![]}),exports[a85_0x37ad3f(0xe6)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x37ad3f(0xd4))),crypto_1=__importDefault(require(a85_0x37ad3f(0xd7))),speakeasy_1=__importDefault(require(a85_0x37ad3f(0xa8))),database_1=__importDefault(require(a85_0x37ad3f(0xbd)));function a85_0x1636(){const _0x10161a=['maskApiKey','1728462RZNvzP','isArray','51ioUolj','repeat','refund','2FA\x20token\x20is\x20required','findMany','findUnique','base32','23843691tdCODD','Current\x20password\x20is\x20incorrect','SettingsService','Telegram\x20session\x20not\x20found','twoFactorEnabled','telegramUsers','Invalid\x202FA\x20token\x20or\x20backup\x20code','Shop\x20not\x20found','webhookEvents','compare','backupCodes','payment_failed','chatId','Unauthorized\x20to\x20disconnect\x20this\x20session','api_error','update','disconnectTelegramSession','deleteAccount','randomBytes','payout','updateWebhookSettings','speakeasy','delete','1lPfKKY','Password\x20confirmation\x20is\x20incorrect','splice','webhookUrl','login','verify','password','sk_','getShopSettings','13494888dBMZvt','859498vNWDoJ','updateNotifications','hex','pk_','name','parse','shop','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','shopUrl4','../config/database','shopUrl3','__esModule','notificationRefund','updateTelegramSettings','substring','362660bNhYdI','notificationPaymentSuccess','length','1578770EtWFPP','totp','notificationPaymentFailed','create','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','string','904463QVVNok','notificationLogin','ensureSettingsExist','botApiKey','stringify','shopSettings','default','notificationPayout','bcryptjs','telegramChatId','toString','crypto','telegramUser','notificationApiError'];a85_0x1636=function(){return _0x10161a;};return a85_0x1636();}class SettingsService{[a85_0x37ad3f(0xda)](_0x2bace3){const _0x6e5c8=a85_0x37ad3f;if(!_0x2bace3)return'';if(_0x2bace3[_0x6e5c8(0xc5)]<=0x8)return _0x2bace3;const _0x87756e=_0x2bace3[_0x6e5c8(0xc2)](0x0,0x8),_0x381048='*'[_0x6e5c8(0xde)](Math['max'](0x0,_0x2bace3[_0x6e5c8(0xc5)]-0x8));return _0x87756e+_0x381048;}['parseWebhookEvents'](_0x22d497){const _0x312999=a85_0x37ad3f;if(!_0x22d497)return[];if(Array[_0x312999(0xdc)](_0x22d497))return _0x22d497;if(typeof _0x22d497===_0x312999(0xcb))try{const _0x5bcec6=JSON['parse'](_0x22d497);return Array[_0x312999(0xdc)](_0x5bcec6)?_0x5bcec6:[];}catch{return[];}return[];}async[a85_0x37ad3f(0xb2)](_0x3bd8f6){const _0x1ac908=a85_0x37ad3f,_0x2a9ff2=await database_1[_0x1ac908(0xd2)][_0x1ac908(0xba)]['findUnique']({'where':{'id':_0x3bd8f6},'select':{'id':!![],'name':!![],'shopUrl':!![],'shopUrl2':!![],'shopUrl3':!![],'shopUrl4':!![],'telegram':!![],'twoFactorEnabled':!![],'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2a9ff2)throw new Error(_0x1ac908(0xeb));let _0x64a0a7=_0x2a9ff2['settings'];return!_0x64a0a7&&(_0x64a0a7=await database_1['default']['shopSettings'][_0x1ac908(0xc9)]({'data':{'shopId':_0x2a9ff2['id']}})),{'fullName':_0x2a9ff2[_0x1ac908(0xb8)],'brand':_0x2a9ff2[_0x1ac908(0xb8)],'merchantUrl':_0x2a9ff2['shopUrl'],'merchantUrl2':_0x2a9ff2['shopUrl2'],'merchantUrl3':_0x2a9ff2[_0x1ac908(0xbe)],'merchantUrl4':_0x2a9ff2[_0x1ac908(0xbc)],'telegramUsername':_0x2a9ff2['telegram'],'telegramBotApiKey':_0x64a0a7['telegramBotApiKey']?this[_0x1ac908(0xda)](_0x64a0a7['telegramBotApiKey']):null,'telegramChatId':_0x64a0a7[_0x1ac908(0xd5)],'telegramUsersCount':_0x2a9ff2['_count'][_0x1ac908(0xe9)],'webhookUrl':_0x64a0a7[_0x1ac908(0xad)],'webhookEvents':this['parseWebhookEvents'](_0x64a0a7[_0x1ac908(0xec)]),'twoFactorEnabled':_0x2a9ff2['twoFactorEnabled']||![],'notifications':{'payment_success':_0x64a0a7['notificationPaymentSuccess'],'payment_failed':_0x64a0a7[_0x1ac908(0xc8)],'refund':_0x64a0a7[_0x1ac908(0xc0)],'payout':_0x64a0a7['notificationPayout'],'login':_0x64a0a7['notificationLogin'],'api_error':_0x64a0a7[_0x1ac908(0xd9)]}};}async['changePassword'](_0x372195,_0x4aeec7){const _0x51ad82=a85_0x37ad3f,{currentPassword:_0x3c04ce,newPassword:_0x7c6943,confirmNewPassword:_0x48fc0e,twoFactorToken:_0x5bc384}=_0x4aeec7;if(_0x7c6943!==_0x48fc0e)throw new Error(_0x51ad82(0xbb));if(_0x7c6943[_0x51ad82(0xc5)]<0x6)throw new Error(_0x51ad82(0xca));const _0x26a6d1=await database_1[_0x51ad82(0xd2)][_0x51ad82(0xba)][_0x51ad82(0xe2)]({'where':{'id':_0x372195},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x26a6d1)throw new Error(_0x51ad82(0xeb));if(_0x26a6d1[_0x51ad82(0xe8)]){if(!_0x5bc384)throw new Error('2FA\x20token\x20is\x20required');const _0x3178ea=speakeasy_1['default'][_0x51ad82(0xc7)]['verify']({'secret':_0x26a6d1['twoFactorSecret'],'encoding':_0x51ad82(0xe3),'token':_0x5bc384,'window':0x2});if(!_0x3178ea){let _0x46d10a=![];if(_0x26a6d1[_0x51ad82(0xee)]){const _0x291709=JSON[_0x51ad82(0xb9)](_0x26a6d1[_0x51ad82(0xee)]);for(let _0x299a5d=0x0;_0x299a5d<_0x291709[_0x51ad82(0xc5)];_0x299a5d++){const _0x50e10=await bcryptjs_1[_0x51ad82(0xd2)][_0x51ad82(0xed)](_0x5bc384,_0x291709[_0x299a5d]);if(_0x50e10){_0x46d10a=!![],_0x291709[_0x51ad82(0xac)](_0x299a5d,0x1),await database_1[_0x51ad82(0xd2)]['shop'][_0x51ad82(0xa2)]({'where':{'id':_0x372195},'data':{'backupCodes':JSON['stringify'](_0x291709)}});break;}}}if(!_0x46d10a)throw new Error(_0x51ad82(0xea));}}const _0x1bed6c=await bcryptjs_1[_0x51ad82(0xd2)]['compare'](_0x3c04ce,_0x26a6d1[_0x51ad82(0xb0)]);if(!_0x1bed6c)throw new Error(_0x51ad82(0xe5));const _0x1cb7dc=await bcryptjs_1[_0x51ad82(0xd2)]['hash'](_0x7c6943,0xc);await database_1[_0x51ad82(0xd2)][_0x51ad82(0xba)][_0x51ad82(0xa2)]({'where':{'id':_0x372195},'data':{'password':_0x1cb7dc}});}async[a85_0x37ad3f(0xb5)](_0x9459f,_0x528397){const _0x510146=a85_0x37ad3f;await this['ensureSettingsExist'](_0x9459f);const _0x10c884={};_0x528397['payment_success']!==undefined&&(_0x10c884[_0x510146(0xc4)]=_0x528397['payment_success']),_0x528397[_0x510146(0xef)]!==undefined&&(_0x10c884['notificationPaymentFailed']=_0x528397[_0x510146(0xef)]),_0x528397[_0x510146(0xdf)]!==undefined&&(_0x10c884[_0x510146(0xc0)]=_0x528397[_0x510146(0xdf)]),_0x528397[_0x510146(0xa6)]!==undefined&&(_0x10c884[_0x510146(0xd3)]=_0x528397[_0x510146(0xa6)]),_0x528397[_0x510146(0xae)]!==undefined&&(_0x10c884[_0x510146(0xcd)]=_0x528397[_0x510146(0xae)]),_0x528397['api_error']!==undefined&&(_0x10c884['notificationApiError']=_0x528397[_0x510146(0xa1)]),await database_1[_0x510146(0xd2)][_0x510146(0xd1)]['update']({'where':{'shopId':_0x9459f},'data':_0x10c884});}async[a85_0x37ad3f(0xc1)](_0x465516,_0x2199e2){const _0x3f2e0d=a85_0x37ad3f;await this[_0x3f2e0d(0xce)](_0x465516);const _0x3899c2={};_0x2199e2[_0x3f2e0d(0xcf)]!==undefined&&(_0x3899c2['telegramBotApiKey']=_0x2199e2['botApiKey']||null),_0x2199e2[_0x3f2e0d(0x9f)]!==undefined&&(_0x3899c2['telegramChatId']=_0x2199e2[_0x3f2e0d(0x9f)]||null),await database_1[_0x3f2e0d(0xd2)]['shopSettings'][_0x3f2e0d(0xa2)]({'where':{'shopId':_0x465516},'data':_0x3899c2});}async[a85_0x37ad3f(0xa7)](_0x2dc9f5,_0x6ae78e){const _0x5ac3bf=a85_0x37ad3f;await this[_0x5ac3bf(0xce)](_0x2dc9f5);const _0x3e3a22={};_0x6ae78e[_0x5ac3bf(0xad)]!==undefined&&(_0x3e3a22[_0x5ac3bf(0xad)]=_0x6ae78e[_0x5ac3bf(0xad)]||null),_0x6ae78e[_0x5ac3bf(0xec)]!==undefined&&(_0x3e3a22[_0x5ac3bf(0xec)]=_0x6ae78e[_0x5ac3bf(0xec)]||[]),await database_1[_0x5ac3bf(0xd2)]['shopSettings'][_0x5ac3bf(0xa2)]({'where':{'shopId':_0x2dc9f5},'data':_0x3e3a22});}async['revokeAllApiKeys'](_0x5e3fab,_0xd52e52){const _0x4e530f=a85_0x37ad3f,_0x25ec95=await database_1[_0x4e530f(0xd2)][_0x4e530f(0xba)][_0x4e530f(0xe2)]({'where':{'id':_0x5e3fab},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x25ec95)throw new Error(_0x4e530f(0xeb));if(_0x25ec95[_0x4e530f(0xe8)]){if(!_0xd52e52)throw new Error(_0x4e530f(0xe0));const _0x4d3ea0=speakeasy_1['default'][_0x4e530f(0xc7)][_0x4e530f(0xaf)]({'secret':_0x25ec95['twoFactorSecret'],'encoding':_0x4e530f(0xe3),'token':_0xd52e52,'window':0x2});if(!_0x4d3ea0){let _0x2f483e=![];if(_0x25ec95[_0x4e530f(0xee)]){const _0x3ffa35=JSON['parse'](_0x25ec95[_0x4e530f(0xee)]);for(let _0x489e71=0x0;_0x489e71<_0x3ffa35['length'];_0x489e71++){const _0x13d4ef=await bcryptjs_1['default'][_0x4e530f(0xed)](_0xd52e52,_0x3ffa35[_0x489e71]);if(_0x13d4ef){_0x2f483e=!![],_0x3ffa35[_0x4e530f(0xac)](_0x489e71,0x1),await database_1[_0x4e530f(0xd2)]['shop'][_0x4e530f(0xa2)]({'where':{'id':_0x5e3fab},'data':{'backupCodes':JSON[_0x4e530f(0xd0)](_0x3ffa35)}});break;}}}if(!_0x2f483e)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x3671b1=_0x4e530f(0xb7)+crypto_1[_0x4e530f(0xd2)][_0x4e530f(0xa5)](0x20)['toString'](_0x4e530f(0xb6)),_0x3bf050=_0x4e530f(0xb1)+crypto_1['default'][_0x4e530f(0xa5)](0x20)[_0x4e530f(0xd6)](_0x4e530f(0xb6));await database_1[_0x4e530f(0xd2)]['shop'][_0x4e530f(0xa2)]({'where':{'id':_0x5e3fab},'data':{'publicKey':_0x3671b1,'secretKey':_0x3bf050}});}async[a85_0x37ad3f(0xa4)](_0x3696e3,_0x4e03e8){const _0x42d4f1=a85_0x37ad3f,{passwordConfirmation:_0x2edc18}=_0x4e03e8,_0x32327f=await database_1[_0x42d4f1(0xd2)]['shop'][_0x42d4f1(0xe2)]({'where':{'id':_0x3696e3},'select':{'password':!![]}});if(!_0x32327f)throw new Error('Shop\x20not\x20found');const _0x54ebc0=await bcryptjs_1['default']['compare'](_0x2edc18,_0x32327f[_0x42d4f1(0xb0)]);if(!_0x54ebc0)throw new Error(_0x42d4f1(0xab));await database_1[_0x42d4f1(0xd2)][_0x42d4f1(0xba)][_0x42d4f1(0xa9)]({'where':{'id':_0x3696e3}});}async['getTelegramSessions'](_0x20aa14){const _0x1f7d99=a85_0x37ad3f,_0x179c91=await database_1[_0x1f7d99(0xd2)][_0x1f7d99(0xd8)][_0x1f7d99(0xe1)]({'where':{'shopId':_0x20aa14,'isVerified':!![]},'orderBy':{'createdAt':'desc'},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x179c91;}async[a85_0x37ad3f(0xa3)](_0x2bbc2d,_0x15bc19){const _0x25ed60=a85_0x37ad3f,_0x31f420=await database_1[_0x25ed60(0xd2)][_0x25ed60(0xd8)]['findUnique']({'where':{'id':_0x15bc19},'select':{'shopId':!![]}});if(!_0x31f420)throw new Error(_0x25ed60(0xe7));if(_0x31f420['shopId']!==_0x2bbc2d)throw new Error(_0x25ed60(0xa0));await database_1[_0x25ed60(0xd2)][_0x25ed60(0xd8)]['update']({'where':{'id':_0x15bc19},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x37ad3f(0xce)](_0x43a05d){const _0x2c115d=a85_0x37ad3f,_0x587298=await database_1[_0x2c115d(0xd2)]['shopSettings']['findUnique']({'where':{'shopId':_0x43a05d}});!_0x587298&&await database_1[_0x2c115d(0xd2)]['shopSettings'][_0x2c115d(0xc9)]({'data':{'shopId':_0x43a05d}});}}function a85_0x3238(_0x585d66,_0x295e49){_0x585d66=_0x585d66-0x9f;const _0x163640=a85_0x1636();let _0x323881=_0x163640[_0x585d66];return _0x323881;}exports[a85_0x37ad3f(0xe6)]=SettingsService;