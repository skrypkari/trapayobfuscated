'use strict';const a47_0xb738c1=a47_0x4121;(function(_0x36b090,_0x288972){const _0xfa7819=a47_0x4121,_0x17fedb=_0x36b090();while(!![]){try{const _0x32b006=-parseInt(_0xfa7819(0x1a5))/0x1*(parseInt(_0xfa7819(0x1a3))/0x2)+parseInt(_0xfa7819(0x1ce))/0x3*(-parseInt(_0xfa7819(0x1cc))/0x4)+parseInt(_0xfa7819(0x1cd))/0x5+-parseInt(_0xfa7819(0x1d6))/0x6+parseInt(_0xfa7819(0x1b1))/0x7+parseInt(_0xfa7819(0x1bb))/0x8+parseInt(_0xfa7819(0x1b3))/0x9;if(_0x32b006===_0x288972)break;else _0x17fedb['push'](_0x17fedb['shift']());}catch(_0x57077e){_0x17fedb['push'](_0x17fedb['shift']());}}}(a47_0x12b9,0xf3e87));var __importDefault=this&&this[a47_0xb738c1(0x1d0)]||function(_0x2c837d){return _0x2c837d&&_0x2c837d['__esModule']?_0x2c837d:{'default':_0x2c837d};};function a47_0x12b9(){const _0x569462=['randomBytes','defineProperty','telegramBotApiKey','notificationApiError','webhookEvents','name','7315497uSGcpF','changePassword','27588330UKngqm','hex','payout','updateTelegramSettings','Password\x20confirmation\x20is\x20incorrect','repeat','findUnique','substring','3807608tafweu','parseWebhookEvents','hash','../config/database','maskApiKey','notificationPaymentFailed','botApiKey','bcryptjs','shopSettings','length','parse','payment_failed','getShopSettings','create','update','delete','toString','8sgJAjH','1319115AyGZxR','2254047NtZgJj','webhookUrl','__importDefault','pk_','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','isArray','deleteAccount','crypto','5007210EdQVaX','default','sk_','notificationPayout','api_error','password','chatId','refund','notificationLogin','payment_success','compare','telegramChatId','revokeAllApiKeys','__esModule','30xfaUbX','telegram','100929AOETSg','settings','updateNotifications','shop','Shop\x20not\x20found','ensureSettingsExist'];a47_0x12b9=function(){return _0x569462;};return a47_0x12b9();}Object[a47_0xb738c1(0x1ac)](exports,a47_0xb738c1(0x1a2),{'value':!![]}),exports['SettingsService']=void 0x0;function a47_0x4121(_0x30f574,_0x49ce96){const _0x12b9a6=a47_0x12b9();return a47_0x4121=function(_0x412103,_0x25a0e1){_0x412103=_0x412103-0x19e;let _0x46a93e=_0x12b9a6[_0x412103];return _0x46a93e;},a47_0x4121(_0x30f574,_0x49ce96);}const bcryptjs_1=__importDefault(require(a47_0xb738c1(0x1c2))),crypto_1=__importDefault(require(a47_0xb738c1(0x1d5))),database_1=__importDefault(require(a47_0xb738c1(0x1be)));class SettingsService{[a47_0xb738c1(0x1bf)](_0x4d19c1){const _0x4af0ed=a47_0xb738c1;if(!_0x4d19c1)return'';if(_0x4d19c1[_0x4af0ed(0x1c4)]<=0x8)return _0x4d19c1;const _0x500ca4=_0x4d19c1[_0x4af0ed(0x1ba)](0x0,0x8),_0x334380='*'[_0x4af0ed(0x1b8)](Math['max'](0x0,_0x4d19c1[_0x4af0ed(0x1c4)]-0x8));return _0x500ca4+_0x334380;}[a47_0xb738c1(0x1bc)](_0x4938a5){const _0x4d85ff=a47_0xb738c1;if(!_0x4938a5)return[];if(Array[_0x4d85ff(0x1d3)](_0x4938a5))return _0x4938a5;if(typeof _0x4938a5==='string')try{const _0x5f2072=JSON[_0x4d85ff(0x1c5)](_0x4938a5);return Array[_0x4d85ff(0x1d3)](_0x5f2072)?_0x5f2072:[];}catch{return[];}return[];}async[a47_0xb738c1(0x1c7)](_0x1ec850){const _0xcecb5a=a47_0xb738c1,_0x1112d0=await database_1[_0xcecb5a(0x1d7)][_0xcecb5a(0x1a8)][_0xcecb5a(0x1b9)]({'where':{'id':_0x1ec850},'include':{'settings':!![]}});if(!_0x1112d0)throw new Error(_0xcecb5a(0x1a9));let _0x3c7ad7=_0x1112d0[_0xcecb5a(0x1a6)];return!_0x3c7ad7&&(_0x3c7ad7=await database_1[_0xcecb5a(0x1d7)][_0xcecb5a(0x1c3)]['create']({'data':{'shopId':_0x1112d0['id']}})),{'fullName':_0x1112d0[_0xcecb5a(0x1b0)],'brand':_0x1112d0[_0xcecb5a(0x1b0)],'merchantUrl':_0x1112d0['shopUrl'],'telegramUsername':_0x1112d0[_0xcecb5a(0x1a4)],'telegramBotApiKey':_0x3c7ad7[_0xcecb5a(0x1ad)]?this[_0xcecb5a(0x1bf)](_0x3c7ad7[_0xcecb5a(0x1ad)]):null,'telegramChatId':_0x3c7ad7[_0xcecb5a(0x1a0)],'webhookUrl':_0x3c7ad7[_0xcecb5a(0x1cf)],'webhookEvents':this[_0xcecb5a(0x1bc)](_0x3c7ad7[_0xcecb5a(0x1af)]),'notifications':{'payment_success':_0x3c7ad7['notificationPaymentSuccess'],'payment_failed':_0x3c7ad7[_0xcecb5a(0x1c0)],'refund':_0x3c7ad7['notificationRefund'],'payout':_0x3c7ad7[_0xcecb5a(0x1d9)],'login':_0x3c7ad7[_0xcecb5a(0x1de)],'api_error':_0x3c7ad7[_0xcecb5a(0x1ae)]}};}async[a47_0xb738c1(0x1b2)](_0x57873d,_0xd9820d){const _0x579b17=a47_0xb738c1,{currentPassword:_0x3417ce,newPassword:_0x5eaf76,confirmNewPassword:_0xdef06f}=_0xd9820d;if(_0x5eaf76!==_0xdef06f)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x5eaf76[_0x579b17(0x1c4)]<0x6)throw new Error(_0x579b17(0x1d2));const _0x3dbaa3=await database_1[_0x579b17(0x1d7)][_0x579b17(0x1a8)][_0x579b17(0x1b9)]({'where':{'id':_0x57873d},'select':{'password':!![]}});if(!_0x3dbaa3)throw new Error(_0x579b17(0x1a9));const _0x4f87cd=await bcryptjs_1[_0x579b17(0x1d7)][_0x579b17(0x19f)](_0x3417ce,_0x3dbaa3['password']);if(!_0x4f87cd)throw new Error('Current\x20password\x20is\x20incorrect');const _0x2afa6e=await bcryptjs_1[_0x579b17(0x1d7)][_0x579b17(0x1bd)](_0x5eaf76,0xc);await database_1['default'][_0x579b17(0x1a8)][_0x579b17(0x1c9)]({'where':{'id':_0x57873d},'data':{'password':_0x2afa6e}});}async[a47_0xb738c1(0x1a7)](_0x31d090,_0x41429a){const _0x4b2dd2=a47_0xb738c1;await this[_0x4b2dd2(0x1aa)](_0x31d090);const _0x160aee={};_0x41429a[_0x4b2dd2(0x19e)]!==undefined&&(_0x160aee['notificationPaymentSuccess']=_0x41429a[_0x4b2dd2(0x19e)]),_0x41429a[_0x4b2dd2(0x1c6)]!==undefined&&(_0x160aee['notificationPaymentFailed']=_0x41429a[_0x4b2dd2(0x1c6)]),_0x41429a['refund']!==undefined&&(_0x160aee['notificationRefund']=_0x41429a[_0x4b2dd2(0x1dd)]),_0x41429a['payout']!==undefined&&(_0x160aee['notificationPayout']=_0x41429a[_0x4b2dd2(0x1b5)]),_0x41429a['login']!==undefined&&(_0x160aee[_0x4b2dd2(0x1de)]=_0x41429a['login']),_0x41429a['api_error']!==undefined&&(_0x160aee['notificationApiError']=_0x41429a[_0x4b2dd2(0x1da)]),await database_1[_0x4b2dd2(0x1d7)][_0x4b2dd2(0x1c3)]['update']({'where':{'shopId':_0x31d090},'data':_0x160aee});}async[a47_0xb738c1(0x1b6)](_0x3dad96,_0x12d9f2){const _0x52c91b=a47_0xb738c1;await this['ensureSettingsExist'](_0x3dad96);const _0x3632cb={};_0x12d9f2['botApiKey']!==undefined&&(_0x3632cb[_0x52c91b(0x1ad)]=_0x12d9f2[_0x52c91b(0x1c1)]||null),_0x12d9f2['chatId']!==undefined&&(_0x3632cb['telegramChatId']=_0x12d9f2[_0x52c91b(0x1dc)]||null),await database_1[_0x52c91b(0x1d7)][_0x52c91b(0x1c3)][_0x52c91b(0x1c9)]({'where':{'shopId':_0x3dad96},'data':_0x3632cb});}async['updateWebhookSettings'](_0x23e37a,_0x4e45cc){const _0xb40f72=a47_0xb738c1;await this[_0xb40f72(0x1aa)](_0x23e37a);const _0x5aa79e={};_0x4e45cc[_0xb40f72(0x1cf)]!==undefined&&(_0x5aa79e[_0xb40f72(0x1cf)]=_0x4e45cc['webhookUrl']||null),_0x4e45cc[_0xb40f72(0x1af)]!==undefined&&(_0x5aa79e[_0xb40f72(0x1af)]=_0x4e45cc[_0xb40f72(0x1af)]||[]),await database_1['default'][_0xb40f72(0x1c3)]['update']({'where':{'shopId':_0x23e37a},'data':_0x5aa79e});}async[a47_0xb738c1(0x1a1)](_0x5bc459){const _0x193586=a47_0xb738c1,_0x3c7a4d=_0x193586(0x1d1)+crypto_1['default'][_0x193586(0x1ab)](0x20)[_0x193586(0x1cb)]('hex'),_0x125b70=_0x193586(0x1d8)+crypto_1[_0x193586(0x1d7)][_0x193586(0x1ab)](0x20)[_0x193586(0x1cb)](_0x193586(0x1b4));await database_1[_0x193586(0x1d7)][_0x193586(0x1a8)][_0x193586(0x1c9)]({'where':{'id':_0x5bc459},'data':{'publicKey':_0x3c7a4d,'secretKey':_0x125b70}});}async[a47_0xb738c1(0x1d4)](_0x502a46,_0x1aca8f){const _0x58def8=a47_0xb738c1,{passwordConfirmation:_0x595285}=_0x1aca8f,_0x4f99e0=await database_1[_0x58def8(0x1d7)][_0x58def8(0x1a8)][_0x58def8(0x1b9)]({'where':{'id':_0x502a46},'select':{'password':!![]}});if(!_0x4f99e0)throw new Error(_0x58def8(0x1a9));const _0x1adab4=await bcryptjs_1[_0x58def8(0x1d7)][_0x58def8(0x19f)](_0x595285,_0x4f99e0[_0x58def8(0x1db)]);if(!_0x1adab4)throw new Error(_0x58def8(0x1b7));await database_1[_0x58def8(0x1d7)]['shop'][_0x58def8(0x1ca)]({'where':{'id':_0x502a46}});}async['ensureSettingsExist'](_0x2850c0){const _0x5ec4c4=a47_0xb738c1,_0x132879=await database_1['default'][_0x5ec4c4(0x1c3)][_0x5ec4c4(0x1b9)]({'where':{'shopId':_0x2850c0}});!_0x132879&&await database_1[_0x5ec4c4(0x1d7)][_0x5ec4c4(0x1c3)][_0x5ec4c4(0x1c8)]({'data':{'shopId':_0x2850c0}});}}exports['SettingsService']=SettingsService;