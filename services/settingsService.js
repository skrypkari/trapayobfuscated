'use strict';function a85_0x1af6(){const _0x269621=['Unauthorized\x20to\x20disconnect\x20this\x20session','base32','botApiKey','notificationLogin','webhookUrl','max','telegramUsers','isArray','revokeAllApiKeys','api_error','notificationPayout','speakeasy','hex','1673732xNklgD','telegramBotApiKey','repeat','payment_success','delete','disconnectTelegramSession','create','_count','688xXzGUW','Telegram\x20session\x20not\x20found','default','deleteAccount','getTelegramSessions','compare','update','twoFactorSecret','15048lmOQrR','2255TlJEma','findMany','webhookEvents','password','parse','notificationRefund','twoFactorEnabled','1697690XIitLr','updateTelegramSettings','../config/database','SettingsService','Shop\x20not\x20found','randomBytes','__esModule','3SAWXJj','maskApiKey','parseWebhookEvents','shop','2FA\x20token\x20is\x20required','__importDefault','11123oSofmN','name','sk_','9BVHCVZ','backupCodes','notificationPaymentSuccess','chatId','241537zwZkLK','notificationPaymentFailed','ensureSettingsExist','findUnique','payout','login','stringify','telegramChatId','75756PdKZLi','shopSettings','telegramUser','payment_failed','totp','hash','pk_','verify','desc','getShopSettings','updateNotifications','notificationApiError','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','Invalid\x202FA\x20token\x20or\x20backup\x20code','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','updateWebhookSettings','365484lSXEMW','toString','length','65AhtWsQ'];a85_0x1af6=function(){return _0x269621;};return a85_0x1af6();}const a85_0x4d48e3=a85_0x2677;(function(_0x835c88,_0x5466eb){const _0x11b3dc=a85_0x2677,_0x1482fe=_0x835c88();while(!![]){try{const _0x34bb68=parseInt(_0x11b3dc(0xed))/0x1+-parseInt(_0x11b3dc(0x105))/0x2+parseInt(_0x11b3dc(0xe0))/0x3*(parseInt(_0x11b3dc(0xc1))/0x4)+parseInt(_0x11b3dc(0x108))/0x5*(parseInt(_0x11b3dc(0xf5))/0x6)+-parseInt(_0x11b3dc(0xe6))/0x7*(-parseInt(_0x11b3dc(0xc9))/0x8)+parseInt(_0x11b3dc(0xe9))/0x9*(-parseInt(_0x11b3dc(0xd9))/0xa)+parseInt(_0x11b3dc(0xd2))/0xb*(-parseInt(_0x11b3dc(0xd1))/0xc);if(_0x34bb68===_0x5466eb)break;else _0x1482fe['push'](_0x1482fe['shift']());}catch(_0x37c295){_0x1482fe['push'](_0x1482fe['shift']());}}}(a85_0x1af6,0x55bcd));var __importDefault=this&&this[a85_0x4d48e3(0xe5)]||function(_0x33371f){const _0x58aa54=a85_0x4d48e3;return _0x33371f&&_0x33371f[_0x58aa54(0xdf)]?_0x33371f:{'default':_0x33371f};};Object['defineProperty'](exports,a85_0x4d48e3(0xdf),{'value':!![]}),exports[a85_0x4d48e3(0xdc)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require('crypto')),speakeasy_1=__importDefault(require(a85_0x4d48e3(0xbf))),database_1=__importDefault(require(a85_0x4d48e3(0xdb)));class SettingsService{[a85_0x4d48e3(0xe1)](_0xff9b67){const _0x5900d=a85_0x4d48e3;if(!_0xff9b67)return'';if(_0xff9b67[_0x5900d(0x107)]<=0x8)return _0xff9b67;const _0x1a8f34=_0xff9b67['substring'](0x0,0x8),_0x53ff0a='*'[_0x5900d(0xc3)](Math[_0x5900d(0xb9)](0x0,_0xff9b67[_0x5900d(0x107)]-0x8));return _0x1a8f34+_0x53ff0a;}[a85_0x4d48e3(0xe2)](_0x101532){const _0x3728e1=a85_0x4d48e3;if(!_0x101532)return[];if(Array[_0x3728e1(0xbb)](_0x101532))return _0x101532;if(typeof _0x101532==='string')try{const _0x2e7499=JSON[_0x3728e1(0xd6)](_0x101532);return Array[_0x3728e1(0xbb)](_0x2e7499)?_0x2e7499:[];}catch{return[];}return[];}async[a85_0x4d48e3(0xfe)](_0x403678){const _0x215a51=a85_0x4d48e3,_0x21d116=await database_1[_0x215a51(0xcb)][_0x215a51(0xe3)][_0x215a51(0xf0)]({'where':{'id':_0x403678},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x21d116)throw new Error(_0x215a51(0xdd));let _0x4d9beb=_0x21d116['settings'];return!_0x4d9beb&&(_0x4d9beb=await database_1[_0x215a51(0xcb)][_0x215a51(0xf6)][_0x215a51(0xc7)]({'data':{'shopId':_0x21d116['id']}})),{'fullName':_0x21d116[_0x215a51(0xe7)],'brand':_0x21d116['name'],'merchantUrl':_0x21d116['shopUrl'],'telegramUsername':_0x21d116['telegram'],'telegramBotApiKey':_0x4d9beb['telegramBotApiKey']?this[_0x215a51(0xe1)](_0x4d9beb[_0x215a51(0xc2)]):null,'telegramChatId':_0x4d9beb['telegramChatId'],'telegramUsersCount':_0x21d116[_0x215a51(0xc8)][_0x215a51(0xba)],'webhookUrl':_0x4d9beb[_0x215a51(0xb8)],'webhookEvents':this[_0x215a51(0xe2)](_0x4d9beb[_0x215a51(0xd4)]),'twoFactorEnabled':_0x21d116[_0x215a51(0xd8)]||![],'notifications':{'payment_success':_0x4d9beb[_0x215a51(0xeb)],'payment_failed':_0x4d9beb[_0x215a51(0xee)],'refund':_0x4d9beb[_0x215a51(0xd7)],'payout':_0x4d9beb[_0x215a51(0xbe)],'login':_0x4d9beb[_0x215a51(0x10c)],'api_error':_0x4d9beb['notificationApiError']}};}async['changePassword'](_0x1f4cda,_0x14c992){const _0x102daa=a85_0x4d48e3,{currentPassword:_0x4224b0,newPassword:_0xab6e9,confirmNewPassword:_0x5ca173,twoFactorToken:_0x5e3ed0}=_0x14c992;if(_0xab6e9!==_0x5ca173)throw new Error(_0x102daa(0x101));if(_0xab6e9[_0x102daa(0x107)]<0x6)throw new Error(_0x102daa(0x103));const _0x36c947=await database_1[_0x102daa(0xcb)][_0x102daa(0xe3)][_0x102daa(0xf0)]({'where':{'id':_0x1f4cda},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x36c947)throw new Error(_0x102daa(0xdd));if(_0x36c947['twoFactorEnabled']){if(!_0x5e3ed0)throw new Error(_0x102daa(0xe4));const _0x29b9a6=speakeasy_1['default']['totp'][_0x102daa(0xfc)]({'secret':_0x36c947['twoFactorSecret'],'encoding':_0x102daa(0x10a),'token':_0x5e3ed0,'window':0x2});if(!_0x29b9a6){let _0x171a5c=![];if(_0x36c947[_0x102daa(0xea)]){const _0x24a0ff=JSON[_0x102daa(0xd6)](_0x36c947[_0x102daa(0xea)]);for(let _0x31f6e3=0x0;_0x31f6e3<_0x24a0ff['length'];_0x31f6e3++){const _0xc969c2=await bcryptjs_1[_0x102daa(0xcb)][_0x102daa(0xce)](_0x5e3ed0,_0x24a0ff[_0x31f6e3]);if(_0xc969c2){_0x171a5c=!![],_0x24a0ff['splice'](_0x31f6e3,0x1),await database_1['default'][_0x102daa(0xe3)][_0x102daa(0xcf)]({'where':{'id':_0x1f4cda},'data':{'backupCodes':JSON['stringify'](_0x24a0ff)}});break;}}}if(!_0x171a5c)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x441add=await bcryptjs_1[_0x102daa(0xcb)][_0x102daa(0xce)](_0x4224b0,_0x36c947[_0x102daa(0xd5)]);if(!_0x441add)throw new Error('Current\x20password\x20is\x20incorrect');const _0x1430b6=await bcryptjs_1[_0x102daa(0xcb)][_0x102daa(0xfa)](_0xab6e9,0xc);await database_1['default']['shop'][_0x102daa(0xcf)]({'where':{'id':_0x1f4cda},'data':{'password':_0x1430b6}});}async[a85_0x4d48e3(0xff)](_0x43dc83,_0x7f2477){const _0x13e5c3=a85_0x4d48e3;await this[_0x13e5c3(0xef)](_0x43dc83);const _0x4c5679={};_0x7f2477['payment_success']!==undefined&&(_0x4c5679[_0x13e5c3(0xeb)]=_0x7f2477[_0x13e5c3(0xc4)]),_0x7f2477[_0x13e5c3(0xf8)]!==undefined&&(_0x4c5679[_0x13e5c3(0xee)]=_0x7f2477['payment_failed']),_0x7f2477['refund']!==undefined&&(_0x4c5679[_0x13e5c3(0xd7)]=_0x7f2477['refund']),_0x7f2477[_0x13e5c3(0xf1)]!==undefined&&(_0x4c5679['notificationPayout']=_0x7f2477[_0x13e5c3(0xf1)]),_0x7f2477[_0x13e5c3(0xf2)]!==undefined&&(_0x4c5679[_0x13e5c3(0x10c)]=_0x7f2477[_0x13e5c3(0xf2)]),_0x7f2477[_0x13e5c3(0xbd)]!==undefined&&(_0x4c5679[_0x13e5c3(0x100)]=_0x7f2477[_0x13e5c3(0xbd)]),await database_1[_0x13e5c3(0xcb)][_0x13e5c3(0xf6)][_0x13e5c3(0xcf)]({'where':{'shopId':_0x43dc83},'data':_0x4c5679});}async[a85_0x4d48e3(0xda)](_0x4e852a,_0x160aae){const _0x4b0cba=a85_0x4d48e3;await this[_0x4b0cba(0xef)](_0x4e852a);const _0x7e3c08={};_0x160aae[_0x4b0cba(0x10b)]!==undefined&&(_0x7e3c08[_0x4b0cba(0xc2)]=_0x160aae[_0x4b0cba(0x10b)]||null),_0x160aae[_0x4b0cba(0xec)]!==undefined&&(_0x7e3c08[_0x4b0cba(0xf4)]=_0x160aae[_0x4b0cba(0xec)]||null),await database_1[_0x4b0cba(0xcb)]['shopSettings'][_0x4b0cba(0xcf)]({'where':{'shopId':_0x4e852a},'data':_0x7e3c08});}async[a85_0x4d48e3(0x104)](_0x2dd773,_0x3adfd1){const _0x12d5b8=a85_0x4d48e3;await this[_0x12d5b8(0xef)](_0x2dd773);const _0x13ce8b={};_0x3adfd1[_0x12d5b8(0xb8)]!==undefined&&(_0x13ce8b[_0x12d5b8(0xb8)]=_0x3adfd1[_0x12d5b8(0xb8)]||null),_0x3adfd1[_0x12d5b8(0xd4)]!==undefined&&(_0x13ce8b[_0x12d5b8(0xd4)]=_0x3adfd1[_0x12d5b8(0xd4)]||[]),await database_1[_0x12d5b8(0xcb)][_0x12d5b8(0xf6)][_0x12d5b8(0xcf)]({'where':{'shopId':_0x2dd773},'data':_0x13ce8b});}async[a85_0x4d48e3(0xbc)](_0x397975,_0x27d953){const _0xc69eaf=a85_0x4d48e3,_0x516e8a=await database_1[_0xc69eaf(0xcb)][_0xc69eaf(0xe3)]['findUnique']({'where':{'id':_0x397975},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x516e8a)throw new Error(_0xc69eaf(0xdd));if(_0x516e8a[_0xc69eaf(0xd8)]){if(!_0x27d953)throw new Error(_0xc69eaf(0xe4));const _0x51b191=speakeasy_1[_0xc69eaf(0xcb)][_0xc69eaf(0xf9)][_0xc69eaf(0xfc)]({'secret':_0x516e8a[_0xc69eaf(0xd0)],'encoding':_0xc69eaf(0x10a),'token':_0x27d953,'window':0x2});if(!_0x51b191){let _0x292cad=![];if(_0x516e8a[_0xc69eaf(0xea)]){const _0x253fd9=JSON[_0xc69eaf(0xd6)](_0x516e8a['backupCodes']);for(let _0x5be5a0=0x0;_0x5be5a0<_0x253fd9[_0xc69eaf(0x107)];_0x5be5a0++){const _0x36d9b5=await bcryptjs_1['default'][_0xc69eaf(0xce)](_0x27d953,_0x253fd9[_0x5be5a0]);if(_0x36d9b5){_0x292cad=!![],_0x253fd9['splice'](_0x5be5a0,0x1),await database_1[_0xc69eaf(0xcb)][_0xc69eaf(0xe3)][_0xc69eaf(0xcf)]({'where':{'id':_0x397975},'data':{'backupCodes':JSON[_0xc69eaf(0xf3)](_0x253fd9)}});break;}}}if(!_0x292cad)throw new Error(_0xc69eaf(0x102));}}const _0x317547=_0xc69eaf(0xfb)+crypto_1['default'][_0xc69eaf(0xde)](0x20)[_0xc69eaf(0x106)](_0xc69eaf(0xc0)),_0x208590=_0xc69eaf(0xe8)+crypto_1[_0xc69eaf(0xcb)]['randomBytes'](0x20)[_0xc69eaf(0x106)](_0xc69eaf(0xc0));await database_1[_0xc69eaf(0xcb)][_0xc69eaf(0xe3)][_0xc69eaf(0xcf)]({'where':{'id':_0x397975},'data':{'publicKey':_0x317547,'secretKey':_0x208590}});}async[a85_0x4d48e3(0xcc)](_0x30da02,_0x3fbc56){const _0x5bcef5=a85_0x4d48e3,{passwordConfirmation:_0x284a24}=_0x3fbc56,_0x5953b8=await database_1[_0x5bcef5(0xcb)][_0x5bcef5(0xe3)][_0x5bcef5(0xf0)]({'where':{'id':_0x30da02},'select':{'password':!![]}});if(!_0x5953b8)throw new Error('Shop\x20not\x20found');const _0x1f1b87=await bcryptjs_1[_0x5bcef5(0xcb)][_0x5bcef5(0xce)](_0x284a24,_0x5953b8[_0x5bcef5(0xd5)]);if(!_0x1f1b87)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1['default']['shop'][_0x5bcef5(0xc5)]({'where':{'id':_0x30da02}});}async[a85_0x4d48e3(0xcd)](_0x5ea933){const _0x44e3e7=a85_0x4d48e3,_0x198ad4=await database_1[_0x44e3e7(0xcb)]['telegramUser'][_0x44e3e7(0xd3)]({'where':{'shopId':_0x5ea933,'isVerified':!![]},'orderBy':{'createdAt':_0x44e3e7(0xfd)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x198ad4;}async[a85_0x4d48e3(0xc6)](_0x5eb15f,_0x4bfbd4){const _0x4b982f=a85_0x4d48e3,_0x31110e=await database_1[_0x4b982f(0xcb)]['telegramUser'][_0x4b982f(0xf0)]({'where':{'id':_0x4bfbd4},'select':{'shopId':!![]}});if(!_0x31110e)throw new Error(_0x4b982f(0xca));if(_0x31110e['shopId']!==_0x5eb15f)throw new Error(_0x4b982f(0x109));await database_1[_0x4b982f(0xcb)][_0x4b982f(0xf7)][_0x4b982f(0xcf)]({'where':{'id':_0x4bfbd4},'data':{'shopId':null,'isVerified':![]}});}async['ensureSettingsExist'](_0x4a29c7){const _0x50e87e=a85_0x4d48e3,_0xca3ca7=await database_1[_0x50e87e(0xcb)][_0x50e87e(0xf6)][_0x50e87e(0xf0)]({'where':{'shopId':_0x4a29c7}});!_0xca3ca7&&await database_1[_0x50e87e(0xcb)][_0x50e87e(0xf6)][_0x50e87e(0xc7)]({'data':{'shopId':_0x4a29c7}});}}function a85_0x2677(_0x7e601e,_0x427323){_0x7e601e=_0x7e601e-0xb8;const _0x1af660=a85_0x1af6();let _0x2677de=_0x1af660[_0x7e601e];return _0x2677de;}exports[a85_0x4d48e3(0xdc)]=SettingsService;