'use strict';function a47_0x740b(_0x283827,_0x5631dc){const _0x2bf4a5=a47_0x2bf4();return a47_0x740b=function(_0x740b44,_0x50afd0){_0x740b44=_0x740b44-0x127;let _0x54320d=_0x2bf4a5[_0x740b44];return _0x54320d;},a47_0x740b(_0x283827,_0x5631dc);}const a47_0x32fc85=a47_0x740b;(function(_0x2f9f43,_0x27cca4){const _0x1ea066=a47_0x740b,_0x41347e=_0x2f9f43();while(!![]){try{const _0x37231c=parseInt(_0x1ea066(0x153))/0x1+parseInt(_0x1ea066(0x136))/0x2*(-parseInt(_0x1ea066(0x15a))/0x3)+parseInt(_0x1ea066(0x12d))/0x4*(-parseInt(_0x1ea066(0x134))/0x5)+parseInt(_0x1ea066(0x12f))/0x6+parseInt(_0x1ea066(0x143))/0x7+-parseInt(_0x1ea066(0x13b))/0x8+-parseInt(_0x1ea066(0x156))/0x9*(-parseInt(_0x1ea066(0x165))/0xa);if(_0x37231c===_0x27cca4)break;else _0x41347e['push'](_0x41347e['shift']());}catch(_0x123bff){_0x41347e['push'](_0x41347e['shift']());}}}(a47_0x2bf4,0x345b4));var __importDefault=this&&this[a47_0x32fc85(0x145)]||function(_0x1f17b8){const _0x51c154=a47_0x32fc85;return _0x1f17b8&&_0x1f17b8[_0x51c154(0x167)]?_0x1f17b8:{'default':_0x1f17b8};};Object[a47_0x32fc85(0x13c)](exports,a47_0x32fc85(0x167),{'value':!![]}),exports[a47_0x32fc85(0x140)]=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x32fc85(0x12e))),crypto_1=__importDefault(require('crypto')),database_1=__importDefault(require('../config/database'));function a47_0x2bf4(){const _0x5be838=['create','hex','SettingsService','shopSettings','findUnique','1659168QpEStL','getShopSettings','__importDefault','maskApiKey','substring','notificationRefund','botApiKey','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','Shop\x20not\x20found','notificationPaymentFailed','deleteAccount','length','webhookUrl','pk_','api_error','chatId','173404BcVhOg','name','telegramChatId','276606SdjEvI','repeat','settings','default','103134DkVcmO','max','telegram','Current\x20password\x20is\x20incorrect','updateWebhookSettings','notificationPayout','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','shop','ensureSettingsExist','webhookEvents','payment_failed','50agLZQK','refund','__esModule','randomBytes','password','compare','delete','parseWebhookEvents','toString','update','changePassword','39268bSuLDe','bcryptjs','463266NtaGSX','parse','hash','isArray','notificationPaymentSuccess','50EHjjlF','sk_','4zUxzPa','notificationApiError','payout','telegramBotApiKey','login','2079448GGegGi','defineProperty','shopUrl'];a47_0x2bf4=function(){return _0x5be838;};return a47_0x2bf4();}class SettingsService{[a47_0x32fc85(0x146)](_0x3edc37){const _0x60e09c=a47_0x32fc85;if(!_0x3edc37)return'';if(_0x3edc37['length']<=0x8)return _0x3edc37;const _0x380135=_0x3edc37[_0x60e09c(0x147)](0x0,0x8),_0x443836='*'[_0x60e09c(0x157)](Math[_0x60e09c(0x15b)](0x0,_0x3edc37[_0x60e09c(0x14e)]-0x8));return _0x380135+_0x443836;}[a47_0x32fc85(0x129)](_0x25062a){const _0x15f5b4=a47_0x32fc85;if(!_0x25062a)return[];if(Array[_0x15f5b4(0x132)](_0x25062a))return _0x25062a;if(typeof _0x25062a==='string')try{const _0x2407a2=JSON[_0x15f5b4(0x130)](_0x25062a);return Array[_0x15f5b4(0x132)](_0x2407a2)?_0x2407a2:[];}catch{return[];}return[];}async[a47_0x32fc85(0x144)](_0x1bd026){const _0x15965e=a47_0x32fc85,_0x201d1f=await database_1[_0x15965e(0x159)][_0x15965e(0x161)]['findUnique']({'where':{'id':_0x1bd026},'include':{'settings':!![]}});if(!_0x201d1f)throw new Error(_0x15965e(0x14b));let _0xcd125=_0x201d1f[_0x15965e(0x158)];return!_0xcd125&&(_0xcd125=await database_1['default']['shopSettings']['create']({'data':{'shopId':_0x201d1f['id']}})),{'fullName':_0x201d1f['name'],'brand':_0x201d1f[_0x15965e(0x154)],'merchantUrl':_0x201d1f[_0x15965e(0x13d)],'telegramUsername':_0x201d1f[_0x15965e(0x15c)],'telegramBotApiKey':_0xcd125[_0x15965e(0x139)]?this['maskApiKey'](_0xcd125[_0x15965e(0x139)]):null,'telegramChatId':_0xcd125[_0x15965e(0x155)],'webhookUrl':_0xcd125[_0x15965e(0x14f)],'webhookEvents':this[_0x15965e(0x129)](_0xcd125['webhookEvents']),'notifications':{'payment_success':_0xcd125[_0x15965e(0x133)],'payment_failed':_0xcd125[_0x15965e(0x14c)],'refund':_0xcd125['notificationRefund'],'payout':_0xcd125[_0x15965e(0x15f)],'login':_0xcd125['notificationLogin'],'api_error':_0xcd125[_0x15965e(0x137)]}};}async[a47_0x32fc85(0x12c)](_0x130798,_0x49199d){const _0x2245d9=a47_0x32fc85,{currentPassword:_0x388268,newPassword:_0x385836,confirmNewPassword:_0x36a5a5}=_0x49199d;if(_0x385836!==_0x36a5a5)throw new Error(_0x2245d9(0x14a));if(_0x385836[_0x2245d9(0x14e)]<0x6)throw new Error(_0x2245d9(0x160));const _0x24f3dd=await database_1[_0x2245d9(0x159)][_0x2245d9(0x161)][_0x2245d9(0x142)]({'where':{'id':_0x130798},'select':{'password':!![]}});if(!_0x24f3dd)throw new Error(_0x2245d9(0x14b));const _0x4ace9e=await bcryptjs_1[_0x2245d9(0x159)]['compare'](_0x388268,_0x24f3dd[_0x2245d9(0x169)]);if(!_0x4ace9e)throw new Error(_0x2245d9(0x15d));const _0x39bea3=await bcryptjs_1[_0x2245d9(0x159)][_0x2245d9(0x131)](_0x385836,0xc);await database_1[_0x2245d9(0x159)]['shop'][_0x2245d9(0x12b)]({'where':{'id':_0x130798},'data':{'password':_0x39bea3}});}async['updateNotifications'](_0x31acb4,_0xcc88df){const _0x4f1586=a47_0x32fc85;await this['ensureSettingsExist'](_0x31acb4);const _0x5e63a6={};_0xcc88df['payment_success']!==undefined&&(_0x5e63a6[_0x4f1586(0x133)]=_0xcc88df['payment_success']),_0xcc88df[_0x4f1586(0x164)]!==undefined&&(_0x5e63a6[_0x4f1586(0x14c)]=_0xcc88df[_0x4f1586(0x164)]),_0xcc88df['refund']!==undefined&&(_0x5e63a6[_0x4f1586(0x148)]=_0xcc88df[_0x4f1586(0x166)]),_0xcc88df['payout']!==undefined&&(_0x5e63a6[_0x4f1586(0x15f)]=_0xcc88df[_0x4f1586(0x138)]),_0xcc88df[_0x4f1586(0x13a)]!==undefined&&(_0x5e63a6['notificationLogin']=_0xcc88df[_0x4f1586(0x13a)]),_0xcc88df['api_error']!==undefined&&(_0x5e63a6[_0x4f1586(0x137)]=_0xcc88df[_0x4f1586(0x151)]),await database_1[_0x4f1586(0x159)]['shopSettings'][_0x4f1586(0x12b)]({'where':{'shopId':_0x31acb4},'data':_0x5e63a6});}async['updateTelegramSettings'](_0x4f5008,_0x223d7b){const _0xce5eb9=a47_0x32fc85;await this[_0xce5eb9(0x162)](_0x4f5008);const _0x27032c={};_0x223d7b[_0xce5eb9(0x149)]!==undefined&&(_0x27032c[_0xce5eb9(0x139)]=_0x223d7b[_0xce5eb9(0x149)]||null),_0x223d7b[_0xce5eb9(0x152)]!==undefined&&(_0x27032c[_0xce5eb9(0x155)]=_0x223d7b[_0xce5eb9(0x152)]||null),await database_1[_0xce5eb9(0x159)][_0xce5eb9(0x141)][_0xce5eb9(0x12b)]({'where':{'shopId':_0x4f5008},'data':_0x27032c});}async[a47_0x32fc85(0x15e)](_0x1c720d,_0x3a3408){const _0x432fbd=a47_0x32fc85;await this['ensureSettingsExist'](_0x1c720d);const _0x2c3361={};_0x3a3408[_0x432fbd(0x14f)]!==undefined&&(_0x2c3361['webhookUrl']=_0x3a3408[_0x432fbd(0x14f)]||null),_0x3a3408[_0x432fbd(0x163)]!==undefined&&(_0x2c3361[_0x432fbd(0x163)]=_0x3a3408[_0x432fbd(0x163)]||[]),await database_1[_0x432fbd(0x159)]['shopSettings'][_0x432fbd(0x12b)]({'where':{'shopId':_0x1c720d},'data':_0x2c3361});}async['revokeAllApiKeys'](_0x12d9af){const _0x2d1f6b=a47_0x32fc85,_0x55ce7c=_0x2d1f6b(0x150)+crypto_1[_0x2d1f6b(0x159)][_0x2d1f6b(0x168)](0x20)[_0x2d1f6b(0x12a)](_0x2d1f6b(0x13f)),_0x253534=_0x2d1f6b(0x135)+crypto_1[_0x2d1f6b(0x159)][_0x2d1f6b(0x168)](0x20)[_0x2d1f6b(0x12a)]('hex');await database_1['default'][_0x2d1f6b(0x161)][_0x2d1f6b(0x12b)]({'where':{'id':_0x12d9af},'data':{'publicKey':_0x55ce7c,'secretKey':_0x253534}});}async[a47_0x32fc85(0x14d)](_0x25d09a,_0x19c30c){const _0xef1a7=a47_0x32fc85,{passwordConfirmation:_0x38b26f}=_0x19c30c,_0x4e35d3=await database_1[_0xef1a7(0x159)][_0xef1a7(0x161)][_0xef1a7(0x142)]({'where':{'id':_0x25d09a},'select':{'password':!![]}});if(!_0x4e35d3)throw new Error('Shop\x20not\x20found');const _0x14ef7c=await bcryptjs_1['default'][_0xef1a7(0x127)](_0x38b26f,_0x4e35d3[_0xef1a7(0x169)]);if(!_0x14ef7c)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0xef1a7(0x159)]['shop'][_0xef1a7(0x128)]({'where':{'id':_0x25d09a}});}async[a47_0x32fc85(0x162)](_0x5d7a3d){const _0x4d2649=a47_0x32fc85,_0x249a35=await database_1[_0x4d2649(0x159)]['shopSettings'][_0x4d2649(0x142)]({'where':{'shopId':_0x5d7a3d}});!_0x249a35&&await database_1['default'][_0x4d2649(0x141)][_0x4d2649(0x13e)]({'data':{'shopId':_0x5d7a3d}});}}exports[a47_0x32fc85(0x140)]=SettingsService;