'use strict';const a85_0x168d1c=a85_0x60f9;function a85_0x60f9(_0x58132b,_0xb1584a){_0x58132b=_0x58132b-0x12f;const _0x55fa3c=a85_0x55fa();let _0x60f9c3=_0x55fa3c[_0x58132b];return _0x60f9c3;}(function(_0x557f3f,_0x3531e6){const _0x161e23=a85_0x60f9,_0x5bd5fa=_0x557f3f();while(!![]){try{const _0x3865ef=parseInt(_0x161e23(0x164))/0x1*(-parseInt(_0x161e23(0x169))/0x2)+-parseInt(_0x161e23(0x13e))/0x3*(-parseInt(_0x161e23(0x15d))/0x4)+parseInt(_0x161e23(0x14b))/0x5*(-parseInt(_0x161e23(0x158))/0x6)+-parseInt(_0x161e23(0x149))/0x7+-parseInt(_0x161e23(0x16f))/0x8*(parseInt(_0x161e23(0x159))/0x9)+parseInt(_0x161e23(0x176))/0xa*(-parseInt(_0x161e23(0x135))/0xb)+parseInt(_0x161e23(0x147))/0xc;if(_0x3865ef===_0x3531e6)break;else _0x5bd5fa['push'](_0x5bd5fa['shift']());}catch(_0x18eef0){_0x5bd5fa['push'](_0x5bd5fa['shift']());}}}(a85_0x55fa,0x93508));var __importDefault=this&&this[a85_0x168d1c(0x177)]||function(_0x1c1b12){const _0x482a7b=a85_0x168d1c;return _0x1c1b12&&_0x1c1b12[_0x482a7b(0x146)]?_0x1c1b12:{'default':_0x1c1b12};};Object[a85_0x168d1c(0x154)](exports,'__esModule',{'value':!![]}),exports[a85_0x168d1c(0x133)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x168d1c(0x167))),crypto_1=__importDefault(require('crypto')),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a85_0x168d1c(0x148)));class SettingsService{[a85_0x168d1c(0x15f)](_0x397b93){const _0x4d580b=a85_0x168d1c;if(!_0x397b93)return'';if(_0x397b93[_0x4d580b(0x17b)]<=0x8)return _0x397b93;const _0x5285c9=_0x397b93['substring'](0x0,0x8),_0x37d5ae='*'[_0x4d580b(0x15c)](Math[_0x4d580b(0x16b)](0x0,_0x397b93[_0x4d580b(0x17b)]-0x8));return _0x5285c9+_0x37d5ae;}[a85_0x168d1c(0x165)](_0x4f0496){const _0x127a99=a85_0x168d1c;if(!_0x4f0496)return[];if(Array['isArray'](_0x4f0496))return _0x4f0496;if(typeof _0x4f0496==='string')try{const _0x5ad65a=JSON['parse'](_0x4f0496);return Array[_0x127a99(0x138)](_0x5ad65a)?_0x5ad65a:[];}catch{return[];}return[];}async[a85_0x168d1c(0x14d)](_0x7a623c){const _0x43006f=a85_0x168d1c,_0x1d43e9=await database_1[_0x43006f(0x134)]['shop']['findUnique']({'where':{'id':_0x7a623c},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x1d43e9)throw new Error(_0x43006f(0x168));let _0x449d8d=_0x1d43e9['settings'];return!_0x449d8d&&(_0x449d8d=await database_1[_0x43006f(0x134)][_0x43006f(0x163)][_0x43006f(0x172)]({'data':{'shopId':_0x1d43e9['id']}})),{'fullName':_0x1d43e9[_0x43006f(0x179)],'brand':_0x1d43e9[_0x43006f(0x179)],'merchantUrl':_0x1d43e9[_0x43006f(0x130)],'telegramUsername':_0x1d43e9[_0x43006f(0x161)],'telegramBotApiKey':_0x449d8d[_0x43006f(0x156)]?this['maskApiKey'](_0x449d8d['telegramBotApiKey']):null,'telegramChatId':_0x449d8d[_0x43006f(0x143)],'telegramUsersCount':_0x1d43e9[_0x43006f(0x13d)][_0x43006f(0x13f)],'webhookUrl':_0x449d8d['webhookUrl'],'webhookEvents':this[_0x43006f(0x165)](_0x449d8d[_0x43006f(0x153)]),'twoFactorEnabled':_0x1d43e9[_0x43006f(0x160)]||![],'notifications':{'payment_success':_0x449d8d['notificationPaymentSuccess'],'payment_failed':_0x449d8d[_0x43006f(0x14e)],'refund':_0x449d8d[_0x43006f(0x17e)],'payout':_0x449d8d[_0x43006f(0x171)],'login':_0x449d8d[_0x43006f(0x132)],'api_error':_0x449d8d['notificationApiError']}};}async[a85_0x168d1c(0x174)](_0x2743ee,_0x287d81){const _0x5461c6=a85_0x168d1c,{currentPassword:_0xa78974,newPassword:_0x308805,confirmNewPassword:_0xb61130,twoFactorToken:_0x3322d5}=_0x287d81;if(_0x308805!==_0xb61130)throw new Error(_0x5461c6(0x137));if(_0x308805['length']<0x6)throw new Error(_0x5461c6(0x131));const _0x5b7690=await database_1[_0x5461c6(0x134)][_0x5461c6(0x141)][_0x5461c6(0x140)]({'where':{'id':_0x2743ee},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x5b7690)throw new Error(_0x5461c6(0x168));if(_0x5b7690['twoFactorEnabled']){if(!_0x3322d5)throw new Error(_0x5461c6(0x180));const _0x1fddd3=speakeasy_1[_0x5461c6(0x134)][_0x5461c6(0x175)][_0x5461c6(0x144)]({'secret':_0x5b7690[_0x5461c6(0x15a)],'encoding':_0x5461c6(0x15e),'token':_0x3322d5,'window':0x2});if(!_0x1fddd3){let _0x4726ca=![];if(_0x5b7690[_0x5461c6(0x139)]){const _0x2a69af=JSON[_0x5461c6(0x17d)](_0x5b7690[_0x5461c6(0x139)]);for(let _0x5cc6e9=0x0;_0x5cc6e9<_0x2a69af[_0x5461c6(0x17b)];_0x5cc6e9++){const _0x22a84a=await bcryptjs_1['default'][_0x5461c6(0x145)](_0x3322d5,_0x2a69af[_0x5cc6e9]);if(_0x22a84a){_0x4726ca=!![],_0x2a69af[_0x5461c6(0x16d)](_0x5cc6e9,0x1),await database_1['default'][_0x5461c6(0x141)][_0x5461c6(0x17f)]({'where':{'id':_0x2743ee},'data':{'backupCodes':JSON['stringify'](_0x2a69af)}});break;}}}if(!_0x4726ca)throw new Error(_0x5461c6(0x155));}}const _0x17f53a=await bcryptjs_1[_0x5461c6(0x134)][_0x5461c6(0x145)](_0xa78974,_0x5b7690[_0x5461c6(0x178)]);if(!_0x17f53a)throw new Error(_0x5461c6(0x157));const _0x27c116=await bcryptjs_1['default'][_0x5461c6(0x142)](_0x308805,0xc);await database_1['default'][_0x5461c6(0x141)][_0x5461c6(0x17f)]({'where':{'id':_0x2743ee},'data':{'password':_0x27c116}});}async['updateNotifications'](_0x42f919,_0x273b41){const _0x23d80a=a85_0x168d1c;await this['ensureSettingsExist'](_0x42f919);const _0x37a1dd={};_0x273b41['payment_success']!==undefined&&(_0x37a1dd[_0x23d80a(0x183)]=_0x273b41['payment_success']),_0x273b41['payment_failed']!==undefined&&(_0x37a1dd['notificationPaymentFailed']=_0x273b41[_0x23d80a(0x173)]),_0x273b41[_0x23d80a(0x17c)]!==undefined&&(_0x37a1dd[_0x23d80a(0x17e)]=_0x273b41[_0x23d80a(0x17c)]),_0x273b41[_0x23d80a(0x13a)]!==undefined&&(_0x37a1dd['notificationPayout']=_0x273b41['payout']),_0x273b41[_0x23d80a(0x151)]!==undefined&&(_0x37a1dd[_0x23d80a(0x132)]=_0x273b41[_0x23d80a(0x151)]),_0x273b41[_0x23d80a(0x182)]!==undefined&&(_0x37a1dd['notificationApiError']=_0x273b41[_0x23d80a(0x182)]),await database_1[_0x23d80a(0x134)]['shopSettings'][_0x23d80a(0x17f)]({'where':{'shopId':_0x42f919},'data':_0x37a1dd});}async[a85_0x168d1c(0x12f)](_0x179e97,_0x42ea6c){const _0x1546d7=a85_0x168d1c;await this[_0x1546d7(0x14a)](_0x179e97);const _0x307304={};_0x42ea6c[_0x1546d7(0x17a)]!==undefined&&(_0x307304[_0x1546d7(0x156)]=_0x42ea6c[_0x1546d7(0x17a)]||null),_0x42ea6c[_0x1546d7(0x170)]!==undefined&&(_0x307304[_0x1546d7(0x143)]=_0x42ea6c[_0x1546d7(0x170)]||null),await database_1[_0x1546d7(0x134)][_0x1546d7(0x163)][_0x1546d7(0x17f)]({'where':{'shopId':_0x179e97},'data':_0x307304});}async[a85_0x168d1c(0x13c)](_0xcab569,_0x424705){const _0x1c3b71=a85_0x168d1c;await this[_0x1c3b71(0x14a)](_0xcab569);const _0x22dae5={};_0x424705['webhookUrl']!==undefined&&(_0x22dae5['webhookUrl']=_0x424705[_0x1c3b71(0x13b)]||null),_0x424705[_0x1c3b71(0x153)]!==undefined&&(_0x22dae5[_0x1c3b71(0x153)]=_0x424705[_0x1c3b71(0x153)]||[]),await database_1[_0x1c3b71(0x134)][_0x1c3b71(0x163)][_0x1c3b71(0x17f)]({'where':{'shopId':_0xcab569},'data':_0x22dae5});}async['revokeAllApiKeys'](_0x1697b,_0x5cbda7){const _0xa42223=a85_0x168d1c,_0x297510=await database_1['default'][_0xa42223(0x141)][_0xa42223(0x140)]({'where':{'id':_0x1697b},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x297510)throw new Error('Shop\x20not\x20found');if(_0x297510[_0xa42223(0x160)]){if(!_0x5cbda7)throw new Error(_0xa42223(0x180));const _0x49d8da=speakeasy_1[_0xa42223(0x134)][_0xa42223(0x175)][_0xa42223(0x144)]({'secret':_0x297510[_0xa42223(0x15a)],'encoding':_0xa42223(0x15e),'token':_0x5cbda7,'window':0x2});if(!_0x49d8da){let _0x2947a1=![];if(_0x297510['backupCodes']){const _0x609d5=JSON[_0xa42223(0x17d)](_0x297510[_0xa42223(0x139)]);for(let _0x30fa33=0x0;_0x30fa33<_0x609d5[_0xa42223(0x17b)];_0x30fa33++){const _0x583ed8=await bcryptjs_1[_0xa42223(0x134)]['compare'](_0x5cbda7,_0x609d5[_0x30fa33]);if(_0x583ed8){_0x2947a1=!![],_0x609d5['splice'](_0x30fa33,0x1),await database_1[_0xa42223(0x134)]['shop']['update']({'where':{'id':_0x1697b},'data':{'backupCodes':JSON['stringify'](_0x609d5)}});break;}}}if(!_0x2947a1)throw new Error(_0xa42223(0x155));}}const _0x55010c='pk_'+crypto_1[_0xa42223(0x134)][_0xa42223(0x150)](0x20)[_0xa42223(0x185)](_0xa42223(0x16a)),_0x36e040=_0xa42223(0x16e)+crypto_1[_0xa42223(0x134)]['randomBytes'](0x20)['toString'](_0xa42223(0x16a));await database_1[_0xa42223(0x134)][_0xa42223(0x141)]['update']({'where':{'id':_0x1697b},'data':{'publicKey':_0x55010c,'secretKey':_0x36e040}});}async['deleteAccount'](_0x11eb88,_0x2df045){const _0xac344f=a85_0x168d1c,{passwordConfirmation:_0x2c9290}=_0x2df045,_0x3f37f7=await database_1[_0xac344f(0x134)][_0xac344f(0x141)][_0xac344f(0x140)]({'where':{'id':_0x11eb88},'select':{'password':!![]}});if(!_0x3f37f7)throw new Error(_0xac344f(0x168));const _0x3ffd45=await bcryptjs_1['default'][_0xac344f(0x145)](_0x2c9290,_0x3f37f7[_0xac344f(0x178)]);if(!_0x3ffd45)throw new Error(_0xac344f(0x15b));await database_1[_0xac344f(0x134)][_0xac344f(0x141)][_0xac344f(0x166)]({'where':{'id':_0x11eb88}});}async[a85_0x168d1c(0x184)](_0x4c01bc){const _0xb4fe69=a85_0x168d1c,_0x542155=await database_1[_0xb4fe69(0x134)][_0xb4fe69(0x181)][_0xb4fe69(0x14f)]({'where':{'shopId':_0x4c01bc,'isVerified':!![]},'orderBy':{'createdAt':_0xb4fe69(0x162)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x542155;}async[a85_0x168d1c(0x14c)](_0x3b7c1a,_0x5d6346){const _0x933550=a85_0x168d1c,_0x5995b9=await database_1[_0x933550(0x134)][_0x933550(0x181)][_0x933550(0x140)]({'where':{'id':_0x5d6346},'select':{'shopId':!![]}});if(!_0x5995b9)throw new Error(_0x933550(0x16c));if(_0x5995b9[_0x933550(0x136)]!==_0x3b7c1a)throw new Error(_0x933550(0x152));await database_1[_0x933550(0x134)]['telegramUser'][_0x933550(0x17f)]({'where':{'id':_0x5d6346},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x168d1c(0x14a)](_0x490d7b){const _0x410ce6=a85_0x168d1c,_0x3e6858=await database_1['default'][_0x410ce6(0x163)][_0x410ce6(0x140)]({'where':{'shopId':_0x490d7b}});!_0x3e6858&&await database_1[_0x410ce6(0x134)][_0x410ce6(0x163)]['create']({'data':{'shopId':_0x490d7b}});}}function a85_0x55fa(){const _0x4492d1=['40vaIlJF','chatId','notificationPayout','create','payment_failed','changePassword','totp','10tnaetm','__importDefault','password','name','botApiKey','length','refund','parse','notificationRefund','update','2FA\x20token\x20is\x20required','telegramUser','api_error','notificationPaymentSuccess','getTelegramSessions','toString','updateTelegramSettings','shopUrl','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','notificationLogin','SettingsService','default','4288691CoUcXD','shopId','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','isArray','backupCodes','payout','webhookUrl','updateWebhookSettings','_count','5436cvjyav','telegramUsers','findUnique','shop','hash','telegramChatId','verify','compare','__esModule','31731768KszVNH','../config/database','5945569JRnSTo','ensureSettingsExist','5nELhDu','disconnectTelegramSession','getShopSettings','notificationPaymentFailed','findMany','randomBytes','login','Unauthorized\x20to\x20disconnect\x20this\x20session','webhookEvents','defineProperty','Invalid\x202FA\x20token\x20or\x20backup\x20code','telegramBotApiKey','Current\x20password\x20is\x20incorrect','3582798jWKANq','1670535gLLHKn','twoFactorSecret','Password\x20confirmation\x20is\x20incorrect','repeat','1768MKObkQ','base32','maskApiKey','twoFactorEnabled','telegram','desc','shopSettings','77362yhxIlZ','parseWebhookEvents','delete','bcryptjs','Shop\x20not\x20found','2wWcfOF','hex','max','Telegram\x20session\x20not\x20found','splice','sk_'];a85_0x55fa=function(){return _0x4492d1;};return a85_0x55fa();}exports[a85_0x168d1c(0x133)]=SettingsService;