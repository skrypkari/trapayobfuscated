'use strict';const a85_0x1b5373=a85_0x3dc8;function a85_0x1a44(){const _0x2dcbaf=['Telegram\x20session\x20not\x20found','pk_','string','toString','Shop\x20not\x20found','getTelegramSessions','../config/database','maskApiKey','notificationPaymentSuccess','refund','telegramBotApiKey','shop','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','telegramUsers','twoFactorEnabled','compare','16cWTDqW','speakeasy','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','splice','bcryptjs','twoFactorSecret','default','updateTelegramSettings','hex','isArray','chatId','webhookUrl','substring','length','ensureSettingsExist','notificationLogin','max','updateNotifications','backupCodes','defineProperty','25914VVvrcU','create','19578303rzjRan','desc','10CQzOWN','botApiKey','2576220yMTZUx','payment_success','193004nlFGnR','name','notificationRefund','updateWebhookSettings','parseWebhookEvents','login','parse','deleteAccount','settings','payment_failed','verify','shopSettings','stringify','1631360YMMtDe','shopId','shopUrl','telegramUser','repeat','sk_','92PRNfqc','password','update','Invalid\x202FA\x20token\x20or\x20backup\x20code','payout','webhookEvents','crypto','2FA\x20token\x20is\x20required','findUnique','base32','notificationPayout','notificationPaymentFailed','randomBytes','hash','api_error','1293846fyhcEn','__importDefault','SettingsService','telegram','Current\x20password\x20is\x20incorrect','telegramChatId','_count','1353877NJjsPm'];a85_0x1a44=function(){return _0x2dcbaf;};return a85_0x1a44();}(function(_0x10d425,_0x20864f){const _0x55628a=a85_0x3dc8,_0x18a586=_0x10d425();while(!![]){try{const _0x4b9744=parseInt(_0x55628a(0x1b6))/0x1+-parseInt(_0x55628a(0x1d8))/0x2+-parseInt(_0x55628a(0x1ae))/0x3*(parseInt(_0x55628a(0x1c9))/0x4)+-parseInt(_0x55628a(0x1c3))/0x5+-parseInt(_0x55628a(0x1b4))/0x6+parseInt(_0x55628a(0x1df))/0x7*(-parseInt(_0x55628a(0x1f0))/0x8)+-parseInt(_0x55628a(0x1b0))/0x9*(-parseInt(_0x55628a(0x1b2))/0xa);if(_0x4b9744===_0x20864f)break;else _0x18a586['push'](_0x18a586['shift']());}catch(_0x207e47){_0x18a586['push'](_0x18a586['shift']());}}}(a85_0x1a44,0x5cd96));var __importDefault=this&&this[a85_0x1b5373(0x1d9)]||function(_0x33f844){return _0x33f844&&_0x33f844['__esModule']?_0x33f844:{'default':_0x33f844};};Object[a85_0x1b5373(0x1ad)](exports,'__esModule',{'value':!![]}),exports[a85_0x1b5373(0x1da)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x1b5373(0x19e))),crypto_1=__importDefault(require(a85_0x1b5373(0x1cf))),speakeasy_1=__importDefault(require(a85_0x1b5373(0x1f1))),database_1=__importDefault(require(a85_0x1b5373(0x1e6)));function a85_0x3dc8(_0x2f87ff,_0x595711){_0x2f87ff=_0x2f87ff-0x19d;const _0x1a445c=a85_0x1a44();let _0x3dc857=_0x1a445c[_0x2f87ff];return _0x3dc857;}class SettingsService{[a85_0x1b5373(0x1e7)](_0x242a02){const _0x2e2b89=a85_0x1b5373;if(!_0x242a02)return'';if(_0x242a02[_0x2e2b89(0x1a7)]<=0x8)return _0x242a02;const _0x79bc31=_0x242a02[_0x2e2b89(0x1a6)](0x0,0x8),_0x3e1904='*'[_0x2e2b89(0x1c7)](Math[_0x2e2b89(0x1aa)](0x0,_0x242a02[_0x2e2b89(0x1a7)]-0x8));return _0x79bc31+_0x3e1904;}['parseWebhookEvents'](_0x53282f){const _0x368b2f=a85_0x1b5373;if(!_0x53282f)return[];if(Array['isArray'](_0x53282f))return _0x53282f;if(typeof _0x53282f===_0x368b2f(0x1e2))try{const _0x23444c=JSON[_0x368b2f(0x1bc)](_0x53282f);return Array[_0x368b2f(0x1a3)](_0x23444c)?_0x23444c:[];}catch{return[];}return[];}async['getShopSettings'](_0x265ffb){const _0x2a1d9e=a85_0x1b5373,_0x4e4506=await database_1[_0x2a1d9e(0x1a0)][_0x2a1d9e(0x1eb)][_0x2a1d9e(0x1d1)]({'where':{'id':_0x265ffb},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x4e4506)throw new Error(_0x2a1d9e(0x1e4));let _0x35d996=_0x4e4506[_0x2a1d9e(0x1be)];return!_0x35d996&&(_0x35d996=await database_1[_0x2a1d9e(0x1a0)][_0x2a1d9e(0x1c1)][_0x2a1d9e(0x1af)]({'data':{'shopId':_0x4e4506['id']}})),{'fullName':_0x4e4506[_0x2a1d9e(0x1b7)],'brand':_0x4e4506[_0x2a1d9e(0x1b7)],'merchantUrl':_0x4e4506[_0x2a1d9e(0x1c5)],'telegramUsername':_0x4e4506[_0x2a1d9e(0x1db)],'telegramBotApiKey':_0x35d996[_0x2a1d9e(0x1ea)]?this[_0x2a1d9e(0x1e7)](_0x35d996[_0x2a1d9e(0x1ea)]):null,'telegramChatId':_0x35d996[_0x2a1d9e(0x1dd)],'telegramUsersCount':_0x4e4506[_0x2a1d9e(0x1de)][_0x2a1d9e(0x1ed)],'webhookUrl':_0x35d996['webhookUrl'],'webhookEvents':this[_0x2a1d9e(0x1ba)](_0x35d996[_0x2a1d9e(0x1ce)]),'twoFactorEnabled':_0x4e4506[_0x2a1d9e(0x1ee)]||![],'notifications':{'payment_success':_0x35d996[_0x2a1d9e(0x1e8)],'payment_failed':_0x35d996[_0x2a1d9e(0x1d4)],'refund':_0x35d996[_0x2a1d9e(0x1b8)],'payout':_0x35d996[_0x2a1d9e(0x1d3)],'login':_0x35d996[_0x2a1d9e(0x1a9)],'api_error':_0x35d996['notificationApiError']}};}async['changePassword'](_0x562551,_0xe27c69){const _0x375dcc=a85_0x1b5373,{currentPassword:_0x391059,newPassword:_0x2fce25,confirmNewPassword:_0x4d5fbc,twoFactorToken:_0x1751ad}=_0xe27c69;if(_0x2fce25!==_0x4d5fbc)throw new Error(_0x375dcc(0x1f2));if(_0x2fce25[_0x375dcc(0x1a7)]<0x6)throw new Error(_0x375dcc(0x1ec));const _0xa2686e=await database_1['default']['shop'][_0x375dcc(0x1d1)]({'where':{'id':_0x562551},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0xa2686e)throw new Error(_0x375dcc(0x1e4));if(_0xa2686e[_0x375dcc(0x1ee)]){if(!_0x1751ad)throw new Error('2FA\x20token\x20is\x20required');const _0x52d27a=speakeasy_1[_0x375dcc(0x1a0)]['totp']['verify']({'secret':_0xa2686e[_0x375dcc(0x19f)],'encoding':_0x375dcc(0x1d2),'token':_0x1751ad,'window':0x2});if(!_0x52d27a){let _0x30ced5=![];if(_0xa2686e[_0x375dcc(0x1ac)]){const _0x3b861a=JSON[_0x375dcc(0x1bc)](_0xa2686e[_0x375dcc(0x1ac)]);for(let _0x428e20=0x0;_0x428e20<_0x3b861a[_0x375dcc(0x1a7)];_0x428e20++){const _0x26110a=await bcryptjs_1[_0x375dcc(0x1a0)][_0x375dcc(0x1ef)](_0x1751ad,_0x3b861a[_0x428e20]);if(_0x26110a){_0x30ced5=!![],_0x3b861a[_0x375dcc(0x19d)](_0x428e20,0x1),await database_1[_0x375dcc(0x1a0)]['shop'][_0x375dcc(0x1cb)]({'where':{'id':_0x562551},'data':{'backupCodes':JSON['stringify'](_0x3b861a)}});break;}}}if(!_0x30ced5)throw new Error(_0x375dcc(0x1cc));}}const _0x557565=await bcryptjs_1[_0x375dcc(0x1a0)][_0x375dcc(0x1ef)](_0x391059,_0xa2686e[_0x375dcc(0x1ca)]);if(!_0x557565)throw new Error(_0x375dcc(0x1dc));const _0x31c83b=await bcryptjs_1[_0x375dcc(0x1a0)][_0x375dcc(0x1d6)](_0x2fce25,0xc);await database_1[_0x375dcc(0x1a0)][_0x375dcc(0x1eb)][_0x375dcc(0x1cb)]({'where':{'id':_0x562551},'data':{'password':_0x31c83b}});}async[a85_0x1b5373(0x1ab)](_0x3046e8,_0x211ba0){const _0x3baf06=a85_0x1b5373;await this['ensureSettingsExist'](_0x3046e8);const _0x4c9a12={};_0x211ba0[_0x3baf06(0x1b5)]!==undefined&&(_0x4c9a12['notificationPaymentSuccess']=_0x211ba0[_0x3baf06(0x1b5)]),_0x211ba0['payment_failed']!==undefined&&(_0x4c9a12[_0x3baf06(0x1d4)]=_0x211ba0[_0x3baf06(0x1bf)]),_0x211ba0['refund']!==undefined&&(_0x4c9a12[_0x3baf06(0x1b8)]=_0x211ba0[_0x3baf06(0x1e9)]),_0x211ba0[_0x3baf06(0x1cd)]!==undefined&&(_0x4c9a12[_0x3baf06(0x1d3)]=_0x211ba0[_0x3baf06(0x1cd)]),_0x211ba0[_0x3baf06(0x1bb)]!==undefined&&(_0x4c9a12['notificationLogin']=_0x211ba0['login']),_0x211ba0[_0x3baf06(0x1d7)]!==undefined&&(_0x4c9a12['notificationApiError']=_0x211ba0[_0x3baf06(0x1d7)]),await database_1[_0x3baf06(0x1a0)][_0x3baf06(0x1c1)]['update']({'where':{'shopId':_0x3046e8},'data':_0x4c9a12});}async[a85_0x1b5373(0x1a1)](_0x4f0085,_0x5ea97f){const _0x51537d=a85_0x1b5373;await this[_0x51537d(0x1a8)](_0x4f0085);const _0x48a65e={};_0x5ea97f[_0x51537d(0x1b3)]!==undefined&&(_0x48a65e['telegramBotApiKey']=_0x5ea97f[_0x51537d(0x1b3)]||null),_0x5ea97f[_0x51537d(0x1a4)]!==undefined&&(_0x48a65e[_0x51537d(0x1dd)]=_0x5ea97f[_0x51537d(0x1a4)]||null),await database_1['default']['shopSettings'][_0x51537d(0x1cb)]({'where':{'shopId':_0x4f0085},'data':_0x48a65e});}async[a85_0x1b5373(0x1b9)](_0xe88082,_0x1c5b70){const _0x280887=a85_0x1b5373;await this[_0x280887(0x1a8)](_0xe88082);const _0x365a15={};_0x1c5b70[_0x280887(0x1a5)]!==undefined&&(_0x365a15['webhookUrl']=_0x1c5b70['webhookUrl']||null),_0x1c5b70['webhookEvents']!==undefined&&(_0x365a15['webhookEvents']=_0x1c5b70[_0x280887(0x1ce)]||[]),await database_1['default']['shopSettings'][_0x280887(0x1cb)]({'where':{'shopId':_0xe88082},'data':_0x365a15});}async['revokeAllApiKeys'](_0x6818c6,_0x45d89c){const _0x5ca751=a85_0x1b5373,_0x3fbbdb=await database_1['default'][_0x5ca751(0x1eb)]['findUnique']({'where':{'id':_0x6818c6},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x3fbbdb)throw new Error(_0x5ca751(0x1e4));if(_0x3fbbdb[_0x5ca751(0x1ee)]){if(!_0x45d89c)throw new Error(_0x5ca751(0x1d0));const _0x42b1b5=speakeasy_1['default']['totp'][_0x5ca751(0x1c0)]({'secret':_0x3fbbdb[_0x5ca751(0x19f)],'encoding':'base32','token':_0x45d89c,'window':0x2});if(!_0x42b1b5){let _0x4dafb8=![];if(_0x3fbbdb[_0x5ca751(0x1ac)]){const _0x512e31=JSON[_0x5ca751(0x1bc)](_0x3fbbdb[_0x5ca751(0x1ac)]);for(let _0x195a4e=0x0;_0x195a4e<_0x512e31[_0x5ca751(0x1a7)];_0x195a4e++){const _0x41b9b4=await bcryptjs_1[_0x5ca751(0x1a0)][_0x5ca751(0x1ef)](_0x45d89c,_0x512e31[_0x195a4e]);if(_0x41b9b4){_0x4dafb8=!![],_0x512e31[_0x5ca751(0x19d)](_0x195a4e,0x1),await database_1[_0x5ca751(0x1a0)][_0x5ca751(0x1eb)][_0x5ca751(0x1cb)]({'where':{'id':_0x6818c6},'data':{'backupCodes':JSON[_0x5ca751(0x1c2)](_0x512e31)}});break;}}}if(!_0x4dafb8)throw new Error(_0x5ca751(0x1cc));}}const _0x5e244d=_0x5ca751(0x1e1)+crypto_1[_0x5ca751(0x1a0)][_0x5ca751(0x1d5)](0x20)[_0x5ca751(0x1e3)](_0x5ca751(0x1a2)),_0x18eb7d=_0x5ca751(0x1c8)+crypto_1['default'][_0x5ca751(0x1d5)](0x20)[_0x5ca751(0x1e3)]('hex');await database_1['default'][_0x5ca751(0x1eb)][_0x5ca751(0x1cb)]({'where':{'id':_0x6818c6},'data':{'publicKey':_0x5e244d,'secretKey':_0x18eb7d}});}async[a85_0x1b5373(0x1bd)](_0x4d09da,_0x79b3a1){const _0x4b1eb2=a85_0x1b5373,{passwordConfirmation:_0x5cca3d}=_0x79b3a1,_0x1a5561=await database_1[_0x4b1eb2(0x1a0)][_0x4b1eb2(0x1eb)][_0x4b1eb2(0x1d1)]({'where':{'id':_0x4d09da},'select':{'password':!![]}});if(!_0x1a5561)throw new Error(_0x4b1eb2(0x1e4));const _0x47944c=await bcryptjs_1[_0x4b1eb2(0x1a0)][_0x4b1eb2(0x1ef)](_0x5cca3d,_0x1a5561['password']);if(!_0x47944c)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x4b1eb2(0x1a0)][_0x4b1eb2(0x1eb)]['delete']({'where':{'id':_0x4d09da}});}async[a85_0x1b5373(0x1e5)](_0x375a47){const _0xb03013=a85_0x1b5373,_0x2448f8=await database_1[_0xb03013(0x1a0)][_0xb03013(0x1c6)]['findMany']({'where':{'shopId':_0x375a47,'isVerified':!![]},'orderBy':{'createdAt':_0xb03013(0x1b1)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x2448f8;}async['disconnectTelegramSession'](_0x336117,_0x317720){const _0xf5ff8f=a85_0x1b5373,_0x125617=await database_1[_0xf5ff8f(0x1a0)]['telegramUser'][_0xf5ff8f(0x1d1)]({'where':{'id':_0x317720},'select':{'shopId':!![]}});if(!_0x125617)throw new Error(_0xf5ff8f(0x1e0));if(_0x125617[_0xf5ff8f(0x1c4)]!==_0x336117)throw new Error('Unauthorized\x20to\x20disconnect\x20this\x20session');await database_1['default'][_0xf5ff8f(0x1c6)][_0xf5ff8f(0x1cb)]({'where':{'id':_0x317720},'data':{'shopId':null,'isVerified':![]}});}async['ensureSettingsExist'](_0x48b489){const _0x3ae0c9=a85_0x1b5373,_0x31f67d=await database_1['default'][_0x3ae0c9(0x1c1)]['findUnique']({'where':{'shopId':_0x48b489}});!_0x31f67d&&await database_1[_0x3ae0c9(0x1a0)][_0x3ae0c9(0x1c1)][_0x3ae0c9(0x1af)]({'data':{'shopId':_0x48b489}});}}exports['SettingsService']=SettingsService;