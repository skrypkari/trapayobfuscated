'use strict';const a57_0x311b28=a57_0x1c05;(function(_0x342fcb,_0x57073d){const _0x5a0573=a57_0x1c05,_0x12278c=_0x342fcb();while(!![]){try{const _0x25b824=-parseInt(_0x5a0573(0xc8))/0x1+-parseInt(_0x5a0573(0xe5))/0x2*(-parseInt(_0x5a0573(0xbd))/0x3)+-parseInt(_0x5a0573(0x100))/0x4+-parseInt(_0x5a0573(0xe2))/0x5+-parseInt(_0x5a0573(0xe7))/0x6*(-parseInt(_0x5a0573(0xde))/0x7)+parseInt(_0x5a0573(0xc4))/0x8*(-parseInt(_0x5a0573(0xf2))/0x9)+parseInt(_0x5a0573(0xd3))/0xa*(parseInt(_0x5a0573(0xe3))/0xb);if(_0x25b824===_0x57073d)break;else _0x12278c['push'](_0x12278c['shift']());}catch(_0x2eb88e){_0x12278c['push'](_0x12278c['shift']());}}}(a57_0x3de9,0xbafdd));function a57_0x1c05(_0x4e02b0,_0x23bcb0){const _0x3de95d=a57_0x3de9();return a57_0x1c05=function(_0x1c05a4,_0x19daf4){_0x1c05a4=_0x1c05a4-0xbd;let _0x248532=_0x3de95d[_0x1c05a4];return _0x248532;},a57_0x1c05(_0x4e02b0,_0x23bcb0);}function a57_0x3de9(){const _0x6f4e8c=['telegram','findUnique','substring','3142452buLckp','180627KKUICm','__esModule','create','hex','refund','../config/database','shop','16GLqdyi','payout','telegramChatId','changePassword','329549dcyyKF','delete','webhookUrl','Shop\x20not\x20found','notificationLogin','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','bcryptjs','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','updateWebhookSettings','botApiKey','notificationRefund','30QwCWFC','deleteAccount','randomBytes','default','payment_failed','defineProperty','repeat','update','updateNotifications','notificationPayout','chatId','7jeLcRG','name','telegramBotApiKey','notificationPaymentSuccess','5482770VzqIaK','1596947yLCxFF','hash','46msojQG','SettingsService','9012162qgMjhf','notificationPaymentFailed','crypto','shopSettings','string','updateTelegramSettings','api_error','ensureSettingsExist','revokeAllApiKeys','compare','webhookEvents','1551294kysNJW','notificationApiError','login','toString','payment_success','Password\x20confirmation\x20is\x20incorrect','maskApiKey','parse','parseWebhookEvents','password','length'];a57_0x3de9=function(){return _0x6f4e8c;};return a57_0x3de9();}var __importDefault=this&&this['__importDefault']||function(_0x51387e){const _0x482570=a57_0x1c05;return _0x51387e&&_0x51387e[_0x482570(0xbe)]?_0x51387e:{'default':_0x51387e};};Object[a57_0x311b28(0xd8)](exports,a57_0x311b28(0xbe),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require(a57_0x311b28(0xce))),crypto_1=__importDefault(require(a57_0x311b28(0xe9))),database_1=__importDefault(require(a57_0x311b28(0xc2)));class SettingsService{[a57_0x311b28(0xf8)](_0x5de2b0){const _0xe624d6=a57_0x311b28;if(!_0x5de2b0)return'';if(_0x5de2b0[_0xe624d6(0xfc)]<=0x8)return _0x5de2b0;const _0x2ab79d=_0x5de2b0[_0xe624d6(0xff)](0x0,0x8),_0x220db0='*'[_0xe624d6(0xd9)](Math['max'](0x0,_0x5de2b0[_0xe624d6(0xfc)]-0x8));return _0x2ab79d+_0x220db0;}[a57_0x311b28(0xfa)](_0x353bf8){const _0x5b243f=a57_0x311b28;if(!_0x353bf8)return[];if(Array['isArray'](_0x353bf8))return _0x353bf8;if(typeof _0x353bf8===_0x5b243f(0xeb))try{const _0x203cc7=JSON[_0x5b243f(0xf9)](_0x353bf8);return Array['isArray'](_0x203cc7)?_0x203cc7:[];}catch{return[];}return[];}async['getShopSettings'](_0x244585){const _0x171f2d=a57_0x311b28,_0x4a7631=await database_1['default']['shop']['findUnique']({'where':{'id':_0x244585},'include':{'settings':!![]}});if(!_0x4a7631)throw new Error(_0x171f2d(0xcb));let _0x582b07=_0x4a7631['settings'];return!_0x582b07&&(_0x582b07=await database_1[_0x171f2d(0xd6)][_0x171f2d(0xea)][_0x171f2d(0xbf)]({'data':{'shopId':_0x4a7631['id']}})),{'fullName':_0x4a7631['name'],'brand':_0x4a7631[_0x171f2d(0xdf)],'merchantUrl':_0x4a7631['shopUrl'],'telegramUsername':_0x4a7631[_0x171f2d(0xfd)],'telegramBotApiKey':_0x582b07[_0x171f2d(0xe0)]?this[_0x171f2d(0xf8)](_0x582b07[_0x171f2d(0xe0)]):null,'telegramChatId':_0x582b07[_0x171f2d(0xc6)],'webhookUrl':_0x582b07[_0x171f2d(0xca)],'webhookEvents':this['parseWebhookEvents'](_0x582b07[_0x171f2d(0xf1)]),'notifications':{'payment_success':_0x582b07['notificationPaymentSuccess'],'payment_failed':_0x582b07[_0x171f2d(0xe8)],'refund':_0x582b07[_0x171f2d(0xd2)],'payout':_0x582b07[_0x171f2d(0xdc)],'login':_0x582b07[_0x171f2d(0xcc)],'api_error':_0x582b07[_0x171f2d(0xf3)]}};}async[a57_0x311b28(0xc7)](_0x49e09b,_0x5832ed){const _0x58ac36=a57_0x311b28,{currentPassword:_0x59c6e6,newPassword:_0x33a255,confirmNewPassword:_0x367707}=_0x5832ed;if(_0x33a255!==_0x367707)throw new Error(_0x58ac36(0xcd));if(_0x33a255[_0x58ac36(0xfc)]<0x6)throw new Error(_0x58ac36(0xcf));const _0x23f613=await database_1[_0x58ac36(0xd6)][_0x58ac36(0xc3)][_0x58ac36(0xfe)]({'where':{'id':_0x49e09b},'select':{'password':!![]}});if(!_0x23f613)throw new Error(_0x58ac36(0xcb));const _0x2082e1=await bcryptjs_1[_0x58ac36(0xd6)][_0x58ac36(0xf0)](_0x59c6e6,_0x23f613['password']);if(!_0x2082e1)throw new Error('Current\x20password\x20is\x20incorrect');const _0x2e4a53=await bcryptjs_1[_0x58ac36(0xd6)][_0x58ac36(0xe4)](_0x33a255,0xc);await database_1['default'][_0x58ac36(0xc3)][_0x58ac36(0xda)]({'where':{'id':_0x49e09b},'data':{'password':_0x2e4a53}});}async[a57_0x311b28(0xdb)](_0x2b5d1c,_0x117cf5){const _0x69710=a57_0x311b28;await this[_0x69710(0xee)](_0x2b5d1c);const _0x42d71d={};_0x117cf5[_0x69710(0xf6)]!==undefined&&(_0x42d71d[_0x69710(0xe1)]=_0x117cf5['payment_success']),_0x117cf5[_0x69710(0xd7)]!==undefined&&(_0x42d71d[_0x69710(0xe8)]=_0x117cf5['payment_failed']),_0x117cf5[_0x69710(0xc1)]!==undefined&&(_0x42d71d['notificationRefund']=_0x117cf5['refund']),_0x117cf5['payout']!==undefined&&(_0x42d71d['notificationPayout']=_0x117cf5[_0x69710(0xc5)]),_0x117cf5['login']!==undefined&&(_0x42d71d[_0x69710(0xcc)]=_0x117cf5[_0x69710(0xf4)]),_0x117cf5['api_error']!==undefined&&(_0x42d71d['notificationApiError']=_0x117cf5[_0x69710(0xed)]),await database_1[_0x69710(0xd6)]['shopSettings'][_0x69710(0xda)]({'where':{'shopId':_0x2b5d1c},'data':_0x42d71d});}async[a57_0x311b28(0xec)](_0x40b734,_0x5a6a9a){const _0x37e1da=a57_0x311b28;await this[_0x37e1da(0xee)](_0x40b734);const _0x19e286={};_0x5a6a9a[_0x37e1da(0xd1)]!==undefined&&(_0x19e286[_0x37e1da(0xe0)]=_0x5a6a9a[_0x37e1da(0xd1)]||null),_0x5a6a9a[_0x37e1da(0xdd)]!==undefined&&(_0x19e286[_0x37e1da(0xc6)]=_0x5a6a9a[_0x37e1da(0xdd)]||null),await database_1[_0x37e1da(0xd6)][_0x37e1da(0xea)][_0x37e1da(0xda)]({'where':{'shopId':_0x40b734},'data':_0x19e286});}async[a57_0x311b28(0xd0)](_0x2564d2,_0x1b9fbd){const _0x3c9d32=a57_0x311b28;await this['ensureSettingsExist'](_0x2564d2);const _0x457f91={};_0x1b9fbd[_0x3c9d32(0xca)]!==undefined&&(_0x457f91['webhookUrl']=_0x1b9fbd[_0x3c9d32(0xca)]||null),_0x1b9fbd[_0x3c9d32(0xf1)]!==undefined&&(_0x457f91[_0x3c9d32(0xf1)]=_0x1b9fbd[_0x3c9d32(0xf1)]||[]),await database_1[_0x3c9d32(0xd6)][_0x3c9d32(0xea)][_0x3c9d32(0xda)]({'where':{'shopId':_0x2564d2},'data':_0x457f91});}async[a57_0x311b28(0xef)](_0x3525c6){const _0x1c567a=a57_0x311b28,_0x5ef49f='pk_'+crypto_1[_0x1c567a(0xd6)][_0x1c567a(0xd5)](0x20)[_0x1c567a(0xf5)](_0x1c567a(0xc0)),_0x38844a='sk_'+crypto_1[_0x1c567a(0xd6)][_0x1c567a(0xd5)](0x20)[_0x1c567a(0xf5)]('hex');await database_1[_0x1c567a(0xd6)][_0x1c567a(0xc3)]['update']({'where':{'id':_0x3525c6},'data':{'publicKey':_0x5ef49f,'secretKey':_0x38844a}});}async[a57_0x311b28(0xd4)](_0x3ffe0f,_0x3dce74){const _0x19063c=a57_0x311b28,{passwordConfirmation:_0x23482a}=_0x3dce74,_0xe4e14d=await database_1[_0x19063c(0xd6)][_0x19063c(0xc3)][_0x19063c(0xfe)]({'where':{'id':_0x3ffe0f},'select':{'password':!![]}});if(!_0xe4e14d)throw new Error('Shop\x20not\x20found');const _0x25e8d4=await bcryptjs_1[_0x19063c(0xd6)]['compare'](_0x23482a,_0xe4e14d[_0x19063c(0xfb)]);if(!_0x25e8d4)throw new Error(_0x19063c(0xf7));await database_1[_0x19063c(0xd6)][_0x19063c(0xc3)][_0x19063c(0xc9)]({'where':{'id':_0x3ffe0f}});}async[a57_0x311b28(0xee)](_0xe66f1b){const _0x21622d=a57_0x311b28,_0x14f235=await database_1[_0x21622d(0xd6)][_0x21622d(0xea)]['findUnique']({'where':{'shopId':_0xe66f1b}});!_0x14f235&&await database_1[_0x21622d(0xd6)]['shopSettings'][_0x21622d(0xbf)]({'data':{'shopId':_0xe66f1b}});}}exports[a57_0x311b28(0xe6)]=SettingsService;