'use strict';const a85_0x448f17=a85_0x240d;(function(_0x2b7aeb,_0x4f2051){const _0x395f56=a85_0x240d,_0x3d5670=_0x2b7aeb();while(!![]){try{const _0x5aa742=-parseInt(_0x395f56(0xb3))/0x1*(parseInt(_0x395f56(0xa8))/0x2)+-parseInt(_0x395f56(0xb7))/0x3+-parseInt(_0x395f56(0xea))/0x4*(parseInt(_0x395f56(0xda))/0x5)+parseInt(_0x395f56(0xe9))/0x6+-parseInt(_0x395f56(0xb6))/0x7*(-parseInt(_0x395f56(0xb1))/0x8)+parseInt(_0x395f56(0xaf))/0x9*(-parseInt(_0x395f56(0xd5))/0xa)+parseInt(_0x395f56(0xc3))/0xb;if(_0x5aa742===_0x4f2051)break;else _0x3d5670['push'](_0x3d5670['shift']());}catch(_0x17e784){_0x3d5670['push'](_0x3d5670['shift']());}}}(a85_0x171a,0xbe884));function a85_0x240d(_0x43e36b,_0x306a80){_0x43e36b=_0x43e36b-0xa1;const _0x171afc=a85_0x171a();let _0x240de4=_0x171afc[_0x43e36b];return _0x240de4;}var __importDefault=this&&this[a85_0x448f17(0xcd)]||function(_0x25e531){const _0x5c48ef=a85_0x448f17;return _0x25e531&&_0x25e531[_0x5c48ef(0xf6)]?_0x25e531:{'default':_0x25e531};};function a85_0x171a(){const _0x455b56=['Unauthorized\x20to\x20disconnect\x20this\x20session','length','Current\x20password\x20is\x20incorrect','hex','11356587mwKflU','findUnique','notificationApiError','parse','twoFactorEnabled','telegramUser','payout','repeat','2FA\x20token\x20is\x20required','backupCodes','__importDefault','notificationRefund','toString','max','Invalid\x202FA\x20token\x20or\x20backup\x20code','isArray','notificationPaymentFailed','parseWebhookEvents','10Blzlle','updateTelegramSettings','shopSettings','login','substring','14090saPLHq','create','verify','randomBytes','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','default','stringify','crypto','updateWebhookSettings','payment_success','shop','defineProperty','telegramUsers','notificationPayout','maskApiKey','7212804YiuDQw','368iEHKfc','changePassword','bcryptjs','Password\x20confirmation\x20is\x20incorrect','telegramBotApiKey','shopUrl','twoFactorSecret','getShopSettings','api_error','telegramChatId','speakeasy','ensureSettingsExist','__esModule','pk_','refund','update','notificationLogin','splice','SettingsService','webhookEvents','chatId','10YbMNQk','compare','password','totp','delete','notificationPaymentSuccess','hash','8183871AfgFtt','updateNotifications','32lbwdFk','webhookUrl','92139vXmRSB','sk_','Telegram\x20session\x20not\x20found','1967945yWYfbZ','2848203ZSEIGI','base32','Shop\x20not\x20found','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','telegram','findMany','desc','payment_failed'];a85_0x171a=function(){return _0x455b56;};return a85_0x171a();}Object[a85_0x448f17(0xe5)](exports,'__esModule',{'value':!![]}),exports[a85_0x448f17(0xa5)]=void 0x0;const bcryptjs_1=__importDefault(require(a85_0x448f17(0xec))),crypto_1=__importDefault(require(a85_0x448f17(0xe1))),speakeasy_1=__importDefault(require(a85_0x448f17(0xf4))),database_1=__importDefault(require('../config/database'));class SettingsService{[a85_0x448f17(0xe8)](_0x327017){const _0x1b42c9=a85_0x448f17;if(!_0x327017)return'';if(_0x327017[_0x1b42c9(0xc0)]<=0x8)return _0x327017;const _0x29ea3e=_0x327017[_0x1b42c9(0xd9)](0x0,0x8),_0x2f3d11='*'[_0x1b42c9(0xca)](Math[_0x1b42c9(0xd0)](0x0,_0x327017['length']-0x8));return _0x29ea3e+_0x2f3d11;}[a85_0x448f17(0xd4)](_0x49c268){const _0x4ead7e=a85_0x448f17;if(!_0x49c268)return[];if(Array[_0x4ead7e(0xd2)](_0x49c268))return _0x49c268;if(typeof _0x49c268==='string')try{const _0xc51a47=JSON[_0x4ead7e(0xc6)](_0x49c268);return Array[_0x4ead7e(0xd2)](_0xc51a47)?_0xc51a47:[];}catch{return[];}return[];}async[a85_0x448f17(0xf1)](_0x16fe17){const _0x4b8785=a85_0x448f17,_0x2c8018=await database_1['default'][_0x4b8785(0xe4)]['findUnique']({'where':{'id':_0x16fe17},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2c8018)throw new Error(_0x4b8785(0xb9));let _0x44d656=_0x2c8018['settings'];return!_0x44d656&&(_0x44d656=await database_1[_0x4b8785(0xdf)][_0x4b8785(0xd7)][_0x4b8785(0xdb)]({'data':{'shopId':_0x2c8018['id']}})),{'fullName':_0x2c8018['name'],'brand':_0x2c8018['name'],'merchantUrl':_0x2c8018[_0x4b8785(0xef)],'telegramUsername':_0x2c8018[_0x4b8785(0xbb)],'telegramBotApiKey':_0x44d656[_0x4b8785(0xee)]?this[_0x4b8785(0xe8)](_0x44d656[_0x4b8785(0xee)]):null,'telegramChatId':_0x44d656[_0x4b8785(0xf3)],'telegramUsersCount':_0x2c8018['_count'][_0x4b8785(0xe6)],'webhookUrl':_0x44d656[_0x4b8785(0xb2)],'webhookEvents':this[_0x4b8785(0xd4)](_0x44d656[_0x4b8785(0xa6)]),'twoFactorEnabled':_0x2c8018[_0x4b8785(0xc7)]||![],'notifications':{'payment_success':_0x44d656[_0x4b8785(0xad)],'payment_failed':_0x44d656[_0x4b8785(0xd3)],'refund':_0x44d656['notificationRefund'],'payout':_0x44d656[_0x4b8785(0xe7)],'login':_0x44d656[_0x4b8785(0xa3)],'api_error':_0x44d656[_0x4b8785(0xc5)]}};}async[a85_0x448f17(0xeb)](_0x1a6bb8,_0x32956f){const _0x43f191=a85_0x448f17,{currentPassword:_0x20bf73,newPassword:_0x4d98e9,confirmNewPassword:_0x4b50a3,twoFactorToken:_0x319e2d}=_0x32956f;if(_0x4d98e9!==_0x4b50a3)throw new Error(_0x43f191(0xba));if(_0x4d98e9['length']<0x6)throw new Error(_0x43f191(0xde));const _0x1ef1d7=await database_1[_0x43f191(0xdf)][_0x43f191(0xe4)][_0x43f191(0xc4)]({'where':{'id':_0x1a6bb8},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x1ef1d7)throw new Error(_0x43f191(0xb9));if(_0x1ef1d7[_0x43f191(0xc7)]){if(!_0x319e2d)throw new Error(_0x43f191(0xcb));const _0x2c0f73=speakeasy_1[_0x43f191(0xdf)][_0x43f191(0xab)]['verify']({'secret':_0x1ef1d7[_0x43f191(0xf0)],'encoding':_0x43f191(0xb8),'token':_0x319e2d,'window':0x2});if(!_0x2c0f73){let _0x7f8b4e=![];if(_0x1ef1d7['backupCodes']){const _0x3ba3b6=JSON[_0x43f191(0xc6)](_0x1ef1d7['backupCodes']);for(let _0x3a4684=0x0;_0x3a4684<_0x3ba3b6[_0x43f191(0xc0)];_0x3a4684++){const _0x1f18e0=await bcryptjs_1[_0x43f191(0xdf)][_0x43f191(0xa9)](_0x319e2d,_0x3ba3b6[_0x3a4684]);if(_0x1f18e0){_0x7f8b4e=!![],_0x3ba3b6[_0x43f191(0xa4)](_0x3a4684,0x1),await database_1[_0x43f191(0xdf)][_0x43f191(0xe4)][_0x43f191(0xa2)]({'where':{'id':_0x1a6bb8},'data':{'backupCodes':JSON['stringify'](_0x3ba3b6)}});break;}}}if(!_0x7f8b4e)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x10fc45=await bcryptjs_1[_0x43f191(0xdf)][_0x43f191(0xa9)](_0x20bf73,_0x1ef1d7[_0x43f191(0xaa)]);if(!_0x10fc45)throw new Error(_0x43f191(0xc1));const _0xf16739=await bcryptjs_1['default'][_0x43f191(0xae)](_0x4d98e9,0xc);await database_1[_0x43f191(0xdf)][_0x43f191(0xe4)][_0x43f191(0xa2)]({'where':{'id':_0x1a6bb8},'data':{'password':_0xf16739}});}async[a85_0x448f17(0xb0)](_0x1b1ae6,_0x506580){const _0x2229ca=a85_0x448f17;await this['ensureSettingsExist'](_0x1b1ae6);const _0x507f5e={};_0x506580[_0x2229ca(0xe3)]!==undefined&&(_0x507f5e[_0x2229ca(0xad)]=_0x506580[_0x2229ca(0xe3)]),_0x506580[_0x2229ca(0xbe)]!==undefined&&(_0x507f5e['notificationPaymentFailed']=_0x506580[_0x2229ca(0xbe)]),_0x506580[_0x2229ca(0xa1)]!==undefined&&(_0x507f5e[_0x2229ca(0xce)]=_0x506580[_0x2229ca(0xa1)]),_0x506580[_0x2229ca(0xc9)]!==undefined&&(_0x507f5e[_0x2229ca(0xe7)]=_0x506580[_0x2229ca(0xc9)]),_0x506580['login']!==undefined&&(_0x507f5e[_0x2229ca(0xa3)]=_0x506580[_0x2229ca(0xd8)]),_0x506580[_0x2229ca(0xf2)]!==undefined&&(_0x507f5e['notificationApiError']=_0x506580['api_error']),await database_1['default'][_0x2229ca(0xd7)]['update']({'where':{'shopId':_0x1b1ae6},'data':_0x507f5e});}async[a85_0x448f17(0xd6)](_0x4622a1,_0x30c99f){const _0x496662=a85_0x448f17;await this[_0x496662(0xf5)](_0x4622a1);const _0xbf1e13={};_0x30c99f['botApiKey']!==undefined&&(_0xbf1e13[_0x496662(0xee)]=_0x30c99f['botApiKey']||null),_0x30c99f[_0x496662(0xa7)]!==undefined&&(_0xbf1e13[_0x496662(0xf3)]=_0x30c99f[_0x496662(0xa7)]||null),await database_1[_0x496662(0xdf)][_0x496662(0xd7)]['update']({'where':{'shopId':_0x4622a1},'data':_0xbf1e13});}async[a85_0x448f17(0xe2)](_0x5036f1,_0x4a321d){const _0x1a7e3d=a85_0x448f17;await this[_0x1a7e3d(0xf5)](_0x5036f1);const _0x485cca={};_0x4a321d['webhookUrl']!==undefined&&(_0x485cca[_0x1a7e3d(0xb2)]=_0x4a321d[_0x1a7e3d(0xb2)]||null),_0x4a321d[_0x1a7e3d(0xa6)]!==undefined&&(_0x485cca[_0x1a7e3d(0xa6)]=_0x4a321d[_0x1a7e3d(0xa6)]||[]),await database_1['default'][_0x1a7e3d(0xd7)]['update']({'where':{'shopId':_0x5036f1},'data':_0x485cca});}async['revokeAllApiKeys'](_0x4ceaaa,_0x322a62){const _0x1ae93f=a85_0x448f17,_0x197c6c=await database_1['default'][_0x1ae93f(0xe4)]['findUnique']({'where':{'id':_0x4ceaaa},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x197c6c)throw new Error(_0x1ae93f(0xb9));if(_0x197c6c[_0x1ae93f(0xc7)]){if(!_0x322a62)throw new Error(_0x1ae93f(0xcb));const _0x4838e0=speakeasy_1[_0x1ae93f(0xdf)]['totp'][_0x1ae93f(0xdc)]({'secret':_0x197c6c['twoFactorSecret'],'encoding':_0x1ae93f(0xb8),'token':_0x322a62,'window':0x2});if(!_0x4838e0){let _0x1753e4=![];if(_0x197c6c['backupCodes']){const _0x47657d=JSON[_0x1ae93f(0xc6)](_0x197c6c[_0x1ae93f(0xcc)]);for(let _0x441371=0x0;_0x441371<_0x47657d[_0x1ae93f(0xc0)];_0x441371++){const _0x4895f6=await bcryptjs_1[_0x1ae93f(0xdf)][_0x1ae93f(0xa9)](_0x322a62,_0x47657d[_0x441371]);if(_0x4895f6){_0x1753e4=!![],_0x47657d[_0x1ae93f(0xa4)](_0x441371,0x1),await database_1[_0x1ae93f(0xdf)]['shop'][_0x1ae93f(0xa2)]({'where':{'id':_0x4ceaaa},'data':{'backupCodes':JSON[_0x1ae93f(0xe0)](_0x47657d)}});break;}}}if(!_0x1753e4)throw new Error(_0x1ae93f(0xd1));}}const _0x400712=_0x1ae93f(0xf7)+crypto_1[_0x1ae93f(0xdf)][_0x1ae93f(0xdd)](0x20)['toString'](_0x1ae93f(0xc2)),_0x11a6b1=_0x1ae93f(0xb4)+crypto_1[_0x1ae93f(0xdf)][_0x1ae93f(0xdd)](0x20)[_0x1ae93f(0xcf)](_0x1ae93f(0xc2));await database_1[_0x1ae93f(0xdf)][_0x1ae93f(0xe4)][_0x1ae93f(0xa2)]({'where':{'id':_0x4ceaaa},'data':{'publicKey':_0x400712,'secretKey':_0x11a6b1}});}async['deleteAccount'](_0x3930ab,_0x868c66){const _0x118108=a85_0x448f17,{passwordConfirmation:_0x59c306}=_0x868c66,_0x31f1d8=await database_1[_0x118108(0xdf)][_0x118108(0xe4)]['findUnique']({'where':{'id':_0x3930ab},'select':{'password':!![]}});if(!_0x31f1d8)throw new Error('Shop\x20not\x20found');const _0x1f92d1=await bcryptjs_1[_0x118108(0xdf)][_0x118108(0xa9)](_0x59c306,_0x31f1d8[_0x118108(0xaa)]);if(!_0x1f92d1)throw new Error(_0x118108(0xed));await database_1[_0x118108(0xdf)][_0x118108(0xe4)][_0x118108(0xac)]({'where':{'id':_0x3930ab}});}async['getTelegramSessions'](_0x4a2b83){const _0xb8ccd3=a85_0x448f17,_0xfd4327=await database_1[_0xb8ccd3(0xdf)][_0xb8ccd3(0xc8)][_0xb8ccd3(0xbc)]({'where':{'shopId':_0x4a2b83,'isVerified':!![]},'orderBy':{'createdAt':_0xb8ccd3(0xbd)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0xfd4327;}async['disconnectTelegramSession'](_0x443aac,_0x38a7f2){const _0x646493=a85_0x448f17,_0x53ed74=await database_1['default'][_0x646493(0xc8)][_0x646493(0xc4)]({'where':{'id':_0x38a7f2},'select':{'shopId':!![]}});if(!_0x53ed74)throw new Error(_0x646493(0xb5));if(_0x53ed74['shopId']!==_0x443aac)throw new Error(_0x646493(0xbf));await database_1[_0x646493(0xdf)]['telegramUser'][_0x646493(0xa2)]({'where':{'id':_0x38a7f2},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x448f17(0xf5)](_0x505f93){const _0xeeb8c7=a85_0x448f17,_0x4009d0=await database_1[_0xeeb8c7(0xdf)][_0xeeb8c7(0xd7)][_0xeeb8c7(0xc4)]({'where':{'shopId':_0x505f93}});!_0x4009d0&&await database_1[_0xeeb8c7(0xdf)][_0xeeb8c7(0xd7)][_0xeeb8c7(0xdb)]({'data':{'shopId':_0x505f93}});}}exports['SettingsService']=SettingsService;