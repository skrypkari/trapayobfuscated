'use strict';const a85_0x7e215c=a85_0xfccf;(function(_0x4e8841,_0xd17109){const _0x25db40=a85_0xfccf,_0x392928=_0x4e8841();while(!![]){try{const _0x50ea93=-parseInt(_0x25db40(0x1ec))/0x1+-parseInt(_0x25db40(0x1b9))/0x2+-parseInt(_0x25db40(0x1e3))/0x3*(-parseInt(_0x25db40(0x1ca))/0x4)+-parseInt(_0x25db40(0x1eb))/0x5+parseInt(_0x25db40(0x1b0))/0x6+-parseInt(_0x25db40(0x1bb))/0x7*(parseInt(_0x25db40(0x1ae))/0x8)+parseInt(_0x25db40(0x1d0))/0x9;if(_0x50ea93===_0xd17109)break;else _0x392928['push'](_0x392928['shift']());}catch(_0x17a320){_0x392928['push'](_0x392928['shift']());}}}(a85_0x1b1a,0x28b16));var __importDefault=this&&this[a85_0x7e215c(0x1d2)]||function(_0x59599c){const _0x232c50=a85_0x7e215c;return _0x59599c&&_0x59599c[_0x232c50(0x1ab)]?_0x59599c:{'default':_0x59599c};};Object[a85_0x7e215c(0x1a4)](exports,a85_0x7e215c(0x1ab),{'value':!![]}),exports[a85_0x7e215c(0x1dc)]=void 0x0;function a85_0xfccf(_0xc48d05,_0x349258){_0xc48d05=_0xc48d05-0x1a0;const _0x1b1ada=a85_0x1b1a();let _0xfccfbd=_0x1b1ada[_0xc48d05];return _0xfccfbd;}const bcryptjs_1=__importDefault(require(a85_0x7e215c(0x1e2))),crypto_1=__importDefault(require(a85_0x7e215c(0x1c9))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a85_0x7e215c(0x1a2)));function a85_0x1b1a(){const _0x5092b6=['revokeAllApiKeys','disconnectTelegramSession','7538688swbrhx','shopUrl3','__importDefault','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','twoFactorEnabled','notificationPaymentFailed','hex','chatId','password','updateNotifications','payment_failed','settings','SettingsService','hash','shopUrl','Shop\x20not\x20found','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','login','bcryptjs','21XfblHT','name','string','webhookUrl','splice','updateWebhookSettings','telegramUser','compare','1664800eEfTZS','247387xzwZAu','delete','Telegram\x20session\x20not\x20found','shopUrl4','notificationApiError','botApiKey','shopSettings','updateTelegramSettings','2FA\x20token\x20is\x20required','telegramBotApiKey','stringify','maskApiKey','../config/database','desc','defineProperty','api_error','refund','payment_success','Unauthorized\x20to\x20disconnect\x20this\x20session','notificationRefund','parseWebhookEvents','__esModule','base32','telegramUsers','24eyqtWK','randomBytes','1678992mEyhbd','shop','ensureSettingsExist','findUnique','notificationPayout','parse','verify','Invalid\x202FA\x20token\x20or\x20backup\x20code','Password\x20confirmation\x20is\x20incorrect','386734rvLgOM','totp','655032wedOZE','length','isArray','repeat','toString','backupCodes','payout','webhookEvents','pk_','twoFactorSecret','notificationPaymentSuccess','max','notificationLogin','create','crypto','59232pqsTjr','default','telegramChatId','update'];a85_0x1b1a=function(){return _0x5092b6;};return a85_0x1b1a();}class SettingsService{[a85_0x7e215c(0x1a1)](_0x477c26){const _0x1dc863=a85_0x7e215c;if(!_0x477c26)return'';if(_0x477c26[_0x1dc863(0x1bc)]<=0x8)return _0x477c26;const _0x3a8287=_0x477c26['substring'](0x0,0x8),_0x5effc3='*'[_0x1dc863(0x1be)](Math[_0x1dc863(0x1c6)](0x0,_0x477c26['length']-0x8));return _0x3a8287+_0x5effc3;}['parseWebhookEvents'](_0x30e454){const _0x3c4392=a85_0x7e215c;if(!_0x30e454)return[];if(Array['isArray'](_0x30e454))return _0x30e454;if(typeof _0x30e454===_0x3c4392(0x1e5))try{const _0x493d8d=JSON[_0x3c4392(0x1b5)](_0x30e454);return Array[_0x3c4392(0x1bd)](_0x493d8d)?_0x493d8d:[];}catch{return[];}return[];}async['getShopSettings'](_0x142af9){const _0x3d8709=a85_0x7e215c,_0x2e5210=await database_1[_0x3d8709(0x1cb)][_0x3d8709(0x1b1)][_0x3d8709(0x1b3)]({'where':{'id':_0x142af9},'select':{'id':!![],'name':!![],'shopUrl':!![],'shopUrl2':!![],'shopUrl3':!![],'shopUrl4':!![],'telegram':!![],'twoFactorEnabled':!![],'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2e5210)throw new Error('Shop\x20not\x20found');let _0x3d160e=_0x2e5210[_0x3d8709(0x1db)];return!_0x3d160e&&(_0x3d160e=await database_1['default'][_0x3d8709(0x1f2)][_0x3d8709(0x1c8)]({'data':{'shopId':_0x2e5210['id']}})),{'fullName':_0x2e5210[_0x3d8709(0x1e4)],'brand':_0x2e5210['name'],'merchantUrl':_0x2e5210[_0x3d8709(0x1de)],'merchantUrl2':_0x2e5210['shopUrl2'],'merchantUrl3':_0x2e5210[_0x3d8709(0x1d1)],'merchantUrl4':_0x2e5210[_0x3d8709(0x1ef)],'telegramUsername':_0x2e5210['telegram'],'telegramBotApiKey':_0x3d160e[_0x3d8709(0x1f5)]?this[_0x3d8709(0x1a1)](_0x3d160e[_0x3d8709(0x1f5)]):null,'telegramChatId':_0x3d160e[_0x3d8709(0x1cc)],'telegramUsersCount':_0x2e5210['_count'][_0x3d8709(0x1ad)],'webhookUrl':_0x3d160e[_0x3d8709(0x1e6)],'webhookEvents':this[_0x3d8709(0x1aa)](_0x3d160e[_0x3d8709(0x1c2)]),'twoFactorEnabled':_0x2e5210[_0x3d8709(0x1d4)]||![],'notifications':{'payment_success':_0x3d160e['notificationPaymentSuccess'],'payment_failed':_0x3d160e[_0x3d8709(0x1d5)],'refund':_0x3d160e[_0x3d8709(0x1a9)],'payout':_0x3d160e[_0x3d8709(0x1b4)],'login':_0x3d160e[_0x3d8709(0x1c7)],'api_error':_0x3d160e[_0x3d8709(0x1f0)]}};}async['changePassword'](_0x4a9ccd,_0x1f3cfd){const _0x3fc3df=a85_0x7e215c,{currentPassword:_0x524ba3,newPassword:_0xfafe90,confirmNewPassword:_0x3b7a37,twoFactorToken:_0x5eebd4}=_0x1f3cfd;if(_0xfafe90!==_0x3b7a37)throw new Error(_0x3fc3df(0x1e0));if(_0xfafe90[_0x3fc3df(0x1bc)]<0x6)throw new Error(_0x3fc3df(0x1d3));const _0x378777=await database_1[_0x3fc3df(0x1cb)][_0x3fc3df(0x1b1)][_0x3fc3df(0x1b3)]({'where':{'id':_0x4a9ccd},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x378777)throw new Error(_0x3fc3df(0x1df));if(_0x378777[_0x3fc3df(0x1d4)]){if(!_0x5eebd4)throw new Error(_0x3fc3df(0x1f4));const _0x4e5239=speakeasy_1[_0x3fc3df(0x1cb)][_0x3fc3df(0x1ba)][_0x3fc3df(0x1b6)]({'secret':_0x378777['twoFactorSecret'],'encoding':_0x3fc3df(0x1ac),'token':_0x5eebd4,'window':0x2});if(!_0x4e5239){let _0x409a34=![];if(_0x378777[_0x3fc3df(0x1c0)]){const _0xd01869=JSON[_0x3fc3df(0x1b5)](_0x378777[_0x3fc3df(0x1c0)]);for(let _0x590569=0x0;_0x590569<_0xd01869[_0x3fc3df(0x1bc)];_0x590569++){const _0x4746d9=await bcryptjs_1['default'][_0x3fc3df(0x1ea)](_0x5eebd4,_0xd01869[_0x590569]);if(_0x4746d9){_0x409a34=!![],_0xd01869[_0x3fc3df(0x1e7)](_0x590569,0x1),await database_1[_0x3fc3df(0x1cb)][_0x3fc3df(0x1b1)][_0x3fc3df(0x1cd)]({'where':{'id':_0x4a9ccd},'data':{'backupCodes':JSON[_0x3fc3df(0x1a0)](_0xd01869)}});break;}}}if(!_0x409a34)throw new Error(_0x3fc3df(0x1b7));}}const _0x5c4af0=await bcryptjs_1['default'][_0x3fc3df(0x1ea)](_0x524ba3,_0x378777[_0x3fc3df(0x1d8)]);if(!_0x5c4af0)throw new Error('Current\x20password\x20is\x20incorrect');const _0x424568=await bcryptjs_1[_0x3fc3df(0x1cb)][_0x3fc3df(0x1dd)](_0xfafe90,0xc);await database_1[_0x3fc3df(0x1cb)][_0x3fc3df(0x1b1)][_0x3fc3df(0x1cd)]({'where':{'id':_0x4a9ccd},'data':{'password':_0x424568}});}async[a85_0x7e215c(0x1d9)](_0x2c7625,_0x58fe55){const _0x47a3c0=a85_0x7e215c;await this[_0x47a3c0(0x1b2)](_0x2c7625);const _0x15885b={};_0x58fe55[_0x47a3c0(0x1a7)]!==undefined&&(_0x15885b[_0x47a3c0(0x1c5)]=_0x58fe55['payment_success']),_0x58fe55[_0x47a3c0(0x1da)]!==undefined&&(_0x15885b[_0x47a3c0(0x1d5)]=_0x58fe55['payment_failed']),_0x58fe55[_0x47a3c0(0x1a6)]!==undefined&&(_0x15885b[_0x47a3c0(0x1a9)]=_0x58fe55[_0x47a3c0(0x1a6)]),_0x58fe55[_0x47a3c0(0x1c1)]!==undefined&&(_0x15885b[_0x47a3c0(0x1b4)]=_0x58fe55['payout']),_0x58fe55['login']!==undefined&&(_0x15885b[_0x47a3c0(0x1c7)]=_0x58fe55[_0x47a3c0(0x1e1)]),_0x58fe55[_0x47a3c0(0x1a5)]!==undefined&&(_0x15885b[_0x47a3c0(0x1f0)]=_0x58fe55[_0x47a3c0(0x1a5)]),await database_1[_0x47a3c0(0x1cb)]['shopSettings'][_0x47a3c0(0x1cd)]({'where':{'shopId':_0x2c7625},'data':_0x15885b});}async[a85_0x7e215c(0x1f3)](_0xed23bd,_0x1e3a49){const _0xdee64b=a85_0x7e215c;await this[_0xdee64b(0x1b2)](_0xed23bd);const _0x1c0b72={};_0x1e3a49[_0xdee64b(0x1f1)]!==undefined&&(_0x1c0b72[_0xdee64b(0x1f5)]=_0x1e3a49[_0xdee64b(0x1f1)]||null),_0x1e3a49[_0xdee64b(0x1d7)]!==undefined&&(_0x1c0b72[_0xdee64b(0x1cc)]=_0x1e3a49[_0xdee64b(0x1d7)]||null),await database_1['default'][_0xdee64b(0x1f2)][_0xdee64b(0x1cd)]({'where':{'shopId':_0xed23bd},'data':_0x1c0b72});}async[a85_0x7e215c(0x1e8)](_0x45ed49,_0x42c5bf){const _0x1c0df1=a85_0x7e215c;await this[_0x1c0df1(0x1b2)](_0x45ed49);const _0x37915a={};_0x42c5bf[_0x1c0df1(0x1e6)]!==undefined&&(_0x37915a[_0x1c0df1(0x1e6)]=_0x42c5bf[_0x1c0df1(0x1e6)]||null),_0x42c5bf[_0x1c0df1(0x1c2)]!==undefined&&(_0x37915a[_0x1c0df1(0x1c2)]=_0x42c5bf[_0x1c0df1(0x1c2)]||[]),await database_1[_0x1c0df1(0x1cb)][_0x1c0df1(0x1f2)][_0x1c0df1(0x1cd)]({'where':{'shopId':_0x45ed49},'data':_0x37915a});}async[a85_0x7e215c(0x1ce)](_0x5a0e50,_0x19eb1e){const _0x577586=a85_0x7e215c,_0x247d0e=await database_1['default']['shop']['findUnique']({'where':{'id':_0x5a0e50},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x247d0e)throw new Error(_0x577586(0x1df));if(_0x247d0e[_0x577586(0x1d4)]){if(!_0x19eb1e)throw new Error(_0x577586(0x1f4));const _0x33ce42=speakeasy_1['default'][_0x577586(0x1ba)][_0x577586(0x1b6)]({'secret':_0x247d0e[_0x577586(0x1c4)],'encoding':_0x577586(0x1ac),'token':_0x19eb1e,'window':0x2});if(!_0x33ce42){let _0x26ea26=![];if(_0x247d0e[_0x577586(0x1c0)]){const _0x2ba9de=JSON[_0x577586(0x1b5)](_0x247d0e[_0x577586(0x1c0)]);for(let _0x6956c1=0x0;_0x6956c1<_0x2ba9de[_0x577586(0x1bc)];_0x6956c1++){const _0x3f55cb=await bcryptjs_1[_0x577586(0x1cb)][_0x577586(0x1ea)](_0x19eb1e,_0x2ba9de[_0x6956c1]);if(_0x3f55cb){_0x26ea26=!![],_0x2ba9de[_0x577586(0x1e7)](_0x6956c1,0x1),await database_1[_0x577586(0x1cb)][_0x577586(0x1b1)][_0x577586(0x1cd)]({'where':{'id':_0x5a0e50},'data':{'backupCodes':JSON[_0x577586(0x1a0)](_0x2ba9de)}});break;}}}if(!_0x26ea26)throw new Error(_0x577586(0x1b7));}}const _0x215f87=_0x577586(0x1c3)+crypto_1[_0x577586(0x1cb)][_0x577586(0x1af)](0x20)[_0x577586(0x1bf)](_0x577586(0x1d6)),_0x36ffb2='sk_'+crypto_1[_0x577586(0x1cb)][_0x577586(0x1af)](0x20)[_0x577586(0x1bf)](_0x577586(0x1d6));await database_1[_0x577586(0x1cb)][_0x577586(0x1b1)][_0x577586(0x1cd)]({'where':{'id':_0x5a0e50},'data':{'publicKey':_0x215f87,'secretKey':_0x36ffb2}});}async['deleteAccount'](_0x17009d,_0x5d6090){const _0x12e174=a85_0x7e215c,{passwordConfirmation:_0x45df89}=_0x5d6090,_0x43f6a1=await database_1['default'][_0x12e174(0x1b1)][_0x12e174(0x1b3)]({'where':{'id':_0x17009d},'select':{'password':!![]}});if(!_0x43f6a1)throw new Error('Shop\x20not\x20found');const _0x1557d9=await bcryptjs_1[_0x12e174(0x1cb)][_0x12e174(0x1ea)](_0x45df89,_0x43f6a1[_0x12e174(0x1d8)]);if(!_0x1557d9)throw new Error(_0x12e174(0x1b8));await database_1[_0x12e174(0x1cb)][_0x12e174(0x1b1)][_0x12e174(0x1ed)]({'where':{'id':_0x17009d}});}async['getTelegramSessions'](_0x299ffd){const _0x46836e=a85_0x7e215c,_0x518279=await database_1[_0x46836e(0x1cb)][_0x46836e(0x1e9)]['findMany']({'where':{'shopId':_0x299ffd,'isVerified':!![]},'orderBy':{'createdAt':_0x46836e(0x1a3)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x518279;}async[a85_0x7e215c(0x1cf)](_0x3cca49,_0x54d7da){const _0x20bfb3=a85_0x7e215c,_0x586278=await database_1['default'][_0x20bfb3(0x1e9)][_0x20bfb3(0x1b3)]({'where':{'id':_0x54d7da},'select':{'shopId':!![]}});if(!_0x586278)throw new Error(_0x20bfb3(0x1ee));if(_0x586278['shopId']!==_0x3cca49)throw new Error(_0x20bfb3(0x1a8));await database_1[_0x20bfb3(0x1cb)][_0x20bfb3(0x1e9)][_0x20bfb3(0x1cd)]({'where':{'id':_0x54d7da},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x7e215c(0x1b2)](_0x1b3e7e){const _0xe865a4=a85_0x7e215c,_0x47ec01=await database_1['default'][_0xe865a4(0x1f2)][_0xe865a4(0x1b3)]({'where':{'shopId':_0x1b3e7e}});!_0x47ec01&&await database_1[_0xe865a4(0x1cb)][_0xe865a4(0x1f2)][_0xe865a4(0x1c8)]({'data':{'shopId':_0x1b3e7e}});}}exports[a85_0x7e215c(0x1dc)]=SettingsService;