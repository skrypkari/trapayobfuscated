'use strict';const a47_0x2924cc=a47_0x3c6f;function a47_0x1a16(){const _0x448f06=['New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','isArray','../config/database','payment_failed','Password\x20confirmation\x20is\x20incorrect','crypto','repeat','shop','109300jADAdt','updateNotifications','name','shopUrl','Shop\x20not\x20found','toString','botApiKey','120530uiVymv','payout','length','notificationPaymentFailed','update','api_error','substring','maskApiKey','settings','password','updateTelegramSettings','120EfMbDO','3275829KGRvFk','notificationApiError','parseWebhookEvents','findUnique','7FuNsSA','getShopSettings','telegramChatId','randomBytes','login','delete','SettingsService','telegram','parse','4675GIzTGn','create','986821DJGIEX','webhookEvents','refund','webhookUrl','deleteAccount','default','notificationPaymentSuccess','5039052jyuRGc','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','compare','ensureSettingsExist','__importDefault','payment_success','telegramBotApiKey','chatId','16LxKFMd','hex','bcryptjs','revokeAllApiKeys','shopSettings','notificationRefund','3769863obpTEf','sk_','2645496yPJPaf','__esModule','Current\x20password\x20is\x20incorrect','notificationLogin'];a47_0x1a16=function(){return _0x448f06;};return a47_0x1a16();}function a47_0x3c6f(_0x2c1bd0,_0x3b70c1){const _0x1a1626=a47_0x1a16();return a47_0x3c6f=function(_0x3c6f29,_0x272613){_0x3c6f29=_0x3c6f29-0x1d6;let _0xd677de=_0x1a1626[_0x3c6f29];return _0xd677de;},a47_0x3c6f(_0x2c1bd0,_0x3b70c1);}(function(_0x49beba,_0x1e3c81){const _0x8823a=a47_0x3c6f,_0x57597c=_0x49beba();while(!![]){try{const _0xc9e91b=parseInt(_0x8823a(0x1ec))/0x1+parseInt(_0x8823a(0x203))/0x2+parseInt(_0x8823a(0x201))/0x3+parseInt(_0x8823a(0x1dc))/0x4*(parseInt(_0x8823a(0x20f))/0x5)+parseInt(_0x8823a(0x1f3))/0x6*(parseInt(_0x8823a(0x1e1))/0x7)+parseInt(_0x8823a(0x1fb))/0x8*(parseInt(_0x8823a(0x1dd))/0x9)+parseInt(_0x8823a(0x216))/0xa*(-parseInt(_0x8823a(0x1ea))/0xb);if(_0xc9e91b===_0x1e3c81)break;else _0x57597c['push'](_0x57597c['shift']());}catch(_0x376413){_0x57597c['push'](_0x57597c['shift']());}}}(a47_0x1a16,0xa2e85));var __importDefault=this&&this[a47_0x2924cc(0x1f7)]||function(_0x777f0d){const _0x20e90f=a47_0x2924cc;return _0x777f0d&&_0x777f0d[_0x20e90f(0x204)]?_0x777f0d:{'default':_0x777f0d};};Object['defineProperty'](exports,a47_0x2924cc(0x204),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x2924cc(0x1fd))),crypto_1=__importDefault(require(a47_0x2924cc(0x20c))),database_1=__importDefault(require(a47_0x2924cc(0x209)));class SettingsService{['maskApiKey'](_0x537080){const _0x792f90=a47_0x2924cc;if(!_0x537080)return'';if(_0x537080[_0x792f90(0x218)]<=0x8)return _0x537080;const _0x1cf245=_0x537080[_0x792f90(0x1d7)](0x0,0x8),_0x5c22ba='*'[_0x792f90(0x20d)](Math['max'](0x0,_0x537080['length']-0x8));return _0x1cf245+_0x5c22ba;}[a47_0x2924cc(0x1df)](_0x22ca3f){const _0x2b96fb=a47_0x2924cc;if(!_0x22ca3f)return[];if(Array[_0x2b96fb(0x208)](_0x22ca3f))return _0x22ca3f;if(typeof _0x22ca3f==='string')try{const _0x2757d0=JSON[_0x2b96fb(0x1e9)](_0x22ca3f);return Array[_0x2b96fb(0x208)](_0x2757d0)?_0x2757d0:[];}catch{return[];}return[];}async[a47_0x2924cc(0x1e2)](_0x388c70){const _0x4ae568=a47_0x2924cc,_0x4d3e26=await database_1[_0x4ae568(0x1f1)][_0x4ae568(0x20e)][_0x4ae568(0x1e0)]({'where':{'id':_0x388c70},'include':{'settings':!![]}});if(!_0x4d3e26)throw new Error(_0x4ae568(0x213));let _0x223f7e=_0x4d3e26[_0x4ae568(0x1d9)];return!_0x223f7e&&(_0x223f7e=await database_1[_0x4ae568(0x1f1)][_0x4ae568(0x1ff)][_0x4ae568(0x1eb)]({'data':{'shopId':_0x4d3e26['id']}})),{'fullName':_0x4d3e26[_0x4ae568(0x211)],'brand':_0x4d3e26['name'],'merchantUrl':_0x4d3e26[_0x4ae568(0x212)],'telegramUsername':_0x4d3e26[_0x4ae568(0x1e8)],'telegramBotApiKey':_0x223f7e[_0x4ae568(0x1f9)]?this[_0x4ae568(0x1d8)](_0x223f7e[_0x4ae568(0x1f9)]):null,'telegramChatId':_0x223f7e[_0x4ae568(0x1e3)],'webhookUrl':_0x223f7e[_0x4ae568(0x1ef)],'webhookEvents':this[_0x4ae568(0x1df)](_0x223f7e[_0x4ae568(0x1ed)]),'notifications':{'payment_success':_0x223f7e[_0x4ae568(0x1f2)],'payment_failed':_0x223f7e[_0x4ae568(0x219)],'refund':_0x223f7e[_0x4ae568(0x200)],'payout':_0x223f7e['notificationPayout'],'login':_0x223f7e['notificationLogin'],'api_error':_0x223f7e[_0x4ae568(0x1de)]}};}async['changePassword'](_0x540714,_0x5c4819){const _0x488621=a47_0x2924cc,{currentPassword:_0x5f08d1,newPassword:_0x1478c8,confirmNewPassword:_0x277e8f}=_0x5c4819;if(_0x1478c8!==_0x277e8f)throw new Error(_0x488621(0x1f4));if(_0x1478c8[_0x488621(0x218)]<0x6)throw new Error(_0x488621(0x207));const _0x5c61e1=await database_1[_0x488621(0x1f1)]['shop'][_0x488621(0x1e0)]({'where':{'id':_0x540714},'select':{'password':!![]}});if(!_0x5c61e1)throw new Error(_0x488621(0x213));const _0x1810a7=await bcryptjs_1[_0x488621(0x1f1)][_0x488621(0x1f5)](_0x5f08d1,_0x5c61e1[_0x488621(0x1da)]);if(!_0x1810a7)throw new Error(_0x488621(0x205));const _0x520461=await bcryptjs_1['default']['hash'](_0x1478c8,0xc);await database_1['default']['shop'][_0x488621(0x21a)]({'where':{'id':_0x540714},'data':{'password':_0x520461}});}async[a47_0x2924cc(0x210)](_0x35859e,_0x218f49){const _0x87182d=a47_0x2924cc;await this['ensureSettingsExist'](_0x35859e);const _0x4d0287={};_0x218f49[_0x87182d(0x1f8)]!==undefined&&(_0x4d0287['notificationPaymentSuccess']=_0x218f49['payment_success']),_0x218f49[_0x87182d(0x20a)]!==undefined&&(_0x4d0287[_0x87182d(0x219)]=_0x218f49[_0x87182d(0x20a)]),_0x218f49[_0x87182d(0x1ee)]!==undefined&&(_0x4d0287[_0x87182d(0x200)]=_0x218f49[_0x87182d(0x1ee)]),_0x218f49[_0x87182d(0x217)]!==undefined&&(_0x4d0287['notificationPayout']=_0x218f49['payout']),_0x218f49[_0x87182d(0x1e5)]!==undefined&&(_0x4d0287[_0x87182d(0x206)]=_0x218f49[_0x87182d(0x1e5)]),_0x218f49[_0x87182d(0x1d6)]!==undefined&&(_0x4d0287[_0x87182d(0x1de)]=_0x218f49[_0x87182d(0x1d6)]),await database_1[_0x87182d(0x1f1)][_0x87182d(0x1ff)][_0x87182d(0x21a)]({'where':{'shopId':_0x35859e},'data':_0x4d0287});}async[a47_0x2924cc(0x1db)](_0x306d33,_0x1db8d6){const _0xbedf1d=a47_0x2924cc;await this[_0xbedf1d(0x1f6)](_0x306d33);const _0x10967c={};_0x1db8d6['botApiKey']!==undefined&&(_0x10967c[_0xbedf1d(0x1f9)]=_0x1db8d6[_0xbedf1d(0x215)]||null),_0x1db8d6[_0xbedf1d(0x1fa)]!==undefined&&(_0x10967c['telegramChatId']=_0x1db8d6[_0xbedf1d(0x1fa)]||null),await database_1[_0xbedf1d(0x1f1)][_0xbedf1d(0x1ff)][_0xbedf1d(0x21a)]({'where':{'shopId':_0x306d33},'data':_0x10967c});}async['updateWebhookSettings'](_0x5ed487,_0x210c78){const _0x21ba6c=a47_0x2924cc;await this['ensureSettingsExist'](_0x5ed487);const _0x34eedc={};_0x210c78['webhookUrl']!==undefined&&(_0x34eedc[_0x21ba6c(0x1ef)]=_0x210c78[_0x21ba6c(0x1ef)]||null),_0x210c78['webhookEvents']!==undefined&&(_0x34eedc['webhookEvents']=_0x210c78[_0x21ba6c(0x1ed)]||[]),await database_1[_0x21ba6c(0x1f1)][_0x21ba6c(0x1ff)]['update']({'where':{'shopId':_0x5ed487},'data':_0x34eedc});}async[a47_0x2924cc(0x1fe)](_0x25535b){const _0x303fc0=a47_0x2924cc,_0x27e9c8='pk_'+crypto_1[_0x303fc0(0x1f1)]['randomBytes'](0x20)['toString'](_0x303fc0(0x1fc)),_0x376ff5=_0x303fc0(0x202)+crypto_1[_0x303fc0(0x1f1)][_0x303fc0(0x1e4)](0x20)[_0x303fc0(0x214)](_0x303fc0(0x1fc));await database_1[_0x303fc0(0x1f1)]['shop'][_0x303fc0(0x21a)]({'where':{'id':_0x25535b},'data':{'publicKey':_0x27e9c8,'secretKey':_0x376ff5}});}async[a47_0x2924cc(0x1f0)](_0x343084,_0xe8d057){const _0x5405d3=a47_0x2924cc,{passwordConfirmation:_0x4c0600}=_0xe8d057,_0x5ad436=await database_1['default'][_0x5405d3(0x20e)][_0x5405d3(0x1e0)]({'where':{'id':_0x343084},'select':{'password':!![]}});if(!_0x5ad436)throw new Error(_0x5405d3(0x213));const _0x182714=await bcryptjs_1['default'][_0x5405d3(0x1f5)](_0x4c0600,_0x5ad436[_0x5405d3(0x1da)]);if(!_0x182714)throw new Error(_0x5405d3(0x20b));await database_1[_0x5405d3(0x1f1)][_0x5405d3(0x20e)][_0x5405d3(0x1e6)]({'where':{'id':_0x343084}});}async['ensureSettingsExist'](_0xfa7be0){const _0x288446=a47_0x2924cc,_0x4ec4e0=await database_1['default'][_0x288446(0x1ff)][_0x288446(0x1e0)]({'where':{'shopId':_0xfa7be0}});!_0x4ec4e0&&await database_1[_0x288446(0x1f1)][_0x288446(0x1ff)]['create']({'data':{'shopId':_0xfa7be0}});}}exports[a47_0x2924cc(0x1e7)]=SettingsService;