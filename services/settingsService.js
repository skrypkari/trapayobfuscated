'use strict';const a76_0x19eeda=a76_0x405d;(function(_0x3ace7,_0x7fb577){const _0x340fc9=a76_0x405d,_0x57df7b=_0x3ace7();while(!![]){try{const _0x49db97=-parseInt(_0x340fc9(0x148))/0x1+-parseInt(_0x340fc9(0x134))/0x2*(parseInt(_0x340fc9(0x160))/0x3)+parseInt(_0x340fc9(0x157))/0x4*(-parseInt(_0x340fc9(0x121))/0x5)+-parseInt(_0x340fc9(0x154))/0x6+-parseInt(_0x340fc9(0x11e))/0x7*(-parseInt(_0x340fc9(0x13a))/0x8)+parseInt(_0x340fc9(0x12a))/0x9+-parseInt(_0x340fc9(0x11f))/0xa*(-parseInt(_0x340fc9(0x152))/0xb);if(_0x49db97===_0x7fb577)break;else _0x57df7b['push'](_0x57df7b['shift']());}catch(_0x391427){_0x57df7b['push'](_0x57df7b['shift']());}}}(a76_0x37d5,0xc3fd3));var __importDefault=this&&this[a76_0x19eeda(0x144)]||function(_0x1d7f36){const _0x280e29=a76_0x19eeda;return _0x1d7f36&&_0x1d7f36[_0x280e29(0x162)]?_0x1d7f36:{'default':_0x1d7f36};};Object[a76_0x19eeda(0x145)](exports,a76_0x19eeda(0x162),{'value':!![]}),exports['SettingsService']=void 0x0;function a76_0x37d5(){const _0x7a8eb4=['20cAZKqA','webhookEvents','307655ZOxTZl','notificationApiError','length','repeat','getShopSettings','deleteAccount','notificationLogin','Shop\x20not\x20found','name','7859646gkpnGB','botApiKey','telegram','default','parseWebhookEvents','splice','isArray','base32','create','verify','420SYcGxw','totp','findUnique','notificationPayout','hex','compare','32AmsShr','webhookUrl','backupCodes','max','payout','2FA\x20token\x20is\x20required','speakeasy','updateWebhookSettings','update','payment_success','__importDefault','defineProperty','parse','Current\x20password\x20is\x20incorrect','584209WUnbDH','telegramBotApiKey','Invalid\x202FA\x20token\x20or\x20backup\x20code','shopSettings','toString','../config/database','password','notificationPaymentSuccess','notificationRefund','updateTelegramSettings','9584421oYsBBe','login','7349976ZjKsjb','crypto','payment_failed','8jcwKBL','shop','twoFactorSecret','revokeAllApiKeys','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','SettingsService','stringify','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','telegramChatId','15591Jnqxwm','chatId','__esModule','api_error','ensureSettingsExist','hash','twoFactorEnabled','Password\x20confirmation\x20is\x20incorrect','maskApiKey','refund','notificationPaymentFailed','updateNotifications','randomBytes','sk_','2118361EylZBt'];a76_0x37d5=function(){return _0x7a8eb4;};return a76_0x37d5();}function a76_0x405d(_0x54aa7c,_0x3eebd1){_0x54aa7c=_0x54aa7c-0x117;const _0x37d5b9=a76_0x37d5();let _0x405df5=_0x37d5b9[_0x54aa7c];return _0x405df5;}const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a76_0x19eeda(0x155))),speakeasy_1=__importDefault(require(a76_0x19eeda(0x140))),database_1=__importDefault(require(a76_0x19eeda(0x14d)));class SettingsService{[a76_0x19eeda(0x118)](_0x163048){const _0x258c2f=a76_0x19eeda;if(!_0x163048)return'';if(_0x163048[_0x258c2f(0x123)]<=0x8)return _0x163048;const _0x59f8ac=_0x163048['substring'](0x0,0x8),_0x320937='*'[_0x258c2f(0x124)](Math[_0x258c2f(0x13d)](0x0,_0x163048[_0x258c2f(0x123)]-0x8));return _0x59f8ac+_0x320937;}[a76_0x19eeda(0x12e)](_0x475665){const _0x2d2807=a76_0x19eeda;if(!_0x475665)return[];if(Array[_0x2d2807(0x130)](_0x475665))return _0x475665;if(typeof _0x475665==='string')try{const _0x3b3175=JSON[_0x2d2807(0x146)](_0x475665);return Array['isArray'](_0x3b3175)?_0x3b3175:[];}catch{return[];}return[];}async[a76_0x19eeda(0x125)](_0xffe20e){const _0x3529fb=a76_0x19eeda,_0x370d37=await database_1['default']['shop'][_0x3529fb(0x136)]({'where':{'id':_0xffe20e},'include':{'settings':!![]}});if(!_0x370d37)throw new Error(_0x3529fb(0x128));let _0x19c265=_0x370d37['settings'];return!_0x19c265&&(_0x19c265=await database_1[_0x3529fb(0x12d)][_0x3529fb(0x14b)][_0x3529fb(0x132)]({'data':{'shopId':_0x370d37['id']}})),{'fullName':_0x370d37[_0x3529fb(0x129)],'brand':_0x370d37[_0x3529fb(0x129)],'merchantUrl':_0x370d37['shopUrl'],'telegramUsername':_0x370d37[_0x3529fb(0x12c)],'telegramBotApiKey':_0x19c265[_0x3529fb(0x149)]?this['maskApiKey'](_0x19c265[_0x3529fb(0x149)]):null,'telegramChatId':_0x19c265['telegramChatId'],'webhookUrl':_0x19c265[_0x3529fb(0x13b)],'webhookEvents':this[_0x3529fb(0x12e)](_0x19c265[_0x3529fb(0x120)]),'twoFactorEnabled':_0x370d37[_0x3529fb(0x166)]||![],'notifications':{'payment_success':_0x19c265[_0x3529fb(0x14f)],'payment_failed':_0x19c265[_0x3529fb(0x11a)],'refund':_0x19c265[_0x3529fb(0x150)],'payout':_0x19c265[_0x3529fb(0x137)],'login':_0x19c265[_0x3529fb(0x127)],'api_error':_0x19c265[_0x3529fb(0x122)]}};}async['changePassword'](_0x3fc7e5,_0x571e9e){const _0x499cd2=a76_0x19eeda,{currentPassword:_0x1a4eb2,newPassword:_0x5ad0a2,confirmNewPassword:_0x8db24d,twoFactorToken:_0x41ec10}=_0x571e9e;if(_0x5ad0a2!==_0x8db24d)throw new Error(_0x499cd2(0x15b));if(_0x5ad0a2[_0x499cd2(0x123)]<0x6)throw new Error(_0x499cd2(0x15e));const _0x4d10a0=await database_1[_0x499cd2(0x12d)][_0x499cd2(0x158)][_0x499cd2(0x136)]({'where':{'id':_0x3fc7e5},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x4d10a0)throw new Error(_0x499cd2(0x128));if(_0x4d10a0['twoFactorEnabled']){if(!_0x41ec10)throw new Error(_0x499cd2(0x13f));const _0x2702b4=speakeasy_1[_0x499cd2(0x12d)][_0x499cd2(0x135)][_0x499cd2(0x133)]({'secret':_0x4d10a0[_0x499cd2(0x159)],'encoding':_0x499cd2(0x131),'token':_0x41ec10,'window':0x2});if(!_0x2702b4){let _0x395efc=![];if(_0x4d10a0['backupCodes']){const _0x55f29e=JSON[_0x499cd2(0x146)](_0x4d10a0[_0x499cd2(0x13c)]);for(let _0x3cee7b=0x0;_0x3cee7b<_0x55f29e[_0x499cd2(0x123)];_0x3cee7b++){const _0x22c79=await bcryptjs_1[_0x499cd2(0x12d)][_0x499cd2(0x139)](_0x41ec10,_0x55f29e[_0x3cee7b]);if(_0x22c79){_0x395efc=!![],_0x55f29e[_0x499cd2(0x12f)](_0x3cee7b,0x1),await database_1[_0x499cd2(0x12d)][_0x499cd2(0x158)][_0x499cd2(0x142)]({'where':{'id':_0x3fc7e5},'data':{'backupCodes':JSON[_0x499cd2(0x15d)](_0x55f29e)}});break;}}}if(!_0x395efc)throw new Error('Invalid\x202FA\x20token\x20or\x20backup\x20code');}}const _0x573647=await bcryptjs_1['default'][_0x499cd2(0x139)](_0x1a4eb2,_0x4d10a0[_0x499cd2(0x14e)]);if(!_0x573647)throw new Error(_0x499cd2(0x147));const _0x3bed73=await bcryptjs_1[_0x499cd2(0x12d)][_0x499cd2(0x165)](_0x5ad0a2,0xc);await database_1['default'][_0x499cd2(0x158)][_0x499cd2(0x142)]({'where':{'id':_0x3fc7e5},'data':{'password':_0x3bed73}});}async[a76_0x19eeda(0x11b)](_0x1e3000,_0x9bafa){const _0x5a36a8=a76_0x19eeda;await this[_0x5a36a8(0x164)](_0x1e3000);const _0x27b994={};_0x9bafa['payment_success']!==undefined&&(_0x27b994[_0x5a36a8(0x14f)]=_0x9bafa[_0x5a36a8(0x143)]),_0x9bafa[_0x5a36a8(0x156)]!==undefined&&(_0x27b994[_0x5a36a8(0x11a)]=_0x9bafa[_0x5a36a8(0x156)]),_0x9bafa[_0x5a36a8(0x119)]!==undefined&&(_0x27b994[_0x5a36a8(0x150)]=_0x9bafa[_0x5a36a8(0x119)]),_0x9bafa[_0x5a36a8(0x13e)]!==undefined&&(_0x27b994['notificationPayout']=_0x9bafa['payout']),_0x9bafa[_0x5a36a8(0x153)]!==undefined&&(_0x27b994[_0x5a36a8(0x127)]=_0x9bafa[_0x5a36a8(0x153)]),_0x9bafa[_0x5a36a8(0x163)]!==undefined&&(_0x27b994[_0x5a36a8(0x122)]=_0x9bafa[_0x5a36a8(0x163)]),await database_1[_0x5a36a8(0x12d)][_0x5a36a8(0x14b)][_0x5a36a8(0x142)]({'where':{'shopId':_0x1e3000},'data':_0x27b994});}async[a76_0x19eeda(0x151)](_0x18fcce,_0x329e6a){const _0x295561=a76_0x19eeda;await this['ensureSettingsExist'](_0x18fcce);const _0x19e9ac={};_0x329e6a[_0x295561(0x12b)]!==undefined&&(_0x19e9ac['telegramBotApiKey']=_0x329e6a[_0x295561(0x12b)]||null),_0x329e6a[_0x295561(0x161)]!==undefined&&(_0x19e9ac[_0x295561(0x15f)]=_0x329e6a[_0x295561(0x161)]||null),await database_1['default']['shopSettings'][_0x295561(0x142)]({'where':{'shopId':_0x18fcce},'data':_0x19e9ac});}async[a76_0x19eeda(0x141)](_0x30781f,_0x1e51ab){const _0x17e1cd=a76_0x19eeda;await this[_0x17e1cd(0x164)](_0x30781f);const _0xd0ac5c={};_0x1e51ab[_0x17e1cd(0x13b)]!==undefined&&(_0xd0ac5c[_0x17e1cd(0x13b)]=_0x1e51ab[_0x17e1cd(0x13b)]||null),_0x1e51ab[_0x17e1cd(0x120)]!==undefined&&(_0xd0ac5c['webhookEvents']=_0x1e51ab['webhookEvents']||[]),await database_1[_0x17e1cd(0x12d)][_0x17e1cd(0x14b)]['update']({'where':{'shopId':_0x30781f},'data':_0xd0ac5c});}async[a76_0x19eeda(0x15a)](_0x118c66,_0x14ac4f){const _0x309249=a76_0x19eeda,_0x53be3b=await database_1[_0x309249(0x12d)][_0x309249(0x158)][_0x309249(0x136)]({'where':{'id':_0x118c66},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x53be3b)throw new Error(_0x309249(0x128));if(_0x53be3b[_0x309249(0x166)]){if(!_0x14ac4f)throw new Error(_0x309249(0x13f));const _0x408d90=speakeasy_1[_0x309249(0x12d)]['totp']['verify']({'secret':_0x53be3b[_0x309249(0x159)],'encoding':'base32','token':_0x14ac4f,'window':0x2});if(!_0x408d90){let _0x111dfd=![];if(_0x53be3b[_0x309249(0x13c)]){const _0x288e8b=JSON[_0x309249(0x146)](_0x53be3b[_0x309249(0x13c)]);for(let _0x2e1243=0x0;_0x2e1243<_0x288e8b['length'];_0x2e1243++){const _0x4e1d46=await bcryptjs_1[_0x309249(0x12d)][_0x309249(0x139)](_0x14ac4f,_0x288e8b[_0x2e1243]);if(_0x4e1d46){_0x111dfd=!![],_0x288e8b['splice'](_0x2e1243,0x1),await database_1['default'][_0x309249(0x158)][_0x309249(0x142)]({'where':{'id':_0x118c66},'data':{'backupCodes':JSON[_0x309249(0x15d)](_0x288e8b)}});break;}}}if(!_0x111dfd)throw new Error(_0x309249(0x14a));}}const _0xef5100='pk_'+crypto_1[_0x309249(0x12d)][_0x309249(0x11c)](0x20)[_0x309249(0x14c)](_0x309249(0x138)),_0x208195=_0x309249(0x11d)+crypto_1[_0x309249(0x12d)][_0x309249(0x11c)](0x20)[_0x309249(0x14c)]('hex');await database_1[_0x309249(0x12d)]['shop']['update']({'where':{'id':_0x118c66},'data':{'publicKey':_0xef5100,'secretKey':_0x208195}});}async[a76_0x19eeda(0x126)](_0x56576f,_0x3ae846){const _0x4e23c2=a76_0x19eeda,{passwordConfirmation:_0x20989c}=_0x3ae846,_0x13e065=await database_1[_0x4e23c2(0x12d)][_0x4e23c2(0x158)][_0x4e23c2(0x136)]({'where':{'id':_0x56576f},'select':{'password':!![]}});if(!_0x13e065)throw new Error('Shop\x20not\x20found');const _0x4036d7=await bcryptjs_1[_0x4e23c2(0x12d)][_0x4e23c2(0x139)](_0x20989c,_0x13e065['password']);if(!_0x4036d7)throw new Error(_0x4e23c2(0x117));await database_1['default'][_0x4e23c2(0x158)]['delete']({'where':{'id':_0x56576f}});}async[a76_0x19eeda(0x164)](_0x10724e){const _0x1b84dc=a76_0x19eeda,_0x5360ba=await database_1[_0x1b84dc(0x12d)][_0x1b84dc(0x14b)][_0x1b84dc(0x136)]({'where':{'shopId':_0x10724e}});!_0x5360ba&&await database_1['default'][_0x1b84dc(0x14b)][_0x1b84dc(0x132)]({'data':{'shopId':_0x10724e}});}}exports[a76_0x19eeda(0x15c)]=SettingsService;