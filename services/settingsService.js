'use strict';const a47_0x2d1a24=a47_0x19ed;function a47_0x19ed(_0x1b4789,_0x2c348e){const _0x383260=a47_0x3832();return a47_0x19ed=function(_0x19edae,_0x3d8ce0){_0x19edae=_0x19edae-0x1ef;let _0x283def=_0x383260[_0x19edae];return _0x283def;},a47_0x19ed(_0x1b4789,_0x2c348e);}(function(_0x5d5396,_0x62a6a8){const _0x1a573e=a47_0x19ed,_0x35bef3=_0x5d5396();while(!![]){try{const _0x1e2cec=-parseInt(_0x1a573e(0x1f8))/0x1+parseInt(_0x1a573e(0x22a))/0x2+-parseInt(_0x1a573e(0x213))/0x3+parseInt(_0x1a573e(0x1fd))/0x4*(-parseInt(_0x1a573e(0x20d))/0x5)+-parseInt(_0x1a573e(0x228))/0x6+-parseInt(_0x1a573e(0x1f5))/0x7+parseInt(_0x1a573e(0x1fb))/0x8;if(_0x1e2cec===_0x62a6a8)break;else _0x35bef3['push'](_0x35bef3['shift']());}catch(_0x11df07){_0x35bef3['push'](_0x35bef3['shift']());}}}(a47_0x3832,0x2fe21));var __importDefault=this&&this['__importDefault']||function(_0x71aff1){const _0x13dd73=a47_0x19ed;return _0x71aff1&&_0x71aff1[_0x13dd73(0x224)]?_0x71aff1:{'default':_0x71aff1};};Object[a47_0x2d1a24(0x208)](exports,'__esModule',{'value':!![]}),exports[a47_0x2d1a24(0x204)]=void 0x0;const bcryptjs_1=__importDefault(require(a47_0x2d1a24(0x229))),crypto_1=__importDefault(require('crypto')),database_1=__importDefault(require('../config/database'));function a47_0x3832(){const _0x25806b=['isArray','botApiKey','10614ltVBmM','shop','changePassword','1682128xqIpYe','notificationPayout','1020caFaXh','notificationLogin','payment_success','name','notificationApiError','delete','toString','SettingsService','Password\x20confirmation\x20is\x20incorrect','compare','randomBytes','defineProperty','updateNotifications','updateTelegramSettings','Shop\x20not\x20found','update','695XqEmBG','payout','length','ensureSettingsExist','login','telegram','218097SijwTk','webhookEvents','shopSettings','create','updateWebhookSettings','hex','sk_','pk_','parseWebhookEvents','notificationPaymentSuccess','revokeAllApiKeys','api_error','refund','hash','deleteAccount','password','findUnique','__esModule','Current\x20password\x20is\x20incorrect','notificationPaymentFailed','payment_failed','649800cSplhT','bcryptjs','755324ySaBFo','getShopSettings','string','telegramChatId','chatId','default','notificationRefund','telegramBotApiKey','substring','1153187hRbULs'];a47_0x3832=function(){return _0x25806b;};return a47_0x3832();}class SettingsService{['maskApiKey'](_0x5509d0){const _0x36ec03=a47_0x2d1a24;if(!_0x5509d0)return'';if(_0x5509d0[_0x36ec03(0x20f)]<=0x8)return _0x5509d0;const _0x45b600=_0x5509d0[_0x36ec03(0x1f4)](0x0,0x8),_0x1928ec='*'['repeat'](Math['max'](0x0,_0x5509d0[_0x36ec03(0x20f)]-0x8));return _0x45b600+_0x1928ec;}['parseWebhookEvents'](_0x1c1c78){const _0x5f4093=a47_0x2d1a24;if(!_0x1c1c78)return[];if(Array[_0x5f4093(0x1f6)](_0x1c1c78))return _0x1c1c78;if(typeof _0x1c1c78===_0x5f4093(0x22c))try{const _0x1e2e8c=JSON['parse'](_0x1c1c78);return Array['isArray'](_0x1e2e8c)?_0x1e2e8c:[];}catch{return[];}return[];}async[a47_0x2d1a24(0x22b)](_0x435204){const _0xb38b83=a47_0x2d1a24,_0x1435bd=await database_1[_0xb38b83(0x1f1)]['shop'][_0xb38b83(0x223)]({'where':{'id':_0x435204},'include':{'settings':!![]}});if(!_0x1435bd)throw new Error(_0xb38b83(0x20b));let _0x2f8be0=_0x1435bd['settings'];return!_0x2f8be0&&(_0x2f8be0=await database_1['default'][_0xb38b83(0x215)][_0xb38b83(0x216)]({'data':{'shopId':_0x1435bd['id']}})),{'fullName':_0x1435bd[_0xb38b83(0x200)],'brand':_0x1435bd[_0xb38b83(0x200)],'merchantUrl':_0x1435bd['shopUrl'],'telegramUsername':_0x1435bd[_0xb38b83(0x212)],'telegramBotApiKey':_0x2f8be0[_0xb38b83(0x1f3)]?this['maskApiKey'](_0x2f8be0[_0xb38b83(0x1f3)]):null,'telegramChatId':_0x2f8be0[_0xb38b83(0x1ef)],'webhookUrl':_0x2f8be0['webhookUrl'],'webhookEvents':this[_0xb38b83(0x21b)](_0x2f8be0[_0xb38b83(0x214)]),'notifications':{'payment_success':_0x2f8be0['notificationPaymentSuccess'],'payment_failed':_0x2f8be0[_0xb38b83(0x226)],'refund':_0x2f8be0['notificationRefund'],'payout':_0x2f8be0[_0xb38b83(0x1fc)],'login':_0x2f8be0[_0xb38b83(0x1fe)],'api_error':_0x2f8be0[_0xb38b83(0x201)]}};}async[a47_0x2d1a24(0x1fa)](_0xfc1d6f,_0x331fd0){const _0x4fad4d=a47_0x2d1a24,{currentPassword:_0x568bb3,newPassword:_0x406af3,confirmNewPassword:_0x4814b2}=_0x331fd0;if(_0x406af3!==_0x4814b2)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0x406af3[_0x4fad4d(0x20f)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x54e868=await database_1[_0x4fad4d(0x1f1)]['shop'][_0x4fad4d(0x223)]({'where':{'id':_0xfc1d6f},'select':{'password':!![]}});if(!_0x54e868)throw new Error('Shop\x20not\x20found');const _0x5266da=await bcryptjs_1[_0x4fad4d(0x1f1)][_0x4fad4d(0x206)](_0x568bb3,_0x54e868[_0x4fad4d(0x222)]);if(!_0x5266da)throw new Error(_0x4fad4d(0x225));const _0x1d1143=await bcryptjs_1['default'][_0x4fad4d(0x220)](_0x406af3,0xc);await database_1[_0x4fad4d(0x1f1)][_0x4fad4d(0x1f9)][_0x4fad4d(0x20c)]({'where':{'id':_0xfc1d6f},'data':{'password':_0x1d1143}});}async[a47_0x2d1a24(0x209)](_0x48957d,_0x3b25b2){const _0x2cfd06=a47_0x2d1a24;await this[_0x2cfd06(0x210)](_0x48957d);const _0xeacd63={};_0x3b25b2[_0x2cfd06(0x1ff)]!==undefined&&(_0xeacd63[_0x2cfd06(0x21c)]=_0x3b25b2[_0x2cfd06(0x1ff)]),_0x3b25b2[_0x2cfd06(0x227)]!==undefined&&(_0xeacd63[_0x2cfd06(0x226)]=_0x3b25b2['payment_failed']),_0x3b25b2[_0x2cfd06(0x21f)]!==undefined&&(_0xeacd63[_0x2cfd06(0x1f2)]=_0x3b25b2['refund']),_0x3b25b2[_0x2cfd06(0x20e)]!==undefined&&(_0xeacd63['notificationPayout']=_0x3b25b2[_0x2cfd06(0x20e)]),_0x3b25b2[_0x2cfd06(0x211)]!==undefined&&(_0xeacd63[_0x2cfd06(0x1fe)]=_0x3b25b2[_0x2cfd06(0x211)]),_0x3b25b2[_0x2cfd06(0x21e)]!==undefined&&(_0xeacd63[_0x2cfd06(0x201)]=_0x3b25b2[_0x2cfd06(0x21e)]),await database_1[_0x2cfd06(0x1f1)][_0x2cfd06(0x215)]['update']({'where':{'shopId':_0x48957d},'data':_0xeacd63});}async[a47_0x2d1a24(0x20a)](_0x1658f1,_0x471a25){const _0x39b91e=a47_0x2d1a24;await this['ensureSettingsExist'](_0x1658f1);const _0x348b0a={};_0x471a25['botApiKey']!==undefined&&(_0x348b0a['telegramBotApiKey']=_0x471a25[_0x39b91e(0x1f7)]||null),_0x471a25[_0x39b91e(0x1f0)]!==undefined&&(_0x348b0a[_0x39b91e(0x1ef)]=_0x471a25['chatId']||null),await database_1[_0x39b91e(0x1f1)][_0x39b91e(0x215)]['update']({'where':{'shopId':_0x1658f1},'data':_0x348b0a});}async[a47_0x2d1a24(0x217)](_0x3f6107,_0x1a2f21){const _0x1c7f46=a47_0x2d1a24;await this[_0x1c7f46(0x210)](_0x3f6107);const _0x3188a9={};_0x1a2f21['webhookUrl']!==undefined&&(_0x3188a9['webhookUrl']=_0x1a2f21['webhookUrl']||null),_0x1a2f21['webhookEvents']!==undefined&&(_0x3188a9[_0x1c7f46(0x214)]=_0x1a2f21['webhookEvents']||[]),await database_1['default'][_0x1c7f46(0x215)][_0x1c7f46(0x20c)]({'where':{'shopId':_0x3f6107},'data':_0x3188a9});}async[a47_0x2d1a24(0x21d)](_0x522132){const _0x4b7bb5=a47_0x2d1a24,_0x34f7a0=_0x4b7bb5(0x21a)+crypto_1['default']['randomBytes'](0x20)['toString']('hex'),_0x27374a=_0x4b7bb5(0x219)+crypto_1[_0x4b7bb5(0x1f1)][_0x4b7bb5(0x207)](0x20)[_0x4b7bb5(0x203)](_0x4b7bb5(0x218));await database_1['default'][_0x4b7bb5(0x1f9)][_0x4b7bb5(0x20c)]({'where':{'id':_0x522132},'data':{'publicKey':_0x34f7a0,'secretKey':_0x27374a}});}async[a47_0x2d1a24(0x221)](_0x75c3c8,_0x2a88ba){const _0x2d75ca=a47_0x2d1a24,{passwordConfirmation:_0xb00bb2}=_0x2a88ba,_0x909499=await database_1[_0x2d75ca(0x1f1)][_0x2d75ca(0x1f9)][_0x2d75ca(0x223)]({'where':{'id':_0x75c3c8},'select':{'password':!![]}});if(!_0x909499)throw new Error('Shop\x20not\x20found');const _0x1b3606=await bcryptjs_1[_0x2d75ca(0x1f1)][_0x2d75ca(0x206)](_0xb00bb2,_0x909499[_0x2d75ca(0x222)]);if(!_0x1b3606)throw new Error(_0x2d75ca(0x205));await database_1[_0x2d75ca(0x1f1)]['shop'][_0x2d75ca(0x202)]({'where':{'id':_0x75c3c8}});}async[a47_0x2d1a24(0x210)](_0x1ab63c){const _0x4d3a0c=a47_0x2d1a24,_0x40594b=await database_1['default'][_0x4d3a0c(0x215)][_0x4d3a0c(0x223)]({'where':{'shopId':_0x1ab63c}});!_0x40594b&&await database_1[_0x4d3a0c(0x1f1)][_0x4d3a0c(0x215)]['create']({'data':{'shopId':_0x1ab63c}});}}exports['SettingsService']=SettingsService;