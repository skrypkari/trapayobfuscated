'use strict';const a78_0x25297c=a78_0x2f0a;(function(_0x36dfcd,_0x46efe4){const _0x729ba1=a78_0x2f0a,_0x50bf32=_0x36dfcd();while(!![]){try{const _0x591e60=-parseInt(_0x729ba1(0xb5))/0x1+-parseInt(_0x729ba1(0xba))/0x2+parseInt(_0x729ba1(0xab))/0x3+-parseInt(_0x729ba1(0xbd))/0x4*(-parseInt(_0x729ba1(0x88))/0x5)+-parseInt(_0x729ba1(0xb0))/0x6+parseInt(_0x729ba1(0xbe))/0x7*(parseInt(_0x729ba1(0xa4))/0x8)+parseInt(_0x729ba1(0xa2))/0x9;if(_0x591e60===_0x46efe4)break;else _0x50bf32['push'](_0x50bf32['shift']());}catch(_0xdce765){_0x50bf32['push'](_0x50bf32['shift']());}}}(a78_0x2b52,0x7b805));function a78_0x2f0a(_0x10341e,_0x3359ce){_0x10341e=_0x10341e-0x79;const _0x2b5270=a78_0x2b52();let _0x2f0a59=_0x2b5270[_0x10341e];return _0x2f0a59;}function a78_0x2b52(){const _0x2a1c93=['revokeAllApiKeys','string','maskApiKey','__esModule','SettingsService','update','deleteAccount','length','hash','sk_','default','settings','parse','notificationPaymentFailed','5gIzElu','__importDefault','Password\x20confirmation\x20is\x20incorrect','shop','create','notificationPaymentSuccess','bcryptjs','backupCodes','repeat','speakeasy','Invalid\x202FA\x20token\x20or\x20backup\x20code','shopUrl','max','chatId','updateNotifications','isArray','parseWebhookEvents','botApiKey','notificationPayout','crypto','updateWebhookSettings','notificationLogin','telegramBotApiKey','payment_failed','shopSettings','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','6570774gyDvAa','compare','2513680uNglsM','pk_','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','webhookUrl','2FA\x20token\x20is\x20required','findUnique','login','37935uhkwoy','refund','twoFactorSecret','hex','../config/database','2709648TrYBFK','verify','notificationRefund','base32','getShopSettings','351389uEaoel','stringify','telegramChatId','payout','api_error','1588HTErjh','ensureSettingsExist','name','1010844RvUdbf','7iBrYIN','randomBytes','defineProperty','totp','payment_success','telegram','Shop\x20not\x20found','splice','Current\x20password\x20is\x20incorrect','_count','twoFactorEnabled','webhookEvents'];a78_0x2b52=function(){return _0x2a1c93;};return a78_0x2b52();}var __importDefault=this&&this[a78_0x25297c(0x89)]||function(_0x34e9d3){return _0x34e9d3&&_0x34e9d3['__esModule']?_0x34e9d3:{'default':_0x34e9d3};};Object[a78_0x25297c(0xc0)](exports,a78_0x25297c(0x7d),{'value':!![]}),exports[a78_0x25297c(0x7e)]=void 0x0;const bcryptjs_1=__importDefault(require(a78_0x25297c(0x8e))),crypto_1=__importDefault(require(a78_0x25297c(0x9b))),speakeasy_1=__importDefault(require(a78_0x25297c(0x91))),database_1=__importDefault(require(a78_0x25297c(0xaf)));class SettingsService{['maskApiKey'](_0x4c52b7){const _0x12b9c8=a78_0x25297c;if(!_0x4c52b7)return'';if(_0x4c52b7['length']<=0x8)return _0x4c52b7;const _0x4aac3c=_0x4c52b7['substring'](0x0,0x8),_0xed838c='*'[_0x12b9c8(0x90)](Math[_0x12b9c8(0x94)](0x0,_0x4c52b7['length']-0x8));return _0x4aac3c+_0xed838c;}[a78_0x25297c(0x98)](_0x5254dd){const _0x5879f5=a78_0x25297c;if(!_0x5254dd)return[];if(Array[_0x5879f5(0x97)](_0x5254dd))return _0x5254dd;if(typeof _0x5254dd===_0x5879f5(0x7b))try{const _0x5db0bf=JSON['parse'](_0x5254dd);return Array[_0x5879f5(0x97)](_0x5db0bf)?_0x5db0bf:[];}catch{return[];}return[];}async[a78_0x25297c(0xb4)](_0x16e902){const _0x24d17e=a78_0x25297c,_0x3b3e03=await database_1['default'][_0x24d17e(0x8b)][_0x24d17e(0xa9)]({'where':{'id':_0x16e902},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x3b3e03)throw new Error('Shop\x20not\x20found');let _0x338a8e=_0x3b3e03[_0x24d17e(0x85)];return!_0x338a8e&&(_0x338a8e=await database_1[_0x24d17e(0x84)][_0x24d17e(0xa0)]['create']({'data':{'shopId':_0x3b3e03['id']}})),{'fullName':_0x3b3e03[_0x24d17e(0xbc)],'brand':_0x3b3e03['name'],'merchantUrl':_0x3b3e03[_0x24d17e(0x93)],'telegramUsername':_0x3b3e03[_0x24d17e(0xc3)],'telegramBotApiKey':_0x338a8e[_0x24d17e(0x9e)]?this[_0x24d17e(0x7c)](_0x338a8e[_0x24d17e(0x9e)]):null,'telegramChatId':_0x338a8e[_0x24d17e(0xb7)],'telegramUsersCount':_0x3b3e03[_0x24d17e(0xc7)]['telegramUsers'],'webhookUrl':_0x338a8e[_0x24d17e(0xa7)],'webhookEvents':this['parseWebhookEvents'](_0x338a8e[_0x24d17e(0x79)]),'twoFactorEnabled':_0x3b3e03['twoFactorEnabled']||![],'notifications':{'payment_success':_0x338a8e['notificationPaymentSuccess'],'payment_failed':_0x338a8e[_0x24d17e(0x87)],'refund':_0x338a8e[_0x24d17e(0xb2)],'payout':_0x338a8e['notificationPayout'],'login':_0x338a8e[_0x24d17e(0x9d)],'api_error':_0x338a8e['notificationApiError']}};}async['changePassword'](_0x4e6135,_0x4f74ab){const _0x582bed=a78_0x25297c,{currentPassword:_0x3afb33,newPassword:_0x497025,confirmNewPassword:_0x534a1d,twoFactorToken:_0x7c6df7}=_0x4f74ab;if(_0x497025!==_0x534a1d)throw new Error(_0x582bed(0xa6));if(_0x497025[_0x582bed(0x81)]<0x6)throw new Error(_0x582bed(0xa1));const _0x36d12c=await database_1[_0x582bed(0x84)][_0x582bed(0x8b)][_0x582bed(0xa9)]({'where':{'id':_0x4e6135},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x36d12c)throw new Error('Shop\x20not\x20found');if(_0x36d12c[_0x582bed(0xc8)]){if(!_0x7c6df7)throw new Error(_0x582bed(0xa8));const _0x54700b=speakeasy_1[_0x582bed(0x84)][_0x582bed(0xc1)][_0x582bed(0xb1)]({'secret':_0x36d12c[_0x582bed(0xad)],'encoding':'base32','token':_0x7c6df7,'window':0x2});if(!_0x54700b){let _0x44cdcf=![];if(_0x36d12c[_0x582bed(0x8f)]){const _0x5244a2=JSON[_0x582bed(0x86)](_0x36d12c[_0x582bed(0x8f)]);for(let _0x31d7e2=0x0;_0x31d7e2<_0x5244a2['length'];_0x31d7e2++){const _0x6d9b7f=await bcryptjs_1[_0x582bed(0x84)]['compare'](_0x7c6df7,_0x5244a2[_0x31d7e2]);if(_0x6d9b7f){_0x44cdcf=!![],_0x5244a2[_0x582bed(0xc5)](_0x31d7e2,0x1),await database_1[_0x582bed(0x84)][_0x582bed(0x8b)][_0x582bed(0x7f)]({'where':{'id':_0x4e6135},'data':{'backupCodes':JSON[_0x582bed(0xb6)](_0x5244a2)}});break;}}}if(!_0x44cdcf)throw new Error(_0x582bed(0x92));}}const _0x3ee821=await bcryptjs_1['default'][_0x582bed(0xa3)](_0x3afb33,_0x36d12c['password']);if(!_0x3ee821)throw new Error(_0x582bed(0xc6));const _0x5b8df5=await bcryptjs_1['default'][_0x582bed(0x82)](_0x497025,0xc);await database_1['default'][_0x582bed(0x8b)][_0x582bed(0x7f)]({'where':{'id':_0x4e6135},'data':{'password':_0x5b8df5}});}async[a78_0x25297c(0x96)](_0x34350e,_0x26ee8d){const _0x3e0102=a78_0x25297c;await this[_0x3e0102(0xbb)](_0x34350e);const _0x34d83b={};_0x26ee8d[_0x3e0102(0xc2)]!==undefined&&(_0x34d83b[_0x3e0102(0x8d)]=_0x26ee8d['payment_success']),_0x26ee8d[_0x3e0102(0x9f)]!==undefined&&(_0x34d83b['notificationPaymentFailed']=_0x26ee8d[_0x3e0102(0x9f)]),_0x26ee8d['refund']!==undefined&&(_0x34d83b[_0x3e0102(0xb2)]=_0x26ee8d[_0x3e0102(0xac)]),_0x26ee8d[_0x3e0102(0xb8)]!==undefined&&(_0x34d83b[_0x3e0102(0x9a)]=_0x26ee8d['payout']),_0x26ee8d[_0x3e0102(0xaa)]!==undefined&&(_0x34d83b['notificationLogin']=_0x26ee8d[_0x3e0102(0xaa)]),_0x26ee8d['api_error']!==undefined&&(_0x34d83b['notificationApiError']=_0x26ee8d[_0x3e0102(0xb9)]),await database_1['default'][_0x3e0102(0xa0)][_0x3e0102(0x7f)]({'where':{'shopId':_0x34350e},'data':_0x34d83b});}async['updateTelegramSettings'](_0x140cad,_0x5e1881){const _0x3168c9=a78_0x25297c;await this[_0x3168c9(0xbb)](_0x140cad);const _0x584f5e={};_0x5e1881[_0x3168c9(0x99)]!==undefined&&(_0x584f5e[_0x3168c9(0x9e)]=_0x5e1881[_0x3168c9(0x99)]||null),_0x5e1881[_0x3168c9(0x95)]!==undefined&&(_0x584f5e[_0x3168c9(0xb7)]=_0x5e1881[_0x3168c9(0x95)]||null),await database_1['default'][_0x3168c9(0xa0)][_0x3168c9(0x7f)]({'where':{'shopId':_0x140cad},'data':_0x584f5e});}async[a78_0x25297c(0x9c)](_0x35b1b2,_0x4bd4ec){const _0x47a422=a78_0x25297c;await this[_0x47a422(0xbb)](_0x35b1b2);const _0xe75836={};_0x4bd4ec[_0x47a422(0xa7)]!==undefined&&(_0xe75836['webhookUrl']=_0x4bd4ec['webhookUrl']||null),_0x4bd4ec[_0x47a422(0x79)]!==undefined&&(_0xe75836['webhookEvents']=_0x4bd4ec[_0x47a422(0x79)]||[]),await database_1[_0x47a422(0x84)]['shopSettings']['update']({'where':{'shopId':_0x35b1b2},'data':_0xe75836});}async[a78_0x25297c(0x7a)](_0x5d9dd7,_0x4a3ac7){const _0x31899b=a78_0x25297c,_0x3a409b=await database_1[_0x31899b(0x84)][_0x31899b(0x8b)][_0x31899b(0xa9)]({'where':{'id':_0x5d9dd7},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x3a409b)throw new Error(_0x31899b(0xc4));if(_0x3a409b[_0x31899b(0xc8)]){if(!_0x4a3ac7)throw new Error(_0x31899b(0xa8));const _0x5f4999=speakeasy_1[_0x31899b(0x84)][_0x31899b(0xc1)]['verify']({'secret':_0x3a409b['twoFactorSecret'],'encoding':_0x31899b(0xb3),'token':_0x4a3ac7,'window':0x2});if(!_0x5f4999){let _0x4ba5be=![];if(_0x3a409b['backupCodes']){const _0x55c807=JSON['parse'](_0x3a409b[_0x31899b(0x8f)]);for(let _0x4580ba=0x0;_0x4580ba<_0x55c807['length'];_0x4580ba++){const _0xfd2130=await bcryptjs_1[_0x31899b(0x84)][_0x31899b(0xa3)](_0x4a3ac7,_0x55c807[_0x4580ba]);if(_0xfd2130){_0x4ba5be=!![],_0x55c807[_0x31899b(0xc5)](_0x4580ba,0x1),await database_1[_0x31899b(0x84)]['shop'][_0x31899b(0x7f)]({'where':{'id':_0x5d9dd7},'data':{'backupCodes':JSON[_0x31899b(0xb6)](_0x55c807)}});break;}}}if(!_0x4ba5be)throw new Error(_0x31899b(0x92));}}const _0x14a6c7=_0x31899b(0xa5)+crypto_1[_0x31899b(0x84)][_0x31899b(0xbf)](0x20)['toString'](_0x31899b(0xae)),_0x3c067f=_0x31899b(0x83)+crypto_1[_0x31899b(0x84)][_0x31899b(0xbf)](0x20)['toString'](_0x31899b(0xae));await database_1['default']['shop']['update']({'where':{'id':_0x5d9dd7},'data':{'publicKey':_0x14a6c7,'secretKey':_0x3c067f}});}async[a78_0x25297c(0x80)](_0x2d86ba,_0xd672a8){const _0x8176f5=a78_0x25297c,{passwordConfirmation:_0x4f705d}=_0xd672a8,_0x512bc0=await database_1[_0x8176f5(0x84)]['shop'][_0x8176f5(0xa9)]({'where':{'id':_0x2d86ba},'select':{'password':!![]}});if(!_0x512bc0)throw new Error(_0x8176f5(0xc4));const _0x298c89=await bcryptjs_1[_0x8176f5(0x84)]['compare'](_0x4f705d,_0x512bc0['password']);if(!_0x298c89)throw new Error(_0x8176f5(0x8a));await database_1[_0x8176f5(0x84)][_0x8176f5(0x8b)]['delete']({'where':{'id':_0x2d86ba}});}async[a78_0x25297c(0xbb)](_0x334201){const _0x43474d=a78_0x25297c,_0x1a627e=await database_1[_0x43474d(0x84)][_0x43474d(0xa0)][_0x43474d(0xa9)]({'where':{'shopId':_0x334201}});!_0x1a627e&&await database_1['default'][_0x43474d(0xa0)][_0x43474d(0x8c)]({'data':{'shopId':_0x334201}});}}exports['SettingsService']=SettingsService;