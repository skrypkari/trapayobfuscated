'use strict';const a76_0x81de72=a76_0x23a6;(function(_0x26187d,_0x1b23bd){const _0x32676f=a76_0x23a6,_0x2adb4e=_0x26187d();while(!![]){try{const _0x418475=parseInt(_0x32676f(0x11b))/0x1*(-parseInt(_0x32676f(0x10c))/0x2)+-parseInt(_0x32676f(0x112))/0x3*(parseInt(_0x32676f(0x146))/0x4)+parseInt(_0x32676f(0x13a))/0x5+parseInt(_0x32676f(0x147))/0x6*(parseInt(_0x32676f(0x135))/0x7)+-parseInt(_0x32676f(0x148))/0x8*(-parseInt(_0x32676f(0x119))/0x9)+parseInt(_0x32676f(0x125))/0xa*(-parseInt(_0x32676f(0x121))/0xb)+parseInt(_0x32676f(0x137))/0xc*(parseInt(_0x32676f(0x118))/0xd);if(_0x418475===_0x1b23bd)break;else _0x2adb4e['push'](_0x2adb4e['shift']());}catch(_0x1931a7){_0x2adb4e['push'](_0x2adb4e['shift']());}}}(a76_0x29dd,0xb6eff));function a76_0x29dd(){const _0x4225a2=['SettingsService','parseWebhookEvents','1811315XRWBTA','password','shopSettings','getShopSettings','backupCodes','findUnique','splice','notificationApiError','revokeAllApiKeys','shopUrl','hex','telegramBotApiKey','44NlmjvQ','5394IQuNkt','312136BgidDp','deleteAccount','length','telegramChatId','refund','default','delete','crypto','__esModule','chatId','shop','notificationRefund','notificationPaymentSuccess','hash','updateTelegramSettings','payout','maskApiKey','2PcixFA','randomBytes','payment_failed','update','twoFactorSecret','Shop\x20not\x20found','141675sPEOri','bcryptjs','compare','webhookUrl','name','botApiKey','7813HxXWad','189PoTPoz','notificationPayout','1171899cThIGZ','notificationPaymentFailed','ensureSettingsExist','verify','string','pk_','828278laKhij','notificationLogin','login','payment_success','40xbihds','isArray','__importDefault','substring','twoFactorEnabled','updateNotifications','api_error','defineProperty','repeat','../config/database','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','webhookEvents','Invalid\x202FA\x20token\x20or\x20backup\x20code','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','updateWebhookSettings','parse','1512qJgCtz','telegram','27276KKlenq'];a76_0x29dd=function(){return _0x4225a2;};return a76_0x29dd();}var __importDefault=this&&this[a76_0x81de72(0x127)]||function(_0x5f539d){return _0x5f539d&&_0x5f539d['__esModule']?_0x5f539d:{'default':_0x5f539d};};Object[a76_0x81de72(0x12c)](exports,a76_0x81de72(0x150),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require(a76_0x81de72(0x113))),crypto_1=__importDefault(require(a76_0x81de72(0x14f))),speakeasy_1=__importDefault(require('speakeasy')),database_1=__importDefault(require(a76_0x81de72(0x12e)));class SettingsService{['maskApiKey'](_0x49fd9d){const _0x89f503=a76_0x81de72;if(!_0x49fd9d)return'';if(_0x49fd9d[_0x89f503(0x14a)]<=0x8)return _0x49fd9d;const _0x12644d=_0x49fd9d[_0x89f503(0x128)](0x0,0x8),_0x4d84b8='*'[_0x89f503(0x12d)](Math['max'](0x0,_0x49fd9d['length']-0x8));return _0x12644d+_0x4d84b8;}['parseWebhookEvents'](_0x28e6b2){const _0xbaabe0=a76_0x81de72;if(!_0x28e6b2)return[];if(Array[_0xbaabe0(0x126)](_0x28e6b2))return _0x28e6b2;if(typeof _0x28e6b2===_0xbaabe0(0x11f))try{const _0x12fb06=JSON[_0xbaabe0(0x134)](_0x28e6b2);return Array[_0xbaabe0(0x126)](_0x12fb06)?_0x12fb06:[];}catch{return[];}return[];}async[a76_0x81de72(0x13d)](_0x4caf6c){const _0x40e5a9=a76_0x81de72,_0x2a6f87=await database_1[_0x40e5a9(0x14d)][_0x40e5a9(0x152)][_0x40e5a9(0x13f)]({'where':{'id':_0x4caf6c},'include':{'settings':!![]}});if(!_0x2a6f87)throw new Error(_0x40e5a9(0x111));let _0x589f72=_0x2a6f87['settings'];return!_0x589f72&&(_0x589f72=await database_1[_0x40e5a9(0x14d)][_0x40e5a9(0x13c)]['create']({'data':{'shopId':_0x2a6f87['id']}})),{'fullName':_0x2a6f87[_0x40e5a9(0x116)],'brand':_0x2a6f87[_0x40e5a9(0x116)],'merchantUrl':_0x2a6f87[_0x40e5a9(0x143)],'telegramUsername':_0x2a6f87[_0x40e5a9(0x136)],'telegramBotApiKey':_0x589f72['telegramBotApiKey']?this[_0x40e5a9(0x10b)](_0x589f72[_0x40e5a9(0x145)]):null,'telegramChatId':_0x589f72[_0x40e5a9(0x14b)],'webhookUrl':_0x589f72[_0x40e5a9(0x115)],'webhookEvents':this[_0x40e5a9(0x139)](_0x589f72['webhookEvents']),'twoFactorEnabled':_0x2a6f87[_0x40e5a9(0x129)]||![],'notifications':{'payment_success':_0x589f72[_0x40e5a9(0x154)],'payment_failed':_0x589f72[_0x40e5a9(0x11c)],'refund':_0x589f72[_0x40e5a9(0x153)],'payout':_0x589f72[_0x40e5a9(0x11a)],'login':_0x589f72['notificationLogin'],'api_error':_0x589f72[_0x40e5a9(0x141)]}};}async['changePassword'](_0x21c535,_0x36d558){const _0x3c1348=a76_0x81de72,{currentPassword:_0x224581,newPassword:_0x181213,confirmNewPassword:_0x8741d9,twoFactorToken:_0x391832}=_0x36d558;if(_0x181213!==_0x8741d9)throw new Error(_0x3c1348(0x12f));if(_0x181213[_0x3c1348(0x14a)]<0x6)throw new Error(_0x3c1348(0x132));const _0x4d093a=await database_1['default'][_0x3c1348(0x152)]['findUnique']({'where':{'id':_0x21c535},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x4d093a)throw new Error('Shop\x20not\x20found');if(_0x4d093a[_0x3c1348(0x129)]){if(!_0x391832)throw new Error('2FA\x20token\x20is\x20required');const _0x5bea23=speakeasy_1[_0x3c1348(0x14d)]['totp'][_0x3c1348(0x11e)]({'secret':_0x4d093a[_0x3c1348(0x110)],'encoding':'base32','token':_0x391832,'window':0x2});if(!_0x5bea23){let _0x4ec136=![];if(_0x4d093a[_0x3c1348(0x13e)]){const _0x377919=JSON['parse'](_0x4d093a['backupCodes']);for(let _0x44d2df=0x0;_0x44d2df<_0x377919['length'];_0x44d2df++){const _0x1161fa=await bcryptjs_1[_0x3c1348(0x14d)]['compare'](_0x391832,_0x377919[_0x44d2df]);if(_0x1161fa){_0x4ec136=!![],_0x377919[_0x3c1348(0x140)](_0x44d2df,0x1),await database_1[_0x3c1348(0x14d)][_0x3c1348(0x152)][_0x3c1348(0x10f)]({'where':{'id':_0x21c535},'data':{'backupCodes':JSON['stringify'](_0x377919)}});break;}}}if(!_0x4ec136)throw new Error(_0x3c1348(0x131));}}const _0xe9712c=await bcryptjs_1[_0x3c1348(0x14d)][_0x3c1348(0x114)](_0x224581,_0x4d093a['password']);if(!_0xe9712c)throw new Error('Current\x20password\x20is\x20incorrect');const _0xd78ae8=await bcryptjs_1[_0x3c1348(0x14d)][_0x3c1348(0x155)](_0x181213,0xc);await database_1['default'][_0x3c1348(0x152)]['update']({'where':{'id':_0x21c535},'data':{'password':_0xd78ae8}});}async[a76_0x81de72(0x12a)](_0x319a63,_0x879c04){const _0x209883=a76_0x81de72;await this[_0x209883(0x11d)](_0x319a63);const _0x390cdb={};_0x879c04[_0x209883(0x124)]!==undefined&&(_0x390cdb[_0x209883(0x154)]=_0x879c04[_0x209883(0x124)]),_0x879c04[_0x209883(0x10e)]!==undefined&&(_0x390cdb[_0x209883(0x11c)]=_0x879c04[_0x209883(0x10e)]),_0x879c04['refund']!==undefined&&(_0x390cdb[_0x209883(0x153)]=_0x879c04[_0x209883(0x14c)]),_0x879c04[_0x209883(0x10a)]!==undefined&&(_0x390cdb[_0x209883(0x11a)]=_0x879c04[_0x209883(0x10a)]),_0x879c04[_0x209883(0x123)]!==undefined&&(_0x390cdb[_0x209883(0x122)]=_0x879c04[_0x209883(0x123)]),_0x879c04['api_error']!==undefined&&(_0x390cdb[_0x209883(0x141)]=_0x879c04[_0x209883(0x12b)]),await database_1[_0x209883(0x14d)][_0x209883(0x13c)][_0x209883(0x10f)]({'where':{'shopId':_0x319a63},'data':_0x390cdb});}async[a76_0x81de72(0x109)](_0x25ee1a,_0x16e101){const _0x25072c=a76_0x81de72;await this[_0x25072c(0x11d)](_0x25ee1a);const _0x137655={};_0x16e101[_0x25072c(0x117)]!==undefined&&(_0x137655[_0x25072c(0x145)]=_0x16e101[_0x25072c(0x117)]||null),_0x16e101[_0x25072c(0x151)]!==undefined&&(_0x137655['telegramChatId']=_0x16e101['chatId']||null),await database_1[_0x25072c(0x14d)][_0x25072c(0x13c)][_0x25072c(0x10f)]({'where':{'shopId':_0x25ee1a},'data':_0x137655});}async[a76_0x81de72(0x133)](_0x5e16f2,_0x4e5adb){const _0x212001=a76_0x81de72;await this[_0x212001(0x11d)](_0x5e16f2);const _0x1cbeb3={};_0x4e5adb['webhookUrl']!==undefined&&(_0x1cbeb3[_0x212001(0x115)]=_0x4e5adb['webhookUrl']||null),_0x4e5adb[_0x212001(0x130)]!==undefined&&(_0x1cbeb3[_0x212001(0x130)]=_0x4e5adb[_0x212001(0x130)]||[]),await database_1[_0x212001(0x14d)]['shopSettings'][_0x212001(0x10f)]({'where':{'shopId':_0x5e16f2},'data':_0x1cbeb3});}async[a76_0x81de72(0x142)](_0x3f6629){const _0x41b773=a76_0x81de72,_0x4ecd2d=_0x41b773(0x120)+crypto_1[_0x41b773(0x14d)][_0x41b773(0x10d)](0x20)['toString'](_0x41b773(0x144)),_0x10d05a='sk_'+crypto_1[_0x41b773(0x14d)]['randomBytes'](0x20)['toString'](_0x41b773(0x144));await database_1['default'][_0x41b773(0x152)][_0x41b773(0x10f)]({'where':{'id':_0x3f6629},'data':{'publicKey':_0x4ecd2d,'secretKey':_0x10d05a}});}async[a76_0x81de72(0x149)](_0x474ec0,_0x140ac5){const _0x5d6ddb=a76_0x81de72,{passwordConfirmation:_0x488693}=_0x140ac5,_0x4a77dc=await database_1['default'][_0x5d6ddb(0x152)][_0x5d6ddb(0x13f)]({'where':{'id':_0x474ec0},'select':{'password':!![]}});if(!_0x4a77dc)throw new Error(_0x5d6ddb(0x111));const _0x4e7293=await bcryptjs_1[_0x5d6ddb(0x14d)][_0x5d6ddb(0x114)](_0x488693,_0x4a77dc[_0x5d6ddb(0x13b)]);if(!_0x4e7293)throw new Error('Password\x20confirmation\x20is\x20incorrect');await database_1[_0x5d6ddb(0x14d)]['shop'][_0x5d6ddb(0x14e)]({'where':{'id':_0x474ec0}});}async[a76_0x81de72(0x11d)](_0x283b0d){const _0x12c030=a76_0x81de72,_0x4ef9f7=await database_1[_0x12c030(0x14d)][_0x12c030(0x13c)]['findUnique']({'where':{'shopId':_0x283b0d}});!_0x4ef9f7&&await database_1['default'][_0x12c030(0x13c)]['create']({'data':{'shopId':_0x283b0d}});}}function a76_0x23a6(_0x389902,_0x2134d5){_0x389902=_0x389902-0x109;const _0x29ddbf=a76_0x29dd();let _0x23a6ca=_0x29ddbf[_0x389902];return _0x23a6ca;}exports[a76_0x81de72(0x138)]=SettingsService;