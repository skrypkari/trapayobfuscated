'use strict';const a52_0x2ae338=a52_0xccc1;function a52_0x3eb5(){const _0x24db5b=['deleteAccount','notificationPaymentSuccess','Shop\x20not\x20found','changePassword','botApiKey','webhookUrl','1215645SJVwbo','update','login','62XBQyVO','refund','ensureSettingsExist','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','maskApiKey','4620096HEjrRd','name','isArray','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','telegramChatId','1242760aaHcea','webhookEvents','SettingsService','telegramBotApiKey','api_error','119533weOaNb','1544879Nwqvbn','max','notificationLogin','payment_failed','create','__importDefault','updateNotifications','42648JPXxjp','notificationPaymentFailed','notificationApiError','getShopSettings','__esModule','hex','payment_success','1011906xTuGCd','shop','updateTelegramSettings','defineProperty','password','chatId','telegram','shopSettings','randomBytes','string','payout','toString','substring','notificationRefund','length','compare','Password\x20confirmation\x20is\x20incorrect','../config/database','findUnique','default','crypto','notificationPayout'];a52_0x3eb5=function(){return _0x24db5b;};return a52_0x3eb5();}(function(_0x2fe06b,_0x11c58e){const _0x1ebfa6=a52_0xccc1,_0x38163c=_0x2fe06b();while(!![]){try{const _0x4c533b=-parseInt(_0x1ebfa6(0x17e))/0x1+parseInt(_0x1ebfa6(0x1ac))/0x2*(parseInt(_0x1ebfa6(0x186))/0x3)+-parseInt(_0x1ebfa6(0x179))/0x4+-parseInt(_0x1ebfa6(0x1a9))/0x5+parseInt(_0x1ebfa6(0x18d))/0x6+-parseInt(_0x1ebfa6(0x17f))/0x7+parseInt(_0x1ebfa6(0x174))/0x8;if(_0x4c533b===_0x11c58e)break;else _0x38163c['push'](_0x38163c['shift']());}catch(_0x403fb4){_0x38163c['push'](_0x38163c['shift']());}}}(a52_0x3eb5,0x477ca));var __importDefault=this&&this[a52_0x2ae338(0x184)]||function(_0x198d72){const _0x300781=a52_0x2ae338;return _0x198d72&&_0x198d72[_0x300781(0x18a)]?_0x198d72:{'default':_0x198d72};};Object[a52_0x2ae338(0x190)](exports,a52_0x2ae338(0x18a),{'value':!![]}),exports[a52_0x2ae338(0x17b)]=void 0x0;function a52_0xccc1(_0x41848e,_0xe66a5f){const _0x3eb544=a52_0x3eb5();return a52_0xccc1=function(_0xccc174,_0x96df3f){_0xccc174=_0xccc174-0x172;let _0x1adc8a=_0x3eb544[_0xccc174];return _0x1adc8a;},a52_0xccc1(_0x41848e,_0xe66a5f);}const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a52_0x2ae338(0x1a1))),database_1=__importDefault(require(a52_0x2ae338(0x19e)));class SettingsService{[a52_0x2ae338(0x173)](_0x39e04f){const _0xd1371d=a52_0x2ae338;if(!_0x39e04f)return'';if(_0x39e04f[_0xd1371d(0x19b)]<=0x8)return _0x39e04f;const _0x3cb2b5=_0x39e04f[_0xd1371d(0x199)](0x0,0x8),_0x3514ef='*'['repeat'](Math[_0xd1371d(0x180)](0x0,_0x39e04f[_0xd1371d(0x19b)]-0x8));return _0x3cb2b5+_0x3514ef;}['parseWebhookEvents'](_0xf7c8de){const _0xf8dbfe=a52_0x2ae338;if(!_0xf7c8de)return[];if(Array['isArray'](_0xf7c8de))return _0xf7c8de;if(typeof _0xf7c8de===_0xf8dbfe(0x196))try{const _0x2ef126=JSON['parse'](_0xf7c8de);return Array[_0xf8dbfe(0x176)](_0x2ef126)?_0x2ef126:[];}catch{return[];}return[];}async[a52_0x2ae338(0x189)](_0x5d8c81){const _0x4eb3b8=a52_0x2ae338,_0x538595=await database_1[_0x4eb3b8(0x1a0)][_0x4eb3b8(0x18e)][_0x4eb3b8(0x19f)]({'where':{'id':_0x5d8c81},'include':{'settings':!![]}});if(!_0x538595)throw new Error(_0x4eb3b8(0x1a5));let _0x46f9ea=_0x538595['settings'];return!_0x46f9ea&&(_0x46f9ea=await database_1[_0x4eb3b8(0x1a0)][_0x4eb3b8(0x194)][_0x4eb3b8(0x183)]({'data':{'shopId':_0x538595['id']}})),{'fullName':_0x538595[_0x4eb3b8(0x175)],'brand':_0x538595[_0x4eb3b8(0x175)],'merchantUrl':_0x538595['shopUrl'],'telegramUsername':_0x538595[_0x4eb3b8(0x193)],'telegramBotApiKey':_0x46f9ea['telegramBotApiKey']?this[_0x4eb3b8(0x173)](_0x46f9ea[_0x4eb3b8(0x17c)]):null,'telegramChatId':_0x46f9ea[_0x4eb3b8(0x178)],'webhookUrl':_0x46f9ea['webhookUrl'],'webhookEvents':this['parseWebhookEvents'](_0x46f9ea['webhookEvents']),'notifications':{'payment_success':_0x46f9ea[_0x4eb3b8(0x1a4)],'payment_failed':_0x46f9ea[_0x4eb3b8(0x187)],'refund':_0x46f9ea[_0x4eb3b8(0x19a)],'payout':_0x46f9ea[_0x4eb3b8(0x1a2)],'login':_0x46f9ea[_0x4eb3b8(0x181)],'api_error':_0x46f9ea[_0x4eb3b8(0x188)]}};}async[a52_0x2ae338(0x1a6)](_0x4a02c9,_0x51cd3b){const _0x4c4bc8=a52_0x2ae338,{currentPassword:_0x3616ff,newPassword:_0x4e90f8,confirmNewPassword:_0x39b129}=_0x51cd3b;if(_0x4e90f8!==_0x39b129)throw new Error(_0x4c4bc8(0x177));if(_0x4e90f8[_0x4c4bc8(0x19b)]<0x6)throw new Error(_0x4c4bc8(0x172));const _0x436d31=await database_1[_0x4c4bc8(0x1a0)][_0x4c4bc8(0x18e)][_0x4c4bc8(0x19f)]({'where':{'id':_0x4a02c9},'select':{'password':!![]}});if(!_0x436d31)throw new Error(_0x4c4bc8(0x1a5));const _0x236e48=await bcryptjs_1['default']['compare'](_0x3616ff,_0x436d31['password']);if(!_0x236e48)throw new Error('Current\x20password\x20is\x20incorrect');const _0x453d73=await bcryptjs_1[_0x4c4bc8(0x1a0)]['hash'](_0x4e90f8,0xc);await database_1['default'][_0x4c4bc8(0x18e)][_0x4c4bc8(0x1aa)]({'where':{'id':_0x4a02c9},'data':{'password':_0x453d73}});}async[a52_0x2ae338(0x185)](_0x57a8ee,_0x1e0146){const _0x496e76=a52_0x2ae338;await this[_0x496e76(0x1ae)](_0x57a8ee);const _0x468abb={};_0x1e0146['payment_success']!==undefined&&(_0x468abb[_0x496e76(0x1a4)]=_0x1e0146[_0x496e76(0x18c)]),_0x1e0146[_0x496e76(0x182)]!==undefined&&(_0x468abb[_0x496e76(0x187)]=_0x1e0146[_0x496e76(0x182)]),_0x1e0146[_0x496e76(0x1ad)]!==undefined&&(_0x468abb['notificationRefund']=_0x1e0146[_0x496e76(0x1ad)]),_0x1e0146[_0x496e76(0x197)]!==undefined&&(_0x468abb['notificationPayout']=_0x1e0146[_0x496e76(0x197)]),_0x1e0146['login']!==undefined&&(_0x468abb[_0x496e76(0x181)]=_0x1e0146[_0x496e76(0x1ab)]),_0x1e0146['api_error']!==undefined&&(_0x468abb[_0x496e76(0x188)]=_0x1e0146[_0x496e76(0x17d)]),await database_1[_0x496e76(0x1a0)][_0x496e76(0x194)][_0x496e76(0x1aa)]({'where':{'shopId':_0x57a8ee},'data':_0x468abb});}async[a52_0x2ae338(0x18f)](_0x3fdb56,_0x3e392e){const _0x30649e=a52_0x2ae338;await this[_0x30649e(0x1ae)](_0x3fdb56);const _0x573484={};_0x3e392e[_0x30649e(0x1a7)]!==undefined&&(_0x573484[_0x30649e(0x17c)]=_0x3e392e[_0x30649e(0x1a7)]||null),_0x3e392e[_0x30649e(0x192)]!==undefined&&(_0x573484['telegramChatId']=_0x3e392e[_0x30649e(0x192)]||null),await database_1[_0x30649e(0x1a0)][_0x30649e(0x194)]['update']({'where':{'shopId':_0x3fdb56},'data':_0x573484});}async['updateWebhookSettings'](_0x5b8382,_0x17410c){const _0x31b971=a52_0x2ae338;await this['ensureSettingsExist'](_0x5b8382);const _0x16f32f={};_0x17410c[_0x31b971(0x1a8)]!==undefined&&(_0x16f32f[_0x31b971(0x1a8)]=_0x17410c[_0x31b971(0x1a8)]||null),_0x17410c[_0x31b971(0x17a)]!==undefined&&(_0x16f32f[_0x31b971(0x17a)]=_0x17410c[_0x31b971(0x17a)]||[]),await database_1[_0x31b971(0x1a0)][_0x31b971(0x194)][_0x31b971(0x1aa)]({'where':{'shopId':_0x5b8382},'data':_0x16f32f});}async['revokeAllApiKeys'](_0x7a1e47){const _0x183ce7=a52_0x2ae338,_0x15ab16='pk_'+crypto_1[_0x183ce7(0x1a0)][_0x183ce7(0x195)](0x20)[_0x183ce7(0x198)](_0x183ce7(0x18b)),_0x2ca404='sk_'+crypto_1['default'][_0x183ce7(0x195)](0x20)['toString'](_0x183ce7(0x18b));await database_1[_0x183ce7(0x1a0)][_0x183ce7(0x18e)]['update']({'where':{'id':_0x7a1e47},'data':{'publicKey':_0x15ab16,'secretKey':_0x2ca404}});}async[a52_0x2ae338(0x1a3)](_0xd1213f,_0x4e888a){const _0x6276a0=a52_0x2ae338,{passwordConfirmation:_0x147d34}=_0x4e888a,_0x5c33fa=await database_1[_0x6276a0(0x1a0)][_0x6276a0(0x18e)][_0x6276a0(0x19f)]({'where':{'id':_0xd1213f},'select':{'password':!![]}});if(!_0x5c33fa)throw new Error(_0x6276a0(0x1a5));const _0x2792d8=await bcryptjs_1[_0x6276a0(0x1a0)][_0x6276a0(0x19c)](_0x147d34,_0x5c33fa[_0x6276a0(0x191)]);if(!_0x2792d8)throw new Error(_0x6276a0(0x19d));await database_1['default'][_0x6276a0(0x18e)]['delete']({'where':{'id':_0xd1213f}});}async[a52_0x2ae338(0x1ae)](_0x44a312){const _0x2b4d4d=a52_0x2ae338,_0x2c94f7=await database_1[_0x2b4d4d(0x1a0)][_0x2b4d4d(0x194)]['findUnique']({'where':{'shopId':_0x44a312}});!_0x2c94f7&&await database_1[_0x2b4d4d(0x1a0)][_0x2b4d4d(0x194)]['create']({'data':{'shopId':_0x44a312}});}}exports['SettingsService']=SettingsService;