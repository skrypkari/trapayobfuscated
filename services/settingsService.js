'use strict';const a52_0x1b7cb3=a52_0x33d7;function a52_0x57d3(){const _0x405df2=['update','__esModule','Current\x20password\x20is\x20incorrect','notificationPaymentSuccess','refund','1479009TIoiQZ','string','length','login','bcryptjs','notificationLogin','195765rnsMGG','notificationPayout','name','hex','Password\x20confirmation\x20is\x20incorrect','botApiKey','10464YJEzWI','telegramBotApiKey','compare','Shop\x20not\x20found','4AtkLAu','defineProperty','getShopSettings','../config/database','SettingsService','password','payout','crypto','findUnique','create','isArray','7kWiPhU','updateWebhookSettings','telegram','delete','38822DhNCHv','payment_success','ensureSettingsExist','sk_','220hyeWcj','215871EqqEQI','webhookUrl','api_error','778140PTClZi','default','telegramChatId','hash','substring','184383iNhXTI','pk_','shopSettings','changePassword','maskApiKey','webhookEvents','chatId','randomBytes','deleteAccount','shop','parseWebhookEvents','notificationApiError','updateNotifications','payment_failed'];a52_0x57d3=function(){return _0x405df2;};return a52_0x57d3();}(function(_0x13f0fb,_0x34b660){const _0x286e28=a52_0x33d7,_0x4b245d=_0x13f0fb();while(!![]){try{const _0x120ac9=parseInt(_0x286e28(0x1a8))/0x1*(parseInt(_0x286e28(0x1ac))/0x2)+parseInt(_0x286e28(0x1b1))/0x3*(parseInt(_0x286e28(0x19d))/0x4)+parseInt(_0x286e28(0x193))/0x5+parseInt(_0x286e28(0x1b4))/0x6+parseInt(_0x286e28(0x18d))/0x7+-parseInt(_0x286e28(0x199))/0x8+parseInt(_0x286e28(0x1b9))/0x9*(-parseInt(_0x286e28(0x1b0))/0xa);if(_0x120ac9===_0x34b660)break;else _0x4b245d['push'](_0x4b245d['shift']());}catch(_0x255cae){_0x4b245d['push'](_0x4b245d['shift']());}}}(a52_0x57d3,0x21306));var __importDefault=this&&this['__importDefault']||function(_0x6ad87){const _0x119399=a52_0x33d7;return _0x6ad87&&_0x6ad87[_0x119399(0x189)]?_0x6ad87:{'default':_0x6ad87};};Object[a52_0x1b7cb3(0x19e)](exports,'__esModule',{'value':!![]}),exports[a52_0x1b7cb3(0x1a1)]=void 0x0;function a52_0x33d7(_0x4f9a3d,_0x424a49){const _0x57d397=a52_0x57d3();return a52_0x33d7=function(_0x33d788,_0x397711){_0x33d788=_0x33d788-0x17b;let _0x37d54b=_0x57d397[_0x33d788];return _0x37d54b;},a52_0x33d7(_0x4f9a3d,_0x424a49);}const bcryptjs_1=__importDefault(require(a52_0x1b7cb3(0x191))),crypto_1=__importDefault(require(a52_0x1b7cb3(0x1a4))),database_1=__importDefault(require(a52_0x1b7cb3(0x1a0)));class SettingsService{[a52_0x1b7cb3(0x17e)](_0x100fe5){const _0xee3dbf=a52_0x1b7cb3;if(!_0x100fe5)return'';if(_0x100fe5['length']<=0x8)return _0x100fe5;const _0x4d77b4=_0x100fe5[_0xee3dbf(0x1b8)](0x0,0x8),_0x1b6efd='*'['repeat'](Math['max'](0x0,_0x100fe5[_0xee3dbf(0x18f)]-0x8));return _0x4d77b4+_0x1b6efd;}['parseWebhookEvents'](_0x103230){const _0x389085=a52_0x1b7cb3;if(!_0x103230)return[];if(Array[_0x389085(0x1a7)](_0x103230))return _0x103230;if(typeof _0x103230===_0x389085(0x18e))try{const _0x5042d0=JSON['parse'](_0x103230);return Array[_0x389085(0x1a7)](_0x5042d0)?_0x5042d0:[];}catch{return[];}return[];}async[a52_0x1b7cb3(0x19f)](_0x3b4e42){const _0x23dd6d=a52_0x1b7cb3,_0x322cc5=await database_1[_0x23dd6d(0x1b5)]['shop'][_0x23dd6d(0x1a5)]({'where':{'id':_0x3b4e42},'include':{'settings':!![]}});if(!_0x322cc5)throw new Error(_0x23dd6d(0x19c));let _0x1c573f=_0x322cc5['settings'];return!_0x1c573f&&(_0x1c573f=await database_1[_0x23dd6d(0x1b5)][_0x23dd6d(0x17c)]['create']({'data':{'shopId':_0x322cc5['id']}})),{'fullName':_0x322cc5[_0x23dd6d(0x195)],'brand':_0x322cc5['name'],'merchantUrl':_0x322cc5['shopUrl'],'telegramUsername':_0x322cc5[_0x23dd6d(0x1aa)],'telegramBotApiKey':_0x1c573f['telegramBotApiKey']?this[_0x23dd6d(0x17e)](_0x1c573f[_0x23dd6d(0x19a)]):null,'telegramChatId':_0x1c573f[_0x23dd6d(0x1b6)],'webhookUrl':_0x1c573f[_0x23dd6d(0x1b2)],'webhookEvents':this[_0x23dd6d(0x184)](_0x1c573f[_0x23dd6d(0x17f)]),'notifications':{'payment_success':_0x1c573f[_0x23dd6d(0x18b)],'payment_failed':_0x1c573f['notificationPaymentFailed'],'refund':_0x1c573f['notificationRefund'],'payout':_0x1c573f[_0x23dd6d(0x194)],'login':_0x1c573f[_0x23dd6d(0x192)],'api_error':_0x1c573f['notificationApiError']}};}async[a52_0x1b7cb3(0x17d)](_0x143a23,_0x65fed1){const _0x5cf55c=a52_0x1b7cb3,{currentPassword:_0x48701e,newPassword:_0xcb3777,confirmNewPassword:_0x461c34}=_0x65fed1;if(_0xcb3777!==_0x461c34)throw new Error('New\x20password\x20and\x20confirmation\x20do\x20not\x20match');if(_0xcb3777[_0x5cf55c(0x18f)]<0x6)throw new Error('New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long');const _0x536786=await database_1[_0x5cf55c(0x1b5)][_0x5cf55c(0x183)]['findUnique']({'where':{'id':_0x143a23},'select':{'password':!![]}});if(!_0x536786)throw new Error(_0x5cf55c(0x19c));const _0x1463ae=await bcryptjs_1[_0x5cf55c(0x1b5)][_0x5cf55c(0x19b)](_0x48701e,_0x536786[_0x5cf55c(0x1a2)]);if(!_0x1463ae)throw new Error(_0x5cf55c(0x18a));const _0x2c479e=await bcryptjs_1[_0x5cf55c(0x1b5)][_0x5cf55c(0x1b7)](_0xcb3777,0xc);await database_1[_0x5cf55c(0x1b5)][_0x5cf55c(0x183)][_0x5cf55c(0x188)]({'where':{'id':_0x143a23},'data':{'password':_0x2c479e}});}async[a52_0x1b7cb3(0x186)](_0x4fd33b,_0x1198ee){const _0x4a41ea=a52_0x1b7cb3;await this[_0x4a41ea(0x1ae)](_0x4fd33b);const _0x4ea149={};_0x1198ee['payment_success']!==undefined&&(_0x4ea149[_0x4a41ea(0x18b)]=_0x1198ee[_0x4a41ea(0x1ad)]),_0x1198ee[_0x4a41ea(0x187)]!==undefined&&(_0x4ea149['notificationPaymentFailed']=_0x1198ee['payment_failed']),_0x1198ee[_0x4a41ea(0x18c)]!==undefined&&(_0x4ea149['notificationRefund']=_0x1198ee['refund']),_0x1198ee[_0x4a41ea(0x1a3)]!==undefined&&(_0x4ea149[_0x4a41ea(0x194)]=_0x1198ee[_0x4a41ea(0x1a3)]),_0x1198ee['login']!==undefined&&(_0x4ea149[_0x4a41ea(0x192)]=_0x1198ee[_0x4a41ea(0x190)]),_0x1198ee[_0x4a41ea(0x1b3)]!==undefined&&(_0x4ea149[_0x4a41ea(0x185)]=_0x1198ee['api_error']),await database_1[_0x4a41ea(0x1b5)][_0x4a41ea(0x17c)][_0x4a41ea(0x188)]({'where':{'shopId':_0x4fd33b},'data':_0x4ea149});}async['updateTelegramSettings'](_0x4506be,_0x191ee4){const _0x5df691=a52_0x1b7cb3;await this[_0x5df691(0x1ae)](_0x4506be);const _0x2b9263={};_0x191ee4['botApiKey']!==undefined&&(_0x2b9263[_0x5df691(0x19a)]=_0x191ee4[_0x5df691(0x198)]||null),_0x191ee4['chatId']!==undefined&&(_0x2b9263[_0x5df691(0x1b6)]=_0x191ee4[_0x5df691(0x180)]||null),await database_1[_0x5df691(0x1b5)][_0x5df691(0x17c)][_0x5df691(0x188)]({'where':{'shopId':_0x4506be},'data':_0x2b9263});}async[a52_0x1b7cb3(0x1a9)](_0x436b71,_0x2abd3f){const _0x531b9c=a52_0x1b7cb3;await this[_0x531b9c(0x1ae)](_0x436b71);const _0x4832f9={};_0x2abd3f[_0x531b9c(0x1b2)]!==undefined&&(_0x4832f9[_0x531b9c(0x1b2)]=_0x2abd3f[_0x531b9c(0x1b2)]||null),_0x2abd3f[_0x531b9c(0x17f)]!==undefined&&(_0x4832f9['webhookEvents']=_0x2abd3f[_0x531b9c(0x17f)]||[]),await database_1[_0x531b9c(0x1b5)][_0x531b9c(0x17c)]['update']({'where':{'shopId':_0x436b71},'data':_0x4832f9});}async['revokeAllApiKeys'](_0x551eb5){const _0x276aa7=a52_0x1b7cb3,_0x469225=_0x276aa7(0x17b)+crypto_1[_0x276aa7(0x1b5)][_0x276aa7(0x181)](0x20)['toString'](_0x276aa7(0x196)),_0x2fa0ea=_0x276aa7(0x1af)+crypto_1[_0x276aa7(0x1b5)][_0x276aa7(0x181)](0x20)['toString']('hex');await database_1[_0x276aa7(0x1b5)][_0x276aa7(0x183)]['update']({'where':{'id':_0x551eb5},'data':{'publicKey':_0x469225,'secretKey':_0x2fa0ea}});}async[a52_0x1b7cb3(0x182)](_0x17cf86,_0x4bd302){const _0x162028=a52_0x1b7cb3,{passwordConfirmation:_0x2206ac}=_0x4bd302,_0x329d73=await database_1['default'][_0x162028(0x183)]['findUnique']({'where':{'id':_0x17cf86},'select':{'password':!![]}});if(!_0x329d73)throw new Error('Shop\x20not\x20found');const _0x342cb5=await bcryptjs_1[_0x162028(0x1b5)][_0x162028(0x19b)](_0x2206ac,_0x329d73[_0x162028(0x1a2)]);if(!_0x342cb5)throw new Error(_0x162028(0x197));await database_1['default'][_0x162028(0x183)][_0x162028(0x1ab)]({'where':{'id':_0x17cf86}});}async[a52_0x1b7cb3(0x1ae)](_0x1779ee){const _0x1dc058=a52_0x1b7cb3,_0x181826=await database_1[_0x1dc058(0x1b5)]['shopSettings'][_0x1dc058(0x1a5)]({'where':{'shopId':_0x1779ee}});!_0x181826&&await database_1[_0x1dc058(0x1b5)]['shopSettings'][_0x1dc058(0x1a6)]({'data':{'shopId':_0x1779ee}});}}exports[a52_0x1b7cb3(0x1a1)]=SettingsService;