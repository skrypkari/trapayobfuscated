'use strict';const a78_0x41c1a3=a78_0xb6ef;(function(_0x2c027a,_0x5d161f){const _0x574803=a78_0xb6ef,_0x5b051d=_0x2c027a();while(!![]){try{const _0x415fd0=parseInt(_0x574803(0x1fe))/0x1*(-parseInt(_0x574803(0x1e2))/0x2)+parseInt(_0x574803(0x1f9))/0x3+-parseInt(_0x574803(0x21c))/0x4*(parseInt(_0x574803(0x1f6))/0x5)+parseInt(_0x574803(0x1e8))/0x6+parseInt(_0x574803(0x210))/0x7*(-parseInt(_0x574803(0x20b))/0x8)+parseInt(_0x574803(0x201))/0x9*(parseInt(_0x574803(0x1f4))/0xa)+parseInt(_0x574803(0x230))/0xb*(parseInt(_0x574803(0x231))/0xc);if(_0x415fd0===_0x5d161f)break;else _0x5b051d['push'](_0x5b051d['shift']());}catch(_0x13597b){_0x5b051d['push'](_0x5b051d['shift']());}}}(a78_0x5e69,0xdf28c));function a78_0xb6ef(_0x3f76ce,_0x153d8d){_0x3f76ce=_0x3f76ce-0x1df;const _0x5e6979=a78_0x5e69();let _0xb6efbf=_0x5e6979[_0x3f76ce];return _0xb6efbf;}var __importDefault=this&&this[a78_0x41c1a3(0x1e0)]||function(_0x1f457c){const _0x261895=a78_0x41c1a3;return _0x1f457c&&_0x1f457c[_0x261895(0x1df)]?_0x1f457c:{'default':_0x1f457c};};function a78_0x5e69(){const _0x5c3e1e=['changePassword','pk_','defineProperty','string','updateWebhookSettings','9124000WGhnsZ','payment_success','Telegram\x20session\x20not\x20found','parse','Shop\x20not\x20found','7lzFaIj','notificationPaymentFailed','maskApiKey','stringify','crypto','create','SettingsService','shopSettings','notificationLogin','updateNotifications','findUnique','ensureSettingsExist','85744yTGnkF','base32','Unauthorized\x20to\x20disconnect\x20this\x20session','updateTelegramSettings','shopId','telegramBotApiKey','chatId','twoFactorEnabled','speakeasy','Current\x20password\x20is\x20incorrect','2FA\x20token\x20is\x20required','shop','notificationApiError','Invalid\x202FA\x20token\x20or\x20backup\x20code','webhookEvents','password','payout','payment_failed','default','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','132lwKExx','1000788hKhKxV','hash','isArray','name','__esModule','__importDefault','twoFactorSecret','7418ZApYrt','update','notificationRefund','parseWebhookEvents','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','length','3558936rePSjI','totp','login','_count','splice','max','notificationPaymentSuccess','hex','backupCodes','telegramUser','settings','telegram','10azAbIM','notificationPayout','285mWROSI','compare','delete','3314472kZpJpA','telegramChatId','webhookUrl','verify','randomBytes','49BgZQiP','desc','../config/database','6834465MpQUpb','revokeAllApiKeys','api_error','refund','Password\x20confirmation\x20is\x20incorrect'];a78_0x5e69=function(){return _0x5c3e1e;};return a78_0x5e69();}Object[a78_0x41c1a3(0x208)](exports,a78_0x41c1a3(0x1df),{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a78_0x41c1a3(0x214))),speakeasy_1=__importDefault(require(a78_0x41c1a3(0x224))),database_1=__importDefault(require(a78_0x41c1a3(0x200)));class SettingsService{[a78_0x41c1a3(0x212)](_0x39ade8){const _0x46338c=a78_0x41c1a3;if(!_0x39ade8)return'';if(_0x39ade8[_0x46338c(0x1e7)]<=0x8)return _0x39ade8;const _0x23e9f0=_0x39ade8['substring'](0x0,0x8),_0x2ab7a7='*'['repeat'](Math[_0x46338c(0x1ed)](0x0,_0x39ade8[_0x46338c(0x1e7)]-0x8));return _0x23e9f0+_0x2ab7a7;}[a78_0x41c1a3(0x1e5)](_0x576ca6){const _0x4566cb=a78_0x41c1a3;if(!_0x576ca6)return[];if(Array[_0x4566cb(0x233)](_0x576ca6))return _0x576ca6;if(typeof _0x576ca6===_0x4566cb(0x209))try{const _0x46006e=JSON[_0x4566cb(0x20e)](_0x576ca6);return Array[_0x4566cb(0x233)](_0x46006e)?_0x46006e:[];}catch{return[];}return[];}async['getShopSettings'](_0x4c7cc0){const _0x518801=a78_0x41c1a3,_0xac5a27=await database_1[_0x518801(0x22e)][_0x518801(0x227)][_0x518801(0x21a)]({'where':{'id':_0x4c7cc0},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0xac5a27)throw new Error(_0x518801(0x20f));let _0x5c5bea=_0xac5a27[_0x518801(0x1f2)];return!_0x5c5bea&&(_0x5c5bea=await database_1[_0x518801(0x22e)]['shopSettings'][_0x518801(0x215)]({'data':{'shopId':_0xac5a27['id']}})),{'fullName':_0xac5a27[_0x518801(0x234)],'brand':_0xac5a27['name'],'merchantUrl':_0xac5a27['shopUrl'],'telegramUsername':_0xac5a27[_0x518801(0x1f3)],'telegramBotApiKey':_0x5c5bea[_0x518801(0x221)]?this['maskApiKey'](_0x5c5bea[_0x518801(0x221)]):null,'telegramChatId':_0x5c5bea[_0x518801(0x1fa)],'telegramUsersCount':_0xac5a27[_0x518801(0x1eb)]['telegramUsers'],'webhookUrl':_0x5c5bea[_0x518801(0x1fb)],'webhookEvents':this[_0x518801(0x1e5)](_0x5c5bea[_0x518801(0x22a)]),'twoFactorEnabled':_0xac5a27[_0x518801(0x223)]||![],'notifications':{'payment_success':_0x5c5bea[_0x518801(0x1ee)],'payment_failed':_0x5c5bea['notificationPaymentFailed'],'refund':_0x5c5bea['notificationRefund'],'payout':_0x5c5bea[_0x518801(0x1f5)],'login':_0x5c5bea[_0x518801(0x218)],'api_error':_0x5c5bea[_0x518801(0x228)]}};}async[a78_0x41c1a3(0x206)](_0x123725,_0x148038){const _0x1f64f9=a78_0x41c1a3,{currentPassword:_0x4f8c27,newPassword:_0x353dc7,confirmNewPassword:_0x55e651,twoFactorToken:_0x299f7b}=_0x148038;if(_0x353dc7!==_0x55e651)throw new Error(_0x1f64f9(0x22f));if(_0x353dc7[_0x1f64f9(0x1e7)]<0x6)throw new Error(_0x1f64f9(0x1e6));const _0x4df606=await database_1[_0x1f64f9(0x22e)][_0x1f64f9(0x227)][_0x1f64f9(0x21a)]({'where':{'id':_0x123725},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x4df606)throw new Error(_0x1f64f9(0x20f));if(_0x4df606[_0x1f64f9(0x223)]){if(!_0x299f7b)throw new Error(_0x1f64f9(0x226));const _0x1352a8=speakeasy_1[_0x1f64f9(0x22e)][_0x1f64f9(0x1e9)][_0x1f64f9(0x1fc)]({'secret':_0x4df606[_0x1f64f9(0x1e1)],'encoding':'base32','token':_0x299f7b,'window':0x2});if(!_0x1352a8){let _0x25a401=![];if(_0x4df606[_0x1f64f9(0x1f0)]){const _0x4cbb06=JSON[_0x1f64f9(0x20e)](_0x4df606[_0x1f64f9(0x1f0)]);for(let _0x3f335b=0x0;_0x3f335b<_0x4cbb06[_0x1f64f9(0x1e7)];_0x3f335b++){const _0x56479f=await bcryptjs_1[_0x1f64f9(0x22e)][_0x1f64f9(0x1f7)](_0x299f7b,_0x4cbb06[_0x3f335b]);if(_0x56479f){_0x25a401=!![],_0x4cbb06[_0x1f64f9(0x1ec)](_0x3f335b,0x1),await database_1[_0x1f64f9(0x22e)][_0x1f64f9(0x227)]['update']({'where':{'id':_0x123725},'data':{'backupCodes':JSON[_0x1f64f9(0x213)](_0x4cbb06)}});break;}}}if(!_0x25a401)throw new Error(_0x1f64f9(0x229));}}const _0x600ca6=await bcryptjs_1[_0x1f64f9(0x22e)]['compare'](_0x4f8c27,_0x4df606[_0x1f64f9(0x22b)]);if(!_0x600ca6)throw new Error(_0x1f64f9(0x225));const _0x26913a=await bcryptjs_1[_0x1f64f9(0x22e)][_0x1f64f9(0x232)](_0x353dc7,0xc);await database_1[_0x1f64f9(0x22e)]['shop'][_0x1f64f9(0x1e3)]({'where':{'id':_0x123725},'data':{'password':_0x26913a}});}async[a78_0x41c1a3(0x219)](_0x1f8c07,_0x2269c6){const _0x5950e6=a78_0x41c1a3;await this[_0x5950e6(0x21b)](_0x1f8c07);const _0xb53816={};_0x2269c6[_0x5950e6(0x20c)]!==undefined&&(_0xb53816[_0x5950e6(0x1ee)]=_0x2269c6[_0x5950e6(0x20c)]),_0x2269c6[_0x5950e6(0x22d)]!==undefined&&(_0xb53816[_0x5950e6(0x211)]=_0x2269c6[_0x5950e6(0x22d)]),_0x2269c6['refund']!==undefined&&(_0xb53816[_0x5950e6(0x1e4)]=_0x2269c6[_0x5950e6(0x204)]),_0x2269c6[_0x5950e6(0x22c)]!==undefined&&(_0xb53816[_0x5950e6(0x1f5)]=_0x2269c6[_0x5950e6(0x22c)]),_0x2269c6['login']!==undefined&&(_0xb53816[_0x5950e6(0x218)]=_0x2269c6[_0x5950e6(0x1ea)]),_0x2269c6[_0x5950e6(0x203)]!==undefined&&(_0xb53816[_0x5950e6(0x228)]=_0x2269c6[_0x5950e6(0x203)]),await database_1[_0x5950e6(0x22e)][_0x5950e6(0x217)][_0x5950e6(0x1e3)]({'where':{'shopId':_0x1f8c07},'data':_0xb53816});}async[a78_0x41c1a3(0x21f)](_0x3a8f8e,_0x2cde6d){const _0x3c5f35=a78_0x41c1a3;await this[_0x3c5f35(0x21b)](_0x3a8f8e);const _0x103951={};_0x2cde6d['botApiKey']!==undefined&&(_0x103951[_0x3c5f35(0x221)]=_0x2cde6d['botApiKey']||null),_0x2cde6d[_0x3c5f35(0x222)]!==undefined&&(_0x103951[_0x3c5f35(0x1fa)]=_0x2cde6d[_0x3c5f35(0x222)]||null),await database_1[_0x3c5f35(0x22e)][_0x3c5f35(0x217)]['update']({'where':{'shopId':_0x3a8f8e},'data':_0x103951});}async[a78_0x41c1a3(0x20a)](_0x3da8c8,_0x4881b5){const _0x38cab2=a78_0x41c1a3;await this['ensureSettingsExist'](_0x3da8c8);const _0x207198={};_0x4881b5['webhookUrl']!==undefined&&(_0x207198['webhookUrl']=_0x4881b5[_0x38cab2(0x1fb)]||null),_0x4881b5['webhookEvents']!==undefined&&(_0x207198['webhookEvents']=_0x4881b5[_0x38cab2(0x22a)]||[]),await database_1['default'][_0x38cab2(0x217)]['update']({'where':{'shopId':_0x3da8c8},'data':_0x207198});}async[a78_0x41c1a3(0x202)](_0x17b89f,_0x235bc5){const _0x12e682=a78_0x41c1a3,_0x30c696=await database_1[_0x12e682(0x22e)]['shop'][_0x12e682(0x21a)]({'where':{'id':_0x17b89f},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x30c696)throw new Error(_0x12e682(0x20f));if(_0x30c696['twoFactorEnabled']){if(!_0x235bc5)throw new Error('2FA\x20token\x20is\x20required');const _0x456ff8=speakeasy_1[_0x12e682(0x22e)][_0x12e682(0x1e9)][_0x12e682(0x1fc)]({'secret':_0x30c696[_0x12e682(0x1e1)],'encoding':_0x12e682(0x21d),'token':_0x235bc5,'window':0x2});if(!_0x456ff8){let _0x222f3b=![];if(_0x30c696[_0x12e682(0x1f0)]){const _0x50c28b=JSON[_0x12e682(0x20e)](_0x30c696['backupCodes']);for(let _0x25583f=0x0;_0x25583f<_0x50c28b[_0x12e682(0x1e7)];_0x25583f++){const _0x24b0a7=await bcryptjs_1[_0x12e682(0x22e)][_0x12e682(0x1f7)](_0x235bc5,_0x50c28b[_0x25583f]);if(_0x24b0a7){_0x222f3b=!![],_0x50c28b[_0x12e682(0x1ec)](_0x25583f,0x1),await database_1['default'][_0x12e682(0x227)]['update']({'where':{'id':_0x17b89f},'data':{'backupCodes':JSON[_0x12e682(0x213)](_0x50c28b)}});break;}}}if(!_0x222f3b)throw new Error(_0x12e682(0x229));}}const _0x2eb64f=_0x12e682(0x207)+crypto_1[_0x12e682(0x22e)]['randomBytes'](0x20)['toString'](_0x12e682(0x1ef)),_0xddfc01='sk_'+crypto_1[_0x12e682(0x22e)][_0x12e682(0x1fd)](0x20)['toString'](_0x12e682(0x1ef));await database_1[_0x12e682(0x22e)][_0x12e682(0x227)][_0x12e682(0x1e3)]({'where':{'id':_0x17b89f},'data':{'publicKey':_0x2eb64f,'secretKey':_0xddfc01}});}async['deleteAccount'](_0x31ef36,_0x4c0b6d){const _0x2653e0=a78_0x41c1a3,{passwordConfirmation:_0x468fd3}=_0x4c0b6d,_0x1696a5=await database_1['default'][_0x2653e0(0x227)][_0x2653e0(0x21a)]({'where':{'id':_0x31ef36},'select':{'password':!![]}});if(!_0x1696a5)throw new Error('Shop\x20not\x20found');const _0x18938a=await bcryptjs_1[_0x2653e0(0x22e)][_0x2653e0(0x1f7)](_0x468fd3,_0x1696a5['password']);if(!_0x18938a)throw new Error(_0x2653e0(0x205));await database_1[_0x2653e0(0x22e)][_0x2653e0(0x227)][_0x2653e0(0x1f8)]({'where':{'id':_0x31ef36}});}async['getTelegramSessions'](_0x5776e6){const _0x3a4c5e=a78_0x41c1a3,_0x3fd9b0=await database_1[_0x3a4c5e(0x22e)][_0x3a4c5e(0x1f1)]['findMany']({'where':{'shopId':_0x5776e6,'isVerified':!![]},'orderBy':{'createdAt':_0x3a4c5e(0x1ff)},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x3fd9b0;}async['disconnectTelegramSession'](_0xd92bc3,_0x1e3d2d){const _0x5a8466=a78_0x41c1a3,_0x533531=await database_1['default'][_0x5a8466(0x1f1)]['findUnique']({'where':{'id':_0x1e3d2d},'select':{'shopId':!![]}});if(!_0x533531)throw new Error(_0x5a8466(0x20d));if(_0x533531[_0x5a8466(0x220)]!==_0xd92bc3)throw new Error(_0x5a8466(0x21e));await database_1[_0x5a8466(0x22e)][_0x5a8466(0x1f1)][_0x5a8466(0x1e3)]({'where':{'id':_0x1e3d2d},'data':{'shopId':null,'isVerified':![]}});}async[a78_0x41c1a3(0x21b)](_0x3d629f){const _0x1e7e25=a78_0x41c1a3,_0x38d911=await database_1['default']['shopSettings'][_0x1e7e25(0x21a)]({'where':{'shopId':_0x3d629f}});!_0x38d911&&await database_1[_0x1e7e25(0x22e)][_0x1e7e25(0x217)]['create']({'data':{'shopId':_0x3d629f}});}}exports[a78_0x41c1a3(0x216)]=SettingsService;