'use strict';function a85_0x391e(_0x29fb41,_0xcb5186){_0x29fb41=_0x29fb41-0x1bd;const _0x592a95=a85_0x592a();let _0x391eb5=_0x592a95[_0x29fb41];return _0x391eb5;}const a85_0x4b5fa3=a85_0x391e;(function(_0x411f06,_0x4dc5c4){const _0x4b4754=a85_0x391e,_0x91702=_0x411f06();while(!![]){try{const _0xb3f82c=-parseInt(_0x4b4754(0x1bf))/0x1*(parseInt(_0x4b4754(0x1d9))/0x2)+-parseInt(_0x4b4754(0x1ca))/0x3*(parseInt(_0x4b4754(0x1c4))/0x4)+parseInt(_0x4b4754(0x1c3))/0x5+-parseInt(_0x4b4754(0x203))/0x6*(parseInt(_0x4b4754(0x20f))/0x7)+-parseInt(_0x4b4754(0x1c5))/0x8*(-parseInt(_0x4b4754(0x1cb))/0x9)+parseInt(_0x4b4754(0x1e7))/0xa+parseInt(_0x4b4754(0x1fc))/0xb;if(_0xb3f82c===_0x4dc5c4)break;else _0x91702['push'](_0x91702['shift']());}catch(_0x4d9657){_0x91702['push'](_0x91702['shift']());}}}(a85_0x592a,0xc9701));var __importDefault=this&&this['__importDefault']||function(_0xd50e07){const _0x23a1ce=a85_0x391e;return _0xd50e07&&_0xd50e07[_0x23a1ce(0x1d3)]?_0xd50e07:{'default':_0xd50e07};};Object['defineProperty'](exports,a85_0x4b5fa3(0x1d3),{'value':!![]}),exports[a85_0x4b5fa3(0x1e4)]=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a85_0x4b5fa3(0x207))),speakeasy_1=__importDefault(require(a85_0x4b5fa3(0x1d1))),database_1=__importDefault(require('../config/database'));class SettingsService{[a85_0x4b5fa3(0x20b)](_0x52ea01){const _0x5d4309=a85_0x4b5fa3;if(!_0x52ea01)return'';if(_0x52ea01[_0x5d4309(0x206)]<=0x8)return _0x52ea01;const _0x560dab=_0x52ea01[_0x5d4309(0x1fb)](0x0,0x8),_0x18de45='*'['repeat'](Math['max'](0x0,_0x52ea01[_0x5d4309(0x206)]-0x8));return _0x560dab+_0x18de45;}[a85_0x4b5fa3(0x1f5)](_0x520070){const _0x40e5ec=a85_0x4b5fa3;if(!_0x520070)return[];if(Array[_0x40e5ec(0x1d4)](_0x520070))return _0x520070;if(typeof _0x520070==='string')try{const _0x31bf07=JSON[_0x40e5ec(0x1d8)](_0x520070);return Array[_0x40e5ec(0x1d4)](_0x31bf07)?_0x31bf07:[];}catch{return[];}return[];}async[a85_0x4b5fa3(0x1e0)](_0x52c645){const _0x2226ba=a85_0x4b5fa3,_0x2b6835=await database_1[_0x2226ba(0x1f3)][_0x2226ba(0x1fe)]['findUnique']({'where':{'id':_0x52c645},'include':{'settings':!![],'_count':{'select':{'telegramUsers':!![]}}}});if(!_0x2b6835)throw new Error(_0x2226ba(0x1f2));let _0x2db1c8=_0x2b6835['settings'];return!_0x2db1c8&&(_0x2db1c8=await database_1[_0x2226ba(0x1f3)][_0x2226ba(0x1ea)][_0x2226ba(0x205)]({'data':{'shopId':_0x2b6835['id']}})),{'fullName':_0x2b6835['name'],'brand':_0x2b6835['name'],'merchantUrl':_0x2b6835[_0x2226ba(0x204)],'telegramUsername':_0x2b6835['telegram'],'telegramBotApiKey':_0x2db1c8['telegramBotApiKey']?this[_0x2226ba(0x20b)](_0x2db1c8[_0x2226ba(0x1df)]):null,'telegramChatId':_0x2db1c8[_0x2226ba(0x208)],'telegramUsersCount':_0x2b6835['_count'][_0x2226ba(0x1cd)],'webhookUrl':_0x2db1c8['webhookUrl'],'webhookEvents':this['parseWebhookEvents'](_0x2db1c8[_0x2226ba(0x1dd)]),'twoFactorEnabled':_0x2b6835[_0x2226ba(0x1f0)]||![],'notifications':{'payment_success':_0x2db1c8[_0x2226ba(0x1ef)],'payment_failed':_0x2db1c8[_0x2226ba(0x1f7)],'refund':_0x2db1c8['notificationRefund'],'payout':_0x2db1c8['notificationPayout'],'login':_0x2db1c8['notificationLogin'],'api_error':_0x2db1c8['notificationApiError']}};}async[a85_0x4b5fa3(0x1d2)](_0x4e4c5c,_0x520104){const _0x54e565=a85_0x4b5fa3,{currentPassword:_0x144b4f,newPassword:_0x18b6d8,confirmNewPassword:_0x5d8dfb,twoFactorToken:_0x1d3493}=_0x520104;if(_0x18b6d8!==_0x5d8dfb)throw new Error(_0x54e565(0x200));if(_0x18b6d8[_0x54e565(0x206)]<0x6)throw new Error(_0x54e565(0x1c9));const _0x4e055c=await database_1[_0x54e565(0x1f3)][_0x54e565(0x1fe)][_0x54e565(0x1c2)]({'where':{'id':_0x4e4c5c},'select':{'password':!![],'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x4e055c)throw new Error(_0x54e565(0x1f2));if(_0x4e055c[_0x54e565(0x1f0)]){if(!_0x1d3493)throw new Error(_0x54e565(0x1e9));const _0x350bba=speakeasy_1['default'][_0x54e565(0x1d0)]['verify']({'secret':_0x4e055c[_0x54e565(0x1c7)],'encoding':'base32','token':_0x1d3493,'window':0x2});if(!_0x350bba){let _0x4f051a=![];if(_0x4e055c[_0x54e565(0x1eb)]){const _0x192c9c=JSON[_0x54e565(0x1d8)](_0x4e055c[_0x54e565(0x1eb)]);for(let _0x6f32c7=0x0;_0x6f32c7<_0x192c9c['length'];_0x6f32c7++){const _0x5ef7c1=await bcryptjs_1[_0x54e565(0x1f3)][_0x54e565(0x1f4)](_0x1d3493,_0x192c9c[_0x6f32c7]);if(_0x5ef7c1){_0x4f051a=!![],_0x192c9c[_0x54e565(0x1fd)](_0x6f32c7,0x1),await database_1[_0x54e565(0x1f3)]['shop'][_0x54e565(0x1ed)]({'where':{'id':_0x4e4c5c},'data':{'backupCodes':JSON[_0x54e565(0x20d)](_0x192c9c)}});break;}}}if(!_0x4f051a)throw new Error(_0x54e565(0x202));}}const _0x5b7a70=await bcryptjs_1['default'][_0x54e565(0x1f4)](_0x144b4f,_0x4e055c[_0x54e565(0x1de)]);if(!_0x5b7a70)throw new Error(_0x54e565(0x1c0));const _0x4add83=await bcryptjs_1[_0x54e565(0x1f3)][_0x54e565(0x1c6)](_0x18b6d8,0xc);await database_1[_0x54e565(0x1f3)][_0x54e565(0x1fe)][_0x54e565(0x1ed)]({'where':{'id':_0x4e4c5c},'data':{'password':_0x4add83}});}async[a85_0x4b5fa3(0x1ce)](_0x4184fc,_0x5380e5){const _0x4a7e05=a85_0x4b5fa3;await this['ensureSettingsExist'](_0x4184fc);const _0x194caa={};_0x5380e5[_0x4a7e05(0x1da)]!==undefined&&(_0x194caa[_0x4a7e05(0x1ef)]=_0x5380e5[_0x4a7e05(0x1da)]),_0x5380e5[_0x4a7e05(0x20e)]!==undefined&&(_0x194caa[_0x4a7e05(0x1f7)]=_0x5380e5[_0x4a7e05(0x20e)]),_0x5380e5['refund']!==undefined&&(_0x194caa[_0x4a7e05(0x1f1)]=_0x5380e5[_0x4a7e05(0x1e5)]),_0x5380e5[_0x4a7e05(0x209)]!==undefined&&(_0x194caa[_0x4a7e05(0x1db)]=_0x5380e5[_0x4a7e05(0x209)]),_0x5380e5[_0x4a7e05(0x20a)]!==undefined&&(_0x194caa[_0x4a7e05(0x20c)]=_0x5380e5[_0x4a7e05(0x20a)]),_0x5380e5[_0x4a7e05(0x1c1)]!==undefined&&(_0x194caa[_0x4a7e05(0x1f6)]=_0x5380e5[_0x4a7e05(0x1c1)]),await database_1[_0x4a7e05(0x1f3)][_0x4a7e05(0x1ea)][_0x4a7e05(0x1ed)]({'where':{'shopId':_0x4184fc},'data':_0x194caa});}async[a85_0x4b5fa3(0x201)](_0x45967b,_0x5c77f4){const _0x37f70c=a85_0x4b5fa3;await this[_0x37f70c(0x1ff)](_0x45967b);const _0x15c88e={};_0x5c77f4['botApiKey']!==undefined&&(_0x15c88e[_0x37f70c(0x1df)]=_0x5c77f4[_0x37f70c(0x210)]||null),_0x5c77f4[_0x37f70c(0x1f9)]!==undefined&&(_0x15c88e[_0x37f70c(0x208)]=_0x5c77f4['chatId']||null),await database_1[_0x37f70c(0x1f3)][_0x37f70c(0x1ea)][_0x37f70c(0x1ed)]({'where':{'shopId':_0x45967b},'data':_0x15c88e});}async[a85_0x4b5fa3(0x1ee)](_0x3de513,_0x1b40b5){const _0x2b6dd8=a85_0x4b5fa3;await this['ensureSettingsExist'](_0x3de513);const _0x3b1139={};_0x1b40b5[_0x2b6dd8(0x1d5)]!==undefined&&(_0x3b1139[_0x2b6dd8(0x1d5)]=_0x1b40b5['webhookUrl']||null),_0x1b40b5[_0x2b6dd8(0x1dd)]!==undefined&&(_0x3b1139[_0x2b6dd8(0x1dd)]=_0x1b40b5[_0x2b6dd8(0x1dd)]||[]),await database_1[_0x2b6dd8(0x1f3)][_0x2b6dd8(0x1ea)][_0x2b6dd8(0x1ed)]({'where':{'shopId':_0x3de513},'data':_0x3b1139});}async[a85_0x4b5fa3(0x1f8)](_0x69d63f,_0x3c558b){const _0x5795a7=a85_0x4b5fa3,_0x356226=await database_1['default'][_0x5795a7(0x1fe)][_0x5795a7(0x1c2)]({'where':{'id':_0x69d63f},'select':{'twoFactorEnabled':!![],'twoFactorSecret':!![],'backupCodes':!![]}});if(!_0x356226)throw new Error(_0x5795a7(0x1f2));if(_0x356226[_0x5795a7(0x1f0)]){if(!_0x3c558b)throw new Error(_0x5795a7(0x1e9));const _0x47176e=speakeasy_1['default'][_0x5795a7(0x1d0)]['verify']({'secret':_0x356226[_0x5795a7(0x1c7)],'encoding':_0x5795a7(0x1be),'token':_0x3c558b,'window':0x2});if(!_0x47176e){let _0x209a54=![];if(_0x356226[_0x5795a7(0x1eb)]){const _0x1d8ecd=JSON[_0x5795a7(0x1d8)](_0x356226[_0x5795a7(0x1eb)]);for(let _0x33f6cf=0x0;_0x33f6cf<_0x1d8ecd[_0x5795a7(0x206)];_0x33f6cf++){const _0x412a1a=await bcryptjs_1[_0x5795a7(0x1f3)][_0x5795a7(0x1f4)](_0x3c558b,_0x1d8ecd[_0x33f6cf]);if(_0x412a1a){_0x209a54=!![],_0x1d8ecd[_0x5795a7(0x1fd)](_0x33f6cf,0x1),await database_1[_0x5795a7(0x1f3)][_0x5795a7(0x1fe)][_0x5795a7(0x1ed)]({'where':{'id':_0x69d63f},'data':{'backupCodes':JSON[_0x5795a7(0x20d)](_0x1d8ecd)}});break;}}}if(!_0x209a54)throw new Error(_0x5795a7(0x202));}}const _0x4f01bd=_0x5795a7(0x1cc)+crypto_1['default'][_0x5795a7(0x1d6)](0x20)['toString'](_0x5795a7(0x1d7)),_0x379449=_0x5795a7(0x1ec)+crypto_1['default']['randomBytes'](0x20)[_0x5795a7(0x1fa)](_0x5795a7(0x1d7));await database_1[_0x5795a7(0x1f3)]['shop'][_0x5795a7(0x1ed)]({'where':{'id':_0x69d63f},'data':{'publicKey':_0x4f01bd,'secretKey':_0x379449}});}async[a85_0x4b5fa3(0x1e6)](_0x4aae04,_0x4cd3f0){const _0x1396ed=a85_0x4b5fa3,{passwordConfirmation:_0x49f269}=_0x4cd3f0,_0x14edc5=await database_1['default'][_0x1396ed(0x1fe)][_0x1396ed(0x1c2)]({'where':{'id':_0x4aae04},'select':{'password':!![]}});if(!_0x14edc5)throw new Error(_0x1396ed(0x1f2));const _0x3c041f=await bcryptjs_1[_0x1396ed(0x1f3)][_0x1396ed(0x1f4)](_0x49f269,_0x14edc5[_0x1396ed(0x1de)]);if(!_0x3c041f)throw new Error(_0x1396ed(0x1e8));await database_1[_0x1396ed(0x1f3)][_0x1396ed(0x1fe)][_0x1396ed(0x1cf)]({'where':{'id':_0x4aae04}});}async[a85_0x4b5fa3(0x1bd)](_0x474f9f){const _0x1767ec=a85_0x4b5fa3,_0x438988=await database_1['default'][_0x1767ec(0x1c8)][_0x1767ec(0x1e2)]({'where':{'shopId':_0x474f9f,'isVerified':!![]},'orderBy':{'createdAt':'desc'},'select':{'id':!![],'telegramId':!![],'username':!![],'firstName':!![],'lastName':!![],'createdAt':!![]}});return _0x438988;}async[a85_0x4b5fa3(0x1e3)](_0x343879,_0x182de1){const _0x1ac7b2=a85_0x4b5fa3,_0x530154=await database_1['default'][_0x1ac7b2(0x1c8)]['findUnique']({'where':{'id':_0x182de1},'select':{'shopId':!![]}});if(!_0x530154)throw new Error('Telegram\x20session\x20not\x20found');if(_0x530154[_0x1ac7b2(0x1dc)]!==_0x343879)throw new Error(_0x1ac7b2(0x1e1));await database_1[_0x1ac7b2(0x1f3)]['telegramUser'][_0x1ac7b2(0x1ed)]({'where':{'id':_0x182de1},'data':{'shopId':null,'isVerified':![]}});}async[a85_0x4b5fa3(0x1ff)](_0x5602e5){const _0x3c66c2=a85_0x4b5fa3,_0x219276=await database_1['default'][_0x3c66c2(0x1ea)][_0x3c66c2(0x1c2)]({'where':{'shopId':_0x5602e5}});!_0x219276&&await database_1['default'][_0x3c66c2(0x1ea)][_0x3c66c2(0x205)]({'data':{'shopId':_0x5602e5}});}}exports[a85_0x4b5fa3(0x1e4)]=SettingsService;function a85_0x592a(){const _0x14bda3=['shopUrl','create','length','crypto','telegramChatId','payout','login','maskApiKey','notificationLogin','stringify','payment_failed','595TScfYC','botApiKey','getTelegramSessions','base32','7fCOspD','Current\x20password\x20is\x20incorrect','api_error','findUnique','81610lHCuPW','344EVatuA','8WWSIZd','hash','twoFactorSecret','telegramUser','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','22053ZjNSbo','3625137fdgodo','pk_','telegramUsers','updateNotifications','delete','totp','speakeasy','changePassword','__esModule','isArray','webhookUrl','randomBytes','hex','parse','454942JdzIYQ','payment_success','notificationPayout','shopId','webhookEvents','password','telegramBotApiKey','getShopSettings','Unauthorized\x20to\x20disconnect\x20this\x20session','findMany','disconnectTelegramSession','SettingsService','refund','deleteAccount','8635830qIvDHy','Password\x20confirmation\x20is\x20incorrect','2FA\x20token\x20is\x20required','shopSettings','backupCodes','sk_','update','updateWebhookSettings','notificationPaymentSuccess','twoFactorEnabled','notificationRefund','Shop\x20not\x20found','default','compare','parseWebhookEvents','notificationApiError','notificationPaymentFailed','revokeAllApiKeys','chatId','toString','substring','31825299saWNgX','splice','shop','ensureSettingsExist','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','updateTelegramSettings','Invalid\x202FA\x20token\x20or\x20backup\x20code','79506eFakZU'];a85_0x592a=function(){return _0x14bda3;};return a85_0x592a();}