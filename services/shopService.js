'use strict';const a53_0x1f478d=a53_0x424a;function a53_0x424a(_0x1708cb,_0x1ced2e){const _0x2ec510=a53_0x2ec5();return a53_0x424a=function(_0x424ac0,_0x5b9e06){_0x424ac0=_0x424ac0-0x107;let _0x4fa8f9=_0x2ec510[_0x424ac0];return _0x4fa8f9;},a53_0x424a(_0x1708cb,_0x1ced2e);}(function(_0x4a5f09,_0x390884){const _0x269f1e=a53_0x424a,_0x5a79ba=_0x4a5f09();while(!![]){try{const _0x3ed5c7=-parseInt(_0x269f1e(0x19e))/0x1+parseInt(_0x269f1e(0x131))/0x2*(parseInt(_0x269f1e(0x129))/0x3)+parseInt(_0x269f1e(0x168))/0x4*(-parseInt(_0x269f1e(0x10c))/0x5)+-parseInt(_0x269f1e(0x18c))/0x6+parseInt(_0x269f1e(0x12d))/0x7+-parseInt(_0x269f1e(0x14f))/0x8+-parseInt(_0x269f1e(0x15a))/0x9*(-parseInt(_0x269f1e(0x176))/0xa);if(_0x3ed5c7===_0x390884)break;else _0x5a79ba['push'](_0x5a79ba['shift']());}catch(_0x5a59db){_0x5a79ba['push'](_0x5a79ba['shift']());}}}(a53_0x2ec5,0xa0f8a));function a53_0x2ec5(){const _0x575d0c=['paid','periodFrom','getPaymentsByShop','29772ISpgMg','totalPaidOut','POST','getPayoutStats','delete','Webhook\x20returned\x20error:\x20','sourceCurrency','Error\x20parsing\x20webhook\x20events:','isArray','getPaymentById','...','__importDefault','Test\x20webhook\x20sent\x20successfully\x20(','toISOString','4Koqwsf','getDate','KLYME\x20GB','getTime','set','expiresAt','gatewaySettings','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','shopUrl','count','retryCount','setDate','../config/database','wallets','4010RkVjpj','shopId','convertToUSDT','revenue','amountUSDT','createdAt','CoinToPay','\x20\x20\x20üìÖ\x20This\x20month:\x20','statusCode','test','payout','./paymentService','paymentGateways','updateShopProfile','map','test_payment_123','findUnique','periodTo','error','testWebhook','getGatewayDisplayName','language','2614632hDmMBP','availableBalance','name','lte','90d','\x20\x20\x20üíµ\x20Available\x20balance:\x20','webhookEvents','getPayoutStatistics','update','shop','toUpperCase','ShopService','\x20USDT\x20(total\x20payouts)','polygon_usdc','txid','trc20','\x20USDT','gateways','665241qBGJEy','updatePayment','currency','Rapyd','USDT\x20BSC','amount','usdtTrcWallet','country','dailyRevenue','REJECTED','event','Noda','deletePayment','usdtErcWallet','fullName','aggregate','Payment\x20not\x20found','usdcPolygonWallet','defineProperty','status','erc20','createPayment','4169260ibcUcm','getFullYear','test_gateway','paidAt','\x20USDT\x20(current\x20balance)','Test\x20Gateway','paymentService','ceil','PENDING','statusText','awaitingPayout','all','gte','usdtPolygonWallet','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','telegram','polygon','USDC\x20Polygon','customerName','findMany','balance','notes','customerEmail','KLYME\x20DE','_sum','__esModule','reduce','PAID','getPaymentByShopAndId','37083MSnubb','parse','getPayouts','usage','3836679deblMJ','./currencyService','getPayments','findFirst','124MmVEyo','message','dailyPayments','amountIsEditable','30d','USDT\x20ERC20','network','gateway','log','payment','round','stringify','generateDailyStatistics','Plisio','getStatistics','webhookUrl','üìä\x20Shop\x20','getShopPayoutStats','redirectUrl','desc','get','merchantUrl','default','getMonth','push','Shop\x20not\x20found','KLYME\x20EU','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','Failed\x20to\x20send\x20webhook:\x20','getPayoutById','374272tOqUHC','COMPLETED','USDT\x20Polygon','settings','paymentId','filter','split','formatNetworkName'];a53_0x2ec5=function(){return _0x575d0c;};return a53_0x2ec5();}var __importDefault=this&&this[a53_0x1f478d(0x165)]||function(_0x4d7411){const _0x81e670=a53_0x1f478d;return _0x4d7411&&_0x4d7411[_0x81e670(0x125)]?_0x4d7411:{'default':_0x4d7411};};Object[a53_0x1f478d(0x108)](exports,a53_0x1f478d(0x125),{'value':!![]}),exports[a53_0x1f478d(0x197)]=void 0x0;const database_1=__importDefault(require(a53_0x1f478d(0x174))),currencyService_1=require(a53_0x1f478d(0x12e)),paymentService_1=require(a53_0x1f478d(0x181));class ShopService{constructor(){const _0x221289=a53_0x1f478d;this[_0x221289(0x112)]=new paymentService_1['PaymentService']();}async['getShopProfile'](_0x512c6d){const _0x28dfab=a53_0x1f478d,_0x102a4a=await database_1[_0x28dfab(0x147)][_0x28dfab(0x195)]['findUnique']({'where':{'id':_0x512c6d},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x102a4a)throw new Error('Shop\x20not\x20found');let _0x1db6b4=[];if(_0x102a4a[_0x28dfab(0x152)]?.[_0x28dfab(0x192)])try{_0x1db6b4=Array[_0x28dfab(0x162)](_0x102a4a[_0x28dfab(0x152)][_0x28dfab(0x192)])?_0x102a4a[_0x28dfab(0x152)][_0x28dfab(0x192)]:JSON['parse'](_0x102a4a[_0x28dfab(0x152)]['webhookEvents']);}catch(_0xdcc4bf){console['error'](_0x28dfab(0x161),_0xdcc4bf),_0x1db6b4=[];}return{'id':_0x102a4a['id'],'fullName':_0x102a4a['name'],'username':_0x102a4a['username'],'telegramId':_0x102a4a[_0x28dfab(0x11b)],'merchantUrl':_0x102a4a[_0x28dfab(0x170)],'gateways':_0x102a4a['paymentGateways']?JSON[_0x28dfab(0x12a)](_0x102a4a[_0x28dfab(0x182)]):null,'gatewaySettings':_0x102a4a['gatewaySettings']?JSON[_0x28dfab(0x12a)](_0x102a4a[_0x28dfab(0x16e)]):null,'publicKey':_0x102a4a['publicKey'],'webhookUrl':_0x102a4a[_0x28dfab(0x152)]?.[_0x28dfab(0x140)]||null,'webhookEvents':_0x1db6b4,'wallets':{'usdtPolygonWallet':_0x102a4a[_0x28dfab(0x119)],'usdtTrcWallet':_0x102a4a[_0x28dfab(0x1a4)],'usdtErcWallet':_0x102a4a[_0x28dfab(0x1ab)],'usdcPolygonWallet':_0x102a4a[_0x28dfab(0x107)]},'status':_0x102a4a[_0x28dfab(0x109)],'createdAt':_0x102a4a[_0x28dfab(0x17b)]};}async[a53_0x1f478d(0x183)](_0x333d1d,_0x6be1f5){const _0x4f4123=a53_0x1f478d,_0x879b7={};_0x6be1f5[_0x4f4123(0x1ac)]&&(_0x879b7[_0x4f4123(0x18e)]=_0x6be1f5[_0x4f4123(0x1ac)]);_0x6be1f5['telegramId']!==undefined&&(_0x879b7[_0x4f4123(0x11b)]=_0x6be1f5['telegramId']||null);_0x6be1f5[_0x4f4123(0x146)]&&(_0x879b7[_0x4f4123(0x170)]=_0x6be1f5['merchantUrl']);_0x6be1f5[_0x4f4123(0x19d)]&&(_0x879b7[_0x4f4123(0x182)]=JSON[_0x4f4123(0x13c)](_0x6be1f5[_0x4f4123(0x19d)]));_0x6be1f5[_0x4f4123(0x16e)]&&(_0x879b7[_0x4f4123(0x16e)]=JSON['stringify'](_0x6be1f5[_0x4f4123(0x16e)]));_0x6be1f5[_0x4f4123(0x175)]&&(_0x6be1f5[_0x4f4123(0x175)][_0x4f4123(0x119)]!==undefined&&(_0x879b7[_0x4f4123(0x119)]=_0x6be1f5[_0x4f4123(0x175)][_0x4f4123(0x119)]||null),_0x6be1f5[_0x4f4123(0x175)][_0x4f4123(0x1a4)]!==undefined&&(_0x879b7[_0x4f4123(0x1a4)]=_0x6be1f5['wallets'][_0x4f4123(0x1a4)]||null),_0x6be1f5[_0x4f4123(0x175)][_0x4f4123(0x1ab)]!==undefined&&(_0x879b7['usdtErcWallet']=_0x6be1f5[_0x4f4123(0x175)]['usdtErcWallet']||null),_0x6be1f5[_0x4f4123(0x175)]['usdcPolygonWallet']!==undefined&&(_0x879b7[_0x4f4123(0x107)]=_0x6be1f5['wallets'][_0x4f4123(0x107)]||null));const _0x562d30=await database_1[_0x4f4123(0x147)]['shop'][_0x4f4123(0x194)]({'where':{'id':_0x333d1d},'data':_0x879b7,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x209f17=[];if(_0x562d30['settings']?.[_0x4f4123(0x192)])try{_0x209f17=Array[_0x4f4123(0x162)](_0x562d30[_0x4f4123(0x152)][_0x4f4123(0x192)])?_0x562d30[_0x4f4123(0x152)][_0x4f4123(0x192)]:JSON[_0x4f4123(0x12a)](_0x562d30[_0x4f4123(0x152)][_0x4f4123(0x192)]);}catch(_0x196778){console[_0x4f4123(0x188)](_0x4f4123(0x161),_0x196778),_0x209f17=[];}return{'id':_0x562d30['id'],'fullName':_0x562d30[_0x4f4123(0x18e)],'username':_0x562d30['username'],'telegramId':_0x562d30['telegram'],'merchantUrl':_0x562d30[_0x4f4123(0x170)],'gateways':_0x562d30['paymentGateways']?JSON[_0x4f4123(0x12a)](_0x562d30['paymentGateways']):null,'gatewaySettings':_0x562d30[_0x4f4123(0x16e)]?JSON['parse'](_0x562d30[_0x4f4123(0x16e)]):null,'publicKey':_0x562d30['publicKey'],'webhookUrl':_0x562d30[_0x4f4123(0x152)]?.[_0x4f4123(0x140)]||null,'webhookEvents':_0x209f17,'wallets':{'usdtPolygonWallet':_0x562d30[_0x4f4123(0x119)],'usdtTrcWallet':_0x562d30['usdtTrcWallet'],'usdtErcWallet':_0x562d30[_0x4f4123(0x1ab)],'usdcPolygonWallet':_0x562d30['usdcPolygonWallet']},'status':_0x562d30[_0x4f4123(0x109)],'createdAt':_0x562d30[_0x4f4123(0x17b)]};}async['updateWallets'](_0x3d736c,_0x5947e2){const _0x438dcb=a53_0x1f478d,_0x5046b0={};_0x5947e2[_0x438dcb(0x119)]!==undefined&&(_0x5046b0[_0x438dcb(0x119)]=_0x5947e2[_0x438dcb(0x119)]||null),_0x5947e2[_0x438dcb(0x1a4)]!==undefined&&(_0x5046b0[_0x438dcb(0x1a4)]=_0x5947e2[_0x438dcb(0x1a4)]||null),_0x5947e2[_0x438dcb(0x1ab)]!==undefined&&(_0x5046b0[_0x438dcb(0x1ab)]=_0x5947e2['usdtErcWallet']||null),_0x5947e2['usdcPolygonWallet']!==undefined&&(_0x5046b0[_0x438dcb(0x107)]=_0x5947e2['usdcPolygonWallet']||null),await database_1[_0x438dcb(0x147)][_0x438dcb(0x195)][_0x438dcb(0x194)]({'where':{'id':_0x3d736c},'data':_0x5046b0});}async[a53_0x1f478d(0x189)](_0x1b2e32){const _0x9f7a6d=a53_0x1f478d,_0x2ff21a=await database_1['default']['shop'][_0x9f7a6d(0x186)]({'where':{'id':_0x1b2e32},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x2ff21a?.[_0x9f7a6d(0x152)]?.[_0x9f7a6d(0x140)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x16b379={'event':_0x9f7a6d(0x17f),'payment':{'id':_0x9f7a6d(0x185),'order_id':'test_order_123','gateway':_0x9f7a6d(0x17f),'amount':0x64,'currency':'USD','status':_0x9f7a6d(0x157),'created_at':new Date()['toISOString']()}};try{const _0x3f89cc=await fetch(_0x2ff21a[_0x9f7a6d(0x152)][_0x9f7a6d(0x140)],{'method':_0x9f7a6d(0x15c),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON['stringify'](_0x16b379)});return _0x3f89cc['ok']?{'success':!![],'message':_0x9f7a6d(0x166)+_0x3f89cc[_0x9f7a6d(0x109)]+')'}:{'success':![],'message':_0x9f7a6d(0x15f)+_0x3f89cc[_0x9f7a6d(0x109)]+'\x20'+_0x3f89cc[_0x9f7a6d(0x115)]};}catch(_0x1fe756){return{'success':![],'message':_0x9f7a6d(0x14d)+(_0x1fe756 instanceof Error?_0x1fe756[_0x9f7a6d(0x132)]:'Unknown\x20error')};}}async[a53_0x1f478d(0x10b)](_0xaf1d38){const _0x26ef72=a53_0x1f478d;return this['paymentService']['createPublicPayment']({'public_key':'','gateway':_0xaf1d38[_0x26ef72(0x138)],'order_id':undefined,'amount':_0xaf1d38[_0x26ef72(0x1a3)],'currency':_0xaf1d38['currency'],'source_currency':_0xaf1d38[_0x26ef72(0x160)],'usage':_0xaf1d38[_0x26ef72(0x12c)],'expires_at':_0xaf1d38[_0x26ef72(0x16d)]?.[_0x26ef72(0x167)](),'success_url':_0xaf1d38[_0x26ef72(0x143)],'fail_url':_0xaf1d38[_0x26ef72(0x143)],'customer_email':_0xaf1d38[_0x26ef72(0x122)],'customer_name':_0xaf1d38[_0x26ef72(0x11e)],'country':_0xaf1d38[_0x26ef72(0x1a5)],'language':_0xaf1d38[_0x26ef72(0x18b)],'amount_is_editable':_0xaf1d38[_0x26ef72(0x134)],'max_payments':_0xaf1d38['maxPayments'],'customer':_0xaf1d38['customer']});}async[a53_0x1f478d(0x12f)](_0x45b217,_0x5ca731){const _0x1710bd=a53_0x1f478d;return this['paymentService'][_0x1710bd(0x159)](_0x45b217,_0x5ca731);}async[a53_0x1f478d(0x163)](_0x504e08,_0x2b7246){const _0x5f1c53=a53_0x1f478d;return this['paymentService'][_0x5f1c53(0x128)](_0x504e08,_0x2b7246);}async[a53_0x1f478d(0x19f)](_0x469d07,_0x3b088b,_0x16bc4d){const _0x35b69c=a53_0x1f478d,_0x3d4147=await database_1[_0x35b69c(0x147)][_0x35b69c(0x13a)][_0x35b69c(0x130)]({'where':{'id':_0x3b088b,'shopId':_0x469d07}});if(!_0x3d4147)throw new Error(_0x35b69c(0x1ae));const _0x5ae481=await database_1[_0x35b69c(0x147)][_0x35b69c(0x13a)][_0x35b69c(0x194)]({'where':{'id':_0x3b088b},'data':{..._0x16bc4d,'updatedAt':new Date()}});return _0x5ae481;}async[a53_0x1f478d(0x1aa)](_0x169367,_0x2a0a16){const _0x5b56e1=a53_0x1f478d,_0x25bc9d=await database_1[_0x5b56e1(0x147)][_0x5b56e1(0x13a)][_0x5b56e1(0x130)]({'where':{'id':_0x2a0a16,'shopId':_0x169367}});if(!_0x25bc9d)throw new Error(_0x5b56e1(0x1ae));await database_1[_0x5b56e1(0x147)]['payment'][_0x5b56e1(0x15e)]({'where':{'id':_0x2a0a16}});}['formatNetworkName'](_0x1dd0eb){const _0x20b8c2=a53_0x1f478d,_0x4e33a1={'polygon':_0x20b8c2(0x151),'trc20':'USDT\x20TRC20','erc20':_0x20b8c2(0x136),'bsc':_0x20b8c2(0x1a2),'polygon_usdc':_0x20b8c2(0x11d)};return _0x4e33a1[_0x1dd0eb]||_0x1dd0eb;}async[a53_0x1f478d(0x12b)](_0x531b04,_0xd9d03e){const _0x64cc28=a53_0x1f478d,{page:_0x13aba4,limit:_0x3f00de,status:_0x33eef3,method:_0x3240d9,dateFrom:_0x56a99b,dateTo:_0x407cdb,periodFrom:_0x492e3e,periodTo:_0xef86b7}=_0xd9d03e,_0x10c88d=(_0x13aba4-0x1)*_0x3f00de,_0x5e4636={'shopId':_0x531b04};_0x33eef3&&(_0x5e4636[_0x64cc28(0x109)]=_0x33eef3[_0x64cc28(0x196)]());_0x3240d9&&(_0x5e4636[_0x64cc28(0x137)]=_0x3240d9);if(_0x56a99b||_0x407cdb||_0x492e3e||_0xef86b7){_0x5e4636['createdAt']={};if(_0x492e3e)_0x5e4636[_0x64cc28(0x17b)][_0x64cc28(0x118)]=new Date(_0x492e3e);else _0x56a99b&&(_0x5e4636[_0x64cc28(0x17b)][_0x64cc28(0x118)]=new Date(_0x56a99b));if(_0xef86b7)_0x5e4636['createdAt'][_0x64cc28(0x18f)]=new Date(_0xef86b7);else _0x407cdb&&(_0x5e4636[_0x64cc28(0x17b)][_0x64cc28(0x18f)]=new Date(_0x407cdb));}const [_0x3f1598,_0x103b0a]=await Promise['all']([database_1[_0x64cc28(0x147)][_0x64cc28(0x180)][_0x64cc28(0x11f)]({'where':_0x5e4636,'skip':_0x10c88d,'take':_0x3f00de,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default'][_0x64cc28(0x180)][_0x64cc28(0x171)]({'where':_0x5e4636})]);return{'payouts':_0x3f1598['map'](_0x3e162b=>{const _0x1d31da=_0x64cc28;let _0x35c4f0=null;switch(_0x3e162b[_0x1d31da(0x137)]){case _0x1d31da(0x11c):_0x35c4f0=_0x3e162b['shop']['usdtPolygonWallet'];break;case _0x1d31da(0x19b):_0x35c4f0=_0x3e162b['shop']['usdtTrcWallet'];break;case _0x1d31da(0x10a):_0x35c4f0=_0x3e162b[_0x1d31da(0x195)][_0x1d31da(0x1ab)];break;case _0x1d31da(0x199):_0x35c4f0=_0x3e162b['shop'][_0x1d31da(0x107)];break;}return{'id':_0x3e162b['id'],'amount':_0x3e162b[_0x1d31da(0x1a3)],'network':this[_0x1d31da(0x156)](_0x3e162b[_0x1d31da(0x137)]),'wallet':_0x35c4f0,'status':_0x3e162b['status'],'txid':_0x3e162b[_0x1d31da(0x19a)],'notes':_0x3e162b[_0x1d31da(0x121)],'periodFrom':_0x3e162b[_0x1d31da(0x158)],'periodTo':_0x3e162b[_0x1d31da(0x187)],'createdAt':_0x3e162b[_0x1d31da(0x17b)],'paidAt':_0x3e162b[_0x1d31da(0x10f)]};}),'pagination':{'page':_0x13aba4,'limit':_0x3f00de,'total':_0x103b0a,'totalPages':Math['ceil'](_0x103b0a/_0x3f00de)}};}async[a53_0x1f478d(0x14e)](_0x1001b0,_0x42dfdc){const _0x3b4350=a53_0x1f478d,_0x4a05d9=await database_1[_0x3b4350(0x147)][_0x3b4350(0x180)][_0x3b4350(0x130)]({'where':{'id':_0x42dfdc,'shopId':_0x1001b0}});if(!_0x4a05d9)return null;return{'id':_0x4a05d9['id'],'amount':_0x4a05d9[_0x3b4350(0x1a3)],'network':_0x4a05d9[_0x3b4350(0x137)],'status':_0x4a05d9[_0x3b4350(0x109)],'txid':_0x4a05d9['txid'],'notes':_0x4a05d9['notes'],'createdAt':_0x4a05d9[_0x3b4350(0x17b)],'paidAt':_0x4a05d9['paidAt']};}async[a53_0x1f478d(0x193)](_0x471cd6,_0x368e91){const _0x12ebdc=a53_0x1f478d,_0x34e253=new Date();let _0x15009a;switch(_0x368e91){case'7d':_0x15009a=new Date(_0x34e253[_0x12ebdc(0x16b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x12ebdc(0x135):_0x15009a=new Date(_0x34e253[_0x12ebdc(0x16b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x12ebdc(0x190):_0x15009a=new Date(_0x34e253[_0x12ebdc(0x16b)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x15009a=new Date(_0x34e253[_0x12ebdc(0x16b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x141909,_0x1aa5fb,_0xca0d58,_0x17ecbd,_0x46c26b,_0x47ef32]=await Promise[_0x12ebdc(0x117)]([database_1[_0x12ebdc(0x147)][_0x12ebdc(0x180)][_0x12ebdc(0x171)]({'where':{'shopId':_0x471cd6,'createdAt':{'gte':_0x15009a}}}),database_1[_0x12ebdc(0x147)]['payout'][_0x12ebdc(0x171)]({'where':{'shopId':_0x471cd6,'status':_0x12ebdc(0x150),'createdAt':{'gte':_0x15009a}}}),database_1[_0x12ebdc(0x147)][_0x12ebdc(0x180)][_0x12ebdc(0x171)]({'where':{'shopId':_0x471cd6,'status':_0x12ebdc(0x114),'createdAt':{'gte':_0x15009a}}}),database_1[_0x12ebdc(0x147)][_0x12ebdc(0x180)]['count']({'where':{'shopId':_0x471cd6,'status':_0x12ebdc(0x1a7),'createdAt':{'gte':_0x15009a}}}),database_1['default']['payout'][_0x12ebdc(0x11f)]({'where':{'shopId':_0x471cd6,'createdAt':{'gte':_0x15009a}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x12ebdc(0x147)][_0x12ebdc(0x180)][_0x12ebdc(0x11f)]({'where':{'shopId':_0x471cd6},'take':0xa,'orderBy':{'createdAt':_0x12ebdc(0x144)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x3680cb=_0x46c26b[_0x12ebdc(0x126)]((_0xf3b3c4,_0x3dfbd9)=>_0xf3b3c4+_0x3dfbd9[_0x12ebdc(0x1a3)],0x0),_0x6d8ae6=_0x46c26b['filter'](_0x152ed8=>_0x152ed8['status']==='COMPLETED')[_0x12ebdc(0x126)]((_0xdfa423,_0x3b84d3)=>_0xdfa423+_0x3b84d3[_0x12ebdc(0x1a3)],0x0),_0xa95565=_0x46c26b[_0x12ebdc(0x154)](_0x2a691b=>_0x2a691b[_0x12ebdc(0x109)]==='PENDING')[_0x12ebdc(0x126)]((_0x1e7b2a,_0x100ba0)=>_0x1e7b2a+_0x100ba0[_0x12ebdc(0x1a3)],0x0),_0x3d0e44=_0x46c26b[_0x12ebdc(0x126)]((_0x989af1,_0x282a2d)=>{const _0x3bf3a1=_0x12ebdc;return _0x989af1[_0x282a2d[_0x3bf3a1(0x137)]]=(_0x989af1[_0x282a2d[_0x3bf3a1(0x137)]]||0x0)+0x1,_0x989af1;},{}),_0x3a43e3=_0x46c26b['reduce']((_0xd0256b,_0x485380)=>{const _0x8e3bd2=_0x12ebdc;return _0xd0256b[_0x485380[_0x8e3bd2(0x109)]]=(_0xd0256b[_0x485380[_0x8e3bd2(0x109)]]||0x0)+0x1,_0xd0256b;},{});return{'totalPayouts':_0x141909,'completedPayouts':_0x1aa5fb,'pendingPayouts':_0xca0d58,'rejectedPayouts':_0x17ecbd,'totalAmount':_0x3680cb,'completedAmount':_0x6d8ae6,'pendingAmount':_0xa95565,'payoutsByMethod':_0x3d0e44,'payoutsByStatus':_0x3a43e3,'recentPayouts':_0x47ef32['map'](_0x32b151=>({'id':_0x32b151['id'],'shopId':_0x471cd6,'amount':_0x32b151[_0x12ebdc(0x1a3)],'method':_0x32b151[_0x12ebdc(0x137)],'status':_0x32b151[_0x12ebdc(0x109)],'txid':_0x32b151[_0x12ebdc(0x19a)],'createdAt':_0x32b151[_0x12ebdc(0x17b)],'paidAt':_0x32b151[_0x12ebdc(0x10f)]}))};}async[a53_0x1f478d(0x142)](_0x28b19d){const _0x3b9fd0=a53_0x1f478d;console[_0x3b9fd0(0x139)](_0x3b9fd0(0x16f)+_0x28b19d+_0x3b9fd0(0x164));const _0x4dba45=await database_1[_0x3b9fd0(0x147)][_0x3b9fd0(0x195)][_0x3b9fd0(0x186)]({'where':{'id':_0x28b19d},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x4dba45)throw new Error(_0x3b9fd0(0x14a));const _0x1e5506=new Date(),_0x211b65=new Date(_0x1e5506[_0x3b9fd0(0x10d)](),_0x1e5506[_0x3b9fd0(0x148)](),0x1),_0x5f04c7=new Date(_0x1e5506[_0x3b9fd0(0x10d)](),_0x1e5506[_0x3b9fd0(0x148)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x246b13=await database_1['default'][_0x3b9fd0(0x180)][_0x3b9fd0(0x1ad)]({'_sum':{'amount':!![]},'where':{'shopId':_0x28b19d,'createdAt':{'gte':_0x211b65,'lte':_0x5f04c7},'status':_0x3b9fd0(0x150)}}),_0x21af87=_0x246b13[_0x3b9fd0(0x124)][_0x3b9fd0(0x1a3)]||0x0,_0x1edbaf={'availableBalance':Math[_0x3b9fd0(0x13b)](_0x4dba45['balance']*0x64)/0x64,'totalPaidOut':Math[_0x3b9fd0(0x13b)](_0x4dba45['totalPaidOut']*0x64)/0x64,'awaitingPayout':Math[_0x3b9fd0(0x13b)](_0x4dba45[_0x3b9fd0(0x120)]*0x64)/0x64,'thisMonth':Math['round'](_0x21af87*0x64)/0x64};return console['log'](_0x3b9fd0(0x141)+_0x4dba45['username']+'\x20payout\x20statistics\x20calculated:'),console[_0x3b9fd0(0x139)](_0x3b9fd0(0x191)+_0x1edbaf[_0x3b9fd0(0x18d)]+'\x20USDT\x20(current\x20balance)'),console['log'](_0x3b9fd0(0x11a)+_0x1edbaf[_0x3b9fd0(0x15b)]+_0x3b9fd0(0x198)),console['log'](_0x3b9fd0(0x14c)+_0x1edbaf[_0x3b9fd0(0x116)]+_0x3b9fd0(0x110)),console[_0x3b9fd0(0x139)](_0x3b9fd0(0x17d)+_0x1edbaf['thisMonth']+_0x3b9fd0(0x19c)),_0x1edbaf;}[a53_0x1f478d(0x18a)](_0x3bfc22){const _0xfc0525=a53_0x1f478d,_0x59d069={'test_gateway':_0xfc0525(0x111),'plisio':_0xfc0525(0x13e),'rapyd':_0xfc0525(0x1a1),'noda':_0xfc0525(0x1a9),'cointopay':_0xfc0525(0x17c),'klyme_eu':_0xfc0525(0x14b),'klyme_gb':_0xfc0525(0x16a),'klyme_de':_0xfc0525(0x123)};return _0x59d069[_0x3bfc22]||_0x3bfc22;}async[a53_0x1f478d(0x15d)](_0x472ca4){return this['getShopPayoutStats'](_0x472ca4);}async['getWebhookLogs'](_0x6ebedb,_0x225b2d){const _0x126d76=a53_0x1f478d,{page:_0x310857,limit:_0x5bad7a,paymentId:_0x6b1ba8}=_0x225b2d,_0x488455=(_0x310857-0x1)*_0x5bad7a,_0x3deb89={'shopId':_0x6ebedb};_0x6b1ba8&&(_0x3deb89[_0x126d76(0x153)]=_0x6b1ba8);const [_0x27d913,_0x341918]=await Promise[_0x126d76(0x117)]([database_1[_0x126d76(0x147)]['webhookLog'][_0x126d76(0x11f)]({'where':_0x3deb89,'skip':_0x488455,'take':_0x5bad7a,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x126d76(0x147)]['webhookLog']['count']({'where':_0x3deb89})]);return{'logs':_0x27d913[_0x126d76(0x184)](_0x60426c=>({'id':_0x60426c['id'],'paymentId':_0x60426c['paymentId'],'shopId':_0x60426c[_0x126d76(0x177)],'event':_0x60426c[_0x126d76(0x1a8)],'statusCode':_0x60426c[_0x126d76(0x17e)],'retryCount':_0x60426c[_0x126d76(0x172)],'responseBody':_0x60426c['responseBody'],'createdAt':_0x60426c['createdAt'],'payment':_0x60426c[_0x126d76(0x13a)]})),'pagination':{'page':_0x310857,'limit':_0x5bad7a,'total':_0x341918,'totalPages':Math[_0x126d76(0x113)](_0x341918/_0x5bad7a)}};}async[a53_0x1f478d(0x13f)](_0x3dc1f5,_0x2494a1){const _0x432236=a53_0x1f478d,_0x28493a=new Date();let _0x564b16;switch(_0x2494a1){case'7d':_0x564b16=new Date(_0x28493a[_0x432236(0x16b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x432236(0x135):_0x564b16=new Date(_0x28493a['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x432236(0x190):_0x564b16=new Date(_0x28493a['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x564b16=new Date(_0x28493a[_0x432236(0x16b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x22d8af,_0x528430,_0x5d1eae,_0x1c30e7,_0x6f85c4]=await Promise[_0x432236(0x117)]([database_1['default'][_0x432236(0x13a)][_0x432236(0x171)]({'where':{'shopId':_0x3dc1f5,'gateway':{'not':_0x432236(0x10e)},'createdAt':{'gte':_0x564b16}}}),database_1[_0x432236(0x147)][_0x432236(0x13a)][_0x432236(0x171)]({'where':{'shopId':_0x3dc1f5,'gateway':{'not':_0x432236(0x10e)},'status':_0x432236(0x127),'createdAt':{'gte':_0x564b16}}}),database_1['default'][_0x432236(0x13a)][_0x432236(0x11f)]({'where':{'shopId':_0x3dc1f5,'gateway':{'not':_0x432236(0x10e)},'status':_0x432236(0x127),'createdAt':{'gte':_0x564b16}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x432236(0x147)][_0x432236(0x13a)][_0x432236(0x11f)]({'where':{'shopId':_0x3dc1f5,'gateway':{'not':'test_gateway'}},'take':0xa,'orderBy':{'createdAt':_0x432236(0x144)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x432236(0x13a)][_0x432236(0x11f)]({'where':{'shopId':_0x3dc1f5,'gateway':{'not':_0x432236(0x10e)},'createdAt':{'gte':_0x564b16}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x341594=0x0;for(const _0x285cc7 of _0x5d1eae){if(_0x285cc7[_0x432236(0x17a)])_0x341594+=_0x285cc7[_0x432236(0x17a)];else{const _0x12f48d=await currencyService_1['currencyService'][_0x432236(0x178)](_0x285cc7[_0x432236(0x1a3)],_0x285cc7[_0x432236(0x1a0)]);_0x341594+=_0x12f48d;}}const _0x3d953d=this[_0x432236(0x13d)](_0x6f85c4,_0x564b16,_0x28493a),_0x1d9c7f=_0x22d8af>0x0?_0x528430/_0x22d8af*0x64:0x0;return{'totalPayments':_0x22d8af,'successfulPayments':_0x528430,'totalRevenue':Math[_0x432236(0x13b)](_0x341594*0x64)/0x64,'conversionRate':Math[_0x432236(0x13b)](_0x1d9c7f*0x64)/0x64,'dailyRevenue':_0x3d953d[_0x432236(0x1a6)],'dailyPayments':_0x3d953d[_0x432236(0x133)],'recentPayments':_0x1c30e7[_0x432236(0x184)](_0x47e3b6=>({'id':_0x47e3b6['id'],'gateway':_0x47e3b6[_0x432236(0x138)],'amount':_0x47e3b6[_0x432236(0x1a3)],'currency':_0x47e3b6[_0x432236(0x1a0)],'status':_0x47e3b6[_0x432236(0x109)],'createdAt':_0x47e3b6[_0x432236(0x17b)]}))};}[a53_0x1f478d(0x13d)](_0x11fa49,_0x580780,_0x1109c1){const _0x20d477=a53_0x1f478d,_0x3b4140=new Map(),_0x1a01ec=new Date(_0x580780);while(_0x1a01ec<=_0x1109c1){const _0xa0b235=_0x1a01ec[_0x20d477(0x167)]()['split']('T')[0x0];_0x3b4140[_0x20d477(0x16c)](_0xa0b235,{'revenue':0x0,'count':0x0}),_0x1a01ec[_0x20d477(0x173)](_0x1a01ec[_0x20d477(0x169)]()+0x1);}for(const _0x165d4b of _0x11fa49){const _0x1208cc=_0x165d4b['createdAt'][_0x20d477(0x167)]()[_0x20d477(0x155)]('T')[0x0],_0x565caf=_0x3b4140[_0x20d477(0x145)](_0x1208cc);_0x565caf&&(_0x565caf['count']+=0x1,_0x165d4b[_0x20d477(0x109)]===_0x20d477(0x127)&&_0x165d4b[_0x20d477(0x17a)]&&(_0x565caf[_0x20d477(0x179)]+=_0x165d4b[_0x20d477(0x17a)]));}const _0x903899=[],_0x3d0df0=[];for(const [_0x543081,_0x56701c]of _0x3b4140){_0x903899[_0x20d477(0x149)]({'date':_0x543081,'amount':Math[_0x20d477(0x13b)](_0x56701c[_0x20d477(0x179)]*0x64)/0x64}),_0x3d0df0[_0x20d477(0x149)]({'date':_0x543081,'count':_0x56701c[_0x20d477(0x171)]});}return{'dailyRevenue':_0x903899,'dailyPayments':_0x3d0df0};}}exports['ShopService']=ShopService;