'use strict';const a60_0x727ff3=a60_0x428f;(function(_0x403d70,_0x4aacc2){const _0x327b54=a60_0x428f,_0x11eb5f=_0x403d70();while(!![]){try{const _0x1c9cad=-parseInt(_0x327b54(0x163))/0x1*(parseInt(_0x327b54(0x174))/0x2)+parseInt(_0x327b54(0x12f))/0x3*(-parseInt(_0x327b54(0x111))/0x4)+parseInt(_0x327b54(0x11b))/0x5+-parseInt(_0x327b54(0x194))/0x6+-parseInt(_0x327b54(0x110))/0x7*(parseInt(_0x327b54(0x118))/0x8)+parseInt(_0x327b54(0x124))/0x9+-parseInt(_0x327b54(0x176))/0xa*(-parseInt(_0x327b54(0x142))/0xb);if(_0x1c9cad===_0x4aacc2)break;else _0x11eb5f['push'](_0x11eb5f['shift']());}catch(_0x6e3d2c){_0x11eb5f['push'](_0x11eb5f['shift']());}}}(a60_0x4ace,0x954d6));function a60_0x4ace(){const _0x58e8fc=['Failed\x20to\x20send\x20webhook:\x20','test_gateway','üåê\x20Network\x20filter:\x20','application/json','getFullYear','status','toISOString','83363jStGMe','3451772vckXZU','telegramId','USD','amount','getPayoutById','lte','responseBody','776tgDhAQ','getGatewayDisplayName','usdtErcWallet','1743520EweAyW','toLowerCase','Plisio','KLYME\x20EU','push','log','\x20payout\x20statistics\x20calculated:','usage','createdAt','5354541VwAaVy','paymentId','erc20','currencyService','all','merchantUrl','webhookUrl','desc','createPublicPayment','shopId','üìÖ\x20Date\x20end:\x20','3QLxmEC','error','get','KLYME\x20DE','wallets','stringify','üåê\x20Method\x20filter:\x20','paymentGateways','parse','getPayments','toUpperCase','\x20USDT\x20(total\x20payouts)','findMany','periodTo','_sum','gateway','settings','90d','maxPayments','3047682gojROB','getStatistics','Payment\x20not\x20found','Shop\x20not\x20found','notes','language','üìä\x20Status\x20filter:\x20','customer','getShopProfile','testWebhook','No\x20webhook\x20URL\x20configured','update','gatewaySettings','COMPLETED','getMonth','count','reduce','usdtPolygonWallet','periodFrom','usdtTrcWallet','Error\x20parsing\x20webhook\x20events:','country','username','USDT\x20BSC','statusText','expiresAt','USDT\x20TRC20','üìÖ\x20Date\x20start:\x20','USDT\x20ERC20','payment','yesterday','fullName','map','1fBlCqW','__esModule','test','\x20USDT\x20(current\x20balance)','gateways','Test\x20Gateway','webhookEvents','polygon_usdc','txid','createPayment','Rapyd','Test\x20webhook\x20sent\x20successfully\x20(','__importDefault','getPayoutStats','\x20\x20\x20üìÖ\x20This\x20month:\x20','split','usdcPolygonWallet','762946exizeY','filter','100AIlqzG','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','awaitingPayout','name','redirectUrl','üìÖ\x20Period\x20end:\x20','amountUSDT','day','ShopService','YESTERDAY','network','shopUrl','findUnique','Webhook\x20returned\x20error:\x20','dailyPayments','setDate','totalPaidOut','revenue','getDate','shop','findFirst','üìÖ\x20Period\x20start:\x20','setHours','trc20','paidAt','dailyRevenue','publicKey','availableBalance','telegram','TesSoft\x20Payment\x20System/1.0\x20(Test)','4218852xfSqDF','test_payment_123','...','customerEmail','getTime','üí∞\x20Getting\x20payouts\x20with\x20filters:','getPaymentsByShop','getWebhookLogs','REJECTED','../config/database','thisMonth','generateDailyStatistics','balance','paymentService','test_order_123','KLYME\x20GB','30d','convertToUSDT','Unknown\x20error','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','webhookLog','paid','./currencyService','retryCount','set','payout','PaymentService','PAID','round','gte','formatNetworkName','updatePayment','sourceCurrency','polygon','asc','amountIsEditable','default','getShopPayoutStats','getPayouts'];a60_0x4ace=function(){return _0x58e8fc;};return a60_0x4ace();}var __importDefault=this&&this[a60_0x727ff3(0x16f)]||function(_0x48110d){const _0x18b0c8=a60_0x727ff3;return _0x48110d&&_0x48110d[_0x18b0c8(0x164)]?_0x48110d:{'default':_0x48110d};};function a60_0x428f(_0x288e1b,_0xdf33ae){const _0x4ace6d=a60_0x4ace();return a60_0x428f=function(_0x428f68,_0xbd959c){_0x428f68=_0x428f68-0xf3;let _0xa685fd=_0x4ace6d[_0x428f68];return _0xa685fd;},a60_0x428f(_0x288e1b,_0xdf33ae);}Object['defineProperty'](exports,a60_0x727ff3(0x164),{'value':!![]}),exports[a60_0x727ff3(0x17e)]=void 0x0;const database_1=__importDefault(require(a60_0x727ff3(0x19d))),currencyService_1=require(a60_0x727ff3(0xf8)),paymentService_1=require('./paymentService');class ShopService{constructor(){const _0x438ed8=a60_0x727ff3;this['paymentService']=new paymentService_1[(_0x438ed8(0xfc))]();}async[a60_0x727ff3(0x14a)](_0x1b28d7){const _0x4e8e75=a60_0x727ff3,_0x4698ad=await database_1[_0x4e8e75(0x106)][_0x4e8e75(0x189)][_0x4e8e75(0x182)]({'where':{'id':_0x1b28d7},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x4698ad)throw new Error(_0x4e8e75(0x145));let _0x599c31=[];if(_0x4698ad['settings']?.[_0x4e8e75(0x169)])try{_0x599c31=Array['isArray'](_0x4698ad['settings'][_0x4e8e75(0x169)])?_0x4698ad[_0x4e8e75(0x13f)]['webhookEvents']:JSON[_0x4e8e75(0x137)](_0x4698ad[_0x4e8e75(0x13f)][_0x4e8e75(0x169)]);}catch(_0x21b530){console[_0x4e8e75(0x130)](_0x4e8e75(0x156),_0x21b530),_0x599c31=[];}return{'id':_0x4698ad['id'],'fullName':_0x4698ad[_0x4e8e75(0x179)],'username':_0x4698ad[_0x4e8e75(0x158)],'telegramId':_0x4698ad['telegram'],'merchantUrl':_0x4698ad[_0x4e8e75(0x181)],'gateways':_0x4698ad[_0x4e8e75(0x136)]?JSON[_0x4e8e75(0x137)](_0x4698ad[_0x4e8e75(0x136)]):null,'gatewaySettings':_0x4698ad[_0x4e8e75(0x14e)]?JSON[_0x4e8e75(0x137)](_0x4698ad[_0x4e8e75(0x14e)]):null,'publicKey':_0x4698ad[_0x4e8e75(0x190)],'webhookUrl':_0x4698ad[_0x4e8e75(0x13f)]?.['webhookUrl']||null,'webhookEvents':_0x599c31,'wallets':{'usdtPolygonWallet':_0x4698ad[_0x4e8e75(0x153)],'usdtTrcWallet':_0x4698ad[_0x4e8e75(0x155)],'usdtErcWallet':_0x4698ad[_0x4e8e75(0x11a)],'usdcPolygonWallet':_0x4698ad['usdcPolygonWallet']},'status':_0x4698ad[_0x4e8e75(0x10e)],'createdAt':_0x4698ad['createdAt']};}async['updateShopProfile'](_0x39a710,_0x47f38b){const _0x21b5af=a60_0x727ff3,_0x2cbc68={};_0x47f38b[_0x21b5af(0x161)]&&(_0x2cbc68['name']=_0x47f38b[_0x21b5af(0x161)]);_0x47f38b[_0x21b5af(0x112)]!==undefined&&(_0x2cbc68[_0x21b5af(0x192)]=_0x47f38b[_0x21b5af(0x112)]||null);_0x47f38b['merchantUrl']&&(_0x2cbc68[_0x21b5af(0x181)]=_0x47f38b[_0x21b5af(0x129)]);_0x47f38b[_0x21b5af(0x167)]&&(_0x2cbc68['paymentGateways']=JSON[_0x21b5af(0x134)](_0x47f38b[_0x21b5af(0x167)]));_0x47f38b[_0x21b5af(0x14e)]&&(_0x2cbc68[_0x21b5af(0x14e)]=JSON['stringify'](_0x47f38b[_0x21b5af(0x14e)]));_0x47f38b['wallets']&&(_0x47f38b[_0x21b5af(0x133)][_0x21b5af(0x153)]!==undefined&&(_0x2cbc68[_0x21b5af(0x153)]=_0x47f38b['wallets']['usdtPolygonWallet']||null),_0x47f38b[_0x21b5af(0x133)][_0x21b5af(0x155)]!==undefined&&(_0x2cbc68['usdtTrcWallet']=_0x47f38b[_0x21b5af(0x133)][_0x21b5af(0x155)]||null),_0x47f38b[_0x21b5af(0x133)]['usdtErcWallet']!==undefined&&(_0x2cbc68[_0x21b5af(0x11a)]=_0x47f38b[_0x21b5af(0x133)][_0x21b5af(0x11a)]||null),_0x47f38b['wallets'][_0x21b5af(0x173)]!==undefined&&(_0x2cbc68[_0x21b5af(0x173)]=_0x47f38b['wallets'][_0x21b5af(0x173)]||null));const _0x47eab9=await database_1[_0x21b5af(0x106)][_0x21b5af(0x189)][_0x21b5af(0x14d)]({'where':{'id':_0x39a710},'data':_0x2cbc68,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x685b2e=[];if(_0x47eab9[_0x21b5af(0x13f)]?.['webhookEvents'])try{_0x685b2e=Array['isArray'](_0x47eab9[_0x21b5af(0x13f)][_0x21b5af(0x169)])?_0x47eab9['settings'][_0x21b5af(0x169)]:JSON[_0x21b5af(0x137)](_0x47eab9[_0x21b5af(0x13f)][_0x21b5af(0x169)]);}catch(_0x2b69db){console[_0x21b5af(0x130)]('Error\x20parsing\x20webhook\x20events:',_0x2b69db),_0x685b2e=[];}return{'id':_0x47eab9['id'],'fullName':_0x47eab9[_0x21b5af(0x179)],'username':_0x47eab9[_0x21b5af(0x158)],'telegramId':_0x47eab9[_0x21b5af(0x192)],'merchantUrl':_0x47eab9[_0x21b5af(0x181)],'gateways':_0x47eab9[_0x21b5af(0x136)]?JSON[_0x21b5af(0x137)](_0x47eab9[_0x21b5af(0x136)]):null,'gatewaySettings':_0x47eab9[_0x21b5af(0x14e)]?JSON['parse'](_0x47eab9[_0x21b5af(0x14e)]):null,'publicKey':_0x47eab9['publicKey'],'webhookUrl':_0x47eab9[_0x21b5af(0x13f)]?.[_0x21b5af(0x12a)]||null,'webhookEvents':_0x685b2e,'wallets':{'usdtPolygonWallet':_0x47eab9[_0x21b5af(0x153)],'usdtTrcWallet':_0x47eab9[_0x21b5af(0x155)],'usdtErcWallet':_0x47eab9[_0x21b5af(0x11a)],'usdcPolygonWallet':_0x47eab9[_0x21b5af(0x173)]},'status':_0x47eab9['status'],'createdAt':_0x47eab9[_0x21b5af(0x123)]};}async['updateWallets'](_0x216cff,_0x594c76){const _0x19a25c=a60_0x727ff3,_0x351705={};_0x594c76[_0x19a25c(0x153)]!==undefined&&(_0x351705[_0x19a25c(0x153)]=_0x594c76[_0x19a25c(0x153)]||null),_0x594c76[_0x19a25c(0x155)]!==undefined&&(_0x351705[_0x19a25c(0x155)]=_0x594c76['usdtTrcWallet']||null),_0x594c76[_0x19a25c(0x11a)]!==undefined&&(_0x351705[_0x19a25c(0x11a)]=_0x594c76[_0x19a25c(0x11a)]||null),_0x594c76[_0x19a25c(0x173)]!==undefined&&(_0x351705[_0x19a25c(0x173)]=_0x594c76[_0x19a25c(0x173)]||null),await database_1[_0x19a25c(0x106)]['shop'][_0x19a25c(0x14d)]({'where':{'id':_0x216cff},'data':_0x351705});}async[a60_0x727ff3(0x14b)](_0x3dfe44){const _0x1b0aed=a60_0x727ff3,_0x120d80=await database_1[_0x1b0aed(0x106)][_0x1b0aed(0x189)][_0x1b0aed(0x182)]({'where':{'id':_0x3dfe44},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x120d80?.[_0x1b0aed(0x13f)]?.[_0x1b0aed(0x12a)])throw new Error(_0x1b0aed(0x14c));const _0x2bbd4a={'event':_0x1b0aed(0x165),'payment':{'id':_0x1b0aed(0x195),'order_id':_0x1b0aed(0x1a2),'gateway':_0x1b0aed(0x165),'amount':0x64,'currency':_0x1b0aed(0x113),'status':_0x1b0aed(0xf7),'created_at':new Date()['toISOString']()}};try{const _0x496c02=await fetch(_0x120d80[_0x1b0aed(0x13f)][_0x1b0aed(0x12a)],{'method':'POST','headers':{'Content-Type':_0x1b0aed(0x10c),'User-Agent':_0x1b0aed(0x193)},'body':JSON[_0x1b0aed(0x134)](_0x2bbd4a)});return _0x496c02['ok']?{'success':!![],'message':_0x1b0aed(0x16e)+_0x496c02[_0x1b0aed(0x10e)]+')'}:{'success':![],'message':_0x1b0aed(0x183)+_0x496c02[_0x1b0aed(0x10e)]+'\x20'+_0x496c02[_0x1b0aed(0x15a)]};}catch(_0x1e831c){return{'success':![],'message':_0x1b0aed(0x109)+(_0x1e831c instanceof Error?_0x1e831c['message']:_0x1b0aed(0xf4))};}}async[a60_0x727ff3(0x16c)](_0x499066){const _0x19fef8=a60_0x727ff3;return this[_0x19fef8(0x1a1)][_0x19fef8(0x12c)]({'public_key':'','gateway':_0x499066[_0x19fef8(0x13e)],'order_id':undefined,'amount':_0x499066['amount'],'currency':_0x499066['currency'],'source_currency':_0x499066[_0x19fef8(0x102)],'usage':_0x499066[_0x19fef8(0x122)],'expires_at':_0x499066[_0x19fef8(0x15b)]?.[_0x19fef8(0x10f)](),'success_url':_0x499066[_0x19fef8(0x17a)],'fail_url':_0x499066[_0x19fef8(0x17a)],'customer_email':_0x499066[_0x19fef8(0x197)],'customer_name':_0x499066['customerName'],'country':_0x499066[_0x19fef8(0x157)],'language':_0x499066[_0x19fef8(0x147)],'amount_is_editable':_0x499066[_0x19fef8(0x105)],'max_payments':_0x499066[_0x19fef8(0x141)],'customer':_0x499066[_0x19fef8(0x149)]});}async[a60_0x727ff3(0x138)](_0x51cdbf,_0x3d2e76){const _0x5e7b8f=a60_0x727ff3;return this['paymentService'][_0x5e7b8f(0x19a)](_0x51cdbf,_0x3d2e76);}async['getPaymentById'](_0x1ad143,_0x4ba737){const _0x437589=a60_0x727ff3;return this[_0x437589(0x1a1)]['getPaymentByShopAndId'](_0x1ad143,_0x4ba737);}async[a60_0x727ff3(0x101)](_0x4e8016,_0x445c8e,_0x1172af){const _0x5a74ca=a60_0x727ff3,_0x10f919=await database_1['default']['payment'][_0x5a74ca(0x18a)]({'where':{'id':_0x445c8e,'shopId':_0x4e8016}});if(!_0x10f919)throw new Error(_0x5a74ca(0x144));const _0x5c0237=await database_1[_0x5a74ca(0x106)][_0x5a74ca(0x15f)][_0x5a74ca(0x14d)]({'where':{'id':_0x445c8e},'data':{..._0x1172af,'updatedAt':new Date()}});return _0x5c0237;}async['deletePayment'](_0x2c67a3,_0xb4ea7a){const _0x4632c8=a60_0x727ff3,_0x5cf547=await database_1[_0x4632c8(0x106)][_0x4632c8(0x15f)][_0x4632c8(0x18a)]({'where':{'id':_0xb4ea7a,'shopId':_0x2c67a3}});if(!_0x5cf547)throw new Error(_0x4632c8(0x144));await database_1[_0x4632c8(0x106)][_0x4632c8(0x15f)]['delete']({'where':{'id':_0xb4ea7a}});}[a60_0x727ff3(0x100)](_0x4f4b18){const _0x1bdba7=a60_0x727ff3,_0x53d69d={'polygon':'USDT\x20Polygon','trc20':_0x1bdba7(0x15c),'erc20':_0x1bdba7(0x15e),'bsc':_0x1bdba7(0x159),'polygon_usdc':'USDC\x20Polygon'};return _0x53d69d[_0x4f4b18]||_0x4f4b18;}async[a60_0x727ff3(0x108)](_0x5aaf57,_0x504436){const _0x1a6f5b=a60_0x727ff3,{page:_0x1cda83,limit:_0x15d797,status:_0xef4ad3,method:_0xd1d128,network:_0x29c0d6,dateFrom:_0x4a4b91,dateTo:_0x5161b3,periodFrom:_0x2915ec,periodTo:_0x3eac2c}=_0x504436,_0x314969=(_0x1cda83-0x1)*_0x15d797;console[_0x1a6f5b(0x120)](_0x1a6f5b(0x199),_0x504436);const _0x32068e={'shopId':_0x5aaf57};_0xef4ad3&&(_0x32068e[_0x1a6f5b(0x10e)]=_0xef4ad3['toUpperCase'](),console[_0x1a6f5b(0x120)](_0x1a6f5b(0x148)+_0xef4ad3[_0x1a6f5b(0x139)]()));if(_0xd1d128)_0x32068e['network']=_0xd1d128,console[_0x1a6f5b(0x120)](_0x1a6f5b(0x135)+_0xd1d128);else _0x29c0d6&&(_0x32068e[_0x1a6f5b(0x180)]=_0x29c0d6,console[_0x1a6f5b(0x120)](_0x1a6f5b(0x10b)+_0x29c0d6));if(_0x4a4b91||_0x5161b3||_0x2915ec||_0x3eac2c){_0x32068e[_0x1a6f5b(0x123)]={};if(_0x2915ec){const _0xff9c67=new Date(_0x2915ec);_0xff9c67[_0x1a6f5b(0x18c)](0x0,0x0,0x0,0x0),_0x32068e[_0x1a6f5b(0x123)]['gte']=_0xff9c67,console[_0x1a6f5b(0x120)](_0x1a6f5b(0x18b)+_0xff9c67['toISOString']());}else{if(_0x4a4b91){const _0x18fe9f=new Date(_0x4a4b91);_0x18fe9f['setHours'](0x0,0x0,0x0,0x0),_0x32068e[_0x1a6f5b(0x123)][_0x1a6f5b(0xff)]=_0x18fe9f,console['log'](_0x1a6f5b(0x15d)+_0x18fe9f['toISOString']());}}if(_0x3eac2c){const _0x33fab6=new Date(_0x3eac2c);_0x33fab6['setHours'](0x17,0x3b,0x3b,0x3e7),_0x32068e[_0x1a6f5b(0x123)]['lte']=_0x33fab6,console['log'](_0x1a6f5b(0x17b)+_0x33fab6[_0x1a6f5b(0x10f)]());}else{if(_0x5161b3){const _0x5bbe3b=new Date(_0x5161b3);_0x5bbe3b[_0x1a6f5b(0x18c)](0x17,0x3b,0x3b,0x3e7),_0x32068e[_0x1a6f5b(0x123)]['lte']=_0x5bbe3b,console[_0x1a6f5b(0x120)](_0x1a6f5b(0x12e)+_0x5bbe3b[_0x1a6f5b(0x10f)]());}}}console[_0x1a6f5b(0x120)]('üìä\x20Final\x20WHERE\x20conditions:',JSON[_0x1a6f5b(0x134)](_0x32068e,null,0x2));const [_0x390f2c,_0x3e9870]=await Promise[_0x1a6f5b(0x128)]([database_1[_0x1a6f5b(0x106)][_0x1a6f5b(0xfb)][_0x1a6f5b(0x13b)]({'where':_0x32068e,'skip':_0x314969,'take':_0x15d797,'orderBy':{'createdAt':_0x1a6f5b(0x12b)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default'][_0x1a6f5b(0xfb)]['count']({'where':_0x32068e})]);return{'payouts':_0x390f2c[_0x1a6f5b(0x162)](_0x12047f=>{const _0x1d9294=_0x1a6f5b;let _0x4b7dd6=null;switch(_0x12047f[_0x1d9294(0x180)]){case _0x1d9294(0x103):_0x4b7dd6=_0x12047f['shop']['usdtPolygonWallet'];break;case _0x1d9294(0x18d):_0x4b7dd6=_0x12047f[_0x1d9294(0x189)]['usdtTrcWallet'];break;case _0x1d9294(0x126):_0x4b7dd6=_0x12047f[_0x1d9294(0x189)]['usdtErcWallet'];break;case _0x1d9294(0x16a):_0x4b7dd6=_0x12047f[_0x1d9294(0x189)][_0x1d9294(0x173)];break;}return{'id':_0x12047f['id'],'amount':_0x12047f['amount'],'network':this['formatNetworkName'](_0x12047f['network']),'wallet':_0x4b7dd6,'status':_0x12047f[_0x1d9294(0x10e)],'txid':_0x12047f['txid'],'notes':_0x12047f[_0x1d9294(0x146)],'periodFrom':_0x12047f[_0x1d9294(0x154)],'periodTo':_0x12047f[_0x1d9294(0x13c)],'createdAt':_0x12047f['createdAt'],'paidAt':_0x12047f[_0x1d9294(0x18e)]};}),'pagination':{'page':_0x1cda83,'limit':_0x15d797,'total':_0x3e9870,'totalPages':Math['ceil'](_0x3e9870/_0x15d797)}};}async[a60_0x727ff3(0x115)](_0x57b53d,_0x3b587f){const _0x51155a=a60_0x727ff3,_0x220b14=await database_1[_0x51155a(0x106)][_0x51155a(0xfb)]['findFirst']({'where':{'id':_0x3b587f,'shopId':_0x57b53d}});if(!_0x220b14)return null;return{'id':_0x220b14['id'],'amount':_0x220b14['amount'],'network':_0x220b14[_0x51155a(0x180)],'status':_0x220b14['status'],'txid':_0x220b14[_0x51155a(0x16b)],'notes':_0x220b14[_0x51155a(0x146)],'createdAt':_0x220b14[_0x51155a(0x123)],'paidAt':_0x220b14['paidAt']};}async['getPayoutStatistics'](_0x1ad44d,_0x15ec01){const _0x272a37=a60_0x727ff3,_0x4c1c87=new Date();let _0x43cf94,_0x111489;switch(_0x15ec01){case _0x272a37(0x160):case'YESTERDAY':const _0x3489b7=new Date(_0x4c1c87);_0x3489b7[_0x272a37(0x185)](_0x3489b7['getDate']()-0x1),_0x43cf94=new Date(_0x3489b7),_0x43cf94[_0x272a37(0x18c)](0x0,0x0,0x0,0x0),_0x111489=new Date(_0x3489b7),_0x111489['setHours'](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x43cf94=new Date(_0x4c1c87[_0x272a37(0x198)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x43cf94=new Date(_0x4c1c87['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x272a37(0x140):_0x43cf94=new Date(_0x4c1c87[_0x272a37(0x198)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x43cf94=new Date(_0x4c1c87[_0x272a37(0x198)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x4884c0={'gte':_0x43cf94};_0x111489&&(_0x4884c0[_0x272a37(0x116)]=_0x111489);const [_0x1659d3,_0x462912,_0x5d1f55,_0x1ffe11,_0x15fc1d,_0x58a0c4]=await Promise['all']([database_1['default'][_0x272a37(0xfb)][_0x272a37(0x151)]({'where':{'shopId':_0x1ad44d,'createdAt':_0x4884c0}}),database_1[_0x272a37(0x106)][_0x272a37(0xfb)]['count']({'where':{'shopId':_0x1ad44d,'status':_0x272a37(0x14f),'createdAt':_0x4884c0}}),database_1['default'][_0x272a37(0xfb)][_0x272a37(0x151)]({'where':{'shopId':_0x1ad44d,'status':'PENDING','createdAt':_0x4884c0}}),database_1[_0x272a37(0x106)][_0x272a37(0xfb)][_0x272a37(0x151)]({'where':{'shopId':_0x1ad44d,'status':_0x272a37(0x19c),'createdAt':_0x4884c0}}),database_1['default'][_0x272a37(0xfb)][_0x272a37(0x13b)]({'where':{'shopId':_0x1ad44d,'createdAt':_0x4884c0},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x272a37(0x106)][_0x272a37(0xfb)][_0x272a37(0x13b)]({'where':{'shopId':_0x1ad44d},'take':0xa,'orderBy':{'createdAt':_0x272a37(0x12b)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x1f9868=_0x15fc1d[_0x272a37(0x152)]((_0x2f0b79,_0x58e067)=>_0x2f0b79+_0x58e067[_0x272a37(0x114)],0x0),_0x3db0d3=_0x15fc1d[_0x272a37(0x175)](_0x254301=>_0x254301[_0x272a37(0x10e)]===_0x272a37(0x14f))[_0x272a37(0x152)]((_0x21ce52,_0x4ce228)=>_0x21ce52+_0x4ce228[_0x272a37(0x114)],0x0),_0x5d1ff3=_0x15fc1d[_0x272a37(0x175)](_0x426792=>_0x426792[_0x272a37(0x10e)]==='PENDING')['reduce']((_0xd7ce3a,_0x28f149)=>_0xd7ce3a+_0x28f149[_0x272a37(0x114)],0x0),_0x4632c9=_0x15fc1d['reduce']((_0xefb87b,_0x324b53)=>{const _0xb4c762=_0x272a37;return _0xefb87b[_0x324b53[_0xb4c762(0x180)]]=(_0xefb87b[_0x324b53['network']]||0x0)+0x1,_0xefb87b;},{}),_0x473ab4=_0x15fc1d[_0x272a37(0x152)]((_0x4f0060,_0x4db192)=>{const _0x27c54b=_0x272a37;return _0x4f0060[_0x4db192[_0x27c54b(0x10e)]]=(_0x4f0060[_0x4db192[_0x27c54b(0x10e)]]||0x0)+0x1,_0x4f0060;},{});return{'totalPayouts':_0x1659d3,'completedPayouts':_0x462912,'pendingPayouts':_0x5d1f55,'rejectedPayouts':_0x1ffe11,'totalAmount':_0x1f9868,'completedAmount':_0x3db0d3,'pendingAmount':_0x5d1ff3,'payoutsByMethod':_0x4632c9,'payoutsByStatus':_0x473ab4,'recentPayouts':_0x58a0c4[_0x272a37(0x162)](_0xf6bd09=>({'id':_0xf6bd09['id'],'shopId':_0x1ad44d,'amount':_0xf6bd09[_0x272a37(0x114)],'method':_0xf6bd09[_0x272a37(0x180)],'status':_0xf6bd09[_0x272a37(0x10e)],'txid':_0xf6bd09['txid'],'createdAt':_0xf6bd09[_0x272a37(0x123)],'paidAt':_0xf6bd09[_0x272a37(0x18e)]}))};}async[a60_0x727ff3(0x107)](_0x88a3f4){const _0x1065aa=a60_0x727ff3;console['log']('üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x88a3f4+_0x1065aa(0x196));const _0x142ac3=await database_1[_0x1065aa(0x106)][_0x1065aa(0x189)][_0x1065aa(0x182)]({'where':{'id':_0x88a3f4},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x142ac3)throw new Error('Shop\x20not\x20found');const _0x3a6675=new Date(),_0x161b6f=new Date(_0x3a6675[_0x1065aa(0x10d)](),_0x3a6675[_0x1065aa(0x150)](),0x1),_0x3b785b=new Date(_0x3a6675['getFullYear'](),_0x3a6675[_0x1065aa(0x150)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x2fd30a=await database_1[_0x1065aa(0x106)][_0x1065aa(0xfb)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x88a3f4,'createdAt':{'gte':_0x161b6f,'lte':_0x3b785b},'status':_0x1065aa(0x14f)}}),_0x24223c=_0x2fd30a[_0x1065aa(0x13d)][_0x1065aa(0x114)]||0x0,_0xc9752={'availableBalance':Math[_0x1065aa(0xfe)](_0x142ac3[_0x1065aa(0x1a0)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x142ac3[_0x1065aa(0x186)]*0x64)/0x64,'awaitingPayout':Math[_0x1065aa(0xfe)](_0x142ac3[_0x1065aa(0x1a0)]*0x64)/0x64,'thisMonth':Math[_0x1065aa(0xfe)](_0x24223c*0x64)/0x64};return console[_0x1065aa(0x120)]('üìä\x20Shop\x20'+_0x142ac3['username']+_0x1065aa(0x121)),console['log']('\x20\x20\x20üíµ\x20Available\x20balance:\x20'+_0xc9752[_0x1065aa(0x191)]+_0x1065aa(0x166)),console['log'](_0x1065aa(0xf5)+_0xc9752['totalPaidOut']+_0x1065aa(0x13a)),console[_0x1065aa(0x120)](_0x1065aa(0x177)+_0xc9752[_0x1065aa(0x178)]+_0x1065aa(0x166)),console['log'](_0x1065aa(0x171)+_0xc9752[_0x1065aa(0x19e)]+'\x20USDT'),_0xc9752;}[a60_0x727ff3(0x119)](_0x30ebdb){const _0x41bc11=a60_0x727ff3,_0x5b1933={'test_gateway':_0x41bc11(0x168),'plisio':_0x41bc11(0x11d),'rapyd':_0x41bc11(0x16d),'noda':'Noda','cointopay':'CoinToPay','klyme_eu':_0x41bc11(0x11e),'klyme_gb':_0x41bc11(0x1a3),'klyme_de':_0x41bc11(0x132)};return _0x5b1933[_0x30ebdb]||_0x30ebdb;}async[a60_0x727ff3(0x170)](_0x30df81){return this['getShopPayoutStats'](_0x30df81);}async[a60_0x727ff3(0x19b)](_0x504795,_0x45807a){const _0x2be0f1=a60_0x727ff3,{page:_0x6447b7,limit:_0x16d621,paymentId:_0x57a3e}=_0x45807a,_0x18a9e8=(_0x6447b7-0x1)*_0x16d621,_0x2d3d1c={'shopId':_0x504795};_0x57a3e&&(_0x2d3d1c[_0x2be0f1(0x125)]=_0x57a3e);const [_0xaea036,_0x3c32e9]=await Promise[_0x2be0f1(0x128)]([database_1[_0x2be0f1(0x106)]['webhookLog'][_0x2be0f1(0x13b)]({'where':_0x2d3d1c,'skip':_0x18a9e8,'take':_0x16d621,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default'][_0x2be0f1(0xf6)][_0x2be0f1(0x151)]({'where':_0x2d3d1c})]);return{'logs':_0xaea036['map'](_0x53d1d0=>({'id':_0x53d1d0['id'],'paymentId':_0x53d1d0[_0x2be0f1(0x125)],'shopId':_0x53d1d0[_0x2be0f1(0x12d)],'event':_0x53d1d0['event'],'statusCode':_0x53d1d0['statusCode'],'retryCount':_0x53d1d0[_0x2be0f1(0xf9)],'responseBody':_0x53d1d0[_0x2be0f1(0x117)],'createdAt':_0x53d1d0[_0x2be0f1(0x123)],'payment':_0x53d1d0[_0x2be0f1(0x15f)]})),'pagination':{'page':_0x6447b7,'limit':_0x16d621,'total':_0x3c32e9,'totalPages':Math['ceil'](_0x3c32e9/_0x16d621)}};}async[a60_0x727ff3(0x143)](_0x202ffd,_0x45042b){const _0x3e6a2d=a60_0x727ff3,_0x1d0363=new Date();let _0x10f825,_0x483c12;switch(_0x45042b[_0x3e6a2d(0x11c)]()){case _0x3e6a2d(0x17d):_0x10f825=new Date(_0x1d0363[_0x3e6a2d(0x10d)](),_0x1d0363[_0x3e6a2d(0x150)](),_0x1d0363[_0x3e6a2d(0x188)](),0x0,0x0,0x0,0x0);break;case _0x3e6a2d(0x160):case _0x3e6a2d(0x17f):const _0x210e46=new Date(_0x1d0363);_0x210e46[_0x3e6a2d(0x185)](_0x210e46[_0x3e6a2d(0x188)]()-0x1),_0x10f825=new Date(_0x210e46),_0x10f825[_0x3e6a2d(0x18c)](0x0,0x0,0x0,0x0),_0x483c12=new Date(_0x210e46),_0x483c12[_0x3e6a2d(0x18c)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x10f825=new Date(_0x1d0363[_0x3e6a2d(0x198)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x3e6a2d(0x1a4):_0x10f825=new Date(_0x1d0363[_0x3e6a2d(0x198)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3e6a2d(0x140):_0x10f825=new Date(_0x1d0363['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x10f825=new Date(_0x1d0363[_0x3e6a2d(0x198)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0xf9bc4f={'gte':_0x10f825};_0x483c12&&(_0xf9bc4f['lte']=_0x483c12);const [_0x29a7eb,_0x42e9a8,_0x170b3b,_0x34d524,_0x203487]=await Promise[_0x3e6a2d(0x128)]([database_1[_0x3e6a2d(0x106)]['payment'][_0x3e6a2d(0x151)]({'where':{'shopId':_0x202ffd,'gateway':{'not':_0x3e6a2d(0x10a)},'createdAt':_0xf9bc4f}}),database_1[_0x3e6a2d(0x106)]['payment'][_0x3e6a2d(0x151)]({'where':{'shopId':_0x202ffd,'gateway':{'not':'test_gateway'},'status':'PAID','createdAt':_0xf9bc4f}}),database_1[_0x3e6a2d(0x106)][_0x3e6a2d(0x15f)][_0x3e6a2d(0x13b)]({'where':{'shopId':_0x202ffd,'gateway':{'not':_0x3e6a2d(0x10a)},'status':_0x3e6a2d(0xfd),'createdAt':_0xf9bc4f},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3e6a2d(0x106)][_0x3e6a2d(0x15f)][_0x3e6a2d(0x13b)]({'where':{'shopId':_0x202ffd,'gateway':{'not':_0x3e6a2d(0x10a)}},'take':0xa,'orderBy':{'createdAt':_0x3e6a2d(0x12b)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x3e6a2d(0x106)][_0x3e6a2d(0x15f)][_0x3e6a2d(0x13b)]({'where':{'shopId':_0x202ffd,'gateway':{'not':'test_gateway'},'createdAt':_0xf9bc4f},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3e6a2d(0x104)}})]);let _0x2837b0=0x0;for(const _0x299624 of _0x170b3b){if(_0x299624['amountUSDT'])_0x2837b0+=_0x299624['amountUSDT'];else{const _0x4e3291=await currencyService_1[_0x3e6a2d(0x127)][_0x3e6a2d(0xf3)](_0x299624[_0x3e6a2d(0x114)],_0x299624['currency']);_0x2837b0+=_0x4e3291;}}const _0x2c5db0=this[_0x3e6a2d(0x19f)](_0x203487,_0x10f825,_0x483c12||_0x1d0363),_0x55ccd0=_0x29a7eb>0x0?_0x42e9a8/_0x29a7eb*0x64:0x0;return{'totalPayments':_0x29a7eb,'successfulPayments':_0x42e9a8,'totalRevenue':Math[_0x3e6a2d(0xfe)](_0x2837b0*0x64)/0x64,'conversionRate':Math[_0x3e6a2d(0xfe)](_0x55ccd0*0x64)/0x64,'dailyRevenue':_0x2c5db0[_0x3e6a2d(0x18f)],'dailyPayments':_0x2c5db0[_0x3e6a2d(0x184)],'recentPayments':_0x34d524[_0x3e6a2d(0x162)](_0x4cdd0c=>({'id':_0x4cdd0c['id'],'gateway':_0x4cdd0c['gateway'],'amount':_0x4cdd0c[_0x3e6a2d(0x114)],'currency':_0x4cdd0c['currency'],'status':_0x4cdd0c[_0x3e6a2d(0x10e)],'createdAt':_0x4cdd0c[_0x3e6a2d(0x123)]}))};}[a60_0x727ff3(0x19f)](_0x4c982a,_0x21d254,_0x1962ee){const _0x3c0a73=a60_0x727ff3,_0x432a4e=new Map(),_0x3da3a9=new Date(_0x21d254);while(_0x3da3a9<=_0x1962ee){const _0x3873e0=_0x3da3a9[_0x3c0a73(0x10f)]()[_0x3c0a73(0x172)]('T')[0x0];_0x432a4e[_0x3c0a73(0xfa)](_0x3873e0,{'revenue':0x0,'count':0x0}),_0x3da3a9[_0x3c0a73(0x185)](_0x3da3a9[_0x3c0a73(0x188)]()+0x1);}for(const _0x3d3121 of _0x4c982a){const _0x99cd03=_0x3d3121[_0x3c0a73(0x123)][_0x3c0a73(0x10f)]()[_0x3c0a73(0x172)]('T')[0x0],_0x40526b=_0x432a4e[_0x3c0a73(0x131)](_0x99cd03);_0x40526b&&(_0x40526b[_0x3c0a73(0x151)]+=0x1,_0x3d3121[_0x3c0a73(0x10e)]==='PAID'&&_0x3d3121[_0x3c0a73(0x17c)]&&(_0x40526b[_0x3c0a73(0x187)]+=_0x3d3121['amountUSDT']));}const _0x2c6fe7=[],_0x42d8fa=[];for(const [_0x44e1d7,_0x4f7364]of _0x432a4e){_0x2c6fe7[_0x3c0a73(0x11f)]({'date':_0x44e1d7,'amount':Math['round'](_0x4f7364[_0x3c0a73(0x187)]*0x64)/0x64}),_0x42d8fa[_0x3c0a73(0x11f)]({'date':_0x44e1d7,'count':_0x4f7364[_0x3c0a73(0x151)]});}return{'dailyRevenue':_0x2c6fe7,'dailyPayments':_0x42d8fa};}}exports[a60_0x727ff3(0x17e)]=ShopService;