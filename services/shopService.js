'use strict';const a53_0x332f8a=a53_0x1cad;(function(_0x2ae4e1,_0x468d1d){const _0xefe8e3=a53_0x1cad,_0x3d6f31=_0x2ae4e1();while(!![]){try{const _0x177154=-parseInt(_0xefe8e3(0x1af))/0x1*(-parseInt(_0xefe8e3(0x1d0))/0x2)+-parseInt(_0xefe8e3(0x1a0))/0x3*(-parseInt(_0xefe8e3(0x1b5))/0x4)+-parseInt(_0xefe8e3(0x1bd))/0x5+-parseInt(_0xefe8e3(0x179))/0x6+parseInt(_0xefe8e3(0x17f))/0x7+-parseInt(_0xefe8e3(0x18d))/0x8+-parseInt(_0xefe8e3(0x1cc))/0x9;if(_0x177154===_0x468d1d)break;else _0x3d6f31['push'](_0x3d6f31['shift']());}catch(_0xa11a89){_0x3d6f31['push'](_0x3d6f31['shift']());}}}(a53_0x365b,0x21f49));var __importDefault=this&&this[a53_0x332f8a(0x1d2)]||function(_0x26ee59){return _0x26ee59&&_0x26ee59['__esModule']?_0x26ee59:{'default':_0x26ee59};};Object[a53_0x332f8a(0x1fc)](exports,a53_0x332f8a(0x1b6),{'value':!![]}),exports['ShopService']=void 0x0;function a53_0x365b(){const _0x35fdb2=['desc','180684xfMoAG','parse','map','telegramId','3246kwUtzd','notes','__importDefault','\x20payout\x20statistics\x20calculated:','dailyRevenue','shop','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','asc','usdtErcWallet','Test\x20Gateway','\x20USDT\x20(total\x20payouts)','90d','update','Payment\x20not\x20found','updateWallets','message','findUnique','status','findFirst','getShopPayoutStats','PENDING','createPayment','amountIsEditable','toUpperCase','split','maxPayments','all','availableBalance','createdAt','round','./paymentService','redirectUrl','stringify','customerName','sourceCurrency','test_order_123','USD','reduce','getPayoutById','username','shopId','usdtPolygonWallet','get','Unknown\x20error','defineProperty','wallets','üìä\x20Shop\x20','REJECTED','event','getTime','payment','settings','Error\x20parsing\x20webhook\x20events:','Webhook\x20returned\x20error:\x20','network','amount','createPublicPayment','\x20USDT','awaitingPayout','_sum','paymentId','responseBody','1438998BCcoKe','usage','shopUrl','retryCount','deletePayment','\x20\x20\x20üìÖ\x20This\x20month:\x20','1872122jhfGOw','balance','name','testWebhook','getMonth','getPayouts','getPaymentsByShop','country','findMany','generateDailyStatistics','getDate','txid','set','30d','1094800olkBQK','COMPLETED','paymentService','gatewaySettings','Rapyd','isArray','error','paymentGateways','TesSoft\x20Payment\x20System/1.0\x20(Test)','No\x20webhook\x20URL\x20configured','\x20USDT\x20(current\x20balance)','delete','currencyService','statusText','expiresAt','webhookLog','webhookEvents','ceil','toISOString','13827qSPMQk','gte','test_payment_123','publicKey','thisMonth','gateway','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','webhookUrl','filter','count','getPaymentById','PaymentService','Test\x20webhook\x20sent\x20successfully\x20(','usdcPolygonWallet','default','162ZSzqdr','lte','../config/database','usdtTrcWallet','getFullYear','log','52RRUtlA','__esModule','PAID','paidAt','test_gateway','telegram','KLYME\x20DE','totalPaidOut','272245SLUvnD','amountUSDT','Failed\x20to\x20send\x20webhook:\x20','KLYME\x20GB','currency','ShopService','fullName','customerEmail','payout','getPayoutStatistics','merchantUrl','convertToUSDT','test','updateShopProfile'];a53_0x365b=function(){return _0x35fdb2;};return a53_0x365b();}const database_1=__importDefault(require(a53_0x332f8a(0x1b1))),currencyService_1=require('./currencyService'),paymentService_1=require(a53_0x332f8a(0x1ee));function a53_0x1cad(_0x1a5240,_0x39cb37){const _0x365bbd=a53_0x365b();return a53_0x1cad=function(_0x1cadb1,_0xfff38b){_0x1cadb1=_0x1cadb1-0x174;let _0x2c047b=_0x365bbd[_0x1cadb1];return _0x2c047b;},a53_0x1cad(_0x1a5240,_0x39cb37);}class ShopService{constructor(){const _0xc832d3=a53_0x332f8a;this['paymentService']=new paymentService_1[(_0xc832d3(0x1ab))]();}async['getShopProfile'](_0x4f009a){const _0x373a5f=a53_0x332f8a,_0x4588f5=await database_1[_0x373a5f(0x1ae)][_0x373a5f(0x1d5)][_0x373a5f(0x1e0)]({'where':{'id':_0x4f009a},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x4588f5)throw new Error('Shop\x20not\x20found');let _0x3e1f4d=[];if(_0x4588f5[_0x373a5f(0x203)]?.[_0x373a5f(0x19d)])try{_0x3e1f4d=Array[_0x373a5f(0x192)](_0x4588f5[_0x373a5f(0x203)]['webhookEvents'])?_0x4588f5['settings'][_0x373a5f(0x19d)]:JSON[_0x373a5f(0x1cd)](_0x4588f5[_0x373a5f(0x203)][_0x373a5f(0x19d)]);}catch(_0x4d624a){console[_0x373a5f(0x193)](_0x373a5f(0x204),_0x4d624a),_0x3e1f4d=[];}return{'id':_0x4588f5['id'],'fullName':_0x4588f5[_0x373a5f(0x181)],'username':_0x4588f5[_0x373a5f(0x1f7)],'telegramId':_0x4588f5[_0x373a5f(0x1ba)],'merchantUrl':_0x4588f5[_0x373a5f(0x17b)],'gateways':_0x4588f5[_0x373a5f(0x194)]?JSON[_0x373a5f(0x1cd)](_0x4588f5[_0x373a5f(0x194)]):null,'gatewaySettings':_0x4588f5['gatewaySettings']?JSON['parse'](_0x4588f5[_0x373a5f(0x190)]):null,'publicKey':_0x4588f5[_0x373a5f(0x1a3)],'webhookUrl':_0x4588f5[_0x373a5f(0x203)]?.[_0x373a5f(0x1a7)]||null,'webhookEvents':_0x3e1f4d,'wallets':{'usdtPolygonWallet':_0x4588f5[_0x373a5f(0x1f9)],'usdtTrcWallet':_0x4588f5[_0x373a5f(0x1b2)],'usdtErcWallet':_0x4588f5[_0x373a5f(0x1d8)],'usdcPolygonWallet':_0x4588f5[_0x373a5f(0x1ad)]},'status':_0x4588f5[_0x373a5f(0x1e1)],'createdAt':_0x4588f5[_0x373a5f(0x1ec)]};}async[a53_0x332f8a(0x1ca)](_0x1faa1d,_0x1d00e5){const _0x1d7566=a53_0x332f8a,_0x52c363={};_0x1d00e5[_0x1d7566(0x1c3)]&&(_0x52c363['name']=_0x1d00e5[_0x1d7566(0x1c3)]);_0x1d00e5[_0x1d7566(0x1cf)]!==undefined&&(_0x52c363[_0x1d7566(0x1ba)]=_0x1d00e5[_0x1d7566(0x1cf)]||null);_0x1d00e5[_0x1d7566(0x1c7)]&&(_0x52c363[_0x1d7566(0x17b)]=_0x1d00e5['merchantUrl']);_0x1d00e5['gateways']&&(_0x52c363[_0x1d7566(0x194)]=JSON[_0x1d7566(0x1f0)](_0x1d00e5['gateways']));_0x1d00e5[_0x1d7566(0x190)]&&(_0x52c363[_0x1d7566(0x190)]=JSON[_0x1d7566(0x1f0)](_0x1d00e5[_0x1d7566(0x190)]));_0x1d00e5['wallets']&&(_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1f9)]!==undefined&&(_0x52c363[_0x1d7566(0x1f9)]=_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1f9)]||null),_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1b2)]!==undefined&&(_0x52c363['usdtTrcWallet']=_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1b2)]||null),_0x1d00e5[_0x1d7566(0x1fd)]['usdtErcWallet']!==undefined&&(_0x52c363[_0x1d7566(0x1d8)]=_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1d8)]||null),_0x1d00e5[_0x1d7566(0x1fd)]['usdcPolygonWallet']!==undefined&&(_0x52c363['usdcPolygonWallet']=_0x1d00e5[_0x1d7566(0x1fd)][_0x1d7566(0x1ad)]||null));const _0x151326=await database_1[_0x1d7566(0x1ae)]['shop'][_0x1d7566(0x1dc)]({'where':{'id':_0x1faa1d},'data':_0x52c363,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0xbba54b=[];if(_0x151326[_0x1d7566(0x203)]?.[_0x1d7566(0x19d)])try{_0xbba54b=Array[_0x1d7566(0x192)](_0x151326['settings']['webhookEvents'])?_0x151326['settings']['webhookEvents']:JSON[_0x1d7566(0x1cd)](_0x151326[_0x1d7566(0x203)][_0x1d7566(0x19d)]);}catch(_0x53adea){console[_0x1d7566(0x193)](_0x1d7566(0x204),_0x53adea),_0xbba54b=[];}return{'id':_0x151326['id'],'fullName':_0x151326[_0x1d7566(0x181)],'username':_0x151326[_0x1d7566(0x1f7)],'telegramId':_0x151326[_0x1d7566(0x1ba)],'merchantUrl':_0x151326[_0x1d7566(0x17b)],'gateways':_0x151326['paymentGateways']?JSON[_0x1d7566(0x1cd)](_0x151326[_0x1d7566(0x194)]):null,'gatewaySettings':_0x151326[_0x1d7566(0x190)]?JSON['parse'](_0x151326[_0x1d7566(0x190)]):null,'publicKey':_0x151326[_0x1d7566(0x1a3)],'webhookUrl':_0x151326[_0x1d7566(0x203)]?.[_0x1d7566(0x1a7)]||null,'webhookEvents':_0xbba54b,'wallets':{'usdtPolygonWallet':_0x151326[_0x1d7566(0x1f9)],'usdtTrcWallet':_0x151326[_0x1d7566(0x1b2)],'usdtErcWallet':_0x151326[_0x1d7566(0x1d8)],'usdcPolygonWallet':_0x151326['usdcPolygonWallet']},'status':_0x151326[_0x1d7566(0x1e1)],'createdAt':_0x151326[_0x1d7566(0x1ec)]};}async[a53_0x332f8a(0x1de)](_0x41b580,_0x55cdff){const _0x1d9b19=a53_0x332f8a,_0x36f935={};_0x55cdff[_0x1d9b19(0x1f9)]!==undefined&&(_0x36f935[_0x1d9b19(0x1f9)]=_0x55cdff['usdtPolygonWallet']||null),_0x55cdff['usdtTrcWallet']!==undefined&&(_0x36f935[_0x1d9b19(0x1b2)]=_0x55cdff[_0x1d9b19(0x1b2)]||null),_0x55cdff[_0x1d9b19(0x1d8)]!==undefined&&(_0x36f935[_0x1d9b19(0x1d8)]=_0x55cdff[_0x1d9b19(0x1d8)]||null),_0x55cdff[_0x1d9b19(0x1ad)]!==undefined&&(_0x36f935[_0x1d9b19(0x1ad)]=_0x55cdff['usdcPolygonWallet']||null),await database_1[_0x1d9b19(0x1ae)][_0x1d9b19(0x1d5)][_0x1d9b19(0x1dc)]({'where':{'id':_0x41b580},'data':_0x36f935});}async[a53_0x332f8a(0x182)](_0xbebdd6){const _0x995209=a53_0x332f8a,_0x3bb5b5=await database_1[_0x995209(0x1ae)]['shop'][_0x995209(0x1e0)]({'where':{'id':_0xbebdd6},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x3bb5b5?.[_0x995209(0x203)]?.[_0x995209(0x1a7)])throw new Error(_0x995209(0x196));const _0x5966d0={'event':_0x995209(0x1c9),'payment':{'id':_0x995209(0x1a2),'order_id':_0x995209(0x1f3),'gateway':_0x995209(0x1c9),'amount':0x64,'currency':_0x995209(0x1f4),'status':'paid','created_at':new Date()['toISOString']()}};try{const _0x177e6c=await fetch(_0x3bb5b5[_0x995209(0x203)][_0x995209(0x1a7)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x995209(0x195)},'body':JSON[_0x995209(0x1f0)](_0x5966d0)});return _0x177e6c['ok']?{'success':!![],'message':_0x995209(0x1ac)+_0x177e6c['status']+')'}:{'success':![],'message':_0x995209(0x205)+_0x177e6c[_0x995209(0x1e1)]+'\x20'+_0x177e6c[_0x995209(0x19a)]};}catch(_0x23bc29){return{'success':![],'message':_0x995209(0x1bf)+(_0x23bc29 instanceof Error?_0x23bc29[_0x995209(0x1df)]:_0x995209(0x1fb))};}}async[a53_0x332f8a(0x1e5)](_0x1ea3a3){const _0x4c839d=a53_0x332f8a;return this['paymentService'][_0x4c839d(0x208)]({'public_key':'','gateway':_0x1ea3a3[_0x4c839d(0x1a5)],'order_id':undefined,'amount':_0x1ea3a3[_0x4c839d(0x207)],'currency':_0x1ea3a3[_0x4c839d(0x1c1)],'source_currency':_0x1ea3a3[_0x4c839d(0x1f2)],'usage':_0x1ea3a3[_0x4c839d(0x17a)],'expires_at':_0x1ea3a3[_0x4c839d(0x19b)]?.[_0x4c839d(0x19f)](),'success_url':_0x1ea3a3[_0x4c839d(0x1ef)],'fail_url':_0x1ea3a3['redirectUrl'],'customer_email':_0x1ea3a3[_0x4c839d(0x1c4)],'customer_name':_0x1ea3a3[_0x4c839d(0x1f1)],'country':_0x1ea3a3[_0x4c839d(0x186)],'language':_0x1ea3a3['language'],'amount_is_editable':_0x1ea3a3[_0x4c839d(0x1e6)],'max_payments':_0x1ea3a3[_0x4c839d(0x1e9)],'customer':_0x1ea3a3['customer']});}async['getPayments'](_0x3420e9,_0xb3338a){const _0x3d40c6=a53_0x332f8a;return this[_0x3d40c6(0x18f)][_0x3d40c6(0x185)](_0x3420e9,_0xb3338a);}async[a53_0x332f8a(0x1aa)](_0x42015c,_0x27b6de){const _0x277fc3=a53_0x332f8a;return this[_0x277fc3(0x18f)]['getPaymentByShopAndId'](_0x42015c,_0x27b6de);}async['updatePayment'](_0x7c9066,_0x5798a0,_0x31b16a){const _0x27e431=a53_0x332f8a,_0x263315=await database_1['default'][_0x27e431(0x202)][_0x27e431(0x1e2)]({'where':{'id':_0x5798a0,'shopId':_0x7c9066}});if(!_0x263315)throw new Error(_0x27e431(0x1dd));const _0x1cd5f0=await database_1[_0x27e431(0x1ae)][_0x27e431(0x202)][_0x27e431(0x1dc)]({'where':{'id':_0x5798a0},'data':{..._0x31b16a,'updatedAt':new Date()}});return _0x1cd5f0;}async[a53_0x332f8a(0x17d)](_0x3ae7e0,_0x351d4b){const _0x2d823d=a53_0x332f8a,_0x5922d5=await database_1['default'][_0x2d823d(0x202)][_0x2d823d(0x1e2)]({'where':{'id':_0x351d4b,'shopId':_0x3ae7e0}});if(!_0x5922d5)throw new Error(_0x2d823d(0x1dd));await database_1[_0x2d823d(0x1ae)]['payment'][_0x2d823d(0x198)]({'where':{'id':_0x351d4b}});}async[a53_0x332f8a(0x184)](_0x4f400e,_0x1ca43b){const _0x158b2f=a53_0x332f8a,{page:_0x3d3477,limit:_0x87da8a,status:_0x696eb8,method:_0x589a59,dateFrom:_0x21ab5f,dateTo:_0x1a64b0,periodFrom:_0x4adeae,periodTo:_0x2f9789}=_0x1ca43b,_0x1b6620=(_0x3d3477-0x1)*_0x87da8a,_0x29a01d={'shopId':_0x4f400e};_0x696eb8&&(_0x29a01d[_0x158b2f(0x1e1)]=_0x696eb8[_0x158b2f(0x1e7)]());_0x589a59&&(_0x29a01d[_0x158b2f(0x206)]=_0x589a59);if(_0x21ab5f||_0x1a64b0||_0x4adeae||_0x2f9789){_0x29a01d[_0x158b2f(0x1ec)]={};if(_0x4adeae)_0x29a01d[_0x158b2f(0x1ec)][_0x158b2f(0x1a1)]=new Date(_0x4adeae);else _0x21ab5f&&(_0x29a01d['createdAt'][_0x158b2f(0x1a1)]=new Date(_0x21ab5f));if(_0x2f9789)_0x29a01d['createdAt'][_0x158b2f(0x1b0)]=new Date(_0x2f9789);else _0x1a64b0&&(_0x29a01d[_0x158b2f(0x1ec)]['lte']=new Date(_0x1a64b0));}const [_0x15472c,_0x9a610b]=await Promise['all']([database_1[_0x158b2f(0x1ae)][_0x158b2f(0x1c5)][_0x158b2f(0x187)]({'where':_0x29a01d,'skip':_0x1b6620,'take':_0x87da8a,'orderBy':{'createdAt':_0x158b2f(0x1cb)}}),database_1[_0x158b2f(0x1ae)][_0x158b2f(0x1c5)][_0x158b2f(0x1a9)]({'where':_0x29a01d})]);return{'payouts':_0x15472c[_0x158b2f(0x1ce)](_0xba3519=>({'id':_0xba3519['id'],'amount':_0xba3519[_0x158b2f(0x207)],'network':_0xba3519['network'],'status':_0xba3519[_0x158b2f(0x1e1)],'txid':_0xba3519[_0x158b2f(0x18a)],'notes':_0xba3519[_0x158b2f(0x1d1)],'createdAt':_0xba3519[_0x158b2f(0x1ec)],'paidAt':_0xba3519[_0x158b2f(0x1b8)]})),'pagination':{'page':_0x3d3477,'limit':_0x87da8a,'total':_0x9a610b,'totalPages':Math[_0x158b2f(0x19e)](_0x9a610b/_0x87da8a)}};}async[a53_0x332f8a(0x1f6)](_0x12c5c5,_0x5df0cd){const _0x3c1dc0=a53_0x332f8a,_0x47d137=await database_1[_0x3c1dc0(0x1ae)]['payout'][_0x3c1dc0(0x1e2)]({'where':{'id':_0x5df0cd,'shopId':_0x12c5c5}});if(!_0x47d137)return null;return{'id':_0x47d137['id'],'amount':_0x47d137[_0x3c1dc0(0x207)],'network':_0x47d137['network'],'status':_0x47d137['status'],'txid':_0x47d137['txid'],'notes':_0x47d137[_0x3c1dc0(0x1d1)],'createdAt':_0x47d137['createdAt'],'paidAt':_0x47d137[_0x3c1dc0(0x1b8)]};}async[a53_0x332f8a(0x1c6)](_0x52f134,_0xb12b1f){const _0x199300=a53_0x332f8a,_0x223fca=new Date();let _0xe68c65;switch(_0xb12b1f){case'7d':_0xe68c65=new Date(_0x223fca[_0x199300(0x201)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0xe68c65=new Date(_0x223fca[_0x199300(0x201)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x199300(0x1db):_0xe68c65=new Date(_0x223fca['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xe68c65=new Date(_0x223fca[_0x199300(0x201)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x3870bd,_0x5b5fcd,_0x163a85,_0x30ee49,_0x49cb60,_0x1f0726]=await Promise[_0x199300(0x1ea)]([database_1[_0x199300(0x1ae)]['payout'][_0x199300(0x1a9)]({'where':{'shopId':_0x52f134,'createdAt':{'gte':_0xe68c65}}}),database_1[_0x199300(0x1ae)][_0x199300(0x1c5)][_0x199300(0x1a9)]({'where':{'shopId':_0x52f134,'status':_0x199300(0x18e),'createdAt':{'gte':_0xe68c65}}}),database_1['default'][_0x199300(0x1c5)][_0x199300(0x1a9)]({'where':{'shopId':_0x52f134,'status':_0x199300(0x1e4),'createdAt':{'gte':_0xe68c65}}}),database_1['default'][_0x199300(0x1c5)]['count']({'where':{'shopId':_0x52f134,'status':_0x199300(0x1ff),'createdAt':{'gte':_0xe68c65}}}),database_1[_0x199300(0x1ae)][_0x199300(0x1c5)][_0x199300(0x187)]({'where':{'shopId':_0x52f134,'createdAt':{'gte':_0xe68c65}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x199300(0x1ae)][_0x199300(0x1c5)][_0x199300(0x187)]({'where':{'shopId':_0x52f134},'take':0xa,'orderBy':{'createdAt':_0x199300(0x1cb)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x15d6cc=_0x49cb60[_0x199300(0x1f5)]((_0x2f6b08,_0x22f55b)=>_0x2f6b08+_0x22f55b[_0x199300(0x207)],0x0),_0x1fbd87=_0x49cb60[_0x199300(0x1a8)](_0x13d318=>_0x13d318['status']===_0x199300(0x18e))[_0x199300(0x1f5)]((_0x12d3b1,_0x4123b8)=>_0x12d3b1+_0x4123b8[_0x199300(0x207)],0x0),_0x2a9df5=_0x49cb60[_0x199300(0x1a8)](_0x45270a=>_0x45270a[_0x199300(0x1e1)]===_0x199300(0x1e4))[_0x199300(0x1f5)]((_0x4fc594,_0x51343c)=>_0x4fc594+_0x51343c[_0x199300(0x207)],0x0),_0x4a0607=_0x49cb60[_0x199300(0x1f5)]((_0x53f5eb,_0x4a8d47)=>{const _0x351cb5=_0x199300;return _0x53f5eb[_0x4a8d47['network']]=(_0x53f5eb[_0x4a8d47[_0x351cb5(0x206)]]||0x0)+0x1,_0x53f5eb;},{}),_0x4516fc=_0x49cb60['reduce']((_0xc10480,_0x22e860)=>{const _0x187532=_0x199300;return _0xc10480[_0x22e860[_0x187532(0x1e1)]]=(_0xc10480[_0x22e860['status']]||0x0)+0x1,_0xc10480;},{});return{'totalPayouts':_0x3870bd,'completedPayouts':_0x5b5fcd,'pendingPayouts':_0x163a85,'rejectedPayouts':_0x30ee49,'totalAmount':_0x15d6cc,'completedAmount':_0x1fbd87,'pendingAmount':_0x2a9df5,'payoutsByMethod':_0x4a0607,'payoutsByStatus':_0x4516fc,'recentPayouts':_0x1f0726[_0x199300(0x1ce)](_0x2861dc=>({'id':_0x2861dc['id'],'shopId':_0x52f134,'amount':_0x2861dc[_0x199300(0x207)],'method':_0x2861dc[_0x199300(0x206)],'status':_0x2861dc['status'],'txid':_0x2861dc[_0x199300(0x18a)],'createdAt':_0x2861dc['createdAt'],'paidAt':_0x2861dc[_0x199300(0x1b8)]}))};}async['getShopPayoutStats'](_0x59a1e8){const _0x3e2eb1=a53_0x332f8a;console[_0x3e2eb1(0x1b4)](_0x3e2eb1(0x1d6)+_0x59a1e8+'...');const _0x4ab2c3=await database_1[_0x3e2eb1(0x1ae)][_0x3e2eb1(0x1d5)][_0x3e2eb1(0x1e0)]({'where':{'id':_0x59a1e8},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x4ab2c3)throw new Error('Shop\x20not\x20found');const _0x1dc484=new Date(),_0x209d30=new Date(_0x1dc484[_0x3e2eb1(0x1b3)](),_0x1dc484[_0x3e2eb1(0x183)](),0x1),_0x4f4c11=new Date(_0x1dc484['getFullYear'](),_0x1dc484[_0x3e2eb1(0x183)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x1c4a71=await database_1[_0x3e2eb1(0x1ae)]['payout']['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x59a1e8,'createdAt':{'gte':_0x209d30,'lte':_0x4f4c11},'status':_0x3e2eb1(0x18e)}}),_0x661142=_0x1c4a71[_0x3e2eb1(0x176)][_0x3e2eb1(0x207)]||0x0,_0x136276={'availableBalance':Math[_0x3e2eb1(0x1ed)](_0x4ab2c3[_0x3e2eb1(0x180)]*0x64)/0x64,'totalPaidOut':Math[_0x3e2eb1(0x1ed)](_0x4ab2c3['totalPaidOut']*0x64)/0x64,'awaitingPayout':Math[_0x3e2eb1(0x1ed)](_0x4ab2c3[_0x3e2eb1(0x180)]*0x64)/0x64,'thisMonth':Math['round'](_0x661142*0x64)/0x64};return console[_0x3e2eb1(0x1b4)](_0x3e2eb1(0x1fe)+_0x4ab2c3[_0x3e2eb1(0x1f7)]+_0x3e2eb1(0x1d3)),console['log']('\x20\x20\x20üíµ\x20Available\x20balance:\x20'+_0x136276[_0x3e2eb1(0x1eb)]+_0x3e2eb1(0x197)),console[_0x3e2eb1(0x1b4)]('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x136276[_0x3e2eb1(0x1bc)]+_0x3e2eb1(0x1da)),console[_0x3e2eb1(0x1b4)](_0x3e2eb1(0x1a6)+_0x136276[_0x3e2eb1(0x175)]+_0x3e2eb1(0x197)),console['log'](_0x3e2eb1(0x17e)+_0x136276[_0x3e2eb1(0x1a4)]+_0x3e2eb1(0x174)),_0x136276;}['getGatewayDisplayName'](_0xdac2d6){const _0x1a8c68=a53_0x332f8a,_0x1c4002={'test_gateway':_0x1a8c68(0x1d9),'plisio':'Plisio','rapyd':_0x1a8c68(0x191),'noda':'Noda','cointopay':'CoinToPay','klyme_eu':'KLYME\x20EU','klyme_gb':_0x1a8c68(0x1c0),'klyme_de':_0x1a8c68(0x1bb)};return _0x1c4002[_0xdac2d6]||_0xdac2d6;}async['getPayoutStats'](_0x2c073b){const _0x59fb66=a53_0x332f8a;return this[_0x59fb66(0x1e3)](_0x2c073b);}async['getWebhookLogs'](_0x1d15f4,_0x146ae3){const _0xf98311=a53_0x332f8a,{page:_0x2e3d69,limit:_0x110e05,paymentId:_0x412db3}=_0x146ae3,_0x1eaaa8=(_0x2e3d69-0x1)*_0x110e05,_0x1feffd={'shopId':_0x1d15f4};_0x412db3&&(_0x1feffd[_0xf98311(0x177)]=_0x412db3);const [_0x2b0921,_0x36cd31]=await Promise['all']([database_1[_0xf98311(0x1ae)]['webhookLog'][_0xf98311(0x187)]({'where':_0x1feffd,'skip':_0x1eaaa8,'take':_0x110e05,'orderBy':{'createdAt':_0xf98311(0x1cb)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0xf98311(0x1ae)][_0xf98311(0x19c)]['count']({'where':_0x1feffd})]);return{'logs':_0x2b0921[_0xf98311(0x1ce)](_0x37e6a6=>({'id':_0x37e6a6['id'],'paymentId':_0x37e6a6['paymentId'],'shopId':_0x37e6a6[_0xf98311(0x1f8)],'event':_0x37e6a6[_0xf98311(0x200)],'statusCode':_0x37e6a6['statusCode'],'retryCount':_0x37e6a6[_0xf98311(0x17c)],'responseBody':_0x37e6a6[_0xf98311(0x178)],'createdAt':_0x37e6a6[_0xf98311(0x1ec)],'payment':_0x37e6a6[_0xf98311(0x202)]})),'pagination':{'page':_0x2e3d69,'limit':_0x110e05,'total':_0x36cd31,'totalPages':Math['ceil'](_0x36cd31/_0x110e05)}};}async['getStatistics'](_0x59f8a7,_0x48009b){const _0x25aed2=a53_0x332f8a,_0x54488a=new Date();let _0x52cfb5;switch(_0x48009b){case'7d':_0x52cfb5=new Date(_0x54488a[_0x25aed2(0x201)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x25aed2(0x18c):_0x52cfb5=new Date(_0x54488a[_0x25aed2(0x201)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x25aed2(0x1db):_0x52cfb5=new Date(_0x54488a[_0x25aed2(0x201)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x52cfb5=new Date(_0x54488a[_0x25aed2(0x201)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x23c050,_0x49a741,_0x4d034d,_0xf191f9,_0x6d28a0]=await Promise[_0x25aed2(0x1ea)]([database_1[_0x25aed2(0x1ae)][_0x25aed2(0x202)][_0x25aed2(0x1a9)]({'where':{'shopId':_0x59f8a7,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x52cfb5}}}),database_1[_0x25aed2(0x1ae)][_0x25aed2(0x202)]['count']({'where':{'shopId':_0x59f8a7,'gateway':{'not':_0x25aed2(0x1b9)},'status':'PAID','createdAt':{'gte':_0x52cfb5}}}),database_1[_0x25aed2(0x1ae)]['payment'][_0x25aed2(0x187)]({'where':{'shopId':_0x59f8a7,'gateway':{'not':'test_gateway'},'status':'PAID','createdAt':{'gte':_0x52cfb5}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x25aed2(0x1ae)]['payment']['findMany']({'where':{'shopId':_0x59f8a7,'gateway':{'not':_0x25aed2(0x1b9)}},'take':0xa,'orderBy':{'createdAt':_0x25aed2(0x1cb)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x25aed2(0x1ae)][_0x25aed2(0x202)]['findMany']({'where':{'shopId':_0x59f8a7,'gateway':{'not':_0x25aed2(0x1b9)},'createdAt':{'gte':_0x52cfb5}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x25aed2(0x1d7)}})]);let _0x5c9cd9=0x0;for(const _0x232d08 of _0x4d034d){if(_0x232d08[_0x25aed2(0x1be)])_0x5c9cd9+=_0x232d08['amountUSDT'];else{const _0x1ab432=await currencyService_1[_0x25aed2(0x199)][_0x25aed2(0x1c8)](_0x232d08[_0x25aed2(0x207)],_0x232d08[_0x25aed2(0x1c1)]);_0x5c9cd9+=_0x1ab432;}}const _0x18c550=this[_0x25aed2(0x188)](_0x6d28a0,_0x52cfb5,_0x54488a),_0x3ae88d=_0x23c050>0x0?_0x49a741/_0x23c050*0x64:0x0;return{'totalPayments':_0x23c050,'successfulPayments':_0x49a741,'totalRevenue':Math[_0x25aed2(0x1ed)](_0x5c9cd9*0x64)/0x64,'conversionRate':Math[_0x25aed2(0x1ed)](_0x3ae88d*0x64)/0x64,'dailyRevenue':_0x18c550[_0x25aed2(0x1d4)],'dailyPayments':_0x18c550['dailyPayments'],'recentPayments':_0xf191f9[_0x25aed2(0x1ce)](_0x534389=>({'id':_0x534389['id'],'gateway':_0x534389[_0x25aed2(0x1a5)],'amount':_0x534389[_0x25aed2(0x207)],'currency':_0x534389[_0x25aed2(0x1c1)],'status':_0x534389[_0x25aed2(0x1e1)],'createdAt':_0x534389['createdAt']}))};}[a53_0x332f8a(0x188)](_0x11e3c2,_0x4845b9,_0x1c0ec4){const _0x426656=a53_0x332f8a,_0x3bddf2=new Map(),_0x43bff9=new Date(_0x4845b9);while(_0x43bff9<=_0x1c0ec4){const _0x244d01=_0x43bff9[_0x426656(0x19f)]()[_0x426656(0x1e8)]('T')[0x0];_0x3bddf2[_0x426656(0x18b)](_0x244d01,{'revenue':0x0,'count':0x0}),_0x43bff9['setDate'](_0x43bff9[_0x426656(0x189)]()+0x1);}for(const _0x56627f of _0x11e3c2){const _0x162d3f=_0x56627f[_0x426656(0x1ec)][_0x426656(0x19f)]()[_0x426656(0x1e8)]('T')[0x0],_0x3a0596=_0x3bddf2[_0x426656(0x1fa)](_0x162d3f);_0x3a0596&&(_0x3a0596[_0x426656(0x1a9)]+=0x1,_0x56627f['status']===_0x426656(0x1b7)&&_0x56627f[_0x426656(0x1be)]&&(_0x3a0596['revenue']+=_0x56627f['amountUSDT']));}const _0xc8e5ba=[],_0x577cbf=[];for(const [_0x12da1e,_0x227335]of _0x3bddf2){_0xc8e5ba['push']({'date':_0x12da1e,'amount':Math[_0x426656(0x1ed)](_0x227335['revenue']*0x64)/0x64}),_0x577cbf['push']({'date':_0x12da1e,'count':_0x227335[_0x426656(0x1a9)]});}return{'dailyRevenue':_0xc8e5ba,'dailyPayments':_0x577cbf};}}exports[a53_0x332f8a(0x1c2)]=ShopService;