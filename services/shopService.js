'use strict';const a54_0x1df13a=a54_0x5d14;function a54_0x5d14(_0x4f0419,_0x279789){const _0x24681f=a54_0x2468();return a54_0x5d14=function(_0x5d14b7,_0x5a6243){_0x5d14b7=_0x5d14b7-0xca;let _0xb8f6d1=_0x24681f[_0x5d14b7];return _0xb8f6d1;},a54_0x5d14(_0x4f0419,_0x279789);}function a54_0x2468(){const _0x309158=['findUnique','REJECTED','thisMonth','desc','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','push','language','70lygeUl','log','application/json','Noda','settings','paid','COMPLETED','txid','periodFrom','parse','No\x20webhook\x20URL\x20configured','awaitingPayout','usage','getPayments','Plisio','Webhook\x20returned\x20error:\x20','Payment\x20not\x20found','Failed\x20to\x20send\x20webhook:\x20','10MqSwIk','gateway','paymentId','USDT\x20Polygon','_sum','totalPaidOut','setHours','dailyRevenue','customerEmail','4OpeXkQ','currency','\x20\x20\x20üìÖ\x20This\x20month:\x20','webhookUrl','usdtTrcWallet','KLYME\x20GB','updateShopProfile','paidAt','split','event','getTime','expiresAt','23849rGdrix','sourceCurrency','set','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','count','redirectUrl','telegramId','all','payout','default','round','usdcPolygonWallet','username','üí∞\x20Getting\x20payouts\x20with\x20filters:','getShopPayoutStats','dailyPayments','trc20','isArray','\x20USDT','formatNetworkName','updatePayment','getDate','getFullYear','üìÖ\x20Date\x20start:\x20','2750613UyQbAe','createdAt','wallets','861597ktqexO','Error\x20parsing\x20webhook\x20events:','telegram','test','customer','maxPayments','defineProperty','üìä\x20Status\x20filter:\x20','status','440leNnpI','amountUSDT','toUpperCase','./currencyService','gatewaySettings','Test\x20Gateway','test_payment_123','merchantUrl','paymentGateways','USDT\x20ERC20','convertToUSDT','90d','periodTo','network','30d','notes','lte','shop','statusText','currencyService','getPaymentByShopAndId','getShopProfile','stringify','1284wywgkD','gte','shopUrl','ceil','test_gateway','generateDailyStatistics','\x20USDT\x20(total\x20payouts)','getPayouts','name','./paymentService','webhookLog','map','getStatistics','polygon_usdc','246763tWWxzE','setDate','findMany','PAID','getPaymentsByShop','balance','7666119HgGwSJ','üìÖ\x20Period\x20end:\x20','paymentService','getPaymentById','1411742rVeKJs','getPayoutStatistics','webhookEvents','toISOString','filter','testWebhook','üìÖ\x20Period\x20start:\x20','usdtErcWallet','amount','üìä\x20Shop\x20','__importDefault','__esModule','\x20\x20\x20üíµ\x20Available\x20balance:\x20','availableBalance','payment','üåê\x20Network\x20filter:\x20','USD','publicKey','\x20payout\x20statistics\x20calculated:','createPayment','error','getMonth','findFirst','message','shopId','65316fBUIbO','update','responseBody','fullName','reduce','revenue','usdtPolygonWallet','PENDING','...','gateways','deletePayment','Shop\x20not\x20found'];a54_0x2468=function(){return _0x309158;};return a54_0x2468();}(function(_0x1d2f68,_0x55ef01){const _0x50bba0=a54_0x5d14,_0x2effbf=_0x1d2f68();while(!![]){try{const _0x104d2d=-parseInt(_0x50bba0(0x155))/0x1+-parseInt(_0x50bba0(0xe7))/0x2+parseInt(_0x50bba0(0x152))/0x3*(parseInt(_0x50bba0(0x12e))/0x4)+parseInt(_0x50bba0(0x113))/0x5*(-parseInt(_0x50bba0(0x100))/0x6)+parseInt(_0x50bba0(0x13a))/0x7*(-parseInt(_0x50bba0(0x15e))/0x8)+parseInt(_0x50bba0(0xe3))/0x9*(-parseInt(_0x50bba0(0x125))/0xa)+-parseInt(_0x50bba0(0xdd))/0xb*(-parseInt(_0x50bba0(0xcf))/0xc);if(_0x104d2d===_0x55ef01)break;else _0x2effbf['push'](_0x2effbf['shift']());}catch(_0xf0c13a){_0x2effbf['push'](_0x2effbf['shift']());}}}(a54_0x2468,0x8844a));var __importDefault=this&&this[a54_0x1df13a(0xf1)]||function(_0x4a9170){const _0x366d94=a54_0x1df13a;return _0x4a9170&&_0x4a9170[_0x366d94(0xf2)]?_0x4a9170:{'default':_0x4a9170};};Object[a54_0x1df13a(0x15b)](exports,a54_0x1df13a(0xf2),{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require(a54_0x1df13a(0x161)),paymentService_1=require(a54_0x1df13a(0xd8));class ShopService{constructor(){const _0x1c0ffb=a54_0x1df13a;this[_0x1c0ffb(0xe5)]=new paymentService_1['PaymentService']();}async[a54_0x1df13a(0xcd)](_0x419cca){const _0x1083f3=a54_0x1df13a,_0x11460b=await database_1['default'][_0x1083f3(0x16f)][_0x1083f3(0x10c)]({'where':{'id':_0x419cca},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x11460b)throw new Error(_0x1083f3(0x10b));let _0x45e2d8=[];if(_0x11460b[_0x1083f3(0x117)]?.[_0x1083f3(0xe9)])try{_0x45e2d8=Array['isArray'](_0x11460b[_0x1083f3(0x117)][_0x1083f3(0xe9)])?_0x11460b[_0x1083f3(0x117)][_0x1083f3(0xe9)]:JSON['parse'](_0x11460b[_0x1083f3(0x117)][_0x1083f3(0xe9)]);}catch(_0xaaf11b){console['error'](_0x1083f3(0x156),_0xaaf11b),_0x45e2d8=[];}return{'id':_0x11460b['id'],'fullName':_0x11460b['name'],'username':_0x11460b[_0x1083f3(0x146)],'telegramId':_0x11460b[_0x1083f3(0x157)],'merchantUrl':_0x11460b[_0x1083f3(0xd1)],'gateways':_0x11460b[_0x1083f3(0x166)]?JSON[_0x1083f3(0x11c)](_0x11460b['paymentGateways']):null,'gatewaySettings':_0x11460b[_0x1083f3(0x162)]?JSON[_0x1083f3(0x11c)](_0x11460b[_0x1083f3(0x162)]):null,'publicKey':_0x11460b['publicKey'],'webhookUrl':_0x11460b[_0x1083f3(0x117)]?.[_0x1083f3(0x131)]||null,'webhookEvents':_0x45e2d8,'wallets':{'usdtPolygonWallet':_0x11460b[_0x1083f3(0x106)],'usdtTrcWallet':_0x11460b[_0x1083f3(0x132)],'usdtErcWallet':_0x11460b[_0x1083f3(0xee)],'usdcPolygonWallet':_0x11460b[_0x1083f3(0x145)]},'status':_0x11460b[_0x1083f3(0x15d)],'createdAt':_0x11460b[_0x1083f3(0x153)]};}async[a54_0x1df13a(0x134)](_0x37b0ca,_0x57c484){const _0x4c81dd=a54_0x1df13a,_0x49d959={};_0x57c484[_0x4c81dd(0x103)]&&(_0x49d959[_0x4c81dd(0xd7)]=_0x57c484[_0x4c81dd(0x103)]);_0x57c484[_0x4c81dd(0x140)]!==undefined&&(_0x49d959[_0x4c81dd(0x157)]=_0x57c484['telegramId']||null);_0x57c484[_0x4c81dd(0x165)]&&(_0x49d959[_0x4c81dd(0xd1)]=_0x57c484[_0x4c81dd(0x165)]);_0x57c484[_0x4c81dd(0x109)]&&(_0x49d959[_0x4c81dd(0x166)]=JSON[_0x4c81dd(0xce)](_0x57c484['gateways']));_0x57c484[_0x4c81dd(0x162)]&&(_0x49d959[_0x4c81dd(0x162)]=JSON[_0x4c81dd(0xce)](_0x57c484[_0x4c81dd(0x162)]));_0x57c484['wallets']&&(_0x57c484[_0x4c81dd(0x154)][_0x4c81dd(0x106)]!==undefined&&(_0x49d959[_0x4c81dd(0x106)]=_0x57c484['wallets']['usdtPolygonWallet']||null),_0x57c484[_0x4c81dd(0x154)][_0x4c81dd(0x132)]!==undefined&&(_0x49d959[_0x4c81dd(0x132)]=_0x57c484['wallets'][_0x4c81dd(0x132)]||null),_0x57c484[_0x4c81dd(0x154)][_0x4c81dd(0xee)]!==undefined&&(_0x49d959[_0x4c81dd(0xee)]=_0x57c484[_0x4c81dd(0x154)][_0x4c81dd(0xee)]||null),_0x57c484[_0x4c81dd(0x154)]['usdcPolygonWallet']!==undefined&&(_0x49d959[_0x4c81dd(0x145)]=_0x57c484['wallets']['usdcPolygonWallet']||null));const _0x33f1ff=await database_1[_0x4c81dd(0x143)][_0x4c81dd(0x16f)][_0x4c81dd(0x101)]({'where':{'id':_0x37b0ca},'data':_0x49d959,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x5afaef=[];if(_0x33f1ff['settings']?.['webhookEvents'])try{_0x5afaef=Array[_0x4c81dd(0x14b)](_0x33f1ff[_0x4c81dd(0x117)]['webhookEvents'])?_0x33f1ff[_0x4c81dd(0x117)][_0x4c81dd(0xe9)]:JSON[_0x4c81dd(0x11c)](_0x33f1ff[_0x4c81dd(0x117)][_0x4c81dd(0xe9)]);}catch(_0x39b69d){console[_0x4c81dd(0xfb)]('Error\x20parsing\x20webhook\x20events:',_0x39b69d),_0x5afaef=[];}return{'id':_0x33f1ff['id'],'fullName':_0x33f1ff[_0x4c81dd(0xd7)],'username':_0x33f1ff[_0x4c81dd(0x146)],'telegramId':_0x33f1ff[_0x4c81dd(0x157)],'merchantUrl':_0x33f1ff[_0x4c81dd(0xd1)],'gateways':_0x33f1ff['paymentGateways']?JSON[_0x4c81dd(0x11c)](_0x33f1ff[_0x4c81dd(0x166)]):null,'gatewaySettings':_0x33f1ff[_0x4c81dd(0x162)]?JSON[_0x4c81dd(0x11c)](_0x33f1ff[_0x4c81dd(0x162)]):null,'publicKey':_0x33f1ff[_0x4c81dd(0xf8)],'webhookUrl':_0x33f1ff[_0x4c81dd(0x117)]?.[_0x4c81dd(0x131)]||null,'webhookEvents':_0x5afaef,'wallets':{'usdtPolygonWallet':_0x33f1ff[_0x4c81dd(0x106)],'usdtTrcWallet':_0x33f1ff[_0x4c81dd(0x132)],'usdtErcWallet':_0x33f1ff[_0x4c81dd(0xee)],'usdcPolygonWallet':_0x33f1ff[_0x4c81dd(0x145)]},'status':_0x33f1ff[_0x4c81dd(0x15d)],'createdAt':_0x33f1ff[_0x4c81dd(0x153)]};}async['updateWallets'](_0x1f742e,_0x12658d){const _0x488e06=a54_0x1df13a,_0x3f3c81={};_0x12658d[_0x488e06(0x106)]!==undefined&&(_0x3f3c81[_0x488e06(0x106)]=_0x12658d['usdtPolygonWallet']||null),_0x12658d[_0x488e06(0x132)]!==undefined&&(_0x3f3c81[_0x488e06(0x132)]=_0x12658d[_0x488e06(0x132)]||null),_0x12658d[_0x488e06(0xee)]!==undefined&&(_0x3f3c81[_0x488e06(0xee)]=_0x12658d[_0x488e06(0xee)]||null),_0x12658d[_0x488e06(0x145)]!==undefined&&(_0x3f3c81['usdcPolygonWallet']=_0x12658d[_0x488e06(0x145)]||null),await database_1[_0x488e06(0x143)][_0x488e06(0x16f)][_0x488e06(0x101)]({'where':{'id':_0x1f742e},'data':_0x3f3c81});}async[a54_0x1df13a(0xec)](_0x4374a6){const _0x2af6db=a54_0x1df13a,_0x1b14ff=await database_1['default'][_0x2af6db(0x16f)]['findUnique']({'where':{'id':_0x4374a6},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x1b14ff?.[_0x2af6db(0x117)]?.['webhookUrl'])throw new Error(_0x2af6db(0x11d));const _0x4dc2dd={'event':_0x2af6db(0x158),'payment':{'id':_0x2af6db(0x164),'order_id':'test_order_123','gateway':_0x2af6db(0x158),'amount':0x64,'currency':_0x2af6db(0xf7),'status':_0x2af6db(0x118),'created_at':new Date()[_0x2af6db(0xea)]()}};try{const _0x453b2b=await fetch(_0x1b14ff[_0x2af6db(0x117)]['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x2af6db(0x115),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON[_0x2af6db(0xce)](_0x4dc2dd)});return _0x453b2b['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x453b2b[_0x2af6db(0x15d)]+')'}:{'success':![],'message':_0x2af6db(0x122)+_0x453b2b[_0x2af6db(0x15d)]+'\x20'+_0x453b2b[_0x2af6db(0xca)]};}catch(_0x13d539){return{'success':![],'message':_0x2af6db(0x124)+(_0x13d539 instanceof Error?_0x13d539[_0x2af6db(0xfe)]:'Unknown\x20error')};}}async[a54_0x1df13a(0xfa)](_0x24d27b){const _0xeef66b=a54_0x1df13a;return this[_0xeef66b(0xe5)]['createPublicPayment']({'public_key':'','gateway':_0x24d27b[_0xeef66b(0x126)],'order_id':undefined,'amount':_0x24d27b[_0xeef66b(0xef)],'currency':_0x24d27b[_0xeef66b(0x12f)],'source_currency':_0x24d27b[_0xeef66b(0x13b)],'usage':_0x24d27b[_0xeef66b(0x11f)],'expires_at':_0x24d27b[_0xeef66b(0x139)]?.[_0xeef66b(0xea)](),'success_url':_0x24d27b['redirectUrl'],'fail_url':_0x24d27b[_0xeef66b(0x13f)],'customer_email':_0x24d27b[_0xeef66b(0x12d)],'customer_name':_0x24d27b['customerName'],'country':_0x24d27b['country'],'language':_0x24d27b[_0xeef66b(0x112)],'amount_is_editable':_0x24d27b['amountIsEditable'],'max_payments':_0x24d27b[_0xeef66b(0x15a)],'customer':_0x24d27b[_0xeef66b(0x159)]});}async[a54_0x1df13a(0x120)](_0x37372f,_0x5b2eeb){const _0x19248d=a54_0x1df13a;return this[_0x19248d(0xe5)][_0x19248d(0xe1)](_0x37372f,_0x5b2eeb);}async[a54_0x1df13a(0xe6)](_0x4d79fa,_0xf77ea3){const _0x2c40e6=a54_0x1df13a;return this[_0x2c40e6(0xe5)][_0x2c40e6(0xcc)](_0x4d79fa,_0xf77ea3);}async[a54_0x1df13a(0x14e)](_0x5c6421,_0x1bc3da,_0x5118a1){const _0x20008=a54_0x1df13a,_0x1aef0e=await database_1[_0x20008(0x143)][_0x20008(0xf5)][_0x20008(0xfd)]({'where':{'id':_0x1bc3da,'shopId':_0x5c6421}});if(!_0x1aef0e)throw new Error(_0x20008(0x123));const _0x37b135=await database_1[_0x20008(0x143)]['payment'][_0x20008(0x101)]({'where':{'id':_0x1bc3da},'data':{..._0x5118a1,'updatedAt':new Date()}});return _0x37b135;}async[a54_0x1df13a(0x10a)](_0x49639a,_0x14d829){const _0x20a060=a54_0x1df13a,_0xe33f65=await database_1['default']['payment'][_0x20a060(0xfd)]({'where':{'id':_0x14d829,'shopId':_0x49639a}});if(!_0xe33f65)throw new Error('Payment\x20not\x20found');await database_1['default'][_0x20a060(0xf5)]['delete']({'where':{'id':_0x14d829}});}[a54_0x1df13a(0x14d)](_0x31cd00){const _0x104798=a54_0x1df13a,_0xac6698={'polygon':_0x104798(0x128),'trc20':'USDT\x20TRC20','erc20':_0x104798(0x167),'bsc':'USDT\x20BSC','polygon_usdc':'USDC\x20Polygon'};return _0xac6698[_0x31cd00]||_0x31cd00;}async[a54_0x1df13a(0xd6)](_0x5ea1d8,_0x560d3d){const _0x28768a=a54_0x1df13a,{page:_0x2bb998,limit:_0x50ce90,status:_0x544940,method:_0x442f73,network:_0x18fe5a,dateFrom:_0x536ac4,dateTo:_0x5e56cf,periodFrom:_0x4c24fb,periodTo:_0x49e165}=_0x560d3d,_0x226ead=(_0x2bb998-0x1)*_0x50ce90;console[_0x28768a(0x114)](_0x28768a(0x147),_0x560d3d);const _0x3596de={'shopId':_0x5ea1d8};_0x544940&&(_0x3596de['status']=_0x544940['toUpperCase'](),console[_0x28768a(0x114)](_0x28768a(0x15c)+_0x544940[_0x28768a(0x160)]()));if(_0x442f73)_0x3596de[_0x28768a(0x16b)]=_0x442f73,console['log']('üåê\x20Method\x20filter:\x20'+_0x442f73);else _0x18fe5a&&(_0x3596de[_0x28768a(0x16b)]=_0x18fe5a,console['log'](_0x28768a(0xf6)+_0x18fe5a));if(_0x536ac4||_0x5e56cf||_0x4c24fb||_0x49e165){_0x3596de[_0x28768a(0x153)]={};if(_0x4c24fb){const _0x1a09cd=new Date(_0x4c24fb);_0x1a09cd[_0x28768a(0x12b)](0x0,0x0,0x0,0x0),_0x3596de[_0x28768a(0x153)][_0x28768a(0xd0)]=_0x1a09cd,console[_0x28768a(0x114)](_0x28768a(0xed)+_0x1a09cd[_0x28768a(0xea)]());}else{if(_0x536ac4){const _0x251570=new Date(_0x536ac4);_0x251570['setHours'](0x0,0x0,0x0,0x0),_0x3596de[_0x28768a(0x153)][_0x28768a(0xd0)]=_0x251570,console[_0x28768a(0x114)](_0x28768a(0x151)+_0x251570[_0x28768a(0xea)]());}}if(_0x49e165){const _0x1d6dc5=new Date(_0x49e165);_0x1d6dc5['setHours'](0x17,0x3b,0x3b,0x3e7),_0x3596de[_0x28768a(0x153)][_0x28768a(0x16e)]=_0x1d6dc5,console['log'](_0x28768a(0xe4)+_0x1d6dc5[_0x28768a(0xea)]());}else{if(_0x5e56cf){const _0x3c4146=new Date(_0x5e56cf);_0x3c4146['setHours'](0x17,0x3b,0x3b,0x3e7),_0x3596de[_0x28768a(0x153)][_0x28768a(0x16e)]=_0x3c4146,console[_0x28768a(0x114)]('üìÖ\x20Date\x20end:\x20'+_0x3c4146[_0x28768a(0xea)]());}}}console[_0x28768a(0x114)]('üìä\x20Final\x20WHERE\x20conditions:',JSON[_0x28768a(0xce)](_0x3596de,null,0x2));const [_0x405e06,_0x3a4348]=await Promise[_0x28768a(0x141)]([database_1[_0x28768a(0x143)]['payout'][_0x28768a(0xdf)]({'where':_0x3596de,'skip':_0x226ead,'take':_0x50ce90,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x28768a(0x143)][_0x28768a(0x142)]['count']({'where':_0x3596de})]);return{'payouts':_0x405e06['map'](_0x2053e6=>{const _0x6018a2=_0x28768a;let _0x496a75=null;switch(_0x2053e6[_0x6018a2(0x16b)]){case'polygon':_0x496a75=_0x2053e6['shop'][_0x6018a2(0x106)];break;case _0x6018a2(0x14a):_0x496a75=_0x2053e6[_0x6018a2(0x16f)]['usdtTrcWallet'];break;case'erc20':_0x496a75=_0x2053e6[_0x6018a2(0x16f)][_0x6018a2(0xee)];break;case _0x6018a2(0xdc):_0x496a75=_0x2053e6[_0x6018a2(0x16f)][_0x6018a2(0x145)];break;}return{'id':_0x2053e6['id'],'amount':_0x2053e6[_0x6018a2(0xef)],'network':this[_0x6018a2(0x14d)](_0x2053e6[_0x6018a2(0x16b)]),'wallet':_0x496a75,'status':_0x2053e6[_0x6018a2(0x15d)],'txid':_0x2053e6[_0x6018a2(0x11a)],'notes':_0x2053e6[_0x6018a2(0x16d)],'periodFrom':_0x2053e6[_0x6018a2(0x11b)],'periodTo':_0x2053e6[_0x6018a2(0x16a)],'createdAt':_0x2053e6[_0x6018a2(0x153)],'paidAt':_0x2053e6[_0x6018a2(0x135)]};}),'pagination':{'page':_0x2bb998,'limit':_0x50ce90,'total':_0x3a4348,'totalPages':Math[_0x28768a(0xd2)](_0x3a4348/_0x50ce90)}};}async['getPayoutById'](_0x3a195d,_0x1a359b){const _0x4c12f9=a54_0x1df13a,_0x144bb1=await database_1[_0x4c12f9(0x143)]['payout']['findFirst']({'where':{'id':_0x1a359b,'shopId':_0x3a195d}});if(!_0x144bb1)return null;return{'id':_0x144bb1['id'],'amount':_0x144bb1[_0x4c12f9(0xef)],'network':_0x144bb1[_0x4c12f9(0x16b)],'status':_0x144bb1[_0x4c12f9(0x15d)],'txid':_0x144bb1[_0x4c12f9(0x11a)],'notes':_0x144bb1['notes'],'createdAt':_0x144bb1[_0x4c12f9(0x153)],'paidAt':_0x144bb1[_0x4c12f9(0x135)]};}async[a54_0x1df13a(0xe8)](_0xdc7466,_0xd41084){const _0x1298c5=a54_0x1df13a,_0x2d45d2=new Date();let _0x39a3a6;switch(_0xd41084){case'7d':_0x39a3a6=new Date(_0x2d45d2[_0x1298c5(0x138)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x1298c5(0x16c):_0x39a3a6=new Date(_0x2d45d2[_0x1298c5(0x138)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x1298c5(0x169):_0x39a3a6=new Date(_0x2d45d2[_0x1298c5(0x138)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x39a3a6=new Date(_0x2d45d2[_0x1298c5(0x138)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x6888ae,_0x1012a3,_0x5a411b,_0x1ae228,_0x529cb8,_0x34c3e5]=await Promise[_0x1298c5(0x141)]([database_1['default'][_0x1298c5(0x142)]['count']({'where':{'shopId':_0xdc7466,'createdAt':{'gte':_0x39a3a6}}}),database_1[_0x1298c5(0x143)]['payout'][_0x1298c5(0x13e)]({'where':{'shopId':_0xdc7466,'status':_0x1298c5(0x119),'createdAt':{'gte':_0x39a3a6}}}),database_1[_0x1298c5(0x143)][_0x1298c5(0x142)][_0x1298c5(0x13e)]({'where':{'shopId':_0xdc7466,'status':_0x1298c5(0x107),'createdAt':{'gte':_0x39a3a6}}}),database_1[_0x1298c5(0x143)][_0x1298c5(0x142)]['count']({'where':{'shopId':_0xdc7466,'status':_0x1298c5(0x10d),'createdAt':{'gte':_0x39a3a6}}}),database_1['default'][_0x1298c5(0x142)]['findMany']({'where':{'shopId':_0xdc7466,'createdAt':{'gte':_0x39a3a6}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x1298c5(0x143)]['payout'][_0x1298c5(0xdf)]({'where':{'shopId':_0xdc7466},'take':0xa,'orderBy':{'createdAt':_0x1298c5(0x10f)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x579442=_0x529cb8['reduce']((_0x2d8ed5,_0x30d920)=>_0x2d8ed5+_0x30d920['amount'],0x0),_0x3f1f81=_0x529cb8['filter'](_0x55dc43=>_0x55dc43[_0x1298c5(0x15d)]===_0x1298c5(0x119))[_0x1298c5(0x104)]((_0x48bb92,_0x2ac5a2)=>_0x48bb92+_0x2ac5a2[_0x1298c5(0xef)],0x0),_0x26df8d=_0x529cb8[_0x1298c5(0xeb)](_0x3006d3=>_0x3006d3[_0x1298c5(0x15d)]===_0x1298c5(0x107))[_0x1298c5(0x104)]((_0x28d17e,_0xe30ae)=>_0x28d17e+_0xe30ae[_0x1298c5(0xef)],0x0),_0x5e3238=_0x529cb8['reduce']((_0x233df6,_0x114c4e)=>{const _0x51e8f1=_0x1298c5;return _0x233df6[_0x114c4e[_0x51e8f1(0x16b)]]=(_0x233df6[_0x114c4e[_0x51e8f1(0x16b)]]||0x0)+0x1,_0x233df6;},{}),_0x3ef71c=_0x529cb8[_0x1298c5(0x104)]((_0x1d917b,_0x559884)=>{const _0x41204b=_0x1298c5;return _0x1d917b[_0x559884[_0x41204b(0x15d)]]=(_0x1d917b[_0x559884[_0x41204b(0x15d)]]||0x0)+0x1,_0x1d917b;},{});return{'totalPayouts':_0x6888ae,'completedPayouts':_0x1012a3,'pendingPayouts':_0x5a411b,'rejectedPayouts':_0x1ae228,'totalAmount':_0x579442,'completedAmount':_0x3f1f81,'pendingAmount':_0x26df8d,'payoutsByMethod':_0x5e3238,'payoutsByStatus':_0x3ef71c,'recentPayouts':_0x34c3e5['map'](_0x147b74=>({'id':_0x147b74['id'],'shopId':_0xdc7466,'amount':_0x147b74['amount'],'method':_0x147b74[_0x1298c5(0x16b)],'status':_0x147b74[_0x1298c5(0x15d)],'txid':_0x147b74[_0x1298c5(0x11a)],'createdAt':_0x147b74['createdAt'],'paidAt':_0x147b74[_0x1298c5(0x135)]}))};}async['getShopPayoutStats'](_0xd8033b){const _0x361455=a54_0x1df13a;console[_0x361455(0x114)](_0x361455(0x13d)+_0xd8033b+_0x361455(0x108));const _0x1e699f=await database_1[_0x361455(0x143)]['shop']['findUnique']({'where':{'id':_0xd8033b},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1e699f)throw new Error(_0x361455(0x10b));const _0x5d23a5=new Date(),_0x247a02=new Date(_0x5d23a5[_0x361455(0x150)](),_0x5d23a5[_0x361455(0xfc)](),0x1),_0x2b8012=new Date(_0x5d23a5[_0x361455(0x150)](),_0x5d23a5[_0x361455(0xfc)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x2e60a6=await database_1[_0x361455(0x143)][_0x361455(0x142)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0xd8033b,'createdAt':{'gte':_0x247a02,'lte':_0x2b8012},'status':_0x361455(0x119)}}),_0x498223=_0x2e60a6[_0x361455(0x129)][_0x361455(0xef)]||0x0,_0x36fd06={'availableBalance':Math[_0x361455(0x144)](_0x1e699f[_0x361455(0xe2)]*0x64)/0x64,'totalPaidOut':Math[_0x361455(0x144)](_0x1e699f[_0x361455(0x12a)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x1e699f[_0x361455(0xe2)]*0x64)/0x64,'thisMonth':Math[_0x361455(0x144)](_0x498223*0x64)/0x64};return console[_0x361455(0x114)](_0x361455(0xf0)+_0x1e699f[_0x361455(0x146)]+_0x361455(0xf9)),console[_0x361455(0x114)](_0x361455(0xf3)+_0x36fd06[_0x361455(0xf4)]+'\x20USDT\x20(current\x20balance)'),console[_0x361455(0x114)]('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x36fd06[_0x361455(0x12a)]+_0x361455(0xd5)),console['log'](_0x361455(0x110)+_0x36fd06[_0x361455(0x11e)]+'\x20USDT\x20(current\x20balance)'),console[_0x361455(0x114)](_0x361455(0x130)+_0x36fd06[_0x361455(0x10e)]+_0x361455(0x14c)),_0x36fd06;}['getGatewayDisplayName'](_0x223ea7){const _0x2c2431=a54_0x1df13a,_0x12066f={'test_gateway':_0x2c2431(0x163),'plisio':_0x2c2431(0x121),'rapyd':'Rapyd','noda':_0x2c2431(0x116),'cointopay':'CoinToPay','klyme_eu':'KLYME\x20EU','klyme_gb':_0x2c2431(0x133),'klyme_de':'KLYME\x20DE'};return _0x12066f[_0x223ea7]||_0x223ea7;}async['getPayoutStats'](_0x1ebfd6){const _0x37fb63=a54_0x1df13a;return this[_0x37fb63(0x148)](_0x1ebfd6);}async['getWebhookLogs'](_0x1972a9,_0x5ee3f2){const _0x190ca8=a54_0x1df13a,{page:_0x1a320d,limit:_0x92d310,paymentId:_0x18da14}=_0x5ee3f2,_0x45382b=(_0x1a320d-0x1)*_0x92d310,_0x1d979e={'shopId':_0x1972a9};_0x18da14&&(_0x1d979e['paymentId']=_0x18da14);const [_0x272035,_0x69e318]=await Promise['all']([database_1[_0x190ca8(0x143)][_0x190ca8(0xd9)]['findMany']({'where':_0x1d979e,'skip':_0x45382b,'take':_0x92d310,'orderBy':{'createdAt':_0x190ca8(0x10f)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x190ca8(0x143)]['webhookLog'][_0x190ca8(0x13e)]({'where':_0x1d979e})]);return{'logs':_0x272035[_0x190ca8(0xda)](_0x554a9c=>({'id':_0x554a9c['id'],'paymentId':_0x554a9c[_0x190ca8(0x127)],'shopId':_0x554a9c[_0x190ca8(0xff)],'event':_0x554a9c[_0x190ca8(0x137)],'statusCode':_0x554a9c['statusCode'],'retryCount':_0x554a9c['retryCount'],'responseBody':_0x554a9c[_0x190ca8(0x102)],'createdAt':_0x554a9c[_0x190ca8(0x153)],'payment':_0x554a9c[_0x190ca8(0xf5)]})),'pagination':{'page':_0x1a320d,'limit':_0x92d310,'total':_0x69e318,'totalPages':Math['ceil'](_0x69e318/_0x92d310)}};}async[a54_0x1df13a(0xdb)](_0x950048,_0x11f280){const _0x2a4219=a54_0x1df13a,_0x4dd0ae=new Date();let _0x7b7079;switch(_0x11f280){case'7d':_0x7b7079=new Date(_0x4dd0ae[_0x2a4219(0x138)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x2a4219(0x16c):_0x7b7079=new Date(_0x4dd0ae[_0x2a4219(0x138)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x7b7079=new Date(_0x4dd0ae[_0x2a4219(0x138)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x7b7079=new Date(_0x4dd0ae['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x26a4df,_0x33b4d1,_0xf5154e,_0x12e0b5,_0xded272]=await Promise[_0x2a4219(0x141)]([database_1[_0x2a4219(0x143)][_0x2a4219(0xf5)][_0x2a4219(0x13e)]({'where':{'shopId':_0x950048,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x7b7079}}}),database_1['default'][_0x2a4219(0xf5)]['count']({'where':{'shopId':_0x950048,'gateway':{'not':'test_gateway'},'status':_0x2a4219(0xe0),'createdAt':{'gte':_0x7b7079}}}),database_1[_0x2a4219(0x143)][_0x2a4219(0xf5)][_0x2a4219(0xdf)]({'where':{'shopId':_0x950048,'gateway':{'not':_0x2a4219(0xd3)},'status':'PAID','createdAt':{'gte':_0x7b7079}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default'][_0x2a4219(0xf5)][_0x2a4219(0xdf)]({'where':{'shopId':_0x950048,'gateway':{'not':_0x2a4219(0xd3)}},'take':0xa,'orderBy':{'createdAt':_0x2a4219(0x10f)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default']['payment'][_0x2a4219(0xdf)]({'where':{'shopId':_0x950048,'gateway':{'not':_0x2a4219(0xd3)},'createdAt':{'gte':_0x7b7079}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x22aa8a=0x0;for(const _0x4d2203 of _0xf5154e){if(_0x4d2203[_0x2a4219(0x15f)])_0x22aa8a+=_0x4d2203[_0x2a4219(0x15f)];else{const _0x126004=await currencyService_1[_0x2a4219(0xcb)][_0x2a4219(0x168)](_0x4d2203[_0x2a4219(0xef)],_0x4d2203['currency']);_0x22aa8a+=_0x126004;}}const _0x25ee85=this[_0x2a4219(0xd4)](_0xded272,_0x7b7079,_0x4dd0ae),_0x4cd4d2=_0x26a4df>0x0?_0x33b4d1/_0x26a4df*0x64:0x0;return{'totalPayments':_0x26a4df,'successfulPayments':_0x33b4d1,'totalRevenue':Math['round'](_0x22aa8a*0x64)/0x64,'conversionRate':Math[_0x2a4219(0x144)](_0x4cd4d2*0x64)/0x64,'dailyRevenue':_0x25ee85[_0x2a4219(0x12c)],'dailyPayments':_0x25ee85[_0x2a4219(0x149)],'recentPayments':_0x12e0b5[_0x2a4219(0xda)](_0x1388fa=>({'id':_0x1388fa['id'],'gateway':_0x1388fa[_0x2a4219(0x126)],'amount':_0x1388fa[_0x2a4219(0xef)],'currency':_0x1388fa[_0x2a4219(0x12f)],'status':_0x1388fa[_0x2a4219(0x15d)],'createdAt':_0x1388fa[_0x2a4219(0x153)]}))};}[a54_0x1df13a(0xd4)](_0x3d424f,_0x244f01,_0x5529cd){const _0x31e562=a54_0x1df13a,_0x3fd042=new Map(),_0x4839e8=new Date(_0x244f01);while(_0x4839e8<=_0x5529cd){const _0xe2fe92=_0x4839e8['toISOString']()['split']('T')[0x0];_0x3fd042[_0x31e562(0x13c)](_0xe2fe92,{'revenue':0x0,'count':0x0}),_0x4839e8[_0x31e562(0xde)](_0x4839e8[_0x31e562(0x14f)]()+0x1);}for(const _0x3cbfe4 of _0x3d424f){const _0x5d7610=_0x3cbfe4['createdAt'][_0x31e562(0xea)]()[_0x31e562(0x136)]('T')[0x0],_0x202e89=_0x3fd042['get'](_0x5d7610);_0x202e89&&(_0x202e89[_0x31e562(0x13e)]+=0x1,_0x3cbfe4[_0x31e562(0x15d)]===_0x31e562(0xe0)&&_0x3cbfe4['amountUSDT']&&(_0x202e89[_0x31e562(0x105)]+=_0x3cbfe4['amountUSDT']));}const _0x5f2516=[],_0x15b5f9=[];for(const [_0x116e7f,_0x319d91]of _0x3fd042){_0x5f2516[_0x31e562(0x111)]({'date':_0x116e7f,'amount':Math['round'](_0x319d91['revenue']*0x64)/0x64}),_0x15b5f9[_0x31e562(0x111)]({'date':_0x116e7f,'count':_0x319d91[_0x31e562(0x13e)]});}return{'dailyRevenue':_0x5f2516,'dailyPayments':_0x15b5f9};}}exports['ShopService']=ShopService;