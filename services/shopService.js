'use strict';const a54_0x3846af=a54_0x2310;(function(_0x1e143d,_0x144afe){const _0x23c5ad=a54_0x2310,_0x36b9a4=_0x1e143d();while(!![]){try{const _0x2a4894=-parseInt(_0x23c5ad(0x117))/0x1+-parseInt(_0x23c5ad(0x11e))/0x2*(parseInt(_0x23c5ad(0x156))/0x3)+-parseInt(_0x23c5ad(0xcf))/0x4+-parseInt(_0x23c5ad(0x118))/0x5*(parseInt(_0x23c5ad(0xe4))/0x6)+-parseInt(_0x23c5ad(0xf3))/0x7+parseInt(_0x23c5ad(0x131))/0x8*(-parseInt(_0x23c5ad(0x11d))/0x9)+-parseInt(_0x23c5ad(0x14a))/0xa*(-parseInt(_0x23c5ad(0xb7))/0xb);if(_0x2a4894===_0x144afe)break;else _0x36b9a4['push'](_0x36b9a4['shift']());}catch(_0x32025a){_0x36b9a4['push'](_0x36b9a4['shift']());}}}(a54_0x545d,0xbe1ed));function a54_0x2310(_0x2e28d1,_0x3caeb3){const _0x545d0f=a54_0x545d();return a54_0x2310=function(_0x231041,_0x3c161e){_0x231041=_0x231041-0xb2;let _0x5da91f=_0x545d0f[_0x231041];return _0x5da91f;},a54_0x2310(_0x2e28d1,_0x3caeb3);}var __importDefault=this&&this[a54_0x3846af(0x157)]||function(_0x3a4d0a){const _0x1b7676=a54_0x3846af;return _0x3a4d0a&&_0x3a4d0a[_0x1b7676(0xd8)]?_0x3a4d0a:{'default':_0x3a4d0a};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a54_0x3846af(0x13a)]=void 0x0;const database_1=__importDefault(require(a54_0x3846af(0xde))),currencyService_1=require(a54_0x3846af(0xf7)),paymentService_1=require(a54_0x3846af(0xd1));class ShopService{constructor(){this['paymentService']=new paymentService_1['PaymentService']();}async[a54_0x3846af(0xd3)](_0x1a51b0){const _0x176dff=a54_0x3846af,_0x510f44=await database_1[_0x176dff(0xc1)]['shop'][_0x176dff(0xec)]({'where':{'id':_0x1a51b0},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x510f44)throw new Error(_0x176dff(0x11b));let _0x5a9a02=[];if(_0x510f44['settings']?.[_0x176dff(0x123)])try{_0x5a9a02=Array[_0x176dff(0xe2)](_0x510f44['settings'][_0x176dff(0x123)])?_0x510f44[_0x176dff(0x112)][_0x176dff(0x123)]:JSON[_0x176dff(0xb3)](_0x510f44[_0x176dff(0x112)][_0x176dff(0x123)]);}catch(_0x2d11a2){console[_0x176dff(0x141)]('Error\x20parsing\x20webhook\x20events:',_0x2d11a2),_0x5a9a02=[];}return{'id':_0x510f44['id'],'fullName':_0x510f44[_0x176dff(0xf8)],'username':_0x510f44[_0x176dff(0x128)],'telegramId':_0x510f44[_0x176dff(0x151)],'merchantUrl':_0x510f44[_0x176dff(0x104)],'gateways':_0x510f44['paymentGateways']?JSON[_0x176dff(0xb3)](_0x510f44['paymentGateways']):null,'gatewaySettings':_0x510f44['gatewaySettings']?JSON[_0x176dff(0xb3)](_0x510f44[_0x176dff(0xca)]):null,'publicKey':_0x510f44[_0x176dff(0xd6)],'webhookUrl':_0x510f44['settings']?.[_0x176dff(0x144)]||null,'webhookEvents':_0x5a9a02,'wallets':{'usdtPolygonWallet':_0x510f44['usdtPolygonWallet'],'usdtTrcWallet':_0x510f44[_0x176dff(0xfc)],'usdtErcWallet':_0x510f44['usdtErcWallet'],'usdcPolygonWallet':_0x510f44['usdcPolygonWallet']},'status':_0x510f44[_0x176dff(0x109)],'createdAt':_0x510f44['createdAt']};}async[a54_0x3846af(0xdb)](_0x12fe98,_0xb8f0fe){const _0xdd8afa=a54_0x3846af,_0x3120f9={};_0xb8f0fe[_0xdd8afa(0x13d)]&&(_0x3120f9['name']=_0xb8f0fe[_0xdd8afa(0x13d)]);_0xb8f0fe[_0xdd8afa(0xed)]!==undefined&&(_0x3120f9['telegram']=_0xb8f0fe['telegramId']||null);_0xb8f0fe[_0xdd8afa(0xc8)]&&(_0x3120f9[_0xdd8afa(0x104)]=_0xb8f0fe[_0xdd8afa(0xc8)]);_0xb8f0fe[_0xdd8afa(0xcb)]&&(_0x3120f9['paymentGateways']=JSON['stringify'](_0xb8f0fe[_0xdd8afa(0xcb)]));_0xb8f0fe[_0xdd8afa(0xca)]&&(_0x3120f9[_0xdd8afa(0xca)]=JSON[_0xdd8afa(0xbb)](_0xb8f0fe[_0xdd8afa(0xca)]));_0xb8f0fe[_0xdd8afa(0xc5)]&&(_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0x139)]!==undefined&&(_0x3120f9[_0xdd8afa(0x139)]=_0xb8f0fe[_0xdd8afa(0xc5)]['usdtPolygonWallet']||null),_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0xfc)]!==undefined&&(_0x3120f9[_0xdd8afa(0xfc)]=_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0xfc)]||null),_0xb8f0fe['wallets']['usdtErcWallet']!==undefined&&(_0x3120f9[_0xdd8afa(0x105)]=_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0x105)]||null),_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0x142)]!==undefined&&(_0x3120f9[_0xdd8afa(0x142)]=_0xb8f0fe[_0xdd8afa(0xc5)][_0xdd8afa(0x142)]||null));const _0x2c434d=await database_1[_0xdd8afa(0xc1)][_0xdd8afa(0x137)][_0xdd8afa(0x111)]({'where':{'id':_0x12fe98},'data':_0x3120f9,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x4b6ad2=[];if(_0x2c434d[_0xdd8afa(0x112)]?.[_0xdd8afa(0x123)])try{_0x4b6ad2=Array[_0xdd8afa(0xe2)](_0x2c434d[_0xdd8afa(0x112)]['webhookEvents'])?_0x2c434d[_0xdd8afa(0x112)][_0xdd8afa(0x123)]:JSON[_0xdd8afa(0xb3)](_0x2c434d[_0xdd8afa(0x112)]['webhookEvents']);}catch(_0x2b3028){console['error']('Error\x20parsing\x20webhook\x20events:',_0x2b3028),_0x4b6ad2=[];}return{'id':_0x2c434d['id'],'fullName':_0x2c434d[_0xdd8afa(0xf8)],'username':_0x2c434d[_0xdd8afa(0x128)],'telegramId':_0x2c434d[_0xdd8afa(0x151)],'merchantUrl':_0x2c434d[_0xdd8afa(0x104)],'gateways':_0x2c434d[_0xdd8afa(0x12c)]?JSON[_0xdd8afa(0xb3)](_0x2c434d[_0xdd8afa(0x12c)]):null,'gatewaySettings':_0x2c434d[_0xdd8afa(0xca)]?JSON[_0xdd8afa(0xb3)](_0x2c434d[_0xdd8afa(0xca)]):null,'publicKey':_0x2c434d['publicKey'],'webhookUrl':_0x2c434d[_0xdd8afa(0x112)]?.[_0xdd8afa(0x144)]||null,'webhookEvents':_0x4b6ad2,'wallets':{'usdtPolygonWallet':_0x2c434d[_0xdd8afa(0x139)],'usdtTrcWallet':_0x2c434d[_0xdd8afa(0xfc)],'usdtErcWallet':_0x2c434d[_0xdd8afa(0x105)],'usdcPolygonWallet':_0x2c434d[_0xdd8afa(0x142)]},'status':_0x2c434d[_0xdd8afa(0x109)],'createdAt':_0x2c434d[_0xdd8afa(0x10c)]};}async[a54_0x3846af(0xc4)](_0x28ac72,_0x4048cd){const _0x39b142=a54_0x3846af,_0x134beb={};_0x4048cd['usdtPolygonWallet']!==undefined&&(_0x134beb[_0x39b142(0x139)]=_0x4048cd[_0x39b142(0x139)]||null),_0x4048cd[_0x39b142(0xfc)]!==undefined&&(_0x134beb[_0x39b142(0xfc)]=_0x4048cd['usdtTrcWallet']||null),_0x4048cd[_0x39b142(0x105)]!==undefined&&(_0x134beb['usdtErcWallet']=_0x4048cd[_0x39b142(0x105)]||null),_0x4048cd['usdcPolygonWallet']!==undefined&&(_0x134beb[_0x39b142(0x142)]=_0x4048cd[_0x39b142(0x142)]||null),await database_1[_0x39b142(0xc1)][_0x39b142(0x137)][_0x39b142(0x111)]({'where':{'id':_0x28ac72},'data':_0x134beb});}async['testWebhook'](_0x516ec3){const _0x3aefd8=a54_0x3846af,_0x4698e7=await database_1[_0x3aefd8(0xc1)][_0x3aefd8(0x137)][_0x3aefd8(0xec)]({'where':{'id':_0x516ec3},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x4698e7?.['settings']?.[_0x3aefd8(0x144)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x507d88={'event':_0x3aefd8(0x13f),'payment':{'id':'test_payment_123','order_id':'test_order_123','gateway':_0x3aefd8(0x13f),'amount':0x64,'currency':'USD','status':_0x3aefd8(0x114),'created_at':new Date()[_0x3aefd8(0x12e)]()}};try{const _0x4c9bf6=await fetch(_0x4698e7['settings'][_0x3aefd8(0x144)],{'method':_0x3aefd8(0xb8),'headers':{'Content-Type':_0x3aefd8(0x148),'User-Agent':_0x3aefd8(0xb5)},'body':JSON[_0x3aefd8(0xbb)](_0x507d88)});return _0x4c9bf6['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x4c9bf6['status']+')'}:{'success':![],'message':_0x3aefd8(0xd2)+_0x4c9bf6[_0x3aefd8(0x109)]+'\x20'+_0x4c9bf6[_0x3aefd8(0xf1)]};}catch(_0x4d968d){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x4d968d instanceof Error?_0x4d968d['message']:_0x3aefd8(0xe3))};}}async[a54_0x3846af(0x122)](_0x449867){const _0x4e449a=a54_0x3846af;return this[_0x4e449a(0xea)][_0x4e449a(0xf9)]({'public_key':'','gateway':_0x449867['gateway'],'order_id':undefined,'amount':_0x449867[_0x4e449a(0xd9)],'currency':_0x449867[_0x4e449a(0x10a)],'source_currency':_0x449867['sourceCurrency'],'usage':_0x449867['usage'],'expires_at':_0x449867[_0x4e449a(0xd0)]?.[_0x4e449a(0x12e)](),'success_url':_0x449867[_0x4e449a(0x12b)],'fail_url':_0x449867[_0x4e449a(0x12b)],'customer_email':_0x449867['customerEmail'],'customer_name':_0x449867[_0x4e449a(0xe7)],'country':_0x449867[_0x4e449a(0x13b)],'language':_0x449867['language'],'amount_is_editable':_0x449867['amountIsEditable'],'max_payments':_0x449867[_0x4e449a(0x106)],'customer':_0x449867[_0x4e449a(0xe0)]});}async['getPayments'](_0x7059af,_0x4bf216){const _0x135b52=a54_0x3846af;return this[_0x135b52(0xea)][_0x135b52(0x153)](_0x7059af,_0x4bf216);}async['getPaymentById'](_0x595cbf,_0x2d6043){return this['paymentService']['getPaymentByShopAndId'](_0x595cbf,_0x2d6043);}async[a54_0x3846af(0x10e)](_0x3fe48f,_0x4e7de4,_0x5b011c){const _0x21d4be=a54_0x3846af,_0x80c31e=await database_1[_0x21d4be(0xc1)][_0x21d4be(0x13e)][_0x21d4be(0x14b)]({'where':{'id':_0x4e7de4,'shopId':_0x3fe48f}});if(!_0x80c31e)throw new Error(_0x21d4be(0xdf));const _0xb6b81=await database_1[_0x21d4be(0xc1)]['payment'][_0x21d4be(0x111)]({'where':{'id':_0x4e7de4},'data':{..._0x5b011c,'updatedAt':new Date()}});return _0xb6b81;}async[a54_0x3846af(0xbd)](_0x183c18,_0x47379f){const _0x39a406=a54_0x3846af,_0x3280f9=await database_1['default'][_0x39a406(0x13e)][_0x39a406(0x14b)]({'where':{'id':_0x47379f,'shopId':_0x183c18}});if(!_0x3280f9)throw new Error(_0x39a406(0xdf));await database_1[_0x39a406(0xc1)]['payment'][_0x39a406(0x14e)]({'where':{'id':_0x47379f}});}[a54_0x3846af(0xb2)](_0x572330){const _0x3b5ec0=a54_0x3846af,_0x270a1b={'polygon':_0x3b5ec0(0xfa),'trc20':'USDT\x20TRC20','erc20':'USDT\x20ERC20','bsc':_0x3b5ec0(0xdc),'polygon_usdc':_0x3b5ec0(0xc7)};return _0x270a1b[_0x572330]||_0x572330;}async[a54_0x3846af(0xbe)](_0x3f3da0,_0x2b8bd6){const _0x3d74f2=a54_0x3846af,{page:_0xefe6f6,limit:_0xf3b8ed,status:_0x59c6f5,method:_0x52d132,network:_0x505514,dateFrom:_0x5bf016,dateTo:_0x416d69,periodFrom:_0x1c77cc,periodTo:_0x428302}=_0x2b8bd6,_0x362e10=(_0xefe6f6-0x1)*_0xf3b8ed;console['log']('💰\x20Getting\x20payouts\x20with\x20filters:',_0x2b8bd6);const _0x393c37={'shopId':_0x3f3da0};_0x59c6f5&&(_0x393c37[_0x3d74f2(0x109)]=_0x59c6f5[_0x3d74f2(0x100)](),console[_0x3d74f2(0x108)](_0x3d74f2(0x14c)+_0x59c6f5[_0x3d74f2(0x100)]()));if(_0x52d132)_0x393c37[_0x3d74f2(0xbc)]=_0x52d132,console[_0x3d74f2(0x108)](_0x3d74f2(0xeb)+_0x52d132);else _0x505514&&(_0x393c37[_0x3d74f2(0xbc)]=_0x505514,console['log'](_0x3d74f2(0xc0)+_0x505514));if(_0x5bf016||_0x416d69||_0x1c77cc||_0x428302){_0x393c37[_0x3d74f2(0x10c)]={};if(_0x1c77cc){const _0x30dad7=new Date(_0x1c77cc);_0x30dad7[_0x3d74f2(0x11f)](0x0,0x0,0x0,0x0),_0x393c37['createdAt'][_0x3d74f2(0x10f)]=_0x30dad7,console[_0x3d74f2(0x108)]('📅\x20Period\x20start:\x20'+_0x30dad7[_0x3d74f2(0x12e)]());}else{if(_0x5bf016){const _0x4b4209=new Date(_0x5bf016);_0x4b4209[_0x3d74f2(0x11f)](0x0,0x0,0x0,0x0),_0x393c37[_0x3d74f2(0x10c)][_0x3d74f2(0x10f)]=_0x4b4209,console['log'](_0x3d74f2(0x145)+_0x4b4209['toISOString']());}}if(_0x428302){const _0x641407=new Date(_0x428302);_0x641407[_0x3d74f2(0x11f)](0x17,0x3b,0x3b,0x3e7),_0x393c37['createdAt']['lte']=_0x641407,console[_0x3d74f2(0x108)](_0x3d74f2(0xb4)+_0x641407[_0x3d74f2(0x12e)]());}else{if(_0x416d69){const _0xed51a3=new Date(_0x416d69);_0xed51a3[_0x3d74f2(0x11f)](0x17,0x3b,0x3b,0x3e7),_0x393c37[_0x3d74f2(0x10c)][_0x3d74f2(0xc3)]=_0xed51a3,console[_0x3d74f2(0x108)]('📅\x20Date\x20end:\x20'+_0xed51a3[_0x3d74f2(0x12e)]());}}}console['log'](_0x3d74f2(0x155),JSON['stringify'](_0x393c37,null,0x2));const [_0x2d6acd,_0xc3b172]=await Promise[_0x3d74f2(0x107)]([database_1[_0x3d74f2(0xc1)]['payout'][_0x3d74f2(0x115)]({'where':_0x393c37,'skip':_0x362e10,'take':_0xf3b8ed,'orderBy':{'createdAt':_0x3d74f2(0x12d)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x3d74f2(0xc1)][_0x3d74f2(0x149)][_0x3d74f2(0xb6)]({'where':_0x393c37})]);return{'payouts':_0x2d6acd[_0x3d74f2(0xe9)](_0x3eb194=>{const _0x31a8df=_0x3d74f2;let _0x537ecd=null;switch(_0x3eb194[_0x31a8df(0xbc)]){case _0x31a8df(0xbf):_0x537ecd=_0x3eb194[_0x31a8df(0x137)][_0x31a8df(0x139)];break;case _0x31a8df(0xef):_0x537ecd=_0x3eb194[_0x31a8df(0x137)][_0x31a8df(0xfc)];break;case _0x31a8df(0xcc):_0x537ecd=_0x3eb194[_0x31a8df(0x137)][_0x31a8df(0x105)];break;case _0x31a8df(0x132):_0x537ecd=_0x3eb194['shop'][_0x31a8df(0x142)];break;}return{'id':_0x3eb194['id'],'amount':_0x3eb194[_0x31a8df(0xd9)],'network':this[_0x31a8df(0xb2)](_0x3eb194[_0x31a8df(0xbc)]),'wallet':_0x537ecd,'status':_0x3eb194[_0x31a8df(0x109)],'txid':_0x3eb194[_0x31a8df(0x10b)],'notes':_0x3eb194[_0x31a8df(0xda)],'periodFrom':_0x3eb194['periodFrom'],'periodTo':_0x3eb194[_0x31a8df(0xcd)],'createdAt':_0x3eb194[_0x31a8df(0x10c)],'paidAt':_0x3eb194[_0x31a8df(0xdd)]};}),'pagination':{'page':_0xefe6f6,'limit':_0xf3b8ed,'total':_0xc3b172,'totalPages':Math[_0x3d74f2(0x129)](_0xc3b172/_0xf3b8ed)}};}async[a54_0x3846af(0x12f)](_0x30bb47,_0x55f237){const _0x5cb1c0=a54_0x3846af,_0x29a387=await database_1[_0x5cb1c0(0xc1)][_0x5cb1c0(0x149)][_0x5cb1c0(0x14b)]({'where':{'id':_0x55f237,'shopId':_0x30bb47}});if(!_0x29a387)return null;return{'id':_0x29a387['id'],'amount':_0x29a387[_0x5cb1c0(0xd9)],'network':_0x29a387[_0x5cb1c0(0xbc)],'status':_0x29a387['status'],'txid':_0x29a387[_0x5cb1c0(0x10b)],'notes':_0x29a387[_0x5cb1c0(0xda)],'createdAt':_0x29a387[_0x5cb1c0(0x10c)],'paidAt':_0x29a387['paidAt']};}async[a54_0x3846af(0xd7)](_0x3b1b86,_0x3a144e){const _0x34a43b=a54_0x3846af,_0x1552a9=new Date();let _0x51b0d5;switch(_0x3a144e){case'7d':_0x51b0d5=new Date(_0x1552a9[_0x34a43b(0xf0)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x51b0d5=new Date(_0x1552a9['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x51b0d5=new Date(_0x1552a9['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x51b0d5=new Date(_0x1552a9['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x297ecf,_0x37025e,_0x31e9f0,_0x4fa3bf,_0x15b821,_0x19c426]=await Promise[_0x34a43b(0x107)]([database_1[_0x34a43b(0xc1)][_0x34a43b(0x149)][_0x34a43b(0xb6)]({'where':{'shopId':_0x3b1b86,'createdAt':{'gte':_0x51b0d5}}}),database_1[_0x34a43b(0xc1)][_0x34a43b(0x149)][_0x34a43b(0xb6)]({'where':{'shopId':_0x3b1b86,'status':'COMPLETED','createdAt':{'gte':_0x51b0d5}}}),database_1['default']['payout'][_0x34a43b(0xb6)]({'where':{'shopId':_0x3b1b86,'status':_0x34a43b(0xba),'createdAt':{'gte':_0x51b0d5}}}),database_1[_0x34a43b(0xc1)]['payout'][_0x34a43b(0xb6)]({'where':{'shopId':_0x3b1b86,'status':'REJECTED','createdAt':{'gte':_0x51b0d5}}}),database_1[_0x34a43b(0xc1)][_0x34a43b(0x149)][_0x34a43b(0x115)]({'where':{'shopId':_0x3b1b86,'createdAt':{'gte':_0x51b0d5}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x34a43b(0xc1)][_0x34a43b(0x149)][_0x34a43b(0x115)]({'where':{'shopId':_0x3b1b86},'take':0xa,'orderBy':{'createdAt':_0x34a43b(0x12d)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x515032=_0x15b821['reduce']((_0x1df529,_0x306aef)=>_0x1df529+_0x306aef[_0x34a43b(0xd9)],0x0),_0x34a22c=_0x15b821[_0x34a43b(0x135)](_0xdfb8b0=>_0xdfb8b0[_0x34a43b(0x109)]==='COMPLETED')[_0x34a43b(0x101)]((_0x3466a5,_0x5f5407)=>_0x3466a5+_0x5f5407[_0x34a43b(0xd9)],0x0),_0x11b443=_0x15b821[_0x34a43b(0x135)](_0x45f294=>_0x45f294[_0x34a43b(0x109)]===_0x34a43b(0xba))[_0x34a43b(0x101)]((_0x22d748,_0x2df53b)=>_0x22d748+_0x2df53b['amount'],0x0),_0x15227a=_0x15b821[_0x34a43b(0x101)]((_0x3085bd,_0x1caa23)=>{const _0x26eeee=_0x34a43b;return _0x3085bd[_0x1caa23[_0x26eeee(0xbc)]]=(_0x3085bd[_0x1caa23['network']]||0x0)+0x1,_0x3085bd;},{}),_0x947d27=_0x15b821[_0x34a43b(0x101)]((_0x43d6d4,_0x5ec4b0)=>{const _0x125e74=_0x34a43b;return _0x43d6d4[_0x5ec4b0[_0x125e74(0x109)]]=(_0x43d6d4[_0x5ec4b0['status']]||0x0)+0x1,_0x43d6d4;},{});return{'totalPayouts':_0x297ecf,'completedPayouts':_0x37025e,'pendingPayouts':_0x31e9f0,'rejectedPayouts':_0x4fa3bf,'totalAmount':_0x515032,'completedAmount':_0x34a22c,'pendingAmount':_0x11b443,'payoutsByMethod':_0x15227a,'payoutsByStatus':_0x947d27,'recentPayouts':_0x19c426[_0x34a43b(0xe9)](_0x34c27d=>({'id':_0x34c27d['id'],'shopId':_0x3b1b86,'amount':_0x34c27d[_0x34a43b(0xd9)],'method':_0x34c27d[_0x34a43b(0xbc)],'status':_0x34c27d[_0x34a43b(0x109)],'txid':_0x34c27d[_0x34a43b(0x10b)],'createdAt':_0x34c27d[_0x34a43b(0x10c)],'paidAt':_0x34c27d['paidAt']}))};}async[a54_0x3846af(0x124)](_0x32e06b){const _0x1e9655=a54_0x3846af;console[_0x1e9655(0x108)](_0x1e9655(0x12a)+_0x32e06b+'...');const _0x211517=await database_1[_0x1e9655(0xc1)][_0x1e9655(0x137)]['findUnique']({'where':{'id':_0x32e06b},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x211517)throw new Error('Shop\x20not\x20found');const _0x2a40fd=new Date(),_0x3ea041=new Date(_0x2a40fd[_0x1e9655(0x154)](),_0x2a40fd[_0x1e9655(0x126)](),0x1),_0x13cae8=new Date(_0x2a40fd[_0x1e9655(0x154)](),_0x2a40fd[_0x1e9655(0x126)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x310ca7=await database_1[_0x1e9655(0xc1)][_0x1e9655(0x149)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x32e06b,'createdAt':{'gte':_0x3ea041,'lte':_0x13cae8},'status':_0x1e9655(0x121)}}),_0x2ce40b=_0x310ca7[_0x1e9655(0x150)]['amount']||0x0,_0xa18a24={'availableBalance':Math[_0x1e9655(0x127)](_0x211517[_0x1e9655(0x102)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x211517[_0x1e9655(0xce)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x211517[_0x1e9655(0x102)]*0x64)/0x64,'thisMonth':Math[_0x1e9655(0x127)](_0x2ce40b*0x64)/0x64};return console['log'](_0x1e9655(0xd4)+_0x211517[_0x1e9655(0x128)]+'\x20payout\x20statistics\x20calculated:'),console['log'](_0x1e9655(0xfd)+_0xa18a24[_0x1e9655(0x140)]+'\x20USDT\x20(current\x20balance)'),console['log'](_0x1e9655(0xe1)+_0xa18a24['totalPaidOut']+_0x1e9655(0x146)),console[_0x1e9655(0x108)](_0x1e9655(0x143)+_0xa18a24[_0x1e9655(0x14d)]+'\x20USDT\x20(current\x20balance)'),console[_0x1e9655(0x108)](_0x1e9655(0xf2)+_0xa18a24[_0x1e9655(0xb9)]+_0x1e9655(0x138)),_0xa18a24;}[a54_0x3846af(0xfe)](_0x47e4bc){const _0x155853=a54_0x3846af,_0x508d82={'test_gateway':_0x155853(0xe6),'plisio':_0x155853(0xf4),'rapyd':'Rapyd','noda':_0x155853(0x116),'cointopay':'CoinToPay','klyme_eu':_0x155853(0x113),'klyme_gb':_0x155853(0xc2),'klyme_de':_0x155853(0xc9)};return _0x508d82[_0x47e4bc]||_0x47e4bc;}async[a54_0x3846af(0x110)](_0x353358){const _0x44d70f=a54_0x3846af;return this[_0x44d70f(0x124)](_0x353358);}async[a54_0x3846af(0xfb)](_0x452773,_0x5196cb){const _0x545e20=a54_0x3846af,{page:_0x5a6378,limit:_0x35c4a9,paymentId:_0x201c61}=_0x5196cb,_0xe5211=(_0x5a6378-0x1)*_0x35c4a9,_0x3f52d0={'shopId':_0x452773};_0x201c61&&(_0x3f52d0[_0x545e20(0x119)]=_0x201c61);const [_0x1a19d5,_0x4fd16e]=await Promise[_0x545e20(0x107)]([database_1[_0x545e20(0xc1)][_0x545e20(0x13c)][_0x545e20(0x115)]({'where':_0x3f52d0,'skip':_0xe5211,'take':_0x35c4a9,'orderBy':{'createdAt':_0x545e20(0x12d)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x545e20(0xc1)]['webhookLog'][_0x545e20(0xb6)]({'where':_0x3f52d0})]);return{'logs':_0x1a19d5[_0x545e20(0xe9)](_0x5ecb39=>({'id':_0x5ecb39['id'],'paymentId':_0x5ecb39[_0x545e20(0x119)],'shopId':_0x5ecb39['shopId'],'event':_0x5ecb39[_0x545e20(0x133)],'statusCode':_0x5ecb39['statusCode'],'retryCount':_0x5ecb39[_0x545e20(0xf5)],'responseBody':_0x5ecb39[_0x545e20(0xc6)],'createdAt':_0x5ecb39[_0x545e20(0x10c)],'payment':_0x5ecb39[_0x545e20(0x13e)]})),'pagination':{'page':_0x5a6378,'limit':_0x35c4a9,'total':_0x4fd16e,'totalPages':Math[_0x545e20(0x129)](_0x4fd16e/_0x35c4a9)}};}async[a54_0x3846af(0x10d)](_0x5e65bf,_0x30b41f){const _0x4ec3d2=a54_0x3846af,_0x26a127=new Date();let _0x459532;switch(_0x30b41f){case'7d':_0x459532=new Date(_0x26a127[_0x4ec3d2(0xf0)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x4ec3d2(0x152):_0x459532=new Date(_0x26a127['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x4ec3d2(0x11a):_0x459532=new Date(_0x26a127[_0x4ec3d2(0xf0)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x459532=new Date(_0x26a127[_0x4ec3d2(0xf0)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x58e2ee,_0x315eab,_0x4e1253,_0x2ba9e3,_0x67faac]=await Promise[_0x4ec3d2(0x107)]([database_1['default'][_0x4ec3d2(0x13e)][_0x4ec3d2(0xb6)]({'where':{'shopId':_0x5e65bf,'gateway':{'not':_0x4ec3d2(0x130)},'createdAt':{'gte':_0x459532}}}),database_1['default'][_0x4ec3d2(0x13e)][_0x4ec3d2(0xb6)]({'where':{'shopId':_0x5e65bf,'gateway':{'not':_0x4ec3d2(0x130)},'status':_0x4ec3d2(0xf6),'createdAt':{'gte':_0x459532}}}),database_1[_0x4ec3d2(0xc1)][_0x4ec3d2(0x13e)][_0x4ec3d2(0x115)]({'where':{'shopId':_0x5e65bf,'gateway':{'not':_0x4ec3d2(0x130)},'status':_0x4ec3d2(0xf6),'createdAt':{'gte':_0x459532}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x4ec3d2(0xc1)][_0x4ec3d2(0x13e)][_0x4ec3d2(0x115)]({'where':{'shopId':_0x5e65bf,'gateway':{'not':_0x4ec3d2(0x130)}},'take':0xa,'orderBy':{'createdAt':_0x4ec3d2(0x12d)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x4ec3d2(0xc1)][_0x4ec3d2(0x13e)]['findMany']({'where':{'shopId':_0x5e65bf,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x459532}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x4ec3d2(0x11c)}})]);let _0x4f626c=0x0;for(const _0x2ef9ca of _0x4e1253){if(_0x2ef9ca[_0x4ec3d2(0xd5)])_0x4f626c+=_0x2ef9ca[_0x4ec3d2(0xd5)];else{const _0x5b6143=await currencyService_1['currencyService'][_0x4ec3d2(0x147)](_0x2ef9ca[_0x4ec3d2(0xd9)],_0x2ef9ca['currency']);_0x4f626c+=_0x5b6143;}}const _0x5f4191=this[_0x4ec3d2(0xee)](_0x67faac,_0x459532,_0x26a127),_0x350771=_0x58e2ee>0x0?_0x315eab/_0x58e2ee*0x64:0x0;return{'totalPayments':_0x58e2ee,'successfulPayments':_0x315eab,'totalRevenue':Math['round'](_0x4f626c*0x64)/0x64,'conversionRate':Math[_0x4ec3d2(0x127)](_0x350771*0x64)/0x64,'dailyRevenue':_0x5f4191[_0x4ec3d2(0xff)],'dailyPayments':_0x5f4191[_0x4ec3d2(0x14f)],'recentPayments':_0x2ba9e3['map'](_0x11f54b=>({'id':_0x11f54b['id'],'gateway':_0x11f54b[_0x4ec3d2(0x125)],'amount':_0x11f54b[_0x4ec3d2(0xd9)],'currency':_0x11f54b[_0x4ec3d2(0x10a)],'status':_0x11f54b[_0x4ec3d2(0x109)],'createdAt':_0x11f54b['createdAt']}))};}['generateDailyStatistics'](_0x5d01f2,_0x1905fe,_0xd6efa4){const _0x1efe39=a54_0x3846af,_0x55f278=new Map(),_0x3f519b=new Date(_0x1905fe);while(_0x3f519b<=_0xd6efa4){const _0x466828=_0x3f519b[_0x1efe39(0x12e)]()[_0x1efe39(0xe8)]('T')[0x0];_0x55f278[_0x1efe39(0x120)](_0x466828,{'revenue':0x0,'count':0x0}),_0x3f519b[_0x1efe39(0x136)](_0x3f519b[_0x1efe39(0x134)]()+0x1);}for(const _0x4d4434 of _0x5d01f2){const _0x141c1a=_0x4d4434[_0x1efe39(0x10c)][_0x1efe39(0x12e)]()['split']('T')[0x0],_0x2104f0=_0x55f278[_0x1efe39(0x103)](_0x141c1a);_0x2104f0&&(_0x2104f0[_0x1efe39(0xb6)]+=0x1,_0x4d4434[_0x1efe39(0x109)]===_0x1efe39(0xf6)&&_0x4d4434[_0x1efe39(0xd5)]&&(_0x2104f0[_0x1efe39(0xe5)]+=_0x4d4434[_0x1efe39(0xd5)]));}const _0xa2688f=[],_0x581281=[];for(const [_0x434ae3,_0x2f4a0a]of _0x55f278){_0xa2688f['push']({'date':_0x434ae3,'amount':Math[_0x1efe39(0x127)](_0x2f4a0a['revenue']*0x64)/0x64}),_0x581281['push']({'date':_0x434ae3,'count':_0x2f4a0a[_0x1efe39(0xb6)]});}return{'dailyRevenue':_0xa2688f,'dailyPayments':_0x581281};}}exports[a54_0x3846af(0x13a)]=ShopService;function a54_0x545d(){const _0x24e0c6=['Shop\x20not\x20found','asc','27iJDSLi','194mMmOhJ','setHours','set','COMPLETED','createPayment','webhookEvents','getShopPayoutStats','gateway','getMonth','round','username','ceil','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','redirectUrl','paymentGateways','desc','toISOString','getPayoutById','test_gateway','1613384CygUZB','polygon_usdc','event','getDate','filter','setDate','shop','\x20USDT','usdtPolygonWallet','ShopService','country','webhookLog','fullName','payment','test','availableBalance','error','usdcPolygonWallet','\x20\x20\x20⏳\x20Awaiting\x20payout:\x20','webhookUrl','📅\x20Date\x20start:\x20','\x20USDT\x20(total\x20payouts)','convertToUSDT','application/json','payout','30IuCnlo','findFirst','📊\x20Status\x20filter:\x20','awaitingPayout','delete','dailyPayments','_sum','telegram','30d','getPaymentsByShop','getFullYear','📊\x20Final\x20WHERE\x20conditions:','11460rEDpTJ','__importDefault','formatNetworkName','parse','📅\x20Period\x20end:\x20','TesSoft\x20Payment\x20System/1.0\x20(Test)','count','19873513ioqBLL','POST','thisMonth','PENDING','stringify','network','deletePayment','getPayouts','polygon','🌐\x20Network\x20filter:\x20','default','KLYME\x20GB','lte','updateWallets','wallets','responseBody','USDC\x20Polygon','merchantUrl','KLYME\x20DE','gatewaySettings','gateways','erc20','periodTo','totalPaidOut','5829168DsWWKT','expiresAt','./paymentService','Webhook\x20returned\x20error:\x20','getShopProfile','📊\x20Shop\x20','amountUSDT','publicKey','getPayoutStatistics','__esModule','amount','notes','updateShopProfile','USDT\x20BSC','paidAt','../config/database','Payment\x20not\x20found','customer','\x20\x20\x20💰\x20Total\x20paid\x20out:\x20','isArray','Unknown\x20error','55140bOsCbI','revenue','Test\x20Gateway','customerName','split','map','paymentService','🌐\x20Method\x20filter:\x20','findUnique','telegramId','generateDailyStatistics','trc20','getTime','statusText','\x20\x20\x20📅\x20This\x20month:\x20','4999638mFbfMN','Plisio','retryCount','PAID','./currencyService','name','createPublicPayment','USDT\x20Polygon','getWebhookLogs','usdtTrcWallet','\x20\x20\x20💵\x20Available\x20balance:\x20','getGatewayDisplayName','dailyRevenue','toUpperCase','reduce','balance','get','shopUrl','usdtErcWallet','maxPayments','all','log','status','currency','txid','createdAt','getStatistics','updatePayment','gte','getPayoutStats','update','settings','KLYME\x20EU','paid','findMany','Noda','602801GHSvcc','485oGsrKd','paymentId','90d'];a54_0x545d=function(){return _0x24e0c6;};return a54_0x545d();}