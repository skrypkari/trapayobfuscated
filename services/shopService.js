'use strict';const a47_0x35d70f=a47_0x23a5;(function(_0x93d23a,_0x21d66c){const _0x470a80=a47_0x23a5,_0xe9f675=_0x93d23a();while(!![]){try{const _0x318e5f=parseInt(_0x470a80(0x176))/0x1*(parseInt(_0x470a80(0x101))/0x2)+parseInt(_0x470a80(0x125))/0x3+parseInt(_0x470a80(0x145))/0x4+-parseInt(_0x470a80(0x197))/0x5+-parseInt(_0x470a80(0x15d))/0x6+-parseInt(_0x470a80(0x1a6))/0x7+-parseInt(_0x470a80(0x1a8))/0x8*(-parseInt(_0x470a80(0x134))/0x9);if(_0x318e5f===_0x21d66c)break;else _0xe9f675['push'](_0xe9f675['shift']());}catch(_0x17900d){_0xe9f675['push'](_0xe9f675['shift']());}}}(a47_0x1e04,0x94080));var __importDefault=this&&this[a47_0x35d70f(0x151)]||function(_0x24cbec){return _0x24cbec&&_0x24cbec['__esModule']?_0x24cbec:{'default':_0x24cbec};};Object[a47_0x35d70f(0x17f)](exports,'__esModule',{'value':!![]}),exports[a47_0x35d70f(0x1a5)]=void 0x0;function a47_0x23a5(_0xcda534,_0x31ee52){const _0x1e0449=a47_0x1e04();return a47_0x23a5=function(_0x23a585,_0xeae005){_0x23a585=_0x23a585-0xe0;let _0x35d454=_0x1e0449[_0x23a585];return _0x35d454;},a47_0x23a5(_0xcda534,_0x31ee52);}const database_1=__importDefault(require(a47_0x35d70f(0x12c))),plisioService_1=require(a47_0x35d70f(0xeb)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require(a47_0x35d70f(0xe6)),coinToPayService_1=require(a47_0x35d70f(0xef)),klymeService_1=require(a47_0x35d70f(0x115)),currencyService_1=require(a47_0x35d70f(0xfe)),gateway_1=require('../types/gateway');class ShopService{constructor(){const _0x571349=a47_0x35d70f;this[_0x571349(0xf8)]=new plisioService_1['PlisioService'](),this[_0x571349(0x1af)]=new rapydService_1[(_0x571349(0x179))](),this[_0x571349(0x11b)]=new nodaService_1['NodaService'](),this[_0x571349(0x120)]=new coinToPayService_1['CoinToPayService'](),this[_0x571349(0x148)]=new klymeService_1[(_0x571349(0xf7))]();}async[a47_0x35d70f(0xf5)](){const _0x41ea4a=a47_0x35d70f;let _0x2644d7,_0x4e4556=0x0;const _0x161c52=0xa;do{const _0x37336c=()=>{const _0x3928e4=a47_0x23a5;return Math[_0x3928e4(0x11a)](Math[_0x3928e4(0x152)]()*0x5f5e100)['toString']()[_0x3928e4(0xe2)](0x8,'0');};_0x2644d7=_0x37336c()+'-'+_0x37336c();const _0xf0835d=await database_1['default'][_0x41ea4a(0x175)][_0x41ea4a(0xf3)]({'where':{'gatewayOrderId':_0x2644d7}});if(!_0xf0835d)break;_0x4e4556++,console[_0x41ea4a(0x149)](_0x41ea4a(0x1b7)+_0x2644d7+_0x41ea4a(0x13b)+_0x4e4556+')');}while(_0x4e4556<_0x161c52);if(_0x4e4556>=_0x161c52)throw new Error(_0x41ea4a(0x117));return _0x2644d7;}['generateGatewayUrls'](_0xf6dbd7,_0x50de65,_0x590bc0,_0x34e460,_0x3a37ff){const _0x3ecbb1=a47_0x35d70f;if(_0x34e460&&_0x3a37ff)return{'finalSuccessUrl':_0x34e460,'finalFailUrl':_0x3a37ff};let _0x5b85cb,_0xf756b7;return _0xf6dbd7==='noda'||_0xf6dbd7[_0x3ecbb1(0x127)](_0x3ecbb1(0x126))?_0x5b85cb=_0x34e460||_0x590bc0+'/payment/pending?payment_id='+_0x50de65:_0x5b85cb=_0x34e460||_0x590bc0+_0x3ecbb1(0xf6)+_0x50de65,_0xf756b7=_0x3a37ff||_0x590bc0+_0x3ecbb1(0x122)+_0x50de65,console[_0x3ecbb1(0x149)](_0x3ecbb1(0xe0)+_0xf6dbd7+':'),console[_0x3ecbb1(0x149)](_0x3ecbb1(0x173)+_0x5b85cb),console[_0x3ecbb1(0x149)](_0x3ecbb1(0x12d)+_0xf756b7),{'finalSuccessUrl':_0x5b85cb,'finalFailUrl':_0xf756b7};}[a47_0x35d70f(0x114)](_0x31fb0b,_0x25e594){const _0xe321a1=a47_0x35d70f,_0xcd5eea=_0x31fb0b['gatewaySettings']?JSON[_0xe321a1(0x1bd)](_0x31fb0b[_0xe321a1(0x1ba)]):null,_0x33d5eb=_0x25e594[_0xe321a1(0x14a)](0x0)['toUpperCase']()+_0x25e594['slice'](0x1)[_0xe321a1(0x132)]();if(_0xcd5eea&&_0xcd5eea[_0x33d5eb])return{'commission':_0xcd5eea[_0x33d5eb][_0xe321a1(0x138)],'payoutDelay':_0xcd5eea[_0x33d5eb][_0xe321a1(0x11e)]};return{'commission':0x0,'payoutDelay':0x0};}[a47_0x35d70f(0x188)](_0x4c4635,_0x117d7d){const _0x1c6964=a47_0x35d70f;if(_0x4c4635[_0x1c6964(0xf4)]!=='PAID'||_0x4c4635[_0x1c6964(0x10c)]||!_0x4c4635[_0x1c6964(0x171)])return![];const _0x35d009=_0x117d7d[_0x1c6964(0x11e)]*0x18*0x3c*0x3c*0x3e8,_0x28fd9a=new Date(_0x4c4635['paidAt']['getTime']()+_0x35d009);return new Date()>_0x28fd9a;}[a47_0x35d70f(0xe7)](_0x5211b4,_0x122c93){return _0x5211b4*(0x1-_0x122c93/0x64);}async['getShopProfile'](_0x4f54f3){const _0x165b8e=a47_0x35d70f,_0x33fa1b=await database_1['default'][_0x165b8e(0x131)][_0x165b8e(0xfb)]({'where':{'id':_0x4f54f3},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x33fa1b)throw new Error(_0x165b8e(0x13a));return{'id':_0x33fa1b['id'],'fullName':_0x33fa1b['name'],'username':_0x33fa1b['username'],'telegramId':_0x33fa1b[_0x165b8e(0x154)],'merchantUrl':_0x33fa1b[_0x165b8e(0x187)],'gateways':_0x33fa1b[_0x165b8e(0x14f)]?JSON[_0x165b8e(0x1bd)](_0x33fa1b[_0x165b8e(0x14f)]):null,'gatewaySettings':_0x33fa1b[_0x165b8e(0x1ba)]?JSON[_0x165b8e(0x1bd)](_0x33fa1b[_0x165b8e(0x1ba)]):null,'publicKey':_0x33fa1b[_0x165b8e(0xf1)],'wallets':{'usdtPolygonWallet':_0x33fa1b[_0x165b8e(0x11d)],'usdtTrcWallet':_0x33fa1b[_0x165b8e(0xe4)],'usdtErcWallet':_0x33fa1b[_0x165b8e(0x196)],'usdcPolygonWallet':_0x33fa1b['usdcPolygonWallet']},'status':_0x33fa1b[_0x165b8e(0xf4)],'createdAt':_0x33fa1b[_0x165b8e(0x18d)]};}async[a47_0x35d70f(0x1a1)](_0x48fbea,_0x44b612){const _0x3cb2bb=a47_0x35d70f,_0x4dbe68={..._0x44b612};_0x44b612[_0x3cb2bb(0x193)]&&(_0x4dbe68[_0x3cb2bb(0x1b8)]=_0x44b612[_0x3cb2bb(0x193)],delete _0x4dbe68[_0x3cb2bb(0x193)]);_0x44b612[_0x3cb2bb(0x1b5)]&&(_0x4dbe68[_0x3cb2bb(0x154)]=_0x44b612[_0x3cb2bb(0x1b5)],delete _0x4dbe68[_0x3cb2bb(0x1b5)]);_0x44b612[_0x3cb2bb(0x16d)]&&(_0x4dbe68['shopUrl']=_0x44b612[_0x3cb2bb(0x16d)],delete _0x4dbe68['merchantUrl']);_0x44b612[_0x3cb2bb(0x164)]&&(_0x4dbe68[_0x3cb2bb(0x14f)]=JSON[_0x3cb2bb(0x140)](_0x44b612[_0x3cb2bb(0x164)]),delete _0x4dbe68[_0x3cb2bb(0x164)]);_0x44b612[_0x3cb2bb(0x1ba)]&&(_0x4dbe68[_0x3cb2bb(0x1ba)]=JSON[_0x3cb2bb(0x140)](_0x44b612[_0x3cb2bb(0x1ba)]),delete _0x4dbe68[_0x3cb2bb(0x1ba)]);_0x44b612[_0x3cb2bb(0x10e)]&&(_0x44b612[_0x3cb2bb(0x10e)][_0x3cb2bb(0x11d)]!==undefined&&(_0x4dbe68[_0x3cb2bb(0x11d)]=_0x44b612[_0x3cb2bb(0x10e)]['usdtPolygonWallet']||null),_0x44b612[_0x3cb2bb(0x10e)]['usdtTrcWallet']!==undefined&&(_0x4dbe68[_0x3cb2bb(0xe4)]=_0x44b612['wallets'][_0x3cb2bb(0xe4)]||null),_0x44b612['wallets'][_0x3cb2bb(0x196)]!==undefined&&(_0x4dbe68[_0x3cb2bb(0x196)]=_0x44b612[_0x3cb2bb(0x10e)][_0x3cb2bb(0x196)]||null),_0x44b612[_0x3cb2bb(0x10e)][_0x3cb2bb(0x12a)]!==undefined&&(_0x4dbe68[_0x3cb2bb(0x12a)]=_0x44b612[_0x3cb2bb(0x10e)][_0x3cb2bb(0x12a)]||null),delete _0x4dbe68[_0x3cb2bb(0x10e)]);const _0x2d8126=await database_1[_0x3cb2bb(0x194)][_0x3cb2bb(0x131)][_0x3cb2bb(0x166)]({'where':{'id':_0x48fbea},'data':_0x4dbe68,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x2d8126['id'],'fullName':_0x2d8126['name'],'username':_0x2d8126['username'],'telegramId':_0x2d8126[_0x3cb2bb(0x154)],'merchantUrl':_0x2d8126['shopUrl'],'gateways':_0x2d8126[_0x3cb2bb(0x14f)]?JSON[_0x3cb2bb(0x1bd)](_0x2d8126[_0x3cb2bb(0x14f)]):null,'gatewaySettings':_0x2d8126[_0x3cb2bb(0x1ba)]?JSON[_0x3cb2bb(0x1bd)](_0x2d8126[_0x3cb2bb(0x1ba)]):null,'publicKey':_0x2d8126['publicKey'],'wallets':{'usdtPolygonWallet':_0x2d8126['usdtPolygonWallet'],'usdtTrcWallet':_0x2d8126[_0x3cb2bb(0xe4)],'usdtErcWallet':_0x2d8126[_0x3cb2bb(0x196)],'usdcPolygonWallet':_0x2d8126[_0x3cb2bb(0x12a)]},'status':_0x2d8126[_0x3cb2bb(0xf4)],'createdAt':_0x2d8126[_0x3cb2bb(0x18d)]};}async[a47_0x35d70f(0x102)](_0x360352,_0x5ad9c7){const _0x2996b1=a47_0x35d70f,_0x14afa8={};_0x5ad9c7[_0x2996b1(0x11d)]!==undefined&&(_0x14afa8[_0x2996b1(0x11d)]=_0x5ad9c7[_0x2996b1(0x11d)]||null),_0x5ad9c7[_0x2996b1(0xe4)]!==undefined&&(_0x14afa8[_0x2996b1(0xe4)]=_0x5ad9c7[_0x2996b1(0xe4)]||null),_0x5ad9c7['usdtErcWallet']!==undefined&&(_0x14afa8[_0x2996b1(0x196)]=_0x5ad9c7['usdtErcWallet']||null),_0x5ad9c7['usdcPolygonWallet']!==undefined&&(_0x14afa8['usdcPolygonWallet']=_0x5ad9c7[_0x2996b1(0x12a)]||null),await database_1['default'][_0x2996b1(0x131)][_0x2996b1(0x166)]({'where':{'id':_0x360352},'data':_0x14afa8});}async['testWebhook'](_0x14c37b){const _0x5f19d5=a47_0x35d70f,_0x2cb0bc=await database_1[_0x5f19d5(0x194)][_0x5f19d5(0x131)]['findUnique']({'where':{'id':_0x14c37b},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x2cb0bc)throw new Error(_0x5f19d5(0x13a));const _0x26af3a=_0x2cb0bc[_0x5f19d5(0x192)]?.[_0x5f19d5(0xfc)];if(!_0x26af3a)throw new Error(_0x5f19d5(0x163));const _0x4cf1fa=await this['generateGatewayOrderId'](),_0x52a4c1={'event':_0x5f19d5(0x1aa),'payment':{'id':_0x5f19d5(0x18a)+Date[_0x5f19d5(0x17c)](),'order_id':null,'gateway_order_id':_0x4cf1fa,'gateway':'plisio','amount':0x64,'currency':_0x5f19d5(0xfa),'status':_0x5f19d5(0x1ad),'customer_email':_0x5f19d5(0x19e),'customer_name':_0x5f19d5(0xee),'created_at':new Date()[_0x5f19d5(0x139)](),'updated_at':new Date()[_0x5f19d5(0x139)]()},'test':!![],'shop':{'id':_0x2cb0bc['id'],'name':_0x2cb0bc[_0x5f19d5(0x1b8)]},'timestamp':new Date()[_0x5f19d5(0x139)]()},_0x48304f=Date[_0x5f19d5(0x17c)]();let _0x56f07d=0x0,_0x18211f=![],_0x5bdd5e;try{console[_0x5f19d5(0x149)](_0x5f19d5(0x18f)+_0x26af3a),console[_0x5f19d5(0x149)](_0x5f19d5(0x10b),JSON[_0x5f19d5(0x140)](_0x52a4c1,null,0x2));const _0x1535d5=await fetch(_0x26af3a,{'method':'POST','headers':{'Content-Type':_0x5f19d5(0x141),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','X-Webhook-Test':_0x5f19d5(0x1ab)},'body':JSON[_0x5f19d5(0x140)](_0x52a4c1)});_0x56f07d=_0x1535d5[_0x5f19d5(0xf4)],_0x18211f=_0x1535d5['ok'];if(!_0x1535d5['ok']){const _0x3b9c09=await _0x1535d5['text']();_0x5bdd5e=_0x5f19d5(0x15c)+_0x1535d5[_0x5f19d5(0xf4)]+':\x20'+_0x3b9c09,console['error'](_0x5f19d5(0x1c0)+_0x5bdd5e);}else console[_0x5f19d5(0x149)]('âœ…\x20Test\x20webhook\x20sent\x20successfully:\x20'+_0x1535d5[_0x5f19d5(0xf4)]);}catch(_0x503eed){_0x5bdd5e=_0x503eed instanceof Error?_0x503eed[_0x5f19d5(0x19f)]:_0x5f19d5(0x147),console[_0x5f19d5(0x100)](_0x5f19d5(0x144)+_0x5bdd5e);}const _0x578ba9=Date['now']()-_0x48304f;try{await database_1[_0x5f19d5(0x194)][_0x5f19d5(0x12f)][_0x5f19d5(0x183)]({'data':{'paymentId':_0x5f19d5(0xea),'shopId':_0x2cb0bc['id'],'event':_0x5f19d5(0xea),'statusCode':_0x56f07d,'responseBody':JSON[_0x5f19d5(0x140)]({'success':_0x18211f,'error':_0x5bdd5e,'responseTime':_0x578ba9,'testPayload':_0x52a4c1})}});}catch(_0x1cac91){console[_0x5f19d5(0x100)](_0x5f19d5(0x1b3),_0x1cac91);}return{'webhookUrl':_0x26af3a,'statusCode':_0x56f07d,'responseTime':_0x578ba9,'success':_0x18211f,'error':_0x5bdd5e};}async['createPayment'](_0x34e6e6){const _0xab5b1a=a47_0x35d70f;let _0x26c346;if((0x0,gateway_1[_0xab5b1a(0x133)])(_0x34e6e6[_0xab5b1a(0xf2)])){const _0x42702c=(0x0,gateway_1['getGatewayNameById'])(_0x34e6e6[_0xab5b1a(0xf2)]);if(!_0x42702c)throw new Error(_0xab5b1a(0x10a)+_0x34e6e6[_0xab5b1a(0xf2)]);_0x26c346=_0x42702c;}else _0x26c346=_0x34e6e6['gateway'][_0xab5b1a(0x132)]();console[_0xab5b1a(0x149)](_0xab5b1a(0xec)+_0x26c346);const _0x8ea3b2=await this[_0xab5b1a(0xf5)]();console[_0xab5b1a(0x149)](_0xab5b1a(0x1ac)+_0x8ea3b2+_0xab5b1a(0x198)+_0x26c346+')');const _0x2f1ea6=await database_1['default']['shop'][_0xab5b1a(0xfb)]({'where':{'id':_0x34e6e6['shopId']},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x2f1ea6)throw new Error(_0xab5b1a(0x13a));const _0x30be71=this[_0xab5b1a(0x114)](_0x2f1ea6,_0x26c346),_0x4d08e5=process[_0xab5b1a(0x17b)][_0xab5b1a(0x1b0)]||_0xab5b1a(0x1bf),{finalSuccessUrl:_0x18d783,finalFailUrl:_0x2fd77d}=this[_0xab5b1a(0x1b9)](_0x26c346,_0x8ea3b2,_0x4d08e5,_0x34e6e6[_0xab5b1a(0x1a7)],undefined),_0x15674e=await database_1[_0xab5b1a(0x194)][_0xab5b1a(0x175)][_0xab5b1a(0x183)]({'data':{'shopId':_0x34e6e6[_0xab5b1a(0x1b4)],'gateway':_0x26c346,'amount':_0x34e6e6[_0xab5b1a(0x104)],'currency':_0x34e6e6[_0xab5b1a(0x123)]||_0xab5b1a(0xfa),'sourceCurrency':_0x34e6e6[_0xab5b1a(0xe1)]||null,'usage':_0x34e6e6[_0xab5b1a(0x155)]||_0xab5b1a(0x13e),'expiresAt':_0x34e6e6['expiresAt'],'successUrl':_0x18d783,'failUrl':_0x2fd77d,'status':'PENDING','orderId':null,'gatewayOrderId':_0x8ea3b2,'customerEmail':_0x34e6e6['customerEmail']||null,'customerName':_0x34e6e6[_0xab5b1a(0x124)]||null,'country':_0x34e6e6[_0xab5b1a(0x14d)]||null,'language':_0x34e6e6['language']||null,'amountIsEditable':_0x34e6e6[_0xab5b1a(0x109)]||null,'maxPayments':_0x34e6e6[_0xab5b1a(0x18e)]||null,'rapydCustomer':_0x34e6e6[_0xab5b1a(0x112)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console[_0xab5b1a(0x149)]('ðŸ’¾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20'+_0x8ea3b2+_0xab5b1a(0x15b));let _0x49e04a;try{if(_0x26c346===_0xab5b1a(0x165)){let _0x26df1e,_0x3362eb,_0x6de20d;_0x34e6e6[_0xab5b1a(0xe1)]?(_0x26df1e=_0x34e6e6[_0xab5b1a(0xe1)],_0x3362eb=_0x34e6e6[_0xab5b1a(0x123)]||_0xab5b1a(0xfa),_0x6de20d=![]):(_0x26df1e=_0xab5b1a(0xfa),_0x3362eb=_0x34e6e6['currency']||'USD',_0x6de20d=!![]);const _0x2eac6b=await this['plisioService']['createPayment']({'paymentId':_0x15674e['id'],'orderId':_0x8ea3b2,'amount':_0x34e6e6['amount'],'currency':_0x26df1e,'productName':_0xab5b1a(0x111)+_0x8ea3b2,'description':'Order\x20ID:\x20'+_0x8ea3b2,'successUrl':_0x18d783,'failUrl':_0x2fd77d,'customerEmail':_0x34e6e6['customerEmail'],'customerName':_0x34e6e6[_0xab5b1a(0x124)],'isSourceCurrency':_0x6de20d});_0x49e04a=_0x2eac6b['payment_url'],await database_1[_0xab5b1a(0x194)][_0xab5b1a(0x175)][_0xab5b1a(0x166)]({'where':{'id':_0x15674e['id']},'data':{'externalPaymentUrl':_0x49e04a,'gatewayPaymentId':_0x2eac6b[_0xab5b1a(0x199)],'invoiceTotalSum':_0x2eac6b[_0xab5b1a(0x16c)],'qrCode':_0x2eac6b[_0xab5b1a(0x178)],'qrUrl':_0x2eac6b[_0xab5b1a(0x121)]}}),_0x15674e['externalPaymentUrl']=_0x49e04a,_0x15674e[_0xab5b1a(0x13c)]=_0x2eac6b[_0xab5b1a(0x199)];}else{if(_0x26c346===_0xab5b1a(0x16f)){const _0x57b9ae='GB';console[_0xab5b1a(0x149)](_0xab5b1a(0x19a));const _0x865011=await this['rapydService'][_0xab5b1a(0x158)]({'paymentId':_0x15674e['id'],'orderId':_0x8ea3b2,'orderName':_0xab5b1a(0x111)+_0x8ea3b2,'amount':_0x34e6e6[_0xab5b1a(0x104)],'currency':_0x34e6e6[_0xab5b1a(0x123)]||_0xab5b1a(0xfa),'country':_0x57b9ae,'usage':_0x34e6e6[_0xab5b1a(0x155)]||_0xab5b1a(0x13e),'maxPayments':_0x34e6e6['maxPayments'],'successUrl':_0x18d783,'failUrl':_0x2fd77d});_0x49e04a=_0x865011[_0xab5b1a(0x1ae)],await database_1['default'][_0xab5b1a(0x175)][_0xab5b1a(0x166)]({'where':{'id':_0x15674e['id']},'data':{'externalPaymentUrl':_0x49e04a,'gatewayPaymentId':_0x865011[_0xab5b1a(0x199)],'country':_0x57b9ae}}),_0x15674e['externalPaymentUrl']=_0x49e04a,_0x15674e[_0xab5b1a(0x13c)]=_0x865011[_0xab5b1a(0x199)];}else{if(_0x26c346===_0xab5b1a(0x161)){console[_0xab5b1a(0x149)](_0xab5b1a(0x167)+_0x8ea3b2+_0xab5b1a(0x15b));const _0xcd8270=await this[_0xab5b1a(0x11b)][_0xab5b1a(0x158)]({'paymentId':_0x15674e['id'],'orderId':_0x8ea3b2,'name':_0xab5b1a(0x111)+_0x8ea3b2,'paymentDescription':_0xab5b1a(0x111)+_0x8ea3b2,'amount':_0x34e6e6[_0xab5b1a(0x104)],'currency':_0x34e6e6[_0xab5b1a(0x123)]||'USD','webhookUrl':_0xab5b1a(0xff),'returnUrl':_0x18d783,'expiryDate':_0x34e6e6[_0xab5b1a(0x1b1)]?.[_0xab5b1a(0x139)]()});_0x49e04a=_0xcd8270[_0xab5b1a(0x1ae)],await database_1[_0xab5b1a(0x194)][_0xab5b1a(0x175)][_0xab5b1a(0x166)]({'where':{'id':_0x15674e['id']},'data':{'externalPaymentUrl':_0x49e04a,'gatewayPaymentId':_0xcd8270['gateway_payment_id'],'qrUrl':_0xcd8270[_0xab5b1a(0x180)]}}),_0x15674e[_0xab5b1a(0x156)]=_0x49e04a,_0x15674e[_0xab5b1a(0x13c)]=_0xcd8270[_0xab5b1a(0x199)],console['log']('âœ…\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x8ea3b2);}else{if(_0x26c346===_0xab5b1a(0x15a)){console[_0xab5b1a(0x149)](_0xab5b1a(0x157)+_0x8ea3b2+_0xab5b1a(0x15b)),console[_0xab5b1a(0x149)](_0xab5b1a(0x1c1)+_0x34e6e6[_0xab5b1a(0x104)]+_0xab5b1a(0x110));const _0x3ad7a0=await this[_0xab5b1a(0x120)][_0xab5b1a(0x158)]({'paymentId':_0x15674e['id'],'orderId':_0x8ea3b2,'amount':_0x34e6e6['amount']});_0x49e04a=_0x3ad7a0[_0xab5b1a(0x1ae)],await database_1['default'][_0xab5b1a(0x175)]['update']({'where':{'id':_0x15674e['id']},'data':{'externalPaymentUrl':_0x49e04a,'gatewayPaymentId':_0x3ad7a0[_0xab5b1a(0x199)],'currency':'EUR'}}),_0x15674e['externalPaymentUrl']=_0x49e04a,_0x15674e[_0xab5b1a(0x13c)]=_0x3ad7a0[_0xab5b1a(0x199)],console['log'](_0xab5b1a(0x153)+_0x8ea3b2);}else{if(_0x26c346[_0xab5b1a(0x127)](_0xab5b1a(0x126))){const _0x3e470b=(0x0,gateway_1[_0xab5b1a(0x16a)])(_0x26c346);if(!_0x3e470b)throw new Error(_0xab5b1a(0x16e)+_0x26c346);if(_0x3e470b!=='EU'&&_0x3e470b!=='GB')throw new Error(_0xab5b1a(0xe9)+_0x3e470b);console[_0xab5b1a(0x149)](_0xab5b1a(0x168)+_0x3e470b+'\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20'+_0x8ea3b2+_0xab5b1a(0x15b)),console[_0xab5b1a(0x149)]('ðŸ’°\x20Amount:\x20'+_0x34e6e6[_0xab5b1a(0x104)]+'\x20'+(_0x34e6e6['currency']||'USD'));const _0x5eb61f=await this[_0xab5b1a(0x148)][_0xab5b1a(0x158)]({'paymentId':_0x15674e['id'],'orderId':_0x8ea3b2,'amount':_0x34e6e6[_0xab5b1a(0x104)],'currency':_0x34e6e6['currency']||_0xab5b1a(0xfa),'region':_0x3e470b,'redirectUrl':_0x18d783});_0x49e04a=_0x5eb61f[_0xab5b1a(0x1ae)],await database_1[_0xab5b1a(0x194)]['payment'][_0xab5b1a(0x166)]({'where':{'id':_0x15674e['id']},'data':{'externalPaymentUrl':_0x49e04a,'gatewayPaymentId':_0x5eb61f['gateway_payment_id']}}),_0x15674e[_0xab5b1a(0x156)]=_0x49e04a,_0x15674e[_0xab5b1a(0x13c)]=_0x5eb61f[_0xab5b1a(0x199)],console[_0xab5b1a(0x149)](_0xab5b1a(0xe3)+_0x3e470b+'\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x8ea3b2);}}}}}}catch(_0x4dbb16){await database_1[_0xab5b1a(0x194)][_0xab5b1a(0x175)][_0xab5b1a(0x166)]({'where':{'id':_0x15674e['id']},'data':{'status':_0xab5b1a(0x15e)}}),console[_0xab5b1a(0x100)]('Gateway\x20error\x20during\x20shop\x20payment\x20creation:',_0x4dbb16);}const _0x5c9344=_0xab5b1a(0x159)+_0x15674e['id'];return{'id':_0x15674e['id'],'shopId':_0x15674e[_0xab5b1a(0x1b4)],'gateway':_0x15674e[_0xab5b1a(0xf2)],'amount':_0x15674e['amount'],'currency':_0x15674e[_0xab5b1a(0x123)],'sourceCurrency':_0x15674e[_0xab5b1a(0xe1)],'usage':_0x15674e['usage'],'expiresAt':_0x15674e[_0xab5b1a(0x1b1)],'redirectUrl':_0x5c9344,'status':_0x15674e[_0xab5b1a(0xf4)],'externalPaymentUrl':_0x49e04a,'customerEmail':_0x15674e[_0xab5b1a(0xed)],'customerName':_0x15674e[_0xab5b1a(0x124)],'country':_0x15674e[_0xab5b1a(0x14d)],'language':_0x15674e[_0xab5b1a(0x17d)],'amountIsEditable':_0x15674e['amountIsEditable'],'maxPayments':_0x15674e[_0xab5b1a(0x18e)],'customer':_0x15674e[_0xab5b1a(0x105)],'createdAt':_0x15674e['createdAt'],'updatedAt':_0x15674e[_0xab5b1a(0x15f)],'shop':_0x15674e[_0xab5b1a(0x131)]};}async[a47_0x35d70f(0x1a3)](_0x14b361,_0x4d76e7){const _0x13a92d=a47_0x35d70f,{page:_0x15242c,limit:_0x325629,status:_0x82c664,gateway:_0x4fb843}=_0x4d76e7,_0x50c9f9=(_0x15242c-0x1)*_0x325629,_0x5bab51={'shopId':_0x14b361};_0x82c664&&(_0x5bab51[_0x13a92d(0xf4)]=_0x82c664);if(_0x4fb843){if((0x0,gateway_1[_0x13a92d(0x133)])(_0x4fb843)){const _0x1162d6=(0x0,gateway_1['getGatewayNameById'])(_0x4fb843);_0x1162d6&&(_0x5bab51[_0x13a92d(0xf2)]=_0x1162d6);}else _0x5bab51['gateway']=_0x4fb843['toLowerCase']();}const [_0xa74955,_0xc62219]=await Promise[_0x13a92d(0x1a9)]([database_1[_0x13a92d(0x194)][_0x13a92d(0x175)][_0x13a92d(0x108)]({'where':_0x5bab51,'skip':_0x50c9f9,'take':_0x325629,'orderBy':{'createdAt':_0x13a92d(0x1be)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1[_0x13a92d(0x194)][_0x13a92d(0x175)][_0x13a92d(0x128)]({'where':_0x5bab51})]);return{'payments':_0xa74955[_0x13a92d(0x14e)](_0x260e86=>{const _0x50d821=_0x13a92d,_0x53d197=_0x50d821(0x159)+_0x260e86['id'];return{'id':_0x260e86['id'],'shopId':_0x260e86['shopId'],'gateway':_0x260e86['gateway'],'amount':_0x260e86[_0x50d821(0x104)],'currency':_0x260e86[_0x50d821(0x123)],'sourceCurrency':_0x260e86[_0x50d821(0xe1)],'usage':_0x260e86[_0x50d821(0x155)],'expiresAt':_0x260e86[_0x50d821(0x1b1)],'redirectUrl':_0x53d197,'status':_0x260e86[_0x50d821(0xf4)],'externalPaymentUrl':_0x260e86[_0x50d821(0x156)],'customerEmail':_0x260e86[_0x50d821(0xed)],'customerName':_0x260e86[_0x50d821(0x124)],'country':_0x260e86[_0x50d821(0x14d)],'language':_0x260e86[_0x50d821(0x17d)],'amountIsEditable':_0x260e86[_0x50d821(0x109)],'maxPayments':_0x260e86[_0x50d821(0x18e)],'customer':_0x260e86[_0x50d821(0x105)],'createdAt':_0x260e86[_0x50d821(0x18d)],'updatedAt':_0x260e86[_0x50d821(0x15f)],'shop':_0x260e86[_0x50d821(0x131)]};}),'pagination':{'page':_0x15242c,'limit':_0x325629,'total':_0xc62219,'totalPages':Math['ceil'](_0xc62219/_0x325629)}};}async[a47_0x35d70f(0x150)](_0x47f54f,_0x255c07){const _0x574763=a47_0x35d70f,_0x490dc6=await database_1['default'][_0x574763(0x175)][_0x574763(0xf3)]({'where':{'id':_0x255c07,'shopId':_0x47f54f},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x574763(0x1be)},'take':0xa}}});if(!_0x490dc6)return null;const _0x6eac8=_0x574763(0x159)+_0x490dc6['id'];return{'id':_0x490dc6['id'],'shopId':_0x490dc6[_0x574763(0x1b4)],'gateway':_0x490dc6[_0x574763(0xf2)],'amount':_0x490dc6['amount'],'currency':_0x490dc6['currency'],'sourceCurrency':_0x490dc6[_0x574763(0xe1)],'usage':_0x490dc6[_0x574763(0x155)],'expiresAt':_0x490dc6[_0x574763(0x1b1)],'redirectUrl':_0x6eac8,'status':_0x490dc6[_0x574763(0xf4)],'externalPaymentUrl':_0x490dc6['externalPaymentUrl'],'customerEmail':_0x490dc6[_0x574763(0xed)],'customerName':_0x490dc6[_0x574763(0x124)],'country':_0x490dc6[_0x574763(0x14d)],'language':_0x490dc6[_0x574763(0x17d)],'amountIsEditable':_0x490dc6['amountIsEditable'],'maxPayments':_0x490dc6['maxPayments'],'customer':_0x490dc6[_0x574763(0x105)],'createdAt':_0x490dc6[_0x574763(0x18d)],'updatedAt':_0x490dc6[_0x574763(0x15f)],'shop':_0x490dc6['shop'],'webhookLogs':_0x490dc6[_0x574763(0x1b2)]};}async[a47_0x35d70f(0x143)](_0x54ca69,_0x3c37bc,_0x3cc75c){const _0x2232cc=a47_0x35d70f,_0x1a3efa={..._0x3cc75c};if(_0x3cc75c['gateway']){if((0x0,gateway_1[_0x2232cc(0x133)])(_0x3cc75c['gateway'])){const _0x50df78=(0x0,gateway_1['getGatewayNameById'])(_0x3cc75c['gateway']);_0x50df78&&(_0x1a3efa[_0x2232cc(0xf2)]=_0x50df78);}else _0x1a3efa[_0x2232cc(0xf2)]=_0x3cc75c[_0x2232cc(0xf2)][_0x2232cc(0x132)]();}const _0xd782c8=await database_1[_0x2232cc(0x194)][_0x2232cc(0x175)][_0x2232cc(0x166)]({'where':{'id':_0x3c37bc,'shopId':_0x54ca69},'data':_0x1a3efa,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x873f8d='https://tesoft.uk/gateway/payment.php?id='+_0xd782c8['id'];return{'id':_0xd782c8['id'],'shopId':_0xd782c8[_0x2232cc(0x1b4)],'gateway':_0xd782c8[_0x2232cc(0xf2)],'amount':_0xd782c8['amount'],'currency':_0xd782c8['currency'],'sourceCurrency':_0xd782c8[_0x2232cc(0xe1)],'usage':_0xd782c8[_0x2232cc(0x155)],'expiresAt':_0xd782c8[_0x2232cc(0x1b1)],'redirectUrl':_0x873f8d,'status':_0xd782c8[_0x2232cc(0xf4)],'externalPaymentUrl':_0xd782c8[_0x2232cc(0x156)],'customerEmail':_0xd782c8[_0x2232cc(0xed)],'customerName':_0xd782c8[_0x2232cc(0x124)],'country':_0xd782c8[_0x2232cc(0x14d)],'language':_0xd782c8[_0x2232cc(0x17d)],'amountIsEditable':_0xd782c8['amountIsEditable'],'maxPayments':_0xd782c8[_0x2232cc(0x18e)],'customer':_0xd782c8[_0x2232cc(0x105)],'createdAt':_0xd782c8[_0x2232cc(0x18d)],'updatedAt':_0xd782c8[_0x2232cc(0x15f)],'shop':_0xd782c8[_0x2232cc(0x131)]};}async[a47_0x35d70f(0x190)](_0x218954,_0x41cc18){const _0x35c3ad=a47_0x35d70f;await database_1[_0x35c3ad(0x194)][_0x35c3ad(0x175)]['delete']({'where':{'id':_0x41cc18,'shopId':_0x218954}});}async['getPayouts'](_0x3ed02f,_0x2e5233){const _0x4aa73c=a47_0x35d70f,{page:_0x2bf866,limit:_0x4ef54d,status:_0x37ca60,method:_0x21e851,dateFrom:_0xfe4939,dateTo:_0x4ddb01}=_0x2e5233,_0x2faac5=(_0x2bf866-0x1)*_0x4ef54d,_0x4aacb0={'shopId':_0x3ed02f};_0x37ca60&&(_0x4aacb0[_0x4aa73c(0xf4)]=_0x37ca60);_0x21e851&&(_0x4aacb0[_0x4aa73c(0x186)]=_0x21e851);(_0xfe4939||_0x4ddb01)&&(_0x4aacb0[_0x4aa73c(0x18d)]={},_0xfe4939&&(_0x4aacb0[_0x4aa73c(0x18d)][_0x4aa73c(0x1a4)]=new Date(_0xfe4939)),_0x4ddb01&&(_0x4aacb0[_0x4aa73c(0x18d)]['lte']=new Date(_0x4ddb01)));const [_0x3d9156,_0x515172]=await Promise[_0x4aa73c(0x1a9)]([database_1[_0x4aa73c(0x194)][_0x4aa73c(0x107)][_0x4aa73c(0x108)]({'where':_0x4aacb0,'skip':_0x2faac5,'take':_0x4ef54d,'orderBy':{'createdAt':_0x4aa73c(0x1be)}}),database_1[_0x4aa73c(0x194)][_0x4aa73c(0x107)][_0x4aa73c(0x128)]({'where':_0x4aacb0})]);return{'payouts':_0x3d9156[_0x4aa73c(0x14e)](_0x13270a=>({'id':_0x13270a['id'],'amount':_0x13270a['amount'],'network':_0x13270a[_0x4aa73c(0x186)],'status':_0x13270a[_0x4aa73c(0xf4)],'txid':_0x13270a[_0x4aa73c(0x195)],'notes':_0x13270a[_0x4aa73c(0x103)],'createdAt':_0x13270a[_0x4aa73c(0x18d)],'paidAt':_0x13270a['paidAt']})),'pagination':{'page':_0x2bf866,'limit':_0x4ef54d,'total':_0x515172,'totalPages':Math[_0x4aa73c(0xe5)](_0x515172/_0x4ef54d)}};}async[a47_0x35d70f(0xf0)](_0x51d434,_0x55cf14){const _0x4ae4bb=a47_0x35d70f,_0x8249af=await database_1['default']['payout'][_0x4ae4bb(0xf3)]({'where':{'id':_0x55cf14,'shopId':_0x51d434},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x8249af)return null;return{'id':_0x8249af['id'],'shopId':_0x8249af['shopId'],'amount':_0x8249af[_0x4ae4bb(0x104)],'method':_0x8249af[_0x4ae4bb(0x186)],'status':_0x8249af[_0x4ae4bb(0xf4)],'txid':_0x8249af[_0x4ae4bb(0x195)],'createdAt':_0x8249af[_0x4ae4bb(0x18d)],'paidAt':_0x8249af['paidAt'],'shop':_0x8249af[_0x4ae4bb(0x131)]};}async[a47_0x35d70f(0x174)](_0x52a40c,_0x6a0af3){const _0xe8f987=a47_0x35d70f,_0x83ae96=this['getPeriodDays'](_0x6a0af3),_0x49abf6=new Date();_0x49abf6['setDate'](_0x49abf6['getDate']()-_0x83ae96);const _0x5ba2f4={'shopId':_0x52a40c,'createdAt':{'gte':_0x49abf6}},[_0x130285,_0x2bb993,_0x199d08,_0x46f52f,_0x26648a,_0x8c169a,_0x136199,_0x4a7890]=await Promise[_0xe8f987(0x1a9)]([database_1[_0xe8f987(0x194)]['payout'][_0xe8f987(0x128)]({'where':_0x5ba2f4}),database_1[_0xe8f987(0x194)][_0xe8f987(0x107)][_0xe8f987(0x128)]({'where':{..._0x5ba2f4,'status':'COMPLETED'}}),database_1[_0xe8f987(0x194)]['payout'][_0xe8f987(0x128)]({'where':{..._0x5ba2f4,'status':_0xe8f987(0x182)}}),database_1[_0xe8f987(0x194)][_0xe8f987(0x107)]['count']({'where':{..._0x5ba2f4,'status':'REJECTED'}}),database_1['default'][_0xe8f987(0x107)]['aggregate']({'where':_0x5ba2f4,'_sum':{'amount':!![]}}),database_1[_0xe8f987(0x194)][_0xe8f987(0x107)][_0xe8f987(0x136)]({'by':[_0xe8f987(0xf4)],'where':_0x5ba2f4,'_count':{'status':!![]}}),database_1['default'][_0xe8f987(0x107)][_0xe8f987(0x136)]({'by':[_0xe8f987(0x186)],'where':_0x5ba2f4,'_count':{'network':!![]}}),database_1['default'][_0xe8f987(0x107)][_0xe8f987(0x108)]({'where':{'shopId':_0x52a40c},'take':0xa,'orderBy':{'createdAt':_0xe8f987(0x1be)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x349eb9=await database_1[_0xe8f987(0x194)]['payout']['aggregate']({'where':{..._0x5ba2f4,'status':_0xe8f987(0x170)},'_sum':{'amount':!![]}}),_0x440d3f=await database_1[_0xe8f987(0x194)][_0xe8f987(0x107)][_0xe8f987(0x184)]({'where':{..._0x5ba2f4,'status':_0xe8f987(0x182)},'_sum':{'amount':!![]}});return{'totalPayouts':_0x130285,'completedPayouts':_0x2bb993,'pendingPayouts':_0x199d08,'rejectedPayouts':_0x46f52f,'totalAmount':_0x26648a['_sum'][_0xe8f987(0x104)]||0x0,'completedAmount':_0x349eb9[_0xe8f987(0x162)][_0xe8f987(0x104)]||0x0,'pendingAmount':_0x440d3f[_0xe8f987(0x162)]['amount']||0x0,'payoutsByStatus':_0x8c169a[_0xe8f987(0x142)]((_0x1921d2,_0x21ec49)=>{const _0x1c69db=_0xe8f987;return _0x1921d2[_0x21ec49[_0x1c69db(0xf4)]]=_0x21ec49[_0x1c69db(0xe8)][_0x1c69db(0xf4)],_0x1921d2;},{}),'payoutsByMethod':_0x136199[_0xe8f987(0x142)]((_0xed1409,_0x399262)=>{const _0x1208e2=_0xe8f987;return _0xed1409[_0x399262[_0x1208e2(0x186)]]=_0x399262['_count']['network'],_0xed1409;},{}),'recentPayouts':_0x4a7890[_0xe8f987(0x14e)](_0x2f60fd=>({'id':_0x2f60fd['id'],'shopId':_0x2f60fd['shopId'],'amount':_0x2f60fd[_0xe8f987(0x104)],'method':_0x2f60fd['network'],'status':_0x2f60fd[_0xe8f987(0xf4)],'txid':_0x2f60fd[_0xe8f987(0x195)],'createdAt':_0x2f60fd[_0xe8f987(0x18d)],'paidAt':_0x2f60fd[_0xe8f987(0x171)],'shop':_0x2f60fd['shop']}))};}async[a47_0x35d70f(0x185)](_0xdf13a){const _0x19c23d=a47_0x35d70f;console[_0x19c23d(0x149)](_0x19c23d(0x13f)+_0xdf13a);const _0x259b99=await database_1[_0x19c23d(0x194)][_0x19c23d(0x131)][_0x19c23d(0xfb)]({'where':{'id':_0xdf13a},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x259b99)throw new Error(_0x19c23d(0x13a));const _0x33e8d8=await database_1[_0x19c23d(0x194)][_0x19c23d(0x175)][_0x19c23d(0x108)]({'where':{'shopId':_0xdf13a,'status':_0x19c23d(0x177)},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0x19c23d(0x149)](_0x19c23d(0x16b)+_0x33e8d8[_0x19c23d(0x1a2)]+'\x20paid\x20payments\x20for\x20analysis');const _0x16b2a5=new Date(),_0xd9d4ad=new Date(_0x16b2a5['getFullYear'](),_0x16b2a5[_0x19c23d(0x172)](),0x1);let _0x138315=0x0,_0x1dfd26=0x0,_0x53f662=0x0,_0x295ac3=0x0;for(const _0x1f33e8 of _0x33e8d8){const _0x2e041b=await currencyService_1[_0x19c23d(0x113)][_0x19c23d(0x10f)](_0x1f33e8[_0x19c23d(0x104)],_0x1f33e8['currency']),_0x2a5448=this[_0x19c23d(0x114)](_0x259b99,_0x1f33e8[_0x19c23d(0xf2)]),_0x32f9d3=this[_0x19c23d(0xe7)](_0x2e041b,_0x2a5448[_0x19c23d(0x138)]);_0x1f33e8[_0x19c23d(0x10c)]&&(_0x138315+=_0x32f9d3,_0x1f33e8['paidAt']&&_0x1f33e8['paidAt']>=_0xd9d4ad&&(_0x53f662+=_0x32f9d3)),this['isEligibleForPayout'](_0x1f33e8,_0x2a5448)&&(_0x1dfd26+=_0x32f9d3,_0x295ac3+=_0x2e041b);}const _0x534fa0={'availableBalance':Math[_0x19c23d(0xfd)](_0x295ac3*0x64)/0x64,'totalPaidOut':Math['round'](_0x138315*0x64)/0x64,'awaitingPayout':Math['round'](_0x1dfd26*0x64)/0x64,'thisMonth':Math['round'](_0x53f662*0x64)/0x64};return console[_0x19c23d(0x149)](_0x19c23d(0x189)),console[_0x19c23d(0x149)](_0x19c23d(0x12b)+_0x534fa0['availableBalance']+_0x19c23d(0x1a0)),console[_0x19c23d(0x149)](_0x19c23d(0x18c)+_0x534fa0[_0x19c23d(0x116)]+_0x19c23d(0x1a0)),console[_0x19c23d(0x149)](_0x19c23d(0x146)+_0x534fa0[_0x19c23d(0x12e)]+_0x19c23d(0x1a0)),console[_0x19c23d(0x149)](_0x19c23d(0xf9)+_0x534fa0['thisMonth']+_0x19c23d(0x1a0)),_0x534fa0;}async[a47_0x35d70f(0x181)](_0x1f801a){const _0x4eb505=a47_0x35d70f,_0x49c0a7=await this[_0x4eb505(0x185)](_0x1f801a);return{'totalBalance':_0x49c0a7[_0x4eb505(0x119)],'totalPaidOut':_0x49c0a7['totalPaidOut'],'awaitingPayout':_0x49c0a7[_0x4eb505(0x12e)],'thisMonth':_0x49c0a7[_0x4eb505(0x19d)]};}async[a47_0x35d70f(0x130)](_0x494e88,_0x8ab228){const _0x464e99=a47_0x35d70f,{page:_0x2a53ac,limit:_0x10d096,paymentId:_0x4c4ba9}=_0x8ab228,_0x555dc9=(_0x2a53ac-0x1)*_0x10d096,_0x3c34f7={'shopId':_0x494e88};_0x4c4ba9&&(_0x3c34f7[_0x464e99(0x135)]=_0x4c4ba9);const [_0x51f2c3,_0x908b2]=await Promise['all']([database_1[_0x464e99(0x194)][_0x464e99(0x12f)][_0x464e99(0x108)]({'where':_0x3c34f7,'skip':_0x555dc9,'take':_0x10d096,'orderBy':{'createdAt':_0x464e99(0x1be)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x464e99(0x194)][_0x464e99(0x12f)][_0x464e99(0x128)]({'where':_0x3c34f7})]);return{'logs':_0x51f2c3[_0x464e99(0x14e)](_0x155475=>({'id':_0x155475['id'],'paymentId':_0x155475[_0x464e99(0x135)],'shopId':_0x155475['shopId'],'event':_0x155475['event'],'statusCode':_0x155475['statusCode'],'retryCount':_0x155475[_0x464e99(0x13d)],'responseBody':_0x155475[_0x464e99(0x1bb)],'createdAt':_0x155475[_0x464e99(0x18d)],'payment':_0x155475[_0x464e99(0x175)]})),'pagination':{'page':_0x2a53ac,'limit':_0x10d096,'total':_0x908b2,'totalPages':Math['ceil'](_0x908b2/_0x10d096)}};}async[a47_0x35d70f(0x1b6)](_0x12737b,_0x215b17){const _0xc438dc=a47_0x35d70f,_0x2b5525=this[_0xc438dc(0x11c)](_0x215b17),_0x57a573=new Date();_0x57a573[_0xc438dc(0x10d)](_0x57a573[_0xc438dc(0x14c)]()-_0x2b5525),console[_0xc438dc(0x149)](_0xc438dc(0x169)+_0x215b17+'\x20('+_0x2b5525+_0xc438dc(0x18b));const _0x3695dd={'shopId':_0x12737b,'createdAt':{'gte':_0x57a573}},_0xdce534=await database_1[_0xc438dc(0x194)][_0xc438dc(0x131)][_0xc438dc(0xfb)]({'where':{'id':_0x12737b},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0xdce534)throw new Error(_0xc438dc(0x13a));const [_0x39bbb1,_0x2a533c,_0x34e0d0,_0x37fa11,_0x20eddf,_0x5efc08,_0x1187e0,_0xcb21d4]=await Promise[_0xc438dc(0x1a9)]([database_1[_0xc438dc(0x194)]['payment'][_0xc438dc(0x128)]({'where':_0x3695dd}),database_1[_0xc438dc(0x194)][_0xc438dc(0x175)]['count']({'where':{..._0x3695dd,'status':_0xc438dc(0x177)}}),database_1['default'][_0xc438dc(0x175)][_0xc438dc(0x108)]({'where':_0x3695dd,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1['default']['payment'][_0xc438dc(0x108)]({'where':{..._0x3695dd,'status':_0xc438dc(0x177)},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0xc438dc(0x194)][_0xc438dc(0x175)][_0xc438dc(0x136)]({'by':[_0xc438dc(0xf4)],'where':_0x3695dd,'_count':{'status':!![]}}),database_1['default'][_0xc438dc(0x175)]['groupBy']({'by':[_0xc438dc(0xf2)],'where':_0x3695dd,'_count':{'gateway':!![]}}),database_1[_0xc438dc(0x194)][_0xc438dc(0x175)][_0xc438dc(0x108)]({'where':{'shopId':_0x12737b},'take':0xa,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1[_0xc438dc(0x194)][_0xc438dc(0x17e)]`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x12737b} 
          AND created_at >= ${_0x57a573}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0xc438dc(0x149)](_0xc438dc(0x16b)+_0x37fa11[_0xc438dc(0x1a2)]+_0xc438dc(0x19b));const _0x14618e=await Promise[_0xc438dc(0x1a9)](_0x37fa11[_0xc438dc(0x14e)](async _0x5d7610=>{const _0x364163=_0xc438dc,_0x181ab2=await currencyService_1[_0x364163(0x113)][_0x364163(0x10f)](_0x5d7610[_0x364163(0x104)],_0x5d7610[_0x364163(0x123)]),_0x5c660b=this['getGatewaySettings'](_0xdce534,_0x5d7610[_0x364163(0xf2)]),_0x2b7f9c=this[_0x364163(0xe7)](_0x181ab2,_0x5c660b[_0x364163(0x138)]);return _0x2b7f9c;})),_0x3d9c1d=await Promise[_0xc438dc(0x1a9)](_0x34e0d0[_0xc438dc(0x14e)](async _0x44a2ac=>{const _0xb5c9d6=_0xc438dc,_0x2de296=await currencyService_1[_0xb5c9d6(0x113)][_0xb5c9d6(0x10f)](_0x44a2ac[_0xb5c9d6(0x104)],_0x44a2ac[_0xb5c9d6(0x123)]);return{'amount':_0x2de296,'status':_0x44a2ac[_0xb5c9d6(0xf4)]};})),_0x45d893=_0x14618e['reduce']((_0x486ebc,_0x5eeeaa)=>_0x486ebc+_0x5eeeaa,0x0),_0x3a3c51=_0x39bbb1>0x0?_0x3d9c1d[_0xc438dc(0x142)]((_0x4ccf05,_0x4161c5)=>_0x4ccf05+_0x4161c5['amount'],0x0)/_0x39bbb1:0x0;console[_0xc438dc(0x149)]('ðŸ’µ\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20'+_0x45d893['toFixed'](0x2)+_0xc438dc(0x1a0)),console[_0xc438dc(0x149)](_0xc438dc(0x137)+_0x3a3c51[_0xc438dc(0x1bc)](0x2)+_0xc438dc(0x1a0));const _0x3d0da5=this[_0xc438dc(0x19c)](_0x57a573,new Date()),_0x5db6af=await Promise[_0xc438dc(0x1a9)](_0xcb21d4[_0xc438dc(0x14e)](async _0x5b4a1e=>{const _0x5289a7=_0xc438dc,_0x33aead=_0x5b4a1e[_0x5289a7(0x17a)]['filter'](_0x28e302=>_0x28e302[_0x5289a7(0xf4)]===_0x5289a7(0x177)),_0x5239e9=await Promise[_0x5289a7(0x1a9)](_0x33aead[_0x5289a7(0x14e)](async _0x6aa05f=>{const _0x5198b4=_0x5289a7,_0x5b7823=await currencyService_1[_0x5198b4(0x113)][_0x5198b4(0x10f)](_0x6aa05f[_0x5198b4(0x104)],_0x6aa05f[_0x5198b4(0x123)]),_0x1beda1=this['getGatewaySettings'](_0xdce534,_0x6aa05f[_0x5198b4(0xf2)]),_0x1c087d=this[_0x5198b4(0xe7)](_0x5b7823,_0x1beda1[_0x5198b4(0x138)]);return _0x1c087d;})),_0x5d992f=_0x5239e9[_0x5289a7(0x142)]((_0xf3a6fe,_0x323534)=>_0xf3a6fe+_0x323534,0x0);return{'date':_0x5b4a1e[_0x5289a7(0x160)]['toISOString']()['split']('T')[0x0],'count':_0x5b4a1e[_0x5289a7(0x128)],'revenue':_0x5d992f};})),_0x24ae90=new Map(_0x5db6af[_0xc438dc(0x14e)](_0x39907b=>[_0x39907b['date'],{'count':_0x39907b[_0xc438dc(0x128)],'revenue':_0x39907b['revenue']}])),_0x4e5210=_0x3d0da5['map'](_0x2a0bf2=>({'date':_0x2a0bf2,'amount':_0x24ae90['get'](_0x2a0bf2)?.[_0xc438dc(0x14b)]||0x0})),_0x115871=_0x3d0da5['map'](_0x2c47a0=>({'date':_0x2c47a0,'count':_0x24ae90[_0xc438dc(0x118)](_0x2c47a0)?.[_0xc438dc(0x128)]||0x0}));return console['log'](_0xc438dc(0x191)),console[_0xc438dc(0x149)]('ðŸ’³\x20Total\x20payments:\x20'+_0x39bbb1),console[_0xc438dc(0x149)](_0xc438dc(0x129)+_0x2a533c),console[_0xc438dc(0x149)]('ðŸ“Š\x20Daily\x20revenue\x20entries:\x20'+_0x4e5210['length']),{'totalPayments':_0x39bbb1,'successfulPayments':_0x2a533c,'totalAmount':Math[_0xc438dc(0xfd)](_0x45d893*0x64)/0x64,'averageAmount':Math[_0xc438dc(0xfd)](_0x3a3c51*0x64)/0x64,'paymentsByStatus':_0x20eddf['reduce']((_0x528bd9,_0x3116c6)=>{const _0x11388b=_0xc438dc;return _0x528bd9[_0x3116c6[_0x11388b(0xf4)]]=_0x3116c6['_count'][_0x11388b(0xf4)],_0x528bd9;},{}),'paymentsByGateway':_0x5efc08[_0xc438dc(0x142)]((_0x78df6b,_0x273e02)=>{return _0x78df6b[_0x273e02['gateway']]=_0x273e02['_count']['gateway'],_0x78df6b;},{}),'recentPayments':_0x1187e0[_0xc438dc(0x14e)](_0x37106a=>{const _0x2141ef=_0xc438dc,_0xbb369f=_0x2141ef(0x159)+_0x37106a['id'];return{'id':_0x37106a['id'],'shopId':_0x37106a[_0x2141ef(0x1b4)],'gateway':_0x37106a['gateway'],'amount':_0x37106a[_0x2141ef(0x104)],'currency':_0x37106a[_0x2141ef(0x123)],'sourceCurrency':_0x37106a[_0x2141ef(0xe1)],'usage':_0x37106a['usage'],'expiresAt':_0x37106a[_0x2141ef(0x1b1)],'redirectUrl':_0xbb369f,'status':_0x37106a[_0x2141ef(0xf4)],'externalPaymentUrl':_0x37106a[_0x2141ef(0x156)],'customerEmail':_0x37106a[_0x2141ef(0xed)],'customerName':_0x37106a[_0x2141ef(0x124)],'country':_0x37106a['country'],'language':_0x37106a['language'],'amountIsEditable':_0x37106a[_0x2141ef(0x109)],'maxPayments':_0x37106a[_0x2141ef(0x18e)],'customer':_0x37106a[_0x2141ef(0x105)],'createdAt':_0x37106a['createdAt'],'updatedAt':_0x37106a[_0x2141ef(0x15f)],'shop':_0x37106a[_0x2141ef(0x131)]};}),'dailyRevenue':_0x4e5210,'dailyPayments':_0x115871};}['getPeriodDays'](_0x11fb3d){const _0x218041=a47_0x35d70f;switch(_0x11fb3d){case'7d':return 0x7;case'30d':return 0x1e;case _0x218041(0x106):return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a47_0x35d70f(0x19c)](_0x44fd37,_0x58ef7a){const _0x10add9=a47_0x35d70f,_0xb0d2fb=[],_0x5423fd=new Date(_0x44fd37);while(_0x5423fd<=_0x58ef7a){_0xb0d2fb[_0x10add9(0x11f)](_0x5423fd[_0x10add9(0x139)]()['split']('T')[0x0]),_0x5423fd[_0x10add9(0x10d)](_0x5423fd[_0x10add9(0x14c)]()+0x1);}return _0xb0d2fb;}}exports['ShopService']=ShopService;function a47_0x1e04(){const _0x38e0f7=['âš ï¸\x20Gateway\x20order\x20ID\x20','name','generateGatewayUrls','gatewaySettings','responseBody','toFixed','parse','desc','https://tesoft.uk','âŒ\x20Test\x20webhook\x20failed:\x20','ðŸ’°\x20Amount:\x20','ðŸ”—\x20Generated\x20URLs\x20for\x20','sourceCurrency','padStart','âœ…\x20KLYME\x20','usdtTrcWallet','ceil','./gateways/nodaService','calculateAmountAfterCommission','_count','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','test_webhook','./gateways/plisioService','ðŸ”„\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20','customerEmail','Test\x20Customer','./gateways/coinToPayService','getPayoutById','publicKey','gateway','findFirst','status','generateGatewayOrderId','/payment/success?payment_id=','KlymeService','plisioService','ðŸ“…\x20This\x20Month:\x20','USD','findUnique','webhookUrl','round','./currencyService','https://tesoft.uk/gateways/noda/webhook','error','74006Uaxwdq','updateWallets','notes','amount','rapydCustomer','90d','payout','findMany','amountIsEditable','Gateway\x20not\x20found\x20for\x20ID:\x20','Test\x20payload:','merchantPaid','setDate','wallets','convertToUSDT','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','Order\x20ID:\x20','customer','currencyService','getGatewaySettings','./gateways/klymeService','totalPaidOut','Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts','get','availableBalance','floor','nodaService','getPeriodDays','usdtPolygonWallet','payoutDelay','push','coinToPayService','qr_url','/payment/fail?payment_id=','currency','customerName','471048RxJgOy','klyme_','startsWith','count','âœ…\x20Successful\x20payments:\x20','usdcPolygonWallet','ðŸ’°\x20Available\x20Balance:\x20','../config/database','\x20\x20\x20âŒ\x20Fail:\x20','awaitingPayout','webhookLog','getWebhookLogs','shop','toLowerCase','isValidGatewayId','9usQhBw','paymentId','groupBy','ðŸ“ˆ\x20Average\x20payment:\x20','commission','toISOString','Shop\x20not\x20found','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','gatewayPaymentId','retryCount','ONCE','ðŸ“Š\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20','stringify','application/json','reduce','updatePayment','âŒ\x20Test\x20webhook\x20error:\x20','2063600Ilzmhh','â³\x20Awaiting\x20Payout:\x20','Unknown\x20error','klymeService','log','charAt','revenue','getDate','country','map','paymentGateways','getPaymentById','__importDefault','random','âœ…\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','telegram','usage','externalPaymentUrl','ðŸª™\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','createPaymentLink','https://tesoft.uk/gateway/payment.php?id=','cointopay','\x20(8digits-8digits\x20format)','HTTP\x20','4734210huVEbQ','FAILED','updatedAt','date','noda','_sum','No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.','gateways','plisio','update','ðŸ”„\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','ðŸ’³\x20Creating\x20KLYME\x20','ðŸ“Š\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','getKlymeRegionFromGatewayName','ðŸ’°\x20Found\x20','invoice_total_sum','merchantUrl','Invalid\x20KLYME\x20gateway:\x20','rapyd','COMPLETED','paidAt','getMonth','\x20\x20\x20âœ…\x20Success:\x20','getPayoutStatistics','payment','1HTCdDe','PAID','qr_code','RapydService','payments','env','now','language','$queryRaw','defineProperty','qr_code_url','getPayoutStats','PENDING','create','aggregate','getShopPayoutStats','network','shopUrl','isEligibleForPayout','âœ…\x20Shop\x20payout\x20statistics\x20calculated:','test_payment_','\x20days)','ðŸ’¸\x20Total\x20Paid\x20Out:\x20','createdAt','maxPayments','ðŸ§ª\x20Sending\x20test\x20webhook\x20to:\x20','deletePayment','âœ…\x20Shop\x20statistics\x20generated\x20successfully','settings','fullName','default','txid','usdtErcWallet','305575fDhFaJ','\x20(8digits-8digits\x20format\x20for\x20','gateway_payment_id','ðŸ‡¬ðŸ‡§\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','\x20PAID\x20payments\x20for\x20totalAmount\x20calculation','generateDateRange','thisMonth','test@example.com','message','\x20USDT','updateShopProfile','length','getPayments','gte','ShopService','5246486erCkUc','redirectUrl','11968520iztFJy','all','payment.success','true','ðŸŽ¯\x20Generated\x20unique\x20gateway\x20order_id:\x20','paid','payment_url','rapydService','BASE_URL','expiresAt','webhookLogs','Failed\x20to\x20log\x20test\x20webhook:','shopId','telegramId','getStatistics'];a47_0x1e04=function(){return _0x38e0f7;};return a47_0x1e04();}