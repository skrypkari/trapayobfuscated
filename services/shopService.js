'use strict';function a48_0x5dd3(_0x45e219,_0x547899){const _0x257f47=a48_0x257f();return a48_0x5dd3=function(_0x5dd351,_0x3a3dc1){_0x5dd351=_0x5dd351-0x74;let _0x1a0a8a=_0x257f47[_0x5dd351];return _0x1a0a8a;},a48_0x5dd3(_0x45e219,_0x547899);}const a48_0x37fe9f=a48_0x5dd3;(function(_0x575328,_0x3d3d86){const _0x1d3e71=a48_0x5dd3,_0x1e8bbf=_0x575328();while(!![]){try{const _0x3ea36f=parseInt(_0x1d3e71(0x11a))/0x1+parseInt(_0x1d3e71(0x13b))/0x2+-parseInt(_0x1d3e71(0xac))/0x3+parseInt(_0x1d3e71(0xff))/0x4+parseInt(_0x1d3e71(0xa3))/0x5*(-parseInt(_0x1d3e71(0x91))/0x6)+-parseInt(_0x1d3e71(0xe8))/0x7+-parseInt(_0x1d3e71(0x86))/0x8*(-parseInt(_0x1d3e71(0x137))/0x9);if(_0x3ea36f===_0x3d3d86)break;else _0x1e8bbf['push'](_0x1e8bbf['shift']());}catch(_0x42ec00){_0x1e8bbf['push'](_0x1e8bbf['shift']());}}}(a48_0x257f,0xb502b));var __importDefault=this&&this[a48_0x37fe9f(0x94)]||function(_0x43fcc8){return _0x43fcc8&&_0x43fcc8['__esModule']?_0x43fcc8:{'default':_0x43fcc8};};Object[a48_0x37fe9f(0x84)](exports,a48_0x37fe9f(0x7b),{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require(a48_0x37fe9f(0x77))),plisioService_1=require(a48_0x37fe9f(0x74)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a48_0x37fe9f(0xca)),klymeService_1=require(a48_0x37fe9f(0x8f)),currencyService_1=require('./currencyService'),gateway_1=require(a48_0x37fe9f(0xc9));function a48_0x257f(){const _0x38bd66=['shop','generateDateRange','ðŸ’°\x20Available\x20Balance:\x20','payment_url','qr_code','getShopProfile','notes','qr_code_url','getPeriodDays','paymentGateways','Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts','Failed\x20to\x20log\x20test\x20webhook:','getGatewaySettings','../types/gateway','./gateways/coinToPayService','REJECTED','sourceCurrency','âœ…\x20Shop\x20payout\x20statistics\x20calculated:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','get','availableBalance','â³\x20Awaiting\x20Payout:\x20','ðŸ’°\x20Amount:\x20','payoutDelay','gateway_payment_id','gatewaySettings','getPayoutById','PlisioService','expiresAt','getPayouts','application/json','name','ceil','FAILED','awaitingPayout','âœ…\x20Test\x20webhook\x20sent\x20successfully:\x20','klymeService','\x20\x20\x20âœ…\x20Success:\x20','shopId','username','usage','Invalid\x20KLYME\x20gateway:\x20','retryCount','charAt','7922551gCzyKu','âŒ\x20Test\x20webhook\x20failed:\x20','coinToPayService','text','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','getKlymeRegionFromGatewayName','telegramId','toISOString','paidAt','reduce','Test\x20Customer','create','usdtTrcWallet','generateGatewayOrderId','POST','txid','RapydService','usdtPolygonWallet','redirectUrl','amount','HTTP\x20','ONCE','generateGatewayUrls','3675136IVEZTH','env','ShopService','externalPaymentUrl','now','convertToUSDT','merchantPaid','ðŸ’°\x20Found\x20','ðŸ“Š\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20','totalPaidOut','customerEmail','getGatewayNameById','https://tesoft.uk/gateway/payment.php?id=','webhookLog','\x20(8digits-8digits\x20format)','merchantUrl','ðŸ’µ\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','groupBy','network','customer','getTime','payment','toLowerCase','ðŸ’³\x20Total\x20payments:\x20','createPayment','status','payments','167311kwHOlh','setDate','startsWith','lte','createdAt','plisio','settings','\x20USDT','ðŸ’³\x20Creating\x20KLYME\x20','findFirst','currency','rapyd','round','ðŸ“Š\x20Daily\x20revenue\x20entries:\x20','âš ï¸\x20Gateway\x20order\x20ID\x20','cointopay','default','date','EUR','USD','getDate','update','âœ…\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','usdcPolygonWallet','isEligibleForPayout','usdtErcWallet','country','deletePayment','getShopPayoutStats','11354157lTDJjm','error','shopUrl','\x20PAID\x20payments\x20for\x20totalAmount\x20calculation','1236232TSkQJn','nodaService','gateways','ðŸ“Š\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','log','parse','COMPLETED','payment.success','ðŸ”„\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20','telegram','ðŸ“…\x20This\x20Month:\x20','getPayments','paymentId','updateWallets','ðŸ”„\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','floor','toString','findUnique','PAID','ðŸ“ˆ\x20Average\x20payment:\x20','./gateways/plisioService','stringify','getPayoutStatistics','../config/database','rapydCustomer','/payment/pending?id=','testWebhook','__esModule','all','length','qr_url','ðŸ§ª\x20Sending\x20test\x20webhook\x20to:\x20','PENDING','desc','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','_count','defineProperty','isValidGatewayId','8eMyJNq','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','payout','âŒ\x20Test\x20webhook\x20error:\x20','_sum','statusCode','map','count','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','./gateways/klymeService','customerName','3838650vTvGmW','updatePayment','random','__importDefault','Test\x20payload:','\x20(8digits-8digits\x20format\x20for\x20','Order\x20ID:\x20','amountIsEditable','publicKey','updatedAt','âœ…\x20Successful\x20payments:\x20','test_payment_','Shop\x20not\x20found','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','commission','klyme_','maxPayments','calculateAmountAfterCommission','5QzMchS','noda','webhookLogs','wallets','event','createPaymentLink','true','push','aggregate','1358391sMWrJQ','split','currencyService','findMany','webhookUrl','gatewayPaymentId','revenue','rapydService','test@example.com','gateway','slice','\x20\x20\x20âŒ\x20Fail:\x20','language','ðŸ’¾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20','ðŸŽ¯\x20Generated\x20unique\x20gateway\x20order_id:\x20','30d'];a48_0x257f=function(){return _0x38bd66;};return a48_0x257f();}class ShopService{constructor(){const _0x5a9af6=a48_0x37fe9f;this['plisioService']=new plisioService_1[(_0x5a9af6(0xd7))](),this[_0x5a9af6(0xb3)]=new rapydService_1[(_0x5a9af6(0xf8))](),this[_0x5a9af6(0x13c)]=new nodaService_1['NodaService'](),this[_0x5a9af6(0xea)]=new coinToPayService_1['CoinToPayService'](),this[_0x5a9af6(0xe0)]=new klymeService_1['KlymeService']();}async[a48_0x37fe9f(0xf5)](){const _0x31a050=a48_0x37fe9f;let _0x9b1f73,_0x5a342e=0x0;const _0x5d6595=0xa;do{const _0x15a9d4=()=>{const _0x3a3b0b=a48_0x5dd3;return Math[_0x3a3b0b(0x14a)](Math[_0x3a3b0b(0x93)]()*0x5f5e100)[_0x3a3b0b(0x14b)]()['padStart'](0x8,'0');};_0x9b1f73=_0x15a9d4()+'-'+_0x15a9d4();const _0x6d04f9=await database_1[_0x31a050(0x12a)]['payment'][_0x31a050(0x123)]({'where':{'gatewayOrderId':_0x9b1f73}});if(!_0x6d04f9)break;_0x5a342e++,console[_0x31a050(0x13f)](_0x31a050(0x128)+_0x9b1f73+_0x31a050(0xec)+_0x5a342e+')');}while(_0x5a342e<_0x5d6595);if(_0x5a342e>=_0x5d6595)throw new Error(_0x31a050(0xc6));return _0x9b1f73;}[a48_0x37fe9f(0xfe)](_0x312d61,_0x3092d0,_0x60515e,_0x5e70ba,_0x1e6818){const _0x503d3c=a48_0x37fe9f;if(_0x5e70ba&&_0x1e6818)return{'finalSuccessUrl':_0x5e70ba,'finalFailUrl':_0x1e6818};let _0x1f4c53,_0x298cb4;return _0x312d61===_0x503d3c(0xa4)||_0x312d61[_0x503d3c(0x11c)](_0x503d3c(0xa0))||_0x312d61===_0x503d3c(0x129)?_0x1f4c53=_0x5e70ba||_0x60515e+_0x503d3c(0x79)+_0x3092d0:_0x1f4c53=_0x5e70ba||_0x60515e+'/payment/success?id='+_0x3092d0,_0x298cb4=_0x1e6818||_0x60515e+'/payment/failed?id='+_0x3092d0,console[_0x503d3c(0x13f)]('ðŸ”—\x20Generated\x20URLs\x20for\x20'+_0x312d61+':'),console['log'](_0x503d3c(0xe1)+_0x1f4c53),console[_0x503d3c(0x13f)](_0x503d3c(0xb7)+_0x298cb4),{'finalSuccessUrl':_0x1f4c53,'finalFailUrl':_0x298cb4};}['getGatewaySettings'](_0x2cad7a,_0x140afe){const _0x100428=a48_0x37fe9f,_0x375003=_0x2cad7a['gatewaySettings']?JSON['parse'](_0x2cad7a[_0x100428(0xd5)]):null,_0x47137e=_0x140afe[_0x100428(0xe7)](0x0)['toUpperCase']()+_0x140afe[_0x100428(0xb6)](0x1)[_0x100428(0x115)]();if(_0x375003&&_0x375003[_0x47137e])return{'commission':_0x375003[_0x47137e]['commission'],'payoutDelay':_0x375003[_0x47137e]['payoutDelay']};return{'commission':0x0,'payoutDelay':0x0};}[a48_0x37fe9f(0x132)](_0x376dbd,_0x30129a){const _0x4b726c=a48_0x37fe9f;if(_0x376dbd[_0x4b726c(0x118)]!==_0x4b726c(0x14d)||_0x376dbd[_0x4b726c(0x105)]||!_0x376dbd[_0x4b726c(0xf0)])return![];const _0x494439=_0x30129a[_0x4b726c(0xd3)]*0x18*0x3c*0x3c*0x3e8,_0x1db653=new Date(_0x376dbd['paidAt'][_0x4b726c(0x113)]()+_0x494439);return new Date()>_0x1db653;}[a48_0x37fe9f(0xa2)](_0x30f82f,_0x32b1dd){return _0x30f82f*(0x1-_0x32b1dd/0x64);}async[a48_0x37fe9f(0xc1)](_0x3f80d7){const _0x2a890a=a48_0x37fe9f,_0x38d60c=await database_1['default'][_0x2a890a(0xbc)][_0x2a890a(0x14c)]({'where':{'id':_0x3f80d7},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x38d60c)throw new Error(_0x2a890a(0x9d));return{'id':_0x38d60c['id'],'fullName':_0x38d60c['name'],'username':_0x38d60c[_0x2a890a(0xe3)],'telegramId':_0x38d60c[_0x2a890a(0x144)],'merchantUrl':_0x38d60c[_0x2a890a(0x139)],'gateways':_0x38d60c['paymentGateways']?JSON[_0x2a890a(0x140)](_0x38d60c[_0x2a890a(0xc5)]):null,'gatewaySettings':_0x38d60c['gatewaySettings']?JSON[_0x2a890a(0x140)](_0x38d60c[_0x2a890a(0xd5)]):null,'publicKey':_0x38d60c[_0x2a890a(0x99)],'wallets':{'usdtPolygonWallet':_0x38d60c['usdtPolygonWallet'],'usdtTrcWallet':_0x38d60c[_0x2a890a(0xf4)],'usdtErcWallet':_0x38d60c[_0x2a890a(0x133)],'usdcPolygonWallet':_0x38d60c['usdcPolygonWallet']},'status':_0x38d60c['status'],'createdAt':_0x38d60c[_0x2a890a(0x11e)]};}async['updateShopProfile'](_0x5ac8b1,_0x2f5102){const _0x3e4012=a48_0x37fe9f,_0x1dddf1={..._0x2f5102};_0x2f5102['fullName']&&(_0x1dddf1[_0x3e4012(0xdb)]=_0x2f5102['fullName'],delete _0x1dddf1['fullName']);_0x2f5102[_0x3e4012(0xee)]&&(_0x1dddf1[_0x3e4012(0x144)]=_0x2f5102[_0x3e4012(0xee)],delete _0x1dddf1['telegramId']);_0x2f5102['merchantUrl']&&(_0x1dddf1['shopUrl']=_0x2f5102[_0x3e4012(0x10e)],delete _0x1dddf1[_0x3e4012(0x10e)]);_0x2f5102['gateways']&&(_0x1dddf1['paymentGateways']=JSON['stringify'](_0x2f5102['gateways']),delete _0x1dddf1[_0x3e4012(0x13d)]);_0x2f5102[_0x3e4012(0xd5)]&&(_0x1dddf1['gatewaySettings']=JSON['stringify'](_0x2f5102[_0x3e4012(0xd5)]),delete _0x1dddf1[_0x3e4012(0xd5)]);_0x2f5102['wallets']&&(_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0xf9)]!==undefined&&(_0x1dddf1['usdtPolygonWallet']=_0x2f5102['wallets']['usdtPolygonWallet']||null),_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0xf4)]!==undefined&&(_0x1dddf1[_0x3e4012(0xf4)]=_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0xf4)]||null),_0x2f5102[_0x3e4012(0xa6)]['usdtErcWallet']!==undefined&&(_0x1dddf1[_0x3e4012(0x133)]=_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0x133)]||null),_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0x131)]!==undefined&&(_0x1dddf1[_0x3e4012(0x131)]=_0x2f5102[_0x3e4012(0xa6)][_0x3e4012(0x131)]||null),delete _0x1dddf1[_0x3e4012(0xa6)]);const _0x120a2a=await database_1['default']['shop'][_0x3e4012(0x12f)]({'where':{'id':_0x5ac8b1},'data':_0x1dddf1,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x120a2a['id'],'fullName':_0x120a2a[_0x3e4012(0xdb)],'username':_0x120a2a[_0x3e4012(0xe3)],'telegramId':_0x120a2a['telegram'],'merchantUrl':_0x120a2a[_0x3e4012(0x139)],'gateways':_0x120a2a[_0x3e4012(0xc5)]?JSON['parse'](_0x120a2a[_0x3e4012(0xc5)]):null,'gatewaySettings':_0x120a2a[_0x3e4012(0xd5)]?JSON['parse'](_0x120a2a[_0x3e4012(0xd5)]):null,'publicKey':_0x120a2a[_0x3e4012(0x99)],'wallets':{'usdtPolygonWallet':_0x120a2a[_0x3e4012(0xf9)],'usdtTrcWallet':_0x120a2a['usdtTrcWallet'],'usdtErcWallet':_0x120a2a[_0x3e4012(0x133)],'usdcPolygonWallet':_0x120a2a['usdcPolygonWallet']},'status':_0x120a2a['status'],'createdAt':_0x120a2a[_0x3e4012(0x11e)]};}async[a48_0x37fe9f(0x148)](_0x56f370,_0x2959d9){const _0x2af91f=a48_0x37fe9f,_0x3ed2a4={};_0x2959d9[_0x2af91f(0xf9)]!==undefined&&(_0x3ed2a4[_0x2af91f(0xf9)]=_0x2959d9[_0x2af91f(0xf9)]||null),_0x2959d9[_0x2af91f(0xf4)]!==undefined&&(_0x3ed2a4[_0x2af91f(0xf4)]=_0x2959d9['usdtTrcWallet']||null),_0x2959d9[_0x2af91f(0x133)]!==undefined&&(_0x3ed2a4[_0x2af91f(0x133)]=_0x2959d9[_0x2af91f(0x133)]||null),_0x2959d9[_0x2af91f(0x131)]!==undefined&&(_0x3ed2a4['usdcPolygonWallet']=_0x2959d9[_0x2af91f(0x131)]||null),await database_1[_0x2af91f(0x12a)][_0x2af91f(0xbc)]['update']({'where':{'id':_0x56f370},'data':_0x3ed2a4});}async[a48_0x37fe9f(0x7a)](_0x31f54a){const _0x5162a5=a48_0x37fe9f,_0x14fb11=await database_1['default'][_0x5162a5(0xbc)][_0x5162a5(0x14c)]({'where':{'id':_0x31f54a},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x14fb11)throw new Error(_0x5162a5(0x9d));const _0x228ba3=_0x14fb11[_0x5162a5(0x120)]?.[_0x5162a5(0xb0)];if(!_0x228ba3)throw new Error('No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.');const _0x47d0b1=await this['generateGatewayOrderId'](),_0x5e14a7={'event':_0x5162a5(0x142),'payment':{'id':_0x5162a5(0x9c)+Date[_0x5162a5(0x103)](),'order_id':null,'gateway_order_id':_0x47d0b1,'gateway':_0x5162a5(0x11f),'amount':0x64,'currency':'USD','status':'paid','customer_email':_0x5162a5(0xb4),'customer_name':_0x5162a5(0xf2),'created_at':new Date()['toISOString'](),'updated_at':new Date()[_0x5162a5(0xef)]()},'test':!![],'shop':{'id':_0x14fb11['id'],'name':_0x14fb11[_0x5162a5(0xdb)]},'timestamp':new Date()['toISOString']()},_0x23c7b7=Date[_0x5162a5(0x103)]();let _0xb29c92=0x0,_0x1fc64a=![],_0x45f93d;try{console[_0x5162a5(0x13f)](_0x5162a5(0x7f)+_0x228ba3),console[_0x5162a5(0x13f)](_0x5162a5(0x95),JSON[_0x5162a5(0x75)](_0x5e14a7,null,0x2));const _0x1e59fe=await fetch(_0x228ba3,{'method':_0x5162a5(0xf6),'headers':{'Content-Type':_0x5162a5(0xda),'User-Agent':_0x5162a5(0xce),'X-Webhook-Test':_0x5162a5(0xa9)},'body':JSON[_0x5162a5(0x75)](_0x5e14a7)});_0xb29c92=_0x1e59fe[_0x5162a5(0x118)],_0x1fc64a=_0x1e59fe['ok'];if(!_0x1e59fe['ok']){const _0xe09eb4=await _0x1e59fe[_0x5162a5(0xeb)]();_0x45f93d=_0x5162a5(0xfc)+_0x1e59fe['status']+':\x20'+_0xe09eb4,console[_0x5162a5(0x138)](_0x5162a5(0xe9)+_0x45f93d);}else console['log'](_0x5162a5(0xdf)+_0x1e59fe[_0x5162a5(0x118)]);}catch(_0x7ba898){_0x45f93d=_0x7ba898 instanceof Error?_0x7ba898['message']:'Unknown\x20error',console[_0x5162a5(0x138)](_0x5162a5(0x89)+_0x45f93d);}const _0x105946=Date[_0x5162a5(0x103)]()-_0x23c7b7;try{await database_1[_0x5162a5(0x12a)][_0x5162a5(0x10c)][_0x5162a5(0xf3)]({'data':{'paymentId':'test_webhook','shopId':_0x14fb11['id'],'event':'test_webhook','statusCode':_0xb29c92,'responseBody':JSON['stringify']({'success':_0x1fc64a,'error':_0x45f93d,'responseTime':_0x105946,'testPayload':_0x5e14a7})}});}catch(_0x269bbb){console[_0x5162a5(0x138)](_0x5162a5(0xc7),_0x269bbb);}return{'webhookUrl':_0x228ba3,'statusCode':_0xb29c92,'responseTime':_0x105946,'success':_0x1fc64a,'error':_0x45f93d};}async[a48_0x37fe9f(0x117)](_0x36f63e){const _0x5dc5bc=a48_0x37fe9f;let _0x260025;if((0x0,gateway_1['isValidGatewayId'])(_0x36f63e[_0x5dc5bc(0xb5)])){const _0x5325df=(0x0,gateway_1[_0x5dc5bc(0x10a)])(_0x36f63e['gateway']);if(!_0x5325df)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x36f63e[_0x5dc5bc(0xb5)]);_0x260025=_0x5325df;}else _0x260025=_0x36f63e[_0x5dc5bc(0xb5)][_0x5dc5bc(0x115)]();console[_0x5dc5bc(0x13f)](_0x5dc5bc(0x143)+_0x260025);const _0xc230e=await this['generateGatewayOrderId']();console[_0x5dc5bc(0x13f)](_0x5dc5bc(0xba)+_0xc230e+_0x5dc5bc(0x96)+_0x260025+')');const _0x2eae4c=await database_1['default'][_0x5dc5bc(0xbc)]['findUnique']({'where':{'id':_0x36f63e[_0x5dc5bc(0xe2)]},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x2eae4c)throw new Error(_0x5dc5bc(0x9d));const _0x432dc0=this['getGatewaySettings'](_0x2eae4c,_0x260025),_0x5e5118=process[_0x5dc5bc(0x100)]['BASE_URL']||'https://tesoft.uk',{finalSuccessUrl:_0x25c983,finalFailUrl:_0x19dbd2}=this['generateGatewayUrls'](_0x260025,_0xc230e,_0x5e5118,_0x36f63e[_0x5dc5bc(0xfa)],undefined),_0x3d63aa=await database_1[_0x5dc5bc(0x12a)][_0x5dc5bc(0x114)][_0x5dc5bc(0xf3)]({'data':{'shopId':_0x36f63e[_0x5dc5bc(0xe2)],'gateway':_0x260025,'amount':_0x36f63e[_0x5dc5bc(0xfb)],'currency':_0x36f63e[_0x5dc5bc(0x124)]||'USD','sourceCurrency':_0x36f63e['sourceCurrency']||null,'usage':_0x36f63e[_0x5dc5bc(0xe4)]||_0x5dc5bc(0xfd),'expiresAt':_0x36f63e[_0x5dc5bc(0xd8)],'successUrl':_0x25c983,'failUrl':_0x19dbd2,'status':_0x5dc5bc(0x80),'orderId':null,'gatewayOrderId':_0xc230e,'customerEmail':_0x36f63e['customerEmail']||null,'customerName':_0x36f63e[_0x5dc5bc(0x90)]||null,'country':_0x36f63e[_0x5dc5bc(0x134)]||null,'language':_0x36f63e['language']||null,'amountIsEditable':_0x36f63e[_0x5dc5bc(0x98)]||null,'maxPayments':_0x36f63e[_0x5dc5bc(0xa1)]||null,'rapydCustomer':_0x36f63e[_0x5dc5bc(0x112)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console[_0x5dc5bc(0x13f)](_0x5dc5bc(0xb9)+_0xc230e+_0x5dc5bc(0x10d));let _0x22ae0a;try{if(_0x260025===_0x5dc5bc(0x11f)){let _0x2e934e,_0x2befce,_0x10f768;_0x36f63e[_0x5dc5bc(0xcc)]?(_0x2e934e=_0x36f63e[_0x5dc5bc(0xcc)],_0x2befce=_0x36f63e['currency']||_0x5dc5bc(0x12d),_0x10f768=![]):(_0x2e934e='USD',_0x2befce=_0x36f63e[_0x5dc5bc(0x124)]||_0x5dc5bc(0x12d),_0x10f768=!![]);const _0xaad506=await this['plisioService'][_0x5dc5bc(0x117)]({'paymentId':_0x3d63aa['id'],'orderId':_0xc230e,'amount':_0x36f63e[_0x5dc5bc(0xfb)],'currency':_0x2e934e,'productName':_0x5dc5bc(0x97)+_0xc230e,'description':_0x5dc5bc(0x97)+_0xc230e,'successUrl':_0x25c983,'failUrl':_0x19dbd2,'customerEmail':_0x36f63e[_0x5dc5bc(0x109)],'customerName':_0x36f63e['customerName'],'isSourceCurrency':_0x10f768});_0x22ae0a=_0xaad506[_0x5dc5bc(0xbf)],await database_1[_0x5dc5bc(0x12a)][_0x5dc5bc(0x114)][_0x5dc5bc(0x12f)]({'where':{'id':_0x3d63aa['id']},'data':{'externalPaymentUrl':_0x22ae0a,'gatewayPaymentId':_0xaad506['gateway_payment_id'],'invoiceTotalSum':Number(_0xaad506['invoice_total_sum']),'qrCode':_0xaad506[_0x5dc5bc(0xc0)],'qrUrl':_0xaad506[_0x5dc5bc(0x7e)]}}),_0x3d63aa['externalPaymentUrl']=_0x22ae0a,_0x3d63aa[_0x5dc5bc(0xb1)]=_0xaad506[_0x5dc5bc(0xd4)];}else{if(_0x260025===_0x5dc5bc(0x125)){const _0x4b268e='GB';console['log']('ðŸ‡¬ðŸ‡§\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment');const _0x360856=await this[_0x5dc5bc(0xb3)][_0x5dc5bc(0xa8)]({'paymentId':_0x3d63aa['id'],'orderId':_0xc230e,'orderName':'Order\x20ID:\x20'+_0xc230e,'amount':_0x36f63e['amount'],'currency':_0x36f63e[_0x5dc5bc(0x124)]||_0x5dc5bc(0x12d),'country':_0x4b268e,'usage':_0x36f63e[_0x5dc5bc(0xe4)]||_0x5dc5bc(0xfd),'maxPayments':_0x36f63e[_0x5dc5bc(0xa1)],'successUrl':_0x25c983,'failUrl':_0x19dbd2});_0x22ae0a=_0x360856['payment_url'],await database_1[_0x5dc5bc(0x12a)]['payment'][_0x5dc5bc(0x12f)]({'where':{'id':_0x3d63aa['id']},'data':{'externalPaymentUrl':_0x22ae0a,'gatewayPaymentId':_0x360856['gateway_payment_id'],'country':_0x4b268e}}),_0x3d63aa[_0x5dc5bc(0x102)]=_0x22ae0a,_0x3d63aa[_0x5dc5bc(0xb1)]=_0x360856[_0x5dc5bc(0xd4)];}else{if(_0x260025===_0x5dc5bc(0xa4)){console[_0x5dc5bc(0x13f)](_0x5dc5bc(0x149)+_0xc230e+'\x20(8digits-8digits\x20format)');const _0x1ab4ea=await this['nodaService'][_0x5dc5bc(0xa8)]({'paymentId':_0x3d63aa['id'],'orderId':_0xc230e,'name':'Order\x20ID:\x20'+_0xc230e,'paymentDescription':_0x5dc5bc(0x97)+_0xc230e,'amount':_0x36f63e[_0x5dc5bc(0xfb)],'currency':_0x36f63e[_0x5dc5bc(0x124)]||_0x5dc5bc(0x12d),'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x25c983,'expiryDate':_0x36f63e[_0x5dc5bc(0xd8)]?.['toISOString']()});_0x22ae0a=_0x1ab4ea['payment_url'],await database_1['default'][_0x5dc5bc(0x114)]['update']({'where':{'id':_0x3d63aa['id']},'data':{'externalPaymentUrl':_0x22ae0a,'gatewayPaymentId':_0x1ab4ea[_0x5dc5bc(0xd4)],'qrUrl':_0x1ab4ea[_0x5dc5bc(0xc3)]}}),_0x3d63aa[_0x5dc5bc(0x102)]=_0x22ae0a,_0x3d63aa['gatewayPaymentId']=_0x1ab4ea[_0x5dc5bc(0xd4)],console[_0x5dc5bc(0x13f)]('âœ…\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0xc230e);}else{if(_0x260025===_0x5dc5bc(0x129)){console[_0x5dc5bc(0x13f)]('ðŸª™\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20'+_0xc230e+_0x5dc5bc(0x10d)),console[_0x5dc5bc(0x13f)](_0x5dc5bc(0xd2)+_0x36f63e[_0x5dc5bc(0xfb)]+_0x5dc5bc(0x9e));const _0x5b3f20=await this['coinToPayService'][_0x5dc5bc(0xa8)]({'paymentId':_0x3d63aa['id'],'orderId':_0xc230e,'amount':_0x36f63e[_0x5dc5bc(0xfb)]});_0x22ae0a=_0x5b3f20[_0x5dc5bc(0xbf)],await database_1[_0x5dc5bc(0x12a)][_0x5dc5bc(0x114)][_0x5dc5bc(0x12f)]({'where':{'id':_0x3d63aa['id']},'data':{'externalPaymentUrl':_0x22ae0a,'gatewayPaymentId':_0x5b3f20[_0x5dc5bc(0xd4)],'currency':_0x5dc5bc(0x12c)}}),_0x3d63aa[_0x5dc5bc(0x102)]=_0x22ae0a,_0x3d63aa['gatewayPaymentId']=_0x5b3f20[_0x5dc5bc(0xd4)],console['log'](_0x5dc5bc(0x130)+_0xc230e);}else{if(_0x260025['startsWith'](_0x5dc5bc(0xa0))){const _0x298e2c=(0x0,gateway_1[_0x5dc5bc(0xed)])(_0x260025);if(!_0x298e2c)throw new Error(_0x5dc5bc(0xe5)+_0x260025);if(_0x298e2c!=='EU'&&_0x298e2c!=='GB')throw new Error(_0x5dc5bc(0x8e)+_0x298e2c);console[_0x5dc5bc(0x13f)](_0x5dc5bc(0x122)+_0x298e2c+_0x5dc5bc(0x82)+_0xc230e+_0x5dc5bc(0x10d)),console['log'](_0x5dc5bc(0xd2)+_0x36f63e[_0x5dc5bc(0xfb)]+'\x20'+(_0x36f63e[_0x5dc5bc(0x124)]||_0x5dc5bc(0x12d)));const _0x5983e7=await this['klymeService']['createPaymentLink']({'paymentId':_0x3d63aa['id'],'orderId':_0xc230e,'amount':_0x36f63e[_0x5dc5bc(0xfb)],'currency':_0x36f63e[_0x5dc5bc(0x124)]||_0x5dc5bc(0x12d),'region':_0x298e2c,'redirectUrl':_0x25c983});_0x22ae0a=_0x5983e7['payment_url'],await database_1['default'][_0x5dc5bc(0x114)][_0x5dc5bc(0x12f)]({'where':{'id':_0x3d63aa['id']},'data':{'externalPaymentUrl':_0x22ae0a,'gatewayPaymentId':_0x5983e7[_0x5dc5bc(0xd4)]}}),_0x3d63aa[_0x5dc5bc(0x102)]=_0x22ae0a,_0x3d63aa[_0x5dc5bc(0xb1)]=_0x5983e7['gateway_payment_id'],console[_0x5dc5bc(0x13f)]('âœ…\x20KLYME\x20'+_0x298e2c+_0x5dc5bc(0x87)+_0xc230e);}}}}}}catch(_0x501abb){await database_1['default'][_0x5dc5bc(0x114)][_0x5dc5bc(0x12f)]({'where':{'id':_0x3d63aa['id']},'data':{'status':_0x5dc5bc(0xdd)}}),console[_0x5dc5bc(0x138)]('Gateway\x20error\x20during\x20shop\x20payment\x20creation:',_0x501abb);}const _0x4c0a66=_0x5dc5bc(0x10b)+_0x3d63aa['id'];return{'id':_0x3d63aa['id'],'shopId':_0x3d63aa[_0x5dc5bc(0xe2)],'gateway':_0x3d63aa['gateway'],'amount':_0x3d63aa[_0x5dc5bc(0xfb)],'currency':_0x3d63aa[_0x5dc5bc(0x124)],'sourceCurrency':_0x3d63aa[_0x5dc5bc(0xcc)],'usage':_0x3d63aa[_0x5dc5bc(0xe4)],'expiresAt':_0x3d63aa[_0x5dc5bc(0xd8)],'redirectUrl':_0x4c0a66,'status':_0x3d63aa['status'],'externalPaymentUrl':_0x22ae0a,'customerEmail':_0x3d63aa[_0x5dc5bc(0x109)],'customerName':_0x3d63aa[_0x5dc5bc(0x90)],'country':_0x3d63aa[_0x5dc5bc(0x134)],'language':_0x3d63aa['language'],'amountIsEditable':_0x3d63aa[_0x5dc5bc(0x98)],'maxPayments':_0x3d63aa['maxPayments'],'customer':_0x3d63aa[_0x5dc5bc(0x78)],'createdAt':_0x3d63aa[_0x5dc5bc(0x11e)],'updatedAt':_0x3d63aa[_0x5dc5bc(0x9a)],'shop':_0x3d63aa[_0x5dc5bc(0xbc)]};}async[a48_0x37fe9f(0x146)](_0x4dc1aa,_0x334043){const _0x47278b=a48_0x37fe9f,{page:_0x162487,limit:_0x386950,status:_0xb6d6be,gateway:_0x349a4e}=_0x334043,_0x1bd2e9=(_0x162487-0x1)*_0x386950,_0x570c0f={'shopId':_0x4dc1aa};_0xb6d6be&&(_0x570c0f['status']=_0xb6d6be);if(_0x349a4e){if((0x0,gateway_1[_0x47278b(0x85)])(_0x349a4e)){const _0x523982=(0x0,gateway_1[_0x47278b(0x10a)])(_0x349a4e);_0x523982&&(_0x570c0f[_0x47278b(0xb5)]=_0x523982);}else _0x570c0f[_0x47278b(0xb5)]=_0x349a4e[_0x47278b(0x115)]();}const [_0x56693e,_0x395583]=await Promise['all']([database_1[_0x47278b(0x12a)][_0x47278b(0x114)]['findMany']({'where':_0x570c0f,'skip':_0x1bd2e9,'take':_0x386950,'orderBy':{'createdAt':_0x47278b(0x81)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1[_0x47278b(0x12a)][_0x47278b(0x114)][_0x47278b(0x8d)]({'where':_0x570c0f})]);return{'payments':_0x56693e['map'](_0x1a4f79=>{const _0x1c8ce0=_0x47278b,_0x39a465=_0x1c8ce0(0x10b)+_0x1a4f79['id'];return{'id':_0x1a4f79['id'],'shopId':_0x1a4f79[_0x1c8ce0(0xe2)],'gateway':_0x1a4f79['gateway'],'amount':_0x1a4f79[_0x1c8ce0(0xfb)],'currency':_0x1a4f79['currency'],'sourceCurrency':_0x1a4f79['sourceCurrency'],'usage':_0x1a4f79[_0x1c8ce0(0xe4)],'expiresAt':_0x1a4f79[_0x1c8ce0(0xd8)],'redirectUrl':_0x39a465,'status':_0x1a4f79[_0x1c8ce0(0x118)],'externalPaymentUrl':_0x1a4f79[_0x1c8ce0(0x102)],'customerEmail':_0x1a4f79[_0x1c8ce0(0x109)],'customerName':_0x1a4f79[_0x1c8ce0(0x90)],'country':_0x1a4f79[_0x1c8ce0(0x134)],'language':_0x1a4f79[_0x1c8ce0(0xb8)],'amountIsEditable':_0x1a4f79[_0x1c8ce0(0x98)],'maxPayments':_0x1a4f79[_0x1c8ce0(0xa1)],'customer':_0x1a4f79['rapydCustomer'],'createdAt':_0x1a4f79[_0x1c8ce0(0x11e)],'updatedAt':_0x1a4f79[_0x1c8ce0(0x9a)],'shop':_0x1a4f79[_0x1c8ce0(0xbc)]};}),'pagination':{'page':_0x162487,'limit':_0x386950,'total':_0x395583,'totalPages':Math[_0x47278b(0xdc)](_0x395583/_0x386950)}};}async['getPaymentById'](_0x5a738f,_0x55b412){const _0x1a21ce=a48_0x37fe9f,_0x134015=await database_1['default'][_0x1a21ce(0x114)][_0x1a21ce(0x123)]({'where':{'id':_0x55b412,'shopId':_0x5a738f},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x1a21ce(0x81)},'take':0xa}}});if(!_0x134015)return null;const _0x284e4a='https://tesoft.uk/gateway/payment.php?id='+_0x134015['id'];return{'id':_0x134015['id'],'shopId':_0x134015[_0x1a21ce(0xe2)],'gateway':_0x134015[_0x1a21ce(0xb5)],'amount':_0x134015[_0x1a21ce(0xfb)],'currency':_0x134015[_0x1a21ce(0x124)],'sourceCurrency':_0x134015[_0x1a21ce(0xcc)],'usage':_0x134015[_0x1a21ce(0xe4)],'expiresAt':_0x134015[_0x1a21ce(0xd8)],'redirectUrl':_0x284e4a,'status':_0x134015[_0x1a21ce(0x118)],'externalPaymentUrl':_0x134015[_0x1a21ce(0x102)],'customerEmail':_0x134015[_0x1a21ce(0x109)],'customerName':_0x134015[_0x1a21ce(0x90)],'country':_0x134015[_0x1a21ce(0x134)],'language':_0x134015[_0x1a21ce(0xb8)],'amountIsEditable':_0x134015[_0x1a21ce(0x98)],'maxPayments':_0x134015[_0x1a21ce(0xa1)],'customer':_0x134015[_0x1a21ce(0x78)],'createdAt':_0x134015[_0x1a21ce(0x11e)],'updatedAt':_0x134015[_0x1a21ce(0x9a)],'shop':_0x134015[_0x1a21ce(0xbc)],'webhookLogs':_0x134015[_0x1a21ce(0xa5)]};}async[a48_0x37fe9f(0x92)](_0x39c7b5,_0x454a07,_0x4cd2b0){const _0x2f6f2a=a48_0x37fe9f,_0x174f2c={..._0x4cd2b0};if(_0x4cd2b0[_0x2f6f2a(0xb5)]){if((0x0,gateway_1[_0x2f6f2a(0x85)])(_0x4cd2b0['gateway'])){const _0x44d61d=(0x0,gateway_1[_0x2f6f2a(0x10a)])(_0x4cd2b0[_0x2f6f2a(0xb5)]);_0x44d61d&&(_0x174f2c[_0x2f6f2a(0xb5)]=_0x44d61d);}else _0x174f2c[_0x2f6f2a(0xb5)]=_0x4cd2b0['gateway'][_0x2f6f2a(0x115)]();}const _0x517efe=await database_1[_0x2f6f2a(0x12a)][_0x2f6f2a(0x114)]['update']({'where':{'id':_0x454a07,'shopId':_0x39c7b5},'data':_0x174f2c,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x5f526d='https://tesoft.uk/gateway/payment.php?id='+_0x517efe['id'];return{'id':_0x517efe['id'],'shopId':_0x517efe[_0x2f6f2a(0xe2)],'gateway':_0x517efe[_0x2f6f2a(0xb5)],'amount':_0x517efe[_0x2f6f2a(0xfb)],'currency':_0x517efe[_0x2f6f2a(0x124)],'sourceCurrency':_0x517efe[_0x2f6f2a(0xcc)],'usage':_0x517efe['usage'],'expiresAt':_0x517efe[_0x2f6f2a(0xd8)],'redirectUrl':_0x5f526d,'status':_0x517efe[_0x2f6f2a(0x118)],'externalPaymentUrl':_0x517efe[_0x2f6f2a(0x102)],'customerEmail':_0x517efe[_0x2f6f2a(0x109)],'customerName':_0x517efe['customerName'],'country':_0x517efe[_0x2f6f2a(0x134)],'language':_0x517efe['language'],'amountIsEditable':_0x517efe['amountIsEditable'],'maxPayments':_0x517efe[_0x2f6f2a(0xa1)],'customer':_0x517efe[_0x2f6f2a(0x78)],'createdAt':_0x517efe['createdAt'],'updatedAt':_0x517efe[_0x2f6f2a(0x9a)],'shop':_0x517efe[_0x2f6f2a(0xbc)]};}async[a48_0x37fe9f(0x135)](_0x39e1de,_0x53c89c){const _0x2ccf47=a48_0x37fe9f;await database_1[_0x2ccf47(0x12a)][_0x2ccf47(0x114)]['delete']({'where':{'id':_0x53c89c,'shopId':_0x39e1de}});}async[a48_0x37fe9f(0xd9)](_0x2df30c,_0x6a8bb){const _0x469d43=a48_0x37fe9f,{page:_0xff3188,limit:_0xf34f72,status:_0x5308a5,method:_0x3f7c40,dateFrom:_0x4c25c6,dateTo:_0x266cf9}=_0x6a8bb,_0x28eeb2=(_0xff3188-0x1)*_0xf34f72,_0x4acae5={'shopId':_0x2df30c};_0x5308a5&&(_0x4acae5[_0x469d43(0x118)]=_0x5308a5);_0x3f7c40&&(_0x4acae5[_0x469d43(0x111)]=_0x3f7c40);(_0x4c25c6||_0x266cf9)&&(_0x4acae5['createdAt']={},_0x4c25c6&&(_0x4acae5[_0x469d43(0x11e)]['gte']=new Date(_0x4c25c6)),_0x266cf9&&(_0x4acae5[_0x469d43(0x11e)][_0x469d43(0x11d)]=new Date(_0x266cf9)));const [_0xec40b1,_0x47bc6d]=await Promise['all']([database_1['default'][_0x469d43(0x88)][_0x469d43(0xaf)]({'where':_0x4acae5,'skip':_0x28eeb2,'take':_0xf34f72,'orderBy':{'createdAt':_0x469d43(0x81)}}),database_1[_0x469d43(0x12a)][_0x469d43(0x88)][_0x469d43(0x8d)]({'where':_0x4acae5})]);return{'payouts':_0xec40b1[_0x469d43(0x8c)](_0x69f4c3=>({'id':_0x69f4c3['id'],'amount':_0x69f4c3[_0x469d43(0xfb)],'network':_0x69f4c3[_0x469d43(0x111)],'status':_0x69f4c3[_0x469d43(0x118)],'txid':_0x69f4c3[_0x469d43(0xf7)],'notes':_0x69f4c3[_0x469d43(0xc2)],'createdAt':_0x69f4c3[_0x469d43(0x11e)],'paidAt':_0x69f4c3[_0x469d43(0xf0)]})),'pagination':{'page':_0xff3188,'limit':_0xf34f72,'total':_0x47bc6d,'totalPages':Math[_0x469d43(0xdc)](_0x47bc6d/_0xf34f72)}};}async[a48_0x37fe9f(0xd6)](_0x1f330e,_0x56013c){const _0xbf89e=a48_0x37fe9f,_0x1ebe97=await database_1[_0xbf89e(0x12a)][_0xbf89e(0x88)]['findFirst']({'where':{'id':_0x56013c,'shopId':_0x1f330e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1ebe97)return null;return{'id':_0x1ebe97['id'],'shopId':_0x1ebe97[_0xbf89e(0xe2)],'amount':_0x1ebe97[_0xbf89e(0xfb)],'method':_0x1ebe97['network'],'status':_0x1ebe97[_0xbf89e(0x118)],'txid':_0x1ebe97[_0xbf89e(0xf7)],'createdAt':_0x1ebe97[_0xbf89e(0x11e)],'paidAt':_0x1ebe97[_0xbf89e(0xf0)],'shop':_0x1ebe97[_0xbf89e(0xbc)]};}async[a48_0x37fe9f(0x76)](_0x5c476c,_0x401eaf){const _0x5d5d11=a48_0x37fe9f,_0x4b22bc=this[_0x5d5d11(0xc4)](_0x401eaf),_0x2c9b91=new Date();_0x2c9b91['setDate'](_0x2c9b91['getDate']()-_0x4b22bc);const _0x54f4d8={'shopId':_0x5c476c,'createdAt':{'gte':_0x2c9b91}},[_0x2466aa,_0x1df5cf,_0x29bc94,_0x1818a1,_0x155b64,_0x1d7d6f,_0x45c838,_0x6484f4]=await Promise[_0x5d5d11(0x7c)]([database_1[_0x5d5d11(0x12a)]['payout'][_0x5d5d11(0x8d)]({'where':_0x54f4d8}),database_1['default']['payout'][_0x5d5d11(0x8d)]({'where':{..._0x54f4d8,'status':_0x5d5d11(0x141)}}),database_1[_0x5d5d11(0x12a)]['payout'][_0x5d5d11(0x8d)]({'where':{..._0x54f4d8,'status':'PENDING'}}),database_1[_0x5d5d11(0x12a)][_0x5d5d11(0x88)][_0x5d5d11(0x8d)]({'where':{..._0x54f4d8,'status':_0x5d5d11(0xcb)}}),database_1['default'][_0x5d5d11(0x88)]['aggregate']({'where':_0x54f4d8,'_sum':{'amount':!![]}}),database_1[_0x5d5d11(0x12a)][_0x5d5d11(0x88)]['groupBy']({'by':['status'],'where':_0x54f4d8,'_count':{'status':!![]}}),database_1['default']['payout'][_0x5d5d11(0x110)]({'by':['network'],'where':_0x54f4d8,'_count':{'network':!![]}}),database_1[_0x5d5d11(0x12a)][_0x5d5d11(0x88)][_0x5d5d11(0xaf)]({'where':{'shopId':_0x5c476c},'take':0xa,'orderBy':{'createdAt':_0x5d5d11(0x81)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x311c77=await database_1[_0x5d5d11(0x12a)][_0x5d5d11(0x88)][_0x5d5d11(0xab)]({'where':{..._0x54f4d8,'status':_0x5d5d11(0x141)},'_sum':{'amount':!![]}}),_0xae2432=await database_1[_0x5d5d11(0x12a)][_0x5d5d11(0x88)]['aggregate']({'where':{..._0x54f4d8,'status':_0x5d5d11(0x80)},'_sum':{'amount':!![]}});return{'totalPayouts':_0x2466aa,'completedPayouts':_0x1df5cf,'pendingPayouts':_0x29bc94,'rejectedPayouts':_0x1818a1,'totalAmount':_0x155b64['_sum'][_0x5d5d11(0xfb)]||0x0,'completedAmount':_0x311c77['_sum']['amount']||0x0,'pendingAmount':_0xae2432[_0x5d5d11(0x8a)][_0x5d5d11(0xfb)]||0x0,'payoutsByStatus':_0x1d7d6f[_0x5d5d11(0xf1)]((_0x36e945,_0x589ef2)=>{const _0x2e27ff=_0x5d5d11;return _0x36e945[_0x589ef2['status']]=_0x589ef2[_0x2e27ff(0x83)][_0x2e27ff(0x118)],_0x36e945;},{}),'payoutsByMethod':_0x45c838['reduce']((_0x3802fc,_0x15fcee)=>{const _0x1cd458=_0x5d5d11;return _0x3802fc[_0x15fcee[_0x1cd458(0x111)]]=_0x15fcee['_count'][_0x1cd458(0x111)],_0x3802fc;},{}),'recentPayouts':_0x6484f4[_0x5d5d11(0x8c)](_0x426e81=>({'id':_0x426e81['id'],'shopId':_0x426e81[_0x5d5d11(0xe2)],'amount':_0x426e81['amount'],'method':_0x426e81[_0x5d5d11(0x111)],'status':_0x426e81['status'],'txid':_0x426e81[_0x5d5d11(0xf7)],'createdAt':_0x426e81[_0x5d5d11(0x11e)],'paidAt':_0x426e81['paidAt'],'shop':_0x426e81[_0x5d5d11(0xbc)]}))};}async[a48_0x37fe9f(0x136)](_0x47530c){const _0x38e6a5=a48_0x37fe9f;console[_0x38e6a5(0x13f)](_0x38e6a5(0x107)+_0x47530c);const _0x2facef=await database_1[_0x38e6a5(0x12a)][_0x38e6a5(0xbc)][_0x38e6a5(0x14c)]({'where':{'id':_0x47530c},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x2facef)throw new Error(_0x38e6a5(0x9d));const _0x542ba2=await database_1['default'][_0x38e6a5(0x114)][_0x38e6a5(0xaf)]({'where':{'shopId':_0x47530c,'status':'PAID'},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0x38e6a5(0x13f)](_0x38e6a5(0x106)+_0x542ba2['length']+'\x20paid\x20payments\x20for\x20analysis');const _0x420203=new Date(),_0x36fb41=new Date(_0x420203['getFullYear'](),_0x420203['getMonth'](),0x1);let _0x5f190d=0x0,_0x2411c8=0x0,_0x156915=0x0,_0x278721=0x0;for(const _0x23bd36 of _0x542ba2){const _0x105c5d=await currencyService_1[_0x38e6a5(0xae)][_0x38e6a5(0x104)](_0x23bd36[_0x38e6a5(0xfb)],_0x23bd36[_0x38e6a5(0x124)]),_0x2efe79=this[_0x38e6a5(0xc8)](_0x2facef,_0x23bd36['gateway']),_0xe79986=this[_0x38e6a5(0xa2)](_0x105c5d,_0x2efe79['commission']);_0x23bd36[_0x38e6a5(0x105)]&&(_0x5f190d+=_0xe79986,_0x23bd36['paidAt']&&_0x23bd36[_0x38e6a5(0xf0)]>=_0x36fb41&&(_0x156915+=_0xe79986)),this[_0x38e6a5(0x132)](_0x23bd36,_0x2efe79)&&(_0x2411c8+=_0xe79986,_0x278721+=_0x105c5d);}const _0x3af5f2={'availableBalance':Math[_0x38e6a5(0x126)](_0x278721*0x64)/0x64,'totalPaidOut':Math[_0x38e6a5(0x126)](_0x5f190d*0x64)/0x64,'awaitingPayout':Math[_0x38e6a5(0x126)](_0x2411c8*0x64)/0x64,'thisMonth':Math[_0x38e6a5(0x126)](_0x156915*0x64)/0x64};return console[_0x38e6a5(0x13f)](_0x38e6a5(0xcd)),console[_0x38e6a5(0x13f)](_0x38e6a5(0xbe)+_0x3af5f2[_0x38e6a5(0xd0)]+_0x38e6a5(0x121)),console[_0x38e6a5(0x13f)]('ðŸ’¸\x20Total\x20Paid\x20Out:\x20'+_0x3af5f2[_0x38e6a5(0x108)]+_0x38e6a5(0x121)),console['log'](_0x38e6a5(0xd1)+_0x3af5f2['awaitingPayout']+'\x20USDT'),console[_0x38e6a5(0x13f)](_0x38e6a5(0x145)+_0x3af5f2['thisMonth']+_0x38e6a5(0x121)),_0x3af5f2;}async['getPayoutStats'](_0x54f5a2){const _0x2ea6a0=a48_0x37fe9f,_0xe107b9=await this[_0x2ea6a0(0x136)](_0x54f5a2);return{'totalBalance':_0xe107b9[_0x2ea6a0(0xd0)],'totalPaidOut':_0xe107b9[_0x2ea6a0(0x108)],'awaitingPayout':_0xe107b9[_0x2ea6a0(0xde)],'thisMonth':_0xe107b9['thisMonth']};}async['getWebhookLogs'](_0x36ddfc,_0x100a73){const _0x29ebfc=a48_0x37fe9f,{page:_0x3de1d3,limit:_0x1a1ea2,paymentId:_0x33dd66}=_0x100a73,_0x2399e9=(_0x3de1d3-0x1)*_0x1a1ea2,_0x4251e5={'shopId':_0x36ddfc};_0x33dd66&&(_0x4251e5['paymentId']=_0x33dd66);const [_0x1c6f84,_0x17b38a]=await Promise['all']([database_1[_0x29ebfc(0x12a)][_0x29ebfc(0x10c)]['findMany']({'where':_0x4251e5,'skip':_0x2399e9,'take':_0x1a1ea2,'orderBy':{'createdAt':_0x29ebfc(0x81)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x29ebfc(0x12a)][_0x29ebfc(0x10c)][_0x29ebfc(0x8d)]({'where':_0x4251e5})]);return{'logs':_0x1c6f84[_0x29ebfc(0x8c)](_0x4f6b5f=>({'id':_0x4f6b5f['id'],'paymentId':_0x4f6b5f[_0x29ebfc(0x147)],'shopId':_0x4f6b5f[_0x29ebfc(0xe2)],'event':_0x4f6b5f[_0x29ebfc(0xa7)],'statusCode':_0x4f6b5f[_0x29ebfc(0x8b)],'retryCount':_0x4f6b5f[_0x29ebfc(0xe6)],'responseBody':_0x4f6b5f['responseBody'],'createdAt':_0x4f6b5f[_0x29ebfc(0x11e)],'payment':_0x4f6b5f[_0x29ebfc(0x114)]})),'pagination':{'page':_0x3de1d3,'limit':_0x1a1ea2,'total':_0x17b38a,'totalPages':Math['ceil'](_0x17b38a/_0x1a1ea2)}};}async['getStatistics'](_0xb2e0b,_0x5e17e1){const _0x358ebb=a48_0x37fe9f,_0x19501a=this[_0x358ebb(0xc4)](_0x5e17e1),_0x23fb27=new Date();_0x23fb27[_0x358ebb(0x11b)](_0x23fb27[_0x358ebb(0x12e)]()-_0x19501a),console[_0x358ebb(0x13f)](_0x358ebb(0x13e)+_0x5e17e1+'\x20('+_0x19501a+'\x20days)');const _0x197af2={'shopId':_0xb2e0b,'createdAt':{'gte':_0x23fb27}},_0x45e0e7=await database_1['default']['shop']['findUnique']({'where':{'id':_0xb2e0b},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x45e0e7)throw new Error(_0x358ebb(0x9d));const [_0x44f9ce,_0x1e2509,_0x108a7d,_0xe4a39b,_0x24ee2d,_0x461421,_0x23ec93,_0xe5789b]=await Promise[_0x358ebb(0x7c)]([database_1[_0x358ebb(0x12a)][_0x358ebb(0x114)]['count']({'where':_0x197af2}),database_1[_0x358ebb(0x12a)]['payment'][_0x358ebb(0x8d)]({'where':{..._0x197af2,'status':_0x358ebb(0x14d)}}),database_1[_0x358ebb(0x12a)][_0x358ebb(0x114)][_0x358ebb(0xaf)]({'where':_0x197af2,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1[_0x358ebb(0x12a)][_0x358ebb(0x114)][_0x358ebb(0xaf)]({'where':{..._0x197af2,'status':'PAID'},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1['default']['payment'][_0x358ebb(0x110)]({'by':[_0x358ebb(0x118)],'where':_0x197af2,'_count':{'status':!![]}}),database_1[_0x358ebb(0x12a)][_0x358ebb(0x114)][_0x358ebb(0x110)]({'by':[_0x358ebb(0xb5)],'where':_0x197af2,'_count':{'gateway':!![]}}),database_1[_0x358ebb(0x12a)]['payment'][_0x358ebb(0xaf)]({'where':{'shopId':_0xb2e0b},'take':0xa,'orderBy':{'createdAt':_0x358ebb(0x81)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1['default']['$queryRaw']`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0xb2e0b} 
          AND created_at >= ${_0x23fb27}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0x358ebb(0x13f)](_0x358ebb(0x106)+_0xe4a39b[_0x358ebb(0x7d)]+_0x358ebb(0x13a));const _0x3cba8f=await Promise[_0x358ebb(0x7c)](_0xe4a39b[_0x358ebb(0x8c)](async _0xdae251=>{const _0x2ddaae=_0x358ebb,_0x81609b=await currencyService_1[_0x2ddaae(0xae)][_0x2ddaae(0x104)](_0xdae251['amount'],_0xdae251[_0x2ddaae(0x124)]),_0x2fbbbe=this[_0x2ddaae(0xc8)](_0x45e0e7,_0xdae251[_0x2ddaae(0xb5)]),_0x3ac75a=this[_0x2ddaae(0xa2)](_0x81609b,_0x2fbbbe[_0x2ddaae(0x9f)]);return _0x3ac75a;})),_0x2edd54=await Promise[_0x358ebb(0x7c)](_0x108a7d[_0x358ebb(0x8c)](async _0x50af42=>{const _0x513b72=_0x358ebb,_0x47a2da=await currencyService_1[_0x513b72(0xae)][_0x513b72(0x104)](_0x50af42['amount'],_0x50af42['currency']);return{'amount':_0x47a2da,'status':_0x50af42[_0x513b72(0x118)]};})),_0x31697b=_0x3cba8f[_0x358ebb(0xf1)]((_0x929fa1,_0x2f942b)=>_0x929fa1+_0x2f942b,0x0),_0x81ea44=_0x44f9ce>0x0?_0x2edd54['reduce']((_0x57eef8,_0x5eaed1)=>_0x57eef8+_0x5eaed1['amount'],0x0)/_0x44f9ce:0x0;console[_0x358ebb(0x13f)](_0x358ebb(0x10f)+_0x31697b['toFixed'](0x2)+_0x358ebb(0x121)),console[_0x358ebb(0x13f)](_0x358ebb(0x14e)+_0x81ea44['toFixed'](0x2)+_0x358ebb(0x121));const _0x43b0b3=this[_0x358ebb(0xbd)](_0x23fb27,new Date()),_0x24728b=await Promise[_0x358ebb(0x7c)](_0xe5789b['map'](async _0x4d5b0c=>{const _0x3dd4b1=_0x358ebb,_0x17f7b6=_0x4d5b0c[_0x3dd4b1(0x119)]['filter'](_0x56028a=>_0x56028a['status']===_0x3dd4b1(0x14d)),_0x2f35c8=await Promise[_0x3dd4b1(0x7c)](_0x17f7b6['map'](async _0x2b56f9=>{const _0x3c5b25=_0x3dd4b1,_0x3f5516=await currencyService_1[_0x3c5b25(0xae)]['convertToUSDT'](_0x2b56f9['amount'],_0x2b56f9[_0x3c5b25(0x124)]),_0x2776de=this[_0x3c5b25(0xc8)](_0x45e0e7,_0x2b56f9[_0x3c5b25(0xb5)]),_0x89fdc7=this[_0x3c5b25(0xa2)](_0x3f5516,_0x2776de['commission']);return _0x89fdc7;})),_0x5caaa5=_0x2f35c8['reduce']((_0x321f04,_0x40dd0a)=>_0x321f04+_0x40dd0a,0x0);return{'date':_0x4d5b0c['date'][_0x3dd4b1(0xef)]()[_0x3dd4b1(0xad)]('T')[0x0],'count':_0x4d5b0c[_0x3dd4b1(0x8d)],'revenue':_0x5caaa5};})),_0x5b06ab=new Map(_0x24728b['map'](_0x266551=>[_0x266551[_0x358ebb(0x12b)],{'count':_0x266551[_0x358ebb(0x8d)],'revenue':_0x266551[_0x358ebb(0xb2)]}])),_0x33270f=_0x43b0b3[_0x358ebb(0x8c)](_0x4a0cec=>({'date':_0x4a0cec,'amount':_0x5b06ab[_0x358ebb(0xcf)](_0x4a0cec)?.[_0x358ebb(0xb2)]||0x0})),_0x5e54a8=_0x43b0b3[_0x358ebb(0x8c)](_0x4ed473=>({'date':_0x4ed473,'count':_0x5b06ab['get'](_0x4ed473)?.['count']||0x0}));return console[_0x358ebb(0x13f)]('âœ…\x20Shop\x20statistics\x20generated\x20successfully'),console[_0x358ebb(0x13f)](_0x358ebb(0x116)+_0x44f9ce),console[_0x358ebb(0x13f)](_0x358ebb(0x9b)+_0x1e2509),console[_0x358ebb(0x13f)](_0x358ebb(0x127)+_0x33270f['length']),{'totalPayments':_0x44f9ce,'successfulPayments':_0x1e2509,'totalAmount':Math[_0x358ebb(0x126)](_0x31697b*0x64)/0x64,'averageAmount':Math['round'](_0x81ea44*0x64)/0x64,'paymentsByStatus':_0x24ee2d['reduce']((_0x5db04a,_0x40a3dd)=>{const _0x3a3daf=_0x358ebb;return _0x5db04a[_0x40a3dd[_0x3a3daf(0x118)]]=_0x40a3dd[_0x3a3daf(0x83)][_0x3a3daf(0x118)],_0x5db04a;},{}),'paymentsByGateway':_0x461421[_0x358ebb(0xf1)]((_0x4b247c,_0x40799f)=>{const _0x1a10b9=_0x358ebb;return _0x4b247c[_0x40799f[_0x1a10b9(0xb5)]]=_0x40799f[_0x1a10b9(0x83)]['gateway'],_0x4b247c;},{}),'recentPayments':_0x23ec93['map'](_0x471519=>{const _0x9baed8=_0x358ebb,_0x46c39c='https://tesoft.uk/gateway/payment.php?id='+_0x471519['id'];return{'id':_0x471519['id'],'shopId':_0x471519[_0x9baed8(0xe2)],'gateway':_0x471519[_0x9baed8(0xb5)],'amount':_0x471519[_0x9baed8(0xfb)],'currency':_0x471519[_0x9baed8(0x124)],'sourceCurrency':_0x471519[_0x9baed8(0xcc)],'usage':_0x471519['usage'],'expiresAt':_0x471519[_0x9baed8(0xd8)],'redirectUrl':_0x46c39c,'status':_0x471519[_0x9baed8(0x118)],'externalPaymentUrl':_0x471519[_0x9baed8(0x102)],'customerEmail':_0x471519[_0x9baed8(0x109)],'customerName':_0x471519[_0x9baed8(0x90)],'country':_0x471519['country'],'language':_0x471519['language'],'amountIsEditable':_0x471519[_0x9baed8(0x98)],'maxPayments':_0x471519[_0x9baed8(0xa1)],'customer':_0x471519[_0x9baed8(0x78)],'createdAt':_0x471519[_0x9baed8(0x11e)],'updatedAt':_0x471519['updatedAt'],'shop':_0x471519[_0x9baed8(0xbc)]};}),'dailyRevenue':_0x33270f,'dailyPayments':_0x5e54a8};}['getPeriodDays'](_0x8e0557){const _0x3f368d=a48_0x37fe9f;switch(_0x8e0557){case'7d':return 0x7;case _0x3f368d(0xbb):return 0x1e;case'90d':return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a48_0x37fe9f(0xbd)](_0x3eb647,_0x35e8a5){const _0x170b21=a48_0x37fe9f,_0x28af09=[],_0x43c70b=new Date(_0x3eb647);while(_0x43c70b<=_0x35e8a5){_0x28af09[_0x170b21(0xaa)](_0x43c70b['toISOString']()[_0x170b21(0xad)]('T')[0x0]),_0x43c70b[_0x170b21(0x11b)](_0x43c70b[_0x170b21(0x12e)]()+0x1);}return _0x28af09;}}exports[a48_0x37fe9f(0x101)]=ShopService;