'use strict';const a53_0x5d9892=a53_0x4544;function a53_0x4544(_0x505654,_0x59259c){const _0x763c46=a53_0x763c();return a53_0x4544=function(_0x454450,_0x3b0e11){_0x454450=_0x454450-0x112;let _0x91655d=_0x763c46[_0x454450];return _0x91655d;},a53_0x4544(_0x505654,_0x59259c);}(function(_0x231e2f,_0x6dd209){const _0x2149d6=a53_0x4544,_0x3d8cc2=_0x231e2f();while(!![]){try{const _0x8677d5=-parseInt(_0x2149d6(0x199))/0x1*(parseInt(_0x2149d6(0x11c))/0x2)+parseInt(_0x2149d6(0x19b))/0x3*(parseInt(_0x2149d6(0x14f))/0x4)+parseInt(_0x2149d6(0x168))/0x5*(parseInt(_0x2149d6(0x149))/0x6)+parseInt(_0x2149d6(0x181))/0x7+parseInt(_0x2149d6(0x12e))/0x8+-parseInt(_0x2149d6(0x119))/0x9*(-parseInt(_0x2149d6(0x13c))/0xa)+parseInt(_0x2149d6(0x187))/0xb*(-parseInt(_0x2149d6(0x1ac))/0xc);if(_0x8677d5===_0x6dd209)break;else _0x3d8cc2['push'](_0x3d8cc2['shift']());}catch(_0x429ff6){_0x3d8cc2['push'](_0x3d8cc2['shift']());}}}(a53_0x763c,0x436e5));var __importDefault=this&&this[a53_0x5d9892(0x124)]||function(_0x5ee641){const _0x2e5b2c=a53_0x5d9892;return _0x5ee641&&_0x5ee641[_0x2e5b2c(0x19f)]?_0x5ee641:{'default':_0x5ee641};};Object['defineProperty'](exports,a53_0x5d9892(0x19f),{'value':!![]}),exports[a53_0x5d9892(0x1ab)]=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require('./currencyService'),paymentService_1=require(a53_0x5d9892(0x170));class ShopService{constructor(){const _0x12207a=a53_0x5d9892;this[_0x12207a(0x12d)]=new paymentService_1[(_0x12207a(0x15d))]();}async[a53_0x5d9892(0x150)](_0x1ad3e3){const _0x59afab=a53_0x5d9892,_0x24b528=await database_1['default'][_0x59afab(0x1b1)][_0x59afab(0x125)]({'where':{'id':_0x1ad3e3},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x24b528)throw new Error('Shop\x20not\x20found');let _0x1f5995=[];if(_0x24b528[_0x59afab(0x11f)]?.[_0x59afab(0x169)])try{_0x1f5995=Array[_0x59afab(0x171)](_0x24b528[_0x59afab(0x11f)]['webhookEvents'])?_0x24b528['settings'][_0x59afab(0x169)]:JSON['parse'](_0x24b528[_0x59afab(0x11f)][_0x59afab(0x169)]);}catch(_0x3b8e89){console[_0x59afab(0x112)]('Error\x20parsing\x20webhook\x20events:',_0x3b8e89),_0x1f5995=[];}return{'id':_0x24b528['id'],'fullName':_0x24b528[_0x59afab(0x197)],'username':_0x24b528['username'],'telegramId':_0x24b528['telegram'],'merchantUrl':_0x24b528[_0x59afab(0x1a3)],'gateways':_0x24b528[_0x59afab(0x141)]?JSON[_0x59afab(0x164)](_0x24b528[_0x59afab(0x141)]):null,'gatewaySettings':_0x24b528[_0x59afab(0x173)]?JSON[_0x59afab(0x164)](_0x24b528[_0x59afab(0x173)]):null,'publicKey':_0x24b528[_0x59afab(0x18e)],'webhookUrl':_0x24b528[_0x59afab(0x11f)]?.[_0x59afab(0x163)]||null,'webhookEvents':_0x1f5995,'wallets':{'usdtPolygonWallet':_0x24b528[_0x59afab(0x16f)],'usdtTrcWallet':_0x24b528[_0x59afab(0x175)],'usdtErcWallet':_0x24b528[_0x59afab(0x18b)],'usdcPolygonWallet':_0x24b528['usdcPolygonWallet']},'status':_0x24b528['status'],'createdAt':_0x24b528[_0x59afab(0x1a2)]};}async[a53_0x5d9892(0x152)](_0x5a4cbc,_0x51410f){const _0xbc2dc4=a53_0x5d9892,_0x23c1ee={};_0x51410f[_0xbc2dc4(0x194)]&&(_0x23c1ee[_0xbc2dc4(0x197)]=_0x51410f[_0xbc2dc4(0x194)]);_0x51410f[_0xbc2dc4(0x1b2)]!==undefined&&(_0x23c1ee[_0xbc2dc4(0x188)]=_0x51410f[_0xbc2dc4(0x1b2)]||null);_0x51410f[_0xbc2dc4(0x18d)]&&(_0x23c1ee[_0xbc2dc4(0x1a3)]=_0x51410f['merchantUrl']);_0x51410f['gateways']&&(_0x23c1ee[_0xbc2dc4(0x141)]=JSON['stringify'](_0x51410f[_0xbc2dc4(0x116)]));_0x51410f[_0xbc2dc4(0x173)]&&(_0x23c1ee['gatewaySettings']=JSON['stringify'](_0x51410f[_0xbc2dc4(0x173)]));_0x51410f['wallets']&&(_0x51410f[_0xbc2dc4(0x165)][_0xbc2dc4(0x16f)]!==undefined&&(_0x23c1ee[_0xbc2dc4(0x16f)]=_0x51410f['wallets'][_0xbc2dc4(0x16f)]||null),_0x51410f['wallets'][_0xbc2dc4(0x175)]!==undefined&&(_0x23c1ee[_0xbc2dc4(0x175)]=_0x51410f[_0xbc2dc4(0x165)]['usdtTrcWallet']||null),_0x51410f[_0xbc2dc4(0x165)]['usdtErcWallet']!==undefined&&(_0x23c1ee[_0xbc2dc4(0x18b)]=_0x51410f[_0xbc2dc4(0x165)][_0xbc2dc4(0x18b)]||null),_0x51410f[_0xbc2dc4(0x165)][_0xbc2dc4(0x193)]!==undefined&&(_0x23c1ee[_0xbc2dc4(0x193)]=_0x51410f[_0xbc2dc4(0x165)][_0xbc2dc4(0x193)]||null));const _0x3b92f3=await database_1['default'][_0xbc2dc4(0x1b1)][_0xbc2dc4(0x18f)]({'where':{'id':_0x5a4cbc},'data':_0x23c1ee,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x598057=[];if(_0x3b92f3[_0xbc2dc4(0x11f)]?.[_0xbc2dc4(0x169)])try{_0x598057=Array[_0xbc2dc4(0x171)](_0x3b92f3[_0xbc2dc4(0x11f)]['webhookEvents'])?_0x3b92f3[_0xbc2dc4(0x11f)][_0xbc2dc4(0x169)]:JSON[_0xbc2dc4(0x164)](_0x3b92f3[_0xbc2dc4(0x11f)][_0xbc2dc4(0x169)]);}catch(_0x2d8842){console['error']('Error\x20parsing\x20webhook\x20events:',_0x2d8842),_0x598057=[];}return{'id':_0x3b92f3['id'],'fullName':_0x3b92f3['name'],'username':_0x3b92f3[_0xbc2dc4(0x183)],'telegramId':_0x3b92f3[_0xbc2dc4(0x188)],'merchantUrl':_0x3b92f3['shopUrl'],'gateways':_0x3b92f3[_0xbc2dc4(0x141)]?JSON[_0xbc2dc4(0x164)](_0x3b92f3['paymentGateways']):null,'gatewaySettings':_0x3b92f3[_0xbc2dc4(0x173)]?JSON['parse'](_0x3b92f3[_0xbc2dc4(0x173)]):null,'publicKey':_0x3b92f3['publicKey'],'webhookUrl':_0x3b92f3[_0xbc2dc4(0x11f)]?.[_0xbc2dc4(0x163)]||null,'webhookEvents':_0x598057,'wallets':{'usdtPolygonWallet':_0x3b92f3[_0xbc2dc4(0x16f)],'usdtTrcWallet':_0x3b92f3[_0xbc2dc4(0x175)],'usdtErcWallet':_0x3b92f3['usdtErcWallet'],'usdcPolygonWallet':_0x3b92f3['usdcPolygonWallet']},'status':_0x3b92f3[_0xbc2dc4(0x128)],'createdAt':_0x3b92f3[_0xbc2dc4(0x1a2)]};}async[a53_0x5d9892(0x159)](_0x3505ff,_0x2eb38d){const _0x426974=a53_0x5d9892,_0x26c84f={};_0x2eb38d[_0x426974(0x16f)]!==undefined&&(_0x26c84f['usdtPolygonWallet']=_0x2eb38d[_0x426974(0x16f)]||null),_0x2eb38d['usdtTrcWallet']!==undefined&&(_0x26c84f[_0x426974(0x175)]=_0x2eb38d[_0x426974(0x175)]||null),_0x2eb38d[_0x426974(0x18b)]!==undefined&&(_0x26c84f['usdtErcWallet']=_0x2eb38d['usdtErcWallet']||null),_0x2eb38d[_0x426974(0x193)]!==undefined&&(_0x26c84f[_0x426974(0x193)]=_0x2eb38d[_0x426974(0x193)]||null),await database_1[_0x426974(0x137)][_0x426974(0x1b1)][_0x426974(0x18f)]({'where':{'id':_0x3505ff},'data':_0x26c84f});}async['testWebhook'](_0x10cde2){const _0x593234=a53_0x5d9892,_0x30b12f=await database_1[_0x593234(0x137)][_0x593234(0x1b1)][_0x593234(0x125)]({'where':{'id':_0x10cde2},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x30b12f?.[_0x593234(0x11f)]?.[_0x593234(0x163)])throw new Error(_0x593234(0x196));const _0x1e8333={'event':_0x593234(0x14b),'payment':{'id':'test_payment_123','order_id':'test_order_123','gateway':_0x593234(0x14b),'amount':0x64,'currency':'USD','status':'paid','created_at':new Date()[_0x593234(0x113)]()}};try{const _0x36b53d=await fetch(_0x30b12f[_0x593234(0x11f)][_0x593234(0x163)],{'method':_0x593234(0x1a9),'headers':{'Content-Type':_0x593234(0x17c),'User-Agent':_0x593234(0x177)},'body':JSON[_0x593234(0x166)](_0x1e8333)});return _0x36b53d['ok']?{'success':!![],'message':_0x593234(0x1b0)+_0x36b53d[_0x593234(0x128)]+')'}:{'success':![],'message':_0x593234(0x121)+_0x36b53d[_0x593234(0x128)]+'\x20'+_0x36b53d[_0x593234(0x158)]};}catch(_0x1d4a25){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x1d4a25 instanceof Error?_0x1d4a25[_0x593234(0x143)]:_0x593234(0x17e))};}}async[a53_0x5d9892(0x14c)](_0x906772){const _0x329c46=a53_0x5d9892;return this[_0x329c46(0x12d)][_0x329c46(0x157)]({'public_key':'','gateway':_0x906772['gateway'],'order_id':undefined,'amount':_0x906772[_0x329c46(0x18a)],'currency':_0x906772[_0x329c46(0x178)],'source_currency':_0x906772[_0x329c46(0x195)],'usage':_0x906772[_0x329c46(0x123)],'expires_at':_0x906772['expiresAt']?.[_0x329c46(0x113)](),'success_url':_0x906772[_0x329c46(0x13e)],'fail_url':_0x906772[_0x329c46(0x13e)],'customer_email':_0x906772[_0x329c46(0x1b7)],'customer_name':_0x906772[_0x329c46(0x19a)],'country':_0x906772[_0x329c46(0x180)],'language':_0x906772[_0x329c46(0x192)],'amount_is_editable':_0x906772[_0x329c46(0x1b3)],'max_payments':_0x906772[_0x329c46(0x174)],'customer':_0x906772[_0x329c46(0x117)]});}async['getPayments'](_0x25c9a2,_0x1c0902){const _0x334fd6=a53_0x5d9892;return this['paymentService'][_0x334fd6(0x126)](_0x25c9a2,_0x1c0902);}async[a53_0x5d9892(0x11a)](_0x51da9b,_0x48bc80){const _0x1c7912=a53_0x5d9892;return this['paymentService'][_0x1c7912(0x139)](_0x51da9b,_0x48bc80);}async[a53_0x5d9892(0x191)](_0x43b08f,_0xc0e375,_0x1dcbb4){const _0x45f2b0=a53_0x5d9892,_0x19ae0c=await database_1['default'][_0x45f2b0(0x144)][_0x45f2b0(0x184)]({'where':{'id':_0xc0e375,'shopId':_0x43b08f}});if(!_0x19ae0c)throw new Error(_0x45f2b0(0x17a));const _0x598929=await database_1['default']['payment'][_0x45f2b0(0x18f)]({'where':{'id':_0xc0e375},'data':{..._0x1dcbb4,'updatedAt':new Date()}});return _0x598929;}async['deletePayment'](_0x40516a,_0x141477){const _0xd6c3c9=a53_0x5d9892,_0x202649=await database_1[_0xd6c3c9(0x137)][_0xd6c3c9(0x144)][_0xd6c3c9(0x184)]({'where':{'id':_0x141477,'shopId':_0x40516a}});if(!_0x202649)throw new Error(_0xd6c3c9(0x17a));await database_1['default']['payment'][_0xd6c3c9(0x122)]({'where':{'id':_0x141477}});}[a53_0x5d9892(0x131)](_0x55f0cb){const _0xa74b50=a53_0x5d9892,_0x54a809={'polygon':'USDT\x20Polygon','trc20':_0xa74b50(0x1b5),'erc20':_0xa74b50(0x190),'bsc':_0xa74b50(0x1a8),'polygon_usdc':'USDC\x20Polygon'};return _0x54a809[_0x55f0cb]||_0x55f0cb;}async[a53_0x5d9892(0x14e)](_0x2eace2,_0x278c13){const _0x5dc2b9=a53_0x5d9892,{page:_0x59e09b,limit:_0x11cd6e,status:_0x59a6be,method:_0x8f5908,network:_0xb6a172,dateFrom:_0x23e5cb,dateTo:_0x113566,periodFrom:_0x5b4365,periodTo:_0x284b04}=_0x278c13,_0x3f4e32=(_0x59e09b-0x1)*_0x11cd6e;console[_0x5dc2b9(0x13f)](_0x5dc2b9(0x15c),_0x278c13);const _0x4cef21={'shopId':_0x2eace2};_0x59a6be&&(_0x4cef21[_0x5dc2b9(0x128)]=_0x59a6be['toUpperCase'](),console['log'](_0x5dc2b9(0x14d)+_0x59a6be[_0x5dc2b9(0x146)]()));if(_0x8f5908)_0x4cef21[_0x5dc2b9(0x16e)]=_0x8f5908,console[_0x5dc2b9(0x13f)]('🌐\x20Method\x20filter:\x20'+_0x8f5908);else _0xb6a172&&(_0x4cef21[_0x5dc2b9(0x16e)]=_0xb6a172,console[_0x5dc2b9(0x13f)](_0x5dc2b9(0x13a)+_0xb6a172));if(_0x23e5cb||_0x113566||_0x5b4365||_0x284b04){_0x4cef21[_0x5dc2b9(0x1a2)]={};if(_0x5b4365){const _0x41c0b8=new Date(_0x5b4365);_0x41c0b8[_0x5dc2b9(0x134)](0x0,0x0,0x0,0x0),_0x4cef21[_0x5dc2b9(0x1a2)]['gte']=_0x41c0b8,console[_0x5dc2b9(0x13f)](_0x5dc2b9(0x189)+_0x41c0b8[_0x5dc2b9(0x113)]());}else{if(_0x23e5cb){const _0x4752f4=new Date(_0x23e5cb);_0x4752f4[_0x5dc2b9(0x134)](0x0,0x0,0x0,0x0),_0x4cef21['createdAt'][_0x5dc2b9(0x12c)]=_0x4752f4,console['log'](_0x5dc2b9(0x179)+_0x4752f4[_0x5dc2b9(0x113)]());}}if(_0x284b04){const _0x25083d=new Date(_0x284b04);_0x25083d[_0x5dc2b9(0x134)](0x17,0x3b,0x3b,0x3e7),_0x4cef21[_0x5dc2b9(0x1a2)]['lte']=_0x25083d,console[_0x5dc2b9(0x13f)](_0x5dc2b9(0x153)+_0x25083d['toISOString']());}else{if(_0x113566){const _0x32247b=new Date(_0x113566);_0x32247b[_0x5dc2b9(0x134)](0x17,0x3b,0x3b,0x3e7),_0x4cef21['createdAt'][_0x5dc2b9(0x1b9)]=_0x32247b,console['log'](_0x5dc2b9(0x14a)+_0x32247b[_0x5dc2b9(0x113)]());}}}console['log'](_0x5dc2b9(0x155),JSON[_0x5dc2b9(0x166)](_0x4cef21,null,0x2));const [_0x30dd6a,_0x35e1cf]=await Promise['all']([database_1[_0x5dc2b9(0x137)][_0x5dc2b9(0x16b)][_0x5dc2b9(0x136)]({'where':_0x4cef21,'skip':_0x3f4e32,'take':_0x11cd6e,'orderBy':{'createdAt':_0x5dc2b9(0x16a)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x5dc2b9(0x137)][_0x5dc2b9(0x16b)][_0x5dc2b9(0x114)]({'where':_0x4cef21})]);return{'payouts':_0x30dd6a[_0x5dc2b9(0x148)](_0x5b22c1=>{const _0x5b6336=_0x5dc2b9;let _0x397108=null;switch(_0x5b22c1[_0x5b6336(0x16e)]){case _0x5b6336(0x176):_0x397108=_0x5b22c1[_0x5b6336(0x1b1)][_0x5b6336(0x16f)];break;case'trc20':_0x397108=_0x5b22c1[_0x5b6336(0x1b1)][_0x5b6336(0x175)];break;case _0x5b6336(0x1a0):_0x397108=_0x5b22c1['shop'][_0x5b6336(0x18b)];break;case'polygon_usdc':_0x397108=_0x5b22c1[_0x5b6336(0x1b1)][_0x5b6336(0x193)];break;}return{'id':_0x5b22c1['id'],'amount':_0x5b22c1[_0x5b6336(0x18a)],'network':this[_0x5b6336(0x131)](_0x5b22c1[_0x5b6336(0x16e)]),'wallet':_0x397108,'status':_0x5b22c1[_0x5b6336(0x128)],'txid':_0x5b22c1[_0x5b6336(0x17f)],'notes':_0x5b22c1[_0x5b6336(0x15b)],'periodFrom':_0x5b22c1[_0x5b6336(0x133)],'periodTo':_0x5b22c1['periodTo'],'createdAt':_0x5b22c1[_0x5b6336(0x1a2)],'paidAt':_0x5b22c1[_0x5b6336(0x130)]};}),'pagination':{'page':_0x59e09b,'limit':_0x11cd6e,'total':_0x35e1cf,'totalPages':Math['ceil'](_0x35e1cf/_0x11cd6e)}};}async[a53_0x5d9892(0x13d)](_0x2f8739,_0x57b28f){const _0x384ba0=a53_0x5d9892,_0x5f2b3c=await database_1[_0x384ba0(0x137)]['payout'][_0x384ba0(0x184)]({'where':{'id':_0x57b28f,'shopId':_0x2f8739}});if(!_0x5f2b3c)return null;return{'id':_0x5f2b3c['id'],'amount':_0x5f2b3c[_0x384ba0(0x18a)],'network':_0x5f2b3c[_0x384ba0(0x16e)],'status':_0x5f2b3c['status'],'txid':_0x5f2b3c[_0x384ba0(0x17f)],'notes':_0x5f2b3c['notes'],'createdAt':_0x5f2b3c[_0x384ba0(0x1a2)],'paidAt':_0x5f2b3c['paidAt']};}async[a53_0x5d9892(0x156)](_0x25f59e,_0x30e500){const _0x4550e7=a53_0x5d9892,_0x2f09ef=new Date();let _0x4eae34;switch(_0x30e500){case'7d':_0x4eae34=new Date(_0x2f09ef[_0x4550e7(0x167)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x4550e7(0x172):_0x4eae34=new Date(_0x2f09ef[_0x4550e7(0x167)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x4550e7(0x12a):_0x4eae34=new Date(_0x2f09ef[_0x4550e7(0x167)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x4eae34=new Date(_0x2f09ef[_0x4550e7(0x167)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x39f593,_0x4580a6,_0x461618,_0x3812fb,_0x2667f5,_0x1428f5]=await Promise['all']([database_1[_0x4550e7(0x137)][_0x4550e7(0x16b)][_0x4550e7(0x114)]({'where':{'shopId':_0x25f59e,'createdAt':{'gte':_0x4eae34}}}),database_1[_0x4550e7(0x137)][_0x4550e7(0x16b)]['count']({'where':{'shopId':_0x25f59e,'status':_0x4550e7(0x115),'createdAt':{'gte':_0x4eae34}}}),database_1[_0x4550e7(0x137)][_0x4550e7(0x16b)][_0x4550e7(0x114)]({'where':{'shopId':_0x25f59e,'status':'PENDING','createdAt':{'gte':_0x4eae34}}}),database_1[_0x4550e7(0x137)][_0x4550e7(0x16b)][_0x4550e7(0x114)]({'where':{'shopId':_0x25f59e,'status':_0x4550e7(0x1ae),'createdAt':{'gte':_0x4eae34}}}),database_1['default']['payout'][_0x4550e7(0x136)]({'where':{'shopId':_0x25f59e,'createdAt':{'gte':_0x4eae34}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x4550e7(0x137)]['payout']['findMany']({'where':{'shopId':_0x25f59e},'take':0xa,'orderBy':{'createdAt':_0x4550e7(0x16a)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x265800=_0x2667f5[_0x4550e7(0x18c)]((_0x27427e,_0x5cf555)=>_0x27427e+_0x5cf555[_0x4550e7(0x18a)],0x0),_0x180289=_0x2667f5[_0x4550e7(0x161)](_0x137150=>_0x137150[_0x4550e7(0x128)]===_0x4550e7(0x115))[_0x4550e7(0x18c)]((_0x5105f2,_0x2f9645)=>_0x5105f2+_0x2f9645[_0x4550e7(0x18a)],0x0),_0x213202=_0x2667f5[_0x4550e7(0x161)](_0x266f7e=>_0x266f7e[_0x4550e7(0x128)]===_0x4550e7(0x1b6))[_0x4550e7(0x18c)]((_0x3b45e0,_0x5f27d5)=>_0x3b45e0+_0x5f27d5['amount'],0x0),_0x394fea=_0x2667f5['reduce']((_0x574958,_0x3c2418)=>{const _0x61e956=_0x4550e7;return _0x574958[_0x3c2418[_0x61e956(0x16e)]]=(_0x574958[_0x3c2418[_0x61e956(0x16e)]]||0x0)+0x1,_0x574958;},{}),_0x28d1ce=_0x2667f5[_0x4550e7(0x18c)]((_0x6a14a0,_0x195fa7)=>{const _0x446c08=_0x4550e7;return _0x6a14a0[_0x195fa7[_0x446c08(0x128)]]=(_0x6a14a0[_0x195fa7[_0x446c08(0x128)]]||0x0)+0x1,_0x6a14a0;},{});return{'totalPayouts':_0x39f593,'completedPayouts':_0x4580a6,'pendingPayouts':_0x461618,'rejectedPayouts':_0x3812fb,'totalAmount':_0x265800,'completedAmount':_0x180289,'pendingAmount':_0x213202,'payoutsByMethod':_0x394fea,'payoutsByStatus':_0x28d1ce,'recentPayouts':_0x1428f5[_0x4550e7(0x148)](_0x41eb69=>({'id':_0x41eb69['id'],'shopId':_0x25f59e,'amount':_0x41eb69[_0x4550e7(0x18a)],'method':_0x41eb69[_0x4550e7(0x16e)],'status':_0x41eb69[_0x4550e7(0x128)],'txid':_0x41eb69[_0x4550e7(0x17f)],'createdAt':_0x41eb69['createdAt'],'paidAt':_0x41eb69[_0x4550e7(0x130)]}))};}async[a53_0x5d9892(0x15f)](_0x520671){const _0x289892=a53_0x5d9892;console[_0x289892(0x13f)](_0x289892(0x185)+_0x520671+_0x289892(0x12b));const _0x4e21f6=await database_1[_0x289892(0x137)][_0x289892(0x1b1)]['findUnique']({'where':{'id':_0x520671},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x4e21f6)throw new Error(_0x289892(0x135));const _0x246df7=new Date(),_0x314710=new Date(_0x246df7[_0x289892(0x127)](),_0x246df7[_0x289892(0x11d)](),0x1),_0xd65cf0=new Date(_0x246df7[_0x289892(0x127)](),_0x246df7[_0x289892(0x11d)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x543f31=await database_1['default']['payout'][_0x289892(0x182)]({'_sum':{'amount':!![]},'where':{'shopId':_0x520671,'createdAt':{'gte':_0x314710,'lte':_0xd65cf0},'status':_0x289892(0x115)}}),_0xcf2865=_0x543f31['_sum'][_0x289892(0x18a)]||0x0,_0x4b0a2c={'availableBalance':Math[_0x289892(0x160)](_0x4e21f6[_0x289892(0x140)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x4e21f6['totalPaidOut']*0x64)/0x64,'awaitingPayout':Math[_0x289892(0x160)](_0x4e21f6['balance']*0x64)/0x64,'thisMonth':Math[_0x289892(0x160)](_0xcf2865*0x64)/0x64};return console[_0x289892(0x13f)]('📊\x20Shop\x20'+_0x4e21f6[_0x289892(0x183)]+_0x289892(0x1b4)),console['log'](_0x289892(0x120)+_0x4b0a2c[_0x289892(0x17d)]+'\x20USDT\x20(current\x20balance)'),console[_0x289892(0x13f)](_0x289892(0x1a7)+_0x4b0a2c[_0x289892(0x11b)]+_0x289892(0x15e)),console[_0x289892(0x13f)](_0x289892(0x1ad)+_0x4b0a2c['awaitingPayout']+'\x20USDT\x20(current\x20balance)'),console[_0x289892(0x13f)](_0x289892(0x142)+_0x4b0a2c[_0x289892(0x132)]+_0x289892(0x19c)),_0x4b0a2c;}['getGatewayDisplayName'](_0x3c249f){const _0x18e34c=a53_0x5d9892,_0x281b47={'test_gateway':'Test\x20Gateway','plisio':_0x18e34c(0x118),'rapyd':'Rapyd','noda':_0x18e34c(0x13b),'cointopay':_0x18e34c(0x1aa),'klyme_eu':'KLYME\x20EU','klyme_gb':'KLYME\x20GB','klyme_de':_0x18e34c(0x15a)};return _0x281b47[_0x3c249f]||_0x3c249f;}async[a53_0x5d9892(0x12f)](_0x557b9b){const _0x486cad=a53_0x5d9892;return this[_0x486cad(0x15f)](_0x557b9b);}async[a53_0x5d9892(0x11e)](_0x1916a3,_0x3e448e){const _0x487023=a53_0x5d9892,{page:_0x4e7000,limit:_0x584c47,paymentId:_0x1c62a4}=_0x3e448e,_0x1cf139=(_0x4e7000-0x1)*_0x584c47,_0x3c97d3={'shopId':_0x1916a3};_0x1c62a4&&(_0x3c97d3['paymentId']=_0x1c62a4);const [_0x12f877,_0x3e32af]=await Promise[_0x487023(0x162)]([database_1[_0x487023(0x137)]['webhookLog'][_0x487023(0x136)]({'where':_0x3c97d3,'skip':_0x1cf139,'take':_0x584c47,'orderBy':{'createdAt':_0x487023(0x16a)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default']['webhookLog'][_0x487023(0x114)]({'where':_0x3c97d3})]);return{'logs':_0x12f877['map'](_0xf9ac5b=>({'id':_0xf9ac5b['id'],'paymentId':_0xf9ac5b[_0x487023(0x1a1)],'shopId':_0xf9ac5b['shopId'],'event':_0xf9ac5b[_0x487023(0x154)],'statusCode':_0xf9ac5b[_0x487023(0x19d)],'retryCount':_0xf9ac5b['retryCount'],'responseBody':_0xf9ac5b[_0x487023(0x186)],'createdAt':_0xf9ac5b[_0x487023(0x1a2)],'payment':_0xf9ac5b[_0x487023(0x144)]})),'pagination':{'page':_0x4e7000,'limit':_0x584c47,'total':_0x3e32af,'totalPages':Math[_0x487023(0x145)](_0x3e32af/_0x584c47)}};}async['getStatistics'](_0x2353ca,_0x15b558){const _0x3ef80f=a53_0x5d9892,_0x532349=new Date();let _0x1eb168;switch(_0x15b558){case'7d':_0x1eb168=new Date(_0x532349[_0x3ef80f(0x167)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x1eb168=new Date(_0x532349[_0x3ef80f(0x167)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3ef80f(0x12a):_0x1eb168=new Date(_0x532349[_0x3ef80f(0x167)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x1eb168=new Date(_0x532349[_0x3ef80f(0x167)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x8ef5b9,_0x910c0a,_0x4499b2,_0x11cf89,_0x5ba4dc]=await Promise[_0x3ef80f(0x162)]([database_1[_0x3ef80f(0x137)][_0x3ef80f(0x144)][_0x3ef80f(0x114)]({'where':{'shopId':_0x2353ca,'gateway':{'not':_0x3ef80f(0x1af)},'createdAt':{'gte':_0x1eb168}}}),database_1[_0x3ef80f(0x137)][_0x3ef80f(0x144)][_0x3ef80f(0x114)]({'where':{'shopId':_0x2353ca,'gateway':{'not':_0x3ef80f(0x1af)},'status':_0x3ef80f(0x1a4),'createdAt':{'gte':_0x1eb168}}}),database_1[_0x3ef80f(0x137)][_0x3ef80f(0x144)]['findMany']({'where':{'shopId':_0x2353ca,'gateway':{'not':'test_gateway'},'status':_0x3ef80f(0x1a4),'createdAt':{'gte':_0x1eb168}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default'][_0x3ef80f(0x144)][_0x3ef80f(0x136)]({'where':{'shopId':_0x2353ca,'gateway':{'not':_0x3ef80f(0x1af)}},'take':0xa,'orderBy':{'createdAt':_0x3ef80f(0x16a)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x3ef80f(0x137)][_0x3ef80f(0x144)]['findMany']({'where':{'shopId':_0x2353ca,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x1eb168}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3ef80f(0x1b8)}})]);let _0xfe02f2=0x0;for(const _0x4841cc of _0x4499b2){if(_0x4841cc[_0x3ef80f(0x147)])_0xfe02f2+=_0x4841cc['amountUSDT'];else{const _0x581ca8=await currencyService_1[_0x3ef80f(0x19e)][_0x3ef80f(0x151)](_0x4841cc[_0x3ef80f(0x18a)],_0x4841cc['currency']);_0xfe02f2+=_0x581ca8;}}const _0x3a22bf=this['generateDailyStatistics'](_0x5ba4dc,_0x1eb168,_0x532349),_0x582cc1=_0x8ef5b9>0x0?_0x910c0a/_0x8ef5b9*0x64:0x0;return{'totalPayments':_0x8ef5b9,'successfulPayments':_0x910c0a,'totalRevenue':Math[_0x3ef80f(0x160)](_0xfe02f2*0x64)/0x64,'conversionRate':Math[_0x3ef80f(0x160)](_0x582cc1*0x64)/0x64,'dailyRevenue':_0x3a22bf[_0x3ef80f(0x129)],'dailyPayments':_0x3a22bf['dailyPayments'],'recentPayments':_0x11cf89[_0x3ef80f(0x148)](_0x7f320e=>({'id':_0x7f320e['id'],'gateway':_0x7f320e[_0x3ef80f(0x1a5)],'amount':_0x7f320e[_0x3ef80f(0x18a)],'currency':_0x7f320e[_0x3ef80f(0x178)],'status':_0x7f320e[_0x3ef80f(0x128)],'createdAt':_0x7f320e[_0x3ef80f(0x1a2)]}))};}[a53_0x5d9892(0x17b)](_0x42df54,_0x7c714f,_0xfe05a7){const _0x1c161e=a53_0x5d9892,_0x4f02bd=new Map(),_0x349816=new Date(_0x7c714f);while(_0x349816<=_0xfe05a7){const _0x5aef88=_0x349816['toISOString']()[_0x1c161e(0x1a6)]('T')[0x0];_0x4f02bd[_0x1c161e(0x16c)](_0x5aef88,{'revenue':0x0,'count':0x0}),_0x349816['setDate'](_0x349816[_0x1c161e(0x198)]()+0x1);}for(const _0x1c9962 of _0x42df54){const _0x280a61=_0x1c9962[_0x1c161e(0x1a2)]['toISOString']()[_0x1c161e(0x1a6)]('T')[0x0],_0x255288=_0x4f02bd['get'](_0x280a61);_0x255288&&(_0x255288[_0x1c161e(0x114)]+=0x1,_0x1c9962[_0x1c161e(0x128)]===_0x1c161e(0x1a4)&&_0x1c9962[_0x1c161e(0x147)]&&(_0x255288[_0x1c161e(0x16d)]+=_0x1c9962[_0x1c161e(0x147)]));}const _0x6fb802=[],_0x3b17d6=[];for(const [_0x34175d,_0x3d5da8]of _0x4f02bd){_0x6fb802['push']({'date':_0x34175d,'amount':Math[_0x1c161e(0x160)](_0x3d5da8[_0x1c161e(0x16d)]*0x64)/0x64}),_0x3b17d6[_0x1c161e(0x138)]({'date':_0x34175d,'count':_0x3d5da8['count']});}return{'dailyRevenue':_0x6fb802,'dailyPayments':_0x3b17d6};}}exports[a53_0x5d9892(0x1ab)]=ShopService;function a53_0x763c(){const _0x2f2aa2=['USDT\x20TRC20','PENDING','customerEmail','asc','lte','error','toISOString','count','COMPLETED','gateways','customer','Plisio','145737ldpHKE','getPaymentById','totalPaidOut','32792CajozQ','getMonth','getWebhookLogs','settings','\x20\x20\x20💵\x20Available\x20balance:\x20','Webhook\x20returned\x20error:\x20','delete','usage','__importDefault','findUnique','getPaymentsByShop','getFullYear','status','dailyRevenue','90d','...','gte','paymentService','1786424CGbssS','getPayoutStats','paidAt','formatNetworkName','thisMonth','periodFrom','setHours','Shop\x20not\x20found','findMany','default','push','getPaymentByShopAndId','🌐\x20Network\x20filter:\x20','Noda','240SBzoBM','getPayoutById','redirectUrl','log','balance','paymentGateways','\x20\x20\x20📅\x20This\x20month:\x20','message','payment','ceil','toUpperCase','amountUSDT','map','407604VRJVBF','📅\x20Date\x20end:\x20','test','createPayment','📊\x20Status\x20filter:\x20','getPayouts','4wrwVbN','getShopProfile','convertToUSDT','updateShopProfile','📅\x20Period\x20end:\x20','event','📊\x20Final\x20WHERE\x20conditions:','getPayoutStatistics','createPublicPayment','statusText','updateWallets','KLYME\x20DE','notes','💰\x20Getting\x20payouts\x20with\x20filters:','PaymentService','\x20USDT\x20(total\x20payouts)','getShopPayoutStats','round','filter','all','webhookUrl','parse','wallets','stringify','getTime','10JhtXLU','webhookEvents','desc','payout','set','revenue','network','usdtPolygonWallet','./paymentService','isArray','30d','gatewaySettings','maxPayments','usdtTrcWallet','polygon','TesSoft\x20Payment\x20System/1.0\x20(Test)','currency','📅\x20Date\x20start:\x20','Payment\x20not\x20found','generateDailyStatistics','application/json','availableBalance','Unknown\x20error','txid','country','3367399VwKeTE','aggregate','username','findFirst','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','responseBody','11dOJwTw','telegram','📅\x20Period\x20start:\x20','amount','usdtErcWallet','reduce','merchantUrl','publicKey','update','USDT\x20ERC20','updatePayment','language','usdcPolygonWallet','fullName','sourceCurrency','No\x20webhook\x20URL\x20configured','name','getDate','14rXkHoO','customerName','1586598tDGCoX','\x20USDT','statusCode','currencyService','__esModule','erc20','paymentId','createdAt','shopUrl','PAID','gateway','split','\x20\x20\x20💰\x20Total\x20paid\x20out:\x20','USDT\x20BSC','POST','CoinToPay','ShopService','15023820IKISmq','\x20\x20\x20⏳\x20Awaiting\x20payout:\x20','REJECTED','test_gateway','Test\x20webhook\x20sent\x20successfully\x20(','shop','telegramId','amountIsEditable','\x20payout\x20statistics\x20calculated:'];a53_0x763c=function(){return _0x2f2aa2;};return a53_0x763c();}