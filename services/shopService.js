'use strict';const a52_0x1d2f83=a52_0x2223;(function(_0x2b14aa,_0x2cb029){const _0x4f91d4=a52_0x2223,_0x399079=_0x2b14aa();while(!![]){try{const _0xb7e3f=parseInt(_0x4f91d4(0x141))/0x1+-parseInt(_0x4f91d4(0x104))/0x2*(-parseInt(_0x4f91d4(0x122))/0x3)+-parseInt(_0x4f91d4(0x135))/0x4*(parseInt(_0x4f91d4(0x177))/0x5)+-parseInt(_0x4f91d4(0x187))/0x6*(parseInt(_0x4f91d4(0x137))/0x7)+parseInt(_0x4f91d4(0x163))/0x8+parseInt(_0x4f91d4(0x18e))/0x9*(parseInt(_0x4f91d4(0x144))/0xa)+-parseInt(_0x4f91d4(0x14e))/0xb;if(_0xb7e3f===_0x2cb029)break;else _0x399079['push'](_0x399079['shift']());}catch(_0x3c17db){_0x399079['push'](_0x399079['shift']());}}}(a52_0x2c3c,0x7ee3c));function a52_0x2c3c(){const _0x343b13=['Error\x20parsing\x20webhook\x20events:','KLYME\x20EU','responseBody','message','getPayments','usdcPolygonWallet','getStatistics','KLYME\x20GB','settings','toUpperCase','USD','retryCount','933772SNdPNq','redirectUrl','28MdElKS','txid','gatewaySettings','📊\x20Shop\x20','desc','Rapyd','push','filter','error','Noda','837641hUKzWN','updateShopProfile','getMonth','10elBCbe','reduce','stringify','\x20USDT\x20(current\x20balance)','gateway','Test\x20Gateway','shopUrl','payout','CoinToPay','getShopPayoutStats','3589355DDaJNQ','toISOString','COMPLETED','lte','shopId','../config/database','update','balance','paymentId','getPayoutStatistics','awaitingPayout','deletePayment','ceil','notes','test','amountUSDT','updatePayment','Test\x20webhook\x20sent\x20successfully\x20(','webhookEvents','amountIsEditable','getDate','3275160rDYfvB','getPayouts','payment','PAID','currency','statusText','KLYME\x20DE','paid','customerName','findMany','test_order_123','Webhook\x20returned\x20error:\x20','amount','all','30d','__esModule','gte','usdtErcWallet','\x20\x20\x20💵\x20Available\x20balance:\x20','customerEmail','20MEMdhJ','Shop\x20not\x20found','90d','getPaymentsByShop','wallets','POST','shop','usdtTrcWallet','usdtPolygonWallet','paymentGateways','sourceCurrency','split','paymentService','event','currencyService','country','1025802jLCqRo','getTime','round','count','...','username','\x20\x20\x20📅\x20This\x20month:\x20','5439429gsoRsW','status','webhookUrl','createdAt','customer','publicKey','fullName','__importDefault','Unknown\x20error','defineProperty','findFirst','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','Plisio','2fTWXXu','REJECTED','createPublicPayment','webhookLog','convertToUSDT','availableBalance','parse','isArray','paidAt','telegramId','./currencyService','default','getShopProfile','statusCode','No\x20webhook\x20URL\x20configured','test_gateway','getFullYear','name','revenue','generateDailyStatistics','test_payment_123','thisMonth','findUnique','log','network','map','Failed\x20to\x20send\x20webhook:\x20','gateways','merchantUrl','telegram','1836804IWHdLP','\x20payout\x20statistics\x20calculated:','PENDING','totalPaidOut','testWebhook','dailyPayments','Payment\x20not\x20found'];a52_0x2c3c=function(){return _0x343b13;};return a52_0x2c3c();}var __importDefault=this&&this[a52_0x1d2f83(0x195)]||function(_0x2ca046){return _0x2ca046&&_0x2ca046['__esModule']?_0x2ca046:{'default':_0x2ca046};};function a52_0x2223(_0x4ad449,_0x18071d){const _0x2c3c4d=a52_0x2c3c();return a52_0x2223=function(_0x222390,_0x52b55e){_0x222390=_0x222390-0x101;let _0x5e9cd9=_0x2c3c4d[_0x222390];return _0x5e9cd9;},a52_0x2223(_0x4ad449,_0x18071d);}Object[a52_0x1d2f83(0x197)](exports,a52_0x1d2f83(0x172),{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require(a52_0x1d2f83(0x153))),currencyService_1=require(a52_0x1d2f83(0x10e)),paymentService_1=require('./paymentService');class ShopService{constructor(){const _0xe54a16=a52_0x1d2f83;this[_0xe54a16(0x183)]=new paymentService_1['PaymentService']();}async[a52_0x1d2f83(0x110)](_0x24c149){const _0x47adce=a52_0x1d2f83,_0x3963b6=await database_1[_0x47adce(0x10f)]['shop'][_0x47adce(0x11a)]({'where':{'id':_0x24c149},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x3963b6)throw new Error(_0x47adce(0x178));let _0x2d82c3=[];if(_0x3963b6[_0x47adce(0x131)]?.[_0x47adce(0x160)])try{_0x2d82c3=Array[_0x47adce(0x10b)](_0x3963b6[_0x47adce(0x131)][_0x47adce(0x160)])?_0x3963b6[_0x47adce(0x131)][_0x47adce(0x160)]:JSON[_0x47adce(0x10a)](_0x3963b6['settings'][_0x47adce(0x160)]);}catch(_0x3b7e48){console[_0x47adce(0x13f)](_0x47adce(0x129),_0x3b7e48),_0x2d82c3=[];}return{'id':_0x3963b6['id'],'fullName':_0x3963b6['name'],'username':_0x3963b6[_0x47adce(0x18c)],'telegramId':_0x3963b6['telegram'],'merchantUrl':_0x3963b6[_0x47adce(0x14a)],'gateways':_0x3963b6['paymentGateways']?JSON[_0x47adce(0x10a)](_0x3963b6[_0x47adce(0x180)]):null,'gatewaySettings':_0x3963b6['gatewaySettings']?JSON[_0x47adce(0x10a)](_0x3963b6[_0x47adce(0x139)]):null,'publicKey':_0x3963b6[_0x47adce(0x193)],'webhookUrl':_0x3963b6[_0x47adce(0x131)]?.[_0x47adce(0x190)]||null,'webhookEvents':_0x2d82c3,'wallets':{'usdtPolygonWallet':_0x3963b6['usdtPolygonWallet'],'usdtTrcWallet':_0x3963b6[_0x47adce(0x17e)],'usdtErcWallet':_0x3963b6[_0x47adce(0x174)],'usdcPolygonWallet':_0x3963b6[_0x47adce(0x12e)]},'status':_0x3963b6['status'],'createdAt':_0x3963b6[_0x47adce(0x191)]};}async[a52_0x1d2f83(0x142)](_0x3c03a9,_0x494188){const _0x3e615b=a52_0x1d2f83,_0xfc670d={};_0x494188[_0x3e615b(0x194)]&&(_0xfc670d[_0x3e615b(0x115)]=_0x494188[_0x3e615b(0x194)]);_0x494188[_0x3e615b(0x10d)]!==undefined&&(_0xfc670d[_0x3e615b(0x121)]=_0x494188[_0x3e615b(0x10d)]||null);_0x494188['merchantUrl']&&(_0xfc670d['shopUrl']=_0x494188[_0x3e615b(0x120)]);_0x494188['gateways']&&(_0xfc670d[_0x3e615b(0x180)]=JSON['stringify'](_0x494188[_0x3e615b(0x11f)]));_0x494188[_0x3e615b(0x139)]&&(_0xfc670d['gatewaySettings']=JSON[_0x3e615b(0x146)](_0x494188[_0x3e615b(0x139)]));_0x494188['wallets']&&(_0x494188['wallets'][_0x3e615b(0x17f)]!==undefined&&(_0xfc670d['usdtPolygonWallet']=_0x494188[_0x3e615b(0x17b)][_0x3e615b(0x17f)]||null),_0x494188[_0x3e615b(0x17b)][_0x3e615b(0x17e)]!==undefined&&(_0xfc670d[_0x3e615b(0x17e)]=_0x494188[_0x3e615b(0x17b)]['usdtTrcWallet']||null),_0x494188[_0x3e615b(0x17b)][_0x3e615b(0x174)]!==undefined&&(_0xfc670d[_0x3e615b(0x174)]=_0x494188[_0x3e615b(0x17b)][_0x3e615b(0x174)]||null),_0x494188['wallets'][_0x3e615b(0x12e)]!==undefined&&(_0xfc670d[_0x3e615b(0x12e)]=_0x494188['wallets'][_0x3e615b(0x12e)]||null));const _0x316293=await database_1[_0x3e615b(0x10f)][_0x3e615b(0x17d)][_0x3e615b(0x154)]({'where':{'id':_0x3c03a9},'data':_0xfc670d,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x785a3d=[];if(_0x316293[_0x3e615b(0x131)]?.['webhookEvents'])try{_0x785a3d=Array[_0x3e615b(0x10b)](_0x316293[_0x3e615b(0x131)][_0x3e615b(0x160)])?_0x316293[_0x3e615b(0x131)][_0x3e615b(0x160)]:JSON[_0x3e615b(0x10a)](_0x316293[_0x3e615b(0x131)]['webhookEvents']);}catch(_0x3889e1){console['error'](_0x3e615b(0x129),_0x3889e1),_0x785a3d=[];}return{'id':_0x316293['id'],'fullName':_0x316293[_0x3e615b(0x115)],'username':_0x316293[_0x3e615b(0x18c)],'telegramId':_0x316293[_0x3e615b(0x121)],'merchantUrl':_0x316293['shopUrl'],'gateways':_0x316293['paymentGateways']?JSON[_0x3e615b(0x10a)](_0x316293['paymentGateways']):null,'gatewaySettings':_0x316293[_0x3e615b(0x139)]?JSON['parse'](_0x316293[_0x3e615b(0x139)]):null,'publicKey':_0x316293['publicKey'],'webhookUrl':_0x316293['settings']?.['webhookUrl']||null,'webhookEvents':_0x785a3d,'wallets':{'usdtPolygonWallet':_0x316293['usdtPolygonWallet'],'usdtTrcWallet':_0x316293[_0x3e615b(0x17e)],'usdtErcWallet':_0x316293['usdtErcWallet'],'usdcPolygonWallet':_0x316293[_0x3e615b(0x12e)]},'status':_0x316293[_0x3e615b(0x18f)],'createdAt':_0x316293[_0x3e615b(0x191)]};}async['updateWallets'](_0x1b05c4,_0x5ccd50){const _0x575818=a52_0x1d2f83,_0x3e6236={};_0x5ccd50[_0x575818(0x17f)]!==undefined&&(_0x3e6236[_0x575818(0x17f)]=_0x5ccd50['usdtPolygonWallet']||null),_0x5ccd50['usdtTrcWallet']!==undefined&&(_0x3e6236[_0x575818(0x17e)]=_0x5ccd50[_0x575818(0x17e)]||null),_0x5ccd50[_0x575818(0x174)]!==undefined&&(_0x3e6236[_0x575818(0x174)]=_0x5ccd50[_0x575818(0x174)]||null),_0x5ccd50[_0x575818(0x12e)]!==undefined&&(_0x3e6236['usdcPolygonWallet']=_0x5ccd50[_0x575818(0x12e)]||null),await database_1[_0x575818(0x10f)]['shop'][_0x575818(0x154)]({'where':{'id':_0x1b05c4},'data':_0x3e6236});}async[a52_0x1d2f83(0x126)](_0xab62dd){const _0x439cd0=a52_0x1d2f83,_0x5aafe9=await database_1[_0x439cd0(0x10f)][_0x439cd0(0x17d)][_0x439cd0(0x11a)]({'where':{'id':_0xab62dd},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x5aafe9?.[_0x439cd0(0x131)]?.['webhookUrl'])throw new Error(_0x439cd0(0x112));const _0x3f539f={'event':_0x439cd0(0x15c),'payment':{'id':_0x439cd0(0x118),'order_id':_0x439cd0(0x16d),'gateway':_0x439cd0(0x15c),'amount':0x64,'currency':_0x439cd0(0x133),'status':_0x439cd0(0x16a),'created_at':new Date()[_0x439cd0(0x14f)]()}};try{const _0x4a6bb4=await fetch(_0x5aafe9[_0x439cd0(0x131)]['webhookUrl'],{'method':_0x439cd0(0x17c),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON[_0x439cd0(0x146)](_0x3f539f)});return _0x4a6bb4['ok']?{'success':!![],'message':_0x439cd0(0x15f)+_0x4a6bb4['status']+')'}:{'success':![],'message':_0x439cd0(0x16e)+_0x4a6bb4[_0x439cd0(0x18f)]+'\x20'+_0x4a6bb4[_0x439cd0(0x168)]};}catch(_0x509034){return{'success':![],'message':_0x439cd0(0x11e)+(_0x509034 instanceof Error?_0x509034[_0x439cd0(0x12c)]:_0x439cd0(0x196))};}}async['createPayment'](_0x52d528){const _0x58e580=a52_0x1d2f83;return this['paymentService'][_0x58e580(0x106)]({'public_key':'','gateway':_0x52d528[_0x58e580(0x148)],'order_id':undefined,'amount':_0x52d528[_0x58e580(0x16f)],'currency':_0x52d528[_0x58e580(0x167)],'source_currency':_0x52d528[_0x58e580(0x181)],'usage':_0x52d528['usage'],'expires_at':_0x52d528['expiresAt']?.[_0x58e580(0x14f)](),'success_url':_0x52d528[_0x58e580(0x136)],'fail_url':_0x52d528[_0x58e580(0x136)],'customer_email':_0x52d528[_0x58e580(0x176)],'customer_name':_0x52d528[_0x58e580(0x16b)],'country':_0x52d528[_0x58e580(0x186)],'language':_0x52d528['language'],'amount_is_editable':_0x52d528[_0x58e580(0x161)],'max_payments':_0x52d528['maxPayments'],'customer':_0x52d528[_0x58e580(0x192)]});}async[a52_0x1d2f83(0x12d)](_0xededad,_0x1155c6){const _0x266de5=a52_0x1d2f83;return this[_0x266de5(0x183)][_0x266de5(0x17a)](_0xededad,_0x1155c6);}async['getPaymentById'](_0xb62dd2,_0x88ee47){const _0x4af6e9=a52_0x1d2f83;return this[_0x4af6e9(0x183)]['getPaymentByShopAndId'](_0xb62dd2,_0x88ee47);}async[a52_0x1d2f83(0x15e)](_0x554216,_0xcff68c,_0x2eceb9){const _0x136bb3=a52_0x1d2f83,_0x2ebec8=await database_1[_0x136bb3(0x10f)][_0x136bb3(0x165)]['findFirst']({'where':{'id':_0xcff68c,'shopId':_0x554216}});if(!_0x2ebec8)throw new Error('Payment\x20not\x20found');const _0x3005e4=await database_1[_0x136bb3(0x10f)]['payment'][_0x136bb3(0x154)]({'where':{'id':_0xcff68c},'data':{..._0x2eceb9,'updatedAt':new Date()}});return _0x3005e4;}async[a52_0x1d2f83(0x159)](_0x2eed56,_0x1ecbae){const _0x3e1e69=a52_0x1d2f83,_0x419dd4=await database_1[_0x3e1e69(0x10f)][_0x3e1e69(0x165)][_0x3e1e69(0x101)]({'where':{'id':_0x1ecbae,'shopId':_0x2eed56}});if(!_0x419dd4)throw new Error(_0x3e1e69(0x128));await database_1[_0x3e1e69(0x10f)]['payment']['delete']({'where':{'id':_0x1ecbae}});}async[a52_0x1d2f83(0x164)](_0x2d41a5,_0x8c9c85){const _0x1cf490=a52_0x1d2f83,{page:_0x172e92,limit:_0xadb84f,status:_0x10feb2,method:_0x57bace,dateFrom:_0x220e3c,dateTo:_0x438c0a,periodFrom:_0x52a80c,periodTo:_0x355413}=_0x8c9c85,_0x5779d9=(_0x172e92-0x1)*_0xadb84f,_0x232a9a={'shopId':_0x2d41a5};_0x10feb2&&(_0x232a9a['status']=_0x10feb2[_0x1cf490(0x132)]());_0x57bace&&(_0x232a9a['network']=_0x57bace);if(_0x220e3c||_0x438c0a||_0x52a80c||_0x355413){_0x232a9a['createdAt']={};if(_0x52a80c)_0x232a9a[_0x1cf490(0x191)][_0x1cf490(0x173)]=new Date(_0x52a80c);else _0x220e3c&&(_0x232a9a[_0x1cf490(0x191)][_0x1cf490(0x173)]=new Date(_0x220e3c));if(_0x355413)_0x232a9a[_0x1cf490(0x191)][_0x1cf490(0x151)]=new Date(_0x355413);else _0x438c0a&&(_0x232a9a[_0x1cf490(0x191)][_0x1cf490(0x151)]=new Date(_0x438c0a));}const [_0x4e9974,_0x396c83]=await Promise[_0x1cf490(0x170)]([database_1[_0x1cf490(0x10f)][_0x1cf490(0x14b)]['findMany']({'where':_0x232a9a,'skip':_0x5779d9,'take':_0xadb84f,'orderBy':{'createdAt':'desc'}}),database_1[_0x1cf490(0x10f)][_0x1cf490(0x14b)]['count']({'where':_0x232a9a})]);return{'payouts':_0x4e9974['map'](_0x39e01e=>({'id':_0x39e01e['id'],'amount':_0x39e01e[_0x1cf490(0x16f)],'network':_0x39e01e[_0x1cf490(0x11c)],'status':_0x39e01e[_0x1cf490(0x18f)],'txid':_0x39e01e[_0x1cf490(0x138)],'notes':_0x39e01e['notes'],'createdAt':_0x39e01e[_0x1cf490(0x191)],'paidAt':_0x39e01e[_0x1cf490(0x10c)]})),'pagination':{'page':_0x172e92,'limit':_0xadb84f,'total':_0x396c83,'totalPages':Math['ceil'](_0x396c83/_0xadb84f)}};}async['getPayoutById'](_0x31d196,_0x2feccf){const _0x32dd89=a52_0x1d2f83,_0x3b3a56=await database_1[_0x32dd89(0x10f)][_0x32dd89(0x14b)][_0x32dd89(0x101)]({'where':{'id':_0x2feccf,'shopId':_0x31d196}});if(!_0x3b3a56)return null;return{'id':_0x3b3a56['id'],'amount':_0x3b3a56['amount'],'network':_0x3b3a56[_0x32dd89(0x11c)],'status':_0x3b3a56['status'],'txid':_0x3b3a56[_0x32dd89(0x138)],'notes':_0x3b3a56[_0x32dd89(0x15b)],'createdAt':_0x3b3a56[_0x32dd89(0x191)],'paidAt':_0x3b3a56[_0x32dd89(0x10c)]};}async[a52_0x1d2f83(0x157)](_0x55b394,_0x886772){const _0x2c4b80=a52_0x1d2f83,_0x141aa4=new Date();let _0x48ce75;switch(_0x886772){case'7d':_0x48ce75=new Date(_0x141aa4[_0x2c4b80(0x188)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x2c4b80(0x171):_0x48ce75=new Date(_0x141aa4[_0x2c4b80(0x188)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x2c4b80(0x179):_0x48ce75=new Date(_0x141aa4['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x48ce75=new Date(_0x141aa4[_0x2c4b80(0x188)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x2dfa1,_0x5ab985,_0x2e7bae,_0x3808ea,_0x2c591d,_0x79eff2]=await Promise[_0x2c4b80(0x170)]([database_1[_0x2c4b80(0x10f)][_0x2c4b80(0x14b)][_0x2c4b80(0x18a)]({'where':{'shopId':_0x55b394,'createdAt':{'gte':_0x48ce75}}}),database_1[_0x2c4b80(0x10f)]['payout']['count']({'where':{'shopId':_0x55b394,'status':'COMPLETED','createdAt':{'gte':_0x48ce75}}}),database_1['default']['payout'][_0x2c4b80(0x18a)]({'where':{'shopId':_0x55b394,'status':_0x2c4b80(0x124),'createdAt':{'gte':_0x48ce75}}}),database_1[_0x2c4b80(0x10f)][_0x2c4b80(0x14b)][_0x2c4b80(0x18a)]({'where':{'shopId':_0x55b394,'status':_0x2c4b80(0x105),'createdAt':{'gte':_0x48ce75}}}),database_1[_0x2c4b80(0x10f)][_0x2c4b80(0x14b)][_0x2c4b80(0x16c)]({'where':{'shopId':_0x55b394,'createdAt':{'gte':_0x48ce75}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x2c4b80(0x10f)][_0x2c4b80(0x14b)][_0x2c4b80(0x16c)]({'where':{'shopId':_0x55b394},'take':0xa,'orderBy':{'createdAt':_0x2c4b80(0x13b)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x544546=_0x2c591d[_0x2c4b80(0x145)]((_0x1316c8,_0x5eeaad)=>_0x1316c8+_0x5eeaad['amount'],0x0),_0xd973f1=_0x2c591d[_0x2c4b80(0x13e)](_0x28928a=>_0x28928a['status']===_0x2c4b80(0x150))[_0x2c4b80(0x145)]((_0x256aa6,_0x1e1d0d)=>_0x256aa6+_0x1e1d0d['amount'],0x0),_0x108cfe=_0x2c591d[_0x2c4b80(0x13e)](_0x50310=>_0x50310[_0x2c4b80(0x18f)]===_0x2c4b80(0x124))[_0x2c4b80(0x145)]((_0x16a982,_0x1788c3)=>_0x16a982+_0x1788c3['amount'],0x0),_0x1b667e=_0x2c591d['reduce']((_0xd1eed1,_0x4c4856)=>{const _0x4579e3=_0x2c4b80;return _0xd1eed1[_0x4c4856['network']]=(_0xd1eed1[_0x4c4856[_0x4579e3(0x11c)]]||0x0)+0x1,_0xd1eed1;},{}),_0x5b48f4=_0x2c591d['reduce']((_0x103ea9,_0x54a92f)=>{const _0x20b525=_0x2c4b80;return _0x103ea9[_0x54a92f[_0x20b525(0x18f)]]=(_0x103ea9[_0x54a92f[_0x20b525(0x18f)]]||0x0)+0x1,_0x103ea9;},{});return{'totalPayouts':_0x2dfa1,'completedPayouts':_0x5ab985,'pendingPayouts':_0x2e7bae,'rejectedPayouts':_0x3808ea,'totalAmount':_0x544546,'completedAmount':_0xd973f1,'pendingAmount':_0x108cfe,'payoutsByMethod':_0x1b667e,'payoutsByStatus':_0x5b48f4,'recentPayouts':_0x79eff2[_0x2c4b80(0x11d)](_0x3a2ec8=>({'id':_0x3a2ec8['id'],'shopId':_0x55b394,'amount':_0x3a2ec8['amount'],'method':_0x3a2ec8[_0x2c4b80(0x11c)],'status':_0x3a2ec8[_0x2c4b80(0x18f)],'txid':_0x3a2ec8[_0x2c4b80(0x138)],'createdAt':_0x3a2ec8['createdAt'],'paidAt':_0x3a2ec8[_0x2c4b80(0x10c)]}))};}async['getShopPayoutStats'](_0x2eb371){const _0x3cceca=a52_0x1d2f83;console[_0x3cceca(0x11b)](_0x3cceca(0x102)+_0x2eb371+_0x3cceca(0x18b));const _0x1dd5cf=await database_1[_0x3cceca(0x10f)][_0x3cceca(0x17d)][_0x3cceca(0x11a)]({'where':{'id':_0x2eb371},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1dd5cf)throw new Error(_0x3cceca(0x178));const _0x154610=new Date(),_0x53e519=new Date(_0x154610[_0x3cceca(0x114)](),_0x154610['getMonth'](),0x1),_0xdf8a4c=new Date(_0x154610[_0x3cceca(0x114)](),_0x154610[_0x3cceca(0x143)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0xe8e594=await database_1['default']['payout']['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x2eb371,'createdAt':{'gte':_0x53e519,'lte':_0xdf8a4c},'status':_0x3cceca(0x150)}}),_0x2ada62=_0xe8e594['_sum'][_0x3cceca(0x16f)]||0x0,_0x1d012f={'availableBalance':Math[_0x3cceca(0x189)](_0x1dd5cf[_0x3cceca(0x155)]*0x64)/0x64,'totalPaidOut':Math[_0x3cceca(0x189)](_0x1dd5cf[_0x3cceca(0x125)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x1dd5cf[_0x3cceca(0x155)]*0x64)/0x64,'thisMonth':Math['round'](_0x2ada62*0x64)/0x64};return console[_0x3cceca(0x11b)](_0x3cceca(0x13a)+_0x1dd5cf[_0x3cceca(0x18c)]+_0x3cceca(0x123)),console['log'](_0x3cceca(0x175)+_0x1d012f[_0x3cceca(0x109)]+_0x3cceca(0x147)),console[_0x3cceca(0x11b)]('\x20\x20\x20💰\x20Total\x20paid\x20out:\x20'+_0x1d012f[_0x3cceca(0x125)]+'\x20USDT\x20(total\x20payouts)'),console[_0x3cceca(0x11b)]('\x20\x20\x20⏳\x20Awaiting\x20payout:\x20'+_0x1d012f[_0x3cceca(0x158)]+_0x3cceca(0x147)),console[_0x3cceca(0x11b)](_0x3cceca(0x18d)+_0x1d012f[_0x3cceca(0x119)]+'\x20USDT'),_0x1d012f;}['getGatewayDisplayName'](_0x219895){const _0x40ee6b=a52_0x1d2f83,_0x3131dc={'test_gateway':_0x40ee6b(0x149),'plisio':_0x40ee6b(0x103),'rapyd':_0x40ee6b(0x13c),'noda':_0x40ee6b(0x140),'cointopay':_0x40ee6b(0x14c),'klyme_eu':_0x40ee6b(0x12a),'klyme_gb':_0x40ee6b(0x130),'klyme_de':_0x40ee6b(0x169)};return _0x3131dc[_0x219895]||_0x219895;}async['getPayoutStats'](_0x213bee){const _0x2bbe2d=a52_0x1d2f83;return this[_0x2bbe2d(0x14d)](_0x213bee);}async['getWebhookLogs'](_0x3414d3,_0xe15008){const _0x5c999a=a52_0x1d2f83,{page:_0x399198,limit:_0x28f2ed,paymentId:_0x5576df}=_0xe15008,_0x536439=(_0x399198-0x1)*_0x28f2ed,_0x4eb124={'shopId':_0x3414d3};_0x5576df&&(_0x4eb124[_0x5c999a(0x156)]=_0x5576df);const [_0x5e49b2,_0x4f7048]=await Promise[_0x5c999a(0x170)]([database_1[_0x5c999a(0x10f)][_0x5c999a(0x107)][_0x5c999a(0x16c)]({'where':_0x4eb124,'skip':_0x536439,'take':_0x28f2ed,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x5c999a(0x10f)]['webhookLog']['count']({'where':_0x4eb124})]);return{'logs':_0x5e49b2[_0x5c999a(0x11d)](_0x519ff7=>({'id':_0x519ff7['id'],'paymentId':_0x519ff7[_0x5c999a(0x156)],'shopId':_0x519ff7[_0x5c999a(0x152)],'event':_0x519ff7[_0x5c999a(0x184)],'statusCode':_0x519ff7[_0x5c999a(0x111)],'retryCount':_0x519ff7[_0x5c999a(0x134)],'responseBody':_0x519ff7[_0x5c999a(0x12b)],'createdAt':_0x519ff7[_0x5c999a(0x191)],'payment':_0x519ff7[_0x5c999a(0x165)]})),'pagination':{'page':_0x399198,'limit':_0x28f2ed,'total':_0x4f7048,'totalPages':Math[_0x5c999a(0x15a)](_0x4f7048/_0x28f2ed)}};}async[a52_0x1d2f83(0x12f)](_0x349f12,_0x29389a){const _0x41e7d5=a52_0x1d2f83,_0x170644=new Date();let _0x8261cf;switch(_0x29389a){case'7d':_0x8261cf=new Date(_0x170644[_0x41e7d5(0x188)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x8261cf=new Date(_0x170644[_0x41e7d5(0x188)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x41e7d5(0x179):_0x8261cf=new Date(_0x170644[_0x41e7d5(0x188)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x8261cf=new Date(_0x170644[_0x41e7d5(0x188)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x43004a,_0x2eec19,_0x985b56,_0x4eceb5,_0x4843f8]=await Promise[_0x41e7d5(0x170)]([database_1[_0x41e7d5(0x10f)][_0x41e7d5(0x165)]['count']({'where':{'shopId':_0x349f12,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x8261cf}}}),database_1['default'][_0x41e7d5(0x165)]['count']({'where':{'shopId':_0x349f12,'gateway':{'not':_0x41e7d5(0x113)},'status':_0x41e7d5(0x166),'createdAt':{'gte':_0x8261cf}}}),database_1[_0x41e7d5(0x10f)][_0x41e7d5(0x165)][_0x41e7d5(0x16c)]({'where':{'shopId':_0x349f12,'gateway':{'not':_0x41e7d5(0x113)},'status':_0x41e7d5(0x166),'createdAt':{'gte':_0x8261cf}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default']['payment']['findMany']({'where':{'shopId':_0x349f12,'gateway':{'not':_0x41e7d5(0x113)}},'take':0xa,'orderBy':{'createdAt':_0x41e7d5(0x13b)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x41e7d5(0x10f)][_0x41e7d5(0x165)][_0x41e7d5(0x16c)]({'where':{'shopId':_0x349f12,'gateway':{'not':_0x41e7d5(0x113)},'createdAt':{'gte':_0x8261cf}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x3c6b0c=0x0;for(const _0x43b2bb of _0x985b56){if(_0x43b2bb[_0x41e7d5(0x15d)])_0x3c6b0c+=_0x43b2bb['amountUSDT'];else{const _0x1d0f76=await currencyService_1[_0x41e7d5(0x185)][_0x41e7d5(0x108)](_0x43b2bb[_0x41e7d5(0x16f)],_0x43b2bb['currency']);_0x3c6b0c+=_0x1d0f76;}}const _0x410bb2=this[_0x41e7d5(0x117)](_0x4843f8,_0x8261cf,_0x170644),_0x28cb7d=_0x43004a>0x0?_0x2eec19/_0x43004a*0x64:0x0;return{'totalPayments':_0x43004a,'successfulPayments':_0x2eec19,'totalRevenue':Math['round'](_0x3c6b0c*0x64)/0x64,'conversionRate':Math[_0x41e7d5(0x189)](_0x28cb7d*0x64)/0x64,'dailyRevenue':_0x410bb2['dailyRevenue'],'dailyPayments':_0x410bb2[_0x41e7d5(0x127)],'recentPayments':_0x4eceb5[_0x41e7d5(0x11d)](_0x4b4485=>({'id':_0x4b4485['id'],'gateway':_0x4b4485[_0x41e7d5(0x148)],'amount':_0x4b4485['amount'],'currency':_0x4b4485[_0x41e7d5(0x167)],'status':_0x4b4485[_0x41e7d5(0x18f)],'createdAt':_0x4b4485['createdAt']}))};}['generateDailyStatistics'](_0xd8e6a7,_0x498bba,_0x6dd4a){const _0x4057cc=a52_0x1d2f83,_0x98750a=new Map(),_0x1750b9=new Date(_0x498bba);while(_0x1750b9<=_0x6dd4a){const _0x5717f8=_0x1750b9[_0x4057cc(0x14f)]()['split']('T')[0x0];_0x98750a['set'](_0x5717f8,{'revenue':0x0,'count':0x0}),_0x1750b9['setDate'](_0x1750b9[_0x4057cc(0x162)]()+0x1);}for(const _0x5a9a29 of _0xd8e6a7){const _0x11836a=_0x5a9a29[_0x4057cc(0x191)][_0x4057cc(0x14f)]()[_0x4057cc(0x182)]('T')[0x0],_0x46abd0=_0x98750a['get'](_0x11836a);_0x46abd0&&(_0x46abd0['count']+=0x1,_0x5a9a29['status']===_0x4057cc(0x166)&&_0x5a9a29[_0x4057cc(0x15d)]&&(_0x46abd0['revenue']+=_0x5a9a29[_0x4057cc(0x15d)]));}const _0x4580ec=[],_0x545d92=[];for(const [_0x5a3f7b,_0x10fc95]of _0x98750a){_0x4580ec[_0x4057cc(0x13d)]({'date':_0x5a3f7b,'amount':Math['round'](_0x10fc95[_0x4057cc(0x116)]*0x64)/0x64}),_0x545d92['push']({'date':_0x5a3f7b,'count':_0x10fc95['count']});}return{'dailyRevenue':_0x4580ec,'dailyPayments':_0x545d92};}}exports['ShopService']=ShopService;