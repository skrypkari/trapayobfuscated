'use strict';const a53_0x52ddc9=a53_0x509b;function a53_0x509b(_0x3cf50b,_0x23d4a3){const _0x45b75d=a53_0x45b7();return a53_0x509b=function(_0x509b5a,_0x54cb04){_0x509b5a=_0x509b5a-0x1c0;let _0x373380=_0x45b75d[_0x509b5a];return _0x373380;},a53_0x509b(_0x3cf50b,_0x23d4a3);}(function(_0x23caca,_0x2d0a4a){const _0x56b8ac=a53_0x509b,_0x380195=_0x23caca();while(!![]){try{const _0x28bd24=parseInt(_0x56b8ac(0x1e8))/0x1+-parseInt(_0x56b8ac(0x22c))/0x2+-parseInt(_0x56b8ac(0x1f1))/0x3*(-parseInt(_0x56b8ac(0x24e))/0x4)+parseInt(_0x56b8ac(0x1fb))/0x5*(-parseInt(_0x56b8ac(0x25e))/0x6)+-parseInt(_0x56b8ac(0x232))/0x7*(parseInt(_0x56b8ac(0x1cf))/0x8)+parseInt(_0x56b8ac(0x25f))/0x9+parseInt(_0x56b8ac(0x1d5))/0xa;if(_0x28bd24===_0x2d0a4a)break;else _0x380195['push'](_0x380195['shift']());}catch(_0x1c9c47){_0x380195['push'](_0x380195['shift']());}}}(a53_0x45b7,0x888a7));var __importDefault=this&&this[a53_0x52ddc9(0x1db)]||function(_0x4f0cbb){const _0x2edf08=a53_0x52ddc9;return _0x4f0cbb&&_0x4f0cbb[_0x2edf08(0x218)]?_0x4f0cbb:{'default':_0x4f0cbb};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a53_0x52ddc9(0x21c)]=void 0x0;const database_1=__importDefault(require(a53_0x52ddc9(0x234))),currencyService_1=require(a53_0x52ddc9(0x20c)),paymentService_1=require(a53_0x52ddc9(0x1dd));function a53_0x45b7(){const _0x3db27f=['243353gQOyEJ','findUnique','getPayouts','getTime','count','COMPLETED','get','txid','deletePayment','6813CWDkEl','usdcPolygonWallet','Noda','POST','usdtTrcWallet','USDT\x20TRC20','paid','currencyService','paymentGateways','lte','11855YfsweA','USDT\x20ERC20','paidAt','error','findMany','\x20payout\x20statistics\x20calculated:','No\x20webhook\x20URL\x20configured','PAID','30d','desc','language','telegramId','convertToUSDT','\x20\x20\x20üíµ\x20Available\x20balance:\x20','Plisio','paymentService','shopId','./currencyService','toUpperCase','redirectUrl','test','getPayoutStatistics','amountUSDT','shopUrl','Error\x20parsing\x20webhook\x20events:','name','getShopProfile','PaymentService','wallets','__esModule','usdtErcWallet','round','Shop\x20not\x20found','ShopService','reduce','maxPayments','currency','gatewaySettings','getFullYear','\x20USDT\x20(current\x20balance)','gateway','aggregate','availableBalance','split','username','balance','USDC\x20Polygon','filter','dailyRevenue','1792818OKyRJV','revenue','findFirst','polygon_usdc','TesSoft\x20Payment\x20System/1.0\x20(Test)','amount','149030Hwprzu','status','../config/database','getWebhookLogs','dailyPayments','gte','CoinToPay','payout','push','setDate','_sum','Failed\x20to\x20send\x20webhook:\x20','generateDailyStatistics','shop','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','merchantUrl','\x20USDT\x20(total\x20payouts)','message','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','getMonth','getPayoutStats','isArray','test_payment_123','createPayment','getPaymentsByShop','fullName','webhookEvents','gateways','1044qbsiQo','updateShopProfile','expiresAt','createdAt','country','publicKey','90d','Payment\x20not\x20found','customerEmail','map','all','thisMonth','Test\x20Gateway','delete','payment','createPublicPayment','90ZdHsYB','731529zfdgOS','USDT\x20Polygon','set','update','getShopPayoutStats','amountIsEditable','usdtPolygonWallet','stringify','erc20','totalPaidOut','telegram','\x20USDT','USDT\x20BSC','log','formatNetworkName','toISOString','328EiPGgQ','notes','periodTo','statusCode','test_gateway','usage','14467700ArMZPz','getPaymentById','paymentId','Test\x20webhook\x20sent\x20successfully\x20(','settings','default','__importDefault','application/json','./paymentService','webhookUrl','webhookLog','network','KLYME\x20GB','periodFrom','REJECTED','test_order_123','parse','getDate','\x20\x20\x20üìÖ\x20This\x20month:\x20'];a53_0x45b7=function(){return _0x3db27f;};return a53_0x45b7();}class ShopService{constructor(){const _0x3ceb6f=a53_0x52ddc9;this[_0x3ceb6f(0x20a)]=new paymentService_1[(_0x3ceb6f(0x216))]();}async[a53_0x52ddc9(0x215)](_0x174d8a){const _0x5bb281=a53_0x52ddc9,_0x6fef25=await database_1[_0x5bb281(0x1da)][_0x5bb281(0x23f)][_0x5bb281(0x1e9)]({'where':{'id':_0x174d8a},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x6fef25)throw new Error(_0x5bb281(0x21b));let _0x5de4bc=[];if(_0x6fef25[_0x5bb281(0x1d9)]?.[_0x5bb281(0x24c)])try{_0x5de4bc=Array['isArray'](_0x6fef25['settings'][_0x5bb281(0x24c)])?_0x6fef25['settings'][_0x5bb281(0x24c)]:JSON[_0x5bb281(0x1e5)](_0x6fef25[_0x5bb281(0x1d9)][_0x5bb281(0x24c)]);}catch(_0x204640){console[_0x5bb281(0x1fe)]('Error\x20parsing\x20webhook\x20events:',_0x204640),_0x5de4bc=[];}return{'id':_0x6fef25['id'],'fullName':_0x6fef25[_0x5bb281(0x214)],'username':_0x6fef25[_0x5bb281(0x227)],'telegramId':_0x6fef25[_0x5bb281(0x1c9)],'merchantUrl':_0x6fef25['shopUrl'],'gateways':_0x6fef25[_0x5bb281(0x1f9)]?JSON['parse'](_0x6fef25['paymentGateways']):null,'gatewaySettings':_0x6fef25[_0x5bb281(0x220)]?JSON[_0x5bb281(0x1e5)](_0x6fef25[_0x5bb281(0x220)]):null,'publicKey':_0x6fef25[_0x5bb281(0x253)],'webhookUrl':_0x6fef25[_0x5bb281(0x1d9)]?.['webhookUrl']||null,'webhookEvents':_0x5de4bc,'wallets':{'usdtPolygonWallet':_0x6fef25[_0x5bb281(0x1c5)],'usdtTrcWallet':_0x6fef25[_0x5bb281(0x1f5)],'usdtErcWallet':_0x6fef25[_0x5bb281(0x219)],'usdcPolygonWallet':_0x6fef25[_0x5bb281(0x1f2)]},'status':_0x6fef25['status'],'createdAt':_0x6fef25[_0x5bb281(0x251)]};}async[a53_0x52ddc9(0x24f)](_0x2b5905,_0x1a14b9){const _0x31d8f6=a53_0x52ddc9,_0x43cf70={};_0x1a14b9[_0x31d8f6(0x24b)]&&(_0x43cf70[_0x31d8f6(0x214)]=_0x1a14b9[_0x31d8f6(0x24b)]);_0x1a14b9[_0x31d8f6(0x206)]!==undefined&&(_0x43cf70[_0x31d8f6(0x1c9)]=_0x1a14b9[_0x31d8f6(0x206)]||null);_0x1a14b9[_0x31d8f6(0x241)]&&(_0x43cf70[_0x31d8f6(0x212)]=_0x1a14b9[_0x31d8f6(0x241)]);_0x1a14b9[_0x31d8f6(0x24d)]&&(_0x43cf70[_0x31d8f6(0x1f9)]=JSON[_0x31d8f6(0x1c6)](_0x1a14b9[_0x31d8f6(0x24d)]));_0x1a14b9[_0x31d8f6(0x220)]&&(_0x43cf70[_0x31d8f6(0x220)]=JSON[_0x31d8f6(0x1c6)](_0x1a14b9['gatewaySettings']));_0x1a14b9[_0x31d8f6(0x217)]&&(_0x1a14b9[_0x31d8f6(0x217)][_0x31d8f6(0x1c5)]!==undefined&&(_0x43cf70['usdtPolygonWallet']=_0x1a14b9[_0x31d8f6(0x217)][_0x31d8f6(0x1c5)]||null),_0x1a14b9[_0x31d8f6(0x217)]['usdtTrcWallet']!==undefined&&(_0x43cf70[_0x31d8f6(0x1f5)]=_0x1a14b9[_0x31d8f6(0x217)]['usdtTrcWallet']||null),_0x1a14b9[_0x31d8f6(0x217)][_0x31d8f6(0x219)]!==undefined&&(_0x43cf70[_0x31d8f6(0x219)]=_0x1a14b9[_0x31d8f6(0x217)]['usdtErcWallet']||null),_0x1a14b9[_0x31d8f6(0x217)][_0x31d8f6(0x1f2)]!==undefined&&(_0x43cf70[_0x31d8f6(0x1f2)]=_0x1a14b9['wallets']['usdcPolygonWallet']||null));const _0x58ef8a=await database_1['default']['shop'][_0x31d8f6(0x1c2)]({'where':{'id':_0x2b5905},'data':_0x43cf70,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x94c5f7=[];if(_0x58ef8a[_0x31d8f6(0x1d9)]?.[_0x31d8f6(0x24c)])try{_0x94c5f7=Array[_0x31d8f6(0x247)](_0x58ef8a[_0x31d8f6(0x1d9)]['webhookEvents'])?_0x58ef8a[_0x31d8f6(0x1d9)][_0x31d8f6(0x24c)]:JSON['parse'](_0x58ef8a['settings'][_0x31d8f6(0x24c)]);}catch(_0x360cff){console['error'](_0x31d8f6(0x213),_0x360cff),_0x94c5f7=[];}return{'id':_0x58ef8a['id'],'fullName':_0x58ef8a[_0x31d8f6(0x214)],'username':_0x58ef8a[_0x31d8f6(0x227)],'telegramId':_0x58ef8a[_0x31d8f6(0x1c9)],'merchantUrl':_0x58ef8a[_0x31d8f6(0x212)],'gateways':_0x58ef8a[_0x31d8f6(0x1f9)]?JSON[_0x31d8f6(0x1e5)](_0x58ef8a['paymentGateways']):null,'gatewaySettings':_0x58ef8a[_0x31d8f6(0x220)]?JSON[_0x31d8f6(0x1e5)](_0x58ef8a[_0x31d8f6(0x220)]):null,'publicKey':_0x58ef8a[_0x31d8f6(0x253)],'webhookUrl':_0x58ef8a['settings']?.['webhookUrl']||null,'webhookEvents':_0x94c5f7,'wallets':{'usdtPolygonWallet':_0x58ef8a['usdtPolygonWallet'],'usdtTrcWallet':_0x58ef8a[_0x31d8f6(0x1f5)],'usdtErcWallet':_0x58ef8a['usdtErcWallet'],'usdcPolygonWallet':_0x58ef8a[_0x31d8f6(0x1f2)]},'status':_0x58ef8a['status'],'createdAt':_0x58ef8a['createdAt']};}async['updateWallets'](_0x1db61b,_0x50ee31){const _0x19e726=a53_0x52ddc9,_0x508cfd={};_0x50ee31[_0x19e726(0x1c5)]!==undefined&&(_0x508cfd['usdtPolygonWallet']=_0x50ee31[_0x19e726(0x1c5)]||null),_0x50ee31[_0x19e726(0x1f5)]!==undefined&&(_0x508cfd[_0x19e726(0x1f5)]=_0x50ee31[_0x19e726(0x1f5)]||null),_0x50ee31[_0x19e726(0x219)]!==undefined&&(_0x508cfd[_0x19e726(0x219)]=_0x50ee31[_0x19e726(0x219)]||null),_0x50ee31['usdcPolygonWallet']!==undefined&&(_0x508cfd[_0x19e726(0x1f2)]=_0x50ee31[_0x19e726(0x1f2)]||null),await database_1['default'][_0x19e726(0x23f)]['update']({'where':{'id':_0x1db61b},'data':_0x508cfd});}async['testWebhook'](_0x20ba37){const _0x193a74=a53_0x52ddc9,_0x261514=await database_1[_0x193a74(0x1da)]['shop'][_0x193a74(0x1e9)]({'where':{'id':_0x20ba37},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x261514?.[_0x193a74(0x1d9)]?.['webhookUrl'])throw new Error(_0x193a74(0x201));const _0x187853={'event':_0x193a74(0x20f),'payment':{'id':_0x193a74(0x248),'order_id':_0x193a74(0x1e4),'gateway':_0x193a74(0x20f),'amount':0x64,'currency':'USD','status':_0x193a74(0x1f7),'created_at':new Date()['toISOString']()}};try{const _0x342e4f=await fetch(_0x261514[_0x193a74(0x1d9)][_0x193a74(0x1de)],{'method':_0x193a74(0x1f4),'headers':{'Content-Type':_0x193a74(0x1dc),'User-Agent':_0x193a74(0x230)},'body':JSON[_0x193a74(0x1c6)](_0x187853)});return _0x342e4f['ok']?{'success':!![],'message':_0x193a74(0x1d8)+_0x342e4f[_0x193a74(0x233)]+')'}:{'success':![],'message':'Webhook\x20returned\x20error:\x20'+_0x342e4f[_0x193a74(0x233)]+'\x20'+_0x342e4f['statusText']};}catch(_0xdc7dd8){return{'success':![],'message':_0x193a74(0x23d)+(_0xdc7dd8 instanceof Error?_0xdc7dd8[_0x193a74(0x243)]:'Unknown\x20error')};}}async[a53_0x52ddc9(0x249)](_0x3d9cd5){const _0x36876f=a53_0x52ddc9;return this[_0x36876f(0x20a)][_0x36876f(0x25d)]({'public_key':'','gateway':_0x3d9cd5[_0x36876f(0x223)],'order_id':undefined,'amount':_0x3d9cd5['amount'],'currency':_0x3d9cd5[_0x36876f(0x21f)],'source_currency':_0x3d9cd5['sourceCurrency'],'usage':_0x3d9cd5[_0x36876f(0x1d4)],'expires_at':_0x3d9cd5[_0x36876f(0x250)]?.[_0x36876f(0x1ce)](),'success_url':_0x3d9cd5[_0x36876f(0x20e)],'fail_url':_0x3d9cd5[_0x36876f(0x20e)],'customer_email':_0x3d9cd5[_0x36876f(0x256)],'customer_name':_0x3d9cd5['customerName'],'country':_0x3d9cd5[_0x36876f(0x252)],'language':_0x3d9cd5[_0x36876f(0x205)],'amount_is_editable':_0x3d9cd5[_0x36876f(0x1c4)],'max_payments':_0x3d9cd5[_0x36876f(0x21e)],'customer':_0x3d9cd5['customer']});}async['getPayments'](_0x3c1741,_0x1ef8e7){const _0x5613bc=a53_0x52ddc9;return this[_0x5613bc(0x20a)][_0x5613bc(0x24a)](_0x3c1741,_0x1ef8e7);}async[a53_0x52ddc9(0x1d6)](_0x3aee41,_0x23520a){const _0x54ce07=a53_0x52ddc9;return this[_0x54ce07(0x20a)]['getPaymentByShopAndId'](_0x3aee41,_0x23520a);}async['updatePayment'](_0x4af329,_0x31fa06,_0x4ddf1b){const _0x291cb2=a53_0x52ddc9,_0x1cf6f7=await database_1[_0x291cb2(0x1da)]['payment'][_0x291cb2(0x22e)]({'where':{'id':_0x31fa06,'shopId':_0x4af329}});if(!_0x1cf6f7)throw new Error(_0x291cb2(0x255));const _0x13c87e=await database_1[_0x291cb2(0x1da)]['payment']['update']({'where':{'id':_0x31fa06},'data':{..._0x4ddf1b,'updatedAt':new Date()}});return _0x13c87e;}async[a53_0x52ddc9(0x1f0)](_0x20e3c1,_0x3b3ed8){const _0x59a7ec=a53_0x52ddc9,_0x270258=await database_1['default'][_0x59a7ec(0x25c)][_0x59a7ec(0x22e)]({'where':{'id':_0x3b3ed8,'shopId':_0x20e3c1}});if(!_0x270258)throw new Error(_0x59a7ec(0x255));await database_1[_0x59a7ec(0x1da)][_0x59a7ec(0x25c)][_0x59a7ec(0x25b)]({'where':{'id':_0x3b3ed8}});}[a53_0x52ddc9(0x1cd)](_0x2b74a0){const _0x288eb1=a53_0x52ddc9,_0x31ef22={'polygon':_0x288eb1(0x1c0),'trc20':_0x288eb1(0x1f6),'erc20':_0x288eb1(0x1fc),'bsc':_0x288eb1(0x1cb),'polygon_usdc':_0x288eb1(0x229)};return _0x31ef22[_0x2b74a0]||_0x2b74a0;}async[a53_0x52ddc9(0x1ea)](_0x3a710f,_0x31b845){const _0x17a7be=a53_0x52ddc9,{page:_0x444bcf,limit:_0x5154e8,status:_0x398bb9,method:_0x45f333,dateFrom:_0x3e2b9b,dateTo:_0x5a80f2,periodFrom:_0x157eda,periodTo:_0x5f15d8}=_0x31b845,_0x3f4a2d=(_0x444bcf-0x1)*_0x5154e8,_0x499c10={'shopId':_0x3a710f};_0x398bb9&&(_0x499c10[_0x17a7be(0x233)]=_0x398bb9[_0x17a7be(0x20d)]());_0x45f333&&(_0x499c10['network']=_0x45f333);if(_0x3e2b9b||_0x5a80f2||_0x157eda||_0x5f15d8){_0x499c10['createdAt']={};if(_0x157eda)_0x499c10[_0x17a7be(0x251)][_0x17a7be(0x237)]=new Date(_0x157eda);else _0x3e2b9b&&(_0x499c10[_0x17a7be(0x251)][_0x17a7be(0x237)]=new Date(_0x3e2b9b));if(_0x5f15d8)_0x499c10[_0x17a7be(0x251)][_0x17a7be(0x1fa)]=new Date(_0x5f15d8);else _0x5a80f2&&(_0x499c10[_0x17a7be(0x251)][_0x17a7be(0x1fa)]=new Date(_0x5a80f2));}const [_0x1a4ff7,_0x175879]=await Promise[_0x17a7be(0x258)]([database_1['default']['payout'][_0x17a7be(0x1ff)]({'where':_0x499c10,'skip':_0x3f4a2d,'take':_0x5154e8,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default']['payout']['count']({'where':_0x499c10})]);return{'payouts':_0x1a4ff7['map'](_0x27fd3d=>{const _0x2618c0=_0x17a7be;let _0x5de6d1=null;switch(_0x27fd3d['network']){case'polygon':_0x5de6d1=_0x27fd3d[_0x2618c0(0x23f)][_0x2618c0(0x1c5)];break;case'trc20':_0x5de6d1=_0x27fd3d[_0x2618c0(0x23f)][_0x2618c0(0x1f5)];break;case _0x2618c0(0x1c7):_0x5de6d1=_0x27fd3d['shop']['usdtErcWallet'];break;case _0x2618c0(0x22f):_0x5de6d1=_0x27fd3d[_0x2618c0(0x23f)]['usdcPolygonWallet'];break;}return{'id':_0x27fd3d['id'],'amount':_0x27fd3d[_0x2618c0(0x231)],'network':this[_0x2618c0(0x1cd)](_0x27fd3d['network']),'wallet':_0x5de6d1,'status':_0x27fd3d[_0x2618c0(0x233)],'txid':_0x27fd3d[_0x2618c0(0x1ef)],'notes':_0x27fd3d['notes'],'periodFrom':_0x27fd3d[_0x2618c0(0x1e2)],'periodTo':_0x27fd3d[_0x2618c0(0x1d1)],'createdAt':_0x27fd3d[_0x2618c0(0x251)],'paidAt':_0x27fd3d[_0x2618c0(0x1fd)]};}),'pagination':{'page':_0x444bcf,'limit':_0x5154e8,'total':_0x175879,'totalPages':Math['ceil'](_0x175879/_0x5154e8)}};}async['getPayoutById'](_0x595877,_0x509a5f){const _0x568090=a53_0x52ddc9,_0x5e6b93=await database_1[_0x568090(0x1da)]['payout'][_0x568090(0x22e)]({'where':{'id':_0x509a5f,'shopId':_0x595877}});if(!_0x5e6b93)return null;return{'id':_0x5e6b93['id'],'amount':_0x5e6b93[_0x568090(0x231)],'network':_0x5e6b93[_0x568090(0x1e0)],'status':_0x5e6b93[_0x568090(0x233)],'txid':_0x5e6b93['txid'],'notes':_0x5e6b93[_0x568090(0x1d0)],'createdAt':_0x5e6b93[_0x568090(0x251)],'paidAt':_0x5e6b93[_0x568090(0x1fd)]};}async[a53_0x52ddc9(0x210)](_0x2df043,_0x173953){const _0x1d38f9=a53_0x52ddc9,_0x422599=new Date();let _0x29d2b0;switch(_0x173953){case'7d':_0x29d2b0=new Date(_0x422599[_0x1d38f9(0x1eb)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x1d38f9(0x203):_0x29d2b0=new Date(_0x422599[_0x1d38f9(0x1eb)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x1d38f9(0x254):_0x29d2b0=new Date(_0x422599[_0x1d38f9(0x1eb)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x29d2b0=new Date(_0x422599[_0x1d38f9(0x1eb)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x45bc80,_0x51b71e,_0x23cdb7,_0x23326d,_0x3413d8,_0x243e35]=await Promise[_0x1d38f9(0x258)]([database_1['default'][_0x1d38f9(0x239)]['count']({'where':{'shopId':_0x2df043,'createdAt':{'gte':_0x29d2b0}}}),database_1[_0x1d38f9(0x1da)]['payout'][_0x1d38f9(0x1ec)]({'where':{'shopId':_0x2df043,'status':_0x1d38f9(0x1ed),'createdAt':{'gte':_0x29d2b0}}}),database_1[_0x1d38f9(0x1da)][_0x1d38f9(0x239)]['count']({'where':{'shopId':_0x2df043,'status':'PENDING','createdAt':{'gte':_0x29d2b0}}}),database_1['default'][_0x1d38f9(0x239)][_0x1d38f9(0x1ec)]({'where':{'shopId':_0x2df043,'status':_0x1d38f9(0x1e3),'createdAt':{'gte':_0x29d2b0}}}),database_1[_0x1d38f9(0x1da)][_0x1d38f9(0x239)][_0x1d38f9(0x1ff)]({'where':{'shopId':_0x2df043,'createdAt':{'gte':_0x29d2b0}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x1d38f9(0x1da)][_0x1d38f9(0x239)][_0x1d38f9(0x1ff)]({'where':{'shopId':_0x2df043},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x1116c2=_0x3413d8[_0x1d38f9(0x21d)]((_0x33eeab,_0x3eac1e)=>_0x33eeab+_0x3eac1e[_0x1d38f9(0x231)],0x0),_0x40cfa7=_0x3413d8['filter'](_0x31314c=>_0x31314c[_0x1d38f9(0x233)]===_0x1d38f9(0x1ed))[_0x1d38f9(0x21d)]((_0x2d5496,_0x3f6d96)=>_0x2d5496+_0x3f6d96[_0x1d38f9(0x231)],0x0),_0x38a941=_0x3413d8[_0x1d38f9(0x22a)](_0x51792c=>_0x51792c[_0x1d38f9(0x233)]==='PENDING')['reduce']((_0x3a4317,_0x3f9068)=>_0x3a4317+_0x3f9068[_0x1d38f9(0x231)],0x0),_0x593519=_0x3413d8['reduce']((_0x457e08,_0x278d46)=>{const _0x49291d=_0x1d38f9;return _0x457e08[_0x278d46['network']]=(_0x457e08[_0x278d46[_0x49291d(0x1e0)]]||0x0)+0x1,_0x457e08;},{}),_0x2896d7=_0x3413d8['reduce']((_0x7b6b5e,_0x1b364f)=>{const _0x5f309d=_0x1d38f9;return _0x7b6b5e[_0x1b364f[_0x5f309d(0x233)]]=(_0x7b6b5e[_0x1b364f[_0x5f309d(0x233)]]||0x0)+0x1,_0x7b6b5e;},{});return{'totalPayouts':_0x45bc80,'completedPayouts':_0x51b71e,'pendingPayouts':_0x23cdb7,'rejectedPayouts':_0x23326d,'totalAmount':_0x1116c2,'completedAmount':_0x40cfa7,'pendingAmount':_0x38a941,'payoutsByMethod':_0x593519,'payoutsByStatus':_0x2896d7,'recentPayouts':_0x243e35[_0x1d38f9(0x257)](_0x348b7b=>({'id':_0x348b7b['id'],'shopId':_0x2df043,'amount':_0x348b7b[_0x1d38f9(0x231)],'method':_0x348b7b['network'],'status':_0x348b7b['status'],'txid':_0x348b7b[_0x1d38f9(0x1ef)],'createdAt':_0x348b7b[_0x1d38f9(0x251)],'paidAt':_0x348b7b[_0x1d38f9(0x1fd)]}))};}async['getShopPayoutStats'](_0x49ed56){const _0x5e7abd=a53_0x52ddc9;console[_0x5e7abd(0x1cc)](_0x5e7abd(0x244)+_0x49ed56+'...');const _0x52534c=await database_1[_0x5e7abd(0x1da)][_0x5e7abd(0x23f)][_0x5e7abd(0x1e9)]({'where':{'id':_0x49ed56},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x52534c)throw new Error('Shop\x20not\x20found');const _0x4a459c=new Date(),_0x179e2d=new Date(_0x4a459c[_0x5e7abd(0x221)](),_0x4a459c[_0x5e7abd(0x245)](),0x1),_0x2dcfb0=new Date(_0x4a459c['getFullYear'](),_0x4a459c[_0x5e7abd(0x245)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x35c493=await database_1[_0x5e7abd(0x1da)][_0x5e7abd(0x239)][_0x5e7abd(0x224)]({'_sum':{'amount':!![]},'where':{'shopId':_0x49ed56,'createdAt':{'gte':_0x179e2d,'lte':_0x2dcfb0},'status':_0x5e7abd(0x1ed)}}),_0x259ef5=_0x35c493[_0x5e7abd(0x23c)]['amount']||0x0,_0x255f48={'availableBalance':Math[_0x5e7abd(0x21a)](_0x52534c[_0x5e7abd(0x228)]*0x64)/0x64,'totalPaidOut':Math[_0x5e7abd(0x21a)](_0x52534c[_0x5e7abd(0x1c8)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x52534c[_0x5e7abd(0x228)]*0x64)/0x64,'thisMonth':Math[_0x5e7abd(0x21a)](_0x259ef5*0x64)/0x64};return console[_0x5e7abd(0x1cc)]('üìä\x20Shop\x20'+_0x52534c['username']+_0x5e7abd(0x200)),console[_0x5e7abd(0x1cc)](_0x5e7abd(0x208)+_0x255f48[_0x5e7abd(0x225)]+'\x20USDT\x20(current\x20balance)'),console[_0x5e7abd(0x1cc)]('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x255f48[_0x5e7abd(0x1c8)]+_0x5e7abd(0x242)),console[_0x5e7abd(0x1cc)](_0x5e7abd(0x240)+_0x255f48['awaitingPayout']+_0x5e7abd(0x222)),console[_0x5e7abd(0x1cc)](_0x5e7abd(0x1e7)+_0x255f48[_0x5e7abd(0x259)]+_0x5e7abd(0x1ca)),_0x255f48;}['getGatewayDisplayName'](_0x594f13){const _0x4a13b9=a53_0x52ddc9,_0x1c2df3={'test_gateway':_0x4a13b9(0x25a),'plisio':_0x4a13b9(0x209),'rapyd':'Rapyd','noda':_0x4a13b9(0x1f3),'cointopay':_0x4a13b9(0x238),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x4a13b9(0x1e1),'klyme_de':'KLYME\x20DE'};return _0x1c2df3[_0x594f13]||_0x594f13;}async[a53_0x52ddc9(0x246)](_0x3946c4){const _0x5238c3=a53_0x52ddc9;return this[_0x5238c3(0x1c3)](_0x3946c4);}async[a53_0x52ddc9(0x235)](_0x5bcf47,_0x5c9526){const _0x3d40ea=a53_0x52ddc9,{page:_0x481a9c,limit:_0x2329b0,paymentId:_0x5876a6}=_0x5c9526,_0x1ca6d1=(_0x481a9c-0x1)*_0x2329b0,_0x303507={'shopId':_0x5bcf47};_0x5876a6&&(_0x303507[_0x3d40ea(0x1d7)]=_0x5876a6);const [_0x265e87,_0x343c39]=await Promise['all']([database_1['default'][_0x3d40ea(0x1df)][_0x3d40ea(0x1ff)]({'where':_0x303507,'skip':_0x1ca6d1,'take':_0x2329b0,'orderBy':{'createdAt':_0x3d40ea(0x204)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x3d40ea(0x1da)]['webhookLog'][_0x3d40ea(0x1ec)]({'where':_0x303507})]);return{'logs':_0x265e87['map'](_0x3d45e2=>({'id':_0x3d45e2['id'],'paymentId':_0x3d45e2[_0x3d40ea(0x1d7)],'shopId':_0x3d45e2[_0x3d40ea(0x20b)],'event':_0x3d45e2['event'],'statusCode':_0x3d45e2[_0x3d40ea(0x1d2)],'retryCount':_0x3d45e2['retryCount'],'responseBody':_0x3d45e2['responseBody'],'createdAt':_0x3d45e2[_0x3d40ea(0x251)],'payment':_0x3d45e2[_0x3d40ea(0x25c)]})),'pagination':{'page':_0x481a9c,'limit':_0x2329b0,'total':_0x343c39,'totalPages':Math['ceil'](_0x343c39/_0x2329b0)}};}async['getStatistics'](_0x562d8b,_0x375a8f){const _0x1e05dc=a53_0x52ddc9,_0x2a6620=new Date();let _0x15f49e;switch(_0x375a8f){case'7d':_0x15f49e=new Date(_0x2a6620['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x15f49e=new Date(_0x2a6620['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x1e05dc(0x254):_0x15f49e=new Date(_0x2a6620['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x15f49e=new Date(_0x2a6620[_0x1e05dc(0x1eb)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x1eb8b3,_0x282dba,_0x1bd992,_0x2bf607,_0x48257e]=await Promise['all']([database_1[_0x1e05dc(0x1da)][_0x1e05dc(0x25c)][_0x1e05dc(0x1ec)]({'where':{'shopId':_0x562d8b,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x15f49e}}}),database_1['default'][_0x1e05dc(0x25c)][_0x1e05dc(0x1ec)]({'where':{'shopId':_0x562d8b,'gateway':{'not':_0x1e05dc(0x1d3)},'status':_0x1e05dc(0x202),'createdAt':{'gte':_0x15f49e}}}),database_1[_0x1e05dc(0x1da)][_0x1e05dc(0x25c)][_0x1e05dc(0x1ff)]({'where':{'shopId':_0x562d8b,'gateway':{'not':_0x1e05dc(0x1d3)},'status':_0x1e05dc(0x202),'createdAt':{'gte':_0x15f49e}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default'][_0x1e05dc(0x25c)][_0x1e05dc(0x1ff)]({'where':{'shopId':_0x562d8b,'gateway':{'not':_0x1e05dc(0x1d3)}},'take':0xa,'orderBy':{'createdAt':_0x1e05dc(0x204)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x1e05dc(0x1da)][_0x1e05dc(0x25c)][_0x1e05dc(0x1ff)]({'where':{'shopId':_0x562d8b,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x15f49e}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x2af545=0x0;for(const _0x11c109 of _0x1bd992){if(_0x11c109[_0x1e05dc(0x211)])_0x2af545+=_0x11c109['amountUSDT'];else{const _0x26f32a=await currencyService_1[_0x1e05dc(0x1f8)][_0x1e05dc(0x207)](_0x11c109['amount'],_0x11c109[_0x1e05dc(0x21f)]);_0x2af545+=_0x26f32a;}}const _0x509bd7=this[_0x1e05dc(0x23e)](_0x48257e,_0x15f49e,_0x2a6620),_0x15e839=_0x1eb8b3>0x0?_0x282dba/_0x1eb8b3*0x64:0x0;return{'totalPayments':_0x1eb8b3,'successfulPayments':_0x282dba,'totalRevenue':Math[_0x1e05dc(0x21a)](_0x2af545*0x64)/0x64,'conversionRate':Math['round'](_0x15e839*0x64)/0x64,'dailyRevenue':_0x509bd7[_0x1e05dc(0x22b)],'dailyPayments':_0x509bd7[_0x1e05dc(0x236)],'recentPayments':_0x2bf607[_0x1e05dc(0x257)](_0x3dded8=>({'id':_0x3dded8['id'],'gateway':_0x3dded8[_0x1e05dc(0x223)],'amount':_0x3dded8['amount'],'currency':_0x3dded8[_0x1e05dc(0x21f)],'status':_0x3dded8[_0x1e05dc(0x233)],'createdAt':_0x3dded8[_0x1e05dc(0x251)]}))};}[a53_0x52ddc9(0x23e)](_0x379399,_0x2102a0,_0x338157){const _0x2f695a=a53_0x52ddc9,_0x1e5ad7=new Map(),_0x19ed7c=new Date(_0x2102a0);while(_0x19ed7c<=_0x338157){const _0x2f8732=_0x19ed7c['toISOString']()['split']('T')[0x0];_0x1e5ad7[_0x2f695a(0x1c1)](_0x2f8732,{'revenue':0x0,'count':0x0}),_0x19ed7c[_0x2f695a(0x23b)](_0x19ed7c[_0x2f695a(0x1e6)]()+0x1);}for(const _0x37601a of _0x379399){const _0x462d47=_0x37601a[_0x2f695a(0x251)]['toISOString']()[_0x2f695a(0x226)]('T')[0x0],_0x1c7495=_0x1e5ad7[_0x2f695a(0x1ee)](_0x462d47);_0x1c7495&&(_0x1c7495[_0x2f695a(0x1ec)]+=0x1,_0x37601a[_0x2f695a(0x233)]===_0x2f695a(0x202)&&_0x37601a[_0x2f695a(0x211)]&&(_0x1c7495[_0x2f695a(0x22d)]+=_0x37601a[_0x2f695a(0x211)]));}const _0x28d243=[],_0x5e279a=[];for(const [_0x48dcc5,_0x244ff5]of _0x1e5ad7){_0x28d243[_0x2f695a(0x23a)]({'date':_0x48dcc5,'amount':Math[_0x2f695a(0x21a)](_0x244ff5[_0x2f695a(0x22d)]*0x64)/0x64}),_0x5e279a['push']({'date':_0x48dcc5,'count':_0x244ff5[_0x2f695a(0x1ec)]});}return{'dailyRevenue':_0x28d243,'dailyPayments':_0x5e279a};}}exports[a53_0x52ddc9(0x21c)]=ShopService;