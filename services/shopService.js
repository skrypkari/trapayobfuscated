'use strict';const a52_0x287632=a52_0x40fb;(function(_0xe04ac6,_0x4dde13){const _0x6ecb17=a52_0x40fb,_0x1471dc=_0xe04ac6();while(!![]){try{const _0x5e56cb=-parseInt(_0x6ecb17(0x18d))/0x1+-parseInt(_0x6ecb17(0x182))/0x2+-parseInt(_0x6ecb17(0x199))/0x3+parseInt(_0x6ecb17(0x17f))/0x4+parseInt(_0x6ecb17(0x163))/0x5+parseInt(_0x6ecb17(0x16f))/0x6*(parseInt(_0x6ecb17(0x116))/0x7)+parseInt(_0x6ecb17(0x153))/0x8;if(_0x5e56cb===_0x4dde13)break;else _0x1471dc['push'](_0x1471dc['shift']());}catch(_0x34e36a){_0x1471dc['push'](_0x1471dc['shift']());}}}(a52_0x13e9,0x6780e));var __importDefault=this&&this[a52_0x287632(0x143)]||function(_0x17db6a){return _0x17db6a&&_0x17db6a['__esModule']?_0x17db6a:{'default':_0x17db6a};};Object[a52_0x287632(0x1a3)](exports,'__esModule',{'value':!![]}),exports[a52_0x287632(0x113)]=void 0x0;const database_1=__importDefault(require(a52_0x287632(0x15f))),currencyService_1=require(a52_0x287632(0x191)),paymentService_1=require(a52_0x287632(0x17c));function a52_0x13e9(){const _0x34def8=['KLYME\x20DE','telegram','./paymentService','paymentService','getShopPayoutStats','2530872RxIuaK','name','test_gateway','788520rnJviM','webhookEvents','isArray','notes','usdcPolygonWallet','amountIsEditable','message','getShopProfile','TesSoft\x20Payment\x20System/1.0\x20(Test)','country','findFirst','497051tBnIby','Error\x20parsing\x20webhook\x20events:','availableBalance','customer','./currencyService','split','KLYME\x20EU','Test\x20Gateway','fullName','currency','gateway','balance','1438356okZwlZ','dailyPayments','asc','test','responseBody','totalPaidOut','network','Failed\x20to\x20send\x20webhook:\x20','Payment\x20not\x20found','getPayouts','defineProperty','statusCode','generateDailyStatistics','createPublicPayment','customerName','POST','ShopService','\x20USDT\x20(current\x20balance)','üìä\x20Shop\x20','1380463lJuXcJ','webhookUrl','retryCount','language','Shop\x20not\x20found','KLYME\x20GB','application/json','getStatistics','getMonth','paymentId','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','testWebhook','map','settings','COMPLETED','getDate','shop','convertToUSDT','desc','lte','dailyRevenue','toISOString','ceil','getFullYear','paidAt','reduce','90d','test_order_123','gatewaySettings','Test\x20webhook\x20sent\x20successfully\x20(','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','...','revenue','No\x20webhook\x20URL\x20configured','paymentGateways','set','wallets','event','PaymentService','default','all','getGatewayDisplayName','amountUSDT','usdtPolygonWallet','updateWallets','__importDefault','usdtTrcWallet','updateShopProfile','statusText','telegramId','gte','findMany','getTime','shopUrl','parse','usdtErcWallet','Noda','gateways','log','getPayoutStatistics','update','2379384ytPXgt','paid','REJECTED','getPaymentByShopAndId','push','error','test_payment_123','publicKey','txid','CoinToPay','delete','username','../config/database','amount','payout','createdAt','2350770waAHUA','thisMonth','getPayoutStats','customerEmail','getPayments','PAID','findUnique','shopId','status','getPayoutById','30d','stringify','12oNeBHy','Webhook\x20returned\x20error:\x20','count','PENDING','USD','merchantUrl','round','payment','redirectUrl','sourceCurrency','getPaymentById'];a52_0x13e9=function(){return _0x34def8;};return a52_0x13e9();}function a52_0x40fb(_0x1dc754,_0x1744f9){const _0x13e930=a52_0x13e9();return a52_0x40fb=function(_0x40fb9c,_0x44caf5){_0x40fb9c=_0x40fb9c-0x112;let _0x17c201=_0x13e930[_0x40fb9c];return _0x17c201;},a52_0x40fb(_0x1dc754,_0x1744f9);}class ShopService{constructor(){const _0x4f22fb=a52_0x287632;this[_0x4f22fb(0x17d)]=new paymentService_1[(_0x4f22fb(0x13c))]();}async[a52_0x287632(0x189)](_0x8df38e){const _0x4be611=a52_0x287632,_0x38d72d=await database_1[_0x4be611(0x13d)][_0x4be611(0x126)][_0x4be611(0x169)]({'where':{'id':_0x8df38e},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x38d72d)throw new Error(_0x4be611(0x11a));let _0x3f3f60=[];if(_0x38d72d[_0x4be611(0x123)]?.[_0x4be611(0x183)])try{_0x3f3f60=Array[_0x4be611(0x184)](_0x38d72d[_0x4be611(0x123)][_0x4be611(0x183)])?_0x38d72d[_0x4be611(0x123)][_0x4be611(0x183)]:JSON[_0x4be611(0x14c)](_0x38d72d[_0x4be611(0x123)][_0x4be611(0x183)]);}catch(_0x1e0705){console[_0x4be611(0x158)](_0x4be611(0x18e),_0x1e0705),_0x3f3f60=[];}return{'id':_0x38d72d['id'],'fullName':_0x38d72d[_0x4be611(0x180)],'username':_0x38d72d[_0x4be611(0x15e)],'telegramId':_0x38d72d[_0x4be611(0x17b)],'merchantUrl':_0x38d72d[_0x4be611(0x14b)],'gateways':_0x38d72d[_0x4be611(0x138)]?JSON[_0x4be611(0x14c)](_0x38d72d['paymentGateways']):null,'gatewaySettings':_0x38d72d['gatewaySettings']?JSON[_0x4be611(0x14c)](_0x38d72d[_0x4be611(0x132)]):null,'publicKey':_0x38d72d[_0x4be611(0x15a)],'webhookUrl':_0x38d72d[_0x4be611(0x123)]?.['webhookUrl']||null,'webhookEvents':_0x3f3f60,'wallets':{'usdtPolygonWallet':_0x38d72d[_0x4be611(0x141)],'usdtTrcWallet':_0x38d72d[_0x4be611(0x144)],'usdtErcWallet':_0x38d72d['usdtErcWallet'],'usdcPolygonWallet':_0x38d72d['usdcPolygonWallet']},'status':_0x38d72d[_0x4be611(0x16b)],'createdAt':_0x38d72d[_0x4be611(0x162)]};}async[a52_0x287632(0x145)](_0x52e387,_0x363900){const _0x258f77=a52_0x287632,_0x42c7a9={};_0x363900[_0x258f77(0x195)]&&(_0x42c7a9[_0x258f77(0x180)]=_0x363900['fullName']);_0x363900[_0x258f77(0x147)]!==undefined&&(_0x42c7a9['telegram']=_0x363900[_0x258f77(0x147)]||null);_0x363900[_0x258f77(0x174)]&&(_0x42c7a9[_0x258f77(0x14b)]=_0x363900[_0x258f77(0x174)]);_0x363900['gateways']&&(_0x42c7a9['paymentGateways']=JSON['stringify'](_0x363900[_0x258f77(0x14f)]));_0x363900[_0x258f77(0x132)]&&(_0x42c7a9[_0x258f77(0x132)]=JSON[_0x258f77(0x16e)](_0x363900[_0x258f77(0x132)]));_0x363900['wallets']&&(_0x363900['wallets'][_0x258f77(0x141)]!==undefined&&(_0x42c7a9['usdtPolygonWallet']=_0x363900[_0x258f77(0x13a)]['usdtPolygonWallet']||null),_0x363900[_0x258f77(0x13a)][_0x258f77(0x144)]!==undefined&&(_0x42c7a9[_0x258f77(0x144)]=_0x363900[_0x258f77(0x13a)][_0x258f77(0x144)]||null),_0x363900[_0x258f77(0x13a)][_0x258f77(0x14d)]!==undefined&&(_0x42c7a9[_0x258f77(0x14d)]=_0x363900[_0x258f77(0x13a)][_0x258f77(0x14d)]||null),_0x363900[_0x258f77(0x13a)][_0x258f77(0x186)]!==undefined&&(_0x42c7a9[_0x258f77(0x186)]=_0x363900['wallets'][_0x258f77(0x186)]||null));const _0x5a7b5a=await database_1[_0x258f77(0x13d)][_0x258f77(0x126)]['update']({'where':{'id':_0x52e387},'data':_0x42c7a9,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x46631f=[];if(_0x5a7b5a['settings']?.[_0x258f77(0x183)])try{_0x46631f=Array[_0x258f77(0x184)](_0x5a7b5a['settings']['webhookEvents'])?_0x5a7b5a[_0x258f77(0x123)]['webhookEvents']:JSON[_0x258f77(0x14c)](_0x5a7b5a[_0x258f77(0x123)][_0x258f77(0x183)]);}catch(_0xcd45b){console[_0x258f77(0x158)](_0x258f77(0x18e),_0xcd45b),_0x46631f=[];}return{'id':_0x5a7b5a['id'],'fullName':_0x5a7b5a[_0x258f77(0x180)],'username':_0x5a7b5a[_0x258f77(0x15e)],'telegramId':_0x5a7b5a['telegram'],'merchantUrl':_0x5a7b5a[_0x258f77(0x14b)],'gateways':_0x5a7b5a[_0x258f77(0x138)]?JSON[_0x258f77(0x14c)](_0x5a7b5a[_0x258f77(0x138)]):null,'gatewaySettings':_0x5a7b5a[_0x258f77(0x132)]?JSON[_0x258f77(0x14c)](_0x5a7b5a[_0x258f77(0x132)]):null,'publicKey':_0x5a7b5a[_0x258f77(0x15a)],'webhookUrl':_0x5a7b5a[_0x258f77(0x123)]?.['webhookUrl']||null,'webhookEvents':_0x46631f,'wallets':{'usdtPolygonWallet':_0x5a7b5a[_0x258f77(0x141)],'usdtTrcWallet':_0x5a7b5a[_0x258f77(0x144)],'usdtErcWallet':_0x5a7b5a[_0x258f77(0x14d)],'usdcPolygonWallet':_0x5a7b5a[_0x258f77(0x186)]},'status':_0x5a7b5a[_0x258f77(0x16b)],'createdAt':_0x5a7b5a[_0x258f77(0x162)]};}async[a52_0x287632(0x142)](_0x51c101,_0x4897db){const _0x359d67=a52_0x287632,_0x576b83={};_0x4897db[_0x359d67(0x141)]!==undefined&&(_0x576b83[_0x359d67(0x141)]=_0x4897db[_0x359d67(0x141)]||null),_0x4897db[_0x359d67(0x144)]!==undefined&&(_0x576b83[_0x359d67(0x144)]=_0x4897db[_0x359d67(0x144)]||null),_0x4897db[_0x359d67(0x14d)]!==undefined&&(_0x576b83['usdtErcWallet']=_0x4897db[_0x359d67(0x14d)]||null),_0x4897db[_0x359d67(0x186)]!==undefined&&(_0x576b83[_0x359d67(0x186)]=_0x4897db[_0x359d67(0x186)]||null),await database_1['default']['shop'][_0x359d67(0x152)]({'where':{'id':_0x51c101},'data':_0x576b83});}async[a52_0x287632(0x121)](_0x2db0f4){const _0x23bc81=a52_0x287632,_0x5ae4bd=await database_1[_0x23bc81(0x13d)][_0x23bc81(0x126)][_0x23bc81(0x169)]({'where':{'id':_0x2db0f4},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x5ae4bd?.['settings']?.[_0x23bc81(0x117)])throw new Error(_0x23bc81(0x137));const _0x2421d0={'event':'test','payment':{'id':_0x23bc81(0x159),'order_id':_0x23bc81(0x131),'gateway':_0x23bc81(0x19c),'amount':0x64,'currency':_0x23bc81(0x173),'status':_0x23bc81(0x154),'created_at':new Date()[_0x23bc81(0x12b)]()}};try{const _0x5390a1=await fetch(_0x5ae4bd[_0x23bc81(0x123)]['webhookUrl'],{'method':_0x23bc81(0x112),'headers':{'Content-Type':_0x23bc81(0x11c),'User-Agent':_0x23bc81(0x18a)},'body':JSON[_0x23bc81(0x16e)](_0x2421d0)});return _0x5390a1['ok']?{'success':!![],'message':_0x23bc81(0x133)+_0x5390a1['status']+')'}:{'success':![],'message':_0x23bc81(0x170)+_0x5390a1['status']+'\x20'+_0x5390a1[_0x23bc81(0x146)]};}catch(_0x5a4cd0){return{'success':![],'message':_0x23bc81(0x1a0)+(_0x5a4cd0 instanceof Error?_0x5a4cd0[_0x23bc81(0x188)]:'Unknown\x20error')};}}async['createPayment'](_0x30f65b){const _0x5f5a10=a52_0x287632;return this[_0x5f5a10(0x17d)][_0x5f5a10(0x1a6)]({'public_key':'','gateway':_0x30f65b[_0x5f5a10(0x197)],'order_id':undefined,'amount':_0x30f65b[_0x5f5a10(0x160)],'currency':_0x30f65b[_0x5f5a10(0x196)],'source_currency':_0x30f65b[_0x5f5a10(0x178)],'usage':_0x30f65b['usage'],'expires_at':_0x30f65b['expiresAt']?.[_0x5f5a10(0x12b)](),'success_url':_0x30f65b[_0x5f5a10(0x177)],'fail_url':_0x30f65b[_0x5f5a10(0x177)],'customer_email':_0x30f65b[_0x5f5a10(0x166)],'customer_name':_0x30f65b[_0x5f5a10(0x1a7)],'country':_0x30f65b[_0x5f5a10(0x18b)],'language':_0x30f65b[_0x5f5a10(0x119)],'amount_is_editable':_0x30f65b[_0x5f5a10(0x187)],'max_payments':_0x30f65b['maxPayments'],'customer':_0x30f65b[_0x5f5a10(0x190)]});}async[a52_0x287632(0x167)](_0x57c0ef,_0x2d4ca7){const _0x5b665c=a52_0x287632;return this[_0x5b665c(0x17d)]['getPaymentsByShop'](_0x57c0ef,_0x2d4ca7);}async[a52_0x287632(0x179)](_0x5bc816,_0x7bcd30){const _0x5c7f13=a52_0x287632;return this[_0x5c7f13(0x17d)][_0x5c7f13(0x156)](_0x5bc816,_0x7bcd30);}async['updatePayment'](_0x2ec6a0,_0x4a3e41,_0xd59322){const _0x59a464=a52_0x287632,_0x324727=await database_1[_0x59a464(0x13d)][_0x59a464(0x176)][_0x59a464(0x18c)]({'where':{'id':_0x4a3e41,'shopId':_0x2ec6a0}});if(!_0x324727)throw new Error('Payment\x20not\x20found');const _0x349d44=await database_1[_0x59a464(0x13d)][_0x59a464(0x176)]['update']({'where':{'id':_0x4a3e41},'data':{..._0xd59322,'updatedAt':new Date()}});return _0x349d44;}async['deletePayment'](_0x14dce6,_0x4da7ff){const _0x4ac36d=a52_0x287632,_0x2ccddd=await database_1[_0x4ac36d(0x13d)][_0x4ac36d(0x176)]['findFirst']({'where':{'id':_0x4da7ff,'shopId':_0x14dce6}});if(!_0x2ccddd)throw new Error(_0x4ac36d(0x1a1));await database_1[_0x4ac36d(0x13d)][_0x4ac36d(0x176)][_0x4ac36d(0x15d)]({'where':{'id':_0x4da7ff}});}async[a52_0x287632(0x1a2)](_0x4227bc,_0x4a6070){const _0x431431=a52_0x287632,{page:_0x37cdf8,limit:_0x5e8a45,status:_0xf3c2cc,method:_0x435f10,dateFrom:_0x1404e9,dateTo:_0x28ef48,periodFrom:_0x37e424,periodTo:_0x290f27}=_0x4a6070,_0x5237c9=(_0x37cdf8-0x1)*_0x5e8a45,_0x49f983={'shopId':_0x4227bc};_0xf3c2cc&&(_0x49f983[_0x431431(0x16b)]=_0xf3c2cc['toUpperCase']());_0x435f10&&(_0x49f983[_0x431431(0x19f)]=_0x435f10);if(_0x1404e9||_0x28ef48||_0x37e424||_0x290f27){_0x49f983[_0x431431(0x162)]={};if(_0x37e424)_0x49f983[_0x431431(0x162)][_0x431431(0x148)]=new Date(_0x37e424);else _0x1404e9&&(_0x49f983[_0x431431(0x162)][_0x431431(0x148)]=new Date(_0x1404e9));if(_0x290f27)_0x49f983['createdAt'][_0x431431(0x129)]=new Date(_0x290f27);else _0x28ef48&&(_0x49f983['createdAt'][_0x431431(0x129)]=new Date(_0x28ef48));}const [_0x10230e,_0x37ff74]=await Promise['all']([database_1[_0x431431(0x13d)]['payout']['findMany']({'where':_0x49f983,'skip':_0x5237c9,'take':_0x5e8a45,'orderBy':{'createdAt':_0x431431(0x128)}}),database_1[_0x431431(0x13d)][_0x431431(0x161)][_0x431431(0x171)]({'where':_0x49f983})]);return{'payouts':_0x10230e[_0x431431(0x122)](_0x4f930f=>({'id':_0x4f930f['id'],'amount':_0x4f930f['amount'],'network':_0x4f930f[_0x431431(0x19f)],'status':_0x4f930f[_0x431431(0x16b)],'txid':_0x4f930f[_0x431431(0x15b)],'notes':_0x4f930f['notes'],'createdAt':_0x4f930f[_0x431431(0x162)],'paidAt':_0x4f930f[_0x431431(0x12e)]})),'pagination':{'page':_0x37cdf8,'limit':_0x5e8a45,'total':_0x37ff74,'totalPages':Math['ceil'](_0x37ff74/_0x5e8a45)}};}async[a52_0x287632(0x16c)](_0xcca86b,_0x21337a){const _0x40afc2=a52_0x287632,_0x412286=await database_1['default'][_0x40afc2(0x161)][_0x40afc2(0x18c)]({'where':{'id':_0x21337a,'shopId':_0xcca86b}});if(!_0x412286)return null;return{'id':_0x412286['id'],'amount':_0x412286[_0x40afc2(0x160)],'network':_0x412286[_0x40afc2(0x19f)],'status':_0x412286[_0x40afc2(0x16b)],'txid':_0x412286['txid'],'notes':_0x412286[_0x40afc2(0x185)],'createdAt':_0x412286['createdAt'],'paidAt':_0x412286[_0x40afc2(0x12e)]};}async[a52_0x287632(0x151)](_0x231b54,_0x572356){const _0xba4ac0=a52_0x287632,_0x7b2eff=new Date();let _0xd112a0;switch(_0x572356){case'7d':_0xd112a0=new Date(_0x7b2eff[_0xba4ac0(0x14a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0xba4ac0(0x16d):_0xd112a0=new Date(_0x7b2eff[_0xba4ac0(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0xba4ac0(0x130):_0xd112a0=new Date(_0x7b2eff['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xd112a0=new Date(_0x7b2eff['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x431d47,_0x2cd7a1,_0x37a82a,_0x6992a2,_0x223492,_0x2b43f0]=await Promise[_0xba4ac0(0x13e)]([database_1['default'][_0xba4ac0(0x161)][_0xba4ac0(0x171)]({'where':{'shopId':_0x231b54,'createdAt':{'gte':_0xd112a0}}}),database_1['default'][_0xba4ac0(0x161)]['count']({'where':{'shopId':_0x231b54,'status':'COMPLETED','createdAt':{'gte':_0xd112a0}}}),database_1[_0xba4ac0(0x13d)][_0xba4ac0(0x161)][_0xba4ac0(0x171)]({'where':{'shopId':_0x231b54,'status':_0xba4ac0(0x172),'createdAt':{'gte':_0xd112a0}}}),database_1[_0xba4ac0(0x13d)]['payout'][_0xba4ac0(0x171)]({'where':{'shopId':_0x231b54,'status':_0xba4ac0(0x155),'createdAt':{'gte':_0xd112a0}}}),database_1[_0xba4ac0(0x13d)][_0xba4ac0(0x161)][_0xba4ac0(0x149)]({'where':{'shopId':_0x231b54,'createdAt':{'gte':_0xd112a0}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0xba4ac0(0x13d)][_0xba4ac0(0x161)][_0xba4ac0(0x149)]({'where':{'shopId':_0x231b54},'take':0xa,'orderBy':{'createdAt':_0xba4ac0(0x128)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x48e267=_0x223492[_0xba4ac0(0x12f)]((_0x1df583,_0x16e84f)=>_0x1df583+_0x16e84f[_0xba4ac0(0x160)],0x0),_0x41f13d=_0x223492['filter'](_0xde76aa=>_0xde76aa['status']===_0xba4ac0(0x124))[_0xba4ac0(0x12f)]((_0x493b44,_0x43884b)=>_0x493b44+_0x43884b[_0xba4ac0(0x160)],0x0),_0x2bedbf=_0x223492['filter'](_0x5f4758=>_0x5f4758['status']===_0xba4ac0(0x172))['reduce']((_0x460df6,_0x435ea9)=>_0x460df6+_0x435ea9[_0xba4ac0(0x160)],0x0),_0x1be2f5=_0x223492[_0xba4ac0(0x12f)]((_0x386db3,_0x4f3c1f)=>{const _0x15181c=_0xba4ac0;return _0x386db3[_0x4f3c1f['network']]=(_0x386db3[_0x4f3c1f[_0x15181c(0x19f)]]||0x0)+0x1,_0x386db3;},{}),_0x435311=_0x223492[_0xba4ac0(0x12f)]((_0x140bef,_0xd327f8)=>{const _0x52ea50=_0xba4ac0;return _0x140bef[_0xd327f8[_0x52ea50(0x16b)]]=(_0x140bef[_0xd327f8[_0x52ea50(0x16b)]]||0x0)+0x1,_0x140bef;},{});return{'totalPayouts':_0x431d47,'completedPayouts':_0x2cd7a1,'pendingPayouts':_0x37a82a,'rejectedPayouts':_0x6992a2,'totalAmount':_0x48e267,'completedAmount':_0x41f13d,'pendingAmount':_0x2bedbf,'payoutsByMethod':_0x1be2f5,'payoutsByStatus':_0x435311,'recentPayouts':_0x2b43f0[_0xba4ac0(0x122)](_0x29b719=>({'id':_0x29b719['id'],'shopId':_0x231b54,'amount':_0x29b719['amount'],'method':_0x29b719[_0xba4ac0(0x19f)],'status':_0x29b719[_0xba4ac0(0x16b)],'txid':_0x29b719[_0xba4ac0(0x15b)],'createdAt':_0x29b719[_0xba4ac0(0x162)],'paidAt':_0x29b719[_0xba4ac0(0x12e)]}))};}async['getShopPayoutStats'](_0xafe26d){const _0x47c7cc=a52_0x287632;console['log']('üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0xafe26d+_0x47c7cc(0x135));const _0x427b7c=await database_1[_0x47c7cc(0x13d)][_0x47c7cc(0x126)][_0x47c7cc(0x169)]({'where':{'id':_0xafe26d},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x427b7c)throw new Error(_0x47c7cc(0x11a));const _0x38cef3=new Date(),_0x14d61f=new Date(_0x38cef3[_0x47c7cc(0x12d)](),_0x38cef3[_0x47c7cc(0x11e)](),0x1),_0x5bd020=new Date(_0x38cef3[_0x47c7cc(0x12d)](),_0x38cef3[_0x47c7cc(0x11e)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x6e27f4=await database_1[_0x47c7cc(0x13d)][_0x47c7cc(0x161)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0xafe26d,'createdAt':{'gte':_0x14d61f,'lte':_0x5bd020},'status':'COMPLETED'}}),_0x14d62a=_0x6e27f4['_sum']['amount']||0x0,_0x39c780={'availableBalance':Math['round'](_0x427b7c[_0x47c7cc(0x198)]*0x64)/0x64,'totalPaidOut':Math[_0x47c7cc(0x175)](_0x427b7c[_0x47c7cc(0x19e)]*0x64)/0x64,'awaitingPayout':Math[_0x47c7cc(0x175)](_0x427b7c[_0x47c7cc(0x198)]*0x64)/0x64,'thisMonth':Math[_0x47c7cc(0x175)](_0x14d62a*0x64)/0x64};return console[_0x47c7cc(0x150)](_0x47c7cc(0x115)+_0x427b7c['username']+'\x20payout\x20statistics\x20calculated:'),console[_0x47c7cc(0x150)]('\x20\x20\x20üíµ\x20Available\x20balance:\x20'+_0x39c780[_0x47c7cc(0x18f)]+'\x20USDT\x20(current\x20balance)'),console['log'](_0x47c7cc(0x134)+_0x39c780[_0x47c7cc(0x19e)]+'\x20USDT\x20(total\x20payouts)'),console['log'](_0x47c7cc(0x120)+_0x39c780['awaitingPayout']+_0x47c7cc(0x114)),console[_0x47c7cc(0x150)]('\x20\x20\x20üìÖ\x20This\x20month:\x20'+_0x39c780[_0x47c7cc(0x164)]+'\x20USDT'),_0x39c780;}[a52_0x287632(0x13f)](_0x309f12){const _0x48a0b3=a52_0x287632,_0x350488={'test_gateway':_0x48a0b3(0x194),'plisio':'Plisio','rapyd':'Rapyd','noda':_0x48a0b3(0x14e),'cointopay':_0x48a0b3(0x15c),'klyme_eu':_0x48a0b3(0x193),'klyme_gb':_0x48a0b3(0x11b),'klyme_de':_0x48a0b3(0x17a)};return _0x350488[_0x309f12]||_0x309f12;}async[a52_0x287632(0x165)](_0x109ba6){const _0xcca750=a52_0x287632;return this[_0xcca750(0x17e)](_0x109ba6);}async['getWebhookLogs'](_0x4622ea,_0x3010e7){const _0x1f902e=a52_0x287632,{page:_0x52f847,limit:_0x36370f,paymentId:_0x58836a}=_0x3010e7,_0x1f9734=(_0x52f847-0x1)*_0x36370f,_0x2dc33a={'shopId':_0x4622ea};_0x58836a&&(_0x2dc33a[_0x1f902e(0x11f)]=_0x58836a);const [_0x379c6b,_0x47838c]=await Promise['all']([database_1[_0x1f902e(0x13d)]['webhookLog'][_0x1f902e(0x149)]({'where':_0x2dc33a,'skip':_0x1f9734,'take':_0x36370f,'orderBy':{'createdAt':_0x1f902e(0x128)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x1f902e(0x13d)]['webhookLog']['count']({'where':_0x2dc33a})]);return{'logs':_0x379c6b[_0x1f902e(0x122)](_0x518350=>({'id':_0x518350['id'],'paymentId':_0x518350['paymentId'],'shopId':_0x518350[_0x1f902e(0x16a)],'event':_0x518350[_0x1f902e(0x13b)],'statusCode':_0x518350[_0x1f902e(0x1a4)],'retryCount':_0x518350[_0x1f902e(0x118)],'responseBody':_0x518350[_0x1f902e(0x19d)],'createdAt':_0x518350[_0x1f902e(0x162)],'payment':_0x518350[_0x1f902e(0x176)]})),'pagination':{'page':_0x52f847,'limit':_0x36370f,'total':_0x47838c,'totalPages':Math[_0x1f902e(0x12c)](_0x47838c/_0x36370f)}};}async[a52_0x287632(0x11d)](_0x15a57a,_0x32c226){const _0x3272d1=a52_0x287632,_0x5d2191=new Date();let _0x2c02b4;switch(_0x32c226){case'7d':_0x2c02b4=new Date(_0x5d2191[_0x3272d1(0x14a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x3272d1(0x16d):_0x2c02b4=new Date(_0x5d2191[_0x3272d1(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3272d1(0x130):_0x2c02b4=new Date(_0x5d2191[_0x3272d1(0x14a)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x2c02b4=new Date(_0x5d2191[_0x3272d1(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x319970,_0x593d0e,_0x1b59d7,_0x526c67,_0x3eeed9]=await Promise[_0x3272d1(0x13e)]([database_1[_0x3272d1(0x13d)][_0x3272d1(0x176)][_0x3272d1(0x171)]({'where':{'shopId':_0x15a57a,'gateway':{'not':_0x3272d1(0x181)},'createdAt':{'gte':_0x2c02b4}}}),database_1['default'][_0x3272d1(0x176)][_0x3272d1(0x171)]({'where':{'shopId':_0x15a57a,'gateway':{'not':_0x3272d1(0x181)},'status':_0x3272d1(0x168),'createdAt':{'gte':_0x2c02b4}}}),database_1['default'][_0x3272d1(0x176)][_0x3272d1(0x149)]({'where':{'shopId':_0x15a57a,'gateway':{'not':'test_gateway'},'status':_0x3272d1(0x168),'createdAt':{'gte':_0x2c02b4}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3272d1(0x13d)][_0x3272d1(0x176)][_0x3272d1(0x149)]({'where':{'shopId':_0x15a57a,'gateway':{'not':'test_gateway'}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x3272d1(0x176)][_0x3272d1(0x149)]({'where':{'shopId':_0x15a57a,'gateway':{'not':_0x3272d1(0x181)},'createdAt':{'gte':_0x2c02b4}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3272d1(0x19b)}})]);let _0x49e859=0x0;for(const _0x23313f of _0x1b59d7){if(_0x23313f['amountUSDT'])_0x49e859+=_0x23313f[_0x3272d1(0x140)];else{const _0x12173e=await currencyService_1['currencyService'][_0x3272d1(0x127)](_0x23313f[_0x3272d1(0x160)],_0x23313f[_0x3272d1(0x196)]);_0x49e859+=_0x12173e;}}const _0x5b5fec=this[_0x3272d1(0x1a5)](_0x3eeed9,_0x2c02b4,_0x5d2191),_0x142871=_0x319970>0x0?_0x593d0e/_0x319970*0x64:0x0;return{'totalPayments':_0x319970,'successfulPayments':_0x593d0e,'totalRevenue':Math[_0x3272d1(0x175)](_0x49e859*0x64)/0x64,'conversionRate':Math[_0x3272d1(0x175)](_0x142871*0x64)/0x64,'dailyRevenue':_0x5b5fec[_0x3272d1(0x12a)],'dailyPayments':_0x5b5fec[_0x3272d1(0x19a)],'recentPayments':_0x526c67[_0x3272d1(0x122)](_0x13e927=>({'id':_0x13e927['id'],'gateway':_0x13e927['gateway'],'amount':_0x13e927[_0x3272d1(0x160)],'currency':_0x13e927[_0x3272d1(0x196)],'status':_0x13e927[_0x3272d1(0x16b)],'createdAt':_0x13e927[_0x3272d1(0x162)]}))};}[a52_0x287632(0x1a5)](_0x55591a,_0x4b3043,_0x582af3){const _0x4a95e3=a52_0x287632,_0x526246=new Map(),_0x20ddba=new Date(_0x4b3043);while(_0x20ddba<=_0x582af3){const _0x3e83dd=_0x20ddba[_0x4a95e3(0x12b)]()[_0x4a95e3(0x192)]('T')[0x0];_0x526246[_0x4a95e3(0x139)](_0x3e83dd,{'revenue':0x0,'count':0x0}),_0x20ddba['setDate'](_0x20ddba[_0x4a95e3(0x125)]()+0x1);}for(const _0x5e6d3d of _0x55591a){const _0x5a7569=_0x5e6d3d[_0x4a95e3(0x162)][_0x4a95e3(0x12b)]()[_0x4a95e3(0x192)]('T')[0x0],_0x35e801=_0x526246['get'](_0x5a7569);_0x35e801&&(_0x35e801[_0x4a95e3(0x171)]+=0x1,_0x5e6d3d[_0x4a95e3(0x16b)]===_0x4a95e3(0x168)&&_0x5e6d3d[_0x4a95e3(0x140)]&&(_0x35e801[_0x4a95e3(0x136)]+=_0x5e6d3d[_0x4a95e3(0x140)]));}const _0x47d02c=[],_0x5add4a=[];for(const [_0x4faa6e,_0x30184a]of _0x526246){_0x47d02c[_0x4a95e3(0x157)]({'date':_0x4faa6e,'amount':Math[_0x4a95e3(0x175)](_0x30184a['revenue']*0x64)/0x64}),_0x5add4a[_0x4a95e3(0x157)]({'date':_0x4faa6e,'count':_0x30184a[_0x4a95e3(0x171)]});}return{'dailyRevenue':_0x47d02c,'dailyPayments':_0x5add4a};}}exports[a52_0x287632(0x113)]=ShopService;