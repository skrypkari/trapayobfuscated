'use strict';function a53_0x12be(_0x16abec,_0x53e0ec){const _0xaabbc6=a53_0xaabb();return a53_0x12be=function(_0x12beab,_0xa54d81){_0x12beab=_0x12beab-0x9c;let _0x4eaa1c=_0xaabbc6[_0x12beab];return _0x4eaa1c;},a53_0x12be(_0x16abec,_0x53e0ec);}const a53_0x1db3b2=a53_0x12be;(function(_0x45e9f0,_0x20a2a6){const _0x4a6c6a=a53_0x12be,_0x146f2e=_0x45e9f0();while(!![]){try{const _0x5c29e6=parseInt(_0x4a6c6a(0x139))/0x1*(-parseInt(_0x4a6c6a(0xab))/0x2)+-parseInt(_0x4a6c6a(0xca))/0x3+-parseInt(_0x4a6c6a(0xe5))/0x4+-parseInt(_0x4a6c6a(0x13f))/0x5*(-parseInt(_0x4a6c6a(0xea))/0x6)+-parseInt(_0x4a6c6a(0xa1))/0x7*(parseInt(_0x4a6c6a(0xc9))/0x8)+parseInt(_0x4a6c6a(0x9e))/0x9*(parseInt(_0x4a6c6a(0xd1))/0xa)+parseInt(_0x4a6c6a(0xd5))/0xb*(parseInt(_0x4a6c6a(0xa6))/0xc);if(_0x5c29e6===_0x20a2a6)break;else _0x146f2e['push'](_0x146f2e['shift']());}catch(_0x94e37e){_0x146f2e['push'](_0x146f2e['shift']());}}}(a53_0xaabb,0xc987a));var __importDefault=this&&this[a53_0x1db3b2(0xe8)]||function(_0x5ec0e6){return _0x5ec0e6&&_0x5ec0e6['__esModule']?_0x5ec0e6:{'default':_0x5ec0e6};};function a53_0xaabb(){const _0x4e03d9=['split','6BlDTsm','findFirst','map','\x20payout\x20statistics\x20calculated:','log','test_order_123','retryCount','webhookEvents','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','\x20\x20\x20üìÖ\x20This\x20month:\x20','shopId','toISOString','getPaymentsByShop','getWebhookLogs','\x20USDT\x20(current\x20balance)','sourceCurrency','expiresAt','getPayoutStatistics','USDC\x20Polygon','reduce','customerName','Test\x20Gateway','gateway','defineProperty','all','fullName','paymentGateways','periodTo','lte','setHours','KLYME\x20GB','getDate','createPayment','status','90d','getMonth','Webhook\x20returned\x20error:\x20','__esModule','_sum','shop','setDate','TesSoft\x20Payment\x20System/1.0\x20(Test)','USDT\x20ERC20','webhookLog','Noda','POST','REJECTED','gatewaySettings','network','toUpperCase','Plisio','default','Payment\x20not\x20found','getFullYear','amount','getGatewayDisplayName','amountUSDT','message','PENDING','webhookUrl','üåê\x20Method\x20filter:\x20','desc','30d','set','maxPayments','PaymentService','KLYME\x20EU','getPaymentByShopAndId','usage','CoinToPay','round','generateDailyStatistics','publicKey','COMPLETED','Shop\x20not\x20found','usdtTrcWallet','usdcPolygonWallet','balance','paymentService','1263WnzvmC','üìä\x20Shop\x20','get','USD','username','payout','537695aeIwtr','asc','PAID','error','isArray','event','telegram','\x20USDT\x20(total\x20payouts)','üåê\x20Network\x20filter:\x20','gte','test_payment_123','merchantUrl','USDT\x20Polygon','notes','findMany','ceil','18PwagrN','findUnique','revenue','3796429rCzSTm','updateShopProfile','availableBalance','currency','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','144wNUtnG','test_gateway','aggregate','Error\x20parsing\x20webhook\x20events:','updatePayment','1426bqUTXX','language','polygon_usdc','usdtPolygonWallet','üìä\x20Status\x20filter:\x20','paid','count','wallets','\x20\x20\x20üíµ\x20Available\x20balance:\x20','settings','update','paymentId','polygon','payment','telegramId','ShopService','getPaymentById','convertToUSDT','formatNetworkName','üìÖ\x20Date\x20end:\x20','usdtErcWallet','statusCode','amountIsEditable','getPayouts','stringify','test','push','trc20','paidAt','getShopProfile','24ZehXiv','4599177pNufxt','txid','testWebhook','KLYME\x20DE','filter','üìÖ\x20Period\x20start:\x20','country','3638180RQeGTy','./paymentService','createdAt','erc20','4132304hxtRHE','parse','getPayoutStats','Failed\x20to\x20send\x20webhook:\x20','getTime','redirectUrl','name','responseBody','üí∞\x20Getting\x20payouts\x20with\x20filters:','deletePayment','updateWallets','totalPaidOut','shopUrl','thisMonth','gateways','dailyPayments','1828232apUqHE','USDT\x20TRC20','USDT\x20BSC','__importDefault'];a53_0xaabb=function(){return _0x4e03d9;};return a53_0xaabb();}Object[a53_0x1db3b2(0x101)](exports,a53_0x1db3b2(0x10f),{'value':!![]}),exports[a53_0x1db3b2(0xba)]=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require('./currencyService'),paymentService_1=require(a53_0x1db3b2(0xd2));class ShopService{constructor(){const _0x253de4=a53_0x1db3b2;this['paymentService']=new paymentService_1[(_0x253de4(0x12b))]();}async[a53_0x1db3b2(0xc8)](_0x40ca4f){const _0x5291de=a53_0x1db3b2,_0x3ec340=await database_1[_0x5291de(0x11d)][_0x5291de(0x111)][_0x5291de(0x9f)]({'where':{'id':_0x40ca4f},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x3ec340)throw new Error(_0x5291de(0x134));let _0x17d152=[];if(_0x3ec340[_0x5291de(0xb4)]?.[_0x5291de(0xf1)])try{_0x17d152=Array[_0x5291de(0x143)](_0x3ec340[_0x5291de(0xb4)]['webhookEvents'])?_0x3ec340[_0x5291de(0xb4)][_0x5291de(0xf1)]:JSON[_0x5291de(0xd6)](_0x3ec340['settings'][_0x5291de(0xf1)]);}catch(_0x1de240){console['error'](_0x5291de(0xa9),_0x1de240),_0x17d152=[];}return{'id':_0x3ec340['id'],'fullName':_0x3ec340['name'],'username':_0x3ec340[_0x5291de(0x13d)],'telegramId':_0x3ec340[_0x5291de(0x145)],'merchantUrl':_0x3ec340[_0x5291de(0xe1)],'gateways':_0x3ec340[_0x5291de(0x104)]?JSON[_0x5291de(0xd6)](_0x3ec340['paymentGateways']):null,'gatewaySettings':_0x3ec340[_0x5291de(0x119)]?JSON[_0x5291de(0xd6)](_0x3ec340['gatewaySettings']):null,'publicKey':_0x3ec340['publicKey'],'webhookUrl':_0x3ec340[_0x5291de(0xb4)]?.[_0x5291de(0x125)]||null,'webhookEvents':_0x17d152,'wallets':{'usdtPolygonWallet':_0x3ec340[_0x5291de(0xae)],'usdtTrcWallet':_0x3ec340['usdtTrcWallet'],'usdtErcWallet':_0x3ec340[_0x5291de(0xbf)],'usdcPolygonWallet':_0x3ec340[_0x5291de(0x136)]},'status':_0x3ec340[_0x5291de(0x10b)],'createdAt':_0x3ec340[_0x5291de(0xd3)]};}async[a53_0x1db3b2(0xa2)](_0x23df57,_0x38a373){const _0x1bef93=a53_0x1db3b2,_0x921601={};_0x38a373[_0x1bef93(0x103)]&&(_0x921601[_0x1bef93(0xdb)]=_0x38a373['fullName']);_0x38a373[_0x1bef93(0xb9)]!==undefined&&(_0x921601[_0x1bef93(0x145)]=_0x38a373[_0x1bef93(0xb9)]||null);_0x38a373[_0x1bef93(0x14a)]&&(_0x921601[_0x1bef93(0xe1)]=_0x38a373[_0x1bef93(0x14a)]);_0x38a373['gateways']&&(_0x921601[_0x1bef93(0x104)]=JSON[_0x1bef93(0xc3)](_0x38a373[_0x1bef93(0xe3)]));_0x38a373[_0x1bef93(0x119)]&&(_0x921601['gatewaySettings']=JSON['stringify'](_0x38a373[_0x1bef93(0x119)]));_0x38a373[_0x1bef93(0xb2)]&&(_0x38a373['wallets'][_0x1bef93(0xae)]!==undefined&&(_0x921601[_0x1bef93(0xae)]=_0x38a373[_0x1bef93(0xb2)][_0x1bef93(0xae)]||null),_0x38a373['wallets'][_0x1bef93(0x135)]!==undefined&&(_0x921601['usdtTrcWallet']=_0x38a373[_0x1bef93(0xb2)][_0x1bef93(0x135)]||null),_0x38a373['wallets'][_0x1bef93(0xbf)]!==undefined&&(_0x921601['usdtErcWallet']=_0x38a373[_0x1bef93(0xb2)][_0x1bef93(0xbf)]||null),_0x38a373[_0x1bef93(0xb2)][_0x1bef93(0x136)]!==undefined&&(_0x921601[_0x1bef93(0x136)]=_0x38a373[_0x1bef93(0xb2)][_0x1bef93(0x136)]||null));const _0x3d40e4=await database_1[_0x1bef93(0x11d)][_0x1bef93(0x111)][_0x1bef93(0xb5)]({'where':{'id':_0x23df57},'data':_0x921601,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x4c67d6=[];if(_0x3d40e4[_0x1bef93(0xb4)]?.['webhookEvents'])try{_0x4c67d6=Array[_0x1bef93(0x143)](_0x3d40e4[_0x1bef93(0xb4)][_0x1bef93(0xf1)])?_0x3d40e4[_0x1bef93(0xb4)][_0x1bef93(0xf1)]:JSON[_0x1bef93(0xd6)](_0x3d40e4[_0x1bef93(0xb4)][_0x1bef93(0xf1)]);}catch(_0x14baec){console[_0x1bef93(0x142)](_0x1bef93(0xa9),_0x14baec),_0x4c67d6=[];}return{'id':_0x3d40e4['id'],'fullName':_0x3d40e4[_0x1bef93(0xdb)],'username':_0x3d40e4[_0x1bef93(0x13d)],'telegramId':_0x3d40e4['telegram'],'merchantUrl':_0x3d40e4['shopUrl'],'gateways':_0x3d40e4[_0x1bef93(0x104)]?JSON[_0x1bef93(0xd6)](_0x3d40e4[_0x1bef93(0x104)]):null,'gatewaySettings':_0x3d40e4['gatewaySettings']?JSON[_0x1bef93(0xd6)](_0x3d40e4[_0x1bef93(0x119)]):null,'publicKey':_0x3d40e4[_0x1bef93(0x132)],'webhookUrl':_0x3d40e4[_0x1bef93(0xb4)]?.[_0x1bef93(0x125)]||null,'webhookEvents':_0x4c67d6,'wallets':{'usdtPolygonWallet':_0x3d40e4[_0x1bef93(0xae)],'usdtTrcWallet':_0x3d40e4[_0x1bef93(0x135)],'usdtErcWallet':_0x3d40e4[_0x1bef93(0xbf)],'usdcPolygonWallet':_0x3d40e4[_0x1bef93(0x136)]},'status':_0x3d40e4[_0x1bef93(0x10b)],'createdAt':_0x3d40e4[_0x1bef93(0xd3)]};}async[a53_0x1db3b2(0xdf)](_0x4fd940,_0x1a66bd){const _0x59ece3=a53_0x1db3b2,_0x1d344f={};_0x1a66bd[_0x59ece3(0xae)]!==undefined&&(_0x1d344f[_0x59ece3(0xae)]=_0x1a66bd[_0x59ece3(0xae)]||null),_0x1a66bd[_0x59ece3(0x135)]!==undefined&&(_0x1d344f[_0x59ece3(0x135)]=_0x1a66bd[_0x59ece3(0x135)]||null),_0x1a66bd['usdtErcWallet']!==undefined&&(_0x1d344f[_0x59ece3(0xbf)]=_0x1a66bd['usdtErcWallet']||null),_0x1a66bd['usdcPolygonWallet']!==undefined&&(_0x1d344f['usdcPolygonWallet']=_0x1a66bd[_0x59ece3(0x136)]||null),await database_1['default'][_0x59ece3(0x111)]['update']({'where':{'id':_0x4fd940},'data':_0x1d344f});}async[a53_0x1db3b2(0xcc)](_0x227deb){const _0xf54b37=a53_0x1db3b2,_0x2f1d20=await database_1['default']['shop'][_0xf54b37(0x9f)]({'where':{'id':_0x227deb},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x2f1d20?.[_0xf54b37(0xb4)]?.[_0xf54b37(0x125)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x690535={'event':_0xf54b37(0xc4),'payment':{'id':_0xf54b37(0x149),'order_id':_0xf54b37(0xef),'gateway':_0xf54b37(0xc4),'amount':0x64,'currency':_0xf54b37(0x13c),'status':_0xf54b37(0xb0),'created_at':new Date()['toISOString']()}};try{const _0x31954c=await fetch(_0x2f1d20[_0xf54b37(0xb4)][_0xf54b37(0x125)],{'method':_0xf54b37(0x117),'headers':{'Content-Type':'application/json','User-Agent':_0xf54b37(0x113)},'body':JSON[_0xf54b37(0xc3)](_0x690535)});return _0x31954c['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x31954c['status']+')'}:{'success':![],'message':_0xf54b37(0x10e)+_0x31954c['status']+'\x20'+_0x31954c['statusText']};}catch(_0x39d86e){return{'success':![],'message':_0xf54b37(0xd8)+(_0x39d86e instanceof Error?_0x39d86e[_0xf54b37(0x123)]:'Unknown\x20error')};}}async[a53_0x1db3b2(0x10a)](_0x28ef75){const _0xa191c9=a53_0x1db3b2;return this['paymentService']['createPublicPayment']({'public_key':'','gateway':_0x28ef75['gateway'],'order_id':undefined,'amount':_0x28ef75[_0xa191c9(0x120)],'currency':_0x28ef75[_0xa191c9(0xa4)],'source_currency':_0x28ef75[_0xa191c9(0xf9)],'usage':_0x28ef75[_0xa191c9(0x12e)],'expires_at':_0x28ef75[_0xa191c9(0xfa)]?.['toISOString'](),'success_url':_0x28ef75[_0xa191c9(0xda)],'fail_url':_0x28ef75[_0xa191c9(0xda)],'customer_email':_0x28ef75['customerEmail'],'customer_name':_0x28ef75[_0xa191c9(0xfe)],'country':_0x28ef75[_0xa191c9(0xd0)],'language':_0x28ef75[_0xa191c9(0xac)],'amount_is_editable':_0x28ef75[_0xa191c9(0xc1)],'max_payments':_0x28ef75[_0xa191c9(0x12a)],'customer':_0x28ef75['customer']});}async['getPayments'](_0x1c04cf,_0x387c27){const _0x29607e=a53_0x1db3b2;return this[_0x29607e(0x138)][_0x29607e(0xf6)](_0x1c04cf,_0x387c27);}async[a53_0x1db3b2(0xbb)](_0x1585ce,_0x357495){const _0x2d8b4c=a53_0x1db3b2;return this[_0x2d8b4c(0x138)][_0x2d8b4c(0x12d)](_0x1585ce,_0x357495);}async[a53_0x1db3b2(0xaa)](_0x48d084,_0x507726,_0x2621b8){const _0x5435d5=a53_0x1db3b2,_0x465bc9=await database_1[_0x5435d5(0x11d)][_0x5435d5(0xb8)][_0x5435d5(0xeb)]({'where':{'id':_0x507726,'shopId':_0x48d084}});if(!_0x465bc9)throw new Error(_0x5435d5(0x11e));const _0x1fbee8=await database_1[_0x5435d5(0x11d)]['payment'][_0x5435d5(0xb5)]({'where':{'id':_0x507726},'data':{..._0x2621b8,'updatedAt':new Date()}});return _0x1fbee8;}async[a53_0x1db3b2(0xde)](_0x50e350,_0x4f067e){const _0x3549d7=a53_0x1db3b2,_0x12453a=await database_1[_0x3549d7(0x11d)][_0x3549d7(0xb8)][_0x3549d7(0xeb)]({'where':{'id':_0x4f067e,'shopId':_0x50e350}});if(!_0x12453a)throw new Error(_0x3549d7(0x11e));await database_1[_0x3549d7(0x11d)][_0x3549d7(0xb8)]['delete']({'where':{'id':_0x4f067e}});}[a53_0x1db3b2(0xbd)](_0x24f6be){const _0x3759ba=a53_0x1db3b2,_0xcf39b5={'polygon':_0x3759ba(0x14b),'trc20':_0x3759ba(0xe6),'erc20':_0x3759ba(0x114),'bsc':_0x3759ba(0xe7),'polygon_usdc':_0x3759ba(0xfc)};return _0xcf39b5[_0x24f6be]||_0x24f6be;}async[a53_0x1db3b2(0xc2)](_0x514d43,_0x375d59){const _0x5b7e6f=a53_0x1db3b2,{page:_0x23f175,limit:_0x4ae4a6,status:_0x410375,method:_0x3b558f,network:_0x2605e0,dateFrom:_0x39d014,dateTo:_0x335d83,periodFrom:_0x1d79b8,periodTo:_0x4ea166}=_0x375d59,_0x342dc8=(_0x23f175-0x1)*_0x4ae4a6;console['log'](_0x5b7e6f(0xdd),_0x375d59);const _0xaf10ff={'shopId':_0x514d43};_0x410375&&(_0xaf10ff[_0x5b7e6f(0x10b)]=_0x410375[_0x5b7e6f(0x11b)](),console[_0x5b7e6f(0xee)](_0x5b7e6f(0xaf)+_0x410375[_0x5b7e6f(0x11b)]()));if(_0x3b558f)_0xaf10ff[_0x5b7e6f(0x11a)]=_0x3b558f,console[_0x5b7e6f(0xee)](_0x5b7e6f(0x126)+_0x3b558f);else _0x2605e0&&(_0xaf10ff[_0x5b7e6f(0x11a)]=_0x2605e0,console['log'](_0x5b7e6f(0x147)+_0x2605e0));if(_0x39d014||_0x335d83||_0x1d79b8||_0x4ea166){_0xaf10ff[_0x5b7e6f(0xd3)]={};if(_0x1d79b8){const _0x2058ab=new Date(_0x1d79b8);_0x2058ab[_0x5b7e6f(0x107)](0x0,0x0,0x0,0x0),_0xaf10ff[_0x5b7e6f(0xd3)]['gte']=_0x2058ab,console[_0x5b7e6f(0xee)](_0x5b7e6f(0xcf)+_0x2058ab[_0x5b7e6f(0xf5)]());}else{if(_0x39d014){const _0x27359e=new Date(_0x39d014);_0x27359e['setHours'](0x0,0x0,0x0,0x0),_0xaf10ff[_0x5b7e6f(0xd3)][_0x5b7e6f(0x148)]=_0x27359e,console[_0x5b7e6f(0xee)]('üìÖ\x20Date\x20start:\x20'+_0x27359e[_0x5b7e6f(0xf5)]());}}if(_0x4ea166){const _0x2f99ac=new Date(_0x4ea166);_0x2f99ac['setHours'](0x17,0x3b,0x3b,0x3e7),_0xaf10ff[_0x5b7e6f(0xd3)][_0x5b7e6f(0x106)]=_0x2f99ac,console[_0x5b7e6f(0xee)]('üìÖ\x20Period\x20end:\x20'+_0x2f99ac[_0x5b7e6f(0xf5)]());}else{if(_0x335d83){const _0x2261cd=new Date(_0x335d83);_0x2261cd[_0x5b7e6f(0x107)](0x17,0x3b,0x3b,0x3e7),_0xaf10ff['createdAt'][_0x5b7e6f(0x106)]=_0x2261cd,console[_0x5b7e6f(0xee)](_0x5b7e6f(0xbe)+_0x2261cd[_0x5b7e6f(0xf5)]());}}}console[_0x5b7e6f(0xee)]('üìä\x20Final\x20WHERE\x20conditions:',JSON[_0x5b7e6f(0xc3)](_0xaf10ff,null,0x2));const [_0x2e4978,_0x23fdf8]=await Promise[_0x5b7e6f(0x102)]([database_1[_0x5b7e6f(0x11d)][_0x5b7e6f(0x13e)][_0x5b7e6f(0x9c)]({'where':_0xaf10ff,'skip':_0x342dc8,'take':_0x4ae4a6,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x5b7e6f(0x11d)][_0x5b7e6f(0x13e)][_0x5b7e6f(0xb1)]({'where':_0xaf10ff})]);return{'payouts':_0x2e4978[_0x5b7e6f(0xec)](_0x5cbcb1=>{const _0x24de56=_0x5b7e6f;let _0x4503d2=null;switch(_0x5cbcb1[_0x24de56(0x11a)]){case _0x24de56(0xb7):_0x4503d2=_0x5cbcb1[_0x24de56(0x111)]['usdtPolygonWallet'];break;case _0x24de56(0xc6):_0x4503d2=_0x5cbcb1['shop']['usdtTrcWallet'];break;case _0x24de56(0xd4):_0x4503d2=_0x5cbcb1[_0x24de56(0x111)][_0x24de56(0xbf)];break;case _0x24de56(0xad):_0x4503d2=_0x5cbcb1[_0x24de56(0x111)][_0x24de56(0x136)];break;}return{'id':_0x5cbcb1['id'],'amount':_0x5cbcb1[_0x24de56(0x120)],'network':this['formatNetworkName'](_0x5cbcb1['network']),'wallet':_0x4503d2,'status':_0x5cbcb1[_0x24de56(0x10b)],'txid':_0x5cbcb1['txid'],'notes':_0x5cbcb1[_0x24de56(0x14c)],'periodFrom':_0x5cbcb1['periodFrom'],'periodTo':_0x5cbcb1[_0x24de56(0x105)],'createdAt':_0x5cbcb1['createdAt'],'paidAt':_0x5cbcb1[_0x24de56(0xc7)]};}),'pagination':{'page':_0x23f175,'limit':_0x4ae4a6,'total':_0x23fdf8,'totalPages':Math[_0x5b7e6f(0x9d)](_0x23fdf8/_0x4ae4a6)}};}async['getPayoutById'](_0x1aee5b,_0x2669bd){const _0x51cd18=a53_0x1db3b2,_0x29d295=await database_1[_0x51cd18(0x11d)][_0x51cd18(0x13e)][_0x51cd18(0xeb)]({'where':{'id':_0x2669bd,'shopId':_0x1aee5b}});if(!_0x29d295)return null;return{'id':_0x29d295['id'],'amount':_0x29d295[_0x51cd18(0x120)],'network':_0x29d295['network'],'status':_0x29d295[_0x51cd18(0x10b)],'txid':_0x29d295[_0x51cd18(0xcb)],'notes':_0x29d295[_0x51cd18(0x14c)],'createdAt':_0x29d295[_0x51cd18(0xd3)],'paidAt':_0x29d295['paidAt']};}async[a53_0x1db3b2(0xfb)](_0x5b3f99,_0x2d7d2c){const _0x1cfabf=a53_0x1db3b2,_0x18930a=new Date();let _0x49822a;switch(_0x2d7d2c){case'7d':_0x49822a=new Date(_0x18930a[_0x1cfabf(0xd9)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x49822a=new Date(_0x18930a['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x49822a=new Date(_0x18930a['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x49822a=new Date(_0x18930a[_0x1cfabf(0xd9)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x16c87f,_0x39413a,_0xe77805,_0x211ac9,_0x1c820c,_0x3edc6a]=await Promise[_0x1cfabf(0x102)]([database_1[_0x1cfabf(0x11d)][_0x1cfabf(0x13e)][_0x1cfabf(0xb1)]({'where':{'shopId':_0x5b3f99,'createdAt':{'gte':_0x49822a}}}),database_1[_0x1cfabf(0x11d)][_0x1cfabf(0x13e)]['count']({'where':{'shopId':_0x5b3f99,'status':_0x1cfabf(0x133),'createdAt':{'gte':_0x49822a}}}),database_1[_0x1cfabf(0x11d)][_0x1cfabf(0x13e)]['count']({'where':{'shopId':_0x5b3f99,'status':'PENDING','createdAt':{'gte':_0x49822a}}}),database_1[_0x1cfabf(0x11d)]['payout'][_0x1cfabf(0xb1)]({'where':{'shopId':_0x5b3f99,'status':_0x1cfabf(0x118),'createdAt':{'gte':_0x49822a}}}),database_1[_0x1cfabf(0x11d)][_0x1cfabf(0x13e)][_0x1cfabf(0x9c)]({'where':{'shopId':_0x5b3f99,'createdAt':{'gte':_0x49822a}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x1cfabf(0x11d)][_0x1cfabf(0x13e)][_0x1cfabf(0x9c)]({'where':{'shopId':_0x5b3f99},'take':0xa,'orderBy':{'createdAt':_0x1cfabf(0x127)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x2b37d7=_0x1c820c[_0x1cfabf(0xfd)]((_0x5c6fba,_0x51d8c6)=>_0x5c6fba+_0x51d8c6[_0x1cfabf(0x120)],0x0),_0x4406ef=_0x1c820c[_0x1cfabf(0xce)](_0x176e52=>_0x176e52[_0x1cfabf(0x10b)]===_0x1cfabf(0x133))[_0x1cfabf(0xfd)]((_0x2ec02a,_0x51984d)=>_0x2ec02a+_0x51984d[_0x1cfabf(0x120)],0x0),_0x2bdba4=_0x1c820c[_0x1cfabf(0xce)](_0x5325fb=>_0x5325fb[_0x1cfabf(0x10b)]===_0x1cfabf(0x124))[_0x1cfabf(0xfd)]((_0x16d741,_0x1756ca)=>_0x16d741+_0x1756ca[_0x1cfabf(0x120)],0x0),_0x1e0a7e=_0x1c820c[_0x1cfabf(0xfd)]((_0x10be9c,_0x311598)=>{const _0x331df5=_0x1cfabf;return _0x10be9c[_0x311598['network']]=(_0x10be9c[_0x311598[_0x331df5(0x11a)]]||0x0)+0x1,_0x10be9c;},{}),_0x3ed6b6=_0x1c820c[_0x1cfabf(0xfd)]((_0x1a329a,_0x53f33a)=>{const _0x3cf1ea=_0x1cfabf;return _0x1a329a[_0x53f33a['status']]=(_0x1a329a[_0x53f33a[_0x3cf1ea(0x10b)]]||0x0)+0x1,_0x1a329a;},{});return{'totalPayouts':_0x16c87f,'completedPayouts':_0x39413a,'pendingPayouts':_0xe77805,'rejectedPayouts':_0x211ac9,'totalAmount':_0x2b37d7,'completedAmount':_0x4406ef,'pendingAmount':_0x2bdba4,'payoutsByMethod':_0x1e0a7e,'payoutsByStatus':_0x3ed6b6,'recentPayouts':_0x3edc6a[_0x1cfabf(0xec)](_0x4cc51c=>({'id':_0x4cc51c['id'],'shopId':_0x5b3f99,'amount':_0x4cc51c[_0x1cfabf(0x120)],'method':_0x4cc51c[_0x1cfabf(0x11a)],'status':_0x4cc51c[_0x1cfabf(0x10b)],'txid':_0x4cc51c[_0x1cfabf(0xcb)],'createdAt':_0x4cc51c['createdAt'],'paidAt':_0x4cc51c['paidAt']}))};}async['getShopPayoutStats'](_0x2c6a5f){const _0x1aa301=a53_0x1db3b2;console[_0x1aa301(0xee)](_0x1aa301(0xf2)+_0x2c6a5f+'...');const _0x50ee6f=await database_1[_0x1aa301(0x11d)]['shop'][_0x1aa301(0x9f)]({'where':{'id':_0x2c6a5f},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x50ee6f)throw new Error(_0x1aa301(0x134));const _0x14f8f7=new Date(),_0x5782d6=new Date(_0x14f8f7['getFullYear'](),_0x14f8f7[_0x1aa301(0x10d)](),0x1),_0x4aa9a8=new Date(_0x14f8f7[_0x1aa301(0x11f)](),_0x14f8f7['getMonth']()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x3d1a4a=await database_1[_0x1aa301(0x11d)][_0x1aa301(0x13e)][_0x1aa301(0xa8)]({'_sum':{'amount':!![]},'where':{'shopId':_0x2c6a5f,'createdAt':{'gte':_0x5782d6,'lte':_0x4aa9a8},'status':_0x1aa301(0x133)}}),_0x4aa0d4=_0x3d1a4a[_0x1aa301(0x110)]['amount']||0x0,_0x37ac1c={'availableBalance':Math[_0x1aa301(0x130)](_0x50ee6f[_0x1aa301(0x137)]*0x64)/0x64,'totalPaidOut':Math[_0x1aa301(0x130)](_0x50ee6f['totalPaidOut']*0x64)/0x64,'awaitingPayout':Math[_0x1aa301(0x130)](_0x50ee6f[_0x1aa301(0x137)]*0x64)/0x64,'thisMonth':Math['round'](_0x4aa0d4*0x64)/0x64};return console['log'](_0x1aa301(0x13a)+_0x50ee6f[_0x1aa301(0x13d)]+_0x1aa301(0xed)),console[_0x1aa301(0xee)](_0x1aa301(0xb3)+_0x37ac1c[_0x1aa301(0xa3)]+_0x1aa301(0xf8)),console[_0x1aa301(0xee)]('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x37ac1c[_0x1aa301(0xe0)]+_0x1aa301(0x146)),console['log'](_0x1aa301(0xa5)+_0x37ac1c['awaitingPayout']+_0x1aa301(0xf8)),console[_0x1aa301(0xee)](_0x1aa301(0xf3)+_0x37ac1c[_0x1aa301(0xe2)]+'\x20USDT'),_0x37ac1c;}[a53_0x1db3b2(0x121)](_0x14f664){const _0x46c36c=a53_0x1db3b2,_0x3b8f73={'test_gateway':_0x46c36c(0xff),'plisio':_0x46c36c(0x11c),'rapyd':'Rapyd','noda':_0x46c36c(0x116),'cointopay':_0x46c36c(0x12f),'klyme_eu':_0x46c36c(0x12c),'klyme_gb':_0x46c36c(0x108),'klyme_de':_0x46c36c(0xcd)};return _0x3b8f73[_0x14f664]||_0x14f664;}async[a53_0x1db3b2(0xd7)](_0x26f39d){return this['getShopPayoutStats'](_0x26f39d);}async[a53_0x1db3b2(0xf7)](_0x49c5b8,_0x33b558){const _0x5b76f9=a53_0x1db3b2,{page:_0xc4861a,limit:_0x58bb43,paymentId:_0x3afc38}=_0x33b558,_0x588376=(_0xc4861a-0x1)*_0x58bb43,_0x38041d={'shopId':_0x49c5b8};_0x3afc38&&(_0x38041d['paymentId']=_0x3afc38);const [_0x474013,_0x3b084f]=await Promise[_0x5b76f9(0x102)]([database_1['default']['webhookLog'][_0x5b76f9(0x9c)]({'where':_0x38041d,'skip':_0x588376,'take':_0x58bb43,'orderBy':{'createdAt':_0x5b76f9(0x127)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x5b76f9(0x11d)][_0x5b76f9(0x115)]['count']({'where':_0x38041d})]);return{'logs':_0x474013[_0x5b76f9(0xec)](_0x33ab0f=>({'id':_0x33ab0f['id'],'paymentId':_0x33ab0f[_0x5b76f9(0xb6)],'shopId':_0x33ab0f[_0x5b76f9(0xf4)],'event':_0x33ab0f[_0x5b76f9(0x144)],'statusCode':_0x33ab0f[_0x5b76f9(0xc0)],'retryCount':_0x33ab0f[_0x5b76f9(0xf0)],'responseBody':_0x33ab0f[_0x5b76f9(0xdc)],'createdAt':_0x33ab0f[_0x5b76f9(0xd3)],'payment':_0x33ab0f[_0x5b76f9(0xb8)]})),'pagination':{'page':_0xc4861a,'limit':_0x58bb43,'total':_0x3b084f,'totalPages':Math[_0x5b76f9(0x9d)](_0x3b084f/_0x58bb43)}};}async['getStatistics'](_0x23b8c6,_0x15b71b){const _0x438115=a53_0x1db3b2,_0x61bfd4=new Date();let _0x50e249;switch(_0x15b71b){case'7d':_0x50e249=new Date(_0x61bfd4[_0x438115(0xd9)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x438115(0x128):_0x50e249=new Date(_0x61bfd4[_0x438115(0xd9)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x438115(0x10c):_0x50e249=new Date(_0x61bfd4['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x50e249=new Date(_0x61bfd4[_0x438115(0xd9)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x108b92,_0x49e242,_0x592dc2,_0x4d7357,_0x397fe8]=await Promise[_0x438115(0x102)]([database_1['default'][_0x438115(0xb8)][_0x438115(0xb1)]({'where':{'shopId':_0x23b8c6,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x50e249}}}),database_1[_0x438115(0x11d)][_0x438115(0xb8)][_0x438115(0xb1)]({'where':{'shopId':_0x23b8c6,'gateway':{'not':_0x438115(0xa7)},'status':'PAID','createdAt':{'gte':_0x50e249}}}),database_1[_0x438115(0x11d)][_0x438115(0xb8)][_0x438115(0x9c)]({'where':{'shopId':_0x23b8c6,'gateway':{'not':_0x438115(0xa7)},'status':_0x438115(0x141),'createdAt':{'gte':_0x50e249}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default']['payment']['findMany']({'where':{'shopId':_0x23b8c6,'gateway':{'not':_0x438115(0xa7)}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x438115(0x11d)]['payment'][_0x438115(0x9c)]({'where':{'shopId':_0x23b8c6,'gateway':{'not':_0x438115(0xa7)},'createdAt':{'gte':_0x50e249}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x438115(0x140)}})]);let _0x38c9e9=0x0;for(const _0x4908ff of _0x592dc2){if(_0x4908ff[_0x438115(0x122)])_0x38c9e9+=_0x4908ff['amountUSDT'];else{const _0xd9b31b=await currencyService_1['currencyService'][_0x438115(0xbc)](_0x4908ff[_0x438115(0x120)],_0x4908ff[_0x438115(0xa4)]);_0x38c9e9+=_0xd9b31b;}}const _0x3f1f70=this[_0x438115(0x131)](_0x397fe8,_0x50e249,_0x61bfd4),_0x47975e=_0x108b92>0x0?_0x49e242/_0x108b92*0x64:0x0;return{'totalPayments':_0x108b92,'successfulPayments':_0x49e242,'totalRevenue':Math[_0x438115(0x130)](_0x38c9e9*0x64)/0x64,'conversionRate':Math[_0x438115(0x130)](_0x47975e*0x64)/0x64,'dailyRevenue':_0x3f1f70['dailyRevenue'],'dailyPayments':_0x3f1f70[_0x438115(0xe4)],'recentPayments':_0x4d7357['map'](_0x261554=>({'id':_0x261554['id'],'gateway':_0x261554[_0x438115(0x100)],'amount':_0x261554[_0x438115(0x120)],'currency':_0x261554[_0x438115(0xa4)],'status':_0x261554['status'],'createdAt':_0x261554['createdAt']}))};}[a53_0x1db3b2(0x131)](_0x534e56,_0xd743a3,_0x15eea5){const _0x39f35a=a53_0x1db3b2,_0x4d2576=new Map(),_0x24b096=new Date(_0xd743a3);while(_0x24b096<=_0x15eea5){const _0xcf5a92=_0x24b096['toISOString']()[_0x39f35a(0xe9)]('T')[0x0];_0x4d2576[_0x39f35a(0x129)](_0xcf5a92,{'revenue':0x0,'count':0x0}),_0x24b096[_0x39f35a(0x112)](_0x24b096[_0x39f35a(0x109)]()+0x1);}for(const _0x212526 of _0x534e56){const _0x3e222c=_0x212526[_0x39f35a(0xd3)]['toISOString']()[_0x39f35a(0xe9)]('T')[0x0],_0x38ced4=_0x4d2576[_0x39f35a(0x13b)](_0x3e222c);_0x38ced4&&(_0x38ced4['count']+=0x1,_0x212526[_0x39f35a(0x10b)]==='PAID'&&_0x212526[_0x39f35a(0x122)]&&(_0x38ced4[_0x39f35a(0xa0)]+=_0x212526[_0x39f35a(0x122)]));}const _0x906c90=[],_0xc2fd3b=[];for(const [_0x2a6e08,_0x2f8114]of _0x4d2576){_0x906c90[_0x39f35a(0xc5)]({'date':_0x2a6e08,'amount':Math[_0x39f35a(0x130)](_0x2f8114['revenue']*0x64)/0x64}),_0xc2fd3b[_0x39f35a(0xc5)]({'date':_0x2a6e08,'count':_0x2f8114[_0x39f35a(0xb1)]});}return{'dailyRevenue':_0x906c90,'dailyPayments':_0xc2fd3b};}}exports[a53_0x1db3b2(0xba)]=ShopService;