'use strict';const a58_0xb53e84=a58_0x8380;(function(_0x214427,_0x1c02a3){const _0x3e376d=a58_0x8380,_0x307f2b=_0x214427();while(!![]){try{const _0x3eaf42=parseInt(_0x3e376d(0x11f))/0x1+parseInt(_0x3e376d(0x134))/0x2+parseInt(_0x3e376d(0xd3))/0x3*(-parseInt(_0x3e376d(0x150))/0x4)+-parseInt(_0x3e376d(0xb3))/0x5+parseInt(_0x3e376d(0x12e))/0x6*(parseInt(_0x3e376d(0x100))/0x7)+-parseInt(_0x3e376d(0xd0))/0x8*(-parseInt(_0x3e376d(0xed))/0x9)+parseInt(_0x3e376d(0xff))/0xa*(parseInt(_0x3e376d(0xfa))/0xb);if(_0x3eaf42===_0x1c02a3)break;else _0x307f2b['push'](_0x307f2b['shift']());}catch(_0x2c323b){_0x307f2b['push'](_0x307f2b['shift']());}}}(a58_0x2d28,0x3a613));var __importDefault=this&&this['__importDefault']||function(_0x465a0b){const _0x1e6371=a58_0x8380;return _0x465a0b&&_0x465a0b[_0x1e6371(0xec)]?_0x465a0b:{'default':_0x465a0b};};function a58_0x2d28(){const _0x5bf5a2=['balance','parse','aggregate','üìä\x20Final\x20WHERE\x20conditions:','amountUSDT','gte','error','getTime','filter','publicKey','CoinToPay','\x20USDT','Error\x20parsing\x20webhook\x20events:','createPublicPayment','update','payout','findFirst','USDT\x20BSC','log','currency','usdtErcWallet','getPayoutStats','Failed\x20to\x20send\x20webhook:\x20','256530IjIoux','getPaymentById','ShopService','toLowerCase','test_payment_123','erc20','Plisio','getShopProfile','üìÖ\x20Date\x20end:\x20','getPayouts','findUnique','telegram','push','getFullYear','count','469122rtoUWa','paid','country','YESTERDAY','status','getMonth','198328lXxtVK','POST','shopUrl','test_order_123','all','üìä\x20Shop\x20','merchantUrl','getWebhookLogs','üåê\x20Method\x20filter:\x20','toISOString','USDT\x20Polygon','reduce','shop','default','Payment\x20not\x20found','USD','getGatewayDisplayName','findMany','awaitingPayout','sourceCurrency','name','yesterday','REJECTED','Noda','USDC\x20Polygon','periodTo','updatePayment','usdtPolygonWallet','62028lIdbAT','generateDailyStatistics','toUpperCase','webhookUrl','isArray','getPayoutStatistics','getPaymentByShopAndId','formatNetworkName','Shop\x20not\x20found','usdtTrcWallet','test','set','üìÖ\x20Date\x20start:\x20','getDate','message','responseBody','Webhook\x20returned\x20error:\x20','webhookEvents','createdAt','1527165IvCknT','telegramId','\x20payout\x20statistics\x20calculated:','\x20\x20\x20üìÖ\x20This\x20month:\x20','asc','paidAt','PaymentService','Test\x20webhook\x20sent\x20successfully\x20(','customerName','username','webhookLog','maxPayments','notes','üåê\x20Network\x20filter:\x20','getShopPayoutStats','\x20\x20\x20üíµ\x20Available\x20balance:\x20','ceil','test_gateway','statusText','split','payment','updateShopProfile','desc','PENDING','get','./paymentService','./currencyService','totalPaidOut','usage','37592sAHBPr','redirectUrl','revenue','57oAbXpM','statusCode','KLYME\x20GB','Rapyd','stringify','getPaymentsByShop','language','map','thisMonth','gateway','USDT\x20ERC20','\x20USDT\x20(current\x20balance)','gateways','USDT\x20TRC20','round','delete','setDate','paymentService','30d','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','setHours','PAID','gatewaySettings','trc20','COMPLETED','__esModule','666djPDkY','../config/database','periodFrom','paymentId','üìä\x20Status\x20filter:\x20','testWebhook','dailyPayments','txid','paymentGateways','network','90d','currencyService','application/json','231HICAml','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','usdcPolygonWallet','getPayoutById','üìÖ\x20Period\x20start:\x20','27420DVRwsd','7WgDrYi','day','amount','getStatistics','wallets','TesSoft\x20Payment\x20System/1.0\x20(Test)','settings','lte'];a58_0x2d28=function(){return _0x5bf5a2;};return a58_0x2d28();}Object['defineProperty'](exports,a58_0xb53e84(0xec),{'value':!![]}),exports[a58_0xb53e84(0x121)]=void 0x0;const database_1=__importDefault(require(a58_0xb53e84(0xee))),currencyService_1=require(a58_0xb53e84(0xcd)),paymentService_1=require(a58_0xb53e84(0xcc));function a58_0x8380(_0x28c05b,_0x4efb20){const _0x2d2829=a58_0x2d28();return a58_0x8380=function(_0x838010,_0x44aed0){_0x838010=_0x838010-0xa2;let _0x347b6a=_0x2d2829[_0x838010];return _0x347b6a;},a58_0x8380(_0x28c05b,_0x4efb20);}class ShopService{constructor(){const _0x5be0ad=a58_0xb53e84;this[_0x5be0ad(0xe4)]=new paymentService_1[(_0x5be0ad(0xb9))]();}async[a58_0xb53e84(0x126)](_0x4a2650){const _0xf80ab6=a58_0xb53e84,_0x5641aa=await database_1[_0xf80ab6(0x141)][_0xf80ab6(0x140)][_0xf80ab6(0x129)]({'where':{'id':_0x4a2650},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x5641aa)throw new Error(_0xf80ab6(0xa8));let _0x4bb75d=[];if(_0x5641aa[_0xf80ab6(0x106)]?.[_0xf80ab6(0xb1)])try{_0x4bb75d=Array[_0xf80ab6(0xa4)](_0x5641aa['settings']['webhookEvents'])?_0x5641aa['settings'][_0xf80ab6(0xb1)]:JSON[_0xf80ab6(0x109)](_0x5641aa[_0xf80ab6(0x106)][_0xf80ab6(0xb1)]);}catch(_0x43b9a5){console['error'](_0xf80ab6(0x114),_0x43b9a5),_0x4bb75d=[];}return{'id':_0x5641aa['id'],'fullName':_0x5641aa[_0xf80ab6(0x148)],'username':_0x5641aa[_0xf80ab6(0xbc)],'telegramId':_0x5641aa[_0xf80ab6(0x12a)],'merchantUrl':_0x5641aa[_0xf80ab6(0x136)],'gateways':_0x5641aa['paymentGateways']?JSON[_0xf80ab6(0x109)](_0x5641aa['paymentGateways']):null,'gatewaySettings':_0x5641aa[_0xf80ab6(0xe9)]?JSON['parse'](_0x5641aa['gatewaySettings']):null,'publicKey':_0x5641aa[_0xf80ab6(0x111)],'webhookUrl':_0x5641aa[_0xf80ab6(0x106)]?.[_0xf80ab6(0xa3)]||null,'webhookEvents':_0x4bb75d,'wallets':{'usdtPolygonWallet':_0x5641aa[_0xf80ab6(0x14f)],'usdtTrcWallet':_0x5641aa[_0xf80ab6(0xa9)],'usdtErcWallet':_0x5641aa[_0xf80ab6(0x11c)],'usdcPolygonWallet':_0x5641aa['usdcPolygonWallet']},'status':_0x5641aa[_0xf80ab6(0x132)],'createdAt':_0x5641aa[_0xf80ab6(0xb2)]};}async[a58_0xb53e84(0xc8)](_0x5c80a5,_0x22c5df){const _0x2e8a09=a58_0xb53e84,_0x2c1bb9={};_0x22c5df['fullName']&&(_0x2c1bb9[_0x2e8a09(0x148)]=_0x22c5df['fullName']);_0x22c5df[_0x2e8a09(0xb4)]!==undefined&&(_0x2c1bb9[_0x2e8a09(0x12a)]=_0x22c5df[_0x2e8a09(0xb4)]||null);_0x22c5df[_0x2e8a09(0x13a)]&&(_0x2c1bb9['shopUrl']=_0x22c5df[_0x2e8a09(0x13a)]);_0x22c5df['gateways']&&(_0x2c1bb9[_0x2e8a09(0xf5)]=JSON['stringify'](_0x22c5df[_0x2e8a09(0xdf)]));_0x22c5df[_0x2e8a09(0xe9)]&&(_0x2c1bb9['gatewaySettings']=JSON[_0x2e8a09(0xd7)](_0x22c5df[_0x2e8a09(0xe9)]));_0x22c5df[_0x2e8a09(0x104)]&&(_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0x14f)]!==undefined&&(_0x2c1bb9[_0x2e8a09(0x14f)]=_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0x14f)]||null),_0x22c5df[_0x2e8a09(0x104)]['usdtTrcWallet']!==undefined&&(_0x2c1bb9['usdtTrcWallet']=_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0xa9)]||null),_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0x11c)]!==undefined&&(_0x2c1bb9['usdtErcWallet']=_0x22c5df['wallets'][_0x2e8a09(0x11c)]||null),_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0xfc)]!==undefined&&(_0x2c1bb9['usdcPolygonWallet']=_0x22c5df[_0x2e8a09(0x104)][_0x2e8a09(0xfc)]||null));const _0x3cd2ae=await database_1[_0x2e8a09(0x141)][_0x2e8a09(0x140)][_0x2e8a09(0x116)]({'where':{'id':_0x5c80a5},'data':_0x2c1bb9,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x59c504=[];if(_0x3cd2ae[_0x2e8a09(0x106)]?.[_0x2e8a09(0xb1)])try{_0x59c504=Array['isArray'](_0x3cd2ae[_0x2e8a09(0x106)][_0x2e8a09(0xb1)])?_0x3cd2ae['settings'][_0x2e8a09(0xb1)]:JSON[_0x2e8a09(0x109)](_0x3cd2ae[_0x2e8a09(0x106)]['webhookEvents']);}catch(_0x10c836){console[_0x2e8a09(0x10e)](_0x2e8a09(0x114),_0x10c836),_0x59c504=[];}return{'id':_0x3cd2ae['id'],'fullName':_0x3cd2ae[_0x2e8a09(0x148)],'username':_0x3cd2ae[_0x2e8a09(0xbc)],'telegramId':_0x3cd2ae[_0x2e8a09(0x12a)],'merchantUrl':_0x3cd2ae['shopUrl'],'gateways':_0x3cd2ae[_0x2e8a09(0xf5)]?JSON[_0x2e8a09(0x109)](_0x3cd2ae['paymentGateways']):null,'gatewaySettings':_0x3cd2ae['gatewaySettings']?JSON[_0x2e8a09(0x109)](_0x3cd2ae[_0x2e8a09(0xe9)]):null,'publicKey':_0x3cd2ae[_0x2e8a09(0x111)],'webhookUrl':_0x3cd2ae[_0x2e8a09(0x106)]?.[_0x2e8a09(0xa3)]||null,'webhookEvents':_0x59c504,'wallets':{'usdtPolygonWallet':_0x3cd2ae[_0x2e8a09(0x14f)],'usdtTrcWallet':_0x3cd2ae[_0x2e8a09(0xa9)],'usdtErcWallet':_0x3cd2ae[_0x2e8a09(0x11c)],'usdcPolygonWallet':_0x3cd2ae[_0x2e8a09(0xfc)]},'status':_0x3cd2ae[_0x2e8a09(0x132)],'createdAt':_0x3cd2ae[_0x2e8a09(0xb2)]};}async['updateWallets'](_0x4e2c72,_0x20389e){const _0x4f9e64=a58_0xb53e84,_0x20ca19={};_0x20389e['usdtPolygonWallet']!==undefined&&(_0x20ca19[_0x4f9e64(0x14f)]=_0x20389e['usdtPolygonWallet']||null),_0x20389e[_0x4f9e64(0xa9)]!==undefined&&(_0x20ca19[_0x4f9e64(0xa9)]=_0x20389e[_0x4f9e64(0xa9)]||null),_0x20389e[_0x4f9e64(0x11c)]!==undefined&&(_0x20ca19['usdtErcWallet']=_0x20389e[_0x4f9e64(0x11c)]||null),_0x20389e[_0x4f9e64(0xfc)]!==undefined&&(_0x20ca19[_0x4f9e64(0xfc)]=_0x20389e[_0x4f9e64(0xfc)]||null),await database_1['default'][_0x4f9e64(0x140)][_0x4f9e64(0x116)]({'where':{'id':_0x4e2c72},'data':_0x20ca19});}async[a58_0xb53e84(0xf2)](_0x3d9262){const _0x1c90d6=a58_0xb53e84,_0x31883c=await database_1['default'][_0x1c90d6(0x140)][_0x1c90d6(0x129)]({'where':{'id':_0x3d9262},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x31883c?.[_0x1c90d6(0x106)]?.['webhookUrl'])throw new Error('No\x20webhook\x20URL\x20configured');const _0x1eea45={'event':_0x1c90d6(0xaa),'payment':{'id':_0x1c90d6(0x123),'order_id':_0x1c90d6(0x137),'gateway':_0x1c90d6(0xaa),'amount':0x64,'currency':_0x1c90d6(0x143),'status':_0x1c90d6(0x12f),'created_at':new Date()[_0x1c90d6(0x13d)]()}};try{const _0x1a41dc=await fetch(_0x31883c[_0x1c90d6(0x106)][_0x1c90d6(0xa3)],{'method':_0x1c90d6(0x135),'headers':{'Content-Type':_0x1c90d6(0xf9),'User-Agent':_0x1c90d6(0x105)},'body':JSON[_0x1c90d6(0xd7)](_0x1eea45)});return _0x1a41dc['ok']?{'success':!![],'message':_0x1c90d6(0xba)+_0x1a41dc[_0x1c90d6(0x132)]+')'}:{'success':![],'message':_0x1c90d6(0xb0)+_0x1a41dc['status']+'\x20'+_0x1a41dc[_0x1c90d6(0xc5)]};}catch(_0x4e1b7d){return{'success':![],'message':_0x1c90d6(0x11e)+(_0x4e1b7d instanceof Error?_0x4e1b7d[_0x1c90d6(0xae)]:'Unknown\x20error')};}}async['createPayment'](_0x239497){const _0x4e8d0b=a58_0xb53e84;return this['paymentService'][_0x4e8d0b(0x115)]({'public_key':'','gateway':_0x239497[_0x4e8d0b(0xdc)],'order_id':undefined,'amount':_0x239497['amount'],'currency':_0x239497['currency'],'source_currency':_0x239497[_0x4e8d0b(0x147)],'usage':_0x239497[_0x4e8d0b(0xcf)],'expires_at':_0x239497['expiresAt']?.[_0x4e8d0b(0x13d)](),'success_url':_0x239497[_0x4e8d0b(0xd1)],'fail_url':_0x239497[_0x4e8d0b(0xd1)],'customer_email':_0x239497['customerEmail'],'customer_name':_0x239497[_0x4e8d0b(0xbb)],'country':_0x239497[_0x4e8d0b(0x130)],'language':_0x239497[_0x4e8d0b(0xd9)],'amount_is_editable':_0x239497['amountIsEditable'],'max_payments':_0x239497[_0x4e8d0b(0xbe)],'customer':_0x239497['customer']});}async['getPayments'](_0xd70c6e,_0x21c608){const _0x41f778=a58_0xb53e84;return this[_0x41f778(0xe4)][_0x41f778(0xd8)](_0xd70c6e,_0x21c608);}async[a58_0xb53e84(0x120)](_0x17d9bc,_0x193e75){const _0x471317=a58_0xb53e84;return this['paymentService'][_0x471317(0xa6)](_0x17d9bc,_0x193e75);}async[a58_0xb53e84(0x14e)](_0x1481e3,_0x2dcbc9,_0x228c1e){const _0x5477e1=a58_0xb53e84,_0x3657a7=await database_1['default'][_0x5477e1(0xc7)][_0x5477e1(0x118)]({'where':{'id':_0x2dcbc9,'shopId':_0x1481e3}});if(!_0x3657a7)throw new Error(_0x5477e1(0x142));const _0x37a49a=await database_1[_0x5477e1(0x141)][_0x5477e1(0xc7)][_0x5477e1(0x116)]({'where':{'id':_0x2dcbc9},'data':{..._0x228c1e,'updatedAt':new Date()}});return _0x37a49a;}async['deletePayment'](_0x14def9,_0x662093){const _0x469a73=a58_0xb53e84,_0x287360=await database_1[_0x469a73(0x141)][_0x469a73(0xc7)][_0x469a73(0x118)]({'where':{'id':_0x662093,'shopId':_0x14def9}});if(!_0x287360)throw new Error(_0x469a73(0x142));await database_1[_0x469a73(0x141)][_0x469a73(0xc7)][_0x469a73(0xe2)]({'where':{'id':_0x662093}});}[a58_0xb53e84(0xa7)](_0x57dad5){const _0x409e3a=a58_0xb53e84,_0x50fe83={'polygon':_0x409e3a(0x13e),'trc20':_0x409e3a(0xe0),'erc20':_0x409e3a(0xdd),'bsc':_0x409e3a(0x119),'polygon_usdc':_0x409e3a(0x14c)};return _0x50fe83[_0x57dad5]||_0x57dad5;}async[a58_0xb53e84(0x128)](_0x234367,_0x55e3d3){const _0x14303a=a58_0xb53e84,{page:_0x9b5ab1,limit:_0x1ef9d5,status:_0xe8f5cf,method:_0x278764,network:_0x2bc17a,dateFrom:_0x4c25cc,dateTo:_0x587f7a,periodFrom:_0x4e89c0,periodTo:_0x133d6c}=_0x55e3d3,_0x2519b6=(_0x9b5ab1-0x1)*_0x1ef9d5;console[_0x14303a(0x11a)]('üí∞\x20Getting\x20payouts\x20with\x20filters:',_0x55e3d3);const _0x10a6b6={'shopId':_0x234367};_0xe8f5cf&&(_0x10a6b6['status']=_0xe8f5cf[_0x14303a(0xa2)](),console['log'](_0x14303a(0xf1)+_0xe8f5cf[_0x14303a(0xa2)]()));if(_0x278764)_0x10a6b6[_0x14303a(0xf6)]=_0x278764,console[_0x14303a(0x11a)](_0x14303a(0x13c)+_0x278764);else _0x2bc17a&&(_0x10a6b6[_0x14303a(0xf6)]=_0x2bc17a,console[_0x14303a(0x11a)](_0x14303a(0xc0)+_0x2bc17a));if(_0x4c25cc||_0x587f7a||_0x4e89c0||_0x133d6c){_0x10a6b6[_0x14303a(0xb2)]={};if(_0x4e89c0){const _0x5ccea5=new Date(_0x4e89c0);_0x5ccea5[_0x14303a(0xe7)](0x0,0x0,0x0,0x0),_0x10a6b6[_0x14303a(0xb2)][_0x14303a(0x10d)]=_0x5ccea5,console[_0x14303a(0x11a)](_0x14303a(0xfe)+_0x5ccea5[_0x14303a(0x13d)]());}else{if(_0x4c25cc){const _0x1ed75a=new Date(_0x4c25cc);_0x1ed75a[_0x14303a(0xe7)](0x0,0x0,0x0,0x0),_0x10a6b6[_0x14303a(0xb2)]['gte']=_0x1ed75a,console[_0x14303a(0x11a)](_0x14303a(0xac)+_0x1ed75a[_0x14303a(0x13d)]());}}if(_0x133d6c){const _0x4fbfff=new Date(_0x133d6c);_0x4fbfff['setHours'](0x17,0x3b,0x3b,0x3e7),_0x10a6b6[_0x14303a(0xb2)][_0x14303a(0x107)]=_0x4fbfff,console[_0x14303a(0x11a)]('üìÖ\x20Period\x20end:\x20'+_0x4fbfff['toISOString']());}else{if(_0x587f7a){const _0x1daa82=new Date(_0x587f7a);_0x1daa82[_0x14303a(0xe7)](0x17,0x3b,0x3b,0x3e7),_0x10a6b6[_0x14303a(0xb2)][_0x14303a(0x107)]=_0x1daa82,console[_0x14303a(0x11a)](_0x14303a(0x127)+_0x1daa82['toISOString']());}}}console['log'](_0x14303a(0x10b),JSON[_0x14303a(0xd7)](_0x10a6b6,null,0x2));const [_0x51f12e,_0x58feb1]=await Promise[_0x14303a(0x138)]([database_1[_0x14303a(0x141)][_0x14303a(0x117)][_0x14303a(0x145)]({'where':_0x10a6b6,'skip':_0x2519b6,'take':_0x1ef9d5,'orderBy':{'createdAt':_0x14303a(0xc9)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x14303a(0x141)][_0x14303a(0x117)][_0x14303a(0x12d)]({'where':_0x10a6b6})]);return{'payouts':_0x51f12e[_0x14303a(0xda)](_0x524631=>{const _0x1c5ba6=_0x14303a;let _0x2c368c=null;switch(_0x524631[_0x1c5ba6(0xf6)]){case'polygon':_0x2c368c=_0x524631[_0x1c5ba6(0x140)][_0x1c5ba6(0x14f)];break;case _0x1c5ba6(0xea):_0x2c368c=_0x524631[_0x1c5ba6(0x140)]['usdtTrcWallet'];break;case _0x1c5ba6(0x124):_0x2c368c=_0x524631['shop']['usdtErcWallet'];break;case'polygon_usdc':_0x2c368c=_0x524631[_0x1c5ba6(0x140)]['usdcPolygonWallet'];break;}return{'id':_0x524631['id'],'amount':_0x524631[_0x1c5ba6(0x102)],'network':this['formatNetworkName'](_0x524631[_0x1c5ba6(0xf6)]),'wallet':_0x2c368c,'status':_0x524631[_0x1c5ba6(0x132)],'txid':_0x524631['txid'],'notes':_0x524631['notes'],'periodFrom':_0x524631[_0x1c5ba6(0xef)],'periodTo':_0x524631[_0x1c5ba6(0x14d)],'createdAt':_0x524631[_0x1c5ba6(0xb2)],'paidAt':_0x524631[_0x1c5ba6(0xb8)]};}),'pagination':{'page':_0x9b5ab1,'limit':_0x1ef9d5,'total':_0x58feb1,'totalPages':Math[_0x14303a(0xc3)](_0x58feb1/_0x1ef9d5)}};}async[a58_0xb53e84(0xfd)](_0x551484,_0x144664){const _0x1c467e=a58_0xb53e84,_0x50b8d2=await database_1[_0x1c467e(0x141)][_0x1c467e(0x117)][_0x1c467e(0x118)]({'where':{'id':_0x144664,'shopId':_0x551484}});if(!_0x50b8d2)return null;return{'id':_0x50b8d2['id'],'amount':_0x50b8d2[_0x1c467e(0x102)],'network':_0x50b8d2[_0x1c467e(0xf6)],'status':_0x50b8d2[_0x1c467e(0x132)],'txid':_0x50b8d2[_0x1c467e(0xf4)],'notes':_0x50b8d2[_0x1c467e(0xbf)],'createdAt':_0x50b8d2[_0x1c467e(0xb2)],'paidAt':_0x50b8d2[_0x1c467e(0xb8)]};}async[a58_0xb53e84(0xa5)](_0x40886a,_0x32983d){const _0x22b1ea=a58_0xb53e84,_0x3cd9a3=new Date();let _0x93ae79,_0x131377;switch(_0x32983d){case'yesterday':case _0x22b1ea(0x131):const _0x367b90=new Date(_0x3cd9a3);_0x367b90[_0x22b1ea(0xe3)](_0x367b90[_0x22b1ea(0xad)]()-0x1),_0x93ae79=new Date(_0x367b90),_0x93ae79[_0x22b1ea(0xe7)](0x0,0x0,0x0,0x0),_0x131377=new Date(_0x367b90),_0x131377[_0x22b1ea(0xe7)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x93ae79=new Date(_0x3cd9a3[_0x22b1ea(0x10f)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x22b1ea(0xe5):_0x93ae79=new Date(_0x3cd9a3[_0x22b1ea(0x10f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x22b1ea(0xf7):_0x93ae79=new Date(_0x3cd9a3[_0x22b1ea(0x10f)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x93ae79=new Date(_0x3cd9a3[_0x22b1ea(0x10f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x8c8608={'gte':_0x93ae79};_0x131377&&(_0x8c8608[_0x22b1ea(0x107)]=_0x131377);const [_0x5329ab,_0x359166,_0x551026,_0x387aec,_0x535c58,_0x4fe4ed]=await Promise[_0x22b1ea(0x138)]([database_1['default']['payout']['count']({'where':{'shopId':_0x40886a,'createdAt':_0x8c8608}}),database_1[_0x22b1ea(0x141)][_0x22b1ea(0x117)][_0x22b1ea(0x12d)]({'where':{'shopId':_0x40886a,'status':_0x22b1ea(0xeb),'createdAt':_0x8c8608}}),database_1[_0x22b1ea(0x141)][_0x22b1ea(0x117)][_0x22b1ea(0x12d)]({'where':{'shopId':_0x40886a,'status':_0x22b1ea(0xca),'createdAt':_0x8c8608}}),database_1[_0x22b1ea(0x141)][_0x22b1ea(0x117)][_0x22b1ea(0x12d)]({'where':{'shopId':_0x40886a,'status':_0x22b1ea(0x14a),'createdAt':_0x8c8608}}),database_1[_0x22b1ea(0x141)]['payout'][_0x22b1ea(0x145)]({'where':{'shopId':_0x40886a,'createdAt':_0x8c8608},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x22b1ea(0x141)][_0x22b1ea(0x117)]['findMany']({'where':{'shopId':_0x40886a},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x8043b6=_0x535c58['reduce']((_0x43af89,_0x2e7e99)=>_0x43af89+_0x2e7e99['amount'],0x0),_0x2abf23=_0x535c58[_0x22b1ea(0x110)](_0x562118=>_0x562118[_0x22b1ea(0x132)]===_0x22b1ea(0xeb))[_0x22b1ea(0x13f)]((_0x33cfa2,_0x1f79fa)=>_0x33cfa2+_0x1f79fa[_0x22b1ea(0x102)],0x0),_0x26e02c=_0x535c58[_0x22b1ea(0x110)](_0x4b4c7b=>_0x4b4c7b['status']==='PENDING')[_0x22b1ea(0x13f)]((_0x417d45,_0x44cf15)=>_0x417d45+_0x44cf15[_0x22b1ea(0x102)],0x0),_0x338930=_0x535c58[_0x22b1ea(0x13f)]((_0xdbcc51,_0x596140)=>{const _0x48e517=_0x22b1ea;return _0xdbcc51[_0x596140[_0x48e517(0xf6)]]=(_0xdbcc51[_0x596140[_0x48e517(0xf6)]]||0x0)+0x1,_0xdbcc51;},{}),_0x5f2997=_0x535c58[_0x22b1ea(0x13f)]((_0x503841,_0x44e31b)=>{const _0xf82ead=_0x22b1ea;return _0x503841[_0x44e31b[_0xf82ead(0x132)]]=(_0x503841[_0x44e31b[_0xf82ead(0x132)]]||0x0)+0x1,_0x503841;},{});return{'totalPayouts':_0x5329ab,'completedPayouts':_0x359166,'pendingPayouts':_0x551026,'rejectedPayouts':_0x387aec,'totalAmount':_0x8043b6,'completedAmount':_0x2abf23,'pendingAmount':_0x26e02c,'payoutsByMethod':_0x338930,'payoutsByStatus':_0x5f2997,'recentPayouts':_0x4fe4ed[_0x22b1ea(0xda)](_0x4bf76f=>({'id':_0x4bf76f['id'],'shopId':_0x40886a,'amount':_0x4bf76f[_0x22b1ea(0x102)],'method':_0x4bf76f[_0x22b1ea(0xf6)],'status':_0x4bf76f[_0x22b1ea(0x132)],'txid':_0x4bf76f[_0x22b1ea(0xf4)],'createdAt':_0x4bf76f[_0x22b1ea(0xb2)],'paidAt':_0x4bf76f[_0x22b1ea(0xb8)]}))};}async[a58_0xb53e84(0xc1)](_0x475104){const _0x33334b=a58_0xb53e84;console[_0x33334b(0x11a)](_0x33334b(0xfb)+_0x475104+'...');const _0x5c8533=await database_1[_0x33334b(0x141)]['shop'][_0x33334b(0x129)]({'where':{'id':_0x475104},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x5c8533)throw new Error(_0x33334b(0xa8));const _0x419771=new Date(),_0x4245c7=new Date(_0x419771[_0x33334b(0x12c)](),_0x419771[_0x33334b(0x133)](),0x1),_0x11cc33=new Date(_0x419771['getFullYear'](),_0x419771[_0x33334b(0x133)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x5cc10e=await database_1['default'][_0x33334b(0x117)][_0x33334b(0x10a)]({'_sum':{'amount':!![]},'where':{'shopId':_0x475104,'createdAt':{'gte':_0x4245c7,'lte':_0x11cc33},'status':'COMPLETED'}}),_0x5ad4f2=_0x5cc10e['_sum'][_0x33334b(0x102)]||0x0,_0x33b377={'availableBalance':Math[_0x33334b(0xe1)](_0x5c8533[_0x33334b(0x108)]*0x64)/0x64,'totalPaidOut':Math[_0x33334b(0xe1)](_0x5c8533[_0x33334b(0xce)]*0x64)/0x64,'awaitingPayout':Math[_0x33334b(0xe1)](_0x5c8533['balance']*0x64)/0x64,'thisMonth':Math['round'](_0x5ad4f2*0x64)/0x64};return console[_0x33334b(0x11a)](_0x33334b(0x139)+_0x5c8533[_0x33334b(0xbc)]+_0x33334b(0xb5)),console[_0x33334b(0x11a)](_0x33334b(0xc2)+_0x33b377['availableBalance']+'\x20USDT\x20(current\x20balance)'),console['log'](_0x33334b(0xe6)+_0x33b377['totalPaidOut']+'\x20USDT\x20(total\x20payouts)'),console[_0x33334b(0x11a)]('\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20'+_0x33b377[_0x33334b(0x146)]+_0x33334b(0xde)),console[_0x33334b(0x11a)](_0x33334b(0xb6)+_0x33b377[_0x33334b(0xdb)]+_0x33334b(0x113)),_0x33b377;}[a58_0xb53e84(0x144)](_0x6d762c){const _0x1ec59e=a58_0xb53e84,_0x3985d0={'test_gateway':'Test\x20Gateway','plisio':_0x1ec59e(0x125),'rapyd':_0x1ec59e(0xd6),'noda':_0x1ec59e(0x14b),'cointopay':_0x1ec59e(0x112),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x1ec59e(0xd5),'klyme_de':'KLYME\x20DE'};return _0x3985d0[_0x6d762c]||_0x6d762c;}async[a58_0xb53e84(0x11d)](_0x504a7b){const _0x33a8bf=a58_0xb53e84;return this[_0x33a8bf(0xc1)](_0x504a7b);}async[a58_0xb53e84(0x13b)](_0x26994e,_0x35720d){const _0x20aa9d=a58_0xb53e84,{page:_0x33ca13,limit:_0x2793a7,paymentId:_0x52e460}=_0x35720d,_0x17817a=(_0x33ca13-0x1)*_0x2793a7,_0x3e8215={'shopId':_0x26994e};_0x52e460&&(_0x3e8215[_0x20aa9d(0xf0)]=_0x52e460);const [_0x1dfe89,_0x5c006e]=await Promise[_0x20aa9d(0x138)]([database_1[_0x20aa9d(0x141)]['webhookLog'][_0x20aa9d(0x145)]({'where':_0x3e8215,'skip':_0x17817a,'take':_0x2793a7,'orderBy':{'createdAt':_0x20aa9d(0xc9)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x20aa9d(0x141)][_0x20aa9d(0xbd)][_0x20aa9d(0x12d)]({'where':_0x3e8215})]);return{'logs':_0x1dfe89[_0x20aa9d(0xda)](_0x2f73e5=>({'id':_0x2f73e5['id'],'paymentId':_0x2f73e5[_0x20aa9d(0xf0)],'shopId':_0x2f73e5['shopId'],'event':_0x2f73e5['event'],'statusCode':_0x2f73e5[_0x20aa9d(0xd4)],'retryCount':_0x2f73e5['retryCount'],'responseBody':_0x2f73e5[_0x20aa9d(0xaf)],'createdAt':_0x2f73e5[_0x20aa9d(0xb2)],'payment':_0x2f73e5[_0x20aa9d(0xc7)]})),'pagination':{'page':_0x33ca13,'limit':_0x2793a7,'total':_0x5c006e,'totalPages':Math[_0x20aa9d(0xc3)](_0x5c006e/_0x2793a7)}};}async[a58_0xb53e84(0x103)](_0x2826a3,_0x5e38f3){const _0x4b9e4e=a58_0xb53e84,_0x3876ec=new Date();let _0xf0f249,_0x560287;switch(_0x5e38f3[_0x4b9e4e(0x122)]()){case _0x4b9e4e(0x101):_0xf0f249=new Date(_0x3876ec[_0x4b9e4e(0x12c)](),_0x3876ec['getMonth'](),_0x3876ec['getDate'](),0x0,0x0,0x0,0x0);break;case _0x4b9e4e(0x149):case _0x4b9e4e(0x131):const _0x1764bc=new Date(_0x3876ec);_0x1764bc['setDate'](_0x1764bc[_0x4b9e4e(0xad)]()-0x1),_0xf0f249=new Date(_0x1764bc),_0xf0f249[_0x4b9e4e(0xe7)](0x0,0x0,0x0,0x0),_0x560287=new Date(_0x1764bc),_0x560287[_0x4b9e4e(0xe7)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0xf0f249=new Date(_0x3876ec['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x4b9e4e(0xe5):_0xf0f249=new Date(_0x3876ec['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0xf0f249=new Date(_0x3876ec[_0x4b9e4e(0x10f)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xf0f249=new Date(_0x3876ec[_0x4b9e4e(0x10f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x216778={'gte':_0xf0f249};_0x560287&&(_0x216778[_0x4b9e4e(0x107)]=_0x560287);const [_0x3dfacd,_0x15ed1c,_0x24588e,_0x300f36,_0x1db408]=await Promise[_0x4b9e4e(0x138)]([database_1[_0x4b9e4e(0x141)][_0x4b9e4e(0xc7)][_0x4b9e4e(0x12d)]({'where':{'shopId':_0x2826a3,'gateway':{'not':_0x4b9e4e(0xc4)},'createdAt':_0x216778}}),database_1['default'][_0x4b9e4e(0xc7)]['count']({'where':{'shopId':_0x2826a3,'gateway':{'not':_0x4b9e4e(0xc4)},'status':_0x4b9e4e(0xe8),'createdAt':_0x216778}}),database_1[_0x4b9e4e(0x141)][_0x4b9e4e(0xc7)][_0x4b9e4e(0x145)]({'where':{'shopId':_0x2826a3,'gateway':{'not':_0x4b9e4e(0xc4)},'status':'PAID','createdAt':_0x216778},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x4b9e4e(0x141)][_0x4b9e4e(0xc7)]['findMany']({'where':{'shopId':_0x2826a3,'gateway':{'not':_0x4b9e4e(0xc4)}},'take':0xa,'orderBy':{'createdAt':_0x4b9e4e(0xc9)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x4b9e4e(0x141)][_0x4b9e4e(0xc7)]['findMany']({'where':{'shopId':_0x2826a3,'gateway':{'not':'test_gateway'},'createdAt':_0x216778},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x4b9e4e(0xb7)}})]);let _0x56002b=0x0;for(const _0x5b1d71 of _0x24588e){if(_0x5b1d71[_0x4b9e4e(0x10c)])_0x56002b+=_0x5b1d71[_0x4b9e4e(0x10c)];else{const _0x3a2327=await currencyService_1[_0x4b9e4e(0xf8)]['convertToUSDT'](_0x5b1d71[_0x4b9e4e(0x102)],_0x5b1d71[_0x4b9e4e(0x11b)]);_0x56002b+=_0x3a2327;}}const _0x22047e=this[_0x4b9e4e(0x151)](_0x1db408,_0xf0f249,_0x560287||_0x3876ec),_0x5f3dc8=_0x3dfacd>0x0?_0x15ed1c/_0x3dfacd*0x64:0x0;return{'totalPayments':_0x3dfacd,'successfulPayments':_0x15ed1c,'totalRevenue':Math[_0x4b9e4e(0xe1)](_0x56002b*0x64)/0x64,'conversionRate':Math[_0x4b9e4e(0xe1)](_0x5f3dc8*0x64)/0x64,'dailyRevenue':_0x22047e['dailyRevenue'],'dailyPayments':_0x22047e[_0x4b9e4e(0xf3)],'recentPayments':_0x300f36[_0x4b9e4e(0xda)](_0x4644ae=>({'id':_0x4644ae['id'],'gateway':_0x4644ae[_0x4b9e4e(0xdc)],'amount':_0x4644ae[_0x4b9e4e(0x102)],'currency':_0x4644ae[_0x4b9e4e(0x11b)],'status':_0x4644ae[_0x4b9e4e(0x132)],'createdAt':_0x4644ae[_0x4b9e4e(0xb2)]}))};}[a58_0xb53e84(0x151)](_0x95cbd7,_0x1ff31f,_0x4865d6){const _0x1af14c=a58_0xb53e84,_0x28665b=new Map(),_0x5a5f55=new Date(_0x1ff31f);while(_0x5a5f55<=_0x4865d6){const _0x44065b=_0x5a5f55[_0x1af14c(0x13d)]()['split']('T')[0x0];_0x28665b[_0x1af14c(0xab)](_0x44065b,{'revenue':0x0,'count':0x0}),_0x5a5f55['setDate'](_0x5a5f55[_0x1af14c(0xad)]()+0x1);}for(const _0x5600de of _0x95cbd7){const _0x42b42f=_0x5600de[_0x1af14c(0xb2)][_0x1af14c(0x13d)]()[_0x1af14c(0xc6)]('T')[0x0],_0x422366=_0x28665b[_0x1af14c(0xcb)](_0x42b42f);_0x422366&&(_0x422366['count']+=0x1,_0x5600de[_0x1af14c(0x132)]===_0x1af14c(0xe8)&&_0x5600de['amountUSDT']&&(_0x422366[_0x1af14c(0xd2)]+=_0x5600de[_0x1af14c(0x10c)]));}const _0x2d1fdc=[],_0x2de8c3=[];for(const [_0x22b5d2,_0x244cf8]of _0x28665b){_0x2d1fdc[_0x1af14c(0x12b)]({'date':_0x22b5d2,'amount':Math[_0x1af14c(0xe1)](_0x244cf8['revenue']*0x64)/0x64}),_0x2de8c3[_0x1af14c(0x12b)]({'date':_0x22b5d2,'count':_0x244cf8['count']});}return{'dailyRevenue':_0x2d1fdc,'dailyPayments':_0x2de8c3};}}exports['ShopService']=ShopService;