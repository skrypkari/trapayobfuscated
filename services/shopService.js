'use strict';function a54_0x56b4(_0x1198da,_0x52e03c){const _0x4c7a1d=a54_0x4c7a();return a54_0x56b4=function(_0x56b413,_0x5a37df){_0x56b413=_0x56b413-0x159;let _0x2b1a84=_0x4c7a1d[_0x56b413];return _0x2b1a84;},a54_0x56b4(_0x1198da,_0x52e03c);}const a54_0x2b5ea8=a54_0x56b4;(function(_0x2d9daa,_0x55a090){const _0x157dae=a54_0x56b4,_0xfd051a=_0x2d9daa();while(!![]){try{const _0x21c9b6=-parseInt(_0x157dae(0x1ce))/0x1+parseInt(_0x157dae(0x203))/0x2*(parseInt(_0x157dae(0x159))/0x3)+parseInt(_0x157dae(0x1ff))/0x4+parseInt(_0x157dae(0x1e0))/0x5*(parseInt(_0x157dae(0x1be))/0x6)+-parseInt(_0x157dae(0x1c5))/0x7+-parseInt(_0x157dae(0x1a3))/0x8*(-parseInt(_0x157dae(0x178))/0x9)+-parseInt(_0x157dae(0x190))/0xa;if(_0x21c9b6===_0x55a090)break;else _0xfd051a['push'](_0xfd051a['shift']());}catch(_0x5eacfb){_0xfd051a['push'](_0xfd051a['shift']());}}}(a54_0x4c7a,0xcf24e));var __importDefault=this&&this['__importDefault']||function(_0x2c1755){const _0x36d5f6=a54_0x56b4;return _0x2c1755&&_0x2c1755[_0x36d5f6(0x1ef)]?_0x2c1755:{'default':_0x2c1755};};Object[a54_0x2b5ea8(0x1d3)](exports,a54_0x2b5ea8(0x1ef),{'value':!![]}),exports[a54_0x2b5ea8(0x192)]=void 0x0;const database_1=__importDefault(require(a54_0x2b5ea8(0x196))),currencyService_1=require('./currencyService'),paymentService_1=require(a54_0x2b5ea8(0x1e6));class ShopService{constructor(){const _0x1d891=a54_0x2b5ea8;this[_0x1d891(0x1bc)]=new paymentService_1['PaymentService']();}async[a54_0x2b5ea8(0x168)](_0xb22d67){const _0x466d6c=a54_0x2b5ea8,_0x57d161=await database_1[_0x466d6c(0x164)]['shop'][_0x466d6c(0x1b9)]({'where':{'id':_0xb22d67},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x57d161)throw new Error(_0x466d6c(0x1d7));let _0xc5335c=[];if(_0x57d161['settings']?.[_0x466d6c(0x18b)])try{_0xc5335c=Array['isArray'](_0x57d161[_0x466d6c(0x1d9)]['webhookEvents'])?_0x57d161[_0x466d6c(0x1d9)][_0x466d6c(0x18b)]:JSON[_0x466d6c(0x1d5)](_0x57d161[_0x466d6c(0x1d9)][_0x466d6c(0x18b)]);}catch(_0xae5da6){console[_0x466d6c(0x19d)](_0x466d6c(0x1fb),_0xae5da6),_0xc5335c=[];}return{'id':_0x57d161['id'],'fullName':_0x57d161[_0x466d6c(0x1a7)],'username':_0x57d161[_0x466d6c(0x186)],'telegramId':_0x57d161[_0x466d6c(0x1ba)],'merchantUrl':_0x57d161[_0x466d6c(0x15c)],'gateways':_0x57d161[_0x466d6c(0x187)]?JSON[_0x466d6c(0x1d5)](_0x57d161[_0x466d6c(0x187)]):null,'gatewaySettings':_0x57d161[_0x466d6c(0x1da)]?JSON[_0x466d6c(0x1d5)](_0x57d161[_0x466d6c(0x1da)]):null,'publicKey':_0x57d161[_0x466d6c(0x19b)],'webhookUrl':_0x57d161[_0x466d6c(0x1d9)]?.[_0x466d6c(0x18d)]||null,'webhookEvents':_0xc5335c,'wallets':{'usdtPolygonWallet':_0x57d161['usdtPolygonWallet'],'usdtTrcWallet':_0x57d161[_0x466d6c(0x201)],'usdtErcWallet':_0x57d161[_0x466d6c(0x188)],'usdcPolygonWallet':_0x57d161[_0x466d6c(0x1f2)]},'status':_0x57d161[_0x466d6c(0x194)],'createdAt':_0x57d161[_0x466d6c(0x1a9)]};}async[a54_0x2b5ea8(0x1e7)](_0x45fb0e,_0x50d7d6){const _0x1cefa7=a54_0x2b5ea8,_0x41b95e={};_0x50d7d6['fullName']&&(_0x41b95e[_0x1cefa7(0x1a7)]=_0x50d7d6[_0x1cefa7(0x1dc)]);_0x50d7d6[_0x1cefa7(0x1e1)]!==undefined&&(_0x41b95e['telegram']=_0x50d7d6[_0x1cefa7(0x1e1)]||null);_0x50d7d6[_0x1cefa7(0x1c2)]&&(_0x41b95e[_0x1cefa7(0x15c)]=_0x50d7d6['merchantUrl']);_0x50d7d6[_0x1cefa7(0x16e)]&&(_0x41b95e[_0x1cefa7(0x187)]=JSON[_0x1cefa7(0x182)](_0x50d7d6[_0x1cefa7(0x16e)]));_0x50d7d6['gatewaySettings']&&(_0x41b95e[_0x1cefa7(0x1da)]=JSON[_0x1cefa7(0x182)](_0x50d7d6[_0x1cefa7(0x1da)]));_0x50d7d6[_0x1cefa7(0x1f1)]&&(_0x50d7d6[_0x1cefa7(0x1f1)][_0x1cefa7(0x1cc)]!==undefined&&(_0x41b95e[_0x1cefa7(0x1cc)]=_0x50d7d6['wallets']['usdtPolygonWallet']||null),_0x50d7d6[_0x1cefa7(0x1f1)][_0x1cefa7(0x201)]!==undefined&&(_0x41b95e['usdtTrcWallet']=_0x50d7d6[_0x1cefa7(0x1f1)]['usdtTrcWallet']||null),_0x50d7d6[_0x1cefa7(0x1f1)][_0x1cefa7(0x188)]!==undefined&&(_0x41b95e[_0x1cefa7(0x188)]=_0x50d7d6['wallets'][_0x1cefa7(0x188)]||null),_0x50d7d6['wallets'][_0x1cefa7(0x1f2)]!==undefined&&(_0x41b95e[_0x1cefa7(0x1f2)]=_0x50d7d6[_0x1cefa7(0x1f1)][_0x1cefa7(0x1f2)]||null));const _0x5dc619=await database_1[_0x1cefa7(0x164)][_0x1cefa7(0x1f3)][_0x1cefa7(0x1fd)]({'where':{'id':_0x45fb0e},'data':_0x41b95e,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x3be290=[];if(_0x5dc619[_0x1cefa7(0x1d9)]?.[_0x1cefa7(0x18b)])try{_0x3be290=Array[_0x1cefa7(0x1eb)](_0x5dc619[_0x1cefa7(0x1d9)][_0x1cefa7(0x18b)])?_0x5dc619[_0x1cefa7(0x1d9)][_0x1cefa7(0x18b)]:JSON[_0x1cefa7(0x1d5)](_0x5dc619[_0x1cefa7(0x1d9)][_0x1cefa7(0x18b)]);}catch(_0x376186){console[_0x1cefa7(0x19d)]('Error\x20parsing\x20webhook\x20events:',_0x376186),_0x3be290=[];}return{'id':_0x5dc619['id'],'fullName':_0x5dc619[_0x1cefa7(0x1a7)],'username':_0x5dc619[_0x1cefa7(0x186)],'telegramId':_0x5dc619[_0x1cefa7(0x1ba)],'merchantUrl':_0x5dc619['shopUrl'],'gateways':_0x5dc619[_0x1cefa7(0x187)]?JSON[_0x1cefa7(0x1d5)](_0x5dc619[_0x1cefa7(0x187)]):null,'gatewaySettings':_0x5dc619[_0x1cefa7(0x1da)]?JSON[_0x1cefa7(0x1d5)](_0x5dc619[_0x1cefa7(0x1da)]):null,'publicKey':_0x5dc619['publicKey'],'webhookUrl':_0x5dc619[_0x1cefa7(0x1d9)]?.[_0x1cefa7(0x18d)]||null,'webhookEvents':_0x3be290,'wallets':{'usdtPolygonWallet':_0x5dc619[_0x1cefa7(0x1cc)],'usdtTrcWallet':_0x5dc619[_0x1cefa7(0x201)],'usdtErcWallet':_0x5dc619[_0x1cefa7(0x188)],'usdcPolygonWallet':_0x5dc619['usdcPolygonWallet']},'status':_0x5dc619[_0x1cefa7(0x194)],'createdAt':_0x5dc619[_0x1cefa7(0x1a9)]};}async[a54_0x2b5ea8(0x161)](_0x1256e,_0x5e5115){const _0x114caf=a54_0x2b5ea8,_0x2d212f={};_0x5e5115[_0x114caf(0x1cc)]!==undefined&&(_0x2d212f[_0x114caf(0x1cc)]=_0x5e5115[_0x114caf(0x1cc)]||null),_0x5e5115[_0x114caf(0x201)]!==undefined&&(_0x2d212f['usdtTrcWallet']=_0x5e5115[_0x114caf(0x201)]||null),_0x5e5115[_0x114caf(0x188)]!==undefined&&(_0x2d212f[_0x114caf(0x188)]=_0x5e5115[_0x114caf(0x188)]||null),_0x5e5115[_0x114caf(0x1f2)]!==undefined&&(_0x2d212f[_0x114caf(0x1f2)]=_0x5e5115['usdcPolygonWallet']||null),await database_1['default']['shop']['update']({'where':{'id':_0x1256e},'data':_0x2d212f});}async[a54_0x2b5ea8(0x1c9)](_0x6900eb){const _0x202a30=a54_0x2b5ea8,_0xa56187=await database_1[_0x202a30(0x164)][_0x202a30(0x1f3)][_0x202a30(0x1b9)]({'where':{'id':_0x6900eb},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0xa56187?.['settings']?.[_0x202a30(0x18d)])throw new Error(_0x202a30(0x19f));const _0x4fee67={'event':_0x202a30(0x1ab),'payment':{'id':_0x202a30(0x1f4),'order_id':_0x202a30(0x1ee),'gateway':_0x202a30(0x1ab),'amount':0x64,'currency':_0x202a30(0x1b0),'status':_0x202a30(0x173),'created_at':new Date()[_0x202a30(0x1d8)]()}};try{const _0x194afc=await fetch(_0xa56187[_0x202a30(0x1d9)][_0x202a30(0x18d)],{'method':_0x202a30(0x1a1),'headers':{'Content-Type':_0x202a30(0x1c6),'User-Agent':_0x202a30(0x16a)},'body':JSON[_0x202a30(0x182)](_0x4fee67)});return _0x194afc['ok']?{'success':!![],'message':_0x202a30(0x170)+_0x194afc['status']+')'}:{'success':![],'message':_0x202a30(0x1f9)+_0x194afc[_0x202a30(0x194)]+'\x20'+_0x194afc['statusText']};}catch(_0x3c2d20){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x3c2d20 instanceof Error?_0x3c2d20[_0x202a30(0x189)]:_0x202a30(0x1b7))};}}async['createPayment'](_0x14d856){const _0x5f3dfa=a54_0x2b5ea8;return this['paymentService'][_0x5f3dfa(0x19c)]({'public_key':'','gateway':_0x14d856[_0x5f3dfa(0x15a)],'order_id':undefined,'amount':_0x14d856['amount'],'currency':_0x14d856[_0x5f3dfa(0x1b5)],'source_currency':_0x14d856[_0x5f3dfa(0x1f5)],'usage':_0x14d856[_0x5f3dfa(0x1dd)],'expires_at':_0x14d856[_0x5f3dfa(0x1fe)]?.['toISOString'](),'success_url':_0x14d856[_0x5f3dfa(0x202)],'fail_url':_0x14d856['redirectUrl'],'customer_email':_0x14d856[_0x5f3dfa(0x18e)],'customer_name':_0x14d856['customerName'],'country':_0x14d856['country'],'language':_0x14d856['language'],'amount_is_editable':_0x14d856[_0x5f3dfa(0x1bb)],'max_payments':_0x14d856[_0x5f3dfa(0x162)],'customer':_0x14d856[_0x5f3dfa(0x1df)]});}async[a54_0x2b5ea8(0x1b6)](_0x30fdae,_0x125d9a){const _0x2aebdd=a54_0x2b5ea8;return this[_0x2aebdd(0x1bc)][_0x2aebdd(0x16c)](_0x30fdae,_0x125d9a);}async[a54_0x2b5ea8(0x1e4)](_0x22cd9d,_0x42c1ea){const _0x1deb3c=a54_0x2b5ea8;return this[_0x1deb3c(0x1bc)][_0x1deb3c(0x193)](_0x22cd9d,_0x42c1ea);}async[a54_0x2b5ea8(0x16d)](_0x17e2f4,_0x3a1eec,_0x55c6e8){const _0x563404=a54_0x2b5ea8,_0x1f2b3e=await database_1['default'][_0x563404(0x165)][_0x563404(0x1b3)]({'where':{'id':_0x3a1eec,'shopId':_0x17e2f4}});if(!_0x1f2b3e)throw new Error('Payment\x20not\x20found');const _0x3f006c=await database_1[_0x563404(0x164)][_0x563404(0x165)]['update']({'where':{'id':_0x3a1eec},'data':{..._0x55c6e8,'updatedAt':new Date()}});return _0x3f006c;}async['deletePayment'](_0x189a84,_0x3c4a5b){const _0x46d336=a54_0x2b5ea8,_0x4020c3=await database_1[_0x46d336(0x164)]['payment'][_0x46d336(0x1b3)]({'where':{'id':_0x3c4a5b,'shopId':_0x189a84}});if(!_0x4020c3)throw new Error(_0x46d336(0x1bf));await database_1[_0x46d336(0x164)]['payment'][_0x46d336(0x1fa)]({'where':{'id':_0x3c4a5b}});}[a54_0x2b5ea8(0x180)](_0x51c2cd){const _0x4a3dc3=a54_0x2b5ea8,_0x584a2b={'polygon':_0x4a3dc3(0x176),'trc20':_0x4a3dc3(0x16f),'erc20':_0x4a3dc3(0x1d2),'bsc':_0x4a3dc3(0x1ac),'polygon_usdc':'USDC\x20Polygon'};return _0x584a2b[_0x51c2cd]||_0x51c2cd;}async[a54_0x2b5ea8(0x1bd)](_0x7cd03c,_0x47811e){const _0x2a50bc=a54_0x2b5ea8,{page:_0x59a8b8,limit:_0x449cf5,status:_0x3469bd,method:_0xd79f2,network:_0x2626f8,dateFrom:_0x25ae61,dateTo:_0x3e964c,periodFrom:_0xd274df,periodTo:_0x292d78}=_0x47811e,_0x511aa6=(_0x59a8b8-0x1)*_0x449cf5;console[_0x2a50bc(0x1cd)](_0x2a50bc(0x1ca),_0x47811e);const _0x30fbb6={'shopId':_0x7cd03c};_0x3469bd&&(_0x30fbb6[_0x2a50bc(0x194)]=_0x3469bd[_0x2a50bc(0x195)](),console[_0x2a50bc(0x1cd)](_0x2a50bc(0x174)+_0x3469bd[_0x2a50bc(0x195)]()));if(_0xd79f2)_0x30fbb6[_0x2a50bc(0x1cf)]=_0xd79f2,console['log'](_0x2a50bc(0x181)+_0xd79f2);else _0x2626f8&&(_0x30fbb6[_0x2a50bc(0x1cf)]=_0x2626f8,console[_0x2a50bc(0x1cd)](_0x2a50bc(0x1cb)+_0x2626f8));if(_0x25ae61||_0x3e964c||_0xd274df||_0x292d78){_0x30fbb6[_0x2a50bc(0x1a9)]={};if(_0xd274df){const _0x224138=new Date(_0xd274df);_0x224138[_0x2a50bc(0x1d4)](0x0,0x0,0x0,0x0),_0x30fbb6[_0x2a50bc(0x1a9)][_0x2a50bc(0x198)]=_0x224138,console[_0x2a50bc(0x1cd)](_0x2a50bc(0x17a)+_0x224138[_0x2a50bc(0x1d8)]());}else{if(_0x25ae61){const _0x227e93=new Date(_0x25ae61);_0x227e93['setHours'](0x0,0x0,0x0,0x0),_0x30fbb6[_0x2a50bc(0x1a9)]['gte']=_0x227e93,console[_0x2a50bc(0x1cd)](_0x2a50bc(0x1f7)+_0x227e93[_0x2a50bc(0x1d8)]());}}if(_0x292d78){const _0x213546=new Date(_0x292d78);_0x213546['setHours'](0x17,0x3b,0x3b,0x3e7),_0x30fbb6[_0x2a50bc(0x1a9)]['lte']=_0x213546,console[_0x2a50bc(0x1cd)](_0x2a50bc(0x185)+_0x213546[_0x2a50bc(0x1d8)]());}else{if(_0x3e964c){const _0x33454a=new Date(_0x3e964c);_0x33454a[_0x2a50bc(0x1d4)](0x17,0x3b,0x3b,0x3e7),_0x30fbb6[_0x2a50bc(0x1a9)]['lte']=_0x33454a,console[_0x2a50bc(0x1cd)](_0x2a50bc(0x1ae)+_0x33454a[_0x2a50bc(0x1d8)]());}}}console[_0x2a50bc(0x1cd)](_0x2a50bc(0x18f),JSON['stringify'](_0x30fbb6,null,0x2));const [_0x8627c,_0x5af10f]=await Promise['all']([database_1['default'][_0x2a50bc(0x1ec)]['findMany']({'where':_0x30fbb6,'skip':_0x511aa6,'take':_0x449cf5,'orderBy':{'createdAt':_0x2a50bc(0x197)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default']['payout']['count']({'where':_0x30fbb6})]);return{'payouts':_0x8627c[_0x2a50bc(0x179)](_0x26109b=>{const _0x28fc6c=_0x2a50bc;let _0x410169=null;switch(_0x26109b['network']){case _0x28fc6c(0x1e5):_0x410169=_0x26109b[_0x28fc6c(0x1f3)]['usdtPolygonWallet'];break;case _0x28fc6c(0x17e):_0x410169=_0x26109b[_0x28fc6c(0x1f3)][_0x28fc6c(0x201)];break;case _0x28fc6c(0x17f):_0x410169=_0x26109b[_0x28fc6c(0x1f3)][_0x28fc6c(0x188)];break;case _0x28fc6c(0x18c):_0x410169=_0x26109b[_0x28fc6c(0x1f3)][_0x28fc6c(0x1f2)];break;}return{'id':_0x26109b['id'],'amount':_0x26109b[_0x28fc6c(0x1c7)],'network':this[_0x28fc6c(0x180)](_0x26109b[_0x28fc6c(0x1cf)]),'wallet':_0x410169,'status':_0x26109b[_0x28fc6c(0x194)],'txid':_0x26109b[_0x28fc6c(0x17c)],'notes':_0x26109b['notes'],'periodFrom':_0x26109b[_0x28fc6c(0x1ed)],'periodTo':_0x26109b[_0x28fc6c(0x207)],'createdAt':_0x26109b['createdAt'],'paidAt':_0x26109b[_0x28fc6c(0x175)]};}),'pagination':{'page':_0x59a8b8,'limit':_0x449cf5,'total':_0x5af10f,'totalPages':Math[_0x2a50bc(0x1c8)](_0x5af10f/_0x449cf5)}};}async[a54_0x2b5ea8(0x204)](_0x383fa8,_0xc3582c){const _0x3bd57d=a54_0x2b5ea8,_0x2392ab=await database_1[_0x3bd57d(0x164)][_0x3bd57d(0x1ec)][_0x3bd57d(0x1b3)]({'where':{'id':_0xc3582c,'shopId':_0x383fa8}});if(!_0x2392ab)return null;return{'id':_0x2392ab['id'],'amount':_0x2392ab[_0x3bd57d(0x1c7)],'network':_0x2392ab[_0x3bd57d(0x1cf)],'status':_0x2392ab[_0x3bd57d(0x194)],'txid':_0x2392ab[_0x3bd57d(0x17c)],'notes':_0x2392ab[_0x3bd57d(0x169)],'createdAt':_0x2392ab['createdAt'],'paidAt':_0x2392ab['paidAt']};}async['getPayoutStatistics'](_0x421309,_0x44cd4f){const _0x977efd=a54_0x2b5ea8,_0x12debf=new Date();let _0x145a12;switch(_0x44cd4f){case'7d':_0x145a12=new Date(_0x12debf[_0x977efd(0x16b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x977efd(0x172):_0x145a12=new Date(_0x12debf['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x145a12=new Date(_0x12debf['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x145a12=new Date(_0x12debf[_0x977efd(0x16b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x44e7db,_0x2d414f,_0x4e2bd1,_0x133809,_0xdb5fc3,_0x1d5194]=await Promise[_0x977efd(0x1f6)]([database_1['default'][_0x977efd(0x1ec)][_0x977efd(0x1e9)]({'where':{'shopId':_0x421309,'createdAt':{'gte':_0x145a12}}}),database_1[_0x977efd(0x164)][_0x977efd(0x1ec)]['count']({'where':{'shopId':_0x421309,'status':'COMPLETED','createdAt':{'gte':_0x145a12}}}),database_1[_0x977efd(0x164)][_0x977efd(0x1ec)][_0x977efd(0x1e9)]({'where':{'shopId':_0x421309,'status':_0x977efd(0x200),'createdAt':{'gte':_0x145a12}}}),database_1[_0x977efd(0x164)][_0x977efd(0x1ec)][_0x977efd(0x1e9)]({'where':{'shopId':_0x421309,'status':_0x977efd(0x1a8),'createdAt':{'gte':_0x145a12}}}),database_1[_0x977efd(0x164)][_0x977efd(0x1ec)]['findMany']({'where':{'shopId':_0x421309,'createdAt':{'gte':_0x145a12}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x977efd(0x164)]['payout'][_0x977efd(0x1a4)]({'where':{'shopId':_0x421309},'take':0xa,'orderBy':{'createdAt':_0x977efd(0x197)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x4e4df7=_0xdb5fc3['reduce']((_0x16aa3c,_0x2d4e74)=>_0x16aa3c+_0x2d4e74['amount'],0x0),_0x2054e9=_0xdb5fc3[_0x977efd(0x166)](_0x4ae5b6=>_0x4ae5b6[_0x977efd(0x194)]==='COMPLETED')['reduce']((_0x5367e0,_0x8bb3cc)=>_0x5367e0+_0x8bb3cc['amount'],0x0),_0x1cc4ea=_0xdb5fc3[_0x977efd(0x166)](_0x34a300=>_0x34a300[_0x977efd(0x194)]===_0x977efd(0x200))[_0x977efd(0x1e2)]((_0x1a5930,_0x1d7f07)=>_0x1a5930+_0x1d7f07['amount'],0x0),_0x5c0aaf=_0xdb5fc3[_0x977efd(0x1e2)]((_0x371801,_0x5f02b5)=>{return _0x371801[_0x5f02b5['network']]=(_0x371801[_0x5f02b5['network']]||0x0)+0x1,_0x371801;},{}),_0x6abab9=_0xdb5fc3[_0x977efd(0x1e2)]((_0x3d9848,_0x300570)=>{const _0x318c34=_0x977efd;return _0x3d9848[_0x300570[_0x318c34(0x194)]]=(_0x3d9848[_0x300570['status']]||0x0)+0x1,_0x3d9848;},{});return{'totalPayouts':_0x44e7db,'completedPayouts':_0x2d414f,'pendingPayouts':_0x4e2bd1,'rejectedPayouts':_0x133809,'totalAmount':_0x4e4df7,'completedAmount':_0x2054e9,'pendingAmount':_0x1cc4ea,'payoutsByMethod':_0x5c0aaf,'payoutsByStatus':_0x6abab9,'recentPayouts':_0x1d5194[_0x977efd(0x179)](_0x406a54=>({'id':_0x406a54['id'],'shopId':_0x421309,'amount':_0x406a54['amount'],'method':_0x406a54['network'],'status':_0x406a54[_0x977efd(0x194)],'txid':_0x406a54[_0x977efd(0x17c)],'createdAt':_0x406a54[_0x977efd(0x1a9)],'paidAt':_0x406a54[_0x977efd(0x175)]}))};}async[a54_0x2b5ea8(0x15f)](_0x567078){const _0x671f6d=a54_0x2b5ea8;console['log']('📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x567078+_0x671f6d(0x1c3));const _0x1d4681=await database_1[_0x671f6d(0x164)][_0x671f6d(0x1f3)][_0x671f6d(0x1b9)]({'where':{'id':_0x567078},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1d4681)throw new Error(_0x671f6d(0x1d7));const _0x391461=new Date(),_0x6dc633=new Date(_0x391461[_0x671f6d(0x191)](),_0x391461[_0x671f6d(0x1b8)](),0x1),_0x252a11=new Date(_0x391461['getFullYear'](),_0x391461[_0x671f6d(0x1b8)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x21cb3c=await database_1[_0x671f6d(0x164)][_0x671f6d(0x1ec)][_0x671f6d(0x1de)]({'_sum':{'amount':!![]},'where':{'shopId':_0x567078,'createdAt':{'gte':_0x6dc633,'lte':_0x252a11},'status':'COMPLETED'}}),_0x5b93bb=_0x21cb3c['_sum'][_0x671f6d(0x1c7)]||0x0,_0x3d837a={'availableBalance':Math[_0x671f6d(0x206)](_0x1d4681['balance']*0x64)/0x64,'totalPaidOut':Math[_0x671f6d(0x206)](_0x1d4681['totalPaidOut']*0x64)/0x64,'awaitingPayout':Math['round'](_0x1d4681['balance']*0x64)/0x64,'thisMonth':Math[_0x671f6d(0x206)](_0x5b93bb*0x64)/0x64};return console[_0x671f6d(0x1cd)](_0x671f6d(0x1a6)+_0x1d4681[_0x671f6d(0x186)]+_0x671f6d(0x1e8)),console[_0x671f6d(0x1cd)](_0x671f6d(0x1c0)+_0x3d837a[_0x671f6d(0x1d6)]+_0x671f6d(0x1b1)),console[_0x671f6d(0x1cd)]('\x20\x20\x20💰\x20Total\x20paid\x20out:\x20'+_0x3d837a[_0x671f6d(0x17d)]+_0x671f6d(0x177)),console['log'](_0x671f6d(0x18a)+_0x3d837a[_0x671f6d(0x1f0)]+_0x671f6d(0x1b1)),console[_0x671f6d(0x1cd)](_0x671f6d(0x163)+_0x3d837a[_0x671f6d(0x15e)]+_0x671f6d(0x171)),_0x3d837a;}[a54_0x2b5ea8(0x1aa)](_0x3ac5ec){const _0x780ec9=a54_0x2b5ea8,_0x4078f1={'test_gateway':'Test\x20Gateway','plisio':_0x780ec9(0x183),'rapyd':_0x780ec9(0x1c1),'noda':_0x780ec9(0x15d),'cointopay':'CoinToPay','klyme_eu':_0x780ec9(0x1af),'klyme_gb':_0x780ec9(0x1a0),'klyme_de':_0x780ec9(0x1a2)};return _0x4078f1[_0x3ac5ec]||_0x3ac5ec;}async[a54_0x2b5ea8(0x1a5)](_0x4a4ff8){const _0x341f68=a54_0x2b5ea8;return this[_0x341f68(0x15f)](_0x4a4ff8);}async[a54_0x2b5ea8(0x1d1)](_0x23e591,_0x1ae392){const _0x450304=a54_0x2b5ea8,{page:_0x50e6f4,limit:_0x5c2c78,paymentId:_0x590e09}=_0x1ae392,_0xd6e17a=(_0x50e6f4-0x1)*_0x5c2c78,_0x256ee6={'shopId':_0x23e591};_0x590e09&&(_0x256ee6[_0x450304(0x1fc)]=_0x590e09);const [_0x2bbb17,_0x398be4]=await Promise[_0x450304(0x1f6)]([database_1[_0x450304(0x164)][_0x450304(0x17b)][_0x450304(0x1a4)]({'where':_0x256ee6,'skip':_0xd6e17a,'take':_0x5c2c78,'orderBy':{'createdAt':_0x450304(0x197)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x450304(0x164)]['webhookLog'][_0x450304(0x1e9)]({'where':_0x256ee6})]);return{'logs':_0x2bbb17[_0x450304(0x179)](_0x96f0e2=>({'id':_0x96f0e2['id'],'paymentId':_0x96f0e2[_0x450304(0x1fc)],'shopId':_0x96f0e2[_0x450304(0x1e3)],'event':_0x96f0e2[_0x450304(0x184)],'statusCode':_0x96f0e2[_0x450304(0x167)],'retryCount':_0x96f0e2[_0x450304(0x1c4)],'responseBody':_0x96f0e2['responseBody'],'createdAt':_0x96f0e2[_0x450304(0x1a9)],'payment':_0x96f0e2['payment']})),'pagination':{'page':_0x50e6f4,'limit':_0x5c2c78,'total':_0x398be4,'totalPages':Math['ceil'](_0x398be4/_0x5c2c78)}};}async[a54_0x2b5ea8(0x1d0)](_0x4c070d,_0xff5c50){const _0x3f28a7=a54_0x2b5ea8,_0x5c4513=new Date();let _0x4a2bc2;switch(_0xff5c50){case'7d':_0x4a2bc2=new Date(_0x5c4513[_0x3f28a7(0x16b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x3f28a7(0x172):_0x4a2bc2=new Date(_0x5c4513[_0x3f28a7(0x16b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3f28a7(0x1b4):_0x4a2bc2=new Date(_0x5c4513[_0x3f28a7(0x16b)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x4a2bc2=new Date(_0x5c4513['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x50ef02,_0x16123f,_0x53f2c1,_0xc7f539,_0x455a6b]=await Promise[_0x3f28a7(0x1f6)]([database_1[_0x3f28a7(0x164)][_0x3f28a7(0x165)]['count']({'where':{'shopId':_0x4c070d,'gateway':{'not':_0x3f28a7(0x1b2)},'createdAt':{'gte':_0x4a2bc2}}}),database_1[_0x3f28a7(0x164)]['payment']['count']({'where':{'shopId':_0x4c070d,'gateway':{'not':'test_gateway'},'status':_0x3f28a7(0x19e),'createdAt':{'gte':_0x4a2bc2}}}),database_1[_0x3f28a7(0x164)][_0x3f28a7(0x165)]['findMany']({'where':{'shopId':_0x4c070d,'gateway':{'not':_0x3f28a7(0x1b2)},'status':_0x3f28a7(0x19e),'createdAt':{'gte':_0x4a2bc2}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3f28a7(0x164)]['payment'][_0x3f28a7(0x1a4)]({'where':{'shopId':_0x4c070d,'gateway':{'not':_0x3f28a7(0x1b2)}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x3f28a7(0x165)][_0x3f28a7(0x1a4)]({'where':{'shopId':_0x4c070d,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x4a2bc2}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3f28a7(0x1f8)}})]);let _0x2e6729=0x0;for(const _0x570e9e of _0x53f2c1){if(_0x570e9e[_0x3f28a7(0x205)])_0x2e6729+=_0x570e9e['amountUSDT'];else{const _0x1aa7c1=await currencyService_1['currencyService'][_0x3f28a7(0x19a)](_0x570e9e[_0x3f28a7(0x1c7)],_0x570e9e[_0x3f28a7(0x1b5)]);_0x2e6729+=_0x1aa7c1;}}const _0x45c4d9=this['generateDailyStatistics'](_0x455a6b,_0x4a2bc2,_0x5c4513),_0x1f760a=_0x50ef02>0x0?_0x16123f/_0x50ef02*0x64:0x0;return{'totalPayments':_0x50ef02,'successfulPayments':_0x16123f,'totalRevenue':Math['round'](_0x2e6729*0x64)/0x64,'conversionRate':Math[_0x3f28a7(0x206)](_0x1f760a*0x64)/0x64,'dailyRevenue':_0x45c4d9[_0x3f28a7(0x160)],'dailyPayments':_0x45c4d9[_0x3f28a7(0x1db)],'recentPayments':_0xc7f539['map'](_0x1a2cee=>({'id':_0x1a2cee['id'],'gateway':_0x1a2cee[_0x3f28a7(0x15a)],'amount':_0x1a2cee[_0x3f28a7(0x1c7)],'currency':_0x1a2cee[_0x3f28a7(0x1b5)],'status':_0x1a2cee['status'],'createdAt':_0x1a2cee['createdAt']}))};}['generateDailyStatistics'](_0x148349,_0x4e97a8,_0x2abfe6){const _0x29e9e6=a54_0x2b5ea8,_0x5a4e7d=new Map(),_0x3bb0a2=new Date(_0x4e97a8);while(_0x3bb0a2<=_0x2abfe6){const _0x4f9056=_0x3bb0a2[_0x29e9e6(0x1d8)]()[_0x29e9e6(0x199)]('T')[0x0];_0x5a4e7d['set'](_0x4f9056,{'revenue':0x0,'count':0x0}),_0x3bb0a2['setDate'](_0x3bb0a2[_0x29e9e6(0x1ea)]()+0x1);}for(const _0x1a1392 of _0x148349){const _0x8742f8=_0x1a1392['createdAt'][_0x29e9e6(0x1d8)]()[_0x29e9e6(0x199)]('T')[0x0],_0x1e1efa=_0x5a4e7d['get'](_0x8742f8);_0x1e1efa&&(_0x1e1efa[_0x29e9e6(0x1e9)]+=0x1,_0x1a1392['status']===_0x29e9e6(0x19e)&&_0x1a1392[_0x29e9e6(0x205)]&&(_0x1e1efa[_0x29e9e6(0x15b)]+=_0x1a1392[_0x29e9e6(0x205)]));}const _0x459a45=[],_0x59511a=[];for(const [_0x1b70a2,_0x1cc5d9]of _0x5a4e7d){_0x459a45[_0x29e9e6(0x1ad)]({'date':_0x1b70a2,'amount':Math[_0x29e9e6(0x206)](_0x1cc5d9[_0x29e9e6(0x15b)]*0x64)/0x64}),_0x59511a[_0x29e9e6(0x1ad)]({'date':_0x1b70a2,'count':_0x1cc5d9[_0x29e9e6(0x1e9)]});}return{'dailyRevenue':_0x459a45,'dailyPayments':_0x59511a};}}function a54_0x4c7a(){const _0x4ddf63=['paymentId','update','expiresAt','990100PWcoxK','PENDING','usdtTrcWallet','redirectUrl','5184mYGGni','getPayoutById','amountUSDT','round','periodTo','1926xINfPE','gateway','revenue','shopUrl','Noda','thisMonth','getShopPayoutStats','dailyRevenue','updateWallets','maxPayments','\x20\x20\x20📅\x20This\x20month:\x20','default','payment','filter','statusCode','getShopProfile','notes','TesSoft\x20Payment\x20System/1.0\x20(Test)','getTime','getPaymentsByShop','updatePayment','gateways','USDT\x20TRC20','Test\x20webhook\x20sent\x20successfully\x20(','\x20USDT','30d','paid','📊\x20Status\x20filter:\x20','paidAt','USDT\x20Polygon','\x20USDT\x20(total\x20payouts)','1258209MXpClC','map','📅\x20Period\x20start:\x20','webhookLog','txid','totalPaidOut','trc20','erc20','formatNetworkName','🌐\x20Method\x20filter:\x20','stringify','Plisio','event','📅\x20Period\x20end:\x20','username','paymentGateways','usdtErcWallet','message','\x20\x20\x20⏳\x20Awaiting\x20payout:\x20','webhookEvents','polygon_usdc','webhookUrl','customerEmail','📊\x20Final\x20WHERE\x20conditions:','23177980uIbWot','getFullYear','ShopService','getPaymentByShopAndId','status','toUpperCase','../config/database','desc','gte','split','convertToUSDT','publicKey','createPublicPayment','error','PAID','No\x20webhook\x20URL\x20configured','KLYME\x20GB','POST','KLYME\x20DE','96BTUsNs','findMany','getPayoutStats','📊\x20Shop\x20','name','REJECTED','createdAt','getGatewayDisplayName','test','USDT\x20BSC','push','📅\x20Date\x20end:\x20','KLYME\x20EU','USD','\x20USDT\x20(current\x20balance)','test_gateway','findFirst','90d','currency','getPayments','Unknown\x20error','getMonth','findUnique','telegram','amountIsEditable','paymentService','getPayouts','6DrHjMT','Payment\x20not\x20found','\x20\x20\x20💵\x20Available\x20balance:\x20','Rapyd','merchantUrl','...','retryCount','257152zeVYlN','application/json','amount','ceil','testWebhook','💰\x20Getting\x20payouts\x20with\x20filters:','🌐\x20Network\x20filter:\x20','usdtPolygonWallet','log','1679875RacNcn','network','getStatistics','getWebhookLogs','USDT\x20ERC20','defineProperty','setHours','parse','availableBalance','Shop\x20not\x20found','toISOString','settings','gatewaySettings','dailyPayments','fullName','usage','aggregate','customer','6468350JIisah','telegramId','reduce','shopId','getPaymentById','polygon','./paymentService','updateShopProfile','\x20payout\x20statistics\x20calculated:','count','getDate','isArray','payout','periodFrom','test_order_123','__esModule','awaitingPayout','wallets','usdcPolygonWallet','shop','test_payment_123','sourceCurrency','all','📅\x20Date\x20start:\x20','asc','Webhook\x20returned\x20error:\x20','delete','Error\x20parsing\x20webhook\x20events:'];a54_0x4c7a=function(){return _0x4ddf63;};return a54_0x4c7a();}exports[a54_0x2b5ea8(0x192)]=ShopService;