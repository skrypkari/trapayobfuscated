'use strict';const a61_0x25e66a=a61_0x5b21;(function(_0x26eeea,_0x55efed){const _0x534c8c=a61_0x5b21,_0x5e2e3c=_0x26eeea();while(!![]){try{const _0x3d45df=parseInt(_0x534c8c(0x1ad))/0x1+parseInt(_0x534c8c(0x1ab))/0x2*(parseInt(_0x534c8c(0x18d))/0x3)+-parseInt(_0x534c8c(0x1a5))/0x4*(-parseInt(_0x534c8c(0x182))/0x5)+-parseInt(_0x534c8c(0x145))/0x6+parseInt(_0x534c8c(0x186))/0x7*(parseInt(_0x534c8c(0x169))/0x8)+-parseInt(_0x534c8c(0x18f))/0x9+-parseInt(_0x534c8c(0x12f))/0xa;if(_0x3d45df===_0x55efed)break;else _0x5e2e3c['push'](_0x5e2e3c['shift']());}catch(_0x4d0ff0){_0x5e2e3c['push'](_0x5e2e3c['shift']());}}}(a61_0x8097,0x73add));var __importDefault=this&&this[a61_0x25e66a(0x1c6)]||function(_0x1cb801){const _0x1776ce=a61_0x25e66a;return _0x1cb801&&_0x1cb801[_0x1776ce(0x16b)]?_0x1cb801:{'default':_0x1cb801};};Object[a61_0x25e66a(0x156)](exports,a61_0x25e66a(0x16b),{'value':!![]}),exports[a61_0x25e66a(0x16d)]=void 0x0;const database_1=__importDefault(require(a61_0x25e66a(0x132))),currencyService_1=require('./currencyService'),paymentService_1=require(a61_0x25e66a(0x17a));function a61_0x8097(){const _0x52be7d=['paymentId','network','Noda','paymentGateways','COMPLETED','split','getDate','setHours','gateway','90d','getPayments','expiresAt','day','\x20\x20\x20üìÖ\x20This\x20month:\x20','sourceCurrency','delete','test_payment_123','aggregate','__importDefault','usdtPolygonWallet','amountUSDT','all','paidAt','availableBalance','findUnique','username','KLYME\x20GB','getPayoutById','paid','round','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','Shop\x20not\x20found','default','txid','No\x20webhook\x20URL\x20configured','polygon_usdc','awaitingPayout','toUpperCase','REJECTED','country','name','thisMonth','parse','getStatistics','4274030rYgpAz','getMonth','findFirst','../config/database','CoinToPay','Test\x20Gateway','webhookLog','usage','customer','retryCount','message','getPaymentById','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','test_gateway','customerName','üí∞\x20Getting\x20payouts\x20with\x20filters:','filter','update','gatewaySettings','totalPaidOut','get','responseBody','1442298ZYFmNG','usdcPolygonWallet','amountIsEditable','trc20','Payment\x20not\x20found','getTime','getPaymentByShopAndId','error','status','findMany','webhookUrl','gateways','convertToUSDT','count','Payment\x20System/1.0\x20(Test)','language','getShopPayoutStats','defineProperty','dailyRevenue','30d','merchantUrl','updateWallets','üìÖ\x20Period\x20end:\x20','deletePayment','lte','push','getWebhookLogs','KLYME\x20DE','PaymentService','createPublicPayment','isArray','setDate','reduce','...','üìä\x20Final\x20WHERE\x20conditions:','createdAt','59272FRxTiY','generateDailyStatistics','__esModule','testWebhook','ShopService','periodFrom','application/json','USDC\x20Ethereum','currency','Error\x20parsing\x20webhook\x20events:','usdtErcWallet','shopUrl','notes','publicKey','desc','getFullYear','üåê\x20Network\x20filter:\x20','./paymentService','getPayoutStats','fullName','getShopProfile','payment','paymentService','webhookEvents','USDT\x20Polygon','1765tiRrKG','shop','USDT\x20TRC20','PAID','455bfIorC','üìÖ\x20Period\x20start:\x20','asc','currencyService','usdtTrcWallet','maxPayments','customerEmail','3NqHIaD','periodTo','184797hYpNki','test','log','amount','balance','settings','üìÖ\x20Date\x20end:\x20','telegram','createPayment','revenue','redirectUrl','toISOString','Failed\x20to\x20send\x20webhook:\x20','_sum','payout','getPaymentsByShop','erc20','test_order_123','shopId','\x20\x20\x20üíµ\x20Available\x20balance:\x20','Unknown\x20error','USDT\x20ERC20','3316OUPddZ','map','üìä\x20Shop\x20','YESTERDAY','formatNetworkName','wallets','352424GIoVWd','stringify','211706lTyIJj','telegramId','gte','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','yesterday','usdcErcWallet','getGatewayDisplayName'];a61_0x8097=function(){return _0x52be7d;};return a61_0x8097();}function a61_0x5b21(_0x9fadf0,_0x43932f){const _0x80971f=a61_0x8097();return a61_0x5b21=function(_0x5b2145,_0x3559cc){_0x5b2145=_0x5b2145-0x117;let _0x57c30b=_0x80971f[_0x5b2145];return _0x57c30b;},a61_0x5b21(_0x9fadf0,_0x43932f);}class ShopService{constructor(){const _0xa12491=a61_0x25e66a;this[_0xa12491(0x17f)]=new paymentService_1[(_0xa12491(0x161))]();}async[a61_0x25e66a(0x17d)](_0x7f4282){const _0x1d4adb=a61_0x25e66a,_0x4f1ada=await database_1[_0x1d4adb(0x123)][_0x1d4adb(0x183)][_0x1d4adb(0x11b)]({'where':{'id':_0x7f4282},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x4f1ada)throw new Error(_0x1d4adb(0x122));let _0xb47f66=[];if(_0x4f1ada[_0x1d4adb(0x194)]?.['webhookEvents'])try{_0xb47f66=Array[_0x1d4adb(0x163)](_0x4f1ada['settings'][_0x1d4adb(0x180)])?_0x4f1ada[_0x1d4adb(0x194)][_0x1d4adb(0x180)]:JSON[_0x1d4adb(0x12d)](_0x4f1ada[_0x1d4adb(0x194)][_0x1d4adb(0x180)]);}catch(_0x2c8c3d){console[_0x1d4adb(0x14c)](_0x1d4adb(0x172),_0x2c8c3d),_0xb47f66=[];}return{'id':_0x4f1ada['id'],'fullName':_0x4f1ada[_0x1d4adb(0x12b)],'username':_0x4f1ada['username'],'telegramId':_0x4f1ada['telegram'],'merchantUrl':_0x4f1ada[_0x1d4adb(0x174)],'gateways':_0x4f1ada[_0x1d4adb(0x1b7)]?JSON['parse'](_0x4f1ada['paymentGateways']):null,'gatewaySettings':_0x4f1ada[_0x1d4adb(0x141)]?JSON[_0x1d4adb(0x12d)](_0x4f1ada['gatewaySettings']):null,'publicKey':_0x4f1ada[_0x1d4adb(0x176)],'webhookUrl':_0x4f1ada[_0x1d4adb(0x194)]?.[_0x1d4adb(0x14f)]||null,'webhookEvents':_0xb47f66,'wallets':{'usdtPolygonWallet':_0x4f1ada['usdtPolygonWallet'],'usdtTrcWallet':_0x4f1ada[_0x1d4adb(0x18a)],'usdtErcWallet':_0x4f1ada[_0x1d4adb(0x173)],'usdcPolygonWallet':_0x4f1ada[_0x1d4adb(0x146)],'usdcErcWallet':_0x4f1ada['usdcErcWallet']},'status':_0x4f1ada[_0x1d4adb(0x14d)],'createdAt':_0x4f1ada['createdAt']};}async['updateShopProfile'](_0x5b880c,_0x584b57){const _0x792b39=a61_0x25e66a,_0x432eb1={};_0x584b57[_0x792b39(0x17c)]&&(_0x432eb1['name']=_0x584b57['fullName']);_0x584b57[_0x792b39(0x1ae)]!==undefined&&(_0x432eb1['telegram']=_0x584b57[_0x792b39(0x1ae)]||null);_0x584b57[_0x792b39(0x159)]&&(_0x432eb1[_0x792b39(0x174)]=_0x584b57[_0x792b39(0x159)]);_0x584b57[_0x792b39(0x150)]&&(_0x432eb1[_0x792b39(0x1b7)]=JSON[_0x792b39(0x1ac)](_0x584b57['gateways']));_0x584b57[_0x792b39(0x141)]&&(_0x432eb1[_0x792b39(0x141)]=JSON[_0x792b39(0x1ac)](_0x584b57['gatewaySettings']));_0x584b57[_0x792b39(0x1aa)]&&(_0x584b57['wallets']['usdtPolygonWallet']!==undefined&&(_0x432eb1['usdtPolygonWallet']=_0x584b57['wallets'][_0x792b39(0x1c7)]||null),_0x584b57[_0x792b39(0x1aa)][_0x792b39(0x18a)]!==undefined&&(_0x432eb1['usdtTrcWallet']=_0x584b57[_0x792b39(0x1aa)][_0x792b39(0x18a)]||null),_0x584b57['wallets'][_0x792b39(0x173)]!==undefined&&(_0x432eb1[_0x792b39(0x173)]=_0x584b57[_0x792b39(0x1aa)][_0x792b39(0x173)]||null),_0x584b57[_0x792b39(0x1aa)][_0x792b39(0x146)]!==undefined&&(_0x432eb1[_0x792b39(0x146)]=_0x584b57['wallets'][_0x792b39(0x146)]||null));const _0x48d063=await database_1[_0x792b39(0x123)][_0x792b39(0x183)]['update']({'where':{'id':_0x5b880c},'data':_0x432eb1,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x1e044a=[];if(_0x48d063[_0x792b39(0x194)]?.['webhookEvents'])try{_0x1e044a=Array[_0x792b39(0x163)](_0x48d063['settings'][_0x792b39(0x180)])?_0x48d063['settings']['webhookEvents']:JSON['parse'](_0x48d063[_0x792b39(0x194)][_0x792b39(0x180)]);}catch(_0x391f3c){console[_0x792b39(0x14c)](_0x792b39(0x172),_0x391f3c),_0x1e044a=[];}return{'id':_0x48d063['id'],'fullName':_0x48d063[_0x792b39(0x12b)],'username':_0x48d063[_0x792b39(0x11c)],'telegramId':_0x48d063[_0x792b39(0x196)],'merchantUrl':_0x48d063[_0x792b39(0x174)],'gateways':_0x48d063[_0x792b39(0x1b7)]?JSON[_0x792b39(0x12d)](_0x48d063[_0x792b39(0x1b7)]):null,'gatewaySettings':_0x48d063[_0x792b39(0x141)]?JSON[_0x792b39(0x12d)](_0x48d063['gatewaySettings']):null,'publicKey':_0x48d063[_0x792b39(0x176)],'webhookUrl':_0x48d063['settings']?.[_0x792b39(0x14f)]||null,'webhookEvents':_0x1e044a,'wallets':{'usdtPolygonWallet':_0x48d063['usdtPolygonWallet'],'usdtTrcWallet':_0x48d063[_0x792b39(0x18a)],'usdtErcWallet':_0x48d063[_0x792b39(0x173)],'usdcPolygonWallet':_0x48d063[_0x792b39(0x146)],'usdcErcWallet':_0x48d063[_0x792b39(0x1b2)]},'status':_0x48d063[_0x792b39(0x14d)],'createdAt':_0x48d063[_0x792b39(0x168)]};}async[a61_0x25e66a(0x15a)](_0x1812f8,_0x20d88c){const _0x459f63=a61_0x25e66a,_0x4afdeb={};_0x20d88c[_0x459f63(0x1c7)]!==undefined&&(_0x4afdeb[_0x459f63(0x1c7)]=_0x20d88c[_0x459f63(0x1c7)]||null),_0x20d88c['usdtTrcWallet']!==undefined&&(_0x4afdeb['usdtTrcWallet']=_0x20d88c[_0x459f63(0x18a)]||null),_0x20d88c['usdtErcWallet']!==undefined&&(_0x4afdeb[_0x459f63(0x173)]=_0x20d88c[_0x459f63(0x173)]||null),_0x20d88c[_0x459f63(0x146)]!==undefined&&(_0x4afdeb[_0x459f63(0x146)]=_0x20d88c[_0x459f63(0x146)]||null),_0x20d88c[_0x459f63(0x1b2)]!==undefined&&(_0x4afdeb[_0x459f63(0x1b2)]=_0x20d88c[_0x459f63(0x1b2)]||null),await database_1[_0x459f63(0x123)][_0x459f63(0x183)][_0x459f63(0x140)]({'where':{'id':_0x1812f8},'data':_0x4afdeb});}async[a61_0x25e66a(0x16c)](_0x33fdc0){const _0x1e6a9a=a61_0x25e66a,_0x5a41e9=await database_1[_0x1e6a9a(0x123)][_0x1e6a9a(0x183)][_0x1e6a9a(0x11b)]({'where':{'id':_0x33fdc0},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x5a41e9?.['settings']?.[_0x1e6a9a(0x14f)])throw new Error(_0x1e6a9a(0x125));const _0x38cb55={'event':'test','payment':{'id':_0x1e6a9a(0x1c4),'order_id':_0x1e6a9a(0x1a0),'gateway':_0x1e6a9a(0x190),'amount':0x64,'currency':'USD','status':_0x1e6a9a(0x11f),'created_at':new Date()[_0x1e6a9a(0x19a)]()}};try{const _0x23c515=await fetch(_0x5a41e9[_0x1e6a9a(0x194)][_0x1e6a9a(0x14f)],{'method':'POST','headers':{'Content-Type':_0x1e6a9a(0x16f),'User-Agent':_0x1e6a9a(0x153)},'body':JSON[_0x1e6a9a(0x1ac)](_0x38cb55)});return _0x23c515['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x23c515[_0x1e6a9a(0x14d)]+')'}:{'success':![],'message':'Webhook\x20returned\x20error:\x20'+_0x23c515[_0x1e6a9a(0x14d)]+'\x20'+_0x23c515['statusText']};}catch(_0x42e3b0){return{'success':![],'message':_0x1e6a9a(0x19b)+(_0x42e3b0 instanceof Error?_0x42e3b0[_0x1e6a9a(0x139)]:_0x1e6a9a(0x1a3))};}}async[a61_0x25e66a(0x197)](_0x124290){const _0x1526b0=a61_0x25e66a;return this[_0x1526b0(0x17f)][_0x1526b0(0x162)]({'public_key':'','gateway':_0x124290['gateway'],'order_id':undefined,'amount':_0x124290[_0x1526b0(0x192)],'currency':_0x124290['currency'],'source_currency':_0x124290[_0x1526b0(0x1c2)],'usage':_0x124290[_0x1526b0(0x136)],'expires_at':_0x124290[_0x1526b0(0x1bf)]?.['toISOString'](),'success_url':_0x124290[_0x1526b0(0x199)],'fail_url':_0x124290['redirectUrl'],'customer_email':_0x124290[_0x1526b0(0x18c)],'customer_name':_0x124290[_0x1526b0(0x13d)],'country':_0x124290[_0x1526b0(0x12a)],'language':_0x124290[_0x1526b0(0x154)],'amount_is_editable':_0x124290[_0x1526b0(0x147)],'max_payments':_0x124290[_0x1526b0(0x18b)],'customer':_0x124290[_0x1526b0(0x137)]});}async[a61_0x25e66a(0x1be)](_0x21fead,_0x5adf0e){const _0x38251d=a61_0x25e66a;return this[_0x38251d(0x17f)][_0x38251d(0x19e)](_0x21fead,_0x5adf0e);}async[a61_0x25e66a(0x13a)](_0x34b8b9,_0x3b809c){const _0x498c3c=a61_0x25e66a;return this[_0x498c3c(0x17f)][_0x498c3c(0x14b)](_0x34b8b9,_0x3b809c);}async['updatePayment'](_0x2b20a1,_0x5db004,_0x3ecaa1){const _0x15e74e=a61_0x25e66a,_0xc14587=await database_1['default'][_0x15e74e(0x17e)]['findFirst']({'where':{'id':_0x5db004,'shopId':_0x2b20a1}});if(!_0xc14587)throw new Error(_0x15e74e(0x149));const _0xc126db=await database_1[_0x15e74e(0x123)]['payment'][_0x15e74e(0x140)]({'where':{'id':_0x5db004},'data':{..._0x3ecaa1,'updatedAt':new Date()}});return _0xc126db;}async[a61_0x25e66a(0x15c)](_0x3df7ca,_0x165216){const _0x5c286a=a61_0x25e66a,_0x45c4ac=await database_1[_0x5c286a(0x123)][_0x5c286a(0x17e)][_0x5c286a(0x131)]({'where':{'id':_0x165216,'shopId':_0x3df7ca}});if(!_0x45c4ac)throw new Error(_0x5c286a(0x149));await database_1[_0x5c286a(0x123)][_0x5c286a(0x17e)][_0x5c286a(0x1c3)]({'where':{'id':_0x165216}});}[a61_0x25e66a(0x1a9)](_0x34b209){const _0x5c84f5=a61_0x25e66a,_0x47cdd5={'polygon':_0x5c84f5(0x181),'trc20':_0x5c84f5(0x184),'erc20':_0x5c84f5(0x1a4),'bsc':'USDT\x20BSC','polygon_usdc':'USDC\x20Polygon','erc20_usdc':_0x5c84f5(0x170)};return _0x47cdd5[_0x34b209]||_0x34b209;}async['getPayouts'](_0x1cdc56,_0x396def){const _0x4d524d=a61_0x25e66a,{page:_0x378706,limit:_0x19fb19,status:_0x230519,method:_0x484ca7,network:_0x1ceaad,dateFrom:_0x38ff9c,dateTo:_0x39c275,periodFrom:_0x4ef1fd,periodTo:_0x2843ba}=_0x396def,_0x3227f2=(_0x378706-0x1)*_0x19fb19;console['log'](_0x4d524d(0x13e),_0x396def);const _0x5c675d={'shopId':_0x1cdc56};_0x230519&&(_0x5c675d[_0x4d524d(0x14d)]=_0x230519[_0x4d524d(0x128)](),console[_0x4d524d(0x191)]('üìä\x20Status\x20filter:\x20'+_0x230519[_0x4d524d(0x128)]()));if(_0x484ca7)_0x5c675d['network']=_0x484ca7,console[_0x4d524d(0x191)]('üåê\x20Method\x20filter:\x20'+_0x484ca7);else _0x1ceaad&&(_0x5c675d[_0x4d524d(0x1b5)]=_0x1ceaad,console[_0x4d524d(0x191)](_0x4d524d(0x179)+_0x1ceaad));if(_0x38ff9c||_0x39c275||_0x4ef1fd||_0x2843ba){_0x5c675d[_0x4d524d(0x168)]={};if(_0x4ef1fd){const _0x4878f4=new Date(_0x4ef1fd);_0x4878f4[_0x4d524d(0x1bb)](0x0,0x0,0x0,0x0),_0x5c675d[_0x4d524d(0x168)][_0x4d524d(0x1af)]=_0x4878f4,console[_0x4d524d(0x191)](_0x4d524d(0x187)+_0x4878f4['toISOString']());}else{if(_0x38ff9c){const _0x586ece=new Date(_0x38ff9c);_0x586ece[_0x4d524d(0x1bb)](0x0,0x0,0x0,0x0),_0x5c675d['createdAt'][_0x4d524d(0x1af)]=_0x586ece,console[_0x4d524d(0x191)]('üìÖ\x20Date\x20start:\x20'+_0x586ece['toISOString']());}}if(_0x2843ba){const _0x1246aa=new Date(_0x2843ba);_0x1246aa['setHours'](0x17,0x3b,0x3b,0x3e7),_0x5c675d['createdAt'][_0x4d524d(0x15d)]=_0x1246aa,console[_0x4d524d(0x191)](_0x4d524d(0x15b)+_0x1246aa[_0x4d524d(0x19a)]());}else{if(_0x39c275){const _0x21f8d6=new Date(_0x39c275);_0x21f8d6[_0x4d524d(0x1bb)](0x17,0x3b,0x3b,0x3e7),_0x5c675d[_0x4d524d(0x168)]['lte']=_0x21f8d6,console[_0x4d524d(0x191)](_0x4d524d(0x195)+_0x21f8d6[_0x4d524d(0x19a)]());}}}console[_0x4d524d(0x191)](_0x4d524d(0x167),JSON['stringify'](_0x5c675d,null,0x2));const [_0x4e84c4,_0x1b2b93]=await Promise[_0x4d524d(0x118)]([database_1[_0x4d524d(0x123)][_0x4d524d(0x19d)]['findMany']({'where':_0x5c675d,'skip':_0x3227f2,'take':_0x19fb19,'orderBy':{'createdAt':_0x4d524d(0x177)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![]}}}}),database_1[_0x4d524d(0x123)][_0x4d524d(0x19d)]['count']({'where':_0x5c675d})]);return{'payouts':_0x4e84c4[_0x4d524d(0x1a6)](_0x4b368d=>{const _0x29a83a=_0x4d524d;let _0x5d002e=null;switch(_0x4b368d[_0x29a83a(0x1b5)]){case'polygon':_0x5d002e=_0x4b368d[_0x29a83a(0x183)][_0x29a83a(0x1c7)];break;case _0x29a83a(0x148):_0x5d002e=_0x4b368d['shop']['usdtTrcWallet'];break;case _0x29a83a(0x19f):_0x5d002e=_0x4b368d[_0x29a83a(0x183)][_0x29a83a(0x173)];break;case _0x29a83a(0x126):_0x5d002e=_0x4b368d[_0x29a83a(0x183)][_0x29a83a(0x146)];break;case'erc20_usdc':_0x5d002e=_0x4b368d[_0x29a83a(0x183)][_0x29a83a(0x1b2)];break;}return{'id':_0x4b368d['id'],'amount':_0x4b368d[_0x29a83a(0x192)],'network':this[_0x29a83a(0x1a9)](_0x4b368d['network']),'wallet':_0x5d002e,'status':_0x4b368d[_0x29a83a(0x14d)],'txid':_0x4b368d[_0x29a83a(0x124)],'notes':_0x4b368d[_0x29a83a(0x175)],'periodFrom':_0x4b368d[_0x29a83a(0x16e)],'periodTo':_0x4b368d[_0x29a83a(0x18e)],'createdAt':_0x4b368d[_0x29a83a(0x168)],'paidAt':_0x4b368d['paidAt']};}),'pagination':{'page':_0x378706,'limit':_0x19fb19,'total':_0x1b2b93,'totalPages':Math['ceil'](_0x1b2b93/_0x19fb19)}};}async[a61_0x25e66a(0x11e)](_0x5f6adc,_0x423088){const _0x480f0e=a61_0x25e66a,_0x158cbe=await database_1['default']['payout'][_0x480f0e(0x131)]({'where':{'id':_0x423088,'shopId':_0x5f6adc}});if(!_0x158cbe)return null;return{'id':_0x158cbe['id'],'amount':_0x158cbe[_0x480f0e(0x192)],'network':_0x158cbe['network'],'status':_0x158cbe[_0x480f0e(0x14d)],'txid':_0x158cbe['txid'],'notes':_0x158cbe[_0x480f0e(0x175)],'createdAt':_0x158cbe[_0x480f0e(0x168)],'paidAt':_0x158cbe[_0x480f0e(0x119)]};}async['getPayoutStatistics'](_0xfe19fc,_0x329b69){const _0x2103bc=a61_0x25e66a,_0x104f3c=new Date();let _0x4adce4,_0x72de3;switch(_0x329b69){case _0x2103bc(0x1b1):case _0x2103bc(0x1a8):const _0x4392ab=new Date(_0x104f3c);_0x4392ab['setDate'](_0x4392ab['getDate']()-0x1),_0x4adce4=new Date(_0x4392ab),_0x4adce4['setHours'](0x0,0x0,0x0,0x0),_0x72de3=new Date(_0x4392ab),_0x72de3[_0x2103bc(0x1bb)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x4adce4=new Date(_0x104f3c[_0x2103bc(0x14a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x2103bc(0x158):_0x4adce4=new Date(_0x104f3c[_0x2103bc(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x4adce4=new Date(_0x104f3c['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x4adce4=new Date(_0x104f3c[_0x2103bc(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x55c870={'gte':_0x4adce4};_0x72de3&&(_0x55c870[_0x2103bc(0x15d)]=_0x72de3);const [_0x31333e,_0x76cd0d,_0x47e934,_0x230126,_0xde96ab,_0x241c31]=await Promise[_0x2103bc(0x118)]([database_1[_0x2103bc(0x123)][_0x2103bc(0x19d)]['count']({'where':{'shopId':_0xfe19fc,'createdAt':_0x55c870}}),database_1[_0x2103bc(0x123)][_0x2103bc(0x19d)][_0x2103bc(0x152)]({'where':{'shopId':_0xfe19fc,'status':'COMPLETED','createdAt':_0x55c870}}),database_1[_0x2103bc(0x123)]['payout'][_0x2103bc(0x152)]({'where':{'shopId':_0xfe19fc,'status':'PENDING','createdAt':_0x55c870}}),database_1['default'][_0x2103bc(0x19d)][_0x2103bc(0x152)]({'where':{'shopId':_0xfe19fc,'status':_0x2103bc(0x129),'createdAt':_0x55c870}}),database_1['default'][_0x2103bc(0x19d)][_0x2103bc(0x14e)]({'where':{'shopId':_0xfe19fc,'createdAt':_0x55c870},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1['default'][_0x2103bc(0x19d)]['findMany']({'where':{'shopId':_0xfe19fc},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x3983e1=_0xde96ab[_0x2103bc(0x165)]((_0x5bf7d3,_0x13caf9)=>_0x5bf7d3+_0x13caf9[_0x2103bc(0x192)],0x0),_0x4dadb5=_0xde96ab[_0x2103bc(0x13f)](_0x4bae6e=>_0x4bae6e[_0x2103bc(0x14d)]===_0x2103bc(0x1b8))[_0x2103bc(0x165)]((_0x2d036a,_0x1c91c7)=>_0x2d036a+_0x1c91c7['amount'],0x0),_0x404064=_0xde96ab[_0x2103bc(0x13f)](_0x4bc27b=>_0x4bc27b[_0x2103bc(0x14d)]==='PENDING')[_0x2103bc(0x165)]((_0x5881a4,_0xf1cdad)=>_0x5881a4+_0xf1cdad[_0x2103bc(0x192)],0x0),_0x5e7bfa=_0xde96ab[_0x2103bc(0x165)]((_0x315de7,_0xc9043c)=>{const _0x46f680=_0x2103bc;return _0x315de7[_0xc9043c['network']]=(_0x315de7[_0xc9043c[_0x46f680(0x1b5)]]||0x0)+0x1,_0x315de7;},{}),_0x18fce8=_0xde96ab[_0x2103bc(0x165)]((_0x4b005b,_0x4509c8)=>{const _0x4cae75=_0x2103bc;return _0x4b005b[_0x4509c8['status']]=(_0x4b005b[_0x4509c8[_0x4cae75(0x14d)]]||0x0)+0x1,_0x4b005b;},{});return{'totalPayouts':_0x31333e,'completedPayouts':_0x76cd0d,'pendingPayouts':_0x47e934,'rejectedPayouts':_0x230126,'totalAmount':_0x3983e1,'completedAmount':_0x4dadb5,'pendingAmount':_0x404064,'payoutsByMethod':_0x5e7bfa,'payoutsByStatus':_0x18fce8,'recentPayouts':_0x241c31[_0x2103bc(0x1a6)](_0x28043a=>({'id':_0x28043a['id'],'shopId':_0xfe19fc,'amount':_0x28043a[_0x2103bc(0x192)],'method':_0x28043a[_0x2103bc(0x1b5)],'status':_0x28043a[_0x2103bc(0x14d)],'txid':_0x28043a['txid'],'createdAt':_0x28043a[_0x2103bc(0x168)],'paidAt':_0x28043a['paidAt']}))};}async[a61_0x25e66a(0x155)](_0x21f3ea){const _0x126483=a61_0x25e66a;console[_0x126483(0x191)](_0x126483(0x1b0)+_0x21f3ea+_0x126483(0x166));const _0x4b316e=await database_1[_0x126483(0x123)][_0x126483(0x183)][_0x126483(0x11b)]({'where':{'id':_0x21f3ea},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x4b316e)throw new Error(_0x126483(0x122));const _0x1de9b5=new Date(),_0x270a2a=new Date(_0x1de9b5[_0x126483(0x178)](),_0x1de9b5[_0x126483(0x130)](),0x1),_0x578e2e=new Date(_0x1de9b5[_0x126483(0x178)](),_0x1de9b5[_0x126483(0x130)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x177b16=await database_1[_0x126483(0x123)][_0x126483(0x19d)][_0x126483(0x1c5)]({'_sum':{'amount':!![]},'where':{'shopId':_0x21f3ea,'createdAt':{'gte':_0x270a2a,'lte':_0x578e2e},'status':_0x126483(0x1b8)}}),_0x148050=_0x177b16[_0x126483(0x19c)]['amount']||0x0,_0x2464d8={'availableBalance':Math['round'](_0x4b316e['balance']*0x64)/0x64,'totalPaidOut':Math[_0x126483(0x120)](_0x4b316e[_0x126483(0x142)]*0x64)/0x64,'awaitingPayout':Math[_0x126483(0x120)](_0x4b316e[_0x126483(0x193)]*0x64)/0x64,'thisMonth':Math[_0x126483(0x120)](_0x148050*0x64)/0x64};return console['log'](_0x126483(0x1a7)+_0x4b316e['username']+'\x20payout\x20statistics\x20calculated:'),console[_0x126483(0x191)](_0x126483(0x1a2)+_0x2464d8[_0x126483(0x11a)]+'\x20USDT\x20(current\x20balance)'),console['log'](_0x126483(0x13b)+_0x2464d8[_0x126483(0x142)]+'\x20USDT\x20(total\x20payouts)'),console[_0x126483(0x191)](_0x126483(0x121)+_0x2464d8[_0x126483(0x127)]+'\x20USDT\x20(current\x20balance)'),console[_0x126483(0x191)](_0x126483(0x1c1)+_0x2464d8[_0x126483(0x12c)]+'\x20USDT'),_0x2464d8;}[a61_0x25e66a(0x1b3)](_0x34281e){const _0x31acb3=a61_0x25e66a,_0x38ff2d={'test_gateway':_0x31acb3(0x134),'plisio':'Plisio','rapyd':'Rapyd','noda':_0x31acb3(0x1b6),'cointopay':_0x31acb3(0x133),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x31acb3(0x11d),'klyme_de':_0x31acb3(0x160)};return _0x38ff2d[_0x34281e]||_0x34281e;}async[a61_0x25e66a(0x17b)](_0x1d93e4){return this['getShopPayoutStats'](_0x1d93e4);}async[a61_0x25e66a(0x15f)](_0x5ab43c,_0xb33272){const _0x46e8f3=a61_0x25e66a,{page:_0x1a4b01,limit:_0x1c3b1c,paymentId:_0x591d24}=_0xb33272,_0x5b1a5d=(_0x1a4b01-0x1)*_0x1c3b1c,_0x39e359={'shopId':_0x5ab43c};_0x591d24&&(_0x39e359[_0x46e8f3(0x1b4)]=_0x591d24);const [_0x481981,_0x18739a]=await Promise[_0x46e8f3(0x118)]([database_1[_0x46e8f3(0x123)][_0x46e8f3(0x135)][_0x46e8f3(0x14e)]({'where':_0x39e359,'skip':_0x5b1a5d,'take':_0x1c3b1c,'orderBy':{'createdAt':_0x46e8f3(0x177)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x46e8f3(0x123)]['webhookLog'][_0x46e8f3(0x152)]({'where':_0x39e359})]);return{'logs':_0x481981['map'](_0x416555=>({'id':_0x416555['id'],'paymentId':_0x416555[_0x46e8f3(0x1b4)],'shopId':_0x416555[_0x46e8f3(0x1a1)],'event':_0x416555['event'],'statusCode':_0x416555['statusCode'],'retryCount':_0x416555[_0x46e8f3(0x138)],'responseBody':_0x416555[_0x46e8f3(0x144)],'createdAt':_0x416555[_0x46e8f3(0x168)],'payment':_0x416555[_0x46e8f3(0x17e)]})),'pagination':{'page':_0x1a4b01,'limit':_0x1c3b1c,'total':_0x18739a,'totalPages':Math['ceil'](_0x18739a/_0x1c3b1c)}};}async[a61_0x25e66a(0x12e)](_0x1d419e,_0x2c91c8){const _0x1cf992=a61_0x25e66a,_0x57e406=new Date();let _0x5dd1ac,_0x527483;switch(_0x2c91c8['toLowerCase']()){case _0x1cf992(0x1c0):_0x5dd1ac=new Date(_0x57e406[_0x1cf992(0x178)](),_0x57e406[_0x1cf992(0x130)](),_0x57e406[_0x1cf992(0x1ba)](),0x0,0x0,0x0,0x0);break;case'yesterday':case _0x1cf992(0x1a8):const _0x2d64e6=new Date(_0x57e406);_0x2d64e6[_0x1cf992(0x164)](_0x2d64e6[_0x1cf992(0x1ba)]()-0x1),_0x5dd1ac=new Date(_0x2d64e6),_0x5dd1ac['setHours'](0x0,0x0,0x0,0x0),_0x527483=new Date(_0x2d64e6),_0x527483['setHours'](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x5dd1ac=new Date(_0x57e406[_0x1cf992(0x14a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x1cf992(0x158):_0x5dd1ac=new Date(_0x57e406[_0x1cf992(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x1cf992(0x1bd):_0x5dd1ac=new Date(_0x57e406['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x5dd1ac=new Date(_0x57e406[_0x1cf992(0x14a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x2e0e87={'gte':_0x5dd1ac};_0x527483&&(_0x2e0e87[_0x1cf992(0x15d)]=_0x527483);const [_0x3a48b5,_0x26f408,_0x3c135d,_0xefe7fa,_0x25bc73]=await Promise['all']([database_1[_0x1cf992(0x123)][_0x1cf992(0x17e)][_0x1cf992(0x152)]({'where':{'shopId':_0x1d419e,'gateway':{'not':_0x1cf992(0x13c)},'createdAt':_0x2e0e87}}),database_1['default'][_0x1cf992(0x17e)]['count']({'where':{'shopId':_0x1d419e,'gateway':{'not':_0x1cf992(0x13c)},'status':'PAID','createdAt':_0x2e0e87}}),database_1[_0x1cf992(0x123)][_0x1cf992(0x17e)]['findMany']({'where':{'shopId':_0x1d419e,'gateway':{'not':'test_gateway'},'status':_0x1cf992(0x185),'createdAt':_0x2e0e87},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x1cf992(0x123)][_0x1cf992(0x17e)]['findMany']({'where':{'shopId':_0x1d419e,'gateway':{'not':_0x1cf992(0x13c)}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x1cf992(0x17e)][_0x1cf992(0x14e)]({'where':{'shopId':_0x1d419e,'gateway':{'not':_0x1cf992(0x13c)},'createdAt':_0x2e0e87},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x1cf992(0x188)}})]);let _0x1f3459=0x0;for(const _0x2b16ee of _0x3c135d){if(_0x2b16ee[_0x1cf992(0x117)])_0x1f3459+=_0x2b16ee[_0x1cf992(0x117)];else{const _0x5a8ab3=await currencyService_1[_0x1cf992(0x189)][_0x1cf992(0x151)](_0x2b16ee[_0x1cf992(0x192)],_0x2b16ee[_0x1cf992(0x171)]);_0x1f3459+=_0x5a8ab3;}}const _0x3aec10=this[_0x1cf992(0x16a)](_0x25bc73,_0x5dd1ac,_0x527483||_0x57e406),_0x11da6e=_0x3a48b5>0x0?_0x26f408/_0x3a48b5*0x64:0x0;return{'totalPayments':_0x3a48b5,'successfulPayments':_0x26f408,'totalRevenue':Math[_0x1cf992(0x120)](_0x1f3459*0x64)/0x64,'conversionRate':Math['round'](_0x11da6e*0x64)/0x64,'dailyRevenue':_0x3aec10[_0x1cf992(0x157)],'dailyPayments':_0x3aec10['dailyPayments'],'recentPayments':_0xefe7fa[_0x1cf992(0x1a6)](_0x347a06=>({'id':_0x347a06['id'],'gateway':_0x347a06[_0x1cf992(0x1bc)],'amount':_0x347a06[_0x1cf992(0x192)],'currency':_0x347a06[_0x1cf992(0x171)],'status':_0x347a06['status'],'createdAt':_0x347a06[_0x1cf992(0x168)]}))};}['generateDailyStatistics'](_0x13defe,_0x58ac09,_0x49ad4a){const _0x454aa8=a61_0x25e66a,_0x1d591c=new Map(),_0x3d9737=new Date(_0x58ac09);while(_0x3d9737<=_0x49ad4a){const _0x40580b=_0x3d9737['toISOString']()['split']('T')[0x0];_0x1d591c['set'](_0x40580b,{'revenue':0x0,'count':0x0}),_0x3d9737[_0x454aa8(0x164)](_0x3d9737['getDate']()+0x1);}for(const _0x2d6048 of _0x13defe){const _0x1e5648=_0x2d6048[_0x454aa8(0x168)][_0x454aa8(0x19a)]()[_0x454aa8(0x1b9)]('T')[0x0],_0x1e1ed5=_0x1d591c[_0x454aa8(0x143)](_0x1e5648);_0x1e1ed5&&(_0x1e1ed5['count']+=0x1,_0x2d6048[_0x454aa8(0x14d)]===_0x454aa8(0x185)&&_0x2d6048[_0x454aa8(0x117)]&&(_0x1e1ed5[_0x454aa8(0x198)]+=_0x2d6048[_0x454aa8(0x117)]));}const _0x386173=[],_0x24c2f2=[];for(const [_0x3e0b5a,_0xb872fd]of _0x1d591c){_0x386173[_0x454aa8(0x15e)]({'date':_0x3e0b5a,'amount':Math[_0x454aa8(0x120)](_0xb872fd[_0x454aa8(0x198)]*0x64)/0x64}),_0x24c2f2['push']({'date':_0x3e0b5a,'count':_0xb872fd[_0x454aa8(0x152)]});}return{'dailyRevenue':_0x386173,'dailyPayments':_0x24c2f2};}}exports[a61_0x25e66a(0x16d)]=ShopService;