'use strict';const a48_0x5535f9=a48_0x4e73;(function(_0x44c002,_0x33f9f8){const _0x252d01=a48_0x4e73,_0x3d151e=_0x44c002();while(!![]){try{const _0x379941=-parseInt(_0x252d01(0x121))/0x1+parseInt(_0x252d01(0x8c))/0x2+parseInt(_0x252d01(0xe0))/0x3*(-parseInt(_0x252d01(0xe4))/0x4)+-parseInt(_0x252d01(0x124))/0x5*(-parseInt(_0x252d01(0xa0))/0x6)+-parseInt(_0x252d01(0x126))/0x7*(parseInt(_0x252d01(0x13a))/0x8)+-parseInt(_0x252d01(0xb8))/0x9*(parseInt(_0x252d01(0xca))/0xa)+parseInt(_0x252d01(0x159))/0xb;if(_0x379941===_0x33f9f8)break;else _0x3d151e['push'](_0x3d151e['shift']());}catch(_0x560576){_0x3d151e['push'](_0x3d151e['shift']());}}}(a48_0x2d4a,0xbc49a));function a48_0x2d4a(){const _0x5c1bda=['payment','test@example.com','findMany','updatePayment','📊\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','paidAt','length','error','PlisioService','reduce','nodaService','name','❌\x20Test\x20webhook\x20error:\x20','toUpperCase','createPayment','availableBalance','log','calculateAmountAfterCommission','gatewayPaymentId','USD','updateWallets','rapyd','💵\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','currencyService','$queryRaw','convertToUSDT','🔄\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20','setDate','all','webhookLog','usdcPolygonWallet','push','customerName','generateGatewayOrderId','fullName','/payment/pending?payment_id=','./gateways/coinToPayService','status','responseBody','FAILED','\x20(8digits-8digits\x20format\x20for\x20','qr_code_url','rapydService','deletePayment','externalPaymentUrl','https://tesoft.uk/gateway/payment.php?id=','1185848ISavQc','Shop\x20not\x20found','padStart','30bMcowA','ONCE','77SFkTNe','toFixed','gateway_payment_id','message','wallets','noda','customer','💰\x20Available\x20Balance:\x20','💰\x20Found\x20','amount','getPayments','merchantPaid','commission','telegramId','✅\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','createdAt','usdtErcWallet','🎯\x20Generated\x20unique\x20gateway\x20order_id:\x20','_sum','getGatewaySettings','940136JAJzYh','shop','groupBy','__importDefault','90d','notes','usdtPolygonWallet','invoice_total_sum','30d','getPaymentById','publicKey','defineProperty','💸\x20Total\x20Paid\x20Out:\x20','Test\x20payload:','updatedAt','toLowerCase','plisioService','parse','statusCode','expiresAt','COMPLETED','toString','__esModule','payment_url','https://tesoft.uk/gateways/noda/webhook','coinToPayService','round','⏳\x20Awaiting\x20Payout:\x20','startsWith','revenue','now','20729214qAceCu','username','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','usdtTrcWallet','webhookLogs','getTime','PAID','isEligibleForPayout','klyme_','paid','Failed\x20to\x20log\x20test\x20webhook:','getPeriodDays','aggregate','map','currency','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20','customerEmail','findFirst','getFullYear','/payment/fail?payment_id=','generateGatewayUrls','charAt','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','🪙\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','2992592vlTQYe','date','paymentId','gateway','🔗\x20Generated\x20URLs\x20for\x20','get','thisMonth','./currencyService','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','updateShopProfile','_count','floor','⚠️\x20Gateway\x20order\x20ID\x20','maxPayments','network','Order\x20ID:\x20','NodaService','testWebhook','📅\x20This\x20Month:\x20','country','1277976cTNgnx','toISOString','getPayoutStats','KlymeService','default','webhookUrl','slice','env','payment.success','✅\x20Test\x20webhook\x20sent\x20successfully:\x20','💰\x20Amount:\x20','count','desc','PENDING','totalPaidOut','findUnique','language','telegram','ceil','📈\x20Average\x20payment:\x20','split','cointopay','Test\x20Customer','\x20USDT','27UfSYtY','gatewaySettings','createPaymentLink','settings','paymentGateways','✅\x20Shop\x20statistics\x20generated\x20successfully','HTTP\x20','getGatewayNameById','test_payment_','getPayoutStatistics','\x20(8digits-8digits\x20format)','💾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20','usage','./gateways/plisioService','test_webhook','stringify','Unknown\x20error','getMonth','4585730RuAaGR','shopUrl','true','generateDateRange','payoutDelay','payments','CoinToPayService','random','getDate','🔄\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','delete','getShopPayoutStats','payout','filter','\x20\x20\x20✅\x20Success:\x20','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','sourceCurrency','isValidGatewayId','shopId','rapydCustomer','application/json','49899vjAeEH','getWebhookLogs','plisio','gte','8JuqfHk','update','getShopProfile','awaitingPayout','\x20PAID\x20payments\x20for\x20totalAmount\x20calculation','amountIsEditable','txid','✅\x20Successful\x20payments:\x20','🧪\x20Sending\x20test\x20webhook\x20to:\x20','klymeService','qr_code','create','gateways','📊\x20Daily\x20revenue\x20entries:\x20','merchantUrl'];a48_0x2d4a=function(){return _0x5c1bda;};return a48_0x2d4a();}var __importDefault=this&&this[a48_0x5535f9(0x13d)]||function(_0x4ecbf5){const _0x760116=a48_0x5535f9;return _0x4ecbf5&&_0x4ecbf5[_0x760116(0x150)]?_0x4ecbf5:{'default':_0x4ecbf5};};Object[a48_0x5535f9(0x145)](exports,a48_0x5535f9(0x150),{'value':!![]}),exports['ShopService']=void 0x0;function a48_0x4e73(_0x591320,_0x537ea0){const _0x2d4a22=a48_0x2d4a();return a48_0x4e73=function(_0x4e7366,_0x45d3ec){_0x4e7366=_0x4e7366-0x76;let _0x3188a5=_0x2d4a22[_0x4e7366];return _0x3188a5;},a48_0x4e73(_0x591320,_0x537ea0);}const database_1=__importDefault(require('../config/database')),plisioService_1=require(a48_0x5535f9(0xc5)),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a48_0x5535f9(0x117)),klymeService_1=require('./gateways/klymeService'),currencyService_1=require(a48_0x5535f9(0x93)),gateway_1=require('../types/gateway');class ShopService{constructor(){const _0x38ba2a=a48_0x5535f9;this['plisioService']=new plisioService_1[(_0x38ba2a(0xfb))](),this[_0x38ba2a(0x11d)]=new rapydService_1['RapydService'](),this[_0x38ba2a(0xfd)]=new nodaService_1[(_0x38ba2a(0x9c))](),this[_0x38ba2a(0x153)]=new coinToPayService_1[(_0x38ba2a(0xd0))](),this[_0x38ba2a(0xed)]=new klymeService_1[(_0x38ba2a(0xa3))]();}async[a48_0x5535f9(0x114)](){const _0x3195bc=a48_0x5535f9;let _0x52d1f8,_0x53e395=0x0;const _0x3f7c81=0xa;do{const _0x3f4795=()=>{const _0x4b5e42=a48_0x4e73;return Math[_0x4b5e42(0x97)](Math[_0x4b5e42(0xd1)]()*0x5f5e100)[_0x4b5e42(0x14f)]()[_0x4b5e42(0x123)](0x8,'0');};_0x52d1f8=_0x3f4795()+'-'+_0x3f4795();const _0x3795b0=await database_1[_0x3195bc(0xa4)][_0x3195bc(0xf3)][_0x3195bc(0x85)]({'where':{'gatewayOrderId':_0x52d1f8}});if(!_0x3795b0)break;_0x53e395++,console['log'](_0x3195bc(0x98)+_0x52d1f8+_0x3195bc(0x76)+_0x53e395+')');}while(_0x53e395<_0x3f7c81);if(_0x53e395>=_0x3f7c81)throw new Error('Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts');return _0x52d1f8;}[a48_0x5535f9(0x88)](_0x44cc7f,_0x39e716,_0x277a45,_0x10fa2e,_0x26f0b5){const _0x55417d=a48_0x5535f9;if(_0x10fa2e&&_0x26f0b5)return{'finalSuccessUrl':_0x10fa2e,'finalFailUrl':_0x26f0b5};let _0x3b0483,_0xcaa5bb;return _0x44cc7f===_0x55417d(0x12b)||_0x44cc7f[_0x55417d(0x156)](_0x55417d(0x7c))?_0x3b0483=_0x10fa2e||_0x277a45+_0x55417d(0x116)+_0x39e716:_0x3b0483=_0x10fa2e||_0x277a45+'/payment/success?payment_id='+_0x39e716,_0xcaa5bb=_0x26f0b5||_0x277a45+_0x55417d(0x87)+_0x39e716,console[_0x55417d(0x103)](_0x55417d(0x90)+_0x44cc7f+':'),console[_0x55417d(0x103)](_0x55417d(0xd9)+_0x3b0483),console[_0x55417d(0x103)]('\x20\x20\x20❌\x20Fail:\x20'+_0xcaa5bb),{'finalSuccessUrl':_0x3b0483,'finalFailUrl':_0xcaa5bb};}['getGatewaySettings'](_0x57176c,_0x20b4ee){const _0x22f5a3=a48_0x5535f9,_0x44b90c=_0x57176c[_0x22f5a3(0xb9)]?JSON[_0x22f5a3(0x14b)](_0x57176c[_0x22f5a3(0xb9)]):null,_0xd89dab=_0x20b4ee[_0x22f5a3(0x89)](0x0)[_0x22f5a3(0x100)]()+_0x20b4ee[_0x22f5a3(0xa6)](0x1)[_0x22f5a3(0x149)]();if(_0x44b90c&&_0x44b90c[_0xd89dab])return{'commission':_0x44b90c[_0xd89dab][_0x22f5a3(0x132)],'payoutDelay':_0x44b90c[_0xd89dab]['payoutDelay']};return{'commission':0x0,'payoutDelay':0x0};}[a48_0x5535f9(0x7b)](_0x413acc,_0x37fd42){const _0x3a038d=a48_0x5535f9;if(_0x413acc[_0x3a038d(0x118)]!==_0x3a038d(0x7a)||_0x413acc[_0x3a038d(0x131)]||!_0x413acc['paidAt'])return![];const _0x48a3bb=_0x37fd42[_0x3a038d(0xce)]*0x18*0x3c*0x3c*0x3e8,_0x4f45e5=new Date(_0x413acc[_0x3a038d(0xf8)][_0x3a038d(0x79)]()+_0x48a3bb);return new Date()>_0x4f45e5;}[a48_0x5535f9(0x104)](_0x2ff995,_0x4a4e70){return _0x2ff995*(0x1-_0x4a4e70/0x64);}async[a48_0x5535f9(0xe6)](_0x1bbdcc){const _0x429454=a48_0x5535f9,_0x4345ab=await database_1[_0x429454(0xa4)]['shop'][_0x429454(0xaf)]({'where':{'id':_0x1bbdcc},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x4345ab)throw new Error(_0x429454(0x122));return{'id':_0x4345ab['id'],'fullName':_0x4345ab['name'],'username':_0x4345ab[_0x429454(0x15a)],'telegramId':_0x4345ab[_0x429454(0xb1)],'merchantUrl':_0x4345ab[_0x429454(0xcb)],'gateways':_0x4345ab[_0x429454(0xbc)]?JSON[_0x429454(0x14b)](_0x4345ab['paymentGateways']):null,'gatewaySettings':_0x4345ab[_0x429454(0xb9)]?JSON[_0x429454(0x14b)](_0x4345ab[_0x429454(0xb9)]):null,'publicKey':_0x4345ab[_0x429454(0x144)],'wallets':{'usdtPolygonWallet':_0x4345ab['usdtPolygonWallet'],'usdtTrcWallet':_0x4345ab['usdtTrcWallet'],'usdtErcWallet':_0x4345ab['usdtErcWallet'],'usdcPolygonWallet':_0x4345ab[_0x429454(0x111)]},'status':_0x4345ab[_0x429454(0x118)],'createdAt':_0x4345ab['createdAt']};}async[a48_0x5535f9(0x95)](_0x18dad2,_0x1f95ce){const _0x31a41e=a48_0x5535f9,_0x3468fc={..._0x1f95ce};_0x1f95ce[_0x31a41e(0x115)]&&(_0x3468fc[_0x31a41e(0xfe)]=_0x1f95ce['fullName'],delete _0x3468fc[_0x31a41e(0x115)]);_0x1f95ce[_0x31a41e(0x133)]&&(_0x3468fc['telegram']=_0x1f95ce[_0x31a41e(0x133)],delete _0x3468fc[_0x31a41e(0x133)]);_0x1f95ce[_0x31a41e(0xf2)]&&(_0x3468fc[_0x31a41e(0xcb)]=_0x1f95ce[_0x31a41e(0xf2)],delete _0x3468fc[_0x31a41e(0xf2)]);_0x1f95ce[_0x31a41e(0xf0)]&&(_0x3468fc[_0x31a41e(0xbc)]=JSON['stringify'](_0x1f95ce[_0x31a41e(0xf0)]),delete _0x3468fc[_0x31a41e(0xf0)]);_0x1f95ce['gatewaySettings']&&(_0x3468fc[_0x31a41e(0xb9)]=JSON['stringify'](_0x1f95ce[_0x31a41e(0xb9)]),delete _0x3468fc['gatewaySettings']);_0x1f95ce[_0x31a41e(0x12a)]&&(_0x1f95ce[_0x31a41e(0x12a)][_0x31a41e(0x140)]!==undefined&&(_0x3468fc[_0x31a41e(0x140)]=_0x1f95ce[_0x31a41e(0x12a)]['usdtPolygonWallet']||null),_0x1f95ce[_0x31a41e(0x12a)]['usdtTrcWallet']!==undefined&&(_0x3468fc[_0x31a41e(0x77)]=_0x1f95ce['wallets'][_0x31a41e(0x77)]||null),_0x1f95ce[_0x31a41e(0x12a)][_0x31a41e(0x136)]!==undefined&&(_0x3468fc[_0x31a41e(0x136)]=_0x1f95ce[_0x31a41e(0x12a)][_0x31a41e(0x136)]||null),_0x1f95ce[_0x31a41e(0x12a)][_0x31a41e(0x111)]!==undefined&&(_0x3468fc[_0x31a41e(0x111)]=_0x1f95ce['wallets'][_0x31a41e(0x111)]||null),delete _0x3468fc[_0x31a41e(0x12a)]);const _0x23dd36=await database_1[_0x31a41e(0xa4)][_0x31a41e(0x13b)][_0x31a41e(0xe5)]({'where':{'id':_0x18dad2},'data':_0x3468fc,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x23dd36['id'],'fullName':_0x23dd36[_0x31a41e(0xfe)],'username':_0x23dd36[_0x31a41e(0x15a)],'telegramId':_0x23dd36['telegram'],'merchantUrl':_0x23dd36['shopUrl'],'gateways':_0x23dd36[_0x31a41e(0xbc)]?JSON[_0x31a41e(0x14b)](_0x23dd36[_0x31a41e(0xbc)]):null,'gatewaySettings':_0x23dd36[_0x31a41e(0xb9)]?JSON[_0x31a41e(0x14b)](_0x23dd36[_0x31a41e(0xb9)]):null,'publicKey':_0x23dd36[_0x31a41e(0x144)],'wallets':{'usdtPolygonWallet':_0x23dd36['usdtPolygonWallet'],'usdtTrcWallet':_0x23dd36[_0x31a41e(0x77)],'usdtErcWallet':_0x23dd36[_0x31a41e(0x136)],'usdcPolygonWallet':_0x23dd36[_0x31a41e(0x111)]},'status':_0x23dd36[_0x31a41e(0x118)],'createdAt':_0x23dd36[_0x31a41e(0x135)]};}async[a48_0x5535f9(0x107)](_0xf95da7,_0x4e1271){const _0x3a27f4=a48_0x5535f9,_0x50b49e={};_0x4e1271[_0x3a27f4(0x140)]!==undefined&&(_0x50b49e['usdtPolygonWallet']=_0x4e1271[_0x3a27f4(0x140)]||null),_0x4e1271[_0x3a27f4(0x77)]!==undefined&&(_0x50b49e['usdtTrcWallet']=_0x4e1271[_0x3a27f4(0x77)]||null),_0x4e1271[_0x3a27f4(0x136)]!==undefined&&(_0x50b49e[_0x3a27f4(0x136)]=_0x4e1271[_0x3a27f4(0x136)]||null),_0x4e1271[_0x3a27f4(0x111)]!==undefined&&(_0x50b49e[_0x3a27f4(0x111)]=_0x4e1271['usdcPolygonWallet']||null),await database_1['default'][_0x3a27f4(0x13b)][_0x3a27f4(0xe5)]({'where':{'id':_0xf95da7},'data':_0x50b49e});}async[a48_0x5535f9(0x9d)](_0x1c5e55){const _0x4e8fc9=a48_0x5535f9,_0x12011b=await database_1[_0x4e8fc9(0xa4)]['shop'][_0x4e8fc9(0xaf)]({'where':{'id':_0x1c5e55},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x12011b)throw new Error(_0x4e8fc9(0x122));const _0x579ccf=_0x12011b[_0x4e8fc9(0xbb)]?.[_0x4e8fc9(0xa5)];if(!_0x579ccf)throw new Error('No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.');const _0x255537=await this[_0x4e8fc9(0x114)](),_0x423fc1={'event':_0x4e8fc9(0xa8),'payment':{'id':_0x4e8fc9(0xc0)+Date['now'](),'order_id':null,'gateway_order_id':_0x255537,'gateway':'plisio','amount':0x64,'currency':_0x4e8fc9(0x106),'status':_0x4e8fc9(0x7d),'customer_email':_0x4e8fc9(0xf4),'customer_name':_0x4e8fc9(0xb6),'created_at':new Date()[_0x4e8fc9(0xa1)](),'updated_at':new Date()[_0x4e8fc9(0xa1)]()},'test':!![],'shop':{'id':_0x12011b['id'],'name':_0x12011b[_0x4e8fc9(0xfe)]},'timestamp':new Date()[_0x4e8fc9(0xa1)]()},_0x5219de=Date['now']();let _0x344958=0x0,_0x4c5865=![],_0x3792db;try{console[_0x4e8fc9(0x103)](_0x4e8fc9(0xec)+_0x579ccf),console[_0x4e8fc9(0x103)](_0x4e8fc9(0x147),JSON['stringify'](_0x423fc1,null,0x2));const _0x34ae34=await fetch(_0x579ccf,{'method':'POST','headers':{'Content-Type':_0x4e8fc9(0xdf),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','X-Webhook-Test':_0x4e8fc9(0xcc)},'body':JSON[_0x4e8fc9(0xc7)](_0x423fc1)});_0x344958=_0x34ae34[_0x4e8fc9(0x118)],_0x4c5865=_0x34ae34['ok'];if(!_0x34ae34['ok']){const _0x5c4de9=await _0x34ae34['text']();_0x3792db=_0x4e8fc9(0xbe)+_0x34ae34['status']+':\x20'+_0x5c4de9,console[_0x4e8fc9(0xfa)]('❌\x20Test\x20webhook\x20failed:\x20'+_0x3792db);}else console[_0x4e8fc9(0x103)](_0x4e8fc9(0xa9)+_0x34ae34[_0x4e8fc9(0x118)]);}catch(_0x4e44e6){_0x3792db=_0x4e44e6 instanceof Error?_0x4e44e6[_0x4e8fc9(0x129)]:_0x4e8fc9(0xc8),console[_0x4e8fc9(0xfa)](_0x4e8fc9(0xff)+_0x3792db);}const _0x314733=Date[_0x4e8fc9(0x158)]()-_0x5219de;try{await database_1[_0x4e8fc9(0xa4)][_0x4e8fc9(0x110)][_0x4e8fc9(0xef)]({'data':{'paymentId':_0x4e8fc9(0xc6),'shopId':_0x12011b['id'],'event':_0x4e8fc9(0xc6),'statusCode':_0x344958,'responseBody':JSON['stringify']({'success':_0x4c5865,'error':_0x3792db,'responseTime':_0x314733,'testPayload':_0x423fc1})}});}catch(_0x499388){console[_0x4e8fc9(0xfa)](_0x4e8fc9(0x7e),_0x499388);}return{'webhookUrl':_0x579ccf,'statusCode':_0x344958,'responseTime':_0x314733,'success':_0x4c5865,'error':_0x3792db};}async['createPayment'](_0x38d6e0){const _0x2b06e4=a48_0x5535f9;let _0x49b7d9;if((0x0,gateway_1[_0x2b06e4(0xdc)])(_0x38d6e0[_0x2b06e4(0x8f)])){const _0xec7756=(0x0,gateway_1[_0x2b06e4(0xbf)])(_0x38d6e0[_0x2b06e4(0x8f)]);if(!_0xec7756)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x38d6e0[_0x2b06e4(0x8f)]);_0x49b7d9=_0xec7756;}else _0x49b7d9=_0x38d6e0[_0x2b06e4(0x8f)][_0x2b06e4(0x149)]();console[_0x2b06e4(0x103)](_0x2b06e4(0x10d)+_0x49b7d9);const _0x5b4e8d=await this['generateGatewayOrderId']();console[_0x2b06e4(0x103)](_0x2b06e4(0x137)+_0x5b4e8d+_0x2b06e4(0x11b)+_0x49b7d9+')');const _0x4d607d=await database_1['default'][_0x2b06e4(0x13b)][_0x2b06e4(0xaf)]({'where':{'id':_0x38d6e0[_0x2b06e4(0xdd)]},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x4d607d)throw new Error(_0x2b06e4(0x122));const _0x16253c=this['getGatewaySettings'](_0x4d607d,_0x49b7d9),_0xd4bb76=process[_0x2b06e4(0xa7)]['BASE_URL']||'https://tesoft.uk',{finalSuccessUrl:_0x59e21c,finalFailUrl:_0x2aaca7}=this[_0x2b06e4(0x88)](_0x49b7d9,_0x5b4e8d,_0xd4bb76,_0x38d6e0['redirectUrl'],undefined),_0x56b0ae=await database_1[_0x2b06e4(0xa4)][_0x2b06e4(0xf3)][_0x2b06e4(0xef)]({'data':{'shopId':_0x38d6e0[_0x2b06e4(0xdd)],'gateway':_0x49b7d9,'amount':_0x38d6e0[_0x2b06e4(0x12f)],'currency':_0x38d6e0[_0x2b06e4(0x82)]||'USD','sourceCurrency':_0x38d6e0[_0x2b06e4(0xdb)]||null,'usage':_0x38d6e0[_0x2b06e4(0xc4)]||_0x2b06e4(0x125),'expiresAt':_0x38d6e0[_0x2b06e4(0x14d)],'successUrl':_0x59e21c,'failUrl':_0x2aaca7,'status':_0x2b06e4(0xad),'orderId':null,'gatewayOrderId':_0x5b4e8d,'customerEmail':_0x38d6e0[_0x2b06e4(0x84)]||null,'customerName':_0x38d6e0[_0x2b06e4(0x113)]||null,'country':_0x38d6e0['country']||null,'language':_0x38d6e0['language']||null,'amountIsEditable':_0x38d6e0[_0x2b06e4(0xe9)]||null,'maxPayments':_0x38d6e0['maxPayments']||null,'rapydCustomer':_0x38d6e0[_0x2b06e4(0x12c)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console['log'](_0x2b06e4(0xc3)+_0x5b4e8d+_0x2b06e4(0xc2));let _0x54345c;try{if(_0x49b7d9===_0x2b06e4(0xe2)){let _0x833a01,_0x5c4a4c,_0x2b1500;_0x38d6e0[_0x2b06e4(0xdb)]?(_0x833a01=_0x38d6e0[_0x2b06e4(0xdb)],_0x5c4a4c=_0x38d6e0['currency']||'USD',_0x2b1500=![]):(_0x833a01=_0x2b06e4(0x106),_0x5c4a4c=_0x38d6e0[_0x2b06e4(0x82)]||_0x2b06e4(0x106),_0x2b1500=!![]);const _0x24e079=await this[_0x2b06e4(0x14a)][_0x2b06e4(0x101)]({'paymentId':_0x56b0ae['id'],'orderId':_0x5b4e8d,'amount':_0x38d6e0['amount'],'currency':_0x833a01,'productName':_0x2b06e4(0x9b)+_0x5b4e8d,'description':_0x2b06e4(0x9b)+_0x5b4e8d,'successUrl':_0x59e21c,'failUrl':_0x2aaca7,'customerEmail':_0x38d6e0[_0x2b06e4(0x84)],'customerName':_0x38d6e0[_0x2b06e4(0x113)],'isSourceCurrency':_0x2b1500});_0x54345c=_0x24e079[_0x2b06e4(0x151)],await database_1[_0x2b06e4(0xa4)][_0x2b06e4(0xf3)]['update']({'where':{'id':_0x56b0ae['id']},'data':{'externalPaymentUrl':_0x54345c,'gatewayPaymentId':_0x24e079[_0x2b06e4(0x128)],'invoiceTotalSum':Number(_0x24e079[_0x2b06e4(0x141)]),'qrCode':_0x24e079[_0x2b06e4(0xee)],'qrUrl':_0x24e079['qr_url']}}),_0x56b0ae[_0x2b06e4(0x11f)]=_0x54345c,_0x56b0ae[_0x2b06e4(0x105)]=_0x24e079[_0x2b06e4(0x128)];}else{if(_0x49b7d9===_0x2b06e4(0x108)){const _0x4f9e34='GB';console[_0x2b06e4(0x103)](_0x2b06e4(0x94));const _0x1f000c=await this[_0x2b06e4(0x11d)][_0x2b06e4(0xba)]({'paymentId':_0x56b0ae['id'],'orderId':_0x5b4e8d,'orderName':_0x2b06e4(0x9b)+_0x5b4e8d,'amount':_0x38d6e0[_0x2b06e4(0x12f)],'currency':_0x38d6e0[_0x2b06e4(0x82)]||_0x2b06e4(0x106),'country':_0x4f9e34,'usage':_0x38d6e0[_0x2b06e4(0xc4)]||_0x2b06e4(0x125),'maxPayments':_0x38d6e0['maxPayments'],'successUrl':_0x59e21c,'failUrl':_0x2aaca7});_0x54345c=_0x1f000c[_0x2b06e4(0x151)],await database_1[_0x2b06e4(0xa4)]['payment'][_0x2b06e4(0xe5)]({'where':{'id':_0x56b0ae['id']},'data':{'externalPaymentUrl':_0x54345c,'gatewayPaymentId':_0x1f000c[_0x2b06e4(0x128)],'country':_0x4f9e34}}),_0x56b0ae[_0x2b06e4(0x11f)]=_0x54345c,_0x56b0ae[_0x2b06e4(0x105)]=_0x1f000c['gateway_payment_id'];}else{if(_0x49b7d9===_0x2b06e4(0x12b)){console['log'](_0x2b06e4(0xd3)+_0x5b4e8d+_0x2b06e4(0xc2));const _0x945fd2=await this[_0x2b06e4(0xfd)][_0x2b06e4(0xba)]({'paymentId':_0x56b0ae['id'],'orderId':_0x5b4e8d,'name':'Order\x20ID:\x20'+_0x5b4e8d,'paymentDescription':_0x2b06e4(0x9b)+_0x5b4e8d,'amount':_0x38d6e0[_0x2b06e4(0x12f)],'currency':_0x38d6e0[_0x2b06e4(0x82)]||'USD','webhookUrl':_0x2b06e4(0x152),'returnUrl':_0x59e21c,'expiryDate':_0x38d6e0[_0x2b06e4(0x14d)]?.[_0x2b06e4(0xa1)]()});_0x54345c=_0x945fd2[_0x2b06e4(0x151)],await database_1[_0x2b06e4(0xa4)][_0x2b06e4(0xf3)]['update']({'where':{'id':_0x56b0ae['id']},'data':{'externalPaymentUrl':_0x54345c,'gatewayPaymentId':_0x945fd2[_0x2b06e4(0x128)],'qrUrl':_0x945fd2[_0x2b06e4(0x11c)]}}),_0x56b0ae[_0x2b06e4(0x11f)]=_0x54345c,_0x56b0ae[_0x2b06e4(0x105)]=_0x945fd2[_0x2b06e4(0x128)],console[_0x2b06e4(0x103)]('✅\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x5b4e8d);}else{if(_0x49b7d9===_0x2b06e4(0xb5)){console[_0x2b06e4(0x103)](_0x2b06e4(0x8b)+_0x5b4e8d+_0x2b06e4(0xc2)),console[_0x2b06e4(0x103)](_0x2b06e4(0xaa)+_0x38d6e0['amount']+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x442df9=await this[_0x2b06e4(0x153)][_0x2b06e4(0xba)]({'paymentId':_0x56b0ae['id'],'orderId':_0x5b4e8d,'amount':_0x38d6e0[_0x2b06e4(0x12f)]});_0x54345c=_0x442df9[_0x2b06e4(0x151)],await database_1['default']['payment']['update']({'where':{'id':_0x56b0ae['id']},'data':{'externalPaymentUrl':_0x54345c,'gatewayPaymentId':_0x442df9[_0x2b06e4(0x128)],'currency':'EUR'}}),_0x56b0ae[_0x2b06e4(0x11f)]=_0x54345c,_0x56b0ae[_0x2b06e4(0x105)]=_0x442df9['gateway_payment_id'],console[_0x2b06e4(0x103)](_0x2b06e4(0x134)+_0x5b4e8d);}else{if(_0x49b7d9[_0x2b06e4(0x156)](_0x2b06e4(0x7c))){const _0x1f47c8=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x49b7d9);if(!_0x1f47c8)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x49b7d9);if(_0x1f47c8!=='EU'&&_0x1f47c8!=='GB')throw new Error(_0x2b06e4(0x8a)+_0x1f47c8);console[_0x2b06e4(0x103)]('💳\x20Creating\x20KLYME\x20'+_0x1f47c8+_0x2b06e4(0xda)+_0x5b4e8d+_0x2b06e4(0xc2)),console[_0x2b06e4(0x103)]('💰\x20Amount:\x20'+_0x38d6e0[_0x2b06e4(0x12f)]+'\x20'+(_0x38d6e0[_0x2b06e4(0x82)]||'USD'));const _0xa28192=await this[_0x2b06e4(0xed)][_0x2b06e4(0xba)]({'paymentId':_0x56b0ae['id'],'orderId':_0x5b4e8d,'amount':_0x38d6e0[_0x2b06e4(0x12f)],'currency':_0x38d6e0[_0x2b06e4(0x82)]||'USD','region':_0x1f47c8,'redirectUrl':_0x59e21c});_0x54345c=_0xa28192['payment_url'],await database_1[_0x2b06e4(0xa4)][_0x2b06e4(0xf3)]['update']({'where':{'id':_0x56b0ae['id']},'data':{'externalPaymentUrl':_0x54345c,'gatewayPaymentId':_0xa28192[_0x2b06e4(0x128)]}}),_0x56b0ae[_0x2b06e4(0x11f)]=_0x54345c,_0x56b0ae['gatewayPaymentId']=_0xa28192['gateway_payment_id'],console['log']('✅\x20KLYME\x20'+_0x1f47c8+_0x2b06e4(0xd4)+_0x5b4e8d);}}}}}}catch(_0x3d9dbd){await database_1['default'][_0x2b06e4(0xf3)][_0x2b06e4(0xe5)]({'where':{'id':_0x56b0ae['id']},'data':{'status':_0x2b06e4(0x11a)}}),console[_0x2b06e4(0xfa)]('Gateway\x20error\x20during\x20shop\x20payment\x20creation:',_0x3d9dbd);}const _0x2495a6=_0x2b06e4(0x120)+_0x56b0ae['id'];return{'id':_0x56b0ae['id'],'shopId':_0x56b0ae[_0x2b06e4(0xdd)],'gateway':_0x56b0ae[_0x2b06e4(0x8f)],'amount':_0x56b0ae[_0x2b06e4(0x12f)],'currency':_0x56b0ae[_0x2b06e4(0x82)],'sourceCurrency':_0x56b0ae[_0x2b06e4(0xdb)],'usage':_0x56b0ae[_0x2b06e4(0xc4)],'expiresAt':_0x56b0ae['expiresAt'],'redirectUrl':_0x2495a6,'status':_0x56b0ae[_0x2b06e4(0x118)],'externalPaymentUrl':_0x54345c,'customerEmail':_0x56b0ae[_0x2b06e4(0x84)],'customerName':_0x56b0ae[_0x2b06e4(0x113)],'country':_0x56b0ae[_0x2b06e4(0x9f)],'language':_0x56b0ae[_0x2b06e4(0xb0)],'amountIsEditable':_0x56b0ae['amountIsEditable'],'maxPayments':_0x56b0ae[_0x2b06e4(0x99)],'customer':_0x56b0ae[_0x2b06e4(0xde)],'createdAt':_0x56b0ae['createdAt'],'updatedAt':_0x56b0ae[_0x2b06e4(0x148)],'shop':_0x56b0ae[_0x2b06e4(0x13b)]};}async[a48_0x5535f9(0x130)](_0x1cb44e,_0x4b5b43){const _0x519947=a48_0x5535f9,{page:_0x96a524,limit:_0x395af0,status:_0x4aa756,gateway:_0x297802}=_0x4b5b43,_0x54a38d=(_0x96a524-0x1)*_0x395af0,_0x4dc547={'shopId':_0x1cb44e};_0x4aa756&&(_0x4dc547[_0x519947(0x118)]=_0x4aa756);if(_0x297802){if((0x0,gateway_1[_0x519947(0xdc)])(_0x297802)){const _0x309bb7=(0x0,gateway_1['getGatewayNameById'])(_0x297802);_0x309bb7&&(_0x4dc547[_0x519947(0x8f)]=_0x309bb7);}else _0x4dc547[_0x519947(0x8f)]=_0x297802[_0x519947(0x149)]();}const [_0x4d0c9b,_0x4afcd8]=await Promise['all']([database_1[_0x519947(0xa4)][_0x519947(0xf3)]['findMany']({'where':_0x4dc547,'skip':_0x54a38d,'take':_0x395af0,'orderBy':{'createdAt':_0x519947(0xac)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1['default']['payment'][_0x519947(0xab)]({'where':_0x4dc547})]);return{'payments':_0x4d0c9b[_0x519947(0x81)](_0x5961f0=>{const _0x331eb5=_0x519947,_0x1c16f4='https://tesoft.uk/gateway/payment.php?id='+_0x5961f0['id'];return{'id':_0x5961f0['id'],'shopId':_0x5961f0['shopId'],'gateway':_0x5961f0['gateway'],'amount':_0x5961f0[_0x331eb5(0x12f)],'currency':_0x5961f0[_0x331eb5(0x82)],'sourceCurrency':_0x5961f0[_0x331eb5(0xdb)],'usage':_0x5961f0[_0x331eb5(0xc4)],'expiresAt':_0x5961f0[_0x331eb5(0x14d)],'redirectUrl':_0x1c16f4,'status':_0x5961f0['status'],'externalPaymentUrl':_0x5961f0[_0x331eb5(0x11f)],'customerEmail':_0x5961f0[_0x331eb5(0x84)],'customerName':_0x5961f0[_0x331eb5(0x113)],'country':_0x5961f0[_0x331eb5(0x9f)],'language':_0x5961f0[_0x331eb5(0xb0)],'amountIsEditable':_0x5961f0[_0x331eb5(0xe9)],'maxPayments':_0x5961f0[_0x331eb5(0x99)],'customer':_0x5961f0[_0x331eb5(0xde)],'createdAt':_0x5961f0[_0x331eb5(0x135)],'updatedAt':_0x5961f0['updatedAt'],'shop':_0x5961f0[_0x331eb5(0x13b)]};}),'pagination':{'page':_0x96a524,'limit':_0x395af0,'total':_0x4afcd8,'totalPages':Math[_0x519947(0xb2)](_0x4afcd8/_0x395af0)}};}async[a48_0x5535f9(0x143)](_0x1327ef,_0x5c73ce){const _0x2fa526=a48_0x5535f9,_0x5cb1dc=await database_1[_0x2fa526(0xa4)][_0x2fa526(0xf3)]['findFirst']({'where':{'id':_0x5c73ce,'shopId':_0x1327ef},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x2fa526(0xac)},'take':0xa}}});if(!_0x5cb1dc)return null;const _0x144acb=_0x2fa526(0x120)+_0x5cb1dc['id'];return{'id':_0x5cb1dc['id'],'shopId':_0x5cb1dc[_0x2fa526(0xdd)],'gateway':_0x5cb1dc['gateway'],'amount':_0x5cb1dc[_0x2fa526(0x12f)],'currency':_0x5cb1dc['currency'],'sourceCurrency':_0x5cb1dc['sourceCurrency'],'usage':_0x5cb1dc['usage'],'expiresAt':_0x5cb1dc['expiresAt'],'redirectUrl':_0x144acb,'status':_0x5cb1dc[_0x2fa526(0x118)],'externalPaymentUrl':_0x5cb1dc[_0x2fa526(0x11f)],'customerEmail':_0x5cb1dc[_0x2fa526(0x84)],'customerName':_0x5cb1dc[_0x2fa526(0x113)],'country':_0x5cb1dc[_0x2fa526(0x9f)],'language':_0x5cb1dc[_0x2fa526(0xb0)],'amountIsEditable':_0x5cb1dc[_0x2fa526(0xe9)],'maxPayments':_0x5cb1dc['maxPayments'],'customer':_0x5cb1dc[_0x2fa526(0xde)],'createdAt':_0x5cb1dc[_0x2fa526(0x135)],'updatedAt':_0x5cb1dc['updatedAt'],'shop':_0x5cb1dc['shop'],'webhookLogs':_0x5cb1dc[_0x2fa526(0x78)]};}async[a48_0x5535f9(0xf6)](_0x80369b,_0x8ed06a,_0x2bd1dc){const _0x6dc0c6=a48_0x5535f9,_0x2b0107={..._0x2bd1dc};if(_0x2bd1dc[_0x6dc0c6(0x8f)]){if((0x0,gateway_1[_0x6dc0c6(0xdc)])(_0x2bd1dc['gateway'])){const _0x54300e=(0x0,gateway_1[_0x6dc0c6(0xbf)])(_0x2bd1dc['gateway']);_0x54300e&&(_0x2b0107[_0x6dc0c6(0x8f)]=_0x54300e);}else _0x2b0107[_0x6dc0c6(0x8f)]=_0x2bd1dc['gateway'][_0x6dc0c6(0x149)]();}const _0x49344b=await database_1['default'][_0x6dc0c6(0xf3)]['update']({'where':{'id':_0x8ed06a,'shopId':_0x80369b},'data':_0x2b0107,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x3f3f19='https://tesoft.uk/gateway/payment.php?id='+_0x49344b['id'];return{'id':_0x49344b['id'],'shopId':_0x49344b['shopId'],'gateway':_0x49344b[_0x6dc0c6(0x8f)],'amount':_0x49344b[_0x6dc0c6(0x12f)],'currency':_0x49344b[_0x6dc0c6(0x82)],'sourceCurrency':_0x49344b[_0x6dc0c6(0xdb)],'usage':_0x49344b[_0x6dc0c6(0xc4)],'expiresAt':_0x49344b[_0x6dc0c6(0x14d)],'redirectUrl':_0x3f3f19,'status':_0x49344b[_0x6dc0c6(0x118)],'externalPaymentUrl':_0x49344b[_0x6dc0c6(0x11f)],'customerEmail':_0x49344b[_0x6dc0c6(0x84)],'customerName':_0x49344b[_0x6dc0c6(0x113)],'country':_0x49344b[_0x6dc0c6(0x9f)],'language':_0x49344b['language'],'amountIsEditable':_0x49344b[_0x6dc0c6(0xe9)],'maxPayments':_0x49344b[_0x6dc0c6(0x99)],'customer':_0x49344b[_0x6dc0c6(0xde)],'createdAt':_0x49344b[_0x6dc0c6(0x135)],'updatedAt':_0x49344b[_0x6dc0c6(0x148)],'shop':_0x49344b['shop']};}async[a48_0x5535f9(0x11e)](_0x5c4054,_0x308480){const _0xd6e1b2=a48_0x5535f9;await database_1[_0xd6e1b2(0xa4)][_0xd6e1b2(0xf3)][_0xd6e1b2(0xd5)]({'where':{'id':_0x308480,'shopId':_0x5c4054}});}async['getPayouts'](_0x487080,_0x2cf122){const _0x252801=a48_0x5535f9,{page:_0x4fd9d0,limit:_0x57afe6,status:_0x1ef255,method:_0x39313a,dateFrom:_0x2b6fa8,dateTo:_0x32c825}=_0x2cf122,_0x4cbcc1=(_0x4fd9d0-0x1)*_0x57afe6,_0x18a6ed={'shopId':_0x487080};_0x1ef255&&(_0x18a6ed[_0x252801(0x118)]=_0x1ef255);_0x39313a&&(_0x18a6ed[_0x252801(0x9a)]=_0x39313a);(_0x2b6fa8||_0x32c825)&&(_0x18a6ed[_0x252801(0x135)]={},_0x2b6fa8&&(_0x18a6ed[_0x252801(0x135)][_0x252801(0xe3)]=new Date(_0x2b6fa8)),_0x32c825&&(_0x18a6ed[_0x252801(0x135)]['lte']=new Date(_0x32c825)));const [_0x570110,_0x28f843]=await Promise[_0x252801(0x10f)]([database_1[_0x252801(0xa4)][_0x252801(0xd7)][_0x252801(0xf5)]({'where':_0x18a6ed,'skip':_0x4cbcc1,'take':_0x57afe6,'orderBy':{'createdAt':_0x252801(0xac)}}),database_1['default'][_0x252801(0xd7)][_0x252801(0xab)]({'where':_0x18a6ed})]);return{'payouts':_0x570110[_0x252801(0x81)](_0x2fa7b8=>({'id':_0x2fa7b8['id'],'amount':_0x2fa7b8[_0x252801(0x12f)],'network':_0x2fa7b8[_0x252801(0x9a)],'status':_0x2fa7b8[_0x252801(0x118)],'txid':_0x2fa7b8[_0x252801(0xea)],'notes':_0x2fa7b8[_0x252801(0x13f)],'createdAt':_0x2fa7b8[_0x252801(0x135)],'paidAt':_0x2fa7b8[_0x252801(0xf8)]})),'pagination':{'page':_0x4fd9d0,'limit':_0x57afe6,'total':_0x28f843,'totalPages':Math[_0x252801(0xb2)](_0x28f843/_0x57afe6)}};}async['getPayoutById'](_0x36bf0c,_0x84e13b){const _0x3db2fc=a48_0x5535f9,_0x2d4dd4=await database_1[_0x3db2fc(0xa4)]['payout'][_0x3db2fc(0x85)]({'where':{'id':_0x84e13b,'shopId':_0x36bf0c},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2d4dd4)return null;return{'id':_0x2d4dd4['id'],'shopId':_0x2d4dd4[_0x3db2fc(0xdd)],'amount':_0x2d4dd4['amount'],'method':_0x2d4dd4[_0x3db2fc(0x9a)],'status':_0x2d4dd4[_0x3db2fc(0x118)],'txid':_0x2d4dd4[_0x3db2fc(0xea)],'createdAt':_0x2d4dd4[_0x3db2fc(0x135)],'paidAt':_0x2d4dd4[_0x3db2fc(0xf8)],'shop':_0x2d4dd4['shop']};}async[a48_0x5535f9(0xc1)](_0x41b4d8,_0x2ea35d){const _0xcdda11=a48_0x5535f9,_0x38bca2=this[_0xcdda11(0x7f)](_0x2ea35d),_0x4f8daf=new Date();_0x4f8daf[_0xcdda11(0x10e)](_0x4f8daf[_0xcdda11(0xd2)]()-_0x38bca2);const _0x3df6cb={'shopId':_0x41b4d8,'createdAt':{'gte':_0x4f8daf}},[_0x585f63,_0x5af752,_0x50016b,_0x531012,_0x371f4f,_0x1326bf,_0x2ec0d3,_0x5edad7]=await Promise[_0xcdda11(0x10f)]([database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0xab)]({'where':_0x3df6cb}),database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0xab)]({'where':{..._0x3df6cb,'status':_0xcdda11(0x14e)}}),database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0xab)]({'where':{..._0x3df6cb,'status':_0xcdda11(0xad)}}),database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0xab)]({'where':{..._0x3df6cb,'status':'REJECTED'}}),database_1['default']['payout'][_0xcdda11(0x80)]({'where':_0x3df6cb,'_sum':{'amount':!![]}}),database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0x13c)]({'by':[_0xcdda11(0x118)],'where':_0x3df6cb,'_count':{'status':!![]}}),database_1[_0xcdda11(0xa4)]['payout']['groupBy']({'by':[_0xcdda11(0x9a)],'where':_0x3df6cb,'_count':{'network':!![]}}),database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)][_0xcdda11(0xf5)]({'where':{'shopId':_0x41b4d8},'take':0xa,'orderBy':{'createdAt':_0xcdda11(0xac)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x401462=await database_1[_0xcdda11(0xa4)][_0xcdda11(0xd7)]['aggregate']({'where':{..._0x3df6cb,'status':_0xcdda11(0x14e)},'_sum':{'amount':!![]}}),_0x11f092=await database_1['default']['payout']['aggregate']({'where':{..._0x3df6cb,'status':_0xcdda11(0xad)},'_sum':{'amount':!![]}});return{'totalPayouts':_0x585f63,'completedPayouts':_0x5af752,'pendingPayouts':_0x50016b,'rejectedPayouts':_0x531012,'totalAmount':_0x371f4f[_0xcdda11(0x138)]['amount']||0x0,'completedAmount':_0x401462[_0xcdda11(0x138)][_0xcdda11(0x12f)]||0x0,'pendingAmount':_0x11f092[_0xcdda11(0x138)][_0xcdda11(0x12f)]||0x0,'payoutsByStatus':_0x1326bf[_0xcdda11(0xfc)]((_0x4af318,_0x1aa585)=>{const _0x1d7693=_0xcdda11;return _0x4af318[_0x1aa585[_0x1d7693(0x118)]]=_0x1aa585[_0x1d7693(0x96)][_0x1d7693(0x118)],_0x4af318;},{}),'payoutsByMethod':_0x2ec0d3[_0xcdda11(0xfc)]((_0x4ef535,_0x3efb26)=>{const _0xe8b991=_0xcdda11;return _0x4ef535[_0x3efb26['network']]=_0x3efb26[_0xe8b991(0x96)]['network'],_0x4ef535;},{}),'recentPayouts':_0x5edad7[_0xcdda11(0x81)](_0x54c3b9=>({'id':_0x54c3b9['id'],'shopId':_0x54c3b9[_0xcdda11(0xdd)],'amount':_0x54c3b9['amount'],'method':_0x54c3b9['network'],'status':_0x54c3b9[_0xcdda11(0x118)],'txid':_0x54c3b9[_0xcdda11(0xea)],'createdAt':_0x54c3b9[_0xcdda11(0x135)],'paidAt':_0x54c3b9[_0xcdda11(0xf8)],'shop':_0x54c3b9[_0xcdda11(0x13b)]}))};}async[a48_0x5535f9(0xd6)](_0x47a96c){const _0x5715e0=a48_0x5535f9;console[_0x5715e0(0x103)](_0x5715e0(0x83)+_0x47a96c);const _0x4da820=await database_1[_0x5715e0(0xa4)]['shop'][_0x5715e0(0xaf)]({'where':{'id':_0x47a96c},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x4da820)throw new Error(_0x5715e0(0x122));const _0x3fa91c=await database_1[_0x5715e0(0xa4)][_0x5715e0(0xf3)]['findMany']({'where':{'shopId':_0x47a96c,'status':_0x5715e0(0x7a)},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0x5715e0(0x103)](_0x5715e0(0x12e)+_0x3fa91c['length']+'\x20paid\x20payments\x20for\x20analysis');const _0x19312a=new Date(),_0x3a6c73=new Date(_0x19312a[_0x5715e0(0x86)](),_0x19312a[_0x5715e0(0xc9)](),0x1);let _0x10c967=0x0,_0x366d0a=0x0,_0x20ae0b=0x0,_0x43a122=0x0;for(const _0x5b0acc of _0x3fa91c){const _0x65a34a=await currencyService_1[_0x5715e0(0x10a)][_0x5715e0(0x10c)](_0x5b0acc['amount'],_0x5b0acc[_0x5715e0(0x82)]),_0x5c0fad=this[_0x5715e0(0x139)](_0x4da820,_0x5b0acc['gateway']),_0x4bfd25=this[_0x5715e0(0x104)](_0x65a34a,_0x5c0fad[_0x5715e0(0x132)]);_0x5b0acc[_0x5715e0(0x131)]&&(_0x10c967+=_0x4bfd25,_0x5b0acc[_0x5715e0(0xf8)]&&_0x5b0acc[_0x5715e0(0xf8)]>=_0x3a6c73&&(_0x20ae0b+=_0x4bfd25)),this[_0x5715e0(0x7b)](_0x5b0acc,_0x5c0fad)&&(_0x366d0a+=_0x4bfd25,_0x43a122+=_0x65a34a);}const _0x555ab5={'availableBalance':Math[_0x5715e0(0x154)](_0x43a122*0x64)/0x64,'totalPaidOut':Math[_0x5715e0(0x154)](_0x10c967*0x64)/0x64,'awaitingPayout':Math[_0x5715e0(0x154)](_0x366d0a*0x64)/0x64,'thisMonth':Math[_0x5715e0(0x154)](_0x20ae0b*0x64)/0x64};return console['log']('✅\x20Shop\x20payout\x20statistics\x20calculated:'),console['log'](_0x5715e0(0x12d)+_0x555ab5['availableBalance']+_0x5715e0(0xb7)),console[_0x5715e0(0x103)](_0x5715e0(0x146)+_0x555ab5['totalPaidOut']+_0x5715e0(0xb7)),console[_0x5715e0(0x103)](_0x5715e0(0x155)+_0x555ab5[_0x5715e0(0xe7)]+_0x5715e0(0xb7)),console[_0x5715e0(0x103)](_0x5715e0(0x9e)+_0x555ab5[_0x5715e0(0x92)]+_0x5715e0(0xb7)),_0x555ab5;}async[a48_0x5535f9(0xa2)](_0x1f5b6a){const _0x3a5a1c=a48_0x5535f9,_0xe5ab24=await this[_0x3a5a1c(0xd6)](_0x1f5b6a);return{'totalBalance':_0xe5ab24[_0x3a5a1c(0x102)],'totalPaidOut':_0xe5ab24[_0x3a5a1c(0xae)],'awaitingPayout':_0xe5ab24['awaitingPayout'],'thisMonth':_0xe5ab24[_0x3a5a1c(0x92)]};}async[a48_0x5535f9(0xe1)](_0x37b4af,_0x1dab9f){const _0x3c8ab3=a48_0x5535f9,{page:_0x2512ee,limit:_0xe6f9ba,paymentId:_0x1bdf0c}=_0x1dab9f,_0x196276=(_0x2512ee-0x1)*_0xe6f9ba,_0x2d2594={'shopId':_0x37b4af};_0x1bdf0c&&(_0x2d2594[_0x3c8ab3(0x8e)]=_0x1bdf0c);const [_0x2114bb,_0x1c8b2a]=await Promise['all']([database_1['default']['webhookLog'][_0x3c8ab3(0xf5)]({'where':_0x2d2594,'skip':_0x196276,'take':_0xe6f9ba,'orderBy':{'createdAt':_0x3c8ab3(0xac)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x3c8ab3(0xa4)][_0x3c8ab3(0x110)][_0x3c8ab3(0xab)]({'where':_0x2d2594})]);return{'logs':_0x2114bb[_0x3c8ab3(0x81)](_0x67ef65=>({'id':_0x67ef65['id'],'paymentId':_0x67ef65[_0x3c8ab3(0x8e)],'shopId':_0x67ef65[_0x3c8ab3(0xdd)],'event':_0x67ef65['event'],'statusCode':_0x67ef65[_0x3c8ab3(0x14c)],'retryCount':_0x67ef65['retryCount'],'responseBody':_0x67ef65[_0x3c8ab3(0x119)],'createdAt':_0x67ef65[_0x3c8ab3(0x135)],'payment':_0x67ef65[_0x3c8ab3(0xf3)]})),'pagination':{'page':_0x2512ee,'limit':_0xe6f9ba,'total':_0x1c8b2a,'totalPages':Math[_0x3c8ab3(0xb2)](_0x1c8b2a/_0xe6f9ba)}};}async['getStatistics'](_0x67c139,_0x6a9cf9){const _0x4c84a0=a48_0x5535f9,_0x420cb3=this['getPeriodDays'](_0x6a9cf9),_0x125caf=new Date();_0x125caf['setDate'](_0x125caf[_0x4c84a0(0xd2)]()-_0x420cb3),console['log'](_0x4c84a0(0xf7)+_0x6a9cf9+'\x20('+_0x420cb3+'\x20days)');const _0x3d090d={'shopId':_0x67c139,'createdAt':{'gte':_0x125caf}},_0x527005=await database_1['default'][_0x4c84a0(0x13b)][_0x4c84a0(0xaf)]({'where':{'id':_0x67c139},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x527005)throw new Error('Shop\x20not\x20found');const [_0x157921,_0x46c30d,_0x44e540,_0x2a0213,_0x4cdb14,_0x610281,_0x3d2d5e,_0x3af8d1]=await Promise[_0x4c84a0(0x10f)]([database_1['default'][_0x4c84a0(0xf3)][_0x4c84a0(0xab)]({'where':_0x3d090d}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)][_0x4c84a0(0xab)]({'where':{..._0x3d090d,'status':_0x4c84a0(0x7a)}}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)][_0x4c84a0(0xf5)]({'where':_0x3d090d,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)]['findMany']({'where':{..._0x3d090d,'status':'PAID'},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)][_0x4c84a0(0x13c)]({'by':[_0x4c84a0(0x118)],'where':_0x3d090d,'_count':{'status':!![]}}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)][_0x4c84a0(0x13c)]({'by':[_0x4c84a0(0x8f)],'where':_0x3d090d,'_count':{'gateway':!![]}}),database_1[_0x4c84a0(0xa4)][_0x4c84a0(0xf3)][_0x4c84a0(0xf5)]({'where':{'shopId':_0x67c139},'take':0xa,'orderBy':{'createdAt':_0x4c84a0(0xac)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1[_0x4c84a0(0xa4)][_0x4c84a0(0x10b)]`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x67c139} 
          AND created_at >= ${_0x125caf}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console['log'](_0x4c84a0(0x12e)+_0x2a0213[_0x4c84a0(0xf9)]+_0x4c84a0(0xe8));const _0x14ff5b=await Promise[_0x4c84a0(0x10f)](_0x2a0213['map'](async _0x2ed1d9=>{const _0x41a298=_0x4c84a0,_0x2c46d5=await currencyService_1['currencyService'][_0x41a298(0x10c)](_0x2ed1d9[_0x41a298(0x12f)],_0x2ed1d9['currency']),_0x5773e0=this[_0x41a298(0x139)](_0x527005,_0x2ed1d9[_0x41a298(0x8f)]),_0x5bc91b=this[_0x41a298(0x104)](_0x2c46d5,_0x5773e0[_0x41a298(0x132)]);return _0x5bc91b;})),_0x35a046=await Promise[_0x4c84a0(0x10f)](_0x44e540[_0x4c84a0(0x81)](async _0x514ba4=>{const _0x577134=await currencyService_1['currencyService']['convertToUSDT'](_0x514ba4['amount'],_0x514ba4['currency']);return{'amount':_0x577134,'status':_0x514ba4['status']};})),_0x15f168=_0x14ff5b[_0x4c84a0(0xfc)]((_0x1fe5ef,_0x13e12a)=>_0x1fe5ef+_0x13e12a,0x0),_0x39dadd=_0x157921>0x0?_0x35a046[_0x4c84a0(0xfc)]((_0x3be4bd,_0x534fd0)=>_0x3be4bd+_0x534fd0[_0x4c84a0(0x12f)],0x0)/_0x157921:0x0;console[_0x4c84a0(0x103)](_0x4c84a0(0x109)+_0x15f168[_0x4c84a0(0x127)](0x2)+_0x4c84a0(0xb7)),console['log'](_0x4c84a0(0xb3)+_0x39dadd['toFixed'](0x2)+'\x20USDT');const _0x3db640=this[_0x4c84a0(0xcd)](_0x125caf,new Date()),_0x2d9c92=await Promise[_0x4c84a0(0x10f)](_0x3af8d1[_0x4c84a0(0x81)](async _0x2e56f9=>{const _0x35f4c1=_0x4c84a0,_0xe72c35=_0x2e56f9[_0x35f4c1(0xcf)][_0x35f4c1(0xd8)](_0x5c82d4=>_0x5c82d4[_0x35f4c1(0x118)]==='PAID'),_0x4c71c3=await Promise[_0x35f4c1(0x10f)](_0xe72c35[_0x35f4c1(0x81)](async _0x2c2977=>{const _0x362868=_0x35f4c1,_0x31f6a4=await currencyService_1[_0x362868(0x10a)][_0x362868(0x10c)](_0x2c2977[_0x362868(0x12f)],_0x2c2977[_0x362868(0x82)]),_0x5ec24b=this[_0x362868(0x139)](_0x527005,_0x2c2977['gateway']),_0x429b6b=this[_0x362868(0x104)](_0x31f6a4,_0x5ec24b['commission']);return _0x429b6b;})),_0x101545=_0x4c71c3[_0x35f4c1(0xfc)]((_0x3d8a4d,_0x1a1134)=>_0x3d8a4d+_0x1a1134,0x0);return{'date':_0x2e56f9[_0x35f4c1(0x8d)][_0x35f4c1(0xa1)]()['split']('T')[0x0],'count':_0x2e56f9[_0x35f4c1(0xab)],'revenue':_0x101545};})),_0x4fcb5=new Map(_0x2d9c92['map'](_0x5f4627=>[_0x5f4627[_0x4c84a0(0x8d)],{'count':_0x5f4627[_0x4c84a0(0xab)],'revenue':_0x5f4627['revenue']}])),_0x23f8bd=_0x3db640['map'](_0x59dc30=>({'date':_0x59dc30,'amount':_0x4fcb5[_0x4c84a0(0x91)](_0x59dc30)?.[_0x4c84a0(0x157)]||0x0})),_0x1e583c=_0x3db640['map'](_0x150186=>({'date':_0x150186,'count':_0x4fcb5[_0x4c84a0(0x91)](_0x150186)?.[_0x4c84a0(0xab)]||0x0}));return console['log'](_0x4c84a0(0xbd)),console[_0x4c84a0(0x103)]('💳\x20Total\x20payments:\x20'+_0x157921),console[_0x4c84a0(0x103)](_0x4c84a0(0xeb)+_0x46c30d),console[_0x4c84a0(0x103)](_0x4c84a0(0xf1)+_0x23f8bd[_0x4c84a0(0xf9)]),{'totalPayments':_0x157921,'successfulPayments':_0x46c30d,'totalAmount':Math[_0x4c84a0(0x154)](_0x15f168*0x64)/0x64,'averageAmount':Math[_0x4c84a0(0x154)](_0x39dadd*0x64)/0x64,'paymentsByStatus':_0x4cdb14[_0x4c84a0(0xfc)]((_0x1a1514,_0x3de455)=>{const _0x52230f=_0x4c84a0;return _0x1a1514[_0x3de455[_0x52230f(0x118)]]=_0x3de455[_0x52230f(0x96)][_0x52230f(0x118)],_0x1a1514;},{}),'paymentsByGateway':_0x610281['reduce']((_0x117c93,_0x38bf01)=>{const _0x1c7a9c=_0x4c84a0;return _0x117c93[_0x38bf01[_0x1c7a9c(0x8f)]]=_0x38bf01[_0x1c7a9c(0x96)]['gateway'],_0x117c93;},{}),'recentPayments':_0x3d2d5e[_0x4c84a0(0x81)](_0x130567=>{const _0x2ba426=_0x4c84a0,_0x53d0ab=_0x2ba426(0x120)+_0x130567['id'];return{'id':_0x130567['id'],'shopId':_0x130567['shopId'],'gateway':_0x130567[_0x2ba426(0x8f)],'amount':_0x130567['amount'],'currency':_0x130567[_0x2ba426(0x82)],'sourceCurrency':_0x130567['sourceCurrency'],'usage':_0x130567[_0x2ba426(0xc4)],'expiresAt':_0x130567[_0x2ba426(0x14d)],'redirectUrl':_0x53d0ab,'status':_0x130567[_0x2ba426(0x118)],'externalPaymentUrl':_0x130567[_0x2ba426(0x11f)],'customerEmail':_0x130567['customerEmail'],'customerName':_0x130567[_0x2ba426(0x113)],'country':_0x130567[_0x2ba426(0x9f)],'language':_0x130567[_0x2ba426(0xb0)],'amountIsEditable':_0x130567[_0x2ba426(0xe9)],'maxPayments':_0x130567[_0x2ba426(0x99)],'customer':_0x130567[_0x2ba426(0xde)],'createdAt':_0x130567['createdAt'],'updatedAt':_0x130567[_0x2ba426(0x148)],'shop':_0x130567[_0x2ba426(0x13b)]};}),'dailyRevenue':_0x23f8bd,'dailyPayments':_0x1e583c};}[a48_0x5535f9(0x7f)](_0x3634a8){const _0x3d56e6=a48_0x5535f9;switch(_0x3634a8){case'7d':return 0x7;case _0x3d56e6(0x142):return 0x1e;case _0x3d56e6(0x13e):return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a48_0x5535f9(0xcd)](_0x228182,_0x519b2d){const _0x223803=a48_0x5535f9,_0x530541=[],_0x10814d=new Date(_0x228182);while(_0x10814d<=_0x519b2d){_0x530541[_0x223803(0x112)](_0x10814d[_0x223803(0xa1)]()[_0x223803(0xb4)]('T')[0x0]),_0x10814d[_0x223803(0x10e)](_0x10814d[_0x223803(0xd2)]()+0x1);}return _0x530541;}}exports['ShopService']=ShopService;