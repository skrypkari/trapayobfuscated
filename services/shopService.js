'use strict';const a48_0x27d12b=a48_0x16f6;(function(_0x30f705,_0xcb41b0){const _0x1ed8cb=a48_0x16f6,_0xba3c85=_0x30f705();while(!![]){try{const _0x4b6d90=parseInt(_0x1ed8cb(0xe9))/0x1*(-parseInt(_0x1ed8cb(0x118))/0x2)+-parseInt(_0x1ed8cb(0xc2))/0x3*(-parseInt(_0x1ed8cb(0x18e))/0x4)+parseInt(_0x1ed8cb(0x135))/0x5*(parseInt(_0x1ed8cb(0xf6))/0x6)+parseInt(_0x1ed8cb(0x150))/0x7+-parseInt(_0x1ed8cb(0xda))/0x8+parseInt(_0x1ed8cb(0xf9))/0x9+-parseInt(_0x1ed8cb(0xd5))/0xa;if(_0x4b6d90===_0xcb41b0)break;else _0xba3c85['push'](_0xba3c85['shift']());}catch(_0x58ff8c){_0xba3c85['push'](_0xba3c85['shift']());}}}(a48_0x41bd,0xb3a85));function a48_0x16f6(_0x58dad3,_0x32b30a){const _0x41bd6b=a48_0x41bd();return a48_0x16f6=function(_0x16f68d,_0x509612){_0x16f68d=_0x16f68d-0xa9;let _0x389e58=_0x41bd6b[_0x16f68d];return _0x389e58;},a48_0x16f6(_0x58dad3,_0x32b30a);}function a48_0x41bd(){const _0x20e181=['\x20\x20\x20✅\x20Success:\x20','./gateways/nodaService','rapyd','parse','commission','log','💳\x20Creating\x20KLYME\x20','getPayoutStats','shopUrl','calculateAmountAfterCommission','📊\x20Daily\x20revenue\x20entries:\x20','groupBy','HTTP\x20','getGatewaySettings','getStatistics','EUR','updatePayment','ShopService','payment_url','round','plisio','usdtPolygonWallet','paymentGateways','/payment/success?id=','toString','noda','Invalid\x20KLYME\x20gateway:\x20','ceil','getPayouts','✅\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20','true','customer','\x20days)','customerEmail','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','../types/gateway','getKlymeRegionFromGatewayName','usdcPolygonWallet','Shop\x20not\x20found','getPayoutById','RapydService','nodaService','telegramId','\x20USDT','qr_code','merchantUrl','generateDateRange','floor','198532zkjwAN','gatewaySettings','\x20\x20\x20❌\x20Fail:\x20','reduce','\x20(8digits-8digits\x20format)','💰\x20Amount:\x20','PlisioService','🔄\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20','all','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','date','getDate','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','isValidGatewayId','klyme_','desc','PAID','getPaymentById','delete','toFixed','aggregate','startsWith','💰\x20Available\x20Balance:\x20','txid','thisMonth','getPeriodDays','🔗\x20Generated\x20URLs\x20for\x20','test@example.com','📈\x20Average\x20payment:\x20','maxPayments','__importDefault','9VKGZtM','plisioService','paid','network','stringify','USD','invoice_total_sum','currencyService','KlymeService','gte','💰\x20Found\x20','getMonth','telegram','Order\x20ID:\x20','create','Unknown\x20error','get','error','https://tesoft.uk','18902020lwaoNz','toLowerCase','🧪\x20Sending\x20test\x20webhook\x20to:\x20','NodaService','✅\x20Shop\x20statistics\x20generated\x20successfully','2009408FqfeDh','webhookLog','convertToUSDT','https://tesoft.uk/gateway/payment.php?id=','usdtTrcWallet','⚠️\x20Gateway\x20order\x20ID\x20','filter','test_payment_','expiresAt','PENDING','💾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20','30d','⏳\x20Awaiting\x20Payout:\x20','generateGatewayOrderId','name','1789TcnzBB','shop','🔄\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','🎯\x20Generated\x20unique\x20gateway\x20order_id:\x20','📊\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','/payment/pending?id=','padStart','fullName','createPaymentLink','/payment/failed?id=','gateways','default','getShopPayoutStats','78ufdueJ','rapydCustomer','🪙\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','12368124faKaoI','language','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','✅\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','amountIsEditable','username','_count','webhookUrl','💸\x20Total\x20Paid\x20Out:\x20','cointopay','update','getPayoutStatistics','gateway_payment_id','Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts','90d','✅\x20Successful\x20payments:\x20','$queryRaw','Gateway\x20not\x20found\x20for\x20ID:\x20','\x20paid\x20payments\x20for\x20analysis','❌\x20Test\x20webhook\x20error:\x20','qr_url','length','__esModule','isEligibleForPayout','getGatewayNameById','redirectUrl','Test\x20payload:','usdtErcWallet','webhookLogs','findFirst','customerName','786idFowq','paidAt','awaitingPayout','klymeService','generateGatewayUrls','push','REJECTED','✅\x20KLYME\x20','deletePayment','📅\x20This\x20Month:\x20','map','toISOString','publicKey','gatewayPaymentId','country','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','gateway','getShopProfile','status','updatedAt','payout','Test\x20Customer','findMany','✅\x20Shop\x20payout\x20statistics\x20calculated:','payments','application/json','Failed\x20to\x20log\x20test\x20webhook:','usage','externalPaymentUrl','399820TsWboD','shopId','ONCE','💵\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','notes','statusCode','_sum','currency','merchantPaid','wallets','✅\x20Test\x20webhook\x20sent\x20successfully:\x20','setDate','availableBalance','test_webhook','payment','coinToPayService','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','./gateways/rapydService','BASE_URL','createdAt','count','now','payoutDelay','FAILED','createPayment','rapydService','revenue','7123655uJDVoX','split','amount','getTime','payment.success','COMPLETED','sourceCurrency','../config/database','retryCount','paymentId','testWebhook','toUpperCase','findUnique'];a48_0x41bd=function(){return _0x20e181;};return a48_0x41bd();}var __importDefault=this&&this[a48_0x27d12b(0xc1)]||function(_0x9d3e8c){const _0x3e329c=a48_0x27d12b;return _0x9d3e8c&&_0x9d3e8c[_0x3e329c(0x10f)]?_0x9d3e8c:{'default':_0x9d3e8c};};Object['defineProperty'](exports,a48_0x27d12b(0x10f),{'value':!![]}),exports[a48_0x27d12b(0x16e)]=void 0x0;const database_1=__importDefault(require(a48_0x27d12b(0x157))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a48_0x27d12b(0x146)),nodaService_1=require(a48_0x27d12b(0x15e)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require('./gateways/klymeService'),currencyService_1=require('./currencyService'),gateway_1=require(a48_0x27d12b(0x181));class ShopService{constructor(){const _0x3cbc75=a48_0x27d12b;this['plisioService']=new plisioService_1[(_0x3cbc75(0xa9))](),this[_0x3cbc75(0x14e)]=new rapydService_1[(_0x3cbc75(0x186))](),this[_0x3cbc75(0x187)]=new nodaService_1[(_0x3cbc75(0xd8))](),this[_0x3cbc75(0x144)]=new coinToPayService_1['CoinToPayService'](),this[_0x3cbc75(0x11b)]=new klymeService_1[(_0x3cbc75(0xca))]();}async[a48_0x27d12b(0xe7)](){const _0x2862c4=a48_0x27d12b;let _0x1935d0,_0x1acef3=0x0;const _0x7f9bea=0xa;do{const _0x317366=()=>{const _0x3b0da5=a48_0x16f6;return Math[_0x3b0da5(0x18d)](Math['random']()*0x5f5e100)[_0x3b0da5(0x175)]()[_0x3b0da5(0xef)](0x8,'0');};_0x1935d0=_0x317366()+'-'+_0x317366();const _0x13be08=await database_1[_0x2862c4(0xf4)][_0x2862c4(0x143)]['findFirst']({'where':{'gatewayOrderId':_0x1935d0}});if(!_0x13be08)break;_0x1acef3++,console[_0x2862c4(0x162)](_0x2862c4(0xdf)+_0x1935d0+_0x2862c4(0x145)+_0x1acef3+')');}while(_0x1acef3<_0x7f9bea);if(_0x1acef3>=_0x7f9bea)throw new Error(_0x2862c4(0x106));return _0x1935d0;}[a48_0x27d12b(0x11c)](_0x5229b2,_0x224f9f,_0x53ee3a,_0xa68358,_0x178059){const _0x157c15=a48_0x27d12b;if(_0xa68358&&_0x178059)return{'finalSuccessUrl':_0xa68358,'finalFailUrl':_0x178059};let _0x260656,_0x453748;return _0x5229b2===_0x157c15(0x176)||_0x5229b2['startsWith'](_0x157c15(0xb1))||_0x5229b2===_0x157c15(0x102)?_0x260656=_0xa68358||_0x53ee3a+_0x157c15(0xee)+_0x224f9f:_0x260656=_0xa68358||_0x53ee3a+_0x157c15(0x174)+_0x224f9f,_0x453748=_0x178059||_0x53ee3a+_0x157c15(0xf2)+_0x224f9f,console[_0x157c15(0x162)](_0x157c15(0xbd)+_0x5229b2+':'),console[_0x157c15(0x162)](_0x157c15(0x15d)+_0x260656),console[_0x157c15(0x162)](_0x157c15(0x190)+_0x453748),{'finalSuccessUrl':_0x260656,'finalFailUrl':_0x453748};}[a48_0x27d12b(0x16a)](_0x2f5200,_0x10e359){const _0x30b4a0=a48_0x27d12b,_0x553a95=_0x2f5200[_0x30b4a0(0x18f)]?JSON[_0x30b4a0(0x160)](_0x2f5200[_0x30b4a0(0x18f)]):null,_0x1bac21=_0x10e359['charAt'](0x0)[_0x30b4a0(0x15b)]()+_0x10e359['slice'](0x1)[_0x30b4a0(0xd6)]();if(_0x553a95&&_0x553a95[_0x1bac21])return{'commission':_0x553a95[_0x1bac21][_0x30b4a0(0x161)],'payoutDelay':_0x553a95[_0x1bac21][_0x30b4a0(0x14b)]};return{'commission':0x0,'payoutDelay':0x0};}[a48_0x27d12b(0x110)](_0x423906,_0x3ccd08){const _0xf710b4=a48_0x27d12b;if(_0x423906[_0xf710b4(0x12a)]!=='PAID'||_0x423906[_0xf710b4(0x13d)]||!_0x423906[_0xf710b4(0x119)])return![];const _0x3a2cb6=_0x3ccd08[_0xf710b4(0x14b)]*0x18*0x3c*0x3c*0x3e8,_0x3dfce1=new Date(_0x423906[_0xf710b4(0x119)][_0xf710b4(0x153)]()+_0x3a2cb6);return new Date()>_0x3dfce1;}[a48_0x27d12b(0x166)](_0xaf4fea,_0x17b85e){return _0xaf4fea*(0x1-_0x17b85e/0x64);}async[a48_0x27d12b(0x129)](_0x202c36){const _0x55fc22=a48_0x27d12b,_0x529a62=await database_1['default']['shop'][_0x55fc22(0x15c)]({'where':{'id':_0x202c36},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x529a62)throw new Error(_0x55fc22(0x184));return{'id':_0x529a62['id'],'fullName':_0x529a62[_0x55fc22(0xe8)],'username':_0x529a62['username'],'telegramId':_0x529a62[_0x55fc22(0xce)],'merchantUrl':_0x529a62['shopUrl'],'gateways':_0x529a62[_0x55fc22(0x173)]?JSON['parse'](_0x529a62[_0x55fc22(0x173)]):null,'gatewaySettings':_0x529a62['gatewaySettings']?JSON[_0x55fc22(0x160)](_0x529a62['gatewaySettings']):null,'publicKey':_0x529a62[_0x55fc22(0x124)],'wallets':{'usdtPolygonWallet':_0x529a62[_0x55fc22(0x172)],'usdtTrcWallet':_0x529a62[_0x55fc22(0xde)],'usdtErcWallet':_0x529a62['usdtErcWallet'],'usdcPolygonWallet':_0x529a62[_0x55fc22(0x183)]},'status':_0x529a62[_0x55fc22(0x12a)],'createdAt':_0x529a62['createdAt']};}async['updateShopProfile'](_0x293285,_0x37fb37){const _0x75a085=a48_0x27d12b,_0x54dd01={..._0x37fb37};_0x37fb37[_0x75a085(0xf0)]&&(_0x54dd01[_0x75a085(0xe8)]=_0x37fb37[_0x75a085(0xf0)],delete _0x54dd01[_0x75a085(0xf0)]);_0x37fb37['telegramId']&&(_0x54dd01[_0x75a085(0xce)]=_0x37fb37[_0x75a085(0x188)],delete _0x54dd01[_0x75a085(0x188)]);_0x37fb37[_0x75a085(0x18b)]&&(_0x54dd01[_0x75a085(0x165)]=_0x37fb37[_0x75a085(0x18b)],delete _0x54dd01[_0x75a085(0x18b)]);_0x37fb37[_0x75a085(0xf3)]&&(_0x54dd01[_0x75a085(0x173)]=JSON[_0x75a085(0xc6)](_0x37fb37[_0x75a085(0xf3)]),delete _0x54dd01[_0x75a085(0xf3)]);_0x37fb37[_0x75a085(0x18f)]&&(_0x54dd01[_0x75a085(0x18f)]=JSON[_0x75a085(0xc6)](_0x37fb37[_0x75a085(0x18f)]),delete _0x54dd01['gatewaySettings']);_0x37fb37[_0x75a085(0x13e)]&&(_0x37fb37['wallets'][_0x75a085(0x172)]!==undefined&&(_0x54dd01[_0x75a085(0x172)]=_0x37fb37[_0x75a085(0x13e)][_0x75a085(0x172)]||null),_0x37fb37['wallets'][_0x75a085(0xde)]!==undefined&&(_0x54dd01[_0x75a085(0xde)]=_0x37fb37[_0x75a085(0x13e)][_0x75a085(0xde)]||null),_0x37fb37[_0x75a085(0x13e)][_0x75a085(0x114)]!==undefined&&(_0x54dd01[_0x75a085(0x114)]=_0x37fb37[_0x75a085(0x13e)][_0x75a085(0x114)]||null),_0x37fb37[_0x75a085(0x13e)][_0x75a085(0x183)]!==undefined&&(_0x54dd01['usdcPolygonWallet']=_0x37fb37[_0x75a085(0x13e)][_0x75a085(0x183)]||null),delete _0x54dd01[_0x75a085(0x13e)]);const _0x1894eb=await database_1['default'][_0x75a085(0xea)]['update']({'where':{'id':_0x293285},'data':_0x54dd01,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x1894eb['id'],'fullName':_0x1894eb['name'],'username':_0x1894eb[_0x75a085(0xfe)],'telegramId':_0x1894eb[_0x75a085(0xce)],'merchantUrl':_0x1894eb['shopUrl'],'gateways':_0x1894eb[_0x75a085(0x173)]?JSON['parse'](_0x1894eb[_0x75a085(0x173)]):null,'gatewaySettings':_0x1894eb[_0x75a085(0x18f)]?JSON[_0x75a085(0x160)](_0x1894eb[_0x75a085(0x18f)]):null,'publicKey':_0x1894eb[_0x75a085(0x124)],'wallets':{'usdtPolygonWallet':_0x1894eb[_0x75a085(0x172)],'usdtTrcWallet':_0x1894eb['usdtTrcWallet'],'usdtErcWallet':_0x1894eb[_0x75a085(0x114)],'usdcPolygonWallet':_0x1894eb[_0x75a085(0x183)]},'status':_0x1894eb['status'],'createdAt':_0x1894eb[_0x75a085(0x148)]};}async['updateWallets'](_0x2b62dd,_0x23a948){const _0x517110=a48_0x27d12b,_0x2bc1ef={};_0x23a948[_0x517110(0x172)]!==undefined&&(_0x2bc1ef[_0x517110(0x172)]=_0x23a948['usdtPolygonWallet']||null),_0x23a948[_0x517110(0xde)]!==undefined&&(_0x2bc1ef[_0x517110(0xde)]=_0x23a948[_0x517110(0xde)]||null),_0x23a948['usdtErcWallet']!==undefined&&(_0x2bc1ef['usdtErcWallet']=_0x23a948[_0x517110(0x114)]||null),_0x23a948[_0x517110(0x183)]!==undefined&&(_0x2bc1ef[_0x517110(0x183)]=_0x23a948[_0x517110(0x183)]||null),await database_1[_0x517110(0xf4)]['shop'][_0x517110(0x103)]({'where':{'id':_0x2b62dd},'data':_0x2bc1ef});}async[a48_0x27d12b(0x15a)](_0x3b8868){const _0xeaa2ef=a48_0x27d12b,_0x395c03=await database_1['default']['shop'][_0xeaa2ef(0x15c)]({'where':{'id':_0x3b8868},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x395c03)throw new Error(_0xeaa2ef(0x184));const _0x5bd781=_0x395c03['settings']?.[_0xeaa2ef(0x100)];if(!_0x5bd781)throw new Error('No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.');const _0xa7917c=await this['generateGatewayOrderId'](),_0x4f7029={'event':_0xeaa2ef(0x154),'payment':{'id':_0xeaa2ef(0xe1)+Date[_0xeaa2ef(0x14a)](),'order_id':null,'gateway_order_id':_0xa7917c,'gateway':_0xeaa2ef(0x171),'amount':0x64,'currency':_0xeaa2ef(0xc7),'status':_0xeaa2ef(0xc4),'customer_email':_0xeaa2ef(0xbe),'customer_name':_0xeaa2ef(0x12d),'created_at':new Date()[_0xeaa2ef(0x123)](),'updated_at':new Date()[_0xeaa2ef(0x123)]()},'test':!![],'shop':{'id':_0x395c03['id'],'name':_0x395c03[_0xeaa2ef(0xe8)]},'timestamp':new Date()[_0xeaa2ef(0x123)]()},_0x176e27=Date[_0xeaa2ef(0x14a)]();let _0x316c48=0x0,_0x1bf96d=![],_0x1a9965;try{console['log'](_0xeaa2ef(0xd7)+_0x5bd781),console['log'](_0xeaa2ef(0x113),JSON[_0xeaa2ef(0xc6)](_0x4f7029,null,0x2));const _0x13465d=await fetch(_0x5bd781,{'method':'POST','headers':{'Content-Type':_0xeaa2ef(0x131),'User-Agent':_0xeaa2ef(0xfb),'X-Webhook-Test':_0xeaa2ef(0x17c)},'body':JSON['stringify'](_0x4f7029)});_0x316c48=_0x13465d[_0xeaa2ef(0x12a)],_0x1bf96d=_0x13465d['ok'];if(!_0x13465d['ok']){const _0xabd01e=await _0x13465d['text']();_0x1a9965=_0xeaa2ef(0x169)+_0x13465d[_0xeaa2ef(0x12a)]+':\x20'+_0xabd01e,console['error']('❌\x20Test\x20webhook\x20failed:\x20'+_0x1a9965);}else console['log'](_0xeaa2ef(0x13f)+_0x13465d[_0xeaa2ef(0x12a)]);}catch(_0x1feaed){_0x1a9965=_0x1feaed instanceof Error?_0x1feaed['message']:_0xeaa2ef(0xd1),console[_0xeaa2ef(0xd3)](_0xeaa2ef(0x10c)+_0x1a9965);}const _0xece4f8=Date['now']()-_0x176e27;try{await database_1['default']['webhookLog'][_0xeaa2ef(0xd0)]({'data':{'paymentId':_0xeaa2ef(0x142),'shopId':_0x395c03['id'],'event':_0xeaa2ef(0x142),'statusCode':_0x316c48,'responseBody':JSON[_0xeaa2ef(0xc6)]({'success':_0x1bf96d,'error':_0x1a9965,'responseTime':_0xece4f8,'testPayload':_0x4f7029})}});}catch(_0x29a13e){console[_0xeaa2ef(0xd3)](_0xeaa2ef(0x132),_0x29a13e);}return{'webhookUrl':_0x5bd781,'statusCode':_0x316c48,'responseTime':_0xece4f8,'success':_0x1bf96d,'error':_0x1a9965};}async['createPayment'](_0x2a26f2){const _0x2118a=a48_0x27d12b;let _0x18c171;if((0x0,gateway_1['isValidGatewayId'])(_0x2a26f2[_0x2118a(0x128)])){const _0x4f42c7=(0x0,gateway_1[_0x2118a(0x111)])(_0x2a26f2[_0x2118a(0x128)]);if(!_0x4f42c7)throw new Error(_0x2118a(0x10a)+_0x2a26f2[_0x2118a(0x128)]);_0x18c171=_0x4f42c7;}else _0x18c171=_0x2a26f2[_0x2118a(0x128)][_0x2118a(0xd6)]();console[_0x2118a(0x162)](_0x2118a(0xaa)+_0x18c171);const _0x40509b=await this[_0x2118a(0xe7)]();console[_0x2118a(0x162)](_0x2118a(0xec)+_0x40509b+'\x20(8digits-8digits\x20format\x20for\x20'+_0x18c171+')');const _0x28399b=await database_1[_0x2118a(0xf4)][_0x2118a(0xea)][_0x2118a(0x15c)]({'where':{'id':_0x2a26f2[_0x2118a(0x136)]},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x28399b)throw new Error(_0x2118a(0x184));const _0x5e6f03=this[_0x2118a(0x16a)](_0x28399b,_0x18c171),_0xb4c83b=process['env'][_0x2118a(0x147)]||_0x2118a(0xd4),{finalSuccessUrl:_0x5dfe92,finalFailUrl:_0x4a337b}=this['generateGatewayUrls'](_0x18c171,_0x40509b,_0xb4c83b,_0x2a26f2[_0x2118a(0x112)],undefined),_0x537c4d=await database_1[_0x2118a(0xf4)][_0x2118a(0x143)][_0x2118a(0xd0)]({'data':{'shopId':_0x2a26f2['shopId'],'gateway':_0x18c171,'amount':_0x2a26f2['amount'],'currency':_0x2a26f2[_0x2118a(0x13c)]||'USD','sourceCurrency':_0x2a26f2[_0x2118a(0x156)]||null,'usage':_0x2a26f2[_0x2118a(0x133)]||_0x2118a(0x137),'expiresAt':_0x2a26f2['expiresAt'],'successUrl':_0x5dfe92,'failUrl':_0x4a337b,'status':_0x2118a(0xe3),'orderId':null,'gatewayOrderId':_0x40509b,'customerEmail':_0x2a26f2[_0x2118a(0x17f)]||null,'customerName':_0x2a26f2['customerName']||null,'country':_0x2a26f2['country']||null,'language':_0x2a26f2[_0x2118a(0xfa)]||null,'amountIsEditable':_0x2a26f2[_0x2118a(0xfd)]||null,'maxPayments':_0x2a26f2['maxPayments']||null,'rapydCustomer':_0x2a26f2[_0x2118a(0x17d)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console['log'](_0x2118a(0xe4)+_0x40509b+_0x2118a(0x192));let _0x261ad5;try{if(_0x18c171===_0x2118a(0x171)){let _0x518c15,_0x3685c0,_0x440711;_0x2a26f2[_0x2118a(0x156)]?(_0x518c15=_0x2a26f2['sourceCurrency'],_0x3685c0=_0x2a26f2[_0x2118a(0x13c)]||_0x2118a(0xc7),_0x440711=![]):(_0x518c15=_0x2118a(0xc7),_0x3685c0=_0x2a26f2[_0x2118a(0x13c)]||_0x2118a(0xc7),_0x440711=!![]);const _0x4b1a34=await this[_0x2118a(0xc3)][_0x2118a(0x14d)]({'paymentId':_0x537c4d['id'],'orderId':_0x40509b,'amount':_0x2a26f2[_0x2118a(0x152)],'currency':_0x518c15,'productName':_0x2118a(0xcf)+_0x40509b,'description':'Order\x20ID:\x20'+_0x40509b,'successUrl':_0x5dfe92,'failUrl':_0x4a337b,'customerEmail':_0x2a26f2[_0x2118a(0x17f)],'customerName':_0x2a26f2[_0x2118a(0x117)],'isSourceCurrency':_0x440711});_0x261ad5=_0x4b1a34['payment_url'],await database_1[_0x2118a(0xf4)]['payment']['update']({'where':{'id':_0x537c4d['id']},'data':{'externalPaymentUrl':_0x261ad5,'gatewayPaymentId':_0x4b1a34[_0x2118a(0x105)],'invoiceTotalSum':Number(_0x4b1a34[_0x2118a(0xc8)]),'qrCode':_0x4b1a34[_0x2118a(0x18a)],'qrUrl':_0x4b1a34[_0x2118a(0x10d)]}}),_0x537c4d['externalPaymentUrl']=_0x261ad5,_0x537c4d['gatewayPaymentId']=_0x4b1a34[_0x2118a(0x105)];}else{if(_0x18c171===_0x2118a(0x15f)){const _0xf85494='GB';console['log'](_0x2118a(0x127));const _0x284bb9=await this[_0x2118a(0x14e)][_0x2118a(0xf1)]({'paymentId':_0x537c4d['id'],'orderId':_0x40509b,'orderName':_0x2118a(0xcf)+_0x40509b,'amount':_0x2a26f2[_0x2118a(0x152)],'currency':_0x2a26f2[_0x2118a(0x13c)]||_0x2118a(0xc7),'country':_0xf85494,'usage':_0x2a26f2[_0x2118a(0x133)]||_0x2118a(0x137),'maxPayments':_0x2a26f2[_0x2118a(0xc0)],'successUrl':_0x5dfe92,'failUrl':_0x4a337b});_0x261ad5=_0x284bb9['payment_url'],await database_1['default'][_0x2118a(0x143)][_0x2118a(0x103)]({'where':{'id':_0x537c4d['id']},'data':{'externalPaymentUrl':_0x261ad5,'gatewayPaymentId':_0x284bb9['gateway_payment_id'],'country':_0xf85494}}),_0x537c4d[_0x2118a(0x134)]=_0x261ad5,_0x537c4d['gatewayPaymentId']=_0x284bb9[_0x2118a(0x105)];}else{if(_0x18c171===_0x2118a(0x176)){console[_0x2118a(0x162)](_0x2118a(0xeb)+_0x40509b+_0x2118a(0x192));const _0x5705cc=await this['nodaService']['createPaymentLink']({'paymentId':_0x537c4d['id'],'orderId':_0x40509b,'name':'Order\x20ID:\x20'+_0x40509b,'paymentDescription':_0x2118a(0xcf)+_0x40509b,'amount':_0x2a26f2[_0x2118a(0x152)],'currency':_0x2a26f2['currency']||_0x2118a(0xc7),'webhookUrl':'https://tesoft.uk/gateways/noda/webhook','returnUrl':_0x5dfe92,'expiryDate':_0x2a26f2[_0x2118a(0xe2)]?.[_0x2118a(0x123)]()});_0x261ad5=_0x5705cc['payment_url'],await database_1[_0x2118a(0xf4)]['payment'][_0x2118a(0x103)]({'where':{'id':_0x537c4d['id']},'data':{'externalPaymentUrl':_0x261ad5,'gatewayPaymentId':_0x5705cc['gateway_payment_id'],'qrUrl':_0x5705cc['qr_code_url']}}),_0x537c4d[_0x2118a(0x134)]=_0x261ad5,_0x537c4d[_0x2118a(0x125)]=_0x5705cc[_0x2118a(0x105)],console[_0x2118a(0x162)](_0x2118a(0x17a)+_0x40509b);}else{if(_0x18c171===_0x2118a(0x102)){console['log'](_0x2118a(0xf8)+_0x40509b+_0x2118a(0x192)),console[_0x2118a(0x162)](_0x2118a(0x193)+_0x2a26f2[_0x2118a(0x152)]+_0x2118a(0xac));const _0x143a09=await this[_0x2118a(0x144)]['createPaymentLink']({'paymentId':_0x537c4d['id'],'orderId':_0x40509b,'amount':_0x2a26f2[_0x2118a(0x152)]});_0x261ad5=_0x143a09[_0x2118a(0x16f)],await database_1[_0x2118a(0xf4)][_0x2118a(0x143)][_0x2118a(0x103)]({'where':{'id':_0x537c4d['id']},'data':{'externalPaymentUrl':_0x261ad5,'gatewayPaymentId':_0x143a09[_0x2118a(0x105)],'currency':_0x2118a(0x16c)}}),_0x537c4d[_0x2118a(0x134)]=_0x261ad5,_0x537c4d[_0x2118a(0x125)]=_0x143a09[_0x2118a(0x105)],console[_0x2118a(0x162)](_0x2118a(0xfc)+_0x40509b);}else{if(_0x18c171[_0x2118a(0xb8)](_0x2118a(0xb1))){const _0x235f39=(0x0,gateway_1[_0x2118a(0x182)])(_0x18c171);if(!_0x235f39)throw new Error(_0x2118a(0x177)+_0x18c171);if(_0x235f39!=='EU'&&_0x235f39!=='GB')throw new Error('KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20'+_0x235f39);console[_0x2118a(0x162)](_0x2118a(0x163)+_0x235f39+_0x2118a(0x180)+_0x40509b+_0x2118a(0x192)),console[_0x2118a(0x162)](_0x2118a(0x193)+_0x2a26f2['amount']+'\x20'+(_0x2a26f2['currency']||'USD'));const _0x609488=await this[_0x2118a(0x11b)][_0x2118a(0xf1)]({'paymentId':_0x537c4d['id'],'orderId':_0x40509b,'amount':_0x2a26f2[_0x2118a(0x152)],'currency':_0x2a26f2['currency']||_0x2118a(0xc7),'region':_0x235f39,'redirectUrl':_0x5dfe92});_0x261ad5=_0x609488['payment_url'],await database_1['default'][_0x2118a(0x143)]['update']({'where':{'id':_0x537c4d['id']},'data':{'externalPaymentUrl':_0x261ad5,'gatewayPaymentId':_0x609488[_0x2118a(0x105)]}}),_0x537c4d['externalPaymentUrl']=_0x261ad5,_0x537c4d['gatewayPaymentId']=_0x609488[_0x2118a(0x105)],console[_0x2118a(0x162)](_0x2118a(0x11f)+_0x235f39+_0x2118a(0xaf)+_0x40509b);}}}}}}catch(_0x53e4ab){await database_1[_0x2118a(0xf4)][_0x2118a(0x143)]['update']({'where':{'id':_0x537c4d['id']},'data':{'status':_0x2118a(0x14c)}}),console[_0x2118a(0xd3)]('Gateway\x20error\x20during\x20shop\x20payment\x20creation:',_0x53e4ab);}const _0x2c1158='https://tesoft.uk/gateway/payment.php?id='+_0x537c4d['id'];return{'id':_0x537c4d['id'],'shopId':_0x537c4d[_0x2118a(0x136)],'gateway':_0x537c4d[_0x2118a(0x128)],'amount':_0x537c4d[_0x2118a(0x152)],'currency':_0x537c4d[_0x2118a(0x13c)],'sourceCurrency':_0x537c4d[_0x2118a(0x156)],'usage':_0x537c4d[_0x2118a(0x133)],'expiresAt':_0x537c4d[_0x2118a(0xe2)],'redirectUrl':_0x2c1158,'status':_0x537c4d['status'],'externalPaymentUrl':_0x261ad5,'customerEmail':_0x537c4d[_0x2118a(0x17f)],'customerName':_0x537c4d['customerName'],'country':_0x537c4d[_0x2118a(0x126)],'language':_0x537c4d[_0x2118a(0xfa)],'amountIsEditable':_0x537c4d[_0x2118a(0xfd)],'maxPayments':_0x537c4d[_0x2118a(0xc0)],'customer':_0x537c4d[_0x2118a(0xf7)],'createdAt':_0x537c4d['createdAt'],'updatedAt':_0x537c4d[_0x2118a(0x12b)],'shop':_0x537c4d[_0x2118a(0xea)]};}async['getPayments'](_0x5af6bc,_0x3f3896){const _0x495982=a48_0x27d12b,{page:_0x365ff4,limit:_0x1dc64f,status:_0x1c415e,gateway:_0x3ef8f1}=_0x3f3896,_0x4e0a47=(_0x365ff4-0x1)*_0x1dc64f,_0x4d9ae5={'shopId':_0x5af6bc};_0x1c415e&&(_0x4d9ae5[_0x495982(0x12a)]=_0x1c415e);if(_0x3ef8f1){if((0x0,gateway_1[_0x495982(0xb0)])(_0x3ef8f1)){const _0x180e83=(0x0,gateway_1['getGatewayNameById'])(_0x3ef8f1);_0x180e83&&(_0x4d9ae5[_0x495982(0x128)]=_0x180e83);}else _0x4d9ae5[_0x495982(0x128)]=_0x3ef8f1[_0x495982(0xd6)]();}const [_0x491790,_0x213164]=await Promise[_0x495982(0xab)]([database_1[_0x495982(0xf4)][_0x495982(0x143)][_0x495982(0x12e)]({'where':_0x4d9ae5,'skip':_0x4e0a47,'take':_0x1dc64f,'orderBy':{'createdAt':_0x495982(0xb2)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1['default'][_0x495982(0x143)][_0x495982(0x149)]({'where':_0x4d9ae5})]);return{'payments':_0x491790[_0x495982(0x122)](_0x3075b6=>{const _0x2c24f2=_0x495982,_0x3e0d28=_0x2c24f2(0xdd)+_0x3075b6['id'];return{'id':_0x3075b6['id'],'shopId':_0x3075b6[_0x2c24f2(0x136)],'gateway':_0x3075b6['gateway'],'amount':_0x3075b6[_0x2c24f2(0x152)],'currency':_0x3075b6[_0x2c24f2(0x13c)],'sourceCurrency':_0x3075b6[_0x2c24f2(0x156)],'usage':_0x3075b6[_0x2c24f2(0x133)],'expiresAt':_0x3075b6[_0x2c24f2(0xe2)],'redirectUrl':_0x3e0d28,'status':_0x3075b6[_0x2c24f2(0x12a)],'externalPaymentUrl':_0x3075b6[_0x2c24f2(0x134)],'customerEmail':_0x3075b6['customerEmail'],'customerName':_0x3075b6[_0x2c24f2(0x117)],'country':_0x3075b6['country'],'language':_0x3075b6[_0x2c24f2(0xfa)],'amountIsEditable':_0x3075b6[_0x2c24f2(0xfd)],'maxPayments':_0x3075b6['maxPayments'],'customer':_0x3075b6[_0x2c24f2(0xf7)],'createdAt':_0x3075b6[_0x2c24f2(0x148)],'updatedAt':_0x3075b6[_0x2c24f2(0x12b)],'shop':_0x3075b6[_0x2c24f2(0xea)]};}),'pagination':{'page':_0x365ff4,'limit':_0x1dc64f,'total':_0x213164,'totalPages':Math[_0x495982(0x178)](_0x213164/_0x1dc64f)}};}async[a48_0x27d12b(0xb4)](_0x295bae,_0x352da8){const _0x53b0c6=a48_0x27d12b,_0x2075e7=await database_1[_0x53b0c6(0xf4)][_0x53b0c6(0x143)]['findFirst']({'where':{'id':_0x352da8,'shopId':_0x295bae},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x53b0c6(0xb2)},'take':0xa}}});if(!_0x2075e7)return null;const _0x3f9f21=_0x53b0c6(0xdd)+_0x2075e7['id'];return{'id':_0x2075e7['id'],'shopId':_0x2075e7['shopId'],'gateway':_0x2075e7[_0x53b0c6(0x128)],'amount':_0x2075e7[_0x53b0c6(0x152)],'currency':_0x2075e7[_0x53b0c6(0x13c)],'sourceCurrency':_0x2075e7['sourceCurrency'],'usage':_0x2075e7[_0x53b0c6(0x133)],'expiresAt':_0x2075e7['expiresAt'],'redirectUrl':_0x3f9f21,'status':_0x2075e7[_0x53b0c6(0x12a)],'externalPaymentUrl':_0x2075e7[_0x53b0c6(0x134)],'customerEmail':_0x2075e7[_0x53b0c6(0x17f)],'customerName':_0x2075e7[_0x53b0c6(0x117)],'country':_0x2075e7[_0x53b0c6(0x126)],'language':_0x2075e7[_0x53b0c6(0xfa)],'amountIsEditable':_0x2075e7[_0x53b0c6(0xfd)],'maxPayments':_0x2075e7[_0x53b0c6(0xc0)],'customer':_0x2075e7[_0x53b0c6(0xf7)],'createdAt':_0x2075e7[_0x53b0c6(0x148)],'updatedAt':_0x2075e7[_0x53b0c6(0x12b)],'shop':_0x2075e7[_0x53b0c6(0xea)],'webhookLogs':_0x2075e7[_0x53b0c6(0x115)]};}async[a48_0x27d12b(0x16d)](_0xa043a7,_0x3fe503,_0x73cd79){const _0x503fac=a48_0x27d12b,_0x195d07={..._0x73cd79};if(_0x73cd79[_0x503fac(0x128)]){if((0x0,gateway_1[_0x503fac(0xb0)])(_0x73cd79[_0x503fac(0x128)])){const _0x5aac77=(0x0,gateway_1[_0x503fac(0x111)])(_0x73cd79[_0x503fac(0x128)]);_0x5aac77&&(_0x195d07[_0x503fac(0x128)]=_0x5aac77);}else _0x195d07[_0x503fac(0x128)]=_0x73cd79[_0x503fac(0x128)][_0x503fac(0xd6)]();}const _0x292fec=await database_1['default'][_0x503fac(0x143)]['update']({'where':{'id':_0x3fe503,'shopId':_0xa043a7},'data':_0x195d07,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x196a80=_0x503fac(0xdd)+_0x292fec['id'];return{'id':_0x292fec['id'],'shopId':_0x292fec['shopId'],'gateway':_0x292fec[_0x503fac(0x128)],'amount':_0x292fec[_0x503fac(0x152)],'currency':_0x292fec[_0x503fac(0x13c)],'sourceCurrency':_0x292fec[_0x503fac(0x156)],'usage':_0x292fec['usage'],'expiresAt':_0x292fec['expiresAt'],'redirectUrl':_0x196a80,'status':_0x292fec[_0x503fac(0x12a)],'externalPaymentUrl':_0x292fec[_0x503fac(0x134)],'customerEmail':_0x292fec[_0x503fac(0x17f)],'customerName':_0x292fec[_0x503fac(0x117)],'country':_0x292fec['country'],'language':_0x292fec['language'],'amountIsEditable':_0x292fec['amountIsEditable'],'maxPayments':_0x292fec[_0x503fac(0xc0)],'customer':_0x292fec[_0x503fac(0xf7)],'createdAt':_0x292fec['createdAt'],'updatedAt':_0x292fec['updatedAt'],'shop':_0x292fec[_0x503fac(0xea)]};}async[a48_0x27d12b(0x120)](_0x4c9e07,_0x154c84){const _0x4d0542=a48_0x27d12b;await database_1[_0x4d0542(0xf4)]['payment'][_0x4d0542(0xb5)]({'where':{'id':_0x154c84,'shopId':_0x4c9e07}});}async[a48_0x27d12b(0x179)](_0x47b8a0,_0x644f7b){const _0x753925=a48_0x27d12b,{page:_0x8c167,limit:_0x16899a,status:_0xde9de6,method:_0x2673fd,dateFrom:_0xa33d8e,dateTo:_0x1a5335}=_0x644f7b,_0x12bfe8=(_0x8c167-0x1)*_0x16899a,_0x25da27={'shopId':_0x47b8a0};_0xde9de6&&(_0x25da27[_0x753925(0x12a)]=_0xde9de6);_0x2673fd&&(_0x25da27[_0x753925(0xc5)]=_0x2673fd);(_0xa33d8e||_0x1a5335)&&(_0x25da27[_0x753925(0x148)]={},_0xa33d8e&&(_0x25da27[_0x753925(0x148)][_0x753925(0xcb)]=new Date(_0xa33d8e)),_0x1a5335&&(_0x25da27[_0x753925(0x148)]['lte']=new Date(_0x1a5335)));const [_0xe172b7,_0x1291e5]=await Promise[_0x753925(0xab)]([database_1[_0x753925(0xf4)][_0x753925(0x12c)]['findMany']({'where':_0x25da27,'skip':_0x12bfe8,'take':_0x16899a,'orderBy':{'createdAt':_0x753925(0xb2)}}),database_1[_0x753925(0xf4)][_0x753925(0x12c)][_0x753925(0x149)]({'where':_0x25da27})]);return{'payouts':_0xe172b7[_0x753925(0x122)](_0x2075af=>({'id':_0x2075af['id'],'amount':_0x2075af[_0x753925(0x152)],'network':_0x2075af[_0x753925(0xc5)],'status':_0x2075af[_0x753925(0x12a)],'txid':_0x2075af[_0x753925(0xba)],'notes':_0x2075af[_0x753925(0x139)],'createdAt':_0x2075af['createdAt'],'paidAt':_0x2075af[_0x753925(0x119)]})),'pagination':{'page':_0x8c167,'limit':_0x16899a,'total':_0x1291e5,'totalPages':Math['ceil'](_0x1291e5/_0x16899a)}};}async[a48_0x27d12b(0x185)](_0x4675a9,_0x1b4239){const _0x454e1c=a48_0x27d12b,_0x314813=await database_1[_0x454e1c(0xf4)]['payout'][_0x454e1c(0x116)]({'where':{'id':_0x1b4239,'shopId':_0x4675a9},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x314813)return null;return{'id':_0x314813['id'],'shopId':_0x314813[_0x454e1c(0x136)],'amount':_0x314813[_0x454e1c(0x152)],'method':_0x314813[_0x454e1c(0xc5)],'status':_0x314813[_0x454e1c(0x12a)],'txid':_0x314813[_0x454e1c(0xba)],'createdAt':_0x314813['createdAt'],'paidAt':_0x314813['paidAt'],'shop':_0x314813[_0x454e1c(0xea)]};}async[a48_0x27d12b(0x104)](_0x4a506c,_0x55ecf1){const _0x39d6cd=a48_0x27d12b,_0x497c9f=this[_0x39d6cd(0xbc)](_0x55ecf1),_0x55b079=new Date();_0x55b079[_0x39d6cd(0x140)](_0x55b079[_0x39d6cd(0xae)]()-_0x497c9f);const _0x34f56f={'shopId':_0x4a506c,'createdAt':{'gte':_0x55b079}},[_0x193040,_0x37c49c,_0x9841b1,_0x4067b2,_0x5b5cc2,_0x35a88f,_0x48c4ee,_0x3a8871]=await Promise[_0x39d6cd(0xab)]([database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0x149)]({'where':_0x34f56f}),database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0x149)]({'where':{..._0x34f56f,'status':_0x39d6cd(0x155)}}),database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)]['count']({'where':{..._0x34f56f,'status':_0x39d6cd(0xe3)}}),database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0x149)]({'where':{..._0x34f56f,'status':_0x39d6cd(0x11e)}}),database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0xb7)]({'where':_0x34f56f,'_sum':{'amount':!![]}}),database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0x168)]({'by':['status'],'where':_0x34f56f,'_count':{'status':!![]}}),database_1['default'][_0x39d6cd(0x12c)][_0x39d6cd(0x168)]({'by':[_0x39d6cd(0xc5)],'where':_0x34f56f,'_count':{'network':!![]}}),database_1['default'][_0x39d6cd(0x12c)]['findMany']({'where':{'shopId':_0x4a506c},'take':0xa,'orderBy':{'createdAt':_0x39d6cd(0xb2)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x1f33f2=await database_1['default'][_0x39d6cd(0x12c)][_0x39d6cd(0xb7)]({'where':{..._0x34f56f,'status':_0x39d6cd(0x155)},'_sum':{'amount':!![]}}),_0x4e931f=await database_1[_0x39d6cd(0xf4)][_0x39d6cd(0x12c)][_0x39d6cd(0xb7)]({'where':{..._0x34f56f,'status':'PENDING'},'_sum':{'amount':!![]}});return{'totalPayouts':_0x193040,'completedPayouts':_0x37c49c,'pendingPayouts':_0x9841b1,'rejectedPayouts':_0x4067b2,'totalAmount':_0x5b5cc2[_0x39d6cd(0x13b)][_0x39d6cd(0x152)]||0x0,'completedAmount':_0x1f33f2[_0x39d6cd(0x13b)]['amount']||0x0,'pendingAmount':_0x4e931f[_0x39d6cd(0x13b)]['amount']||0x0,'payoutsByStatus':_0x35a88f[_0x39d6cd(0x191)]((_0x21aa57,_0x55f14f)=>{const _0x40971b=_0x39d6cd;return _0x21aa57[_0x55f14f[_0x40971b(0x12a)]]=_0x55f14f[_0x40971b(0xff)][_0x40971b(0x12a)],_0x21aa57;},{}),'payoutsByMethod':_0x48c4ee[_0x39d6cd(0x191)]((_0x592446,_0x312e4d)=>{const _0x3a4425=_0x39d6cd;return _0x592446[_0x312e4d['network']]=_0x312e4d[_0x3a4425(0xff)]['network'],_0x592446;},{}),'recentPayouts':_0x3a8871[_0x39d6cd(0x122)](_0x4ff2bd=>({'id':_0x4ff2bd['id'],'shopId':_0x4ff2bd[_0x39d6cd(0x136)],'amount':_0x4ff2bd[_0x39d6cd(0x152)],'method':_0x4ff2bd['network'],'status':_0x4ff2bd[_0x39d6cd(0x12a)],'txid':_0x4ff2bd['txid'],'createdAt':_0x4ff2bd[_0x39d6cd(0x148)],'paidAt':_0x4ff2bd['paidAt'],'shop':_0x4ff2bd[_0x39d6cd(0xea)]}))};}async['getShopPayoutStats'](_0x2b1085){const _0x1aca46=a48_0x27d12b;console[_0x1aca46(0x162)](_0x1aca46(0x17b)+_0x2b1085);const _0x2d57e3=await database_1['default'][_0x1aca46(0xea)][_0x1aca46(0x15c)]({'where':{'id':_0x2b1085},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x2d57e3)throw new Error('Shop\x20not\x20found');const _0x2c4db0=await database_1[_0x1aca46(0xf4)]['payment'][_0x1aca46(0x12e)]({'where':{'shopId':_0x2b1085,'status':_0x1aca46(0xb3)},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0x1aca46(0x162)](_0x1aca46(0xcc)+_0x2c4db0[_0x1aca46(0x10e)]+_0x1aca46(0x10b));const _0x5338ba=new Date(),_0x5823c3=new Date(_0x5338ba['getFullYear'](),_0x5338ba[_0x1aca46(0xcd)](),0x1);let _0x2ebe33=0x0,_0x456aeb=0x0,_0x1fa318=0x0,_0x244db8=0x0;for(const _0x2f5114 of _0x2c4db0){const _0x4218b1=await currencyService_1[_0x1aca46(0xc9)]['convertToUSDT'](_0x2f5114[_0x1aca46(0x152)],_0x2f5114['currency']),_0x5ea27b=this[_0x1aca46(0x16a)](_0x2d57e3,_0x2f5114[_0x1aca46(0x128)]),_0x46d1aa=this[_0x1aca46(0x166)](_0x4218b1,_0x5ea27b[_0x1aca46(0x161)]);_0x2f5114[_0x1aca46(0x13d)]&&(_0x2ebe33+=_0x46d1aa,_0x2f5114[_0x1aca46(0x119)]&&_0x2f5114['paidAt']>=_0x5823c3&&(_0x1fa318+=_0x46d1aa)),this['isEligibleForPayout'](_0x2f5114,_0x5ea27b)&&(_0x456aeb+=_0x46d1aa,_0x244db8+=_0x4218b1);}const _0x1ae0dc={'availableBalance':Math[_0x1aca46(0x170)](_0x244db8*0x64)/0x64,'totalPaidOut':Math['round'](_0x2ebe33*0x64)/0x64,'awaitingPayout':Math[_0x1aca46(0x170)](_0x456aeb*0x64)/0x64,'thisMonth':Math[_0x1aca46(0x170)](_0x1fa318*0x64)/0x64};return console[_0x1aca46(0x162)](_0x1aca46(0x12f)),console[_0x1aca46(0x162)](_0x1aca46(0xb9)+_0x1ae0dc[_0x1aca46(0x141)]+_0x1aca46(0x189)),console[_0x1aca46(0x162)](_0x1aca46(0x101)+_0x1ae0dc['totalPaidOut']+_0x1aca46(0x189)),console[_0x1aca46(0x162)](_0x1aca46(0xe6)+_0x1ae0dc[_0x1aca46(0x11a)]+'\x20USDT'),console[_0x1aca46(0x162)](_0x1aca46(0x121)+_0x1ae0dc['thisMonth']+_0x1aca46(0x189)),_0x1ae0dc;}async[a48_0x27d12b(0x164)](_0x1cd260){const _0x1f9b15=a48_0x27d12b,_0x566eae=await this[_0x1f9b15(0xf5)](_0x1cd260);return{'totalBalance':_0x566eae['availableBalance'],'totalPaidOut':_0x566eae['totalPaidOut'],'awaitingPayout':_0x566eae[_0x1f9b15(0x11a)],'thisMonth':_0x566eae[_0x1f9b15(0xbb)]};}async['getWebhookLogs'](_0x3f9d02,_0x19d297){const _0x42c61f=a48_0x27d12b,{page:_0x75cd2b,limit:_0x5dfa3a,paymentId:_0x17bb6c}=_0x19d297,_0x57740c=(_0x75cd2b-0x1)*_0x5dfa3a,_0x174f0f={'shopId':_0x3f9d02};_0x17bb6c&&(_0x174f0f[_0x42c61f(0x159)]=_0x17bb6c);const [_0x37f5f2,_0x19de3c]=await Promise[_0x42c61f(0xab)]([database_1[_0x42c61f(0xf4)][_0x42c61f(0xdb)]['findMany']({'where':_0x174f0f,'skip':_0x57740c,'take':_0x5dfa3a,'orderBy':{'createdAt':_0x42c61f(0xb2)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default']['webhookLog'][_0x42c61f(0x149)]({'where':_0x174f0f})]);return{'logs':_0x37f5f2[_0x42c61f(0x122)](_0x1dc0f6=>({'id':_0x1dc0f6['id'],'paymentId':_0x1dc0f6[_0x42c61f(0x159)],'shopId':_0x1dc0f6['shopId'],'event':_0x1dc0f6['event'],'statusCode':_0x1dc0f6[_0x42c61f(0x13a)],'retryCount':_0x1dc0f6[_0x42c61f(0x158)],'responseBody':_0x1dc0f6['responseBody'],'createdAt':_0x1dc0f6['createdAt'],'payment':_0x1dc0f6[_0x42c61f(0x143)]})),'pagination':{'page':_0x75cd2b,'limit':_0x5dfa3a,'total':_0x19de3c,'totalPages':Math[_0x42c61f(0x178)](_0x19de3c/_0x5dfa3a)}};}async[a48_0x27d12b(0x16b)](_0x5bca45,_0x38010f){const _0x124286=a48_0x27d12b,_0x3a14c3=this[_0x124286(0xbc)](_0x38010f),_0x22c67e=new Date();_0x22c67e[_0x124286(0x140)](_0x22c67e[_0x124286(0xae)]()-_0x3a14c3),console[_0x124286(0x162)](_0x124286(0xed)+_0x38010f+'\x20('+_0x3a14c3+_0x124286(0x17e));const _0x1b234f={'shopId':_0x5bca45,'createdAt':{'gte':_0x22c67e}},_0x43a769=await database_1['default'][_0x124286(0xea)][_0x124286(0x15c)]({'where':{'id':_0x5bca45},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x43a769)throw new Error(_0x124286(0x184));const [_0xa266c8,_0x5b1e3a,_0x21c1e7,_0x3e4c15,_0x2f72d1,_0x1eba1e,_0x3c1b15,_0x21b02b]=await Promise[_0x124286(0xab)]([database_1[_0x124286(0xf4)][_0x124286(0x143)][_0x124286(0x149)]({'where':_0x1b234f}),database_1[_0x124286(0xf4)]['payment'][_0x124286(0x149)]({'where':{..._0x1b234f,'status':_0x124286(0xb3)}}),database_1[_0x124286(0xf4)][_0x124286(0x143)][_0x124286(0x12e)]({'where':_0x1b234f,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1[_0x124286(0xf4)][_0x124286(0x143)][_0x124286(0x12e)]({'where':{..._0x1b234f,'status':_0x124286(0xb3)},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0x124286(0xf4)][_0x124286(0x143)][_0x124286(0x168)]({'by':[_0x124286(0x12a)],'where':_0x1b234f,'_count':{'status':!![]}}),database_1[_0x124286(0xf4)][_0x124286(0x143)]['groupBy']({'by':[_0x124286(0x128)],'where':_0x1b234f,'_count':{'gateway':!![]}}),database_1['default'][_0x124286(0x143)][_0x124286(0x12e)]({'where':{'shopId':_0x5bca45},'take':0xa,'orderBy':{'createdAt':_0x124286(0xb2)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1[_0x124286(0xf4)][_0x124286(0x109)]`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x5bca45} 
          AND created_at >= ${_0x22c67e}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0x124286(0x162)](_0x124286(0xcc)+_0x3e4c15[_0x124286(0x10e)]+'\x20PAID\x20payments\x20for\x20totalAmount\x20calculation');const _0x52c586=await Promise[_0x124286(0xab)](_0x3e4c15[_0x124286(0x122)](async _0x5c5929=>{const _0x532639=_0x124286,_0x623da5=await currencyService_1['currencyService'][_0x532639(0xdc)](_0x5c5929[_0x532639(0x152)],_0x5c5929[_0x532639(0x13c)]),_0x528333=this[_0x532639(0x16a)](_0x43a769,_0x5c5929[_0x532639(0x128)]),_0x4364df=this[_0x532639(0x166)](_0x623da5,_0x528333[_0x532639(0x161)]);return _0x4364df;})),_0xb6958c=await Promise['all'](_0x21c1e7[_0x124286(0x122)](async _0x226184=>{const _0x2a9158=_0x124286,_0x25f15e=await currencyService_1['currencyService']['convertToUSDT'](_0x226184[_0x2a9158(0x152)],_0x226184['currency']);return{'amount':_0x25f15e,'status':_0x226184[_0x2a9158(0x12a)]};})),_0x2616ec=_0x52c586[_0x124286(0x191)]((_0x5ab101,_0x326f08)=>_0x5ab101+_0x326f08,0x0),_0xc385f0=_0xa266c8>0x0?_0xb6958c[_0x124286(0x191)]((_0x4b6a3a,_0x123c53)=>_0x4b6a3a+_0x123c53[_0x124286(0x152)],0x0)/_0xa266c8:0x0;console[_0x124286(0x162)](_0x124286(0x138)+_0x2616ec['toFixed'](0x2)+_0x124286(0x189)),console[_0x124286(0x162)](_0x124286(0xbf)+_0xc385f0[_0x124286(0xb6)](0x2)+_0x124286(0x189));const _0x32cea9=this[_0x124286(0x18c)](_0x22c67e,new Date()),_0x1a7239=await Promise[_0x124286(0xab)](_0x21b02b[_0x124286(0x122)](async _0x225696=>{const _0x48f2a5=_0x124286,_0x5597c7=_0x225696[_0x48f2a5(0x130)][_0x48f2a5(0xe0)](_0x525743=>_0x525743['status']==='PAID'),_0x1c864c=await Promise[_0x48f2a5(0xab)](_0x5597c7[_0x48f2a5(0x122)](async _0x43313d=>{const _0x2f5b2f=_0x48f2a5,_0x424a19=await currencyService_1[_0x2f5b2f(0xc9)][_0x2f5b2f(0xdc)](_0x43313d[_0x2f5b2f(0x152)],_0x43313d['currency']),_0x4402c8=this[_0x2f5b2f(0x16a)](_0x43a769,_0x43313d['gateway']),_0x44fe13=this[_0x2f5b2f(0x166)](_0x424a19,_0x4402c8[_0x2f5b2f(0x161)]);return _0x44fe13;})),_0x5715e3=_0x1c864c[_0x48f2a5(0x191)]((_0xab1d68,_0x1334f4)=>_0xab1d68+_0x1334f4,0x0);return{'date':_0x225696[_0x48f2a5(0xad)][_0x48f2a5(0x123)]()[_0x48f2a5(0x151)]('T')[0x0],'count':_0x225696[_0x48f2a5(0x149)],'revenue':_0x5715e3};})),_0x4d6310=new Map(_0x1a7239[_0x124286(0x122)](_0x455327=>[_0x455327[_0x124286(0xad)],{'count':_0x455327[_0x124286(0x149)],'revenue':_0x455327[_0x124286(0x14f)]}])),_0x107de6=_0x32cea9[_0x124286(0x122)](_0x2451ab=>({'date':_0x2451ab,'amount':_0x4d6310['get'](_0x2451ab)?.[_0x124286(0x14f)]||0x0})),_0x1f3be0=_0x32cea9['map'](_0x3ada33=>({'date':_0x3ada33,'count':_0x4d6310[_0x124286(0xd2)](_0x3ada33)?.[_0x124286(0x149)]||0x0}));return console[_0x124286(0x162)](_0x124286(0xd9)),console[_0x124286(0x162)]('💳\x20Total\x20payments:\x20'+_0xa266c8),console[_0x124286(0x162)](_0x124286(0x108)+_0x5b1e3a),console['log'](_0x124286(0x167)+_0x107de6[_0x124286(0x10e)]),{'totalPayments':_0xa266c8,'successfulPayments':_0x5b1e3a,'totalAmount':Math['round'](_0x2616ec*0x64)/0x64,'averageAmount':Math[_0x124286(0x170)](_0xc385f0*0x64)/0x64,'paymentsByStatus':_0x2f72d1[_0x124286(0x191)]((_0x38b802,_0x3d77d0)=>{const _0x5db4b5=_0x124286;return _0x38b802[_0x3d77d0['status']]=_0x3d77d0[_0x5db4b5(0xff)][_0x5db4b5(0x12a)],_0x38b802;},{}),'paymentsByGateway':_0x1eba1e[_0x124286(0x191)]((_0xa3c1c5,_0x3759da)=>{const _0x4e74ba=_0x124286;return _0xa3c1c5[_0x3759da[_0x4e74ba(0x128)]]=_0x3759da[_0x4e74ba(0xff)][_0x4e74ba(0x128)],_0xa3c1c5;},{}),'recentPayments':_0x3c1b15[_0x124286(0x122)](_0x59bc3f=>{const _0x543586=_0x124286,_0xacbfce=_0x543586(0xdd)+_0x59bc3f['id'];return{'id':_0x59bc3f['id'],'shopId':_0x59bc3f[_0x543586(0x136)],'gateway':_0x59bc3f[_0x543586(0x128)],'amount':_0x59bc3f['amount'],'currency':_0x59bc3f[_0x543586(0x13c)],'sourceCurrency':_0x59bc3f[_0x543586(0x156)],'usage':_0x59bc3f[_0x543586(0x133)],'expiresAt':_0x59bc3f[_0x543586(0xe2)],'redirectUrl':_0xacbfce,'status':_0x59bc3f[_0x543586(0x12a)],'externalPaymentUrl':_0x59bc3f[_0x543586(0x134)],'customerEmail':_0x59bc3f[_0x543586(0x17f)],'customerName':_0x59bc3f[_0x543586(0x117)],'country':_0x59bc3f[_0x543586(0x126)],'language':_0x59bc3f['language'],'amountIsEditable':_0x59bc3f[_0x543586(0xfd)],'maxPayments':_0x59bc3f[_0x543586(0xc0)],'customer':_0x59bc3f[_0x543586(0xf7)],'createdAt':_0x59bc3f[_0x543586(0x148)],'updatedAt':_0x59bc3f[_0x543586(0x12b)],'shop':_0x59bc3f[_0x543586(0xea)]};}),'dailyRevenue':_0x107de6,'dailyPayments':_0x1f3be0};}['getPeriodDays'](_0x350a76){const _0xeb0c40=a48_0x27d12b;switch(_0x350a76){case'7d':return 0x7;case _0xeb0c40(0xe5):return 0x1e;case _0xeb0c40(0x107):return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a48_0x27d12b(0x18c)](_0x3ca918,_0x2ba28f){const _0x2aa30d=a48_0x27d12b,_0x286909=[],_0x2fcf39=new Date(_0x3ca918);while(_0x2fcf39<=_0x2ba28f){_0x286909[_0x2aa30d(0x11d)](_0x2fcf39['toISOString']()[_0x2aa30d(0x151)]('T')[0x0]),_0x2fcf39[_0x2aa30d(0x140)](_0x2fcf39['getDate']()+0x1);}return _0x286909;}}exports[a48_0x27d12b(0x16e)]=ShopService;