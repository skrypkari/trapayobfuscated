'use strict';const a53_0x140604=a53_0x169d;function a53_0x58a7(){const _0x1f54f3=['ShopService','username','Test\x20Gateway','map','setDate','customerEmail','publicKey','reduce','1788112rCAubI','_sum','PAID','getGatewayDisplayName','Unknown\x20error','COMPLETED','\x20USDT\x20(current\x20balance)','POST','payment','amountIsEditable','paymentGateways','paymentService','findFirst','getShopProfile','name','\x20payout\x20statistics\x20calculated:','\x20USDT','USDT\x20BSC','\x20\x20\x20üìÖ\x20This\x20month:\x20','formatNetworkName','notes','getFullYear','isArray','gatewaySettings','customerName','amountUSDT','Shop\x20not\x20found','6KyIgGd','application/json','message','push','telegramId','payout','gateways','13805yjynxY','shopId','amount','usdtErcWallet','parse','event','shop','customer','convertToUSDT','PaymentService','test','revenue','getPayments','getPaymentByShopAndId','getPaymentsByShop','getStatistics','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','statusText','settings','toISOString','error','usdtPolygonWallet','desc','webhookUrl','periodTo','findUnique','sourceCurrency','txid','status','updateShopProfile','totalPaidOut','No\x20webhook\x20URL\x20configured','getShopPayoutStats','TesSoft\x20Payment\x20System/1.0\x20(Test)','telegram','gateway','log','createdAt','Error\x20parsing\x20webhook\x20events:','getPayouts','1115660FMnhId','fullName','__esModule','\x20\x20\x20üíµ\x20Available\x20balance:\x20','count','dailyPayments','stringify','PENDING','all','Noda','getMonth','paidAt','asc','redirectUrl','getPayoutStats','usage','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','responseBody','ceil','USDT\x20Polygon','updateWallets','test_gateway','test_payment_123','Plisio','maxPayments','__importDefault','516762dXxsMc','224562dyiKDT','...','./paymentService','gte','usdtTrcWallet','awaitingPayout','toUpperCase','1631427ROoRzt','\x20USDT\x20(total\x20payouts)','webhookEvents','default','delete','USDT\x20ERC20','üìä\x20Shop\x20','statusCode','lte','usdcPolygonWallet','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','generateDailyStatistics','balance','Payment\x20not\x20found','getPaymentById','split','wallets','filter','round','deletePayment','REJECTED','KLYME\x20GB','update','webhookLog','30d','expiresAt','network','90d','currency','getTime','findMany','periodFrom','207590TgCddl','merchantUrl','Webhook\x20returned\x20error:\x20','shopUrl','./currencyService'];a53_0x58a7=function(){return _0x1f54f3;};return a53_0x58a7();}(function(_0x44369b,_0x18c659){const _0x9ea987=a53_0x169d,_0x23b51e=_0x44369b();while(!![]){try{const _0x449d21=-parseInt(_0x9ea987(0x1e2))/0x1+-parseInt(_0x9ea987(0x1bb))/0x2+parseInt(_0x9ea987(0x1ba))/0x3+parseInt(_0x9ea987(0x1a0))/0x4+parseInt(_0x9ea987(0x178))/0x5*(parseInt(_0x9ea987(0x20a))/0x6)+parseInt(_0x9ea987(0x1c2))/0x7+-parseInt(_0x9ea987(0x1ef))/0x8;if(_0x449d21===_0x18c659)break;else _0x23b51e['push'](_0x23b51e['shift']());}catch(_0x4acec0){_0x23b51e['push'](_0x23b51e['shift']());}}}(a53_0x58a7,0x230f6));var __importDefault=this&&this[a53_0x140604(0x1b9)]||function(_0x3f564b){const _0x3d1c07=a53_0x140604;return _0x3f564b&&_0x3f564b[_0x3d1c07(0x1a2)]?_0x3f564b:{'default':_0x3f564b};};Object['defineProperty'](exports,a53_0x140604(0x1a2),{'value':!![]}),exports[a53_0x140604(0x1e7)]=void 0x0;function a53_0x169d(_0x459533,_0x2f4669){const _0x58a73a=a53_0x58a7();return a53_0x169d=function(_0x169d8b,_0x367f64){_0x169d8b=_0x169d8b-0x174;let _0x3397b9=_0x58a73a[_0x169d8b];return _0x3397b9;},a53_0x169d(_0x459533,_0x2f4669);}const database_1=__importDefault(require('../config/database')),currencyService_1=require(a53_0x140604(0x1e6)),paymentService_1=require(a53_0x140604(0x1bd));class ShopService{constructor(){const _0x327a2e=a53_0x140604;this[_0x327a2e(0x1fa)]=new paymentService_1[(_0x327a2e(0x181))]();}async[a53_0x140604(0x1fc)](_0xe48a74){const _0x42d308=a53_0x140604,_0xfcd74e=await database_1[_0x42d308(0x1c5)]['shop'][_0x42d308(0x191)]({'where':{'id':_0xe48a74},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0xfcd74e)throw new Error(_0x42d308(0x209));let _0x23b819=[];if(_0xfcd74e[_0x42d308(0x18a)]?.[_0x42d308(0x1c4)])try{_0x23b819=Array[_0x42d308(0x205)](_0xfcd74e[_0x42d308(0x18a)][_0x42d308(0x1c4)])?_0xfcd74e[_0x42d308(0x18a)][_0x42d308(0x1c4)]:JSON[_0x42d308(0x17c)](_0xfcd74e[_0x42d308(0x18a)][_0x42d308(0x1c4)]);}catch(_0x565b23){console['error']('Error\x20parsing\x20webhook\x20events:',_0x565b23),_0x23b819=[];}return{'id':_0xfcd74e['id'],'fullName':_0xfcd74e['name'],'username':_0xfcd74e[_0x42d308(0x1e8)],'telegramId':_0xfcd74e[_0x42d308(0x19a)],'merchantUrl':_0xfcd74e[_0x42d308(0x1e5)],'gateways':_0xfcd74e[_0x42d308(0x1f9)]?JSON['parse'](_0xfcd74e[_0x42d308(0x1f9)]):null,'gatewaySettings':_0xfcd74e[_0x42d308(0x206)]?JSON[_0x42d308(0x17c)](_0xfcd74e['gatewaySettings']):null,'publicKey':_0xfcd74e[_0x42d308(0x1ed)],'webhookUrl':_0xfcd74e[_0x42d308(0x18a)]?.[_0x42d308(0x18f)]||null,'webhookEvents':_0x23b819,'wallets':{'usdtPolygonWallet':_0xfcd74e['usdtPolygonWallet'],'usdtTrcWallet':_0xfcd74e['usdtTrcWallet'],'usdtErcWallet':_0xfcd74e[_0x42d308(0x17b)],'usdcPolygonWallet':_0xfcd74e[_0x42d308(0x1cb)]},'status':_0xfcd74e[_0x42d308(0x194)],'createdAt':_0xfcd74e[_0x42d308(0x19d)]};}async[a53_0x140604(0x195)](_0x545541,_0x4c993c){const _0x1a6dd0=a53_0x140604,_0x458fd1={};_0x4c993c[_0x1a6dd0(0x1a1)]&&(_0x458fd1[_0x1a6dd0(0x1fd)]=_0x4c993c[_0x1a6dd0(0x1a1)]);_0x4c993c[_0x1a6dd0(0x175)]!==undefined&&(_0x458fd1[_0x1a6dd0(0x19a)]=_0x4c993c[_0x1a6dd0(0x175)]||null);_0x4c993c[_0x1a6dd0(0x1e3)]&&(_0x458fd1[_0x1a6dd0(0x1e5)]=_0x4c993c[_0x1a6dd0(0x1e3)]);_0x4c993c['gateways']&&(_0x458fd1[_0x1a6dd0(0x1f9)]=JSON[_0x1a6dd0(0x1a6)](_0x4c993c[_0x1a6dd0(0x177)]));_0x4c993c[_0x1a6dd0(0x206)]&&(_0x458fd1[_0x1a6dd0(0x206)]=JSON[_0x1a6dd0(0x1a6)](_0x4c993c[_0x1a6dd0(0x206)]));_0x4c993c[_0x1a6dd0(0x1d2)]&&(_0x4c993c[_0x1a6dd0(0x1d2)]['usdtPolygonWallet']!==undefined&&(_0x458fd1['usdtPolygonWallet']=_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x18d)]||null),_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x1bf)]!==undefined&&(_0x458fd1['usdtTrcWallet']=_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x1bf)]||null),_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x17b)]!==undefined&&(_0x458fd1['usdtErcWallet']=_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x17b)]||null),_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x1cb)]!==undefined&&(_0x458fd1[_0x1a6dd0(0x1cb)]=_0x4c993c[_0x1a6dd0(0x1d2)][_0x1a6dd0(0x1cb)]||null));const _0x423b2b=await database_1['default'][_0x1a6dd0(0x17e)][_0x1a6dd0(0x1d8)]({'where':{'id':_0x545541},'data':_0x458fd1,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x55f576=[];if(_0x423b2b[_0x1a6dd0(0x18a)]?.[_0x1a6dd0(0x1c4)])try{_0x55f576=Array[_0x1a6dd0(0x205)](_0x423b2b['settings'][_0x1a6dd0(0x1c4)])?_0x423b2b[_0x1a6dd0(0x18a)][_0x1a6dd0(0x1c4)]:JSON[_0x1a6dd0(0x17c)](_0x423b2b['settings'][_0x1a6dd0(0x1c4)]);}catch(_0xa2d40f){console[_0x1a6dd0(0x18c)](_0x1a6dd0(0x19e),_0xa2d40f),_0x55f576=[];}return{'id':_0x423b2b['id'],'fullName':_0x423b2b['name'],'username':_0x423b2b[_0x1a6dd0(0x1e8)],'telegramId':_0x423b2b[_0x1a6dd0(0x19a)],'merchantUrl':_0x423b2b['shopUrl'],'gateways':_0x423b2b['paymentGateways']?JSON[_0x1a6dd0(0x17c)](_0x423b2b[_0x1a6dd0(0x1f9)]):null,'gatewaySettings':_0x423b2b[_0x1a6dd0(0x206)]?JSON[_0x1a6dd0(0x17c)](_0x423b2b[_0x1a6dd0(0x206)]):null,'publicKey':_0x423b2b[_0x1a6dd0(0x1ed)],'webhookUrl':_0x423b2b[_0x1a6dd0(0x18a)]?.['webhookUrl']||null,'webhookEvents':_0x55f576,'wallets':{'usdtPolygonWallet':_0x423b2b[_0x1a6dd0(0x18d)],'usdtTrcWallet':_0x423b2b[_0x1a6dd0(0x1bf)],'usdtErcWallet':_0x423b2b[_0x1a6dd0(0x17b)],'usdcPolygonWallet':_0x423b2b[_0x1a6dd0(0x1cb)]},'status':_0x423b2b['status'],'createdAt':_0x423b2b[_0x1a6dd0(0x19d)]};}async[a53_0x140604(0x1b4)](_0x17a54e,_0x1329a3){const _0x3dc34b=a53_0x140604,_0x19cc67={};_0x1329a3[_0x3dc34b(0x18d)]!==undefined&&(_0x19cc67[_0x3dc34b(0x18d)]=_0x1329a3[_0x3dc34b(0x18d)]||null),_0x1329a3['usdtTrcWallet']!==undefined&&(_0x19cc67['usdtTrcWallet']=_0x1329a3[_0x3dc34b(0x1bf)]||null),_0x1329a3[_0x3dc34b(0x17b)]!==undefined&&(_0x19cc67[_0x3dc34b(0x17b)]=_0x1329a3['usdtErcWallet']||null),_0x1329a3[_0x3dc34b(0x1cb)]!==undefined&&(_0x19cc67['usdcPolygonWallet']=_0x1329a3[_0x3dc34b(0x1cb)]||null),await database_1[_0x3dc34b(0x1c5)][_0x3dc34b(0x17e)][_0x3dc34b(0x1d8)]({'where':{'id':_0x17a54e},'data':_0x19cc67});}async['testWebhook'](_0x5e60fa){const _0x2ceb39=a53_0x140604,_0x50f5af=await database_1['default']['shop']['findUnique']({'where':{'id':_0x5e60fa},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x50f5af?.[_0x2ceb39(0x18a)]?.[_0x2ceb39(0x18f)])throw new Error(_0x2ceb39(0x197));const _0x2259dc={'event':_0x2ceb39(0x182),'payment':{'id':_0x2ceb39(0x1b6),'order_id':'test_order_123','gateway':_0x2ceb39(0x182),'amount':0x64,'currency':'USD','status':'paid','created_at':new Date()[_0x2ceb39(0x18b)]()}};try{const _0x4a64dd=await fetch(_0x50f5af['settings'][_0x2ceb39(0x18f)],{'method':_0x2ceb39(0x1f6),'headers':{'Content-Type':_0x2ceb39(0x20b),'User-Agent':_0x2ceb39(0x199)},'body':JSON[_0x2ceb39(0x1a6)](_0x2259dc)});return _0x4a64dd['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x4a64dd['status']+')'}:{'success':![],'message':_0x2ceb39(0x1e4)+_0x4a64dd[_0x2ceb39(0x194)]+'\x20'+_0x4a64dd[_0x2ceb39(0x189)]};}catch(_0x2266a4){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x2266a4 instanceof Error?_0x2266a4[_0x2ceb39(0x20c)]:_0x2ceb39(0x1f3))};}}async['createPayment'](_0x379222){const _0x45d5a7=a53_0x140604;return this['paymentService']['createPublicPayment']({'public_key':'','gateway':_0x379222['gateway'],'order_id':undefined,'amount':_0x379222[_0x45d5a7(0x17a)],'currency':_0x379222[_0x45d5a7(0x1de)],'source_currency':_0x379222[_0x45d5a7(0x192)],'usage':_0x379222[_0x45d5a7(0x1af)],'expires_at':_0x379222[_0x45d5a7(0x1db)]?.['toISOString'](),'success_url':_0x379222['redirectUrl'],'fail_url':_0x379222[_0x45d5a7(0x1ad)],'customer_email':_0x379222[_0x45d5a7(0x1ec)],'customer_name':_0x379222[_0x45d5a7(0x207)],'country':_0x379222['country'],'language':_0x379222['language'],'amount_is_editable':_0x379222[_0x45d5a7(0x1f8)],'max_payments':_0x379222[_0x45d5a7(0x1b8)],'customer':_0x379222[_0x45d5a7(0x17f)]});}async[a53_0x140604(0x184)](_0x1dfdb6,_0xb59918){const _0xb76f56=a53_0x140604;return this[_0xb76f56(0x1fa)][_0xb76f56(0x186)](_0x1dfdb6,_0xb59918);}async[a53_0x140604(0x1d0)](_0x381312,_0x1388c7){const _0x2d14b5=a53_0x140604;return this[_0x2d14b5(0x1fa)][_0x2d14b5(0x185)](_0x381312,_0x1388c7);}async['updatePayment'](_0x5066a4,_0x14c246,_0x5de3e0){const _0x37fe7d=a53_0x140604,_0x43c780=await database_1[_0x37fe7d(0x1c5)]['payment']['findFirst']({'where':{'id':_0x14c246,'shopId':_0x5066a4}});if(!_0x43c780)throw new Error(_0x37fe7d(0x1cf));const _0x142750=await database_1['default'][_0x37fe7d(0x1f7)][_0x37fe7d(0x1d8)]({'where':{'id':_0x14c246},'data':{..._0x5de3e0,'updatedAt':new Date()}});return _0x142750;}async[a53_0x140604(0x1d5)](_0x572a74,_0x9de111){const _0x1d47e6=a53_0x140604,_0x4d31f9=await database_1[_0x1d47e6(0x1c5)][_0x1d47e6(0x1f7)][_0x1d47e6(0x1fb)]({'where':{'id':_0x9de111,'shopId':_0x572a74}});if(!_0x4d31f9)throw new Error('Payment\x20not\x20found');await database_1[_0x1d47e6(0x1c5)][_0x1d47e6(0x1f7)][_0x1d47e6(0x1c6)]({'where':{'id':_0x9de111}});}[a53_0x140604(0x202)](_0x47957e){const _0x28078f=a53_0x140604,_0x5b19f9={'polygon':_0x28078f(0x1b3),'trc20':'USDT\x20TRC20','erc20':_0x28078f(0x1c7),'bsc':_0x28078f(0x200),'polygon_usdc':'USDC\x20Polygon'};return _0x5b19f9[_0x47957e]||_0x47957e;}async[a53_0x140604(0x19f)](_0x288add,_0x486a0f){const _0x1ce7aa=a53_0x140604,{page:_0x5e947f,limit:_0x32a6f5,status:_0x4ad9ad,method:_0x50cfec,dateFrom:_0x57f0c1,dateTo:_0x162a93,periodFrom:_0x3500f1,periodTo:_0x3637ee}=_0x486a0f,_0x7b78dc=(_0x5e947f-0x1)*_0x32a6f5,_0x575a18={'shopId':_0x288add};_0x4ad9ad&&(_0x575a18[_0x1ce7aa(0x194)]=_0x4ad9ad[_0x1ce7aa(0x1c1)]());_0x50cfec&&(_0x575a18[_0x1ce7aa(0x1dc)]=_0x50cfec);if(_0x57f0c1||_0x162a93||_0x3500f1||_0x3637ee){_0x575a18[_0x1ce7aa(0x19d)]={};if(_0x3500f1)_0x575a18[_0x1ce7aa(0x19d)][_0x1ce7aa(0x1be)]=new Date(_0x3500f1);else _0x57f0c1&&(_0x575a18['createdAt'][_0x1ce7aa(0x1be)]=new Date(_0x57f0c1));if(_0x3637ee)_0x575a18[_0x1ce7aa(0x19d)]['lte']=new Date(_0x3637ee);else _0x162a93&&(_0x575a18[_0x1ce7aa(0x19d)][_0x1ce7aa(0x1ca)]=new Date(_0x162a93));}const [_0x5bdd39,_0x3120b1]=await Promise['all']([database_1[_0x1ce7aa(0x1c5)][_0x1ce7aa(0x176)][_0x1ce7aa(0x1e0)]({'where':_0x575a18,'skip':_0x7b78dc,'take':_0x32a6f5,'orderBy':{'createdAt':_0x1ce7aa(0x18e)}}),database_1[_0x1ce7aa(0x1c5)]['payout']['count']({'where':_0x575a18})]);return{'payouts':_0x5bdd39['map'](_0x2b2103=>({'id':_0x2b2103['id'],'amount':_0x2b2103[_0x1ce7aa(0x17a)],'network':this[_0x1ce7aa(0x202)](_0x2b2103[_0x1ce7aa(0x1dc)]),'status':_0x2b2103['status'],'txid':_0x2b2103['txid'],'notes':_0x2b2103[_0x1ce7aa(0x203)],'periodFrom':_0x2b2103[_0x1ce7aa(0x1e1)],'periodTo':_0x2b2103[_0x1ce7aa(0x190)],'createdAt':_0x2b2103[_0x1ce7aa(0x19d)],'paidAt':_0x2b2103[_0x1ce7aa(0x1ab)]})),'pagination':{'page':_0x5e947f,'limit':_0x32a6f5,'total':_0x3120b1,'totalPages':Math[_0x1ce7aa(0x1b2)](_0x3120b1/_0x32a6f5)}};}async['getPayoutById'](_0x32c75e,_0x6e5b34){const _0x3a3716=a53_0x140604,_0x240c6d=await database_1['default'][_0x3a3716(0x176)][_0x3a3716(0x1fb)]({'where':{'id':_0x6e5b34,'shopId':_0x32c75e}});if(!_0x240c6d)return null;return{'id':_0x240c6d['id'],'amount':_0x240c6d[_0x3a3716(0x17a)],'network':_0x240c6d[_0x3a3716(0x1dc)],'status':_0x240c6d[_0x3a3716(0x194)],'txid':_0x240c6d[_0x3a3716(0x193)],'notes':_0x240c6d[_0x3a3716(0x203)],'createdAt':_0x240c6d[_0x3a3716(0x19d)],'paidAt':_0x240c6d['paidAt']};}async['getPayoutStatistics'](_0x1b9c0c,_0x30a9de){const _0x481d9c=a53_0x140604,_0x33c721=new Date();let _0x17c3aa;switch(_0x30a9de){case'7d':_0x17c3aa=new Date(_0x33c721['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x481d9c(0x1da):_0x17c3aa=new Date(_0x33c721[_0x481d9c(0x1df)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x481d9c(0x1dd):_0x17c3aa=new Date(_0x33c721[_0x481d9c(0x1df)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x17c3aa=new Date(_0x33c721[_0x481d9c(0x1df)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x5a6444,_0x34765d,_0x21a077,_0x5a6af0,_0x4af484,_0xf52052]=await Promise[_0x481d9c(0x1a8)]([database_1[_0x481d9c(0x1c5)][_0x481d9c(0x176)][_0x481d9c(0x1a4)]({'where':{'shopId':_0x1b9c0c,'createdAt':{'gte':_0x17c3aa}}}),database_1[_0x481d9c(0x1c5)][_0x481d9c(0x176)][_0x481d9c(0x1a4)]({'where':{'shopId':_0x1b9c0c,'status':_0x481d9c(0x1f4),'createdAt':{'gte':_0x17c3aa}}}),database_1[_0x481d9c(0x1c5)][_0x481d9c(0x176)][_0x481d9c(0x1a4)]({'where':{'shopId':_0x1b9c0c,'status':_0x481d9c(0x1a7),'createdAt':{'gte':_0x17c3aa}}}),database_1[_0x481d9c(0x1c5)][_0x481d9c(0x176)]['count']({'where':{'shopId':_0x1b9c0c,'status':_0x481d9c(0x1d6),'createdAt':{'gte':_0x17c3aa}}}),database_1['default'][_0x481d9c(0x176)][_0x481d9c(0x1e0)]({'where':{'shopId':_0x1b9c0c,'createdAt':{'gte':_0x17c3aa}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x481d9c(0x1c5)][_0x481d9c(0x176)][_0x481d9c(0x1e0)]({'where':{'shopId':_0x1b9c0c},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x2a41a1=_0x4af484[_0x481d9c(0x1ee)]((_0x11d967,_0x29a285)=>_0x11d967+_0x29a285[_0x481d9c(0x17a)],0x0),_0x12d420=_0x4af484[_0x481d9c(0x1d3)](_0x1fd464=>_0x1fd464['status']===_0x481d9c(0x1f4))[_0x481d9c(0x1ee)]((_0xbed1d4,_0x1fd7a2)=>_0xbed1d4+_0x1fd7a2[_0x481d9c(0x17a)],0x0),_0x4605df=_0x4af484[_0x481d9c(0x1d3)](_0x466148=>_0x466148[_0x481d9c(0x194)]==='PENDING')[_0x481d9c(0x1ee)]((_0x5b88a7,_0x2841e1)=>_0x5b88a7+_0x2841e1[_0x481d9c(0x17a)],0x0),_0x347005=_0x4af484[_0x481d9c(0x1ee)]((_0x3b0488,_0x103d8e)=>{const _0x4a2b61=_0x481d9c;return _0x3b0488[_0x103d8e[_0x4a2b61(0x1dc)]]=(_0x3b0488[_0x103d8e[_0x4a2b61(0x1dc)]]||0x0)+0x1,_0x3b0488;},{}),_0xa9fcea=_0x4af484['reduce']((_0x13ef44,_0x516f25)=>{const _0x2873ea=_0x481d9c;return _0x13ef44[_0x516f25[_0x2873ea(0x194)]]=(_0x13ef44[_0x516f25[_0x2873ea(0x194)]]||0x0)+0x1,_0x13ef44;},{});return{'totalPayouts':_0x5a6444,'completedPayouts':_0x34765d,'pendingPayouts':_0x21a077,'rejectedPayouts':_0x5a6af0,'totalAmount':_0x2a41a1,'completedAmount':_0x12d420,'pendingAmount':_0x4605df,'payoutsByMethod':_0x347005,'payoutsByStatus':_0xa9fcea,'recentPayouts':_0xf52052[_0x481d9c(0x1ea)](_0x299f2d=>({'id':_0x299f2d['id'],'shopId':_0x1b9c0c,'amount':_0x299f2d[_0x481d9c(0x17a)],'method':_0x299f2d[_0x481d9c(0x1dc)],'status':_0x299f2d[_0x481d9c(0x194)],'txid':_0x299f2d[_0x481d9c(0x193)],'createdAt':_0x299f2d['createdAt'],'paidAt':_0x299f2d[_0x481d9c(0x1ab)]}))};}async[a53_0x140604(0x198)](_0x3b9005){const _0x15662e=a53_0x140604;console['log'](_0x15662e(0x1cc)+_0x3b9005+_0x15662e(0x1bc));const _0x56e4cf=await database_1[_0x15662e(0x1c5)][_0x15662e(0x17e)][_0x15662e(0x191)]({'where':{'id':_0x3b9005},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x56e4cf)throw new Error('Shop\x20not\x20found');const _0x55ae23=new Date(),_0x1e8ec8=new Date(_0x55ae23[_0x15662e(0x204)](),_0x55ae23[_0x15662e(0x1aa)](),0x1),_0x17acb7=new Date(_0x55ae23['getFullYear'](),_0x55ae23[_0x15662e(0x1aa)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x206d1e=await database_1[_0x15662e(0x1c5)]['payout']['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x3b9005,'createdAt':{'gte':_0x1e8ec8,'lte':_0x17acb7},'status':'COMPLETED'}}),_0x49f43e=_0x206d1e[_0x15662e(0x1f0)][_0x15662e(0x17a)]||0x0,_0x4a036b={'availableBalance':Math[_0x15662e(0x1d4)](_0x56e4cf[_0x15662e(0x1ce)]*0x64)/0x64,'totalPaidOut':Math[_0x15662e(0x1d4)](_0x56e4cf[_0x15662e(0x196)]*0x64)/0x64,'awaitingPayout':Math[_0x15662e(0x1d4)](_0x56e4cf['balance']*0x64)/0x64,'thisMonth':Math['round'](_0x49f43e*0x64)/0x64};return console[_0x15662e(0x19c)](_0x15662e(0x1c8)+_0x56e4cf['username']+_0x15662e(0x1fe)),console['log'](_0x15662e(0x1a3)+_0x4a036b['availableBalance']+_0x15662e(0x1f5)),console[_0x15662e(0x19c)](_0x15662e(0x188)+_0x4a036b[_0x15662e(0x196)]+_0x15662e(0x1c3)),console[_0x15662e(0x19c)](_0x15662e(0x1b0)+_0x4a036b[_0x15662e(0x1c0)]+'\x20USDT\x20(current\x20balance)'),console['log'](_0x15662e(0x201)+_0x4a036b['thisMonth']+_0x15662e(0x1ff)),_0x4a036b;}[a53_0x140604(0x1f2)](_0x3c92e7){const _0xc0dcde=a53_0x140604,_0x18406e={'test_gateway':_0xc0dcde(0x1e9),'plisio':_0xc0dcde(0x1b7),'rapyd':'Rapyd','noda':_0xc0dcde(0x1a9),'cointopay':'CoinToPay','klyme_eu':'KLYME\x20EU','klyme_gb':_0xc0dcde(0x1d7),'klyme_de':'KLYME\x20DE'};return _0x18406e[_0x3c92e7]||_0x3c92e7;}async[a53_0x140604(0x1ae)](_0x15c089){return this['getShopPayoutStats'](_0x15c089);}async['getWebhookLogs'](_0x3961c6,_0x1a8720){const _0x167725=a53_0x140604,{page:_0x27ef7d,limit:_0x41fcc7,paymentId:_0x2d776e}=_0x1a8720,_0xaecdc7=(_0x27ef7d-0x1)*_0x41fcc7,_0x275b48={'shopId':_0x3961c6};_0x2d776e&&(_0x275b48['paymentId']=_0x2d776e);const [_0x2cf2f3,_0x1ffad4]=await Promise[_0x167725(0x1a8)]([database_1[_0x167725(0x1c5)][_0x167725(0x1d9)][_0x167725(0x1e0)]({'where':_0x275b48,'skip':_0xaecdc7,'take':_0x41fcc7,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x167725(0x1c5)][_0x167725(0x1d9)][_0x167725(0x1a4)]({'where':_0x275b48})]);return{'logs':_0x2cf2f3['map'](_0x46361d=>({'id':_0x46361d['id'],'paymentId':_0x46361d['paymentId'],'shopId':_0x46361d[_0x167725(0x179)],'event':_0x46361d[_0x167725(0x17d)],'statusCode':_0x46361d[_0x167725(0x1c9)],'retryCount':_0x46361d['retryCount'],'responseBody':_0x46361d[_0x167725(0x1b1)],'createdAt':_0x46361d['createdAt'],'payment':_0x46361d['payment']})),'pagination':{'page':_0x27ef7d,'limit':_0x41fcc7,'total':_0x1ffad4,'totalPages':Math[_0x167725(0x1b2)](_0x1ffad4/_0x41fcc7)}};}async[a53_0x140604(0x187)](_0x253020,_0x5c4934){const _0x20b563=a53_0x140604,_0x3ed5b7=new Date();let _0xf4f74f;switch(_0x5c4934){case'7d':_0xf4f74f=new Date(_0x3ed5b7['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x20b563(0x1da):_0xf4f74f=new Date(_0x3ed5b7[_0x20b563(0x1df)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x20b563(0x1dd):_0xf4f74f=new Date(_0x3ed5b7[_0x20b563(0x1df)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xf4f74f=new Date(_0x3ed5b7[_0x20b563(0x1df)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x164ac1,_0x5d9ffc,_0x3a50d4,_0x308db3,_0x4c6af0]=await Promise[_0x20b563(0x1a8)]([database_1[_0x20b563(0x1c5)][_0x20b563(0x1f7)][_0x20b563(0x1a4)]({'where':{'shopId':_0x253020,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0xf4f74f}}}),database_1[_0x20b563(0x1c5)][_0x20b563(0x1f7)]['count']({'where':{'shopId':_0x253020,'gateway':{'not':_0x20b563(0x1b5)},'status':_0x20b563(0x1f1),'createdAt':{'gte':_0xf4f74f}}}),database_1[_0x20b563(0x1c5)][_0x20b563(0x1f7)][_0x20b563(0x1e0)]({'where':{'shopId':_0x253020,'gateway':{'not':'test_gateway'},'status':_0x20b563(0x1f1),'createdAt':{'gte':_0xf4f74f}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x20b563(0x1c5)][_0x20b563(0x1f7)][_0x20b563(0x1e0)]({'where':{'shopId':_0x253020,'gateway':{'not':_0x20b563(0x1b5)}},'take':0xa,'orderBy':{'createdAt':_0x20b563(0x18e)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x20b563(0x1c5)][_0x20b563(0x1f7)]['findMany']({'where':{'shopId':_0x253020,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0xf4f74f}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x20b563(0x1ac)}})]);let _0x1e5560=0x0;for(const _0x3883b3 of _0x3a50d4){if(_0x3883b3[_0x20b563(0x208)])_0x1e5560+=_0x3883b3['amountUSDT'];else{const _0x44439b=await currencyService_1['currencyService'][_0x20b563(0x180)](_0x3883b3[_0x20b563(0x17a)],_0x3883b3[_0x20b563(0x1de)]);_0x1e5560+=_0x44439b;}}const _0x36dbc2=this['generateDailyStatistics'](_0x4c6af0,_0xf4f74f,_0x3ed5b7),_0x29f082=_0x164ac1>0x0?_0x5d9ffc/_0x164ac1*0x64:0x0;return{'totalPayments':_0x164ac1,'successfulPayments':_0x5d9ffc,'totalRevenue':Math[_0x20b563(0x1d4)](_0x1e5560*0x64)/0x64,'conversionRate':Math[_0x20b563(0x1d4)](_0x29f082*0x64)/0x64,'dailyRevenue':_0x36dbc2['dailyRevenue'],'dailyPayments':_0x36dbc2[_0x20b563(0x1a5)],'recentPayments':_0x308db3[_0x20b563(0x1ea)](_0x15c84b=>({'id':_0x15c84b['id'],'gateway':_0x15c84b[_0x20b563(0x19b)],'amount':_0x15c84b[_0x20b563(0x17a)],'currency':_0x15c84b['currency'],'status':_0x15c84b[_0x20b563(0x194)],'createdAt':_0x15c84b[_0x20b563(0x19d)]}))};}[a53_0x140604(0x1cd)](_0x8c1579,_0x1d5749,_0x1c7583){const _0x17eab4=a53_0x140604,_0x2dc1c7=new Map(),_0x5ba10a=new Date(_0x1d5749);while(_0x5ba10a<=_0x1c7583){const _0x3d7642=_0x5ba10a['toISOString']()[_0x17eab4(0x1d1)]('T')[0x0];_0x2dc1c7['set'](_0x3d7642,{'revenue':0x0,'count':0x0}),_0x5ba10a[_0x17eab4(0x1eb)](_0x5ba10a['getDate']()+0x1);}for(const _0x449cec of _0x8c1579){const _0x348df0=_0x449cec[_0x17eab4(0x19d)]['toISOString']()['split']('T')[0x0],_0x2a36b6=_0x2dc1c7['get'](_0x348df0);_0x2a36b6&&(_0x2a36b6[_0x17eab4(0x1a4)]+=0x1,_0x449cec[_0x17eab4(0x194)]==='PAID'&&_0x449cec['amountUSDT']&&(_0x2a36b6['revenue']+=_0x449cec[_0x17eab4(0x208)]));}const _0x257f47=[],_0x9afe37=[];for(const [_0x4b3901,_0x3dfb53]of _0x2dc1c7){_0x257f47[_0x17eab4(0x174)]({'date':_0x4b3901,'amount':Math['round'](_0x3dfb53[_0x17eab4(0x183)]*0x64)/0x64}),_0x9afe37['push']({'date':_0x4b3901,'count':_0x3dfb53[_0x17eab4(0x1a4)]});}return{'dailyRevenue':_0x257f47,'dailyPayments':_0x9afe37};}}exports['ShopService']=ShopService;