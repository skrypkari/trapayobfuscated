'use strict';const a48_0x27377a=a48_0x3d6d;(function(_0x361bea,_0x26178f){const _0x24358b=a48_0x3d6d,_0x3945d3=_0x361bea();while(!![]){try{const _0x24644c=-parseInt(_0x24358b(0x20e))/0x1*(parseInt(_0x24358b(0x25a))/0x2)+parseInt(_0x24358b(0x1f4))/0x3*(parseInt(_0x24358b(0x1d9))/0x4)+parseInt(_0x24358b(0x1d0))/0x5*(-parseInt(_0x24358b(0x262))/0x6)+parseInt(_0x24358b(0x1da))/0x7*(parseInt(_0x24358b(0x240))/0x8)+parseInt(_0x24358b(0x1be))/0x9+parseInt(_0x24358b(0x1c8))/0xa*(-parseInt(_0x24358b(0x1b5))/0xb)+-parseInt(_0x24358b(0x248))/0xc;if(_0x24644c===_0x26178f)break;else _0x3945d3['push'](_0x3945d3['shift']());}catch(_0x1b43a6){_0x3945d3['push'](_0x3945d3['shift']());}}}(a48_0x585a,0x67942));var __importDefault=this&&this['__importDefault']||function(_0x3e21ad){const _0x16aa11=a48_0x3d6d;return _0x3e21ad&&_0x3e21ad[_0x16aa11(0x231)]?_0x3e21ad:{'default':_0x3e21ad};};Object[a48_0x27377a(0x21b)](exports,'__esModule',{'value':!![]}),exports[a48_0x27377a(0x228)]=void 0x0;function a48_0x3d6d(_0x384333,_0x541d7d){const _0x585a27=a48_0x585a();return a48_0x3d6d=function(_0x3d6d90,_0x48f4c0){_0x3d6d90=_0x3d6d90-0x1a2;let _0x531a3f=_0x585a27[_0x3d6d90];return _0x531a3f;},a48_0x3d6d(_0x384333,_0x541d7d);}const database_1=__importDefault(require(a48_0x27377a(0x1ad))),plisioService_1=require(a48_0x27377a(0x1cc)),rapydService_1=require(a48_0x27377a(0x258)),nodaService_1=require(a48_0x27377a(0x20a)),coinToPayService_1=require(a48_0x27377a(0x275)),klymeService_1=require('./gateways/klymeService'),currencyService_1=require(a48_0x27377a(0x1fa)),gateway_1=require(a48_0x27377a(0x1cf));class ShopService{constructor(){const _0x532734=a48_0x27377a;this[_0x532734(0x1f2)]=new plisioService_1[(_0x532734(0x1c3))](),this[_0x532734(0x226)]=new rapydService_1[(_0x532734(0x1eb))](),this[_0x532734(0x1b6)]=new nodaService_1['NodaService'](),this[_0x532734(0x1b3)]=new coinToPayService_1[(_0x532734(0x1bc))](),this[_0x532734(0x268)]=new klymeService_1[(_0x532734(0x256))]();}async['generateGatewayOrderId'](){const _0x124c6d=a48_0x27377a;let _0x5cc39c,_0x5277a3=0x0;const _0x453463=0xa;do{const _0x39d14a=()=>{const _0x251dd9=a48_0x3d6d;return Math[_0x251dd9(0x25e)](Math[_0x251dd9(0x23d)]()*0x5f5e100)['toString']()[_0x251dd9(0x24e)](0x8,'0');};_0x5cc39c=_0x39d14a()+'-'+_0x39d14a();const _0x39fa6d=await database_1[_0x124c6d(0x207)][_0x124c6d(0x1bf)][_0x124c6d(0x1e8)]({'where':{'gatewayOrderId':_0x5cc39c}});if(!_0x39fa6d)break;_0x5277a3++,console['log'](_0x124c6d(0x249)+_0x5cc39c+_0x124c6d(0x1ab)+_0x5277a3+')');}while(_0x5277a3<_0x453463);if(_0x5277a3>=_0x453463)throw new Error(_0x124c6d(0x243));return _0x5cc39c;}['generateGatewayUrls'](_0x15ff37,_0x3a027c,_0x246439,_0x284bdf,_0x22d233){const _0x4a4cc2=a48_0x27377a;if(_0x284bdf&&_0x22d233)return{'finalSuccessUrl':_0x284bdf,'finalFailUrl':_0x22d233};let _0x115a30,_0x36d6ee;return _0x15ff37==='noda'||_0x15ff37['startsWith'](_0x4a4cc2(0x1db))?_0x115a30=_0x284bdf||_0x246439+_0x4a4cc2(0x1c1)+_0x3a027c:_0x115a30=_0x284bdf||_0x246439+_0x4a4cc2(0x1f1)+_0x3a027c,_0x36d6ee=_0x22d233||_0x246439+_0x4a4cc2(0x272)+_0x3a027c,console[_0x4a4cc2(0x1e0)](_0x4a4cc2(0x21a)+_0x15ff37+':'),console[_0x4a4cc2(0x1e0)](_0x4a4cc2(0x1ef)+_0x115a30),console[_0x4a4cc2(0x1e0)]('\x20\x20\x20âŒ\x20Fail:\x20'+_0x36d6ee),{'finalSuccessUrl':_0x115a30,'finalFailUrl':_0x36d6ee};}[a48_0x27377a(0x1e9)](_0x23ff46,_0x28f9f0){const _0x3e672c=a48_0x27377a,_0x1ab655=_0x23ff46[_0x3e672c(0x1fc)]?JSON['parse'](_0x23ff46[_0x3e672c(0x1fc)]):null,_0x13cd15=_0x28f9f0[_0x3e672c(0x1f6)](0x0)[_0x3e672c(0x257)]()+_0x28f9f0[_0x3e672c(0x1de)](0x1)[_0x3e672c(0x225)]();if(_0x1ab655&&_0x1ab655[_0x13cd15])return{'commission':_0x1ab655[_0x13cd15][_0x3e672c(0x26f)],'payoutDelay':_0x1ab655[_0x13cd15][_0x3e672c(0x1ea)]};return{'commission':0x0,'payoutDelay':0x0};}[a48_0x27377a(0x245)](_0x1bd097,_0x504c1e){const _0x54b91a=a48_0x27377a;if(_0x1bd097[_0x54b91a(0x210)]!==_0x54b91a(0x281)||_0x1bd097[_0x54b91a(0x23a)]||!_0x1bd097['paidAt'])return![];const _0x571707=_0x504c1e[_0x54b91a(0x1ea)]*0x18*0x3c*0x3c*0x3e8,_0x37e29b=new Date(_0x1bd097[_0x54b91a(0x1df)][_0x54b91a(0x1b4)]()+_0x571707);return new Date()>_0x37e29b;}[a48_0x27377a(0x25b)](_0x4577a7,_0x272e8f){return _0x4577a7*(0x1-_0x272e8f/0x64);}async[a48_0x27377a(0x286)](_0xaaf6d6){const _0xf0aca6=a48_0x27377a,_0x49d3cf=await database_1[_0xf0aca6(0x207)][_0xf0aca6(0x1bd)][_0xf0aca6(0x1ac)]({'where':{'id':_0xaaf6d6},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x49d3cf)throw new Error(_0xf0aca6(0x24c));return{'id':_0x49d3cf['id'],'fullName':_0x49d3cf[_0xf0aca6(0x1ed)],'username':_0x49d3cf[_0xf0aca6(0x278)],'telegramId':_0x49d3cf[_0xf0aca6(0x261)],'merchantUrl':_0x49d3cf[_0xf0aca6(0x22a)],'gateways':_0x49d3cf['paymentGateways']?JSON[_0xf0aca6(0x1a3)](_0x49d3cf[_0xf0aca6(0x212)]):null,'gatewaySettings':_0x49d3cf[_0xf0aca6(0x1fc)]?JSON['parse'](_0x49d3cf[_0xf0aca6(0x1fc)]):null,'publicKey':_0x49d3cf['publicKey'],'wallets':{'usdtPolygonWallet':_0x49d3cf[_0xf0aca6(0x20f)],'usdtTrcWallet':_0x49d3cf[_0xf0aca6(0x277)],'usdtErcWallet':_0x49d3cf[_0xf0aca6(0x211)],'usdcPolygonWallet':_0x49d3cf[_0xf0aca6(0x285)]},'status':_0x49d3cf['status'],'createdAt':_0x49d3cf[_0xf0aca6(0x223)]};}async[a48_0x27377a(0x218)](_0x2d52c1,_0x2a71da){const _0x30251d=a48_0x27377a,_0x16fc42={..._0x2a71da};_0x2a71da['fullName']&&(_0x16fc42[_0x30251d(0x1ed)]=_0x2a71da[_0x30251d(0x23b)],delete _0x16fc42[_0x30251d(0x23b)]);_0x2a71da[_0x30251d(0x1e7)]&&(_0x16fc42[_0x30251d(0x261)]=_0x2a71da[_0x30251d(0x1e7)],delete _0x16fc42[_0x30251d(0x1e7)]);_0x2a71da[_0x30251d(0x230)]&&(_0x16fc42['shopUrl']=_0x2a71da[_0x30251d(0x230)],delete _0x16fc42[_0x30251d(0x230)]);_0x2a71da['gateways']&&(_0x16fc42['paymentGateways']=JSON[_0x30251d(0x24a)](_0x2a71da[_0x30251d(0x263)]),delete _0x16fc42[_0x30251d(0x263)]);_0x2a71da[_0x30251d(0x1fc)]&&(_0x16fc42[_0x30251d(0x1fc)]=JSON[_0x30251d(0x24a)](_0x2a71da[_0x30251d(0x1fc)]),delete _0x16fc42[_0x30251d(0x1fc)]);_0x2a71da[_0x30251d(0x21f)]&&(_0x2a71da[_0x30251d(0x21f)]['usdtPolygonWallet']!==undefined&&(_0x16fc42[_0x30251d(0x20f)]=_0x2a71da[_0x30251d(0x21f)][_0x30251d(0x20f)]||null),_0x2a71da['wallets']['usdtTrcWallet']!==undefined&&(_0x16fc42[_0x30251d(0x277)]=_0x2a71da[_0x30251d(0x21f)]['usdtTrcWallet']||null),_0x2a71da[_0x30251d(0x21f)][_0x30251d(0x211)]!==undefined&&(_0x16fc42[_0x30251d(0x211)]=_0x2a71da[_0x30251d(0x21f)]['usdtErcWallet']||null),_0x2a71da[_0x30251d(0x21f)][_0x30251d(0x285)]!==undefined&&(_0x16fc42[_0x30251d(0x285)]=_0x2a71da[_0x30251d(0x21f)]['usdcPolygonWallet']||null),delete _0x16fc42['wallets']);const _0x21193e=await database_1['default'][_0x30251d(0x1bd)]['update']({'where':{'id':_0x2d52c1},'data':_0x16fc42,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x21193e['id'],'fullName':_0x21193e[_0x30251d(0x1ed)],'username':_0x21193e[_0x30251d(0x278)],'telegramId':_0x21193e[_0x30251d(0x261)],'merchantUrl':_0x21193e['shopUrl'],'gateways':_0x21193e['paymentGateways']?JSON['parse'](_0x21193e[_0x30251d(0x212)]):null,'gatewaySettings':_0x21193e[_0x30251d(0x1fc)]?JSON[_0x30251d(0x1a3)](_0x21193e['gatewaySettings']):null,'publicKey':_0x21193e[_0x30251d(0x1e1)],'wallets':{'usdtPolygonWallet':_0x21193e[_0x30251d(0x20f)],'usdtTrcWallet':_0x21193e['usdtTrcWallet'],'usdtErcWallet':_0x21193e['usdtErcWallet'],'usdcPolygonWallet':_0x21193e['usdcPolygonWallet']},'status':_0x21193e[_0x30251d(0x210)],'createdAt':_0x21193e[_0x30251d(0x223)]};}async[a48_0x27377a(0x255)](_0x39933f,_0x1472c4){const _0x20771b=a48_0x27377a,_0xc00abd={};_0x1472c4[_0x20771b(0x20f)]!==undefined&&(_0xc00abd[_0x20771b(0x20f)]=_0x1472c4[_0x20771b(0x20f)]||null),_0x1472c4[_0x20771b(0x277)]!==undefined&&(_0xc00abd[_0x20771b(0x277)]=_0x1472c4[_0x20771b(0x277)]||null),_0x1472c4[_0x20771b(0x211)]!==undefined&&(_0xc00abd['usdtErcWallet']=_0x1472c4[_0x20771b(0x211)]||null),_0x1472c4[_0x20771b(0x285)]!==undefined&&(_0xc00abd[_0x20771b(0x285)]=_0x1472c4['usdcPolygonWallet']||null),await database_1['default']['shop'][_0x20771b(0x213)]({'where':{'id':_0x39933f},'data':_0xc00abd});}async[a48_0x27377a(0x244)](_0x1e170d){const _0x3a23ce=a48_0x27377a,_0x52f48e=await database_1[_0x3a23ce(0x207)][_0x3a23ce(0x1bd)][_0x3a23ce(0x1ac)]({'where':{'id':_0x1e170d},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x52f48e)throw new Error(_0x3a23ce(0x24c));const _0x4fb184=_0x52f48e[_0x3a23ce(0x1c5)]?.[_0x3a23ce(0x1ce)];if(!_0x4fb184)throw new Error(_0x3a23ce(0x250));const _0x4cc5fe=await this['generateGatewayOrderId'](),_0x58cc31={'event':'payment.success','payment':{'id':_0x3a23ce(0x1fd)+Date[_0x3a23ce(0x1a8)](),'order_id':null,'gateway_order_id':_0x4cc5fe,'gateway':_0x3a23ce(0x1b9),'amount':0x64,'currency':'USD','status':_0x3a23ce(0x25c),'customer_email':_0x3a23ce(0x24f),'customer_name':'Test\x20Customer','created_at':new Date()[_0x3a23ce(0x279)](),'updated_at':new Date()[_0x3a23ce(0x279)]()},'test':!![],'shop':{'id':_0x52f48e['id'],'name':_0x52f48e['name']},'timestamp':new Date()[_0x3a23ce(0x279)]()},_0x5dd70a=Date[_0x3a23ce(0x1a8)]();let _0x1c6911=0x0,_0x32311a=![],_0x36cfc9;try{console['log'](_0x3a23ce(0x25d)+_0x4fb184),console[_0x3a23ce(0x1e0)](_0x3a23ce(0x1b7),JSON['stringify'](_0x58cc31,null,0x2));const _0x5c2143=await fetch(_0x4fb184,{'method':_0x3a23ce(0x259),'headers':{'Content-Type':'application/json','User-Agent':_0x3a23ce(0x20c),'X-Webhook-Test':_0x3a23ce(0x203)},'body':JSON[_0x3a23ce(0x24a)](_0x58cc31)});_0x1c6911=_0x5c2143[_0x3a23ce(0x210)],_0x32311a=_0x5c2143['ok'];if(!_0x5c2143['ok']){const _0x235cd0=await _0x5c2143['text']();_0x36cfc9=_0x3a23ce(0x202)+_0x5c2143[_0x3a23ce(0x210)]+':\x20'+_0x235cd0,console[_0x3a23ce(0x1f8)](_0x3a23ce(0x1c0)+_0x36cfc9);}else console[_0x3a23ce(0x1e0)](_0x3a23ce(0x1d3)+_0x5c2143[_0x3a23ce(0x210)]);}catch(_0x845948){_0x36cfc9=_0x845948 instanceof Error?_0x845948['message']:'Unknown\x20error',console['error']('âŒ\x20Test\x20webhook\x20error:\x20'+_0x36cfc9);}const _0xdae212=Date[_0x3a23ce(0x1a8)]()-_0x5dd70a;try{await database_1[_0x3a23ce(0x207)][_0x3a23ce(0x26b)][_0x3a23ce(0x1dd)]({'data':{'paymentId':'test_webhook','shopId':_0x52f48e['id'],'event':'test_webhook','statusCode':_0x1c6911,'responseBody':JSON[_0x3a23ce(0x24a)]({'success':_0x32311a,'error':_0x36cfc9,'responseTime':_0xdae212,'testPayload':_0x58cc31})}});}catch(_0x472a75){console[_0x3a23ce(0x1f8)]('Failed\x20to\x20log\x20test\x20webhook:',_0x472a75);}return{'webhookUrl':_0x4fb184,'statusCode':_0x1c6911,'responseTime':_0xdae212,'success':_0x32311a,'error':_0x36cfc9};}async[a48_0x27377a(0x1d5)](_0x34a337){const _0x52808=a48_0x27377a;let _0x128519;if((0x0,gateway_1['isValidGatewayId'])(_0x34a337['gateway'])){const _0x1f5b38=(0x0,gateway_1['getGatewayNameById'])(_0x34a337[_0x52808(0x1b2)]);if(!_0x1f5b38)throw new Error(_0x52808(0x246)+_0x34a337[_0x52808(0x1b2)]);_0x128519=_0x1f5b38;}else _0x128519=_0x34a337[_0x52808(0x1b2)][_0x52808(0x225)]();console[_0x52808(0x1e0)]('ðŸ”„\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20'+_0x128519);const _0x51cfab=await this[_0x52808(0x271)]();console[_0x52808(0x1e0)]('ðŸŽ¯\x20Generated\x20unique\x20gateway\x20order_id:\x20'+_0x51cfab+_0x52808(0x1b8)+_0x128519+')');const _0x23ec5f=await database_1[_0x52808(0x207)][_0x52808(0x1bd)][_0x52808(0x1ac)]({'where':{'id':_0x34a337['shopId']},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x23ec5f)throw new Error('Shop\x20not\x20found');const _0x35a736=this[_0x52808(0x1e9)](_0x23ec5f,_0x128519),_0xa96b4a=process['env'][_0x52808(0x27a)]||'https://tesoft.uk',{finalSuccessUrl:_0x290226,finalFailUrl:_0x265f77}=this[_0x52808(0x1d7)](_0x128519,_0x51cfab,_0xa96b4a,_0x34a337[_0x52808(0x21e)],undefined),_0x1e39ea=await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x1dd)]({'data':{'shopId':_0x34a337['shopId'],'gateway':_0x128519,'amount':_0x34a337[_0x52808(0x26e)],'currency':_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),'sourceCurrency':_0x34a337[_0x52808(0x216)]||null,'usage':_0x34a337[_0x52808(0x1c4)]||_0x52808(0x1e3),'expiresAt':_0x34a337['expiresAt'],'successUrl':_0x290226,'failUrl':_0x265f77,'status':'PENDING','orderId':null,'gatewayOrderId':_0x51cfab,'customerEmail':_0x34a337[_0x52808(0x233)]||null,'customerName':_0x34a337['customerName']||null,'country':_0x34a337['country']||null,'language':_0x34a337[_0x52808(0x265)]||null,'amountIsEditable':_0x34a337[_0x52808(0x222)]||null,'maxPayments':_0x34a337[_0x52808(0x24d)]||null,'rapydCustomer':_0x34a337[_0x52808(0x1f5)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console['log']('ðŸ’¾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20'+_0x51cfab+_0x52808(0x264));let _0x38eb55;try{if(_0x128519===_0x52808(0x1b9)){let _0x241f96,_0x30b3f9,_0x352cda;_0x34a337['sourceCurrency']?(_0x241f96=_0x34a337[_0x52808(0x216)],_0x30b3f9=_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),_0x352cda=![]):(_0x241f96=_0x52808(0x270),_0x30b3f9=_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),_0x352cda=!![]);const _0x298235=await this[_0x52808(0x1f2)]['createPayment']({'paymentId':_0x1e39ea['id'],'orderId':_0x51cfab,'amount':_0x34a337['amount'],'currency':_0x241f96,'productName':'Order\x20ID:\x20'+_0x51cfab,'description':_0x52808(0x27b)+_0x51cfab,'successUrl':_0x290226,'failUrl':_0x265f77,'customerEmail':_0x34a337[_0x52808(0x233)],'customerName':_0x34a337['customerName'],'isSourceCurrency':_0x352cda});_0x38eb55=_0x298235[_0x52808(0x1aa)],await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'externalPaymentUrl':_0x38eb55,'gatewayPaymentId':_0x298235[_0x52808(0x234)],'invoiceTotalSum':Number(_0x298235[_0x52808(0x274)]),'qrCode':_0x298235['qr_code'],'qrUrl':_0x298235[_0x52808(0x1c7)]}}),_0x1e39ea[_0x52808(0x26c)]=_0x38eb55,_0x1e39ea[_0x52808(0x239)]=_0x298235[_0x52808(0x234)];}else{if(_0x128519===_0x52808(0x27d)){const _0x4d6ba5='GB';console[_0x52808(0x1e0)](_0x52808(0x215));const _0x2545e5=await this[_0x52808(0x226)][_0x52808(0x27c)]({'paymentId':_0x1e39ea['id'],'orderId':_0x51cfab,'orderName':'Order\x20ID:\x20'+_0x51cfab,'amount':_0x34a337['amount'],'currency':_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),'country':_0x4d6ba5,'usage':_0x34a337[_0x52808(0x1c4)]||_0x52808(0x1e3),'maxPayments':_0x34a337['maxPayments'],'successUrl':_0x290226,'failUrl':_0x265f77});_0x38eb55=_0x2545e5[_0x52808(0x1aa)],await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'externalPaymentUrl':_0x38eb55,'gatewayPaymentId':_0x2545e5[_0x52808(0x234)],'country':_0x4d6ba5}}),_0x1e39ea['externalPaymentUrl']=_0x38eb55,_0x1e39ea[_0x52808(0x239)]=_0x2545e5[_0x52808(0x234)];}else{if(_0x128519===_0x52808(0x1e4)){console['log']('ðŸ”„\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20'+_0x51cfab+_0x52808(0x264));const _0x16b3cb=await this['nodaService'][_0x52808(0x27c)]({'paymentId':_0x1e39ea['id'],'orderId':_0x51cfab,'name':_0x52808(0x27b)+_0x51cfab,'paymentDescription':_0x52808(0x27b)+_0x51cfab,'amount':_0x34a337['amount'],'currency':_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),'webhookUrl':_0x52808(0x1f9),'returnUrl':_0x290226,'expiryDate':_0x34a337['expiresAt']?.['toISOString']()});_0x38eb55=_0x16b3cb[_0x52808(0x1aa)],await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'externalPaymentUrl':_0x38eb55,'gatewayPaymentId':_0x16b3cb[_0x52808(0x234)],'qrUrl':_0x16b3cb['qr_code_url']}}),_0x1e39ea['externalPaymentUrl']=_0x38eb55,_0x1e39ea[_0x52808(0x239)]=_0x16b3cb[_0x52808(0x234)],console[_0x52808(0x1e0)](_0x52808(0x266)+_0x51cfab);}else{if(_0x128519==='cointopay'){console['log']('ðŸª™\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20'+_0x51cfab+_0x52808(0x264)),console[_0x52808(0x1e0)](_0x52808(0x1d2)+_0x34a337[_0x52808(0x26e)]+_0x52808(0x1e5));const _0x5203a9=await this[_0x52808(0x1b3)][_0x52808(0x27c)]({'paymentId':_0x1e39ea['id'],'orderId':_0x51cfab,'amount':_0x34a337[_0x52808(0x26e)]});_0x38eb55=_0x5203a9[_0x52808(0x1aa)],await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'externalPaymentUrl':_0x38eb55,'gatewayPaymentId':_0x5203a9['gateway_payment_id'],'currency':_0x52808(0x1dc)}}),_0x1e39ea[_0x52808(0x26c)]=_0x38eb55,_0x1e39ea[_0x52808(0x239)]=_0x5203a9[_0x52808(0x234)],console['log']('âœ…\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x51cfab);}else{if(_0x128519['startsWith'](_0x52808(0x1db))){const _0x291cef=(0x0,gateway_1[_0x52808(0x205)])(_0x128519);if(!_0x291cef)throw new Error(_0x52808(0x1d6)+_0x128519);if(_0x291cef!=='EU'&&_0x291cef!=='GB')throw new Error(_0x52808(0x1c6)+_0x291cef);console[_0x52808(0x1e0)]('ðŸ’³\x20Creating\x20KLYME\x20'+_0x291cef+_0x52808(0x260)+_0x51cfab+'\x20(8digits-8digits\x20format)'),console[_0x52808(0x1e0)](_0x52808(0x1d2)+_0x34a337[_0x52808(0x26e)]+'\x20'+(_0x34a337[_0x52808(0x23e)]||_0x52808(0x270)));const _0x435256=await this[_0x52808(0x268)][_0x52808(0x27c)]({'paymentId':_0x1e39ea['id'],'orderId':_0x51cfab,'amount':_0x34a337[_0x52808(0x26e)],'currency':_0x34a337[_0x52808(0x23e)]||_0x52808(0x270),'region':_0x291cef,'redirectUrl':_0x290226});_0x38eb55=_0x435256[_0x52808(0x1aa)],await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'externalPaymentUrl':_0x38eb55,'gatewayPaymentId':_0x435256['gateway_payment_id']}}),_0x1e39ea['externalPaymentUrl']=_0x38eb55,_0x1e39ea[_0x52808(0x239)]=_0x435256['gateway_payment_id'],console[_0x52808(0x1e0)](_0x52808(0x21d)+_0x291cef+_0x52808(0x209)+_0x51cfab);}}}}}}catch(_0x2c729e){await database_1[_0x52808(0x207)][_0x52808(0x1bf)][_0x52808(0x213)]({'where':{'id':_0x1e39ea['id']},'data':{'status':_0x52808(0x227)}}),console[_0x52808(0x1f8)]('Gateway\x20error\x20during\x20shop\x20payment\x20creation:',_0x2c729e);}const _0x466593=_0x52808(0x22f)+_0x1e39ea['id'];return{'id':_0x1e39ea['id'],'shopId':_0x1e39ea['shopId'],'gateway':_0x1e39ea[_0x52808(0x1b2)],'amount':_0x1e39ea['amount'],'currency':_0x1e39ea[_0x52808(0x23e)],'sourceCurrency':_0x1e39ea[_0x52808(0x216)],'usage':_0x1e39ea[_0x52808(0x1c4)],'expiresAt':_0x1e39ea[_0x52808(0x1a4)],'redirectUrl':_0x466593,'status':_0x1e39ea[_0x52808(0x210)],'externalPaymentUrl':_0x38eb55,'customerEmail':_0x1e39ea['customerEmail'],'customerName':_0x1e39ea[_0x52808(0x1bb)],'country':_0x1e39ea[_0x52808(0x25f)],'language':_0x1e39ea['language'],'amountIsEditable':_0x1e39ea[_0x52808(0x222)],'maxPayments':_0x1e39ea[_0x52808(0x24d)],'customer':_0x1e39ea[_0x52808(0x254)],'createdAt':_0x1e39ea[_0x52808(0x223)],'updatedAt':_0x1e39ea[_0x52808(0x1d4)],'shop':_0x1e39ea['shop']};}async[a48_0x27377a(0x1f7)](_0x309e86,_0x439932){const _0x112c3f=a48_0x27377a,{page:_0x5d8b4d,limit:_0xbf7b46,status:_0x3bcd55,gateway:_0x3729eb}=_0x439932,_0x113882=(_0x5d8b4d-0x1)*_0xbf7b46,_0x354463={'shopId':_0x309e86};_0x3bcd55&&(_0x354463[_0x112c3f(0x210)]=_0x3bcd55);if(_0x3729eb){if((0x0,gateway_1[_0x112c3f(0x238)])(_0x3729eb)){const _0x48e462=(0x0,gateway_1['getGatewayNameById'])(_0x3729eb);_0x48e462&&(_0x354463['gateway']=_0x48e462);}else _0x354463['gateway']=_0x3729eb['toLowerCase']();}const [_0x595cee,_0xac72b5]=await Promise[_0x112c3f(0x1ba)]([database_1[_0x112c3f(0x207)][_0x112c3f(0x1bf)]['findMany']({'where':_0x354463,'skip':_0x113882,'take':_0xbf7b46,'orderBy':{'createdAt':_0x112c3f(0x1d8)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1['default']['payment'][_0x112c3f(0x229)]({'where':_0x354463})]);return{'payments':_0x595cee[_0x112c3f(0x219)](_0x42aab6=>{const _0x4382d9=_0x112c3f,_0x5ed13c=_0x4382d9(0x22f)+_0x42aab6['id'];return{'id':_0x42aab6['id'],'shopId':_0x42aab6[_0x4382d9(0x1e2)],'gateway':_0x42aab6[_0x4382d9(0x1b2)],'amount':_0x42aab6[_0x4382d9(0x26e)],'currency':_0x42aab6[_0x4382d9(0x23e)],'sourceCurrency':_0x42aab6[_0x4382d9(0x216)],'usage':_0x42aab6[_0x4382d9(0x1c4)],'expiresAt':_0x42aab6['expiresAt'],'redirectUrl':_0x5ed13c,'status':_0x42aab6[_0x4382d9(0x210)],'externalPaymentUrl':_0x42aab6['externalPaymentUrl'],'customerEmail':_0x42aab6[_0x4382d9(0x233)],'customerName':_0x42aab6['customerName'],'country':_0x42aab6[_0x4382d9(0x25f)],'language':_0x42aab6[_0x4382d9(0x265)],'amountIsEditable':_0x42aab6['amountIsEditable'],'maxPayments':_0x42aab6[_0x4382d9(0x24d)],'customer':_0x42aab6[_0x4382d9(0x254)],'createdAt':_0x42aab6[_0x4382d9(0x223)],'updatedAt':_0x42aab6[_0x4382d9(0x1d4)],'shop':_0x42aab6['shop']};}),'pagination':{'page':_0x5d8b4d,'limit':_0xbf7b46,'total':_0xac72b5,'totalPages':Math[_0x112c3f(0x26a)](_0xac72b5/_0xbf7b46)}};}async[a48_0x27377a(0x1b0)](_0x114ad3,_0x23d0b7){const _0x193f99=a48_0x27377a,_0x59a7de=await database_1[_0x193f99(0x207)][_0x193f99(0x1bf)][_0x193f99(0x1e8)]({'where':{'id':_0x23d0b7,'shopId':_0x114ad3},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x193f99(0x1d8)},'take':0xa}}});if(!_0x59a7de)return null;const _0x27b8f8=_0x193f99(0x22f)+_0x59a7de['id'];return{'id':_0x59a7de['id'],'shopId':_0x59a7de[_0x193f99(0x1e2)],'gateway':_0x59a7de[_0x193f99(0x1b2)],'amount':_0x59a7de[_0x193f99(0x26e)],'currency':_0x59a7de[_0x193f99(0x23e)],'sourceCurrency':_0x59a7de[_0x193f99(0x216)],'usage':_0x59a7de[_0x193f99(0x1c4)],'expiresAt':_0x59a7de[_0x193f99(0x1a4)],'redirectUrl':_0x27b8f8,'status':_0x59a7de['status'],'externalPaymentUrl':_0x59a7de[_0x193f99(0x26c)],'customerEmail':_0x59a7de[_0x193f99(0x233)],'customerName':_0x59a7de['customerName'],'country':_0x59a7de[_0x193f99(0x25f)],'language':_0x59a7de['language'],'amountIsEditable':_0x59a7de['amountIsEditable'],'maxPayments':_0x59a7de[_0x193f99(0x24d)],'customer':_0x59a7de['rapydCustomer'],'createdAt':_0x59a7de[_0x193f99(0x223)],'updatedAt':_0x59a7de[_0x193f99(0x1d4)],'shop':_0x59a7de['shop'],'webhookLogs':_0x59a7de[_0x193f99(0x269)]};}async['updatePayment'](_0x2bfbc,_0x2e1f13,_0x53cc47){const _0x4c3ef1=a48_0x27377a,_0x3078f4={..._0x53cc47};if(_0x53cc47[_0x4c3ef1(0x1b2)]){if((0x0,gateway_1[_0x4c3ef1(0x238)])(_0x53cc47['gateway'])){const _0x146f12=(0x0,gateway_1['getGatewayNameById'])(_0x53cc47[_0x4c3ef1(0x1b2)]);_0x146f12&&(_0x3078f4['gateway']=_0x146f12);}else _0x3078f4[_0x4c3ef1(0x1b2)]=_0x53cc47['gateway'][_0x4c3ef1(0x225)]();}const _0x3eaf01=await database_1['default']['payment'][_0x4c3ef1(0x213)]({'where':{'id':_0x2e1f13,'shopId':_0x2bfbc},'data':_0x3078f4,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x4dae03=_0x4c3ef1(0x22f)+_0x3eaf01['id'];return{'id':_0x3eaf01['id'],'shopId':_0x3eaf01['shopId'],'gateway':_0x3eaf01[_0x4c3ef1(0x1b2)],'amount':_0x3eaf01[_0x4c3ef1(0x26e)],'currency':_0x3eaf01[_0x4c3ef1(0x23e)],'sourceCurrency':_0x3eaf01[_0x4c3ef1(0x216)],'usage':_0x3eaf01[_0x4c3ef1(0x1c4)],'expiresAt':_0x3eaf01[_0x4c3ef1(0x1a4)],'redirectUrl':_0x4dae03,'status':_0x3eaf01[_0x4c3ef1(0x210)],'externalPaymentUrl':_0x3eaf01[_0x4c3ef1(0x26c)],'customerEmail':_0x3eaf01[_0x4c3ef1(0x233)],'customerName':_0x3eaf01[_0x4c3ef1(0x1bb)],'country':_0x3eaf01[_0x4c3ef1(0x25f)],'language':_0x3eaf01[_0x4c3ef1(0x265)],'amountIsEditable':_0x3eaf01[_0x4c3ef1(0x222)],'maxPayments':_0x3eaf01['maxPayments'],'customer':_0x3eaf01[_0x4c3ef1(0x254)],'createdAt':_0x3eaf01['createdAt'],'updatedAt':_0x3eaf01['updatedAt'],'shop':_0x3eaf01[_0x4c3ef1(0x1bd)]};}async[a48_0x27377a(0x282)](_0x355e9f,_0x1d0bc1){const _0x3025d5=a48_0x27377a;await database_1[_0x3025d5(0x207)][_0x3025d5(0x1bf)][_0x3025d5(0x27e)]({'where':{'id':_0x1d0bc1,'shopId':_0x355e9f}});}async[a48_0x27377a(0x200)](_0x198e6e,_0x4f89b0){const _0x777d2d=a48_0x27377a,{page:_0x4e8363,limit:_0x545277,status:_0x52ad55,method:_0xca80e3,dateFrom:_0x5b928f,dateTo:_0x1133a9}=_0x4f89b0,_0x2311a1=(_0x4e8363-0x1)*_0x545277,_0x4cbe89={'shopId':_0x198e6e};_0x52ad55&&(_0x4cbe89[_0x777d2d(0x210)]=_0x52ad55);_0xca80e3&&(_0x4cbe89['network']=_0xca80e3);(_0x5b928f||_0x1133a9)&&(_0x4cbe89[_0x777d2d(0x223)]={},_0x5b928f&&(_0x4cbe89[_0x777d2d(0x223)][_0x777d2d(0x27f)]=new Date(_0x5b928f)),_0x1133a9&&(_0x4cbe89[_0x777d2d(0x223)][_0x777d2d(0x221)]=new Date(_0x1133a9)));const [_0x519bf6,_0x5249c2]=await Promise[_0x777d2d(0x1ba)]([database_1[_0x777d2d(0x207)]['payout'][_0x777d2d(0x20b)]({'where':_0x4cbe89,'skip':_0x2311a1,'take':_0x545277,'orderBy':{'createdAt':_0x777d2d(0x1d8)}}),database_1['default'][_0x777d2d(0x252)][_0x777d2d(0x229)]({'where':_0x4cbe89})]);return{'payouts':_0x519bf6[_0x777d2d(0x219)](_0xbed37e=>({'id':_0xbed37e['id'],'amount':_0xbed37e[_0x777d2d(0x26e)],'network':_0xbed37e['network'],'status':_0xbed37e[_0x777d2d(0x210)],'txid':_0xbed37e['txid'],'notes':_0xbed37e[_0x777d2d(0x237)],'createdAt':_0xbed37e['createdAt'],'paidAt':_0xbed37e[_0x777d2d(0x1df)]})),'pagination':{'page':_0x4e8363,'limit':_0x545277,'total':_0x5249c2,'totalPages':Math[_0x777d2d(0x26a)](_0x5249c2/_0x545277)}};}async['getPayoutById'](_0x2740ec,_0x12dc82){const _0x770b29=a48_0x27377a,_0xea3cfb=await database_1[_0x770b29(0x207)][_0x770b29(0x252)][_0x770b29(0x1e8)]({'where':{'id':_0x12dc82,'shopId':_0x2740ec},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xea3cfb)return null;return{'id':_0xea3cfb['id'],'shopId':_0xea3cfb[_0x770b29(0x1e2)],'amount':_0xea3cfb['amount'],'method':_0xea3cfb[_0x770b29(0x208)],'status':_0xea3cfb['status'],'txid':_0xea3cfb[_0x770b29(0x1ae)],'createdAt':_0xea3cfb['createdAt'],'paidAt':_0xea3cfb['paidAt'],'shop':_0xea3cfb[_0x770b29(0x1bd)]};}async['getPayoutStatistics'](_0x3f6ffb,_0x45ef29){const _0x60b024=a48_0x27377a,_0x318b52=this['getPeriodDays'](_0x45ef29),_0x5a4178=new Date();_0x5a4178['setDate'](_0x5a4178['getDate']()-_0x318b52);const _0x353d2b={'shopId':_0x3f6ffb,'createdAt':{'gte':_0x5a4178}},[_0x126a12,_0x512627,_0xd051f5,_0x1a9163,_0x5bfdd0,_0x5e9241,_0x43da3e,_0x203de7]=await Promise[_0x60b024(0x1ba)]([database_1[_0x60b024(0x207)][_0x60b024(0x252)]['count']({'where':_0x353d2b}),database_1['default'][_0x60b024(0x252)][_0x60b024(0x229)]({'where':{..._0x353d2b,'status':_0x60b024(0x241)}}),database_1[_0x60b024(0x207)][_0x60b024(0x252)][_0x60b024(0x229)]({'where':{..._0x353d2b,'status':_0x60b024(0x21c)}}),database_1[_0x60b024(0x207)][_0x60b024(0x252)][_0x60b024(0x229)]({'where':{..._0x353d2b,'status':_0x60b024(0x217)}}),database_1[_0x60b024(0x207)]['payout'][_0x60b024(0x204)]({'where':_0x353d2b,'_sum':{'amount':!![]}}),database_1[_0x60b024(0x207)][_0x60b024(0x252)]['groupBy']({'by':[_0x60b024(0x210)],'where':_0x353d2b,'_count':{'status':!![]}}),database_1[_0x60b024(0x207)][_0x60b024(0x252)][_0x60b024(0x267)]({'by':[_0x60b024(0x208)],'where':_0x353d2b,'_count':{'network':!![]}}),database_1[_0x60b024(0x207)][_0x60b024(0x252)][_0x60b024(0x20b)]({'where':{'shopId':_0x3f6ffb},'take':0xa,'orderBy':{'createdAt':_0x60b024(0x1d8)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x145119=await database_1[_0x60b024(0x207)][_0x60b024(0x252)][_0x60b024(0x204)]({'where':{..._0x353d2b,'status':_0x60b024(0x241)},'_sum':{'amount':!![]}}),_0x3ac92f=await database_1['default'][_0x60b024(0x252)][_0x60b024(0x204)]({'where':{..._0x353d2b,'status':_0x60b024(0x21c)},'_sum':{'amount':!![]}});return{'totalPayouts':_0x126a12,'completedPayouts':_0x512627,'pendingPayouts':_0xd051f5,'rejectedPayouts':_0x1a9163,'totalAmount':_0x5bfdd0[_0x60b024(0x1ff)][_0x60b024(0x26e)]||0x0,'completedAmount':_0x145119['_sum'][_0x60b024(0x26e)]||0x0,'pendingAmount':_0x3ac92f[_0x60b024(0x1ff)][_0x60b024(0x26e)]||0x0,'payoutsByStatus':_0x5e9241[_0x60b024(0x23c)]((_0x56ec67,_0x389014)=>{const _0x3c7a44=_0x60b024;return _0x56ec67[_0x389014['status']]=_0x389014['_count'][_0x3c7a44(0x210)],_0x56ec67;},{}),'payoutsByMethod':_0x43da3e['reduce']((_0x45d52d,_0x2bf6c7)=>{const _0x3a756f=_0x60b024;return _0x45d52d[_0x2bf6c7[_0x3a756f(0x208)]]=_0x2bf6c7['_count'][_0x3a756f(0x208)],_0x45d52d;},{}),'recentPayouts':_0x203de7[_0x60b024(0x219)](_0x5271e0=>({'id':_0x5271e0['id'],'shopId':_0x5271e0[_0x60b024(0x1e2)],'amount':_0x5271e0[_0x60b024(0x26e)],'method':_0x5271e0[_0x60b024(0x208)],'status':_0x5271e0[_0x60b024(0x210)],'txid':_0x5271e0[_0x60b024(0x1ae)],'createdAt':_0x5271e0['createdAt'],'paidAt':_0x5271e0[_0x60b024(0x1df)],'shop':_0x5271e0[_0x60b024(0x1bd)]}))};}async['getShopPayoutStats'](_0x131793){const _0xca3d8=a48_0x27377a;console['log']('ðŸ“Š\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20'+_0x131793);const _0xd67cd5=await database_1[_0xca3d8(0x207)][_0xca3d8(0x1bd)][_0xca3d8(0x1ac)]({'where':{'id':_0x131793},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0xd67cd5)throw new Error('Shop\x20not\x20found');const _0x437a2e=await database_1[_0xca3d8(0x207)][_0xca3d8(0x1bf)][_0xca3d8(0x20b)]({'where':{'shopId':_0x131793,'status':'PAID'},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0xca3d8(0x1e0)](_0xca3d8(0x1a5)+_0x437a2e['length']+_0xca3d8(0x1b1));const _0x4c238a=new Date(),_0x3e3639=new Date(_0x4c238a[_0xca3d8(0x1f3)](),_0x4c238a[_0xca3d8(0x1af)](),0x1);let _0x2eab0c=0x0,_0x54808b=0x0,_0x592e44=0x0,_0x594aee=0x0;for(const _0x44c1c4 of _0x437a2e){const _0x17ca7a=await currencyService_1[_0xca3d8(0x26d)][_0xca3d8(0x1f0)](_0x44c1c4[_0xca3d8(0x26e)],_0x44c1c4[_0xca3d8(0x23e)]),_0x4a63f1=this['getGatewaySettings'](_0xd67cd5,_0x44c1c4['gateway']),_0x58b89a=this[_0xca3d8(0x25b)](_0x17ca7a,_0x4a63f1[_0xca3d8(0x26f)]);_0x44c1c4['merchantPaid']&&(_0x2eab0c+=_0x58b89a,_0x44c1c4['paidAt']&&_0x44c1c4['paidAt']>=_0x3e3639&&(_0x592e44+=_0x58b89a)),this[_0xca3d8(0x245)](_0x44c1c4,_0x4a63f1)&&(_0x54808b+=_0x58b89a,_0x594aee+=_0x17ca7a);}const _0x3cfe88={'availableBalance':Math[_0xca3d8(0x1c9)](_0x594aee*0x64)/0x64,'totalPaidOut':Math[_0xca3d8(0x1c9)](_0x2eab0c*0x64)/0x64,'awaitingPayout':Math[_0xca3d8(0x1c9)](_0x54808b*0x64)/0x64,'thisMonth':Math[_0xca3d8(0x1c9)](_0x592e44*0x64)/0x64};return console['log']('âœ…\x20Shop\x20payout\x20statistics\x20calculated:'),console[_0xca3d8(0x1e0)](_0xca3d8(0x23f)+_0x3cfe88[_0xca3d8(0x1cd)]+'\x20USDT'),console['log'](_0xca3d8(0x253)+_0x3cfe88[_0xca3d8(0x1fb)]+_0xca3d8(0x280)),console['log'](_0xca3d8(0x273)+_0x3cfe88['awaitingPayout']+_0xca3d8(0x280)),console[_0xca3d8(0x1e0)](_0xca3d8(0x214)+_0x3cfe88['thisMonth']+'\x20USDT'),_0x3cfe88;}async[a48_0x27377a(0x224)](_0x3325be){const _0x2ae0bf=a48_0x27377a,_0x46c92f=await this[_0x2ae0bf(0x201)](_0x3325be);return{'totalBalance':_0x46c92f[_0x2ae0bf(0x1cd)],'totalPaidOut':_0x46c92f[_0x2ae0bf(0x1fb)],'awaitingPayout':_0x46c92f[_0x2ae0bf(0x1d1)],'thisMonth':_0x46c92f[_0x2ae0bf(0x1c2)]};}async[a48_0x27377a(0x1a6)](_0x5f3082,_0x45122f){const _0x456ef5=a48_0x27377a,{page:_0x4d421c,limit:_0x116d32,paymentId:_0x5024d4}=_0x45122f,_0xfc615b=(_0x4d421c-0x1)*_0x116d32,_0x431615={'shopId':_0x5f3082};_0x5024d4&&(_0x431615[_0x456ef5(0x232)]=_0x5024d4);const [_0x5b471d,_0x272f3c]=await Promise[_0x456ef5(0x1ba)]([database_1[_0x456ef5(0x207)]['webhookLog'][_0x456ef5(0x20b)]({'where':_0x431615,'skip':_0xfc615b,'take':_0x116d32,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x456ef5(0x207)][_0x456ef5(0x26b)]['count']({'where':_0x431615})]);return{'logs':_0x5b471d['map'](_0x2a2202=>({'id':_0x2a2202['id'],'paymentId':_0x2a2202[_0x456ef5(0x232)],'shopId':_0x2a2202[_0x456ef5(0x1e2)],'event':_0x2a2202[_0x456ef5(0x24b)],'statusCode':_0x2a2202['statusCode'],'retryCount':_0x2a2202[_0x456ef5(0x276)],'responseBody':_0x2a2202[_0x456ef5(0x1a9)],'createdAt':_0x2a2202[_0x456ef5(0x223)],'payment':_0x2a2202[_0x456ef5(0x1bf)]})),'pagination':{'page':_0x4d421c,'limit':_0x116d32,'total':_0x272f3c,'totalPages':Math[_0x456ef5(0x26a)](_0x272f3c/_0x116d32)}};}async[a48_0x27377a(0x242)](_0x485d45,_0x3ca9fc){const _0x59832e=a48_0x27377a,_0x21f58f=this[_0x59832e(0x251)](_0x3ca9fc),_0x4e5609=new Date();_0x4e5609[_0x59832e(0x22b)](_0x4e5609['getDate']()-_0x21f58f),console['log'](_0x59832e(0x235)+_0x3ca9fc+'\x20('+_0x21f58f+_0x59832e(0x236));const _0x5ebfbf={'shopId':_0x485d45,'createdAt':{'gte':_0x4e5609}},_0x335de6=await database_1['default'][_0x59832e(0x1bd)][_0x59832e(0x1ac)]({'where':{'id':_0x485d45},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x335de6)throw new Error(_0x59832e(0x24c));const [_0x39a2f6,_0x584edf,_0x885ef2,_0xd2efa3,_0x3e0f8f,_0x1d40e9,_0xfbfc4d,_0x26eed2]=await Promise[_0x59832e(0x1ba)]([database_1[_0x59832e(0x207)][_0x59832e(0x1bf)][_0x59832e(0x229)]({'where':_0x5ebfbf}),database_1[_0x59832e(0x207)][_0x59832e(0x1bf)][_0x59832e(0x229)]({'where':{..._0x5ebfbf,'status':_0x59832e(0x281)}}),database_1['default'][_0x59832e(0x1bf)]['findMany']({'where':_0x5ebfbf,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1[_0x59832e(0x207)][_0x59832e(0x1bf)][_0x59832e(0x20b)]({'where':{..._0x5ebfbf,'status':_0x59832e(0x281)},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0x59832e(0x207)][_0x59832e(0x1bf)][_0x59832e(0x267)]({'by':['status'],'where':_0x5ebfbf,'_count':{'status':!![]}}),database_1['default'][_0x59832e(0x1bf)][_0x59832e(0x267)]({'by':[_0x59832e(0x1b2)],'where':_0x5ebfbf,'_count':{'gateway':!![]}}),database_1[_0x59832e(0x207)]['payment'][_0x59832e(0x20b)]({'where':{'shopId':_0x485d45},'take':0xa,'orderBy':{'createdAt':_0x59832e(0x1d8)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1[_0x59832e(0x207)][_0x59832e(0x22e)]`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x485d45} 
          AND created_at >= ${_0x4e5609}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0x59832e(0x1e0)](_0x59832e(0x1a5)+_0xd2efa3[_0x59832e(0x284)]+'\x20PAID\x20payments\x20for\x20totalAmount\x20calculation');const _0xb4ec01=await Promise[_0x59832e(0x1ba)](_0xd2efa3['map'](async _0xc2e5a0=>{const _0x5c1708=_0x59832e,_0x215091=await currencyService_1[_0x5c1708(0x26d)][_0x5c1708(0x1f0)](_0xc2e5a0['amount'],_0xc2e5a0[_0x5c1708(0x23e)]),_0x3fa91a=this[_0x5c1708(0x1e9)](_0x335de6,_0xc2e5a0[_0x5c1708(0x1b2)]),_0x277ea9=this[_0x5c1708(0x25b)](_0x215091,_0x3fa91a['commission']);return _0x277ea9;})),_0x54450d=await Promise[_0x59832e(0x1ba)](_0x885ef2[_0x59832e(0x219)](async _0x5a7f2f=>{const _0x11d189=_0x59832e,_0xcf7021=await currencyService_1[_0x11d189(0x26d)][_0x11d189(0x1f0)](_0x5a7f2f['amount'],_0x5a7f2f['currency']);return{'amount':_0xcf7021,'status':_0x5a7f2f['status']};})),_0x2c3813=_0xb4ec01['reduce']((_0x1b6fd1,_0x1425cb)=>_0x1b6fd1+_0x1425cb,0x0),_0x406e73=_0x39a2f6>0x0?_0x54450d[_0x59832e(0x23c)]((_0x2ced69,_0x2d1b84)=>_0x2ced69+_0x2d1b84[_0x59832e(0x26e)],0x0)/_0x39a2f6:0x0;console[_0x59832e(0x1e0)](_0x59832e(0x220)+_0x2c3813[_0x59832e(0x283)](0x2)+_0x59832e(0x280)),console['log'](_0x59832e(0x1ee)+_0x406e73[_0x59832e(0x283)](0x2)+_0x59832e(0x280));const _0x4b0feb=this[_0x59832e(0x1ca)](_0x4e5609,new Date()),_0xef108f=await Promise['all'](_0x26eed2[_0x59832e(0x219)](async _0x494f07=>{const _0x3be9ef=_0x59832e,_0x96cbf8=_0x494f07['payments']['filter'](_0x520375=>_0x520375[_0x3be9ef(0x210)]==='PAID'),_0xa0babf=await Promise[_0x3be9ef(0x1ba)](_0x96cbf8[_0x3be9ef(0x219)](async _0xe3cb5a=>{const _0x39cf95=_0x3be9ef,_0xf0791a=await currencyService_1[_0x39cf95(0x26d)][_0x39cf95(0x1f0)](_0xe3cb5a['amount'],_0xe3cb5a['currency']),_0x3affd4=this[_0x39cf95(0x1e9)](_0x335de6,_0xe3cb5a['gateway']),_0x3d9d6d=this[_0x39cf95(0x25b)](_0xf0791a,_0x3affd4[_0x39cf95(0x26f)]);return _0x3d9d6d;})),_0x99f28d=_0xa0babf[_0x3be9ef(0x23c)]((_0xf0dfda,_0x4d5f20)=>_0xf0dfda+_0x4d5f20,0x0);return{'date':_0x494f07[_0x3be9ef(0x1ec)][_0x3be9ef(0x279)]()[_0x3be9ef(0x1a7)]('T')[0x0],'count':_0x494f07[_0x3be9ef(0x229)],'revenue':_0x99f28d};})),_0x335737=new Map(_0xef108f['map'](_0x160951=>[_0x160951[_0x59832e(0x1ec)],{'count':_0x160951[_0x59832e(0x229)],'revenue':_0x160951['revenue']}])),_0x1a8442=_0x4b0feb[_0x59832e(0x219)](_0x1b223e=>({'date':_0x1b223e,'amount':_0x335737['get'](_0x1b223e)?.['revenue']||0x0})),_0x5d712c=_0x4b0feb['map'](_0x2b38af=>({'date':_0x2b38af,'count':_0x335737[_0x59832e(0x206)](_0x2b38af)?.[_0x59832e(0x229)]||0x0}));return console['log'](_0x59832e(0x1fe)),console[_0x59832e(0x1e0)](_0x59832e(0x20d)+_0x39a2f6),console['log'](_0x59832e(0x22c)+_0x584edf),console[_0x59832e(0x1e0)](_0x59832e(0x1e6)+_0x1a8442[_0x59832e(0x284)]),{'totalPayments':_0x39a2f6,'successfulPayments':_0x584edf,'totalAmount':Math['round'](_0x2c3813*0x64)/0x64,'averageAmount':Math[_0x59832e(0x1c9)](_0x406e73*0x64)/0x64,'paymentsByStatus':_0x3e0f8f[_0x59832e(0x23c)]((_0x1964aa,_0x4106f0)=>{const _0xb1f7aa=_0x59832e;return _0x1964aa[_0x4106f0['status']]=_0x4106f0[_0xb1f7aa(0x1a2)]['status'],_0x1964aa;},{}),'paymentsByGateway':_0x1d40e9[_0x59832e(0x23c)]((_0x444de2,_0x2bf08e)=>{return _0x444de2[_0x2bf08e['gateway']]=_0x2bf08e['_count']['gateway'],_0x444de2;},{}),'recentPayments':_0xfbfc4d[_0x59832e(0x219)](_0x19c2ff=>{const _0x108b13=_0x59832e,_0x5ed3e0=_0x108b13(0x22f)+_0x19c2ff['id'];return{'id':_0x19c2ff['id'],'shopId':_0x19c2ff[_0x108b13(0x1e2)],'gateway':_0x19c2ff[_0x108b13(0x1b2)],'amount':_0x19c2ff['amount'],'currency':_0x19c2ff[_0x108b13(0x23e)],'sourceCurrency':_0x19c2ff['sourceCurrency'],'usage':_0x19c2ff[_0x108b13(0x1c4)],'expiresAt':_0x19c2ff[_0x108b13(0x1a4)],'redirectUrl':_0x5ed3e0,'status':_0x19c2ff[_0x108b13(0x210)],'externalPaymentUrl':_0x19c2ff['externalPaymentUrl'],'customerEmail':_0x19c2ff[_0x108b13(0x233)],'customerName':_0x19c2ff[_0x108b13(0x1bb)],'country':_0x19c2ff[_0x108b13(0x25f)],'language':_0x19c2ff['language'],'amountIsEditable':_0x19c2ff[_0x108b13(0x222)],'maxPayments':_0x19c2ff[_0x108b13(0x24d)],'customer':_0x19c2ff[_0x108b13(0x254)],'createdAt':_0x19c2ff[_0x108b13(0x223)],'updatedAt':_0x19c2ff[_0x108b13(0x1d4)],'shop':_0x19c2ff[_0x108b13(0x1bd)]};}),'dailyRevenue':_0x1a8442,'dailyPayments':_0x5d712c};}[a48_0x27377a(0x251)](_0x581e2f){const _0x18299e=a48_0x27377a;switch(_0x581e2f){case'7d':return 0x7;case _0x18299e(0x247):return 0x1e;case'90d':return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a48_0x27377a(0x1ca)](_0x2e6f69,_0x1fc649){const _0x1007a5=a48_0x27377a,_0x47debf=[],_0x386c3e=new Date(_0x2e6f69);while(_0x386c3e<=_0x1fc649){_0x47debf[_0x1007a5(0x1cb)](_0x386c3e[_0x1007a5(0x279)]()[_0x1007a5(0x1a7)]('T')[0x0]),_0x386c3e['setDate'](_0x386c3e[_0x1007a5(0x22d)]()+0x1);}return _0x47debf;}}exports[a48_0x27377a(0x228)]=ShopService;function a48_0x585a(){const _0x5c0809=['ðŸ’°\x20Available\x20Balance:\x20','16tFvOxM','COMPLETED','getStatistics','Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts','testWebhook','isEligibleForPayout','Gateway\x20not\x20found\x20for\x20ID:\x20','30d','273960oAQcQT','âš ï¸\x20Gateway\x20order\x20ID\x20','stringify','event','Shop\x20not\x20found','maxPayments','padStart','test@example.com','No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.','getPeriodDays','payout','ðŸ’¸\x20Total\x20Paid\x20Out:\x20','rapydCustomer','updateWallets','KlymeService','toUpperCase','./gateways/rapydService','POST','1326190KrwRbe','calculateAmountAfterCommission','paid','ðŸ§ª\x20Sending\x20test\x20webhook\x20to:\x20','floor','country','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','telegram','42BdCvys','gateways','\x20(8digits-8digits\x20format)','language','âœ…\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','groupBy','klymeService','webhookLogs','ceil','webhookLog','externalPaymentUrl','currencyService','amount','commission','USD','generateGatewayOrderId','/payment/fail?payment_id=','â³\x20Awaiting\x20Payout:\x20','invoice_total_sum','./gateways/coinToPayService','retryCount','usdtTrcWallet','username','toISOString','BASE_URL','Order\x20ID:\x20','createPaymentLink','rapyd','delete','gte','\x20USDT','PAID','deletePayment','toFixed','length','usdcPolygonWallet','getShopProfile','_count','parse','expiresAt','ðŸ’°\x20Found\x20','getWebhookLogs','split','now','responseBody','payment_url','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','findUnique','../config/database','txid','getMonth','getPaymentById','\x20paid\x20payments\x20for\x20analysis','gateway','coinToPayService','getTime','11UbqLti','nodaService','Test\x20payload:','\x20(8digits-8digits\x20format\x20for\x20','plisio','all','customerName','CoinToPayService','shop','3481650NabIqI','payment','âŒ\x20Test\x20webhook\x20failed:\x20','/payment/pending?payment_id=','thisMonth','PlisioService','usage','settings','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','qr_url','2910100ghfmiV','round','generateDateRange','push','./gateways/plisioService','availableBalance','webhookUrl','../types/gateway','246435KXrjcs','awaitingPayout','ðŸ’°\x20Amount:\x20','âœ…\x20Test\x20webhook\x20sent\x20successfully:\x20','updatedAt','createPayment','Invalid\x20KLYME\x20gateway:\x20','generateGatewayUrls','desc','1294736aPPamZ','2491944cKrDYu','klyme_','EUR','create','slice','paidAt','log','publicKey','shopId','ONCE','noda','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','ðŸ“Š\x20Daily\x20revenue\x20entries:\x20','telegramId','findFirst','getGatewaySettings','payoutDelay','RapydService','date','name','ðŸ“ˆ\x20Average\x20payment:\x20','\x20\x20\x20âœ…\x20Success:\x20','convertToUSDT','/payment/success?payment_id=','plisioService','getFullYear','6RYQBbp','customer','charAt','getPayments','error','https://tesoft.uk/gateways/noda/webhook','./currencyService','totalPaidOut','gatewaySettings','test_payment_','âœ…\x20Shop\x20statistics\x20generated\x20successfully','_sum','getPayouts','getShopPayoutStats','HTTP\x20','true','aggregate','getKlymeRegionFromGatewayName','get','default','network','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','./gateways/nodaService','findMany','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','ðŸ’³\x20Total\x20payments:\x20','1egmphw','usdtPolygonWallet','status','usdtErcWallet','paymentGateways','update','ðŸ“…\x20This\x20Month:\x20','ðŸ‡¬ðŸ‡§\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','sourceCurrency','REJECTED','updateShopProfile','map','ðŸ”—\x20Generated\x20URLs\x20for\x20','defineProperty','PENDING','âœ…\x20KLYME\x20','redirectUrl','wallets','ðŸ’µ\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','lte','amountIsEditable','createdAt','getPayoutStats','toLowerCase','rapydService','FAILED','ShopService','count','shopUrl','setDate','âœ…\x20Successful\x20payments:\x20','getDate','$queryRaw','https://tesoft.uk/gateway/payment.php?id=','merchantUrl','__esModule','paymentId','customerEmail','gateway_payment_id','ðŸ“Š\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','\x20days)','notes','isValidGatewayId','gatewayPaymentId','merchantPaid','fullName','reduce','random','currency'];a48_0x585a=function(){return _0x5c0809;};return a48_0x585a();}