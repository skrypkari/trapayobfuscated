'use strict';const a58_0x33f249=a58_0x2062;(function(_0x590d64,_0xee2b54){const _0x27881a=a58_0x2062,_0x4d16ed=_0x590d64();while(!![]){try{const _0x8d276e=-parseInt(_0x27881a(0x11b))/0x1+parseInt(_0x27881a(0x125))/0x2*(parseInt(_0x27881a(0xc5))/0x3)+-parseInt(_0x27881a(0x117))/0x4+-parseInt(_0x27881a(0x14f))/0x5*(-parseInt(_0x27881a(0x13d))/0x6)+parseInt(_0x27881a(0x12b))/0x7*(parseInt(_0x27881a(0xea))/0x8)+-parseInt(_0x27881a(0xfa))/0x9*(-parseInt(_0x27881a(0xc3))/0xa)+-parseInt(_0x27881a(0x15b))/0xb;if(_0x8d276e===_0xee2b54)break;else _0x4d16ed['push'](_0x4d16ed['shift']());}catch(_0x35fcd6){_0x4d16ed['push'](_0x4d16ed['shift']());}}}(a58_0x3d79,0x5148b));var __importDefault=this&&this[a58_0x33f249(0x11d)]||function(_0x25d604){return _0x25d604&&_0x25d604['__esModule']?_0x25d604:{'default':_0x25d604};};Object[a58_0x33f249(0x140)](exports,'__esModule',{'value':!![]}),exports[a58_0x33f249(0x15c)]=void 0x0;const database_1=__importDefault(require(a58_0x33f249(0xd9))),currencyService_1=require(a58_0x33f249(0xdb)),paymentService_1=require('./paymentService');function a58_0x3d79(){const _0x2cdcf4=['usdcPolygonWallet','üìÖ\x20Period\x20end:\x20','asc','responseBody','txid','gte','amountUSDT','convertToUSDT','\x20\x20\x20üíµ\x20Available\x20balance:\x20','getPaymentById','Payment\x20not\x20found','application/json','wallets','gateway','shop','paymentGateways','round','6YMItdY','periodFrom','lte','defineProperty','üìä\x20Status\x20filter:\x20','toUpperCase','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','getStatistics','update','paymentService','amountIsEditable','30d','statusCode','CoinToPay','redirectUrl','COMPLETED','üìä\x20Shop\x20','Rapyd','1566305tgIYnG','_sum','isArray','getPaymentByShopAndId','payment','updateShopProfile','findFirst','thisMonth','findMany','log','PENDING','revenue','2135320tKRWAn','ShopService','stringify','split','notes','Error\x20parsing\x20webhook\x20events:','merchantUrl','reduce','üìÖ\x20Date\x20start:\x20','polygon_usdc','usdtPolygonWallet','KLYME\x20GB','push','20yuVAhQ','getShopProfile','6CDnHpX','customerEmail','publicKey','getPayoutStats','retryCount','error','periodTo','getPayouts','network','Shop\x20not\x20found','paidAt','telegram','REJECTED','Failed\x20to\x20send\x20webhook:\x20','payout','webhookEvents','test','getPayoutStatistics','getPayoutById','amount','../config/database','getShopPayoutStats','./currencyService','updateWallets','aggregate','customerName','test_payment_123','name','KLYME\x20EU','status','maxPayments','totalPaidOut','customer','all','webhookUrl','USDC\x20Polygon','findUnique','3848848iDskyn','deletePayment','parse','default','setHours','Unknown\x20error','fullName','currencyService','getGatewayDisplayName','\x20payout\x20statistics\x20calculated:','Noda','üåê\x20Method\x20filter:\x20','paymentId','balance','count','settings','230778JoLtBb','createdAt','map','generateDailyStatistics','test_gateway','PAID','getPaymentsByShop','shopId','dailyRevenue','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','getTime','USDT\x20Polygon','90d','createPayment','event','...','currency','createPublicPayment','Test\x20webhook\x20sent\x20successfully\x20(','KLYME\x20DE','telegramId','formatNetworkName','setDate','testWebhook','üìä\x20Final\x20WHERE\x20conditions:','getFullYear','üí∞\x20Getting\x20payouts\x20with\x20filters:','gatewaySettings','statusText','2497664ubrMKy','shopUrl','getMonth','USDT\x20ERC20','228012iiRmJl','toISOString','__importDefault','usdtErcWallet','sourceCurrency','dailyPayments','webhookLog','\x20\x20\x20üìÖ\x20This\x20month:\x20','polygon','üåê\x20Network\x20filter:\x20','533836zFtiXD','desc','USDT\x20TRC20','username','ceil','usdtTrcWallet','7csJyuq'];a58_0x3d79=function(){return _0x2cdcf4;};return a58_0x3d79();}class ShopService{constructor(){const _0xa81813=a58_0x33f249;this[_0xa81813(0x146)]=new paymentService_1['PaymentService']();}async[a58_0x33f249(0xc4)](_0x57b176){const _0x5142c2=a58_0x33f249,_0x380ca2=await database_1[_0x5142c2(0xed)]['shop'][_0x5142c2(0xe9)]({'where':{'id':_0x57b176},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x380ca2)throw new Error(_0x5142c2(0xce));let _0x370bbd=[];if(_0x380ca2[_0x5142c2(0xf9)]?.[_0x5142c2(0xd4)])try{_0x370bbd=Array[_0x5142c2(0x151)](_0x380ca2['settings'][_0x5142c2(0xd4)])?_0x380ca2[_0x5142c2(0xf9)][_0x5142c2(0xd4)]:JSON[_0x5142c2(0xec)](_0x380ca2['settings'][_0x5142c2(0xd4)]);}catch(_0x5df7dc){console[_0x5142c2(0xca)](_0x5142c2(0xbb),_0x5df7dc),_0x370bbd=[];}return{'id':_0x380ca2['id'],'fullName':_0x380ca2[_0x5142c2(0xe0)],'username':_0x380ca2['username'],'telegramId':_0x380ca2[_0x5142c2(0xd0)],'merchantUrl':_0x380ca2[_0x5142c2(0x118)],'gateways':_0x380ca2[_0x5142c2(0x13b)]?JSON[_0x5142c2(0xec)](_0x380ca2[_0x5142c2(0x13b)]):null,'gatewaySettings':_0x380ca2[_0x5142c2(0x115)]?JSON[_0x5142c2(0xec)](_0x380ca2['gatewaySettings']):null,'publicKey':_0x380ca2[_0x5142c2(0xc7)],'webhookUrl':_0x380ca2[_0x5142c2(0xf9)]?.[_0x5142c2(0xe7)]||null,'webhookEvents':_0x370bbd,'wallets':{'usdtPolygonWallet':_0x380ca2[_0x5142c2(0xc0)],'usdtTrcWallet':_0x380ca2[_0x5142c2(0x12a)],'usdtErcWallet':_0x380ca2['usdtErcWallet'],'usdcPolygonWallet':_0x380ca2[_0x5142c2(0x12c)]},'status':_0x380ca2[_0x5142c2(0xe2)],'createdAt':_0x380ca2['createdAt']};}async[a58_0x33f249(0x154)](_0x51b7c2,_0x5a1d93){const _0x25a827=a58_0x33f249,_0x32f04c={};_0x5a1d93[_0x25a827(0xf0)]&&(_0x32f04c[_0x25a827(0xe0)]=_0x5a1d93[_0x25a827(0xf0)]);_0x5a1d93[_0x25a827(0x10e)]!==undefined&&(_0x32f04c[_0x25a827(0xd0)]=_0x5a1d93[_0x25a827(0x10e)]||null);_0x5a1d93[_0x25a827(0xbc)]&&(_0x32f04c[_0x25a827(0x118)]=_0x5a1d93['merchantUrl']);_0x5a1d93['gateways']&&(_0x32f04c[_0x25a827(0x13b)]=JSON[_0x25a827(0x15d)](_0x5a1d93['gateways']));_0x5a1d93[_0x25a827(0x115)]&&(_0x32f04c[_0x25a827(0x115)]=JSON[_0x25a827(0x15d)](_0x5a1d93[_0x25a827(0x115)]));_0x5a1d93[_0x25a827(0x138)]&&(_0x5a1d93['wallets'][_0x25a827(0xc0)]!==undefined&&(_0x32f04c[_0x25a827(0xc0)]=_0x5a1d93[_0x25a827(0x138)][_0x25a827(0xc0)]||null),_0x5a1d93['wallets'][_0x25a827(0x12a)]!==undefined&&(_0x32f04c[_0x25a827(0x12a)]=_0x5a1d93[_0x25a827(0x138)][_0x25a827(0x12a)]||null),_0x5a1d93[_0x25a827(0x138)]['usdtErcWallet']!==undefined&&(_0x32f04c[_0x25a827(0x11e)]=_0x5a1d93['wallets'][_0x25a827(0x11e)]||null),_0x5a1d93['wallets'][_0x25a827(0x12c)]!==undefined&&(_0x32f04c[_0x25a827(0x12c)]=_0x5a1d93[_0x25a827(0x138)][_0x25a827(0x12c)]||null));const _0x3a537c=await database_1['default'][_0x25a827(0x13a)][_0x25a827(0x145)]({'where':{'id':_0x51b7c2},'data':_0x32f04c,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x2e96ed=[];if(_0x3a537c['settings']?.[_0x25a827(0xd4)])try{_0x2e96ed=Array[_0x25a827(0x151)](_0x3a537c[_0x25a827(0xf9)][_0x25a827(0xd4)])?_0x3a537c[_0x25a827(0xf9)][_0x25a827(0xd4)]:JSON[_0x25a827(0xec)](_0x3a537c[_0x25a827(0xf9)][_0x25a827(0xd4)]);}catch(_0x379242){console['error']('Error\x20parsing\x20webhook\x20events:',_0x379242),_0x2e96ed=[];}return{'id':_0x3a537c['id'],'fullName':_0x3a537c['name'],'username':_0x3a537c[_0x25a827(0x128)],'telegramId':_0x3a537c['telegram'],'merchantUrl':_0x3a537c['shopUrl'],'gateways':_0x3a537c[_0x25a827(0x13b)]?JSON['parse'](_0x3a537c[_0x25a827(0x13b)]):null,'gatewaySettings':_0x3a537c['gatewaySettings']?JSON[_0x25a827(0xec)](_0x3a537c['gatewaySettings']):null,'publicKey':_0x3a537c[_0x25a827(0xc7)],'webhookUrl':_0x3a537c['settings']?.[_0x25a827(0xe7)]||null,'webhookEvents':_0x2e96ed,'wallets':{'usdtPolygonWallet':_0x3a537c[_0x25a827(0xc0)],'usdtTrcWallet':_0x3a537c[_0x25a827(0x12a)],'usdtErcWallet':_0x3a537c[_0x25a827(0x11e)],'usdcPolygonWallet':_0x3a537c[_0x25a827(0x12c)]},'status':_0x3a537c[_0x25a827(0xe2)],'createdAt':_0x3a537c[_0x25a827(0xfb)]};}async[a58_0x33f249(0xdc)](_0x263aa,_0x4e0684){const _0x14cbb2=a58_0x33f249,_0x65931c={};_0x4e0684[_0x14cbb2(0xc0)]!==undefined&&(_0x65931c['usdtPolygonWallet']=_0x4e0684[_0x14cbb2(0xc0)]||null),_0x4e0684[_0x14cbb2(0x12a)]!==undefined&&(_0x65931c['usdtTrcWallet']=_0x4e0684[_0x14cbb2(0x12a)]||null),_0x4e0684[_0x14cbb2(0x11e)]!==undefined&&(_0x65931c[_0x14cbb2(0x11e)]=_0x4e0684[_0x14cbb2(0x11e)]||null),_0x4e0684['usdcPolygonWallet']!==undefined&&(_0x65931c['usdcPolygonWallet']=_0x4e0684[_0x14cbb2(0x12c)]||null),await database_1[_0x14cbb2(0xed)][_0x14cbb2(0x13a)]['update']({'where':{'id':_0x263aa},'data':_0x65931c});}async[a58_0x33f249(0x111)](_0x5df681){const _0x19ada7=a58_0x33f249,_0x5bf49f=await database_1[_0x19ada7(0xed)][_0x19ada7(0x13a)][_0x19ada7(0xe9)]({'where':{'id':_0x5df681},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x5bf49f?.[_0x19ada7(0xf9)]?.[_0x19ada7(0xe7)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x3f9170={'event':'test','payment':{'id':_0x19ada7(0xdf),'order_id':'test_order_123','gateway':_0x19ada7(0xd5),'amount':0x64,'currency':'USD','status':'paid','created_at':new Date()[_0x19ada7(0x11c)]()}};try{const _0x115027=await fetch(_0x5bf49f[_0x19ada7(0xf9)][_0x19ada7(0xe7)],{'method':'POST','headers':{'Content-Type':_0x19ada7(0x137),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON['stringify'](_0x3f9170)});return _0x115027['ok']?{'success':!![],'message':_0x19ada7(0x10c)+_0x115027[_0x19ada7(0xe2)]+')'}:{'success':![],'message':'Webhook\x20returned\x20error:\x20'+_0x115027['status']+'\x20'+_0x115027[_0x19ada7(0x116)]};}catch(_0x557b36){return{'success':![],'message':_0x19ada7(0xd2)+(_0x557b36 instanceof Error?_0x557b36['message']:_0x19ada7(0xef))};}}async[a58_0x33f249(0x107)](_0x515c2d){const _0x5acec3=a58_0x33f249;return this[_0x5acec3(0x146)][_0x5acec3(0x10b)]({'public_key':'','gateway':_0x515c2d[_0x5acec3(0x139)],'order_id':undefined,'amount':_0x515c2d[_0x5acec3(0xd8)],'currency':_0x515c2d['currency'],'source_currency':_0x515c2d[_0x5acec3(0x11f)],'usage':_0x515c2d['usage'],'expires_at':_0x515c2d['expiresAt']?.['toISOString'](),'success_url':_0x515c2d[_0x5acec3(0x14b)],'fail_url':_0x515c2d[_0x5acec3(0x14b)],'customer_email':_0x515c2d[_0x5acec3(0xc6)],'customer_name':_0x515c2d[_0x5acec3(0xde)],'country':_0x515c2d['country'],'language':_0x515c2d['language'],'amount_is_editable':_0x515c2d[_0x5acec3(0x147)],'max_payments':_0x515c2d[_0x5acec3(0xe3)],'customer':_0x515c2d[_0x5acec3(0xe5)]});}async['getPayments'](_0x5679e9,_0x4e84e7){const _0x2ec16c=a58_0x33f249;return this[_0x2ec16c(0x146)][_0x2ec16c(0x100)](_0x5679e9,_0x4e84e7);}async[a58_0x33f249(0x135)](_0x36b5d4,_0x186b25){const _0xa5e2cf=a58_0x33f249;return this[_0xa5e2cf(0x146)][_0xa5e2cf(0x152)](_0x36b5d4,_0x186b25);}async['updatePayment'](_0x6e29c5,_0xbb4ab0,_0x15855c){const _0x397c6f=a58_0x33f249,_0x451f42=await database_1['default'][_0x397c6f(0x153)][_0x397c6f(0x155)]({'where':{'id':_0xbb4ab0,'shopId':_0x6e29c5}});if(!_0x451f42)throw new Error(_0x397c6f(0x136));const _0x2d4410=await database_1[_0x397c6f(0xed)][_0x397c6f(0x153)][_0x397c6f(0x145)]({'where':{'id':_0xbb4ab0},'data':{..._0x15855c,'updatedAt':new Date()}});return _0x2d4410;}async[a58_0x33f249(0xeb)](_0x205d70,_0x4178b1){const _0x5d4c20=a58_0x33f249,_0x1f69d9=await database_1[_0x5d4c20(0xed)][_0x5d4c20(0x153)][_0x5d4c20(0x155)]({'where':{'id':_0x4178b1,'shopId':_0x205d70}});if(!_0x1f69d9)throw new Error(_0x5d4c20(0x136));await database_1[_0x5d4c20(0xed)][_0x5d4c20(0x153)]['delete']({'where':{'id':_0x4178b1}});}[a58_0x33f249(0x10f)](_0x115dcd){const _0x4e1b21=a58_0x33f249,_0x5619e2={'polygon':_0x4e1b21(0x105),'trc20':_0x4e1b21(0x127),'erc20':_0x4e1b21(0x11a),'bsc':'USDT\x20BSC','polygon_usdc':_0x4e1b21(0xe8)};return _0x5619e2[_0x115dcd]||_0x115dcd;}async[a58_0x33f249(0xcc)](_0x5cd091,_0x14bb71){const _0x4195a9=a58_0x33f249,{page:_0xf9acae,limit:_0x251a54,status:_0x29d319,method:_0x46f1ae,network:_0xd145d1,dateFrom:_0x4e701a,dateTo:_0x3f44b4,periodFrom:_0x344d99,periodTo:_0x1bcf41}=_0x14bb71,_0x51ced7=(_0xf9acae-0x1)*_0x251a54;console[_0x4195a9(0x158)](_0x4195a9(0x114),_0x14bb71);const _0x359ef6={'shopId':_0x5cd091};_0x29d319&&(_0x359ef6['status']=_0x29d319[_0x4195a9(0x142)](),console[_0x4195a9(0x158)](_0x4195a9(0x141)+_0x29d319[_0x4195a9(0x142)]()));if(_0x46f1ae)_0x359ef6['network']=_0x46f1ae,console[_0x4195a9(0x158)](_0x4195a9(0xf5)+_0x46f1ae);else _0xd145d1&&(_0x359ef6[_0x4195a9(0xcd)]=_0xd145d1,console[_0x4195a9(0x158)](_0x4195a9(0x124)+_0xd145d1));if(_0x4e701a||_0x3f44b4||_0x344d99||_0x1bcf41){_0x359ef6['createdAt']={};if(_0x344d99){const _0x5ead87=new Date(_0x344d99);_0x5ead87[_0x4195a9(0xee)](0x0,0x0,0x0,0x0),_0x359ef6[_0x4195a9(0xfb)][_0x4195a9(0x131)]=_0x5ead87,console[_0x4195a9(0x158)]('üìÖ\x20Period\x20start:\x20'+_0x5ead87['toISOString']());}else{if(_0x4e701a){const _0x3ec8ba=new Date(_0x4e701a);_0x3ec8ba[_0x4195a9(0xee)](0x0,0x0,0x0,0x0),_0x359ef6[_0x4195a9(0xfb)]['gte']=_0x3ec8ba,console['log'](_0x4195a9(0xbe)+_0x3ec8ba[_0x4195a9(0x11c)]());}}if(_0x1bcf41){const _0x27a848=new Date(_0x1bcf41);_0x27a848[_0x4195a9(0xee)](0x17,0x3b,0x3b,0x3e7),_0x359ef6['createdAt'][_0x4195a9(0x13f)]=_0x27a848,console[_0x4195a9(0x158)](_0x4195a9(0x12d)+_0x27a848[_0x4195a9(0x11c)]());}else{if(_0x3f44b4){const _0x3e984c=new Date(_0x3f44b4);_0x3e984c['setHours'](0x17,0x3b,0x3b,0x3e7),_0x359ef6[_0x4195a9(0xfb)]['lte']=_0x3e984c,console['log']('üìÖ\x20Date\x20end:\x20'+_0x3e984c[_0x4195a9(0x11c)]());}}}console[_0x4195a9(0x158)](_0x4195a9(0x112),JSON[_0x4195a9(0x15d)](_0x359ef6,null,0x2));const [_0xda47a8,_0x442d15]=await Promise[_0x4195a9(0xe6)]([database_1[_0x4195a9(0xed)][_0x4195a9(0xd3)][_0x4195a9(0x157)]({'where':_0x359ef6,'skip':_0x51ced7,'take':_0x251a54,'orderBy':{'createdAt':_0x4195a9(0x126)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default'][_0x4195a9(0xd3)]['count']({'where':_0x359ef6})]);return{'payouts':_0xda47a8[_0x4195a9(0xfc)](_0x11e18e=>{const _0x231ec9=_0x4195a9;let _0x2660d9=null;switch(_0x11e18e[_0x231ec9(0xcd)]){case _0x231ec9(0x123):_0x2660d9=_0x11e18e[_0x231ec9(0x13a)]['usdtPolygonWallet'];break;case'trc20':_0x2660d9=_0x11e18e[_0x231ec9(0x13a)]['usdtTrcWallet'];break;case'erc20':_0x2660d9=_0x11e18e[_0x231ec9(0x13a)][_0x231ec9(0x11e)];break;case _0x231ec9(0xbf):_0x2660d9=_0x11e18e[_0x231ec9(0x13a)][_0x231ec9(0x12c)];break;}return{'id':_0x11e18e['id'],'amount':_0x11e18e[_0x231ec9(0xd8)],'network':this[_0x231ec9(0x10f)](_0x11e18e['network']),'wallet':_0x2660d9,'status':_0x11e18e[_0x231ec9(0xe2)],'txid':_0x11e18e[_0x231ec9(0x130)],'notes':_0x11e18e[_0x231ec9(0xba)],'periodFrom':_0x11e18e[_0x231ec9(0x13e)],'periodTo':_0x11e18e[_0x231ec9(0xcb)],'createdAt':_0x11e18e[_0x231ec9(0xfb)],'paidAt':_0x11e18e['paidAt']};}),'pagination':{'page':_0xf9acae,'limit':_0x251a54,'total':_0x442d15,'totalPages':Math[_0x4195a9(0x129)](_0x442d15/_0x251a54)}};}async[a58_0x33f249(0xd7)](_0xb3e669,_0x4be5bb){const _0x1b3166=a58_0x33f249,_0x2e41c3=await database_1[_0x1b3166(0xed)][_0x1b3166(0xd3)][_0x1b3166(0x155)]({'where':{'id':_0x4be5bb,'shopId':_0xb3e669}});if(!_0x2e41c3)return null;return{'id':_0x2e41c3['id'],'amount':_0x2e41c3[_0x1b3166(0xd8)],'network':_0x2e41c3[_0x1b3166(0xcd)],'status':_0x2e41c3[_0x1b3166(0xe2)],'txid':_0x2e41c3['txid'],'notes':_0x2e41c3[_0x1b3166(0xba)],'createdAt':_0x2e41c3[_0x1b3166(0xfb)],'paidAt':_0x2e41c3['paidAt']};}async[a58_0x33f249(0xd6)](_0x51bc1e,_0x2073a3){const _0x2bcaad=a58_0x33f249,_0x59e1d7=new Date();let _0x3890b5;switch(_0x2073a3){case'7d':_0x3890b5=new Date(_0x59e1d7[_0x2bcaad(0x104)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x2bcaad(0x148):_0x3890b5=new Date(_0x59e1d7['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x3890b5=new Date(_0x59e1d7['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x3890b5=new Date(_0x59e1d7[_0x2bcaad(0x104)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x5183d6,_0x3f31ce,_0x3cfd18,_0x5bd3f3,_0x45432e,_0x3e9892]=await Promise['all']([database_1[_0x2bcaad(0xed)][_0x2bcaad(0xd3)][_0x2bcaad(0xf8)]({'where':{'shopId':_0x51bc1e,'createdAt':{'gte':_0x3890b5}}}),database_1[_0x2bcaad(0xed)][_0x2bcaad(0xd3)][_0x2bcaad(0xf8)]({'where':{'shopId':_0x51bc1e,'status':'COMPLETED','createdAt':{'gte':_0x3890b5}}}),database_1[_0x2bcaad(0xed)]['payout'][_0x2bcaad(0xf8)]({'where':{'shopId':_0x51bc1e,'status':_0x2bcaad(0x159),'createdAt':{'gte':_0x3890b5}}}),database_1['default'][_0x2bcaad(0xd3)]['count']({'where':{'shopId':_0x51bc1e,'status':_0x2bcaad(0xd1),'createdAt':{'gte':_0x3890b5}}}),database_1['default']['payout'][_0x2bcaad(0x157)]({'where':{'shopId':_0x51bc1e,'createdAt':{'gte':_0x3890b5}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x2bcaad(0xed)][_0x2bcaad(0xd3)][_0x2bcaad(0x157)]({'where':{'shopId':_0x51bc1e},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x29fbab=_0x45432e[_0x2bcaad(0xbd)]((_0x2be960,_0x2cf0e5)=>_0x2be960+_0x2cf0e5['amount'],0x0),_0x187f22=_0x45432e['filter'](_0x252fa4=>_0x252fa4['status']===_0x2bcaad(0x14c))['reduce']((_0x40ac97,_0x2d997f)=>_0x40ac97+_0x2d997f[_0x2bcaad(0xd8)],0x0),_0xdc07fd=_0x45432e['filter'](_0x2fee8a=>_0x2fee8a[_0x2bcaad(0xe2)]===_0x2bcaad(0x159))[_0x2bcaad(0xbd)]((_0x56b930,_0x341e34)=>_0x56b930+_0x341e34[_0x2bcaad(0xd8)],0x0),_0x3d7f3d=_0x45432e[_0x2bcaad(0xbd)]((_0x40117b,_0x221005)=>{const _0x177131=_0x2bcaad;return _0x40117b[_0x221005[_0x177131(0xcd)]]=(_0x40117b[_0x221005[_0x177131(0xcd)]]||0x0)+0x1,_0x40117b;},{}),_0x3ebfff=_0x45432e[_0x2bcaad(0xbd)]((_0x4dd899,_0x363524)=>{const _0x5b80a2=_0x2bcaad;return _0x4dd899[_0x363524[_0x5b80a2(0xe2)]]=(_0x4dd899[_0x363524[_0x5b80a2(0xe2)]]||0x0)+0x1,_0x4dd899;},{});return{'totalPayouts':_0x5183d6,'completedPayouts':_0x3f31ce,'pendingPayouts':_0x3cfd18,'rejectedPayouts':_0x5bd3f3,'totalAmount':_0x29fbab,'completedAmount':_0x187f22,'pendingAmount':_0xdc07fd,'payoutsByMethod':_0x3d7f3d,'payoutsByStatus':_0x3ebfff,'recentPayouts':_0x3e9892[_0x2bcaad(0xfc)](_0x130559=>({'id':_0x130559['id'],'shopId':_0x51bc1e,'amount':_0x130559[_0x2bcaad(0xd8)],'method':_0x130559[_0x2bcaad(0xcd)],'status':_0x130559[_0x2bcaad(0xe2)],'txid':_0x130559[_0x2bcaad(0x130)],'createdAt':_0x130559[_0x2bcaad(0xfb)],'paidAt':_0x130559[_0x2bcaad(0xcf)]}))};}async['getShopPayoutStats'](_0x204693){const _0x339717=a58_0x33f249;console['log'](_0x339717(0x103)+_0x204693+_0x339717(0x109));const _0x3a249e=await database_1[_0x339717(0xed)][_0x339717(0x13a)][_0x339717(0xe9)]({'where':{'id':_0x204693},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x3a249e)throw new Error(_0x339717(0xce));const _0x26a4a0=new Date(),_0x46efc9=new Date(_0x26a4a0[_0x339717(0x113)](),_0x26a4a0[_0x339717(0x119)](),0x1),_0x518709=new Date(_0x26a4a0['getFullYear'](),_0x26a4a0[_0x339717(0x119)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x2d148a=await database_1[_0x339717(0xed)][_0x339717(0xd3)][_0x339717(0xdd)]({'_sum':{'amount':!![]},'where':{'shopId':_0x204693,'createdAt':{'gte':_0x46efc9,'lte':_0x518709},'status':_0x339717(0x14c)}}),_0xab6338=_0x2d148a[_0x339717(0x150)][_0x339717(0xd8)]||0x0,_0x10e1d2={'availableBalance':Math[_0x339717(0x13c)](_0x3a249e[_0x339717(0xf7)]*0x64)/0x64,'totalPaidOut':Math[_0x339717(0x13c)](_0x3a249e[_0x339717(0xe4)]*0x64)/0x64,'awaitingPayout':Math[_0x339717(0x13c)](_0x3a249e['balance']*0x64)/0x64,'thisMonth':Math[_0x339717(0x13c)](_0xab6338*0x64)/0x64};return console[_0x339717(0x158)](_0x339717(0x14d)+_0x3a249e[_0x339717(0x128)]+_0x339717(0xf3)),console[_0x339717(0x158)](_0x339717(0x134)+_0x10e1d2['availableBalance']+'\x20USDT\x20(current\x20balance)'),console[_0x339717(0x158)]('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x10e1d2[_0x339717(0xe4)]+'\x20USDT\x20(total\x20payouts)'),console[_0x339717(0x158)](_0x339717(0x143)+_0x10e1d2['awaitingPayout']+'\x20USDT\x20(current\x20balance)'),console['log'](_0x339717(0x122)+_0x10e1d2[_0x339717(0x156)]+'\x20USDT'),_0x10e1d2;}[a58_0x33f249(0xf2)](_0x52bf94){const _0x180b7c=a58_0x33f249,_0x7ad80b={'test_gateway':'Test\x20Gateway','plisio':'Plisio','rapyd':_0x180b7c(0x14e),'noda':_0x180b7c(0xf4),'cointopay':_0x180b7c(0x14a),'klyme_eu':_0x180b7c(0xe1),'klyme_gb':_0x180b7c(0xc1),'klyme_de':_0x180b7c(0x10d)};return _0x7ad80b[_0x52bf94]||_0x52bf94;}async[a58_0x33f249(0xc8)](_0x26da53){const _0x126037=a58_0x33f249;return this[_0x126037(0xda)](_0x26da53);}async['getWebhookLogs'](_0x50c2ca,_0x385dae){const _0x4075c0=a58_0x33f249,{page:_0x31c3e1,limit:_0x229e4f,paymentId:_0x594003}=_0x385dae,_0x44bed3=(_0x31c3e1-0x1)*_0x229e4f,_0x2b0262={'shopId':_0x50c2ca};_0x594003&&(_0x2b0262[_0x4075c0(0xf6)]=_0x594003);const [_0x5f70f0,_0x56b53a]=await Promise['all']([database_1[_0x4075c0(0xed)][_0x4075c0(0x121)][_0x4075c0(0x157)]({'where':_0x2b0262,'skip':_0x44bed3,'take':_0x229e4f,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default']['webhookLog'][_0x4075c0(0xf8)]({'where':_0x2b0262})]);return{'logs':_0x5f70f0[_0x4075c0(0xfc)](_0x1b0a02=>({'id':_0x1b0a02['id'],'paymentId':_0x1b0a02['paymentId'],'shopId':_0x1b0a02[_0x4075c0(0x101)],'event':_0x1b0a02[_0x4075c0(0x108)],'statusCode':_0x1b0a02[_0x4075c0(0x149)],'retryCount':_0x1b0a02[_0x4075c0(0xc9)],'responseBody':_0x1b0a02[_0x4075c0(0x12f)],'createdAt':_0x1b0a02[_0x4075c0(0xfb)],'payment':_0x1b0a02['payment']})),'pagination':{'page':_0x31c3e1,'limit':_0x229e4f,'total':_0x56b53a,'totalPages':Math[_0x4075c0(0x129)](_0x56b53a/_0x229e4f)}};}async[a58_0x33f249(0x144)](_0x2bb9bc,_0x43a3be){const _0x36e87a=a58_0x33f249,_0x2d67f4=new Date();let _0x438d9b;switch(_0x43a3be){case'7d':_0x438d9b=new Date(_0x2d67f4[_0x36e87a(0x104)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x36e87a(0x148):_0x438d9b=new Date(_0x2d67f4['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x36e87a(0x106):_0x438d9b=new Date(_0x2d67f4[_0x36e87a(0x104)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x438d9b=new Date(_0x2d67f4['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x90c059,_0x51a39c,_0x11f701,_0x4bffa3,_0x2f587c]=await Promise[_0x36e87a(0xe6)]([database_1[_0x36e87a(0xed)][_0x36e87a(0x153)]['count']({'where':{'shopId':_0x2bb9bc,'gateway':{'not':_0x36e87a(0xfe)},'createdAt':{'gte':_0x438d9b}}}),database_1[_0x36e87a(0xed)][_0x36e87a(0x153)][_0x36e87a(0xf8)]({'where':{'shopId':_0x2bb9bc,'gateway':{'not':_0x36e87a(0xfe)},'status':_0x36e87a(0xff),'createdAt':{'gte':_0x438d9b}}}),database_1['default'][_0x36e87a(0x153)]['findMany']({'where':{'shopId':_0x2bb9bc,'gateway':{'not':'test_gateway'},'status':'PAID','createdAt':{'gte':_0x438d9b}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x36e87a(0xed)][_0x36e87a(0x153)]['findMany']({'where':{'shopId':_0x2bb9bc,'gateway':{'not':'test_gateway'}},'take':0xa,'orderBy':{'createdAt':_0x36e87a(0x126)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x36e87a(0x153)]['findMany']({'where':{'shopId':_0x2bb9bc,'gateway':{'not':_0x36e87a(0xfe)},'createdAt':{'gte':_0x438d9b}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x36e87a(0x12e)}})]);let _0x56b31b=0x0;for(const _0x2d39ae of _0x11f701){if(_0x2d39ae[_0x36e87a(0x132)])_0x56b31b+=_0x2d39ae[_0x36e87a(0x132)];else{const _0x345cd2=await currencyService_1[_0x36e87a(0xf1)][_0x36e87a(0x133)](_0x2d39ae[_0x36e87a(0xd8)],_0x2d39ae[_0x36e87a(0x10a)]);_0x56b31b+=_0x345cd2;}}const _0xbd7b6e=this[_0x36e87a(0xfd)](_0x2f587c,_0x438d9b,_0x2d67f4),_0x5ed3c1=_0x90c059>0x0?_0x51a39c/_0x90c059*0x64:0x0;return{'totalPayments':_0x90c059,'successfulPayments':_0x51a39c,'totalRevenue':Math[_0x36e87a(0x13c)](_0x56b31b*0x64)/0x64,'conversionRate':Math[_0x36e87a(0x13c)](_0x5ed3c1*0x64)/0x64,'dailyRevenue':_0xbd7b6e[_0x36e87a(0x102)],'dailyPayments':_0xbd7b6e[_0x36e87a(0x120)],'recentPayments':_0x4bffa3[_0x36e87a(0xfc)](_0x2986ce=>({'id':_0x2986ce['id'],'gateway':_0x2986ce['gateway'],'amount':_0x2986ce[_0x36e87a(0xd8)],'currency':_0x2986ce[_0x36e87a(0x10a)],'status':_0x2986ce[_0x36e87a(0xe2)],'createdAt':_0x2986ce[_0x36e87a(0xfb)]}))};}[a58_0x33f249(0xfd)](_0x3e6c8e,_0x1ed8fd,_0x4b30de){const _0x287719=a58_0x33f249,_0x217325=new Map(),_0x28eead=new Date(_0x1ed8fd);while(_0x28eead<=_0x4b30de){const _0x2b6f2d=_0x28eead[_0x287719(0x11c)]()[_0x287719(0x15e)]('T')[0x0];_0x217325['set'](_0x2b6f2d,{'revenue':0x0,'count':0x0}),_0x28eead[_0x287719(0x110)](_0x28eead['getDate']()+0x1);}for(const _0x1ac127 of _0x3e6c8e){const _0x45ce45=_0x1ac127['createdAt'][_0x287719(0x11c)]()['split']('T')[0x0],_0x5b7a70=_0x217325['get'](_0x45ce45);_0x5b7a70&&(_0x5b7a70['count']+=0x1,_0x1ac127[_0x287719(0xe2)]===_0x287719(0xff)&&_0x1ac127[_0x287719(0x132)]&&(_0x5b7a70['revenue']+=_0x1ac127[_0x287719(0x132)]));}const _0x488373=[],_0x4eddee=[];for(const [_0x3dac1e,_0x4fe802]of _0x217325){_0x488373[_0x287719(0xc2)]({'date':_0x3dac1e,'amount':Math[_0x287719(0x13c)](_0x4fe802[_0x287719(0x15a)]*0x64)/0x64}),_0x4eddee[_0x287719(0xc2)]({'date':_0x3dac1e,'count':_0x4fe802[_0x287719(0xf8)]});}return{'dailyRevenue':_0x488373,'dailyPayments':_0x4eddee};}}function a58_0x2062(_0x53733a,_0x114ed4){const _0x3d79e7=a58_0x3d79();return a58_0x2062=function(_0x2062a,_0x386c0c){_0x2062a=_0x2062a-0xba;let _0x3658cf=_0x3d79e7[_0x2062a];return _0x3658cf;},a58_0x2062(_0x53733a,_0x114ed4);}exports[a58_0x33f249(0x15c)]=ShopService;