'use strict';const a65_0x3901a7=a65_0x4a37;(function(_0x27faf7,_0x36f545){const _0x2b7e5f=a65_0x4a37,_0x2879e7=_0x27faf7();while(!![]){try{const _0x4615e3=-parseInt(_0x2b7e5f(0x1f5))/0x1*(parseInt(_0x2b7e5f(0x1ff))/0x2)+-parseInt(_0x2b7e5f(0x1a4))/0x3+-parseInt(_0x2b7e5f(0x1e9))/0x4+parseInt(_0x2b7e5f(0x1cb))/0x5+-parseInt(_0x2b7e5f(0x176))/0x6*(-parseInt(_0x2b7e5f(0x1c5))/0x7)+-parseInt(_0x2b7e5f(0x1be))/0x8+-parseInt(_0x2b7e5f(0x1c7))/0x9*(parseInt(_0x2b7e5f(0x1d6))/0xa);if(_0x4615e3===_0x36f545)break;else _0x2879e7['push'](_0x2879e7['shift']());}catch(_0x32e72f){_0x2879e7['push'](_0x2879e7['shift']());}}}(a65_0x3d57,0x389b0));var __importDefault=this&&this[a65_0x3901a7(0x1de)]||function(_0xcf8087){return _0xcf8087&&_0xcf8087['__esModule']?_0xcf8087:{'default':_0xcf8087};};function a65_0x3d57(){const _0x24c95a=['PAID','setDate','usdcErcWallet','getTime','shopUrl','77LPXpWs','paid','45lmGeiw','üìä\x20Final\x20WHERE\x20conditions:','USDC\x20Polygon','polygon_usdc','1868560cHEMBP','network','dailyRevenue','publicKey','notes','test_gateway','map','Shop\x20not\x20found','name','toISOString','getPaymentsByShop','344480rQdGyw','usdtErcWallet','username',',\x20dateFrom:\x20','stringify','üìä\x20Shop\x20','statusCode','desc','__importDefault','PENDING','default','üìÖ\x20Date\x20end:\x20','ShopService','amountUSDT','üìÖ\x20Final\x20date\x20range:\x20','get','lte','customerName','payout','480744kjRlPg','all','erc20','2020-01-01','KLYME\x20DE','wallets','updatePayment','toLowerCase','paymentGateways','availableBalance','usdcPolygonWallet','ceil','184877XYxfeX','REFUND','30d','getShopProfile','error','amountIsEditable','\x20USDT','aggregate','getPaymentByShopAndId','findMany','2ZqQJEW','delete','Rapyd','split','KLYME\x20EU','yesterday','reduce','üí∞\x20Getting\x20payouts\x20with\x20filters:','maxPayments','getMonth','...','getStatistics','Noda','responseBody','telegram','getPayoutStats','USDT\x20TRC20','COMPLETED','totalPaidOut','event','Plisio','currencyService','USDT\x20ERC20','getFullYear','Failed\x20to\x20send\x20webhook:\x20','createdAt','getPayoutById','asc','txid','currency','getDate','getGatewayDisplayName','erc20_usdc','\x20USDT\x20(current\x20balance)','Test\x20Gateway','payment','createPublicPayment','parse','defineProperty','getPayoutStatistics','Payment\x20not\x20found','__esModule','thisMonth','language','settings','227706BoUdPZ','üìÖ\x20Period\x20start:\x20','test_payment_123','Test\x20webhook\x20sent\x20successfully\x20(','createPayment','isArray','findFirst','periodFrom','../config/database','paidAt','setHours','gateways','round','90d','gateway','expiresAt','KLYME\x20GB','Webhook\x20returned\x20error:\x20','\x20to\x20','./currencyService','getPayouts','paymentService','PaymentService','day','shop','Unknown\x20error','redirectUrl','CHARGEBACK','deletePayment','test','getShopPayoutStats','üåê\x20Method\x20filter:\x20','fullName','Error\x20parsing\x20webhook\x20events:','usdtPolygonWallet','getPayments','shopId','formatNetworkName','count','dailyPayments','usdtTrcWallet','USDC\x20Ethereum','getWebhookLogs','customer','now','toUpperCase','124527kUyXzE','status','generateDailyStatistics','push','gatewaySettings','message','year','revenue','log','üìä\x20Getting\x20statistics\x20for\x20shop\x20','polygon','webhookUrl','sourceCurrency','balance','convertToUSDT','merchantUrl','paymentId','YESTERDAY','application/json','\x20\x20\x20üíµ\x20Available\x20balance:\x20','update','webhookEvents','amount','webhookLog','findUnique','üìä\x20Status\x20filter:\x20','324040CTWFxc','\x20\x20\x20üìÖ\x20This\x20month:\x20'];a65_0x3d57=function(){return _0x24c95a;};return a65_0x3d57();}Object[a65_0x3901a7(0x225)](exports,a65_0x3901a7(0x172),{'value':!![]}),exports[a65_0x3901a7(0x1e2)]=void 0x0;function a65_0x4a37(_0x38b5cd,_0x2faf96){const _0x3d570c=a65_0x3d57();return a65_0x4a37=function(_0x4a3749,_0x2e37d8){_0x4a3749=_0x4a3749-0x171;let _0xba475b=_0x3d570c[_0x4a3749];return _0xba475b;},a65_0x4a37(_0x38b5cd,_0x2faf96);}const database_1=__importDefault(require(a65_0x3901a7(0x17e))),currencyService_1=require(a65_0x3901a7(0x189)),paymentService_1=require('./paymentService');class ShopService{constructor(){const _0x59e85a=a65_0x3901a7;this[_0x59e85a(0x18b)]=new paymentService_1[(_0x59e85a(0x18c))]();}async[a65_0x3901a7(0x1f8)](_0x45613c){const _0x18a0dc=a65_0x3901a7,_0x1fbdbe=await database_1[_0x18a0dc(0x1e0)][_0x18a0dc(0x18e)][_0x18a0dc(0x1bc)]({'where':{'id':_0x45613c},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x1fbdbe)throw new Error(_0x18a0dc(0x1d2));let _0x20994b=[];if(_0x1fbdbe[_0x18a0dc(0x175)]?.[_0x18a0dc(0x1b9)])try{_0x20994b=Array[_0x18a0dc(0x17b)](_0x1fbdbe[_0x18a0dc(0x175)][_0x18a0dc(0x1b9)])?_0x1fbdbe[_0x18a0dc(0x175)]['webhookEvents']:JSON[_0x18a0dc(0x224)](_0x1fbdbe['settings'][_0x18a0dc(0x1b9)]);}catch(_0x365028){console[_0x18a0dc(0x1f9)](_0x18a0dc(0x197),_0x365028),_0x20994b=[];}return{'id':_0x1fbdbe['id'],'fullName':_0x1fbdbe[_0x18a0dc(0x1d3)],'username':_0x1fbdbe['username'],'telegramId':_0x1fbdbe[_0x18a0dc(0x20d)],'merchantUrl':_0x1fbdbe[_0x18a0dc(0x1c4)],'gateways':_0x1fbdbe[_0x18a0dc(0x1f1)]?JSON[_0x18a0dc(0x224)](_0x1fbdbe['paymentGateways']):null,'gatewaySettings':_0x1fbdbe[_0x18a0dc(0x1a8)]?JSON['parse'](_0x1fbdbe['gatewaySettings']):null,'publicKey':_0x1fbdbe[_0x18a0dc(0x1ce)],'webhookUrl':_0x1fbdbe[_0x18a0dc(0x175)]?.['webhookUrl']||null,'webhookEvents':_0x20994b,'wallets':{'usdtPolygonWallet':_0x1fbdbe[_0x18a0dc(0x198)],'usdtTrcWallet':_0x1fbdbe['usdtTrcWallet'],'usdtErcWallet':_0x1fbdbe[_0x18a0dc(0x1d7)],'usdcPolygonWallet':_0x1fbdbe[_0x18a0dc(0x1f3)],'usdcErcWallet':_0x1fbdbe[_0x18a0dc(0x1c2)]},'status':_0x1fbdbe[_0x18a0dc(0x1a5)],'createdAt':_0x1fbdbe[_0x18a0dc(0x218)]};}async['updateShopProfile'](_0x10b48e,_0x5e20ff){const _0xe09562=a65_0x3901a7,_0x4f7734={};_0x5e20ff[_0xe09562(0x196)]&&(_0x4f7734['name']=_0x5e20ff['fullName']);_0x5e20ff['telegramId']!==undefined&&(_0x4f7734[_0xe09562(0x20d)]=_0x5e20ff['telegramId']||null);_0x5e20ff[_0xe09562(0x1b3)]&&(_0x4f7734[_0xe09562(0x1c4)]=_0x5e20ff[_0xe09562(0x1b3)]);_0x5e20ff[_0xe09562(0x181)]&&(_0x4f7734[_0xe09562(0x1f1)]=JSON[_0xe09562(0x1da)](_0x5e20ff[_0xe09562(0x181)]));_0x5e20ff[_0xe09562(0x1a8)]&&(_0x4f7734[_0xe09562(0x1a8)]=JSON[_0xe09562(0x1da)](_0x5e20ff[_0xe09562(0x1a8)]));_0x5e20ff['wallets']&&(_0x5e20ff[_0xe09562(0x1ee)][_0xe09562(0x198)]!==undefined&&(_0x4f7734[_0xe09562(0x198)]=_0x5e20ff['wallets'][_0xe09562(0x198)]||null),_0x5e20ff[_0xe09562(0x1ee)][_0xe09562(0x19e)]!==undefined&&(_0x4f7734[_0xe09562(0x19e)]=_0x5e20ff['wallets'][_0xe09562(0x19e)]||null),_0x5e20ff['wallets'][_0xe09562(0x1d7)]!==undefined&&(_0x4f7734[_0xe09562(0x1d7)]=_0x5e20ff[_0xe09562(0x1ee)]['usdtErcWallet']||null),_0x5e20ff['wallets'][_0xe09562(0x1f3)]!==undefined&&(_0x4f7734[_0xe09562(0x1f3)]=_0x5e20ff['wallets']['usdcPolygonWallet']||null));const _0x1a66c1=await database_1[_0xe09562(0x1e0)]['shop']['update']({'where':{'id':_0x10b48e},'data':_0x4f7734,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x2fb525=[];if(_0x1a66c1['settings']?.[_0xe09562(0x1b9)])try{_0x2fb525=Array[_0xe09562(0x17b)](_0x1a66c1[_0xe09562(0x175)][_0xe09562(0x1b9)])?_0x1a66c1[_0xe09562(0x175)][_0xe09562(0x1b9)]:JSON[_0xe09562(0x224)](_0x1a66c1[_0xe09562(0x175)]['webhookEvents']);}catch(_0x2b4c70){console[_0xe09562(0x1f9)](_0xe09562(0x197),_0x2b4c70),_0x2fb525=[];}return{'id':_0x1a66c1['id'],'fullName':_0x1a66c1[_0xe09562(0x1d3)],'username':_0x1a66c1[_0xe09562(0x1d8)],'telegramId':_0x1a66c1[_0xe09562(0x20d)],'merchantUrl':_0x1a66c1[_0xe09562(0x1c4)],'gateways':_0x1a66c1[_0xe09562(0x1f1)]?JSON[_0xe09562(0x224)](_0x1a66c1['paymentGateways']):null,'gatewaySettings':_0x1a66c1['gatewaySettings']?JSON[_0xe09562(0x224)](_0x1a66c1[_0xe09562(0x1a8)]):null,'publicKey':_0x1a66c1[_0xe09562(0x1ce)],'webhookUrl':_0x1a66c1['settings']?.[_0xe09562(0x1af)]||null,'webhookEvents':_0x2fb525,'wallets':{'usdtPolygonWallet':_0x1a66c1[_0xe09562(0x198)],'usdtTrcWallet':_0x1a66c1[_0xe09562(0x19e)],'usdtErcWallet':_0x1a66c1['usdtErcWallet'],'usdcPolygonWallet':_0x1a66c1[_0xe09562(0x1f3)],'usdcErcWallet':_0x1a66c1['usdcErcWallet']},'status':_0x1a66c1[_0xe09562(0x1a5)],'createdAt':_0x1a66c1[_0xe09562(0x218)]};}async['updateWallets'](_0x360064,_0x2321e2){const _0x4e614c=a65_0x3901a7,_0x8ef6b9={};_0x2321e2[_0x4e614c(0x198)]!==undefined&&(_0x8ef6b9[_0x4e614c(0x198)]=_0x2321e2[_0x4e614c(0x198)]||null),_0x2321e2[_0x4e614c(0x19e)]!==undefined&&(_0x8ef6b9[_0x4e614c(0x19e)]=_0x2321e2['usdtTrcWallet']||null),_0x2321e2[_0x4e614c(0x1d7)]!==undefined&&(_0x8ef6b9[_0x4e614c(0x1d7)]=_0x2321e2[_0x4e614c(0x1d7)]||null),_0x2321e2[_0x4e614c(0x1f3)]!==undefined&&(_0x8ef6b9[_0x4e614c(0x1f3)]=_0x2321e2['usdcPolygonWallet']||null),_0x2321e2[_0x4e614c(0x1c2)]!==undefined&&(_0x8ef6b9[_0x4e614c(0x1c2)]=_0x2321e2['usdcErcWallet']||null),await database_1[_0x4e614c(0x1e0)]['shop'][_0x4e614c(0x1b8)]({'where':{'id':_0x360064},'data':_0x8ef6b9});}async['testWebhook'](_0x4cc106){const _0x518ba7=a65_0x3901a7,_0x25d849=await database_1[_0x518ba7(0x1e0)][_0x518ba7(0x18e)]['findUnique']({'where':{'id':_0x4cc106},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x25d849?.[_0x518ba7(0x175)]?.[_0x518ba7(0x1af)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x409664={'event':_0x518ba7(0x193),'payment':{'id':_0x518ba7(0x178),'order_id':'test_order_123','gateway':'test','amount':0x64,'currency':'USD','status':_0x518ba7(0x1c6),'created_at':new Date()['toISOString']()}};try{const _0x2c1bcf=await fetch(_0x25d849[_0x518ba7(0x175)][_0x518ba7(0x1af)],{'method':'POST','headers':{'Content-Type':_0x518ba7(0x1b6),'User-Agent':'Payment\x20System/1.0\x20(Test)'},'body':JSON[_0x518ba7(0x1da)](_0x409664)});return _0x2c1bcf['ok']?{'success':!![],'message':_0x518ba7(0x179)+_0x2c1bcf[_0x518ba7(0x1a5)]+')'}:{'success':![],'message':_0x518ba7(0x187)+_0x2c1bcf[_0x518ba7(0x1a5)]+'\x20'+_0x2c1bcf['statusText']};}catch(_0x920282){return{'success':![],'message':_0x518ba7(0x217)+(_0x920282 instanceof Error?_0x920282[_0x518ba7(0x1a9)]:_0x518ba7(0x18f))};}}async[a65_0x3901a7(0x17a)](_0x586008){const _0x342407=a65_0x3901a7;return this[_0x342407(0x18b)][_0x342407(0x223)]({'public_key':'','gateway':_0x586008[_0x342407(0x184)],'order_id':undefined,'amount':_0x586008[_0x342407(0x1ba)],'currency':_0x586008[_0x342407(0x21c)],'source_currency':_0x586008[_0x342407(0x1b0)],'usage':_0x586008['usage'],'expires_at':_0x586008[_0x342407(0x185)]?.['toISOString'](),'success_url':_0x586008['redirectUrl'],'fail_url':_0x586008[_0x342407(0x190)],'customer_email':_0x586008['customerEmail'],'customer_name':_0x586008[_0x342407(0x1e7)],'country':_0x586008['country'],'language':_0x586008[_0x342407(0x174)],'amount_is_editable':_0x586008[_0x342407(0x1fa)],'max_payments':_0x586008[_0x342407(0x207)],'customer':_0x586008[_0x342407(0x1a1)]});}async[a65_0x3901a7(0x199)](_0x36e2b8,_0x3aaecd){const _0x2ad11e=a65_0x3901a7;return this[_0x2ad11e(0x18b)][_0x2ad11e(0x1d5)](_0x36e2b8,_0x3aaecd);}async['getPaymentById'](_0x5348a5,_0x3d7195){const _0x2c28b9=a65_0x3901a7;return this[_0x2c28b9(0x18b)][_0x2c28b9(0x1fd)](_0x5348a5,_0x3d7195);}async[a65_0x3901a7(0x1ef)](_0x4bbb1a,_0x3adc54,_0x176eac){const _0x139d27=a65_0x3901a7,_0x326e7c=await database_1[_0x139d27(0x1e0)][_0x139d27(0x222)]['findFirst']({'where':{'id':_0x3adc54,'shopId':_0x4bbb1a}});if(!_0x326e7c)throw new Error(_0x139d27(0x171));const _0x4f2224=await database_1[_0x139d27(0x1e0)][_0x139d27(0x222)][_0x139d27(0x1b8)]({'where':{'id':_0x3adc54},'data':{..._0x176eac,'updatedAt':new Date()}});return _0x4f2224;}async[a65_0x3901a7(0x192)](_0x4d89c8,_0x35671a){const _0x29f171=a65_0x3901a7,_0x3dbf3b=await database_1[_0x29f171(0x1e0)][_0x29f171(0x222)][_0x29f171(0x17c)]({'where':{'id':_0x35671a,'shopId':_0x4d89c8}});if(!_0x3dbf3b)throw new Error(_0x29f171(0x171));await database_1['default'][_0x29f171(0x222)][_0x29f171(0x200)]({'where':{'id':_0x35671a}});}['formatNetworkName'](_0x20ff06){const _0x4dfff4=a65_0x3901a7,_0x336a70={'polygon':'USDT\x20Polygon','trc20':_0x4dfff4(0x20f),'erc20':_0x4dfff4(0x215),'bsc':'USDT\x20BSC','polygon_usdc':_0x4dfff4(0x1c9),'erc20_usdc':_0x4dfff4(0x19f)};return _0x336a70[_0x20ff06]||_0x20ff06;}async[a65_0x3901a7(0x18a)](_0x27d2a3,_0x38c212){const _0x46d4e2=a65_0x3901a7,{page:_0x314830,limit:_0x23f5a6,status:_0x490c94,method:_0x423571,network:_0x1dbe0d,dateFrom:_0x438096,dateTo:_0x18aab7,periodFrom:_0x5a8863,periodTo:_0x110aab}=_0x38c212,_0x284796=(_0x314830-0x1)*_0x23f5a6;console[_0x46d4e2(0x1ac)](_0x46d4e2(0x206),_0x38c212);const _0x5c2719={'shopId':_0x27d2a3};_0x490c94&&(_0x5c2719[_0x46d4e2(0x1a5)]=_0x490c94[_0x46d4e2(0x1a3)](),console[_0x46d4e2(0x1ac)](_0x46d4e2(0x1bd)+_0x490c94[_0x46d4e2(0x1a3)]()));if(_0x423571)_0x5c2719['network']=_0x423571,console[_0x46d4e2(0x1ac)](_0x46d4e2(0x195)+_0x423571);else _0x1dbe0d&&(_0x5c2719[_0x46d4e2(0x1cc)]=_0x1dbe0d,console['log']('üåê\x20Network\x20filter:\x20'+_0x1dbe0d));if(_0x438096||_0x18aab7||_0x5a8863||_0x110aab){_0x5c2719[_0x46d4e2(0x218)]={};if(_0x5a8863){const _0x1d18c6=new Date(_0x5a8863);_0x1d18c6[_0x46d4e2(0x180)](0x0,0x0,0x0,0x1),_0x5c2719[_0x46d4e2(0x218)]['gte']=_0x1d18c6,console['log'](_0x46d4e2(0x177)+_0x1d18c6[_0x46d4e2(0x1d4)]());}else{if(_0x438096){const _0x1a678d=new Date(_0x438096);_0x1a678d['setHours'](0x0,0x0,0x0,0x1),_0x5c2719[_0x46d4e2(0x218)]['gte']=_0x1a678d,console[_0x46d4e2(0x1ac)]('üìÖ\x20Date\x20start:\x20'+_0x1a678d[_0x46d4e2(0x1d4)]());}}if(_0x110aab){const _0x21a832=new Date(_0x110aab);_0x21a832[_0x46d4e2(0x180)](0x17,0x3b,0x3b,0x3e7),_0x5c2719[_0x46d4e2(0x218)][_0x46d4e2(0x1e6)]=_0x21a832,console[_0x46d4e2(0x1ac)]('üìÖ\x20Period\x20end:\x20'+_0x21a832[_0x46d4e2(0x1d4)]());}else{if(_0x18aab7){const _0x27723f=new Date(_0x18aab7);_0x27723f[_0x46d4e2(0x180)](0x17,0x3b,0x3b,0x3e7),_0x5c2719[_0x46d4e2(0x218)][_0x46d4e2(0x1e6)]=_0x27723f,console[_0x46d4e2(0x1ac)](_0x46d4e2(0x1e1)+_0x27723f['toISOString']());}}}console[_0x46d4e2(0x1ac)](_0x46d4e2(0x1c8),JSON[_0x46d4e2(0x1da)](_0x5c2719,null,0x2));const [_0x507c54,_0x2d4956]=await Promise[_0x46d4e2(0x1ea)]([database_1['default'][_0x46d4e2(0x1e8)][_0x46d4e2(0x1fe)]({'where':_0x5c2719,'skip':_0x284796,'take':_0x23f5a6,'orderBy':{'createdAt':_0x46d4e2(0x1dd)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![]}}}}),database_1[_0x46d4e2(0x1e0)]['payout'][_0x46d4e2(0x19c)]({'where':_0x5c2719})]);return{'payouts':_0x507c54[_0x46d4e2(0x1d1)](_0x67775d=>{const _0x582438=_0x46d4e2;let _0x47a71f=null;switch(_0x67775d[_0x582438(0x1cc)]){case _0x582438(0x1ae):_0x47a71f=_0x67775d[_0x582438(0x18e)][_0x582438(0x198)];break;case'trc20':_0x47a71f=_0x67775d[_0x582438(0x18e)][_0x582438(0x19e)];break;case _0x582438(0x1eb):_0x47a71f=_0x67775d[_0x582438(0x18e)]['usdtErcWallet'];break;case _0x582438(0x1ca):_0x47a71f=_0x67775d[_0x582438(0x18e)][_0x582438(0x1f3)];break;case _0x582438(0x21f):_0x47a71f=_0x67775d['shop'][_0x582438(0x1c2)];break;}return{'id':_0x67775d['id'],'amount':_0x67775d[_0x582438(0x1ba)],'network':this[_0x582438(0x19b)](_0x67775d[_0x582438(0x1cc)]),'wallet':_0x47a71f,'status':_0x67775d[_0x582438(0x1a5)],'txid':_0x67775d['txid'],'notes':_0x67775d[_0x582438(0x1cf)],'periodFrom':_0x67775d[_0x582438(0x17d)],'periodTo':_0x67775d['periodTo'],'createdAt':_0x67775d[_0x582438(0x218)],'paidAt':_0x67775d[_0x582438(0x17f)]};}),'pagination':{'page':_0x314830,'limit':_0x23f5a6,'total':_0x2d4956,'totalPages':Math['ceil'](_0x2d4956/_0x23f5a6)}};}async[a65_0x3901a7(0x219)](_0x13148d,_0x4fbe6c){const _0x132f88=a65_0x3901a7,_0xbb0ce3=await database_1['default'][_0x132f88(0x1e8)]['findFirst']({'where':{'id':_0x4fbe6c,'shopId':_0x13148d}});if(!_0xbb0ce3)return null;return{'id':_0xbb0ce3['id'],'amount':_0xbb0ce3[_0x132f88(0x1ba)],'network':_0xbb0ce3[_0x132f88(0x1cc)],'status':_0xbb0ce3[_0x132f88(0x1a5)],'txid':_0xbb0ce3[_0x132f88(0x21b)],'notes':_0xbb0ce3[_0x132f88(0x1cf)],'createdAt':_0xbb0ce3['createdAt'],'paidAt':_0xbb0ce3[_0x132f88(0x17f)]};}async[a65_0x3901a7(0x226)](_0x4012c0,_0x26c29c){const _0x25cd7c=a65_0x3901a7,_0x2ca55f=new Date();let _0x935e3,_0x56ea0e;switch(_0x26c29c){case _0x25cd7c(0x204):case _0x25cd7c(0x1b5):const _0x48ca61=new Date(_0x2ca55f);_0x48ca61['setDate'](_0x48ca61[_0x25cd7c(0x21d)]()-0x1),_0x935e3=new Date(_0x48ca61),_0x935e3[_0x25cd7c(0x180)](0x0,0x0,0x0,0x0),_0x56ea0e=new Date(_0x48ca61),_0x56ea0e[_0x25cd7c(0x180)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x935e3=new Date(_0x2ca55f[_0x25cd7c(0x1c3)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x25cd7c(0x1f7):_0x935e3=new Date(_0x2ca55f[_0x25cd7c(0x1c3)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x25cd7c(0x183):_0x935e3=new Date(_0x2ca55f['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x935e3=new Date(_0x2ca55f[_0x25cd7c(0x1c3)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x307988={'gte':_0x935e3};_0x56ea0e&&(_0x307988['lte']=_0x56ea0e);const [_0x1f4bf9,_0x4054d2,_0x17e251,_0x577975,_0x25647f,_0x57f2b5]=await Promise['all']([database_1['default'][_0x25cd7c(0x1e8)][_0x25cd7c(0x19c)]({'where':{'shopId':_0x4012c0,'createdAt':_0x307988}}),database_1[_0x25cd7c(0x1e0)][_0x25cd7c(0x1e8)][_0x25cd7c(0x19c)]({'where':{'shopId':_0x4012c0,'status':_0x25cd7c(0x210),'createdAt':_0x307988}}),database_1[_0x25cd7c(0x1e0)][_0x25cd7c(0x1e8)][_0x25cd7c(0x19c)]({'where':{'shopId':_0x4012c0,'status':_0x25cd7c(0x1df),'createdAt':_0x307988}}),database_1['default'][_0x25cd7c(0x1e8)][_0x25cd7c(0x19c)]({'where':{'shopId':_0x4012c0,'status':'REJECTED','createdAt':_0x307988}}),database_1['default'][_0x25cd7c(0x1e8)]['findMany']({'where':{'shopId':_0x4012c0,'createdAt':_0x307988},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1['default'][_0x25cd7c(0x1e8)][_0x25cd7c(0x1fe)]({'where':{'shopId':_0x4012c0},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x74ceca=_0x25647f['reduce']((_0x375ded,_0x5629f9)=>_0x375ded+_0x5629f9[_0x25cd7c(0x1ba)],0x0),_0x21b38b=_0x25647f['filter'](_0x3dea32=>_0x3dea32[_0x25cd7c(0x1a5)]==='COMPLETED')[_0x25cd7c(0x205)]((_0xef0e5b,_0x115f73)=>_0xef0e5b+_0x115f73[_0x25cd7c(0x1ba)],0x0),_0x155277=_0x25647f['filter'](_0x12fb6f=>_0x12fb6f[_0x25cd7c(0x1a5)]===_0x25cd7c(0x1df))[_0x25cd7c(0x205)]((_0x37092a,_0x233c53)=>_0x37092a+_0x233c53[_0x25cd7c(0x1ba)],0x0),_0x357bb9=_0x25647f[_0x25cd7c(0x205)]((_0xd6367d,_0x227825)=>{const _0x3149de=_0x25cd7c;return _0xd6367d[_0x227825[_0x3149de(0x1cc)]]=(_0xd6367d[_0x227825[_0x3149de(0x1cc)]]||0x0)+0x1,_0xd6367d;},{}),_0x23e111=_0x25647f[_0x25cd7c(0x205)]((_0x273cda,_0x48a6bf)=>{const _0x776313=_0x25cd7c;return _0x273cda[_0x48a6bf[_0x776313(0x1a5)]]=(_0x273cda[_0x48a6bf[_0x776313(0x1a5)]]||0x0)+0x1,_0x273cda;},{});return{'totalPayouts':_0x1f4bf9,'completedPayouts':_0x4054d2,'pendingPayouts':_0x17e251,'rejectedPayouts':_0x577975,'totalAmount':_0x74ceca,'completedAmount':_0x21b38b,'pendingAmount':_0x155277,'payoutsByMethod':_0x357bb9,'payoutsByStatus':_0x23e111,'recentPayouts':_0x57f2b5[_0x25cd7c(0x1d1)](_0x15fee5=>({'id':_0x15fee5['id'],'shopId':_0x4012c0,'amount':_0x15fee5[_0x25cd7c(0x1ba)],'method':_0x15fee5[_0x25cd7c(0x1cc)],'status':_0x15fee5[_0x25cd7c(0x1a5)],'txid':_0x15fee5[_0x25cd7c(0x21b)],'createdAt':_0x15fee5[_0x25cd7c(0x218)],'paidAt':_0x15fee5['paidAt']}))};}async[a65_0x3901a7(0x194)](_0x10a836){const _0xf30728=a65_0x3901a7;console[_0xf30728(0x1ac)]('üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x10a836+_0xf30728(0x209));const _0x1b8f78=await database_1[_0xf30728(0x1e0)]['shop'][_0xf30728(0x1bc)]({'where':{'id':_0x10a836},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1b8f78)throw new Error('Shop\x20not\x20found');const _0x157164=new Date(),_0x5a1301=new Date(_0x157164[_0xf30728(0x216)](),_0x157164[_0xf30728(0x208)](),0x1),_0xef968c=new Date(_0x157164[_0xf30728(0x216)](),_0x157164['getMonth']()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x22bb08=await database_1[_0xf30728(0x1e0)]['payout'][_0xf30728(0x1fc)]({'_sum':{'amount':!![]},'where':{'shopId':_0x10a836,'createdAt':{'gte':_0x5a1301,'lte':_0xef968c},'status':'COMPLETED'}}),_0x39fa80=_0x22bb08['_sum'][_0xf30728(0x1ba)]||0x0,_0xc8795f={'availableBalance':Math[_0xf30728(0x182)](_0x1b8f78[_0xf30728(0x1b1)]*0x64)/0x64,'totalPaidOut':Math[_0xf30728(0x182)](_0x1b8f78[_0xf30728(0x211)]*0x64)/0x64,'awaitingPayout':Math[_0xf30728(0x182)](_0x1b8f78[_0xf30728(0x1b1)]*0x64)/0x64,'thisMonth':Math['round'](_0x39fa80*0x64)/0x64};return console[_0xf30728(0x1ac)](_0xf30728(0x1db)+_0x1b8f78['username']+'\x20payout\x20statistics\x20calculated:'),console[_0xf30728(0x1ac)](_0xf30728(0x1b7)+_0xc8795f[_0xf30728(0x1f2)]+_0xf30728(0x220)),console['log']('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0xc8795f[_0xf30728(0x211)]+'\x20USDT\x20(total\x20payouts)'),console[_0xf30728(0x1ac)]('\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20'+_0xc8795f['awaitingPayout']+_0xf30728(0x220)),console[_0xf30728(0x1ac)](_0xf30728(0x1bf)+_0xc8795f[_0xf30728(0x173)]+_0xf30728(0x1fb)),_0xc8795f;}[a65_0x3901a7(0x21e)](_0x2c507b){const _0x3af64c=a65_0x3901a7,_0xa8e6a6={'test_gateway':_0x3af64c(0x221),'plisio':_0x3af64c(0x213),'rapyd':_0x3af64c(0x201),'noda':_0x3af64c(0x20b),'cointopay':'CoinToPay','klyme_eu':_0x3af64c(0x203),'klyme_gb':_0x3af64c(0x186),'klyme_de':_0x3af64c(0x1ed)};return _0xa8e6a6[_0x2c507b]||_0x2c507b;}async[a65_0x3901a7(0x20e)](_0x33391b){const _0x39c186=a65_0x3901a7;return this[_0x39c186(0x194)](_0x33391b);}async[a65_0x3901a7(0x1a0)](_0x13e514,_0x3e1b6f){const _0xdd8a7d=a65_0x3901a7,{page:_0x485fdf,limit:_0xcb075,paymentId:_0x48aa23}=_0x3e1b6f,_0xbc131=(_0x485fdf-0x1)*_0xcb075,_0x103c1f={'shopId':_0x13e514};_0x48aa23&&(_0x103c1f[_0xdd8a7d(0x1b4)]=_0x48aa23);const [_0x4fbcd5,_0x3dd6a6]=await Promise[_0xdd8a7d(0x1ea)]([database_1[_0xdd8a7d(0x1e0)]['webhookLog']['findMany']({'where':_0x103c1f,'skip':_0xbc131,'take':_0xcb075,'orderBy':{'createdAt':_0xdd8a7d(0x1dd)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0xdd8a7d(0x1e0)][_0xdd8a7d(0x1bb)]['count']({'where':_0x103c1f})]);return{'logs':_0x4fbcd5[_0xdd8a7d(0x1d1)](_0x9b5828=>({'id':_0x9b5828['id'],'paymentId':_0x9b5828[_0xdd8a7d(0x1b4)],'shopId':_0x9b5828[_0xdd8a7d(0x19a)],'event':_0x9b5828[_0xdd8a7d(0x212)],'statusCode':_0x9b5828[_0xdd8a7d(0x1dc)],'retryCount':_0x9b5828['retryCount'],'responseBody':_0x9b5828[_0xdd8a7d(0x20c)],'createdAt':_0x9b5828['createdAt'],'payment':_0x9b5828[_0xdd8a7d(0x222)]})),'pagination':{'page':_0x485fdf,'limit':_0xcb075,'total':_0x3dd6a6,'totalPages':Math[_0xdd8a7d(0x1f4)](_0x3dd6a6/_0xcb075)}};}async[a65_0x3901a7(0x20a)](_0x4035a4,_0x319342,_0x59704c,_0x189569){const _0x3f7ea3=a65_0x3901a7;console[_0x3f7ea3(0x1ac)](_0x3f7ea3(0x1ad)+_0x4035a4+',\x20period:\x20'+_0x319342+_0x3f7ea3(0x1d9)+_0x59704c+',\x20dateTo:\x20'+_0x189569);const _0x3c6e5c=new Date();let _0x3e249a,_0x1ea5b6;if(_0x59704c||_0x189569)_0x59704c?(_0x3e249a=new Date(_0x59704c),_0x3e249a[_0x3f7ea3(0x180)](0x0,0x0,0x0,0x1),console[_0x3f7ea3(0x1ac)]('üìÖ\x20Custom\x20start\x20date:\x20'+_0x3e249a['toISOString']())):(_0x3e249a=new Date(_0x3f7ea3(0x1ec)),_0x3e249a[_0x3f7ea3(0x180)](0x0,0x0,0x0,0x1)),_0x189569&&(_0x1ea5b6=new Date(_0x189569),_0x1ea5b6['setHours'](0x17,0x3b,0x3b,0x3e7),console['log']('üìÖ\x20Custom\x20end\x20date:\x20'+_0x1ea5b6[_0x3f7ea3(0x1d4)]()));else{const _0x27ad10=_0x319342||_0x3f7ea3(0x1f7);switch(_0x27ad10[_0x3f7ea3(0x1f0)]()){case _0x3f7ea3(0x18d):_0x3e249a=new Date(_0x3c6e5c[_0x3f7ea3(0x216)](),_0x3c6e5c[_0x3f7ea3(0x208)](),_0x3c6e5c[_0x3f7ea3(0x21d)](),0x0,0x0,0x0,0x1);break;case _0x3f7ea3(0x204):case _0x3f7ea3(0x1b5):const _0x29d250=new Date(_0x3c6e5c);_0x29d250['setDate'](_0x29d250['getDate']()-0x1),_0x3e249a=new Date(_0x29d250),_0x3e249a[_0x3f7ea3(0x180)](0x0,0x0,0x0,0x1),_0x1ea5b6=new Date(_0x29d250),_0x1ea5b6['setHours'](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x3e249a=new Date(_0x3c6e5c[_0x3f7ea3(0x1c3)]()-0x7*0x18*0x3c*0x3c*0x3e8),_0x3e249a[_0x3f7ea3(0x180)](0x0,0x0,0x0,0x1);break;case _0x3f7ea3(0x1f7):_0x3e249a=new Date(_0x3c6e5c[_0x3f7ea3(0x1c3)]()-0x1e*0x18*0x3c*0x3c*0x3e8),_0x3e249a['setHours'](0x0,0x0,0x0,0x1);break;case'90d':_0x3e249a=new Date(_0x3c6e5c['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8),_0x3e249a[_0x3f7ea3(0x180)](0x0,0x0,0x0,0x1);break;case'1y':case _0x3f7ea3(0x1aa):_0x3e249a=new Date(_0x3c6e5c['getTime']()-0x16d*0x18*0x3c*0x3c*0x3e8),_0x3e249a['setHours'](0x0,0x0,0x0,0x1);break;default:_0x3e249a=new Date(_0x3c6e5c[_0x3f7ea3(0x1c3)]()-0x1e*0x18*0x3c*0x3c*0x3e8),_0x3e249a['setHours'](0x0,0x0,0x0,0x1);}}console[_0x3f7ea3(0x1ac)](_0x3f7ea3(0x1e4)+_0x3e249a['toISOString']()+_0x3f7ea3(0x188)+(_0x1ea5b6?_0x1ea5b6[_0x3f7ea3(0x1d4)]():_0x3f7ea3(0x1a2)));const _0x2d6d49={'gte':_0x3e249a};_0x1ea5b6&&(_0x2d6d49[_0x3f7ea3(0x1e6)]=_0x1ea5b6);const [_0x37a708,_0x5f1c4a,_0x21c413,_0x53ecfb,_0x33d8e4,_0x13bb7d,_0x33962d]=await Promise[_0x3f7ea3(0x1ea)]([database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)][_0x3f7ea3(0x19c)]({'where':{'shopId':_0x4035a4,'gateway':{'not':_0x3f7ea3(0x1d0)},'createdAt':_0x2d6d49}}),database_1[_0x3f7ea3(0x1e0)]['payment'][_0x3f7ea3(0x19c)]({'where':{'shopId':_0x4035a4,'gateway':{'not':'test_gateway'},'status':'PAID','createdAt':_0x2d6d49}}),database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)]['count']({'where':{'shopId':_0x4035a4,'gateway':{'not':_0x3f7ea3(0x1d0)},'status':_0x3f7ea3(0x191),'createdAt':_0x2d6d49}}),database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)][_0x3f7ea3(0x19c)]({'where':{'shopId':_0x4035a4,'gateway':{'not':'test_gateway'},'status':_0x3f7ea3(0x1f6),'createdAt':_0x2d6d49}}),database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)][_0x3f7ea3(0x1fe)]({'where':{'shopId':_0x4035a4,'gateway':{'not':'test_gateway'},'status':_0x3f7ea3(0x1c0),'createdAt':_0x2d6d49},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)]['findMany']({'where':{'shopId':_0x4035a4,'gateway':{'not':'test_gateway'}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x3f7ea3(0x1e0)][_0x3f7ea3(0x222)]['findMany']({'where':{'shopId':_0x4035a4,'gateway':{'not':'test_gateway'},'createdAt':_0x2d6d49},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3f7ea3(0x21a)}})]);let _0x18026d=0x0;for(const _0x5cd4ce of _0x33d8e4){if(_0x5cd4ce[_0x3f7ea3(0x1e3)])_0x18026d+=_0x5cd4ce[_0x3f7ea3(0x1e3)];else{const _0x312e4c=await currencyService_1[_0x3f7ea3(0x214)][_0x3f7ea3(0x1b2)](_0x5cd4ce[_0x3f7ea3(0x1ba)],_0x5cd4ce[_0x3f7ea3(0x21c)]);_0x18026d+=_0x312e4c;}}const _0x372e56=this['generateDailyStatistics'](_0x33962d,_0x3e249a,_0x1ea5b6||_0x3c6e5c),_0xfdc01b=_0x37a708>0x0?_0x5f1c4a/_0x37a708*0x64:0x0;return{'totalPayments':_0x37a708,'successfulPayments':_0x5f1c4a,'totalRevenue':Math[_0x3f7ea3(0x182)](_0x18026d*0x64)/0x64,'conversionRate':Math[_0x3f7ea3(0x182)](_0xfdc01b*0x64)/0x64,'chargebacks':_0x21c413,'refunds':_0x53ecfb,'dailyRevenue':_0x372e56[_0x3f7ea3(0x1cd)],'dailyPayments':_0x372e56[_0x3f7ea3(0x19d)],'recentPayments':_0x13bb7d[_0x3f7ea3(0x1d1)](_0x578dbc=>({'id':_0x578dbc['id'],'gateway':_0x578dbc[_0x3f7ea3(0x184)],'amount':_0x578dbc[_0x3f7ea3(0x1ba)],'currency':_0x578dbc[_0x3f7ea3(0x21c)],'status':_0x578dbc[_0x3f7ea3(0x1a5)],'createdAt':_0x578dbc[_0x3f7ea3(0x218)]}))};}[a65_0x3901a7(0x1a6)](_0x1b5bf3,_0x245653,_0x5d4e0a){const _0x138b0f=a65_0x3901a7,_0x468663=new Map(),_0x625763=new Date(_0x245653);while(_0x625763<=_0x5d4e0a){const _0x510b86=_0x625763[_0x138b0f(0x1d4)]()[_0x138b0f(0x202)]('T')[0x0];_0x468663['set'](_0x510b86,{'revenue':0x0,'count':0x0}),_0x625763[_0x138b0f(0x1c1)](_0x625763[_0x138b0f(0x21d)]()+0x1);}for(const _0x41de4d of _0x1b5bf3){const _0x1cdf69=_0x41de4d['createdAt']['toISOString']()[_0x138b0f(0x202)]('T')[0x0],_0x546ca6=_0x468663[_0x138b0f(0x1e5)](_0x1cdf69);_0x546ca6&&(_0x546ca6[_0x138b0f(0x19c)]+=0x1,_0x41de4d['status']===_0x138b0f(0x1c0)&&_0x41de4d[_0x138b0f(0x1e3)]&&(_0x546ca6[_0x138b0f(0x1ab)]+=_0x41de4d[_0x138b0f(0x1e3)]));}const _0x27c67c=[],_0x3428cf=[];for(const [_0x8e6b87,_0x5deae1]of _0x468663){_0x27c67c[_0x138b0f(0x1a7)]({'date':_0x8e6b87,'amount':Math[_0x138b0f(0x182)](_0x5deae1[_0x138b0f(0x1ab)]*0x64)/0x64}),_0x3428cf['push']({'date':_0x8e6b87,'count':_0x5deae1[_0x138b0f(0x19c)]});}return{'dailyRevenue':_0x27c67c,'dailyPayments':_0x3428cf};}}exports[a65_0x3901a7(0x1e2)]=ShopService;