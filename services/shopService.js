'use strict';const a48_0xa0c371=a48_0x5dc7;(function(_0x5dc472,_0x4f12ad){const _0x5e10a2=a48_0x5dc7,_0x15f6d9=_0x5dc472();while(!![]){try{const _0x4916ae=-parseInt(_0x5e10a2(0xc5))/0x1*(-parseInt(_0x5e10a2(0x12d))/0x2)+-parseInt(_0x5e10a2(0xeb))/0x3+parseInt(_0x5e10a2(0xb0))/0x4*(parseInt(_0x5e10a2(0x155))/0x5)+-parseInt(_0x5e10a2(0x123))/0x6*(-parseInt(_0x5e10a2(0x13b))/0x7)+-parseInt(_0x5e10a2(0xad))/0x8+-parseInt(_0x5e10a2(0x163))/0x9+-parseInt(_0x5e10a2(0x177))/0xa*(-parseInt(_0x5e10a2(0x14d))/0xb);if(_0x4916ae===_0x4f12ad)break;else _0x15f6d9['push'](_0x15f6d9['shift']());}catch(_0x9a3015){_0x15f6d9['push'](_0x15f6d9['shift']());}}}(a48_0x56d2,0x7fe8c));var __importDefault=this&&this['__importDefault']||function(_0x4abe20){const _0x39134c=a48_0x5dc7;return _0x4abe20&&_0x4abe20[_0x39134c(0x134)]?_0x4abe20:{'default':_0x4abe20};};function a48_0x5dc7(_0x56599d,_0x3ba61e){const _0x56d2fd=a48_0x56d2();return a48_0x5dc7=function(_0x5dc77a,_0x4cf344){_0x5dc77a=_0x5dc77a-0xa5;let _0x39d66b=_0x56d2fd[_0x5dc77a];return _0x39d66b;},a48_0x5dc7(_0x56599d,_0x3ba61e);}Object[a48_0xa0c371(0x10c)](exports,a48_0xa0c371(0x134),{'value':!![]}),exports[a48_0xa0c371(0x14f)]=void 0x0;const database_1=__importDefault(require(a48_0xa0c371(0xc9))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require(a48_0xa0c371(0x160)),nodaService_1=require(a48_0xa0c371(0xcc)),coinToPayService_1=require('./gateways/coinToPayService'),klymeService_1=require(a48_0xa0c371(0x145)),currencyService_1=require(a48_0xa0c371(0x130)),gateway_1=require(a48_0xa0c371(0x16a));class ShopService{constructor(){const _0x35a54c=a48_0xa0c371;this[_0x35a54c(0xd5)]=new plisioService_1['PlisioService'](),this['rapydService']=new rapydService_1[(_0x35a54c(0x101))](),this['nodaService']=new nodaService_1['NodaService'](),this[_0x35a54c(0xa5)]=new coinToPayService_1[(_0x35a54c(0xcf))](),this[_0x35a54c(0x139)]=new klymeService_1[(_0x35a54c(0xdc))]();}async[a48_0xa0c371(0xb8)](){const _0x47c965=a48_0xa0c371;let _0x1cc5dd,_0xaa5f46=0x0;const _0x50d71b=0xa;do{const _0x23e4b9=()=>{const _0x2e93c9=a48_0x5dc7;return Math[_0x2e93c9(0xc2)](Math['random']()*0x5f5e100)['toString']()[_0x2e93c9(0xcb)](0x8,'0');};_0x1cc5dd=_0x23e4b9()+'-'+_0x23e4b9();const _0x1a7615=await database_1[_0x47c965(0xb2)][_0x47c965(0xe6)][_0x47c965(0xd4)]({'where':{'gatewayOrderId':_0x1cc5dd}});if(!_0x1a7615)break;_0xaa5f46++,console[_0x47c965(0x127)](_0x47c965(0x14e)+_0x1cc5dd+'\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20'+_0xaa5f46+')');}while(_0xaa5f46<_0x50d71b);if(_0xaa5f46>=_0x50d71b)throw new Error(_0x47c965(0x15b));return _0x1cc5dd;}[a48_0xa0c371(0xef)](_0x24e137,_0x1237ba,_0x30ac0a,_0x421c71,_0x493534){const _0x52c5cb=a48_0xa0c371;if(_0x421c71&&_0x493534)return{'finalSuccessUrl':_0x421c71,'finalFailUrl':_0x493534};let _0x2b8abf,_0x5123a9;return _0x24e137==='noda'||_0x24e137[_0x52c5cb(0x11c)](_0x52c5cb(0x124))?_0x2b8abf=_0x421c71||_0x30ac0a+'/payment/pending?payment_id='+_0x1237ba:_0x2b8abf=_0x421c71||_0x30ac0a+_0x52c5cb(0xf5)+_0x1237ba,_0x5123a9=_0x493534||_0x30ac0a+_0x52c5cb(0x151)+_0x1237ba,console[_0x52c5cb(0x127)](_0x52c5cb(0x15c)+_0x24e137+':'),console[_0x52c5cb(0x127)](_0x52c5cb(0xd2)+_0x2b8abf),console[_0x52c5cb(0x127)](_0x52c5cb(0xbc)+_0x5123a9),{'finalSuccessUrl':_0x2b8abf,'finalFailUrl':_0x5123a9};}[a48_0xa0c371(0x17f)](_0x388474,_0x47c177){const _0x1b177b=a48_0xa0c371,_0x1318a5=_0x388474[_0x1b177b(0x15d)]?JSON['parse'](_0x388474[_0x1b177b(0x15d)]):null,_0x7d1450=_0x47c177[_0x1b177b(0x175)](0x0)['toUpperCase']()+_0x47c177['slice'](0x1)[_0x1b177b(0x171)]();if(_0x1318a5&&_0x1318a5[_0x7d1450])return{'commission':_0x1318a5[_0x7d1450][_0x1b177b(0x105)],'payoutDelay':_0x1318a5[_0x7d1450][_0x1b177b(0x111)]};return{'commission':0x0,'payoutDelay':0x0};}[a48_0xa0c371(0x149)](_0x4ceee4,_0x2efb48){const _0xa02c85=a48_0xa0c371;if(_0x4ceee4['status']!==_0xa02c85(0x16b)||_0x4ceee4[_0xa02c85(0x159)]||!_0x4ceee4['paidAt'])return![];const _0x58f7bd=_0x2efb48['payoutDelay']*0x18*0x3c*0x3c*0x3e8,_0x2bb696=new Date(_0x4ceee4[_0xa02c85(0xbe)][_0xa02c85(0x164)]()+_0x58f7bd);return new Date()>_0x2bb696;}[a48_0xa0c371(0xe5)](_0x4aa266,_0x15cff2){return _0x4aa266*(0x1-_0x15cff2/0x64);}async['getShopProfile'](_0x39adeb){const _0x5965a5=a48_0xa0c371,_0x29ec78=await database_1[_0x5965a5(0xb2)][_0x5965a5(0x13a)][_0x5965a5(0x112)]({'where':{'id':_0x39adeb},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x29ec78)throw new Error(_0x5965a5(0x11b));return{'id':_0x29ec78['id'],'fullName':_0x29ec78[_0x5965a5(0x150)],'username':_0x29ec78[_0x5965a5(0x178)],'telegramId':_0x29ec78[_0x5965a5(0xde)],'merchantUrl':_0x29ec78[_0x5965a5(0x169)],'gateways':_0x29ec78[_0x5965a5(0x115)]?JSON[_0x5965a5(0x10f)](_0x29ec78[_0x5965a5(0x115)]):null,'gatewaySettings':_0x29ec78[_0x5965a5(0x15d)]?JSON['parse'](_0x29ec78[_0x5965a5(0x15d)]):null,'publicKey':_0x29ec78[_0x5965a5(0xe9)],'wallets':{'usdtPolygonWallet':_0x29ec78[_0x5965a5(0x179)],'usdtTrcWallet':_0x29ec78[_0x5965a5(0xcd)],'usdtErcWallet':_0x29ec78[_0x5965a5(0xb1)],'usdcPolygonWallet':_0x29ec78[_0x5965a5(0x170)]},'status':_0x29ec78[_0x5965a5(0x106)],'createdAt':_0x29ec78[_0x5965a5(0x11f)]};}async[a48_0xa0c371(0x128)](_0x58f9aa,_0x22f28d){const _0x2f3e3e=a48_0xa0c371,_0x36b52e={..._0x22f28d};_0x22f28d['fullName']&&(_0x36b52e[_0x2f3e3e(0x150)]=_0x22f28d[_0x2f3e3e(0xaa)],delete _0x36b52e[_0x2f3e3e(0xaa)]);_0x22f28d[_0x2f3e3e(0xbf)]&&(_0x36b52e['telegram']=_0x22f28d[_0x2f3e3e(0xbf)],delete _0x36b52e[_0x2f3e3e(0xbf)]);_0x22f28d['merchantUrl']&&(_0x36b52e[_0x2f3e3e(0x169)]=_0x22f28d['merchantUrl'],delete _0x36b52e['merchantUrl']);_0x22f28d[_0x2f3e3e(0x108)]&&(_0x36b52e['paymentGateways']=JSON['stringify'](_0x22f28d[_0x2f3e3e(0x108)]),delete _0x36b52e[_0x2f3e3e(0x108)]);_0x22f28d[_0x2f3e3e(0x15d)]&&(_0x36b52e[_0x2f3e3e(0x15d)]=JSON[_0x2f3e3e(0x116)](_0x22f28d[_0x2f3e3e(0x15d)]),delete _0x36b52e['gatewaySettings']);_0x22f28d[_0x2f3e3e(0x12c)]&&(_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0x179)]!==undefined&&(_0x36b52e[_0x2f3e3e(0x179)]=_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0x179)]||null),_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0xcd)]!==undefined&&(_0x36b52e[_0x2f3e3e(0xcd)]=_0x22f28d[_0x2f3e3e(0x12c)]['usdtTrcWallet']||null),_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0xb1)]!==undefined&&(_0x36b52e[_0x2f3e3e(0xb1)]=_0x22f28d[_0x2f3e3e(0x12c)]['usdtErcWallet']||null),_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0x170)]!==undefined&&(_0x36b52e['usdcPolygonWallet']=_0x22f28d[_0x2f3e3e(0x12c)][_0x2f3e3e(0x170)]||null),delete _0x36b52e['wallets']);const _0x1bab79=await database_1[_0x2f3e3e(0xb2)][_0x2f3e3e(0x13a)][_0x2f3e3e(0xf6)]({'where':{'id':_0x58f9aa},'data':_0x36b52e,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x1bab79['id'],'fullName':_0x1bab79[_0x2f3e3e(0x150)],'username':_0x1bab79[_0x2f3e3e(0x178)],'telegramId':_0x1bab79[_0x2f3e3e(0xde)],'merchantUrl':_0x1bab79[_0x2f3e3e(0x169)],'gateways':_0x1bab79[_0x2f3e3e(0x115)]?JSON['parse'](_0x1bab79[_0x2f3e3e(0x115)]):null,'gatewaySettings':_0x1bab79[_0x2f3e3e(0x15d)]?JSON[_0x2f3e3e(0x10f)](_0x1bab79[_0x2f3e3e(0x15d)]):null,'publicKey':_0x1bab79['publicKey'],'wallets':{'usdtPolygonWallet':_0x1bab79['usdtPolygonWallet'],'usdtTrcWallet':_0x1bab79[_0x2f3e3e(0xcd)],'usdtErcWallet':_0x1bab79[_0x2f3e3e(0xb1)],'usdcPolygonWallet':_0x1bab79[_0x2f3e3e(0x170)]},'status':_0x1bab79['status'],'createdAt':_0x1bab79['createdAt']};}async[a48_0xa0c371(0xf7)](_0x449d93,_0x71105f){const _0x4f4c47=a48_0xa0c371,_0x3afd14={};_0x71105f['usdtPolygonWallet']!==undefined&&(_0x3afd14[_0x4f4c47(0x179)]=_0x71105f[_0x4f4c47(0x179)]||null),_0x71105f['usdtTrcWallet']!==undefined&&(_0x3afd14[_0x4f4c47(0xcd)]=_0x71105f[_0x4f4c47(0xcd)]||null),_0x71105f[_0x4f4c47(0xb1)]!==undefined&&(_0x3afd14[_0x4f4c47(0xb1)]=_0x71105f['usdtErcWallet']||null),_0x71105f[_0x4f4c47(0x170)]!==undefined&&(_0x3afd14[_0x4f4c47(0x170)]=_0x71105f['usdcPolygonWallet']||null),await database_1[_0x4f4c47(0xb2)][_0x4f4c47(0x13a)]['update']({'where':{'id':_0x449d93},'data':_0x3afd14});}async[a48_0xa0c371(0x104)](_0x18a213){const _0x5d0f99=a48_0xa0c371,_0x201ff0=await database_1[_0x5d0f99(0xb2)][_0x5d0f99(0x13a)][_0x5d0f99(0x112)]({'where':{'id':_0x18a213},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x201ff0)throw new Error('Shop\x20not\x20found');const _0x3c77d6=_0x201ff0[_0x5d0f99(0xb6)]?.[_0x5d0f99(0x16d)];if(!_0x3c77d6)throw new Error('No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.');const _0x18742b=await this['generateGatewayOrderId'](),_0x42fd61={'event':_0x5d0f99(0xa6),'payment':{'id':_0x5d0f99(0xda)+Date[_0x5d0f99(0x144)](),'order_id':null,'gateway_order_id':_0x18742b,'gateway':_0x5d0f99(0xa7),'amount':0x64,'currency':_0x5d0f99(0xd0),'status':_0x5d0f99(0xb4),'customer_email':'test@example.com','customer_name':_0x5d0f99(0x11d),'created_at':new Date()[_0x5d0f99(0x118)](),'updated_at':new Date()[_0x5d0f99(0x118)]()},'test':!![],'shop':{'id':_0x201ff0['id'],'name':_0x201ff0[_0x5d0f99(0x150)]},'timestamp':new Date()[_0x5d0f99(0x118)]()},_0x9d340b=Date[_0x5d0f99(0x144)]();let _0x357f0d=0x0,_0x185f58=![],_0x1579eb;try{console['log'](_0x5d0f99(0x153)+_0x3c77d6),console[_0x5d0f99(0x127)](_0x5d0f99(0xfc),JSON[_0x5d0f99(0x116)](_0x42fd61,null,0x2));const _0x192c10=await fetch(_0x3c77d6,{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x5d0f99(0xc4),'X-Webhook-Test':'true'},'body':JSON['stringify'](_0x42fd61)});_0x357f0d=_0x192c10['status'],_0x185f58=_0x192c10['ok'];if(!_0x192c10['ok']){const _0x131362=await _0x192c10[_0x5d0f99(0x172)]();_0x1579eb=_0x5d0f99(0x12b)+_0x192c10[_0x5d0f99(0x106)]+':\x20'+_0x131362,console['error']('❌\x20Test\x20webhook\x20failed:\x20'+_0x1579eb);}else console[_0x5d0f99(0x127)](_0x5d0f99(0x125)+_0x192c10[_0x5d0f99(0x106)]);}catch(_0x1f307e){_0x1579eb=_0x1f307e instanceof Error?_0x1f307e[_0x5d0f99(0xb9)]:_0x5d0f99(0x140),console[_0x5d0f99(0x156)]('❌\x20Test\x20webhook\x20error:\x20'+_0x1579eb);}const _0xfacda8=Date[_0x5d0f99(0x144)]()-_0x9d340b;try{await database_1[_0x5d0f99(0xb2)][_0x5d0f99(0x152)][_0x5d0f99(0x12e)]({'data':{'paymentId':_0x5d0f99(0x14b),'shopId':_0x201ff0['id'],'event':_0x5d0f99(0x14b),'statusCode':_0x357f0d,'responseBody':JSON['stringify']({'success':_0x185f58,'error':_0x1579eb,'responseTime':_0xfacda8,'testPayload':_0x42fd61})}});}catch(_0xe62179){console['error'](_0x5d0f99(0x16e),_0xe62179);}return{'webhookUrl':_0x3c77d6,'statusCode':_0x357f0d,'responseTime':_0xfacda8,'success':_0x185f58,'error':_0x1579eb};}async['createPayment'](_0x22ad32){const _0x3d87f4=a48_0xa0c371;let _0x3fdce2;if((0x0,gateway_1['isValidGatewayId'])(_0x22ad32[_0x3d87f4(0x11a)])){const _0x1b2abd=(0x0,gateway_1[_0x3d87f4(0xec)])(_0x22ad32[_0x3d87f4(0x11a)]);if(!_0x1b2abd)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x22ad32[_0x3d87f4(0x11a)]);_0x3fdce2=_0x1b2abd;}else _0x3fdce2=_0x22ad32[_0x3d87f4(0x11a)]['toLowerCase']();console[_0x3d87f4(0x127)]('🔄\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20'+_0x3fdce2);const _0x57cf43=await this['generateGatewayOrderId']();console[_0x3d87f4(0x127)]('🎯\x20Generated\x20unique\x20gateway\x20order_id:\x20'+_0x57cf43+'\x20(8digits-8digits\x20format\x20for\x20'+_0x3fdce2+')');const _0x770d03=await database_1[_0x3d87f4(0xb2)]['shop']['findUnique']({'where':{'id':_0x22ad32[_0x3d87f4(0x11e)]},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x770d03)throw new Error(_0x3d87f4(0x11b));const _0x3db237=this['getGatewaySettings'](_0x770d03,_0x3fdce2),_0x2fa5dc=process[_0x3d87f4(0x17d)]['BASE_URL']||'https://tesoft.uk',{finalSuccessUrl:_0x32e835,finalFailUrl:_0x4641d6}=this[_0x3d87f4(0xef)](_0x3fdce2,_0x57cf43,_0x2fa5dc,_0x22ad32[_0x3d87f4(0x173)],undefined),_0x559284=await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)]['create']({'data':{'shopId':_0x22ad32['shopId'],'gateway':_0x3fdce2,'amount':_0x22ad32[_0x3d87f4(0xdb)],'currency':_0x22ad32[_0x3d87f4(0xac)]||'USD','sourceCurrency':_0x22ad32[_0x3d87f4(0x119)]||null,'usage':_0x22ad32[_0x3d87f4(0xb7)]||_0x3d87f4(0x12f),'expiresAt':_0x22ad32[_0x3d87f4(0xed)],'successUrl':_0x32e835,'failUrl':_0x4641d6,'status':_0x3d87f4(0x137),'orderId':null,'gatewayOrderId':_0x57cf43,'customerEmail':_0x22ad32['customerEmail']||null,'customerName':_0x22ad32[_0x3d87f4(0x158)]||null,'country':_0x22ad32[_0x3d87f4(0xd9)]||null,'language':_0x22ad32['language']||null,'amountIsEditable':_0x22ad32['amountIsEditable']||null,'maxPayments':_0x22ad32[_0x3d87f4(0xb3)]||null,'rapydCustomer':_0x22ad32[_0x3d87f4(0xe4)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console[_0x3d87f4(0x127)](_0x3d87f4(0xc8)+_0x57cf43+_0x3d87f4(0x157));let _0x3fe6d2;try{if(_0x3fdce2===_0x3d87f4(0xa7)){let _0x18930b,_0x3dc233,_0x5712f0;_0x22ad32[_0x3d87f4(0x119)]?(_0x18930b=_0x22ad32[_0x3d87f4(0x119)],_0x3dc233=_0x22ad32[_0x3d87f4(0xac)]||_0x3d87f4(0xd0),_0x5712f0=![]):(_0x18930b=_0x3d87f4(0xd0),_0x3dc233=_0x22ad32[_0x3d87f4(0xac)]||'USD',_0x5712f0=!![]);const _0x3c4d5a=await this['plisioService']['createPayment']({'paymentId':_0x559284['id'],'orderId':_0x57cf43,'amount':_0x22ad32[_0x3d87f4(0xdb)],'currency':_0x18930b,'productName':_0x3d87f4(0x129)+_0x57cf43,'description':_0x3d87f4(0x129)+_0x57cf43,'successUrl':_0x32e835,'failUrl':_0x4641d6,'customerEmail':_0x22ad32['customerEmail'],'customerName':_0x22ad32[_0x3d87f4(0x158)],'isSourceCurrency':_0x5712f0});_0x3fe6d2=_0x3c4d5a[_0x3d87f4(0x167)],await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)][_0x3d87f4(0xf6)]({'where':{'id':_0x559284['id']},'data':{'externalPaymentUrl':_0x3fe6d2,'gatewayPaymentId':_0x3c4d5a['gateway_payment_id'],'invoiceTotalSum':_0x3c4d5a['invoice_total_sum'],'qrCode':_0x3c4d5a[_0x3d87f4(0x176)],'qrUrl':_0x3c4d5a[_0x3d87f4(0x162)]}}),_0x559284[_0x3d87f4(0xd7)]=_0x3fe6d2,_0x559284[_0x3d87f4(0x102)]=_0x3c4d5a[_0x3d87f4(0x180)];}else{if(_0x3fdce2===_0x3d87f4(0xce)){const _0x49cbdb='GB';console[_0x3d87f4(0x127)](_0x3d87f4(0x10d));const _0x3dfa79=await this[_0x3d87f4(0x12a)]['createPaymentLink']({'paymentId':_0x559284['id'],'orderId':_0x57cf43,'orderName':'Order\x20ID:\x20'+_0x57cf43,'amount':_0x22ad32[_0x3d87f4(0xdb)],'currency':_0x22ad32['currency']||_0x3d87f4(0xd0),'country':_0x49cbdb,'usage':_0x22ad32[_0x3d87f4(0xb7)]||_0x3d87f4(0x12f),'maxPayments':_0x22ad32[_0x3d87f4(0xb3)],'successUrl':_0x32e835,'failUrl':_0x4641d6});_0x3fe6d2=_0x3dfa79[_0x3d87f4(0x167)],await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)]['update']({'where':{'id':_0x559284['id']},'data':{'externalPaymentUrl':_0x3fe6d2,'gatewayPaymentId':_0x3dfa79[_0x3d87f4(0x180)],'country':_0x49cbdb}}),_0x559284[_0x3d87f4(0xd7)]=_0x3fe6d2,_0x559284['gatewayPaymentId']=_0x3dfa79[_0x3d87f4(0x180)];}else{if(_0x3fdce2===_0x3d87f4(0xbd)){console[_0x3d87f4(0x127)](_0x3d87f4(0x17c)+_0x57cf43+_0x3d87f4(0x157));const _0x585bcd=await this[_0x3d87f4(0xe3)][_0x3d87f4(0xff)]({'paymentId':_0x559284['id'],'orderId':_0x57cf43,'name':_0x3d87f4(0x129)+_0x57cf43,'paymentDescription':'Order\x20ID:\x20'+_0x57cf43,'amount':_0x22ad32[_0x3d87f4(0xdb)],'currency':_0x22ad32[_0x3d87f4(0xac)]||_0x3d87f4(0xd0),'webhookUrl':_0x3d87f4(0x13c),'returnUrl':_0x32e835,'expiryDate':_0x22ad32['expiresAt']?.[_0x3d87f4(0x118)]()});_0x3fe6d2=_0x585bcd[_0x3d87f4(0x167)],await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)][_0x3d87f4(0xf6)]({'where':{'id':_0x559284['id']},'data':{'externalPaymentUrl':_0x3fe6d2,'gatewayPaymentId':_0x585bcd[_0x3d87f4(0x180)],'qrUrl':_0x585bcd[_0x3d87f4(0x113)]}}),_0x559284[_0x3d87f4(0xd7)]=_0x3fe6d2,_0x559284[_0x3d87f4(0x102)]=_0x585bcd[_0x3d87f4(0x180)],console[_0x3d87f4(0x127)](_0x3d87f4(0x122)+_0x57cf43);}else{if(_0x3fdce2===_0x3d87f4(0x15a)){console['log'](_0x3d87f4(0x121)+_0x57cf43+_0x3d87f4(0x157)),console[_0x3d87f4(0x127)](_0x3d87f4(0xdf)+_0x22ad32['amount']+'\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)');const _0x26538c=await this[_0x3d87f4(0xa5)][_0x3d87f4(0xff)]({'paymentId':_0x559284['id'],'orderId':_0x57cf43,'amount':_0x22ad32[_0x3d87f4(0xdb)]});_0x3fe6d2=_0x26538c[_0x3d87f4(0x167)],await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)][_0x3d87f4(0xf6)]({'where':{'id':_0x559284['id']},'data':{'externalPaymentUrl':_0x3fe6d2,'gatewayPaymentId':_0x26538c['gateway_payment_id'],'currency':_0x3d87f4(0xc0)}}),_0x559284['externalPaymentUrl']=_0x3fe6d2,_0x559284[_0x3d87f4(0x102)]=_0x26538c[_0x3d87f4(0x180)],console['log'](_0x3d87f4(0x13e)+_0x57cf43);}else{if(_0x3fdce2[_0x3d87f4(0x11c)](_0x3d87f4(0x124))){const _0x18b286=(0x0,gateway_1[_0x3d87f4(0x181)])(_0x3fdce2);if(!_0x18b286)throw new Error('Invalid\x20KLYME\x20gateway:\x20'+_0x3fdce2);if(_0x18b286!=='EU'&&_0x18b286!=='GB')throw new Error(_0x3d87f4(0x142)+_0x18b286);console['log']('💳\x20Creating\x20KLYME\x20'+_0x18b286+_0x3d87f4(0x132)+_0x57cf43+_0x3d87f4(0x157)),console[_0x3d87f4(0x127)]('💰\x20Amount:\x20'+_0x22ad32[_0x3d87f4(0xdb)]+'\x20'+(_0x22ad32['currency']||'USD'));const _0x14b1fd=await this[_0x3d87f4(0x139)][_0x3d87f4(0xff)]({'paymentId':_0x559284['id'],'orderId':_0x57cf43,'amount':_0x22ad32[_0x3d87f4(0xdb)],'currency':_0x22ad32[_0x3d87f4(0xac)]||_0x3d87f4(0xd0),'region':_0x18b286,'redirectUrl':_0x32e835});_0x3fe6d2=_0x14b1fd[_0x3d87f4(0x167)],await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)][_0x3d87f4(0xf6)]({'where':{'id':_0x559284['id']},'data':{'externalPaymentUrl':_0x3fe6d2,'gatewayPaymentId':_0x14b1fd[_0x3d87f4(0x180)]}}),_0x559284[_0x3d87f4(0xd7)]=_0x3fe6d2,_0x559284[_0x3d87f4(0x102)]=_0x14b1fd[_0x3d87f4(0x180)],console[_0x3d87f4(0x127)](_0x3d87f4(0x13d)+_0x18b286+_0x3d87f4(0xf4)+_0x57cf43);}}}}}}catch(_0x47fe1e){await database_1[_0x3d87f4(0xb2)][_0x3d87f4(0xe6)]['update']({'where':{'id':_0x559284['id']},'data':{'status':_0x3d87f4(0xe7)}}),console['error'](_0x3d87f4(0x126),_0x47fe1e);}const _0x32252b='https://tesoft.uk/gateway/payment.php?id='+_0x559284['id'];return{'id':_0x559284['id'],'shopId':_0x559284[_0x3d87f4(0x11e)],'gateway':_0x559284[_0x3d87f4(0x11a)],'amount':_0x559284[_0x3d87f4(0xdb)],'currency':_0x559284[_0x3d87f4(0xac)],'sourceCurrency':_0x559284[_0x3d87f4(0x119)],'usage':_0x559284['usage'],'expiresAt':_0x559284[_0x3d87f4(0xed)],'redirectUrl':_0x32252b,'status':_0x559284[_0x3d87f4(0x106)],'externalPaymentUrl':_0x3fe6d2,'customerEmail':_0x559284['customerEmail'],'customerName':_0x559284['customerName'],'country':_0x559284[_0x3d87f4(0xd9)],'language':_0x559284[_0x3d87f4(0xd6)],'amountIsEditable':_0x559284[_0x3d87f4(0x16c)],'maxPayments':_0x559284[_0x3d87f4(0xb3)],'customer':_0x559284[_0x3d87f4(0x15e)],'createdAt':_0x559284[_0x3d87f4(0x11f)],'updatedAt':_0x559284['updatedAt'],'shop':_0x559284[_0x3d87f4(0x13a)]};}async[a48_0xa0c371(0x110)](_0x29641f,_0x21d893){const _0x571ee3=a48_0xa0c371,{page:_0x1b4c28,limit:_0x4bdad2,status:_0x33f1a0,gateway:_0x5a0643}=_0x21d893,_0x3dc627=(_0x1b4c28-0x1)*_0x4bdad2,_0x529e1c={'shopId':_0x29641f};_0x33f1a0&&(_0x529e1c['status']=_0x33f1a0);if(_0x5a0643){if((0x0,gateway_1[_0x571ee3(0x146)])(_0x5a0643)){const _0x19b4de=(0x0,gateway_1[_0x571ee3(0xec)])(_0x5a0643);_0x19b4de&&(_0x529e1c[_0x571ee3(0x11a)]=_0x19b4de);}else _0x529e1c['gateway']=_0x5a0643[_0x571ee3(0x171)]();}const [_0x1cb0f1,_0x2e40a1]=await Promise[_0x571ee3(0x166)]([database_1[_0x571ee3(0xb2)][_0x571ee3(0xe6)]['findMany']({'where':_0x529e1c,'skip':_0x3dc627,'take':_0x4bdad2,'orderBy':{'createdAt':_0x571ee3(0xc7)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1[_0x571ee3(0xb2)][_0x571ee3(0xe6)][_0x571ee3(0x131)]({'where':_0x529e1c})]);return{'payments':_0x1cb0f1[_0x571ee3(0x154)](_0x3d0bcd=>{const _0x4c03d1=_0x571ee3,_0x8619c9=_0x4c03d1(0x15f)+_0x3d0bcd['id'];return{'id':_0x3d0bcd['id'],'shopId':_0x3d0bcd['shopId'],'gateway':_0x3d0bcd[_0x4c03d1(0x11a)],'amount':_0x3d0bcd[_0x4c03d1(0xdb)],'currency':_0x3d0bcd[_0x4c03d1(0xac)],'sourceCurrency':_0x3d0bcd[_0x4c03d1(0x119)],'usage':_0x3d0bcd[_0x4c03d1(0xb7)],'expiresAt':_0x3d0bcd[_0x4c03d1(0xed)],'redirectUrl':_0x8619c9,'status':_0x3d0bcd[_0x4c03d1(0x106)],'externalPaymentUrl':_0x3d0bcd[_0x4c03d1(0xd7)],'customerEmail':_0x3d0bcd[_0x4c03d1(0xfd)],'customerName':_0x3d0bcd[_0x4c03d1(0x158)],'country':_0x3d0bcd['country'],'language':_0x3d0bcd['language'],'amountIsEditable':_0x3d0bcd[_0x4c03d1(0x16c)],'maxPayments':_0x3d0bcd[_0x4c03d1(0xb3)],'customer':_0x3d0bcd[_0x4c03d1(0x15e)],'createdAt':_0x3d0bcd['createdAt'],'updatedAt':_0x3d0bcd[_0x4c03d1(0x138)],'shop':_0x3d0bcd[_0x4c03d1(0x13a)]};}),'pagination':{'page':_0x1b4c28,'limit':_0x4bdad2,'total':_0x2e40a1,'totalPages':Math[_0x571ee3(0xaf)](_0x2e40a1/_0x4bdad2)}};}async[a48_0xa0c371(0xf1)](_0x26a213,_0x4ccca4){const _0x370896=a48_0xa0c371,_0x6b2cb3=await database_1[_0x370896(0xb2)][_0x370896(0xe6)][_0x370896(0xd4)]({'where':{'id':_0x4ccca4,'shopId':_0x26a213},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x370896(0xc7)},'take':0xa}}});if(!_0x6b2cb3)return null;const _0x7ca173='https://tesoft.uk/gateway/payment.php?id='+_0x6b2cb3['id'];return{'id':_0x6b2cb3['id'],'shopId':_0x6b2cb3[_0x370896(0x11e)],'gateway':_0x6b2cb3[_0x370896(0x11a)],'amount':_0x6b2cb3['amount'],'currency':_0x6b2cb3[_0x370896(0xac)],'sourceCurrency':_0x6b2cb3[_0x370896(0x119)],'usage':_0x6b2cb3['usage'],'expiresAt':_0x6b2cb3[_0x370896(0xed)],'redirectUrl':_0x7ca173,'status':_0x6b2cb3[_0x370896(0x106)],'externalPaymentUrl':_0x6b2cb3[_0x370896(0xd7)],'customerEmail':_0x6b2cb3[_0x370896(0xfd)],'customerName':_0x6b2cb3[_0x370896(0x158)],'country':_0x6b2cb3[_0x370896(0xd9)],'language':_0x6b2cb3['language'],'amountIsEditable':_0x6b2cb3['amountIsEditable'],'maxPayments':_0x6b2cb3['maxPayments'],'customer':_0x6b2cb3[_0x370896(0x15e)],'createdAt':_0x6b2cb3['createdAt'],'updatedAt':_0x6b2cb3[_0x370896(0x138)],'shop':_0x6b2cb3[_0x370896(0x13a)],'webhookLogs':_0x6b2cb3[_0x370896(0x10e)]};}async[a48_0xa0c371(0xba)](_0x313485,_0x3c6081,_0x89d737){const _0x38a7bf=a48_0xa0c371,_0xd712a3={..._0x89d737};if(_0x89d737[_0x38a7bf(0x11a)]){if((0x0,gateway_1['isValidGatewayId'])(_0x89d737[_0x38a7bf(0x11a)])){const _0x4c4e52=(0x0,gateway_1[_0x38a7bf(0xec)])(_0x89d737[_0x38a7bf(0x11a)]);_0x4c4e52&&(_0xd712a3[_0x38a7bf(0x11a)]=_0x4c4e52);}else _0xd712a3[_0x38a7bf(0x11a)]=_0x89d737['gateway'][_0x38a7bf(0x171)]();}const _0x223b69=await database_1[_0x38a7bf(0xb2)][_0x38a7bf(0xe6)][_0x38a7bf(0xf6)]({'where':{'id':_0x3c6081,'shopId':_0x313485},'data':_0xd712a3,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x3cf1ba=_0x38a7bf(0x15f)+_0x223b69['id'];return{'id':_0x223b69['id'],'shopId':_0x223b69[_0x38a7bf(0x11e)],'gateway':_0x223b69['gateway'],'amount':_0x223b69[_0x38a7bf(0xdb)],'currency':_0x223b69[_0x38a7bf(0xac)],'sourceCurrency':_0x223b69[_0x38a7bf(0x119)],'usage':_0x223b69['usage'],'expiresAt':_0x223b69[_0x38a7bf(0xed)],'redirectUrl':_0x3cf1ba,'status':_0x223b69[_0x38a7bf(0x106)],'externalPaymentUrl':_0x223b69['externalPaymentUrl'],'customerEmail':_0x223b69[_0x38a7bf(0xfd)],'customerName':_0x223b69[_0x38a7bf(0x158)],'country':_0x223b69['country'],'language':_0x223b69[_0x38a7bf(0xd6)],'amountIsEditable':_0x223b69[_0x38a7bf(0x16c)],'maxPayments':_0x223b69[_0x38a7bf(0xb3)],'customer':_0x223b69['rapydCustomer'],'createdAt':_0x223b69[_0x38a7bf(0x11f)],'updatedAt':_0x223b69[_0x38a7bf(0x138)],'shop':_0x223b69[_0x38a7bf(0x13a)]};}async['deletePayment'](_0x22c6df,_0x305d28){const _0x17007c=a48_0xa0c371;await database_1[_0x17007c(0xb2)][_0x17007c(0xe6)][_0x17007c(0xe0)]({'where':{'id':_0x305d28,'shopId':_0x22c6df}});}async['getPayouts'](_0x52db5e,_0x54fec8){const _0x428c3f=a48_0xa0c371,{page:_0x3371c5,limit:_0x5318fd,status:_0x1f72c7,method:_0x3c5bf6,dateFrom:_0x525021,dateTo:_0x2560ba}=_0x54fec8,_0x37564c=(_0x3371c5-0x1)*_0x5318fd,_0xa827bf={'shopId':_0x52db5e};_0x1f72c7&&(_0xa827bf[_0x428c3f(0x106)]=_0x1f72c7);_0x3c5bf6&&(_0xa827bf['network']=_0x3c5bf6);(_0x525021||_0x2560ba)&&(_0xa827bf['createdAt']={},_0x525021&&(_0xa827bf[_0x428c3f(0x11f)]['gte']=new Date(_0x525021)),_0x2560ba&&(_0xa827bf[_0x428c3f(0x11f)][_0x428c3f(0x174)]=new Date(_0x2560ba)));const [_0x284245,_0x57ca64]=await Promise[_0x428c3f(0x166)]([database_1[_0x428c3f(0xb2)][_0x428c3f(0xd8)][_0x428c3f(0x165)]({'where':_0xa827bf,'skip':_0x37564c,'take':_0x5318fd,'orderBy':{'createdAt':_0x428c3f(0xc7)}}),database_1[_0x428c3f(0xb2)][_0x428c3f(0xd8)]['count']({'where':_0xa827bf})]);return{'payouts':_0x284245[_0x428c3f(0x154)](_0x387441=>({'id':_0x387441['id'],'amount':_0x387441[_0x428c3f(0xdb)],'network':_0x387441[_0x428c3f(0x100)],'status':_0x387441['status'],'txid':_0x387441[_0x428c3f(0xd1)],'notes':_0x387441[_0x428c3f(0x136)],'createdAt':_0x387441[_0x428c3f(0x11f)],'paidAt':_0x387441[_0x428c3f(0xbe)]})),'pagination':{'page':_0x3371c5,'limit':_0x5318fd,'total':_0x57ca64,'totalPages':Math[_0x428c3f(0xaf)](_0x57ca64/_0x5318fd)}};}async['getPayoutById'](_0x583123,_0x32bcb7){const _0x4d2f47=a48_0xa0c371,_0x1acbb2=await database_1[_0x4d2f47(0xb2)]['payout'][_0x4d2f47(0xd4)]({'where':{'id':_0x32bcb7,'shopId':_0x583123},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1acbb2)return null;return{'id':_0x1acbb2['id'],'shopId':_0x1acbb2[_0x4d2f47(0x11e)],'amount':_0x1acbb2[_0x4d2f47(0xdb)],'method':_0x1acbb2['network'],'status':_0x1acbb2['status'],'txid':_0x1acbb2['txid'],'createdAt':_0x1acbb2[_0x4d2f47(0x11f)],'paidAt':_0x1acbb2[_0x4d2f47(0xbe)],'shop':_0x1acbb2[_0x4d2f47(0x13a)]};}async[a48_0xa0c371(0xc6)](_0x5d13c1,_0x43b52a){const _0xb404fe=a48_0xa0c371,_0x1a4d4a=this[_0xb404fe(0xbb)](_0x43b52a),_0x3dbe86=new Date();_0x3dbe86[_0xb404fe(0x107)](_0x3dbe86[_0xb404fe(0xee)]()-_0x1a4d4a);const _0x1574df={'shopId':_0x5d13c1,'createdAt':{'gte':_0x3dbe86}},[_0x269ba8,_0x110c22,_0x156506,_0x4934b5,_0x5d9667,_0x4b1e9c,_0x4e1c1e,_0x5af5ae]=await Promise[_0xb404fe(0x166)]([database_1[_0xb404fe(0xb2)]['payout'][_0xb404fe(0x131)]({'where':_0x1574df}),database_1[_0xb404fe(0xb2)]['payout'][_0xb404fe(0x131)]({'where':{..._0x1574df,'status':_0xb404fe(0xfe)}}),database_1[_0xb404fe(0xb2)][_0xb404fe(0xd8)][_0xb404fe(0x131)]({'where':{..._0x1574df,'status':_0xb404fe(0x137)}}),database_1[_0xb404fe(0xb2)][_0xb404fe(0xd8)]['count']({'where':{..._0x1574df,'status':'REJECTED'}}),database_1[_0xb404fe(0xb2)][_0xb404fe(0xd8)][_0xb404fe(0xf0)]({'where':_0x1574df,'_sum':{'amount':!![]}}),database_1['default'][_0xb404fe(0xd8)][_0xb404fe(0xf2)]({'by':[_0xb404fe(0x106)],'where':_0x1574df,'_count':{'status':!![]}}),database_1['default'][_0xb404fe(0xd8)][_0xb404fe(0xf2)]({'by':['network'],'where':_0x1574df,'_count':{'network':!![]}}),database_1[_0xb404fe(0xb2)][_0xb404fe(0xd8)]['findMany']({'where':{'shopId':_0x5d13c1},'take':0xa,'orderBy':{'createdAt':_0xb404fe(0xc7)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x537e54=await database_1['default'][_0xb404fe(0xd8)][_0xb404fe(0xf0)]({'where':{..._0x1574df,'status':_0xb404fe(0xfe)},'_sum':{'amount':!![]}}),_0x6fd887=await database_1[_0xb404fe(0xb2)][_0xb404fe(0xd8)][_0xb404fe(0xf0)]({'where':{..._0x1574df,'status':'PENDING'},'_sum':{'amount':!![]}});return{'totalPayouts':_0x269ba8,'completedPayouts':_0x110c22,'pendingPayouts':_0x156506,'rejectedPayouts':_0x4934b5,'totalAmount':_0x5d9667[_0xb404fe(0x143)]['amount']||0x0,'completedAmount':_0x537e54[_0xb404fe(0x143)][_0xb404fe(0xdb)]||0x0,'pendingAmount':_0x6fd887[_0xb404fe(0x143)][_0xb404fe(0xdb)]||0x0,'payoutsByStatus':_0x4b1e9c[_0xb404fe(0x161)]((_0x32fa32,_0x427383)=>{const _0x231f7e=_0xb404fe;return _0x32fa32[_0x427383[_0x231f7e(0x106)]]=_0x427383[_0x231f7e(0xe2)][_0x231f7e(0x106)],_0x32fa32;},{}),'payoutsByMethod':_0x4e1c1e[_0xb404fe(0x161)]((_0x2dcec8,_0x464409)=>{const _0x2e3e00=_0xb404fe;return _0x2dcec8[_0x464409[_0x2e3e00(0x100)]]=_0x464409[_0x2e3e00(0xe2)][_0x2e3e00(0x100)],_0x2dcec8;},{}),'recentPayouts':_0x5af5ae[_0xb404fe(0x154)](_0x30c8f7=>({'id':_0x30c8f7['id'],'shopId':_0x30c8f7[_0xb404fe(0x11e)],'amount':_0x30c8f7[_0xb404fe(0xdb)],'method':_0x30c8f7[_0xb404fe(0x100)],'status':_0x30c8f7['status'],'txid':_0x30c8f7[_0xb404fe(0xd1)],'createdAt':_0x30c8f7[_0xb404fe(0x11f)],'paidAt':_0x30c8f7[_0xb404fe(0xbe)],'shop':_0x30c8f7[_0xb404fe(0x13a)]}))};}async[a48_0xa0c371(0xe8)](_0xca894e){const _0x1d65f3=a48_0xa0c371;console['log']('📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20'+_0xca894e);const _0x3752e3=await database_1['default']['shop'][_0x1d65f3(0x112)]({'where':{'id':_0xca894e},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x3752e3)throw new Error(_0x1d65f3(0x11b));const _0xe9830b=await database_1[_0x1d65f3(0xb2)]['payment']['findMany']({'where':{'shopId':_0xca894e,'status':_0x1d65f3(0x16b)},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console['log'](_0x1d65f3(0xfb)+_0xe9830b[_0x1d65f3(0xa9)]+_0x1d65f3(0x14a));const _0x112a44=new Date(),_0x5d2119=new Date(_0x112a44['getFullYear'](),_0x112a44[_0x1d65f3(0xea)](),0x1);let _0xf8abe5=0x0,_0x3b9d42=0x0,_0x1e230e=0x0,_0x37a395=0x0;for(const _0x43182e of _0xe9830b){const _0x3beaad=await currencyService_1[_0x1d65f3(0x168)]['convertToUSDT'](_0x43182e[_0x1d65f3(0xdb)],_0x43182e['currency']),_0x4c43fa=this[_0x1d65f3(0x17f)](_0x3752e3,_0x43182e[_0x1d65f3(0x11a)]),_0x62e9e4=this[_0x1d65f3(0xe5)](_0x3beaad,_0x4c43fa[_0x1d65f3(0x105)]);_0x43182e['merchantPaid']&&(_0xf8abe5+=_0x62e9e4,_0x43182e[_0x1d65f3(0xbe)]&&_0x43182e['paidAt']>=_0x5d2119&&(_0x1e230e+=_0x62e9e4)),this['isEligibleForPayout'](_0x43182e,_0x4c43fa)&&(_0x3b9d42+=_0x62e9e4,_0x37a395+=_0x3beaad);}const _0x127f45={'availableBalance':Math[_0x1d65f3(0xa8)](_0x37a395*0x64)/0x64,'totalPaidOut':Math[_0x1d65f3(0xa8)](_0xf8abe5*0x64)/0x64,'awaitingPayout':Math[_0x1d65f3(0xa8)](_0x3b9d42*0x64)/0x64,'thisMonth':Math['round'](_0x1e230e*0x64)/0x64};return console[_0x1d65f3(0x127)](_0x1d65f3(0x103)),console['log'](_0x1d65f3(0xb5)+_0x127f45[_0x1d65f3(0x182)]+_0x1d65f3(0xab)),console['log'](_0x1d65f3(0x13f)+_0x127f45[_0x1d65f3(0x17b)]+'\x20USDT'),console['log'](_0x1d65f3(0x114)+_0x127f45[_0x1d65f3(0xdd)]+_0x1d65f3(0xab)),console[_0x1d65f3(0x127)]('📅\x20This\x20Month:\x20'+_0x127f45[_0x1d65f3(0x109)]+_0x1d65f3(0xab)),_0x127f45;}async['getPayoutStats'](_0x17885f){const _0x3dbf77=a48_0xa0c371,_0x33863c=await this['getShopPayoutStats'](_0x17885f);return{'totalBalance':_0x33863c['availableBalance'],'totalPaidOut':_0x33863c[_0x3dbf77(0x17b)],'awaitingPayout':_0x33863c[_0x3dbf77(0xdd)],'thisMonth':_0x33863c['thisMonth']};}async[a48_0xa0c371(0xe1)](_0x3a9f55,_0x1f0c61){const _0x3777e4=a48_0xa0c371,{page:_0x17d730,limit:_0x52afee,paymentId:_0xc28d32}=_0x1f0c61,_0x286703=(_0x17d730-0x1)*_0x52afee,_0x5285de={'shopId':_0x3a9f55};_0xc28d32&&(_0x5285de[_0x3777e4(0x10a)]=_0xc28d32);const [_0x2466dc,_0x2ac4d3]=await Promise['all']([database_1[_0x3777e4(0xb2)][_0x3777e4(0x152)][_0x3777e4(0x165)]({'where':_0x5285de,'skip':_0x286703,'take':_0x52afee,'orderBy':{'createdAt':_0x3777e4(0xc7)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x3777e4(0xb2)][_0x3777e4(0x152)][_0x3777e4(0x131)]({'where':_0x5285de})]);return{'logs':_0x2466dc[_0x3777e4(0x154)](_0x1ba0b9=>({'id':_0x1ba0b9['id'],'paymentId':_0x1ba0b9['paymentId'],'shopId':_0x1ba0b9[_0x3777e4(0x11e)],'event':_0x1ba0b9[_0x3777e4(0xd3)],'statusCode':_0x1ba0b9['statusCode'],'retryCount':_0x1ba0b9[_0x3777e4(0x17e)],'responseBody':_0x1ba0b9[_0x3777e4(0x16f)],'createdAt':_0x1ba0b9[_0x3777e4(0x11f)],'payment':_0x1ba0b9[_0x3777e4(0xe6)]})),'pagination':{'page':_0x17d730,'limit':_0x52afee,'total':_0x2ac4d3,'totalPages':Math['ceil'](_0x2ac4d3/_0x52afee)}};}async[a48_0xa0c371(0x148)](_0x5b400f,_0x1e9c0d){const _0x254324=a48_0xa0c371,_0x28fe1b=this[_0x254324(0xbb)](_0x1e9c0d),_0x5b5ccd=new Date();_0x5b5ccd[_0x254324(0x107)](_0x5b5ccd[_0x254324(0xee)]()-_0x28fe1b),console[_0x254324(0x127)](_0x254324(0xfa)+_0x1e9c0d+'\x20('+_0x28fe1b+_0x254324(0xf3));const _0x3ca623={'shopId':_0x5b400f,'createdAt':{'gte':_0x5b5ccd}},_0x4619b9=await database_1[_0x254324(0xb2)]['shop'][_0x254324(0x112)]({'where':{'id':_0x5b400f},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x4619b9)throw new Error(_0x254324(0x11b));const [_0x855dfd,_0x4c880d,_0xbe0573,_0x2dbf9,_0x256aa2,_0x18471e,_0x5e48de,_0x664b0f]=await Promise[_0x254324(0x166)]([database_1['default'][_0x254324(0xe6)][_0x254324(0x131)]({'where':_0x3ca623}),database_1['default'][_0x254324(0xe6)][_0x254324(0x131)]({'where':{..._0x3ca623,'status':_0x254324(0x16b)}}),database_1[_0x254324(0xb2)][_0x254324(0xe6)][_0x254324(0x165)]({'where':_0x3ca623,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1['default'][_0x254324(0xe6)][_0x254324(0x165)]({'where':{..._0x3ca623,'status':_0x254324(0x16b)},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0x254324(0xb2)][_0x254324(0xe6)][_0x254324(0xf2)]({'by':['status'],'where':_0x3ca623,'_count':{'status':!![]}}),database_1[_0x254324(0xb2)][_0x254324(0xe6)][_0x254324(0xf2)]({'by':['gateway'],'where':_0x3ca623,'_count':{'gateway':!![]}}),database_1[_0x254324(0xb2)][_0x254324(0xe6)]['findMany']({'where':{'shopId':_0x5b400f},'take':0xa,'orderBy':{'createdAt':_0x254324(0xc7)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1['default']['$queryRaw']`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x5b400f} 
          AND created_at >= ${_0x5b5ccd}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0x254324(0x127)]('💰\x20Found\x20'+_0x2dbf9['length']+'\x20PAID\x20payments\x20for\x20totalAmount\x20calculation');const _0x16dc74=await Promise['all'](_0x2dbf9['map'](async _0x555769=>{const _0x25b347=_0x254324,_0xac5cb9=await currencyService_1['currencyService'][_0x25b347(0xc1)](_0x555769['amount'],_0x555769[_0x25b347(0xac)]),_0x3bf384=this[_0x25b347(0x17f)](_0x4619b9,_0x555769['gateway']),_0x325ac5=this[_0x25b347(0xe5)](_0xac5cb9,_0x3bf384['commission']);return _0x325ac5;})),_0x579593=await Promise['all'](_0xbe0573['map'](async _0xc72077=>{const _0x359e24=_0x254324,_0x202678=await currencyService_1[_0x359e24(0x168)][_0x359e24(0xc1)](_0xc72077[_0x359e24(0xdb)],_0xc72077['currency']);return{'amount':_0x202678,'status':_0xc72077[_0x359e24(0x106)]};})),_0x55d625=_0x16dc74[_0x254324(0x161)]((_0xae7fa2,_0x554394)=>_0xae7fa2+_0x554394,0x0),_0x2ac24e=_0x855dfd>0x0?_0x579593[_0x254324(0x161)]((_0x30690a,_0x961f6f)=>_0x30690a+_0x961f6f['amount'],0x0)/_0x855dfd:0x0;console[_0x254324(0x127)](_0x254324(0x135)+_0x55d625[_0x254324(0x17a)](0x2)+_0x254324(0xab)),console[_0x254324(0x127)]('📈\x20Average\x20payment:\x20'+_0x2ac24e[_0x254324(0x17a)](0x2)+_0x254324(0xab));const _0x38557f=this[_0x254324(0xc3)](_0x5b5ccd,new Date()),_0x4acf91=await Promise[_0x254324(0x166)](_0x664b0f['map'](async _0xc28671=>{const _0x19a9e6=_0x254324,_0x3a208b=_0xc28671[_0x19a9e6(0xf8)][_0x19a9e6(0xf9)](_0x22274f=>_0x22274f['status']===_0x19a9e6(0x16b)),_0x37cd02=await Promise[_0x19a9e6(0x166)](_0x3a208b[_0x19a9e6(0x154)](async _0x37863e=>{const _0x10f7a8=_0x19a9e6,_0x1e8887=await currencyService_1['currencyService']['convertToUSDT'](_0x37863e[_0x10f7a8(0xdb)],_0x37863e[_0x10f7a8(0xac)]),_0x4c83e3=this[_0x10f7a8(0x17f)](_0x4619b9,_0x37863e[_0x10f7a8(0x11a)]),_0x4b745a=this[_0x10f7a8(0xe5)](_0x1e8887,_0x4c83e3['commission']);return _0x4b745a;})),_0x13b704=_0x37cd02[_0x19a9e6(0x161)]((_0x3e6f25,_0x22851e)=>_0x3e6f25+_0x22851e,0x0);return{'date':_0xc28671[_0x19a9e6(0xca)][_0x19a9e6(0x118)]()[_0x19a9e6(0xae)]('T')[0x0],'count':_0xc28671[_0x19a9e6(0x131)],'revenue':_0x13b704};})),_0x19b5a7=new Map(_0x4acf91[_0x254324(0x154)](_0x325525=>[_0x325525[_0x254324(0xca)],{'count':_0x325525[_0x254324(0x131)],'revenue':_0x325525[_0x254324(0x10b)]}])),_0x2266eb=_0x38557f['map'](_0x4617d9=>({'date':_0x4617d9,'amount':_0x19b5a7[_0x254324(0x133)](_0x4617d9)?.[_0x254324(0x10b)]||0x0})),_0x5eb024=_0x38557f[_0x254324(0x154)](_0x37e42c=>({'date':_0x37e42c,'count':_0x19b5a7[_0x254324(0x133)](_0x37e42c)?.['count']||0x0}));return console[_0x254324(0x127)](_0x254324(0x14c)),console[_0x254324(0x127)](_0x254324(0x141)+_0x855dfd),console[_0x254324(0x127)]('✅\x20Successful\x20payments:\x20'+_0x4c880d),console[_0x254324(0x127)](_0x254324(0x117)+_0x2266eb[_0x254324(0xa9)]),{'totalPayments':_0x855dfd,'successfulPayments':_0x4c880d,'totalAmount':Math[_0x254324(0xa8)](_0x55d625*0x64)/0x64,'averageAmount':Math[_0x254324(0xa8)](_0x2ac24e*0x64)/0x64,'paymentsByStatus':_0x256aa2['reduce']((_0x41a516,_0x306ef4)=>{const _0x326f88=_0x254324;return _0x41a516[_0x306ef4[_0x326f88(0x106)]]=_0x306ef4['_count']['status'],_0x41a516;},{}),'paymentsByGateway':_0x18471e[_0x254324(0x161)]((_0x584387,_0x2acbd3)=>{const _0x2ba462=_0x254324;return _0x584387[_0x2acbd3[_0x2ba462(0x11a)]]=_0x2acbd3[_0x2ba462(0xe2)][_0x2ba462(0x11a)],_0x584387;},{}),'recentPayments':_0x5e48de[_0x254324(0x154)](_0x3d3cd0=>{const _0x4dc7e6=_0x254324,_0xfc1131=_0x4dc7e6(0x15f)+_0x3d3cd0['id'];return{'id':_0x3d3cd0['id'],'shopId':_0x3d3cd0[_0x4dc7e6(0x11e)],'gateway':_0x3d3cd0[_0x4dc7e6(0x11a)],'amount':_0x3d3cd0[_0x4dc7e6(0xdb)],'currency':_0x3d3cd0['currency'],'sourceCurrency':_0x3d3cd0[_0x4dc7e6(0x119)],'usage':_0x3d3cd0['usage'],'expiresAt':_0x3d3cd0[_0x4dc7e6(0xed)],'redirectUrl':_0xfc1131,'status':_0x3d3cd0[_0x4dc7e6(0x106)],'externalPaymentUrl':_0x3d3cd0[_0x4dc7e6(0xd7)],'customerEmail':_0x3d3cd0['customerEmail'],'customerName':_0x3d3cd0['customerName'],'country':_0x3d3cd0['country'],'language':_0x3d3cd0[_0x4dc7e6(0xd6)],'amountIsEditable':_0x3d3cd0[_0x4dc7e6(0x16c)],'maxPayments':_0x3d3cd0[_0x4dc7e6(0xb3)],'customer':_0x3d3cd0[_0x4dc7e6(0x15e)],'createdAt':_0x3d3cd0['createdAt'],'updatedAt':_0x3d3cd0[_0x4dc7e6(0x138)],'shop':_0x3d3cd0[_0x4dc7e6(0x13a)]};}),'dailyRevenue':_0x2266eb,'dailyPayments':_0x5eb024};}[a48_0xa0c371(0xbb)](_0x14177a){const _0xcbd748=a48_0xa0c371;switch(_0x14177a){case'7d':return 0x7;case'30d':return 0x1e;case _0xcbd748(0x147):return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}[a48_0xa0c371(0xc3)](_0x3fdcb4,_0x290a12){const _0x57a4bd=a48_0xa0c371,_0x3c2929=[],_0x53b942=new Date(_0x3fdcb4);while(_0x53b942<=_0x290a12){_0x3c2929[_0x57a4bd(0x120)](_0x53b942['toISOString']()[_0x57a4bd(0xae)]('T')[0x0]),_0x53b942[_0x57a4bd(0x107)](_0x53b942[_0x57a4bd(0xee)]()+0x1);}return _0x3c2929;}}exports[a48_0xa0c371(0x14f)]=ShopService;function a48_0x56d2(){const _0xc992e5=['✅\x20Shop\x20payout\x20statistics\x20calculated:','testWebhook','commission','status','setDate','gateways','thisMonth','paymentId','revenue','defineProperty','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','webhookLogs','parse','getPayments','payoutDelay','findUnique','qr_code_url','⏳\x20Awaiting\x20Payout:\x20','paymentGateways','stringify','📊\x20Daily\x20revenue\x20entries:\x20','toISOString','sourceCurrency','gateway','Shop\x20not\x20found','startsWith','Test\x20Customer','shopId','createdAt','push','🪙\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','✅\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','1972482cUxMBz','klyme_','✅\x20Test\x20webhook\x20sent\x20successfully:\x20','Gateway\x20error\x20during\x20shop\x20payment\x20creation:','log','updateShopProfile','Order\x20ID:\x20','rapydService','HTTP\x20','wallets','50RJTMlC','create','ONCE','./currencyService','count','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','get','__esModule','💵\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','notes','PENDING','updatedAt','klymeService','shop','7jnjPFD','https://tesoft.uk/gateways/noda/webhook','✅\x20KLYME\x20','✅\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','💸\x20Total\x20Paid\x20Out:\x20','Unknown\x20error','💳\x20Total\x20payments:\x20','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','_sum','now','./gateways/klymeService','isValidGatewayId','90d','getStatistics','isEligibleForPayout','\x20paid\x20payments\x20for\x20analysis','test_webhook','✅\x20Shop\x20statistics\x20generated\x20successfully','11nuwqbl','⚠️\x20Gateway\x20order\x20ID\x20','ShopService','name','/payment/fail?payment_id=','webhookLog','🧪\x20Sending\x20test\x20webhook\x20to:\x20','map','4726270BXmqcc','error','\x20(8digits-8digits\x20format)','customerName','merchantPaid','cointopay','Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts','🔗\x20Generated\x20URLs\x20for\x20','gatewaySettings','rapydCustomer','https://tesoft.uk/gateway/payment.php?id=','./gateways/rapydService','reduce','qr_url','5251167qtRNEE','getTime','findMany','all','payment_url','currencyService','shopUrl','../types/gateway','PAID','amountIsEditable','webhookUrl','Failed\x20to\x20log\x20test\x20webhook:','responseBody','usdcPolygonWallet','toLowerCase','text','redirectUrl','lte','charAt','qr_code','92770phbJFa','username','usdtPolygonWallet','toFixed','totalPaidOut','🔄\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','env','retryCount','getGatewaySettings','gateway_payment_id','getKlymeRegionFromGatewayName','availableBalance','coinToPayService','payment.success','plisio','round','length','fullName','\x20USDT','currency','890208cSyJJQ','split','ceil','4ksOBvN','usdtErcWallet','default','maxPayments','paid','💰\x20Available\x20Balance:\x20','settings','usage','generateGatewayOrderId','message','updatePayment','getPeriodDays','\x20\x20\x20❌\x20Fail:\x20','noda','paidAt','telegramId','EUR','convertToUSDT','floor','generateDateRange','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','21100lDXKDs','getPayoutStatistics','desc','💾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20','../config/database','date','padStart','./gateways/nodaService','usdtTrcWallet','rapyd','CoinToPayService','USD','txid','\x20\x20\x20✅\x20Success:\x20','event','findFirst','plisioService','language','externalPaymentUrl','payout','country','test_payment_','amount','KlymeService','awaitingPayout','telegram','💰\x20Amount:\x20','delete','getWebhookLogs','_count','nodaService','customer','calculateAmountAfterCommission','payment','FAILED','getShopPayoutStats','publicKey','getMonth','1776369YrPTpH','getGatewayNameById','expiresAt','getDate','generateGatewayUrls','aggregate','getPaymentById','groupBy','\x20days)','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','/payment/success?payment_id=','update','updateWallets','payments','filter','📊\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','💰\x20Found\x20','Test\x20payload:','customerEmail','COMPLETED','createPaymentLink','network','RapydService','gatewayPaymentId'];a48_0x56d2=function(){return _0xc992e5;};return a48_0x56d2();}