'use strict';const a53_0x467870=a53_0x1b12;function a53_0x27ef(){const _0x1fe168=['test_order_123','all','25375QPLrUH','gateway','usdtErcWallet','KLYME\x20DE','54928522QZyRJd','\x20USDT\x20(total\x20payouts)','updateWallets','getTime','CoinToPay','count','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','getPayoutStatistics','shopId','asc','settings','customer','getWebhookLogs','3091985DAitpJ','stringify','aggregate','application/json','USDT\x20BSC','Plisio','periodFrom','getPaymentById','__esModule','Test\x20webhook\x20sent\x20successfully\x20(','publicKey','Noda','paidAt','../config/database','test_gateway','getPayoutStats','getMonth','Error\x20parsing\x20webhook\x20events:','Webhook\x20returned\x20error:\x20','gte','telegram','notes','sourceCurrency','__importDefault','90d','amountIsEditable','6iJWVZE','PENDING','1184znGWuI','periodTo','thisMonth','ceil','currency','getStatistics','fullName','payment','payout','message','responseBody','webhookEvents','updatePayment','webhookUrl','default','...','COMPLETED','17KFAbQj','paymentId','USD','shopUrl','language','30d','testWebhook','findUnique','dailyPayments','statusText','15539370jjcJUr','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','delete','Payment\x20not\x20found','setDate','lte','\x20\x20\x20üìÖ\x20This\x20month:\x20','test','parse','country','reduce','USDC\x20Polygon','paymentGateways','getPaymentByShopAndId','totalPaidOut','getPayoutById','convertToUSDT','dailyRevenue','getShopPayoutStats','username','toUpperCase','_sum','PAID','network','getFullYear','getPayments','Failed\x20to\x20send\x20webhook:\x20','telegramId','test_payment_123','shop','update','round','formatNetworkName','txid','PaymentService','paymentService','merchantUrl','desc','KLYME\x20GB','88414LCXPQO','Shop\x20not\x20found','ShopService','toISOString','usage','amountUSDT','createPublicPayment','retryCount','createdAt','event','üìä\x20Shop\x20','availableBalance','amount','customerEmail','Unknown\x20error','./paymentService','push','split','statusCode','Test\x20Gateway','paid','usdtPolygonWallet','10221gCVPgW','9351378vFwEyv','REJECTED','usdtTrcWallet','currencyService','KLYME\x20EU','\x20\x20\x20üíµ\x20Available\x20balance:\x20','gatewaySettings','filter','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','name','error','usdcPolygonWallet','TesSoft\x20Payment\x20System/1.0\x20(Test)','findMany','getDate','log','\x20USDT\x20(current\x20balance)','revenue','status','getGatewayDisplayName','createPayment','expiresAt','wallets','generateDailyStatistics','1360BOzPCq','updateShopProfile','redirectUrl','gateways','findFirst','webhookLog','awaitingPayout','map'];a53_0x27ef=function(){return _0x1fe168;};return a53_0x27ef();}(function(_0x579314,_0x5bca7c){const _0x22a0de=a53_0x1b12,_0x9c078d=_0x579314();while(!![]){try{const _0x4920d6=parseInt(_0x22a0de(0x161))/0x1*(parseInt(_0x22a0de(0x192))/0x2)+parseInt(_0x22a0de(0x1a8))/0x3*(-parseInt(_0x22a0de(0x119))/0x4)+parseInt(_0x22a0de(0x134))/0x5*(-parseInt(_0x22a0de(0x14e))/0x6)+parseInt(_0x22a0de(0x123))/0x7*(-parseInt(_0x22a0de(0x150))/0x8)+-parseInt(_0x22a0de(0x1a9))/0x9+-parseInt(_0x22a0de(0x16b))/0xa+parseInt(_0x22a0de(0x127))/0xb;if(_0x4920d6===_0x5bca7c)break;else _0x9c078d['push'](_0x9c078d['shift']());}catch(_0x29c76b){_0x9c078d['push'](_0x9c078d['shift']());}}}(a53_0x27ef,0xccc6d));function a53_0x1b12(_0x177d96,_0x2d862f){const _0x27efb7=a53_0x27ef();return a53_0x1b12=function(_0x1b12a7,_0x2d9dfa){_0x1b12a7=_0x1b12a7-0x110;let _0x418f91=_0x27efb7[_0x1b12a7];return _0x418f91;},a53_0x1b12(_0x177d96,_0x2d862f);}var __importDefault=this&&this[a53_0x467870(0x14b)]||function(_0x1bec0c){const _0x781635=a53_0x467870;return _0x1bec0c&&_0x1bec0c[_0x781635(0x13c)]?_0x1bec0c:{'default':_0x1bec0c};};Object['defineProperty'](exports,a53_0x467870(0x13c),{'value':!![]}),exports[a53_0x467870(0x194)]=void 0x0;const database_1=__importDefault(require(a53_0x467870(0x141))),currencyService_1=require('./currencyService'),paymentService_1=require(a53_0x467870(0x1a1));class ShopService{constructor(){const _0x204653=a53_0x467870;this[_0x204653(0x18e)]=new paymentService_1[(_0x204653(0x18d))]();}async['getShopProfile'](_0x3802f0){const _0x57cdab=a53_0x467870,_0x2fe1e5=await database_1[_0x57cdab(0x15e)][_0x57cdab(0x188)][_0x57cdab(0x168)]({'where':{'id':_0x3802f0},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x2fe1e5)throw new Error('Shop\x20not\x20found');let _0x465a9e=[];if(_0x2fe1e5['settings']?.[_0x57cdab(0x15b)])try{_0x465a9e=Array['isArray'](_0x2fe1e5['settings'][_0x57cdab(0x15b)])?_0x2fe1e5['settings'][_0x57cdab(0x15b)]:JSON[_0x57cdab(0x173)](_0x2fe1e5[_0x57cdab(0x131)][_0x57cdab(0x15b)]);}catch(_0x2b1e5f){console[_0x57cdab(0x1b3)]('Error\x20parsing\x20webhook\x20events:',_0x2b1e5f),_0x465a9e=[];}return{'id':_0x2fe1e5['id'],'fullName':_0x2fe1e5[_0x57cdab(0x1b2)],'username':_0x2fe1e5['username'],'telegramId':_0x2fe1e5['telegram'],'merchantUrl':_0x2fe1e5[_0x57cdab(0x164)],'gateways':_0x2fe1e5[_0x57cdab(0x177)]?JSON[_0x57cdab(0x173)](_0x2fe1e5['paymentGateways']):null,'gatewaySettings':_0x2fe1e5[_0x57cdab(0x1af)]?JSON[_0x57cdab(0x173)](_0x2fe1e5[_0x57cdab(0x1af)]):null,'publicKey':_0x2fe1e5[_0x57cdab(0x13e)],'webhookUrl':_0x2fe1e5['settings']?.[_0x57cdab(0x15d)]||null,'webhookEvents':_0x465a9e,'wallets':{'usdtPolygonWallet':_0x2fe1e5[_0x57cdab(0x1a7)],'usdtTrcWallet':_0x2fe1e5[_0x57cdab(0x1ab)],'usdtErcWallet':_0x2fe1e5[_0x57cdab(0x125)],'usdcPolygonWallet':_0x2fe1e5[_0x57cdab(0x1b4)]},'status':_0x2fe1e5[_0x57cdab(0x113)],'createdAt':_0x2fe1e5['createdAt']};}async[a53_0x467870(0x11a)](_0x25eda6,_0x2ae812){const _0x325fd7=a53_0x467870,_0x3f187f={};_0x2ae812[_0x325fd7(0x156)]&&(_0x3f187f[_0x325fd7(0x1b2)]=_0x2ae812[_0x325fd7(0x156)]);_0x2ae812['telegramId']!==undefined&&(_0x3f187f['telegram']=_0x2ae812[_0x325fd7(0x186)]||null);_0x2ae812[_0x325fd7(0x18f)]&&(_0x3f187f[_0x325fd7(0x164)]=_0x2ae812['merchantUrl']);_0x2ae812[_0x325fd7(0x11c)]&&(_0x3f187f[_0x325fd7(0x177)]=JSON['stringify'](_0x2ae812['gateways']));_0x2ae812['gatewaySettings']&&(_0x3f187f['gatewaySettings']=JSON[_0x325fd7(0x135)](_0x2ae812['gatewaySettings']));_0x2ae812[_0x325fd7(0x117)]&&(_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x1a7)]!==undefined&&(_0x3f187f['usdtPolygonWallet']=_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x1a7)]||null),_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x1ab)]!==undefined&&(_0x3f187f['usdtTrcWallet']=_0x2ae812['wallets'][_0x325fd7(0x1ab)]||null),_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x125)]!==undefined&&(_0x3f187f[_0x325fd7(0x125)]=_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x125)]||null),_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x1b4)]!==undefined&&(_0x3f187f[_0x325fd7(0x1b4)]=_0x2ae812[_0x325fd7(0x117)][_0x325fd7(0x1b4)]||null));const _0x1b1cbe=await database_1[_0x325fd7(0x15e)]['shop'][_0x325fd7(0x189)]({'where':{'id':_0x25eda6},'data':_0x3f187f,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x5fe1f7=[];if(_0x1b1cbe[_0x325fd7(0x131)]?.['webhookEvents'])try{_0x5fe1f7=Array['isArray'](_0x1b1cbe[_0x325fd7(0x131)]['webhookEvents'])?_0x1b1cbe['settings']['webhookEvents']:JSON[_0x325fd7(0x173)](_0x1b1cbe[_0x325fd7(0x131)][_0x325fd7(0x15b)]);}catch(_0x2a33b4){console['error'](_0x325fd7(0x145),_0x2a33b4),_0x5fe1f7=[];}return{'id':_0x1b1cbe['id'],'fullName':_0x1b1cbe[_0x325fd7(0x1b2)],'username':_0x1b1cbe[_0x325fd7(0x17e)],'telegramId':_0x1b1cbe[_0x325fd7(0x148)],'merchantUrl':_0x1b1cbe[_0x325fd7(0x164)],'gateways':_0x1b1cbe[_0x325fd7(0x177)]?JSON[_0x325fd7(0x173)](_0x1b1cbe[_0x325fd7(0x177)]):null,'gatewaySettings':_0x1b1cbe[_0x325fd7(0x1af)]?JSON[_0x325fd7(0x173)](_0x1b1cbe[_0x325fd7(0x1af)]):null,'publicKey':_0x1b1cbe[_0x325fd7(0x13e)],'webhookUrl':_0x1b1cbe[_0x325fd7(0x131)]?.[_0x325fd7(0x15d)]||null,'webhookEvents':_0x5fe1f7,'wallets':{'usdtPolygonWallet':_0x1b1cbe['usdtPolygonWallet'],'usdtTrcWallet':_0x1b1cbe['usdtTrcWallet'],'usdtErcWallet':_0x1b1cbe[_0x325fd7(0x125)],'usdcPolygonWallet':_0x1b1cbe[_0x325fd7(0x1b4)]},'status':_0x1b1cbe[_0x325fd7(0x113)],'createdAt':_0x1b1cbe[_0x325fd7(0x19a)]};}async[a53_0x467870(0x129)](_0x22a6b2,_0x57d46d){const _0x483d4e=a53_0x467870,_0x4694ee={};_0x57d46d[_0x483d4e(0x1a7)]!==undefined&&(_0x4694ee[_0x483d4e(0x1a7)]=_0x57d46d[_0x483d4e(0x1a7)]||null),_0x57d46d[_0x483d4e(0x1ab)]!==undefined&&(_0x4694ee[_0x483d4e(0x1ab)]=_0x57d46d[_0x483d4e(0x1ab)]||null),_0x57d46d[_0x483d4e(0x125)]!==undefined&&(_0x4694ee[_0x483d4e(0x125)]=_0x57d46d[_0x483d4e(0x125)]||null),_0x57d46d[_0x483d4e(0x1b4)]!==undefined&&(_0x4694ee['usdcPolygonWallet']=_0x57d46d[_0x483d4e(0x1b4)]||null),await database_1['default'][_0x483d4e(0x188)]['update']({'where':{'id':_0x22a6b2},'data':_0x4694ee});}async[a53_0x467870(0x167)](_0x1a03d2){const _0x310502=a53_0x467870,_0x4745e2=await database_1[_0x310502(0x15e)]['shop']['findUnique']({'where':{'id':_0x1a03d2},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x4745e2?.[_0x310502(0x131)]?.['webhookUrl'])throw new Error('No\x20webhook\x20URL\x20configured');const _0x1740db={'event':_0x310502(0x172),'payment':{'id':_0x310502(0x187),'order_id':_0x310502(0x121),'gateway':_0x310502(0x172),'amount':0x64,'currency':_0x310502(0x163),'status':_0x310502(0x1a6),'created_at':new Date()[_0x310502(0x195)]()}};try{const _0x23ae9b=await fetch(_0x4745e2[_0x310502(0x131)]['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x310502(0x137),'User-Agent':_0x310502(0x1b5)},'body':JSON[_0x310502(0x135)](_0x1740db)});return _0x23ae9b['ok']?{'success':!![],'message':_0x310502(0x13d)+_0x23ae9b[_0x310502(0x113)]+')'}:{'success':![],'message':_0x310502(0x146)+_0x23ae9b[_0x310502(0x113)]+'\x20'+_0x23ae9b[_0x310502(0x16a)]};}catch(_0x3bc6ac){return{'success':![],'message':_0x310502(0x185)+(_0x3bc6ac instanceof Error?_0x3bc6ac[_0x310502(0x159)]:_0x310502(0x1a0))};}}async[a53_0x467870(0x115)](_0x4ede68){const _0x160a73=a53_0x467870;return this[_0x160a73(0x18e)][_0x160a73(0x198)]({'public_key':'','gateway':_0x4ede68['gateway'],'order_id':undefined,'amount':_0x4ede68[_0x160a73(0x19e)],'currency':_0x4ede68['currency'],'source_currency':_0x4ede68[_0x160a73(0x14a)],'usage':_0x4ede68[_0x160a73(0x196)],'expires_at':_0x4ede68[_0x160a73(0x116)]?.['toISOString'](),'success_url':_0x4ede68['redirectUrl'],'fail_url':_0x4ede68[_0x160a73(0x11b)],'customer_email':_0x4ede68[_0x160a73(0x19f)],'customer_name':_0x4ede68['customerName'],'country':_0x4ede68[_0x160a73(0x174)],'language':_0x4ede68[_0x160a73(0x165)],'amount_is_editable':_0x4ede68[_0x160a73(0x14d)],'max_payments':_0x4ede68['maxPayments'],'customer':_0x4ede68[_0x160a73(0x132)]});}async[a53_0x467870(0x184)](_0x51011a,_0x1d72e9){return this['paymentService']['getPaymentsByShop'](_0x51011a,_0x1d72e9);}async[a53_0x467870(0x13b)](_0x3f7982,_0x2cea3b){const _0x400fff=a53_0x467870;return this[_0x400fff(0x18e)][_0x400fff(0x178)](_0x3f7982,_0x2cea3b);}async[a53_0x467870(0x15c)](_0x2945d4,_0x1aff72,_0x137e80){const _0x31c1a9=a53_0x467870,_0x467913=await database_1[_0x31c1a9(0x15e)][_0x31c1a9(0x157)][_0x31c1a9(0x11d)]({'where':{'id':_0x1aff72,'shopId':_0x2945d4}});if(!_0x467913)throw new Error(_0x31c1a9(0x16e));const _0x327da0=await database_1[_0x31c1a9(0x15e)][_0x31c1a9(0x157)][_0x31c1a9(0x189)]({'where':{'id':_0x1aff72},'data':{..._0x137e80,'updatedAt':new Date()}});return _0x327da0;}async['deletePayment'](_0x347193,_0x2e38e8){const _0x1d0198=a53_0x467870,_0x3486c0=await database_1['default']['payment']['findFirst']({'where':{'id':_0x2e38e8,'shopId':_0x347193}});if(!_0x3486c0)throw new Error(_0x1d0198(0x16e));await database_1[_0x1d0198(0x15e)][_0x1d0198(0x157)][_0x1d0198(0x16d)]({'where':{'id':_0x2e38e8}});}[a53_0x467870(0x18b)](_0x2c75db){const _0x25a730=a53_0x467870,_0x2feab4={'polygon':'USDT\x20Polygon','trc20':'USDT\x20TRC20','erc20':'USDT\x20ERC20','bsc':_0x25a730(0x138),'polygon_usdc':_0x25a730(0x176)};return _0x2feab4[_0x2c75db]||_0x2c75db;}async['getPayouts'](_0x2b8010,_0x38d06b){const _0x5ae702=a53_0x467870,{page:_0x4ac25d,limit:_0xf53339,status:_0x1a3766,method:_0x54cf78,dateFrom:_0x4a81ca,dateTo:_0x32bc9c,periodFrom:_0x341601,periodTo:_0x4cdd94}=_0x38d06b,_0x18f61b=(_0x4ac25d-0x1)*_0xf53339,_0x4e2cdc={'shopId':_0x2b8010};_0x1a3766&&(_0x4e2cdc[_0x5ae702(0x113)]=_0x1a3766[_0x5ae702(0x17f)]());_0x54cf78&&(_0x4e2cdc[_0x5ae702(0x182)]=_0x54cf78);if(_0x4a81ca||_0x32bc9c||_0x341601||_0x4cdd94){_0x4e2cdc[_0x5ae702(0x19a)]={};if(_0x341601)_0x4e2cdc[_0x5ae702(0x19a)][_0x5ae702(0x147)]=new Date(_0x341601);else _0x4a81ca&&(_0x4e2cdc[_0x5ae702(0x19a)][_0x5ae702(0x147)]=new Date(_0x4a81ca));if(_0x4cdd94)_0x4e2cdc['createdAt'][_0x5ae702(0x170)]=new Date(_0x4cdd94);else _0x32bc9c&&(_0x4e2cdc[_0x5ae702(0x19a)][_0x5ae702(0x170)]=new Date(_0x32bc9c));}const [_0x3fcb83,_0xce7bd6]=await Promise[_0x5ae702(0x122)]([database_1['default'][_0x5ae702(0x158)][_0x5ae702(0x1b6)]({'where':_0x4e2cdc,'skip':_0x18f61b,'take':_0xf53339,'orderBy':{'createdAt':'desc'}}),database_1[_0x5ae702(0x15e)][_0x5ae702(0x158)][_0x5ae702(0x12c)]({'where':_0x4e2cdc})]);return{'payouts':_0x3fcb83[_0x5ae702(0x120)](_0xad53cb=>({'id':_0xad53cb['id'],'amount':_0xad53cb['amount'],'network':this['formatNetworkName'](_0xad53cb['network']),'status':_0xad53cb[_0x5ae702(0x113)],'txid':_0xad53cb[_0x5ae702(0x18c)],'notes':_0xad53cb[_0x5ae702(0x149)],'periodFrom':_0xad53cb[_0x5ae702(0x13a)],'periodTo':_0xad53cb[_0x5ae702(0x151)],'createdAt':_0xad53cb[_0x5ae702(0x19a)],'paidAt':_0xad53cb[_0x5ae702(0x140)]})),'pagination':{'page':_0x4ac25d,'limit':_0xf53339,'total':_0xce7bd6,'totalPages':Math['ceil'](_0xce7bd6/_0xf53339)}};}async[a53_0x467870(0x17a)](_0x1ef6ad,_0x1fcb5b){const _0x40aede=a53_0x467870,_0x19219e=await database_1[_0x40aede(0x15e)][_0x40aede(0x158)][_0x40aede(0x11d)]({'where':{'id':_0x1fcb5b,'shopId':_0x1ef6ad}});if(!_0x19219e)return null;return{'id':_0x19219e['id'],'amount':_0x19219e[_0x40aede(0x19e)],'network':_0x19219e[_0x40aede(0x182)],'status':_0x19219e[_0x40aede(0x113)],'txid':_0x19219e[_0x40aede(0x18c)],'notes':_0x19219e['notes'],'createdAt':_0x19219e[_0x40aede(0x19a)],'paidAt':_0x19219e[_0x40aede(0x140)]};}async[a53_0x467870(0x12e)](_0x278ca6,_0x29ef5f){const _0x9213=a53_0x467870,_0xe1370e=new Date();let _0x1deff0;switch(_0x29ef5f){case'7d':_0x1deff0=new Date(_0xe1370e[_0x9213(0x12a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x9213(0x166):_0x1deff0=new Date(_0xe1370e[_0x9213(0x12a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x9213(0x14c):_0x1deff0=new Date(_0xe1370e[_0x9213(0x12a)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x1deff0=new Date(_0xe1370e[_0x9213(0x12a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x461649,_0x68aa9d,_0x342340,_0x6cafad,_0x1b97ff,_0x4fea94]=await Promise[_0x9213(0x122)]([database_1['default'][_0x9213(0x158)]['count']({'where':{'shopId':_0x278ca6,'createdAt':{'gte':_0x1deff0}}}),database_1[_0x9213(0x15e)][_0x9213(0x158)][_0x9213(0x12c)]({'where':{'shopId':_0x278ca6,'status':'COMPLETED','createdAt':{'gte':_0x1deff0}}}),database_1[_0x9213(0x15e)][_0x9213(0x158)][_0x9213(0x12c)]({'where':{'shopId':_0x278ca6,'status':_0x9213(0x14f),'createdAt':{'gte':_0x1deff0}}}),database_1[_0x9213(0x15e)][_0x9213(0x158)][_0x9213(0x12c)]({'where':{'shopId':_0x278ca6,'status':_0x9213(0x1aa),'createdAt':{'gte':_0x1deff0}}}),database_1['default'][_0x9213(0x158)][_0x9213(0x1b6)]({'where':{'shopId':_0x278ca6,'createdAt':{'gte':_0x1deff0}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x9213(0x15e)][_0x9213(0x158)][_0x9213(0x1b6)]({'where':{'shopId':_0x278ca6},'take':0xa,'orderBy':{'createdAt':_0x9213(0x190)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0xbc37b9=_0x1b97ff[_0x9213(0x175)]((_0x3733cf,_0xca277e)=>_0x3733cf+_0xca277e[_0x9213(0x19e)],0x0),_0x43a7a8=_0x1b97ff['filter'](_0x181760=>_0x181760[_0x9213(0x113)]==='COMPLETED')[_0x9213(0x175)]((_0x2634a7,_0xa237a)=>_0x2634a7+_0xa237a['amount'],0x0),_0x220ee5=_0x1b97ff[_0x9213(0x1b0)](_0x57f9d3=>_0x57f9d3[_0x9213(0x113)]==='PENDING')[_0x9213(0x175)]((_0x33a0ea,_0x197ad3)=>_0x33a0ea+_0x197ad3[_0x9213(0x19e)],0x0),_0xe1638d=_0x1b97ff[_0x9213(0x175)]((_0x24c303,_0x346135)=>{const _0x3ce024=_0x9213;return _0x24c303[_0x346135['network']]=(_0x24c303[_0x346135[_0x3ce024(0x182)]]||0x0)+0x1,_0x24c303;},{}),_0xd361a2=_0x1b97ff[_0x9213(0x175)]((_0x260157,_0x2efa30)=>{const _0x1f7d86=_0x9213;return _0x260157[_0x2efa30[_0x1f7d86(0x113)]]=(_0x260157[_0x2efa30[_0x1f7d86(0x113)]]||0x0)+0x1,_0x260157;},{});return{'totalPayouts':_0x461649,'completedPayouts':_0x68aa9d,'pendingPayouts':_0x342340,'rejectedPayouts':_0x6cafad,'totalAmount':_0xbc37b9,'completedAmount':_0x43a7a8,'pendingAmount':_0x220ee5,'payoutsByMethod':_0xe1638d,'payoutsByStatus':_0xd361a2,'recentPayouts':_0x4fea94[_0x9213(0x120)](_0x1383fd=>({'id':_0x1383fd['id'],'shopId':_0x278ca6,'amount':_0x1383fd['amount'],'method':_0x1383fd[_0x9213(0x182)],'status':_0x1383fd[_0x9213(0x113)],'txid':_0x1383fd[_0x9213(0x18c)],'createdAt':_0x1383fd['createdAt'],'paidAt':_0x1383fd[_0x9213(0x140)]}))};}async['getShopPayoutStats'](_0x1cd68d){const _0x332abc=a53_0x467870;console['log'](_0x332abc(0x12d)+_0x1cd68d+_0x332abc(0x15f));const _0x1e5fd8=await database_1[_0x332abc(0x15e)][_0x332abc(0x188)][_0x332abc(0x168)]({'where':{'id':_0x1cd68d},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1e5fd8)throw new Error(_0x332abc(0x193));const _0x1e3803=new Date(),_0x5e8382=new Date(_0x1e3803[_0x332abc(0x183)](),_0x1e3803[_0x332abc(0x144)](),0x1),_0x8dbcf5=new Date(_0x1e3803[_0x332abc(0x183)](),_0x1e3803[_0x332abc(0x144)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x4dffca=await database_1[_0x332abc(0x15e)][_0x332abc(0x158)][_0x332abc(0x136)]({'_sum':{'amount':!![]},'where':{'shopId':_0x1cd68d,'createdAt':{'gte':_0x5e8382,'lte':_0x8dbcf5},'status':_0x332abc(0x160)}}),_0x3d24ed=_0x4dffca[_0x332abc(0x180)][_0x332abc(0x19e)]||0x0,_0x4702eb={'availableBalance':Math[_0x332abc(0x18a)](_0x1e5fd8['balance']*0x64)/0x64,'totalPaidOut':Math[_0x332abc(0x18a)](_0x1e5fd8[_0x332abc(0x179)]*0x64)/0x64,'awaitingPayout':Math[_0x332abc(0x18a)](_0x1e5fd8['balance']*0x64)/0x64,'thisMonth':Math[_0x332abc(0x18a)](_0x3d24ed*0x64)/0x64};return console[_0x332abc(0x110)](_0x332abc(0x19c)+_0x1e5fd8['username']+'\x20payout\x20statistics\x20calculated:'),console[_0x332abc(0x110)](_0x332abc(0x1ae)+_0x4702eb[_0x332abc(0x19d)]+_0x332abc(0x111)),console[_0x332abc(0x110)](_0x332abc(0x1b1)+_0x4702eb[_0x332abc(0x179)]+_0x332abc(0x128)),console['log'](_0x332abc(0x16c)+_0x4702eb[_0x332abc(0x11f)]+_0x332abc(0x111)),console[_0x332abc(0x110)](_0x332abc(0x171)+_0x4702eb[_0x332abc(0x152)]+'\x20USDT'),_0x4702eb;}[a53_0x467870(0x114)](_0x22b1f7){const _0x2cd0b8=a53_0x467870,_0x5cdd84={'test_gateway':_0x2cd0b8(0x1a5),'plisio':_0x2cd0b8(0x139),'rapyd':'Rapyd','noda':_0x2cd0b8(0x13f),'cointopay':_0x2cd0b8(0x12b),'klyme_eu':_0x2cd0b8(0x1ad),'klyme_gb':_0x2cd0b8(0x191),'klyme_de':_0x2cd0b8(0x126)};return _0x5cdd84[_0x22b1f7]||_0x22b1f7;}async[a53_0x467870(0x143)](_0x2d77c7){const _0x1c7eda=a53_0x467870;return this[_0x1c7eda(0x17d)](_0x2d77c7);}async[a53_0x467870(0x133)](_0x23a430,_0x484427){const _0x10c56d=a53_0x467870,{page:_0x14d372,limit:_0x31a499,paymentId:_0x4a4f9d}=_0x484427,_0x4029e7=(_0x14d372-0x1)*_0x31a499,_0x467910={'shopId':_0x23a430};_0x4a4f9d&&(_0x467910['paymentId']=_0x4a4f9d);const [_0x449b58,_0x5840f2]=await Promise[_0x10c56d(0x122)]([database_1['default']['webhookLog'][_0x10c56d(0x1b6)]({'where':_0x467910,'skip':_0x4029e7,'take':_0x31a499,'orderBy':{'createdAt':_0x10c56d(0x190)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default'][_0x10c56d(0x11e)][_0x10c56d(0x12c)]({'where':_0x467910})]);return{'logs':_0x449b58[_0x10c56d(0x120)](_0xf94430=>({'id':_0xf94430['id'],'paymentId':_0xf94430[_0x10c56d(0x162)],'shopId':_0xf94430[_0x10c56d(0x12f)],'event':_0xf94430[_0x10c56d(0x19b)],'statusCode':_0xf94430[_0x10c56d(0x1a4)],'retryCount':_0xf94430[_0x10c56d(0x199)],'responseBody':_0xf94430[_0x10c56d(0x15a)],'createdAt':_0xf94430[_0x10c56d(0x19a)],'payment':_0xf94430[_0x10c56d(0x157)]})),'pagination':{'page':_0x14d372,'limit':_0x31a499,'total':_0x5840f2,'totalPages':Math[_0x10c56d(0x153)](_0x5840f2/_0x31a499)}};}async[a53_0x467870(0x155)](_0x3a0a61,_0x294f20){const _0x4b9029=a53_0x467870,_0x14d6ad=new Date();let _0x5329a9;switch(_0x294f20){case'7d':_0x5329a9=new Date(_0x14d6ad[_0x4b9029(0x12a)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x4b9029(0x166):_0x5329a9=new Date(_0x14d6ad[_0x4b9029(0x12a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x4b9029(0x14c):_0x5329a9=new Date(_0x14d6ad[_0x4b9029(0x12a)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x5329a9=new Date(_0x14d6ad[_0x4b9029(0x12a)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x454885,_0x5b8cc4,_0x2e510e,_0x220104,_0xcb6071]=await Promise[_0x4b9029(0x122)]([database_1[_0x4b9029(0x15e)][_0x4b9029(0x157)][_0x4b9029(0x12c)]({'where':{'shopId':_0x3a0a61,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x5329a9}}}),database_1[_0x4b9029(0x15e)][_0x4b9029(0x157)][_0x4b9029(0x12c)]({'where':{'shopId':_0x3a0a61,'gateway':{'not':_0x4b9029(0x142)},'status':_0x4b9029(0x181),'createdAt':{'gte':_0x5329a9}}}),database_1[_0x4b9029(0x15e)][_0x4b9029(0x157)][_0x4b9029(0x1b6)]({'where':{'shopId':_0x3a0a61,'gateway':{'not':_0x4b9029(0x142)},'status':'PAID','createdAt':{'gte':_0x5329a9}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x4b9029(0x15e)]['payment'][_0x4b9029(0x1b6)]({'where':{'shopId':_0x3a0a61,'gateway':{'not':_0x4b9029(0x142)}},'take':0xa,'orderBy':{'createdAt':_0x4b9029(0x190)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x4b9029(0x15e)]['payment'][_0x4b9029(0x1b6)]({'where':{'shopId':_0x3a0a61,'gateway':{'not':_0x4b9029(0x142)},'createdAt':{'gte':_0x5329a9}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x4b9029(0x130)}})]);let _0x2032f4=0x0;for(const _0x50fd4d of _0x2e510e){if(_0x50fd4d['amountUSDT'])_0x2032f4+=_0x50fd4d[_0x4b9029(0x197)];else{const _0xb26e99=await currencyService_1[_0x4b9029(0x1ac)][_0x4b9029(0x17b)](_0x50fd4d[_0x4b9029(0x19e)],_0x50fd4d[_0x4b9029(0x154)]);_0x2032f4+=_0xb26e99;}}const _0x5e4fe2=this['generateDailyStatistics'](_0xcb6071,_0x5329a9,_0x14d6ad),_0x4253c6=_0x454885>0x0?_0x5b8cc4/_0x454885*0x64:0x0;return{'totalPayments':_0x454885,'successfulPayments':_0x5b8cc4,'totalRevenue':Math[_0x4b9029(0x18a)](_0x2032f4*0x64)/0x64,'conversionRate':Math[_0x4b9029(0x18a)](_0x4253c6*0x64)/0x64,'dailyRevenue':_0x5e4fe2[_0x4b9029(0x17c)],'dailyPayments':_0x5e4fe2[_0x4b9029(0x169)],'recentPayments':_0x220104[_0x4b9029(0x120)](_0x598386=>({'id':_0x598386['id'],'gateway':_0x598386[_0x4b9029(0x124)],'amount':_0x598386['amount'],'currency':_0x598386[_0x4b9029(0x154)],'status':_0x598386['status'],'createdAt':_0x598386[_0x4b9029(0x19a)]}))};}[a53_0x467870(0x118)](_0x58b1e3,_0x47d833,_0x41211b){const _0x17a448=a53_0x467870,_0x1ce21e=new Map(),_0x1410f5=new Date(_0x47d833);while(_0x1410f5<=_0x41211b){const _0x40848c=_0x1410f5[_0x17a448(0x195)]()[_0x17a448(0x1a3)]('T')[0x0];_0x1ce21e['set'](_0x40848c,{'revenue':0x0,'count':0x0}),_0x1410f5[_0x17a448(0x16f)](_0x1410f5[_0x17a448(0x1b7)]()+0x1);}for(const _0x3de0a6 of _0x58b1e3){const _0x3c43fb=_0x3de0a6['createdAt']['toISOString']()[_0x17a448(0x1a3)]('T')[0x0],_0x27ac14=_0x1ce21e['get'](_0x3c43fb);_0x27ac14&&(_0x27ac14[_0x17a448(0x12c)]+=0x1,_0x3de0a6[_0x17a448(0x113)]===_0x17a448(0x181)&&_0x3de0a6[_0x17a448(0x197)]&&(_0x27ac14['revenue']+=_0x3de0a6['amountUSDT']));}const _0xec0e3f=[],_0x13a786=[];for(const [_0x5d9733,_0x86f8c]of _0x1ce21e){_0xec0e3f['push']({'date':_0x5d9733,'amount':Math[_0x17a448(0x18a)](_0x86f8c[_0x17a448(0x112)]*0x64)/0x64}),_0x13a786[_0x17a448(0x1a2)]({'date':_0x5d9733,'count':_0x86f8c[_0x17a448(0x12c)]});}return{'dailyRevenue':_0xec0e3f,'dailyPayments':_0x13a786};}}exports['ShopService']=ShopService;