'use strict';const a53_0x2bd6d6=a53_0x4123;(function(_0x1d5e83,_0xa126f3){const _0x1f1d71=a53_0x4123,_0x28d4ef=_0x1d5e83();while(!![]){try{const _0x2bd0c5=-parseInt(_0x1f1d71(0x195))/0x1+-parseInt(_0x1f1d71(0x113))/0x2*(parseInt(_0x1f1d71(0x14f))/0x3)+-parseInt(_0x1f1d71(0x19b))/0x4+parseInt(_0x1f1d71(0x15b))/0x5+parseInt(_0x1f1d71(0x168))/0x6*(parseInt(_0x1f1d71(0x14c))/0x7)+-parseInt(_0x1f1d71(0x166))/0x8*(-parseInt(_0x1f1d71(0x149))/0x9)+parseInt(_0x1f1d71(0x11b))/0xa;if(_0x2bd0c5===_0xa126f3)break;else _0x28d4ef['push'](_0x28d4ef['shift']());}catch(_0x22052a){_0x28d4ef['push'](_0x28d4ef['shift']());}}}(a53_0x3af5,0xf07d6));function a53_0x4123(_0xf254cb,_0x162127){const _0x3af5e9=a53_0x3af5();return a53_0x4123=function(_0x4123fe,_0x3f91ed){_0x4123fe=_0x4123fe-0xfc;let _0x298d64=_0x3af5e9[_0x4123fe];return _0x298d64;},a53_0x4123(_0xf254cb,_0x162127);}var __importDefault=this&&this[a53_0x2bd6d6(0x13f)]||function(_0x1665d0){return _0x1665d0&&_0x1665d0['__esModule']?_0x1665d0:{'default':_0x1665d0};};function a53_0x3af5(){const _0x5e8a3b=['\x20USDT\x20(current\x20balance)','merchantUrl','getShopProfile','all','paymentId','getFullYear','erc20','\x20USDT\x20(total\x20payouts)','üìÖ\x20Period\x20end:\x20','lte','PENDING','filter','thisMonth','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','network','count','testWebhook','gte','\x20\x20\x20üíµ\x20Available\x20balance:\x20','gateway','getStatistics','expiresAt','setHours','\x20payout\x20statistics\x20calculated:','üìÖ\x20Date\x20start:\x20','üìÖ\x20Date\x20end:\x20','test_payment_123','getPayoutStats','Test\x20webhook\x20sent\x20successfully\x20(','polygon','getTime','Noda','KLYME\x20EU','Webhook\x20returned\x20error:\x20','__importDefault','name','status','findFirst','customerName','periodTo','test_order_123','username','toUpperCase','toISOString','7861437WANBms','updateShopProfile','defineProperty','7mEEFlh','polygon_usdc','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','99pTRmXE','telegram','test_gateway','maxPayments','usdtPolygonWallet','findUnique','statusText','round','amount','USD','REJECTED','settings','5244940WNHkDx','gatewaySettings','test','USDT\x20TRC20','createPayment','paidAt','balance','webhookEvents','getWebhookLogs','log','getMonth','8DuPreH','customerEmail','724674XfmnKq','wallets','üåê\x20Method\x20filter:\x20','shop','setDate','stringify','revenue','delete','trc20','payment','gateways','usdtTrcWallet','Error\x20parsing\x20webhook\x20events:','paymentService','amountUSDT','Payment\x20not\x20found','Shop\x20not\x20found','map','fullName','getPaymentByShopAndId','90d','update','Rapyd','redirectUrl','getDate','getShopPayoutStats','paymentGateways','sourceCurrency','notes','asc','usdtErcWallet','üåê\x20Network\x20filter:\x20','ceil','shopUrl','./paymentService','split','isArray','USDT\x20Polygon','KLYME\x20GB','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','usdcPolygonWallet','PaymentService','generateDailyStatistics','getPayments','publicKey','250962EYQldW','parse','USDC\x20Polygon','awaitingPayout','reduce','txid','6751060UPNnzx','createdAt','responseBody','__esModule','findMany','customer','updateWallets','telegramId','ShopService','_sum','country','set','get','createPublicPayment','Unknown\x20error','payout','message','desc','event','default','USDT\x20BSC','totalPaidOut','retryCount','statusCode','webhookUrl','Plisio','webhookLog','üìÖ\x20Period\x20start:\x20','53154ercvfo','push','currency','shopId','getPayoutById','getPaymentById','COMPLETED','PAID','17575540TJgDYn','aggregate'];a53_0x3af5=function(){return _0x5e8a3b;};return a53_0x3af5();}Object[a53_0x2bd6d6(0x14b)](exports,a53_0x2bd6d6(0x19e),{'value':!![]}),exports[a53_0x2bd6d6(0xff)]=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require('./currencyService'),paymentService_1=require(a53_0x2bd6d6(0x18a));class ShopService{constructor(){const _0x5489f9=a53_0x2bd6d6;this[_0x5489f9(0x175)]=new paymentService_1[(_0x5489f9(0x191))]();}async[a53_0x2bd6d6(0x11f)](_0x4fe84e){const _0x5ceba4=a53_0x2bd6d6,_0x562d23=await database_1[_0x5ceba4(0x10a)][_0x5ceba4(0x16b)][_0x5ceba4(0x154)]({'where':{'id':_0x4fe84e},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x562d23)throw new Error('Shop\x20not\x20found');let _0xd443ef=[];if(_0x562d23[_0x5ceba4(0x15a)]?.[_0x5ceba4(0x162)])try{_0xd443ef=Array[_0x5ceba4(0x18c)](_0x562d23[_0x5ceba4(0x15a)][_0x5ceba4(0x162)])?_0x562d23[_0x5ceba4(0x15a)][_0x5ceba4(0x162)]:JSON['parse'](_0x562d23[_0x5ceba4(0x15a)]['webhookEvents']);}catch(_0x4efaf4){console['error'](_0x5ceba4(0x174),_0x4efaf4),_0xd443ef=[];}return{'id':_0x562d23['id'],'fullName':_0x562d23[_0x5ceba4(0x140)],'username':_0x562d23['username'],'telegramId':_0x562d23[_0x5ceba4(0x150)],'merchantUrl':_0x562d23[_0x5ceba4(0x189)],'gateways':_0x562d23[_0x5ceba4(0x182)]?JSON['parse'](_0x562d23['paymentGateways']):null,'gatewaySettings':_0x562d23[_0x5ceba4(0x15c)]?JSON[_0x5ceba4(0x196)](_0x562d23[_0x5ceba4(0x15c)]):null,'publicKey':_0x562d23[_0x5ceba4(0x194)],'webhookUrl':_0x562d23[_0x5ceba4(0x15a)]?.[_0x5ceba4(0x10f)]||null,'webhookEvents':_0xd443ef,'wallets':{'usdtPolygonWallet':_0x562d23[_0x5ceba4(0x153)],'usdtTrcWallet':_0x562d23[_0x5ceba4(0x173)],'usdtErcWallet':_0x562d23[_0x5ceba4(0x186)],'usdcPolygonWallet':_0x562d23[_0x5ceba4(0x190)]},'status':_0x562d23[_0x5ceba4(0x141)],'createdAt':_0x562d23[_0x5ceba4(0x19c)]};}async[a53_0x2bd6d6(0x14a)](_0x55f381,_0x3dbbe4){const _0x49d739=a53_0x2bd6d6,_0x1ef35a={};_0x3dbbe4[_0x49d739(0x17a)]&&(_0x1ef35a['name']=_0x3dbbe4[_0x49d739(0x17a)]);_0x3dbbe4[_0x49d739(0xfe)]!==undefined&&(_0x1ef35a[_0x49d739(0x150)]=_0x3dbbe4[_0x49d739(0xfe)]||null);_0x3dbbe4[_0x49d739(0x11e)]&&(_0x1ef35a[_0x49d739(0x189)]=_0x3dbbe4[_0x49d739(0x11e)]);_0x3dbbe4[_0x49d739(0x172)]&&(_0x1ef35a[_0x49d739(0x182)]=JSON[_0x49d739(0x16d)](_0x3dbbe4[_0x49d739(0x172)]));_0x3dbbe4['gatewaySettings']&&(_0x1ef35a[_0x49d739(0x15c)]=JSON['stringify'](_0x3dbbe4['gatewaySettings']));_0x3dbbe4[_0x49d739(0x169)]&&(_0x3dbbe4[_0x49d739(0x169)]['usdtPolygonWallet']!==undefined&&(_0x1ef35a['usdtPolygonWallet']=_0x3dbbe4[_0x49d739(0x169)]['usdtPolygonWallet']||null),_0x3dbbe4[_0x49d739(0x169)][_0x49d739(0x173)]!==undefined&&(_0x1ef35a[_0x49d739(0x173)]=_0x3dbbe4[_0x49d739(0x169)][_0x49d739(0x173)]||null),_0x3dbbe4[_0x49d739(0x169)][_0x49d739(0x186)]!==undefined&&(_0x1ef35a['usdtErcWallet']=_0x3dbbe4[_0x49d739(0x169)][_0x49d739(0x186)]||null),_0x3dbbe4[_0x49d739(0x169)]['usdcPolygonWallet']!==undefined&&(_0x1ef35a[_0x49d739(0x190)]=_0x3dbbe4[_0x49d739(0x169)]['usdcPolygonWallet']||null));const _0x355bb4=await database_1['default'][_0x49d739(0x16b)][_0x49d739(0x17d)]({'where':{'id':_0x55f381},'data':_0x1ef35a,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x2a19c5=[];if(_0x355bb4[_0x49d739(0x15a)]?.[_0x49d739(0x162)])try{_0x2a19c5=Array[_0x49d739(0x18c)](_0x355bb4[_0x49d739(0x15a)][_0x49d739(0x162)])?_0x355bb4['settings'][_0x49d739(0x162)]:JSON[_0x49d739(0x196)](_0x355bb4[_0x49d739(0x15a)]['webhookEvents']);}catch(_0x79a197){console['error']('Error\x20parsing\x20webhook\x20events:',_0x79a197),_0x2a19c5=[];}return{'id':_0x355bb4['id'],'fullName':_0x355bb4[_0x49d739(0x140)],'username':_0x355bb4[_0x49d739(0x146)],'telegramId':_0x355bb4['telegram'],'merchantUrl':_0x355bb4[_0x49d739(0x189)],'gateways':_0x355bb4[_0x49d739(0x182)]?JSON['parse'](_0x355bb4[_0x49d739(0x182)]):null,'gatewaySettings':_0x355bb4['gatewaySettings']?JSON[_0x49d739(0x196)](_0x355bb4[_0x49d739(0x15c)]):null,'publicKey':_0x355bb4[_0x49d739(0x194)],'webhookUrl':_0x355bb4[_0x49d739(0x15a)]?.['webhookUrl']||null,'webhookEvents':_0x2a19c5,'wallets':{'usdtPolygonWallet':_0x355bb4[_0x49d739(0x153)],'usdtTrcWallet':_0x355bb4['usdtTrcWallet'],'usdtErcWallet':_0x355bb4[_0x49d739(0x186)],'usdcPolygonWallet':_0x355bb4[_0x49d739(0x190)]},'status':_0x355bb4[_0x49d739(0x141)],'createdAt':_0x355bb4[_0x49d739(0x19c)]};}async[a53_0x2bd6d6(0xfd)](_0x488317,_0x5d7c37){const _0x5a09e6=a53_0x2bd6d6,_0x49d5e0={};_0x5d7c37['usdtPolygonWallet']!==undefined&&(_0x49d5e0['usdtPolygonWallet']=_0x5d7c37[_0x5a09e6(0x153)]||null),_0x5d7c37[_0x5a09e6(0x173)]!==undefined&&(_0x49d5e0[_0x5a09e6(0x173)]=_0x5d7c37[_0x5a09e6(0x173)]||null),_0x5d7c37[_0x5a09e6(0x186)]!==undefined&&(_0x49d5e0['usdtErcWallet']=_0x5d7c37[_0x5a09e6(0x186)]||null),_0x5d7c37[_0x5a09e6(0x190)]!==undefined&&(_0x49d5e0['usdcPolygonWallet']=_0x5d7c37[_0x5a09e6(0x190)]||null),await database_1[_0x5a09e6(0x10a)][_0x5a09e6(0x16b)]['update']({'where':{'id':_0x488317},'data':_0x49d5e0});}async[a53_0x2bd6d6(0x12d)](_0x2c1dcc){const _0x2370f5=a53_0x2bd6d6,_0xea0f1c=await database_1[_0x2370f5(0x10a)][_0x2370f5(0x16b)][_0x2370f5(0x154)]({'where':{'id':_0x2c1dcc},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0xea0f1c?.[_0x2370f5(0x15a)]?.[_0x2370f5(0x10f)])throw new Error('No\x20webhook\x20URL\x20configured');const _0x119ff0={'event':_0x2370f5(0x15d),'payment':{'id':_0x2370f5(0x137),'order_id':_0x2370f5(0x145),'gateway':_0x2370f5(0x15d),'amount':0x64,'currency':_0x2370f5(0x158),'status':'paid','created_at':new Date()[_0x2370f5(0x148)]()}};try{const _0x5a4792=await fetch(_0xea0f1c[_0x2370f5(0x15a)]['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON['stringify'](_0x119ff0)});return _0x5a4792['ok']?{'success':!![],'message':_0x2370f5(0x139)+_0x5a4792[_0x2370f5(0x141)]+')'}:{'success':![],'message':_0x2370f5(0x13e)+_0x5a4792['status']+'\x20'+_0x5a4792[_0x2370f5(0x155)]};}catch(_0x95013a){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x95013a instanceof Error?_0x95013a[_0x2370f5(0x107)]:_0x2370f5(0x105))};}}async[a53_0x2bd6d6(0x15f)](_0x465ca6){const _0x24283e=a53_0x2bd6d6;return this[_0x24283e(0x175)][_0x24283e(0x104)]({'public_key':'','gateway':_0x465ca6[_0x24283e(0x130)],'order_id':undefined,'amount':_0x465ca6[_0x24283e(0x157)],'currency':_0x465ca6['currency'],'source_currency':_0x465ca6[_0x24283e(0x183)],'usage':_0x465ca6['usage'],'expires_at':_0x465ca6[_0x24283e(0x132)]?.[_0x24283e(0x148)](),'success_url':_0x465ca6[_0x24283e(0x17f)],'fail_url':_0x465ca6[_0x24283e(0x17f)],'customer_email':_0x465ca6[_0x24283e(0x167)],'customer_name':_0x465ca6[_0x24283e(0x143)],'country':_0x465ca6[_0x24283e(0x101)],'language':_0x465ca6['language'],'amount_is_editable':_0x465ca6['amountIsEditable'],'max_payments':_0x465ca6[_0x24283e(0x152)],'customer':_0x465ca6[_0x24283e(0xfc)]});}async[a53_0x2bd6d6(0x193)](_0x31e13f,_0x37aa71){const _0xd44eb=a53_0x2bd6d6;return this[_0xd44eb(0x175)]['getPaymentsByShop'](_0x31e13f,_0x37aa71);}async[a53_0x2bd6d6(0x118)](_0x5733f0,_0x4dc03b){const _0x32321c=a53_0x2bd6d6;return this[_0x32321c(0x175)][_0x32321c(0x17b)](_0x5733f0,_0x4dc03b);}async['updatePayment'](_0x492deb,_0x2e0b75,_0x3438a3){const _0x235198=a53_0x2bd6d6,_0x4c4574=await database_1['default'][_0x235198(0x171)]['findFirst']({'where':{'id':_0x2e0b75,'shopId':_0x492deb}});if(!_0x4c4574)throw new Error(_0x235198(0x177));const _0xa4fd6f=await database_1['default'][_0x235198(0x171)][_0x235198(0x17d)]({'where':{'id':_0x2e0b75},'data':{..._0x3438a3,'updatedAt':new Date()}});return _0xa4fd6f;}async['deletePayment'](_0x46a922,_0x14b746){const _0x43ac9c=a53_0x2bd6d6,_0x1dafb6=await database_1[_0x43ac9c(0x10a)]['payment']['findFirst']({'where':{'id':_0x14b746,'shopId':_0x46a922}});if(!_0x1dafb6)throw new Error(_0x43ac9c(0x177));await database_1[_0x43ac9c(0x10a)][_0x43ac9c(0x171)][_0x43ac9c(0x16f)]({'where':{'id':_0x14b746}});}['formatNetworkName'](_0x936bf1){const _0x2cb86f=a53_0x2bd6d6,_0x5e04d5={'polygon':_0x2cb86f(0x18d),'trc20':_0x2cb86f(0x15e),'erc20':'USDT\x20ERC20','bsc':_0x2cb86f(0x10b),'polygon_usdc':_0x2cb86f(0x197)};return _0x5e04d5[_0x936bf1]||_0x936bf1;}async['getPayouts'](_0x52f4f8,_0x33731d){const _0x4c4fd0=a53_0x2bd6d6,{page:_0x31c298,limit:_0x1a11e5,status:_0x53b841,method:_0x17366f,network:_0x3f0ade,dateFrom:_0x3e6e54,dateTo:_0xf927d7,periodFrom:_0x4dd4a0,periodTo:_0x2191be}=_0x33731d,_0x50a29d=(_0x31c298-0x1)*_0x1a11e5;console[_0x4c4fd0(0x164)]('üí∞\x20Getting\x20payouts\x20with\x20filters:',_0x33731d);const _0x3d5e3a={'shopId':_0x52f4f8};_0x53b841&&(_0x3d5e3a[_0x4c4fd0(0x141)]=_0x53b841['toUpperCase'](),console[_0x4c4fd0(0x164)]('üìä\x20Status\x20filter:\x20'+_0x53b841[_0x4c4fd0(0x147)]()));if(_0x17366f)_0x3d5e3a['network']=_0x17366f,console[_0x4c4fd0(0x164)](_0x4c4fd0(0x16a)+_0x17366f);else _0x3f0ade&&(_0x3d5e3a[_0x4c4fd0(0x12b)]=_0x3f0ade,console['log'](_0x4c4fd0(0x187)+_0x3f0ade));if(_0x3e6e54||_0xf927d7||_0x4dd4a0||_0x2191be){_0x3d5e3a[_0x4c4fd0(0x19c)]={};if(_0x4dd4a0){const _0x46f6bd=new Date(_0x4dd4a0);_0x46f6bd['setHours'](0x0,0x0,0x0,0x0),_0x3d5e3a['createdAt'][_0x4c4fd0(0x12e)]=_0x46f6bd,console[_0x4c4fd0(0x164)](_0x4c4fd0(0x112)+_0x46f6bd[_0x4c4fd0(0x148)]());}else{if(_0x3e6e54){const _0x2486b1=new Date(_0x3e6e54);_0x2486b1[_0x4c4fd0(0x133)](0x0,0x0,0x0,0x0),_0x3d5e3a['createdAt']['gte']=_0x2486b1,console[_0x4c4fd0(0x164)](_0x4c4fd0(0x135)+_0x2486b1[_0x4c4fd0(0x148)]());}}if(_0x2191be){const _0x1835e0=new Date(_0x2191be);_0x1835e0[_0x4c4fd0(0x133)](0x17,0x3b,0x3b,0x3e7),_0x3d5e3a['createdAt'][_0x4c4fd0(0x126)]=_0x1835e0,console[_0x4c4fd0(0x164)](_0x4c4fd0(0x125)+_0x1835e0[_0x4c4fd0(0x148)]());}else{if(_0xf927d7){const _0x2e5e5c=new Date(_0xf927d7);_0x2e5e5c[_0x4c4fd0(0x133)](0x17,0x3b,0x3b,0x3e7),_0x3d5e3a[_0x4c4fd0(0x19c)][_0x4c4fd0(0x126)]=_0x2e5e5c,console[_0x4c4fd0(0x164)](_0x4c4fd0(0x136)+_0x2e5e5c['toISOString']());}}}console[_0x4c4fd0(0x164)]('üìä\x20Final\x20WHERE\x20conditions:',JSON[_0x4c4fd0(0x16d)](_0x3d5e3a,null,0x2));const [_0x5a5b10,_0x23cc95]=await Promise[_0x4c4fd0(0x120)]([database_1[_0x4c4fd0(0x10a)][_0x4c4fd0(0x106)]['findMany']({'where':_0x3d5e3a,'skip':_0x50a29d,'take':_0x1a11e5,'orderBy':{'createdAt':_0x4c4fd0(0x108)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x4c4fd0(0x10a)][_0x4c4fd0(0x106)][_0x4c4fd0(0x12c)]({'where':_0x3d5e3a})]);return{'payouts':_0x5a5b10[_0x4c4fd0(0x179)](_0x1430f9=>{const _0x27bfdc=_0x4c4fd0;let _0x4cfea1=null;switch(_0x1430f9[_0x27bfdc(0x12b)]){case _0x27bfdc(0x13a):_0x4cfea1=_0x1430f9[_0x27bfdc(0x16b)][_0x27bfdc(0x153)];break;case _0x27bfdc(0x170):_0x4cfea1=_0x1430f9[_0x27bfdc(0x16b)][_0x27bfdc(0x173)];break;case _0x27bfdc(0x123):_0x4cfea1=_0x1430f9[_0x27bfdc(0x16b)][_0x27bfdc(0x186)];break;case _0x27bfdc(0x14d):_0x4cfea1=_0x1430f9[_0x27bfdc(0x16b)]['usdcPolygonWallet'];break;}return{'id':_0x1430f9['id'],'amount':_0x1430f9['amount'],'network':this['formatNetworkName'](_0x1430f9[_0x27bfdc(0x12b)]),'wallet':_0x4cfea1,'status':_0x1430f9[_0x27bfdc(0x141)],'txid':_0x1430f9[_0x27bfdc(0x19a)],'notes':_0x1430f9[_0x27bfdc(0x184)],'periodFrom':_0x1430f9['periodFrom'],'periodTo':_0x1430f9[_0x27bfdc(0x144)],'createdAt':_0x1430f9['createdAt'],'paidAt':_0x1430f9[_0x27bfdc(0x160)]};}),'pagination':{'page':_0x31c298,'limit':_0x1a11e5,'total':_0x23cc95,'totalPages':Math[_0x4c4fd0(0x188)](_0x23cc95/_0x1a11e5)}};}async[a53_0x2bd6d6(0x117)](_0x572756,_0x1ecda0){const _0x6efbc6=a53_0x2bd6d6,_0x1b8d0f=await database_1[_0x6efbc6(0x10a)][_0x6efbc6(0x106)][_0x6efbc6(0x142)]({'where':{'id':_0x1ecda0,'shopId':_0x572756}});if(!_0x1b8d0f)return null;return{'id':_0x1b8d0f['id'],'amount':_0x1b8d0f[_0x6efbc6(0x157)],'network':_0x1b8d0f['network'],'status':_0x1b8d0f['status'],'txid':_0x1b8d0f[_0x6efbc6(0x19a)],'notes':_0x1b8d0f['notes'],'createdAt':_0x1b8d0f[_0x6efbc6(0x19c)],'paidAt':_0x1b8d0f[_0x6efbc6(0x160)]};}async['getPayoutStatistics'](_0x259b97,_0x48c949){const _0x636020=a53_0x2bd6d6,_0x11a0bf=new Date();let _0x1746b2;switch(_0x48c949){case'7d':_0x1746b2=new Date(_0x11a0bf[_0x636020(0x13b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x1746b2=new Date(_0x11a0bf[_0x636020(0x13b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x636020(0x17c):_0x1746b2=new Date(_0x11a0bf['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x1746b2=new Date(_0x11a0bf[_0x636020(0x13b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x13f5ff,_0x484271,_0x56043c,_0x1c481d,_0x27fb2d,_0x28a17c]=await Promise[_0x636020(0x120)]([database_1[_0x636020(0x10a)][_0x636020(0x106)][_0x636020(0x12c)]({'where':{'shopId':_0x259b97,'createdAt':{'gte':_0x1746b2}}}),database_1['default']['payout']['count']({'where':{'shopId':_0x259b97,'status':'COMPLETED','createdAt':{'gte':_0x1746b2}}}),database_1[_0x636020(0x10a)][_0x636020(0x106)][_0x636020(0x12c)]({'where':{'shopId':_0x259b97,'status':_0x636020(0x127),'createdAt':{'gte':_0x1746b2}}}),database_1['default']['payout'][_0x636020(0x12c)]({'where':{'shopId':_0x259b97,'status':_0x636020(0x159),'createdAt':{'gte':_0x1746b2}}}),database_1['default'][_0x636020(0x106)][_0x636020(0x19f)]({'where':{'shopId':_0x259b97,'createdAt':{'gte':_0x1746b2}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x636020(0x10a)][_0x636020(0x106)]['findMany']({'where':{'shopId':_0x259b97},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x5d6c8f=_0x27fb2d[_0x636020(0x199)]((_0x1f52fd,_0x30dd48)=>_0x1f52fd+_0x30dd48['amount'],0x0),_0x513866=_0x27fb2d[_0x636020(0x128)](_0x1686c3=>_0x1686c3['status']===_0x636020(0x119))[_0x636020(0x199)]((_0x21cca9,_0x59b427)=>_0x21cca9+_0x59b427[_0x636020(0x157)],0x0),_0x228b39=_0x27fb2d[_0x636020(0x128)](_0x291d1c=>_0x291d1c[_0x636020(0x141)]===_0x636020(0x127))['reduce']((_0x474e6d,_0x17da44)=>_0x474e6d+_0x17da44[_0x636020(0x157)],0x0),_0x2aba86=_0x27fb2d[_0x636020(0x199)]((_0x51a186,_0x5cd002)=>{const _0x4b3392=_0x636020;return _0x51a186[_0x5cd002[_0x4b3392(0x12b)]]=(_0x51a186[_0x5cd002[_0x4b3392(0x12b)]]||0x0)+0x1,_0x51a186;},{}),_0x32a821=_0x27fb2d[_0x636020(0x199)]((_0x5564cd,_0x23c343)=>{const _0x56be3c=_0x636020;return _0x5564cd[_0x23c343[_0x56be3c(0x141)]]=(_0x5564cd[_0x23c343['status']]||0x0)+0x1,_0x5564cd;},{});return{'totalPayouts':_0x13f5ff,'completedPayouts':_0x484271,'pendingPayouts':_0x56043c,'rejectedPayouts':_0x1c481d,'totalAmount':_0x5d6c8f,'completedAmount':_0x513866,'pendingAmount':_0x228b39,'payoutsByMethod':_0x2aba86,'payoutsByStatus':_0x32a821,'recentPayouts':_0x28a17c[_0x636020(0x179)](_0x415d2f=>({'id':_0x415d2f['id'],'shopId':_0x259b97,'amount':_0x415d2f[_0x636020(0x157)],'method':_0x415d2f['network'],'status':_0x415d2f[_0x636020(0x141)],'txid':_0x415d2f['txid'],'createdAt':_0x415d2f['createdAt'],'paidAt':_0x415d2f['paidAt']}))};}async[a53_0x2bd6d6(0x181)](_0x36e352){const _0x3bf22e=a53_0x2bd6d6;console[_0x3bf22e(0x164)](_0x3bf22e(0x18f)+_0x36e352+'...');const _0x5cc571=await database_1[_0x3bf22e(0x10a)][_0x3bf22e(0x16b)][_0x3bf22e(0x154)]({'where':{'id':_0x36e352},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x5cc571)throw new Error(_0x3bf22e(0x178));const _0x444570=new Date(),_0x5ef30b=new Date(_0x444570[_0x3bf22e(0x122)](),_0x444570[_0x3bf22e(0x165)](),0x1),_0x40410b=new Date(_0x444570['getFullYear'](),_0x444570[_0x3bf22e(0x165)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x331141=await database_1[_0x3bf22e(0x10a)][_0x3bf22e(0x106)][_0x3bf22e(0x11c)]({'_sum':{'amount':!![]},'where':{'shopId':_0x36e352,'createdAt':{'gte':_0x5ef30b,'lte':_0x40410b},'status':'COMPLETED'}}),_0xd32664=_0x331141[_0x3bf22e(0x100)][_0x3bf22e(0x157)]||0x0,_0xdedf5f={'availableBalance':Math[_0x3bf22e(0x156)](_0x5cc571[_0x3bf22e(0x161)]*0x64)/0x64,'totalPaidOut':Math[_0x3bf22e(0x156)](_0x5cc571[_0x3bf22e(0x10c)]*0x64)/0x64,'awaitingPayout':Math[_0x3bf22e(0x156)](_0x5cc571['balance']*0x64)/0x64,'thisMonth':Math[_0x3bf22e(0x156)](_0xd32664*0x64)/0x64};return console[_0x3bf22e(0x164)]('üìä\x20Shop\x20'+_0x5cc571[_0x3bf22e(0x146)]+_0x3bf22e(0x134)),console[_0x3bf22e(0x164)](_0x3bf22e(0x12f)+_0xdedf5f['availableBalance']+_0x3bf22e(0x11d)),console[_0x3bf22e(0x164)](_0x3bf22e(0x14e)+_0xdedf5f[_0x3bf22e(0x10c)]+_0x3bf22e(0x124)),console['log'](_0x3bf22e(0x12a)+_0xdedf5f[_0x3bf22e(0x198)]+_0x3bf22e(0x11d)),console[_0x3bf22e(0x164)]('\x20\x20\x20üìÖ\x20This\x20month:\x20'+_0xdedf5f[_0x3bf22e(0x129)]+'\x20USDT'),_0xdedf5f;}['getGatewayDisplayName'](_0x434e16){const _0x4b71c9=a53_0x2bd6d6,_0x110c58={'test_gateway':'Test\x20Gateway','plisio':_0x4b71c9(0x110),'rapyd':_0x4b71c9(0x17e),'noda':_0x4b71c9(0x13c),'cointopay':'CoinToPay','klyme_eu':_0x4b71c9(0x13d),'klyme_gb':_0x4b71c9(0x18e),'klyme_de':'KLYME\x20DE'};return _0x110c58[_0x434e16]||_0x434e16;}async[a53_0x2bd6d6(0x138)](_0x45c996){const _0x10c10a=a53_0x2bd6d6;return this[_0x10c10a(0x181)](_0x45c996);}async[a53_0x2bd6d6(0x163)](_0x8f17d6,_0x23efe9){const _0x3f1feb=a53_0x2bd6d6,{page:_0x3c2a1b,limit:_0x31c4c8,paymentId:_0x407b77}=_0x23efe9,_0x19e869=(_0x3c2a1b-0x1)*_0x31c4c8,_0xa38d1={'shopId':_0x8f17d6};_0x407b77&&(_0xa38d1[_0x3f1feb(0x121)]=_0x407b77);const [_0x49729c,_0x49357b]=await Promise[_0x3f1feb(0x120)]([database_1['default'][_0x3f1feb(0x111)]['findMany']({'where':_0xa38d1,'skip':_0x19e869,'take':_0x31c4c8,'orderBy':{'createdAt':_0x3f1feb(0x108)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default']['webhookLog'][_0x3f1feb(0x12c)]({'where':_0xa38d1})]);return{'logs':_0x49729c[_0x3f1feb(0x179)](_0x24c378=>({'id':_0x24c378['id'],'paymentId':_0x24c378[_0x3f1feb(0x121)],'shopId':_0x24c378[_0x3f1feb(0x116)],'event':_0x24c378[_0x3f1feb(0x109)],'statusCode':_0x24c378[_0x3f1feb(0x10e)],'retryCount':_0x24c378[_0x3f1feb(0x10d)],'responseBody':_0x24c378[_0x3f1feb(0x19d)],'createdAt':_0x24c378['createdAt'],'payment':_0x24c378['payment']})),'pagination':{'page':_0x3c2a1b,'limit':_0x31c4c8,'total':_0x49357b,'totalPages':Math['ceil'](_0x49357b/_0x31c4c8)}};}async[a53_0x2bd6d6(0x131)](_0x584ad6,_0x451b5c){const _0x3676fe=a53_0x2bd6d6,_0x43f113=new Date();let _0x5c0d7a;switch(_0x451b5c){case'7d':_0x5c0d7a=new Date(_0x43f113[_0x3676fe(0x13b)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x5c0d7a=new Date(_0x43f113['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3676fe(0x17c):_0x5c0d7a=new Date(_0x43f113['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x5c0d7a=new Date(_0x43f113[_0x3676fe(0x13b)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x4fb212,_0x2e192c,_0x2c153a,_0x441fa5,_0x4b1c86]=await Promise[_0x3676fe(0x120)]([database_1['default']['payment'][_0x3676fe(0x12c)]({'where':{'shopId':_0x584ad6,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x5c0d7a}}}),database_1[_0x3676fe(0x10a)]['payment'][_0x3676fe(0x12c)]({'where':{'shopId':_0x584ad6,'gateway':{'not':_0x3676fe(0x151)},'status':'PAID','createdAt':{'gte':_0x5c0d7a}}}),database_1['default'][_0x3676fe(0x171)][_0x3676fe(0x19f)]({'where':{'shopId':_0x584ad6,'gateway':{'not':_0x3676fe(0x151)},'status':_0x3676fe(0x11a),'createdAt':{'gte':_0x5c0d7a}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3676fe(0x10a)][_0x3676fe(0x171)]['findMany']({'where':{'shopId':_0x584ad6,'gateway':{'not':_0x3676fe(0x151)}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x3676fe(0x10a)][_0x3676fe(0x171)][_0x3676fe(0x19f)]({'where':{'shopId':_0x584ad6,'gateway':{'not':_0x3676fe(0x151)},'createdAt':{'gte':_0x5c0d7a}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x3676fe(0x185)}})]);let _0x295602=0x0;for(const _0x260ce1 of _0x2c153a){if(_0x260ce1[_0x3676fe(0x176)])_0x295602+=_0x260ce1[_0x3676fe(0x176)];else{const _0x5950a2=await currencyService_1['currencyService']['convertToUSDT'](_0x260ce1[_0x3676fe(0x157)],_0x260ce1[_0x3676fe(0x115)]);_0x295602+=_0x5950a2;}}const _0x345306=this[_0x3676fe(0x192)](_0x4b1c86,_0x5c0d7a,_0x43f113),_0x1316da=_0x4fb212>0x0?_0x2e192c/_0x4fb212*0x64:0x0;return{'totalPayments':_0x4fb212,'successfulPayments':_0x2e192c,'totalRevenue':Math[_0x3676fe(0x156)](_0x295602*0x64)/0x64,'conversionRate':Math[_0x3676fe(0x156)](_0x1316da*0x64)/0x64,'dailyRevenue':_0x345306['dailyRevenue'],'dailyPayments':_0x345306['dailyPayments'],'recentPayments':_0x441fa5[_0x3676fe(0x179)](_0x3970ac=>({'id':_0x3970ac['id'],'gateway':_0x3970ac[_0x3676fe(0x130)],'amount':_0x3970ac[_0x3676fe(0x157)],'currency':_0x3970ac[_0x3676fe(0x115)],'status':_0x3970ac[_0x3676fe(0x141)],'createdAt':_0x3970ac[_0x3676fe(0x19c)]}))};}[a53_0x2bd6d6(0x192)](_0x8042d3,_0x512857,_0x3975e2){const _0x15c2f1=a53_0x2bd6d6,_0x1a4b55=new Map(),_0x19bafc=new Date(_0x512857);while(_0x19bafc<=_0x3975e2){const _0x17b11c=_0x19bafc[_0x15c2f1(0x148)]()[_0x15c2f1(0x18b)]('T')[0x0];_0x1a4b55[_0x15c2f1(0x102)](_0x17b11c,{'revenue':0x0,'count':0x0}),_0x19bafc[_0x15c2f1(0x16c)](_0x19bafc[_0x15c2f1(0x180)]()+0x1);}for(const _0x2ed8e9 of _0x8042d3){const _0x4dd368=_0x2ed8e9[_0x15c2f1(0x19c)]['toISOString']()[_0x15c2f1(0x18b)]('T')[0x0],_0x53839e=_0x1a4b55[_0x15c2f1(0x103)](_0x4dd368);_0x53839e&&(_0x53839e['count']+=0x1,_0x2ed8e9[_0x15c2f1(0x141)]===_0x15c2f1(0x11a)&&_0x2ed8e9[_0x15c2f1(0x176)]&&(_0x53839e[_0x15c2f1(0x16e)]+=_0x2ed8e9['amountUSDT']));}const _0x3fa586=[],_0x1c7927=[];for(const [_0xf0b611,_0x5f4f23]of _0x1a4b55){_0x3fa586[_0x15c2f1(0x114)]({'date':_0xf0b611,'amount':Math['round'](_0x5f4f23['revenue']*0x64)/0x64}),_0x1c7927[_0x15c2f1(0x114)]({'date':_0xf0b611,'count':_0x5f4f23['count']});}return{'dailyRevenue':_0x3fa586,'dailyPayments':_0x1c7927};}}exports[a53_0x2bd6d6(0xff)]=ShopService;