'use strict';const a58_0xf7bb2=a58_0x3ebf;(function(_0x328612,_0xabb4c5){const _0x1cda73=a58_0x3ebf,_0x4b8561=_0x328612();while(!![]){try{const _0x520f66=parseInt(_0x1cda73(0x163))/0x1*(-parseInt(_0x1cda73(0x17e))/0x2)+parseInt(_0x1cda73(0x1c3))/0x3+parseInt(_0x1cda73(0x193))/0x4+-parseInt(_0x1cda73(0x1d6))/0x5+-parseInt(_0x1cda73(0x13b))/0x6+parseInt(_0x1cda73(0x13e))/0x7*(parseInt(_0x1cda73(0x18d))/0x8)+parseInt(_0x1cda73(0x1ac))/0x9;if(_0x520f66===_0xabb4c5)break;else _0x4b8561['push'](_0x4b8561['shift']());}catch(_0x223cf9){_0x4b8561['push'](_0x4b8561['shift']());}}}(a58_0x4695,0x305e2));function a58_0x3ebf(_0x37069d,_0x30458f){const _0x4695cf=a58_0x4695();return a58_0x3ebf=function(_0x3ebfec,_0x4985dd){_0x3ebfec=_0x3ebfec-0x127;let _0x49decb=_0x4695cf[_0x3ebfec];return _0x49decb;},a58_0x3ebf(_0x37069d,_0x30458f);}var __importDefault=this&&this[a58_0xf7bb2(0x1b3)]||function(_0x4ade70){return _0x4ade70&&_0x4ade70['__esModule']?_0x4ade70:{'default':_0x4ade70};};Object[a58_0xf7bb2(0x164)](exports,'__esModule',{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require(a58_0xf7bb2(0x12a))),currencyService_1=require(a58_0xf7bb2(0x1d8)),paymentService_1=require(a58_0xf7bb2(0x1a2));class ShopService{constructor(){const _0x2186f5=a58_0xf7bb2;this[_0x2186f5(0x129)]=new paymentService_1[(_0x2186f5(0x194))]();}async[a58_0xf7bb2(0x1be)](_0x151487){const _0x2d44cf=a58_0xf7bb2,_0x28c5e6=await database_1[_0x2d44cf(0x12b)][_0x2d44cf(0x187)][_0x2d44cf(0x191)]({'where':{'id':_0x151487},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x28c5e6)throw new Error(_0x2d44cf(0x1cb));let _0x443ca8=[];if(_0x28c5e6[_0x2d44cf(0x135)]?.[_0x2d44cf(0x1b8)])try{_0x443ca8=Array[_0x2d44cf(0x17b)](_0x28c5e6[_0x2d44cf(0x135)]['webhookEvents'])?_0x28c5e6[_0x2d44cf(0x135)][_0x2d44cf(0x1b8)]:JSON[_0x2d44cf(0x151)](_0x28c5e6[_0x2d44cf(0x135)]['webhookEvents']);}catch(_0x1821c5){console[_0x2d44cf(0x131)](_0x2d44cf(0x183),_0x1821c5),_0x443ca8=[];}return{'id':_0x28c5e6['id'],'fullName':_0x28c5e6[_0x2d44cf(0x15d)],'username':_0x28c5e6['username'],'telegramId':_0x28c5e6[_0x2d44cf(0x1c5)],'merchantUrl':_0x28c5e6[_0x2d44cf(0x16c)],'gateways':_0x28c5e6['paymentGateways']?JSON['parse'](_0x28c5e6[_0x2d44cf(0x14e)]):null,'gatewaySettings':_0x28c5e6[_0x2d44cf(0x1a7)]?JSON['parse'](_0x28c5e6[_0x2d44cf(0x1a7)]):null,'publicKey':_0x28c5e6[_0x2d44cf(0x180)],'webhookUrl':_0x28c5e6['settings']?.[_0x2d44cf(0x15b)]||null,'webhookEvents':_0x443ca8,'wallets':{'usdtPolygonWallet':_0x28c5e6[_0x2d44cf(0x1b5)],'usdtTrcWallet':_0x28c5e6[_0x2d44cf(0x178)],'usdtErcWallet':_0x28c5e6[_0x2d44cf(0x188)],'usdcPolygonWallet':_0x28c5e6[_0x2d44cf(0x140)]},'status':_0x28c5e6['status'],'createdAt':_0x28c5e6[_0x2d44cf(0x1c8)]};}async[a58_0xf7bb2(0x14a)](_0x289cc3,_0x4674ed){const _0x409673=a58_0xf7bb2,_0x4fb052={};_0x4674ed['fullName']&&(_0x4fb052[_0x409673(0x15d)]=_0x4674ed['fullName']);_0x4674ed['telegramId']!==undefined&&(_0x4fb052['telegram']=_0x4674ed[_0x409673(0x136)]||null);_0x4674ed[_0x409673(0x15e)]&&(_0x4fb052[_0x409673(0x16c)]=_0x4674ed['merchantUrl']);_0x4674ed[_0x409673(0x165)]&&(_0x4fb052[_0x409673(0x14e)]=JSON[_0x409673(0x161)](_0x4674ed[_0x409673(0x165)]));_0x4674ed[_0x409673(0x1a7)]&&(_0x4fb052[_0x409673(0x1a7)]=JSON[_0x409673(0x161)](_0x4674ed[_0x409673(0x1a7)]));_0x4674ed[_0x409673(0x181)]&&(_0x4674ed['wallets'][_0x409673(0x1b5)]!==undefined&&(_0x4fb052[_0x409673(0x1b5)]=_0x4674ed[_0x409673(0x181)][_0x409673(0x1b5)]||null),_0x4674ed[_0x409673(0x181)][_0x409673(0x178)]!==undefined&&(_0x4fb052[_0x409673(0x178)]=_0x4674ed[_0x409673(0x181)][_0x409673(0x178)]||null),_0x4674ed[_0x409673(0x181)][_0x409673(0x188)]!==undefined&&(_0x4fb052[_0x409673(0x188)]=_0x4674ed[_0x409673(0x181)][_0x409673(0x188)]||null),_0x4674ed[_0x409673(0x181)][_0x409673(0x140)]!==undefined&&(_0x4fb052[_0x409673(0x140)]=_0x4674ed[_0x409673(0x181)][_0x409673(0x140)]||null));const _0xbfa2d8=await database_1['default'][_0x409673(0x187)][_0x409673(0x133)]({'where':{'id':_0x289cc3},'data':_0x4fb052,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0xca325d=[];if(_0xbfa2d8[_0x409673(0x135)]?.[_0x409673(0x1b8)])try{_0xca325d=Array[_0x409673(0x17b)](_0xbfa2d8[_0x409673(0x135)][_0x409673(0x1b8)])?_0xbfa2d8[_0x409673(0x135)][_0x409673(0x1b8)]:JSON[_0x409673(0x151)](_0xbfa2d8[_0x409673(0x135)][_0x409673(0x1b8)]);}catch(_0x26e36a){console['error'](_0x409673(0x183),_0x26e36a),_0xca325d=[];}return{'id':_0xbfa2d8['id'],'fullName':_0xbfa2d8[_0x409673(0x15d)],'username':_0xbfa2d8[_0x409673(0x19c)],'telegramId':_0xbfa2d8[_0x409673(0x1c5)],'merchantUrl':_0xbfa2d8[_0x409673(0x16c)],'gateways':_0xbfa2d8[_0x409673(0x14e)]?JSON[_0x409673(0x151)](_0xbfa2d8[_0x409673(0x14e)]):null,'gatewaySettings':_0xbfa2d8[_0x409673(0x1a7)]?JSON['parse'](_0xbfa2d8[_0x409673(0x1a7)]):null,'publicKey':_0xbfa2d8['publicKey'],'webhookUrl':_0xbfa2d8[_0x409673(0x135)]?.[_0x409673(0x15b)]||null,'webhookEvents':_0xca325d,'wallets':{'usdtPolygonWallet':_0xbfa2d8[_0x409673(0x1b5)],'usdtTrcWallet':_0xbfa2d8['usdtTrcWallet'],'usdtErcWallet':_0xbfa2d8['usdtErcWallet'],'usdcPolygonWallet':_0xbfa2d8['usdcPolygonWallet']},'status':_0xbfa2d8['status'],'createdAt':_0xbfa2d8['createdAt']};}async[a58_0xf7bb2(0x19d)](_0x168b12,_0x597e43){const _0x14f59d=a58_0xf7bb2,_0x3b8b81={};_0x597e43['usdtPolygonWallet']!==undefined&&(_0x3b8b81[_0x14f59d(0x1b5)]=_0x597e43[_0x14f59d(0x1b5)]||null),_0x597e43[_0x14f59d(0x178)]!==undefined&&(_0x3b8b81[_0x14f59d(0x178)]=_0x597e43[_0x14f59d(0x178)]||null),_0x597e43['usdtErcWallet']!==undefined&&(_0x3b8b81[_0x14f59d(0x188)]=_0x597e43[_0x14f59d(0x188)]||null),_0x597e43[_0x14f59d(0x140)]!==undefined&&(_0x3b8b81['usdcPolygonWallet']=_0x597e43[_0x14f59d(0x140)]||null),await database_1['default'][_0x14f59d(0x187)][_0x14f59d(0x133)]({'where':{'id':_0x168b12},'data':_0x3b8b81});}async[a58_0xf7bb2(0x189)](_0x39c0eb){const _0x4462cf=a58_0xf7bb2,_0x3d3a95=await database_1[_0x4462cf(0x12b)][_0x4462cf(0x187)][_0x4462cf(0x191)]({'where':{'id':_0x39c0eb},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x3d3a95?.[_0x4462cf(0x135)]?.[_0x4462cf(0x15b)])throw new Error(_0x4462cf(0x1d1));const _0x2cb63d={'event':_0x4462cf(0x1a5),'payment':{'id':_0x4462cf(0x1c0),'order_id':_0x4462cf(0x13c),'gateway':'test','amount':0x64,'currency':_0x4462cf(0x17c),'status':'paid','created_at':new Date()[_0x4462cf(0x1a1)]()}};try{const _0x2cdb85=await fetch(_0x3d3a95['settings'][_0x4462cf(0x15b)],{'method':_0x4462cf(0x18c),'headers':{'Content-Type':'application/json','User-Agent':_0x4462cf(0x1a9)},'body':JSON[_0x4462cf(0x161)](_0x2cb63d)});return _0x2cdb85['ok']?{'success':!![],'message':_0x4462cf(0x195)+_0x2cdb85[_0x4462cf(0x1da)]+')'}:{'success':![],'message':_0x4462cf(0x199)+_0x2cdb85[_0x4462cf(0x1da)]+'\x20'+_0x2cdb85[_0x4462cf(0x16a)]};}catch(_0x397e52){return{'success':![],'message':_0x4462cf(0x1cc)+(_0x397e52 instanceof Error?_0x397e52['message']:'Unknown\x20error')};}}async[a58_0xf7bb2(0x12e)](_0x1dc44e){const _0x598d9c=a58_0xf7bb2;return this[_0x598d9c(0x129)][_0x598d9c(0x162)]({'public_key':'','gateway':_0x1dc44e[_0x598d9c(0x1aa)],'order_id':undefined,'amount':_0x1dc44e[_0x598d9c(0x14d)],'currency':_0x1dc44e[_0x598d9c(0x1a4)],'source_currency':_0x1dc44e[_0x598d9c(0x1c1)],'usage':_0x1dc44e[_0x598d9c(0x182)],'expires_at':_0x1dc44e[_0x598d9c(0x1b2)]?.[_0x598d9c(0x1a1)](),'success_url':_0x1dc44e[_0x598d9c(0x144)],'fail_url':_0x1dc44e[_0x598d9c(0x144)],'customer_email':_0x1dc44e[_0x598d9c(0x134)],'customer_name':_0x1dc44e[_0x598d9c(0x16e)],'country':_0x1dc44e['country'],'language':_0x1dc44e[_0x598d9c(0x1d0)],'amount_is_editable':_0x1dc44e[_0x598d9c(0x1c4)],'max_payments':_0x1dc44e[_0x598d9c(0x1bf)],'customer':_0x1dc44e[_0x598d9c(0x12c)]});}async[a58_0xf7bb2(0x1b7)](_0x43ffd7,_0x42e06e){const _0x103e13=a58_0xf7bb2;return this['paymentService'][_0x103e13(0x16d)](_0x43ffd7,_0x42e06e);}async[a58_0xf7bb2(0x154)](_0x120b55,_0x26c994){const _0x33c1b1=a58_0xf7bb2;return this[_0x33c1b1(0x129)][_0x33c1b1(0x1b6)](_0x120b55,_0x26c994);}async[a58_0xf7bb2(0x19a)](_0x293083,_0x19403d,_0x2d65c6){const _0x1d488d=a58_0xf7bb2,_0x566d00=await database_1[_0x1d488d(0x12b)][_0x1d488d(0x16f)][_0x1d488d(0x18a)]({'where':{'id':_0x19403d,'shopId':_0x293083}});if(!_0x566d00)throw new Error(_0x1d488d(0x1cf));const _0x4e799d=await database_1[_0x1d488d(0x12b)][_0x1d488d(0x16f)][_0x1d488d(0x133)]({'where':{'id':_0x19403d},'data':{..._0x2d65c6,'updatedAt':new Date()}});return _0x4e799d;}async[a58_0xf7bb2(0x1cd)](_0x52cf70,_0x34776d){const _0x2ca20d=a58_0xf7bb2,_0x35f4e6=await database_1[_0x2ca20d(0x12b)]['payment'][_0x2ca20d(0x18a)]({'where':{'id':_0x34776d,'shopId':_0x52cf70}});if(!_0x35f4e6)throw new Error('Payment\x20not\x20found');await database_1[_0x2ca20d(0x12b)]['payment']['delete']({'where':{'id':_0x34776d}});}[a58_0xf7bb2(0x130)](_0x3753fa){const _0x11d115=a58_0xf7bb2,_0x53c408={'polygon':_0x11d115(0x18f),'trc20':_0x11d115(0x1b1),'erc20':'USDT\x20ERC20','bsc':_0x11d115(0x1b0),'polygon_usdc':_0x11d115(0x14b)};return _0x53c408[_0x3753fa]||_0x3753fa;}async[a58_0xf7bb2(0x1a0)](_0x477703,_0x2343ca){const _0x15b5ef=a58_0xf7bb2,{page:_0xa31bf4,limit:_0x36291b,status:_0x966570,method:_0x242c18,network:_0x4d14f9,dateFrom:_0x9a3f68,dateTo:_0x2bb9a3,periodFrom:_0x2275e8,periodTo:_0x1dfe86}=_0x2343ca,_0x58164a=(_0xa31bf4-0x1)*_0x36291b;console[_0x15b5ef(0x155)](_0x15b5ef(0x18e),_0x2343ca);const _0x2af538={'shopId':_0x477703};_0x966570&&(_0x2af538[_0x15b5ef(0x1da)]=_0x966570[_0x15b5ef(0x137)](),console[_0x15b5ef(0x155)](_0x15b5ef(0x132)+_0x966570['toUpperCase']()));if(_0x242c18)_0x2af538[_0x15b5ef(0x148)]=_0x242c18,console[_0x15b5ef(0x155)](_0x15b5ef(0x184)+_0x242c18);else _0x4d14f9&&(_0x2af538[_0x15b5ef(0x148)]=_0x4d14f9,console[_0x15b5ef(0x155)](_0x15b5ef(0x146)+_0x4d14f9));if(_0x9a3f68||_0x2bb9a3||_0x2275e8||_0x1dfe86){_0x2af538[_0x15b5ef(0x1c8)]={};if(_0x2275e8){const _0x44fc17=new Date(_0x2275e8);_0x44fc17['setHours'](0x0,0x0,0x0,0x0),_0x2af538[_0x15b5ef(0x1c8)]['gte']=_0x44fc17,console[_0x15b5ef(0x155)](_0x15b5ef(0x1c2)+_0x44fc17[_0x15b5ef(0x1a1)]());}else{if(_0x9a3f68){const _0x1814dc=new Date(_0x9a3f68);_0x1814dc[_0x15b5ef(0x167)](0x0,0x0,0x0,0x0),_0x2af538['createdAt'][_0x15b5ef(0x156)]=_0x1814dc,console[_0x15b5ef(0x155)](_0x15b5ef(0x12f)+_0x1814dc[_0x15b5ef(0x1a1)]());}}if(_0x1dfe86){const _0x3a4886=new Date(_0x1dfe86);_0x3a4886['setHours'](0x17,0x3b,0x3b,0x3e7),_0x2af538[_0x15b5ef(0x1c8)][_0x15b5ef(0x1d5)]=_0x3a4886,console[_0x15b5ef(0x155)](_0x15b5ef(0x158)+_0x3a4886['toISOString']());}else{if(_0x2bb9a3){const _0x23a1ac=new Date(_0x2bb9a3);_0x23a1ac['setHours'](0x17,0x3b,0x3b,0x3e7),_0x2af538[_0x15b5ef(0x1c8)][_0x15b5ef(0x1d5)]=_0x23a1ac,console[_0x15b5ef(0x155)]('📅\x20Date\x20end:\x20'+_0x23a1ac[_0x15b5ef(0x1a1)]());}}}console['log'](_0x15b5ef(0x1bc),JSON['stringify'](_0x2af538,null,0x2));const [_0x118db8,_0x229e5b]=await Promise[_0x15b5ef(0x175)]([database_1[_0x15b5ef(0x12b)][_0x15b5ef(0x12d)][_0x15b5ef(0x1ad)]({'where':_0x2af538,'skip':_0x58164a,'take':_0x36291b,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x15b5ef(0x12b)][_0x15b5ef(0x12d)][_0x15b5ef(0x170)]({'where':_0x2af538})]);return{'payouts':_0x118db8[_0x15b5ef(0x1c7)](_0x5d6325=>{const _0x180bac=_0x15b5ef;let _0x38ef38=null;switch(_0x5d6325['network']){case _0x180bac(0x145):_0x38ef38=_0x5d6325[_0x180bac(0x187)][_0x180bac(0x1b5)];break;case _0x180bac(0x1ce):_0x38ef38=_0x5d6325[_0x180bac(0x187)][_0x180bac(0x178)];break;case _0x180bac(0x13d):_0x38ef38=_0x5d6325[_0x180bac(0x187)]['usdtErcWallet'];break;case _0x180bac(0x17d):_0x38ef38=_0x5d6325[_0x180bac(0x187)]['usdcPolygonWallet'];break;}return{'id':_0x5d6325['id'],'amount':_0x5d6325['amount'],'network':this['formatNetworkName'](_0x5d6325[_0x180bac(0x148)]),'wallet':_0x38ef38,'status':_0x5d6325['status'],'txid':_0x5d6325[_0x180bac(0x190)],'notes':_0x5d6325[_0x180bac(0x173)],'periodFrom':_0x5d6325[_0x180bac(0x174)],'periodTo':_0x5d6325['periodTo'],'createdAt':_0x5d6325['createdAt'],'paidAt':_0x5d6325[_0x180bac(0x15f)]};}),'pagination':{'page':_0xa31bf4,'limit':_0x36291b,'total':_0x229e5b,'totalPages':Math[_0x15b5ef(0x192)](_0x229e5b/_0x36291b)}};}async[a58_0xf7bb2(0x157)](_0x2f2c2f,_0x1c3eee){const _0x36af3f=a58_0xf7bb2,_0x7a7b4c=await database_1[_0x36af3f(0x12b)][_0x36af3f(0x12d)][_0x36af3f(0x18a)]({'where':{'id':_0x1c3eee,'shopId':_0x2f2c2f}});if(!_0x7a7b4c)return null;return{'id':_0x7a7b4c['id'],'amount':_0x7a7b4c[_0x36af3f(0x14d)],'network':_0x7a7b4c['network'],'status':_0x7a7b4c[_0x36af3f(0x1da)],'txid':_0x7a7b4c[_0x36af3f(0x190)],'notes':_0x7a7b4c[_0x36af3f(0x173)],'createdAt':_0x7a7b4c[_0x36af3f(0x1c8)],'paidAt':_0x7a7b4c[_0x36af3f(0x15f)]};}async[a58_0xf7bb2(0x128)](_0x52d5a3,_0xbb767c){const _0x20bbcd=a58_0xf7bb2,_0x10a707=new Date();let _0x2f6848,_0x25fb09;switch(_0xbb767c){case _0x20bbcd(0x1af):case'YESTERDAY':const _0x277001=new Date(_0x10a707);_0x277001['setDate'](_0x277001['getDate']()-0x1),_0x2f6848=new Date(_0x277001),_0x2f6848[_0x20bbcd(0x167)](0x0,0x0,0x0,0x0),_0x25fb09=new Date(_0x277001),_0x25fb09[_0x20bbcd(0x167)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x2f6848=new Date(_0x10a707['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x2f6848=new Date(_0x10a707[_0x20bbcd(0x1d2)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x20bbcd(0x138):_0x2f6848=new Date(_0x10a707['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x2f6848=new Date(_0x10a707[_0x20bbcd(0x1d2)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x3c81b4={'gte':_0x2f6848};_0x25fb09&&(_0x3c81b4[_0x20bbcd(0x1d5)]=_0x25fb09);const [_0xb9aba,_0x1066fc,_0xc948d2,_0x42951c,_0x2b1904,_0x263598]=await Promise[_0x20bbcd(0x175)]([database_1['default'][_0x20bbcd(0x12d)][_0x20bbcd(0x170)]({'where':{'shopId':_0x52d5a3,'createdAt':_0x3c81b4}}),database_1[_0x20bbcd(0x12b)]['payout'][_0x20bbcd(0x170)]({'where':{'shopId':_0x52d5a3,'status':_0x20bbcd(0x1d7),'createdAt':_0x3c81b4}}),database_1[_0x20bbcd(0x12b)]['payout'][_0x20bbcd(0x170)]({'where':{'shopId':_0x52d5a3,'status':_0x20bbcd(0x14c),'createdAt':_0x3c81b4}}),database_1[_0x20bbcd(0x12b)][_0x20bbcd(0x12d)][_0x20bbcd(0x170)]({'where':{'shopId':_0x52d5a3,'status':_0x20bbcd(0x127),'createdAt':_0x3c81b4}}),database_1[_0x20bbcd(0x12b)][_0x20bbcd(0x12d)][_0x20bbcd(0x1ad)]({'where':{'shopId':_0x52d5a3,'createdAt':_0x3c81b4},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x20bbcd(0x12b)][_0x20bbcd(0x12d)][_0x20bbcd(0x1ad)]({'where':{'shopId':_0x52d5a3},'take':0xa,'orderBy':{'createdAt':_0x20bbcd(0x177)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x1ea76c=_0x2b1904[_0x20bbcd(0x1d9)]((_0x2f8c86,_0x1d6a57)=>_0x2f8c86+_0x1d6a57[_0x20bbcd(0x14d)],0x0),_0x39e3f6=_0x2b1904['filter'](_0x7b8157=>_0x7b8157[_0x20bbcd(0x1da)]===_0x20bbcd(0x1d7))[_0x20bbcd(0x1d9)]((_0x1ecb6c,_0x34c40a)=>_0x1ecb6c+_0x34c40a[_0x20bbcd(0x14d)],0x0),_0x20ad37=_0x2b1904[_0x20bbcd(0x197)](_0x2ff3f1=>_0x2ff3f1['status']==='PENDING')['reduce']((_0x3a25b9,_0x246583)=>_0x3a25b9+_0x246583[_0x20bbcd(0x14d)],0x0),_0x2c8cdf=_0x2b1904['reduce']((_0x809891,_0x35d317)=>{const _0x223630=_0x20bbcd;return _0x809891[_0x35d317[_0x223630(0x148)]]=(_0x809891[_0x35d317[_0x223630(0x148)]]||0x0)+0x1,_0x809891;},{}),_0x1543c9=_0x2b1904[_0x20bbcd(0x1d9)]((_0x540f03,_0x49252b)=>{const _0x4bf936=_0x20bbcd;return _0x540f03[_0x49252b[_0x4bf936(0x1da)]]=(_0x540f03[_0x49252b[_0x4bf936(0x1da)]]||0x0)+0x1,_0x540f03;},{});return{'totalPayouts':_0xb9aba,'completedPayouts':_0x1066fc,'pendingPayouts':_0xc948d2,'rejectedPayouts':_0x42951c,'totalAmount':_0x1ea76c,'completedAmount':_0x39e3f6,'pendingAmount':_0x20ad37,'payoutsByMethod':_0x2c8cdf,'payoutsByStatus':_0x1543c9,'recentPayouts':_0x263598[_0x20bbcd(0x1c7)](_0x140bf6=>({'id':_0x140bf6['id'],'shopId':_0x52d5a3,'amount':_0x140bf6[_0x20bbcd(0x14d)],'method':_0x140bf6[_0x20bbcd(0x148)],'status':_0x140bf6[_0x20bbcd(0x1da)],'txid':_0x140bf6['txid'],'createdAt':_0x140bf6[_0x20bbcd(0x1c8)],'paidAt':_0x140bf6[_0x20bbcd(0x15f)]}))};}async['getShopPayoutStats'](_0x37038f){const _0x4f7230=a58_0xf7bb2;console[_0x4f7230(0x155)](_0x4f7230(0x17a)+_0x37038f+'...');const _0x2ebf51=await database_1[_0x4f7230(0x12b)][_0x4f7230(0x187)][_0x4f7230(0x191)]({'where':{'id':_0x37038f},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x2ebf51)throw new Error(_0x4f7230(0x1cb));const _0x1aaf29=new Date(),_0x35a0c3=new Date(_0x1aaf29['getFullYear'](),_0x1aaf29['getMonth'](),0x1),_0x578fc6=new Date(_0x1aaf29[_0x4f7230(0x186)](),_0x1aaf29[_0x4f7230(0x172)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x2429f8=await database_1[_0x4f7230(0x12b)][_0x4f7230(0x12d)][_0x4f7230(0x1d4)]({'_sum':{'amount':!![]},'where':{'shopId':_0x37038f,'createdAt':{'gte':_0x35a0c3,'lte':_0x578fc6},'status':_0x4f7230(0x1d7)}}),_0x5e7b29=_0x2429f8[_0x4f7230(0x19f)][_0x4f7230(0x14d)]||0x0,_0x440f86={'availableBalance':Math[_0x4f7230(0x15c)](_0x2ebf51[_0x4f7230(0x1b4)]*0x64)/0x64,'totalPaidOut':Math[_0x4f7230(0x15c)](_0x2ebf51[_0x4f7230(0x152)]*0x64)/0x64,'awaitingPayout':Math[_0x4f7230(0x15c)](_0x2ebf51[_0x4f7230(0x1b4)]*0x64)/0x64,'thisMonth':Math['round'](_0x5e7b29*0x64)/0x64};return console[_0x4f7230(0x155)]('📊\x20Shop\x20'+_0x2ebf51[_0x4f7230(0x19c)]+_0x4f7230(0x1c6)),console[_0x4f7230(0x155)](_0x4f7230(0x149)+_0x440f86['availableBalance']+_0x4f7230(0x143)),console[_0x4f7230(0x155)](_0x4f7230(0x13f)+_0x440f86[_0x4f7230(0x152)]+_0x4f7230(0x1ba)),console[_0x4f7230(0x155)](_0x4f7230(0x1db)+_0x440f86[_0x4f7230(0x168)]+_0x4f7230(0x143)),console[_0x4f7230(0x155)](_0x4f7230(0x1d3)+_0x440f86[_0x4f7230(0x13a)]+'\x20USDT'),_0x440f86;}[a58_0xf7bb2(0x176)](_0x45718a){const _0x14be1e=a58_0xf7bb2,_0x3c453a={'test_gateway':'Test\x20Gateway','plisio':_0x14be1e(0x139),'rapyd':_0x14be1e(0x179),'noda':_0x14be1e(0x185),'cointopay':_0x14be1e(0x1ca),'klyme_eu':_0x14be1e(0x1ae),'klyme_gb':_0x14be1e(0x17f),'klyme_de':_0x14be1e(0x141)};return _0x3c453a[_0x45718a]||_0x45718a;}async[a58_0xf7bb2(0x142)](_0x1f3971){const _0x4462d7=a58_0xf7bb2;return this[_0x4462d7(0x150)](_0x1f3971);}async[a58_0xf7bb2(0x14f)](_0x4b9498,_0x3db32b){const _0x412b07=a58_0xf7bb2,{page:_0x3a05ac,limit:_0x5e0c0d,paymentId:_0x5d6a2e}=_0x3db32b,_0x157cb7=(_0x3a05ac-0x1)*_0x5e0c0d,_0x2e62aa={'shopId':_0x4b9498};_0x5d6a2e&&(_0x2e62aa[_0x412b07(0x1c9)]=_0x5d6a2e);const [_0x5b32c1,_0x133456]=await Promise[_0x412b07(0x175)]([database_1[_0x412b07(0x12b)][_0x412b07(0x196)][_0x412b07(0x1ad)]({'where':_0x2e62aa,'skip':_0x157cb7,'take':_0x5e0c0d,'orderBy':{'createdAt':_0x412b07(0x177)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x412b07(0x12b)][_0x412b07(0x196)][_0x412b07(0x170)]({'where':_0x2e62aa})]);return{'logs':_0x5b32c1[_0x412b07(0x1c7)](_0x2db93c=>({'id':_0x2db93c['id'],'paymentId':_0x2db93c[_0x412b07(0x1c9)],'shopId':_0x2db93c[_0x412b07(0x19e)],'event':_0x2db93c[_0x412b07(0x16b)],'statusCode':_0x2db93c['statusCode'],'retryCount':_0x2db93c['retryCount'],'responseBody':_0x2db93c['responseBody'],'createdAt':_0x2db93c[_0x412b07(0x1c8)],'payment':_0x2db93c[_0x412b07(0x16f)]})),'pagination':{'page':_0x3a05ac,'limit':_0x5e0c0d,'total':_0x133456,'totalPages':Math['ceil'](_0x133456/_0x5e0c0d)}};}async['getStatistics'](_0x59ad26,_0x164432){const _0x4b8e83=a58_0xf7bb2,_0x2792ef=new Date();let _0x49c0c1,_0x1a7bfd;switch(_0x164432['toLowerCase']()){case _0x4b8e83(0x160):_0x49c0c1=new Date(_0x2792ef[_0x4b8e83(0x186)](),_0x2792ef['getMonth'](),_0x2792ef[_0x4b8e83(0x1bb)](),0x0,0x0,0x0,0x0);break;case _0x4b8e83(0x1af):case _0x4b8e83(0x1a8):const _0x56cc1d=new Date(_0x2792ef);_0x56cc1d[_0x4b8e83(0x1a3)](_0x56cc1d['getDate']()-0x1),_0x49c0c1=new Date(_0x56cc1d),_0x49c0c1[_0x4b8e83(0x167)](0x0,0x0,0x0,0x0),_0x1a7bfd=new Date(_0x56cc1d),_0x1a7bfd[_0x4b8e83(0x167)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x49c0c1=new Date(_0x2792ef[_0x4b8e83(0x1d2)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x4b8e83(0x171):_0x49c0c1=new Date(_0x2792ef[_0x4b8e83(0x1d2)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x4b8e83(0x138):_0x49c0c1=new Date(_0x2792ef[_0x4b8e83(0x1d2)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x49c0c1=new Date(_0x2792ef[_0x4b8e83(0x1d2)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x28f38d={'gte':_0x49c0c1};_0x1a7bfd&&(_0x28f38d[_0x4b8e83(0x1d5)]=_0x1a7bfd);const [_0x384776,_0x18fa9c,_0xf3e17c,_0x3562a2,_0x560680]=await Promise['all']([database_1[_0x4b8e83(0x12b)][_0x4b8e83(0x16f)][_0x4b8e83(0x170)]({'where':{'shopId':_0x59ad26,'gateway':{'not':_0x4b8e83(0x153)},'createdAt':_0x28f38d}}),database_1[_0x4b8e83(0x12b)][_0x4b8e83(0x16f)][_0x4b8e83(0x170)]({'where':{'shopId':_0x59ad26,'gateway':{'not':_0x4b8e83(0x153)},'status':_0x4b8e83(0x198),'createdAt':_0x28f38d}}),database_1[_0x4b8e83(0x12b)][_0x4b8e83(0x16f)][_0x4b8e83(0x1ad)]({'where':{'shopId':_0x59ad26,'gateway':{'not':_0x4b8e83(0x153)},'status':_0x4b8e83(0x198),'createdAt':_0x28f38d},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default']['payment']['findMany']({'where':{'shopId':_0x59ad26,'gateway':{'not':_0x4b8e83(0x153)}},'take':0xa,'orderBy':{'createdAt':_0x4b8e83(0x177)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x4b8e83(0x12b)]['payment'][_0x4b8e83(0x1ad)]({'where':{'shopId':_0x59ad26,'gateway':{'not':_0x4b8e83(0x153)},'createdAt':_0x28f38d},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x4b8e83(0x1bd)}})]);let _0x3d40c2=0x0;for(const _0x30414e of _0xf3e17c){if(_0x30414e[_0x4b8e83(0x147)])_0x3d40c2+=_0x30414e['amountUSDT'];else{const _0x19207c=await currencyService_1[_0x4b8e83(0x1a6)][_0x4b8e83(0x169)](_0x30414e[_0x4b8e83(0x14d)],_0x30414e['currency']);_0x3d40c2+=_0x19207c;}}const _0x336e96=this['generateDailyStatistics'](_0x560680,_0x49c0c1,_0x1a7bfd||_0x2792ef),_0x20ab10=_0x384776>0x0?_0x18fa9c/_0x384776*0x64:0x0;return{'totalPayments':_0x384776,'successfulPayments':_0x18fa9c,'totalRevenue':Math[_0x4b8e83(0x15c)](_0x3d40c2*0x64)/0x64,'conversionRate':Math[_0x4b8e83(0x15c)](_0x20ab10*0x64)/0x64,'dailyRevenue':_0x336e96['dailyRevenue'],'dailyPayments':_0x336e96['dailyPayments'],'recentPayments':_0x3562a2['map'](_0x1f0d00=>({'id':_0x1f0d00['id'],'gateway':_0x1f0d00[_0x4b8e83(0x1aa)],'amount':_0x1f0d00[_0x4b8e83(0x14d)],'currency':_0x1f0d00[_0x4b8e83(0x1a4)],'status':_0x1f0d00[_0x4b8e83(0x1da)],'createdAt':_0x1f0d00[_0x4b8e83(0x1c8)]}))};}[a58_0xf7bb2(0x166)](_0x3d286f,_0x47d826,_0x3947c3){const _0x52b2ba=a58_0xf7bb2,_0x25a499=new Map(),_0x180b6e=new Date(_0x47d826);while(_0x180b6e<=_0x3947c3){const _0x33f33f=_0x180b6e[_0x52b2ba(0x1a1)]()[_0x52b2ba(0x15a)]('T')[0x0];_0x25a499[_0x52b2ba(0x19b)](_0x33f33f,{'revenue':0x0,'count':0x0}),_0x180b6e[_0x52b2ba(0x1a3)](_0x180b6e[_0x52b2ba(0x1bb)]()+0x1);}for(const _0x598738 of _0x3d286f){const _0x5e9001=_0x598738[_0x52b2ba(0x1c8)]['toISOString']()[_0x52b2ba(0x15a)]('T')[0x0],_0x442010=_0x25a499[_0x52b2ba(0x1ab)](_0x5e9001);_0x442010&&(_0x442010[_0x52b2ba(0x170)]+=0x1,_0x598738[_0x52b2ba(0x1da)]===_0x52b2ba(0x198)&&_0x598738[_0x52b2ba(0x147)]&&(_0x442010['revenue']+=_0x598738['amountUSDT']));}const _0x43233e=[],_0x9365fc=[];for(const [_0x72d236,_0x2ff31a]of _0x25a499){_0x43233e['push']({'date':_0x72d236,'amount':Math[_0x52b2ba(0x15c)](_0x2ff31a[_0x52b2ba(0x1b9)]*0x64)/0x64}),_0x9365fc[_0x52b2ba(0x18b)]({'date':_0x72d236,'count':_0x2ff31a[_0x52b2ba(0x170)]});}return{'dailyRevenue':_0x43233e,'dailyPayments':_0x9365fc};}}function a58_0x4695(){const _0x26bbd5=['getPaymentByShopAndId','getPayments','webhookEvents','revenue','\x20USDT\x20(total\x20payouts)','getDate','📊\x20Final\x20WHERE\x20conditions:','asc','getShopProfile','maxPayments','test_payment_123','sourceCurrency','📅\x20Period\x20start:\x20','777258EnTsRQ','amountIsEditable','telegram','\x20payout\x20statistics\x20calculated:','map','createdAt','paymentId','CoinToPay','Shop\x20not\x20found','Failed\x20to\x20send\x20webhook:\x20','deletePayment','trc20','Payment\x20not\x20found','language','No\x20webhook\x20URL\x20configured','getTime','\x20\x20\x20📅\x20This\x20month:\x20','aggregate','lte','789980yBYsSQ','COMPLETED','./currencyService','reduce','status','\x20\x20\x20⏳\x20Awaiting\x20payout:\x20','REJECTED','getPayoutStatistics','paymentService','../config/database','default','customer','payout','createPayment','📅\x20Date\x20start:\x20','formatNetworkName','error','📊\x20Status\x20filter:\x20','update','customerEmail','settings','telegramId','toUpperCase','90d','Plisio','thisMonth','487806OofTsp','test_order_123','erc20','77kLzQcg','\x20\x20\x20💰\x20Total\x20paid\x20out:\x20','usdcPolygonWallet','KLYME\x20DE','getPayoutStats','\x20USDT\x20(current\x20balance)','redirectUrl','polygon','🌐\x20Network\x20filter:\x20','amountUSDT','network','\x20\x20\x20💵\x20Available\x20balance:\x20','updateShopProfile','USDC\x20Polygon','PENDING','amount','paymentGateways','getWebhookLogs','getShopPayoutStats','parse','totalPaidOut','test_gateway','getPaymentById','log','gte','getPayoutById','📅\x20Period\x20end:\x20','ShopService','split','webhookUrl','round','name','merchantUrl','paidAt','day','stringify','createPublicPayment','299551VedOHC','defineProperty','gateways','generateDailyStatistics','setHours','awaitingPayout','convertToUSDT','statusText','event','shopUrl','getPaymentsByShop','customerName','payment','count','30d','getMonth','notes','periodFrom','all','getGatewayDisplayName','desc','usdtTrcWallet','Rapyd','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','isArray','USD','polygon_usdc','2paWCyI','KLYME\x20GB','publicKey','wallets','usage','Error\x20parsing\x20webhook\x20events:','🌐\x20Method\x20filter:\x20','Noda','getFullYear','shop','usdtErcWallet','testWebhook','findFirst','push','POST','246664HGotmc','💰\x20Getting\x20payouts\x20with\x20filters:','USDT\x20Polygon','txid','findUnique','ceil','46588mUkmEJ','PaymentService','Test\x20webhook\x20sent\x20successfully\x20(','webhookLog','filter','PAID','Webhook\x20returned\x20error:\x20','updatePayment','set','username','updateWallets','shopId','_sum','getPayouts','toISOString','./paymentService','setDate','currency','test','currencyService','gatewaySettings','YESTERDAY','TesSoft\x20Payment\x20System/1.0\x20(Test)','gateway','get','1143594yDsibF','findMany','KLYME\x20EU','yesterday','USDT\x20BSC','USDT\x20TRC20','expiresAt','__importDefault','balance','usdtPolygonWallet'];a58_0x4695=function(){return _0x26bbd5;};return a58_0x4695();}exports[a58_0xf7bb2(0x159)]=ShopService;