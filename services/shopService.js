'use strict';const a58_0x42afd0=a58_0x2604;(function(_0x3266a2,_0x10c72e){const _0x5ec117=a58_0x2604,_0xd5e2bc=_0x3266a2();while(!![]){try{const _0x47814c=parseInt(_0x5ec117(0x13d))/0x1+parseInt(_0x5ec117(0x109))/0x2*(parseInt(_0x5ec117(0x15a))/0x3)+parseInt(_0x5ec117(0xda))/0x4+-parseInt(_0x5ec117(0x12b))/0x5*(parseInt(_0x5ec117(0x160))/0x6)+-parseInt(_0x5ec117(0xdf))/0x7*(parseInt(_0x5ec117(0x126))/0x8)+parseInt(_0x5ec117(0x10f))/0x9*(-parseInt(_0x5ec117(0x102))/0xa)+parseInt(_0x5ec117(0x166))/0xb*(parseInt(_0x5ec117(0x175))/0xc);if(_0x47814c===_0x10c72e)break;else _0xd5e2bc['push'](_0xd5e2bc['shift']());}catch(_0x5a9a64){_0xd5e2bc['push'](_0xd5e2bc['shift']());}}}(a58_0x40c2,0x38ff2));function a58_0x2604(_0x5c258f,_0x24c901){const _0x40c277=a58_0x40c2();return a58_0x2604=function(_0x26042a,_0x498682){_0x26042a=_0x26042a-0xd4;let _0x505d55=_0x40c277[_0x26042a];return _0x505d55;},a58_0x2604(_0x5c258f,_0x24c901);}var __importDefault=this&&this[a58_0x42afd0(0x169)]||function(_0x45630b){const _0x548ed9=a58_0x42afd0;return _0x45630b&&_0x45630b[_0x548ed9(0x111)]?_0x45630b:{'default':_0x45630b};};Object[a58_0x42afd0(0x117)](exports,a58_0x42afd0(0x111),{'value':!![]}),exports[a58_0x42afd0(0x104)]=void 0x0;const database_1=__importDefault(require(a58_0x42afd0(0x159))),currencyService_1=require('./currencyService'),paymentService_1=require('./paymentService');function a58_0x40c2(){const _0x5edf1f=['\x20USDT\x20(total\x20payouts)','telegram','findMany','Shop\x20not\x20found','test_order_123','Error\x20parsing\x20webhook\x20events:','username','asc','statusText','\x20USDT\x20(current\x20balance)','redirectUrl','PaymentService','test_payment_123','üåê\x20Method\x20filter:\x20','txid','90d','status','reduce','telegramId','webhookUrl','10QdAwZo','lte','ShopService','üìÖ\x20Period\x20start:\x20','revenue','polygon','country','2Clyfev','TesSoft\x20Payment\x20System/1.0\x20(Test)','createdAt','USD','test','üåê\x20Network\x20filter:\x20','2957463UwpZts','üìÖ\x20Date\x20start:\x20','__esModule','getMonth','update','usdtTrcWallet','üìä\x20Status\x20filter:\x20','amountUSDT','defineProperty','usdtPolygonWallet','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','payout','toISOString','Failed\x20to\x20send\x20webhook:\x20','paymentService','thisMonth','retryCount','map','updateWallets','getPaymentByShopAndId','30d','USDT\x20TRC20','currency','8UaJROX','usdtErcWallet','KLYME\x20DE','Noda','stringify','26420iRnOQZ','availableBalance','USDC\x20Polygon','webhookLog','Webhook\x20returned\x20error:\x20','desc','getPayoutStatistics','setHours','amountIsEditable','log','üìÖ\x20Date\x20end:\x20','findUnique','usdcPolygonWallet','PAID','network','testWebhook','updateShopProfile','Test\x20Gateway','404941eKfhua','shopId','getTime','periodFrom','setDate','formatNetworkName','filter','toUpperCase','üí∞\x20Getting\x20payouts\x20with\x20filters:','gatewaySettings','üìÖ\x20Period\x20end:\x20','getPayouts','wallets','notes','split','settings','getShopPayoutStats','getFullYear','COMPLETED','statusCode','USDT\x20ERC20','\x20\x20\x20üíµ\x20Available\x20balance:\x20','set','dailyPayments','delete','polygon_usdc','getStatistics','merchantUrl','../config/database','757032bKoCfb','totalPaidOut','trc20','count','periodTo','paymentGateways','462XDfXrW','round','name','getDate','amount','gte','406109GZAMto','\x20USDT','generateDailyStatistics','__importDefault','üìä\x20Shop\x20','getWebhookLogs','responseBody','customer','sourceCurrency','dailyRevenue','PENDING','getPaymentById','all','expiresAt','findFirst','96SmJcAZ','üìä\x20Final\x20WHERE\x20conditions:','shop','\x20\x20\x20üìÖ\x20This\x20month:\x20','deletePayment','...','get','ceil','Test\x20webhook\x20sent\x20successfully\x20(','customerName','getPayoutStats','usage','webhookEvents','createPayment','Rapyd','POST','gateways','parse','347476sZicLV','test_gateway','publicKey','application/json','\x20payout\x20statistics\x20calculated:','494011LLecSN','getGatewayDisplayName','paymentId','isArray','gateway','Payment\x20not\x20found','message','default','payment','paidAt','_sum','createPublicPayment','balance','event','shopUrl'];a58_0x40c2=function(){return _0x5edf1f;};return a58_0x40c2();}class ShopService{constructor(){const _0x3cd513=a58_0x42afd0;this[_0x3cd513(0x11d)]=new paymentService_1[(_0x3cd513(0xf9))]();}async['getShopProfile'](_0x497eb7){const _0x39e708=a58_0x42afd0,_0x380eed=await database_1[_0x39e708(0xe6)][_0x39e708(0x177)][_0x39e708(0x136)]({'where':{'id':_0x497eb7},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x380eed)throw new Error('Shop\x20not\x20found');let _0xf67512=[];if(_0x380eed[_0x39e708(0x14c)]?.[_0x39e708(0xd4)])try{_0xf67512=Array[_0x39e708(0xe2)](_0x380eed[_0x39e708(0x14c)]['webhookEvents'])?_0x380eed[_0x39e708(0x14c)][_0x39e708(0xd4)]:JSON[_0x39e708(0xd9)](_0x380eed['settings'][_0x39e708(0xd4)]);}catch(_0xb539dc){console['error'](_0x39e708(0xf3),_0xb539dc),_0xf67512=[];}return{'id':_0x380eed['id'],'fullName':_0x380eed[_0x39e708(0x162)],'username':_0x380eed[_0x39e708(0xf4)],'telegramId':_0x380eed['telegram'],'merchantUrl':_0x380eed['shopUrl'],'gateways':_0x380eed[_0x39e708(0x15f)]?JSON[_0x39e708(0xd9)](_0x380eed[_0x39e708(0x15f)]):null,'gatewaySettings':_0x380eed[_0x39e708(0x146)]?JSON[_0x39e708(0xd9)](_0x380eed[_0x39e708(0x146)]):null,'publicKey':_0x380eed['publicKey'],'webhookUrl':_0x380eed['settings']?.[_0x39e708(0x101)]||null,'webhookEvents':_0xf67512,'wallets':{'usdtPolygonWallet':_0x380eed[_0x39e708(0x118)],'usdtTrcWallet':_0x380eed[_0x39e708(0x114)],'usdtErcWallet':_0x380eed[_0x39e708(0x127)],'usdcPolygonWallet':_0x380eed[_0x39e708(0x137)]},'status':_0x380eed[_0x39e708(0xfe)],'createdAt':_0x380eed['createdAt']};}async[a58_0x42afd0(0x13b)](_0x2ab521,_0x31caee){const _0x19db84=a58_0x42afd0,_0x43da37={};_0x31caee['fullName']&&(_0x43da37[_0x19db84(0x162)]=_0x31caee['fullName']);_0x31caee[_0x19db84(0x100)]!==undefined&&(_0x43da37['telegram']=_0x31caee['telegramId']||null);_0x31caee[_0x19db84(0x158)]&&(_0x43da37[_0x19db84(0xed)]=_0x31caee[_0x19db84(0x158)]);_0x31caee[_0x19db84(0xd8)]&&(_0x43da37[_0x19db84(0x15f)]=JSON[_0x19db84(0x12a)](_0x31caee[_0x19db84(0xd8)]));_0x31caee[_0x19db84(0x146)]&&(_0x43da37[_0x19db84(0x146)]=JSON[_0x19db84(0x12a)](_0x31caee[_0x19db84(0x146)]));_0x31caee[_0x19db84(0x149)]&&(_0x31caee[_0x19db84(0x149)][_0x19db84(0x118)]!==undefined&&(_0x43da37[_0x19db84(0x118)]=_0x31caee[_0x19db84(0x149)][_0x19db84(0x118)]||null),_0x31caee[_0x19db84(0x149)][_0x19db84(0x114)]!==undefined&&(_0x43da37[_0x19db84(0x114)]=_0x31caee[_0x19db84(0x149)][_0x19db84(0x114)]||null),_0x31caee[_0x19db84(0x149)]['usdtErcWallet']!==undefined&&(_0x43da37['usdtErcWallet']=_0x31caee[_0x19db84(0x149)][_0x19db84(0x127)]||null),_0x31caee[_0x19db84(0x149)]['usdcPolygonWallet']!==undefined&&(_0x43da37['usdcPolygonWallet']=_0x31caee['wallets'][_0x19db84(0x137)]||null));const _0x3b12d7=await database_1[_0x19db84(0xe6)][_0x19db84(0x177)]['update']({'where':{'id':_0x2ab521},'data':_0x43da37,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x2eb3a1=[];if(_0x3b12d7[_0x19db84(0x14c)]?.[_0x19db84(0xd4)])try{_0x2eb3a1=Array['isArray'](_0x3b12d7['settings']['webhookEvents'])?_0x3b12d7[_0x19db84(0x14c)][_0x19db84(0xd4)]:JSON[_0x19db84(0xd9)](_0x3b12d7[_0x19db84(0x14c)][_0x19db84(0xd4)]);}catch(_0x11aabe){console['error'](_0x19db84(0xf3),_0x11aabe),_0x2eb3a1=[];}return{'id':_0x3b12d7['id'],'fullName':_0x3b12d7['name'],'username':_0x3b12d7[_0x19db84(0xf4)],'telegramId':_0x3b12d7[_0x19db84(0xef)],'merchantUrl':_0x3b12d7[_0x19db84(0xed)],'gateways':_0x3b12d7[_0x19db84(0x15f)]?JSON[_0x19db84(0xd9)](_0x3b12d7[_0x19db84(0x15f)]):null,'gatewaySettings':_0x3b12d7[_0x19db84(0x146)]?JSON[_0x19db84(0xd9)](_0x3b12d7['gatewaySettings']):null,'publicKey':_0x3b12d7[_0x19db84(0xdc)],'webhookUrl':_0x3b12d7[_0x19db84(0x14c)]?.[_0x19db84(0x101)]||null,'webhookEvents':_0x2eb3a1,'wallets':{'usdtPolygonWallet':_0x3b12d7[_0x19db84(0x118)],'usdtTrcWallet':_0x3b12d7[_0x19db84(0x114)],'usdtErcWallet':_0x3b12d7[_0x19db84(0x127)],'usdcPolygonWallet':_0x3b12d7[_0x19db84(0x137)]},'status':_0x3b12d7['status'],'createdAt':_0x3b12d7['createdAt']};}async[a58_0x42afd0(0x121)](_0x11d203,_0x4e4f2f){const _0x5c91d1=a58_0x42afd0,_0x54cd7f={};_0x4e4f2f[_0x5c91d1(0x118)]!==undefined&&(_0x54cd7f['usdtPolygonWallet']=_0x4e4f2f[_0x5c91d1(0x118)]||null),_0x4e4f2f['usdtTrcWallet']!==undefined&&(_0x54cd7f[_0x5c91d1(0x114)]=_0x4e4f2f[_0x5c91d1(0x114)]||null),_0x4e4f2f[_0x5c91d1(0x127)]!==undefined&&(_0x54cd7f[_0x5c91d1(0x127)]=_0x4e4f2f['usdtErcWallet']||null),_0x4e4f2f[_0x5c91d1(0x137)]!==undefined&&(_0x54cd7f[_0x5c91d1(0x137)]=_0x4e4f2f[_0x5c91d1(0x137)]||null),await database_1[_0x5c91d1(0xe6)][_0x5c91d1(0x177)][_0x5c91d1(0x113)]({'where':{'id':_0x11d203},'data':_0x54cd7f});}async[a58_0x42afd0(0x13a)](_0x26653d){const _0x231bde=a58_0x42afd0,_0x1be497=await database_1['default']['shop']['findUnique']({'where':{'id':_0x26653d},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x1be497?.['settings']?.['webhookUrl'])throw new Error('No\x20webhook\x20URL\x20configured');const _0x9ec644={'event':_0x231bde(0x10d),'payment':{'id':_0x231bde(0xfa),'order_id':_0x231bde(0xf2),'gateway':_0x231bde(0x10d),'amount':0x64,'currency':_0x231bde(0x10c),'status':'paid','created_at':new Date()[_0x231bde(0x11b)]()}};try{const _0xed5436=await fetch(_0x1be497[_0x231bde(0x14c)][_0x231bde(0x101)],{'method':_0x231bde(0xd7),'headers':{'Content-Type':_0x231bde(0xdd),'User-Agent':_0x231bde(0x10a)},'body':JSON[_0x231bde(0x12a)](_0x9ec644)});return _0xed5436['ok']?{'success':!![],'message':_0x231bde(0x17d)+_0xed5436['status']+')'}:{'success':![],'message':_0x231bde(0x12f)+_0xed5436[_0x231bde(0xfe)]+'\x20'+_0xed5436[_0x231bde(0xf6)]};}catch(_0x155ebc){return{'success':![],'message':_0x231bde(0x11c)+(_0x155ebc instanceof Error?_0x155ebc[_0x231bde(0xe5)]:'Unknown\x20error')};}}async[a58_0x42afd0(0xd5)](_0x29a7f7){const _0x26838f=a58_0x42afd0;return this[_0x26838f(0x11d)][_0x26838f(0xea)]({'public_key':'','gateway':_0x29a7f7[_0x26838f(0xe3)],'order_id':undefined,'amount':_0x29a7f7[_0x26838f(0x164)],'currency':_0x29a7f7[_0x26838f(0x125)],'source_currency':_0x29a7f7[_0x26838f(0x16e)],'usage':_0x29a7f7[_0x26838f(0x180)],'expires_at':_0x29a7f7[_0x26838f(0x173)]?.[_0x26838f(0x11b)](),'success_url':_0x29a7f7[_0x26838f(0xf8)],'fail_url':_0x29a7f7[_0x26838f(0xf8)],'customer_email':_0x29a7f7['customerEmail'],'customer_name':_0x29a7f7[_0x26838f(0x17e)],'country':_0x29a7f7[_0x26838f(0x108)],'language':_0x29a7f7['language'],'amount_is_editable':_0x29a7f7[_0x26838f(0x133)],'max_payments':_0x29a7f7['maxPayments'],'customer':_0x29a7f7[_0x26838f(0x16d)]});}async['getPayments'](_0xeaa1d8,_0x1eeb5b){const _0x301830=a58_0x42afd0;return this[_0x301830(0x11d)]['getPaymentsByShop'](_0xeaa1d8,_0x1eeb5b);}async[a58_0x42afd0(0x171)](_0x283c23,_0x172c78){const _0x5c5341=a58_0x42afd0;return this[_0x5c5341(0x11d)][_0x5c5341(0x122)](_0x283c23,_0x172c78);}async['updatePayment'](_0x1e3443,_0x7a1b0,_0x52674d){const _0x53284e=a58_0x42afd0,_0x29e1f7=await database_1['default']['payment'][_0x53284e(0x174)]({'where':{'id':_0x7a1b0,'shopId':_0x1e3443}});if(!_0x29e1f7)throw new Error(_0x53284e(0xe4));const _0xacb1d1=await database_1['default'][_0x53284e(0xe7)][_0x53284e(0x113)]({'where':{'id':_0x7a1b0},'data':{..._0x52674d,'updatedAt':new Date()}});return _0xacb1d1;}async[a58_0x42afd0(0x179)](_0x34c401,_0x17c64c){const _0x382a92=a58_0x42afd0,_0x58f270=await database_1[_0x382a92(0xe6)]['payment'][_0x382a92(0x174)]({'where':{'id':_0x17c64c,'shopId':_0x34c401}});if(!_0x58f270)throw new Error(_0x382a92(0xe4));await database_1[_0x382a92(0xe6)][_0x382a92(0xe7)][_0x382a92(0x155)]({'where':{'id':_0x17c64c}});}['formatNetworkName'](_0x337376){const _0x9cbdd3=a58_0x42afd0,_0x1656fc={'polygon':'USDT\x20Polygon','trc20':_0x9cbdd3(0x124),'erc20':_0x9cbdd3(0x151),'bsc':'USDT\x20BSC','polygon_usdc':_0x9cbdd3(0x12d)};return _0x1656fc[_0x337376]||_0x337376;}async[a58_0x42afd0(0x148)](_0x8429ec,_0x1a68e4){const _0x56280d=a58_0x42afd0,{page:_0x4a0607,limit:_0x17a26c,status:_0x353367,method:_0x17fb3a,network:_0x366421,dateFrom:_0x4bd3a6,dateTo:_0x3a37ab,periodFrom:_0x5777a8,periodTo:_0x115def}=_0x1a68e4,_0x312d6d=(_0x4a0607-0x1)*_0x17a26c;console[_0x56280d(0x134)](_0x56280d(0x145),_0x1a68e4);const _0x3702fd={'shopId':_0x8429ec};_0x353367&&(_0x3702fd[_0x56280d(0xfe)]=_0x353367[_0x56280d(0x144)](),console[_0x56280d(0x134)](_0x56280d(0x115)+_0x353367[_0x56280d(0x144)]()));if(_0x17fb3a)_0x3702fd[_0x56280d(0x139)]=_0x17fb3a,console[_0x56280d(0x134)](_0x56280d(0xfb)+_0x17fb3a);else _0x366421&&(_0x3702fd[_0x56280d(0x139)]=_0x366421,console[_0x56280d(0x134)](_0x56280d(0x10e)+_0x366421));if(_0x4bd3a6||_0x3a37ab||_0x5777a8||_0x115def){_0x3702fd[_0x56280d(0x10b)]={};if(_0x5777a8){const _0x15b44a=new Date(_0x5777a8);_0x15b44a[_0x56280d(0x132)](0x0,0x0,0x0,0x0),_0x3702fd[_0x56280d(0x10b)]['gte']=_0x15b44a,console[_0x56280d(0x134)](_0x56280d(0x105)+_0x15b44a[_0x56280d(0x11b)]());}else{if(_0x4bd3a6){const _0x1e239b=new Date(_0x4bd3a6);_0x1e239b[_0x56280d(0x132)](0x0,0x0,0x0,0x0),_0x3702fd[_0x56280d(0x10b)][_0x56280d(0x165)]=_0x1e239b,console[_0x56280d(0x134)](_0x56280d(0x110)+_0x1e239b['toISOString']());}}if(_0x115def){const _0x5eb8f6=new Date(_0x115def);_0x5eb8f6[_0x56280d(0x132)](0x17,0x3b,0x3b,0x3e7),_0x3702fd[_0x56280d(0x10b)][_0x56280d(0x103)]=_0x5eb8f6,console['log'](_0x56280d(0x147)+_0x5eb8f6[_0x56280d(0x11b)]());}else{if(_0x3a37ab){const _0x186879=new Date(_0x3a37ab);_0x186879['setHours'](0x17,0x3b,0x3b,0x3e7),_0x3702fd['createdAt']['lte']=_0x186879,console[_0x56280d(0x134)](_0x56280d(0x135)+_0x186879[_0x56280d(0x11b)]());}}}console[_0x56280d(0x134)](_0x56280d(0x176),JSON['stringify'](_0x3702fd,null,0x2));const [_0x42703e,_0x160a42]=await Promise[_0x56280d(0x172)]([database_1['default']['payout'][_0x56280d(0xf0)]({'where':_0x3702fd,'skip':_0x312d6d,'take':_0x17a26c,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x56280d(0xe6)][_0x56280d(0x11a)]['count']({'where':_0x3702fd})]);return{'payouts':_0x42703e[_0x56280d(0x120)](_0x4243ca=>{const _0x577fac=_0x56280d;let _0x1d4bc8=null;switch(_0x4243ca[_0x577fac(0x139)]){case _0x577fac(0x107):_0x1d4bc8=_0x4243ca[_0x577fac(0x177)][_0x577fac(0x118)];break;case _0x577fac(0x15c):_0x1d4bc8=_0x4243ca['shop']['usdtTrcWallet'];break;case'erc20':_0x1d4bc8=_0x4243ca[_0x577fac(0x177)][_0x577fac(0x127)];break;case _0x577fac(0x156):_0x1d4bc8=_0x4243ca[_0x577fac(0x177)][_0x577fac(0x137)];break;}return{'id':_0x4243ca['id'],'amount':_0x4243ca[_0x577fac(0x164)],'network':this[_0x577fac(0x142)](_0x4243ca[_0x577fac(0x139)]),'wallet':_0x1d4bc8,'status':_0x4243ca[_0x577fac(0xfe)],'txid':_0x4243ca[_0x577fac(0xfc)],'notes':_0x4243ca[_0x577fac(0x14a)],'periodFrom':_0x4243ca[_0x577fac(0x140)],'periodTo':_0x4243ca[_0x577fac(0x15e)],'createdAt':_0x4243ca[_0x577fac(0x10b)],'paidAt':_0x4243ca[_0x577fac(0xe8)]};}),'pagination':{'page':_0x4a0607,'limit':_0x17a26c,'total':_0x160a42,'totalPages':Math[_0x56280d(0x17c)](_0x160a42/_0x17a26c)}};}async['getPayoutById'](_0x822af7,_0x5a2296){const _0x1b4351=a58_0x42afd0,_0x15f3f8=await database_1[_0x1b4351(0xe6)]['payout']['findFirst']({'where':{'id':_0x5a2296,'shopId':_0x822af7}});if(!_0x15f3f8)return null;return{'id':_0x15f3f8['id'],'amount':_0x15f3f8[_0x1b4351(0x164)],'network':_0x15f3f8[_0x1b4351(0x139)],'status':_0x15f3f8[_0x1b4351(0xfe)],'txid':_0x15f3f8[_0x1b4351(0xfc)],'notes':_0x15f3f8[_0x1b4351(0x14a)],'createdAt':_0x15f3f8[_0x1b4351(0x10b)],'paidAt':_0x15f3f8[_0x1b4351(0xe8)]};}async[a58_0x42afd0(0x131)](_0xf37615,_0x4f9091){const _0x39bb2f=a58_0x42afd0,_0x155070=new Date();let _0xae66a6;switch(_0x4f9091){case'7d':_0xae66a6=new Date(_0x155070[_0x39bb2f(0x13f)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x39bb2f(0x123):_0xae66a6=new Date(_0x155070[_0x39bb2f(0x13f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x39bb2f(0xfd):_0xae66a6=new Date(_0x155070[_0x39bb2f(0x13f)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xae66a6=new Date(_0x155070[_0x39bb2f(0x13f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x39249f,_0x190740,_0x207e42,_0x499cc2,_0x2ba74e,_0x54cba0]=await Promise[_0x39bb2f(0x172)]([database_1[_0x39bb2f(0xe6)][_0x39bb2f(0x11a)]['count']({'where':{'shopId':_0xf37615,'createdAt':{'gte':_0xae66a6}}}),database_1['default']['payout'][_0x39bb2f(0x15d)]({'where':{'shopId':_0xf37615,'status':_0x39bb2f(0x14f),'createdAt':{'gte':_0xae66a6}}}),database_1[_0x39bb2f(0xe6)][_0x39bb2f(0x11a)]['count']({'where':{'shopId':_0xf37615,'status':_0x39bb2f(0x170),'createdAt':{'gte':_0xae66a6}}}),database_1[_0x39bb2f(0xe6)][_0x39bb2f(0x11a)][_0x39bb2f(0x15d)]({'where':{'shopId':_0xf37615,'status':'REJECTED','createdAt':{'gte':_0xae66a6}}}),database_1[_0x39bb2f(0xe6)][_0x39bb2f(0x11a)][_0x39bb2f(0xf0)]({'where':{'shopId':_0xf37615,'createdAt':{'gte':_0xae66a6}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x39bb2f(0xe6)][_0x39bb2f(0x11a)]['findMany']({'where':{'shopId':_0xf37615},'take':0xa,'orderBy':{'createdAt':_0x39bb2f(0x130)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x4faf4e=_0x2ba74e['reduce']((_0x4b8b25,_0x5845e4)=>_0x4b8b25+_0x5845e4['amount'],0x0),_0x193320=_0x2ba74e[_0x39bb2f(0x143)](_0x3289bd=>_0x3289bd[_0x39bb2f(0xfe)]===_0x39bb2f(0x14f))[_0x39bb2f(0xff)]((_0x1aef02,_0x3dc06d)=>_0x1aef02+_0x3dc06d[_0x39bb2f(0x164)],0x0),_0xc4bca7=_0x2ba74e[_0x39bb2f(0x143)](_0x329b31=>_0x329b31[_0x39bb2f(0xfe)]===_0x39bb2f(0x170))['reduce']((_0x183934,_0x5b67f6)=>_0x183934+_0x5b67f6[_0x39bb2f(0x164)],0x0),_0xceb6aa=_0x2ba74e[_0x39bb2f(0xff)]((_0x369344,_0x5c53dd)=>{const _0x418cac=_0x39bb2f;return _0x369344[_0x5c53dd[_0x418cac(0x139)]]=(_0x369344[_0x5c53dd[_0x418cac(0x139)]]||0x0)+0x1,_0x369344;},{}),_0x1596c1=_0x2ba74e[_0x39bb2f(0xff)]((_0x487271,_0x442eb0)=>{const _0xe338a7=_0x39bb2f;return _0x487271[_0x442eb0['status']]=(_0x487271[_0x442eb0[_0xe338a7(0xfe)]]||0x0)+0x1,_0x487271;},{});return{'totalPayouts':_0x39249f,'completedPayouts':_0x190740,'pendingPayouts':_0x207e42,'rejectedPayouts':_0x499cc2,'totalAmount':_0x4faf4e,'completedAmount':_0x193320,'pendingAmount':_0xc4bca7,'payoutsByMethod':_0xceb6aa,'payoutsByStatus':_0x1596c1,'recentPayouts':_0x54cba0[_0x39bb2f(0x120)](_0x2c61f6=>({'id':_0x2c61f6['id'],'shopId':_0xf37615,'amount':_0x2c61f6[_0x39bb2f(0x164)],'method':_0x2c61f6[_0x39bb2f(0x139)],'status':_0x2c61f6[_0x39bb2f(0xfe)],'txid':_0x2c61f6['txid'],'createdAt':_0x2c61f6[_0x39bb2f(0x10b)],'paidAt':_0x2c61f6[_0x39bb2f(0xe8)]}))};}async['getShopPayoutStats'](_0x59cc3c){const _0x53cce3=a58_0x42afd0;console[_0x53cce3(0x134)](_0x53cce3(0x119)+_0x59cc3c+_0x53cce3(0x17a));const _0x5bb478=await database_1[_0x53cce3(0xe6)][_0x53cce3(0x177)][_0x53cce3(0x136)]({'where':{'id':_0x59cc3c},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x5bb478)throw new Error(_0x53cce3(0xf1));const _0x2b55a9=new Date(),_0x1a1bd9=new Date(_0x2b55a9[_0x53cce3(0x14e)](),_0x2b55a9[_0x53cce3(0x112)](),0x1),_0x512b08=new Date(_0x2b55a9['getFullYear'](),_0x2b55a9[_0x53cce3(0x112)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x136874=await database_1[_0x53cce3(0xe6)][_0x53cce3(0x11a)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x59cc3c,'createdAt':{'gte':_0x1a1bd9,'lte':_0x512b08},'status':'COMPLETED'}}),_0x17ac1c=_0x136874[_0x53cce3(0xe9)][_0x53cce3(0x164)]||0x0,_0x2761c7={'availableBalance':Math[_0x53cce3(0x161)](_0x5bb478[_0x53cce3(0xeb)]*0x64)/0x64,'totalPaidOut':Math[_0x53cce3(0x161)](_0x5bb478[_0x53cce3(0x15b)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x5bb478[_0x53cce3(0xeb)]*0x64)/0x64,'thisMonth':Math[_0x53cce3(0x161)](_0x17ac1c*0x64)/0x64};return console[_0x53cce3(0x134)](_0x53cce3(0x16a)+_0x5bb478[_0x53cce3(0xf4)]+_0x53cce3(0xde)),console[_0x53cce3(0x134)](_0x53cce3(0x152)+_0x2761c7[_0x53cce3(0x12c)]+'\x20USDT\x20(current\x20balance)'),console['log']('\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20'+_0x2761c7[_0x53cce3(0x15b)]+_0x53cce3(0xee)),console['log']('\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20'+_0x2761c7['awaitingPayout']+_0x53cce3(0xf7)),console[_0x53cce3(0x134)](_0x53cce3(0x178)+_0x2761c7[_0x53cce3(0x11e)]+_0x53cce3(0x167)),_0x2761c7;}[a58_0x42afd0(0xe0)](_0x46bd4f){const _0x29fbae=a58_0x42afd0,_0x3631d3={'test_gateway':_0x29fbae(0x13c),'plisio':'Plisio','rapyd':_0x29fbae(0xd6),'noda':_0x29fbae(0x129),'cointopay':'CoinToPay','klyme_eu':'KLYME\x20EU','klyme_gb':'KLYME\x20GB','klyme_de':_0x29fbae(0x128)};return _0x3631d3[_0x46bd4f]||_0x46bd4f;}async[a58_0x42afd0(0x17f)](_0x55027e){const _0x131105=a58_0x42afd0;return this[_0x131105(0x14d)](_0x55027e);}async[a58_0x42afd0(0x16b)](_0x42fd24,_0x2899de){const _0x431a31=a58_0x42afd0,{page:_0x32857f,limit:_0x3e2452,paymentId:_0x23e4a3}=_0x2899de,_0x1381bf=(_0x32857f-0x1)*_0x3e2452,_0x10ebd8={'shopId':_0x42fd24};_0x23e4a3&&(_0x10ebd8[_0x431a31(0xe1)]=_0x23e4a3);const [_0x1e8ddb,_0xef0c27]=await Promise[_0x431a31(0x172)]([database_1['default'][_0x431a31(0x12e)]['findMany']({'where':_0x10ebd8,'skip':_0x1381bf,'take':_0x3e2452,'orderBy':{'createdAt':'desc'},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x431a31(0xe6)][_0x431a31(0x12e)][_0x431a31(0x15d)]({'where':_0x10ebd8})]);return{'logs':_0x1e8ddb[_0x431a31(0x120)](_0x521915=>({'id':_0x521915['id'],'paymentId':_0x521915[_0x431a31(0xe1)],'shopId':_0x521915[_0x431a31(0x13e)],'event':_0x521915[_0x431a31(0xec)],'statusCode':_0x521915[_0x431a31(0x150)],'retryCount':_0x521915[_0x431a31(0x11f)],'responseBody':_0x521915[_0x431a31(0x16c)],'createdAt':_0x521915[_0x431a31(0x10b)],'payment':_0x521915[_0x431a31(0xe7)]})),'pagination':{'page':_0x32857f,'limit':_0x3e2452,'total':_0xef0c27,'totalPages':Math['ceil'](_0xef0c27/_0x3e2452)}};}async[a58_0x42afd0(0x157)](_0x1992a7,_0x2b66f4){const _0x5cb602=a58_0x42afd0,_0x5ae301=new Date();let _0x4fde99;switch(_0x2b66f4){case'7d':_0x4fde99=new Date(_0x5ae301[_0x5cb602(0x13f)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x5cb602(0x123):_0x4fde99=new Date(_0x5ae301[_0x5cb602(0x13f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x5cb602(0xfd):_0x4fde99=new Date(_0x5ae301[_0x5cb602(0x13f)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x4fde99=new Date(_0x5ae301[_0x5cb602(0x13f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0xa616bb,_0x517caf,_0x212cac,_0x101051,_0x48e860]=await Promise[_0x5cb602(0x172)]([database_1[_0x5cb602(0xe6)]['payment'][_0x5cb602(0x15d)]({'where':{'shopId':_0x1992a7,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x4fde99}}}),database_1[_0x5cb602(0xe6)]['payment'][_0x5cb602(0x15d)]({'where':{'shopId':_0x1992a7,'gateway':{'not':_0x5cb602(0xdb)},'status':_0x5cb602(0x138),'createdAt':{'gte':_0x4fde99}}}),database_1[_0x5cb602(0xe6)][_0x5cb602(0xe7)][_0x5cb602(0xf0)]({'where':{'shopId':_0x1992a7,'gateway':{'not':'test_gateway'},'status':_0x5cb602(0x138),'createdAt':{'gte':_0x4fde99}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default']['payment']['findMany']({'where':{'shopId':_0x1992a7,'gateway':{'not':_0x5cb602(0xdb)}},'take':0xa,'orderBy':{'createdAt':_0x5cb602(0x130)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x5cb602(0xe6)]['payment'][_0x5cb602(0xf0)]({'where':{'shopId':_0x1992a7,'gateway':{'not':_0x5cb602(0xdb)},'createdAt':{'gte':_0x4fde99}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x5cb602(0xf5)}})]);let _0x388911=0x0;for(const _0x55ce13 of _0x212cac){if(_0x55ce13[_0x5cb602(0x116)])_0x388911+=_0x55ce13[_0x5cb602(0x116)];else{const _0x2a8131=await currencyService_1['currencyService']['convertToUSDT'](_0x55ce13['amount'],_0x55ce13[_0x5cb602(0x125)]);_0x388911+=_0x2a8131;}}const _0xe65c20=this[_0x5cb602(0x168)](_0x48e860,_0x4fde99,_0x5ae301),_0x5300af=_0xa616bb>0x0?_0x517caf/_0xa616bb*0x64:0x0;return{'totalPayments':_0xa616bb,'successfulPayments':_0x517caf,'totalRevenue':Math[_0x5cb602(0x161)](_0x388911*0x64)/0x64,'conversionRate':Math['round'](_0x5300af*0x64)/0x64,'dailyRevenue':_0xe65c20[_0x5cb602(0x16f)],'dailyPayments':_0xe65c20[_0x5cb602(0x154)],'recentPayments':_0x101051[_0x5cb602(0x120)](_0x192774=>({'id':_0x192774['id'],'gateway':_0x192774[_0x5cb602(0xe3)],'amount':_0x192774['amount'],'currency':_0x192774['currency'],'status':_0x192774[_0x5cb602(0xfe)],'createdAt':_0x192774[_0x5cb602(0x10b)]}))};}[a58_0x42afd0(0x168)](_0x5b9909,_0x4de20f,_0x121507){const _0x2bcf8e=a58_0x42afd0,_0x591451=new Map(),_0x578bd2=new Date(_0x4de20f);while(_0x578bd2<=_0x121507){const _0x277d01=_0x578bd2[_0x2bcf8e(0x11b)]()[_0x2bcf8e(0x14b)]('T')[0x0];_0x591451[_0x2bcf8e(0x153)](_0x277d01,{'revenue':0x0,'count':0x0}),_0x578bd2[_0x2bcf8e(0x141)](_0x578bd2[_0x2bcf8e(0x163)]()+0x1);}for(const _0xae2e5e of _0x5b9909){const _0x8f8814=_0xae2e5e['createdAt'][_0x2bcf8e(0x11b)]()[_0x2bcf8e(0x14b)]('T')[0x0],_0x184728=_0x591451[_0x2bcf8e(0x17b)](_0x8f8814);_0x184728&&(_0x184728[_0x2bcf8e(0x15d)]+=0x1,_0xae2e5e[_0x2bcf8e(0xfe)]==='PAID'&&_0xae2e5e[_0x2bcf8e(0x116)]&&(_0x184728[_0x2bcf8e(0x106)]+=_0xae2e5e['amountUSDT']));}const _0x109219=[],_0x23afa4=[];for(const [_0x34bae9,_0x32c0ae]of _0x591451){_0x109219['push']({'date':_0x34bae9,'amount':Math[_0x2bcf8e(0x161)](_0x32c0ae[_0x2bcf8e(0x106)]*0x64)/0x64}),_0x23afa4['push']({'date':_0x34bae9,'count':_0x32c0ae['count']});}return{'dailyRevenue':_0x109219,'dailyPayments':_0x23afa4};}}exports[a58_0x42afd0(0x104)]=ShopService;