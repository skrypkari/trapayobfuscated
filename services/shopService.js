'use strict';const a65_0x5805a4=a65_0x5c8c;(function(_0x20e841,_0xf9faa7){const _0x125f01=a65_0x5c8c,_0x553b9c=_0x20e841();while(!![]){try{const _0x328cdd=-parseInt(_0x125f01(0xce))/0x1+parseInt(_0x125f01(0xfc))/0x2*(parseInt(_0x125f01(0x103))/0x3)+parseInt(_0x125f01(0xe1))/0x4*(parseInt(_0x125f01(0xf4))/0x5)+parseInt(_0x125f01(0x94))/0x6+parseInt(_0x125f01(0xd4))/0x7+parseInt(_0x125f01(0xb9))/0x8*(parseInt(_0x125f01(0x84))/0x9)+-parseInt(_0x125f01(0x7b))/0xa;if(_0x328cdd===_0xf9faa7)break;else _0x553b9c['push'](_0x553b9c['shift']());}catch(_0x41b608){_0x553b9c['push'](_0x553b9c['shift']());}}}(a65_0x52dd,0x99967));var __importDefault=this&&this[a65_0x5805a4(0x8a)]||function(_0x1eb9d8){const _0x577511=a65_0x5805a4;return _0x1eb9d8&&_0x1eb9d8[_0x577511(0xfe)]?_0x1eb9d8:{'default':_0x1eb9d8};};Object[a65_0x5805a4(0xd6)](exports,a65_0x5805a4(0xfe),{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require(a65_0x5805a4(0xde)),paymentService_1=require(a65_0x5805a4(0xa5));class ShopService{constructor(){this['paymentService']=new paymentService_1['PaymentService']();}async[a65_0x5805a4(0xec)](_0x52800b){const _0x31c73b=a65_0x5805a4,_0x584432=await database_1['default'][_0x31c73b(0x71)][_0x31c73b(0xb1)]({'where':{'id':_0x52800b},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x584432)throw new Error(_0x31c73b(0xb6));let _0x5e2607=[];if(_0x584432[_0x31c73b(0xb2)]?.[_0x31c73b(0xcb)])try{_0x5e2607=Array[_0x31c73b(0xe7)](_0x584432[_0x31c73b(0xb2)]['webhookEvents'])?_0x584432[_0x31c73b(0xb2)][_0x31c73b(0xcb)]:JSON['parse'](_0x584432[_0x31c73b(0xb2)][_0x31c73b(0xcb)]);}catch(_0x5f5a52){console[_0x31c73b(0x98)](_0x31c73b(0x81),_0x5f5a52),_0x5e2607=[];}return{'id':_0x584432['id'],'fullName':_0x584432[_0x31c73b(0xa2)],'username':_0x584432['username'],'telegramId':_0x584432[_0x31c73b(0x93)],'merchantUrl':_0x584432['shopUrl'],'gateways':_0x584432['paymentGateways']?JSON['parse'](_0x584432[_0x31c73b(0x109)]):null,'gatewaySettings':_0x584432[_0x31c73b(0x77)]?JSON['parse'](_0x584432['gatewaySettings']):null,'publicKey':_0x584432[_0x31c73b(0xac)],'webhookUrl':_0x584432[_0x31c73b(0xb2)]?.[_0x31c73b(0xc6)]||null,'webhookEvents':_0x5e2607,'wallets':{'usdtPolygonWallet':_0x584432[_0x31c73b(0x102)],'usdtTrcWallet':_0x584432[_0x31c73b(0xab)],'usdtErcWallet':_0x584432[_0x31c73b(0xdd)],'usdcPolygonWallet':_0x584432[_0x31c73b(0xc0)],'usdcErcWallet':_0x584432[_0x31c73b(0x100)]},'status':_0x584432[_0x31c73b(0xe4)],'createdAt':_0x584432[_0x31c73b(0x10e)]};}async[a65_0x5805a4(0xa4)](_0x4ed8c0,_0x34e4f0){const _0x4e6306=a65_0x5805a4,_0x68b8e2={};_0x34e4f0[_0x4e6306(0x89)]&&(_0x68b8e2[_0x4e6306(0xa2)]=_0x34e4f0[_0x4e6306(0x89)]);_0x34e4f0[_0x4e6306(0x97)]!==undefined&&(_0x68b8e2[_0x4e6306(0x93)]=_0x34e4f0[_0x4e6306(0x97)]||null);_0x34e4f0[_0x4e6306(0xbc)]&&(_0x68b8e2[_0x4e6306(0xee)]=_0x34e4f0[_0x4e6306(0xbc)]);_0x34e4f0[_0x4e6306(0x9e)]&&(_0x68b8e2[_0x4e6306(0x109)]=JSON[_0x4e6306(0x11c)](_0x34e4f0[_0x4e6306(0x9e)]));_0x34e4f0[_0x4e6306(0x77)]&&(_0x68b8e2[_0x4e6306(0x77)]=JSON['stringify'](_0x34e4f0[_0x4e6306(0x77)]));_0x34e4f0[_0x4e6306(0xb0)]&&(_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0x102)]!==undefined&&(_0x68b8e2[_0x4e6306(0x102)]=_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0x102)]||null),_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0xab)]!==undefined&&(_0x68b8e2['usdtTrcWallet']=_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0xab)]||null),_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0xdd)]!==undefined&&(_0x68b8e2[_0x4e6306(0xdd)]=_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0xdd)]||null),_0x34e4f0[_0x4e6306(0xb0)][_0x4e6306(0xc0)]!==undefined&&(_0x68b8e2[_0x4e6306(0xc0)]=_0x34e4f0['wallets'][_0x4e6306(0xc0)]||null));const _0x205438=await database_1['default'][_0x4e6306(0x71)][_0x4e6306(0xf0)]({'where':{'id':_0x4ed8c0},'data':_0x68b8e2,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x1120b8=[];if(_0x205438['settings']?.['webhookEvents'])try{_0x1120b8=Array['isArray'](_0x205438[_0x4e6306(0xb2)][_0x4e6306(0xcb)])?_0x205438[_0x4e6306(0xb2)]['webhookEvents']:JSON[_0x4e6306(0xa6)](_0x205438['settings'][_0x4e6306(0xcb)]);}catch(_0x2f39a1){console['error'](_0x4e6306(0x81),_0x2f39a1),_0x1120b8=[];}return{'id':_0x205438['id'],'fullName':_0x205438[_0x4e6306(0xa2)],'username':_0x205438[_0x4e6306(0x10c)],'telegramId':_0x205438[_0x4e6306(0x93)],'merchantUrl':_0x205438[_0x4e6306(0xee)],'gateways':_0x205438[_0x4e6306(0x109)]?JSON[_0x4e6306(0xa6)](_0x205438['paymentGateways']):null,'gatewaySettings':_0x205438[_0x4e6306(0x77)]?JSON['parse'](_0x205438[_0x4e6306(0x77)]):null,'publicKey':_0x205438['publicKey'],'webhookUrl':_0x205438[_0x4e6306(0xb2)]?.['webhookUrl']||null,'webhookEvents':_0x1120b8,'wallets':{'usdtPolygonWallet':_0x205438[_0x4e6306(0x102)],'usdtTrcWallet':_0x205438[_0x4e6306(0xab)],'usdtErcWallet':_0x205438['usdtErcWallet'],'usdcPolygonWallet':_0x205438[_0x4e6306(0xc0)],'usdcErcWallet':_0x205438['usdcErcWallet']},'status':_0x205438[_0x4e6306(0xe4)],'createdAt':_0x205438[_0x4e6306(0x10e)]};}async[a65_0x5805a4(0x96)](_0x13a1cb,_0x29744c){const _0x5eacf4=a65_0x5805a4,_0x405ab5={};_0x29744c['usdtPolygonWallet']!==undefined&&(_0x405ab5[_0x5eacf4(0x102)]=_0x29744c[_0x5eacf4(0x102)]||null),_0x29744c[_0x5eacf4(0xab)]!==undefined&&(_0x405ab5[_0x5eacf4(0xab)]=_0x29744c['usdtTrcWallet']||null),_0x29744c[_0x5eacf4(0xdd)]!==undefined&&(_0x405ab5[_0x5eacf4(0xdd)]=_0x29744c['usdtErcWallet']||null),_0x29744c[_0x5eacf4(0xc0)]!==undefined&&(_0x405ab5[_0x5eacf4(0xc0)]=_0x29744c['usdcPolygonWallet']||null),_0x29744c[_0x5eacf4(0x100)]!==undefined&&(_0x405ab5['usdcErcWallet']=_0x29744c[_0x5eacf4(0x100)]||null),await database_1[_0x5eacf4(0x116)][_0x5eacf4(0x71)][_0x5eacf4(0xf0)]({'where':{'id':_0x13a1cb},'data':_0x405ab5});}async[a65_0x5805a4(0xf9)](_0x4cd4d5){const _0x2722d4=a65_0x5805a4,_0x1f00d7=await database_1['default']['shop'][_0x2722d4(0xb1)]({'where':{'id':_0x4cd4d5},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x1f00d7?.[_0x2722d4(0xb2)]?.[_0x2722d4(0xc6)])throw new Error(_0x2722d4(0xd9));const _0x540b8a={'event':_0x2722d4(0xf2),'payment':{'id':'test_payment_123','order_id':'test_order_123','gateway':_0x2722d4(0xf2),'amount':0x64,'currency':_0x2722d4(0x11e),'status':_0x2722d4(0x7c),'created_at':new Date()[_0x2722d4(0xb5)]()}};try{const _0x5660af=await fetch(_0x1f00d7[_0x2722d4(0xb2)][_0x2722d4(0xc6)],{'method':'POST','headers':{'Content-Type':_0x2722d4(0xfb),'User-Agent':_0x2722d4(0x112)},'body':JSON[_0x2722d4(0x11c)](_0x540b8a)});return _0x5660af['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x5660af['status']+')'}:{'success':![],'message':_0x2722d4(0x8f)+_0x5660af['status']+'\x20'+_0x5660af[_0x2722d4(0xa0)]};}catch(_0x14758f){return{'success':![],'message':_0x2722d4(0xa8)+(_0x14758f instanceof Error?_0x14758f[_0x2722d4(0xe2)]:_0x2722d4(0xeb))};}}async['createPayment'](_0x25a19e){const _0xdf956b=a65_0x5805a4;return this['paymentService'][_0xdf956b(0xdb)]({'public_key':'','gateway':_0x25a19e['gateway'],'order_id':undefined,'amount':_0x25a19e[_0xdf956b(0x9a)],'currency':_0x25a19e[_0xdf956b(0x83)],'source_currency':_0x25a19e[_0xdf956b(0x82)],'usage':_0x25a19e[_0xdf956b(0x80)],'expires_at':_0x25a19e[_0xdf956b(0xea)]?.[_0xdf956b(0xb5)](),'success_url':_0x25a19e[_0xdf956b(0x70)],'fail_url':_0x25a19e['redirectUrl'],'customer_email':_0x25a19e[_0xdf956b(0x9c)],'customer_name':_0x25a19e[_0xdf956b(0xe9)],'country':_0x25a19e[_0xdf956b(0x87)],'language':_0x25a19e[_0xdf956b(0xc9)],'amount_is_editable':_0x25a19e[_0xdf956b(0xc3)],'max_payments':_0x25a19e[_0xdf956b(0x11a)],'customer':_0x25a19e[_0xdf956b(0xe3)]});}async['getPayments'](_0x30bfb5,_0x475d7e){const _0x353d05=a65_0x5805a4;return this[_0x353d05(0xcc)]['getPaymentsByShop'](_0x30bfb5,_0x475d7e);}async[a65_0x5805a4(0xb7)](_0x48edcf,_0x58d358){const _0x7dbaab=a65_0x5805a4;return this[_0x7dbaab(0xcc)][_0x7dbaab(0x9f)](_0x48edcf,_0x58d358);}async[a65_0x5805a4(0x7a)](_0x57b42c,_0x42e8d2,_0x3d8baa){const _0x387618=a65_0x5805a4,_0x11d30d=await database_1[_0x387618(0x116)][_0x387618(0x10d)][_0x387618(0x6d)]({'where':{'id':_0x42e8d2,'shopId':_0x57b42c}});if(!_0x11d30d)throw new Error('Payment\x20not\x20found');const _0x4dbbc3=await database_1['default'][_0x387618(0x10d)][_0x387618(0xf0)]({'where':{'id':_0x42e8d2},'data':{..._0x3d8baa,'updatedAt':new Date()}});return _0x4dbbc3;}async['deletePayment'](_0xa6cfc2,_0xb1f0a6){const _0x144259=a65_0x5805a4,_0x117054=await database_1[_0x144259(0x116)][_0x144259(0x10d)][_0x144259(0x6d)]({'where':{'id':_0xb1f0a6,'shopId':_0xa6cfc2}});if(!_0x117054)throw new Error(_0x144259(0x9d));await database_1[_0x144259(0x116)][_0x144259(0x10d)][_0x144259(0xf3)]({'where':{'id':_0xb1f0a6}});}[a65_0x5805a4(0x75)](_0x1b93bc){const _0x2beb00=a65_0x5805a4,_0x3c85a6={'polygon':'USDT\x20Polygon','trc20':_0x2beb00(0xbe),'erc20':'USDT\x20ERC20','bsc':_0x2beb00(0xbf),'polygon_usdc':_0x2beb00(0xe6),'erc20_usdc':_0x2beb00(0xa3)};return _0x3c85a6[_0x1b93bc]||_0x1b93bc;}async['getPayouts'](_0x494907,_0x532d70){const _0x1cdc58=a65_0x5805a4,{page:_0x45e442,limit:_0x35d7c7,status:_0x5154ff,method:_0x56153a,network:_0x49fe27,dateFrom:_0x443dc6,dateTo:_0x25a58a,periodFrom:_0x186386,periodTo:_0x46e3db}=_0x532d70,_0x539136=(_0x45e442-0x1)*_0x35d7c7;console[_0x1cdc58(0xf5)](_0x1cdc58(0xf7),_0x532d70);const _0x2ae5c6={'shopId':_0x494907};_0x5154ff&&(_0x2ae5c6['status']=_0x5154ff[_0x1cdc58(0xa1)](),console['log'](_0x1cdc58(0xd8)+_0x5154ff['toUpperCase']()));if(_0x56153a)_0x2ae5c6[_0x1cdc58(0x86)]=_0x56153a,console[_0x1cdc58(0xf5)](_0x1cdc58(0x11b)+_0x56153a);else _0x49fe27&&(_0x2ae5c6[_0x1cdc58(0x86)]=_0x49fe27,console[_0x1cdc58(0xf5)]('🌐\x20Network\x20filter:\x20'+_0x49fe27));if(_0x443dc6||_0x25a58a||_0x186386||_0x46e3db){_0x2ae5c6['createdAt']={};if(_0x186386){const _0x365d79=new Date(_0x186386);_0x365d79[_0x1cdc58(0x8b)](0x0,0x0,0x0,0x0),_0x2ae5c6['createdAt'][_0x1cdc58(0xe0)]=_0x365d79,console[_0x1cdc58(0xf5)]('📅\x20Period\x20start:\x20'+_0x365d79['toISOString']());}else{if(_0x443dc6){const _0x5b59f7=new Date(_0x443dc6);_0x5b59f7[_0x1cdc58(0x8b)](0x0,0x0,0x0,0x0),_0x2ae5c6['createdAt'][_0x1cdc58(0xe0)]=_0x5b59f7,console[_0x1cdc58(0xf5)]('📅\x20Date\x20start:\x20'+_0x5b59f7[_0x1cdc58(0xb5)]());}}if(_0x46e3db){const _0x3f9eef=new Date(_0x46e3db);_0x3f9eef[_0x1cdc58(0x8b)](0x17,0x3b,0x3b,0x3e7),_0x2ae5c6[_0x1cdc58(0x10e)][_0x1cdc58(0x8e)]=_0x3f9eef,console['log'](_0x1cdc58(0xff)+_0x3f9eef[_0x1cdc58(0xb5)]());}else{if(_0x25a58a){const _0x505d99=new Date(_0x25a58a);_0x505d99['setHours'](0x17,0x3b,0x3b,0x3e7),_0x2ae5c6['createdAt']['lte']=_0x505d99,console[_0x1cdc58(0xf5)](_0x1cdc58(0xdc)+_0x505d99[_0x1cdc58(0xb5)]());}}}console['log']('📊\x20Final\x20WHERE\x20conditions:',JSON['stringify'](_0x2ae5c6,null,0x2));const [_0x59afb7,_0x379ea1]=await Promise[_0x1cdc58(0x117)]([database_1[_0x1cdc58(0x116)][_0x1cdc58(0xad)][_0x1cdc58(0x10a)]({'where':_0x2ae5c6,'skip':_0x539136,'take':_0x35d7c7,'orderBy':{'createdAt':_0x1cdc58(0x106)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![]}}}}),database_1[_0x1cdc58(0x116)][_0x1cdc58(0xad)]['count']({'where':_0x2ae5c6})]);return{'payouts':_0x59afb7[_0x1cdc58(0xc7)](_0x34a5ad=>{const _0x26a323=_0x1cdc58;let _0x57b482=null;switch(_0x34a5ad[_0x26a323(0x86)]){case'polygon':_0x57b482=_0x34a5ad[_0x26a323(0x71)][_0x26a323(0x102)];break;case _0x26a323(0xd2):_0x57b482=_0x34a5ad[_0x26a323(0x71)][_0x26a323(0xab)];break;case _0x26a323(0xbd):_0x57b482=_0x34a5ad[_0x26a323(0x71)]['usdtErcWallet'];break;case _0x26a323(0x7e):_0x57b482=_0x34a5ad[_0x26a323(0x71)]['usdcPolygonWallet'];break;case _0x26a323(0xf1):_0x57b482=_0x34a5ad[_0x26a323(0x71)][_0x26a323(0x100)];break;}return{'id':_0x34a5ad['id'],'amount':_0x34a5ad[_0x26a323(0x9a)],'network':this[_0x26a323(0x75)](_0x34a5ad[_0x26a323(0x86)]),'wallet':_0x57b482,'status':_0x34a5ad['status'],'txid':_0x34a5ad['txid'],'notes':_0x34a5ad[_0x26a323(0xb8)],'periodFrom':_0x34a5ad[_0x26a323(0x118)],'periodTo':_0x34a5ad[_0x26a323(0xef)],'createdAt':_0x34a5ad[_0x26a323(0x10e)],'paidAt':_0x34a5ad[_0x26a323(0x111)]};}),'pagination':{'page':_0x45e442,'limit':_0x35d7c7,'total':_0x379ea1,'totalPages':Math[_0x1cdc58(0xda)](_0x379ea1/_0x35d7c7)}};}async[a65_0x5805a4(0x85)](_0x30090d,_0xba5ca){const _0x55981e=a65_0x5805a4,_0x3c5d73=await database_1['default'][_0x55981e(0xad)][_0x55981e(0x6d)]({'where':{'id':_0xba5ca,'shopId':_0x30090d}});if(!_0x3c5d73)return null;return{'id':_0x3c5d73['id'],'amount':_0x3c5d73[_0x55981e(0x9a)],'network':_0x3c5d73['network'],'status':_0x3c5d73[_0x55981e(0xe4)],'txid':_0x3c5d73[_0x55981e(0x115)],'notes':_0x3c5d73[_0x55981e(0xb8)],'createdAt':_0x3c5d73['createdAt'],'paidAt':_0x3c5d73[_0x55981e(0x111)]};}async['getPayoutStatistics'](_0x203182,_0x2f1a32){const _0x3cef5f=a65_0x5805a4,_0x4d2369=new Date();let _0x3e3d1d,_0x5de24a;switch(_0x2f1a32){case _0x3cef5f(0x6e):case'YESTERDAY':const _0x29ca49=new Date(_0x4d2369);_0x29ca49['setDate'](_0x29ca49['getDate']()-0x1),_0x3e3d1d=new Date(_0x29ca49),_0x3e3d1d[_0x3cef5f(0x8b)](0x0,0x0,0x0,0x0),_0x5de24a=new Date(_0x29ca49),_0x5de24a[_0x3cef5f(0x8b)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x3e3d1d=new Date(_0x4d2369['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x3cef5f(0xc1):_0x3e3d1d=new Date(_0x4d2369['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3cef5f(0x91):_0x3e3d1d=new Date(_0x4d2369['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x3e3d1d=new Date(_0x4d2369['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x30a6ef={'gte':_0x3e3d1d};_0x5de24a&&(_0x30a6ef[_0x3cef5f(0x8e)]=_0x5de24a);const [_0x2616b7,_0x3c4c45,_0x27543a,_0x3ca258,_0x4867b3,_0x28ae3e]=await Promise['all']([database_1['default'][_0x3cef5f(0xad)][_0x3cef5f(0xe8)]({'where':{'shopId':_0x203182,'createdAt':_0x30a6ef}}),database_1[_0x3cef5f(0x116)][_0x3cef5f(0xad)][_0x3cef5f(0xe8)]({'where':{'shopId':_0x203182,'status':_0x3cef5f(0x11f),'createdAt':_0x30a6ef}}),database_1[_0x3cef5f(0x116)][_0x3cef5f(0xad)][_0x3cef5f(0xe8)]({'where':{'shopId':_0x203182,'status':_0x3cef5f(0xaa),'createdAt':_0x30a6ef}}),database_1[_0x3cef5f(0x116)][_0x3cef5f(0xad)][_0x3cef5f(0xe8)]({'where':{'shopId':_0x203182,'status':_0x3cef5f(0xd3),'createdAt':_0x30a6ef}}),database_1[_0x3cef5f(0x116)][_0x3cef5f(0xad)][_0x3cef5f(0x10a)]({'where':{'shopId':_0x203182,'createdAt':_0x30a6ef},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1['default'][_0x3cef5f(0xad)][_0x3cef5f(0x10a)]({'where':{'shopId':_0x203182},'take':0xa,'orderBy':{'createdAt':_0x3cef5f(0x106)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x5cf6d=_0x4867b3[_0x3cef5f(0xc2)]((_0x5b4afe,_0x35d0b1)=>_0x5b4afe+_0x35d0b1[_0x3cef5f(0x9a)],0x0),_0x80e510=_0x4867b3[_0x3cef5f(0xf6)](_0x4fa1a2=>_0x4fa1a2[_0x3cef5f(0xe4)]==='COMPLETED')[_0x3cef5f(0xc2)]((_0x20ff73,_0x56ad71)=>_0x20ff73+_0x56ad71[_0x3cef5f(0x9a)],0x0),_0x1a4586=_0x4867b3[_0x3cef5f(0xf6)](_0x427daf=>_0x427daf[_0x3cef5f(0xe4)]===_0x3cef5f(0xaa))['reduce']((_0x46413d,_0x49860d)=>_0x46413d+_0x49860d['amount'],0x0),_0x135424=_0x4867b3['reduce']((_0x268f45,_0x3e59ef)=>{const _0x3fa7ac=_0x3cef5f;return _0x268f45[_0x3e59ef[_0x3fa7ac(0x86)]]=(_0x268f45[_0x3e59ef[_0x3fa7ac(0x86)]]||0x0)+0x1,_0x268f45;},{}),_0x57b0f3=_0x4867b3[_0x3cef5f(0xc2)]((_0xed5388,_0x3be57a)=>{const _0x53634e=_0x3cef5f;return _0xed5388[_0x3be57a[_0x53634e(0xe4)]]=(_0xed5388[_0x3be57a[_0x53634e(0xe4)]]||0x0)+0x1,_0xed5388;},{});return{'totalPayouts':_0x2616b7,'completedPayouts':_0x3c4c45,'pendingPayouts':_0x27543a,'rejectedPayouts':_0x3ca258,'totalAmount':_0x5cf6d,'completedAmount':_0x80e510,'pendingAmount':_0x1a4586,'payoutsByMethod':_0x135424,'payoutsByStatus':_0x57b0f3,'recentPayouts':_0x28ae3e[_0x3cef5f(0xc7)](_0x36ba7c=>({'id':_0x36ba7c['id'],'shopId':_0x203182,'amount':_0x36ba7c[_0x3cef5f(0x9a)],'method':_0x36ba7c[_0x3cef5f(0x86)],'status':_0x36ba7c[_0x3cef5f(0xe4)],'txid':_0x36ba7c[_0x3cef5f(0x115)],'createdAt':_0x36ba7c['createdAt'],'paidAt':_0x36ba7c[_0x3cef5f(0x111)]}))};}async['getShopPayoutStats'](_0x31fa77){const _0x1e940e=a65_0x5805a4;console[_0x1e940e(0xf5)](_0x1e940e(0xaf)+_0x31fa77+'...');const _0x5dc047=await database_1[_0x1e940e(0x116)][_0x1e940e(0x71)][_0x1e940e(0xb1)]({'where':{'id':_0x31fa77},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x5dc047)throw new Error('Shop\x20not\x20found');const _0x5bdfee=new Date(),_0x4ad6ac=new Date(_0x5bdfee[_0x1e940e(0xb4)](),_0x5bdfee[_0x1e940e(0x7f)](),0x1),_0x521648=new Date(_0x5bdfee[_0x1e940e(0xb4)](),_0x5bdfee['getMonth']()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0xfead74=await database_1[_0x1e940e(0x116)][_0x1e940e(0xad)][_0x1e940e(0x76)]({'_sum':{'amount':!![]},'where':{'shopId':_0x31fa77,'createdAt':{'gte':_0x4ad6ac,'lte':_0x521648},'status':_0x1e940e(0x11f)}}),_0x12b84f=_0xfead74[_0x1e940e(0xc5)][_0x1e940e(0x9a)]||0x0,_0x3a40d6={'availableBalance':Math['round'](_0x5dc047[_0x1e940e(0x119)]*0x64)/0x64,'totalPaidOut':Math[_0x1e940e(0x107)](_0x5dc047[_0x1e940e(0x7d)]*0x64)/0x64,'awaitingPayout':Math[_0x1e940e(0x107)](_0x5dc047['balance']*0x64)/0x64,'thisMonth':Math[_0x1e940e(0x107)](_0x12b84f*0x64)/0x64};return console[_0x1e940e(0xf5)](_0x1e940e(0x120)+_0x5dc047[_0x1e940e(0x10c)]+'\x20payout\x20statistics\x20calculated:'),console[_0x1e940e(0xf5)]('\x20\x20\x20💵\x20Available\x20balance:\x20'+_0x3a40d6[_0x1e940e(0xae)]+_0x1e940e(0x95)),console[_0x1e940e(0xf5)]('\x20\x20\x20💰\x20Total\x20paid\x20out:\x20'+_0x3a40d6[_0x1e940e(0x7d)]+_0x1e940e(0xd5)),console['log'](_0x1e940e(0xa7)+_0x3a40d6[_0x1e940e(0xc4)]+'\x20USDT\x20(current\x20balance)'),console[_0x1e940e(0xf5)](_0x1e940e(0xc8)+_0x3a40d6[_0x1e940e(0x10b)]+'\x20USDT'),_0x3a40d6;}['getGatewayDisplayName'](_0x1680c4){const _0x51b193=a65_0x5805a4,_0x307738={'test_gateway':'Test\x20Gateway','plisio':_0x51b193(0xdf),'rapyd':_0x51b193(0x104),'noda':_0x51b193(0x8c),'cointopay':_0x51b193(0xb3),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x51b193(0x90),'klyme_de':_0x51b193(0x73)};return _0x307738[_0x1680c4]||_0x1680c4;}async[a65_0x5805a4(0x9b)](_0xf4bcca){return this['getShopPayoutStats'](_0xf4bcca);}async[a65_0x5805a4(0xed)](_0x4c5e43,_0x51a398){const _0x4b46b8=a65_0x5805a4,{page:_0x3a1343,limit:_0x39c87b,paymentId:_0x5cfa47}=_0x51a398,_0x1c3942=(_0x3a1343-0x1)*_0x39c87b,_0xd2cecc={'shopId':_0x4c5e43};_0x5cfa47&&(_0xd2cecc[_0x4b46b8(0x92)]=_0x5cfa47);const [_0x10f193,_0x3fcf1f]=await Promise['all']([database_1[_0x4b46b8(0x116)][_0x4b46b8(0xd0)][_0x4b46b8(0x10a)]({'where':_0xd2cecc,'skip':_0x1c3942,'take':_0x39c87b,'orderBy':{'createdAt':_0x4b46b8(0x106)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default'][_0x4b46b8(0xd0)]['count']({'where':_0xd2cecc})]);return{'logs':_0x10f193[_0x4b46b8(0xc7)](_0x810511=>({'id':_0x810511['id'],'paymentId':_0x810511['paymentId'],'shopId':_0x810511[_0x4b46b8(0xba)],'event':_0x810511[_0x4b46b8(0x78)],'statusCode':_0x810511[_0x4b46b8(0x79)],'retryCount':_0x810511['retryCount'],'responseBody':_0x810511[_0x4b46b8(0x114)],'createdAt':_0x810511[_0x4b46b8(0x10e)],'payment':_0x810511[_0x4b46b8(0x10d)]})),'pagination':{'page':_0x3a1343,'limit':_0x39c87b,'total':_0x3fcf1f,'totalPages':Math[_0x4b46b8(0xda)](_0x3fcf1f/_0x39c87b)}};}async[a65_0x5805a4(0x8d)](_0x5b480d,_0x2239c3){const _0x288875=a65_0x5805a4;console[_0x288875(0xf5)](_0x288875(0x108)+_0x5b480d+_0x288875(0x72)+_0x2239c3);const _0x789eb0=new Date();let _0x2fd1b0,_0x3dab1f;switch(_0x2239c3['toLowerCase']()){case _0x288875(0xcd):_0x2fd1b0=new Date(_0x789eb0[_0x288875(0xb4)](),_0x789eb0[_0x288875(0x7f)](),_0x789eb0[_0x288875(0x99)](),0x0,0x0,0x0,0x0);break;case _0x288875(0x6e):case'YESTERDAY':const _0x54c78d=new Date(_0x789eb0);_0x54c78d[_0x288875(0x11d)](_0x54c78d[_0x288875(0x99)]()-0x1),_0x2fd1b0=new Date(_0x54c78d),_0x2fd1b0['setHours'](0x0,0x0,0x0,0x0),_0x3dab1f=new Date(_0x54c78d),_0x3dab1f[_0x288875(0x8b)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x2fd1b0=new Date(_0x789eb0[_0x288875(0x10f)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x288875(0xc1):_0x2fd1b0=new Date(_0x789eb0[_0x288875(0x10f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x2fd1b0=new Date(_0x789eb0['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;case'1y':case _0x288875(0x105):_0x2fd1b0=new Date(_0x789eb0['getTime']()-0x16d*0x18*0x3c*0x3c*0x3e8);break;default:_0x2fd1b0=new Date(_0x789eb0[_0x288875(0x10f)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}console[_0x288875(0xf5)](_0x288875(0xbb)+_0x2fd1b0[_0x288875(0xb5)]()+_0x288875(0xe5)+(_0x3dab1f?_0x3dab1f[_0x288875(0xb5)]():_0x288875(0xd1)));const _0x21c629={'gte':_0x2fd1b0};_0x3dab1f&&(_0x21c629[_0x288875(0x8e)]=_0x3dab1f);const [_0x90b624,_0x3c1d10,_0x44af41,_0x3d8c03,_0x195fc0]=await Promise[_0x288875(0x117)]([database_1[_0x288875(0x116)][_0x288875(0x10d)][_0x288875(0xe8)]({'where':{'shopId':_0x5b480d,'gateway':{'not':_0x288875(0x113)},'createdAt':_0x21c629}}),database_1['default'][_0x288875(0x10d)][_0x288875(0xe8)]({'where':{'shopId':_0x5b480d,'gateway':{'not':_0x288875(0x113)},'status':_0x288875(0x88),'createdAt':_0x21c629}}),database_1[_0x288875(0x116)][_0x288875(0x10d)][_0x288875(0x10a)]({'where':{'shopId':_0x5b480d,'gateway':{'not':_0x288875(0x113)},'status':_0x288875(0x88),'createdAt':_0x21c629},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x288875(0x116)][_0x288875(0x10d)]['findMany']({'where':{'shopId':_0x5b480d,'gateway':{'not':_0x288875(0x113)}},'take':0xa,'orderBy':{'createdAt':_0x288875(0x106)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x288875(0x116)]['payment'][_0x288875(0x10a)]({'where':{'shopId':_0x5b480d,'gateway':{'not':'test_gateway'},'createdAt':_0x21c629},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x288875(0xcf)}})]);let _0x5858b2=0x0;for(const _0x393010 of _0x44af41){if(_0x393010[_0x288875(0xfa)])_0x5858b2+=_0x393010['amountUSDT'];else{const _0x1a8d1f=await currencyService_1['currencyService'][_0x288875(0xf8)](_0x393010[_0x288875(0x9a)],_0x393010[_0x288875(0x83)]);_0x5858b2+=_0x1a8d1f;}}const _0x50aa1f=this[_0x288875(0x101)](_0x195fc0,_0x2fd1b0,_0x3dab1f||_0x789eb0),_0x41f44d=_0x90b624>0x0?_0x3c1d10/_0x90b624*0x64:0x0;return{'totalPayments':_0x90b624,'successfulPayments':_0x3c1d10,'totalRevenue':Math[_0x288875(0x107)](_0x5858b2*0x64)/0x64,'conversionRate':Math['round'](_0x41f44d*0x64)/0x64,'dailyRevenue':_0x50aa1f[_0x288875(0xfd)],'dailyPayments':_0x50aa1f[_0x288875(0x121)],'recentPayments':_0x3d8c03[_0x288875(0xc7)](_0x4516a8=>({'id':_0x4516a8['id'],'gateway':_0x4516a8[_0x288875(0xa9)],'amount':_0x4516a8[_0x288875(0x9a)],'currency':_0x4516a8[_0x288875(0x83)],'status':_0x4516a8[_0x288875(0xe4)],'createdAt':_0x4516a8[_0x288875(0x10e)]}))};}[a65_0x5805a4(0x101)](_0x11487d,_0x5e98a7,_0x4506a0){const _0x56dfd1=a65_0x5805a4,_0x26a185=new Map(),_0x268125=new Date(_0x5e98a7);while(_0x268125<=_0x4506a0){const _0x1058c3=_0x268125[_0x56dfd1(0xb5)]()[_0x56dfd1(0x110)]('T')[0x0];_0x26a185[_0x56dfd1(0xd7)](_0x1058c3,{'revenue':0x0,'count':0x0}),_0x268125[_0x56dfd1(0x11d)](_0x268125['getDate']()+0x1);}for(const _0x80cf5f of _0x11487d){const _0x576035=_0x80cf5f[_0x56dfd1(0x10e)][_0x56dfd1(0xb5)]()['split']('T')[0x0],_0x1d8fae=_0x26a185['get'](_0x576035);_0x1d8fae&&(_0x1d8fae[_0x56dfd1(0xe8)]+=0x1,_0x80cf5f[_0x56dfd1(0xe4)]===_0x56dfd1(0x88)&&_0x80cf5f['amountUSDT']&&(_0x1d8fae[_0x56dfd1(0x6f)]+=_0x80cf5f[_0x56dfd1(0xfa)]));}const _0x1eb41c=[],_0x35e906=[];for(const [_0x45a0b0,_0x112838]of _0x26a185){_0x1eb41c[_0x56dfd1(0xca)]({'date':_0x45a0b0,'amount':Math[_0x56dfd1(0x107)](_0x112838['revenue']*0x64)/0x64}),_0x35e906[_0x56dfd1(0xca)]({'date':_0x45a0b0,'count':_0x112838['count']});}return{'dailyRevenue':_0x1eb41c,'dailyPayments':_0x35e906};}}function a65_0x52dd(){const _0x22d350=['usdtErcWallet','./currencyService','Plisio','gte','876408RxKmZy','message','customer','status','\x20to\x20','USDC\x20Polygon','isArray','count','customerName','expiresAt','Unknown\x20error','getShopProfile','getWebhookLogs','shopUrl','periodTo','update','erc20_usdc','test','delete','20KVmZHM','log','filter','💰\x20Getting\x20payouts\x20with\x20filters:','convertToUSDT','testWebhook','amountUSDT','application/json','8brGgHy','dailyRevenue','__esModule','📅\x20Period\x20end:\x20','usdcErcWallet','generateDailyStatistics','usdtPolygonWallet','835041cqrbSq','Rapyd','year','desc','round','📊\x20Getting\x20statistics\x20for\x20shop\x20','paymentGateways','findMany','thisMonth','username','payment','createdAt','getTime','split','paidAt','Payment\x20System/1.0\x20(Test)','test_gateway','responseBody','txid','default','all','periodFrom','balance','maxPayments','🌐\x20Method\x20filter:\x20','stringify','setDate','USD','COMPLETED','📊\x20Shop\x20','dailyPayments','findFirst','yesterday','revenue','redirectUrl','shop',',\x20period:\x20','KLYME\x20DE','ShopService','formatNetworkName','aggregate','gatewaySettings','event','statusCode','updatePayment','33771510ZKOVYR','paid','totalPaidOut','polygon_usdc','getMonth','usage','Error\x20parsing\x20webhook\x20events:','sourceCurrency','currency','5665689vFAMZn','getPayoutById','network','country','PAID','fullName','__importDefault','setHours','Noda','getStatistics','lte','Webhook\x20returned\x20error:\x20','KLYME\x20GB','90d','paymentId','telegram','3094674yiZyXD','\x20USDT\x20(current\x20balance)','updateWallets','telegramId','error','getDate','amount','getPayoutStats','customerEmail','Payment\x20not\x20found','gateways','getPaymentByShopAndId','statusText','toUpperCase','name','USDC\x20Ethereum','updateShopProfile','./paymentService','parse','\x20\x20\x20⏳\x20Awaiting\x20payout:\x20','Failed\x20to\x20send\x20webhook:\x20','gateway','PENDING','usdtTrcWallet','publicKey','payout','availableBalance','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','wallets','findUnique','settings','CoinToPay','getFullYear','toISOString','Shop\x20not\x20found','getPaymentById','notes','8iqLIrK','shopId','📅\x20Date\x20range:\x20','merchantUrl','erc20','USDT\x20TRC20','USDT\x20BSC','usdcPolygonWallet','30d','reduce','amountIsEditable','awaitingPayout','_sum','webhookUrl','map','\x20\x20\x20📅\x20This\x20month:\x20','language','push','webhookEvents','paymentService','day','309777KVPJrL','asc','webhookLog','now','trc20','REJECTED','8266489CdyIcf','\x20USDT\x20(total\x20payouts)','defineProperty','set','📊\x20Status\x20filter:\x20','No\x20webhook\x20URL\x20configured','ceil','createPublicPayment','📅\x20Date\x20end:\x20'];a65_0x52dd=function(){return _0x22d350;};return a65_0x52dd();}function a65_0x5c8c(_0x588979,_0x24a5a8){const _0x52dd53=a65_0x52dd();return a65_0x5c8c=function(_0x5c8c84,_0x58813f){_0x5c8c84=_0x5c8c84-0x6d;let _0x55490c=_0x52dd53[_0x5c8c84];return _0x55490c;},a65_0x5c8c(_0x588979,_0x24a5a8);}exports[a65_0x5805a4(0x74)]=ShopService;