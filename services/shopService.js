'use strict';const a62_0x1e18c5=a62_0x512c;(function(_0x15c3a8,_0x2a848a){const _0x5bec21=a62_0x512c,_0x34657=_0x15c3a8();while(!![]){try{const _0x8d09a5=parseInt(_0x5bec21(0x22c))/0x1*(-parseInt(_0x5bec21(0x23a))/0x2)+-parseInt(_0x5bec21(0x215))/0x3+-parseInt(_0x5bec21(0x24d))/0x4+-parseInt(_0x5bec21(0x1f4))/0x5+parseInt(_0x5bec21(0x245))/0x6*(parseInt(_0x5bec21(0x208))/0x7)+-parseInt(_0x5bec21(0x1d7))/0x8*(-parseInt(_0x5bec21(0x209))/0x9)+parseInt(_0x5bec21(0x20c))/0xa;if(_0x8d09a5===_0x2a848a)break;else _0x34657['push'](_0x34657['shift']());}catch(_0x398582){_0x34657['push'](_0x34657['shift']());}}}(a62_0x4dec,0xb11b4));var __importDefault=this&&this[a62_0x1e18c5(0x1f8)]||function(_0x4ec4b5){const _0x10e0d0=a62_0x1e18c5;return _0x4ec4b5&&_0x4ec4b5[_0x10e0d0(0x231)]?_0x4ec4b5:{'default':_0x4ec4b5};};function a62_0x4dec(){const _0x355eb2=['lte','createdAt','Error\x20parsing\x20webhook\x20events:','log','txid','test','getGatewayDisplayName','payment','Shop\x20not\x20found','amount','username','paid','findMany','reduce','updateWallets','defineProperty','periodTo','30d','deletePayment','Test\x20Gateway','telegram','usage','üìä\x20Status\x20filter:\x20','üìÖ\x20Period\x20end:\x20','statusText','paidAt','notes','amountIsEditable','USDT\x20Polygon','delete','üìÖ\x20Period\x20start:\x20','gatewaySettings','üí∞\x20Getting\x20payouts\x20with\x20filters:','error','POST','Webhook\x20returned\x20error:\x20','wallets','createPublicPayment','balance','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','thisMonth','periodFrom','1448NayItZ','setHours','No\x20webhook\x20URL\x20configured','aggregate','getPaymentsByShop','webhookLog','gateways','convertToUSDT','Rapyd','ceil','customer','getPaymentByShopAndId','amountUSDT','parse','sourceCurrency','toISOString','Unknown\x20error','paymentGateways','dailyPayments','...','usdtErcWallet','map','üåê\x20Network\x20filter:\x20','\x20payout\x20statistics\x20calculated:','gte','availableBalance','USDT\x20ERC20','stringify','network','177950zKhiAL','REJECTED','getStatistics','filter','__importDefault','toUpperCase','awaitingPayout','expiresAt','name','redirectUrl','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','split','COMPLETED','PENDING','erc20_usdc','application/json','all','shop','merchantUrl','Test\x20webhook\x20sent\x20successfully\x20(','1157611BPWafm','1683wrIAPB','count','shopUrl','7212620MVmqTS','currency','desc','PAID','polygon_usdc','usdcErcWallet','_sum','usdtPolygonWallet','default','589212SknVjw','asc','gateway','dailyRevenue','getShopPayoutStats','createPayment','updatePayment','test_gateway','polygon','Payment\x20System/1.0\x20(Test)','getFullYear','paymentService','Payment\x20not\x20found','test_order_123','generateDailyStatistics','formatNetworkName','retryCount','responseBody','webhookUrl','./paymentService','90d','webhookEvents','PaymentService','17iqvOwc','usdcPolygonWallet','USDT\x20BSC','getPayoutStatistics','yesterday','__esModule','KLYME\x20GB','fullName','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','erc20','update','\x20USDT\x20(total\x20payouts)','setDate','getMonth','80812kyWkFL','USDC\x20Ethereum','getPayoutStats','getPayments','usdtTrcWallet','isArray','\x20USDT','getPayouts','set','findUnique','test_payment_123','42jJdYuS','totalPaidOut','telegramId','KLYME\x20EU','getPayoutById','CoinToPay','getPaymentById','revenue','1073584HtAdaV','publicKey','settings','\x20USDT\x20(current\x20balance)','payout','üìÖ\x20Date\x20start:\x20','\x20\x20\x20üìÖ\x20This\x20month:\x20','round','getTime','\x20\x20\x20üíµ\x20Available\x20balance:\x20','currencyService','üìä\x20Final\x20WHERE\x20conditions:','paymentId','getDate','../config/database','country','push','status','üåê\x20Method\x20filter:\x20','maxPayments','findFirst'];a62_0x4dec=function(){return _0x355eb2;};return a62_0x4dec();}function a62_0x512c(_0x2a9624,_0x4d325a){const _0x4decc0=a62_0x4dec();return a62_0x512c=function(_0x512c74,_0x33a249){_0x512c74=_0x512c74-0x1b7;let _0x2ca6bd=_0x4decc0[_0x512c74];return _0x2ca6bd;},a62_0x512c(_0x2a9624,_0x4d325a);}Object[a62_0x1e18c5(0x1bc)](exports,a62_0x1e18c5(0x231),{'value':!![]}),exports['ShopService']=void 0x0;const database_1=__importDefault(require(a62_0x1e18c5(0x25b))),currencyService_1=require('./currencyService'),paymentService_1=require(a62_0x1e18c5(0x228));class ShopService{constructor(){const _0x3b6174=a62_0x1e18c5;this[_0x3b6174(0x220)]=new paymentService_1[(_0x3b6174(0x22b))]();}async['getShopProfile'](_0x4a7ebe){const _0x41317a=a62_0x1e18c5,_0x50ae96=await database_1[_0x41317a(0x214)]['shop'][_0x41317a(0x243)]({'where':{'id':_0x4a7ebe},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x50ae96)throw new Error(_0x41317a(0x26a));let _0x3ef8ce=[];if(_0x50ae96[_0x41317a(0x24f)]?.[_0x41317a(0x22a)])try{_0x3ef8ce=Array[_0x41317a(0x23f)](_0x50ae96[_0x41317a(0x24f)][_0x41317a(0x22a)])?_0x50ae96[_0x41317a(0x24f)][_0x41317a(0x22a)]:JSON[_0x41317a(0x1e4)](_0x50ae96[_0x41317a(0x24f)][_0x41317a(0x22a)]);}catch(_0x45ca57){console[_0x41317a(0x1ce)](_0x41317a(0x264),_0x45ca57),_0x3ef8ce=[];}return{'id':_0x50ae96['id'],'fullName':_0x50ae96[_0x41317a(0x1fc)],'username':_0x50ae96[_0x41317a(0x1b7)],'telegramId':_0x50ae96['telegram'],'merchantUrl':_0x50ae96[_0x41317a(0x20b)],'gateways':_0x50ae96['paymentGateways']?JSON[_0x41317a(0x1e4)](_0x50ae96['paymentGateways']):null,'gatewaySettings':_0x50ae96[_0x41317a(0x1cc)]?JSON[_0x41317a(0x1e4)](_0x50ae96['gatewaySettings']):null,'publicKey':_0x50ae96[_0x41317a(0x24e)],'webhookUrl':_0x50ae96[_0x41317a(0x24f)]?.[_0x41317a(0x227)]||null,'webhookEvents':_0x3ef8ce,'wallets':{'usdtPolygonWallet':_0x50ae96['usdtPolygonWallet'],'usdtTrcWallet':_0x50ae96['usdtTrcWallet'],'usdtErcWallet':_0x50ae96['usdtErcWallet'],'usdcPolygonWallet':_0x50ae96[_0x41317a(0x22d)],'usdcErcWallet':_0x50ae96['usdcErcWallet']},'status':_0x50ae96[_0x41317a(0x25e)],'createdAt':_0x50ae96[_0x41317a(0x263)]};}async['updateShopProfile'](_0x563914,_0x51d65c){const _0x5dee69=a62_0x1e18c5,_0x3a81f6={};_0x51d65c[_0x5dee69(0x233)]&&(_0x3a81f6[_0x5dee69(0x1fc)]=_0x51d65c[_0x5dee69(0x233)]);_0x51d65c[_0x5dee69(0x247)]!==undefined&&(_0x3a81f6['telegram']=_0x51d65c[_0x5dee69(0x247)]||null);_0x51d65c['merchantUrl']&&(_0x3a81f6['shopUrl']=_0x51d65c[_0x5dee69(0x206)]);_0x51d65c[_0x5dee69(0x1dd)]&&(_0x3a81f6['paymentGateways']=JSON[_0x5dee69(0x1f2)](_0x51d65c[_0x5dee69(0x1dd)]));_0x51d65c[_0x5dee69(0x1cc)]&&(_0x3a81f6[_0x5dee69(0x1cc)]=JSON['stringify'](_0x51d65c['gatewaySettings']));_0x51d65c[_0x5dee69(0x1d1)]&&(_0x51d65c[_0x5dee69(0x1d1)]['usdtPolygonWallet']!==undefined&&(_0x3a81f6[_0x5dee69(0x213)]=_0x51d65c[_0x5dee69(0x1d1)][_0x5dee69(0x213)]||null),_0x51d65c['wallets'][_0x5dee69(0x23e)]!==undefined&&(_0x3a81f6[_0x5dee69(0x23e)]=_0x51d65c[_0x5dee69(0x1d1)]['usdtTrcWallet']||null),_0x51d65c['wallets'][_0x5dee69(0x1eb)]!==undefined&&(_0x3a81f6['usdtErcWallet']=_0x51d65c[_0x5dee69(0x1d1)]['usdtErcWallet']||null),_0x51d65c[_0x5dee69(0x1d1)]['usdcPolygonWallet']!==undefined&&(_0x3a81f6['usdcPolygonWallet']=_0x51d65c['wallets']['usdcPolygonWallet']||null));const _0x21c906=await database_1[_0x5dee69(0x214)]['shop'][_0x5dee69(0x236)]({'where':{'id':_0x563914},'data':_0x3a81f6,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x51e233=[];if(_0x21c906['settings']?.[_0x5dee69(0x22a)])try{_0x51e233=Array[_0x5dee69(0x23f)](_0x21c906[_0x5dee69(0x24f)][_0x5dee69(0x22a)])?_0x21c906['settings']['webhookEvents']:JSON[_0x5dee69(0x1e4)](_0x21c906['settings']['webhookEvents']);}catch(_0x423d84){console[_0x5dee69(0x1ce)](_0x5dee69(0x264),_0x423d84),_0x51e233=[];}return{'id':_0x21c906['id'],'fullName':_0x21c906['name'],'username':_0x21c906[_0x5dee69(0x1b7)],'telegramId':_0x21c906[_0x5dee69(0x1c1)],'merchantUrl':_0x21c906[_0x5dee69(0x20b)],'gateways':_0x21c906[_0x5dee69(0x1e8)]?JSON['parse'](_0x21c906['paymentGateways']):null,'gatewaySettings':_0x21c906['gatewaySettings']?JSON[_0x5dee69(0x1e4)](_0x21c906[_0x5dee69(0x1cc)]):null,'publicKey':_0x21c906['publicKey'],'webhookUrl':_0x21c906[_0x5dee69(0x24f)]?.[_0x5dee69(0x227)]||null,'webhookEvents':_0x51e233,'wallets':{'usdtPolygonWallet':_0x21c906['usdtPolygonWallet'],'usdtTrcWallet':_0x21c906[_0x5dee69(0x23e)],'usdtErcWallet':_0x21c906[_0x5dee69(0x1eb)],'usdcPolygonWallet':_0x21c906[_0x5dee69(0x22d)],'usdcErcWallet':_0x21c906[_0x5dee69(0x211)]},'status':_0x21c906[_0x5dee69(0x25e)],'createdAt':_0x21c906[_0x5dee69(0x263)]};}async[a62_0x1e18c5(0x1bb)](_0x41529e,_0x50f155){const _0x74e3e8=a62_0x1e18c5,_0x508163={};_0x50f155[_0x74e3e8(0x213)]!==undefined&&(_0x508163[_0x74e3e8(0x213)]=_0x50f155['usdtPolygonWallet']||null),_0x50f155['usdtTrcWallet']!==undefined&&(_0x508163['usdtTrcWallet']=_0x50f155['usdtTrcWallet']||null),_0x50f155['usdtErcWallet']!==undefined&&(_0x508163['usdtErcWallet']=_0x50f155['usdtErcWallet']||null),_0x50f155[_0x74e3e8(0x22d)]!==undefined&&(_0x508163[_0x74e3e8(0x22d)]=_0x50f155['usdcPolygonWallet']||null),_0x50f155[_0x74e3e8(0x211)]!==undefined&&(_0x508163['usdcErcWallet']=_0x50f155[_0x74e3e8(0x211)]||null),await database_1['default'][_0x74e3e8(0x205)][_0x74e3e8(0x236)]({'where':{'id':_0x41529e},'data':_0x508163});}async['testWebhook'](_0x33a89c){const _0xf9dfc7=a62_0x1e18c5,_0x34269b=await database_1['default'][_0xf9dfc7(0x205)]['findUnique']({'where':{'id':_0x33a89c},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x34269b?.['settings']?.[_0xf9dfc7(0x227)])throw new Error(_0xf9dfc7(0x1d9));const _0x35e1e9={'event':_0xf9dfc7(0x267),'payment':{'id':_0xf9dfc7(0x244),'order_id':_0xf9dfc7(0x222),'gateway':_0xf9dfc7(0x267),'amount':0x64,'currency':'USD','status':_0xf9dfc7(0x1b8),'created_at':new Date()[_0xf9dfc7(0x1e6)]()}};try{const _0x5ccde9=await fetch(_0x34269b[_0xf9dfc7(0x24f)][_0xf9dfc7(0x227)],{'method':_0xf9dfc7(0x1cf),'headers':{'Content-Type':_0xf9dfc7(0x203),'User-Agent':_0xf9dfc7(0x21e)},'body':JSON[_0xf9dfc7(0x1f2)](_0x35e1e9)});return _0x5ccde9['ok']?{'success':!![],'message':_0xf9dfc7(0x207)+_0x5ccde9[_0xf9dfc7(0x25e)]+')'}:{'success':![],'message':_0xf9dfc7(0x1d0)+_0x5ccde9['status']+'\x20'+_0x5ccde9[_0xf9dfc7(0x1c5)]};}catch(_0x17a41c){return{'success':![],'message':'Failed\x20to\x20send\x20webhook:\x20'+(_0x17a41c instanceof Error?_0x17a41c['message']:_0xf9dfc7(0x1e7))};}}async[a62_0x1e18c5(0x21a)](_0x1bbc3a){const _0x323d3e=a62_0x1e18c5;return this[_0x323d3e(0x220)][_0x323d3e(0x1d2)]({'public_key':'','gateway':_0x1bbc3a[_0x323d3e(0x217)],'order_id':undefined,'amount':_0x1bbc3a[_0x323d3e(0x26b)],'currency':_0x1bbc3a[_0x323d3e(0x20d)],'source_currency':_0x1bbc3a[_0x323d3e(0x1e5)],'usage':_0x1bbc3a[_0x323d3e(0x1c2)],'expires_at':_0x1bbc3a[_0x323d3e(0x1fb)]?.[_0x323d3e(0x1e6)](),'success_url':_0x1bbc3a[_0x323d3e(0x1fd)],'fail_url':_0x1bbc3a['redirectUrl'],'customer_email':_0x1bbc3a['customerEmail'],'customer_name':_0x1bbc3a['customerName'],'country':_0x1bbc3a[_0x323d3e(0x25c)],'language':_0x1bbc3a['language'],'amount_is_editable':_0x1bbc3a[_0x323d3e(0x1c8)],'max_payments':_0x1bbc3a[_0x323d3e(0x260)],'customer':_0x1bbc3a[_0x323d3e(0x1e1)]});}async[a62_0x1e18c5(0x23d)](_0x23c0ed,_0x499d3a){const _0x1d13d0=a62_0x1e18c5;return this['paymentService'][_0x1d13d0(0x1db)](_0x23c0ed,_0x499d3a);}async[a62_0x1e18c5(0x24b)](_0x4f2306,_0x154152){const _0x29d286=a62_0x1e18c5;return this[_0x29d286(0x220)][_0x29d286(0x1e2)](_0x4f2306,_0x154152);}async[a62_0x1e18c5(0x21b)](_0x53b5ad,_0x2a921c,_0x491acf){const _0x37cbf4=a62_0x1e18c5,_0x333ed4=await database_1[_0x37cbf4(0x214)][_0x37cbf4(0x269)][_0x37cbf4(0x261)]({'where':{'id':_0x2a921c,'shopId':_0x53b5ad}});if(!_0x333ed4)throw new Error(_0x37cbf4(0x221));const _0x549933=await database_1['default'][_0x37cbf4(0x269)][_0x37cbf4(0x236)]({'where':{'id':_0x2a921c},'data':{..._0x491acf,'updatedAt':new Date()}});return _0x549933;}async[a62_0x1e18c5(0x1bf)](_0x55eed3,_0x77646){const _0x2e25f9=a62_0x1e18c5,_0x1c0549=await database_1['default'][_0x2e25f9(0x269)][_0x2e25f9(0x261)]({'where':{'id':_0x77646,'shopId':_0x55eed3}});if(!_0x1c0549)throw new Error(_0x2e25f9(0x221));await database_1[_0x2e25f9(0x214)][_0x2e25f9(0x269)][_0x2e25f9(0x1ca)]({'where':{'id':_0x77646}});}[a62_0x1e18c5(0x224)](_0x53fad5){const _0x15d640=a62_0x1e18c5,_0x59c052={'polygon':_0x15d640(0x1c9),'trc20':'USDT\x20TRC20','erc20':_0x15d640(0x1f1),'bsc':_0x15d640(0x22e),'polygon_usdc':'USDC\x20Polygon','erc20_usdc':_0x15d640(0x23b)};return _0x59c052[_0x53fad5]||_0x53fad5;}async[a62_0x1e18c5(0x241)](_0x124849,_0x31dcc8){const _0x500b62=a62_0x1e18c5,{page:_0x32d86b,limit:_0x372cde,status:_0x4f9557,method:_0x40ec5d,network:_0x201c0a,dateFrom:_0x54b4b9,dateTo:_0x3e9820,periodFrom:_0x6325ba,periodTo:_0x2e824e}=_0x31dcc8,_0x261916=(_0x32d86b-0x1)*_0x372cde;console[_0x500b62(0x265)](_0x500b62(0x1cd),_0x31dcc8);const _0x227b9a={'shopId':_0x124849};_0x4f9557&&(_0x227b9a[_0x500b62(0x25e)]=_0x4f9557[_0x500b62(0x1f9)](),console[_0x500b62(0x265)](_0x500b62(0x1c3)+_0x4f9557[_0x500b62(0x1f9)]()));if(_0x40ec5d)_0x227b9a[_0x500b62(0x1f3)]=_0x40ec5d,console[_0x500b62(0x265)](_0x500b62(0x25f)+_0x40ec5d);else _0x201c0a&&(_0x227b9a['network']=_0x201c0a,console[_0x500b62(0x265)](_0x500b62(0x1ed)+_0x201c0a));if(_0x54b4b9||_0x3e9820||_0x6325ba||_0x2e824e){_0x227b9a[_0x500b62(0x263)]={};if(_0x6325ba){const _0x323fa7=new Date(_0x6325ba);_0x323fa7[_0x500b62(0x1d8)](0x0,0x0,0x0,0x0),_0x227b9a[_0x500b62(0x263)]['gte']=_0x323fa7,console[_0x500b62(0x265)](_0x500b62(0x1cb)+_0x323fa7[_0x500b62(0x1e6)]());}else{if(_0x54b4b9){const _0x376017=new Date(_0x54b4b9);_0x376017['setHours'](0x0,0x0,0x0,0x0),_0x227b9a[_0x500b62(0x263)][_0x500b62(0x1ef)]=_0x376017,console[_0x500b62(0x265)](_0x500b62(0x252)+_0x376017['toISOString']());}}if(_0x2e824e){const _0x59f5f1=new Date(_0x2e824e);_0x59f5f1[_0x500b62(0x1d8)](0x17,0x3b,0x3b,0x3e7),_0x227b9a[_0x500b62(0x263)][_0x500b62(0x262)]=_0x59f5f1,console['log'](_0x500b62(0x1c4)+_0x59f5f1[_0x500b62(0x1e6)]());}else{if(_0x3e9820){const _0x31f66d=new Date(_0x3e9820);_0x31f66d[_0x500b62(0x1d8)](0x17,0x3b,0x3b,0x3e7),_0x227b9a[_0x500b62(0x263)][_0x500b62(0x262)]=_0x31f66d,console[_0x500b62(0x265)]('üìÖ\x20Date\x20end:\x20'+_0x31f66d['toISOString']());}}}console[_0x500b62(0x265)](_0x500b62(0x258),JSON['stringify'](_0x227b9a,null,0x2));const [_0x5188e7,_0x5c28b0]=await Promise[_0x500b62(0x204)]([database_1['default']['payout'][_0x500b62(0x1b9)]({'where':_0x227b9a,'skip':_0x261916,'take':_0x372cde,'orderBy':{'createdAt':_0x500b62(0x20e)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![]}}}}),database_1['default'][_0x500b62(0x251)][_0x500b62(0x20a)]({'where':_0x227b9a})]);return{'payouts':_0x5188e7[_0x500b62(0x1ec)](_0xa3bae2=>{const _0x22d510=_0x500b62;let _0xa168b0=null;switch(_0xa3bae2['network']){case _0x22d510(0x21d):_0xa168b0=_0xa3bae2[_0x22d510(0x205)][_0x22d510(0x213)];break;case'trc20':_0xa168b0=_0xa3bae2[_0x22d510(0x205)][_0x22d510(0x23e)];break;case _0x22d510(0x235):_0xa168b0=_0xa3bae2[_0x22d510(0x205)]['usdtErcWallet'];break;case _0x22d510(0x210):_0xa168b0=_0xa3bae2[_0x22d510(0x205)]['usdcPolygonWallet'];break;case _0x22d510(0x202):_0xa168b0=_0xa3bae2['shop']['usdcErcWallet'];break;}return{'id':_0xa3bae2['id'],'amount':_0xa3bae2[_0x22d510(0x26b)],'network':this[_0x22d510(0x224)](_0xa3bae2[_0x22d510(0x1f3)]),'wallet':_0xa168b0,'status':_0xa3bae2[_0x22d510(0x25e)],'txid':_0xa3bae2['txid'],'notes':_0xa3bae2['notes'],'periodFrom':_0xa3bae2[_0x22d510(0x1d6)],'periodTo':_0xa3bae2[_0x22d510(0x1bd)],'createdAt':_0xa3bae2[_0x22d510(0x263)],'paidAt':_0xa3bae2[_0x22d510(0x1c6)]};}),'pagination':{'page':_0x32d86b,'limit':_0x372cde,'total':_0x5c28b0,'totalPages':Math[_0x500b62(0x1e0)](_0x5c28b0/_0x372cde)}};}async[a62_0x1e18c5(0x249)](_0x476edc,_0xc02b9b){const _0x204be4=a62_0x1e18c5,_0x6e5c40=await database_1[_0x204be4(0x214)][_0x204be4(0x251)][_0x204be4(0x261)]({'where':{'id':_0xc02b9b,'shopId':_0x476edc}});if(!_0x6e5c40)return null;return{'id':_0x6e5c40['id'],'amount':_0x6e5c40[_0x204be4(0x26b)],'network':_0x6e5c40[_0x204be4(0x1f3)],'status':_0x6e5c40['status'],'txid':_0x6e5c40[_0x204be4(0x266)],'notes':_0x6e5c40[_0x204be4(0x1c7)],'createdAt':_0x6e5c40[_0x204be4(0x263)],'paidAt':_0x6e5c40[_0x204be4(0x1c6)]};}async[a62_0x1e18c5(0x22f)](_0x248d19,_0x208b00){const _0x18bd00=a62_0x1e18c5,_0x320dea=new Date();let _0x3340b7,_0x8e9b92;switch(_0x208b00){case _0x18bd00(0x230):case'YESTERDAY':const _0x29d0d0=new Date(_0x320dea);_0x29d0d0[_0x18bd00(0x238)](_0x29d0d0[_0x18bd00(0x25a)]()-0x1),_0x3340b7=new Date(_0x29d0d0),_0x3340b7[_0x18bd00(0x1d8)](0x0,0x0,0x0,0x0),_0x8e9b92=new Date(_0x29d0d0),_0x8e9b92['setHours'](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x3340b7=new Date(_0x320dea[_0x18bd00(0x255)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x18bd00(0x1be):_0x3340b7=new Date(_0x320dea[_0x18bd00(0x255)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x18bd00(0x229):_0x3340b7=new Date(_0x320dea[_0x18bd00(0x255)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x3340b7=new Date(_0x320dea[_0x18bd00(0x255)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x3d2e7a={'gte':_0x3340b7};_0x8e9b92&&(_0x3d2e7a[_0x18bd00(0x262)]=_0x8e9b92);const [_0x1dc04f,_0x9accfe,_0x19b880,_0x2499d8,_0x134908,_0x542936]=await Promise[_0x18bd00(0x204)]([database_1[_0x18bd00(0x214)][_0x18bd00(0x251)][_0x18bd00(0x20a)]({'where':{'shopId':_0x248d19,'createdAt':_0x3d2e7a}}),database_1[_0x18bd00(0x214)][_0x18bd00(0x251)]['count']({'where':{'shopId':_0x248d19,'status':'COMPLETED','createdAt':_0x3d2e7a}}),database_1[_0x18bd00(0x214)][_0x18bd00(0x251)]['count']({'where':{'shopId':_0x248d19,'status':_0x18bd00(0x201),'createdAt':_0x3d2e7a}}),database_1[_0x18bd00(0x214)][_0x18bd00(0x251)]['count']({'where':{'shopId':_0x248d19,'status':_0x18bd00(0x1f5),'createdAt':_0x3d2e7a}}),database_1[_0x18bd00(0x214)][_0x18bd00(0x251)][_0x18bd00(0x1b9)]({'where':{'shopId':_0x248d19,'createdAt':_0x3d2e7a},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1['default']['payout'][_0x18bd00(0x1b9)]({'where':{'shopId':_0x248d19},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x1e6a0c=_0x134908[_0x18bd00(0x1ba)]((_0x302924,_0x1c3285)=>_0x302924+_0x1c3285[_0x18bd00(0x26b)],0x0),_0x53ca54=_0x134908['filter'](_0x17169b=>_0x17169b['status']===_0x18bd00(0x200))[_0x18bd00(0x1ba)]((_0x51764b,_0x4db551)=>_0x51764b+_0x4db551[_0x18bd00(0x26b)],0x0),_0x4e4b3e=_0x134908[_0x18bd00(0x1f7)](_0x22a94e=>_0x22a94e['status']===_0x18bd00(0x201))['reduce']((_0x53c047,_0x4fd285)=>_0x53c047+_0x4fd285['amount'],0x0),_0x251a89=_0x134908[_0x18bd00(0x1ba)]((_0x1f9075,_0x366f1c)=>{const _0x2c01bf=_0x18bd00;return _0x1f9075[_0x366f1c[_0x2c01bf(0x1f3)]]=(_0x1f9075[_0x366f1c[_0x2c01bf(0x1f3)]]||0x0)+0x1,_0x1f9075;},{}),_0x5cbb18=_0x134908['reduce']((_0x50c46e,_0x27aaf3)=>{const _0x54ae23=_0x18bd00;return _0x50c46e[_0x27aaf3[_0x54ae23(0x25e)]]=(_0x50c46e[_0x27aaf3[_0x54ae23(0x25e)]]||0x0)+0x1,_0x50c46e;},{});return{'totalPayouts':_0x1dc04f,'completedPayouts':_0x9accfe,'pendingPayouts':_0x19b880,'rejectedPayouts':_0x2499d8,'totalAmount':_0x1e6a0c,'completedAmount':_0x53ca54,'pendingAmount':_0x4e4b3e,'payoutsByMethod':_0x251a89,'payoutsByStatus':_0x5cbb18,'recentPayouts':_0x542936[_0x18bd00(0x1ec)](_0x5854a7=>({'id':_0x5854a7['id'],'shopId':_0x248d19,'amount':_0x5854a7[_0x18bd00(0x26b)],'method':_0x5854a7[_0x18bd00(0x1f3)],'status':_0x5854a7['status'],'txid':_0x5854a7[_0x18bd00(0x266)],'createdAt':_0x5854a7[_0x18bd00(0x263)],'paidAt':_0x5854a7[_0x18bd00(0x1c6)]}))};}async['getShopPayoutStats'](_0x111eba){const _0x2f4a14=a62_0x1e18c5;console['log'](_0x2f4a14(0x1fe)+_0x111eba+_0x2f4a14(0x1ea));const _0x593f6e=await database_1['default'][_0x2f4a14(0x205)][_0x2f4a14(0x243)]({'where':{'id':_0x111eba},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x593f6e)throw new Error(_0x2f4a14(0x26a));const _0x5236b5=new Date(),_0x472ba5=new Date(_0x5236b5[_0x2f4a14(0x21f)](),_0x5236b5[_0x2f4a14(0x239)](),0x1),_0x35e91c=new Date(_0x5236b5[_0x2f4a14(0x21f)](),_0x5236b5['getMonth']()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x8c8c6c=await database_1[_0x2f4a14(0x214)]['payout'][_0x2f4a14(0x1da)]({'_sum':{'amount':!![]},'where':{'shopId':_0x111eba,'createdAt':{'gte':_0x472ba5,'lte':_0x35e91c},'status':_0x2f4a14(0x200)}}),_0x16f814=_0x8c8c6c[_0x2f4a14(0x212)][_0x2f4a14(0x26b)]||0x0,_0x5399b0={'availableBalance':Math[_0x2f4a14(0x254)](_0x593f6e[_0x2f4a14(0x1d3)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x593f6e[_0x2f4a14(0x246)]*0x64)/0x64,'awaitingPayout':Math[_0x2f4a14(0x254)](_0x593f6e[_0x2f4a14(0x1d3)]*0x64)/0x64,'thisMonth':Math[_0x2f4a14(0x254)](_0x16f814*0x64)/0x64};return console[_0x2f4a14(0x265)]('üìä\x20Shop\x20'+_0x593f6e[_0x2f4a14(0x1b7)]+_0x2f4a14(0x1ee)),console[_0x2f4a14(0x265)](_0x2f4a14(0x256)+_0x5399b0[_0x2f4a14(0x1f0)]+'\x20USDT\x20(current\x20balance)'),console[_0x2f4a14(0x265)](_0x2f4a14(0x234)+_0x5399b0[_0x2f4a14(0x246)]+_0x2f4a14(0x237)),console[_0x2f4a14(0x265)](_0x2f4a14(0x1d4)+_0x5399b0[_0x2f4a14(0x1fa)]+_0x2f4a14(0x250)),console[_0x2f4a14(0x265)](_0x2f4a14(0x253)+_0x5399b0[_0x2f4a14(0x1d5)]+_0x2f4a14(0x240)),_0x5399b0;}[a62_0x1e18c5(0x268)](_0x35b5f6){const _0x36aa00=a62_0x1e18c5,_0xcd0f7f={'test_gateway':_0x36aa00(0x1c0),'plisio':'Plisio','rapyd':_0x36aa00(0x1df),'noda':'Noda','cointopay':_0x36aa00(0x24a),'klyme_eu':_0x36aa00(0x248),'klyme_gb':_0x36aa00(0x232),'klyme_de':'KLYME\x20DE'};return _0xcd0f7f[_0x35b5f6]||_0x35b5f6;}async[a62_0x1e18c5(0x23c)](_0x5f38ea){const _0x4a4110=a62_0x1e18c5;return this[_0x4a4110(0x219)](_0x5f38ea);}async['getWebhookLogs'](_0x3ee9fa,_0xc9b0fa){const _0x203647=a62_0x1e18c5,{page:_0x5e9dd2,limit:_0x48a0ae,paymentId:_0x2fe1e6}=_0xc9b0fa,_0x3e211b=(_0x5e9dd2-0x1)*_0x48a0ae,_0x39ce16={'shopId':_0x3ee9fa};_0x2fe1e6&&(_0x39ce16[_0x203647(0x259)]=_0x2fe1e6);const [_0x263c25,_0xe3cc9a]=await Promise[_0x203647(0x204)]([database_1[_0x203647(0x214)]['webhookLog'][_0x203647(0x1b9)]({'where':_0x39ce16,'skip':_0x3e211b,'take':_0x48a0ae,'orderBy':{'createdAt':_0x203647(0x20e)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x203647(0x214)][_0x203647(0x1dc)][_0x203647(0x20a)]({'where':_0x39ce16})]);return{'logs':_0x263c25[_0x203647(0x1ec)](_0x3419c1=>({'id':_0x3419c1['id'],'paymentId':_0x3419c1['paymentId'],'shopId':_0x3419c1['shopId'],'event':_0x3419c1['event'],'statusCode':_0x3419c1['statusCode'],'retryCount':_0x3419c1[_0x203647(0x225)],'responseBody':_0x3419c1[_0x203647(0x226)],'createdAt':_0x3419c1[_0x203647(0x263)],'payment':_0x3419c1[_0x203647(0x269)]})),'pagination':{'page':_0x5e9dd2,'limit':_0x48a0ae,'total':_0xe3cc9a,'totalPages':Math['ceil'](_0xe3cc9a/_0x48a0ae)}};}async[a62_0x1e18c5(0x1f6)](_0x18288e,_0x593c44){const _0x2dcc00=a62_0x1e18c5,_0x347ddd=new Date();let _0x4c59a6,_0x3b94b0;switch(_0x593c44['toLowerCase']()){case'day':_0x4c59a6=new Date(_0x347ddd[_0x2dcc00(0x21f)](),_0x347ddd[_0x2dcc00(0x239)](),_0x347ddd[_0x2dcc00(0x25a)](),0x0,0x0,0x0,0x0);break;case _0x2dcc00(0x230):case'YESTERDAY':const _0x218d0e=new Date(_0x347ddd);_0x218d0e[_0x2dcc00(0x238)](_0x218d0e['getDate']()-0x1),_0x4c59a6=new Date(_0x218d0e),_0x4c59a6[_0x2dcc00(0x1d8)](0x0,0x0,0x0,0x0),_0x3b94b0=new Date(_0x218d0e),_0x3b94b0[_0x2dcc00(0x1d8)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x4c59a6=new Date(_0x347ddd['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x2dcc00(0x1be):_0x4c59a6=new Date(_0x347ddd['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x2dcc00(0x229):_0x4c59a6=new Date(_0x347ddd[_0x2dcc00(0x255)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x4c59a6=new Date(_0x347ddd[_0x2dcc00(0x255)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x453d0d={'gte':_0x4c59a6};_0x3b94b0&&(_0x453d0d[_0x2dcc00(0x262)]=_0x3b94b0);const [_0x18b9bf,_0x20a5d3,_0x124aa7,_0x5b17c8,_0x31b0f1]=await Promise[_0x2dcc00(0x204)]([database_1['default'][_0x2dcc00(0x269)]['count']({'where':{'shopId':_0x18288e,'gateway':{'not':_0x2dcc00(0x21c)},'createdAt':_0x453d0d}}),database_1['default'][_0x2dcc00(0x269)][_0x2dcc00(0x20a)]({'where':{'shopId':_0x18288e,'gateway':{'not':_0x2dcc00(0x21c)},'status':_0x2dcc00(0x20f),'createdAt':_0x453d0d}}),database_1[_0x2dcc00(0x214)]['payment'][_0x2dcc00(0x1b9)]({'where':{'shopId':_0x18288e,'gateway':{'not':_0x2dcc00(0x21c)},'status':_0x2dcc00(0x20f),'createdAt':_0x453d0d},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default']['payment'][_0x2dcc00(0x1b9)]({'where':{'shopId':_0x18288e,'gateway':{'not':_0x2dcc00(0x21c)}},'take':0xa,'orderBy':{'createdAt':_0x2dcc00(0x20e)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x2dcc00(0x214)][_0x2dcc00(0x269)][_0x2dcc00(0x1b9)]({'where':{'shopId':_0x18288e,'gateway':{'not':'test_gateway'},'createdAt':_0x453d0d},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x2dcc00(0x216)}})]);let _0x285c6f=0x0;for(const _0x5a7b6a of _0x124aa7){if(_0x5a7b6a[_0x2dcc00(0x1e3)])_0x285c6f+=_0x5a7b6a[_0x2dcc00(0x1e3)];else{const _0x495bfe=await currencyService_1[_0x2dcc00(0x257)][_0x2dcc00(0x1de)](_0x5a7b6a[_0x2dcc00(0x26b)],_0x5a7b6a[_0x2dcc00(0x20d)]);_0x285c6f+=_0x495bfe;}}const _0x2ec220=this[_0x2dcc00(0x223)](_0x31b0f1,_0x4c59a6,_0x3b94b0||_0x347ddd),_0x214b23=_0x18b9bf>0x0?_0x20a5d3/_0x18b9bf*0x64:0x0;return{'totalPayments':_0x18b9bf,'successfulPayments':_0x20a5d3,'totalRevenue':Math[_0x2dcc00(0x254)](_0x285c6f*0x64)/0x64,'conversionRate':Math[_0x2dcc00(0x254)](_0x214b23*0x64)/0x64,'dailyRevenue':_0x2ec220[_0x2dcc00(0x218)],'dailyPayments':_0x2ec220[_0x2dcc00(0x1e9)],'recentPayments':_0x5b17c8[_0x2dcc00(0x1ec)](_0x42a8dc=>({'id':_0x42a8dc['id'],'gateway':_0x42a8dc['gateway'],'amount':_0x42a8dc[_0x2dcc00(0x26b)],'currency':_0x42a8dc[_0x2dcc00(0x20d)],'status':_0x42a8dc[_0x2dcc00(0x25e)],'createdAt':_0x42a8dc[_0x2dcc00(0x263)]}))};}['generateDailyStatistics'](_0x54990f,_0xc991e6,_0x4f71f4){const _0x101d3a=a62_0x1e18c5,_0x332f14=new Map(),_0x382d3b=new Date(_0xc991e6);while(_0x382d3b<=_0x4f71f4){const _0x209c20=_0x382d3b[_0x101d3a(0x1e6)]()[_0x101d3a(0x1ff)]('T')[0x0];_0x332f14[_0x101d3a(0x242)](_0x209c20,{'revenue':0x0,'count':0x0}),_0x382d3b[_0x101d3a(0x238)](_0x382d3b['getDate']()+0x1);}for(const _0x1a77f2 of _0x54990f){const _0x2c8f74=_0x1a77f2[_0x101d3a(0x263)][_0x101d3a(0x1e6)]()[_0x101d3a(0x1ff)]('T')[0x0],_0x1527ad=_0x332f14['get'](_0x2c8f74);_0x1527ad&&(_0x1527ad[_0x101d3a(0x20a)]+=0x1,_0x1a77f2[_0x101d3a(0x25e)]===_0x101d3a(0x20f)&&_0x1a77f2[_0x101d3a(0x1e3)]&&(_0x1527ad[_0x101d3a(0x24c)]+=_0x1a77f2[_0x101d3a(0x1e3)]));}const _0x1b8f68=[],_0x399a50=[];for(const [_0x2e0503,_0x3d48b4]of _0x332f14){_0x1b8f68[_0x101d3a(0x25d)]({'date':_0x2e0503,'amount':Math[_0x101d3a(0x254)](_0x3d48b4[_0x101d3a(0x24c)]*0x64)/0x64}),_0x399a50['push']({'date':_0x2e0503,'count':_0x3d48b4['count']});}return{'dailyRevenue':_0x1b8f68,'dailyPayments':_0x399a50};}}exports['ShopService']=ShopService;