'use strict';const a60_0x4fbb48=a60_0x4879;(function(_0xa596e4,_0x5112a5){const _0x3bc802=a60_0x4879,_0x4a8537=_0xa596e4();while(!![]){try{const _0x5a5d37=-parseInt(_0x3bc802(0x24c))/0x1*(-parseInt(_0x3bc802(0x1e7))/0x2)+parseInt(_0x3bc802(0x267))/0x3*(parseInt(_0x3bc802(0x1dd))/0x4)+-parseInt(_0x3bc802(0x233))/0x5*(parseInt(_0x3bc802(0x1e5))/0x6)+-parseInt(_0x3bc802(0x25a))/0x7+-parseInt(_0x3bc802(0x204))/0x8*(-parseInt(_0x3bc802(0x230))/0x9)+-parseInt(_0x3bc802(0x23a))/0xa+-parseInt(_0x3bc802(0x1de))/0xb;if(_0x5a5d37===_0x5112a5)break;else _0x4a8537['push'](_0x4a8537['shift']());}catch(_0x232c68){_0x4a8537['push'](_0x4a8537['shift']());}}}(a60_0x2917,0xaa91b));var __importDefault=this&&this['__importDefault']||function(_0x42927f){const _0xd754f8=a60_0x4879;return _0x42927f&&_0x42927f[_0xd754f8(0x1fa)]?_0x42927f:{'default':_0x42927f};};Object[a60_0x4fbb48(0x206)](exports,'__esModule',{'value':!![]}),exports[a60_0x4fbb48(0x209)]=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require(a60_0x4fbb48(0x278)),paymentService_1=require('./paymentService');function a60_0x4879(_0x3a9056,_0x58448f){const _0x29170d=a60_0x2917();return a60_0x4879=function(_0x4879d9,_0x2c9bf9){_0x4879d9=_0x4879d9-0x1d3;let _0x1e563a=_0x29170d[_0x4879d9];return _0x1e563a;},a60_0x4879(_0x3a9056,_0x58448f);}class ShopService{constructor(){const _0xc5411a=a60_0x4fbb48;this[_0xc5411a(0x272)]=new paymentService_1[(_0xc5411a(0x21c))]();}async[a60_0x4fbb48(0x255)](_0x6ca584){const _0x32add3=a60_0x4fbb48,_0x1a95ff=await database_1['default'][_0x32add3(0x229)][_0x32add3(0x25f)]({'where':{'id':_0x6ca584},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x1a95ff)throw new Error(_0x32add3(0x207));let _0x102322=[];if(_0x1a95ff[_0x32add3(0x1e2)]?.[_0x32add3(0x1e6)])try{_0x102322=Array[_0x32add3(0x279)](_0x1a95ff[_0x32add3(0x1e2)][_0x32add3(0x1e6)])?_0x1a95ff['settings'][_0x32add3(0x1e6)]:JSON['parse'](_0x1a95ff[_0x32add3(0x1e2)]['webhookEvents']);}catch(_0x1ebecd){console[_0x32add3(0x1ec)](_0x32add3(0x1dc),_0x1ebecd),_0x102322=[];}return{'id':_0x1a95ff['id'],'fullName':_0x1a95ff[_0x32add3(0x1db)],'username':_0x1a95ff[_0x32add3(0x205)],'telegramId':_0x1a95ff[_0x32add3(0x21e)],'merchantUrl':_0x1a95ff[_0x32add3(0x20b)],'gateways':_0x1a95ff[_0x32add3(0x203)]?JSON['parse'](_0x1a95ff[_0x32add3(0x203)]):null,'gatewaySettings':_0x1a95ff['gatewaySettings']?JSON[_0x32add3(0x277)](_0x1a95ff[_0x32add3(0x228)]):null,'publicKey':_0x1a95ff[_0x32add3(0x22d)],'webhookUrl':_0x1a95ff['settings']?.[_0x32add3(0x1d6)]||null,'webhookEvents':_0x102322,'wallets':{'usdtPolygonWallet':_0x1a95ff[_0x32add3(0x24b)],'usdtTrcWallet':_0x1a95ff[_0x32add3(0x237)],'usdtErcWallet':_0x1a95ff[_0x32add3(0x21f)],'usdcPolygonWallet':_0x1a95ff[_0x32add3(0x202)]},'status':_0x1a95ff[_0x32add3(0x261)],'createdAt':_0x1a95ff[_0x32add3(0x25e)]};}async[a60_0x4fbb48(0x1ea)](_0x26011d,_0xb0062a){const _0x3a8a3a=a60_0x4fbb48,_0x6a19a4={};_0xb0062a[_0x3a8a3a(0x256)]&&(_0x6a19a4[_0x3a8a3a(0x1db)]=_0xb0062a['fullName']);_0xb0062a[_0x3a8a3a(0x245)]!==undefined&&(_0x6a19a4[_0x3a8a3a(0x21e)]=_0xb0062a['telegramId']||null);_0xb0062a['merchantUrl']&&(_0x6a19a4[_0x3a8a3a(0x20b)]=_0xb0062a[_0x3a8a3a(0x200)]);_0xb0062a[_0x3a8a3a(0x1e4)]&&(_0x6a19a4['paymentGateways']=JSON[_0x3a8a3a(0x22f)](_0xb0062a[_0x3a8a3a(0x1e4)]));_0xb0062a[_0x3a8a3a(0x228)]&&(_0x6a19a4['gatewaySettings']=JSON['stringify'](_0xb0062a['gatewaySettings']));_0xb0062a[_0x3a8a3a(0x1e8)]&&(_0xb0062a['wallets'][_0x3a8a3a(0x24b)]!==undefined&&(_0x6a19a4[_0x3a8a3a(0x24b)]=_0xb0062a[_0x3a8a3a(0x1e8)][_0x3a8a3a(0x24b)]||null),_0xb0062a['wallets'][_0x3a8a3a(0x237)]!==undefined&&(_0x6a19a4[_0x3a8a3a(0x237)]=_0xb0062a[_0x3a8a3a(0x1e8)]['usdtTrcWallet']||null),_0xb0062a[_0x3a8a3a(0x1e8)][_0x3a8a3a(0x21f)]!==undefined&&(_0x6a19a4[_0x3a8a3a(0x21f)]=_0xb0062a[_0x3a8a3a(0x1e8)]['usdtErcWallet']||null),_0xb0062a[_0x3a8a3a(0x1e8)]['usdcPolygonWallet']!==undefined&&(_0x6a19a4[_0x3a8a3a(0x202)]=_0xb0062a[_0x3a8a3a(0x1e8)]['usdcPolygonWallet']||null));const _0x337f60=await database_1[_0x3a8a3a(0x274)]['shop'][_0x3a8a3a(0x223)]({'where':{'id':_0x26011d},'data':_0x6a19a4,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x55da8f=[];if(_0x337f60[_0x3a8a3a(0x1e2)]?.['webhookEvents'])try{_0x55da8f=Array['isArray'](_0x337f60[_0x3a8a3a(0x1e2)][_0x3a8a3a(0x1e6)])?_0x337f60[_0x3a8a3a(0x1e2)]['webhookEvents']:JSON['parse'](_0x337f60[_0x3a8a3a(0x1e2)][_0x3a8a3a(0x1e6)]);}catch(_0x12050d){console[_0x3a8a3a(0x1ec)]('Error\x20parsing\x20webhook\x20events:',_0x12050d),_0x55da8f=[];}return{'id':_0x337f60['id'],'fullName':_0x337f60[_0x3a8a3a(0x1db)],'username':_0x337f60[_0x3a8a3a(0x205)],'telegramId':_0x337f60[_0x3a8a3a(0x21e)],'merchantUrl':_0x337f60[_0x3a8a3a(0x20b)],'gateways':_0x337f60[_0x3a8a3a(0x203)]?JSON[_0x3a8a3a(0x277)](_0x337f60[_0x3a8a3a(0x203)]):null,'gatewaySettings':_0x337f60[_0x3a8a3a(0x228)]?JSON[_0x3a8a3a(0x277)](_0x337f60['gatewaySettings']):null,'publicKey':_0x337f60[_0x3a8a3a(0x22d)],'webhookUrl':_0x337f60[_0x3a8a3a(0x1e2)]?.[_0x3a8a3a(0x1d6)]||null,'webhookEvents':_0x55da8f,'wallets':{'usdtPolygonWallet':_0x337f60['usdtPolygonWallet'],'usdtTrcWallet':_0x337f60['usdtTrcWallet'],'usdtErcWallet':_0x337f60[_0x3a8a3a(0x21f)],'usdcPolygonWallet':_0x337f60['usdcPolygonWallet']},'status':_0x337f60[_0x3a8a3a(0x261)],'createdAt':_0x337f60['createdAt']};}async['updateWallets'](_0x43f5ee,_0x27aabb){const _0x548d9c=a60_0x4fbb48,_0xf2c5eb={};_0x27aabb[_0x548d9c(0x24b)]!==undefined&&(_0xf2c5eb[_0x548d9c(0x24b)]=_0x27aabb[_0x548d9c(0x24b)]||null),_0x27aabb[_0x548d9c(0x237)]!==undefined&&(_0xf2c5eb['usdtTrcWallet']=_0x27aabb[_0x548d9c(0x237)]||null),_0x27aabb['usdtErcWallet']!==undefined&&(_0xf2c5eb['usdtErcWallet']=_0x27aabb[_0x548d9c(0x21f)]||null),_0x27aabb[_0x548d9c(0x202)]!==undefined&&(_0xf2c5eb[_0x548d9c(0x202)]=_0x27aabb['usdcPolygonWallet']||null),await database_1[_0x548d9c(0x274)][_0x548d9c(0x229)]['update']({'where':{'id':_0x43f5ee},'data':_0xf2c5eb});}async[a60_0x4fbb48(0x1f6)](_0x4977f8){const _0x292b58=a60_0x4fbb48,_0x23887a=await database_1[_0x292b58(0x274)][_0x292b58(0x229)][_0x292b58(0x25f)]({'where':{'id':_0x4977f8},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x23887a?.['settings']?.[_0x292b58(0x1d6)])throw new Error(_0x292b58(0x268));const _0x17c2fe={'event':_0x292b58(0x217),'payment':{'id':_0x292b58(0x1e0),'order_id':'test_order_123','gateway':_0x292b58(0x217),'amount':0x64,'currency':'USD','status':_0x292b58(0x1eb),'created_at':new Date()['toISOString']()}};try{const _0x4514aa=await fetch(_0x23887a[_0x292b58(0x1e2)]['webhookUrl'],{'method':_0x292b58(0x24d),'headers':{'Content-Type':_0x292b58(0x234),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON[_0x292b58(0x22f)](_0x17c2fe)});return _0x4514aa['ok']?{'success':!![],'message':_0x292b58(0x1f8)+_0x4514aa[_0x292b58(0x261)]+')'}:{'success':![],'message':_0x292b58(0x249)+_0x4514aa[_0x292b58(0x261)]+'\x20'+_0x4514aa[_0x292b58(0x20c)]};}catch(_0x3c0d72){return{'success':![],'message':_0x292b58(0x1f0)+(_0x3c0d72 instanceof Error?_0x3c0d72[_0x292b58(0x21a)]:_0x292b58(0x262))};}}async[a60_0x4fbb48(0x1f4)](_0x3081fe){const _0x2bbb85=a60_0x4fbb48;return this[_0x2bbb85(0x272)][_0x2bbb85(0x227)]({'public_key':'','gateway':_0x3081fe['gateway'],'order_id':undefined,'amount':_0x3081fe[_0x2bbb85(0x1ed)],'currency':_0x3081fe[_0x2bbb85(0x254)],'source_currency':_0x3081fe[_0x2bbb85(0x265)],'usage':_0x3081fe[_0x2bbb85(0x235)],'expires_at':_0x3081fe[_0x2bbb85(0x27c)]?.[_0x2bbb85(0x238)](),'success_url':_0x3081fe['redirectUrl'],'fail_url':_0x3081fe[_0x2bbb85(0x212)],'customer_email':_0x3081fe[_0x2bbb85(0x1d3)],'customer_name':_0x3081fe[_0x2bbb85(0x1f5)],'country':_0x3081fe[_0x2bbb85(0x269)],'language':_0x3081fe['language'],'amount_is_editable':_0x3081fe[_0x2bbb85(0x260)],'max_payments':_0x3081fe[_0x2bbb85(0x23e)],'customer':_0x3081fe[_0x2bbb85(0x21b)]});}async['getPayments'](_0x5ab3c1,_0xdb28f0){const _0x4e9f1d=a60_0x4fbb48;return this[_0x4e9f1d(0x272)][_0x4e9f1d(0x22a)](_0x5ab3c1,_0xdb28f0);}async[a60_0x4fbb48(0x23b)](_0x4018eb,_0x130f39){const _0x872f1a=a60_0x4fbb48;return this[_0x872f1a(0x272)]['getPaymentByShopAndId'](_0x4018eb,_0x130f39);}async['updatePayment'](_0x204fc6,_0x47ca34,_0x192f7e){const _0x33b582=a60_0x4fbb48,_0x2e6f22=await database_1[_0x33b582(0x274)][_0x33b582(0x20a)][_0x33b582(0x215)]({'where':{'id':_0x47ca34,'shopId':_0x204fc6}});if(!_0x2e6f22)throw new Error('Payment\x20not\x20found');const _0x1dd9f6=await database_1[_0x33b582(0x274)][_0x33b582(0x20a)][_0x33b582(0x223)]({'where':{'id':_0x47ca34},'data':{..._0x192f7e,'updatedAt':new Date()}});return _0x1dd9f6;}async[a60_0x4fbb48(0x1fb)](_0x22cf40,_0x344b35){const _0x1a7aa3=a60_0x4fbb48,_0x29559d=await database_1[_0x1a7aa3(0x274)][_0x1a7aa3(0x20a)][_0x1a7aa3(0x215)]({'where':{'id':_0x344b35,'shopId':_0x22cf40}});if(!_0x29559d)throw new Error(_0x1a7aa3(0x275));await database_1['default'][_0x1a7aa3(0x20a)][_0x1a7aa3(0x1d9)]({'where':{'id':_0x344b35}});}[a60_0x4fbb48(0x26a)](_0x567ea2){const _0x4b060d=a60_0x4fbb48,_0x26321d={'polygon':_0x4b060d(0x1fe),'trc20':'USDT\x20TRC20','erc20':_0x4b060d(0x20d),'bsc':_0x4b060d(0x226),'polygon_usdc':_0x4b060d(0x222)};return _0x26321d[_0x567ea2]||_0x567ea2;}async['getPayouts'](_0x2a209d,_0x5d128a){const _0x30108c=a60_0x4fbb48,{page:_0x40513a,limit:_0x3988e9,status:_0x7c754c,method:_0x2732ba,network:_0x4e545c,dateFrom:_0x1d0365,dateTo:_0x4d915,periodFrom:_0x414893,periodTo:_0x20427d}=_0x5d128a,_0x5736ca=(_0x40513a-0x1)*_0x3988e9;console['log'](_0x30108c(0x23c),_0x5d128a);const _0x43a470={'shopId':_0x2a209d};_0x7c754c&&(_0x43a470[_0x30108c(0x261)]=_0x7c754c['toUpperCase'](),console[_0x30108c(0x1d8)]('📊\x20Status\x20filter:\x20'+_0x7c754c['toUpperCase']()));if(_0x2732ba)_0x43a470[_0x30108c(0x1d4)]=_0x2732ba,console[_0x30108c(0x1d8)](_0x30108c(0x25b)+_0x2732ba);else _0x4e545c&&(_0x43a470[_0x30108c(0x1d4)]=_0x4e545c,console['log'](_0x30108c(0x244)+_0x4e545c));if(_0x1d0365||_0x4d915||_0x414893||_0x20427d){_0x43a470[_0x30108c(0x25e)]={};if(_0x414893){const _0x5a3433=new Date(_0x414893);_0x5a3433[_0x30108c(0x271)](0x0,0x0,0x0,0x0),_0x43a470[_0x30108c(0x25e)][_0x30108c(0x216)]=_0x5a3433,console['log'](_0x30108c(0x239)+_0x5a3433[_0x30108c(0x238)]());}else{if(_0x1d0365){const _0x48046c=new Date(_0x1d0365);_0x48046c[_0x30108c(0x271)](0x0,0x0,0x0,0x0),_0x43a470['createdAt'][_0x30108c(0x216)]=_0x48046c,console[_0x30108c(0x1d8)](_0x30108c(0x1e1)+_0x48046c[_0x30108c(0x238)]());}}if(_0x20427d){const _0x841781=new Date(_0x20427d);_0x841781['setHours'](0x17,0x3b,0x3b,0x3e7),_0x43a470[_0x30108c(0x25e)][_0x30108c(0x27a)]=_0x841781,console[_0x30108c(0x1d8)](_0x30108c(0x1ee)+_0x841781[_0x30108c(0x238)]());}else{if(_0x4d915){const _0x6ae930=new Date(_0x4d915);_0x6ae930[_0x30108c(0x271)](0x17,0x3b,0x3b,0x3e7),_0x43a470[_0x30108c(0x25e)]['lte']=_0x6ae930,console['log'](_0x30108c(0x26d)+_0x6ae930[_0x30108c(0x238)]());}}}console['log'](_0x30108c(0x24e),JSON[_0x30108c(0x22f)](_0x43a470,null,0x2));const [_0x278e84,_0x2442ba]=await Promise[_0x30108c(0x26b)]([database_1['default'][_0x30108c(0x26c)][_0x30108c(0x1f1)]({'where':_0x43a470,'skip':_0x5736ca,'take':_0x3988e9,'orderBy':{'createdAt':_0x30108c(0x253)},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1['default']['payout'][_0x30108c(0x20f)]({'where':_0x43a470})]);return{'payouts':_0x278e84[_0x30108c(0x27b)](_0x52b0b6=>{const _0x873dc5=_0x30108c;let _0x35d1cf=null;switch(_0x52b0b6[_0x873dc5(0x1d4)]){case _0x873dc5(0x1f7):_0x35d1cf=_0x52b0b6[_0x873dc5(0x229)][_0x873dc5(0x24b)];break;case'trc20':_0x35d1cf=_0x52b0b6[_0x873dc5(0x229)][_0x873dc5(0x237)];break;case'erc20':_0x35d1cf=_0x52b0b6[_0x873dc5(0x229)][_0x873dc5(0x21f)];break;case _0x873dc5(0x270):_0x35d1cf=_0x52b0b6[_0x873dc5(0x229)][_0x873dc5(0x202)];break;}return{'id':_0x52b0b6['id'],'amount':_0x52b0b6[_0x873dc5(0x1ed)],'network':this[_0x873dc5(0x26a)](_0x52b0b6[_0x873dc5(0x1d4)]),'wallet':_0x35d1cf,'status':_0x52b0b6[_0x873dc5(0x261)],'txid':_0x52b0b6[_0x873dc5(0x276)],'notes':_0x52b0b6[_0x873dc5(0x1d5)],'periodFrom':_0x52b0b6['periodFrom'],'periodTo':_0x52b0b6['periodTo'],'createdAt':_0x52b0b6['createdAt'],'paidAt':_0x52b0b6[_0x873dc5(0x263)]};}),'pagination':{'page':_0x40513a,'limit':_0x3988e9,'total':_0x2442ba,'totalPages':Math[_0x30108c(0x21d)](_0x2442ba/_0x3988e9)}};}async[a60_0x4fbb48(0x25d)](_0x21bcf0,_0x50e17c){const _0xa7945d=a60_0x4fbb48,_0x39b328=await database_1[_0xa7945d(0x274)]['payout'][_0xa7945d(0x215)]({'where':{'id':_0x50e17c,'shopId':_0x21bcf0}});if(!_0x39b328)return null;return{'id':_0x39b328['id'],'amount':_0x39b328[_0xa7945d(0x1ed)],'network':_0x39b328[_0xa7945d(0x1d4)],'status':_0x39b328[_0xa7945d(0x261)],'txid':_0x39b328['txid'],'notes':_0x39b328['notes'],'createdAt':_0x39b328['createdAt'],'paidAt':_0x39b328[_0xa7945d(0x263)]};}async['getPayoutStatistics'](_0x588725,_0x1b0486){const _0x100862=a60_0x4fbb48,_0x3a729e=new Date();let _0x71f69a,_0x18cba8;switch(_0x1b0486){case _0x100862(0x232):case _0x100862(0x264):const _0x224f48=new Date(_0x3a729e);_0x224f48[_0x100862(0x247)](_0x224f48['getDate']()-0x1),_0x71f69a=new Date(_0x224f48),_0x71f69a[_0x100862(0x271)](0x0,0x0,0x0,0x0),_0x18cba8=new Date(_0x224f48),_0x18cba8[_0x100862(0x271)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x71f69a=new Date(_0x3a729e['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x100862(0x220):_0x71f69a=new Date(_0x3a729e[_0x100862(0x1da)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case'90d':_0x71f69a=new Date(_0x3a729e[_0x100862(0x1da)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x71f69a=new Date(_0x3a729e[_0x100862(0x1da)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x52093f={'gte':_0x71f69a};_0x18cba8&&(_0x52093f[_0x100862(0x27a)]=_0x18cba8);const [_0x119533,_0x45a536,_0x3abe8b,_0x3e8d04,_0x4f16a0,_0x1100b4]=await Promise[_0x100862(0x26b)]([database_1[_0x100862(0x274)][_0x100862(0x26c)][_0x100862(0x20f)]({'where':{'shopId':_0x588725,'createdAt':_0x52093f}}),database_1[_0x100862(0x274)][_0x100862(0x26c)]['count']({'where':{'shopId':_0x588725,'status':_0x100862(0x1f9),'createdAt':_0x52093f}}),database_1['default'][_0x100862(0x26c)][_0x100862(0x20f)]({'where':{'shopId':_0x588725,'status':_0x100862(0x22c),'createdAt':_0x52093f}}),database_1[_0x100862(0x274)][_0x100862(0x26c)]['count']({'where':{'shopId':_0x588725,'status':_0x100862(0x1df),'createdAt':_0x52093f}}),database_1[_0x100862(0x274)]['payout'][_0x100862(0x1f1)]({'where':{'shopId':_0x588725,'createdAt':_0x52093f},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1['default'][_0x100862(0x26c)][_0x100862(0x1f1)]({'where':{'shopId':_0x588725},'take':0xa,'orderBy':{'createdAt':_0x100862(0x253)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x45aaf5=_0x4f16a0['reduce']((_0x3cd70e,_0x2685c4)=>_0x3cd70e+_0x2685c4[_0x100862(0x1ed)],0x0),_0xa58743=_0x4f16a0['filter'](_0xe6958d=>_0xe6958d[_0x100862(0x261)]===_0x100862(0x1f9))['reduce']((_0x1696c7,_0x525f88)=>_0x1696c7+_0x525f88[_0x100862(0x1ed)],0x0),_0x334e4d=_0x4f16a0[_0x100862(0x24f)](_0x1543bb=>_0x1543bb[_0x100862(0x261)]===_0x100862(0x22c))['reduce']((_0x281466,_0x570243)=>_0x281466+_0x570243[_0x100862(0x1ed)],0x0),_0x2a9d7f=_0x4f16a0[_0x100862(0x213)]((_0x327187,_0x561ab7)=>{const _0xf19283=_0x100862;return _0x327187[_0x561ab7['network']]=(_0x327187[_0x561ab7[_0xf19283(0x1d4)]]||0x0)+0x1,_0x327187;},{}),_0x31af5d=_0x4f16a0[_0x100862(0x213)]((_0x50dd71,_0x2ce006)=>{const _0x4e17d5=_0x100862;return _0x50dd71[_0x2ce006['status']]=(_0x50dd71[_0x2ce006[_0x4e17d5(0x261)]]||0x0)+0x1,_0x50dd71;},{});return{'totalPayouts':_0x119533,'completedPayouts':_0x45a536,'pendingPayouts':_0x3abe8b,'rejectedPayouts':_0x3e8d04,'totalAmount':_0x45aaf5,'completedAmount':_0xa58743,'pendingAmount':_0x334e4d,'payoutsByMethod':_0x2a9d7f,'payoutsByStatus':_0x31af5d,'recentPayouts':_0x1100b4[_0x100862(0x27b)](_0x541e83=>({'id':_0x541e83['id'],'shopId':_0x588725,'amount':_0x541e83[_0x100862(0x1ed)],'method':_0x541e83['network'],'status':_0x541e83[_0x100862(0x261)],'txid':_0x541e83[_0x100862(0x276)],'createdAt':_0x541e83[_0x100862(0x25e)],'paidAt':_0x541e83['paidAt']}))};}async[a60_0x4fbb48(0x1f3)](_0x3f24c3){const _0x5d159d=a60_0x4fbb48;console[_0x5d159d(0x1d8)]('📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x3f24c3+_0x5d159d(0x231));const _0x505675=await database_1[_0x5d159d(0x274)]['shop'][_0x5d159d(0x25f)]({'where':{'id':_0x3f24c3},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x505675)throw new Error(_0x5d159d(0x207));const _0x2fa1e8=new Date(),_0x4dec2e=new Date(_0x2fa1e8[_0x5d159d(0x241)](),_0x2fa1e8[_0x5d159d(0x225)](),0x1),_0x4e65ac=new Date(_0x2fa1e8['getFullYear'](),_0x2fa1e8[_0x5d159d(0x225)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x43f2fa=await database_1[_0x5d159d(0x274)][_0x5d159d(0x26c)][_0x5d159d(0x250)]({'_sum':{'amount':!![]},'where':{'shopId':_0x3f24c3,'createdAt':{'gte':_0x4dec2e,'lte':_0x4e65ac},'status':_0x5d159d(0x1f9)}}),_0x417758=_0x43f2fa['_sum'][_0x5d159d(0x1ed)]||0x0,_0x4cc91f={'availableBalance':Math[_0x5d159d(0x243)](_0x505675[_0x5d159d(0x218)]*0x64)/0x64,'totalPaidOut':Math[_0x5d159d(0x243)](_0x505675[_0x5d159d(0x22e)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x505675['balance']*0x64)/0x64,'thisMonth':Math[_0x5d159d(0x243)](_0x417758*0x64)/0x64};return console[_0x5d159d(0x1d8)](_0x5d159d(0x23d)+_0x505675['username']+'\x20payout\x20statistics\x20calculated:'),console[_0x5d159d(0x1d8)](_0x5d159d(0x259)+_0x4cc91f[_0x5d159d(0x257)]+_0x5d159d(0x248)),console[_0x5d159d(0x1d8)]('\x20\x20\x20💰\x20Total\x20paid\x20out:\x20'+_0x4cc91f[_0x5d159d(0x22e)]+_0x5d159d(0x210)),console['log']('\x20\x20\x20⏳\x20Awaiting\x20payout:\x20'+_0x4cc91f[_0x5d159d(0x266)]+'\x20USDT\x20(current\x20balance)'),console[_0x5d159d(0x1d8)]('\x20\x20\x20📅\x20This\x20month:\x20'+_0x4cc91f[_0x5d159d(0x214)]+'\x20USDT'),_0x4cc91f;}['getGatewayDisplayName'](_0x50a67f){const _0x132c95=a60_0x4fbb48,_0x238a9e={'test_gateway':_0x132c95(0x208),'plisio':_0x132c95(0x26e),'rapyd':_0x132c95(0x211),'noda':_0x132c95(0x242),'cointopay':_0x132c95(0x1fd),'klyme_eu':_0x132c95(0x1fc),'klyme_gb':_0x132c95(0x221),'klyme_de':_0x132c95(0x27d)};return _0x238a9e[_0x50a67f]||_0x50a67f;}async[a60_0x4fbb48(0x224)](_0x17b94e){const _0x3fd7dd=a60_0x4fbb48;return this[_0x3fd7dd(0x1f3)](_0x17b94e);}async[a60_0x4fbb48(0x251)](_0x105021,_0x528761){const _0x13cb95=a60_0x4fbb48,{page:_0x2b58fa,limit:_0x45d05b,paymentId:_0x92f12f}=_0x528761,_0x474bbb=(_0x2b58fa-0x1)*_0x45d05b,_0x10f398={'shopId':_0x105021};_0x92f12f&&(_0x10f398['paymentId']=_0x92f12f);const [_0x1038d7,_0x58033e]=await Promise[_0x13cb95(0x26b)]([database_1[_0x13cb95(0x274)][_0x13cb95(0x1ff)]['findMany']({'where':_0x10f398,'skip':_0x474bbb,'take':_0x45d05b,'orderBy':{'createdAt':_0x13cb95(0x253)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x13cb95(0x274)][_0x13cb95(0x1ff)]['count']({'where':_0x10f398})]);return{'logs':_0x1038d7[_0x13cb95(0x27b)](_0x884fe1=>({'id':_0x884fe1['id'],'paymentId':_0x884fe1[_0x13cb95(0x20e)],'shopId':_0x884fe1[_0x13cb95(0x258)],'event':_0x884fe1[_0x13cb95(0x252)],'statusCode':_0x884fe1[_0x13cb95(0x1e3)],'retryCount':_0x884fe1[_0x13cb95(0x246)],'responseBody':_0x884fe1[_0x13cb95(0x1ef)],'createdAt':_0x884fe1[_0x13cb95(0x25e)],'payment':_0x884fe1[_0x13cb95(0x20a)]})),'pagination':{'page':_0x2b58fa,'limit':_0x45d05b,'total':_0x58033e,'totalPages':Math[_0x13cb95(0x21d)](_0x58033e/_0x45d05b)}};}async[a60_0x4fbb48(0x1e9)](_0xd7ff3e,_0x2c710c){const _0x1881f0=a60_0x4fbb48,_0xd6d761=new Date();let _0x271028,_0x44040f;switch(_0x2c710c[_0x1881f0(0x236)]()){case _0x1881f0(0x1d7):_0x271028=new Date(_0xd6d761[_0x1881f0(0x241)](),_0xd6d761[_0x1881f0(0x225)](),_0xd6d761['getDate'](),0x0,0x0,0x0,0x0);break;case _0x1881f0(0x232):case _0x1881f0(0x264):const _0x13681b=new Date(_0xd6d761);_0x13681b['setDate'](_0x13681b[_0x1881f0(0x240)]()-0x1),_0x271028=new Date(_0x13681b),_0x271028['setHours'](0x0,0x0,0x0,0x0),_0x44040f=new Date(_0x13681b),_0x44040f[_0x1881f0(0x271)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x271028=new Date(_0xd6d761[_0x1881f0(0x1da)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x1881f0(0x220):_0x271028=new Date(_0xd6d761[_0x1881f0(0x1da)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x1881f0(0x201):_0x271028=new Date(_0xd6d761[_0x1881f0(0x1da)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x271028=new Date(_0xd6d761[_0x1881f0(0x1da)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0xb52264={'gte':_0x271028};_0x44040f&&(_0xb52264[_0x1881f0(0x27a)]=_0x44040f);const [_0x27b25a,_0x1d55d6,_0x1d65ca,_0x1afb3b,_0x2bea12]=await Promise[_0x1881f0(0x26b)]([database_1[_0x1881f0(0x274)][_0x1881f0(0x20a)]['count']({'where':{'shopId':_0xd7ff3e,'gateway':{'not':_0x1881f0(0x273)},'createdAt':_0xb52264}}),database_1[_0x1881f0(0x274)][_0x1881f0(0x20a)][_0x1881f0(0x20f)]({'where':{'shopId':_0xd7ff3e,'gateway':{'not':_0x1881f0(0x273)},'status':_0x1881f0(0x22b),'createdAt':_0xb52264}}),database_1['default'][_0x1881f0(0x20a)][_0x1881f0(0x1f1)]({'where':{'shopId':_0xd7ff3e,'gateway':{'not':_0x1881f0(0x273)},'status':_0x1881f0(0x22b),'createdAt':_0xb52264},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1['default'][_0x1881f0(0x20a)][_0x1881f0(0x1f1)]({'where':{'shopId':_0xd7ff3e,'gateway':{'not':'test_gateway'}},'take':0xa,'orderBy':{'createdAt':_0x1881f0(0x253)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x1881f0(0x274)]['payment']['findMany']({'where':{'shopId':_0xd7ff3e,'gateway':{'not':_0x1881f0(0x273)},'createdAt':_0xb52264},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x1bc8d7=0x0;for(const _0x4d056d of _0x1d65ca){if(_0x4d056d[_0x1881f0(0x24a)])_0x1bc8d7+=_0x4d056d['amountUSDT'];else{const _0x54fa52=await currencyService_1[_0x1881f0(0x219)][_0x1881f0(0x26f)](_0x4d056d[_0x1881f0(0x1ed)],_0x4d056d[_0x1881f0(0x254)]);_0x1bc8d7+=_0x54fa52;}}const _0x267741=this[_0x1881f0(0x1f2)](_0x2bea12,_0x271028,_0x44040f||_0xd6d761),_0x31c24c=_0x27b25a>0x0?_0x1d55d6/_0x27b25a*0x64:0x0;return{'totalPayments':_0x27b25a,'successfulPayments':_0x1d55d6,'totalRevenue':Math[_0x1881f0(0x243)](_0x1bc8d7*0x64)/0x64,'conversionRate':Math['round'](_0x31c24c*0x64)/0x64,'dailyRevenue':_0x267741['dailyRevenue'],'dailyPayments':_0x267741['dailyPayments'],'recentPayments':_0x1afb3b[_0x1881f0(0x27b)](_0x3a61b7=>({'id':_0x3a61b7['id'],'gateway':_0x3a61b7['gateway'],'amount':_0x3a61b7[_0x1881f0(0x1ed)],'currency':_0x3a61b7[_0x1881f0(0x254)],'status':_0x3a61b7[_0x1881f0(0x261)],'createdAt':_0x3a61b7['createdAt']}))};}[a60_0x4fbb48(0x1f2)](_0xd99bdd,_0x400d1f,_0x3a9eff){const _0x3aced8=a60_0x4fbb48,_0x297f4c=new Map(),_0x2bd304=new Date(_0x400d1f);while(_0x2bd304<=_0x3a9eff){const _0x53590d=_0x2bd304[_0x3aced8(0x238)]()['split']('T')[0x0];_0x297f4c['set'](_0x53590d,{'revenue':0x0,'count':0x0}),_0x2bd304[_0x3aced8(0x247)](_0x2bd304['getDate']()+0x1);}for(const _0x1c3ed3 of _0xd99bdd){const _0x53ea66=_0x1c3ed3['createdAt']['toISOString']()[_0x3aced8(0x25c)]('T')[0x0],_0x29280b=_0x297f4c['get'](_0x53ea66);_0x29280b&&(_0x29280b[_0x3aced8(0x20f)]+=0x1,_0x1c3ed3['status']===_0x3aced8(0x22b)&&_0x1c3ed3[_0x3aced8(0x24a)]&&(_0x29280b[_0x3aced8(0x23f)]+=_0x1c3ed3['amountUSDT']));}const _0x28dde5=[],_0x564732=[];for(const [_0x4cc4c7,_0x360166]of _0x297f4c){_0x28dde5['push']({'date':_0x4cc4c7,'amount':Math['round'](_0x360166[_0x3aced8(0x23f)]*0x64)/0x64}),_0x564732['push']({'date':_0x4cc4c7,'count':_0x360166['count']});}return{'dailyRevenue':_0x28dde5,'dailyPayments':_0x564732};}}exports[a60_0x4fbb48(0x209)]=ShopService;function a60_0x2917(){const _0x5681a0=['updateShopProfile','paid','error','amount','📅\x20Period\x20end:\x20','responseBody','Failed\x20to\x20send\x20webhook:\x20','findMany','generateDailyStatistics','getShopPayoutStats','createPayment','customerName','testWebhook','polygon','Test\x20webhook\x20sent\x20successfully\x20(','COMPLETED','__esModule','deletePayment','KLYME\x20EU','CoinToPay','USDT\x20Polygon','webhookLog','merchantUrl','90d','usdcPolygonWallet','paymentGateways','16jfovlt','username','defineProperty','Shop\x20not\x20found','Test\x20Gateway','ShopService','payment','shopUrl','statusText','USDT\x20ERC20','paymentId','count','\x20USDT\x20(total\x20payouts)','Rapyd','redirectUrl','reduce','thisMonth','findFirst','gte','test','balance','currencyService','message','customer','PaymentService','ceil','telegram','usdtErcWallet','30d','KLYME\x20GB','USDC\x20Polygon','update','getPayoutStats','getMonth','USDT\x20BSC','createPublicPayment','gatewaySettings','shop','getPaymentsByShop','PAID','PENDING','publicKey','totalPaidOut','stringify','5128749nZihAf','...','yesterday','45eALNzH','application/json','usage','toLowerCase','usdtTrcWallet','toISOString','📅\x20Period\x20start:\x20','1054190AWWFIs','getPaymentById','💰\x20Getting\x20payouts\x20with\x20filters:','📊\x20Shop\x20','maxPayments','revenue','getDate','getFullYear','Noda','round','🌐\x20Network\x20filter:\x20','telegramId','retryCount','setDate','\x20USDT\x20(current\x20balance)','Webhook\x20returned\x20error:\x20','amountUSDT','usdtPolygonWallet','3109rZStsf','POST','📊\x20Final\x20WHERE\x20conditions:','filter','aggregate','getWebhookLogs','event','desc','currency','getShopProfile','fullName','availableBalance','shopId','\x20\x20\x20💵\x20Available\x20balance:\x20','5315639nAbJIh','🌐\x20Method\x20filter:\x20','split','getPayoutById','createdAt','findUnique','amountIsEditable','status','Unknown\x20error','paidAt','YESTERDAY','sourceCurrency','awaitingPayout','1018482MAPDiU','No\x20webhook\x20URL\x20configured','country','formatNetworkName','all','payout','📅\x20Date\x20end:\x20','Plisio','convertToUSDT','polygon_usdc','setHours','paymentService','test_gateway','default','Payment\x20not\x20found','txid','parse','./currencyService','isArray','lte','map','expiresAt','KLYME\x20DE','customerEmail','network','notes','webhookUrl','day','log','delete','getTime','name','Error\x20parsing\x20webhook\x20events:','4tyQrmK','8290227lssHAn','REJECTED','test_payment_123','📅\x20Date\x20start:\x20','settings','statusCode','gateways','255966LNleou','webhookEvents','786Fjvaga','wallets','getStatistics'];a60_0x2917=function(){return _0x5681a0;};return a60_0x2917();}