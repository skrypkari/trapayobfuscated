'use strict';const a65_0x105d8b=a65_0x104b;(function(_0x30ff0f,_0x4f555e){const _0x262b6a=a65_0x104b,_0x162d39=_0x30ff0f();while(!![]){try{const _0x468f14=parseInt(_0x262b6a(0x146))/0x1*(parseInt(_0x262b6a(0xf6))/0x2)+-parseInt(_0x262b6a(0xa6))/0x3*(parseInt(_0x262b6a(0x108))/0x4)+parseInt(_0x262b6a(0xbf))/0x5*(-parseInt(_0x262b6a(0x125))/0x6)+parseInt(_0x262b6a(0x117))/0x7+-parseInt(_0x262b6a(0xb3))/0x8*(parseInt(_0x262b6a(0xd3))/0x9)+parseInt(_0x262b6a(0x109))/0xa*(-parseInt(_0x262b6a(0x120))/0xb)+parseInt(_0x262b6a(0x10d))/0xc;if(_0x468f14===_0x4f555e)break;else _0x162d39['push'](_0x162d39['shift']());}catch(_0x35c199){_0x162d39['push'](_0x162d39['shift']());}}}(a65_0x5141,0xbe675));function a65_0x5141(){const _0x526703=['periodFrom','getShopPayoutStats','fullName','getPayoutStats','POST','7358967ocMBTX','paymentService','getMonth','setHours','currencyService','count','shopId','polygon_usdc','revenue','15202bmZrav','notes','findUnique','getPayouts','payout','8509656lugzKQ','Payment\x20not\x20found','createdAt','findFirst','Failed\x20to\x20send\x20webhook:\x20','set','update','language','PaymentService','message','usdtTrcWallet','webhookLog','customerEmail','PENDING','dailyPayments','üìä\x20Shop\x20','webhookUrl','\x20USDT\x20(total\x20payouts)','./currencyService','gateways','amountUSDT','30d','desc','usdcErcWallet','getTime','network','üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20','KLYME\x20DE','reduce','customerName','Unknown\x20error','settings','CoinToPay','1UkcjWS','publicKey','test','getShopProfile','getFullYear','expiresAt','thisMonth','getPayoutById','customer','defineProperty','toISOString','USD','getPayoutStatistics','all','asc','amount','updateShopProfile','default','__importDefault','üìä\x20Status\x20filter:\x20','2709qnhpHJ','\x20\x20\x20üìÖ\x20This\x20month:\x20','üìä\x20Final\x20WHERE\x20conditions:','telegram','name','paymentGateways','isArray','ShopService','wallets','usage','findMany','lte','polygon','8BZSmQM','USDT\x20TRC20','currency','paid','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','usdcPolygonWallet','webhookEvents','YESTERDAY','periodTo','day','get','KLYME\x20EU','5pkttnN','getPayments','gte','retryCount','status','ceil','map','country','USDT\x20ERC20','telegramId','usdtPolygonWallet','../config/database','üìÖ\x20Date\x20end:\x20','\x20USDT','log','\x20\x20\x20üíµ\x20Available\x20balance:\x20','PAID','COMPLETED','deletePayment','parse','3179691FuUETm','erc20','convertToUSDT','stringify','toUpperCase','90d','paidAt','üìÖ\x20Date\x20start:\x20','push','generateDailyStatistics','getPaymentById','gateway','createPublicPayment','getDate','setDate','USDT\x20BSC','trc20','username','createPayment','usdtErcWallet','USDC\x20Polygon','payment','test_gateway','Webhook\x20returned\x20error:\x20','totalPaidOut','test_order_123','split','KLYME\x20GB','error','gatewaySettings','Test\x20webhook\x20sent\x20successfully\x20(','round','shop','\x20payout\x20statistics\x20calculated:','filter','1460516UiBNKB','Noda','event','__esModule','Error\x20parsing\x20webhook\x20events:','merchantUrl','Payment\x20System/1.0\x20(Test)','amountIsEditable','maxPayments','getGatewayDisplayName','shopUrl','üí∞\x20Getting\x20payouts\x20with\x20filters:','balance','availableBalance','formatNetworkName','getStatistics','üìÖ\x20Period\x20end:\x20','./paymentService','4952nFPaHR','10130SrBMIh','üåê\x20Network\x20filter:\x20','statusText','txid','39453708kSJfGj','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','yesterday','_sum','application/json'];a65_0x5141=function(){return _0x526703;};return a65_0x5141();}var __importDefault=this&&this[a65_0x105d8b(0xa4)]||function(_0xeefdc0){const _0x439cdd=a65_0x105d8b;return _0xeefdc0&&_0xeefdc0[_0x439cdd(0xf9)]?_0xeefdc0:{'default':_0xeefdc0};};function a65_0x104b(_0x2116ba,_0x166c47){const _0x514129=a65_0x5141();return a65_0x104b=function(_0x104b7c,_0x1b4afd){_0x104b7c=_0x104b7c-0x9b;let _0x1ca596=_0x514129[_0x104b7c];return _0x1ca596;},a65_0x104b(_0x2116ba,_0x166c47);}Object[a65_0x105d8b(0x9b)](exports,a65_0x105d8b(0xf9),{'value':!![]}),exports[a65_0x105d8b(0xad)]=void 0x0;const database_1=__importDefault(require(a65_0x105d8b(0xca))),currencyService_1=require(a65_0x105d8b(0x137)),paymentService_1=require(a65_0x105d8b(0x107));class ShopService{constructor(){const _0x14b8d2=a65_0x105d8b;this[_0x14b8d2(0x118)]=new paymentService_1[(_0x14b8d2(0x12d))]();}async[a65_0x105d8b(0x149)](_0x1489f6){const _0x52606f=a65_0x105d8b,_0x294d9d=await database_1[_0x52606f(0xa3)][_0x52606f(0xf3)][_0x52606f(0x122)]({'where':{'id':_0x1489f6},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x294d9d)throw new Error('Shop\x20not\x20found');let _0x5cafbe=[];if(_0x294d9d[_0x52606f(0x144)]?.[_0x52606f(0xb9)])try{_0x5cafbe=Array[_0x52606f(0xac)](_0x294d9d[_0x52606f(0x144)]['webhookEvents'])?_0x294d9d[_0x52606f(0x144)][_0x52606f(0xb9)]:JSON[_0x52606f(0xd2)](_0x294d9d[_0x52606f(0x144)]['webhookEvents']);}catch(_0x28698b){console[_0x52606f(0xef)](_0x52606f(0xfa),_0x28698b),_0x5cafbe=[];}return{'id':_0x294d9d['id'],'fullName':_0x294d9d[_0x52606f(0xaa)],'username':_0x294d9d[_0x52606f(0xe4)],'telegramId':_0x294d9d[_0x52606f(0xa9)],'merchantUrl':_0x294d9d[_0x52606f(0x100)],'gateways':_0x294d9d[_0x52606f(0xab)]?JSON[_0x52606f(0xd2)](_0x294d9d['paymentGateways']):null,'gatewaySettings':_0x294d9d[_0x52606f(0xf0)]?JSON[_0x52606f(0xd2)](_0x294d9d[_0x52606f(0xf0)]):null,'publicKey':_0x294d9d[_0x52606f(0x147)],'webhookUrl':_0x294d9d['settings']?.['webhookUrl']||null,'webhookEvents':_0x5cafbe,'wallets':{'usdtPolygonWallet':_0x294d9d[_0x52606f(0xc9)],'usdtTrcWallet':_0x294d9d[_0x52606f(0x12f)],'usdtErcWallet':_0x294d9d[_0x52606f(0xe6)],'usdcPolygonWallet':_0x294d9d[_0x52606f(0xb8)],'usdcErcWallet':_0x294d9d[_0x52606f(0x13c)]},'status':_0x294d9d[_0x52606f(0xc3)],'createdAt':_0x294d9d['createdAt']};}async[a65_0x105d8b(0xa2)](_0x1b009b,_0x21005c){const _0x3ff7cd=a65_0x105d8b,_0x5337a3={};_0x21005c[_0x3ff7cd(0x114)]&&(_0x5337a3[_0x3ff7cd(0xaa)]=_0x21005c[_0x3ff7cd(0x114)]);_0x21005c[_0x3ff7cd(0xc8)]!==undefined&&(_0x5337a3[_0x3ff7cd(0xa9)]=_0x21005c['telegramId']||null);_0x21005c['merchantUrl']&&(_0x5337a3[_0x3ff7cd(0x100)]=_0x21005c[_0x3ff7cd(0xfb)]);_0x21005c[_0x3ff7cd(0x138)]&&(_0x5337a3[_0x3ff7cd(0xab)]=JSON[_0x3ff7cd(0xd6)](_0x21005c[_0x3ff7cd(0x138)]));_0x21005c['gatewaySettings']&&(_0x5337a3[_0x3ff7cd(0xf0)]=JSON[_0x3ff7cd(0xd6)](_0x21005c[_0x3ff7cd(0xf0)]));_0x21005c['wallets']&&(_0x21005c[_0x3ff7cd(0xae)][_0x3ff7cd(0xc9)]!==undefined&&(_0x5337a3[_0x3ff7cd(0xc9)]=_0x21005c['wallets'][_0x3ff7cd(0xc9)]||null),_0x21005c[_0x3ff7cd(0xae)]['usdtTrcWallet']!==undefined&&(_0x5337a3['usdtTrcWallet']=_0x21005c[_0x3ff7cd(0xae)][_0x3ff7cd(0x12f)]||null),_0x21005c[_0x3ff7cd(0xae)][_0x3ff7cd(0xe6)]!==undefined&&(_0x5337a3[_0x3ff7cd(0xe6)]=_0x21005c['wallets'][_0x3ff7cd(0xe6)]||null),_0x21005c['wallets']['usdcPolygonWallet']!==undefined&&(_0x5337a3[_0x3ff7cd(0xb8)]=_0x21005c['wallets'][_0x3ff7cd(0xb8)]||null));const _0xa6aeca=await database_1['default'][_0x3ff7cd(0xf3)][_0x3ff7cd(0x12b)]({'where':{'id':_0x1b009b},'data':_0x5337a3,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x18ae6a=[];if(_0xa6aeca['settings']?.['webhookEvents'])try{_0x18ae6a=Array[_0x3ff7cd(0xac)](_0xa6aeca[_0x3ff7cd(0x144)]['webhookEvents'])?_0xa6aeca[_0x3ff7cd(0x144)][_0x3ff7cd(0xb9)]:JSON[_0x3ff7cd(0xd2)](_0xa6aeca[_0x3ff7cd(0x144)][_0x3ff7cd(0xb9)]);}catch(_0x2fe2a4){console[_0x3ff7cd(0xef)](_0x3ff7cd(0xfa),_0x2fe2a4),_0x18ae6a=[];}return{'id':_0xa6aeca['id'],'fullName':_0xa6aeca[_0x3ff7cd(0xaa)],'username':_0xa6aeca[_0x3ff7cd(0xe4)],'telegramId':_0xa6aeca[_0x3ff7cd(0xa9)],'merchantUrl':_0xa6aeca[_0x3ff7cd(0x100)],'gateways':_0xa6aeca['paymentGateways']?JSON[_0x3ff7cd(0xd2)](_0xa6aeca[_0x3ff7cd(0xab)]):null,'gatewaySettings':_0xa6aeca[_0x3ff7cd(0xf0)]?JSON[_0x3ff7cd(0xd2)](_0xa6aeca[_0x3ff7cd(0xf0)]):null,'publicKey':_0xa6aeca[_0x3ff7cd(0x147)],'webhookUrl':_0xa6aeca['settings']?.[_0x3ff7cd(0x135)]||null,'webhookEvents':_0x18ae6a,'wallets':{'usdtPolygonWallet':_0xa6aeca[_0x3ff7cd(0xc9)],'usdtTrcWallet':_0xa6aeca['usdtTrcWallet'],'usdtErcWallet':_0xa6aeca[_0x3ff7cd(0xe6)],'usdcPolygonWallet':_0xa6aeca[_0x3ff7cd(0xb8)],'usdcErcWallet':_0xa6aeca[_0x3ff7cd(0x13c)]},'status':_0xa6aeca[_0x3ff7cd(0xc3)],'createdAt':_0xa6aeca[_0x3ff7cd(0x127)]};}async['updateWallets'](_0x5e6c2e,_0x52c17a){const _0x2e4a03=a65_0x105d8b,_0x21f832={};_0x52c17a['usdtPolygonWallet']!==undefined&&(_0x21f832[_0x2e4a03(0xc9)]=_0x52c17a[_0x2e4a03(0xc9)]||null),_0x52c17a['usdtTrcWallet']!==undefined&&(_0x21f832[_0x2e4a03(0x12f)]=_0x52c17a[_0x2e4a03(0x12f)]||null),_0x52c17a[_0x2e4a03(0xe6)]!==undefined&&(_0x21f832['usdtErcWallet']=_0x52c17a[_0x2e4a03(0xe6)]||null),_0x52c17a[_0x2e4a03(0xb8)]!==undefined&&(_0x21f832[_0x2e4a03(0xb8)]=_0x52c17a[_0x2e4a03(0xb8)]||null),_0x52c17a['usdcErcWallet']!==undefined&&(_0x21f832['usdcErcWallet']=_0x52c17a['usdcErcWallet']||null),await database_1[_0x2e4a03(0xa3)][_0x2e4a03(0xf3)]['update']({'where':{'id':_0x5e6c2e},'data':_0x21f832});}async['testWebhook'](_0x1df925){const _0x15eb78=a65_0x105d8b,_0x5919b6=await database_1[_0x15eb78(0xa3)][_0x15eb78(0xf3)][_0x15eb78(0x122)]({'where':{'id':_0x1df925},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x5919b6?.[_0x15eb78(0x144)]?.['webhookUrl'])throw new Error('No\x20webhook\x20URL\x20configured');const _0x2c046e={'event':_0x15eb78(0x148),'payment':{'id':'test_payment_123','order_id':_0x15eb78(0xec),'gateway':_0x15eb78(0x148),'amount':0x64,'currency':_0x15eb78(0x9d),'status':_0x15eb78(0xb6),'created_at':new Date()['toISOString']()}};try{const _0x2062ae=await fetch(_0x5919b6['settings'][_0x15eb78(0x135)],{'method':_0x15eb78(0x116),'headers':{'Content-Type':_0x15eb78(0x111),'User-Agent':_0x15eb78(0xfc)},'body':JSON[_0x15eb78(0xd6)](_0x2c046e)});return _0x2062ae['ok']?{'success':!![],'message':_0x15eb78(0xf1)+_0x2062ae[_0x15eb78(0xc3)]+')'}:{'success':![],'message':_0x15eb78(0xea)+_0x2062ae[_0x15eb78(0xc3)]+'\x20'+_0x2062ae[_0x15eb78(0x10b)]};}catch(_0x24b8d7){return{'success':![],'message':_0x15eb78(0x129)+(_0x24b8d7 instanceof Error?_0x24b8d7[_0x15eb78(0x12e)]:_0x15eb78(0x143))};}}async[a65_0x105d8b(0xe5)](_0x369e05){const _0x24782a=a65_0x105d8b;return this[_0x24782a(0x118)][_0x24782a(0xdf)]({'public_key':'','gateway':_0x369e05['gateway'],'order_id':undefined,'amount':_0x369e05['amount'],'currency':_0x369e05[_0x24782a(0xb5)],'source_currency':_0x369e05['sourceCurrency'],'usage':_0x369e05[_0x24782a(0xaf)],'expires_at':_0x369e05[_0x24782a(0x14b)]?.[_0x24782a(0x9c)](),'success_url':_0x369e05['redirectUrl'],'fail_url':_0x369e05['redirectUrl'],'customer_email':_0x369e05[_0x24782a(0x131)],'customer_name':_0x369e05[_0x24782a(0x142)],'country':_0x369e05[_0x24782a(0xc6)],'language':_0x369e05[_0x24782a(0x12c)],'amount_is_editable':_0x369e05[_0x24782a(0xfd)],'max_payments':_0x369e05[_0x24782a(0xfe)],'customer':_0x369e05[_0x24782a(0x14e)]});}async[a65_0x105d8b(0xc0)](_0x335d92,_0x5040c7){const _0x4fb87f=a65_0x105d8b;return this[_0x4fb87f(0x118)]['getPaymentsByShop'](_0x335d92,_0x5040c7);}async[a65_0x105d8b(0xdd)](_0x17a4bf,_0x41f36d){const _0x5856ab=a65_0x105d8b;return this[_0x5856ab(0x118)]['getPaymentByShopAndId'](_0x17a4bf,_0x41f36d);}async['updatePayment'](_0x5e3f19,_0x1c77f4,_0x5a7b41){const _0x5cc992=a65_0x105d8b,_0x31a1a5=await database_1[_0x5cc992(0xa3)][_0x5cc992(0xe8)][_0x5cc992(0x128)]({'where':{'id':_0x1c77f4,'shopId':_0x5e3f19}});if(!_0x31a1a5)throw new Error(_0x5cc992(0x126));const _0x3ce7a4=await database_1[_0x5cc992(0xa3)][_0x5cc992(0xe8)][_0x5cc992(0x12b)]({'where':{'id':_0x1c77f4},'data':{..._0x5a7b41,'updatedAt':new Date()}});return _0x3ce7a4;}async[a65_0x105d8b(0xd1)](_0x4c0ca8,_0x99ea63){const _0x795da1=a65_0x105d8b,_0x31d967=await database_1[_0x795da1(0xa3)]['payment'][_0x795da1(0x128)]({'where':{'id':_0x99ea63,'shopId':_0x4c0ca8}});if(!_0x31d967)throw new Error(_0x795da1(0x126));await database_1['default']['payment']['delete']({'where':{'id':_0x99ea63}});}[a65_0x105d8b(0x104)](_0x53a0c5){const _0x34406c=a65_0x105d8b,_0x3d1ef9={'polygon':'USDT\x20Polygon','trc20':_0x34406c(0xb4),'erc20':_0x34406c(0xc7),'bsc':_0x34406c(0xe2),'polygon_usdc':_0x34406c(0xe7),'erc20_usdc':'USDC\x20Ethereum'};return _0x3d1ef9[_0x53a0c5]||_0x53a0c5;}async[a65_0x105d8b(0x123)](_0x5adca6,_0x177c88){const _0x58f3fd=a65_0x105d8b,{page:_0x4c330e,limit:_0x335573,status:_0x3bf96c,method:_0x2cca0e,network:_0x3643b2,dateFrom:_0x54fc28,dateTo:_0xc4648c,periodFrom:_0x31cbd5,periodTo:_0x442163}=_0x177c88,_0x42e5d3=(_0x4c330e-0x1)*_0x335573;console[_0x58f3fd(0xcd)](_0x58f3fd(0x101),_0x177c88);const _0x19129a={'shopId':_0x5adca6};_0x3bf96c&&(_0x19129a[_0x58f3fd(0xc3)]=_0x3bf96c[_0x58f3fd(0xd7)](),console['log'](_0x58f3fd(0xa5)+_0x3bf96c[_0x58f3fd(0xd7)]()));if(_0x2cca0e)_0x19129a[_0x58f3fd(0x13e)]=_0x2cca0e,console[_0x58f3fd(0xcd)]('üåê\x20Method\x20filter:\x20'+_0x2cca0e);else _0x3643b2&&(_0x19129a[_0x58f3fd(0x13e)]=_0x3643b2,console[_0x58f3fd(0xcd)](_0x58f3fd(0x10a)+_0x3643b2));if(_0x54fc28||_0xc4648c||_0x31cbd5||_0x442163){_0x19129a['createdAt']={};if(_0x31cbd5){const _0x3e30b1=new Date(_0x31cbd5);_0x3e30b1[_0x58f3fd(0x11a)](0x0,0x0,0x0,0x0),_0x19129a[_0x58f3fd(0x127)][_0x58f3fd(0xc1)]=_0x3e30b1,console[_0x58f3fd(0xcd)]('üìÖ\x20Period\x20start:\x20'+_0x3e30b1[_0x58f3fd(0x9c)]());}else{if(_0x54fc28){const _0x83465b=new Date(_0x54fc28);_0x83465b['setHours'](0x0,0x0,0x0,0x0),_0x19129a[_0x58f3fd(0x127)][_0x58f3fd(0xc1)]=_0x83465b,console[_0x58f3fd(0xcd)](_0x58f3fd(0xda)+_0x83465b[_0x58f3fd(0x9c)]());}}if(_0x442163){const _0x58ef07=new Date(_0x442163);_0x58ef07[_0x58f3fd(0x11a)](0x17,0x3b,0x3b,0x3e7),_0x19129a['createdAt']['lte']=_0x58ef07,console[_0x58f3fd(0xcd)](_0x58f3fd(0x106)+_0x58ef07['toISOString']());}else{if(_0xc4648c){const _0x234a91=new Date(_0xc4648c);_0x234a91[_0x58f3fd(0x11a)](0x17,0x3b,0x3b,0x3e7),_0x19129a[_0x58f3fd(0x127)][_0x58f3fd(0xb1)]=_0x234a91,console['log'](_0x58f3fd(0xcb)+_0x234a91[_0x58f3fd(0x9c)]());}}}console[_0x58f3fd(0xcd)](_0x58f3fd(0xa8),JSON[_0x58f3fd(0xd6)](_0x19129a,null,0x2));const [_0xf2a7a1,_0x416dd8]=await Promise[_0x58f3fd(0x9f)]([database_1['default'][_0x58f3fd(0x124)][_0x58f3fd(0xb0)]({'where':_0x19129a,'skip':_0x42e5d3,'take':_0x335573,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'usdcErcWallet':!![]}}}}),database_1[_0x58f3fd(0xa3)][_0x58f3fd(0x124)][_0x58f3fd(0x11c)]({'where':_0x19129a})]);return{'payouts':_0xf2a7a1[_0x58f3fd(0xc5)](_0x13a9f7=>{const _0x22320f=_0x58f3fd;let _0x49ef4e=null;switch(_0x13a9f7['network']){case _0x22320f(0xb2):_0x49ef4e=_0x13a9f7['shop'][_0x22320f(0xc9)];break;case _0x22320f(0xe3):_0x49ef4e=_0x13a9f7[_0x22320f(0xf3)][_0x22320f(0x12f)];break;case _0x22320f(0xd4):_0x49ef4e=_0x13a9f7['shop'][_0x22320f(0xe6)];break;case _0x22320f(0x11e):_0x49ef4e=_0x13a9f7['shop'][_0x22320f(0xb8)];break;case'erc20_usdc':_0x49ef4e=_0x13a9f7[_0x22320f(0xf3)][_0x22320f(0x13c)];break;}return{'id':_0x13a9f7['id'],'amount':_0x13a9f7['amount'],'network':this[_0x22320f(0x104)](_0x13a9f7[_0x22320f(0x13e)]),'wallet':_0x49ef4e,'status':_0x13a9f7[_0x22320f(0xc3)],'txid':_0x13a9f7[_0x22320f(0x10c)],'notes':_0x13a9f7[_0x22320f(0x121)],'periodFrom':_0x13a9f7[_0x22320f(0x112)],'periodTo':_0x13a9f7[_0x22320f(0xbb)],'createdAt':_0x13a9f7[_0x22320f(0x127)],'paidAt':_0x13a9f7[_0x22320f(0xd9)]};}),'pagination':{'page':_0x4c330e,'limit':_0x335573,'total':_0x416dd8,'totalPages':Math[_0x58f3fd(0xc4)](_0x416dd8/_0x335573)}};}async[a65_0x105d8b(0x14d)](_0x2d6bc6,_0x577f6a){const _0x592b5b=a65_0x105d8b,_0x58846e=await database_1[_0x592b5b(0xa3)][_0x592b5b(0x124)][_0x592b5b(0x128)]({'where':{'id':_0x577f6a,'shopId':_0x2d6bc6}});if(!_0x58846e)return null;return{'id':_0x58846e['id'],'amount':_0x58846e['amount'],'network':_0x58846e[_0x592b5b(0x13e)],'status':_0x58846e[_0x592b5b(0xc3)],'txid':_0x58846e[_0x592b5b(0x10c)],'notes':_0x58846e['notes'],'createdAt':_0x58846e['createdAt'],'paidAt':_0x58846e[_0x592b5b(0xd9)]};}async[a65_0x105d8b(0x9e)](_0x3f1ad7,_0x4ead10){const _0x6a17b0=a65_0x105d8b,_0x21db61=new Date();let _0x391733,_0x53ac8e;switch(_0x4ead10){case _0x6a17b0(0x10f):case'YESTERDAY':const _0x418cd6=new Date(_0x21db61);_0x418cd6[_0x6a17b0(0xe1)](_0x418cd6['getDate']()-0x1),_0x391733=new Date(_0x418cd6),_0x391733[_0x6a17b0(0x11a)](0x0,0x0,0x0,0x0),_0x53ac8e=new Date(_0x418cd6),_0x53ac8e['setHours'](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x391733=new Date(_0x21db61['getTime']()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x6a17b0(0x13a):_0x391733=new Date(_0x21db61[_0x6a17b0(0x13d)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x6a17b0(0xd8):_0x391733=new Date(_0x21db61[_0x6a17b0(0x13d)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x391733=new Date(_0x21db61[_0x6a17b0(0x13d)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x26a4be={'gte':_0x391733};_0x53ac8e&&(_0x26a4be[_0x6a17b0(0xb1)]=_0x53ac8e);const [_0x12fc2f,_0x4d132d,_0x2cbd90,_0x540b41,_0x9fefbd,_0x4377cd]=await Promise[_0x6a17b0(0x9f)]([database_1[_0x6a17b0(0xa3)][_0x6a17b0(0x124)][_0x6a17b0(0x11c)]({'where':{'shopId':_0x3f1ad7,'createdAt':_0x26a4be}}),database_1[_0x6a17b0(0xa3)][_0x6a17b0(0x124)][_0x6a17b0(0x11c)]({'where':{'shopId':_0x3f1ad7,'status':_0x6a17b0(0xd0),'createdAt':_0x26a4be}}),database_1[_0x6a17b0(0xa3)][_0x6a17b0(0x124)][_0x6a17b0(0x11c)]({'where':{'shopId':_0x3f1ad7,'status':_0x6a17b0(0x132),'createdAt':_0x26a4be}}),database_1[_0x6a17b0(0xa3)][_0x6a17b0(0x124)][_0x6a17b0(0x11c)]({'where':{'shopId':_0x3f1ad7,'status':'REJECTED','createdAt':_0x26a4be}}),database_1[_0x6a17b0(0xa3)]['payout'][_0x6a17b0(0xb0)]({'where':{'shopId':_0x3f1ad7,'createdAt':_0x26a4be},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x6a17b0(0xa3)][_0x6a17b0(0x124)][_0x6a17b0(0xb0)]({'where':{'shopId':_0x3f1ad7},'take':0xa,'orderBy':{'createdAt':_0x6a17b0(0x13b)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x106841=_0x9fefbd[_0x6a17b0(0x141)]((_0x27fd2e,_0x2d13f1)=>_0x27fd2e+_0x2d13f1[_0x6a17b0(0xa1)],0x0),_0x3f5336=_0x9fefbd[_0x6a17b0(0xf5)](_0x958a3a=>_0x958a3a[_0x6a17b0(0xc3)]==='COMPLETED')[_0x6a17b0(0x141)]((_0x3d9327,_0x15c784)=>_0x3d9327+_0x15c784['amount'],0x0),_0x3795ea=_0x9fefbd['filter'](_0x4088d7=>_0x4088d7[_0x6a17b0(0xc3)]==='PENDING')[_0x6a17b0(0x141)]((_0x216de0,_0x3e945c)=>_0x216de0+_0x3e945c[_0x6a17b0(0xa1)],0x0),_0x5d33c9=_0x9fefbd[_0x6a17b0(0x141)]((_0x55e513,_0x1d27ce)=>{const _0xcc314b=_0x6a17b0;return _0x55e513[_0x1d27ce[_0xcc314b(0x13e)]]=(_0x55e513[_0x1d27ce['network']]||0x0)+0x1,_0x55e513;},{}),_0x5ef290=_0x9fefbd[_0x6a17b0(0x141)]((_0x466b27,_0x305f90)=>{const _0xf811a6=_0x6a17b0;return _0x466b27[_0x305f90[_0xf811a6(0xc3)]]=(_0x466b27[_0x305f90[_0xf811a6(0xc3)]]||0x0)+0x1,_0x466b27;},{});return{'totalPayouts':_0x12fc2f,'completedPayouts':_0x4d132d,'pendingPayouts':_0x2cbd90,'rejectedPayouts':_0x540b41,'totalAmount':_0x106841,'completedAmount':_0x3f5336,'pendingAmount':_0x3795ea,'payoutsByMethod':_0x5d33c9,'payoutsByStatus':_0x5ef290,'recentPayouts':_0x4377cd[_0x6a17b0(0xc5)](_0x495fca=>({'id':_0x495fca['id'],'shopId':_0x3f1ad7,'amount':_0x495fca['amount'],'method':_0x495fca[_0x6a17b0(0x13e)],'status':_0x495fca[_0x6a17b0(0xc3)],'txid':_0x495fca[_0x6a17b0(0x10c)],'createdAt':_0x495fca[_0x6a17b0(0x127)],'paidAt':_0x495fca[_0x6a17b0(0xd9)]}))};}async['getShopPayoutStats'](_0xa6f267){const _0x1bafa1=a65_0x105d8b;console[_0x1bafa1(0xcd)](_0x1bafa1(0x13f)+_0xa6f267+'...');const _0x5e9234=await database_1[_0x1bafa1(0xa3)]['shop'][_0x1bafa1(0x122)]({'where':{'id':_0xa6f267},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x5e9234)throw new Error('Shop\x20not\x20found');const _0xbcd536=new Date(),_0x49378d=new Date(_0xbcd536[_0x1bafa1(0x14a)](),_0xbcd536[_0x1bafa1(0x119)](),0x1),_0x1a9967=new Date(_0xbcd536[_0x1bafa1(0x14a)](),_0xbcd536['getMonth']()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0xe8df5f=await database_1[_0x1bafa1(0xa3)][_0x1bafa1(0x124)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0xa6f267,'createdAt':{'gte':_0x49378d,'lte':_0x1a9967},'status':_0x1bafa1(0xd0)}}),_0x15b5e6=_0xe8df5f[_0x1bafa1(0x110)][_0x1bafa1(0xa1)]||0x0,_0x15c081={'availableBalance':Math['round'](_0x5e9234[_0x1bafa1(0x102)]*0x64)/0x64,'totalPaidOut':Math[_0x1bafa1(0xf2)](_0x5e9234[_0x1bafa1(0xeb)]*0x64)/0x64,'awaitingPayout':Math[_0x1bafa1(0xf2)](_0x5e9234[_0x1bafa1(0x102)]*0x64)/0x64,'thisMonth':Math[_0x1bafa1(0xf2)](_0x15b5e6*0x64)/0x64};return console[_0x1bafa1(0xcd)](_0x1bafa1(0x134)+_0x5e9234[_0x1bafa1(0xe4)]+_0x1bafa1(0xf4)),console[_0x1bafa1(0xcd)](_0x1bafa1(0xce)+_0x15c081[_0x1bafa1(0x103)]+'\x20USDT\x20(current\x20balance)'),console[_0x1bafa1(0xcd)](_0x1bafa1(0x10e)+_0x15c081[_0x1bafa1(0xeb)]+_0x1bafa1(0x136)),console[_0x1bafa1(0xcd)](_0x1bafa1(0xb7)+_0x15c081['awaitingPayout']+'\x20USDT\x20(current\x20balance)'),console[_0x1bafa1(0xcd)](_0x1bafa1(0xa7)+_0x15c081[_0x1bafa1(0x14c)]+_0x1bafa1(0xcc)),_0x15c081;}[a65_0x105d8b(0xff)](_0x4430d5){const _0x391464=a65_0x105d8b,_0x421cdc={'test_gateway':'Test\x20Gateway','plisio':'Plisio','rapyd':'Rapyd','noda':_0x391464(0xf7),'cointopay':_0x391464(0x145),'klyme_eu':_0x391464(0xbe),'klyme_gb':_0x391464(0xee),'klyme_de':_0x391464(0x140)};return _0x421cdc[_0x4430d5]||_0x4430d5;}async[a65_0x105d8b(0x115)](_0x24704a){const _0x1feba8=a65_0x105d8b;return this[_0x1feba8(0x113)](_0x24704a);}async['getWebhookLogs'](_0x422af5,_0x208c98){const _0x1783fe=a65_0x105d8b,{page:_0x25ed2d,limit:_0xc54970,paymentId:_0x1df43b}=_0x208c98,_0x3fec0f=(_0x25ed2d-0x1)*_0xc54970,_0x6c4821={'shopId':_0x422af5};_0x1df43b&&(_0x6c4821['paymentId']=_0x1df43b);const [_0x430375,_0x1c9d1a]=await Promise[_0x1783fe(0x9f)]([database_1[_0x1783fe(0xa3)]['webhookLog'][_0x1783fe(0xb0)]({'where':_0x6c4821,'skip':_0x3fec0f,'take':_0xc54970,'orderBy':{'createdAt':_0x1783fe(0x13b)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default'][_0x1783fe(0x130)][_0x1783fe(0x11c)]({'where':_0x6c4821})]);return{'logs':_0x430375['map'](_0x5a2713=>({'id':_0x5a2713['id'],'paymentId':_0x5a2713['paymentId'],'shopId':_0x5a2713[_0x1783fe(0x11d)],'event':_0x5a2713[_0x1783fe(0xf8)],'statusCode':_0x5a2713['statusCode'],'retryCount':_0x5a2713[_0x1783fe(0xc2)],'responseBody':_0x5a2713['responseBody'],'createdAt':_0x5a2713[_0x1783fe(0x127)],'payment':_0x5a2713[_0x1783fe(0xe8)]})),'pagination':{'page':_0x25ed2d,'limit':_0xc54970,'total':_0x1c9d1a,'totalPages':Math['ceil'](_0x1c9d1a/_0xc54970)}};}async[a65_0x105d8b(0x105)](_0x19694a,_0x549fd4){const _0x41152b=a65_0x105d8b,_0x318a42=new Date();let _0x23ac46,_0x47e314;switch(_0x549fd4['toLowerCase']()){case _0x41152b(0xbc):_0x23ac46=new Date(_0x318a42[_0x41152b(0x14a)](),_0x318a42[_0x41152b(0x119)](),_0x318a42[_0x41152b(0xe0)](),0x0,0x0,0x0,0x0);break;case _0x41152b(0x10f):case _0x41152b(0xba):const _0x406433=new Date(_0x318a42);_0x406433[_0x41152b(0xe1)](_0x406433['getDate']()-0x1),_0x23ac46=new Date(_0x406433),_0x23ac46[_0x41152b(0x11a)](0x0,0x0,0x0,0x0),_0x47e314=new Date(_0x406433),_0x47e314[_0x41152b(0x11a)](0x17,0x3b,0x3b,0x3e7);break;case'7d':_0x23ac46=new Date(_0x318a42[_0x41152b(0x13d)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x41152b(0x13a):_0x23ac46=new Date(_0x318a42['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x41152b(0xd8):_0x23ac46=new Date(_0x318a42[_0x41152b(0x13d)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x23ac46=new Date(_0x318a42[_0x41152b(0x13d)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const _0x2beeb8={'gte':_0x23ac46};_0x47e314&&(_0x2beeb8[_0x41152b(0xb1)]=_0x47e314);const [_0x1088af,_0x5232a8,_0x4f5feb,_0x5a8a1c,_0x469603]=await Promise[_0x41152b(0x9f)]([database_1['default'][_0x41152b(0xe8)]['count']({'where':{'shopId':_0x19694a,'gateway':{'not':_0x41152b(0xe9)},'createdAt':_0x2beeb8}}),database_1[_0x41152b(0xa3)][_0x41152b(0xe8)]['count']({'where':{'shopId':_0x19694a,'gateway':{'not':_0x41152b(0xe9)},'status':'PAID','createdAt':_0x2beeb8}}),database_1[_0x41152b(0xa3)][_0x41152b(0xe8)]['findMany']({'where':{'shopId':_0x19694a,'gateway':{'not':'test_gateway'},'status':_0x41152b(0xcf),'createdAt':_0x2beeb8},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x41152b(0xa3)]['payment']['findMany']({'where':{'shopId':_0x19694a,'gateway':{'not':_0x41152b(0xe9)}},'take':0xa,'orderBy':{'createdAt':'desc'},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1[_0x41152b(0xa3)]['payment']['findMany']({'where':{'shopId':_0x19694a,'gateway':{'not':'test_gateway'},'createdAt':_0x2beeb8},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x41152b(0xa0)}})]);let _0xefac39=0x0;for(const _0x1b7e7b of _0x4f5feb){if(_0x1b7e7b[_0x41152b(0x139)])_0xefac39+=_0x1b7e7b[_0x41152b(0x139)];else{const _0x5c093f=await currencyService_1[_0x41152b(0x11b)][_0x41152b(0xd5)](_0x1b7e7b['amount'],_0x1b7e7b[_0x41152b(0xb5)]);_0xefac39+=_0x5c093f;}}const _0x52cde0=this[_0x41152b(0xdc)](_0x469603,_0x23ac46,_0x47e314||_0x318a42),_0x56d7c8=_0x1088af>0x0?_0x5232a8/_0x1088af*0x64:0x0;return{'totalPayments':_0x1088af,'successfulPayments':_0x5232a8,'totalRevenue':Math['round'](_0xefac39*0x64)/0x64,'conversionRate':Math['round'](_0x56d7c8*0x64)/0x64,'dailyRevenue':_0x52cde0['dailyRevenue'],'dailyPayments':_0x52cde0[_0x41152b(0x133)],'recentPayments':_0x5a8a1c[_0x41152b(0xc5)](_0x516b0d=>({'id':_0x516b0d['id'],'gateway':_0x516b0d[_0x41152b(0xde)],'amount':_0x516b0d[_0x41152b(0xa1)],'currency':_0x516b0d[_0x41152b(0xb5)],'status':_0x516b0d[_0x41152b(0xc3)],'createdAt':_0x516b0d['createdAt']}))};}[a65_0x105d8b(0xdc)](_0x4c7807,_0x35dd9c,_0x3813bb){const _0x3c1f4f=a65_0x105d8b,_0xf2d5a=new Map(),_0x266fbf=new Date(_0x35dd9c);while(_0x266fbf<=_0x3813bb){const _0x57aafc=_0x266fbf['toISOString']()[_0x3c1f4f(0xed)]('T')[0x0];_0xf2d5a[_0x3c1f4f(0x12a)](_0x57aafc,{'revenue':0x0,'count':0x0}),_0x266fbf[_0x3c1f4f(0xe1)](_0x266fbf['getDate']()+0x1);}for(const _0x3c21d6 of _0x4c7807){const _0x3ce41d=_0x3c21d6[_0x3c1f4f(0x127)][_0x3c1f4f(0x9c)]()[_0x3c1f4f(0xed)]('T')[0x0],_0x427fd6=_0xf2d5a[_0x3c1f4f(0xbd)](_0x3ce41d);_0x427fd6&&(_0x427fd6['count']+=0x1,_0x3c21d6[_0x3c1f4f(0xc3)]==='PAID'&&_0x3c21d6[_0x3c1f4f(0x139)]&&(_0x427fd6[_0x3c1f4f(0x11f)]+=_0x3c21d6[_0x3c1f4f(0x139)]));}const _0x33b26f=[],_0x474339=[];for(const [_0x485849,_0x1f51ce]of _0xf2d5a){_0x33b26f['push']({'date':_0x485849,'amount':Math['round'](_0x1f51ce[_0x3c1f4f(0x11f)]*0x64)/0x64}),_0x474339[_0x3c1f4f(0xdb)]({'date':_0x485849,'count':_0x1f51ce[_0x3c1f4f(0x11c)]});}return{'dailyRevenue':_0x33b26f,'dailyPayments':_0x474339};}}exports[a65_0x105d8b(0xad)]=ShopService;