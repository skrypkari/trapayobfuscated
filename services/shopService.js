'use strict';const a48_0x167927=a48_0x3f10;(function(_0x20947d,_0xb71acb){const _0x4bdb03=a48_0x3f10,_0x12850e=_0x20947d();while(!![]){try{const _0x5cab3f=-parseInt(_0x4bdb03(0x210))/0x1*(-parseInt(_0x4bdb03(0x1f7))/0x2)+-parseInt(_0x4bdb03(0x156))/0x3*(-parseInt(_0x4bdb03(0x19d))/0x4)+-parseInt(_0x4bdb03(0x155))/0x5+-parseInt(_0x4bdb03(0x149))/0x6*(-parseInt(_0x4bdb03(0x1ee))/0x7)+-parseInt(_0x4bdb03(0x170))/0x8*(parseInt(_0x4bdb03(0x164))/0x9)+-parseInt(_0x4bdb03(0x160))/0xa+parseInt(_0x4bdb03(0x204))/0xb;if(_0x5cab3f===_0xb71acb)break;else _0x12850e['push'](_0x12850e['shift']());}catch(_0x6d806d){_0x12850e['push'](_0x12850e['shift']());}}}(a48_0x3dd7,0x87284));function a48_0x3dd7(){const _0x12b2ce=['error','usage','slice','getPaymentById','createdAt','customer','getShopPayoutStats','getPeriodDays','getShopProfile','./gateways/plisioService','Shop\x20not\x20found','createPaymentLink','update','gatewayPaymentId','🇬🇧\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20shop\x20payment','\x20\x20\x20✅\x20Success:\x20','country','network','./gateways/nodaService','✅\x20Shop\x20statistics\x20generated\x20successfully','status','floor','Gateway\x20error\x20during\x20shop\x20payment\x20creation:','getMonth','settings','application/json','\x20paid\x20payments\x20for\x20analysis','rapyd','❌\x20Test\x20webhook\x20error:\x20','💳\x20Creating\x20KLYME\x20','📊\x20Daily\x20revenue\x20entries:\x20','ShopService','push','7ojOYip','💾\x20Shop\x20payment\x20created\x20with\x20gateway\x20order_id:\x20','create','name','test@example.com','all','paymentGateways','desc','startsWith','4300RNEkDF','__importDefault','updatedAt','🔗\x20Generated\x20URLs\x20for\x20','webhookUrl','💰\x20Found\x20','KLYME\x20payment\x20creation\x20is\x20only\x20supported\x20for\x20EU\x20and\x20GB\x20regions,\x20got:\x20','getPayoutById','map','BASE_URL','/payment/success?payment_id=','KlymeService','Test\x20Customer','1449899yWUmOB','getStatistics','currency','ONCE','rapydService','currencyService','merchantPaid','shopId','commission','Order\x20ID:\x20','webhookLog','Failed\x20to\x20log\x20test\x20webhook:','161uExlkF','✅\x20CoinToPay\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','get','📈\x20Average\x20payment:\x20','externalPaymentUrl','✅\x20Successful\x20payments:\x20','payment_url','username','payments','availableBalance','_sum','getWebhookLogs','findMany','\x20(8digits-8digits\x20format\x20for\x20','event','lte','generateDateRange','createPayment','invoice_total_sum','txid','getDate','📊\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop:\x20','rapydCustomer','webhookLogs','klymeService','🔄\x20Creating\x20Noda\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','now','getGatewayNameById','generateGatewayUrls','toLowerCase','language','./gateways/rapydService','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','payout','stringify','getTime','paymentId','telegram','5709408HDjrQv','📊\x20Generating\x20shop\x20statistics\x20for\x20period:\x20','gateway_payment_id','\x20(8digits-8digits\x20format)','shopUrl','EUR','aggregate','PENDING','log','⚠️\x20Gateway\x20order\x20ID\x20','💵\x20Total\x20amount\x20(PAID\x20with\x20commission):\x20','📅\x20This\x20Month:\x20','2833025pKVEnS','9sNFyGW','cointopay','payoutDelay','random','No\x20webhook\x20URL\x20configured.\x20Please\x20set\x20up\x20your\x20webhook\x20URL\x20in\x20settings\x20first.','getFullYear','$queryRaw','🎯\x20Generated\x20unique\x20gateway\x20order_id:\x20','PAID','./currencyService','3010040JOltQE','convertToUSDT','isValidGatewayId','test_webhook','13545XtxcwL','HTTP\x20','delete','reduce','env','testWebhook','payment','../config/database','round','date','wallets','https://tesoft.uk','904SxfQKe','_count','redirectUrl','❌\x20Test\x20webhook\x20failed:\x20','amount','publicKey','../types/gateway','toFixed','30d','telegramId','/payment/fail?payment_id=','COMPLETED','filter','Unknown\x20error','isEligibleForPayout','\x20\x20\x20❌\x20Fail:\x20','Test\x20payload:','thisMonth','\x20USDT','toString','💸\x20Total\x20Paid\x20Out:\x20','generateGatewayOrderId','revenue','💰\x20Available\x20Balance:\x20','💳\x20Total\x20payments:\x20','paidAt','message','⏳\x20Awaiting\x20Payout:\x20','toUpperCase','fullName','groupBy','usdtErcWallet','RapydService','getPayments','length','✅\x20KLYME\x20','getPayoutStats','count','getGatewaySettings','maxPayments','updatePayment','customerName','getPayouts','./gateways/coinToPayService','__esModule','215668PepjMd','findUnique','plisioService','REJECTED','\x20already\x20exists,\x20generating\x20new\x20one\x20(attempt\x20','default','qr_url','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Webhook)','amountIsEditable','PlisioService','sourceCurrency','findFirst','Invalid\x20KLYME\x20gateway:\x20','usdcPolygonWallet','gte','gatewaySettings','ceil','https://tesoft.uk/gateways/noda/webhook','🪙\x20Creating\x20CoinToPay\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','expiresAt','USD','https://tesoft.uk/gateway/payment.php?id=','test_payment_','merchantUrl','klyme_','customerEmail','\x20shop\x20payment\x20with\x20gateway\x20order_id:\x20','retryCount','gateways','usdtTrcWallet','90d','parse','split','usdtPolygonWallet','shop','qr_code','🧪\x20Sending\x20test\x20webhook\x20to:\x20','setDate','💰\x20Amount:\x20','coinToPayService','nodaService','text','calculateAmountAfterCommission','toISOString','noda','updateShopProfile','gateway','awaitingPayout'];a48_0x3dd7=function(){return _0x12b2ce;};return a48_0x3dd7();}function a48_0x3f10(_0x414788,_0x34b59d){const _0x3dd7a4=a48_0x3dd7();return a48_0x3f10=function(_0x3f10e3,_0x2a8c74){_0x3f10e3=_0x3f10e3-0x144;let _0x4b55fa=_0x3dd7a4[_0x3f10e3];return _0x4b55fa;},a48_0x3f10(_0x414788,_0x34b59d);}var __importDefault=this&&this[a48_0x167927(0x1f8)]||function(_0x411f6d){const _0xcde11e=a48_0x167927;return _0x411f6d&&_0x411f6d[_0xcde11e(0x19c)]?_0x411f6d:{'default':_0x411f6d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a48_0x167927(0x1ec)]=void 0x0;const database_1=__importDefault(require(a48_0x167927(0x16b))),plisioService_1=require(a48_0x167927(0x1d6)),rapydService_1=require(a48_0x167927(0x22f)),nodaService_1=require(a48_0x167927(0x1df)),coinToPayService_1=require(a48_0x167927(0x19b)),klymeService_1=require('./gateways/klymeService'),currencyService_1=require(a48_0x167927(0x15f)),gateway_1=require(a48_0x167927(0x176));class ShopService{constructor(){const _0xe3dce9=a48_0x167927;this[_0xe3dce9(0x19f)]=new plisioService_1[(_0xe3dce9(0x1a6))](),this[_0xe3dce9(0x208)]=new rapydService_1[(_0xe3dce9(0x190))](),this['nodaService']=new nodaService_1['NodaService'](),this[_0xe3dce9(0x1c4)]=new coinToPayService_1['CoinToPayService'](),this['klymeService']=new klymeService_1[(_0xe3dce9(0x202))]();}async[a48_0x167927(0x185)](){const _0x4c0af5=a48_0x167927;let _0x55e8db,_0x5b17fb=0x0;const _0x27b6bb=0xa;do{const _0x6db32=()=>{const _0x237395=a48_0x3f10;return Math[_0x237395(0x1e2)](Math[_0x237395(0x159)]()*0x5f5e100)[_0x237395(0x183)]()['padStart'](0x8,'0');};_0x55e8db=_0x6db32()+'-'+_0x6db32();const _0x32744f=await database_1[_0x4c0af5(0x1a2)][_0x4c0af5(0x16a)][_0x4c0af5(0x1a8)]({'where':{'gatewayOrderId':_0x55e8db}});if(!_0x32744f)break;_0x5b17fb++,console[_0x4c0af5(0x151)](_0x4c0af5(0x152)+_0x55e8db+_0x4c0af5(0x1a1)+_0x5b17fb+')');}while(_0x5b17fb<_0x27b6bb);if(_0x5b17fb>=_0x27b6bb)throw new Error('Failed\x20to\x20generate\x20unique\x20gateway\x20order\x20ID\x20after\x20maximum\x20attempts');return _0x55e8db;}['generateGatewayUrls'](_0x462f0e,_0x1bf892,_0x4389b8,_0x2f61bf,_0x2ada24){const _0x3a5251=a48_0x167927;if(_0x2f61bf&&_0x2ada24)return{'finalSuccessUrl':_0x2f61bf,'finalFailUrl':_0x2ada24};let _0x52caf6,_0x3db51b;return _0x462f0e===_0x3a5251(0x1c9)||_0x462f0e['startsWith'](_0x3a5251(0x1b5))||_0x462f0e===_0x3a5251(0x157)?_0x52caf6=_0x2f61bf||_0x4389b8+'/payment/pending?payment_id='+_0x1bf892:_0x52caf6=_0x2f61bf||_0x4389b8+_0x3a5251(0x201)+_0x1bf892,_0x3db51b=_0x2ada24||_0x4389b8+_0x3a5251(0x17a)+_0x1bf892,console['log'](_0x3a5251(0x1fa)+_0x462f0e+':'),console['log'](_0x3a5251(0x1dc)+_0x52caf6),console[_0x3a5251(0x151)](_0x3a5251(0x17f)+_0x3db51b),{'finalSuccessUrl':_0x52caf6,'finalFailUrl':_0x3db51b};}[a48_0x167927(0x196)](_0x19ff0c,_0x40852a){const _0x379315=a48_0x167927,_0x12c44e=_0x19ff0c[_0x379315(0x1ac)]?JSON['parse'](_0x19ff0c[_0x379315(0x1ac)]):null,_0x5f302d=_0x40852a['charAt'](0x0)[_0x379315(0x18c)]()+_0x40852a[_0x379315(0x1cf)](0x1)[_0x379315(0x22d)]();if(_0x12c44e&&_0x12c44e[_0x5f302d])return{'commission':_0x12c44e[_0x5f302d][_0x379315(0x20c)],'payoutDelay':_0x12c44e[_0x5f302d][_0x379315(0x158)]};return{'commission':0x0,'payoutDelay':0x0};}[a48_0x167927(0x17e)](_0x1325db,_0x3f57f4){const _0x426f79=a48_0x167927;if(_0x1325db[_0x426f79(0x1e1)]!==_0x426f79(0x15e)||_0x1325db[_0x426f79(0x20a)]||!_0x1325db[_0x426f79(0x189)])return![];const _0x3983b8=_0x3f57f4['payoutDelay']*0x18*0x3c*0x3c*0x3e8,_0x4d41b0=new Date(_0x1325db[_0x426f79(0x189)][_0x426f79(0x146)]()+_0x3983b8);return new Date()>_0x4d41b0;}['calculateAmountAfterCommission'](_0x4cb8f6,_0x146eba){return _0x4cb8f6*(0x1-_0x146eba/0x64);}async[a48_0x167927(0x1d5)](_0x21a583){const _0xde109=a48_0x167927,_0x3e534e=await database_1[_0xde109(0x1a2)][_0xde109(0x1bf)][_0xde109(0x19e)]({'where':{'id':_0x21a583},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});if(!_0x3e534e)throw new Error('Shop\x20not\x20found');return{'id':_0x3e534e['id'],'fullName':_0x3e534e[_0xde109(0x1f1)],'username':_0x3e534e['username'],'telegramId':_0x3e534e[_0xde109(0x148)],'merchantUrl':_0x3e534e['shopUrl'],'gateways':_0x3e534e[_0xde109(0x1f4)]?JSON[_0xde109(0x1bc)](_0x3e534e[_0xde109(0x1f4)]):null,'gatewaySettings':_0x3e534e['gatewaySettings']?JSON[_0xde109(0x1bc)](_0x3e534e[_0xde109(0x1ac)]):null,'publicKey':_0x3e534e[_0xde109(0x175)],'wallets':{'usdtPolygonWallet':_0x3e534e[_0xde109(0x1be)],'usdtTrcWallet':_0x3e534e['usdtTrcWallet'],'usdtErcWallet':_0x3e534e[_0xde109(0x18f)],'usdcPolygonWallet':_0x3e534e['usdcPolygonWallet']},'status':_0x3e534e[_0xde109(0x1e1)],'createdAt':_0x3e534e[_0xde109(0x1d1)]};}async[a48_0x167927(0x1ca)](_0x27cac9,_0xbb557d){const _0x3aea18=a48_0x167927,_0x791aee={..._0xbb557d};_0xbb557d[_0x3aea18(0x18d)]&&(_0x791aee[_0x3aea18(0x1f1)]=_0xbb557d['fullName'],delete _0x791aee[_0x3aea18(0x18d)]);_0xbb557d[_0x3aea18(0x179)]&&(_0x791aee[_0x3aea18(0x148)]=_0xbb557d['telegramId'],delete _0x791aee['telegramId']);_0xbb557d[_0x3aea18(0x1b4)]&&(_0x791aee[_0x3aea18(0x14d)]=_0xbb557d[_0x3aea18(0x1b4)],delete _0x791aee[_0x3aea18(0x1b4)]);_0xbb557d['gateways']&&(_0x791aee[_0x3aea18(0x1f4)]=JSON[_0x3aea18(0x145)](_0xbb557d[_0x3aea18(0x1b9)]),delete _0x791aee['gateways']);_0xbb557d[_0x3aea18(0x1ac)]&&(_0x791aee['gatewaySettings']=JSON[_0x3aea18(0x145)](_0xbb557d[_0x3aea18(0x1ac)]),delete _0x791aee['gatewaySettings']);_0xbb557d['wallets']&&(_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x1be)]!==undefined&&(_0x791aee[_0x3aea18(0x1be)]=_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x1be)]||null),_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x1ba)]!==undefined&&(_0x791aee[_0x3aea18(0x1ba)]=_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x1ba)]||null),_0xbb557d[_0x3aea18(0x16e)]['usdtErcWallet']!==undefined&&(_0x791aee[_0x3aea18(0x18f)]=_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x18f)]||null),_0xbb557d[_0x3aea18(0x16e)][_0x3aea18(0x1aa)]!==undefined&&(_0x791aee[_0x3aea18(0x1aa)]=_0xbb557d[_0x3aea18(0x16e)]['usdcPolygonWallet']||null),delete _0x791aee['wallets']);const _0x48df1b=await database_1['default'][_0x3aea18(0x1bf)][_0x3aea18(0x1d9)]({'where':{'id':_0x27cac9},'data':_0x791aee,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![]}});return{'id':_0x48df1b['id'],'fullName':_0x48df1b[_0x3aea18(0x1f1)],'username':_0x48df1b[_0x3aea18(0x217)],'telegramId':_0x48df1b[_0x3aea18(0x148)],'merchantUrl':_0x48df1b[_0x3aea18(0x14d)],'gateways':_0x48df1b[_0x3aea18(0x1f4)]?JSON[_0x3aea18(0x1bc)](_0x48df1b[_0x3aea18(0x1f4)]):null,'gatewaySettings':_0x48df1b['gatewaySettings']?JSON[_0x3aea18(0x1bc)](_0x48df1b[_0x3aea18(0x1ac)]):null,'publicKey':_0x48df1b['publicKey'],'wallets':{'usdtPolygonWallet':_0x48df1b[_0x3aea18(0x1be)],'usdtTrcWallet':_0x48df1b[_0x3aea18(0x1ba)],'usdtErcWallet':_0x48df1b['usdtErcWallet'],'usdcPolygonWallet':_0x48df1b['usdcPolygonWallet']},'status':_0x48df1b[_0x3aea18(0x1e1)],'createdAt':_0x48df1b[_0x3aea18(0x1d1)]};}async['updateWallets'](_0x3ba6b7,_0x2005f9){const _0x5e4b7c=a48_0x167927,_0x16a34d={};_0x2005f9[_0x5e4b7c(0x1be)]!==undefined&&(_0x16a34d[_0x5e4b7c(0x1be)]=_0x2005f9[_0x5e4b7c(0x1be)]||null),_0x2005f9[_0x5e4b7c(0x1ba)]!==undefined&&(_0x16a34d[_0x5e4b7c(0x1ba)]=_0x2005f9['usdtTrcWallet']||null),_0x2005f9[_0x5e4b7c(0x18f)]!==undefined&&(_0x16a34d[_0x5e4b7c(0x18f)]=_0x2005f9['usdtErcWallet']||null),_0x2005f9[_0x5e4b7c(0x1aa)]!==undefined&&(_0x16a34d[_0x5e4b7c(0x1aa)]=_0x2005f9[_0x5e4b7c(0x1aa)]||null),await database_1[_0x5e4b7c(0x1a2)][_0x5e4b7c(0x1bf)]['update']({'where':{'id':_0x3ba6b7},'data':_0x16a34d});}async[a48_0x167927(0x169)](_0x54505e){const _0x479e36=a48_0x167927,_0x5eb6c8=await database_1['default'][_0x479e36(0x1bf)][_0x479e36(0x19e)]({'where':{'id':_0x54505e},'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x5eb6c8)throw new Error(_0x479e36(0x1d7));const _0x579731=_0x5eb6c8[_0x479e36(0x1e5)]?.[_0x479e36(0x1fb)];if(!_0x579731)throw new Error(_0x479e36(0x15a));const _0x308437=await this[_0x479e36(0x185)](),_0x352be1={'event':'payment.success','payment':{'id':_0x479e36(0x1b3)+Date['now'](),'order_id':null,'gateway_order_id':_0x308437,'gateway':'plisio','amount':0x64,'currency':'USD','status':'paid','customer_email':_0x479e36(0x1f2),'customer_name':_0x479e36(0x203),'created_at':new Date()[_0x479e36(0x1c8)](),'updated_at':new Date()[_0x479e36(0x1c8)]()},'test':!![],'shop':{'id':_0x5eb6c8['id'],'name':_0x5eb6c8[_0x479e36(0x1f1)]},'timestamp':new Date()[_0x479e36(0x1c8)]()},_0x573855=Date[_0x479e36(0x22a)]();let _0x366a08=0x0,_0x269923=![],_0x33780a;try{console[_0x479e36(0x151)](_0x479e36(0x1c1)+_0x579731),console[_0x479e36(0x151)](_0x479e36(0x180),JSON[_0x479e36(0x145)](_0x352be1,null,0x2));const _0xb601a1=await fetch(_0x579731,{'method':'POST','headers':{'Content-Type':_0x479e36(0x1e6),'User-Agent':_0x479e36(0x1a4),'X-Webhook-Test':'true'},'body':JSON[_0x479e36(0x145)](_0x352be1)});_0x366a08=_0xb601a1[_0x479e36(0x1e1)],_0x269923=_0xb601a1['ok'];if(!_0xb601a1['ok']){const _0xd14b3d=await _0xb601a1[_0x479e36(0x1c6)]();_0x33780a=_0x479e36(0x165)+_0xb601a1[_0x479e36(0x1e1)]+':\x20'+_0xd14b3d,console[_0x479e36(0x1cd)](_0x479e36(0x173)+_0x33780a);}else console[_0x479e36(0x151)]('✅\x20Test\x20webhook\x20sent\x20successfully:\x20'+_0xb601a1[_0x479e36(0x1e1)]);}catch(_0x655ece){_0x33780a=_0x655ece instanceof Error?_0x655ece[_0x479e36(0x18a)]:_0x479e36(0x17d),console['error'](_0x479e36(0x1e9)+_0x33780a);}const _0x1c9e2e=Date['now']()-_0x573855;try{await database_1[_0x479e36(0x1a2)][_0x479e36(0x20e)][_0x479e36(0x1f0)]({'data':{'paymentId':_0x479e36(0x163),'shopId':_0x5eb6c8['id'],'event':_0x479e36(0x163),'statusCode':_0x366a08,'responseBody':JSON[_0x479e36(0x145)]({'success':_0x269923,'error':_0x33780a,'responseTime':_0x1c9e2e,'testPayload':_0x352be1})}});}catch(_0x2ac7f4){console['error'](_0x479e36(0x20f),_0x2ac7f4);}return{'webhookUrl':_0x579731,'statusCode':_0x366a08,'responseTime':_0x1c9e2e,'success':_0x269923,'error':_0x33780a};}async[a48_0x167927(0x221)](_0x3cd55d){const _0x17064d=a48_0x167927;let _0x2d9186;if((0x0,gateway_1[_0x17064d(0x162)])(_0x3cd55d[_0x17064d(0x1cb)])){const _0x3ee65e=(0x0,gateway_1[_0x17064d(0x22b)])(_0x3cd55d[_0x17064d(0x1cb)]);if(!_0x3ee65e)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x3cd55d[_0x17064d(0x1cb)]);_0x2d9186=_0x3ee65e;}else _0x2d9186=_0x3cd55d[_0x17064d(0x1cb)][_0x17064d(0x22d)]();console['log']('🔄\x20Creating\x20shop\x20payment\x20for\x20gateway:\x20'+_0x2d9186);const _0x4f3cd1=await this[_0x17064d(0x185)]();console[_0x17064d(0x151)](_0x17064d(0x15d)+_0x4f3cd1+_0x17064d(0x21d)+_0x2d9186+')');const _0x2a169f=await database_1[_0x17064d(0x1a2)][_0x17064d(0x1bf)][_0x17064d(0x19e)]({'where':{'id':_0x3cd55d[_0x17064d(0x20b)]},'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}});if(!_0x2a169f)throw new Error(_0x17064d(0x1d7));const _0x21181e=this[_0x17064d(0x196)](_0x2a169f,_0x2d9186),_0x5e5bcb=process[_0x17064d(0x168)][_0x17064d(0x200)]||_0x17064d(0x16f),{finalSuccessUrl:_0x577681,finalFailUrl:_0x47d2f3}=this[_0x17064d(0x22c)](_0x2d9186,_0x4f3cd1,_0x5e5bcb,_0x3cd55d[_0x17064d(0x172)],undefined),_0x41898f=await database_1['default']['payment']['create']({'data':{'shopId':_0x3cd55d[_0x17064d(0x20b)],'gateway':_0x2d9186,'amount':_0x3cd55d[_0x17064d(0x174)],'currency':_0x3cd55d[_0x17064d(0x206)]||_0x17064d(0x1b1),'sourceCurrency':_0x3cd55d['sourceCurrency']||null,'usage':_0x3cd55d[_0x17064d(0x1ce)]||_0x17064d(0x207),'expiresAt':_0x3cd55d[_0x17064d(0x1b0)],'successUrl':_0x577681,'failUrl':_0x47d2f3,'status':_0x17064d(0x150),'orderId':null,'gatewayOrderId':_0x4f3cd1,'customerEmail':_0x3cd55d[_0x17064d(0x1b6)]||null,'customerName':_0x3cd55d[_0x17064d(0x199)]||null,'country':_0x3cd55d[_0x17064d(0x1dd)]||null,'language':_0x3cd55d[_0x17064d(0x22e)]||null,'amountIsEditable':_0x3cd55d[_0x17064d(0x1a5)]||null,'maxPayments':_0x3cd55d[_0x17064d(0x197)]||null,'rapydCustomer':_0x3cd55d[_0x17064d(0x1d2)]||null},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});console['log'](_0x17064d(0x1ef)+_0x4f3cd1+_0x17064d(0x14c));let _0xcbd611;try{if(_0x2d9186==='plisio'){let _0x153005,_0x3db9de,_0x22f8c7;_0x3cd55d[_0x17064d(0x1a7)]?(_0x153005=_0x3cd55d['sourceCurrency'],_0x3db9de=_0x3cd55d[_0x17064d(0x206)]||_0x17064d(0x1b1),_0x22f8c7=![]):(_0x153005=_0x17064d(0x1b1),_0x3db9de=_0x3cd55d[_0x17064d(0x206)]||'USD',_0x22f8c7=!![]);const _0x4ecc00=await this[_0x17064d(0x19f)][_0x17064d(0x221)]({'paymentId':_0x41898f['id'],'orderId':_0x4f3cd1,'amount':_0x3cd55d[_0x17064d(0x174)],'currency':_0x153005,'productName':_0x17064d(0x20d)+_0x4f3cd1,'description':'Order\x20ID:\x20'+_0x4f3cd1,'successUrl':_0x577681,'failUrl':_0x47d2f3,'customerEmail':_0x3cd55d[_0x17064d(0x1b6)],'customerName':_0x3cd55d[_0x17064d(0x199)],'isSourceCurrency':_0x22f8c7});_0xcbd611=_0x4ecc00['payment_url'],await database_1['default'][_0x17064d(0x16a)]['update']({'where':{'id':_0x41898f['id']},'data':{'externalPaymentUrl':_0xcbd611,'gatewayPaymentId':_0x4ecc00[_0x17064d(0x14b)],'invoiceTotalSum':Number(_0x4ecc00[_0x17064d(0x222)]),'qrCode':_0x4ecc00[_0x17064d(0x1c0)],'qrUrl':_0x4ecc00[_0x17064d(0x1a3)]}}),_0x41898f[_0x17064d(0x214)]=_0xcbd611,_0x41898f[_0x17064d(0x1da)]=_0x4ecc00['gateway_payment_id'];}else{if(_0x2d9186===_0x17064d(0x1e8)){const _0x588558='GB';console[_0x17064d(0x151)](_0x17064d(0x1db));const _0x5ae4c5=await this[_0x17064d(0x208)][_0x17064d(0x1d8)]({'paymentId':_0x41898f['id'],'orderId':_0x4f3cd1,'orderName':_0x17064d(0x20d)+_0x4f3cd1,'amount':_0x3cd55d[_0x17064d(0x174)],'currency':_0x3cd55d['currency']||'USD','country':_0x588558,'usage':_0x3cd55d[_0x17064d(0x1ce)]||_0x17064d(0x207),'maxPayments':_0x3cd55d[_0x17064d(0x197)],'successUrl':_0x577681,'failUrl':_0x47d2f3});_0xcbd611=_0x5ae4c5[_0x17064d(0x216)],await database_1[_0x17064d(0x1a2)]['payment'][_0x17064d(0x1d9)]({'where':{'id':_0x41898f['id']},'data':{'externalPaymentUrl':_0xcbd611,'gatewayPaymentId':_0x5ae4c5[_0x17064d(0x14b)],'country':_0x588558}}),_0x41898f[_0x17064d(0x214)]=_0xcbd611,_0x41898f[_0x17064d(0x1da)]=_0x5ae4c5[_0x17064d(0x14b)];}else{if(_0x2d9186==='noda'){console['log'](_0x17064d(0x229)+_0x4f3cd1+'\x20(8digits-8digits\x20format)');const _0x462897=await this[_0x17064d(0x1c5)][_0x17064d(0x1d8)]({'paymentId':_0x41898f['id'],'orderId':_0x4f3cd1,'name':_0x17064d(0x20d)+_0x4f3cd1,'paymentDescription':'Order\x20ID:\x20'+_0x4f3cd1,'amount':_0x3cd55d['amount'],'currency':_0x3cd55d[_0x17064d(0x206)]||'USD','webhookUrl':_0x17064d(0x1ae),'returnUrl':_0x577681,'expiryDate':_0x3cd55d['expiresAt']?.['toISOString']()});_0xcbd611=_0x462897[_0x17064d(0x216)],await database_1[_0x17064d(0x1a2)][_0x17064d(0x16a)][_0x17064d(0x1d9)]({'where':{'id':_0x41898f['id']},'data':{'externalPaymentUrl':_0xcbd611,'gatewayPaymentId':_0x462897['gateway_payment_id'],'qrUrl':_0x462897['qr_code_url']}}),_0x41898f['externalPaymentUrl']=_0xcbd611,_0x41898f['gatewayPaymentId']=_0x462897[_0x17064d(0x14b)],console[_0x17064d(0x151)]('✅\x20Noda\x20shop\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20'+_0x4f3cd1);}else{if(_0x2d9186===_0x17064d(0x157)){console[_0x17064d(0x151)](_0x17064d(0x1af)+_0x4f3cd1+_0x17064d(0x14c)),console[_0x17064d(0x151)](_0x17064d(0x1c3)+_0x3cd55d[_0x17064d(0x174)]+_0x17064d(0x230));const _0x3865c8=await this['coinToPayService'][_0x17064d(0x1d8)]({'paymentId':_0x41898f['id'],'orderId':_0x4f3cd1,'amount':_0x3cd55d[_0x17064d(0x174)]});_0xcbd611=_0x3865c8[_0x17064d(0x216)],await database_1[_0x17064d(0x1a2)][_0x17064d(0x16a)][_0x17064d(0x1d9)]({'where':{'id':_0x41898f['id']},'data':{'externalPaymentUrl':_0xcbd611,'gatewayPaymentId':_0x3865c8[_0x17064d(0x14b)],'currency':_0x17064d(0x14e)}}),_0x41898f[_0x17064d(0x214)]=_0xcbd611,_0x41898f['gatewayPaymentId']=_0x3865c8[_0x17064d(0x14b)],console[_0x17064d(0x151)](_0x17064d(0x211)+_0x4f3cd1);}else{if(_0x2d9186[_0x17064d(0x1f6)](_0x17064d(0x1b5))){const _0x53aad3=(0x0,gateway_1['getKlymeRegionFromGatewayName'])(_0x2d9186);if(!_0x53aad3)throw new Error(_0x17064d(0x1a9)+_0x2d9186);if(_0x53aad3!=='EU'&&_0x53aad3!=='GB')throw new Error(_0x17064d(0x1fd)+_0x53aad3);console[_0x17064d(0x151)](_0x17064d(0x1ea)+_0x53aad3+_0x17064d(0x1b7)+_0x4f3cd1+_0x17064d(0x14c)),console[_0x17064d(0x151)](_0x17064d(0x1c3)+_0x3cd55d[_0x17064d(0x174)]+'\x20'+(_0x3cd55d[_0x17064d(0x206)]||'USD'));const _0x2af1ed=await this[_0x17064d(0x228)]['createPaymentLink']({'paymentId':_0x41898f['id'],'orderId':_0x4f3cd1,'amount':_0x3cd55d[_0x17064d(0x174)],'currency':_0x3cd55d[_0x17064d(0x206)]||_0x17064d(0x1b1),'region':_0x53aad3,'redirectUrl':_0x577681});_0xcbd611=_0x2af1ed[_0x17064d(0x216)],await database_1[_0x17064d(0x1a2)][_0x17064d(0x16a)]['update']({'where':{'id':_0x41898f['id']},'data':{'externalPaymentUrl':_0xcbd611,'gatewayPaymentId':_0x2af1ed[_0x17064d(0x14b)]}}),_0x41898f[_0x17064d(0x214)]=_0xcbd611,_0x41898f[_0x17064d(0x1da)]=_0x2af1ed[_0x17064d(0x14b)],console['log'](_0x17064d(0x193)+_0x53aad3+_0x17064d(0x231)+_0x4f3cd1);}}}}}}catch(_0x4ac239){await database_1[_0x17064d(0x1a2)][_0x17064d(0x16a)][_0x17064d(0x1d9)]({'where':{'id':_0x41898f['id']},'data':{'status':'FAILED'}}),console[_0x17064d(0x1cd)](_0x17064d(0x1e3),_0x4ac239);}const _0x577e2f='https://tesoft.uk/gateway/payment.php?id='+_0x41898f['id'];return{'id':_0x41898f['id'],'shopId':_0x41898f['shopId'],'gateway':_0x41898f[_0x17064d(0x1cb)],'amount':_0x41898f[_0x17064d(0x174)],'currency':_0x41898f[_0x17064d(0x206)],'sourceCurrency':_0x41898f[_0x17064d(0x1a7)],'usage':_0x41898f[_0x17064d(0x1ce)],'expiresAt':_0x41898f[_0x17064d(0x1b0)],'redirectUrl':_0x577e2f,'status':_0x41898f[_0x17064d(0x1e1)],'externalPaymentUrl':_0xcbd611,'customerEmail':_0x41898f[_0x17064d(0x1b6)],'customerName':_0x41898f[_0x17064d(0x199)],'country':_0x41898f['country'],'language':_0x41898f['language'],'amountIsEditable':_0x41898f[_0x17064d(0x1a5)],'maxPayments':_0x41898f[_0x17064d(0x197)],'customer':_0x41898f[_0x17064d(0x226)],'createdAt':_0x41898f[_0x17064d(0x1d1)],'updatedAt':_0x41898f[_0x17064d(0x1f9)],'shop':_0x41898f[_0x17064d(0x1bf)]};}async[a48_0x167927(0x191)](_0x48b0ef,_0x30033e){const _0x320c62=a48_0x167927,{page:_0x25b5fc,limit:_0x3b19a7,status:_0xc271c6,gateway:_0x301488}=_0x30033e,_0x2eaf5f=(_0x25b5fc-0x1)*_0x3b19a7,_0x23e4af={'shopId':_0x48b0ef};_0xc271c6&&(_0x23e4af[_0x320c62(0x1e1)]=_0xc271c6);if(_0x301488){if((0x0,gateway_1[_0x320c62(0x162)])(_0x301488)){const _0x299d2d=(0x0,gateway_1[_0x320c62(0x22b)])(_0x301488);_0x299d2d&&(_0x23e4af[_0x320c62(0x1cb)]=_0x299d2d);}else _0x23e4af['gateway']=_0x301488[_0x320c62(0x22d)]();}const [_0x5ef43c,_0x2b70ad]=await Promise[_0x320c62(0x1f3)]([database_1[_0x320c62(0x1a2)][_0x320c62(0x16a)][_0x320c62(0x21c)]({'where':_0x23e4af,'skip':_0x2eaf5f,'take':_0x3b19a7,'orderBy':{'createdAt':_0x320c62(0x1f5)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),database_1['default'][_0x320c62(0x16a)][_0x320c62(0x195)]({'where':_0x23e4af})]);return{'payments':_0x5ef43c[_0x320c62(0x1ff)](_0x1d1436=>{const _0x5e8332=_0x320c62,_0x35dc7b=_0x5e8332(0x1b2)+_0x1d1436['id'];return{'id':_0x1d1436['id'],'shopId':_0x1d1436[_0x5e8332(0x20b)],'gateway':_0x1d1436[_0x5e8332(0x1cb)],'amount':_0x1d1436[_0x5e8332(0x174)],'currency':_0x1d1436[_0x5e8332(0x206)],'sourceCurrency':_0x1d1436[_0x5e8332(0x1a7)],'usage':_0x1d1436['usage'],'expiresAt':_0x1d1436[_0x5e8332(0x1b0)],'redirectUrl':_0x35dc7b,'status':_0x1d1436['status'],'externalPaymentUrl':_0x1d1436[_0x5e8332(0x214)],'customerEmail':_0x1d1436['customerEmail'],'customerName':_0x1d1436[_0x5e8332(0x199)],'country':_0x1d1436[_0x5e8332(0x1dd)],'language':_0x1d1436[_0x5e8332(0x22e)],'amountIsEditable':_0x1d1436[_0x5e8332(0x1a5)],'maxPayments':_0x1d1436[_0x5e8332(0x197)],'customer':_0x1d1436[_0x5e8332(0x226)],'createdAt':_0x1d1436[_0x5e8332(0x1d1)],'updatedAt':_0x1d1436['updatedAt'],'shop':_0x1d1436['shop']};}),'pagination':{'page':_0x25b5fc,'limit':_0x3b19a7,'total':_0x2b70ad,'totalPages':Math[_0x320c62(0x1ad)](_0x2b70ad/_0x3b19a7)}};}async[a48_0x167927(0x1d0)](_0x2bdb8d,_0x15414b){const _0x1d4a99=a48_0x167927,_0x250782=await database_1[_0x1d4a99(0x1a2)][_0x1d4a99(0x16a)][_0x1d4a99(0x1a8)]({'where':{'id':_0x15414b,'shopId':_0x2bdb8d},'include':{'shop':{'select':{'name':!![],'username':!![]}},'webhookLogs':{'orderBy':{'createdAt':_0x1d4a99(0x1f5)},'take':0xa}}});if(!_0x250782)return null;const _0x5abeee=_0x1d4a99(0x1b2)+_0x250782['id'];return{'id':_0x250782['id'],'shopId':_0x250782[_0x1d4a99(0x20b)],'gateway':_0x250782[_0x1d4a99(0x1cb)],'amount':_0x250782[_0x1d4a99(0x174)],'currency':_0x250782[_0x1d4a99(0x206)],'sourceCurrency':_0x250782[_0x1d4a99(0x1a7)],'usage':_0x250782[_0x1d4a99(0x1ce)],'expiresAt':_0x250782['expiresAt'],'redirectUrl':_0x5abeee,'status':_0x250782[_0x1d4a99(0x1e1)],'externalPaymentUrl':_0x250782['externalPaymentUrl'],'customerEmail':_0x250782['customerEmail'],'customerName':_0x250782[_0x1d4a99(0x199)],'country':_0x250782[_0x1d4a99(0x1dd)],'language':_0x250782[_0x1d4a99(0x22e)],'amountIsEditable':_0x250782['amountIsEditable'],'maxPayments':_0x250782[_0x1d4a99(0x197)],'customer':_0x250782[_0x1d4a99(0x226)],'createdAt':_0x250782[_0x1d4a99(0x1d1)],'updatedAt':_0x250782['updatedAt'],'shop':_0x250782['shop'],'webhookLogs':_0x250782[_0x1d4a99(0x227)]};}async[a48_0x167927(0x198)](_0x97de11,_0x19b37a,_0x1d6da7){const _0x5c91f0=a48_0x167927,_0x3033e8={..._0x1d6da7};if(_0x1d6da7[_0x5c91f0(0x1cb)]){if((0x0,gateway_1[_0x5c91f0(0x162)])(_0x1d6da7[_0x5c91f0(0x1cb)])){const _0x5690c8=(0x0,gateway_1[_0x5c91f0(0x22b)])(_0x1d6da7['gateway']);_0x5690c8&&(_0x3033e8[_0x5c91f0(0x1cb)]=_0x5690c8);}else _0x3033e8[_0x5c91f0(0x1cb)]=_0x1d6da7[_0x5c91f0(0x1cb)][_0x5c91f0(0x22d)]();}const _0x506cd7=await database_1['default'][_0x5c91f0(0x16a)][_0x5c91f0(0x1d9)]({'where':{'id':_0x19b37a,'shopId':_0x97de11},'data':_0x3033e8,'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),_0x491fbc=_0x5c91f0(0x1b2)+_0x506cd7['id'];return{'id':_0x506cd7['id'],'shopId':_0x506cd7['shopId'],'gateway':_0x506cd7[_0x5c91f0(0x1cb)],'amount':_0x506cd7[_0x5c91f0(0x174)],'currency':_0x506cd7[_0x5c91f0(0x206)],'sourceCurrency':_0x506cd7[_0x5c91f0(0x1a7)],'usage':_0x506cd7[_0x5c91f0(0x1ce)],'expiresAt':_0x506cd7[_0x5c91f0(0x1b0)],'redirectUrl':_0x491fbc,'status':_0x506cd7[_0x5c91f0(0x1e1)],'externalPaymentUrl':_0x506cd7[_0x5c91f0(0x214)],'customerEmail':_0x506cd7[_0x5c91f0(0x1b6)],'customerName':_0x506cd7[_0x5c91f0(0x199)],'country':_0x506cd7[_0x5c91f0(0x1dd)],'language':_0x506cd7['language'],'amountIsEditable':_0x506cd7[_0x5c91f0(0x1a5)],'maxPayments':_0x506cd7[_0x5c91f0(0x197)],'customer':_0x506cd7[_0x5c91f0(0x226)],'createdAt':_0x506cd7[_0x5c91f0(0x1d1)],'updatedAt':_0x506cd7[_0x5c91f0(0x1f9)],'shop':_0x506cd7[_0x5c91f0(0x1bf)]};}async['deletePayment'](_0x19ac4b,_0x454f97){const _0x526547=a48_0x167927;await database_1[_0x526547(0x1a2)][_0x526547(0x16a)][_0x526547(0x166)]({'where':{'id':_0x454f97,'shopId':_0x19ac4b}});}async[a48_0x167927(0x19a)](_0x25c2c1,_0x4ff466){const _0x5ce881=a48_0x167927,{page:_0x34b3e8,limit:_0x410616,status:_0x5cfcd9,method:_0x12d217,dateFrom:_0x3f84c2,dateTo:_0x2adace}=_0x4ff466,_0x11608b=(_0x34b3e8-0x1)*_0x410616,_0x3ba1a3={'shopId':_0x25c2c1};_0x5cfcd9&&(_0x3ba1a3[_0x5ce881(0x1e1)]=_0x5cfcd9);_0x12d217&&(_0x3ba1a3[_0x5ce881(0x1de)]=_0x12d217);(_0x3f84c2||_0x2adace)&&(_0x3ba1a3['createdAt']={},_0x3f84c2&&(_0x3ba1a3[_0x5ce881(0x1d1)][_0x5ce881(0x1ab)]=new Date(_0x3f84c2)),_0x2adace&&(_0x3ba1a3[_0x5ce881(0x1d1)][_0x5ce881(0x21f)]=new Date(_0x2adace)));const [_0x307317,_0x314dc3]=await Promise[_0x5ce881(0x1f3)]([database_1['default'][_0x5ce881(0x144)][_0x5ce881(0x21c)]({'where':_0x3ba1a3,'skip':_0x11608b,'take':_0x410616,'orderBy':{'createdAt':_0x5ce881(0x1f5)}}),database_1[_0x5ce881(0x1a2)][_0x5ce881(0x144)][_0x5ce881(0x195)]({'where':_0x3ba1a3})]);return{'payouts':_0x307317['map'](_0x344d55=>({'id':_0x344d55['id'],'amount':_0x344d55[_0x5ce881(0x174)],'network':_0x344d55[_0x5ce881(0x1de)],'status':_0x344d55[_0x5ce881(0x1e1)],'txid':_0x344d55[_0x5ce881(0x223)],'notes':_0x344d55['notes'],'createdAt':_0x344d55[_0x5ce881(0x1d1)],'paidAt':_0x344d55[_0x5ce881(0x189)]})),'pagination':{'page':_0x34b3e8,'limit':_0x410616,'total':_0x314dc3,'totalPages':Math['ceil'](_0x314dc3/_0x410616)}};}async[a48_0x167927(0x1fe)](_0x47184e,_0xac58d5){const _0x18427f=a48_0x167927,_0x26f1ac=await database_1['default'][_0x18427f(0x144)][_0x18427f(0x1a8)]({'where':{'id':_0xac58d5,'shopId':_0x47184e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x26f1ac)return null;return{'id':_0x26f1ac['id'],'shopId':_0x26f1ac[_0x18427f(0x20b)],'amount':_0x26f1ac[_0x18427f(0x174)],'method':_0x26f1ac[_0x18427f(0x1de)],'status':_0x26f1ac[_0x18427f(0x1e1)],'txid':_0x26f1ac[_0x18427f(0x223)],'createdAt':_0x26f1ac[_0x18427f(0x1d1)],'paidAt':_0x26f1ac['paidAt'],'shop':_0x26f1ac['shop']};}async['getPayoutStatistics'](_0xff2237,_0x225273){const _0x58cf0f=a48_0x167927,_0x4fb920=this[_0x58cf0f(0x1d4)](_0x225273),_0x822a40=new Date();_0x822a40[_0x58cf0f(0x1c2)](_0x822a40[_0x58cf0f(0x224)]()-_0x4fb920);const _0x4e22c1={'shopId':_0xff2237,'createdAt':{'gte':_0x822a40}},[_0x8950dd,_0x27251c,_0x158360,_0xb7dab1,_0x4f55c1,_0x6c579a,_0x34487c,_0x3fff57]=await Promise[_0x58cf0f(0x1f3)]([database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x195)]({'where':_0x4e22c1}),database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x195)]({'where':{..._0x4e22c1,'status':_0x58cf0f(0x17b)}}),database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x195)]({'where':{..._0x4e22c1,'status':'PENDING'}}),database_1['default'][_0x58cf0f(0x144)][_0x58cf0f(0x195)]({'where':{..._0x4e22c1,'status':_0x58cf0f(0x1a0)}}),database_1['default'][_0x58cf0f(0x144)][_0x58cf0f(0x14f)]({'where':_0x4e22c1,'_sum':{'amount':!![]}}),database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x18e)]({'by':[_0x58cf0f(0x1e1)],'where':_0x4e22c1,'_count':{'status':!![]}}),database_1['default']['payout'][_0x58cf0f(0x18e)]({'by':[_0x58cf0f(0x1de)],'where':_0x4e22c1,'_count':{'network':!![]}}),database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x21c)]({'where':{'shopId':_0xff2237},'take':0xa,'orderBy':{'createdAt':_0x58cf0f(0x1f5)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}})]),_0x5b404f=await database_1[_0x58cf0f(0x1a2)][_0x58cf0f(0x144)][_0x58cf0f(0x14f)]({'where':{..._0x4e22c1,'status':'COMPLETED'},'_sum':{'amount':!![]}}),_0x37317a=await database_1['default'][_0x58cf0f(0x144)]['aggregate']({'where':{..._0x4e22c1,'status':_0x58cf0f(0x150)},'_sum':{'amount':!![]}});return{'totalPayouts':_0x8950dd,'completedPayouts':_0x27251c,'pendingPayouts':_0x158360,'rejectedPayouts':_0xb7dab1,'totalAmount':_0x4f55c1[_0x58cf0f(0x21a)]['amount']||0x0,'completedAmount':_0x5b404f['_sum'][_0x58cf0f(0x174)]||0x0,'pendingAmount':_0x37317a['_sum']['amount']||0x0,'payoutsByStatus':_0x6c579a[_0x58cf0f(0x167)]((_0x36bd87,_0x52e0eb)=>{const _0x5875c9=_0x58cf0f;return _0x36bd87[_0x52e0eb['status']]=_0x52e0eb[_0x5875c9(0x171)]['status'],_0x36bd87;},{}),'payoutsByMethod':_0x34487c[_0x58cf0f(0x167)]((_0x5b3f3c,_0x5e6e85)=>{const _0x482744=_0x58cf0f;return _0x5b3f3c[_0x5e6e85[_0x482744(0x1de)]]=_0x5e6e85['_count'][_0x482744(0x1de)],_0x5b3f3c;},{}),'recentPayouts':_0x3fff57[_0x58cf0f(0x1ff)](_0xf9e121=>({'id':_0xf9e121['id'],'shopId':_0xf9e121[_0x58cf0f(0x20b)],'amount':_0xf9e121[_0x58cf0f(0x174)],'method':_0xf9e121[_0x58cf0f(0x1de)],'status':_0xf9e121['status'],'txid':_0xf9e121[_0x58cf0f(0x223)],'createdAt':_0xf9e121[_0x58cf0f(0x1d1)],'paidAt':_0xf9e121[_0x58cf0f(0x189)],'shop':_0xf9e121['shop']}))};}async['getShopPayoutStats'](_0x5871fa){const _0x47c86b=a48_0x167927;console[_0x47c86b(0x151)](_0x47c86b(0x225)+_0x5871fa);const _0x383e54=await database_1[_0x47c86b(0x1a2)][_0x47c86b(0x1bf)][_0x47c86b(0x19e)]({'where':{'id':_0x5871fa},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x383e54)throw new Error(_0x47c86b(0x1d7));const _0x584d3a=await database_1[_0x47c86b(0x1a2)][_0x47c86b(0x16a)][_0x47c86b(0x21c)]({'where':{'shopId':_0x5871fa,'status':_0x47c86b(0x15e)},'select':{'id':!![],'amount':!![],'currency':!![],'gateway':!![],'paidAt':!![],'merchantPaid':!![],'createdAt':!![]}});console[_0x47c86b(0x151)](_0x47c86b(0x1fc)+_0x584d3a[_0x47c86b(0x192)]+_0x47c86b(0x1e7));const _0x1d4758=new Date(),_0x51870f=new Date(_0x1d4758[_0x47c86b(0x15b)](),_0x1d4758[_0x47c86b(0x1e4)](),0x1);let _0x4515a4=0x0,_0x3e0605=0x0,_0x3b2399=0x0,_0x5ab14d=0x0;for(const _0x446f6e of _0x584d3a){const _0x4bd72b=await currencyService_1[_0x47c86b(0x209)][_0x47c86b(0x161)](_0x446f6e[_0x47c86b(0x174)],_0x446f6e[_0x47c86b(0x206)]),_0x33a265=this['getGatewaySettings'](_0x383e54,_0x446f6e[_0x47c86b(0x1cb)]),_0x361062=this[_0x47c86b(0x1c7)](_0x4bd72b,_0x33a265['commission']);_0x446f6e[_0x47c86b(0x20a)]&&(_0x4515a4+=_0x361062,_0x446f6e[_0x47c86b(0x189)]&&_0x446f6e['paidAt']>=_0x51870f&&(_0x3b2399+=_0x361062)),this['isEligibleForPayout'](_0x446f6e,_0x33a265)&&(_0x3e0605+=_0x361062,_0x5ab14d+=_0x4bd72b);}const _0x3acbb0={'availableBalance':Math[_0x47c86b(0x16c)](_0x5ab14d*0x64)/0x64,'totalPaidOut':Math[_0x47c86b(0x16c)](_0x4515a4*0x64)/0x64,'awaitingPayout':Math[_0x47c86b(0x16c)](_0x3e0605*0x64)/0x64,'thisMonth':Math['round'](_0x3b2399*0x64)/0x64};return console['log']('✅\x20Shop\x20payout\x20statistics\x20calculated:'),console[_0x47c86b(0x151)](_0x47c86b(0x187)+_0x3acbb0[_0x47c86b(0x219)]+_0x47c86b(0x182)),console['log'](_0x47c86b(0x184)+_0x3acbb0['totalPaidOut']+_0x47c86b(0x182)),console[_0x47c86b(0x151)](_0x47c86b(0x18b)+_0x3acbb0[_0x47c86b(0x1cc)]+'\x20USDT'),console[_0x47c86b(0x151)](_0x47c86b(0x154)+_0x3acbb0[_0x47c86b(0x181)]+_0x47c86b(0x182)),_0x3acbb0;}async[a48_0x167927(0x194)](_0x4202de){const _0x3e4686=a48_0x167927,_0x1e89c1=await this[_0x3e4686(0x1d3)](_0x4202de);return{'totalBalance':_0x1e89c1['availableBalance'],'totalPaidOut':_0x1e89c1['totalPaidOut'],'awaitingPayout':_0x1e89c1[_0x3e4686(0x1cc)],'thisMonth':_0x1e89c1['thisMonth']};}async[a48_0x167927(0x21b)](_0x3a6f71,_0x102d0e){const _0x10a522=a48_0x167927,{page:_0x28b859,limit:_0x10810f,paymentId:_0x2e18b}=_0x102d0e,_0x22ea12=(_0x28b859-0x1)*_0x10810f,_0x460652={'shopId':_0x3a6f71};_0x2e18b&&(_0x460652['paymentId']=_0x2e18b);const [_0x2069ad,_0x8a97ad]=await Promise[_0x10a522(0x1f3)]([database_1[_0x10a522(0x1a2)][_0x10a522(0x20e)]['findMany']({'where':_0x460652,'skip':_0x22ea12,'take':_0x10810f,'orderBy':{'createdAt':_0x10a522(0x1f5)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1['default'][_0x10a522(0x20e)][_0x10a522(0x195)]({'where':_0x460652})]);return{'logs':_0x2069ad[_0x10a522(0x1ff)](_0x233424=>({'id':_0x233424['id'],'paymentId':_0x233424[_0x10a522(0x147)],'shopId':_0x233424[_0x10a522(0x20b)],'event':_0x233424[_0x10a522(0x21e)],'statusCode':_0x233424['statusCode'],'retryCount':_0x233424[_0x10a522(0x1b8)],'responseBody':_0x233424['responseBody'],'createdAt':_0x233424[_0x10a522(0x1d1)],'payment':_0x233424[_0x10a522(0x16a)]})),'pagination':{'page':_0x28b859,'limit':_0x10810f,'total':_0x8a97ad,'totalPages':Math[_0x10a522(0x1ad)](_0x8a97ad/_0x10810f)}};}async[a48_0x167927(0x205)](_0x36e364,_0x3fe65a){const _0x375bff=a48_0x167927,_0x3de7ba=this['getPeriodDays'](_0x3fe65a),_0x1097c6=new Date();_0x1097c6[_0x375bff(0x1c2)](_0x1097c6[_0x375bff(0x224)]()-_0x3de7ba),console[_0x375bff(0x151)](_0x375bff(0x14a)+_0x3fe65a+'\x20('+_0x3de7ba+'\x20days)');const _0x3e7fa3={'shopId':_0x36e364,'createdAt':{'gte':_0x1097c6}},_0x559ccb=await database_1[_0x375bff(0x1a2)]['shop'][_0x375bff(0x19e)]({'where':{'id':_0x36e364},'select':{'id':!![],'gatewaySettings':!![]}});if(!_0x559ccb)throw new Error(_0x375bff(0x1d7));const [_0x20ad55,_0xc915d1,_0x21818f,_0x1a93b9,_0x51965c,_0x232233,_0x334845,_0x3b08ec]=await Promise['all']([database_1['default'][_0x375bff(0x16a)][_0x375bff(0x195)]({'where':_0x3e7fa3}),database_1[_0x375bff(0x1a2)][_0x375bff(0x16a)][_0x375bff(0x195)]({'where':{..._0x3e7fa3,'status':_0x375bff(0x15e)}}),database_1[_0x375bff(0x1a2)]['payment'][_0x375bff(0x21c)]({'where':_0x3e7fa3,'select':{'amount':!![],'currency':!![],'status':!![]}}),database_1[_0x375bff(0x1a2)]['payment'][_0x375bff(0x21c)]({'where':{..._0x3e7fa3,'status':'PAID'},'select':{'amount':!![],'currency':!![],'gateway':!![]}}),database_1[_0x375bff(0x1a2)][_0x375bff(0x16a)][_0x375bff(0x18e)]({'by':[_0x375bff(0x1e1)],'where':_0x3e7fa3,'_count':{'status':!![]}}),database_1[_0x375bff(0x1a2)][_0x375bff(0x16a)]['groupBy']({'by':[_0x375bff(0x1cb)],'where':_0x3e7fa3,'_count':{'gateway':!![]}}),database_1[_0x375bff(0x1a2)][_0x375bff(0x16a)][_0x375bff(0x21c)]({'where':{'shopId':_0x36e364},'take':0xa,'orderBy':{'createdAt':_0x375bff(0x1f5)},'include':{'shop':{'select':{'name':!![],'username':!![]}}}}),await database_1[_0x375bff(0x1a2)][_0x375bff(0x15c)]`
        SELECT 
          DATE(created_at) as date,
          COUNT(*)::int as count,
          array_agg(
            json_build_object(
              'amount', amount,
              'currency', currency,
              'status', status,
              'gateway', gateway
            )
          ) as payments
        FROM payments 
        WHERE shop_id = ${_0x36e364} 
          AND created_at >= ${_0x1097c6}
        GROUP BY DATE(created_at)
        ORDER BY date ASC
      `]);console[_0x375bff(0x151)](_0x375bff(0x1fc)+_0x1a93b9[_0x375bff(0x192)]+'\x20PAID\x20payments\x20for\x20totalAmount\x20calculation');const _0x54881e=await Promise[_0x375bff(0x1f3)](_0x1a93b9[_0x375bff(0x1ff)](async _0x5cd140=>{const _0x23573a=_0x375bff,_0x1efe63=await currencyService_1[_0x23573a(0x209)][_0x23573a(0x161)](_0x5cd140[_0x23573a(0x174)],_0x5cd140[_0x23573a(0x206)]),_0x1a0fa0=this[_0x23573a(0x196)](_0x559ccb,_0x5cd140[_0x23573a(0x1cb)]),_0x4c1b2a=this[_0x23573a(0x1c7)](_0x1efe63,_0x1a0fa0['commission']);return _0x4c1b2a;})),_0x22c3f6=await Promise['all'](_0x21818f['map'](async _0x1cf11d=>{const _0x2136d3=_0x375bff,_0x4215b5=await currencyService_1[_0x2136d3(0x209)][_0x2136d3(0x161)](_0x1cf11d['amount'],_0x1cf11d[_0x2136d3(0x206)]);return{'amount':_0x4215b5,'status':_0x1cf11d[_0x2136d3(0x1e1)]};})),_0x37dc73=_0x54881e[_0x375bff(0x167)]((_0x5bb7c0,_0x5f101e)=>_0x5bb7c0+_0x5f101e,0x0),_0x410981=_0x20ad55>0x0?_0x22c3f6[_0x375bff(0x167)]((_0xce6225,_0x4ec2f1)=>_0xce6225+_0x4ec2f1['amount'],0x0)/_0x20ad55:0x0;console[_0x375bff(0x151)](_0x375bff(0x153)+_0x37dc73[_0x375bff(0x177)](0x2)+'\x20USDT'),console[_0x375bff(0x151)](_0x375bff(0x213)+_0x410981[_0x375bff(0x177)](0x2)+_0x375bff(0x182));const _0x4a7329=this[_0x375bff(0x220)](_0x1097c6,new Date()),_0x21766b=await Promise['all'](_0x3b08ec[_0x375bff(0x1ff)](async _0xb0de43=>{const _0x11558b=_0x375bff,_0x5b4f04=_0xb0de43[_0x11558b(0x218)][_0x11558b(0x17c)](_0x3fb3c2=>_0x3fb3c2['status']===_0x11558b(0x15e)),_0x47c2b2=await Promise[_0x11558b(0x1f3)](_0x5b4f04[_0x11558b(0x1ff)](async _0x46c54c=>{const _0x2cf0ba=_0x11558b,_0x53f392=await currencyService_1[_0x2cf0ba(0x209)][_0x2cf0ba(0x161)](_0x46c54c['amount'],_0x46c54c[_0x2cf0ba(0x206)]),_0x5d7fa1=this['getGatewaySettings'](_0x559ccb,_0x46c54c[_0x2cf0ba(0x1cb)]),_0x5c1e5a=this[_0x2cf0ba(0x1c7)](_0x53f392,_0x5d7fa1[_0x2cf0ba(0x20c)]);return _0x5c1e5a;})),_0x48faa1=_0x47c2b2[_0x11558b(0x167)]((_0x35acf8,_0x2a15b7)=>_0x35acf8+_0x2a15b7,0x0);return{'date':_0xb0de43[_0x11558b(0x16d)][_0x11558b(0x1c8)]()[_0x11558b(0x1bd)]('T')[0x0],'count':_0xb0de43[_0x11558b(0x195)],'revenue':_0x48faa1};})),_0x26a19e=new Map(_0x21766b[_0x375bff(0x1ff)](_0x4d6b55=>[_0x4d6b55[_0x375bff(0x16d)],{'count':_0x4d6b55[_0x375bff(0x195)],'revenue':_0x4d6b55['revenue']}])),_0x20aa6a=_0x4a7329[_0x375bff(0x1ff)](_0x30a5b6=>({'date':_0x30a5b6,'amount':_0x26a19e[_0x375bff(0x212)](_0x30a5b6)?.[_0x375bff(0x186)]||0x0})),_0x40cac1=_0x4a7329['map'](_0x51a21d=>({'date':_0x51a21d,'count':_0x26a19e[_0x375bff(0x212)](_0x51a21d)?.[_0x375bff(0x195)]||0x0}));return console[_0x375bff(0x151)](_0x375bff(0x1e0)),console['log'](_0x375bff(0x188)+_0x20ad55),console['log'](_0x375bff(0x215)+_0xc915d1),console[_0x375bff(0x151)](_0x375bff(0x1eb)+_0x20aa6a[_0x375bff(0x192)]),{'totalPayments':_0x20ad55,'successfulPayments':_0xc915d1,'totalAmount':Math[_0x375bff(0x16c)](_0x37dc73*0x64)/0x64,'averageAmount':Math[_0x375bff(0x16c)](_0x410981*0x64)/0x64,'paymentsByStatus':_0x51965c[_0x375bff(0x167)]((_0x8fa565,_0x5ee6fe)=>{const _0x3db994=_0x375bff;return _0x8fa565[_0x5ee6fe['status']]=_0x5ee6fe[_0x3db994(0x171)][_0x3db994(0x1e1)],_0x8fa565;},{}),'paymentsByGateway':_0x232233[_0x375bff(0x167)]((_0x4ce6e6,_0x1f4556)=>{const _0x21bd83=_0x375bff;return _0x4ce6e6[_0x1f4556[_0x21bd83(0x1cb)]]=_0x1f4556['_count'][_0x21bd83(0x1cb)],_0x4ce6e6;},{}),'recentPayments':_0x334845[_0x375bff(0x1ff)](_0x44af27=>{const _0xe0559b=_0x375bff,_0x5cdced=_0xe0559b(0x1b2)+_0x44af27['id'];return{'id':_0x44af27['id'],'shopId':_0x44af27[_0xe0559b(0x20b)],'gateway':_0x44af27[_0xe0559b(0x1cb)],'amount':_0x44af27[_0xe0559b(0x174)],'currency':_0x44af27[_0xe0559b(0x206)],'sourceCurrency':_0x44af27[_0xe0559b(0x1a7)],'usage':_0x44af27[_0xe0559b(0x1ce)],'expiresAt':_0x44af27[_0xe0559b(0x1b0)],'redirectUrl':_0x5cdced,'status':_0x44af27[_0xe0559b(0x1e1)],'externalPaymentUrl':_0x44af27[_0xe0559b(0x214)],'customerEmail':_0x44af27[_0xe0559b(0x1b6)],'customerName':_0x44af27[_0xe0559b(0x199)],'country':_0x44af27['country'],'language':_0x44af27['language'],'amountIsEditable':_0x44af27[_0xe0559b(0x1a5)],'maxPayments':_0x44af27['maxPayments'],'customer':_0x44af27[_0xe0559b(0x226)],'createdAt':_0x44af27[_0xe0559b(0x1d1)],'updatedAt':_0x44af27[_0xe0559b(0x1f9)],'shop':_0x44af27[_0xe0559b(0x1bf)]};}),'dailyRevenue':_0x20aa6a,'dailyPayments':_0x40cac1};}['getPeriodDays'](_0x56814a){const _0xcd7b63=a48_0x167927;switch(_0x56814a){case'7d':return 0x7;case _0xcd7b63(0x178):return 0x1e;case _0xcd7b63(0x1bb):return 0x5a;case'1y':return 0x16d;default:return 0x1e;}}['generateDateRange'](_0x29d230,_0x582570){const _0x2dfff7=a48_0x167927,_0x48966e=[],_0xf1a844=new Date(_0x29d230);while(_0xf1a844<=_0x582570){_0x48966e[_0x2dfff7(0x1ed)](_0xf1a844[_0x2dfff7(0x1c8)]()[_0x2dfff7(0x1bd)]('T')[0x0]),_0xf1a844['setDate'](_0xf1a844[_0x2dfff7(0x224)]()+0x1);}return _0x48966e;}}exports[a48_0x167927(0x1ec)]=ShopService;