'use strict';function a52_0x5948(_0x51e6ad,_0x45293c){const _0x194e2d=a52_0x194e();return a52_0x5948=function(_0x594870,_0x18adbb){_0x594870=_0x594870-0x84;let _0x450705=_0x194e2d[_0x594870];return _0x450705;},a52_0x5948(_0x51e6ad,_0x45293c);}const a52_0xabd2fe=a52_0x5948;(function(_0x49c263,_0x405a4e){const _0xd2ce16=a52_0x5948,_0x2c9c61=_0x49c263();while(!![]){try{const _0x49557f=-parseInt(_0xd2ce16(0x10f))/0x1*(-parseInt(_0xd2ce16(0x119))/0x2)+-parseInt(_0xd2ce16(0xf6))/0x3+parseInt(_0xd2ce16(0xa7))/0x4*(parseInt(_0xd2ce16(0xd9))/0x5)+-parseInt(_0xd2ce16(0xa8))/0x6+parseInt(_0xd2ce16(0x84))/0x7+-parseInt(_0xd2ce16(0x117))/0x8*(parseInt(_0xd2ce16(0xdd))/0x9)+-parseInt(_0xd2ce16(0xc4))/0xa*(-parseInt(_0xd2ce16(0xf9))/0xb);if(_0x49557f===_0x405a4e)break;else _0x2c9c61['push'](_0x2c9c61['shift']());}catch(_0x1e71c6){_0x2c9c61['push'](_0x2c9c61['shift']());}}}(a52_0x194e,0xc5240));var __importDefault=this&&this[a52_0xabd2fe(0xd1)]||function(_0x578adc){const _0x1b555a=a52_0xabd2fe;return _0x578adc&&_0x578adc[_0x1b555a(0xf0)]?_0x578adc:{'default':_0x578adc};};Object[a52_0xabd2fe(0xdc)](exports,a52_0xabd2fe(0xf0),{'value':!![]}),exports[a52_0xabd2fe(0x115)]=void 0x0;const database_1=__importDefault(require('../config/database')),currencyService_1=require('./currencyService'),paymentService_1=require('./paymentService');function a52_0x194e(){const _0x5a0db6=['amountIsEditable','totalPaidOut','Plisio','paymentService','lte','\x20USDT','paymentId','testWebhook','payment','awaitingPayout','notes','isArray','parse','üìä\x20Shop\x20','webhookUrl','usdtPolygonWallet','test_gateway','PAID','status','8984350UdEEeU','createPublicPayment','thisMonth','settings','paymentGateways','split','getPayoutStatistics','getPayments','USD','dailyRevenue','responseBody','setDate','gateway','__importDefault','currency','findMany','Webhook\x20returned\x20error:\x20','getShopPayoutStats','expiresAt','shopUrl','merchantUrl','90925aMZnRO','customer','push','defineProperty','9NkqJZk','REJECTED','KLYME\x20DE','aggregate','findUnique','telegramId','gatewaySettings','language','No\x20webhook\x20URL\x20configured','\x20USDT\x20(current\x20balance)','usage','amount','publicKey','count','90d','txid','getMonth','ceil','all','__esModule','amountUSDT','statusText','_sum','toUpperCase','set','3410418ShFAYj','gte','customerName','33fwvRcA','getPayoutById','redirectUrl','\x20USDT\x20(total\x20payouts)','generateDailyStatistics','KLYME\x20GB','payout','usdtErcWallet','convertToUSDT','Noda','Payment\x20not\x20found','telegram','getPaymentByShopAndId','fullName','test','createPayment','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','shop','username','Rapyd','\x20\x20\x20üìÖ\x20This\x20month:\x20','Shop\x20not\x20found','13799xXlIue','updateWallets','default','update','toISOString','30d','ShopService','maxPayments','11778888wqUUls','Test\x20Gateway','180JHdoaO','round','log','gateways','paidAt','updateShopProfile','Error\x20parsing\x20webhook\x20events:','desc','5779333zzZgHu','\x20payout\x20statistics\x20calculated:','application/json','COMPLETED','findFirst','dailyPayments','\x20\x20\x20üíµ\x20Available\x20balance:\x20','balance','availableBalance','stringify','webhookEvents','reduce','revenue','TesSoft\x20Payment\x20System/1.0\x20(Test)','getTime','getWebhookLogs','retryCount','PENDING','CoinToPay','getPayouts','test_order_123','map','usdtTrcWallet','getFullYear','filter','message','shopId','getShopProfile','createdAt','sourceCurrency','currencyService','network','usdcPolygonWallet','delete','getPayoutStats','40sYhlYA','9168174WeiRqh','webhookLog','\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20','updatePayment','Test\x20webhook\x20sent\x20successfully\x20(','Failed\x20to\x20send\x20webhook:\x20','wallets','getPaymentById','name'];a52_0x194e=function(){return _0x5a0db6;};return a52_0x194e();}class ShopService{constructor(){this['paymentService']=new paymentService_1['PaymentService']();}async[a52_0xabd2fe(0x9f)](_0x221c08){const _0x133925=a52_0xabd2fe,_0x28b167=await database_1[_0x133925(0x111)][_0x133925(0x10a)][_0x133925(0xe1)]({'where':{'id':_0x221c08},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x28b167)throw new Error(_0x133925(0x10e));let _0x5f38be=[];if(_0x28b167['settings']?.['webhookEvents'])try{_0x5f38be=Array[_0x133925(0xbc)](_0x28b167[_0x133925(0xc7)]['webhookEvents'])?_0x28b167[_0x133925(0xc7)][_0x133925(0x8e)]:JSON[_0x133925(0xbd)](_0x28b167[_0x133925(0xc7)][_0x133925(0x8e)]);}catch(_0x17c875){console['error'](_0x133925(0x11f),_0x17c875),_0x5f38be=[];}return{'id':_0x28b167['id'],'fullName':_0x28b167[_0x133925(0xb0)],'username':_0x28b167[_0x133925(0x10b)],'telegramId':_0x28b167[_0x133925(0x104)],'merchantUrl':_0x28b167[_0x133925(0xd7)],'gateways':_0x28b167[_0x133925(0xc8)]?JSON[_0x133925(0xbd)](_0x28b167[_0x133925(0xc8)]):null,'gatewaySettings':_0x28b167[_0x133925(0xe3)]?JSON['parse'](_0x28b167['gatewaySettings']):null,'publicKey':_0x28b167[_0x133925(0xe9)],'webhookUrl':_0x28b167[_0x133925(0xc7)]?.[_0x133925(0xbf)]||null,'webhookEvents':_0x5f38be,'wallets':{'usdtPolygonWallet':_0x28b167[_0x133925(0xc0)],'usdtTrcWallet':_0x28b167[_0x133925(0x9a)],'usdtErcWallet':_0x28b167['usdtErcWallet'],'usdcPolygonWallet':_0x28b167[_0x133925(0xa4)]},'status':_0x28b167['status'],'createdAt':_0x28b167[_0x133925(0xa0)]};}async[a52_0xabd2fe(0x11e)](_0x40a325,_0x5ac0bb){const _0x590d1a=a52_0xabd2fe,_0x41df03={};_0x5ac0bb[_0x590d1a(0x106)]&&(_0x41df03[_0x590d1a(0xb0)]=_0x5ac0bb['fullName']);_0x5ac0bb[_0x590d1a(0xe2)]!==undefined&&(_0x41df03[_0x590d1a(0x104)]=_0x5ac0bb[_0x590d1a(0xe2)]||null);_0x5ac0bb[_0x590d1a(0xd8)]&&(_0x41df03[_0x590d1a(0xd7)]=_0x5ac0bb[_0x590d1a(0xd8)]);_0x5ac0bb[_0x590d1a(0x11c)]&&(_0x41df03[_0x590d1a(0xc8)]=JSON[_0x590d1a(0x8d)](_0x5ac0bb[_0x590d1a(0x11c)]));_0x5ac0bb['gatewaySettings']&&(_0x41df03[_0x590d1a(0xe3)]=JSON[_0x590d1a(0x8d)](_0x5ac0bb[_0x590d1a(0xe3)]));_0x5ac0bb[_0x590d1a(0xae)]&&(_0x5ac0bb['wallets']['usdtPolygonWallet']!==undefined&&(_0x41df03[_0x590d1a(0xc0)]=_0x5ac0bb[_0x590d1a(0xae)]['usdtPolygonWallet']||null),_0x5ac0bb['wallets'][_0x590d1a(0x9a)]!==undefined&&(_0x41df03[_0x590d1a(0x9a)]=_0x5ac0bb[_0x590d1a(0xae)][_0x590d1a(0x9a)]||null),_0x5ac0bb[_0x590d1a(0xae)][_0x590d1a(0x100)]!==undefined&&(_0x41df03[_0x590d1a(0x100)]=_0x5ac0bb['wallets'][_0x590d1a(0x100)]||null),_0x5ac0bb[_0x590d1a(0xae)][_0x590d1a(0xa4)]!==undefined&&(_0x41df03[_0x590d1a(0xa4)]=_0x5ac0bb[_0x590d1a(0xae)][_0x590d1a(0xa4)]||null));const _0x5dbbe8=await database_1[_0x590d1a(0x111)][_0x590d1a(0x10a)][_0x590d1a(0x112)]({'where':{'id':_0x40a325},'data':_0x41df03,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x398b4f=[];if(_0x5dbbe8[_0x590d1a(0xc7)]?.['webhookEvents'])try{_0x398b4f=Array['isArray'](_0x5dbbe8['settings']['webhookEvents'])?_0x5dbbe8['settings'][_0x590d1a(0x8e)]:JSON[_0x590d1a(0xbd)](_0x5dbbe8[_0x590d1a(0xc7)]['webhookEvents']);}catch(_0x56a074){console['error'](_0x590d1a(0x11f),_0x56a074),_0x398b4f=[];}return{'id':_0x5dbbe8['id'],'fullName':_0x5dbbe8[_0x590d1a(0xb0)],'username':_0x5dbbe8[_0x590d1a(0x10b)],'telegramId':_0x5dbbe8[_0x590d1a(0x104)],'merchantUrl':_0x5dbbe8[_0x590d1a(0xd7)],'gateways':_0x5dbbe8[_0x590d1a(0xc8)]?JSON['parse'](_0x5dbbe8[_0x590d1a(0xc8)]):null,'gatewaySettings':_0x5dbbe8[_0x590d1a(0xe3)]?JSON[_0x590d1a(0xbd)](_0x5dbbe8[_0x590d1a(0xe3)]):null,'publicKey':_0x5dbbe8[_0x590d1a(0xe9)],'webhookUrl':_0x5dbbe8['settings']?.[_0x590d1a(0xbf)]||null,'webhookEvents':_0x398b4f,'wallets':{'usdtPolygonWallet':_0x5dbbe8[_0x590d1a(0xc0)],'usdtTrcWallet':_0x5dbbe8[_0x590d1a(0x9a)],'usdtErcWallet':_0x5dbbe8[_0x590d1a(0x100)],'usdcPolygonWallet':_0x5dbbe8['usdcPolygonWallet']},'status':_0x5dbbe8[_0x590d1a(0xc3)],'createdAt':_0x5dbbe8[_0x590d1a(0xa0)]};}async[a52_0xabd2fe(0x110)](_0x600269,_0x301cb0){const _0x4f4ed4=a52_0xabd2fe,_0x763b29={};_0x301cb0[_0x4f4ed4(0xc0)]!==undefined&&(_0x763b29[_0x4f4ed4(0xc0)]=_0x301cb0[_0x4f4ed4(0xc0)]||null),_0x301cb0[_0x4f4ed4(0x9a)]!==undefined&&(_0x763b29[_0x4f4ed4(0x9a)]=_0x301cb0[_0x4f4ed4(0x9a)]||null),_0x301cb0[_0x4f4ed4(0x100)]!==undefined&&(_0x763b29[_0x4f4ed4(0x100)]=_0x301cb0[_0x4f4ed4(0x100)]||null),_0x301cb0[_0x4f4ed4(0xa4)]!==undefined&&(_0x763b29[_0x4f4ed4(0xa4)]=_0x301cb0[_0x4f4ed4(0xa4)]||null),await database_1['default']['shop'][_0x4f4ed4(0x112)]({'where':{'id':_0x600269},'data':_0x763b29});}async[a52_0xabd2fe(0xb8)](_0xadae0c){const _0x5367f8=a52_0xabd2fe,_0xd81a76=await database_1[_0x5367f8(0x111)][_0x5367f8(0x10a)][_0x5367f8(0xe1)]({'where':{'id':_0xadae0c},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0xd81a76?.[_0x5367f8(0xc7)]?.['webhookUrl'])throw new Error(_0x5367f8(0xe5));const _0xfc8a35={'event':_0x5367f8(0x107),'payment':{'id':'test_payment_123','order_id':_0x5367f8(0x98),'gateway':_0x5367f8(0x107),'amount':0x64,'currency':_0x5367f8(0xcc),'status':'paid','created_at':new Date()[_0x5367f8(0x113)]()}};try{const _0x477d14=await fetch(_0xd81a76[_0x5367f8(0xc7)]['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x5367f8(0x86),'User-Agent':_0x5367f8(0x91)},'body':JSON[_0x5367f8(0x8d)](_0xfc8a35)});return _0x477d14['ok']?{'success':!![],'message':_0x5367f8(0xac)+_0x477d14['status']+')'}:{'success':![],'message':_0x5367f8(0xd4)+_0x477d14[_0x5367f8(0xc3)]+'\x20'+_0x477d14[_0x5367f8(0xf2)]};}catch(_0x5dd072){return{'success':![],'message':_0x5367f8(0xad)+(_0x5dd072 instanceof Error?_0x5dd072[_0x5367f8(0x9d)]:'Unknown\x20error')};}}async[a52_0xabd2fe(0x108)](_0x4d30ee){const _0x584c50=a52_0xabd2fe;return this[_0x584c50(0xb4)][_0x584c50(0xc5)]({'public_key':'','gateway':_0x4d30ee[_0x584c50(0xd0)],'order_id':undefined,'amount':_0x4d30ee[_0x584c50(0xe8)],'currency':_0x4d30ee['currency'],'source_currency':_0x4d30ee[_0x584c50(0xa1)],'usage':_0x4d30ee[_0x584c50(0xe7)],'expires_at':_0x4d30ee[_0x584c50(0xd6)]?.['toISOString'](),'success_url':_0x4d30ee[_0x584c50(0xfb)],'fail_url':_0x4d30ee[_0x584c50(0xfb)],'customer_email':_0x4d30ee['customerEmail'],'customer_name':_0x4d30ee[_0x584c50(0xf8)],'country':_0x4d30ee['country'],'language':_0x4d30ee[_0x584c50(0xe4)],'amount_is_editable':_0x4d30ee[_0x584c50(0xb1)],'max_payments':_0x4d30ee[_0x584c50(0x116)],'customer':_0x4d30ee[_0x584c50(0xda)]});}async[a52_0xabd2fe(0xcb)](_0x2db6fd,_0x4f128e){const _0x506a50=a52_0xabd2fe;return this[_0x506a50(0xb4)]['getPaymentsByShop'](_0x2db6fd,_0x4f128e);}async[a52_0xabd2fe(0xaf)](_0x124ef8,_0x448282){const _0x3e1592=a52_0xabd2fe;return this[_0x3e1592(0xb4)][_0x3e1592(0x105)](_0x124ef8,_0x448282);}async[a52_0xabd2fe(0xab)](_0x27bb52,_0x2aca64,_0x3621b6){const _0x396da0=a52_0xabd2fe,_0x387cae=await database_1['default'][_0x396da0(0xb9)][_0x396da0(0x88)]({'where':{'id':_0x2aca64,'shopId':_0x27bb52}});if(!_0x387cae)throw new Error(_0x396da0(0x103));const _0x69d4a1=await database_1[_0x396da0(0x111)][_0x396da0(0xb9)][_0x396da0(0x112)]({'where':{'id':_0x2aca64},'data':{..._0x3621b6,'updatedAt':new Date()}});return _0x69d4a1;}async['deletePayment'](_0x11194d,_0x2de11c){const _0x7a2ead=a52_0xabd2fe,_0x2876cb=await database_1['default'][_0x7a2ead(0xb9)][_0x7a2ead(0x88)]({'where':{'id':_0x2de11c,'shopId':_0x11194d}});if(!_0x2876cb)throw new Error(_0x7a2ead(0x103));await database_1[_0x7a2ead(0x111)][_0x7a2ead(0xb9)][_0x7a2ead(0xa5)]({'where':{'id':_0x2de11c}});}async[a52_0xabd2fe(0x97)](_0x51e4f8,_0x764efa){const _0x29392f=a52_0xabd2fe,{page:_0x1d53ea,limit:_0x223583,status:_0x421620,method:_0x4d28c3,dateFrom:_0xeec02e,dateTo:_0x3baa1e,periodFrom:_0xf651ef,periodTo:_0x2bd2fe}=_0x764efa,_0x1ba909=(_0x1d53ea-0x1)*_0x223583,_0x5d32fa={'shopId':_0x51e4f8};_0x421620&&(_0x5d32fa[_0x29392f(0xc3)]=_0x421620[_0x29392f(0xf4)]());_0x4d28c3&&(_0x5d32fa[_0x29392f(0xa3)]=_0x4d28c3);if(_0xeec02e||_0x3baa1e||_0xf651ef||_0x2bd2fe){_0x5d32fa[_0x29392f(0xa0)]={};if(_0xf651ef)_0x5d32fa[_0x29392f(0xa0)]['gte']=new Date(_0xf651ef);else _0xeec02e&&(_0x5d32fa['createdAt'][_0x29392f(0xf7)]=new Date(_0xeec02e));if(_0x2bd2fe)_0x5d32fa[_0x29392f(0xa0)][_0x29392f(0xb5)]=new Date(_0x2bd2fe);else _0x3baa1e&&(_0x5d32fa[_0x29392f(0xa0)][_0x29392f(0xb5)]=new Date(_0x3baa1e));}const [_0x5df591,_0x2e75a5]=await Promise['all']([database_1[_0x29392f(0x111)][_0x29392f(0xff)][_0x29392f(0xd3)]({'where':_0x5d32fa,'skip':_0x1ba909,'take':_0x223583,'orderBy':{'createdAt':_0x29392f(0x120)}}),database_1['default'][_0x29392f(0xff)][_0x29392f(0xea)]({'where':_0x5d32fa})]);return{'payouts':_0x5df591[_0x29392f(0x99)](_0x2e8a0a=>({'id':_0x2e8a0a['id'],'amount':_0x2e8a0a[_0x29392f(0xe8)],'network':_0x2e8a0a[_0x29392f(0xa3)],'status':_0x2e8a0a['status'],'txid':_0x2e8a0a[_0x29392f(0xec)],'notes':_0x2e8a0a[_0x29392f(0xbb)],'createdAt':_0x2e8a0a[_0x29392f(0xa0)],'paidAt':_0x2e8a0a['paidAt']})),'pagination':{'page':_0x1d53ea,'limit':_0x223583,'total':_0x2e75a5,'totalPages':Math[_0x29392f(0xee)](_0x2e75a5/_0x223583)}};}async[a52_0xabd2fe(0xfa)](_0x383c10,_0x2d087d){const _0x2d9e57=a52_0xabd2fe,_0x1efc11=await database_1['default'][_0x2d9e57(0xff)][_0x2d9e57(0x88)]({'where':{'id':_0x2d087d,'shopId':_0x383c10}});if(!_0x1efc11)return null;return{'id':_0x1efc11['id'],'amount':_0x1efc11['amount'],'network':_0x1efc11[_0x2d9e57(0xa3)],'status':_0x1efc11[_0x2d9e57(0xc3)],'txid':_0x1efc11['txid'],'notes':_0x1efc11['notes'],'createdAt':_0x1efc11[_0x2d9e57(0xa0)],'paidAt':_0x1efc11[_0x2d9e57(0x11d)]};}async[a52_0xabd2fe(0xca)](_0x3f84ff,_0x5145cc){const _0x2ff086=a52_0xabd2fe,_0x181eef=new Date();let _0x1e284d;switch(_0x5145cc){case'7d':_0x1e284d=new Date(_0x181eef[_0x2ff086(0x92)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x1e284d=new Date(_0x181eef[_0x2ff086(0x92)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x2ff086(0xeb):_0x1e284d=new Date(_0x181eef[_0x2ff086(0x92)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x1e284d=new Date(_0x181eef['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x537815,_0x4f591a,_0x371b9c,_0x45dbd8,_0x2d6418,_0x4c70cb]=await Promise[_0x2ff086(0xef)]([database_1[_0x2ff086(0x111)]['payout'][_0x2ff086(0xea)]({'where':{'shopId':_0x3f84ff,'createdAt':{'gte':_0x1e284d}}}),database_1['default']['payout'][_0x2ff086(0xea)]({'where':{'shopId':_0x3f84ff,'status':'COMPLETED','createdAt':{'gte':_0x1e284d}}}),database_1[_0x2ff086(0x111)][_0x2ff086(0xff)][_0x2ff086(0xea)]({'where':{'shopId':_0x3f84ff,'status':_0x2ff086(0x95),'createdAt':{'gte':_0x1e284d}}}),database_1[_0x2ff086(0x111)][_0x2ff086(0xff)]['count']({'where':{'shopId':_0x3f84ff,'status':_0x2ff086(0xde),'createdAt':{'gte':_0x1e284d}}}),database_1[_0x2ff086(0x111)]['payout']['findMany']({'where':{'shopId':_0x3f84ff,'createdAt':{'gte':_0x1e284d}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x2ff086(0x111)][_0x2ff086(0xff)]['findMany']({'where':{'shopId':_0x3f84ff},'take':0xa,'orderBy':{'createdAt':_0x2ff086(0x120)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x5da679=_0x2d6418['reduce']((_0x46b833,_0x1fe1e7)=>_0x46b833+_0x1fe1e7[_0x2ff086(0xe8)],0x0),_0x410669=_0x2d6418[_0x2ff086(0x9c)](_0x2e2caf=>_0x2e2caf[_0x2ff086(0xc3)]===_0x2ff086(0x87))[_0x2ff086(0x8f)]((_0x25e90a,_0x23264a)=>_0x25e90a+_0x23264a[_0x2ff086(0xe8)],0x0),_0x506ad0=_0x2d6418[_0x2ff086(0x9c)](_0x191140=>_0x191140[_0x2ff086(0xc3)]===_0x2ff086(0x95))[_0x2ff086(0x8f)]((_0x519b01,_0x56bae9)=>_0x519b01+_0x56bae9[_0x2ff086(0xe8)],0x0),_0x10a143=_0x2d6418[_0x2ff086(0x8f)]((_0x46bb9f,_0x1ad81f)=>{const _0x4c3d5a=_0x2ff086;return _0x46bb9f[_0x1ad81f['network']]=(_0x46bb9f[_0x1ad81f[_0x4c3d5a(0xa3)]]||0x0)+0x1,_0x46bb9f;},{}),_0x24af04=_0x2d6418[_0x2ff086(0x8f)]((_0x3b9245,_0x3be791)=>{const _0x1ea78f=_0x2ff086;return _0x3b9245[_0x3be791['status']]=(_0x3b9245[_0x3be791[_0x1ea78f(0xc3)]]||0x0)+0x1,_0x3b9245;},{});return{'totalPayouts':_0x537815,'completedPayouts':_0x4f591a,'pendingPayouts':_0x371b9c,'rejectedPayouts':_0x45dbd8,'totalAmount':_0x5da679,'completedAmount':_0x410669,'pendingAmount':_0x506ad0,'payoutsByMethod':_0x10a143,'payoutsByStatus':_0x24af04,'recentPayouts':_0x4c70cb['map'](_0x3a4779=>({'id':_0x3a4779['id'],'shopId':_0x3f84ff,'amount':_0x3a4779[_0x2ff086(0xe8)],'method':_0x3a4779[_0x2ff086(0xa3)],'status':_0x3a4779[_0x2ff086(0xc3)],'txid':_0x3a4779[_0x2ff086(0xec)],'createdAt':_0x3a4779[_0x2ff086(0xa0)],'paidAt':_0x3a4779[_0x2ff086(0x11d)]}))};}async['getShopPayoutStats'](_0x5c419d){const _0x17a6fc=a52_0xabd2fe;console[_0x17a6fc(0x11b)]('üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x5c419d+'...');const _0x1a441c=await database_1[_0x17a6fc(0x111)]['shop'][_0x17a6fc(0xe1)]({'where':{'id':_0x5c419d},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x1a441c)throw new Error(_0x17a6fc(0x10e));const _0xd5a2d3=new Date(),_0x5b5207=new Date(_0xd5a2d3[_0x17a6fc(0x9b)](),_0xd5a2d3[_0x17a6fc(0xed)](),0x1),_0x47984c=new Date(_0xd5a2d3[_0x17a6fc(0x9b)](),_0xd5a2d3[_0x17a6fc(0xed)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x73728f=await database_1[_0x17a6fc(0x111)][_0x17a6fc(0xff)][_0x17a6fc(0xe0)]({'_sum':{'amount':!![]},'where':{'shopId':_0x5c419d,'createdAt':{'gte':_0x5b5207,'lte':_0x47984c},'status':_0x17a6fc(0x87)}}),_0x11bc04=_0x73728f[_0x17a6fc(0xf3)][_0x17a6fc(0xe8)]||0x0,_0x166813={'availableBalance':Math['round'](_0x1a441c[_0x17a6fc(0x8b)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x1a441c[_0x17a6fc(0xb2)]*0x64)/0x64,'awaitingPayout':Math['round'](_0x1a441c['balance']*0x64)/0x64,'thisMonth':Math[_0x17a6fc(0x11a)](_0x11bc04*0x64)/0x64};return console[_0x17a6fc(0x11b)](_0x17a6fc(0xbe)+_0x1a441c[_0x17a6fc(0x10b)]+_0x17a6fc(0x85)),console[_0x17a6fc(0x11b)](_0x17a6fc(0x8a)+_0x166813[_0x17a6fc(0x8c)]+'\x20USDT\x20(current\x20balance)'),console[_0x17a6fc(0x11b)](_0x17a6fc(0x109)+_0x166813[_0x17a6fc(0xb2)]+_0x17a6fc(0xfc)),console[_0x17a6fc(0x11b)](_0x17a6fc(0xaa)+_0x166813[_0x17a6fc(0xba)]+_0x17a6fc(0xe6)),console['log'](_0x17a6fc(0x10d)+_0x166813[_0x17a6fc(0xc6)]+_0x17a6fc(0xb6)),_0x166813;}['getGatewayDisplayName'](_0x2394fb){const _0x213869=a52_0xabd2fe,_0x2145e6={'test_gateway':_0x213869(0x118),'plisio':_0x213869(0xb3),'rapyd':_0x213869(0x10c),'noda':_0x213869(0x102),'cointopay':_0x213869(0x96),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x213869(0xfe),'klyme_de':_0x213869(0xdf)};return _0x2145e6[_0x2394fb]||_0x2394fb;}async[a52_0xabd2fe(0xa6)](_0x3ca898){const _0x4c7bdf=a52_0xabd2fe;return this[_0x4c7bdf(0xd5)](_0x3ca898);}async[a52_0xabd2fe(0x93)](_0x16ca97,_0x8c95a5){const _0xc65827=a52_0xabd2fe,{page:_0x3130b9,limit:_0x48ffa9,paymentId:_0x52a50d}=_0x8c95a5,_0x46b08d=(_0x3130b9-0x1)*_0x48ffa9,_0x51afca={'shopId':_0x16ca97};_0x52a50d&&(_0x51afca['paymentId']=_0x52a50d);const [_0x5e4026,_0x4314ef]=await Promise[_0xc65827(0xef)]([database_1['default'][_0xc65827(0xa9)][_0xc65827(0xd3)]({'where':_0x51afca,'skip':_0x46b08d,'take':_0x48ffa9,'orderBy':{'createdAt':_0xc65827(0x120)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0xc65827(0x111)][_0xc65827(0xa9)]['count']({'where':_0x51afca})]);return{'logs':_0x5e4026['map'](_0x417e8b=>({'id':_0x417e8b['id'],'paymentId':_0x417e8b[_0xc65827(0xb7)],'shopId':_0x417e8b[_0xc65827(0x9e)],'event':_0x417e8b['event'],'statusCode':_0x417e8b['statusCode'],'retryCount':_0x417e8b[_0xc65827(0x94)],'responseBody':_0x417e8b[_0xc65827(0xce)],'createdAt':_0x417e8b[_0xc65827(0xa0)],'payment':_0x417e8b[_0xc65827(0xb9)]})),'pagination':{'page':_0x3130b9,'limit':_0x48ffa9,'total':_0x4314ef,'totalPages':Math[_0xc65827(0xee)](_0x4314ef/_0x48ffa9)}};}async['getStatistics'](_0x3ac1af,_0x4a8b11){const _0x3ca1b4=a52_0xabd2fe,_0xcb86c3=new Date();let _0x239f02;switch(_0x4a8b11){case'7d':_0x239f02=new Date(_0xcb86c3[_0x3ca1b4(0x92)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x3ca1b4(0x114):_0x239f02=new Date(_0xcb86c3[_0x3ca1b4(0x92)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x3ca1b4(0xeb):_0x239f02=new Date(_0xcb86c3['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x239f02=new Date(_0xcb86c3[_0x3ca1b4(0x92)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x2fc67b,_0x2220da,_0x4f3668,_0x3f878c,_0x4f8105]=await Promise[_0x3ca1b4(0xef)]([database_1[_0x3ca1b4(0x111)][_0x3ca1b4(0xb9)]['count']({'where':{'shopId':_0x3ac1af,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0x239f02}}}),database_1['default'][_0x3ca1b4(0xb9)]['count']({'where':{'shopId':_0x3ac1af,'gateway':{'not':_0x3ca1b4(0xc1)},'status':_0x3ca1b4(0xc2),'createdAt':{'gte':_0x239f02}}}),database_1['default']['payment'][_0x3ca1b4(0xd3)]({'where':{'shopId':_0x3ac1af,'gateway':{'not':_0x3ca1b4(0xc1)},'status':_0x3ca1b4(0xc2),'createdAt':{'gte':_0x239f02}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x3ca1b4(0x111)][_0x3ca1b4(0xb9)][_0x3ca1b4(0xd3)]({'where':{'shopId':_0x3ac1af,'gateway':{'not':_0x3ca1b4(0xc1)}},'take':0xa,'orderBy':{'createdAt':_0x3ca1b4(0x120)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x3ca1b4(0xb9)][_0x3ca1b4(0xd3)]({'where':{'shopId':_0x3ac1af,'gateway':{'not':_0x3ca1b4(0xc1)},'createdAt':{'gte':_0x239f02}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':'asc'}})]);let _0x426dec=0x0;for(const _0x409796 of _0x4f3668){if(_0x409796['amountUSDT'])_0x426dec+=_0x409796[_0x3ca1b4(0xf1)];else{const _0x397de0=await currencyService_1[_0x3ca1b4(0xa2)][_0x3ca1b4(0x101)](_0x409796['amount'],_0x409796[_0x3ca1b4(0xd2)]);_0x426dec+=_0x397de0;}}const _0x307d11=this['generateDailyStatistics'](_0x4f8105,_0x239f02,_0xcb86c3),_0x381321=_0x2fc67b>0x0?_0x2220da/_0x2fc67b*0x64:0x0;return{'totalPayments':_0x2fc67b,'successfulPayments':_0x2220da,'totalRevenue':Math[_0x3ca1b4(0x11a)](_0x426dec*0x64)/0x64,'conversionRate':Math['round'](_0x381321*0x64)/0x64,'dailyRevenue':_0x307d11[_0x3ca1b4(0xcd)],'dailyPayments':_0x307d11[_0x3ca1b4(0x89)],'recentPayments':_0x3f878c[_0x3ca1b4(0x99)](_0x2bbdd0=>({'id':_0x2bbdd0['id'],'gateway':_0x2bbdd0['gateway'],'amount':_0x2bbdd0[_0x3ca1b4(0xe8)],'currency':_0x2bbdd0['currency'],'status':_0x2bbdd0['status'],'createdAt':_0x2bbdd0[_0x3ca1b4(0xa0)]}))};}[a52_0xabd2fe(0xfd)](_0x2a4da3,_0x4775db,_0xec45f5){const _0x2f3970=a52_0xabd2fe,_0x27be21=new Map(),_0x515e98=new Date(_0x4775db);while(_0x515e98<=_0xec45f5){const _0x41cce2=_0x515e98['toISOString']()[_0x2f3970(0xc9)]('T')[0x0];_0x27be21[_0x2f3970(0xf5)](_0x41cce2,{'revenue':0x0,'count':0x0}),_0x515e98[_0x2f3970(0xcf)](_0x515e98['getDate']()+0x1);}for(const _0x3eba6c of _0x2a4da3){const _0x2e523f=_0x3eba6c[_0x2f3970(0xa0)][_0x2f3970(0x113)]()[_0x2f3970(0xc9)]('T')[0x0],_0x5eac9f=_0x27be21['get'](_0x2e523f);_0x5eac9f&&(_0x5eac9f[_0x2f3970(0xea)]+=0x1,_0x3eba6c[_0x2f3970(0xc3)]==='PAID'&&_0x3eba6c[_0x2f3970(0xf1)]&&(_0x5eac9f[_0x2f3970(0x90)]+=_0x3eba6c['amountUSDT']));}const _0x3ebd04=[],_0x4b54b5=[];for(const [_0x5dc7ed,_0x1c8aec]of _0x27be21){_0x3ebd04[_0x2f3970(0xdb)]({'date':_0x5dc7ed,'amount':Math[_0x2f3970(0x11a)](_0x1c8aec[_0x2f3970(0x90)]*0x64)/0x64}),_0x4b54b5[_0x2f3970(0xdb)]({'date':_0x5dc7ed,'count':_0x1c8aec[_0x2f3970(0xea)]});}return{'dailyRevenue':_0x3ebd04,'dailyPayments':_0x4b54b5};}}exports[a52_0xabd2fe(0x115)]=ShopService;