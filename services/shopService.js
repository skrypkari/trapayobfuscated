'use strict';const a56_0x594e0f=a56_0x3556;(function(_0x3580f3,_0x32aa62){const _0x2ac66d=a56_0x3556,_0x22123c=_0x3580f3();while(!![]){try{const _0x490cee=parseInt(_0x2ac66d(0x7e))/0x1+parseInt(_0x2ac66d(0xb2))/0x2*(-parseInt(_0x2ac66d(0xda))/0x3)+-parseInt(_0x2ac66d(0x115))/0x4*(parseInt(_0x2ac66d(0xe0))/0x5)+-parseInt(_0x2ac66d(0x70))/0x6+parseInt(_0x2ac66d(0x7a))/0x7+-parseInt(_0x2ac66d(0x8b))/0x8+parseInt(_0x2ac66d(0x116))/0x9*(parseInt(_0x2ac66d(0x101))/0xa);if(_0x490cee===_0x32aa62)break;else _0x22123c['push'](_0x22123c['shift']());}catch(_0x36f529){_0x22123c['push'](_0x22123c['shift']());}}}(a56_0xeedb,0x9f345));var __importDefault=this&&this[a56_0x594e0f(0xbe)]||function(_0x1ee7d7){const _0x4df725=a56_0x594e0f;return _0x1ee7d7&&_0x1ee7d7[_0x4df725(0xa5)]?_0x1ee7d7:{'default':_0x1ee7d7};};Object[a56_0x594e0f(0x7b)](exports,a56_0x594e0f(0xa5),{'value':!![]}),exports[a56_0x594e0f(0xe6)]=void 0x0;const database_1=__importDefault(require(a56_0x594e0f(0x119))),currencyService_1=require('./currencyService'),paymentService_1=require(a56_0x594e0f(0x83));function a56_0x3556(_0x42aede,_0x19c65c){const _0xeedbe3=a56_0xeedb();return a56_0x3556=function(_0x35561d,_0x2c6d76){_0x35561d=_0x35561d-0x68;let _0x5150bd=_0xeedbe3[_0x35561d];return _0x5150bd;},a56_0x3556(_0x42aede,_0x19c65c);}function a56_0xeedb(){const _0x5773d3=['setDate','usdtTrcWallet','5zSQoTG','updateShopProfile','country','paymentGateways','customerEmail','generateDailyStatistics','ShopService','polygon','usage','Shop\x20not\x20found','üåê\x20Network\x20filter:\x20','Failed\x20to\x20send\x20webhook:\x20','getShopProfile','customer','paymentId','paymentService','setHours','count','balance','Noda','formatNetworkName','getFullYear','language','amountIsEditable','update','error','gte','USDC\x20Polygon','createPayment','event','üìÖ\x20Date\x20start:\x20','erc20','sourceCurrency','370PvjBqi','getPayoutStatistics','thisMonth','getTime','CoinToPay','paid','getGatewayDisplayName','publicKey','filter','30d','reduce','findMany','ceil','round','getMonth','periodFrom','network','amountUSDT','customerName','getPaymentByShopAndId','657656dSBSDW','535779IfBjAS','statusText','üìÖ\x20Period\x20start:\x20','../config/database','push','payout','\x20payout\x20statistics\x20calculated:','gatewaySettings','PAID','COMPLETED','USDT\x20TRC20','log','shopUrl','122988XOzhdA','findFirst','isArray','periodTo','POST','revenue','USDT\x20BSC','getPayoutById','test','trc20','563591vOvwvz','defineProperty','shopId','currency','710498HJzsEu','notes','default','Unknown\x20error','Payment\x20not\x20found','./paymentService','webhookLog','createPublicPayment','dailyPayments','availableBalance','usdtPolygonWallet','findUnique','desc','7529472QRdEtL','username','toUpperCase','parse','expiresAt','currencyService','amount','txid','üìä\x20Status\x20filter:\x20','getPayoutStats','üìä\x20Final\x20WHERE\x20conditions:','PaymentService','\x20\x20\x20üíµ\x20Available\x20balance:\x20','get','telegram','deletePayment','Test\x20Gateway','usdtErcWallet','wallets','status','merchantUrl','90d','getPayouts','getPaymentById','gateway','Error\x20parsing\x20webhook\x20events:','__esModule','\x20\x20\x20üí∞\x20Total\x20paid\x20out:\x20','...','No\x20webhook\x20URL\x20configured','message','all','PENDING','\x20\x20\x20üìÖ\x20This\x20month:\x20','testWebhook','webhookUrl','convertToUSDT','toISOString','Plisio','2smlZdb','\x20USDT\x20(current\x20balance)','stringify','createdAt','REJECTED','gateways','webhookEvents','name','responseBody','test_payment_123','retryCount','payment','__importDefault','\x20USDT\x20(total\x20payouts)','USD','map','updatePayment','dailyRevenue','awaitingPayout','totalPaidOut','_sum','polygon_usdc','telegramId','application/json','getShopPayoutStats','getWebhookLogs','settings','üí∞\x20Getting\x20payouts\x20with\x20filters:','redirectUrl','Rapyd','lte','\x20USDT','split','üìä\x20Shop\x20','KLYME\x20DE','statusCode','fullName','test_gateway','paidAt','shop','3646383FpxaQi','usdcPolygonWallet','KLYME\x20GB','asc'];a56_0xeedb=function(){return _0x5773d3;};return a56_0xeedb();}class ShopService{constructor(){const _0x4e268d=a56_0x594e0f;this['paymentService']=new paymentService_1[(_0x4e268d(0x96))]();}async[a56_0x594e0f(0xec)](_0x2db5b2){const _0x23a30b=a56_0x594e0f,_0x484289=await database_1[_0x23a30b(0x80)]['shop'][_0x23a30b(0x89)]({'where':{'id':_0x2db5b2},'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});if(!_0x484289)throw new Error(_0x23a30b(0xe9));let _0x49c05e=[];if(_0x484289[_0x23a30b(0xcc)]?.[_0x23a30b(0xb8)])try{_0x49c05e=Array[_0x23a30b(0x72)](_0x484289[_0x23a30b(0xcc)][_0x23a30b(0xb8)])?_0x484289['settings']['webhookEvents']:JSON[_0x23a30b(0x8e)](_0x484289['settings'][_0x23a30b(0xb8)]);}catch(_0x321bef){console[_0x23a30b(0xf9)](_0x23a30b(0xa4),_0x321bef),_0x49c05e=[];}return{'id':_0x484289['id'],'fullName':_0x484289['name'],'username':_0x484289[_0x23a30b(0x8c)],'telegramId':_0x484289[_0x23a30b(0x99)],'merchantUrl':_0x484289[_0x23a30b(0x6f)],'gateways':_0x484289[_0x23a30b(0xe3)]?JSON[_0x23a30b(0x8e)](_0x484289[_0x23a30b(0xe3)]):null,'gatewaySettings':_0x484289[_0x23a30b(0x6a)]?JSON[_0x23a30b(0x8e)](_0x484289['gatewaySettings']):null,'publicKey':_0x484289[_0x23a30b(0x108)],'webhookUrl':_0x484289['settings']?.[_0x23a30b(0xae)]||null,'webhookEvents':_0x49c05e,'wallets':{'usdtPolygonWallet':_0x484289[_0x23a30b(0x88)],'usdtTrcWallet':_0x484289[_0x23a30b(0xdf)],'usdtErcWallet':_0x484289[_0x23a30b(0x9c)],'usdcPolygonWallet':_0x484289[_0x23a30b(0xdb)]},'status':_0x484289['status'],'createdAt':_0x484289[_0x23a30b(0xb5)]};}async[a56_0x594e0f(0xe1)](_0x1b47a3,_0x4f9b85){const _0x3f0618=a56_0x594e0f,_0x517998={};_0x4f9b85[_0x3f0618(0xd6)]&&(_0x517998['name']=_0x4f9b85['fullName']);_0x4f9b85[_0x3f0618(0xc8)]!==undefined&&(_0x517998['telegram']=_0x4f9b85[_0x3f0618(0xc8)]||null);_0x4f9b85['merchantUrl']&&(_0x517998[_0x3f0618(0x6f)]=_0x4f9b85[_0x3f0618(0x9f)]);_0x4f9b85[_0x3f0618(0xb7)]&&(_0x517998['paymentGateways']=JSON[_0x3f0618(0xb4)](_0x4f9b85[_0x3f0618(0xb7)]));_0x4f9b85['gatewaySettings']&&(_0x517998[_0x3f0618(0x6a)]=JSON['stringify'](_0x4f9b85[_0x3f0618(0x6a)]));_0x4f9b85[_0x3f0618(0x9d)]&&(_0x4f9b85['wallets'][_0x3f0618(0x88)]!==undefined&&(_0x517998['usdtPolygonWallet']=_0x4f9b85['wallets'][_0x3f0618(0x88)]||null),_0x4f9b85[_0x3f0618(0x9d)][_0x3f0618(0xdf)]!==undefined&&(_0x517998[_0x3f0618(0xdf)]=_0x4f9b85['wallets'][_0x3f0618(0xdf)]||null),_0x4f9b85['wallets']['usdtErcWallet']!==undefined&&(_0x517998[_0x3f0618(0x9c)]=_0x4f9b85[_0x3f0618(0x9d)]['usdtErcWallet']||null),_0x4f9b85[_0x3f0618(0x9d)][_0x3f0618(0xdb)]!==undefined&&(_0x517998['usdcPolygonWallet']=_0x4f9b85['wallets'][_0x3f0618(0xdb)]||null));const _0x38a907=await database_1[_0x3f0618(0x80)]['shop'][_0x3f0618(0xf8)]({'where':{'id':_0x1b47a3},'data':_0x517998,'select':{'id':!![],'name':!![],'username':!![],'telegram':!![],'shopUrl':!![],'paymentGateways':!![],'gatewaySettings':!![],'publicKey':!![],'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![],'status':!![],'createdAt':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}});let _0x1e9c3d=[];if(_0x38a907[_0x3f0618(0xcc)]?.[_0x3f0618(0xb8)])try{_0x1e9c3d=Array[_0x3f0618(0x72)](_0x38a907['settings'][_0x3f0618(0xb8)])?_0x38a907[_0x3f0618(0xcc)]['webhookEvents']:JSON['parse'](_0x38a907[_0x3f0618(0xcc)][_0x3f0618(0xb8)]);}catch(_0xf976c8){console['error']('Error\x20parsing\x20webhook\x20events:',_0xf976c8),_0x1e9c3d=[];}return{'id':_0x38a907['id'],'fullName':_0x38a907[_0x3f0618(0xb9)],'username':_0x38a907[_0x3f0618(0x8c)],'telegramId':_0x38a907[_0x3f0618(0x99)],'merchantUrl':_0x38a907['shopUrl'],'gateways':_0x38a907['paymentGateways']?JSON[_0x3f0618(0x8e)](_0x38a907[_0x3f0618(0xe3)]):null,'gatewaySettings':_0x38a907[_0x3f0618(0x6a)]?JSON[_0x3f0618(0x8e)](_0x38a907[_0x3f0618(0x6a)]):null,'publicKey':_0x38a907[_0x3f0618(0x108)],'webhookUrl':_0x38a907[_0x3f0618(0xcc)]?.[_0x3f0618(0xae)]||null,'webhookEvents':_0x1e9c3d,'wallets':{'usdtPolygonWallet':_0x38a907[_0x3f0618(0x88)],'usdtTrcWallet':_0x38a907['usdtTrcWallet'],'usdtErcWallet':_0x38a907[_0x3f0618(0x9c)],'usdcPolygonWallet':_0x38a907[_0x3f0618(0xdb)]},'status':_0x38a907[_0x3f0618(0x9e)],'createdAt':_0x38a907['createdAt']};}async['updateWallets'](_0x124e4c,_0x493642){const _0x1be060=a56_0x594e0f,_0x331ce3={};_0x493642['usdtPolygonWallet']!==undefined&&(_0x331ce3[_0x1be060(0x88)]=_0x493642['usdtPolygonWallet']||null),_0x493642[_0x1be060(0xdf)]!==undefined&&(_0x331ce3[_0x1be060(0xdf)]=_0x493642[_0x1be060(0xdf)]||null),_0x493642[_0x1be060(0x9c)]!==undefined&&(_0x331ce3[_0x1be060(0x9c)]=_0x493642[_0x1be060(0x9c)]||null),_0x493642[_0x1be060(0xdb)]!==undefined&&(_0x331ce3['usdcPolygonWallet']=_0x493642[_0x1be060(0xdb)]||null),await database_1[_0x1be060(0x80)][_0x1be060(0xd9)][_0x1be060(0xf8)]({'where':{'id':_0x124e4c},'data':_0x331ce3});}async[a56_0x594e0f(0xad)](_0x2ea757){const _0x19b2fe=a56_0x594e0f,_0x3dcf20=await database_1[_0x19b2fe(0x80)]['shop'][_0x19b2fe(0x89)]({'where':{'id':_0x2ea757},'include':{'settings':{'select':{'webhookUrl':!![]}}}});if(!_0x3dcf20?.[_0x19b2fe(0xcc)]?.['webhookUrl'])throw new Error(_0x19b2fe(0xa8));const _0x45e50b={'event':_0x19b2fe(0x78),'payment':{'id':_0x19b2fe(0xbb),'order_id':'test_order_123','gateway':_0x19b2fe(0x78),'amount':0x64,'currency':_0x19b2fe(0xc0),'status':_0x19b2fe(0x106),'created_at':new Date()['toISOString']()}};try{const _0x21b4cb=await fetch(_0x3dcf20[_0x19b2fe(0xcc)][_0x19b2fe(0xae)],{'method':_0x19b2fe(0x74),'headers':{'Content-Type':_0x19b2fe(0xc9),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test)'},'body':JSON[_0x19b2fe(0xb4)](_0x45e50b)});return _0x21b4cb['ok']?{'success':!![],'message':'Test\x20webhook\x20sent\x20successfully\x20('+_0x21b4cb[_0x19b2fe(0x9e)]+')'}:{'success':![],'message':'Webhook\x20returned\x20error:\x20'+_0x21b4cb[_0x19b2fe(0x9e)]+'\x20'+_0x21b4cb[_0x19b2fe(0x117)]};}catch(_0x3a67be){return{'success':![],'message':_0x19b2fe(0xeb)+(_0x3a67be instanceof Error?_0x3a67be[_0x19b2fe(0xa9)]:_0x19b2fe(0x81))};}}async[a56_0x594e0f(0xfc)](_0x55696d){const _0xe2a186=a56_0x594e0f;return this[_0xe2a186(0xef)][_0xe2a186(0x85)]({'public_key':'','gateway':_0x55696d[_0xe2a186(0xa3)],'order_id':undefined,'amount':_0x55696d[_0xe2a186(0x91)],'currency':_0x55696d[_0xe2a186(0x7d)],'source_currency':_0x55696d[_0xe2a186(0x100)],'usage':_0x55696d[_0xe2a186(0xe8)],'expires_at':_0x55696d[_0xe2a186(0x8f)]?.[_0xe2a186(0xb0)](),'success_url':_0x55696d[_0xe2a186(0xce)],'fail_url':_0x55696d[_0xe2a186(0xce)],'customer_email':_0x55696d[_0xe2a186(0xe4)],'customer_name':_0x55696d[_0xe2a186(0x113)],'country':_0x55696d[_0xe2a186(0xe2)],'language':_0x55696d[_0xe2a186(0xf6)],'amount_is_editable':_0x55696d[_0xe2a186(0xf7)],'max_payments':_0x55696d['maxPayments'],'customer':_0x55696d[_0xe2a186(0xed)]});}async['getPayments'](_0x1d62b7,_0x12fd70){return this['paymentService']['getPaymentsByShop'](_0x1d62b7,_0x12fd70);}async[a56_0x594e0f(0xa2)](_0xae6aee,_0x334611){const _0x375baa=a56_0x594e0f;return this[_0x375baa(0xef)][_0x375baa(0x114)](_0xae6aee,_0x334611);}async[a56_0x594e0f(0xc2)](_0x16c39c,_0x1524f3,_0x4ad459){const _0x570417=a56_0x594e0f,_0x1282f4=await database_1[_0x570417(0x80)]['payment'][_0x570417(0x71)]({'where':{'id':_0x1524f3,'shopId':_0x16c39c}});if(!_0x1282f4)throw new Error(_0x570417(0x82));const _0x257854=await database_1[_0x570417(0x80)][_0x570417(0xbd)][_0x570417(0xf8)]({'where':{'id':_0x1524f3},'data':{..._0x4ad459,'updatedAt':new Date()}});return _0x257854;}async[a56_0x594e0f(0x9a)](_0x245fca,_0xa236a5){const _0x110c23=a56_0x594e0f,_0x4a0e3a=await database_1[_0x110c23(0x80)][_0x110c23(0xbd)][_0x110c23(0x71)]({'where':{'id':_0xa236a5,'shopId':_0x245fca}});if(!_0x4a0e3a)throw new Error('Payment\x20not\x20found');await database_1[_0x110c23(0x80)][_0x110c23(0xbd)]['delete']({'where':{'id':_0xa236a5}});}['formatNetworkName'](_0x563103){const _0x4dff1e=a56_0x594e0f,_0x48d21e={'polygon':'USDT\x20Polygon','trc20':_0x4dff1e(0x6d),'erc20':'USDT\x20ERC20','bsc':_0x4dff1e(0x76),'polygon_usdc':_0x4dff1e(0xfb)};return _0x48d21e[_0x563103]||_0x563103;}async[a56_0x594e0f(0xa1)](_0x42113c,_0x292bb0){const _0x246965=a56_0x594e0f,{page:_0x4380c9,limit:_0x57f66b,status:_0x590391,method:_0x3f6f71,network:_0x3959f7,dateFrom:_0x588775,dateTo:_0x336290,periodFrom:_0x326881,periodTo:_0x128667}=_0x292bb0,_0x43bf2b=(_0x4380c9-0x1)*_0x57f66b;console[_0x246965(0x6e)](_0x246965(0xcd),_0x292bb0);const _0x34a782={'shopId':_0x42113c};_0x590391&&(_0x34a782[_0x246965(0x9e)]=_0x590391['toUpperCase'](),console[_0x246965(0x6e)](_0x246965(0x93)+_0x590391[_0x246965(0x8d)]()));if(_0x3f6f71)_0x34a782['network']=_0x3f6f71,console[_0x246965(0x6e)]('üåê\x20Method\x20filter:\x20'+_0x3f6f71);else _0x3959f7&&(_0x34a782[_0x246965(0x111)]=_0x3959f7,console[_0x246965(0x6e)](_0x246965(0xea)+_0x3959f7));if(_0x588775||_0x336290||_0x326881||_0x128667){_0x34a782[_0x246965(0xb5)]={};if(_0x326881){const _0x1c3ad5=new Date(_0x326881);_0x1c3ad5['setHours'](0x0,0x0,0x0,0x0),_0x34a782[_0x246965(0xb5)][_0x246965(0xfa)]=_0x1c3ad5,console[_0x246965(0x6e)](_0x246965(0x118)+_0x1c3ad5['toISOString']());}else{if(_0x588775){const _0x2ab255=new Date(_0x588775);_0x2ab255[_0x246965(0xf0)](0x0,0x0,0x0,0x0),_0x34a782[_0x246965(0xb5)][_0x246965(0xfa)]=_0x2ab255,console['log'](_0x246965(0xfe)+_0x2ab255[_0x246965(0xb0)]());}}if(_0x128667){const _0x4c3d80=new Date(_0x128667);_0x4c3d80[_0x246965(0xf0)](0x17,0x3b,0x3b,0x3e7),_0x34a782[_0x246965(0xb5)][_0x246965(0xd0)]=_0x4c3d80,console['log']('üìÖ\x20Period\x20end:\x20'+_0x4c3d80[_0x246965(0xb0)]());}else{if(_0x336290){const _0x4960a1=new Date(_0x336290);_0x4960a1[_0x246965(0xf0)](0x17,0x3b,0x3b,0x3e7),_0x34a782[_0x246965(0xb5)][_0x246965(0xd0)]=_0x4960a1,console[_0x246965(0x6e)]('üìÖ\x20Date\x20end:\x20'+_0x4960a1[_0x246965(0xb0)]());}}}console[_0x246965(0x6e)](_0x246965(0x95),JSON['stringify'](_0x34a782,null,0x2));const [_0x359505,_0xce7fe9]=await Promise[_0x246965(0xaa)]([database_1[_0x246965(0x80)][_0x246965(0x68)]['findMany']({'where':_0x34a782,'skip':_0x43bf2b,'take':_0x57f66b,'orderBy':{'createdAt':'desc'},'include':{'shop':{'select':{'usdtPolygonWallet':!![],'usdtTrcWallet':!![],'usdtErcWallet':!![],'usdcPolygonWallet':!![]}}}}),database_1[_0x246965(0x80)]['payout'][_0x246965(0xf1)]({'where':_0x34a782})]);return{'payouts':_0x359505[_0x246965(0xc1)](_0x55c2c1=>{const _0x1f3506=_0x246965;let _0x1bf396=null;switch(_0x55c2c1[_0x1f3506(0x111)]){case _0x1f3506(0xe7):_0x1bf396=_0x55c2c1['shop'][_0x1f3506(0x88)];break;case _0x1f3506(0x79):_0x1bf396=_0x55c2c1[_0x1f3506(0xd9)]['usdtTrcWallet'];break;case _0x1f3506(0xff):_0x1bf396=_0x55c2c1[_0x1f3506(0xd9)]['usdtErcWallet'];break;case _0x1f3506(0xc7):_0x1bf396=_0x55c2c1[_0x1f3506(0xd9)]['usdcPolygonWallet'];break;}return{'id':_0x55c2c1['id'],'amount':_0x55c2c1['amount'],'network':this[_0x1f3506(0xf4)](_0x55c2c1['network']),'wallet':_0x1bf396,'status':_0x55c2c1['status'],'txid':_0x55c2c1[_0x1f3506(0x92)],'notes':_0x55c2c1['notes'],'periodFrom':_0x55c2c1[_0x1f3506(0x110)],'periodTo':_0x55c2c1[_0x1f3506(0x73)],'createdAt':_0x55c2c1['createdAt'],'paidAt':_0x55c2c1[_0x1f3506(0xd8)]};}),'pagination':{'page':_0x4380c9,'limit':_0x57f66b,'total':_0xce7fe9,'totalPages':Math[_0x246965(0x10d)](_0xce7fe9/_0x57f66b)}};}async[a56_0x594e0f(0x77)](_0x319d65,_0x13f64e){const _0x5c7df3=a56_0x594e0f,_0x276301=await database_1[_0x5c7df3(0x80)]['payout'][_0x5c7df3(0x71)]({'where':{'id':_0x13f64e,'shopId':_0x319d65}});if(!_0x276301)return null;return{'id':_0x276301['id'],'amount':_0x276301['amount'],'network':_0x276301[_0x5c7df3(0x111)],'status':_0x276301[_0x5c7df3(0x9e)],'txid':_0x276301[_0x5c7df3(0x92)],'notes':_0x276301[_0x5c7df3(0x7f)],'createdAt':_0x276301[_0x5c7df3(0xb5)],'paidAt':_0x276301[_0x5c7df3(0xd8)]};}async[a56_0x594e0f(0x102)](_0x36b498,_0xef811a){const _0x43a953=a56_0x594e0f,_0x214adb=new Date();let _0x512a87;switch(_0xef811a){case'7d':_0x512a87=new Date(_0x214adb[_0x43a953(0x104)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case'30d':_0x512a87=new Date(_0x214adb[_0x43a953(0x104)]()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x43a953(0xa0):_0x512a87=new Date(_0x214adb[_0x43a953(0x104)]()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0x512a87=new Date(_0x214adb[_0x43a953(0x104)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x48fee4,_0x18a37b,_0x2e38db,_0x1c8250,_0x869c98,_0xcd5a1b]=await Promise[_0x43a953(0xaa)]([database_1[_0x43a953(0x80)][_0x43a953(0x68)][_0x43a953(0xf1)]({'where':{'shopId':_0x36b498,'createdAt':{'gte':_0x512a87}}}),database_1[_0x43a953(0x80)][_0x43a953(0x68)][_0x43a953(0xf1)]({'where':{'shopId':_0x36b498,'status':_0x43a953(0x6c),'createdAt':{'gte':_0x512a87}}}),database_1[_0x43a953(0x80)][_0x43a953(0x68)][_0x43a953(0xf1)]({'where':{'shopId':_0x36b498,'status':_0x43a953(0xab),'createdAt':{'gte':_0x512a87}}}),database_1['default'][_0x43a953(0x68)][_0x43a953(0xf1)]({'where':{'shopId':_0x36b498,'status':_0x43a953(0xb6),'createdAt':{'gte':_0x512a87}}}),database_1[_0x43a953(0x80)][_0x43a953(0x68)][_0x43a953(0x10c)]({'where':{'shopId':_0x36b498,'createdAt':{'gte':_0x512a87}},'select':{'amount':!![],'status':!![],'network':!![]}}),database_1[_0x43a953(0x80)][_0x43a953(0x68)][_0x43a953(0x10c)]({'where':{'shopId':_0x36b498},'take':0xa,'orderBy':{'createdAt':_0x43a953(0x8a)},'select':{'id':!![],'amount':!![],'network':!![],'status':!![],'txid':!![],'createdAt':!![],'paidAt':!![]}})]),_0x1d0cf8=_0x869c98['reduce']((_0x493295,_0x1fc930)=>_0x493295+_0x1fc930[_0x43a953(0x91)],0x0),_0x5b7bf8=_0x869c98[_0x43a953(0x109)](_0xeb42b4=>_0xeb42b4[_0x43a953(0x9e)]===_0x43a953(0x6c))['reduce']((_0x54f731,_0x3beac8)=>_0x54f731+_0x3beac8[_0x43a953(0x91)],0x0),_0x47f84f=_0x869c98[_0x43a953(0x109)](_0x206822=>_0x206822[_0x43a953(0x9e)]==='PENDING')[_0x43a953(0x10b)]((_0x1b1886,_0x1feaed)=>_0x1b1886+_0x1feaed[_0x43a953(0x91)],0x0),_0x5233ce=_0x869c98[_0x43a953(0x10b)]((_0xcda183,_0x440080)=>{const _0x451db2=_0x43a953;return _0xcda183[_0x440080[_0x451db2(0x111)]]=(_0xcda183[_0x440080[_0x451db2(0x111)]]||0x0)+0x1,_0xcda183;},{}),_0x4e4515=_0x869c98['reduce']((_0x46eb16,_0x4d1c1e)=>{return _0x46eb16[_0x4d1c1e['status']]=(_0x46eb16[_0x4d1c1e['status']]||0x0)+0x1,_0x46eb16;},{});return{'totalPayouts':_0x48fee4,'completedPayouts':_0x18a37b,'pendingPayouts':_0x2e38db,'rejectedPayouts':_0x1c8250,'totalAmount':_0x1d0cf8,'completedAmount':_0x5b7bf8,'pendingAmount':_0x47f84f,'payoutsByMethod':_0x5233ce,'payoutsByStatus':_0x4e4515,'recentPayouts':_0xcd5a1b[_0x43a953(0xc1)](_0x45cdde=>({'id':_0x45cdde['id'],'shopId':_0x36b498,'amount':_0x45cdde[_0x43a953(0x91)],'method':_0x45cdde[_0x43a953(0x111)],'status':_0x45cdde[_0x43a953(0x9e)],'txid':_0x45cdde['txid'],'createdAt':_0x45cdde[_0x43a953(0xb5)],'paidAt':_0x45cdde[_0x43a953(0xd8)]}))};}async[a56_0x594e0f(0xca)](_0x533514){const _0x46b079=a56_0x594e0f;console['log']('üìä\x20Calculating\x20shop\x20payout\x20stats\x20for\x20shop\x20'+_0x533514+_0x46b079(0xa7));const _0x2d93f4=await database_1['default'][_0x46b079(0xd9)][_0x46b079(0x89)]({'where':{'id':_0x533514},'select':{'id':!![],'name':!![],'username':!![],'balance':!![],'totalPaidOut':!![]}});if(!_0x2d93f4)throw new Error(_0x46b079(0xe9));const _0x4a9d03=new Date(),_0x3e0d06=new Date(_0x4a9d03['getFullYear'](),_0x4a9d03[_0x46b079(0x10f)](),0x1),_0x9f7f75=new Date(_0x4a9d03[_0x46b079(0xf5)](),_0x4a9d03[_0x46b079(0x10f)]()+0x1,0x0,0x17,0x3b,0x3b,0x3e7),_0x4d500a=await database_1[_0x46b079(0x80)][_0x46b079(0x68)]['aggregate']({'_sum':{'amount':!![]},'where':{'shopId':_0x533514,'createdAt':{'gte':_0x3e0d06,'lte':_0x9f7f75},'status':_0x46b079(0x6c)}}),_0x57beec=_0x4d500a[_0x46b079(0xc6)][_0x46b079(0x91)]||0x0,_0x1717f5={'availableBalance':Math['round'](_0x2d93f4[_0x46b079(0xf2)]*0x64)/0x64,'totalPaidOut':Math['round'](_0x2d93f4[_0x46b079(0xc5)]*0x64)/0x64,'awaitingPayout':Math[_0x46b079(0x10e)](_0x2d93f4[_0x46b079(0xf2)]*0x64)/0x64,'thisMonth':Math[_0x46b079(0x10e)](_0x57beec*0x64)/0x64};return console[_0x46b079(0x6e)](_0x46b079(0xd3)+_0x2d93f4[_0x46b079(0x8c)]+_0x46b079(0x69)),console[_0x46b079(0x6e)](_0x46b079(0x97)+_0x1717f5[_0x46b079(0x87)]+'\x20USDT\x20(current\x20balance)'),console[_0x46b079(0x6e)](_0x46b079(0xa6)+_0x1717f5['totalPaidOut']+_0x46b079(0xbf)),console[_0x46b079(0x6e)]('\x20\x20\x20‚è≥\x20Awaiting\x20payout:\x20'+_0x1717f5[_0x46b079(0xc4)]+_0x46b079(0xb3)),console[_0x46b079(0x6e)](_0x46b079(0xac)+_0x1717f5[_0x46b079(0x103)]+_0x46b079(0xd1)),_0x1717f5;}[a56_0x594e0f(0x107)](_0x4230d8){const _0x5c8db0=a56_0x594e0f,_0x2794f3={'test_gateway':_0x5c8db0(0x9b),'plisio':_0x5c8db0(0xb1),'rapyd':_0x5c8db0(0xcf),'noda':_0x5c8db0(0xf3),'cointopay':_0x5c8db0(0x105),'klyme_eu':'KLYME\x20EU','klyme_gb':_0x5c8db0(0xdc),'klyme_de':_0x5c8db0(0xd4)};return _0x2794f3[_0x4230d8]||_0x4230d8;}async[a56_0x594e0f(0x94)](_0x23a813){const _0xaeaeb1=a56_0x594e0f;return this[_0xaeaeb1(0xca)](_0x23a813);}async[a56_0x594e0f(0xcb)](_0x283024,_0x408fa9){const _0x3b9663=a56_0x594e0f,{page:_0x4e8733,limit:_0x1bb710,paymentId:_0x10cbe3}=_0x408fa9,_0x24097d=(_0x4e8733-0x1)*_0x1bb710,_0x5144cd={'shopId':_0x283024};_0x10cbe3&&(_0x5144cd[_0x3b9663(0xee)]=_0x10cbe3);const [_0x29b8bb,_0x5c79ef]=await Promise['all']([database_1[_0x3b9663(0x80)][_0x3b9663(0x84)][_0x3b9663(0x10c)]({'where':_0x5144cd,'skip':_0x24097d,'take':_0x1bb710,'orderBy':{'createdAt':_0x3b9663(0x8a)},'include':{'payment':{'select':{'id':!![],'amount':!![],'currency':!![]}}}}),database_1[_0x3b9663(0x80)]['webhookLog'][_0x3b9663(0xf1)]({'where':_0x5144cd})]);return{'logs':_0x29b8bb[_0x3b9663(0xc1)](_0x582ecb=>({'id':_0x582ecb['id'],'paymentId':_0x582ecb[_0x3b9663(0xee)],'shopId':_0x582ecb[_0x3b9663(0x7c)],'event':_0x582ecb[_0x3b9663(0xfd)],'statusCode':_0x582ecb[_0x3b9663(0xd5)],'retryCount':_0x582ecb[_0x3b9663(0xbc)],'responseBody':_0x582ecb[_0x3b9663(0xba)],'createdAt':_0x582ecb['createdAt'],'payment':_0x582ecb[_0x3b9663(0xbd)]})),'pagination':{'page':_0x4e8733,'limit':_0x1bb710,'total':_0x5c79ef,'totalPages':Math[_0x3b9663(0x10d)](_0x5c79ef/_0x1bb710)}};}async['getStatistics'](_0x1140b8,_0x333e09){const _0x188201=a56_0x594e0f,_0xd46355=new Date();let _0xe9ffd4;switch(_0x333e09){case'7d':_0xe9ffd4=new Date(_0xd46355[_0x188201(0x104)]()-0x7*0x18*0x3c*0x3c*0x3e8);break;case _0x188201(0x10a):_0xe9ffd4=new Date(_0xd46355['getTime']()-0x1e*0x18*0x3c*0x3c*0x3e8);break;case _0x188201(0xa0):_0xe9ffd4=new Date(_0xd46355['getTime']()-0x5a*0x18*0x3c*0x3c*0x3e8);break;default:_0xe9ffd4=new Date(_0xd46355[_0x188201(0x104)]()-0x1e*0x18*0x3c*0x3c*0x3e8);}const [_0x57b28a,_0x59297a,_0x43ff89,_0x25af8f,_0x329146]=await Promise[_0x188201(0xaa)]([database_1[_0x188201(0x80)][_0x188201(0xbd)]['count']({'where':{'shopId':_0x1140b8,'gateway':{'not':_0x188201(0xd7)},'createdAt':{'gte':_0xe9ffd4}}}),database_1[_0x188201(0x80)][_0x188201(0xbd)][_0x188201(0xf1)]({'where':{'shopId':_0x1140b8,'gateway':{'not':_0x188201(0xd7)},'status':'PAID','createdAt':{'gte':_0xe9ffd4}}}),database_1[_0x188201(0x80)][_0x188201(0xbd)][_0x188201(0x10c)]({'where':{'shopId':_0x1140b8,'gateway':{'not':_0x188201(0xd7)},'status':'PAID','createdAt':{'gte':_0xe9ffd4}},'select':{'amount':!![],'currency':!![],'amountUSDT':!![],'createdAt':!![]}}),database_1[_0x188201(0x80)][_0x188201(0xbd)]['findMany']({'where':{'shopId':_0x1140b8,'gateway':{'not':_0x188201(0xd7)}},'take':0xa,'orderBy':{'createdAt':_0x188201(0x8a)},'select':{'id':!![],'gateway':!![],'amount':!![],'currency':!![],'status':!![],'createdAt':!![]}}),database_1['default'][_0x188201(0xbd)][_0x188201(0x10c)]({'where':{'shopId':_0x1140b8,'gateway':{'not':'test_gateway'},'createdAt':{'gte':_0xe9ffd4}},'select':{'status':!![],'amountUSDT':!![],'createdAt':!![]},'orderBy':{'createdAt':_0x188201(0xdd)}})]);let _0x19b530=0x0;for(const _0x59585d of _0x43ff89){if(_0x59585d[_0x188201(0x112)])_0x19b530+=_0x59585d['amountUSDT'];else{const _0x3b43f5=await currencyService_1[_0x188201(0x90)][_0x188201(0xaf)](_0x59585d[_0x188201(0x91)],_0x59585d[_0x188201(0x7d)]);_0x19b530+=_0x3b43f5;}}const _0x583b2e=this[_0x188201(0xe5)](_0x329146,_0xe9ffd4,_0xd46355),_0x648252=_0x57b28a>0x0?_0x59297a/_0x57b28a*0x64:0x0;return{'totalPayments':_0x57b28a,'successfulPayments':_0x59297a,'totalRevenue':Math[_0x188201(0x10e)](_0x19b530*0x64)/0x64,'conversionRate':Math['round'](_0x648252*0x64)/0x64,'dailyRevenue':_0x583b2e[_0x188201(0xc3)],'dailyPayments':_0x583b2e[_0x188201(0x86)],'recentPayments':_0x25af8f[_0x188201(0xc1)](_0xa3772d=>({'id':_0xa3772d['id'],'gateway':_0xa3772d[_0x188201(0xa3)],'amount':_0xa3772d[_0x188201(0x91)],'currency':_0xa3772d['currency'],'status':_0xa3772d[_0x188201(0x9e)],'createdAt':_0xa3772d[_0x188201(0xb5)]}))};}[a56_0x594e0f(0xe5)](_0x103ef0,_0x2aa9d4,_0x366d73){const _0x564929=a56_0x594e0f,_0x1efb38=new Map(),_0x5207fb=new Date(_0x2aa9d4);while(_0x5207fb<=_0x366d73){const _0x2465ea=_0x5207fb[_0x564929(0xb0)]()[_0x564929(0xd2)]('T')[0x0];_0x1efb38['set'](_0x2465ea,{'revenue':0x0,'count':0x0}),_0x5207fb[_0x564929(0xde)](_0x5207fb['getDate']()+0x1);}for(const _0x8686bd of _0x103ef0){const _0x1f5e44=_0x8686bd[_0x564929(0xb5)][_0x564929(0xb0)]()[_0x564929(0xd2)]('T')[0x0],_0x29bee5=_0x1efb38[_0x564929(0x98)](_0x1f5e44);_0x29bee5&&(_0x29bee5['count']+=0x1,_0x8686bd['status']===_0x564929(0x6b)&&_0x8686bd[_0x564929(0x112)]&&(_0x29bee5[_0x564929(0x75)]+=_0x8686bd['amountUSDT']));}const _0x188573=[],_0x5cb1f2=[];for(const [_0x5a84fe,_0x199b7c]of _0x1efb38){_0x188573[_0x564929(0x11a)]({'date':_0x5a84fe,'amount':Math[_0x564929(0x10e)](_0x199b7c[_0x564929(0x75)]*0x64)/0x64}),_0x5cb1f2['push']({'date':_0x5a84fe,'count':_0x199b7c[_0x564929(0xf1)]});}return{'dailyRevenue':_0x188573,'dailyPayments':_0x5cb1f2};}}exports[a56_0x594e0f(0xe6)]=ShopService;