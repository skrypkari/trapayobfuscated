'use strict';const a25_0xc04c60=a25_0x1b52;function a25_0x1b52(_0x37effd,_0x218c2e){const _0x5dd40d=a25_0x5dd4();return a25_0x1b52=function(_0x1b5238,_0x2fb402){_0x1b5238=_0x1b5238-0x151;let _0x2c948c=_0x5dd40d[_0x1b5238];return _0x2c948c;},a25_0x1b52(_0x37effd,_0x218c2e);}function a25_0x5dd4(){const _0x57957d=['../config/database','defineProperty','__setModuleDefault','get','Internal\x20API\x20error\x20updating\x20payment:','call','3113wufPnb','username','body','default','error','paid_at','236128sBBAuU','üì§\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','Missing\x20or\x20invalid\x20authorization\x20header','/payments/:id/gateway-settings','prototype','resolve','1613583gxSEdl','entries','orderId','__importStar','329DiuikD','hasOwnProperty','getOwnPropertyDescriptor','payment_method','33510ccbiaz','internal-api-key','üéâ\x20Payment\x20','log','getOwnPropertyNames','No\x20valid\x20fields\x20to\x20update','üîÑ\x20Internal\x20API:\x20Updating\x20payment\x20','Internal\x20server\x20error','length','2041084lwNSRA','üîç\x20Internal\x20API:\x20Getting\x20payment\x20','failure_message','\x20updated\x20successfully','update','46600bvAVzC','express','substring','string','shop','then','gateway_payment_id','status','replace','json','4pHtDEj','758640anvHEH','headers','create','toISOString','amount','configurable','../services/webhookService','Internal\x20API\x20error\x20getting\x20payment:','findUnique','‚úÖ\x20Internal\x20API:\x20Payment\x20','‚úÖ\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','45ygeKMN','toUpperCase','authorization','params','Invalid\x20internal\x20API\x20key','718629RVnWzt','payment','PAID','__esModule','Router','\x20with\x20gateway\x20settings','patch'];a25_0x5dd4=function(){return _0x57957d;};return a25_0x5dd4();}(function(_0x5752d1,_0x67a6b9){const _0x3c31d8=a25_0x1b52,_0x161284=_0x5752d1();while(!![]){try{const _0x2a0f85=parseInt(_0x3c31d8(0x152))/0x1+-parseInt(_0x3c31d8(0x17d))/0x2+parseInt(_0x3c31d8(0x16c))/0x3*(-parseInt(_0x3c31d8(0x18c))/0x4)+parseInt(_0x3c31d8(0x18d))/0x5+-parseInt(_0x3c31d8(0x174))/0x6*(parseInt(_0x3c31d8(0x170))/0x7)+parseInt(_0x3c31d8(0x165))/0x8*(parseInt(_0x3c31d8(0x198))/0x9)+parseInt(_0x3c31d8(0x182))/0xa*(parseInt(_0x3c31d8(0x15f))/0xb);if(_0x2a0f85===_0x67a6b9)break;else _0x161284['push'](_0x161284['shift']());}catch(_0x39b602){_0x161284['push'](_0x161284['shift']());}}}(a25_0x5dd4,0x7deeb));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x4e5cb6,_0x1d123e,_0x478661,_0x2d19d7){const _0x28b66e=a25_0x1b52;if(_0x2d19d7===undefined)_0x2d19d7=_0x478661;var _0x1d19e4=Object[_0x28b66e(0x172)](_0x1d123e,_0x478661);(!_0x1d19e4||(_0x28b66e(0x15c)in _0x1d19e4?!_0x1d123e[_0x28b66e(0x155)]:_0x1d19e4['writable']||_0x1d19e4[_0x28b66e(0x192)]))&&(_0x1d19e4={'enumerable':!![],'get':function(){return _0x1d123e[_0x478661];}}),Object['defineProperty'](_0x4e5cb6,_0x2d19d7,_0x1d19e4);}:function(_0x3d31b0,_0x4b78a1,_0x54a4ec,_0x1f99b4){if(_0x1f99b4===undefined)_0x1f99b4=_0x54a4ec;_0x3d31b0[_0x1f99b4]=_0x4b78a1[_0x54a4ec];}),__setModuleDefault=this&&this[a25_0xc04c60(0x15b)]||(Object[a25_0xc04c60(0x18f)]?function(_0x1041b7,_0x3c2def){const _0x4b3aea=a25_0xc04c60;Object[_0x4b3aea(0x15a)](_0x1041b7,_0x4b3aea(0x162),{'enumerable':!![],'value':_0x3c2def});}:function(_0x32f196,_0xeed895){const _0x25d30d=a25_0xc04c60;_0x32f196[_0x25d30d(0x162)]=_0xeed895;}),__importStar=this&&this[a25_0xc04c60(0x16f)]||(function(){var _0x522d2c=function(_0x3a8df6){const _0x403524=a25_0x1b52;return _0x522d2c=Object[_0x403524(0x178)]||function(_0x50dff5){const _0x44dda1=_0x403524;var _0x39644c=[];for(var _0x2f694e in _0x50dff5)if(Object[_0x44dda1(0x16a)][_0x44dda1(0x171)][_0x44dda1(0x15e)](_0x50dff5,_0x2f694e))_0x39644c[_0x39644c[_0x44dda1(0x17c)]]=_0x2f694e;return _0x39644c;},_0x522d2c(_0x3a8df6);};return function(_0x412354){const _0x379e3c=a25_0x1b52;if(_0x412354&&_0x412354[_0x379e3c(0x155)])return _0x412354;var _0x4bd09e={};if(_0x412354!=null){for(var _0x56e84c=_0x522d2c(_0x412354),_0x24e4b7=0x0;_0x24e4b7<_0x56e84c[_0x379e3c(0x17c)];_0x24e4b7++)if(_0x56e84c[_0x24e4b7]!==_0x379e3c(0x162))__createBinding(_0x4bd09e,_0x412354,_0x56e84c[_0x24e4b7]);}return __setModuleDefault(_0x4bd09e,_0x412354),_0x4bd09e;};}()),__importDefault=this&&this['__importDefault']||function(_0x27bc0c){return _0x27bc0c&&_0x27bc0c['__esModule']?_0x27bc0c:{'default':_0x27bc0c};};Object[a25_0xc04c60(0x15a)](exports,a25_0xc04c60(0x155),{'value':!![]});const express_1=require(a25_0xc04c60(0x183)),database_1=__importDefault(require(a25_0xc04c60(0x159))),router=(0x0,express_1[a25_0xc04c60(0x156)])(),verifyInternalApiKey=(_0x5db728,_0x9c51cd,_0x4e9bba)=>{const _0x4ac1d2=a25_0xc04c60,_0x2cf971=_0x5db728[_0x4ac1d2(0x18e)][_0x4ac1d2(0x19a)];if(!_0x2cf971||!_0x2cf971['startsWith']('Bearer\x20'))return _0x9c51cd[_0x4ac1d2(0x189)](0x191)['json']({'error':_0x4ac1d2(0x168)});const _0x4b5eb5=_0x2cf971[_0x4ac1d2(0x184)](0x7);if(_0x4b5eb5!==_0x4ac1d2(0x175))return _0x9c51cd['status'](0x191)[_0x4ac1d2(0x18b)]({'error':_0x4ac1d2(0x151)});_0x4e9bba();};router['get'](a25_0xc04c60(0x169),verifyInternalApiKey,async(_0x53f211,_0x38ffb6)=>{const _0x4926c2=a25_0xc04c60;try{const {id:_0x817ce4}=_0x53f211['params'];console[_0x4926c2(0x177)](_0x4926c2(0x17e)+_0x817ce4+_0x4926c2(0x157));const _0x3def3a=await database_1[_0x4926c2(0x162)][_0x4926c2(0x153)][_0x4926c2(0x195)]({'where':{'id':_0x817ce4},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x3def3a)return _0x38ffb6[_0x4926c2(0x189)](0x194)[_0x4926c2(0x18b)]({'error':'Payment\x20not\x20found'});console['log'](_0x4926c2(0x197)+_0x3def3a[_0x4926c2(0x186)][_0x4926c2(0x160)]),_0x38ffb6[_0x4926c2(0x18b)]({'id':_0x3def3a['id'],'amount':_0x3def3a[_0x4926c2(0x191)],'currency':_0x3def3a['currency'],'status':_0x3def3a['status'],'orderId':_0x3def3a[_0x4926c2(0x16e)],'shop':_0x3def3a['shop']});}catch(_0x5acdbc){console[_0x4926c2(0x163)](_0x4926c2(0x194),_0x5acdbc),_0x38ffb6[_0x4926c2(0x189)](0x1f4)[_0x4926c2(0x18b)]({'error':'Internal\x20server\x20error'});}}),router[a25_0xc04c60(0x158)]('/payments/:id/update',verifyInternalApiKey,async(_0x9d5a5f,_0x5083e6)=>{const _0x92229e=a25_0xc04c60;try{const {id:_0x31e688}=_0x9d5a5f[_0x92229e(0x19b)],_0x4a6f50=_0x9d5a5f[_0x92229e(0x161)];console[_0x92229e(0x177)](_0x92229e(0x17a)+_0x31e688,_0x4a6f50);const _0x576608=['status',_0x92229e(0x188),'card_last4',_0x92229e(0x173),_0x92229e(0x164),_0x92229e(0x17f)],_0xea2ab2={};for(const [_0x44b22a,_0x38b438]of Object[_0x92229e(0x16d)](_0x4a6f50)){if(_0x576608['includes'](_0x44b22a)){const _0x2bb36b=_0x44b22a[_0x92229e(0x18a)](/_([a-z])/g,(_0x3ebfec,_0x537808)=>_0x537808[_0x92229e(0x199)]());_0x2bb36b==='paidAt'&&typeof _0x38b438===_0x92229e(0x185)?_0xea2ab2[_0x2bb36b]=new Date(_0x38b438):_0xea2ab2[_0x2bb36b]=_0x38b438;}}if(Object['keys'](_0xea2ab2)[_0x92229e(0x17c)]===0x0)return _0x5083e6[_0x92229e(0x189)](0x190)['json']({'error':_0x92229e(0x179)});const _0x10845c=await database_1[_0x92229e(0x162)][_0x92229e(0x153)][_0x92229e(0x181)]({'where':{'id':_0x31e688},'data':_0xea2ab2});console[_0x92229e(0x177)](_0x92229e(0x196)+_0x31e688+_0x92229e(0x180));if(_0xea2ab2[_0x92229e(0x189)]===_0x92229e(0x154)){console['log'](_0x92229e(0x176)+_0x31e688+_0x92229e(0x167));try{const {WebhookService:_0x4903a5}=await Promise[_0x92229e(0x16b)]()[_0x92229e(0x187)](()=>__importStar(require(_0x92229e(0x193)))),_0x37d878=new _0x4903a5(),_0x34bb7b=await database_1['default'][_0x92229e(0x153)][_0x92229e(0x195)]({'where':{'id':_0x31e688},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x34bb7b&&console[_0x92229e(0x177)](_0x92229e(0x166)+_0x31e688);}catch(_0x33d472){console[_0x92229e(0x163)]('Error\x20sending\x20webhook\x20notification:',_0x33d472);}}_0x5083e6[_0x92229e(0x18b)]({'success':!![],'payment':{'id':_0x10845c['id'],'status':_0x10845c[_0x92229e(0x189)]}});}catch(_0x590323){console[_0x92229e(0x163)](_0x92229e(0x15d),_0x590323),_0x5083e6[_0x92229e(0x189)](0x1f4)[_0x92229e(0x18b)]({'error':_0x92229e(0x17b)});}}),router[a25_0xc04c60(0x15c)]('/health',(_0xe1b9d7,_0x284318)=>{const _0x130f95=a25_0xc04c60;_0x284318['json']({'status':'ok','timestamp':new Date()[_0x130f95(0x190)]()});}),exports[a25_0xc04c60(0x162)]=router;