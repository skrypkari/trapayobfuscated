'use strict';const a25_0x302b79=a25_0x8ee9;(function(_0x5ed8c7,_0x518d24){const _0x352695=a25_0x8ee9,_0x10253b=_0x5ed8c7();while(!![]){try{const _0x500f29=parseInt(_0x352695(0x11a))/0x1+parseInt(_0x352695(0x12e))/0x2*(parseInt(_0x352695(0x111))/0x3)+-parseInt(_0x352695(0x12b))/0x4*(parseInt(_0x352695(0x14c))/0x5)+-parseInt(_0x352695(0x136))/0x6*(parseInt(_0x352695(0x143))/0x7)+-parseInt(_0x352695(0x11d))/0x8*(-parseInt(_0x352695(0x121))/0x9)+parseInt(_0x352695(0x115))/0xa+parseInt(_0x352695(0x11b))/0xb*(parseInt(_0x352695(0x132))/0xc);if(_0x500f29===_0x518d24)break;else _0x10253b['push'](_0x10253b['shift']());}catch(_0x120f11){_0x10253b['push'](_0x10253b['shift']());}}}(a25_0x13d4,0x5145f));function a25_0x8ee9(_0x549ba5,_0x5599d6){const _0x13d4af=a25_0x13d4();return a25_0x8ee9=function(_0x8ee9d6,_0x5d8fff){_0x8ee9d6=_0x8ee9d6-0xff;let _0xc2636d=_0x13d4af[_0x8ee9d6];return _0xc2636d;},a25_0x8ee9(_0x549ba5,_0x5599d6);}var __createBinding=this&&this[a25_0x302b79(0x116)]||(Object[a25_0x302b79(0x104)]?function(_0x411f92,_0x14e60d,_0x237773,_0x3f6c60){const _0x204d11=a25_0x302b79;if(_0x3f6c60===undefined)_0x3f6c60=_0x237773;var _0x422ca3=Object[_0x204d11(0x13b)](_0x14e60d,_0x237773);(!_0x422ca3||('get'in _0x422ca3?!_0x14e60d[_0x204d11(0x13f)]:_0x422ca3[_0x204d11(0x142)]||_0x422ca3[_0x204d11(0x11e)]))&&(_0x422ca3={'enumerable':!![],'get':function(){return _0x14e60d[_0x237773];}}),Object['defineProperty'](_0x411f92,_0x3f6c60,_0x422ca3);}:function(_0x17fd04,_0x4a660e,_0x3433ab,_0x534e43){if(_0x534e43===undefined)_0x534e43=_0x3433ab;_0x17fd04[_0x534e43]=_0x4a660e[_0x3433ab];}),__setModuleDefault=this&&this[a25_0x302b79(0xff)]||(Object['create']?function(_0x2f947c,_0x45b9fe){const _0x38a770=a25_0x302b79;Object[_0x38a770(0x110)](_0x2f947c,_0x38a770(0x102),{'enumerable':!![],'value':_0x45b9fe});}:function(_0x4d07ab,_0x58d1c0){const _0x2f9962=a25_0x302b79;_0x4d07ab[_0x2f9962(0x102)]=_0x58d1c0;}),__importStar=this&&this[a25_0x302b79(0x119)]||(function(){var _0x4055ee=function(_0x3e01f9){const _0x5e8016=a25_0x8ee9;return _0x4055ee=Object[_0x5e8016(0x13c)]||function(_0x4eeef8){const _0x755761=_0x5e8016;var _0x3c3d6d=[];for(var _0x41b975 in _0x4eeef8)if(Object[_0x755761(0x118)]['hasOwnProperty']['call'](_0x4eeef8,_0x41b975))_0x3c3d6d[_0x3c3d6d['length']]=_0x41b975;return _0x3c3d6d;},_0x4055ee(_0x3e01f9);};return function(_0x73ef52){const _0x581dd8=a25_0x8ee9;if(_0x73ef52&&_0x73ef52['__esModule'])return _0x73ef52;var _0x3da7f6={};if(_0x73ef52!=null){for(var _0x5aa45d=_0x4055ee(_0x73ef52),_0x3bd96d=0x0;_0x3bd96d<_0x5aa45d[_0x581dd8(0x10c)];_0x3bd96d++)if(_0x5aa45d[_0x3bd96d]!==_0x581dd8(0x102))__createBinding(_0x3da7f6,_0x73ef52,_0x5aa45d[_0x3bd96d]);}return __setModuleDefault(_0x3da7f6,_0x73ef52),_0x3da7f6;};}()),__importDefault=this&&this[a25_0x302b79(0x114)]||function(_0x367c6c){const _0x342c84=a25_0x302b79;return _0x367c6c&&_0x367c6c[_0x342c84(0x13f)]?_0x367c6c:{'default':_0x367c6c};};Object['defineProperty'](exports,'__esModule',{'value':!![]});function a25_0x13d4(){const _0x29a9ab=['2754978lXQqdh','paymentMethod','failure_message','🎉\x20Payment\x20','get','getOwnPropertyDescriptor','getOwnPropertyNames','currency','then','__esModule','gatewayPaymentId','paid_at','writable','7GluzaI','status','../config/database','payment_method','json','✅\x20Internal\x20API:\x20Payment\x20','Internal\x20server\x20error','Bearer\x20','toISOString','60ObSpxi','__setModuleDefault','entries','update','default','resolve','create','payment','Payment\x20not\x20found','findUnique','✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','substring','gateway_payment_id','/payments/:id/gateway-settings','length','Internal\x20API\x20error\x20updating\x20payment:','amount','failureMessage','defineProperty','36813koVfqb','authorization','card_last4','__importDefault','364990oXdVhr','__createBinding','username','prototype','__importStar','345803zixVrG','2398oPRWsd','includes','93064pnFNUG','configurable','cardLast4','startsWith','9DPnpTZ','🔄\x20Internal\x20API:\x20Updating\x20payment\x20','patch','log','internal-api-key','params','string','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','orderId','/payments/:id/update','42516YYCDLU','keys','Missing\x20or\x20invalid\x20authorization\x20header','30nrISZM','PAID','error','\x20with\x20gateway\x20settings','18804qyZtKw','Invalid\x20internal\x20API\x20key','shop','Internal\x20API\x20error\x20getting\x20payment:'];a25_0x13d4=function(){return _0x29a9ab;};return a25_0x13d4();}const express_1=require('express'),database_1=__importDefault(require(a25_0x302b79(0x145))),router=(0x0,express_1['Router'])(),verifyInternalApiKey=(_0x46725f,_0x1de3df,_0x1dc433)=>{const _0x140f83=a25_0x302b79,_0x3f7af5=_0x46725f['headers'][_0x140f83(0x112)];if(!_0x3f7af5||!_0x3f7af5[_0x140f83(0x120)](_0x140f83(0x14a)))return _0x1de3df['status'](0x191)[_0x140f83(0x147)]({'error':_0x140f83(0x12d)});const _0x26e56e=_0x3f7af5[_0x140f83(0x109)](0x7);if(_0x26e56e!==_0x140f83(0x125))return _0x1de3df[_0x140f83(0x144)](0x191)[_0x140f83(0x147)]({'error':_0x140f83(0x133)});_0x1dc433();};router['get'](a25_0x302b79(0x10b),verifyInternalApiKey,async(_0x1e244b,_0x5f20e9)=>{const _0x538c4e=a25_0x302b79;try{const {id:_0x22902a}=_0x1e244b[_0x538c4e(0x126)];console['log']('🔍\x20Internal\x20API:\x20Getting\x20payment\x20'+_0x22902a+_0x538c4e(0x131));const _0x5ffc64=await database_1[_0x538c4e(0x102)]['payment'][_0x538c4e(0x107)]({'where':{'id':_0x22902a},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x5ffc64)return _0x5f20e9[_0x538c4e(0x144)](0x194)['json']({'error':_0x538c4e(0x106)});console['log'](_0x538c4e(0x108)+_0x5ffc64[_0x538c4e(0x134)][_0x538c4e(0x117)]),_0x5f20e9[_0x538c4e(0x147)]({'id':_0x5ffc64['id'],'amount':_0x5ffc64[_0x538c4e(0x10e)],'currency':_0x5ffc64[_0x538c4e(0x13d)],'status':_0x5ffc64[_0x538c4e(0x144)],'orderId':_0x5ffc64[_0x538c4e(0x129)],'shop':_0x5ffc64[_0x538c4e(0x134)]});}catch(_0x2432f9){console[_0x538c4e(0x130)](_0x538c4e(0x135),_0x2432f9),_0x5f20e9['status'](0x1f4)['json']({'error':_0x538c4e(0x149)});}}),router[a25_0x302b79(0x123)](a25_0x302b79(0x12a),verifyInternalApiKey,async(_0x1cce85,_0x56ed08)=>{const _0x2e2853=a25_0x302b79;try{const {id:_0x4caffe}=_0x1cce85[_0x2e2853(0x126)],_0x3e61fd=_0x1cce85['body'];console[_0x2e2853(0x124)](_0x2e2853(0x122)+_0x4caffe,_0x3e61fd);const _0x1bc61f=[_0x2e2853(0x144),_0x2e2853(0x10a),_0x2e2853(0x140),_0x2e2853(0x113),_0x2e2853(0x11f),_0x2e2853(0x146),_0x2e2853(0x137),'paid_at','paidAt',_0x2e2853(0x138),_0x2e2853(0x10f)],_0x5667c3={};for(const [_0x5a7ea5,_0x2a00a8]of Object[_0x2e2853(0x100)](_0x3e61fd)){if(_0x1bc61f[_0x2e2853(0x11c)](_0x5a7ea5)){let _0x15fe48=_0x5a7ea5;if(_0x5a7ea5==='gateway_payment_id'||_0x5a7ea5===_0x2e2853(0x140))_0x15fe48=_0x2e2853(0x140);else{if(_0x5a7ea5===_0x2e2853(0x113)||_0x5a7ea5===_0x2e2853(0x11f))_0x15fe48=_0x2e2853(0x11f);else{if(_0x5a7ea5===_0x2e2853(0x146)||_0x5a7ea5===_0x2e2853(0x137))_0x15fe48='paymentMethod';else{if(_0x5a7ea5===_0x2e2853(0x141)||_0x5a7ea5==='paidAt')_0x15fe48='paidAt';else(_0x5a7ea5==='failure_message'||_0x5a7ea5===_0x2e2853(0x10f))&&(_0x15fe48='failureMessage');}}}_0x15fe48==='paidAt'&&typeof _0x2a00a8===_0x2e2853(0x127)?_0x5667c3[_0x15fe48]=new Date(_0x2a00a8):_0x5667c3[_0x15fe48]=_0x2a00a8;}}if(Object[_0x2e2853(0x12c)](_0x5667c3)[_0x2e2853(0x10c)]===0x0)return _0x56ed08[_0x2e2853(0x144)](0x190)[_0x2e2853(0x147)]({'error':'No\x20valid\x20fields\x20to\x20update'});const _0x29beb2=await database_1[_0x2e2853(0x102)][_0x2e2853(0x105)][_0x2e2853(0x101)]({'where':{'id':_0x4caffe},'data':_0x5667c3});console[_0x2e2853(0x124)](_0x2e2853(0x148)+_0x4caffe+'\x20updated\x20successfully');if(_0x5667c3[_0x2e2853(0x144)]===_0x2e2853(0x12f)){console[_0x2e2853(0x124)](_0x2e2853(0x139)+_0x4caffe+_0x2e2853(0x128));try{const {WebhookService:_0x4d5ac3}=await Promise[_0x2e2853(0x103)]()[_0x2e2853(0x13e)](()=>__importStar(require('../services/webhookService'))),_0x5297f9=new _0x4d5ac3(),_0xa9f553=await database_1['default'][_0x2e2853(0x105)][_0x2e2853(0x107)]({'where':{'id':_0x4caffe},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0xa9f553&&console[_0x2e2853(0x124)]('📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20'+_0x4caffe);}catch(_0x99565){console[_0x2e2853(0x130)]('Error\x20sending\x20webhook\x20notification:',_0x99565);}}_0x56ed08[_0x2e2853(0x147)]({'success':!![],'payment':{'id':_0x29beb2['id'],'status':_0x29beb2['status']}});}catch(_0xac26e7){console['error'](_0x2e2853(0x10d),_0xac26e7),_0x56ed08[_0x2e2853(0x144)](0x1f4)['json']({'error':_0x2e2853(0x149)});}}),router[a25_0x302b79(0x13a)]('/health',(_0x150b3a,_0x5d2ab9)=>{const _0x1a0c38=a25_0x302b79;_0x5d2ab9[_0x1a0c38(0x147)]({'status':'ok','timestamp':new Date()[_0x1a0c38(0x14b)]()});}),exports[a25_0x302b79(0x102)]=router;