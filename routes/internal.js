'use strict';const a27_0x20ee70=a27_0x5108;(function(_0x5ca808,_0x2ad22d){const _0xd30e41=a27_0x5108,_0x27a6fb=_0x5ca808();while(!![]){try{const _0xfd9177=-parseInt(_0xd30e41(0x151))/0x1+-parseInt(_0xd30e41(0x147))/0x2*(-parseInt(_0xd30e41(0x15e))/0x3)+parseInt(_0xd30e41(0x15f))/0x4+parseInt(_0xd30e41(0x161))/0x5*(-parseInt(_0xd30e41(0x160))/0x6)+-parseInt(_0xd30e41(0x149))/0x7+-parseInt(_0xd30e41(0x17b))/0x8+parseInt(_0xd30e41(0x18a))/0x9;if(_0xfd9177===_0x2ad22d)break;else _0x27a6fb['push'](_0x27a6fb['shift']());}catch(_0x50c900){_0x27a6fb['push'](_0x27a6fb['shift']());}}}(a27_0xab3b,0x1e28a));var __createBinding=this&&this[a27_0x20ee70(0x181)]||(Object['create']?function(_0x47f250,_0x42b133,_0x24f35c,_0x24d4a7){const _0x23ead8=a27_0x20ee70;if(_0x24d4a7===undefined)_0x24d4a7=_0x24f35c;var _0xa7974b=Object['getOwnPropertyDescriptor'](_0x42b133,_0x24f35c);(!_0xa7974b||(_0x23ead8(0x172)in _0xa7974b?!_0x42b133[_0x23ead8(0x184)]:_0xa7974b['writable']||_0xa7974b[_0x23ead8(0x14b)]))&&(_0xa7974b={'enumerable':!![],'get':function(){return _0x42b133[_0x24f35c];}}),Object[_0x23ead8(0x17a)](_0x47f250,_0x24d4a7,_0xa7974b);}:function(_0x40a375,_0x344d91,_0x35b611,_0x5adf3d){if(_0x5adf3d===undefined)_0x5adf3d=_0x35b611;_0x40a375[_0x5adf3d]=_0x344d91[_0x35b611];}),__setModuleDefault=this&&this[a27_0x20ee70(0x15d)]||(Object[a27_0x20ee70(0x16a)]?function(_0x236de0,_0x37d81e){Object['defineProperty'](_0x236de0,'default',{'enumerable':!![],'value':_0x37d81e});}:function(_0x16dfd8,_0xbadd94){const _0x2b979a=a27_0x20ee70;_0x16dfd8[_0x2b979a(0x183)]=_0xbadd94;}),__importStar=this&&this[a27_0x20ee70(0x17f)]||(function(){var _0x195e52=function(_0x4ba40d){return _0x195e52=Object['getOwnPropertyNames']||function(_0x57f824){const _0x3db828=a27_0x5108;var _0x53ee8f=[];for(var _0x408f96 in _0x57f824)if(Object[_0x3db828(0x189)][_0x3db828(0x14f)][_0x3db828(0x15b)](_0x57f824,_0x408f96))_0x53ee8f[_0x53ee8f[_0x3db828(0x179)]]=_0x408f96;return _0x53ee8f;},_0x195e52(_0x4ba40d);};return function(_0x339ad8){const _0x158c5a=a27_0x5108;if(_0x339ad8&&_0x339ad8['__esModule'])return _0x339ad8;var _0x362d43={};if(_0x339ad8!=null){for(var _0x3da36d=_0x195e52(_0x339ad8),_0x5be095=0x0;_0x5be095<_0x3da36d[_0x158c5a(0x179)];_0x5be095++)if(_0x3da36d[_0x5be095]!==_0x158c5a(0x183))__createBinding(_0x362d43,_0x339ad8,_0x3da36d[_0x5be095]);}return __setModuleDefault(_0x362d43,_0x339ad8),_0x362d43;};}()),__importDefault=this&&this['__importDefault']||function(_0xfa9c07){return _0xfa9c07&&_0xfa9c07['__esModule']?_0xfa9c07:{'default':_0xfa9c07};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const express_1=require('express'),database_1=__importDefault(require('../config/database')),router=(0x0,express_1[a27_0x20ee70(0x173)])(),verifyInternalApiKey=(_0x1d45ef,_0x22184f,_0x4d83e1)=>{const _0x44fe50=a27_0x20ee70,_0x48e997=_0x1d45ef[_0x44fe50(0x14d)]['authorization'];if(!_0x48e997||!_0x48e997[_0x44fe50(0x14c)](_0x44fe50(0x17d)))return _0x22184f[_0x44fe50(0x146)](0x191)['json']({'error':_0x44fe50(0x170)});const _0x304807=_0x48e997[_0x44fe50(0x15a)](0x7);if(_0x304807!==_0x44fe50(0x174))return _0x22184f[_0x44fe50(0x146)](0x191)[_0x44fe50(0x169)]({'error':_0x44fe50(0x165)});_0x4d83e1();};function a27_0x5108(_0x516c16,_0x203605){const _0xab3b19=a27_0xab3b();return a27_0x5108=function(_0x510806,_0x116a7d){_0x510806=_0x510806-0x144;let _0x3fb2ba=_0xab3b19[_0x510806];return _0x3fb2ba;},a27_0x5108(_0x516c16,_0x203605);}function a27_0xab3b(){const _0x51b4d5=['Invalid\x20internal\x20API\x20key','card_last4','update','No\x20valid\x20fields\x20to\x20update','json','create','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','username','Payment\x20not\x20found','then','gateway_payment_id','Missing\x20or\x20invalid\x20authorization\x20header','failure_message','get','Router','internal-api-key','/health','🎉\x20Payment\x20','payment','paymentMethod','length','defineProperty','1742688MXRvgO','/payments/:id/gateway-settings','Bearer\x20','payment_method','__importStar','../services/webhookService','__createBinding','patch','default','__esModule','Error\x20sending\x20webhook\x20notification:','currency','Internal\x20API\x20error\x20updating\x20payment:','shop','prototype','2998107kwbZxt','error','toISOString','🔄\x20Internal\x20API:\x20Updating\x20payment\x20','status','4nSImOi','✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','786597JXYfFc','cardLast4','configurable','startsWith','headers','resolve','hasOwnProperty','Internal\x20server\x20error','38238Fhaolg','🔍\x20Internal\x20API:\x20Getting\x20payment\x20','gatewayPaymentId','log','PAID','Internal\x20API\x20error\x20getting\x20payment:','paidAt','string','✅\x20Internal\x20API:\x20Payment\x20','substring','call','findUnique','__setModuleDefault','62004LDODqR','901296BpQwxW','36hAhmhe','89840RIFoLB','failureMessage','params','paid_at'];a27_0xab3b=function(){return _0x51b4d5;};return a27_0xab3b();}router[a27_0x20ee70(0x172)](a27_0x20ee70(0x17c),verifyInternalApiKey,async(_0xf000b0,_0x411b87)=>{const _0x2b6dc3=a27_0x20ee70;try{const {id:_0x1e5859}=_0xf000b0[_0x2b6dc3(0x163)];console['log'](_0x2b6dc3(0x152)+_0x1e5859+'\x20with\x20gateway\x20settings');const _0x2730ce=await database_1[_0x2b6dc3(0x183)][_0x2b6dc3(0x177)]['findUnique']({'where':{'id':_0x1e5859},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x2730ce)return _0x411b87[_0x2b6dc3(0x146)](0x194)['json']({'error':_0x2b6dc3(0x16d)});console['log'](_0x2b6dc3(0x148)+_0x2730ce[_0x2b6dc3(0x188)][_0x2b6dc3(0x16c)]),_0x411b87[_0x2b6dc3(0x169)]({'id':_0x2730ce['id'],'amount':_0x2730ce['amount'],'currency':_0x2730ce[_0x2b6dc3(0x186)],'status':_0x2730ce[_0x2b6dc3(0x146)],'orderId':_0x2730ce['orderId'],'shop':_0x2730ce['shop']});}catch(_0x150488){console[_0x2b6dc3(0x18b)](_0x2b6dc3(0x156),_0x150488),_0x411b87['status'](0x1f4)[_0x2b6dc3(0x169)]({'error':'Internal\x20server\x20error'});}}),router[a27_0x20ee70(0x182)]('/payments/:id/update',verifyInternalApiKey,async(_0x53dc14,_0x44d425)=>{const _0x2a9c68=a27_0x20ee70;try{const {id:_0xcbbb0c}=_0x53dc14[_0x2a9c68(0x163)],_0x5959d6=_0x53dc14['body'];console['log'](_0x2a9c68(0x145)+_0xcbbb0c,_0x5959d6);const _0xdc87c8=[_0x2a9c68(0x146),_0x2a9c68(0x16f),_0x2a9c68(0x153),_0x2a9c68(0x166),'cardLast4',_0x2a9c68(0x17e),'paymentMethod',_0x2a9c68(0x164),'paidAt',_0x2a9c68(0x171),_0x2a9c68(0x162)],_0x1e25d9={};for(const [_0x3cc4dd,_0x857a20]of Object['entries'](_0x5959d6)){if(_0xdc87c8['includes'](_0x3cc4dd)){let _0x5df48d=_0x3cc4dd;if(_0x3cc4dd===_0x2a9c68(0x16f)||_0x3cc4dd===_0x2a9c68(0x153))_0x5df48d='gatewayPaymentId';else{if(_0x3cc4dd===_0x2a9c68(0x166)||_0x3cc4dd===_0x2a9c68(0x14a))_0x5df48d='cardLast4';else{if(_0x3cc4dd===_0x2a9c68(0x17e)||_0x3cc4dd===_0x2a9c68(0x178))_0x5df48d='paymentMethod';else{if(_0x3cc4dd===_0x2a9c68(0x164)||_0x3cc4dd===_0x2a9c68(0x157))_0x5df48d=_0x2a9c68(0x157);else(_0x3cc4dd===_0x2a9c68(0x171)||_0x3cc4dd===_0x2a9c68(0x162))&&(_0x5df48d='failureMessage');}}}_0x5df48d==='paidAt'&&typeof _0x857a20===_0x2a9c68(0x158)?_0x1e25d9[_0x5df48d]=new Date(_0x857a20):_0x1e25d9[_0x5df48d]=_0x857a20;}}if(Object['keys'](_0x1e25d9)[_0x2a9c68(0x179)]===0x0)return _0x44d425[_0x2a9c68(0x146)](0x190)[_0x2a9c68(0x169)]({'error':_0x2a9c68(0x168)});const _0x195fb8=await database_1['default']['payment'][_0x2a9c68(0x167)]({'where':{'id':_0xcbbb0c},'data':_0x1e25d9});console[_0x2a9c68(0x154)](_0x2a9c68(0x159)+_0xcbbb0c+'\x20updated\x20successfully');if(_0x1e25d9['status']===_0x2a9c68(0x155)){console[_0x2a9c68(0x154)](_0x2a9c68(0x176)+_0xcbbb0c+_0x2a9c68(0x16b));try{const {WebhookService:_0x59e644}=await Promise[_0x2a9c68(0x14e)]()[_0x2a9c68(0x16e)](()=>__importStar(require(_0x2a9c68(0x180)))),_0xa09450=new _0x59e644(),_0x213d11=await database_1[_0x2a9c68(0x183)][_0x2a9c68(0x177)][_0x2a9c68(0x15c)]({'where':{'id':_0xcbbb0c},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x213d11&&console[_0x2a9c68(0x154)]('📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20'+_0xcbbb0c);}catch(_0x24e36c){console[_0x2a9c68(0x18b)](_0x2a9c68(0x185),_0x24e36c);}}_0x44d425[_0x2a9c68(0x169)]({'success':!![],'payment':{'id':_0x195fb8['id'],'status':_0x195fb8[_0x2a9c68(0x146)]}});}catch(_0x30bb6b){console['error'](_0x2a9c68(0x187),_0x30bb6b),_0x44d425[_0x2a9c68(0x146)](0x1f4)['json']({'error':_0x2a9c68(0x150)});}}),router[a27_0x20ee70(0x172)](a27_0x20ee70(0x175),(_0x5e1793,_0x6390e9)=>{const _0xca9c6c=a27_0x20ee70;_0x6390e9[_0xca9c6c(0x169)]({'status':'ok','timestamp':new Date()[_0xca9c6c(0x144)]()});}),exports['default']=router;