'use strict';function a27_0x5982(){const _0x19f685=['toISOString','Internal\x20API\x20error\x20updating\x20payment:','15pWhcvN','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','89672RwUYAs','621572fSllXl','Internal\x20server\x20error','hasOwnProperty','gatewayPaymentId','getOwnPropertyDescriptor','üîç\x20Internal\x20API:\x20Getting\x20payment\x20','findUnique','__importDefault','failure_message','6072736xtjiOn','Missing\x20or\x20invalid\x20authorization\x20header','1126956KqYGQt','writable','express','paidAt','substring','shop','__createBinding','\x20updated\x20successfully','Error\x20sending\x20webhook\x20notification:','defineProperty','üì§\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','get','includes','gateway_payment_id','51kMAibD','Router','card_last4','../config/database','default','resolve','payment_method','body','create','‚úÖ\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','keys','Payment\x20not\x20found','12468480dlDFhQ','/payments/:id/gateway-settings','paid_at','1757LQmxMP','patch','PAID','Internal\x20API\x20error\x20getting\x20payment:','7266WflnfB','getOwnPropertyNames','length','__esModule','üéâ\x20Payment\x20','internal-api-key','paymentMethod','error','payment','__setModuleDefault','orderId','authorization','877239AcLSxq','failureMessage','‚úÖ\x20Internal\x20API:\x20Payment\x20','entries','üîÑ\x20Internal\x20API:\x20Updating\x20payment\x20','cardLast4','params','prototype','\x20with\x20gateway\x20settings','/health','call','update','username','string','then','configurable','json','log','startsWith','status','__importStar'];a27_0x5982=function(){return _0x19f685;};return a27_0x5982();}const a27_0x5d31ed=a27_0x3bae;function a27_0x3bae(_0x45b3ee,_0x504f53){const _0x59822f=a27_0x5982();return a27_0x3bae=function(_0x3bae9f,_0x1a2964){_0x3bae9f=_0x3bae9f-0x71;let _0x406e07=_0x59822f[_0x3bae9f];return _0x406e07;},a27_0x3bae(_0x45b3ee,_0x504f53);}(function(_0x21ec00,_0x4d14d2){const _0x3069ee=a27_0x3bae,_0x4ae2cd=_0x21ec00();while(!![]){try{const _0x27ddde=parseInt(_0x3069ee(0xb2))/0x1+-parseInt(_0x3069ee(0xb1))/0x2*(-parseInt(_0x3069ee(0x79))/0x3)+parseInt(_0x3069ee(0xbd))/0x4*(parseInt(_0x3069ee(0xaf))/0x5)+-parseInt(_0x3069ee(0x8c))/0x6*(-parseInt(_0x3069ee(0x88))/0x7)+-parseInt(_0x3069ee(0xbb))/0x8+-parseInt(_0x3069ee(0x98))/0x9+-parseInt(_0x3069ee(0x85))/0xa;if(_0x27ddde===_0x4d14d2)break;else _0x4ae2cd['push'](_0x4ae2cd['shift']());}catch(_0x2785e1){_0x4ae2cd['push'](_0x4ae2cd['shift']());}}}(a27_0x5982,0x68def));var __createBinding=this&&this[a27_0x5d31ed(0x71)]||(Object[a27_0x5d31ed(0x81)]?function(_0x2f8c97,_0x3f6c0b,_0x4d59b1,_0x40a97c){const _0x2caf68=a27_0x5d31ed;if(_0x40a97c===undefined)_0x40a97c=_0x4d59b1;var _0x50d982=Object[_0x2caf68(0xb6)](_0x3f6c0b,_0x4d59b1);(!_0x50d982||(_0x2caf68(0x76)in _0x50d982?!_0x3f6c0b[_0x2caf68(0x8f)]:_0x50d982[_0x2caf68(0xbe)]||_0x50d982[_0x2caf68(0xa7)]))&&(_0x50d982={'enumerable':!![],'get':function(){return _0x3f6c0b[_0x4d59b1];}}),Object[_0x2caf68(0x74)](_0x2f8c97,_0x40a97c,_0x50d982);}:function(_0x5d5efd,_0x39ddda,_0x2c55c0,_0x2da3c6){if(_0x2da3c6===undefined)_0x2da3c6=_0x2c55c0;_0x5d5efd[_0x2da3c6]=_0x39ddda[_0x2c55c0];}),__setModuleDefault=this&&this[a27_0x5d31ed(0x95)]||(Object[a27_0x5d31ed(0x81)]?function(_0x5909dd,_0x93e33d){const _0x4a5753=a27_0x5d31ed;Object[_0x4a5753(0x74)](_0x5909dd,_0x4a5753(0x7d),{'enumerable':!![],'value':_0x93e33d});}:function(_0x467e53,_0x32a9f7){_0x467e53['default']=_0x32a9f7;}),__importStar=this&&this[a27_0x5d31ed(0xac)]||(function(){var _0x2256ae=function(_0x5ccdf1){const _0xd3bd5=a27_0x3bae;return _0x2256ae=Object[_0xd3bd5(0x8d)]||function(_0x32caac){const _0x389a54=_0xd3bd5;var _0xcad947=[];for(var _0x53f68b in _0x32caac)if(Object[_0x389a54(0x9f)][_0x389a54(0xb4)][_0x389a54(0xa2)](_0x32caac,_0x53f68b))_0xcad947[_0xcad947['length']]=_0x53f68b;return _0xcad947;},_0x2256ae(_0x5ccdf1);};return function(_0x46e525){const _0x52219e=a27_0x3bae;if(_0x46e525&&_0x46e525[_0x52219e(0x8f)])return _0x46e525;var _0x486fb9={};if(_0x46e525!=null){for(var _0x1528ec=_0x2256ae(_0x46e525),_0x13b747=0x0;_0x13b747<_0x1528ec[_0x52219e(0x8e)];_0x13b747++)if(_0x1528ec[_0x13b747]!==_0x52219e(0x7d))__createBinding(_0x486fb9,_0x46e525,_0x1528ec[_0x13b747]);}return __setModuleDefault(_0x486fb9,_0x46e525),_0x486fb9;};}()),__importDefault=this&&this[a27_0x5d31ed(0xb9)]||function(_0x180d3f){return _0x180d3f&&_0x180d3f['__esModule']?_0x180d3f:{'default':_0x180d3f};};Object[a27_0x5d31ed(0x74)](exports,a27_0x5d31ed(0x8f),{'value':!![]});const express_1=require(a27_0x5d31ed(0xbf)),database_1=__importDefault(require(a27_0x5d31ed(0x7c))),router=(0x0,express_1[a27_0x5d31ed(0x7a)])(),verifyInternalApiKey=(_0x1066ea,_0x7f0634,_0x48d41c)=>{const _0x2d5081=a27_0x5d31ed,_0x226806=_0x1066ea['headers'][_0x2d5081(0x97)];if(!_0x226806||!_0x226806[_0x2d5081(0xaa)]('Bearer\x20'))return _0x7f0634[_0x2d5081(0xab)](0x191)[_0x2d5081(0xa8)]({'error':_0x2d5081(0xbc)});const _0x3e6a72=_0x226806[_0x2d5081(0xc1)](0x7);if(_0x3e6a72!==_0x2d5081(0x91))return _0x7f0634[_0x2d5081(0xab)](0x191)[_0x2d5081(0xa8)]({'error':'Invalid\x20internal\x20API\x20key'});_0x48d41c();};router[a27_0x5d31ed(0x76)](a27_0x5d31ed(0x86),verifyInternalApiKey,async(_0x106d78,_0x48c38d)=>{const _0xc6816=a27_0x5d31ed;try{const {id:_0x1d0d17}=_0x106d78[_0xc6816(0x9e)];console[_0xc6816(0xa9)](_0xc6816(0xb7)+_0x1d0d17+_0xc6816(0xa0));const _0x5ed56f=await database_1[_0xc6816(0x7d)]['payment'][_0xc6816(0xb8)]({'where':{'id':_0x1d0d17},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x5ed56f)return _0x48c38d[_0xc6816(0xab)](0x194)['json']({'error':_0xc6816(0x84)});console[_0xc6816(0xa9)](_0xc6816(0x82)+_0x5ed56f['shop'][_0xc6816(0xa4)]),_0x48c38d[_0xc6816(0xa8)]({'id':_0x5ed56f['id'],'amount':_0x5ed56f['amount'],'currency':_0x5ed56f['currency'],'status':_0x5ed56f[_0xc6816(0xab)],'orderId':_0x5ed56f[_0xc6816(0x96)],'shop':_0x5ed56f[_0xc6816(0xc2)]});}catch(_0x51332e){console[_0xc6816(0x93)](_0xc6816(0x8b),_0x51332e),_0x48c38d[_0xc6816(0xab)](0x1f4)[_0xc6816(0xa8)]({'error':_0xc6816(0xb3)});}}),router[a27_0x5d31ed(0x89)]('/payments/:id/update',verifyInternalApiKey,async(_0x5a7d19,_0xbb9eba)=>{const _0x8e3a73=a27_0x5d31ed;try{const {id:_0x33de2e}=_0x5a7d19[_0x8e3a73(0x9e)],_0x2ad191=_0x5a7d19[_0x8e3a73(0x80)];console['log'](_0x8e3a73(0x9c)+_0x33de2e,_0x2ad191);const _0x4facd9=[_0x8e3a73(0xab),'gateway_payment_id',_0x8e3a73(0xb5),_0x8e3a73(0x7b),'cardLast4',_0x8e3a73(0x7f),_0x8e3a73(0x92),_0x8e3a73(0x87),'paidAt',_0x8e3a73(0xba),_0x8e3a73(0x99)],_0x598851={};for(const [_0x214aab,_0x1ba6ef]of Object[_0x8e3a73(0x9b)](_0x2ad191)){if(_0x4facd9[_0x8e3a73(0x77)](_0x214aab)){let _0x49ae7e=_0x214aab;if(_0x214aab===_0x8e3a73(0x78)||_0x214aab===_0x8e3a73(0xb5))_0x49ae7e=_0x8e3a73(0xb5);else{if(_0x214aab===_0x8e3a73(0x7b)||_0x214aab==='cardLast4')_0x49ae7e=_0x8e3a73(0x9d);else{if(_0x214aab==='payment_method'||_0x214aab===_0x8e3a73(0x92))_0x49ae7e='paymentMethod';else{if(_0x214aab===_0x8e3a73(0x87)||_0x214aab==='paidAt')_0x49ae7e=_0x8e3a73(0xc0);else(_0x214aab==='failure_message'||_0x214aab===_0x8e3a73(0x99))&&(_0x49ae7e=_0x8e3a73(0x99));}}}_0x49ae7e===_0x8e3a73(0xc0)&&typeof _0x1ba6ef===_0x8e3a73(0xa5)?_0x598851[_0x49ae7e]=new Date(_0x1ba6ef):_0x598851[_0x49ae7e]=_0x1ba6ef;}}if(Object[_0x8e3a73(0x83)](_0x598851)['length']===0x0)return _0xbb9eba['status'](0x190)[_0x8e3a73(0xa8)]({'error':'No\x20valid\x20fields\x20to\x20update'});const _0x975f9c=await database_1[_0x8e3a73(0x7d)]['payment'][_0x8e3a73(0xa3)]({'where':{'id':_0x33de2e},'data':_0x598851});console[_0x8e3a73(0xa9)](_0x8e3a73(0x9a)+_0x33de2e+_0x8e3a73(0x72));if(_0x598851['status']===_0x8e3a73(0x8a)){console[_0x8e3a73(0xa9)](_0x8e3a73(0x90)+_0x33de2e+_0x8e3a73(0xb0));try{const {WebhookService:_0x196d4e}=await Promise[_0x8e3a73(0x7e)]()[_0x8e3a73(0xa6)](()=>__importStar(require('../services/webhookService'))),_0x48c2c2=new _0x196d4e(),_0xe3a968=await database_1[_0x8e3a73(0x7d)][_0x8e3a73(0x94)][_0x8e3a73(0xb8)]({'where':{'id':_0x33de2e},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0xe3a968&&console[_0x8e3a73(0xa9)](_0x8e3a73(0x75)+_0x33de2e);}catch(_0x39bbc8){console[_0x8e3a73(0x93)](_0x8e3a73(0x73),_0x39bbc8);}}_0xbb9eba[_0x8e3a73(0xa8)]({'success':!![],'payment':{'id':_0x975f9c['id'],'status':_0x975f9c['status']}});}catch(_0x1b831c){console[_0x8e3a73(0x93)](_0x8e3a73(0xae),_0x1b831c),_0xbb9eba[_0x8e3a73(0xab)](0x1f4)['json']({'error':_0x8e3a73(0xb3)});}}),router[a27_0x5d31ed(0x76)](a27_0x5d31ed(0xa1),(_0x24c221,_0x48d9d3)=>{const _0x24357b=a27_0x5d31ed;_0x48d9d3[_0x24357b(0xa8)]({'status':'ok','timestamp':new Date()[_0x24357b(0xad)]()});}),exports[a27_0x5d31ed(0x7d)]=router;