'use strict';const a32_0x2a37fe=a32_0x203b;(function(_0x449a65,_0x431bef){const _0x59d076=a32_0x203b,_0x44b031=_0x449a65();while(!![]){try{const _0x279594=parseInt(_0x59d076(0x120))/0x1*(parseInt(_0x59d076(0x119))/0x2)+parseInt(_0x59d076(0x12c))/0x3+-parseInt(_0x59d076(0x153))/0x4*(parseInt(_0x59d076(0x152))/0x5)+parseInt(_0x59d076(0x129))/0x6*(parseInt(_0x59d076(0x156))/0x7)+-parseInt(_0x59d076(0x15b))/0x8+parseInt(_0x59d076(0x158))/0x9+parseInt(_0x59d076(0x11c))/0xa*(-parseInt(_0x59d076(0x137))/0xb);if(_0x279594===_0x431bef)break;else _0x44b031['push'](_0x44b031['shift']());}catch(_0x2b9caa){_0x44b031['push'](_0x44b031['shift']());}}}(a32_0x22ce,0x939bb));var __createBinding=this&&this[a32_0x2a37fe(0x131)]||(Object[a32_0x2a37fe(0x15a)]?function(_0xfe69a7,_0x3b5c4b,_0x106540,_0x548496){const _0x50d62a=a32_0x2a37fe;if(_0x548496===undefined)_0x548496=_0x106540;var _0x5f38ed=Object[_0x50d62a(0x112)](_0x3b5c4b,_0x106540);(!_0x5f38ed||(_0x50d62a(0x134)in _0x5f38ed?!_0x3b5c4b['__esModule']:_0x5f38ed[_0x50d62a(0x159)]||_0x5f38ed[_0x50d62a(0x139)]))&&(_0x5f38ed={'enumerable':!![],'get':function(){return _0x3b5c4b[_0x106540];}}),Object['defineProperty'](_0xfe69a7,_0x548496,_0x5f38ed);}:function(_0x16847e,_0x191ad4,_0x314f76,_0x2c45a6){if(_0x2c45a6===undefined)_0x2c45a6=_0x314f76;_0x16847e[_0x2c45a6]=_0x191ad4[_0x314f76];}),__setModuleDefault=this&&this[a32_0x2a37fe(0x144)]||(Object['create']?function(_0x79409e,_0x5b691e){const _0x595ba5=a32_0x2a37fe;Object[_0x595ba5(0x154)](_0x79409e,_0x595ba5(0x149),{'enumerable':!![],'value':_0x5b691e});}:function(_0x201da1,_0x40ff24){const _0x45eed1=a32_0x2a37fe;_0x201da1[_0x45eed1(0x149)]=_0x40ff24;}),__importStar=this&&this[a32_0x2a37fe(0x124)]||(function(){var _0x3ca2ef=function(_0x17c592){const _0x20df26=a32_0x203b;return _0x3ca2ef=Object[_0x20df26(0x12b)]||function(_0x4d73aa){const _0xa0c9eb=_0x20df26;var _0x2e7248=[];for(var _0x158d0c in _0x4d73aa)if(Object[_0xa0c9eb(0x15e)][_0xa0c9eb(0x136)][_0xa0c9eb(0x12d)](_0x4d73aa,_0x158d0c))_0x2e7248[_0x2e7248[_0xa0c9eb(0x11b)]]=_0x158d0c;return _0x2e7248;},_0x3ca2ef(_0x17c592);};return function(_0x4ab53a){const _0x4f510a=a32_0x203b;if(_0x4ab53a&&_0x4ab53a[_0x4f510a(0x14e)])return _0x4ab53a;var _0x3bde40={};if(_0x4ab53a!=null){for(var _0x21c276=_0x3ca2ef(_0x4ab53a),_0x2e8e25=0x0;_0x2e8e25<_0x21c276[_0x4f510a(0x11b)];_0x2e8e25++)if(_0x21c276[_0x2e8e25]!==_0x4f510a(0x149))__createBinding(_0x3bde40,_0x4ab53a,_0x21c276[_0x2e8e25]);}return __setModuleDefault(_0x3bde40,_0x4ab53a),_0x3bde40;};}()),__importDefault=this&&this['__importDefault']||function(_0x4eaff2){const _0x12a158=a32_0x2a37fe;return _0x4eaff2&&_0x4eaff2[_0x12a158(0x14e)]?_0x4eaff2:{'default':_0x4eaff2};};Object[a32_0x2a37fe(0x154)](exports,a32_0x2a37fe(0x14e),{'value':!![]});function a32_0x203b(_0x6a3508,_0x24870c){_0x6a3508=_0x6a3508-0x112;const _0x22cef5=a32_0x22ce();let _0x203b00=_0x22cef5[_0x6a3508];return _0x203b00;}function a32_0x22ce(){const _0x1513da=['error','__setModuleDefault','failure_message','toISOString','string','\x20updated\x20successfully','default','amount','Router','status','ðŸ“¤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','__esModule','paymentMethod','username','express','1926310hpvjtl','4cIteVY','defineProperty','/payments/:id/gateway-settings','7483DYrhbt','paid_at','1552302CTJcqL','writable','create','9005544VsDWMI','resolve','currency','prototype','getOwnPropertyDescriptor','Invalid\x20internal\x20API\x20key','params','card_last4','shop','gateway_payment_id','âœ…\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','2150238hEbYKh','Internal\x20API\x20error\x20getting\x20payment:','length','7272970skCHWm','authorization','/payments/:id/update','log','1PSoYlr','gatewayPaymentId','payment_method','payment','__importStar','substring','ðŸ”\x20Internal\x20API:\x20Getting\x20payment\x20','âœ…\x20Internal\x20API:\x20Payment\x20','paidAt','4098nTwnEw','Internal\x20server\x20error','getOwnPropertyNames','2595393lQFGPu','call','internal-api-key','ðŸŽ‰\x20Payment\x20','entries','__createBinding','failureMessage','cardLast4','get','headers','hasOwnProperty','11MXlgPH','ðŸ”„\x20Internal\x20API:\x20Updating\x20payment\x20','configurable','/health','../services/webhookService','then','Payment\x20not\x20found','json','Error\x20sending\x20webhook\x20notification:','Missing\x20or\x20invalid\x20authorization\x20header','update','PAID'];a32_0x22ce=function(){return _0x1513da;};return a32_0x22ce();}const express_1=require(a32_0x2a37fe(0x151)),database_1=__importDefault(require('../config/database')),router=(0x0,express_1[a32_0x2a37fe(0x14b)])(),verifyInternalApiKey=(_0x4fbe5b,_0x5f008e,_0xad1f7c)=>{const _0x329d05=a32_0x2a37fe,_0x508a00=_0x4fbe5b[_0x329d05(0x135)][_0x329d05(0x11d)];if(!_0x508a00||!_0x508a00['startsWith']('Bearer\x20'))return _0x5f008e['status'](0x191)['json']({'error':_0x329d05(0x140)});const _0x3fcb63=_0x508a00[_0x329d05(0x125)](0x7);if(_0x3fcb63!==_0x329d05(0x12e))return _0x5f008e[_0x329d05(0x14c)](0x191)[_0x329d05(0x13e)]({'error':_0x329d05(0x113)});_0xad1f7c();};router[a32_0x2a37fe(0x134)](a32_0x2a37fe(0x155),verifyInternalApiKey,async(_0x1fc3f0,_0x56db25)=>{const _0x41bbfa=a32_0x2a37fe;try{const {id:_0x1df642}=_0x1fc3f0[_0x41bbfa(0x114)];console[_0x41bbfa(0x11f)](_0x41bbfa(0x126)+_0x1df642+'\x20with\x20gateway\x20settings');const _0x485267=await database_1['default'][_0x41bbfa(0x123)]['findUnique']({'where':{'id':_0x1df642},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x485267)return _0x56db25[_0x41bbfa(0x14c)](0x194)[_0x41bbfa(0x13e)]({'error':_0x41bbfa(0x13d)});console['log'](_0x41bbfa(0x118)+_0x485267['shop'][_0x41bbfa(0x150)]),_0x56db25[_0x41bbfa(0x13e)]({'id':_0x485267['id'],'amount':_0x485267[_0x41bbfa(0x14a)],'currency':_0x485267[_0x41bbfa(0x15d)],'status':_0x485267[_0x41bbfa(0x14c)],'orderId':_0x485267['orderId'],'shop':_0x485267[_0x41bbfa(0x116)]});}catch(_0x3ef708){console[_0x41bbfa(0x143)](_0x41bbfa(0x11a),_0x3ef708),_0x56db25[_0x41bbfa(0x14c)](0x1f4)[_0x41bbfa(0x13e)]({'error':_0x41bbfa(0x12a)});}}),router['patch'](a32_0x2a37fe(0x11e),verifyInternalApiKey,async(_0x42c399,_0x10f252)=>{const _0xe500e3=a32_0x2a37fe;try{const {id:_0x1e3393}=_0x42c399[_0xe500e3(0x114)],_0xeeef1=_0x42c399['body'];console[_0xe500e3(0x11f)](_0xe500e3(0x138)+_0x1e3393,_0xeeef1);const _0x21252e=[_0xe500e3(0x14c),_0xe500e3(0x117),'gatewayPaymentId',_0xe500e3(0x115),'cardLast4',_0xe500e3(0x122),_0xe500e3(0x14f),_0xe500e3(0x157),_0xe500e3(0x128),_0xe500e3(0x145),_0xe500e3(0x132)],_0x387665={};for(const [_0x53660f,_0x134dfb]of Object[_0xe500e3(0x130)](_0xeeef1)){if(_0x21252e['includes'](_0x53660f)){let _0x5c76b1=_0x53660f;if(_0x53660f===_0xe500e3(0x117)||_0x53660f==='gatewayPaymentId')_0x5c76b1=_0xe500e3(0x121);else{if(_0x53660f==='card_last4'||_0x53660f==='cardLast4')_0x5c76b1=_0xe500e3(0x133);else{if(_0x53660f===_0xe500e3(0x122)||_0x53660f==='paymentMethod')_0x5c76b1=_0xe500e3(0x14f);else{if(_0x53660f==='paid_at'||_0x53660f===_0xe500e3(0x128))_0x5c76b1=_0xe500e3(0x128);else(_0x53660f===_0xe500e3(0x145)||_0x53660f===_0xe500e3(0x132))&&(_0x5c76b1=_0xe500e3(0x132));}}}_0x5c76b1==='paidAt'&&typeof _0x134dfb===_0xe500e3(0x147)?_0x387665[_0x5c76b1]=new Date(_0x134dfb):_0x387665[_0x5c76b1]=_0x134dfb;}}if(Object['keys'](_0x387665)[_0xe500e3(0x11b)]===0x0)return _0x10f252[_0xe500e3(0x14c)](0x190)['json']({'error':'No\x20valid\x20fields\x20to\x20update'});const _0x13de86=await database_1[_0xe500e3(0x149)]['payment'][_0xe500e3(0x141)]({'where':{'id':_0x1e3393},'data':_0x387665});console['log'](_0xe500e3(0x127)+_0x1e3393+_0xe500e3(0x148));if(_0x387665[_0xe500e3(0x14c)]===_0xe500e3(0x142)){console['log'](_0xe500e3(0x12f)+_0x1e3393+'\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing');try{const {WebhookService:_0x1d9d06}=await Promise[_0xe500e3(0x15c)]()[_0xe500e3(0x13c)](()=>__importStar(require(_0xe500e3(0x13b)))),_0x347d3d=new _0x1d9d06(),_0x41fcfb=await database_1[_0xe500e3(0x149)][_0xe500e3(0x123)]['findUnique']({'where':{'id':_0x1e3393},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x41fcfb&&console['log'](_0xe500e3(0x14d)+_0x1e3393);}catch(_0x350231){console['error'](_0xe500e3(0x13f),_0x350231);}}_0x10f252[_0xe500e3(0x13e)]({'success':!![],'payment':{'id':_0x13de86['id'],'status':_0x13de86[_0xe500e3(0x14c)]}});}catch(_0x5ad897){console[_0xe500e3(0x143)]('Internal\x20API\x20error\x20updating\x20payment:',_0x5ad897),_0x10f252[_0xe500e3(0x14c)](0x1f4)[_0xe500e3(0x13e)]({'error':_0xe500e3(0x12a)});}}),router[a32_0x2a37fe(0x134)](a32_0x2a37fe(0x13a),(_0x2370ad,_0x175268)=>{const _0x136752=a32_0x2a37fe;_0x175268[_0x136752(0x13e)]({'status':'ok','timestamp':new Date()[_0x136752(0x146)]()});}),exports[a32_0x2a37fe(0x149)]=router;