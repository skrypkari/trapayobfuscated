'use strict';const a27_0x15f7ab=a27_0xdffd;(function(_0x151f4c,_0x1034a3){const _0x3cbef9=a27_0xdffd,_0xb7388d=_0x151f4c();while(!![]){try{const _0x1623b5=-parseInt(_0x3cbef9(0x137))/0x1*(-parseInt(_0x3cbef9(0x158))/0x2)+parseInt(_0x3cbef9(0x10e))/0x3*(parseInt(_0x3cbef9(0x14d))/0x4)+parseInt(_0x3cbef9(0x10f))/0x5*(-parseInt(_0x3cbef9(0x15c))/0x6)+parseInt(_0x3cbef9(0x138))/0x7+-parseInt(_0x3cbef9(0x114))/0x8+parseInt(_0x3cbef9(0x14b))/0x9*(parseInt(_0x3cbef9(0x116))/0xa)+-parseInt(_0x3cbef9(0x113))/0xb;if(_0x1623b5===_0x1034a3)break;else _0xb7388d['push'](_0xb7388d['shift']());}catch(_0xbd3837){_0xb7388d['push'](_0xb7388d['shift']());}}}(a27_0x24f2,0x3eb02));function a27_0xdffd(_0x339853,_0x19218c){const _0x24f25d=a27_0x24f2();return a27_0xdffd=function(_0xdffdd2,_0x7c5dcd){_0xdffdd2=_0xdffdd2-0x10b;let _0x37c408=_0x24f25d[_0xdffdd2];return _0x37c408;},a27_0xdffd(_0x339853,_0x19218c);}var __createBinding=this&&this[a27_0x15f7ab(0x15b)]||(Object['create']?function(_0x62d26,_0x272aa5,_0xe49738,_0x253ddf){const _0x544ec=a27_0x15f7ab;if(_0x253ddf===undefined)_0x253ddf=_0xe49738;var _0x566b1a=Object['getOwnPropertyDescriptor'](_0x272aa5,_0xe49738);(!_0x566b1a||('get'in _0x566b1a?!_0x272aa5[_0x544ec(0x13a)]:_0x566b1a[_0x544ec(0x125)]||_0x566b1a[_0x544ec(0x130)]))&&(_0x566b1a={'enumerable':!![],'get':function(){return _0x272aa5[_0xe49738];}}),Object[_0x544ec(0x10d)](_0x62d26,_0x253ddf,_0x566b1a);}:function(_0x5d0659,_0x3dc3ab,_0x23fc74,_0x3f98e4){if(_0x3f98e4===undefined)_0x3f98e4=_0x23fc74;_0x5d0659[_0x3f98e4]=_0x3dc3ab[_0x23fc74];}),__setModuleDefault=this&&this[a27_0x15f7ab(0x112)]||(Object[a27_0x15f7ab(0x13c)]?function(_0x3b9cb7,_0x5365a7){const _0x1a8620=a27_0x15f7ab;Object[_0x1a8620(0x10d)](_0x3b9cb7,'default',{'enumerable':!![],'value':_0x5365a7});}:function(_0x1fabdc,_0x5af04c){_0x1fabdc['default']=_0x5af04c;}),__importStar=this&&this[a27_0x15f7ab(0x140)]||(function(){var _0x507ac1=function(_0xe41fe){const _0xe44c12=a27_0xdffd;return _0x507ac1=Object[_0xe44c12(0x145)]||function(_0x28d942){const _0x3c5afd=_0xe44c12;var _0x413a22=[];for(var _0x3072c8 in _0x28d942)if(Object[_0x3c5afd(0x131)][_0x3c5afd(0x12d)][_0x3c5afd(0x129)](_0x28d942,_0x3072c8))_0x413a22[_0x413a22[_0x3c5afd(0x14a)]]=_0x3072c8;return _0x413a22;},_0x507ac1(_0xe41fe);};return function(_0x296f6e){const _0x2616a6=a27_0xdffd;if(_0x296f6e&&_0x296f6e['__esModule'])return _0x296f6e;var _0x2f14b5={};if(_0x296f6e!=null){for(var _0x31ac3e=_0x507ac1(_0x296f6e),_0x55110c=0x0;_0x55110c<_0x31ac3e[_0x2616a6(0x14a)];_0x55110c++)if(_0x31ac3e[_0x55110c]!==_0x2616a6(0x11b))__createBinding(_0x2f14b5,_0x296f6e,_0x31ac3e[_0x55110c]);}return __setModuleDefault(_0x2f14b5,_0x296f6e),_0x2f14b5;};}()),__importDefault=this&&this[a27_0x15f7ab(0x123)]||function(_0x2db108){const _0x4b0aea=a27_0x15f7ab;return _0x2db108&&_0x2db108[_0x4b0aea(0x13a)]?_0x2db108:{'default':_0x2db108};};Object[a27_0x15f7ab(0x10d)](exports,a27_0x15f7ab(0x13a),{'value':!![]});function a27_0x24f2(){const _0x5bd556=['3663iEtVEk','update','92804SwkPra','substring','../config/database','card_last4','json','amount','paymentMethod','shop','✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','\x20updated\x20successfully','\x20with\x20gateway\x20settings','82828MzjAtW','Router','internal-api-key','__createBinding','310878kZAhuP','resolve','Invalid\x20internal\x20API\x20key','/health','Internal\x20server\x20error','defineProperty','63KTspen','25ZrLxZY','startsWith','includes','__setModuleDefault','9530939AzKFrd','74232oDJRsX','currency','210NHgEpp','express','📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','🎉\x20Payment\x20','payment_method','default','🔍\x20Internal\x20API:\x20Getting\x20payment\x20','toISOString','gatewayPaymentId','orderId','username','params','patch','__importDefault','authorization','writable','gateway_payment_id','cardLast4','keys','call','🔄\x20Internal\x20API:\x20Updating\x20payment\x20','get','failure_message','hasOwnProperty','status','paidAt','configurable','prototype','error','string','/payments/:id/update','Bearer\x20','headers','10hXdgdl','3371585RmHipU','PAID','__esModule','log','create','../services/webhookService','Internal\x20API\x20error\x20updating\x20payment:','Internal\x20API\x20error\x20getting\x20payment:','__importStar','payment','then','paid_at','failureMessage','getOwnPropertyNames','No\x20valid\x20fields\x20to\x20update','/payments/:id/gateway-settings','Payment\x20not\x20found','findUnique','length'];a27_0x24f2=function(){return _0x5bd556;};return a27_0x24f2();}const express_1=require(a27_0x15f7ab(0x117)),database_1=__importDefault(require(a27_0x15f7ab(0x14f))),router=(0x0,express_1[a27_0x15f7ab(0x159)])(),verifyInternalApiKey=(_0x210310,_0x43f4f5,_0xcab13a)=>{const _0x2239a5=a27_0x15f7ab,_0x2cb91c=_0x210310[_0x2239a5(0x136)][_0x2239a5(0x124)];if(!_0x2cb91c||!_0x2cb91c[_0x2239a5(0x110)](_0x2239a5(0x135)))return _0x43f4f5[_0x2239a5(0x12e)](0x191)[_0x2239a5(0x151)]({'error':'Missing\x20or\x20invalid\x20authorization\x20header'});const _0x3ac5f1=_0x2cb91c[_0x2239a5(0x14e)](0x7);if(_0x3ac5f1!==_0x2239a5(0x15a))return _0x43f4f5[_0x2239a5(0x12e)](0x191)['json']({'error':_0x2239a5(0x15e)});_0xcab13a();};router[a27_0x15f7ab(0x12b)](a27_0x15f7ab(0x147),verifyInternalApiKey,async(_0x47015b,_0x2ecdc2)=>{const _0x3aa5e=a27_0x15f7ab;try{const {id:_0x1f3404}=_0x47015b['params'];console[_0x3aa5e(0x13b)](_0x3aa5e(0x11c)+_0x1f3404+_0x3aa5e(0x157));const _0x3f388e=await database_1[_0x3aa5e(0x11b)]['payment'][_0x3aa5e(0x149)]({'where':{'id':_0x1f3404},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x3f388e)return _0x2ecdc2[_0x3aa5e(0x12e)](0x194)['json']({'error':_0x3aa5e(0x148)});console[_0x3aa5e(0x13b)](_0x3aa5e(0x155)+_0x3f388e[_0x3aa5e(0x154)][_0x3aa5e(0x120)]),_0x2ecdc2[_0x3aa5e(0x151)]({'id':_0x3f388e['id'],'amount':_0x3f388e[_0x3aa5e(0x152)],'currency':_0x3f388e[_0x3aa5e(0x115)],'status':_0x3f388e['status'],'orderId':_0x3f388e[_0x3aa5e(0x11f)],'shop':_0x3f388e[_0x3aa5e(0x154)]});}catch(_0x133601){console['error'](_0x3aa5e(0x13f),_0x133601),_0x2ecdc2[_0x3aa5e(0x12e)](0x1f4)[_0x3aa5e(0x151)]({'error':_0x3aa5e(0x10c)});}}),router[a27_0x15f7ab(0x122)](a27_0x15f7ab(0x134),verifyInternalApiKey,async(_0x2c812b,_0x3a2923)=>{const _0x58f4ed=a27_0x15f7ab;try{const {id:_0x3e8568}=_0x2c812b[_0x58f4ed(0x121)],_0x5445d4=_0x2c812b['body'];console[_0x58f4ed(0x13b)](_0x58f4ed(0x12a)+_0x3e8568,_0x5445d4);const _0x3de923=[_0x58f4ed(0x12e),_0x58f4ed(0x126),'gatewayPaymentId','card_last4',_0x58f4ed(0x127),_0x58f4ed(0x11a),'paymentMethod',_0x58f4ed(0x143),'paidAt',_0x58f4ed(0x12c),'failureMessage'],_0x2b6ec5={};for(const [_0x2701e0,_0x61abe0]of Object['entries'](_0x5445d4)){if(_0x3de923[_0x58f4ed(0x111)](_0x2701e0)){let _0x13f581=_0x2701e0;if(_0x2701e0===_0x58f4ed(0x126)||_0x2701e0==='gatewayPaymentId')_0x13f581=_0x58f4ed(0x11e);else{if(_0x2701e0===_0x58f4ed(0x150)||_0x2701e0==='cardLast4')_0x13f581=_0x58f4ed(0x127);else{if(_0x2701e0===_0x58f4ed(0x11a)||_0x2701e0==='paymentMethod')_0x13f581=_0x58f4ed(0x153);else{if(_0x2701e0===_0x58f4ed(0x143)||_0x2701e0===_0x58f4ed(0x12f))_0x13f581=_0x58f4ed(0x12f);else(_0x2701e0===_0x58f4ed(0x12c)||_0x2701e0===_0x58f4ed(0x144))&&(_0x13f581=_0x58f4ed(0x144));}}}_0x13f581===_0x58f4ed(0x12f)&&typeof _0x61abe0===_0x58f4ed(0x133)?_0x2b6ec5[_0x13f581]=new Date(_0x61abe0):_0x2b6ec5[_0x13f581]=_0x61abe0;}}if(Object[_0x58f4ed(0x128)](_0x2b6ec5)[_0x58f4ed(0x14a)]===0x0)return _0x3a2923['status'](0x190)[_0x58f4ed(0x151)]({'error':_0x58f4ed(0x146)});const _0x449590=await database_1['default'][_0x58f4ed(0x141)][_0x58f4ed(0x14c)]({'where':{'id':_0x3e8568},'data':_0x2b6ec5});console[_0x58f4ed(0x13b)]('✅\x20Internal\x20API:\x20Payment\x20'+_0x3e8568+_0x58f4ed(0x156));if(_0x2b6ec5['status']===_0x58f4ed(0x139)){console['log'](_0x58f4ed(0x119)+_0x3e8568+'\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing');try{const {WebhookService:_0x550b22}=await Promise[_0x58f4ed(0x15d)]()[_0x58f4ed(0x142)](()=>__importStar(require(_0x58f4ed(0x13d)))),_0x22ac57=new _0x550b22(),_0x335a7a=await database_1[_0x58f4ed(0x11b)][_0x58f4ed(0x141)][_0x58f4ed(0x149)]({'where':{'id':_0x3e8568},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x335a7a&&console[_0x58f4ed(0x13b)](_0x58f4ed(0x118)+_0x3e8568);}catch(_0x495513){console[_0x58f4ed(0x132)]('Error\x20sending\x20webhook\x20notification:',_0x495513);}}_0x3a2923[_0x58f4ed(0x151)]({'success':!![],'payment':{'id':_0x449590['id'],'status':_0x449590[_0x58f4ed(0x12e)]}});}catch(_0x15b3ad){console[_0x58f4ed(0x132)](_0x58f4ed(0x13e),_0x15b3ad),_0x3a2923['status'](0x1f4)[_0x58f4ed(0x151)]({'error':_0x58f4ed(0x10c)});}}),router['get'](a27_0x15f7ab(0x10b),(_0x176314,_0x3216c3)=>{const _0x52e337=a27_0x15f7ab;_0x3216c3['json']({'status':'ok','timestamp':new Date()[_0x52e337(0x11d)]()});}),exports['default']=router;