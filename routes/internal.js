'use strict';function a25_0x37f7(){const _0x1b1dcb=['9oTmPBa','Router','length','failure_message','Internal\x20API\x20error\x20updating\x20payment:','update','findUnique','configurable','PAID','🎉\x20Payment\x20','authorization','body','failureMessage','username','getOwnPropertyNames','card_last4','default','shop','amount','patch','then','__esModule','Payment\x20not\x20found','paid_at','gatewayPaymentId','✅\x20Internal\x20API:\x20Payment\x20','/payments/:id/gateway-settings','Missing\x20or\x20invalid\x20authorization\x20header','18UWyOmH','startsWith','keys','__setModuleDefault','payment_method','✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','params','cardLast4','Bearer\x20','2127732IKXCZR','substring','get','Internal\x20server\x20error','currency','488033tjnKPs','\x20with\x20gateway\x20settings','Invalid\x20internal\x20API\x20key','gateway_payment_id','status','writable','orderId','1308VfLumF','12332700gBzPqF','string','143BQggut','__importStar','Error\x20sending\x20webhook\x20notification:','📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','Internal\x20API\x20error\x20getting\x20payment:','error','paymentMethod','\x20updated\x20successfully','headers','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','defineProperty','968645iLaTIV','internal-api-key','../services/webhookService','/payments/:id/update','No\x20valid\x20fields\x20to\x20update','🔄\x20Internal\x20API:\x20Updating\x20payment\x20','paidAt','json','log','1374927mEoPLI','6681SjyUgC','32GJOkYm','2933142sXBBVv','toISOString'];a25_0x37f7=function(){return _0x1b1dcb;};return a25_0x37f7();}const a25_0x1b0504=a25_0x4285;(function(_0x1e1d9c,_0x53224b){const _0x25746f=a25_0x4285,_0x26b8dc=_0x1e1d9c();while(!![]){try{const _0x334fa8=-parseInt(_0x25746f(0x1a0))/0x1+parseInt(_0x25746f(0x1a3))/0x2+parseInt(_0x25746f(0x1a1))/0x3*(-parseInt(_0x25746f(0x189))/0x4)+parseInt(_0x25746f(0x197))/0x5*(parseInt(_0x25746f(0x174))/0x6)+parseInt(_0x25746f(0x182))/0x7*(-parseInt(_0x25746f(0x1a2))/0x8)+parseInt(_0x25746f(0x1a5))/0x9*(-parseInt(_0x25746f(0x18a))/0xa)+parseInt(_0x25746f(0x18c))/0xb*(parseInt(_0x25746f(0x17d))/0xc);if(_0x334fa8===_0x53224b)break;else _0x26b8dc['push'](_0x26b8dc['shift']());}catch(_0x23af1b){_0x26b8dc['push'](_0x26b8dc['shift']());}}}(a25_0x37f7,0xb40db));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x634f8a,_0x26e6df,_0x3baf9f,_0x35e624){const _0xae9191=a25_0x4285;if(_0x35e624===undefined)_0x35e624=_0x3baf9f;var _0x38ef33=Object['getOwnPropertyDescriptor'](_0x26e6df,_0x3baf9f);(!_0x38ef33||(_0xae9191(0x17f)in _0x38ef33?!_0x26e6df[_0xae9191(0x1ba)]:_0x38ef33[_0xae9191(0x187)]||_0x38ef33[_0xae9191(0x1ac)]))&&(_0x38ef33={'enumerable':!![],'get':function(){return _0x26e6df[_0x3baf9f];}}),Object['defineProperty'](_0x634f8a,_0x35e624,_0x38ef33);}:function(_0x4a6f11,_0x3cfafc,_0x1d43e9,_0x18719f){if(_0x18719f===undefined)_0x18719f=_0x1d43e9;_0x4a6f11[_0x18719f]=_0x3cfafc[_0x1d43e9];}),__setModuleDefault=this&&this[a25_0x1b0504(0x177)]||(Object['create']?function(_0x42f721,_0x163411){const _0x57cb31=a25_0x1b0504;Object[_0x57cb31(0x196)](_0x42f721,_0x57cb31(0x1b5),{'enumerable':!![],'value':_0x163411});}:function(_0x4030f7,_0x3a1dfb){const _0x597903=a25_0x1b0504;_0x4030f7[_0x597903(0x1b5)]=_0x3a1dfb;}),__importStar=this&&this[a25_0x1b0504(0x18d)]||(function(){var _0x586ec9=function(_0x36159f){const _0x1c6d3b=a25_0x4285;return _0x586ec9=Object[_0x1c6d3b(0x1b3)]||function(_0xa45fc){const _0x3bf6a3=_0x1c6d3b;var _0x4d34ca=[];for(var _0x4daf0 in _0xa45fc)if(Object['prototype']['hasOwnProperty']['call'](_0xa45fc,_0x4daf0))_0x4d34ca[_0x4d34ca[_0x3bf6a3(0x1a7)]]=_0x4daf0;return _0x4d34ca;},_0x586ec9(_0x36159f);};return function(_0x566c27){const _0x4e12eb=a25_0x4285;if(_0x566c27&&_0x566c27[_0x4e12eb(0x1ba)])return _0x566c27;var _0xd960ca={};if(_0x566c27!=null){for(var _0x233be6=_0x586ec9(_0x566c27),_0x493278=0x0;_0x493278<_0x233be6['length'];_0x493278++)if(_0x233be6[_0x493278]!==_0x4e12eb(0x1b5))__createBinding(_0xd960ca,_0x566c27,_0x233be6[_0x493278]);}return __setModuleDefault(_0xd960ca,_0x566c27),_0xd960ca;};}()),__importDefault=this&&this['__importDefault']||function(_0x240fbd){const _0x11fc98=a25_0x1b0504;return _0x240fbd&&_0x240fbd[_0x11fc98(0x1ba)]?_0x240fbd:{'default':_0x240fbd};};function a25_0x4285(_0x27ca0c,_0x1fed61){const _0x37f707=a25_0x37f7();return a25_0x4285=function(_0x428545,_0x500567){_0x428545=_0x428545-0x16f;let _0x4184a4=_0x37f707[_0x428545];return _0x4184a4;},a25_0x4285(_0x27ca0c,_0x1fed61);}Object[a25_0x1b0504(0x196)](exports,a25_0x1b0504(0x1ba),{'value':!![]});const express_1=require('express'),database_1=__importDefault(require('../config/database')),router=(0x0,express_1[a25_0x1b0504(0x1a6)])(),verifyInternalApiKey=(_0x49471b,_0x56b882,_0x3775a1)=>{const _0x281d6e=a25_0x1b0504,_0x1e9836=_0x49471b[_0x281d6e(0x194)][_0x281d6e(0x1af)];if(!_0x1e9836||!_0x1e9836[_0x281d6e(0x175)](_0x281d6e(0x17c)))return _0x56b882[_0x281d6e(0x186)](0x191)[_0x281d6e(0x19e)]({'error':_0x281d6e(0x173)});const _0x361f94=_0x1e9836[_0x281d6e(0x17e)](0x7);if(_0x361f94!==_0x281d6e(0x198))return _0x56b882[_0x281d6e(0x186)](0x191)[_0x281d6e(0x19e)]({'error':_0x281d6e(0x184)});_0x3775a1();};router[a25_0x1b0504(0x17f)](a25_0x1b0504(0x172),verifyInternalApiKey,async(_0x4befc1,_0x12013e)=>{const _0x2677c8=a25_0x1b0504;try{const {id:_0x473e20}=_0x4befc1[_0x2677c8(0x17a)];console[_0x2677c8(0x19f)]('🔍\x20Internal\x20API:\x20Getting\x20payment\x20'+_0x473e20+_0x2677c8(0x183));const _0x637d00=await database_1[_0x2677c8(0x1b5)]['payment'][_0x2677c8(0x1ab)]({'where':{'id':_0x473e20},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x637d00)return _0x12013e[_0x2677c8(0x186)](0x194)[_0x2677c8(0x19e)]({'error':_0x2677c8(0x1bb)});console[_0x2677c8(0x19f)](_0x2677c8(0x179)+_0x637d00[_0x2677c8(0x1b6)][_0x2677c8(0x1b2)]),_0x12013e[_0x2677c8(0x19e)]({'id':_0x637d00['id'],'amount':_0x637d00[_0x2677c8(0x1b7)],'currency':_0x637d00[_0x2677c8(0x181)],'status':_0x637d00['status'],'orderId':_0x637d00[_0x2677c8(0x188)],'shop':_0x637d00[_0x2677c8(0x1b6)]});}catch(_0x302036){console[_0x2677c8(0x191)](_0x2677c8(0x190),_0x302036),_0x12013e[_0x2677c8(0x186)](0x1f4)[_0x2677c8(0x19e)]({'error':'Internal\x20server\x20error'});}}),router[a25_0x1b0504(0x1b8)](a25_0x1b0504(0x19a),verifyInternalApiKey,async(_0x31ec49,_0x4ffdf1)=>{const _0x18263b=a25_0x1b0504;try{const {id:_0x4f8af8}=_0x31ec49['params'],_0x747634=_0x31ec49[_0x18263b(0x1b0)];console[_0x18263b(0x19f)](_0x18263b(0x19c)+_0x4f8af8,_0x747634);const _0x116ea5=[_0x18263b(0x186),_0x18263b(0x185),_0x18263b(0x170),'card_last4',_0x18263b(0x17b),_0x18263b(0x178),'paymentMethod',_0x18263b(0x16f),_0x18263b(0x19d),_0x18263b(0x1a8),'failureMessage'],_0x4a4e28={};for(const [_0x1873fd,_0x29561b]of Object['entries'](_0x747634)){if(_0x116ea5['includes'](_0x1873fd)){let _0x38d550=_0x1873fd;if(_0x1873fd===_0x18263b(0x185)||_0x1873fd===_0x18263b(0x170))_0x38d550=_0x18263b(0x170);else{if(_0x1873fd===_0x18263b(0x1b4)||_0x1873fd===_0x18263b(0x17b))_0x38d550=_0x18263b(0x17b);else{if(_0x1873fd===_0x18263b(0x178)||_0x1873fd===_0x18263b(0x192))_0x38d550=_0x18263b(0x192);else{if(_0x1873fd===_0x18263b(0x16f)||_0x1873fd==='paidAt')_0x38d550='paidAt';else(_0x1873fd==='failure_message'||_0x1873fd===_0x18263b(0x1b1))&&(_0x38d550=_0x18263b(0x1b1));}}}_0x38d550===_0x18263b(0x19d)&&typeof _0x29561b===_0x18263b(0x18b)?_0x4a4e28[_0x38d550]=new Date(_0x29561b):_0x4a4e28[_0x38d550]=_0x29561b;}}if(Object[_0x18263b(0x176)](_0x4a4e28)[_0x18263b(0x1a7)]===0x0)return _0x4ffdf1['status'](0x190)['json']({'error':_0x18263b(0x19b)});const _0x456112=await database_1[_0x18263b(0x1b5)]['payment'][_0x18263b(0x1aa)]({'where':{'id':_0x4f8af8},'data':_0x4a4e28});console[_0x18263b(0x19f)](_0x18263b(0x171)+_0x4f8af8+_0x18263b(0x193));if(_0x4a4e28['status']===_0x18263b(0x1ad)){console[_0x18263b(0x19f)](_0x18263b(0x1ae)+_0x4f8af8+_0x18263b(0x195));try{const {WebhookService:_0x14bf45}=await Promise['resolve']()[_0x18263b(0x1b9)](()=>__importStar(require(_0x18263b(0x199)))),_0x13b394=new _0x14bf45(),_0x35f140=await database_1['default']['payment'][_0x18263b(0x1ab)]({'where':{'id':_0x4f8af8},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x35f140&&console[_0x18263b(0x19f)](_0x18263b(0x18f)+_0x4f8af8);}catch(_0x23a082){console[_0x18263b(0x191)](_0x18263b(0x18e),_0x23a082);}}_0x4ffdf1[_0x18263b(0x19e)]({'success':!![],'payment':{'id':_0x456112['id'],'status':_0x456112['status']}});}catch(_0x2b15bc){console[_0x18263b(0x191)](_0x18263b(0x1a9),_0x2b15bc),_0x4ffdf1[_0x18263b(0x186)](0x1f4)[_0x18263b(0x19e)]({'error':_0x18263b(0x180)});}}),router[a25_0x1b0504(0x17f)]('/health',(_0x350660,_0x441b81)=>{const _0x40e679=a25_0x1b0504;_0x441b81[_0x40e679(0x19e)]({'status':'ok','timestamp':new Date()[_0x40e679(0x1a4)]()});}),exports[a25_0x1b0504(0x1b5)]=router;