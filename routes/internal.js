'use strict';const a27_0x349706=a27_0x1bbf;(function(_0x13f573,_0x2e1e56){const _0x373809=a27_0x1bbf,_0x88d670=_0x13f573();while(!![]){try{const _0x5f3d40=-parseInt(_0x373809(0x119))/0x1*(-parseInt(_0x373809(0x14a))/0x2)+-parseInt(_0x373809(0x13d))/0x3+parseInt(_0x373809(0x11f))/0x4*(-parseInt(_0x373809(0x147))/0x5)+parseInt(_0x373809(0x134))/0x6+parseInt(_0x373809(0x137))/0x7*(parseInt(_0x373809(0x10d))/0x8)+parseInt(_0x373809(0x136))/0x9*(parseInt(_0x373809(0x121))/0xa)+parseInt(_0x373809(0x118))/0xb*(-parseInt(_0x373809(0x126))/0xc);if(_0x5f3d40===_0x2e1e56)break;else _0x88d670['push'](_0x88d670['shift']());}catch(_0x5f07eb){_0x88d670['push'](_0x88d670['shift']());}}}(a27_0x2308,0x505ef));function a27_0x1bbf(_0xb61cec,_0x11cc03){const _0x23082e=a27_0x2308();return a27_0x1bbf=function(_0x1bbf75,_0x358f05){_0x1bbf75=_0x1bbf75-0x109;let _0x4de6e7=_0x23082e[_0x1bbf75];return _0x4de6e7;},a27_0x1bbf(_0xb61cec,_0x11cc03);}var __createBinding=this&&this[a27_0x349706(0x116)]||(Object[a27_0x349706(0x112)]?function(_0x59a7e4,_0x1f93a6,_0x88bc1a,_0x2fe34d){const _0x2643f2=a27_0x349706;if(_0x2fe34d===undefined)_0x2fe34d=_0x88bc1a;var _0x5e0229=Object[_0x2643f2(0x12b)](_0x1f93a6,_0x88bc1a);(!_0x5e0229||(_0x2643f2(0x115)in _0x5e0229?!_0x1f93a6[_0x2643f2(0x124)]:_0x5e0229[_0x2643f2(0x10a)]||_0x5e0229['configurable']))&&(_0x5e0229={'enumerable':!![],'get':function(){return _0x1f93a6[_0x88bc1a];}}),Object[_0x2643f2(0x10b)](_0x59a7e4,_0x2fe34d,_0x5e0229);}:function(_0x4ee077,_0x36fb39,_0x3fd8d9,_0x15483a){if(_0x15483a===undefined)_0x15483a=_0x3fd8d9;_0x4ee077[_0x15483a]=_0x36fb39[_0x3fd8d9];}),__setModuleDefault=this&&this[a27_0x349706(0x13a)]||(Object[a27_0x349706(0x112)]?function(_0x5317eb,_0x2589d2){const _0x448823=a27_0x349706;Object[_0x448823(0x10b)](_0x5317eb,_0x448823(0x131),{'enumerable':!![],'value':_0x2589d2});}:function(_0x1237df,_0x55f747){const _0x538e1c=a27_0x349706;_0x1237df[_0x538e1c(0x131)]=_0x55f747;}),__importStar=this&&this[a27_0x349706(0x13c)]||(function(){var _0x16a2af=function(_0x25ab31){const _0x24e512=a27_0x1bbf;return _0x16a2af=Object[_0x24e512(0x150)]||function(_0x1a1546){const _0x3625c9=_0x24e512;var _0x57a2fd=[];for(var _0x31ed44 in _0x1a1546)if(Object[_0x3625c9(0x148)][_0x3625c9(0x12c)]['call'](_0x1a1546,_0x31ed44))_0x57a2fd[_0x57a2fd[_0x3625c9(0x12f)]]=_0x31ed44;return _0x57a2fd;},_0x16a2af(_0x25ab31);};return function(_0xd28aac){const _0x2df2dd=a27_0x1bbf;if(_0xd28aac&&_0xd28aac['__esModule'])return _0xd28aac;var _0x4533b1={};if(_0xd28aac!=null){for(var _0x5d937d=_0x16a2af(_0xd28aac),_0x6777b=0x0;_0x6777b<_0x5d937d[_0x2df2dd(0x12f)];_0x6777b++)if(_0x5d937d[_0x6777b]!==_0x2df2dd(0x131))__createBinding(_0x4533b1,_0xd28aac,_0x5d937d[_0x6777b]);}return __setModuleDefault(_0x4533b1,_0xd28aac),_0x4533b1;};}()),__importDefault=this&&this[a27_0x349706(0x128)]||function(_0x401ec9){const _0x38b061=a27_0x349706;return _0x401ec9&&_0x401ec9[_0x38b061(0x124)]?_0x401ec9:{'default':_0x401ec9};};function a27_0x2308(){const _0x4a0072=['card_last4','toISOString','paymentMethod','then','writable','defineProperty','shop','68840kwKldt','✅\x20Internal\x20API:\x20Payment\x20','findUnique','substring','payment_method','create','\x20with\x20gateway\x20settings','Missing\x20or\x20invalid\x20authorization\x20header','get','__createBinding','🎉\x20Payment\x20','495FJqtcn','6449ftPMyU','/health','Error\x20sending\x20webhook\x20notification:','json','Internal\x20server\x20error','log','1590724YolrSy','error','710xOabgU','gatewayPaymentId','gateway_payment_id','__esModule','🔍\x20Internal\x20API:\x20Getting\x20payment\x20','101592PULiva','entries','__importDefault','patch','username','getOwnPropertyDescriptor','hasOwnProperty','status','cardLast4','length','paid_at','default','No\x20valid\x20fields\x20to\x20update','📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','3446622FscsYN','paidAt','31959CoagXm','301jhKnRh','authorization','payment','__setModuleDefault','failure_message','__importStar','885273EHgzUP','/payments/:id/update','/payments/:id/gateway-settings','resolve','failureMessage','Payment\x20not\x20found','params','orderId','Bearer\x20','🔄\x20Internal\x20API:\x20Updating\x20payment\x20','5KXLuRj','prototype','express','64CpBSYS','Invalid\x20internal\x20API\x20key','Router','amount','currency','\x20updated\x20successfully','getOwnPropertyNames','../services/webhookService','string'];a27_0x2308=function(){return _0x4a0072;};return a27_0x2308();}Object[a27_0x349706(0x10b)](exports,a27_0x349706(0x124),{'value':!![]});const express_1=require(a27_0x349706(0x149)),database_1=__importDefault(require('../config/database')),router=(0x0,express_1[a27_0x349706(0x14c)])(),verifyInternalApiKey=(_0x553cb7,_0x1a4d57,_0x4e2ad6)=>{const _0x25ea57=a27_0x349706,_0x922bb4=_0x553cb7['headers'][_0x25ea57(0x138)];if(!_0x922bb4||!_0x922bb4['startsWith'](_0x25ea57(0x145)))return _0x1a4d57[_0x25ea57(0x12d)](0x191)['json']({'error':_0x25ea57(0x114)});const _0x3c6d16=_0x922bb4[_0x25ea57(0x110)](0x7);if(_0x3c6d16!=='internal-api-key')return _0x1a4d57[_0x25ea57(0x12d)](0x191)[_0x25ea57(0x11c)]({'error':_0x25ea57(0x14b)});_0x4e2ad6();};router[a27_0x349706(0x115)](a27_0x349706(0x13f),verifyInternalApiKey,async(_0x1002e5,_0x5c7d79)=>{const _0xd3e2eb=a27_0x349706;try{const {id:_0x5b4fa1}=_0x1002e5['params'];console['log'](_0xd3e2eb(0x125)+_0x5b4fa1+_0xd3e2eb(0x113));const _0x3d6cb3=await database_1['default'][_0xd3e2eb(0x139)]['findUnique']({'where':{'id':_0x5b4fa1},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x3d6cb3)return _0x5c7d79['status'](0x194)[_0xd3e2eb(0x11c)]({'error':_0xd3e2eb(0x142)});console[_0xd3e2eb(0x11e)]('✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20'+_0x3d6cb3[_0xd3e2eb(0x10c)][_0xd3e2eb(0x12a)]),_0x5c7d79[_0xd3e2eb(0x11c)]({'id':_0x3d6cb3['id'],'amount':_0x3d6cb3[_0xd3e2eb(0x14d)],'currency':_0x3d6cb3[_0xd3e2eb(0x14e)],'status':_0x3d6cb3[_0xd3e2eb(0x12d)],'orderId':_0x3d6cb3[_0xd3e2eb(0x144)],'shop':_0x3d6cb3['shop']});}catch(_0x1a4eaa){console['error']('Internal\x20API\x20error\x20getting\x20payment:',_0x1a4eaa),_0x5c7d79[_0xd3e2eb(0x12d)](0x1f4)['json']({'error':_0xd3e2eb(0x11d)});}}),router[a27_0x349706(0x129)](a27_0x349706(0x13e),verifyInternalApiKey,async(_0x4c7468,_0x262064)=>{const _0x5a65b6=a27_0x349706;try{const {id:_0x3cc774}=_0x4c7468[_0x5a65b6(0x143)],_0x2594e6=_0x4c7468['body'];console[_0x5a65b6(0x11e)](_0x5a65b6(0x146)+_0x3cc774,_0x2594e6);const _0x500137=['status',_0x5a65b6(0x123),'gatewayPaymentId',_0x5a65b6(0x153),_0x5a65b6(0x12e),_0x5a65b6(0x111),_0x5a65b6(0x155),_0x5a65b6(0x130),_0x5a65b6(0x135),_0x5a65b6(0x13b),_0x5a65b6(0x141)],_0x4056c3={};for(const [_0x470277,_0x3bbf34]of Object[_0x5a65b6(0x127)](_0x2594e6)){if(_0x500137['includes'](_0x470277)){let _0x49344c=_0x470277;if(_0x470277===_0x5a65b6(0x123)||_0x470277===_0x5a65b6(0x122))_0x49344c=_0x5a65b6(0x122);else{if(_0x470277===_0x5a65b6(0x153)||_0x470277==='cardLast4')_0x49344c='cardLast4';else{if(_0x470277===_0x5a65b6(0x111)||_0x470277===_0x5a65b6(0x155))_0x49344c=_0x5a65b6(0x155);else{if(_0x470277===_0x5a65b6(0x130)||_0x470277===_0x5a65b6(0x135))_0x49344c=_0x5a65b6(0x135);else(_0x470277===_0x5a65b6(0x13b)||_0x470277===_0x5a65b6(0x141))&&(_0x49344c='failureMessage');}}}_0x49344c===_0x5a65b6(0x135)&&typeof _0x3bbf34===_0x5a65b6(0x152)?_0x4056c3[_0x49344c]=new Date(_0x3bbf34):_0x4056c3[_0x49344c]=_0x3bbf34;}}if(Object['keys'](_0x4056c3)[_0x5a65b6(0x12f)]===0x0)return _0x262064['status'](0x190)['json']({'error':_0x5a65b6(0x132)});const _0x46201e=await database_1[_0x5a65b6(0x131)][_0x5a65b6(0x139)]['update']({'where':{'id':_0x3cc774},'data':_0x4056c3});console[_0x5a65b6(0x11e)](_0x5a65b6(0x10e)+_0x3cc774+_0x5a65b6(0x14f));if(_0x4056c3[_0x5a65b6(0x12d)]==='PAID'){console[_0x5a65b6(0x11e)](_0x5a65b6(0x117)+_0x3cc774+'\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing');try{const {WebhookService:_0x591d84}=await Promise[_0x5a65b6(0x140)]()[_0x5a65b6(0x109)](()=>__importStar(require(_0x5a65b6(0x151)))),_0x2aa045=new _0x591d84(),_0x1458b4=await database_1['default']['payment'][_0x5a65b6(0x10f)]({'where':{'id':_0x3cc774},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x1458b4&&console['log'](_0x5a65b6(0x133)+_0x3cc774);}catch(_0x34f5f5){console[_0x5a65b6(0x120)](_0x5a65b6(0x11b),_0x34f5f5);}}_0x262064[_0x5a65b6(0x11c)]({'success':!![],'payment':{'id':_0x46201e['id'],'status':_0x46201e[_0x5a65b6(0x12d)]}});}catch(_0x10e60a){console[_0x5a65b6(0x120)]('Internal\x20API\x20error\x20updating\x20payment:',_0x10e60a),_0x262064[_0x5a65b6(0x12d)](0x1f4)[_0x5a65b6(0x11c)]({'error':'Internal\x20server\x20error'});}}),router[a27_0x349706(0x115)](a27_0x349706(0x11a),(_0xbe4b09,_0x25ffd8)=>{const _0x3f01fc=a27_0x349706;_0x25ffd8[_0x3f01fc(0x11c)]({'status':'ok','timestamp':new Date()[_0x3f01fc(0x154)]()});}),exports[a27_0x349706(0x131)]=router;