'use strict';const a27_0x58a4b7=a27_0x3022;(function(_0x5237a8,_0x5c96b6){const _0x436795=a27_0x3022,_0x4b8c9b=_0x5237a8();while(!![]){try{const _0x47ed38=parseInt(_0x436795(0x130))/0x1+-parseInt(_0x436795(0x159))/0x2+-parseInt(_0x436795(0x143))/0x3+parseInt(_0x436795(0x140))/0x4*(-parseInt(_0x436795(0x152))/0x5)+parseInt(_0x436795(0x128))/0x6*(-parseInt(_0x436795(0x13f))/0x7)+-parseInt(_0x436795(0x121))/0x8*(parseInt(_0x436795(0x14b))/0x9)+parseInt(_0x436795(0x120))/0xa*(parseInt(_0x436795(0x12a))/0xb);if(_0x47ed38===_0x5c96b6)break;else _0x4b8c9b['push'](_0x4b8c9b['shift']());}catch(_0x37673e){_0x4b8c9b['push'](_0x4b8c9b['shift']());}}}(a27_0x5f03,0x3fcd6));function a27_0x3022(_0x70e78a,_0x2d69f7){const _0x5f0309=a27_0x5f03();return a27_0x3022=function(_0x302228,_0x5ab8ae){_0x302228=_0x302228-0x113;let _0x1f9afe=_0x5f0309[_0x302228];return _0x1f9afe;},a27_0x3022(_0x70e78a,_0x2d69f7);}var __createBinding=this&&this[a27_0x58a4b7(0x11b)]||(Object[a27_0x58a4b7(0x155)]?function(_0x57cb8f,_0x42cdb7,_0x190410,_0x22745a){const _0x2a34d4=a27_0x58a4b7;if(_0x22745a===undefined)_0x22745a=_0x190410;var _0xdf411b=Object[_0x2a34d4(0x11a)](_0x42cdb7,_0x190410);(!_0xdf411b||('get'in _0xdf411b?!_0x42cdb7[_0x2a34d4(0x146)]:_0xdf411b[_0x2a34d4(0x115)]||_0xdf411b[_0x2a34d4(0x119)]))&&(_0xdf411b={'enumerable':!![],'get':function(){return _0x42cdb7[_0x190410];}}),Object[_0x2a34d4(0x129)](_0x57cb8f,_0x22745a,_0xdf411b);}:function(_0x14b5bc,_0x400d15,_0x738cad,_0x55ff8f){if(_0x55ff8f===undefined)_0x55ff8f=_0x738cad;_0x14b5bc[_0x55ff8f]=_0x400d15[_0x738cad];}),__setModuleDefault=this&&this[a27_0x58a4b7(0x132)]||(Object[a27_0x58a4b7(0x155)]?function(_0x1d9574,_0x3ec738){const _0x570d1c=a27_0x58a4b7;Object[_0x570d1c(0x129)](_0x1d9574,'default',{'enumerable':!![],'value':_0x3ec738});}:function(_0xf799b9,_0x21074f){const _0xe4f0e0=a27_0x58a4b7;_0xf799b9[_0xe4f0e0(0x13c)]=_0x21074f;}),__importStar=this&&this['__importStar']||(function(){var _0x4462cf=function(_0x433deb){const _0x84f2c8=a27_0x3022;return _0x4462cf=Object[_0x84f2c8(0x12f)]||function(_0x112a3c){const _0x41b1ed=_0x84f2c8;var _0x2c992c=[];for(var _0x5a9cfb in _0x112a3c)if(Object[_0x41b1ed(0x148)][_0x41b1ed(0x150)][_0x41b1ed(0x13d)](_0x112a3c,_0x5a9cfb))_0x2c992c[_0x2c992c[_0x41b1ed(0x13a)]]=_0x5a9cfb;return _0x2c992c;},_0x4462cf(_0x433deb);};return function(_0x4359d2){const _0x6d5104=a27_0x3022;if(_0x4359d2&&_0x4359d2[_0x6d5104(0x146)])return _0x4359d2;var _0x2320e1={};if(_0x4359d2!=null){for(var _0x6c28ce=_0x4462cf(_0x4359d2),_0x50c8b2=0x0;_0x50c8b2<_0x6c28ce['length'];_0x50c8b2++)if(_0x6c28ce[_0x50c8b2]!==_0x6d5104(0x13c))__createBinding(_0x2320e1,_0x4359d2,_0x6c28ce[_0x50c8b2]);}return __setModuleDefault(_0x2320e1,_0x4359d2),_0x2320e1;};}()),__importDefault=this&&this['__importDefault']||function(_0x28dbe5){const _0x3fda81=a27_0x58a4b7;return _0x28dbe5&&_0x28dbe5[_0x3fda81(0x146)]?_0x28dbe5:{'default':_0x28dbe5};};Object[a27_0x58a4b7(0x129)](exports,a27_0x58a4b7(0x146),{'value':!![]});const express_1=require(a27_0x58a4b7(0x12b)),database_1=__importDefault(require(a27_0x58a4b7(0x15c))),router=(0x0,express_1['Router'])(),verifyInternalApiKey=(_0x555cbe,_0x2135b1,_0x3c7954)=>{const _0x6251ab=a27_0x58a4b7,_0x1bab6b=_0x555cbe['headers'][_0x6251ab(0x126)];if(!_0x1bab6b||!_0x1bab6b[_0x6251ab(0x12d)](_0x6251ab(0x137)))return _0x2135b1[_0x6251ab(0x131)](0x191)[_0x6251ab(0x139)]({'error':_0x6251ab(0x15a)});const _0x537f34=_0x1bab6b[_0x6251ab(0x11f)](0x7);if(_0x537f34!==_0x6251ab(0x156))return _0x2135b1[_0x6251ab(0x131)](0x191)[_0x6251ab(0x139)]({'error':_0x6251ab(0x14f)});_0x3c7954();};router['get'](a27_0x58a4b7(0x113),verifyInternalApiKey,async(_0x276b5a,_0x47c555)=>{const _0x2880a0=a27_0x58a4b7;try{const {id:_0xdf1600}=_0x276b5a[_0x2880a0(0x135)];console['log'](_0x2880a0(0x123)+_0xdf1600+'\x20with\x20gateway\x20settings');const _0x1d6513=await database_1[_0x2880a0(0x13c)][_0x2880a0(0x145)]['findUnique']({'where':{'id':_0xdf1600},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x1d6513)return _0x47c555[_0x2880a0(0x131)](0x194)[_0x2880a0(0x139)]({'error':'Payment\x20not\x20found'});console[_0x2880a0(0x11c)](_0x2880a0(0x151)+_0x1d6513[_0x2880a0(0x116)]['username']),_0x47c555[_0x2880a0(0x139)]({'id':_0x1d6513['id'],'amount':_0x1d6513['amount'],'currency':_0x1d6513['currency'],'status':_0x1d6513['status'],'orderId':_0x1d6513[_0x2880a0(0x15b)],'shop':_0x1d6513[_0x2880a0(0x116)]});}catch(_0x2a188d){console[_0x2880a0(0x142)](_0x2880a0(0x11d),_0x2a188d),_0x47c555['status'](0x1f4)[_0x2880a0(0x139)]({'error':_0x2880a0(0x13b)});}}),router['patch']('/payments/:id/update',verifyInternalApiKey,async(_0x4357fa,_0x40dfd3)=>{const _0xe6bdbf=a27_0x58a4b7;try{const {id:_0xd172d2}=_0x4357fa['params'],_0x3e1330=_0x4357fa[_0xe6bdbf(0x154)];console[_0xe6bdbf(0x11c)](_0xe6bdbf(0x11e)+_0xd172d2,_0x3e1330);const _0x24d188=[_0xe6bdbf(0x131),_0xe6bdbf(0x13e),'gatewayPaymentId','card_last4',_0xe6bdbf(0x134),_0xe6bdbf(0x14a),_0xe6bdbf(0x118),_0xe6bdbf(0x153),_0xe6bdbf(0x138),_0xe6bdbf(0x133),_0xe6bdbf(0x125)],_0x4a2770={};for(const [_0xba0e29,_0x153f68]of Object[_0xe6bdbf(0x12e)](_0x3e1330)){if(_0x24d188[_0xe6bdbf(0x147)](_0xba0e29)){let _0x21182a=_0xba0e29;if(_0xba0e29==='gateway_payment_id'||_0xba0e29===_0xe6bdbf(0x144))_0x21182a=_0xe6bdbf(0x144);else{if(_0xba0e29===_0xe6bdbf(0x117)||_0xba0e29===_0xe6bdbf(0x134))_0x21182a=_0xe6bdbf(0x134);else{if(_0xba0e29==='payment_method'||_0xba0e29===_0xe6bdbf(0x118))_0x21182a='paymentMethod';else{if(_0xba0e29==='paid_at'||_0xba0e29===_0xe6bdbf(0x138))_0x21182a=_0xe6bdbf(0x138);else(_0xba0e29===_0xe6bdbf(0x133)||_0xba0e29===_0xe6bdbf(0x125))&&(_0x21182a='failureMessage');}}}_0x21182a===_0xe6bdbf(0x138)&&typeof _0x153f68===_0xe6bdbf(0x149)?_0x4a2770[_0x21182a]=new Date(_0x153f68):_0x4a2770[_0x21182a]=_0x153f68;}}if(Object[_0xe6bdbf(0x157)](_0x4a2770)['length']===0x0)return _0x40dfd3[_0xe6bdbf(0x131)](0x190)[_0xe6bdbf(0x139)]({'error':_0xe6bdbf(0x122)});const _0xda9a0f=await database_1[_0xe6bdbf(0x13c)][_0xe6bdbf(0x145)]['update']({'where':{'id':_0xd172d2},'data':_0x4a2770});console['log'](_0xe6bdbf(0x12c)+_0xd172d2+_0xe6bdbf(0x15d));if(_0x4a2770[_0xe6bdbf(0x131)]===_0xe6bdbf(0x158)){console[_0xe6bdbf(0x11c)]('üéâ\x20Payment\x20'+_0xd172d2+_0xe6bdbf(0x124));try{const {WebhookService:_0x54be70}=await Promise[_0xe6bdbf(0x14e)]()[_0xe6bdbf(0x136)](()=>__importStar(require('../services/webhookService'))),_0x2cee4c=new _0x54be70(),_0x3f7d2e=await database_1[_0xe6bdbf(0x13c)]['payment'][_0xe6bdbf(0x14c)]({'where':{'id':_0xd172d2},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x3f7d2e&&console[_0xe6bdbf(0x11c)]('üì§\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20'+_0xd172d2);}catch(_0x4165aa){console[_0xe6bdbf(0x142)](_0xe6bdbf(0x141),_0x4165aa);}}_0x40dfd3[_0xe6bdbf(0x139)]({'success':!![],'payment':{'id':_0xda9a0f['id'],'status':_0xda9a0f[_0xe6bdbf(0x131)]}});}catch(_0x58252b){console[_0xe6bdbf(0x142)]('Internal\x20API\x20error\x20updating\x20payment:',_0x58252b),_0x40dfd3[_0xe6bdbf(0x131)](0x1f4)[_0xe6bdbf(0x139)]({'error':'Internal\x20server\x20error'});}}),router[a27_0x58a4b7(0x127)](a27_0x58a4b7(0x114),(_0x34b827,_0x2c537a)=>{const _0x31d742=a27_0x58a4b7;_0x2c537a[_0x31d742(0x139)]({'status':'ok','timestamp':new Date()[_0x31d742(0x14d)]()});}),exports['default']=router;function a27_0x5f03(){const _0x1b2143=['Error\x20sending\x20webhook\x20notification:','error','300564ifqTfl','gatewayPaymentId','payment','__esModule','includes','prototype','string','payment_method','4311gAmEfo','findUnique','toISOString','resolve','Invalid\x20internal\x20API\x20key','hasOwnProperty','‚úÖ\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','7370bJaTMS','paid_at','body','create','internal-api-key','keys','PAID','786228DPVNcm','Missing\x20or\x20invalid\x20authorization\x20header','orderId','../config/database','\x20updated\x20successfully','/payments/:id/gateway-settings','/health','writable','shop','card_last4','paymentMethod','configurable','getOwnPropertyDescriptor','__createBinding','log','Internal\x20API\x20error\x20getting\x20payment:','üîÑ\x20Internal\x20API:\x20Updating\x20payment\x20','substring','290uSpQkv','3856wdLUaA','No\x20valid\x20fields\x20to\x20update','üîç\x20Internal\x20API:\x20Getting\x20payment\x20','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','failureMessage','authorization','get','6OsHAEI','defineProperty','628034MomxsC','express','‚úÖ\x20Internal\x20API:\x20Payment\x20','startsWith','entries','getOwnPropertyNames','621tbpzCg','status','__setModuleDefault','failure_message','cardLast4','params','then','Bearer\x20','paidAt','json','length','Internal\x20server\x20error','default','call','gateway_payment_id','1682975VENuOt','1168DDhWdN'];a27_0x5f03=function(){return _0x1b2143;};return a27_0x5f03();}