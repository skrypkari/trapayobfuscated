'use strict';const a25_0x5ebb54=a25_0x61af;function a25_0x61af(_0x2b5765,_0x2d979d){const _0x1ffd1b=a25_0x1ffd();return a25_0x61af=function(_0x61afda,_0x216e21){_0x61afda=_0x61afda-0xa5;let _0x585ea9=_0x1ffd1b[_0x61afda];return _0x585ea9;},a25_0x61af(_0x2b5765,_0x2d979d);}(function(_0x343877,_0x44bd53){const _0x426280=a25_0x61af,_0x3566b5=_0x343877();while(!![]){try{const _0x9ed034=-parseInt(_0x426280(0xa5))/0x1+-parseInt(_0x426280(0xd6))/0x2+parseInt(_0x426280(0xbf))/0x3+parseInt(_0x426280(0xb2))/0x4+-parseInt(_0x426280(0xe1))/0x5*(-parseInt(_0x426280(0xb8))/0x6)+-parseInt(_0x426280(0xc9))/0x7+-parseInt(_0x426280(0xe0))/0x8*(-parseInt(_0x426280(0xa8))/0x9);if(_0x9ed034===_0x44bd53)break;else _0x3566b5['push'](_0x3566b5['shift']());}catch(_0x3f03c0){_0x3566b5['push'](_0x3566b5['shift']());}}}(a25_0x1ffd,0x9d56c));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x5c8fda,_0x25982a,_0x5c2221,_0x5bc823){const _0xe7b5ee=a25_0x61af;if(_0x5bc823===undefined)_0x5bc823=_0x5c2221;var _0x526903=Object['getOwnPropertyDescriptor'](_0x25982a,_0x5c2221);(!_0x526903||(_0xe7b5ee(0xcd)in _0x526903?!_0x25982a[_0xe7b5ee(0xdc)]:_0x526903[_0xe7b5ee(0xde)]||_0x526903[_0xe7b5ee(0xcc)]))&&(_0x526903={'enumerable':!![],'get':function(){return _0x25982a[_0x5c2221];}}),Object[_0xe7b5ee(0xe2)](_0x5c8fda,_0x5bc823,_0x526903);}:function(_0x2ed4f9,_0x3bdaad,_0x578f5b,_0x47336e){if(_0x47336e===undefined)_0x47336e=_0x578f5b;_0x2ed4f9[_0x47336e]=_0x3bdaad[_0x578f5b];}),__setModuleDefault=this&&this[a25_0x5ebb54(0xc3)]||(Object[a25_0x5ebb54(0xe8)]?function(_0x2f5472,_0x2f462c){const _0x2f25f3=a25_0x5ebb54;Object[_0x2f25f3(0xe2)](_0x2f5472,'default',{'enumerable':!![],'value':_0x2f462c});}:function(_0x174dbc,_0x11abe4){const _0x24d3b8=a25_0x5ebb54;_0x174dbc[_0x24d3b8(0xc8)]=_0x11abe4;}),__importStar=this&&this['__importStar']||(function(){var _0x1c57f9=function(_0x692519){return _0x1c57f9=Object['getOwnPropertyNames']||function(_0x38cbba){const _0x648e77=a25_0x61af;var _0x27f1e1=[];for(var _0x58f242 in _0x38cbba)if(Object[_0x648e77(0xa6)]['hasOwnProperty'][_0x648e77(0xa9)](_0x38cbba,_0x58f242))_0x27f1e1[_0x27f1e1[_0x648e77(0xd9)]]=_0x58f242;return _0x27f1e1;},_0x1c57f9(_0x692519);};return function(_0x1399dd){const _0x1176e9=a25_0x61af;if(_0x1399dd&&_0x1399dd[_0x1176e9(0xdc)])return _0x1399dd;var _0x2fb2f2={};if(_0x1399dd!=null){for(var _0x2c40f2=_0x1c57f9(_0x1399dd),_0x23a19b=0x0;_0x23a19b<_0x2c40f2['length'];_0x23a19b++)if(_0x2c40f2[_0x23a19b]!==_0x1176e9(0xc8))__createBinding(_0x2fb2f2,_0x1399dd,_0x2c40f2[_0x23a19b]);}return __setModuleDefault(_0x2fb2f2,_0x1399dd),_0x2fb2f2;};}()),__importDefault=this&&this[a25_0x5ebb54(0xac)]||function(_0xd276a3){return _0xd276a3&&_0xd276a3['__esModule']?_0xd276a3:{'default':_0xd276a3};};Object[a25_0x5ebb54(0xe2)](exports,a25_0x5ebb54(0xdc),{'value':!![]});const express_1=require('express'),database_1=__importDefault(require(a25_0x5ebb54(0xb0))),router=(0x0,express_1['Router'])(),verifyInternalApiKey=(_0x5ee3c4,_0x139f8b,_0x130d57)=>{const _0x59773f=a25_0x5ebb54,_0x1d1aa3=_0x5ee3c4[_0x59773f(0xe6)][_0x59773f(0xad)];if(!_0x1d1aa3||!_0x1d1aa3[_0x59773f(0xbe)](_0x59773f(0xec)))return _0x139f8b['status'](0x191)[_0x59773f(0xce)]({'error':_0x59773f(0xd2)});const _0x271806=_0x1d1aa3[_0x59773f(0xcb)](0x7);if(_0x271806!==_0x59773f(0xbd))return _0x139f8b[_0x59773f(0xbb)](0x191)[_0x59773f(0xce)]({'error':_0x59773f(0xc0)});_0x130d57();};function a25_0x1ffd(){const _0x38eb28=['status','/payments/:id/gateway-settings','internal-api-key','startsWith','1550610OUDcQl','Invalid\x20internal\x20API\x20key','Internal\x20API\x20error\x20updating\x20payment:','findUnique','__setModuleDefault','Internal\x20API\x20error\x20getting\x20payment:','error','Internal\x20server\x20error','log','default','8765267oZAxxP','card_last4','substring','configurable','get','json','✅\x20Internal\x20API:\x20Payment\x20','orderId','\x20updated\x20successfully','Missing\x20or\x20invalid\x20authorization\x20header','patch','then','paidAt','1098146TrYrwo','body','PAID','length','✅\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','string','__esModule','gateway_response','writable','🔍\x20Internal\x20API:\x20Getting\x20payment\x20','4479640jRCWTF','95VmunRA','defineProperty','failure_message','resolve','replace','headers','params','create','../services/webhookService','/payments/:id/update','📤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','Bearer\x20','320651UjitqD','prototype','username','9dnNnXd','call','includes','toISOString','__importDefault','authorization','shop','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','../config/database','Payment\x20not\x20found','2620948idoslB','🎉\x20Payment\x20','paid_at','keys','currency','update','326622UReBjU','payment','\x20with\x20gateway\x20settings'];a25_0x1ffd=function(){return _0x38eb28;};return a25_0x1ffd();}router[a25_0x5ebb54(0xcd)](a25_0x5ebb54(0xbc),verifyInternalApiKey,async(_0x4ce910,_0x2c5af5)=>{const _0x101c53=a25_0x5ebb54;try{const {id:_0x351ad1}=_0x4ce910['params'];console[_0x101c53(0xc7)](_0x101c53(0xdf)+_0x351ad1+_0x101c53(0xba));const _0x5b25a7=await database_1[_0x101c53(0xc8)][_0x101c53(0xb9)][_0x101c53(0xc2)]({'where':{'id':_0x351ad1},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x5b25a7)return _0x2c5af5[_0x101c53(0xbb)](0x194)['json']({'error':_0x101c53(0xb1)});console['log'](_0x101c53(0xda)+_0x5b25a7[_0x101c53(0xae)][_0x101c53(0xa7)]),_0x2c5af5[_0x101c53(0xce)]({'id':_0x5b25a7['id'],'amount':_0x5b25a7['amount'],'currency':_0x5b25a7[_0x101c53(0xb6)],'status':_0x5b25a7[_0x101c53(0xbb)],'orderId':_0x5b25a7[_0x101c53(0xd0)],'shop':_0x5b25a7[_0x101c53(0xae)]});}catch(_0x52c982){console[_0x101c53(0xc5)](_0x101c53(0xc4),_0x52c982),_0x2c5af5[_0x101c53(0xbb)](0x1f4)[_0x101c53(0xce)]({'error':_0x101c53(0xc6)});}}),router[a25_0x5ebb54(0xd3)](a25_0x5ebb54(0xea),verifyInternalApiKey,async(_0x8b0306,_0x452b98)=>{const _0x424e3a=a25_0x5ebb54;try{const {id:_0x487fe3}=_0x8b0306[_0x424e3a(0xe7)],_0x4f3357=_0x8b0306[_0x424e3a(0xd7)];console['log']('🔄\x20Internal\x20API:\x20Updating\x20payment\x20'+_0x487fe3,_0x4f3357);const _0x2aac66=[_0x424e3a(0xbb),'gateway_payment_id',_0x424e3a(0xca),'payment_method',_0x424e3a(0xb4),_0x424e3a(0xdd),_0x424e3a(0xe3)],_0x227533={};for(const [_0x49af1f,_0x2770ed]of Object['entries'](_0x4f3357)){if(_0x2aac66[_0x424e3a(0xaa)](_0x49af1f)){const _0x4e7fec=_0x49af1f[_0x424e3a(0xe5)](/_([a-z])/g,(_0x21166a,_0x4eb905)=>_0x4eb905['toUpperCase']());_0x4e7fec===_0x424e3a(0xd5)&&typeof _0x2770ed===_0x424e3a(0xdb)?_0x227533[_0x4e7fec]=new Date(_0x2770ed):_0x227533[_0x4e7fec]=_0x2770ed;}}if(Object[_0x424e3a(0xb5)](_0x227533)[_0x424e3a(0xd9)]===0x0)return _0x452b98['status'](0x190)[_0x424e3a(0xce)]({'error':'No\x20valid\x20fields\x20to\x20update'});const _0xd38b97=await database_1[_0x424e3a(0xc8)]['payment'][_0x424e3a(0xb7)]({'where':{'id':_0x487fe3},'data':_0x227533});console['log'](_0x424e3a(0xcf)+_0x487fe3+_0x424e3a(0xd1));if(_0x227533['status']===_0x424e3a(0xd8)){console['log'](_0x424e3a(0xb3)+_0x487fe3+_0x424e3a(0xaf));try{const {WebhookService:_0xb319d4}=await Promise[_0x424e3a(0xe4)]()[_0x424e3a(0xd4)](()=>__importStar(require(_0x424e3a(0xe9)))),_0x143492=new _0xb319d4(),_0x5dd9f2=await database_1[_0x424e3a(0xc8)][_0x424e3a(0xb9)][_0x424e3a(0xc2)]({'where':{'id':_0x487fe3},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x5dd9f2&&console[_0x424e3a(0xc7)](_0x424e3a(0xeb)+_0x487fe3);}catch(_0x42c0fd){console['error']('Error\x20sending\x20webhook\x20notification:',_0x42c0fd);}}_0x452b98['json']({'success':!![],'payment':{'id':_0xd38b97['id'],'status':_0xd38b97[_0x424e3a(0xbb)]}});}catch(_0x3e414f){console[_0x424e3a(0xc5)](_0x424e3a(0xc1),_0x3e414f),_0x452b98['status'](0x1f4)[_0x424e3a(0xce)]({'error':_0x424e3a(0xc6)});}}),router[a25_0x5ebb54(0xcd)]('/health',(_0x193e00,_0x471cd9)=>{const _0x342f80=a25_0x5ebb54;_0x471cd9[_0x342f80(0xce)]({'status':'ok','timestamp':new Date()[_0x342f80(0xab)]()});}),exports[a25_0x5ebb54(0xc8)]=router;