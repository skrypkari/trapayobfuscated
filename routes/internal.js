'use strict';const a32_0x31f296=a32_0x55df;(function(_0x53756a,_0x143119){const _0x8b45f5=a32_0x55df,_0xc4f967=_0x53756a();while(!![]){try{const _0x2d9d8e=parseInt(_0x8b45f5(0x127))/0x1*(parseInt(_0x8b45f5(0xff))/0x2)+parseInt(_0x8b45f5(0x129))/0x3*(-parseInt(_0x8b45f5(0x121))/0x4)+-parseInt(_0x8b45f5(0x128))/0x5+parseInt(_0x8b45f5(0xf5))/0x6+parseInt(_0x8b45f5(0xeb))/0x7*(-parseInt(_0x8b45f5(0xea))/0x8)+-parseInt(_0x8b45f5(0x103))/0x9*(-parseInt(_0x8b45f5(0xfa))/0xa)+-parseInt(_0x8b45f5(0x104))/0xb*(-parseInt(_0x8b45f5(0x105))/0xc);if(_0x2d9d8e===_0x143119)break;else _0xc4f967['push'](_0xc4f967['shift']());}catch(_0x47435a){_0xc4f967['push'](_0xc4f967['shift']());}}}(a32_0x4f9f,0x8ef7c));var __createBinding=this&&this[a32_0x31f296(0x137)]||(Object[a32_0x31f296(0x12f)]?function(_0x37ffe3,_0x345a58,_0x1c5590,_0x212a27){const _0x1c7d98=a32_0x31f296;if(_0x212a27===undefined)_0x212a27=_0x1c5590;var _0x380fc4=Object[_0x1c7d98(0x11f)](_0x345a58,_0x1c5590);(!_0x380fc4||(_0x1c7d98(0xef)in _0x380fc4?!_0x345a58[_0x1c7d98(0x122)]:_0x380fc4[_0x1c7d98(0x10a)]||_0x380fc4[_0x1c7d98(0xf0)]))&&(_0x380fc4={'enumerable':!![],'get':function(){return _0x345a58[_0x1c5590];}}),Object[_0x1c7d98(0x115)](_0x37ffe3,_0x212a27,_0x380fc4);}:function(_0x1905cc,_0x3fe662,_0xbfbd87,_0x26bb6d){if(_0x26bb6d===undefined)_0x26bb6d=_0xbfbd87;_0x1905cc[_0x26bb6d]=_0x3fe662[_0xbfbd87];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a32_0x31f296(0x12f)]?function(_0x2cc980,_0x4cd77c){const _0x45b0fe=a32_0x31f296;Object[_0x45b0fe(0x115)](_0x2cc980,'default',{'enumerable':!![],'value':_0x4cd77c});}:function(_0xf6359f,_0x31fd23){const _0x261057=a32_0x31f296;_0xf6359f[_0x261057(0xed)]=_0x31fd23;}),__importStar=this&&this[a32_0x31f296(0xfc)]||(function(){var _0x400b34=function(_0x131597){const _0x9a4b21=a32_0x55df;return _0x400b34=Object[_0x9a4b21(0x11b)]||function(_0x5deb08){const _0x46ddec=_0x9a4b21;var _0x37ede6=[];for(var _0x144e89 in _0x5deb08)if(Object[_0x46ddec(0x130)][_0x46ddec(0x111)][_0x46ddec(0x132)](_0x5deb08,_0x144e89))_0x37ede6[_0x37ede6[_0x46ddec(0x133)]]=_0x144e89;return _0x37ede6;},_0x400b34(_0x131597);};return function(_0x304aa4){const _0x10c089=a32_0x55df;if(_0x304aa4&&_0x304aa4[_0x10c089(0x122)])return _0x304aa4;var _0x39989c={};if(_0x304aa4!=null){for(var _0x188cc0=_0x400b34(_0x304aa4),_0x1df1ee=0x0;_0x1df1ee<_0x188cc0[_0x10c089(0x133)];_0x1df1ee++)if(_0x188cc0[_0x1df1ee]!==_0x10c089(0xed))__createBinding(_0x39989c,_0x304aa4,_0x188cc0[_0x1df1ee]);}return __setModuleDefault(_0x39989c,_0x304aa4),_0x39989c;};}()),__importDefault=this&&this[a32_0x31f296(0x11a)]||function(_0xb84a51){const _0x642fe=a32_0x31f296;return _0xb84a51&&_0xb84a51[_0x642fe(0x122)]?_0xb84a51:{'default':_0xb84a51};};function a32_0x4f9f(){const _0x304f6b=['params','status','then','writable','log','entries','âœ…\x20Internal\x20API:\x20Payment\x20found\x20for\x20shop\x20','startsWith','internal-api-key','username','hasOwnProperty','includes','currency','Missing\x20or\x20invalid\x20authorization\x20header','defineProperty','\x20with\x20gateway\x20settings','Internal\x20API\x20error\x20getting\x20payment:','resolve','toISOString','__importDefault','getOwnPropertyNames','../services/webhookService','paymentMethod','\x20marked\x20as\x20PAID,\x20triggering\x20webhook\x20processing','getOwnPropertyDescriptor','express','445212JVwdle','__esModule','paidAt','Internal\x20server\x20error','error','ðŸŽ‰\x20Payment\x20','8KVJgss','3778855TTUyaZ','3KowryC','ðŸ“¤\x20Sending\x20webhook\x20notification\x20to\x20merchant\x20for\x20payment\x20','string','/health','Invalid\x20internal\x20API\x20key','Router','create','prototype','gateway_payment_id','call','length','orderId','failureMessage','shop','__createBinding','32KZCyoN','1378230JQqIor','substring','default','Payment\x20not\x20found','get','configurable','Internal\x20API\x20error\x20updating\x20payment:','No\x20valid\x20fields\x20to\x20update','failure_message','findUnique','531372PWSYOc','card_last4','/payments/:id/gateway-settings','paid_at','gatewayPaymentId','58150kmbruD','json','__importStar','\x20updated\x20successfully','keys','137318tSCpiZ','cardLast4','payment','payment_method','342KHzVsK','29854ZNPzQw','6108FWjeDY','âœ…\x20Internal\x20API:\x20Payment\x20'];a32_0x4f9f=function(){return _0x304f6b;};return a32_0x4f9f();}Object[a32_0x31f296(0x115)](exports,a32_0x31f296(0x122),{'value':!![]});const express_1=require(a32_0x31f296(0x120)),database_1=__importDefault(require('../config/database')),router=(0x0,express_1[a32_0x31f296(0x12e)])(),verifyInternalApiKey=(_0x55a47a,_0x5a767e,_0x3e6b43)=>{const _0x47e7ae=a32_0x31f296,_0x40c38d=_0x55a47a['headers']['authorization'];if(!_0x40c38d||!_0x40c38d[_0x47e7ae(0x10e)]('Bearer\x20'))return _0x5a767e[_0x47e7ae(0x108)](0x191)[_0x47e7ae(0xfb)]({'error':_0x47e7ae(0x114)});const _0x9780fd=_0x40c38d[_0x47e7ae(0xec)](0x7);if(_0x9780fd!==_0x47e7ae(0x10f))return _0x5a767e['status'](0x191)[_0x47e7ae(0xfb)]({'error':_0x47e7ae(0x12d)});_0x3e6b43();};function a32_0x55df(_0x27352d,_0x2661bb){_0x27352d=_0x27352d-0xea;const _0x4f9fa=a32_0x4f9f();let _0x55df4e=_0x4f9fa[_0x27352d];return _0x55df4e;}router[a32_0x31f296(0xef)](a32_0x31f296(0xf7),verifyInternalApiKey,async(_0x71df95,_0x42814d)=>{const _0x1db6dc=a32_0x31f296;try{const {id:_0x2f833c}=_0x71df95[_0x1db6dc(0x107)];console[_0x1db6dc(0x10b)]('ðŸ”\x20Internal\x20API:\x20Getting\x20payment\x20'+_0x2f833c+_0x1db6dc(0x116));const _0x1378cc=await database_1[_0x1db6dc(0xed)][_0x1db6dc(0x101)]['findUnique']({'where':{'id':_0x2f833c},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'gatewaySettings':!![]}}}});if(!_0x1378cc)return _0x42814d['status'](0x194)[_0x1db6dc(0xfb)]({'error':_0x1db6dc(0xee)});console['log'](_0x1db6dc(0x10d)+_0x1378cc[_0x1db6dc(0x136)][_0x1db6dc(0x110)]),_0x42814d[_0x1db6dc(0xfb)]({'id':_0x1378cc['id'],'amount':_0x1378cc['amount'],'currency':_0x1378cc[_0x1db6dc(0x113)],'status':_0x1378cc[_0x1db6dc(0x108)],'orderId':_0x1378cc[_0x1db6dc(0x134)],'shop':_0x1378cc['shop']});}catch(_0x506fe6){console['error'](_0x1db6dc(0x117),_0x506fe6),_0x42814d[_0x1db6dc(0x108)](0x1f4)[_0x1db6dc(0xfb)]({'error':_0x1db6dc(0x124)});}}),router['patch']('/payments/:id/update',verifyInternalApiKey,async(_0x28f775,_0x269c49)=>{const _0x550fe0=a32_0x31f296;try{const {id:_0x479198}=_0x28f775[_0x550fe0(0x107)],_0x8031fd=_0x28f775['body'];console[_0x550fe0(0x10b)]('ðŸ”„\x20Internal\x20API:\x20Updating\x20payment\x20'+_0x479198,_0x8031fd);const _0x176534=[_0x550fe0(0x108),'gateway_payment_id',_0x550fe0(0xf9),_0x550fe0(0xf6),_0x550fe0(0x100),_0x550fe0(0x102),'paymentMethod',_0x550fe0(0xf8),_0x550fe0(0x123),_0x550fe0(0xf3),_0x550fe0(0x135)],_0x419e95={};for(const [_0x13cc44,_0x405074]of Object[_0x550fe0(0x10c)](_0x8031fd)){if(_0x176534[_0x550fe0(0x112)](_0x13cc44)){let _0x585904=_0x13cc44;if(_0x13cc44===_0x550fe0(0x131)||_0x13cc44===_0x550fe0(0xf9))_0x585904='gatewayPaymentId';else{if(_0x13cc44==='card_last4'||_0x13cc44===_0x550fe0(0x100))_0x585904=_0x550fe0(0x100);else{if(_0x13cc44==='payment_method'||_0x13cc44==='paymentMethod')_0x585904=_0x550fe0(0x11d);else{if(_0x13cc44==='paid_at'||_0x13cc44==='paidAt')_0x585904=_0x550fe0(0x123);else(_0x13cc44==='failure_message'||_0x13cc44===_0x550fe0(0x135))&&(_0x585904=_0x550fe0(0x135));}}}_0x585904===_0x550fe0(0x123)&&typeof _0x405074===_0x550fe0(0x12b)?_0x419e95[_0x585904]=new Date(_0x405074):_0x419e95[_0x585904]=_0x405074;}}if(Object[_0x550fe0(0xfe)](_0x419e95)[_0x550fe0(0x133)]===0x0)return _0x269c49[_0x550fe0(0x108)](0x190)[_0x550fe0(0xfb)]({'error':_0x550fe0(0xf2)});const _0x394374=await database_1[_0x550fe0(0xed)][_0x550fe0(0x101)]['update']({'where':{'id':_0x479198},'data':_0x419e95});console[_0x550fe0(0x10b)](_0x550fe0(0x106)+_0x479198+_0x550fe0(0xfd));if(_0x419e95[_0x550fe0(0x108)]==='PAID'){console[_0x550fe0(0x10b)](_0x550fe0(0x126)+_0x479198+_0x550fe0(0x11e));try{const {WebhookService:_0x390c92}=await Promise[_0x550fe0(0x118)]()[_0x550fe0(0x109)](()=>__importStar(require(_0x550fe0(0x11c)))),_0x517fec=new _0x390c92(),_0x3dad96=await database_1[_0x550fe0(0xed)][_0x550fe0(0x101)][_0x550fe0(0xf4)]({'where':{'id':_0x479198},'include':{'shop':{'select':{'id':!![],'username':!![],'settings':!![]}}}});_0x3dad96&&console[_0x550fe0(0x10b)](_0x550fe0(0x12a)+_0x479198);}catch(_0x268e00){console[_0x550fe0(0x125)]('Error\x20sending\x20webhook\x20notification:',_0x268e00);}}_0x269c49[_0x550fe0(0xfb)]({'success':!![],'payment':{'id':_0x394374['id'],'status':_0x394374[_0x550fe0(0x108)]}});}catch(_0x50b604){console[_0x550fe0(0x125)](_0x550fe0(0xf1),_0x50b604),_0x269c49[_0x550fe0(0x108)](0x1f4)[_0x550fe0(0xfb)]({'error':_0x550fe0(0x124)});}}),router[a32_0x31f296(0xef)](a32_0x31f296(0x12c),(_0x518549,_0x409c32)=>{const _0x64484=a32_0x31f296;_0x409c32[_0x64484(0xfb)]({'status':'ok','timestamp':new Date()[_0x64484(0x119)]()});}),exports[a32_0x31f296(0xed)]=router;