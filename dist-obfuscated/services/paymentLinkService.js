'use strict';const a45_0x2b2936=a45_0x1e2a;function a45_0x1e2a(_0x5f502d,_0x579b81){const _0x1b7e58=a45_0x1b7e();return a45_0x1e2a=function(_0x1e2a46,_0x2e7d28){_0x1e2a46=_0x1e2a46-0xbc;let _0x53b060=_0x1b7e58[_0x1e2a46];return _0x53b060;},a45_0x1e2a(_0x5f502d,_0x579b81);}(function(_0x278001,_0x4f4792){const _0x4daa3d=a45_0x1e2a,_0x27e8a8=_0x278001();while(!![]){try{const _0x33ef78=parseInt(_0x4daa3d(0x103))/0x1+parseInt(_0x4daa3d(0xbe))/0x2*(parseInt(_0x4daa3d(0x115))/0x3)+-parseInt(_0x4daa3d(0x156))/0x4+-parseInt(_0x4daa3d(0x139))/0x5*(parseInt(_0x4daa3d(0x157))/0x6)+-parseInt(_0x4daa3d(0x10e))/0x7+-parseInt(_0x4daa3d(0xd0))/0x8+parseInt(_0x4daa3d(0x137))/0x9*(parseInt(_0x4daa3d(0x161))/0xa);if(_0x33ef78===_0x4f4792)break;else _0x27e8a8['push'](_0x27e8a8['shift']());}catch(_0x3d15e4){_0x27e8a8['push'](_0x27e8a8['shift']());}}}(a45_0x1b7e,0x79e9e));function a45_0x1b7e(){const _0x4bba07=['default','./currencyService','floor','Anonymous','__importDefault','qr_code','shopId','üë§\x20Customer:\x20','NodaService','paymentLink','6043192eBZlqX','sourceCurrency','sourceCurrency\x20is\x20required\x20for\x20Plisio\x20payment\x20links','maxPayments','KlymeService','createPaymentLink','currencyService','deletePaymentLink','message','./gateways/klymeService','üîó\x20Plisio\x20payment\x20URL:\x20','üîó\x20Link\x20URL:\x20https://app.trapay.uk/link/','üí∞\x20Plisio\x20payment\x20link\x20mapping:','random','insensitive','defineProperty','env','üèÅ\x20Payment\x20link\x20','üîó\x20Rapyd\x20payment\x20URL:\x20','Payment\x20link\x20has\x20reached\x20maximum\x20payments','üîó\x20CoinToPay\x20payment\x20URL:\x20','ü™ô\x20Using\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link','Invalid\x20KLYME\x20gateway:\x20','initiatePaymentFromLink','\x20\x20\x20üíæ\x20DB\x20Fail\x20URL:\x20','üí∞\x20Fixed\x20amount:\x20','gateway_payment_id','üíæ\x20DB\x20Fail\x20URL:\x20','currency','country','üíæ\x20Payment\x20created\x20from\x20link:\x20','getPaymentLinkStatistics','https://tesoft.uk/gateway/payment.php?id=','üîó\x20KLYME\x20','../types/gateway','toLowerCase','\x20payments:\x20','USD','successUrl','qr_url','\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','https://app.trapay.uk/payment/','./gateways/coinToPayService','updatedAt','PENDING','handleSuccessfulPayment','ACTIVE','amount','qr_code_url','ONCE','KLYME\x20EU\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','234692NZbSbX','count','padStart','\x20(validated\x20for\x20','findUnique','\x20\x20\x20-\x20link.currency\x20(merchant\x20fiat\x20currency):\x20','findFirst','__esModule','invoice_total_sum','klymeService','generateGatewayOrderId','1294258sBBigC','\x20completed\x20(reached\x20max\x20payments)','getPaymentLinks','‚úÖ\x20Payment\x20link\x20created:\x20','PLACEHOLDER','toString','klyme_','40158idNaTe','expiresAt','delete','\x20\x20\x20üíæ\x20DB\x20Success\x20URL:\x20','üí≥\x20Creating\x20KLYME\x20','\x20payment\x20URL:\x20','Shop\x20is\x20not\x20active','../config/database','payment','failUrl','PlisioService','updatePaymentLink','payment_url','gateway','üíæ\x20DB\x20Success\x20URL:\x20','üí∞\x20Amount:\x20','COMPLETED','/gateway/pending.php?id=','ü™ô\x20Creating\x20CoinToPay\x20payment\x20from\x20link\x20with\x20gateway\x20order_id:\x20','üîó\x20Noda\x20payment\x20URL:\x20','KLYME\x20GB\x20accepts\x20only\x20GBP\x20currency,\x20got:\x20','ceil','PaymentLinkService','Unknown\x20error','language','\x20\x20\x20üåê\x20Gateway\x20Fail\x20URL:\x20','KLYME\x20DE\x20accepts\x20only\x20EUR\x20currency,\x20got:\x20','getPublicPaymentLinkData','\x20EUR\x20(always\x20EUR\x20for\x20CoinToPay)','getGatewayNameById','ü™ô\x20Forcing\x20EUR\x20as\x20currency\x20for\x20CoinToPay\x20payment\x20link\x20update','map','paymentLinkId','startsWith','11798253JubRED','Payment\x20link\x20is\x20not\x20active','5WGmgTb','FAILED','all','length','‚úÖ\x20DB\x20Success\x20URL:\x20','nodaService','formatPaymentLinkResponse','Payment\x20','RapydService','https://app.trapay.uk/payment/success','EUR','rapyd','status','validateKlymeCurrency','https://tesoft.uk','\x20(8digits-8digits\x20format)','‚ùå\x20DB\x20Fail\x20URL:\x20','log','Gateway\x20error:\x20','currentPayments','/gateway/fail.php?id=','Invalid\x20gateway\x20ID:\x20','no\x20email','BASE_URL','create','update','round','/gateway/success.php?id=','convertToUSDT','830316vcdXdI','3406074vsuzBD','Payment\x20link\x20has\x20expired','desc','\x20payment\x20created\x20successfully\x20with\x20gateway\x20order_id:\x20','shop','coinToPayService','isValidGatewayId','createdAt','cointopay','name','10nDlOCn','noda','üá¨üáß\x20Using\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link','100aCEwMr','amount\x20is\x20required\x20and\x20must\x20be\x20positive','.\x20Valid\x20IDs\x20are:\x200001\x20(Plisio),\x200010\x20(Rapyd),\x200100\x20(CoinToPay),\x201000\x20(Noda),\x201001\x20(KLYME\x20EU),\x201010\x20(KLYME\x20GB),\x201100\x20(KLYME\x20DE)','generateGatewayUrls','getKlymeRegionFromGatewayName','toUpperCase','https://tesoft.uk/gateways/noda/webhook','üá¨üáß\x20Forcing\x20GB\x20(Britain)\x20as\x20country\x20for\x20Rapyd\x20payment\x20link\x20update'];a45_0x1b7e=function(){return _0x4bba07;};return a45_0x1b7e();}var __importDefault=this&&this[a45_0x2b2936(0xca)]||function(_0x17e7c4){const _0x3b3733=a45_0x2b2936;return _0x17e7c4&&_0x17e7c4[_0x3b3733(0x10a)]?_0x17e7c4:{'default':_0x17e7c4};};Object[a45_0x2b2936(0xdf)](exports,a45_0x2b2936(0x10a),{'value':!![]}),exports['PaymentLinkService']=void 0x0;const database_1=__importDefault(require(a45_0x2b2936(0x11c))),plisioService_1=require('./gateways/plisioService'),rapydService_1=require('./gateways/rapydService'),nodaService_1=require('./gateways/nodaService'),coinToPayService_1=require(a45_0x2b2936(0xfa)),klymeService_1=require(a45_0x2b2936(0xd9)),gateway_1=require(a45_0x2b2936(0xf2)),currencyService_1=require(a45_0x2b2936(0xc7));class PaymentLinkService{constructor(){const _0x7fd5f5=a45_0x2b2936;this['plisioService']=new plisioService_1[(_0x7fd5f5(0x11f))](),this['rapydService']=new rapydService_1[(_0x7fd5f5(0x141))](),this['nodaService']=new nodaService_1[(_0x7fd5f5(0xce))](),this['coinToPayService']=new coinToPayService_1['CoinToPayService'](),this[_0x7fd5f5(0x10c)]=new klymeService_1[(_0x7fd5f5(0xd4))]();}[a45_0x2b2936(0x10d)](){const _0x44b17a=()=>{const _0x221412=a45_0x1e2a;return Math[_0x221412(0xc8)](Math[_0x221412(0xdd)]()*0x5f5e100)[_0x221412(0x113)]()[_0x221412(0x105)](0x8,'0');};return _0x44b17a()+'-'+_0x44b17a();}[a45_0x2b2936(0xc1)](_0x18a6bd,_0x2c6f74,_0x3e0d18,_0x273f33,_0x2727a2){const _0x3ebcb8=a45_0x2b2936;if(_0x273f33&&_0x2727a2)return{'finalSuccessUrl':_0x273f33,'finalFailUrl':_0x2727a2,'dbSuccessUrl':_0x273f33,'dbFailUrl':_0x2727a2};let _0x2252fe,_0x35863f,_0x34be3f,_0x390096;return _0x18a6bd===_0x3ebcb8(0xbc)||_0x18a6bd[_0x3ebcb8(0x136)](_0x3ebcb8(0x114))?(_0x2252fe=_0x3e0d18+_0x3ebcb8(0x126)+_0x2c6f74,_0x34be3f='https://app.trapay.uk/payment/pending'):(_0x2252fe=_0x3e0d18+_0x3ebcb8(0x154)+_0x2c6f74,_0x34be3f=_0x3ebcb8(0x142)),_0x35863f=_0x3e0d18+_0x3ebcb8(0x14d)+_0x2c6f74,_0x390096='https://app.trapay.uk/payment/fail',console[_0x3ebcb8(0x14a)]('üîó\x20Generated\x20URLs\x20for\x20'+_0x18a6bd+':'),console[_0x3ebcb8(0x14a)]('\x20\x20\x20üåê\x20Gateway\x20Success\x20URL:\x20'+_0x2252fe),console[_0x3ebcb8(0x14a)](_0x3ebcb8(0x12e)+_0x35863f),console['log'](_0x3ebcb8(0x118)+_0x34be3f),console[_0x3ebcb8(0x14a)](_0x3ebcb8(0xe8)+_0x390096),{'finalSuccessUrl':_0x2252fe,'finalFailUrl':_0x35863f,'dbSuccessUrl':_0x34be3f,'dbFailUrl':_0x390096};}[a45_0x2b2936(0x146)](_0x1585ae,_0x33b8bd){const _0x527f1a=a45_0x2b2936;if(!_0x1585ae[_0x527f1a(0x136)]('klyme_'))return;const _0x19024d=(0x0,gateway_1[_0x527f1a(0xc2)])(_0x1585ae),_0x4152be=_0x33b8bd['toUpperCase']();switch(_0x19024d){case'EU':if(_0x4152be!==_0x527f1a(0x143))throw new Error(_0x527f1a(0x102)+_0x4152be);break;case'GB':if(_0x4152be!=='GBP')throw new Error(_0x527f1a(0x129)+_0x4152be);break;case'DE':if(_0x4152be!=='EUR')throw new Error(_0x527f1a(0x12f)+_0x4152be);break;default:throw new Error('Unsupported\x20KLYME\x20region:\x20'+_0x19024d);}}async['createPaymentLink'](_0x4d2d07,_0x144307){const _0xa16cf0=a45_0x2b2936;if(!(0x0,gateway_1[_0xa16cf0(0x15d)])(_0x144307[_0xa16cf0(0x122)]))throw new Error(_0xa16cf0(0x14e)+_0x144307[_0xa16cf0(0x122)]+_0xa16cf0(0xc0));const _0x2d49e7=(0x0,gateway_1[_0xa16cf0(0x132)])(_0x144307[_0xa16cf0(0x122)]);if(!_0x2d49e7)throw new Error('Gateway\x20not\x20found\x20for\x20ID:\x20'+_0x144307[_0xa16cf0(0x122)]);console[_0xa16cf0(0x14a)]('üîó\x20Creating\x20payment\x20link\x20for\x20gateway:\x20'+_0x2d49e7);if(_0x2d49e7==='plisio'&&!_0x144307['sourceCurrency'])throw new Error(_0xa16cf0(0xd2));if(_0x2d49e7[_0xa16cf0(0x136)](_0xa16cf0(0x114))){const _0x284159=(0x0,gateway_1[_0xa16cf0(0xc2)])(_0x2d49e7);console['log'](_0xa16cf0(0x119)+_0x284159+'\x20payment\x20link');}let _0x5346ec=_0x144307[_0xa16cf0(0xed)];_0x2d49e7==='rapyd'&&(_0x5346ec='GB',console[_0xa16cf0(0x14a)](_0xa16cf0(0xbd)));if(!_0x144307[_0xa16cf0(0xff)]||_0x144307[_0xa16cf0(0xff)]<=0x0)throw new Error(_0xa16cf0(0xbf));let _0x138415=_0x144307[_0xa16cf0(0xec)]||_0xa16cf0(0xf5);_0x2d49e7===_0xa16cf0(0x15f)&&(_0x138415=_0xa16cf0(0x143),console[_0xa16cf0(0x14a)](_0xa16cf0(0xe5)));this['validateKlymeCurrency'](_0x2d49e7,_0x138415);const _0x23d870=process['env'][_0xa16cf0(0x150)]||_0xa16cf0(0x147),{finalSuccessUrl:_0x5803d7,finalFailUrl:_0x35466f,dbSuccessUrl:_0x28f217,dbFailUrl:_0xe88cae}=this['generateGatewayUrls'](_0x2d49e7,_0xa16cf0(0x112),_0x23d870,_0x144307[_0xa16cf0(0xf6)],_0x144307[_0xa16cf0(0x11e)]),_0x17eec8=await database_1[_0xa16cf0(0xc6)][_0xa16cf0(0xcf)]['create']({'data':{'shopId':_0x4d2d07,'amount':_0x144307[_0xa16cf0(0xff)],'currency':_0x138415,'sourceCurrency':_0x144307[_0xa16cf0(0xd1)]||undefined,'gateway':_0x2d49e7,'maxPayments':_0x144307[_0xa16cf0(0xd3)]||0x1,'currentPayments':0x0,'status':_0xa16cf0(0xfe),'expiresAt':_0x144307[_0xa16cf0(0x116)]?new Date(_0x144307[_0xa16cf0(0x116)]):undefined,'successUrl':_0x28f217,'failUrl':_0xe88cae,'country':_0x5346ec,'language':_0x144307['language']||'EN'},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});return console['log'](_0xa16cf0(0x111)+_0x17eec8['id']+'\x20('+_0x2d49e7+')'),console[_0xa16cf0(0x14a)](_0xa16cf0(0xe9)+_0x17eec8[_0xa16cf0(0xff)]+'\x20'+_0x17eec8[_0xa16cf0(0xec)]),console[_0xa16cf0(0x14a)](_0xa16cf0(0xdb)+_0x17eec8['id']),console[_0xa16cf0(0x14a)](_0xa16cf0(0x13d)+_0x17eec8[_0xa16cf0(0xf6)]),console[_0xa16cf0(0x14a)](_0xa16cf0(0x149)+_0x17eec8[_0xa16cf0(0x11e)]),this[_0xa16cf0(0x13f)](_0x17eec8);}async[a45_0x2b2936(0x110)](_0x3ae875,_0x482edd){const _0x47b9a5=a45_0x2b2936,{page:_0x1604cf,limit:_0x2335bb,status:_0x420882,gateway:_0x4a07e5,search:_0x1fc599}=_0x482edd,_0x58f9a0=(_0x1604cf-0x1)*_0x2335bb,_0x2a2a1c={'shopId':_0x3ae875};_0x420882&&(_0x2a2a1c[_0x47b9a5(0x145)]=_0x420882[_0x47b9a5(0xc3)]());if(_0x4a07e5){if((0x0,gateway_1['isValidGatewayId'])(_0x4a07e5)){const _0x523f97=(0x0,gateway_1['getGatewayNameById'])(_0x4a07e5);_0x523f97&&(_0x2a2a1c[_0x47b9a5(0x122)]=_0x523f97);}else _0x2a2a1c[_0x47b9a5(0x122)]=_0x4a07e5[_0x47b9a5(0xf3)]();}_0x1fc599&&(_0x2a2a1c['OR']=[{'gateway':{'contains':_0x1fc599,'mode':_0x47b9a5(0xde)}},{'currency':{'contains':_0x1fc599,'mode':'insensitive'}}]);const [_0x501776,_0x3acdf1]=await Promise[_0x47b9a5(0x13b)]([database_1[_0x47b9a5(0xc6)][_0x47b9a5(0xcf)]['findMany']({'where':_0x2a2a1c,'skip':_0x58f9a0,'take':_0x2335bb,'orderBy':{'createdAt':_0x47b9a5(0x159)},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x47b9a5(0x159)},'take':0xa}}}),database_1[_0x47b9a5(0xc6)][_0x47b9a5(0xcf)][_0x47b9a5(0x104)]({'where':_0x2a2a1c})]);return{'links':_0x501776[_0x47b9a5(0x134)](_0x2e9357=>this[_0x47b9a5(0x13f)](_0x2e9357)),'pagination':{'page':_0x1604cf,'limit':_0x2335bb,'total':_0x3acdf1,'totalPages':Math[_0x47b9a5(0x12a)](_0x3acdf1/_0x2335bb)}};}async['getPaymentLinkById'](_0x2120f9,_0xa30405){const _0x2333ca=a45_0x2b2936,_0x5d56a4=await database_1['default'][_0x2333ca(0xcf)][_0x2333ca(0x109)]({'where':{'id':_0xa30405,'shopId':_0x2120f9},'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2333ca(0x159)}}}});if(!_0x5d56a4)return null;return this['formatPaymentLinkResponse'](_0x5d56a4);}async[a45_0x2b2936(0x120)](_0x3ed609,_0x3302ee,_0x85476d){const _0x2b352d=a45_0x2b2936,_0x39e1da={..._0x85476d};if(_0x85476d[_0x2b352d(0x122)]){if((0x0,gateway_1[_0x2b352d(0x15d)])(_0x85476d[_0x2b352d(0x122)])){const _0x4824e9=(0x0,gateway_1[_0x2b352d(0x132)])(_0x85476d[_0x2b352d(0x122)]);_0x4824e9&&(_0x39e1da[_0x2b352d(0x122)]=_0x4824e9);}else _0x39e1da[_0x2b352d(0x122)]=_0x85476d[_0x2b352d(0x122)][_0x2b352d(0xf3)]();}(_0x39e1da[_0x2b352d(0x122)]==='rapyd'||_0x85476d['country']&&_0x39e1da[_0x2b352d(0x122)]!=='rapyd')&&(_0x39e1da[_0x2b352d(0x122)]===_0x2b352d(0x144)&&(_0x39e1da[_0x2b352d(0xed)]='GB',console[_0x2b352d(0x14a)](_0x2b352d(0xc5))));_0x39e1da[_0x2b352d(0x122)]===_0x2b352d(0x15f)&&(_0x39e1da[_0x2b352d(0xec)]='EUR',console[_0x2b352d(0x14a)](_0x2b352d(0x133)));_0x39e1da[_0x2b352d(0x122)]&&_0x39e1da[_0x2b352d(0xec)]&&this[_0x2b352d(0x146)](_0x39e1da[_0x2b352d(0x122)],_0x39e1da[_0x2b352d(0xec)]);_0x85476d[_0x2b352d(0x116)]&&(_0x39e1da[_0x2b352d(0x116)]=new Date(_0x85476d[_0x2b352d(0x116)]));const _0x3d4c91=await database_1[_0x2b352d(0xc6)][_0x2b352d(0xcf)]['update']({'where':{'id':_0x3302ee,'shopId':_0x3ed609},'data':_0x39e1da,'include':{'shop':{'select':{'name':!![],'username':!![]}},'payments':{'select':{'id':!![],'amount':!![],'currency':!![],'status':!![],'customerEmail':!![],'customerName':!![],'createdAt':!![],'paidAt':!![]},'orderBy':{'createdAt':_0x2b352d(0x159)},'take':0xa}}});return this[_0x2b352d(0x13f)](_0x3d4c91);}async[a45_0x2b2936(0xd7)](_0x4a7425,_0x2166f6){const _0x46c50d=a45_0x2b2936;await database_1['default'][_0x46c50d(0xcf)][_0x46c50d(0x117)]({'where':{'id':_0x2166f6,'shopId':_0x4a7425}});}async[a45_0x2b2936(0x130)](_0x106149){const _0x54082f=a45_0x2b2936,_0x3721a3=await database_1[_0x54082f(0xc6)][_0x54082f(0xcf)][_0x54082f(0x107)]({'where':{'id':_0x106149},'include':{'shop':{'select':{'name':!![],'status':!![]}}}});if(!_0x3721a3)return null;const _0x5c0491=_0x3721a3[_0x54082f(0x116)]&&_0x3721a3[_0x54082f(0x116)]<new Date(),_0xca2bcb=_0x3721a3['currentPayments']>=_0x3721a3[_0x54082f(0xd3)],_0x4daae9=_0x3721a3[_0x54082f(0x15b)][_0x54082f(0x145)]===_0x54082f(0xfe),_0x438911=_0x3721a3[_0x54082f(0x145)]===_0x54082f(0xfe),_0x12e080=!_0x5c0491&&!_0xca2bcb&&_0x4daae9&&_0x438911,_0x38ebe6=Math['max'](0x0,_0x3721a3['maxPayments']-_0x3721a3[_0x54082f(0x14c)]);return{'id':_0x3721a3['id'],'amount':_0x3721a3[_0x54082f(0xff)],'currency':_0x3721a3['currency'],'sourceCurrency':_0x3721a3[_0x54082f(0xd1)]||undefined,'gateway':_0x3721a3[_0x54082f(0x122)],'maxPayments':_0x3721a3[_0x54082f(0xd3)],'currentPayments':_0x3721a3['currentPayments'],'status':_0x3721a3[_0x54082f(0x145)],'expiresAt':_0x3721a3[_0x54082f(0x116)]||undefined,'shopName':_0x3721a3[_0x54082f(0x15b)][_0x54082f(0x160)],'isAvailable':_0x12e080,'remainingPayments':_0x38ebe6};}async[a45_0x2b2936(0xe7)](_0x446414){const _0x253552=a45_0x2b2936,{linkId:_0x593de5,customerEmail:_0xbee455,customerName:_0x2cc0c6}=_0x446414,_0x2ae9a5=await database_1[_0x253552(0xc6)][_0x253552(0xcf)][_0x253552(0x107)]({'where':{'id':_0x593de5},'include':{'shop':{'select':{'id':!![],'name':!![],'status':!![]}}}});if(!_0x2ae9a5)throw new Error('Payment\x20link\x20not\x20found');const _0x71c315=_0x2ae9a5['expiresAt']&&_0x2ae9a5['expiresAt']<new Date(),_0x48c5e9=_0x2ae9a5[_0x253552(0x14c)]>=_0x2ae9a5[_0x253552(0xd3)],_0xe6e4d7=_0x2ae9a5[_0x253552(0x15b)][_0x253552(0x145)]===_0x253552(0xfe),_0xdd08d1=_0x2ae9a5[_0x253552(0x145)]===_0x253552(0xfe);if(_0x71c315)throw new Error(_0x253552(0x158));if(_0x48c5e9)throw new Error(_0x253552(0xe3));if(!_0xe6e4d7)throw new Error(_0x253552(0x11b));if(!_0xdd08d1)throw new Error(_0x253552(0x138));const _0x5845c7=_0x2ae9a5['amount'];console[_0x253552(0x14a)]('üí≥\x20Initiating\x20payment\x20from\x20link\x20'+_0x593de5+':\x20'+_0x5845c7+'\x20'+_0x2ae9a5['currency']),console[_0x253552(0x14a)](_0x253552(0xcd)+(_0x2cc0c6||_0x253552(0xc9))+'\x20('+(_0xbee455||_0x253552(0x14f))+')'),this['validateKlymeCurrency'](_0x2ae9a5[_0x253552(0x122)],_0x2ae9a5['currency']);const _0x28d44e=this[_0x253552(0x10d)]();console[_0x253552(0x14a)]('üéØ\x20Generated\x20gateway\x20order_id:\x20'+_0x28d44e+'\x20(8digits-8digits\x20format\x20for\x20'+_0x2ae9a5[_0x253552(0x122)]+')');const _0x3b69d1=process[_0x253552(0xe0)]['BASE_URL']||_0x253552(0x147),{finalSuccessUrl:_0x22856e,finalFailUrl:_0xbe8275,dbSuccessUrl:_0x7d2002,dbFailUrl:_0x38c300}=this[_0x253552(0xc1)](_0x2ae9a5['gateway'],_0x28d44e,_0x3b69d1,_0x2ae9a5['successUrl']||undefined,_0x2ae9a5[_0x253552(0x11e)]||undefined),_0x3106ad=await database_1[_0x253552(0xc6)]['payment'][_0x253552(0x151)]({'data':{'shopId':_0x2ae9a5[_0x253552(0xcc)],'paymentLinkId':_0x2ae9a5['id'],'gateway':_0x2ae9a5['gateway'],'amount':_0x5845c7,'currency':_0x2ae9a5[_0x253552(0xec)],'sourceCurrency':_0x2ae9a5[_0x253552(0xd1)]||undefined,'usage':_0x253552(0x101),'expiresAt':_0x2ae9a5[_0x253552(0x116)]||undefined,'successUrl':_0x7d2002,'failUrl':_0x38c300,'status':_0x253552(0xfc),'orderId':null,'gatewayOrderId':_0x28d44e,'customerEmail':_0xbee455||undefined,'customerName':_0x2cc0c6||undefined,'country':_0x2ae9a5[_0x253552(0xed)]||undefined,'language':_0x2ae9a5[_0x253552(0x12d)]||undefined,'amountIsEditable':![],'maxPayments':0x1}});console[_0x253552(0x14a)](_0x253552(0xee)+_0x3106ad['id']),console[_0x253552(0x14a)](_0x253552(0x124)+_0x5845c7+'\x20'+_0x2ae9a5['currency']),console[_0x253552(0x14a)](_0x253552(0xcd)+(_0x2cc0c6||_0x253552(0xc9))+'\x20('+(_0xbee455||_0x253552(0x14f))+')'),console['log'](_0x253552(0x123)+_0x7d2002),console[_0x253552(0x14a)](_0x253552(0xeb)+_0x38c300);let _0x21f590,_0x149d4f;try{if(_0x2ae9a5[_0x253552(0x122)]==='plisio'){console[_0x253552(0x14a)](_0x253552(0xdc)),console[_0x253552(0x14a)](_0x253552(0x108)+_0x2ae9a5[_0x253552(0xec)]),console[_0x253552(0x14a)]('\x20\x20\x20-\x20link.sourceCurrency\x20(crypto\x20currency\x20for\x20payment):\x20'+_0x2ae9a5[_0x253552(0xd1)]);const _0x1aad36=await this['plisioService']['createPayment']({'paymentId':_0x3106ad['id'],'orderId':_0x28d44e,'amount':_0x5845c7,'currency':_0x2ae9a5[_0x253552(0xec)],'productName':_0x253552(0x140)+_0x5845c7+'\x20'+_0x2ae9a5[_0x253552(0xec)],'description':_0x253552(0x140)+_0x5845c7+'\x20'+_0x2ae9a5[_0x253552(0xec)],'successUrl':_0x22856e,'failUrl':_0xbe8275,'customerEmail':_0xbee455||undefined,'customerName':_0x2cc0c6||undefined,'isSourceCurrency':!![],'sourceCurrency':_0x2ae9a5['sourceCurrency']||undefined});_0x21f590=_0x1aad36[_0x253552(0xea)],_0x149d4f=_0x1aad36[_0x253552(0x121)],await database_1[_0x253552(0xc6)]['payment'][_0x253552(0x152)]({'where':{'id':_0x3106ad['id']},'data':{'externalPaymentUrl':_0x149d4f,'gatewayPaymentId':_0x21f590,'invoiceTotalSum':Number(_0x1aad36[_0x253552(0x10b)]),'qrCode':_0x1aad36[_0x253552(0xcb)],'qrUrl':_0x1aad36[_0x253552(0xf7)]}});const _0x5b622e=_0x253552(0xf9)+_0x3106ad['id'];return console[_0x253552(0x14a)](_0x253552(0xda)+_0x5b622e),{'paymentId':_0x3106ad['id'],'paymentUrl':_0x5b622e,'expiresAt':_0x3106ad[_0x253552(0x116)]||undefined};}else{if(_0x2ae9a5[_0x253552(0x122)]===_0x253552(0x144)){const _0x22544c=await this['rapydService'][_0x253552(0xd5)]({'paymentId':_0x3106ad['id'],'orderId':_0x28d44e,'orderName':'Payment\x20'+_0x5845c7+'\x20'+_0x2ae9a5[_0x253552(0xec)],'amount':_0x5845c7,'currency':_0x2ae9a5[_0x253552(0xec)],'country':_0x2ae9a5[_0x253552(0xed)],'language':_0x2ae9a5[_0x253552(0x12d)]||'EN','amountIsEditable':![],'usage':_0x253552(0x101),'maxPayments':0x1,'successUrl':_0x22856e,'failUrl':_0xbe8275});_0x21f590=_0x22544c[_0x253552(0xea)],_0x149d4f=_0x22544c[_0x253552(0x121)],await database_1['default'][_0x253552(0x11d)][_0x253552(0x152)]({'where':{'id':_0x3106ad['id']},'data':{'externalPaymentUrl':_0x149d4f,'gatewayPaymentId':_0x21f590}});const _0x533186=_0x253552(0xf0)+_0x3106ad['id'];return console[_0x253552(0x14a)](_0x253552(0xe2)+_0x533186),{'paymentId':_0x3106ad['id'],'paymentUrl':_0x533186,'expiresAt':_0x3106ad[_0x253552(0x116)]||undefined};}else{if(_0x2ae9a5[_0x253552(0x122)]===_0x253552(0xbc)){const _0x3225dc=await this[_0x253552(0x13e)][_0x253552(0xd5)]({'paymentId':_0x3106ad['id'],'orderId':_0x28d44e,'name':_0x253552(0x140)+_0x5845c7+'\x20'+_0x2ae9a5['currency'],'paymentDescription':_0x253552(0x140)+_0x5845c7+'\x20'+_0x2ae9a5['currency'],'amount':_0x5845c7,'currency':_0x2ae9a5[_0x253552(0xec)],'webhookUrl':_0x253552(0xc4),'returnUrl':_0x22856e,'expiryDate':_0x2ae9a5[_0x253552(0x116)]?.['toISOString']()});_0x21f590=_0x3225dc['gateway_payment_id'],_0x149d4f=_0x3225dc[_0x253552(0x121)],await database_1[_0x253552(0xc6)][_0x253552(0x11d)][_0x253552(0x152)]({'where':{'id':_0x3106ad['id']},'data':{'externalPaymentUrl':_0x149d4f,'gatewayPaymentId':_0x21f590,'qrUrl':_0x3225dc[_0x253552(0x100)]}});const _0x147074=_0x253552(0xf0)+_0x3106ad['id'];return console['log'](_0x253552(0x128)+_0x147074),{'paymentId':_0x3106ad['id'],'paymentUrl':_0x147074,'expiresAt':_0x3106ad[_0x253552(0x116)]||undefined};}else{if(_0x2ae9a5[_0x253552(0x122)]===_0x253552(0x15f)){console['log'](_0x253552(0x127)+_0x28d44e+_0x253552(0x148)),console['log'](_0x253552(0x124)+_0x5845c7+_0x253552(0x131));const _0x101a5f=await this[_0x253552(0x15c)][_0x253552(0xd5)]({'paymentId':_0x3106ad['id'],'orderId':_0x28d44e,'amount':_0x5845c7});_0x21f590=_0x101a5f[_0x253552(0xea)],_0x149d4f=_0x101a5f[_0x253552(0x121)],await database_1[_0x253552(0xc6)]['payment']['update']({'where':{'id':_0x3106ad['id']},'data':{'externalPaymentUrl':_0x149d4f,'gatewayPaymentId':_0x21f590}});const _0x155aca='https://tesoft.uk/gateway/payment.php?id='+_0x3106ad['id'];return console[_0x253552(0x14a)](_0x253552(0xe4)+_0x155aca),{'paymentId':_0x3106ad['id'],'paymentUrl':_0x155aca,'expiresAt':_0x3106ad[_0x253552(0x116)]||undefined};}else{if(_0x2ae9a5[_0x253552(0x122)]['startsWith'](_0x253552(0x114))){const _0x2f8ef3=(0x0,gateway_1[_0x253552(0xc2)])(_0x2ae9a5[_0x253552(0x122)]);if(!_0x2f8ef3)throw new Error(_0x253552(0xe6)+_0x2ae9a5[_0x253552(0x122)]);console[_0x253552(0x14a)](_0x253552(0x119)+_0x2f8ef3+_0x253552(0xf8)+_0x28d44e+_0x253552(0x148)),console[_0x253552(0x14a)](_0x253552(0x124)+_0x5845c7+'\x20'+_0x2ae9a5[_0x253552(0xec)]+_0x253552(0x106)+_0x2f8ef3+')');const _0x4cfcb8=await this['klymeService'][_0x253552(0xd5)]({'paymentId':_0x3106ad['id'],'orderId':_0x28d44e,'amount':_0x5845c7,'currency':_0x2ae9a5[_0x253552(0xec)],'region':_0x2f8ef3,'redirectUrl':_0x22856e});_0x21f590=_0x4cfcb8[_0x253552(0xea)],_0x149d4f=_0x4cfcb8[_0x253552(0x121)],await database_1[_0x253552(0xc6)]['payment'][_0x253552(0x152)]({'where':{'id':_0x3106ad['id']},'data':{'externalPaymentUrl':_0x149d4f,'gatewayPaymentId':_0x21f590}});const _0x327e57=_0x253552(0xf9)+_0x3106ad['id'];return console[_0x253552(0x14a)]('‚úÖ\x20KLYME\x20'+_0x2f8ef3+_0x253552(0x15a)+_0x28d44e),console[_0x253552(0x14a)](_0x253552(0xf1)+_0x2f8ef3+_0x253552(0x11a)+_0x327e57),{'paymentId':_0x3106ad['id'],'paymentUrl':_0x327e57,'expiresAt':_0x3106ad[_0x253552(0x116)]||undefined};}else throw new Error('Unsupported\x20gateway:\x20'+_0x2ae9a5[_0x253552(0x122)]);}}}}}catch(_0x87de41){await database_1[_0x253552(0xc6)][_0x253552(0x11d)][_0x253552(0x152)]({'where':{'id':_0x3106ad['id']},'data':{'status':_0x253552(0x13a)}});throw new Error(_0x253552(0x14b)+(_0x87de41 instanceof Error?_0x87de41[_0x253552(0xd8)]:_0x253552(0x12c)));}}async[a45_0x2b2936(0xfd)](_0x2d0ec6){const _0x470394=a45_0x2b2936,_0xddbe69=await database_1['default'][_0x470394(0x11d)][_0x470394(0x107)]({'where':{'id':_0x2d0ec6},'include':{'paymentLink':!![]}});if(!_0xddbe69||!_0xddbe69[_0x470394(0xcf)])return;const _0x284076=await database_1[_0x470394(0xc6)]['paymentLink']['update']({'where':{'id':_0xddbe69['paymentLinkId']},'data':{'currentPayments':{'increment':0x1}}});console[_0x470394(0x14a)]('üìà\x20Payment\x20link\x20'+_0xddbe69[_0x470394(0x135)]+_0x470394(0xf4)+_0x284076[_0x470394(0x14c)]+'/'+_0x284076[_0x470394(0xd3)]),_0x284076[_0x470394(0x14c)]>=_0x284076[_0x470394(0xd3)]&&(await database_1['default']['paymentLink']['update']({'where':{'id':_0xddbe69['paymentLinkId']},'data':{'status':_0x470394(0x125)}}),console[_0x470394(0x14a)](_0x470394(0xe1)+_0xddbe69['paymentLinkId']+_0x470394(0x10f)));}async[a45_0x2b2936(0xef)](_0x1702d1){const _0x13d1c9=a45_0x2b2936,[_0x2149fa,_0x1149c8,_0x39ca8f,_0x2bb345]=await Promise[_0x13d1c9(0x13b)]([database_1[_0x13d1c9(0xc6)][_0x13d1c9(0xcf)][_0x13d1c9(0x104)]({'where':{'shopId':_0x1702d1}}),database_1[_0x13d1c9(0xc6)][_0x13d1c9(0xcf)]['count']({'where':{'shopId':_0x1702d1,'status':'ACTIVE'}}),database_1[_0x13d1c9(0xc6)]['payment']['count']({'where':{'shopId':_0x1702d1,'paymentLinkId':{'not':null}}}),database_1['default'][_0x13d1c9(0x11d)]['findMany']({'where':{'shopId':_0x1702d1,'paymentLinkId':{'not':null},'status':'PAID'},'select':{'amount':!![],'currency':!![]}})]);let _0x502d35=0x0;for(const _0x570f1b of _0x2bb345){const _0x28e151=await currencyService_1[_0x13d1c9(0xd6)][_0x13d1c9(0x155)](_0x570f1b[_0x13d1c9(0xff)],_0x570f1b[_0x13d1c9(0xec)]);_0x502d35+=_0x28e151;}const _0x2773f3=_0x39ca8f>0x0?_0x2bb345[_0x13d1c9(0x13c)]/_0x39ca8f*0x64:0x0;return{'totalLinks':_0x2149fa,'activeLinks':_0x1149c8,'totalPayments':_0x39ca8f,'totalRevenue':Math[_0x13d1c9(0x153)](_0x502d35*0x64)/0x64,'conversionRate':Math['round'](_0x2773f3*0x64)/0x64};}[a45_0x2b2936(0x13f)](_0x2fd7cd){const _0x5bee1b=a45_0x2b2936;return{'id':_0x2fd7cd['id'],'shopId':_0x2fd7cd['shopId'],'amount':_0x2fd7cd[_0x5bee1b(0xff)],'currency':_0x2fd7cd[_0x5bee1b(0xec)],'sourceCurrency':_0x2fd7cd[_0x5bee1b(0xd1)]||undefined,'gateway':_0x2fd7cd[_0x5bee1b(0x122)],'maxPayments':_0x2fd7cd[_0x5bee1b(0xd3)],'currentPayments':_0x2fd7cd[_0x5bee1b(0x14c)],'status':_0x2fd7cd[_0x5bee1b(0x145)],'expiresAt':_0x2fd7cd['expiresAt']||undefined,'successUrl':_0x2fd7cd[_0x5bee1b(0xf6)]||undefined,'failUrl':_0x2fd7cd[_0x5bee1b(0x11e)]||undefined,'country':_0x2fd7cd[_0x5bee1b(0xed)]||undefined,'language':_0x2fd7cd['language']||undefined,'linkUrl':'https://app.trapay.uk/link/'+_0x2fd7cd['id'],'createdAt':_0x2fd7cd[_0x5bee1b(0x15e)],'updatedAt':_0x2fd7cd[_0x5bee1b(0xfb)],'shop':_0x2fd7cd[_0x5bee1b(0x15b)],'payments':_0x2fd7cd['payments']};}}exports[a45_0x2b2936(0x12b)]=PaymentLinkService;