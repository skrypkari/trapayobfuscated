'use strict';const a35_0x397083=a35_0x3ba0;(function(_0x1e1b57,_0x485430){const _0x2a8568=a35_0x3ba0,_0x550252=_0x1e1b57();while(!![]){try{const _0x3bc1e0=-parseInt(_0x2a8568(0x8d))/0x1+-parseInt(_0x2a8568(0x8e))/0x2+-parseInt(_0x2a8568(0xd6))/0x3*(-parseInt(_0x2a8568(0x79))/0x4)+-parseInt(_0x2a8568(0xa8))/0x5+parseInt(_0x2a8568(0x8a))/0x6+parseInt(_0x2a8568(0xac))/0x7+-parseInt(_0x2a8568(0xd8))/0x8*(-parseInt(_0x2a8568(0x69))/0x9);if(_0x3bc1e0===_0x485430)break;else _0x550252['push'](_0x550252['shift']());}catch(_0x37397f){_0x550252['push'](_0x550252['shift']());}}}(a35_0x1fce,0xd0e91));var __importDefault=this&&this[a35_0x397083(0xc6)]||function(_0x350afb){const _0x3e19ea=a35_0x397083;return _0x350afb&&_0x350afb[_0x3e19ea(0x7a)]?_0x350afb:{'default':_0x350afb};};function a35_0x1fce(){const _0x2b538f=['update','webhookUrl','length','findMany','stringify','shopId','Payment\x20not\x20found','bankDetails','CoinToPayStatusService','ðŸ”\x20Checking\x20CoinToPay\x20payment\x20','error','1629hsQjQi','\x20details:','settings','Unknown\x20error','checkPaymentStatus','getServiceStats','push','cointopay_status_check_error','sendShopWebhook','paid','ðŸ“Š\x20Payment\x20','CHECK_INTERVAL_MS','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Bank\x20Details:\x20','checkSinglePayment','\x20pending\x20CoinToPay\x20payments','3604qaDgfP','__esModule','â°\x20Checking\x20for\x20CoinToPay\x20payments\x20older\x20than\x20','\x20days\x20without\x20payment\x20confirmation','orderId','webhookEvents','gatewayPaymentId','ms)','webhookLog','âš ï¸\x20Payment\x20','iban','log','\x20days\x20(created\x20before\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','coinToPayStatusService','logShopWebhookError','\x20CoinToPay\x20payments','7253178YWzrvF','\x20status:\x20','payment','1248986nabFXt','1856984oeDfkc','Automatically\x20expired\x20after\x20','not\x20found','checkInterval','stopPeriodicStatusCheck','ðŸª™\x20No\x20pending\x20CoinToPay\x20payments\x20to\x20check','sendPaymentStatusNotification','0100','ðŸ”„\x20Updating\x20payment\x20','FAILED','\x20with\x20status\x20','now','\x20expired\x20CoinToPay\x20payments','getDate','createdAt','ðŸ†”\x20Transaction\x20ID:\x20','checkExpiredPayments','Success','getTime','status','\x20updated\x20successfully','adminNotes','payment.failed','toLowerCase','cointopay','./gateways/coinToPayService','6288565XhzGAH','ðŸ’°\x20Payment\x20','Failed\x20to\x20check\x20payment\x20','transactionId','4090772SfzYtu','cointopay_status_check_','logWhiteDomainError','ðŸª™\x20Starting\x20CoinToPay\x20periodic\x20status\x20checking\x20(every\x201\x20hour)','/status/','\x20days','logShopWebhookSent','TesSoft\x20Payment\x20System/1.0','Periodic\x20CoinToPay\x20status\x20check\x20failed:','toISOString','âœ…\x20Transaction\x20confirmed\x20on:\x20','checkAllPendingPayments','\x20to\x20','PAID','create','webhook_send','../config/database','Failed\x20to\x20check\x20CoinToPay\x20payment\x20','\x20days,\x20marking\x20as\x20EXPIRED','Failed\x20to\x20get\x20pending\x20CoinToPay\x20payments:','coinToPayService','expired','text','./telegramBotService','EXPIRY_DAYS','gateway','__importDefault','amount','\x20marked\x20as\x20EXPIRED\x20due\x20to\x20','startPeriodicStatusCheck','paymentDetails','message','\x20has\x20no\x20gatewayPaymentId,\x20skipping','remitterIban','confirmedOn','Initial\x20CoinToPay\x20status\x20check\x20failed:','catch','includes','ðŸ›‘\x20CoinToPay\x20status\x20checking\x20stopped','paidAt','\x20status\x20unchanged\x20(','default','1893wgFimD','setDate','85264EyGZbd','findUnique','floor','shop','-day\x20timeout','loggerService','âœ…\x20Payment\x20','EXPIRED','currency','customerName','not\x20confirmed','Payment\x20older\x20than\x20','created','â°\x20Found\x20','checkPaymentById'];a35_0x1fce=function(){return _0x2b538f;};return a35_0x1fce();}Object['defineProperty'](exports,a35_0x397083(0x7a),{'value':!![]}),exports[a35_0x397083(0x87)]=exports[a35_0x397083(0xef)]=void 0x0;const coinToPayService_1=require(a35_0x397083(0xa7)),database_1=__importDefault(require(a35_0x397083(0xbc))),telegramBotService_1=require(a35_0x397083(0xc3)),loggerService_1=require('./loggerService');class CoinToPayStatusService{constructor(){const _0x488de6=a35_0x397083;this[_0x488de6(0x91)]=null,this['CHECK_INTERVAL_MS']=0x3c*0x3c*0x3e8,this[_0x488de6(0xc4)]=0x5,this[_0x488de6(0xc0)]=new coinToPayService_1['CoinToPayService']();}[a35_0x397083(0xc9)](){const _0x17399c=a35_0x397083;console[_0x17399c(0x84)](_0x17399c(0xaf)),this[_0x17399c(0xb7)]()[_0x17399c(0xd0)](_0x46fb27=>{const _0x3fc5e0=_0x17399c;console[_0x3fc5e0(0xf1)](_0x3fc5e0(0xcf),_0x46fb27);}),this[_0x17399c(0x91)]=setInterval(async()=>{const _0x1a576f=_0x17399c;try{await this[_0x1a576f(0xb7)]();}catch(_0x289c09){console[_0x1a576f(0xf1)](_0x1a576f(0xb4),_0x289c09);}},this['CHECK_INTERVAL_MS']),console[_0x17399c(0x84)]('âœ…\x20CoinToPay\x20status\x20checking\x20service\x20started\x20(hourly\x20checks)');}[a35_0x397083(0x92)](){const _0x24160e=a35_0x397083;this[_0x24160e(0x91)]&&(clearInterval(this[_0x24160e(0x91)]),this[_0x24160e(0x91)]=null,console[_0x24160e(0x84)](_0x24160e(0xd2)));}async[a35_0x397083(0xb7)](){const _0x2ab6f4=a35_0x397083;try{const _0x4401ff=await database_1[_0x2ab6f4(0xd5)][_0x2ab6f4(0x8c)][_0x2ab6f4(0xea)]({'where':{'gateway':_0x2ab6f4(0xa6),'status':'PENDING','gatewayPaymentId':{'not':null}},'select':{'id':!![],'gatewayPaymentId':!![],'amount':!![],'currency':!![],'status':!![],'shopId':!![],'createdAt':!![],'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(_0x4401ff[_0x2ab6f4(0xe9)]===0x0){console['log'](_0x2ab6f4(0x93));return;}console['log']('ðŸª™\x20Checking\x20'+_0x4401ff[_0x2ab6f4(0xe9)]+_0x2ab6f4(0x78));const _0x240819=await this['checkExpiredPayments'](_0x4401ff);console[_0x2ab6f4(0x84)](_0x2ab6f4(0xe5)+_0x240819[_0x2ab6f4(0xe9)]+_0x2ab6f4(0x9a));for(const _0x37c3c8 of _0x4401ff){try{if(_0x240819[_0x2ab6f4(0xd1)](_0x37c3c8['id'])){console[_0x2ab6f4(0x84)]('â°\x20Payment\x20'+_0x37c3c8['id']+'\x20already\x20marked\x20as\x20expired,\x20skipping\x20status\x20check');continue;}await this[_0x2ab6f4(0x77)](_0x37c3c8),await new Promise(_0x53e24c=>setTimeout(_0x53e24c,0x7d0));}catch(_0x2d1306){console[_0x2ab6f4(0xf1)](_0x2ab6f4(0xbd)+_0x37c3c8['id']+':',_0x2d1306),loggerService_1[_0x2ab6f4(0xdd)][_0x2ab6f4(0xae)](_0x2ab6f4(0xa6),_0x2ab6f4(0xb0)+_0x37c3c8[_0x2ab6f4(0x7f)],_0x2d1306);}}console[_0x2ab6f4(0x84)]('âœ…\x20Completed\x20checking\x20'+_0x4401ff['length']+_0x2ab6f4(0x89));}catch(_0x12a98f){console[_0x2ab6f4(0xf1)](_0x2ab6f4(0xbf),_0x12a98f);}}async[a35_0x397083(0x9e)](_0x24cf76){const _0x1aa722=a35_0x397083,_0x2371a6=[],_0x5d2ea6=new Date();_0x5d2ea6[_0x1aa722(0xd7)](_0x5d2ea6[_0x1aa722(0x9b)]()-this['EXPIRY_DAYS']),console['log'](_0x1aa722(0x7b)+this[_0x1aa722(0xc4)]+_0x1aa722(0x85)+_0x5d2ea6[_0x1aa722(0xb5)]()+')');for(const _0x3a31f4 of _0x24cf76){if(_0x3a31f4['createdAt']<_0x5d2ea6){console[_0x1aa722(0x84)]('â°\x20Payment\x20'+_0x3a31f4['id']+'\x20is\x20older\x20than\x20'+this[_0x1aa722(0xc4)]+_0x1aa722(0xbe));try{await database_1[_0x1aa722(0xd5)]['payment'][_0x1aa722(0xe7)]({'where':{'id':_0x3a31f4['id']},'data':{'status':'EXPIRED','updatedAt':new Date(),'adminNotes':_0x1aa722(0x8f)+this[_0x1aa722(0xc4)]+_0x1aa722(0x7c)}}),await database_1[_0x1aa722(0xd5)][_0x1aa722(0x81)][_0x1aa722(0xba)]({'data':{'paymentId':_0x3a31f4['id'],'shopId':_0x3a31f4['shopId'],'event':'cointopay_auto_expired','statusCode':0xc8,'responseBody':JSON[_0x1aa722(0xeb)]({'reason':_0x1aa722(0xe3)+this[_0x1aa722(0xc4)]+_0x1aa722(0xb1),'createdAt':_0x3a31f4['createdAt'],'expiredAt':new Date()[_0x1aa722(0xb5)](),'daysSinceCreation':Math[_0x1aa722(0xda)]((Date[_0x1aa722(0x99)]()-_0x3a31f4['createdAt'][_0x1aa722(0xa0)]())/(0x3e8*0x3c*0x3c*0x18))})}}),await this['sendShopWebhook'](_0x3a31f4,_0x1aa722(0xdf)),await this[_0x1aa722(0x94)](_0x3a31f4,'EXPIRED'),_0x2371a6[_0x1aa722(0x6f)](_0x3a31f4['id']),console['log'](_0x1aa722(0xde)+_0x3a31f4['id']+_0x1aa722(0xc8)+this[_0x1aa722(0xc4)]+_0x1aa722(0xdc));}catch(_0x279789){console[_0x1aa722(0xf1)]('Failed\x20to\x20expire\x20payment\x20'+_0x3a31f4['id']+':',_0x279789);}}}return _0x2371a6;}async[a35_0x397083(0x77)](_0x1d1b2b){const _0x498dd4=a35_0x397083;if(!_0x1d1b2b[_0x498dd4(0x7f)]){console['log'](_0x498dd4(0x82)+_0x1d1b2b['id']+_0x498dd4(0xcc));return;}console[_0x498dd4(0x84)](_0x498dd4(0xf0)+_0x1d1b2b['id']+'\x20('+_0x1d1b2b[_0x498dd4(0x7f)]+')');try{const _0x1706fd=await this[_0x498dd4(0xc0)][_0x498dd4(0x6d)](_0x1d1b2b[_0x498dd4(0x7f)]);console['log'](_0x498dd4(0x73)+_0x1d1b2b['id']+_0x498dd4(0x8b)+_0x1706fd[_0x498dd4(0xa1)]);_0x1706fd[_0x498dd4(0xca)]&&console[_0x498dd4(0x84)]('ðŸ“Š\x20Payment\x20'+_0x1d1b2b['id']+_0x498dd4(0x6a),{'iban':_0x1706fd[_0x498dd4(0xca)]['iban']||_0x498dd4(0x90),'transactionId':_0x1706fd[_0x498dd4(0xca)][_0x498dd4(0xab)],'createdOn':_0x1706fd[_0x498dd4(0xca)]['createdOn'],'confirmedOn':_0x1706fd[_0x498dd4(0xca)][_0x498dd4(0xce)]||_0x498dd4(0xe2)});if(_0x1706fd[_0x498dd4(0xa1)]!==_0x1d1b2b[_0x498dd4(0xa1)]){console['log'](_0x498dd4(0x96)+_0x1d1b2b['id']+'\x20status\x20from\x20'+_0x1d1b2b[_0x498dd4(0xa1)]+_0x498dd4(0xb8)+_0x1706fd[_0x498dd4(0xa1)]);const _0x2b77e2={'status':_0x1706fd[_0x498dd4(0xa1)],'updatedAt':new Date()};_0x1706fd['status']===_0x498dd4(0xb9)&&_0x1d1b2b[_0x498dd4(0xa1)]!==_0x498dd4(0xb9)&&(_0x2b77e2[_0x498dd4(0xd3)]=new Date(),console[_0x498dd4(0x84)](_0x498dd4(0xa9)+_0x1d1b2b['id']+'\x20marked\x20as\x20paid\x20at:\x20'+_0x2b77e2[_0x498dd4(0xd3)][_0x498dd4(0xb5)]()));if(_0x1706fd[_0x498dd4(0xca)]){const _0x30ff0a=_0x1706fd[_0x498dd4(0xca)];_0x30ff0a['iban']&&(_0x2b77e2[_0x498dd4(0xcd)]=_0x30ff0a[_0x498dd4(0x83)],console[_0x498dd4(0x84)]('ðŸ¦\x20Saved\x20IBAN:\x20'+_0x30ff0a[_0x498dd4(0x83)]));if(_0x30ff0a[_0x498dd4(0xee)]){const _0xb02610=_0x1d1b2b['adminNotes']||'',_0xc2828c=_0x498dd4(0x76)+_0x30ff0a[_0x498dd4(0xee)];_0x2b77e2[_0x498dd4(0xa3)]=_0xb02610?_0xb02610+'\x0a\x0a'+_0xc2828c:_0xc2828c,console['log']('ðŸ¦\x20Saved\x20bank\x20details\x20to\x20admin\x20notes');}_0x30ff0a[_0x498dd4(0xab)]&&console[_0x498dd4(0x84)](_0x498dd4(0x9d)+_0x30ff0a['transactionId']),_0x30ff0a[_0x498dd4(0xce)]&&console[_0x498dd4(0x84)](_0x498dd4(0xb6)+_0x30ff0a[_0x498dd4(0xce)]);}await database_1[_0x498dd4(0xd5)][_0x498dd4(0x8c)][_0x498dd4(0xe7)]({'where':{'id':_0x1d1b2b['id']},'data':_0x2b77e2}),await database_1[_0x498dd4(0xd5)][_0x498dd4(0x81)]['create']({'data':{'paymentId':_0x1d1b2b['id'],'shopId':_0x1d1b2b['shopId'],'event':_0x498dd4(0xad)+_0x1706fd[_0x498dd4(0xa1)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x498dd4(0xeb)]({'oldStatus':_0x1d1b2b[_0x498dd4(0xa1)],'newStatus':_0x1706fd['status'],'paymentDetails':_0x1706fd[_0x498dd4(0xca)],'checkedAt':new Date()['toISOString']()})}}),await this[_0x498dd4(0x71)](_0x1d1b2b,_0x1706fd[_0x498dd4(0xa1)]),await this[_0x498dd4(0x94)](_0x1d1b2b,_0x1706fd[_0x498dd4(0xa1)]),console[_0x498dd4(0x84)](_0x498dd4(0xde)+_0x1d1b2b['id']+_0x498dd4(0xa2));}else console['log'](_0x498dd4(0x73)+_0x1d1b2b['id']+_0x498dd4(0xd4)+_0x1706fd[_0x498dd4(0xa1)]+')');}catch(_0x1ef71d){console[_0x498dd4(0xf1)](_0x498dd4(0xaa)+_0x1d1b2b['id']+':',_0x1ef71d),await database_1[_0x498dd4(0xd5)][_0x498dd4(0x81)]['create']({'data':{'paymentId':_0x1d1b2b['id'],'shopId':_0x1d1b2b['shopId'],'event':_0x498dd4(0x70),'statusCode':0x1f4,'responseBody':JSON[_0x498dd4(0xeb)]({'error':_0x1ef71d instanceof Error?_0x1ef71d[_0x498dd4(0xcb)]:_0x498dd4(0x6c),'gatewayPaymentId':_0x1d1b2b['gatewayPaymentId'],'checkedAt':new Date()[_0x498dd4(0xb5)]()})}});}}async[a35_0x397083(0x71)](_0x590d7b,_0xe57e26){const _0x96cf1f=a35_0x397083,_0x2978c1=Date['now']();try{const _0x1bf3fe=_0x590d7b[_0x96cf1f(0xdb)],_0x50980e=_0x1bf3fe[_0x96cf1f(0x6b)];if(!_0x50980e?.[_0x96cf1f(0xe8)]){console[_0x96cf1f(0x84)](_0x96cf1f(0x86)+_0x1bf3fe['id']);return;}const _0x2a1d02=_0xe57e26===_0x96cf1f(0xb9)?'payment.success':_0xe57e26===_0x96cf1f(0x97)?_0x96cf1f(0xa4):_0xe57e26===_0x96cf1f(0xdf)?'payment.failed':'payment.pending';if(!_0x50980e[_0x96cf1f(0x7e)]?.['includes'](_0x2a1d02)){console[_0x96cf1f(0x84)]('Webhook\x20event\x20'+_0x2a1d02+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1bf3fe['id']);return;}const _0x56560c={'event':_0x2a1d02,'payment':{'id':_0x590d7b['id'],'order_id':_0x590d7b[_0x96cf1f(0x7d)],'gateway_order_id':_0x590d7b['gatewayOrderId'],'gateway':_0x96cf1f(0x95),'amount':_0x590d7b[_0x96cf1f(0xc7)],'currency':_0x590d7b[_0x96cf1f(0xe0)],'status':_0xe57e26[_0x96cf1f(0xa5)](),'customer_email':_0x590d7b['customerEmail'],'customer_name':_0x590d7b[_0x96cf1f(0xe1)],'created_at':_0x590d7b[_0x96cf1f(0x9c)],'updated_at':new Date()}},_0x541cff=await fetch(_0x50980e['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x96cf1f(0xb3)},'body':JSON[_0x96cf1f(0xeb)](_0x56560c)}),_0x1d2ed0=Date[_0x96cf1f(0x99)]()-_0x2978c1,_0x3aaba8=_0x541cff['ok']?_0x96cf1f(0x9f):await _0x541cff[_0x96cf1f(0xc2)]();loggerService_1[_0x96cf1f(0xdd)][_0x96cf1f(0xb2)](_0x590d7b['shopId'],_0x50980e[_0x96cf1f(0xe8)],_0x2a1d02,_0x541cff['status'],_0x1d2ed0,_0x56560c),console[_0x96cf1f(0x84)]('Shop\x20webhook\x20sent\x20to\x20'+_0x50980e['webhookUrl']+_0x96cf1f(0x98)+_0x541cff[_0x96cf1f(0xa1)]+'\x20('+_0x1d2ed0+_0x96cf1f(0x80));}catch(_0x468220){console['error']('Failed\x20to\x20send\x20shop\x20webhook:',_0x468220),loggerService_1[_0x96cf1f(0xdd)][_0x96cf1f(0x88)](_0x590d7b[_0x96cf1f(0xec)],_0x590d7b['shop']?.[_0x96cf1f(0x6b)]?.[_0x96cf1f(0xe8)]||'unknown',_0x96cf1f(0xbb),_0x468220,{});}}async[a35_0x397083(0x94)](_0x368d29,_0x2cf144){const _0x34d0c5=a35_0x397083;try{const _0x35cd83={'PENDING':_0x34d0c5(0xe4),'PAID':_0x34d0c5(0x72),'FAILED':'failed','EXPIRED':_0x34d0c5(0xc1)},_0x416496=_0x35cd83[_0x2cf144];if(!_0x416496||_0x416496===_0x34d0c5(0xe4))return;await telegramBotService_1['telegramBotService']['sendPaymentNotification'](_0x368d29[_0x34d0c5(0xec)],_0x368d29,_0x416496);}catch(_0x1f56a2){console['error'](_0x34d0c5(0x75),_0x1f56a2);}}async[a35_0x397083(0xe6)](_0x45f991){const _0xea15e6=a35_0x397083,_0xe900ec=await database_1[_0xea15e6(0xd5)][_0xea15e6(0x8c)][_0xea15e6(0xd9)]({'where':{'id':_0x45f991},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe900ec)throw new Error(_0xea15e6(0xed));if(_0xe900ec[_0xea15e6(0xc5)]!=='cointopay')throw new Error('Payment\x20is\x20not\x20a\x20CoinToPay\x20payment');await this[_0xea15e6(0x77)](_0xe900ec);}[a35_0x397083(0x6e)](){const _0x357f23=a35_0x397083,_0x4b9054=this[_0x357f23(0x91)]?this[_0x357f23(0x74)]:undefined;return{'isActive':!!this[_0x357f23(0x91)],'checkIntervalMinutes':this['CHECK_INTERVAL_MS']/(0x3e8*0x3c),'expiryDays':this[_0x357f23(0xc4)],'nextCheckIn':_0x4b9054};}}function a35_0x3ba0(_0x53e50a,_0x45dae7){const _0x1fceb3=a35_0x1fce();return a35_0x3ba0=function(_0x3ba051,_0x12cd79){_0x3ba051=_0x3ba051-0x69;let _0x472737=_0x1fceb3[_0x3ba051];return _0x472737;},a35_0x3ba0(_0x53e50a,_0x45dae7);}exports[a35_0x397083(0xef)]=CoinToPayStatusService,exports[a35_0x397083(0x87)]=new CoinToPayStatusService();