'use strict';const a47_0x1a71a1=a47_0x11d0;function a47_0x2f8f(){const _0x326c9e=['api_error','Shop\x20not\x20found','notificationPayout','name','default','261575xVuPvk','max','refund','__esModule','notificationLogin','shopSettings','New\x20password\x20must\x20be\x20at\x20least\x206\x20characters\x20long','webhookEvents','92771AAQYsD','login','SettingsService','2309690qQosxy','2772972CpTxsX','154qXISCs','chatId','pk_','payout','Password\x20confirmation\x20is\x20incorrect','../config/database','parseWebhookEvents','delete','hex','2EbfaAw','29094BNqCBz','maskApiKey','deleteAccount','2848PjCvMo','notificationApiError','updateWebhookSettings','telegramChatId','24QgJqHd','getShopSettings','substring','settings','compare','isArray','update','webhookUrl','22oQQhVa','payment_failed','telegram','toString','shopUrl','shop','sk_','findUnique','ensureSettingsExist','randomBytes','881991IDFurM','notificationPaymentFailed','crypto','defineProperty','payment_success','length','1455Jultxa','New\x20password\x20and\x20confirmation\x20do\x20not\x20match','botApiKey','telegramBotApiKey','updateTelegramSettings','changePassword','Current\x20password\x20is\x20incorrect','notificationPaymentSuccess','hash','parse','repeat','create','password'];a47_0x2f8f=function(){return _0x326c9e;};return a47_0x2f8f();}(function(_0x5805ab,_0x1c43b5){const _0x195c97=a47_0x11d0,_0x5ae6ff=_0x5805ab();while(!![]){try{const _0x253a77=parseInt(_0x195c97(0x192))/0x1*(parseInt(_0x195c97(0x158))/0x2)+parseInt(_0x195c97(0x178))/0x3*(-parseInt(_0x195c97(0x15c))/0x4)+-parseInt(_0x195c97(0x18a))/0x5+-parseInt(_0x195c97(0x159))/0x6*(-parseInt(_0x195c97(0x14f))/0x7)+parseInt(_0x195c97(0x160))/0x8*(-parseInt(_0x195c97(0x172))/0x9)+parseInt(_0x195c97(0x14d))/0xa+-parseInt(_0x195c97(0x168))/0xb*(-parseInt(_0x195c97(0x14e))/0xc);if(_0x253a77===_0x1c43b5)break;else _0x5ae6ff['push'](_0x5ae6ff['shift']());}catch(_0x57dfa5){_0x5ae6ff['push'](_0x5ae6ff['shift']());}}}(a47_0x2f8f,0x310f4));var __importDefault=this&&this['__importDefault']||function(_0x5798b6){const _0x565cf0=a47_0x11d0;return _0x5798b6&&_0x5798b6[_0x565cf0(0x18d)]?_0x5798b6:{'default':_0x5798b6};};function a47_0x11d0(_0x5d968b,_0x5c9b38){const _0x2f8f33=a47_0x2f8f();return a47_0x11d0=function(_0x11d0bb,_0x5d6ee8){_0x11d0bb=_0x11d0bb-0x14d;let _0x428e43=_0x2f8f33[_0x11d0bb];return _0x428e43;},a47_0x11d0(_0x5d968b,_0x5c9b38);}Object[a47_0x1a71a1(0x175)](exports,'__esModule',{'value':!![]}),exports['SettingsService']=void 0x0;const bcryptjs_1=__importDefault(require('bcryptjs')),crypto_1=__importDefault(require(a47_0x1a71a1(0x174))),database_1=__importDefault(require(a47_0x1a71a1(0x154)));class SettingsService{[a47_0x1a71a1(0x15a)](_0x416815){const _0x481650=a47_0x1a71a1;if(!_0x416815)return'';if(_0x416815['length']<=0x8)return _0x416815;const _0xf38895=_0x416815[_0x481650(0x162)](0x0,0x8),_0x4350aa='*'[_0x481650(0x182)](Math[_0x481650(0x18b)](0x0,_0x416815['length']-0x8));return _0xf38895+_0x4350aa;}[a47_0x1a71a1(0x155)](_0xf0568e){const _0x9084af=a47_0x1a71a1;if(!_0xf0568e)return[];if(Array[_0x9084af(0x165)](_0xf0568e))return _0xf0568e;if(typeof _0xf0568e==='string')try{const _0x3f8cf7=JSON[_0x9084af(0x181)](_0xf0568e);return Array[_0x9084af(0x165)](_0x3f8cf7)?_0x3f8cf7:[];}catch{return[];}return[];}async[a47_0x1a71a1(0x161)](_0x2f2582){const _0x1e8db5=a47_0x1a71a1,_0x4845d9=await database_1[_0x1e8db5(0x189)]['shop'][_0x1e8db5(0x16f)]({'where':{'id':_0x2f2582},'include':{'settings':!![]}});if(!_0x4845d9)throw new Error(_0x1e8db5(0x186));let _0x42f05e=_0x4845d9[_0x1e8db5(0x163)];return!_0x42f05e&&(_0x42f05e=await database_1[_0x1e8db5(0x189)][_0x1e8db5(0x18f)]['create']({'data':{'shopId':_0x4845d9['id']}})),{'fullName':_0x4845d9[_0x1e8db5(0x188)],'brand':_0x4845d9['name'],'merchantUrl':_0x4845d9[_0x1e8db5(0x16c)],'telegramUsername':_0x4845d9[_0x1e8db5(0x16a)],'telegramBotApiKey':_0x42f05e[_0x1e8db5(0x17b)]?this[_0x1e8db5(0x15a)](_0x42f05e[_0x1e8db5(0x17b)]):null,'telegramChatId':_0x42f05e[_0x1e8db5(0x15f)],'webhookUrl':_0x42f05e['webhookUrl'],'webhookEvents':this[_0x1e8db5(0x155)](_0x42f05e[_0x1e8db5(0x191)]),'notifications':{'payment_success':_0x42f05e[_0x1e8db5(0x17f)],'payment_failed':_0x42f05e[_0x1e8db5(0x173)],'refund':_0x42f05e['notificationRefund'],'payout':_0x42f05e['notificationPayout'],'login':_0x42f05e['notificationLogin'],'api_error':_0x42f05e['notificationApiError']}};}async[a47_0x1a71a1(0x17d)](_0x283af5,_0x593122){const _0x496527=a47_0x1a71a1,{currentPassword:_0xfba158,newPassword:_0x3aff7d,confirmNewPassword:_0x5ebc5d}=_0x593122;if(_0x3aff7d!==_0x5ebc5d)throw new Error(_0x496527(0x179));if(_0x3aff7d[_0x496527(0x177)]<0x6)throw new Error(_0x496527(0x190));const _0x37fd02=await database_1[_0x496527(0x189)][_0x496527(0x16d)][_0x496527(0x16f)]({'where':{'id':_0x283af5},'select':{'password':!![]}});if(!_0x37fd02)throw new Error(_0x496527(0x186));const _0x5dec55=await bcryptjs_1[_0x496527(0x189)][_0x496527(0x164)](_0xfba158,_0x37fd02['password']);if(!_0x5dec55)throw new Error(_0x496527(0x17e));const _0x2eca54=await bcryptjs_1['default'][_0x496527(0x180)](_0x3aff7d,0xc);await database_1[_0x496527(0x189)]['shop'][_0x496527(0x166)]({'where':{'id':_0x283af5},'data':{'password':_0x2eca54}});}async['updateNotifications'](_0x5739fd,_0x43c34c){const _0x56aa24=a47_0x1a71a1;await this[_0x56aa24(0x170)](_0x5739fd);const _0xe9af48={};_0x43c34c[_0x56aa24(0x176)]!==undefined&&(_0xe9af48[_0x56aa24(0x17f)]=_0x43c34c['payment_success']),_0x43c34c[_0x56aa24(0x169)]!==undefined&&(_0xe9af48[_0x56aa24(0x173)]=_0x43c34c[_0x56aa24(0x169)]),_0x43c34c[_0x56aa24(0x18c)]!==undefined&&(_0xe9af48['notificationRefund']=_0x43c34c[_0x56aa24(0x18c)]),_0x43c34c[_0x56aa24(0x152)]!==undefined&&(_0xe9af48[_0x56aa24(0x187)]=_0x43c34c[_0x56aa24(0x152)]),_0x43c34c[_0x56aa24(0x193)]!==undefined&&(_0xe9af48[_0x56aa24(0x18e)]=_0x43c34c['login']),_0x43c34c[_0x56aa24(0x185)]!==undefined&&(_0xe9af48[_0x56aa24(0x15d)]=_0x43c34c[_0x56aa24(0x185)]),await database_1[_0x56aa24(0x189)][_0x56aa24(0x18f)]['update']({'where':{'shopId':_0x5739fd},'data':_0xe9af48});}async[a47_0x1a71a1(0x17c)](_0x205105,_0x55cb6a){const _0x24529b=a47_0x1a71a1;await this['ensureSettingsExist'](_0x205105);const _0x38b919={};_0x55cb6a[_0x24529b(0x17a)]!==undefined&&(_0x38b919['telegramBotApiKey']=_0x55cb6a[_0x24529b(0x17a)]||null),_0x55cb6a[_0x24529b(0x150)]!==undefined&&(_0x38b919['telegramChatId']=_0x55cb6a[_0x24529b(0x150)]||null),await database_1[_0x24529b(0x189)][_0x24529b(0x18f)][_0x24529b(0x166)]({'where':{'shopId':_0x205105},'data':_0x38b919});}async[a47_0x1a71a1(0x15e)](_0x3bbece,_0x1a49ff){const _0x9ea8c5=a47_0x1a71a1;await this['ensureSettingsExist'](_0x3bbece);const _0x1f55fd={};_0x1a49ff[_0x9ea8c5(0x167)]!==undefined&&(_0x1f55fd[_0x9ea8c5(0x167)]=_0x1a49ff[_0x9ea8c5(0x167)]||null),_0x1a49ff[_0x9ea8c5(0x191)]!==undefined&&(_0x1f55fd[_0x9ea8c5(0x191)]=_0x1a49ff[_0x9ea8c5(0x191)]||[]),await database_1[_0x9ea8c5(0x189)]['shopSettings'][_0x9ea8c5(0x166)]({'where':{'shopId':_0x3bbece},'data':_0x1f55fd});}async['revokeAllApiKeys'](_0x52cf70){const _0x56c8f5=a47_0x1a71a1,_0xdbbcfd=_0x56c8f5(0x151)+crypto_1[_0x56c8f5(0x189)][_0x56c8f5(0x171)](0x20)[_0x56c8f5(0x16b)](_0x56c8f5(0x157)),_0x4422c9=_0x56c8f5(0x16e)+crypto_1[_0x56c8f5(0x189)][_0x56c8f5(0x171)](0x20)[_0x56c8f5(0x16b)](_0x56c8f5(0x157));await database_1[_0x56c8f5(0x189)]['shop']['update']({'where':{'id':_0x52cf70},'data':{'publicKey':_0xdbbcfd,'secretKey':_0x4422c9}});}async[a47_0x1a71a1(0x15b)](_0x2b14ce,_0x43c951){const _0x11cf0b=a47_0x1a71a1,{passwordConfirmation:_0x4f7c01}=_0x43c951,_0x1ba7f1=await database_1[_0x11cf0b(0x189)][_0x11cf0b(0x16d)][_0x11cf0b(0x16f)]({'where':{'id':_0x2b14ce},'select':{'password':!![]}});if(!_0x1ba7f1)throw new Error('Shop\x20not\x20found');const _0x2cf1bd=await bcryptjs_1['default'][_0x11cf0b(0x164)](_0x4f7c01,_0x1ba7f1[_0x11cf0b(0x184)]);if(!_0x2cf1bd)throw new Error(_0x11cf0b(0x153));await database_1[_0x11cf0b(0x189)][_0x11cf0b(0x16d)][_0x11cf0b(0x156)]({'where':{'id':_0x2b14ce}});}async['ensureSettingsExist'](_0x17393c){const _0x859990=a47_0x1a71a1,_0x59d043=await database_1['default']['shopSettings'][_0x859990(0x16f)]({'where':{'shopId':_0x17393c}});!_0x59d043&&await database_1[_0x859990(0x189)][_0x859990(0x18f)][_0x859990(0x183)]({'data':{'shopId':_0x17393c}});}}exports[a47_0x1a71a1(0x194)]=SettingsService;