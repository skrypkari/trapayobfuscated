'use strict';const a16_0x3d950d=a16_0x2ce8;(function(_0x95cdc3,_0x399364){const _0x202ee9=a16_0x2ce8,_0x6f8f21=_0x95cdc3();while(!![]){try{const _0x556cea=parseInt(_0x202ee9(0x1ef))/0x1+parseInt(_0x202ee9(0x212))/0x2+-parseInt(_0x202ee9(0x1f2))/0x3*(-parseInt(_0x202ee9(0x219))/0x4)+parseInt(_0x202ee9(0x1fc))/0x5+parseInt(_0x202ee9(0x203))/0x6*(-parseInt(_0x202ee9(0x1f6))/0x7)+-parseInt(_0x202ee9(0x214))/0x8*(parseInt(_0x202ee9(0x205))/0x9)+-parseInt(_0x202ee9(0x1d0))/0xa;if(_0x556cea===_0x399364)break;else _0x6f8f21['push'](_0x6f8f21['shift']());}catch(_0x1e78c6){_0x6f8f21['push'](_0x6f8f21['shift']());}}}(a16_0x5400,0xef9bc));var __importDefault=this&&this[a16_0x3d950d(0x204)]||function(_0x414728){const _0x23c638=a16_0x3d950d;return _0x414728&&_0x414728[_0x23c638(0x225)]?_0x414728:{'default':_0x414728};};Object[a16_0x3d950d(0x1ea)](exports,a16_0x3d950d(0x225),{'value':!![]}),exports[a16_0x3d950d(0x23e)]=void 0x0;function a16_0x2ce8(_0xa27b24,_0x37587e){_0xa27b24=_0xa27b24-0x1cf;const _0x54009e=a16_0x5400();let _0x2ce821=_0x54009e[_0xa27b24];return _0x2ce821;}const squirrelPayService_1=require(a16_0x3d950d(0x239)),currencyService_1=require(a16_0x3d950d(0x22d)),webhookService_1=require(a16_0x3d950d(0x240)),database_1=__importDefault(require('../config/database')),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0xf6010f){const _0x2680f1=a16_0x3d950d;return ISO_COUNTRY_CODES[_0x2680f1(0x1e9)](_0xf6010f[_0x2680f1(0x1e7)]());}class SquirrelPayController{constructor(){const _0x3c5d68=a16_0x3d950d;this[_0x3c5d68(0x224)]=async(_0x1fb808,_0x4f1a3e,_0x555ef2)=>{const _0x2f9de8=_0x3c5d68;try{const {paymentId:_0x8c4401}=_0x1fb808['params'],{card_number:_0xa45b59,exp_month:_0x1eadd6,exp_year:_0x540825,cvv:_0x1e221c,holder_name:_0x33ad06,customer_email:_0x164647,customer_birth_date:_0x422740,billing_country:_0x40f506,customer_phone:_0x14bdce,billing_address:_0x121772,billing_city:_0x197825,billing_state:_0x3079e1,billing_zip:_0x1513be}=_0x1fb808[_0x2f9de8(0x236)];console[_0x2f9de8(0x1e4)]('üêøÔ∏è\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x8c4401);if(!_0xa45b59||!_0x1eadd6||!_0x540825||!_0x1e221c||!_0x33ad06||!_0x164647)return _0x4f1a3e['status'](0x190)[_0x2f9de8(0x234)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x40f506&&!isValidCountryCode(_0x40f506))return _0x4f1a3e['status'](0x190)[_0x2f9de8(0x234)]({'success':![],'message':_0x2f9de8(0x1d6)});const _0x2b5daa=await database_1['default'][_0x2f9de8(0x1ff)][_0x2f9de8(0x1d3)]({'where':{'id':_0x8c4401},'include':{'shop':!![]}});if(!_0x2b5daa)return _0x4f1a3e[_0x2f9de8(0x21b)](0x194)[_0x2f9de8(0x234)]({'success':![],'message':_0x2f9de8(0x1e0)});if(_0x2b5daa['status']!==_0x2f9de8(0x206))return _0x4f1a3e[_0x2f9de8(0x21b)](0x190)['json']({'success':![],'message':_0x2f9de8(0x1f4)});const _0x5ecc99=(0x0,ipHelper_1[_0x2f9de8(0x237)])(_0x1fb808),_0x3bee90={'number':_0xa45b59[_0x2f9de8(0x1e3)](/\s/g,''),'exp_month':_0x1eadd6['toString']()['padStart'](0x2,'0'),'exp_year':_0x540825[_0x2f9de8(0x223)](),'verification_value':_0x1e221c,'holder':_0x33ad06[_0x2f9de8(0x1e7)]()},_0x228bb6={'ip':_0x5ecc99,'email':_0x164647};_0x422740&&(_0x228bb6[_0x2f9de8(0x218)]=_0x422740);let _0x5bd7cf;_0x40f506&&(_0x5bd7cf={'country':_0x40f506,'address':_0x121772,'city':_0x197825,'state':_0x3079e1,'zip':_0x1513be});const _0x27a0f6=(process[_0x2f9de8(0x1e1)]['FRONTEND_URL']||_0x2f9de8(0x20a))+_0x2f9de8(0x21c)+_0x8c4401+'&payment_id='+(_0x2b5daa['gatewayOrderId']||_0x8c4401),_0x467082=(process[_0x2f9de8(0x1e1)][_0x2f9de8(0x1f8)]||_0x2f9de8(0x22a))+'/api/webhooks/squirrel-pay',_0xabf1b5=_0x8c4401[_0x2f9de8(0x1f0)](0x0,0x8)+'-'+_0x8c4401[_0x2f9de8(0x1f0)](0x8,0x10);console['log'](_0x2f9de8(0x1fe)),console['log'](_0x2f9de8(0x1cf)+_0x8c4401),console[_0x2f9de8(0x1e4)](_0x2f9de8(0x1d7)+_0x2b5daa[_0x2f9de8(0x1fa)]+'\x20'+_0x2b5daa[_0x2f9de8(0x231)]),console['log'](_0x2f9de8(0x1f5)+_0x164647+'\x20('+_0x5ecc99+')'),console['log']('\x20\x20\x20Billing\x20Country:\x20'+(_0x40f506||'not\x20provided')),console[_0x2f9de8(0x1e4)](_0x2f9de8(0x1d2)+_0xabf1b5);const _0x3295fe=await this[_0x2f9de8(0x226)][_0x2f9de8(0x224)](Math[_0x2f9de8(0x222)](_0x2b5daa['amount']*0x64),_0x2b5daa[_0x2f9de8(0x231)],_0xabf1b5,_0x27a0f6,_0x467082,_0x3bee90,_0x228bb6,_0x5bd7cf,_0x14bdce),_0x336d44=this[_0x2f9de8(0x226)][_0x2f9de8(0x201)](_0x3295fe),_0x260d90={'gatewayPaymentId':_0x3295fe[_0x2f9de8(0x20b)],'cardLast4':_0x336d44[_0x2f9de8(0x213)],'gateway':'squirrelpay','customerEmail':_0x164647,'customerPhone':_0x14bdce,'customerBirthDate':_0x422740,'billingAddress':_0x121772,'billingCity':_0x197825,'billingState':_0x3079e1,'billingZip':_0x1513be,'customerCountry':_0x40f506};if(_0x336d44[_0x2f9de8(0x21b)]===_0x2f9de8(0x1ec)){_0x260d90[_0x2f9de8(0x21b)]='PAID',_0x260d90['paidAt']=new Date();try{const _0x2f76b3=await this['currencyService']['convertToUSDT'](_0x2b5daa[_0x2f9de8(0x1fa)],_0x2b5daa[_0x2f9de8(0x231)]);_0x260d90[_0x2f9de8(0x211)]=_0x2f76b3,console[_0x2f9de8(0x1e4)](_0x2f9de8(0x20d)+_0x2f76b3+_0x2f9de8(0x23d));const _0x32ca94=await this[_0x2f9de8(0x22b)][_0x2f9de8(0x1fb)](_0x2b5daa[_0x2f9de8(0x1dc)],_0x2b5daa[_0x2f9de8(0x216)]),_0x2499b3=_0x2f76b3*(0x1-_0x32ca94/0x64);_0x260d90[_0x2f9de8(0x228)]=_0x2499b3,_0x260d90[_0x2f9de8(0x1ed)]=_0x32ca94,console['log'](_0x2f9de8(0x1fd)+_0x2b5daa[_0x2f9de8(0x216)]+_0x2f9de8(0x1e8)+_0x32ca94+'%'),console[_0x2f9de8(0x1e4)]('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x2499b3[_0x2f9de8(0x238)](0x6)+_0x2f9de8(0x23d));}catch(_0x565c2c){console[_0x2f9de8(0x208)]('‚ùå\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x565c2c),_0x260d90['amountUSDT']=0x0,_0x260d90[_0x2f9de8(0x228)]=0x0,_0x260d90[_0x2f9de8(0x1ed)]=0x0;}}else _0x336d44[_0x2f9de8(0x21b)]==='FAILED'&&(_0x260d90[_0x2f9de8(0x21b)]=_0x2f9de8(0x227),_0x260d90[_0x2f9de8(0x233)]=_0x336d44[_0x2f9de8(0x233)]);const _0x5e3563=await database_1[_0x2f9de8(0x1d5)][_0x2f9de8(0x1ff)]['update']({'where':{'id':_0x8c4401},'data':_0x260d90});console[_0x2f9de8(0x1e4)](_0x2f9de8(0x21e)+_0x5e3563[_0x2f9de8(0x21b)]);let _0x2b4892;if(_0x336d44[_0x2f9de8(0x21b)]===_0x2f9de8(0x227))_0x2b4892=_0x336d44[_0x2f9de8(0x233)]||_0x3295fe['friendly_message']||_0x2f9de8(0x235);else _0x336d44['status']===_0x2f9de8(0x206)?_0x2b4892=_0x3295fe[_0x2f9de8(0x1d9)]||_0x2f9de8(0x22f):_0x2b4892=_0x3295fe[_0x2f9de8(0x1d9)]||_0x2f9de8(0x23c);const _0x1f4fd7={'success':_0x336d44[_0x2f9de8(0x21b)]!==_0x2f9de8(0x227),'status':_0x336d44[_0x2f9de8(0x21b)],'message':_0x2b4892,'payment':{'id':_0x8c4401,'status':_0x5e3563[_0x2f9de8(0x21b)],'gateway':_0x2f9de8(0x23b),'last4':_0x336d44[_0x2f9de8(0x213)]}};_0x336d44[_0x2f9de8(0x215)]&&(_0x1f4fd7[_0x2f9de8(0x207)]=_0x336d44[_0x2f9de8(0x215)],_0x1f4fd7[_0x2f9de8(0x22c)]=!![],console[_0x2f9de8(0x1e4)](_0x2f9de8(0x1eb)+_0x336d44['redirectUrl'])),_0x4f1a3e[_0x2f9de8(0x234)](_0x1f4fd7);}catch(_0x4c6a64){console['error']('‚ùå\x20SquirrelPay\x20card\x20payment\x20error:',_0x4c6a64),_0x555ef2(_0x4c6a64);}},this[_0x3c5d68(0x20e)]=async(_0x58a75b,_0x32160f,_0x4e4329)=>{const _0x12da5f=_0x3c5d68;try{console[_0x12da5f(0x1e4)](_0x12da5f(0x1f9)),console[_0x12da5f(0x1e4)](_0x12da5f(0x1dd),_0x58a75b[_0x12da5f(0x202)]),console['log'](_0x12da5f(0x1e5),_0x58a75b[_0x12da5f(0x236)]),this[_0x12da5f(0x226)][_0x12da5f(0x1e2)]({'headers':_0x58a75b['headers'],'body':_0x58a75b[_0x12da5f(0x236)],'timestamp':new Date()[_0x12da5f(0x1ee)]()});const _0x394c21=_0x58a75b[_0x12da5f(0x236)];if(!_0x394c21[_0x12da5f(0x20b)]||!_0x394c21[_0x12da5f(0x21b)])return console[_0x12da5f(0x21a)](_0x12da5f(0x200)),_0x32160f['status'](0x190)[_0x12da5f(0x234)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x63b6f4;_0x394c21[_0x12da5f(0x20b)]&&(_0x63b6f4=await database_1['default'][_0x12da5f(0x1ff)][_0x12da5f(0x209)]({'where':{'gatewayPaymentId':_0x394c21[_0x12da5f(0x20b)],'gateway':_0x12da5f(0x23b)}}));if(!_0x63b6f4)return console[_0x12da5f(0x21a)](_0x12da5f(0x1e6)),console['warn'](_0x12da5f(0x1df)+_0x394c21[_0x12da5f(0x20b)]),console[_0x12da5f(0x21a)]('\x20\x20\x20Description:\x20'+_0x394c21[_0x12da5f(0x20f)]),console['warn'](_0x12da5f(0x1f1)),console['warn'](_0x12da5f(0x1f3)+_0x394c21[_0x12da5f(0x20b)]),_0x32160f[_0x12da5f(0x21b)](0x194)['json']({'success':![],'message':_0x12da5f(0x1e0)});console['log']('üîç\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x63b6f4['id']),console['log']('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x63b6f4[_0x12da5f(0x21b)]),console['log']('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x63b6f4[_0x12da5f(0x1d1)]),console[_0x12da5f(0x1e4)](_0x12da5f(0x1db)+_0x394c21[_0x12da5f(0x21b)]),console[_0x12da5f(0x1e4)](_0x12da5f(0x217)+_0x394c21[_0x12da5f(0x20b)]);let _0x145027=null;const _0x303bf7={};switch(_0x394c21[_0x12da5f(0x21b)]){case _0x12da5f(0x1f7):_0x145027=_0x12da5f(0x1ec),console[_0x12da5f(0x1e4)](_0x12da5f(0x229));break;case _0x12da5f(0x1d8):_0x145027=_0x12da5f(0x227),_0x303bf7['failureMessage']=_0x394c21[_0x12da5f(0x1d9)]||_0x394c21['message']||_0x12da5f(0x235),console['log'](_0x12da5f(0x22e)+_0x303bf7[_0x12da5f(0x233)]);break;case'incomplete':console[_0x12da5f(0x1e4)]('‚è≥\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console['warn'](_0x12da5f(0x21d)+_0x394c21[_0x12da5f(0x21b)]);break;}if(_0x145027&&_0x145027!==_0x63b6f4['status'])console['log']('üîÑ\x20Updating\x20payment\x20status\x20from\x20'+_0x63b6f4[_0x12da5f(0x21b)]+_0x12da5f(0x1de)+_0x145027),await this[_0x12da5f(0x22b)]['updatePaymentStatus'](_0x63b6f4['id'],_0x145027,_0x303bf7),console[_0x12da5f(0x1e4)]('‚úÖ\x20Payment\x20'+_0x63b6f4['id']+_0x12da5f(0x220)+_0x145027+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x145027&&console['log'](_0x12da5f(0x23a)+_0x63b6f4['id']+'\x20already\x20has\x20status\x20'+_0x145027+',\x20skipping\x20update');_0x32160f[_0x12da5f(0x21b)](0xc8)[_0x12da5f(0x234)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x294377){console[_0x12da5f(0x208)](_0x12da5f(0x21f),_0x294377),_0x4e4329(_0x294377);}},this['getWebhookLogs']=async(_0x1be662,_0x45d297,_0x279948)=>{const _0x12dc0c=_0x3c5d68;try{const {limit:_0x3a6bee}=_0x1be662['query'],_0x5f4e6c=this[_0x12dc0c(0x226)][_0x12dc0c(0x20c)](_0x3a6bee?parseInt(_0x3a6bee):0x32);_0x45d297[_0x12dc0c(0x234)]({'success':!![],'result':{'logs':_0x5f4e6c,'count':_0x5f4e6c['length']}});}catch(_0x5f5b4d){_0x279948(_0x5f5b4d);}},this[_0x3c5d68(0x226)]=new squirrelPayService_1[(_0x3c5d68(0x1da))]({'shopId':process[_0x3c5d68(0x1e1)][_0x3c5d68(0x221)]||'','secretKey':process[_0x3c5d68(0x1e1)]['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0x3c5d68(0x1e1)][_0x3c5d68(0x1d4)]||_0x3c5d68(0x232),'isTestMode':process[_0x3c5d68(0x1e1)]['SQUIRREL_PAY_TEST_MODE']===_0x3c5d68(0x23f)}),this[_0x3c5d68(0x230)]=new currencyService_1[(_0x3c5d68(0x210))](),this[_0x3c5d68(0x22b)]=new webhookService_1['WebhookService']();}}function a16_0x5400(){const _0x388c34=['9149520mYAcWh','üí∞\x20Gateway\x20','üìù\x20SquirrelPay\x20payment\x20details:','payment','‚ö†Ô∏è\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','getPaymentStatus','headers','5780658EqFECU','__importDefault','9dEBDqJ','PENDING','redirect_url','error','findFirst','https://app.trapay.uk','uid','getWebhookLogs','üí∞\x20Calculated\x20amountUSDT:\x20','handleWebhook','description','CurrencyService','amountUSDT','1177534fpEYco','cardLast4','8752864KhUEzB','redirectUrl','gateway','\x20\x20\x20Webhook\x20UID:\x20','birth_date','8FzHRgC','warn','status','/payment/pending?id=','‚ö†Ô∏è\x20Unknown\x20SquirrelPay\x20status:\x20','‚úÖ\x20SquirrelPay\x20payment\x20updated:\x20','‚ùå\x20SquirrelPay\x20webhook\x20error:','\x20updated:\x20status=','SQUIRREL_PAY_SHOP_ID','round','toString','processCardPayment','__esModule','squirrelPayService','FAILED','amountAfterGatewayCommissionUSDT','‚úÖ\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','https://api.trapay.uk','webhookService','requires_action','../services/currencyService','‚ùå\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','Payment\x20is\x20being\x20processed','currencyService','currency','https://gate.squirrel-pay.com','failureMessage','json','Payment\x20failed','body','getClientIP','toFixed','../services/gateways/squirrelPayService','‚ÑπÔ∏è\x20Payment\x20','squirrelpay','Payment\x20processed\x20successfully','\x20USDT','SquirrelPayController','true','../services/webhookService','\x20\x20\x20Payment\x20ID:\x20','5668330harNXv','gatewayPaymentId','\x20\x20\x20Description:\x20','findUnique','SQUIRREL_PAY_BASE_URL','default','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','\x20\x20\x20Amount:\x20','failed','friendly_message','SquirrelPayService','\x20\x20\x20Webhook\x20status:\x20','shopId','Headers:','\x20to\x20','\x20\x20\x20UID:\x20','Payment\x20not\x20found','env','logWebhook','replace','log','Body:','‚ö†Ô∏è\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','toUpperCase','\x20commission:\x20','has','defineProperty','üîÑ\x203D\x20Secure\x20redirect\x20required:\x20','PAID','gatewayCommissionRate','toISOString','407695ibDpfd','slice','\x20\x20\x20Gateway:\x20squirrelpay','1169181ypZwRR','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','Payment\x20is\x20not\x20in\x20pending\x20status','\x20\x20\x20Customer:\x20','7phbegI','successful','API_BASE_URL','üêøÔ∏è\x20SquirrelPay\x20webhook\x20received','amount','getGatewayCommission'];a16_0x5400=function(){return _0x388c34;};return a16_0x5400();}exports[a16_0x3d950d(0x23e)]=SquirrelPayController;