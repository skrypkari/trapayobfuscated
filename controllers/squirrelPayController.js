'use strict';const a19_0x121584=a19_0x337a;(function(_0x56c38d,_0x20788e){const _0x3bc682=a19_0x337a,_0x1b90fc=_0x56c38d();while(!![]){try{const _0x2802b2=parseInt(_0x3bc682(0x176))/0x1*(-parseInt(_0x3bc682(0x197))/0x2)+parseInt(_0x3bc682(0x179))/0x3*(-parseInt(_0x3bc682(0x1a6))/0x4)+-parseInt(_0x3bc682(0x1db))/0x5+parseInt(_0x3bc682(0x1c6))/0x6+-parseInt(_0x3bc682(0x1e7))/0x7*(-parseInt(_0x3bc682(0x1e9))/0x8)+parseInt(_0x3bc682(0x1b2))/0x9+parseInt(_0x3bc682(0x1bf))/0xa;if(_0x2802b2===_0x20788e)break;else _0x1b90fc['push'](_0x1b90fc['shift']());}catch(_0x17f414){_0x1b90fc['push'](_0x1b90fc['shift']());}}}(a19_0x5a34,0x7f7ff));var __importDefault=this&&this['__importDefault']||function(_0x1d2e3d){const _0x77f325=a19_0x337a;return _0x1d2e3d&&_0x1d2e3d[_0x77f325(0x1ed)]?_0x1d2e3d:{'default':_0x1d2e3d};};Object[a19_0x121584(0x1e0)](exports,a19_0x121584(0x1ed),{'value':!![]}),exports['SquirrelPayController']=void 0x0;function a19_0x337a(_0x5e7c95,_0x2f8fa2){_0x5e7c95=_0x5e7c95-0x173;const _0x5a3412=a19_0x5a34();let _0x337aef=_0x5a3412[_0x5e7c95];return _0x337aef;}const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a19_0x121584(0x181)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a19_0x121584(0x174))),ipHelper_1=require(a19_0x121584(0x1d4)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x52d879){const _0xecb7b6=a19_0x121584;return ISO_COUNTRY_CODES[_0xecb7b6(0x19c)](_0x52d879['toUpperCase']());}function a19_0x5a34(){const _0x3aea2e=['update','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','Webhook\x20processed\x20successfully','3385240gArYda','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','gatewayCommissionRate','friendly_message','headers','failureMessage','Payment\x20is\x20not\x20in\x20pending\x20status','1392258SqdVHw','redirect_url','length','\x20\x20\x20Gateway:\x20squirrelpay','/payment/pending?id=','âœ…\x20Payment\x20','Missing\x20required\x20card\x20or\x20customer\x20information','gatewayPaymentId','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','CurrencyService','log',',\x20skipping\x20update','findFirst','../utils/ipHelper','â„¹ï¸\x20Payment\x20','/api/webhooks/squirrel-pay','amountUSDT','toString','processCardPayment','last_4','3217500YnnswB','Payment\x20failed','phoneIsValid','handleWebhook','gatewayOrderId','defineProperty','SquirrelPayService','PAID','getWebhookLogs','message','failed','https://gate.squirrel-pay.com','7KDEhhZ','cardBrand','5634088yCDmTd','incomplete','cardLast4','redirectUrl','__esModule','uid','requires_action','\x20\x20\x20Webhook\x20status:\x20','../config/database','warn','8XvJxft','squirrelPayService','toFixed','3iyLvfH','getPaymentStatus','findUnique','toISOString','\x20\x20\x20Description:\x20','replace','Missing\x20required\x20fields\x20in\x20webhook','gateway','../services/currencyService','logWebhook','query','ðŸ’°\x20Calculated\x20amountUSDT:\x20','\x20\x20\x20Webhook\x20UID:\x20','\x20already\x20has\x20status\x20','FAILED','isValid','âŒ\x20SquirrelPay\x20webhook\x20error:','\x20updated:\x20status=','getClientIP','amountAfterGatewayCommissionUSDT','error','currencyService','not\x20provided','payment','default','webhookService','PENDING','&payment_id=','\x20\x20\x20Payment\x20ID:\x20','riskLevel','107746PVsYeX',',\x20balance\x20updated,\x20amountUSDT\x20calculated','status','WebhookService','phoneLineStatus','has','getGatewayCommission','ðŸ’°\x20Gateway\x20','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','\x20USDT','phoneRiskLevel','brand','\x20\x20\x20UID:\x20','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','500204GxbEBt','description','true','squirrelpay','json','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','\x20commission:\x20','SquirrelPayController','\x20\x20\x20Customer:\x20','Payment\x20not\x20found','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','padStart','4022514ZZJnUM','body','shopId','amount','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','updatePaymentStatus','payment_method','phoneIsVoip','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','currency'];a19_0x5a34=function(){return _0x3aea2e;};return a19_0x5a34();}class SquirrelPayController{constructor(){const _0x3566a1=a19_0x121584;this[_0x3566a1(0x1d9)]=async(_0xdfb79,_0x2af907,_0x4f2dc9)=>{const _0x1b90f1=_0x3566a1;try{const {paymentId:_0x4077a7}=_0xdfb79['params'],{card_number:_0x3870ef,exp_month:_0x5d664d,exp_year:_0x3d8234,cvv:_0x392431,holder_name:_0x2cecba,customer_email:_0x386b17,customer_birth_date:_0x57b9e7,billing_country:_0x503a4c,customer_phone:_0x3c1e6f,billing_address:_0x4ddba1,billing_city:_0x5ef7ca,billing_state:_0x2692fc,billing_zip:_0x47e8ce,phoneValidation:_0x957172}=_0xdfb79[_0x1b90f1(0x1b3)];console[_0x1b90f1(0x1d1)](_0x1b90f1(0x1ce)+_0x4077a7),console[_0x1b90f1(0x1d1)]('ðŸ“ž\x20Phone\x20validation\x20data:',_0x957172);if(!_0x3870ef||!_0x5d664d||!_0x3d8234||!_0x392431||!_0x2cecba||!_0x386b17)return _0x2af907['status'](0x190)[_0x1b90f1(0x1aa)]({'success':![],'message':_0x1b90f1(0x1cc)});if(_0x503a4c&&!isValidCountryCode(_0x503a4c))return _0x2af907['status'](0x190)['json']({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x3e5d48=await database_1[_0x1b90f1(0x191)]['payment'][_0x1b90f1(0x17b)]({'where':{'id':_0x4077a7},'include':{'shop':!![]}});if(!_0x3e5d48)return _0x2af907[_0x1b90f1(0x199)](0x194)['json']({'success':![],'message':_0x1b90f1(0x1af)});if(_0x3e5d48[_0x1b90f1(0x199)]!==_0x1b90f1(0x193))return _0x2af907[_0x1b90f1(0x199)](0x190)[_0x1b90f1(0x1aa)]({'success':![],'message':_0x1b90f1(0x1c5)});const _0x4a8222=(0x0,ipHelper_1[_0x1b90f1(0x18b)])(_0xdfb79),_0x577b05={'number':_0x3870ef[_0x1b90f1(0x17e)](/\s/g,''),'exp_month':_0x5d664d[_0x1b90f1(0x1d8)]()[_0x1b90f1(0x1b1)](0x2,'0'),'exp_year':_0x3d8234[_0x1b90f1(0x1d8)](),'verification_value':_0x392431,'holder':_0x2cecba['toUpperCase']()},_0x14470b={'ip':_0x4a8222,'email':_0x386b17};_0x57b9e7&&(_0x14470b['birth_date']=_0x57b9e7);let _0x3224b6;_0x503a4c&&(_0x3224b6={'country':_0x503a4c,'address':_0x4ddba1,'city':_0x5ef7ca,'state':_0x2692fc,'zip':_0x47e8ce});const _0x4cf177=(process.env.FRONTEND_URL||'https://app.trapay.uk')+_0x1b90f1(0x1ca)+_0x4077a7+_0x1b90f1(0x194)+(_0x3e5d48[_0x1b90f1(0x1df)]||_0x4077a7),_0x1a15cb=(process.env.API_BASE_URL||'https://api.trapay.uk')+_0x1b90f1(0x1d6),_0x3bd399=_0x4077a7['slice'](0x0,0x8)+'-'+_0x4077a7['slice'](0x8,0x10);console[_0x1b90f1(0x1d1)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console[_0x1b90f1(0x1d1)](_0x1b90f1(0x195)+_0x4077a7),console[_0x1b90f1(0x1d1)]('\x20\x20\x20Amount:\x20'+_0x3e5d48[_0x1b90f1(0x1b5)]+'\x20'+_0x3e5d48[_0x1b90f1(0x1bb)]),console['log'](_0x1b90f1(0x1ae)+_0x386b17+'\x20('+_0x4a8222+')'),console['log']('\x20\x20\x20Billing\x20Country:\x20'+(_0x503a4c||_0x1b90f1(0x18f))),console['log'](_0x1b90f1(0x17d)+_0x3bd399);const _0x400143=await this[_0x1b90f1(0x177)][_0x1b90f1(0x1d9)](Math['round'](_0x3e5d48['amount']*0x64),_0x3e5d48[_0x1b90f1(0x1bb)],_0x3bd399,_0x4cf177,_0x1a15cb,_0x577b05,_0x14470b,_0x3224b6,_0x3c1e6f),_0x59fd32=this[_0x1b90f1(0x177)][_0x1b90f1(0x17a)](_0x400143),_0x9a3f16={'gatewayPaymentId':_0x400143[_0x1b90f1(0x1ee)],'cardLast4':_0x59fd32[_0x1b90f1(0x1eb)],'gateway':_0x1b90f1(0x1a9),'customerEmail':_0x386b17,'customerPhone':_0x3c1e6f,'customerBirthDate':_0x57b9e7,'billingAddress':_0x4ddba1,'billingCity':_0x5ef7ca,'billingState':_0x2692fc,'billingZip':_0x47e8ce,'customerCountry':_0x503a4c,'phoneIsValid':_0x957172?.[_0x1b90f1(0x188)],'phoneLineStatus':_0x957172?.['lineStatus'],'phoneIsVoip':_0x957172?.['isVoip'],'phoneRiskLevel':_0x957172?.[_0x1b90f1(0x196)]};console[_0x1b90f1(0x1d1)]('ðŸ’¾\x20Update\x20data\x20being\x20saved:',{'phoneIsValid':_0x9a3f16[_0x1b90f1(0x1dd)],'phoneLineStatus':_0x9a3f16[_0x1b90f1(0x19b)],'phoneIsVoip':_0x9a3f16[_0x1b90f1(0x1b9)],'phoneRiskLevel':_0x9a3f16[_0x1b90f1(0x1a2)]});if(_0x59fd32[_0x1b90f1(0x199)]===_0x1b90f1(0x1e2)){_0x9a3f16['status']=_0x1b90f1(0x1e2),_0x9a3f16['paidAt']=new Date();try{const _0x577369=await this['currencyService']['convertToUSDT'](_0x3e5d48['amount'],_0x3e5d48[_0x1b90f1(0x1bb)]);_0x9a3f16[_0x1b90f1(0x1d7)]=_0x577369,console[_0x1b90f1(0x1d1)](_0x1b90f1(0x184)+_0x577369+_0x1b90f1(0x1a1));const _0x7a2237=await this[_0x1b90f1(0x192)][_0x1b90f1(0x19d)](_0x3e5d48[_0x1b90f1(0x1b4)],_0x3e5d48[_0x1b90f1(0x180)]),_0x23f8aa=_0x577369*(0x1-_0x7a2237/0x64);_0x9a3f16[_0x1b90f1(0x18c)]=_0x23f8aa,_0x9a3f16[_0x1b90f1(0x1c1)]=_0x7a2237,console[_0x1b90f1(0x1d1)](_0x1b90f1(0x19e)+_0x3e5d48[_0x1b90f1(0x180)]+_0x1b90f1(0x1ac)+_0x7a2237+'%'),console[_0x1b90f1(0x1d1)](_0x1b90f1(0x1b6)+_0x23f8aa[_0x1b90f1(0x178)](0x6)+_0x1b90f1(0x1a1));}catch(_0x43c809){console[_0x1b90f1(0x18d)](_0x1b90f1(0x1c0),_0x43c809),_0x9a3f16[_0x1b90f1(0x1d7)]=0x0,_0x9a3f16['amountAfterGatewayCommissionUSDT']=0x0,_0x9a3f16[_0x1b90f1(0x1c1)]=0x0;}}else _0x59fd32[_0x1b90f1(0x199)]===_0x1b90f1(0x187)&&(_0x9a3f16[_0x1b90f1(0x199)]=_0x1b90f1(0x187),_0x9a3f16[_0x1b90f1(0x1c4)]=_0x59fd32[_0x1b90f1(0x1c4)]);const _0x1a70bf=await database_1['default'][_0x1b90f1(0x190)][_0x1b90f1(0x1bc)]({'where':{'id':_0x4077a7},'data':_0x9a3f16});console['log'](_0x1b90f1(0x1ba)+_0x1a70bf[_0x1b90f1(0x199)]);let _0x1ef5f9;if(_0x59fd32[_0x1b90f1(0x199)]===_0x1b90f1(0x187))_0x1ef5f9=_0x59fd32[_0x1b90f1(0x1c4)]||_0x400143['friendly_message']||'Payment\x20failed';else _0x59fd32[_0x1b90f1(0x199)]===_0x1b90f1(0x193)?_0x1ef5f9=_0x400143[_0x1b90f1(0x1c2)]||'Payment\x20is\x20being\x20processed':_0x1ef5f9=_0x400143[_0x1b90f1(0x1c2)]||'Payment\x20processed\x20successfully';const _0x3b710b={'success':_0x59fd32['status']!==_0x1b90f1(0x187),'status':_0x59fd32[_0x1b90f1(0x199)],'message':_0x1ef5f9,'payment':{'id':_0x4077a7,'status':_0x1a70bf['status'],'gateway':'squirrelpay','last4':_0x59fd32[_0x1b90f1(0x1eb)]}};_0x59fd32[_0x1b90f1(0x1ec)]&&(_0x3b710b[_0x1b90f1(0x1c7)]=_0x59fd32[_0x1b90f1(0x1ec)],_0x3b710b[_0x1b90f1(0x1ef)]=!![],console[_0x1b90f1(0x1d1)](_0x1b90f1(0x1bd)+_0x59fd32[_0x1b90f1(0x1ec)])),_0x2af907[_0x1b90f1(0x1aa)](_0x3b710b);}catch(_0x51593e){console[_0x1b90f1(0x18d)](_0x1b90f1(0x1ab),_0x51593e),_0x4f2dc9(_0x51593e);}},this[_0x3566a1(0x1de)]=async(_0x2e7a5a,_0x275eae,_0x14e351)=>{const _0x34b529=_0x3566a1;try{console[_0x34b529(0x1d1)]('ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'),console['log']('Headers:',_0x2e7a5a[_0x34b529(0x1c3)]),console['log']('Body:',_0x2e7a5a[_0x34b529(0x1b3)]),this['squirrelPayService'][_0x34b529(0x182)]({'headers':_0x2e7a5a['headers'],'body':_0x2e7a5a[_0x34b529(0x1b3)],'timestamp':new Date()[_0x34b529(0x17c)]()});const _0x5b3c05=_0x2e7a5a['body'];if(!_0x5b3c05['uid']||!_0x5b3c05[_0x34b529(0x199)])return console[_0x34b529(0x175)](_0x34b529(0x1a5)),_0x275eae[_0x34b529(0x199)](0x190)[_0x34b529(0x1aa)]({'success':![],'message':_0x34b529(0x17f)});let _0x41dfcc;_0x5b3c05[_0x34b529(0x1ee)]&&(_0x41dfcc=await database_1['default'][_0x34b529(0x190)][_0x34b529(0x1d3)]({'where':{'gatewayPaymentId':_0x5b3c05[_0x34b529(0x1ee)],'gateway':_0x34b529(0x1a9)}}));if(!_0x41dfcc)return console['warn']('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x34b529(0x175)](_0x34b529(0x1a4)+_0x5b3c05['uid']),console[_0x34b529(0x175)](_0x34b529(0x17d)+_0x5b3c05[_0x34b529(0x1a7)]),console[_0x34b529(0x175)](_0x34b529(0x1c9)),console[_0x34b529(0x175)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x5b3c05[_0x34b529(0x1ee)]),_0x275eae[_0x34b529(0x199)](0x194)[_0x34b529(0x1aa)]({'success':![],'message':_0x34b529(0x1af)});console[_0x34b529(0x1d1)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x41dfcc['id']),console['log']('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x41dfcc['status']),console[_0x34b529(0x1d1)](_0x34b529(0x1cf)+_0x41dfcc[_0x34b529(0x1cd)]),console[_0x34b529(0x1d1)](_0x34b529(0x173)+_0x5b3c05[_0x34b529(0x199)]),console[_0x34b529(0x1d1)](_0x34b529(0x185)+_0x5b3c05[_0x34b529(0x1ee)]);let _0x2b46be=null;const _0x24c417={};_0x5b3c05[_0x34b529(0x1b8)]?.[_0x34b529(0x1a3)]&&(_0x24c417[_0x34b529(0x1e8)]=_0x5b3c05[_0x34b529(0x1b8)][_0x34b529(0x1a3)],console[_0x34b529(0x1d1)]('ðŸ’³\x20Card\x20brand\x20detected:\x20'+_0x5b3c05[_0x34b529(0x1b8)]['brand']));_0x5b3c05[_0x34b529(0x1b8)]?.[_0x34b529(0x1da)]&&(_0x24c417[_0x34b529(0x1eb)]=_0x5b3c05['payment_method'][_0x34b529(0x1da)],console['log']('ðŸ’³\x20Card\x20last\x204:\x20'+_0x5b3c05['payment_method']['last_4']));switch(_0x5b3c05[_0x34b529(0x199)]){case'successful':_0x2b46be=_0x34b529(0x1e2),console[_0x34b529(0x1d1)](_0x34b529(0x19f));break;case _0x34b529(0x1e5):_0x2b46be='FAILED',_0x24c417[_0x34b529(0x1c4)]=_0x5b3c05[_0x34b529(0x1c2)]||_0x5b3c05[_0x34b529(0x1e4)]||_0x34b529(0x1dc),console[_0x34b529(0x1d1)](_0x34b529(0x1b0)+_0x24c417['failureMessage']);break;case _0x34b529(0x1ea):console[_0x34b529(0x1d1)]('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console[_0x34b529(0x175)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x5b3c05[_0x34b529(0x199)]);break;}if(_0x2b46be&&_0x2b46be!==_0x41dfcc[_0x34b529(0x199)])console[_0x34b529(0x1d1)](_0x34b529(0x1a0)+_0x41dfcc['status']+'\x20to\x20'+_0x2b46be),await this[_0x34b529(0x192)][_0x34b529(0x1b7)](_0x41dfcc['id'],_0x2b46be,_0x24c417),console[_0x34b529(0x1d1)](_0x34b529(0x1cb)+_0x41dfcc['id']+_0x34b529(0x18a)+_0x2b46be+_0x34b529(0x198));else _0x2b46be&&console[_0x34b529(0x1d1)](_0x34b529(0x1d5)+_0x41dfcc['id']+_0x34b529(0x186)+_0x2b46be+_0x34b529(0x1d2));_0x275eae['status'](0xc8)[_0x34b529(0x1aa)]({'success':!![],'message':_0x34b529(0x1be)});}catch(_0xaab8ed){console[_0x34b529(0x18d)](_0x34b529(0x189),_0xaab8ed),_0x14e351(_0xaab8ed);}},this[_0x3566a1(0x1e3)]=async(_0x1d74fb,_0x31eb1a,_0x3984cf)=>{const _0x3e2900=_0x3566a1;try{const {limit:_0x4639c1}=_0x1d74fb[_0x3e2900(0x183)],_0xcdb3ad=this[_0x3e2900(0x177)][_0x3e2900(0x1e3)](_0x4639c1?parseInt(_0x4639c1):0x32);_0x31eb1a[_0x3e2900(0x1aa)]({'success':!![],'result':{'logs':_0xcdb3ad,'count':_0xcdb3ad[_0x3e2900(0x1c8)]}});}catch(_0x39082a){_0x3984cf(_0x39082a);}},this[_0x3566a1(0x177)]=new squirrelPayService_1[(_0x3566a1(0x1e1))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x3566a1(0x1e6),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0x3566a1(0x1a8)}),this[_0x3566a1(0x18e)]=new currencyService_1[(_0x3566a1(0x1d0))](),this[_0x3566a1(0x192)]=new webhookService_1[(_0x3566a1(0x19a))]();}}exports[a19_0x121584(0x1ad)]=SquirrelPayController;