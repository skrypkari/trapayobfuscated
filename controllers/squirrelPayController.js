'use strict';const a16_0x23a814=a16_0x11ff;(function(_0x15d423,_0x1d02a5){const _0x3d0df6=a16_0x11ff,_0x3b6db2=_0x15d423();while(!![]){try{const _0xf33bd3=-parseInt(_0x3d0df6(0x227))/0x1*(-parseInt(_0x3d0df6(0x1f5))/0x2)+parseInt(_0x3d0df6(0x261))/0x3+-parseInt(_0x3d0df6(0x21b))/0x4*(parseInt(_0x3d0df6(0x20f))/0x5)+-parseInt(_0x3d0df6(0x209))/0x6+parseInt(_0x3d0df6(0x24a))/0x7+parseInt(_0x3d0df6(0x1fd))/0x8+-parseInt(_0x3d0df6(0x1f7))/0x9;if(_0xf33bd3===_0x1d02a5)break;else _0x3b6db2['push'](_0x3b6db2['shift']());}catch(_0x5832ce){_0x3b6db2['push'](_0x3b6db2['shift']());}}}(a16_0x5a2c,0x546ce));function a16_0x11ff(_0x577885,_0x47d562){_0x577885=_0x577885-0x1f2;const _0x5a2c02=a16_0x5a2c();let _0x11ff24=_0x5a2c02[_0x577885];return _0x11ff24;}var __importDefault=this&&this[a16_0x23a814(0x243)]||function(_0x3b7ded){const _0x3098c9=a16_0x23a814;return _0x3b7ded&&_0x3b7ded[_0x3098c9(0x21c)]?_0x3b7ded:{'default':_0x3b7ded};};Object['defineProperty'](exports,a16_0x23a814(0x21c),{'value':!![]}),exports[a16_0x23a814(0x212)]=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require('../services/currencyService'),webhookService_1=require(a16_0x23a814(0x21d)),database_1=__importDefault(require(a16_0x23a814(0x23f))),ipHelper_1=require(a16_0x23a814(0x253)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a16_0x5a2c(){const _0x3fc47a=['../config/database','webhookService','Payment\x20not\x20found','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','__importDefault','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','\x20already\x20has\x20status\x20','redirectUrl','true','amountAfterGatewayCommissionUSDT','\x20USDT','2835791cMTxwh','FAILED','friendly_message','Payment\x20is\x20being\x20processed','gatewayPaymentId','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','updatePaymentStatus','status','https://app.trapay.uk','../utils/ipHelper','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','&payment_id=','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','Missing\x20required\x20card\x20or\x20customer\x20information','amountUSDT','update','round','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','\x20\x20\x20Amount:\x20','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','env','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','1981791EsxstP','findFirst','âŒ\x20SquirrelPay\x20webhook\x20error:','error','body','description','Payment\x20failed','warn','uid','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','failureMessage','processCardPayment','birth_date','\x20\x20\x20Webhook\x20UID:\x20','2LuKDDp','failed','6412680yobRnE','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','SQUIRREL_PAY_BASE_URL','log','WebhookService','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','1644088vwwQTo','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Billing\x20Country:\x20','payment','\x20to\x20','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','\x20\x20\x20UID:\x20','json','PAID','https://gate.squirrel-pay.com','PENDING','API_BASE_URL','2431026sgkWHg','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','toISOString','cardLast4','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','default','40XXriXy','\x20\x20\x20Gateway:\x20squirrelpay','ðŸ’°\x20Gateway\x20','SquirrelPayController','\x20\x20\x20Customer:\x20','Payment\x20processed\x20successfully','incomplete','length','\x20\x20\x20Description:\x20','Webhook\x20processed\x20successfully','getGatewayCommission','squirrelpay','138004KRCrFU','__esModule','../services/webhookService','shopId','amount','Payment\x20is\x20not\x20in\x20pending\x20status','/payment/pending?id=','padStart','replace','headers','gateway','SQUIRREL_PAY_TEST_MODE','468284PtEHlr','\x20commission:\x20',',\x20balance\x20updated,\x20amountUSDT\x20calculated','âœ…\x20Payment\x20','\x20updated:\x20status=','handleWebhook','CurrencyService','has','gatewayCommissionRate','query',',\x20skipping\x20update','https://api.trapay.uk','toString','slice','paidAt','successful','currency','toUpperCase','getWebhookLogs','squirrelPayService','requires_action','SquirrelPayService','convertToUSDT','Missing\x20required\x20fields\x20in\x20webhook'];a16_0x5a2c=function(){return _0x3fc47a;};return a16_0x5a2c();}function isValidCountryCode(_0x2603dc){const _0x255d83=a16_0x23a814;return ISO_COUNTRY_CODES[_0x255d83(0x22e)](_0x2603dc[_0x255d83(0x238)]());}class SquirrelPayController{constructor(){const _0x307ff5=a16_0x23a814;this[_0x307ff5(0x1f2)]=async(_0x26d442,_0x33db25,_0x5443c0)=>{const _0x19b889=_0x307ff5;try{const {paymentId:_0x23abdc}=_0x26d442['params'],{card_number:_0x524047,exp_month:_0x158b63,exp_year:_0x2ce9bc,cvv:_0x2716a1,holder_name:_0x3e787e,customer_email:_0x317944,customer_birth_date:_0x338590,billing_country:_0x49410c,customer_phone:_0xfe30a8,billing_address:_0x55572e,billing_city:_0x2c654f,billing_state:_0x1ece59,billing_zip:_0x3a2e85}=_0x26d442[_0x19b889(0x265)];console[_0x19b889(0x1fa)](_0x19b889(0x254)+_0x23abdc);if(!_0x524047||!_0x158b63||!_0x2ce9bc||!_0x2716a1||!_0x3e787e||!_0x317944)return _0x33db25[_0x19b889(0x251)](0x190)[_0x19b889(0x204)]({'success':![],'message':_0x19b889(0x257)});if(_0x49410c&&!isValidCountryCode(_0x49410c))return _0x33db25[_0x19b889(0x251)](0x190)[_0x19b889(0x204)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x2fa8dc=await database_1['default'][_0x19b889(0x200)]['findUnique']({'where':{'id':_0x23abdc},'include':{'shop':!![]}});if(!_0x2fa8dc)return _0x33db25['status'](0x194)[_0x19b889(0x204)]({'success':![],'message':_0x19b889(0x241)});if(_0x2fa8dc['status']!==_0x19b889(0x207))return _0x33db25[_0x19b889(0x251)](0x190)['json']({'success':![],'message':_0x19b889(0x220)});const _0x1bbbe0=(0x0,ipHelper_1['getClientIP'])(_0x26d442),_0x433e78={'number':_0x524047[_0x19b889(0x223)](/\s/g,''),'exp_month':_0x158b63[_0x19b889(0x233)]()[_0x19b889(0x222)](0x2,'0'),'exp_year':_0x2ce9bc[_0x19b889(0x233)](),'verification_value':_0x2716a1,'holder':_0x3e787e['toUpperCase']()},_0x576985={'ip':_0x1bbbe0,'email':_0x317944};_0x338590&&(_0x576985[_0x19b889(0x1f3)]=_0x338590);let _0x171f44;_0x49410c&&(_0x171f44={'country':_0x49410c,'address':_0x55572e,'city':_0x2c654f,'state':_0x1ece59,'zip':_0x3a2e85});const _0xccc23a=(process['env']['FRONTEND_URL']||_0x19b889(0x252))+_0x19b889(0x221)+_0x23abdc+_0x19b889(0x255)+(_0x2fa8dc['gatewayOrderId']||_0x23abdc),_0x38fddf=(process[_0x19b889(0x25e)][_0x19b889(0x208)]||_0x19b889(0x232))+'/api/webhooks/squirrel-pay',_0x8ec173=_0x23abdc[_0x19b889(0x234)](0x0,0x8)+'-'+_0x23abdc[_0x19b889(0x234)](0x8,0x10);console[_0x19b889(0x1fa)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console['log']('\x20\x20\x20Payment\x20ID:\x20'+_0x23abdc),console[_0x19b889(0x1fa)](_0x19b889(0x25c)+_0x2fa8dc[_0x19b889(0x21f)]+'\x20'+_0x2fa8dc[_0x19b889(0x237)]),console[_0x19b889(0x1fa)](_0x19b889(0x213)+_0x317944+'\x20('+_0x1bbbe0+')'),console[_0x19b889(0x1fa)](_0x19b889(0x1ff)+(_0x49410c||'not\x20provided')),console[_0x19b889(0x1fa)](_0x19b889(0x217)+_0x8ec173);const _0x10c130=await this[_0x19b889(0x23a)][_0x19b889(0x1f2)](Math[_0x19b889(0x25a)](_0x2fa8dc['amount']*0x64),_0x2fa8dc[_0x19b889(0x237)],_0x8ec173,_0xccc23a,_0x38fddf,_0x433e78,_0x576985,_0x171f44,_0xfe30a8),_0x38e731=this[_0x19b889(0x23a)]['getPaymentStatus'](_0x10c130),_0x1f3ea6={'gatewayPaymentId':_0x10c130[_0x19b889(0x269)],'cardLast4':_0x38e731[_0x19b889(0x20c)],'gateway':_0x19b889(0x21a),'customerEmail':_0x317944,'customerPhone':_0xfe30a8,'customerBirthDate':_0x338590,'billingAddress':_0x55572e,'billingCity':_0x2c654f,'billingState':_0x1ece59,'billingZip':_0x3a2e85,'customerCountry':_0x49410c};if(_0x38e731[_0x19b889(0x251)]===_0x19b889(0x205)){_0x1f3ea6[_0x19b889(0x251)]=_0x19b889(0x205),_0x1f3ea6[_0x19b889(0x235)]=new Date();try{const _0x49b808=await this['currencyService'][_0x19b889(0x23d)](_0x2fa8dc[_0x19b889(0x21f)],_0x2fa8dc[_0x19b889(0x237)]);_0x1f3ea6[_0x19b889(0x258)]=_0x49b808,console['log']('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x49b808+_0x19b889(0x249));const _0x58a936=await this[_0x19b889(0x240)][_0x19b889(0x219)](_0x2fa8dc[_0x19b889(0x21e)],_0x2fa8dc['gateway']),_0x45d10c=_0x49b808*(0x1-_0x58a936/0x64);_0x1f3ea6[_0x19b889(0x248)]=_0x45d10c,_0x1f3ea6[_0x19b889(0x22f)]=_0x58a936,console[_0x19b889(0x1fa)](_0x19b889(0x211)+_0x2fa8dc[_0x19b889(0x225)]+_0x19b889(0x228)+_0x58a936+'%'),console['log'](_0x19b889(0x244)+_0x45d10c['toFixed'](0x6)+_0x19b889(0x249));}catch(_0x1e299a){console[_0x19b889(0x264)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x1e299a),_0x1f3ea6[_0x19b889(0x258)]=0x0,_0x1f3ea6[_0x19b889(0x248)]=0x0,_0x1f3ea6[_0x19b889(0x22f)]=0x0;}}else _0x38e731[_0x19b889(0x251)]===_0x19b889(0x24b)&&(_0x1f3ea6[_0x19b889(0x251)]=_0x19b889(0x24b),_0x1f3ea6[_0x19b889(0x26b)]=_0x38e731[_0x19b889(0x26b)]);const _0x22fd20=await database_1[_0x19b889(0x20e)][_0x19b889(0x200)][_0x19b889(0x259)]({'where':{'id':_0x23abdc},'data':_0x1f3ea6});console[_0x19b889(0x1fa)](_0x19b889(0x256)+_0x22fd20[_0x19b889(0x251)]);let _0x97d234;if(_0x38e731['status']===_0x19b889(0x24b))_0x97d234=_0x38e731[_0x19b889(0x26b)]||_0x10c130['friendly_message']||_0x19b889(0x267);else _0x38e731[_0x19b889(0x251)]===_0x19b889(0x207)?_0x97d234=_0x10c130[_0x19b889(0x24c)]||_0x19b889(0x24d):_0x97d234=_0x10c130[_0x19b889(0x24c)]||_0x19b889(0x214);const _0x215660={'success':_0x38e731['status']!==_0x19b889(0x24b),'status':_0x38e731['status'],'message':_0x97d234,'payment':{'id':_0x23abdc,'status':_0x22fd20[_0x19b889(0x251)],'gateway':_0x19b889(0x21a),'last4':_0x38e731[_0x19b889(0x20c)]}};_0x38e731['redirectUrl']&&(_0x215660['redirect_url']=_0x38e731[_0x19b889(0x246)],_0x215660[_0x19b889(0x23b)]=!![],console[_0x19b889(0x1fa)](_0x19b889(0x242)+_0x38e731[_0x19b889(0x246)])),_0x33db25[_0x19b889(0x204)](_0x215660);}catch(_0x5cf46d){console['error'](_0x19b889(0x26a),_0x5cf46d),_0x5443c0(_0x5cf46d);}},this[_0x307ff5(0x22c)]=async(_0x99b668,_0x26df13,_0x316501)=>{const _0x369bf0=_0x307ff5;try{console[_0x369bf0(0x1fa)](_0x369bf0(0x25d)),console[_0x369bf0(0x1fa)]('Headers:',_0x99b668[_0x369bf0(0x224)]),console[_0x369bf0(0x1fa)]('Body:',_0x99b668[_0x369bf0(0x265)]),this[_0x369bf0(0x23a)]['logWebhook']({'headers':_0x99b668[_0x369bf0(0x224)],'body':_0x99b668[_0x369bf0(0x265)],'timestamp':new Date()[_0x369bf0(0x20b)]()});const _0x525753=_0x99b668[_0x369bf0(0x265)];if(!_0x525753['uid']||!_0x525753[_0x369bf0(0x251)])return console[_0x369bf0(0x268)](_0x369bf0(0x202)),_0x26df13['status'](0x190)[_0x369bf0(0x204)]({'success':![],'message':_0x369bf0(0x23e)});let _0x2f919e;_0x525753['uid']&&(_0x2f919e=await database_1[_0x369bf0(0x20e)][_0x369bf0(0x200)][_0x369bf0(0x262)]({'where':{'gatewayPaymentId':_0x525753[_0x369bf0(0x269)],'gateway':_0x369bf0(0x21a)}}));if(!_0x2f919e)return console[_0x369bf0(0x268)](_0x369bf0(0x260)),console[_0x369bf0(0x268)](_0x369bf0(0x203)+_0x525753['uid']),console['warn'](_0x369bf0(0x217)+_0x525753[_0x369bf0(0x266)]),console[_0x369bf0(0x268)](_0x369bf0(0x210)),console[_0x369bf0(0x268)](_0x369bf0(0x1f8)+_0x525753[_0x369bf0(0x269)]),_0x26df13[_0x369bf0(0x251)](0x194)[_0x369bf0(0x204)]({'success':![],'message':'Payment\x20not\x20found'});console[_0x369bf0(0x1fa)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x2f919e['id']),console[_0x369bf0(0x1fa)](_0x369bf0(0x20d)+_0x2f919e[_0x369bf0(0x251)]),console[_0x369bf0(0x1fa)](_0x369bf0(0x25b)+_0x2f919e[_0x369bf0(0x24e)]),console[_0x369bf0(0x1fa)]('\x20\x20\x20Webhook\x20status:\x20'+_0x525753[_0x369bf0(0x251)]),console['log'](_0x369bf0(0x1f4)+_0x525753[_0x369bf0(0x269)]);let _0x354334=null;const _0x425940={};switch(_0x525753['status']){case _0x369bf0(0x236):_0x354334=_0x369bf0(0x205),console[_0x369bf0(0x1fa)](_0x369bf0(0x1fe));break;case _0x369bf0(0x1f6):_0x354334=_0x369bf0(0x24b),_0x425940[_0x369bf0(0x26b)]=_0x525753['friendly_message']||_0x525753['message']||_0x369bf0(0x267),console['log'](_0x369bf0(0x24f)+_0x425940[_0x369bf0(0x26b)]);break;case _0x369bf0(0x215):console[_0x369bf0(0x1fa)](_0x369bf0(0x1fc));break;default:console[_0x369bf0(0x268)](_0x369bf0(0x25f)+_0x525753[_0x369bf0(0x251)]);break;}if(_0x354334&&_0x354334!==_0x2f919e[_0x369bf0(0x251)])console[_0x369bf0(0x1fa)](_0x369bf0(0x20a)+_0x2f919e[_0x369bf0(0x251)]+_0x369bf0(0x201)+_0x354334),await this[_0x369bf0(0x240)][_0x369bf0(0x250)](_0x2f919e['id'],_0x354334,_0x425940),console[_0x369bf0(0x1fa)](_0x369bf0(0x22a)+_0x2f919e['id']+_0x369bf0(0x22b)+_0x354334+_0x369bf0(0x229));else _0x354334&&console[_0x369bf0(0x1fa)]('â„¹ï¸\x20Payment\x20'+_0x2f919e['id']+_0x369bf0(0x245)+_0x354334+_0x369bf0(0x231));_0x26df13[_0x369bf0(0x251)](0xc8)[_0x369bf0(0x204)]({'success':!![],'message':_0x369bf0(0x218)});}catch(_0x3d5578){console['error'](_0x369bf0(0x263),_0x3d5578),_0x316501(_0x3d5578);}},this['getWebhookLogs']=async(_0x45c5e2,_0x17a0f2,_0x2fb89e)=>{const _0x3d8cca=_0x307ff5;try{const {limit:_0x3a84b9}=_0x45c5e2[_0x3d8cca(0x230)],_0x2e6ff6=this[_0x3d8cca(0x23a)][_0x3d8cca(0x239)](_0x3a84b9?parseInt(_0x3a84b9):0x32);_0x17a0f2[_0x3d8cca(0x204)]({'success':!![],'result':{'logs':_0x2e6ff6,'count':_0x2e6ff6[_0x3d8cca(0x216)]}});}catch(_0x3962da){_0x2fb89e(_0x3962da);}},this[_0x307ff5(0x23a)]=new squirrelPayService_1[(_0x307ff5(0x23c))]({'shopId':process[_0x307ff5(0x25e)]['SQUIRREL_PAY_SHOP_ID']||'','secretKey':process['env']['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process['env'][_0x307ff5(0x1f9)]||_0x307ff5(0x206),'isTestMode':process[_0x307ff5(0x25e)][_0x307ff5(0x226)]===_0x307ff5(0x247)}),this['currencyService']=new currencyService_1[(_0x307ff5(0x22d))](),this['webhookService']=new webhookService_1[(_0x307ff5(0x1fb))]();}}exports[a16_0x23a814(0x212)]=SquirrelPayController;