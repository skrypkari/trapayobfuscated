'use strict';const a17_0x5b71aa=a17_0x5179;function a17_0x5179(_0x416881,_0x17de31){_0x416881=_0x416881-0xb3;const _0x296c74=a17_0x296c();let _0x5179f4=_0x296c74[_0x416881];return _0x5179f4;}(function(_0x114f40,_0x1fcaca){const _0x196ce8=a17_0x5179,_0x4c314a=_0x114f40();while(!![]){try{const _0xf69628=-parseInt(_0x196ce8(0x12e))/0x1*(parseInt(_0x196ce8(0xd3))/0x2)+parseInt(_0x196ce8(0x10d))/0x3*(-parseInt(_0x196ce8(0xbe))/0x4)+-parseInt(_0x196ce8(0x106))/0x5+-parseInt(_0x196ce8(0xf5))/0x6+parseInt(_0x196ce8(0xd0))/0x7+parseInt(_0x196ce8(0x11c))/0x8+parseInt(_0x196ce8(0xe3))/0x9;if(_0xf69628===_0x1fcaca)break;else _0x4c314a['push'](_0x4c314a['shift']());}catch(_0x435696){_0x4c314a['push'](_0x4c314a['shift']());}}}(a17_0x296c,0xdff08));var __importDefault=this&&this[a17_0x5b71aa(0xca)]||function(_0x2da3cd){return _0x2da3cd&&_0x2da3cd['__esModule']?_0x2da3cd:{'default':_0x2da3cd};};function a17_0x296c(){const _0x4f36fb=['friendly_message','ðŸ’°\x20Calculated\x20amountUSDT:\x20','SQUIRREL_PAY_BASE_URL','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','\x20\x20\x20Description:\x20','/api/webhooks/squirrel-pay','status','brand','\x20\x20\x20Amount:\x20','__importDefault','getWebhookLogs','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','SQUIRREL_PAY_SHOP_ID','requires_action',',\x20skipping\x20update','2253811usDDBa','toString','../utils/ipHelper','8ClSOoM','../services/currencyService','updatePaymentStatus','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','\x20updated:\x20status=','https://gate.squirrel-pay.com','&payment_id=','\x20\x20\x20UID:\x20','Missing\x20required\x20card\x20or\x20customer\x20information','getClientIP','gatewayPaymentId','FAILED','\x20USDT','amountUSDT','FRONTEND_URL','PAID','32645988lWjmLB','Payment\x20is\x20not\x20in\x20pending\x20status','SQUIRREL_PAY_TEST_MODE','slice','â„¹ï¸\x20Payment\x20','has','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','processCardPayment','\x20to\x20','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','/payment/pending?id=','gateway','\x20commission:\x20','error','round','SquirrelPayController','headers','ðŸ“\x20SquirrelPay\x20payment\x20details:','7310724JPMgfL','body','SQUIRREL_PAY_SECRET_KEY','ðŸ’³\x20Card\x20last\x204:\x20','../services/gateways/squirrelPayService','ðŸ’³\x20Card\x20brand\x20detected:\x20','amountAfterGatewayCommissionUSDT','update','payment','PENDING','getPaymentStatus','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','Headers:','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','redirectUrl','uid','padStart','1954805YNfJSY','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','webhookService','payment_method','currencyService','log','__esModule','1275BMTrVX','length','squirrelPayService','paidAt',',\x20balance\x20updated,\x20amountUSDT\x20calculated','../services/webhookService','gatewayCommissionRate','description','cardBrand','squirrelpay','defineProperty','Payment\x20not\x20found','API_BASE_URL','toISOString','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','442536EUnaNj','gatewayOrderId','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Gateway:\x20squirrelpay','last_4','shopId','amount','successful','Body:','warn','cardLast4','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','message','findFirst','Payment\x20failed','Missing\x20required\x20fields\x20in\x20webhook','env','getGatewayCommission','290544uXdyYe','replace','not\x20provided','\x20already\x20has\x20status\x20','convertToUSDT','failureMessage','Webhook\x20processed\x20successfully','âœ…\x20Payment\x20','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','currency','json','âŒ\x20SquirrelPay\x20webhook\x20error:','default','2972KwzIyv','incomplete','WebhookService'];a17_0x296c=function(){return _0x4f36fb;};return a17_0x296c();}Object[a17_0x5b71aa(0x117)](exports,a17_0x5b71aa(0x10c),{'value':!![]}),exports[a17_0x5b71aa(0xf2)]=void 0x0;const squirrelPayService_1=require(a17_0x5b71aa(0xf9)),currencyService_1=require(a17_0x5b71aa(0xd4)),webhookService_1=require(a17_0x5b71aa(0x112)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a17_0x5b71aa(0xd2)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x21bc48){const _0x5c746c=a17_0x5b71aa;return ISO_COUNTRY_CODES[_0x5c746c(0xe8)](_0x21bc48['toUpperCase']());}class SquirrelPayController{constructor(){const _0xb45073=a17_0x5b71aa;this[_0xb45073(0xea)]=async(_0x1a3bc3,_0x502b1e,_0x133bcf)=>{const _0xfd0397=_0xb45073;try{const {paymentId:_0x4377c6}=_0x1a3bc3['params'],{card_number:_0x261f47,exp_month:_0x3a0cde,exp_year:_0x53f616,cvv:_0x270fa0,holder_name:_0x499903,customer_email:_0x19886f,customer_birth_date:_0xeea558,billing_country:_0x5551cd,customer_phone:_0x4025ee,billing_address:_0x268564,billing_city:_0x232a18,billing_state:_0x22baa0,billing_zip:_0x1d571b}=_0x1a3bc3['body'];console[_0xfd0397(0x10b)](_0xfd0397(0x102)+_0x4377c6);if(!_0x261f47||!_0x3a0cde||!_0x53f616||!_0x270fa0||!_0x499903||!_0x19886f)return _0x502b1e['status'](0x190)[_0xfd0397(0xbb)]({'success':![],'message':_0xfd0397(0xdb)});if(_0x5551cd&&!isValidCountryCode(_0x5551cd))return _0x502b1e[_0xfd0397(0xc7)](0x190)[_0xfd0397(0xbb)]({'success':![],'message':_0xfd0397(0xd6)});const _0x28ced8=await database_1[_0xfd0397(0xbd)][_0xfd0397(0xfd)]['findUnique']({'where':{'id':_0x4377c6},'include':{'shop':!![]}});if(!_0x28ced8)return _0x502b1e[_0xfd0397(0xc7)](0x194)['json']({'success':![],'message':_0xfd0397(0x118)});if(_0x28ced8[_0xfd0397(0xc7)]!==_0xfd0397(0xfe))return _0x502b1e['status'](0x190)[_0xfd0397(0xbb)]({'success':![],'message':_0xfd0397(0xe4)});const _0x153e36=(0x0,ipHelper_1[_0xfd0397(0xdc)])(_0x1a3bc3),_0x20c385={'number':_0x261f47[_0xfd0397(0x12f)](/\s/g,''),'exp_month':_0x3a0cde['toString']()[_0xfd0397(0x105)](0x2,'0'),'exp_year':_0x53f616[_0xfd0397(0xd1)](),'verification_value':_0x270fa0,'holder':_0x499903['toUpperCase']()},_0x276c6={'ip':_0x153e36,'email':_0x19886f};_0xeea558&&(_0x276c6['birth_date']=_0xeea558);let _0x3bfe55;_0x5551cd&&(_0x3bfe55={'country':_0x5551cd,'address':_0x268564,'city':_0x232a18,'state':_0x22baa0,'zip':_0x1d571b});const _0x2600d5=(process[_0xfd0397(0x12c)][_0xfd0397(0xe1)]||'https://app.trapay.uk')+_0xfd0397(0xed)+_0x4377c6+_0xfd0397(0xd9)+(_0x28ced8[_0xfd0397(0x11d)]||_0x4377c6),_0x5ea5a9=(process[_0xfd0397(0x12c)][_0xfd0397(0x119)]||'https://api.trapay.uk')+_0xfd0397(0xc6),_0x486894=_0x4377c6[_0xfd0397(0xe6)](0x0,0x8)+'-'+_0x4377c6[_0xfd0397(0xe6)](0x8,0x10);console[_0xfd0397(0x10b)](_0xfd0397(0xf4)),console[_0xfd0397(0x10b)]('\x20\x20\x20Payment\x20ID:\x20'+_0x4377c6),console['log'](_0xfd0397(0xc9)+_0x28ced8['amount']+'\x20'+_0x28ced8[_0xfd0397(0xba)]),console[_0xfd0397(0x10b)]('\x20\x20\x20Customer:\x20'+_0x19886f+'\x20('+_0x153e36+')'),console[_0xfd0397(0x10b)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x5551cd||_0xfd0397(0xb3))),console['log'](_0xfd0397(0xc5)+_0x486894);const _0x355c9c=await this[_0xfd0397(0x10f)][_0xfd0397(0xea)](Math[_0xfd0397(0xf1)](_0x28ced8[_0xfd0397(0x122)]*0x64),_0x28ced8['currency'],_0x486894,_0x2600d5,_0x5ea5a9,_0x20c385,_0x276c6,_0x3bfe55,_0x4025ee),_0x1fa42d=this['squirrelPayService'][_0xfd0397(0xff)](_0x355c9c),_0x4fa327={'gatewayPaymentId':_0x355c9c[_0xfd0397(0x104)],'cardLast4':_0x1fa42d[_0xfd0397(0x126)],'gateway':_0xfd0397(0x116),'customerEmail':_0x19886f,'customerPhone':_0x4025ee,'customerBirthDate':_0xeea558,'billingAddress':_0x268564,'billingCity':_0x232a18,'billingState':_0x22baa0,'billingZip':_0x1d571b,'customerCountry':_0x5551cd};if(_0x1fa42d[_0xfd0397(0xc7)]===_0xfd0397(0xe2)){_0x4fa327['status']='PAID',_0x4fa327[_0xfd0397(0x110)]=new Date();try{const _0x29b4ba=await this[_0xfd0397(0x10a)][_0xfd0397(0xb5)](_0x28ced8[_0xfd0397(0x122)],_0x28ced8[_0xfd0397(0xba)]);_0x4fa327[_0xfd0397(0xe0)]=_0x29b4ba,console[_0xfd0397(0x10b)](_0xfd0397(0xc2)+_0x29b4ba+'\x20USDT');const _0x392fc0=await this[_0xfd0397(0x108)][_0xfd0397(0x12d)](_0x28ced8[_0xfd0397(0x121)],_0x28ced8[_0xfd0397(0xee)]),_0x59efc3=_0x29b4ba*(0x1-_0x392fc0/0x64);_0x4fa327[_0xfd0397(0xfb)]=_0x59efc3,_0x4fa327[_0xfd0397(0x113)]=_0x392fc0,console[_0xfd0397(0x10b)]('ðŸ’°\x20Gateway\x20'+_0x28ced8[_0xfd0397(0xee)]+_0xfd0397(0xef)+_0x392fc0+'%'),console[_0xfd0397(0x10b)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x59efc3['toFixed'](0x6)+_0xfd0397(0xdf));}catch(_0x491202){console[_0xfd0397(0xf0)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x491202),_0x4fa327['amountUSDT']=0x0,_0x4fa327['amountAfterGatewayCommissionUSDT']=0x0,_0x4fa327[_0xfd0397(0x113)]=0x0;}}else _0x1fa42d[_0xfd0397(0xc7)]===_0xfd0397(0xde)&&(_0x4fa327['status']=_0xfd0397(0xde),_0x4fa327[_0xfd0397(0xb6)]=_0x1fa42d[_0xfd0397(0xb6)]);const _0x579511=await database_1['default'][_0xfd0397(0xfd)][_0xfd0397(0xfc)]({'where':{'id':_0x4377c6},'data':_0x4fa327});console['log'](_0xfd0397(0xc4)+_0x579511['status']);let _0x3b14fe;if(_0x1fa42d['status']==='FAILED')_0x3b14fe=_0x1fa42d[_0xfd0397(0xb6)]||_0x355c9c[_0xfd0397(0xc1)]||_0xfd0397(0x12a);else _0x1fa42d[_0xfd0397(0xc7)]===_0xfd0397(0xfe)?_0x3b14fe=_0x355c9c[_0xfd0397(0xc1)]||'Payment\x20is\x20being\x20processed':_0x3b14fe=_0x355c9c['friendly_message']||'Payment\x20processed\x20successfully';const _0x4487a1={'success':_0x1fa42d[_0xfd0397(0xc7)]!==_0xfd0397(0xde),'status':_0x1fa42d[_0xfd0397(0xc7)],'message':_0x3b14fe,'payment':{'id':_0x4377c6,'status':_0x579511[_0xfd0397(0xc7)],'gateway':_0xfd0397(0x116),'last4':_0x1fa42d[_0xfd0397(0x126)]}};_0x1fa42d[_0xfd0397(0x103)]&&(_0x4487a1['redirect_url']=_0x1fa42d[_0xfd0397(0x103)],_0x4487a1[_0xfd0397(0xce)]=!![],console[_0xfd0397(0x10b)](_0xfd0397(0xcc)+_0x1fa42d[_0xfd0397(0x103)])),_0x502b1e[_0xfd0397(0xbb)](_0x4487a1);}catch(_0x2be1e9){console[_0xfd0397(0xf0)](_0xfd0397(0xe9),_0x2be1e9),_0x133bcf(_0x2be1e9);}},this['handleWebhook']=async(_0x1a8ea1,_0xd24c60,_0x18132d)=>{const _0x77f660=_0xb45073;try{console[_0x77f660(0x10b)]('ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'),console[_0x77f660(0x10b)](_0x77f660(0x101),_0x1a8ea1[_0x77f660(0xf3)]),console[_0x77f660(0x10b)](_0x77f660(0x124),_0x1a8ea1[_0x77f660(0xf6)]),this[_0x77f660(0x10f)]['logWebhook']({'headers':_0x1a8ea1[_0x77f660(0xf3)],'body':_0x1a8ea1[_0x77f660(0xf6)],'timestamp':new Date()[_0x77f660(0x11a)]()});const _0x315822=_0x1a8ea1['body'];if(!_0x315822['uid']||!_0x315822[_0x77f660(0xc7)])return console[_0x77f660(0x125)](_0x77f660(0x11b)),_0xd24c60[_0x77f660(0xc7)](0x190)[_0x77f660(0xbb)]({'success':![],'message':_0x77f660(0x12b)});let _0x47b2c0;_0x315822[_0x77f660(0x104)]&&(_0x47b2c0=await database_1[_0x77f660(0xbd)][_0x77f660(0xfd)][_0x77f660(0x129)]({'where':{'gatewayPaymentId':_0x315822[_0x77f660(0x104)],'gateway':_0x77f660(0x116)}}));if(!_0x47b2c0)return console[_0x77f660(0x125)](_0x77f660(0xb9)),console['warn'](_0x77f660(0xda)+_0x315822['uid']),console['warn'](_0x77f660(0xc5)+_0x315822[_0x77f660(0x114)]),console[_0x77f660(0x125)](_0x77f660(0x11f)),console[_0x77f660(0x125)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x315822[_0x77f660(0x104)]),_0xd24c60['status'](0x194)[_0x77f660(0xbb)]({'success':![],'message':'Payment\x20not\x20found'});console['log'](_0x77f660(0x127)+_0x47b2c0['id']),console['log'](_0x77f660(0x107)+_0x47b2c0[_0x77f660(0xc7)]),console[_0x77f660(0x10b)](_0x77f660(0x100)+_0x47b2c0[_0x77f660(0xdd)]),console[_0x77f660(0x10b)]('\x20\x20\x20Webhook\x20status:\x20'+_0x315822[_0x77f660(0xc7)]),console[_0x77f660(0x10b)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x315822[_0x77f660(0x104)]);let _0x14e4fb=null;const _0x5b7836={};_0x315822[_0x77f660(0x109)]?.[_0x77f660(0xc8)]&&(_0x5b7836[_0x77f660(0x115)]=_0x315822[_0x77f660(0x109)][_0x77f660(0xc8)],console['log'](_0x77f660(0xfa)+_0x315822[_0x77f660(0x109)][_0x77f660(0xc8)]));_0x315822['payment_method']?.[_0x77f660(0x120)]&&(_0x5b7836[_0x77f660(0x126)]=_0x315822['payment_method'][_0x77f660(0x120)],console[_0x77f660(0x10b)](_0x77f660(0xf8)+_0x315822[_0x77f660(0x109)][_0x77f660(0x120)]));switch(_0x315822[_0x77f660(0xc7)]){case _0x77f660(0x123):_0x14e4fb=_0x77f660(0xe2),console[_0x77f660(0x10b)](_0x77f660(0x11e));break;case'failed':_0x14e4fb=_0x77f660(0xde),_0x5b7836[_0x77f660(0xb6)]=_0x315822[_0x77f660(0xc1)]||_0x315822[_0x77f660(0x128)]||_0x77f660(0x12a),console['log']('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x5b7836[_0x77f660(0xb6)]);break;case _0x77f660(0xbf):console[_0x77f660(0x10b)]('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console[_0x77f660(0x125)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x315822[_0x77f660(0xc7)]);break;}if(_0x14e4fb&&_0x14e4fb!==_0x47b2c0[_0x77f660(0xc7)])console[_0x77f660(0x10b)](_0x77f660(0xec)+_0x47b2c0['status']+_0x77f660(0xeb)+_0x14e4fb),await this[_0x77f660(0x108)][_0x77f660(0xd5)](_0x47b2c0['id'],_0x14e4fb,_0x5b7836),console[_0x77f660(0x10b)](_0x77f660(0xb8)+_0x47b2c0['id']+_0x77f660(0xd7)+_0x14e4fb+_0x77f660(0x111));else _0x14e4fb&&console[_0x77f660(0x10b)](_0x77f660(0xe7)+_0x47b2c0['id']+_0x77f660(0xb4)+_0x14e4fb+_0x77f660(0xcf));_0xd24c60[_0x77f660(0xc7)](0xc8)['json']({'success':!![],'message':_0x77f660(0xb7)});}catch(_0x413bb1){console[_0x77f660(0xf0)](_0x77f660(0xbc),_0x413bb1),_0x18132d(_0x413bb1);}},this[_0xb45073(0xcb)]=async(_0x157f1a,_0x36bf39,_0x5b0ef2)=>{const _0x1749f1=_0xb45073;try{const {limit:_0x4825f5}=_0x157f1a['query'],_0x2271c4=this[_0x1749f1(0x10f)]['getWebhookLogs'](_0x4825f5?parseInt(_0x4825f5):0x32);_0x36bf39[_0x1749f1(0xbb)]({'success':!![],'result':{'logs':_0x2271c4,'count':_0x2271c4[_0x1749f1(0x10e)]}});}catch(_0xde0c83){_0x5b0ef2(_0xde0c83);}},this[_0xb45073(0x10f)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0xb45073(0x12c)][_0xb45073(0xcd)]||'','secretKey':process[_0xb45073(0x12c)][_0xb45073(0xf7)]||'','baseUrl':process[_0xb45073(0x12c)][_0xb45073(0xc3)]||_0xb45073(0xd8),'isTestMode':process[_0xb45073(0x12c)][_0xb45073(0xe5)]==='true'}),this[_0xb45073(0x10a)]=new currencyService_1['CurrencyService'](),this[_0xb45073(0x108)]=new webhookService_1[(_0xb45073(0xc0))]();}}exports[a17_0x5b71aa(0xf2)]=SquirrelPayController;