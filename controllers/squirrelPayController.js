'use strict';const a17_0xc3b844=a17_0x1830;(function(_0xbc0f8c,_0xbdff59){const _0x263e54=a17_0x1830,_0x40bab4=_0xbc0f8c();while(!![]){try{const _0x4907e3=parseInt(_0x263e54(0x230))/0x1*(-parseInt(_0x263e54(0x20e))/0x2)+parseInt(_0x263e54(0x221))/0x3*(-parseInt(_0x263e54(0x22a))/0x4)+-parseInt(_0x263e54(0x265))/0x5*(parseInt(_0x263e54(0x213))/0x6)+-parseInt(_0x263e54(0x25a))/0x7+parseInt(_0x263e54(0x206))/0x8*(parseInt(_0x263e54(0x1f7))/0x9)+-parseInt(_0x263e54(0x219))/0xa+parseInt(_0x263e54(0x238))/0xb;if(_0x4907e3===_0xbdff59)break;else _0x40bab4['push'](_0x40bab4['shift']());}catch(_0x31e933){_0x40bab4['push'](_0x40bab4['shift']());}}}(a17_0x58bb,0x500fc));function a17_0x58bb(){const _0x2bb003=['error','squirrelpay','__esModule','query','slice','https://gate.squirrel-pay.com',',\x20balance\x20updated,\x20amountUSDT\x20calculated','22585057vYMXqX','https://api.trapay.uk','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','toString','SquirrelPayController','padStart','\x20\x20\x20Payment\x20ID:\x20','redirectUrl','toUpperCase','CurrencyService','Webhook\x20processed\x20successfully','friendly_message','amountAfterGatewayCommissionUSDT','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','SQUIRREL_PAY_BASE_URL','has','PAID','payment','../utils/ipHelper','findFirst','&payment_id=','getClientIP','default','\x20\x20\x20Webhook\x20UID:\x20','\x20\x20\x20Billing\x20Country:\x20','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','replace','defineProperty','status','failureMessage','amountUSDT','warn','SQUIRREL_PAY_TEST_MODE','4307009CZRulL','description','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','birth_date','redirect_url','findUnique','json','Headers:','WebhookService','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','FAILED','40DOeWvF','\x20\x20\x20Amount:\x20','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','../services/currencyService','\x20already\x20has\x20status\x20','API_BASE_URL','paidAt','squirrelPayService','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','webhookService','log','__importDefault','../services/webhookService','currency','4144653mRWyPR','handleWebhook','\x20USDT','â„¹ï¸\x20Payment\x20','SquirrelPayService','amount','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','shopId','cardLast4','uid','gateway','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','SQUIRREL_PAY_SECRET_KEY','Missing\x20required\x20card\x20or\x20customer\x20information','headers','8FrIDKV','Payment\x20failed','\x20\x20\x20Customer:\x20','getWebhookLogs','SQUIRREL_PAY_SHOP_ID','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','Payment\x20is\x20being\x20processed',',\x20skipping\x20update','26XokteP','Body:','\x20\x20\x20UID:\x20','processCardPayment','FRONTEND_URL','434730TcMMSZ','\x20updated:\x20status=','\x20\x20\x20Webhook\x20status:\x20','params','toISOString','successful','5422270gfgQzL','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','env','https://app.trapay.uk','ðŸ’°\x20Calculated\x20amountUSDT:\x20','/payment/pending?id=','Payment\x20not\x20found','update','449907pJWrRi','message','\x20commission:\x20','Payment\x20processed\x20successfully','getPaymentStatus','logWebhook','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','toFixed','requires_action','4iZsckM','body','ðŸ’°\x20Gateway\x20','true','âœ…\x20Payment\x20','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','22973PVLJzS'];a17_0x58bb=function(){return _0x2bb003;};return a17_0x58bb();}var __importDefault=this&&this[a17_0xc3b844(0x1f4)]||function(_0x3eb9a3){const _0x4a4e87=a17_0xc3b844;return _0x3eb9a3&&_0x3eb9a3[_0x4a4e87(0x233)]?_0x3eb9a3:{'default':_0x3eb9a3};};Object[a17_0xc3b844(0x254)](exports,a17_0xc3b844(0x233),{'value':!![]}),exports[a17_0xc3b844(0x23c)]=void 0x0;function a17_0x1830(_0x27c9cf,_0x47712b){_0x27c9cf=_0x27c9cf-0x1f2;const _0x58bb24=a17_0x58bb();let _0x1830d0=_0x58bb24[_0x27c9cf];return _0x1830d0;}const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a17_0xc3b844(0x268)),webhookService_1=require(a17_0xc3b844(0x1f5)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a17_0xc3b844(0x24b)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x3d3aa8){const _0x438b4c=a17_0xc3b844;return ISO_COUNTRY_CODES[_0x438b4c(0x248)](_0x3d3aa8[_0x438b4c(0x240)]());}class SquirrelPayController{constructor(){const _0x293a9c=a17_0xc3b844;this[_0x293a9c(0x211)]=async(_0xa172b8,_0x378fdb,_0x13a945)=>{const _0x405898=_0x293a9c;try{const {paymentId:_0x3a69e7}=_0xa172b8[_0x405898(0x216)],{card_number:_0x5980d1,exp_month:_0x4f4c64,exp_year:_0x258fe6,cvv:_0x263e17,holder_name:_0x2427b5,customer_email:_0x590f28,customer_birth_date:_0x338d29,billing_country:_0x47f67f,customer_phone:_0x170390,billing_address:_0x19eef7,billing_city:_0x44fe67,billing_state:_0x4525b2,billing_zip:_0x174f2b}=_0xa172b8['body'];console[_0x405898(0x1f3)]('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x3a69e7);if(!_0x5980d1||!_0x4f4c64||!_0x258fe6||!_0x263e17||!_0x2427b5||!_0x590f28)return _0x378fdb[_0x405898(0x255)](0x190)[_0x405898(0x260)]({'success':![],'message':_0x405898(0x204)});if(_0x47f67f&&!isValidCountryCode(_0x47f67f))return _0x378fdb[_0x405898(0x255)](0x190)[_0x405898(0x260)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x27874c=await database_1[_0x405898(0x24f)][_0x405898(0x24a)][_0x405898(0x25f)]({'where':{'id':_0x3a69e7},'include':{'shop':!![]}});if(!_0x27874c)return _0x378fdb['status'](0x194)[_0x405898(0x260)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x27874c[_0x405898(0x255)]!=='PENDING')return _0x378fdb[_0x405898(0x255)](0x190)[_0x405898(0x260)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x1c408f=(0x0,ipHelper_1[_0x405898(0x24e)])(_0xa172b8),_0x5edf8c={'number':_0x5980d1[_0x405898(0x253)](/\s/g,''),'exp_month':_0x4f4c64['toString']()[_0x405898(0x23d)](0x2,'0'),'exp_year':_0x258fe6[_0x405898(0x23b)](),'verification_value':_0x263e17,'holder':_0x2427b5[_0x405898(0x240)]()},_0x12bcd9={'ip':_0x1c408f,'email':_0x590f28};_0x338d29&&(_0x12bcd9[_0x405898(0x25d)]=_0x338d29);let _0x47a175;_0x47f67f&&(_0x47a175={'country':_0x47f67f,'address':_0x19eef7,'city':_0x44fe67,'state':_0x4525b2,'zip':_0x174f2b});const _0x124ad3=(process[_0x405898(0x21b)][_0x405898(0x212)]||_0x405898(0x21c))+_0x405898(0x21e)+_0x3a69e7+_0x405898(0x24d)+(_0x27874c['gatewayOrderId']||_0x3a69e7),_0x4754a5=(process[_0x405898(0x21b)][_0x405898(0x26a)]||_0x405898(0x239))+'/api/webhooks/squirrel-pay',_0x4f4593=_0x3a69e7[_0x405898(0x235)](0x0,0x8)+'-'+_0x3a69e7[_0x405898(0x235)](0x8,0x10);console[_0x405898(0x1f3)](_0x405898(0x246)),console[_0x405898(0x1f3)](_0x405898(0x23e)+_0x3a69e7),console[_0x405898(0x1f3)](_0x405898(0x266)+_0x27874c[_0x405898(0x1fc)]+'\x20'+_0x27874c[_0x405898(0x1f6)]),console[_0x405898(0x1f3)](_0x405898(0x208)+_0x590f28+'\x20('+_0x1c408f+')'),console[_0x405898(0x1f3)](_0x405898(0x251)+(_0x47f67f||'not\x20provided')),console[_0x405898(0x1f3)]('\x20\x20\x20Description:\x20'+_0x4f4593);const _0x4d6938=await this[_0x405898(0x26c)][_0x405898(0x211)](Math['round'](_0x27874c[_0x405898(0x1fc)]*0x64),_0x27874c['currency'],_0x4f4593,_0x124ad3,_0x4754a5,_0x5edf8c,_0x12bcd9,_0x47a175,_0x170390),_0x33d5b3=this['squirrelPayService'][_0x405898(0x225)](_0x4d6938),_0xe6426e={'gatewayPaymentId':_0x4d6938[_0x405898(0x200)],'cardLast4':_0x33d5b3[_0x405898(0x1ff)],'gateway':_0x405898(0x232),'customerEmail':_0x590f28,'customerPhone':_0x170390,'customerBirthDate':_0x338d29,'billingAddress':_0x19eef7,'billingCity':_0x44fe67,'billingState':_0x4525b2,'billingZip':_0x174f2b,'customerCountry':_0x47f67f};if(_0x33d5b3[_0x405898(0x255)]===_0x405898(0x249)){_0xe6426e[_0x405898(0x255)]=_0x405898(0x249),_0xe6426e[_0x405898(0x26b)]=new Date();try{const _0x5cfa2a=await this['currencyService']['convertToUSDT'](_0x27874c[_0x405898(0x1fc)],_0x27874c[_0x405898(0x1f6)]);_0xe6426e[_0x405898(0x257)]=_0x5cfa2a,console['log'](_0x405898(0x21d)+_0x5cfa2a+_0x405898(0x1f9));const _0x2ea5dd=await this['webhookService']['getGatewayCommission'](_0x27874c[_0x405898(0x1fe)],_0x27874c['gateway']),_0x276a42=_0x5cfa2a*(0x1-_0x2ea5dd/0x64);_0xe6426e[_0x405898(0x244)]=_0x276a42,_0xe6426e['gatewayCommissionRate']=_0x2ea5dd,console[_0x405898(0x1f3)](_0x405898(0x22c)+_0x27874c[_0x405898(0x201)]+_0x405898(0x223)+_0x2ea5dd+'%'),console[_0x405898(0x1f3)](_0x405898(0x22f)+_0x276a42[_0x405898(0x228)](0x6)+_0x405898(0x1f9));}catch(_0x2bebee){console[_0x405898(0x231)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x2bebee),_0xe6426e[_0x405898(0x257)]=0x0,_0xe6426e[_0x405898(0x244)]=0x0,_0xe6426e['gatewayCommissionRate']=0x0;}}else _0x33d5b3[_0x405898(0x255)]===_0x405898(0x264)&&(_0xe6426e[_0x405898(0x255)]=_0x405898(0x264),_0xe6426e[_0x405898(0x256)]=_0x33d5b3[_0x405898(0x256)]);const _0x397745=await database_1[_0x405898(0x24f)]['payment'][_0x405898(0x220)]({'where':{'id':_0x3a69e7},'data':_0xe6426e});console[_0x405898(0x1f3)](_0x405898(0x26d)+_0x397745[_0x405898(0x255)]);let _0xa7d6ef;if(_0x33d5b3[_0x405898(0x255)]==='FAILED')_0xa7d6ef=_0x33d5b3[_0x405898(0x256)]||_0x4d6938[_0x405898(0x243)]||_0x405898(0x207);else _0x33d5b3[_0x405898(0x255)]==='PENDING'?_0xa7d6ef=_0x4d6938['friendly_message']||_0x405898(0x20c):_0xa7d6ef=_0x4d6938[_0x405898(0x243)]||_0x405898(0x224);const _0x214b2a={'success':_0x33d5b3[_0x405898(0x255)]!==_0x405898(0x264),'status':_0x33d5b3[_0x405898(0x255)],'message':_0xa7d6ef,'payment':{'id':_0x3a69e7,'status':_0x397745[_0x405898(0x255)],'gateway':_0x405898(0x232),'last4':_0x33d5b3[_0x405898(0x1ff)]}};_0x33d5b3['redirectUrl']&&(_0x214b2a[_0x405898(0x25e)]=_0x33d5b3[_0x405898(0x23f)],_0x214b2a[_0x405898(0x229)]=!![],console[_0x405898(0x1f3)](_0x405898(0x245)+_0x33d5b3[_0x405898(0x23f)])),_0x378fdb[_0x405898(0x260)](_0x214b2a);}catch(_0xe9e20f){console['error'](_0x405898(0x21a),_0xe9e20f),_0x13a945(_0xe9e20f);}},this[_0x293a9c(0x1f8)]=async(_0x3b9aa7,_0x4aa59d,_0x37c7a9)=>{const _0x11e11b=_0x293a9c;try{console[_0x11e11b(0x1f3)](_0x11e11b(0x25c)),console[_0x11e11b(0x1f3)](_0x11e11b(0x261),_0x3b9aa7[_0x11e11b(0x205)]),console['log'](_0x11e11b(0x20f),_0x3b9aa7[_0x11e11b(0x22b)]),this[_0x11e11b(0x26c)][_0x11e11b(0x226)]({'headers':_0x3b9aa7[_0x11e11b(0x205)],'body':_0x3b9aa7[_0x11e11b(0x22b)],'timestamp':new Date()[_0x11e11b(0x217)]()});const _0x2c1b26=_0x3b9aa7[_0x11e11b(0x22b)];if(!_0x2c1b26[_0x11e11b(0x200)]||!_0x2c1b26['status'])return console[_0x11e11b(0x258)](_0x11e11b(0x252)),_0x4aa59d[_0x11e11b(0x255)](0x190)[_0x11e11b(0x260)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x159fd2;_0x2c1b26[_0x11e11b(0x200)]&&(_0x159fd2=await database_1[_0x11e11b(0x24f)][_0x11e11b(0x24a)][_0x11e11b(0x24c)]({'where':{'gatewayPaymentId':_0x2c1b26[_0x11e11b(0x200)],'gateway':_0x11e11b(0x232)}}));if(!_0x159fd2)return console['warn']('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x11e11b(0x258)](_0x11e11b(0x210)+_0x2c1b26[_0x11e11b(0x200)]),console[_0x11e11b(0x258)]('\x20\x20\x20Description:\x20'+_0x2c1b26[_0x11e11b(0x25b)]),console[_0x11e11b(0x258)]('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x11e11b(0x258)](_0x11e11b(0x1fd)+_0x2c1b26[_0x11e11b(0x200)]),_0x4aa59d['status'](0x194)['json']({'success':![],'message':_0x11e11b(0x21f)});console[_0x11e11b(0x1f3)](_0x11e11b(0x267)+_0x159fd2['id']),console['log']('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x159fd2[_0x11e11b(0x255)]),console['log'](_0x11e11b(0x23a)+_0x159fd2['gatewayPaymentId']),console[_0x11e11b(0x1f3)](_0x11e11b(0x215)+_0x2c1b26[_0x11e11b(0x255)]),console[_0x11e11b(0x1f3)](_0x11e11b(0x250)+_0x2c1b26[_0x11e11b(0x200)]);let _0x40df53=null;const _0xcfdf39={};switch(_0x2c1b26[_0x11e11b(0x255)]){case _0x11e11b(0x218):_0x40df53='PAID',console['log'](_0x11e11b(0x20b));break;case'failed':_0x40df53=_0x11e11b(0x264),_0xcfdf39[_0x11e11b(0x256)]=_0x2c1b26[_0x11e11b(0x243)]||_0x2c1b26[_0x11e11b(0x222)]||_0x11e11b(0x207),console[_0x11e11b(0x1f3)](_0x11e11b(0x202)+_0xcfdf39[_0x11e11b(0x256)]);break;case'incomplete':console[_0x11e11b(0x1f3)](_0x11e11b(0x227));break;default:console[_0x11e11b(0x258)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x2c1b26[_0x11e11b(0x255)]);break;}if(_0x40df53&&_0x40df53!==_0x159fd2[_0x11e11b(0x255)])console[_0x11e11b(0x1f3)](_0x11e11b(0x263)+_0x159fd2[_0x11e11b(0x255)]+'\x20to\x20'+_0x40df53),await this[_0x11e11b(0x1f2)]['updatePaymentStatus'](_0x159fd2['id'],_0x40df53,_0xcfdf39),console[_0x11e11b(0x1f3)](_0x11e11b(0x22e)+_0x159fd2['id']+_0x11e11b(0x214)+_0x40df53+_0x11e11b(0x237));else _0x40df53&&console[_0x11e11b(0x1f3)](_0x11e11b(0x1fa)+_0x159fd2['id']+_0x11e11b(0x269)+_0x40df53+_0x11e11b(0x20d));_0x4aa59d[_0x11e11b(0x255)](0xc8)[_0x11e11b(0x260)]({'success':!![],'message':_0x11e11b(0x242)});}catch(_0xd018ae){console[_0x11e11b(0x231)]('âŒ\x20SquirrelPay\x20webhook\x20error:',_0xd018ae),_0x37c7a9(_0xd018ae);}},this[_0x293a9c(0x209)]=async(_0x392578,_0x2ee981,_0x3990fe)=>{const _0xe72b85=_0x293a9c;try{const {limit:_0x2c2253}=_0x392578[_0xe72b85(0x234)],_0x43c23c=this[_0xe72b85(0x26c)][_0xe72b85(0x209)](_0x2c2253?parseInt(_0x2c2253):0x32);_0x2ee981[_0xe72b85(0x260)]({'success':!![],'result':{'logs':_0x43c23c,'count':_0x43c23c['length']}});}catch(_0x2dca2a){_0x3990fe(_0x2dca2a);}},this[_0x293a9c(0x26c)]=new squirrelPayService_1[(_0x293a9c(0x1fb))]({'shopId':process[_0x293a9c(0x21b)][_0x293a9c(0x20a)]||'','secretKey':process[_0x293a9c(0x21b)][_0x293a9c(0x203)]||'','baseUrl':process[_0x293a9c(0x21b)][_0x293a9c(0x247)]||_0x293a9c(0x236),'isTestMode':process['env'][_0x293a9c(0x259)]===_0x293a9c(0x22d)}),this['currencyService']=new currencyService_1[(_0x293a9c(0x241))](),this[_0x293a9c(0x1f2)]=new webhookService_1[(_0x293a9c(0x262))]();}}exports[a17_0xc3b844(0x23c)]=SquirrelPayController;