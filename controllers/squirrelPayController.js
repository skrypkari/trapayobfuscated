'use strict';const a17_0x432b68=a17_0x248f;(function(_0x2d0fc0,_0x3273e8){const _0x1bf026=a17_0x248f,_0x2c9d76=_0x2d0fc0();while(!![]){try{const _0x176d5=parseInt(_0x1bf026(0x14b))/0x1+-parseInt(_0x1bf026(0x132))/0x2+-parseInt(_0x1bf026(0x13f))/0x3*(parseInt(_0x1bf026(0x13e))/0x4)+parseInt(_0x1bf026(0x176))/0x5+-parseInt(_0x1bf026(0x14e))/0x6+parseInt(_0x1bf026(0x162))/0x7+-parseInt(_0x1bf026(0x12f))/0x8;if(_0x176d5===_0x3273e8)break;else _0x2c9d76['push'](_0x2c9d76['shift']());}catch(_0x74c4a7){_0x2c9d76['push'](_0x2c9d76['shift']());}}}(a17_0x3253,0x4964a));function a17_0x248f(_0x413d3b,_0x891c4e){_0x413d3b=_0x413d3b-0x125;const _0x3253e5=a17_0x3253();let _0x248f67=_0x3253e5[_0x413d3b];return _0x248f67;}var __importDefault=this&&this[a17_0x432b68(0x15a)]||function(_0x5339a3){const _0x584324=a17_0x432b68;return _0x5339a3&&_0x5339a3[_0x584324(0x128)]?_0x5339a3:{'default':_0x5339a3};};Object[a17_0x432b68(0x17c)](exports,a17_0x432b68(0x128),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a17_0x432b68(0x17e)),currencyService_1=require('../services/currencyService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a17_0x432b68(0x131))),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a17_0x3253(){const _0x57e739=['\x20\x20\x20Payment\x20ID:\x20','default','json','79272uQzCTT','9VjggzU',',\x20skipping\x20update','Body:','âŒ\x20SquirrelPay\x20webhook\x20error:','last_4','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','amount','Missing\x20required\x20fields\x20in\x20webhook','log','Headers:','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','shopId','573477HYNVCp','SquirrelPayService','/api/webhooks/squirrel-pay','124686LuuAnS','Payment\x20processed\x20successfully','WebhookService','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','warn','update','\x20\x20\x20Webhook\x20status:\x20','webhookService','payment_method','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','Missing\x20required\x20card\x20or\x20customer\x20information','amountUSDT','__importDefault','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','âœ…\x20Payment\x20','https://gate.squirrel-pay.com','\x20\x20\x20Webhook\x20UID:\x20','processCardPayment','incomplete','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','2995846ZYPrGc','\x20\x20\x20UID:\x20','\x20\x20\x20Billing\x20Country:\x20','ðŸ’°\x20Gateway\x20','updatePaymentStatus','gatewayOrderId','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','toUpperCase','not\x20provided','\x20updated:\x20status=','toISOString','\x20USDT','currency','failureMessage','getClientIP','gateway','getPaymentStatus','message','amountAfterGatewayCommissionUSDT','PENDING','2715860JpTuHo','payment','replace','slice','length','cardLast4','defineProperty','gatewayPaymentId','../services/gateways/squirrelPayService','getGatewayCommission','/payment/pending?id=','toFixed','status','currencyService','toString','cardBrand','\x20\x20\x20Customer:\x20','squirrelPayService','\x20commission:\x20','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','error','squirrelpay','ðŸ’°\x20Calculated\x20amountUSDT:\x20','&payment_id=','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','convertToUSDT','params','PAID','failed','friendly_message','brand','ðŸ’³\x20Card\x20brand\x20detected:\x20','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','https://app.trapay.uk','__esModule','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','Payment\x20is\x20being\x20processed','uid','\x20\x20\x20Description:\x20','FAILED','\x20\x20\x20Gateway:\x20squirrelpay','6200024UmZVhL','Payment\x20not\x20found','../config/database','777542AhnlNt','redirectUrl','body','Webhook\x20processed\x20successfully','gatewayCommissionRate',',\x20balance\x20updated,\x20amountUSDT\x20calculated','headers','\x20\x20\x20Amount:\x20','getWebhookLogs'];a17_0x3253=function(){return _0x57e739;};return a17_0x3253();}function isValidCountryCode(_0x51a20a){const _0x12bad4=a17_0x432b68;return ISO_COUNTRY_CODES['has'](_0x51a20a[_0x12bad4(0x169)]());}class SquirrelPayController{constructor(){const _0x32ad8f=a17_0x432b68;this[_0x32ad8f(0x15f)]=async(_0x302979,_0x283434,_0x1e26d7)=>{const _0x40d04f=_0x32ad8f;try{const {paymentId:_0x1ff6de}=_0x302979[_0x40d04f(0x190)],{card_number:_0x295f9e,exp_month:_0x5a1c8a,exp_year:_0x28ad8b,cvv:_0x4d4a9c,holder_name:_0x120e22,customer_email:_0x132fa1,customer_birth_date:_0x42a02e,billing_country:_0xb55607,customer_phone:_0x4d8aca,billing_address:_0x529df9,billing_city:_0x19f26a,billing_state:_0x2aca90,billing_zip:_0x50949b}=_0x302979[_0x40d04f(0x134)];console['log'](_0x40d04f(0x15b)+_0x1ff6de);if(!_0x295f9e||!_0x5a1c8a||!_0x28ad8b||!_0x4d4a9c||!_0x120e22||!_0x132fa1)return _0x283434[_0x40d04f(0x182)](0x190)[_0x40d04f(0x13d)]({'success':![],'message':_0x40d04f(0x158)});if(_0xb55607&&!isValidCountryCode(_0xb55607))return _0x283434['status'](0x190)[_0x40d04f(0x13d)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x433486=await database_1['default'][_0x40d04f(0x177)]['findUnique']({'where':{'id':_0x1ff6de},'include':{'shop':!![]}});if(!_0x433486)return _0x283434[_0x40d04f(0x182)](0x194)['json']({'success':![],'message':_0x40d04f(0x130)});if(_0x433486['status']!==_0x40d04f(0x175))return _0x283434['status'](0x190)[_0x40d04f(0x13d)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x6b20de=(0x0,ipHelper_1[_0x40d04f(0x170)])(_0x302979),_0x5e03c7={'number':_0x295f9e[_0x40d04f(0x178)](/\s/g,''),'exp_month':_0x5a1c8a[_0x40d04f(0x184)]()['padStart'](0x2,'0'),'exp_year':_0x28ad8b[_0x40d04f(0x184)](),'verification_value':_0x4d4a9c,'holder':_0x120e22[_0x40d04f(0x169)]()},_0x3c5c1b={'ip':_0x6b20de,'email':_0x132fa1};_0x42a02e&&(_0x3c5c1b['birth_date']=_0x42a02e);let _0x3f497d;_0xb55607&&(_0x3f497d={'country':_0xb55607,'address':_0x529df9,'city':_0x19f26a,'state':_0x2aca90,'zip':_0x50949b});const _0x4aa2de=(process.env.FRONTEND_URL||_0x40d04f(0x127))+_0x40d04f(0x180)+_0x1ff6de+_0x40d04f(0x18d)+(_0x433486[_0x40d04f(0x167)]||_0x1ff6de),_0x13e4c0=(process.env.API_BASE_URL||'https://api.trapay.uk')+_0x40d04f(0x14d),_0x2bae65=_0x1ff6de[_0x40d04f(0x179)](0x0,0x8)+'-'+_0x1ff6de[_0x40d04f(0x179)](0x8,0x10);console[_0x40d04f(0x147)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console[_0x40d04f(0x147)](_0x40d04f(0x13b)+_0x1ff6de),console[_0x40d04f(0x147)](_0x40d04f(0x139)+_0x433486[_0x40d04f(0x145)]+'\x20'+_0x433486['currency']),console[_0x40d04f(0x147)](_0x40d04f(0x186)+_0x132fa1+'\x20('+_0x6b20de+')'),console[_0x40d04f(0x147)](_0x40d04f(0x164)+(_0xb55607||_0x40d04f(0x16a))),console[_0x40d04f(0x147)]('\x20\x20\x20Description:\x20'+_0x2bae65);const _0x4dafcf=await this[_0x40d04f(0x187)][_0x40d04f(0x15f)](Math['round'](_0x433486['amount']*0x64),_0x433486[_0x40d04f(0x16e)],_0x2bae65,_0x4aa2de,_0x13e4c0,_0x5e03c7,_0x3c5c1b,_0x3f497d,_0x4d8aca),_0x599daa=this[_0x40d04f(0x187)][_0x40d04f(0x172)](_0x4dafcf),_0x2f6538={'gatewayPaymentId':_0x4dafcf[_0x40d04f(0x12b)],'cardLast4':_0x599daa[_0x40d04f(0x17b)],'gateway':_0x40d04f(0x18b),'customerEmail':_0x132fa1,'customerPhone':_0x4d8aca,'customerBirthDate':_0x42a02e,'billingAddress':_0x529df9,'billingCity':_0x19f26a,'billingState':_0x2aca90,'billingZip':_0x50949b,'customerCountry':_0xb55607};if(_0x599daa['status']===_0x40d04f(0x191)){_0x2f6538[_0x40d04f(0x182)]=_0x40d04f(0x191),_0x2f6538['paidAt']=new Date();try{const _0x121638=await this[_0x40d04f(0x183)][_0x40d04f(0x18f)](_0x433486[_0x40d04f(0x145)],_0x433486['currency']);_0x2f6538[_0x40d04f(0x159)]=_0x121638,console['log'](_0x40d04f(0x18c)+_0x121638+_0x40d04f(0x16d));const _0x3d529b=await this[_0x40d04f(0x155)][_0x40d04f(0x17f)](_0x433486[_0x40d04f(0x14a)],_0x433486[_0x40d04f(0x171)]),_0x3075ad=_0x121638*(0x1-_0x3d529b/0x64);_0x2f6538[_0x40d04f(0x174)]=_0x3075ad,_0x2f6538['gatewayCommissionRate']=_0x3d529b,console[_0x40d04f(0x147)](_0x40d04f(0x165)+_0x433486['gateway']+_0x40d04f(0x188)+_0x3d529b+'%'),console['log']('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x3075ad[_0x40d04f(0x181)](0x6)+_0x40d04f(0x16d));}catch(_0x488b5b){console['error'](_0x40d04f(0x151),_0x488b5b),_0x2f6538[_0x40d04f(0x159)]=0x0,_0x2f6538['amountAfterGatewayCommissionUSDT']=0x0,_0x2f6538[_0x40d04f(0x136)]=0x0;}}else _0x599daa[_0x40d04f(0x182)]==='FAILED'&&(_0x2f6538[_0x40d04f(0x182)]=_0x40d04f(0x12d),_0x2f6538[_0x40d04f(0x16f)]=_0x599daa['failureMessage']);const _0xd515fd=await database_1[_0x40d04f(0x13c)][_0x40d04f(0x177)][_0x40d04f(0x153)]({'where':{'id':_0x1ff6de},'data':_0x2f6538});console[_0x40d04f(0x147)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0xd515fd['status']);let _0x3099f9;if(_0x599daa[_0x40d04f(0x182)]===_0x40d04f(0x12d))_0x3099f9=_0x599daa[_0x40d04f(0x16f)]||_0x4dafcf[_0x40d04f(0x193)]||'Payment\x20failed';else _0x599daa[_0x40d04f(0x182)]==='PENDING'?_0x3099f9=_0x4dafcf[_0x40d04f(0x193)]||_0x40d04f(0x12a):_0x3099f9=_0x4dafcf[_0x40d04f(0x193)]||_0x40d04f(0x14f);const _0x173c5e={'success':_0x599daa[_0x40d04f(0x182)]!=='FAILED','status':_0x599daa['status'],'message':_0x3099f9,'payment':{'id':_0x1ff6de,'status':_0xd515fd[_0x40d04f(0x182)],'gateway':_0x40d04f(0x18b),'last4':_0x599daa[_0x40d04f(0x17b)]}};_0x599daa['redirectUrl']&&(_0x173c5e['redirect_url']=_0x599daa[_0x40d04f(0x133)],_0x173c5e['requires_action']=!![],console[_0x40d04f(0x147)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x599daa[_0x40d04f(0x133)])),_0x283434[_0x40d04f(0x13d)](_0x173c5e);}catch(_0x1deb85){console[_0x40d04f(0x18a)](_0x40d04f(0x149),_0x1deb85),_0x1e26d7(_0x1deb85);}},this['handleWebhook']=async(_0x3b43d2,_0x2d051f,_0x544cd9)=>{const _0x51c9e4=_0x32ad8f;try{console[_0x51c9e4(0x147)](_0x51c9e4(0x129)),console[_0x51c9e4(0x147)](_0x51c9e4(0x148),_0x3b43d2[_0x51c9e4(0x138)]),console['log'](_0x51c9e4(0x141),_0x3b43d2[_0x51c9e4(0x134)]),this[_0x51c9e4(0x187)]['logWebhook']({'headers':_0x3b43d2[_0x51c9e4(0x138)],'body':_0x3b43d2[_0x51c9e4(0x134)],'timestamp':new Date()[_0x51c9e4(0x16c)]()});const _0x26e73c=_0x3b43d2['body'];if(!_0x26e73c['uid']||!_0x26e73c['status'])return console['warn']('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x2d051f[_0x51c9e4(0x182)](0x190)['json']({'success':![],'message':_0x51c9e4(0x146)});let _0x2741dc;_0x26e73c['uid']&&(_0x2741dc=await database_1['default']['payment']['findFirst']({'where':{'gatewayPaymentId':_0x26e73c[_0x51c9e4(0x12b)],'gateway':_0x51c9e4(0x18b)}}));if(!_0x2741dc)return console['warn'](_0x51c9e4(0x168)),console[_0x51c9e4(0x152)](_0x51c9e4(0x163)+_0x26e73c[_0x51c9e4(0x12b)]),console[_0x51c9e4(0x152)](_0x51c9e4(0x12c)+_0x26e73c['description']),console[_0x51c9e4(0x152)](_0x51c9e4(0x12e)),console[_0x51c9e4(0x152)](_0x51c9e4(0x161)+_0x26e73c[_0x51c9e4(0x12b)]),_0x2d051f[_0x51c9e4(0x182)](0x194)[_0x51c9e4(0x13d)]({'success':![],'message':_0x51c9e4(0x130)});console['log']('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x2741dc['id']),console[_0x51c9e4(0x147)](_0x51c9e4(0x144)+_0x2741dc[_0x51c9e4(0x182)]),console[_0x51c9e4(0x147)](_0x51c9e4(0x18e)+_0x2741dc[_0x51c9e4(0x17d)]),console[_0x51c9e4(0x147)](_0x51c9e4(0x154)+_0x26e73c[_0x51c9e4(0x182)]),console[_0x51c9e4(0x147)](_0x51c9e4(0x15e)+_0x26e73c[_0x51c9e4(0x12b)]);let _0x767318=null;const _0x2fa391={};_0x26e73c[_0x51c9e4(0x156)]?.[_0x51c9e4(0x194)]&&(_0x2fa391[_0x51c9e4(0x185)]=_0x26e73c[_0x51c9e4(0x156)][_0x51c9e4(0x194)],console[_0x51c9e4(0x147)](_0x51c9e4(0x195)+_0x26e73c[_0x51c9e4(0x156)][_0x51c9e4(0x194)]));_0x26e73c[_0x51c9e4(0x156)]?.[_0x51c9e4(0x143)]&&(_0x2fa391[_0x51c9e4(0x17b)]=_0x26e73c[_0x51c9e4(0x156)]['last_4'],console['log']('ðŸ’³\x20Card\x20last\x204:\x20'+_0x26e73c[_0x51c9e4(0x156)][_0x51c9e4(0x143)]));switch(_0x26e73c['status']){case'successful':_0x767318=_0x51c9e4(0x191),console[_0x51c9e4(0x147)](_0x51c9e4(0x126));break;case _0x51c9e4(0x192):_0x767318=_0x51c9e4(0x12d),_0x2fa391[_0x51c9e4(0x16f)]=_0x26e73c[_0x51c9e4(0x193)]||_0x26e73c[_0x51c9e4(0x173)]||'Payment\x20failed',console[_0x51c9e4(0x147)](_0x51c9e4(0x125)+_0x2fa391['failureMessage']);break;case _0x51c9e4(0x160):console[_0x51c9e4(0x147)](_0x51c9e4(0x157));break;default:console[_0x51c9e4(0x152)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x26e73c['status']);break;}if(_0x767318&&_0x767318!==_0x2741dc[_0x51c9e4(0x182)])console[_0x51c9e4(0x147)](_0x51c9e4(0x189)+_0x2741dc['status']+'\x20to\x20'+_0x767318),await this['webhookService'][_0x51c9e4(0x166)](_0x2741dc['id'],_0x767318,_0x2fa391),console[_0x51c9e4(0x147)](_0x51c9e4(0x15c)+_0x2741dc['id']+_0x51c9e4(0x16b)+_0x767318+_0x51c9e4(0x137));else _0x767318&&console[_0x51c9e4(0x147)]('â„¹ï¸\x20Payment\x20'+_0x2741dc['id']+'\x20already\x20has\x20status\x20'+_0x767318+_0x51c9e4(0x140));_0x2d051f[_0x51c9e4(0x182)](0xc8)['json']({'success':!![],'message':_0x51c9e4(0x135)});}catch(_0x26f1d4){console[_0x51c9e4(0x18a)](_0x51c9e4(0x142),_0x26f1d4),_0x544cd9(_0x26f1d4);}},this[_0x32ad8f(0x13a)]=async(_0x7016be,_0x559deb,_0x174c45)=>{const _0x35c7c7=_0x32ad8f;try{const {limit:_0x1552ae}=_0x7016be['query'],_0x5bfb9d=this[_0x35c7c7(0x187)][_0x35c7c7(0x13a)](_0x1552ae?parseInt(_0x1552ae):0x32);_0x559deb[_0x35c7c7(0x13d)]({'success':!![],'result':{'logs':_0x5bfb9d,'count':_0x5bfb9d[_0x35c7c7(0x17a)]}});}catch(_0x2abce2){_0x174c45(_0x2abce2);}},this[_0x32ad8f(0x187)]=new squirrelPayService_1[(_0x32ad8f(0x14c))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x32ad8f(0x15d),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE==='true'}),this[_0x32ad8f(0x183)]=new currencyService_1['CurrencyService'](),this['webhookService']=new webhookService_1[(_0x32ad8f(0x150))]();}}exports['SquirrelPayController']=SquirrelPayController;