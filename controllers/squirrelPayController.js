'use strict';const a16_0x3d43ae=a16_0x1238;(function(_0xc249c6,_0x573b9a){const _0x33d55b=a16_0x1238,_0x142cfc=_0xc249c6();while(!![]){try{const _0x41ba03=parseInt(_0x33d55b(0x153))/0x1+parseInt(_0x33d55b(0x110))/0x2+-parseInt(_0x33d55b(0x147))/0x3+-parseInt(_0x33d55b(0x106))/0x4+-parseInt(_0x33d55b(0x11a))/0x5+-parseInt(_0x33d55b(0xfc))/0x6*(parseInt(_0x33d55b(0x138))/0x7)+parseInt(_0x33d55b(0x124))/0x8;if(_0x41ba03===_0x573b9a)break;else _0x142cfc['push'](_0x142cfc['shift']());}catch(_0x76a651){_0x142cfc['push'](_0x142cfc['shift']());}}}(a16_0x69d4,0x55839));var __importDefault=this&&this['__importDefault']||function(_0x22b37e){const _0x38747f=a16_0x1238;return _0x22b37e&&_0x22b37e[_0x38747f(0x163)]?_0x22b37e:{'default':_0x22b37e};};Object['defineProperty'](exports,a16_0x3d43ae(0x163),{'value':!![]}),exports[a16_0x3d43ae(0x143)]=void 0x0;const squirrelPayService_1=require(a16_0x3d43ae(0x14d)),currencyService_1=require(a16_0x3d43ae(0x137)),webhookService_1=require(a16_0x3d43ae(0x10d)),database_1=__importDefault(require(a16_0x3d43ae(0x109))),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x140f4e){const _0x28792f=a16_0x3d43ae;return ISO_COUNTRY_CODES[_0x28792f(0x12d)](_0x140f4e[_0x28792f(0x12c)]());}function a16_0x1238(_0x4b9cf0,_0x5b851f){_0x4b9cf0=_0x4b9cf0-0xf9;const _0x69d412=a16_0x69d4();let _0x123897=_0x69d412[_0x4b9cf0];return _0x123897;}class SquirrelPayController{constructor(){const _0x356a54=a16_0x3d43ae;this[_0x356a54(0x104)]=async(_0x4841b3,_0x499cb7,_0x121720)=>{const _0x1ec15d=_0x356a54;try{const {paymentId:_0x8f3ccc}=_0x4841b3[_0x1ec15d(0x169)],{card_number:_0x4367de,exp_month:_0x40483d,exp_year:_0x9c24bb,cvv:_0x16b797,holder_name:_0x51d636,customer_email:_0x24101a,customer_birth_date:_0xc6140,billing_country:_0x20ea42,customer_phone:_0x2d377e,billing_address:_0x10f956,billing_city:_0x587f01,billing_state:_0x22e45e,billing_zip:_0x162964}=_0x4841b3[_0x1ec15d(0x126)];console['log'](_0x1ec15d(0xfb)+_0x8f3ccc);if(!_0x4367de||!_0x40483d||!_0x9c24bb||!_0x16b797||!_0x51d636||!_0x24101a)return _0x499cb7[_0x1ec15d(0x152)](0x190)[_0x1ec15d(0x170)]({'success':![],'message':_0x1ec15d(0x158)});if(_0x20ea42&&!isValidCountryCode(_0x20ea42))return _0x499cb7[_0x1ec15d(0x152)](0x190)[_0x1ec15d(0x170)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x30adb5=await database_1[_0x1ec15d(0x142)][_0x1ec15d(0x16f)][_0x1ec15d(0xfd)]({'where':{'id':_0x8f3ccc},'include':{'shop':!![]}});if(!_0x30adb5)return _0x499cb7['status'](0x194)[_0x1ec15d(0x170)]({'success':![],'message':_0x1ec15d(0x10f)});if(_0x30adb5[_0x1ec15d(0x152)]!==_0x1ec15d(0x155))return _0x499cb7[_0x1ec15d(0x152)](0x190)[_0x1ec15d(0x170)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x24a0f8=(0x0,ipHelper_1['getClientIP'])(_0x4841b3),_0x1ccd2d={'number':_0x4367de['replace'](/\s/g,''),'exp_month':_0x40483d[_0x1ec15d(0x15a)]()[_0x1ec15d(0x123)](0x2,'0'),'exp_year':_0x9c24bb[_0x1ec15d(0x15a)](),'verification_value':_0x16b797,'holder':_0x51d636['toUpperCase']()},_0x5a87d8={'ip':_0x24a0f8,'email':_0x24101a};_0xc6140&&(_0x5a87d8['birth_date']=_0xc6140);let _0x5e3589;_0x20ea42&&(_0x5e3589={'country':_0x20ea42,'address':_0x10f956,'city':_0x587f01,'state':_0x22e45e,'zip':_0x162964});const _0x5e701b=(process[_0x1ec15d(0x14e)][_0x1ec15d(0x16c)]||_0x1ec15d(0x13a))+'/payment/pending?id='+_0x8f3ccc+'&payment_id='+(_0x30adb5[_0x1ec15d(0x117)]||_0x8f3ccc),_0x77390a=(process[_0x1ec15d(0x14e)][_0x1ec15d(0x10e)]||'https://api.trapay.uk')+_0x1ec15d(0x105),_0x537df2=_0x8f3ccc[_0x1ec15d(0x14f)](0x0,0x8)+'-'+_0x8f3ccc[_0x1ec15d(0x14f)](0x8,0x10);console['log'](_0x1ec15d(0x114)),console[_0x1ec15d(0x173)](_0x1ec15d(0x119)+_0x8f3ccc),console['log'](_0x1ec15d(0x113)+_0x30adb5['amount']+'\x20'+_0x30adb5[_0x1ec15d(0x118)]),console[_0x1ec15d(0x173)](_0x1ec15d(0x15f)+_0x24101a+'\x20('+_0x24a0f8+')'),console[_0x1ec15d(0x173)](_0x1ec15d(0x172)+(_0x20ea42||_0x1ec15d(0x14b))),console['log'](_0x1ec15d(0x168)+_0x537df2);const _0x7685bd=await this['squirrelPayService'][_0x1ec15d(0x104)](Math[_0x1ec15d(0x125)](_0x30adb5['amount']*0x64),_0x30adb5[_0x1ec15d(0x118)],_0x537df2,_0x5e701b,_0x77390a,_0x1ccd2d,_0x5a87d8,_0x5e3589,_0x2d377e),_0xd9c31f=this[_0x1ec15d(0x122)]['getPaymentStatus'](_0x7685bd),_0xbcb9a6={'gatewayPaymentId':_0x7685bd[_0x1ec15d(0x16b)],'cardLast4':_0xd9c31f[_0x1ec15d(0x121)],'gateway':'squirrelpay','customerEmail':_0x24101a,'customerPhone':_0x2d377e,'customerBirthDate':_0xc6140,'billingAddress':_0x10f956,'billingCity':_0x587f01,'billingState':_0x22e45e,'billingZip':_0x162964,'customerCountry':_0x20ea42};if(_0xd9c31f['status']===_0x1ec15d(0x10b)){_0xbcb9a6[_0x1ec15d(0x152)]=_0x1ec15d(0x10b),_0xbcb9a6['paidAt']=new Date();try{const _0x4a6e02=await this[_0x1ec15d(0x10a)][_0x1ec15d(0x132)](_0x30adb5[_0x1ec15d(0x164)],_0x30adb5[_0x1ec15d(0x118)]);_0xbcb9a6[_0x1ec15d(0x13f)]=_0x4a6e02,console[_0x1ec15d(0x173)]('üí∞\x20Calculated\x20amountUSDT:\x20'+_0x4a6e02+_0x1ec15d(0x140));const _0x3f4179=await this[_0x1ec15d(0x141)][_0x1ec15d(0x135)](_0x30adb5[_0x1ec15d(0x108)],_0x30adb5[_0x1ec15d(0x116)]),_0x441f91=_0x4a6e02*(0x1-_0x3f4179/0x64);_0xbcb9a6[_0x1ec15d(0x144)]=_0x441f91,_0xbcb9a6['gatewayCommissionRate']=_0x3f4179,console[_0x1ec15d(0x173)]('üí∞\x20Gateway\x20'+_0x30adb5[_0x1ec15d(0x116)]+_0x1ec15d(0x162)+_0x3f4179+'%'),console[_0x1ec15d(0x173)](_0x1ec15d(0x101)+_0x441f91[_0x1ec15d(0x166)](0x6)+_0x1ec15d(0x140));}catch(_0x3bbc0a){console[_0x1ec15d(0x120)](_0x1ec15d(0x128),_0x3bbc0a),_0xbcb9a6[_0x1ec15d(0x13f)]=0x0,_0xbcb9a6['amountAfterGatewayCommissionUSDT']=0x0,_0xbcb9a6['gatewayCommissionRate']=0x0;}}else _0xd9c31f[_0x1ec15d(0x152)]===_0x1ec15d(0xfe)&&(_0xbcb9a6[_0x1ec15d(0x152)]=_0x1ec15d(0xfe),_0xbcb9a6[_0x1ec15d(0x133)]=_0xd9c31f[_0x1ec15d(0x133)]);const _0x5558e7=await database_1['default']['payment'][_0x1ec15d(0x148)]({'where':{'id':_0x8f3ccc},'data':_0xbcb9a6});console[_0x1ec15d(0x173)](_0x1ec15d(0x11d)+_0x5558e7[_0x1ec15d(0x152)]);let _0x1b9648;if(_0xd9c31f['status']===_0x1ec15d(0xfe))_0x1b9648=_0xd9c31f[_0x1ec15d(0x133)]||_0x7685bd[_0x1ec15d(0x150)]||_0x1ec15d(0x167);else _0xd9c31f['status']===_0x1ec15d(0x155)?_0x1b9648=_0x7685bd[_0x1ec15d(0x150)]||_0x1ec15d(0x12a):_0x1b9648=_0x7685bd[_0x1ec15d(0x150)]||_0x1ec15d(0xf9);const _0x319a57={'success':_0xd9c31f[_0x1ec15d(0x152)]!=='FAILED','status':_0xd9c31f[_0x1ec15d(0x152)],'message':_0x1b9648,'payment':{'id':_0x8f3ccc,'status':_0x5558e7['status'],'gateway':_0x1ec15d(0x154),'last4':_0xd9c31f['cardLast4']}};_0xd9c31f[_0x1ec15d(0xff)]&&(_0x319a57[_0x1ec15d(0x13b)]=_0xd9c31f['redirectUrl'],_0x319a57[_0x1ec15d(0x130)]=!![],console['log'](_0x1ec15d(0x13c)+_0xd9c31f[_0x1ec15d(0xff)])),_0x499cb7[_0x1ec15d(0x170)](_0x319a57);}catch(_0x3380a1){console[_0x1ec15d(0x120)]('‚ùå\x20SquirrelPay\x20card\x20payment\x20error:',_0x3380a1),_0x121720(_0x3380a1);}},this[_0x356a54(0x159)]=async(_0x13fde0,_0x3344e3,_0x2b375a)=>{const _0x17dc0a=_0x356a54;try{console[_0x17dc0a(0x173)](_0x17dc0a(0x11f)),console['log'](_0x17dc0a(0x11e),_0x13fde0['headers']),console['log'](_0x17dc0a(0x16d),_0x13fde0[_0x17dc0a(0x126)]),this['squirrelPayService']['logWebhook']({'headers':_0x13fde0[_0x17dc0a(0x112)],'body':_0x13fde0[_0x17dc0a(0x126)],'timestamp':new Date()[_0x17dc0a(0x13d)]()});const _0x2b7523=_0x13fde0[_0x17dc0a(0x126)];if(!_0x2b7523[_0x17dc0a(0x16b)]||!_0x2b7523[_0x17dc0a(0x152)])return console[_0x17dc0a(0x16a)]('‚ö†Ô∏è\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x3344e3['status'](0x190)[_0x17dc0a(0x170)]({'success':![],'message':_0x17dc0a(0x171)});let _0x5d610e;_0x2b7523[_0x17dc0a(0x16b)]&&(_0x5d610e=await database_1[_0x17dc0a(0x142)]['payment'][_0x17dc0a(0x15b)]({'where':{'gatewayPaymentId':_0x2b7523[_0x17dc0a(0x16b)],'gateway':_0x17dc0a(0x154)}}));if(!_0x5d610e)return console[_0x17dc0a(0x16a)](_0x17dc0a(0x12f)),console[_0x17dc0a(0x16a)](_0x17dc0a(0x103)+_0x2b7523[_0x17dc0a(0x16b)]),console[_0x17dc0a(0x16a)](_0x17dc0a(0x168)+_0x2b7523[_0x17dc0a(0x10c)]),console[_0x17dc0a(0x16a)](_0x17dc0a(0x146)),console['warn'](_0x17dc0a(0x11c)+_0x2b7523[_0x17dc0a(0x16b)]),_0x3344e3[_0x17dc0a(0x152)](0x194)[_0x17dc0a(0x170)]({'success':![],'message':_0x17dc0a(0x10f)});console['log'](_0x17dc0a(0x136)+_0x5d610e['id']),console[_0x17dc0a(0x173)](_0x17dc0a(0x14c)+_0x5d610e[_0x17dc0a(0x152)]),console[_0x17dc0a(0x173)](_0x17dc0a(0x15e)+_0x5d610e['gatewayPaymentId']),console[_0x17dc0a(0x173)](_0x17dc0a(0x127)+_0x2b7523['status']),console[_0x17dc0a(0x173)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x2b7523['uid']);let _0x3bab4a=null;const _0x85cc0c={};switch(_0x2b7523[_0x17dc0a(0x152)]){case _0x17dc0a(0x157):_0x3bab4a=_0x17dc0a(0x10b),console[_0x17dc0a(0x173)](_0x17dc0a(0x15c));break;case _0x17dc0a(0x134):_0x3bab4a='FAILED',_0x85cc0c['failureMessage']=_0x2b7523[_0x17dc0a(0x150)]||_0x2b7523[_0x17dc0a(0x161)]||_0x17dc0a(0x167),console[_0x17dc0a(0x173)](_0x17dc0a(0x13e)+_0x85cc0c[_0x17dc0a(0x133)]);break;case _0x17dc0a(0x165):console[_0x17dc0a(0x173)](_0x17dc0a(0x100));break;default:console[_0x17dc0a(0x16a)](_0x17dc0a(0x149)+_0x2b7523[_0x17dc0a(0x152)]);break;}if(_0x3bab4a&&_0x3bab4a!==_0x5d610e[_0x17dc0a(0x152)])console[_0x17dc0a(0x173)](_0x17dc0a(0x12e)+_0x5d610e[_0x17dc0a(0x152)]+_0x17dc0a(0x14a)+_0x3bab4a),await this[_0x17dc0a(0x141)][_0x17dc0a(0x16e)](_0x5d610e['id'],_0x3bab4a,_0x85cc0c),console[_0x17dc0a(0x173)]('‚úÖ\x20Payment\x20'+_0x5d610e['id']+'\x20updated:\x20status='+_0x3bab4a+_0x17dc0a(0xfa));else _0x3bab4a&&console[_0x17dc0a(0x173)](_0x17dc0a(0x131)+_0x5d610e['id']+_0x17dc0a(0x160)+_0x3bab4a+_0x17dc0a(0x156));_0x3344e3[_0x17dc0a(0x152)](0xc8)[_0x17dc0a(0x170)]({'success':!![],'message':_0x17dc0a(0x15d)});}catch(_0x32cb06){console[_0x17dc0a(0x120)](_0x17dc0a(0x107),_0x32cb06),_0x2b375a(_0x32cb06);}},this[_0x356a54(0x12b)]=async(_0x419122,_0x2c9a44,_0x249482)=>{const _0x37e810=_0x356a54;try{const {limit:_0x426c74}=_0x419122[_0x37e810(0x102)],_0x4949d1=this['squirrelPayService']['getWebhookLogs'](_0x426c74?parseInt(_0x426c74):0x32);_0x2c9a44['json']({'success':!![],'result':{'logs':_0x4949d1,'count':_0x4949d1['length']}});}catch(_0xc19c4c){_0x249482(_0xc19c4c);}},this[_0x356a54(0x122)]=new squirrelPayService_1[(_0x356a54(0x151))]({'shopId':process[_0x356a54(0x14e)][_0x356a54(0x11b)]||'','secretKey':process[_0x356a54(0x14e)][_0x356a54(0x129)]||'','baseUrl':process['env'][_0x356a54(0x145)]||_0x356a54(0x115),'isTestMode':process[_0x356a54(0x14e)][_0x356a54(0x111)]==='true'}),this['currencyService']=new currencyService_1['CurrencyService'](),this[_0x356a54(0x141)]=new webhookService_1[(_0x356a54(0x139))]();}}function a16_0x69d4(){const _0x4fc48a=['üîç\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','../services/currencyService','14SwAcft','WebhookService','https://app.trapay.uk','redirect_url','üîÑ\x203D\x20Secure\x20redirect\x20required:\x20','toISOString','‚ùå\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','amountUSDT','\x20USDT','webhookService','default','SquirrelPayController','amountAfterGatewayCommissionUSDT','SQUIRREL_PAY_BASE_URL','\x20\x20\x20Gateway:\x20squirrelpay','1790688cCmJIN','update','‚ö†Ô∏è\x20Unknown\x20SquirrelPay\x20status:\x20','\x20to\x20','not\x20provided','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','../services/gateways/squirrelPayService','env','slice','friendly_message','SquirrelPayService','status','574284aaWyZS','squirrelpay','PENDING',',\x20skipping\x20update','successful','Missing\x20required\x20card\x20or\x20customer\x20information','handleWebhook','toString','findFirst','‚úÖ\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','Webhook\x20processed\x20successfully','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','\x20\x20\x20Customer:\x20','\x20already\x20has\x20status\x20','message','\x20commission:\x20','__esModule','amount','incomplete','toFixed','Payment\x20failed','\x20\x20\x20Description:\x20','params','warn','uid','FRONTEND_URL','Body:','updatePaymentStatus','payment','json','Missing\x20required\x20fields\x20in\x20webhook','\x20\x20\x20Billing\x20Country:\x20','log','Payment\x20processed\x20successfully',',\x20balance\x20updated,\x20amountUSDT\x20calculated','üêøÔ∏è\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','274500lyaOVr','findUnique','FAILED','redirectUrl','‚è≥\x20Payment\x20remains\x20PENDING\x20(incomplete)','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','query','\x20\x20\x20UID:\x20','processCardPayment','/api/webhooks/squirrel-pay','2369640aHUNpp','‚ùå\x20SquirrelPay\x20webhook\x20error:','shopId','../config/database','currencyService','PAID','description','../services/webhookService','API_BASE_URL','Payment\x20not\x20found','962096fzCRhJ','SQUIRREL_PAY_TEST_MODE','headers','\x20\x20\x20Amount:\x20','üìù\x20SquirrelPay\x20payment\x20details:','https://gate.squirrel-pay.com','gateway','gatewayOrderId','currency','\x20\x20\x20Payment\x20ID:\x20','3140715fFCsZD','SQUIRREL_PAY_SHOP_ID','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','‚úÖ\x20SquirrelPay\x20payment\x20updated:\x20','Headers:','üêøÔ∏è\x20SquirrelPay\x20webhook\x20received','error','cardLast4','squirrelPayService','padStart','9631056qAeswc','round','body','\x20\x20\x20Webhook\x20status:\x20','‚ùå\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','SQUIRREL_PAY_SECRET_KEY','Payment\x20is\x20being\x20processed','getWebhookLogs','toUpperCase','has','üîÑ\x20Updating\x20payment\x20status\x20from\x20','‚ö†Ô∏è\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','requires_action','‚ÑπÔ∏è\x20Payment\x20','convertToUSDT','failureMessage','failed','getGatewayCommission'];a16_0x69d4=function(){return _0x4fc48a;};return a16_0x69d4();}exports[a16_0x3d43ae(0x143)]=SquirrelPayController;