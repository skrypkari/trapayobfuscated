'use strict';const a16_0x3d4b86=a16_0x422e;(function(_0x3c89c1,_0x876828){const _0x91eb4c=a16_0x422e,_0x33721a=_0x3c89c1();while(!![]){try{const _0x1eea0c=-parseInt(_0x91eb4c(0x19a))/0x1*(-parseInt(_0x91eb4c(0x1de))/0x2)+-parseInt(_0x91eb4c(0x1b9))/0x3*(-parseInt(_0x91eb4c(0x1ad))/0x4)+parseInt(_0x91eb4c(0x1b6))/0x5*(parseInt(_0x91eb4c(0x17d))/0x6)+-parseInt(_0x91eb4c(0x1d5))/0x7*(parseInt(_0x91eb4c(0x185))/0x8)+-parseInt(_0x91eb4c(0x183))/0x9*(-parseInt(_0x91eb4c(0x165))/0xa)+parseInt(_0x91eb4c(0x16b))/0xb*(parseInt(_0x91eb4c(0x16f))/0xc)+-parseInt(_0x91eb4c(0x19b))/0xd;if(_0x1eea0c===_0x876828)break;else _0x33721a['push'](_0x33721a['shift']());}catch(_0x386a24){_0x33721a['push'](_0x33721a['shift']());}}}(a16_0x4cde,0xbf40c));var __importDefault=this&&this['__importDefault']||function(_0x44bd2b){return _0x44bd2b&&_0x44bd2b['__esModule']?_0x44bd2b:{'default':_0x44bd2b};};Object['defineProperty'](exports,a16_0x3d4b86(0x199),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a16_0x3d4b86(0x19c)),currencyService_1=require(a16_0x3d4b86(0x1dd)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a16_0x3d4b86(0x17e))),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a16_0x4cde(){const _0x3a0796=['cardLast4','params','default','description','amount','has','error','âœ…\x20Payment\x20','SQUIRREL_PAY_TEST_MODE','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','updatePaymentStatus','Payment\x20is\x20being\x20processed','7zcbRKU','processCardPayment','payment','birth_date','\x20\x20\x20Payment\x20ID:\x20','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','headers','&payment_id=','../services/currencyService','4804sIEhiv','ðŸ’°\x20Calculated\x20amountUSDT:\x20','SQUIRREL_PAY_SECRET_KEY','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','SQUIRREL_PAY_SHOP_ID','findUnique','https://gate.squirrel-pay.com','getGatewayCommission','shopId','3590NuWQqV','\x20updated:\x20status=','redirectUrl','update','FAILED','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','352FYnaNy','currencyService','\x20\x20\x20Webhook\x20status:\x20','https://api.trapay.uk','382092XHpjVa','gatewayPaymentId','Payment\x20failed','\x20USDT','\x20to\x20','SQUIRREL_PAY_BASE_URL','\x20\x20\x20Webhook\x20UID:\x20','Payment\x20is\x20not\x20in\x20pending\x20status',',\x20balance\x20updated,\x20amountUSDT\x20calculated','PENDING','failed','amountAfterGatewayCommissionUSDT','squirrelpay','WebhookService','6ojldgB','../config/database','Payment\x20processed\x20successfully','CurrencyService','ðŸ“\x20SquirrelPay\x20payment\x20details:','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','4284TIOPnb','warn','11690616kPjoJw','env','convertToUSDT','slice','\x20\x20\x20Amount:\x20','incomplete','friendly_message','Missing\x20required\x20card\x20or\x20customer\x20information','webhookService','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','Payment\x20not\x20found','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','json','length','SquirrelPayService','true','https://app.trapay.uk','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','__esModule','114GYpqDw','12353614PatZma','../services/gateways/squirrelPayService','getWebhookLogs','getClientIP','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','gateway','gatewayOrderId','\x20already\x20has\x20status\x20','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','\x20commission:\x20','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','API_BASE_URL','log',',\x20skipping\x20update','not\x20provided','\x20\x20\x20UID:\x20','squirrelPayService','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','8XPPMnr','failureMessage','toUpperCase','\x20\x20\x20Description:\x20','toISOString','paidAt','â„¹ï¸\x20Payment\x20','SquirrelPayController','amountUSDT','6157945UVMPqr','PAID','toString','749646awBZOC','requires_action','currency','uid','logWebhook','Headers:','body','/payment/pending?id=','padStart','\x20\x20\x20Customer:\x20','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','message','ðŸ’°\x20Gateway\x20','gatewayCommissionRate','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','status'];a16_0x4cde=function(){return _0x3a0796;};return a16_0x4cde();}function a16_0x422e(_0x3e93ea,_0x20e5ad){_0x3e93ea=_0x3e93ea-0x163;const _0x4cde8e=a16_0x4cde();let _0x422e70=_0x4cde8e[_0x3e93ea];return _0x422e70;}function isValidCountryCode(_0x5a9515){const _0x9cda9f=a16_0x3d4b86;return ISO_COUNTRY_CODES[_0x9cda9f(0x1ce)](_0x5a9515[_0x9cda9f(0x1af)]());}class SquirrelPayController{constructor(){const _0x38ae42=a16_0x3d4b86;this['processCardPayment']=async(_0x37ba87,_0x408e48,_0x1ea538)=>{const _0x57a83a=a16_0x422e;try{const {paymentId:_0x1c15e1}=_0x37ba87[_0x57a83a(0x1ca)],{card_number:_0x8c25f1,exp_month:_0x44f8a4,exp_year:_0x572513,cvv:_0x42a701,holder_name:_0x444f75,customer_email:_0x5e8980,customer_birth_date:_0x2cf531,billing_country:_0x364983,customer_phone:_0x14177c,billing_address:_0x535b0c,billing_city:_0x4c0764,billing_state:_0x4a17f4,billing_zip:_0x8b196f}=_0x37ba87[_0x57a83a(0x1bf)];console[_0x57a83a(0x1a7)]('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x1c15e1);if(!_0x8c25f1||!_0x44f8a4||!_0x572513||!_0x42a701||!_0x444f75||!_0x5e8980)return _0x408e48[_0x57a83a(0x1c8)](0x190)[_0x57a83a(0x192)]({'success':![],'message':_0x57a83a(0x18c)});if(_0x364983&&!isValidCountryCode(_0x364983))return _0x408e48[_0x57a83a(0x1c8)](0x190)['json']({'success':![],'message':_0x57a83a(0x190)});const _0x53b08a=await database_1[_0x57a83a(0x1cb)][_0x57a83a(0x1d7)][_0x57a83a(0x1e3)]({'where':{'id':_0x1c15e1},'include':{'shop':!![]}});if(!_0x53b08a)return _0x408e48[_0x57a83a(0x1c8)](0x194)[_0x57a83a(0x192)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x53b08a[_0x57a83a(0x1c8)]!==_0x57a83a(0x178))return _0x408e48[_0x57a83a(0x1c8)](0x190)['json']({'success':![],'message':_0x57a83a(0x176)});const _0x5acdce=(0x0,ipHelper_1[_0x57a83a(0x19e)])(_0x37ba87),_0x24abe0={'number':_0x8c25f1['replace'](/\s/g,''),'exp_month':_0x44f8a4[_0x57a83a(0x1b8)]()[_0x57a83a(0x1c1)](0x2,'0'),'exp_year':_0x572513[_0x57a83a(0x1b8)](),'verification_value':_0x42a701,'holder':_0x444f75[_0x57a83a(0x1af)]()},_0x4e661d={'ip':_0x5acdce,'email':_0x5e8980};_0x2cf531&&(_0x4e661d[_0x57a83a(0x1d8)]=_0x2cf531);let _0x183f4d;_0x364983&&(_0x183f4d={'country':_0x364983,'address':_0x535b0c,'city':_0x4c0764,'state':_0x4a17f4,'zip':_0x8b196f});const _0x3b09b3=(process['env']['FRONTEND_URL']||_0x57a83a(0x196))+_0x57a83a(0x1c0)+_0x1c15e1+_0x57a83a(0x1dc)+(_0x53b08a[_0x57a83a(0x1a1)]||_0x1c15e1),_0x434576=(process[_0x57a83a(0x186)][_0x57a83a(0x1a6)]||_0x57a83a(0x16e))+'/api/webhooks/squirrel-pay',_0x824e4e=_0x1c15e1[_0x57a83a(0x188)](0x0,0x8)+'-'+_0x1c15e1[_0x57a83a(0x188)](0x8,0x10);console['log'](_0x57a83a(0x181)),console[_0x57a83a(0x1a7)](_0x57a83a(0x1d9)+_0x1c15e1),console[_0x57a83a(0x1a7)](_0x57a83a(0x189)+_0x53b08a[_0x57a83a(0x1cd)]+'\x20'+_0x53b08a[_0x57a83a(0x1bb)]),console['log'](_0x57a83a(0x1c2)+_0x5e8980+'\x20('+_0x5acdce+')'),console[_0x57a83a(0x1a7)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x364983||_0x57a83a(0x1a9))),console[_0x57a83a(0x1a7)](_0x57a83a(0x1b0)+_0x824e4e);const _0xe060b=await this[_0x57a83a(0x1ab)][_0x57a83a(0x1d6)](Math['round'](_0x53b08a['amount']*0x64),_0x53b08a[_0x57a83a(0x1bb)],_0x824e4e,_0x3b09b3,_0x434576,_0x24abe0,_0x4e661d,_0x183f4d,_0x14177c),_0x183f35=this[_0x57a83a(0x1ab)]['getPaymentStatus'](_0xe060b),_0xdc6086={'gatewayPaymentId':_0xe060b[_0x57a83a(0x1bc)],'cardLast4':_0x183f35[_0x57a83a(0x1c9)],'gateway':_0x57a83a(0x17b),'customerEmail':_0x5e8980,'customerPhone':_0x14177c,'customerBirthDate':_0x2cf531,'billingAddress':_0x535b0c,'billingCity':_0x4c0764,'billingState':_0x4a17f4,'billingZip':_0x8b196f,'customerCountry':_0x364983};if(_0x183f35['status']===_0x57a83a(0x1b7)){_0xdc6086['status']='PAID',_0xdc6086[_0x57a83a(0x1b2)]=new Date();try{const _0x3aab09=await this[_0x57a83a(0x16c)][_0x57a83a(0x187)](_0x53b08a[_0x57a83a(0x1cd)],_0x53b08a[_0x57a83a(0x1bb)]);_0xdc6086[_0x57a83a(0x1b5)]=_0x3aab09,console[_0x57a83a(0x1a7)](_0x57a83a(0x1df)+_0x3aab09+_0x57a83a(0x172));const _0xa238fb=await this[_0x57a83a(0x18d)][_0x57a83a(0x163)](_0x53b08a[_0x57a83a(0x164)],_0x53b08a[_0x57a83a(0x1a0)]),_0x449516=_0x3aab09*(0x1-_0xa238fb/0x64);_0xdc6086[_0x57a83a(0x17a)]=_0x449516,_0xdc6086[_0x57a83a(0x1c6)]=_0xa238fb,console['log'](_0x57a83a(0x1c5)+_0x53b08a[_0x57a83a(0x1a0)]+_0x57a83a(0x1a4)+_0xa238fb+'%'),console[_0x57a83a(0x1a7)](_0x57a83a(0x198)+_0x449516['toFixed'](0x6)+_0x57a83a(0x172));}catch(_0x7e476d){console['error'](_0x57a83a(0x1c3),_0x7e476d),_0xdc6086[_0x57a83a(0x1b5)]=0x0,_0xdc6086[_0x57a83a(0x17a)]=0x0,_0xdc6086[_0x57a83a(0x1c6)]=0x0;}}else _0x183f35[_0x57a83a(0x1c8)]===_0x57a83a(0x169)&&(_0xdc6086[_0x57a83a(0x1c8)]='FAILED',_0xdc6086[_0x57a83a(0x1ae)]=_0x183f35['failureMessage']);const _0x18fa31=await database_1[_0x57a83a(0x1cb)][_0x57a83a(0x1d7)][_0x57a83a(0x168)]({'where':{'id':_0x1c15e1},'data':_0xdc6086});console[_0x57a83a(0x1a7)](_0x57a83a(0x1a3)+_0x18fa31[_0x57a83a(0x1c8)]);let _0x6630b4;if(_0x183f35[_0x57a83a(0x1c8)]===_0x57a83a(0x169))_0x6630b4=_0x183f35[_0x57a83a(0x1ae)]||_0xe060b[_0x57a83a(0x18b)]||'Payment\x20failed';else _0x183f35[_0x57a83a(0x1c8)]===_0x57a83a(0x178)?_0x6630b4=_0xe060b['friendly_message']||_0x57a83a(0x1d4):_0x6630b4=_0xe060b[_0x57a83a(0x18b)]||_0x57a83a(0x17f);const _0x7aa201={'success':_0x183f35[_0x57a83a(0x1c8)]!==_0x57a83a(0x169),'status':_0x183f35['status'],'message':_0x6630b4,'payment':{'id':_0x1c15e1,'status':_0x18fa31[_0x57a83a(0x1c8)],'gateway':_0x57a83a(0x17b),'last4':_0x183f35['cardLast4']}};_0x183f35[_0x57a83a(0x167)]&&(_0x7aa201['redirect_url']=_0x183f35[_0x57a83a(0x167)],_0x7aa201[_0x57a83a(0x1ba)]=!![],console['log'](_0x57a83a(0x1d2)+_0x183f35[_0x57a83a(0x167)])),_0x408e48[_0x57a83a(0x192)](_0x7aa201);}catch(_0x34fba9){console['error'](_0x57a83a(0x1e1),_0x34fba9),_0x1ea538(_0x34fba9);}},this['handleWebhook']=async(_0x270748,_0x4d5e7e,_0x397389)=>{const _0x134f8d=a16_0x422e;try{console[_0x134f8d(0x1a7)]('ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'),console[_0x134f8d(0x1a7)](_0x134f8d(0x1be),_0x270748[_0x134f8d(0x1db)]),console[_0x134f8d(0x1a7)]('Body:',_0x270748['body']),this['squirrelPayService'][_0x134f8d(0x1bd)]({'headers':_0x270748[_0x134f8d(0x1db)],'body':_0x270748[_0x134f8d(0x1bf)],'timestamp':new Date()[_0x134f8d(0x1b1)]()});const _0x179079=_0x270748[_0x134f8d(0x1bf)];if(!_0x179079[_0x134f8d(0x1bc)]||!_0x179079[_0x134f8d(0x1c8)])return console[_0x134f8d(0x184)](_0x134f8d(0x18e)),_0x4d5e7e[_0x134f8d(0x1c8)](0x190)[_0x134f8d(0x192)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x2ae625;_0x179079[_0x134f8d(0x1bc)]&&(_0x2ae625=await database_1['default'][_0x134f8d(0x1d7)]['findFirst']({'where':{'gatewayPaymentId':_0x179079[_0x134f8d(0x1bc)],'gateway':'squirrelpay'}}));if(!_0x2ae625)return console['warn'](_0x134f8d(0x191)),console[_0x134f8d(0x184)](_0x134f8d(0x1aa)+_0x179079['uid']),console[_0x134f8d(0x184)](_0x134f8d(0x1b0)+_0x179079[_0x134f8d(0x1cc)]),console['warn']('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x134f8d(0x184)](_0x134f8d(0x16a)+_0x179079[_0x134f8d(0x1bc)]),_0x4d5e7e[_0x134f8d(0x1c8)](0x194)[_0x134f8d(0x192)]({'success':![],'message':_0x134f8d(0x18f)});console['log'](_0x134f8d(0x197)+_0x2ae625['id']),console[_0x134f8d(0x1a7)](_0x134f8d(0x1a5)+_0x2ae625[_0x134f8d(0x1c8)]),console[_0x134f8d(0x1a7)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x2ae625[_0x134f8d(0x170)]),console[_0x134f8d(0x1a7)](_0x134f8d(0x16d)+_0x179079[_0x134f8d(0x1c8)]),console[_0x134f8d(0x1a7)](_0x134f8d(0x175)+_0x179079['uid']);let _0x2a0ddd=null;const _0x58cc36={};switch(_0x179079[_0x134f8d(0x1c8)]){case'successful':_0x2a0ddd=_0x134f8d(0x1b7),console[_0x134f8d(0x1a7)](_0x134f8d(0x19f));break;case _0x134f8d(0x179):_0x2a0ddd='FAILED',_0x58cc36['failureMessage']=_0x179079[_0x134f8d(0x18b)]||_0x179079[_0x134f8d(0x1c4)]||_0x134f8d(0x171),console[_0x134f8d(0x1a7)](_0x134f8d(0x1da)+_0x58cc36[_0x134f8d(0x1ae)]);break;case _0x134f8d(0x18a):console[_0x134f8d(0x1a7)](_0x134f8d(0x182));break;default:console['warn'](_0x134f8d(0x1ac)+_0x179079[_0x134f8d(0x1c8)]);break;}if(_0x2a0ddd&&_0x2a0ddd!==_0x2ae625[_0x134f8d(0x1c8)])console[_0x134f8d(0x1a7)](_0x134f8d(0x1c7)+_0x2ae625[_0x134f8d(0x1c8)]+_0x134f8d(0x173)+_0x2a0ddd),await this[_0x134f8d(0x18d)][_0x134f8d(0x1d3)](_0x2ae625['id'],_0x2a0ddd,_0x58cc36),console[_0x134f8d(0x1a7)](_0x134f8d(0x1d0)+_0x2ae625['id']+_0x134f8d(0x166)+_0x2a0ddd+_0x134f8d(0x177));else _0x2a0ddd&&console[_0x134f8d(0x1a7)](_0x134f8d(0x1b3)+_0x2ae625['id']+_0x134f8d(0x1a2)+_0x2a0ddd+_0x134f8d(0x1a8));_0x4d5e7e['status'](0xc8)[_0x134f8d(0x192)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x268bb4){console[_0x134f8d(0x1cf)]('âŒ\x20SquirrelPay\x20webhook\x20error:',_0x268bb4),_0x397389(_0x268bb4);}},this['getWebhookLogs']=async(_0x42f75f,_0x29dfd7,_0x167cd8)=>{const _0x5114d0=a16_0x422e;try{const {limit:_0x3ebf16}=_0x42f75f['query'],_0x2ed729=this['squirrelPayService'][_0x5114d0(0x19d)](_0x3ebf16?parseInt(_0x3ebf16):0x32);_0x29dfd7['json']({'success':!![],'result':{'logs':_0x2ed729,'count':_0x2ed729[_0x5114d0(0x193)]}});}catch(_0x147243){_0x167cd8(_0x147243);}},this['squirrelPayService']=new squirrelPayService_1[(_0x38ae42(0x194))]({'shopId':process[_0x38ae42(0x186)][_0x38ae42(0x1e2)]||'','secretKey':process[_0x38ae42(0x186)][_0x38ae42(0x1e0)]||'','baseUrl':process[_0x38ae42(0x186)][_0x38ae42(0x174)]||_0x38ae42(0x1e4),'isTestMode':process['env'][_0x38ae42(0x1d1)]===_0x38ae42(0x195)}),this['currencyService']=new currencyService_1[(_0x38ae42(0x180))](),this[_0x38ae42(0x18d)]=new webhookService_1[(_0x38ae42(0x17c))]();}}exports[a16_0x3d4b86(0x1b4)]=SquirrelPayController;