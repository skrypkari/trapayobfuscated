'use strict';const a16_0x432275=a16_0x45fa;function a16_0x3e33(){const _0x1da2f2=['cardLast4','amountAfterGatewayCommissionUSDT','__importDefault','redirectUrl','\x20commission:\x20','uid','description','redirect_url','gatewayCommissionRate','FRONTEND_URL','WebhookService','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','toFixed','../services/currencyService','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','webhookService','slice','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','failureMessage','successful','round','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','âœ…\x20Payment\x20','\x20\x20\x20Webhook\x20status:\x20','defineProperty','findUnique','friendly_message','\x20USDT','findFirst','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','1683148QNkwfD','ðŸ“\x20SquirrelPay\x20payment\x20details:','\x20\x20\x20Webhook\x20UID:\x20','headers','SQUIRREL_PAY_SHOP_ID','currency','getWebhookLogs','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','Payment\x20processed\x20successfully','\x20already\x20has\x20status\x20','16130290rVNJZK','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','amount','currencyService','squirrelPayService','184nFAyIm','Headers:','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','getPaymentStatus','Body:','PENDING','shopId','body','query','birth_date','gateway','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','SQUIRREL_PAY_TEST_MODE','__esModule','https://gate.squirrel-pay.com','7230aKeogx','âŒ\x20SquirrelPay\x20webhook\x20error:','handleWebhook','\x20\x20\x20Gateway:\x20squirrelpay','Payment\x20failed','6926960daiJfx','squirrelpay','log','â„¹ï¸\x20Payment\x20','logWebhook','../services/gateways/squirrelPayService','ðŸ’°\x20Gateway\x20','json','toString','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','toUpperCase','failed','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','\x20\x20\x20Amount:\x20','1685KRKOUg','Payment\x20not\x20found','convertToUSDT','gatewayPaymentId','FAILED','warn',',\x20balance\x20updated,\x20amountUSDT\x20calculated','/api/webhooks/squirrel-pay','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','replace','\x20to\x20','/payment/pending?id=','length','\x20\x20\x20Customer:\x20','\x20\x20\x20Billing\x20Country:\x20','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','Payment\x20is\x20not\x20in\x20pending\x20status','SQUIRREL_PAY_SECRET_KEY','toISOString','PAID','default','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','getGatewayCommission','payment','8064805IhevcS','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','../utils/ipHelper','&payment_id=','SquirrelPayService','SquirrelPayController','\x20\x20\x20Payment\x20ID:\x20','message','processCardPayment','../services/webhookService','has','status','425781gBZfjr','incomplete','ðŸ’°\x20Calculated\x20amountUSDT:\x20','Missing\x20required\x20card\x20or\x20customer\x20information','374481vsvQFF','\x20\x20\x20Description:\x20','not\x20provided','gatewayOrderId','\x20updated:\x20status=','12yuMroO','env','CurrencyService','error','amountUSDT'];a16_0x3e33=function(){return _0x1da2f2;};return a16_0x3e33();}(function(_0x1675c2,_0x12d1cc){const _0x389480=a16_0x45fa,_0x5b7aee=_0x1675c2();while(!![]){try{const _0xed2074=parseInt(_0x389480(0x210))/0x1+-parseInt(_0x389480(0x1eb))/0x2*(-parseInt(_0x389480(0x1e2))/0x3)+-parseInt(_0x389480(0x233))/0x4+-parseInt(_0x389480(0x241))/0x5*(parseInt(_0x389480(0x22e))/0x6)+parseInt(_0x389480(0x259))/0x7+-parseInt(_0x389480(0x21f))/0x8*(-parseInt(_0x389480(0x1e6))/0x9)+-parseInt(_0x389480(0x21a))/0xa;if(_0xed2074===_0x12d1cc)break;else _0x5b7aee['push'](_0x5b7aee['shift']());}catch(_0x97c030){_0x5b7aee['push'](_0x5b7aee['shift']());}}}(a16_0x3e33,0xda032));var __importDefault=this&&this[a16_0x432275(0x1f2)]||function(_0x690cd9){const _0x54eb27=a16_0x432275;return _0x690cd9&&_0x690cd9[_0x54eb27(0x22c)]?_0x690cd9:{'default':_0x690cd9};};function a16_0x45fa(_0x367dda,_0x241821){_0x367dda=_0x367dda-0x1dc;const _0x3e33f0=a16_0x3e33();let _0x45fa9a=_0x3e33f0[_0x367dda];return _0x45fa9a;}Object[a16_0x432275(0x209)](exports,a16_0x432275(0x22c),{'value':!![]}),exports[a16_0x432275(0x25f)]=void 0x0;const squirrelPayService_1=require(a16_0x432275(0x238)),currencyService_1=require(a16_0x432275(0x1fd)),webhookService_1=require(a16_0x432275(0x1df)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a16_0x432275(0x25c)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x10ddaf){const _0xe76f7e=a16_0x432275;return ISO_COUNTRY_CODES[_0xe76f7e(0x1e0)](_0x10ddaf['toUpperCase']());}class SquirrelPayController{constructor(){const _0x5708ba=a16_0x432275;this[_0x5708ba(0x1de)]=async(_0x4cd4d6,_0x251f2e,_0x2ac2fb)=>{const _0x53f301=_0x5708ba;try{const {paymentId:_0x310cad}=_0x4cd4d6['params'],{card_number:_0x3a54bc,exp_month:_0x5575ef,exp_year:_0x4a089e,cvv:_0x4c7cab,holder_name:_0x2b9be8,customer_email:_0x3fddfe,customer_birth_date:_0x704857,billing_country:_0x470efc,customer_phone:_0xb244d0,billing_address:_0x513b11,billing_city:_0x4dfec3,billing_state:_0x35a708,billing_zip:_0x4519ee}=_0x4cd4d6[_0x53f301(0x226)];console[_0x53f301(0x235)](_0x53f301(0x221)+_0x310cad);if(!_0x3a54bc||!_0x5575ef||!_0x4a089e||!_0x4c7cab||!_0x2b9be8||!_0x3fddfe)return _0x251f2e[_0x53f301(0x1e1)](0x190)[_0x53f301(0x23a)]({'success':![],'message':_0x53f301(0x1e5)});if(_0x470efc&&!isValidCountryCode(_0x470efc))return _0x251f2e[_0x53f301(0x1e1)](0x190)[_0x53f301(0x23a)]({'success':![],'message':_0x53f301(0x25a)});const _0x31145b=await database_1[_0x53f301(0x255)][_0x53f301(0x258)][_0x53f301(0x20a)]({'where':{'id':_0x310cad},'include':{'shop':!![]}});if(!_0x31145b)return _0x251f2e[_0x53f301(0x1e1)](0x194)[_0x53f301(0x23a)]({'success':![],'message':_0x53f301(0x242)});if(_0x31145b[_0x53f301(0x1e1)]!==_0x53f301(0x224))return _0x251f2e['status'](0x190)[_0x53f301(0x23a)]({'success':![],'message':_0x53f301(0x251)});const _0x50e80e=(0x0,ipHelper_1['getClientIP'])(_0x4cd4d6),_0x5e4edd={'number':_0x3a54bc[_0x53f301(0x24a)](/\s/g,''),'exp_month':_0x5575ef['toString']()['padStart'](0x2,'0'),'exp_year':_0x4a089e[_0x53f301(0x23b)](),'verification_value':_0x4c7cab,'holder':_0x2b9be8[_0x53f301(0x23d)]()},_0x441368={'ip':_0x50e80e,'email':_0x3fddfe};_0x704857&&(_0x441368[_0x53f301(0x228)]=_0x704857);let _0x2b913c;_0x470efc&&(_0x2b913c={'country':_0x470efc,'address':_0x513b11,'city':_0x4dfec3,'state':_0x35a708,'zip':_0x4519ee});const _0x1cc020=(process[_0x53f301(0x1ec)][_0x53f301(0x1f9)]||'https://app.trapay.uk')+_0x53f301(0x24c)+_0x310cad+_0x53f301(0x25d)+(_0x31145b[_0x53f301(0x1e9)]||_0x310cad),_0x81f156=(process['env']['API_BASE_URL']||'https://api.trapay.uk')+_0x53f301(0x248),_0x36f169=_0x310cad[_0x53f301(0x200)](0x0,0x8)+'-'+_0x310cad['slice'](0x8,0x10);console[_0x53f301(0x235)](_0x53f301(0x211)),console[_0x53f301(0x235)](_0x53f301(0x1dc)+_0x310cad),console[_0x53f301(0x235)](_0x53f301(0x240)+_0x31145b[_0x53f301(0x21c)]+'\x20'+_0x31145b['currency']),console['log'](_0x53f301(0x24e)+_0x3fddfe+'\x20('+_0x50e80e+')'),console['log'](_0x53f301(0x24f)+(_0x470efc||_0x53f301(0x1e8))),console['log'](_0x53f301(0x1e7)+_0x36f169);const _0x3c3450=await this[_0x53f301(0x21e)][_0x53f301(0x1de)](Math[_0x53f301(0x205)](_0x31145b[_0x53f301(0x21c)]*0x64),_0x31145b[_0x53f301(0x215)],_0x36f169,_0x1cc020,_0x81f156,_0x5e4edd,_0x441368,_0x2b913c,_0xb244d0),_0x1f5d38=this[_0x53f301(0x21e)][_0x53f301(0x222)](_0x3c3450),_0x3b8176={'gatewayPaymentId':_0x3c3450[_0x53f301(0x1f5)],'cardLast4':_0x1f5d38[_0x53f301(0x1f0)],'gateway':'squirrelpay','customerEmail':_0x3fddfe,'customerPhone':_0xb244d0,'customerBirthDate':_0x704857,'billingAddress':_0x513b11,'billingCity':_0x4dfec3,'billingState':_0x35a708,'billingZip':_0x4519ee,'customerCountry':_0x470efc};if(_0x1f5d38['status']===_0x53f301(0x254)){_0x3b8176[_0x53f301(0x1e1)]=_0x53f301(0x254),_0x3b8176['paidAt']=new Date();try{const _0xbe76f6=await this[_0x53f301(0x21d)][_0x53f301(0x243)](_0x31145b[_0x53f301(0x21c)],_0x31145b[_0x53f301(0x215)]);_0x3b8176['amountUSDT']=_0xbe76f6,console[_0x53f301(0x235)](_0x53f301(0x1e4)+_0xbe76f6+_0x53f301(0x20c));const _0x2db6fd=await this['webhookService'][_0x53f301(0x257)](_0x31145b[_0x53f301(0x225)],_0x31145b[_0x53f301(0x229)]),_0x12c74e=_0xbe76f6*(0x1-_0x2db6fd/0x64);_0x3b8176[_0x53f301(0x1f1)]=_0x12c74e,_0x3b8176['gatewayCommissionRate']=_0x2db6fd,console[_0x53f301(0x235)](_0x53f301(0x239)+_0x31145b[_0x53f301(0x229)]+_0x53f301(0x1f4)+_0x2db6fd+'%'),console[_0x53f301(0x235)](_0x53f301(0x22a)+_0x12c74e[_0x53f301(0x1fc)](0x6)+'\x20USDT');}catch(_0x194c0f){console['error'](_0x53f301(0x20f),_0x194c0f),_0x3b8176[_0x53f301(0x1ef)]=0x0,_0x3b8176['amountAfterGatewayCommissionUSDT']=0x0,_0x3b8176[_0x53f301(0x1f8)]=0x0;}}else _0x1f5d38[_0x53f301(0x1e1)]===_0x53f301(0x245)&&(_0x3b8176['status']=_0x53f301(0x245),_0x3b8176[_0x53f301(0x203)]=_0x1f5d38[_0x53f301(0x203)]);const _0x33030f=await database_1[_0x53f301(0x255)]['payment']['update']({'where':{'id':_0x310cad},'data':_0x3b8176});console[_0x53f301(0x235)](_0x53f301(0x23f)+_0x33030f['status']);let _0x4dbe89;if(_0x1f5d38['status']===_0x53f301(0x245))_0x4dbe89=_0x1f5d38['failureMessage']||_0x3c3450['friendly_message']||_0x53f301(0x232);else _0x1f5d38[_0x53f301(0x1e1)]===_0x53f301(0x224)?_0x4dbe89=_0x3c3450['friendly_message']||'Payment\x20is\x20being\x20processed':_0x4dbe89=_0x3c3450['friendly_message']||_0x53f301(0x218);const _0x36e44c={'success':_0x1f5d38[_0x53f301(0x1e1)]!==_0x53f301(0x245),'status':_0x1f5d38['status'],'message':_0x4dbe89,'payment':{'id':_0x310cad,'status':_0x33030f['status'],'gateway':_0x53f301(0x234),'last4':_0x1f5d38[_0x53f301(0x1f0)]}};_0x1f5d38[_0x53f301(0x1f3)]&&(_0x36e44c[_0x53f301(0x1f7)]=_0x1f5d38[_0x53f301(0x1f3)],_0x36e44c['requires_action']=!![],console[_0x53f301(0x235)](_0x53f301(0x256)+_0x1f5d38[_0x53f301(0x1f3)])),_0x251f2e[_0x53f301(0x23a)](_0x36e44c);}catch(_0x59b58b){console[_0x53f301(0x1ee)](_0x53f301(0x21b),_0x59b58b),_0x2ac2fb(_0x59b58b);}},this[_0x5708ba(0x230)]=async(_0xa6ed2a,_0x5d0b20,_0x673a29)=>{const _0x40c056=_0x5708ba;try{console[_0x40c056(0x235)](_0x40c056(0x20e)),console[_0x40c056(0x235)](_0x40c056(0x220),_0xa6ed2a[_0x40c056(0x213)]),console[_0x40c056(0x235)](_0x40c056(0x223),_0xa6ed2a[_0x40c056(0x226)]),this[_0x40c056(0x21e)][_0x40c056(0x237)]({'headers':_0xa6ed2a[_0x40c056(0x213)],'body':_0xa6ed2a[_0x40c056(0x226)],'timestamp':new Date()[_0x40c056(0x253)]()});const _0x4a6acf=_0xa6ed2a[_0x40c056(0x226)];if(!_0x4a6acf['uid']||!_0x4a6acf['status'])return console[_0x40c056(0x246)](_0x40c056(0x202)),_0x5d0b20[_0x40c056(0x1e1)](0x190)['json']({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x11e486;_0x4a6acf[_0x40c056(0x1f5)]&&(_0x11e486=await database_1[_0x40c056(0x255)][_0x40c056(0x258)][_0x40c056(0x20d)]({'where':{'gatewayPaymentId':_0x4a6acf['uid'],'gateway':_0x40c056(0x234)}}));if(!_0x11e486)return console['warn'](_0x40c056(0x217)),console['warn']('\x20\x20\x20UID:\x20'+_0x4a6acf[_0x40c056(0x1f5)]),console[_0x40c056(0x246)](_0x40c056(0x1e7)+_0x4a6acf[_0x40c056(0x1f6)]),console['warn'](_0x40c056(0x231)),console[_0x40c056(0x246)](_0x40c056(0x23c)+_0x4a6acf[_0x40c056(0x1f5)]),_0x5d0b20[_0x40c056(0x1e1)](0x194)[_0x40c056(0x23a)]({'success':![],'message':_0x40c056(0x242)});console[_0x40c056(0x235)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x11e486['id']),console[_0x40c056(0x235)](_0x40c056(0x249)+_0x11e486[_0x40c056(0x1e1)]),console[_0x40c056(0x235)](_0x40c056(0x1fb)+_0x11e486[_0x40c056(0x244)]),console[_0x40c056(0x235)](_0x40c056(0x208)+_0x4a6acf[_0x40c056(0x1e1)]),console[_0x40c056(0x235)](_0x40c056(0x212)+_0x4a6acf['uid']);let _0x3126f0=null;const _0x5c63ac={};switch(_0x4a6acf['status']){case _0x40c056(0x204):_0x3126f0=_0x40c056(0x254),console[_0x40c056(0x235)](_0x40c056(0x201));break;case _0x40c056(0x23e):_0x3126f0=_0x40c056(0x245),_0x5c63ac[_0x40c056(0x203)]=_0x4a6acf[_0x40c056(0x20b)]||_0x4a6acf[_0x40c056(0x1dd)]||_0x40c056(0x232),console[_0x40c056(0x235)](_0x40c056(0x1fe)+_0x5c63ac[_0x40c056(0x203)]);break;case _0x40c056(0x1e3):console[_0x40c056(0x235)](_0x40c056(0x206));break;default:console[_0x40c056(0x246)](_0x40c056(0x250)+_0x4a6acf['status']);break;}if(_0x3126f0&&_0x3126f0!==_0x11e486[_0x40c056(0x1e1)])console['log'](_0x40c056(0x25b)+_0x11e486['status']+_0x40c056(0x24b)+_0x3126f0),await this[_0x40c056(0x1ff)]['updatePaymentStatus'](_0x11e486['id'],_0x3126f0,_0x5c63ac),console['log'](_0x40c056(0x207)+_0x11e486['id']+_0x40c056(0x1ea)+_0x3126f0+_0x40c056(0x247));else _0x3126f0&&console[_0x40c056(0x235)](_0x40c056(0x236)+_0x11e486['id']+_0x40c056(0x219)+_0x3126f0+',\x20skipping\x20update');_0x5d0b20[_0x40c056(0x1e1)](0xc8)[_0x40c056(0x23a)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x2a5f0f){console['error'](_0x40c056(0x22f),_0x2a5f0f),_0x673a29(_0x2a5f0f);}},this[_0x5708ba(0x216)]=async(_0x1bad8a,_0x2cb3e2,_0x3cf55c)=>{const _0xff740=_0x5708ba;try{const {limit:_0x7c302c}=_0x1bad8a[_0xff740(0x227)],_0x5e8f89=this['squirrelPayService'][_0xff740(0x216)](_0x7c302c?parseInt(_0x7c302c):0x32);_0x2cb3e2[_0xff740(0x23a)]({'success':!![],'result':{'logs':_0x5e8f89,'count':_0x5e8f89[_0xff740(0x24d)]}});}catch(_0x16a34e){_0x3cf55c(_0x16a34e);}},this[_0x5708ba(0x21e)]=new squirrelPayService_1[(_0x5708ba(0x25e))]({'shopId':process[_0x5708ba(0x1ec)][_0x5708ba(0x214)]||'','secretKey':process['env'][_0x5708ba(0x252)]||'','baseUrl':process[_0x5708ba(0x1ec)]['SQUIRREL_PAY_BASE_URL']||_0x5708ba(0x22d),'isTestMode':process[_0x5708ba(0x1ec)][_0x5708ba(0x22b)]==='true'}),this[_0x5708ba(0x21d)]=new currencyService_1[(_0x5708ba(0x1ed))](),this[_0x5708ba(0x1ff)]=new webhookService_1[(_0x5708ba(0x1fa))]();}}exports[a16_0x432275(0x25f)]=SquirrelPayController;