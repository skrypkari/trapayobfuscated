'use strict';const a16_0xf160c6=a16_0x14f5;(function(_0x129c39,_0x3c8434){const _0x2ff38a=a16_0x14f5,_0x3b0d73=_0x129c39();while(!![]){try{const _0x28841a=parseInt(_0x2ff38a(0x1ad))/0x1+parseInt(_0x2ff38a(0x16a))/0x2*(parseInt(_0x2ff38a(0x17d))/0x3)+parseInt(_0x2ff38a(0x1aa))/0x4+-parseInt(_0x2ff38a(0x148))/0x5*(parseInt(_0x2ff38a(0x174))/0x6)+-parseInt(_0x2ff38a(0x170))/0x7*(-parseInt(_0x2ff38a(0x180))/0x8)+parseInt(_0x2ff38a(0x160))/0x9*(-parseInt(_0x2ff38a(0x187))/0xa)+-parseInt(_0x2ff38a(0x16c))/0xb;if(_0x28841a===_0x3c8434)break;else _0x3b0d73['push'](_0x3b0d73['shift']());}catch(_0x3c656a){_0x3b0d73['push'](_0x3b0d73['shift']());}}}(a16_0x188b,0xa36bc));var __importDefault=this&&this[a16_0xf160c6(0x1a6)]||function(_0x3661d4){return _0x3661d4&&_0x3661d4['__esModule']?_0x3661d4:{'default':_0x3661d4};};Object[a16_0xf160c6(0x1a1)](exports,a16_0xf160c6(0x18e),{'value':!![]}),exports[a16_0xf160c6(0x1ae)]=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a16_0xf160c6(0x145)),webhookService_1=require(a16_0xf160c6(0x16e)),database_1=__importDefault(require('../config/database')),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a16_0x14f5(_0x2a251a,_0x4162ad){_0x2a251a=_0x2a251a-0x143;const _0x188bf5=a16_0x188b();let _0x14f5b2=_0x188bf5[_0x2a251a];return _0x14f5b2;}function isValidCountryCode(_0x544b58){const _0x4a924a=a16_0xf160c6;return ISO_COUNTRY_CODES['has'](_0x544b58[_0x4a924a(0x196)]());}function a16_0x188b(){const _0x21d7c6=['https://api.trapay.uk','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','squirrelPayService','&payment_id=','length','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','true','âœ…\x20Payment\x20','Body:','amountAfterGatewayCommissionUSDT','\x20to\x20','gatewayPaymentId','SquirrelPayService','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','\x20\x20\x20Billing\x20Country:\x20',',\x20balance\x20updated,\x20amountUSDT\x20calculated','SQUIRREL_PAY_TEST_MODE','API_BASE_URL','toFixed','cardLast4','508941gLjPfY','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','âŒ\x20SquirrelPay\x20webhook\x20error:','status','handleWebhook','webhookService','Payment\x20failed','Payment\x20not\x20found','\x20already\x20has\x20status\x20','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','16534aVEMyD','ðŸ’°\x20Calculated\x20amountUSDT:\x20','5524662tpOzHu','description','../services/webhookService','FAILED','36106MJhdYe','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','\x20USDT','54654MqcOVd','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','Headers:','successful','currency','redirectUrl','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','body','warn','105QLAiFl','\x20\x20\x20Customer:\x20','\x20\x20\x20Description:\x20','8ftKvCc','/api/webhooks/squirrel-pay','uid','PAID','paidAt','slice','incomplete','90BkyEgp','squirrelpay','update','Payment\x20is\x20being\x20processed','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','convertToUSDT','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','__esModule','error','SQUIRREL_PAY_SHOP_ID','Payment\x20is\x20not\x20in\x20pending\x20status','FRONTEND_URL','shopId','headers','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','toUpperCase','amount','toISOString','gateway','query','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','log','getWebhookLogs','\x20\x20\x20UID:\x20','failureMessage','CurrencyService','defineProperty','Webhook\x20processed\x20successfully','Missing\x20required\x20fields\x20in\x20webhook','gatewayCommissionRate','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','__importDefault','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','friendly_message','failed','5228872sbRDXo','ðŸ’°\x20Gateway\x20','\x20\x20\x20Amount:\x20','424976HFeAdp','SquirrelPayController','params','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','amountUSDT','not\x20provided','gatewayOrderId','env','processCardPayment','json','message','https://app.trapay.uk','https://gate.squirrel-pay.com','../services/currencyService','getClientIP','toString','190QAYGwl','PENDING','\x20\x20\x20Webhook\x20status:\x20','payment'];a16_0x188b=function(){return _0x21d7c6;};return a16_0x188b();}class SquirrelPayController{constructor(){const _0x3bf322=a16_0xf160c6;this[_0x3bf322(0x1b5)]=async(_0x1af584,_0x5dccaf,_0x264faa)=>{const _0x51b2bb=_0x3bf322;try{const {paymentId:_0x2e1f92}=_0x1af584[_0x51b2bb(0x1af)],{card_number:_0x4cf40e,exp_month:_0x4a0d4b,exp_year:_0x32b738,cvv:_0xff62de,holder_name:_0x15dbf8,customer_email:_0x124403,customer_birth_date:_0x53c5f1,billing_country:_0x3a03b1,customer_phone:_0x30dc53,billing_address:_0x2b319e,billing_city:_0x530a84,billing_state:_0x52d0e9,billing_zip:_0x4de03a}=_0x1af584[_0x51b2bb(0x17b)];console['log']('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x2e1f92);if(!_0x4cf40e||!_0x4a0d4b||!_0x32b738||!_0xff62de||!_0x15dbf8||!_0x124403)return _0x5dccaf[_0x51b2bb(0x163)](0x190)[_0x51b2bb(0x1b6)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x3a03b1&&!isValidCountryCode(_0x3a03b1))return _0x5dccaf[_0x51b2bb(0x163)](0x190)[_0x51b2bb(0x1b6)]({'success':![],'message':_0x51b2bb(0x175)});const _0x13f818=await database_1['default'][_0x51b2bb(0x14b)]['findUnique']({'where':{'id':_0x2e1f92},'include':{'shop':!![]}});if(!_0x13f818)return _0x5dccaf[_0x51b2bb(0x163)](0x194)[_0x51b2bb(0x1b6)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x13f818['status']!=='PENDING')return _0x5dccaf[_0x51b2bb(0x163)](0x190)[_0x51b2bb(0x1b6)]({'success':![],'message':_0x51b2bb(0x191)});const _0x2cc46e=(0x0,ipHelper_1[_0x51b2bb(0x146)])(_0x1af584),_0x5ec24c={'number':_0x4cf40e['replace'](/\s/g,''),'exp_month':_0x4a0d4b[_0x51b2bb(0x147)]()['padStart'](0x2,'0'),'exp_year':_0x32b738[_0x51b2bb(0x147)](),'verification_value':_0xff62de,'holder':_0x15dbf8[_0x51b2bb(0x196)]()},_0x44451d={'ip':_0x2cc46e,'email':_0x124403};_0x53c5f1&&(_0x44451d['birth_date']=_0x53c5f1);let _0x40754d;_0x3a03b1&&(_0x40754d={'country':_0x3a03b1,'address':_0x2b319e,'city':_0x530a84,'state':_0x52d0e9,'zip':_0x4de03a});const _0x9535d1=(process[_0x51b2bb(0x1b4)][_0x51b2bb(0x192)]||_0x51b2bb(0x143))+'/payment/pending?id='+_0x2e1f92+_0x51b2bb(0x14f)+(_0x13f818[_0x51b2bb(0x1b3)]||_0x2e1f92),_0x7d85b6=(process[_0x51b2bb(0x1b4)][_0x51b2bb(0x15d)]||_0x51b2bb(0x14c))+_0x51b2bb(0x181),_0x2b7a1e=_0x2e1f92[_0x51b2bb(0x185)](0x0,0x8)+'-'+_0x2e1f92[_0x51b2bb(0x185)](0x8,0x10);console['log'](_0x51b2bb(0x172)),console[_0x51b2bb(0x19c)]('\x20\x20\x20Payment\x20ID:\x20'+_0x2e1f92),console[_0x51b2bb(0x19c)](_0x51b2bb(0x1ac)+_0x13f818[_0x51b2bb(0x197)]+'\x20'+_0x13f818[_0x51b2bb(0x178)]),console[_0x51b2bb(0x19c)](_0x51b2bb(0x17e)+_0x124403+'\x20('+_0x2cc46e+')'),console[_0x51b2bb(0x19c)](_0x51b2bb(0x15a)+(_0x3a03b1||_0x51b2bb(0x1b2))),console[_0x51b2bb(0x19c)](_0x51b2bb(0x17f)+_0x2b7a1e);const _0x2d3360=await this[_0x51b2bb(0x14e)][_0x51b2bb(0x1b5)](Math['round'](_0x13f818[_0x51b2bb(0x197)]*0x64),_0x13f818[_0x51b2bb(0x178)],_0x2b7a1e,_0x9535d1,_0x7d85b6,_0x5ec24c,_0x44451d,_0x40754d,_0x30dc53),_0x453b6c=this[_0x51b2bb(0x14e)]['getPaymentStatus'](_0x2d3360),_0x253000={'gatewayPaymentId':_0x2d3360[_0x51b2bb(0x182)],'cardLast4':_0x453b6c[_0x51b2bb(0x15f)],'gateway':_0x51b2bb(0x188),'customerEmail':_0x124403,'customerPhone':_0x30dc53,'customerBirthDate':_0x53c5f1,'billingAddress':_0x2b319e,'billingCity':_0x530a84,'billingState':_0x52d0e9,'billingZip':_0x4de03a,'customerCountry':_0x3a03b1};if(_0x453b6c[_0x51b2bb(0x163)]===_0x51b2bb(0x183)){_0x253000[_0x51b2bb(0x163)]='PAID',_0x253000[_0x51b2bb(0x184)]=new Date();try{const _0x36afba=await this['currencyService'][_0x51b2bb(0x18c)](_0x13f818[_0x51b2bb(0x197)],_0x13f818[_0x51b2bb(0x178)]);_0x253000[_0x51b2bb(0x1b1)]=_0x36afba,console['log'](_0x51b2bb(0x16b)+_0x36afba+_0x51b2bb(0x173));const _0x5e4885=await this['webhookService']['getGatewayCommission'](_0x13f818[_0x51b2bb(0x193)],_0x13f818[_0x51b2bb(0x199)]),_0x3da3f1=_0x36afba*(0x1-_0x5e4885/0x64);_0x253000[_0x51b2bb(0x155)]=_0x3da3f1,_0x253000[_0x51b2bb(0x1a4)]=_0x5e4885,console[_0x51b2bb(0x19c)](_0x51b2bb(0x1ab)+_0x13f818[_0x51b2bb(0x199)]+'\x20commission:\x20'+_0x5e4885+'%'),console[_0x51b2bb(0x19c)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x3da3f1[_0x51b2bb(0x15e)](0x6)+_0x51b2bb(0x173));}catch(_0x10fbc8){console[_0x51b2bb(0x18f)](_0x51b2bb(0x169),_0x10fbc8),_0x253000[_0x51b2bb(0x1b1)]=0x0,_0x253000[_0x51b2bb(0x155)]=0x0,_0x253000[_0x51b2bb(0x1a4)]=0x0;}}else _0x453b6c['status']===_0x51b2bb(0x16f)&&(_0x253000['status']='FAILED',_0x253000[_0x51b2bb(0x19f)]=_0x453b6c[_0x51b2bb(0x19f)]);const _0x2464e5=await database_1['default'][_0x51b2bb(0x14b)][_0x51b2bb(0x189)]({'where':{'id':_0x2e1f92},'data':_0x253000});console[_0x51b2bb(0x19c)](_0x51b2bb(0x1b0)+_0x2464e5[_0x51b2bb(0x163)]);let _0x2f951a;if(_0x453b6c[_0x51b2bb(0x163)]==='FAILED')_0x2f951a=_0x453b6c['failureMessage']||_0x2d3360[_0x51b2bb(0x1a8)]||'Payment\x20failed';else _0x453b6c[_0x51b2bb(0x163)]===_0x51b2bb(0x149)?_0x2f951a=_0x2d3360[_0x51b2bb(0x1a8)]||_0x51b2bb(0x18a):_0x2f951a=_0x2d3360[_0x51b2bb(0x1a8)]||'Payment\x20processed\x20successfully';const _0x57c031={'success':_0x453b6c[_0x51b2bb(0x163)]!==_0x51b2bb(0x16f),'status':_0x453b6c[_0x51b2bb(0x163)],'message':_0x2f951a,'payment':{'id':_0x2e1f92,'status':_0x2464e5[_0x51b2bb(0x163)],'gateway':'squirrelpay','last4':_0x453b6c['cardLast4']}};_0x453b6c[_0x51b2bb(0x179)]&&(_0x57c031['redirect_url']=_0x453b6c[_0x51b2bb(0x179)],_0x57c031['requires_action']=!![],console[_0x51b2bb(0x19c)](_0x51b2bb(0x171)+_0x453b6c[_0x51b2bb(0x179)])),_0x5dccaf[_0x51b2bb(0x1b6)](_0x57c031);}catch(_0x90172c){console[_0x51b2bb(0x18f)](_0x51b2bb(0x18d),_0x90172c),_0x264faa(_0x90172c);}},this[_0x3bf322(0x164)]=async(_0x298573,_0x1ee5cc,_0x4d1e49)=>{const _0x4edc07=_0x3bf322;try{console[_0x4edc07(0x19c)](_0x4edc07(0x14d)),console[_0x4edc07(0x19c)](_0x4edc07(0x176),_0x298573['headers']),console['log'](_0x4edc07(0x154),_0x298573['body']),this[_0x4edc07(0x14e)]['logWebhook']({'headers':_0x298573[_0x4edc07(0x194)],'body':_0x298573[_0x4edc07(0x17b)],'timestamp':new Date()[_0x4edc07(0x198)]()});const _0x2bfe61=_0x298573[_0x4edc07(0x17b)];if(!_0x2bfe61['uid']||!_0x2bfe61[_0x4edc07(0x163)])return console[_0x4edc07(0x17c)](_0x4edc07(0x19b)),_0x1ee5cc['status'](0x190)[_0x4edc07(0x1b6)]({'success':![],'message':_0x4edc07(0x1a3)});let _0x5544bf;_0x2bfe61[_0x4edc07(0x182)]&&(_0x5544bf=await database_1['default'][_0x4edc07(0x14b)]['findFirst']({'where':{'gatewayPaymentId':_0x2bfe61[_0x4edc07(0x182)],'gateway':_0x4edc07(0x188)}}));if(!_0x5544bf)return console[_0x4edc07(0x17c)](_0x4edc07(0x195)),console[_0x4edc07(0x17c)](_0x4edc07(0x19e)+_0x2bfe61['uid']),console[_0x4edc07(0x17c)](_0x4edc07(0x17f)+_0x2bfe61[_0x4edc07(0x16d)]),console[_0x4edc07(0x17c)]('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x4edc07(0x17c)](_0x4edc07(0x161)+_0x2bfe61[_0x4edc07(0x182)]),_0x1ee5cc['status'](0x194)[_0x4edc07(0x1b6)]({'success':![],'message':_0x4edc07(0x167)});console[_0x4edc07(0x19c)](_0x4edc07(0x159)+_0x5544bf['id']),console[_0x4edc07(0x19c)](_0x4edc07(0x1a5)+_0x5544bf['status']),console[_0x4edc07(0x19c)](_0x4edc07(0x17a)+_0x5544bf[_0x4edc07(0x157)]),console['log'](_0x4edc07(0x14a)+_0x2bfe61['status']),console[_0x4edc07(0x19c)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x2bfe61[_0x4edc07(0x182)]);let _0x50eee0=null;const _0x2ef540={};switch(_0x2bfe61[_0x4edc07(0x163)]){case _0x4edc07(0x177):_0x50eee0=_0x4edc07(0x183),console[_0x4edc07(0x19c)](_0x4edc07(0x1a7));break;case _0x4edc07(0x1a9):_0x50eee0=_0x4edc07(0x16f),_0x2ef540['failureMessage']=_0x2bfe61[_0x4edc07(0x1a8)]||_0x2bfe61[_0x4edc07(0x1b7)]||_0x4edc07(0x166),console[_0x4edc07(0x19c)](_0x4edc07(0x18b)+_0x2ef540[_0x4edc07(0x19f)]);break;case _0x4edc07(0x186):console['log']('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console['warn']('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x2bfe61[_0x4edc07(0x163)]);break;}if(_0x50eee0&&_0x50eee0!==_0x5544bf[_0x4edc07(0x163)])console['log'](_0x4edc07(0x151)+_0x5544bf['status']+_0x4edc07(0x156)+_0x50eee0),await this['webhookService']['updatePaymentStatus'](_0x5544bf['id'],_0x50eee0,_0x2ef540),console[_0x4edc07(0x19c)](_0x4edc07(0x153)+_0x5544bf['id']+'\x20updated:\x20status='+_0x50eee0+_0x4edc07(0x15b));else _0x50eee0&&console[_0x4edc07(0x19c)]('â„¹ï¸\x20Payment\x20'+_0x5544bf['id']+_0x4edc07(0x168)+_0x50eee0+',\x20skipping\x20update');_0x1ee5cc['status'](0xc8)[_0x4edc07(0x1b6)]({'success':!![],'message':_0x4edc07(0x1a2)});}catch(_0x88e645){console[_0x4edc07(0x18f)](_0x4edc07(0x162),_0x88e645),_0x4d1e49(_0x88e645);}},this[_0x3bf322(0x19d)]=async(_0x40a300,_0x1ba4fc,_0x125a66)=>{const _0x23cc1f=_0x3bf322;try{const {limit:_0xad4aa}=_0x40a300[_0x23cc1f(0x19a)],_0x4814b4=this['squirrelPayService']['getWebhookLogs'](_0xad4aa?parseInt(_0xad4aa):0x32);_0x1ba4fc[_0x23cc1f(0x1b6)]({'success':!![],'result':{'logs':_0x4814b4,'count':_0x4814b4[_0x23cc1f(0x150)]}});}catch(_0x148a03){_0x125a66(_0x148a03);}},this[_0x3bf322(0x14e)]=new squirrelPayService_1[(_0x3bf322(0x158))]({'shopId':process['env'][_0x3bf322(0x190)]||'','secretKey':process[_0x3bf322(0x1b4)]['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0x3bf322(0x1b4)]['SQUIRREL_PAY_BASE_URL']||_0x3bf322(0x144),'isTestMode':process[_0x3bf322(0x1b4)][_0x3bf322(0x15c)]===_0x3bf322(0x152)}),this['currencyService']=new currencyService_1[(_0x3bf322(0x1a0))](),this[_0x3bf322(0x165)]=new webhookService_1['WebhookService']();}}exports[a16_0xf160c6(0x1ae)]=SquirrelPayController;