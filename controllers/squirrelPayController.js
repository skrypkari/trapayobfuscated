'use strict';const a19_0x4f4be6=a19_0x2a6f;function a19_0x2a6f(_0x23080b,_0x6b2cf0){_0x23080b=_0x23080b-0x114;const _0x48c60e=a19_0x48c6();let _0x2a6f3f=_0x48c60e[_0x23080b];return _0x2a6f3f;}function a19_0x48c6(){const _0xd0793e=['FAILED','getGatewayCommission','ðŸ’°\x20Gateway\x20','ðŸ’¾\x20Update\x20data\x20being\x20saved:','\x20already\x20has\x20status\x20','status','webhookService','currency','amountUSDT','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','json',',\x20skipping\x20update','17445948swxoIl','friendly_message','true','payment','default','logWebhook','paidAt','failureMessage','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','\x20\x20\x20Webhook\x20status:\x20','squirrelpay','\x20commission:\x20','squirrelPayService','ðŸ“\x20SquirrelPay\x20payment\x20details:','SquirrelPayService','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Webhook\x20UID:\x20','https://app.trapay.uk','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','query','193784RrlYSf','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','findFirst','redirect_url','/payment/pending?id=','phoneRiskLevel','warn','redirectUrl','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','convertToUSDT','WebhookService','\x20to\x20','round','1890nedbMC','PENDING','14ApGhVQ','defineProperty','lineStatus','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','body','Body:','not\x20provided',',\x20balance\x20updated,\x20amountUSDT\x20calculated','../utils/ipHelper','https://gate.squirrel-pay.com','Missing\x20required\x20card\x20or\x20customer\x20information','shopId','has','uid','last_4','log','Payment\x20failed','headers','cardBrand','isVoip','error','Webhook\x20processed\x20successfully','update','PAID','1620455xYKblh','CurrencyService','gatewayCommissionRate','14069qCbSAB','\x20\x20\x20Billing\x20Country:\x20','toString','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','118674jGgxtf','phoneIsVoip','ðŸ“ž\x20Phone\x20validation\x20data:','ðŸ’³\x20Card\x20last\x204:\x20','params','SquirrelPayController','Payment\x20is\x20not\x20in\x20pending\x20status','Payment\x20not\x20found','getWebhookLogs','../services/webhookService','../services/currencyService','/api/webhooks/squirrel-pay','handleWebhook','amountAfterGatewayCommissionUSDT','6cnXHXW','153lsRvRU','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','\x20updated:\x20status=','payment_method','amount','toUpperCase','slice','__esModule','toFixed','currencyService','184588aCXkwn','brand','updatePaymentStatus','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','Payment\x20is\x20being\x20processed','35OyxOFT','gatewayPaymentId','findUnique','gateway','60939jbtzrZ','length','getClientIP','cardLast4','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','replace','__importDefault','\x20\x20\x20UID:\x20','&payment_id=','processCardPayment','\x20\x20\x20Description:\x20'];a19_0x48c6=function(){return _0xd0793e;};return a19_0x48c6();}(function(_0x3b456a,_0x8d1652){const _0x2568c0=a19_0x2a6f,_0x213f27=_0x3b456a();while(!![]){try{const _0x58c255=-parseInt(_0x2568c0(0x168))/0x1*(parseInt(_0x2568c0(0x126))/0x2)+parseInt(_0x2568c0(0x154))/0x3*(-parseInt(_0x2568c0(0x15f))/0x4)+-parseInt(_0x2568c0(0x13f))/0x5+-parseInt(_0x2568c0(0x146))/0x6*(parseInt(_0x2568c0(0x164))/0x7)+-parseInt(_0x2568c0(0x117))/0x8*(parseInt(_0x2568c0(0x155))/0x9)+parseInt(_0x2568c0(0x124))/0xa*(parseInt(_0x2568c0(0x142))/0xb)+parseInt(_0x2568c0(0x180))/0xc;if(_0x58c255===_0x8d1652)break;else _0x213f27['push'](_0x213f27['shift']());}catch(_0x869f91){_0x213f27['push'](_0x213f27['shift']());}}}(a19_0x48c6,0x5379c));var __importDefault=this&&this[a19_0x4f4be6(0x16e)]||function(_0x3e8571){return _0x3e8571&&_0x3e8571['__esModule']?_0x3e8571:{'default':_0x3e8571};};Object[a19_0x4f4be6(0x127)](exports,a19_0x4f4be6(0x15c),{'value':!![]}),exports[a19_0x4f4be6(0x14b)]=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a19_0x4f4be6(0x150)),webhookService_1=require(a19_0x4f4be6(0x14f)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a19_0x4f4be6(0x12f)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x3ee256){const _0x14655d=a19_0x4f4be6;return ISO_COUNTRY_CODES[_0x14655d(0x133)](_0x3ee256[_0x14655d(0x15a)]());}class SquirrelPayController{constructor(){const _0x51c40d=a19_0x4f4be6;this[_0x51c40d(0x171)]=async(_0x223900,_0x109b5b,_0x288bc0)=>{const _0x1bef62=_0x51c40d;try{const {paymentId:_0x270b93}=_0x223900[_0x1bef62(0x14a)],{card_number:_0x226b27,exp_month:_0xb0644a,exp_year:_0x3290c2,cvv:_0x295faf,holder_name:_0x66967,customer_email:_0x4eda5a,customer_birth_date:_0x571b8b,billing_country:_0x4fdc70,customer_phone:_0x26438f,billing_address:_0x2377c6,billing_city:_0x3fa118,billing_state:_0x40a6f2,billing_zip:_0x101f8f,phoneValidation:_0xcf763e}=_0x223900[_0x1bef62(0x12b)];console[_0x1bef62(0x136)](_0x1bef62(0x12a)+_0x270b93),console[_0x1bef62(0x136)](_0x1bef62(0x148),_0xcf763e);if(!_0x226b27||!_0xb0644a||!_0x3290c2||!_0x295faf||!_0x66967||!_0x4eda5a)return _0x109b5b[_0x1bef62(0x178)](0x190)['json']({'success':![],'message':_0x1bef62(0x131)});if(_0x4fdc70&&!isValidCountryCode(_0x4fdc70))return _0x109b5b[_0x1bef62(0x178)](0x190)[_0x1bef62(0x17e)]({'success':![],'message':_0x1bef62(0x17d)});const _0x446160=await database_1[_0x1bef62(0x184)][_0x1bef62(0x183)][_0x1bef62(0x166)]({'where':{'id':_0x270b93},'include':{'shop':!![]}});if(!_0x446160)return _0x109b5b[_0x1bef62(0x178)](0x194)[_0x1bef62(0x17e)]({'success':![],'message':_0x1bef62(0x14d)});if(_0x446160[_0x1bef62(0x178)]!=='PENDING')return _0x109b5b[_0x1bef62(0x178)](0x190)[_0x1bef62(0x17e)]({'success':![],'message':_0x1bef62(0x14c)});const _0x1a8ce5=(0x0,ipHelper_1[_0x1bef62(0x16a)])(_0x223900),_0xccdb8a={'number':_0x226b27[_0x1bef62(0x16d)](/\s/g,''),'exp_month':_0xb0644a[_0x1bef62(0x144)]()['padStart'](0x2,'0'),'exp_year':_0x3290c2[_0x1bef62(0x144)](),'verification_value':_0x295faf,'holder':_0x66967['toUpperCase']()},_0x1aeefa={'ip':_0x1a8ce5,'email':_0x4eda5a};_0x571b8b&&(_0x1aeefa['birth_date']=_0x571b8b);let _0x1f5ba1;_0x4fdc70&&(_0x1f5ba1={'country':_0x4fdc70,'address':_0x2377c6,'city':_0x3fa118,'state':_0x40a6f2,'zip':_0x101f8f});const _0x1b4b10=(process.env.FRONTEND_URL||_0x1bef62(0x114))+_0x1bef62(0x11b)+_0x270b93+_0x1bef62(0x170)+(_0x446160['gatewayOrderId']||_0x270b93),_0x1f904f=(process.env.API_BASE_URL||'https://api.trapay.uk')+_0x1bef62(0x151),_0x3f0e30=_0x270b93[_0x1bef62(0x15b)](0x0,0x8)+'-'+_0x270b93[_0x1bef62(0x15b)](0x8,0x10);console[_0x1bef62(0x136)](_0x1bef62(0x18d)),console[_0x1bef62(0x136)]('\x20\x20\x20Payment\x20ID:\x20'+_0x270b93),console['log']('\x20\x20\x20Amount:\x20'+_0x446160[_0x1bef62(0x159)]+'\x20'+_0x446160[_0x1bef62(0x17a)]),console[_0x1bef62(0x136)]('\x20\x20\x20Customer:\x20'+_0x4eda5a+'\x20('+_0x1a8ce5+')'),console[_0x1bef62(0x136)](_0x1bef62(0x143)+(_0x4fdc70||_0x1bef62(0x12d))),console[_0x1bef62(0x136)]('\x20\x20\x20Description:\x20'+_0x3f0e30);const _0x414453=await this[_0x1bef62(0x18c)][_0x1bef62(0x171)](Math[_0x1bef62(0x123)](_0x446160['amount']*0x64),_0x446160['currency'],_0x3f0e30,_0x1b4b10,_0x1f904f,_0xccdb8a,_0x1aeefa,_0x1f5ba1,_0x26438f),_0x7a69bf=this['squirrelPayService']['getPaymentStatus'](_0x414453),_0x33e2fd={'gatewayPaymentId':_0x414453[_0x1bef62(0x134)],'cardLast4':_0x7a69bf[_0x1bef62(0x16b)],'gateway':_0x1bef62(0x18a),'customerEmail':_0x4eda5a,'customerPhone':_0x26438f,'customerBirthDate':_0x571b8b,'billingAddress':_0x2377c6,'billingCity':_0x3fa118,'billingState':_0x40a6f2,'billingZip':_0x101f8f,'customerCountry':_0x4fdc70,'phoneIsValid':_0xcf763e?.['isValid'],'phoneLineStatus':_0xcf763e?.[_0x1bef62(0x128)],'phoneIsVoip':_0xcf763e?.[_0x1bef62(0x13a)],'phoneRiskLevel':_0xcf763e?.['riskLevel']};console[_0x1bef62(0x136)](_0x1bef62(0x176),{'phoneIsValid':_0x33e2fd['phoneIsValid'],'phoneLineStatus':_0x33e2fd['phoneLineStatus'],'phoneIsVoip':_0x33e2fd[_0x1bef62(0x147)],'phoneRiskLevel':_0x33e2fd[_0x1bef62(0x11c)]});if(_0x7a69bf['status']===_0x1bef62(0x13e)){_0x33e2fd['status']=_0x1bef62(0x13e),_0x33e2fd[_0x1bef62(0x186)]=new Date();try{const _0x2c2d65=await this[_0x1bef62(0x15e)][_0x1bef62(0x120)](_0x446160['amount'],_0x446160[_0x1bef62(0x17a)]);_0x33e2fd[_0x1bef62(0x17b)]=_0x2c2d65,console[_0x1bef62(0x136)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x2c2d65+'\x20USDT');const _0x204d6c=await this['webhookService'][_0x1bef62(0x174)](_0x446160[_0x1bef62(0x132)],_0x446160[_0x1bef62(0x167)]),_0xeb0b32=_0x2c2d65*(0x1-_0x204d6c/0x64);_0x33e2fd['amountAfterGatewayCommissionUSDT']=_0xeb0b32,_0x33e2fd[_0x1bef62(0x141)]=_0x204d6c,console[_0x1bef62(0x136)](_0x1bef62(0x175)+_0x446160[_0x1bef62(0x167)]+_0x1bef62(0x18b)+_0x204d6c+'%'),console[_0x1bef62(0x136)](_0x1bef62(0x11f)+_0xeb0b32[_0x1bef62(0x15d)](0x6)+'\x20USDT');}catch(_0x3b8037){console[_0x1bef62(0x13b)](_0x1bef62(0x188),_0x3b8037),_0x33e2fd['amountUSDT']=0x0,_0x33e2fd[_0x1bef62(0x153)]=0x0,_0x33e2fd[_0x1bef62(0x141)]=0x0;}}else _0x7a69bf[_0x1bef62(0x178)]===_0x1bef62(0x173)&&(_0x33e2fd[_0x1bef62(0x178)]=_0x1bef62(0x173),_0x33e2fd['failureMessage']=_0x7a69bf['failureMessage']);const _0x5cae1f=await database_1[_0x1bef62(0x184)][_0x1bef62(0x183)][_0x1bef62(0x13d)]({'where':{'id':_0x270b93},'data':_0x33e2fd});console[_0x1bef62(0x136)](_0x1bef62(0x118)+_0x5cae1f[_0x1bef62(0x178)]);let _0x1b044a;if(_0x7a69bf['status']==='FAILED')_0x1b044a=_0x7a69bf['failureMessage']||_0x414453['friendly_message']||_0x1bef62(0x137);else _0x7a69bf[_0x1bef62(0x178)]===_0x1bef62(0x125)?_0x1b044a=_0x414453[_0x1bef62(0x181)]||_0x1bef62(0x163):_0x1b044a=_0x414453['friendly_message']||'Payment\x20processed\x20successfully';const _0x177ce6={'success':_0x7a69bf[_0x1bef62(0x178)]!==_0x1bef62(0x173),'status':_0x7a69bf[_0x1bef62(0x178)],'message':_0x1b044a,'payment':{'id':_0x270b93,'status':_0x5cae1f['status'],'gateway':_0x1bef62(0x18a),'last4':_0x7a69bf[_0x1bef62(0x16b)]}};_0x7a69bf[_0x1bef62(0x11e)]&&(_0x177ce6[_0x1bef62(0x11a)]=_0x7a69bf[_0x1bef62(0x11e)],_0x177ce6['requires_action']=!![],console['log'](_0x1bef62(0x17c)+_0x7a69bf[_0x1bef62(0x11e)])),_0x109b5b[_0x1bef62(0x17e)](_0x177ce6);}catch(_0x3d29cf){console['error']('âŒ\x20SquirrelPay\x20card\x20payment\x20error:',_0x3d29cf),_0x288bc0(_0x3d29cf);}},this[_0x51c40d(0x152)]=async(_0x9f1ba0,_0x2236e0,_0x3ac85a)=>{const _0x5889f9=_0x51c40d;try{console['log']('ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'),console[_0x5889f9(0x136)]('Headers:',_0x9f1ba0[_0x5889f9(0x138)]),console[_0x5889f9(0x136)](_0x5889f9(0x12c),_0x9f1ba0[_0x5889f9(0x12b)]),this[_0x5889f9(0x18c)][_0x5889f9(0x185)]({'headers':_0x9f1ba0[_0x5889f9(0x138)],'body':_0x9f1ba0[_0x5889f9(0x12b)],'timestamp':new Date()['toISOString']()});const _0x5e299d=_0x9f1ba0[_0x5889f9(0x12b)];if(!_0x5e299d['uid']||!_0x5e299d[_0x5889f9(0x178)])return console[_0x5889f9(0x11d)](_0x5889f9(0x156)),_0x2236e0['status'](0x190)[_0x5889f9(0x17e)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x58da69;_0x5e299d[_0x5889f9(0x134)]&&(_0x58da69=await database_1['default'][_0x5889f9(0x183)][_0x5889f9(0x119)]({'where':{'gatewayPaymentId':_0x5e299d[_0x5889f9(0x134)],'gateway':_0x5889f9(0x18a)}}));if(!_0x58da69)return console[_0x5889f9(0x11d)]('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x5889f9(0x11d)](_0x5889f9(0x16f)+_0x5e299d['uid']),console['warn'](_0x5889f9(0x172)+_0x5e299d['description']),console[_0x5889f9(0x11d)]('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x5889f9(0x11d)](_0x5889f9(0x145)+_0x5e299d['uid']),_0x2236e0[_0x5889f9(0x178)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console[_0x5889f9(0x136)](_0x5889f9(0x162)+_0x58da69['id']),console['log']('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x58da69[_0x5889f9(0x178)]),console[_0x5889f9(0x136)](_0x5889f9(0x129)+_0x58da69[_0x5889f9(0x165)]),console[_0x5889f9(0x136)](_0x5889f9(0x189)+_0x5e299d['status']),console['log'](_0x5889f9(0x190)+_0x5e299d[_0x5889f9(0x134)]);let _0x198806=null;const _0x2ca97b={};_0x5e299d[_0x5889f9(0x158)]?.[_0x5889f9(0x160)]&&(_0x2ca97b[_0x5889f9(0x139)]=_0x5e299d['payment_method'][_0x5889f9(0x160)],console[_0x5889f9(0x136)]('ðŸ’³\x20Card\x20brand\x20detected:\x20'+_0x5e299d[_0x5889f9(0x158)][_0x5889f9(0x160)]));_0x5e299d[_0x5889f9(0x158)]?.['last_4']&&(_0x2ca97b[_0x5889f9(0x16b)]=_0x5e299d[_0x5889f9(0x158)][_0x5889f9(0x135)],console[_0x5889f9(0x136)](_0x5889f9(0x149)+_0x5e299d['payment_method']['last_4']));switch(_0x5e299d[_0x5889f9(0x178)]){case'successful':_0x198806=_0x5889f9(0x13e),console[_0x5889f9(0x136)](_0x5889f9(0x18f));break;case'failed':_0x198806=_0x5889f9(0x173),_0x2ca97b['failureMessage']=_0x5e299d['friendly_message']||_0x5e299d['message']||_0x5889f9(0x137),console[_0x5889f9(0x136)](_0x5889f9(0x16c)+_0x2ca97b[_0x5889f9(0x187)]);break;case'incomplete':console['log']('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console[_0x5889f9(0x11d)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x5e299d['status']);break;}if(_0x198806&&_0x198806!==_0x58da69[_0x5889f9(0x178)])console['log'](_0x5889f9(0x115)+_0x58da69['status']+_0x5889f9(0x122)+_0x198806),await this[_0x5889f9(0x179)][_0x5889f9(0x161)](_0x58da69['id'],_0x198806,_0x2ca97b),console[_0x5889f9(0x136)]('âœ…\x20Payment\x20'+_0x58da69['id']+_0x5889f9(0x157)+_0x198806+_0x5889f9(0x12e));else _0x198806&&console[_0x5889f9(0x136)]('â„¹ï¸\x20Payment\x20'+_0x58da69['id']+_0x5889f9(0x177)+_0x198806+_0x5889f9(0x17f));_0x2236e0['status'](0xc8)[_0x5889f9(0x17e)]({'success':!![],'message':_0x5889f9(0x13c)});}catch(_0xe5d814){console[_0x5889f9(0x13b)]('âŒ\x20SquirrelPay\x20webhook\x20error:',_0xe5d814),_0x3ac85a(_0xe5d814);}},this[_0x51c40d(0x14e)]=async(_0x232176,_0x504db8,_0x53d8dd)=>{const _0x2ac806=_0x51c40d;try{const {limit:_0x24fc2b}=_0x232176[_0x2ac806(0x116)],_0x17a555=this[_0x2ac806(0x18c)][_0x2ac806(0x14e)](_0x24fc2b?parseInt(_0x24fc2b):0x32);_0x504db8[_0x2ac806(0x17e)]({'success':!![],'result':{'logs':_0x17a555,'count':_0x17a555[_0x2ac806(0x169)]}});}catch(_0x3546e5){_0x53d8dd(_0x3546e5);}},this['squirrelPayService']=new squirrelPayService_1[(_0x51c40d(0x18e))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x51c40d(0x130),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0x51c40d(0x182)}),this[_0x51c40d(0x15e)]=new currencyService_1[(_0x51c40d(0x140))](),this[_0x51c40d(0x179)]=new webhookService_1[(_0x51c40d(0x121))]();}}exports['SquirrelPayController']=SquirrelPayController;