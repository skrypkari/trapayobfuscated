'use strict';const a18_0x24bf31=a18_0x6533;(function(_0x482c70,_0x21cb3f){const _0x30bf3c=a18_0x6533,_0x34b0a9=_0x482c70();while(!![]){try{const _0x555a8e=-parseInt(_0x30bf3c(0x121))/0x1*(parseInt(_0x30bf3c(0x172))/0x2)+parseInt(_0x30bf3c(0x174))/0x3*(-parseInt(_0x30bf3c(0x143))/0x4)+-parseInt(_0x30bf3c(0x117))/0x5*(parseInt(_0x30bf3c(0x10d))/0x6)+-parseInt(_0x30bf3c(0x107))/0x7+-parseInt(_0x30bf3c(0x100))/0x8*(parseInt(_0x30bf3c(0x145))/0x9)+parseInt(_0x30bf3c(0x112))/0xa*(-parseInt(_0x30bf3c(0x116))/0xb)+-parseInt(_0x30bf3c(0x113))/0xc*(-parseInt(_0x30bf3c(0x12b))/0xd);if(_0x555a8e===_0x21cb3f)break;else _0x34b0a9['push'](_0x34b0a9['shift']());}catch(_0x57810e){_0x34b0a9['push'](_0x34b0a9['shift']());}}}(a18_0x473d,0x1f0ac));function a18_0x6533(_0x24e206,_0x3fc5f8){_0x24e206=_0x24e206-0xfb;const _0x473dd4=a18_0x473d();let _0x65336f=_0x473dd4[_0x24e206];return _0x65336f;}var __importDefault=this&&this[a18_0x24bf31(0x14a)]||function(_0x2d8d80){return _0x2d8d80&&_0x2d8d80['__esModule']?_0x2d8d80:{'default':_0x2d8d80};};Object[a18_0x24bf31(0x15b)](exports,a18_0x24bf31(0x178),{'value':!![]}),exports[a18_0x24bf31(0x152)]=void 0x0;const squirrelPayService_1=require(a18_0x24bf31(0x14f)),currencyService_1=require(a18_0x24bf31(0x125)),webhookService_1=require(a18_0x24bf31(0x160)),database_1=__importDefault(require(a18_0x24bf31(0x138))),ipHelper_1=require(a18_0x24bf31(0x129)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a18_0x473d(){const _0xc79e37=['findFirst','Payment\x20not\x20found','warn','\x20\x20\x20Amount:\x20','/api/webhooks/squirrel-pay','Payment\x20processed\x20successfully','status','../config/database','\x20\x20\x20Webhook\x20status:\x20','friendly_message','not\x20provided','currencyService','Body:','\x20USDT','â„¹ï¸\x20Payment\x20','default','amountAfterGatewayCommissionUSDT','toUpperCase','12gToqtY','findUnique','680373JreqzQ','SquirrelPayService','uid','ðŸ“\x20SquirrelPay\x20payment\x20details:','convertToUSDT','__importDefault','error','https://app.trapay.uk','gatewayOrderId','\x20\x20\x20Payment\x20ID:\x20','../services/gateways/squirrelPayService','Missing\x20required\x20fields\x20in\x20webhook','payment','SquirrelPayController','https://api.trapay.uk','slice','amount','\x20\x20\x20Billing\x20Country:\x20','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','amountUSDT','currency','squirrelPayService','defineProperty','\x20updated:\x20status=','getClientIP','update','âœ…\x20Payment\x20','../services/webhookService','failureMessage','processCardPayment','Payment\x20failed','paidAt','birth_date','getWebhookLogs','has','PAID','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','\x20\x20\x20Customer:\x20','\x20\x20\x20Webhook\x20UID:\x20','handleWebhook','Missing\x20required\x20card\x20or\x20customer\x20information','Headers:','\x20\x20\x20UID:\x20','log','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','296108bULGBm','toISOString','164799VvDoYs','last_4','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','__esModule','cardBrand','CurrencyService','requires_action','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','\x20to\x20','getPaymentStatus','ðŸ’³\x20Card\x20brand\x20detected:\x20','16hruXHe','body','successful',',\x20balance\x20updated,\x20amountUSDT\x20calculated','brand','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','description','511840AovmQU','Payment\x20is\x20being\x20processed','https://gate.squirrel-pay.com','gatewayCommissionRate','padStart','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','13794dzBpBl','ðŸ’°\x20Gateway\x20','payment_method','gateway','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','719330msSQpB','552UtHIyt','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','ðŸ’³\x20Card\x20last\x204:\x20','11fQqgit','550wTmlbG','redirectUrl','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','ðŸ’°\x20Calculated\x20amountUSDT:\x20','shopId','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','length','Payment\x20is\x20not\x20in\x20pending\x20status','toFixed','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','1tTBOVg','Webhook\x20processed\x20successfully','webhookService','failed','../services/currencyService','replace','json','\x20commission:\x20','../utils/ipHelper','logWebhook','279539bOLFcl','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','round','squirrelpay','\x20\x20\x20Description:\x20','FAILED'];a18_0x473d=function(){return _0xc79e37;};return a18_0x473d();}function isValidCountryCode(_0x2a0ace){const _0x6fc2e7=a18_0x24bf31;return ISO_COUNTRY_CODES[_0x6fc2e7(0x167)](_0x2a0ace['toUpperCase']());}class SquirrelPayController{constructor(){const _0x2e4864=a18_0x24bf31;this[_0x2e4864(0x162)]=async(_0x1d5194,_0x27ed4e,_0x3a6ea7)=>{const _0x4ea101=_0x2e4864;try{const {paymentId:_0x5b829a}=_0x1d5194['params'],{card_number:_0x53b666,exp_month:_0x34f9e6,exp_year:_0x4c38e2,cvv:_0xd4f3d7,holder_name:_0x1e64c9,customer_email:_0x34e71b,customer_birth_date:_0x44ac79,billing_country:_0x1a4f1c,customer_phone:_0x3df497,billing_address:_0x9243db,billing_city:_0x4539ec,billing_state:_0x297607,billing_zip:_0x3d20f8}=_0x1d5194[_0x4ea101(0x101)];console['log'](_0x4ea101(0x120)+_0x5b829a);if(!_0x53b666||!_0x34f9e6||!_0x4c38e2||!_0xd4f3d7||!_0x1e64c9||!_0x34e71b)return _0x27ed4e[_0x4ea101(0x137)](0x190)[_0x4ea101(0x127)]({'success':![],'message':_0x4ea101(0x16d)});if(_0x1a4f1c&&!isValidCountryCode(_0x1a4f1c))return _0x27ed4e['status'](0x190)[_0x4ea101(0x127)]({'success':![],'message':_0x4ea101(0x177)});const _0x39e51c=await database_1[_0x4ea101(0x140)][_0x4ea101(0x151)][_0x4ea101(0x144)]({'where':{'id':_0x5b829a},'include':{'shop':!![]}});if(!_0x39e51c)return _0x27ed4e['status'](0x194)[_0x4ea101(0x127)]({'success':![],'message':_0x4ea101(0x132)});if(_0x39e51c[_0x4ea101(0x137)]!=='PENDING')return _0x27ed4e['status'](0x190)[_0x4ea101(0x127)]({'success':![],'message':_0x4ea101(0x11e)});const _0x4d1739=(0x0,ipHelper_1[_0x4ea101(0x15d)])(_0x1d5194),_0x31cd8a={'number':_0x53b666[_0x4ea101(0x126)](/\s/g,''),'exp_month':_0x34f9e6['toString']()[_0x4ea101(0x10b)](0x2,'0'),'exp_year':_0x4c38e2['toString'](),'verification_value':_0xd4f3d7,'holder':_0x1e64c9[_0x4ea101(0x142)]()},_0x587a4b={'ip':_0x4d1739,'email':_0x34e71b};_0x44ac79&&(_0x587a4b[_0x4ea101(0x165)]=_0x44ac79);let _0x4a8dae;_0x1a4f1c&&(_0x4a8dae={'country':_0x1a4f1c,'address':_0x9243db,'city':_0x4539ec,'state':_0x297607,'zip':_0x3d20f8});const _0x267527=(process.env.FRONTEND_URL||_0x4ea101(0x14c))+'/payment/pending?id='+_0x5b829a+'&payment_id='+(_0x39e51c[_0x4ea101(0x14d)]||_0x5b829a),_0x41ccf8=(process.env.API_BASE_URL||_0x4ea101(0x153))+_0x4ea101(0x135),_0x4f2037=_0x5b829a[_0x4ea101(0x154)](0x0,0x8)+'-'+_0x5b829a[_0x4ea101(0x154)](0x8,0x10);console['log'](_0x4ea101(0x148)),console['log'](_0x4ea101(0x14e)+_0x5b829a),console[_0x4ea101(0x170)](_0x4ea101(0x134)+_0x39e51c[_0x4ea101(0x155)]+'\x20'+_0x39e51c['currency']),console[_0x4ea101(0x170)](_0x4ea101(0x16a)+_0x34e71b+'\x20('+_0x4d1739+')'),console[_0x4ea101(0x170)](_0x4ea101(0x156)+(_0x1a4f1c||_0x4ea101(0x13b))),console[_0x4ea101(0x170)](_0x4ea101(0x12f)+_0x4f2037);const _0x378548=await this[_0x4ea101(0x15a)]['processCardPayment'](Math[_0x4ea101(0x12d)](_0x39e51c[_0x4ea101(0x155)]*0x64),_0x39e51c['currency'],_0x4f2037,_0x267527,_0x41ccf8,_0x31cd8a,_0x587a4b,_0x4a8dae,_0x3df497),_0x27ba0d=this[_0x4ea101(0x15a)][_0x4ea101(0xfe)](_0x378548),_0x4087ea={'gatewayPaymentId':_0x378548[_0x4ea101(0x147)],'cardLast4':_0x27ba0d['cardLast4'],'gateway':_0x4ea101(0x12e),'customerEmail':_0x34e71b,'customerPhone':_0x3df497,'customerBirthDate':_0x44ac79,'billingAddress':_0x9243db,'billingCity':_0x4539ec,'billingState':_0x297607,'billingZip':_0x3d20f8,'customerCountry':_0x1a4f1c};if(_0x27ba0d[_0x4ea101(0x137)]===_0x4ea101(0x168)){_0x4087ea[_0x4ea101(0x137)]=_0x4ea101(0x168),_0x4087ea[_0x4ea101(0x164)]=new Date();try{const _0x1d1097=await this[_0x4ea101(0x13c)][_0x4ea101(0x149)](_0x39e51c[_0x4ea101(0x155)],_0x39e51c[_0x4ea101(0x159)]);_0x4087ea[_0x4ea101(0x158)]=_0x1d1097,console[_0x4ea101(0x170)](_0x4ea101(0x11a)+_0x1d1097+_0x4ea101(0x13e));const _0x373c22=await this['webhookService']['getGatewayCommission'](_0x39e51c[_0x4ea101(0x11b)],_0x39e51c[_0x4ea101(0x110)]),_0x2d192c=_0x1d1097*(0x1-_0x373c22/0x64);_0x4087ea['amountAfterGatewayCommissionUSDT']=_0x2d192c,_0x4087ea['gatewayCommissionRate']=_0x373c22,console[_0x4ea101(0x170)](_0x4ea101(0x10e)+_0x39e51c[_0x4ea101(0x110)]+_0x4ea101(0x128)+_0x373c22+'%'),console['log'](_0x4ea101(0x114)+_0x2d192c[_0x4ea101(0x11f)](0x6)+_0x4ea101(0x13e));}catch(_0x431f14){console[_0x4ea101(0x14b)](_0x4ea101(0x119),_0x431f14),_0x4087ea[_0x4ea101(0x158)]=0x0,_0x4087ea[_0x4ea101(0x141)]=0x0,_0x4087ea[_0x4ea101(0x10a)]=0x0;}}else _0x27ba0d[_0x4ea101(0x137)]===_0x4ea101(0x130)&&(_0x4087ea[_0x4ea101(0x137)]='FAILED',_0x4087ea[_0x4ea101(0x161)]=_0x27ba0d[_0x4ea101(0x161)]);const _0x543dcb=await database_1['default'][_0x4ea101(0x151)][_0x4ea101(0x15e)]({'where':{'id':_0x5b829a},'data':_0x4087ea});console['log']('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x543dcb[_0x4ea101(0x137)]);let _0x7ad39;if(_0x27ba0d['status']===_0x4ea101(0x130))_0x7ad39=_0x27ba0d['failureMessage']||_0x378548[_0x4ea101(0x13a)]||'Payment\x20failed';else _0x27ba0d['status']==='PENDING'?_0x7ad39=_0x378548[_0x4ea101(0x13a)]||_0x4ea101(0x108):_0x7ad39=_0x378548['friendly_message']||_0x4ea101(0x136);const _0x15feaf={'success':_0x27ba0d['status']!==_0x4ea101(0x130),'status':_0x27ba0d[_0x4ea101(0x137)],'message':_0x7ad39,'payment':{'id':_0x5b829a,'status':_0x543dcb[_0x4ea101(0x137)],'gateway':'squirrelpay','last4':_0x27ba0d['cardLast4']}};_0x27ba0d[_0x4ea101(0x118)]&&(_0x15feaf['redirect_url']=_0x27ba0d['redirectUrl'],_0x15feaf[_0x4ea101(0xfb)]=!![],console[_0x4ea101(0x170)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x27ba0d['redirectUrl'])),_0x27ed4e[_0x4ea101(0x127)](_0x15feaf);}catch(_0x48dec1){console[_0x4ea101(0x14b)](_0x4ea101(0x176),_0x48dec1),_0x3a6ea7(_0x48dec1);}},this[_0x2e4864(0x16c)]=async(_0x1a5a3b,_0xeb2f9,_0x59dc6d)=>{const _0x1a2568=_0x2e4864;try{console[_0x1a2568(0x170)]('ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'),console[_0x1a2568(0x170)](_0x1a2568(0x16e),_0x1a5a3b['headers']),console[_0x1a2568(0x170)](_0x1a2568(0x13d),_0x1a5a3b[_0x1a2568(0x101)]),this[_0x1a2568(0x15a)][_0x1a2568(0x12a)]({'headers':_0x1a5a3b['headers'],'body':_0x1a5a3b[_0x1a2568(0x101)],'timestamp':new Date()[_0x1a2568(0x173)]()});const _0x584e71=_0x1a5a3b['body'];if(!_0x584e71[_0x1a2568(0x147)]||!_0x584e71[_0x1a2568(0x137)])return console[_0x1a2568(0x133)](_0x1a2568(0x171)),_0xeb2f9[_0x1a2568(0x137)](0x190)[_0x1a2568(0x127)]({'success':![],'message':_0x1a2568(0x150)});let _0x2516b1;_0x584e71['uid']&&(_0x2516b1=await database_1[_0x1a2568(0x140)]['payment'][_0x1a2568(0x131)]({'where':{'gatewayPaymentId':_0x584e71[_0x1a2568(0x147)],'gateway':'squirrelpay'}}));if(!_0x2516b1)return console[_0x1a2568(0x133)](_0x1a2568(0xfc)),console[_0x1a2568(0x133)](_0x1a2568(0x16f)+_0x584e71[_0x1a2568(0x147)]),console[_0x1a2568(0x133)](_0x1a2568(0x12f)+_0x584e71[_0x1a2568(0x106)]),console['warn']('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x1a2568(0x133)](_0x1a2568(0x10c)+_0x584e71[_0x1a2568(0x147)]),_0xeb2f9['status'](0x194)[_0x1a2568(0x127)]({'success':![],'message':_0x1a2568(0x132)});console['log'](_0x1a2568(0x169)+_0x2516b1['id']),console['log'](_0x1a2568(0x105)+_0x2516b1[_0x1a2568(0x137)]),console[_0x1a2568(0x170)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x2516b1['gatewayPaymentId']),console['log'](_0x1a2568(0x139)+_0x584e71[_0x1a2568(0x137)]),console[_0x1a2568(0x170)](_0x1a2568(0x16b)+_0x584e71[_0x1a2568(0x147)]);let _0x3814ee=null;const _0x197cb0={};_0x584e71[_0x1a2568(0x10f)]?.[_0x1a2568(0x104)]&&(_0x197cb0[_0x1a2568(0x179)]=_0x584e71[_0x1a2568(0x10f)][_0x1a2568(0x104)],console[_0x1a2568(0x170)](_0x1a2568(0xff)+_0x584e71[_0x1a2568(0x10f)][_0x1a2568(0x104)]));_0x584e71[_0x1a2568(0x10f)]?.[_0x1a2568(0x175)]&&(_0x197cb0['cardLast4']=_0x584e71[_0x1a2568(0x10f)][_0x1a2568(0x175)],console[_0x1a2568(0x170)](_0x1a2568(0x115)+_0x584e71[_0x1a2568(0x10f)][_0x1a2568(0x175)]));switch(_0x584e71[_0x1a2568(0x137)]){case _0x1a2568(0x102):_0x3814ee=_0x1a2568(0x168),console[_0x1a2568(0x170)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x1a2568(0x124):_0x3814ee=_0x1a2568(0x130),_0x197cb0[_0x1a2568(0x161)]=_0x584e71[_0x1a2568(0x13a)]||_0x584e71['message']||_0x1a2568(0x163),console[_0x1a2568(0x170)](_0x1a2568(0x157)+_0x197cb0[_0x1a2568(0x161)]);break;case'incomplete':console['log'](_0x1a2568(0x11c));break;default:console[_0x1a2568(0x133)](_0x1a2568(0x111)+_0x584e71[_0x1a2568(0x137)]);break;}if(_0x3814ee&&_0x3814ee!==_0x2516b1['status'])console['log'](_0x1a2568(0x12c)+_0x2516b1[_0x1a2568(0x137)]+_0x1a2568(0xfd)+_0x3814ee),await this[_0x1a2568(0x123)]['updatePaymentStatus'](_0x2516b1['id'],_0x3814ee,_0x197cb0),console[_0x1a2568(0x170)](_0x1a2568(0x15f)+_0x2516b1['id']+_0x1a2568(0x15c)+_0x3814ee+_0x1a2568(0x103));else _0x3814ee&&console[_0x1a2568(0x170)](_0x1a2568(0x13f)+_0x2516b1['id']+'\x20already\x20has\x20status\x20'+_0x3814ee+',\x20skipping\x20update');_0xeb2f9[_0x1a2568(0x137)](0xc8)[_0x1a2568(0x127)]({'success':!![],'message':_0x1a2568(0x122)});}catch(_0x341bf0){console[_0x1a2568(0x14b)]('âŒ\x20SquirrelPay\x20webhook\x20error:',_0x341bf0),_0x59dc6d(_0x341bf0);}},this[_0x2e4864(0x166)]=async(_0x38bb88,_0x12d65c,_0x24343c)=>{const _0x26ad02=_0x2e4864;try{const {limit:_0x71d373}=_0x38bb88['query'],_0x51e8fa=this[_0x26ad02(0x15a)]['getWebhookLogs'](_0x71d373?parseInt(_0x71d373):0x32);_0x12d65c[_0x26ad02(0x127)]({'success':!![],'result':{'logs':_0x51e8fa,'count':_0x51e8fa[_0x26ad02(0x11d)]}});}catch(_0x2a3d2c){_0x24343c(_0x2a3d2c);}},this['squirrelPayService']=new squirrelPayService_1[(_0x2e4864(0x146))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x2e4864(0x109),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE==='true'}),this[_0x2e4864(0x13c)]=new currencyService_1[(_0x2e4864(0x17a))](),this[_0x2e4864(0x123)]=new webhookService_1['WebhookService']();}}exports[a18_0x24bf31(0x152)]=SquirrelPayController;