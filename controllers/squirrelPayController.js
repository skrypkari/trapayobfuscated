'use strict';const a16_0x2ee189=a16_0x4d84;function a16_0x350a(){const _0xb124c2=['amountAfterGatewayCommissionUSDT','uid','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','SQUIRREL_PAY_SHOP_ID','1027456nygehX','âœ…\x20Payment\x20','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','findFirst','6934634nLKQck','FRONTEND_URL','35672qcrsZL','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','warn','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','Payment\x20failed','failed','\x20\x20\x20Payment\x20ID:\x20','PENDING','24LpOdzk','currencyService','\x20\x20\x20Customer:\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','gatewayPaymentId','gateway','../utils/ipHelper','WebhookService','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','CurrencyService','https://api.trapay.uk','default','handleWebhook','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','getGatewayCommission','processCardPayment','https://gate.squirrel-pay.com','API_BASE_URL','redirect_url','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','9rScQqV','\x20\x20\x20Description:\x20','defineProperty','getClientIP','status','SquirrelPayService','\x20\x20\x20Billing\x20Country:\x20','cardLast4','gatewayOrderId','updatePaymentStatus','63KsfVwH','711SvXYaT','query','&payment_id=','toISOString','toString','__esModule','Webhook\x20processed\x20successfully','toUpperCase','gatewayCommissionRate','toFixed','8484377ggViFU','\x20\x20\x20Gateway:\x20squirrelpay','redirectUrl','currency','SquirrelPayController','shopId','FAILED','padStart','not\x20provided','requires_action','/payment/pending?id=','description','https://app.trapay.uk','body','Payment\x20not\x20found','squirrelpay','\x20already\x20has\x20status\x20','561196dBjqMY','log','../services/currencyService','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','error',',\x20skipping\x20update','amount','ðŸ“\x20SquirrelPay\x20payment\x20details:','friendly_message','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','83180tfoqHE','replace','Payment\x20processed\x20successfully','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','\x20commission:\x20','env',',\x20balance\x20updated,\x20amountUSDT\x20calculated','json','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','round','5339545jxiOsq','6QJteIn','ðŸ’°\x20Gateway\x20','âŒ\x20SquirrelPay\x20webhook\x20error:','message','__importDefault','PAID','incomplete','\x20to\x20','\x20USDT','\x20\x20\x20Webhook\x20status:\x20','/api/webhooks/squirrel-pay','payment','../services/gateways/squirrelPayService','slice','../config/database','failureMessage','headers','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','webhookService','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','findUnique','\x20\x20\x20UID:\x20','squirrelPayService','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','length'];a16_0x350a=function(){return _0xb124c2;};return a16_0x350a();}(function(_0x5abe53,_0x2bf336){const _0x516388=a16_0x4d84,_0x10c3ab=_0x5abe53();while(!![]){try{const _0x285ec1=parseInt(_0x516388(0x1ab))/0x1*(parseInt(_0x516388(0x185))/0x2)+-parseInt(_0x516388(0x1a1))/0x3*(parseInt(_0x516388(0x1c7))/0x4)+parseInt(_0x516388(0x1db))/0x5+parseInt(_0x516388(0x1dc))/0x6*(parseInt(_0x516388(0x183))/0x7)+parseInt(_0x516388(0x17f))/0x8+-parseInt(_0x516388(0x1ac))/0x9*(parseInt(_0x516388(0x1d1))/0xa)+parseInt(_0x516388(0x1b6))/0xb*(-parseInt(_0x516388(0x18d))/0xc);if(_0x285ec1===_0x2bf336)break;else _0x10c3ab['push'](_0x10c3ab['shift']());}catch(_0x157456){_0x10c3ab['push'](_0x10c3ab['shift']());}}}(a16_0x350a,0xa8776));function a16_0x4d84(_0x5ec46d,_0x17f6bd){_0x5ec46d=_0x5ec46d-0x173;const _0x350ad8=a16_0x350a();let _0x4d847c=_0x350ad8[_0x5ec46d];return _0x4d847c;}var __importDefault=this&&this[a16_0x2ee189(0x1e0)]||function(_0x58aee3){const _0x21d594=a16_0x2ee189;return _0x58aee3&&_0x58aee3[_0x21d594(0x1b1)]?_0x58aee3:{'default':_0x58aee3};};Object[a16_0x2ee189(0x1a3)](exports,'__esModule',{'value':!![]}),exports[a16_0x2ee189(0x1ba)]=void 0x0;const squirrelPayService_1=require(a16_0x2ee189(0x1e8)),currencyService_1=require(a16_0x2ee189(0x1c9)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a16_0x2ee189(0x1ea))),ipHelper_1=require(a16_0x2ee189(0x193)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x14b068){const _0x32cc54=a16_0x2ee189;return ISO_COUNTRY_CODES['has'](_0x14b068[_0x32cc54(0x1b3)]());}class SquirrelPayController{constructor(){const _0x13a751=a16_0x2ee189;this[_0x13a751(0x19c)]=async(_0x248a83,_0x4f4723,_0x164800)=>{const _0x1d1188=_0x13a751;try{const {paymentId:_0x3b9e59}=_0x248a83['params'],{card_number:_0x54c116,exp_month:_0x171ca3,exp_year:_0x3cf1c6,cvv:_0x3260bf,holder_name:_0x17cf26,customer_email:_0x57dc52,customer_birth_date:_0x4bb221,billing_country:_0x75b73e,customer_phone:_0x1d16c5,billing_address:_0xf2e2e2,billing_city:_0x280b25,billing_state:_0x57c69b,billing_zip:_0x3e10b1}=_0x248a83[_0x1d1188(0x1c3)];console['log'](_0x1d1188(0x1ed)+_0x3b9e59);if(!_0x54c116||!_0x171ca3||!_0x3cf1c6||!_0x3260bf||!_0x17cf26||!_0x57dc52)return _0x4f4723['status'](0x190)['json']({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x75b73e&&!isValidCountryCode(_0x75b73e))return _0x4f4723[_0x1d1188(0x1a5)](0x190)[_0x1d1188(0x1d8)]({'success':![],'message':_0x1d1188(0x190)});const _0x2ab09e=await database_1[_0x1d1188(0x198)][_0x1d1188(0x1e7)][_0x1d1188(0x176)]({'where':{'id':_0x3b9e59},'include':{'shop':!![]}});if(!_0x2ab09e)return _0x4f4723[_0x1d1188(0x1a5)](0x194)[_0x1d1188(0x1d8)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2ab09e[_0x1d1188(0x1a5)]!==_0x1d1188(0x18c))return _0x4f4723[_0x1d1188(0x1a5)](0x190)[_0x1d1188(0x1d8)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x2a3e00=(0x0,ipHelper_1[_0x1d1188(0x1a4)])(_0x248a83),_0x42cf26={'number':_0x54c116[_0x1d1188(0x1d2)](/\s/g,''),'exp_month':_0x171ca3[_0x1d1188(0x1b0)]()[_0x1d1188(0x1bd)](0x2,'0'),'exp_year':_0x3cf1c6['toString'](),'verification_value':_0x3260bf,'holder':_0x17cf26['toUpperCase']()},_0x340711={'ip':_0x2a3e00,'email':_0x57dc52};_0x4bb221&&(_0x340711['birth_date']=_0x4bb221);let _0x908be4;_0x75b73e&&(_0x908be4={'country':_0x75b73e,'address':_0xf2e2e2,'city':_0x280b25,'state':_0x57c69b,'zip':_0x3e10b1});const _0x469175=(process[_0x1d1188(0x1d6)][_0x1d1188(0x184)]||_0x1d1188(0x1c2))+_0x1d1188(0x1c0)+_0x3b9e59+_0x1d1188(0x1ae)+(_0x2ab09e[_0x1d1188(0x1a9)]||_0x3b9e59),_0x55139a=(process[_0x1d1188(0x1d6)][_0x1d1188(0x19e)]||_0x1d1188(0x197))+_0x1d1188(0x1e6),_0x1d60d6=_0x3b9e59['slice'](0x0,0x8)+'-'+_0x3b9e59[_0x1d1188(0x1e9)](0x8,0x10);console['log'](_0x1d1188(0x1ce)),console[_0x1d1188(0x1c8)](_0x1d1188(0x18b)+_0x3b9e59),console['log']('\x20\x20\x20Amount:\x20'+_0x2ab09e[_0x1d1188(0x1cd)]+'\x20'+_0x2ab09e[_0x1d1188(0x1b9)]),console[_0x1d1188(0x1c8)](_0x1d1188(0x18f)+_0x57dc52+'\x20('+_0x2a3e00+')'),console[_0x1d1188(0x1c8)](_0x1d1188(0x1a7)+(_0x75b73e||_0x1d1188(0x1be))),console['log']('\x20\x20\x20Description:\x20'+_0x1d60d6);const _0x30dbf4=await this[_0x1d1188(0x178)][_0x1d1188(0x19c)](Math[_0x1d1188(0x1da)](_0x2ab09e[_0x1d1188(0x1cd)]*0x64),_0x2ab09e[_0x1d1188(0x1b9)],_0x1d60d6,_0x469175,_0x55139a,_0x42cf26,_0x340711,_0x908be4,_0x1d16c5),_0x4e9d22=this[_0x1d1188(0x178)]['getPaymentStatus'](_0x30dbf4),_0x367f91={'gatewayPaymentId':_0x30dbf4[_0x1d1188(0x17c)],'cardLast4':_0x4e9d22['cardLast4'],'gateway':_0x1d1188(0x1c5),'customerEmail':_0x57dc52,'customerPhone':_0x1d16c5,'customerBirthDate':_0x4bb221,'billingAddress':_0xf2e2e2,'billingCity':_0x280b25,'billingState':_0x57c69b,'billingZip':_0x3e10b1,'customerCountry':_0x75b73e};if(_0x4e9d22[_0x1d1188(0x1a5)]===_0x1d1188(0x1e1)){_0x367f91[_0x1d1188(0x1a5)]=_0x1d1188(0x1e1),_0x367f91['paidAt']=new Date();try{const _0x3154bd=await this['currencyService']['convertToUSDT'](_0x2ab09e[_0x1d1188(0x1cd)],_0x2ab09e[_0x1d1188(0x1b9)]);_0x367f91['amountUSDT']=_0x3154bd,console[_0x1d1188(0x1c8)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x3154bd+_0x1d1188(0x1e4));const _0x3eda21=await this[_0x1d1188(0x174)][_0x1d1188(0x19b)](_0x2ab09e[_0x1d1188(0x1bb)],_0x2ab09e[_0x1d1188(0x192)]),_0x477f04=_0x3154bd*(0x1-_0x3eda21/0x64);_0x367f91['amountAfterGatewayCommissionUSDT']=_0x477f04,_0x367f91[_0x1d1188(0x1b4)]=_0x3eda21,console['log'](_0x1d1188(0x1dd)+_0x2ab09e[_0x1d1188(0x192)]+_0x1d1188(0x1d5)+_0x3eda21+'%'),console[_0x1d1188(0x1c8)](_0x1d1188(0x1a0)+_0x477f04[_0x1d1188(0x1b5)](0x6)+_0x1d1188(0x1e4));}catch(_0x5ee645){console[_0x1d1188(0x1cb)](_0x1d1188(0x181),_0x5ee645),_0x367f91['amountUSDT']=0x0,_0x367f91[_0x1d1188(0x17b)]=0x0,_0x367f91[_0x1d1188(0x1b4)]=0x0;}}else _0x4e9d22[_0x1d1188(0x1a5)]==='FAILED'&&(_0x367f91[_0x1d1188(0x1a5)]=_0x1d1188(0x1bc),_0x367f91[_0x1d1188(0x1eb)]=_0x4e9d22[_0x1d1188(0x1eb)]);const _0x3178a1=await database_1[_0x1d1188(0x198)][_0x1d1188(0x1e7)]['update']({'where':{'id':_0x3b9e59},'data':_0x367f91});console[_0x1d1188(0x1c8)](_0x1d1188(0x1d0)+_0x3178a1['status']);let _0x4e9d7a;if(_0x4e9d22[_0x1d1188(0x1a5)]===_0x1d1188(0x1bc))_0x4e9d7a=_0x4e9d22[_0x1d1188(0x1eb)]||_0x30dbf4[_0x1d1188(0x1cf)]||'Payment\x20failed';else _0x4e9d22[_0x1d1188(0x1a5)]===_0x1d1188(0x18c)?_0x4e9d7a=_0x30dbf4[_0x1d1188(0x1cf)]||'Payment\x20is\x20being\x20processed':_0x4e9d7a=_0x30dbf4['friendly_message']||_0x1d1188(0x1d3);const _0x54abb9={'success':_0x4e9d22['status']!==_0x1d1188(0x1bc),'status':_0x4e9d22[_0x1d1188(0x1a5)],'message':_0x4e9d7a,'payment':{'id':_0x3b9e59,'status':_0x3178a1[_0x1d1188(0x1a5)],'gateway':_0x1d1188(0x1c5),'last4':_0x4e9d22[_0x1d1188(0x1a8)]}};_0x4e9d22[_0x1d1188(0x1b8)]&&(_0x54abb9[_0x1d1188(0x19f)]=_0x4e9d22['redirectUrl'],_0x54abb9[_0x1d1188(0x1bf)]=!![],console[_0x1d1188(0x1c8)](_0x1d1188(0x195)+_0x4e9d22[_0x1d1188(0x1b8)])),_0x4f4723[_0x1d1188(0x1d8)](_0x54abb9);}catch(_0x2aaaa1){console[_0x1d1188(0x1cb)]('âŒ\x20SquirrelPay\x20card\x20payment\x20error:',_0x2aaaa1),_0x164800(_0x2aaaa1);}},this[_0x13a751(0x199)]=async(_0x3cc7df,_0x880fa,_0x4800b3)=>{const _0x191651=_0x13a751;try{console[_0x191651(0x1c8)](_0x191651(0x188)),console[_0x191651(0x1c8)]('Headers:',_0x3cc7df[_0x191651(0x1ec)]),console[_0x191651(0x1c8)]('Body:',_0x3cc7df[_0x191651(0x1c3)]),this['squirrelPayService']['logWebhook']({'headers':_0x3cc7df[_0x191651(0x1ec)],'body':_0x3cc7df[_0x191651(0x1c3)],'timestamp':new Date()[_0x191651(0x1af)]()});const _0x219184=_0x3cc7df[_0x191651(0x1c3)];if(!_0x219184[_0x191651(0x17c)]||!_0x219184['status'])return console[_0x191651(0x187)]('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x880fa[_0x191651(0x1a5)](0x190)['json']({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x364c19;_0x219184['uid']&&(_0x364c19=await database_1['default'][_0x191651(0x1e7)][_0x191651(0x182)]({'where':{'gatewayPaymentId':_0x219184[_0x191651(0x17c)],'gateway':_0x191651(0x1c5)}}));if(!_0x364c19)return console[_0x191651(0x187)]('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console['warn'](_0x191651(0x177)+_0x219184[_0x191651(0x17c)]),console[_0x191651(0x187)](_0x191651(0x1a2)+_0x219184[_0x191651(0x1c1)]),console[_0x191651(0x187)](_0x191651(0x1b7)),console[_0x191651(0x187)](_0x191651(0x173)+_0x219184[_0x191651(0x17c)]),_0x880fa['status'](0x194)[_0x191651(0x1d8)]({'success':![],'message':_0x191651(0x1c4)});console[_0x191651(0x1c8)](_0x191651(0x1d4)+_0x364c19['id']),console[_0x191651(0x1c8)](_0x191651(0x179)+_0x364c19[_0x191651(0x1a5)]),console[_0x191651(0x1c8)](_0x191651(0x17d)+_0x364c19[_0x191651(0x191)]),console[_0x191651(0x1c8)](_0x191651(0x1e5)+_0x219184[_0x191651(0x1a5)]),console['log']('\x20\x20\x20Webhook\x20UID:\x20'+_0x219184[_0x191651(0x17c)]);let _0x821ae1=null;const _0x33902d={};switch(_0x219184[_0x191651(0x1a5)]){case'successful':_0x821ae1=_0x191651(0x1e1),console[_0x191651(0x1c8)](_0x191651(0x175));break;case _0x191651(0x18a):_0x821ae1=_0x191651(0x1bc),_0x33902d['failureMessage']=_0x219184['friendly_message']||_0x219184[_0x191651(0x1df)]||_0x191651(0x189),console[_0x191651(0x1c8)](_0x191651(0x1ca)+_0x33902d['failureMessage']);break;case _0x191651(0x1e2):console[_0x191651(0x1c8)](_0x191651(0x1d9));break;default:console['warn'](_0x191651(0x186)+_0x219184[_0x191651(0x1a5)]);break;}if(_0x821ae1&&_0x821ae1!==_0x364c19[_0x191651(0x1a5)])console[_0x191651(0x1c8)](_0x191651(0x19a)+_0x364c19[_0x191651(0x1a5)]+_0x191651(0x1e3)+_0x821ae1),await this[_0x191651(0x174)][_0x191651(0x1aa)](_0x364c19['id'],_0x821ae1,_0x33902d),console[_0x191651(0x1c8)](_0x191651(0x180)+_0x364c19['id']+'\x20updated:\x20status='+_0x821ae1+_0x191651(0x1d7));else _0x821ae1&&console[_0x191651(0x1c8)]('â„¹ï¸\x20Payment\x20'+_0x364c19['id']+_0x191651(0x1c6)+_0x821ae1+_0x191651(0x1cc));_0x880fa[_0x191651(0x1a5)](0xc8)[_0x191651(0x1d8)]({'success':!![],'message':_0x191651(0x1b2)});}catch(_0xb5e774){console[_0x191651(0x1cb)](_0x191651(0x1de),_0xb5e774),_0x4800b3(_0xb5e774);}},this['getWebhookLogs']=async(_0x24547d,_0x6fbe47,_0xb833f1)=>{const _0xf44b4c=_0x13a751;try{const {limit:_0xfbba1b}=_0x24547d[_0xf44b4c(0x1ad)],_0x322a3e=this[_0xf44b4c(0x178)]['getWebhookLogs'](_0xfbba1b?parseInt(_0xfbba1b):0x32);_0x6fbe47[_0xf44b4c(0x1d8)]({'success':!![],'result':{'logs':_0x322a3e,'count':_0x322a3e[_0xf44b4c(0x17a)]}});}catch(_0x358b1e){_0xb833f1(_0x358b1e);}},this[_0x13a751(0x178)]=new squirrelPayService_1[(_0x13a751(0x1a6))]({'shopId':process[_0x13a751(0x1d6)][_0x13a751(0x17e)]||'','secretKey':process['env']['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0x13a751(0x1d6)]['SQUIRREL_PAY_BASE_URL']||_0x13a751(0x19d),'isTestMode':process['env']['SQUIRREL_PAY_TEST_MODE']==='true'}),this[_0x13a751(0x18e)]=new currencyService_1[(_0x13a751(0x196))](),this[_0x13a751(0x174)]=new webhookService_1[(_0x13a751(0x194))]();}}exports[a16_0x2ee189(0x1ba)]=SquirrelPayController;