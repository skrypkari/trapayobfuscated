'use strict';const a19_0x421075=a19_0x20a8;function a19_0x4fc2(){const _0x3b475c=['warn','Body:','default','shopId','birth_date','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','gatewayOrderId','ðŸ“\x20SquirrelPay\x20payment\x20details:','Payment\x20failed','1184420ieHTgP','body','getPaymentStatus','true','friendly_message','phoneIsValid','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','currency','&payment_id=','Missing\x20required\x20fields\x20in\x20webhook','update','Missing\x20required\x20card\x20or\x20customer\x20information','\x20\x20\x20Description:\x20','../services/currencyService','payment_method','../config/database',',\x20balance\x20updated,\x20amountUSDT\x20calculated','brand','toUpperCase','failureMessage','\x20updated:\x20status=','phoneLineStatus','ðŸ’¾\x20Update\x20data\x20being\x20saved:','toString','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','âŒ\x20SquirrelPay\x20webhook\x20error:','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','Payment\x20processed\x20successfully','\x20\x20\x20Webhook\x20status:\x20','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','logWebhook','description','gateway','Webhook\x20processed\x20successfully','status','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','uid','https://api.trapay.uk','isVoip','ðŸ’°\x20Calculated\x20amountUSDT:\x20','PENDING','last_4','toISOString','FAILED','/api/webhooks/squirrel-pay','21694tqnWxY','SquirrelPayController','1184630IbzLtn','riskLevel','currencyService','payment','defineProperty',',\x20skipping\x20update','114252AbnFqQ','error','/payment/pending?id=','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','\x20\x20\x20Billing\x20Country:\x20','ðŸ’³\x20Card\x20brand\x20detected:\x20','cardLast4','44648QogEXm','cardBrand','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','successful','replace','â„¹ï¸\x20Payment\x20','122928cjCTyF','105966xYphSF','21CsmDMh','lineStatus','PAID','Headers:','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','redirect_url','redirectUrl','https://gate.squirrel-pay.com','squirrelPayService','amountUSDT','log','35xwaNJB','9ocNAJI','squirrelpay','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','slice','incomplete','ðŸ’°\x20Gateway\x20','isValid','\x20\x20\x20Webhook\x20UID:\x20','WebhookService','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','gatewayPaymentId','updatePaymentStatus','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','224OZFapY','length','getWebhookLogs','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','../services/gateways/squirrelPayService','round','\x20commission:\x20','processCardPayment','__importDefault','506LKZKcR','\x20USDT','phoneRiskLevel','amountAfterGatewayCommissionUSDT','headers','webhookService','\x20\x20\x20Amount:\x20','\x20\x20\x20UID:\x20','Payment\x20is\x20being\x20processed','json','findFirst','not\x20provided','gatewayCommissionRate','ðŸ’³\x20Card\x20last\x204:\x20','params','âœ…\x20Payment\x20','https://app.trapay.uk','\x20\x20\x20Customer:\x20','SquirrelPayService','convertToUSDT','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','Payment\x20not\x20found','amount','findUnique'];a19_0x4fc2=function(){return _0x3b475c;};return a19_0x4fc2();}(function(_0x25b9b1,_0x51a5f8){const _0x1058b9=a19_0x20a8,_0x4a276d=_0x25b9b1();while(!![]){try{const _0x543672=-parseInt(_0x1058b9(0x228))/0x1+-parseInt(_0x1058b9(0x220))/0x2*(parseInt(_0x1058b9(0x237))/0x3)+-parseInt(_0x1058b9(0x1f3))/0x4+-parseInt(_0x1058b9(0x1bb))/0x5*(-parseInt(_0x1058b9(0x236))/0x6)+-parseInt(_0x1058b9(0x1c9))/0x7*(-parseInt(_0x1058b9(0x22f))/0x8)+parseInt(_0x1058b9(0x1bc))/0x9*(-parseInt(_0x1058b9(0x222))/0xa)+-parseInt(_0x1058b9(0x1d2))/0xb*(-parseInt(_0x1058b9(0x235))/0xc);if(_0x543672===_0x51a5f8)break;else _0x4a276d['push'](_0x4a276d['shift']());}catch(_0x1288b1){_0x4a276d['push'](_0x4a276d['shift']());}}}(a19_0x4fc2,0x292f6));var __importDefault=this&&this[a19_0x421075(0x1d1)]||function(_0x2363f8){return _0x2363f8&&_0x2363f8['__esModule']?_0x2363f8:{'default':_0x2363f8};};Object[a19_0x421075(0x226)](exports,'__esModule',{'value':!![]}),exports[a19_0x421075(0x221)]=void 0x0;const squirrelPayService_1=require(a19_0x421075(0x1cd)),currencyService_1=require(a19_0x421075(0x200)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a19_0x421075(0x202))),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x169e50){return ISO_COUNTRY_CODES['has'](_0x169e50['toUpperCase']());}function a19_0x20a8(_0x5e144c,_0x3c4163){_0x5e144c=_0x5e144c-0x1b5;const _0x4fc210=a19_0x4fc2();let _0x20a846=_0x4fc210[_0x5e144c];return _0x20a846;}class SquirrelPayController{constructor(){const _0x87c623=a19_0x421075;this[_0x87c623(0x1d0)]=async(_0x55a6b4,_0x392b5e,_0x4ec6fe)=>{const _0x3dd423=_0x87c623;try{const {paymentId:_0x23a90c}=_0x55a6b4[_0x3dd423(0x1e0)],{card_number:_0x3cbe6c,exp_month:_0x4af6da,exp_year:_0xd461c,cvv:_0x163bf2,holder_name:_0x2f7675,customer_email:_0x2bc8bf,customer_birth_date:_0x36dd39,billing_country:_0x30318c,customer_phone:_0x1748fd,billing_address:_0x1da9c1,billing_city:_0x5d4237,billing_state:_0x515b74,billing_zip:_0x232237,phoneValidation:_0x62e75a}=_0x55a6b4[_0x3dd423(0x1f4)];console['log'](_0x3dd423(0x23b)+_0x23a90c),console[_0x3dd423(0x1ba)]('ðŸ“ž\x20Phone\x20validation\x20data:',_0x62e75a);if(!_0x3cbe6c||!_0x4af6da||!_0xd461c||!_0x163bf2||!_0x2f7675||!_0x2bc8bf)return _0x392b5e['status'](0x190)['json']({'success':![],'message':_0x3dd423(0x1fe)});if(_0x30318c&&!isValidCountryCode(_0x30318c))return _0x392b5e[_0x3dd423(0x215)](0x190)['json']({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x51dcac=await database_1[_0x3dd423(0x1ec)][_0x3dd423(0x225)][_0x3dd423(0x1e9)]({'where':{'id':_0x23a90c},'include':{'shop':!![]}});if(!_0x51dcac)return _0x392b5e['status'](0x194)[_0x3dd423(0x1db)]({'success':![],'message':_0x3dd423(0x1e7)});if(_0x51dcac[_0x3dd423(0x215)]!=='PENDING')return _0x392b5e[_0x3dd423(0x215)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x11896c=(0x0,ipHelper_1['getClientIP'])(_0x55a6b4),_0x3760d1={'number':_0x3cbe6c[_0x3dd423(0x233)](/\s/g,''),'exp_month':_0x4af6da[_0x3dd423(0x20a)]()['padStart'](0x2,'0'),'exp_year':_0xd461c[_0x3dd423(0x20a)](),'verification_value':_0x163bf2,'holder':_0x2f7675[_0x3dd423(0x205)]()},_0x1fdca7={'ip':_0x11896c,'email':_0x2bc8bf};_0x36dd39&&(_0x1fdca7[_0x3dd423(0x1ee)]=_0x36dd39);let _0x78a44e;_0x30318c&&(_0x78a44e={'country':_0x30318c,'address':_0x1da9c1,'city':_0x5d4237,'state':_0x515b74,'zip':_0x232237});const _0x4484de=(process.env.FRONTEND_URL||_0x3dd423(0x1e2))+_0x3dd423(0x22a)+_0x23a90c+_0x3dd423(0x1fb)+(_0x51dcac[_0x3dd423(0x1f0)]||_0x23a90c),_0x29abf5=(process.env.API_BASE_URL||_0x3dd423(0x218))+_0x3dd423(0x21f),_0x25b588=_0x23a90c[_0x3dd423(0x1bf)](0x0,0x8)+'-'+_0x23a90c[_0x3dd423(0x1bf)](0x8,0x10);console[_0x3dd423(0x1ba)](_0x3dd423(0x1f1)),console[_0x3dd423(0x1ba)]('\x20\x20\x20Payment\x20ID:\x20'+_0x23a90c),console[_0x3dd423(0x1ba)](_0x3dd423(0x1d8)+_0x51dcac[_0x3dd423(0x1e8)]+'\x20'+_0x51dcac[_0x3dd423(0x1fa)]),console[_0x3dd423(0x1ba)](_0x3dd423(0x1e3)+_0x2bc8bf+'\x20('+_0x11896c+')'),console['log'](_0x3dd423(0x22c)+(_0x30318c||_0x3dd423(0x1dd))),console[_0x3dd423(0x1ba)](_0x3dd423(0x1ff)+_0x25b588);const _0x54a53b=await this[_0x3dd423(0x1b8)]['processCardPayment'](Math[_0x3dd423(0x1ce)](_0x51dcac[_0x3dd423(0x1e8)]*0x64),_0x51dcac['currency'],_0x25b588,_0x4484de,_0x29abf5,_0x3760d1,_0x1fdca7,_0x78a44e,_0x1748fd),_0x1afc6f=this['squirrelPayService'][_0x3dd423(0x1f5)](_0x54a53b),_0x5d7fec={'gatewayPaymentId':_0x54a53b[_0x3dd423(0x217)],'cardLast4':_0x1afc6f[_0x3dd423(0x22e)],'gateway':_0x3dd423(0x1bd),'customerEmail':_0x2bc8bf,'customerPhone':_0x1748fd,'customerBirthDate':_0x36dd39,'billingAddress':_0x1da9c1,'billingCity':_0x5d4237,'billingState':_0x515b74,'billingZip':_0x232237,'customerCountry':_0x30318c,'phoneIsValid':_0x62e75a?.[_0x3dd423(0x1c2)],'phoneLineStatus':_0x62e75a?.[_0x3dd423(0x238)],'phoneIsVoip':_0x62e75a?.[_0x3dd423(0x219)],'phoneRiskLevel':_0x62e75a?.[_0x3dd423(0x223)]};console['log'](_0x3dd423(0x209),{'phoneIsValid':_0x5d7fec[_0x3dd423(0x1f8)],'phoneLineStatus':_0x5d7fec[_0x3dd423(0x208)],'phoneIsVoip':_0x5d7fec['phoneIsVoip'],'phoneRiskLevel':_0x5d7fec[_0x3dd423(0x1d4)]});if(_0x1afc6f[_0x3dd423(0x215)]==='PAID'){_0x5d7fec[_0x3dd423(0x215)]=_0x3dd423(0x239),_0x5d7fec['paidAt']=new Date();try{const _0x107033=await this[_0x3dd423(0x224)][_0x3dd423(0x1e5)](_0x51dcac[_0x3dd423(0x1e8)],_0x51dcac['currency']);_0x5d7fec[_0x3dd423(0x1b9)]=_0x107033,console['log'](_0x3dd423(0x21a)+_0x107033+_0x3dd423(0x1d3));const _0x2610eb=await this[_0x3dd423(0x1d7)]['getGatewayCommission'](_0x51dcac[_0x3dd423(0x1ed)],_0x51dcac['gateway']),_0x2985f7=_0x107033*(0x1-_0x2610eb/0x64);_0x5d7fec[_0x3dd423(0x1d5)]=_0x2985f7,_0x5d7fec['gatewayCommissionRate']=_0x2610eb,console['log'](_0x3dd423(0x1c1)+_0x51dcac[_0x3dd423(0x213)]+_0x3dd423(0x1cf)+_0x2610eb+'%'),console['log'](_0x3dd423(0x1cc)+_0x2985f7['toFixed'](0x6)+_0x3dd423(0x1d3));}catch(_0x1e347a){console['error'](_0x3dd423(0x1ef),_0x1e347a),_0x5d7fec[_0x3dd423(0x1b9)]=0x0,_0x5d7fec['amountAfterGatewayCommissionUSDT']=0x0,_0x5d7fec[_0x3dd423(0x1de)]=0x0;}}else _0x1afc6f[_0x3dd423(0x215)]===_0x3dd423(0x21e)&&(_0x5d7fec['status']=_0x3dd423(0x21e),_0x5d7fec[_0x3dd423(0x206)]=_0x1afc6f[_0x3dd423(0x206)]);const _0x5a9766=await database_1['default'][_0x3dd423(0x225)][_0x3dd423(0x1fd)]({'where':{'id':_0x23a90c},'data':_0x5d7fec});console[_0x3dd423(0x1ba)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x5a9766['status']);let _0x5342ee;if(_0x1afc6f['status']===_0x3dd423(0x21e))_0x5342ee=_0x1afc6f[_0x3dd423(0x206)]||_0x54a53b[_0x3dd423(0x1f7)]||_0x3dd423(0x1f2);else _0x1afc6f['status']===_0x3dd423(0x21b)?_0x5342ee=_0x54a53b[_0x3dd423(0x1f7)]||_0x3dd423(0x1da):_0x5342ee=_0x54a53b[_0x3dd423(0x1f7)]||_0x3dd423(0x20e);const _0x136e4d={'success':_0x1afc6f[_0x3dd423(0x215)]!=='FAILED','status':_0x1afc6f[_0x3dd423(0x215)],'message':_0x5342ee,'payment':{'id':_0x23a90c,'status':_0x5a9766[_0x3dd423(0x215)],'gateway':_0x3dd423(0x1bd),'last4':_0x1afc6f[_0x3dd423(0x22e)]}};_0x1afc6f['redirectUrl']&&(_0x136e4d[_0x3dd423(0x1b5)]=_0x1afc6f[_0x3dd423(0x1b6)],_0x136e4d['requires_action']=!![],console[_0x3dd423(0x1ba)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x1afc6f[_0x3dd423(0x1b6)])),_0x392b5e[_0x3dd423(0x1db)](_0x136e4d);}catch(_0x4f7fe3){console['error'](_0x3dd423(0x22b),_0x4f7fe3),_0x4ec6fe(_0x4f7fe3);}},this['handleWebhook']=async(_0xcf435f,_0x15212b,_0x2763da)=>{const _0x513d81=_0x87c623;try{console['log'](_0x513d81(0x1c5)),console[_0x513d81(0x1ba)](_0x513d81(0x23a),_0xcf435f[_0x513d81(0x1d6)]),console['log'](_0x513d81(0x1eb),_0xcf435f[_0x513d81(0x1f4)]),this[_0x513d81(0x1b8)][_0x513d81(0x211)]({'headers':_0xcf435f[_0x513d81(0x1d6)],'body':_0xcf435f['body'],'timestamp':new Date()[_0x513d81(0x21d)]()});const _0x3a5898=_0xcf435f[_0x513d81(0x1f4)];if(!_0x3a5898[_0x513d81(0x217)]||!_0x3a5898[_0x513d81(0x215)])return console[_0x513d81(0x1ea)](_0x513d81(0x1be)),_0x15212b[_0x513d81(0x215)](0x190)[_0x513d81(0x1db)]({'success':![],'message':_0x513d81(0x1fc)});let _0x1b2696;_0x3a5898['uid']&&(_0x1b2696=await database_1[_0x513d81(0x1ec)][_0x513d81(0x225)][_0x513d81(0x1dc)]({'where':{'gatewayPaymentId':_0x3a5898['uid'],'gateway':_0x513d81(0x1bd)}}));if(!_0x1b2696)return console['warn']('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x513d81(0x1ea)](_0x513d81(0x1d9)+_0x3a5898[_0x513d81(0x217)]),console['warn'](_0x513d81(0x1ff)+_0x3a5898[_0x513d81(0x212)]),console[_0x513d81(0x1ea)]('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x513d81(0x1ea)](_0x513d81(0x210)+_0x3a5898['uid']),_0x15212b[_0x513d81(0x215)](0x194)[_0x513d81(0x1db)]({'success':![],'message':_0x513d81(0x1e7)});console[_0x513d81(0x1ba)](_0x513d81(0x231)+_0x1b2696['id']),console[_0x513d81(0x1ba)](_0x513d81(0x1e6)+_0x1b2696[_0x513d81(0x215)]),console['log'](_0x513d81(0x20d)+_0x1b2696[_0x513d81(0x1c6)]),console['log'](_0x513d81(0x20f)+_0x3a5898[_0x513d81(0x215)]),console[_0x513d81(0x1ba)](_0x513d81(0x1c3)+_0x3a5898[_0x513d81(0x217)]);let _0x1f7255=null;const _0x311e53={};_0x3a5898[_0x513d81(0x201)]?.[_0x513d81(0x204)]&&(_0x311e53[_0x513d81(0x230)]=_0x3a5898['payment_method'][_0x513d81(0x204)],console[_0x513d81(0x1ba)](_0x513d81(0x22d)+_0x3a5898['payment_method'][_0x513d81(0x204)]));_0x3a5898['payment_method']?.[_0x513d81(0x21c)]&&(_0x311e53[_0x513d81(0x22e)]=_0x3a5898[_0x513d81(0x201)]['last_4'],console['log'](_0x513d81(0x1df)+_0x3a5898[_0x513d81(0x201)][_0x513d81(0x21c)]));switch(_0x3a5898[_0x513d81(0x215)]){case _0x513d81(0x232):_0x1f7255=_0x513d81(0x239),console[_0x513d81(0x1ba)](_0x513d81(0x20b));break;case'failed':_0x1f7255='FAILED',_0x311e53[_0x513d81(0x206)]=_0x3a5898[_0x513d81(0x1f7)]||_0x3a5898['message']||'Payment\x20failed',console['log']('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x311e53[_0x513d81(0x206)]);break;case _0x513d81(0x1c0):console[_0x513d81(0x1ba)](_0x513d81(0x1f9));break;default:console[_0x513d81(0x1ea)](_0x513d81(0x1c8)+_0x3a5898[_0x513d81(0x215)]);break;}if(_0x1f7255&&_0x1f7255!==_0x1b2696[_0x513d81(0x215)])console['log'](_0x513d81(0x216)+_0x1b2696[_0x513d81(0x215)]+'\x20to\x20'+_0x1f7255),await this[_0x513d81(0x1d7)][_0x513d81(0x1c7)](_0x1b2696['id'],_0x1f7255,_0x311e53),console[_0x513d81(0x1ba)](_0x513d81(0x1e1)+_0x1b2696['id']+_0x513d81(0x207)+_0x1f7255+_0x513d81(0x203));else _0x1f7255&&console[_0x513d81(0x1ba)](_0x513d81(0x234)+_0x1b2696['id']+'\x20already\x20has\x20status\x20'+_0x1f7255+_0x513d81(0x227));_0x15212b['status'](0xc8)[_0x513d81(0x1db)]({'success':!![],'message':_0x513d81(0x214)});}catch(_0x442efe){console[_0x513d81(0x229)](_0x513d81(0x20c),_0x442efe),_0x2763da(_0x442efe);}},this[_0x87c623(0x1cb)]=async(_0x389ab3,_0x8f8b63,_0x149714)=>{const _0x352ee9=_0x87c623;try{const {limit:_0x34b029}=_0x389ab3['query'],_0x323561=this[_0x352ee9(0x1b8)][_0x352ee9(0x1cb)](_0x34b029?parseInt(_0x34b029):0x32);_0x8f8b63[_0x352ee9(0x1db)]({'success':!![],'result':{'logs':_0x323561,'count':_0x323561[_0x352ee9(0x1ca)]}});}catch(_0x2dcd01){_0x149714(_0x2dcd01);}},this[_0x87c623(0x1b8)]=new squirrelPayService_1[(_0x87c623(0x1e4))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x87c623(0x1b7),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0x87c623(0x1f6)}),this['currencyService']=new currencyService_1['CurrencyService'](),this[_0x87c623(0x1d7)]=new webhookService_1[(_0x87c623(0x1c4))]();}}exports[a19_0x421075(0x221)]=SquirrelPayController;