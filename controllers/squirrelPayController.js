'use strict';const a17_0x3141ea=a17_0x4d70;(function(_0x587b95,_0x3fc476){const _0x27fa6a=a17_0x4d70,_0x4dc978=_0x587b95();while(!![]){try{const _0x23ab2d=-parseInt(_0x27fa6a(0x1cf))/0x1+-parseInt(_0x27fa6a(0x209))/0x2+-parseInt(_0x27fa6a(0x1d3))/0x3*(-parseInt(_0x27fa6a(0x218))/0x4)+-parseInt(_0x27fa6a(0x219))/0x5*(parseInt(_0x27fa6a(0x1d6))/0x6)+-parseInt(_0x27fa6a(0x1d7))/0x7*(parseInt(_0x27fa6a(0x208))/0x8)+parseInt(_0x27fa6a(0x1f5))/0x9*(-parseInt(_0x27fa6a(0x1cb))/0xa)+parseInt(_0x27fa6a(0x1eb))/0xb;if(_0x23ab2d===_0x3fc476)break;else _0x4dc978['push'](_0x4dc978['shift']());}catch(_0x1f3536){_0x4dc978['push'](_0x4dc978['shift']());}}}(a17_0x91e5,0x7fbed));function a17_0x91e5(){const _0x4a17d7=['117wRHAcC','defineProperty','payment_method','params','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','replace','https://gate.squirrel-pay.com','toFixed','https://app.trapay.uk','\x20\x20\x20Description:\x20','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','\x20\x20\x20Gateway:\x20squirrelpay','__importDefault','webhookService','FAILED','toString','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','1666360jhmAio','323760oSkWcP','cardLast4','failed','body','log','last_4','getWebhookLogs','\x20commission:\x20','\x20\x20\x20Amount:\x20','gatewayCommissionRate','status','has','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','squirrelPayService','true','1064848MsmntW','390YeBqHe','findFirst','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','/payment/pending?id=','\x20\x20\x20Webhook\x20UID:\x20','padStart','birth_date','brand','not\x20provided','ðŸ’³\x20Card\x20brand\x20detected:\x20','SquirrelPayController','logWebhook','payment','Headers:','Payment\x20is\x20being\x20processed','PAID','ðŸ’°\x20Calculated\x20amountUSDT:\x20','currency','\x20\x20\x20Billing\x20Country:\x20','\x20\x20\x20Webhook\x20status:\x20','../services/gateways/squirrelPayService','query','currencyService','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','https://api.trapay.uk','\x20USDT','\x20\x20\x20Customer:\x20','slice','squirrelpay','â„¹ï¸\x20Payment\x20','round','../utils/ipHelper','gatewayPaymentId','toUpperCase','message','amount','getGatewayCommission','getClientIP','convertToUSDT','requires_action','ðŸ’°\x20Gateway\x20','amountUSDT','âŒ\x20SquirrelPay\x20webhook\x20error:','442670fducdz','error',',\x20skipping\x20update','CurrencyService','178628UQkWMz','handleWebhook','default','shopId','6wrrbCP','Body:','headers','55788MgLAHw','21Tulwph','amountAfterGatewayCommissionUSDT','gateway','cardBrand','findUnique','warn','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','paidAt','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','Payment\x20processed\x20successfully','getPaymentStatus','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','Payment\x20not\x20found','Payment\x20failed','\x20updated:\x20status=','\x20to\x20','__esModule','friendly_message','Missing\x20required\x20card\x20or\x20customer\x20information','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','24826219DGWKpA','redirectUrl','uid','processCardPayment','redirect_url','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','json','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','âœ…\x20Payment\x20','failureMessage'];a17_0x91e5=function(){return _0x4a17d7;};return a17_0x91e5();}var __importDefault=this&&this[a17_0x3141ea(0x203)]||function(_0x16c353){return _0x16c353&&_0x16c353['__esModule']?_0x16c353:{'default':_0x16c353};};Object[a17_0x3141ea(0x1f6)](exports,a17_0x3141ea(0x1e7),{'value':!![]}),exports[a17_0x3141ea(0x223)]=void 0x0;const squirrelPayService_1=require(a17_0x3141ea(0x22d)),currencyService_1=require('../services/currencyService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a17_0x3141ea(0x1bf)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a17_0x4d70(_0x3d9c75,_0x1b5648){_0x3d9c75=_0x3d9c75-0x1b7;const _0x91e5be=a17_0x91e5();let _0x4d70b0=_0x91e5be[_0x3d9c75];return _0x4d70b0;}function isValidCountryCode(_0x58757c){const _0x170413=a17_0x3141ea;return ISO_COUNTRY_CODES[_0x170413(0x214)](_0x58757c[_0x170413(0x1c1)]());}class SquirrelPayController{constructor(){const _0xca61f7=a17_0x3141ea;this[_0xca61f7(0x1ee)]=async(_0x234733,_0x448188,_0x333c1f)=>{const _0x3fec68=_0xca61f7;try{const {paymentId:_0x4bec0b}=_0x234733[_0x3fec68(0x1f8)],{card_number:_0x168f7e,exp_month:_0x1dbf84,exp_year:_0x5063c6,cvv:_0x20a8ca,holder_name:_0x566ed1,customer_email:_0x21d5fc,customer_birth_date:_0x2a7b32,billing_country:_0x1fe0c8,customer_phone:_0x43eee2,billing_address:_0x21977e,billing_city:_0x1c88a0,billing_state:_0x2b93af,billing_zip:_0x4088ea}=_0x234733[_0x3fec68(0x20c)];console[_0x3fec68(0x20d)](_0x3fec68(0x1fa)+_0x4bec0b);if(!_0x168f7e||!_0x1dbf84||!_0x5063c6||!_0x20a8ca||!_0x566ed1||!_0x21d5fc)return _0x448188['status'](0x190)[_0x3fec68(0x1f1)]({'success':![],'message':_0x3fec68(0x1e9)});if(_0x1fe0c8&&!isValidCountryCode(_0x1fe0c8))return _0x448188['status'](0x190)[_0x3fec68(0x1f1)]({'success':![],'message':_0x3fec68(0x1df)});const _0x568470=await database_1[_0x3fec68(0x1d1)][_0x3fec68(0x225)][_0x3fec68(0x1db)]({'where':{'id':_0x4bec0b},'include':{'shop':!![]}});if(!_0x568470)return _0x448188['status'](0x194)[_0x3fec68(0x1f1)]({'success':![],'message':_0x3fec68(0x1e3)});if(_0x568470[_0x3fec68(0x213)]!=='PENDING')return _0x448188[_0x3fec68(0x213)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x57b0e0=(0x0,ipHelper_1[_0x3fec68(0x1c5)])(_0x234733),_0x1cab64={'number':_0x168f7e[_0x3fec68(0x1fc)](/\s/g,''),'exp_month':_0x1dbf84[_0x3fec68(0x206)]()[_0x3fec68(0x21e)](0x2,'0'),'exp_year':_0x5063c6[_0x3fec68(0x206)](),'verification_value':_0x20a8ca,'holder':_0x566ed1[_0x3fec68(0x1c1)]()},_0x2c9ade={'ip':_0x57b0e0,'email':_0x21d5fc};_0x2a7b32&&(_0x2c9ade[_0x3fec68(0x21f)]=_0x2a7b32);let _0x464d0f;_0x1fe0c8&&(_0x464d0f={'country':_0x1fe0c8,'address':_0x21977e,'city':_0x1c88a0,'state':_0x2b93af,'zip':_0x4088ea});const _0x37eb10=(process.env.FRONTEND_URL||_0x3fec68(0x1ff))+_0x3fec68(0x21c)+_0x4bec0b+'&payment_id='+(_0x568470['gatewayOrderId']||_0x4bec0b),_0x137993=(process.env.API_BASE_URL||_0x3fec68(0x1b8))+'/api/webhooks/squirrel-pay',_0x53269d=_0x4bec0b['slice'](0x0,0x8)+'-'+_0x4bec0b[_0x3fec68(0x1bb)](0x8,0x10);console[_0x3fec68(0x20d)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console[_0x3fec68(0x20d)]('\x20\x20\x20Payment\x20ID:\x20'+_0x4bec0b),console[_0x3fec68(0x20d)](_0x3fec68(0x211)+_0x568470['amount']+'\x20'+_0x568470[_0x3fec68(0x22a)]),console[_0x3fec68(0x20d)](_0x3fec68(0x1ba)+_0x21d5fc+'\x20('+_0x57b0e0+')'),console[_0x3fec68(0x20d)](_0x3fec68(0x22b)+(_0x1fe0c8||_0x3fec68(0x221))),console[_0x3fec68(0x20d)](_0x3fec68(0x200)+_0x53269d);const _0x8d4008=await this[_0x3fec68(0x216)][_0x3fec68(0x1ee)](Math[_0x3fec68(0x1be)](_0x568470[_0x3fec68(0x1c3)]*0x64),_0x568470['currency'],_0x53269d,_0x37eb10,_0x137993,_0x1cab64,_0x2c9ade,_0x464d0f,_0x43eee2),_0x44694a=this[_0x3fec68(0x216)][_0x3fec68(0x1e1)](_0x8d4008),_0x44b712={'gatewayPaymentId':_0x8d4008['uid'],'cardLast4':_0x44694a[_0x3fec68(0x20a)],'gateway':_0x3fec68(0x1bc),'customerEmail':_0x21d5fc,'customerPhone':_0x43eee2,'customerBirthDate':_0x2a7b32,'billingAddress':_0x21977e,'billingCity':_0x1c88a0,'billingState':_0x2b93af,'billingZip':_0x4088ea,'customerCountry':_0x1fe0c8};if(_0x44694a[_0x3fec68(0x213)]===_0x3fec68(0x228)){_0x44b712[_0x3fec68(0x213)]=_0x3fec68(0x228),_0x44b712[_0x3fec68(0x1de)]=new Date();try{const _0x3f1a08=await this[_0x3fec68(0x22f)][_0x3fec68(0x1c6)](_0x568470[_0x3fec68(0x1c3)],_0x568470[_0x3fec68(0x22a)]);_0x44b712[_0x3fec68(0x1c9)]=_0x3f1a08,console[_0x3fec68(0x20d)](_0x3fec68(0x229)+_0x3f1a08+_0x3fec68(0x1b9));const _0x108b24=await this['webhookService'][_0x3fec68(0x1c4)](_0x568470[_0x3fec68(0x1d2)],_0x568470[_0x3fec68(0x1d9)]),_0x5b347b=_0x3f1a08*(0x1-_0x108b24/0x64);_0x44b712[_0x3fec68(0x1d8)]=_0x5b347b,_0x44b712[_0x3fec68(0x212)]=_0x108b24,console[_0x3fec68(0x20d)](_0x3fec68(0x1c8)+_0x568470['gateway']+_0x3fec68(0x210)+_0x108b24+'%'),console[_0x3fec68(0x20d)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x5b347b[_0x3fec68(0x1fe)](0x6)+_0x3fec68(0x1b9));}catch(_0x55d2ee){console[_0x3fec68(0x1cc)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x55d2ee),_0x44b712['amountUSDT']=0x0,_0x44b712[_0x3fec68(0x1d8)]=0x0,_0x44b712[_0x3fec68(0x212)]=0x0;}}else _0x44694a[_0x3fec68(0x213)]===_0x3fec68(0x205)&&(_0x44b712[_0x3fec68(0x213)]=_0x3fec68(0x205),_0x44b712[_0x3fec68(0x1f4)]=_0x44694a[_0x3fec68(0x1f4)]);const _0x260214=await database_1['default'][_0x3fec68(0x225)]['update']({'where':{'id':_0x4bec0b},'data':_0x44b712});console[_0x3fec68(0x20d)](_0x3fec68(0x1f0)+_0x260214[_0x3fec68(0x213)]);let _0x26e718;if(_0x44694a[_0x3fec68(0x213)]==='FAILED')_0x26e718=_0x44694a[_0x3fec68(0x1f4)]||_0x8d4008['friendly_message']||'Payment\x20failed';else _0x44694a['status']==='PENDING'?_0x26e718=_0x8d4008[_0x3fec68(0x1e8)]||_0x3fec68(0x227):_0x26e718=_0x8d4008['friendly_message']||_0x3fec68(0x1e0);const _0x4eb6f0={'success':_0x44694a[_0x3fec68(0x213)]!=='FAILED','status':_0x44694a['status'],'message':_0x26e718,'payment':{'id':_0x4bec0b,'status':_0x260214[_0x3fec68(0x213)],'gateway':'squirrelpay','last4':_0x44694a[_0x3fec68(0x20a)]}};_0x44694a[_0x3fec68(0x1ec)]&&(_0x4eb6f0[_0x3fec68(0x1ef)]=_0x44694a[_0x3fec68(0x1ec)],_0x4eb6f0[_0x3fec68(0x1c7)]=!![],console[_0x3fec68(0x20d)](_0x3fec68(0x215)+_0x44694a[_0x3fec68(0x1ec)])),_0x448188['json'](_0x4eb6f0);}catch(_0x4803cc){console[_0x3fec68(0x1cc)](_0x3fec68(0x1e2),_0x4803cc),_0x333c1f(_0x4803cc);}},this[_0xca61f7(0x1d0)]=async(_0x453803,_0x4f8d41,_0x41bb37)=>{const _0x369dc0=_0xca61f7;try{console['log'](_0x369dc0(0x1ea)),console[_0x369dc0(0x20d)](_0x369dc0(0x226),_0x453803[_0x369dc0(0x1d5)]),console[_0x369dc0(0x20d)](_0x369dc0(0x1d4),_0x453803['body']),this[_0x369dc0(0x216)][_0x369dc0(0x224)]({'headers':_0x453803[_0x369dc0(0x1d5)],'body':_0x453803[_0x369dc0(0x20c)],'timestamp':new Date()['toISOString']()});const _0x47d1c1=_0x453803[_0x369dc0(0x20c)];if(!_0x47d1c1[_0x369dc0(0x1ed)]||!_0x47d1c1[_0x369dc0(0x213)])return console['warn']('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x4f8d41[_0x369dc0(0x213)](0x190)['json']({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x372590;_0x47d1c1[_0x369dc0(0x1ed)]&&(_0x372590=await database_1[_0x369dc0(0x1d1)][_0x369dc0(0x225)][_0x369dc0(0x21a)]({'where':{'gatewayPaymentId':_0x47d1c1['uid'],'gateway':'squirrelpay'}}));if(!_0x372590)return console['warn'](_0x369dc0(0x1fb)),console['warn']('\x20\x20\x20UID:\x20'+_0x47d1c1['uid']),console[_0x369dc0(0x1dc)](_0x369dc0(0x200)+_0x47d1c1['description']),console[_0x369dc0(0x1dc)](_0x369dc0(0x202)),console[_0x369dc0(0x1dc)](_0x369dc0(0x207)+_0x47d1c1[_0x369dc0(0x1ed)]),_0x4f8d41[_0x369dc0(0x213)](0x194)[_0x369dc0(0x1f1)]({'success':![],'message':_0x369dc0(0x1e3)});console[_0x369dc0(0x20d)](_0x369dc0(0x1f9)+_0x372590['id']),console['log']('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x372590[_0x369dc0(0x213)]),console[_0x369dc0(0x20d)](_0x369dc0(0x201)+_0x372590[_0x369dc0(0x1c0)]),console[_0x369dc0(0x20d)](_0x369dc0(0x22c)+_0x47d1c1[_0x369dc0(0x213)]),console[_0x369dc0(0x20d)](_0x369dc0(0x21d)+_0x47d1c1[_0x369dc0(0x1ed)]);let _0x2237e0=null;const _0x4df7d8={};_0x47d1c1[_0x369dc0(0x1f7)]?.[_0x369dc0(0x220)]&&(_0x4df7d8[_0x369dc0(0x1da)]=_0x47d1c1[_0x369dc0(0x1f7)][_0x369dc0(0x220)],console[_0x369dc0(0x20d)](_0x369dc0(0x222)+_0x47d1c1[_0x369dc0(0x1f7)][_0x369dc0(0x220)]));_0x47d1c1[_0x369dc0(0x1f7)]?.[_0x369dc0(0x20e)]&&(_0x4df7d8[_0x369dc0(0x20a)]=_0x47d1c1['payment_method'][_0x369dc0(0x20e)],console[_0x369dc0(0x20d)]('ðŸ’³\x20Card\x20last\x204:\x20'+_0x47d1c1['payment_method'][_0x369dc0(0x20e)]));switch(_0x47d1c1[_0x369dc0(0x213)]){case'successful':_0x2237e0='PAID',console[_0x369dc0(0x20d)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x369dc0(0x20b):_0x2237e0='FAILED',_0x4df7d8[_0x369dc0(0x1f4)]=_0x47d1c1[_0x369dc0(0x1e8)]||_0x47d1c1[_0x369dc0(0x1c2)]||_0x369dc0(0x1e4),console[_0x369dc0(0x20d)](_0x369dc0(0x1b7)+_0x4df7d8[_0x369dc0(0x1f4)]);break;case'incomplete':console['log'](_0x369dc0(0x1f2));break;default:console[_0x369dc0(0x1dc)](_0x369dc0(0x1dd)+_0x47d1c1[_0x369dc0(0x213)]);break;}if(_0x2237e0&&_0x2237e0!==_0x372590[_0x369dc0(0x213)])console[_0x369dc0(0x20d)](_0x369dc0(0x21b)+_0x372590['status']+_0x369dc0(0x1e6)+_0x2237e0),await this[_0x369dc0(0x204)]['updatePaymentStatus'](_0x372590['id'],_0x2237e0,_0x4df7d8),console[_0x369dc0(0x20d)](_0x369dc0(0x1f3)+_0x372590['id']+_0x369dc0(0x1e5)+_0x2237e0+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x2237e0&&console[_0x369dc0(0x20d)](_0x369dc0(0x1bd)+_0x372590['id']+'\x20already\x20has\x20status\x20'+_0x2237e0+_0x369dc0(0x1cd));_0x4f8d41[_0x369dc0(0x213)](0xc8)[_0x369dc0(0x1f1)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x4c2274){console[_0x369dc0(0x1cc)](_0x369dc0(0x1ca),_0x4c2274),_0x41bb37(_0x4c2274);}},this[_0xca61f7(0x20f)]=async(_0x1d610c,_0xe0f34f,_0x26f64d)=>{const _0x90d335=_0xca61f7;try{const {limit:_0x37598e}=_0x1d610c[_0x90d335(0x22e)],_0x4dfecb=this[_0x90d335(0x216)][_0x90d335(0x20f)](_0x37598e?parseInt(_0x37598e):0x32);_0xe0f34f['json']({'success':!![],'result':{'logs':_0x4dfecb,'count':_0x4dfecb['length']}});}catch(_0xc6bcee){_0x26f64d(_0xc6bcee);}},this[_0xca61f7(0x216)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0xca61f7(0x1fd),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0xca61f7(0x217)}),this[_0xca61f7(0x22f)]=new currencyService_1[(_0xca61f7(0x1ce))](),this[_0xca61f7(0x204)]=new webhookService_1['WebhookService']();}}exports['SquirrelPayController']=SquirrelPayController;