'use strict';const a17_0x4386ae=a17_0x2f55;(function(_0x25996d,_0x1994ce){const _0x22c36b=a17_0x2f55,_0x679926=_0x25996d();while(!![]){try{const _0x175948=parseInt(_0x22c36b(0x93))/0x1*(parseInt(_0x22c36b(0x9f))/0x2)+-parseInt(_0x22c36b(0x91))/0x3+-parseInt(_0x22c36b(0xac))/0x4*(parseInt(_0x22c36b(0xaf))/0x5)+parseInt(_0x22c36b(0xcf))/0x6+-parseInt(_0x22c36b(0xd0))/0x7*(-parseInt(_0x22c36b(0xd8))/0x8)+-parseInt(_0x22c36b(0x8e))/0x9+parseInt(_0x22c36b(0xd1))/0xa;if(_0x175948===_0x1994ce)break;else _0x679926['push'](_0x679926['shift']());}catch(_0xb49433){_0x679926['push'](_0x679926['shift']());}}}(a17_0x321b,0x55cb4));function a17_0x2f55(_0x430814,_0x1f2311){_0x430814=_0x430814-0x6e;const _0x321b75=a17_0x321b();let _0x2f554f=_0x321b75[_0x430814];return _0x2f554f;}var __importDefault=this&&this[a17_0x4386ae(0xe5)]||function(_0x5e271d){const _0x413d91=a17_0x4386ae;return _0x5e271d&&_0x5e271d[_0x413d91(0xa2)]?_0x5e271d:{'default':_0x5e271d};};Object[a17_0x4386ae(0xdb)](exports,a17_0x4386ae(0xa2),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a17_0x4386ae(0xb1)),currencyService_1=require(a17_0x4386ae(0xd2)),webhookService_1=require(a17_0x4386ae(0xbc)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a17_0x4386ae(0xc9)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a17_0x321b(){const _0x223b11=['padStart','Payment\x20processed\x20successfully','\x20\x20\x20Webhook\x20UID:\x20','currency','toISOString','Payment\x20is\x20not\x20in\x20pending\x20status','../services/webhookService','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','processCardPayment','payment','failureMessage','true','getWebhookLogs','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','body','failed','âŒ\x20SquirrelPay\x20webhook\x20error:','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','../utils/ipHelper','replace','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','warn','Headers:','webhookService','254442RyDLNX','392UseNux','7936870wdTPVR','../services/currencyService','error','slice','SquirrelPayController',',\x20skipping\x20update','query','38072vJDuWH','\x20\x20\x20Customer:\x20','friendly_message','defineProperty','convertToUSDT','amountAfterGatewayCommissionUSDT','gatewayPaymentId','redirect_url','amountUSDT','ðŸ’³\x20Card\x20last\x204:\x20','WebhookService','squirrelPayService','â„¹ï¸\x20Payment\x20','__importDefault','has','update','length','Missing\x20required\x20fields\x20in\x20webhook','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','status','PAID','getGatewayCommission','\x20\x20\x20Webhook\x20status:\x20','shopId','last_4','https://app.trapay.uk','Payment\x20failed','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','ðŸ’°\x20Calculated\x20amountUSDT:\x20','log','âœ…\x20Payment\x20','\x20already\x20has\x20status\x20','ðŸ’³\x20Card\x20brand\x20detected:\x20','Webhook\x20processed\x20successfully','json',',\x20balance\x20updated,\x20amountUSDT\x20calculated','/api/webhooks/squirrel-pay','paidAt','params','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','SquirrelPayService','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','successful','\x20\x20\x20Description:\x20','Body:','redirectUrl','headers','\x20\x20\x20Payment\x20ID:\x20','getClientIP','message','gatewayCommissionRate','1769238zHiXcI','uid','default','1845480BZXZsU','brand','5YwZBPx','findUnique','description','PENDING','logWebhook','\x20\x20\x20UID:\x20','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','Payment\x20is\x20being\x20processed','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','toString','squirrelpay','findFirst','269528Kyorwl','/payment/pending?id=','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','__esModule','cardLast4','birth_date','payment_method','toUpperCase','FAILED','updatePaymentStatus','gatewayOrderId','cardBrand','Payment\x20not\x20found','2453056VUemOd','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','amount','5dlrwHI','currencyService','../services/gateways/squirrelPayService','gateway','\x20USDT','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Current\x20status\x20in\x20DB:\x20'];a17_0x321b=function(){return _0x223b11;};return a17_0x321b();}function isValidCountryCode(_0x454356){const _0x3b1f76=a17_0x4386ae;return ISO_COUNTRY_CODES[_0x3b1f76(0xe6)](_0x454356[_0x3b1f76(0xa6)]());}class SquirrelPayController{constructor(){const _0xe144c4=a17_0x4386ae;this[_0xe144c4(0xbf)]=async(_0x3f419b,_0x1cba66,_0x73b89d)=>{const _0x554fd5=_0xe144c4;try{const {paymentId:_0x233f26}=_0x3f419b[_0x554fd5(0x81)],{card_number:_0x4e079f,exp_month:_0x52adcf,exp_year:_0x2ef7eb,cvv:_0x5ae052,holder_name:_0x2ca0dd,customer_email:_0xcc18e7,customer_birth_date:_0x2ed6d9,billing_country:_0x4485e5,customer_phone:_0x2365d1,billing_address:_0x3cefd7,billing_city:_0x58810b,billing_state:_0x18c4d1,billing_zip:_0x5a6582}=_0x3f419b[_0x554fd5(0xc5)];console['log']('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x233f26);if(!_0x4e079f||!_0x52adcf||!_0x2ef7eb||!_0x5ae052||!_0x2ca0dd||!_0xcc18e7)return _0x1cba66[_0x554fd5(0x6e)](0x190)[_0x554fd5(0x7d)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x4485e5&&!isValidCountryCode(_0x4485e5))return _0x1cba66['status'](0x190)[_0x554fd5(0x7d)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x56ea83=await database_1[_0x554fd5(0x90)][_0x554fd5(0xc0)][_0x554fd5(0x94)]({'where':{'id':_0x233f26},'include':{'shop':!![]}});if(!_0x56ea83)return _0x1cba66[_0x554fd5(0x6e)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x56ea83[_0x554fd5(0x6e)]!==_0x554fd5(0x96))return _0x1cba66[_0x554fd5(0x6e)](0x190)['json']({'success':![],'message':_0x554fd5(0xbb)});const _0x524677=(0x0,ipHelper_1[_0x554fd5(0x8b)])(_0x3f419b),_0x4c460b={'number':_0x4e079f[_0x554fd5(0xca)](/\s/g,''),'exp_month':_0x52adcf[_0x554fd5(0x9c)]()[_0x554fd5(0xb6)](0x2,'0'),'exp_year':_0x2ef7eb['toString'](),'verification_value':_0x5ae052,'holder':_0x2ca0dd[_0x554fd5(0xa6)]()},_0x9cc746={'ip':_0x524677,'email':_0xcc18e7};_0x2ed6d9&&(_0x9cc746[_0x554fd5(0xa4)]=_0x2ed6d9);let _0x2fe72b;_0x4485e5&&(_0x2fe72b={'country':_0x4485e5,'address':_0x3cefd7,'city':_0x58810b,'state':_0x18c4d1,'zip':_0x5a6582});const _0x7d6a0a=(process.env.FRONTEND_URL||_0x554fd5(0x74))+_0x554fd5(0xa0)+_0x233f26+'&payment_id='+(_0x56ea83[_0x554fd5(0xa9)]||_0x233f26),_0x5f4e81=(process.env.API_BASE_URL||'https://api.trapay.uk')+_0x554fd5(0x7f),_0x253655=_0x233f26[_0x554fd5(0xd4)](0x0,0x8)+'-'+_0x233f26[_0x554fd5(0xd4)](0x8,0x10);console[_0x554fd5(0x78)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console['log'](_0x554fd5(0x8a)+_0x233f26),console[_0x554fd5(0x78)]('\x20\x20\x20Amount:\x20'+_0x56ea83[_0x554fd5(0xae)]+'\x20'+_0x56ea83[_0x554fd5(0xb9)]),console[_0x554fd5(0x78)](_0x554fd5(0xd9)+_0xcc18e7+'\x20('+_0x524677+')'),console[_0x554fd5(0x78)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x4485e5||'not\x20provided')),console[_0x554fd5(0x78)](_0x554fd5(0x86)+_0x253655);const _0x228c57=await this[_0x554fd5(0xe3)][_0x554fd5(0xbf)](Math['round'](_0x56ea83[_0x554fd5(0xae)]*0x64),_0x56ea83[_0x554fd5(0xb9)],_0x253655,_0x7d6a0a,_0x5f4e81,_0x4c460b,_0x9cc746,_0x2fe72b,_0x2365d1),_0x1b46ff=this[_0x554fd5(0xe3)]['getPaymentStatus'](_0x228c57),_0xc7caf9={'gatewayPaymentId':_0x228c57[_0x554fd5(0x8f)],'cardLast4':_0x1b46ff[_0x554fd5(0xa3)],'gateway':_0x554fd5(0x9d),'customerEmail':_0xcc18e7,'customerPhone':_0x2365d1,'customerBirthDate':_0x2ed6d9,'billingAddress':_0x3cefd7,'billingCity':_0x58810b,'billingState':_0x18c4d1,'billingZip':_0x5a6582,'customerCountry':_0x4485e5};if(_0x1b46ff['status']===_0x554fd5(0x6f)){_0xc7caf9[_0x554fd5(0x6e)]=_0x554fd5(0x6f),_0xc7caf9[_0x554fd5(0x80)]=new Date();try{const _0x54b96c=await this[_0x554fd5(0xb0)][_0x554fd5(0xdc)](_0x56ea83[_0x554fd5(0xae)],_0x56ea83[_0x554fd5(0xb9)]);_0xc7caf9['amountUSDT']=_0x54b96c,console[_0x554fd5(0x78)](_0x554fd5(0x77)+_0x54b96c+_0x554fd5(0xb3));const _0x5d8b91=await this['webhookService'][_0x554fd5(0x70)](_0x56ea83[_0x554fd5(0x72)],_0x56ea83['gateway']),_0x56746=_0x54b96c*(0x1-_0x5d8b91/0x64);_0xc7caf9[_0x554fd5(0xdd)]=_0x56746,_0xc7caf9[_0x554fd5(0x8d)]=_0x5d8b91,console[_0x554fd5(0x78)]('ðŸ’°\x20Gateway\x20'+_0x56ea83[_0x554fd5(0xb2)]+'\x20commission:\x20'+_0x5d8b91+'%'),console[_0x554fd5(0x78)](_0x554fd5(0xcb)+_0x56746['toFixed'](0x6)+_0x554fd5(0xb3));}catch(_0x11593a){console[_0x554fd5(0xd3)](_0x554fd5(0x84),_0x11593a),_0xc7caf9[_0x554fd5(0xe0)]=0x0,_0xc7caf9[_0x554fd5(0xdd)]=0x0,_0xc7caf9['gatewayCommissionRate']=0x0;}}else _0x1b46ff[_0x554fd5(0x6e)]==='FAILED'&&(_0xc7caf9[_0x554fd5(0x6e)]=_0x554fd5(0xa7),_0xc7caf9[_0x554fd5(0xc1)]=_0x1b46ff['failureMessage']);const _0x4bafd9=await database_1['default']['payment'][_0x554fd5(0xe7)]({'where':{'id':_0x233f26},'data':_0xc7caf9});console[_0x554fd5(0x78)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x4bafd9[_0x554fd5(0x6e)]);let _0x39d730;if(_0x1b46ff[_0x554fd5(0x6e)]===_0x554fd5(0xa7))_0x39d730=_0x1b46ff[_0x554fd5(0xc1)]||_0x228c57[_0x554fd5(0xda)]||'Payment\x20failed';else _0x1b46ff[_0x554fd5(0x6e)]===_0x554fd5(0x96)?_0x39d730=_0x228c57[_0x554fd5(0xda)]||_0x554fd5(0x9a):_0x39d730=_0x228c57['friendly_message']||_0x554fd5(0xb7);const _0x327ed8={'success':_0x1b46ff[_0x554fd5(0x6e)]!==_0x554fd5(0xa7),'status':_0x1b46ff[_0x554fd5(0x6e)],'message':_0x39d730,'payment':{'id':_0x233f26,'status':_0x4bafd9[_0x554fd5(0x6e)],'gateway':_0x554fd5(0x9d),'last4':_0x1b46ff[_0x554fd5(0xa3)]}};_0x1b46ff[_0x554fd5(0x88)]&&(_0x327ed8[_0x554fd5(0xdf)]=_0x1b46ff[_0x554fd5(0x88)],_0x327ed8['requires_action']=!![],console['log'](_0x554fd5(0xad)+_0x1b46ff['redirectUrl'])),_0x1cba66[_0x554fd5(0x7d)](_0x327ed8);}catch(_0x9b8c6b){console[_0x554fd5(0xd3)](_0x554fd5(0xc8),_0x9b8c6b),_0x73b89d(_0x9b8c6b);}},this['handleWebhook']=async(_0x593a6e,_0x2a76ca,_0x5f0365)=>{const _0x3df793=_0xe144c4;try{console['log'](_0x3df793(0x9b)),console[_0x3df793(0x78)](_0x3df793(0xcd),_0x593a6e['headers']),console[_0x3df793(0x78)](_0x3df793(0x87),_0x593a6e[_0x3df793(0xc5)]),this[_0x3df793(0xe3)][_0x3df793(0x97)]({'headers':_0x593a6e[_0x3df793(0x89)],'body':_0x593a6e[_0x3df793(0xc5)],'timestamp':new Date()[_0x3df793(0xba)]()});const _0x2dfe86=_0x593a6e[_0x3df793(0xc5)];if(!_0x2dfe86['uid']||!_0x2dfe86[_0x3df793(0x6e)])return console[_0x3df793(0xcc)](_0x3df793(0x76)),_0x2a76ca[_0x3df793(0x6e)](0x190)[_0x3df793(0x7d)]({'success':![],'message':_0x3df793(0xe9)});let _0xaf9c9b;_0x2dfe86[_0x3df793(0x8f)]&&(_0xaf9c9b=await database_1[_0x3df793(0x90)][_0x3df793(0xc0)][_0x3df793(0x9e)]({'where':{'gatewayPaymentId':_0x2dfe86['uid'],'gateway':_0x3df793(0x9d)}}));if(!_0xaf9c9b)return console[_0x3df793(0xcc)]('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x3df793(0xcc)](_0x3df793(0x98)+_0x2dfe86['uid']),console[_0x3df793(0xcc)](_0x3df793(0x86)+_0x2dfe86[_0x3df793(0x95)]),console[_0x3df793(0xcc)]('\x20\x20\x20Gateway:\x20squirrelpay'),console['warn'](_0x3df793(0x82)+_0x2dfe86[_0x3df793(0x8f)]),_0x2a76ca['status'](0x194)[_0x3df793(0x7d)]({'success':![],'message':_0x3df793(0xab)});console[_0x3df793(0x78)](_0x3df793(0xa1)+_0xaf9c9b['id']),console[_0x3df793(0x78)](_0x3df793(0xb5)+_0xaf9c9b[_0x3df793(0x6e)]),console['log'](_0x3df793(0xc4)+_0xaf9c9b[_0x3df793(0xde)]),console['log'](_0x3df793(0x71)+_0x2dfe86[_0x3df793(0x6e)]),console[_0x3df793(0x78)](_0x3df793(0xb8)+_0x2dfe86[_0x3df793(0x8f)]);let _0x181d69=null;const _0x1b98d9={};_0x2dfe86[_0x3df793(0xa5)]?.[_0x3df793(0x92)]&&(_0x1b98d9[_0x3df793(0xaa)]=_0x2dfe86[_0x3df793(0xa5)][_0x3df793(0x92)],console[_0x3df793(0x78)](_0x3df793(0x7b)+_0x2dfe86[_0x3df793(0xa5)][_0x3df793(0x92)]));_0x2dfe86[_0x3df793(0xa5)]?.['last_4']&&(_0x1b98d9[_0x3df793(0xa3)]=_0x2dfe86['payment_method'][_0x3df793(0x73)],console['log'](_0x3df793(0xe1)+_0x2dfe86[_0x3df793(0xa5)][_0x3df793(0x73)]));switch(_0x2dfe86[_0x3df793(0x6e)]){case _0x3df793(0x85):_0x181d69=_0x3df793(0x6f),console[_0x3df793(0x78)](_0x3df793(0xb4));break;case _0x3df793(0xc6):_0x181d69=_0x3df793(0xa7),_0x1b98d9[_0x3df793(0xc1)]=_0x2dfe86[_0x3df793(0xda)]||_0x2dfe86[_0x3df793(0x8c)]||_0x3df793(0x75),console[_0x3df793(0x78)](_0x3df793(0xbe)+_0x1b98d9[_0x3df793(0xc1)]);break;case'incomplete':console['log'](_0x3df793(0xea));break;default:console[_0x3df793(0xcc)](_0x3df793(0x99)+_0x2dfe86[_0x3df793(0x6e)]);break;}if(_0x181d69&&_0x181d69!==_0xaf9c9b[_0x3df793(0x6e)])console[_0x3df793(0x78)](_0x3df793(0xbd)+_0xaf9c9b['status']+'\x20to\x20'+_0x181d69),await this['webhookService'][_0x3df793(0xa8)](_0xaf9c9b['id'],_0x181d69,_0x1b98d9),console[_0x3df793(0x78)](_0x3df793(0x79)+_0xaf9c9b['id']+'\x20updated:\x20status='+_0x181d69+_0x3df793(0x7e));else _0x181d69&&console['log'](_0x3df793(0xe4)+_0xaf9c9b['id']+_0x3df793(0x7a)+_0x181d69+_0x3df793(0xd6));_0x2a76ca[_0x3df793(0x6e)](0xc8)[_0x3df793(0x7d)]({'success':!![],'message':_0x3df793(0x7c)});}catch(_0x46265a){console[_0x3df793(0xd3)](_0x3df793(0xc7),_0x46265a),_0x5f0365(_0x46265a);}},this[_0xe144c4(0xc3)]=async(_0x5fe1ae,_0x456b42,_0xfc9c3f)=>{const _0x5bf856=_0xe144c4;try{const {limit:_0x4cfc46}=_0x5fe1ae[_0x5bf856(0xd7)],_0x4bfdbd=this[_0x5bf856(0xe3)][_0x5bf856(0xc3)](_0x4cfc46?parseInt(_0x4cfc46):0x32);_0x456b42[_0x5bf856(0x7d)]({'success':!![],'result':{'logs':_0x4bfdbd,'count':_0x4bfdbd[_0x5bf856(0xe8)]}});}catch(_0x4136d2){_0xfc9c3f(_0x4136d2);}},this['squirrelPayService']=new squirrelPayService_1[(_0xe144c4(0x83))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||'https://gate.squirrel-pay.com','isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0xe144c4(0xc2)}),this[_0xe144c4(0xb0)]=new currencyService_1['CurrencyService'](),this[_0xe144c4(0xce)]=new webhookService_1[(_0xe144c4(0xe2))]();}}exports[a17_0x4386ae(0xd5)]=SquirrelPayController;