'use strict';const a16_0x743285=a16_0x12d3;(function(_0x278fc1,_0x5aac17){const _0x425fc1=a16_0x12d3,_0x5392e4=_0x278fc1();while(!![]){try{const _0x425508=parseInt(_0x425fc1(0xa1))/0x1+parseInt(_0x425fc1(0xb7))/0x2*(parseInt(_0x425fc1(0xc5))/0x3)+-parseInt(_0x425fc1(0x106))/0x4*(-parseInt(_0x425fc1(0xe3))/0x5)+parseInt(_0x425fc1(0xb9))/0x6+parseInt(_0x425fc1(0x9e))/0x7+-parseInt(_0x425fc1(0xcb))/0x8*(parseInt(_0x425fc1(0xdf))/0x9)+parseInt(_0x425fc1(0xd2))/0xa*(-parseInt(_0x425fc1(0xe4))/0xb);if(_0x425508===_0x5aac17)break;else _0x5392e4['push'](_0x5392e4['shift']());}catch(_0x371ce4){_0x5392e4['push'](_0x5392e4['shift']());}}}(a16_0x4396,0xa74de));function a16_0x4396(){const _0x4b1dff=['log','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','webhookService','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','friendly_message','7332150vSNudG','params','https://gate.squirrel-pay.com','1369363lwyxwk','length','Payment\x20processed\x20successfully','gateway','getClientIP','amountAfterGatewayCommissionUSDT','env','getWebhookLogs','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','Missing\x20required\x20fields\x20in\x20webhook','âŒ\x20SquirrelPay\x20webhook\x20error:','\x20\x20\x20Gateway:\x20squirrelpay','&payment_id=','currencyService','warn','replace','birth_date','failed','ðŸ’°\x20Gateway\x20','Webhook\x20processed\x20successfully','requires_action','CurrencyService','1993138uyqedz','body','6781008FXWLcu','toUpperCase','incomplete','â„¹ï¸\x20Payment\x20','default','padStart','PAID','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','handleWebhook','\x20\x20\x20Payment\x20ID:\x20','FAILED','SQUIRREL_PAY_SHOP_ID','3vDBvhy','slice','Body:','error','logWebhook','gatewayCommissionRate','8lYukgm','\x20to\x20','description','message','uid','../config/database','/payment/pending?id=','30yHhMrV','\x20\x20\x20Customer:\x20','SquirrelPayService','\x20already\x20has\x20status\x20','\x20\x20\x20Amount:\x20','\x20\x20\x20Webhook\x20UID:\x20','amount','Payment\x20not\x20found','FRONTEND_URL','../utils/ipHelper','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','Payment\x20failed','paidAt','2518587iKXSOi','round','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','findFirst','25qyFbAY','17189953EUWWqV','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','\x20\x20\x20Billing\x20Country:\x20','has','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20',',\x20skipping\x20update','successful','SQUIRREL_PAY_TEST_MODE','gatewayOrderId','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','Payment\x20is\x20not\x20in\x20pending\x20status','update','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','convertToUSDT','ðŸ“\x20SquirrelPay\x20payment\x20details:','toString','redirectUrl','\x20\x20\x20UID:\x20','Headers:','âœ…\x20Payment\x20','shopId','currency','SquirrelPayController','Payment\x20is\x20being\x20processed','not\x20provided','SQUIRREL_PAY_BASE_URL','processCardPayment','status','WebhookService','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','squirrelpay','\x20updated:\x20status=','squirrelPayService','toISOString','887792YXHbrI','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','failureMessage','toFixed','defineProperty',',\x20balance\x20updated,\x20amountUSDT\x20calculated','json','amountUSDT','updatePaymentStatus','../services/gateways/squirrelPayService','cardLast4','__esModule','PENDING','headers','payment','\x20USDT'];a16_0x4396=function(){return _0x4b1dff;};return a16_0x4396();}function a16_0x12d3(_0x1dd6bf,_0x181a4b){_0x1dd6bf=_0x1dd6bf-0x8b;const _0x4396ec=a16_0x4396();let _0x12d30f=_0x4396ec[_0x1dd6bf];return _0x12d30f;}var __importDefault=this&&this['__importDefault']||function(_0x3fef6f){return _0x3fef6f&&_0x3fef6f['__esModule']?_0x3fef6f:{'default':_0x3fef6f};};Object[a16_0x743285(0x8c)](exports,a16_0x743285(0x93),{'value':!![]}),exports[a16_0x743285(0xfa)]=void 0x0;const squirrelPayService_1=require(a16_0x743285(0x91)),currencyService_1=require('../services/currencyService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a16_0x743285(0xd0))),ipHelper_1=require(a16_0x743285(0xdb)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x1cb935){const _0x22b02f=a16_0x743285;return ISO_COUNTRY_CODES[_0x22b02f(0xe7)](_0x1cb935[_0x22b02f(0xba)]());}class SquirrelPayController{constructor(){const _0x24477b=a16_0x743285;this['processCardPayment']=async(_0x29f01e,_0x47dda5,_0x80d518)=>{const _0xf5b61d=a16_0x12d3;try{const {paymentId:_0x32010c}=_0x29f01e[_0xf5b61d(0x9f)],{card_number:_0x370879,exp_month:_0x38796f,exp_year:_0x13a0cb,cvv:_0x598e9e,holder_name:_0x57c61b,customer_email:_0x1d00af,customer_birth_date:_0x1d73a7,billing_country:_0x48077a,customer_phone:_0x4952ff,billing_address:_0x1fa570,billing_city:_0x624f35,billing_state:_0x44ba76,billing_zip:_0x1e5781}=_0x29f01e[_0xf5b61d(0xb8)];console[_0xf5b61d(0x98)](_0xf5b61d(0x107)+_0x32010c);if(!_0x370879||!_0x38796f||!_0x13a0cb||!_0x598e9e||!_0x57c61b||!_0x1d00af)return _0x47dda5['status'](0x190)[_0xf5b61d(0x8e)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x48077a&&!isValidCountryCode(_0x48077a))return _0x47dda5['status'](0x190)[_0xf5b61d(0x8e)]({'success':![],'message':_0xf5b61d(0xed)});const _0x46a2f8=await database_1[_0xf5b61d(0xbd)]['payment']['findUnique']({'where':{'id':_0x32010c},'include':{'shop':!![]}});if(!_0x46a2f8)return _0x47dda5[_0xf5b61d(0xff)](0x194)[_0xf5b61d(0x8e)]({'success':![],'message':_0xf5b61d(0xd9)});if(_0x46a2f8[_0xf5b61d(0xff)]!==_0xf5b61d(0x94))return _0x47dda5['status'](0x190)[_0xf5b61d(0x8e)]({'success':![],'message':_0xf5b61d(0xee)});const _0x1fb1e9=(0x0,ipHelper_1[_0xf5b61d(0xa5)])(_0x29f01e),_0x3fa08d={'number':_0x370879[_0xf5b61d(0xb0)](/\s/g,''),'exp_month':_0x38796f[_0xf5b61d(0xf3)]()[_0xf5b61d(0xbe)](0x2,'0'),'exp_year':_0x13a0cb[_0xf5b61d(0xf3)](),'verification_value':_0x598e9e,'holder':_0x57c61b[_0xf5b61d(0xba)]()},_0x50e33e={'ip':_0x1fb1e9,'email':_0x1d00af};_0x1d73a7&&(_0x50e33e[_0xf5b61d(0xb1)]=_0x1d73a7);let _0xb16e9;_0x48077a&&(_0xb16e9={'country':_0x48077a,'address':_0x1fa570,'city':_0x624f35,'state':_0x44ba76,'zip':_0x1e5781});const _0x5b1e86=(process[_0xf5b61d(0xa7)][_0xf5b61d(0xda)]||'https://app.trapay.uk')+_0xf5b61d(0xd1)+_0x32010c+_0xf5b61d(0xad)+(_0x46a2f8[_0xf5b61d(0xec)]||_0x32010c),_0x48f871=(process[_0xf5b61d(0xa7)]['API_BASE_URL']||'https://api.trapay.uk')+'/api/webhooks/squirrel-pay',_0xbb3d6d=_0x32010c[_0xf5b61d(0xc6)](0x0,0x8)+'-'+_0x32010c['slice'](0x8,0x10);console['log'](_0xf5b61d(0xf2)),console[_0xf5b61d(0x98)](_0xf5b61d(0xc2)+_0x32010c),console[_0xf5b61d(0x98)](_0xf5b61d(0xd6)+_0x46a2f8[_0xf5b61d(0xd8)]+'\x20'+_0x46a2f8[_0xf5b61d(0xf9)]),console[_0xf5b61d(0x98)](_0xf5b61d(0xd3)+_0x1d00af+'\x20('+_0x1fb1e9+')'),console['log'](_0xf5b61d(0xe6)+(_0x48077a||_0xf5b61d(0xfc))),console['log']('\x20\x20\x20Description:\x20'+_0xbb3d6d);const _0xcbca07=await this[_0xf5b61d(0x104)][_0xf5b61d(0xfe)](Math[_0xf5b61d(0xe0)](_0x46a2f8[_0xf5b61d(0xd8)]*0x64),_0x46a2f8[_0xf5b61d(0xf9)],_0xbb3d6d,_0x5b1e86,_0x48f871,_0x3fa08d,_0x50e33e,_0xb16e9,_0x4952ff),_0x22197d=this[_0xf5b61d(0x104)]['getPaymentStatus'](_0xcbca07),_0x462781={'gatewayPaymentId':_0xcbca07[_0xf5b61d(0xcf)],'cardLast4':_0x22197d[_0xf5b61d(0x92)],'gateway':_0xf5b61d(0x102),'customerEmail':_0x1d00af,'customerPhone':_0x4952ff,'customerBirthDate':_0x1d73a7,'billingAddress':_0x1fa570,'billingCity':_0x624f35,'billingState':_0x44ba76,'billingZip':_0x1e5781,'customerCountry':_0x48077a};if(_0x22197d[_0xf5b61d(0xff)]===_0xf5b61d(0xbf)){_0x462781['status']=_0xf5b61d(0xbf),_0x462781[_0xf5b61d(0xde)]=new Date();try{const _0x31daa3=await this[_0xf5b61d(0xae)][_0xf5b61d(0xf1)](_0x46a2f8[_0xf5b61d(0xd8)],_0x46a2f8[_0xf5b61d(0xf9)]);_0x462781['amountUSDT']=_0x31daa3,console['log']('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x31daa3+'\x20USDT');const _0xed84ca=await this[_0xf5b61d(0x9b)]['getGatewayCommission'](_0x46a2f8[_0xf5b61d(0xf8)],_0x46a2f8[_0xf5b61d(0xa4)]),_0x4ece14=_0x31daa3*(0x1-_0xed84ca/0x64);_0x462781[_0xf5b61d(0xa6)]=_0x4ece14,_0x462781[_0xf5b61d(0xca)]=_0xed84ca,console[_0xf5b61d(0x98)](_0xf5b61d(0xb3)+_0x46a2f8[_0xf5b61d(0xa4)]+'\x20commission:\x20'+_0xed84ca+'%'),console[_0xf5b61d(0x98)](_0xf5b61d(0x9c)+_0x4ece14[_0xf5b61d(0x8b)](0x6)+_0xf5b61d(0x97));}catch(_0x1a16fc){console[_0xf5b61d(0xc8)](_0xf5b61d(0x99),_0x1a16fc),_0x462781[_0xf5b61d(0x8f)]=0x0,_0x462781[_0xf5b61d(0xa6)]=0x0,_0x462781[_0xf5b61d(0xca)]=0x0;}}else _0x22197d[_0xf5b61d(0xff)]==='FAILED'&&(_0x462781['status']=_0xf5b61d(0xc3),_0x462781[_0xf5b61d(0x108)]=_0x22197d[_0xf5b61d(0x108)]);const _0x5634dc=await database_1[_0xf5b61d(0xbd)][_0xf5b61d(0x96)][_0xf5b61d(0xef)]({'where':{'id':_0x32010c},'data':_0x462781});console[_0xf5b61d(0x98)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x5634dc['status']);let _0x3d7816;if(_0x22197d[_0xf5b61d(0xff)]===_0xf5b61d(0xc3))_0x3d7816=_0x22197d[_0xf5b61d(0x108)]||_0xcbca07[_0xf5b61d(0x9d)]||'Payment\x20failed';else _0x22197d[_0xf5b61d(0xff)]===_0xf5b61d(0x94)?_0x3d7816=_0xcbca07[_0xf5b61d(0x9d)]||_0xf5b61d(0xfb):_0x3d7816=_0xcbca07['friendly_message']||_0xf5b61d(0xa3);const _0x2d9979={'success':_0x22197d[_0xf5b61d(0xff)]!==_0xf5b61d(0xc3),'status':_0x22197d[_0xf5b61d(0xff)],'message':_0x3d7816,'payment':{'id':_0x32010c,'status':_0x5634dc[_0xf5b61d(0xff)],'gateway':_0xf5b61d(0x102),'last4':_0x22197d['cardLast4']}};_0x22197d[_0xf5b61d(0xf4)]&&(_0x2d9979['redirect_url']=_0x22197d['redirectUrl'],_0x2d9979[_0xf5b61d(0xb5)]=!![],console[_0xf5b61d(0x98)](_0xf5b61d(0xe5)+_0x22197d[_0xf5b61d(0xf4)])),_0x47dda5[_0xf5b61d(0x8e)](_0x2d9979);}catch(_0x598aa9){console[_0xf5b61d(0xc8)]('âŒ\x20SquirrelPay\x20card\x20payment\x20error:',_0x598aa9),_0x80d518(_0x598aa9);}},this[_0x24477b(0xc1)]=async(_0x33b1e9,_0x33ce61,_0x41fd44)=>{const _0x21e913=_0x24477b;try{console['log'](_0x21e913(0xc0)),console[_0x21e913(0x98)](_0x21e913(0xf6),_0x33b1e9['headers']),console[_0x21e913(0x98)](_0x21e913(0xc7),_0x33b1e9['body']),this[_0x21e913(0x104)][_0x21e913(0xc9)]({'headers':_0x33b1e9[_0x21e913(0x95)],'body':_0x33b1e9[_0x21e913(0xb8)],'timestamp':new Date()[_0x21e913(0x105)]()});const _0x3dab42=_0x33b1e9[_0x21e913(0xb8)];if(!_0x3dab42['uid']||!_0x3dab42[_0x21e913(0xff)])return console['warn'](_0x21e913(0xa9)),_0x33ce61['status'](0x190)[_0x21e913(0x8e)]({'success':![],'message':_0x21e913(0xaa)});let _0x4ea67b;_0x3dab42['uid']&&(_0x4ea67b=await database_1[_0x21e913(0xbd)][_0x21e913(0x96)][_0x21e913(0xe2)]({'where':{'gatewayPaymentId':_0x3dab42[_0x21e913(0xcf)],'gateway':_0x21e913(0x102)}}));if(!_0x4ea67b)return console[_0x21e913(0xaf)]('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x21e913(0xaf)](_0x21e913(0xf5)+_0x3dab42[_0x21e913(0xcf)]),console['warn']('\x20\x20\x20Description:\x20'+_0x3dab42[_0x21e913(0xcd)]),console[_0x21e913(0xaf)](_0x21e913(0xac)),console[_0x21e913(0xaf)](_0x21e913(0x101)+_0x3dab42[_0x21e913(0xcf)]),_0x33ce61[_0x21e913(0xff)](0x194)['json']({'success':![],'message':_0x21e913(0xd9)});console[_0x21e913(0x98)](_0x21e913(0xe8)+_0x4ea67b['id']),console[_0x21e913(0x98)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x4ea67b['status']),console[_0x21e913(0x98)](_0x21e913(0xe1)+_0x4ea67b['gatewayPaymentId']),console[_0x21e913(0x98)]('\x20\x20\x20Webhook\x20status:\x20'+_0x3dab42['status']),console['log'](_0x21e913(0xd7)+_0x3dab42['uid']);let _0x5c57cd=null;const _0x6e7c59={};switch(_0x3dab42[_0x21e913(0xff)]){case _0x21e913(0xea):_0x5c57cd='PAID',console[_0x21e913(0x98)](_0x21e913(0xf0));break;case _0x21e913(0xb2):_0x5c57cd=_0x21e913(0xc3),_0x6e7c59[_0x21e913(0x108)]=_0x3dab42[_0x21e913(0x9d)]||_0x3dab42[_0x21e913(0xce)]||_0x21e913(0xdd),console[_0x21e913(0x98)](_0x21e913(0x9a)+_0x6e7c59[_0x21e913(0x108)]);break;case _0x21e913(0xbb):console[_0x21e913(0x98)]('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console[_0x21e913(0xaf)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x3dab42[_0x21e913(0xff)]);break;}if(_0x5c57cd&&_0x5c57cd!==_0x4ea67b[_0x21e913(0xff)])console[_0x21e913(0x98)](_0x21e913(0xdc)+_0x4ea67b['status']+_0x21e913(0xcc)+_0x5c57cd),await this['webhookService'][_0x21e913(0x90)](_0x4ea67b['id'],_0x5c57cd,_0x6e7c59),console[_0x21e913(0x98)](_0x21e913(0xf7)+_0x4ea67b['id']+_0x21e913(0x103)+_0x5c57cd+_0x21e913(0x8d));else _0x5c57cd&&console[_0x21e913(0x98)](_0x21e913(0xbc)+_0x4ea67b['id']+_0x21e913(0xd5)+_0x5c57cd+_0x21e913(0xe9));_0x33ce61['status'](0xc8)[_0x21e913(0x8e)]({'success':!![],'message':_0x21e913(0xb4)});}catch(_0xa57512){console[_0x21e913(0xc8)](_0x21e913(0xab),_0xa57512),_0x41fd44(_0xa57512);}},this[_0x24477b(0xa8)]=async(_0x46094d,_0x4b2d34,_0x3e3878)=>{const _0x24f893=_0x24477b;try{const {limit:_0x500a12}=_0x46094d['query'],_0x48b32b=this[_0x24f893(0x104)]['getWebhookLogs'](_0x500a12?parseInt(_0x500a12):0x32);_0x4b2d34['json']({'success':!![],'result':{'logs':_0x48b32b,'count':_0x48b32b[_0x24f893(0xa2)]}});}catch(_0x410cb6){_0x3e3878(_0x410cb6);}},this[_0x24477b(0x104)]=new squirrelPayService_1[(_0x24477b(0xd4))]({'shopId':process[_0x24477b(0xa7)][_0x24477b(0xc4)]||'','secretKey':process[_0x24477b(0xa7)]['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0x24477b(0xa7)][_0x24477b(0xfd)]||_0x24477b(0xa0),'isTestMode':process['env'][_0x24477b(0xeb)]==='true'}),this[_0x24477b(0xae)]=new currencyService_1[(_0x24477b(0xb6))](),this[_0x24477b(0x9b)]=new webhookService_1[(_0x24477b(0x100))]();}}exports[a16_0x743285(0xfa)]=SquirrelPayController;