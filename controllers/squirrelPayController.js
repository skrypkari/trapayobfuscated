'use strict';const a17_0x48c2a1=a17_0x483d;(function(_0x46bbae,_0x48f3d1){const _0x400139=a17_0x483d,_0x1b4c92=_0x46bbae();while(!![]){try{const _0x284d10=parseInt(_0x400139(0x184))/0x1*(-parseInt(_0x400139(0x1c5))/0x2)+-parseInt(_0x400139(0x160))/0x3+-parseInt(_0x400139(0x161))/0x4*(-parseInt(_0x400139(0x1c8))/0x5)+parseInt(_0x400139(0x1c7))/0x6*(-parseInt(_0x400139(0x1c3))/0x7)+-parseInt(_0x400139(0x177))/0x8+parseInt(_0x400139(0x1c4))/0x9*(-parseInt(_0x400139(0x154))/0xa)+-parseInt(_0x400139(0x1be))/0xb*(-parseInt(_0x400139(0x198))/0xc);if(_0x284d10===_0x48f3d1)break;else _0x1b4c92['push'](_0x1b4c92['shift']());}catch(_0x20fde5){_0x1b4c92['push'](_0x1b4c92['shift']());}}}(a17_0x5522,0xec47f));var __importDefault=this&&this['__importDefault']||function(_0x1eed45){const _0x323819=a17_0x483d;return _0x1eed45&&_0x1eed45[_0x323819(0x1d4)]?_0x1eed45:{'default':_0x1eed45};};Object[a17_0x48c2a1(0x1d2)](exports,a17_0x48c2a1(0x1d4),{'value':!![]}),exports[a17_0x48c2a1(0x1a4)]=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require('../services/currencyService'),webhookService_1=require(a17_0x48c2a1(0x15a)),database_1=__importDefault(require(a17_0x48c2a1(0x16a))),ipHelper_1=require(a17_0x48c2a1(0x173)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a17_0x483d(_0x5f5a3a,_0x25bf32){_0x5f5a3a=_0x5f5a3a-0x150;const _0x5522ed=a17_0x5522();let _0x483d6f=_0x5522ed[_0x5f5a3a];return _0x483d6f;}function isValidCountryCode(_0x46035c){const _0x139705=a17_0x48c2a1;return ISO_COUNTRY_CODES[_0x139705(0x1a3)](_0x46035c[_0x139705(0x19d)]());}function a17_0x5522(){const _0x2b82b2=['PAID','â„¹ï¸\x20Payment\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','CurrencyService','redirectUrl','1249186KTIVhT','gatewayPaymentId','default','squirrelpay','getWebhookLogs','âŒ\x20SquirrelPay\x20webhook\x20error:','successful','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','API_BASE_URL','&payment_id=','Body:','ðŸ’³\x20Card\x20last\x204:\x20','\x20commission:\x20','not\x20provided','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','toISOString','error','payment','SQUIRREL_PAY_SECRET_KEY','900hEJMvC','failed','ðŸ’³\x20Card\x20brand\x20detected:\x20','amount','updatePaymentStatus','toUpperCase','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','\x20\x20\x20Gateway:\x20squirrelpay','length','headers','\x20\x20\x20UID:\x20','has','SquirrelPayController','json','WebhookService','uid','description','FRONTEND_URL','cardLast4','SQUIRREL_PAY_BASE_URL','Missing\x20required\x20card\x20or\x20customer\x20information','https://api.trapay.uk','\x20\x20\x20Description:\x20','update','PENDING','\x20\x20\x20Webhook\x20UID:\x20','toString','birth_date','Headers:','params','ðŸ’°\x20Gateway\x20','shopId','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','brand','friendly_message','env','convertToUSDT','getClientIP','746867AcdKXz','currencyService','\x20\x20\x20Webhook\x20status:\x20','Payment\x20is\x20being\x20processed','handleWebhook','91Bqkcna','14881410frkqzK','2CXfPaH','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','64062OdPMDl','45kbMKVO','\x20\x20\x20Customer:\x20','\x20USDT','currency','SQUIRREL_PAY_SHOP_ID','\x20\x20\x20Payment\x20ID:\x20','\x20updated:\x20status=','https://app.trapay.uk','webhookService','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','defineProperty','processCardPayment','__esModule','incomplete','padStart','ðŸ“\x20SquirrelPay\x20payment\x20details:','slice','10tynXTD','log','/payment/pending?id=','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','https://gate.squirrel-pay.com','warn','../services/webhookService','getGatewayCommission','redirect_url','Payment\x20not\x20found',',\x20balance\x20updated,\x20amountUSDT\x20calculated','gateway','3890406wdicBq','843940ZpiBHZ','requires_action','cardBrand','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','amountUSDT','gatewayCommissionRate','status','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','../config/database','body','\x20\x20\x20Amount:\x20','query','FAILED','gatewayOrderId','paidAt','Payment\x20processed\x20successfully','findUnique','../utils/ipHelper','amountAfterGatewayCommissionUSDT','true','replace','13480432CnmaLM','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','payment_method','squirrelPayService','findFirst','Webhook\x20processed\x20successfully','last_4','failureMessage'];a17_0x5522=function(){return _0x2b82b2;};return a17_0x5522();}class SquirrelPayController{constructor(){const _0x74cf6f=a17_0x48c2a1;this[_0x74cf6f(0x1d3)]=async(_0x2086d0,_0x2e2ab0,_0x4c72d0)=>{const _0x7ca697=_0x74cf6f;try{const {paymentId:_0x594b4e}=_0x2086d0[_0x7ca697(0x1b5)],{card_number:_0x3cfa27,exp_month:_0x5680bd,exp_year:_0x4af7e6,cvv:_0x19fab3,holder_name:_0x2bdf6a,customer_email:_0x1492fa,customer_birth_date:_0x2cdaba,billing_country:_0x4d10d9,customer_phone:_0x4d6620,billing_address:_0x3fc698,billing_city:_0x25d540,billing_state:_0x357e75,billing_zip:_0x3910b0}=_0x2086d0[_0x7ca697(0x16b)];console['log']('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x594b4e);if(!_0x3cfa27||!_0x5680bd||!_0x4af7e6||!_0x19fab3||!_0x2bdf6a||!_0x1492fa)return _0x2e2ab0['status'](0x190)[_0x7ca697(0x1a5)]({'success':![],'message':_0x7ca697(0x1ac)});if(_0x4d10d9&&!isValidCountryCode(_0x4d10d9))return _0x2e2ab0[_0x7ca697(0x168)](0x190)[_0x7ca697(0x1a5)]({'success':![],'message':_0x7ca697(0x181)});const _0x186f54=await database_1[_0x7ca697(0x186)][_0x7ca697(0x196)][_0x7ca697(0x172)]({'where':{'id':_0x594b4e},'include':{'shop':!![]}});if(!_0x186f54)return _0x2e2ab0[_0x7ca697(0x168)](0x194)[_0x7ca697(0x1a5)]({'success':![],'message':_0x7ca697(0x15d)});if(_0x186f54[_0x7ca697(0x168)]!==_0x7ca697(0x1b0))return _0x2e2ab0[_0x7ca697(0x168)](0x190)[_0x7ca697(0x1a5)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x22876c=(0x0,ipHelper_1[_0x7ca697(0x1bd)])(_0x2086d0),_0x4b428b={'number':_0x3cfa27[_0x7ca697(0x176)](/\s/g,''),'exp_month':_0x5680bd[_0x7ca697(0x1b2)]()[_0x7ca697(0x151)](0x2,'0'),'exp_year':_0x4af7e6['toString'](),'verification_value':_0x19fab3,'holder':_0x2bdf6a['toUpperCase']()},_0x543474={'ip':_0x22876c,'email':_0x1492fa};_0x2cdaba&&(_0x543474[_0x7ca697(0x1b3)]=_0x2cdaba);let _0x3584c9;_0x4d10d9&&(_0x3584c9={'country':_0x4d10d9,'address':_0x3fc698,'city':_0x25d540,'state':_0x357e75,'zip':_0x3910b0});const _0x27dfcd=(process['env'][_0x7ca697(0x1a9)]||_0x7ca697(0x1cf))+_0x7ca697(0x156)+_0x594b4e+_0x7ca697(0x18e)+(_0x186f54[_0x7ca697(0x16f)]||_0x594b4e),_0x50a74b=(process['env'][_0x7ca697(0x18d)]||_0x7ca697(0x1ad))+'/api/webhooks/squirrel-pay',_0x23c0c4=_0x594b4e[_0x7ca697(0x153)](0x0,0x8)+'-'+_0x594b4e[_0x7ca697(0x153)](0x8,0x10);console['log'](_0x7ca697(0x152)),console[_0x7ca697(0x155)](_0x7ca697(0x1cd)+_0x594b4e),console[_0x7ca697(0x155)](_0x7ca697(0x16c)+_0x186f54[_0x7ca697(0x19b)]+'\x20'+_0x186f54[_0x7ca697(0x1cb)]),console[_0x7ca697(0x155)](_0x7ca697(0x1c9)+_0x1492fa+'\x20('+_0x22876c+')'),console[_0x7ca697(0x155)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x4d10d9||_0x7ca697(0x192))),console[_0x7ca697(0x155)]('\x20\x20\x20Description:\x20'+_0x23c0c4);const _0x51b225=await this[_0x7ca697(0x17a)][_0x7ca697(0x1d3)](Math['round'](_0x186f54[_0x7ca697(0x19b)]*0x64),_0x186f54[_0x7ca697(0x1cb)],_0x23c0c4,_0x27dfcd,_0x50a74b,_0x4b428b,_0x543474,_0x3584c9,_0x4d6620),_0x3c7d81=this[_0x7ca697(0x17a)]['getPaymentStatus'](_0x51b225),_0x420dc9={'gatewayPaymentId':_0x51b225[_0x7ca697(0x1a7)],'cardLast4':_0x3c7d81[_0x7ca697(0x1aa)],'gateway':_0x7ca697(0x187),'customerEmail':_0x1492fa,'customerPhone':_0x4d6620,'customerBirthDate':_0x2cdaba,'billingAddress':_0x3fc698,'billingCity':_0x25d540,'billingState':_0x357e75,'billingZip':_0x3910b0,'customerCountry':_0x4d10d9};if(_0x3c7d81[_0x7ca697(0x168)]==='PAID'){_0x420dc9[_0x7ca697(0x168)]=_0x7ca697(0x17f),_0x420dc9[_0x7ca697(0x170)]=new Date();try{const _0x19ef63=await this['currencyService'][_0x7ca697(0x1bc)](_0x186f54[_0x7ca697(0x19b)],_0x186f54[_0x7ca697(0x1cb)]);_0x420dc9['amountUSDT']=_0x19ef63,console[_0x7ca697(0x155)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x19ef63+_0x7ca697(0x1ca));const _0x45ceb6=await this[_0x7ca697(0x1d0)][_0x7ca697(0x15b)](_0x186f54[_0x7ca697(0x1b7)],_0x186f54[_0x7ca697(0x15f)]),_0x25b30b=_0x19ef63*(0x1-_0x45ceb6/0x64);_0x420dc9[_0x7ca697(0x174)]=_0x25b30b,_0x420dc9[_0x7ca697(0x167)]=_0x45ceb6,console['log'](_0x7ca697(0x1b6)+_0x186f54[_0x7ca697(0x15f)]+_0x7ca697(0x191)+_0x45ceb6+'%'),console[_0x7ca697(0x155)](_0x7ca697(0x1b8)+_0x25b30b['toFixed'](0x6)+'\x20USDT');}catch(_0x240270){console[_0x7ca697(0x195)](_0x7ca697(0x1c6),_0x240270),_0x420dc9[_0x7ca697(0x166)]=0x0,_0x420dc9[_0x7ca697(0x174)]=0x0,_0x420dc9['gatewayCommissionRate']=0x0;}}else _0x3c7d81[_0x7ca697(0x168)]===_0x7ca697(0x16e)&&(_0x420dc9['status']=_0x7ca697(0x16e),_0x420dc9[_0x7ca697(0x17e)]=_0x3c7d81[_0x7ca697(0x17e)]);const _0x35daa5=await database_1[_0x7ca697(0x186)]['payment'][_0x7ca697(0x1af)]({'where':{'id':_0x594b4e},'data':_0x420dc9});console[_0x7ca697(0x155)](_0x7ca697(0x169)+_0x35daa5[_0x7ca697(0x168)]);let _0x277bb5;if(_0x3c7d81['status']===_0x7ca697(0x16e))_0x277bb5=_0x3c7d81[_0x7ca697(0x17e)]||_0x51b225[_0x7ca697(0x1ba)]||'Payment\x20failed';else _0x3c7d81[_0x7ca697(0x168)]===_0x7ca697(0x1b0)?_0x277bb5=_0x51b225[_0x7ca697(0x1ba)]||_0x7ca697(0x1c1):_0x277bb5=_0x51b225[_0x7ca697(0x1ba)]||_0x7ca697(0x171);const _0x161272={'success':_0x3c7d81[_0x7ca697(0x168)]!==_0x7ca697(0x16e),'status':_0x3c7d81[_0x7ca697(0x168)],'message':_0x277bb5,'payment':{'id':_0x594b4e,'status':_0x35daa5[_0x7ca697(0x168)],'gateway':_0x7ca697(0x187),'last4':_0x3c7d81[_0x7ca697(0x1aa)]}};_0x3c7d81[_0x7ca697(0x183)]&&(_0x161272[_0x7ca697(0x15c)]=_0x3c7d81[_0x7ca697(0x183)],_0x161272[_0x7ca697(0x162)]=!![],console[_0x7ca697(0x155)](_0x7ca697(0x18b)+_0x3c7d81[_0x7ca697(0x183)])),_0x2e2ab0['json'](_0x161272);}catch(_0x4114bb){console['error'](_0x7ca697(0x164),_0x4114bb),_0x4c72d0(_0x4114bb);}},this[_0x74cf6f(0x1c2)]=async(_0x2be858,_0x51422d,_0x3eb969)=>{const _0x35ea74=_0x74cf6f;try{console[_0x35ea74(0x155)](_0x35ea74(0x165)),console['log'](_0x35ea74(0x1b4),_0x2be858['headers']),console['log'](_0x35ea74(0x18f),_0x2be858['body']),this[_0x35ea74(0x17a)]['logWebhook']({'headers':_0x2be858[_0x35ea74(0x1a1)],'body':_0x2be858[_0x35ea74(0x16b)],'timestamp':new Date()[_0x35ea74(0x194)]()});const _0x4f7c7d=_0x2be858[_0x35ea74(0x16b)];if(!_0x4f7c7d[_0x35ea74(0x1a7)]||!_0x4f7c7d[_0x35ea74(0x168)])return console[_0x35ea74(0x159)]('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x51422d[_0x35ea74(0x168)](0x190)[_0x35ea74(0x1a5)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x5b8b0b;_0x4f7c7d[_0x35ea74(0x1a7)]&&(_0x5b8b0b=await database_1[_0x35ea74(0x186)][_0x35ea74(0x196)][_0x35ea74(0x17b)]({'where':{'gatewayPaymentId':_0x4f7c7d[_0x35ea74(0x1a7)],'gateway':'squirrelpay'}}));if(!_0x5b8b0b)return console[_0x35ea74(0x159)](_0x35ea74(0x19e)),console[_0x35ea74(0x159)](_0x35ea74(0x1a2)+_0x4f7c7d['uid']),console['warn'](_0x35ea74(0x1ae)+_0x4f7c7d[_0x35ea74(0x1a8)]),console[_0x35ea74(0x159)](_0x35ea74(0x19f)),console[_0x35ea74(0x159)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x4f7c7d[_0x35ea74(0x1a7)]),_0x51422d[_0x35ea74(0x168)](0x194)[_0x35ea74(0x1a5)]({'success':![],'message':'Payment\x20not\x20found'});console[_0x35ea74(0x155)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x5b8b0b['id']),console[_0x35ea74(0x155)](_0x35ea74(0x193)+_0x5b8b0b[_0x35ea74(0x168)]),console[_0x35ea74(0x155)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x5b8b0b[_0x35ea74(0x185)]),console[_0x35ea74(0x155)](_0x35ea74(0x1c0)+_0x4f7c7d[_0x35ea74(0x168)]),console[_0x35ea74(0x155)](_0x35ea74(0x1b1)+_0x4f7c7d[_0x35ea74(0x1a7)]);let _0x577621=null;const _0x365b96={};_0x4f7c7d[_0x35ea74(0x179)]?.[_0x35ea74(0x1b9)]&&(_0x365b96[_0x35ea74(0x163)]=_0x4f7c7d[_0x35ea74(0x179)][_0x35ea74(0x1b9)],console['log'](_0x35ea74(0x19a)+_0x4f7c7d['payment_method'][_0x35ea74(0x1b9)]));_0x4f7c7d[_0x35ea74(0x179)]?.['last_4']&&(_0x365b96[_0x35ea74(0x1aa)]=_0x4f7c7d[_0x35ea74(0x179)][_0x35ea74(0x17d)],console[_0x35ea74(0x155)](_0x35ea74(0x190)+_0x4f7c7d[_0x35ea74(0x179)]['last_4']));switch(_0x4f7c7d['status']){case _0x35ea74(0x18a):_0x577621=_0x35ea74(0x17f),console[_0x35ea74(0x155)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x35ea74(0x199):_0x577621=_0x35ea74(0x16e),_0x365b96[_0x35ea74(0x17e)]=_0x4f7c7d[_0x35ea74(0x1ba)]||_0x4f7c7d['message']||'Payment\x20failed',console['log'](_0x35ea74(0x157)+_0x365b96[_0x35ea74(0x17e)]);break;case _0x35ea74(0x150):console['log'](_0x35ea74(0x18c));break;default:console[_0x35ea74(0x159)](_0x35ea74(0x1d1)+_0x4f7c7d[_0x35ea74(0x168)]);break;}if(_0x577621&&_0x577621!==_0x5b8b0b[_0x35ea74(0x168)])console[_0x35ea74(0x155)](_0x35ea74(0x178)+_0x5b8b0b[_0x35ea74(0x168)]+'\x20to\x20'+_0x577621),await this[_0x35ea74(0x1d0)][_0x35ea74(0x19c)](_0x5b8b0b['id'],_0x577621,_0x365b96),console[_0x35ea74(0x155)]('âœ…\x20Payment\x20'+_0x5b8b0b['id']+_0x35ea74(0x1ce)+_0x577621+_0x35ea74(0x15e));else _0x577621&&console[_0x35ea74(0x155)](_0x35ea74(0x180)+_0x5b8b0b['id']+'\x20already\x20has\x20status\x20'+_0x577621+',\x20skipping\x20update');_0x51422d[_0x35ea74(0x168)](0xc8)[_0x35ea74(0x1a5)]({'success':!![],'message':_0x35ea74(0x17c)});}catch(_0x8b5e86){console[_0x35ea74(0x195)](_0x35ea74(0x189),_0x8b5e86),_0x3eb969(_0x8b5e86);}},this[_0x74cf6f(0x188)]=async(_0x302777,_0x1e8ccd,_0x588bf2)=>{const _0x458de5=_0x74cf6f;try{const {limit:_0x2d0672}=_0x302777[_0x458de5(0x16d)],_0x4cbd4b=this['squirrelPayService'][_0x458de5(0x188)](_0x2d0672?parseInt(_0x2d0672):0x32);_0x1e8ccd['json']({'success':!![],'result':{'logs':_0x4cbd4b,'count':_0x4cbd4b[_0x458de5(0x1a0)]}});}catch(_0x572207){_0x588bf2(_0x572207);}},this[_0x74cf6f(0x17a)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0x74cf6f(0x1bb)][_0x74cf6f(0x1cc)]||'','secretKey':process[_0x74cf6f(0x1bb)][_0x74cf6f(0x197)]||'','baseUrl':process[_0x74cf6f(0x1bb)][_0x74cf6f(0x1ab)]||_0x74cf6f(0x158),'isTestMode':process['env']['SQUIRREL_PAY_TEST_MODE']===_0x74cf6f(0x175)}),this[_0x74cf6f(0x1bf)]=new currencyService_1[(_0x74cf6f(0x182))](),this[_0x74cf6f(0x1d0)]=new webhookService_1[(_0x74cf6f(0x1a6))]();}}exports['SquirrelPayController']=SquirrelPayController;