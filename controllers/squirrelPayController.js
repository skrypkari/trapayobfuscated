'use strict';function a17_0x8b56(){const _0x4c043f=['headers','getWebhookLogs','CurrencyService','__importDefault','webhookService','cardBrand','logWebhook','22wMDykk','9396744RGyjBX','currencyService','default','SquirrelPayController','Payment\x20failed','\x20\x20\x20Webhook\x20status:\x20','friendly_message','last_4','replace','âœ…\x20Payment\x20','../services/currencyService','Headers:','paidAt','query','failureMessage','has','not\x20provided','ðŸ“\x20SquirrelPay\x20payment\x20details:','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','24VTeJtL','Missing\x20required\x20fields\x20in\x20webhook','payment','birth_date','â„¹ï¸\x20Payment\x20','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','1661060DEDcrm','cardLast4','toString','ðŸ’°\x20Calculated\x20amountUSDT:\x20','toISOString','Webhook\x20processed\x20successfully','redirect_url','shopId','5FVshfL','Payment\x20processed\x20successfully','https://gate.squirrel-pay.com','\x20\x20\x20Payment\x20ID:\x20','padStart','\x20updated:\x20status=','findUnique','handleWebhook','status','30921550WOLpLe','warn','âŒ\x20SquirrelPay\x20webhook\x20error:','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','failed','4723299YwiyrQ','1637jCPgAp','requires_action','SquirrelPayService','../services/webhookService','getPaymentStatus',',\x20balance\x20updated,\x20amountUSDT\x20calculated','\x20USDT','PAID','toFixed','../services/gateways/squirrelPayService','amountUSDT','ðŸ’³\x20Card\x20last\x204:\x20','https://app.trapay.uk','Body:','body','findFirst','toUpperCase','gateway','uid','redirectUrl','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','__esModule','getGatewayCommission','amount','Payment\x20is\x20being\x20processed','1540848DYsAXW','PENDING','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','&payment_id=','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','/api/webhooks/squirrel-pay','ðŸ’³\x20Card\x20brand\x20detected:\x20','round','\x20\x20\x20Gateway:\x20squirrelpay','1376494KITuFE','../config/database','update','squirrelPayService','currency','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','slice','brand','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','../utils/ipHelper','successful','updatePaymentStatus','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','Payment\x20not\x20found','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','error','payment_method','\x20\x20\x20Current\x20status\x20in\x20DB:\x20',',\x20skipping\x20update','squirrelpay','json','FAILED','gatewayOrderId','amountAfterGatewayCommissionUSDT','\x20to\x20','log'];a17_0x8b56=function(){return _0x4c043f;};return a17_0x8b56();}const a17_0xb62e0c=a17_0x309e;function a17_0x309e(_0x1cf9e3,_0xb665c0){_0x1cf9e3=_0x1cf9e3-0x10d;const _0x8b5671=a17_0x8b56();let _0x309e3e=_0x8b5671[_0x1cf9e3];return _0x309e3e;}(function(_0x3221f0,_0x1227da){const _0x3d7a82=a17_0x309e,_0x81f6ff=_0x3221f0();while(!![]){try{const _0x3950db=parseInt(_0x3d7a82(0x158))/0x1*(-parseInt(_0x3d7a82(0x126))/0x2)+parseInt(_0x3d7a82(0x172))/0x3+-parseInt(_0x3d7a82(0x141))/0x4*(parseInt(_0x3d7a82(0x149))/0x5)+parseInt(_0x3d7a82(0x13a))/0x6*(-parseInt(_0x3d7a82(0x17c))/0x7)+-parseInt(_0x3d7a82(0x127))/0x8+-parseInt(_0x3d7a82(0x157))/0x9+parseInt(_0x3d7a82(0x152))/0xa;if(_0x3950db===_0x1227da)break;else _0x81f6ff['push'](_0x81f6ff['shift']());}catch(_0x468089){_0x81f6ff['push'](_0x81f6ff['shift']());}}}(a17_0x8b56,0xa79bf));var __importDefault=this&&this[a17_0xb62e0c(0x122)]||function(_0x7c904b){return _0x7c904b&&_0x7c904b['__esModule']?_0x7c904b:{'default':_0x7c904b};};Object['defineProperty'](exports,a17_0xb62e0c(0x16e),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a17_0xb62e0c(0x161)),currencyService_1=require(a17_0xb62e0c(0x131)),webhookService_1=require(a17_0xb62e0c(0x15b)),database_1=__importDefault(require(a17_0xb62e0c(0x17d))),ipHelper_1=require(a17_0xb62e0c(0x10e)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x5ab510){const _0x3be4e0=a17_0xb62e0c;return ISO_COUNTRY_CODES[_0x3be4e0(0x136)](_0x5ab510[_0x3be4e0(0x168)]());}class SquirrelPayController{constructor(){const _0xc9d257=a17_0xb62e0c;this['processCardPayment']=async(_0x6306b2,_0x5067e0,_0x1f1d4b)=>{const _0xf13461=a17_0x309e;try{const {paymentId:_0x5aae2c}=_0x6306b2['params'],{card_number:_0x38c826,exp_month:_0xb6a645,exp_year:_0x128538,cvv:_0x7652c4,holder_name:_0x59c614,customer_email:_0x21b103,customer_birth_date:_0x5796fd,billing_country:_0x1ae123,customer_phone:_0x57748,billing_address:_0x3452e6,billing_city:_0x459bb8,billing_state:_0xb86290,billing_zip:_0x3ef2c7}=_0x6306b2[_0xf13461(0x166)];console[_0xf13461(0x11e)](_0xf13461(0x13f)+_0x5aae2c);if(!_0x38c826||!_0xb6a645||!_0x128538||!_0x7652c4||!_0x59c614||!_0x21b103)return _0x5067e0[_0xf13461(0x151)](0x190)[_0xf13461(0x119)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x1ae123&&!isValidCountryCode(_0x1ae123))return _0x5067e0['status'](0x190)[_0xf13461(0x119)]({'success':![],'message':_0xf13461(0x155)});const _0x8fbab3=await database_1[_0xf13461(0x129)][_0xf13461(0x13c)][_0xf13461(0x14f)]({'where':{'id':_0x5aae2c},'include':{'shop':!![]}});if(!_0x8fbab3)return _0x5067e0[_0xf13461(0x151)](0x194)[_0xf13461(0x119)]({'success':![],'message':_0xf13461(0x112)});if(_0x8fbab3[_0xf13461(0x151)]!==_0xf13461(0x173))return _0x5067e0[_0xf13461(0x151)](0x190)[_0xf13461(0x119)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x13a6f4=(0x0,ipHelper_1['getClientIP'])(_0x6306b2),_0xff7d66={'number':_0x38c826[_0xf13461(0x12f)](/\s/g,''),'exp_month':_0xb6a645[_0xf13461(0x143)]()[_0xf13461(0x14d)](0x2,'0'),'exp_year':_0x128538['toString'](),'verification_value':_0x7652c4,'holder':_0x59c614[_0xf13461(0x168)]()},_0x1549b9={'ip':_0x13a6f4,'email':_0x21b103};_0x5796fd&&(_0x1549b9[_0xf13461(0x13d)]=_0x5796fd);let _0x227977;_0x1ae123&&(_0x227977={'country':_0x1ae123,'address':_0x3452e6,'city':_0x459bb8,'state':_0xb86290,'zip':_0x3ef2c7});const _0x38a046=(process.env.FRONTEND_URL||_0xf13461(0x164))+'/payment/pending?id='+_0x5aae2c+_0xf13461(0x175)+(_0x8fbab3[_0xf13461(0x11b)]||_0x5aae2c),_0x11ecb8=(process.env.API_BASE_URL||'https://api.trapay.uk')+_0xf13461(0x178),_0x36acf5=_0x5aae2c[_0xf13461(0x182)](0x0,0x8)+'-'+_0x5aae2c[_0xf13461(0x182)](0x8,0x10);console[_0xf13461(0x11e)](_0xf13461(0x138)),console['log'](_0xf13461(0x14c)+_0x5aae2c),console[_0xf13461(0x11e)]('\x20\x20\x20Amount:\x20'+_0x8fbab3[_0xf13461(0x170)]+'\x20'+_0x8fbab3[_0xf13461(0x180)]),console[_0xf13461(0x11e)]('\x20\x20\x20Customer:\x20'+_0x21b103+'\x20('+_0x13a6f4+')'),console[_0xf13461(0x11e)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x1ae123||_0xf13461(0x137))),console[_0xf13461(0x11e)]('\x20\x20\x20Description:\x20'+_0x36acf5);const _0x1528d8=await this[_0xf13461(0x17f)]['processCardPayment'](Math[_0xf13461(0x17a)](_0x8fbab3[_0xf13461(0x170)]*0x64),_0x8fbab3['currency'],_0x36acf5,_0x38a046,_0x11ecb8,_0xff7d66,_0x1549b9,_0x227977,_0x57748),_0x1ecaf5=this[_0xf13461(0x17f)][_0xf13461(0x15c)](_0x1528d8),_0x4426b0={'gatewayPaymentId':_0x1528d8['uid'],'cardLast4':_0x1ecaf5['cardLast4'],'gateway':'squirrelpay','customerEmail':_0x21b103,'customerPhone':_0x57748,'customerBirthDate':_0x5796fd,'billingAddress':_0x3452e6,'billingCity':_0x459bb8,'billingState':_0xb86290,'billingZip':_0x3ef2c7,'customerCountry':_0x1ae123};if(_0x1ecaf5[_0xf13461(0x151)]===_0xf13461(0x15f)){_0x4426b0[_0xf13461(0x151)]=_0xf13461(0x15f),_0x4426b0[_0xf13461(0x133)]=new Date();try{const _0x532d21=await this[_0xf13461(0x128)]['convertToUSDT'](_0x8fbab3[_0xf13461(0x170)],_0x8fbab3['currency']);_0x4426b0['amountUSDT']=_0x532d21,console[_0xf13461(0x11e)](_0xf13461(0x144)+_0x532d21+_0xf13461(0x15e));const _0x571277=await this[_0xf13461(0x123)][_0xf13461(0x16f)](_0x8fbab3[_0xf13461(0x148)],_0x8fbab3[_0xf13461(0x169)]),_0x37f595=_0x532d21*(0x1-_0x571277/0x64);_0x4426b0[_0xf13461(0x11c)]=_0x37f595,_0x4426b0['gatewayCommissionRate']=_0x571277,console[_0xf13461(0x11e)]('ðŸ’°\x20Gateway\x20'+_0x8fbab3[_0xf13461(0x169)]+'\x20commission:\x20'+_0x571277+'%'),console[_0xf13461(0x11e)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x37f595[_0xf13461(0x160)](0x6)+_0xf13461(0x15e));}catch(_0x2375f5){console[_0xf13461(0x114)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x2375f5),_0x4426b0[_0xf13461(0x162)]=0x0,_0x4426b0[_0xf13461(0x11c)]=0x0,_0x4426b0['gatewayCommissionRate']=0x0;}}else _0x1ecaf5[_0xf13461(0x151)]===_0xf13461(0x11a)&&(_0x4426b0[_0xf13461(0x151)]='FAILED',_0x4426b0['failureMessage']=_0x1ecaf5[_0xf13461(0x135)]);const _0x1613ce=await database_1['default']['payment'][_0xf13461(0x17e)]({'where':{'id':_0x5aae2c},'data':_0x4426b0});console[_0xf13461(0x11e)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x1613ce[_0xf13461(0x151)]);let _0x4a992a;if(_0x1ecaf5['status']==='FAILED')_0x4a992a=_0x1ecaf5[_0xf13461(0x135)]||_0x1528d8[_0xf13461(0x12d)]||'Payment\x20failed';else _0x1ecaf5[_0xf13461(0x151)]===_0xf13461(0x173)?_0x4a992a=_0x1528d8[_0xf13461(0x12d)]||_0xf13461(0x171):_0x4a992a=_0x1528d8[_0xf13461(0x12d)]||_0xf13461(0x14a);const _0x3a3d2d={'success':_0x1ecaf5[_0xf13461(0x151)]!=='FAILED','status':_0x1ecaf5[_0xf13461(0x151)],'message':_0x4a992a,'payment':{'id':_0x5aae2c,'status':_0x1613ce['status'],'gateway':_0xf13461(0x118),'last4':_0x1ecaf5[_0xf13461(0x142)]}};_0x1ecaf5[_0xf13461(0x16b)]&&(_0x3a3d2d[_0xf13461(0x147)]=_0x1ecaf5[_0xf13461(0x16b)],_0x3a3d2d[_0xf13461(0x159)]=!![],console[_0xf13461(0x11e)](_0xf13461(0x181)+_0x1ecaf5[_0xf13461(0x16b)])),_0x5067e0[_0xf13461(0x119)](_0x3a3d2d);}catch(_0x579c6f){console[_0xf13461(0x114)](_0xf13461(0x177),_0x579c6f),_0x1f1d4b(_0x579c6f);}},this[_0xc9d257(0x150)]=async(_0x355e0e,_0x34d425,_0x46ed1e)=>{const _0x3ab861=_0xc9d257;try{console['log'](_0x3ab861(0x140)),console[_0x3ab861(0x11e)](_0x3ab861(0x132),_0x355e0e[_0x3ab861(0x11f)]),console['log'](_0x3ab861(0x165),_0x355e0e[_0x3ab861(0x166)]),this[_0x3ab861(0x17f)][_0x3ab861(0x125)]({'headers':_0x355e0e['headers'],'body':_0x355e0e['body'],'timestamp':new Date()[_0x3ab861(0x145)]()});const _0x363077=_0x355e0e[_0x3ab861(0x166)];if(!_0x363077[_0x3ab861(0x16a)]||!_0x363077[_0x3ab861(0x151)])return console['warn'](_0x3ab861(0x174)),_0x34d425[_0x3ab861(0x151)](0x190)[_0x3ab861(0x119)]({'success':![],'message':_0x3ab861(0x13b)});let _0x3f09ad;_0x363077[_0x3ab861(0x16a)]&&(_0x3f09ad=await database_1[_0x3ab861(0x129)][_0x3ab861(0x13c)][_0x3ab861(0x167)]({'where':{'gatewayPaymentId':_0x363077[_0x3ab861(0x16a)],'gateway':_0x3ab861(0x118)}}));if(!_0x3f09ad)return console['warn'](_0x3ab861(0x10d)),console['warn']('\x20\x20\x20UID:\x20'+_0x363077[_0x3ab861(0x16a)]),console[_0x3ab861(0x153)]('\x20\x20\x20Description:\x20'+_0x363077['description']),console['warn'](_0x3ab861(0x17b)),console[_0x3ab861(0x153)](_0x3ab861(0x111)+_0x363077[_0x3ab861(0x16a)]),_0x34d425[_0x3ab861(0x151)](0x194)[_0x3ab861(0x119)]({'success':![],'message':'Payment\x20not\x20found'});console[_0x3ab861(0x11e)](_0x3ab861(0x113)+_0x3f09ad['id']),console['log'](_0x3ab861(0x116)+_0x3f09ad[_0x3ab861(0x151)]),console[_0x3ab861(0x11e)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x3f09ad['gatewayPaymentId']),console[_0x3ab861(0x11e)](_0x3ab861(0x12c)+_0x363077[_0x3ab861(0x151)]),console['log']('\x20\x20\x20Webhook\x20UID:\x20'+_0x363077[_0x3ab861(0x16a)]);let _0x3dc0af=null;const _0xff1937={};_0x363077[_0x3ab861(0x115)]?.[_0x3ab861(0x183)]&&(_0xff1937[_0x3ab861(0x124)]=_0x363077['payment_method']['brand'],console[_0x3ab861(0x11e)](_0x3ab861(0x179)+_0x363077[_0x3ab861(0x115)]['brand']));_0x363077['payment_method']?.[_0x3ab861(0x12e)]&&(_0xff1937['cardLast4']=_0x363077[_0x3ab861(0x115)][_0x3ab861(0x12e)],console['log'](_0x3ab861(0x163)+_0x363077[_0x3ab861(0x115)]['last_4']));switch(_0x363077[_0x3ab861(0x151)]){case _0x3ab861(0x10f):_0x3dc0af=_0x3ab861(0x15f),console[_0x3ab861(0x11e)](_0x3ab861(0x139));break;case _0x3ab861(0x156):_0x3dc0af=_0x3ab861(0x11a),_0xff1937[_0x3ab861(0x135)]=_0x363077[_0x3ab861(0x12d)]||_0x363077['message']||_0x3ab861(0x12b),console['log'](_0x3ab861(0x16c)+_0xff1937['failureMessage']);break;case'incomplete':console[_0x3ab861(0x11e)](_0x3ab861(0x176));break;default:console[_0x3ab861(0x153)](_0x3ab861(0x16d)+_0x363077[_0x3ab861(0x151)]);break;}if(_0x3dc0af&&_0x3dc0af!==_0x3f09ad[_0x3ab861(0x151)])console[_0x3ab861(0x11e)]('ðŸ”„\x20Updating\x20payment\x20status\x20from\x20'+_0x3f09ad[_0x3ab861(0x151)]+_0x3ab861(0x11d)+_0x3dc0af),await this[_0x3ab861(0x123)][_0x3ab861(0x110)](_0x3f09ad['id'],_0x3dc0af,_0xff1937),console[_0x3ab861(0x11e)](_0x3ab861(0x130)+_0x3f09ad['id']+_0x3ab861(0x14e)+_0x3dc0af+_0x3ab861(0x15d));else _0x3dc0af&&console['log'](_0x3ab861(0x13e)+_0x3f09ad['id']+'\x20already\x20has\x20status\x20'+_0x3dc0af+_0x3ab861(0x117));_0x34d425[_0x3ab861(0x151)](0xc8)['json']({'success':!![],'message':_0x3ab861(0x146)});}catch(_0x5d6950){console[_0x3ab861(0x114)](_0x3ab861(0x154),_0x5d6950),_0x46ed1e(_0x5d6950);}},this[_0xc9d257(0x120)]=async(_0x28ea4d,_0x4efe5d,_0x1af812)=>{const _0x1bb07a=_0xc9d257;try{const {limit:_0x338e29}=_0x28ea4d[_0x1bb07a(0x134)],_0xd7c276=this[_0x1bb07a(0x17f)][_0x1bb07a(0x120)](_0x338e29?parseInt(_0x338e29):0x32);_0x4efe5d[_0x1bb07a(0x119)]({'success':!![],'result':{'logs':_0xd7c276,'count':_0xd7c276['length']}});}catch(_0x48c46d){_0x1af812(_0x48c46d);}},this[_0xc9d257(0x17f)]=new squirrelPayService_1[(_0xc9d257(0x15a))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0xc9d257(0x14b),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE==='true'}),this[_0xc9d257(0x128)]=new currencyService_1[(_0xc9d257(0x121))](),this[_0xc9d257(0x123)]=new webhookService_1['WebhookService']();}}exports[a17_0xb62e0c(0x12a)]=SquirrelPayController;