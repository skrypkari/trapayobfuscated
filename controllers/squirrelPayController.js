'use strict';const a16_0x398990=a16_0x3544;(function(_0x481e8,_0xefc31f){const _0x122e2f=a16_0x3544,_0x46ebb1=_0x481e8();while(!![]){try{const _0x30824a=parseInt(_0x122e2f(0xad))/0x1+parseInt(_0x122e2f(0xc8))/0x2+parseInt(_0x122e2f(0xd5))/0x3+-parseInt(_0x122e2f(0xfe))/0x4+-parseInt(_0x122e2f(0xba))/0x5+-parseInt(_0x122e2f(0xa3))/0x6+parseInt(_0x122e2f(0xe5))/0x7;if(_0x30824a===_0xefc31f)break;else _0x46ebb1['push'](_0x46ebb1['shift']());}catch(_0x3c9681){_0x46ebb1['push'](_0x46ebb1['shift']());}}}(a16_0x531e,0x8afad));var __importDefault=this&&this[a16_0x398990(0x109)]||function(_0x35803a){const _0x4b109c=a16_0x398990;return _0x35803a&&_0x35803a[_0x4b109c(0xd8)]?_0x35803a:{'default':_0x35803a};};Object[a16_0x398990(0x10f)](exports,a16_0x398990(0xd8),{'value':!![]}),exports[a16_0x398990(0xed)]=void 0x0;const squirrelPayService_1=require(a16_0x398990(0xa7)),currencyService_1=require(a16_0x398990(0xcb)),webhookService_1=require(a16_0x398990(0xf7)),database_1=__importDefault(require(a16_0x398990(0xdd))),ipHelper_1=require('../utils/ipHelper'),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0xb2c541){const _0x1c2d0e=a16_0x398990;return ISO_COUNTRY_CODES[_0x1c2d0e(0xf6)](_0xb2c541[_0x1c2d0e(0x103)]());}function a16_0x3544(_0x3cccf1,_0x30a162){_0x3cccf1=_0x3cccf1-0x9f;const _0x531e8f=a16_0x531e();let _0x35440e=_0x531e8f[_0x3cccf1];return _0x35440e;}class SquirrelPayController{constructor(){const _0x4439da=a16_0x398990;this[_0x4439da(0xf3)]=async(_0x49ef39,_0x5f3f32,_0x3dd454)=>{const _0x28dffe=_0x4439da;try{const {paymentId:_0x5f3949}=_0x49ef39[_0x28dffe(0xc2)],{card_number:_0x1b02cb,exp_month:_0x4fec50,exp_year:_0x5179ec,cvv:_0x5adb9f,holder_name:_0x589c24,customer_email:_0x5182e8,customer_birth_date:_0xd57179,billing_country:_0x3eec9e,customer_phone:_0x3e4d7a,billing_address:_0x511114,billing_city:_0x32e69f,billing_state:_0x2ae622,billing_zip:_0x535f39}=_0x49ef39[_0x28dffe(0xb3)];console['log'](_0x28dffe(0xd0)+_0x5f3949);if(!_0x1b02cb||!_0x4fec50||!_0x5179ec||!_0x5adb9f||!_0x589c24||!_0x5182e8)return _0x5f3f32['status'](0x190)[_0x28dffe(0x112)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x3eec9e&&!isValidCountryCode(_0x3eec9e))return _0x5f3f32[_0x28dffe(0xe0)](0x190)[_0x28dffe(0x112)]({'success':![],'message':_0x28dffe(0xf0)});const _0x60c6b2=await database_1[_0x28dffe(0x115)][_0x28dffe(0xe8)]['findUnique']({'where':{'id':_0x5f3949},'include':{'shop':!![]}});if(!_0x60c6b2)return _0x5f3f32[_0x28dffe(0xe0)](0x194)[_0x28dffe(0x112)]({'success':![],'message':_0x28dffe(0xbd)});if(_0x60c6b2[_0x28dffe(0xe0)]!==_0x28dffe(0xff))return _0x5f3f32[_0x28dffe(0xe0)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x1b676e=(0x0,ipHelper_1[_0x28dffe(0xdf)])(_0x49ef39),_0x36dc9f={'number':_0x1b02cb[_0x28dffe(0xb5)](/\s/g,''),'exp_month':_0x4fec50['toString']()['padStart'](0x2,'0'),'exp_year':_0x5179ec['toString'](),'verification_value':_0x5adb9f,'holder':_0x589c24['toUpperCase']()},_0x4bbf98={'ip':_0x1b676e,'email':_0x5182e8};_0xd57179&&(_0x4bbf98['birth_date']=_0xd57179);let _0x23a2d2;_0x3eec9e&&(_0x23a2d2={'country':_0x3eec9e,'address':_0x511114,'city':_0x32e69f,'state':_0x2ae622,'zip':_0x535f39});const _0x242d78=(process['env'][_0x28dffe(0x104)]||'https://app.trapay.uk')+_0x28dffe(0xe7)+_0x5f3949+_0x28dffe(0xf4)+(_0x60c6b2[_0x28dffe(0xf5)]||_0x5f3949),_0x5edcc8=(process[_0x28dffe(0xda)]['API_BASE_URL']||_0x28dffe(0x110))+_0x28dffe(0xbe),_0x3985d4=_0x5f3949[_0x28dffe(0xd1)](0x0,0x8)+'-'+_0x5f3949[_0x28dffe(0xd1)](0x8,0x10);console[_0x28dffe(0x10e)](_0x28dffe(0xf2)),console['log']('\x20\x20\x20Payment\x20ID:\x20'+_0x5f3949),console[_0x28dffe(0x10e)](_0x28dffe(0x10a)+_0x60c6b2['amount']+'\x20'+_0x60c6b2[_0x28dffe(0xf9)]),console['log']('\x20\x20\x20Customer:\x20'+_0x5182e8+'\x20('+_0x1b676e+')'),console['log'](_0x28dffe(0xdc)+(_0x3eec9e||_0x28dffe(0x10b))),console[_0x28dffe(0x10e)](_0x28dffe(0xa8)+_0x3985d4);const _0x54a76d=await this[_0x28dffe(0xb0)][_0x28dffe(0xf3)](Math[_0x28dffe(0xbf)](_0x60c6b2[_0x28dffe(0xc7)]*0x64),_0x60c6b2['currency'],_0x3985d4,_0x242d78,_0x5edcc8,_0x36dc9f,_0x4bbf98,_0x23a2d2,_0x3e4d7a),_0x4fe630=this[_0x28dffe(0xb0)]['getPaymentStatus'](_0x54a76d),_0x3b729a={'gatewayPaymentId':_0x54a76d['uid'],'cardLast4':_0x4fe630['cardLast4'],'gateway':'squirrelpay','customerEmail':_0x5182e8,'customerPhone':_0x3e4d7a,'customerBirthDate':_0xd57179,'billingAddress':_0x511114,'billingCity':_0x32e69f,'billingState':_0x2ae622,'billingZip':_0x535f39,'customerCountry':_0x3eec9e};if(_0x4fe630['status']===_0x28dffe(0x100)){_0x3b729a[_0x28dffe(0xe0)]=_0x28dffe(0x100),_0x3b729a[_0x28dffe(0x106)]=new Date();try{const _0x1ed04d=await this['currencyService'][_0x28dffe(0xaf)](_0x60c6b2['amount'],_0x60c6b2[_0x28dffe(0xf9)]);_0x3b729a[_0x28dffe(0xe9)]=_0x1ed04d,console[_0x28dffe(0x10e)]('üí∞\x20Calculated\x20amountUSDT:\x20'+_0x1ed04d+_0x28dffe(0xb7));const _0xd4356f=await this['webhookService'][_0x28dffe(0x111)](_0x60c6b2[_0x28dffe(0x101)],_0x60c6b2[_0x28dffe(0xe4)]),_0x4ff3e4=_0x1ed04d*(0x1-_0xd4356f/0x64);_0x3b729a[_0x28dffe(0xe6)]=_0x4ff3e4,_0x3b729a[_0x28dffe(0xf8)]=_0xd4356f,console['log'](_0x28dffe(0xee)+_0x60c6b2['gateway']+_0x28dffe(0xe2)+_0xd4356f+'%'),console['log'](_0x28dffe(0xfd)+_0x4ff3e4[_0x28dffe(0xd9)](0x6)+'\x20USDT');}catch(_0x5f140f){console['error'](_0x28dffe(0xa5),_0x5f140f),_0x3b729a['amountUSDT']=0x0,_0x3b729a[_0x28dffe(0xe6)]=0x0,_0x3b729a[_0x28dffe(0xf8)]=0x0;}}else _0x4fe630[_0x28dffe(0xe0)]===_0x28dffe(0xd3)&&(_0x3b729a[_0x28dffe(0xe0)]=_0x28dffe(0xd3),_0x3b729a[_0x28dffe(0x107)]=_0x4fe630[_0x28dffe(0x107)]);const _0xe1115e=await database_1[_0x28dffe(0x115)]['payment']['update']({'where':{'id':_0x5f3949},'data':_0x3b729a});console[_0x28dffe(0x10e)]('‚úÖ\x20SquirrelPay\x20payment\x20updated:\x20'+_0xe1115e[_0x28dffe(0xe0)]);let _0x1ab393;if(_0x4fe630[_0x28dffe(0xe0)]===_0x28dffe(0xd3))_0x1ab393=_0x4fe630['failureMessage']||_0x54a76d[_0x28dffe(0xac)]||_0x28dffe(0xde);else _0x4fe630[_0x28dffe(0xe0)]===_0x28dffe(0xff)?_0x1ab393=_0x54a76d['friendly_message']||'Payment\x20is\x20being\x20processed':_0x1ab393=_0x54a76d[_0x28dffe(0xac)]||_0x28dffe(0xa9);const _0x510898={'success':_0x4fe630[_0x28dffe(0xe0)]!=='FAILED','status':_0x4fe630[_0x28dffe(0xe0)],'message':_0x1ab393,'payment':{'id':_0x5f3949,'status':_0xe1115e[_0x28dffe(0xe0)],'gateway':'squirrelpay','last4':_0x4fe630[_0x28dffe(0x10c)]}};_0x4fe630[_0x28dffe(0xc5)]&&(_0x510898[_0x28dffe(0x9f)]=_0x4fe630[_0x28dffe(0xc5)],_0x510898['requires_action']=!![],console[_0x28dffe(0x10e)](_0x28dffe(0xec)+_0x4fe630[_0x28dffe(0xc5)])),_0x5f3f32[_0x28dffe(0x112)](_0x510898);}catch(_0x4a8b43){console['error'](_0x28dffe(0xea),_0x4a8b43),_0x3dd454(_0x4a8b43);}},this[_0x4439da(0xb9)]=async(_0x6ed48f,_0x284faa,_0x1a8f60)=>{const _0x45557c=_0x4439da;try{console[_0x45557c(0x10e)](_0x45557c(0xdb)),console['log'](_0x45557c(0xc6),_0x6ed48f[_0x45557c(0xae)]),console[_0x45557c(0x10e)](_0x45557c(0x114),_0x6ed48f[_0x45557c(0xb3)]),this[_0x45557c(0xb0)][_0x45557c(0xc4)]({'headers':_0x6ed48f['headers'],'body':_0x6ed48f[_0x45557c(0xb3)],'timestamp':new Date()[_0x45557c(0xb4)]()});const _0x4b687c=_0x6ed48f[_0x45557c(0xb3)];if(!_0x4b687c[_0x45557c(0xb2)]||!_0x4b687c['status'])return console[_0x45557c(0xcd)]('‚ö†Ô∏è\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x284faa[_0x45557c(0xe0)](0x190)[_0x45557c(0x112)]({'success':![],'message':_0x45557c(0xd2)});let _0x3546af;_0x4b687c['uid']&&(_0x3546af=await database_1[_0x45557c(0x115)][_0x45557c(0xe8)][_0x45557c(0xd4)]({'where':{'gatewayPaymentId':_0x4b687c[_0x45557c(0xb2)],'gateway':_0x45557c(0x116)}}));if(!_0x3546af)return console[_0x45557c(0xcd)]('‚ö†Ô∏è\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console['warn'](_0x45557c(0xc9)+_0x4b687c[_0x45557c(0xb2)]),console[_0x45557c(0xcd)]('\x20\x20\x20Description:\x20'+_0x4b687c['description']),console['warn'](_0x45557c(0xc1)),console[_0x45557c(0xcd)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x4b687c[_0x45557c(0xb2)]),_0x284faa[_0x45557c(0xe0)](0x194)[_0x45557c(0x112)]({'success':![],'message':_0x45557c(0xbd)});console[_0x45557c(0x10e)]('üîç\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x3546af['id']),console[_0x45557c(0x10e)](_0x45557c(0xa1)+_0x3546af[_0x45557c(0xe0)]),console['log']('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x3546af[_0x45557c(0xef)]),console[_0x45557c(0x10e)](_0x45557c(0xb6)+_0x4b687c['status']),console[_0x45557c(0x10e)](_0x45557c(0xca)+_0x4b687c[_0x45557c(0xb2)]);let _0x31a481=null;const _0x58054d={};switch(_0x4b687c[_0x45557c(0xe0)]){case _0x45557c(0xe3):_0x31a481=_0x45557c(0x100),console['log'](_0x45557c(0xfc));break;case _0x45557c(0xd7):_0x31a481=_0x45557c(0xd3),_0x58054d['failureMessage']=_0x4b687c[_0x45557c(0xac)]||_0x4b687c[_0x45557c(0x105)]||_0x45557c(0xde),console[_0x45557c(0x10e)]('‚ùå\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x58054d[_0x45557c(0x107)]);break;case _0x45557c(0xcc):console[_0x45557c(0x10e)](_0x45557c(0xd6));break;default:console[_0x45557c(0xcd)](_0x45557c(0xa0)+_0x4b687c[_0x45557c(0xe0)]);break;}if(_0x31a481&&_0x31a481!==_0x3546af['status'])console[_0x45557c(0x10e)](_0x45557c(0x108)+_0x3546af[_0x45557c(0xe0)]+'\x20to\x20'+_0x31a481),await this[_0x45557c(0xc3)][_0x45557c(0xf1)](_0x3546af['id'],_0x31a481,_0x58054d),console['log'](_0x45557c(0xc0)+_0x3546af['id']+_0x45557c(0xeb)+_0x31a481+_0x45557c(0xfa));else _0x31a481&&console[_0x45557c(0x10e)](_0x45557c(0x102)+_0x3546af['id']+_0x45557c(0xe1)+_0x31a481+',\x20skipping\x20update');_0x284faa[_0x45557c(0xe0)](0xc8)[_0x45557c(0x112)]({'success':!![],'message':_0x45557c(0xbc)});}catch(_0x142b09){console['error'](_0x45557c(0xab),_0x142b09),_0x1a8f60(_0x142b09);}},this['getWebhookLogs']=async(_0x354e08,_0x37bfb0,_0x18f1ab)=>{const _0x4f399f=_0x4439da;try{const {limit:_0x188901}=_0x354e08[_0x4f399f(0xa4)],_0x3aa195=this['squirrelPayService'][_0x4f399f(0xaa)](_0x188901?parseInt(_0x188901):0x32);_0x37bfb0[_0x4f399f(0x112)]({'success':!![],'result':{'logs':_0x3aa195,'count':_0x3aa195[_0x4f399f(0x10d)]}});}catch(_0x45cb31){_0x18f1ab(_0x45cb31);}},this[_0x4439da(0xb0)]=new squirrelPayService_1[(_0x4439da(0xa6))]({'shopId':process[_0x4439da(0xda)][_0x4439da(0xb8)]||'','secretKey':process[_0x4439da(0xda)][_0x4439da(0xcf)]||'','baseUrl':process[_0x4439da(0xda)][_0x4439da(0xce)]||_0x4439da(0x113),'isTestMode':process[_0x4439da(0xda)]['SQUIRREL_PAY_TEST_MODE']===_0x4439da(0xbb)}),this[_0x4439da(0xb1)]=new currencyService_1[(_0x4439da(0xa2))](),this[_0x4439da(0xc3)]=new webhookService_1[(_0x4439da(0xfb))]();}}function a16_0x531e(){const _0x51095e=['uid','body','toISOString','replace','\x20\x20\x20Webhook\x20status:\x20','\x20USDT','SQUIRREL_PAY_SHOP_ID','handleWebhook','1818075ksclWE','true','Webhook\x20processed\x20successfully','Payment\x20not\x20found','/api/webhooks/squirrel-pay','round','‚úÖ\x20Payment\x20','\x20\x20\x20Gateway:\x20squirrelpay','params','webhookService','logWebhook','redirectUrl','Headers:','amount','1663644npuRDd','\x20\x20\x20UID:\x20','\x20\x20\x20Webhook\x20UID:\x20','../services/currencyService','incomplete','warn','SQUIRREL_PAY_BASE_URL','SQUIRREL_PAY_SECRET_KEY','üêøÔ∏è\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','slice','Missing\x20required\x20fields\x20in\x20webhook','FAILED','findFirst','1535745pxMOrd','‚è≥\x20Payment\x20remains\x20PENDING\x20(incomplete)','failed','__esModule','toFixed','env','üêøÔ∏è\x20SquirrelPay\x20webhook\x20received','\x20\x20\x20Billing\x20Country:\x20','../config/database','Payment\x20failed','getClientIP','status','\x20already\x20has\x20status\x20','\x20commission:\x20','successful','gateway','8261792JGsCAb','amountAfterGatewayCommissionUSDT','/payment/pending?id=','payment','amountUSDT','‚ùå\x20SquirrelPay\x20card\x20payment\x20error:','\x20updated:\x20status=','üîÑ\x203D\x20Secure\x20redirect\x20required:\x20','SquirrelPayController','üí∞\x20Gateway\x20','gatewayPaymentId','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','updatePaymentStatus','üìù\x20SquirrelPay\x20payment\x20details:','processCardPayment','&payment_id=','gatewayOrderId','has','../services/webhookService','gatewayCommissionRate','currency',',\x20balance\x20updated,\x20amountUSDT\x20calculated','WebhookService','‚úÖ\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','4146148tzPgLY','PENDING','PAID','shopId','‚ÑπÔ∏è\x20Payment\x20','toUpperCase','FRONTEND_URL','message','paidAt','failureMessage','üîÑ\x20Updating\x20payment\x20status\x20from\x20','__importDefault','\x20\x20\x20Amount:\x20','not\x20provided','cardLast4','length','log','defineProperty','https://api.trapay.uk','getGatewayCommission','json','https://gate.squirrel-pay.com','Body:','default','squirrelpay','redirect_url','‚ö†Ô∏è\x20Unknown\x20SquirrelPay\x20status:\x20','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','CurrencyService','6129528GAbeXM','query','‚ùå\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','SquirrelPayService','../services/gateways/squirrelPayService','\x20\x20\x20Description:\x20','Payment\x20processed\x20successfully','getWebhookLogs','‚ùå\x20SquirrelPay\x20webhook\x20error:','friendly_message','467008kMenbn','headers','convertToUSDT','squirrelPayService','currencyService'];a16_0x531e=function(){return _0x51095e;};return a16_0x531e();}exports[a16_0x398990(0xed)]=SquirrelPayController;