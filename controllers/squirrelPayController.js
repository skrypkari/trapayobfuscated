'use strict';function a16_0xb1cc(_0x4072bf,_0x37b779){_0x4072bf=_0x4072bf-0xe0;const _0x479f43=a16_0x479f();let _0xb1cc40=_0x479f43[_0x4072bf];return _0xb1cc40;}const a16_0x36c6f8=a16_0xb1cc;(function(_0x4312dd,_0x1d4ba6){const _0x114d76=a16_0xb1cc,_0x54ed68=_0x4312dd();while(!![]){try{const _0x556039=parseInt(_0x114d76(0x10a))/0x1*(parseInt(_0x114d76(0x149))/0x2)+-parseInt(_0x114d76(0x11e))/0x3+-parseInt(_0x114d76(0x11f))/0x4+parseInt(_0x114d76(0x100))/0x5+-parseInt(_0x114d76(0x148))/0x6+-parseInt(_0x114d76(0x15d))/0x7*(-parseInt(_0x114d76(0x11b))/0x8)+-parseInt(_0x114d76(0x11a))/0x9;if(_0x556039===_0x1d4ba6)break;else _0x54ed68['push'](_0x54ed68['shift']());}catch(_0x3a6060){_0x54ed68['push'](_0x54ed68['shift']());}}}(a16_0x479f,0x1f13c));var __importDefault=this&&this[a16_0x36c6f8(0xf4)]||function(_0x510df0){const _0x46587d=a16_0x36c6f8;return _0x510df0&&_0x510df0[_0x46587d(0xea)]?_0x510df0:{'default':_0x510df0};};Object[a16_0x36c6f8(0x130)](exports,a16_0x36c6f8(0xea),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a16_0x36c6f8(0x13d)),currencyService_1=require(a16_0x36c6f8(0x167)),webhookService_1=require(a16_0x36c6f8(0xfd)),database_1=__importDefault(require(a16_0x36c6f8(0xfe))),ipHelper_1=require(a16_0x36c6f8(0x137)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x3caaa2){const _0x5aa90b=a16_0x36c6f8;return ISO_COUNTRY_CODES[_0x5aa90b(0x15c)](_0x3caaa2['toUpperCase']());}function a16_0x479f(){const _0x1e1e9f=['SQUIRREL_PAY_BASE_URL','API_BASE_URL','env','\x20\x20\x20UID:\x20','default','query','log','currencyService','464928ERpMWU','88130Tourao','status','PAID','getPaymentStatus','\x20\x20\x20Amount:\x20','\x20\x20\x20Webhook\x20status:\x20','paidAt','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20',',\x20balance\x20updated,\x20amountUSDT\x20calculated','warn','SQUIRREL_PAY_TEST_MODE','processCardPayment','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','SquirrelPayController','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','slice','squirrelpay','getWebhookLogs','has','7GxHMMT','https://app.trapay.uk','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','&payment_id=','replace','WebhookService','\x20USDT','convertToUSDT','toString','\x20\x20\x20Gateway:\x20squirrelpay','../services/currencyService','FAILED','https://gate.squirrel-pay.com','\x20\x20\x20Description:\x20','FRONTEND_URL','padStart','gatewayCommissionRate','amountAfterGatewayCommissionUSDT','âœ…\x20Payment\x20','CurrencyService','â„¹ï¸\x20Payment\x20','__esModule',',\x20skipping\x20update','headers','ðŸ’°\x20Calculated\x20amountUSDT:\x20','\x20already\x20has\x20status\x20','true','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','gateway','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','Payment\x20failed','__importDefault','squirrelPayService','requires_action','successful','\x20updated:\x20status=','updatePaymentStatus','ðŸ“\x20SquirrelPay\x20payment\x20details:','Headers:','Missing\x20required\x20card\x20or\x20customer\x20information','../services/webhookService','../config/database','Missing\x20required\x20fields\x20in\x20webhook','1241260jUwRaN','payment','/payment/pending?id=','Webhook\x20processed\x20successfully','Payment\x20is\x20not\x20in\x20pending\x20status','shopId','https://api.trapay.uk','currency','cardLast4','birth_date','5Mdyyej','toISOString','redirectUrl','ðŸ’°\x20Gateway\x20','toUpperCase','params','amount','handleWebhook','error','message','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','gatewayOrderId','logWebhook','\x20\x20\x20Billing\x20Country:\x20','PENDING','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','2082843NNfhrV','291608gQwOMx','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','uid','204186mZRmEA','3036CGdNMB','body','âŒ\x20SquirrelPay\x20webhook\x20error:','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','findUnique','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','webhookService','update','length','\x20\x20\x20Payment\x20ID:\x20','round','/api/webhooks/squirrel-pay','description','Payment\x20processed\x20successfully','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','defineProperty','findFirst','SQUIRREL_PAY_SHOP_ID','failureMessage','SQUIRREL_PAY_SECRET_KEY','gatewayPaymentId','amountUSDT','../utils/ipHelper','Payment\x20not\x20found','json','\x20\x20\x20Webhook\x20UID:\x20','friendly_message','not\x20provided','../services/gateways/squirrelPayService','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'];a16_0x479f=function(){return _0x1e1e9f;};return a16_0x479f();}class SquirrelPayController{constructor(){const _0x1b990b=a16_0x36c6f8;this['processCardPayment']=async(_0x50a9fa,_0x5ba814,_0x473f9f)=>{const _0x9fc98d=a16_0xb1cc;try{const {paymentId:_0x25d1ed}=_0x50a9fa[_0x9fc98d(0x10f)],{card_number:_0x2982f2,exp_month:_0x3b7e90,exp_year:_0x20dde1,cvv:_0x53c404,holder_name:_0x4c3391,customer_email:_0x1eea1c,customer_birth_date:_0x1bf20b,billing_country:_0x365404,customer_phone:_0x353107,billing_address:_0x3723e5,billing_city:_0x1cc85e,billing_state:_0x1a1e5a,billing_zip:_0x562dfa}=_0x50a9fa[_0x9fc98d(0x120)];console[_0x9fc98d(0x146)](_0x9fc98d(0x156)+_0x25d1ed);if(!_0x2982f2||!_0x3b7e90||!_0x20dde1||!_0x53c404||!_0x4c3391||!_0x1eea1c)return _0x5ba814[_0x9fc98d(0x14a)](0x190)[_0x9fc98d(0x139)]({'success':![],'message':_0x9fc98d(0xfc)});if(_0x365404&&!isValidCountryCode(_0x365404))return _0x5ba814['status'](0x190)[_0x9fc98d(0x139)]({'success':![],'message':_0x9fc98d(0x13f)});const _0xe9fbe2=await database_1[_0x9fc98d(0x144)][_0x9fc98d(0x101)][_0x9fc98d(0x125)]({'where':{'id':_0x25d1ed},'include':{'shop':!![]}});if(!_0xe9fbe2)return _0x5ba814[_0x9fc98d(0x14a)](0x194)[_0x9fc98d(0x139)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xe9fbe2['status']!=='PENDING')return _0x5ba814[_0x9fc98d(0x14a)](0x190)['json']({'success':![],'message':_0x9fc98d(0x104)});const _0x30ca83=(0x0,ipHelper_1['getClientIP'])(_0x50a9fa),_0x5d7fc2={'number':_0x2982f2[_0x9fc98d(0x161)](/\s/g,''),'exp_month':_0x3b7e90[_0x9fc98d(0x165)]()[_0x9fc98d(0xe4)](0x2,'0'),'exp_year':_0x20dde1[_0x9fc98d(0x165)](),'verification_value':_0x53c404,'holder':_0x4c3391[_0x9fc98d(0x10e)]()},_0x18d7e8={'ip':_0x30ca83,'email':_0x1eea1c};_0x1bf20b&&(_0x18d7e8[_0x9fc98d(0x109)]=_0x1bf20b);let _0x18f391;_0x365404&&(_0x18f391={'country':_0x365404,'address':_0x3723e5,'city':_0x1cc85e,'state':_0x1a1e5a,'zip':_0x562dfa});const _0x1407ca=(process[_0x9fc98d(0x142)][_0x9fc98d(0xe3)]||_0x9fc98d(0x15e))+_0x9fc98d(0x102)+_0x25d1ed+_0x9fc98d(0x160)+(_0xe9fbe2[_0x9fc98d(0x115)]||_0x25d1ed),_0x42f3b8=(process[_0x9fc98d(0x142)][_0x9fc98d(0x141)]||_0x9fc98d(0x106))+_0x9fc98d(0x12c),_0x4c7f4c=_0x25d1ed['slice'](0x0,0x8)+'-'+_0x25d1ed[_0x9fc98d(0x159)](0x8,0x10);console['log'](_0x9fc98d(0xfa)),console[_0x9fc98d(0x146)](_0x9fc98d(0x12a)+_0x25d1ed),console['log'](_0x9fc98d(0x14d)+_0xe9fbe2[_0x9fc98d(0x110)]+'\x20'+_0xe9fbe2[_0x9fc98d(0x107)]),console[_0x9fc98d(0x146)]('\x20\x20\x20Customer:\x20'+_0x1eea1c+'\x20('+_0x30ca83+')'),console['log'](_0x9fc98d(0x117)+(_0x365404||_0x9fc98d(0x13c))),console[_0x9fc98d(0x146)](_0x9fc98d(0xe2)+_0x4c7f4c);const _0x4bac33=await this[_0x9fc98d(0xf5)][_0x9fc98d(0x155)](Math[_0x9fc98d(0x12b)](_0xe9fbe2[_0x9fc98d(0x110)]*0x64),_0xe9fbe2['currency'],_0x4c7f4c,_0x1407ca,_0x42f3b8,_0x5d7fc2,_0x18d7e8,_0x18f391,_0x353107),_0x40ff2b=this[_0x9fc98d(0xf5)][_0x9fc98d(0x14c)](_0x4bac33),_0x19bbf8={'gatewayPaymentId':_0x4bac33['uid'],'cardLast4':_0x40ff2b['cardLast4'],'gateway':_0x9fc98d(0x15a),'customerEmail':_0x1eea1c,'customerPhone':_0x353107,'customerBirthDate':_0x1bf20b,'billingAddress':_0x3723e5,'billingCity':_0x1cc85e,'billingState':_0x1a1e5a,'billingZip':_0x562dfa,'customerCountry':_0x365404};if(_0x40ff2b[_0x9fc98d(0x14a)]===_0x9fc98d(0x14b)){_0x19bbf8[_0x9fc98d(0x14a)]='PAID',_0x19bbf8[_0x9fc98d(0x14f)]=new Date();try{const _0x3ae5f2=await this[_0x9fc98d(0x147)][_0x9fc98d(0x164)](_0xe9fbe2['amount'],_0xe9fbe2['currency']);_0x19bbf8[_0x9fc98d(0x136)]=_0x3ae5f2,console[_0x9fc98d(0x146)](_0x9fc98d(0xed)+_0x3ae5f2+_0x9fc98d(0x163));const _0x174543=await this[_0x9fc98d(0x127)]['getGatewayCommission'](_0xe9fbe2[_0x9fc98d(0x105)],_0xe9fbe2[_0x9fc98d(0xf1)]),_0x1da24d=_0x3ae5f2*(0x1-_0x174543/0x64);_0x19bbf8[_0x9fc98d(0xe6)]=_0x1da24d,_0x19bbf8[_0x9fc98d(0xe5)]=_0x174543,console[_0x9fc98d(0x146)](_0x9fc98d(0x10d)+_0xe9fbe2['gateway']+'\x20commission:\x20'+_0x174543+'%'),console['log'](_0x9fc98d(0x158)+_0x1da24d['toFixed'](0x6)+'\x20USDT');}catch(_0x395847){console['error'](_0x9fc98d(0x119),_0x395847),_0x19bbf8[_0x9fc98d(0x136)]=0x0,_0x19bbf8['amountAfterGatewayCommissionUSDT']=0x0,_0x19bbf8[_0x9fc98d(0xe5)]=0x0;}}else _0x40ff2b[_0x9fc98d(0x14a)]===_0x9fc98d(0xe0)&&(_0x19bbf8['status']=_0x9fc98d(0xe0),_0x19bbf8[_0x9fc98d(0x133)]=_0x40ff2b[_0x9fc98d(0x133)]);const _0x5cd666=await database_1[_0x9fc98d(0x144)]['payment'][_0x9fc98d(0x128)]({'where':{'id':_0x25d1ed},'data':_0x19bbf8});console['log'](_0x9fc98d(0x124)+_0x5cd666[_0x9fc98d(0x14a)]);let _0x4bde8e;if(_0x40ff2b[_0x9fc98d(0x14a)]===_0x9fc98d(0xe0))_0x4bde8e=_0x40ff2b[_0x9fc98d(0x133)]||_0x4bac33['friendly_message']||_0x9fc98d(0xf3);else _0x40ff2b[_0x9fc98d(0x14a)]===_0x9fc98d(0x118)?_0x4bde8e=_0x4bac33['friendly_message']||'Payment\x20is\x20being\x20processed':_0x4bde8e=_0x4bac33[_0x9fc98d(0x13b)]||_0x9fc98d(0x12e);const _0x10a48={'success':_0x40ff2b['status']!==_0x9fc98d(0xe0),'status':_0x40ff2b[_0x9fc98d(0x14a)],'message':_0x4bde8e,'payment':{'id':_0x25d1ed,'status':_0x5cd666['status'],'gateway':'squirrelpay','last4':_0x40ff2b[_0x9fc98d(0x108)]}};_0x40ff2b[_0x9fc98d(0x10c)]&&(_0x10a48['redirect_url']=_0x40ff2b[_0x9fc98d(0x10c)],_0x10a48[_0x9fc98d(0xf6)]=!![],console[_0x9fc98d(0x146)](_0x9fc98d(0x123)+_0x40ff2b[_0x9fc98d(0x10c)])),_0x5ba814[_0x9fc98d(0x139)](_0x10a48);}catch(_0xb89ad2){console[_0x9fc98d(0x112)]('âŒ\x20SquirrelPay\x20card\x20payment\x20error:',_0xb89ad2),_0x473f9f(_0xb89ad2);}},this[_0x1b990b(0x111)]=async(_0x524d87,_0x589bc5,_0x130c1)=>{const _0x32c484=_0x1b990b;try{console['log'](_0x32c484(0x114)),console['log'](_0x32c484(0xfb),_0x524d87[_0x32c484(0xec)]),console[_0x32c484(0x146)]('Body:',_0x524d87[_0x32c484(0x120)]),this['squirrelPayService'][_0x32c484(0x116)]({'headers':_0x524d87[_0x32c484(0xec)],'body':_0x524d87[_0x32c484(0x120)],'timestamp':new Date()[_0x32c484(0x10b)]()});const _0x3fc9e1=_0x524d87['body'];if(!_0x3fc9e1[_0x32c484(0x11d)]||!_0x3fc9e1[_0x32c484(0x14a)])return console[_0x32c484(0x153)](_0x32c484(0x12f)),_0x589bc5[_0x32c484(0x14a)](0x190)[_0x32c484(0x139)]({'success':![],'message':_0x32c484(0xff)});let _0x542884;_0x3fc9e1[_0x32c484(0x11d)]&&(_0x542884=await database_1['default'][_0x32c484(0x101)][_0x32c484(0x131)]({'where':{'gatewayPaymentId':_0x3fc9e1[_0x32c484(0x11d)],'gateway':'squirrelpay'}}));if(!_0x542884)return console[_0x32c484(0x153)]('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x32c484(0x153)](_0x32c484(0x143)+_0x3fc9e1[_0x32c484(0x11d)]),console[_0x32c484(0x153)]('\x20\x20\x20Description:\x20'+_0x3fc9e1[_0x32c484(0x12d)]),console[_0x32c484(0x153)](_0x32c484(0x166)),console[_0x32c484(0x153)](_0x32c484(0x122)+_0x3fc9e1[_0x32c484(0x11d)]),_0x589bc5[_0x32c484(0x14a)](0x194)['json']({'success':![],'message':_0x32c484(0x138)});console[_0x32c484(0x146)](_0x32c484(0x15f)+_0x542884['id']),console[_0x32c484(0x146)](_0x32c484(0x11c)+_0x542884[_0x32c484(0x14a)]),console[_0x32c484(0x146)](_0x32c484(0x151)+_0x542884[_0x32c484(0x135)]),console[_0x32c484(0x146)](_0x32c484(0x14e)+_0x3fc9e1[_0x32c484(0x14a)]),console['log'](_0x32c484(0x13a)+_0x3fc9e1[_0x32c484(0x11d)]);let _0x447ab5=null;const _0x53b64c={};switch(_0x3fc9e1[_0x32c484(0x14a)]){case _0x32c484(0xf7):_0x447ab5=_0x32c484(0x14b),console['log'](_0x32c484(0xf0));break;case'failed':_0x447ab5=_0x32c484(0xe0),_0x53b64c[_0x32c484(0x133)]=_0x3fc9e1[_0x32c484(0x13b)]||_0x3fc9e1[_0x32c484(0x113)]||_0x32c484(0xf3),console[_0x32c484(0x146)](_0x32c484(0x13e)+_0x53b64c['failureMessage']);break;case'incomplete':console[_0x32c484(0x146)](_0x32c484(0x126));break;default:console[_0x32c484(0x153)](_0x32c484(0xf2)+_0x3fc9e1[_0x32c484(0x14a)]);break;}if(_0x447ab5&&_0x447ab5!==_0x542884[_0x32c484(0x14a)])console[_0x32c484(0x146)](_0x32c484(0x150)+_0x542884['status']+'\x20to\x20'+_0x447ab5),await this['webhookService'][_0x32c484(0xf9)](_0x542884['id'],_0x447ab5,_0x53b64c),console['log'](_0x32c484(0xe7)+_0x542884['id']+_0x32c484(0xf8)+_0x447ab5+_0x32c484(0x152));else _0x447ab5&&console['log'](_0x32c484(0xe9)+_0x542884['id']+_0x32c484(0xee)+_0x447ab5+_0x32c484(0xeb));_0x589bc5[_0x32c484(0x14a)](0xc8)[_0x32c484(0x139)]({'success':!![],'message':_0x32c484(0x103)});}catch(_0x5af25f){console[_0x32c484(0x112)](_0x32c484(0x121),_0x5af25f),_0x130c1(_0x5af25f);}},this['getWebhookLogs']=async(_0x402e9f,_0x1767e1,_0x1b07ee)=>{const _0x3bcb83=_0x1b990b;try{const {limit:_0x5b7609}=_0x402e9f[_0x3bcb83(0x145)],_0x5956f8=this[_0x3bcb83(0xf5)][_0x3bcb83(0x15b)](_0x5b7609?parseInt(_0x5b7609):0x32);_0x1767e1['json']({'success':!![],'result':{'logs':_0x5956f8,'count':_0x5956f8[_0x3bcb83(0x129)]}});}catch(_0xcc0889){_0x1b07ee(_0xcc0889);}},this[_0x1b990b(0xf5)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0x1b990b(0x142)][_0x1b990b(0x132)]||'','secretKey':process['env'][_0x1b990b(0x134)]||'','baseUrl':process[_0x1b990b(0x142)][_0x1b990b(0x140)]||_0x1b990b(0xe1),'isTestMode':process[_0x1b990b(0x142)][_0x1b990b(0x154)]===_0x1b990b(0xef)}),this[_0x1b990b(0x147)]=new currencyService_1[(_0x1b990b(0xe8))](),this[_0x1b990b(0x127)]=new webhookService_1[(_0x1b990b(0x162))]();}}exports[a16_0x36c6f8(0x157)]=SquirrelPayController;