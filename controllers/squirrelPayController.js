'use strict';const a19_0xdb63d1=a19_0x5048;(function(_0x2ccb92,_0x5335c5){const _0x43b17c=a19_0x5048,_0x1ffa1c=_0x2ccb92();while(!![]){try{const _0x5bb749=parseInt(_0x43b17c(0x200))/0x1*(parseInt(_0x43b17c(0x1ed))/0x2)+-parseInt(_0x43b17c(0x219))/0x3*(-parseInt(_0x43b17c(0x1e6))/0x4)+parseInt(_0x43b17c(0x239))/0x5+parseInt(_0x43b17c(0x247))/0x6*(-parseInt(_0x43b17c(0x254))/0x7)+-parseInt(_0x43b17c(0x20a))/0x8+-parseInt(_0x43b17c(0x21f))/0x9+parseInt(_0x43b17c(0x23c))/0xa;if(_0x5bb749===_0x5335c5)break;else _0x1ffa1c['push'](_0x1ffa1c['shift']());}catch(_0x4ee3ac){_0x1ffa1c['push'](_0x1ffa1c['shift']());}}}(a19_0x3d8c,0x4ddc6));function a19_0x5048(_0x5f02c3,_0x17f975){_0x5f02c3=_0x5f02c3-0x1e6;const _0x3d8cf0=a19_0x3d8c();let _0x504896=_0x3d8cf0[_0x5f02c3];return _0x504896;}var __importDefault=this&&this['__importDefault']||function(_0x5e94d0){const _0x26626d=a19_0x5048;return _0x5e94d0&&_0x5e94d0[_0x26626d(0x1f1)]?_0x5e94d0:{'default':_0x5e94d0};};Object[a19_0xdb63d1(0x23b)](exports,a19_0xdb63d1(0x1f1),{'value':!![]}),exports[a19_0xdb63d1(0x201)]=void 0x0;const squirrelPayService_1=require(a19_0xdb63d1(0x237)),currencyService_1=require('../services/currencyService'),webhookService_1=require(a19_0xdb63d1(0x24a)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a19_0xdb63d1(0x1f4)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x132997){const _0x5e24a4=a19_0xdb63d1;return ISO_COUNTRY_CODES[_0x5e24a4(0x231)](_0x132997['toUpperCase']());}function a19_0x3d8c(){const _0x13bb8c=['âŒ\x20SquirrelPay\x20webhook\x20error:','update','WebhookService','\x20\x20\x20UID:\x20','3389502ymfKCO','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','cardBrand','../services/webhookService','body','toUpperCase','padStart','Missing\x20required\x20fields\x20in\x20webhook','Payment\x20is\x20not\x20in\x20pending\x20status','squirrelPayService','\x20\x20\x20Webhook\x20status:\x20','brand','not\x20provided','7flRihC','slice','gatewayPaymentId','https://app.trapay.uk','convertToUSDT','failureMessage','redirectUrl','getPaymentStatus','Webhook\x20processed\x20successfully','1065916RIRpRC','lineStatus','log','\x20\x20\x20Gateway:\x20squirrelpay','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','phoneRiskLevel','amountAfterGatewayCommissionUSDT','16zhDjUL','length','query','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','__esModule','\x20commission:\x20','currency','../utils/ipHelper','gatewayCommissionRate','default','currencyService','PAID','phoneIsValid','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','birth_date','ðŸ“\x20SquirrelPay\x20payment\x20details:','\x20\x20\x20Customer:\x20','https://gate.squirrel-pay.com','FAILED','58899yYJwWt','SquirrelPayController','description','warn','uid','json','\x20\x20\x20Payment\x20ID:\x20','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','Payment\x20failed','paidAt','431584PjBRah','ðŸ’°\x20Gateway\x20','\x20\x20\x20Description:\x20','logWebhook','incomplete','params','âœ…\x20Payment\x20','gateway','amountUSDT','Headers:','\x20\x20\x20Webhook\x20UID:\x20','/payment/pending?id=','gatewayOrderId','SquirrelPayService','ðŸ“ž\x20Phone\x20validation\x20data:','3aZkGVs','handleWebhook','/api/webhooks/squirrel-pay','PENDING','https://api.trapay.uk','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','998361xssdCn','Missing\x20required\x20card\x20or\x20customer\x20information','shopId','phoneIsVoip','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','\x20\x20\x20Amount:\x20','isValid','riskLevel','amount','isVoip','Payment\x20is\x20being\x20processed','headers','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','CurrencyService','toString','Payment\x20processed\x20successfully','Payment\x20not\x20found','error','has','processCardPayment','updatePaymentStatus','payment','cardLast4','\x20to\x20','../services/gateways/squirrelPayService','last_4','418805hgdwQR','successful','defineProperty','2272800kwKYaF','squirrelpay','friendly_message','webhookService','payment_method',',\x20balance\x20updated,\x20amountUSDT\x20calculated','status'];a19_0x3d8c=function(){return _0x13bb8c;};return a19_0x3d8c();}class SquirrelPayController{constructor(){const _0x56be41=a19_0xdb63d1;this[_0x56be41(0x232)]=async(_0x8c9587,_0x5e14b9,_0x182d9c)=>{const _0x10a7e0=_0x56be41;try{const {paymentId:_0x403f6e}=_0x8c9587[_0x10a7e0(0x20f)],{card_number:_0x2159b1,exp_month:_0x197e21,exp_year:_0x1e3a7f,cvv:_0x20f9dc,holder_name:_0x5e8df1,customer_email:_0x3be67a,customer_birth_date:_0xcee627,billing_country:_0x134db3,customer_phone:_0x4a53c3,billing_address:_0x3a311c,billing_city:_0x5e1945,billing_state:_0x13c340,billing_zip:_0xa24ca5,phoneValidation:_0x1320f9}=_0x8c9587[_0x10a7e0(0x24b)];console['log'](_0x10a7e0(0x1f0)+_0x403f6e),console[_0x10a7e0(0x1e8)](_0x10a7e0(0x218),_0x1320f9);if(!_0x2159b1||!_0x197e21||!_0x1e3a7f||!_0x20f9dc||!_0x5e8df1||!_0x3be67a)return _0x5e14b9['status'](0x190)['json']({'success':![],'message':_0x10a7e0(0x220)});if(_0x134db3&&!isValidCountryCode(_0x134db3))return _0x5e14b9[_0x10a7e0(0x242)](0x190)['json']({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x4a0cc0=await database_1[_0x10a7e0(0x1f6)]['payment']['findUnique']({'where':{'id':_0x403f6e},'include':{'shop':!![]}});if(!_0x4a0cc0)return _0x5e14b9[_0x10a7e0(0x242)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x4a0cc0[_0x10a7e0(0x242)]!==_0x10a7e0(0x21c))return _0x5e14b9['status'](0x190)[_0x10a7e0(0x205)]({'success':![],'message':_0x10a7e0(0x24f)});const _0xe60869=(0x0,ipHelper_1['getClientIP'])(_0x8c9587),_0x290d84={'number':_0x2159b1['replace'](/\s/g,''),'exp_month':_0x197e21[_0x10a7e0(0x22d)]()[_0x10a7e0(0x24d)](0x2,'0'),'exp_year':_0x1e3a7f[_0x10a7e0(0x22d)](),'verification_value':_0x20f9dc,'holder':_0x5e8df1[_0x10a7e0(0x24c)]()},_0xf592d4={'ip':_0xe60869,'email':_0x3be67a};_0xcee627&&(_0xf592d4[_0x10a7e0(0x1fb)]=_0xcee627);let _0x36b92c;_0x134db3&&(_0x36b92c={'country':_0x134db3,'address':_0x3a311c,'city':_0x5e1945,'state':_0x13c340,'zip':_0xa24ca5});const _0x568b2e=(process.env.FRONTEND_URL||_0x10a7e0(0x257))+_0x10a7e0(0x215)+_0x403f6e+'&payment_id='+(_0x4a0cc0[_0x10a7e0(0x216)]||_0x403f6e),_0x131377=(process.env.API_BASE_URL||_0x10a7e0(0x21d))+_0x10a7e0(0x21b),_0x18a65f=_0x403f6e['slice'](0x0,0x8)+'-'+_0x403f6e[_0x10a7e0(0x255)](0x8,0x10);console[_0x10a7e0(0x1e8)](_0x10a7e0(0x1fc)),console['log'](_0x10a7e0(0x206)+_0x403f6e),console['log'](_0x10a7e0(0x224)+_0x4a0cc0['amount']+'\x20'+_0x4a0cc0[_0x10a7e0(0x1f3)]),console[_0x10a7e0(0x1e8)](_0x10a7e0(0x1fd)+_0x3be67a+'\x20('+_0xe60869+')'),console['log']('\x20\x20\x20Billing\x20Country:\x20'+(_0x134db3||_0x10a7e0(0x253))),console['log']('\x20\x20\x20Description:\x20'+_0x18a65f);const _0x5808df=await this[_0x10a7e0(0x250)][_0x10a7e0(0x232)](Math['round'](_0x4a0cc0[_0x10a7e0(0x227)]*0x64),_0x4a0cc0[_0x10a7e0(0x1f3)],_0x18a65f,_0x568b2e,_0x131377,_0x290d84,_0xf592d4,_0x36b92c,_0x4a53c3),_0x5f5718=this[_0x10a7e0(0x250)][_0x10a7e0(0x25b)](_0x5808df),_0x6395a3={'gatewayPaymentId':_0x5808df[_0x10a7e0(0x204)],'cardLast4':_0x5f5718[_0x10a7e0(0x235)],'gateway':_0x10a7e0(0x23d),'customerEmail':_0x3be67a,'customerPhone':_0x4a53c3,'customerBirthDate':_0xcee627,'billingAddress':_0x3a311c,'billingCity':_0x5e1945,'billingState':_0x13c340,'billingZip':_0xa24ca5,'customerCountry':_0x134db3,'phoneIsValid':_0x1320f9?.[_0x10a7e0(0x225)],'phoneLineStatus':_0x1320f9?.[_0x10a7e0(0x1e7)],'phoneIsVoip':_0x1320f9?.[_0x10a7e0(0x228)],'phoneRiskLevel':_0x1320f9?.[_0x10a7e0(0x226)]};console[_0x10a7e0(0x1e8)]('ðŸ’¾\x20Update\x20data\x20being\x20saved:',{'phoneIsValid':_0x6395a3[_0x10a7e0(0x1f9)],'phoneLineStatus':_0x6395a3['phoneLineStatus'],'phoneIsVoip':_0x6395a3[_0x10a7e0(0x222)],'phoneRiskLevel':_0x6395a3[_0x10a7e0(0x1eb)]});if(_0x5f5718[_0x10a7e0(0x242)]==='PAID'){_0x6395a3['status']=_0x10a7e0(0x1f8),_0x6395a3[_0x10a7e0(0x209)]=new Date();try{const _0x383acb=await this[_0x10a7e0(0x1f7)][_0x10a7e0(0x258)](_0x4a0cc0[_0x10a7e0(0x227)],_0x4a0cc0[_0x10a7e0(0x1f3)]);_0x6395a3[_0x10a7e0(0x212)]=_0x383acb,console[_0x10a7e0(0x1e8)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x383acb+'\x20USDT');const _0x5738fa=await this[_0x10a7e0(0x23f)]['getGatewayCommission'](_0x4a0cc0[_0x10a7e0(0x221)],_0x4a0cc0[_0x10a7e0(0x211)]),_0x4b6906=_0x383acb*(0x1-_0x5738fa/0x64);_0x6395a3[_0x10a7e0(0x1ec)]=_0x4b6906,_0x6395a3['gatewayCommissionRate']=_0x5738fa,console[_0x10a7e0(0x1e8)](_0x10a7e0(0x20b)+_0x4a0cc0['gateway']+_0x10a7e0(0x1f2)+_0x5738fa+'%'),console[_0x10a7e0(0x1e8)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x4b6906['toFixed'](0x6)+'\x20USDT');}catch(_0x6a6f0e){console[_0x10a7e0(0x230)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x6a6f0e),_0x6395a3[_0x10a7e0(0x212)]=0x0,_0x6395a3[_0x10a7e0(0x1ec)]=0x0,_0x6395a3[_0x10a7e0(0x1f5)]=0x0;}}else _0x5f5718['status']===_0x10a7e0(0x1ff)&&(_0x6395a3[_0x10a7e0(0x242)]=_0x10a7e0(0x1ff),_0x6395a3['failureMessage']=_0x5f5718[_0x10a7e0(0x259)]);const _0x4eff41=await database_1[_0x10a7e0(0x1f6)][_0x10a7e0(0x234)][_0x10a7e0(0x244)]({'where':{'id':_0x403f6e},'data':_0x6395a3});console[_0x10a7e0(0x1e8)](_0x10a7e0(0x207)+_0x4eff41[_0x10a7e0(0x242)]);let _0x4aed16;if(_0x5f5718['status']==='FAILED')_0x4aed16=_0x5f5718[_0x10a7e0(0x259)]||_0x5808df['friendly_message']||_0x10a7e0(0x208);else _0x5f5718[_0x10a7e0(0x242)]===_0x10a7e0(0x21c)?_0x4aed16=_0x5808df[_0x10a7e0(0x23e)]||_0x10a7e0(0x229):_0x4aed16=_0x5808df[_0x10a7e0(0x23e)]||_0x10a7e0(0x22e);const _0x5a1090={'success':_0x5f5718[_0x10a7e0(0x242)]!==_0x10a7e0(0x1ff),'status':_0x5f5718[_0x10a7e0(0x242)],'message':_0x4aed16,'payment':{'id':_0x403f6e,'status':_0x4eff41[_0x10a7e0(0x242)],'gateway':'squirrelpay','last4':_0x5f5718[_0x10a7e0(0x235)]}};_0x5f5718[_0x10a7e0(0x25a)]&&(_0x5a1090['redirect_url']=_0x5f5718[_0x10a7e0(0x25a)],_0x5a1090['requires_action']=!![],console[_0x10a7e0(0x1e8)](_0x10a7e0(0x22b)+_0x5f5718['redirectUrl'])),_0x5e14b9[_0x10a7e0(0x205)](_0x5a1090);}catch(_0x21af84){console[_0x10a7e0(0x230)](_0x10a7e0(0x21e),_0x21af84),_0x182d9c(_0x21af84);}},this[_0x56be41(0x21a)]=async(_0x2af36e,_0x4a459b,_0x20e5a6)=>{const _0x403fa2=_0x56be41;try{console[_0x403fa2(0x1e8)](_0x403fa2(0x223)),console['log'](_0x403fa2(0x213),_0x2af36e[_0x403fa2(0x22a)]),console['log']('Body:',_0x2af36e[_0x403fa2(0x24b)]),this[_0x403fa2(0x250)][_0x403fa2(0x20d)]({'headers':_0x2af36e[_0x403fa2(0x22a)],'body':_0x2af36e[_0x403fa2(0x24b)],'timestamp':new Date()['toISOString']()});const _0x41c45c=_0x2af36e[_0x403fa2(0x24b)];if(!_0x41c45c['uid']||!_0x41c45c[_0x403fa2(0x242)])return console[_0x403fa2(0x203)]('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x4a459b[_0x403fa2(0x242)](0x190)[_0x403fa2(0x205)]({'success':![],'message':_0x403fa2(0x24e)});let _0x2bbe37;_0x41c45c['uid']&&(_0x2bbe37=await database_1[_0x403fa2(0x1f6)][_0x403fa2(0x234)]['findFirst']({'where':{'gatewayPaymentId':_0x41c45c[_0x403fa2(0x204)],'gateway':'squirrelpay'}}));if(!_0x2bbe37)return console['warn']('âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console[_0x403fa2(0x203)](_0x403fa2(0x246)+_0x41c45c[_0x403fa2(0x204)]),console[_0x403fa2(0x203)](_0x403fa2(0x20c)+_0x41c45c[_0x403fa2(0x202)]),console[_0x403fa2(0x203)](_0x403fa2(0x1e9)),console[_0x403fa2(0x203)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x41c45c[_0x403fa2(0x204)]),_0x4a459b[_0x403fa2(0x242)](0x194)[_0x403fa2(0x205)]({'success':![],'message':_0x403fa2(0x22f)});console[_0x403fa2(0x1e8)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x2bbe37['id']),console[_0x403fa2(0x1e8)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x2bbe37['status']),console[_0x403fa2(0x1e8)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x2bbe37[_0x403fa2(0x256)]),console[_0x403fa2(0x1e8)](_0x403fa2(0x251)+_0x41c45c[_0x403fa2(0x242)]),console['log'](_0x403fa2(0x214)+_0x41c45c[_0x403fa2(0x204)]);let _0x1f341b=null;const _0x10b24c={};_0x41c45c[_0x403fa2(0x240)]?.[_0x403fa2(0x252)]&&(_0x10b24c[_0x403fa2(0x249)]=_0x41c45c[_0x403fa2(0x240)][_0x403fa2(0x252)],console[_0x403fa2(0x1e8)]('ðŸ’³\x20Card\x20brand\x20detected:\x20'+_0x41c45c['payment_method'][_0x403fa2(0x252)]));_0x41c45c[_0x403fa2(0x240)]?.[_0x403fa2(0x238)]&&(_0x10b24c[_0x403fa2(0x235)]=_0x41c45c['payment_method'][_0x403fa2(0x238)],console[_0x403fa2(0x1e8)]('ðŸ’³\x20Card\x20last\x204:\x20'+_0x41c45c[_0x403fa2(0x240)][_0x403fa2(0x238)]));switch(_0x41c45c[_0x403fa2(0x242)]){case _0x403fa2(0x23a):_0x1f341b=_0x403fa2(0x1f8),console['log']('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case'failed':_0x1f341b=_0x403fa2(0x1ff),_0x10b24c['failureMessage']=_0x41c45c[_0x403fa2(0x23e)]||_0x41c45c['message']||_0x403fa2(0x208),console['log'](_0x403fa2(0x248)+_0x10b24c[_0x403fa2(0x259)]);break;case _0x403fa2(0x20e):console[_0x403fa2(0x1e8)]('â³\x20Payment\x20remains\x20PENDING\x20(incomplete)');break;default:console[_0x403fa2(0x203)](_0x403fa2(0x1ea)+_0x41c45c['status']);break;}if(_0x1f341b&&_0x1f341b!==_0x2bbe37['status'])console[_0x403fa2(0x1e8)](_0x403fa2(0x1fa)+_0x2bbe37[_0x403fa2(0x242)]+_0x403fa2(0x236)+_0x1f341b),await this[_0x403fa2(0x23f)][_0x403fa2(0x233)](_0x2bbe37['id'],_0x1f341b,_0x10b24c),console[_0x403fa2(0x1e8)](_0x403fa2(0x210)+_0x2bbe37['id']+'\x20updated:\x20status='+_0x1f341b+_0x403fa2(0x241));else _0x1f341b&&console[_0x403fa2(0x1e8)]('â„¹ï¸\x20Payment\x20'+_0x2bbe37['id']+'\x20already\x20has\x20status\x20'+_0x1f341b+',\x20skipping\x20update');_0x4a459b['status'](0xc8)[_0x403fa2(0x205)]({'success':!![],'message':_0x403fa2(0x25c)});}catch(_0x553062){console[_0x403fa2(0x230)](_0x403fa2(0x243),_0x553062),_0x20e5a6(_0x553062);}},this['getWebhookLogs']=async(_0x389464,_0x25843b,_0x5038f4)=>{const _0x324c54=_0x56be41;try{const {limit:_0x13be22}=_0x389464[_0x324c54(0x1ef)],_0x1e3063=this[_0x324c54(0x250)]['getWebhookLogs'](_0x13be22?parseInt(_0x13be22):0x32);_0x25843b[_0x324c54(0x205)]({'success':!![],'result':{'logs':_0x1e3063,'count':_0x1e3063[_0x324c54(0x1ee)]}});}catch(_0x16eaf8){_0x5038f4(_0x16eaf8);}},this[_0x56be41(0x250)]=new squirrelPayService_1[(_0x56be41(0x217))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||_0x56be41(0x1fe),'isTestMode':process.env.SQUIRREL_PAY_TEST_MODE==='true'}),this['currencyService']=new currencyService_1[(_0x56be41(0x22c))](),this[_0x56be41(0x23f)]=new webhookService_1[(_0x56be41(0x245))]();}}exports[a19_0xdb63d1(0x201)]=SquirrelPayController;