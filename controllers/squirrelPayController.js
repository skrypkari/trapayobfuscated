'use strict';function a17_0x46b5(){const _0x9c3f58=['getWebhookLogs','failureMessage','Body:','133960bdHtNG','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','SQUIRREL_PAY_SECRET_KEY','redirectUrl','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','payment','shopId','payment_method','squirrelPayService','friendly_message','cardLast4','https://api.trapay.uk','incomplete','\x20\x20\x20Gateway:\x20squirrelpay','padStart','squirrelpay','9mgqEVs','10CCIyCA','\x20updated:\x20status=',',\x20skipping\x20update','headers',',\x20balance\x20updated,\x20amountUSDT\x20calculated','ðŸ’°\x20Calculated\x20amountUSDT:\x20','\x20\x20\x20Webhook\x20status:\x20','âŒ\x20SquirrelPay\x20webhook\x20error:','webhookService','WebhookService','currencyService','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','ðŸ’³\x20Card\x20brand\x20detected:\x20','PAID','json','\x20to\x20','amountUSDT','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','last_4','SQUIRREL_PAY_SHOP_ID','690588sALOyB','2582379OtBWSX','119MCMjtd','toISOString','birth_date','gatewayPaymentId','1033711zQeDLM','__esModule','API_BASE_URL','successful','CurrencyService','amount','5256040jQHEBB','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','../utils/ipHelper','redirect_url','gateway','SQUIRREL_PAY_TEST_MODE','brand','toString','ðŸ’°\x20Gateway\x20','\x20USDT','has','not\x20provided','processCardPayment','â„¹ï¸\x20Payment\x20','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','FAILED','gatewayCommissionRate','replace','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','../services/currencyService','Headers:','getPaymentStatus','FRONTEND_URL','ðŸ’³\x20Card\x20last\x204:\x20','SQUIRREL_PAY_BASE_URL','gatewayOrderId','âœ…\x20Payment\x20','round','\x20\x20\x20Amount:\x20','https://app.trapay.uk','length','\x20\x20\x20Billing\x20Country:\x20','../services/webhookService','Missing\x20required\x20card\x20or\x20customer\x20information','&payment_id=','description','log','https://gate.squirrel-pay.com','\x20\x20\x20Description:\x20','update','PENDING','21080030WzKdTq','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','\x20already\x20has\x20status\x20','error','currency','SquirrelPayService','/payment/pending?id=','env','default','amountAfterGatewayCommissionUSDT','toFixed','failed','getGatewayCommission','params','status','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','3814316PoPLLZ','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','paidAt','handleWebhook','Payment\x20processed\x20successfully','Payment\x20not\x20found','uid','/api/webhooks/squirrel-pay','slice','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','Webhook\x20processed\x20successfully','warn','body','Missing\x20required\x20fields\x20in\x20webhook','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','\x20commission:\x20','defineProperty','toUpperCase','Payment\x20failed','Payment\x20is\x20not\x20in\x20pending\x20status'];a17_0x46b5=function(){return _0x9c3f58;};return a17_0x46b5();}const a17_0x207b46=a17_0x3541;(function(_0x4c59d4,_0x1d0fd5){const _0x442cc7=a17_0x3541,_0x2c2f3e=_0x4c59d4();while(!![]){try{const _0x314340=-parseInt(_0x442cc7(0x159))/0x1+-parseInt(_0x442cc7(0x115))/0x2+-parseInt(_0x442cc7(0x154))/0x3+-parseInt(_0x442cc7(0x12c))/0x4*(-parseInt(_0x442cc7(0x13d))/0x5)+parseInt(_0x442cc7(0x153))/0x6*(parseInt(_0x442cc7(0x155))/0x7)+parseInt(_0x442cc7(0x15f))/0x8+-parseInt(_0x442cc7(0x13c))/0x9*(-parseInt(_0x442cc7(0x189))/0xa);if(_0x314340===_0x1d0fd5)break;else _0x2c2f3e['push'](_0x2c2f3e['shift']());}catch(_0x31420a){_0x2c2f3e['push'](_0x2c2f3e['shift']());}}}(a17_0x46b5,0xf0f70));function a17_0x3541(_0x559bb0,_0x3a3d02){_0x559bb0=_0x559bb0-0x10a;const _0x46b5ae=a17_0x46b5();let _0x354181=_0x46b5ae[_0x559bb0];return _0x354181;}var __importDefault=this&&this['__importDefault']||function(_0x491fbf){const _0x524ffe=a17_0x3541;return _0x491fbf&&_0x491fbf[_0x524ffe(0x15a)]?_0x491fbf:{'default':_0x491fbf};};Object[a17_0x207b46(0x125)](exports,a17_0x207b46(0x15a),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a17_0x207b46(0x173)),webhookService_1=require(a17_0x207b46(0x180)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a17_0x207b46(0x161)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x2558b0){const _0x40c8f7=a17_0x207b46;return ISO_COUNTRY_CODES[_0x40c8f7(0x169)](_0x2558b0['toUpperCase']());}class SquirrelPayController{constructor(){const _0x33a211=a17_0x207b46;this[_0x33a211(0x16b)]=async(_0x53b04a,_0x2a8c67,_0x2417b0)=>{const _0x430abd=_0x33a211;try{const {paymentId:_0xfe42c9}=_0x53b04a[_0x430abd(0x112)],{card_number:_0x590952,exp_month:_0x4230a8,exp_year:_0x4a4438,cvv:_0x88fc2d,holder_name:_0x134159,customer_email:_0x3e63d2,customer_birth_date:_0x425612,billing_country:_0x4f7120,customer_phone:_0x5e800b,billing_address:_0x74cb3,billing_city:_0x47180f,billing_state:_0x16dbdd,billing_zip:_0x379a31}=_0x53b04a[_0x430abd(0x121)];console['log'](_0x430abd(0x150)+_0xfe42c9);if(!_0x590952||!_0x4230a8||!_0x4a4438||!_0x88fc2d||!_0x134159||!_0x3e63d2)return _0x2a8c67[_0x430abd(0x113)](0x190)[_0x430abd(0x14c)]({'success':![],'message':_0x430abd(0x181)});if(_0x4f7120&&!isValidCountryCode(_0x4f7120))return _0x2a8c67[_0x430abd(0x113)](0x190)[_0x430abd(0x14c)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x3ee4a8=await database_1[_0x430abd(0x10d)][_0x430abd(0x131)]['findUnique']({'where':{'id':_0xfe42c9},'include':{'shop':!![]}});if(!_0x3ee4a8)return _0x2a8c67[_0x430abd(0x113)](0x194)[_0x430abd(0x14c)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3ee4a8[_0x430abd(0x113)]!==_0x430abd(0x188))return _0x2a8c67[_0x430abd(0x113)](0x190)[_0x430abd(0x14c)]({'success':![],'message':_0x430abd(0x128)});const _0x6ded8f=(0x0,ipHelper_1['getClientIP'])(_0x53b04a),_0x234292={'number':_0x590952[_0x430abd(0x171)](/\s/g,''),'exp_month':_0x4230a8[_0x430abd(0x166)]()[_0x430abd(0x13a)](0x2,'0'),'exp_year':_0x4a4438[_0x430abd(0x166)](),'verification_value':_0x88fc2d,'holder':_0x134159[_0x430abd(0x126)]()},_0x313b52={'ip':_0x6ded8f,'email':_0x3e63d2};_0x425612&&(_0x313b52[_0x430abd(0x157)]=_0x425612);let _0xa20a7f;_0x4f7120&&(_0xa20a7f={'country':_0x4f7120,'address':_0x74cb3,'city':_0x47180f,'state':_0x16dbdd,'zip':_0x379a31});const _0x3f40ff=(process['env'][_0x430abd(0x176)]||_0x430abd(0x17d))+_0x430abd(0x10b)+_0xfe42c9+_0x430abd(0x182)+(_0x3ee4a8[_0x430abd(0x179)]||_0xfe42c9),_0x3f9024=(process[_0x430abd(0x10c)][_0x430abd(0x15b)]||_0x430abd(0x137))+_0x430abd(0x11c),_0x6b0db0=_0xfe42c9[_0x430abd(0x11d)](0x0,0x8)+'-'+_0xfe42c9[_0x430abd(0x11d)](0x8,0x10);console[_0x430abd(0x184)](_0x430abd(0x149)),console[_0x430abd(0x184)]('\x20\x20\x20Payment\x20ID:\x20'+_0xfe42c9),console[_0x430abd(0x184)](_0x430abd(0x17c)+_0x3ee4a8[_0x430abd(0x15e)]+'\x20'+_0x3ee4a8[_0x430abd(0x18d)]),console['log']('\x20\x20\x20Customer:\x20'+_0x3e63d2+'\x20('+_0x6ded8f+')'),console[_0x430abd(0x184)](_0x430abd(0x17f)+(_0x4f7120||_0x430abd(0x16a))),console[_0x430abd(0x184)](_0x430abd(0x186)+_0x6b0db0);const _0x5f948=await this[_0x430abd(0x134)][_0x430abd(0x16b)](Math[_0x430abd(0x17b)](_0x3ee4a8[_0x430abd(0x15e)]*0x64),_0x3ee4a8[_0x430abd(0x18d)],_0x6b0db0,_0x3f40ff,_0x3f9024,_0x234292,_0x313b52,_0xa20a7f,_0x5e800b),_0xe6c882=this[_0x430abd(0x134)][_0x430abd(0x175)](_0x5f948),_0x12a9b6={'gatewayPaymentId':_0x5f948[_0x430abd(0x11b)],'cardLast4':_0xe6c882[_0x430abd(0x136)],'gateway':_0x430abd(0x13b),'customerEmail':_0x3e63d2,'customerPhone':_0x5e800b,'customerBirthDate':_0x425612,'billingAddress':_0x74cb3,'billingCity':_0x47180f,'billingState':_0x16dbdd,'billingZip':_0x379a31,'customerCountry':_0x4f7120};if(_0xe6c882[_0x430abd(0x113)]==='PAID'){_0x12a9b6[_0x430abd(0x113)]='PAID',_0x12a9b6[_0x430abd(0x117)]=new Date();try{const _0x3140f1=await this[_0x430abd(0x147)]['convertToUSDT'](_0x3ee4a8[_0x430abd(0x15e)],_0x3ee4a8[_0x430abd(0x18d)]);_0x12a9b6['amountUSDT']=_0x3140f1,console[_0x430abd(0x184)](_0x430abd(0x142)+_0x3140f1+_0x430abd(0x168));const _0x3f2c5c=await this['webhookService'][_0x430abd(0x111)](_0x3ee4a8[_0x430abd(0x132)],_0x3ee4a8['gateway']),_0x5ba15c=_0x3140f1*(0x1-_0x3f2c5c/0x64);_0x12a9b6[_0x430abd(0x10e)]=_0x5ba15c,_0x12a9b6[_0x430abd(0x170)]=_0x3f2c5c,console[_0x430abd(0x184)](_0x430abd(0x167)+_0x3ee4a8[_0x430abd(0x163)]+_0x430abd(0x124)+_0x3f2c5c+'%'),console['log'](_0x430abd(0x12d)+_0x5ba15c[_0x430abd(0x10f)](0x6)+_0x430abd(0x168));}catch(_0x2eacd8){console['error'](_0x430abd(0x160),_0x2eacd8),_0x12a9b6[_0x430abd(0x14e)]=0x0,_0x12a9b6[_0x430abd(0x10e)]=0x0,_0x12a9b6['gatewayCommissionRate']=0x0;}}else _0xe6c882[_0x430abd(0x113)]===_0x430abd(0x16f)&&(_0x12a9b6['status']=_0x430abd(0x16f),_0x12a9b6[_0x430abd(0x12a)]=_0xe6c882['failureMessage']);const _0x4387cb=await database_1['default']['payment'][_0x430abd(0x187)]({'where':{'id':_0xfe42c9},'data':_0x12a9b6});console[_0x430abd(0x184)](_0x430abd(0x130)+_0x4387cb[_0x430abd(0x113)]);let _0x4a4057;if(_0xe6c882[_0x430abd(0x113)]==='FAILED')_0x4a4057=_0xe6c882[_0x430abd(0x12a)]||_0x5f948[_0x430abd(0x135)]||_0x430abd(0x127);else _0xe6c882[_0x430abd(0x113)]===_0x430abd(0x188)?_0x4a4057=_0x5f948['friendly_message']||'Payment\x20is\x20being\x20processed':_0x4a4057=_0x5f948['friendly_message']||_0x430abd(0x119);const _0xefcc9b={'success':_0xe6c882[_0x430abd(0x113)]!==_0x430abd(0x16f),'status':_0xe6c882[_0x430abd(0x113)],'message':_0x4a4057,'payment':{'id':_0xfe42c9,'status':_0x4387cb[_0x430abd(0x113)],'gateway':'squirrelpay','last4':_0xe6c882[_0x430abd(0x136)]}};_0xe6c882[_0x430abd(0x12f)]&&(_0xefcc9b[_0x430abd(0x162)]=_0xe6c882[_0x430abd(0x12f)],_0xefcc9b['requires_action']=!![],console[_0x430abd(0x184)](_0x430abd(0x148)+_0xe6c882[_0x430abd(0x12f)])),_0x2a8c67[_0x430abd(0x14c)](_0xefcc9b);}catch(_0x10bf91){console[_0x430abd(0x18c)](_0x430abd(0x172),_0x10bf91),_0x2417b0(_0x10bf91);}},this[_0x33a211(0x118)]=async(_0x2ab9ff,_0x241662,_0x184f67)=>{const _0x186d28=_0x33a211;try{console['log'](_0x186d28(0x123)),console[_0x186d28(0x184)](_0x186d28(0x174),_0x2ab9ff['headers']),console[_0x186d28(0x184)](_0x186d28(0x12b),_0x2ab9ff[_0x186d28(0x121)]),this[_0x186d28(0x134)]['logWebhook']({'headers':_0x2ab9ff[_0x186d28(0x140)],'body':_0x2ab9ff['body'],'timestamp':new Date()[_0x186d28(0x156)]()});const _0x510306=_0x2ab9ff[_0x186d28(0x121)];if(!_0x510306[_0x186d28(0x11b)]||!_0x510306[_0x186d28(0x113)])return console[_0x186d28(0x120)]('âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x241662['status'](0x190)[_0x186d28(0x14c)]({'success':![],'message':_0x186d28(0x122)});let _0x43f106;_0x510306[_0x186d28(0x11b)]&&(_0x43f106=await database_1[_0x186d28(0x10d)][_0x186d28(0x131)]['findFirst']({'where':{'gatewayPaymentId':_0x510306['uid'],'gateway':_0x186d28(0x13b)}}));if(!_0x43f106)return console['warn'](_0x186d28(0x11e)),console[_0x186d28(0x120)]('\x20\x20\x20UID:\x20'+_0x510306['uid']),console[_0x186d28(0x120)](_0x186d28(0x186)+_0x510306[_0x186d28(0x183)]),console[_0x186d28(0x120)](_0x186d28(0x139)),console['warn']('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x510306[_0x186d28(0x11b)]),_0x241662[_0x186d28(0x113)](0x194)[_0x186d28(0x14c)]({'success':![],'message':_0x186d28(0x11a)});console['log']('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x43f106['id']),console[_0x186d28(0x184)](_0x186d28(0x16d)+_0x43f106[_0x186d28(0x113)]),console[_0x186d28(0x184)](_0x186d28(0x114)+_0x43f106[_0x186d28(0x158)]),console[_0x186d28(0x184)](_0x186d28(0x143)+_0x510306['status']),console[_0x186d28(0x184)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x510306[_0x186d28(0x11b)]);let _0x3395c2=null;const _0x281de2={};_0x510306[_0x186d28(0x133)]?.[_0x186d28(0x165)]&&(_0x281de2['cardBrand']=_0x510306[_0x186d28(0x133)][_0x186d28(0x165)],console[_0x186d28(0x184)](_0x186d28(0x14a)+_0x510306[_0x186d28(0x133)]['brand']));_0x510306[_0x186d28(0x133)]?.['last_4']&&(_0x281de2[_0x186d28(0x136)]=_0x510306[_0x186d28(0x133)][_0x186d28(0x151)],console[_0x186d28(0x184)](_0x186d28(0x177)+_0x510306[_0x186d28(0x133)][_0x186d28(0x151)]));switch(_0x510306[_0x186d28(0x113)]){case _0x186d28(0x15c):_0x3395c2=_0x186d28(0x14b),console[_0x186d28(0x184)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x186d28(0x110):_0x3395c2='FAILED',_0x281de2[_0x186d28(0x12a)]=_0x510306[_0x186d28(0x135)]||_0x510306['message']||'Payment\x20failed',console[_0x186d28(0x184)](_0x186d28(0x116)+_0x281de2[_0x186d28(0x12a)]);break;case _0x186d28(0x138):console[_0x186d28(0x184)](_0x186d28(0x16e));break;default:console[_0x186d28(0x120)](_0x186d28(0x14f)+_0x510306[_0x186d28(0x113)]);break;}if(_0x3395c2&&_0x3395c2!==_0x43f106['status'])console[_0x186d28(0x184)](_0x186d28(0x18a)+_0x43f106['status']+_0x186d28(0x14d)+_0x3395c2),await this[_0x186d28(0x145)]['updatePaymentStatus'](_0x43f106['id'],_0x3395c2,_0x281de2),console[_0x186d28(0x184)](_0x186d28(0x17a)+_0x43f106['id']+_0x186d28(0x13e)+_0x3395c2+_0x186d28(0x141));else _0x3395c2&&console[_0x186d28(0x184)](_0x186d28(0x16c)+_0x43f106['id']+_0x186d28(0x18b)+_0x3395c2+_0x186d28(0x13f));_0x241662[_0x186d28(0x113)](0xc8)[_0x186d28(0x14c)]({'success':!![],'message':_0x186d28(0x11f)});}catch(_0x518817){console['error'](_0x186d28(0x144),_0x518817),_0x184f67(_0x518817);}},this[_0x33a211(0x129)]=async(_0x313d99,_0x49f997,_0x100e22)=>{const _0x52f18e=_0x33a211;try{const {limit:_0x454ef6}=_0x313d99['query'],_0x1094e5=this[_0x52f18e(0x134)][_0x52f18e(0x129)](_0x454ef6?parseInt(_0x454ef6):0x32);_0x49f997['json']({'success':!![],'result':{'logs':_0x1094e5,'count':_0x1094e5[_0x52f18e(0x17e)]}});}catch(_0x44f2e5){_0x100e22(_0x44f2e5);}},this[_0x33a211(0x134)]=new squirrelPayService_1[(_0x33a211(0x10a))]({'shopId':process[_0x33a211(0x10c)][_0x33a211(0x152)]||'','secretKey':process[_0x33a211(0x10c)][_0x33a211(0x12e)]||'','baseUrl':process[_0x33a211(0x10c)][_0x33a211(0x178)]||_0x33a211(0x185),'isTestMode':process[_0x33a211(0x10c)][_0x33a211(0x164)]==='true'}),this[_0x33a211(0x147)]=new currencyService_1[(_0x33a211(0x15d))](),this[_0x33a211(0x145)]=new webhookService_1[(_0x33a211(0x146))]();}}exports['SquirrelPayController']=SquirrelPayController;