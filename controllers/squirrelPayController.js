'use strict';const a19_0x4f5f7a=a19_0xa75a;(function(_0x59dfe3,_0x1b0bab){const _0x3d0060=a19_0xa75a,_0x386e9c=_0x59dfe3();while(!![]){try{const _0x230f5d=parseInt(_0x3d0060(0x1b1))/0x1*(-parseInt(_0x3d0060(0x1a3))/0x2)+-parseInt(_0x3d0060(0x18d))/0x3+parseInt(_0x3d0060(0x1a7))/0x4+-parseInt(_0x3d0060(0x16e))/0x5*(-parseInt(_0x3d0060(0x1c3))/0x6)+-parseInt(_0x3d0060(0x1c2))/0x7*(-parseInt(_0x3d0060(0x1cd))/0x8)+parseInt(_0x3d0060(0x180))/0x9+-parseInt(_0x3d0060(0x15b))/0xa;if(_0x230f5d===_0x1b0bab)break;else _0x386e9c['push'](_0x386e9c['shift']());}catch(_0x21c4f1){_0x386e9c['push'](_0x386e9c['shift']());}}}(a19_0x56de,0x3c4a7));function a19_0x56de(){const _0x55537f=['\x20to\x20','birth_date','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','last_4','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','19658ftpeXk','handleWebhook','\x20\x20\x20Webhook\x20status:\x20','logWebhook','1227308SlhTwT','CurrencyService','Payment\x20not\x20found','ðŸ“\x20SquirrelPay\x20payment\x20details:','ðŸ’³\x20Card\x20brand\x20detected:\x20','SquirrelPayController','phoneRiskLevel','https://app.trapay.uk','shopId','&payment_id=','35iqsfdB','currency','/api/webhooks/squirrel-pay','json','https://api.trapay.uk','../services/gateways/squirrelPayService','lineStatus','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','uid','has','Payment\x20is\x20being\x20processed','Webhook\x20processed\x20successfully','\x20commission:\x20','update','../utils/ipHelper','Missing\x20required\x20fields\x20in\x20webhook','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','166523GfcUOv','6DpdRro','redirectUrl','toString','warn','Headers:','phoneIsValid','getWebhookLogs','failed','isVoip','cardLast4','104syAoWm','isValid','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','padStart','params','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','true','redirect_url','gateway','\x20\x20\x20Gateway:\x20squirrelpay','../config/database','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','getClientIP','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','ðŸ’°\x20Calculated\x20amountUSDT:\x20','toFixed','214770xZwZIz','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','error','\x20\x20\x20Payment\x20ID:\x20','FAILED','SquirrelPayService','description','WebhookService','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','Missing\x20required\x20card\x20or\x20customer\x20information','webhookService','log',',\x20skipping\x20update','replace','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','ðŸ’¾\x20Update\x20data\x20being\x20saved:','ðŸ’³\x20Card\x20last\x204:\x20','gatewayPaymentId','toUpperCase','1750090yRkVut','cardBrand','Payment\x20is\x20not\x20in\x20pending\x20status','/payment/pending?id=','\x20USDT','payment','friendly_message','ðŸ“ž\x20Phone\x20validation\x20data:','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','currencyService','PAID','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','brand','paidAt','getPaymentStatus','failureMessage','default','toISOString','272790SxbpcZ','squirrelPayService','\x20\x20\x20Description:\x20','__importDefault','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','âŒ\x20SquirrelPay\x20webhook\x20error:','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','squirrelpay','requires_action','amount','status','findUnique','headers','1151907eEUvlv','body','processCardPayment','amountAfterGatewayCommissionUSDT','phoneIsVoip','riskLevel','successful','PENDING','payment_method','__esModule','round','slice','gatewayCommissionRate','Payment\x20failed','message','getGatewayCommission'];a19_0x56de=function(){return _0x55537f;};return a19_0x56de();}var __importDefault=this&&this[a19_0x4f5f7a(0x183)]||function(_0x19d29c){const _0x3ceb04=a19_0x4f5f7a;return _0x19d29c&&_0x19d29c[_0x3ceb04(0x196)]?_0x19d29c:{'default':_0x19d29c};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a19_0x4f5f7a(0x1ac)]=void 0x0;const squirrelPayService_1=require(a19_0x4f5f7a(0x1b6)),currencyService_1=require('../services/currencyService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a19_0x4f5f7a(0x155))),ipHelper_1=require(a19_0x4f5f7a(0x1bf)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x32a41e){const _0x4bc634=a19_0x4f5f7a;return ISO_COUNTRY_CODES[_0x4bc634(0x1ba)](_0x32a41e[_0x4bc634(0x16d)]());}class SquirrelPayController{constructor(){const _0x141623=a19_0x4f5f7a;this[_0x141623(0x18f)]=async(_0x15e2c1,_0x2c1a78,_0x54e917)=>{const _0x5db6ff=_0x141623;try{const {paymentId:_0x2ba724}=_0x15e2c1[_0x5db6ff(0x14f)],{card_number:_0xf10b3a,exp_month:_0x4432eb,exp_year:_0x7fb009,cvv:_0x3b54f5,holder_name:_0x54efb8,customer_email:_0x47201b,customer_birth_date:_0x557e90,billing_country:_0x2bc04a,customer_phone:_0x47b72e,billing_address:_0x1f2cbe,billing_city:_0x311cab,billing_state:_0x5793ab,billing_zip:_0x1b5194,phoneValidation:_0x581f11}=_0x15e2c1[_0x5db6ff(0x18e)];console[_0x5db6ff(0x166)](_0x5db6ff(0x15c)+_0x2ba724),console[_0x5db6ff(0x166)](_0x5db6ff(0x175),_0x581f11);if(!_0xf10b3a||!_0x4432eb||!_0x7fb009||!_0x3b54f5||!_0x54efb8||!_0x47201b)return _0x2c1a78[_0x5db6ff(0x18a)](0x190)['json']({'success':![],'message':_0x5db6ff(0x164)});if(_0x2bc04a&&!isValidCountryCode(_0x2bc04a))return _0x2c1a78['status'](0x190)['json']({'success':![],'message':_0x5db6ff(0x1a2)});const _0x4020aa=await database_1[_0x5db6ff(0x17e)][_0x5db6ff(0x173)][_0x5db6ff(0x18b)]({'where':{'id':_0x2ba724},'include':{'shop':!![]}});if(!_0x4020aa)return _0x2c1a78[_0x5db6ff(0x18a)](0x194)[_0x5db6ff(0x1b4)]({'success':![],'message':_0x5db6ff(0x1a9)});if(_0x4020aa[_0x5db6ff(0x18a)]!==_0x5db6ff(0x194))return _0x2c1a78[_0x5db6ff(0x18a)](0x190)[_0x5db6ff(0x1b4)]({'success':![],'message':_0x5db6ff(0x170)});const _0x5c5f50=(0x0,ipHelper_1[_0x5db6ff(0x157)])(_0x15e2c1),_0x59f061={'number':_0xf10b3a[_0x5db6ff(0x168)](/\s/g,''),'exp_month':_0x4432eb['toString']()[_0x5db6ff(0x14e)](0x2,'0'),'exp_year':_0x7fb009[_0x5db6ff(0x1c5)](),'verification_value':_0x3b54f5,'holder':_0x54efb8[_0x5db6ff(0x16d)]()},_0x1d93d3={'ip':_0x5c5f50,'email':_0x47201b};_0x557e90&&(_0x1d93d3[_0x5db6ff(0x19e)]=_0x557e90);let _0x271c4d;_0x2bc04a&&(_0x271c4d={'country':_0x2bc04a,'address':_0x1f2cbe,'city':_0x311cab,'state':_0x5793ab,'zip':_0x1b5194});const _0x41e3d1=(process.env.FRONTEND_URL||_0x5db6ff(0x1ae))+_0x5db6ff(0x171)+_0x2ba724+_0x5db6ff(0x1b0)+(_0x4020aa['gatewayOrderId']||_0x2ba724),_0x2758c8=(process.env.API_BASE_URL||_0x5db6ff(0x1b5))+_0x5db6ff(0x1b3),_0x35273d=_0x2ba724[_0x5db6ff(0x198)](0x0,0x8)+'-'+_0x2ba724[_0x5db6ff(0x198)](0x8,0x10);console[_0x5db6ff(0x166)](_0x5db6ff(0x1aa)),console[_0x5db6ff(0x166)](_0x5db6ff(0x15e)+_0x2ba724),console[_0x5db6ff(0x166)]('\x20\x20\x20Amount:\x20'+_0x4020aa['amount']+'\x20'+_0x4020aa[_0x5db6ff(0x1b2)]),console[_0x5db6ff(0x166)]('\x20\x20\x20Customer:\x20'+_0x47201b+'\x20('+_0x5c5f50+')'),console[_0x5db6ff(0x166)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x2bc04a||'not\x20provided')),console['log'](_0x5db6ff(0x182)+_0x35273d);const _0x212554=await this[_0x5db6ff(0x181)]['processCardPayment'](Math[_0x5db6ff(0x197)](_0x4020aa[_0x5db6ff(0x189)]*0x64),_0x4020aa[_0x5db6ff(0x1b2)],_0x35273d,_0x41e3d1,_0x2758c8,_0x59f061,_0x1d93d3,_0x271c4d,_0x47b72e),_0x527722=this[_0x5db6ff(0x181)][_0x5db6ff(0x17c)](_0x212554),_0x479e6e={'gatewayPaymentId':_0x212554[_0x5db6ff(0x1b9)],'cardLast4':_0x527722[_0x5db6ff(0x1cc)],'gateway':_0x5db6ff(0x187),'customerEmail':_0x47201b,'customerPhone':_0x47b72e,'customerBirthDate':_0x557e90,'billingAddress':_0x1f2cbe,'billingCity':_0x311cab,'billingState':_0x5793ab,'billingZip':_0x1b5194,'customerCountry':_0x2bc04a,'phoneIsValid':_0x581f11?.[_0x5db6ff(0x14c)],'phoneLineStatus':_0x581f11?.[_0x5db6ff(0x1b7)],'phoneIsVoip':_0x581f11?.[_0x5db6ff(0x1cb)],'phoneRiskLevel':_0x581f11?.[_0x5db6ff(0x192)]};console[_0x5db6ff(0x166)](_0x5db6ff(0x16a),{'phoneIsValid':_0x479e6e[_0x5db6ff(0x1c8)],'phoneLineStatus':_0x479e6e['phoneLineStatus'],'phoneIsVoip':_0x479e6e[_0x5db6ff(0x191)],'phoneRiskLevel':_0x479e6e[_0x5db6ff(0x1ad)]});if(_0x527722['status']==='PAID'){_0x479e6e['status']='PAID',_0x479e6e[_0x5db6ff(0x17b)]=new Date();try{const _0x2ac2f5=await this[_0x5db6ff(0x177)]['convertToUSDT'](_0x4020aa[_0x5db6ff(0x189)],_0x4020aa['currency']);_0x479e6e['amountUSDT']=_0x2ac2f5,console[_0x5db6ff(0x166)](_0x5db6ff(0x159)+_0x2ac2f5+_0x5db6ff(0x172));const _0x343d13=await this['webhookService'][_0x5db6ff(0x19c)](_0x4020aa[_0x5db6ff(0x1af)],_0x4020aa[_0x5db6ff(0x153)]),_0x171af9=_0x2ac2f5*(0x1-_0x343d13/0x64);_0x479e6e[_0x5db6ff(0x190)]=_0x171af9,_0x479e6e[_0x5db6ff(0x199)]=_0x343d13,console[_0x5db6ff(0x166)]('ðŸ’°\x20Gateway\x20'+_0x4020aa[_0x5db6ff(0x153)]+_0x5db6ff(0x1bd)+_0x343d13+'%'),console['log']('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x171af9[_0x5db6ff(0x15a)](0x6)+_0x5db6ff(0x172));}catch(_0x1277fe){console['error'](_0x5db6ff(0x150),_0x1277fe),_0x479e6e['amountUSDT']=0x0,_0x479e6e[_0x5db6ff(0x190)]=0x0,_0x479e6e['gatewayCommissionRate']=0x0;}}else _0x527722[_0x5db6ff(0x18a)]===_0x5db6ff(0x15f)&&(_0x479e6e[_0x5db6ff(0x18a)]=_0x5db6ff(0x15f),_0x479e6e[_0x5db6ff(0x17d)]=_0x527722[_0x5db6ff(0x17d)]);const _0x19158f=await database_1['default'][_0x5db6ff(0x173)][_0x5db6ff(0x1be)]({'where':{'id':_0x2ba724},'data':_0x479e6e});console[_0x5db6ff(0x166)](_0x5db6ff(0x19f)+_0x19158f[_0x5db6ff(0x18a)]);let _0x4f3742;if(_0x527722[_0x5db6ff(0x18a)]===_0x5db6ff(0x15f))_0x4f3742=_0x527722[_0x5db6ff(0x17d)]||_0x212554[_0x5db6ff(0x174)]||_0x5db6ff(0x19a);else _0x527722[_0x5db6ff(0x18a)]===_0x5db6ff(0x194)?_0x4f3742=_0x212554[_0x5db6ff(0x174)]||_0x5db6ff(0x1bb):_0x4f3742=_0x212554[_0x5db6ff(0x174)]||'Payment\x20processed\x20successfully';const _0x521b68={'success':_0x527722[_0x5db6ff(0x18a)]!==_0x5db6ff(0x15f),'status':_0x527722[_0x5db6ff(0x18a)],'message':_0x4f3742,'payment':{'id':_0x2ba724,'status':_0x19158f['status'],'gateway':_0x5db6ff(0x187),'last4':_0x527722['cardLast4']}};_0x527722[_0x5db6ff(0x1c4)]&&(_0x521b68[_0x5db6ff(0x152)]=_0x527722[_0x5db6ff(0x1c4)],_0x521b68[_0x5db6ff(0x188)]=!![],console['log']('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x527722[_0x5db6ff(0x1c4)])),_0x2c1a78[_0x5db6ff(0x1b4)](_0x521b68);}catch(_0x474017){console[_0x5db6ff(0x15d)](_0x5db6ff(0x163),_0x474017),_0x54e917(_0x474017);}},this[_0x141623(0x1a4)]=async(_0x9d92cc,_0x56fe45,_0x371b51)=>{const _0x27cd7f=_0x141623;try{console[_0x27cd7f(0x166)](_0x27cd7f(0x184)),console[_0x27cd7f(0x166)](_0x27cd7f(0x1c7),_0x9d92cc['headers']),console['log']('Body:',_0x9d92cc[_0x27cd7f(0x18e)]),this[_0x27cd7f(0x181)][_0x27cd7f(0x1a6)]({'headers':_0x9d92cc[_0x27cd7f(0x18c)],'body':_0x9d92cc[_0x27cd7f(0x18e)],'timestamp':new Date()[_0x27cd7f(0x17f)]()});const _0x1ac951=_0x9d92cc[_0x27cd7f(0x18e)];if(!_0x1ac951['uid']||!_0x1ac951['status'])return console[_0x27cd7f(0x1c6)](_0x27cd7f(0x1a0)),_0x56fe45[_0x27cd7f(0x18a)](0x190)[_0x27cd7f(0x1b4)]({'success':![],'message':_0x27cd7f(0x1c0)});let _0x15efeb;_0x1ac951[_0x27cd7f(0x1b9)]&&(_0x15efeb=await database_1[_0x27cd7f(0x17e)][_0x27cd7f(0x173)]['findFirst']({'where':{'gatewayPaymentId':_0x1ac951['uid'],'gateway':'squirrelpay'}}));if(!_0x15efeb)return console[_0x27cd7f(0x1c6)](_0x27cd7f(0x1b8)),console[_0x27cd7f(0x1c6)]('\x20\x20\x20UID:\x20'+_0x1ac951['uid']),console['warn'](_0x27cd7f(0x182)+_0x1ac951[_0x27cd7f(0x161)]),console[_0x27cd7f(0x1c6)](_0x27cd7f(0x154)),console[_0x27cd7f(0x1c6)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x1ac951[_0x27cd7f(0x1b9)]),_0x56fe45[_0x27cd7f(0x18a)](0x194)['json']({'success':![],'message':_0x27cd7f(0x1a9)});console[_0x27cd7f(0x166)](_0x27cd7f(0x169)+_0x15efeb['id']),console[_0x27cd7f(0x166)](_0x27cd7f(0x176)+_0x15efeb[_0x27cd7f(0x18a)]),console[_0x27cd7f(0x166)](_0x27cd7f(0x156)+_0x15efeb[_0x27cd7f(0x16c)]),console[_0x27cd7f(0x166)](_0x27cd7f(0x1a5)+_0x1ac951[_0x27cd7f(0x18a)]),console[_0x27cd7f(0x166)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x1ac951[_0x27cd7f(0x1b9)]);let _0x56591a=null;const _0x4954f4={};_0x1ac951[_0x27cd7f(0x195)]?.['brand']&&(_0x4954f4[_0x27cd7f(0x16f)]=_0x1ac951['payment_method'][_0x27cd7f(0x17a)],console[_0x27cd7f(0x166)](_0x27cd7f(0x1ab)+_0x1ac951[_0x27cd7f(0x195)]['brand']));_0x1ac951['payment_method']?.[_0x27cd7f(0x1a1)]&&(_0x4954f4[_0x27cd7f(0x1cc)]=_0x1ac951[_0x27cd7f(0x195)][_0x27cd7f(0x1a1)],console['log'](_0x27cd7f(0x16b)+_0x1ac951[_0x27cd7f(0x195)][_0x27cd7f(0x1a1)]));switch(_0x1ac951[_0x27cd7f(0x18a)]){case _0x27cd7f(0x193):_0x56591a=_0x27cd7f(0x178),console[_0x27cd7f(0x166)](_0x27cd7f(0x1c1));break;case _0x27cd7f(0x1ca):_0x56591a=_0x27cd7f(0x15f),_0x4954f4[_0x27cd7f(0x17d)]=_0x1ac951[_0x27cd7f(0x174)]||_0x1ac951[_0x27cd7f(0x19b)]||_0x27cd7f(0x19a),console['log'](_0x27cd7f(0x14d)+_0x4954f4['failureMessage']);break;case'incomplete':console[_0x27cd7f(0x166)](_0x27cd7f(0x179));break;default:console['warn'](_0x27cd7f(0x186)+_0x1ac951['status']);break;}if(_0x56591a&&_0x56591a!==_0x15efeb['status'])console[_0x27cd7f(0x166)](_0x27cd7f(0x158)+_0x15efeb[_0x27cd7f(0x18a)]+_0x27cd7f(0x19d)+_0x56591a),await this[_0x27cd7f(0x165)]['updatePaymentStatus'](_0x15efeb['id'],_0x56591a,_0x4954f4),console[_0x27cd7f(0x166)]('âœ…\x20Payment\x20'+_0x15efeb['id']+'\x20updated:\x20status='+_0x56591a+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x56591a&&console[_0x27cd7f(0x166)]('â„¹ï¸\x20Payment\x20'+_0x15efeb['id']+'\x20already\x20has\x20status\x20'+_0x56591a+_0x27cd7f(0x167));_0x56fe45[_0x27cd7f(0x18a)](0xc8)['json']({'success':!![],'message':_0x27cd7f(0x1bc)});}catch(_0x546f54){console[_0x27cd7f(0x15d)](_0x27cd7f(0x185),_0x546f54),_0x371b51(_0x546f54);}},this[_0x141623(0x1c9)]=async(_0x176fb4,_0x405d73,_0x106b48)=>{const _0x3854cb=_0x141623;try{const {limit:_0x1447b0}=_0x176fb4['query'],_0x25e605=this[_0x3854cb(0x181)][_0x3854cb(0x1c9)](_0x1447b0?parseInt(_0x1447b0):0x32);_0x405d73[_0x3854cb(0x1b4)]({'success':!![],'result':{'logs':_0x25e605,'count':_0x25e605['length']}});}catch(_0xfcf23c){_0x106b48(_0xfcf23c);}},this[_0x141623(0x181)]=new squirrelPayService_1[(_0x141623(0x160))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||'https://gate.squirrel-pay.com','isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0x141623(0x151)}),this['currencyService']=new currencyService_1[(_0x141623(0x1a8))](),this[_0x141623(0x165)]=new webhookService_1[(_0x141623(0x162))]();}}function a19_0xa75a(_0x2e706b,_0x386fa2){_0x2e706b=_0x2e706b-0x14c;const _0x56de01=a19_0x56de();let _0xa75a9d=_0x56de01[_0x2e706b];return _0xa75a9d;}exports[a19_0x4f5f7a(0x1ac)]=SquirrelPayController;