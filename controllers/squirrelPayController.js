'use strict';const a19_0x40e5b8=a19_0x31b0;(function(_0x5efcb2,_0x4f8f18){const _0x155fb=a19_0x31b0,_0x2962d7=_0x5efcb2();while(!![]){try{const _0x12a459=-parseInt(_0x155fb(0x124))/0x1+parseInt(_0x155fb(0xed))/0x2+parseInt(_0x155fb(0x13a))/0x3*(parseInt(_0x155fb(0x168))/0x4)+-parseInt(_0x155fb(0x13f))/0x5+parseInt(_0x155fb(0x107))/0x6*(-parseInt(_0x155fb(0x15c))/0x7)+parseInt(_0x155fb(0x13c))/0x8*(parseInt(_0x155fb(0x14b))/0x9)+-parseInt(_0x155fb(0x141))/0xa;if(_0x12a459===_0x4f8f18)break;else _0x2962d7['push'](_0x2962d7['shift']());}catch(_0x272b4f){_0x2962d7['push'](_0x2962d7['shift']());}}}(a19_0x286e,0xdc266));function a19_0x286e(){const _0x23d0c4=['/payment/pending?id=','ðŸ’³\x20Card\x20brand\x20detected:\x20','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','ðŸ“ž\x20Phone\x20validation\x20data:','processCardPayment','round','CurrencyService','\x20\x20\x20Webhook\x20status:\x20','../services/currencyService','getGatewayCommission','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','currencyService','uid','../services/gateways/squirrelPayService','requires_action','ðŸ“\x20SquirrelPay\x20payment\x20details:','Payment\x20is\x20being\x20processed','getClientIP','SquirrelPayController','12PLXomK','\x20\x20\x20Payment\x20ID:\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','__esModule','cardLast4','toString','paidAt','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','\x20USDT','warn','webhookService','toFixed','FAILED','Payment\x20not\x20found','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','https://app.trapay.uk','birth_date','payment_method','Missing\x20required\x20fields\x20in\x20webhook','slice','Payment\x20processed\x20successfully','findFirst','error','\x20\x20\x20Billing\x20Country:\x20','headers','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','squirrelpay','status','1318481zCuuKy','âŒ\x20SquirrelPay\x20webhook\x20error:','true','successful','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','toISOString','message','phoneIsValid','ðŸ’³\x20Card\x20last\x204:\x20','redirect_url','\x20\x20\x20Webhook\x20UID:\x20','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','getPaymentStatus','../utils/ipHelper','redirectUrl','json','friendly_message','PENDING','phoneIsVoip','gateway','PAID','5889kXTdcO','Payment\x20is\x20not\x20in\x20pending\x20status','153688DlUxpx','default','squirrelPayService','2977610YYYJNd','lineStatus','2884750ADMiuW','has','\x20\x20\x20Amount:\x20','incomplete','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','currency','ðŸ’°\x20Gateway\x20','getWebhookLogs','Missing\x20required\x20card\x20or\x20customer\x20information','update','432qnniQq','handleWebhook','Payment\x20failed','WebhookService','failureMessage','amount','not\x20provided','riskLevel','last_4','amountAfterGatewayCommissionUSDT','length','\x20\x20\x20Description:\x20','\x20\x20\x20Gateway:\x20squirrelpay','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','phoneLineStatus','params','cardBrand','2855839QdMuYR','brand','\x20commission:\x20','payment','\x20already\x20has\x20status\x20','\x20to\x20','isValid','phoneRiskLevel','padStart','Headers:','ðŸ’°\x20Calculated\x20amountUSDT:\x20','body','3092bQuNvh','log','https://api.trapay.uk','gatewayCommissionRate','2961278pEojdd','toUpperCase','SquirrelPayService','\x20updated:\x20status=','logWebhook','isVoip','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'];a19_0x286e=function(){return _0x23d0c4;};return a19_0x286e();}var __importDefault=this&&this['__importDefault']||function(_0x1df035){const _0x2fb534=a19_0x31b0;return _0x1df035&&_0x1df035[_0x2fb534(0x10a)]?_0x1df035:{'default':_0x1df035};};Object['defineProperty'](exports,a19_0x40e5b8(0x10a),{'value':!![]}),exports[a19_0x40e5b8(0x106)]=void 0x0;const squirrelPayService_1=require(a19_0x40e5b8(0x101)),currencyService_1=require(a19_0x40e5b8(0xfc)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a19_0x40e5b8(0x132)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x3683de){const _0x5cdfa7=a19_0x40e5b8;return ISO_COUNTRY_CODES[_0x5cdfa7(0x142)](_0x3683de['toUpperCase']());}class SquirrelPayController{constructor(){const _0x390daa=a19_0x40e5b8;this[_0x390daa(0xf8)]=async(_0x20f8fa,_0xd3e87,_0x4eef03)=>{const _0x40fa15=_0x390daa;try{const {paymentId:_0x9ae10e}=_0x20f8fa[_0x40fa15(0x15a)],{card_number:_0x133180,exp_month:_0x381655,exp_year:_0x104b22,cvv:_0x531902,holder_name:_0x5f129b,customer_email:_0x395a5f,customer_birth_date:_0x57b45a,billing_country:_0x850177,customer_phone:_0x5a618d,billing_address:_0x293714,billing_city:_0x4d7d43,billing_state:_0x59d168,billing_zip:_0x61e8c3,phoneValidation:_0x13be2c}=_0x20f8fa[_0x40fa15(0x167)];console[_0x40fa15(0x169)](_0x40fa15(0x10e)+_0x9ae10e),console[_0x40fa15(0x169)](_0x40fa15(0xf7),_0x13be2c);if(!_0x133180||!_0x381655||!_0x104b22||!_0x531902||!_0x5f129b||!_0x395a5f)return _0xd3e87['status'](0x190)['json']({'success':![],'message':_0x40fa15(0x149)});if(_0x850177&&!isValidCountryCode(_0x850177))return _0xd3e87[_0x40fa15(0x123)](0x190)[_0x40fa15(0x134)]({'success':![],'message':_0x40fa15(0x128)});const _0x4c2f42=await database_1[_0x40fa15(0x13d)]['payment']['findUnique']({'where':{'id':_0x9ae10e},'include':{'shop':!![]}});if(!_0x4c2f42)return _0xd3e87[_0x40fa15(0x123)](0x194)[_0x40fa15(0x134)]({'success':![],'message':_0x40fa15(0x114)});if(_0x4c2f42[_0x40fa15(0x123)]!==_0x40fa15(0x136))return _0xd3e87[_0x40fa15(0x123)](0x190)[_0x40fa15(0x134)]({'success':![],'message':_0x40fa15(0x13b)});const _0x4eef68=(0x0,ipHelper_1[_0x40fa15(0x105)])(_0x20f8fa),_0x1e40e5={'number':_0x133180['replace'](/\s/g,''),'exp_month':_0x381655[_0x40fa15(0x10c)]()[_0x40fa15(0x164)](0x2,'0'),'exp_year':_0x104b22[_0x40fa15(0x10c)](),'verification_value':_0x531902,'holder':_0x5f129b[_0x40fa15(0xee)]()},_0x1809ae={'ip':_0x4eef68,'email':_0x395a5f};_0x57b45a&&(_0x1809ae[_0x40fa15(0x118)]=_0x57b45a);let _0x515b7f;_0x850177&&(_0x515b7f={'country':_0x850177,'address':_0x293714,'city':_0x4d7d43,'state':_0x59d168,'zip':_0x61e8c3});const _0x11b7cd=(process.env.FRONTEND_URL||_0x40fa15(0x117))+_0x40fa15(0xf4)+_0x9ae10e+'&payment_id='+(_0x4c2f42['gatewayOrderId']||_0x9ae10e),_0x33e875=(process.env.API_BASE_URL||_0x40fa15(0x16a))+'/api/webhooks/squirrel-pay',_0x1ac8d5=_0x9ae10e[_0x40fa15(0x11b)](0x0,0x8)+'-'+_0x9ae10e[_0x40fa15(0x11b)](0x8,0x10);console[_0x40fa15(0x169)](_0x40fa15(0x103)),console[_0x40fa15(0x169)](_0x40fa15(0x108)+_0x9ae10e),console[_0x40fa15(0x169)](_0x40fa15(0x143)+_0x4c2f42[_0x40fa15(0x150)]+'\x20'+_0x4c2f42[_0x40fa15(0x146)]),console[_0x40fa15(0x169)]('\x20\x20\x20Customer:\x20'+_0x395a5f+'\x20('+_0x4eef68+')'),console[_0x40fa15(0x169)](_0x40fa15(0x11f)+(_0x850177||_0x40fa15(0x151))),console[_0x40fa15(0x169)](_0x40fa15(0x156)+_0x1ac8d5);const _0x773318=await this[_0x40fa15(0x13e)][_0x40fa15(0xf8)](Math[_0x40fa15(0xf9)](_0x4c2f42['amount']*0x64),_0x4c2f42[_0x40fa15(0x146)],_0x1ac8d5,_0x11b7cd,_0x33e875,_0x1e40e5,_0x1809ae,_0x515b7f,_0x5a618d),_0x1da201=this[_0x40fa15(0x13e)][_0x40fa15(0x131)](_0x773318),_0x3aef3d={'gatewayPaymentId':_0x773318['uid'],'cardLast4':_0x1da201[_0x40fa15(0x10b)],'gateway':_0x40fa15(0x122),'customerEmail':_0x395a5f,'customerPhone':_0x5a618d,'customerBirthDate':_0x57b45a,'billingAddress':_0x293714,'billingCity':_0x4d7d43,'billingState':_0x59d168,'billingZip':_0x61e8c3,'customerCountry':_0x850177,'phoneIsValid':_0x13be2c?.[_0x40fa15(0x162)],'phoneLineStatus':_0x13be2c?.[_0x40fa15(0x140)],'phoneIsVoip':_0x13be2c?.[_0x40fa15(0xf2)],'phoneRiskLevel':_0x13be2c?.[_0x40fa15(0x152)]};console[_0x40fa15(0x169)]('ðŸ’¾\x20Update\x20data\x20being\x20saved:',{'phoneIsValid':_0x3aef3d[_0x40fa15(0x12c)],'phoneLineStatus':_0x3aef3d[_0x40fa15(0x159)],'phoneIsVoip':_0x3aef3d[_0x40fa15(0x137)],'phoneRiskLevel':_0x3aef3d[_0x40fa15(0x163)]});if(_0x1da201[_0x40fa15(0x123)]===_0x40fa15(0x139)){_0x3aef3d[_0x40fa15(0x123)]='PAID',_0x3aef3d[_0x40fa15(0x10d)]=new Date();try{const _0x1d158e=await this[_0x40fa15(0xff)]['convertToUSDT'](_0x4c2f42[_0x40fa15(0x150)],_0x4c2f42[_0x40fa15(0x146)]);_0x3aef3d['amountUSDT']=_0x1d158e,console[_0x40fa15(0x169)](_0x40fa15(0x166)+_0x1d158e+'\x20USDT');const _0x5b5f12=await this[_0x40fa15(0x111)][_0x40fa15(0xfd)](_0x4c2f42['shopId'],_0x4c2f42[_0x40fa15(0x138)]),_0x416ea9=_0x1d158e*(0x1-_0x5b5f12/0x64);_0x3aef3d[_0x40fa15(0x154)]=_0x416ea9,_0x3aef3d[_0x40fa15(0x16b)]=_0x5b5f12,console[_0x40fa15(0x169)](_0x40fa15(0x147)+_0x4c2f42[_0x40fa15(0x138)]+_0x40fa15(0x15e)+_0x5b5f12+'%'),console[_0x40fa15(0x169)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x416ea9[_0x40fa15(0x112)](0x6)+_0x40fa15(0x10f));}catch(_0x219e29){console[_0x40fa15(0x11e)](_0x40fa15(0x158),_0x219e29),_0x3aef3d['amountUSDT']=0x0,_0x3aef3d[_0x40fa15(0x154)]=0x0,_0x3aef3d[_0x40fa15(0x16b)]=0x0;}}else _0x1da201[_0x40fa15(0x123)]==='FAILED'&&(_0x3aef3d[_0x40fa15(0x123)]=_0x40fa15(0x113),_0x3aef3d['failureMessage']=_0x1da201[_0x40fa15(0x14f)]);const _0x1b848d=await database_1[_0x40fa15(0x13d)][_0x40fa15(0x15f)][_0x40fa15(0x14a)]({'where':{'id':_0x9ae10e},'data':_0x3aef3d});console[_0x40fa15(0x169)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x1b848d['status']);let _0x1714fe;if(_0x1da201['status']===_0x40fa15(0x113))_0x1714fe=_0x1da201[_0x40fa15(0x14f)]||_0x773318['friendly_message']||'Payment\x20failed';else _0x1da201[_0x40fa15(0x123)]==='PENDING'?_0x1714fe=_0x773318[_0x40fa15(0x135)]||_0x40fa15(0x104):_0x1714fe=_0x773318[_0x40fa15(0x135)]||_0x40fa15(0x11c);const _0x589c1a={'success':_0x1da201[_0x40fa15(0x123)]!==_0x40fa15(0x113),'status':_0x1da201[_0x40fa15(0x123)],'message':_0x1714fe,'payment':{'id':_0x9ae10e,'status':_0x1b848d['status'],'gateway':'squirrelpay','last4':_0x1da201['cardLast4']}};_0x1da201['redirectUrl']&&(_0x589c1a[_0x40fa15(0x12e)]=_0x1da201['redirectUrl'],_0x589c1a[_0x40fa15(0x102)]=!![],console[_0x40fa15(0x169)](_0x40fa15(0x116)+_0x1da201[_0x40fa15(0x133)])),_0xd3e87['json'](_0x589c1a);}catch(_0x5f443f){console['error'](_0x40fa15(0x130),_0x5f443f),_0x4eef03(_0x5f443f);}},this[_0x390daa(0x14c)]=async(_0x4e0555,_0x939ef2,_0x6f7818)=>{const _0x170c6d=_0x390daa;try{console[_0x170c6d(0x169)](_0x170c6d(0xf3)),console[_0x170c6d(0x169)](_0x170c6d(0x165),_0x4e0555[_0x170c6d(0x120)]),console[_0x170c6d(0x169)]('Body:',_0x4e0555['body']),this[_0x170c6d(0x13e)][_0x170c6d(0xf1)]({'headers':_0x4e0555[_0x170c6d(0x120)],'body':_0x4e0555[_0x170c6d(0x167)],'timestamp':new Date()[_0x170c6d(0x12a)]()});const _0x48f8d7=_0x4e0555['body'];if(!_0x48f8d7[_0x170c6d(0x100)]||!_0x48f8d7['status'])return console[_0x170c6d(0x110)](_0x170c6d(0xf6)),_0x939ef2[_0x170c6d(0x123)](0x190)[_0x170c6d(0x134)]({'success':![],'message':_0x170c6d(0x11a)});let _0x3cc5c7;_0x48f8d7[_0x170c6d(0x100)]&&(_0x3cc5c7=await database_1['default'][_0x170c6d(0x15f)][_0x170c6d(0x11d)]({'where':{'gatewayPaymentId':_0x48f8d7[_0x170c6d(0x100)],'gateway':_0x170c6d(0x122)}}));if(!_0x3cc5c7)return console[_0x170c6d(0x110)](_0x170c6d(0x121)),console[_0x170c6d(0x110)]('\x20\x20\x20UID:\x20'+_0x48f8d7[_0x170c6d(0x100)]),console[_0x170c6d(0x110)](_0x170c6d(0x156)+_0x48f8d7['description']),console[_0x170c6d(0x110)](_0x170c6d(0x157)),console['warn']('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x48f8d7[_0x170c6d(0x100)]),_0x939ef2[_0x170c6d(0x123)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console[_0x170c6d(0x169)](_0x170c6d(0x129)+_0x3cc5c7['id']),console[_0x170c6d(0x169)](_0x170c6d(0x145)+_0x3cc5c7['status']),console[_0x170c6d(0x169)](_0x170c6d(0xfe)+_0x3cc5c7['gatewayPaymentId']),console[_0x170c6d(0x169)](_0x170c6d(0xfb)+_0x48f8d7[_0x170c6d(0x123)]),console[_0x170c6d(0x169)](_0x170c6d(0x12f)+_0x48f8d7[_0x170c6d(0x100)]);let _0x243a8d=null;const _0x1b72ef={};_0x48f8d7[_0x170c6d(0x119)]?.[_0x170c6d(0x15d)]&&(_0x1b72ef[_0x170c6d(0x15b)]=_0x48f8d7[_0x170c6d(0x119)][_0x170c6d(0x15d)],console['log'](_0x170c6d(0xf5)+_0x48f8d7['payment_method'][_0x170c6d(0x15d)]));_0x48f8d7['payment_method']?.[_0x170c6d(0x153)]&&(_0x1b72ef[_0x170c6d(0x10b)]=_0x48f8d7[_0x170c6d(0x119)][_0x170c6d(0x153)],console[_0x170c6d(0x169)](_0x170c6d(0x12d)+_0x48f8d7[_0x170c6d(0x119)][_0x170c6d(0x153)]));switch(_0x48f8d7[_0x170c6d(0x123)]){case _0x170c6d(0x127):_0x243a8d=_0x170c6d(0x139),console[_0x170c6d(0x169)](_0x170c6d(0x115));break;case'failed':_0x243a8d=_0x170c6d(0x113),_0x1b72ef[_0x170c6d(0x14f)]=_0x48f8d7['friendly_message']||_0x48f8d7[_0x170c6d(0x12b)]||_0x170c6d(0x14d),console[_0x170c6d(0x169)]('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x1b72ef[_0x170c6d(0x14f)]);break;case _0x170c6d(0x144):console[_0x170c6d(0x169)](_0x170c6d(0x109));break;default:console[_0x170c6d(0x110)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x48f8d7[_0x170c6d(0x123)]);break;}if(_0x243a8d&&_0x243a8d!==_0x3cc5c7[_0x170c6d(0x123)])console[_0x170c6d(0x169)]('ðŸ”„\x20Updating\x20payment\x20status\x20from\x20'+_0x3cc5c7['status']+_0x170c6d(0x161)+_0x243a8d),await this[_0x170c6d(0x111)]['updatePaymentStatus'](_0x3cc5c7['id'],_0x243a8d,_0x1b72ef),console['log']('âœ…\x20Payment\x20'+_0x3cc5c7['id']+_0x170c6d(0xf0)+_0x243a8d+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x243a8d&&console['log']('â„¹ï¸\x20Payment\x20'+_0x3cc5c7['id']+_0x170c6d(0x160)+_0x243a8d+',\x20skipping\x20update');_0x939ef2[_0x170c6d(0x123)](0xc8)[_0x170c6d(0x134)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x242ed7){console[_0x170c6d(0x11e)](_0x170c6d(0x125),_0x242ed7),_0x6f7818(_0x242ed7);}},this['getWebhookLogs']=async(_0x173df0,_0xdc9e1,_0x584266)=>{const _0x4b157a=_0x390daa;try{const {limit:_0x200c46}=_0x173df0['query'],_0x4ca2bf=this['squirrelPayService'][_0x4b157a(0x148)](_0x200c46?parseInt(_0x200c46):0x32);_0xdc9e1[_0x4b157a(0x134)]({'success':!![],'result':{'logs':_0x4ca2bf,'count':_0x4ca2bf[_0x4b157a(0x155)]}});}catch(_0x33d9b2){_0x584266(_0x33d9b2);}},this['squirrelPayService']=new squirrelPayService_1[(_0x390daa(0xef))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||'https://gate.squirrel-pay.com','isTestMode':process.env.SQUIRREL_PAY_TEST_MODE===_0x390daa(0x126)}),this['currencyService']=new currencyService_1[(_0x390daa(0xfa))](),this[_0x390daa(0x111)]=new webhookService_1[(_0x390daa(0x14e))]();}}function a19_0x31b0(_0x2a2c66,_0x396775){_0x2a2c66=_0x2a2c66-0xed;const _0x286e6e=a19_0x286e();let _0x31b0bf=_0x286e6e[_0x2a2c66];return _0x31b0bf;}exports[a19_0x40e5b8(0x106)]=SquirrelPayController;