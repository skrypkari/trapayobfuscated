'use strict';const a16_0x10c43c=a16_0x2e82;(function(_0x1cb6c8,_0x402f08){const _0x216da1=a16_0x2e82,_0x399b1b=_0x1cb6c8();while(!![]){try{const _0x2e472a=-parseInt(_0x216da1(0xfb))/0x1*(parseInt(_0x216da1(0xe0))/0x2)+parseInt(_0x216da1(0x136))/0x3+-parseInt(_0x216da1(0xea))/0x4+-parseInt(_0x216da1(0x13d))/0x5*(-parseInt(_0x216da1(0xf1))/0x6)+parseInt(_0x216da1(0xe2))/0x7*(parseInt(_0x216da1(0x13f))/0x8)+-parseInt(_0x216da1(0x117))/0x9+-parseInt(_0x216da1(0x11b))/0xa;if(_0x2e472a===_0x402f08)break;else _0x399b1b['push'](_0x399b1b['shift']());}catch(_0x2e7bee){_0x399b1b['push'](_0x399b1b['shift']());}}}(a16_0x243e,0xa2f03));var __importDefault=this&&this[a16_0x10c43c(0x128)]||function(_0x8294df){return _0x8294df&&_0x8294df['__esModule']?_0x8294df:{'default':_0x8294df};};Object['defineProperty'](exports,a16_0x10c43c(0x118),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a16_0x10c43c(0x103)),currencyService_1=require(a16_0x10c43c(0x13e)),webhookService_1=require(a16_0x10c43c(0x10e)),database_1=__importDefault(require(a16_0x10c43c(0x154))),ipHelper_1=require(a16_0x10c43c(0x110)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a16_0x243e(){const _0xf09740=['\x20to\x20','uid','SQUIRREL_PAY_TEST_MODE','Payment\x20is\x20not\x20in\x20pending\x20status','getPaymentStatus','2614LPjtCO','squirrelpay','FAILED',',\x20balance\x20updated,\x20amountUSDT\x20calculated','friendly_message','/api/webhooks/squirrel-pay','padStart','log','../services/gateways/squirrelPayService','gateway','\x20\x20\x20Payment\x20ID:\x20','\x20\x20\x20UID:\x20','\x20\x20\x20Gateway:\x20squirrelpay','successful','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','warn','PENDING','ðŸ’°\x20Calculated\x20amountUSDT:\x20','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','../services/webhookService','not\x20provided','../utils/ipHelper','status','â„¹ï¸\x20Payment\x20','slice','Payment\x20processed\x20successfully','\x20\x20\x20Webhook\x20UID:\x20','payment','2268603KYWeaY','__esModule','replace','Body:','2845480GrBVKj','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','getWebhookLogs','webhookService','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','PAID','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','round','shopId','true','toUpperCase','description','FRONTEND_URL','__importDefault','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','Payment\x20not\x20found','query','failureMessage','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','SquirrelPayController','gatewayCommissionRate','handleWebhook','Payment\x20failed','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','message','SQUIRREL_PAY_BASE_URL','env','2313576JkjPVh','Payment\x20is\x20being\x20processed','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','\x20\x20\x20Description:\x20','birth_date','requires_action','findUnique','560avNSbq','../services/currencyService','1569624AYWvkv','updatePaymentStatus','\x20USDT','squirrelPayService','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','length','redirectUrl','gatewayOrderId','body','toString','processCardPayment','logWebhook','\x20already\x20has\x20status\x20','âŒ\x20SquirrelPay\x20webhook\x20error:','update',',\x20skipping\x20update','amountAfterGatewayCommissionUSDT','findFirst','convertToUSDT','CurrencyService','cardLast4','../config/database','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','json','âœ…\x20Payment\x20','\x20updated:\x20status=','redirect_url','has','toFixed','toISOString','default','236uOzSre','currencyService','21CaTIYf','amount','SQUIRREL_PAY_SHOP_ID','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','\x20commission:\x20','failed','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','gatewayPaymentId','1729260ccsWAp','error','headers','getGatewayCommission','SQUIRREL_PAY_SECRET_KEY','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','currency','31338moCrAo','incomplete','\x20\x20\x20Amount:\x20','ðŸ’°\x20Gateway\x20','\x20\x20\x20Customer:\x20'];a16_0x243e=function(){return _0xf09740;};return a16_0x243e();}function isValidCountryCode(_0x3dadb9){const _0x5bce21=a16_0x10c43c;return ISO_COUNTRY_CODES[_0x5bce21(0xdc)](_0x3dadb9[_0x5bce21(0x125)]());}function a16_0x2e82(_0x14bc7a,_0x28e41f){_0x14bc7a=_0x14bc7a-0xdb;const _0x243e1f=a16_0x243e();let _0x2e8298=_0x243e1f[_0x14bc7a];return _0x2e8298;}class SquirrelPayController{constructor(){const _0x3d17ee=a16_0x10c43c;this['processCardPayment']=async(_0x5663f7,_0x3075be,_0x4c1fd9)=>{const _0x2ddc17=a16_0x2e82;try{const {paymentId:_0x10af9e}=_0x5663f7['params'],{card_number:_0x9026e0,exp_month:_0x3bda6b,exp_year:_0x25a243,cvv:_0x2cd5f4,holder_name:_0x525575,customer_email:_0x2657d2,customer_birth_date:_0xb8cb0,billing_country:_0x390c3d,customer_phone:_0x1fea3a,billing_address:_0x2f3e61,billing_city:_0x10df73,billing_state:_0x2c08c9,billing_zip:_0x232714}=_0x5663f7[_0x2ddc17(0x147)];console[_0x2ddc17(0x102)](_0x2ddc17(0x129)+_0x10af9e);if(!_0x9026e0||!_0x3bda6b||!_0x25a243||!_0x2cd5f4||!_0x525575||!_0x2657d2)return _0x3075be[_0x2ddc17(0x111)](0x190)[_0x2ddc17(0x156)]({'success':![],'message':'Missing\x20required\x20card\x20or\x20customer\x20information'});if(_0x390c3d&&!isValidCountryCode(_0x390c3d))return _0x3075be['status'](0x190)[_0x2ddc17(0x156)]({'success':![],'message':_0x2ddc17(0x11f)});const _0x5c212c=await database_1['default'][_0x2ddc17(0x116)][_0x2ddc17(0x13c)]({'where':{'id':_0x10af9e},'include':{'shop':!![]}});if(!_0x5c212c)return _0x3075be[_0x2ddc17(0x111)](0x194)[_0x2ddc17(0x156)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5c212c['status']!=='PENDING')return _0x3075be['status'](0x190)[_0x2ddc17(0x156)]({'success':![],'message':_0x2ddc17(0xf9)});const _0x2ae1a0=(0x0,ipHelper_1['getClientIP'])(_0x5663f7),_0xa2b46={'number':_0x9026e0[_0x2ddc17(0x119)](/\s/g,''),'exp_month':_0x3bda6b[_0x2ddc17(0x148)]()[_0x2ddc17(0x101)](0x2,'0'),'exp_year':_0x25a243[_0x2ddc17(0x148)](),'verification_value':_0x2cd5f4,'holder':_0x525575[_0x2ddc17(0x125)]()},_0x2d1259={'ip':_0x2ae1a0,'email':_0x2657d2};_0xb8cb0&&(_0x2d1259[_0x2ddc17(0x13a)]=_0xb8cb0);let _0x20f91a;_0x390c3d&&(_0x20f91a={'country':_0x390c3d,'address':_0x2f3e61,'city':_0x10df73,'state':_0x2c08c9,'zip':_0x232714});const _0x505a41=(process[_0x2ddc17(0x135)][_0x2ddc17(0x127)]||'https://app.trapay.uk')+'/payment/pending?id='+_0x10af9e+'&payment_id='+(_0x5c212c[_0x2ddc17(0x146)]||_0x10af9e),_0x39a547=(process[_0x2ddc17(0x135)]['API_BASE_URL']||'https://api.trapay.uk')+_0x2ddc17(0x100),_0x39eeca=_0x10af9e[_0x2ddc17(0x113)](0x0,0x8)+'-'+_0x10af9e[_0x2ddc17(0x113)](0x8,0x10);console[_0x2ddc17(0x102)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console['log'](_0x2ddc17(0x105)+_0x10af9e),console['log'](_0x2ddc17(0xf3)+_0x5c212c[_0x2ddc17(0xe3)]+'\x20'+_0x5c212c['currency']),console[_0x2ddc17(0x102)](_0x2ddc17(0xf5)+_0x2657d2+'\x20('+_0x2ae1a0+')'),console[_0x2ddc17(0x102)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x390c3d||_0x2ddc17(0x10f))),console[_0x2ddc17(0x102)]('\x20\x20\x20Description:\x20'+_0x39eeca);const _0x13a6da=await this[_0x2ddc17(0x142)][_0x2ddc17(0x149)](Math[_0x2ddc17(0x122)](_0x5c212c[_0x2ddc17(0xe3)]*0x64),_0x5c212c[_0x2ddc17(0xf0)],_0x39eeca,_0x505a41,_0x39a547,_0xa2b46,_0x2d1259,_0x20f91a,_0x1fea3a),_0x505baa=this[_0x2ddc17(0x142)][_0x2ddc17(0xfa)](_0x13a6da),_0x556728={'gatewayPaymentId':_0x13a6da[_0x2ddc17(0xf7)],'cardLast4':_0x505baa[_0x2ddc17(0x153)],'gateway':_0x2ddc17(0xfc),'customerEmail':_0x2657d2,'customerPhone':_0x1fea3a,'customerBirthDate':_0xb8cb0,'billingAddress':_0x2f3e61,'billingCity':_0x10df73,'billingState':_0x2c08c9,'billingZip':_0x232714,'customerCountry':_0x390c3d};if(_0x505baa['status']==='PAID'){_0x556728[_0x2ddc17(0x111)]='PAID',_0x556728['paidAt']=new Date();try{const _0x212cd1=await this[_0x2ddc17(0xe1)][_0x2ddc17(0x151)](_0x5c212c[_0x2ddc17(0xe3)],_0x5c212c['currency']);_0x556728['amountUSDT']=_0x212cd1,console[_0x2ddc17(0x102)](_0x2ddc17(0x10c)+_0x212cd1+_0x2ddc17(0x141));const _0x3b9ff2=await this[_0x2ddc17(0x11e)][_0x2ddc17(0xed)](_0x5c212c[_0x2ddc17(0x123)],_0x5c212c[_0x2ddc17(0x104)]),_0x3165e3=_0x212cd1*(0x1-_0x3b9ff2/0x64);_0x556728['amountAfterGatewayCommissionUSDT']=_0x3165e3,_0x556728['gatewayCommissionRate']=_0x3b9ff2,console[_0x2ddc17(0x102)](_0x2ddc17(0xf4)+_0x5c212c['gateway']+_0x2ddc17(0xe6)+_0x3b9ff2+'%'),console['log'](_0x2ddc17(0x143)+_0x3165e3[_0x2ddc17(0xdd)](0x6)+'\x20USDT');}catch(_0x49c6cb){console[_0x2ddc17(0xeb)](_0x2ddc17(0x10d),_0x49c6cb),_0x556728['amountUSDT']=0x0,_0x556728[_0x2ddc17(0x14f)]=0x0,_0x556728[_0x2ddc17(0x12f)]=0x0;}}else _0x505baa[_0x2ddc17(0x111)]===_0x2ddc17(0xfd)&&(_0x556728[_0x2ddc17(0x111)]='FAILED',_0x556728['failureMessage']=_0x505baa[_0x2ddc17(0x12c)]);const _0xcb67d3=await database_1[_0x2ddc17(0xdf)]['payment'][_0x2ddc17(0x14d)]({'where':{'id':_0x10af9e},'data':_0x556728});console['log'](_0x2ddc17(0xe5)+_0xcb67d3[_0x2ddc17(0x111)]);let _0x4574f6;if(_0x505baa[_0x2ddc17(0x111)]===_0x2ddc17(0xfd))_0x4574f6=_0x505baa[_0x2ddc17(0x12c)]||_0x13a6da[_0x2ddc17(0xff)]||'Payment\x20failed';else _0x505baa[_0x2ddc17(0x111)]===_0x2ddc17(0x10b)?_0x4574f6=_0x13a6da['friendly_message']||_0x2ddc17(0x137):_0x4574f6=_0x13a6da[_0x2ddc17(0xff)]||_0x2ddc17(0x114);const _0x53817b={'success':_0x505baa[_0x2ddc17(0x111)]!==_0x2ddc17(0xfd),'status':_0x505baa['status'],'message':_0x4574f6,'payment':{'id':_0x10af9e,'status':_0xcb67d3['status'],'gateway':_0x2ddc17(0xfc),'last4':_0x505baa[_0x2ddc17(0x153)]}};_0x505baa['redirectUrl']&&(_0x53817b[_0x2ddc17(0xdb)]=_0x505baa[_0x2ddc17(0x145)],_0x53817b[_0x2ddc17(0x13b)]=!![],console[_0x2ddc17(0x102)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x505baa[_0x2ddc17(0x145)])),_0x3075be['json'](_0x53817b);}catch(_0x1d4f7){console[_0x2ddc17(0xeb)](_0x2ddc17(0x121),_0x1d4f7),_0x4c1fd9(_0x1d4f7);}},this[_0x3d17ee(0x130)]=async(_0x3758bd,_0x1ccf0b,_0x2beaba)=>{const _0x90426b=_0x3d17ee;try{console[_0x90426b(0x102)](_0x90426b(0x132)),console[_0x90426b(0x102)]('Headers:',_0x3758bd[_0x90426b(0xec)]),console['log'](_0x90426b(0x11a),_0x3758bd['body']),this[_0x90426b(0x142)][_0x90426b(0x14a)]({'headers':_0x3758bd[_0x90426b(0xec)],'body':_0x3758bd[_0x90426b(0x147)],'timestamp':new Date()[_0x90426b(0xde)]()});const _0x3ab519=_0x3758bd[_0x90426b(0x147)];if(!_0x3ab519[_0x90426b(0xf7)]||!_0x3ab519[_0x90426b(0x111)])return console[_0x90426b(0x10a)](_0x90426b(0x109)),_0x1ccf0b[_0x90426b(0x111)](0x190)[_0x90426b(0x156)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x2953c8;_0x3ab519[_0x90426b(0xf7)]&&(_0x2953c8=await database_1['default'][_0x90426b(0x116)][_0x90426b(0x150)]({'where':{'gatewayPaymentId':_0x3ab519[_0x90426b(0xf7)],'gateway':_0x90426b(0xfc)}}));if(!_0x2953c8)return console['warn'](_0x90426b(0xef)),console[_0x90426b(0x10a)](_0x90426b(0x106)+_0x3ab519[_0x90426b(0xf7)]),console['warn'](_0x90426b(0x139)+_0x3ab519[_0x90426b(0x126)]),console[_0x90426b(0x10a)](_0x90426b(0x107)),console['warn'](_0x90426b(0x12d)+_0x3ab519[_0x90426b(0xf7)]),_0x1ccf0b['status'](0x194)[_0x90426b(0x156)]({'success':![],'message':_0x90426b(0x12a)});console[_0x90426b(0x102)]('ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20'+_0x2953c8['id']),console['log'](_0x90426b(0xe8)+_0x2953c8[_0x90426b(0x111)]),console[_0x90426b(0x102)](_0x90426b(0x138)+_0x2953c8[_0x90426b(0xe9)]),console[_0x90426b(0x102)]('\x20\x20\x20Webhook\x20status:\x20'+_0x3ab519[_0x90426b(0x111)]),console[_0x90426b(0x102)](_0x90426b(0x115)+_0x3ab519[_0x90426b(0xf7)]);let _0x19a6a9=null;const _0x55a7a2={};switch(_0x3ab519[_0x90426b(0x111)]){case _0x90426b(0x108):_0x19a6a9=_0x90426b(0x120),console[_0x90426b(0x102)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x90426b(0xe7):_0x19a6a9=_0x90426b(0xfd),_0x55a7a2['failureMessage']=_0x3ab519[_0x90426b(0xff)]||_0x3ab519[_0x90426b(0x133)]||_0x90426b(0x131),console[_0x90426b(0x102)]('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x55a7a2[_0x90426b(0x12c)]);break;case _0x90426b(0xf2):console['log'](_0x90426b(0x11c));break;default:console['warn']('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x3ab519[_0x90426b(0x111)]);break;}if(_0x19a6a9&&_0x19a6a9!==_0x2953c8[_0x90426b(0x111)])console[_0x90426b(0x102)](_0x90426b(0x155)+_0x2953c8[_0x90426b(0x111)]+_0x90426b(0xf6)+_0x19a6a9),await this[_0x90426b(0x11e)][_0x90426b(0x140)](_0x2953c8['id'],_0x19a6a9,_0x55a7a2),console['log'](_0x90426b(0x157)+_0x2953c8['id']+_0x90426b(0x158)+_0x19a6a9+_0x90426b(0xfe));else _0x19a6a9&&console['log'](_0x90426b(0x112)+_0x2953c8['id']+_0x90426b(0x14b)+_0x19a6a9+_0x90426b(0x14e));_0x1ccf0b['status'](0xc8)[_0x90426b(0x156)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x2288bd){console[_0x90426b(0xeb)](_0x90426b(0x14c),_0x2288bd),_0x2beaba(_0x2288bd);}},this[_0x3d17ee(0x11d)]=async(_0x2585d8,_0x5868fa,_0x505afb)=>{const _0x317a53=_0x3d17ee;try{const {limit:_0x453b38}=_0x2585d8[_0x317a53(0x12b)],_0x15185e=this[_0x317a53(0x142)][_0x317a53(0x11d)](_0x453b38?parseInt(_0x453b38):0x32);_0x5868fa[_0x317a53(0x156)]({'success':!![],'result':{'logs':_0x15185e,'count':_0x15185e[_0x317a53(0x144)]}});}catch(_0x1adcc7){_0x505afb(_0x1adcc7);}},this[_0x3d17ee(0x142)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0x3d17ee(0x135)][_0x3d17ee(0xe4)]||'','secretKey':process[_0x3d17ee(0x135)][_0x3d17ee(0xee)]||'','baseUrl':process[_0x3d17ee(0x135)][_0x3d17ee(0x134)]||'https://gate.squirrel-pay.com','isTestMode':process[_0x3d17ee(0x135)][_0x3d17ee(0xf8)]===_0x3d17ee(0x124)}),this[_0x3d17ee(0xe1)]=new currencyService_1[(_0x3d17ee(0x152))](),this[_0x3d17ee(0x11e)]=new webhookService_1['WebhookService']();}}exports[a16_0x10c43c(0x12e)]=SquirrelPayController;