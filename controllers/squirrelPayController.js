'use strict';const a17_0x28cdfc=a17_0x47f9;(function(_0x455c37,_0x36c458){const _0x430f8d=a17_0x47f9,_0x4ddee1=_0x455c37();while(!![]){try{const _0x3048ed=parseInt(_0x430f8d(0x1d0))/0x1*(parseInt(_0x430f8d(0x236))/0x2)+-parseInt(_0x430f8d(0x1da))/0x3*(parseInt(_0x430f8d(0x207))/0x4)+-parseInt(_0x430f8d(0x1d4))/0x5*(-parseInt(_0x430f8d(0x23a))/0x6)+-parseInt(_0x430f8d(0x1c8))/0x7+-parseInt(_0x430f8d(0x206))/0x8*(parseInt(_0x430f8d(0x22b))/0x9)+parseInt(_0x430f8d(0x225))/0xa+-parseInt(_0x430f8d(0x1f1))/0xb*(-parseInt(_0x430f8d(0x235))/0xc);if(_0x3048ed===_0x36c458)break;else _0x4ddee1['push'](_0x4ddee1['shift']());}catch(_0x4212ed){_0x4ddee1['push'](_0x4ddee1['shift']());}}}(a17_0x1883,0x8ae80));function a17_0x47f9(_0x4dfb8d,_0x4849f8){_0x4dfb8d=_0x4dfb8d-0x1c8;const _0x188304=a17_0x1883();let _0x47f921=_0x188304[_0x4dfb8d];return _0x47f921;}var __importDefault=this&&this[a17_0x28cdfc(0x1eb)]||function(_0x317158){const _0x280417=a17_0x28cdfc;return _0x317158&&_0x317158[_0x280417(0x209)]?_0x317158:{'default':_0x317158};};Object[a17_0x28cdfc(0x234)](exports,'__esModule',{'value':!![]}),exports[a17_0x28cdfc(0x1d1)]=void 0x0;const squirrelPayService_1=require(a17_0x28cdfc(0x20a)),currencyService_1=require('../services/currencyService'),webhookService_1=require(a17_0x28cdfc(0x239)),database_1=__importDefault(require(a17_0x28cdfc(0x248))),ipHelper_1=require(a17_0x28cdfc(0x1ff)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x38e727){const _0x39fc14=a17_0x28cdfc;return ISO_COUNTRY_CODES['has'](_0x38e727[_0x39fc14(0x1d2)]());}function a17_0x1883(){const _0x5df033=['webhookService','\x20to\x20','body','amount','log','ðŸ’³\x20Card\x20brand\x20detected:\x20','status','\x20\x20\x20Gateway:\x20squirrelpay','convertToUSDT','headers','SQUIRREL_PAY_BASE_URL','round','warn','/payment/pending?id=','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','redirect_url','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','FAILED','\x20\x20\x20Webhook\x20UID:\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','FRONTEND_URL','processCardPayment','âœ…\x20Payment\x20','1102690oQjoYu','payment_method','gatewayCommissionRate','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','findFirst','SquirrelPayService','6814611PmHPTN','cardBrand','\x20\x20\x20Customer:\x20','https://gate.squirrel-pay.com','description','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','getPaymentStatus','brand','incomplete','defineProperty','7867212hKirRd','354086GwPUjq','\x20\x20\x20Payment\x20ID:\x20','env','../services/webhookService','5368638rjMwFk','default','last_4','\x20updated:\x20status=','https://app.trapay.uk','true','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Webhook\x20status:\x20','currency','PENDING','Payment\x20is\x20being\x20processed','update','\x20\x20\x20Billing\x20Country:\x20','toFixed','../config/database','5868205SiDohO','ðŸ’°\x20Calculated\x20amountUSDT:\x20','friendly_message','payment','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','amountUSDT','requires_action','CurrencyService','5dsXqoX','SquirrelPayController','toUpperCase','gateway','5VXeRrA','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','cardLast4','squirrelpay','slice','failureMessage','3RTVtpp','error','SQUIRREL_PAY_SHOP_ID','getGatewayCommission','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','shopId','Webhook\x20processed\x20successfully','padStart','message','SQUIRREL_PAY_TEST_MODE','redirectUrl','currencyService','logWebhook','\x20\x20\x20UID:\x20','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','getWebhookLogs','Payment\x20not\x20found','__importDefault','Headers:','not\x20provided','PAID','WebhookService','https://api.trapay.uk','22KEHohj','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','handleWebhook','Missing\x20required\x20card\x20or\x20customer\x20information','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','\x20\x20\x20Description:\x20','amountAfterGatewayCommissionUSDT','Payment\x20processed\x20successfully','uid','updatePaymentStatus','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','json','Payment\x20failed','getClientIP','../utils/ipHelper','query','Body:','API_BASE_URL','/api/webhooks/squirrel-pay','squirrelPayService','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','8JclPLq','4148020hdNsLi','findUnique','__esModule','../services/gateways/squirrelPayService','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received'];a17_0x1883=function(){return _0x5df033;};return a17_0x1883();}class SquirrelPayController{constructor(){const _0xd8b67a=a17_0x28cdfc;this[_0xd8b67a(0x223)]=async(_0x15d696,_0x544c30,_0x21fb7f)=>{const _0x349367=_0xd8b67a;try{const {paymentId:_0x39fac6}=_0x15d696['params'],{card_number:_0x2e00ff,exp_month:_0xd5c7a8,exp_year:_0x3a4a09,cvv:_0x5a44c4,holder_name:_0x142181,customer_email:_0x193fb8,customer_birth_date:_0x1f5ddc,billing_country:_0x188d45,customer_phone:_0x44533d,billing_address:_0x5ecea5,billing_city:_0x17d70c,billing_state:_0x49c0e3,billing_zip:_0x272d82}=_0x15d696[_0x349367(0x20f)];console[_0x349367(0x211)](_0x349367(0x21d)+_0x39fac6);if(!_0x2e00ff||!_0xd5c7a8||!_0x3a4a09||!_0x5a44c4||!_0x142181||!_0x193fb8)return _0x544c30[_0x349367(0x213)](0x190)[_0x349367(0x1fc)]({'success':![],'message':_0x349367(0x1f4)});if(_0x188d45&&!isValidCountryCode(_0x188d45))return _0x544c30[_0x349367(0x213)](0x190)[_0x349367(0x1fc)]({'success':![],'message':_0x349367(0x221)});const _0x1fc974=await database_1[_0x349367(0x23b)][_0x349367(0x1cb)][_0x349367(0x208)]({'where':{'id':_0x39fac6},'include':{'shop':!![]}});if(!_0x1fc974)return _0x544c30[_0x349367(0x213)](0x194)[_0x349367(0x1fc)]({'success':![],'message':_0x349367(0x1ea)});if(_0x1fc974[_0x349367(0x213)]!==_0x349367(0x243))return _0x544c30['status'](0x190)[_0x349367(0x1fc)]({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0x3d728f=(0x0,ipHelper_1[_0x349367(0x1fe)])(_0x15d696),_0x3d3a89={'number':_0x2e00ff['replace'](/\s/g,''),'exp_month':_0xd5c7a8['toString']()[_0x349367(0x1e1)](0x2,'0'),'exp_year':_0x3a4a09['toString'](),'verification_value':_0x5a44c4,'holder':_0x142181[_0x349367(0x1d2)]()},_0x29459b={'ip':_0x3d728f,'email':_0x193fb8};_0x1f5ddc&&(_0x29459b['birth_date']=_0x1f5ddc);let _0x1dad6f;_0x188d45&&(_0x1dad6f={'country':_0x188d45,'address':_0x5ecea5,'city':_0x17d70c,'state':_0x49c0e3,'zip':_0x272d82});const _0x5e9bd7=(process['env'][_0x349367(0x222)]||_0x349367(0x23e))+_0x349367(0x21a)+_0x39fac6+'&payment_id='+(_0x1fc974['gatewayOrderId']||_0x39fac6),_0x185046=(process[_0x349367(0x238)][_0x349367(0x202)]||_0x349367(0x1f0))+_0x349367(0x203),_0xf2a8bc=_0x39fac6[_0x349367(0x1d8)](0x0,0x8)+'-'+_0x39fac6['slice'](0x8,0x10);console[_0x349367(0x211)]('ðŸ“\x20SquirrelPay\x20payment\x20details:'),console[_0x349367(0x211)](_0x349367(0x237)+_0x39fac6),console['log']('\x20\x20\x20Amount:\x20'+_0x1fc974[_0x349367(0x210)]+'\x20'+_0x1fc974[_0x349367(0x242)]),console[_0x349367(0x211)](_0x349367(0x22d)+_0x193fb8+'\x20('+_0x3d728f+')'),console[_0x349367(0x211)](_0x349367(0x246)+(_0x188d45||_0x349367(0x1ed))),console['log'](_0x349367(0x1f6)+_0xf2a8bc);const _0x247c38=await this[_0x349367(0x204)][_0x349367(0x223)](Math[_0x349367(0x218)](_0x1fc974[_0x349367(0x210)]*0x64),_0x1fc974[_0x349367(0x242)],_0xf2a8bc,_0x5e9bd7,_0x185046,_0x3d3a89,_0x29459b,_0x1dad6f,_0x44533d),_0x48c405=this['squirrelPayService'][_0x349367(0x231)](_0x247c38),_0x12b4c6={'gatewayPaymentId':_0x247c38[_0x349367(0x1f9)],'cardLast4':_0x48c405[_0x349367(0x1d6)],'gateway':_0x349367(0x1d7),'customerEmail':_0x193fb8,'customerPhone':_0x44533d,'customerBirthDate':_0x1f5ddc,'billingAddress':_0x5ecea5,'billingCity':_0x17d70c,'billingState':_0x49c0e3,'billingZip':_0x272d82,'customerCountry':_0x188d45};if(_0x48c405['status']===_0x349367(0x1ee)){_0x12b4c6['status']=_0x349367(0x1ee),_0x12b4c6['paidAt']=new Date();try{const _0x5dd628=await this[_0x349367(0x1e5)][_0x349367(0x215)](_0x1fc974['amount'],_0x1fc974[_0x349367(0x242)]);_0x12b4c6[_0x349367(0x1cd)]=_0x5dd628,console[_0x349367(0x211)](_0x349367(0x1c9)+_0x5dd628+'\x20USDT');const _0x1da39d=await this[_0x349367(0x20d)][_0x349367(0x1dd)](_0x1fc974[_0x349367(0x1df)],_0x1fc974[_0x349367(0x1d3)]),_0x4a524c=_0x5dd628*(0x1-_0x1da39d/0x64);_0x12b4c6[_0x349367(0x1f7)]=_0x4a524c,_0x12b4c6[_0x349367(0x227)]=_0x1da39d,console[_0x349367(0x211)]('ðŸ’°\x20Gateway\x20'+_0x1fc974['gateway']+'\x20commission:\x20'+_0x1da39d+'%'),console['log'](_0x349367(0x1d5)+_0x4a524c[_0x349367(0x247)](0x6)+'\x20USDT');}catch(_0x1b310d){console[_0x349367(0x1db)](_0x349367(0x20b),_0x1b310d),_0x12b4c6[_0x349367(0x1cd)]=0x0,_0x12b4c6[_0x349367(0x1f7)]=0x0,_0x12b4c6[_0x349367(0x227)]=0x0;}}else _0x48c405[_0x349367(0x213)]==='FAILED'&&(_0x12b4c6[_0x349367(0x213)]=_0x349367(0x21f),_0x12b4c6['failureMessage']=_0x48c405['failureMessage']);const _0x24c27f=await database_1[_0x349367(0x23b)][_0x349367(0x1cb)][_0x349367(0x245)]({'where':{'id':_0x39fac6},'data':_0x12b4c6});console['log'](_0x349367(0x1cc)+_0x24c27f[_0x349367(0x213)]);let _0x2a35cf;if(_0x48c405['status']===_0x349367(0x21f))_0x2a35cf=_0x48c405[_0x349367(0x1d9)]||_0x247c38['friendly_message']||_0x349367(0x1fd);else _0x48c405[_0x349367(0x213)]===_0x349367(0x243)?_0x2a35cf=_0x247c38[_0x349367(0x1ca)]||_0x349367(0x244):_0x2a35cf=_0x247c38[_0x349367(0x1ca)]||_0x349367(0x1f8);const _0x23aad3={'success':_0x48c405['status']!=='FAILED','status':_0x48c405[_0x349367(0x213)],'message':_0x2a35cf,'payment':{'id':_0x39fac6,'status':_0x24c27f['status'],'gateway':_0x349367(0x1d7),'last4':_0x48c405['cardLast4']}};_0x48c405[_0x349367(0x1e4)]&&(_0x23aad3[_0x349367(0x21c)]=_0x48c405[_0x349367(0x1e4)],_0x23aad3[_0x349367(0x1ce)]=!![],console[_0x349367(0x211)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x48c405[_0x349367(0x1e4)])),_0x544c30['json'](_0x23aad3);}catch(_0x5a266b){console[_0x349367(0x1db)](_0x349367(0x21e),_0x5a266b),_0x21fb7f(_0x5a266b);}},this[_0xd8b67a(0x1f3)]=async(_0x1fb2b2,_0x178376,_0x359f77)=>{const _0x5969a8=_0xd8b67a;try{console[_0x5969a8(0x211)](_0x5969a8(0x20c)),console['log'](_0x5969a8(0x1ec),_0x1fb2b2[_0x5969a8(0x216)]),console['log'](_0x5969a8(0x201),_0x1fb2b2['body']),this['squirrelPayService'][_0x5969a8(0x1e6)]({'headers':_0x1fb2b2[_0x5969a8(0x216)],'body':_0x1fb2b2[_0x5969a8(0x20f)],'timestamp':new Date()['toISOString']()});const _0x42333f=_0x1fb2b2[_0x5969a8(0x20f)];if(!_0x42333f[_0x5969a8(0x1f9)]||!_0x42333f[_0x5969a8(0x213)])return console[_0x5969a8(0x219)](_0x5969a8(0x1f2)),_0x178376[_0x5969a8(0x213)](0x190)['json']({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x1b3f6a;_0x42333f[_0x5969a8(0x1f9)]&&(_0x1b3f6a=await database_1[_0x5969a8(0x23b)][_0x5969a8(0x1cb)][_0x5969a8(0x229)]({'where':{'gatewayPaymentId':_0x42333f[_0x5969a8(0x1f9)],'gateway':_0x5969a8(0x1d7)}}));if(!_0x1b3f6a)return console[_0x5969a8(0x219)](_0x5969a8(0x1f5)),console[_0x5969a8(0x219)](_0x5969a8(0x1e7)+_0x42333f[_0x5969a8(0x1f9)]),console[_0x5969a8(0x219)](_0x5969a8(0x1f6)+_0x42333f[_0x5969a8(0x22f)]),console[_0x5969a8(0x219)](_0x5969a8(0x214)),console[_0x5969a8(0x219)](_0x5969a8(0x205)+_0x42333f[_0x5969a8(0x1f9)]),_0x178376[_0x5969a8(0x213)](0x194)[_0x5969a8(0x1fc)]({'success':![],'message':_0x5969a8(0x1ea)});console[_0x5969a8(0x211)](_0x5969a8(0x1e8)+_0x1b3f6a['id']),console[_0x5969a8(0x211)](_0x5969a8(0x1fb)+_0x1b3f6a[_0x5969a8(0x213)]),console[_0x5969a8(0x211)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x1b3f6a['gatewayPaymentId']),console[_0x5969a8(0x211)](_0x5969a8(0x241)+_0x42333f[_0x5969a8(0x213)]),console[_0x5969a8(0x211)](_0x5969a8(0x220)+_0x42333f['uid']);let _0x433b02=null;const _0x8b2bac={};_0x42333f[_0x5969a8(0x226)]?.['brand']&&(_0x8b2bac[_0x5969a8(0x22c)]=_0x42333f[_0x5969a8(0x226)][_0x5969a8(0x232)],console[_0x5969a8(0x211)](_0x5969a8(0x212)+_0x42333f['payment_method'][_0x5969a8(0x232)]));_0x42333f['payment_method']?.[_0x5969a8(0x23c)]&&(_0x8b2bac[_0x5969a8(0x1d6)]=_0x42333f[_0x5969a8(0x226)][_0x5969a8(0x23c)],console[_0x5969a8(0x211)]('ðŸ’³\x20Card\x20last\x204:\x20'+_0x42333f[_0x5969a8(0x226)]['last_4']));switch(_0x42333f['status']){case'successful':_0x433b02=_0x5969a8(0x1ee),console[_0x5969a8(0x211)](_0x5969a8(0x240));break;case'failed':_0x433b02=_0x5969a8(0x21f),_0x8b2bac['failureMessage']=_0x42333f['friendly_message']||_0x42333f[_0x5969a8(0x1e2)]||_0x5969a8(0x1fd),console[_0x5969a8(0x211)](_0x5969a8(0x230)+_0x8b2bac[_0x5969a8(0x1d9)]);break;case _0x5969a8(0x233):console[_0x5969a8(0x211)](_0x5969a8(0x21b));break;default:console['warn'](_0x5969a8(0x228)+_0x42333f[_0x5969a8(0x213)]);break;}if(_0x433b02&&_0x433b02!==_0x1b3f6a['status'])console['log'](_0x5969a8(0x1de)+_0x1b3f6a['status']+_0x5969a8(0x20e)+_0x433b02),await this[_0x5969a8(0x20d)][_0x5969a8(0x1fa)](_0x1b3f6a['id'],_0x433b02,_0x8b2bac),console[_0x5969a8(0x211)](_0x5969a8(0x224)+_0x1b3f6a['id']+_0x5969a8(0x23d)+_0x433b02+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x433b02&&console[_0x5969a8(0x211)]('â„¹ï¸\x20Payment\x20'+_0x1b3f6a['id']+'\x20already\x20has\x20status\x20'+_0x433b02+',\x20skipping\x20update');_0x178376[_0x5969a8(0x213)](0xc8)[_0x5969a8(0x1fc)]({'success':!![],'message':_0x5969a8(0x1e0)});}catch(_0x28ea05){console[_0x5969a8(0x1db)]('âŒ\x20SquirrelPay\x20webhook\x20error:',_0x28ea05),_0x359f77(_0x28ea05);}},this[_0xd8b67a(0x1e9)]=async(_0x33966d,_0x23809f,_0x61d6df)=>{const _0x580240=_0xd8b67a;try{const {limit:_0x3a5f32}=_0x33966d[_0x580240(0x200)],_0x17eaac=this[_0x580240(0x204)][_0x580240(0x1e9)](_0x3a5f32?parseInt(_0x3a5f32):0x32);_0x23809f[_0x580240(0x1fc)]({'success':!![],'result':{'logs':_0x17eaac,'count':_0x17eaac['length']}});}catch(_0x522c69){_0x61d6df(_0x522c69);}},this[_0xd8b67a(0x204)]=new squirrelPayService_1[(_0xd8b67a(0x22a))]({'shopId':process[_0xd8b67a(0x238)][_0xd8b67a(0x1dc)]||'','secretKey':process[_0xd8b67a(0x238)]['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0xd8b67a(0x238)][_0xd8b67a(0x217)]||_0xd8b67a(0x22e),'isTestMode':process[_0xd8b67a(0x238)][_0xd8b67a(0x1e3)]===_0xd8b67a(0x23f)}),this[_0xd8b67a(0x1e5)]=new currencyService_1[(_0xd8b67a(0x1cf))](),this[_0xd8b67a(0x20d)]=new webhookService_1[(_0xd8b67a(0x1ef))]();}}exports[a17_0x28cdfc(0x1d1)]=SquirrelPayController;