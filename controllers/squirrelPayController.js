'use strict';const a17_0x162ac9=a17_0x1b53;(function(_0x2d1256,_0x379108){const _0x3bfa07=a17_0x1b53,_0x2101a2=_0x2d1256();while(!![]){try{const _0x38e849=parseInt(_0x3bfa07(0x1ff))/0x1+parseInt(_0x3bfa07(0x1ac))/0x2+parseInt(_0x3bfa07(0x194))/0x3*(parseInt(_0x3bfa07(0x213))/0x4)+parseInt(_0x3bfa07(0x1a6))/0x5+parseInt(_0x3bfa07(0x20e))/0x6+-parseInt(_0x3bfa07(0x1ad))/0x7+parseInt(_0x3bfa07(0x1e8))/0x8*(-parseInt(_0x3bfa07(0x1e5))/0x9);if(_0x38e849===_0x379108)break;else _0x2101a2['push'](_0x2101a2['shift']());}catch(_0x34ad5f){_0x2101a2['push'](_0x2101a2['shift']());}}}(a17_0x3894,0x2e820));var __importDefault=this&&this['__importDefault']||function(_0x38429a){const _0x432a08=a17_0x1b53;return _0x38429a&&_0x38429a[_0x432a08(0x1d6)]?_0x38429a:{'default':_0x38429a};};Object[a17_0x162ac9(0x1ae)](exports,a17_0x162ac9(0x1d6),{'value':!![]}),exports[a17_0x162ac9(0x1bb)]=void 0x0;function a17_0x3894(){const _0x56e96b=['1245489eTcpUu','defineProperty','../utils/ipHelper','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','slice','headers','\x20updated:\x20status=','ðŸ’°\x20Gateway\x20','../config/database','true','squirrelPayService','https://gate.squirrel-pay.com','convertToUSDT','SquirrelPayController','body','ðŸ’°\x20Calculated\x20amountUSDT:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','paidAt','round','shopId','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','/api/webhooks/squirrel-pay','PAID','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','\x20\x20\x20Webhook\x20status:\x20','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','toUpperCase','âŒ\x20SquirrelPay\x20webhook\x20error:',',\x20balance\x20updated,\x20amountUSDT\x20calculated','update','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','\x20\x20\x20Payment\x20ID:\x20','../services/currencyService','amountUSDT','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','Payment\x20processed\x20successfully','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','__esModule','successful','message','getClientIP','\x20commission:\x20','Missing\x20required\x20card\x20or\x20customer\x20information','FRONTEND_URL','log','status','\x20\x20\x20Billing\x20Country:\x20','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','getWebhookLogs','SQUIRREL_PAY_BASE_URL','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','SQUIRREL_PAY_SECRET_KEY','9RCivtx','\x20\x20\x20Webhook\x20UID:\x20','\x20\x20\x20Customer:\x20','457544SoUaCX','handleWebhook','failureMessage','currencyService','toString','brand','ðŸ’³\x20Card\x20brand\x20detected:\x20','WebhookService','SQUIRREL_PAY_SHOP_ID','redirectUrl','gateway','error','incomplete','\x20\x20\x20Amount:\x20','FAILED','friendly_message','warn','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','\x20to\x20','currency','failed','requires_action','params','62248CsyXgF','payment_method','replace','cardBrand','query','updatePaymentStatus','last_4','Payment\x20is\x20not\x20in\x20pending\x20status','Payment\x20failed','squirrelpay','padStart','Payment\x20not\x20found','\x20\x20\x20Description:\x20','Webhook\x20processed\x20successfully','amount','657510hwFJRJ','payment','json','../services/webhookService','webhookService','4qoZsxq','https://api.trapay.uk','https://app.trapay.uk','uid','\x20\x20\x20Gateway:\x20squirrelpay','env','24477DQmOCe','\x20\x20\x20UID:\x20','toFixed','Missing\x20required\x20fields\x20in\x20webhook','\x20already\x20has\x20status\x20','findFirst','has','cardLast4','description','PENDING','length','birth_date','API_BASE_URL','SQUIRREL_PAY_TEST_MODE','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','findUnique','redirect_url','306540YwGepG','âœ…\x20Payment\x20','default','Headers:','SquirrelPayService','gatewayCommissionRate','368632JEaTKP'];a17_0x3894=function(){return _0x56e96b;};return a17_0x3894();}const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a17_0x162ac9(0x1d0)),webhookService_1=require(a17_0x162ac9(0x211)),database_1=__importDefault(require(a17_0x162ac9(0x1b6))),ipHelper_1=require(a17_0x162ac9(0x1af)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x124ede){const _0x2e0b7c=a17_0x162ac9;return ISO_COUNTRY_CODES[_0x2e0b7c(0x19a)](_0x124ede[_0x2e0b7c(0x1c8)]());}class SquirrelPayController{constructor(){const _0x36eb3a=a17_0x162ac9;this['processCardPayment']=async(_0x393d26,_0x2a7d20,_0x5645fb)=>{const _0xa03e52=a17_0x1b53;try{const {paymentId:_0x5991b3}=_0x393d26[_0xa03e52(0x1fe)],{card_number:_0x3b92f8,exp_month:_0x33ccf9,exp_year:_0x2bcabe,cvv:_0x2d5723,holder_name:_0x5ac9c3,customer_email:_0x456834,customer_birth_date:_0x5ac798,billing_country:_0x26bdd8,customer_phone:_0x2a4883,billing_address:_0x47dcf6,billing_city:_0x3be36a,billing_state:_0x2c8d7c,billing_zip:_0x1b60f0}=_0x393d26[_0xa03e52(0x1bc)];console[_0xa03e52(0x1dd)](_0xa03e52(0x1c7)+_0x5991b3);if(!_0x3b92f8||!_0x33ccf9||!_0x2bcabe||!_0x2d5723||!_0x5ac9c3||!_0x456834)return _0x2a7d20[_0xa03e52(0x1de)](0x190)[_0xa03e52(0x210)]({'success':![],'message':_0xa03e52(0x1db)});if(_0x26bdd8&&!isValidCountryCode(_0x26bdd8))return _0x2a7d20[_0xa03e52(0x1de)](0x190)[_0xa03e52(0x210)]({'success':![],'message':_0xa03e52(0x1a3)});const _0x10246e=await database_1[_0xa03e52(0x1a8)][_0xa03e52(0x20f)][_0xa03e52(0x1a4)]({'where':{'id':_0x5991b3},'include':{'shop':!![]}});if(!_0x10246e)return _0x2a7d20['status'](0x194)[_0xa03e52(0x210)]({'success':![],'message':_0xa03e52(0x20a)});if(_0x10246e[_0xa03e52(0x1de)]!==_0xa03e52(0x19d))return _0x2a7d20['status'](0x190)[_0xa03e52(0x210)]({'success':![],'message':_0xa03e52(0x206)});const _0x247b70=(0x0,ipHelper_1[_0xa03e52(0x1d9)])(_0x393d26),_0x39d9d0={'number':_0x3b92f8[_0xa03e52(0x201)](/\s/g,''),'exp_month':_0x33ccf9['toString']()[_0xa03e52(0x209)](0x2,'0'),'exp_year':_0x2bcabe[_0xa03e52(0x1ec)](),'verification_value':_0x2d5723,'holder':_0x5ac9c3['toUpperCase']()},_0x1feef0={'ip':_0x247b70,'email':_0x456834};_0x5ac798&&(_0x1feef0[_0xa03e52(0x19f)]=_0x5ac798);let _0x4e8cb3;_0x26bdd8&&(_0x4e8cb3={'country':_0x26bdd8,'address':_0x47dcf6,'city':_0x3be36a,'state':_0x2c8d7c,'zip':_0x1b60f0});const _0x1c4ae8=(process[_0xa03e52(0x193)][_0xa03e52(0x1dc)]||_0xa03e52(0x190))+'/payment/pending?id='+_0x5991b3+'&payment_id='+(_0x10246e['gatewayOrderId']||_0x5991b3),_0x5971ff=(process[_0xa03e52(0x193)][_0xa03e52(0x1a0)]||_0xa03e52(0x18f))+_0xa03e52(0x1c3),_0x556df3=_0x5991b3['slice'](0x0,0x8)+'-'+_0x5991b3[_0xa03e52(0x1b2)](0x8,0x10);console[_0xa03e52(0x1dd)](_0xa03e52(0x1be)),console[_0xa03e52(0x1dd)](_0xa03e52(0x1cf)+_0x5991b3),console[_0xa03e52(0x1dd)](_0xa03e52(0x1f5)+_0x10246e['amount']+'\x20'+_0x10246e[_0xa03e52(0x1fb)]),console[_0xa03e52(0x1dd)](_0xa03e52(0x1e7)+_0x456834+'\x20('+_0x247b70+')'),console['log'](_0xa03e52(0x1df)+(_0x26bdd8||'not\x20provided')),console[_0xa03e52(0x1dd)]('\x20\x20\x20Description:\x20'+_0x556df3);const _0x577990=await this[_0xa03e52(0x1b8)]['processCardPayment'](Math[_0xa03e52(0x1c0)](_0x10246e['amount']*0x64),_0x10246e[_0xa03e52(0x1fb)],_0x556df3,_0x1c4ae8,_0x5971ff,_0x39d9d0,_0x1feef0,_0x4e8cb3,_0x2a4883),_0x1df9e4=this[_0xa03e52(0x1b8)]['getPaymentStatus'](_0x577990),_0x5879d7={'gatewayPaymentId':_0x577990[_0xa03e52(0x191)],'cardLast4':_0x1df9e4[_0xa03e52(0x19b)],'gateway':_0xa03e52(0x208),'customerEmail':_0x456834,'customerPhone':_0x2a4883,'customerBirthDate':_0x5ac798,'billingAddress':_0x47dcf6,'billingCity':_0x3be36a,'billingState':_0x2c8d7c,'billingZip':_0x1b60f0,'customerCountry':_0x26bdd8};if(_0x1df9e4[_0xa03e52(0x1de)]===_0xa03e52(0x1c4)){_0x5879d7['status']='PAID',_0x5879d7[_0xa03e52(0x1bf)]=new Date();try{const _0x141745=await this[_0xa03e52(0x1eb)][_0xa03e52(0x1ba)](_0x10246e[_0xa03e52(0x20d)],_0x10246e['currency']);_0x5879d7[_0xa03e52(0x1d1)]=_0x141745,console[_0xa03e52(0x1dd)](_0xa03e52(0x1bd)+_0x141745+'\x20USDT');const _0x2c4783=await this[_0xa03e52(0x212)]['getGatewayCommission'](_0x10246e[_0xa03e52(0x1c1)],_0x10246e[_0xa03e52(0x1f2)]),_0x248299=_0x141745*(0x1-_0x2c4783/0x64);_0x5879d7['amountAfterGatewayCommissionUSDT']=_0x248299,_0x5879d7[_0xa03e52(0x1ab)]=_0x2c4783,console[_0xa03e52(0x1dd)](_0xa03e52(0x1b5)+_0x10246e[_0xa03e52(0x1f2)]+_0xa03e52(0x1da)+_0x2c4783+'%'),console[_0xa03e52(0x1dd)](_0xa03e52(0x1b1)+_0x248299[_0xa03e52(0x196)](0x6)+'\x20USDT');}catch(_0x1992d6){console['error'](_0xa03e52(0x1cc),_0x1992d6),_0x5879d7[_0xa03e52(0x1d1)]=0x0,_0x5879d7['amountAfterGatewayCommissionUSDT']=0x0,_0x5879d7['gatewayCommissionRate']=0x0;}}else _0x1df9e4[_0xa03e52(0x1de)]===_0xa03e52(0x1f6)&&(_0x5879d7['status']=_0xa03e52(0x1f6),_0x5879d7[_0xa03e52(0x1ea)]=_0x1df9e4['failureMessage']);const _0x46b878=await database_1[_0xa03e52(0x1a8)][_0xa03e52(0x20f)][_0xa03e52(0x1cb)]({'where':{'id':_0x5991b3},'data':_0x5879d7});console[_0xa03e52(0x1dd)](_0xa03e52(0x1b0)+_0x46b878[_0xa03e52(0x1de)]);let _0x340982;if(_0x1df9e4[_0xa03e52(0x1de)]===_0xa03e52(0x1f6))_0x340982=_0x1df9e4[_0xa03e52(0x1ea)]||_0x577990[_0xa03e52(0x1f7)]||_0xa03e52(0x207);else _0x1df9e4[_0xa03e52(0x1de)]===_0xa03e52(0x19d)?_0x340982=_0x577990[_0xa03e52(0x1f7)]||'Payment\x20is\x20being\x20processed':_0x340982=_0x577990[_0xa03e52(0x1f7)]||_0xa03e52(0x1d4);const _0x238788={'success':_0x1df9e4[_0xa03e52(0x1de)]!=='FAILED','status':_0x1df9e4[_0xa03e52(0x1de)],'message':_0x340982,'payment':{'id':_0x5991b3,'status':_0x46b878[_0xa03e52(0x1de)],'gateway':_0xa03e52(0x208),'last4':_0x1df9e4[_0xa03e52(0x19b)]}};_0x1df9e4['redirectUrl']&&(_0x238788[_0xa03e52(0x1a5)]=_0x1df9e4[_0xa03e52(0x1f1)],_0x238788[_0xa03e52(0x1fd)]=!![],console[_0xa03e52(0x1dd)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x1df9e4[_0xa03e52(0x1f1)])),_0x2a7d20[_0xa03e52(0x210)](_0x238788);}catch(_0x257d9f){console[_0xa03e52(0x1f3)](_0xa03e52(0x1e0),_0x257d9f),_0x5645fb(_0x257d9f);}},this[_0x36eb3a(0x1e9)]=async(_0xe1e56a,_0x48dd58,_0x5e0547)=>{const _0x1871f7=_0x36eb3a;try{console[_0x1871f7(0x1dd)](_0x1871f7(0x1d3)),console['log'](_0x1871f7(0x1a9),_0xe1e56a[_0x1871f7(0x1b3)]),console['log']('Body:',_0xe1e56a[_0x1871f7(0x1bc)]),this[_0x1871f7(0x1b8)]['logWebhook']({'headers':_0xe1e56a['headers'],'body':_0xe1e56a[_0x1871f7(0x1bc)],'timestamp':new Date()['toISOString']()});const _0x51a128=_0xe1e56a[_0x1871f7(0x1bc)];if(!_0x51a128[_0x1871f7(0x191)]||!_0x51a128['status'])return console[_0x1871f7(0x1f8)](_0x1871f7(0x1e3)),_0x48dd58[_0x1871f7(0x1de)](0x190)[_0x1871f7(0x210)]({'success':![],'message':_0x1871f7(0x197)});let _0x56ae8b;_0x51a128[_0x1871f7(0x191)]&&(_0x56ae8b=await database_1[_0x1871f7(0x1a8)][_0x1871f7(0x20f)][_0x1871f7(0x199)]({'where':{'gatewayPaymentId':_0x51a128[_0x1871f7(0x191)],'gateway':'squirrelpay'}}));if(!_0x56ae8b)return console['warn'](_0x1871f7(0x1d5)),console[_0x1871f7(0x1f8)](_0x1871f7(0x195)+_0x51a128[_0x1871f7(0x191)]),console['warn'](_0x1871f7(0x20b)+_0x51a128[_0x1871f7(0x19c)]),console[_0x1871f7(0x1f8)](_0x1871f7(0x192)),console[_0x1871f7(0x1f8)](_0x1871f7(0x1f9)+_0x51a128[_0x1871f7(0x191)]),_0x48dd58[_0x1871f7(0x1de)](0x194)[_0x1871f7(0x210)]({'success':![],'message':_0x1871f7(0x20a)});console[_0x1871f7(0x1dd)](_0x1871f7(0x1a2)+_0x56ae8b['id']),console[_0x1871f7(0x1dd)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x56ae8b['status']),console[_0x1871f7(0x1dd)](_0x1871f7(0x1c2)+_0x56ae8b['gatewayPaymentId']),console[_0x1871f7(0x1dd)](_0x1871f7(0x1c6)+_0x51a128[_0x1871f7(0x1de)]),console[_0x1871f7(0x1dd)](_0x1871f7(0x1e6)+_0x51a128[_0x1871f7(0x191)]);let _0x36ce56=null;const _0x5946ac={};_0x51a128[_0x1871f7(0x200)]?.[_0x1871f7(0x1ed)]&&(_0x5946ac[_0x1871f7(0x202)]=_0x51a128[_0x1871f7(0x200)]['brand'],console[_0x1871f7(0x1dd)](_0x1871f7(0x1ee)+_0x51a128[_0x1871f7(0x200)][_0x1871f7(0x1ed)]));_0x51a128[_0x1871f7(0x200)]?.[_0x1871f7(0x205)]&&(_0x5946ac[_0x1871f7(0x19b)]=_0x51a128[_0x1871f7(0x200)][_0x1871f7(0x205)],console[_0x1871f7(0x1dd)]('ðŸ’³\x20Card\x20last\x204:\x20'+_0x51a128[_0x1871f7(0x200)][_0x1871f7(0x205)]));switch(_0x51a128[_0x1871f7(0x1de)]){case _0x1871f7(0x1d7):_0x36ce56=_0x1871f7(0x1c4),console[_0x1871f7(0x1dd)](_0x1871f7(0x1ce));break;case _0x1871f7(0x1fc):_0x36ce56=_0x1871f7(0x1f6),_0x5946ac[_0x1871f7(0x1ea)]=_0x51a128[_0x1871f7(0x1f7)]||_0x51a128[_0x1871f7(0x1d8)]||_0x1871f7(0x207),console[_0x1871f7(0x1dd)](_0x1871f7(0x1d2)+_0x5946ac[_0x1871f7(0x1ea)]);break;case _0x1871f7(0x1f4):console[_0x1871f7(0x1dd)](_0x1871f7(0x1c5));break;default:console[_0x1871f7(0x1f8)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x51a128[_0x1871f7(0x1de)]);break;}if(_0x36ce56&&_0x36ce56!==_0x56ae8b['status'])console[_0x1871f7(0x1dd)](_0x1871f7(0x1cd)+_0x56ae8b[_0x1871f7(0x1de)]+_0x1871f7(0x1fa)+_0x36ce56),await this['webhookService'][_0x1871f7(0x204)](_0x56ae8b['id'],_0x36ce56,_0x5946ac),console['log'](_0x1871f7(0x1a7)+_0x56ae8b['id']+_0x1871f7(0x1b4)+_0x36ce56+_0x1871f7(0x1ca));else _0x36ce56&&console[_0x1871f7(0x1dd)]('â„¹ï¸\x20Payment\x20'+_0x56ae8b['id']+_0x1871f7(0x198)+_0x36ce56+',\x20skipping\x20update');_0x48dd58[_0x1871f7(0x1de)](0xc8)[_0x1871f7(0x210)]({'success':!![],'message':_0x1871f7(0x20c)});}catch(_0x521d3f){console[_0x1871f7(0x1f3)](_0x1871f7(0x1c9),_0x521d3f),_0x5e0547(_0x521d3f);}},this[_0x36eb3a(0x1e1)]=async(_0x1ea8e0,_0x52efad,_0x1c56de)=>{const _0x3ab846=_0x36eb3a;try{const {limit:_0x52be89}=_0x1ea8e0[_0x3ab846(0x203)],_0x54b345=this[_0x3ab846(0x1b8)]['getWebhookLogs'](_0x52be89?parseInt(_0x52be89):0x32);_0x52efad[_0x3ab846(0x210)]({'success':!![],'result':{'logs':_0x54b345,'count':_0x54b345[_0x3ab846(0x19e)]}});}catch(_0x339cfa){_0x1c56de(_0x339cfa);}},this[_0x36eb3a(0x1b8)]=new squirrelPayService_1[(_0x36eb3a(0x1aa))]({'shopId':process[_0x36eb3a(0x193)][_0x36eb3a(0x1f0)]||'','secretKey':process['env'][_0x36eb3a(0x1e4)]||'','baseUrl':process[_0x36eb3a(0x193)][_0x36eb3a(0x1e2)]||_0x36eb3a(0x1b9),'isTestMode':process[_0x36eb3a(0x193)][_0x36eb3a(0x1a1)]===_0x36eb3a(0x1b7)}),this['currencyService']=new currencyService_1['CurrencyService'](),this[_0x36eb3a(0x212)]=new webhookService_1[(_0x36eb3a(0x1ef))]();}}function a17_0x1b53(_0x353fb0,_0x554d32){_0x353fb0=_0x353fb0-0x18f;const _0x389482=a17_0x3894();let _0x1b53bc=_0x389482[_0x353fb0];return _0x1b53bc;}exports[a17_0x162ac9(0x1bb)]=SquirrelPayController;