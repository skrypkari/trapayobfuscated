'use strict';const a17_0x4c3f04=a17_0x181b;(function(_0x4c202e,_0x1ad5c7){const _0x71839f=a17_0x181b,_0xdcb757=_0x4c202e();while(!![]){try{const _0x1779a7=parseInt(_0x71839f(0x194))/0x1+-parseInt(_0x71839f(0x183))/0x2+parseInt(_0x71839f(0x1f6))/0x3*(parseInt(_0x71839f(0x17f))/0x4)+parseInt(_0x71839f(0x1d4))/0x5*(-parseInt(_0x71839f(0x1d0))/0x6)+parseInt(_0x71839f(0x1c3))/0x7*(-parseInt(_0x71839f(0x1a7))/0x8)+-parseInt(_0x71839f(0x1f7))/0x9*(-parseInt(_0x71839f(0x1e7))/0xa)+-parseInt(_0x71839f(0x18f))/0xb*(-parseInt(_0x71839f(0x1b2))/0xc);if(_0x1779a7===_0x1ad5c7)break;else _0xdcb757['push'](_0xdcb757['shift']());}catch(_0x47ff6a){_0xdcb757['push'](_0xdcb757['shift']());}}}(a17_0x28fa,0x36676));var __importDefault=this&&this['__importDefault']||function(_0x468db8){const _0x490e60=a17_0x181b;return _0x468db8&&_0x468db8[_0x490e60(0x1dd)]?_0x468db8:{'default':_0x468db8};};function a17_0x181b(_0x2c0636,_0x291bda){_0x2c0636=_0x2c0636-0x17c;const _0x28fae3=a17_0x28fa();let _0x181b63=_0x28fae3[_0x2c0636];return _0x181b63;}Object[a17_0x4c3f04(0x1c0)](exports,a17_0x4c3f04(0x1dd),{'value':!![]}),exports['SquirrelPayController']=void 0x0;const squirrelPayService_1=require(a17_0x4c3f04(0x1b7)),currencyService_1=require(a17_0x4c3f04(0x195)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a17_0x4c3f04(0x1d2))),ipHelper_1=require(a17_0x4c3f04(0x1c2)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x5d18a9){const _0x5c5fde=a17_0x4c3f04;return ISO_COUNTRY_CODES['has'](_0x5d18a9[_0x5c5fde(0x1f3)]());}class SquirrelPayController{constructor(){const _0x212ee6=a17_0x4c3f04;this[_0x212ee6(0x1ca)]=async(_0x1b5139,_0x266e70,_0x458ed9)=>{const _0xcfecc5=_0x212ee6;try{const {paymentId:_0x270302}=_0x1b5139[_0xcfecc5(0x1ec)],{card_number:_0x4440d4,exp_month:_0x125188,exp_year:_0x222926,cvv:_0x291a32,holder_name:_0x5dc77c,customer_email:_0x5dbeb6,customer_birth_date:_0x28e69f,billing_country:_0x11d7a3,customer_phone:_0x10e5a8,billing_address:_0x3e0f95,billing_city:_0x21387e,billing_state:_0xad3565,billing_zip:_0x475df8}=_0x1b5139[_0xcfecc5(0x185)];console[_0xcfecc5(0x1eb)](_0xcfecc5(0x1e6)+_0x270302);if(!_0x4440d4||!_0x125188||!_0x222926||!_0x291a32||!_0x5dc77c||!_0x5dbeb6)return _0x266e70[_0xcfecc5(0x1f9)](0x190)[_0xcfecc5(0x1c9)]({'success':![],'message':_0xcfecc5(0x17c)});if(_0x11d7a3&&!isValidCountryCode(_0x11d7a3))return _0x266e70[_0xcfecc5(0x1f9)](0x190)[_0xcfecc5(0x1c9)]({'success':![],'message':_0xcfecc5(0x1e2)});const _0x35b993=await database_1[_0xcfecc5(0x1e1)][_0xcfecc5(0x181)][_0xcfecc5(0x184)]({'where':{'id':_0x270302},'include':{'shop':!![]}});if(!_0x35b993)return _0x266e70['status'](0x194)[_0xcfecc5(0x1c9)]({'success':![],'message':_0xcfecc5(0x1e3)});if(_0x35b993[_0xcfecc5(0x1f9)]!=='PENDING')return _0x266e70['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20in\x20pending\x20status'});const _0xb8f8b=(0x0,ipHelper_1[_0xcfecc5(0x1f1)])(_0x1b5139),_0x551dfa={'number':_0x4440d4[_0xcfecc5(0x197)](/\s/g,''),'exp_month':_0x125188['toString']()[_0xcfecc5(0x1b8)](0x2,'0'),'exp_year':_0x222926[_0xcfecc5(0x1a0)](),'verification_value':_0x291a32,'holder':_0x5dc77c[_0xcfecc5(0x1f3)]()},_0x5ddf3b={'ip':_0xb8f8b,'email':_0x5dbeb6};_0x28e69f&&(_0x5ddf3b['birth_date']=_0x28e69f);let _0xd7121a;_0x11d7a3&&(_0xd7121a={'country':_0x11d7a3,'address':_0x3e0f95,'city':_0x21387e,'state':_0xad3565,'zip':_0x475df8});const _0x30eab1=(process['env'][_0xcfecc5(0x19d)]||_0xcfecc5(0x1b0))+_0xcfecc5(0x1fa)+_0x270302+_0xcfecc5(0x1ef)+(_0x35b993[_0xcfecc5(0x1b4)]||_0x270302),_0x3fb687=(process[_0xcfecc5(0x198)][_0xcfecc5(0x17d)]||_0xcfecc5(0x1aa))+'/api/webhooks/squirrel-pay',_0x31fec6=_0x270302[_0xcfecc5(0x1bf)](0x0,0x8)+'-'+_0x270302[_0xcfecc5(0x1bf)](0x8,0x10);console[_0xcfecc5(0x1eb)]('üìù\x20SquirrelPay\x20payment\x20details:'),console[_0xcfecc5(0x1eb)]('\x20\x20\x20Payment\x20ID:\x20'+_0x270302),console['log'](_0xcfecc5(0x1a9)+_0x35b993['amount']+'\x20'+_0x35b993[_0xcfecc5(0x1db)]),console[_0xcfecc5(0x1eb)](_0xcfecc5(0x1ad)+_0x5dbeb6+'\x20('+_0xb8f8b+')'),console[_0xcfecc5(0x1eb)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x11d7a3||_0xcfecc5(0x1a5))),console[_0xcfecc5(0x1eb)](_0xcfecc5(0x1ea)+_0x31fec6);const _0x587110=await this['squirrelPayService'][_0xcfecc5(0x1ca)](Math[_0xcfecc5(0x1c4)](_0x35b993[_0xcfecc5(0x1b3)]*0x64),_0x35b993[_0xcfecc5(0x1db)],_0x31fec6,_0x30eab1,_0x3fb687,_0x551dfa,_0x5ddf3b,_0xd7121a,_0x10e5a8),_0x4e7acb=this[_0xcfecc5(0x1a6)][_0xcfecc5(0x192)](_0x587110),_0x57594b={'gatewayPaymentId':_0x587110['uid'],'cardLast4':_0x4e7acb[_0xcfecc5(0x1bb)],'gateway':_0xcfecc5(0x1d3),'customerEmail':_0x5dbeb6,'customerPhone':_0x10e5a8,'customerBirthDate':_0x28e69f,'billingAddress':_0x3e0f95,'billingCity':_0x21387e,'billingState':_0xad3565,'billingZip':_0x475df8,'customerCountry':_0x11d7a3};if(_0x4e7acb[_0xcfecc5(0x1f9)]==='PAID'){_0x57594b['status']='PAID',_0x57594b[_0xcfecc5(0x18e)]=new Date();try{const _0x53d566=await this[_0xcfecc5(0x196)][_0xcfecc5(0x19f)](_0x35b993[_0xcfecc5(0x1b3)],_0x35b993[_0xcfecc5(0x1db)]);_0x57594b[_0xcfecc5(0x1de)]=_0x53d566,console[_0xcfecc5(0x1eb)]('üí∞\x20Calculated\x20amountUSDT:\x20'+_0x53d566+_0xcfecc5(0x1b6));const _0x562568=await this[_0xcfecc5(0x1f0)][_0xcfecc5(0x1da)](_0x35b993[_0xcfecc5(0x1ee)],_0x35b993[_0xcfecc5(0x1ba)]),_0xd0e53e=_0x53d566*(0x1-_0x562568/0x64);_0x57594b[_0xcfecc5(0x186)]=_0xd0e53e,_0x57594b['gatewayCommissionRate']=_0x562568,console[_0xcfecc5(0x1eb)](_0xcfecc5(0x188)+_0x35b993[_0xcfecc5(0x1ba)]+_0xcfecc5(0x180)+_0x562568+'%'),console['log'](_0xcfecc5(0x1bc)+_0xd0e53e['toFixed'](0x6)+_0xcfecc5(0x1b6));}catch(_0xd9a19){console[_0xcfecc5(0x18c)]('‚ùå\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0xd9a19),_0x57594b[_0xcfecc5(0x1de)]=0x0,_0x57594b[_0xcfecc5(0x186)]=0x0,_0x57594b[_0xcfecc5(0x1d7)]=0x0;}}else _0x4e7acb['status']===_0xcfecc5(0x1f2)&&(_0x57594b['status']=_0xcfecc5(0x1f2),_0x57594b[_0xcfecc5(0x1c7)]=_0x4e7acb[_0xcfecc5(0x1c7)]);const _0x3ebaaa=await database_1[_0xcfecc5(0x1e1)][_0xcfecc5(0x181)][_0xcfecc5(0x1a3)]({'where':{'id':_0x270302},'data':_0x57594b});console[_0xcfecc5(0x1eb)](_0xcfecc5(0x1c8)+_0x3ebaaa[_0xcfecc5(0x1f9)]);let _0x4a0b00;if(_0x4e7acb['status']==='FAILED')_0x4a0b00=_0x4e7acb[_0xcfecc5(0x1c7)]||_0x587110[_0xcfecc5(0x1dc)]||_0xcfecc5(0x1cf);else _0x4e7acb[_0xcfecc5(0x1f9)]===_0xcfecc5(0x1df)?_0x4a0b00=_0x587110['friendly_message']||_0xcfecc5(0x1a2):_0x4a0b00=_0x587110[_0xcfecc5(0x1dc)]||'Payment\x20processed\x20successfully';const _0x32969d={'success':_0x4e7acb[_0xcfecc5(0x1f9)]!==_0xcfecc5(0x1f2),'status':_0x4e7acb[_0xcfecc5(0x1f9)],'message':_0x4a0b00,'payment':{'id':_0x270302,'status':_0x3ebaaa[_0xcfecc5(0x1f9)],'gateway':'squirrelpay','last4':_0x4e7acb['cardLast4']}};_0x4e7acb[_0xcfecc5(0x1be)]&&(_0x32969d[_0xcfecc5(0x191)]=_0x4e7acb['redirectUrl'],_0x32969d[_0xcfecc5(0x1d6)]=!![],console[_0xcfecc5(0x1eb)](_0xcfecc5(0x1d1)+_0x4e7acb[_0xcfecc5(0x1be)])),_0x266e70[_0xcfecc5(0x1c9)](_0x32969d);}catch(_0x52d85c){console[_0xcfecc5(0x18c)](_0xcfecc5(0x187),_0x52d85c),_0x458ed9(_0x52d85c);}},this[_0x212ee6(0x1d8)]=async(_0x4f2ec7,_0x38050d,_0x4fe7d9)=>{const _0x4221f9=_0x212ee6;try{console[_0x4221f9(0x1eb)]('üêøÔ∏è\x20SquirrelPay\x20webhook\x20received'),console[_0x4221f9(0x1eb)](_0x4221f9(0x1ab),_0x4f2ec7['headers']),console[_0x4221f9(0x1eb)](_0x4221f9(0x189),_0x4f2ec7[_0x4221f9(0x185)]),this[_0x4221f9(0x1a6)][_0x4221f9(0x17e)]({'headers':_0x4f2ec7[_0x4221f9(0x1d5)],'body':_0x4f2ec7[_0x4221f9(0x185)],'timestamp':new Date()[_0x4221f9(0x18b)]()});const _0x47f157=_0x4f2ec7[_0x4221f9(0x185)];if(!_0x47f157[_0x4221f9(0x1e8)]||!_0x47f157[_0x4221f9(0x1f9)])return console[_0x4221f9(0x1ed)]('‚ö†Ô∏è\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields'),_0x38050d[_0x4221f9(0x1f9)](0x190)[_0x4221f9(0x1c9)]({'success':![],'message':_0x4221f9(0x190)});let _0x61cb27;_0x47f157['uid']&&(_0x61cb27=await database_1['default']['payment'][_0x4221f9(0x1e0)]({'where':{'gatewayPaymentId':_0x47f157[_0x4221f9(0x1e8)],'gateway':_0x4221f9(0x1d3)}}));if(!_0x61cb27)return console[_0x4221f9(0x1ed)](_0x4221f9(0x1ce)),console['warn'](_0x4221f9(0x1f4)+_0x47f157[_0x4221f9(0x1e8)]),console['warn']('\x20\x20\x20Description:\x20'+_0x47f157['description']),console['warn']('\x20\x20\x20Gateway:\x20squirrelpay'),console[_0x4221f9(0x1ed)](_0x4221f9(0x1c5)+_0x47f157[_0x4221f9(0x1e8)]),_0x38050d[_0x4221f9(0x1f9)](0x194)[_0x4221f9(0x1c9)]({'success':![],'message':_0x4221f9(0x1e3)});console[_0x4221f9(0x1eb)](_0x4221f9(0x1e5)+_0x61cb27['id']),console[_0x4221f9(0x1eb)](_0x4221f9(0x19b)+_0x61cb27[_0x4221f9(0x1f9)]),console[_0x4221f9(0x1eb)](_0x4221f9(0x1ae)+_0x61cb27[_0x4221f9(0x1cb)]),console[_0x4221f9(0x1eb)](_0x4221f9(0x1a4)+_0x47f157[_0x4221f9(0x1f9)]),console[_0x4221f9(0x1eb)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x47f157[_0x4221f9(0x1e8)]);let _0xbffdb0=null;const _0x41fde2={};_0x47f157[_0x4221f9(0x1e9)]?.[_0x4221f9(0x199)]&&(_0x41fde2[_0x4221f9(0x1a1)]=_0x47f157[_0x4221f9(0x1e9)][_0x4221f9(0x199)],console[_0x4221f9(0x1eb)]('üí≥\x20Card\x20brand\x20detected:\x20'+_0x47f157[_0x4221f9(0x1e9)][_0x4221f9(0x199)]));_0x47f157['payment_method']?.[_0x4221f9(0x1cd)]&&(_0x41fde2[_0x4221f9(0x1bb)]=_0x47f157[_0x4221f9(0x1e9)][_0x4221f9(0x1cd)],console['log']('üí≥\x20Card\x20last\x204:\x20'+_0x47f157[_0x4221f9(0x1e9)][_0x4221f9(0x1cd)]));switch(_0x47f157['status']){case'successful':_0xbffdb0=_0x4221f9(0x1b5),console[_0x4221f9(0x1eb)]('‚úÖ\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x4221f9(0x1bd):_0xbffdb0=_0x4221f9(0x1f2),_0x41fde2['failureMessage']=_0x47f157[_0x4221f9(0x1dc)]||_0x47f157['message']||_0x4221f9(0x1cf),console[_0x4221f9(0x1eb)](_0x4221f9(0x1cc)+_0x41fde2[_0x4221f9(0x1c7)]);break;case _0x4221f9(0x1ac):console['log'](_0x4221f9(0x182));break;default:console[_0x4221f9(0x1ed)]('‚ö†Ô∏è\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x47f157[_0x4221f9(0x1f9)]);break;}if(_0xbffdb0&&_0xbffdb0!==_0x61cb27['status'])console[_0x4221f9(0x1eb)]('üîÑ\x20Updating\x20payment\x20status\x20from\x20'+_0x61cb27['status']+'\x20to\x20'+_0xbffdb0),await this[_0x4221f9(0x1f0)][_0x4221f9(0x1b9)](_0x61cb27['id'],_0xbffdb0,_0x41fde2),console['log'](_0x4221f9(0x1e4)+_0x61cb27['id']+_0x4221f9(0x18a)+_0xbffdb0+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0xbffdb0&&console[_0x4221f9(0x1eb)]('‚ÑπÔ∏è\x20Payment\x20'+_0x61cb27['id']+_0x4221f9(0x1c1)+_0xbffdb0+_0x4221f9(0x1d9));_0x38050d[_0x4221f9(0x1f9)](0xc8)['json']({'success':!![],'message':_0x4221f9(0x19a)});}catch(_0x2ad1e2){console[_0x4221f9(0x18c)]('‚ùå\x20SquirrelPay\x20webhook\x20error:',_0x2ad1e2),_0x4fe7d9(_0x2ad1e2);}},this[_0x212ee6(0x1c6)]=async(_0x514e2b,_0x48c536,_0x171222)=>{const _0xcb89b=_0x212ee6;try{const {limit:_0xdd3538}=_0x514e2b[_0xcb89b(0x193)],_0x88b940=this[_0xcb89b(0x1a6)][_0xcb89b(0x1c6)](_0xdd3538?parseInt(_0xdd3538):0x32);_0x48c536[_0xcb89b(0x1c9)]({'success':!![],'result':{'logs':_0x88b940,'count':_0x88b940[_0xcb89b(0x1f8)]}});}catch(_0x5fc6e8){_0x171222(_0x5fc6e8);}},this[_0x212ee6(0x1a6)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0x212ee6(0x198)]['SQUIRREL_PAY_SHOP_ID']||'','secretKey':process[_0x212ee6(0x198)][_0x212ee6(0x1a8)]||'','baseUrl':process[_0x212ee6(0x198)][_0x212ee6(0x19e)]||_0x212ee6(0x1af),'isTestMode':process['env']['SQUIRREL_PAY_TEST_MODE']===_0x212ee6(0x1f5)}),this[_0x212ee6(0x196)]=new currencyService_1[(_0x212ee6(0x18d))](),this['webhookService']=new webhookService_1[(_0x212ee6(0x1b1))]();}}function a17_0x28fa(){const _0x3ee76f=['Payment\x20not\x20found','‚úÖ\x20Payment\x20','üîç\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','üêøÔ∏è\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','1228550rkUVDR','uid','payment_method','\x20\x20\x20Description:\x20','log','params','warn','shopId','&payment_id=','webhookService','getClientIP','FAILED','toUpperCase','\x20\x20\x20UID:\x20','true','141VdlKMp','9YDMNXY','length','status','/payment/pending?id=','Missing\x20required\x20card\x20or\x20customer\x20information','API_BASE_URL','logWebhook','25924hDdpOe','\x20commission:\x20','payment','‚è≥\x20Payment\x20remains\x20PENDING\x20(incomplete)','310470WbYwPs','findUnique','body','amountAfterGatewayCommissionUSDT','‚ùå\x20SquirrelPay\x20card\x20payment\x20error:','üí∞\x20Gateway\x20','Body:','\x20updated:\x20status=','toISOString','error','CurrencyService','paidAt','11SdHwzB','Missing\x20required\x20fields\x20in\x20webhook','redirect_url','getPaymentStatus','query','48693DsTmIm','../services/currencyService','currencyService','replace','env','brand','Webhook\x20processed\x20successfully','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','SquirrelPayController','FRONTEND_URL','SQUIRREL_PAY_BASE_URL','convertToUSDT','toString','cardBrand','Payment\x20is\x20being\x20processed','update','\x20\x20\x20Webhook\x20status:\x20','not\x20provided','squirrelPayService','8nthtXB','SQUIRREL_PAY_SECRET_KEY','\x20\x20\x20Amount:\x20','https://api.trapay.uk','Headers:','incomplete','\x20\x20\x20Customer:\x20','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','https://gate.squirrel-pay.com','https://app.trapay.uk','WebhookService','4546068XAUhUf','amount','gatewayOrderId','PAID','\x20USDT','../services/gateways/squirrelPayService','padStart','updatePaymentStatus','gateway','cardLast4','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','failed','redirectUrl','slice','defineProperty','\x20already\x20has\x20status\x20','../utils/ipHelper','1611330Dfmurk','round','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','getWebhookLogs','failureMessage','‚úÖ\x20SquirrelPay\x20payment\x20updated:\x20','json','processCardPayment','gatewayPaymentId','‚ùå\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','last_4','‚ö†Ô∏è\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','Payment\x20failed','6yXfmlh','üîÑ\x203D\x20Secure\x20redirect\x20required:\x20','../config/database','squirrelpay','1233655iUJezy','headers','requires_action','gatewayCommissionRate','handleWebhook',',\x20skipping\x20update','getGatewayCommission','currency','friendly_message','__esModule','amountUSDT','PENDING','findFirst','default','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'];a17_0x28fa=function(){return _0x3ee76f;};return a17_0x28fa();}exports[a17_0x4c3f04(0x19c)]=SquirrelPayController;