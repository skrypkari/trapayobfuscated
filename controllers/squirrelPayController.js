'use strict';const a16_0x3b43df=a16_0x5f45;(function(_0x487153,_0x3eba00){const _0x2999bf=a16_0x5f45,_0x246c41=_0x487153();while(!![]){try{const _0x39c229=-parseInt(_0x2999bf(0xfa))/0x1*(parseInt(_0x2999bf(0x126))/0x2)+-parseInt(_0x2999bf(0x10c))/0x3*(parseInt(_0x2999bf(0x121))/0x4)+-parseInt(_0x2999bf(0x168))/0x5+parseInt(_0x2999bf(0x124))/0x6+parseInt(_0x2999bf(0xf8))/0x7+parseInt(_0x2999bf(0x106))/0x8*(parseInt(_0x2999bf(0x15b))/0x9)+parseInt(_0x2999bf(0x134))/0xa;if(_0x39c229===_0x3eba00)break;else _0x246c41['push'](_0x246c41['shift']());}catch(_0x56e2e6){_0x246c41['push'](_0x246c41['shift']());}}}(a16_0x3620,0x42919));var __importDefault=this&&this['__importDefault']||function(_0x85860c){const _0x57c68e=a16_0x5f45;return _0x85860c&&_0x85860c[_0x57c68e(0x150)]?_0x85860c:{'default':_0x85860c};};Object[a16_0x3b43df(0x109)](exports,'__esModule',{'value':!![]}),exports['SquirrelPayController']=void 0x0;function a16_0x3620(){const _0x13f948=['ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','CurrencyService','../services/gateways/squirrelPayService','log','\x20\x20\x20Billing\x20Country:\x20','gatewayCommissionRate','\x20\x20\x20Webhook\x20status:\x20','3984300McKhvZ','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','&payment_id=','toFixed','updatePaymentStatus','amount','convertToUSDT','body','/payment/pending?id=','squirrelPayService','toString','round','redirectUrl','FAILED','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','/api/webhooks/squirrel-pay','âœ…\x20Payment\x20','true','Missing\x20required\x20card\x20or\x20customer\x20information','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','\x20\x20\x20Webhook\x20UID:\x20','https://app.trapay.uk','uid','Payment\x20failed','amountUSDT','Payment\x20processed\x20successfully','https://gate.squirrel-pay.com','\x20\x20\x20Payment\x20ID:\x20','__esModule','\x20USDT','headers','cardLast4','shopId','âŒ\x20SquirrelPay\x20webhook\x20error:','params','currencyService','Payment\x20is\x20being\x20processed','SQUIRREL_PAY_BASE_URL','status','90jmheei','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','toISOString','toUpperCase','SQUIRREL_PAY_SECRET_KEY','currency','\x20\x20\x20Gateway:\x20squirrelpay','message','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','\x20\x20\x20Description:\x20','getGatewayCommission','friendly_message','../services/webhookService','300830zmRWCE','json','SquirrelPayController','findFirst','amountAfterGatewayCommissionUSDT','\x20to\x20','../utils/ipHelper','handleWebhook','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','ðŸ’°\x20Gateway\x20','245091GoIBYc','redirect_url','27253vgzMGd','gatewayOrderId','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','incomplete','PENDING','padStart','SQUIRREL_PAY_TEST_MODE','PAID','WebhookService','Payment\x20is\x20not\x20in\x20pending\x20status','getPaymentStatus','env','235896mrzuud','default','Webhook\x20processed\x20successfully','defineProperty','getWebhookLogs','description','1501956JZNNcM','payment','squirrelpay','\x20updated:\x20status=','findUnique','failureMessage','error','webhookService','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','slice','\x20\x20\x20Current\x20status\x20in\x20DB:\x20','\x20\x20\x20UID:\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','SQUIRREL_PAY_SHOP_ID','warn','https://api.trapay.uk','paidAt','ðŸ’°\x20Calculated\x20amountUSDT:\x20','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','not\x20provided',',\x20skipping\x20update','4gfgJbF','Payment\x20not\x20found','FRONTEND_URL','794538JdZirG','gateway','2bBkrNX','../services/currencyService','ðŸ“\x20SquirrelPay\x20payment\x20details:','\x20commission:\x20','query','length','update'];a16_0x3620=function(){return _0x13f948;};return a16_0x3620();}const squirrelPayService_1=require(a16_0x3b43df(0x12f)),currencyService_1=require(a16_0x3b43df(0x127)),webhookService_1=require(a16_0x3b43df(0x167)),database_1=__importDefault(require('../config/database')),ipHelper_1=require(a16_0x3b43df(0x16e)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a16_0x5f45(_0x30cd1f,_0x3a1b05){_0x30cd1f=_0x30cd1f-0xf7;const _0x3620a3=a16_0x3620();let _0x5f4504=_0x3620a3[_0x30cd1f];return _0x5f4504;}function isValidCountryCode(_0x2471b9){const _0x13ded3=a16_0x3b43df;return ISO_COUNTRY_CODES['has'](_0x2471b9[_0x13ded3(0x15e)]());}class SquirrelPayController{constructor(){const _0x13e89b=a16_0x3b43df;this['processCardPayment']=async(_0xe25a1c,_0x1a0872,_0x14e344)=>{const _0x3ad494=a16_0x5f45;try{const {paymentId:_0x41d14e}=_0xe25a1c[_0x3ad494(0x156)],{card_number:_0xa4826e,exp_month:_0x27d705,exp_year:_0xe8db5f,cvv:_0x4e4448,holder_name:_0x15703c,customer_email:_0x4cb517,customer_birth_date:_0x52e0f4,billing_country:_0x409396,customer_phone:_0x4cb798,billing_address:_0x45f953,billing_city:_0x5d4f21,billing_state:_0x1676e0,billing_zip:_0x48db39}=_0xe25a1c[_0x3ad494(0x13b)];console[_0x3ad494(0x130)](_0x3ad494(0x12d)+_0x41d14e);if(!_0xa4826e||!_0x27d705||!_0xe8db5f||!_0x4e4448||!_0x15703c||!_0x4cb517)return _0x1a0872['status'](0x190)[_0x3ad494(0x169)]({'success':![],'message':_0x3ad494(0x146)});if(_0x409396&&!isValidCountryCode(_0x409396))return _0x1a0872[_0x3ad494(0x15a)](0x190)[_0x3ad494(0x169)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x3c20f7=await database_1[_0x3ad494(0x107)][_0x3ad494(0x10d)][_0x3ad494(0x110)]({'where':{'id':_0x41d14e},'include':{'shop':!![]}});if(!_0x3c20f7)return _0x1a0872[_0x3ad494(0x15a)](0x194)[_0x3ad494(0x169)]({'success':![],'message':_0x3ad494(0x122)});if(_0x3c20f7[_0x3ad494(0x15a)]!==_0x3ad494(0xfe))return _0x1a0872[_0x3ad494(0x15a)](0x190)[_0x3ad494(0x169)]({'success':![],'message':_0x3ad494(0x103)});const _0xa89ee5=(0x0,ipHelper_1['getClientIP'])(_0xe25a1c),_0xfb98e5={'number':_0xa4826e['replace'](/\s/g,''),'exp_month':_0x27d705[_0x3ad494(0x13e)]()[_0x3ad494(0xff)](0x2,'0'),'exp_year':_0xe8db5f['toString'](),'verification_value':_0x4e4448,'holder':_0x15703c[_0x3ad494(0x15e)]()},_0x2a54e7={'ip':_0xa89ee5,'email':_0x4cb517};_0x52e0f4&&(_0x2a54e7['birth_date']=_0x52e0f4);let _0x8c8a5b;_0x409396&&(_0x8c8a5b={'country':_0x409396,'address':_0x45f953,'city':_0x5d4f21,'state':_0x1676e0,'zip':_0x48db39});const _0x3b648c=(process[_0x3ad494(0x105)][_0x3ad494(0x123)]||_0x3ad494(0x149))+_0x3ad494(0x13c)+_0x41d14e+_0x3ad494(0x136)+(_0x3c20f7[_0x3ad494(0xfb)]||_0x41d14e),_0x33cd43=(process[_0x3ad494(0x105)]['API_BASE_URL']||_0x3ad494(0x11b))+_0x3ad494(0x143),_0x8473a5=_0x41d14e[_0x3ad494(0x115)](0x0,0x8)+'-'+_0x41d14e[_0x3ad494(0x115)](0x8,0x10);console[_0x3ad494(0x130)](_0x3ad494(0x128)),console[_0x3ad494(0x130)](_0x3ad494(0x14f)+_0x41d14e),console[_0x3ad494(0x130)]('\x20\x20\x20Amount:\x20'+_0x3c20f7['amount']+'\x20'+_0x3c20f7[_0x3ad494(0x160)]),console[_0x3ad494(0x130)]('\x20\x20\x20Customer:\x20'+_0x4cb517+'\x20('+_0xa89ee5+')'),console[_0x3ad494(0x130)](_0x3ad494(0x131)+(_0x409396||_0x3ad494(0x11f))),console['log'](_0x3ad494(0x164)+_0x8473a5);const _0x5f44b3=await this[_0x3ad494(0x13d)]['processCardPayment'](Math[_0x3ad494(0x13f)](_0x3c20f7[_0x3ad494(0x139)]*0x64),_0x3c20f7['currency'],_0x8473a5,_0x3b648c,_0x33cd43,_0xfb98e5,_0x2a54e7,_0x8c8a5b,_0x4cb798),_0x31c2e4=this['squirrelPayService'][_0x3ad494(0x104)](_0x5f44b3),_0x9d59cc={'gatewayPaymentId':_0x5f44b3[_0x3ad494(0x14a)],'cardLast4':_0x31c2e4[_0x3ad494(0x153)],'gateway':'squirrelpay','customerEmail':_0x4cb517,'customerPhone':_0x4cb798,'customerBirthDate':_0x52e0f4,'billingAddress':_0x45f953,'billingCity':_0x5d4f21,'billingState':_0x1676e0,'billingZip':_0x48db39,'customerCountry':_0x409396};if(_0x31c2e4[_0x3ad494(0x15a)]===_0x3ad494(0x101)){_0x9d59cc[_0x3ad494(0x15a)]=_0x3ad494(0x101),_0x9d59cc[_0x3ad494(0x11c)]=new Date();try{const _0x580487=await this[_0x3ad494(0x157)][_0x3ad494(0x13a)](_0x3c20f7[_0x3ad494(0x139)],_0x3c20f7[_0x3ad494(0x160)]);_0x9d59cc[_0x3ad494(0x14c)]=_0x580487,console[_0x3ad494(0x130)](_0x3ad494(0x11d)+_0x580487+_0x3ad494(0x151));const _0x4866b8=await this[_0x3ad494(0x113)][_0x3ad494(0x165)](_0x3c20f7[_0x3ad494(0x154)],_0x3c20f7[_0x3ad494(0x125)]),_0x51be15=_0x580487*(0x1-_0x4866b8/0x64);_0x9d59cc[_0x3ad494(0x16c)]=_0x51be15,_0x9d59cc[_0x3ad494(0x132)]=_0x4866b8,console[_0x3ad494(0x130)](_0x3ad494(0xf7)+_0x3c20f7['gateway']+_0x3ad494(0x129)+_0x4866b8+'%'),console[_0x3ad494(0x130)](_0x3ad494(0x11e)+_0x51be15[_0x3ad494(0x137)](0x6)+_0x3ad494(0x151));}catch(_0x1f9ddc){console[_0x3ad494(0x112)]('âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x1f9ddc),_0x9d59cc[_0x3ad494(0x14c)]=0x0,_0x9d59cc[_0x3ad494(0x16c)]=0x0,_0x9d59cc[_0x3ad494(0x132)]=0x0;}}else _0x31c2e4['status']==='FAILED'&&(_0x9d59cc[_0x3ad494(0x15a)]=_0x3ad494(0x141),_0x9d59cc[_0x3ad494(0x111)]=_0x31c2e4[_0x3ad494(0x111)]);const _0x312579=await database_1[_0x3ad494(0x107)][_0x3ad494(0x10d)][_0x3ad494(0x12c)]({'where':{'id':_0x41d14e},'data':_0x9d59cc});console[_0x3ad494(0x130)](_0x3ad494(0x147)+_0x312579[_0x3ad494(0x15a)]);let _0x47e420;if(_0x31c2e4[_0x3ad494(0x15a)]===_0x3ad494(0x141))_0x47e420=_0x31c2e4[_0x3ad494(0x111)]||_0x5f44b3[_0x3ad494(0x166)]||'Payment\x20failed';else _0x31c2e4[_0x3ad494(0x15a)]===_0x3ad494(0xfe)?_0x47e420=_0x5f44b3[_0x3ad494(0x166)]||_0x3ad494(0x158):_0x47e420=_0x5f44b3[_0x3ad494(0x166)]||_0x3ad494(0x14d);const _0x512b92={'success':_0x31c2e4[_0x3ad494(0x15a)]!==_0x3ad494(0x141),'status':_0x31c2e4[_0x3ad494(0x15a)],'message':_0x47e420,'payment':{'id':_0x41d14e,'status':_0x312579[_0x3ad494(0x15a)],'gateway':_0x3ad494(0x10e),'last4':_0x31c2e4['cardLast4']}};_0x31c2e4[_0x3ad494(0x140)]&&(_0x512b92[_0x3ad494(0xf9)]=_0x31c2e4[_0x3ad494(0x140)],_0x512b92['requires_action']=!![],console[_0x3ad494(0x130)]('ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20'+_0x31c2e4['redirectUrl'])),_0x1a0872[_0x3ad494(0x169)](_0x512b92);}catch(_0x4c740e){console['error'](_0x3ad494(0x114),_0x4c740e),_0x14e344(_0x4c740e);}},this[_0x13e89b(0x16f)]=async(_0x46b9d5,_0x2fb989,_0x3eaf9e)=>{const _0x571143=_0x13e89b;try{console['log'](_0x571143(0x142)),console[_0x571143(0x130)]('Headers:',_0x46b9d5[_0x571143(0x152)]),console['log']('Body:',_0x46b9d5[_0x571143(0x13b)]),this['squirrelPayService']['logWebhook']({'headers':_0x46b9d5[_0x571143(0x152)],'body':_0x46b9d5[_0x571143(0x13b)],'timestamp':new Date()[_0x571143(0x15d)]()});const _0x966904=_0x46b9d5[_0x571143(0x13b)];if(!_0x966904[_0x571143(0x14a)]||!_0x966904[_0x571143(0x15a)])return console[_0x571143(0x11a)](_0x571143(0x135)),_0x2fb989[_0x571143(0x15a)](0x190)[_0x571143(0x169)]({'success':![],'message':'Missing\x20required\x20fields\x20in\x20webhook'});let _0x275a7c;_0x966904[_0x571143(0x14a)]&&(_0x275a7c=await database_1[_0x571143(0x107)][_0x571143(0x10d)][_0x571143(0x16b)]({'where':{'gatewayPaymentId':_0x966904[_0x571143(0x14a)],'gateway':_0x571143(0x10e)}}));if(!_0x275a7c)return console['warn'](_0x571143(0x15c)),console[_0x571143(0x11a)](_0x571143(0x117)+_0x966904[_0x571143(0x14a)]),console[_0x571143(0x11a)](_0x571143(0x164)+_0x966904[_0x571143(0x10b)]),console[_0x571143(0x11a)](_0x571143(0x161)),console[_0x571143(0x11a)]('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x966904[_0x571143(0x14a)]),_0x2fb989['status'](0x194)['json']({'success':![],'message':_0x571143(0x122)});console[_0x571143(0x130)](_0x571143(0x170)+_0x275a7c['id']),console[_0x571143(0x130)](_0x571143(0x116)+_0x275a7c[_0x571143(0x15a)]),console[_0x571143(0x130)]('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x275a7c['gatewayPaymentId']),console[_0x571143(0x130)](_0x571143(0x133)+_0x966904[_0x571143(0x15a)]),console[_0x571143(0x130)](_0x571143(0x148)+_0x966904[_0x571143(0x14a)]);let _0x5eb017=null;const _0x5677cb={};switch(_0x966904[_0x571143(0x15a)]){case'successful':_0x5eb017=_0x571143(0x101),console[_0x571143(0x130)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case'failed':_0x5eb017='FAILED',_0x5677cb[_0x571143(0x111)]=_0x966904[_0x571143(0x166)]||_0x966904[_0x571143(0x162)]||_0x571143(0x14b),console[_0x571143(0x130)]('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x5677cb[_0x571143(0x111)]);break;case _0x571143(0xfd):console['log'](_0x571143(0x118));break;default:console[_0x571143(0x11a)](_0x571143(0xfc)+_0x966904[_0x571143(0x15a)]);break;}if(_0x5eb017&&_0x5eb017!==_0x275a7c[_0x571143(0x15a)])console[_0x571143(0x130)](_0x571143(0x163)+_0x275a7c[_0x571143(0x15a)]+_0x571143(0x16d)+_0x5eb017),await this[_0x571143(0x113)][_0x571143(0x138)](_0x275a7c['id'],_0x5eb017,_0x5677cb),console['log'](_0x571143(0x144)+_0x275a7c['id']+_0x571143(0x10f)+_0x5eb017+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x5eb017&&console['log']('â„¹ï¸\x20Payment\x20'+_0x275a7c['id']+'\x20already\x20has\x20status\x20'+_0x5eb017+_0x571143(0x120));_0x2fb989[_0x571143(0x15a)](0xc8)[_0x571143(0x169)]({'success':!![],'message':_0x571143(0x108)});}catch(_0x485258){console[_0x571143(0x112)](_0x571143(0x155),_0x485258),_0x3eaf9e(_0x485258);}},this[_0x13e89b(0x10a)]=async(_0x3d4689,_0x23da7f,_0xccc57b)=>{const _0xcde1b2=_0x13e89b;try{const {limit:_0x1f041c}=_0x3d4689[_0xcde1b2(0x12a)],_0x1577b9=this[_0xcde1b2(0x13d)][_0xcde1b2(0x10a)](_0x1f041c?parseInt(_0x1f041c):0x32);_0x23da7f[_0xcde1b2(0x169)]({'success':!![],'result':{'logs':_0x1577b9,'count':_0x1577b9[_0xcde1b2(0x12b)]}});}catch(_0x1dbcf3){_0xccc57b(_0x1dbcf3);}},this[_0x13e89b(0x13d)]=new squirrelPayService_1['SquirrelPayService']({'shopId':process[_0x13e89b(0x105)][_0x13e89b(0x119)]||'','secretKey':process[_0x13e89b(0x105)][_0x13e89b(0x15f)]||'','baseUrl':process[_0x13e89b(0x105)][_0x13e89b(0x159)]||_0x13e89b(0x14e),'isTestMode':process[_0x13e89b(0x105)][_0x13e89b(0x100)]===_0x13e89b(0x145)}),this['currencyService']=new currencyService_1[(_0x13e89b(0x12e))](),this[_0x13e89b(0x113)]=new webhookService_1[(_0x13e89b(0x102))]();}}exports[a16_0x3b43df(0x16a)]=SquirrelPayController;