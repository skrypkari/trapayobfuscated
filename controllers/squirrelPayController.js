'use strict';function a18_0x422a(_0x18e5cb,_0x3dee7b){_0x18e5cb=_0x18e5cb-0x1ba;const _0x1ab131=a18_0x1ab1();let _0x422a10=_0x1ab131[_0x18e5cb];return _0x422a10;}const a18_0x32ca22=a18_0x422a;(function(_0x3307d2,_0x3b983e){const _0x1ae484=a18_0x422a,_0x3b67d9=_0x3307d2();while(!![]){try{const _0x347e3a=-parseInt(_0x1ae484(0x208))/0x1+parseInt(_0x1ae484(0x203))/0x2+parseInt(_0x1ae484(0x1eb))/0x3*(-parseInt(_0x1ae484(0x231))/0x4)+-parseInt(_0x1ae484(0x230))/0x5*(parseInt(_0x1ae484(0x21d))/0x6)+parseInt(_0x1ae484(0x1fd))/0x7+-parseInt(_0x1ae484(0x1f7))/0x8+parseInt(_0x1ae484(0x1dc))/0x9;if(_0x347e3a===_0x3b983e)break;else _0x3b67d9['push'](_0x3b67d9['shift']());}catch(_0x2996b1){_0x3b67d9['push'](_0x3b67d9['shift']());}}}(a18_0x1ab1,0x8249b));var __importDefault=this&&this[a18_0x32ca22(0x1c1)]||function(_0xdee551){const _0x3a1600=a18_0x32ca22;return _0xdee551&&_0xdee551[_0x3a1600(0x233)]?_0xdee551:{'default':_0xdee551};};function a18_0x1ab1(){const _0x53d485=['length','requires_action','processCardPayment','toString','toISOString','params','Payment\x20is\x20not\x20in\x20pending\x20status','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20','json',',\x20balance\x20updated,\x20amountUSDT\x20calculated','https://app.trapay.uk','âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20','description','Body:','../services/currencyService','896655GEmblh','2405944ynJJiu','padStart','__esModule','SquirrelPayService','SquirrelPayController','cardLast4','../utils/ipHelper','webhookService','gateway','toUpperCase','âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','last_4','__importDefault','amount','findFirst','\x20updated:\x20status=','getGatewayCommission','failureMessage','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','updatePaymentStatus','birth_date','payment','warn','PENDING','../config/database','findUnique','has','â„¹ï¸\x20Payment\x20','uid','status','incomplete','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','Missing\x20required\x20fields\x20in\x20webhook','log','../services/gateways/squirrelPayService','headers','ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','Payment\x20processed\x20successfully','redirect_url','24689862UjbDSv','Payment\x20failed','amountUSDT','\x20USDT','ðŸ’³\x20Card\x20brand\x20detected:\x20','redirectUrl','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','currencyService','cardBrand','getPaymentStatus','Missing\x20required\x20card\x20or\x20customer\x20information','default','\x20commission:\x20','Payment\x20not\x20found','ðŸ”„\x20Updating\x20payment\x20status\x20from\x20','3fIrxhH','âœ…\x20Payment\x20','gatewayOrderId','error','\x20\x20\x20Customer:\x20','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','Headers:','ðŸ’°\x20Gateway\x20','https://api.trapay.uk','gatewayCommissionRate','\x20\x20\x20Amount:\x20','replace','8196192OMXrWt','\x20\x20\x20Payment\x20ID:\x20','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','âŒ\x20SquirrelPay\x20card\x20payment\x20error:','update','not\x20provided','1066968ZxuoCA','\x20\x20\x20Description:\x20','getWebhookLogs','Payment\x20is\x20being\x20processed','PAID','currency','625140mEgPAr','ðŸ’³\x20Card\x20last\x204:\x20','defineProperty','successful','amountAfterGatewayCommissionUSDT','151988KIFfuF','\x20already\x20has\x20status\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','brand','/api/webhooks/squirrel-pay','CurrencyService',',\x20skipping\x20update','\x20\x20\x20Billing\x20Country:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','\x20\x20\x20Webhook\x20status:\x20','friendly_message','FAILED','round','squirrelPayService','slice','\x20\x20\x20UID:\x20','gatewayPaymentId','toFixed','logWebhook','squirrelpay','paidAt','30KwXqel','payment_method','body'];a18_0x1ab1=function(){return _0x53d485;};return a18_0x1ab1();}Object[a18_0x32ca22(0x205)](exports,a18_0x32ca22(0x233),{'value':!![]}),exports[a18_0x32ca22(0x235)]=void 0x0;const squirrelPayService_1=require(a18_0x32ca22(0x1d7)),currencyService_1=require(a18_0x32ca22(0x22f)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a18_0x32ca22(0x1cd))),ipHelper_1=require(a18_0x32ca22(0x1ba)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0xba21d6){const _0x25ae91=a18_0x32ca22;return ISO_COUNTRY_CODES[_0x25ae91(0x1cf)](_0xba21d6[_0x25ae91(0x1bd)]());}class SquirrelPayController{constructor(){const _0xb3ee85=a18_0x32ca22;this[_0xb3ee85(0x222)]=async(_0xdbe1ea,_0x1beb6d,_0x3cd76e)=>{const _0x107f30=_0xb3ee85;try{const {paymentId:_0x1238b2}=_0xdbe1ea[_0x107f30(0x225)],{card_number:_0x220db0,exp_month:_0x55b4c3,exp_year:_0x50a10b,cvv:_0xc138c7,holder_name:_0x386985,customer_email:_0x38626a,customer_birth_date:_0x54fb1a,billing_country:_0x43f780,customer_phone:_0x145516,billing_address:_0x143847,billing_city:_0x3cd5b2,billing_state:_0x4f09a8,billing_zip:_0x6cfcc4}=_0xdbe1ea['body'];console[_0x107f30(0x1d6)](_0x107f30(0x1d9)+_0x1238b2);if(!_0x220db0||!_0x55b4c3||!_0x50a10b||!_0xc138c7||!_0x386985||!_0x38626a)return _0x1beb6d['status'](0x190)[_0x107f30(0x229)]({'success':![],'message':_0x107f30(0x1e6)});if(_0x43f780&&!isValidCountryCode(_0x43f780))return _0x1beb6d[_0x107f30(0x1d2)](0x190)[_0x107f30(0x229)]({'success':![],'message':'Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)'});const _0x3d8a4a=await database_1[_0x107f30(0x1e7)][_0x107f30(0x1ca)][_0x107f30(0x1ce)]({'where':{'id':_0x1238b2},'include':{'shop':!![]}});if(!_0x3d8a4a)return _0x1beb6d[_0x107f30(0x1d2)](0x194)[_0x107f30(0x229)]({'success':![],'message':_0x107f30(0x1e9)});if(_0x3d8a4a[_0x107f30(0x1d2)]!=='PENDING')return _0x1beb6d[_0x107f30(0x1d2)](0x190)[_0x107f30(0x229)]({'success':![],'message':_0x107f30(0x226)});const _0x447049=(0x0,ipHelper_1['getClientIP'])(_0xdbe1ea),_0xe0e074={'number':_0x220db0[_0x107f30(0x1f6)](/\s/g,''),'exp_month':_0x55b4c3[_0x107f30(0x223)]()[_0x107f30(0x232)](0x2,'0'),'exp_year':_0x50a10b[_0x107f30(0x223)](),'verification_value':_0xc138c7,'holder':_0x386985[_0x107f30(0x1bd)]()},_0x57c2c1={'ip':_0x447049,'email':_0x38626a};_0x54fb1a&&(_0x57c2c1[_0x107f30(0x1c9)]=_0x54fb1a);let _0x459861;_0x43f780&&(_0x459861={'country':_0x43f780,'address':_0x143847,'city':_0x3cd5b2,'state':_0x4f09a8,'zip':_0x6cfcc4});const _0x4517d4=(process.env.FRONTEND_URL||_0x107f30(0x22b))+'/payment/pending?id='+_0x1238b2+'&payment_id='+(_0x3d8a4a[_0x107f30(0x1ed)]||_0x1238b2),_0xd344e0=(process.env.API_BASE_URL||_0x107f30(0x1f3))+_0x107f30(0x20c),_0x54a29f=_0x1238b2[_0x107f30(0x216)](0x0,0x8)+'-'+_0x1238b2[_0x107f30(0x216)](0x8,0x10);console[_0x107f30(0x1d6)](_0x107f30(0x210)),console[_0x107f30(0x1d6)](_0x107f30(0x1f8)+_0x1238b2),console['log'](_0x107f30(0x1f5)+_0x3d8a4a[_0x107f30(0x1c2)]+'\x20'+_0x3d8a4a['currency']),console[_0x107f30(0x1d6)](_0x107f30(0x1ef)+_0x38626a+'\x20('+_0x447049+')'),console[_0x107f30(0x1d6)](_0x107f30(0x20f)+(_0x43f780||_0x107f30(0x1fc))),console[_0x107f30(0x1d6)](_0x107f30(0x1fe)+_0x54a29f);const _0x5a4307=await this[_0x107f30(0x215)][_0x107f30(0x222)](Math[_0x107f30(0x214)](_0x3d8a4a['amount']*0x64),_0x3d8a4a[_0x107f30(0x202)],_0x54a29f,_0x4517d4,_0xd344e0,_0xe0e074,_0x57c2c1,_0x459861,_0x145516),_0x278861=this['squirrelPayService'][_0x107f30(0x1e5)](_0x5a4307),_0x35053d={'gatewayPaymentId':_0x5a4307[_0x107f30(0x1d1)],'cardLast4':_0x278861['cardLast4'],'gateway':_0x107f30(0x21b),'customerEmail':_0x38626a,'customerPhone':_0x145516,'customerBirthDate':_0x54fb1a,'billingAddress':_0x143847,'billingCity':_0x3cd5b2,'billingState':_0x4f09a8,'billingZip':_0x6cfcc4,'customerCountry':_0x43f780};if(_0x278861['status']===_0x107f30(0x201)){_0x35053d['status']=_0x107f30(0x201),_0x35053d[_0x107f30(0x21c)]=new Date();try{const _0x2da870=await this['currencyService']['convertToUSDT'](_0x3d8a4a[_0x107f30(0x1c2)],_0x3d8a4a[_0x107f30(0x202)]);_0x35053d[_0x107f30(0x1de)]=_0x2da870,console[_0x107f30(0x1d6)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x2da870+_0x107f30(0x1df));const _0x38c8b3=await this[_0x107f30(0x1bb)][_0x107f30(0x1c5)](_0x3d8a4a['shopId'],_0x3d8a4a[_0x107f30(0x1bc)]),_0x14f806=_0x2da870*(0x1-_0x38c8b3/0x64);_0x35053d[_0x107f30(0x207)]=_0x14f806,_0x35053d['gatewayCommissionRate']=_0x38c8b3,console[_0x107f30(0x1d6)](_0x107f30(0x1f2)+_0x3d8a4a[_0x107f30(0x1bc)]+_0x107f30(0x1e8)+_0x38c8b3+'%'),console['log'](_0x107f30(0x1e2)+_0x14f806[_0x107f30(0x219)](0x6)+'\x20USDT');}catch(_0x4e02e0){console[_0x107f30(0x1ee)](_0x107f30(0x1d4),_0x4e02e0),_0x35053d[_0x107f30(0x1de)]=0x0,_0x35053d[_0x107f30(0x207)]=0x0,_0x35053d[_0x107f30(0x1f4)]=0x0;}}else _0x278861[_0x107f30(0x1d2)]==='FAILED'&&(_0x35053d[_0x107f30(0x1d2)]=_0x107f30(0x213),_0x35053d[_0x107f30(0x1c6)]=_0x278861[_0x107f30(0x1c6)]);const _0x14f98f=await database_1[_0x107f30(0x1e7)]['payment'][_0x107f30(0x1fb)]({'where':{'id':_0x1238b2},'data':_0x35053d});console[_0x107f30(0x1d6)]('âœ…\x20SquirrelPay\x20payment\x20updated:\x20'+_0x14f98f['status']);let _0x6fcdef;if(_0x278861['status']===_0x107f30(0x213))_0x6fcdef=_0x278861[_0x107f30(0x1c6)]||_0x5a4307[_0x107f30(0x212)]||_0x107f30(0x1dd);else _0x278861['status']===_0x107f30(0x1cc)?_0x6fcdef=_0x5a4307['friendly_message']||_0x107f30(0x200):_0x6fcdef=_0x5a4307['friendly_message']||_0x107f30(0x1da);const _0x196628={'success':_0x278861[_0x107f30(0x1d2)]!==_0x107f30(0x213),'status':_0x278861[_0x107f30(0x1d2)],'message':_0x6fcdef,'payment':{'id':_0x1238b2,'status':_0x14f98f[_0x107f30(0x1d2)],'gateway':_0x107f30(0x21b),'last4':_0x278861['cardLast4']}};_0x278861[_0x107f30(0x1e1)]&&(_0x196628[_0x107f30(0x1db)]=_0x278861[_0x107f30(0x1e1)],_0x196628[_0x107f30(0x221)]=!![],console['log'](_0x107f30(0x1f0)+_0x278861[_0x107f30(0x1e1)])),_0x1beb6d[_0x107f30(0x229)](_0x196628);}catch(_0xb80c60){console[_0x107f30(0x1ee)](_0x107f30(0x1fa),_0xb80c60),_0x3cd76e(_0xb80c60);}},this['handleWebhook']=async(_0x16fd45,_0x2a9699,_0x3b6871)=>{const _0x4172b0=_0xb3ee85;try{console[_0x4172b0(0x1d6)](_0x4172b0(0x1f9)),console[_0x4172b0(0x1d6)](_0x4172b0(0x1f1),_0x16fd45[_0x4172b0(0x1d8)]),console['log'](_0x4172b0(0x22e),_0x16fd45[_0x4172b0(0x21f)]),this[_0x4172b0(0x215)][_0x4172b0(0x21a)]({'headers':_0x16fd45[_0x4172b0(0x1d8)],'body':_0x16fd45['body'],'timestamp':new Date()[_0x4172b0(0x224)]()});const _0x396938=_0x16fd45['body'];if(!_0x396938['uid']||!_0x396938[_0x4172b0(0x1d2)])return console[_0x4172b0(0x1cb)](_0x4172b0(0x1bf)),_0x2a9699[_0x4172b0(0x1d2)](0x190)[_0x4172b0(0x229)]({'success':![],'message':_0x4172b0(0x1d5)});let _0x567b9e;_0x396938[_0x4172b0(0x1d1)]&&(_0x567b9e=await database_1[_0x4172b0(0x1e7)][_0x4172b0(0x1ca)][_0x4172b0(0x1c3)]({'where':{'gatewayPaymentId':_0x396938[_0x4172b0(0x1d1)],'gateway':_0x4172b0(0x21b)}}));if(!_0x567b9e)return console['warn'](_0x4172b0(0x227)),console[_0x4172b0(0x1cb)](_0x4172b0(0x217)+_0x396938[_0x4172b0(0x1d1)]),console['warn'](_0x4172b0(0x1fe)+_0x396938[_0x4172b0(0x22d)]),console[_0x4172b0(0x1cb)]('\x20\x20\x20Gateway:\x20squirrelpay'),console['warn']('\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20'+_0x396938['uid']),_0x2a9699[_0x4172b0(0x1d2)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console[_0x4172b0(0x1d6)](_0x4172b0(0x1c7)+_0x567b9e['id']),console[_0x4172b0(0x1d6)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x567b9e[_0x4172b0(0x1d2)]),console['log']('\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20'+_0x567b9e[_0x4172b0(0x218)]),console[_0x4172b0(0x1d6)](_0x4172b0(0x211)+_0x396938['status']),console[_0x4172b0(0x1d6)]('\x20\x20\x20Webhook\x20UID:\x20'+_0x396938[_0x4172b0(0x1d1)]);let _0x142d14=null;const _0x1e48a3={};_0x396938[_0x4172b0(0x21e)]?.[_0x4172b0(0x20b)]&&(_0x1e48a3[_0x4172b0(0x1e4)]=_0x396938[_0x4172b0(0x21e)][_0x4172b0(0x20b)],console[_0x4172b0(0x1d6)](_0x4172b0(0x1e0)+_0x396938[_0x4172b0(0x21e)][_0x4172b0(0x20b)]));_0x396938[_0x4172b0(0x21e)]?.[_0x4172b0(0x1c0)]&&(_0x1e48a3[_0x4172b0(0x236)]=_0x396938[_0x4172b0(0x21e)][_0x4172b0(0x1c0)],console['log'](_0x4172b0(0x204)+_0x396938[_0x4172b0(0x21e)][_0x4172b0(0x1c0)]));switch(_0x396938[_0x4172b0(0x1d2)]){case _0x4172b0(0x206):_0x142d14=_0x4172b0(0x201),console[_0x4172b0(0x1d6)](_0x4172b0(0x1be));break;case'failed':_0x142d14=_0x4172b0(0x213),_0x1e48a3[_0x4172b0(0x1c6)]=_0x396938[_0x4172b0(0x212)]||_0x396938['message']||_0x4172b0(0x1dd),console[_0x4172b0(0x1d6)](_0x4172b0(0x22c)+_0x1e48a3[_0x4172b0(0x1c6)]);break;case _0x4172b0(0x1d3):console[_0x4172b0(0x1d6)](_0x4172b0(0x20a));break;default:console[_0x4172b0(0x1cb)](_0x4172b0(0x228)+_0x396938[_0x4172b0(0x1d2)]);break;}if(_0x142d14&&_0x142d14!==_0x567b9e[_0x4172b0(0x1d2)])console[_0x4172b0(0x1d6)](_0x4172b0(0x1ea)+_0x567b9e[_0x4172b0(0x1d2)]+'\x20to\x20'+_0x142d14),await this[_0x4172b0(0x1bb)][_0x4172b0(0x1c8)](_0x567b9e['id'],_0x142d14,_0x1e48a3),console[_0x4172b0(0x1d6)](_0x4172b0(0x1ec)+_0x567b9e['id']+_0x4172b0(0x1c4)+_0x142d14+_0x4172b0(0x22a));else _0x142d14&&console[_0x4172b0(0x1d6)](_0x4172b0(0x1d0)+_0x567b9e['id']+_0x4172b0(0x209)+_0x142d14+_0x4172b0(0x20e));_0x2a9699[_0x4172b0(0x1d2)](0xc8)['json']({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x1b7390){console['error']('âŒ\x20SquirrelPay\x20webhook\x20error:',_0x1b7390),_0x3b6871(_0x1b7390);}},this[_0xb3ee85(0x1ff)]=async(_0x46050a,_0x54d0f1,_0x2f0050)=>{const _0x1109b9=_0xb3ee85;try{const {limit:_0x5d978e}=_0x46050a['query'],_0x44a948=this[_0x1109b9(0x215)][_0x1109b9(0x1ff)](_0x5d978e?parseInt(_0x5d978e):0x32);_0x54d0f1[_0x1109b9(0x229)]({'success':!![],'result':{'logs':_0x44a948,'count':_0x44a948[_0x1109b9(0x220)]}});}catch(_0x3385b9){_0x2f0050(_0x3385b9);}},this[_0xb3ee85(0x215)]=new squirrelPayService_1[(_0xb3ee85(0x234))]({'shopId':process.env.SQUIRREL_PAY_SHOP_ID||'','secretKey':process.env.SQUIRREL_PAY_SECRET_KEY||'','baseUrl':process.env.SQUIRREL_PAY_BASE_URL||'https://gate.squirrel-pay.com','isTestMode':process.env.SQUIRREL_PAY_TEST_MODE==='true'}),this[_0xb3ee85(0x1e3)]=new currencyService_1[(_0xb3ee85(0x20d))](),this['webhookService']=new webhookService_1['WebhookService']();}}exports['SquirrelPayController']=SquirrelPayController;