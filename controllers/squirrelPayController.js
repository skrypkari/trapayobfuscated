'use strict';const a17_0x2c5ef6=a17_0x515b;(function(_0x346fe4,_0x20cf0a){const _0x5215c4=a17_0x515b,_0x5c59e0=_0x346fe4();while(!![]){try{const _0x295960=parseInt(_0x5215c4(0x222))/0x1*(-parseInt(_0x5215c4(0x202))/0x2)+parseInt(_0x5215c4(0x259))/0x3*(-parseInt(_0x5215c4(0x239))/0x4)+-parseInt(_0x5215c4(0x249))/0x5+-parseInt(_0x5215c4(0x21b))/0x6*(parseInt(_0x5215c4(0x1fb))/0x7)+parseInt(_0x5215c4(0x1e2))/0x8+parseInt(_0x5215c4(0x1ee))/0x9*(parseInt(_0x5215c4(0x226))/0xa)+parseInt(_0x5215c4(0x1f4))/0xb*(parseInt(_0x5215c4(0x260))/0xc);if(_0x295960===_0x20cf0a)break;else _0x5c59e0['push'](_0x5c59e0['shift']());}catch(_0x2013ca){_0x5c59e0['push'](_0x5c59e0['shift']());}}}(a17_0x328e,0x54239));var __importDefault=this&&this[a17_0x2c5ef6(0x20e)]||function(_0x144723){const _0x2b3058=a17_0x2c5ef6;return _0x144723&&_0x144723[_0x2b3058(0x23b)]?_0x144723:{'default':_0x144723};};Object['defineProperty'](exports,a17_0x2c5ef6(0x23b),{'value':!![]}),exports[a17_0x2c5ef6(0x214)]=void 0x0;const squirrelPayService_1=require(a17_0x2c5ef6(0x230)),currencyService_1=require('../services/currencyService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a17_0x2c5ef6(0x229))),ipHelper_1=require(a17_0x2c5ef6(0x1fd)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function a17_0x328e(){const _0x51edc9=['processCardPayment','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','5999TgCANV','description','../utils/ipHelper','json','params','âŒ\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:','Payment\x20is\x20not\x20in\x20pending\x20status','223810bJSnux','amountAfterGatewayCommissionUSDT','warn','SquirrelPayService','\x20\x20\x20Webhook\x20UID:\x20','squirrelpay','toISOString','ðŸ”\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','\x20updated:\x20status=','message','FAILED','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','__importDefault','body','\x20\x20\x20Billing\x20Country:\x20','PENDING','incomplete','toUpperCase','SquirrelPayController','Body:','friendly_message','\x20to\x20','headers','API_BASE_URL','uid','2370MOHoUf','\x20\x20\x20Webhook\x20status:\x20','amountUSDT','Missing\x20required\x20card\x20or\x20customer\x20information','not\x20provided','\x20USDT','toString','6VeTwLL','squirrelPayService','amount','replace','3080gloyal',',\x20skipping\x20update','\x20\x20\x20Description:\x20','../config/database','\x20commission:\x20','ðŸ“\x20SquirrelPay\x20payment\x20details:','toFixed','PAID','handleWebhook','Missing\x20required\x20fields\x20in\x20webhook','../services/gateways/squirrelPayService','getClientIP','env','brand','getGatewayCommission','Payment\x20not\x20found','currencyService','requires_action','Headers:','1532nDpdvH','FRONTEND_URL','__esModule','âœ…\x20Payment\x20','failed','âœ…\x20SquirrelPay\x20payment\x20updated:\x20','â³\x20Payment\x20remains\x20PENDING\x20(incomplete)','redirectUrl','true','\x20\x20\x20Payment\x20ID:\x20','query','âŒ\x20SquirrelPay\x20webhook\x20error:','has','ðŸ¿ï¸\x20SquirrelPay\x20webhook\x20received','last_4','WebhookService','99550GKgFrT','length','Payment\x20failed','slice','getWebhookLogs','status','padStart','gateway','\x20\x20\x20Gateway:\x20squirrelpay','https://app.trapay.uk','getPaymentStatus','\x20\x20\x20Customer:\x20','log','successful','gatewayPaymentId','https://api.trapay.uk','1272hPpjBg','ðŸ’³\x20Card\x20last\x204:\x20','default','round','payment_method','update','birth_date','757920ZdaBEt','cardLast4','âš ï¸\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:','3103904KMsWYm','\x20\x20\x20UID:\x20','failureMessage','CurrencyService','convertToUSDT','ðŸ”„\x203D\x20Secure\x20redirect\x20required:\x20','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','&payment_id=','/payment/pending?id=','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','Payment\x20is\x20being\x20processed','findUnique','351vvlWeY','payment','currency','error','updatePaymentStatus','â„¹ï¸\x20Payment\x20','198wasGVg','âš ï¸\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','gatewayCommissionRate','ðŸ’°\x20Gateway\x20','SQUIRREL_PAY_BASE_URL'];a17_0x328e=function(){return _0x51edc9;};return a17_0x328e();}function isValidCountryCode(_0x591102){const _0x5254a7=a17_0x2c5ef6;return ISO_COUNTRY_CODES[_0x5254a7(0x245)](_0x591102[_0x5254a7(0x213)]());}class SquirrelPayController{constructor(){const _0x3efbbc=a17_0x2c5ef6;this[_0x3efbbc(0x1f9)]=async(_0x60658f,_0xb18aca,_0x30fc78)=>{const _0x200b78=_0x3efbbc;try{const {paymentId:_0x5adf95}=_0x60658f[_0x200b78(0x1ff)],{card_number:_0x3d178e,exp_month:_0x3aeb29,exp_year:_0x1bbca9,cvv:_0x3ee9a4,holder_name:_0x359bb6,customer_email:_0x29e8c9,customer_birth_date:_0x67edd0,billing_country:_0x33fef2,customer_phone:_0x1ccca9,billing_address:_0x339a1f,billing_city:_0x2f6fba,billing_state:_0x2511b5,billing_zip:_0x46926d}=_0x60658f[_0x200b78(0x20f)];console['log']('ðŸ¿ï¸\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20'+_0x5adf95);if(!_0x3d178e||!_0x3aeb29||!_0x1bbca9||!_0x3ee9a4||!_0x359bb6||!_0x29e8c9)return _0xb18aca[_0x200b78(0x24e)](0x190)[_0x200b78(0x1fe)]({'success':![],'message':_0x200b78(0x21e)});if(_0x33fef2&&!isValidCountryCode(_0x33fef2))return _0xb18aca['status'](0x190)[_0x200b78(0x1fe)]({'success':![],'message':_0x200b78(0x1fa)});const _0x3ec9f3=await database_1['default'][_0x200b78(0x1ef)][_0x200b78(0x1ed)]({'where':{'id':_0x5adf95},'include':{'shop':!![]}});if(!_0x3ec9f3)return _0xb18aca[_0x200b78(0x24e)](0x194)['json']({'success':![],'message':_0x200b78(0x235)});if(_0x3ec9f3[_0x200b78(0x24e)]!==_0x200b78(0x211))return _0xb18aca['status'](0x190)[_0x200b78(0x1fe)]({'success':![],'message':_0x200b78(0x201)});const _0x21f1f1=(0x0,ipHelper_1[_0x200b78(0x231)])(_0x60658f),_0x1d29ad={'number':_0x3d178e[_0x200b78(0x225)](/\s/g,''),'exp_month':_0x3aeb29[_0x200b78(0x221)]()[_0x200b78(0x24f)](0x2,'0'),'exp_year':_0x1bbca9[_0x200b78(0x221)](),'verification_value':_0x3ee9a4,'holder':_0x359bb6[_0x200b78(0x213)]()},_0x3f8996={'ip':_0x21f1f1,'email':_0x29e8c9};_0x67edd0&&(_0x3f8996[_0x200b78(0x25f)]=_0x67edd0);let _0x4c6151;_0x33fef2&&(_0x4c6151={'country':_0x33fef2,'address':_0x339a1f,'city':_0x2f6fba,'state':_0x2511b5,'zip':_0x46926d});const _0x8ddff=(process[_0x200b78(0x232)][_0x200b78(0x23a)]||_0x200b78(0x252))+_0x200b78(0x1ea)+_0x5adf95+_0x200b78(0x1e9)+(_0x3ec9f3['gatewayOrderId']||_0x5adf95),_0x56111f=(process[_0x200b78(0x232)][_0x200b78(0x219)]||_0x200b78(0x258))+'/api/webhooks/squirrel-pay',_0xa2ad49=_0x5adf95['slice'](0x0,0x8)+'-'+_0x5adf95[_0x200b78(0x24c)](0x8,0x10);console[_0x200b78(0x255)](_0x200b78(0x22b)),console[_0x200b78(0x255)](_0x200b78(0x242)+_0x5adf95),console[_0x200b78(0x255)]('\x20\x20\x20Amount:\x20'+_0x3ec9f3[_0x200b78(0x224)]+'\x20'+_0x3ec9f3[_0x200b78(0x1f0)]),console[_0x200b78(0x255)](_0x200b78(0x254)+_0x29e8c9+'\x20('+_0x21f1f1+')'),console[_0x200b78(0x255)](_0x200b78(0x210)+(_0x33fef2||_0x200b78(0x21f))),console['log']('\x20\x20\x20Description:\x20'+_0xa2ad49);const _0x4c1d98=await this[_0x200b78(0x223)][_0x200b78(0x1f9)](Math[_0x200b78(0x25c)](_0x3ec9f3[_0x200b78(0x224)]*0x64),_0x3ec9f3['currency'],_0xa2ad49,_0x8ddff,_0x56111f,_0x1d29ad,_0x3f8996,_0x4c6151,_0x1ccca9),_0xe477c1=this[_0x200b78(0x223)][_0x200b78(0x253)](_0x4c1d98),_0xa76e79={'gatewayPaymentId':_0x4c1d98[_0x200b78(0x21a)],'cardLast4':_0xe477c1[_0x200b78(0x261)],'gateway':_0x200b78(0x207),'customerEmail':_0x29e8c9,'customerPhone':_0x1ccca9,'customerBirthDate':_0x67edd0,'billingAddress':_0x339a1f,'billingCity':_0x2f6fba,'billingState':_0x2511b5,'billingZip':_0x46926d,'customerCountry':_0x33fef2};if(_0xe477c1[_0x200b78(0x24e)]===_0x200b78(0x22d)){_0xa76e79[_0x200b78(0x24e)]=_0x200b78(0x22d),_0xa76e79['paidAt']=new Date();try{const _0x2bc5fc=await this[_0x200b78(0x236)][_0x200b78(0x1e6)](_0x3ec9f3[_0x200b78(0x224)],_0x3ec9f3[_0x200b78(0x1f0)]);_0xa76e79[_0x200b78(0x21d)]=_0x2bc5fc,console[_0x200b78(0x255)]('ðŸ’°\x20Calculated\x20amountUSDT:\x20'+_0x2bc5fc+_0x200b78(0x220));const _0x144e49=await this['webhookService'][_0x200b78(0x234)](_0x3ec9f3['shopId'],_0x3ec9f3['gateway']),_0x23976e=_0x2bc5fc*(0x1-_0x144e49/0x64);_0xa76e79[_0x200b78(0x203)]=_0x23976e,_0xa76e79[_0x200b78(0x1f6)]=_0x144e49,console[_0x200b78(0x255)](_0x200b78(0x1f7)+_0x3ec9f3[_0x200b78(0x250)]+_0x200b78(0x22a)+_0x144e49+'%'),console[_0x200b78(0x255)](_0x200b78(0x1eb)+_0x23976e[_0x200b78(0x22c)](0x6)+_0x200b78(0x220));}catch(_0xefe0b2){console[_0x200b78(0x1f1)](_0x200b78(0x200),_0xefe0b2),_0xa76e79[_0x200b78(0x21d)]=0x0,_0xa76e79[_0x200b78(0x203)]=0x0,_0xa76e79[_0x200b78(0x1f6)]=0x0;}}else _0xe477c1[_0x200b78(0x24e)]===_0x200b78(0x20c)&&(_0xa76e79[_0x200b78(0x24e)]=_0x200b78(0x20c),_0xa76e79[_0x200b78(0x1e4)]=_0xe477c1['failureMessage']);const _0x2b88b6=await database_1[_0x200b78(0x25b)][_0x200b78(0x1ef)][_0x200b78(0x25e)]({'where':{'id':_0x5adf95},'data':_0xa76e79});console[_0x200b78(0x255)](_0x200b78(0x23e)+_0x2b88b6[_0x200b78(0x24e)]);let _0x2bbb89;if(_0xe477c1[_0x200b78(0x24e)]==='FAILED')_0x2bbb89=_0xe477c1[_0x200b78(0x1e4)]||_0x4c1d98[_0x200b78(0x216)]||'Payment\x20failed';else _0xe477c1[_0x200b78(0x24e)]===_0x200b78(0x211)?_0x2bbb89=_0x4c1d98['friendly_message']||_0x200b78(0x1ec):_0x2bbb89=_0x4c1d98[_0x200b78(0x216)]||'Payment\x20processed\x20successfully';const _0x2103e2={'success':_0xe477c1[_0x200b78(0x24e)]!==_0x200b78(0x20c),'status':_0xe477c1[_0x200b78(0x24e)],'message':_0x2bbb89,'payment':{'id':_0x5adf95,'status':_0x2b88b6[_0x200b78(0x24e)],'gateway':_0x200b78(0x207),'last4':_0xe477c1[_0x200b78(0x261)]}};_0xe477c1['redirectUrl']&&(_0x2103e2['redirect_url']=_0xe477c1[_0x200b78(0x240)],_0x2103e2[_0x200b78(0x237)]=!![],console[_0x200b78(0x255)](_0x200b78(0x1e7)+_0xe477c1[_0x200b78(0x240)])),_0xb18aca['json'](_0x2103e2);}catch(_0x5474d5){console[_0x200b78(0x1f1)]('âŒ\x20SquirrelPay\x20card\x20payment\x20error:',_0x5474d5),_0x30fc78(_0x5474d5);}},this[_0x3efbbc(0x22e)]=async(_0x45fc7f,_0xb3388f,_0x192e08)=>{const _0x2f2e92=_0x3efbbc;try{console[_0x2f2e92(0x255)](_0x2f2e92(0x246)),console[_0x2f2e92(0x255)](_0x2f2e92(0x238),_0x45fc7f['headers']),console['log'](_0x2f2e92(0x215),_0x45fc7f['body']),this[_0x2f2e92(0x223)]['logWebhook']({'headers':_0x45fc7f[_0x2f2e92(0x218)],'body':_0x45fc7f['body'],'timestamp':new Date()[_0x2f2e92(0x208)]()});const _0xea81b8=_0x45fc7f['body'];if(!_0xea81b8[_0x2f2e92(0x21a)]||!_0xea81b8[_0x2f2e92(0x24e)])return console[_0x2f2e92(0x204)](_0x2f2e92(0x1f5)),_0xb3388f['status'](0x190)[_0x2f2e92(0x1fe)]({'success':![],'message':_0x2f2e92(0x22f)});let _0x5f45d1;_0xea81b8[_0x2f2e92(0x21a)]&&(_0x5f45d1=await database_1[_0x2f2e92(0x25b)][_0x2f2e92(0x1ef)]['findFirst']({'where':{'gatewayPaymentId':_0xea81b8['uid'],'gateway':_0x2f2e92(0x207)}}));if(!_0x5f45d1)return console[_0x2f2e92(0x204)](_0x2f2e92(0x262)),console[_0x2f2e92(0x204)](_0x2f2e92(0x1e3)+_0xea81b8[_0x2f2e92(0x21a)]),console[_0x2f2e92(0x204)](_0x2f2e92(0x228)+_0xea81b8[_0x2f2e92(0x1fc)]),console[_0x2f2e92(0x204)](_0x2f2e92(0x251)),console['warn'](_0x2f2e92(0x20d)+_0xea81b8['uid']),_0xb3388f[_0x2f2e92(0x24e)](0x194)['json']({'success':![],'message':_0x2f2e92(0x235)});console['log'](_0x2f2e92(0x209)+_0x5f45d1['id']),console[_0x2f2e92(0x255)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x5f45d1[_0x2f2e92(0x24e)]),console[_0x2f2e92(0x255)](_0x2f2e92(0x1e8)+_0x5f45d1[_0x2f2e92(0x257)]),console[_0x2f2e92(0x255)](_0x2f2e92(0x21c)+_0xea81b8[_0x2f2e92(0x24e)]),console[_0x2f2e92(0x255)](_0x2f2e92(0x206)+_0xea81b8[_0x2f2e92(0x21a)]);let _0x5c5ac0=null;const _0x205a2d={};_0xea81b8[_0x2f2e92(0x25d)]?.[_0x2f2e92(0x233)]&&(_0x205a2d['cardBrand']=_0xea81b8['payment_method'][_0x2f2e92(0x233)],console['log']('ðŸ’³\x20Card\x20brand\x20detected:\x20'+_0xea81b8[_0x2f2e92(0x25d)]['brand']));_0xea81b8[_0x2f2e92(0x25d)]?.[_0x2f2e92(0x247)]&&(_0x205a2d[_0x2f2e92(0x261)]=_0xea81b8[_0x2f2e92(0x25d)][_0x2f2e92(0x247)],console[_0x2f2e92(0x255)](_0x2f2e92(0x25a)+_0xea81b8['payment_method']['last_4']));switch(_0xea81b8[_0x2f2e92(0x24e)]){case _0x2f2e92(0x256):_0x5c5ac0=_0x2f2e92(0x22d),console[_0x2f2e92(0x255)]('âœ…\x20Payment\x20will\x20be\x20marked\x20as\x20PAID');break;case _0x2f2e92(0x23d):_0x5c5ac0=_0x2f2e92(0x20c),_0x205a2d[_0x2f2e92(0x1e4)]=_0xea81b8[_0x2f2e92(0x216)]||_0xea81b8[_0x2f2e92(0x20b)]||_0x2f2e92(0x24b),console[_0x2f2e92(0x255)]('âŒ\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x205a2d[_0x2f2e92(0x1e4)]);break;case _0x2f2e92(0x212):console[_0x2f2e92(0x255)](_0x2f2e92(0x23f));break;default:console[_0x2f2e92(0x204)]('âš ï¸\x20Unknown\x20SquirrelPay\x20status:\x20'+_0xea81b8['status']);break;}if(_0x5c5ac0&&_0x5c5ac0!==_0x5f45d1[_0x2f2e92(0x24e)])console['log']('ðŸ”„\x20Updating\x20payment\x20status\x20from\x20'+_0x5f45d1[_0x2f2e92(0x24e)]+_0x2f2e92(0x217)+_0x5c5ac0),await this['webhookService'][_0x2f2e92(0x1f2)](_0x5f45d1['id'],_0x5c5ac0,_0x205a2d),console[_0x2f2e92(0x255)](_0x2f2e92(0x23c)+_0x5f45d1['id']+_0x2f2e92(0x20a)+_0x5c5ac0+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0x5c5ac0&&console['log'](_0x2f2e92(0x1f3)+_0x5f45d1['id']+'\x20already\x20has\x20status\x20'+_0x5c5ac0+_0x2f2e92(0x227));_0xb3388f[_0x2f2e92(0x24e)](0xc8)[_0x2f2e92(0x1fe)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x20e19){console[_0x2f2e92(0x1f1)](_0x2f2e92(0x244),_0x20e19),_0x192e08(_0x20e19);}},this[_0x3efbbc(0x24d)]=async(_0x5777ab,_0x27b1de,_0x10e785)=>{const _0x550d88=_0x3efbbc;try{const {limit:_0x4322fa}=_0x5777ab[_0x550d88(0x243)],_0x56f2f1=this[_0x550d88(0x223)][_0x550d88(0x24d)](_0x4322fa?parseInt(_0x4322fa):0x32);_0x27b1de[_0x550d88(0x1fe)]({'success':!![],'result':{'logs':_0x56f2f1,'count':_0x56f2f1[_0x550d88(0x24a)]}});}catch(_0x28ddf4){_0x10e785(_0x28ddf4);}},this['squirrelPayService']=new squirrelPayService_1[(_0x3efbbc(0x205))]({'shopId':process[_0x3efbbc(0x232)]['SQUIRREL_PAY_SHOP_ID']||'','secretKey':process['env']['SQUIRREL_PAY_SECRET_KEY']||'','baseUrl':process[_0x3efbbc(0x232)][_0x3efbbc(0x1f8)]||'https://gate.squirrel-pay.com','isTestMode':process[_0x3efbbc(0x232)]['SQUIRREL_PAY_TEST_MODE']===_0x3efbbc(0x241)}),this[_0x3efbbc(0x236)]=new currencyService_1[(_0x3efbbc(0x1e5))](),this['webhookService']=new webhookService_1[(_0x3efbbc(0x248))]();}}function a17_0x515b(_0x9340e8,_0x57c0f6){_0x9340e8=_0x9340e8-0x1e2;const _0x328ef9=a17_0x328e();let _0x515bed=_0x328ef9[_0x9340e8];return _0x515bed;}exports[a17_0x2c5ef6(0x214)]=SquirrelPayController;