'use strict';const a16_0x315768=a16_0x3232;(function(_0x35d921,_0x1e1d2d){const _0x37fced=a16_0x3232,_0x2425e1=_0x35d921();while(!![]){try{const _0x303bd3=-parseInt(_0x37fced(0x101))/0x1+parseInt(_0x37fced(0xf0))/0x2+-parseInt(_0x37fced(0xec))/0x3+-parseInt(_0x37fced(0x108))/0x4*(-parseInt(_0x37fced(0x10c))/0x5)+parseInt(_0x37fced(0xd2))/0x6+parseInt(_0x37fced(0x129))/0x7*(parseInt(_0x37fced(0x124))/0x8)+parseInt(_0x37fced(0x10d))/0x9;if(_0x303bd3===_0x1e1d2d)break;else _0x2425e1['push'](_0x2425e1['shift']());}catch(_0x4bba3e){_0x2425e1['push'](_0x2425e1['shift']());}}}(a16_0x1114,0x73c44));var __importDefault=this&&this[a16_0x315768(0xe3)]||function(_0x50e695){return _0x50e695&&_0x50e695['__esModule']?_0x50e695:{'default':_0x50e695};};Object[a16_0x315768(0xc7)](exports,a16_0x315768(0x111),{'value':!![]}),exports[a16_0x315768(0xc0)]=void 0x0;const squirrelPayService_1=require('../services/gateways/squirrelPayService'),currencyService_1=require(a16_0x315768(0xe7)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a16_0x315768(0xde))),ipHelper_1=require(a16_0x315768(0xf3)),ISO_COUNTRY_CODES=new Set(['AD','AE','AF','AG','AI','AL','AM','AO','AQ','AR','AS','AT','AU','AW','AX','AZ','BA','BB','BD','BE','BF','BG','BH','BI','BJ','BL','BM','BN','BO','BQ','BR','BS','BT','BV','BW','BY','BZ','CA','CC','CD','CF','CG','CH','CI','CK','CL','CM','CN','CO','CR','CU','CV','CW','CX','CY','CZ','DE','DJ','DK','DM','DO','DZ','EC','EE','EG','EH','ER','ES','ET','FI','FJ','FK','FM','FO','FR','GA','GB','GD','GE','GF','GG','GH','GI','GL','GM','GN','GP','GQ','GR','GS','GT','GU','GW','GY','HK','HM','HN','HR','HT','HU','ID','IE','IL','IM','IN','IO','IQ','IR','IS','IT','JE','JM','JO','JP','KE','KG','KH','KI','KM','KN','KP','KR','KW','KY','KZ','LA','LB','LC','LI','LK','LR','LS','LT','LU','LV','LY','MA','MC','MD','ME','MF','MG','MH','MK','ML','MM','MN','MO','MP','MQ','MR','MS','MT','MU','MV','MW','MX','MY','MZ','NA','NC','NE','NF','NG','NI','NL','NO','NP','NR','NU','NZ','OM','PA','PE','PF','PG','PH','PK','PL','PM','PN','PR','PS','PT','PW','PY','QA','RE','RO','RS','RU','RW','SA','SB','SC','SD','SE','SG','SH','SI','SJ','SK','SL','SM','SN','SO','SR','SS','ST','SV','SX','SY','SZ','TC','TD','TF','TG','TH','TJ','TK','TL','TM','TN','TO','TR','TT','TV','TW','TZ','UA','UG','UM','US','UY','UZ','VA','VC','VE','VG','VI','VN','VU','WF','WS','YE','YT','ZA','ZM','ZW']);function isValidCountryCode(_0x521f16){const _0x280253=a16_0x315768;return ISO_COUNTRY_CODES[_0x280253(0x118)](_0x521f16[_0x280253(0xd3)]());}class SquirrelPayController{constructor(){const _0x4e4d70=a16_0x315768;this[_0x4e4d70(0xdb)]=async(_0x23862c,_0x4ae642,_0x200572)=>{const _0xc45739=_0x4e4d70;try{const {paymentId:_0x1f54d8}=_0x23862c[_0xc45739(0x104)],{card_number:_0x3aa54a,exp_month:_0x18383f,exp_year:_0x176b9e,cvv:_0x295040,holder_name:_0x2c2b28,customer_email:_0x2533ff,customer_birth_date:_0x335f3b,billing_country:_0x47f52b,customer_phone:_0xd2cc45,billing_address:_0x4a24ff,billing_city:_0x3efc3a,billing_state:_0x34b1bf,billing_zip:_0xbcf621}=_0x23862c[_0xc45739(0x12c)];console[_0xc45739(0xf6)](_0xc45739(0xe1)+_0x1f54d8);if(!_0x3aa54a||!_0x18383f||!_0x176b9e||!_0x295040||!_0x2c2b28||!_0x2533ff)return _0x4ae642['status'](0x190)[_0xc45739(0xdf)]({'success':![],'message':_0xc45739(0xf2)});if(_0x47f52b&&!isValidCountryCode(_0x47f52b))return _0x4ae642[_0xc45739(0x106)](0x190)[_0xc45739(0xdf)]({'success':![],'message':_0xc45739(0xeb)});const _0xa4bb84=await database_1['default']['payment'][_0xc45739(0x122)]({'where':{'id':_0x1f54d8},'include':{'shop':!![]}});if(!_0xa4bb84)return _0x4ae642['status'](0x194)[_0xc45739(0xdf)]({'success':![],'message':_0xc45739(0xf8)});if(_0xa4bb84[_0xc45739(0x106)]!==_0xc45739(0x128))return _0x4ae642[_0xc45739(0x106)](0x190)[_0xc45739(0xdf)]({'success':![],'message':_0xc45739(0xcf)});const _0x11b8fc=(0x0,ipHelper_1[_0xc45739(0xbc)])(_0x23862c),_0x44a2df={'number':_0x3aa54a[_0xc45739(0x112)](/\s/g,''),'exp_month':_0x18383f[_0xc45739(0xd8)]()[_0xc45739(0xbb)](0x2,'0'),'exp_year':_0x176b9e[_0xc45739(0xd8)](),'verification_value':_0x295040,'holder':_0x2c2b28[_0xc45739(0xd3)]()},_0x25a9fc={'ip':_0x11b8fc,'email':_0x2533ff};_0x335f3b&&(_0x25a9fc[_0xc45739(0xff)]=_0x335f3b);let _0x10cc02;_0x47f52b&&(_0x10cc02={'country':_0x47f52b,'address':_0x4a24ff,'city':_0x3efc3a,'state':_0x34b1bf,'zip':_0xbcf621});const _0x4c13af=(process[_0xc45739(0x12e)][_0xc45739(0xd9)]||_0xc45739(0x127))+'/payment/pending?id='+_0x1f54d8+'&payment_id='+(_0xa4bb84[_0xc45739(0xce)]||_0x1f54d8),_0x9192e1=(process['env'][_0xc45739(0xe4)]||_0xc45739(0xea))+_0xc45739(0xcc),_0x4dee40=_0x1f54d8[_0xc45739(0xdc)](0x0,0x8)+'-'+_0x1f54d8[_0xc45739(0xdc)](0x8,0x10);console[_0xc45739(0xf6)](_0xc45739(0x113)),console[_0xc45739(0xf6)](_0xc45739(0x126)+_0x1f54d8),console['log'](_0xc45739(0x117)+_0xa4bb84['amount']+'\x20'+_0xa4bb84[_0xc45739(0xc2)]),console['log'](_0xc45739(0x107)+_0x2533ff+'\x20('+_0x11b8fc+')'),console[_0xc45739(0xf6)]('\x20\x20\x20Billing\x20Country:\x20'+(_0x47f52b||_0xc45739(0xc6))),console[_0xc45739(0xf6)](_0xc45739(0x11b)+_0x4dee40);const _0x5bd678=await this[_0xc45739(0x130)][_0xc45739(0xdb)](Math[_0xc45739(0xb5)](_0xa4bb84[_0xc45739(0xe6)]*0x64),_0xa4bb84[_0xc45739(0xc2)],_0x4dee40,_0x4c13af,_0x9192e1,_0x44a2df,_0x25a9fc,_0x10cc02,_0xd2cc45),_0x18335b=this[_0xc45739(0x130)][_0xc45739(0x115)](_0x5bd678),_0x1de4f8={'gatewayPaymentId':_0x5bd678['uid'],'cardLast4':_0x18335b[_0xc45739(0xe9)],'gateway':_0xc45739(0xb4),'customerEmail':_0x2533ff,'customerPhone':_0xd2cc45,'customerBirthDate':_0x335f3b,'billingAddress':_0x4a24ff,'billingCity':_0x3efc3a,'billingState':_0x34b1bf,'billingZip':_0xbcf621,'customerCountry':_0x47f52b};if(_0x18335b[_0xc45739(0x106)]===_0xc45739(0xe5)){_0x1de4f8[_0xc45739(0x106)]=_0xc45739(0xe5),_0x1de4f8[_0xc45739(0x123)]=new Date();try{const _0x2b0b67=await this[_0xc45739(0x10b)][_0xc45739(0x114)](_0xa4bb84['amount'],_0xa4bb84[_0xc45739(0xc2)]);_0x1de4f8[_0xc45739(0xb7)]=_0x2b0b67,console['log'](_0xc45739(0xba)+_0x2b0b67+_0xc45739(0xda));const _0x37cda9=await this[_0xc45739(0x109)][_0xc45739(0xdd)](_0xa4bb84[_0xc45739(0x100)],_0xa4bb84[_0xc45739(0xe0)]),_0x5a6c04=_0x2b0b67*(0x1-_0x37cda9/0x64);_0x1de4f8[_0xc45739(0xd0)]=_0x5a6c04,_0x1de4f8['gatewayCommissionRate']=_0x37cda9,console[_0xc45739(0xf6)](_0xc45739(0xc9)+_0xa4bb84[_0xc45739(0xe0)]+'\x20commission:\x20'+_0x37cda9+'%'),console[_0xc45739(0xf6)]('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x5a6c04['toFixed'](0x6)+'\x20USDT');}catch(_0x3a94a4){console[_0xc45739(0x11a)]('‚ùå\x20Failed\x20to\x20calculate\x20amountUSDT\x20or\x20commission:',_0x3a94a4),_0x1de4f8[_0xc45739(0xb7)]=0x0,_0x1de4f8[_0xc45739(0xd0)]=0x0,_0x1de4f8[_0xc45739(0x10f)]=0x0;}}else _0x18335b[_0xc45739(0x106)]===_0xc45739(0x11e)&&(_0x1de4f8['status']=_0xc45739(0x11e),_0x1de4f8[_0xc45739(0xe2)]=_0x18335b[_0xc45739(0xe2)]);const _0x525e79=await database_1[_0xc45739(0xb9)][_0xc45739(0x12a)][_0xc45739(0x110)]({'where':{'id':_0x1f54d8},'data':_0x1de4f8});console['log'](_0xc45739(0x103)+_0x525e79[_0xc45739(0x106)]);let _0x5838c3;if(_0x18335b[_0xc45739(0x106)]===_0xc45739(0x11e))_0x5838c3=_0x18335b[_0xc45739(0xe2)]||_0x5bd678[_0xc45739(0x12f)]||'Payment\x20failed';else _0x18335b[_0xc45739(0x106)]===_0xc45739(0x128)?_0x5838c3=_0x5bd678[_0xc45739(0x12f)]||_0xc45739(0xfb):_0x5838c3=_0x5bd678['friendly_message']||_0xc45739(0xf7);const _0x1123df={'success':_0x18335b[_0xc45739(0x106)]!==_0xc45739(0x11e),'status':_0x18335b[_0xc45739(0x106)],'message':_0x5838c3,'payment':{'id':_0x1f54d8,'status':_0x525e79[_0xc45739(0x106)],'gateway':_0xc45739(0xb4),'last4':_0x18335b['cardLast4']}};_0x18335b['redirectUrl']&&(_0x1123df[_0xc45739(0x120)]=_0x18335b[_0xc45739(0x11f)],_0x1123df[_0xc45739(0xf9)]=!![],console[_0xc45739(0xf6)](_0xc45739(0x116)+_0x18335b[_0xc45739(0x11f)])),_0x4ae642[_0xc45739(0xdf)](_0x1123df);}catch(_0x470bdf){console['error']('‚ùå\x20SquirrelPay\x20card\x20payment\x20error:',_0x470bdf),_0x200572(_0x470bdf);}},this[_0x4e4d70(0xd5)]=async(_0x2741ef,_0x4d234a,_0x2228ef)=>{const _0x9f7e85=_0x4e4d70;try{console[_0x9f7e85(0xf6)](_0x9f7e85(0xfa)),console[_0x9f7e85(0xf6)](_0x9f7e85(0xed),_0x2741ef[_0x9f7e85(0x11c)]),console[_0x9f7e85(0xf6)](_0x9f7e85(0xd7),_0x2741ef['body']),this[_0x9f7e85(0x130)][_0x9f7e85(0xf1)]({'headers':_0x2741ef['headers'],'body':_0x2741ef[_0x9f7e85(0x12c)],'timestamp':new Date()[_0x9f7e85(0x12b)]()});const _0x2a1c39=_0x2741ef['body'];if(!_0x2a1c39[_0x9f7e85(0xb8)]||!_0x2a1c39[_0x9f7e85(0x106)])return console[_0x9f7e85(0xc4)](_0x9f7e85(0xfc)),_0x4d234a[_0x9f7e85(0x106)](0x190)['json']({'success':![],'message':_0x9f7e85(0xee)});let _0x5a3a07;_0x2a1c39[_0x9f7e85(0xb8)]&&(_0x5a3a07=await database_1[_0x9f7e85(0xb9)][_0x9f7e85(0x12a)][_0x9f7e85(0xe8)]({'where':{'gatewayPaymentId':_0x2a1c39[_0x9f7e85(0xb8)],'gateway':'squirrelpay'}}));if(!_0x5a3a07)return console[_0x9f7e85(0xc4)]('‚ö†Ô∏è\x20Payment\x20not\x20found\x20for\x20SquirrelPay\x20webhook:'),console['warn'](_0x9f7e85(0x121)+_0x2a1c39['uid']),console[_0x9f7e85(0xc4)](_0x9f7e85(0x11b)+_0x2a1c39['description']),console[_0x9f7e85(0xc4)]('\x20\x20\x20Gateway:\x20squirrelpay'),console['warn'](_0x9f7e85(0xef)+_0x2a1c39['uid']),_0x4d234a[_0x9f7e85(0x106)](0x194)[_0x9f7e85(0xdf)]({'success':![],'message':'Payment\x20not\x20found'});console[_0x9f7e85(0xf6)](_0x9f7e85(0xca)+_0x5a3a07['id']),console[_0x9f7e85(0xf6)]('\x20\x20\x20Current\x20status\x20in\x20DB:\x20'+_0x5a3a07[_0x9f7e85(0x106)]),console[_0x9f7e85(0xf6)](_0x9f7e85(0xf4)+_0x5a3a07[_0x9f7e85(0xbf)]),console['log'](_0x9f7e85(0x12d)+_0x2a1c39[_0x9f7e85(0x106)]),console[_0x9f7e85(0xf6)](_0x9f7e85(0x105)+_0x2a1c39[_0x9f7e85(0xb8)]);let _0xe18900=null;const _0x581de1={};switch(_0x2a1c39[_0x9f7e85(0x106)]){case _0x9f7e85(0xd6):_0xe18900=_0x9f7e85(0xe5),console['log'](_0x9f7e85(0xd1));break;case _0x9f7e85(0xcb):_0xe18900='FAILED',_0x581de1[_0x9f7e85(0xe2)]=_0x2a1c39[_0x9f7e85(0x12f)]||_0x2a1c39[_0x9f7e85(0x10e)]||_0x9f7e85(0xf5),console[_0x9f7e85(0xf6)]('‚ùå\x20Payment\x20will\x20be\x20marked\x20as\x20FAILED:\x20'+_0x581de1['failureMessage']);break;case'incomplete':console[_0x9f7e85(0xf6)](_0x9f7e85(0x125));break;default:console[_0x9f7e85(0xc4)]('‚ö†Ô∏è\x20Unknown\x20SquirrelPay\x20status:\x20'+_0x2a1c39['status']);break;}if(_0xe18900&&_0xe18900!==_0x5a3a07[_0x9f7e85(0x106)])console[_0x9f7e85(0xf6)](_0x9f7e85(0x119)+_0x5a3a07[_0x9f7e85(0x106)]+_0x9f7e85(0x10a)+_0xe18900),await this[_0x9f7e85(0x109)][_0x9f7e85(0xc3)](_0x5a3a07['id'],_0xe18900,_0x581de1),console[_0x9f7e85(0xf6)]('‚úÖ\x20Payment\x20'+_0x5a3a07['id']+'\x20updated:\x20status='+_0xe18900+',\x20balance\x20updated,\x20amountUSDT\x20calculated');else _0xe18900&&console['log'](_0x9f7e85(0xb6)+_0x5a3a07['id']+'\x20already\x20has\x20status\x20'+_0xe18900+',\x20skipping\x20update');_0x4d234a[_0x9f7e85(0x106)](0xc8)[_0x9f7e85(0xdf)]({'success':!![],'message':_0x9f7e85(0x102)});}catch(_0x49bc4f){console[_0x9f7e85(0x11a)](_0x9f7e85(0xbd),_0x49bc4f),_0x2228ef(_0x49bc4f);}},this[_0x4e4d70(0xc8)]=async(_0x22664f,_0xffcc53,_0x2e07ef)=>{const _0x550247=_0x4e4d70;try{const {limit:_0x56f4b4}=_0x22664f[_0x550247(0x11d)],_0x2b3126=this[_0x550247(0x130)]['getWebhookLogs'](_0x56f4b4?parseInt(_0x56f4b4):0x32);_0xffcc53[_0x550247(0xdf)]({'success':!![],'result':{'logs':_0x2b3126,'count':_0x2b3126[_0x550247(0xc5)]}});}catch(_0x552338){_0x2e07ef(_0x552338);}},this[_0x4e4d70(0x130)]=new squirrelPayService_1[(_0x4e4d70(0xbe))]({'shopId':process[_0x4e4d70(0x12e)][_0x4e4d70(0xfe)]||'','secretKey':process[_0x4e4d70(0x12e)][_0x4e4d70(0xfd)]||'','baseUrl':process['env'][_0x4e4d70(0xd4)]||'https://gate.squirrel-pay.com','isTestMode':process[_0x4e4d70(0x12e)][_0x4e4d70(0xcd)]==='true'}),this[_0x4e4d70(0x10b)]=new currencyService_1[(_0x4e4d70(0xc1))](),this[_0x4e4d70(0x109)]=new webhookService_1['WebhookService']();}}exports[a16_0x315768(0xc0)]=SquirrelPayController;function a16_0x3232(_0x34ba83,_0x142509){_0x34ba83=_0x34ba83-0xb4;const _0x1114be=a16_0x1114();let _0x3232ee=_0x1114be[_0x34ba83];return _0x3232ee;}function a16_0x1114(){const _0x10bb02=['query','FAILED','redirectUrl','redirect_url','\x20\x20\x20UID:\x20','findUnique','paidAt','328ABtdIm','‚è≥\x20Payment\x20remains\x20PENDING\x20(incomplete)','\x20\x20\x20Payment\x20ID:\x20','https://app.trapay.uk','PENDING','17605cBZHax','payment','toISOString','body','\x20\x20\x20Webhook\x20status:\x20','env','friendly_message','squirrelPayService','squirrelpay','round','‚ÑπÔ∏è\x20Payment\x20','amountUSDT','uid','default','üí∞\x20Calculated\x20amountUSDT:\x20','padStart','getClientIP','‚ùå\x20SquirrelPay\x20webhook\x20error:','SquirrelPayService','gatewayPaymentId','SquirrelPayController','CurrencyService','currency','updatePaymentStatus','warn','length','not\x20provided','defineProperty','getWebhookLogs','üí∞\x20Gateway\x20','üîç\x20Processing\x20SquirrelPay\x20webhook\x20for\x20payment\x20','failed','/api/webhooks/squirrel-pay','SQUIRREL_PAY_TEST_MODE','gatewayOrderId','Payment\x20is\x20not\x20in\x20pending\x20status','amountAfterGatewayCommissionUSDT','‚úÖ\x20Payment\x20will\x20be\x20marked\x20as\x20PAID','3016332qPLisM','toUpperCase','SQUIRREL_PAY_BASE_URL','handleWebhook','successful','Body:','toString','FRONTEND_URL','\x20USDT','processCardPayment','slice','getGatewayCommission','../config/database','json','gateway','üêøÔ∏è\x20SquirrelPay:\x20Processing\x20card\x20payment\x20for\x20payment\x20','failureMessage','__importDefault','API_BASE_URL','PAID','amount','../services/currencyService','findFirst','cardLast4','https://api.trapay.uk','Invalid\x20billing\x20country\x20format.\x20Must\x20be\x20ISO\x203166-1\x20Alpha-2\x20(e.g.,\x20US,\x20GB,\x20DE)','2174847HAGkWa','Headers:','Missing\x20required\x20fields\x20in\x20webhook','\x20\x20\x20Expected:\x20gatewayPaymentId\x20=\x20','455098KKvJym','logWebhook','Missing\x20required\x20card\x20or\x20customer\x20information','../utils/ipHelper','\x20\x20\x20Current\x20gatewayPaymentId\x20in\x20DB:\x20','Payment\x20failed','log','Payment\x20processed\x20successfully','Payment\x20not\x20found','requires_action','üêøÔ∏è\x20SquirrelPay\x20webhook\x20received','Payment\x20is\x20being\x20processed','‚ö†Ô∏è\x20SquirrelPay\x20webhook\x20missing\x20required\x20fields','SQUIRREL_PAY_SECRET_KEY','SQUIRREL_PAY_SHOP_ID','birth_date','shopId','254014yfivfv','Webhook\x20processed\x20successfully','‚úÖ\x20SquirrelPay\x20payment\x20updated:\x20','params','\x20\x20\x20Webhook\x20UID:\x20','status','\x20\x20\x20Customer:\x20','1276OXXwfe','webhookService','\x20to\x20','currencyService','5105PtLjrj','2646522pcuIpb','message','gatewayCommissionRate','update','__esModule','replace','üìù\x20SquirrelPay\x20payment\x20details:','convertToUSDT','getPaymentStatus','üîÑ\x203D\x20Secure\x20redirect\x20required:\x20','\x20\x20\x20Amount:\x20','has','üîÑ\x20Updating\x20payment\x20status\x20from\x20','error','\x20\x20\x20Description:\x20','headers'];a16_0x1114=function(){return _0x10bb02;};return a16_0x1114();}