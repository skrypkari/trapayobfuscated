'use strict';const a16_0x2dde03=a16_0x5703;(function(_0x3e567c,_0x51223e){const _0x3d340a=a16_0x5703,_0x10061a=_0x3e567c();while(!![]){try{const _0x4d077d=parseInt(_0x3d340a(0x96))/0x1*(-parseInt(_0x3d340a(0xa6))/0x2)+-parseInt(_0x3d340a(0x9e))/0x3*(-parseInt(_0x3d340a(0x98))/0x4)+parseInt(_0x3d340a(0x8c))/0x5+-parseInt(_0x3d340a(0xb2))/0x6*(parseInt(_0x3d340a(0xab))/0x7)+-parseInt(_0x3d340a(0x8e))/0x8+-parseInt(_0x3d340a(0xba))/0x9*(-parseInt(_0x3d340a(0xb7))/0xa)+parseInt(_0x3d340a(0xd0))/0xb*(parseInt(_0x3d340a(0xad))/0xc);if(_0x4d077d===_0x51223e)break;else _0x10061a['push'](_0x10061a['shift']());}catch(_0x271dcc){_0x10061a['push'](_0x10061a['shift']());}}}(a16_0x2c5f,0xd1400));function a16_0x2c5f(){const _0x148550=['api','message','https://app.trapay.uk','getPaymentFingerprint','../services/paymentService','prePaymentService','params','146poMJJq','now','payment','/payment/','defineProperty','7pVKbuK','initiateGatewayPayment','493548oeIrjI','../services/prePaymentService','pendingUrl','https://app.trapay.uk/payment/success','__importDefault','1853070LNGLRj','failUrl','Failed\x20to\x20confirm\x20pre-payment','Shop\x20not\x20found','network','68790fNRRIj','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','PaymentService','675rjxIWx','log','customerName','customerEmail','shop','generateGatewayOrderId','âœ…\x20Payment\x20created:\x20','update','riskLevel','random','âœ…\x20Payment\x20URL:\x20','Get\x20pre-payment\x20error:','body','findUnique','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','externalPaymentUrl','default','https://app.trapay.uk/payment/pending','prePaymentController','amount','PrePaymentController','paymentService','22yPmLSS','Confirm\x20pre-payment\x20error:','successUrl','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','gateway','getPrePaymentByCode','shopId','4335340WFNQex','__esModule','5284800EwKBMR','Failed\x20to\x20save\x20fingerprint:','status','json','error','create','getPrePayment','currency','7528ezceWz','PENDING','20468rYXfpv','deliverabilityStatus','prePayment','confirmPrePayment','prePaymentId','floor','534qjHupl'];a16_0x2c5f=function(){return _0x148550;};return a16_0x2c5f();}var __importDefault=this&&this[a16_0x2dde03(0xb1)]||function(_0x28b915){const _0x4f2aeb=a16_0x2dde03;return _0x28b915&&_0x28b915[_0x4f2aeb(0x8d)]?_0x28b915:{'default':_0x28b915};};Object[a16_0x2dde03(0xaa)](exports,a16_0x2dde03(0x8d),{'value':!![]}),exports[a16_0x2dde03(0xcc)]=exports[a16_0x2dde03(0xce)]=void 0x0;function a16_0x5703(_0x621996,_0x21d44c){_0x621996=_0x621996-0x86;const _0x2c5fce=a16_0x2c5f();let _0x570359=_0x2c5fce[_0x621996];return _0x570359;}const database_1=__importDefault(require('../config/database')),prePaymentService_1=require(a16_0x2dde03(0xae)),paymentService_1=require(a16_0x2dde03(0xa3));class PrePaymentController{constructor(){const _0x5b3981=a16_0x2dde03;this[_0x5b3981(0xcf)]=new paymentService_1[(_0x5b3981(0xb9))]();}async[a16_0x2dde03(0x94)](_0x146226,_0x127996){const _0x5d98de=a16_0x2dde03;try{const {code:_0x1cc9e5}=_0x146226[_0x5d98de(0xa5)],_0x55e1e0=await prePaymentService_1[_0x5d98de(0xa4)][_0x5d98de(0x8a)](_0x1cc9e5);_0x127996[_0x5d98de(0x91)]({'success':!![],'result':_0x55e1e0});}catch(_0xffc15b){console['error'](_0x5d98de(0xc5),_0xffc15b),_0x127996[_0x5d98de(0x90)](0x190)[_0x5d98de(0x91)]({'success':![],'error':_0xffc15b['message']||'Failed\x20to\x20fetch\x20pre-payment'});}}async[a16_0x2dde03(0x9b)](_0x3a51dc,_0x42f5b9){const _0x320b01=a16_0x2dde03;try{const {code:_0x41ce3b}=_0x3a51dc['params'],{customerEmail:_0x5800da,customerName:_0x29299b,customerIp:_0x40db3f,customerUa:_0x597467,customerCountry:_0x200916,requestId:_0x26307c,emailValidation:_0x438e92}=_0x3a51dc[_0x320b01(0xc6)];if(!_0x5800da||!_0x29299b)return _0x42f5b9[_0x320b01(0x90)](0x190)[_0x320b01(0x91)]({'success':![],'error':'Customer\x20email\x20and\x20name\x20are\x20required'});const _0x482b98=await prePaymentService_1['prePaymentService'][_0x320b01(0x9b)](_0x41ce3b,{'customerEmail':_0x5800da,'customerName':_0x29299b,'customerIp':_0x40db3f,'customerUa':_0x597467,'customerCountry':_0x200916}),_0x41b6f5=await database_1[_0x320b01(0xca)][_0x320b01(0xbe)][_0x320b01(0xc7)]({'where':{'id':_0x482b98[_0x320b01(0x8b)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0x41b6f5)throw new Error(_0x320b01(0xb5));const _0x672f52=this[_0x320b01(0xbf)]();console[_0x320b01(0xbb)](_0x320b01(0xc8)+_0x672f52);const _0xef1d1e=_0x320b01(0x97),_0x496a47=new Date(Date[_0x320b01(0xa7)]()+0x1e*0x3c*0x3e8),_0x171605=await database_1[_0x320b01(0xca)]['payment'][_0x320b01(0x93)]({'data':{'shopId':_0x482b98[_0x320b01(0x8b)],'gateway':_0x482b98[_0x320b01(0x89)],'amount':Number(_0x482b98[_0x320b01(0xcd)]),'currency':_0x482b98[_0x320b01(0x95)],'sourceCurrency':_0x482b98['sourceCurrency']||undefined,'network':_0x482b98[_0x320b01(0xb6)]||undefined,'orderId':_0x482b98['orderId']||'','gatewayOrderId':_0x672f52,'customerEmail':_0x482b98[_0x320b01(0xbd)],'customerName':_0x482b98[_0x320b01(0xbc)],'customerCountry':_0x200916||undefined,'customerIp':_0x40db3f||undefined,'customerUa':_0x597467||undefined,'successUrl':_0x482b98[_0x320b01(0x87)]||_0x320b01(0xb0),'failUrl':_0x482b98[_0x320b01(0xb3)]||'https://app.trapay.uk/payment/fail','pendingUrl':_0x482b98[_0x320b01(0xaf)]||_0x320b01(0xcb),'status':_0xef1d1e,'expiresAt':_0x496a47,'createdVia':_0x320b01(0x9f)}});console[_0x320b01(0xbb)](_0x320b01(0xc0)+_0x171605['id']),await database_1[_0x320b01(0xca)][_0x320b01(0x9a)][_0x320b01(0xc1)]({'where':{'id':_0x482b98[_0x320b01(0x9c)]},'data':{'paymentId':_0x171605['id']}});_0x438e92&&await database_1[_0x320b01(0xca)][_0x320b01(0xa8)][_0x320b01(0xc1)]({'where':{'id':_0x171605['id']},'data':{'emailDeliverabilityStatus':_0x438e92[_0x320b01(0x99)],'emailIsDisposable':_0x438e92['isDisposable'],'emailRiskLevel':_0x438e92[_0x320b01(0xc2)]}});if(_0x26307c)try{await this[_0x320b01(0xcf)][_0x320b01(0xa2)](_0x171605['id'],_0x26307c),console['log'](_0x320b01(0xb8)+_0x171605['id']);}catch(_0x7678aa){console[_0x320b01(0x92)](_0x320b01(0x8f),_0x7678aa);}console[_0x320b01(0xbb)](_0x320b01(0x88)+_0x482b98[_0x320b01(0x89)]+'...');const _0x220f60=await this[_0x320b01(0xcf)][_0x320b01(0xac)](_0x171605['id']),_0x4a9378=process.env.FRONTEND_URL||_0x320b01(0xa1),_0x2b5ec0=_0x220f60[_0x320b01(0xc9)]||_0x4a9378+_0x320b01(0xa9)+_0x171605['id'];console[_0x320b01(0xbb)](_0x320b01(0xc4)+_0x2b5ec0),_0x42f5b9[_0x320b01(0x91)]({'success':!![],'result':{'paymentId':_0x171605['id'],'paymentUrl':_0x2b5ec0}});}catch(_0x58d894){console[_0x320b01(0x92)](_0x320b01(0x86),_0x58d894),_0x42f5b9['status'](0x190)[_0x320b01(0x91)]({'success':![],'error':_0x58d894[_0x320b01(0xa0)]||_0x320b01(0xb4)});}}[a16_0x2dde03(0xbf)](){const _0x506fca=a16_0x2dde03,_0x315088=Math[_0x506fca(0x9d)](0x989680+Math['random']()*0x55d4a80),_0x2260d7=Math[_0x506fca(0x9d)](0x989680+Math[_0x506fca(0xc3)]()*0x55d4a80);return _0x315088+'-'+_0x2260d7;}}exports[a16_0x2dde03(0xce)]=PrePaymentController,exports[a16_0x2dde03(0xcc)]=new PrePaymentController();