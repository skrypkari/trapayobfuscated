'use strict';const a16_0x569140=a16_0x493a;(function(_0x46b44e,_0x5cb1d1){const _0x3df547=a16_0x493a,_0x1e4733=_0x46b44e();while(!![]){try{const _0x25aba8=-parseInt(_0x3df547(0x1e6))/0x1*(-parseInt(_0x3df547(0x218))/0x2)+-parseInt(_0x3df547(0x212))/0x3*(-parseInt(_0x3df547(0x215))/0x4)+-parseInt(_0x3df547(0x1ff))/0x5+-parseInt(_0x3df547(0x1da))/0x6*(parseInt(_0x3df547(0x217))/0x7)+parseInt(_0x3df547(0x1dd))/0x8+-parseInt(_0x3df547(0x1dc))/0x9*(parseInt(_0x3df547(0x1e7))/0xa)+parseInt(_0x3df547(0x220))/0xb*(parseInt(_0x3df547(0x1fe))/0xc);if(_0x25aba8===_0x5cb1d1)break;else _0x1e4733['push'](_0x1e4733['shift']());}catch(_0x5b6c7e){_0x1e4733['push'](_0x1e4733['shift']());}}}(a16_0x278d,0xb712c));function a16_0x278d(){const _0x552b4f=['rapyd','default','orderId','json','Customer\x20email\x20and\x20name\x20are\x20required','status','48UlUOGu','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','964899sqVcTK','5946104NuIhjk','../config/database','paymentService','cointopay2','squirrel-pay','currency','../services/paymentService','âœ…\x20Payment\x20URL:\x20','PaymentService','3qKWYFh','30ZVlaBz','floor','Failed\x20to\x20fetch\x20pre-payment','prePaymentService','squirrelpay','n/a','error','instaxchange','ampay','visa/mastercard','update','https://app.trapay.uk/payment/success','IBAN','/payment/','Shop\x20not\x20found','Failed\x20to\x20confirm\x20pre-payment','PrePaymentController','https://app.trapay.uk/payment/fail','shopId','gateway','noda','payment','params','16248hOWXtH','4203755LZTiys','prePaymentController','Cryptocurrency','customerEmail','now','log','pendingUrl','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','https://app.trapay.uk','isDisposable','getPrePayment','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','maxpara','create','confirmPrePayment','ampay_try','../services/prePaymentService','...','__esModule','65652xfScLN','getPaymentFingerprint','api','184FIHnlo','amount','802886PjJrlp','531282hCOzJE','PENDING','findUnique','deliverabilityStatus','ðŸ“Š\x20Payment\x20will\x20be\x20created\x20with\x20status:\x20','cointopay','getPrePaymentByCode','network','2299zJDuHM','Confirm\x20pre-payment\x20error:','random','message','riskLevel'];a16_0x278d=function(){return _0x552b4f;};return a16_0x278d();}var __importDefault=this&&this['__importDefault']||function(_0x18a0d9){const _0xa9a486=a16_0x493a;return _0x18a0d9&&_0x18a0d9[_0xa9a486(0x211)]?_0x18a0d9:{'default':_0x18a0d9};};Object['defineProperty'](exports,a16_0x569140(0x211),{'value':!![]}),exports[a16_0x569140(0x200)]=exports[a16_0x569140(0x1f7)]=void 0x0;const database_1=__importDefault(require(a16_0x569140(0x1de))),prePaymentService_1=require(a16_0x569140(0x20f)),paymentService_1=require(a16_0x569140(0x1e3));function a16_0x493a(_0x492fd6,_0x447423){_0x492fd6=_0x492fd6-0x1d4;const _0x278dbd=a16_0x278d();let _0x493ad3=_0x278dbd[_0x492fd6];return _0x493ad3;}class PrePaymentController{constructor(){const _0x24e5ea=a16_0x569140;this[_0x24e5ea(0x1df)]=new paymentService_1[(_0x24e5ea(0x1e5))]();}async[a16_0x569140(0x209)](_0x3bec63,_0x355f9d){const _0x2e10f2=a16_0x569140;try{const {code:_0x24101e}=_0x3bec63['params'],_0x4262b5=await prePaymentService_1[_0x2e10f2(0x1ea)][_0x2e10f2(0x21e)](_0x24101e);_0x355f9d[_0x2e10f2(0x1d7)]({'success':!![],'result':_0x4262b5});}catch(_0x45d4bc){console[_0x2e10f2(0x1ed)]('Get\x20pre-payment\x20error:',_0x45d4bc),_0x355f9d['status'](0x190)['json']({'success':![],'error':_0x45d4bc[_0x2e10f2(0x223)]||_0x2e10f2(0x1e9)});}}async[a16_0x569140(0x20d)](_0x32e192,_0x43a64c){const _0x5d73fe=a16_0x569140;try{const {code:_0x991fc8}=_0x32e192[_0x5d73fe(0x1fd)],{customerEmail:_0x4431d7,customerName:_0x5608e5,customerIp:_0x10d6ea,customerUa:_0x38d154,customerCountry:_0x3fd544,requestId:_0x3c76be,emailValidation:_0x1ab592}=_0x32e192['body'];if(!_0x4431d7||!_0x5608e5)return _0x43a64c[_0x5d73fe(0x1d9)](0x190)[_0x5d73fe(0x1d7)]({'success':![],'error':_0x5d73fe(0x1d8)});const _0x4c6a14=await prePaymentService_1[_0x5d73fe(0x1ea)]['confirmPrePayment'](_0x991fc8,{'customerEmail':_0x4431d7,'customerName':_0x5608e5,'customerIp':_0x10d6ea,'customerUa':_0x38d154,'customerCountry':_0x3fd544}),_0x51d66b=await database_1['default']['shop'][_0x5d73fe(0x21a)]({'where':{'id':_0x4c6a14[_0x5d73fe(0x1f9)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0x51d66b)throw new Error(_0x5d73fe(0x1f5));const _0x134ba9=this['generateGatewayOrderId']();console['log'](_0x5d73fe(0x206)+_0x134ba9);const _0x2d4ed3=_0x5d73fe(0x219),_0x1cef7d=new Date(Date[_0x5d73fe(0x203)]()+0x1e*0x3c*0x3e8);console[_0x5d73fe(0x204)](_0x5d73fe(0x21c)+_0x2d4ed3);const _0x487be8=_0x1581d0=>{const _0x2fec6f=_0x5d73fe;if(_0x1581d0===_0x2fec6f(0x1d4)||_0x1581d0===_0x2fec6f(0x1ee)||_0x1581d0===_0x2fec6f(0x1f0)||_0x1581d0===_0x2fec6f(0x1eb)||_0x1581d0===_0x2fec6f(0x1e1))return'Bank\x20Card';else{if(_0x1581d0===_0x2fec6f(0x1fb)||_0x1581d0===_0x2fec6f(0x21d)||_0x1581d0===_0x2fec6f(0x1e0)||_0x1581d0==='myxspend')return'Open\x20Banking';else{if(_0x1581d0===_0x2fec6f(0x20b)||_0x1581d0===_0x2fec6f(0x1ef)||_0x1581d0===_0x2fec6f(0x20e))return _0x2fec6f(0x1f3);else{if(_0x1581d0==='oxapay')return _0x2fec6f(0x201);}}}return _0x2fec6f(0x1ec);},_0x43ab47=_0x487be8(_0x4c6a14[_0x5d73fe(0x1fa)]),_0x50ad34=await database_1['default'][_0x5d73fe(0x1fc)][_0x5d73fe(0x20c)]({'data':{'shopId':_0x4c6a14[_0x5d73fe(0x1f9)],'gateway':_0x4c6a14['gateway'],'amount':Number(_0x4c6a14[_0x5d73fe(0x216)]),'currency':_0x4c6a14[_0x5d73fe(0x1e2)],'sourceCurrency':_0x4c6a14['sourceCurrency']||undefined,'network':_0x4c6a14[_0x5d73fe(0x21f)]||undefined,'orderId':_0x4c6a14[_0x5d73fe(0x1d6)]||'','gatewayOrderId':_0x134ba9,'customerEmail':_0x4c6a14[_0x5d73fe(0x202)],'customerName':_0x4c6a14['customerName'],'customerCountry':_0x3fd544||undefined,'customerIp':_0x10d6ea||undefined,'customerUa':_0x38d154||undefined,'successUrl':_0x4c6a14['successUrl']||_0x5d73fe(0x1f2),'failUrl':_0x4c6a14['failUrl']||_0x5d73fe(0x1f8),'pendingUrl':_0x4c6a14[_0x5d73fe(0x205)]||'https://app.trapay.uk/payment/pending','status':_0x2d4ed3,'expiresAt':_0x1cef7d,'createdVia':_0x5d73fe(0x214),'paymentMethod':_0x43ab47}});console['log']('âœ…\x20Payment\x20created:\x20'+_0x50ad34['id']),await database_1[_0x5d73fe(0x1d5)]['prePayment'][_0x5d73fe(0x1f1)]({'where':{'id':_0x4c6a14['prePaymentId']},'data':{'paymentId':_0x50ad34['id']}});_0x1ab592&&await database_1[_0x5d73fe(0x1d5)]['payment'][_0x5d73fe(0x1f1)]({'where':{'id':_0x50ad34['id']},'data':{'emailDeliverabilityStatus':_0x1ab592[_0x5d73fe(0x21b)],'emailIsDisposable':_0x1ab592[_0x5d73fe(0x208)],'emailRiskLevel':_0x1ab592[_0x5d73fe(0x224)]}});if(_0x3c76be)try{await this[_0x5d73fe(0x1df)][_0x5d73fe(0x213)](_0x50ad34['id'],_0x3c76be),console['log'](_0x5d73fe(0x1db)+_0x50ad34['id']);}catch(_0x501f32){console['error']('Failed\x20to\x20save\x20fingerprint:',_0x501f32);}console[_0x5d73fe(0x204)](_0x5d73fe(0x20a)+_0x4c6a14['gateway']+_0x5d73fe(0x210));const _0xd0ebcc=await this[_0x5d73fe(0x1df)]['initiateGatewayPayment'](_0x50ad34['id']),_0x500844=process.env.FRONTEND_URL||_0x5d73fe(0x207),_0x44734c=_0xd0ebcc['externalPaymentUrl']||_0x500844+_0x5d73fe(0x1f4)+_0x50ad34['id'];console[_0x5d73fe(0x204)](_0x5d73fe(0x1e4)+_0x44734c),_0x43a64c[_0x5d73fe(0x1d7)]({'success':!![],'result':{'paymentId':_0x50ad34['id'],'paymentUrl':_0x44734c}});}catch(_0x435ed5){console[_0x5d73fe(0x1ed)](_0x5d73fe(0x221),_0x435ed5),_0x43a64c[_0x5d73fe(0x1d9)](0x190)[_0x5d73fe(0x1d7)]({'success':![],'error':_0x435ed5[_0x5d73fe(0x223)]||_0x5d73fe(0x1f6)});}}['generateGatewayOrderId'](){const _0x38a794=a16_0x569140,_0x24a365=Math['floor'](0x989680+Math['random']()*0x55d4a80),_0x17833f=Math[_0x38a794(0x1e8)](0x989680+Math[_0x38a794(0x222)]()*0x55d4a80);return _0x24a365+'-'+_0x17833f;}}exports[a16_0x569140(0x1f7)]=PrePaymentController,exports[a16_0x569140(0x200)]=new PrePaymentController();