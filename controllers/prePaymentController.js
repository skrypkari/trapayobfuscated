'use strict';function a16_0x2374(){const _0x1309e8=['2060gMFxek','338358RpliYH','log','1731vhHvWa','27158175qjHrsM','confirmPrePayment','shop','prePaymentService','PaymentService','api','random','/payment/','https://app.trapay.uk','Failed\x20to\x20save\x20fingerprint:','default','getPaymentFingerprint','isDisposable','https://app.trapay.uk/payment/pending','body','riskLevel','initiateGatewayPayment','../services/paymentService','customerEmail','Failed\x20to\x20confirm\x20pre-payment','deliverabilityStatus','âœ…\x20Payment\x20created:\x20','10asgIPu','__esModule','PrePaymentController','status','âœ…\x20Payment\x20URL:\x20','gateway','Shop\x20not\x20found','sourceCurrency','customerName','generateGatewayOrderId','currency','payment','getPrePaymentByCode','getPrePayment','shopId','5963556sPTejl','findUnique','paymentService','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','prePaymentController','amount','orderId','../config/database','Get\x20pre-payment\x20error:','externalPaymentUrl','8DXbTns','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','https://app.trapay.uk/payment/fail','update','prePayment','error','json','Confirm\x20pre-payment\x20error:','../services/prePaymentService','8950438swZtSa','PENDING','create','params','prePaymentId','5fnASRK','1668551pWvjck','network','...','message','15592779kvlBTw'];a16_0x2374=function(){return _0x1309e8;};return a16_0x2374();}const a16_0x2be679=a16_0x3287;(function(_0x366739,_0x335f99){const _0xb89499=a16_0x3287,_0x4ab6ff=_0x366739();while(!![]){try{const _0x5c637b=-parseInt(_0xb89499(0xe1))/0x1+-parseInt(_0xb89499(0x9f))/0x2*(-parseInt(_0xb89499(0xa2))/0x3)+parseInt(_0xb89499(0xc8))/0x4+parseInt(_0xb89499(0xe0))/0x5*(-parseInt(_0xb89499(0xa0))/0x6)+-parseInt(_0xb89499(0xdb))/0x7*(-parseInt(_0xb89499(0xd2))/0x8)+parseInt(_0xb89499(0x9e))/0x9*(parseInt(_0xb89499(0xb9))/0xa)+-parseInt(_0xb89499(0xa3))/0xb;if(_0x5c637b===_0x335f99)break;else _0x4ab6ff['push'](_0x4ab6ff['shift']());}catch(_0x58fa52){_0x4ab6ff['push'](_0x4ab6ff['shift']());}}}(a16_0x2374,0xdc55f));var __importDefault=this&&this['__importDefault']||function(_0x493d3d){const _0x147b58=a16_0x3287;return _0x493d3d&&_0x493d3d[_0x147b58(0xba)]?_0x493d3d:{'default':_0x493d3d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a16_0x2be679(0xcc)]=exports[a16_0x2be679(0xbb)]=void 0x0;const database_1=__importDefault(require(a16_0x2be679(0xcf))),prePaymentService_1=require(a16_0x2be679(0xda)),paymentService_1=require(a16_0x2be679(0xb4));class PrePaymentController{constructor(){const _0x43efb4=a16_0x2be679;this[_0x43efb4(0xca)]=new paymentService_1[(_0x43efb4(0xa7))]();}async[a16_0x2be679(0xc6)](_0x39d487,_0x4e8939){const _0x4c4869=a16_0x2be679;try{const {code:_0x187d7f}=_0x39d487[_0x4c4869(0xde)],_0x40b6b5=await prePaymentService_1[_0x4c4869(0xa6)][_0x4c4869(0xc5)](_0x187d7f);_0x4e8939[_0x4c4869(0xd8)]({'success':!![],'result':_0x40b6b5});}catch(_0x12cc5c){console[_0x4c4869(0xd7)](_0x4c4869(0xd0),_0x12cc5c),_0x4e8939['status'](0x190)[_0x4c4869(0xd8)]({'success':![],'error':_0x12cc5c[_0x4c4869(0xe4)]||'Failed\x20to\x20fetch\x20pre-payment'});}}async[a16_0x2be679(0xa4)](_0x5075f5,_0x41a544){const _0x3f1746=a16_0x2be679;try{const {code:_0x2bd10e}=_0x5075f5[_0x3f1746(0xde)],{customerEmail:_0x3b5439,customerName:_0x2b1b00,customerIp:_0x366c35,customerUa:_0x17ef69,customerCountry:_0x1111e3,requestId:_0x3e2a1c,emailValidation:_0x1ab718}=_0x5075f5[_0x3f1746(0xb1)];if(!_0x3b5439||!_0x2b1b00)return _0x41a544[_0x3f1746(0xbc)](0x190)[_0x3f1746(0xd8)]({'success':![],'error':'Customer\x20email\x20and\x20name\x20are\x20required'});const _0x3460b8=await prePaymentService_1[_0x3f1746(0xa6)][_0x3f1746(0xa4)](_0x2bd10e,{'customerEmail':_0x3b5439,'customerName':_0x2b1b00,'customerIp':_0x366c35,'customerUa':_0x17ef69,'customerCountry':_0x1111e3}),_0x287cd8=await database_1[_0x3f1746(0xad)][_0x3f1746(0xa5)][_0x3f1746(0xc9)]({'where':{'id':_0x3460b8['shopId']},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0x287cd8)throw new Error(_0x3f1746(0xbf));const _0x1bcd4c=this['generateGatewayOrderId']();console[_0x3f1746(0xa1)](_0x3f1746(0xd3)+_0x1bcd4c);const _0x16a956=_0x3f1746(0xdc),_0x26248e=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x2fbda6=await database_1[_0x3f1746(0xad)][_0x3f1746(0xc4)][_0x3f1746(0xdd)]({'data':{'shopId':_0x3460b8[_0x3f1746(0xc7)],'gateway':_0x3460b8[_0x3f1746(0xbe)],'amount':Number(_0x3460b8[_0x3f1746(0xcd)]),'currency':_0x3460b8[_0x3f1746(0xc3)],'sourceCurrency':_0x3460b8[_0x3f1746(0xc0)]||undefined,'network':_0x3460b8[_0x3f1746(0xe2)]||undefined,'orderId':_0x3460b8[_0x3f1746(0xce)]||'','gatewayOrderId':_0x1bcd4c,'customerEmail':_0x3460b8[_0x3f1746(0xb5)],'customerName':_0x3460b8[_0x3f1746(0xc1)],'customerCountry':_0x1111e3||undefined,'customerIp':_0x366c35||undefined,'customerUa':_0x17ef69||undefined,'successUrl':_0x3460b8['successUrl']||'https://app.trapay.uk/payment/success','failUrl':_0x3460b8['failUrl']||_0x3f1746(0xd4),'pendingUrl':_0x3460b8['pendingUrl']||_0x3f1746(0xb0),'status':_0x16a956,'expiresAt':_0x26248e,'createdVia':_0x3f1746(0xa8)}});console[_0x3f1746(0xa1)](_0x3f1746(0xb8)+_0x2fbda6['id']),await database_1['default'][_0x3f1746(0xd6)]['update']({'where':{'id':_0x3460b8[_0x3f1746(0xdf)]},'data':{'paymentId':_0x2fbda6['id']}});_0x1ab718&&await database_1[_0x3f1746(0xad)][_0x3f1746(0xc4)][_0x3f1746(0xd5)]({'where':{'id':_0x2fbda6['id']},'data':{'emailDeliverabilityStatus':_0x1ab718[_0x3f1746(0xb7)],'emailIsDisposable':_0x1ab718[_0x3f1746(0xaf)],'emailRiskLevel':_0x1ab718[_0x3f1746(0xb2)]}});if(_0x3e2a1c)try{await this[_0x3f1746(0xca)][_0x3f1746(0xae)](_0x2fbda6['id'],_0x3e2a1c),console[_0x3f1746(0xa1)]('âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20'+_0x2fbda6['id']);}catch(_0x1cfb7a){console[_0x3f1746(0xd7)](_0x3f1746(0xac),_0x1cfb7a);}console['log'](_0x3f1746(0xcb)+_0x3460b8[_0x3f1746(0xbe)]+_0x3f1746(0xe3));const _0x25cacd=await this['paymentService'][_0x3f1746(0xb3)](_0x2fbda6['id']),_0x2aa4a9=process.env.FRONTEND_URL||_0x3f1746(0xab),_0x144503=_0x25cacd[_0x3f1746(0xd1)]||_0x2aa4a9+_0x3f1746(0xaa)+_0x2fbda6['id'];console[_0x3f1746(0xa1)](_0x3f1746(0xbd)+_0x144503),_0x41a544['json']({'success':!![],'result':{'paymentId':_0x2fbda6['id'],'paymentUrl':_0x144503}});}catch(_0x3647e3){console['error'](_0x3f1746(0xd9),_0x3647e3),_0x41a544[_0x3f1746(0xbc)](0x190)[_0x3f1746(0xd8)]({'success':![],'error':_0x3647e3[_0x3f1746(0xe4)]||_0x3f1746(0xb6)});}}[a16_0x2be679(0xc2)](){const _0x50461c=a16_0x2be679,_0x4c196e=Math['floor'](0x989680+Math[_0x50461c(0xa9)]()*0x55d4a80),_0x31493b=Math['floor'](0x989680+Math[_0x50461c(0xa9)]()*0x55d4a80);return _0x4c196e+'-'+_0x31493b;}}function a16_0x3287(_0x477834,_0x5b4bff){_0x477834=_0x477834-0x9e;const _0x237474=a16_0x2374();let _0x3287e3=_0x237474[_0x477834];return _0x3287e3;}exports[a16_0x2be679(0xbb)]=PrePaymentController,exports['prePaymentController']=new PrePaymentController();