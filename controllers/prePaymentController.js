'use strict';const a16_0x4c3417=a16_0x3e3f;(function(_0x5343fb,_0x353233){const _0x111371=a16_0x3e3f,_0x28ec85=_0x5343fb();while(!![]){try{const _0x387897=parseInt(_0x111371(0x153))/0x1*(-parseInt(_0x111371(0x171))/0x2)+parseInt(_0x111371(0x15e))/0x3+parseInt(_0x111371(0x173))/0x4+parseInt(_0x111371(0x177))/0x5+-parseInt(_0x111371(0x172))/0x6+-parseInt(_0x111371(0x14c))/0x7+parseInt(_0x111371(0x15b))/0x8;if(_0x387897===_0x353233)break;else _0x28ec85['push'](_0x28ec85['shift']());}catch(_0x56b53a){_0x28ec85['push'](_0x28ec85['shift']());}}}(a16_0x4150,0x20cb5));var __importDefault=this&&this[a16_0x4c3417(0x17f)]||function(_0x3ed2f1){return _0x3ed2f1&&_0x3ed2f1['__esModule']?_0x3ed2f1:{'default':_0x3ed2f1};};Object[a16_0x4c3417(0x16a)](exports,'__esModule',{'value':!![]}),exports[a16_0x4c3417(0x155)]=exports[a16_0x4c3417(0x186)]=void 0x0;function a16_0x4150(){const _0x5b1a1f=['âœ…\x20Payment\x20created:\x20','https://app.trapay.uk/payment/success','body','PENDING','https://app.trapay.uk','getPrePaymentByCode','create','Failed\x20to\x20confirm\x20pre-payment','getPrePayment','defineProperty','successUrl','/payment/','api','now','../services/prePaymentService','Failed\x20to\x20save\x20fingerprint:','1278EHbYrR','685248kuqGVN','464628mhHrBQ','Failed\x20to\x20fetch\x20pre-payment','prePaymentService','confirmPrePayment','432240eMOYHX','../config/database','https://app.trapay.uk/payment/pending','isDisposable','pendingUrl','default','paymentService','shop','__importDefault','...','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','floor','https://app.trapay.uk/payment/fail','json','riskLevel','PrePaymentController','Confirm\x20pre-payment\x20error:','params','log','getPaymentFingerprint','generateGatewayOrderId','PaymentService','failUrl','message','customerEmail','1125222kJTmff','sourceCurrency','prePayment','amount','payment','../services/paymentService','shopId','67DjITkQ','network','prePaymentController','âœ…\x20Payment\x20URL:\x20','orderId','Shop\x20not\x20found','error','status','239256qpGPel','initiateGatewayPayment','update','658740GlZUuE','customerName','random'];a16_0x4150=function(){return _0x5b1a1f;};return a16_0x4150();}const database_1=__importDefault(require(a16_0x4c3417(0x178))),prePaymentService_1=require(a16_0x4c3417(0x16f)),paymentService_1=require(a16_0x4c3417(0x151));class PrePaymentController{constructor(){const _0x2c5d83=a16_0x4c3417;this[_0x2c5d83(0x17d)]=new paymentService_1[(_0x2c5d83(0x148))]();}async[a16_0x4c3417(0x169)](_0x19c9ca,_0x4aaecb){const _0x17ff97=a16_0x4c3417;try{const {code:_0x4b6e42}=_0x19c9ca[_0x17ff97(0x144)],_0xe9bc5a=await prePaymentService_1[_0x17ff97(0x175)][_0x17ff97(0x166)](_0x4b6e42);_0x4aaecb[_0x17ff97(0x184)]({'success':!![],'result':_0xe9bc5a});}catch(_0x4e1ec2){console['error']('Get\x20pre-payment\x20error:',_0x4e1ec2),_0x4aaecb[_0x17ff97(0x15a)](0x190)[_0x17ff97(0x184)]({'success':![],'error':_0x4e1ec2[_0x17ff97(0x14a)]||_0x17ff97(0x174)});}}async[a16_0x4c3417(0x176)](_0x5b83ef,_0x1144ec){const _0x1083dc=a16_0x4c3417;try{const {code:_0x136a61}=_0x5b83ef[_0x1083dc(0x144)],{customerEmail:_0x51fca1,customerName:_0x542b33,customerIp:_0x2d0198,customerUa:_0x5bc38c,customerCountry:_0x495d6b,requestId:_0x466c6f,emailValidation:_0x14cda5}=_0x5b83ef[_0x1083dc(0x163)];if(!_0x51fca1||!_0x542b33)return _0x1144ec[_0x1083dc(0x15a)](0x190)['json']({'success':![],'error':'Customer\x20email\x20and\x20name\x20are\x20required'});const _0x34fa6b=await prePaymentService_1[_0x1083dc(0x175)][_0x1083dc(0x176)](_0x136a61,{'customerEmail':_0x51fca1,'customerName':_0x542b33,'customerIp':_0x2d0198,'customerUa':_0x5bc38c,'customerCountry':_0x495d6b}),_0xd0d957=await database_1[_0x1083dc(0x17c)][_0x1083dc(0x17e)]['findUnique']({'where':{'id':_0x34fa6b[_0x1083dc(0x152)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0xd0d957)throw new Error(_0x1083dc(0x158));const _0x44281b=this[_0x1083dc(0x147)]();console[_0x1083dc(0x145)]('ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20'+_0x44281b);const _0x30dcc6=_0x1083dc(0x164),_0x2f00a7=new Date(Date[_0x1083dc(0x16e)]()+0x1e*0x3c*0x3e8),_0xeadcf4=await database_1[_0x1083dc(0x17c)][_0x1083dc(0x150)][_0x1083dc(0x167)]({'data':{'shopId':_0x34fa6b[_0x1083dc(0x152)],'gateway':_0x34fa6b['gateway'],'amount':Number(_0x34fa6b[_0x1083dc(0x14f)]),'currency':_0x34fa6b['currency'],'sourceCurrency':_0x34fa6b[_0x1083dc(0x14d)]||undefined,'network':_0x34fa6b[_0x1083dc(0x154)]||undefined,'orderId':_0x34fa6b[_0x1083dc(0x157)]||'','gatewayOrderId':_0x44281b,'customerEmail':_0x34fa6b[_0x1083dc(0x14b)],'customerName':_0x34fa6b[_0x1083dc(0x15f)],'customerCountry':_0x495d6b||undefined,'customerIp':_0x2d0198||undefined,'customerUa':_0x5bc38c||undefined,'successUrl':_0x34fa6b[_0x1083dc(0x16b)]||_0x1083dc(0x162),'failUrl':_0x34fa6b[_0x1083dc(0x149)]||_0x1083dc(0x183),'pendingUrl':_0x34fa6b[_0x1083dc(0x17b)]||_0x1083dc(0x179),'status':_0x30dcc6,'expiresAt':_0x2f00a7,'createdVia':_0x1083dc(0x16d)}});console['log'](_0x1083dc(0x161)+_0xeadcf4['id']),await database_1[_0x1083dc(0x17c)][_0x1083dc(0x14e)][_0x1083dc(0x15d)]({'where':{'id':_0x34fa6b['prePaymentId']},'data':{'paymentId':_0xeadcf4['id']}});_0x14cda5&&await database_1[_0x1083dc(0x17c)]['payment']['update']({'where':{'id':_0xeadcf4['id']},'data':{'emailDeliverabilityStatus':_0x14cda5['deliverabilityStatus'],'emailIsDisposable':_0x14cda5[_0x1083dc(0x17a)],'emailRiskLevel':_0x14cda5[_0x1083dc(0x185)]}});if(_0x466c6f)try{await this[_0x1083dc(0x17d)][_0x1083dc(0x146)](_0xeadcf4['id'],_0x466c6f),console[_0x1083dc(0x145)](_0x1083dc(0x181)+_0xeadcf4['id']);}catch(_0x47db79){console[_0x1083dc(0x159)](_0x1083dc(0x170),_0x47db79);}console[_0x1083dc(0x145)]('ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20'+_0x34fa6b['gateway']+_0x1083dc(0x180));const _0x54a798=await this[_0x1083dc(0x17d)][_0x1083dc(0x15c)](_0xeadcf4['id']),_0xebdbdf=process.env.FRONTEND_URL||_0x1083dc(0x165),_0x4ad46e=_0x54a798['externalPaymentUrl']||_0xebdbdf+_0x1083dc(0x16c)+_0xeadcf4['id'];console['log'](_0x1083dc(0x156)+_0x4ad46e),_0x1144ec['json']({'success':!![],'result':{'paymentId':_0xeadcf4['id'],'paymentUrl':_0x4ad46e}});}catch(_0x1d6ab6){console['error'](_0x1083dc(0x187),_0x1d6ab6),_0x1144ec['status'](0x190)['json']({'success':![],'error':_0x1d6ab6[_0x1083dc(0x14a)]||_0x1083dc(0x168)});}}[a16_0x4c3417(0x147)](){const _0x2a9709=a16_0x4c3417,_0x3b788c=Math[_0x2a9709(0x182)](0x989680+Math[_0x2a9709(0x160)]()*0x55d4a80),_0x5652e1=Math[_0x2a9709(0x182)](0x989680+Math[_0x2a9709(0x160)]()*0x55d4a80);return _0x3b788c+'-'+_0x5652e1;}}function a16_0x3e3f(_0x2fa483,_0x46aee8){_0x2fa483=_0x2fa483-0x144;const _0x415027=a16_0x4150();let _0x3e3f40=_0x415027[_0x2fa483];return _0x3e3f40;}exports[a16_0x4c3417(0x186)]=PrePaymentController,exports[a16_0x4c3417(0x155)]=new PrePaymentController();