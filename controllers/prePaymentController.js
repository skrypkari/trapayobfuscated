'use strict';function a16_0x573f(){const _0xbbb2aa=['customerEmail','params','__esModule','6288130OaPKuG','currency','sourceCurrency','PENDING','656502TsHLdL','network','getPrePayment','now','paymentService','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','âœ…\x20Payment\x20created:\x20','35bvJmmp','PrePaymentController','amount','body','customerName','payment','218432cmuyzN','shopId','prePaymentService','prePayment','Failed\x20to\x20save\x20fingerprint:','initiateGatewayPayment','error','https://app.trapay.uk/payment/pending','https://app.trapay.uk/payment/success','riskLevel','PaymentService','create','33eMoape','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','confirmPrePayment','gateway','default','/payment/','__importDefault','orderId','18HyFfrK','prePaymentId','json','random','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','Get\x20pre-payment\x20error:','getPaymentFingerprint','isDisposable','17048dfsZuz','defineProperty','1885815CHrvZd','../services/prePaymentService','Failed\x20to\x20fetch\x20pre-payment','Customer\x20email\x20and\x20name\x20are\x20required','https://app.trapay.uk/payment/fail','../services/paymentService','getPrePaymentByCode','failUrl','1280660swgbOU','status','48BkVEjO','1142888WPFrmx','message','prePaymentController','log','https://app.trapay.uk'];a16_0x573f=function(){return _0xbbb2aa;};return a16_0x573f();}const a16_0x1abc3f=a16_0x399c;(function(_0x5a346d,_0x42a24){const _0xb16370=a16_0x399c,_0x1d2b5f=_0x5a346d();while(!![]){try{const _0x1df8a6=parseInt(_0xb16370(0x1da))/0x1+parseInt(_0xb16370(0x1ce))/0x2+parseInt(_0xb16370(0x1cd))/0x3*(-parseInt(_0xb16370(0x1c1))/0x4)+parseInt(_0xb16370(0x1cb))/0x5*(parseInt(_0xb16370(0x1b9))/0x6)+-parseInt(_0xb16370(0x1e1))/0x7*(-parseInt(_0xb16370(0x1e7))/0x8)+parseInt(_0xb16370(0x1c3))/0x9+parseInt(_0xb16370(0x1d6))/0xa*(-parseInt(_0xb16370(0x1b1))/0xb);if(_0x1df8a6===_0x42a24)break;else _0x1d2b5f['push'](_0x1d2b5f['shift']());}catch(_0x4f1963){_0x1d2b5f['push'](_0x1d2b5f['shift']());}}}(a16_0x573f,0x5eab6));var __importDefault=this&&this[a16_0x1abc3f(0x1b7)]||function(_0x36b61a){return _0x36b61a&&_0x36b61a['__esModule']?_0x36b61a:{'default':_0x36b61a};};Object[a16_0x1abc3f(0x1c2)](exports,a16_0x1abc3f(0x1d5),{'value':!![]}),exports['prePaymentController']=exports[a16_0x1abc3f(0x1e2)]=void 0x0;const database_1=__importDefault(require('../config/database')),prePaymentService_1=require(a16_0x1abc3f(0x1c4)),paymentService_1=require(a16_0x1abc3f(0x1c8));class PrePaymentController{constructor(){const _0x54a0c9=a16_0x1abc3f;this[_0x54a0c9(0x1de)]=new paymentService_1[(_0x54a0c9(0x1af))]();}async[a16_0x1abc3f(0x1dc)](_0x267e75,_0x46dc6c){const _0x186ed9=a16_0x1abc3f;try{const {code:_0x234242}=_0x267e75['params'],_0x5db229=await prePaymentService_1['prePaymentService'][_0x186ed9(0x1c9)](_0x234242);_0x46dc6c[_0x186ed9(0x1bb)]({'success':!![],'result':_0x5db229});}catch(_0x5934d8){console['error'](_0x186ed9(0x1be),_0x5934d8),_0x46dc6c[_0x186ed9(0x1cc)](0x190)[_0x186ed9(0x1bb)]({'success':![],'error':_0x5934d8[_0x186ed9(0x1cf)]||_0x186ed9(0x1c5)});}}async[a16_0x1abc3f(0x1b3)](_0x217071,_0x633701){const _0x9f43bc=a16_0x1abc3f;try{const {code:_0x51ea83}=_0x217071[_0x9f43bc(0x1d4)],{customerEmail:_0x4842cd,customerName:_0x39912e,customerIp:_0x41df86,customerUa:_0x26b2ff,customerCountry:_0x55b05f,requestId:_0x4ad7a9,emailValidation:_0x4f442d}=_0x217071[_0x9f43bc(0x1e4)];if(!_0x4842cd||!_0x39912e)return _0x633701[_0x9f43bc(0x1cc)](0x190)[_0x9f43bc(0x1bb)]({'success':![],'error':_0x9f43bc(0x1c6)});const _0x483bbb=await prePaymentService_1[_0x9f43bc(0x1a7)][_0x9f43bc(0x1b3)](_0x51ea83,{'customerEmail':_0x4842cd,'customerName':_0x39912e,'customerIp':_0x41df86,'customerUa':_0x26b2ff,'customerCountry':_0x55b05f}),_0x3927e9=await database_1[_0x9f43bc(0x1b5)]['shop']['findUnique']({'where':{'id':_0x483bbb[_0x9f43bc(0x1e8)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0x3927e9)throw new Error('Shop\x20not\x20found');const _0x2c386e=this['generateGatewayOrderId']();console[_0x9f43bc(0x1d1)](_0x9f43bc(0x1bd)+_0x2c386e);const _0xbf7903=_0x9f43bc(0x1d9),_0x1a4b80=new Date(Date[_0x9f43bc(0x1dd)]()+0x1e*0x3c*0x3e8),_0xfea6df=await database_1[_0x9f43bc(0x1b5)]['payment'][_0x9f43bc(0x1b0)]({'data':{'shopId':_0x483bbb['shopId'],'gateway':_0x483bbb[_0x9f43bc(0x1b4)],'amount':Number(_0x483bbb[_0x9f43bc(0x1e3)]),'currency':_0x483bbb[_0x9f43bc(0x1d7)],'sourceCurrency':_0x483bbb[_0x9f43bc(0x1d8)]||undefined,'network':_0x483bbb[_0x9f43bc(0x1db)]||undefined,'orderId':_0x483bbb[_0x9f43bc(0x1b8)]||'','gatewayOrderId':_0x2c386e,'customerEmail':_0x483bbb[_0x9f43bc(0x1d3)],'customerName':_0x483bbb[_0x9f43bc(0x1e5)],'customerCountry':_0x55b05f||undefined,'customerIp':_0x41df86||undefined,'customerUa':_0x26b2ff||undefined,'successUrl':_0x483bbb['successUrl']||_0x9f43bc(0x1ad),'failUrl':_0x483bbb[_0x9f43bc(0x1ca)]||_0x9f43bc(0x1c7),'pendingUrl':_0x483bbb['pendingUrl']||_0x9f43bc(0x1ac),'status':_0xbf7903,'expiresAt':_0x1a4b80,'createdVia':'api'}});console[_0x9f43bc(0x1d1)](_0x9f43bc(0x1e0)+_0xfea6df['id']),await database_1[_0x9f43bc(0x1b5)][_0x9f43bc(0x1a8)]['update']({'where':{'id':_0x483bbb[_0x9f43bc(0x1ba)]},'data':{'paymentId':_0xfea6df['id']}});_0x4f442d&&await database_1[_0x9f43bc(0x1b5)][_0x9f43bc(0x1e6)]['update']({'where':{'id':_0xfea6df['id']},'data':{'emailDeliverabilityStatus':_0x4f442d['deliverabilityStatus'],'emailIsDisposable':_0x4f442d[_0x9f43bc(0x1c0)],'emailRiskLevel':_0x4f442d[_0x9f43bc(0x1ae)]}});if(_0x4ad7a9)try{await this[_0x9f43bc(0x1de)][_0x9f43bc(0x1bf)](_0xfea6df['id'],_0x4ad7a9),console['log'](_0x9f43bc(0x1b2)+_0xfea6df['id']);}catch(_0x1074eb){console[_0x9f43bc(0x1ab)](_0x9f43bc(0x1a9),_0x1074eb);}console[_0x9f43bc(0x1d1)](_0x9f43bc(0x1df)+_0x483bbb['gateway']+'...');const _0x53f68c=await this[_0x9f43bc(0x1de)][_0x9f43bc(0x1aa)](_0xfea6df['id']),_0x1ccf9b=process.env.FRONTEND_URL||_0x9f43bc(0x1d2),_0x401072=_0x53f68c['externalPaymentUrl']||_0x1ccf9b+_0x9f43bc(0x1b6)+_0xfea6df['id'];console['log']('âœ…\x20Payment\x20URL:\x20'+_0x401072),_0x633701[_0x9f43bc(0x1bb)]({'success':!![],'result':{'paymentId':_0xfea6df['id'],'paymentUrl':_0x401072}});}catch(_0x48351c){console[_0x9f43bc(0x1ab)]('Confirm\x20pre-payment\x20error:',_0x48351c),_0x633701['status'](0x190)['json']({'success':![],'error':_0x48351c[_0x9f43bc(0x1cf)]||'Failed\x20to\x20confirm\x20pre-payment'});}}['generateGatewayOrderId'](){const _0x3aa68b=a16_0x1abc3f,_0x686b73=Math['floor'](0x989680+Math[_0x3aa68b(0x1bc)]()*0x55d4a80),_0x5541f0=Math['floor'](0x989680+Math[_0x3aa68b(0x1bc)]()*0x55d4a80);return _0x686b73+'-'+_0x5541f0;}}function a16_0x399c(_0x223e9f,_0x38dbea){_0x223e9f=_0x223e9f-0x1a7;const _0x573f23=a16_0x573f();let _0x399c3f=_0x573f23[_0x223e9f];return _0x399c3f;}exports[a16_0x1abc3f(0x1e2)]=PrePaymentController,exports[a16_0x1abc3f(0x1d0)]=new PrePaymentController();