'use strict';const a16_0x2db31b=a16_0xe402;(function(_0x2e3cfa,_0x4fb63e){const _0x4376b3=a16_0xe402,_0x500df8=_0x2e3cfa();while(!![]){try{const _0x50e0ec=-parseInt(_0x4376b3(0xb7))/0x1+-parseInt(_0x4376b3(0x91))/0x2*(-parseInt(_0x4376b3(0x92))/0x3)+parseInt(_0x4376b3(0x95))/0x4*(parseInt(_0x4376b3(0x93))/0x5)+-parseInt(_0x4376b3(0x9c))/0x6*(parseInt(_0x4376b3(0xc5))/0x7)+-parseInt(_0x4376b3(0xbe))/0x8+parseInt(_0x4376b3(0xaf))/0x9+parseInt(_0x4376b3(0xc1))/0xa;if(_0x50e0ec===_0x4fb63e)break;else _0x500df8['push'](_0x500df8['shift']());}catch(_0xa02960){_0x500df8['push'](_0x500df8['shift']());}}}(a16_0x2c68,0x3075d));function a16_0xe402(_0x583ab9,_0x352b5d){_0x583ab9=_0x583ab9-0x8d;const _0x2c6827=a16_0x2c68();let _0xe402c8=_0x2c6827[_0x583ab9];return _0xe402c8;}var __importDefault=this&&this[a16_0x2db31b(0xb4)]||function(_0x3b2963){const _0x55dff3=a16_0x2db31b;return _0x3b2963&&_0x3b2963[_0x55dff3(0xba)]?_0x3b2963:{'default':_0x3b2963};};Object[a16_0x2db31b(0xbd)](exports,a16_0x2db31b(0xba),{'value':!![]}),exports['prePaymentController']=exports[a16_0x2db31b(0x96)]=void 0x0;function a16_0x2c68(){const _0x237a1b=['../services/paymentService','7aJTBGR','prePaymentId','getPrePayment','shop','findUnique','json','prePaymentController','riskLevel','getPaymentFingerprint','28GjJOJR','19554ZMomBx','169095ZunSbj','publicKey','44MLOxZj','PrePaymentController','update','params','language','Get\x20pre-payment\x20error:','status','1927242jEPEEP','/payment/','orderId','payment','Failed\x20to\x20fetch\x20pre-payment','getPrePaymentByCode','Customer\x20email\x20and\x20name\x20are\x20required','message','gateway','error','cointopay2','customerEmail','Failed\x20to\x20confirm\x20pre-payment','customerName','rapyd','pendingUrl','Confirm\x20pre-payment\x20error:','noda','prePaymentService','1866321EBhgbe','../services/prePaymentService','confirmPrePayment','amount','isDisposable','__importDefault','Failed\x20to\x20save\x20fingerprint:','successUrl','289774tzMaoK','paymentService','default','__esModule','../config/database','body','defineProperty','1643320bUoMiE','sourceCurrency','Shop\x20not\x20found','3442590xVELED','log','prePayment'];a16_0x2c68=function(){return _0x237a1b;};return a16_0x2c68();}const database_1=__importDefault(require(a16_0x2db31b(0xbb))),prePaymentService_1=require(a16_0x2db31b(0xb0)),paymentService_1=require(a16_0x2db31b(0xc4));class PrePaymentController{constructor(){const _0x8d86c=a16_0x2db31b;this[_0x8d86c(0xb8)]=new paymentService_1['PaymentService']();}async[a16_0x2db31b(0xc7)](_0x3083f3,_0x3cb01f){const _0x38939d=a16_0x2db31b;try{const {code:_0x3af99e}=_0x3083f3[_0x38939d(0x98)],_0x53884c=await prePaymentService_1[_0x38939d(0xae)][_0x38939d(0xa1)](_0x3af99e);_0x3cb01f[_0x38939d(0x8d)]({'success':!![],'result':_0x53884c});}catch(_0x206d69){console[_0x38939d(0xa5)](_0x38939d(0x9a),_0x206d69),_0x3cb01f[_0x38939d(0x9b)](0x190)[_0x38939d(0x8d)]({'success':![],'error':_0x206d69[_0x38939d(0xa3)]||_0x38939d(0xa0)});}}async['confirmPrePayment'](_0x2ae84e,_0x488143){const _0x41b617=a16_0x2db31b;try{const {code:_0x55f238}=_0x2ae84e['params'],{customerEmail:_0x4da243,customerName:_0x4b6c8d,customerIp:_0x4e96fc,customerUa:_0x20d664,customerCountry:_0x2d1472,requestId:_0xc6756c,emailValidation:_0x21b198}=_0x2ae84e[_0x41b617(0xbc)];if(!_0x4da243||!_0x4b6c8d)return _0x488143[_0x41b617(0x9b)](0x190)['json']({'success':![],'error':_0x41b617(0xa2)});const _0x574e43=await prePaymentService_1[_0x41b617(0xae)][_0x41b617(0xb1)](_0x55f238,{'customerEmail':_0x4da243,'customerName':_0x4b6c8d,'customerIp':_0x4e96fc,'customerUa':_0x20d664,'customerCountry':_0x2d1472}),_0x237893=await database_1['default'][_0x41b617(0xc8)][_0x41b617(0xc9)]({'where':{'id':_0x574e43['shopId']},'select':{'publicKey':!![]}});if(!_0x237893)throw new Error(_0x41b617(0xc0));const _0x23e2cb=this[_0x41b617(0xb8)]['getGatewayIdFromName'](_0x574e43[_0x41b617(0xa4)]),_0x1aba6f=await this['paymentService']['createPublicPayment']({'public_key':_0x237893[_0x41b617(0x94)],'gateway':String(_0x23e2cb),'order_id':_0x574e43[_0x41b617(0x9e)]||'','amount':Number(_0x574e43[_0x41b617(0xb2)]),'currency':_0x574e43['currency'],'source_currency':_0x574e43[_0x41b617(0xbf)]||undefined,'network':_0x574e43['network']||undefined,'success_url':_0x574e43[_0x41b617(0xb6)]||undefined,'fail_url':_0x574e43['failUrl']||undefined,'pending_url':_0x574e43[_0x41b617(0xab)]||undefined,'customer_email':_0x574e43[_0x41b617(0xa7)],'customer_name':_0x574e43[_0x41b617(0xa9)],'language':_0x574e43[_0x41b617(0x99)]||undefined});await database_1[_0x41b617(0xb9)][_0x41b617(0xc3)][_0x41b617(0x97)]({'where':{'id':_0x574e43[_0x41b617(0xc6)]},'data':{'paymentId':_0x1aba6f['id']}});_0x21b198&&await database_1[_0x41b617(0xb9)][_0x41b617(0x9f)][_0x41b617(0x97)]({'where':{'id':_0x1aba6f['id']},'data':{'emailDeliverabilityStatus':_0x21b198['deliverabilityStatus'],'emailIsDisposable':_0x21b198[_0x41b617(0xb3)],'emailRiskLevel':_0x21b198[_0x41b617(0x8f)]}});if(_0xc6756c)try{await this[_0x41b617(0xb8)][_0x41b617(0x90)](_0x1aba6f['id'],_0xc6756c),console[_0x41b617(0xc2)]('âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20'+_0x1aba6f['id']);}catch(_0x48b6d8){console[_0x41b617(0xa5)](_0x41b617(0xb5),_0x48b6d8);}const _0x2ace1f=[_0x41b617(0xaa),'maxpara','instaxchange',_0x41b617(0xad),'cointopay',_0x41b617(0xa6)],_0x18e46a=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x3ce824=_0x18e46a+_0x41b617(0x9d)+_0x1aba6f['id'];_0x488143['json']({'success':!![],'result':{'paymentId':_0x1aba6f['id'],'paymentUrl':_0x3ce824}});}catch(_0x2cbf39){console[_0x41b617(0xa5)](_0x41b617(0xac),_0x2cbf39),_0x488143[_0x41b617(0x9b)](0x190)[_0x41b617(0x8d)]({'success':![],'error':_0x2cbf39[_0x41b617(0xa3)]||_0x41b617(0xa8)});}}}exports[a16_0x2db31b(0x96)]=PrePaymentController,exports[a16_0x2db31b(0x8e)]=new PrePaymentController();