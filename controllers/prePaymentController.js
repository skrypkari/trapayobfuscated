'use strict';function a16_0x32c2(_0x878415,_0x40a057){_0x878415=_0x878415-0x13d;const _0x2e6592=a16_0x2e65();let _0x32c205=_0x2e6592[_0x878415];return _0x32c205;}const a16_0x26ab79=a16_0x32c2;function a16_0x2e65(){const _0x37fee0=['âœ…\x20Payment\x20URL:\x20','Shop\x20not\x20found','Payment\x20blocked\x20due\x20to\x20email\x20validation\x20failure','log','PENDING','amount','ðŸ“Š\x20Payment\x20will\x20be\x20created\x20with\x20status:\x20','maxpara','json','update','defineProperty','cointopay','initiateGatewayPayment','ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20','findUnique','error','Cryptocurrency','__esModule','create','currency','__importDefault','random','ðŸš«\x20Email\x20validation\x20failed\x20-\x20payment\x20created\x20with\x20BLOCKED\x20status','network','PaymentService','instaxchange','rapyd','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','cointopay2','shopId','Customer\x20email\x20and\x20name\x20are\x20required','visa/mastercard','prePaymentId','Failed\x20to\x20confirm\x20pre-payment','myxspend','generateGatewayOrderId','sourceCurrency','Bank\x20Card','message','ampay','32YYNmnA','68821sUeNWG','n/a','now','../services/paymentService','/payment/','11027238rVrWrt','https://app.trapay.uk/payment/pending','getPrePaymentByCode','riskLevel','https://app.trapay.uk/payment/fail','customerName','oxapay','status=BLOCKED&reason=','ampay_try','orderId','shop','pendingUrl','Failed\x20to\x20save\x20fingerprint:','api','confirmPrePayment','ðŸ”—\x20Returning\x20fail\x20URL:\x20','gateway','paymentService','externalPaymentUrl','2927432uHikFB','noda','params','getPrePayment','../config/database','prePaymentService','prePaymentController','payment','21586077xqGfZr','4480005qALZMh','7043099QGieaV','failUrl','status','PrePaymentController','\x20(email\x20validation\x20failed)','2WCBHDj','isValid','612207mmzvbj','default','BLOCKED','customerEmail','deliverabilityStatus','https://app.trapay.uk/payment/success'];a16_0x2e65=function(){return _0x37fee0;};return a16_0x2e65();}(function(_0x5eecd3,_0x49ef0c){const _0x28ed34=a16_0x32c2,_0x37fd07=_0x5eecd3();while(!![]){try{const _0x339836=parseInt(_0x28ed34(0x193))/0x1*(-parseInt(_0x28ed34(0x162))/0x2)+parseInt(_0x28ed34(0x164))/0x3*(-parseInt(_0x28ed34(0x192))/0x4)+-parseInt(_0x28ed34(0x15c))/0x5+parseInt(_0x28ed34(0x140))/0x6+-parseInt(_0x28ed34(0x15d))/0x7+parseInt(_0x28ed34(0x153))/0x8+parseInt(_0x28ed34(0x15b))/0x9;if(_0x339836===_0x49ef0c)break;else _0x37fd07['push'](_0x37fd07['shift']());}catch(_0x2b8072){_0x37fd07['push'](_0x37fd07['shift']());}}}(a16_0x2e65,0xf3d44));var __importDefault=this&&this[a16_0x26ab79(0x17e)]||function(_0x5c50ad){const _0x4d05b2=a16_0x26ab79;return _0x5c50ad&&_0x5c50ad[_0x4d05b2(0x17b)]?_0x5c50ad:{'default':_0x5c50ad};};Object[a16_0x26ab79(0x174)](exports,a16_0x26ab79(0x17b),{'value':!![]}),exports[a16_0x26ab79(0x159)]=exports['PrePaymentController']=void 0x0;const database_1=__importDefault(require(a16_0x26ab79(0x157))),prePaymentService_1=require('../services/prePaymentService'),paymentService_1=require(a16_0x26ab79(0x13e));class PrePaymentController{constructor(){const _0x8e96e9=a16_0x26ab79;this[_0x8e96e9(0x151)]=new paymentService_1[(_0x8e96e9(0x182))]();}async[a16_0x26ab79(0x156)](_0x576929,_0x46c2ef){const _0x27e06d=a16_0x26ab79;try{const {code:_0x323549}=_0x576929[_0x27e06d(0x155)],_0xe6c810=await prePaymentService_1[_0x27e06d(0x158)][_0x27e06d(0x142)](_0x323549);_0x46c2ef['json']({'success':!![],'result':_0xe6c810});}catch(_0x5758b4){console[_0x27e06d(0x179)]('Get\x20pre-payment\x20error:',_0x5758b4),_0x46c2ef[_0x27e06d(0x15f)](0x190)['json']({'success':![],'error':_0x5758b4[_0x27e06d(0x190)]||'Failed\x20to\x20fetch\x20pre-payment'});}}async[a16_0x26ab79(0x14e)](_0x390dbd,_0x43965e){const _0xbb97b5=a16_0x26ab79;try{const {code:_0x48ec4c}=_0x390dbd[_0xbb97b5(0x155)],{customerEmail:_0x410c8f,customerName:_0x4768dc,customerIp:_0x4b1656,customerUa:_0x2f4408,customerCountry:_0x3bb6df,requestId:_0x3536a3,emailValidation:_0x33bec4}=_0x390dbd['body'];if(!_0x410c8f||!_0x4768dc)return _0x43965e[_0xbb97b5(0x15f)](0x190)['json']({'success':![],'error':_0xbb97b5(0x188)});const _0x40deeb=await prePaymentService_1['prePaymentService'][_0xbb97b5(0x14e)](_0x48ec4c,{'customerEmail':_0x410c8f,'customerName':_0x4768dc,'customerIp':_0x4b1656,'customerUa':_0x2f4408,'customerCountry':_0x3bb6df}),_0xb1a1c=await database_1[_0xbb97b5(0x165)][_0xbb97b5(0x14a)][_0xbb97b5(0x178)]({'where':{'id':_0x40deeb[_0xbb97b5(0x187)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0xb1a1c)throw new Error(_0xbb97b5(0x16b));const _0x20ec08=this[_0xbb97b5(0x18d)]();console[_0xbb97b5(0x16d)](_0xbb97b5(0x177)+_0x20ec08);const _0x57a4ac=_0x33bec4&&_0x33bec4[_0xbb97b5(0x163)]===![],_0x14aaff=_0x57a4ac?_0xbb97b5(0x166):_0xbb97b5(0x16e),_0x25381a=new Date(Date[_0xbb97b5(0x13d)]()+0x1e*0x3c*0x3e8);console[_0xbb97b5(0x16d)](_0xbb97b5(0x170)+_0x14aaff+(_0x57a4ac?_0xbb97b5(0x161):''));const _0xb21d09=_0x447ee2=>{const _0x151a43=_0xbb97b5;if(_0x447ee2===_0x151a43(0x184)||_0x447ee2===_0x151a43(0x183)||_0x447ee2===_0x151a43(0x189)||_0x447ee2==='squirrelpay'||_0x447ee2==='squirrel-pay')return _0x151a43(0x18f);else{if(_0x447ee2===_0x151a43(0x154)||_0x447ee2===_0x151a43(0x175)||_0x447ee2===_0x151a43(0x186)||_0x447ee2===_0x151a43(0x18c))return'Open\x20Banking';else{if(_0x447ee2===_0x151a43(0x171)||_0x447ee2===_0x151a43(0x191)||_0x447ee2===_0x151a43(0x148))return'IBAN';else{if(_0x447ee2===_0x151a43(0x146))return _0x151a43(0x17a);}}}return _0x151a43(0x194);},_0x560ed2=_0xb21d09(_0x40deeb['gateway']),_0x3372c6=await database_1['default'][_0xbb97b5(0x15a)][_0xbb97b5(0x17c)]({'data':{'shopId':_0x40deeb[_0xbb97b5(0x187)],'gateway':_0x40deeb[_0xbb97b5(0x150)],'amount':Number(_0x40deeb[_0xbb97b5(0x16f)]),'currency':_0x40deeb[_0xbb97b5(0x17d)],'sourceCurrency':_0x40deeb[_0xbb97b5(0x18e)]||undefined,'network':_0x40deeb[_0xbb97b5(0x181)]||undefined,'orderId':_0x40deeb[_0xbb97b5(0x149)]||'','gatewayOrderId':_0x20ec08,'customerEmail':_0x40deeb[_0xbb97b5(0x167)],'customerName':_0x40deeb[_0xbb97b5(0x145)],'customerCountry':_0x3bb6df||undefined,'customerIp':_0x4b1656||undefined,'customerUa':_0x2f4408||undefined,'successUrl':_0x40deeb['successUrl']||_0xbb97b5(0x169),'failUrl':_0x40deeb['failUrl']||_0xbb97b5(0x144),'pendingUrl':_0x40deeb[_0xbb97b5(0x14b)]||_0xbb97b5(0x141),'status':_0x14aaff,'expiresAt':_0x25381a,'createdVia':_0xbb97b5(0x14d),'paymentMethod':_0x560ed2}});console[_0xbb97b5(0x16d)]('âœ…\x20Payment\x20created:\x20'+_0x3372c6['id']),await database_1[_0xbb97b5(0x165)]['prePayment']['update']({'where':{'id':_0x40deeb[_0xbb97b5(0x18a)]},'data':{'paymentId':_0x3372c6['id']}});_0x33bec4&&await database_1[_0xbb97b5(0x165)][_0xbb97b5(0x15a)][_0xbb97b5(0x173)]({'where':{'id':_0x3372c6['id']},'data':{'emailDeliverabilityStatus':_0x33bec4[_0xbb97b5(0x168)],'emailIsDisposable':_0x33bec4['isDisposable'],'emailRiskLevel':_0x33bec4[_0xbb97b5(0x143)]}});if(_0x3536a3)try{await this[_0xbb97b5(0x151)]['getPaymentFingerprint'](_0x3372c6['id'],_0x3536a3),console['log']('âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20'+_0x3372c6['id']);}catch(_0x3e28b3){console[_0xbb97b5(0x179)](_0xbb97b5(0x14c),_0x3e28b3);}if(_0x57a4ac){console[_0xbb97b5(0x16d)](_0xbb97b5(0x180));const _0x19c71f=_0x40deeb[_0xbb97b5(0x15e)]||'',_0x2f60df=_0x19c71f['includes']('?')?'&':'?',_0x33bf0a=''+_0x19c71f+_0x2f60df+_0xbb97b5(0x147)+encodeURIComponent(_0xbb97b5(0x16c));return console['log'](_0xbb97b5(0x14f)+_0x33bf0a),_0x43965e[_0xbb97b5(0x172)]({'success':!![],'result':{'paymentId':_0x3372c6['id'],'paymentUrl':_0x33bf0a}});}console[_0xbb97b5(0x16d)](_0xbb97b5(0x185)+_0x40deeb['gateway']+'...');const _0x33f2b2=await this['paymentService'][_0xbb97b5(0x176)](_0x3372c6['id']),_0x735719=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x1cfbe0=_0x33f2b2[_0xbb97b5(0x152)]||_0x735719+_0xbb97b5(0x13f)+_0x3372c6['id'];console['log'](_0xbb97b5(0x16a)+_0x1cfbe0),_0x43965e[_0xbb97b5(0x172)]({'success':!![],'result':{'paymentId':_0x3372c6['id'],'paymentUrl':_0x1cfbe0}});}catch(_0x21109a){console[_0xbb97b5(0x179)]('Confirm\x20pre-payment\x20error:',_0x21109a),_0x43965e[_0xbb97b5(0x15f)](0x190)['json']({'success':![],'error':_0x21109a[_0xbb97b5(0x190)]||_0xbb97b5(0x18b)});}}[a16_0x26ab79(0x18d)](){const _0x3bd761=a16_0x26ab79,_0x5924af=Math['floor'](0x989680+Math['random']()*0x55d4a80),_0x2d4821=Math['floor'](0x989680+Math[_0x3bd761(0x17f)]()*0x55d4a80);return _0x5924af+'-'+_0x2d4821;}}exports[a16_0x26ab79(0x160)]=PrePaymentController,exports['prePaymentController']=new PrePaymentController();