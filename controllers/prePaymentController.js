'use strict';const a16_0x118e75=a16_0x888b;(function(_0x93bdcd,_0x77b46a){const _0x216aa7=a16_0x888b,_0x46b111=_0x93bdcd();while(!![]){try{const _0x50bc40=-parseInt(_0x216aa7(0x1fa))/0x1*(parseInt(_0x216aa7(0x1e9))/0x2)+-parseInt(_0x216aa7(0x1e4))/0x3*(parseInt(_0x216aa7(0x1f5))/0x4)+-parseInt(_0x216aa7(0x1dd))/0x5+parseInt(_0x216aa7(0x1e5))/0x6*(parseInt(_0x216aa7(0x1f1))/0x7)+-parseInt(_0x216aa7(0x1d9))/0x8+-parseInt(_0x216aa7(0x1cc))/0x9*(parseInt(_0x216aa7(0x1ca))/0xa)+parseInt(_0x216aa7(0x1ed))/0xb*(parseInt(_0x216aa7(0x1da))/0xc);if(_0x50bc40===_0x77b46a)break;else _0x46b111['push'](_0x46b111['shift']());}catch(_0x420442){_0x46b111['push'](_0x46b111['shift']());}}}(a16_0x169d,0xb82f0));var __importDefault=this&&this['__importDefault']||function(_0x4ef793){const _0x1d0968=a16_0x888b;return _0x4ef793&&_0x4ef793[_0x1d0968(0x1f9)]?_0x4ef793:{'default':_0x4ef793};};function a16_0x888b(_0x5cf21d,_0x1c7921){_0x5cf21d=_0x5cf21d-0x1c0;const _0x169dfb=a16_0x169d();let _0x888b2b=_0x169dfb[_0x5cf21d];return _0x888b2b;}Object[a16_0x118e75(0x1c0)](exports,a16_0x118e75(0x1f9),{'value':!![]}),exports[a16_0x118e75(0x1d5)]=exports[a16_0x118e75(0x1fc)]=void 0x0;const database_1=__importDefault(require(a16_0x118e75(0x1e6))),prePaymentService_1=require(a16_0x118e75(0x1f3)),paymentService_1=require('../services/paymentService');class PrePaymentController{constructor(){const _0x50974c=a16_0x118e75;this[_0x50974c(0x1d8)]=new paymentService_1[(_0x50974c(0x1eb))]();}async[a16_0x118e75(0x1c5)](_0x5c1fa2,_0x4c38dc){const _0x20ff79=a16_0x118e75;try{const {code:_0x568bfb}=_0x5c1fa2[_0x20ff79(0x1f7)],_0x2962c6=await prePaymentService_1[_0x20ff79(0x1d1)]['getPrePaymentByCode'](_0x568bfb);_0x4c38dc[_0x20ff79(0x1d2)]({'success':!![],'result':_0x2962c6});}catch(_0x1888f5){console[_0x20ff79(0x1c9)](_0x20ff79(0x1f8),_0x1888f5),_0x4c38dc[_0x20ff79(0x1e0)](0x190)[_0x20ff79(0x1d2)]({'success':![],'error':_0x1888f5[_0x20ff79(0x1e3)]||'Failed\x20to\x20fetch\x20pre-payment'});}}async[a16_0x118e75(0x1d7)](_0x3dc34f,_0x271164){const _0x32d7aa=a16_0x118e75;try{const {code:_0x5906de}=_0x3dc34f[_0x32d7aa(0x1f7)],{customerEmail:_0x4fbaba,customerName:_0x5754ad,customerIp:_0x3f9f04,customerUa:_0x24d0bf,customerCountry:_0x584917,requestId:_0x22a1cc,emailValidation:_0x6fea95}=_0x3dc34f[_0x32d7aa(0x1d3)];if(!_0x4fbaba||!_0x5754ad)return _0x271164['status'](0x190)[_0x32d7aa(0x1d2)]({'success':![],'error':_0x32d7aa(0x1d4)});const _0x49799b=await prePaymentService_1[_0x32d7aa(0x1d1)][_0x32d7aa(0x1d7)](_0x5906de,{'customerEmail':_0x4fbaba,'customerName':_0x5754ad,'customerIp':_0x3f9f04,'customerUa':_0x24d0bf,'customerCountry':_0x584917}),_0x412f37=await database_1['default'][_0x32d7aa(0x1f6)][_0x32d7aa(0x1c7)]({'where':{'id':_0x49799b[_0x32d7aa(0x1cb)]},'select':{'publicKey':!![],'name':!![],'username':!![]}});if(!_0x412f37)throw new Error('Shop\x20not\x20found');const _0x55eeb6=this['generateGatewayOrderId']();console['log']('ðŸŽ¯\x20Generated\x20gateway\x20order_id:\x20'+_0x55eeb6);const _0x36edf1=_0x32d7aa(0x1e1),_0xc5090d=new Date(Date['now']()+0x1e*0x3c*0x3e8),_0x30c1d5=await database_1['default']['payment'][_0x32d7aa(0x1fe)]({'data':{'shopId':_0x49799b[_0x32d7aa(0x1cb)],'gateway':_0x49799b[_0x32d7aa(0x1c3)],'amount':Number(_0x49799b[_0x32d7aa(0x1c6)]),'currency':_0x49799b['currency'],'sourceCurrency':_0x49799b['sourceCurrency']||undefined,'network':_0x49799b[_0x32d7aa(0x1e2)]||undefined,'orderId':_0x49799b[_0x32d7aa(0x1c1)]||'','gatewayOrderId':_0x55eeb6,'customerEmail':_0x49799b[_0x32d7aa(0x200)],'customerName':_0x49799b[_0x32d7aa(0x1f2)],'customerCountry':_0x584917||undefined,'customerIp':_0x3f9f04||undefined,'customerUa':_0x24d0bf||undefined,'successUrl':_0x49799b['successUrl']||_0x32d7aa(0x1f0),'failUrl':_0x49799b[_0x32d7aa(0x1ce)]||_0x32d7aa(0x1d6),'pendingUrl':_0x49799b['pendingUrl']||'https://app.trapay.uk/payment/pending','status':_0x36edf1,'expiresAt':_0xc5090d,'createdVia':_0x32d7aa(0x1ec)}});console[_0x32d7aa(0x1d0)](_0x32d7aa(0x1c2)+_0x30c1d5['id']),await database_1['default'][_0x32d7aa(0x1df)][_0x32d7aa(0x1fd)]({'where':{'id':_0x49799b['prePaymentId']},'data':{'paymentId':_0x30c1d5['id']}});_0x6fea95&&await database_1[_0x32d7aa(0x1ee)][_0x32d7aa(0x1dc)][_0x32d7aa(0x1fd)]({'where':{'id':_0x30c1d5['id']},'data':{'emailDeliverabilityStatus':_0x6fea95[_0x32d7aa(0x1cd)],'emailIsDisposable':_0x6fea95['isDisposable'],'emailRiskLevel':_0x6fea95['riskLevel']}});if(_0x22a1cc)try{await this[_0x32d7aa(0x1d8)][_0x32d7aa(0x1e7)](_0x30c1d5['id'],_0x22a1cc),console[_0x32d7aa(0x1d0)](_0x32d7aa(0x1f4)+_0x30c1d5['id']);}catch(_0x7ce32d){console[_0x32d7aa(0x1c9)]('Failed\x20to\x20save\x20fingerprint:',_0x7ce32d);}console[_0x32d7aa(0x1d0)](_0x32d7aa(0x1de)+_0x49799b[_0x32d7aa(0x1c3)]+_0x32d7aa(0x1ea));const _0x19ca71=await this[_0x32d7aa(0x1d8)][_0x32d7aa(0x1cf)](_0x30c1d5['id']),_0x5aa4c9=process.env.FRONTEND_URL||_0x32d7aa(0x1e8),_0x1c34c8=_0x19ca71[_0x32d7aa(0x1fb)]||_0x5aa4c9+_0x32d7aa(0x1ef)+_0x30c1d5['id'];console[_0x32d7aa(0x1d0)](_0x32d7aa(0x1c8)+_0x1c34c8),_0x271164[_0x32d7aa(0x1d2)]({'success':!![],'result':{'paymentId':_0x30c1d5['id'],'paymentUrl':_0x1c34c8}});}catch(_0x438d49){console[_0x32d7aa(0x1c9)](_0x32d7aa(0x1c4),_0x438d49),_0x271164[_0x32d7aa(0x1e0)](0x190)[_0x32d7aa(0x1d2)]({'success':![],'error':_0x438d49[_0x32d7aa(0x1e3)]||'Failed\x20to\x20confirm\x20pre-payment'});}}[a16_0x118e75(0x1db)](){const _0x45d70c=a16_0x118e75,_0x127a3b=Math['floor'](0x989680+Math['random']()*0x55d4a80),_0x571a21=Math[_0x45d70c(0x1ff)](0x989680+Math['random']()*0x55d4a80);return _0x127a3b+'-'+_0x571a21;}}exports[a16_0x118e75(0x1fc)]=PrePaymentController,exports[a16_0x118e75(0x1d5)]=new PrePaymentController();function a16_0x169d(){const _0x4e9b7a=['7KAkPKG','customerName','../services/prePaymentService','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','2454812MJKHZs','shop','params','Get\x20pre-payment\x20error:','__esModule','878mQfPjr','externalPaymentUrl','PrePaymentController','update','create','floor','customerEmail','defineProperty','orderId','âœ…\x20Payment\x20created:\x20','gateway','Confirm\x20pre-payment\x20error:','getPrePayment','amount','findUnique','âœ…\x20Payment\x20URL:\x20','error','412190XKZlZf','shopId','27ygHRSy','deliverabilityStatus','failUrl','initiateGatewayPayment','log','prePaymentService','json','body','Customer\x20email\x20and\x20name\x20are\x20required','prePaymentController','https://app.trapay.uk/payment/fail','confirmPrePayment','paymentService','8877384pmJwfE','153528VLMBZW','generateGatewayOrderId','payment','1386690TINRvX','ðŸ”„\x20Initiating\x20gateway\x20payment\x20for\x20','prePayment','status','PENDING','network','message','3RtgOJm','3804222pKExUc','../config/database','getPaymentFingerprint','https://app.trapay.uk','3076yQOMSz','...','PaymentService','api','3091aUlGNv','default','/payment/','https://app.trapay.uk/payment/success'];a16_0x169d=function(){return _0x4e9b7a;};return a16_0x169d();}