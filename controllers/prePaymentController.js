'use strict';const a15_0x2448a5=a15_0x3ccb;(function(_0x1ffd8c,_0x2fded2){const _0x4a9888=a15_0x3ccb,_0x3a3b97=_0x1ffd8c();while(!![]){try{const _0x33cb01=parseInt(_0x4a9888(0x13f))/0x1+-parseInt(_0x4a9888(0x143))/0x2+-parseInt(_0x4a9888(0x125))/0x3*(parseInt(_0x4a9888(0x146))/0x4)+-parseInt(_0x4a9888(0x11c))/0x5*(parseInt(_0x4a9888(0x123))/0x6)+parseInt(_0x4a9888(0x141))/0x7+-parseInt(_0x4a9888(0x12a))/0x8*(-parseInt(_0x4a9888(0x119))/0x9)+-parseInt(_0x4a9888(0x133))/0xa;if(_0x33cb01===_0x2fded2)break;else _0x3a3b97['push'](_0x3a3b97['shift']());}catch(_0x453c04){_0x3a3b97['push'](_0x3a3b97['shift']());}}}(a15_0x229d,0x6b1eb));function a15_0x3ccb(_0xd08b82,_0x4967b5){_0xd08b82=_0xd08b82-0x10d;const _0x229d8d=a15_0x229d();let _0x3ccb29=_0x229d8d[_0xd08b82];return _0x3ccb29;}var __importDefault=this&&this[a15_0x2448a5(0x124)]||function(_0x2e0039){const _0x34e134=a15_0x2448a5;return _0x2e0039&&_0x2e0039[_0x34e134(0x10f)]?_0x2e0039:{'default':_0x2e0039};};Object[a15_0x2448a5(0x112)](exports,'__esModule',{'value':!![]}),exports['prePaymentController']=exports[a15_0x2448a5(0x11f)]=void 0x0;function a15_0x229d(){const _0x376a03=['instaxchange','PrePaymentController','error','PaymentService','gateway','6TaQYLp','__importDefault','3ilpnoQ','Failed\x20to\x20fetch\x20pre-payment','getPaymentFingerprint','paymentService','status','32WgZSBd','prePaymentService','../services/paymentService','getPrePaymentByCode','publicKey','payment_url','cointopay','network','createPublicPayment','5154020hUefNA','customerName','Failed\x20to\x20confirm\x20pre-payment','getGatewayIdFromName','confirmPrePayment','cointopay2','prePaymentController','rapyd','amount','noda','getPrePayment','currency','630421GyKmuw','customerEmail','4037082gnYZkI','shopId','187316obwHfr','default','json','803204WkzKXz','prePayment','Confirm\x20pre-payment\x20error:','findUnique','__esModule','orderId','message','defineProperty','shop','body','country','language','failUrl','maxpara','536463rWmRHo','âœ…\x20Fingerprint\x20saved\x20for\x20payment\x20','params','984755EKAgau','Customer\x20email\x20and\x20name\x20are\x20required'];a15_0x229d=function(){return _0x376a03;};return a15_0x229d();}const database_1=__importDefault(require('../config/database')),prePaymentService_1=require('../services/prePaymentService'),paymentService_1=require(a15_0x2448a5(0x12c));class PrePaymentController{constructor(){const _0x115f41=a15_0x2448a5;this[_0x115f41(0x128)]=new paymentService_1[(_0x115f41(0x121))]();}async[a15_0x2448a5(0x13d)](_0x7f9123,_0x393dab){const _0x21934d=a15_0x2448a5;try{const {code:_0x19b4a8}=_0x7f9123[_0x21934d(0x11b)],_0x1d2cd9=await prePaymentService_1[_0x21934d(0x12b)][_0x21934d(0x12d)](_0x19b4a8);_0x393dab[_0x21934d(0x145)]({'success':!![],'result':_0x1d2cd9});}catch(_0x53df73){console['error']('Get\x20pre-payment\x20error:',_0x53df73),_0x393dab[_0x21934d(0x129)](0x190)['json']({'success':![],'error':_0x53df73['message']||_0x21934d(0x126)});}}async[a15_0x2448a5(0x137)](_0x1ecc2c,_0x395ec1){const _0x2ba7e3=a15_0x2448a5;try{const {code:_0x19b71a}=_0x1ecc2c[_0x2ba7e3(0x11b)],{customerEmail:_0x2e38e5,customerName:_0x1a795e,customerIp:_0x46d728,customerUa:_0x36f932,customerCountry:_0x466bda,requestId:_0x199701}=_0x1ecc2c[_0x2ba7e3(0x114)];if(!_0x2e38e5||!_0x1a795e)return _0x395ec1[_0x2ba7e3(0x129)](0x190)[_0x2ba7e3(0x145)]({'success':![],'error':_0x2ba7e3(0x11d)});const _0x5c73fd=await prePaymentService_1['prePaymentService']['confirmPrePayment'](_0x19b71a,{'customerEmail':_0x2e38e5,'customerName':_0x1a795e,'customerIp':_0x46d728,'customerUa':_0x36f932,'customerCountry':_0x466bda}),_0x378563=await database_1[_0x2ba7e3(0x144)][_0x2ba7e3(0x113)][_0x2ba7e3(0x10e)]({'where':{'id':_0x5c73fd[_0x2ba7e3(0x142)]},'select':{'publicKey':!![]}});if(!_0x378563)throw new Error('Shop\x20not\x20found');const _0xe937ea=this[_0x2ba7e3(0x128)][_0x2ba7e3(0x136)](_0x5c73fd[_0x2ba7e3(0x122)]),_0x438204=await this['paymentService'][_0x2ba7e3(0x132)]({'public_key':_0x378563[_0x2ba7e3(0x12e)],'gateway':String(_0xe937ea),'order_id':_0x5c73fd[_0x2ba7e3(0x110)]||undefined,'amount':Number(_0x5c73fd[_0x2ba7e3(0x13b)]),'currency':_0x5c73fd[_0x2ba7e3(0x13e)],'source_currency':_0x5c73fd['sourceCurrency']||undefined,'network':_0x5c73fd[_0x2ba7e3(0x131)]||undefined,'success_url':_0x5c73fd['successUrl']||undefined,'fail_url':_0x5c73fd[_0x2ba7e3(0x117)]||undefined,'pending_url':_0x5c73fd['pendingUrl']||undefined,'customer_email':_0x5c73fd[_0x2ba7e3(0x140)],'customer_name':_0x5c73fd[_0x2ba7e3(0x134)],'customer_country':_0x466bda,'customer_ip':_0x46d728,'customer_ua':_0x36f932,'country':_0x5c73fd[_0x2ba7e3(0x115)]||undefined,'language':_0x5c73fd[_0x2ba7e3(0x116)]||undefined});await database_1['default'][_0x2ba7e3(0x147)]['update']({'where':{'id':_0x5c73fd['prePaymentId']},'data':{'paymentId':_0x438204['id']}});if(_0x199701)try{await this[_0x2ba7e3(0x128)][_0x2ba7e3(0x127)](_0x438204['id'],_0x199701),console['log'](_0x2ba7e3(0x11a)+_0x438204['id']);}catch(_0x7b105d){console[_0x2ba7e3(0x120)]('Failed\x20to\x20save\x20fingerprint:',_0x7b105d);}const _0x55c24f=[_0x2ba7e3(0x13a),_0x2ba7e3(0x118),_0x2ba7e3(0x11e),_0x2ba7e3(0x13c),_0x2ba7e3(0x130),_0x2ba7e3(0x138)],_0x2d5750=_0x55c24f['includes'](_0x5c73fd[_0x2ba7e3(0x122)])&&_0x438204[_0x2ba7e3(0x12f)],_0x301be1=process.env.FRONTEND_URL||'https://app.trapay.uk',_0x2d9a96=_0x2d5750?_0x438204[_0x2ba7e3(0x12f)]:_0x301be1+'/payment/'+_0x438204['id'];_0x395ec1[_0x2ba7e3(0x145)]({'success':!![],'result':{'paymentId':_0x438204['id'],'paymentUrl':_0x2d9a96}});}catch(_0x2b3049){console[_0x2ba7e3(0x120)](_0x2ba7e3(0x10d),_0x2b3049),_0x395ec1['status'](0x190)[_0x2ba7e3(0x145)]({'success':![],'error':_0x2b3049[_0x2ba7e3(0x111)]||_0x2ba7e3(0x135)});}}}exports[a15_0x2448a5(0x11f)]=PrePaymentController,exports[a15_0x2448a5(0x139)]=new PrePaymentController();