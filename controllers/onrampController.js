'use strict';var a12_0x216b71=a12_0x453f;(function(_0x1ed296,_0x48293c){var _0x3ebe2e=a12_0x453f,_0x349e35=_0x1ed296();while(!![]){try{var _0x34ba1b=-parseInt(_0x3ebe2e(0x208))/0x1+parseInt(_0x3ebe2e(0x202))/0x2+parseInt(_0x3ebe2e(0x1f7))/0x3*(parseInt(_0x3ebe2e(0x200))/0x4)+-parseInt(_0x3ebe2e(0x1c7))/0x5*(parseInt(_0x3ebe2e(0x1cf))/0x6)+parseInt(_0x3ebe2e(0x1f3))/0x7*(-parseInt(_0x3ebe2e(0x1f1))/0x8)+-parseInt(_0x3ebe2e(0x1d4))/0x9+parseInt(_0x3ebe2e(0x20f))/0xa*(parseInt(_0x3ebe2e(0x1f8))/0xb);if(_0x34ba1b===_0x48293c)break;else _0x349e35['push'](_0x349e35['shift']());}catch(_0x3e16c0){_0x349e35['push'](_0x349e35['shift']());}}}(a12_0x15c8,0x40f84));function a12_0x15c8(){var _0x5159e2=['__setModuleDefault','toUpperCase','Internal\x20server\x20error','getOwnPropertyNames','params','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','updatePaymentStatus','‚úÖ\x20Found\x20payment:\x20','‚úÖ\x20OnRamp\x20payment\x20','16ndlRuU','resolve','1246308lcDrmu','convertToUSDT','prototype','json','3jFgvBT','22DkJLEl','defineProperty','Payment\x20status\x20updated\x20successfully','\x20updated\x20to\x20','create','update','gateway','gatewayPaymentId','149772efHkmz','\x20USDT\x20(after\x20','941156ffOuml','amount','__createBinding','onramp_system','payment','name','433255FZyHBu','findFirst','length','message','invoiceTotalSum','body','onramp','4310170gtWiWp','‚ùå\x20OnRamp\x20status\x20update\x20error:','Unknown\x20error','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','16120xqMFsI','error','default','__importDefault','Payment\x20not\x20found','shopId','get','gatewayOrderId','288aqlbxh','call','getOwnPropertyDescriptor','%\x20commission)','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','1438596pBSMlO','log','customerEmail','currency','updateMerchantBalanceForPaidPayment','OnRampController','writable','../config/database','PAID','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','successUrl','__esModule','Payment\x20ID\x20is\x20required','getPaymentData','../services/currencyService','status','customerName','pendingUrl','\x20->\x20','createdAt'];a12_0x15c8=function(){return _0x5159e2;};return a12_0x15c8();}var __createBinding=this&&this[a12_0x216b71(0x204)]||(Object['create']?function(_0x36dcf3,_0x1de922,_0x56ed2e,_0x1b75c1){var _0x130249=a12_0x216b71;if(_0x1b75c1===undefined)_0x1b75c1=_0x56ed2e;var _0xe50478=Object[_0x130249(0x1d1)](_0x1de922,_0x56ed2e);(!_0xe50478||(_0x130249(0x1cd)in _0xe50478?!_0x1de922[_0x130249(0x1df)]:_0xe50478[_0x130249(0x1da)]||_0xe50478['configurable']))&&(_0xe50478={'enumerable':!![],'get':function(){return _0x1de922[_0x56ed2e];}}),Object[_0x130249(0x1f9)](_0x36dcf3,_0x1b75c1,_0xe50478);}:function(_0x20b09e,_0x288913,_0x4a4728,_0x13f082){if(_0x13f082===undefined)_0x13f082=_0x4a4728;_0x20b09e[_0x13f082]=_0x288913[_0x4a4728];}),__setModuleDefault=this&&this[a12_0x216b71(0x1e8)]||(Object[a12_0x216b71(0x1fc)]?function(_0x45bf36,_0x22c95d){var _0x3fb13b=a12_0x216b71;Object[_0x3fb13b(0x1f9)](_0x45bf36,_0x3fb13b(0x1c9),{'enumerable':!![],'value':_0x22c95d});}:function(_0xe70fd4,_0x41286b){var _0x44db19=a12_0x216b71;_0xe70fd4[_0x44db19(0x1c9)]=_0x41286b;}),__importStar=this&&this['__importStar']||(function(){var _0x2c963b=function(_0x2ac8a6){var _0x3187ca=a12_0x453f;return _0x2c963b=Object[_0x3187ca(0x1eb)]||function(_0x14df5c){var _0x267086=_0x3187ca,_0x510ec4=[];for(var _0x156d64 in _0x14df5c)if(Object[_0x267086(0x1f5)]['hasOwnProperty'][_0x267086(0x1d0)](_0x14df5c,_0x156d64))_0x510ec4[_0x510ec4[_0x267086(0x20a)]]=_0x156d64;return _0x510ec4;},_0x2c963b(_0x2ac8a6);};return function(_0x3db3f0){var _0x19d186=a12_0x453f;if(_0x3db3f0&&_0x3db3f0['__esModule'])return _0x3db3f0;var _0x25bc70={};if(_0x3db3f0!=null){for(var _0x287a69=_0x2c963b(_0x3db3f0),_0x50f4fc=0x0;_0x50f4fc<_0x287a69[_0x19d186(0x20a)];_0x50f4fc++)if(_0x287a69[_0x50f4fc]!==_0x19d186(0x1c9))__createBinding(_0x25bc70,_0x3db3f0,_0x287a69[_0x50f4fc]);}return __setModuleDefault(_0x25bc70,_0x3db3f0),_0x25bc70;};}()),__importDefault=this&&this[a12_0x216b71(0x1ca)]||function(_0x3af95a){var _0x18437c=a12_0x216b71;return _0x3af95a&&_0x3af95a[_0x18437c(0x1df)]?_0x3af95a:{'default':_0x3af95a};};Object[a12_0x216b71(0x1f9)](exports,a12_0x216b71(0x1df),{'value':!![]}),exports['OnRampController']=void 0x0;const database_1=__importDefault(require(a12_0x216b71(0x1db)));function a12_0x453f(_0x4e5bd2,_0x860dca){_0x4e5bd2=_0x4e5bd2-0x1c5;var _0x15c83f=a12_0x15c8();var _0x453f28=_0x15c83f[_0x4e5bd2];return _0x453f28;}class OnRampController{async[a12_0x216b71(0x1ee)](_0x3c5811,_0x21525f){var _0x46c760=a12_0x216b71;try{const {paymentId:_0x47ecb0,status:_0x23e653,referenceId:_0xcdc743,transactionHash:_0x1c5f14,actualCryptoAmount:_0x1f2dce,orderId:_0x4fcbd2}=_0x3c5811[_0x46c760(0x20d)];if(!_0x47ecb0||!_0x23e653){_0x21525f['status'](0x190)[_0x46c760(0x1f6)]({'success':![],'message':'Payment\x20ID\x20and\x20status\x20are\x20required'});return;}console['log']('üöÄ\x20OnRamp\x20status\x20update:\x20'+_0x47ecb0+_0x46c760(0x1e6)+_0x23e653),console[_0x46c760(0x1d5)]('üìù\x20Data:',{'referenceId':_0xcdc743,'transactionHash':_0x1c5f14,'actualCryptoAmount':_0x1f2dce,'orderId':_0x4fcbd2});const _0x585a8a=await database_1['default']['payment'][_0x46c760(0x209)]({'where':{'OR':[{'id':_0x47ecb0},{'orderId':_0x47ecb0},{'gatewayOrderId':_0x47ecb0},{'gatewayPaymentId':_0x47ecb0}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x585a8a){_0x21525f[_0x46c760(0x1e3)](0x194)[_0x46c760(0x1f6)]({'success':![],'message':_0x46c760(0x1cb)});return;}if(_0x585a8a[_0x46c760(0x1fe)]!==_0x46c760(0x20e)){_0x21525f[_0x46c760(0x1e3)](0x190)[_0x46c760(0x1f6)]({'success':![],'message':_0x46c760(0x1dd)});return;}const _0x3933e0={'status':_0x23e653[_0x46c760(0x1e9)](),'statusChangedAt':new Date(),'statusChangedBy':_0x46c760(0x205)};_0xcdc743&&(_0x3933e0[_0x46c760(0x1ce)]=_0xcdc743);_0x1c5f14&&(_0x3933e0['gatewayPaymentId']=_0x1c5f14);_0x1f2dce&&(_0x3933e0[_0x46c760(0x20c)]=_0x1f2dce);const _0x14bc2e=await database_1[_0x46c760(0x1c9)][_0x46c760(0x206)][_0x46c760(0x1fd)]({'where':{'id':_0x585a8a['id']},'data':_0x3933e0});console['log'](_0x46c760(0x1f0)+_0x585a8a['id']+_0x46c760(0x1fb)+_0x23e653),_0x23e653[_0x46c760(0x1e9)]()===_0x46c760(0x1dc)&&_0x585a8a[_0x46c760(0x1e3)]!==_0x46c760(0x1dc)&&await this[_0x46c760(0x1d8)](_0x585a8a),_0x21525f[_0x46c760(0x1f6)]({'success':!![],'message':_0x46c760(0x1fa),'data':{'paymentId':_0x14bc2e['id'],'status':_0x14bc2e[_0x46c760(0x1e3)],'referenceId':_0xcdc743,'transactionHash':_0x1c5f14,'actualCryptoAmount':_0x1f2dce}});}catch(_0x5f2369){console[_0x46c760(0x1c8)](_0x46c760(0x210),_0x5f2369),_0x21525f[_0x46c760(0x1e3)](0x1f4)[_0x46c760(0x1f6)]({'success':![],'message':_0x46c760(0x1ea),'error':_0x5f2369 instanceof Error?_0x5f2369[_0x46c760(0x20b)]:_0x46c760(0x1c5)});}}async['updateMerchantBalanceForPaidPayment'](_0x28b97b){var _0x48d795=a12_0x216b71;try{console[_0x48d795(0x1d5)](_0x48d795(0x1ed)+_0x28b97b['id']);let _0xae3644;if(_0x28b97b[_0x48d795(0x1d7)]==='USD')_0xae3644=_0x28b97b[_0x48d795(0x203)];else{const {currencyService:_0x4abd7f}=await Promise[_0x48d795(0x1f2)]()['then'](()=>__importStar(require(_0x48d795(0x1e2))));_0xae3644=await _0x4abd7f[_0x48d795(0x1f4)](_0x28b97b['amount'],_0x28b97b[_0x48d795(0x1d7)]);}await database_1[_0x48d795(0x1c9)][_0x48d795(0x206)]['update']({'where':{'id':_0x28b97b['id']},'data':{'amountUSDT':_0xae3644,'paidAt':new Date()}});const _0x46d575=0xa,_0xe815e7=_0xae3644*(0x1-_0x46d575/0x64);await database_1['default']['shop'][_0x48d795(0x1fd)]({'where':{'id':_0x28b97b[_0x48d795(0x1cc)]},'data':{'balance':{'increment':_0xe815e7}}}),console[_0x48d795(0x1d5)]('‚úÖ\x20Merchant\x20balance\x20updated:\x20+'+_0xe815e7['toFixed'](0x6)+_0x48d795(0x201)+_0x46d575+_0x48d795(0x1d2));}catch(_0x3f66bc){console[_0x48d795(0x1c8)]('‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:',_0x3f66bc);}}async[a12_0x216b71(0x1e1)](_0x4a2351,_0x6e7ce6){var _0x451fcc=a12_0x216b71;try{const {id:_0x106606}=_0x4a2351[_0x451fcc(0x1ec)];if(!_0x106606){_0x6e7ce6[_0x451fcc(0x1e3)](0x190)[_0x451fcc(0x1f6)]({'success':![],'message':_0x451fcc(0x1e0)});return;}console[_0x451fcc(0x1d5)](_0x451fcc(0x1d3)+_0x106606);const _0xb13ff0=await database_1['default'][_0x451fcc(0x206)][_0x451fcc(0x209)]({'where':{'OR':[{'id':_0x106606},{'orderId':_0x106606},{'gatewayOrderId':_0x106606},{'gatewayPaymentId':_0x106606}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0xb13ff0){_0x6e7ce6[_0x451fcc(0x1e3)](0x194)[_0x451fcc(0x1f6)]({'success':![],'message':'Payment\x20not\x20found'});return;}console[_0x451fcc(0x1d5)](_0x451fcc(0x1ef)+_0xb13ff0['id']+'\x20('+_0xb13ff0[_0x451fcc(0x1e3)]+')'),_0x6e7ce6[_0x451fcc(0x1f6)]({'success':!![],'data':{'id':_0xb13ff0['id'],'gateway':_0xb13ff0[_0x451fcc(0x1fe)],'amount':_0xb13ff0['amount'],'currency':_0xb13ff0[_0x451fcc(0x1d7)],'status':_0xb13ff0[_0x451fcc(0x1e3)],'gatewayOrderId':_0xb13ff0[_0x451fcc(0x1ce)],'gatewayPaymentId':_0xb13ff0[_0x451fcc(0x1ff)],'successUrl':_0xb13ff0[_0x451fcc(0x1de)],'failUrl':_0xb13ff0['failUrl'],'pendingUrl':_0xb13ff0[_0x451fcc(0x1e5)],'customerEmail':_0xb13ff0[_0x451fcc(0x1d6)],'customerName':_0xb13ff0[_0x451fcc(0x1e4)],'merchantBrand':_0xb13ff0['shop'][_0x451fcc(0x207)],'createdAt':_0xb13ff0[_0x451fcc(0x1e7)],'updatedAt':_0xb13ff0['updatedAt']}});}catch(_0x3537cd){console[_0x451fcc(0x1c8)](_0x451fcc(0x1c6),_0x3537cd),_0x6e7ce6['status'](0x1f4)[_0x451fcc(0x1f6)]({'success':![],'message':'Internal\x20server\x20error','error':_0x3537cd instanceof Error?_0x3537cd[_0x451fcc(0x20b)]:_0x451fcc(0x1c5)});}}}exports[a12_0x216b71(0x1d9)]=OnRampController;