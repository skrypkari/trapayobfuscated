'use strict';function a9_0x5587(){var _0x14fb0c=['default','‚úÖ\x20OnRamp\x20payment\x20','shopId','2wrbWSo','../config/database','1674294zblPPj','Payment\x20ID\x20is\x20required','gateway','writable','prototype','27ZDNAKz','pendingUrl','21625200pdAGpu','__createBinding','Payment\x20not\x20found','\x20USDT\x20(after\x20','body','30pMqknh','üìù\x20Data:','length','currency','Payment\x20status\x20updated\x20successfully','message','\x20->\x20','../services/currencyService','Unknown\x20error','gatewayOrderId','amount','params','OnRampController','then','4805948SCLSID','PAID','‚ùå\x20OnRamp\x20status\x20update\x20error:','2820716iiheMt','768962VfKCsN','resolve','Internal\x20server\x20error','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','toUpperCase','getOwnPropertyNames','error','payment','onramp_system','updateMerchantBalanceForPaidPayment','name','\x20updated\x20to\x20','üöÄ\x20OnRamp\x20status\x20update:\x20','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','‚úÖ\x20Found\x20payment:\x20','successUrl','2411816TSeroi','hasOwnProperty','log','defineProperty','toFixed','getPaymentData','customerName','json','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','updatedAt','createdAt','getOwnPropertyDescriptor','create','call','customerEmail','__setModuleDefault','gatewayPaymentId','findFirst','__esModule','%\x20commission)','failUrl','Payment\x20ID\x20and\x20status\x20are\x20required','update','get','updatePaymentStatus','status','803375OUfnPL','convertToUSDT'];a9_0x5587=function(){return _0x14fb0c;};return a9_0x5587();}var a9_0x2925ef=a9_0x5788;(function(_0x5be908,_0x8a91b3){var _0x4ad172=a9_0x5788,_0x3f02c2=_0x5be908();while(!![]){try{var _0x1b5029=parseInt(_0x4ad172(0x155))/0x1*(parseInt(_0x4ad172(0x175))/0x2)+parseInt(_0x4ad172(0x157))/0x3+parseInt(_0x4ad172(0x174))/0x4+parseInt(_0x4ad172(0x150))/0x5*(parseInt(_0x4ad172(0x163))/0x6)+parseInt(_0x4ad172(0x171))/0x7+parseInt(_0x4ad172(0x135))/0x8*(-parseInt(_0x4ad172(0x15c))/0x9)+-parseInt(_0x4ad172(0x15e))/0xa;if(_0x1b5029===_0x8a91b3)break;else _0x3f02c2['push'](_0x3f02c2['shift']());}catch(_0x52a490){_0x3f02c2['push'](_0x3f02c2['shift']());}}}(a9_0x5587,0x6f23b));function a9_0x5788(_0x28dede,_0x42fb57){var _0x55878f=a9_0x5587();return a9_0x5788=function(_0x57888d,_0x560dbe){_0x57888d=_0x57888d-0x132;var _0xfc8b6e=_0x55878f[_0x57888d];return _0xfc8b6e;},a9_0x5788(_0x28dede,_0x42fb57);}var __createBinding=this&&this[a9_0x2925ef(0x15f)]||(Object[a9_0x2925ef(0x142)]?function(_0x2539bb,_0x5989db,_0x162d4c,_0x571208){var _0x33323e=a9_0x2925ef;if(_0x571208===undefined)_0x571208=_0x162d4c;var _0x1071b3=Object[_0x33323e(0x141)](_0x5989db,_0x162d4c);(!_0x1071b3||(_0x33323e(0x14d)in _0x1071b3?!_0x5989db[_0x33323e(0x148)]:_0x1071b3[_0x33323e(0x15a)]||_0x1071b3['configurable']))&&(_0x1071b3={'enumerable':!![],'get':function(){return _0x5989db[_0x162d4c];}}),Object[_0x33323e(0x138)](_0x2539bb,_0x571208,_0x1071b3);}:function(_0x22c0de,_0x20785b,_0x18beb0,_0x2628b4){if(_0x2628b4===undefined)_0x2628b4=_0x18beb0;_0x22c0de[_0x2628b4]=_0x20785b[_0x18beb0];}),__setModuleDefault=this&&this[a9_0x2925ef(0x145)]||(Object[a9_0x2925ef(0x142)]?function(_0x4c7be5,_0x1f020b){var _0x3fa5ef=a9_0x2925ef;Object[_0x3fa5ef(0x138)](_0x4c7be5,'default',{'enumerable':!![],'value':_0x1f020b});}:function(_0x3b640d,_0x1f5c4b){var _0x4387a1=a9_0x2925ef;_0x3b640d[_0x4387a1(0x152)]=_0x1f5c4b;}),__importStar=this&&this['__importStar']||(function(){var _0x3344e5=function(_0xe2fad4){var _0x45ff83=a9_0x5788;return _0x3344e5=Object[_0x45ff83(0x17a)]||function(_0x416f38){var _0x13d8f6=_0x45ff83,_0x2eb95b=[];for(var _0x49614a in _0x416f38)if(Object[_0x13d8f6(0x15b)][_0x13d8f6(0x136)][_0x13d8f6(0x143)](_0x416f38,_0x49614a))_0x2eb95b[_0x2eb95b[_0x13d8f6(0x165)]]=_0x49614a;return _0x2eb95b;},_0x3344e5(_0xe2fad4);};return function(_0x124e0e){var _0x13977b=a9_0x5788;if(_0x124e0e&&_0x124e0e[_0x13977b(0x148)])return _0x124e0e;var _0x2de464={};if(_0x124e0e!=null){for(var _0x135876=_0x3344e5(_0x124e0e),_0x238b25=0x0;_0x238b25<_0x135876['length'];_0x238b25++)if(_0x135876[_0x238b25]!==_0x13977b(0x152))__createBinding(_0x2de464,_0x124e0e,_0x135876[_0x238b25]);}return __setModuleDefault(_0x2de464,_0x124e0e),_0x2de464;};}()),__importDefault=this&&this['__importDefault']||function(_0x59103d){var _0x23b4e6=a9_0x2925ef;return _0x59103d&&_0x59103d[_0x23b4e6(0x148)]?_0x59103d:{'default':_0x59103d};};Object[a9_0x2925ef(0x138)](exports,a9_0x2925ef(0x148),{'value':!![]}),exports[a9_0x2925ef(0x16f)]=void 0x0;const database_1=__importDefault(require(a9_0x2925ef(0x156)));class OnRampController{async[a9_0x2925ef(0x14e)](_0x425ff4,_0x3c5766){var _0xcd5991=a9_0x2925ef;try{const {paymentId:_0x270f16,status:_0x2d39c0,referenceId:_0x2e2670,transactionHash:_0x4b02ee,actualCryptoAmount:_0x5c93f7,orderId:_0x1f24a5}=_0x425ff4[_0xcd5991(0x162)];if(!_0x270f16||!_0x2d39c0){_0x3c5766[_0xcd5991(0x14f)](0x190)[_0xcd5991(0x13c)]({'success':![],'message':_0xcd5991(0x14b)});return;}console[_0xcd5991(0x137)](_0xcd5991(0x181)+_0x270f16+_0xcd5991(0x169)+_0x2d39c0),console[_0xcd5991(0x137)](_0xcd5991(0x164),{'referenceId':_0x2e2670,'transactionHash':_0x4b02ee,'actualCryptoAmount':_0x5c93f7,'orderId':_0x1f24a5});const _0x5ca45a=await database_1['default'][_0xcd5991(0x17c)][_0xcd5991(0x147)]({'where':{'OR':[{'id':_0x270f16},{'orderId':_0x270f16},{'gatewayOrderId':_0x270f16},{'gatewayPaymentId':_0x270f16}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x5ca45a){_0x3c5766['status'](0x194)[_0xcd5991(0x13c)]({'success':![],'message':_0xcd5991(0x160)});return;}if(_0x5ca45a[_0xcd5991(0x159)]!=='onramp'){_0x3c5766[_0xcd5991(0x14f)](0x190)['json']({'success':![],'message':_0xcd5991(0x178)});return;}const _0x540539={'status':_0x2d39c0['toUpperCase'](),'statusChangedAt':new Date(),'statusChangedBy':_0xcd5991(0x17d)};_0x2e2670&&(_0x540539[_0xcd5991(0x16c)]=_0x2e2670);_0x4b02ee&&(_0x540539['gatewayPaymentId']=_0x4b02ee);_0x5c93f7&&(_0x540539['invoiceTotalSum']=_0x5c93f7);const _0x43e1f7=await database_1['default']['payment'][_0xcd5991(0x14c)]({'where':{'id':_0x5ca45a['id']},'data':_0x540539});console[_0xcd5991(0x137)](_0xcd5991(0x153)+_0x5ca45a['id']+_0xcd5991(0x180)+_0x2d39c0),_0x2d39c0[_0xcd5991(0x179)]()==='PAID'&&_0x5ca45a[_0xcd5991(0x14f)]!==_0xcd5991(0x172)&&await this[_0xcd5991(0x17e)](_0x5ca45a),_0x3c5766[_0xcd5991(0x13c)]({'success':!![],'message':_0xcd5991(0x167),'data':{'paymentId':_0x43e1f7['id'],'status':_0x43e1f7[_0xcd5991(0x14f)],'referenceId':_0x2e2670,'transactionHash':_0x4b02ee,'actualCryptoAmount':_0x5c93f7}});}catch(_0x253055){console['error'](_0xcd5991(0x173),_0x253055),_0x3c5766[_0xcd5991(0x14f)](0x1f4)[_0xcd5991(0x13c)]({'success':![],'message':_0xcd5991(0x177),'error':_0x253055 instanceof Error?_0x253055[_0xcd5991(0x168)]:_0xcd5991(0x16b)});}}async[a9_0x2925ef(0x17e)](_0x2449fb){var _0x2a8699=a9_0x2925ef;try{console['log']('üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20'+_0x2449fb['id']);let _0x5d0caa;if(_0x2449fb[_0x2a8699(0x166)]==='USD')_0x5d0caa=_0x2449fb[_0x2a8699(0x16d)];else{const {currencyService:_0x15deb3}=await Promise[_0x2a8699(0x176)]()[_0x2a8699(0x170)](()=>__importStar(require(_0x2a8699(0x16a))));_0x5d0caa=await _0x15deb3[_0x2a8699(0x151)](_0x2449fb[_0x2a8699(0x16d)],_0x2449fb[_0x2a8699(0x166)]);}await database_1[_0x2a8699(0x152)]['payment'][_0x2a8699(0x14c)]({'where':{'id':_0x2449fb['id']},'data':{'amountUSDT':_0x5d0caa,'paidAt':new Date()}});const _0x137ca6=0xa,_0x15de41=_0x5d0caa*(0x1-_0x137ca6/0x64);await database_1['default']['shop'][_0x2a8699(0x14c)]({'where':{'id':_0x2449fb[_0x2a8699(0x154)]},'data':{'balance':{'increment':_0x15de41}}}),console['log'](_0x2a8699(0x13e)+_0x15de41[_0x2a8699(0x139)](0x6)+_0x2a8699(0x161)+_0x137ca6+_0x2a8699(0x149));}catch(_0x326474){console[_0x2a8699(0x17b)](_0x2a8699(0x132),_0x326474);}}async[a9_0x2925ef(0x13a)](_0x42bc87,_0x157a06){var _0x37529f=a9_0x2925ef;try{const {id:_0xe1f6c1}=_0x42bc87[_0x37529f(0x16e)];if(!_0xe1f6c1){_0x157a06[_0x37529f(0x14f)](0x190)[_0x37529f(0x13c)]({'success':![],'message':_0x37529f(0x158)});return;}console['log']('üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20'+_0xe1f6c1);const _0x35f102=await database_1[_0x37529f(0x152)]['payment']['findFirst']({'where':{'OR':[{'id':_0xe1f6c1},{'orderId':_0xe1f6c1},{'gatewayOrderId':_0xe1f6c1},{'gatewayPaymentId':_0xe1f6c1}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x35f102){_0x157a06['status'](0x194)[_0x37529f(0x13c)]({'success':![],'message':'Payment\x20not\x20found'});return;}console[_0x37529f(0x137)](_0x37529f(0x133)+_0x35f102['id']+'\x20('+_0x35f102['status']+')'),_0x157a06[_0x37529f(0x13c)]({'success':!![],'data':{'id':_0x35f102['id'],'gateway':_0x35f102[_0x37529f(0x159)],'amount':_0x35f102[_0x37529f(0x16d)],'currency':_0x35f102[_0x37529f(0x166)],'status':_0x35f102[_0x37529f(0x14f)],'gatewayOrderId':_0x35f102['gatewayOrderId'],'gatewayPaymentId':_0x35f102[_0x37529f(0x146)],'successUrl':_0x35f102[_0x37529f(0x134)],'failUrl':_0x35f102[_0x37529f(0x14a)],'pendingUrl':_0x35f102[_0x37529f(0x15d)],'customerEmail':_0x35f102[_0x37529f(0x144)],'customerName':_0x35f102[_0x37529f(0x13b)],'merchantBrand':_0x35f102['shop'][_0x37529f(0x17f)],'createdAt':_0x35f102[_0x37529f(0x140)],'updatedAt':_0x35f102[_0x37529f(0x13f)]}});}catch(_0x281964){console[_0x37529f(0x17b)](_0x37529f(0x13d),_0x281964),_0x157a06['status'](0x1f4)[_0x37529f(0x13c)]({'success':![],'message':_0x37529f(0x177),'error':_0x281964 instanceof Error?_0x281964[_0x37529f(0x168)]:_0x37529f(0x16b)});}}}exports['OnRampController']=OnRampController;