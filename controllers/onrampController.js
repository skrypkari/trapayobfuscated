'use strict';var a13_0x1f777e=a13_0x8df8;(function(_0x217eff,_0x506a86){var _0x5d13c5=a13_0x8df8,_0x3f0efb=_0x217eff();while(!![]){try{var _0x5223d9=-parseInt(_0x5d13c5(0x1fa))/0x1+parseInt(_0x5d13c5(0x1fe))/0x2+parseInt(_0x5d13c5(0x20e))/0x3+-parseInt(_0x5d13c5(0x1e4))/0x4+-parseInt(_0x5d13c5(0x1fb))/0x5*(parseInt(_0x5d13c5(0x1da))/0x6)+-parseInt(_0x5d13c5(0x1e6))/0x7+parseInt(_0x5d13c5(0x201))/0x8;if(_0x5223d9===_0x506a86)break;else _0x3f0efb['push'](_0x3f0efb['shift']());}catch(_0x177250){_0x3f0efb['push'](_0x3f0efb['shift']());}}}(a13_0x3594,0xc706c));function a13_0x8df8(_0x597bb5,_0x2ffe87){_0x597bb5=_0x597bb5-0x1cc;var _0x359476=a13_0x3594();var _0x8df8d=_0x359476[_0x597bb5];return _0x8df8d;}var __createBinding=this&&this[a13_0x1f777e(0x1d9)]||(Object['create']?function(_0x3a759c,_0x43b046,_0x28e9e4,_0xe7faf){var _0x4738f3=a13_0x1f777e;if(_0xe7faf===undefined)_0xe7faf=_0x28e9e4;var _0x4273f1=Object[_0x4738f3(0x1cd)](_0x43b046,_0x28e9e4);(!_0x4273f1||(_0x4738f3(0x202)in _0x4273f1?!_0x43b046[_0x4738f3(0x206)]:_0x4273f1[_0x4738f3(0x1e7)]||_0x4273f1[_0x4738f3(0x1e1)]))&&(_0x4273f1={'enumerable':!![],'get':function(){return _0x43b046[_0x28e9e4];}}),Object[_0x4738f3(0x1d6)](_0x3a759c,_0xe7faf,_0x4273f1);}:function(_0xafeba4,_0x172655,_0x585199,_0x2c0e6e){if(_0x2c0e6e===undefined)_0x2c0e6e=_0x585199;_0xafeba4[_0x2c0e6e]=_0x172655[_0x585199];}),__setModuleDefault=this&&this[a13_0x1f777e(0x1f4)]||(Object[a13_0x1f777e(0x212)]?function(_0x564bd5,_0x2b2fdc){var _0x24f5c2=a13_0x1f777e;Object[_0x24f5c2(0x1d6)](_0x564bd5,'default',{'enumerable':!![],'value':_0x2b2fdc});}:function(_0x580d6e,_0x436705){var _0x9f8fc7=a13_0x1f777e;_0x580d6e[_0x9f8fc7(0x1d2)]=_0x436705;}),__importStar=this&&this[a13_0x1f777e(0x1df)]||(function(){var _0x23fcbe=function(_0x24223c){var _0x171ff9=a13_0x8df8;return _0x23fcbe=Object[_0x171ff9(0x1ec)]||function(_0x57ca15){var _0x2f5025=_0x171ff9,_0x105c95=[];for(var _0x23dfb8 in _0x57ca15)if(Object[_0x2f5025(0x1d0)][_0x2f5025(0x211)]['call'](_0x57ca15,_0x23dfb8))_0x105c95[_0x105c95[_0x2f5025(0x1e3)]]=_0x23dfb8;return _0x105c95;},_0x23fcbe(_0x24223c);};return function(_0x3eaf5f){var _0x58ccd0=a13_0x8df8;if(_0x3eaf5f&&_0x3eaf5f[_0x58ccd0(0x206)])return _0x3eaf5f;var _0x2dcdae={};if(_0x3eaf5f!=null){for(var _0x5bb15e=_0x23fcbe(_0x3eaf5f),_0x4c4ad6=0x0;_0x4c4ad6<_0x5bb15e[_0x58ccd0(0x1e3)];_0x4c4ad6++)if(_0x5bb15e[_0x4c4ad6]!==_0x58ccd0(0x1d2))__createBinding(_0x2dcdae,_0x3eaf5f,_0x5bb15e[_0x4c4ad6]);}return __setModuleDefault(_0x2dcdae,_0x3eaf5f),_0x2dcdae;};}()),__importDefault=this&&this['__importDefault']||function(_0xe01e65){return _0xe01e65&&_0xe01e65['__esModule']?_0xe01e65:{'default':_0xe01e65};};Object[a13_0x1f777e(0x1d6)](exports,a13_0x1f777e(0x206),{'value':!![]}),exports['OnRampController']=void 0x0;const database_1=__importDefault(require('../config/database'));function a13_0x3594(){var _0x2028da=['create','customerEmail','getOwnPropertyDescriptor','params','name','prototype','gatewayOrderId','default','toFixed','invoiceTotalSum','USD','defineProperty','\x20updated\x20to\x20','then','__createBinding','484734DgkUHF','\x20->\x20','toUpperCase','json','getPaymentData','__importStar','customerName','configurable','../services/currencyService','length','1752672RNKnVy','ðŸ”\x20Getting\x20OnRamp\x20payment\x20data:\x20','8582427MfLxRp','writable','ðŸ“\x20Data:','Payment\x20not\x20found','âŒ\x20Failed\x20to\x20update\x20merchant\x20balance:','onramp_system','getOwnPropertyNames','error','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','successUrl','findFirst','âŒ\x20OnRamp\x20get\x20payment\x20data\x20error:','amount','shopId','__setModuleDefault','PAID','updateMerchantBalanceForPaidPayment','convertToUSDT','Payment\x20ID\x20and\x20status\x20are\x20required','body','1389281tuEzpj','35lmMNeD','update','pendingUrl','905942uHKHzG','\x20USDT\x20(after\x20','status','28594800JEIiSf','get','%\x20commission)','log','shop','__esModule','gateway','Payment\x20status\x20updated\x20successfully','createdAt','payment','gatewayPaymentId','âœ…\x20Found\x20payment:\x20','ðŸš€\x20OnRamp\x20status\x20update:\x20','1220772IwjMUL','currency','message','hasOwnProperty'];a13_0x3594=function(){return _0x2028da;};return a13_0x3594();}class OnRampController{async['updatePaymentStatus'](_0x2a3cea,_0x3de57f){var _0x1adacd=a13_0x1f777e;try{const {paymentId:_0x4f7f3d,status:_0x3b0253,referenceId:_0x33abe1,transactionHash:_0x5b6415,actualCryptoAmount:_0xeab82d,orderId:_0x133bd9}=_0x2a3cea[_0x1adacd(0x1f9)];if(!_0x4f7f3d||!_0x3b0253){_0x3de57f[_0x1adacd(0x200)](0x190)[_0x1adacd(0x1dd)]({'success':![],'message':_0x1adacd(0x1f8)});return;}console[_0x1adacd(0x204)](_0x1adacd(0x20d)+_0x4f7f3d+_0x1adacd(0x1db)+_0x3b0253),console[_0x1adacd(0x204)](_0x1adacd(0x1e8),{'referenceId':_0x33abe1,'transactionHash':_0x5b6415,'actualCryptoAmount':_0xeab82d,'orderId':_0x133bd9});const _0x5c1d62=await database_1['default']['payment']['findFirst']({'where':{'OR':[{'id':_0x4f7f3d},{'orderId':_0x4f7f3d},{'gatewayOrderId':_0x4f7f3d},{'gatewayPaymentId':_0x4f7f3d}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x5c1d62){_0x3de57f[_0x1adacd(0x200)](0x194)[_0x1adacd(0x1dd)]({'success':![],'message':_0x1adacd(0x1e9)});return;}if(_0x5c1d62[_0x1adacd(0x207)]!=='onramp'){_0x3de57f[_0x1adacd(0x200)](0x190)[_0x1adacd(0x1dd)]({'success':![],'message':_0x1adacd(0x1ee)});return;}const _0x53693b={'status':_0x3b0253[_0x1adacd(0x1dc)](),'statusChangedAt':new Date(),'statusChangedBy':_0x1adacd(0x1eb)};_0x33abe1&&(_0x53693b['gatewayOrderId']=_0x33abe1);_0x5b6415&&(_0x53693b[_0x1adacd(0x20b)]=_0x5b6415);_0xeab82d&&(_0x53693b[_0x1adacd(0x1d4)]=_0xeab82d);const _0x49bb79=await database_1[_0x1adacd(0x1d2)][_0x1adacd(0x20a)][_0x1adacd(0x1fc)]({'where':{'id':_0x5c1d62['id']},'data':_0x53693b});console[_0x1adacd(0x204)]('âœ…\x20OnRamp\x20payment\x20'+_0x5c1d62['id']+_0x1adacd(0x1d7)+_0x3b0253),_0x3b0253[_0x1adacd(0x1dc)]()===_0x1adacd(0x1f5)&&_0x5c1d62['status']!==_0x1adacd(0x1f5)&&await this[_0x1adacd(0x1f6)](_0x5c1d62),_0x3de57f[_0x1adacd(0x1dd)]({'success':!![],'message':_0x1adacd(0x208),'data':{'paymentId':_0x49bb79['id'],'status':_0x49bb79[_0x1adacd(0x200)],'referenceId':_0x33abe1,'transactionHash':_0x5b6415,'actualCryptoAmount':_0xeab82d}});}catch(_0x576409){console[_0x1adacd(0x1ed)]('âŒ\x20OnRamp\x20status\x20update\x20error:',_0x576409),_0x3de57f[_0x1adacd(0x200)](0x1f4)[_0x1adacd(0x1dd)]({'success':![],'message':'Internal\x20server\x20error','error':_0x576409 instanceof Error?_0x576409[_0x1adacd(0x210)]:'Unknown\x20error'});}}async['updateMerchantBalanceForPaidPayment'](_0x561a31){var _0x1965e3=a13_0x1f777e;try{console[_0x1965e3(0x204)]('ðŸ’°\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20'+_0x561a31['id']);let _0x2e0e21;if(_0x561a31[_0x1965e3(0x20f)]===_0x1965e3(0x1d5))_0x2e0e21=_0x561a31[_0x1965e3(0x1f2)];else{const {currencyService:_0x35b0db}=await Promise['resolve']()[_0x1965e3(0x1d8)](()=>__importStar(require(_0x1965e3(0x1e2))));_0x2e0e21=await _0x35b0db[_0x1965e3(0x1f7)](_0x561a31[_0x1965e3(0x1f2)],_0x561a31['currency']);}await database_1[_0x1965e3(0x1d2)][_0x1965e3(0x20a)][_0x1965e3(0x1fc)]({'where':{'id':_0x561a31['id']},'data':{'amountUSDT':_0x2e0e21,'paidAt':new Date()}});const _0x1396e7=0xa,_0x7168a4=_0x2e0e21*(0x1-_0x1396e7/0x64);await database_1[_0x1965e3(0x1d2)][_0x1965e3(0x205)][_0x1965e3(0x1fc)]({'where':{'id':_0x561a31[_0x1965e3(0x1f3)]},'data':{'balance':{'increment':_0x7168a4}}}),console['log']('âœ…\x20Merchant\x20balance\x20updated:\x20+'+_0x7168a4[_0x1965e3(0x1d3)](0x6)+_0x1965e3(0x1ff)+_0x1396e7+_0x1965e3(0x203));}catch(_0x42bf54){console['error'](_0x1965e3(0x1ea),_0x42bf54);}}async[a13_0x1f777e(0x1de)](_0x51c68f,_0x191fd2){var _0x5d16e8=a13_0x1f777e;try{const {id:_0x409dc0}=_0x51c68f[_0x5d16e8(0x1ce)];if(!_0x409dc0){_0x191fd2[_0x5d16e8(0x200)](0x190)[_0x5d16e8(0x1dd)]({'success':![],'message':'Payment\x20ID\x20is\x20required'});return;}console[_0x5d16e8(0x204)](_0x5d16e8(0x1e5)+_0x409dc0);const _0x12580c=await database_1[_0x5d16e8(0x1d2)]['payment'][_0x5d16e8(0x1f0)]({'where':{'OR':[{'id':_0x409dc0},{'orderId':_0x409dc0},{'gatewayOrderId':_0x409dc0},{'gatewayPaymentId':_0x409dc0}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x12580c){_0x191fd2[_0x5d16e8(0x200)](0x194)[_0x5d16e8(0x1dd)]({'success':![],'message':'Payment\x20not\x20found'});return;}console['log'](_0x5d16e8(0x20c)+_0x12580c['id']+'\x20('+_0x12580c[_0x5d16e8(0x200)]+')'),_0x191fd2[_0x5d16e8(0x1dd)]({'success':!![],'data':{'id':_0x12580c['id'],'gateway':_0x12580c['gateway'],'amount':_0x12580c[_0x5d16e8(0x1f2)],'currency':_0x12580c[_0x5d16e8(0x20f)],'status':_0x12580c[_0x5d16e8(0x200)],'gatewayOrderId':_0x12580c[_0x5d16e8(0x1d1)],'gatewayPaymentId':_0x12580c[_0x5d16e8(0x20b)],'successUrl':_0x12580c[_0x5d16e8(0x1ef)],'failUrl':_0x12580c['failUrl'],'pendingUrl':_0x12580c[_0x5d16e8(0x1fd)],'customerEmail':_0x12580c[_0x5d16e8(0x1cc)],'customerName':_0x12580c[_0x5d16e8(0x1e0)],'merchantBrand':_0x12580c[_0x5d16e8(0x205)][_0x5d16e8(0x1cf)],'createdAt':_0x12580c[_0x5d16e8(0x209)],'updatedAt':_0x12580c['updatedAt']}});}catch(_0x5f0abf){console[_0x5d16e8(0x1ed)](_0x5d16e8(0x1f1),_0x5f0abf),_0x191fd2[_0x5d16e8(0x200)](0x1f4)['json']({'success':![],'message':'Internal\x20server\x20error','error':_0x5f0abf instanceof Error?_0x5f0abf['message']:'Unknown\x20error'});}}}exports['OnRampController']=OnRampController;