'use strict';var a13_0x40b84f=a13_0x3ff1;(function(_0x2d3e59,_0x428c09){var _0x15155f=a13_0x3ff1,_0x39dfa6=_0x2d3e59();while(!![]){try{var _0xb25376=-parseInt(_0x15155f(0xf7))/0x1*(parseInt(_0x15155f(0x117))/0x2)+parseInt(_0x15155f(0x138))/0x3*(parseInt(_0x15155f(0xf1))/0x4)+parseInt(_0x15155f(0x11e))/0x5*(parseInt(_0x15155f(0x128))/0x6)+-parseInt(_0x15155f(0x100))/0x7*(parseInt(_0x15155f(0x103))/0x8)+parseInt(_0x15155f(0x114))/0x9+parseInt(_0x15155f(0x10e))/0xa*(-parseInt(_0x15155f(0xee))/0xb)+parseInt(_0x15155f(0x132))/0xc*(parseInt(_0x15155f(0x10a))/0xd);if(_0xb25376===_0x428c09)break;else _0x39dfa6['push'](_0x39dfa6['shift']());}catch(_0x3ebe2d){_0x39dfa6['push'](_0x39dfa6['shift']());}}}(a13_0x3e2a,0x38622));function a13_0x3ff1(_0xd51022,_0x30929f){_0xd51022=_0xd51022-0xee;var _0x3e2a88=a13_0x3e2a();var _0x3ff11d=_0x3e2a88[_0xd51022];return _0x3ff11d;}function a13_0x3e2a(){var _0x6ae36=['defineProperty','update','879155GGcyQE','Unknown\x20error','call','length','payment','__setModuleDefault','body','gatewayOrderId','üìù\x20Data:','then','12MezHLC','onramp_system','create','PAID','currency','error','__importDefault','getOwnPropertyDescriptor','findFirst','gateway','95892KTIUeF','amount','OnRampController','message','updateMerchantBalanceForPaidPayment','log','48ahXXWQ','23089uVoZWc','successUrl','__esModule','49148ckwzvL','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','shop','get','updatePaymentStatus','Payment\x20not\x20found','311XKQqrd','../services/currencyService','toUpperCase','‚ùå\x20OnRamp\x20status\x20update\x20error:','%\x20commission)','customerName','convertToUSDT','‚úÖ\x20OnRamp\x20payment\x20','customerEmail','21bvNRPJ','params','__createBinding','790424UjLUba','getPaymentData','Payment\x20ID\x20is\x20required','json','failUrl','createdAt','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','715rfbDBf','Internal\x20server\x20error','\x20->\x20','writable','1680dKGSbq','default','Payment\x20ID\x20and\x20status\x20are\x20required','../config/database','‚úÖ\x20Found\x20payment:\x20','resolve','9702wFhtee','updatedAt','status','700xrUXkB','hasOwnProperty','üöÄ\x20OnRamp\x20status\x20update:\x20','Payment\x20status\x20updated\x20successfully','gatewayPaymentId'];a13_0x3e2a=function(){return _0x6ae36;};return a13_0x3e2a();}var __createBinding=this&&this[a13_0x40b84f(0x102)]||(Object['create']?function(_0x43102a,_0x4fbc69,_0x59489e,_0x1c3766){var _0x54aa20=a13_0x40b84f;if(_0x1c3766===undefined)_0x1c3766=_0x59489e;var _0x541659=Object[_0x54aa20(0x12f)](_0x4fbc69,_0x59489e);(!_0x541659||(_0x54aa20(0xf4)in _0x541659?!_0x4fbc69[_0x54aa20(0xf0)]:_0x541659[_0x54aa20(0x10d)]||_0x541659['configurable']))&&(_0x541659={'enumerable':!![],'get':function(){return _0x4fbc69[_0x59489e];}}),Object['defineProperty'](_0x43102a,_0x1c3766,_0x541659);}:function(_0x3e663f,_0x13ef4a,_0x93c574,_0x3fbd7f){if(_0x3fbd7f===undefined)_0x3fbd7f=_0x93c574;_0x3e663f[_0x3fbd7f]=_0x13ef4a[_0x93c574];}),__setModuleDefault=this&&this[a13_0x40b84f(0x123)]||(Object[a13_0x40b84f(0x12a)]?function(_0x582755,_0x2c2dad){var _0x745e22=a13_0x40b84f;Object['defineProperty'](_0x582755,_0x745e22(0x10f),{'enumerable':!![],'value':_0x2c2dad});}:function(_0xb46a00,_0x421572){var _0x206d43=a13_0x40b84f;_0xb46a00[_0x206d43(0x10f)]=_0x421572;}),__importStar=this&&this['__importStar']||(function(){var _0x41722d=function(_0x5703b8){return _0x41722d=Object['getOwnPropertyNames']||function(_0x43b617){var _0x546ea3=a13_0x3ff1,_0x2a7fdf=[];for(var _0x52a07d in _0x43b617)if(Object['prototype'][_0x546ea3(0x118)][_0x546ea3(0x120)](_0x43b617,_0x52a07d))_0x2a7fdf[_0x2a7fdf['length']]=_0x52a07d;return _0x2a7fdf;},_0x41722d(_0x5703b8);};return function(_0x2d156c){var _0x2039c7=a13_0x3ff1;if(_0x2d156c&&_0x2d156c[_0x2039c7(0xf0)])return _0x2d156c;var _0x3ce125={};if(_0x2d156c!=null){for(var _0x4757ef=_0x41722d(_0x2d156c),_0x587d77=0x0;_0x587d77<_0x4757ef[_0x2039c7(0x121)];_0x587d77++)if(_0x4757ef[_0x587d77]!=='default')__createBinding(_0x3ce125,_0x2d156c,_0x4757ef[_0x587d77]);}return __setModuleDefault(_0x3ce125,_0x2d156c),_0x3ce125;};}()),__importDefault=this&&this[a13_0x40b84f(0x12e)]||function(_0x2fbc5c){var _0x5dd126=a13_0x40b84f;return _0x2fbc5c&&_0x2fbc5c[_0x5dd126(0xf0)]?_0x2fbc5c:{'default':_0x2fbc5c};};Object[a13_0x40b84f(0x11c)](exports,a13_0x40b84f(0xf0),{'value':!![]}),exports['OnRampController']=void 0x0;const database_1=__importDefault(require(a13_0x40b84f(0x111)));class OnRampController{async[a13_0x40b84f(0xf5)](_0x35e9e8,_0x44bfef){var _0x3f971e=a13_0x40b84f;try{const {paymentId:_0x918ae,status:_0x8ffdcd,referenceId:_0xe53f1e,transactionHash:_0x28a6f0,actualCryptoAmount:_0x42e8a9,orderId:_0x163f8b}=_0x35e9e8[_0x3f971e(0x124)];if(!_0x918ae||!_0x8ffdcd){_0x44bfef[_0x3f971e(0x116)](0x190)['json']({'success':![],'message':_0x3f971e(0x110)});return;}console[_0x3f971e(0x137)](_0x3f971e(0x119)+_0x918ae+_0x3f971e(0x10c)+_0x8ffdcd),console[_0x3f971e(0x137)](_0x3f971e(0x126),{'referenceId':_0xe53f1e,'transactionHash':_0x28a6f0,'actualCryptoAmount':_0x42e8a9,'orderId':_0x163f8b});const _0x2dd641=await database_1['default'][_0x3f971e(0x122)][_0x3f971e(0x130)]({'where':{'OR':[{'id':_0x918ae},{'orderId':_0x918ae},{'gatewayOrderId':_0x918ae},{'gatewayPaymentId':_0x918ae}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x2dd641){_0x44bfef[_0x3f971e(0x116)](0x194)[_0x3f971e(0x106)]({'success':![],'message':'Payment\x20not\x20found'});return;}if(_0x2dd641[_0x3f971e(0x131)]!=='onramp'){_0x44bfef[_0x3f971e(0x116)](0x190)[_0x3f971e(0x106)]({'success':![],'message':'This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway'});return;}const _0x264bbe={'status':_0x8ffdcd[_0x3f971e(0xf9)](),'statusChangedAt':new Date(),'statusChangedBy':_0x3f971e(0x129)};_0xe53f1e&&(_0x264bbe[_0x3f971e(0x125)]=_0xe53f1e);_0x28a6f0&&(_0x264bbe[_0x3f971e(0x11b)]=_0x28a6f0);_0x42e8a9&&(_0x264bbe['invoiceTotalSum']=_0x42e8a9);const _0x41f06c=await database_1[_0x3f971e(0x10f)][_0x3f971e(0x122)]['update']({'where':{'id':_0x2dd641['id']},'data':_0x264bbe});console[_0x3f971e(0x137)](_0x3f971e(0xfe)+_0x2dd641['id']+'\x20updated\x20to\x20'+_0x8ffdcd),_0x8ffdcd[_0x3f971e(0xf9)]()===_0x3f971e(0x12b)&&_0x2dd641['status']!==_0x3f971e(0x12b)&&await this[_0x3f971e(0x136)](_0x2dd641),_0x44bfef[_0x3f971e(0x106)]({'success':!![],'message':_0x3f971e(0x11a),'data':{'paymentId':_0x41f06c['id'],'status':_0x41f06c['status'],'referenceId':_0xe53f1e,'transactionHash':_0x28a6f0,'actualCryptoAmount':_0x42e8a9}});}catch(_0x224a9d){console[_0x3f971e(0x12d)](_0x3f971e(0xfa),_0x224a9d),_0x44bfef['status'](0x1f4)['json']({'success':![],'message':_0x3f971e(0x10b),'error':_0x224a9d instanceof Error?_0x224a9d[_0x3f971e(0x135)]:_0x3f971e(0x11f)});}}async['updateMerchantBalanceForPaidPayment'](_0x5ca78e){var _0x19fc9c=a13_0x40b84f;try{console[_0x19fc9c(0x137)]('üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20'+_0x5ca78e['id']);let _0x740d63;if(_0x5ca78e['currency']==='USD')_0x740d63=_0x5ca78e[_0x19fc9c(0x133)];else{const {currencyService:_0x3a72f6}=await Promise[_0x19fc9c(0x113)]()[_0x19fc9c(0x127)](()=>__importStar(require(_0x19fc9c(0xf8))));_0x740d63=await _0x3a72f6[_0x19fc9c(0xfd)](_0x5ca78e['amount'],_0x5ca78e[_0x19fc9c(0x12c)]);}await database_1['default'][_0x19fc9c(0x122)]['update']({'where':{'id':_0x5ca78e['id']},'data':{'amountUSDT':_0x740d63,'paidAt':new Date()}});const _0x40fefe=0xa,_0x3d8fbf=_0x740d63*(0x1-_0x40fefe/0x64);await database_1['default'][_0x19fc9c(0xf3)][_0x19fc9c(0x11d)]({'where':{'id':_0x5ca78e['shopId']},'data':{'balance':{'increment':_0x3d8fbf}}}),console['log'](_0x19fc9c(0xf2)+_0x3d8fbf['toFixed'](0x6)+'\x20USDT\x20(after\x20'+_0x40fefe+_0x19fc9c(0xfb));}catch(_0x5e450d){console['error'](_0x19fc9c(0x109),_0x5e450d);}}async[a13_0x40b84f(0x104)](_0x60941a,_0x2ed108){var _0x121b42=a13_0x40b84f;try{const {id:_0x2cf0ae}=_0x60941a[_0x121b42(0x101)];if(!_0x2cf0ae){_0x2ed108[_0x121b42(0x116)](0x190)['json']({'success':![],'message':_0x121b42(0x105)});return;}console[_0x121b42(0x137)]('üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20'+_0x2cf0ae);const _0x510bdb=await database_1[_0x121b42(0x10f)][_0x121b42(0x122)][_0x121b42(0x130)]({'where':{'OR':[{'id':_0x2cf0ae},{'orderId':_0x2cf0ae},{'gatewayOrderId':_0x2cf0ae},{'gatewayPaymentId':_0x2cf0ae}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x510bdb){_0x2ed108[_0x121b42(0x116)](0x194)[_0x121b42(0x106)]({'success':![],'message':_0x121b42(0xf6)});return;}console[_0x121b42(0x137)](_0x121b42(0x112)+_0x510bdb['id']+'\x20('+_0x510bdb[_0x121b42(0x116)]+')'),_0x2ed108[_0x121b42(0x106)]({'success':!![],'data':{'id':_0x510bdb['id'],'gateway':_0x510bdb[_0x121b42(0x131)],'amount':_0x510bdb[_0x121b42(0x133)],'currency':_0x510bdb[_0x121b42(0x12c)],'status':_0x510bdb[_0x121b42(0x116)],'gatewayOrderId':_0x510bdb[_0x121b42(0x125)],'gatewayPaymentId':_0x510bdb[_0x121b42(0x11b)],'successUrl':_0x510bdb[_0x121b42(0xef)],'failUrl':_0x510bdb[_0x121b42(0x107)],'pendingUrl':_0x510bdb['pendingUrl'],'customerEmail':_0x510bdb[_0x121b42(0xff)],'customerName':_0x510bdb[_0x121b42(0xfc)],'merchantBrand':_0x510bdb[_0x121b42(0xf3)]['name'],'createdAt':_0x510bdb[_0x121b42(0x108)],'updatedAt':_0x510bdb[_0x121b42(0x115)]}});}catch(_0x1ed5fa){console[_0x121b42(0x12d)]('‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:',_0x1ed5fa),_0x2ed108['status'](0x1f4)[_0x121b42(0x106)]({'success':![],'message':_0x121b42(0x10b),'error':_0x1ed5fa instanceof Error?_0x1ed5fa[_0x121b42(0x135)]:_0x121b42(0x11f)});}}}exports[a13_0x40b84f(0x134)]=OnRampController;