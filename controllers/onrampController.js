'use strict';var a9_0xd384bb=a9_0xccac;(function(_0x144f2c,_0x5458af){var _0xbb54f=a9_0xccac,_0x3c684c=_0x144f2c();while(!![]){try{var _0x53f568=parseInt(_0xbb54f(0x184))/0x1+parseInt(_0xbb54f(0x1ac))/0x2+-parseInt(_0xbb54f(0x1ae))/0x3+-parseInt(_0xbb54f(0x181))/0x4+-parseInt(_0xbb54f(0x190))/0x5*(-parseInt(_0xbb54f(0x16b))/0x6)+-parseInt(_0xbb54f(0x17c))/0x7+parseInt(_0xbb54f(0x18c))/0x8*(-parseInt(_0xbb54f(0x173))/0x9);if(_0x53f568===_0x5458af)break;else _0x3c684c['push'](_0x3c684c['shift']());}catch(_0x57a46a){_0x3c684c['push'](_0x3c684c['shift']());}}}(a9_0x473b,0x9f2ed));function a9_0xccac(_0x4c2395,_0x3be645){var _0x473bc8=a9_0x473b();return a9_0xccac=function(_0xccacf0,_0x2c890d){_0xccacf0=_0xccacf0-0x167;var _0x5544f8=_0x473bc8[_0xccacf0];return _0x5544f8;},a9_0xccac(_0x4c2395,_0x3be645);}var __createBinding=this&&this[a9_0xd384bb(0x188)]||(Object[a9_0xd384bb(0x1a0)]?function(_0x44c108,_0x2a42b2,_0x53abb5,_0x53a05d){var _0x3c07cb=a9_0xd384bb;if(_0x53a05d===undefined)_0x53a05d=_0x53abb5;var _0xd2ee9e=Object[_0x3c07cb(0x183)](_0x2a42b2,_0x53abb5);(!_0xd2ee9e||(_0x3c07cb(0x1ad)in _0xd2ee9e?!_0x2a42b2[_0x3c07cb(0x185)]:_0xd2ee9e['writable']||_0xd2ee9e[_0x3c07cb(0x168)]))&&(_0xd2ee9e={'enumerable':!![],'get':function(){return _0x2a42b2[_0x53abb5];}}),Object[_0x3c07cb(0x19f)](_0x44c108,_0x53a05d,_0xd2ee9e);}:function(_0x271e44,_0x1d7f26,_0x4db341,_0x55f36a){if(_0x55f36a===undefined)_0x55f36a=_0x4db341;_0x271e44[_0x55f36a]=_0x1d7f26[_0x4db341];}),__setModuleDefault=this&&this[a9_0xd384bb(0x1a2)]||(Object[a9_0xd384bb(0x1a0)]?function(_0x7575d0,_0x296edb){var _0x9626a2=a9_0xd384bb;Object[_0x9626a2(0x19f)](_0x7575d0,_0x9626a2(0x191),{'enumerable':!![],'value':_0x296edb});}:function(_0x4cf794,_0x3f68e1){var _0x3a360a=a9_0xd384bb;_0x4cf794[_0x3a360a(0x191)]=_0x3f68e1;}),__importStar=this&&this[a9_0xd384bb(0x196)]||(function(){var _0x106b64=function(_0x25aef0){var _0x533f9e=a9_0xccac;return _0x106b64=Object[_0x533f9e(0x1a9)]||function(_0x3e5d3a){var _0x2b594c=_0x533f9e,_0x15d670=[];for(var _0x3d6bde in _0x3e5d3a)if(Object['prototype'][_0x2b594c(0x1a7)][_0x2b594c(0x18b)](_0x3e5d3a,_0x3d6bde))_0x15d670[_0x15d670['length']]=_0x3d6bde;return _0x15d670;},_0x106b64(_0x25aef0);};return function(_0x141606){var _0x13d394=a9_0xccac;if(_0x141606&&_0x141606[_0x13d394(0x185)])return _0x141606;var _0x1accf6={};if(_0x141606!=null){for(var _0x48dea2=_0x106b64(_0x141606),_0x30ff83=0x0;_0x30ff83<_0x48dea2[_0x13d394(0x19b)];_0x30ff83++)if(_0x48dea2[_0x30ff83]!==_0x13d394(0x191))__createBinding(_0x1accf6,_0x141606,_0x48dea2[_0x30ff83]);}return __setModuleDefault(_0x1accf6,_0x141606),_0x1accf6;};}()),__importDefault=this&&this[a9_0xd384bb(0x167)]||function(_0x5de950){var _0xb2e285=a9_0xd384bb;return _0x5de950&&_0x5de950[_0xb2e285(0x185)]?_0x5de950:{'default':_0x5de950};};function a9_0x473b(){var _0x17f197=['pendingUrl','1014412gDwpQm','shopId','invoiceTotalSum','\x20updated\x20to\x20','name','2250432xPgzFU','amount','getOwnPropertyDescriptor','1131216QIPJNH','__esModule','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','currency','__createBinding','gatewayPaymentId','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','call','44680AbZFHT','Unknown\x20error','status','Payment\x20not\x20found','1410UeiPJe','default','\x20->\x20','message','%\x20commission)','üìù\x20Data:','__importStar','updatePaymentStatus','json','OnRampController','‚úÖ\x20Found\x20payment:\x20','length','gateway','convertToUSDT','onramp','defineProperty','create','customerName','__setModuleDefault','shop','successUrl','findFirst','update','hasOwnProperty','updateMerchantBalanceForPaidPayment','getOwnPropertyNames','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','toUpperCase','2025844jlqUPw','get','2906154IbNFEd','../services/currencyService','__importDefault','configurable','Payment\x20status\x20updated\x20successfully','Internal\x20server\x20error','11166EyHNzW','toFixed','gatewayOrderId','body','‚úÖ\x20OnRamp\x20payment\x20','\x20USDT\x20(after\x20','failUrl','log','549zHvvBI','updatedAt','PAID','error','üöÄ\x20OnRamp\x20status\x20update:\x20','Payment\x20ID\x20and\x20status\x20are\x20required','params','payment'];a9_0x473b=function(){return _0x17f197;};return a9_0x473b();}Object[a9_0xd384bb(0x19f)](exports,a9_0xd384bb(0x185),{'value':!![]}),exports[a9_0xd384bb(0x199)]=void 0x0;const database_1=__importDefault(require('../config/database'));class OnRampController{async[a9_0xd384bb(0x197)](_0x4d74b8,_0x565c0f){var _0x4e57d7=a9_0xd384bb;try{const {paymentId:_0x764a3c,status:_0x1dafc0,referenceId:_0xd92f1c,transactionHash:_0x21fc0a,actualCryptoAmount:_0x5ce831,orderId:_0x5d18e3}=_0x4d74b8[_0x4e57d7(0x16e)];if(!_0x764a3c||!_0x1dafc0){_0x565c0f['status'](0x190)['json']({'success':![],'message':_0x4e57d7(0x178)});return;}console['log'](_0x4e57d7(0x177)+_0x764a3c+_0x4e57d7(0x192)+_0x1dafc0),console[_0x4e57d7(0x172)](_0x4e57d7(0x195),{'referenceId':_0xd92f1c,'transactionHash':_0x21fc0a,'actualCryptoAmount':_0x5ce831,'orderId':_0x5d18e3});const _0x1b3f5b=await database_1[_0x4e57d7(0x191)][_0x4e57d7(0x17a)][_0x4e57d7(0x1a5)]({'where':{'OR':[{'id':_0x764a3c},{'orderId':_0x764a3c},{'gatewayOrderId':_0x764a3c},{'gatewayPaymentId':_0x764a3c}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x1b3f5b){_0x565c0f['status'](0x194)[_0x4e57d7(0x198)]({'success':![],'message':_0x4e57d7(0x18f)});return;}if(_0x1b3f5b['gateway']!==_0x4e57d7(0x19e)){_0x565c0f[_0x4e57d7(0x18e)](0x190)[_0x4e57d7(0x198)]({'success':![],'message':_0x4e57d7(0x186)});return;}const _0x4259ca={'status':_0x1dafc0[_0x4e57d7(0x1ab)](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0xd92f1c&&(_0x4259ca[_0x4e57d7(0x16d)]=_0xd92f1c);_0x21fc0a&&(_0x4259ca[_0x4e57d7(0x189)]=_0x21fc0a);_0x5ce831&&(_0x4259ca[_0x4e57d7(0x17e)]=_0x5ce831);const _0x3f4487=await database_1[_0x4e57d7(0x191)][_0x4e57d7(0x17a)][_0x4e57d7(0x1a6)]({'where':{'id':_0x1b3f5b['id']},'data':_0x4259ca});console['log'](_0x4e57d7(0x16f)+_0x1b3f5b['id']+_0x4e57d7(0x17f)+_0x1dafc0),_0x1dafc0[_0x4e57d7(0x1ab)]()===_0x4e57d7(0x175)&&_0x1b3f5b['status']!==_0x4e57d7(0x175)&&await this['updateMerchantBalanceForPaidPayment'](_0x1b3f5b),_0x565c0f[_0x4e57d7(0x198)]({'success':!![],'message':_0x4e57d7(0x169),'data':{'paymentId':_0x3f4487['id'],'status':_0x3f4487[_0x4e57d7(0x18e)],'referenceId':_0xd92f1c,'transactionHash':_0x21fc0a,'actualCryptoAmount':_0x5ce831}});}catch(_0x56d68d){console[_0x4e57d7(0x176)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x56d68d),_0x565c0f[_0x4e57d7(0x18e)](0x1f4)['json']({'success':![],'message':_0x4e57d7(0x16a),'error':_0x56d68d instanceof Error?_0x56d68d[_0x4e57d7(0x193)]:_0x4e57d7(0x18d)});}}async[a9_0xd384bb(0x1a8)](_0x1353d6){var _0x5df2d2=a9_0xd384bb;try{console[_0x5df2d2(0x172)](_0x5df2d2(0x18a)+_0x1353d6['id']);let _0x532bc8;if(_0x1353d6[_0x5df2d2(0x187)]==='USD')_0x532bc8=_0x1353d6[_0x5df2d2(0x182)];else{const {currencyService:_0x210844}=await Promise['resolve']()['then'](()=>__importStar(require(_0x5df2d2(0x1af))));_0x532bc8=await _0x210844[_0x5df2d2(0x19d)](_0x1353d6[_0x5df2d2(0x182)],_0x1353d6[_0x5df2d2(0x187)]);}await database_1[_0x5df2d2(0x191)][_0x5df2d2(0x17a)][_0x5df2d2(0x1a6)]({'where':{'id':_0x1353d6['id']},'data':{'amountUSDT':_0x532bc8,'paidAt':new Date()}});const _0x24de5f=0xa,_0x2c1a9b=_0x532bc8*(0x1-_0x24de5f/0x64);await database_1[_0x5df2d2(0x191)][_0x5df2d2(0x1a3)]['update']({'where':{'id':_0x1353d6[_0x5df2d2(0x17d)]},'data':{'balance':{'increment':_0x2c1a9b}}}),console[_0x5df2d2(0x172)]('‚úÖ\x20Merchant\x20balance\x20updated:\x20+'+_0x2c1a9b[_0x5df2d2(0x16c)](0x6)+_0x5df2d2(0x170)+_0x24de5f+_0x5df2d2(0x194));}catch(_0x48d861){console[_0x5df2d2(0x176)]('‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:',_0x48d861);}}async['getPaymentData'](_0x23a62e,_0x543045){var _0x1248da=a9_0xd384bb;try{const {id:_0x19aac6}=_0x23a62e[_0x1248da(0x179)];if(!_0x19aac6){_0x543045[_0x1248da(0x18e)](0x190)[_0x1248da(0x198)]({'success':![],'message':'Payment\x20ID\x20is\x20required'});return;}console['log']('üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20'+_0x19aac6);const _0x1f9f53=await database_1[_0x1248da(0x191)][_0x1248da(0x17a)][_0x1248da(0x1a5)]({'where':{'OR':[{'id':_0x19aac6},{'orderId':_0x19aac6},{'gatewayOrderId':_0x19aac6},{'gatewayPaymentId':_0x19aac6}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x1f9f53){_0x543045['status'](0x194)[_0x1248da(0x198)]({'success':![],'message':_0x1248da(0x18f)});return;}console[_0x1248da(0x172)](_0x1248da(0x19a)+_0x1f9f53['id']+'\x20('+_0x1f9f53[_0x1248da(0x18e)]+')'),_0x543045[_0x1248da(0x198)]({'success':!![],'data':{'id':_0x1f9f53['id'],'gateway':_0x1f9f53[_0x1248da(0x19c)],'amount':_0x1f9f53[_0x1248da(0x182)],'currency':_0x1f9f53[_0x1248da(0x187)],'status':_0x1f9f53[_0x1248da(0x18e)],'gatewayOrderId':_0x1f9f53[_0x1248da(0x16d)],'gatewayPaymentId':_0x1f9f53[_0x1248da(0x189)],'successUrl':_0x1f9f53[_0x1248da(0x1a4)],'failUrl':_0x1f9f53[_0x1248da(0x171)],'pendingUrl':_0x1f9f53[_0x1248da(0x17b)],'customerEmail':_0x1f9f53['customerEmail'],'customerName':_0x1f9f53[_0x1248da(0x1a1)],'merchantBrand':_0x1f9f53['shop'][_0x1248da(0x180)],'createdAt':_0x1f9f53['createdAt'],'updatedAt':_0x1f9f53[_0x1248da(0x174)]}});}catch(_0x354ce8){console[_0x1248da(0x176)](_0x1248da(0x1aa),_0x354ce8),_0x543045[_0x1248da(0x18e)](0x1f4)[_0x1248da(0x198)]({'success':![],'message':'Internal\x20server\x20error','error':_0x354ce8 instanceof Error?_0x354ce8[_0x1248da(0x193)]:_0x1248da(0x18d)});}}}exports[a9_0xd384bb(0x199)]=OnRampController;