'use strict';var a9_0x27049f=a9_0x2217;function a9_0x2217(_0xbf9b11,_0xf4f19d){var _0x5f320a=a9_0x5f32();return a9_0x2217=function(_0x2217ff,_0x59ce8f){_0x2217ff=_0x2217ff-0x12d;var _0x1ca610=_0x5f320a[_0x2217ff];return _0x1ca610;},a9_0x2217(_0xbf9b11,_0xf4f19d);}(function(_0x3b3eb0,_0x44a97e){var _0x3cf0c8=a9_0x2217,_0x49b3d4=_0x3b3eb0();while(!![]){try{var _0x6414c9=-parseInt(_0x3cf0c8(0x13e))/0x1*(-parseInt(_0x3cf0c8(0x16d))/0x2)+-parseInt(_0x3cf0c8(0x136))/0x3+parseInt(_0x3cf0c8(0x13f))/0x4*(parseInt(_0x3cf0c8(0x138))/0x5)+-parseInt(_0x3cf0c8(0x154))/0x6*(parseInt(_0x3cf0c8(0x15d))/0x7)+-parseInt(_0x3cf0c8(0x169))/0x8+-parseInt(_0x3cf0c8(0x16b))/0x9+parseInt(_0x3cf0c8(0x134))/0xa;if(_0x6414c9===_0x44a97e)break;else _0x49b3d4['push'](_0x49b3d4['shift']());}catch(_0x2ea3a2){_0x49b3d4['push'](_0x49b3d4['shift']());}}}(a9_0x5f32,0xf3b65));function a9_0x5f32(){var _0x136a93=['getPaymentData','updatePaymentStatus','create','message','then','json','7BcKypt','status','Internal\x20server\x20error','üìù\x20Data:','__setModuleDefault','default','shopId','customerName','customerEmail','name','../services/currencyService','defineProperty','12438304AApLkN','gateway','5893137irRXEz','OnRampController','2432NMbrFe','payment','\x20->\x20','successUrl','gatewayPaymentId','invoiceTotalSum','toUpperCase','‚úÖ\x20Found\x20payment:\x20','‚ùå\x20OnRamp\x20status\x20update\x20error:','update','25947360itOlSm','failUrl','4782777IImTGi','%\x20commission)','10nWmvsR','Payment\x20not\x20found','__importStar','getOwnPropertyNames','currency','gatewayOrderId','1342YefAMQ','1936352DVZieD','__importDefault','Unknown\x20error','USD','length','Payment\x20ID\x20and\x20status\x20are\x20required','configurable','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','PAID','log','__esModule','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','body','shop','error','writable','Payment\x20status\x20updated\x20successfully','call','get','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','findFirst','2356194SgnDed','toFixed','updatedAt'];a9_0x5f32=function(){return _0x136a93;};return a9_0x5f32();}var __createBinding=this&&this['__createBinding']||(Object[a9_0x27049f(0x159)]?function(_0xf98fa9,_0x540770,_0x3fff02,_0x597b1b){var _0x3f5d60=a9_0x27049f;if(_0x597b1b===undefined)_0x597b1b=_0x3fff02;var _0x396ac9=Object['getOwnPropertyDescriptor'](_0x540770,_0x3fff02);(!_0x396ac9||(_0x3f5d60(0x151)in _0x396ac9?!_0x540770['__esModule']:_0x396ac9[_0x3f5d60(0x14e)]||_0x396ac9[_0x3f5d60(0x145)]))&&(_0x396ac9={'enumerable':!![],'get':function(){return _0x540770[_0x3fff02];}}),Object[_0x3f5d60(0x168)](_0xf98fa9,_0x597b1b,_0x396ac9);}:function(_0x23e453,_0x5d6ad9,_0x30b973,_0x4fb2c8){if(_0x4fb2c8===undefined)_0x4fb2c8=_0x30b973;_0x23e453[_0x4fb2c8]=_0x5d6ad9[_0x30b973];}),__setModuleDefault=this&&this[a9_0x27049f(0x161)]||(Object['create']?function(_0x2ec91d,_0x47e6ff){Object['defineProperty'](_0x2ec91d,'default',{'enumerable':!![],'value':_0x47e6ff});}:function(_0x37d45f,_0xd67f2e){var _0x18a997=a9_0x27049f;_0x37d45f[_0x18a997(0x162)]=_0xd67f2e;}),__importStar=this&&this[a9_0x27049f(0x13a)]||(function(){var _0x51c3ce=function(_0x35da90){var _0x311198=a9_0x2217;return _0x51c3ce=Object[_0x311198(0x13b)]||function(_0x25979e){var _0x1b64a0=_0x311198,_0x4f42c8=[];for(var _0x54c8fa in _0x25979e)if(Object['prototype']['hasOwnProperty'][_0x1b64a0(0x150)](_0x25979e,_0x54c8fa))_0x4f42c8[_0x4f42c8[_0x1b64a0(0x143)]]=_0x54c8fa;return _0x4f42c8;},_0x51c3ce(_0x35da90);};return function(_0x1bb46a){var _0x42e2cb=a9_0x2217;if(_0x1bb46a&&_0x1bb46a['__esModule'])return _0x1bb46a;var _0x3b29c6={};if(_0x1bb46a!=null){for(var _0x271c81=_0x51c3ce(_0x1bb46a),_0x21ccf8=0x0;_0x21ccf8<_0x271c81[_0x42e2cb(0x143)];_0x21ccf8++)if(_0x271c81[_0x21ccf8]!==_0x42e2cb(0x162))__createBinding(_0x3b29c6,_0x1bb46a,_0x271c81[_0x21ccf8]);}return __setModuleDefault(_0x3b29c6,_0x1bb46a),_0x3b29c6;};}()),__importDefault=this&&this[a9_0x27049f(0x140)]||function(_0x21469b){var _0x3c72a7=a9_0x27049f;return _0x21469b&&_0x21469b[_0x3c72a7(0x149)]?_0x21469b:{'default':_0x21469b};};Object[a9_0x27049f(0x168)](exports,a9_0x27049f(0x149),{'value':!![]}),exports[a9_0x27049f(0x16c)]=void 0x0;const database_1=__importDefault(require('../config/database'));class OnRampController{async[a9_0x27049f(0x158)](_0x3a765a,_0x4467ba){var _0x14f46c=a9_0x27049f;try{const {paymentId:_0x3ac142,status:_0x37ccf,referenceId:_0x3a9a02,transactionHash:_0x4b440b,actualCryptoAmount:_0x3a48f3,orderId:_0x215959}=_0x3a765a[_0x14f46c(0x14b)];if(!_0x3ac142||!_0x37ccf){_0x4467ba[_0x14f46c(0x15e)](0x190)[_0x14f46c(0x15c)]({'success':![],'message':_0x14f46c(0x144)});return;}console[_0x14f46c(0x148)]('üöÄ\x20OnRamp\x20status\x20update:\x20'+_0x3ac142+_0x14f46c(0x16f)+_0x37ccf),console[_0x14f46c(0x148)](_0x14f46c(0x160),{'referenceId':_0x3a9a02,'transactionHash':_0x4b440b,'actualCryptoAmount':_0x3a48f3,'orderId':_0x215959});const _0x5f4d70=await database_1[_0x14f46c(0x162)][_0x14f46c(0x16e)][_0x14f46c(0x153)]({'where':{'OR':[{'id':_0x3ac142},{'orderId':_0x3ac142},{'gatewayOrderId':_0x3ac142},{'gatewayPaymentId':_0x3ac142}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x5f4d70){_0x4467ba[_0x14f46c(0x15e)](0x194)[_0x14f46c(0x15c)]({'success':![],'message':_0x14f46c(0x139)});return;}if(_0x5f4d70[_0x14f46c(0x16a)]!=='onramp'){_0x4467ba[_0x14f46c(0x15e)](0x190)[_0x14f46c(0x15c)]({'success':![],'message':'This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway'});return;}const _0x502f71={'status':_0x37ccf[_0x14f46c(0x130)](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0x3a9a02&&(_0x502f71[_0x14f46c(0x13d)]=_0x3a9a02);_0x4b440b&&(_0x502f71['gatewayPaymentId']=_0x4b440b);_0x3a48f3&&(_0x502f71[_0x14f46c(0x12f)]=_0x3a48f3);const _0x426805=await database_1[_0x14f46c(0x162)][_0x14f46c(0x16e)][_0x14f46c(0x133)]({'where':{'id':_0x5f4d70['id']},'data':_0x502f71});console['log']('‚úÖ\x20OnRamp\x20payment\x20'+_0x5f4d70['id']+'\x20updated\x20to\x20'+_0x37ccf),_0x37ccf[_0x14f46c(0x130)]()==='PAID'&&_0x5f4d70[_0x14f46c(0x15e)]!==_0x14f46c(0x147)&&await this['updateMerchantBalanceForPaidPayment'](_0x5f4d70),_0x4467ba[_0x14f46c(0x15c)]({'success':!![],'message':_0x14f46c(0x14f),'data':{'paymentId':_0x426805['id'],'status':_0x426805[_0x14f46c(0x15e)],'referenceId':_0x3a9a02,'transactionHash':_0x4b440b,'actualCryptoAmount':_0x3a48f3}});}catch(_0x41990d){console[_0x14f46c(0x14d)](_0x14f46c(0x132),_0x41990d),_0x4467ba[_0x14f46c(0x15e)](0x1f4)[_0x14f46c(0x15c)]({'success':![],'message':_0x14f46c(0x15f),'error':_0x41990d instanceof Error?_0x41990d[_0x14f46c(0x15a)]:_0x14f46c(0x141)});}}async['updateMerchantBalanceForPaidPayment'](_0x47e35b){var _0x573b5d=a9_0x27049f;try{console['log'](_0x573b5d(0x146)+_0x47e35b['id']);let _0x180097;if(_0x47e35b['currency']===_0x573b5d(0x142))_0x180097=_0x47e35b['amount'];else{const {currencyService:_0x40f828}=await Promise['resolve']()[_0x573b5d(0x15b)](()=>__importStar(require(_0x573b5d(0x167))));_0x180097=await _0x40f828['convertToUSDT'](_0x47e35b['amount'],_0x47e35b[_0x573b5d(0x13c)]);}await database_1['default'][_0x573b5d(0x16e)][_0x573b5d(0x133)]({'where':{'id':_0x47e35b['id']},'data':{'amountUSDT':_0x180097,'paidAt':new Date()}});const _0x1ab7d0=0xa,_0xc512a3=_0x180097*(0x1-_0x1ab7d0/0x64);await database_1[_0x573b5d(0x162)][_0x573b5d(0x14c)][_0x573b5d(0x133)]({'where':{'id':_0x47e35b[_0x573b5d(0x163)]},'data':{'balance':{'increment':_0xc512a3}}}),console[_0x573b5d(0x148)](_0x573b5d(0x14a)+_0xc512a3[_0x573b5d(0x155)](0x6)+'\x20USDT\x20(after\x20'+_0x1ab7d0+_0x573b5d(0x137));}catch(_0x1c078f){console[_0x573b5d(0x14d)]('‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:',_0x1c078f);}}async[a9_0x27049f(0x157)](_0x25308f,_0x3c6c5f){var _0x282955=a9_0x27049f;try{const {id:_0x1a90b4}=_0x25308f['params'];if(!_0x1a90b4){_0x3c6c5f[_0x282955(0x15e)](0x190)[_0x282955(0x15c)]({'success':![],'message':'Payment\x20ID\x20is\x20required'});return;}console[_0x282955(0x148)](_0x282955(0x152)+_0x1a90b4);const _0x43f7e2=await database_1[_0x282955(0x162)][_0x282955(0x16e)][_0x282955(0x153)]({'where':{'OR':[{'id':_0x1a90b4},{'orderId':_0x1a90b4},{'gatewayOrderId':_0x1a90b4},{'gatewayPaymentId':_0x1a90b4}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x43f7e2){_0x3c6c5f[_0x282955(0x15e)](0x194)[_0x282955(0x15c)]({'success':![],'message':_0x282955(0x139)});return;}console[_0x282955(0x148)](_0x282955(0x131)+_0x43f7e2['id']+'\x20('+_0x43f7e2[_0x282955(0x15e)]+')'),_0x3c6c5f[_0x282955(0x15c)]({'success':!![],'data':{'id':_0x43f7e2['id'],'gateway':_0x43f7e2[_0x282955(0x16a)],'amount':_0x43f7e2['amount'],'currency':_0x43f7e2['currency'],'status':_0x43f7e2[_0x282955(0x15e)],'gatewayOrderId':_0x43f7e2[_0x282955(0x13d)],'gatewayPaymentId':_0x43f7e2[_0x282955(0x12e)],'successUrl':_0x43f7e2[_0x282955(0x12d)],'failUrl':_0x43f7e2[_0x282955(0x135)],'pendingUrl':_0x43f7e2['pendingUrl'],'customerEmail':_0x43f7e2[_0x282955(0x165)],'customerName':_0x43f7e2[_0x282955(0x164)],'merchantBrand':_0x43f7e2['shop'][_0x282955(0x166)],'createdAt':_0x43f7e2['createdAt'],'updatedAt':_0x43f7e2[_0x282955(0x156)]}});}catch(_0x26409d){console[_0x282955(0x14d)]('‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:',_0x26409d),_0x3c6c5f[_0x282955(0x15e)](0x1f4)[_0x282955(0x15c)]({'success':![],'message':_0x282955(0x15f),'error':_0x26409d instanceof Error?_0x26409d[_0x282955(0x15a)]:_0x282955(0x141)});}}}exports[a9_0x27049f(0x16c)]=OnRampController;