'use strict';function a12_0x3b71(){var _0x4d1695=['gateway','updatePaymentStatus','error','length','name','customerEmail','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','1130004MtaMou','hasOwnProperty','defineProperty','OnRampController','currency','payment','getPaymentData','Unknown\x20error','8814915pAXJID','‚úÖ\x20Found\x20payment:\x20','default','updateMerchantBalanceForPaidPayment','__createBinding','get','%\x20commission)','onramp','\x20USDT\x20(after\x20','writable','params','7138424FfTzTc','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','update','../config/database','then','shop','json','log','toUpperCase','Payment\x20status\x20updated\x20successfully','2925507kzgfYZ','‚úÖ\x20OnRamp\x20payment\x20','\x20updated\x20to\x20','status','1neCOYH','message','1637428ucJVLn','__setModuleDefault','updatedAt','PAID','__importStar','amount','toFixed','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','__esModule','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','createdAt','üìù\x20Data:','üöÄ\x20OnRamp\x20status\x20update:\x20','11264360JgXebV','Internal\x20server\x20error','Payment\x20not\x20found','findFirst','\x20->\x20','getOwnPropertyDescriptor','7rhicti','call','45337815CUwQRf','../services/currencyService','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','gatewayOrderId','gatewayPaymentId','Payment\x20ID\x20and\x20status\x20are\x20required','successUrl','create','USD'];a12_0x3b71=function(){return _0x4d1695;};return a12_0x3b71();}function a12_0x1825(_0x378367,_0xe69926){_0x378367=_0x378367-0x1f1;var _0x3b7127=a12_0x3b71();var _0x1825c1=_0x3b7127[_0x378367];return _0x1825c1;}var a12_0x9b296f=a12_0x1825;(function(_0x5cd8f1,_0x36ba32){var _0x30eb61=a12_0x1825,_0x31e124=_0x5cd8f1();while(!![]){try{var _0x5e483c=parseInt(_0x30eb61(0x224))/0x1*(-parseInt(_0x30eb61(0x226))/0x2)+-parseInt(_0x30eb61(0x220))/0x3+-parseInt(_0x30eb61(0x216))/0x4+-parseInt(_0x30eb61(0x20b))/0x5+-parseInt(_0x30eb61(0x203))/0x6+-parseInt(_0x30eb61(0x1f1))/0x7*(-parseInt(_0x30eb61(0x233))/0x8)+parseInt(_0x30eb61(0x1f3))/0x9;if(_0x5e483c===_0x36ba32)break;else _0x31e124['push'](_0x31e124['shift']());}catch(_0x1352fd){_0x31e124['push'](_0x31e124['shift']());}}}(a12_0x3b71,0xdf93e));var __createBinding=this&&this[a12_0x9b296f(0x20f)]||(Object[a12_0x9b296f(0x1fa)]?function(_0x1d0a2c,_0x287a6f,_0x2fa4f5,_0x143aaa){var _0x51c869=a12_0x9b296f;if(_0x143aaa===undefined)_0x143aaa=_0x2fa4f5;var _0x32e6e7=Object[_0x51c869(0x238)](_0x287a6f,_0x2fa4f5);(!_0x32e6e7||(_0x51c869(0x210)in _0x32e6e7?!_0x287a6f[_0x51c869(0x22e)]:_0x32e6e7[_0x51c869(0x214)]||_0x32e6e7['configurable']))&&(_0x32e6e7={'enumerable':!![],'get':function(){return _0x287a6f[_0x2fa4f5];}}),Object[_0x51c869(0x205)](_0x1d0a2c,_0x143aaa,_0x32e6e7);}:function(_0x389585,_0x303921,_0x161b09,_0x58b266){if(_0x58b266===undefined)_0x58b266=_0x161b09;_0x389585[_0x58b266]=_0x303921[_0x161b09];}),__setModuleDefault=this&&this[a12_0x9b296f(0x227)]||(Object[a12_0x9b296f(0x1fa)]?function(_0x45b5aa,_0x5b90f8){var _0x1cec3d=a12_0x9b296f;Object[_0x1cec3d(0x205)](_0x45b5aa,_0x1cec3d(0x20d),{'enumerable':!![],'value':_0x5b90f8});}:function(_0x501773,_0x42cd2e){var _0x1c38b6=a12_0x9b296f;_0x501773[_0x1c38b6(0x20d)]=_0x42cd2e;}),__importStar=this&&this[a12_0x9b296f(0x22a)]||(function(){var _0x12a547=function(_0x26d647){return _0x12a547=Object['getOwnPropertyNames']||function(_0x462f68){var _0x58b51e=a12_0x1825,_0x1f13d7=[];for(var _0x54ec6b in _0x462f68)if(Object['prototype'][_0x58b51e(0x204)][_0x58b51e(0x1f2)](_0x462f68,_0x54ec6b))_0x1f13d7[_0x1f13d7['length']]=_0x54ec6b;return _0x1f13d7;},_0x12a547(_0x26d647);};return function(_0x3a854d){var _0x406b5b=a12_0x1825;if(_0x3a854d&&_0x3a854d[_0x406b5b(0x22e)])return _0x3a854d;var _0x5aa388={};if(_0x3a854d!=null){for(var _0x1e93ca=_0x12a547(_0x3a854d),_0x10694b=0x0;_0x10694b<_0x1e93ca[_0x406b5b(0x1ff)];_0x10694b++)if(_0x1e93ca[_0x10694b]!==_0x406b5b(0x20d))__createBinding(_0x5aa388,_0x3a854d,_0x1e93ca[_0x10694b]);}return __setModuleDefault(_0x5aa388,_0x3a854d),_0x5aa388;};}()),__importDefault=this&&this['__importDefault']||function(_0x444ff5){var _0x3c45df=a12_0x9b296f;return _0x444ff5&&_0x444ff5[_0x3c45df(0x22e)]?_0x444ff5:{'default':_0x444ff5};};Object[a12_0x9b296f(0x205)](exports,'__esModule',{'value':!![]}),exports[a12_0x9b296f(0x206)]=void 0x0;const database_1=__importDefault(require(a12_0x9b296f(0x219)));class OnRampController{async[a12_0x9b296f(0x1fd)](_0x312f63,_0x53deef){var _0x50f7ad=a12_0x9b296f;try{const {paymentId:_0x3a6362,status:_0x2ff239,referenceId:_0x3b8c31,transactionHash:_0x5e4088,actualCryptoAmount:_0x25e56c,orderId:_0x1d1dc1}=_0x312f63['body'];if(!_0x3a6362||!_0x2ff239){_0x53deef[_0x50f7ad(0x223)](0x190)[_0x50f7ad(0x21c)]({'success':![],'message':_0x50f7ad(0x1f8)});return;}console[_0x50f7ad(0x21d)](_0x50f7ad(0x232)+_0x3a6362+_0x50f7ad(0x237)+_0x2ff239),console['log'](_0x50f7ad(0x231),{'referenceId':_0x3b8c31,'transactionHash':_0x5e4088,'actualCryptoAmount':_0x25e56c,'orderId':_0x1d1dc1});const _0x1bf410=await database_1[_0x50f7ad(0x20d)][_0x50f7ad(0x208)][_0x50f7ad(0x236)]({'where':{'OR':[{'id':_0x3a6362},{'orderId':_0x3a6362},{'gatewayOrderId':_0x3a6362},{'gatewayPaymentId':_0x3a6362}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x1bf410){_0x53deef[_0x50f7ad(0x223)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});return;}if(_0x1bf410[_0x50f7ad(0x1fc)]!==_0x50f7ad(0x212)){_0x53deef[_0x50f7ad(0x223)](0x190)['json']({'success':![],'message':_0x50f7ad(0x22d)});return;}const _0x49b9c6={'status':_0x2ff239[_0x50f7ad(0x21e)](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0x3b8c31&&(_0x49b9c6[_0x50f7ad(0x1f6)]=_0x3b8c31);_0x5e4088&&(_0x49b9c6['gatewayPaymentId']=_0x5e4088);_0x25e56c&&(_0x49b9c6['invoiceTotalSum']=_0x25e56c);const _0x44145a=await database_1[_0x50f7ad(0x20d)]['payment'][_0x50f7ad(0x218)]({'where':{'id':_0x1bf410['id']},'data':_0x49b9c6});console[_0x50f7ad(0x21d)](_0x50f7ad(0x221)+_0x1bf410['id']+_0x50f7ad(0x222)+_0x2ff239),_0x2ff239[_0x50f7ad(0x21e)]()==='PAID'&&_0x1bf410[_0x50f7ad(0x223)]!==_0x50f7ad(0x229)&&await this[_0x50f7ad(0x20e)](_0x1bf410),_0x53deef[_0x50f7ad(0x21c)]({'success':!![],'message':_0x50f7ad(0x21f),'data':{'paymentId':_0x44145a['id'],'status':_0x44145a[_0x50f7ad(0x223)],'referenceId':_0x3b8c31,'transactionHash':_0x5e4088,'actualCryptoAmount':_0x25e56c}});}catch(_0xd5346b){console[_0x50f7ad(0x1fe)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0xd5346b),_0x53deef[_0x50f7ad(0x223)](0x1f4)['json']({'success':![],'message':_0x50f7ad(0x234),'error':_0xd5346b instanceof Error?_0xd5346b[_0x50f7ad(0x225)]:_0x50f7ad(0x20a)});}}async['updateMerchantBalanceForPaidPayment'](_0x3d469d){var _0x3e3079=a12_0x9b296f;try{console[_0x3e3079(0x21d)](_0x3e3079(0x217)+_0x3d469d['id']);let _0x22d280;if(_0x3d469d[_0x3e3079(0x207)]===_0x3e3079(0x1fb))_0x22d280=_0x3d469d['amount'];else{const {currencyService:_0x524659}=await Promise['resolve']()[_0x3e3079(0x21a)](()=>__importStar(require(_0x3e3079(0x1f4))));_0x22d280=await _0x524659['convertToUSDT'](_0x3d469d[_0x3e3079(0x22b)],_0x3d469d['currency']);}await database_1['default'][_0x3e3079(0x208)][_0x3e3079(0x218)]({'where':{'id':_0x3d469d['id']},'data':{'amountUSDT':_0x22d280,'paidAt':new Date()}});const _0x493693=0xa,_0x213ee4=_0x22d280*(0x1-_0x493693/0x64);await database_1[_0x3e3079(0x20d)][_0x3e3079(0x21b)][_0x3e3079(0x218)]({'where':{'id':_0x3d469d['shopId']},'data':{'balance':{'increment':_0x213ee4}}}),console[_0x3e3079(0x21d)]('‚úÖ\x20Merchant\x20balance\x20updated:\x20+'+_0x213ee4[_0x3e3079(0x22c)](0x6)+_0x3e3079(0x213)+_0x493693+_0x3e3079(0x211));}catch(_0x30b89e){console['error'](_0x3e3079(0x1f5),_0x30b89e);}}async[a12_0x9b296f(0x209)](_0x566551,_0x2740ed){var _0x1f9a69=a12_0x9b296f;try{const {id:_0x445daa}=_0x566551[_0x1f9a69(0x215)];if(!_0x445daa){_0x2740ed[_0x1f9a69(0x223)](0x190)[_0x1f9a69(0x21c)]({'success':![],'message':'Payment\x20ID\x20is\x20required'});return;}console[_0x1f9a69(0x21d)](_0x1f9a69(0x22f)+_0x445daa);const _0x32e68f=await database_1['default']['payment'][_0x1f9a69(0x236)]({'where':{'OR':[{'id':_0x445daa},{'orderId':_0x445daa},{'gatewayOrderId':_0x445daa},{'gatewayPaymentId':_0x445daa}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x32e68f){_0x2740ed['status'](0x194)[_0x1f9a69(0x21c)]({'success':![],'message':_0x1f9a69(0x235)});return;}console[_0x1f9a69(0x21d)](_0x1f9a69(0x20c)+_0x32e68f['id']+'\x20('+_0x32e68f[_0x1f9a69(0x223)]+')'),_0x2740ed[_0x1f9a69(0x21c)]({'success':!![],'data':{'id':_0x32e68f['id'],'gateway':_0x32e68f[_0x1f9a69(0x1fc)],'amount':_0x32e68f[_0x1f9a69(0x22b)],'currency':_0x32e68f[_0x1f9a69(0x207)],'status':_0x32e68f['status'],'gatewayOrderId':_0x32e68f['gatewayOrderId'],'gatewayPaymentId':_0x32e68f[_0x1f9a69(0x1f7)],'successUrl':_0x32e68f[_0x1f9a69(0x1f9)],'failUrl':_0x32e68f['failUrl'],'pendingUrl':_0x32e68f['pendingUrl'],'customerEmail':_0x32e68f[_0x1f9a69(0x201)],'customerName':_0x32e68f['customerName'],'merchantBrand':_0x32e68f[_0x1f9a69(0x21b)][_0x1f9a69(0x200)],'createdAt':_0x32e68f[_0x1f9a69(0x230)],'updatedAt':_0x32e68f[_0x1f9a69(0x228)]}});}catch(_0x455364){console['error'](_0x1f9a69(0x202),_0x455364),_0x2740ed['status'](0x1f4)['json']({'success':![],'message':_0x1f9a69(0x234),'error':_0x455364 instanceof Error?_0x455364[_0x1f9a69(0x225)]:_0x1f9a69(0x20a)});}}}exports[a12_0x9b296f(0x206)]=OnRampController;