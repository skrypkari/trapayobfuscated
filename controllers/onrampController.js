'use strict';var a12_0x49cbf7=a12_0x3c0e;(function(_0x3e3ee5,_0x238902){var _0x5b80fc=a12_0x3c0e,_0x1b226b=_0x3e3ee5();while(!![]){try{var _0x38051d=-parseInt(_0x5b80fc(0x178))/0x1*(parseInt(_0x5b80fc(0x17a))/0x2)+-parseInt(_0x5b80fc(0x16b))/0x3+parseInt(_0x5b80fc(0x17f))/0x4*(-parseInt(_0x5b80fc(0x148))/0x5)+parseInt(_0x5b80fc(0x163))/0x6+-parseInt(_0x5b80fc(0x18c))/0x7*(parseInt(_0x5b80fc(0x172))/0x8)+parseInt(_0x5b80fc(0x17e))/0x9*(parseInt(_0x5b80fc(0x17b))/0xa)+parseInt(_0x5b80fc(0x165))/0xb*(parseInt(_0x5b80fc(0x14b))/0xc);if(_0x38051d===_0x238902)break;else _0x1b226b['push'](_0x1b226b['shift']());}catch(_0x501538){_0x1b226b['push'](_0x1b226b['shift']());}}}(a12_0x1aea,0xd2a94));function a12_0x3c0e(_0x8b7b33,_0x3f5c95){_0x8b7b33=_0x8b7b33-0x147;var _0x1aeac9=a12_0x1aea();var _0x3c0e92=_0x1aeac9[_0x8b7b33];return _0x3c0e92;}var __createBinding=this&&this['__createBinding']||(Object[a12_0x49cbf7(0x15c)]?function(_0x56e277,_0x1a12e9,_0x3eb43c,_0x48de07){var _0x17fd08=a12_0x49cbf7;if(_0x48de07===undefined)_0x48de07=_0x3eb43c;var _0x28a04c=Object[_0x17fd08(0x149)](_0x1a12e9,_0x3eb43c);(!_0x28a04c||(_0x17fd08(0x171)in _0x28a04c?!_0x1a12e9[_0x17fd08(0x152)]:_0x28a04c[_0x17fd08(0x15b)]||_0x28a04c['configurable']))&&(_0x28a04c={'enumerable':!![],'get':function(){return _0x1a12e9[_0x3eb43c];}}),Object['defineProperty'](_0x56e277,_0x48de07,_0x28a04c);}:function(_0x564181,_0x3d688d,_0x25390e,_0x468f54){if(_0x468f54===undefined)_0x468f54=_0x25390e;_0x564181[_0x468f54]=_0x3d688d[_0x25390e];}),__setModuleDefault=this&&this[a12_0x49cbf7(0x167)]||(Object[a12_0x49cbf7(0x15c)]?function(_0x46ac40,_0x2eb87d){var _0xcea60e=a12_0x49cbf7;Object[_0xcea60e(0x15a)](_0x46ac40,_0xcea60e(0x16f),{'enumerable':!![],'value':_0x2eb87d});}:function(_0x3eb22c,_0xd0178f){var _0x1d8707=a12_0x49cbf7;_0x3eb22c[_0x1d8707(0x16f)]=_0xd0178f;}),__importStar=this&&this[a12_0x49cbf7(0x17c)]||(function(){var _0x3af4a1=function(_0x4fb25a){var _0x4d8a51=a12_0x3c0e;return _0x3af4a1=Object[_0x4d8a51(0x16d)]||function(_0x571bf5){var _0x5f418f=_0x4d8a51,_0x2c9a3d=[];for(var _0x1248fc in _0x571bf5)if(Object[_0x5f418f(0x186)][_0x5f418f(0x183)][_0x5f418f(0x168)](_0x571bf5,_0x1248fc))_0x2c9a3d[_0x2c9a3d[_0x5f418f(0x153)]]=_0x1248fc;return _0x2c9a3d;},_0x3af4a1(_0x4fb25a);};return function(_0x5cdda8){var _0x101cb5=a12_0x3c0e;if(_0x5cdda8&&_0x5cdda8[_0x101cb5(0x152)])return _0x5cdda8;var _0x291a65={};if(_0x5cdda8!=null){for(var _0x5e775d=_0x3af4a1(_0x5cdda8),_0x384de6=0x0;_0x384de6<_0x5e775d[_0x101cb5(0x153)];_0x384de6++)if(_0x5e775d[_0x384de6]!==_0x101cb5(0x16f))__createBinding(_0x291a65,_0x5cdda8,_0x5e775d[_0x384de6]);}return __setModuleDefault(_0x291a65,_0x5cdda8),_0x291a65;};}()),__importDefault=this&&this[a12_0x49cbf7(0x161)]||function(_0xec212){return _0xec212&&_0xec212['__esModule']?_0xec212:{'default':_0xec212};};Object[a12_0x49cbf7(0x15a)](exports,a12_0x49cbf7(0x152),{'value':!![]}),exports[a12_0x49cbf7(0x177)]=void 0x0;function a12_0x1aea(){var _0x12d391=['2388873wHLsIu','update','getOwnPropertyNames','gatewayPaymentId','default','error','get','2506808GVuMhl','json','getPaymentData','üöÄ\x20OnRamp\x20status\x20update:\x20','failUrl','OnRampController','16eqlGII','name','195574jjmbuZ','10dUXTbD','__importStar','PAID','11380509izAqmV','4wgBILR','‚úÖ\x20Found\x20payment:\x20','invoiceTotalSum','gateway','hasOwnProperty','updatePaymentStatus','amount','prototype','resolve','onramp_system','üìù\x20Data:','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','Payment\x20ID\x20and\x20status\x20are\x20required','35spcpqT','payment','status','../services/currencyService','updateMerchantBalanceForPaidPayment','log','2289575Asgkin','getOwnPropertyDescriptor','params','48948DBWjAs','Unknown\x20error','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','toUpperCase','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','\x20updated\x20to\x20','then','__esModule','length','\x20->\x20','Payment\x20not\x20found','body','message','gatewayOrderId','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','defineProperty','writable','create','shop','onramp','‚úÖ\x20OnRamp\x20payment\x20','findFirst','__importDefault','currency','6991986kjaFEf','createdAt','7601sijjiW','customerEmail','__setModuleDefault','call','pendingUrl','customerName'];a12_0x1aea=function(){return _0x12d391;};return a12_0x1aea();}const database_1=__importDefault(require('../config/database'));class OnRampController{async[a12_0x49cbf7(0x184)](_0x2d2a27,_0x22e686){var _0x260e9b=a12_0x49cbf7;try{const {paymentId:_0x5b0604,status:_0x58da18,referenceId:_0x307c86,transactionHash:_0x4d326f,actualCryptoAmount:_0x539962,orderId:_0x5309dd}=_0x2d2a27[_0x260e9b(0x156)];if(!_0x5b0604||!_0x58da18){_0x22e686['status'](0x190)[_0x260e9b(0x173)]({'success':![],'message':_0x260e9b(0x18b)});return;}console[_0x260e9b(0x147)](_0x260e9b(0x175)+_0x5b0604+_0x260e9b(0x154)+_0x58da18),console[_0x260e9b(0x147)](_0x260e9b(0x189),{'referenceId':_0x307c86,'transactionHash':_0x4d326f,'actualCryptoAmount':_0x539962,'orderId':_0x5309dd});const _0x1f4d44=await database_1[_0x260e9b(0x16f)][_0x260e9b(0x18d)][_0x260e9b(0x160)]({'where':{'OR':[{'id':_0x5b0604},{'orderId':_0x5b0604},{'gatewayOrderId':_0x5b0604},{'gatewayPaymentId':_0x5b0604}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x1f4d44){_0x22e686[_0x260e9b(0x18e)](0x194)[_0x260e9b(0x173)]({'success':![],'message':_0x260e9b(0x155)});return;}if(_0x1f4d44['gateway']!==_0x260e9b(0x15e)){_0x22e686[_0x260e9b(0x18e)](0x190)['json']({'success':![],'message':'This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway'});return;}const _0x3ae538={'status':_0x58da18[_0x260e9b(0x14e)](),'statusChangedAt':new Date(),'statusChangedBy':_0x260e9b(0x188)};_0x307c86&&(_0x3ae538[_0x260e9b(0x158)]=_0x307c86);_0x4d326f&&(_0x3ae538[_0x260e9b(0x16e)]=_0x4d326f);_0x539962&&(_0x3ae538[_0x260e9b(0x181)]=_0x539962);const _0x74d39f=await database_1[_0x260e9b(0x16f)][_0x260e9b(0x18d)][_0x260e9b(0x16c)]({'where':{'id':_0x1f4d44['id']},'data':_0x3ae538});console[_0x260e9b(0x147)](_0x260e9b(0x15f)+_0x1f4d44['id']+_0x260e9b(0x150)+_0x58da18),_0x58da18[_0x260e9b(0x14e)]()==='PAID'&&_0x1f4d44[_0x260e9b(0x18e)]!==_0x260e9b(0x17d)&&await this['updateMerchantBalanceForPaidPayment'](_0x1f4d44),_0x22e686[_0x260e9b(0x173)]({'success':!![],'message':'Payment\x20status\x20updated\x20successfully','data':{'paymentId':_0x74d39f['id'],'status':_0x74d39f[_0x260e9b(0x18e)],'referenceId':_0x307c86,'transactionHash':_0x4d326f,'actualCryptoAmount':_0x539962}});}catch(_0xa32499){console[_0x260e9b(0x170)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0xa32499),_0x22e686[_0x260e9b(0x18e)](0x1f4)['json']({'success':![],'message':'Internal\x20server\x20error','error':_0xa32499 instanceof Error?_0xa32499[_0x260e9b(0x157)]:'Unknown\x20error'});}}async[a12_0x49cbf7(0x190)](_0x59afa4){var _0x4f6e7d=a12_0x49cbf7;try{console[_0x4f6e7d(0x147)](_0x4f6e7d(0x14f)+_0x59afa4['id']);let _0xfe7a45;if(_0x59afa4['currency']==='USD')_0xfe7a45=_0x59afa4[_0x4f6e7d(0x185)];else{const {currencyService:_0x40d7d6}=await Promise[_0x4f6e7d(0x187)]()[_0x4f6e7d(0x151)](()=>__importStar(require(_0x4f6e7d(0x18f))));_0xfe7a45=await _0x40d7d6['convertToUSDT'](_0x59afa4['amount'],_0x59afa4['currency']);}await database_1[_0x4f6e7d(0x16f)][_0x4f6e7d(0x18d)][_0x4f6e7d(0x16c)]({'where':{'id':_0x59afa4['id']},'data':{'amountUSDT':_0xfe7a45,'paidAt':new Date()}});const _0x293ea7=0xa,_0xe8d45a=_0xfe7a45*(0x1-_0x293ea7/0x64);await database_1[_0x4f6e7d(0x16f)][_0x4f6e7d(0x15d)]['update']({'where':{'id':_0x59afa4['shopId']},'data':{'balance':{'increment':_0xe8d45a}}}),console[_0x4f6e7d(0x147)](_0x4f6e7d(0x14d)+_0xe8d45a['toFixed'](0x6)+'\x20USDT\x20(after\x20'+_0x293ea7+'%\x20commission)');}catch(_0x2333fa){console[_0x4f6e7d(0x170)](_0x4f6e7d(0x18a),_0x2333fa);}}async[a12_0x49cbf7(0x174)](_0x3047ee,_0xf46b6b){var _0x357ca1=a12_0x49cbf7;try{const {id:_0x131973}=_0x3047ee[_0x357ca1(0x14a)];if(!_0x131973){_0xf46b6b['status'](0x190)['json']({'success':![],'message':'Payment\x20ID\x20is\x20required'});return;}console[_0x357ca1(0x147)](_0x357ca1(0x159)+_0x131973);const _0x2849c3=await database_1['default'][_0x357ca1(0x18d)][_0x357ca1(0x160)]({'where':{'OR':[{'id':_0x131973},{'orderId':_0x131973},{'gatewayOrderId':_0x131973},{'gatewayPaymentId':_0x131973}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x2849c3){_0xf46b6b['status'](0x194)[_0x357ca1(0x173)]({'success':![],'message':_0x357ca1(0x155)});return;}console[_0x357ca1(0x147)](_0x357ca1(0x180)+_0x2849c3['id']+'\x20('+_0x2849c3['status']+')'),_0xf46b6b[_0x357ca1(0x173)]({'success':!![],'data':{'id':_0x2849c3['id'],'gateway':_0x2849c3[_0x357ca1(0x182)],'amount':_0x2849c3[_0x357ca1(0x185)],'currency':_0x2849c3[_0x357ca1(0x162)],'status':_0x2849c3[_0x357ca1(0x18e)],'gatewayOrderId':_0x2849c3[_0x357ca1(0x158)],'gatewayPaymentId':_0x2849c3[_0x357ca1(0x16e)],'successUrl':_0x2849c3['successUrl'],'failUrl':_0x2849c3[_0x357ca1(0x176)],'pendingUrl':_0x2849c3[_0x357ca1(0x169)],'customerEmail':_0x2849c3[_0x357ca1(0x166)],'customerName':_0x2849c3[_0x357ca1(0x16a)],'merchantBrand':_0x2849c3[_0x357ca1(0x15d)][_0x357ca1(0x179)],'createdAt':_0x2849c3[_0x357ca1(0x164)],'updatedAt':_0x2849c3['updatedAt']}});}catch(_0x3a6da4){console['error']('‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:',_0x3a6da4),_0xf46b6b[_0x357ca1(0x18e)](0x1f4)[_0x357ca1(0x173)]({'success':![],'message':'Internal\x20server\x20error','error':_0x3a6da4 instanceof Error?_0x3a6da4[_0x357ca1(0x157)]:_0x357ca1(0x14c)});}}}exports[a12_0x49cbf7(0x177)]=OnRampController;