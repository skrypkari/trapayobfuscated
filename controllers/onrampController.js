'use strict';var a13_0x5520fe=a13_0x1584;(function(_0x432237,_0x19d3a3){var _0x2c61dc=a13_0x1584,_0x4c1a5a=_0x432237();while(!![]){try{var _0x15d8e0=parseInt(_0x2c61dc(0xb2))/0x1*(parseInt(_0x2c61dc(0xb1))/0x2)+parseInt(_0x2c61dc(0x8d))/0x3+-parseInt(_0x2c61dc(0x83))/0x4+parseInt(_0x2c61dc(0x9d))/0x5+parseInt(_0x2c61dc(0xc4))/0x6+-parseInt(_0x2c61dc(0xb7))/0x7*(parseInt(_0x2c61dc(0x9e))/0x8)+-parseInt(_0x2c61dc(0x93))/0x9;if(_0x15d8e0===_0x19d3a3)break;else _0x4c1a5a['push'](_0x4c1a5a['shift']());}catch(_0x1e49e4){_0x4c1a5a['push'](_0x4c1a5a['shift']());}}}(a13_0x33bb,0x56efd));function a13_0x33bb(){var _0x2f28be=['customerName','Payment\x20not\x20found','log','__createBinding','Internal\x20server\x20error','body','Unknown\x20error','shop','json','1279368DpYsZl','length','USD','hasOwnProperty','amount','configurable','9271629btngzV','gateway','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','pendingUrl','\x20->\x20','Payment\x20ID\x20is\x20required','status','onramp_system','call','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','3102855SyWOeB','1409384vatKQo','params','defineProperty','üìù\x20Data:','getOwnPropertyDescriptor','__importStar','../config/database','error','‚úÖ\x20Found\x20payment:\x20','default','Payment\x20ID\x20and\x20status\x20are\x20required','__esModule','update','üöÄ\x20OnRamp\x20status\x20update:\x20','toFixed','prototype','toUpperCase','OnRampController','../services/currencyService','38VMHrED','11482fKSULj','PAID','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','currency','payment','7oKwaQy','gatewayOrderId','create','writable','onramp','get','updatePaymentStatus','failUrl','customerEmail','gatewayPaymentId','\x20updated\x20to\x20','updateMerchantBalanceForPaidPayment','message','3414984HDqERd','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','updatedAt','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','createdAt','%\x20commission)','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','‚ùå\x20OnRamp\x20status\x20update\x20error:','1087608FxeqjO'];a13_0x33bb=function(){return _0x2f28be;};return a13_0x33bb();}var __createBinding=this&&this[a13_0x5520fe(0x87)]||(Object['create']?function(_0x62b326,_0x2c7c4d,_0x504de8,_0x3d2bf1){var _0x321ee2=a13_0x5520fe;if(_0x3d2bf1===undefined)_0x3d2bf1=_0x504de8;var _0x431a95=Object[_0x321ee2(0xa2)](_0x2c7c4d,_0x504de8);(!_0x431a95||(_0x321ee2(0xbc)in _0x431a95?!_0x2c7c4d[_0x321ee2(0xa9)]:_0x431a95[_0x321ee2(0xba)]||_0x431a95[_0x321ee2(0x92)]))&&(_0x431a95={'enumerable':!![],'get':function(){return _0x2c7c4d[_0x504de8];}}),Object[_0x321ee2(0xa0)](_0x62b326,_0x3d2bf1,_0x431a95);}:function(_0x410d7a,_0x39576d,_0x849a19,_0x567764){if(_0x567764===undefined)_0x567764=_0x849a19;_0x410d7a[_0x567764]=_0x39576d[_0x849a19];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x5520fe(0xb9)]?function(_0x11a598,_0x5e7e5a){var _0x4e0bcf=a13_0x5520fe;Object[_0x4e0bcf(0xa0)](_0x11a598,_0x4e0bcf(0xa7),{'enumerable':!![],'value':_0x5e7e5a});}:function(_0x1d8a9d,_0x287f2e){var _0x53e4ca=a13_0x5520fe;_0x1d8a9d[_0x53e4ca(0xa7)]=_0x287f2e;}),__importStar=this&&this[a13_0x5520fe(0xa3)]||(function(){var _0x26e691=function(_0x22dc54){return _0x26e691=Object['getOwnPropertyNames']||function(_0x108725){var _0x58de51=a13_0x1584,_0x8cb897=[];for(var _0x2037ef in _0x108725)if(Object[_0x58de51(0xad)][_0x58de51(0x90)][_0x58de51(0x9b)](_0x108725,_0x2037ef))_0x8cb897[_0x8cb897[_0x58de51(0x8e)]]=_0x2037ef;return _0x8cb897;},_0x26e691(_0x22dc54);};return function(_0x41eb12){var _0x31d76e=a13_0x1584;if(_0x41eb12&&_0x41eb12[_0x31d76e(0xa9)])return _0x41eb12;var _0x5a448b={};if(_0x41eb12!=null){for(var _0x193a8e=_0x26e691(_0x41eb12),_0x14e24d=0x0;_0x14e24d<_0x193a8e[_0x31d76e(0x8e)];_0x14e24d++)if(_0x193a8e[_0x14e24d]!=='default')__createBinding(_0x5a448b,_0x41eb12,_0x193a8e[_0x14e24d]);}return __setModuleDefault(_0x5a448b,_0x41eb12),_0x5a448b;};}()),__importDefault=this&&this['__importDefault']||function(_0x39ab10){var _0x2b18da=a13_0x5520fe;return _0x39ab10&&_0x39ab10[_0x2b18da(0xa9)]?_0x39ab10:{'default':_0x39ab10};};Object[a13_0x5520fe(0xa0)](exports,a13_0x5520fe(0xa9),{'value':!![]}),exports[a13_0x5520fe(0xaf)]=void 0x0;const database_1=__importDefault(require(a13_0x5520fe(0xa4)));class OnRampController{async[a13_0x5520fe(0xbd)](_0x499d45,_0x552876){var _0x398d4c=a13_0x5520fe;try{const {paymentId:_0x25787a,status:_0x552b7c,referenceId:_0x524d54,transactionHash:_0x2993c3,actualCryptoAmount:_0xc08518,orderId:_0x4c5b20}=_0x499d45[_0x398d4c(0x89)];if(!_0x25787a||!_0x552b7c){_0x552876[_0x398d4c(0x99)](0x190)[_0x398d4c(0x8c)]({'success':![],'message':_0x398d4c(0xa8)});return;}console[_0x398d4c(0x86)](_0x398d4c(0xab)+_0x25787a+_0x398d4c(0x97)+_0x552b7c),console[_0x398d4c(0x86)](_0x398d4c(0xa1),{'referenceId':_0x524d54,'transactionHash':_0x2993c3,'actualCryptoAmount':_0xc08518,'orderId':_0x4c5b20});const _0x4c6155=await database_1[_0x398d4c(0xa7)]['payment']['findFirst']({'where':{'OR':[{'id':_0x25787a},{'orderId':_0x25787a},{'gatewayOrderId':_0x25787a},{'gatewayPaymentId':_0x25787a}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x4c6155){_0x552876[_0x398d4c(0x99)](0x194)[_0x398d4c(0x8c)]({'success':![],'message':'Payment\x20not\x20found'});return;}if(_0x4c6155[_0x398d4c(0x94)]!==_0x398d4c(0xbb)){_0x552876['status'](0x190)['json']({'success':![],'message':_0x398d4c(0x95)});return;}const _0x4f24de={'status':_0x552b7c[_0x398d4c(0xae)](),'statusChangedAt':new Date(),'statusChangedBy':_0x398d4c(0x9a)};_0x524d54&&(_0x4f24de[_0x398d4c(0xb8)]=_0x524d54);_0x2993c3&&(_0x4f24de[_0x398d4c(0xc0)]=_0x2993c3);_0xc08518&&(_0x4f24de['invoiceTotalSum']=_0xc08518);const _0x44bb9d=await database_1[_0x398d4c(0xa7)][_0x398d4c(0xb6)][_0x398d4c(0xaa)]({'where':{'id':_0x4c6155['id']},'data':_0x4f24de});console[_0x398d4c(0x86)]('‚úÖ\x20OnRamp\x20payment\x20'+_0x4c6155['id']+_0x398d4c(0xc1)+_0x552b7c),_0x552b7c[_0x398d4c(0xae)]()===_0x398d4c(0xb3)&&_0x4c6155[_0x398d4c(0x99)]!=='PAID'&&await this[_0x398d4c(0xc2)](_0x4c6155),_0x552876['json']({'success':!![],'message':'Payment\x20status\x20updated\x20successfully','data':{'paymentId':_0x44bb9d['id'],'status':_0x44bb9d['status'],'referenceId':_0x524d54,'transactionHash':_0x2993c3,'actualCryptoAmount':_0xc08518}});}catch(_0x5b20f1){console[_0x398d4c(0xa5)](_0x398d4c(0x82),_0x5b20f1),_0x552876['status'](0x1f4)[_0x398d4c(0x8c)]({'success':![],'message':_0x398d4c(0x88),'error':_0x5b20f1 instanceof Error?_0x5b20f1[_0x398d4c(0xc3)]:_0x398d4c(0x8a)});}}async['updateMerchantBalanceForPaidPayment'](_0xaab5f4){var _0x38a3fc=a13_0x5520fe;try{console['log'](_0x38a3fc(0xca)+_0xaab5f4['id']);let _0x4606e3;if(_0xaab5f4[_0x38a3fc(0xb5)]===_0x38a3fc(0x8f))_0x4606e3=_0xaab5f4['amount'];else{const {currencyService:_0x1214a5}=await Promise['resolve']()['then'](()=>__importStar(require(_0x38a3fc(0xb0))));_0x4606e3=await _0x1214a5['convertToUSDT'](_0xaab5f4[_0x38a3fc(0x91)],_0xaab5f4[_0x38a3fc(0xb5)]);}await database_1['default'][_0x38a3fc(0xb6)]['update']({'where':{'id':_0xaab5f4['id']},'data':{'amountUSDT':_0x4606e3,'paidAt':new Date()}});const _0x3fae23=0xa,_0x3b6e6c=_0x4606e3*(0x1-_0x3fae23/0x64);await database_1['default'][_0x38a3fc(0x8b)][_0x38a3fc(0xaa)]({'where':{'id':_0xaab5f4['shopId']},'data':{'balance':{'increment':_0x3b6e6c}}}),console[_0x38a3fc(0x86)](_0x38a3fc(0xc5)+_0x3b6e6c[_0x38a3fc(0xac)](0x6)+'\x20USDT\x20(after\x20'+_0x3fae23+_0x38a3fc(0xc9));}catch(_0x43dc86){console[_0x38a3fc(0xa5)](_0x38a3fc(0xb4),_0x43dc86);}}async['getPaymentData'](_0x5d63fe,_0x588940){var _0x2f878d=a13_0x5520fe;try{const {id:_0x465cdf}=_0x5d63fe[_0x2f878d(0x9f)];if(!_0x465cdf){_0x588940['status'](0x190)[_0x2f878d(0x8c)]({'success':![],'message':_0x2f878d(0x98)});return;}console['log'](_0x2f878d(0xc7)+_0x465cdf);const _0x28efb1=await database_1['default'][_0x2f878d(0xb6)]['findFirst']({'where':{'OR':[{'id':_0x465cdf},{'orderId':_0x465cdf},{'gatewayOrderId':_0x465cdf},{'gatewayPaymentId':_0x465cdf}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x28efb1){_0x588940['status'](0x194)[_0x2f878d(0x8c)]({'success':![],'message':_0x2f878d(0x85)});return;}console['log'](_0x2f878d(0xa6)+_0x28efb1['id']+'\x20('+_0x28efb1[_0x2f878d(0x99)]+')'),_0x588940[_0x2f878d(0x8c)]({'success':!![],'data':{'id':_0x28efb1['id'],'gateway':_0x28efb1['gateway'],'amount':_0x28efb1[_0x2f878d(0x91)],'currency':_0x28efb1[_0x2f878d(0xb5)],'status':_0x28efb1[_0x2f878d(0x99)],'gatewayOrderId':_0x28efb1[_0x2f878d(0xb8)],'gatewayPaymentId':_0x28efb1['gatewayPaymentId'],'successUrl':_0x28efb1['successUrl'],'failUrl':_0x28efb1[_0x2f878d(0xbe)],'pendingUrl':_0x28efb1[_0x2f878d(0x96)],'customerEmail':_0x28efb1[_0x2f878d(0xbf)],'customerName':_0x28efb1[_0x2f878d(0x84)],'merchantBrand':_0x28efb1['shop']['name'],'createdAt':_0x28efb1[_0x2f878d(0xc8)],'updatedAt':_0x28efb1[_0x2f878d(0xc6)]}});}catch(_0x2be7fa){console[_0x2f878d(0xa5)](_0x2f878d(0x9c),_0x2be7fa),_0x588940[_0x2f878d(0x99)](0x1f4)[_0x2f878d(0x8c)]({'success':![],'message':_0x2f878d(0x88),'error':_0x2be7fa instanceof Error?_0x2be7fa[_0x2f878d(0xc3)]:_0x2f878d(0x8a)});}}}function a13_0x1584(_0x53bca1,_0x1e2f94){_0x53bca1=_0x53bca1-0x82;var _0x33bb16=a13_0x33bb();var _0x1584b6=_0x33bb16[_0x53bca1];return _0x1584b6;}exports[a13_0x5520fe(0xaf)]=OnRampController;