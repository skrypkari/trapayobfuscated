'use strict';var a12_0x2b8efc=a12_0x40b4;function a12_0x40b4(_0x1ab7aa,_0x3ad134){_0x1ab7aa=_0x1ab7aa-0x168;var _0x105eb4=a12_0x105e();var _0x40b44d=_0x105eb4[_0x1ab7aa];return _0x40b44d;}(function(_0x37f4b5,_0x40b1f4){var _0x42a9b5=a12_0x40b4,_0x5384f4=_0x37f4b5();while(!![]){try{var _0x115d1f=parseInt(_0x42a9b5(0x18f))/0x1*(parseInt(_0x42a9b5(0x19f))/0x2)+-parseInt(_0x42a9b5(0x192))/0x3*(parseInt(_0x42a9b5(0x185))/0x4)+-parseInt(_0x42a9b5(0x1a7))/0x5*(parseInt(_0x42a9b5(0x176))/0x6)+-parseInt(_0x42a9b5(0x18b))/0x7+-parseInt(_0x42a9b5(0x1b3))/0x8+-parseInt(_0x42a9b5(0x195))/0x9*(parseInt(_0x42a9b5(0x199))/0xa)+parseInt(_0x42a9b5(0x1af))/0xb;if(_0x115d1f===_0x40b1f4)break;else _0x5384f4['push'](_0x5384f4['shift']());}catch(_0x3c5835){_0x5384f4['push'](_0x5384f4['shift']());}}}(a12_0x105e,0x9ad56));function a12_0x105e(){var _0x4e4293=['error','23902923oXqNmp','‚úÖ\x20Found\x20payment:\x20','updatePaymentStatus','getOwnPropertyNames','7572904RAbAJv','updateMerchantBalanceForPaidPayment','default','PAID','then','log','__importDefault','convertToUSDT','üöÄ\x20OnRamp\x20status\x20update:\x20','Unknown\x20error','OnRampController','Payment\x20not\x20found','json','__setModuleDefault','Payment\x20ID\x20and\x20status\x20are\x20required','../config/database','Payment\x20ID\x20is\x20required','shop','2016618gaXCCp','hasOwnProperty','Payment\x20status\x20updated\x20successfully','currency','failUrl','gatewayPaymentId','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','__esModule','Internal\x20server\x20error','message','__createBinding','length','prototype','getPaymentData','amount','60uAKmzu','\x20USDT\x20(after\x20','shopId','status','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','findFirst','3094063YzMOgD','update','toUpperCase','writable','66401UDUHJj','gateway','%\x20commission)','3483tqJjhZ','USD','createdAt','39969HnOrbs','invoiceTotalSum','configurable','onramp','430UxJvES','gatewayOrderId','../services/currencyService','create','pendingUrl','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','22hIKcaI','customerEmail','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','defineProperty','payment','get','toFixed','‚úÖ\x20OnRamp\x20payment\x20','10nfhCTd','resolve','name','params','\x20->\x20','customerName','\x20updated\x20to\x20'];a12_0x105e=function(){return _0x4e4293;};return a12_0x105e();}var __createBinding=this&&this[a12_0x2b8efc(0x180)]||(Object['create']?function(_0x24d1d3,_0x439a96,_0x1c5072,_0x33b2ec){var _0x3a9433=a12_0x2b8efc;if(_0x33b2ec===undefined)_0x33b2ec=_0x1c5072;var _0x191a7a=Object['getOwnPropertyDescriptor'](_0x439a96,_0x1c5072);(!_0x191a7a||(_0x3a9433(0x1a4)in _0x191a7a?!_0x439a96[_0x3a9433(0x17d)]:_0x191a7a[_0x3a9433(0x18e)]||_0x191a7a[_0x3a9433(0x197)]))&&(_0x191a7a={'enumerable':!![],'get':function(){return _0x439a96[_0x1c5072];}}),Object['defineProperty'](_0x24d1d3,_0x33b2ec,_0x191a7a);}:function(_0x26eee8,_0x1ffa6a,_0x5415b0,_0x553d4c){if(_0x553d4c===undefined)_0x553d4c=_0x5415b0;_0x26eee8[_0x553d4c]=_0x1ffa6a[_0x5415b0];}),__setModuleDefault=this&&this[a12_0x2b8efc(0x171)]||(Object[a12_0x2b8efc(0x19c)]?function(_0x5e1792,_0xb6ea12){var _0x1b357e=a12_0x2b8efc;Object[_0x1b357e(0x1a2)](_0x5e1792,_0x1b357e(0x1b5),{'enumerable':!![],'value':_0xb6ea12});}:function(_0xab5789,_0x16da40){var _0x1b382c=a12_0x2b8efc;_0xab5789[_0x1b382c(0x1b5)]=_0x16da40;}),__importStar=this&&this['__importStar']||(function(){var _0x5dcdf0=function(_0x4e79f2){var _0x1da7a4=a12_0x40b4;return _0x5dcdf0=Object[_0x1da7a4(0x1b2)]||function(_0x32f36f){var _0x546259=_0x1da7a4,_0x3032b2=[];for(var _0x525261 in _0x32f36f)if(Object[_0x546259(0x182)][_0x546259(0x177)]['call'](_0x32f36f,_0x525261))_0x3032b2[_0x3032b2[_0x546259(0x181)]]=_0x525261;return _0x3032b2;},_0x5dcdf0(_0x4e79f2);};return function(_0x15054c){var _0x340757=a12_0x40b4;if(_0x15054c&&_0x15054c[_0x340757(0x17d)])return _0x15054c;var _0x4a3222={};if(_0x15054c!=null){for(var _0x437bd2=_0x5dcdf0(_0x15054c),_0x327824=0x0;_0x327824<_0x437bd2[_0x340757(0x181)];_0x327824++)if(_0x437bd2[_0x327824]!==_0x340757(0x1b5))__createBinding(_0x4a3222,_0x15054c,_0x437bd2[_0x327824]);}return __setModuleDefault(_0x4a3222,_0x15054c),_0x4a3222;};}()),__importDefault=this&&this[a12_0x2b8efc(0x16a)]||function(_0x4efe2d){var _0x31c9ec=a12_0x2b8efc;return _0x4efe2d&&_0x4efe2d[_0x31c9ec(0x17d)]?_0x4efe2d:{'default':_0x4efe2d};};Object[a12_0x2b8efc(0x1a2)](exports,a12_0x2b8efc(0x17d),{'value':!![]}),exports[a12_0x2b8efc(0x16e)]=void 0x0;const database_1=__importDefault(require(a12_0x2b8efc(0x173)));class OnRampController{async[a12_0x2b8efc(0x1b1)](_0x236ccb,_0xad26f9){var _0x5abf8f=a12_0x2b8efc;try{const {paymentId:_0x229cd6,status:_0x39f778,referenceId:_0x321428,transactionHash:_0x439ecb,actualCryptoAmount:_0xf7a770,orderId:_0x2827aa}=_0x236ccb['body'];if(!_0x229cd6||!_0x39f778){_0xad26f9[_0x5abf8f(0x188)](0x190)[_0x5abf8f(0x170)]({'success':![],'message':_0x5abf8f(0x172)});return;}console[_0x5abf8f(0x169)](_0x5abf8f(0x16c)+_0x229cd6+_0x5abf8f(0x1ab)+_0x39f778),console[_0x5abf8f(0x169)]('üìù\x20Data:',{'referenceId':_0x321428,'transactionHash':_0x439ecb,'actualCryptoAmount':_0xf7a770,'orderId':_0x2827aa});const _0x2520bb=await database_1['default'][_0x5abf8f(0x1a3)]['findFirst']({'where':{'OR':[{'id':_0x229cd6},{'orderId':_0x229cd6},{'gatewayOrderId':_0x229cd6},{'gatewayPaymentId':_0x229cd6}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x2520bb){_0xad26f9[_0x5abf8f(0x188)](0x194)['json']({'success':![],'message':_0x5abf8f(0x16f)});return;}if(_0x2520bb[_0x5abf8f(0x190)]!==_0x5abf8f(0x198)){_0xad26f9['status'](0x190)[_0x5abf8f(0x170)]({'success':![],'message':_0x5abf8f(0x17c)});return;}const _0x1e5995={'status':_0x39f778[_0x5abf8f(0x18d)](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0x321428&&(_0x1e5995['gatewayOrderId']=_0x321428);_0x439ecb&&(_0x1e5995[_0x5abf8f(0x17b)]=_0x439ecb);_0xf7a770&&(_0x1e5995[_0x5abf8f(0x196)]=_0xf7a770);const _0x38bcd2=await database_1[_0x5abf8f(0x1b5)][_0x5abf8f(0x1a3)][_0x5abf8f(0x18c)]({'where':{'id':_0x2520bb['id']},'data':_0x1e5995});console[_0x5abf8f(0x169)](_0x5abf8f(0x1a6)+_0x2520bb['id']+_0x5abf8f(0x1ad)+_0x39f778),_0x39f778[_0x5abf8f(0x18d)]()===_0x5abf8f(0x1b6)&&_0x2520bb[_0x5abf8f(0x188)]!==_0x5abf8f(0x1b6)&&await this[_0x5abf8f(0x1b4)](_0x2520bb),_0xad26f9[_0x5abf8f(0x170)]({'success':!![],'message':_0x5abf8f(0x178),'data':{'paymentId':_0x38bcd2['id'],'status':_0x38bcd2[_0x5abf8f(0x188)],'referenceId':_0x321428,'transactionHash':_0x439ecb,'actualCryptoAmount':_0xf7a770}});}catch(_0x5e971e){console[_0x5abf8f(0x1ae)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x5e971e),_0xad26f9[_0x5abf8f(0x188)](0x1f4)['json']({'success':![],'message':_0x5abf8f(0x17e),'error':_0x5e971e instanceof Error?_0x5e971e[_0x5abf8f(0x17f)]:_0x5abf8f(0x16d)});}}async['updateMerchantBalanceForPaidPayment'](_0x35839b){var _0x47e296=a12_0x2b8efc;try{console[_0x47e296(0x169)](_0x47e296(0x189)+_0x35839b['id']);let _0x3126ac;if(_0x35839b['currency']===_0x47e296(0x193))_0x3126ac=_0x35839b[_0x47e296(0x184)];else{const {currencyService:_0x1fb4b0}=await Promise[_0x47e296(0x1a8)]()[_0x47e296(0x168)](()=>__importStar(require(_0x47e296(0x19b))));_0x3126ac=await _0x1fb4b0[_0x47e296(0x16b)](_0x35839b[_0x47e296(0x184)],_0x35839b[_0x47e296(0x179)]);}await database_1[_0x47e296(0x1b5)][_0x47e296(0x1a3)][_0x47e296(0x18c)]({'where':{'id':_0x35839b['id']},'data':{'amountUSDT':_0x3126ac,'paidAt':new Date()}});const _0x108a62=0xa,_0x364910=_0x3126ac*(0x1-_0x108a62/0x64);await database_1[_0x47e296(0x1b5)][_0x47e296(0x175)][_0x47e296(0x18c)]({'where':{'id':_0x35839b[_0x47e296(0x187)]},'data':{'balance':{'increment':_0x364910}}}),console[_0x47e296(0x169)](_0x47e296(0x1a1)+_0x364910[_0x47e296(0x1a5)](0x6)+_0x47e296(0x186)+_0x108a62+_0x47e296(0x191));}catch(_0x1945d7){console[_0x47e296(0x1ae)]('‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:',_0x1945d7);}}async[a12_0x2b8efc(0x183)](_0x27394d,_0x8813dc){var _0x5c53d7=a12_0x2b8efc;try{const {id:_0x4da5d0}=_0x27394d[_0x5c53d7(0x1aa)];if(!_0x4da5d0){_0x8813dc[_0x5c53d7(0x188)](0x190)[_0x5c53d7(0x170)]({'success':![],'message':_0x5c53d7(0x174)});return;}console[_0x5c53d7(0x169)](_0x5c53d7(0x19e)+_0x4da5d0);const _0x4c6d60=await database_1[_0x5c53d7(0x1b5)]['payment'][_0x5c53d7(0x18a)]({'where':{'OR':[{'id':_0x4da5d0},{'orderId':_0x4da5d0},{'gatewayOrderId':_0x4da5d0},{'gatewayPaymentId':_0x4da5d0}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x4c6d60){_0x8813dc[_0x5c53d7(0x188)](0x194)[_0x5c53d7(0x170)]({'success':![],'message':_0x5c53d7(0x16f)});return;}console[_0x5c53d7(0x169)](_0x5c53d7(0x1b0)+_0x4c6d60['id']+'\x20('+_0x4c6d60['status']+')'),_0x8813dc[_0x5c53d7(0x170)]({'success':!![],'data':{'id':_0x4c6d60['id'],'gateway':_0x4c6d60[_0x5c53d7(0x190)],'amount':_0x4c6d60[_0x5c53d7(0x184)],'currency':_0x4c6d60['currency'],'status':_0x4c6d60['status'],'gatewayOrderId':_0x4c6d60[_0x5c53d7(0x19a)],'gatewayPaymentId':_0x4c6d60['gatewayPaymentId'],'successUrl':_0x4c6d60['successUrl'],'failUrl':_0x4c6d60[_0x5c53d7(0x17a)],'pendingUrl':_0x4c6d60[_0x5c53d7(0x19d)],'customerEmail':_0x4c6d60[_0x5c53d7(0x1a0)],'customerName':_0x4c6d60[_0x5c53d7(0x1ac)],'merchantBrand':_0x4c6d60[_0x5c53d7(0x175)][_0x5c53d7(0x1a9)],'createdAt':_0x4c6d60[_0x5c53d7(0x194)],'updatedAt':_0x4c6d60['updatedAt']}});}catch(_0x540592){console[_0x5c53d7(0x1ae)]('‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:',_0x540592),_0x8813dc['status'](0x1f4)['json']({'success':![],'message':_0x5c53d7(0x17e),'error':_0x540592 instanceof Error?_0x540592['message']:_0x5c53d7(0x16d)});}}}exports[a12_0x2b8efc(0x16e)]=OnRampController;