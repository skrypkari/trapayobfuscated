'use strict';var a13_0x3d593c=a13_0x64c7;function a13_0x21d9(){var _0x567e99=['1109972cxGmjs','gatewayPaymentId','Internal\x20server\x20error','default','Unknown\x20error','currency','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','5TRwjsD','54cUCbQb','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','getOwnPropertyNames','defineProperty','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','\x20USDT\x20(after\x20','payment','create','99856uFoCgU','json','configurable','pendingUrl','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','Payment\x20status\x20updated\x20successfully','__importStar','gateway','__createBinding','__importDefault','Payment\x20ID\x20is\x20required','update','getPaymentData','%\x20commission)','Payment\x20not\x20found','15932510XDuwxk','toUpperCase','error','2pVGseK','2884674VCxuuP','hasOwnProperty','call','message','get','USD','length','gatewayOrderId','prototype','customerEmail','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','updatePaymentStatus','then','shop','212757MyEQcX','resolve','successUrl','1381851RePGsH','body','name','__esModule','\x20updated\x20to\x20','status','Payment\x20ID\x20and\x20status\x20are\x20required','convertToUSDT','writable','üöÄ\x20OnRamp\x20status\x20update:\x20','__setModuleDefault','810355xhYkUU','‚úÖ\x20OnRamp\x20payment\x20','amount','updateMerchantBalanceForPaidPayment','üìù\x20Data:','customerName','log','\x20->\x20'];a13_0x21d9=function(){return _0x567e99;};return a13_0x21d9();}function a13_0x64c7(_0x21759e,_0x50547c){_0x21759e=_0x21759e-0x113;var _0x21d9f6=a13_0x21d9();var _0x64c70e=_0x21d9f6[_0x21759e];return _0x64c70e;}(function(_0x881bdf,_0x12a0b1){var _0x116351=a13_0x64c7,_0x3c0a05=_0x881bdf();while(!![]){try{var _0x26936d=parseInt(_0x116351(0x138))/0x1*(-parseInt(_0x116351(0x129))/0x2)+-parseInt(_0x116351(0x13b))/0x3+parseInt(_0x116351(0x14e))/0x4+-parseInt(_0x116351(0x155))/0x5*(parseInt(_0x116351(0x12a))/0x6)+-parseInt(_0x116351(0x146))/0x7+-parseInt(_0x116351(0x117))/0x8*(parseInt(_0x116351(0x156))/0x9)+parseInt(_0x116351(0x126))/0xa;if(_0x26936d===_0x12a0b1)break;else _0x3c0a05['push'](_0x3c0a05['shift']());}catch(_0x22804b){_0x3c0a05['push'](_0x3c0a05['shift']());}}}(a13_0x21d9,0x8066e));var __createBinding=this&&this[a13_0x3d593c(0x11f)]||(Object[a13_0x3d593c(0x116)]?function(_0x21dafe,_0x2b4fbe,_0x5e7554,_0x38e5e4){var _0x450da0=a13_0x3d593c;if(_0x38e5e4===undefined)_0x38e5e4=_0x5e7554;var _0x1b98cd=Object['getOwnPropertyDescriptor'](_0x2b4fbe,_0x5e7554);(!_0x1b98cd||(_0x450da0(0x12e)in _0x1b98cd?!_0x2b4fbe[_0x450da0(0x13e)]:_0x1b98cd[_0x450da0(0x143)]||_0x1b98cd[_0x450da0(0x119)]))&&(_0x1b98cd={'enumerable':!![],'get':function(){return _0x2b4fbe[_0x5e7554];}}),Object[_0x450da0(0x159)](_0x21dafe,_0x38e5e4,_0x1b98cd);}:function(_0x8a6d96,_0x350c9b,_0x34d382,_0x4ea7a2){if(_0x4ea7a2===undefined)_0x4ea7a2=_0x34d382;_0x8a6d96[_0x4ea7a2]=_0x350c9b[_0x34d382];}),__setModuleDefault=this&&this[a13_0x3d593c(0x145)]||(Object[a13_0x3d593c(0x116)]?function(_0x145f69,_0xdb8bfd){var _0x3327aa=a13_0x3d593c;Object[_0x3327aa(0x159)](_0x145f69,_0x3327aa(0x151),{'enumerable':!![],'value':_0xdb8bfd});}:function(_0x11f2df,_0x271d4a){var _0xdc1646=a13_0x3d593c;_0x11f2df[_0xdc1646(0x151)]=_0x271d4a;}),__importStar=this&&this[a13_0x3d593c(0x11d)]||(function(){var _0x2d65d8=function(_0x4fc732){var _0x45b54a=a13_0x64c7;return _0x2d65d8=Object[_0x45b54a(0x158)]||function(_0x374e2b){var _0x419bfd=_0x45b54a,_0x41abd5=[];for(var _0x51c15f in _0x374e2b)if(Object[_0x419bfd(0x132)][_0x419bfd(0x12b)][_0x419bfd(0x12c)](_0x374e2b,_0x51c15f))_0x41abd5[_0x41abd5[_0x419bfd(0x130)]]=_0x51c15f;return _0x41abd5;},_0x2d65d8(_0x4fc732);};return function(_0x19679d){var _0x65d8c9=a13_0x64c7;if(_0x19679d&&_0x19679d[_0x65d8c9(0x13e)])return _0x19679d;var _0x1df6df={};if(_0x19679d!=null){for(var _0x192a40=_0x2d65d8(_0x19679d),_0x1f7441=0x0;_0x1f7441<_0x192a40[_0x65d8c9(0x130)];_0x1f7441++)if(_0x192a40[_0x1f7441]!==_0x65d8c9(0x151))__createBinding(_0x1df6df,_0x19679d,_0x192a40[_0x1f7441]);}return __setModuleDefault(_0x1df6df,_0x19679d),_0x1df6df;};}()),__importDefault=this&&this[a13_0x3d593c(0x120)]||function(_0x506495){var _0x3cd9ab=a13_0x3d593c;return _0x506495&&_0x506495[_0x3cd9ab(0x13e)]?_0x506495:{'default':_0x506495};};Object['defineProperty'](exports,a13_0x3d593c(0x13e),{'value':!![]}),exports['OnRampController']=void 0x0;const database_1=__importDefault(require('../config/database'));class OnRampController{async[a13_0x3d593c(0x135)](_0x2de72a,_0x10f6ae){var _0x30781c=a13_0x3d593c;try{const {paymentId:_0x20927d,status:_0x13442b,referenceId:_0x28b930,transactionHash:_0x5d6e52,actualCryptoAmount:_0x19fe38,orderId:_0x109c20}=_0x2de72a[_0x30781c(0x13c)];if(!_0x20927d||!_0x13442b){_0x10f6ae[_0x30781c(0x140)](0x190)['json']({'success':![],'message':_0x30781c(0x141)});return;}console['log'](_0x30781c(0x144)+_0x20927d+_0x30781c(0x14d)+_0x13442b),console[_0x30781c(0x14c)](_0x30781c(0x14a),{'referenceId':_0x28b930,'transactionHash':_0x5d6e52,'actualCryptoAmount':_0x19fe38,'orderId':_0x109c20});const _0x256776=await database_1['default'][_0x30781c(0x115)]['findFirst']({'where':{'OR':[{'id':_0x20927d},{'orderId':_0x20927d},{'gatewayOrderId':_0x20927d},{'gatewayPaymentId':_0x20927d}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x256776){_0x10f6ae[_0x30781c(0x140)](0x194)['json']({'success':![],'message':_0x30781c(0x125)});return;}if(_0x256776[_0x30781c(0x11e)]!=='onramp'){_0x10f6ae[_0x30781c(0x140)](0x190)[_0x30781c(0x118)]({'success':![],'message':_0x30781c(0x154)});return;}const _0x19bd70={'status':_0x13442b['toUpperCase'](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0x28b930&&(_0x19bd70[_0x30781c(0x131)]=_0x28b930);_0x5d6e52&&(_0x19bd70[_0x30781c(0x14f)]=_0x5d6e52);_0x19fe38&&(_0x19bd70['invoiceTotalSum']=_0x19fe38);const _0x49de83=await database_1[_0x30781c(0x151)]['payment'][_0x30781c(0x122)]({'where':{'id':_0x256776['id']},'data':_0x19bd70});console[_0x30781c(0x14c)](_0x30781c(0x147)+_0x256776['id']+_0x30781c(0x13f)+_0x13442b),_0x13442b[_0x30781c(0x127)]()==='PAID'&&_0x256776[_0x30781c(0x140)]!=='PAID'&&await this[_0x30781c(0x149)](_0x256776),_0x10f6ae[_0x30781c(0x118)]({'success':!![],'message':_0x30781c(0x11c),'data':{'paymentId':_0x49de83['id'],'status':_0x49de83[_0x30781c(0x140)],'referenceId':_0x28b930,'transactionHash':_0x5d6e52,'actualCryptoAmount':_0x19fe38}});}catch(_0x48a043){console[_0x30781c(0x128)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x48a043),_0x10f6ae[_0x30781c(0x140)](0x1f4)[_0x30781c(0x118)]({'success':![],'message':_0x30781c(0x150),'error':_0x48a043 instanceof Error?_0x48a043[_0x30781c(0x12d)]:'Unknown\x20error'});}}async[a13_0x3d593c(0x149)](_0x120013){var _0x54c2a5=a13_0x3d593c;try{console[_0x54c2a5(0x14c)](_0x54c2a5(0x11b)+_0x120013['id']);let _0x48beee;if(_0x120013['currency']===_0x54c2a5(0x12f))_0x48beee=_0x120013['amount'];else{const {currencyService:_0x5e4c6b}=await Promise[_0x54c2a5(0x139)]()[_0x54c2a5(0x136)](()=>__importStar(require('../services/currencyService')));_0x48beee=await _0x5e4c6b[_0x54c2a5(0x142)](_0x120013[_0x54c2a5(0x148)],_0x120013[_0x54c2a5(0x153)]);}await database_1[_0x54c2a5(0x151)][_0x54c2a5(0x115)][_0x54c2a5(0x122)]({'where':{'id':_0x120013['id']},'data':{'amountUSDT':_0x48beee,'paidAt':new Date()}});const _0x45bdd5=0xa,_0x5b2f7a=_0x48beee*(0x1-_0x45bdd5/0x64);await database_1[_0x54c2a5(0x151)][_0x54c2a5(0x137)]['update']({'where':{'id':_0x120013['shopId']},'data':{'balance':{'increment':_0x5b2f7a}}}),console['log'](_0x54c2a5(0x134)+_0x5b2f7a['toFixed'](0x6)+_0x54c2a5(0x114)+_0x45bdd5+_0x54c2a5(0x124));}catch(_0x98bcb1){console[_0x54c2a5(0x128)](_0x54c2a5(0x157),_0x98bcb1);}}async[a13_0x3d593c(0x123)](_0x2b4b0e,_0x302a53){var _0x39d9f8=a13_0x3d593c;try{const {id:_0x5da2ee}=_0x2b4b0e['params'];if(!_0x5da2ee){_0x302a53['status'](0x190)[_0x39d9f8(0x118)]({'success':![],'message':_0x39d9f8(0x121)});return;}console[_0x39d9f8(0x14c)](_0x39d9f8(0x113)+_0x5da2ee);const _0x185140=await database_1[_0x39d9f8(0x151)][_0x39d9f8(0x115)]['findFirst']({'where':{'OR':[{'id':_0x5da2ee},{'orderId':_0x5da2ee},{'gatewayOrderId':_0x5da2ee},{'gatewayPaymentId':_0x5da2ee}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x185140){_0x302a53[_0x39d9f8(0x140)](0x194)[_0x39d9f8(0x118)]({'success':![],'message':'Payment\x20not\x20found'});return;}console['log']('‚úÖ\x20Found\x20payment:\x20'+_0x185140['id']+'\x20('+_0x185140['status']+')'),_0x302a53[_0x39d9f8(0x118)]({'success':!![],'data':{'id':_0x185140['id'],'gateway':_0x185140[_0x39d9f8(0x11e)],'amount':_0x185140[_0x39d9f8(0x148)],'currency':_0x185140['currency'],'status':_0x185140[_0x39d9f8(0x140)],'gatewayOrderId':_0x185140[_0x39d9f8(0x131)],'gatewayPaymentId':_0x185140[_0x39d9f8(0x14f)],'successUrl':_0x185140[_0x39d9f8(0x13a)],'failUrl':_0x185140['failUrl'],'pendingUrl':_0x185140[_0x39d9f8(0x11a)],'customerEmail':_0x185140[_0x39d9f8(0x133)],'customerName':_0x185140[_0x39d9f8(0x14b)],'merchantBrand':_0x185140[_0x39d9f8(0x137)][_0x39d9f8(0x13d)],'createdAt':_0x185140['createdAt'],'updatedAt':_0x185140['updatedAt']}});}catch(_0x3e0277){console[_0x39d9f8(0x128)]('‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:',_0x3e0277),_0x302a53[_0x39d9f8(0x140)](0x1f4)[_0x39d9f8(0x118)]({'success':![],'message':_0x39d9f8(0x150),'error':_0x3e0277 instanceof Error?_0x3e0277[_0x39d9f8(0x12d)]:_0x39d9f8(0x152)});}}}exports['OnRampController']=OnRampController;