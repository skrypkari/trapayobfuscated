'use strict';var a9_0x540822=a9_0x6f38;function a9_0x7ad0(){var _0x5f0b9a=['Payment\x20ID\x20is\x20required','updateMerchantBalanceForPaidPayment','__importStar','getOwnPropertyDescriptor','onramp_system','failUrl','convertToUSDT','json','PAID','error','Payment\x20status\x20updated\x20successfully','%\x20commission)','name','../services/currencyService','\x20updated\x20to\x20','customerEmail','\x20->\x20','onramp','üìù\x20Data:','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','shop','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','then','__esModule','payment','message','currency','prototype','updatePaymentStatus','customerName','__setModuleDefault','getPaymentData','body','configurable','../config/database','findFirst','amount','successUrl','372822ykXidS','default','resolve','Unknown\x20error','Payment\x20not\x20found','call','üöÄ\x20OnRamp\x20status\x20update:\x20','create','status','2536326EraXtL','gatewayPaymentId','hasOwnProperty','USD','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','get','OnRampController','defineProperty','gateway','Internal\x20server\x20error','updatedAt','toFixed','‚úÖ\x20Found\x20payment:\x20','length','log','2831196TObrZn','__importDefault','__createBinding','update','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','params','581915uDSGQh','1097586tmIUmf','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','5YeBIjM','\x20USDT\x20(after\x20','963216GQuBYM','gatewayOrderId','704926PKgRhX','7TIelDJ','toUpperCase','createdAt'];a9_0x7ad0=function(){return _0x5f0b9a;};return a9_0x7ad0();}(function(_0x5b8cb8,_0x55a3af){var _0xc3f2a8=a9_0x6f38,_0x4b0ec8=_0x5b8cb8();while(!![]){try{var _0x1799a1=parseInt(_0xc3f2a8(0x207))/0x1+parseInt(_0xc3f2a8(0x20e))/0x2+parseInt(_0xc3f2a8(0x208))/0x3+-parseInt(_0xc3f2a8(0x201))/0x4+-parseInt(_0xc3f2a8(0x20a))/0x5*(parseInt(_0xc3f2a8(0x239))/0x6)+-parseInt(_0xc3f2a8(0x20f))/0x7*(-parseInt(_0xc3f2a8(0x20c))/0x8)+-parseInt(_0xc3f2a8(0x1f2))/0x9;if(_0x1799a1===_0x55a3af)break;else _0x4b0ec8['push'](_0x4b0ec8['shift']());}catch(_0x5c208d){_0x4b0ec8['push'](_0x4b0ec8['shift']());}}}(a9_0x7ad0,0x5a0fc));var __createBinding=this&&this[a9_0x540822(0x203)]||(Object[a9_0x540822(0x240)]?function(_0x4fb1ca,_0x48607c,_0x4d3791,_0xb470ff){var _0xc58823=a9_0x540822;if(_0xb470ff===undefined)_0xb470ff=_0x4d3791;var _0x55b051=Object[_0xc58823(0x215)](_0x48607c,_0x4d3791);(!_0x55b051||(_0xc58823(0x1f7)in _0x55b051?!_0x48607c[_0xc58823(0x22a)]:_0x55b051['writable']||_0x55b051[_0xc58823(0x234)]))&&(_0x55b051={'enumerable':!![],'get':function(){return _0x48607c[_0x4d3791];}}),Object[_0xc58823(0x1f9)](_0x4fb1ca,_0xb470ff,_0x55b051);}:function(_0xde320,_0x1076ff,_0x4bbd67,_0x214fc3){if(_0x214fc3===undefined)_0x214fc3=_0x4bbd67;_0xde320[_0x214fc3]=_0x1076ff[_0x4bbd67];}),__setModuleDefault=this&&this[a9_0x540822(0x231)]||(Object[a9_0x540822(0x240)]?function(_0x5815a7,_0x24319d){var _0x587240=a9_0x540822;Object[_0x587240(0x1f9)](_0x5815a7,'default',{'enumerable':!![],'value':_0x24319d});}:function(_0x19c813,_0x20ad9f){var _0x2a857b=a9_0x540822;_0x19c813[_0x2a857b(0x23a)]=_0x20ad9f;}),__importStar=this&&this[a9_0x540822(0x214)]||(function(){var _0x3483cc=function(_0x45d6be){return _0x3483cc=Object['getOwnPropertyNames']||function(_0x5c11be){var _0xafe519=a9_0x6f38,_0x26ff9a=[];for(var _0x51fd9b in _0x5c11be)if(Object[_0xafe519(0x22e)][_0xafe519(0x1f4)][_0xafe519(0x23e)](_0x5c11be,_0x51fd9b))_0x26ff9a[_0x26ff9a[_0xafe519(0x1ff)]]=_0x51fd9b;return _0x26ff9a;},_0x3483cc(_0x45d6be);};return function(_0x4905de){var _0x14f2ab=a9_0x6f38;if(_0x4905de&&_0x4905de[_0x14f2ab(0x22a)])return _0x4905de;var _0x1eef7d={};if(_0x4905de!=null){for(var _0x374976=_0x3483cc(_0x4905de),_0x3a8c5a=0x0;_0x3a8c5a<_0x374976[_0x14f2ab(0x1ff)];_0x3a8c5a++)if(_0x374976[_0x3a8c5a]!=='default')__createBinding(_0x1eef7d,_0x4905de,_0x374976[_0x3a8c5a]);}return __setModuleDefault(_0x1eef7d,_0x4905de),_0x1eef7d;};}()),__importDefault=this&&this[a9_0x540822(0x202)]||function(_0x41901e){var _0x31f074=a9_0x540822;return _0x41901e&&_0x41901e[_0x31f074(0x22a)]?_0x41901e:{'default':_0x41901e};};Object['defineProperty'](exports,a9_0x540822(0x22a),{'value':!![]}),exports['OnRampController']=void 0x0;function a9_0x6f38(_0x52a0de,_0x552582){var _0x7ad0c2=a9_0x7ad0();return a9_0x6f38=function(_0x6f3837,_0x331e56){_0x6f3837=_0x6f3837-0x1f1;var _0x202a6c=_0x7ad0c2[_0x6f3837];return _0x202a6c;},a9_0x6f38(_0x52a0de,_0x552582);}const database_1=__importDefault(require(a9_0x540822(0x235)));class OnRampController{async[a9_0x540822(0x22f)](_0x4bceeb,_0xaeddd){var _0x4e3db3=a9_0x540822;try{const {paymentId:_0x240ff2,status:_0x350d6a,referenceId:_0x20b692,transactionHash:_0x31bce0,actualCryptoAmount:_0x26da82,orderId:_0x34ce36}=_0x4bceeb[_0x4e3db3(0x233)];if(!_0x240ff2||!_0x350d6a){_0xaeddd[_0x4e3db3(0x1f1)](0x190)[_0x4e3db3(0x219)]({'success':![],'message':'Payment\x20ID\x20and\x20status\x20are\x20required'});return;}console['log'](_0x4e3db3(0x23f)+_0x240ff2+_0x4e3db3(0x222)+_0x350d6a),console[_0x4e3db3(0x200)](_0x4e3db3(0x224),{'referenceId':_0x20b692,'transactionHash':_0x31bce0,'actualCryptoAmount':_0x26da82,'orderId':_0x34ce36});const _0x2e35a2=await database_1[_0x4e3db3(0x23a)][_0x4e3db3(0x22b)]['findFirst']({'where':{'OR':[{'id':_0x240ff2},{'orderId':_0x240ff2},{'gatewayOrderId':_0x240ff2},{'gatewayPaymentId':_0x240ff2}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x2e35a2){_0xaeddd[_0x4e3db3(0x1f1)](0x194)['json']({'success':![],'message':_0x4e3db3(0x23d)});return;}if(_0x2e35a2[_0x4e3db3(0x1fa)]!==_0x4e3db3(0x223)){_0xaeddd[_0x4e3db3(0x1f1)](0x190)[_0x4e3db3(0x219)]({'success':![],'message':_0x4e3db3(0x228)});return;}const _0x5f18c4={'status':_0x350d6a['toUpperCase'](),'statusChangedAt':new Date(),'statusChangedBy':_0x4e3db3(0x216)};_0x20b692&&(_0x5f18c4[_0x4e3db3(0x20d)]=_0x20b692);_0x31bce0&&(_0x5f18c4['gatewayPaymentId']=_0x31bce0);_0x26da82&&(_0x5f18c4['invoiceTotalSum']=_0x26da82);const _0x5eb8b9=await database_1['default'][_0x4e3db3(0x22b)][_0x4e3db3(0x204)]({'where':{'id':_0x2e35a2['id']},'data':_0x5f18c4});console[_0x4e3db3(0x200)]('‚úÖ\x20OnRamp\x20payment\x20'+_0x2e35a2['id']+_0x4e3db3(0x220)+_0x350d6a),_0x350d6a[_0x4e3db3(0x210)]()===_0x4e3db3(0x21a)&&_0x2e35a2['status']!==_0x4e3db3(0x21a)&&await this['updateMerchantBalanceForPaidPayment'](_0x2e35a2),_0xaeddd[_0x4e3db3(0x219)]({'success':!![],'message':_0x4e3db3(0x21c),'data':{'paymentId':_0x5eb8b9['id'],'status':_0x5eb8b9[_0x4e3db3(0x1f1)],'referenceId':_0x20b692,'transactionHash':_0x31bce0,'actualCryptoAmount':_0x26da82}});}catch(_0x4d6e41){console[_0x4e3db3(0x21b)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x4d6e41),_0xaeddd['status'](0x1f4)[_0x4e3db3(0x219)]({'success':![],'message':_0x4e3db3(0x1fb),'error':_0x4d6e41 instanceof Error?_0x4d6e41[_0x4e3db3(0x22c)]:_0x4e3db3(0x23c)});}}async[a9_0x540822(0x213)](_0x2f013a){var _0x2c2002=a9_0x540822;try{console[_0x2c2002(0x200)](_0x2c2002(0x1f6)+_0x2f013a['id']);let _0x49bd16;if(_0x2f013a[_0x2c2002(0x22d)]===_0x2c2002(0x1f5))_0x49bd16=_0x2f013a['amount'];else{const {currencyService:_0x5ed6d3}=await Promise[_0x2c2002(0x23b)]()[_0x2c2002(0x229)](()=>__importStar(require(_0x2c2002(0x21f))));_0x49bd16=await _0x5ed6d3[_0x2c2002(0x218)](_0x2f013a[_0x2c2002(0x237)],_0x2f013a[_0x2c2002(0x22d)]);}await database_1[_0x2c2002(0x23a)][_0x2c2002(0x22b)][_0x2c2002(0x204)]({'where':{'id':_0x2f013a['id']},'data':{'amountUSDT':_0x49bd16,'paidAt':new Date()}});const _0x5b483e=0xa,_0x29c11b=_0x49bd16*(0x1-_0x5b483e/0x64);await database_1[_0x2c2002(0x23a)][_0x2c2002(0x227)]['update']({'where':{'id':_0x2f013a['shopId']},'data':{'balance':{'increment':_0x29c11b}}}),console['log'](_0x2c2002(0x226)+_0x29c11b[_0x2c2002(0x1fd)](0x6)+_0x2c2002(0x20b)+_0x5b483e+_0x2c2002(0x21d));}catch(_0x49933e){console[_0x2c2002(0x21b)](_0x2c2002(0x209),_0x49933e);}}async[a9_0x540822(0x232)](_0x10a0d2,_0x25d05f){var _0x21f731=a9_0x540822;try{const {id:_0x237244}=_0x10a0d2[_0x21f731(0x206)];if(!_0x237244){_0x25d05f[_0x21f731(0x1f1)](0x190)[_0x21f731(0x219)]({'success':![],'message':_0x21f731(0x212)});return;}console[_0x21f731(0x200)](_0x21f731(0x205)+_0x237244);const _0x1bb4c6=await database_1[_0x21f731(0x23a)][_0x21f731(0x22b)][_0x21f731(0x236)]({'where':{'OR':[{'id':_0x237244},{'orderId':_0x237244},{'gatewayOrderId':_0x237244},{'gatewayPaymentId':_0x237244}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x1bb4c6){_0x25d05f['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});return;}console[_0x21f731(0x200)](_0x21f731(0x1fe)+_0x1bb4c6['id']+'\x20('+_0x1bb4c6[_0x21f731(0x1f1)]+')'),_0x25d05f['json']({'success':!![],'data':{'id':_0x1bb4c6['id'],'gateway':_0x1bb4c6['gateway'],'amount':_0x1bb4c6[_0x21f731(0x237)],'currency':_0x1bb4c6['currency'],'status':_0x1bb4c6[_0x21f731(0x1f1)],'gatewayOrderId':_0x1bb4c6['gatewayOrderId'],'gatewayPaymentId':_0x1bb4c6[_0x21f731(0x1f3)],'successUrl':_0x1bb4c6[_0x21f731(0x238)],'failUrl':_0x1bb4c6[_0x21f731(0x217)],'pendingUrl':_0x1bb4c6['pendingUrl'],'customerEmail':_0x1bb4c6[_0x21f731(0x221)],'customerName':_0x1bb4c6[_0x21f731(0x230)],'merchantBrand':_0x1bb4c6['shop'][_0x21f731(0x21e)],'createdAt':_0x1bb4c6[_0x21f731(0x211)],'updatedAt':_0x1bb4c6[_0x21f731(0x1fc)]}});}catch(_0x90deca){console[_0x21f731(0x21b)](_0x21f731(0x225),_0x90deca),_0x25d05f['status'](0x1f4)[_0x21f731(0x219)]({'success':![],'message':_0x21f731(0x1fb),'error':_0x90deca instanceof Error?_0x90deca['message']:'Unknown\x20error'});}}}exports[a9_0x540822(0x1f8)]=OnRampController;