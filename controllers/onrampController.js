'use strict';var a13_0x65c7a1=a13_0x3609;(function(_0x232dc5,_0xd0fcc){var _0x6ae05f=a13_0x3609,_0x1fdecd=_0x232dc5();while(!![]){try{var _0x17b173=-parseInt(_0x6ae05f(0xcf))/0x1*(parseInt(_0x6ae05f(0xd9))/0x2)+parseInt(_0x6ae05f(0xfe))/0x3+-parseInt(_0x6ae05f(0x112))/0x4+parseInt(_0x6ae05f(0x106))/0x5*(parseInt(_0x6ae05f(0xd5))/0x6)+parseInt(_0x6ae05f(0x10f))/0x7*(parseInt(_0x6ae05f(0x10b))/0x8)+-parseInt(_0x6ae05f(0x110))/0x9+-parseInt(_0x6ae05f(0x111))/0xa;if(_0x17b173===_0xd0fcc)break;else _0x1fdecd['push'](_0x1fdecd['shift']());}catch(_0x1222af){_0x1fdecd['push'](_0x1fdecd['shift']());}}}(a13_0x5bae,0xd4b2e));function a13_0x5bae(){var _0x58a757=['getOwnPropertyNames','length','4444818nSZTFR','../config/database','writable','findFirst','\x20->\x20','failUrl','default','getPaymentData','40gOCvmy','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','Payment\x20ID\x20is\x20required','gatewayOrderId','hasOwnProperty','117352xuIhHs','createdAt','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','defineProperty','651HlSXkG','11112840BFiXQH','11258210TbpAjb','1503940GcaEQw','gatewayPaymentId','\x20updated\x20to\x20','resolve','726171RegGAO','then','status','toFixed','convertToUSDT','\x20USDT\x20(after\x20','1116096apdXoS','updatedAt','getOwnPropertyDescriptor','USD','2GvAWLe','update','updateMerchantBalanceForPaidPayment','amount','successUrl','Unknown\x20error','log','Payment\x20ID\x20and\x20status\x20are\x20required','payment','currency','params','OnRampController','onramp_system','gateway','prototype','shop','message','body','error','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','Internal\x20server\x20error','‚úÖ\x20Merchant\x20balance\x20updated:\x20+','__esModule','Payment\x20status\x20updated\x20successfully','pendingUrl','Payment\x20not\x20found','‚úÖ\x20Found\x20payment:\x20','invoiceTotalSum','updatePaymentStatus','__importStar','json','customerName','onramp','toUpperCase','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway'];a13_0x5bae=function(){return _0x58a757;};return a13_0x5bae();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x502c99,_0x26d915,_0x34a371,_0x193181){var _0x785d1b=a13_0x3609;if(_0x193181===undefined)_0x193181=_0x34a371;var _0x2ad09c=Object[_0x785d1b(0xd7)](_0x26d915,_0x34a371);(!_0x2ad09c||('get'in _0x2ad09c?!_0x26d915['__esModule']:_0x2ad09c[_0x785d1b(0x100)]||_0x2ad09c['configurable']))&&(_0x2ad09c={'enumerable':!![],'get':function(){return _0x26d915[_0x34a371];}}),Object['defineProperty'](_0x502c99,_0x193181,_0x2ad09c);}:function(_0x5a4cb8,_0x3d516f,_0x5a3194,_0x4b7424){if(_0x4b7424===undefined)_0x4b7424=_0x5a3194;_0x5a4cb8[_0x4b7424]=_0x3d516f[_0x5a3194];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0xc6ff24,_0xd5e43b){var _0x1a8664=a13_0x3609;Object[_0x1a8664(0x10e)](_0xc6ff24,_0x1a8664(0x104),{'enumerable':!![],'value':_0xd5e43b});}:function(_0xcd495e,_0xc60910){var _0x28f2b6=a13_0x3609;_0xcd495e[_0x28f2b6(0x104)]=_0xc60910;}),__importStar=this&&this[a13_0x65c7a1(0xf6)]||(function(){var _0x148cfe=function(_0x150c19){var _0x7f82e1=a13_0x3609;return _0x148cfe=Object[_0x7f82e1(0xfc)]||function(_0x8d5952){var _0x2e1129=_0x7f82e1,_0xdb0394=[];for(var _0x21b80e in _0x8d5952)if(Object[_0x2e1129(0xe7)][_0x2e1129(0x10a)]['call'](_0x8d5952,_0x21b80e))_0xdb0394[_0xdb0394[_0x2e1129(0xfd)]]=_0x21b80e;return _0xdb0394;},_0x148cfe(_0x150c19);};return function(_0x48da0e){var _0x392947=a13_0x3609;if(_0x48da0e&&_0x48da0e[_0x392947(0xef)])return _0x48da0e;var _0xa1ec60={};if(_0x48da0e!=null){for(var _0x2e4ee3=_0x148cfe(_0x48da0e),_0x4c7529=0x0;_0x4c7529<_0x2e4ee3['length'];_0x4c7529++)if(_0x2e4ee3[_0x4c7529]!==_0x392947(0x104))__createBinding(_0xa1ec60,_0x48da0e,_0x2e4ee3[_0x4c7529]);}return __setModuleDefault(_0xa1ec60,_0x48da0e),_0xa1ec60;};}()),__importDefault=this&&this['__importDefault']||function(_0x3aa72b){var _0x5c9555=a13_0x65c7a1;return _0x3aa72b&&_0x3aa72b[_0x5c9555(0xef)]?_0x3aa72b:{'default':_0x3aa72b};};function a13_0x3609(_0x2bda0f,_0x26a07a){_0x2bda0f=_0x2bda0f-0xce;var _0x5bae4c=a13_0x5bae();var _0x3609d4=_0x5bae4c[_0x2bda0f];return _0x3609d4;}Object['defineProperty'](exports,a13_0x65c7a1(0xef),{'value':!![]}),exports[a13_0x65c7a1(0xe4)]=void 0x0;const database_1=__importDefault(require(a13_0x65c7a1(0xff)));class OnRampController{async[a13_0x65c7a1(0xf5)](_0x48905b,_0xf95119){var _0x1a939d=a13_0x65c7a1;try{const {paymentId:_0x25033b,status:_0x5ad992,referenceId:_0x4397c4,transactionHash:_0x59e340,actualCryptoAmount:_0x240f4f,orderId:_0x23974c}=_0x48905b[_0x1a939d(0xea)];if(!_0x25033b||!_0x5ad992){_0xf95119[_0x1a939d(0xd1)](0x190)['json']({'success':![],'message':_0x1a939d(0xe0)});return;}console[_0x1a939d(0xdf)]('üöÄ\x20OnRamp\x20status\x20update:\x20'+_0x25033b+_0x1a939d(0x102)+_0x5ad992),console['log']('üìù\x20Data:',{'referenceId':_0x4397c4,'transactionHash':_0x59e340,'actualCryptoAmount':_0x240f4f,'orderId':_0x23974c});const _0x5399ef=await database_1[_0x1a939d(0x104)]['payment'][_0x1a939d(0x101)]({'where':{'OR':[{'id':_0x25033b},{'orderId':_0x25033b},{'gatewayOrderId':_0x25033b},{'gatewayPaymentId':_0x25033b}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x5399ef){_0xf95119['status'](0x194)[_0x1a939d(0xf7)]({'success':![],'message':_0x1a939d(0xf2)});return;}if(_0x5399ef['gateway']!==_0x1a939d(0xf9)){_0xf95119[_0x1a939d(0xd1)](0x190)[_0x1a939d(0xf7)]({'success':![],'message':_0x1a939d(0xfb)});return;}const _0x3382b5={'status':_0x5ad992[_0x1a939d(0xfa)](),'statusChangedAt':new Date(),'statusChangedBy':_0x1a939d(0xe5)};_0x4397c4&&(_0x3382b5[_0x1a939d(0x109)]=_0x4397c4);_0x59e340&&(_0x3382b5[_0x1a939d(0x113)]=_0x59e340);_0x240f4f&&(_0x3382b5[_0x1a939d(0xf4)]=_0x240f4f);const _0x456901=await database_1[_0x1a939d(0x104)][_0x1a939d(0xe1)][_0x1a939d(0xda)]({'where':{'id':_0x5399ef['id']},'data':_0x3382b5});console['log']('‚úÖ\x20OnRamp\x20payment\x20'+_0x5399ef['id']+_0x1a939d(0x114)+_0x5ad992),_0x5ad992[_0x1a939d(0xfa)]()==='PAID'&&_0x5399ef[_0x1a939d(0xd1)]!=='PAID'&&await this[_0x1a939d(0xdb)](_0x5399ef),_0xf95119['json']({'success':!![],'message':_0x1a939d(0xf0),'data':{'paymentId':_0x456901['id'],'status':_0x456901[_0x1a939d(0xd1)],'referenceId':_0x4397c4,'transactionHash':_0x59e340,'actualCryptoAmount':_0x240f4f}});}catch(_0x3948bb){console['error']('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x3948bb),_0xf95119[_0x1a939d(0xd1)](0x1f4)[_0x1a939d(0xf7)]({'success':![],'message':_0x1a939d(0xed),'error':_0x3948bb instanceof Error?_0x3948bb[_0x1a939d(0xe9)]:_0x1a939d(0xde)});}}async['updateMerchantBalanceForPaidPayment'](_0x9be8ad){var _0x2a0550=a13_0x65c7a1;try{console[_0x2a0550(0xdf)](_0x2a0550(0x107)+_0x9be8ad['id']);let _0x595483;if(_0x9be8ad[_0x2a0550(0xe2)]===_0x2a0550(0xd8))_0x595483=_0x9be8ad[_0x2a0550(0xdc)];else{const {currencyService:_0x1f5d48}=await Promise[_0x2a0550(0xce)]()[_0x2a0550(0xd0)](()=>__importStar(require('../services/currencyService')));_0x595483=await _0x1f5d48[_0x2a0550(0xd3)](_0x9be8ad[_0x2a0550(0xdc)],_0x9be8ad['currency']);}await database_1[_0x2a0550(0x104)][_0x2a0550(0xe1)][_0x2a0550(0xda)]({'where':{'id':_0x9be8ad['id']},'data':{'amountUSDT':_0x595483,'paidAt':new Date()}});const _0x4fa8bd=0xa,_0x4dda0c=_0x595483*(0x1-_0x4fa8bd/0x64);await database_1['default']['shop'][_0x2a0550(0xda)]({'where':{'id':_0x9be8ad['shopId']},'data':{'balance':{'increment':_0x4dda0c}}}),console['log'](_0x2a0550(0xee)+_0x4dda0c[_0x2a0550(0xd2)](0x6)+_0x2a0550(0xd4)+_0x4fa8bd+'%\x20commission)');}catch(_0x35064b){console[_0x2a0550(0xeb)]('‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:',_0x35064b);}}async[a13_0x65c7a1(0x105)](_0x4095cf,_0x522f6f){var _0x293376=a13_0x65c7a1;try{const {id:_0x323cd9}=_0x4095cf[_0x293376(0xe3)];if(!_0x323cd9){_0x522f6f[_0x293376(0xd1)](0x190)['json']({'success':![],'message':_0x293376(0x108)});return;}console['log'](_0x293376(0x10d)+_0x323cd9);const _0x3a7ac3=await database_1[_0x293376(0x104)][_0x293376(0xe1)][_0x293376(0x101)]({'where':{'OR':[{'id':_0x323cd9},{'orderId':_0x323cd9},{'gatewayOrderId':_0x323cd9},{'gatewayPaymentId':_0x323cd9}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0x3a7ac3){_0x522f6f[_0x293376(0xd1)](0x194)[_0x293376(0xf7)]({'success':![],'message':_0x293376(0xf2)});return;}console[_0x293376(0xdf)](_0x293376(0xf3)+_0x3a7ac3['id']+'\x20('+_0x3a7ac3[_0x293376(0xd1)]+')'),_0x522f6f[_0x293376(0xf7)]({'success':!![],'data':{'id':_0x3a7ac3['id'],'gateway':_0x3a7ac3[_0x293376(0xe6)],'amount':_0x3a7ac3[_0x293376(0xdc)],'currency':_0x3a7ac3['currency'],'status':_0x3a7ac3['status'],'gatewayOrderId':_0x3a7ac3[_0x293376(0x109)],'gatewayPaymentId':_0x3a7ac3['gatewayPaymentId'],'successUrl':_0x3a7ac3[_0x293376(0xdd)],'failUrl':_0x3a7ac3[_0x293376(0x103)],'pendingUrl':_0x3a7ac3[_0x293376(0xf1)],'customerEmail':_0x3a7ac3['customerEmail'],'customerName':_0x3a7ac3[_0x293376(0xf8)],'merchantBrand':_0x3a7ac3[_0x293376(0xe8)]['name'],'createdAt':_0x3a7ac3[_0x293376(0x10c)],'updatedAt':_0x3a7ac3[_0x293376(0xd6)]}});}catch(_0x4cdc42){console[_0x293376(0xeb)](_0x293376(0xec),_0x4cdc42),_0x522f6f['status'](0x1f4)[_0x293376(0xf7)]({'success':![],'message':'Internal\x20server\x20error','error':_0x4cdc42 instanceof Error?_0x4cdc42[_0x293376(0xe9)]:_0x293376(0xde)});}}}exports['OnRampController']=OnRampController;