'use strict';function a9_0x1aee(){var _0x2376e9=['payment','default','This\x20payment\x20is\x20not\x20for\x20OnRamp\x20gateway','1058296rwUOKc','call','body','11060sFeTSx','Internal\x20server\x20error','\x20USDT\x20(after\x20','üí∞\x20Updating\x20merchant\x20balance\x20for\x20paid\x20OnRamp\x20payment:\x20','‚ùå\x20Failed\x20to\x20update\x20merchant\x20balance:','gatewayOrderId','log','create','toFixed','\x20updated\x20to\x20','365324ZEVKki','‚úÖ\x20OnRamp\x20payment\x20','message','update','__importDefault','updatePaymentStatus','params','Payment\x20ID\x20is\x20required','‚ùå\x20OnRamp\x20get\x20payment\x20data\x20error:','length','10JSCdpP','4DjdgGK','status','amount','then','convertToUSDT','failUrl','createdAt','__esModule','writable','gateway','invoiceTotalSum','get','defineProperty','../services/currencyService','onramp','821112WqfKmc','name','currency','findFirst','OnRampController','4240224pIlQEH','json','2436321obaOvX','üöÄ\x20OnRamp\x20status\x20update:\x20','10250324vfuQkz','../config/database','13156CFCaLb','\x20->\x20','__setModuleDefault','Payment\x20ID\x20and\x20status\x20are\x20required','resolve','customerEmail','üîç\x20Getting\x20OnRamp\x20payment\x20data:\x20','customerName','getOwnPropertyDescriptor','configurable','PAID','63wOxeFk','error','Payment\x20not\x20found','updatedAt','__importStar','getPaymentData','__createBinding','shop'];a9_0x1aee=function(){return _0x2376e9;};return a9_0x1aee();}var a9_0x12bc21=a9_0x338f;function a9_0x338f(_0x428e31,_0x2ed54b){var _0x1aeea7=a9_0x1aee();return a9_0x338f=function(_0x338f24,_0x213760){_0x338f24=_0x338f24-0xc9;var _0x2bb4c4=_0x1aeea7[_0x338f24];return _0x2bb4c4;},a9_0x338f(_0x428e31,_0x2ed54b);}(function(_0x48466e,_0x367e31){var _0x1b802f=a9_0x338f,_0x63f943=_0x48466e();while(!![]){try{var _0x223548=-parseInt(_0x1b802f(0xd4))/0x1*(parseInt(_0x1b802f(0xdf))/0x2)+-parseInt(_0x1b802f(0xf5))/0x3+-parseInt(_0x1b802f(0xee))/0x4+parseInt(_0x1b802f(0xde))/0x5*(parseInt(_0x1b802f(0xf3))/0x6)+parseInt(_0x1b802f(0xf7))/0x7+parseInt(_0x1b802f(0x10f))/0x8*(parseInt(_0x1b802f(0x104))/0x9)+parseInt(_0x1b802f(0xca))/0xa*(-parseInt(_0x1b802f(0xf9))/0xb);if(_0x223548===_0x367e31)break;else _0x63f943['push'](_0x63f943['shift']());}catch(_0x1a4efb){_0x63f943['push'](_0x63f943['shift']());}}}(a9_0x1aee,0xb2f0c));var __createBinding=this&&this[a9_0x12bc21(0x10a)]||(Object[a9_0x12bc21(0xd1)]?function(_0x479c9e,_0x54398d,_0x49a432,_0x3bca76){var _0x26fd06=a9_0x12bc21;if(_0x3bca76===undefined)_0x3bca76=_0x49a432;var _0x18ed28=Object[_0x26fd06(0x101)](_0x54398d,_0x49a432);(!_0x18ed28||(_0x26fd06(0xea)in _0x18ed28?!_0x54398d[_0x26fd06(0xe6)]:_0x18ed28[_0x26fd06(0xe7)]||_0x18ed28[_0x26fd06(0x102)]))&&(_0x18ed28={'enumerable':!![],'get':function(){return _0x54398d[_0x49a432];}}),Object[_0x26fd06(0xeb)](_0x479c9e,_0x3bca76,_0x18ed28);}:function(_0x31f436,_0xa45695,_0x50fd55,_0x4c52a4){if(_0x4c52a4===undefined)_0x4c52a4=_0x50fd55;_0x31f436[_0x4c52a4]=_0xa45695[_0x50fd55];}),__setModuleDefault=this&&this[a9_0x12bc21(0xfb)]||(Object['create']?function(_0x303ab9,_0x5a1b78){var _0x4c39cd=a9_0x12bc21;Object['defineProperty'](_0x303ab9,_0x4c39cd(0x10d),{'enumerable':!![],'value':_0x5a1b78});}:function(_0x523d8d,_0x43b8aa){var _0x34312c=a9_0x12bc21;_0x523d8d[_0x34312c(0x10d)]=_0x43b8aa;}),__importStar=this&&this[a9_0x12bc21(0x108)]||(function(){var _0x348374=function(_0xdd864d){return _0x348374=Object['getOwnPropertyNames']||function(_0x5221cd){var _0x4dea33=a9_0x338f,_0x2fd617=[];for(var _0x44a0fa in _0x5221cd)if(Object['prototype']['hasOwnProperty'][_0x4dea33(0x110)](_0x5221cd,_0x44a0fa))_0x2fd617[_0x2fd617['length']]=_0x44a0fa;return _0x2fd617;},_0x348374(_0xdd864d);};return function(_0xd4e8f1){var _0x13dcd1=a9_0x338f;if(_0xd4e8f1&&_0xd4e8f1[_0x13dcd1(0xe6)])return _0xd4e8f1;var _0x20f596={};if(_0xd4e8f1!=null){for(var _0x300593=_0x348374(_0xd4e8f1),_0x1065cf=0x0;_0x1065cf<_0x300593[_0x13dcd1(0xdd)];_0x1065cf++)if(_0x300593[_0x1065cf]!==_0x13dcd1(0x10d))__createBinding(_0x20f596,_0xd4e8f1,_0x300593[_0x1065cf]);}return __setModuleDefault(_0x20f596,_0xd4e8f1),_0x20f596;};}()),__importDefault=this&&this[a9_0x12bc21(0xd8)]||function(_0x22cf84){var _0x8400fe=a9_0x12bc21;return _0x22cf84&&_0x22cf84[_0x8400fe(0xe6)]?_0x22cf84:{'default':_0x22cf84};};Object[a9_0x12bc21(0xeb)](exports,a9_0x12bc21(0xe6),{'value':!![]}),exports[a9_0x12bc21(0xf2)]=void 0x0;const database_1=__importDefault(require(a9_0x12bc21(0xf8)));class OnRampController{async[a9_0x12bc21(0xd9)](_0x3a1259,_0x507ed2){var _0x774044=a9_0x12bc21;try{const {paymentId:_0x4e11eb,status:_0x971a2,referenceId:_0x44c3a3,transactionHash:_0x16ce82,actualCryptoAmount:_0x35822f,orderId:_0x566566}=_0x3a1259[_0x774044(0xc9)];if(!_0x4e11eb||!_0x971a2){_0x507ed2[_0x774044(0xe0)](0x190)[_0x774044(0xf4)]({'success':![],'message':_0x774044(0xfc)});return;}console[_0x774044(0xd0)](_0x774044(0xf6)+_0x4e11eb+_0x774044(0xfa)+_0x971a2),console[_0x774044(0xd0)]('üìù\x20Data:',{'referenceId':_0x44c3a3,'transactionHash':_0x16ce82,'actualCryptoAmount':_0x35822f,'orderId':_0x566566});const _0x50df1c=await database_1[_0x774044(0x10d)][_0x774044(0x10c)][_0x774044(0xf1)]({'where':{'OR':[{'id':_0x4e11eb},{'orderId':_0x4e11eb},{'gatewayOrderId':_0x4e11eb},{'gatewayPaymentId':_0x4e11eb}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![],'balance':!![]}}}});if(!_0x50df1c){_0x507ed2[_0x774044(0xe0)](0x194)[_0x774044(0xf4)]({'success':![],'message':_0x774044(0x106)});return;}if(_0x50df1c['gateway']!==_0x774044(0xed)){_0x507ed2[_0x774044(0xe0)](0x190)[_0x774044(0xf4)]({'success':![],'message':_0x774044(0x10e)});return;}const _0x37fcad={'status':_0x971a2['toUpperCase'](),'statusChangedAt':new Date(),'statusChangedBy':'onramp_system'};_0x44c3a3&&(_0x37fcad[_0x774044(0xcf)]=_0x44c3a3);_0x16ce82&&(_0x37fcad['gatewayPaymentId']=_0x16ce82);_0x35822f&&(_0x37fcad[_0x774044(0xe9)]=_0x35822f);const _0x22c3de=await database_1[_0x774044(0x10d)]['payment'][_0x774044(0xd7)]({'where':{'id':_0x50df1c['id']},'data':_0x37fcad});console[_0x774044(0xd0)](_0x774044(0xd5)+_0x50df1c['id']+_0x774044(0xd3)+_0x971a2),_0x971a2['toUpperCase']()===_0x774044(0x103)&&_0x50df1c[_0x774044(0xe0)]!==_0x774044(0x103)&&await this['updateMerchantBalanceForPaidPayment'](_0x50df1c),_0x507ed2[_0x774044(0xf4)]({'success':!![],'message':'Payment\x20status\x20updated\x20successfully','data':{'paymentId':_0x22c3de['id'],'status':_0x22c3de[_0x774044(0xe0)],'referenceId':_0x44c3a3,'transactionHash':_0x16ce82,'actualCryptoAmount':_0x35822f}});}catch(_0x40ddc9){console[_0x774044(0x105)]('‚ùå\x20OnRamp\x20status\x20update\x20error:',_0x40ddc9),_0x507ed2[_0x774044(0xe0)](0x1f4)[_0x774044(0xf4)]({'success':![],'message':_0x774044(0xcb),'error':_0x40ddc9 instanceof Error?_0x40ddc9[_0x774044(0xd6)]:'Unknown\x20error'});}}async['updateMerchantBalanceForPaidPayment'](_0x4e522c){var _0x1f8e40=a9_0x12bc21;try{console[_0x1f8e40(0xd0)](_0x1f8e40(0xcd)+_0x4e522c['id']);let _0x1c12f6;if(_0x4e522c[_0x1f8e40(0xf0)]==='USD')_0x1c12f6=_0x4e522c['amount'];else{const {currencyService:_0x5c73af}=await Promise[_0x1f8e40(0xfd)]()[_0x1f8e40(0xe2)](()=>__importStar(require(_0x1f8e40(0xec))));_0x1c12f6=await _0x5c73af[_0x1f8e40(0xe3)](_0x4e522c['amount'],_0x4e522c['currency']);}await database_1[_0x1f8e40(0x10d)][_0x1f8e40(0x10c)][_0x1f8e40(0xd7)]({'where':{'id':_0x4e522c['id']},'data':{'amountUSDT':_0x1c12f6,'paidAt':new Date()}});const _0x52ab14=0xa,_0x4067bf=_0x1c12f6*(0x1-_0x52ab14/0x64);await database_1[_0x1f8e40(0x10d)][_0x1f8e40(0x10b)][_0x1f8e40(0xd7)]({'where':{'id':_0x4e522c['shopId']},'data':{'balance':{'increment':_0x4067bf}}}),console[_0x1f8e40(0xd0)]('‚úÖ\x20Merchant\x20balance\x20updated:\x20+'+_0x4067bf[_0x1f8e40(0xd2)](0x6)+_0x1f8e40(0xcc)+_0x52ab14+'%\x20commission)');}catch(_0x4caaef){console[_0x1f8e40(0x105)](_0x1f8e40(0xce),_0x4caaef);}}async[a9_0x12bc21(0x109)](_0x281dd4,_0x5c853b){var _0x39744c=a9_0x12bc21;try{const {id:_0x4c132b}=_0x281dd4[_0x39744c(0xda)];if(!_0x4c132b){_0x5c853b[_0x39744c(0xe0)](0x190)[_0x39744c(0xf4)]({'success':![],'message':_0x39744c(0xdb)});return;}console[_0x39744c(0xd0)](_0x39744c(0xff)+_0x4c132b);const _0xf6d39a=await database_1[_0x39744c(0x10d)][_0x39744c(0x10c)][_0x39744c(0xf1)]({'where':{'OR':[{'id':_0x4c132b},{'orderId':_0x4c132b},{'gatewayOrderId':_0x4c132b},{'gatewayPaymentId':_0x4c132b}]},'include':{'shop':{'select':{'id':!![],'name':!![],'username':!![]}}}});if(!_0xf6d39a){_0x5c853b['status'](0x194)[_0x39744c(0xf4)]({'success':![],'message':_0x39744c(0x106)});return;}console[_0x39744c(0xd0)]('‚úÖ\x20Found\x20payment:\x20'+_0xf6d39a['id']+'\x20('+_0xf6d39a['status']+')'),_0x5c853b[_0x39744c(0xf4)]({'success':!![],'data':{'id':_0xf6d39a['id'],'gateway':_0xf6d39a[_0x39744c(0xe8)],'amount':_0xf6d39a[_0x39744c(0xe1)],'currency':_0xf6d39a[_0x39744c(0xf0)],'status':_0xf6d39a['status'],'gatewayOrderId':_0xf6d39a[_0x39744c(0xcf)],'gatewayPaymentId':_0xf6d39a['gatewayPaymentId'],'successUrl':_0xf6d39a['successUrl'],'failUrl':_0xf6d39a[_0x39744c(0xe4)],'pendingUrl':_0xf6d39a['pendingUrl'],'customerEmail':_0xf6d39a[_0x39744c(0xfe)],'customerName':_0xf6d39a[_0x39744c(0x100)],'merchantBrand':_0xf6d39a[_0x39744c(0x10b)][_0x39744c(0xef)],'createdAt':_0xf6d39a[_0x39744c(0xe5)],'updatedAt':_0xf6d39a[_0x39744c(0x107)]}});}catch(_0x2100e3){console[_0x39744c(0x105)](_0x39744c(0xdc),_0x2100e3),_0x5c853b['status'](0x1f4)[_0x39744c(0xf4)]({'success':![],'message':_0x39744c(0xcb),'error':_0x2100e3 instanceof Error?_0x2100e3[_0x39744c(0xd6)]:'Unknown\x20error'});}}}exports[a9_0x12bc21(0xf2)]=OnRampController;