'use strict';const a18_0x3edfb5=a18_0x7b2e;(function(_0x4e679e,_0x5e2bd9){const _0x211ecb=a18_0x7b2e,_0x1299f8=_0x4e679e();while(!![]){try{const _0x2f704f=-parseInt(_0x211ecb(0x1ef))/0x1*(parseInt(_0x211ecb(0x228))/0x2)+-parseInt(_0x211ecb(0x240))/0x3+parseInt(_0x211ecb(0x23b))/0x4+-parseInt(_0x211ecb(0x1f6))/0x5*(parseInt(_0x211ecb(0x22d))/0x6)+-parseInt(_0x211ecb(0x206))/0x7*(parseInt(_0x211ecb(0x220))/0x8)+parseInt(_0x211ecb(0x243))/0x9+parseInt(_0x211ecb(0x1f9))/0xa;if(_0x2f704f===_0x5e2bd9)break;else _0x1299f8['push'](_0x1299f8['shift']());}catch(_0x1c389a){_0x1299f8['push'](_0x1299f8['shift']());}}}(a18_0x3a75,0x70919));var __createBinding=this&&this[a18_0x3edfb5(0x20f)]||(Object[a18_0x3edfb5(0x21a)]?function(_0x4d04d9,_0x39c2e5,_0x2f38c3,_0x463c97){const _0x3545a4=a18_0x3edfb5;if(_0x463c97===undefined)_0x463c97=_0x2f38c3;var _0x217ac4=Object[_0x3545a4(0x23c)](_0x39c2e5,_0x2f38c3);(!_0x217ac4||(_0x3545a4(0x251)in _0x217ac4?!_0x39c2e5[_0x3545a4(0x20d)]:_0x217ac4['writable']||_0x217ac4[_0x3545a4(0x22c)]))&&(_0x217ac4={'enumerable':!![],'get':function(){return _0x39c2e5[_0x2f38c3];}}),Object[_0x3545a4(0x22a)](_0x4d04d9,_0x463c97,_0x217ac4);}:function(_0x155792,_0x19451e,_0xa2cc5f,_0x8bc293){if(_0x8bc293===undefined)_0x8bc293=_0xa2cc5f;_0x155792[_0x8bc293]=_0x19451e[_0xa2cc5f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a18_0x3edfb5(0x21a)]?function(_0x3abd71,_0x766cfd){const _0x3d9b87=a18_0x3edfb5;Object[_0x3d9b87(0x22a)](_0x3abd71,_0x3d9b87(0x1ed),{'enumerable':!![],'value':_0x766cfd});}:function(_0x26ef4a,_0x308a3d){const _0x455a9e=a18_0x3edfb5;_0x26ef4a[_0x455a9e(0x1ed)]=_0x308a3d;}),__importStar=this&&this['__importStar']||(function(){var _0x3a3233=function(_0x4347b8){const _0x57236f=a18_0x7b2e;return _0x3a3233=Object[_0x57236f(0x1f4)]||function(_0xdbe64d){const _0x14162c=_0x57236f;var _0x51c17e=[];for(var _0x5d8e36 in _0xdbe64d)if(Object[_0x14162c(0x1f5)][_0x14162c(0x24a)][_0x14162c(0x221)](_0xdbe64d,_0x5d8e36))_0x51c17e[_0x51c17e[_0x14162c(0x1e7)]]=_0x5d8e36;return _0x51c17e;},_0x3a3233(_0x4347b8);};return function(_0x5729a8){const _0x26d5d3=a18_0x7b2e;if(_0x5729a8&&_0x5729a8[_0x26d5d3(0x20d)])return _0x5729a8;var _0x4e206a={};if(_0x5729a8!=null){for(var _0x154111=_0x3a3233(_0x5729a8),_0x184e03=0x0;_0x184e03<_0x154111[_0x26d5d3(0x1e7)];_0x184e03++)if(_0x154111[_0x184e03]!==_0x26d5d3(0x1ed))__createBinding(_0x4e206a,_0x5729a8,_0x154111[_0x184e03]);}return __setModuleDefault(_0x4e206a,_0x5729a8),_0x4e206a;};}()),__importDefault=this&&this[a18_0x3edfb5(0x23f)]||function(_0xac0112){const _0x11e6c1=a18_0x3edfb5;return _0xac0112&&_0xac0112[_0x11e6c1(0x20d)]?_0xac0112:{'default':_0xac0112};};Object[a18_0x3edfb5(0x22a)](exports,a18_0x3edfb5(0x20d),{'value':!![]}),exports[a18_0x3edfb5(0x1fe)]=void 0x0;const testGatewayService_1=require(a18_0x3edfb5(0x21b)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1ddd4d=a18_0x3edfb5;this[_0x1ddd4d(0x22e)]=async(_0x5a2abe,_0x1ba58a,_0x4efc13)=>{const _0x15c460=_0x1ddd4d;try{const {paymentId:_0x2e8272}=_0x5a2abe['params'];console['log'](_0x15c460(0x205)+_0x2e8272);const _0x3c2da7=await database_1[_0x15c460(0x1ed)]['payment']['findUnique']({'where':{'id':_0x2e8272},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3c2da7)return _0x1ba58a['status'](0x194)[_0x15c460(0x1f8)]({'success':![],'message':_0x15c460(0x21c)});if(_0x3c2da7[_0x15c460(0x1e5)]!=='test_gateway')return _0x1ba58a[_0x15c460(0x1e9)](0x190)[_0x15c460(0x1f8)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3c2da7['status']!==_0x15c460(0x1ea))return _0x1ba58a[_0x15c460(0x1e9)](0x190)['json']({'success':![],'message':_0x15c460(0x1e6)+_0x3c2da7[_0x15c460(0x1e9)]+_0x15c460(0x22b)});_0x1ba58a['json']({'success':!![],'result':{'paymentId':_0x3c2da7['id'],'orderId':_0x3c2da7[_0x15c460(0x1fa)],'amount':_0x3c2da7[_0x15c460(0x20a)],'currency':_0x3c2da7['currency'],'merchantName':_0x3c2da7[_0x15c460(0x222)]['name'],'description':'Payment\x20to\x20'+_0x3c2da7['shop'][_0x15c460(0x23a)],'testInstructions':{'successCard':_0x15c460(0x1e2),'failureCard':_0x15c460(0x1dd),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x15c460(0x217),'holderName':'Any\x20name'}}});}catch(_0x174488){_0x4efc13(_0x174488);}},this[_0x1ddd4d(0x21f)]=async(_0x55101c,_0x229bf7,_0x4d0a7c)=>{const _0x8181f4=_0x1ddd4d;try{const {paymentId:_0x4f10ea}=_0x55101c[_0x8181f4(0x20e)],_0x147137=_0x55101c['body'];console[_0x8181f4(0x1e3)](_0x8181f4(0x23e)+_0x4f10ea);const _0x55613e=await database_1[_0x8181f4(0x1ed)]['payment']['findUnique']({'where':{'id':_0x4f10ea},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x55613e)return _0x229bf7[_0x8181f4(0x1e9)](0x194)[_0x8181f4(0x1f8)]({'success':![],'message':_0x8181f4(0x21c)});if(_0x55613e[_0x8181f4(0x1e5)]!==_0x8181f4(0x241))return _0x229bf7[_0x8181f4(0x1e9)](0x190)[_0x8181f4(0x1f8)]({'success':![],'message':_0x8181f4(0x21e)});if(_0x55613e[_0x8181f4(0x1e9)]!==_0x8181f4(0x1ea))return _0x229bf7[_0x8181f4(0x1e9)](0x190)[_0x8181f4(0x1f8)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x55613e['status']+_0x8181f4(0x22b)});const _0x15640c=await this['testGatewayService'][_0x8181f4(0x24e)]({'paymentId':_0x55613e['id'],'orderId':_0x55613e[_0x8181f4(0x1fa)]||_0x55613e['id'],'amount':_0x55613e[_0x8181f4(0x20a)],'currency':_0x55613e[_0x8181f4(0x238)],'cardData':_0x147137});console['log'](_0x8181f4(0x213),_0x15640c);const _0xca3560={'status':_0x15640c['status'],'updatedAt':new Date()};if(_0x15640c[_0x8181f4(0x1e9)]===_0x8181f4(0x218))_0xca3560[_0x8181f4(0x226)]=new Date(),_0xca3560[_0x8181f4(0x225)]=_0x15640c[_0x8181f4(0x1f1)];else _0x15640c[_0x8181f4(0x1e9)]===_0x8181f4(0x1df)&&(_0xca3560[_0x8181f4(0x248)]=_0x15640c[_0x8181f4(0x1f2)]);const _0x4e1fd9=_0x147137[_0x8181f4(0x1e4)][_0x8181f4(0x242)](/[\s-]/g,'');_0xca3560[_0x8181f4(0x227)]=_0x4e1fd9[_0x8181f4(0x1f3)](-0x4),_0xca3560[_0x8181f4(0x1e1)]=_0x8181f4(0x223),await database_1['default'][_0x8181f4(0x233)][_0x8181f4(0x244)]({'where':{'id':_0x55613e['id']},'data':_0xca3560});if(_0x15640c[_0x8181f4(0x1e9)]===_0x8181f4(0x218)&&_0x55613e[_0x8181f4(0x1fc)]){console[_0x8181f4(0x1e3)](_0x8181f4(0x219)+_0x55613e['id']+_0x8181f4(0x24c));try{await database_1[_0x8181f4(0x1ed)]['$transaction'](async _0x32ec26=>{const _0x4f4582=_0x8181f4,_0x2ac32f=await _0x32ec26[_0x4f4582(0x224)][_0x4f4582(0x1f7)]({'where':{'id':_0x55613e[_0x4f4582(0x1fc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2ac32f){console[_0x4f4582(0x1e3)](_0x4f4582(0x202)+_0x2ac32f['id']+':\x20type='+_0x2ac32f[_0x4f4582(0x24b)]+_0x4f4582(0x246)+_0x2ac32f['currentPayments']+_0x4f4582(0x230)+_0x2ac32f[_0x4f4582(0x1e9)]);const _0x57d802=_0x2ac32f[_0x4f4582(0x235)]+0x1,_0xc8f746=_0x2ac32f[_0x4f4582(0x24b)]==='SINGLE'?'COMPLETED':_0x2ac32f[_0x4f4582(0x1e9)];await _0x32ec26[_0x4f4582(0x224)][_0x4f4582(0x244)]({'where':{'id':_0x55613e[_0x4f4582(0x1fc)]},'data':{'currentPayments':_0x57d802,'status':_0xc8f746,'updatedAt':new Date()}}),console['log'](_0x4f4582(0x200)+_0x2ac32f['id']+'\x20updated:\x20currentPayments='+_0x2ac32f['currentPayments']+_0x4f4582(0x215)+_0x57d802+_0x4f4582(0x230)+_0x2ac32f[_0x4f4582(0x1e9)]+'\x20->\x20'+_0xc8f746);}else console[_0x4f4582(0x1e3)]('‚ùå\x20Payment\x20link\x20'+_0x55613e[_0x4f4582(0x1fc)]+_0x4f4582(0x1f0));});}catch(_0x5f0296){console[_0x8181f4(0x22f)](_0x8181f4(0x24f),_0x5f0296);}}await database_1['default'][_0x8181f4(0x209)][_0x8181f4(0x21a)]({'data':{'paymentId':_0x55613e['id'],'shopId':_0x55613e[_0x8181f4(0x229)],'event':_0x8181f4(0x208)+_0x15640c[_0x8181f4(0x1e9)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x8181f4(0x20b)]({'oldStatus':_0x8181f4(0x1ea),'newStatus':_0x15640c['status'],'transactionId':_0x15640c[_0x8181f4(0x1f1)],'failureReason':_0x15640c[_0x8181f4(0x1f2)],'processedAt':new Date()[_0x8181f4(0x236)]()})}}),await this['sendShopWebhook'](_0x55613e,_0x15640c[_0x8181f4(0x1e9)],_0x15640c[_0x8181f4(0x1f1)],_0x15640c[_0x8181f4(0x1f2)]),await this[_0x8181f4(0x1ec)](_0x55613e,_0x15640c[_0x8181f4(0x1e9)]),console[_0x8181f4(0x1e3)](_0x8181f4(0x1fb)+_0x4f10ea+'\x20processed:\x20'+_0x15640c[_0x8181f4(0x1e9)]),_0x15640c['status']===_0x8181f4(0x218)?_0x229bf7[_0x8181f4(0x1f8)]({'success':!![],'message':_0x8181f4(0x216),'result':{'status':'PAID','transactionId':_0x15640c[_0x8181f4(0x1f1)],'redirectUrl':_0x55613e[_0x8181f4(0x1e8)]}}):_0x229bf7[_0x8181f4(0x1e9)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x8181f4(0x1df),'failureReason':_0x15640c['failureReason'],'redirectUrl':_0x55613e[_0x8181f4(0x231)]}});}catch(_0x6c91e0){_0x4d0a7c(_0x6c91e0);}},this[_0x1ddd4d(0x237)]=new testGatewayService_1[(_0x1ddd4d(0x207))](),this[_0x1ddd4d(0x1e0)]=new webhookService_1[(_0x1ddd4d(0x214))]();}async[a18_0x3edfb5(0x1fd)](_0x309896,_0x241370,_0x4e1b45,_0x35f1c5){const _0x53f432=a18_0x3edfb5,_0x2cc34b=Date[_0x53f432(0x203)]();try{const _0x1f34cb=_0x309896[_0x53f432(0x222)],_0x413487=_0x1f34cb[_0x53f432(0x20c)];if(!_0x413487?.['webhookUrl']){console[_0x53f432(0x1e3)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1f34cb['id']);return;}const _0x56e7ab=_0x241370===_0x53f432(0x218)?_0x53f432(0x232):_0x53f432(0x211);let _0x3a8769=[];if(_0x413487['webhookEvents'])try{_0x3a8769=Array['isArray'](_0x413487[_0x53f432(0x245)])?_0x413487[_0x53f432(0x245)]:JSON['parse'](_0x413487[_0x53f432(0x245)]);}catch(_0xe3fe58){console[_0x53f432(0x22f)]('Error\x20parsing\x20webhook\x20events:',_0xe3fe58),_0x3a8769=[];}if(!_0x3a8769['includes'](_0x56e7ab)){console[_0x53f432(0x1e3)](_0x53f432(0x1ff)+_0x56e7ab+_0x53f432(0x201)+_0x1f34cb['id']);return;}const _0x15b55a={'event':_0x56e7ab,'payment':{'id':_0x309896['id'],'order_id':_0x309896[_0x53f432(0x204)],'gateway_order_id':_0x309896[_0x53f432(0x1fa)],'gateway':'0000','amount':_0x309896[_0x53f432(0x20a)],'currency':_0x309896[_0x53f432(0x238)],'status':_0x241370[_0x53f432(0x239)](),'customer_email':_0x309896['customerEmail'],'customer_name':_0x309896[_0x53f432(0x21d)],'transaction_id':_0x4e1b45,'failure_message':_0x35f1c5,'created_at':_0x309896[_0x53f432(0x1eb)],'updated_at':new Date()}},_0x139d40=await fetch(_0x413487[_0x53f432(0x23d)],{'method':'POST','headers':{'Content-Type':_0x53f432(0x210),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x53f432(0x20b)](_0x15b55a)}),_0x31d73b=Date['now']()-_0x2cc34b;console['log'](_0x53f432(0x212)+_0x413487[_0x53f432(0x23d)]+_0x53f432(0x1ee)+_0x139d40[_0x53f432(0x1e9)]+'\x20('+_0x31d73b+_0x53f432(0x249));}catch(_0x425903){console[_0x53f432(0x22f)](_0x53f432(0x234),_0x425903);}}async[a18_0x3edfb5(0x1ec)](_0x50a83e,_0x523765){const _0x3ce4aa=a18_0x3edfb5;try{const {telegramBotService:_0x20e06c}=await Promise['resolve']()[_0x3ce4aa(0x247)](()=>__importStar(require(_0x3ce4aa(0x1de)))),_0x3d78c4={'PAID':_0x3ce4aa(0x24d),'FAILED':'failed'},_0x140e8d=_0x3d78c4[_0x523765];if(!_0x140e8d)return;await _0x20e06c['sendPaymentNotification'](_0x50a83e[_0x3ce4aa(0x229)],_0x50a83e,_0x140e8d);}catch(_0x5215a9){console[_0x3ce4aa(0x22f)](_0x3ce4aa(0x250),_0x5215a9);}}}function a18_0x7b2e(_0x4390fe,_0x2fd51a){_0x4390fe=_0x4390fe-0x1dd;const _0x3a7549=a18_0x3a75();let _0x7b2e7e=_0x3a7549[_0x4390fe];return _0x7b2e7e;}function a18_0x3a75(){const _0x262739=['sendShopWebhook','TestGatewayController','Webhook\x20event\x20','‚úÖ\x20Payment\x20link\x20','\x20not\x20enabled\x20for\x20shop\x20','üìà\x20Found\x20payment\x20link\x20','now','orderId','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','611660HvXDlm','TestGatewayService','test_gateway_','webhookLog','amount','stringify','settings','__esModule','params','__createBinding','application/json','payment.failed','Test\x20Gateway\x20webhook\x20sent\x20to\x20','üß™\x20Test\x20Gateway\x20result:','WebhookService','\x20->\x20','Payment\x20processed\x20successfully','Any\x203-4\x20digits','PAID','üìà\x20Test\x20Gateway:\x20Payment\x20','create','../services/gateways/testGatewayService','Payment\x20not\x20found','customerName','Payment\x20is\x20not\x20for\x20test\x20gateway','processCard','24BrXTZB','call','shop','test_card','paymentLink','gatewayPaymentId','paidAt','cardLast4','1242284Fxgfpy','shopId','defineProperty',',\x20cannot\x20process','configurable','49698SJdzDW','getPaymentForm','error',',\x20status=','failUrl','payment.success','payment','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','currentPayments','toISOString','testGatewayService','currency','toLowerCase','name','1978976EHETdx','getOwnPropertyDescriptor','webhookUrl','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importDefault','1092642Wjcdsf','test_gateway','replace','1514979iwdyYi','update','webhookEvents',',\x20currentPayments=','then','failureMessage','ms)','hasOwnProperty','type','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','paid','processCardPayment','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','get','Any\x20other\x20card\x20number','../services/telegramBotService','FAILED','webhookService','paymentMethod','4242\x204242\x204242\x204242','log','cardNumber','gateway','Payment\x20status\x20is\x20','length','successUrl','status','PENDING','createdAt','sendPaymentStatusNotification','default','\x20with\x20status\x20','1jURPtx','\x20not\x20found','transactionId','failureReason','slice','getOwnPropertyNames','prototype','65VERBra','findUnique','json','11531810mUTbrm','gatewayOrderId','‚úÖ\x20Test\x20Gateway\x20payment\x20','paymentLinkId'];a18_0x3a75=function(){return _0x262739;};return a18_0x3a75();}exports[a18_0x3edfb5(0x1fe)]=TestGatewayController;