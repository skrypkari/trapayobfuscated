'use strict';const a13_0x4d6cf2=a13_0x250f;(function(_0x117756,_0x56e2af){const _0x1b7f19=a13_0x250f,_0xbae75a=_0x117756();while(!![]){try{const _0x443d9e=-parseInt(_0x1b7f19(0x1b1))/0x1+parseInt(_0x1b7f19(0x16c))/0x2+-parseInt(_0x1b7f19(0x150))/0x3*(parseInt(_0x1b7f19(0x17b))/0x4)+parseInt(_0x1b7f19(0x1ae))/0x5+parseInt(_0x1b7f19(0x1a6))/0x6*(-parseInt(_0x1b7f19(0x1ad))/0x7)+parseInt(_0x1b7f19(0x1a4))/0x8*(parseInt(_0x1b7f19(0x191))/0x9)+-parseInt(_0x1b7f19(0x192))/0xa*(-parseInt(_0x1b7f19(0x159))/0xb);if(_0x443d9e===_0x56e2af)break;else _0xbae75a['push'](_0xbae75a['shift']());}catch(_0x301e15){_0xbae75a['push'](_0xbae75a['shift']());}}}(a13_0x2d54,0x6f03d));function a13_0x2d54(){const _0x328ce3=['1169267XTfvmK','âœ…\x20Test\x20Gateway\x20payment\x20','getOwnPropertyDescriptor','processCardPayment','update','failed','json','Any\x20future\x20date\x20(MM/YY)','gatewayOrderId','webhookService','\x20processed:\x20','WebhookService','replace','POST','slice','settings','failUrl','__importDefault','Test\x20Gateway\x20webhook\x20sent\x20to\x20','1288568KPKusi','Payment\x20is\x20not\x20for\x20test\x20gateway','cardNumber','test_gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','orderId','\x20with\x20status\x20','test_card','getPaymentForm','TestGatewayService','webhookUrl','sendPaymentStatusNotification','error','FAILED','Payment\x20not\x20found','419816ZijFMi','prototype','Payment\x20failed','cardLast4','toLowerCase','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','log','../services/telegramBotService','__esModule','sendPaymentNotification','failureReason','shop','Payment\x20status\x20is\x20','create','isArray','resolve','params','failureMessage','createdAt','testGatewayService','Any\x20name','paidAt','35307oiTuFM','10HjQFHW','Webhook\x20event\x20','length','processCard','currency','Error\x20parsing\x20webhook\x20events:','findUnique','application/json','paymentMethod','PENDING',',\x20cannot\x20process','shopId','stringify','successUrl','gateway','../services/gateways/testGatewayService','name','status','1248PjYOhp','then','528UmfodU','customerEmail','amount','../services/webhookService','get','webhookEvents','__createBinding','31696hJEiIF','1570600qSVJBh','defineProperty','transactionId','508646Ldqozd','PAID','default','payment','toISOString','0000','TestGatewayController','test_gateway_','customerName','../config/database','9iSrHZZ','\x20not\x20enabled\x20for\x20shop\x20','__importStar','ms)','body','__setModuleDefault','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','includes'];a13_0x2d54=function(){return _0x328ce3;};return a13_0x2d54();}function a13_0x250f(_0x64420d,_0x4662d5){const _0x2d54da=a13_0x2d54();return a13_0x250f=function(_0x250f75,_0x49ad0f){_0x250f75=_0x250f75-0x147;let _0x52a66a=_0x2d54da[_0x250f75];return _0x52a66a;},a13_0x250f(_0x64420d,_0x4662d5);}var __createBinding=this&&this[a13_0x4d6cf2(0x1ac)]||(Object[a13_0x4d6cf2(0x188)]?function(_0x480b8e,_0x5456bb,_0x55315a,_0x2f8b3b){const _0xbbe590=a13_0x4d6cf2;if(_0x2f8b3b===undefined)_0x2f8b3b=_0x55315a;var _0x48c5c1=Object[_0xbbe590(0x15b)](_0x5456bb,_0x55315a);(!_0x48c5c1||(_0xbbe590(0x1aa)in _0x48c5c1?!_0x5456bb[_0xbbe590(0x183)]:_0x48c5c1['writable']||_0x48c5c1['configurable']))&&(_0x48c5c1={'enumerable':!![],'get':function(){return _0x5456bb[_0x55315a];}}),Object[_0xbbe590(0x1af)](_0x480b8e,_0x2f8b3b,_0x48c5c1);}:function(_0x28bb24,_0x5bfed0,_0x24fec1,_0x1dbe5c){if(_0x1dbe5c===undefined)_0x1dbe5c=_0x24fec1;_0x28bb24[_0x1dbe5c]=_0x5bfed0[_0x24fec1];}),__setModuleDefault=this&&this[a13_0x4d6cf2(0x155)]||(Object[a13_0x4d6cf2(0x188)]?function(_0x406968,_0x313ba8){const _0x1f8a43=a13_0x4d6cf2;Object[_0x1f8a43(0x1af)](_0x406968,_0x1f8a43(0x148),{'enumerable':!![],'value':_0x313ba8});}:function(_0x294bfa,_0x569cde){const _0x4c4df1=a13_0x4d6cf2;_0x294bfa[_0x4c4df1(0x148)]=_0x569cde;}),__importStar=this&&this[a13_0x4d6cf2(0x152)]||(function(){var _0x337395=function(_0x1c180e){return _0x337395=Object['getOwnPropertyNames']||function(_0x35630b){const _0x4db9ab=a13_0x250f;var _0x21365b=[];for(var _0x42be83 in _0x35630b)if(Object[_0x4db9ab(0x17c)]['hasOwnProperty']['call'](_0x35630b,_0x42be83))_0x21365b[_0x21365b['length']]=_0x42be83;return _0x21365b;},_0x337395(_0x1c180e);};return function(_0x1afeb4){const _0x199693=a13_0x250f;if(_0x1afeb4&&_0x1afeb4['__esModule'])return _0x1afeb4;var _0x174454={};if(_0x1afeb4!=null){for(var _0x308af9=_0x337395(_0x1afeb4),_0x5c553e=0x0;_0x5c553e<_0x308af9[_0x199693(0x194)];_0x5c553e++)if(_0x308af9[_0x5c553e]!==_0x199693(0x148))__createBinding(_0x174454,_0x1afeb4,_0x308af9[_0x5c553e]);}return __setModuleDefault(_0x174454,_0x1afeb4),_0x174454;};}()),__importDefault=this&&this[a13_0x4d6cf2(0x16a)]||function(_0x3e1c1b){const _0x40f9d7=a13_0x4d6cf2;return _0x3e1c1b&&_0x3e1c1b[_0x40f9d7(0x183)]?_0x3e1c1b:{'default':_0x3e1c1b};};Object[a13_0x4d6cf2(0x1af)](exports,a13_0x4d6cf2(0x183),{'value':!![]}),exports[a13_0x4d6cf2(0x14c)]=void 0x0;const testGatewayService_1=require(a13_0x4d6cf2(0x1a1)),webhookService_1=require(a13_0x4d6cf2(0x1a9)),database_1=__importDefault(require(a13_0x4d6cf2(0x14f)));class TestGatewayController{constructor(){const _0x5c0907=a13_0x4d6cf2;this[_0x5c0907(0x174)]=async(_0x14123c,_0x30a17e,_0x1fa12f)=>{const _0x181c1d=_0x5c0907;try{const {paymentId:_0x31b297}=_0x14123c[_0x181c1d(0x18b)];console[_0x181c1d(0x181)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x31b297);const _0x308d3b=await database_1[_0x181c1d(0x148)]['payment']['findUnique']({'where':{'id':_0x31b297},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x308d3b)return _0x30a17e[_0x181c1d(0x1a3)](0x194)[_0x181c1d(0x15f)]({'success':![],'message':_0x181c1d(0x17a)});if(_0x308d3b[_0x181c1d(0x1a0)]!==_0x181c1d(0x16f))return _0x30a17e[_0x181c1d(0x1a3)](0x190)[_0x181c1d(0x15f)]({'success':![],'message':_0x181c1d(0x16d)});if(_0x308d3b[_0x181c1d(0x1a3)]!=='PENDING')return _0x30a17e[_0x181c1d(0x1a3)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x308d3b['status']+_0x181c1d(0x19c)});_0x30a17e['json']({'success':!![],'result':{'paymentId':_0x308d3b['id'],'orderId':_0x308d3b[_0x181c1d(0x161)],'amount':_0x308d3b[_0x181c1d(0x1a8)],'currency':_0x308d3b['currency'],'merchantName':_0x308d3b[_0x181c1d(0x186)]['name'],'description':'Payment\x20to\x20'+_0x308d3b['shop'][_0x181c1d(0x1a2)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x181c1d(0x160),'cvc':'Any\x203-4\x20digits','holderName':_0x181c1d(0x18f)}}});}catch(_0x21f6e8){_0x1fa12f(_0x21f6e8);}},this[_0x5c0907(0x195)]=async(_0xcc55a7,_0x126c1d,_0x3de151)=>{const _0x215833=_0x5c0907;try{const {paymentId:_0x4aac80}=_0xcc55a7['params'],_0xeb849a=_0xcc55a7[_0x215833(0x154)];console[_0x215833(0x181)](_0x215833(0x156)+_0x4aac80);const _0x5d03b9=await database_1[_0x215833(0x148)][_0x215833(0x149)][_0x215833(0x198)]({'where':{'id':_0x4aac80},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d03b9)return _0x126c1d[_0x215833(0x1a3)](0x194)[_0x215833(0x15f)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5d03b9['gateway']!==_0x215833(0x16f))return _0x126c1d[_0x215833(0x1a3)](0x190)[_0x215833(0x15f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5d03b9['status']!=='PENDING')return _0x126c1d[_0x215833(0x1a3)](0x190)[_0x215833(0x15f)]({'success':![],'message':_0x215833(0x187)+_0x5d03b9['status']+_0x215833(0x19c)});const _0x480851=await this[_0x215833(0x18e)][_0x215833(0x15c)]({'paymentId':_0x5d03b9['id'],'orderId':_0x5d03b9['gatewayOrderId']||_0x5d03b9['id'],'amount':_0x5d03b9[_0x215833(0x1a8)],'currency':_0x5d03b9[_0x215833(0x196)],'cardData':_0xeb849a});console[_0x215833(0x181)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x480851);const _0xfbf145={'status':_0x480851[_0x215833(0x1a3)],'updatedAt':new Date()};if(_0x480851['status']==='PAID')_0xfbf145[_0x215833(0x190)]=new Date(),_0xfbf145['gatewayPaymentId']=_0x480851[_0x215833(0x1b0)];else _0x480851[_0x215833(0x1a3)]==='FAILED'&&(_0xfbf145[_0x215833(0x18c)]=_0x480851[_0x215833(0x185)]);const _0x16ad25=_0xeb849a[_0x215833(0x16e)][_0x215833(0x165)](/[\s-]/g,'');_0xfbf145[_0x215833(0x17e)]=_0x16ad25[_0x215833(0x167)](-0x4),_0xfbf145[_0x215833(0x19a)]=_0x215833(0x173),await database_1[_0x215833(0x148)][_0x215833(0x149)][_0x215833(0x15d)]({'where':{'id':_0x5d03b9['id']},'data':_0xfbf145}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x5d03b9['id'],'shopId':_0x5d03b9['shopId'],'event':_0x215833(0x14d)+_0x480851['status'][_0x215833(0x17f)](),'statusCode':0xc8,'responseBody':JSON[_0x215833(0x19e)]({'oldStatus':_0x215833(0x19b),'newStatus':_0x480851[_0x215833(0x1a3)],'transactionId':_0x480851[_0x215833(0x1b0)],'failureReason':_0x480851[_0x215833(0x185)],'processedAt':new Date()[_0x215833(0x14a)]()})}}),await this['sendShopWebhook'](_0x5d03b9,_0x480851[_0x215833(0x1a3)],_0x480851[_0x215833(0x1b0)],_0x480851['failureReason']),await this[_0x215833(0x177)](_0x5d03b9,_0x480851['status']),console['log'](_0x215833(0x15a)+_0x4aac80+_0x215833(0x163)+_0x480851[_0x215833(0x1a3)]),_0x480851['status']===_0x215833(0x147)?_0x126c1d[_0x215833(0x15f)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x215833(0x147),'transactionId':_0x480851[_0x215833(0x1b0)],'redirectUrl':_0x5d03b9[_0x215833(0x19f)]}}):_0x126c1d[_0x215833(0x1a3)](0x190)[_0x215833(0x15f)]({'success':![],'message':_0x215833(0x17d),'result':{'status':_0x215833(0x179),'failureReason':_0x480851[_0x215833(0x185)],'redirectUrl':_0x5d03b9[_0x215833(0x169)]}});}catch(_0x12de54){_0x3de151(_0x12de54);}},this['testGatewayService']=new testGatewayService_1[(_0x5c0907(0x175))](),this[_0x5c0907(0x162)]=new webhookService_1[(_0x5c0907(0x164))]();}async['sendShopWebhook'](_0xec5204,_0x1f69ed,_0x218fe9,_0x21691f){const _0x269fd6=a13_0x4d6cf2,_0x1acb3d=Date['now']();try{const _0x33aabf=_0xec5204[_0x269fd6(0x186)],_0xf80d1f=_0x33aabf[_0x269fd6(0x168)];if(!_0xf80d1f?.[_0x269fd6(0x176)]){console[_0x269fd6(0x181)](_0x269fd6(0x170)+_0x33aabf['id']);return;}const _0x4a3ef7=_0x1f69ed==='PAID'?'payment.success':'payment.failed';let _0x56869e=[];if(_0xf80d1f[_0x269fd6(0x1ab)])try{_0x56869e=Array[_0x269fd6(0x189)](_0xf80d1f[_0x269fd6(0x1ab)])?_0xf80d1f[_0x269fd6(0x1ab)]:JSON['parse'](_0xf80d1f[_0x269fd6(0x1ab)]);}catch(_0x10dabc){console[_0x269fd6(0x178)](_0x269fd6(0x197),_0x10dabc),_0x56869e=[];}if(!_0x56869e[_0x269fd6(0x158)](_0x4a3ef7)){console[_0x269fd6(0x181)](_0x269fd6(0x193)+_0x4a3ef7+_0x269fd6(0x151)+_0x33aabf['id']);return;}const _0x30a7d6={'event':_0x4a3ef7,'payment':{'id':_0xec5204['id'],'order_id':_0xec5204[_0x269fd6(0x171)],'gateway_order_id':_0xec5204['gatewayOrderId'],'gateway':_0x269fd6(0x14b),'amount':_0xec5204[_0x269fd6(0x1a8)],'currency':_0xec5204[_0x269fd6(0x196)],'status':_0x1f69ed[_0x269fd6(0x17f)](),'customer_email':_0xec5204[_0x269fd6(0x1a7)],'customer_name':_0xec5204[_0x269fd6(0x14e)],'transaction_id':_0x218fe9,'failure_message':_0x21691f,'created_at':_0xec5204[_0x269fd6(0x18d)],'updated_at':new Date()}},_0x7f9064=await fetch(_0xf80d1f[_0x269fd6(0x176)],{'method':_0x269fd6(0x166),'headers':{'Content-Type':_0x269fd6(0x199),'User-Agent':_0x269fd6(0x180)},'body':JSON[_0x269fd6(0x19e)](_0x30a7d6)}),_0x41b3c3=Date['now']()-_0x1acb3d;console[_0x269fd6(0x181)](_0x269fd6(0x16b)+_0xf80d1f[_0x269fd6(0x176)]+_0x269fd6(0x172)+_0x7f9064[_0x269fd6(0x1a3)]+'\x20('+_0x41b3c3+_0x269fd6(0x153));}catch(_0x116ad4){console[_0x269fd6(0x178)](_0x269fd6(0x157),_0x116ad4);}}async[a13_0x4d6cf2(0x177)](_0x6227bf,_0x5f011c){const _0x2bc6f1=a13_0x4d6cf2;try{const {telegramBotService:_0x4e697e}=await Promise[_0x2bc6f1(0x18a)]()[_0x2bc6f1(0x1a5)](()=>__importStar(require(_0x2bc6f1(0x182)))),_0x478b35={'PAID':'paid','FAILED':_0x2bc6f1(0x15e)},_0x20ecb1=_0x478b35[_0x5f011c];if(!_0x20ecb1)return;await _0x4e697e[_0x2bc6f1(0x184)](_0x6227bf[_0x2bc6f1(0x19d)],_0x6227bf,_0x20ecb1);}catch(_0x11ecb3){console[_0x2bc6f1(0x178)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x11ecb3);}}}exports[a13_0x4d6cf2(0x14c)]=TestGatewayController;