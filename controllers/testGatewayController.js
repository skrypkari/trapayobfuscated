'use strict';const a18_0x28eb0f=a18_0x5270;(function(_0x176e90,_0xfa2a12){const _0x3ecf82=a18_0x5270,_0x308b19=_0x176e90();while(!![]){try{const _0x50957b=-parseInt(_0x3ecf82(0x1db))/0x1*(parseInt(_0x3ecf82(0x243))/0x2)+parseInt(_0x3ecf82(0x1f0))/0x3+-parseInt(_0x3ecf82(0x21d))/0x4*(-parseInt(_0x3ecf82(0x1f5))/0x5)+-parseInt(_0x3ecf82(0x1e1))/0x6*(parseInt(_0x3ecf82(0x209))/0x7)+parseInt(_0x3ecf82(0x246))/0x8*(-parseInt(_0x3ecf82(0x1f2))/0x9)+-parseInt(_0x3ecf82(0x22d))/0xa+-parseInt(_0x3ecf82(0x1e2))/0xb*(-parseInt(_0x3ecf82(0x224))/0xc);if(_0x50957b===_0xfa2a12)break;else _0x308b19['push'](_0x308b19['shift']());}catch(_0x4a87f7){_0x308b19['push'](_0x308b19['shift']());}}}(a18_0x346e,0x96bf9));var __createBinding=this&&this[a18_0x28eb0f(0x233)]||(Object['create']?function(_0x41374e,_0x4d5c12,_0x452da0,_0x5cd95a){const _0xdcf013=a18_0x28eb0f;if(_0x5cd95a===undefined)_0x5cd95a=_0x452da0;var _0x3884b4=Object[_0xdcf013(0x22f)](_0x4d5c12,_0x452da0);(!_0x3884b4||(_0xdcf013(0x22b)in _0x3884b4?!_0x4d5c12[_0xdcf013(0x215)]:_0x3884b4[_0xdcf013(0x210)]||_0x3884b4[_0xdcf013(0x1e3)]))&&(_0x3884b4={'enumerable':!![],'get':function(){return _0x4d5c12[_0x452da0];}}),Object['defineProperty'](_0x41374e,_0x5cd95a,_0x3884b4);}:function(_0x52f1f1,_0x6b072b,_0x31af21,_0xed94f0){if(_0xed94f0===undefined)_0xed94f0=_0x31af21;_0x52f1f1[_0xed94f0]=_0x6b072b[_0x31af21];}),__setModuleDefault=this&&this[a18_0x28eb0f(0x231)]||(Object[a18_0x28eb0f(0x1e7)]?function(_0x2f64ca,_0x5e5cba){const _0x4657a3=a18_0x28eb0f;Object[_0x4657a3(0x206)](_0x2f64ca,_0x4657a3(0x1e9),{'enumerable':!![],'value':_0x5e5cba});}:function(_0x38cbef,_0x4bf20a){const _0x106bd4=a18_0x28eb0f;_0x38cbef[_0x106bd4(0x1e9)]=_0x4bf20a;}),__importStar=this&&this[a18_0x28eb0f(0x238)]||(function(){var _0x511f64=function(_0xfa0098){const _0x9f663d=a18_0x5270;return _0x511f64=Object[_0x9f663d(0x241)]||function(_0x47ad95){const _0x25a1f3=_0x9f663d;var _0x203eb7=[];for(var _0x44dc28 in _0x47ad95)if(Object[_0x25a1f3(0x1ea)]['hasOwnProperty'][_0x25a1f3(0x1f9)](_0x47ad95,_0x44dc28))_0x203eb7[_0x203eb7[_0x25a1f3(0x248)]]=_0x44dc28;return _0x203eb7;},_0x511f64(_0xfa0098);};return function(_0x52171e){const _0x364624=a18_0x5270;if(_0x52171e&&_0x52171e[_0x364624(0x215)])return _0x52171e;var _0x4239c9={};if(_0x52171e!=null){for(var _0x28b56b=_0x511f64(_0x52171e),_0x3c51e1=0x0;_0x3c51e1<_0x28b56b['length'];_0x3c51e1++)if(_0x28b56b[_0x3c51e1]!==_0x364624(0x1e9))__createBinding(_0x4239c9,_0x52171e,_0x28b56b[_0x3c51e1]);}return __setModuleDefault(_0x4239c9,_0x52171e),_0x4239c9;};}()),__importDefault=this&&this['__importDefault']||function(_0x5aed47){const _0x5a903c=a18_0x28eb0f;return _0x5aed47&&_0x5aed47[_0x5a903c(0x215)]?_0x5aed47:{'default':_0x5aed47};};Object[a18_0x28eb0f(0x206)](exports,a18_0x28eb0f(0x215),{'value':!![]}),exports[a18_0x28eb0f(0x22e)]=void 0x0;const testGatewayService_1=require(a18_0x28eb0f(0x202)),webhookService_1=require(a18_0x28eb0f(0x1ce)),database_1=__importDefault(require(a18_0x28eb0f(0x21f)));class TestGatewayController{constructor(){const _0x5243f8=a18_0x28eb0f;this[_0x5243f8(0x1d3)]=async(_0x2261a2,_0x4a7bab,_0xc0fa7)=>{const _0x2b5080=_0x5243f8;try{const {paymentId:_0x4482ff}=_0x2261a2[_0x2b5080(0x1fc)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4482ff);const _0x1421da=await database_1[_0x2b5080(0x1e9)][_0x2b5080(0x1d0)]['findUnique']({'where':{'id':_0x4482ff},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1421da)return _0x4a7bab['status'](0x194)['json']({'success':![],'message':_0x2b5080(0x205)});if(_0x1421da['gateway']!==_0x2b5080(0x1d1))return _0x4a7bab[_0x2b5080(0x1dd)](0x190)['json']({'success':![],'message':_0x2b5080(0x236)});if(_0x1421da[_0x2b5080(0x1dd)]!==_0x2b5080(0x1d9))return _0x4a7bab['status'](0x190)['json']({'success':![],'message':_0x2b5080(0x216)+_0x1421da[_0x2b5080(0x1dd)]+_0x2b5080(0x1f1)});_0x4a7bab['json']({'success':!![],'result':{'paymentId':_0x1421da['id'],'orderId':_0x1421da['gatewayOrderId'],'amount':_0x1421da['amount'],'currency':_0x1421da[_0x2b5080(0x21c)],'merchantName':_0x1421da[_0x2b5080(0x20e)][_0x2b5080(0x1d5)],'description':_0x2b5080(0x227)+_0x1421da[_0x2b5080(0x20e)][_0x2b5080(0x1d5)],'testInstructions':{'successCard':_0x2b5080(0x1cf),'failureCard':_0x2b5080(0x24b),'expiryDate':_0x2b5080(0x1da),'cvc':_0x2b5080(0x20c),'holderName':'Any\x20name'}}});}catch(_0x4143fa){_0xc0fa7(_0x4143fa);}},this['processCard']=async(_0xf75785,_0x4872e2,_0x5130fe)=>{const _0x1e2f2c=_0x5243f8;try{const {paymentId:_0x142892}=_0xf75785[_0x1e2f2c(0x1fc)],_0x462c3e=_0xf75785[_0x1e2f2c(0x1f3)];console[_0x1e2f2c(0x1d2)](_0x1e2f2c(0x245)+_0x142892);const _0x313caa=await database_1[_0x1e2f2c(0x1e9)][_0x1e2f2c(0x1d0)][_0x1e2f2c(0x201)]({'where':{'id':_0x142892},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x313caa)return _0x4872e2[_0x1e2f2c(0x1dd)](0x194)[_0x1e2f2c(0x211)]({'success':![],'message':_0x1e2f2c(0x205)});if(_0x313caa[_0x1e2f2c(0x1dc)]!==_0x1e2f2c(0x1d1))return _0x4872e2[_0x1e2f2c(0x1dd)](0x190)[_0x1e2f2c(0x211)]({'success':![],'message':_0x1e2f2c(0x236)});if(_0x313caa[_0x1e2f2c(0x1dd)]!==_0x1e2f2c(0x1d9))return _0x4872e2[_0x1e2f2c(0x1dd)](0x190)['json']({'success':![],'message':_0x1e2f2c(0x216)+_0x313caa['status']+_0x1e2f2c(0x1f1)});const _0x2e84aa=await this[_0x1e2f2c(0x1f8)][_0x1e2f2c(0x23d)]({'paymentId':_0x313caa['id'],'orderId':_0x313caa[_0x1e2f2c(0x229)]||_0x313caa['id'],'amount':_0x313caa[_0x1e2f2c(0x1f7)],'currency':_0x313caa[_0x1e2f2c(0x21c)],'cardData':_0x462c3e});console[_0x1e2f2c(0x1d2)](_0x1e2f2c(0x1fa),_0x2e84aa);const _0x5b3318={'status':_0x2e84aa['status'],'updatedAt':new Date()};if(_0x2e84aa[_0x1e2f2c(0x1dd)]===_0x1e2f2c(0x237))_0x5b3318[_0x1e2f2c(0x207)]=new Date(),_0x5b3318[_0x1e2f2c(0x223)]=_0x2e84aa[_0x1e2f2c(0x24a)];else _0x2e84aa[_0x1e2f2c(0x1dd)]===_0x1e2f2c(0x1d8)&&(_0x5b3318[_0x1e2f2c(0x247)]=_0x2e84aa['failureReason']);const _0x42924e=_0x462c3e[_0x1e2f2c(0x230)][_0x1e2f2c(0x1ed)](/[\s-]/g,'');_0x5b3318[_0x1e2f2c(0x1e4)]=_0x42924e['slice'](-0x4),_0x5b3318[_0x1e2f2c(0x242)]=_0x1e2f2c(0x1de),await database_1['default'][_0x1e2f2c(0x1d0)][_0x1e2f2c(0x1d7)]({'where':{'id':_0x313caa['id']},'data':_0x5b3318});if(_0x2e84aa[_0x1e2f2c(0x1dd)]===_0x1e2f2c(0x237)&&_0x313caa[_0x1e2f2c(0x212)]){console['log'](_0x1e2f2c(0x21e)+_0x313caa['id']+_0x1e2f2c(0x23e));try{await database_1[_0x1e2f2c(0x1e9)]['$transaction'](async _0x3f617b=>{const _0x496e9d=_0x1e2f2c,_0x1cbee0=await _0x3f617b[_0x496e9d(0x213)][_0x496e9d(0x201)]({'where':{'id':_0x313caa[_0x496e9d(0x212)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1cbee0){console['log'](_0x496e9d(0x23b)+_0x1cbee0['id']+_0x496e9d(0x218)+_0x1cbee0[_0x496e9d(0x20b)]+',\x20currentPayments='+_0x1cbee0[_0x496e9d(0x214)]+_0x496e9d(0x228)+_0x1cbee0[_0x496e9d(0x1dd)]);const _0x459329=_0x1cbee0[_0x496e9d(0x214)]+0x1,_0x1554cd=_0x1cbee0[_0x496e9d(0x20b)]==='SINGLE'?_0x496e9d(0x1ec):_0x1cbee0[_0x496e9d(0x1dd)];await _0x3f617b['paymentLink'][_0x496e9d(0x1d7)]({'where':{'id':_0x313caa[_0x496e9d(0x212)]},'data':{'currentPayments':_0x459329,'status':_0x1554cd,'updatedAt':new Date()}}),console[_0x496e9d(0x1d2)](_0x496e9d(0x225)+_0x1cbee0['id']+_0x496e9d(0x1e8)+_0x1cbee0[_0x496e9d(0x214)]+'\x20->\x20'+_0x459329+_0x496e9d(0x228)+_0x1cbee0[_0x496e9d(0x1dd)]+_0x496e9d(0x232)+_0x1554cd);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x313caa[_0x496e9d(0x212)]+_0x496e9d(0x20a));});}catch(_0x27cc1d){console[_0x1e2f2c(0x1ff)](_0x1e2f2c(0x1e5),_0x27cc1d);}}await database_1[_0x1e2f2c(0x1e9)]['webhookLog'][_0x1e2f2c(0x1e7)]({'data':{'paymentId':_0x313caa['id'],'shopId':_0x313caa[_0x1e2f2c(0x1ee)],'event':_0x1e2f2c(0x23c)+_0x2e84aa[_0x1e2f2c(0x1dd)][_0x1e2f2c(0x244)](),'statusCode':0xc8,'responseBody':JSON[_0x1e2f2c(0x221)]({'oldStatus':'PENDING','newStatus':_0x2e84aa[_0x1e2f2c(0x1dd)],'transactionId':_0x2e84aa[_0x1e2f2c(0x24a)],'failureReason':_0x2e84aa[_0x1e2f2c(0x1e0)],'processedAt':new Date()['toISOString']()})}}),await this[_0x1e2f2c(0x1df)](_0x313caa,_0x2e84aa[_0x1e2f2c(0x1dd)],_0x2e84aa[_0x1e2f2c(0x24a)],_0x2e84aa['failureReason']),await this['sendPaymentStatusNotification'](_0x313caa,_0x2e84aa[_0x1e2f2c(0x1dd)]),console[_0x1e2f2c(0x1d2)](_0x1e2f2c(0x249)+_0x142892+'\x20processed:\x20'+_0x2e84aa['status']),_0x2e84aa['status']===_0x1e2f2c(0x237)?_0x4872e2[_0x1e2f2c(0x211)]({'success':!![],'message':_0x1e2f2c(0x1fb),'result':{'status':_0x1e2f2c(0x237),'transactionId':_0x2e84aa[_0x1e2f2c(0x24a)],'redirectUrl':_0x313caa[_0x1e2f2c(0x1ef)]}}):_0x4872e2[_0x1e2f2c(0x1dd)](0x190)[_0x1e2f2c(0x211)]({'success':![],'message':_0x1e2f2c(0x1f6),'result':{'status':_0x1e2f2c(0x1d8),'failureReason':_0x2e84aa[_0x1e2f2c(0x1e0)],'redirectUrl':_0x313caa[_0x1e2f2c(0x208)]}});}catch(_0x1fbeae){_0x5130fe(_0x1fbeae);}},this['testGatewayService']=new testGatewayService_1[(_0x5243f8(0x1fe))](),this['webhookService']=new webhookService_1[(_0x5243f8(0x1e6))]();}async[a18_0x28eb0f(0x1df)](_0x1e2c9a,_0x226f6f,_0xedbd94,_0x2f9a08){const _0x401e23=a18_0x28eb0f,_0x3597d2=Date[_0x401e23(0x23a)]();try{const _0x5ca5f4=_0x1e2c9a[_0x401e23(0x20e)],_0x58b0c0=_0x5ca5f4['settings'];if(!_0x58b0c0?.[_0x401e23(0x1eb)]){console['log'](_0x401e23(0x1f4)+_0x5ca5f4['id']);return;}const _0x3d0026=_0x226f6f===_0x401e23(0x237)?_0x401e23(0x23f):'payment.failed';let _0x12361a=[];if(_0x58b0c0['webhookEvents'])try{_0x12361a=Array[_0x401e23(0x239)](_0x58b0c0[_0x401e23(0x22a)])?_0x58b0c0[_0x401e23(0x22a)]:JSON['parse'](_0x58b0c0[_0x401e23(0x22a)]);}catch(_0x3b51d1){console[_0x401e23(0x1ff)](_0x401e23(0x20d),_0x3b51d1),_0x12361a=[];}if(!_0x12361a['includes'](_0x3d0026)){console[_0x401e23(0x1d2)]('Webhook\x20event\x20'+_0x3d0026+_0x401e23(0x222)+_0x5ca5f4['id']);return;}const _0x585139={'event':_0x3d0026,'payment':{'id':_0x1e2c9a['id'],'order_id':_0x1e2c9a[_0x401e23(0x24c)],'gateway_order_id':_0x1e2c9a[_0x401e23(0x229)],'gateway':_0x401e23(0x226),'amount':_0x1e2c9a[_0x401e23(0x1f7)],'currency':_0x1e2c9a[_0x401e23(0x21c)],'status':_0x226f6f[_0x401e23(0x244)](),'customer_email':_0x1e2c9a[_0x401e23(0x219)],'customer_name':_0x1e2c9a[_0x401e23(0x1fd)],'transaction_id':_0xedbd94,'failure_message':_0x2f9a08,'created_at':_0x1e2c9a[_0x401e23(0x1d4)],'updated_at':new Date()}},_0x4baff9=await fetch(_0x58b0c0[_0x401e23(0x1eb)],{'method':'POST','headers':{'Content-Type':_0x401e23(0x20f),'User-Agent':_0x401e23(0x204)},'body':JSON[_0x401e23(0x221)](_0x585139)}),_0x38f7fa=Date[_0x401e23(0x23a)]()-_0x3597d2;console['log'](_0x401e23(0x217)+_0x58b0c0['webhookUrl']+_0x401e23(0x235)+_0x4baff9[_0x401e23(0x1dd)]+'\x20('+_0x38f7fa+_0x401e23(0x203));}catch(_0x27efff){console[_0x401e23(0x1ff)](_0x401e23(0x21a),_0x27efff);}}async[a18_0x28eb0f(0x234)](_0x290ee0,_0x19588d){const _0x31b328=a18_0x28eb0f;try{const {telegramBotService:_0x58b9e3}=await Promise[_0x31b328(0x220)]()['then'](()=>__importStar(require(_0x31b328(0x200)))),_0x3f360e={'PAID':_0x31b328(0x240),'FAILED':_0x31b328(0x21b)},_0x474574=_0x3f360e[_0x19588d];if(!_0x474574)return;await _0x58b9e3[_0x31b328(0x1d6)](_0x290ee0[_0x31b328(0x1ee)],_0x290ee0,_0x474574);}catch(_0xbfbefd){console[_0x31b328(0x1ff)](_0x31b328(0x22c),_0xbfbefd);}}}function a18_0x5270(_0x37f0f1,_0x16f579){_0x37f0f1=_0x37f0f1-0x1ce;const _0x346e1d=a18_0x346e();let _0x527035=_0x346e1d[_0x37f0f1];return _0x527035;}function a18_0x346e(){const _0x2a15a6=['\x20->\x20','__createBinding','sendPaymentStatusNotification','\x20with\x20status\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','PAID','__importStar','isArray','now','üìà\x20Found\x20payment\x20link\x20','test_gateway_','processCardPayment','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','payment.success','paid','getOwnPropertyNames','paymentMethod','91302jPPPrR','toLowerCase','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','8AkiuNI','failureMessage','length','‚úÖ\x20Test\x20Gateway\x20payment\x20','transactionId','Any\x20other\x20card\x20number','orderId','../services/webhookService','4242\x204242\x204242\x204242','payment','test_gateway','log','getPaymentForm','createdAt','name','sendPaymentNotification','update','FAILED','PENDING','Any\x20future\x20date\x20(MM/YY)','24larIdY','gateway','status','test_card','sendShopWebhook','failureReason','4090626PdXkol','2728PkGyQE','configurable','cardLast4','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','WebhookService','create','\x20updated:\x20currentPayments=','default','prototype','webhookUrl','COMPLETED','replace','shopId','successUrl','1323006zyJayY',',\x20cannot\x20process','5922531wRKFsc','body','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','949460jsVsLk','Payment\x20failed','amount','testGatewayService','call','üß™\x20Test\x20Gateway\x20result:','Payment\x20processed\x20successfully','params','customerName','TestGatewayService','error','../services/telegramBotService','findUnique','../services/gateways/testGatewayService','ms)','Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20not\x20found','defineProperty','paidAt','failUrl','7zItViK','\x20not\x20found','type','Any\x203-4\x20digits','Error\x20parsing\x20webhook\x20events:','shop','application/json','writable','json','paymentLinkId','paymentLink','currentPayments','__esModule','Payment\x20status\x20is\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20',':\x20type=','customerEmail','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','failed','currency','12lRNDMT','üìà\x20Test\x20Gateway:\x20Payment\x20','../config/database','resolve','stringify','\x20not\x20enabled\x20for\x20shop\x20','gatewayPaymentId','116904KENyTj','‚úÖ\x20Payment\x20link\x20','0000','Payment\x20to\x20',',\x20status=','gatewayOrderId','webhookEvents','get','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','3737750wQpQtg','TestGatewayController','getOwnPropertyDescriptor','cardNumber','__setModuleDefault'];a18_0x346e=function(){return _0x2a15a6;};return a18_0x346e();}exports[a18_0x28eb0f(0x22e)]=TestGatewayController;