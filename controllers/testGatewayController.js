'use strict';const a13_0x9ac0b8=a13_0x1d95;(function(_0x4771e7,_0x4fc90d){const _0x43527a=a13_0x1d95,_0x51b7b1=_0x4771e7();while(!![]){try{const _0x3ba2d5=-parseInt(_0x43527a(0xb9))/0x1*(-parseInt(_0x43527a(0xe6))/0x2)+parseInt(_0x43527a(0xb2))/0x3*(parseInt(_0x43527a(0x118))/0x4)+parseInt(_0x43527a(0xfd))/0x5*(-parseInt(_0x43527a(0xec))/0x6)+parseInt(_0x43527a(0x10b))/0x7+-parseInt(_0x43527a(0xcb))/0x8*(parseInt(_0x43527a(0x128))/0x9)+parseInt(_0x43527a(0xf9))/0xa*(-parseInt(_0x43527a(0x120))/0xb)+-parseInt(_0x43527a(0x123))/0xc*(-parseInt(_0x43527a(0xed))/0xd);if(_0x3ba2d5===_0x4fc90d)break;else _0x51b7b1['push'](_0x51b7b1['shift']());}catch(_0x362e55){_0x51b7b1['push'](_0x51b7b1['shift']());}}}(a13_0x26f3,0xe7b9b));var __createBinding=this&&this['__createBinding']||(Object[a13_0x9ac0b8(0xc5)]?function(_0x49df71,_0x349d3c,_0x5e99ad,_0x4e55a8){const _0x5fad3f=a13_0x9ac0b8;if(_0x4e55a8===undefined)_0x4e55a8=_0x5e99ad;var _0x37a54d=Object[_0x5fad3f(0xc9)](_0x349d3c,_0x5e99ad);(!_0x37a54d||(_0x5fad3f(0xf7)in _0x37a54d?!_0x349d3c[_0x5fad3f(0xf5)]:_0x37a54d[_0x5fad3f(0xfa)]||_0x37a54d[_0x5fad3f(0xbd)]))&&(_0x37a54d={'enumerable':!![],'get':function(){return _0x349d3c[_0x5e99ad];}}),Object[_0x5fad3f(0xb8)](_0x49df71,_0x4e55a8,_0x37a54d);}:function(_0x1dbda6,_0x474389,_0x2c31eb,_0x2d2a32){if(_0x2d2a32===undefined)_0x2d2a32=_0x2c31eb;_0x1dbda6[_0x2d2a32]=_0x474389[_0x2c31eb];}),__setModuleDefault=this&&this[a13_0x9ac0b8(0x105)]||(Object['create']?function(_0x1ca4a5,_0x54b5b7){const _0x1b7bea=a13_0x9ac0b8;Object[_0x1b7bea(0xb8)](_0x1ca4a5,'default',{'enumerable':!![],'value':_0x54b5b7});}:function(_0xfd2edf,_0x56b240){const _0x5284df=a13_0x9ac0b8;_0xfd2edf[_0x5284df(0xc2)]=_0x56b240;}),__importStar=this&&this[a13_0x9ac0b8(0xe1)]||(function(){var _0x4d96cb=function(_0xd91b52){return _0x4d96cb=Object['getOwnPropertyNames']||function(_0x4976ce){const _0x2bb825=a13_0x1d95;var _0xe7d05c=[];for(var _0x109cc9 in _0x4976ce)if(Object[_0x2bb825(0x104)][_0x2bb825(0x11d)]['call'](_0x4976ce,_0x109cc9))_0xe7d05c[_0xe7d05c['length']]=_0x109cc9;return _0xe7d05c;},_0x4d96cb(_0xd91b52);};return function(_0x3bc9d5){const _0x50375a=a13_0x1d95;if(_0x3bc9d5&&_0x3bc9d5[_0x50375a(0xf5)])return _0x3bc9d5;var _0x10bee5={};if(_0x3bc9d5!=null){for(var _0x4d516d=_0x4d96cb(_0x3bc9d5),_0x3ecc99=0x0;_0x3ecc99<_0x4d516d[_0x50375a(0x125)];_0x3ecc99++)if(_0x4d516d[_0x3ecc99]!==_0x50375a(0xc2))__createBinding(_0x10bee5,_0x3bc9d5,_0x4d516d[_0x3ecc99]);}return __setModuleDefault(_0x10bee5,_0x3bc9d5),_0x10bee5;};}()),__importDefault=this&&this[a13_0x9ac0b8(0x11a)]||function(_0x113f8a){const _0x1d0f7d=a13_0x9ac0b8;return _0x113f8a&&_0x113f8a[_0x1d0f7d(0xf5)]?_0x113f8a:{'default':_0x113f8a};};Object[a13_0x9ac0b8(0xb8)](exports,a13_0x9ac0b8(0xf5),{'value':!![]}),exports[a13_0x9ac0b8(0x110)]=void 0x0;const testGatewayService_1=require(a13_0x9ac0b8(0xcd)),webhookService_1=require(a13_0x9ac0b8(0xc7)),database_1=__importDefault(require(a13_0x9ac0b8(0xf4)));function a13_0x1d95(_0x42b7e1,_0x32b96b){const _0x26f3f2=a13_0x26f3();return a13_0x1d95=function(_0x1d95eb,_0x3a4232){_0x1d95eb=_0x1d95eb-0xb1;let _0x558ce0=_0x26f3f2[_0x1d95eb];return _0x558ce0;},a13_0x1d95(_0x42b7e1,_0x32b96b);}class TestGatewayController{constructor(){const _0x270e18=a13_0x9ac0b8;this[_0x270e18(0x103)]=async(_0x1e6460,_0x51d9e6,_0x38ef43)=>{const _0x3e56e7=_0x270e18;try{const {paymentId:_0x4b0b1e}=_0x1e6460[_0x3e56e7(0xbe)];console[_0x3e56e7(0xb7)](_0x3e56e7(0xe5)+_0x4b0b1e);const _0x5a3720=await database_1[_0x3e56e7(0xc2)][_0x3e56e7(0xe0)][_0x3e56e7(0xfb)]({'where':{'id':_0x4b0b1e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5a3720)return _0x51d9e6[_0x3e56e7(0x108)](0x194)['json']({'success':![],'message':_0x3e56e7(0xb3)});if(_0x5a3720['gateway']!=='test_gateway')return _0x51d9e6[_0x3e56e7(0x108)](0x190)[_0x3e56e7(0x116)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5a3720[_0x3e56e7(0x108)]!==_0x3e56e7(0xbf))return _0x51d9e6[_0x3e56e7(0x108)](0x190)[_0x3e56e7(0x116)]({'success':![],'message':_0x3e56e7(0x127)+_0x5a3720['status']+_0x3e56e7(0x121)});_0x51d9e6[_0x3e56e7(0x116)]({'success':!![],'result':{'paymentId':_0x5a3720['id'],'orderId':_0x5a3720['gatewayOrderId'],'amount':_0x5a3720[_0x3e56e7(0xb6)],'currency':_0x5a3720['currency'],'merchantName':_0x5a3720[_0x3e56e7(0xf0)][_0x3e56e7(0xe9)],'description':_0x3e56e7(0xbc)+_0x5a3720[_0x3e56e7(0xf0)]['name'],'testInstructions':{'successCard':_0x3e56e7(0xbb),'failureCard':_0x3e56e7(0xd1),'expiryDate':_0x3e56e7(0xd7),'cvc':_0x3e56e7(0xca),'holderName':_0x3e56e7(0xdd)}}});}catch(_0x1d17f4){_0x38ef43(_0x1d17f4);}},this['processCard']=async(_0x57b278,_0x36d535,_0x5cb7af)=>{const _0x12d425=_0x270e18;try{const {paymentId:_0x560ef8}=_0x57b278[_0x12d425(0xbe)],_0x175cde=_0x57b278[_0x12d425(0xde)];console[_0x12d425(0xb7)](_0x12d425(0xd5)+_0x560ef8);const _0x2b4ca7=await database_1[_0x12d425(0xc2)]['payment'][_0x12d425(0xfb)]({'where':{'id':_0x560ef8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b4ca7)return _0x36d535[_0x12d425(0x108)](0x194)[_0x12d425(0x116)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2b4ca7[_0x12d425(0xb1)]!=='test_gateway')return _0x36d535['status'](0x190)[_0x12d425(0x116)]({'success':![],'message':_0x12d425(0x11e)});if(_0x2b4ca7['status']!==_0x12d425(0xbf))return _0x36d535[_0x12d425(0x108)](0x190)[_0x12d425(0x116)]({'success':![],'message':_0x12d425(0x127)+_0x2b4ca7[_0x12d425(0x108)]+_0x12d425(0x121)});const _0x35fd5e=await this[_0x12d425(0xba)][_0x12d425(0xd8)]({'paymentId':_0x2b4ca7['id'],'orderId':_0x2b4ca7['gatewayOrderId']||_0x2b4ca7['id'],'amount':_0x2b4ca7[_0x12d425(0xb6)],'currency':_0x2b4ca7[_0x12d425(0x11c)],'cardData':_0x175cde});console[_0x12d425(0xb7)]('üß™\x20Test\x20Gateway\x20result:',_0x35fd5e);const _0x14eac9={'status':_0x35fd5e[_0x12d425(0x108)],'updatedAt':new Date()};if(_0x35fd5e[_0x12d425(0x108)]==='PAID')_0x14eac9['paidAt']=new Date(),_0x14eac9['gatewayPaymentId']=_0x35fd5e[_0x12d425(0xc1)];else _0x35fd5e[_0x12d425(0x108)]==='FAILED'&&(_0x14eac9[_0x12d425(0xd0)]=_0x35fd5e[_0x12d425(0x117)]);const _0x7c86ae=_0x175cde[_0x12d425(0x11b)][_0x12d425(0x112)](/[\s-]/g,'');_0x14eac9['cardLast4']=_0x7c86ae[_0x12d425(0x102)](-0x4),_0x14eac9[_0x12d425(0xc4)]=_0x12d425(0xfc),await database_1[_0x12d425(0xc2)][_0x12d425(0xe0)]['update']({'where':{'id':_0x2b4ca7['id']},'data':_0x14eac9});if(_0x35fd5e[_0x12d425(0x108)]===_0x12d425(0xdc)&&_0x2b4ca7[_0x12d425(0xdf)]){console[_0x12d425(0xb7)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x2b4ca7['id']+_0x12d425(0xc3));try{await database_1[_0x12d425(0xc2)]['$transaction'](async _0x362d90=>{const _0x132926=_0x12d425,_0x4b7ede=await _0x362d90['paymentLink'][_0x132926(0xfb)]({'where':{'id':_0x2b4ca7['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4b7ede){console['log'](_0x132926(0xef)+_0x4b7ede['id']+_0x132926(0xd4)+_0x4b7ede['type']+_0x132926(0xd3)+_0x4b7ede[_0x132926(0xb5)]+_0x132926(0xe3)+_0x4b7ede[_0x132926(0x108)]);const _0xe667a6=_0x4b7ede[_0x132926(0xb5)]+0x1,_0x52e4b2=_0x4b7ede[_0x132926(0xe2)]==='SINGLE'?_0x132926(0x126):_0x4b7ede[_0x132926(0x108)];await _0x362d90[_0x132926(0xda)][_0x132926(0xd6)]({'where':{'id':_0x2b4ca7[_0x132926(0xdf)]},'data':{'currentPayments':_0xe667a6,'status':_0x52e4b2,'updatedAt':new Date()}}),console[_0x132926(0xb7)]('‚úÖ\x20Payment\x20link\x20'+_0x4b7ede['id']+_0x132926(0x119)+_0x4b7ede[_0x132926(0xb5)]+_0x132926(0xee)+_0xe667a6+',\x20status='+_0x4b7ede['status']+_0x132926(0xee)+_0x52e4b2);}else console[_0x132926(0xb7)]('‚ùå\x20Payment\x20link\x20'+_0x2b4ca7['paymentLinkId']+'\x20not\x20found');});}catch(_0x464b83){console[_0x12d425(0x124)](_0x12d425(0x113),_0x464b83);}}await database_1['default']['webhookLog'][_0x12d425(0xc5)]({'data':{'paymentId':_0x2b4ca7['id'],'shopId':_0x2b4ca7[_0x12d425(0xf3)],'event':'test_gateway_'+_0x35fd5e[_0x12d425(0x108)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x12d425(0xbf),'newStatus':_0x35fd5e['status'],'transactionId':_0x35fd5e['transactionId'],'failureReason':_0x35fd5e[_0x12d425(0x117)],'processedAt':new Date()[_0x12d425(0x109)]()})}}),await this['sendShopWebhook'](_0x2b4ca7,_0x35fd5e[_0x12d425(0x108)],_0x35fd5e[_0x12d425(0xc1)],_0x35fd5e[_0x12d425(0x117)]),await this[_0x12d425(0x10f)](_0x2b4ca7,_0x35fd5e[_0x12d425(0x108)]),console[_0x12d425(0xb7)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x560ef8+'\x20processed:\x20'+_0x35fd5e[_0x12d425(0x108)]),_0x35fd5e[_0x12d425(0x108)]==='PAID'?_0x36d535[_0x12d425(0x116)]({'success':!![],'message':_0x12d425(0xdb),'result':{'status':_0x12d425(0xdc),'transactionId':_0x35fd5e[_0x12d425(0xc1)],'redirectUrl':_0x2b4ca7[_0x12d425(0x106)]}}):_0x36d535['status'](0x190)[_0x12d425(0x116)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x12d425(0x11f),'failureReason':_0x35fd5e[_0x12d425(0x117)],'redirectUrl':_0x2b4ca7[_0x12d425(0x114)]}});}catch(_0x1decb3){_0x5cb7af(_0x1decb3);}},this[_0x270e18(0xba)]=new testGatewayService_1[(_0x270e18(0xc8))](),this['webhookService']=new webhookService_1[(_0x270e18(0x100))]();}async[a13_0x9ac0b8(0x115)](_0x36531c,_0x3d26f4,_0xe138a6,_0x2c4579){const _0x1b5e65=a13_0x9ac0b8,_0x2b8f8a=Date[_0x1b5e65(0xff)]();try{const _0x4708ff=_0x36531c[_0x1b5e65(0xf0)],_0x26d2d5=_0x4708ff[_0x1b5e65(0xe8)];if(!_0x26d2d5?.[_0x1b5e65(0xf6)]){console[_0x1b5e65(0xb7)](_0x1b5e65(0xea)+_0x4708ff['id']);return;}const _0x1e5f92=_0x3d26f4==='PAID'?_0x1b5e65(0x122):_0x1b5e65(0xcc);let _0x292e62=[];if(_0x26d2d5[_0x1b5e65(0xcf)])try{_0x292e62=Array['isArray'](_0x26d2d5[_0x1b5e65(0xcf)])?_0x26d2d5['webhookEvents']:JSON['parse'](_0x26d2d5['webhookEvents']);}catch(_0x4c7e57){console[_0x1b5e65(0x124)](_0x1b5e65(0xf2),_0x4c7e57),_0x292e62=[];}if(!_0x292e62[_0x1b5e65(0xd2)](_0x1e5f92)){console[_0x1b5e65(0xb7)](_0x1b5e65(0x10e)+_0x1e5f92+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4708ff['id']);return;}const _0x387460={'event':_0x1e5f92,'payment':{'id':_0x36531c['id'],'order_id':_0x36531c[_0x1b5e65(0x10a)],'gateway_order_id':_0x36531c[_0x1b5e65(0x10c)],'gateway':_0x1b5e65(0xd9),'amount':_0x36531c[_0x1b5e65(0xb6)],'currency':_0x36531c[_0x1b5e65(0x11c)],'status':_0x3d26f4[_0x1b5e65(0xeb)](),'customer_email':_0x36531c[_0x1b5e65(0xce)],'customer_name':_0x36531c['customerName'],'transaction_id':_0xe138a6,'failure_message':_0x2c4579,'created_at':_0x36531c['createdAt'],'updated_at':new Date()}},_0xa6bcdd=await fetch(_0x26d2d5[_0x1b5e65(0xf6)],{'method':_0x1b5e65(0xe4),'headers':{'Content-Type':'application/json','User-Agent':_0x1b5e65(0xf1)},'body':JSON['stringify'](_0x387460)}),_0x4d50d6=Date['now']()-_0x2b8f8a;console[_0x1b5e65(0xb7)](_0x1b5e65(0xb4)+_0x26d2d5[_0x1b5e65(0xf6)]+_0x1b5e65(0x111)+_0xa6bcdd[_0x1b5e65(0x108)]+'\x20('+_0x4d50d6+_0x1b5e65(0xe7));}catch(_0x541761){console[_0x1b5e65(0x124)](_0x1b5e65(0xc6),_0x541761);}}async[a13_0x9ac0b8(0x10f)](_0xdfc4be,_0x1be74a){const _0x5e75d7=a13_0x9ac0b8;try{const {telegramBotService:_0x156cd}=await Promise[_0x5e75d7(0x107)]()[_0x5e75d7(0xf8)](()=>__importStar(require('../services/telegramBotService'))),_0x2a783b={'PAID':_0x5e75d7(0x10d),'FAILED':_0x5e75d7(0xfe)},_0x42d1c5=_0x2a783b[_0x1be74a];if(!_0x42d1c5)return;await _0x156cd[_0x5e75d7(0xc0)](_0xdfc4be['shopId'],_0xdfc4be,_0x42d1c5);}catch(_0x92a7c6){console[_0x5e75d7(0x124)](_0x5e75d7(0x101),_0x92a7c6);}}}function a13_0x26f3(){const _0x1aee07=['testGatewayService','4242\x204242\x204242\x204242','Payment\x20to\x20','configurable','params','PENDING','sendPaymentNotification','transactionId','default','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','paymentMethod','create','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../services/webhookService','TestGatewayService','getOwnPropertyDescriptor','Any\x203-4\x20digits','24BqBSJU','payment.failed','../services/gateways/testGatewayService','customerEmail','webhookEvents','failureMessage','Any\x20other\x20card\x20number','includes',',\x20currentPayments=',':\x20type=','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','update','Any\x20future\x20date\x20(MM/YY)','processCardPayment','0000','paymentLink','Payment\x20processed\x20successfully','PAID','Any\x20name','body','paymentLinkId','payment','__importStar','type',',\x20status=','POST','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','783876syqomd','ms)','settings','name','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','39426DHALPL','35297249tQmzBw','\x20->\x20','üìà\x20Found\x20payment\x20link\x20','shop','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Error\x20parsing\x20webhook\x20events:','shopId','../config/database','__esModule','webhookUrl','get','then','180890bynNbE','writable','findUnique','test_card','535zaaiME','failed','now','WebhookService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','slice','getPaymentForm','prototype','__setModuleDefault','successUrl','resolve','status','toISOString','orderId','7868693mLLhyk','gatewayOrderId','paid','Webhook\x20event\x20','sendPaymentStatusNotification','TestGatewayController','\x20with\x20status\x20','replace','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','failUrl','sendShopWebhook','json','failureReason','67916quIpcw','\x20updated:\x20currentPayments=','__importDefault','cardNumber','currency','hasOwnProperty','Payment\x20is\x20not\x20for\x20test\x20gateway','FAILED','1034pVdfyG',',\x20cannot\x20process','payment.success','12CzRuSf','error','length','COMPLETED','Payment\x20status\x20is\x20','3913488AKZTZq','gateway','6DSVWjO','Payment\x20not\x20found','Test\x20Gateway\x20webhook\x20sent\x20to\x20','currentPayments','amount','log','defineProperty','2uwpoSt'];a13_0x26f3=function(){return _0x1aee07;};return a13_0x26f3();}exports[a13_0x9ac0b8(0x110)]=TestGatewayController;