'use strict';const a20_0x56fd88=a20_0x1432;(function(_0x5911ed,_0x83eb15){const _0x49fbf3=a20_0x1432,_0x4a809a=_0x5911ed();while(!![]){try{const _0x4cd78e=-parseInt(_0x49fbf3(0x16c))/0x1*(parseInt(_0x49fbf3(0x19c))/0x2)+-parseInt(_0x49fbf3(0x190))/0x3*(parseInt(_0x49fbf3(0x1b1))/0x4)+parseInt(_0x49fbf3(0x1ae))/0x5*(-parseInt(_0x49fbf3(0x18b))/0x6)+-parseInt(_0x49fbf3(0x153))/0x7*(-parseInt(_0x49fbf3(0x184))/0x8)+-parseInt(_0x49fbf3(0x12d))/0x9+-parseInt(_0x49fbf3(0x13f))/0xa+-parseInt(_0x49fbf3(0x130))/0xb*(-parseInt(_0x49fbf3(0x19b))/0xc);if(_0x4cd78e===_0x83eb15)break;else _0x4a809a['push'](_0x4a809a['shift']());}catch(_0x1f83e7){_0x4a809a['push'](_0x4a809a['shift']());}}}(a20_0x27ed,0x28e70));function a20_0x1432(_0x44ed03,_0x508630){_0x44ed03=_0x44ed03-0x129;const _0x27ed33=a20_0x27ed();let _0x14326d=_0x27ed33[_0x44ed03];return _0x14326d;}var __createBinding=this&&this[a20_0x56fd88(0x154)]||(Object[a20_0x56fd88(0x161)]?function(_0x5f5da8,_0x2c60ef,_0x2415b9,_0x1ef572){const _0x5f38d3=a20_0x56fd88;if(_0x1ef572===undefined)_0x1ef572=_0x2415b9;var _0x2d0130=Object[_0x5f38d3(0x185)](_0x2c60ef,_0x2415b9);(!_0x2d0130||(_0x5f38d3(0x1a9)in _0x2d0130?!_0x2c60ef['__esModule']:_0x2d0130['writable']||_0x2d0130[_0x5f38d3(0x174)]))&&(_0x2d0130={'enumerable':!![],'get':function(){return _0x2c60ef[_0x2415b9];}}),Object['defineProperty'](_0x5f5da8,_0x1ef572,_0x2d0130);}:function(_0x4a00ef,_0x2a908f,_0x46544d,_0x7ed98){if(_0x7ed98===undefined)_0x7ed98=_0x46544d;_0x4a00ef[_0x7ed98]=_0x2a908f[_0x46544d];}),__setModuleDefault=this&&this[a20_0x56fd88(0x132)]||(Object[a20_0x56fd88(0x161)]?function(_0xecabc0,_0x544c27){const _0x5e0b2c=a20_0x56fd88;Object[_0x5e0b2c(0x1b0)](_0xecabc0,_0x5e0b2c(0x156),{'enumerable':!![],'value':_0x544c27});}:function(_0x301c8c,_0x9cf858){const _0xd3fcd6=a20_0x56fd88;_0x301c8c[_0xd3fcd6(0x156)]=_0x9cf858;}),__importStar=this&&this[a20_0x56fd88(0x177)]||(function(){var _0x170430=function(_0x5b94c8){const _0x2434ff=a20_0x1432;return _0x170430=Object[_0x2434ff(0x14e)]||function(_0x5ed358){const _0x29dbe9=_0x2434ff;var _0xabe0e3=[];for(var _0x2d8a1d in _0x5ed358)if(Object[_0x29dbe9(0x17a)][_0x29dbe9(0x151)][_0x29dbe9(0x1af)](_0x5ed358,_0x2d8a1d))_0xabe0e3[_0xabe0e3[_0x29dbe9(0x1a5)]]=_0x2d8a1d;return _0xabe0e3;},_0x170430(_0x5b94c8);};return function(_0x447127){const _0x20bba7=a20_0x1432;if(_0x447127&&_0x447127[_0x20bba7(0x19a)])return _0x447127;var _0x501196={};if(_0x447127!=null){for(var _0x3169d3=_0x170430(_0x447127),_0x595a54=0x0;_0x595a54<_0x3169d3[_0x20bba7(0x1a5)];_0x595a54++)if(_0x3169d3[_0x595a54]!==_0x20bba7(0x156))__createBinding(_0x501196,_0x447127,_0x3169d3[_0x595a54]);}return __setModuleDefault(_0x501196,_0x447127),_0x501196;};}()),__importDefault=this&&this[a20_0x56fd88(0x18a)]||function(_0x1d9026){const _0x4acd38=a20_0x56fd88;return _0x1d9026&&_0x1d9026[_0x4acd38(0x19a)]?_0x1d9026:{'default':_0x1d9026};};Object[a20_0x56fd88(0x1b0)](exports,a20_0x56fd88(0x19a),{'value':!![]}),exports[a20_0x56fd88(0x1ac)]=void 0x0;function a20_0x27ed(){const _0x1c9d20=['Payment\x20not\x20found','Payment\x20to\x20','testGatewayService','âŒ\x20Payment\x20link\x20','SINGLE','log','shopId','status','__esModule','1679844nhrsdf','374278IsnUau','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',':\x20type=','\x20with\x20status\x20','COMPLETED','includes','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','gateway','$transaction','length','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','test_card','failureReason','get','../config/database','hex','TestGatewayController','../services/gateways/testGatewayService','40rdnLpn','call','defineProperty','8256VIgyZQ','sendShopWebhook','âš ï¸\x20Webhook\x20event\x20','\x20not\x20found','name','Any\x203-4\x20digits','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','params','345627OHlWsh','paymentMethod','createdAt','77oFribC','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','__setModuleDefault','parse','test_gateway','paymentLink','webhookUrl','sendPaymentStatusNotification',',\x20cannot\x20process','WebhookService','...','shop','âœ…\x20Test\x20Gateway\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','PENDING','1239710YjBnuO','failed','type','ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event=','then','json','successUrl','ðŸ§ª\x20Test\x20Gateway\x20result:','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20',',\x20currentPayments=',',\x20webhookUrl=','gatewayOrderId','paymentLinkId','\x20not\x20enabled\x20for\x20shop\x20','webhookService','getOwnPropertyNames','currency','settings','hasOwnProperty','secretKey','455602LqTOEy','__createBinding','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','default','toLowerCase','toISOString','4242\x204242\x204242\x204242','Error\x20parsing\x20webhook\x20events:','transactionId','application/json','createHmac','replace','../services/webhookService','amount','create','test_gateway_','sha256','failureMessage','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20processed:\x20','payment','findUnique','webhookLog','\x20->\x20','update','1CiSAvB','Payment\x20System/1.0\x20(Test\x20Gateway)','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','stringify','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','isArray','cardLast4','not\x20configured','configurable','error','sendPaymentNotification','__importStar','ðŸ§ª\x20Sending\x20webhook\x20to\x20','crypto','prototype','processCard','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','TestGatewayService','now','0000','Payment\x20processed\x20successfully','Any\x20future\x20date\x20(MM/YY)',',\x20status=','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','16qYoqcY','getOwnPropertyDescriptor','resolve','PAID','webhookEvents','âœ…\x20Payment\x20link\x20','__importDefault','245082FBeKFN','processCardPayment','\x20updated:\x20currentPayments=','currentPayments','FAILED','387DFXiCu','configured'];a20_0x27ed=function(){return _0x1c9d20;};return a20_0x27ed();}const crypto_1=__importDefault(require(a20_0x56fd88(0x179))),testGatewayService_1=require(a20_0x56fd88(0x1ad)),webhookService_1=require(a20_0x56fd88(0x15f)),database_1=__importDefault(require(a20_0x56fd88(0x1aa)));class TestGatewayController{constructor(){const _0x10f437=a20_0x56fd88;this['getPaymentForm']=async(_0x1b3f80,_0x5cab91,_0x31afc2)=>{const _0x227837=a20_0x1432;try{const {paymentId:_0x3c0ba0}=_0x1b3f80[_0x227837(0x12c)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3c0ba0);const _0x59f7f1=await database_1[_0x227837(0x156)][_0x227837(0x167)][_0x227837(0x168)]({'where':{'id':_0x3c0ba0},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x59f7f1)return _0x5cab91[_0x227837(0x199)](0x194)['json']({'success':![],'message':_0x227837(0x192)});if(_0x59f7f1['gateway']!=='test_gateway')return _0x5cab91[_0x227837(0x199)](0x190)['json']({'success':![],'message':_0x227837(0x13d)});if(_0x59f7f1['status']!==_0x227837(0x13e))return _0x5cab91[_0x227837(0x199)](0x190)[_0x227837(0x144)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x59f7f1[_0x227837(0x199)]+_0x227837(0x138)});_0x5cab91['json']({'success':!![],'result':{'paymentId':_0x59f7f1['id'],'orderId':_0x59f7f1[_0x227837(0x14a)],'amount':_0x59f7f1[_0x227837(0x160)],'currency':_0x59f7f1['currency'],'merchantName':_0x59f7f1[_0x227837(0x13b)]['name'],'description':_0x227837(0x193)+_0x59f7f1[_0x227837(0x13b)][_0x227837(0x129)],'testInstructions':{'successCard':_0x227837(0x159),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x227837(0x181),'cvc':_0x227837(0x12a),'holderName':'Any\x20name'}}});}catch(_0x2d6643){_0x31afc2(_0x2d6643);}},this[_0x10f437(0x17b)]=async(_0x5a3b1f,_0x32d05e,_0x1f8114)=>{const _0x3326d6=_0x10f437;try{const {paymentId:_0x103471}=_0x5a3b1f[_0x3326d6(0x12c)],_0x3ffbcd=_0x5a3b1f['body'];console[_0x3326d6(0x197)](_0x3326d6(0x12b)+_0x103471);const _0x139c35=await database_1[_0x3326d6(0x156)][_0x3326d6(0x167)][_0x3326d6(0x168)]({'where':{'id':_0x103471},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x139c35)return _0x32d05e[_0x3326d6(0x199)](0x194)['json']({'success':![],'message':_0x3326d6(0x192)});if(_0x139c35[_0x3326d6(0x1a3)]!==_0x3326d6(0x134))return _0x32d05e[_0x3326d6(0x199)](0x190)[_0x3326d6(0x144)]({'success':![],'message':_0x3326d6(0x13d)});if(_0x139c35[_0x3326d6(0x199)]!=='PENDING')return _0x32d05e['status'](0x190)[_0x3326d6(0x144)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x139c35[_0x3326d6(0x199)]+_0x3326d6(0x138)});const _0x5d7f74=await this[_0x3326d6(0x194)][_0x3326d6(0x18c)]({'paymentId':_0x139c35['id'],'orderId':_0x139c35[_0x3326d6(0x14a)]||_0x139c35['id'],'amount':_0x139c35[_0x3326d6(0x160)],'currency':_0x139c35[_0x3326d6(0x14f)],'cardData':_0x3ffbcd});console[_0x3326d6(0x197)](_0x3326d6(0x146),_0x5d7f74);const _0x3353fc={'status':_0x5d7f74[_0x3326d6(0x199)],'updatedAt':new Date()};if(_0x5d7f74['status']==='PAID')_0x3353fc['paidAt']=new Date(),_0x3353fc['gatewayPaymentId']=_0x5d7f74['transactionId'];else _0x5d7f74[_0x3326d6(0x199)]===_0x3326d6(0x18f)&&(_0x3353fc[_0x3326d6(0x164)]=_0x5d7f74[_0x3326d6(0x1a8)]);const _0x53eacd=_0x3ffbcd['cardNumber'][_0x3326d6(0x15e)](/[\s-]/g,'');_0x3353fc[_0x3326d6(0x172)]=_0x53eacd['slice'](-0x4),_0x3353fc[_0x3326d6(0x12e)]=_0x3326d6(0x1a7),await database_1[_0x3326d6(0x156)]['payment'][_0x3326d6(0x16b)]({'where':{'id':_0x139c35['id']},'data':_0x3353fc});if(_0x5d7f74[_0x3326d6(0x199)]===_0x3326d6(0x187)&&_0x139c35['paymentLinkId']){console[_0x3326d6(0x197)](_0x3326d6(0x183)+_0x139c35['id']+_0x3326d6(0x16e));try{await database_1['default'][_0x3326d6(0x1a4)](async _0x5a78ce=>{const _0xe34040=_0x3326d6,_0x5af63b=await _0x5a78ce[_0xe34040(0x135)][_0xe34040(0x168)]({'where':{'id':_0x139c35[_0xe34040(0x14b)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5af63b){console[_0xe34040(0x197)]('ðŸ“ˆ\x20Found\x20payment\x20link\x20'+_0x5af63b['id']+_0xe34040(0x19e)+_0x5af63b[_0xe34040(0x141)]+_0xe34040(0x148)+_0x5af63b[_0xe34040(0x18e)]+',\x20status='+_0x5af63b[_0xe34040(0x199)]);const _0x2922e3=_0x5af63b['currentPayments']+0x1,_0x13ba05=_0x5af63b[_0xe34040(0x141)]===_0xe34040(0x196)?_0xe34040(0x1a0):_0x5af63b['status'];await _0x5a78ce['paymentLink'][_0xe34040(0x16b)]({'where':{'id':_0x139c35[_0xe34040(0x14b)]},'data':{'currentPayments':_0x2922e3,'status':_0x13ba05,'updatedAt':new Date()}}),console[_0xe34040(0x197)](_0xe34040(0x189)+_0x5af63b['id']+_0xe34040(0x18d)+_0x5af63b[_0xe34040(0x18e)]+_0xe34040(0x16a)+_0x2922e3+_0xe34040(0x182)+_0x5af63b['status']+_0xe34040(0x16a)+_0x13ba05);}else console['log'](_0xe34040(0x195)+_0x139c35[_0xe34040(0x14b)]+_0xe34040(0x1b4));});}catch(_0x5461be){console[_0x3326d6(0x175)](_0x3326d6(0x170),_0x5461be);}}await database_1[_0x3326d6(0x156)][_0x3326d6(0x169)]['create']({'data':{'paymentId':_0x139c35['id'],'shopId':_0x139c35[_0x3326d6(0x198)],'event':_0x3326d6(0x162)+_0x5d7f74['status'][_0x3326d6(0x157)](),'statusCode':_0x5d7f74[_0x3326d6(0x199)]===_0x3326d6(0x187)?0xc8:0x190,'responseBody':JSON[_0x3326d6(0x16f)]({'oldStatus':_0x3326d6(0x13e),'newStatus':_0x5d7f74[_0x3326d6(0x199)],'transactionId':_0x5d7f74[_0x3326d6(0x15b)],'failureReason':_0x5d7f74[_0x3326d6(0x1a8)],'processedAt':new Date()[_0x3326d6(0x158)]()})}}),console['log'](_0x3326d6(0x147)+_0x5d7f74[_0x3326d6(0x199)]+_0x3326d6(0x13a)),await this[_0x3326d6(0x1b2)](_0x139c35,_0x5d7f74[_0x3326d6(0x199)],_0x5d7f74[_0x3326d6(0x15b)],_0x5d7f74[_0x3326d6(0x1a8)]),console[_0x3326d6(0x197)](_0x3326d6(0x131)+_0x5d7f74[_0x3326d6(0x199)]),console['log'](_0x3326d6(0x1a6)+_0x5d7f74[_0x3326d6(0x199)]+_0x3326d6(0x13a)),await this[_0x3326d6(0x137)](_0x139c35,_0x5d7f74[_0x3326d6(0x199)]),console[_0x3326d6(0x197)](_0x3326d6(0x1a2)+_0x5d7f74[_0x3326d6(0x199)]),console[_0x3326d6(0x197)](_0x3326d6(0x13c)+_0x103471+_0x3326d6(0x166)+_0x5d7f74['status']),_0x5d7f74[_0x3326d6(0x199)]==='PAID'?_0x32d05e[_0x3326d6(0x144)]({'success':!![],'message':_0x3326d6(0x180),'result':{'status':'PAID','transactionId':_0x5d7f74['transactionId'],'redirectUrl':_0x139c35[_0x3326d6(0x145)]}}):_0x32d05e['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x3326d6(0x18f),'failureReason':_0x5d7f74[_0x3326d6(0x1a8)],'redirectUrl':_0x139c35['failUrl']}});}catch(_0x17a4eb){_0x1f8114(_0x17a4eb);}},this[_0x10f437(0x194)]=new testGatewayService_1[(_0x10f437(0x17d))](),this[_0x10f437(0x14d)]=new webhookService_1[(_0x10f437(0x139))]();}async[a20_0x56fd88(0x1b2)](_0x513555,_0x21fba8,_0x277844,_0x56e495){const _0x44c7aa=a20_0x56fd88,_0xa056c6=Date['now']();try{const _0xf6421e=_0x513555[_0x44c7aa(0x13b)],_0x4421ea=_0xf6421e[_0x44c7aa(0x150)];if(!_0x4421ea?.[_0x44c7aa(0x136)]){console[_0x44c7aa(0x197)](_0x44c7aa(0x165)+_0xf6421e['id']);return;}const _0x1bfdee=_0x21fba8===_0x44c7aa(0x187)?'payment.success':'payment.failed';console['log'](_0x44c7aa(0x142)+_0x1bfdee+_0x44c7aa(0x149)+(_0x4421ea[_0x44c7aa(0x136)]?_0x44c7aa(0x191):_0x44c7aa(0x173)));let _0x5f5609=[];if(_0x4421ea[_0x44c7aa(0x188)])try{_0x5f5609=Array[_0x44c7aa(0x171)](_0x4421ea[_0x44c7aa(0x188)])?_0x4421ea[_0x44c7aa(0x188)]:JSON[_0x44c7aa(0x133)](_0x4421ea[_0x44c7aa(0x188)]);}catch(_0x1d1976){console[_0x44c7aa(0x175)](_0x44c7aa(0x15a),_0x1d1976),_0x5f5609=[];}console['log'](_0x44c7aa(0x17c),_0x5f5609);if(!_0x5f5609[_0x44c7aa(0x1a1)](_0x1bfdee)){console[_0x44c7aa(0x197)](_0x44c7aa(0x1b3)+_0x1bfdee+_0x44c7aa(0x14c)+_0xf6421e['id']);return;}const _0xc972b9={'event':_0x1bfdee,'payment':{'id':_0x513555['id'],'order_id':_0x513555['orderId'],'gateway_order_id':_0x513555['gatewayOrderId'],'gateway':_0x44c7aa(0x17f),'amount':_0x513555[_0x44c7aa(0x160)],'currency':_0x513555[_0x44c7aa(0x14f)],'status':_0x21fba8[_0x44c7aa(0x157)](),'customer_email':_0x513555['customerEmail'],'customer_name':_0x513555['customerName'],'transaction_id':_0x277844,'failure_message':_0x56e495,'created_at':_0x513555[_0x44c7aa(0x12f)],'updated_at':new Date()}};console[_0x44c7aa(0x197)](_0x44c7aa(0x178)+_0x4421ea[_0x44c7aa(0x136)]+_0x44c7aa(0x13a)),console['log']('ðŸ§ª\x20Webhook\x20payload:',JSON[_0x44c7aa(0x16f)](_0xc972b9,null,0x2));const _0x55ad4b=JSON[_0x44c7aa(0x16f)](_0xc972b9),_0x199471=crypto_1['default'][_0x44c7aa(0x15d)](_0x44c7aa(0x163),_0xf6421e[_0x44c7aa(0x152)])['update'](_0x55ad4b)['digest'](_0x44c7aa(0x1ab)),_0x37e525=await fetch(_0x4421ea[_0x44c7aa(0x136)],{'method':'POST','headers':{'Content-Type':_0x44c7aa(0x15c),'User-Agent':_0x44c7aa(0x16d),'X-Webhook-Signature':_0x199471},'body':_0x55ad4b}),_0x54a644=Date[_0x44c7aa(0x17e)]()-_0xa056c6;console['log'](_0x44c7aa(0x155)+_0x4421ea['webhookUrl']+_0x44c7aa(0x19f)+_0x37e525[_0x44c7aa(0x199)]+'\x20('+_0x54a644+'ms)');}catch(_0x79afc3){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x79afc3);}}async[a20_0x56fd88(0x137)](_0x2b3ef0,_0x3be67e){const _0x5269b4=a20_0x56fd88;try{const {telegramBotService:_0x3464be}=await Promise[_0x5269b4(0x186)]()[_0x5269b4(0x143)](()=>__importStar(require('../services/telegramBotService'))),_0x17305d={'PAID':'paid','FAILED':_0x5269b4(0x140)},_0x3598cd=_0x17305d[_0x3be67e];if(!_0x3598cd)return;await _0x3464be[_0x5269b4(0x176)](_0x2b3ef0['shopId'],_0x2b3ef0,_0x3598cd);}catch(_0xba5cdf){console[_0x5269b4(0x175)](_0x5269b4(0x19d),_0xba5cdf);}}}exports['TestGatewayController']=TestGatewayController;