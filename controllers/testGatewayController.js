'use strict';const a13_0x5b509e=a13_0x5c6a;(function(_0xb1dd75,_0x5d4b24){const _0x4e566b=a13_0x5c6a,_0xbb0efd=_0xb1dd75();while(!![]){try{const _0x1ce77e=-parseInt(_0x4e566b(0xe6))/0x1*(-parseInt(_0x4e566b(0x135))/0x2)+-parseInt(_0x4e566b(0x11a))/0x3*(-parseInt(_0x4e566b(0x13a))/0x4)+-parseInt(_0x4e566b(0x122))/0x5*(-parseInt(_0x4e566b(0x11d))/0x6)+-parseInt(_0x4e566b(0x118))/0x7+parseInt(_0x4e566b(0x129))/0x8+parseInt(_0x4e566b(0x132))/0x9*(parseInt(_0x4e566b(0x133))/0xa)+-parseInt(_0x4e566b(0x12c))/0xb;if(_0x1ce77e===_0x5d4b24)break;else _0xbb0efd['push'](_0xbb0efd['shift']());}catch(_0x4c353f){_0xbb0efd['push'](_0xbb0efd['shift']());}}}(a13_0x2d8b,0x2b7f3));var __createBinding=this&&this[a13_0x5b509e(0xf0)]||(Object[a13_0x5b509e(0x10c)]?function(_0x1a18e4,_0x3aa43c,_0x12cde0,_0x44178c){const _0x2c642e=a13_0x5b509e;if(_0x44178c===undefined)_0x44178c=_0x12cde0;var _0x5a62fe=Object['getOwnPropertyDescriptor'](_0x3aa43c,_0x12cde0);(!_0x5a62fe||(_0x2c642e(0x117)in _0x5a62fe?!_0x3aa43c[_0x2c642e(0xfe)]:_0x5a62fe[_0x2c642e(0xe7)]||_0x5a62fe['configurable']))&&(_0x5a62fe={'enumerable':!![],'get':function(){return _0x3aa43c[_0x12cde0];}}),Object['defineProperty'](_0x1a18e4,_0x44178c,_0x5a62fe);}:function(_0x15da59,_0x1525b0,_0x4016da,_0x39098e){if(_0x39098e===undefined)_0x39098e=_0x4016da;_0x15da59[_0x39098e]=_0x1525b0[_0x4016da];}),__setModuleDefault=this&&this[a13_0x5b509e(0x10b)]||(Object[a13_0x5b509e(0x10c)]?function(_0x1779a1,_0x5e2356){const _0x47dce3=a13_0x5b509e;Object[_0x47dce3(0x125)](_0x1779a1,_0x47dce3(0x12e),{'enumerable':!![],'value':_0x5e2356});}:function(_0x3bb4e1,_0x2d5a95){const _0x1b42ee=a13_0x5b509e;_0x3bb4e1[_0x1b42ee(0x12e)]=_0x2d5a95;}),__importStar=this&&this[a13_0x5b509e(0x119)]||(function(){var _0x3e8c8b=function(_0x121fc8){const _0x2e0934=a13_0x5c6a;return _0x3e8c8b=Object[_0x2e0934(0x123)]||function(_0x4c31e4){const _0x53456b=_0x2e0934;var _0x43b2ec=[];for(var _0xc8b1c1 in _0x4c31e4)if(Object[_0x53456b(0x10d)][_0x53456b(0x127)][_0x53456b(0x111)](_0x4c31e4,_0xc8b1c1))_0x43b2ec[_0x43b2ec[_0x53456b(0xf8)]]=_0xc8b1c1;return _0x43b2ec;},_0x3e8c8b(_0x121fc8);};return function(_0xf3bd68){const _0x2cebaf=a13_0x5c6a;if(_0xf3bd68&&_0xf3bd68['__esModule'])return _0xf3bd68;var _0x311857={};if(_0xf3bd68!=null){for(var _0x49e21a=_0x3e8c8b(_0xf3bd68),_0x429716=0x0;_0x429716<_0x49e21a['length'];_0x429716++)if(_0x49e21a[_0x429716]!==_0x2cebaf(0x12e))__createBinding(_0x311857,_0xf3bd68,_0x49e21a[_0x429716]);}return __setModuleDefault(_0x311857,_0xf3bd68),_0x311857;};}()),__importDefault=this&&this[a13_0x5b509e(0x106)]||function(_0x48b952){const _0x54109e=a13_0x5b509e;return _0x48b952&&_0x48b952[_0x54109e(0xfe)]?_0x48b952:{'default':_0x48b952};};function a13_0x2d8b(){const _0x489b20=['hasOwnProperty','WebhookService','2346624VAVaQU','gatewayOrderId','failureMessage','8010057zFmxSx','Payment\x20not\x20found','default','cardNumber','gatewayPaymentId','sendShopWebhook','34974ncYmty','390zOKfVh','Any\x203-4\x20digits','476458ujCcZA','amount','Any\x20other\x20card\x20number','createdAt','PENDING','1132IFfDWi','getPaymentForm','\x20with\x20status\x20','4242\x204242\x204242\x204242','ðŸ§ª\x20Test\x20Gateway\x20result:','shopId','error','sendPaymentNotification','paid','Payment\x20status\x20is\x20','Any\x20future\x20date\x20(MM/YY)','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Error\x20parsing\x20webhook\x20events:','findUnique','PAID','TestGatewayController','test_gateway','payment.success','toISOString','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','transactionId','customerName','1BwyhIr','writable','body','webhookEvents','FAILED','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','webhookService','log','settings','Payment\x20to\x20','__createBinding','âœ…\x20Test\x20Gateway\x20payment\x20','processCard','processCardPayment','webhookUrl','replace','../config/database','params','length','sendPaymentStatusNotification','name','isArray','\x20not\x20enabled\x20for\x20shop\x20','status','__esModule','Payment\x20failed','ms)','payment','testGatewayService','orderId','../services/gateways/testGatewayService','toLowerCase','__importDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookLog','includes','__setModuleDefault','create','prototype','failUrl','0000','update','call','shop','TestGatewayService',',\x20cannot\x20process','gateway','currency','get','667359MrHEZq','__importStar','375HNhRFG','test_gateway_','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1699206LafUiH','failureReason','test_card','../services/webhookService','successUrl','5zZMUtA','getOwnPropertyNames','now','defineProperty','json'];a13_0x2d8b=function(){return _0x489b20;};return a13_0x2d8b();}function a13_0x5c6a(_0x31cfd0,_0x150e29){const _0x2d8bd1=a13_0x2d8b();return a13_0x5c6a=function(_0x5c6aa3,_0x3c1ec2){_0x5c6aa3=_0x5c6aa3-0xd9;let _0x4f046d=_0x2d8bd1[_0x5c6aa3];return _0x4f046d;},a13_0x5c6a(_0x31cfd0,_0x150e29);}Object[a13_0x5b509e(0x125)](exports,a13_0x5b509e(0xfe),{'value':!![]}),exports[a13_0x5b509e(0xdf)]=void 0x0;const testGatewayService_1=require(a13_0x5b509e(0x104)),webhookService_1=require(a13_0x5b509e(0x120)),database_1=__importDefault(require(a13_0x5b509e(0xf6)));class TestGatewayController{constructor(){const _0x24c42f=a13_0x5b509e;this[_0x24c42f(0x13b)]=async(_0x31cd5e,_0x3753cc,_0x480817)=>{const _0x43688d=_0x24c42f;try{const {paymentId:_0x33a7b2}=_0x31cd5e[_0x43688d(0xf7)];console['log'](_0x43688d(0xe3)+_0x33a7b2);const _0x17896d=await database_1[_0x43688d(0x12e)]['payment'][_0x43688d(0xdd)]({'where':{'id':_0x33a7b2},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x17896d)return _0x3753cc[_0x43688d(0xfd)](0x194)[_0x43688d(0x126)]({'success':![],'message':_0x43688d(0x12d)});if(_0x17896d[_0x43688d(0x115)]!==_0x43688d(0xe0))return _0x3753cc[_0x43688d(0xfd)](0x190)[_0x43688d(0x126)]({'success':![],'message':_0x43688d(0x107)});if(_0x17896d[_0x43688d(0xfd)]!==_0x43688d(0x139))return _0x3753cc['status'](0x190)[_0x43688d(0x126)]({'success':![],'message':_0x43688d(0xd9)+_0x17896d[_0x43688d(0xfd)]+_0x43688d(0x114)});_0x3753cc[_0x43688d(0x126)]({'success':!![],'result':{'paymentId':_0x17896d['id'],'orderId':_0x17896d[_0x43688d(0x12a)],'amount':_0x17896d[_0x43688d(0x136)],'currency':_0x17896d[_0x43688d(0x116)],'merchantName':_0x17896d[_0x43688d(0x112)][_0x43688d(0xfa)],'description':_0x43688d(0xef)+_0x17896d[_0x43688d(0x112)]['name'],'testInstructions':{'successCard':_0x43688d(0x13d),'failureCard':_0x43688d(0x137),'expiryDate':_0x43688d(0xda),'cvc':_0x43688d(0x134),'holderName':'Any\x20name'}}});}catch(_0x3c0128){_0x480817(_0x3c0128);}},this[_0x24c42f(0xf2)]=async(_0xbcf650,_0x3bc058,_0x44e3fe)=>{const _0x3ca8f0=_0x24c42f;try{const {paymentId:_0xf69da5}=_0xbcf650['params'],_0x3ff3ae=_0xbcf650[_0x3ca8f0(0xe8)];console[_0x3ca8f0(0xed)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0xf69da5);const _0xd99023=await database_1['default']['payment']['findUnique']({'where':{'id':_0xf69da5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xd99023)return _0x3bc058['status'](0x194)[_0x3ca8f0(0x126)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xd99023['gateway']!=='test_gateway')return _0x3bc058['status'](0x190)[_0x3ca8f0(0x126)]({'success':![],'message':_0x3ca8f0(0x107)});if(_0xd99023[_0x3ca8f0(0xfd)]!=='PENDING')return _0x3bc058[_0x3ca8f0(0xfd)](0x190)[_0x3ca8f0(0x126)]({'success':![],'message':_0x3ca8f0(0xd9)+_0xd99023['status']+_0x3ca8f0(0x114)});const _0x406e46=await this[_0x3ca8f0(0x102)][_0x3ca8f0(0xf3)]({'paymentId':_0xd99023['id'],'orderId':_0xd99023['gatewayOrderId']||_0xd99023['id'],'amount':_0xd99023[_0x3ca8f0(0x136)],'currency':_0xd99023[_0x3ca8f0(0x116)],'cardData':_0x3ff3ae});console['log'](_0x3ca8f0(0x13e),_0x406e46);const _0x2b0880={'status':_0x406e46[_0x3ca8f0(0xfd)],'updatedAt':new Date()};if(_0x406e46[_0x3ca8f0(0xfd)]===_0x3ca8f0(0xde))_0x2b0880['paidAt']=new Date(),_0x2b0880[_0x3ca8f0(0x130)]=_0x406e46[_0x3ca8f0(0xe4)];else _0x406e46[_0x3ca8f0(0xfd)]==='FAILED'&&(_0x2b0880[_0x3ca8f0(0x12b)]=_0x406e46['failureReason']);const _0x4f2a85=_0x3ff3ae[_0x3ca8f0(0x12f)][_0x3ca8f0(0xf5)](/[\s-]/g,'');_0x2b0880['cardLast4']=_0x4f2a85['slice'](-0x4),_0x2b0880['paymentMethod']=_0x3ca8f0(0x11f),await database_1[_0x3ca8f0(0x12e)][_0x3ca8f0(0x101)][_0x3ca8f0(0x110)]({'where':{'id':_0xd99023['id']},'data':_0x2b0880}),await database_1[_0x3ca8f0(0x12e)][_0x3ca8f0(0x109)][_0x3ca8f0(0x10c)]({'data':{'paymentId':_0xd99023['id'],'shopId':_0xd99023[_0x3ca8f0(0x13f)],'event':_0x3ca8f0(0x11b)+_0x406e46[_0x3ca8f0(0xfd)][_0x3ca8f0(0x105)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3ca8f0(0x139),'newStatus':_0x406e46['status'],'transactionId':_0x406e46[_0x3ca8f0(0xe4)],'failureReason':_0x406e46[_0x3ca8f0(0x11e)],'processedAt':new Date()[_0x3ca8f0(0xe2)]()})}}),await this[_0x3ca8f0(0x131)](_0xd99023,_0x406e46[_0x3ca8f0(0xfd)],_0x406e46['transactionId'],_0x406e46['failureReason']),await this[_0x3ca8f0(0xf9)](_0xd99023,_0x406e46[_0x3ca8f0(0xfd)]),console[_0x3ca8f0(0xed)](_0x3ca8f0(0xf1)+_0xf69da5+'\x20processed:\x20'+_0x406e46[_0x3ca8f0(0xfd)]),_0x406e46['status']===_0x3ca8f0(0xde)?_0x3bc058[_0x3ca8f0(0x126)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x406e46[_0x3ca8f0(0xe4)],'redirectUrl':_0xd99023[_0x3ca8f0(0x121)]}}):_0x3bc058['status'](0x190)[_0x3ca8f0(0x126)]({'success':![],'message':_0x3ca8f0(0xff),'result':{'status':_0x3ca8f0(0xea),'failureReason':_0x406e46[_0x3ca8f0(0x11e)],'redirectUrl':_0xd99023[_0x3ca8f0(0x10e)]}});}catch(_0x3d5e96){_0x44e3fe(_0x3d5e96);}},this[_0x24c42f(0x102)]=new testGatewayService_1[(_0x24c42f(0x113))](),this[_0x24c42f(0xec)]=new webhookService_1[(_0x24c42f(0x128))]();}async[a13_0x5b509e(0x131)](_0x36ca19,_0x21aae8,_0x10c27a,_0x181326){const _0x376dbf=a13_0x5b509e,_0x3716fa=Date['now']();try{const _0x3802a8=_0x36ca19['shop'],_0x5eed63=_0x3802a8[_0x376dbf(0xee)];if(!_0x5eed63?.['webhookUrl']){console['log'](_0x376dbf(0x108)+_0x3802a8['id']);return;}const _0xa9dc2f=_0x21aae8===_0x376dbf(0xde)?_0x376dbf(0xe1):'payment.failed';let _0x65e197=[];if(_0x5eed63[_0x376dbf(0xe9)])try{_0x65e197=Array[_0x376dbf(0xfb)](_0x5eed63[_0x376dbf(0xe9)])?_0x5eed63['webhookEvents']:JSON['parse'](_0x5eed63[_0x376dbf(0xe9)]);}catch(_0x1c57ff){console[_0x376dbf(0x140)](_0x376dbf(0xdc),_0x1c57ff),_0x65e197=[];}if(!_0x65e197[_0x376dbf(0x10a)](_0xa9dc2f)){console[_0x376dbf(0xed)]('Webhook\x20event\x20'+_0xa9dc2f+_0x376dbf(0xfc)+_0x3802a8['id']);return;}const _0x5c261c={'event':_0xa9dc2f,'payment':{'id':_0x36ca19['id'],'order_id':_0x36ca19[_0x376dbf(0x103)],'gateway_order_id':_0x36ca19['gatewayOrderId'],'gateway':_0x376dbf(0x10f),'amount':_0x36ca19[_0x376dbf(0x136)],'currency':_0x36ca19['currency'],'status':_0x21aae8[_0x376dbf(0x105)](),'customer_email':_0x36ca19['customerEmail'],'customer_name':_0x36ca19[_0x376dbf(0xe5)],'transaction_id':_0x10c27a,'failure_message':_0x181326,'created_at':_0x36ca19[_0x376dbf(0x138)],'updated_at':new Date()}},_0x4cbb2f=await fetch(_0x5eed63[_0x376dbf(0xf4)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x376dbf(0xeb)},'body':JSON['stringify'](_0x5c261c)}),_0x119eed=Date[_0x376dbf(0x124)]()-_0x3716fa;console[_0x376dbf(0xed)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x5eed63['webhookUrl']+_0x376dbf(0x13c)+_0x4cbb2f['status']+'\x20('+_0x119eed+_0x376dbf(0x100));}catch(_0xc468ca){console[_0x376dbf(0x140)](_0x376dbf(0xdb),_0xc468ca);}}async[a13_0x5b509e(0xf9)](_0x5bb188,_0x506d34){const _0x506226=a13_0x5b509e;try{const {telegramBotService:_0x3a7e10}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x3acad6={'PAID':_0x506226(0x142),'FAILED':'failed'},_0x18fcc7=_0x3acad6[_0x506d34];if(!_0x18fcc7)return;await _0x3a7e10[_0x506226(0x141)](_0x5bb188[_0x506226(0x13f)],_0x5bb188,_0x18fcc7);}catch(_0x144dc8){console[_0x506226(0x140)](_0x506226(0x11c),_0x144dc8);}}}exports[a13_0x5b509e(0xdf)]=TestGatewayController;