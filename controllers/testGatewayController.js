'use strict';const a13_0x577e86=a13_0x4b29;function a13_0x4b29(_0x4ed68f,_0x3ac428){const _0x5508bf=a13_0x5508();return a13_0x4b29=function(_0x4b2933,_0xe5c488){_0x4b2933=_0x4b2933-0x65;let _0x349889=_0x5508bf[_0x4b2933];return _0x349889;},a13_0x4b29(_0x4ed68f,_0x3ac428);}(function(_0x54bb26,_0x4de11b){const _0xe7c8f2=a13_0x4b29,_0x461858=_0x54bb26();while(!![]){try{const _0x9904ec=parseInt(_0xe7c8f2(0x98))/0x1+-parseInt(_0xe7c8f2(0xc8))/0x2*(parseInt(_0xe7c8f2(0x6e))/0x3)+-parseInt(_0xe7c8f2(0x90))/0x4+parseInt(_0xe7c8f2(0x6d))/0x5*(parseInt(_0xe7c8f2(0x8d))/0x6)+-parseInt(_0xe7c8f2(0xa6))/0x7+parseInt(_0xe7c8f2(0xc3))/0x8+parseInt(_0xe7c8f2(0x71))/0x9;if(_0x9904ec===_0x4de11b)break;else _0x461858['push'](_0x461858['shift']());}catch(_0x2deef7){_0x461858['push'](_0x461858['shift']());}}}(a13_0x5508,0x3e75a));var __createBinding=this&&this[a13_0x577e86(0x85)]||(Object['create']?function(_0x3f7879,_0x129fcb,_0x32b33d,_0x12bce7){const _0x3637e5=a13_0x577e86;if(_0x12bce7===undefined)_0x12bce7=_0x32b33d;var _0x4c354b=Object['getOwnPropertyDescriptor'](_0x129fcb,_0x32b33d);(!_0x4c354b||(_0x3637e5(0x9d)in _0x4c354b?!_0x129fcb[_0x3637e5(0x69)]:_0x4c354b['writable']||_0x4c354b['configurable']))&&(_0x4c354b={'enumerable':!![],'get':function(){return _0x129fcb[_0x32b33d];}}),Object[_0x3637e5(0x72)](_0x3f7879,_0x12bce7,_0x4c354b);}:function(_0x244c17,_0x545d18,_0xe069ea,_0x88c62e){if(_0x88c62e===undefined)_0x88c62e=_0xe069ea;_0x244c17[_0x88c62e]=_0x545d18[_0xe069ea];}),__setModuleDefault=this&&this[a13_0x577e86(0x84)]||(Object['create']?function(_0x14dad3,_0x3fb095){const _0x5a9726=a13_0x577e86;Object[_0x5a9726(0x72)](_0x14dad3,_0x5a9726(0xa0),{'enumerable':!![],'value':_0x3fb095});}:function(_0x2eafa9,_0x44a226){const _0x20c1b8=a13_0x577e86;_0x2eafa9[_0x20c1b8(0xa0)]=_0x44a226;}),__importStar=this&&this[a13_0x577e86(0xcc)]||(function(){var _0x15d436=function(_0x39910b){return _0x15d436=Object['getOwnPropertyNames']||function(_0x433430){const _0x380dc9=a13_0x4b29;var _0x29f177=[];for(var _0x151e28 in _0x433430)if(Object[_0x380dc9(0xbd)]['hasOwnProperty'][_0x380dc9(0x81)](_0x433430,_0x151e28))_0x29f177[_0x29f177[_0x380dc9(0x8f)]]=_0x151e28;return _0x29f177;},_0x15d436(_0x39910b);};return function(_0x40b259){const _0x5f39b2=a13_0x4b29;if(_0x40b259&&_0x40b259[_0x5f39b2(0x69)])return _0x40b259;var _0x3d41c4={};if(_0x40b259!=null){for(var _0x47f414=_0x15d436(_0x40b259),_0x443d0b=0x0;_0x443d0b<_0x47f414[_0x5f39b2(0x8f)];_0x443d0b++)if(_0x47f414[_0x443d0b]!=='default')__createBinding(_0x3d41c4,_0x40b259,_0x47f414[_0x443d0b]);}return __setModuleDefault(_0x3d41c4,_0x40b259),_0x3d41c4;};}()),__importDefault=this&&this['__importDefault']||function(_0x19a16c){const _0xfad3ec=a13_0x577e86;return _0x19a16c&&_0x19a16c[_0xfad3ec(0x69)]?_0x19a16c:{'default':_0x19a16c};};Object[a13_0x577e86(0x72)](exports,'__esModule',{'value':!![]}),exports[a13_0x577e86(0xd2)]=void 0x0;function a13_0x5508(){const _0x4b32ff=['findUnique','4134636xtbOeY','defineProperty','error','shopId','paymentLink','name','\x20with\x20status\x20','body','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','📈\x20Found\x20payment\x20link\x20','Any\x20future\x20date\x20(MM/YY)','gateway','amount','Payment\x20failed','json','application/json','call','webhookUrl','✅\x20Payment\x20link\x20','__setModuleDefault','__createBinding',',\x20status=','TestGatewayService','PAID','\x20->\x20','\x20updated:\x20currentPayments=','../config/database','Payment\x20to\x20','216114NoQVeE','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','length','1978532vxniPD','POST','settings','update','0000','resolve','log','includes','205394awgfWG','sendPaymentStatusNotification','4242\x204242\x204242\x204242','webhookService',',\x20cannot\x20process','get','payment.failed','❌\x20Payment\x20link\x20','default','PENDING','payment','cardNumber','cardLast4','shop','292243oesWxd','type','sendShopWebhook','WebhookService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','create','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Error\x20parsing\x20webhook\x20events:','toLowerCase','now','processCard','paymentLinkId','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','COMPLETED','status','sendPaymentNotification','isArray','$transaction','paymentMethod','gatewayOrderId','webhookEvents','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20not\x20found','prototype','Any\x203-4\x20digits','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20processed\x20successfully','createdAt','slice','2790784zcnfVm','SINGLE','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','stringify','params','2EtLoBL','test_gateway','Any\x20other\x20card\x20number','replace','__importStar','ms)','\x20not\x20found','Webhook\x20event\x20','payment.success','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','TestGatewayController','failureReason','Payment\x20is\x20not\x20for\x20test\x20gateway','paid','currentPayments','customerEmail','\x20not\x20enabled\x20for\x20shop\x20','gatewayPaymentId','currency','testGatewayService','toISOString','../services/telegramBotService','Payment\x20status\x20is\x20','../services/gateways/testGatewayService','../services/webhookService','processCardPayment','transactionId','✅\x20Test\x20Gateway\x20payment\x20','customerName','test_card','__esModule',':\x20type=','orderId','test_gateway_','15HnIiVf','988461BNtyUs','successUrl'];a13_0x5508=function(){return _0x4b32ff;};return a13_0x5508();}const testGatewayService_1=require(a13_0x577e86(0xdf)),webhookService_1=require(a13_0x577e86(0xe0)),database_1=__importDefault(require(a13_0x577e86(0x8b)));class TestGatewayController{constructor(){const _0x406ffc=a13_0x577e86;this['getPaymentForm']=async(_0x16165f,_0x308762,_0xcc7937)=>{const _0x2ce847=a13_0x4b29;try{const {paymentId:_0x4ffd88}=_0x16165f[_0x2ce847(0xc7)];console[_0x2ce847(0x96)](_0x2ce847(0xb2)+_0x4ffd88);const _0x8de5ca=await database_1[_0x2ce847(0xa0)][_0x2ce847(0xa2)][_0x2ce847(0x70)]({'where':{'id':_0x4ffd88},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x8de5ca)return _0x308762[_0x2ce847(0xb4)](0x194)['json']({'success':![],'message':_0x2ce847(0xbc)});if(_0x8de5ca[_0x2ce847(0x7c)]!==_0x2ce847(0xc9))return _0x308762[_0x2ce847(0xb4)](0x190)[_0x2ce847(0x7f)]({'success':![],'message':_0x2ce847(0xd4)});if(_0x8de5ca[_0x2ce847(0xb4)]!==_0x2ce847(0xa1))return _0x308762['status'](0x190)[_0x2ce847(0x7f)]({'success':![],'message':_0x2ce847(0xde)+_0x8de5ca['status']+_0x2ce847(0x9c)});_0x308762['json']({'success':!![],'result':{'paymentId':_0x8de5ca['id'],'orderId':_0x8de5ca['gatewayOrderId'],'amount':_0x8de5ca[_0x2ce847(0x7d)],'currency':_0x8de5ca['currency'],'merchantName':_0x8de5ca['shop'][_0x2ce847(0x76)],'description':_0x2ce847(0x8c)+_0x8de5ca[_0x2ce847(0xa5)]['name'],'testInstructions':{'successCard':_0x2ce847(0x9a),'failureCard':_0x2ce847(0xca),'expiryDate':_0x2ce847(0x7b),'cvc':_0x2ce847(0xbe),'holderName':'Any\x20name'}}});}catch(_0x5d4cc1){_0xcc7937(_0x5d4cc1);}},this[_0x406ffc(0xb0)]=async(_0x27cfb1,_0x52b18f,_0x409f74)=>{const _0x947fe3=_0x406ffc;try{const {paymentId:_0x3492a8}=_0x27cfb1[_0x947fe3(0xc7)],_0x7630da=_0x27cfb1[_0x947fe3(0x78)];console[_0x947fe3(0x96)](_0x947fe3(0xac)+_0x3492a8);const _0x4f7d61=await database_1[_0x947fe3(0xa0)][_0x947fe3(0xa2)]['findUnique']({'where':{'id':_0x3492a8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4f7d61)return _0x52b18f[_0x947fe3(0xb4)](0x194)[_0x947fe3(0x7f)]({'success':![],'message':_0x947fe3(0xbc)});if(_0x4f7d61[_0x947fe3(0x7c)]!==_0x947fe3(0xc9))return _0x52b18f[_0x947fe3(0xb4)](0x190)[_0x947fe3(0x7f)]({'success':![],'message':_0x947fe3(0xd4)});if(_0x4f7d61[_0x947fe3(0xb4)]!==_0x947fe3(0xa1))return _0x52b18f[_0x947fe3(0xb4)](0x190)[_0x947fe3(0x7f)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4f7d61[_0x947fe3(0xb4)]+_0x947fe3(0x9c)});const _0x5a478c=await this[_0x947fe3(0xdb)][_0x947fe3(0xe1)]({'paymentId':_0x4f7d61['id'],'orderId':_0x4f7d61[_0x947fe3(0xb9)]||_0x4f7d61['id'],'amount':_0x4f7d61[_0x947fe3(0x7d)],'currency':_0x4f7d61[_0x947fe3(0xda)],'cardData':_0x7630da});console['log']('🧪\x20Test\x20Gateway\x20result:',_0x5a478c);const _0x2075bd={'status':_0x5a478c[_0x947fe3(0xb4)],'updatedAt':new Date()};if(_0x5a478c[_0x947fe3(0xb4)]===_0x947fe3(0x88))_0x2075bd['paidAt']=new Date(),_0x2075bd[_0x947fe3(0xd9)]=_0x5a478c['transactionId'];else _0x5a478c[_0x947fe3(0xb4)]==='FAILED'&&(_0x2075bd['failureMessage']=_0x5a478c[_0x947fe3(0xd3)]);const _0x5c9d2a=_0x7630da[_0x947fe3(0xa3)][_0x947fe3(0xcb)](/[\s-]/g,'');_0x2075bd[_0x947fe3(0xa4)]=_0x5c9d2a[_0x947fe3(0xc2)](-0x4),_0x2075bd[_0x947fe3(0xb8)]=_0x947fe3(0x68),await database_1[_0x947fe3(0xa0)]['payment'][_0x947fe3(0x93)]({'where':{'id':_0x4f7d61['id']},'data':_0x2075bd});if(_0x5a478c[_0x947fe3(0xb4)]===_0x947fe3(0x88)&&_0x4f7d61[_0x947fe3(0xb1)]){console[_0x947fe3(0x96)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x4f7d61['id']+_0x947fe3(0xaa));try{await database_1[_0x947fe3(0xa0)][_0x947fe3(0xb7)](async _0x5589b5=>{const _0xba75be=_0x947fe3,_0x4f1922=await _0x5589b5['paymentLink'][_0xba75be(0x70)]({'where':{'id':_0x4f7d61[_0xba75be(0xb1)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4f1922){console[_0xba75be(0x96)](_0xba75be(0x7a)+_0x4f1922['id']+_0xba75be(0x6a)+_0x4f1922[_0xba75be(0xa7)]+',\x20currentPayments='+_0x4f1922[_0xba75be(0xd6)]+',\x20status='+_0x4f1922[_0xba75be(0xb4)]);const _0x2fc26d=_0x4f1922[_0xba75be(0xd6)]+0x1,_0x4d846c=_0x4f1922[_0xba75be(0xa7)]===_0xba75be(0xc4)?_0xba75be(0xb3):_0x4f1922[_0xba75be(0xb4)];await _0x5589b5[_0xba75be(0x75)][_0xba75be(0x93)]({'where':{'id':_0x4f7d61[_0xba75be(0xb1)]},'data':{'currentPayments':_0x2fc26d,'status':_0x4d846c,'updatedAt':new Date()}}),console['log'](_0xba75be(0x83)+_0x4f1922['id']+_0xba75be(0x8a)+_0x4f1922[_0xba75be(0xd6)]+_0xba75be(0x89)+_0x2fc26d+_0xba75be(0x86)+_0x4f1922[_0xba75be(0xb4)]+_0xba75be(0x89)+_0x4d846c);}else console[_0xba75be(0x96)](_0xba75be(0x9f)+_0x4f7d61[_0xba75be(0xb1)]+_0xba75be(0xce));});}catch(_0x47ff13){console['error'](_0x947fe3(0x8e),_0x47ff13);}}await database_1[_0x947fe3(0xa0)]['webhookLog'][_0x947fe3(0xab)]({'data':{'paymentId':_0x4f7d61['id'],'shopId':_0x4f7d61[_0x947fe3(0x74)],'event':_0x947fe3(0x6c)+_0x5a478c[_0x947fe3(0xb4)][_0x947fe3(0xae)](),'statusCode':0xc8,'responseBody':JSON[_0x947fe3(0xc6)]({'oldStatus':'PENDING','newStatus':_0x5a478c[_0x947fe3(0xb4)],'transactionId':_0x5a478c[_0x947fe3(0x65)],'failureReason':_0x5a478c[_0x947fe3(0xd3)],'processedAt':new Date()[_0x947fe3(0xdc)]()})}}),await this[_0x947fe3(0xa8)](_0x4f7d61,_0x5a478c['status'],_0x5a478c['transactionId'],_0x5a478c[_0x947fe3(0xd3)]),await this['sendPaymentStatusNotification'](_0x4f7d61,_0x5a478c[_0x947fe3(0xb4)]),console[_0x947fe3(0x96)](_0x947fe3(0x66)+_0x3492a8+'\x20processed:\x20'+_0x5a478c['status']),_0x5a478c[_0x947fe3(0xb4)]===_0x947fe3(0x88)?_0x52b18f[_0x947fe3(0x7f)]({'success':!![],'message':_0x947fe3(0xc0),'result':{'status':_0x947fe3(0x88),'transactionId':_0x5a478c[_0x947fe3(0x65)],'redirectUrl':_0x4f7d61[_0x947fe3(0x6f)]}}):_0x52b18f['status'](0x190)[_0x947fe3(0x7f)]({'success':![],'message':_0x947fe3(0x7e),'result':{'status':'FAILED','failureReason':_0x5a478c[_0x947fe3(0xd3)],'redirectUrl':_0x4f7d61['failUrl']}});}catch(_0x43981d){_0x409f74(_0x43981d);}},this[_0x406ffc(0xdb)]=new testGatewayService_1[(_0x406ffc(0x87))](),this[_0x406ffc(0x9b)]=new webhookService_1[(_0x406ffc(0xa9))]();}async[a13_0x577e86(0xa8)](_0x303aab,_0x147c95,_0x161554,_0x373c3d){const _0x317b32=a13_0x577e86,_0x412009=Date['now']();try{const _0x3b0162=_0x303aab[_0x317b32(0xa5)],_0xd616ab=_0x3b0162[_0x317b32(0x92)];if(!_0xd616ab?.[_0x317b32(0x82)]){console['log'](_0x317b32(0x79)+_0x3b0162['id']);return;}const _0x2f1ff1=_0x147c95==='PAID'?_0x317b32(0xd0):_0x317b32(0x9e);let _0x3e1767=[];if(_0xd616ab[_0x317b32(0xba)])try{_0x3e1767=Array[_0x317b32(0xb6)](_0xd616ab[_0x317b32(0xba)])?_0xd616ab[_0x317b32(0xba)]:JSON['parse'](_0xd616ab[_0x317b32(0xba)]);}catch(_0x50d61e){console[_0x317b32(0x73)](_0x317b32(0xad),_0x50d61e),_0x3e1767=[];}if(!_0x3e1767[_0x317b32(0x97)](_0x2f1ff1)){console[_0x317b32(0x96)](_0x317b32(0xcf)+_0x2f1ff1+_0x317b32(0xd8)+_0x3b0162['id']);return;}const _0x441cbd={'event':_0x2f1ff1,'payment':{'id':_0x303aab['id'],'order_id':_0x303aab[_0x317b32(0x6b)],'gateway_order_id':_0x303aab[_0x317b32(0xb9)],'gateway':_0x317b32(0x94),'amount':_0x303aab[_0x317b32(0x7d)],'currency':_0x303aab[_0x317b32(0xda)],'status':_0x147c95[_0x317b32(0xae)](),'customer_email':_0x303aab[_0x317b32(0xd7)],'customer_name':_0x303aab[_0x317b32(0x67)],'transaction_id':_0x161554,'failure_message':_0x373c3d,'created_at':_0x303aab[_0x317b32(0xc1)],'updated_at':new Date()}},_0x39a0e1=await fetch(_0xd616ab['webhookUrl'],{'method':_0x317b32(0x91),'headers':{'Content-Type':_0x317b32(0x80),'User-Agent':_0x317b32(0xbf)},'body':JSON[_0x317b32(0xc6)](_0x441cbd)}),_0x2a836e=Date[_0x317b32(0xaf)]()-_0x412009;console[_0x317b32(0x96)](_0x317b32(0xbb)+_0xd616ab[_0x317b32(0x82)]+_0x317b32(0x77)+_0x39a0e1['status']+'\x20('+_0x2a836e+_0x317b32(0xcd));}catch(_0x356b6a){console[_0x317b32(0x73)](_0x317b32(0xd1),_0x356b6a);}}async[a13_0x577e86(0x99)](_0x18f989,_0x511cb2){const _0x1f1707=a13_0x577e86;try{const {telegramBotService:_0x26fa2b}=await Promise[_0x1f1707(0x95)]()['then'](()=>__importStar(require(_0x1f1707(0xdd)))),_0x5d793d={'PAID':_0x1f1707(0xd5),'FAILED':'failed'},_0x572d23=_0x5d793d[_0x511cb2];if(!_0x572d23)return;await _0x26fa2b[_0x1f1707(0xb5)](_0x18f989['shopId'],_0x18f989,_0x572d23);}catch(_0x347c98){console[_0x1f1707(0x73)](_0x1f1707(0xc5),_0x347c98);}}}exports[a13_0x577e86(0xd2)]=TestGatewayController;