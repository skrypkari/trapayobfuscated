'use strict';const a13_0x17e815=a13_0x1f8a;(function(_0x1bc34c,_0x3215aa){const _0x561e55=a13_0x1f8a,_0x330dcf=_0x1bc34c();while(!![]){try{const _0x5c7308=parseInt(_0x561e55(0x265))/0x1+parseInt(_0x561e55(0x209))/0x2*(parseInt(_0x561e55(0x21a))/0x3)+-parseInt(_0x561e55(0x242))/0x4*(parseInt(_0x561e55(0x222))/0x5)+parseInt(_0x561e55(0x1fc))/0x6+parseInt(_0x561e55(0x245))/0x7+-parseInt(_0x561e55(0x25c))/0x8*(parseInt(_0x561e55(0x235))/0x9)+parseInt(_0x561e55(0x249))/0xa*(-parseInt(_0x561e55(0x26b))/0xb);if(_0x5c7308===_0x3215aa)break;else _0x330dcf['push'](_0x330dcf['shift']());}catch(_0x5bad66){_0x330dcf['push'](_0x330dcf['shift']());}}}(a13_0x20b0,0xd180b));function a13_0x20b0(){const _0xf769c3=['includes',',\x20status=','body','\x20->\x20','COMPLETED','FAILED','name','3gYIqbV','Any\x203-4\x20digits','findUnique','currentPayments','length','paymentLink','üß™\x20Test\x20Gateway\x20result:','getPaymentForm','290935VCphaT','paymentLinkId','Payment\x20failed','customerName','__importDefault','getOwnPropertyNames','0000','writable','application/json','testGatewayService','\x20updated:\x20currentPayments=','test_gateway_','../services/webhookService','__setModuleDefault','Error\x20parsing\x20webhook\x20events:','status','paymentMethod','POST','json','176139XJOrtt','error','processCard','isArray','get','paid','default','failureReason',',\x20cannot\x20process','TestGatewayService','\x20not\x20enabled\x20for\x20shop\x20','processCardPayment','configurable','4kDuoEI','Payment\x20is\x20not\x20for\x20test\x20gateway','sendShopWebhook','284571xRxSPp','$transaction','shop','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','30DfmcVJ','__esModule','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20processed:\x20','cardNumber','ms)','transactionId','call','failureMessage','PENDING','webhookLog','Any\x20other\x20card\x20number','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Any\x20name','shopId','PAID','currency','hasOwnProperty','sendPaymentNotification','280DyeEQz','paidAt','toLowerCase','update','stringify','__createBinding','Webhook\x20event\x20','Any\x20future\x20date\x20(MM/YY)','webhookUrl','1196343lqjfLo','webhookEvents','\x20with\x20status\x20','createdAt','Payment\x20not\x20found','toISOString','7357713QceBUF','getOwnPropertyDescriptor','Payment\x20processed\x20successfully','defineProperty','params','test_card','failUrl','‚úÖ\x20Payment\x20link\x20','4242\x204242\x204242\x204242','slice','now','Payment\x20status\x20is\x20','__importStar','‚úÖ\x20Test\x20Gateway\x20payment\x20','settings','create','SINGLE','sendPaymentStatusNotification','10278300opXeuC',':\x20type=','TestGatewayController','customerEmail','test_gateway','gatewayOrderId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','payment.failed','prototype','üìà\x20Test\x20Gateway:\x20Payment\x20','parse','gatewayPaymentId','amount','1315796iUixqJ','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','type','webhookService','../services/gateways/testGatewayService','payment.success','cardLast4','then','resolve','log'];a13_0x20b0=function(){return _0xf769c3;};return a13_0x20b0();}var __createBinding=this&&this[a13_0x17e815(0x261)]||(Object[a13_0x17e815(0x1f9)]?function(_0x40ba39,_0x21ca81,_0x48d17e,_0x559539){const _0x44e35f=a13_0x17e815;if(_0x559539===undefined)_0x559539=_0x48d17e;var _0xe2270c=Object[_0x44e35f(0x26c)](_0x21ca81,_0x48d17e);(!_0xe2270c||(_0x44e35f(0x239)in _0xe2270c?!_0x21ca81[_0x44e35f(0x24a)]:_0xe2270c[_0x44e35f(0x229)]||_0xe2270c[_0x44e35f(0x241)]))&&(_0xe2270c={'enumerable':!![],'get':function(){return _0x21ca81[_0x48d17e];}}),Object['defineProperty'](_0x40ba39,_0x559539,_0xe2270c);}:function(_0x52d6c4,_0x305a7b,_0x247027,_0x1235e6){if(_0x1235e6===undefined)_0x1235e6=_0x247027;_0x52d6c4[_0x1235e6]=_0x305a7b[_0x247027];}),__setModuleDefault=this&&this[a13_0x17e815(0x22f)]||(Object['create']?function(_0x3abd8c,_0x5efdc4){const _0x10a552=a13_0x17e815;Object[_0x10a552(0x26e)](_0x3abd8c,'default',{'enumerable':!![],'value':_0x5efdc4});}:function(_0x2c76ed,_0x1f8a88){const _0x49e69e=a13_0x17e815;_0x2c76ed[_0x49e69e(0x23b)]=_0x1f8a88;}),__importStar=this&&this[a13_0x17e815(0x1f6)]||(function(){var _0x4e7fce=function(_0x3e825b){const _0x3b69b9=a13_0x1f8a;return _0x4e7fce=Object[_0x3b69b9(0x227)]||function(_0x210474){const _0x55af45=_0x3b69b9;var _0x3ac40f=[];for(var _0x4b1f61 in _0x210474)if(Object[_0x55af45(0x204)][_0x55af45(0x25a)][_0x55af45(0x250)](_0x210474,_0x4b1f61))_0x3ac40f[_0x3ac40f[_0x55af45(0x21e)]]=_0x4b1f61;return _0x3ac40f;},_0x4e7fce(_0x3e825b);};return function(_0x26d1ad){const _0x35e418=a13_0x1f8a;if(_0x26d1ad&&_0x26d1ad[_0x35e418(0x24a)])return _0x26d1ad;var _0x2d2474={};if(_0x26d1ad!=null){for(var _0x5c6af1=_0x4e7fce(_0x26d1ad),_0x1fc883=0x0;_0x1fc883<_0x5c6af1[_0x35e418(0x21e)];_0x1fc883++)if(_0x5c6af1[_0x1fc883]!==_0x35e418(0x23b))__createBinding(_0x2d2474,_0x26d1ad,_0x5c6af1[_0x1fc883]);}return __setModuleDefault(_0x2d2474,_0x26d1ad),_0x2d2474;};}()),__importDefault=this&&this[a13_0x17e815(0x226)]||function(_0x3b55c8){const _0x73bf50=a13_0x17e815;return _0x3b55c8&&_0x3b55c8[_0x73bf50(0x24a)]?_0x3b55c8:{'default':_0x3b55c8};};Object[a13_0x17e815(0x26e)](exports,a13_0x17e815(0x24a),{'value':!![]}),exports[a13_0x17e815(0x1fe)]=void 0x0;const testGatewayService_1=require(a13_0x17e815(0x20d)),webhookService_1=require(a13_0x17e815(0x22e)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x4d901d=a13_0x17e815;this[_0x4d901d(0x221)]=async(_0x45396f,_0x40f706,_0x21abb4)=>{const _0x4ed26c=_0x4d901d;try{const {paymentId:_0x4ce6e7}=_0x45396f[_0x4ed26c(0x26f)];console[_0x4ed26c(0x212)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4ce6e7);const _0xe231d5=await database_1[_0x4ed26c(0x23b)]['payment'][_0x4ed26c(0x21c)]({'where':{'id':_0x4ce6e7},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xe231d5)return _0x40f706[_0x4ed26c(0x231)](0x194)['json']({'success':![],'message':_0x4ed26c(0x269)});if(_0xe231d5['gateway']!==_0x4ed26c(0x200))return _0x40f706[_0x4ed26c(0x231)](0x190)['json']({'success':![],'message':_0x4ed26c(0x243)});if(_0xe231d5[_0x4ed26c(0x231)]!=='PENDING')return _0x40f706['status'](0x190)[_0x4ed26c(0x234)]({'success':![],'message':_0x4ed26c(0x1f5)+_0xe231d5['status']+_0x4ed26c(0x23d)});_0x40f706[_0x4ed26c(0x234)]({'success':!![],'result':{'paymentId':_0xe231d5['id'],'orderId':_0xe231d5[_0x4ed26c(0x201)],'amount':_0xe231d5['amount'],'currency':_0xe231d5[_0x4ed26c(0x259)],'merchantName':_0xe231d5['shop'][_0x4ed26c(0x219)],'description':'Payment\x20to\x20'+_0xe231d5[_0x4ed26c(0x247)]['name'],'testInstructions':{'successCard':_0x4ed26c(0x1f2),'failureCard':_0x4ed26c(0x254),'expiryDate':_0x4ed26c(0x263),'cvc':_0x4ed26c(0x21b),'holderName':_0x4ed26c(0x256)}}});}catch(_0x3081f8){_0x21abb4(_0x3081f8);}},this[_0x4d901d(0x237)]=async(_0x698b7f,_0x3c55a4,_0x232731)=>{const _0x3a730d=_0x4d901d;try{const {paymentId:_0x2bd4d8}=_0x698b7f[_0x3a730d(0x26f)],_0x4a4be7=_0x698b7f[_0x3a730d(0x215)];console[_0x3a730d(0x212)](_0x3a730d(0x20a)+_0x2bd4d8);const _0x4821e9=await database_1[_0x3a730d(0x23b)]['payment'][_0x3a730d(0x21c)]({'where':{'id':_0x2bd4d8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4821e9)return _0x3c55a4[_0x3a730d(0x231)](0x194)[_0x3a730d(0x234)]({'success':![],'message':_0x3a730d(0x269)});if(_0x4821e9['gateway']!==_0x3a730d(0x200))return _0x3c55a4[_0x3a730d(0x231)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4821e9[_0x3a730d(0x231)]!==_0x3a730d(0x252))return _0x3c55a4['status'](0x190)[_0x3a730d(0x234)]({'success':![],'message':_0x3a730d(0x1f5)+_0x4821e9[_0x3a730d(0x231)]+_0x3a730d(0x23d)});const _0xd1d230=await this[_0x3a730d(0x22b)][_0x3a730d(0x240)]({'paymentId':_0x4821e9['id'],'orderId':_0x4821e9[_0x3a730d(0x201)]||_0x4821e9['id'],'amount':_0x4821e9[_0x3a730d(0x208)],'currency':_0x4821e9['currency'],'cardData':_0x4a4be7});console[_0x3a730d(0x212)](_0x3a730d(0x220),_0xd1d230);const _0x3f9036={'status':_0xd1d230[_0x3a730d(0x231)],'updatedAt':new Date()};if(_0xd1d230[_0x3a730d(0x231)]===_0x3a730d(0x258))_0x3f9036[_0x3a730d(0x25d)]=new Date(),_0x3f9036[_0x3a730d(0x207)]=_0xd1d230[_0x3a730d(0x24f)];else _0xd1d230[_0x3a730d(0x231)]==='FAILED'&&(_0x3f9036[_0x3a730d(0x251)]=_0xd1d230[_0x3a730d(0x23c)]);const _0x21c1ee=_0x4a4be7[_0x3a730d(0x24d)]['replace'](/[\s-]/g,'');_0x3f9036[_0x3a730d(0x20f)]=_0x21c1ee[_0x3a730d(0x1f3)](-0x4),_0x3f9036[_0x3a730d(0x232)]=_0x3a730d(0x270),await database_1['default']['payment'][_0x3a730d(0x25f)]({'where':{'id':_0x4821e9['id']},'data':_0x3f9036});if(_0xd1d230[_0x3a730d(0x231)]==='PAID'&&_0x4821e9[_0x3a730d(0x223)]){console['log'](_0x3a730d(0x205)+_0x4821e9['id']+_0x3a730d(0x255));try{await database_1['default'][_0x3a730d(0x246)](async _0x34db31=>{const _0x577521=_0x3a730d,_0x3b9082=await _0x34db31['paymentLink'][_0x577521(0x21c)]({'where':{'id':_0x4821e9[_0x577521(0x223)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3b9082){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x3b9082['id']+_0x577521(0x1fd)+_0x3b9082[_0x577521(0x20b)]+',\x20currentPayments='+_0x3b9082[_0x577521(0x21d)]+_0x577521(0x214)+_0x3b9082[_0x577521(0x231)]);const _0x3cfd6e=_0x3b9082['currentPayments']+0x1,_0x49f37a=_0x3b9082[_0x577521(0x20b)]===_0x577521(0x1fa)?_0x577521(0x217):_0x3b9082[_0x577521(0x231)];await _0x34db31[_0x577521(0x21f)][_0x577521(0x25f)]({'where':{'id':_0x4821e9[_0x577521(0x223)]},'data':{'currentPayments':_0x3cfd6e,'status':_0x49f37a,'updatedAt':new Date()}}),console[_0x577521(0x212)](_0x577521(0x1f1)+_0x3b9082['id']+_0x577521(0x22c)+_0x3b9082[_0x577521(0x21d)]+_0x577521(0x216)+_0x3cfd6e+',\x20status='+_0x3b9082['status']+_0x577521(0x216)+_0x49f37a);}else console[_0x577521(0x212)]('‚ùå\x20Payment\x20link\x20'+_0x4821e9[_0x577521(0x223)]+'\x20not\x20found');});}catch(_0x1df9d2){console[_0x3a730d(0x236)](_0x3a730d(0x24b),_0x1df9d2);}}await database_1['default'][_0x3a730d(0x253)]['create']({'data':{'paymentId':_0x4821e9['id'],'shopId':_0x4821e9[_0x3a730d(0x257)],'event':_0x3a730d(0x22d)+_0xd1d230[_0x3a730d(0x231)][_0x3a730d(0x25e)](),'statusCode':0xc8,'responseBody':JSON[_0x3a730d(0x260)]({'oldStatus':'PENDING','newStatus':_0xd1d230[_0x3a730d(0x231)],'transactionId':_0xd1d230[_0x3a730d(0x24f)],'failureReason':_0xd1d230[_0x3a730d(0x23c)],'processedAt':new Date()[_0x3a730d(0x26a)]()})}}),await this[_0x3a730d(0x244)](_0x4821e9,_0xd1d230['status'],_0xd1d230[_0x3a730d(0x24f)],_0xd1d230[_0x3a730d(0x23c)]),await this[_0x3a730d(0x1fb)](_0x4821e9,_0xd1d230[_0x3a730d(0x231)]),console['log'](_0x3a730d(0x1f7)+_0x2bd4d8+_0x3a730d(0x24c)+_0xd1d230['status']),_0xd1d230[_0x3a730d(0x231)]===_0x3a730d(0x258)?_0x3c55a4[_0x3a730d(0x234)]({'success':!![],'message':_0x3a730d(0x26d),'result':{'status':'PAID','transactionId':_0xd1d230[_0x3a730d(0x24f)],'redirectUrl':_0x4821e9['successUrl']}}):_0x3c55a4[_0x3a730d(0x231)](0x190)[_0x3a730d(0x234)]({'success':![],'message':_0x3a730d(0x224),'result':{'status':_0x3a730d(0x218),'failureReason':_0xd1d230[_0x3a730d(0x23c)],'redirectUrl':_0x4821e9[_0x3a730d(0x1f0)]}});}catch(_0x5a9a3b){_0x232731(_0x5a9a3b);}},this[_0x4d901d(0x22b)]=new testGatewayService_1[(_0x4d901d(0x23e))](),this[_0x4d901d(0x20c)]=new webhookService_1['WebhookService']();}async[a13_0x17e815(0x244)](_0x4dffac,_0x81293,_0x3bf0b4,_0x420e21){const _0x1ea4de=a13_0x17e815,_0x397c40=Date[_0x1ea4de(0x1f4)]();try{const _0x8775a0=_0x4dffac['shop'],_0x39f220=_0x8775a0[_0x1ea4de(0x1f8)];if(!_0x39f220?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x8775a0['id']);return;}const _0x3bd8a6=_0x81293==='PAID'?_0x1ea4de(0x20e):_0x1ea4de(0x203);let _0x56fd7e=[];if(_0x39f220[_0x1ea4de(0x266)])try{_0x56fd7e=Array[_0x1ea4de(0x238)](_0x39f220[_0x1ea4de(0x266)])?_0x39f220[_0x1ea4de(0x266)]:JSON[_0x1ea4de(0x206)](_0x39f220[_0x1ea4de(0x266)]);}catch(_0xaae454){console[_0x1ea4de(0x236)](_0x1ea4de(0x230),_0xaae454),_0x56fd7e=[];}if(!_0x56fd7e[_0x1ea4de(0x213)](_0x3bd8a6)){console[_0x1ea4de(0x212)](_0x1ea4de(0x262)+_0x3bd8a6+_0x1ea4de(0x23f)+_0x8775a0['id']);return;}const _0x3c62ac={'event':_0x3bd8a6,'payment':{'id':_0x4dffac['id'],'order_id':_0x4dffac['orderId'],'gateway_order_id':_0x4dffac[_0x1ea4de(0x201)],'gateway':_0x1ea4de(0x228),'amount':_0x4dffac[_0x1ea4de(0x208)],'currency':_0x4dffac[_0x1ea4de(0x259)],'status':_0x81293[_0x1ea4de(0x25e)](),'customer_email':_0x4dffac[_0x1ea4de(0x1ff)],'customer_name':_0x4dffac[_0x1ea4de(0x225)],'transaction_id':_0x3bf0b4,'failure_message':_0x420e21,'created_at':_0x4dffac[_0x1ea4de(0x268)],'updated_at':new Date()}},_0x23249b=await fetch(_0x39f220[_0x1ea4de(0x264)],{'method':_0x1ea4de(0x233),'headers':{'Content-Type':_0x1ea4de(0x22a),'User-Agent':_0x1ea4de(0x248)},'body':JSON['stringify'](_0x3c62ac)}),_0x1150f9=Date['now']()-_0x397c40;console[_0x1ea4de(0x212)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x39f220[_0x1ea4de(0x264)]+_0x1ea4de(0x267)+_0x23249b[_0x1ea4de(0x231)]+'\x20('+_0x1150f9+_0x1ea4de(0x24e));}catch(_0x29ffa8){console['error'](_0x1ea4de(0x202),_0x29ffa8);}}async[a13_0x17e815(0x1fb)](_0x431ff1,_0x344f71){const _0x9c0a4c=a13_0x17e815;try{const {telegramBotService:_0x37dea2}=await Promise[_0x9c0a4c(0x211)]()[_0x9c0a4c(0x210)](()=>__importStar(require('../services/telegramBotService'))),_0x321638={'PAID':_0x9c0a4c(0x23a),'FAILED':'failed'},_0x56b9a7=_0x321638[_0x344f71];if(!_0x56b9a7)return;await _0x37dea2[_0x9c0a4c(0x25b)](_0x431ff1[_0x9c0a4c(0x257)],_0x431ff1,_0x56b9a7);}catch(_0x173bf0){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x173bf0);}}}function a13_0x1f8a(_0x1724ae,_0x5f28bb){const _0x20b0f4=a13_0x20b0();return a13_0x1f8a=function(_0x1f8a7c,_0x44d5ff){_0x1f8a7c=_0x1f8a7c-0x1f0;let _0x144c74=_0x20b0f4[_0x1f8a7c];return _0x144c74;},a13_0x1f8a(_0x1724ae,_0x5f28bb);}exports[a13_0x17e815(0x1fe)]=TestGatewayController;