'use strict';const a15_0xce75c6=a15_0x1d2c;(function(_0x4d873c,_0x5c6fbf){const _0x315aa8=a15_0x1d2c,_0x35154c=_0x4d873c();while(!![]){try{const _0x223f9d=-parseInt(_0x315aa8(0x1ea))/0x1*(-parseInt(_0x315aa8(0x1c4))/0x2)+parseInt(_0x315aa8(0x1fa))/0x3*(-parseInt(_0x315aa8(0x204))/0x4)+parseInt(_0x315aa8(0x1e4))/0x5+parseInt(_0x315aa8(0x1f7))/0x6*(-parseInt(_0x315aa8(0x1dc))/0x7)+parseInt(_0x315aa8(0x1b1))/0x8*(-parseInt(_0x315aa8(0x1f0))/0x9)+-parseInt(_0x315aa8(0x1ec))/0xa*(-parseInt(_0x315aa8(0x1a5))/0xb)+parseInt(_0x315aa8(0x195))/0xc*(-parseInt(_0x315aa8(0x203))/0xd);if(_0x223f9d===_0x5c6fbf)break;else _0x35154c['push'](_0x35154c['shift']());}catch(_0x576d98){_0x35154c['push'](_0x35154c['shift']());}}}(a15_0x7bbb,0x9fe9f));var __createBinding=this&&this[a15_0xce75c6(0x1db)]||(Object[a15_0xce75c6(0x1f1)]?function(_0x1ea8fb,_0x385550,_0x48efb4,_0x553a2f){const _0x106437=a15_0xce75c6;if(_0x553a2f===undefined)_0x553a2f=_0x48efb4;var _0x53c033=Object['getOwnPropertyDescriptor'](_0x385550,_0x48efb4);(!_0x53c033||('get'in _0x53c033?!_0x385550[_0x106437(0x1a2)]:_0x53c033[_0x106437(0x1ae)]||_0x53c033[_0x106437(0x1e8)]))&&(_0x53c033={'enumerable':!![],'get':function(){return _0x385550[_0x48efb4];}}),Object[_0x106437(0x1f2)](_0x1ea8fb,_0x553a2f,_0x53c033);}:function(_0x54b6a5,_0x56e15e,_0x3bd009,_0x4cd425){if(_0x4cd425===undefined)_0x4cd425=_0x3bd009;_0x54b6a5[_0x4cd425]=_0x56e15e[_0x3bd009];}),__setModuleDefault=this&&this[a15_0xce75c6(0x1d0)]||(Object[a15_0xce75c6(0x1f1)]?function(_0x5555cf,_0x3542d8){const _0x1701fd=a15_0xce75c6;Object[_0x1701fd(0x1f2)](_0x5555cf,_0x1701fd(0x1ad),{'enumerable':!![],'value':_0x3542d8});}:function(_0x206a67,_0x5ca31d){const _0x4d6361=a15_0xce75c6;_0x206a67[_0x4d6361(0x1ad)]=_0x5ca31d;}),__importStar=this&&this['__importStar']||(function(){var _0x3473a9=function(_0x51d576){const _0x21a727=a15_0x1d2c;return _0x3473a9=Object[_0x21a727(0x1aa)]||function(_0x1bd133){const _0xb86767=_0x21a727;var _0x57bc49=[];for(var _0x7b7699 in _0x1bd133)if(Object[_0xb86767(0x1b9)][_0xb86767(0x1c2)][_0xb86767(0x1fb)](_0x1bd133,_0x7b7699))_0x57bc49[_0x57bc49['length']]=_0x7b7699;return _0x57bc49;},_0x3473a9(_0x51d576);};return function(_0x453aef){const _0x420876=a15_0x1d2c;if(_0x453aef&&_0x453aef[_0x420876(0x1a2)])return _0x453aef;var _0x764ff6={};if(_0x453aef!=null){for(var _0xfc531d=_0x3473a9(_0x453aef),_0x6f70fa=0x0;_0x6f70fa<_0xfc531d[_0x420876(0x1a9)];_0x6f70fa++)if(_0xfc531d[_0x6f70fa]!=='default')__createBinding(_0x764ff6,_0x453aef,_0xfc531d[_0x6f70fa]);}return __setModuleDefault(_0x764ff6,_0x453aef),_0x764ff6;};}()),__importDefault=this&&this[a15_0xce75c6(0x209)]||function(_0x1a786d){const _0x2be3c5=a15_0xce75c6;return _0x1a786d&&_0x1a786d[_0x2be3c5(0x1a2)]?_0x1a786d:{'default':_0x1a786d};};function a15_0x1d2c(_0x55ad77,_0x1cf8dc){const _0x7bbbe1=a15_0x7bbb();return a15_0x1d2c=function(_0x1d2cb9,_0x4b89a7){_0x1d2cb9=_0x1d2cb9-0x192;let _0x40360c=_0x7bbbe1[_0x1d2cb9];return _0x40360c;},a15_0x1d2c(_0x55ad77,_0x1cf8dc);}Object[a15_0xce75c6(0x1f2)](exports,a15_0xce75c6(0x1a2),{'value':!![]}),exports[a15_0xce75c6(0x1ab)]=void 0x0;function a15_0x7bbb(){const _0x1fc340=['then','6574368pFCkUG','paidAt','Payment\x20is\x20not\x20for\x20test\x20gateway','successUrl','Error\x20parsing\x20webhook\x20events:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','processCard','../services/telegramBotService','json','paid','\x20processed:\x20',',\x20currentPayments=','name','__esModule','payment.failed','failUrl','22XoylfE','update','PAID','webhookUrl','length','getOwnPropertyNames','TestGatewayController','includes','default','writable','orderId','shopId','407248GDsYHD','processCardPayment','../services/gateways/testGatewayService','customerName','Payment\x20System/1.0\x20(Test\x20Gateway)','status','webhookLog','payment.success','prototype','Any\x203-4\x20digits','Payment\x20failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','log','createdAt','paymentLink','now','PENDING','hasOwnProperty','📈\x20Found\x20payment\x20link\x20','26582ZUkgQM','✅\x20Payment\x20link\x20','📈\x20Test\x20Gateway:\x20Payment\x20','Payment\x20status\x20is\x20','shop','payment','failureReason','getPaymentForm','webhookEvents','POST','type','Webhook\x20event\x20','__setModuleDefault','paymentLinkId','toISOString','4242\x204242\x204242\x204242','Payment\x20not\x20found','error','✅\x20Test\x20Gateway\x20payment\x20','testGatewayService','currency','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','🧪\x20Test\x20Gateway\x20result:','__createBinding','1193087jNxtGe','sendShopWebhook','webhookService','application/json','Any\x20other\x20card\x20number','gatewayOrderId','\x20updated:\x20currentPayments=','WebhookService','5947485voVbdn','currentPayments','\x20not\x20enabled\x20for\x20shop\x20','paymentMethod','configurable','test_card','49yVsGgm','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','2140390NJcGlT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Test\x20Gateway\x20webhook\x20sent\x20to\x20','body','72joHnJB','create','defineProperty','stringify','Any\x20name','params','Payment\x20to\x20','6aHgAhn','findUnique','TestGatewayService','51sCGRHz','call','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','toLowerCase','\x20with\x20status\x20','transactionId','settings','0000','failureMessage','13gIaFXJ','114888mmwlPl','sendPaymentStatusNotification',',\x20cannot\x20process',',\x20status=','gateway','__importDefault','gatewayPaymentId','FAILED','❌\x20Payment\x20link\x20','\x20->\x20','slice'];a15_0x7bbb=function(){return _0x1fc340;};return a15_0x7bbb();}const testGatewayService_1=require(a15_0xce75c6(0x1b3)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x2efcc7=a15_0xce75c6;this[_0x2efcc7(0x1cb)]=async(_0x426445,_0x22745a,_0x410ee8)=>{const _0x22423f=_0x2efcc7;try{const {paymentId:_0x4e6a64}=_0x426445['params'];console[_0x22423f(0x1bd)](_0x22423f(0x1eb)+_0x4e6a64);const _0x5040c7=await database_1[_0x22423f(0x1ad)]['payment']['findUnique']({'where':{'id':_0x4e6a64},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5040c7)return _0x22745a['status'](0x194)['json']({'success':![],'message':_0x22423f(0x1d4)});if(_0x5040c7[_0x22423f(0x208)]!=='test_gateway')return _0x22745a[_0x22423f(0x1b6)](0x190)[_0x22423f(0x19d)]({'success':![],'message':_0x22423f(0x197)});if(_0x5040c7[_0x22423f(0x1b6)]!==_0x22423f(0x1c1))return _0x22745a[_0x22423f(0x1b6)](0x190)['json']({'success':![],'message':_0x22423f(0x1c7)+_0x5040c7[_0x22423f(0x1b6)]+_0x22423f(0x206)});_0x22745a['json']({'success':!![],'result':{'paymentId':_0x5040c7['id'],'orderId':_0x5040c7[_0x22423f(0x1e1)],'amount':_0x5040c7['amount'],'currency':_0x5040c7[_0x22423f(0x1d8)],'merchantName':_0x5040c7[_0x22423f(0x1c8)][_0x22423f(0x1a1)],'description':_0x22423f(0x1f6)+_0x5040c7[_0x22423f(0x1c8)][_0x22423f(0x1a1)],'testInstructions':{'successCard':_0x22423f(0x1d3),'failureCard':_0x22423f(0x1e0),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x22423f(0x1ba),'holderName':_0x22423f(0x1f4)}}});}catch(_0x4f2b4d){_0x410ee8(_0x4f2b4d);}},this[_0x2efcc7(0x19b)]=async(_0x42758a,_0x2a5d66,_0x27a782)=>{const _0x4baf5f=_0x2efcc7;try{const {paymentId:_0x401a4f}=_0x42758a[_0x4baf5f(0x1f5)],_0x3c3a79=_0x42758a[_0x4baf5f(0x1ef)];console[_0x4baf5f(0x1bd)](_0x4baf5f(0x1d9)+_0x401a4f);const _0x29399d=await database_1[_0x4baf5f(0x1ad)][_0x4baf5f(0x1c9)][_0x4baf5f(0x1f8)]({'where':{'id':_0x401a4f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29399d)return _0x2a5d66[_0x4baf5f(0x1b6)](0x194)['json']({'success':![],'message':_0x4baf5f(0x1d4)});if(_0x29399d['gateway']!=='test_gateway')return _0x2a5d66[_0x4baf5f(0x1b6)](0x190)[_0x4baf5f(0x19d)]({'success':![],'message':_0x4baf5f(0x197)});if(_0x29399d[_0x4baf5f(0x1b6)]!==_0x4baf5f(0x1c1))return _0x2a5d66[_0x4baf5f(0x1b6)](0x190)['json']({'success':![],'message':_0x4baf5f(0x1c7)+_0x29399d['status']+_0x4baf5f(0x206)});const _0x2711da=await this[_0x4baf5f(0x1d7)][_0x4baf5f(0x1b2)]({'paymentId':_0x29399d['id'],'orderId':_0x29399d[_0x4baf5f(0x1e1)]||_0x29399d['id'],'amount':_0x29399d['amount'],'currency':_0x29399d[_0x4baf5f(0x1d8)],'cardData':_0x3c3a79});console['log'](_0x4baf5f(0x1da),_0x2711da);const _0x3b5399={'status':_0x2711da[_0x4baf5f(0x1b6)],'updatedAt':new Date()};if(_0x2711da[_0x4baf5f(0x1b6)]===_0x4baf5f(0x1a7))_0x3b5399[_0x4baf5f(0x196)]=new Date(),_0x3b5399[_0x4baf5f(0x20a)]=_0x2711da[_0x4baf5f(0x1ff)];else _0x2711da[_0x4baf5f(0x1b6)]===_0x4baf5f(0x20b)&&(_0x3b5399[_0x4baf5f(0x202)]=_0x2711da['failureReason']);const _0x266e8e=_0x3c3a79['cardNumber']['replace'](/[\s-]/g,'');_0x3b5399['cardLast4']=_0x266e8e[_0x4baf5f(0x193)](-0x4),_0x3b5399[_0x4baf5f(0x1e7)]=_0x4baf5f(0x1e9),await database_1[_0x4baf5f(0x1ad)][_0x4baf5f(0x1c9)][_0x4baf5f(0x1a6)]({'where':{'id':_0x29399d['id']},'data':_0x3b5399});if(_0x2711da[_0x4baf5f(0x1b6)]===_0x4baf5f(0x1a7)&&_0x29399d[_0x4baf5f(0x1d1)]){console[_0x4baf5f(0x1bd)](_0x4baf5f(0x1c6)+_0x29399d['id']+_0x4baf5f(0x1fc));try{await database_1[_0x4baf5f(0x1ad)]['$transaction'](async _0x1462e5=>{const _0x1d592f=_0x4baf5f,_0x59703f=await _0x1462e5[_0x1d592f(0x1bf)][_0x1d592f(0x1f8)]({'where':{'id':_0x29399d[_0x1d592f(0x1d1)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x59703f){console[_0x1d592f(0x1bd)](_0x1d592f(0x1c3)+_0x59703f['id']+':\x20type='+_0x59703f[_0x1d592f(0x1ce)]+_0x1d592f(0x1a0)+_0x59703f[_0x1d592f(0x1e5)]+_0x1d592f(0x207)+_0x59703f[_0x1d592f(0x1b6)]);const _0x3e04d0=_0x59703f[_0x1d592f(0x1e5)]+0x1,_0x5ae555=_0x59703f[_0x1d592f(0x1ce)]==='SINGLE'?'COMPLETED':_0x59703f['status'];await _0x1462e5[_0x1d592f(0x1bf)][_0x1d592f(0x1a6)]({'where':{'id':_0x29399d[_0x1d592f(0x1d1)]},'data':{'currentPayments':_0x3e04d0,'status':_0x5ae555,'updatedAt':new Date()}}),console[_0x1d592f(0x1bd)](_0x1d592f(0x1c5)+_0x59703f['id']+_0x1d592f(0x1e2)+_0x59703f['currentPayments']+'\x20->\x20'+_0x3e04d0+_0x1d592f(0x207)+_0x59703f[_0x1d592f(0x1b6)]+_0x1d592f(0x192)+_0x5ae555);}else console['log'](_0x1d592f(0x20c)+_0x29399d[_0x1d592f(0x1d1)]+'\x20not\x20found');});}catch(_0x55fbd3){console[_0x4baf5f(0x1d5)](_0x4baf5f(0x19a),_0x55fbd3);}}await database_1[_0x4baf5f(0x1ad)][_0x4baf5f(0x1b7)]['create']({'data':{'paymentId':_0x29399d['id'],'shopId':_0x29399d[_0x4baf5f(0x1b0)],'event':'test_gateway_'+_0x2711da[_0x4baf5f(0x1b6)][_0x4baf5f(0x1fd)](),'statusCode':0xc8,'responseBody':JSON[_0x4baf5f(0x1f3)]({'oldStatus':'PENDING','newStatus':_0x2711da[_0x4baf5f(0x1b6)],'transactionId':_0x2711da[_0x4baf5f(0x1ff)],'failureReason':_0x2711da[_0x4baf5f(0x1ca)],'processedAt':new Date()[_0x4baf5f(0x1d2)]()})}}),await this[_0x4baf5f(0x1dd)](_0x29399d,_0x2711da[_0x4baf5f(0x1b6)],_0x2711da[_0x4baf5f(0x1ff)],_0x2711da[_0x4baf5f(0x1ca)]),await this['sendPaymentStatusNotification'](_0x29399d,_0x2711da['status']),console[_0x4baf5f(0x1bd)](_0x4baf5f(0x1d6)+_0x401a4f+_0x4baf5f(0x19f)+_0x2711da[_0x4baf5f(0x1b6)]),_0x2711da[_0x4baf5f(0x1b6)]==='PAID'?_0x2a5d66[_0x4baf5f(0x19d)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x2711da[_0x4baf5f(0x1ff)],'redirectUrl':_0x29399d[_0x4baf5f(0x198)]}}):_0x2a5d66['status'](0x190)[_0x4baf5f(0x19d)]({'success':![],'message':_0x4baf5f(0x1bb),'result':{'status':_0x4baf5f(0x20b),'failureReason':_0x2711da[_0x4baf5f(0x1ca)],'redirectUrl':_0x29399d[_0x4baf5f(0x1a4)]}});}catch(_0x1d5fb5){_0x27a782(_0x1d5fb5);}},this[_0x2efcc7(0x1d7)]=new testGatewayService_1[(_0x2efcc7(0x1f9))](),this[_0x2efcc7(0x1de)]=new webhookService_1[(_0x2efcc7(0x1e3))]();}async[a15_0xce75c6(0x1dd)](_0x441600,_0x5804af,_0x489e3f,_0x1a0d8f){const _0x24f4e3=a15_0xce75c6,_0x5ca379=Date[_0x24f4e3(0x1c0)]();try{const _0x28bba2=_0x441600[_0x24f4e3(0x1c8)],_0x465aad=_0x28bba2[_0x24f4e3(0x200)];if(!_0x465aad?.[_0x24f4e3(0x1a8)]){console[_0x24f4e3(0x1bd)](_0x24f4e3(0x1bc)+_0x28bba2['id']);return;}const _0x207e2d=_0x5804af==='PAID'?_0x24f4e3(0x1b8):_0x24f4e3(0x1a3);let _0x4e9fa0=[];if(_0x465aad[_0x24f4e3(0x1cc)])try{_0x4e9fa0=Array['isArray'](_0x465aad['webhookEvents'])?_0x465aad[_0x24f4e3(0x1cc)]:JSON['parse'](_0x465aad['webhookEvents']);}catch(_0xf5e8b2){console[_0x24f4e3(0x1d5)](_0x24f4e3(0x199),_0xf5e8b2),_0x4e9fa0=[];}if(!_0x4e9fa0[_0x24f4e3(0x1ac)](_0x207e2d)){console[_0x24f4e3(0x1bd)](_0x24f4e3(0x1cf)+_0x207e2d+_0x24f4e3(0x1e6)+_0x28bba2['id']);return;}const _0x1cd9b9={'event':_0x207e2d,'payment':{'id':_0x441600['id'],'order_id':_0x441600[_0x24f4e3(0x1af)],'gateway_order_id':_0x441600['gatewayOrderId'],'gateway':_0x24f4e3(0x201),'amount':_0x441600['amount'],'currency':_0x441600['currency'],'status':_0x5804af[_0x24f4e3(0x1fd)](),'customer_email':_0x441600['customerEmail'],'customer_name':_0x441600[_0x24f4e3(0x1b4)],'transaction_id':_0x489e3f,'failure_message':_0x1a0d8f,'created_at':_0x441600[_0x24f4e3(0x1be)],'updated_at':new Date()}},_0xfa794f=await fetch(_0x465aad[_0x24f4e3(0x1a8)],{'method':_0x24f4e3(0x1cd),'headers':{'Content-Type':_0x24f4e3(0x1df),'User-Agent':_0x24f4e3(0x1b5)},'body':JSON[_0x24f4e3(0x1f3)](_0x1cd9b9)}),_0x5cb9cd=Date[_0x24f4e3(0x1c0)]()-_0x5ca379;console[_0x24f4e3(0x1bd)](_0x24f4e3(0x1ee)+_0x465aad['webhookUrl']+_0x24f4e3(0x1fe)+_0xfa794f['status']+'\x20('+_0x5cb9cd+'ms)');}catch(_0x327259){console[_0x24f4e3(0x1d5)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x327259);}}async[a15_0xce75c6(0x205)](_0x18a0b9,_0x15eedb){const _0x5800d9=a15_0xce75c6;try{const {telegramBotService:_0x3e22c6}=await Promise['resolve']()[_0x5800d9(0x194)](()=>__importStar(require(_0x5800d9(0x19c)))),_0x519931={'PAID':_0x5800d9(0x19e),'FAILED':'failed'},_0x3b792f=_0x519931[_0x15eedb];if(!_0x3b792f)return;await _0x3e22c6['sendPaymentNotification'](_0x18a0b9['shopId'],_0x18a0b9,_0x3b792f);}catch(_0x1b3cae){console[_0x5800d9(0x1d5)](_0x5800d9(0x1ed),_0x1b3cae);}}}exports[a15_0xce75c6(0x1ab)]=TestGatewayController;