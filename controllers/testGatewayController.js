'use strict';function a19_0x2e13(){const _0x524e48=['Any\x203-4\x20digits','TestGatewayController','call','createdAt','configurable','SINGLE','../services/webhookService','webhookService','üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','Payment\x20failed',':\x20type=','currency','toISOString','processCard','Payment\x20not\x20found','4hhlBba','create','üß™\x20Test\x20Gateway\x20webhook:\x20event=','FAILED','body','hasOwnProperty','‚úÖ\x20Test\x20Gateway\x20payment\x20','‚ùå\x20Payment\x20link\x20','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','getOwnPropertyDescriptor','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','default','0000','now','paymentMethod','üìà\x20Found\x20payment\x20link\x20','currentPayments','paymentLinkId','üß™\x20Webhook\x20payload:','gatewayPaymentId','paymentLink','4177404SsMheH','Error\x20parsing\x20webhook\x20events:','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20with\x20status\x20','\x20processed:\x20','transactionId','ms)','\x20->\x20','üìà\x20Test\x20Gateway:\x20Payment\x20','261712HcKDzL','params','POST','failed','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','Any\x20name','PAID','name','webhookEvents','‚úÖ\x20Payment\x20link\x20','PENDING','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','test_gateway_','../config/database','\x20not\x20enabled\x20for\x20shop\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','test_gateway','error','getOwnPropertyNames','resolve','\x20not\x20found','...',',\x20cannot\x20process','shopId','__importDefault','‚ö†Ô∏è\x20Webhook\x20event\x20','../services/gateways/testGatewayService','gateway','testGatewayService','payment.failed','üß™\x20Sending\x20webhook\x20to\x20','shop','\x20updated:\x20currentPayments=','amount','test_card','findUnique','4242\x204242\x204242\x204242','sendShopWebhook','Payment\x20is\x20not\x20for\x20test\x20gateway','successUrl','445272JAkqwU','Any\x20other\x20card\x20number','207294EKWmCu','paidAt','webhookUrl','status','114257qHeppL','update','payment.success','Any\x20future\x20date\x20(MM/YY)','length','Payment\x20status\x20is\x20','cardLast4','payment','96538bpjCbW','sendPaymentStatusNotification','Payment\x20to\x20','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','defineProperty','paid','json',',\x20status=','gatewayOrderId','28NKOFDG','type','isArray','__setModuleDefault','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','WebhookService','__createBinding','toLowerCase','__esModule','failureReason','$transaction',',\x20webhookUrl=','slice','526945xTrVBS',',\x20currentPayments=','webhookLog','failureMessage','application/json','sendPaymentNotification'];a19_0x2e13=function(){return _0x524e48;};return a19_0x2e13();}const a19_0x3ac650=a19_0x2f6d;function a19_0x2f6d(_0x205674,_0x598aff){_0x205674=_0x205674-0x114;const _0x2e13e1=a19_0x2e13();let _0x2f6d93=_0x2e13e1[_0x205674];return _0x2f6d93;}(function(_0x51ef9f,_0x14535e){const _0x336463=a19_0x2f6d,_0x4b645d=_0x51ef9f();while(!![]){try{const _0x1fb611=-parseInt(_0x336463(0x195))/0x1+-parseInt(_0x336463(0x11b))/0x2+-parseInt(_0x336463(0x18f))/0x3*(parseInt(_0x336463(0x148))/0x4)+-parseInt(_0x336463(0x133))/0x5+parseInt(_0x336463(0x191))/0x6*(parseInt(_0x336463(0x124))/0x7)+-parseInt(_0x336463(0x167))/0x8+parseInt(_0x336463(0x15e))/0x9;if(_0x1fb611===_0x14535e)break;else _0x4b645d['push'](_0x4b645d['shift']());}catch(_0x3113c1){_0x4b645d['push'](_0x4b645d['shift']());}}}(a19_0x2e13,0x256d3));var __createBinding=this&&this[a19_0x3ac650(0x12c)]||(Object['create']?function(_0x1e6d84,_0x31fdae,_0x3ce857,_0x22d6b9){const _0x4dacc7=a19_0x3ac650;if(_0x22d6b9===undefined)_0x22d6b9=_0x3ce857;var _0x34d784=Object[_0x4dacc7(0x151)](_0x31fdae,_0x3ce857);(!_0x34d784||('get'in _0x34d784?!_0x31fdae[_0x4dacc7(0x12e)]:_0x34d784['writable']||_0x34d784[_0x4dacc7(0x13d)]))&&(_0x34d784={'enumerable':!![],'get':function(){return _0x31fdae[_0x3ce857];}}),Object['defineProperty'](_0x1e6d84,_0x22d6b9,_0x34d784);}:function(_0x16145a,_0x179f95,_0x80ec57,_0x2d5fbd){if(_0x2d5fbd===undefined)_0x2d5fbd=_0x80ec57;_0x16145a[_0x2d5fbd]=_0x179f95[_0x80ec57];}),__setModuleDefault=this&&this[a19_0x3ac650(0x127)]||(Object[a19_0x3ac650(0x149)]?function(_0x2c1b7b,_0x341ba1){const _0x154793=a19_0x3ac650;Object[_0x154793(0x11f)](_0x2c1b7b,_0x154793(0x154),{'enumerable':!![],'value':_0x341ba1});}:function(_0x3a0129,_0x555e39){const _0x352d1b=a19_0x3ac650;_0x3a0129[_0x352d1b(0x154)]=_0x555e39;}),__importStar=this&&this['__importStar']||(function(){var _0x59072d=function(_0x59dc54){const _0x3377ed=a19_0x2f6d;return _0x59072d=Object[_0x3377ed(0x179)]||function(_0x10f598){const _0x5521d1=_0x3377ed;var _0xf38d0b=[];for(var _0x378d7d in _0x10f598)if(Object['prototype'][_0x5521d1(0x14d)][_0x5521d1(0x13b)](_0x10f598,_0x378d7d))_0xf38d0b[_0xf38d0b[_0x5521d1(0x117)]]=_0x378d7d;return _0xf38d0b;},_0x59072d(_0x59dc54);};return function(_0x53ae81){const _0x402247=a19_0x2f6d;if(_0x53ae81&&_0x53ae81[_0x402247(0x12e)])return _0x53ae81;var _0x1f856c={};if(_0x53ae81!=null){for(var _0xc48b40=_0x59072d(_0x53ae81),_0x507b80=0x0;_0x507b80<_0xc48b40[_0x402247(0x117)];_0x507b80++)if(_0xc48b40[_0x507b80]!==_0x402247(0x154))__createBinding(_0x1f856c,_0x53ae81,_0xc48b40[_0x507b80]);}return __setModuleDefault(_0x1f856c,_0x53ae81),_0x1f856c;};}()),__importDefault=this&&this[a19_0x3ac650(0x17f)]||function(_0x312723){const _0x3807d0=a19_0x3ac650;return _0x312723&&_0x312723[_0x3807d0(0x12e)]?_0x312723:{'default':_0x312723};};Object[a19_0x3ac650(0x11f)](exports,a19_0x3ac650(0x12e),{'value':!![]}),exports[a19_0x3ac650(0x13a)]=void 0x0;const testGatewayService_1=require(a19_0x3ac650(0x181)),webhookService_1=require(a19_0x3ac650(0x13f)),database_1=__importDefault(require(a19_0x3ac650(0x174)));class TestGatewayController{constructor(){const _0x2c835e=a19_0x3ac650;this['getPaymentForm']=async(_0x161da0,_0x2fd790,_0x5ea0df)=>{const _0x1ecbaf=a19_0x2f6d;try{const {paymentId:_0x48b141}=_0x161da0[_0x1ecbaf(0x168)];console[_0x1ecbaf(0x153)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x48b141);const _0x2a0648=await database_1['default']['payment'][_0x1ecbaf(0x18a)]({'where':{'id':_0x48b141},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2a0648)return _0x2fd790[_0x1ecbaf(0x194)](0x194)[_0x1ecbaf(0x121)]({'success':![],'message':_0x1ecbaf(0x147)});if(_0x2a0648[_0x1ecbaf(0x182)]!==_0x1ecbaf(0x177))return _0x2fd790[_0x1ecbaf(0x194)](0x190)[_0x1ecbaf(0x121)]({'success':![],'message':_0x1ecbaf(0x18d)});if(_0x2a0648[_0x1ecbaf(0x194)]!=='PENDING')return _0x2fd790[_0x1ecbaf(0x194)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2a0648[_0x1ecbaf(0x194)]+_0x1ecbaf(0x17d)});_0x2fd790['json']({'success':!![],'result':{'paymentId':_0x2a0648['id'],'orderId':_0x2a0648['gatewayOrderId'],'amount':_0x2a0648['amount'],'currency':_0x2a0648[_0x1ecbaf(0x144)],'merchantName':_0x2a0648[_0x1ecbaf(0x186)]['name'],'description':_0x1ecbaf(0x11d)+_0x2a0648['shop'][_0x1ecbaf(0x16e)],'testInstructions':{'successCard':_0x1ecbaf(0x18b),'failureCard':_0x1ecbaf(0x190),'expiryDate':_0x1ecbaf(0x116),'cvc':_0x1ecbaf(0x139),'holderName':_0x1ecbaf(0x16c)}}});}catch(_0x226377){_0x5ea0df(_0x226377);}},this[_0x2c835e(0x146)]=async(_0x102ecd,_0x52099f,_0x408b4d)=>{const _0x185d9b=_0x2c835e;try{const {paymentId:_0x1be492}=_0x102ecd['params'],_0x46dcbe=_0x102ecd[_0x185d9b(0x14c)];console[_0x185d9b(0x153)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1be492);const _0x443309=await database_1[_0x185d9b(0x154)]['payment'][_0x185d9b(0x18a)]({'where':{'id':_0x1be492},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x443309)return _0x52099f[_0x185d9b(0x194)](0x194)[_0x185d9b(0x121)]({'success':![],'message':_0x185d9b(0x147)});if(_0x443309[_0x185d9b(0x182)]!==_0x185d9b(0x177))return _0x52099f[_0x185d9b(0x194)](0x190)[_0x185d9b(0x121)]({'success':![],'message':_0x185d9b(0x18d)});if(_0x443309['status']!==_0x185d9b(0x171))return _0x52099f[_0x185d9b(0x194)](0x190)['json']({'success':![],'message':_0x185d9b(0x118)+_0x443309[_0x185d9b(0x194)]+_0x185d9b(0x17d)});const _0x1e3681=await this[_0x185d9b(0x183)]['processCardPayment']({'paymentId':_0x443309['id'],'orderId':_0x443309[_0x185d9b(0x123)]||_0x443309['id'],'amount':_0x443309[_0x185d9b(0x188)],'currency':_0x443309[_0x185d9b(0x144)],'cardData':_0x46dcbe});console[_0x185d9b(0x153)]('üß™\x20Test\x20Gateway\x20result:',_0x1e3681);const _0x2960ee={'status':_0x1e3681['status'],'updatedAt':new Date()};if(_0x1e3681[_0x185d9b(0x194)]===_0x185d9b(0x16d))_0x2960ee[_0x185d9b(0x192)]=new Date(),_0x2960ee[_0x185d9b(0x15c)]=_0x1e3681[_0x185d9b(0x163)];else _0x1e3681[_0x185d9b(0x194)]==='FAILED'&&(_0x2960ee[_0x185d9b(0x136)]=_0x1e3681[_0x185d9b(0x12f)]);const _0x549421=_0x46dcbe['cardNumber']['replace'](/[\s-]/g,'');_0x2960ee[_0x185d9b(0x119)]=_0x549421[_0x185d9b(0x132)](-0x4),_0x2960ee[_0x185d9b(0x157)]=_0x185d9b(0x189),await database_1[_0x185d9b(0x154)][_0x185d9b(0x11a)][_0x185d9b(0x114)]({'where':{'id':_0x443309['id']},'data':_0x2960ee});if(_0x1e3681['status']==='PAID'&&_0x443309[_0x185d9b(0x15a)]){console[_0x185d9b(0x153)](_0x185d9b(0x166)+_0x443309['id']+_0x185d9b(0x176));try{await database_1[_0x185d9b(0x154)][_0x185d9b(0x130)](async _0x365116=>{const _0x3173e0=_0x185d9b,_0x4dade5=await _0x365116[_0x3173e0(0x15d)]['findUnique']({'where':{'id':_0x443309['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4dade5){console[_0x3173e0(0x153)](_0x3173e0(0x158)+_0x4dade5['id']+_0x3173e0(0x143)+_0x4dade5[_0x3173e0(0x125)]+_0x3173e0(0x134)+_0x4dade5['currentPayments']+_0x3173e0(0x122)+_0x4dade5[_0x3173e0(0x194)]);const _0x234761=_0x4dade5['currentPayments']+0x1,_0x49c5f6=_0x4dade5[_0x3173e0(0x125)]===_0x3173e0(0x13e)?'COMPLETED':_0x4dade5[_0x3173e0(0x194)];await _0x365116['paymentLink'][_0x3173e0(0x114)]({'where':{'id':_0x443309[_0x3173e0(0x15a)]},'data':{'currentPayments':_0x234761,'status':_0x49c5f6,'updatedAt':new Date()}}),console[_0x3173e0(0x153)](_0x3173e0(0x170)+_0x4dade5['id']+_0x3173e0(0x187)+_0x4dade5[_0x3173e0(0x159)]+_0x3173e0(0x165)+_0x234761+_0x3173e0(0x122)+_0x4dade5[_0x3173e0(0x194)]+'\x20->\x20'+_0x49c5f6);}else console[_0x3173e0(0x153)](_0x3173e0(0x14f)+_0x443309[_0x3173e0(0x15a)]+_0x3173e0(0x17b));});}catch(_0x1adc32){console[_0x185d9b(0x178)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x1adc32);}}await database_1[_0x185d9b(0x154)][_0x185d9b(0x135)][_0x185d9b(0x149)]({'data':{'paymentId':_0x443309['id'],'shopId':_0x443309['shopId'],'event':_0x185d9b(0x173)+_0x1e3681[_0x185d9b(0x194)][_0x185d9b(0x12d)](),'statusCode':_0x1e3681[_0x185d9b(0x194)]===_0x185d9b(0x16d)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':_0x185d9b(0x171),'newStatus':_0x1e3681[_0x185d9b(0x194)],'transactionId':_0x1e3681[_0x185d9b(0x163)],'failureReason':_0x1e3681[_0x185d9b(0x12f)],'processedAt':new Date()[_0x185d9b(0x145)]()})}}),console['log'](_0x185d9b(0x16b)+_0x1e3681[_0x185d9b(0x194)]+_0x185d9b(0x17c)),await this['sendShopWebhook'](_0x443309,_0x1e3681[_0x185d9b(0x194)],_0x1e3681[_0x185d9b(0x163)],_0x1e3681[_0x185d9b(0x12f)]),console[_0x185d9b(0x153)](_0x185d9b(0x128)+_0x1e3681[_0x185d9b(0x194)]),console['log'](_0x185d9b(0x141)+_0x1e3681['status']+'...'),await this[_0x185d9b(0x11c)](_0x443309,_0x1e3681[_0x185d9b(0x194)]),console[_0x185d9b(0x153)](_0x185d9b(0x11e)+_0x1e3681[_0x185d9b(0x194)]),console[_0x185d9b(0x153)](_0x185d9b(0x14e)+_0x1be492+_0x185d9b(0x162)+_0x1e3681['status']),_0x1e3681[_0x185d9b(0x194)]===_0x185d9b(0x16d)?_0x52099f[_0x185d9b(0x121)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x185d9b(0x16d),'transactionId':_0x1e3681['transactionId'],'redirectUrl':_0x443309[_0x185d9b(0x18e)]}}):_0x52099f[_0x185d9b(0x194)](0x190)[_0x185d9b(0x121)]({'success':![],'message':_0x185d9b(0x142),'result':{'status':_0x185d9b(0x14b),'failureReason':_0x1e3681[_0x185d9b(0x12f)],'redirectUrl':_0x443309['failUrl']}});}catch(_0x3dff1e){_0x408b4d(_0x3dff1e);}},this[_0x2c835e(0x183)]=new testGatewayService_1['TestGatewayService'](),this[_0x2c835e(0x140)]=new webhookService_1[(_0x2c835e(0x12b))]();}async[a19_0x3ac650(0x18c)](_0x5615b6,_0x273656,_0x323fee,_0x3fd186){const _0x4e1fa5=a19_0x3ac650,_0x1cb783=Date[_0x4e1fa5(0x156)]();try{const _0xf53510=_0x5615b6[_0x4e1fa5(0x186)],_0x3587ea=_0xf53510['settings'];if(!_0x3587ea?.['webhookUrl']){console[_0x4e1fa5(0x153)](_0x4e1fa5(0x172)+_0xf53510['id']);return;}const _0x576073=_0x273656===_0x4e1fa5(0x16d)?_0x4e1fa5(0x115):_0x4e1fa5(0x184);console[_0x4e1fa5(0x153)](_0x4e1fa5(0x14a)+_0x576073+_0x4e1fa5(0x131)+(_0x3587ea[_0x4e1fa5(0x193)]?'configured':'not\x20configured'));let _0x85d2d8=[];if(_0x3587ea['webhookEvents'])try{_0x85d2d8=Array[_0x4e1fa5(0x126)](_0x3587ea['webhookEvents'])?_0x3587ea[_0x4e1fa5(0x16f)]:JSON['parse'](_0x3587ea[_0x4e1fa5(0x16f)]);}catch(_0x3f8113){console[_0x4e1fa5(0x178)](_0x4e1fa5(0x15f),_0x3f8113),_0x85d2d8=[];}console[_0x4e1fa5(0x153)](_0x4e1fa5(0x150),_0x85d2d8);if(!_0x85d2d8['includes'](_0x576073)){console[_0x4e1fa5(0x153)](_0x4e1fa5(0x180)+_0x576073+_0x4e1fa5(0x175)+_0xf53510['id']);return;}const _0x130492={'event':_0x576073,'payment':{'id':_0x5615b6['id'],'order_id':_0x5615b6['orderId'],'gateway_order_id':_0x5615b6[_0x4e1fa5(0x123)],'gateway':_0x4e1fa5(0x155),'amount':_0x5615b6[_0x4e1fa5(0x188)],'currency':_0x5615b6['currency'],'status':_0x273656['toLowerCase'](),'customer_email':_0x5615b6['customerEmail'],'customer_name':_0x5615b6['customerName'],'transaction_id':_0x323fee,'failure_message':_0x3fd186,'created_at':_0x5615b6[_0x4e1fa5(0x13c)],'updated_at':new Date()}};console[_0x4e1fa5(0x153)](_0x4e1fa5(0x185)+_0x3587ea['webhookUrl']+_0x4e1fa5(0x17c)),console[_0x4e1fa5(0x153)](_0x4e1fa5(0x15b),JSON['stringify'](_0x130492,null,0x2));const _0x2cdbd1=await fetch(_0x3587ea[_0x4e1fa5(0x193)],{'method':_0x4e1fa5(0x169),'headers':{'Content-Type':_0x4e1fa5(0x137),'User-Agent':_0x4e1fa5(0x12a)},'body':JSON['stringify'](_0x130492)}),_0x13fd1d=Date[_0x4e1fa5(0x156)]()-_0x1cb783;console['log'](_0x4e1fa5(0x129)+_0x3587ea[_0x4e1fa5(0x193)]+_0x4e1fa5(0x161)+_0x2cdbd1['status']+'\x20('+_0x13fd1d+_0x4e1fa5(0x164));}catch(_0x4a296d){console[_0x4e1fa5(0x178)](_0x4e1fa5(0x160),_0x4a296d);}}async[a19_0x3ac650(0x11c)](_0x5c530b,_0x48060a){const _0x3fb45e=a19_0x3ac650;try{const {telegramBotService:_0x355a56}=await Promise[_0x3fb45e(0x17a)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0xdbc37a={'PAID':_0x3fb45e(0x120),'FAILED':_0x3fb45e(0x16a)},_0x9bf4cd=_0xdbc37a[_0x48060a];if(!_0x9bf4cd)return;await _0x355a56[_0x3fb45e(0x138)](_0x5c530b[_0x3fb45e(0x17e)],_0x5c530b,_0x9bf4cd);}catch(_0x3b69b0){console[_0x3fb45e(0x178)](_0x3fb45e(0x152),_0x3b69b0);}}}exports[a19_0x3ac650(0x13a)]=TestGatewayController;