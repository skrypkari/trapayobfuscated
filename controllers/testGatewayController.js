'use strict';function a15_0x4236(_0x57a450,_0x478974){const _0x1ca730=a15_0x1ca7();return a15_0x4236=function(_0x42366e,_0x129cda){_0x42366e=_0x42366e-0xda;let _0x51ee0d=_0x1ca730[_0x42366e];return _0x51ee0d;},a15_0x4236(_0x57a450,_0x478974);}const a15_0x23a558=a15_0x4236;(function(_0x27ea67,_0x118b66){const _0x3d99c1=a15_0x4236,_0x572c06=_0x27ea67();while(!![]){try{const _0x2844bd=parseInt(_0x3d99c1(0xdf))/0x1+-parseInt(_0x3d99c1(0x114))/0x2+parseInt(_0x3d99c1(0x117))/0x3+-parseInt(_0x3d99c1(0xfd))/0x4+-parseInt(_0x3d99c1(0x128))/0x5*(-parseInt(_0x3d99c1(0x150))/0x6)+parseInt(_0x3d99c1(0xda))/0x7*(-parseInt(_0x3d99c1(0x12f))/0x8)+parseInt(_0x3d99c1(0xe1))/0x9*(-parseInt(_0x3d99c1(0x121))/0xa);if(_0x2844bd===_0x118b66)break;else _0x572c06['push'](_0x572c06['shift']());}catch(_0x1ed757){_0x572c06['push'](_0x572c06['shift']());}}}(a15_0x1ca7,0x2b63e));var __createBinding=this&&this[a15_0x23a558(0xef)]||(Object[a15_0x23a558(0x13c)]?function(_0x3c4c3a,_0x274f67,_0x2bc355,_0x34dbcd){const _0x36e7a9=a15_0x23a558;if(_0x34dbcd===undefined)_0x34dbcd=_0x2bc355;var _0x30d2aa=Object[_0x36e7a9(0x155)](_0x274f67,_0x2bc355);(!_0x30d2aa||(_0x36e7a9(0x110)in _0x30d2aa?!_0x274f67[_0x36e7a9(0x12a)]:_0x30d2aa[_0x36e7a9(0xf3)]||_0x30d2aa['configurable']))&&(_0x30d2aa={'enumerable':!![],'get':function(){return _0x274f67[_0x2bc355];}}),Object['defineProperty'](_0x3c4c3a,_0x34dbcd,_0x30d2aa);}:function(_0x5a9d40,_0x25495b,_0x3d4c2b,_0x112c4a){if(_0x112c4a===undefined)_0x112c4a=_0x3d4c2b;_0x5a9d40[_0x112c4a]=_0x25495b[_0x3d4c2b];}),__setModuleDefault=this&&this[a15_0x23a558(0x113)]||(Object[a15_0x23a558(0x13c)]?function(_0x5d7424,_0xa410bc){const _0x3e8424=a15_0x23a558;Object[_0x3e8424(0x125)](_0x5d7424,_0x3e8424(0x10d),{'enumerable':!![],'value':_0xa410bc});}:function(_0x381f18,_0xbc3171){const _0x29c6a9=a15_0x23a558;_0x381f18[_0x29c6a9(0x10d)]=_0xbc3171;}),__importStar=this&&this['__importStar']||(function(){var _0x2d7339=function(_0x6da10a){const _0xc2c7ba=a15_0x4236;return _0x2d7339=Object[_0xc2c7ba(0x129)]||function(_0x144191){const _0x1ed754=_0xc2c7ba;var _0x29bc11=[];for(var _0x5aa535 in _0x144191)if(Object[_0x1ed754(0x109)][_0x1ed754(0x100)][_0x1ed754(0x11b)](_0x144191,_0x5aa535))_0x29bc11[_0x29bc11['length']]=_0x5aa535;return _0x29bc11;},_0x2d7339(_0x6da10a);};return function(_0x1e7f30){const _0x32def9=a15_0x4236;if(_0x1e7f30&&_0x1e7f30[_0x32def9(0x12a)])return _0x1e7f30;var _0x1a4c16={};if(_0x1e7f30!=null){for(var _0x1c886c=_0x2d7339(_0x1e7f30),_0x14dbca=0x0;_0x14dbca<_0x1c886c['length'];_0x14dbca++)if(_0x1c886c[_0x14dbca]!==_0x32def9(0x10d))__createBinding(_0x1a4c16,_0x1e7f30,_0x1c886c[_0x14dbca]);}return __setModuleDefault(_0x1a4c16,_0x1e7f30),_0x1a4c16;};}()),__importDefault=this&&this[a15_0x23a558(0xde)]||function(_0x52039d){const _0x17f984=a15_0x23a558;return _0x52039d&&_0x52039d[_0x17f984(0x12a)]?_0x52039d:{'default':_0x52039d};};function a15_0x1ca7(){const _0x21c5e7=['toLowerCase','shopId','testGatewayService','__importDefault','93509UlEEtY','params','750645asARXo','../services/gateways/testGatewayService','error','PENDING','status','✅\x20Test\x20Gateway\x20payment\x20','FAILED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','orderId','toISOString','$transaction','parse','webhookEvents','application/json','__createBinding',':\x20type=','\x20processed:\x20','json','writable','findUnique','TestGatewayController','processCardPayment','getPaymentForm','amount','Payment\x20status\x20is\x20','📈\x20Found\x20payment\x20link\x20','Webhook\x20event\x20','POST','823684JuObiT','ms)',',\x20status=','hasOwnProperty','Payment\x20is\x20not\x20for\x20test\x20gateway','processCard','test_gateway','webhookLog','sendPaymentNotification','customerEmail','sendPaymentStatusNotification','\x20updated:\x20currentPayments=','prototype','gatewayPaymentId','test_card','Any\x20other\x20card\x20number','default','cardLast4','../services/webhookService','get','currentPayments','0000','__setModuleDefault','17002vEBdQi','COMPLETED','paymentLink','897918QpVFnK','payment.success','Payment\x20failed',',\x20cannot\x20process','call','name','\x20not\x20enabled\x20for\x20shop\x20','paid','🧪\x20Test\x20Gateway\x20result:','webhookService','10WQKQPu','SINGLE','webhookUrl','shop','defineProperty','test_gateway_','\x20->\x20','709165BGMeEt','getOwnPropertyNames','__esModule','✅\x20Payment\x20link\x20','resolve','then','📈\x20Test\x20Gateway:\x20Payment\x20','1104gIdOgX','Error\x20parsing\x20webhook\x20events:','gateway','successUrl','Payment\x20System/1.0\x20(Test\x20Gateway)','Test\x20Gateway\x20webhook\x20sent\x20to\x20','replace','customerName','failUrl','update','paidAt','paymentLinkId','currency','create','WebhookService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','❌\x20Payment\x20link\x20','4242\x204242\x204242\x204242','type','Any\x20future\x20date\x20(MM/YY)','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Payment\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','transactionId','../config/database','cardNumber','slice','\x20not\x20found','PAID','gatewayOrderId','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','includes','TestGatewayService','12cXmJow','log','failureReason','payment','Payment\x20processed\x20successfully','getOwnPropertyDescriptor','Payment\x20not\x20found','10192XlhbZp'];a15_0x1ca7=function(){return _0x21c5e7;};return a15_0x1ca7();}Object[a15_0x23a558(0x125)](exports,a15_0x23a558(0x12a),{'value':!![]}),exports[a15_0x23a558(0xf5)]=void 0x0;const testGatewayService_1=require(a15_0x23a558(0xe2)),webhookService_1=require(a15_0x23a558(0x10f)),database_1=__importDefault(require(a15_0x23a558(0x147)));class TestGatewayController{constructor(){const _0x4bd4ad=a15_0x23a558;this[_0x4bd4ad(0xf7)]=async(_0xbc2bc8,_0x4185b7,_0x29e50f)=>{const _0x47b642=_0x4bd4ad;try{const {paymentId:_0x4cfcbf}=_0xbc2bc8[_0x47b642(0xe0)];console[_0x47b642(0x151)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4cfcbf);const _0x3c5d72=await database_1['default'][_0x47b642(0x153)][_0x47b642(0xf4)]({'where':{'id':_0x4cfcbf},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3c5d72)return _0x4185b7[_0x47b642(0xe5)](0x194)[_0x47b642(0xf2)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3c5d72[_0x47b642(0x131)]!==_0x47b642(0x103))return _0x4185b7['status'](0x190)[_0x47b642(0xf2)]({'success':![],'message':_0x47b642(0x101)});if(_0x3c5d72['status']!=='PENDING')return _0x4185b7[_0x47b642(0xe5)](0x190)[_0x47b642(0xf2)]({'success':![],'message':_0x47b642(0xf9)+_0x3c5d72[_0x47b642(0xe5)]+_0x47b642(0x11a)});_0x4185b7[_0x47b642(0xf2)]({'success':!![],'result':{'paymentId':_0x3c5d72['id'],'orderId':_0x3c5d72[_0x47b642(0x14c)],'amount':_0x3c5d72[_0x47b642(0xf8)],'currency':_0x3c5d72[_0x47b642(0x13b)],'merchantName':_0x3c5d72[_0x47b642(0x124)][_0x47b642(0x11c)],'description':_0x47b642(0x144)+_0x3c5d72['shop'][_0x47b642(0x11c)],'testInstructions':{'successCard':_0x47b642(0x140),'failureCard':_0x47b642(0x10c),'expiryDate':_0x47b642(0x142),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x1860f4){_0x29e50f(_0x1860f4);}},this[_0x4bd4ad(0x102)]=async(_0x3aea73,_0x57e48e,_0x51f2f0)=>{const _0x1d041a=_0x4bd4ad;try{const {paymentId:_0x356a16}=_0x3aea73[_0x1d041a(0xe0)],_0x2ebfe7=_0x3aea73['body'];console[_0x1d041a(0x151)](_0x1d041a(0x14d)+_0x356a16);const _0xbbc3ec=await database_1[_0x1d041a(0x10d)]['payment'][_0x1d041a(0xf4)]({'where':{'id':_0x356a16},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xbbc3ec)return _0x57e48e[_0x1d041a(0xe5)](0x194)[_0x1d041a(0xf2)]({'success':![],'message':_0x1d041a(0x156)});if(_0xbbc3ec[_0x1d041a(0x131)]!==_0x1d041a(0x103))return _0x57e48e[_0x1d041a(0xe5)](0x190)[_0x1d041a(0xf2)]({'success':![],'message':_0x1d041a(0x101)});if(_0xbbc3ec[_0x1d041a(0xe5)]!==_0x1d041a(0xe4))return _0x57e48e[_0x1d041a(0xe5)](0x190)[_0x1d041a(0xf2)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0xbbc3ec[_0x1d041a(0xe5)]+_0x1d041a(0x11a)});const _0x1a6680=await this[_0x1d041a(0xdd)][_0x1d041a(0xf6)]({'paymentId':_0xbbc3ec['id'],'orderId':_0xbbc3ec[_0x1d041a(0x14c)]||_0xbbc3ec['id'],'amount':_0xbbc3ec[_0x1d041a(0xf8)],'currency':_0xbbc3ec[_0x1d041a(0x13b)],'cardData':_0x2ebfe7});console[_0x1d041a(0x151)](_0x1d041a(0x11f),_0x1a6680);const _0x4dcde7={'status':_0x1a6680['status'],'updatedAt':new Date()};if(_0x1a6680['status']==='PAID')_0x4dcde7[_0x1d041a(0x139)]=new Date(),_0x4dcde7[_0x1d041a(0x10a)]=_0x1a6680[_0x1d041a(0x146)];else _0x1a6680[_0x1d041a(0xe5)]===_0x1d041a(0xe7)&&(_0x4dcde7['failureMessage']=_0x1a6680['failureReason']);const _0x160085=_0x2ebfe7[_0x1d041a(0x148)][_0x1d041a(0x135)](/[\s-]/g,'');_0x4dcde7[_0x1d041a(0x10e)]=_0x160085[_0x1d041a(0x149)](-0x4),_0x4dcde7['paymentMethod']=_0x1d041a(0x10b),await database_1[_0x1d041a(0x10d)][_0x1d041a(0x153)][_0x1d041a(0x138)]({'where':{'id':_0xbbc3ec['id']},'data':_0x4dcde7});if(_0x1a6680['status']===_0x1d041a(0x14b)&&_0xbbc3ec[_0x1d041a(0x13a)]){console['log'](_0x1d041a(0x12e)+_0xbbc3ec['id']+_0x1d041a(0x143));try{await database_1['default'][_0x1d041a(0xeb)](async _0x5520d5=>{const _0xce3ff5=_0x1d041a,_0x6b3ed9=await _0x5520d5[_0xce3ff5(0x116)]['findUnique']({'where':{'id':_0xbbc3ec[_0xce3ff5(0x13a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x6b3ed9){console[_0xce3ff5(0x151)](_0xce3ff5(0xfa)+_0x6b3ed9['id']+_0xce3ff5(0xf0)+_0x6b3ed9[_0xce3ff5(0x141)]+',\x20currentPayments='+_0x6b3ed9[_0xce3ff5(0x111)]+_0xce3ff5(0xff)+_0x6b3ed9[_0xce3ff5(0xe5)]);const _0x165fe3=_0x6b3ed9[_0xce3ff5(0x111)]+0x1,_0x4ff185=_0x6b3ed9[_0xce3ff5(0x141)]===_0xce3ff5(0x122)?_0xce3ff5(0x115):_0x6b3ed9[_0xce3ff5(0xe5)];await _0x5520d5[_0xce3ff5(0x116)][_0xce3ff5(0x138)]({'where':{'id':_0xbbc3ec[_0xce3ff5(0x13a)]},'data':{'currentPayments':_0x165fe3,'status':_0x4ff185,'updatedAt':new Date()}}),console[_0xce3ff5(0x151)](_0xce3ff5(0x12b)+_0x6b3ed9['id']+_0xce3ff5(0x108)+_0x6b3ed9[_0xce3ff5(0x111)]+_0xce3ff5(0x127)+_0x165fe3+_0xce3ff5(0xff)+_0x6b3ed9['status']+_0xce3ff5(0x127)+_0x4ff185);}else console[_0xce3ff5(0x151)](_0xce3ff5(0x13f)+_0xbbc3ec[_0xce3ff5(0x13a)]+_0xce3ff5(0x14a));});}catch(_0x2b95cf){console[_0x1d041a(0xe3)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x2b95cf);}}await database_1[_0x1d041a(0x10d)][_0x1d041a(0x104)][_0x1d041a(0x13c)]({'data':{'paymentId':_0xbbc3ec['id'],'shopId':_0xbbc3ec['shopId'],'event':_0x1d041a(0x126)+_0x1a6680['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1d041a(0xe4),'newStatus':_0x1a6680[_0x1d041a(0xe5)],'transactionId':_0x1a6680[_0x1d041a(0x146)],'failureReason':_0x1a6680['failureReason'],'processedAt':new Date()[_0x1d041a(0xea)]()})}}),await this['sendShopWebhook'](_0xbbc3ec,_0x1a6680[_0x1d041a(0xe5)],_0x1a6680[_0x1d041a(0x146)],_0x1a6680['failureReason']),await this[_0x1d041a(0x107)](_0xbbc3ec,_0x1a6680[_0x1d041a(0xe5)]),console['log'](_0x1d041a(0xe6)+_0x356a16+_0x1d041a(0xf1)+_0x1a6680['status']),_0x1a6680[_0x1d041a(0xe5)]==='PAID'?_0x57e48e[_0x1d041a(0xf2)]({'success':!![],'message':_0x1d041a(0x154),'result':{'status':_0x1d041a(0x14b),'transactionId':_0x1a6680[_0x1d041a(0x146)],'redirectUrl':_0xbbc3ec[_0x1d041a(0x132)]}}):_0x57e48e[_0x1d041a(0xe5)](0x190)[_0x1d041a(0xf2)]({'success':![],'message':_0x1d041a(0x119),'result':{'status':_0x1d041a(0xe7),'failureReason':_0x1a6680[_0x1d041a(0x152)],'redirectUrl':_0xbbc3ec[_0x1d041a(0x137)]}});}catch(_0x211c8c){_0x51f2f0(_0x211c8c);}},this[_0x4bd4ad(0xdd)]=new testGatewayService_1[(_0x4bd4ad(0x14f))](),this[_0x4bd4ad(0x120)]=new webhookService_1[(_0x4bd4ad(0x13d))]();}async['sendShopWebhook'](_0x546c94,_0x43c2ba,_0x41d51a,_0x599cff){const _0x25d462=a15_0x23a558,_0x45783b=Date['now']();try{const _0x121f87=_0x546c94[_0x25d462(0x124)],_0xcd8129=_0x121f87['settings'];if(!_0xcd8129?.['webhookUrl']){console[_0x25d462(0x151)](_0x25d462(0xe8)+_0x121f87['id']);return;}const _0x4e0db8=_0x43c2ba===_0x25d462(0x14b)?_0x25d462(0x118):'payment.failed';let _0x298700=[];if(_0xcd8129[_0x25d462(0xed)])try{_0x298700=Array['isArray'](_0xcd8129[_0x25d462(0xed)])?_0xcd8129[_0x25d462(0xed)]:JSON[_0x25d462(0xec)](_0xcd8129[_0x25d462(0xed)]);}catch(_0x2fe837){console[_0x25d462(0xe3)](_0x25d462(0x130),_0x2fe837),_0x298700=[];}if(!_0x298700[_0x25d462(0x14e)](_0x4e0db8)){console[_0x25d462(0x151)](_0x25d462(0xfb)+_0x4e0db8+_0x25d462(0x11d)+_0x121f87['id']);return;}const _0x17cba4={'event':_0x4e0db8,'payment':{'id':_0x546c94['id'],'order_id':_0x546c94[_0x25d462(0xe9)],'gateway_order_id':_0x546c94[_0x25d462(0x14c)],'gateway':_0x25d462(0x112),'amount':_0x546c94[_0x25d462(0xf8)],'currency':_0x546c94[_0x25d462(0x13b)],'status':_0x43c2ba[_0x25d462(0xdb)](),'customer_email':_0x546c94[_0x25d462(0x106)],'customer_name':_0x546c94[_0x25d462(0x136)],'transaction_id':_0x41d51a,'failure_message':_0x599cff,'created_at':_0x546c94['createdAt'],'updated_at':new Date()}},_0x12a7f9=await fetch(_0xcd8129[_0x25d462(0x123)],{'method':_0x25d462(0xfc),'headers':{'Content-Type':_0x25d462(0xee),'User-Agent':_0x25d462(0x133)},'body':JSON['stringify'](_0x17cba4)}),_0xbb1682=Date['now']()-_0x45783b;console[_0x25d462(0x151)](_0x25d462(0x134)+_0xcd8129[_0x25d462(0x123)]+'\x20with\x20status\x20'+_0x12a7f9[_0x25d462(0xe5)]+'\x20('+_0xbb1682+_0x25d462(0xfe));}catch(_0x57e697){console[_0x25d462(0xe3)](_0x25d462(0x13e),_0x57e697);}}async['sendPaymentStatusNotification'](_0x12d20d,_0x4f9d19){const _0x4ff1af=a15_0x23a558;try{const {telegramBotService:_0x458e8a}=await Promise[_0x4ff1af(0x12c)]()[_0x4ff1af(0x12d)](()=>__importStar(require('../services/telegramBotService'))),_0x28e198={'PAID':_0x4ff1af(0x11e),'FAILED':'failed'},_0x3790cf=_0x28e198[_0x4f9d19];if(!_0x3790cf)return;await _0x458e8a[_0x4ff1af(0x105)](_0x12d20d[_0x4ff1af(0xdc)],_0x12d20d,_0x3790cf);}catch(_0x3a2cfb){console['error'](_0x4ff1af(0x145),_0x3a2cfb);}}}exports[a15_0x23a558(0xf5)]=TestGatewayController;