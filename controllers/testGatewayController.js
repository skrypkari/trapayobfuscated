'use strict';const a13_0x568638=a13_0x53be;function a13_0x1d52(){const _0x26d024=['currency','getPaymentForm','paymentLinkId','SINGLE','üìà\x20Found\x20payment\x20link\x20','7004808pCWsLD','params','now',',\x20status=','writable','call','\x20->\x20','payment','amount','findUnique','createdAt','application/json','orderId','\x20not\x20enabled\x20for\x20shop\x20','webhookService',',\x20cannot\x20process','TestGatewayService','2676375pDFyeO','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','../services/gateways/testGatewayService','failureReason','customerEmail','Payment\x20status\x20is\x20','cardLast4','defineProperty','PAID','Any\x20other\x20card\x20number','failed','__createBinding','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Payment\x20failed','error','type','5511548uxTpsw','sendShopWebhook','Any\x20name','slice','gateway','hasOwnProperty','$transaction','shop','paymentLink','processCard','paid','4242\x204242\x204242\x204242','FAILED','WebhookService','Any\x20future\x20date\x20(MM/YY)','replace','Payment\x20not\x20found','body','TestGatewayController','currentPayments','19164fFarbj','Webhook\x20event\x20','COMPLETED','toLowerCase','gatewayOrderId','default','1531088VPAmKI','‚ùå\x20Payment\x20link\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','test_card','\x20with\x20status\x20','Any\x203-4\x20digits','__esModule','1732128iYgjLy','create','sendPaymentStatusNotification','payment.success','test_gateway','length','log','../config/database','transactionId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','PENDING','parse','customerName','getOwnPropertyDescriptor','POST','stringify','Error\x20parsing\x20webhook\x20events:','webhookUrl','cardNumber','failUrl','json','processCardPayment','0000','350RfuJxR','then','payment.failed','shopId','update','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','üìà\x20Test\x20Gateway:\x20Payment\x20','webhookEvents','successUrl','ms)','../services/telegramBotService','configurable','status','getOwnPropertyNames','4190646biCeSJ','prototype','testGatewayService','name','__importStar','__importDefault','get','settings'];a13_0x1d52=function(){return _0x26d024;};return a13_0x1d52();}(function(_0x514585,_0x4f4028){const _0x458eef=a13_0x53be,_0x27bc53=_0x514585();while(!![]){try{const _0x3f9a52=-parseInt(_0x458eef(0x1a9))/0x1+-parseInt(_0x458eef(0x1c7))/0x2*(parseInt(_0x458eef(0x1a3))/0x3)+parseInt(_0x458eef(0x16d))/0x4+parseInt(_0x458eef(0x17e))/0x5+parseInt(_0x458eef(0x160))/0x6+parseInt(_0x458eef(0x18f))/0x7+-parseInt(_0x458eef(0x1b0))/0x8;if(_0x3f9a52===_0x4f4028)break;else _0x27bc53['push'](_0x27bc53['shift']());}catch(_0x429bb0){_0x27bc53['push'](_0x27bc53['shift']());}}}(a13_0x1d52,0xdd61a));function a13_0x53be(_0x23cf11,_0x50af42){const _0x1d5237=a13_0x1d52();return a13_0x53be=function(_0x53be5f,_0x61ef08){_0x53be5f=_0x53be5f-0x152;let _0x1c22d1=_0x1d5237[_0x53be5f];return _0x1c22d1;},a13_0x53be(_0x23cf11,_0x50af42);}var __createBinding=this&&this[a13_0x568638(0x18a)]||(Object[a13_0x568638(0x1b1)]?function(_0x5575ab,_0x2b1a09,_0xc232e2,_0x2e7342){const _0x165191=a13_0x568638;if(_0x2e7342===undefined)_0x2e7342=_0xc232e2;var _0x22128f=Object[_0x165191(0x1bd)](_0x2b1a09,_0xc232e2);(!_0x22128f||(_0x165191(0x166)in _0x22128f?!_0x2b1a09[_0x165191(0x1af)]:_0x22128f[_0x165191(0x171)]||_0x22128f[_0x165191(0x15d)]))&&(_0x22128f={'enumerable':!![],'get':function(){return _0x2b1a09[_0xc232e2];}}),Object[_0x165191(0x186)](_0x5575ab,_0x2e7342,_0x22128f);}:function(_0x16d5fc,_0x5ef91c,_0xdede16,_0x3810ab){if(_0x3810ab===undefined)_0x3810ab=_0xdede16;_0x16d5fc[_0x3810ab]=_0x5ef91c[_0xdede16];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x568638(0x1b1)]?function(_0x524bfd,_0x58519b){const _0x29e607=a13_0x568638;Object[_0x29e607(0x186)](_0x524bfd,_0x29e607(0x1a8),{'enumerable':!![],'value':_0x58519b});}:function(_0x294c87,_0x8151eb){const _0xae96cf=a13_0x568638;_0x294c87[_0xae96cf(0x1a8)]=_0x8151eb;}),__importStar=this&&this[a13_0x568638(0x164)]||(function(){var _0x325be5=function(_0x8ca68d){const _0x564e79=a13_0x53be;return _0x325be5=Object[_0x564e79(0x15f)]||function(_0x58c01f){const _0x44830e=_0x564e79;var _0x39b239=[];for(var _0x305456 in _0x58c01f)if(Object[_0x44830e(0x161)][_0x44830e(0x194)][_0x44830e(0x172)](_0x58c01f,_0x305456))_0x39b239[_0x39b239[_0x44830e(0x1b5)]]=_0x305456;return _0x39b239;},_0x325be5(_0x8ca68d);};return function(_0x228dbd){const _0x21986e=a13_0x53be;if(_0x228dbd&&_0x228dbd[_0x21986e(0x1af)])return _0x228dbd;var _0x3f0ff8={};if(_0x228dbd!=null){for(var _0x3fc566=_0x325be5(_0x228dbd),_0x2c9f2e=0x0;_0x2c9f2e<_0x3fc566[_0x21986e(0x1b5)];_0x2c9f2e++)if(_0x3fc566[_0x2c9f2e]!==_0x21986e(0x1a8))__createBinding(_0x3f0ff8,_0x228dbd,_0x3fc566[_0x2c9f2e]);}return __setModuleDefault(_0x3f0ff8,_0x228dbd),_0x3f0ff8;};}()),__importDefault=this&&this[a13_0x568638(0x165)]||function(_0x51e877){return _0x51e877&&_0x51e877['__esModule']?_0x51e877:{'default':_0x51e877};};Object[a13_0x568638(0x186)](exports,'__esModule',{'value':!![]}),exports[a13_0x568638(0x1a1)]=void 0x0;const testGatewayService_1=require(a13_0x568638(0x181)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x568638(0x1b7)));class TestGatewayController{constructor(){const _0x370e7a=a13_0x568638;this[_0x370e7a(0x169)]=async(_0x183850,_0x7be4e3,_0x59df85)=>{const _0x353b42=_0x370e7a;try{const {paymentId:_0x2234cd}=_0x183850['params'];console[_0x353b42(0x1b6)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2234cd);const _0x2773d4=await database_1['default'][_0x353b42(0x174)][_0x353b42(0x176)]({'where':{'id':_0x2234cd},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2773d4)return _0x7be4e3['status'](0x194)['json']({'success':![],'message':_0x353b42(0x19f)});if(_0x2773d4[_0x353b42(0x193)]!==_0x353b42(0x1b4))return _0x7be4e3[_0x353b42(0x15e)](0x190)['json']({'success':![],'message':_0x353b42(0x180)});if(_0x2773d4[_0x353b42(0x15e)]!==_0x353b42(0x1ba))return _0x7be4e3[_0x353b42(0x15e)](0x190)[_0x353b42(0x1c4)]({'success':![],'message':_0x353b42(0x184)+_0x2773d4[_0x353b42(0x15e)]+_0x353b42(0x17c)});_0x7be4e3[_0x353b42(0x1c4)]({'success':!![],'result':{'paymentId':_0x2773d4['id'],'orderId':_0x2773d4[_0x353b42(0x1a7)],'amount':_0x2773d4[_0x353b42(0x175)],'currency':_0x2773d4['currency'],'merchantName':_0x2773d4['shop'][_0x353b42(0x163)],'description':'Payment\x20to\x20'+_0x2773d4[_0x353b42(0x196)][_0x353b42(0x163)],'testInstructions':{'successCard':_0x353b42(0x19a),'failureCard':_0x353b42(0x188),'expiryDate':_0x353b42(0x19d),'cvc':_0x353b42(0x1ae),'holderName':_0x353b42(0x191)}}});}catch(_0x2ba8c4){_0x59df85(_0x2ba8c4);}},this[_0x370e7a(0x198)]=async(_0x4f9845,_0x22341e,_0x5ebf7f)=>{const _0x54dd49=_0x370e7a;try{const {paymentId:_0x302bbb}=_0x4f9845[_0x54dd49(0x16e)],_0x22c9da=_0x4f9845[_0x54dd49(0x1a0)];console[_0x54dd49(0x1b6)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x302bbb);const _0x519de7=await database_1['default'][_0x54dd49(0x174)][_0x54dd49(0x176)]({'where':{'id':_0x302bbb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x519de7)return _0x22341e[_0x54dd49(0x15e)](0x194)[_0x54dd49(0x1c4)]({'success':![],'message':_0x54dd49(0x19f)});if(_0x519de7['gateway']!==_0x54dd49(0x1b4))return _0x22341e['status'](0x190)[_0x54dd49(0x1c4)]({'success':![],'message':_0x54dd49(0x180)});if(_0x519de7[_0x54dd49(0x15e)]!=='PENDING')return _0x22341e['status'](0x190)[_0x54dd49(0x1c4)]({'success':![],'message':_0x54dd49(0x184)+_0x519de7['status']+',\x20cannot\x20process'});const _0x58e96b=await this[_0x54dd49(0x162)][_0x54dd49(0x1c5)]({'paymentId':_0x519de7['id'],'orderId':_0x519de7[_0x54dd49(0x1a7)]||_0x519de7['id'],'amount':_0x519de7[_0x54dd49(0x175)],'currency':_0x519de7[_0x54dd49(0x168)],'cardData':_0x22c9da});console[_0x54dd49(0x1b6)]('üß™\x20Test\x20Gateway\x20result:',_0x58e96b);const _0x1636f3={'status':_0x58e96b[_0x54dd49(0x15e)],'updatedAt':new Date()};if(_0x58e96b[_0x54dd49(0x15e)]===_0x54dd49(0x187))_0x1636f3['paidAt']=new Date(),_0x1636f3['gatewayPaymentId']=_0x58e96b[_0x54dd49(0x1b8)];else _0x58e96b[_0x54dd49(0x15e)]===_0x54dd49(0x19b)&&(_0x1636f3['failureMessage']=_0x58e96b[_0x54dd49(0x182)]);const _0x4d5c1c=_0x22c9da[_0x54dd49(0x1c2)][_0x54dd49(0x19e)](/[\s-]/g,'');_0x1636f3[_0x54dd49(0x185)]=_0x4d5c1c[_0x54dd49(0x192)](-0x4),_0x1636f3['paymentMethod']=_0x54dd49(0x1ac),await database_1[_0x54dd49(0x1a8)]['payment'][_0x54dd49(0x155)]({'where':{'id':_0x519de7['id']},'data':_0x1636f3});if(_0x58e96b[_0x54dd49(0x15e)]===_0x54dd49(0x187)&&_0x519de7[_0x54dd49(0x16a)]){console[_0x54dd49(0x1b6)](_0x54dd49(0x158)+_0x519de7['id']+_0x54dd49(0x18b));try{await database_1[_0x54dd49(0x1a8)][_0x54dd49(0x195)](async _0x4fc528=>{const _0x3a095b=_0x54dd49,_0xfac39d=await _0x4fc528[_0x3a095b(0x197)][_0x3a095b(0x176)]({'where':{'id':_0x519de7['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xfac39d){console['log'](_0x3a095b(0x16c)+_0xfac39d['id']+':\x20type='+_0xfac39d['type']+',\x20currentPayments='+_0xfac39d[_0x3a095b(0x1a2)]+_0x3a095b(0x170)+_0xfac39d[_0x3a095b(0x15e)]);const _0x16fc49=_0xfac39d[_0x3a095b(0x1a2)]+0x1,_0x261106=_0xfac39d[_0x3a095b(0x18e)]===_0x3a095b(0x16b)?_0x3a095b(0x1a5):_0xfac39d[_0x3a095b(0x15e)];await _0x4fc528[_0x3a095b(0x197)]['update']({'where':{'id':_0x519de7['paymentLinkId']},'data':{'currentPayments':_0x16fc49,'status':_0x261106,'updatedAt':new Date()}}),console[_0x3a095b(0x1b6)]('‚úÖ\x20Payment\x20link\x20'+_0xfac39d['id']+'\x20updated:\x20currentPayments='+_0xfac39d[_0x3a095b(0x1a2)]+'\x20->\x20'+_0x16fc49+_0x3a095b(0x170)+_0xfac39d[_0x3a095b(0x15e)]+_0x3a095b(0x173)+_0x261106);}else console[_0x3a095b(0x1b6)](_0x3a095b(0x1aa)+_0x519de7[_0x3a095b(0x16a)]+'\x20not\x20found');});}catch(_0x5b2c26){console['error'](_0x54dd49(0x157),_0x5b2c26);}}await database_1[_0x54dd49(0x1a8)]['webhookLog'][_0x54dd49(0x1b1)]({'data':{'paymentId':_0x519de7['id'],'shopId':_0x519de7[_0x54dd49(0x154)],'event':'test_gateway_'+_0x58e96b[_0x54dd49(0x15e)][_0x54dd49(0x1a6)](),'statusCode':0xc8,'responseBody':JSON[_0x54dd49(0x1bf)]({'oldStatus':_0x54dd49(0x1ba),'newStatus':_0x58e96b['status'],'transactionId':_0x58e96b[_0x54dd49(0x1b8)],'failureReason':_0x58e96b['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x519de7,_0x58e96b[_0x54dd49(0x15e)],_0x58e96b[_0x54dd49(0x1b8)],_0x58e96b[_0x54dd49(0x182)]),await this[_0x54dd49(0x1b2)](_0x519de7,_0x58e96b['status']),console[_0x54dd49(0x1b6)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x302bbb+'\x20processed:\x20'+_0x58e96b[_0x54dd49(0x15e)]),_0x58e96b[_0x54dd49(0x15e)]===_0x54dd49(0x187)?_0x22341e[_0x54dd49(0x1c4)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x54dd49(0x187),'transactionId':_0x58e96b['transactionId'],'redirectUrl':_0x519de7[_0x54dd49(0x15a)]}}):_0x22341e[_0x54dd49(0x15e)](0x190)[_0x54dd49(0x1c4)]({'success':![],'message':_0x54dd49(0x18c),'result':{'status':_0x54dd49(0x19b),'failureReason':_0x58e96b[_0x54dd49(0x182)],'redirectUrl':_0x519de7[_0x54dd49(0x1c3)]}});}catch(_0x11ac76){_0x5ebf7f(_0x11ac76);}},this[_0x370e7a(0x162)]=new testGatewayService_1[(_0x370e7a(0x17d))](),this[_0x370e7a(0x17b)]=new webhookService_1[(_0x370e7a(0x19c))]();}async[a13_0x568638(0x190)](_0x5a79ce,_0xc7ee7c,_0xaca01e,_0x858831){const _0x257c3a=a13_0x568638,_0x5e3990=Date[_0x257c3a(0x16f)]();try{const _0x5105a0=_0x5a79ce[_0x257c3a(0x196)],_0xe4efed=_0x5105a0[_0x257c3a(0x167)];if(!_0xe4efed?.['webhookUrl']){console[_0x257c3a(0x1b6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5105a0['id']);return;}const _0x2c238d=_0xc7ee7c===_0x257c3a(0x187)?_0x257c3a(0x1b3):_0x257c3a(0x153);let _0x387c0e=[];if(_0xe4efed[_0x257c3a(0x159)])try{_0x387c0e=Array['isArray'](_0xe4efed['webhookEvents'])?_0xe4efed['webhookEvents']:JSON[_0x257c3a(0x1bb)](_0xe4efed[_0x257c3a(0x159)]);}catch(_0x48e268){console[_0x257c3a(0x18d)](_0x257c3a(0x1c0),_0x48e268),_0x387c0e=[];}if(!_0x387c0e['includes'](_0x2c238d)){console[_0x257c3a(0x1b6)](_0x257c3a(0x1a4)+_0x2c238d+_0x257c3a(0x17a)+_0x5105a0['id']);return;}const _0x136b23={'event':_0x2c238d,'payment':{'id':_0x5a79ce['id'],'order_id':_0x5a79ce[_0x257c3a(0x179)],'gateway_order_id':_0x5a79ce[_0x257c3a(0x1a7)],'gateway':_0x257c3a(0x1c6),'amount':_0x5a79ce[_0x257c3a(0x175)],'currency':_0x5a79ce[_0x257c3a(0x168)],'status':_0xc7ee7c['toLowerCase'](),'customer_email':_0x5a79ce[_0x257c3a(0x183)],'customer_name':_0x5a79ce[_0x257c3a(0x1bc)],'transaction_id':_0xaca01e,'failure_message':_0x858831,'created_at':_0x5a79ce[_0x257c3a(0x177)],'updated_at':new Date()}},_0x149caf=await fetch(_0xe4efed[_0x257c3a(0x1c1)],{'method':_0x257c3a(0x1be),'headers':{'Content-Type':_0x257c3a(0x178),'User-Agent':_0x257c3a(0x156)},'body':JSON[_0x257c3a(0x1bf)](_0x136b23)}),_0x50eaa6=Date[_0x257c3a(0x16f)]()-_0x5e3990;console[_0x257c3a(0x1b6)](_0x257c3a(0x17f)+_0xe4efed['webhookUrl']+_0x257c3a(0x1ad)+_0x149caf[_0x257c3a(0x15e)]+'\x20('+_0x50eaa6+_0x257c3a(0x15b));}catch(_0x59a44f){console[_0x257c3a(0x18d)](_0x257c3a(0x1b9),_0x59a44f);}}async['sendPaymentStatusNotification'](_0x34998e,_0xc57e07){const _0x38a230=a13_0x568638;try{const {telegramBotService:_0x44d6f0}=await Promise['resolve']()[_0x38a230(0x152)](()=>__importStar(require(_0x38a230(0x15c)))),_0x4c5b4f={'PAID':_0x38a230(0x199),'FAILED':_0x38a230(0x189)},_0x4f55a0=_0x4c5b4f[_0xc57e07];if(!_0x4f55a0)return;await _0x44d6f0['sendPaymentNotification'](_0x34998e[_0x38a230(0x154)],_0x34998e,_0x4f55a0);}catch(_0x293ee7){console[_0x38a230(0x18d)](_0x38a230(0x1ab),_0x293ee7);}}}exports[a13_0x568638(0x1a1)]=TestGatewayController;