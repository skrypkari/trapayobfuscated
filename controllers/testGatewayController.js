'use strict';function a13_0x3ee2(_0x3e5ac3,_0x367f91){const _0x132f01=a13_0x132f();return a13_0x3ee2=function(_0x3ee226,_0x34309e){_0x3ee226=_0x3ee226-0xb6;let _0x161494=_0x132f01[_0x3ee226];return _0x161494;},a13_0x3ee2(_0x3e5ac3,_0x367f91);}function a13_0x132f(){const _0x5d78bc=['processCard','prototype','Error\x20parsing\x20webhook\x20events:','\x20processed:\x20','__importStar','gatewayPaymentId','__setModuleDefault','\x20with\x20status\x20','\x20->\x20','processCardPayment','ms)','WebhookService','defineProperty','39wODcqq','3pzegTl','sendShopWebhook','findUnique','replace','COMPLETED','body','Payment\x20not\x20found','application/json','690NtEDyK','payment','791NwYpfN','Payment\x20to\x20','$transaction','gateway','gatewayOrderId','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','‚ùå\x20Payment\x20link\x20','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','paid','get','name','configurable','payment.success','TestGatewayController','../services/gateways/testGatewayService','cardLast4','webhookService','test_gateway','amount','55WbkAuT','shop','Payment\x20status\x20is\x20','failureMessage','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üìà\x20Found\x20payment\x20link\x20','üß™\x20Test\x20Gateway\x20result:','Any\x20future\x20date\x20(MM/YY)','currentPayments','length','PENDING','settings',',\x20cannot\x20process','writable',',\x20currentPayments=','resolve','../services/webhookService','Payment\x20failed','toISOString','shopId','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','default','35336ezBpTt','type','params','getOwnPropertyNames','hasOwnProperty','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','includes','successUrl','getPaymentForm','Any\x20name','../services/telegramBotService','webhookEvents','failed','failureReason','1855596uZJTEC','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentStatusNotification','__esModule','update','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookUrl','__importDefault','Any\x20other\x20card\x20number','toLowerCase','slice','__createBinding','151947gKXFRl','../config/database','currency','paymentLinkId','5093286LxBMyp','customerEmail','333524ZkpHBO','511FXCfOy','log','FAILED','sendPaymentNotification','status',':\x20type=','webhookLog','create','Webhook\x20event\x20','error','\x20not\x20found','PAID','transactionId','Payment\x20is\x20not\x20for\x20test\x20gateway','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paymentLink','90FeGpfO','\x20not\x20enabled\x20for\x20shop\x20','json','then','testGatewayService','stringify','now','234834KZDtSL'];a13_0x132f=function(){return _0x5d78bc;};return a13_0x132f();}const a13_0x318062=a13_0x3ee2;(function(_0x3bd999,_0x358265){const _0x77cebf=a13_0x3ee2,_0x4f7b56=_0x3bd999();while(!![]){try{const _0x509887=-parseInt(_0x77cebf(0x106))/0x1*(-parseInt(_0x77cebf(0x104))/0x2)+-parseInt(_0x77cebf(0xfc))/0x3*(parseInt(_0x77cebf(0xd5))/0x4)+-parseInt(_0x77cebf(0x119))/0x5*(parseInt(_0x77cebf(0xed))/0x6)+parseInt(_0x77cebf(0xd6))/0x7*(parseInt(_0x77cebf(0x12f))/0x8)+-parseInt(_0x77cebf(0xcf))/0x9*(-parseInt(_0x77cebf(0xe6))/0xa)+parseInt(_0x77cebf(0xd3))/0xb+-parseInt(_0x77cebf(0xc3))/0xc*(parseInt(_0x77cebf(0xfb))/0xd);if(_0x509887===_0x358265)break;else _0x4f7b56['push'](_0x4f7b56['shift']());}catch(_0x39a623){_0x4f7b56['push'](_0x4f7b56['shift']());}}}(a13_0x132f,0x38c34));var __createBinding=this&&this[a13_0x318062(0xce)]||(Object[a13_0x318062(0xdd)]?function(_0x4c6721,_0x127b8d,_0x187ea2,_0x38118d){const _0x27dcbd=a13_0x318062;if(_0x38118d===undefined)_0x38118d=_0x187ea2;var _0x31ac6a=Object['getOwnPropertyDescriptor'](_0x127b8d,_0x187ea2);(!_0x31ac6a||(_0x27dcbd(0x10f)in _0x31ac6a?!_0x127b8d[_0x27dcbd(0xc6)]:_0x31ac6a[_0x27dcbd(0x126)]||_0x31ac6a[_0x27dcbd(0x111)]))&&(_0x31ac6a={'enumerable':!![],'get':function(){return _0x127b8d[_0x187ea2];}}),Object[_0x27dcbd(0xfa)](_0x4c6721,_0x38118d,_0x31ac6a);}:function(_0x2ff560,_0x1387ee,_0x502373,_0x27015c){if(_0x27015c===undefined)_0x27015c=_0x502373;_0x2ff560[_0x27015c]=_0x1387ee[_0x502373];}),__setModuleDefault=this&&this[a13_0x318062(0xf4)]||(Object[a13_0x318062(0xdd)]?function(_0xf0f3e2,_0x2c4cd7){const _0x347bde=a13_0x318062;Object[_0x347bde(0xfa)](_0xf0f3e2,_0x347bde(0x12e),{'enumerable':!![],'value':_0x2c4cd7});}:function(_0x33dad5,_0x2aa098){const _0x263687=a13_0x318062;_0x33dad5[_0x263687(0x12e)]=_0x2aa098;}),__importStar=this&&this[a13_0x318062(0xf2)]||(function(){var _0x4ea012=function(_0x220ed9){const _0x25f7af=a13_0x3ee2;return _0x4ea012=Object[_0x25f7af(0xb8)]||function(_0x15d94e){const _0xf75181=_0x25f7af;var _0x266b0b=[];for(var _0x47276a in _0x15d94e)if(Object[_0xf75181(0xef)][_0xf75181(0xb9)]['call'](_0x15d94e,_0x47276a))_0x266b0b[_0x266b0b[_0xf75181(0x122)]]=_0x47276a;return _0x266b0b;},_0x4ea012(_0x220ed9);};return function(_0x5b4173){const _0x49a5c4=a13_0x3ee2;if(_0x5b4173&&_0x5b4173[_0x49a5c4(0xc6)])return _0x5b4173;var _0x3291f5={};if(_0x5b4173!=null){for(var _0x3c75d3=_0x4ea012(_0x5b4173),_0x3994b6=0x0;_0x3994b6<_0x3c75d3['length'];_0x3994b6++)if(_0x3c75d3[_0x3994b6]!==_0x49a5c4(0x12e))__createBinding(_0x3291f5,_0x5b4173,_0x3c75d3[_0x3994b6]);}return __setModuleDefault(_0x3291f5,_0x5b4173),_0x3291f5;};}()),__importDefault=this&&this[a13_0x318062(0xca)]||function(_0x2eb707){const _0x537ff9=a13_0x318062;return _0x2eb707&&_0x2eb707[_0x537ff9(0xc6)]?_0x2eb707:{'default':_0x2eb707};};Object[a13_0x318062(0xfa)](exports,'__esModule',{'value':!![]}),exports[a13_0x318062(0x113)]=void 0x0;const testGatewayService_1=require(a13_0x318062(0x114)),webhookService_1=require(a13_0x318062(0x129)),database_1=__importDefault(require(a13_0x318062(0xd0)));class TestGatewayController{constructor(){const _0xdf3ac=a13_0x318062;this[_0xdf3ac(0xbd)]=async(_0x1fd882,_0x1e62ac,_0xef171e)=>{const _0x5a6567=_0xdf3ac;try{const {paymentId:_0x42ac38}=_0x1fd882[_0x5a6567(0xb7)];console[_0x5a6567(0xd7)](_0x5a6567(0x12d)+_0x42ac38);const _0x39e49f=await database_1[_0x5a6567(0x12e)][_0x5a6567(0x105)]['findUnique']({'where':{'id':_0x42ac38},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x39e49f)return _0x1e62ac['status'](0x194)[_0x5a6567(0xe8)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x39e49f[_0x5a6567(0x109)]!=='test_gateway')return _0x1e62ac[_0x5a6567(0xda)](0x190)[_0x5a6567(0xe8)]({'success':![],'message':_0x5a6567(0xe3)});if(_0x39e49f['status']!==_0x5a6567(0x123))return _0x1e62ac[_0x5a6567(0xda)](0x190)[_0x5a6567(0xe8)]({'success':![],'message':_0x5a6567(0x11b)+_0x39e49f[_0x5a6567(0xda)]+_0x5a6567(0x125)});_0x1e62ac[_0x5a6567(0xe8)]({'success':!![],'result':{'paymentId':_0x39e49f['id'],'orderId':_0x39e49f[_0x5a6567(0x10a)],'amount':_0x39e49f[_0x5a6567(0x118)],'currency':_0x39e49f['currency'],'merchantName':_0x39e49f[_0x5a6567(0x11a)][_0x5a6567(0x110)],'description':_0x5a6567(0x107)+_0x39e49f['shop']['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5a6567(0xcb),'expiryDate':_0x5a6567(0x120),'cvc':'Any\x203-4\x20digits','holderName':_0x5a6567(0xbe)}}});}catch(_0x4a4901){_0xef171e(_0x4a4901);}},this[_0xdf3ac(0xee)]=async(_0x151e28,_0x4202ae,_0x33966c)=>{const _0x4c7bef=_0xdf3ac;try{const {paymentId:_0x507045}=_0x151e28[_0x4c7bef(0xb7)],_0x1f7390=_0x151e28[_0x4c7bef(0x101)];console[_0x4c7bef(0xd7)](_0x4c7bef(0xe4)+_0x507045);const _0x2f587a=await database_1[_0x4c7bef(0x12e)]['payment'][_0x4c7bef(0xfe)]({'where':{'id':_0x507045},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f587a)return _0x4202ae[_0x4c7bef(0xda)](0x194)[_0x4c7bef(0xe8)]({'success':![],'message':_0x4c7bef(0x102)});if(_0x2f587a[_0x4c7bef(0x109)]!==_0x4c7bef(0x117))return _0x4202ae['status'](0x190)[_0x4c7bef(0xe8)]({'success':![],'message':_0x4c7bef(0xe3)});if(_0x2f587a[_0x4c7bef(0xda)]!==_0x4c7bef(0x123))return _0x4202ae[_0x4c7bef(0xda)](0x190)[_0x4c7bef(0xe8)]({'success':![],'message':_0x4c7bef(0x11b)+_0x2f587a[_0x4c7bef(0xda)]+_0x4c7bef(0x125)});const _0x2fe8a8=await this[_0x4c7bef(0xea)][_0x4c7bef(0xf7)]({'paymentId':_0x2f587a['id'],'orderId':_0x2f587a[_0x4c7bef(0x10a)]||_0x2f587a['id'],'amount':_0x2f587a[_0x4c7bef(0x118)],'currency':_0x2f587a[_0x4c7bef(0xd1)],'cardData':_0x1f7390});console['log'](_0x4c7bef(0x11f),_0x2fe8a8);const _0x367c7f={'status':_0x2fe8a8[_0x4c7bef(0xda)],'updatedAt':new Date()};if(_0x2fe8a8[_0x4c7bef(0xda)]===_0x4c7bef(0xe1))_0x367c7f['paidAt']=new Date(),_0x367c7f[_0x4c7bef(0xf3)]=_0x2fe8a8[_0x4c7bef(0xe2)];else _0x2fe8a8['status']===_0x4c7bef(0xd8)&&(_0x367c7f[_0x4c7bef(0x11c)]=_0x2fe8a8[_0x4c7bef(0xc2)]);const _0x610c91=_0x1f7390['cardNumber'][_0x4c7bef(0xff)](/[\s-]/g,'');_0x367c7f[_0x4c7bef(0x115)]=_0x610c91[_0x4c7bef(0xcd)](-0x4),_0x367c7f['paymentMethod']='test_card',await database_1['default'][_0x4c7bef(0x105)][_0x4c7bef(0xc7)]({'where':{'id':_0x2f587a['id']},'data':_0x367c7f});if(_0x2fe8a8['status']===_0x4c7bef(0xe1)&&_0x2f587a[_0x4c7bef(0xd2)]){console['log']('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x2f587a['id']+_0x4c7bef(0xba));try{await database_1['default'][_0x4c7bef(0x108)](async _0x4ffedc=>{const _0x173198=_0x4c7bef,_0x40b10b=await _0x4ffedc['paymentLink'][_0x173198(0xfe)]({'where':{'id':_0x2f587a[_0x173198(0xd2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x40b10b){console[_0x173198(0xd7)](_0x173198(0x11e)+_0x40b10b['id']+_0x173198(0xdb)+_0x40b10b[_0x173198(0xb6)]+_0x173198(0x127)+_0x40b10b[_0x173198(0x121)]+',\x20status='+_0x40b10b['status']);const _0x1cdda9=_0x40b10b[_0x173198(0x121)]+0x1,_0x141760=_0x40b10b[_0x173198(0xb6)]==='SINGLE'?_0x173198(0x100):_0x40b10b[_0x173198(0xda)];await _0x4ffedc[_0x173198(0xe5)][_0x173198(0xc7)]({'where':{'id':_0x2f587a[_0x173198(0xd2)]},'data':{'currentPayments':_0x1cdda9,'status':_0x141760,'updatedAt':new Date()}}),console[_0x173198(0xd7)]('‚úÖ\x20Payment\x20link\x20'+_0x40b10b['id']+'\x20updated:\x20currentPayments='+_0x40b10b[_0x173198(0x121)]+_0x173198(0xf6)+_0x1cdda9+',\x20status='+_0x40b10b[_0x173198(0xda)]+_0x173198(0xf6)+_0x141760);}else console[_0x173198(0xd7)](_0x173198(0x10c)+_0x2f587a[_0x173198(0xd2)]+_0x173198(0xe0));});}catch(_0xe7ab6c){console[_0x4c7bef(0xdf)](_0x4c7bef(0x10d),_0xe7ab6c);}}await database_1[_0x4c7bef(0x12e)][_0x4c7bef(0xdc)]['create']({'data':{'paymentId':_0x2f587a['id'],'shopId':_0x2f587a[_0x4c7bef(0x12c)],'event':'test_gateway_'+_0x2fe8a8['status'][_0x4c7bef(0xcc)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4c7bef(0x123),'newStatus':_0x2fe8a8['status'],'transactionId':_0x2fe8a8['transactionId'],'failureReason':_0x2fe8a8[_0x4c7bef(0xc2)],'processedAt':new Date()[_0x4c7bef(0x12b)]()})}}),await this['sendShopWebhook'](_0x2f587a,_0x2fe8a8[_0x4c7bef(0xda)],_0x2fe8a8[_0x4c7bef(0xe2)],_0x2fe8a8['failureReason']),await this[_0x4c7bef(0xc5)](_0x2f587a,_0x2fe8a8[_0x4c7bef(0xda)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x507045+_0x4c7bef(0xf1)+_0x2fe8a8[_0x4c7bef(0xda)]),_0x2fe8a8[_0x4c7bef(0xda)]==='PAID'?_0x4202ae['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x4c7bef(0xe1),'transactionId':_0x2fe8a8[_0x4c7bef(0xe2)],'redirectUrl':_0x2f587a[_0x4c7bef(0xbc)]}}):_0x4202ae[_0x4c7bef(0xda)](0x190)[_0x4c7bef(0xe8)]({'success':![],'message':_0x4c7bef(0x12a),'result':{'status':_0x4c7bef(0xd8),'failureReason':_0x2fe8a8[_0x4c7bef(0xc2)],'redirectUrl':_0x2f587a['failUrl']}});}catch(_0xa38b8b){_0x33966c(_0xa38b8b);}},this[_0xdf3ac(0xea)]=new testGatewayService_1['TestGatewayService'](),this[_0xdf3ac(0x116)]=new webhookService_1[(_0xdf3ac(0xf9))]();}async[a13_0x318062(0xfd)](_0x249934,_0x179eb2,_0x519c44,_0x26799b){const _0x223d19=a13_0x318062,_0x113139=Date[_0x223d19(0xec)]();try{const _0x863a26=_0x249934[_0x223d19(0x11a)],_0x2c9eeb=_0x863a26[_0x223d19(0x124)];if(!_0x2c9eeb?.[_0x223d19(0xc9)]){console[_0x223d19(0xd7)](_0x223d19(0x11d)+_0x863a26['id']);return;}const _0x22b810=_0x179eb2===_0x223d19(0xe1)?_0x223d19(0x112):'payment.failed';let _0x3dd39c=[];if(_0x2c9eeb[_0x223d19(0xc0)])try{_0x3dd39c=Array['isArray'](_0x2c9eeb[_0x223d19(0xc0)])?_0x2c9eeb['webhookEvents']:JSON['parse'](_0x2c9eeb['webhookEvents']);}catch(_0x481b99){console[_0x223d19(0xdf)](_0x223d19(0xf0),_0x481b99),_0x3dd39c=[];}if(!_0x3dd39c[_0x223d19(0xbb)](_0x22b810)){console[_0x223d19(0xd7)](_0x223d19(0xde)+_0x22b810+_0x223d19(0xe7)+_0x863a26['id']);return;}const _0x57201e={'event':_0x22b810,'payment':{'id':_0x249934['id'],'order_id':_0x249934['orderId'],'gateway_order_id':_0x249934[_0x223d19(0x10a)],'gateway':'0000','amount':_0x249934[_0x223d19(0x118)],'currency':_0x249934['currency'],'status':_0x179eb2[_0x223d19(0xcc)](),'customer_email':_0x249934[_0x223d19(0xd4)],'customer_name':_0x249934['customerName'],'transaction_id':_0x519c44,'failure_message':_0x26799b,'created_at':_0x249934['createdAt'],'updated_at':new Date()}},_0x3b077a=await fetch(_0x2c9eeb['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x223d19(0x103),'User-Agent':_0x223d19(0x10b)},'body':JSON[_0x223d19(0xeb)](_0x57201e)}),_0x20e6d3=Date[_0x223d19(0xec)]()-_0x113139;console[_0x223d19(0xd7)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2c9eeb[_0x223d19(0xc9)]+_0x223d19(0xf5)+_0x3b077a[_0x223d19(0xda)]+'\x20('+_0x20e6d3+_0x223d19(0xf8));}catch(_0x48c914){console[_0x223d19(0xdf)](_0x223d19(0xc8),_0x48c914);}}async[a13_0x318062(0xc5)](_0x342946,_0x41dd62){const _0x2a088e=a13_0x318062;try{const {telegramBotService:_0x266205}=await Promise[_0x2a088e(0x128)]()[_0x2a088e(0xe9)](()=>__importStar(require(_0x2a088e(0xbf)))),_0x3b720a={'PAID':_0x2a088e(0x10e),'FAILED':_0x2a088e(0xc1)},_0x288691=_0x3b720a[_0x41dd62];if(!_0x288691)return;await _0x266205[_0x2a088e(0xd9)](_0x342946[_0x2a088e(0x12c)],_0x342946,_0x288691);}catch(_0x1a20d7){console[_0x2a088e(0xdf)](_0x2a088e(0xc4),_0x1a20d7);}}}exports[a13_0x318062(0x113)]=TestGatewayController;