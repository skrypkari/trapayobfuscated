'use strict';const a13_0x356ccd=a13_0x5794;(function(_0x5522a8,_0x23ca46){const _0x1946d2=a13_0x5794,_0x39f309=_0x5522a8();while(!![]){try{const _0x93335b=parseInt(_0x1946d2(0x17e))/0x1*(parseInt(_0x1946d2(0x15e))/0x2)+-parseInt(_0x1946d2(0x177))/0x3*(parseInt(_0x1946d2(0x160))/0x4)+parseInt(_0x1946d2(0x170))/0x5+-parseInt(_0x1946d2(0x184))/0x6*(parseInt(_0x1946d2(0x185))/0x7)+-parseInt(_0x1946d2(0x197))/0x8+parseInt(_0x1946d2(0x161))/0x9+parseInt(_0x1946d2(0x1b4))/0xa;if(_0x93335b===_0x23ca46)break;else _0x39f309['push'](_0x39f309['shift']());}catch(_0x48267d){_0x39f309['push'](_0x39f309['shift']());}}}(a13_0x1593,0xadea5));function a13_0x5794(_0x3281f7,_0xbb02d5){const _0x1593ef=a13_0x1593();return a13_0x5794=function(_0x5794fc,_0x112716){_0x5794fc=_0x5794fc-0x15e;let _0x4d7c51=_0x1593ef[_0x5794fc];return _0x4d7c51;},a13_0x5794(_0x3281f7,_0xbb02d5);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x2e1cde,_0xdbb400,_0x16ae4d,_0x489c61){const _0x292b6e=a13_0x5794;if(_0x489c61===undefined)_0x489c61=_0x16ae4d;var _0x1b8b52=Object[_0x292b6e(0x1cb)](_0xdbb400,_0x16ae4d);(!_0x1b8b52||(_0x292b6e(0x16f)in _0x1b8b52?!_0xdbb400[_0x292b6e(0x1be)]:_0x1b8b52[_0x292b6e(0x189)]||_0x1b8b52[_0x292b6e(0x18c)]))&&(_0x1b8b52={'enumerable':!![],'get':function(){return _0xdbb400[_0x16ae4d];}}),Object['defineProperty'](_0x2e1cde,_0x489c61,_0x1b8b52);}:function(_0x555196,_0x5d43a7,_0x9bac84,_0x3b105f){if(_0x3b105f===undefined)_0x3b105f=_0x9bac84;_0x555196[_0x3b105f]=_0x5d43a7[_0x9bac84];}),__setModuleDefault=this&&this[a13_0x356ccd(0x17b)]||(Object[a13_0x356ccd(0x19c)]?function(_0x1e320a,_0x1e54d3){Object['defineProperty'](_0x1e320a,'default',{'enumerable':!![],'value':_0x1e54d3});}:function(_0x5ae33b,_0x56eacd){const _0x22bcbd=a13_0x356ccd;_0x5ae33b[_0x22bcbd(0x1c2)]=_0x56eacd;}),__importStar=this&&this[a13_0x356ccd(0x1a6)]||(function(){var _0x22925f=function(_0x48e98c){const _0xd427a5=a13_0x5794;return _0x22925f=Object[_0xd427a5(0x1c9)]||function(_0x5ea59f){const _0x44d3da=_0xd427a5;var _0x411379=[];for(var _0x32d120 in _0x5ea59f)if(Object[_0x44d3da(0x1bd)]['hasOwnProperty']['call'](_0x5ea59f,_0x32d120))_0x411379[_0x411379['length']]=_0x32d120;return _0x411379;},_0x22925f(_0x48e98c);};return function(_0x3c56e3){const _0x2bd5bf=a13_0x5794;if(_0x3c56e3&&_0x3c56e3['__esModule'])return _0x3c56e3;var _0x2c9119={};if(_0x3c56e3!=null){for(var _0x4bb9be=_0x22925f(_0x3c56e3),_0x11dc3a=0x0;_0x11dc3a<_0x4bb9be[_0x2bd5bf(0x18e)];_0x11dc3a++)if(_0x4bb9be[_0x11dc3a]!==_0x2bd5bf(0x1c2))__createBinding(_0x2c9119,_0x3c56e3,_0x4bb9be[_0x11dc3a]);}return __setModuleDefault(_0x2c9119,_0x3c56e3),_0x2c9119;};}()),__importDefault=this&&this[a13_0x356ccd(0x1cc)]||function(_0x5a2fee){const _0x30688f=a13_0x356ccd;return _0x5a2fee&&_0x5a2fee[_0x30688f(0x1be)]?_0x5a2fee:{'default':_0x5a2fee};};Object[a13_0x356ccd(0x19e)](exports,a13_0x356ccd(0x1be),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x356ccd(0x1d1)),webhookService_1=require(a13_0x356ccd(0x1a0)),database_1=__importDefault(require(a13_0x356ccd(0x1aa)));class TestGatewayController{constructor(){const _0x3b61bc=a13_0x356ccd;this[_0x3b61bc(0x167)]=async(_0x8d95f0,_0x4cee31,_0x474c19)=>{const _0xc3e1be=_0x3b61bc;try{const {paymentId:_0x5d366a}=_0x8d95f0[_0xc3e1be(0x178)];console[_0xc3e1be(0x18a)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5d366a);const _0x141e59=await database_1['default'][_0xc3e1be(0x1a5)][_0xc3e1be(0x15f)]({'where':{'id':_0x5d366a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x141e59)return _0x4cee31[_0xc3e1be(0x1a9)](0x194)[_0xc3e1be(0x1c5)]({'success':![],'message':_0xc3e1be(0x192)});if(_0x141e59[_0xc3e1be(0x1c8)]!=='test_gateway')return _0x4cee31[_0xc3e1be(0x1a9)](0x190)['json']({'success':![],'message':_0xc3e1be(0x173)});if(_0x141e59['status']!==_0xc3e1be(0x1ab))return _0x4cee31[_0xc3e1be(0x1a9)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x141e59[_0xc3e1be(0x1a9)]+_0xc3e1be(0x172)});_0x4cee31[_0xc3e1be(0x1c5)]({'success':!![],'result':{'paymentId':_0x141e59['id'],'orderId':_0x141e59[_0xc3e1be(0x1a4)],'amount':_0x141e59['amount'],'currency':_0x141e59[_0xc3e1be(0x1c7)],'merchantName':_0x141e59[_0xc3e1be(0x18f)][_0xc3e1be(0x19f)],'description':_0xc3e1be(0x1c1)+_0x141e59[_0xc3e1be(0x18f)]['name'],'testInstructions':{'successCard':_0xc3e1be(0x1a7),'failureCard':_0xc3e1be(0x1d0),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0xc3e1be(0x195),'holderName':_0xc3e1be(0x16c)}}});}catch(_0x4cf935){_0x474c19(_0x4cf935);}},this[_0x3b61bc(0x1b5)]=async(_0x589d29,_0x220310,_0x31a623)=>{const _0x13c22c=_0x3b61bc;try{const {paymentId:_0x503998}=_0x589d29[_0x13c22c(0x178)],_0x38532d=_0x589d29[_0x13c22c(0x1c6)];console[_0x13c22c(0x18a)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x503998);const _0x4d437d=await database_1[_0x13c22c(0x1c2)][_0x13c22c(0x1a5)]['findUnique']({'where':{'id':_0x503998},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4d437d)return _0x220310[_0x13c22c(0x1a9)](0x194)[_0x13c22c(0x1c5)]({'success':![],'message':_0x13c22c(0x192)});if(_0x4d437d[_0x13c22c(0x1c8)]!==_0x13c22c(0x194))return _0x220310[_0x13c22c(0x1a9)](0x190)['json']({'success':![],'message':_0x13c22c(0x173)});if(_0x4d437d['status']!==_0x13c22c(0x1ab))return _0x220310['status'](0x190)[_0x13c22c(0x1c5)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4d437d['status']+_0x13c22c(0x172)});const _0x43c507=await this['testGatewayService'][_0x13c22c(0x1a8)]({'paymentId':_0x4d437d['id'],'orderId':_0x4d437d[_0x13c22c(0x1a4)]||_0x4d437d['id'],'amount':_0x4d437d['amount'],'currency':_0x4d437d[_0x13c22c(0x1c7)],'cardData':_0x38532d});console[_0x13c22c(0x18a)]('🧪\x20Test\x20Gateway\x20result:',_0x43c507);const _0x5ca80f={'status':_0x43c507[_0x13c22c(0x1a9)],'updatedAt':new Date()};if(_0x43c507['status']===_0x13c22c(0x1b6))_0x5ca80f[_0x13c22c(0x1b2)]=new Date(),_0x5ca80f[_0x13c22c(0x190)]=_0x43c507['transactionId'];else _0x43c507[_0x13c22c(0x1a9)]==='FAILED'&&(_0x5ca80f[_0x13c22c(0x1ae)]=_0x43c507['failureReason']);const _0x5d123e=_0x38532d[_0x13c22c(0x1a2)][_0x13c22c(0x17f)](/[\s-]/g,'');_0x5ca80f['cardLast4']=_0x5d123e[_0x13c22c(0x166)](-0x4),_0x5ca80f['paymentMethod']=_0x13c22c(0x179),await database_1[_0x13c22c(0x1c2)][_0x13c22c(0x1a5)][_0x13c22c(0x1d2)]({'where':{'id':_0x4d437d['id']},'data':_0x5ca80f});if(_0x43c507[_0x13c22c(0x1a9)]===_0x13c22c(0x1b6)&&_0x4d437d['paymentLinkId']){console[_0x13c22c(0x18a)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x4d437d['id']+_0x13c22c(0x18d));try{await database_1[_0x13c22c(0x1c2)][_0x13c22c(0x1cf)](async _0x381725=>{const _0x3c1cb6=_0x13c22c,_0x3f9685=await _0x381725[_0x3c1cb6(0x1b0)][_0x3c1cb6(0x15f)]({'where':{'id':_0x4d437d[_0x3c1cb6(0x199)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3f9685){console[_0x3c1cb6(0x18a)](_0x3c1cb6(0x162)+_0x3f9685['id']+_0x3c1cb6(0x17d)+_0x3f9685[_0x3c1cb6(0x17c)]+',\x20currentPayments='+_0x3f9685['currentPayments']+',\x20status='+_0x3f9685[_0x3c1cb6(0x1a9)]);const _0x87b86=_0x3f9685['currentPayments']+0x1,_0x251517=_0x3f9685[_0x3c1cb6(0x17c)]===_0x3c1cb6(0x1b8)?_0x3c1cb6(0x164):_0x3f9685['status'];await _0x381725['paymentLink'][_0x3c1cb6(0x1d2)]({'where':{'id':_0x4d437d[_0x3c1cb6(0x199)]},'data':{'currentPayments':_0x87b86,'status':_0x251517,'updatedAt':new Date()}}),console[_0x3c1cb6(0x18a)](_0x3c1cb6(0x1c3)+_0x3f9685['id']+'\x20updated:\x20currentPayments='+_0x3f9685[_0x3c1cb6(0x1d7)]+_0x3c1cb6(0x171)+_0x87b86+',\x20status='+_0x3f9685[_0x3c1cb6(0x1a9)]+'\x20->\x20'+_0x251517);}else console[_0x3c1cb6(0x18a)](_0x3c1cb6(0x188)+_0x4d437d[_0x3c1cb6(0x199)]+'\x20not\x20found');});}catch(_0x8bf5fc){console[_0x13c22c(0x180)](_0x13c22c(0x1b1),_0x8bf5fc);}}await database_1[_0x13c22c(0x1c2)]['webhookLog'][_0x13c22c(0x19c)]({'data':{'paymentId':_0x4d437d['id'],'shopId':_0x4d437d['shopId'],'event':_0x13c22c(0x187)+_0x43c507[_0x13c22c(0x1a9)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x13c22c(0x1ab),'newStatus':_0x43c507[_0x13c22c(0x1a9)],'transactionId':_0x43c507['transactionId'],'failureReason':_0x43c507[_0x13c22c(0x16a)],'processedAt':new Date()[_0x13c22c(0x168)]()})}}),await this['sendShopWebhook'](_0x4d437d,_0x43c507[_0x13c22c(0x1a9)],_0x43c507[_0x13c22c(0x1cd)],_0x43c507[_0x13c22c(0x16a)]),await this['sendPaymentStatusNotification'](_0x4d437d,_0x43c507['status']),console[_0x13c22c(0x18a)](_0x13c22c(0x1bb)+_0x503998+'\x20processed:\x20'+_0x43c507[_0x13c22c(0x1a9)]),_0x43c507['status']===_0x13c22c(0x1b6)?_0x220310[_0x13c22c(0x1c5)]({'success':!![],'message':_0x13c22c(0x186),'result':{'status':_0x13c22c(0x1b6),'transactionId':_0x43c507[_0x13c22c(0x1cd)],'redirectUrl':_0x4d437d[_0x13c22c(0x16b)]}}):_0x220310[_0x13c22c(0x1a9)](0x190)[_0x13c22c(0x1c5)]({'success':![],'message':_0x13c22c(0x196),'result':{'status':_0x13c22c(0x1d6),'failureReason':_0x43c507[_0x13c22c(0x16a)],'redirectUrl':_0x4d437d[_0x13c22c(0x1ac)]}});}catch(_0x26ad8b){_0x31a623(_0x26ad8b);}},this[_0x3b61bc(0x1a1)]=new testGatewayService_1['TestGatewayService'](),this[_0x3b61bc(0x1bf)]=new webhookService_1[(_0x3b61bc(0x1d5))]();}async[a13_0x356ccd(0x175)](_0x1cf8a4,_0x16052a,_0x569cff,_0x2b84a5){const _0x41a7ad=a13_0x356ccd,_0x351017=Date[_0x41a7ad(0x193)]();try{const _0x38a44d=_0x1cf8a4[_0x41a7ad(0x18f)],_0x3ad5fa=_0x38a44d[_0x41a7ad(0x183)];if(!_0x3ad5fa?.[_0x41a7ad(0x181)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x38a44d['id']);return;}const _0x405ea0=_0x16052a===_0x41a7ad(0x1b6)?_0x41a7ad(0x1b7):_0x41a7ad(0x16d);let _0x318fd1=[];if(_0x3ad5fa[_0x41a7ad(0x169)])try{_0x318fd1=Array['isArray'](_0x3ad5fa[_0x41a7ad(0x169)])?_0x3ad5fa[_0x41a7ad(0x169)]:JSON[_0x41a7ad(0x1c0)](_0x3ad5fa[_0x41a7ad(0x169)]);}catch(_0x49685e){console[_0x41a7ad(0x180)](_0x41a7ad(0x19a),_0x49685e),_0x318fd1=[];}if(!_0x318fd1[_0x41a7ad(0x18b)](_0x405ea0)){console['log'](_0x41a7ad(0x19d)+_0x405ea0+_0x41a7ad(0x1ce)+_0x38a44d['id']);return;}const _0x1580c0={'event':_0x405ea0,'payment':{'id':_0x1cf8a4['id'],'order_id':_0x1cf8a4[_0x41a7ad(0x17a)],'gateway_order_id':_0x1cf8a4[_0x41a7ad(0x1a4)],'gateway':_0x41a7ad(0x191),'amount':_0x1cf8a4[_0x41a7ad(0x1b3)],'currency':_0x1cf8a4[_0x41a7ad(0x1c7)],'status':_0x16052a[_0x41a7ad(0x1d4)](),'customer_email':_0x1cf8a4[_0x41a7ad(0x165)],'customer_name':_0x1cf8a4[_0x41a7ad(0x1ca)],'transaction_id':_0x569cff,'failure_message':_0x2b84a5,'created_at':_0x1cf8a4[_0x41a7ad(0x1d8)],'updated_at':new Date()}},_0x45d317=await fetch(_0x3ad5fa[_0x41a7ad(0x181)],{'method':_0x41a7ad(0x176),'headers':{'Content-Type':'application/json','User-Agent':_0x41a7ad(0x19b)},'body':JSON[_0x41a7ad(0x182)](_0x1580c0)}),_0xf25470=Date[_0x41a7ad(0x193)]()-_0x351017;console['log'](_0x41a7ad(0x163)+_0x3ad5fa['webhookUrl']+_0x41a7ad(0x16e)+_0x45d317[_0x41a7ad(0x1a9)]+'\x20('+_0xf25470+_0x41a7ad(0x1ba));}catch(_0x2eea33){console[_0x41a7ad(0x180)](_0x41a7ad(0x1bc),_0x2eea33);}}async[a13_0x356ccd(0x1c4)](_0x1b2119,_0x25bf2c){const _0x22dbf5=a13_0x356ccd;try{const {telegramBotService:_0x881dab}=await Promise[_0x22dbf5(0x174)]()[_0x22dbf5(0x1a3)](()=>__importStar(require('../services/telegramBotService'))),_0xbac0cd={'PAID':_0x22dbf5(0x198),'FAILED':_0x22dbf5(0x1b9)},_0x362df8=_0xbac0cd[_0x25bf2c];if(!_0x362df8)return;await _0x881dab[_0x22dbf5(0x1d3)](_0x1b2119[_0x22dbf5(0x1ad)],_0x1b2119,_0x362df8);}catch(_0x4c1a21){console[_0x22dbf5(0x180)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4c1a21);}}}exports[a13_0x356ccd(0x1af)]=TestGatewayController;function a13_0x1593(){const _0x2b557c=['ms)','✅\x20Test\x20Gateway\x20payment\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','prototype','__esModule','webhookService','parse','Payment\x20to\x20','default','✅\x20Payment\x20link\x20','sendPaymentStatusNotification','json','body','currency','gateway','getOwnPropertyNames','customerName','getOwnPropertyDescriptor','__importDefault','transactionId','\x20not\x20enabled\x20for\x20shop\x20','$transaction','Any\x20other\x20card\x20number','../services/gateways/testGatewayService','update','sendPaymentNotification','toLowerCase','WebhookService','FAILED','currentPayments','createdAt','321830SpBQDt','findUnique','100tUXKhO','7521642uIYeMn','📈\x20Found\x20payment\x20link\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','COMPLETED','customerEmail','slice','getPaymentForm','toISOString','webhookEvents','failureReason','successUrl','Any\x20name','payment.failed','\x20with\x20status\x20','get','2649380CwYHhl','\x20->\x20',',\x20cannot\x20process','Payment\x20is\x20not\x20for\x20test\x20gateway','resolve','sendShopWebhook','POST','154050sjsUGG','params','test_card','orderId','__setModuleDefault','type',':\x20type=','7MdoczF','replace','error','webhookUrl','stringify','settings','99318XhYzXQ','42GmPpqu','Payment\x20processed\x20successfully','test_gateway_','❌\x20Payment\x20link\x20','writable','log','includes','configurable','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','length','shop','gatewayPaymentId','0000','Payment\x20not\x20found','now','test_gateway','Any\x203-4\x20digits','Payment\x20failed','8777216cpejWV','paid','paymentLinkId','Error\x20parsing\x20webhook\x20events:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','create','Webhook\x20event\x20','defineProperty','name','../services/webhookService','testGatewayService','cardNumber','then','gatewayOrderId','payment','__importStar','4242\x204242\x204242\x204242','processCardPayment','status','../config/database','PENDING','failUrl','shopId','failureMessage','TestGatewayController','paymentLink','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','paidAt','amount','7005580YPDysf','processCard','PAID','payment.success','SINGLE','failed'];a13_0x1593=function(){return _0x2b557c;};return a13_0x1593();}