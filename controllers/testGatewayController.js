'use strict';const a13_0x2aeeac=a13_0x27b8;function a13_0x5755(){const _0x2331b0=['isArray','COMPLETED','getOwnPropertyNames','__createBinding','4242\x204242\x204242\x204242','orderId','__setModuleDefault','test_gateway_','Payment\x20processed\x20successfully','name','toISOString','\x20not\x20enabled\x20for\x20shop\x20','then','failUrl','json','payment','paid','defineProperty','Payment\x20failed','sendPaymentStatusNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','paymentMethod','257634MtAtmT','Test\x20Gateway\x20webhook\x20sent\x20to\x20','create','gatewayOrderId','‚ùå\x20Payment\x20link\x20','shopId','FAILED','successUrl','paymentLink','now','\x20->\x20','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','webhookLog','shop','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','sendShopWebhook','sendPaymentNotification','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','settings','cardNumber','../services/telegramBotService','failureReason','$transaction','status','cardLast4','test_gateway','prototype','resolve','Payment\x20not\x20found','createdAt','\x20with\x20status\x20','‚úÖ\x20Test\x20Gateway\x20payment\x20','amount','replace','paymentLinkId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerEmail','get',',\x20status=','3481245NgXgYi','currency','64805zAhRnn','length','includes','webhookEvents','gateway','Payment\x20status\x20is\x20','call','transactionId','Any\x20other\x20card\x20number','14owCYGQ','__importDefault','findUnique',':\x20type=','type','ms)','Any\x203-4\x20digits','currentPayments','log','__esModule','3346011yxjEPy','Payment\x20is\x20not\x20for\x20test\x20gateway','error','../config/database','writable','1944232sWaMIj','../services/gateways/testGatewayService','PENDING','Any\x20name','testGatewayService','application/json','\x20not\x20found','Error\x20parsing\x20webhook\x20events:','default','slice','test_card','PAID','hasOwnProperty','payment.success','payment.failed','paidAt','params','312239fnotJJ',',\x20cannot\x20process','../services/webhookService','configurable','2MUxfsr','toLowerCase','6573296KvYuBd','0000'];a13_0x5755=function(){return _0x2331b0;};return a13_0x5755();}(function(_0x24ddfc,_0x4d0006){const _0x1888f6=a13_0x27b8,_0xbd79e1=_0x24ddfc();while(!![]){try{const _0x176e74=parseInt(_0x1888f6(0x9e))/0x1+parseInt(_0x1888f6(0xa2))/0x2*(parseInt(_0x1888f6(0x88))/0x3)+-parseInt(_0x1888f6(0x8d))/0x4+parseInt(_0x1888f6(0xe6))/0x5+parseInt(_0x1888f6(0xbd))/0x6*(parseInt(_0x1888f6(0xef))/0x7)+-parseInt(_0x1888f6(0xa4))/0x8+parseInt(_0x1888f6(0xe4))/0x9;if(_0x176e74===_0x4d0006)break;else _0xbd79e1['push'](_0xbd79e1['shift']());}catch(_0x553a15){_0xbd79e1['push'](_0xbd79e1['shift']());}}}(a13_0x5755,0x93d3c));function a13_0x27b8(_0x3da27d,_0x482fc2){const _0x5755cc=a13_0x5755();return a13_0x27b8=function(_0x27b8ea,_0x5ce6bd){_0x27b8ea=_0x27b8ea-0x83;let _0x4b013a=_0x5755cc[_0x27b8ea];return _0x4b013a;},a13_0x27b8(_0x3da27d,_0x482fc2);}var __createBinding=this&&this[a13_0x2aeeac(0xa9)]||(Object[a13_0x2aeeac(0xbf)]?function(_0x2e76fe,_0x544526,_0x5f3f4e,_0x5df1ed){const _0x5f0023=a13_0x2aeeac;if(_0x5df1ed===undefined)_0x5df1ed=_0x5f3f4e;var _0x124e52=Object['getOwnPropertyDescriptor'](_0x544526,_0x5f3f4e);(!_0x124e52||(_0x5f0023(0xe2)in _0x124e52?!_0x544526[_0x5f0023(0x87)]:_0x124e52[_0x5f0023(0x8c)]||_0x124e52[_0x5f0023(0xa1)]))&&(_0x124e52={'enumerable':!![],'get':function(){return _0x544526[_0x5f3f4e];}}),Object[_0x5f0023(0xb7)](_0x2e76fe,_0x5df1ed,_0x124e52);}:function(_0x28a1a1,_0x50460a,_0x10229d,_0x1aca7d){if(_0x1aca7d===undefined)_0x1aca7d=_0x10229d;_0x28a1a1[_0x1aca7d]=_0x50460a[_0x10229d];}),__setModuleDefault=this&&this[a13_0x2aeeac(0xac)]||(Object['create']?function(_0x28a89c,_0x11738c){const _0x46a3d1=a13_0x2aeeac;Object[_0x46a3d1(0xb7)](_0x28a89c,_0x46a3d1(0x95),{'enumerable':!![],'value':_0x11738c});}:function(_0x36e671,_0x5d585b){const _0xe419ce=a13_0x2aeeac;_0x36e671[_0xe419ce(0x95)]=_0x5d585b;}),__importStar=this&&this['__importStar']||(function(){var _0x4441fd=function(_0x2f999d){const _0x2ad404=a13_0x27b8;return _0x4441fd=Object[_0x2ad404(0xa8)]||function(_0x5a5f1e){const _0x1043b5=_0x2ad404;var _0x3a7103=[];for(var _0x56971a in _0x5a5f1e)if(Object[_0x1043b5(0xd7)][_0x1043b5(0x99)][_0x1043b5(0xec)](_0x5a5f1e,_0x56971a))_0x3a7103[_0x3a7103[_0x1043b5(0xe7)]]=_0x56971a;return _0x3a7103;},_0x4441fd(_0x2f999d);};return function(_0xf1c126){const _0x2e71e1=a13_0x27b8;if(_0xf1c126&&_0xf1c126[_0x2e71e1(0x87)])return _0xf1c126;var _0x24386a={};if(_0xf1c126!=null){for(var _0x4fb3e9=_0x4441fd(_0xf1c126),_0x339a93=0x0;_0x339a93<_0x4fb3e9[_0x2e71e1(0xe7)];_0x339a93++)if(_0x4fb3e9[_0x339a93]!==_0x2e71e1(0x95))__createBinding(_0x24386a,_0xf1c126,_0x4fb3e9[_0x339a93]);}return __setModuleDefault(_0x24386a,_0xf1c126),_0x24386a;};}()),__importDefault=this&&this[a13_0x2aeeac(0xf0)]||function(_0x4f8a3d){return _0x4f8a3d&&_0x4f8a3d['__esModule']?_0x4f8a3d:{'default':_0x4f8a3d};};Object[a13_0x2aeeac(0xb7)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x2aeeac(0x8e)),webhookService_1=require(a13_0x2aeeac(0xa0)),database_1=__importDefault(require(a13_0x2aeeac(0x8b)));class TestGatewayController{constructor(){const _0x308359=a13_0x2aeeac;this['getPaymentForm']=async(_0x16727f,_0x4ae2bf,_0xcb044e)=>{const _0x2dfc3f=a13_0x27b8;try{const {paymentId:_0x48a147}=_0x16727f['params'];console[_0x2dfc3f(0x86)](_0x2dfc3f(0xc8)+_0x48a147);const _0x54670b=await database_1['default'][_0x2dfc3f(0xb5)][_0x2dfc3f(0xf1)]({'where':{'id':_0x48a147},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x54670b)return _0x4ae2bf[_0x2dfc3f(0xd4)](0x194)[_0x2dfc3f(0xb4)]({'success':![],'message':_0x2dfc3f(0xd9)});if(_0x54670b[_0x2dfc3f(0xea)]!==_0x2dfc3f(0xd6))return _0x4ae2bf[_0x2dfc3f(0xd4)](0x190)[_0x2dfc3f(0xb4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x54670b[_0x2dfc3f(0xd4)]!==_0x2dfc3f(0x8f))return _0x4ae2bf['status'](0x190)[_0x2dfc3f(0xb4)]({'success':![],'message':_0x2dfc3f(0xeb)+_0x54670b[_0x2dfc3f(0xd4)]+_0x2dfc3f(0x9f)});_0x4ae2bf[_0x2dfc3f(0xb4)]({'success':!![],'result':{'paymentId':_0x54670b['id'],'orderId':_0x54670b[_0x2dfc3f(0xc0)],'amount':_0x54670b[_0x2dfc3f(0xdd)],'currency':_0x54670b[_0x2dfc3f(0xe5)],'merchantName':_0x54670b[_0x2dfc3f(0xca)]['name'],'description':'Payment\x20to\x20'+_0x54670b[_0x2dfc3f(0xca)][_0x2dfc3f(0xaf)],'testInstructions':{'successCard':_0x2dfc3f(0xaa),'failureCard':_0x2dfc3f(0xee),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x2dfc3f(0x84),'holderName':_0x2dfc3f(0x90)}}});}catch(_0x10faf5){_0xcb044e(_0x10faf5);}},this['processCard']=async(_0x4c8fe7,_0x4d7261,_0x228d0d)=>{const _0x1e3f0b=a13_0x27b8;try{const {paymentId:_0x4ab851}=_0x4c8fe7[_0x1e3f0b(0x9d)],_0x480b03=_0x4c8fe7['body'];console[_0x1e3f0b(0x86)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4ab851);const _0x3003f9=await database_1[_0x1e3f0b(0x95)]['payment'][_0x1e3f0b(0xf1)]({'where':{'id':_0x4ab851},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3003f9)return _0x4d7261[_0x1e3f0b(0xd4)](0x194)[_0x1e3f0b(0xb4)]({'success':![],'message':_0x1e3f0b(0xd9)});if(_0x3003f9['gateway']!==_0x1e3f0b(0xd6))return _0x4d7261[_0x1e3f0b(0xd4)](0x190)[_0x1e3f0b(0xb4)]({'success':![],'message':_0x1e3f0b(0x89)});if(_0x3003f9['status']!==_0x1e3f0b(0x8f))return _0x4d7261['status'](0x190)[_0x1e3f0b(0xb4)]({'success':![],'message':_0x1e3f0b(0xeb)+_0x3003f9[_0x1e3f0b(0xd4)]+_0x1e3f0b(0x9f)});const _0x444b4d=await this[_0x1e3f0b(0x91)]['processCardPayment']({'paymentId':_0x3003f9['id'],'orderId':_0x3003f9[_0x1e3f0b(0xc0)]||_0x3003f9['id'],'amount':_0x3003f9['amount'],'currency':_0x3003f9[_0x1e3f0b(0xe5)],'cardData':_0x480b03});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x444b4d);const _0x1498b0={'status':_0x444b4d[_0x1e3f0b(0xd4)],'updatedAt':new Date()};if(_0x444b4d[_0x1e3f0b(0xd4)]===_0x1e3f0b(0x98))_0x1498b0[_0x1e3f0b(0x9c)]=new Date(),_0x1498b0['gatewayPaymentId']=_0x444b4d['transactionId'];else _0x444b4d[_0x1e3f0b(0xd4)]===_0x1e3f0b(0xc3)&&(_0x1498b0['failureMessage']=_0x444b4d[_0x1e3f0b(0xd2)]);const _0x44a043=_0x480b03[_0x1e3f0b(0xd0)][_0x1e3f0b(0xde)](/[\s-]/g,'');_0x1498b0[_0x1e3f0b(0xd5)]=_0x44a043[_0x1e3f0b(0x96)](-0x4),_0x1498b0[_0x1e3f0b(0xbc)]=_0x1e3f0b(0x97),await database_1[_0x1e3f0b(0x95)]['payment']['update']({'where':{'id':_0x3003f9['id']},'data':_0x1498b0});if(_0x444b4d[_0x1e3f0b(0xd4)]===_0x1e3f0b(0x98)&&_0x3003f9[_0x1e3f0b(0xdf)]){console[_0x1e3f0b(0x86)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x3003f9['id']+_0x1e3f0b(0xce));try{await database_1[_0x1e3f0b(0x95)][_0x1e3f0b(0xd3)](async _0xaff0ae=>{const _0xc918f6=_0x1e3f0b,_0x3d6f6f=await _0xaff0ae[_0xc918f6(0xc5)][_0xc918f6(0xf1)]({'where':{'id':_0x3003f9[_0xc918f6(0xdf)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3d6f6f){console[_0xc918f6(0x86)]('üìà\x20Found\x20payment\x20link\x20'+_0x3d6f6f['id']+_0xc918f6(0xf2)+_0x3d6f6f[_0xc918f6(0xf3)]+',\x20currentPayments='+_0x3d6f6f['currentPayments']+_0xc918f6(0xe3)+_0x3d6f6f[_0xc918f6(0xd4)]);const _0x206807=_0x3d6f6f[_0xc918f6(0x85)]+0x1,_0x103fc8=_0x3d6f6f[_0xc918f6(0xf3)]==='SINGLE'?_0xc918f6(0xa7):_0x3d6f6f[_0xc918f6(0xd4)];await _0xaff0ae[_0xc918f6(0xc5)]['update']({'where':{'id':_0x3003f9[_0xc918f6(0xdf)]},'data':{'currentPayments':_0x206807,'status':_0x103fc8,'updatedAt':new Date()}}),console[_0xc918f6(0x86)]('‚úÖ\x20Payment\x20link\x20'+_0x3d6f6f['id']+'\x20updated:\x20currentPayments='+_0x3d6f6f[_0xc918f6(0x85)]+_0xc918f6(0xc7)+_0x206807+_0xc918f6(0xe3)+_0x3d6f6f[_0xc918f6(0xd4)]+_0xc918f6(0xc7)+_0x103fc8);}else console[_0xc918f6(0x86)](_0xc918f6(0xc1)+_0x3003f9[_0xc918f6(0xdf)]+_0xc918f6(0x93));});}catch(_0x16fd70){console['error']('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x16fd70);}}await database_1[_0x1e3f0b(0x95)][_0x1e3f0b(0xc9)][_0x1e3f0b(0xbf)]({'data':{'paymentId':_0x3003f9['id'],'shopId':_0x3003f9[_0x1e3f0b(0xc2)],'event':_0x1e3f0b(0xad)+_0x444b4d[_0x1e3f0b(0xd4)][_0x1e3f0b(0xa3)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1e3f0b(0x8f),'newStatus':_0x444b4d[_0x1e3f0b(0xd4)],'transactionId':_0x444b4d['transactionId'],'failureReason':_0x444b4d[_0x1e3f0b(0xd2)],'processedAt':new Date()[_0x1e3f0b(0xb0)]()})}}),await this['sendShopWebhook'](_0x3003f9,_0x444b4d['status'],_0x444b4d[_0x1e3f0b(0xed)],_0x444b4d[_0x1e3f0b(0xd2)]),await this[_0x1e3f0b(0xb9)](_0x3003f9,_0x444b4d[_0x1e3f0b(0xd4)]),console[_0x1e3f0b(0x86)](_0x1e3f0b(0xdc)+_0x4ab851+'\x20processed:\x20'+_0x444b4d[_0x1e3f0b(0xd4)]),_0x444b4d['status']===_0x1e3f0b(0x98)?_0x4d7261[_0x1e3f0b(0xb4)]({'success':!![],'message':_0x1e3f0b(0xae),'result':{'status':_0x1e3f0b(0x98),'transactionId':_0x444b4d[_0x1e3f0b(0xed)],'redirectUrl':_0x3003f9[_0x1e3f0b(0xc4)]}}):_0x4d7261[_0x1e3f0b(0xd4)](0x190)[_0x1e3f0b(0xb4)]({'success':![],'message':_0x1e3f0b(0xb8),'result':{'status':_0x1e3f0b(0xc3),'failureReason':_0x444b4d[_0x1e3f0b(0xd2)],'redirectUrl':_0x3003f9[_0x1e3f0b(0xb3)]}});}catch(_0x116b7d){_0x228d0d(_0x116b7d);}},this[_0x308359(0x91)]=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1['WebhookService']();}async[a13_0x2aeeac(0xcc)](_0xde8c61,_0x1e7dd0,_0x4664a7,_0x3aefbe){const _0xeec16b=a13_0x2aeeac,_0xcc632a=Date['now']();try{const _0x171894=_0xde8c61['shop'],_0x21b0ae=_0x171894[_0xeec16b(0xcf)];if(!_0x21b0ae?.[_0xeec16b(0xbb)]){console[_0xeec16b(0x86)](_0xeec16b(0xba)+_0x171894['id']);return;}const _0x4963f4=_0x1e7dd0===_0xeec16b(0x98)?_0xeec16b(0x9a):_0xeec16b(0x9b);let _0x3cf60c=[];if(_0x21b0ae[_0xeec16b(0xe9)])try{_0x3cf60c=Array[_0xeec16b(0xa6)](_0x21b0ae[_0xeec16b(0xe9)])?_0x21b0ae[_0xeec16b(0xe9)]:JSON['parse'](_0x21b0ae['webhookEvents']);}catch(_0x272870){console[_0xeec16b(0x8a)](_0xeec16b(0x94),_0x272870),_0x3cf60c=[];}if(!_0x3cf60c[_0xeec16b(0xe8)](_0x4963f4)){console[_0xeec16b(0x86)]('Webhook\x20event\x20'+_0x4963f4+_0xeec16b(0xb1)+_0x171894['id']);return;}const _0x22d070={'event':_0x4963f4,'payment':{'id':_0xde8c61['id'],'order_id':_0xde8c61[_0xeec16b(0xab)],'gateway_order_id':_0xde8c61[_0xeec16b(0xc0)],'gateway':_0xeec16b(0xa5),'amount':_0xde8c61[_0xeec16b(0xdd)],'currency':_0xde8c61[_0xeec16b(0xe5)],'status':_0x1e7dd0[_0xeec16b(0xa3)](),'customer_email':_0xde8c61[_0xeec16b(0xe1)],'customer_name':_0xde8c61['customerName'],'transaction_id':_0x4664a7,'failure_message':_0x3aefbe,'created_at':_0xde8c61[_0xeec16b(0xda)],'updated_at':new Date()}},_0x192819=await fetch(_0x21b0ae['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0xeec16b(0x92),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x22d070)}),_0x2d35f7=Date[_0xeec16b(0xc6)]()-_0xcc632a;console[_0xeec16b(0x86)](_0xeec16b(0xbe)+_0x21b0ae[_0xeec16b(0xbb)]+_0xeec16b(0xdb)+_0x192819[_0xeec16b(0xd4)]+'\x20('+_0x2d35f7+_0xeec16b(0x83));}catch(_0x37c8f3){console[_0xeec16b(0x8a)](_0xeec16b(0xcb),_0x37c8f3);}}async['sendPaymentStatusNotification'](_0xfbff13,_0x5d165d){const _0x6535b4=a13_0x2aeeac;try{const {telegramBotService:_0x1d4d64}=await Promise[_0x6535b4(0xd8)]()[_0x6535b4(0xb2)](()=>__importStar(require(_0x6535b4(0xd1)))),_0x20b7d1={'PAID':_0x6535b4(0xb6),'FAILED':'failed'},_0x4a988a=_0x20b7d1[_0x5d165d];if(!_0x4a988a)return;await _0x1d4d64[_0x6535b4(0xcd)](_0xfbff13[_0x6535b4(0xc2)],_0xfbff13,_0x4a988a);}catch(_0x3a6eab){console[_0x6535b4(0x8a)](_0x6535b4(0xe0),_0x3a6eab);}}}exports['TestGatewayController']=TestGatewayController;