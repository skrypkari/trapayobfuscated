'use strict';const a13_0x212336=a13_0x16ed;(function(_0x68cf5d,_0x2867e3){const _0x589f4e=a13_0x16ed,_0x1c989f=_0x68cf5d();while(!![]){try{const _0x12afb2=parseInt(_0x589f4e(0x11c))/0x1+-parseInt(_0x589f4e(0x10b))/0x2+parseInt(_0x589f4e(0x12a))/0x3*(-parseInt(_0x589f4e(0x12e))/0x4)+parseInt(_0x589f4e(0x154))/0x5+parseInt(_0x589f4e(0x165))/0x6+-parseInt(_0x589f4e(0x11f))/0x7+-parseInt(_0x589f4e(0x168))/0x8*(-parseInt(_0x589f4e(0x16a))/0x9);if(_0x12afb2===_0x2867e3)break;else _0x1c989f['push'](_0x1c989f['shift']());}catch(_0x2347cd){_0x1c989f['push'](_0x1c989f['shift']());}}}(a13_0x37ee,0x6874f));function a13_0x16ed(_0x4222c5,_0x5dc474){const _0x37eea1=a13_0x37ee();return a13_0x16ed=function(_0x16ed02,_0x10abbe){_0x16ed02=_0x16ed02-0x10b;let _0x5eb891=_0x37eea1[_0x16ed02];return _0x5eb891;},a13_0x16ed(_0x4222c5,_0x5dc474);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x3d5954,_0x266b44,_0x1e70a1,_0x29ab8b){const _0x307007=a13_0x16ed;if(_0x29ab8b===undefined)_0x29ab8b=_0x1e70a1;var _0x446c89=Object['getOwnPropertyDescriptor'](_0x266b44,_0x1e70a1);(!_0x446c89||(_0x307007(0x153)in _0x446c89?!_0x266b44['__esModule']:_0x446c89[_0x307007(0x13e)]||_0x446c89[_0x307007(0x135)]))&&(_0x446c89={'enumerable':!![],'get':function(){return _0x266b44[_0x1e70a1];}}),Object[_0x307007(0x14c)](_0x3d5954,_0x29ab8b,_0x446c89);}:function(_0x38426c,_0x3bf211,_0xf6a81b,_0x5ba7cf){if(_0x5ba7cf===undefined)_0x5ba7cf=_0xf6a81b;_0x38426c[_0x5ba7cf]=_0x3bf211[_0xf6a81b];}),__setModuleDefault=this&&this[a13_0x212336(0x133)]||(Object[a13_0x212336(0x126)]?function(_0x5b96d6,_0x1be005){Object['defineProperty'](_0x5b96d6,'default',{'enumerable':!![],'value':_0x1be005});}:function(_0x41e169,_0x356e26){_0x41e169['default']=_0x356e26;}),__importStar=this&&this[a13_0x212336(0x132)]||(function(){var _0x4f3e42=function(_0x4b2717){const _0x13c273=a13_0x16ed;return _0x4f3e42=Object[_0x13c273(0x173)]||function(_0x8f8755){const _0x2d86d7=_0x13c273;var _0xd51a56=[];for(var _0x251a0e in _0x8f8755)if(Object[_0x2d86d7(0x16c)][_0x2d86d7(0x162)][_0x2d86d7(0x169)](_0x8f8755,_0x251a0e))_0xd51a56[_0xd51a56[_0x2d86d7(0x150)]]=_0x251a0e;return _0xd51a56;},_0x4f3e42(_0x4b2717);};return function(_0x2c7d1b){const _0xa20ca9=a13_0x16ed;if(_0x2c7d1b&&_0x2c7d1b[_0xa20ca9(0x131)])return _0x2c7d1b;var _0x3343e3={};if(_0x2c7d1b!=null){for(var _0x4c7d27=_0x4f3e42(_0x2c7d1b),_0x38f007=0x0;_0x38f007<_0x4c7d27[_0xa20ca9(0x150)];_0x38f007++)if(_0x4c7d27[_0x38f007]!==_0xa20ca9(0x11a))__createBinding(_0x3343e3,_0x2c7d1b,_0x4c7d27[_0x38f007]);}return __setModuleDefault(_0x3343e3,_0x2c7d1b),_0x3343e3;};}()),__importDefault=this&&this[a13_0x212336(0x15f)]||function(_0x1f19ad){const _0x23f69e=a13_0x212336;return _0x1f19ad&&_0x1f19ad[_0x23f69e(0x131)]?_0x1f19ad:{'default':_0x1f19ad};};Object[a13_0x212336(0x14c)](exports,a13_0x212336(0x131),{'value':!![]}),exports[a13_0x212336(0x119)]=void 0x0;function a13_0x37ee(){const _0x562fac=['log','WebhookService','PENDING','Payment\x20is\x20not\x20for\x20test\x20gateway','Payment\x20status\x20is\x20','TestGatewayController','default','status','765642OtbAbZ','stringify','Payment\x20processed\x20successfully','5430607eeGCOu','sendShopWebhook','createdAt','Any\x203-4\x20digits','name','resolve','failed','create','error','params','../services/gateways/testGatewayService','69987LquWEe','payment','body','gatewayPaymentId','68wNdszT','replace','POST','__esModule','__importStar','__setModuleDefault','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','configurable','customerName','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x20future\x20date\x20(MM/YY)','payment.success','slice','sendPaymentNotification','FAILED','\x20processed:\x20','writable','shopId','cardNumber','test_gateway_','customerEmail','failUrl','webhookUrl','gateway','application/json','webhookService','test_card','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','toLowerCase','../services/telegramBotService','defineProperty','currency',',\x20cannot\x20process','Payment\x20not\x20found','length','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','shop','get','251375DSGnMz','json','transactionId','âœ…\x20Test\x20Gateway\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TestGatewayService','PAID','webhookLog','now','then','failureMessage','__importDefault','sendPaymentStatusNotification','testGatewayService','hasOwnProperty','processCardPayment','webhookEvents','5074950bADxni','Any\x20other\x20card\x20number','amount','136672NoUoQF','call','171KayMhd','test_gateway','prototype','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20with\x20status\x20','Error\x20parsing\x20webhook\x20events:','cardLast4','payment.failed','failureReason','getOwnPropertyNames','772178rRTfgu','\x20not\x20enabled\x20for\x20shop\x20','parse','findUnique','update','orderId','0000','gatewayOrderId','isArray'];a13_0x37ee=function(){return _0x562fac;};return a13_0x37ee();}const testGatewayService_1=require(a13_0x212336(0x129)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x51fe45=a13_0x212336;this['getPaymentForm']=async(_0x390c73,_0x348678,_0x2b492c)=>{const _0x2574c9=a13_0x16ed;try{const {paymentId:_0x5e05fb}=_0x390c73[_0x2574c9(0x128)];console[_0x2574c9(0x114)](_0x2574c9(0x134)+_0x5e05fb);const _0x566682=await database_1[_0x2574c9(0x11a)]['payment'][_0x2574c9(0x10e)]({'where':{'id':_0x5e05fb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x566682)return _0x348678[_0x2574c9(0x11b)](0x194)[_0x2574c9(0x155)]({'success':![],'message':_0x2574c9(0x14f)});if(_0x566682[_0x2574c9(0x145)]!==_0x2574c9(0x16b))return _0x348678['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x566682[_0x2574c9(0x11b)]!==_0x2574c9(0x116))return _0x348678['status'](0x190)[_0x2574c9(0x155)]({'success':![],'message':_0x2574c9(0x118)+_0x566682['status']+_0x2574c9(0x14e)});_0x348678[_0x2574c9(0x155)]({'success':!![],'result':{'paymentId':_0x566682['id'],'orderId':_0x566682[_0x2574c9(0x112)],'amount':_0x566682[_0x2574c9(0x167)],'currency':_0x566682[_0x2574c9(0x14d)],'merchantName':_0x566682[_0x2574c9(0x152)][_0x2574c9(0x123)],'description':'Payment\x20to\x20'+_0x566682['shop'][_0x2574c9(0x123)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x2574c9(0x166),'expiryDate':_0x2574c9(0x138),'cvc':_0x2574c9(0x122),'holderName':'Any\x20name'}}});}catch(_0x3eca09){_0x2b492c(_0x3eca09);}},this['processCard']=async(_0x5a6092,_0x113575,_0x4cecf1)=>{const _0x51f2b7=a13_0x16ed;try{const {paymentId:_0x568430}=_0x5a6092[_0x51f2b7(0x128)],_0x5ad21d=_0x5a6092[_0x51f2b7(0x12c)];console[_0x51f2b7(0x114)](_0x51f2b7(0x151)+_0x568430);const _0x1136cb=await database_1[_0x51f2b7(0x11a)][_0x51f2b7(0x12b)]['findUnique']({'where':{'id':_0x568430},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1136cb)return _0x113575[_0x51f2b7(0x11b)](0x194)[_0x51f2b7(0x155)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1136cb[_0x51f2b7(0x145)]!=='test_gateway')return _0x113575[_0x51f2b7(0x11b)](0x190)['json']({'success':![],'message':_0x51f2b7(0x117)});if(_0x1136cb[_0x51f2b7(0x11b)]!==_0x51f2b7(0x116))return _0x113575[_0x51f2b7(0x11b)](0x190)[_0x51f2b7(0x155)]({'success':![],'message':_0x51f2b7(0x118)+_0x1136cb[_0x51f2b7(0x11b)]+',\x20cannot\x20process'});const _0x59c3c5=await this[_0x51f2b7(0x161)][_0x51f2b7(0x163)]({'paymentId':_0x1136cb['id'],'orderId':_0x1136cb[_0x51f2b7(0x112)]||_0x1136cb['id'],'amount':_0x1136cb[_0x51f2b7(0x167)],'currency':_0x1136cb[_0x51f2b7(0x14d)],'cardData':_0x5ad21d});console[_0x51f2b7(0x114)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x59c3c5);const _0x2dd670={'status':_0x59c3c5[_0x51f2b7(0x11b)],'updatedAt':new Date()};if(_0x59c3c5[_0x51f2b7(0x11b)]==='PAID')_0x2dd670['paidAt']=new Date(),_0x2dd670[_0x51f2b7(0x12d)]=_0x59c3c5[_0x51f2b7(0x156)];else _0x59c3c5['status']===_0x51f2b7(0x13c)&&(_0x2dd670[_0x51f2b7(0x15e)]=_0x59c3c5[_0x51f2b7(0x172)]);const _0x16541e=_0x5ad21d[_0x51f2b7(0x140)][_0x51f2b7(0x12f)](/[\s-]/g,'');_0x2dd670[_0x51f2b7(0x170)]=_0x16541e[_0x51f2b7(0x13a)](-0x4),_0x2dd670['paymentMethod']=_0x51f2b7(0x148),await database_1['default'][_0x51f2b7(0x12b)][_0x51f2b7(0x10f)]({'where':{'id':_0x1136cb['id']},'data':_0x2dd670}),await database_1[_0x51f2b7(0x11a)][_0x51f2b7(0x15b)][_0x51f2b7(0x126)]({'data':{'paymentId':_0x1136cb['id'],'shopId':_0x1136cb[_0x51f2b7(0x13f)],'event':_0x51f2b7(0x141)+_0x59c3c5[_0x51f2b7(0x11b)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x51f2b7(0x11d)]({'oldStatus':_0x51f2b7(0x116),'newStatus':_0x59c3c5[_0x51f2b7(0x11b)],'transactionId':_0x59c3c5[_0x51f2b7(0x156)],'failureReason':_0x59c3c5[_0x51f2b7(0x172)],'processedAt':new Date()['toISOString']()})}}),await this[_0x51f2b7(0x120)](_0x1136cb,_0x59c3c5['status'],_0x59c3c5[_0x51f2b7(0x156)],_0x59c3c5[_0x51f2b7(0x172)]),await this[_0x51f2b7(0x160)](_0x1136cb,_0x59c3c5[_0x51f2b7(0x11b)]),console['log'](_0x51f2b7(0x157)+_0x568430+_0x51f2b7(0x13d)+_0x59c3c5[_0x51f2b7(0x11b)]),_0x59c3c5['status']==='PAID'?_0x113575[_0x51f2b7(0x155)]({'success':!![],'message':_0x51f2b7(0x11e),'result':{'status':'PAID','transactionId':_0x59c3c5[_0x51f2b7(0x156)],'redirectUrl':_0x1136cb['successUrl']}}):_0x113575[_0x51f2b7(0x11b)](0x190)[_0x51f2b7(0x155)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x51f2b7(0x13c),'failureReason':_0x59c3c5[_0x51f2b7(0x172)],'redirectUrl':_0x1136cb[_0x51f2b7(0x143)]}});}catch(_0x1651fe){_0x4cecf1(_0x1651fe);}},this[_0x51fe45(0x161)]=new testGatewayService_1[(_0x51fe45(0x159))](),this[_0x51fe45(0x147)]=new webhookService_1[(_0x51fe45(0x115))]();}async[a13_0x212336(0x120)](_0x1998db,_0x18be77,_0x31838c,_0x48fb91){const _0x481731=a13_0x212336,_0x4a304b=Date[_0x481731(0x15c)]();try{const _0x565f2a=_0x1998db['shop'],_0x2939b4=_0x565f2a['settings'];if(!_0x2939b4?.[_0x481731(0x144)]){console[_0x481731(0x114)](_0x481731(0x16d)+_0x565f2a['id']);return;}const _0x2e3b0a=_0x18be77===_0x481731(0x15a)?_0x481731(0x139):_0x481731(0x171);let _0x2bd8b2=[];if(_0x2939b4[_0x481731(0x164)])try{_0x2bd8b2=Array[_0x481731(0x113)](_0x2939b4[_0x481731(0x164)])?_0x2939b4[_0x481731(0x164)]:JSON[_0x481731(0x10d)](_0x2939b4[_0x481731(0x164)]);}catch(_0x3b8782){console[_0x481731(0x127)](_0x481731(0x16f),_0x3b8782),_0x2bd8b2=[];}if(!_0x2bd8b2['includes'](_0x2e3b0a)){console['log']('Webhook\x20event\x20'+_0x2e3b0a+_0x481731(0x10c)+_0x565f2a['id']);return;}const _0x3b85e3={'event':_0x2e3b0a,'payment':{'id':_0x1998db['id'],'order_id':_0x1998db[_0x481731(0x110)],'gateway_order_id':_0x1998db[_0x481731(0x112)],'gateway':_0x481731(0x111),'amount':_0x1998db['amount'],'currency':_0x1998db[_0x481731(0x14d)],'status':_0x18be77[_0x481731(0x14a)](),'customer_email':_0x1998db[_0x481731(0x142)],'customer_name':_0x1998db[_0x481731(0x136)],'transaction_id':_0x31838c,'failure_message':_0x48fb91,'created_at':_0x1998db[_0x481731(0x121)],'updated_at':new Date()}},_0x1efb75=await fetch(_0x2939b4[_0x481731(0x144)],{'method':_0x481731(0x130),'headers':{'Content-Type':_0x481731(0x146),'User-Agent':_0x481731(0x137)},'body':JSON[_0x481731(0x11d)](_0x3b85e3)}),_0x2397a9=Date[_0x481731(0x15c)]()-_0x4a304b;console[_0x481731(0x114)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2939b4[_0x481731(0x144)]+_0x481731(0x16e)+_0x1efb75['status']+'\x20('+_0x2397a9+'ms)');}catch(_0x143b53){console[_0x481731(0x127)](_0x481731(0x149),_0x143b53);}}async[a13_0x212336(0x160)](_0xa38259,_0xeb0adb){const _0x127cf9=a13_0x212336;try{const {telegramBotService:_0x2cb17f}=await Promise[_0x127cf9(0x124)]()[_0x127cf9(0x15d)](()=>__importStar(require(_0x127cf9(0x14b)))),_0xf345b2={'PAID':'paid','FAILED':_0x127cf9(0x125)},_0xf7f63e=_0xf345b2[_0xeb0adb];if(!_0xf7f63e)return;await _0x2cb17f[_0x127cf9(0x13b)](_0xa38259[_0x127cf9(0x13f)],_0xa38259,_0xf7f63e);}catch(_0x33bbb6){console['error'](_0x127cf9(0x158),_0x33bbb6);}}}exports['TestGatewayController']=TestGatewayController;