'use strict';function a20_0x4524(_0x3f7342,_0x56d136){_0x3f7342=_0x3f7342-0x119;const _0x440f67=a20_0x440f();let _0x452493=_0x440f67[_0x3f7342];return _0x452493;}function a20_0x440f(){const _0x81299d=['shopId','275QJmgoI','defineProperty','findUnique','Payment\x20not\x20found','shop','getPaymentForm',',\x20currentPayments=','status','9hPxJLN','error','__setModuleDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','name','\x20not\x20found','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','sha256','testGatewayService','518889gSEqsf','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','digest','includes','__createBinding','POST','payment.success','createdAt','__esModule','232845oNNmwx','webhookUrl','createHmac','default','PENDING','Payment\x20failed','cardLast4','1148385UTvUOe','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','6aKtmbo','Any\x20other\x20card\x20number','paymentLink','‚úÖ\x20Test\x20Gateway\x20payment\x20','amount','paymentLinkId','test_card','length','resolve','Payment\x20System/1.0\x20(Test\x20Gateway)','body','configurable','\x20->\x20','SINGLE','273254QmPdMW','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','params','customerName','currency','‚úÖ\x20Payment\x20link\x20','application/json','slice','../services/telegramBotService','now','../config/database','../services/gateways/testGatewayService','payment','crypto','12PkVRik','Payment\x20processed\x20successfully','ms)',',\x20status=','json','4242\x204242\x204242\x204242','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','successUrl','stringify',':\x20type=','not\x20configured','12iIuLDs','üß™\x20Test\x20Gateway\x20result:','isArray','\x20with\x20status\x20','toLowerCase','sendPaymentNotification','\x20processed:\x20','üìà\x20Found\x20payment\x20link\x20','call','__importStar','transactionId','Payment\x20to\x20','create','failureReason','sendPaymentStatusNotification','currentPayments','\x20not\x20enabled\x20for\x20shop\x20','webhookEvents','test_gateway','...','webhookLog','secretKey','customerEmail','TestGatewayController','writable','prototype','hex',',\x20cannot\x20process','payment.failed','then','üß™\x20Sending\x20webhook\x20to\x20','type','PAID','FAILED','COMPLETED','gateway','1202984rKQoZw','test_gateway_','gatewayOrderId','log','paidAt','get','üìà\x20Test\x20Gateway:\x20Payment\x20','‚ùå\x20Payment\x20link\x20','73410UqCcgt','5895192iHCpQi','hasOwnProperty','TestGatewayService','replace','settings','Payment\x20status\x20is\x20','update'];a20_0x440f=function(){return _0x81299d;};return a20_0x440f();}const a20_0xed1b03=a20_0x4524;(function(_0x40bb56,_0x6d8761){const _0x47f95d=a20_0x4524,_0x524f20=_0x40bb56();while(!![]){try{const _0x2e66e1=parseInt(_0x47f95d(0x188))/0x1+-parseInt(_0x47f95d(0x127))/0x2*(parseInt(_0x47f95d(0x136))/0x3)+-parseInt(_0x47f95d(0x141))/0x4*(-parseInt(_0x47f95d(0x191))/0x5)+-parseInt(_0x47f95d(0x119))/0x6*(parseInt(_0x47f95d(0x198))/0x7)+parseInt(_0x47f95d(0x165))/0x8*(parseInt(_0x47f95d(0x17e))/0x9)+parseInt(_0x47f95d(0x16d))/0xa*(-parseInt(_0x47f95d(0x176))/0xb)+parseInt(_0x47f95d(0x16e))/0xc;if(_0x2e66e1===_0x6d8761)break;else _0x524f20['push'](_0x524f20['shift']());}catch(_0x20096c){_0x524f20['push'](_0x524f20['shift']());}}}(a20_0x440f,0x63283));var __createBinding=this&&this[a20_0xed1b03(0x18c)]||(Object[a20_0xed1b03(0x14d)]?function(_0x51a0e3,_0x5aa509,_0x41a7ca,_0x48a3e2){const _0x216aba=a20_0xed1b03;if(_0x48a3e2===undefined)_0x48a3e2=_0x41a7ca;var _0x18d7a5=Object['getOwnPropertyDescriptor'](_0x5aa509,_0x41a7ca);(!_0x18d7a5||(_0x216aba(0x16a)in _0x18d7a5?!_0x5aa509[_0x216aba(0x190)]:_0x18d7a5[_0x216aba(0x159)]||_0x18d7a5[_0x216aba(0x124)]))&&(_0x18d7a5={'enumerable':!![],'get':function(){return _0x5aa509[_0x41a7ca];}}),Object[_0x216aba(0x177)](_0x51a0e3,_0x48a3e2,_0x18d7a5);}:function(_0xee8f55,_0x5b93a7,_0x357d74,_0x7642fd){if(_0x7642fd===undefined)_0x7642fd=_0x357d74;_0xee8f55[_0x7642fd]=_0x5b93a7[_0x357d74];}),__setModuleDefault=this&&this[a20_0xed1b03(0x180)]||(Object[a20_0xed1b03(0x14d)]?function(_0x366639,_0x4ba6c5){const _0x4951c1=a20_0xed1b03;Object[_0x4951c1(0x177)](_0x366639,'default',{'enumerable':!![],'value':_0x4ba6c5});}:function(_0x5c282f,_0x1cda3f){const _0x5625a3=a20_0xed1b03;_0x5c282f[_0x5625a3(0x194)]=_0x1cda3f;}),__importStar=this&&this[a20_0xed1b03(0x14a)]||(function(){var _0x553451=function(_0x2c9c3e){return _0x553451=Object['getOwnPropertyNames']||function(_0x5a13db){const _0x4c277b=a20_0x4524;var _0x53eb02=[];for(var _0x14dd94 in _0x5a13db)if(Object[_0x4c277b(0x15a)][_0x4c277b(0x16f)][_0x4c277b(0x149)](_0x5a13db,_0x14dd94))_0x53eb02[_0x53eb02[_0x4c277b(0x120)]]=_0x14dd94;return _0x53eb02;},_0x553451(_0x2c9c3e);};return function(_0x2f5cff){const _0x4c1cbf=a20_0x4524;if(_0x2f5cff&&_0x2f5cff['__esModule'])return _0x2f5cff;var _0x2e4d7e={};if(_0x2f5cff!=null){for(var _0x15e39e=_0x553451(_0x2f5cff),_0x2e1a19=0x0;_0x2e1a19<_0x15e39e[_0x4c1cbf(0x120)];_0x2e1a19++)if(_0x15e39e[_0x2e1a19]!==_0x4c1cbf(0x194))__createBinding(_0x2e4d7e,_0x2f5cff,_0x15e39e[_0x2e1a19]);}return __setModuleDefault(_0x2e4d7e,_0x2f5cff),_0x2e4d7e;};}()),__importDefault=this&&this['__importDefault']||function(_0x507c32){const _0xc518d=a20_0xed1b03;return _0x507c32&&_0x507c32[_0xc518d(0x190)]?_0x507c32:{'default':_0x507c32};};Object[a20_0xed1b03(0x177)](exports,'__esModule',{'value':!![]}),exports[a20_0xed1b03(0x158)]=void 0x0;const crypto_1=__importDefault(require(a20_0xed1b03(0x135))),testGatewayService_1=require(a20_0xed1b03(0x133)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a20_0xed1b03(0x132)));class TestGatewayController{constructor(){const _0x33f09e=a20_0xed1b03;this[_0x33f09e(0x17b)]=async(_0x452ee5,_0x5d0fcc,_0x169062)=>{const _0x22be1f=_0x33f09e;try{const {paymentId:_0x50f748}=_0x452ee5['params'];console[_0x22be1f(0x168)](_0x22be1f(0x189)+_0x50f748);const _0x4a4ec3=await database_1['default'][_0x22be1f(0x134)][_0x22be1f(0x178)]({'where':{'id':_0x50f748},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4a4ec3)return _0x5d0fcc['status'](0x194)[_0x22be1f(0x13a)]({'success':![],'message':_0x22be1f(0x179)});if(_0x4a4ec3[_0x22be1f(0x164)]!==_0x22be1f(0x153))return _0x5d0fcc[_0x22be1f(0x17d)](0x190)[_0x22be1f(0x13a)]({'success':![],'message':_0x22be1f(0x181)});if(_0x4a4ec3[_0x22be1f(0x17d)]!==_0x22be1f(0x195))return _0x5d0fcc[_0x22be1f(0x17d)](0x190)[_0x22be1f(0x13a)]({'success':![],'message':_0x22be1f(0x173)+_0x4a4ec3[_0x22be1f(0x17d)]+',\x20cannot\x20process'});_0x5d0fcc[_0x22be1f(0x13a)]({'success':!![],'result':{'paymentId':_0x4a4ec3['id'],'orderId':_0x4a4ec3[_0x22be1f(0x167)],'amount':_0x4a4ec3[_0x22be1f(0x11d)],'currency':_0x4a4ec3[_0x22be1f(0x12c)],'merchantName':_0x4a4ec3['shop'][_0x22be1f(0x183)],'description':_0x22be1f(0x14c)+_0x4a4ec3['shop'][_0x22be1f(0x183)],'testInstructions':{'successCard':_0x22be1f(0x13b),'failureCard':_0x22be1f(0x11a),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x5c9356){_0x169062(_0x5c9356);}},this['processCard']=async(_0x182922,_0x436218,_0x18e67f)=>{const _0x1e38ec=_0x33f09e;try{const {paymentId:_0x37b7c2}=_0x182922[_0x1e38ec(0x12a)],_0x2043b7=_0x182922[_0x1e38ec(0x123)];console[_0x1e38ec(0x168)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x37b7c2);const _0x566524=await database_1[_0x1e38ec(0x194)]['payment'][_0x1e38ec(0x178)]({'where':{'id':_0x37b7c2},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x566524)return _0x436218[_0x1e38ec(0x17d)](0x194)[_0x1e38ec(0x13a)]({'success':![],'message':_0x1e38ec(0x179)});if(_0x566524[_0x1e38ec(0x164)]!==_0x1e38ec(0x153))return _0x436218[_0x1e38ec(0x17d)](0x190)[_0x1e38ec(0x13a)]({'success':![],'message':_0x1e38ec(0x181)});if(_0x566524[_0x1e38ec(0x17d)]!==_0x1e38ec(0x195))return _0x436218[_0x1e38ec(0x17d)](0x190)[_0x1e38ec(0x13a)]({'success':![],'message':_0x1e38ec(0x173)+_0x566524[_0x1e38ec(0x17d)]+_0x1e38ec(0x15c)});const _0xe38736=await this['testGatewayService']['processCardPayment']({'paymentId':_0x566524['id'],'orderId':_0x566524[_0x1e38ec(0x167)]||_0x566524['id'],'amount':_0x566524['amount'],'currency':_0x566524['currency'],'cardData':_0x2043b7});console['log'](_0x1e38ec(0x142),_0xe38736);const _0x2d3c20={'status':_0xe38736[_0x1e38ec(0x17d)],'updatedAt':new Date()};if(_0xe38736[_0x1e38ec(0x17d)]===_0x1e38ec(0x161))_0x2d3c20[_0x1e38ec(0x169)]=new Date(),_0x2d3c20['gatewayPaymentId']=_0xe38736[_0x1e38ec(0x14b)];else _0xe38736[_0x1e38ec(0x17d)]===_0x1e38ec(0x162)&&(_0x2d3c20['failureMessage']=_0xe38736['failureReason']);const _0x57e2a5=_0x2043b7['cardNumber'][_0x1e38ec(0x171)](/[\s-]/g,'');_0x2d3c20[_0x1e38ec(0x197)]=_0x57e2a5[_0x1e38ec(0x12f)](-0x4),_0x2d3c20['paymentMethod']=_0x1e38ec(0x11f),await database_1[_0x1e38ec(0x194)][_0x1e38ec(0x134)][_0x1e38ec(0x174)]({'where':{'id':_0x566524['id']},'data':_0x2d3c20});if(_0xe38736[_0x1e38ec(0x17d)]===_0x1e38ec(0x161)&&_0x566524[_0x1e38ec(0x11e)]){console[_0x1e38ec(0x168)](_0x1e38ec(0x16b)+_0x566524['id']+_0x1e38ec(0x185));try{await database_1[_0x1e38ec(0x194)]['$transaction'](async _0x5ea801=>{const _0x56bfc1=_0x1e38ec,_0x586965=await _0x5ea801[_0x56bfc1(0x11b)][_0x56bfc1(0x178)]({'where':{'id':_0x566524[_0x56bfc1(0x11e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x586965){console[_0x56bfc1(0x168)](_0x56bfc1(0x148)+_0x586965['id']+_0x56bfc1(0x13f)+_0x586965[_0x56bfc1(0x160)]+_0x56bfc1(0x17c)+_0x586965['currentPayments']+_0x56bfc1(0x139)+_0x586965['status']);const _0x1c116b=_0x586965[_0x56bfc1(0x150)]+0x1,_0x5e4e15=_0x586965[_0x56bfc1(0x160)]===_0x56bfc1(0x126)?_0x56bfc1(0x163):_0x586965[_0x56bfc1(0x17d)];await _0x5ea801[_0x56bfc1(0x11b)][_0x56bfc1(0x174)]({'where':{'id':_0x566524['paymentLinkId']},'data':{'currentPayments':_0x1c116b,'status':_0x5e4e15,'updatedAt':new Date()}}),console[_0x56bfc1(0x168)](_0x56bfc1(0x12d)+_0x586965['id']+'\x20updated:\x20currentPayments='+_0x586965[_0x56bfc1(0x150)]+'\x20->\x20'+_0x1c116b+',\x20status='+_0x586965[_0x56bfc1(0x17d)]+_0x56bfc1(0x125)+_0x5e4e15);}else console['log'](_0x56bfc1(0x16c)+_0x566524[_0x56bfc1(0x11e)]+_0x56bfc1(0x184));});}catch(_0x4c2613){console[_0x1e38ec(0x17f)](_0x1e38ec(0x182),_0x4c2613);}}await database_1['default'][_0x1e38ec(0x155)]['create']({'data':{'paymentId':_0x566524['id'],'shopId':_0x566524['shopId'],'event':_0x1e38ec(0x166)+_0xe38736[_0x1e38ec(0x17d)][_0x1e38ec(0x145)](),'statusCode':_0xe38736['status']===_0x1e38ec(0x161)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0xe38736[_0x1e38ec(0x17d)],'transactionId':_0xe38736[_0x1e38ec(0x14b)],'failureReason':_0xe38736[_0x1e38ec(0x14e)],'processedAt':new Date()['toISOString']()})}}),console[_0x1e38ec(0x168)](_0x1e38ec(0x13c)+_0xe38736['status']+_0x1e38ec(0x154)),await this['sendShopWebhook'](_0x566524,_0xe38736['status'],_0xe38736['transactionId'],_0xe38736[_0x1e38ec(0x14e)]),console[_0x1e38ec(0x168)](_0x1e38ec(0x129)+_0xe38736[_0x1e38ec(0x17d)]),console[_0x1e38ec(0x168)]('üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20'+_0xe38736['status']+_0x1e38ec(0x154)),await this['sendPaymentStatusNotification'](_0x566524,_0xe38736['status']),console['log']('üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20'+_0xe38736[_0x1e38ec(0x17d)]),console[_0x1e38ec(0x168)](_0x1e38ec(0x11c)+_0x37b7c2+_0x1e38ec(0x147)+_0xe38736[_0x1e38ec(0x17d)]),_0xe38736[_0x1e38ec(0x17d)]===_0x1e38ec(0x161)?_0x436218['json']({'success':!![],'message':_0x1e38ec(0x137),'result':{'status':_0x1e38ec(0x161),'transactionId':_0xe38736['transactionId'],'redirectUrl':_0x566524[_0x1e38ec(0x13d)]}}):_0x436218['status'](0x190)[_0x1e38ec(0x13a)]({'success':![],'message':_0x1e38ec(0x196),'result':{'status':'FAILED','failureReason':_0xe38736[_0x1e38ec(0x14e)],'redirectUrl':_0x566524['failUrl']}});}catch(_0x5e2416){_0x18e67f(_0x5e2416);}},this[_0x33f09e(0x187)]=new testGatewayService_1[(_0x33f09e(0x170))](),this['webhookService']=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x51726c,_0x421101,_0x780b17,_0x3c43a6){const _0xb87bad=a20_0xed1b03,_0xf5b1c1=Date[_0xb87bad(0x131)]();try{const _0x5c68df=_0x51726c[_0xb87bad(0x17a)],_0x59acf2=_0x5c68df[_0xb87bad(0x172)];if(!_0x59acf2?.[_0xb87bad(0x192)]){console[_0xb87bad(0x168)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5c68df['id']);return;}const _0x5dac9d=_0x421101===_0xb87bad(0x161)?_0xb87bad(0x18e):_0xb87bad(0x15d);console['log']('üß™\x20Test\x20Gateway\x20webhook:\x20event='+_0x5dac9d+',\x20webhookUrl='+(_0x59acf2[_0xb87bad(0x192)]?'configured':_0xb87bad(0x140)));let _0x3b9f6c=[];if(_0x59acf2['webhookEvents'])try{_0x3b9f6c=Array[_0xb87bad(0x143)](_0x59acf2['webhookEvents'])?_0x59acf2[_0xb87bad(0x152)]:JSON['parse'](_0x59acf2['webhookEvents']);}catch(_0x1b7f21){console['error']('Error\x20parsing\x20webhook\x20events:',_0x1b7f21),_0x3b9f6c=[];}console[_0xb87bad(0x168)](_0xb87bad(0x199),_0x3b9f6c);if(!_0x3b9f6c[_0xb87bad(0x18b)](_0x5dac9d)){console[_0xb87bad(0x168)]('‚ö†Ô∏è\x20Webhook\x20event\x20'+_0x5dac9d+_0xb87bad(0x151)+_0x5c68df['id']);return;}const _0xb3da3c={'event':_0x5dac9d,'payment':{'id':_0x51726c['id'],'order_id':_0x51726c['orderId'],'gateway_order_id':_0x51726c[_0xb87bad(0x167)],'gateway':'0000','amount':_0x51726c[_0xb87bad(0x11d)],'currency':_0x51726c[_0xb87bad(0x12c)],'status':_0x421101[_0xb87bad(0x145)](),'customer_email':_0x51726c[_0xb87bad(0x157)],'customer_name':_0x51726c[_0xb87bad(0x12b)],'transaction_id':_0x780b17,'failure_message':_0x3c43a6,'created_at':_0x51726c[_0xb87bad(0x18f)],'updated_at':new Date()}};console['log'](_0xb87bad(0x15f)+_0x59acf2[_0xb87bad(0x192)]+'...'),console[_0xb87bad(0x168)]('üß™\x20Webhook\x20payload:',JSON['stringify'](_0xb3da3c,null,0x2));const _0x4e9185=JSON[_0xb87bad(0x13e)](_0xb3da3c),_0xdc045d=crypto_1[_0xb87bad(0x194)][_0xb87bad(0x193)](_0xb87bad(0x186),_0x5c68df[_0xb87bad(0x156)])[_0xb87bad(0x174)](_0x4e9185)[_0xb87bad(0x18a)](_0xb87bad(0x15b)),_0x5a766e=await fetch(_0x59acf2[_0xb87bad(0x192)],{'method':_0xb87bad(0x18d),'headers':{'Content-Type':_0xb87bad(0x12e),'User-Agent':_0xb87bad(0x122),'X-Webhook-Signature':_0xdc045d},'body':_0x4e9185}),_0x6e0e23=Date[_0xb87bad(0x131)]()-_0xf5b1c1;console[_0xb87bad(0x168)]('‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x59acf2[_0xb87bad(0x192)]+_0xb87bad(0x144)+_0x5a766e[_0xb87bad(0x17d)]+'\x20('+_0x6e0e23+_0xb87bad(0x138));}catch(_0x107a90){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x107a90);}}async[a20_0xed1b03(0x14f)](_0x5d1c06,_0x16f34c){const _0x5bfffc=a20_0xed1b03;try{const {telegramBotService:_0x158291}=await Promise[_0x5bfffc(0x121)]()[_0x5bfffc(0x15e)](()=>__importStar(require(_0x5bfffc(0x130)))),_0x2bee1={'PAID':'paid','FAILED':'failed'},_0x4b118f=_0x2bee1[_0x16f34c];if(!_0x4b118f)return;await _0x158291[_0x5bfffc(0x146)](_0x5d1c06[_0x5bfffc(0x175)],_0x5d1c06,_0x4b118f);}catch(_0x3fabeb){console[_0x5bfffc(0x17f)](_0x5bfffc(0x128),_0x3fabeb);}}}exports[a20_0xed1b03(0x158)]=TestGatewayController;