'use strict';const a13_0x5a0808=a13_0x3105;function a13_0x1f50(){const _0x5b377a=['name',':\x20type=','type','processCardPayment','test_gateway','get','üìà\x20Found\x20payment\x20link\x20','__esModule','paymentLinkId','body','currentPayments','4242\x204242\x204242\x204242','Any\x20name','transactionId','status','error','80eUaCje','../services/gateways/testGatewayService','../services/telegramBotService','üìà\x20Test\x20Gateway:\x20Payment\x20','TestGatewayService','1475325PSVBTS','shopId','PENDING','Payment\x20to\x20','sendPaymentStatusNotification','paid','toISOString','sendShopWebhook','gatewayOrderId','Webhook\x20event\x20','8442gTbMrV','call','successUrl','amount','__importStar','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','payment.success','1833524BPlGwG','FAILED','Error\x20parsing\x20webhook\x20events:','parse','webhookEvents','\x20updated:\x20currentPayments=','1984NCdreV','PAID','\x20not\x20found','../config/database','payment','WebhookService','orderId','cardLast4','webhookLog','getPaymentForm','Any\x20future\x20date\x20(MM/YY)','processCard','Payment\x20is\x20not\x20for\x20test\x20gateway','replace','1nagPup',',\x20currentPayments=','configurable','gateway','isArray','create','testGatewayService','0000','sendPaymentNotification','findUnique','getOwnPropertyDescriptor','\x20->\x20','Payment\x20failed','951655HipnpZ','paymentMethod','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','6kGGcHN','default','paymentLink','customerEmail','Payment\x20status\x20is\x20','defineProperty','then','POST','webhookService','customerName','stringify','length','json',',\x20cannot\x20process','\x20processed:\x20','../services/webhookService','failureReason','SINGLE','\x20with\x20status\x20','1257OvfKUA','payment.failed','test_card','failUrl','Payment\x20not\x20found','params','webhookUrl',',\x20status=','__createBinding','slice','10ElGFkg','Payment\x20processed\x20successfully','__setModuleDefault','5041368UNulqu','shop','failureMessage','__importDefault','Any\x203-4\x20digits','üß™\x20Test\x20Gateway\x20result:','‚úÖ\x20Test\x20Gateway\x20payment\x20','update','Any\x20other\x20card\x20number','currency','test_gateway_','COMPLETED','250626JInpvj','TestGatewayController','log'];a13_0x1f50=function(){return _0x5b377a;};return a13_0x1f50();}function a13_0x3105(_0x392bb9,_0x5bbb5d){const _0x1f5084=a13_0x1f50();return a13_0x3105=function(_0x3105d5,_0xd94007){_0x3105d5=_0x3105d5-0x13b;let _0x32e027=_0x1f5084[_0x3105d5];return _0x32e027;},a13_0x3105(_0x392bb9,_0x5bbb5d);}(function(_0x50341a,_0x300154){const _0x3de026=a13_0x3105,_0x3cef50=_0x50341a();while(!![]){try{const _0x554fbe=-parseInt(_0x3de026(0x19b))/0x1*(-parseInt(_0x3de026(0x15e))/0x2)+parseInt(_0x3de026(0x145))/0x3*(parseInt(_0x3de026(0x18d))/0x4)+parseInt(_0x3de026(0x1a8))/0x5*(parseInt(_0x3de026(0x1ab))/0x6)+parseInt(_0x3de026(0x180))/0x7*(parseInt(_0x3de026(0x171))/0x8)+-parseInt(_0x3de026(0x176))/0x9*(-parseInt(_0x3de026(0x14f))/0xa)+-parseInt(_0x3de026(0x187))/0xb+-parseInt(_0x3de026(0x152))/0xc;if(_0x554fbe===_0x300154)break;else _0x3cef50['push'](_0x3cef50['shift']());}catch(_0xe70ee3){_0x3cef50['push'](_0x3cef50['shift']());}}}(a13_0x1f50,0x1b80f));var __createBinding=this&&this[a13_0x5a0808(0x14d)]||(Object[a13_0x5a0808(0x1a0)]?function(_0x45e17d,_0x20c733,_0x53bbd5,_0x401740){const _0x3bce7f=a13_0x5a0808;if(_0x401740===undefined)_0x401740=_0x53bbd5;var _0x553dc5=Object[_0x3bce7f(0x1a5)](_0x20c733,_0x53bbd5);(!_0x553dc5||(_0x3bce7f(0x166)in _0x553dc5?!_0x20c733['__esModule']:_0x553dc5['writable']||_0x553dc5[_0x3bce7f(0x19d)]))&&(_0x553dc5={'enumerable':!![],'get':function(){return _0x20c733[_0x53bbd5];}}),Object[_0x3bce7f(0x1b0)](_0x45e17d,_0x401740,_0x553dc5);}:function(_0x49a9b2,_0x40d0be,_0x3214d6,_0x21330e){if(_0x21330e===undefined)_0x21330e=_0x3214d6;_0x49a9b2[_0x21330e]=_0x40d0be[_0x3214d6];}),__setModuleDefault=this&&this[a13_0x5a0808(0x151)]||(Object['create']?function(_0x116590,_0x4e3042){const _0x3b7c3c=a13_0x5a0808;Object[_0x3b7c3c(0x1b0)](_0x116590,_0x3b7c3c(0x1ac),{'enumerable':!![],'value':_0x4e3042});}:function(_0x55a963,_0x31d5fc){const _0x4ba2ec=a13_0x5a0808;_0x55a963[_0x4ba2ec(0x1ac)]=_0x31d5fc;}),__importStar=this&&this[a13_0x5a0808(0x184)]||(function(){var _0x3ab612=function(_0x479db8){return _0x3ab612=Object['getOwnPropertyNames']||function(_0x3ee3de){const _0x25c154=a13_0x3105;var _0x414eb8=[];for(var _0x21a335 in _0x3ee3de)if(Object['prototype']['hasOwnProperty'][_0x25c154(0x181)](_0x3ee3de,_0x21a335))_0x414eb8[_0x414eb8[_0x25c154(0x13d)]]=_0x21a335;return _0x414eb8;},_0x3ab612(_0x479db8);};return function(_0xf42c18){const _0x2828ce=a13_0x3105;if(_0xf42c18&&_0xf42c18[_0x2828ce(0x168)])return _0xf42c18;var _0x1a2dda={};if(_0xf42c18!=null){for(var _0x8ac605=_0x3ab612(_0xf42c18),_0x46d822=0x0;_0x46d822<_0x8ac605[_0x2828ce(0x13d)];_0x46d822++)if(_0x8ac605[_0x46d822]!==_0x2828ce(0x1ac))__createBinding(_0x1a2dda,_0xf42c18,_0x8ac605[_0x46d822]);}return __setModuleDefault(_0x1a2dda,_0xf42c18),_0x1a2dda;};}()),__importDefault=this&&this[a13_0x5a0808(0x155)]||function(_0x5c1afa){const _0x3589a1=a13_0x5a0808;return _0x5c1afa&&_0x5c1afa[_0x3589a1(0x168)]?_0x5c1afa:{'default':_0x5c1afa};};Object['defineProperty'](exports,a13_0x5a0808(0x168),{'value':!![]}),exports[a13_0x5a0808(0x15f)]=void 0x0;const testGatewayService_1=require(a13_0x5a0808(0x172)),webhookService_1=require(a13_0x5a0808(0x141)),database_1=__importDefault(require(a13_0x5a0808(0x190)));class TestGatewayController{constructor(){const _0x41f068=a13_0x5a0808;this[_0x41f068(0x196)]=async(_0x249427,_0x140a01,_0x577e61)=>{const _0x1aa9a4=_0x41f068;try{const {paymentId:_0x37fa80}=_0x249427[_0x1aa9a4(0x14a)];console[_0x1aa9a4(0x160)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x37fa80);const _0x587d52=await database_1['default']['payment'][_0x1aa9a4(0x1a4)]({'where':{'id':_0x37fa80},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x587d52)return _0x140a01[_0x1aa9a4(0x16f)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x587d52[_0x1aa9a4(0x19e)]!==_0x1aa9a4(0x165))return _0x140a01[_0x1aa9a4(0x16f)](0x190)[_0x1aa9a4(0x13e)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x587d52[_0x1aa9a4(0x16f)]!==_0x1aa9a4(0x178))return _0x140a01['status'](0x190)['json']({'success':![],'message':_0x1aa9a4(0x1af)+_0x587d52[_0x1aa9a4(0x16f)]+_0x1aa9a4(0x13f)});_0x140a01[_0x1aa9a4(0x13e)]({'success':!![],'result':{'paymentId':_0x587d52['id'],'orderId':_0x587d52[_0x1aa9a4(0x17e)],'amount':_0x587d52[_0x1aa9a4(0x183)],'currency':_0x587d52['currency'],'merchantName':_0x587d52[_0x1aa9a4(0x153)]['name'],'description':_0x1aa9a4(0x179)+_0x587d52['shop'][_0x1aa9a4(0x161)],'testInstructions':{'successCard':_0x1aa9a4(0x16c),'failureCard':_0x1aa9a4(0x15a),'expiryDate':_0x1aa9a4(0x197),'cvc':_0x1aa9a4(0x156),'holderName':_0x1aa9a4(0x16d)}}});}catch(_0x2c7ff9){_0x577e61(_0x2c7ff9);}},this[_0x41f068(0x198)]=async(_0x4886c0,_0x418015,_0x4ec250)=>{const _0x7da489=_0x41f068;try{const {paymentId:_0x5c8aee}=_0x4886c0[_0x7da489(0x14a)],_0x5409dc=_0x4886c0[_0x7da489(0x16a)];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x5c8aee);const _0x217797=await database_1[_0x7da489(0x1ac)][_0x7da489(0x191)][_0x7da489(0x1a4)]({'where':{'id':_0x5c8aee},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x217797)return _0x418015[_0x7da489(0x16f)](0x194)[_0x7da489(0x13e)]({'success':![],'message':_0x7da489(0x149)});if(_0x217797[_0x7da489(0x19e)]!==_0x7da489(0x165))return _0x418015['status'](0x190)[_0x7da489(0x13e)]({'success':![],'message':_0x7da489(0x199)});if(_0x217797[_0x7da489(0x16f)]!==_0x7da489(0x178))return _0x418015[_0x7da489(0x16f)](0x190)['json']({'success':![],'message':_0x7da489(0x1af)+_0x217797['status']+',\x20cannot\x20process'});const _0x5f1533=await this[_0x7da489(0x1a1)][_0x7da489(0x164)]({'paymentId':_0x217797['id'],'orderId':_0x217797[_0x7da489(0x17e)]||_0x217797['id'],'amount':_0x217797['amount'],'currency':_0x217797[_0x7da489(0x15b)],'cardData':_0x5409dc});console[_0x7da489(0x160)](_0x7da489(0x157),_0x5f1533);const _0x369044={'status':_0x5f1533[_0x7da489(0x16f)],'updatedAt':new Date()};if(_0x5f1533[_0x7da489(0x16f)]===_0x7da489(0x18e))_0x369044['paidAt']=new Date(),_0x369044['gatewayPaymentId']=_0x5f1533[_0x7da489(0x16e)];else _0x5f1533['status']===_0x7da489(0x188)&&(_0x369044[_0x7da489(0x154)]=_0x5f1533[_0x7da489(0x142)]);const _0x906c0a=_0x5409dc['cardNumber'][_0x7da489(0x19a)](/[\s-]/g,'');_0x369044[_0x7da489(0x194)]=_0x906c0a[_0x7da489(0x14e)](-0x4),_0x369044[_0x7da489(0x1a9)]=_0x7da489(0x147),await database_1[_0x7da489(0x1ac)]['payment'][_0x7da489(0x159)]({'where':{'id':_0x217797['id']},'data':_0x369044});if(_0x5f1533['status']===_0x7da489(0x18e)&&_0x217797[_0x7da489(0x169)]){console[_0x7da489(0x160)](_0x7da489(0x174)+_0x217797['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x7da489(0x1ac)]['$transaction'](async _0x52c5fa=>{const _0x2df3e7=_0x7da489,_0x31fe3f=await _0x52c5fa[_0x2df3e7(0x1ad)][_0x2df3e7(0x1a4)]({'where':{'id':_0x217797[_0x2df3e7(0x169)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x31fe3f){console[_0x2df3e7(0x160)](_0x2df3e7(0x167)+_0x31fe3f['id']+_0x2df3e7(0x162)+_0x31fe3f[_0x2df3e7(0x163)]+_0x2df3e7(0x19c)+_0x31fe3f[_0x2df3e7(0x16b)]+_0x2df3e7(0x14c)+_0x31fe3f[_0x2df3e7(0x16f)]);const _0x30c1bd=_0x31fe3f[_0x2df3e7(0x16b)]+0x1,_0x488ac9=_0x31fe3f[_0x2df3e7(0x163)]===_0x2df3e7(0x143)?_0x2df3e7(0x15d):_0x31fe3f['status'];await _0x52c5fa['paymentLink'][_0x2df3e7(0x159)]({'where':{'id':_0x217797[_0x2df3e7(0x169)]},'data':{'currentPayments':_0x30c1bd,'status':_0x488ac9,'updatedAt':new Date()}}),console[_0x2df3e7(0x160)]('‚úÖ\x20Payment\x20link\x20'+_0x31fe3f['id']+_0x2df3e7(0x18c)+_0x31fe3f['currentPayments']+_0x2df3e7(0x1a6)+_0x30c1bd+_0x2df3e7(0x14c)+_0x31fe3f[_0x2df3e7(0x16f)]+_0x2df3e7(0x1a6)+_0x488ac9);}else console[_0x2df3e7(0x160)]('‚ùå\x20Payment\x20link\x20'+_0x217797[_0x2df3e7(0x169)]+_0x2df3e7(0x18f));});}catch(_0x1bce71){console[_0x7da489(0x170)](_0x7da489(0x1aa),_0x1bce71);}}await database_1[_0x7da489(0x1ac)][_0x7da489(0x195)]['create']({'data':{'paymentId':_0x217797['id'],'shopId':_0x217797[_0x7da489(0x177)],'event':_0x7da489(0x15c)+_0x5f1533[_0x7da489(0x16f)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x7da489(0x13c)]({'oldStatus':'PENDING','newStatus':_0x5f1533['status'],'transactionId':_0x5f1533[_0x7da489(0x16e)],'failureReason':_0x5f1533[_0x7da489(0x142)],'processedAt':new Date()[_0x7da489(0x17c)]()})}}),await this['sendShopWebhook'](_0x217797,_0x5f1533[_0x7da489(0x16f)],_0x5f1533[_0x7da489(0x16e)],_0x5f1533['failureReason']),await this[_0x7da489(0x17a)](_0x217797,_0x5f1533[_0x7da489(0x16f)]),console['log'](_0x7da489(0x158)+_0x5c8aee+_0x7da489(0x140)+_0x5f1533[_0x7da489(0x16f)]),_0x5f1533['status']===_0x7da489(0x18e)?_0x418015['json']({'success':!![],'message':_0x7da489(0x150),'result':{'status':_0x7da489(0x18e),'transactionId':_0x5f1533[_0x7da489(0x16e)],'redirectUrl':_0x217797[_0x7da489(0x182)]}}):_0x418015[_0x7da489(0x16f)](0x190)[_0x7da489(0x13e)]({'success':![],'message':_0x7da489(0x1a7),'result':{'status':_0x7da489(0x188),'failureReason':_0x5f1533[_0x7da489(0x142)],'redirectUrl':_0x217797[_0x7da489(0x148)]}});}catch(_0x4be672){_0x4ec250(_0x4be672);}},this[_0x41f068(0x1a1)]=new testGatewayService_1[(_0x41f068(0x175))](),this[_0x41f068(0x1b3)]=new webhookService_1[(_0x41f068(0x192))]();}async[a13_0x5a0808(0x17d)](_0x2d5846,_0x2e48a1,_0x52d18e,_0x3dfcba){const _0x54cf7a=a13_0x5a0808,_0x5cecf7=Date['now']();try{const _0x2c1872=_0x2d5846[_0x54cf7a(0x153)],_0x2f2822=_0x2c1872['settings'];if(!_0x2f2822?.[_0x54cf7a(0x14b)]){console[_0x54cf7a(0x160)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2c1872['id']);return;}const _0x1f287f=_0x2e48a1===_0x54cf7a(0x18e)?_0x54cf7a(0x186):_0x54cf7a(0x146);let _0x2de1f5=[];if(_0x2f2822['webhookEvents'])try{_0x2de1f5=Array[_0x54cf7a(0x19f)](_0x2f2822['webhookEvents'])?_0x2f2822[_0x54cf7a(0x18b)]:JSON[_0x54cf7a(0x18a)](_0x2f2822[_0x54cf7a(0x18b)]);}catch(_0x39d4c5){console[_0x54cf7a(0x170)](_0x54cf7a(0x189),_0x39d4c5),_0x2de1f5=[];}if(!_0x2de1f5['includes'](_0x1f287f)){console['log'](_0x54cf7a(0x17f)+_0x1f287f+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2c1872['id']);return;}const _0x8c48f1={'event':_0x1f287f,'payment':{'id':_0x2d5846['id'],'order_id':_0x2d5846[_0x54cf7a(0x193)],'gateway_order_id':_0x2d5846['gatewayOrderId'],'gateway':_0x54cf7a(0x1a2),'amount':_0x2d5846[_0x54cf7a(0x183)],'currency':_0x2d5846[_0x54cf7a(0x15b)],'status':_0x2e48a1['toLowerCase'](),'customer_email':_0x2d5846[_0x54cf7a(0x1ae)],'customer_name':_0x2d5846[_0x54cf7a(0x13b)],'transaction_id':_0x52d18e,'failure_message':_0x3dfcba,'created_at':_0x2d5846['createdAt'],'updated_at':new Date()}},_0x21343a=await fetch(_0x2f2822[_0x54cf7a(0x14b)],{'method':_0x54cf7a(0x1b2),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x54cf7a(0x13c)](_0x8c48f1)}),_0x4df275=Date['now']()-_0x5cecf7;console[_0x54cf7a(0x160)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2f2822['webhookUrl']+_0x54cf7a(0x144)+_0x21343a[_0x54cf7a(0x16f)]+'\x20('+_0x4df275+'ms)');}catch(_0x176426){console[_0x54cf7a(0x170)](_0x54cf7a(0x185),_0x176426);}}async[a13_0x5a0808(0x17a)](_0x41ee4e,_0x3a5c3f){const _0x251e58=a13_0x5a0808;try{const {telegramBotService:_0x38649e}=await Promise['resolve']()[_0x251e58(0x1b1)](()=>__importStar(require(_0x251e58(0x173)))),_0x4e7aad={'PAID':_0x251e58(0x17b),'FAILED':'failed'},_0x1364d0=_0x4e7aad[_0x3a5c3f];if(!_0x1364d0)return;await _0x38649e[_0x251e58(0x1a3)](_0x41ee4e[_0x251e58(0x177)],_0x41ee4e,_0x1364d0);}catch(_0x3a3018){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3a3018);}}}exports[a13_0x5a0808(0x15f)]=TestGatewayController;