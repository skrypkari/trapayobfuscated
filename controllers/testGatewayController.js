'use strict';const a13_0x3395ca=a13_0x52ff;function a13_0x51e2(){const _0x219619=['webhookEvents','9651PVpHjb','Payment\x20not\x20found','Any\x20future\x20date\x20(MM/YY)','application/json','shop','json','paidAt','error','status','5051223RxoViG','toLowerCase','\x20not\x20enabled\x20for\x20shop\x20','processCard','stringify','337025vGLkyt','Payment\x20to\x20','settings','testGatewayService','sendShopWebhook','failureReason',',\x20cannot\x20process','78UYvtsn','paid','4242\x204242\x204242\x204242','PENDING','Error\x20parsing\x20webhook\x20events:','gatewayOrderId','currency','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','__importStar','failureMessage','includes','WebhookService','ðŸ§ª\x20Test\x20Gateway\x20result:','__esModule','shopId','configurable','webhookLog','FAILED','transactionId','then','test_card','createdAt','default','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','109753mSzPra','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gateway','processCardPayment','get','paymentMethod','sendPaymentNotification','__importDefault','parse','isArray','Webhook\x20event\x20','POST','cardNumber','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','successUrl','failed','toISOString','PAID','Payment\x20failed','Payment\x20status\x20is\x20','findUnique','TestGatewayController','body','now','payment.failed','getOwnPropertyDescriptor','âœ…\x20Test\x20Gateway\x20payment\x20','TestGatewayService','16QGDxZh','getOwnPropertyNames','writable','__setModuleDefault','12416930VxcolF','slice','334rKkRRA','Payment\x20is\x20not\x20for\x20test\x20gateway','hasOwnProperty','defineProperty','38235oMIxEs','update','payment.success','Test\x20Gateway\x20webhook\x20sent\x20to\x20','test_gateway_','sendPaymentStatusNotification','995720JWRJyz','Payment\x20processed\x20successfully','webhookUrl','0000','length','resolve','Any\x203-4\x20digits','prototype','cardLast4','../services/gateways/testGatewayService','payment','amount','test_gateway','../services/telegramBotService','orderId','params','name','create','log'];a13_0x51e2=function(){return _0x219619;};return a13_0x51e2();}(function(_0x24c7d1,_0x2f599b){const _0x4af13e=a13_0x52ff,_0x5ccb36=_0x24c7d1();while(!![]){try{const _0x3fad80=parseInt(_0x4af13e(0x97))/0x1+-parseInt(_0x4af13e(0xd9))/0x2*(-parseInt(_0x4af13e(0xf7))/0x3)+parseInt(_0x4af13e(0xe3))/0x4+parseInt(_0x4af13e(0xdd))/0x5*(-parseInt(_0x4af13e(0x9e))/0x6)+parseInt(_0x4af13e(0xb7))/0x7*(-parseInt(_0x4af13e(0xd3))/0x8)+parseInt(_0x4af13e(0x92))/0x9+-parseInt(_0x4af13e(0xd7))/0xa;if(_0x3fad80===_0x2f599b)break;else _0x5ccb36['push'](_0x5ccb36['shift']());}catch(_0x13aec2){_0x5ccb36['push'](_0x5ccb36['shift']());}}}(a13_0x51e2,0x4c2ab));function a13_0x52ff(_0x2b5c4d,_0x2d121e){const _0x51e2ea=a13_0x51e2();return a13_0x52ff=function(_0x52ff4c,_0x1633e0){_0x52ff4c=_0x52ff4c-0x90;let _0x481a3f=_0x51e2ea[_0x52ff4c];return _0x481a3f;},a13_0x52ff(_0x2b5c4d,_0x2d121e);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x130b02,_0x212475,_0x5c04e0,_0x5cdb63){const _0x1001bc=a13_0x52ff;if(_0x5cdb63===undefined)_0x5cdb63=_0x5c04e0;var _0x5e918e=Object[_0x1001bc(0xd0)](_0x212475,_0x5c04e0);(!_0x5e918e||(_0x1001bc(0xbb)in _0x5e918e?!_0x212475['__esModule']:_0x5e918e[_0x1001bc(0xd5)]||_0x5e918e[_0x1001bc(0xae)]))&&(_0x5e918e={'enumerable':!![],'get':function(){return _0x212475[_0x5c04e0];}}),Object[_0x1001bc(0xdc)](_0x130b02,_0x5cdb63,_0x5e918e);}:function(_0x2a2570,_0x50151f,_0x6042e2,_0x25aa5d){if(_0x25aa5d===undefined)_0x25aa5d=_0x6042e2;_0x2a2570[_0x25aa5d]=_0x50151f[_0x6042e2];}),__setModuleDefault=this&&this[a13_0x3395ca(0xd6)]||(Object[a13_0x3395ca(0xf4)]?function(_0x192539,_0x470521){const _0x1f34da=a13_0x3395ca;Object[_0x1f34da(0xdc)](_0x192539,'default',{'enumerable':!![],'value':_0x470521});}:function(_0x3db2ef,_0x50d240){const _0x3f5d2e=a13_0x3395ca;_0x3db2ef[_0x3f5d2e(0xb5)]=_0x50d240;}),__importStar=this&&this[a13_0x3395ca(0xa7)]||(function(){var _0x48ebb4=function(_0x49e4b4){const _0x118d79=a13_0x52ff;return _0x48ebb4=Object[_0x118d79(0xd4)]||function(_0x57a4c5){const _0x1084a1=_0x118d79;var _0x243b1c=[];for(var _0x1ba986 in _0x57a4c5)if(Object[_0x1084a1(0xea)][_0x1084a1(0xdb)]['call'](_0x57a4c5,_0x1ba986))_0x243b1c[_0x243b1c[_0x1084a1(0xe7)]]=_0x1ba986;return _0x243b1c;},_0x48ebb4(_0x49e4b4);};return function(_0x20056b){const _0x1af604=a13_0x52ff;if(_0x20056b&&_0x20056b[_0x1af604(0xac)])return _0x20056b;var _0x245a20={};if(_0x20056b!=null){for(var _0x1e4cf6=_0x48ebb4(_0x20056b),_0x4be116=0x0;_0x4be116<_0x1e4cf6[_0x1af604(0xe7)];_0x4be116++)if(_0x1e4cf6[_0x4be116]!==_0x1af604(0xb5))__createBinding(_0x245a20,_0x20056b,_0x1e4cf6[_0x4be116]);}return __setModuleDefault(_0x245a20,_0x20056b),_0x245a20;};}()),__importDefault=this&&this[a13_0x3395ca(0xbe)]||function(_0x424b9e){const _0x17b5d7=a13_0x3395ca;return _0x424b9e&&_0x424b9e[_0x17b5d7(0xac)]?_0x424b9e:{'default':_0x424b9e};};Object[a13_0x3395ca(0xdc)](exports,a13_0x3395ca(0xac),{'value':!![]}),exports[a13_0x3395ca(0xcc)]=void 0x0;const testGatewayService_1=require(a13_0x3395ca(0xec)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1bf997=a13_0x3395ca;this['getPaymentForm']=async(_0xe96f8f,_0xca3d13,_0x3f6ba7)=>{const _0x4c4ed8=a13_0x52ff;try{const {paymentId:_0x181314}=_0xe96f8f[_0x4c4ed8(0xf2)];console[_0x4c4ed8(0xf5)](_0x4c4ed8(0xa6)+_0x181314);const _0x5d915b=await database_1[_0x4c4ed8(0xb5)]['payment']['findUnique']({'where':{'id':_0x181314},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5d915b)return _0xca3d13[_0x4c4ed8(0x91)](0x194)[_0x4c4ed8(0xfc)]({'success':![],'message':_0x4c4ed8(0xf8)});if(_0x5d915b[_0x4c4ed8(0xb9)]!==_0x4c4ed8(0xef))return _0xca3d13[_0x4c4ed8(0x91)](0x190)[_0x4c4ed8(0xfc)]({'success':![],'message':_0x4c4ed8(0xda)});if(_0x5d915b[_0x4c4ed8(0x91)]!==_0x4c4ed8(0xa1))return _0xca3d13[_0x4c4ed8(0x91)](0x190)['json']({'success':![],'message':_0x4c4ed8(0xca)+_0x5d915b[_0x4c4ed8(0x91)]+_0x4c4ed8(0x9d)});_0xca3d13[_0x4c4ed8(0xfc)]({'success':!![],'result':{'paymentId':_0x5d915b['id'],'orderId':_0x5d915b[_0x4c4ed8(0xa3)],'amount':_0x5d915b[_0x4c4ed8(0xee)],'currency':_0x5d915b[_0x4c4ed8(0xa4)],'merchantName':_0x5d915b[_0x4c4ed8(0xfb)][_0x4c4ed8(0xf3)],'description':_0x4c4ed8(0x98)+_0x5d915b[_0x4c4ed8(0xfb)][_0x4c4ed8(0xf3)],'testInstructions':{'successCard':_0x4c4ed8(0xa0),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x4c4ed8(0xf9),'cvc':_0x4c4ed8(0xe9),'holderName':'Any\x20name'}}});}catch(_0x438892){_0x3f6ba7(_0x438892);}},this[_0x1bf997(0x95)]=async(_0x429181,_0xbb8854,_0x8eff3d)=>{const _0x5d0b28=_0x1bf997;try{const {paymentId:_0x3f4108}=_0x429181[_0x5d0b28(0xf2)],_0x2d2def=_0x429181[_0x5d0b28(0xcd)];console[_0x5d0b28(0xf5)](_0x5d0b28(0xc4)+_0x3f4108);const _0x5bb057=await database_1['default'][_0x5d0b28(0xed)][_0x5d0b28(0xcb)]({'where':{'id':_0x3f4108},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5bb057)return _0xbb8854[_0x5d0b28(0x91)](0x194)[_0x5d0b28(0xfc)]({'success':![],'message':_0x5d0b28(0xf8)});if(_0x5bb057[_0x5d0b28(0xb9)]!=='test_gateway')return _0xbb8854[_0x5d0b28(0x91)](0x190)['json']({'success':![],'message':_0x5d0b28(0xda)});if(_0x5bb057['status']!==_0x5d0b28(0xa1))return _0xbb8854[_0x5d0b28(0x91)](0x190)[_0x5d0b28(0xfc)]({'success':![],'message':_0x5d0b28(0xca)+_0x5bb057[_0x5d0b28(0x91)]+',\x20cannot\x20process'});const _0x3e6099=await this[_0x5d0b28(0x9a)][_0x5d0b28(0xba)]({'paymentId':_0x5bb057['id'],'orderId':_0x5bb057[_0x5d0b28(0xa3)]||_0x5bb057['id'],'amount':_0x5bb057[_0x5d0b28(0xee)],'currency':_0x5bb057[_0x5d0b28(0xa4)],'cardData':_0x2d2def});console[_0x5d0b28(0xf5)](_0x5d0b28(0xab),_0x3e6099);const _0x7cab1a={'status':_0x3e6099[_0x5d0b28(0x91)],'updatedAt':new Date()};if(_0x3e6099['status']==='PAID')_0x7cab1a[_0x5d0b28(0xfd)]=new Date(),_0x7cab1a[_0x5d0b28(0xa5)]=_0x3e6099[_0x5d0b28(0xb1)];else _0x3e6099[_0x5d0b28(0x91)]===_0x5d0b28(0xb0)&&(_0x7cab1a[_0x5d0b28(0xa8)]=_0x3e6099['failureReason']);const _0x2c20cf=_0x2d2def[_0x5d0b28(0xc3)]['replace'](/[\s-]/g,'');_0x7cab1a[_0x5d0b28(0xeb)]=_0x2c20cf[_0x5d0b28(0xd8)](-0x4),_0x7cab1a[_0x5d0b28(0xbc)]=_0x5d0b28(0xb3),await database_1[_0x5d0b28(0xb5)]['payment'][_0x5d0b28(0xde)]({'where':{'id':_0x5bb057['id']},'data':_0x7cab1a}),await database_1[_0x5d0b28(0xb5)][_0x5d0b28(0xaf)][_0x5d0b28(0xf4)]({'data':{'paymentId':_0x5bb057['id'],'shopId':_0x5bb057[_0x5d0b28(0xad)],'event':_0x5d0b28(0xe1)+_0x3e6099['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5d0b28(0x96)]({'oldStatus':_0x5d0b28(0xa1),'newStatus':_0x3e6099[_0x5d0b28(0x91)],'transactionId':_0x3e6099[_0x5d0b28(0xb1)],'failureReason':_0x3e6099[_0x5d0b28(0x9c)],'processedAt':new Date()[_0x5d0b28(0xc7)]()})}}),await this[_0x5d0b28(0x9b)](_0x5bb057,_0x3e6099['status'],_0x3e6099[_0x5d0b28(0xb1)],_0x3e6099['failureReason']),await this[_0x5d0b28(0xe2)](_0x5bb057,_0x3e6099[_0x5d0b28(0x91)]),console[_0x5d0b28(0xf5)](_0x5d0b28(0xd1)+_0x3f4108+'\x20processed:\x20'+_0x3e6099[_0x5d0b28(0x91)]),_0x3e6099[_0x5d0b28(0x91)]===_0x5d0b28(0xc8)?_0xbb8854[_0x5d0b28(0xfc)]({'success':!![],'message':_0x5d0b28(0xe4),'result':{'status':'PAID','transactionId':_0x3e6099[_0x5d0b28(0xb1)],'redirectUrl':_0x5bb057[_0x5d0b28(0xc5)]}}):_0xbb8854[_0x5d0b28(0x91)](0x190)['json']({'success':![],'message':_0x5d0b28(0xc9),'result':{'status':_0x5d0b28(0xb0),'failureReason':_0x3e6099[_0x5d0b28(0x9c)],'redirectUrl':_0x5bb057['failUrl']}});}catch(_0x3ea010){_0x8eff3d(_0x3ea010);}},this[_0x1bf997(0x9a)]=new testGatewayService_1[(_0x1bf997(0xd2))](),this['webhookService']=new webhookService_1[(_0x1bf997(0xaa))]();}async[a13_0x3395ca(0x9b)](_0x31c9a8,_0x418e4b,_0x1c592d,_0x50bb92){const _0x2940b5=a13_0x3395ca,_0x14ea50=Date[_0x2940b5(0xce)]();try{const _0x3ab209=_0x31c9a8[_0x2940b5(0xfb)],_0x4c1fff=_0x3ab209[_0x2940b5(0x99)];if(!_0x4c1fff?.[_0x2940b5(0xe5)]){console[_0x2940b5(0xf5)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3ab209['id']);return;}const _0x3d8bd7=_0x418e4b===_0x2940b5(0xc8)?_0x2940b5(0xdf):_0x2940b5(0xcf);let _0x5c2972=[];if(_0x4c1fff[_0x2940b5(0xf6)])try{_0x5c2972=Array[_0x2940b5(0xc0)](_0x4c1fff[_0x2940b5(0xf6)])?_0x4c1fff['webhookEvents']:JSON[_0x2940b5(0xbf)](_0x4c1fff[_0x2940b5(0xf6)]);}catch(_0x37eee9){console[_0x2940b5(0x90)](_0x2940b5(0xa2),_0x37eee9),_0x5c2972=[];}if(!_0x5c2972[_0x2940b5(0xa9)](_0x3d8bd7)){console[_0x2940b5(0xf5)](_0x2940b5(0xc1)+_0x3d8bd7+_0x2940b5(0x94)+_0x3ab209['id']);return;}const _0x2b3330={'event':_0x3d8bd7,'payment':{'id':_0x31c9a8['id'],'order_id':_0x31c9a8[_0x2940b5(0xf1)],'gateway_order_id':_0x31c9a8[_0x2940b5(0xa3)],'gateway':_0x2940b5(0xe6),'amount':_0x31c9a8[_0x2940b5(0xee)],'currency':_0x31c9a8['currency'],'status':_0x418e4b[_0x2940b5(0x93)](),'customer_email':_0x31c9a8['customerEmail'],'customer_name':_0x31c9a8['customerName'],'transaction_id':_0x1c592d,'failure_message':_0x50bb92,'created_at':_0x31c9a8[_0x2940b5(0xb4)],'updated_at':new Date()}},_0x4698a5=await fetch(_0x4c1fff[_0x2940b5(0xe5)],{'method':_0x2940b5(0xc2),'headers':{'Content-Type':_0x2940b5(0xfa),'User-Agent':_0x2940b5(0xb6)},'body':JSON[_0x2940b5(0x96)](_0x2b3330)}),_0x4dc342=Date[_0x2940b5(0xce)]()-_0x14ea50;console[_0x2940b5(0xf5)](_0x2940b5(0xe0)+_0x4c1fff[_0x2940b5(0xe5)]+'\x20with\x20status\x20'+_0x4698a5[_0x2940b5(0x91)]+'\x20('+_0x4dc342+'ms)');}catch(_0x11923a){console[_0x2940b5(0x90)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x11923a);}}async['sendPaymentStatusNotification'](_0x46d179,_0x193d18){const _0x3cd11d=a13_0x3395ca;try{const {telegramBotService:_0x2888f0}=await Promise[_0x3cd11d(0xe8)]()[_0x3cd11d(0xb2)](()=>__importStar(require(_0x3cd11d(0xf0)))),_0x325c74={'PAID':_0x3cd11d(0x9f),'FAILED':_0x3cd11d(0xc6)},_0x497835=_0x325c74[_0x193d18];if(!_0x497835)return;await _0x2888f0[_0x3cd11d(0xbd)](_0x46d179[_0x3cd11d(0xad)],_0x46d179,_0x497835);}catch(_0x2cee84){console[_0x3cd11d(0x90)](_0x3cd11d(0xb8),_0x2cee84);}}}exports[a13_0x3395ca(0xcc)]=TestGatewayController;