'use strict';const a21_0x5e4589=a21_0x2269;(function(_0x337e38,_0x4bbab0){const _0x17ee4a=a21_0x2269,_0x2a8ca7=_0x337e38();while(!![]){try{const _0x3fa10d=-parseInt(_0x17ee4a(0x12f))/0x1*(-parseInt(_0x17ee4a(0x107))/0x2)+-parseInt(_0x17ee4a(0x129))/0x3*(-parseInt(_0x17ee4a(0x169))/0x4)+-parseInt(_0x17ee4a(0x170))/0x5*(-parseInt(_0x17ee4a(0x143))/0x6)+parseInt(_0x17ee4a(0x13b))/0x7+-parseInt(_0x17ee4a(0x17b))/0x8+parseInt(_0x17ee4a(0x14a))/0x9+-parseInt(_0x17ee4a(0x157))/0xa;if(_0x3fa10d===_0x4bbab0)break;else _0x2a8ca7['push'](_0x2a8ca7['shift']());}catch(_0x5dfdde){_0x2a8ca7['push'](_0x2a8ca7['shift']());}}}(a21_0x2ba1,0x409ef));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x312032,_0x4ee718,_0x5999d7,_0xe04ee5){const _0x36ec50=a21_0x2269;if(_0xe04ee5===undefined)_0xe04ee5=_0x5999d7;var _0x4d5c8b=Object[_0x36ec50(0x172)](_0x4ee718,_0x5999d7);(!_0x4d5c8b||(_0x36ec50(0x161)in _0x4d5c8b?!_0x4ee718[_0x36ec50(0x184)]:_0x4d5c8b[_0x36ec50(0x155)]||_0x4d5c8b['configurable']))&&(_0x4d5c8b={'enumerable':!![],'get':function(){return _0x4ee718[_0x5999d7];}}),Object[_0x36ec50(0x149)](_0x312032,_0xe04ee5,_0x4d5c8b);}:function(_0x441293,_0xe16f22,_0x3562f2,_0x522f0f){if(_0x522f0f===undefined)_0x522f0f=_0x3562f2;_0x441293[_0x522f0f]=_0xe16f22[_0x3562f2];}),__setModuleDefault=this&&this[a21_0x5e4589(0x178)]||(Object[a21_0x5e4589(0x183)]?function(_0x42f223,_0xf09cdc){const _0x2928c7=a21_0x5e4589;Object[_0x2928c7(0x149)](_0x42f223,_0x2928c7(0x175),{'enumerable':!![],'value':_0xf09cdc});}:function(_0x44f4ef,_0xe71d0b){const _0x52c2cc=a21_0x5e4589;_0x44f4ef[_0x52c2cc(0x175)]=_0xe71d0b;}),__importStar=this&&this[a21_0x5e4589(0x114)]||(function(){var _0x202f2f=function(_0x17d497){const _0x446330=a21_0x2269;return _0x202f2f=Object[_0x446330(0x10c)]||function(_0x5d4f15){const _0x42eb45=_0x446330;var _0x2fedd1=[];for(var _0xe582ae in _0x5d4f15)if(Object[_0x42eb45(0x15f)][_0x42eb45(0x14d)][_0x42eb45(0x173)](_0x5d4f15,_0xe582ae))_0x2fedd1[_0x2fedd1[_0x42eb45(0x111)]]=_0xe582ae;return _0x2fedd1;},_0x202f2f(_0x17d497);};return function(_0x467083){const _0x128f50=a21_0x2269;if(_0x467083&&_0x467083[_0x128f50(0x184)])return _0x467083;var _0x4f91cc={};if(_0x467083!=null){for(var _0x25e2fd=_0x202f2f(_0x467083),_0x1eb4dd=0x0;_0x1eb4dd<_0x25e2fd[_0x128f50(0x111)];_0x1eb4dd++)if(_0x25e2fd[_0x1eb4dd]!==_0x128f50(0x175))__createBinding(_0x4f91cc,_0x467083,_0x25e2fd[_0x1eb4dd]);}return __setModuleDefault(_0x4f91cc,_0x467083),_0x4f91cc;};}()),__importDefault=this&&this[a21_0x5e4589(0x15d)]||function(_0x4a3907){const _0x4d62a3=a21_0x5e4589;return _0x4a3907&&_0x4a3907[_0x4d62a3(0x184)]?_0x4a3907:{'default':_0x4a3907};};Object[a21_0x5e4589(0x149)](exports,'__esModule',{'value':!![]}),exports[a21_0x5e4589(0x108)]=void 0x0;function a21_0x2ba1(){const _0x5356c1=['toISOString','Payment\x20to\x20','gatewayOrderId','paymentMethod','0000','params','\x20updated:\x20currentPayments=','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway','Payment\x20processed\x20successfully','TestGatewayService','isArray','findUnique','currency','gateway','69vcIcqn','parse','âŒ\x20Payment\x20link\x20','ðŸ§ª\x20Sending\x20webhook\x20to\x20','webhookService','replace','6997oqWSWD','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','error','../config/database','../services/telegramBotService','$transaction','test_gateway_','failUrl','name','Payment\x20not\x20found','not\x20configured','paymentLinkId','2295006esoJKd','successUrl','Any\x20future\x20date\x20(MM/YY)','webhookEvents','...','status','payment','ms)','1392EzwTwa','PENDING','FAILED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gatewayPaymentId','ðŸ“ˆ\x20Found\x20payment\x20link\x20','defineProperty','4172004PqNQfP','payment.failed','shop','hasOwnProperty','\x20not\x20enabled\x20for\x20shop\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','type','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','configured',',\x20cannot\x20process','createdAt','writable','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','6041750ixLzpo','\x20not\x20found','then','slice','log','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','__importDefault','secretKey','prototype','PAID','get',',\x20status=','testGatewayService','sendPaymentStatusNotification','Error\x20parsing\x20webhook\x20events:','createHmac','failureMessage','sha256','42916IRceSH','webhookUrl','POST','paidAt','currentPayments','failed','Payment\x20System/1.0\x20(Test\x20Gateway)','225jSTEKS','toLowerCase','getOwnPropertyDescriptor','call','âœ…\x20Payment\x20link\x20','default','customerName','../services/gateways/testGatewayService','__setModuleDefault','Any\x20name','customerEmail','1550024eNLITn','amount','processCard','failureReason','json','Payment\x20failed','update','4242\x204242\x204242\x204242','create','__esModule','shopId','Payment\x20status\x20is\x20','webhookLog',',\x20currentPayments=','âœ…\x20Test\x20Gateway\x20payment\x20','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event=','stringify','crypto','application/json','4hIFiUV','TestGatewayController','resolve','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cardNumber','getOwnPropertyNames','Any\x203-4\x20digits','sendPaymentNotification','now','transactionId','length','digest','paymentLink','__importStar','sendShopWebhook','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','\x20processed:\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','../services/webhookService'];a21_0x2ba1=function(){return _0x5356c1;};return a21_0x2ba1();}const crypto_1=__importDefault(require(a21_0x5e4589(0x18d))),testGatewayService_1=require(a21_0x5e4589(0x177)),webhookService_1=require(a21_0x5e4589(0x119)),database_1=__importDefault(require(a21_0x5e4589(0x132)));class TestGatewayController{constructor(){const _0x5ed807=a21_0x5e4589;this['getPaymentForm']=async(_0x278311,_0x5cafab,_0x32dff1)=>{const _0x15b66b=a21_0x2269;try{const {paymentId:_0x39ccd5}=_0x278311[_0x15b66b(0x11f)];console['log'](_0x15b66b(0x118)+_0x39ccd5);const _0x10d672=await database_1[_0x15b66b(0x175)][_0x15b66b(0x141)]['findUnique']({'where':{'id':_0x39ccd5},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x10d672)return _0x5cafab[_0x15b66b(0x140)](0x194)[_0x15b66b(0x17f)]({'success':![],'message':_0x15b66b(0x138)});if(_0x10d672[_0x15b66b(0x128)]!==_0x15b66b(0x122))return _0x5cafab[_0x15b66b(0x140)](0x190)[_0x15b66b(0x17f)]({'success':![],'message':_0x15b66b(0x121)});if(_0x10d672['status']!=='PENDING')return _0x5cafab[_0x15b66b(0x140)](0x190)[_0x15b66b(0x17f)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x10d672[_0x15b66b(0x140)]+_0x15b66b(0x153)});_0x5cafab[_0x15b66b(0x17f)]({'success':!![],'result':{'paymentId':_0x10d672['id'],'orderId':_0x10d672[_0x15b66b(0x11c)],'amount':_0x10d672[_0x15b66b(0x17c)],'currency':_0x10d672[_0x15b66b(0x127)],'merchantName':_0x10d672[_0x15b66b(0x14c)][_0x15b66b(0x137)],'description':_0x15b66b(0x11b)+_0x10d672['shop'][_0x15b66b(0x137)],'testInstructions':{'successCard':_0x15b66b(0x182),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x15b66b(0x13d),'cvc':_0x15b66b(0x10d),'holderName':_0x15b66b(0x179)}}});}catch(_0x1f0035){_0x32dff1(_0x1f0035);}},this[_0x5ed807(0x17d)]=async(_0x5c066f,_0x56c5fd,_0x21ca2d)=>{const _0x503a15=_0x5ed807;try{const {paymentId:_0x441115}=_0x5c066f['params'],_0x1e7dd4=_0x5c066f['body'];console[_0x503a15(0x15b)](_0x503a15(0x151)+_0x441115);const _0x29070c=await database_1[_0x503a15(0x175)]['payment']['findUnique']({'where':{'id':_0x441115},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29070c)return _0x56c5fd[_0x503a15(0x140)](0x194)[_0x503a15(0x17f)]({'success':![],'message':_0x503a15(0x138)});if(_0x29070c[_0x503a15(0x128)]!==_0x503a15(0x122))return _0x56c5fd[_0x503a15(0x140)](0x190)[_0x503a15(0x17f)]({'success':![],'message':_0x503a15(0x121)});if(_0x29070c[_0x503a15(0x140)]!==_0x503a15(0x144))return _0x56c5fd[_0x503a15(0x140)](0x190)['json']({'success':![],'message':_0x503a15(0x186)+_0x29070c[_0x503a15(0x140)]+_0x503a15(0x153)});const _0x4eeb69=await this['testGatewayService']['processCardPayment']({'paymentId':_0x29070c['id'],'orderId':_0x29070c['gatewayOrderId']||_0x29070c['id'],'amount':_0x29070c[_0x503a15(0x17c)],'currency':_0x29070c[_0x503a15(0x127)],'cardData':_0x1e7dd4});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x4eeb69);const _0x16bd1d={'status':_0x4eeb69[_0x503a15(0x140)],'updatedAt':new Date()};if(_0x4eeb69[_0x503a15(0x140)]===_0x503a15(0x160))_0x16bd1d[_0x503a15(0x16c)]=new Date(),_0x16bd1d[_0x503a15(0x147)]=_0x4eeb69[_0x503a15(0x110)];else _0x4eeb69[_0x503a15(0x140)]===_0x503a15(0x145)&&(_0x16bd1d[_0x503a15(0x167)]=_0x4eeb69['failureReason']);const _0x362d1a=_0x1e7dd4[_0x503a15(0x10b)][_0x503a15(0x12e)](/[\s-]/g,'');_0x16bd1d['cardLast4']=_0x362d1a[_0x503a15(0x15a)](-0x4),_0x16bd1d[_0x503a15(0x11d)]='test_card',await database_1[_0x503a15(0x175)][_0x503a15(0x141)]['update']({'where':{'id':_0x29070c['id']},'data':_0x16bd1d});if(_0x4eeb69['status']==='PAID'&&_0x29070c[_0x503a15(0x13a)]){console[_0x503a15(0x15b)](_0x503a15(0x130)+_0x29070c['id']+_0x503a15(0x14f));try{await database_1[_0x503a15(0x175)][_0x503a15(0x134)](async _0x79dac7=>{const _0x133d6c=_0x503a15,_0x22629e=await _0x79dac7['paymentLink'][_0x133d6c(0x126)]({'where':{'id':_0x29070c[_0x133d6c(0x13a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x22629e){console[_0x133d6c(0x15b)](_0x133d6c(0x148)+_0x22629e['id']+':\x20type='+_0x22629e[_0x133d6c(0x150)]+_0x133d6c(0x188)+_0x22629e[_0x133d6c(0x16d)]+_0x133d6c(0x162)+_0x22629e[_0x133d6c(0x140)]);const _0x55868b=_0x22629e[_0x133d6c(0x16d)]+0x1,_0x2d6ae2=_0x22629e[_0x133d6c(0x150)]==='SINGLE'?'COMPLETED':_0x22629e[_0x133d6c(0x140)];await _0x79dac7[_0x133d6c(0x113)][_0x133d6c(0x181)]({'where':{'id':_0x29070c[_0x133d6c(0x13a)]},'data':{'currentPayments':_0x55868b,'status':_0x2d6ae2,'updatedAt':new Date()}}),console[_0x133d6c(0x15b)](_0x133d6c(0x174)+_0x22629e['id']+_0x133d6c(0x120)+_0x22629e[_0x133d6c(0x16d)]+'\x20->\x20'+_0x55868b+_0x133d6c(0x162)+_0x22629e[_0x133d6c(0x140)]+'\x20->\x20'+_0x2d6ae2);}else console[_0x133d6c(0x15b)](_0x133d6c(0x12b)+_0x29070c[_0x133d6c(0x13a)]+_0x133d6c(0x158));});}catch(_0x495612){console[_0x503a15(0x131)](_0x503a15(0x18a),_0x495612);}}await database_1[_0x503a15(0x175)][_0x503a15(0x187)]['create']({'data':{'paymentId':_0x29070c['id'],'shopId':_0x29070c[_0x503a15(0x185)],'event':_0x503a15(0x135)+_0x4eeb69[_0x503a15(0x140)]['toLowerCase'](),'statusCode':_0x4eeb69[_0x503a15(0x140)]===_0x503a15(0x160)?0xc8:0x190,'responseBody':JSON[_0x503a15(0x18c)]({'oldStatus':_0x503a15(0x144),'newStatus':_0x4eeb69['status'],'transactionId':_0x4eeb69[_0x503a15(0x110)],'failureReason':_0x4eeb69[_0x503a15(0x17e)],'processedAt':new Date()[_0x503a15(0x11a)]()})}}),console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20'+_0x4eeb69['status']+_0x503a15(0x13f)),await this[_0x503a15(0x115)](_0x29070c,_0x4eeb69[_0x503a15(0x140)],_0x4eeb69['transactionId'],_0x4eeb69[_0x503a15(0x17e)]),console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20'+_0x4eeb69[_0x503a15(0x140)]),console['log'](_0x503a15(0x116)+_0x4eeb69[_0x503a15(0x140)]+'...'),await this[_0x503a15(0x164)](_0x29070c,_0x4eeb69[_0x503a15(0x140)]),console[_0x503a15(0x15b)](_0x503a15(0x15c)+_0x4eeb69[_0x503a15(0x140)]),console[_0x503a15(0x15b)](_0x503a15(0x189)+_0x441115+_0x503a15(0x117)+_0x4eeb69[_0x503a15(0x140)]),_0x4eeb69[_0x503a15(0x140)]==='PAID'?_0x56c5fd[_0x503a15(0x17f)]({'success':!![],'message':_0x503a15(0x123),'result':{'status':_0x503a15(0x160),'transactionId':_0x4eeb69[_0x503a15(0x110)],'redirectUrl':_0x29070c[_0x503a15(0x13c)]}}):_0x56c5fd['status'](0x190)[_0x503a15(0x17f)]({'success':![],'message':_0x503a15(0x180),'result':{'status':'FAILED','failureReason':_0x4eeb69['failureReason'],'redirectUrl':_0x29070c[_0x503a15(0x136)]}});}catch(_0x1b2258){_0x21ca2d(_0x1b2258);}},this[_0x5ed807(0x163)]=new testGatewayService_1[(_0x5ed807(0x124))](),this[_0x5ed807(0x12d)]=new webhookService_1['WebhookService']();}async[a21_0x5e4589(0x115)](_0x2369be,_0x31aa22,_0x5eaf56,_0x3d767f){const _0x52e848=a21_0x5e4589,_0x443b40=Date[_0x52e848(0x10f)]();try{const _0x58f219=_0x2369be[_0x52e848(0x14c)],_0x2b6489=_0x58f219['settings'];if(!_0x2b6489?.[_0x52e848(0x16a)]){console[_0x52e848(0x15b)](_0x52e848(0x146)+_0x58f219['id']);return;}const _0x518dd6=_0x31aa22===_0x52e848(0x160)?'payment.success':_0x52e848(0x14b);console['log'](_0x52e848(0x18b)+_0x518dd6+',\x20webhookUrl='+(_0x2b6489[_0x52e848(0x16a)]?_0x52e848(0x152):_0x52e848(0x139)));let _0x2fb0b4=[];if(_0x2b6489[_0x52e848(0x13e)])try{_0x2fb0b4=Array[_0x52e848(0x125)](_0x2b6489[_0x52e848(0x13e)])?_0x2b6489[_0x52e848(0x13e)]:JSON[_0x52e848(0x12a)](_0x2b6489[_0x52e848(0x13e)]);}catch(_0x1f71f1){console[_0x52e848(0x131)](_0x52e848(0x165),_0x1f71f1),_0x2fb0b4=[];}console[_0x52e848(0x15b)]('ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:',_0x2fb0b4);if(!_0x2fb0b4['includes'](_0x518dd6)){console[_0x52e848(0x15b)]('âš ï¸\x20Webhook\x20event\x20'+_0x518dd6+_0x52e848(0x14e)+_0x58f219['id']);return;}const _0x5726b2={'event':_0x518dd6,'payment':{'id':_0x2369be['id'],'order_id':_0x2369be['orderId'],'gateway_order_id':_0x2369be[_0x52e848(0x11c)],'gateway':_0x52e848(0x11e),'amount':_0x2369be[_0x52e848(0x17c)],'currency':_0x2369be[_0x52e848(0x127)],'status':_0x31aa22[_0x52e848(0x171)](),'customer_email':_0x2369be[_0x52e848(0x17a)],'customer_name':_0x2369be[_0x52e848(0x176)],'transaction_id':_0x5eaf56,'failure_message':_0x3d767f,'created_at':_0x2369be[_0x52e848(0x154)],'updated_at':new Date()}};console[_0x52e848(0x15b)](_0x52e848(0x12c)+_0x2b6489['webhookUrl']+_0x52e848(0x13f)),console[_0x52e848(0x15b)]('ðŸ§ª\x20Webhook\x20payload:',JSON['stringify'](_0x5726b2,null,0x2));const _0x55cdfc=JSON[_0x52e848(0x18c)](_0x5726b2),_0x362297=crypto_1['default'][_0x52e848(0x166)](_0x52e848(0x168),_0x58f219[_0x52e848(0x15e)])[_0x52e848(0x181)](_0x55cdfc)[_0x52e848(0x112)]('hex'),_0x592b48=await fetch(_0x2b6489[_0x52e848(0x16a)],{'method':_0x52e848(0x16b),'headers':{'Content-Type':_0x52e848(0x106),'User-Agent':_0x52e848(0x16f),'X-Webhook-Signature':_0x362297},'body':_0x55cdfc}),_0x2c9f69=Date[_0x52e848(0x10f)]()-_0x443b40;console[_0x52e848(0x15b)]('âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2b6489[_0x52e848(0x16a)]+'\x20with\x20status\x20'+_0x592b48['status']+'\x20('+_0x2c9f69+_0x52e848(0x142));}catch(_0x598cfa){console[_0x52e848(0x131)](_0x52e848(0x156),_0x598cfa);}}async['sendPaymentStatusNotification'](_0x39216f,_0x84cf7f){const _0x21cdfe=a21_0x5e4589;try{const {telegramBotService:_0x2ebef5}=await Promise[_0x21cdfe(0x109)]()[_0x21cdfe(0x159)](()=>__importStar(require(_0x21cdfe(0x133)))),_0x5b1c91={'PAID':'paid','FAILED':_0x21cdfe(0x16e)},_0x2546ae=_0x5b1c91[_0x84cf7f];if(!_0x2546ae)return;await _0x2ebef5[_0x21cdfe(0x10e)](_0x39216f[_0x21cdfe(0x185)],_0x39216f,_0x2546ae);}catch(_0x50e0cf){console[_0x21cdfe(0x131)](_0x21cdfe(0x10a),_0x50e0cf);}}}function a21_0x2269(_0x2558be,_0x2df3eb){_0x2558be=_0x2558be-0x106;const _0x2ba1a0=a21_0x2ba1();let _0x22693=_0x2ba1a0[_0x2558be];return _0x22693;}exports['TestGatewayController']=TestGatewayController;