'use strict';function a13_0x4129(_0x113a35,_0x47f207){const _0x27706b=a13_0x2770();return a13_0x4129=function(_0x4129c6,_0x3330c1){_0x4129c6=_0x4129c6-0x11f;let _0x453368=_0x27706b[_0x4129c6];return _0x453368;},a13_0x4129(_0x113a35,_0x47f207);}const a13_0x10f7a1=a13_0x4129;(function(_0x394a3d,_0x23b5e0){const _0x4ca90c=a13_0x4129,_0x40b889=_0x394a3d();while(!![]){try{const _0x3e3945=-parseInt(_0x4ca90c(0x178))/0x1+parseInt(_0x4ca90c(0x174))/0x2*(parseInt(_0x4ca90c(0x179))/0x3)+-parseInt(_0x4ca90c(0x170))/0x4*(-parseInt(_0x4ca90c(0x132))/0x5)+-parseInt(_0x4ca90c(0x13b))/0x6*(parseInt(_0x4ca90c(0x145))/0x7)+-parseInt(_0x4ca90c(0x149))/0x8+-parseInt(_0x4ca90c(0x16a))/0x9+parseInt(_0x4ca90c(0x12b))/0xa;if(_0x3e3945===_0x23b5e0)break;else _0x40b889['push'](_0x40b889['shift']());}catch(_0x1ca095){_0x40b889['push'](_0x40b889['shift']());}}}(a13_0x2770,0xc11d4));var __createBinding=this&&this['__createBinding']||(Object[a13_0x10f7a1(0x154)]?function(_0x203871,_0x273698,_0x489006,_0x2e0244){const _0x223954=a13_0x10f7a1;if(_0x2e0244===undefined)_0x2e0244=_0x489006;var _0x48a9ed=Object[_0x223954(0x157)](_0x273698,_0x489006);(!_0x48a9ed||(_0x223954(0x13c)in _0x48a9ed?!_0x273698['__esModule']:_0x48a9ed[_0x223954(0x15b)]||_0x48a9ed['configurable']))&&(_0x48a9ed={'enumerable':!![],'get':function(){return _0x273698[_0x489006];}}),Object[_0x223954(0x181)](_0x203871,_0x2e0244,_0x48a9ed);}:function(_0x569059,_0x51bbf7,_0x3e823b,_0x3ddcbc){if(_0x3ddcbc===undefined)_0x3ddcbc=_0x3e823b;_0x569059[_0x3ddcbc]=_0x51bbf7[_0x3e823b];}),__setModuleDefault=this&&this[a13_0x10f7a1(0x147)]||(Object[a13_0x10f7a1(0x154)]?function(_0x5a5287,_0x516878){const _0x242486=a13_0x10f7a1;Object['defineProperty'](_0x5a5287,_0x242486(0x16b),{'enumerable':!![],'value':_0x516878});}:function(_0x4c2dcb,_0x567e25){const _0x41ea3c=a13_0x10f7a1;_0x4c2dcb[_0x41ea3c(0x16b)]=_0x567e25;}),__importStar=this&&this[a13_0x10f7a1(0x15c)]||(function(){var _0x3b2ca1=function(_0x16044e){const _0xe2cfd=a13_0x4129;return _0x3b2ca1=Object[_0xe2cfd(0x187)]||function(_0x35991d){const _0x1e3329=_0xe2cfd;var _0x2d1280=[];for(var _0x135c9e in _0x35991d)if(Object[_0x1e3329(0x18b)][_0x1e3329(0x155)][_0x1e3329(0x130)](_0x35991d,_0x135c9e))_0x2d1280[_0x2d1280[_0x1e3329(0x172)]]=_0x135c9e;return _0x2d1280;},_0x3b2ca1(_0x16044e);};return function(_0x38db94){const _0x1379e8=a13_0x4129;if(_0x38db94&&_0x38db94[_0x1379e8(0x167)])return _0x38db94;var _0x32cd29={};if(_0x38db94!=null){for(var _0x11ceb4=_0x3b2ca1(_0x38db94),_0x49d09=0x0;_0x49d09<_0x11ceb4[_0x1379e8(0x172)];_0x49d09++)if(_0x11ceb4[_0x49d09]!=='default')__createBinding(_0x32cd29,_0x38db94,_0x11ceb4[_0x49d09]);}return __setModuleDefault(_0x32cd29,_0x38db94),_0x32cd29;};}()),__importDefault=this&&this[a13_0x10f7a1(0x16e)]||function(_0x47d648){const _0x3526b7=a13_0x10f7a1;return _0x47d648&&_0x47d648[_0x3526b7(0x167)]?_0x47d648:{'default':_0x47d648};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x10f7a1(0x14c)]=void 0x0;const testGatewayService_1=require(a13_0x10f7a1(0x150)),webhookService_1=require(a13_0x10f7a1(0x17f)),database_1=__importDefault(require(a13_0x10f7a1(0x159)));function a13_0x2770(){const _0x2800be=['sendPaymentStatusNotification','log','45143870pxrTis','Payment\x20is\x20not\x20for\x20test\x20gateway','Any\x20future\x20date\x20(MM/YY)','currency','paid','call','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','5ywpPaW','payment.success','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','json','update','name','failed','customerName','Test\x20Gateway\x20webhook\x20sent\x20to\x20','8422122zDdoyE','get','transactionId','ms)','âœ…\x20Test\x20Gateway\x20payment\x20','processCardPayment','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Webhook\x20event\x20','amount','shopId','7InsFHt','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','__setModuleDefault','payment.failed','5371840eoutMa','findUnique','Any\x20name','TestGatewayController','4242\x204242\x204242\x204242','parse','failUrl','../services/gateways/testGatewayService','webhookLog','ðŸ§ª\x20Test\x20Gateway\x20result:','webhookUrl','create','hasOwnProperty','error','getOwnPropertyDescriptor','failureReason','../config/database','\x20processed:\x20','writable','__importStar',',\x20cannot\x20process','toLowerCase','gateway','customerEmail','payment','paidAt','cardNumber','Payment\x20failed','stringify','sendShopWebhook','__esModule','POST','test_gateway','11399778ufMcjS','default','resolve','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importDefault','body','66412mMKQMS','sendPaymentNotification','length','test_card','437978dPIrsE','isArray','status','PENDING','1055152WQBgol','9oyMTSj','Error\x20parsing\x20webhook\x20events:','params','includes','createdAt','processCard','../services/webhookService','slice','defineProperty','PAID','now','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20status\x20is\x20','\x20with\x20status\x20','getOwnPropertyNames','webhookService','shop','webhookEvents','prototype','gatewayOrderId','getPaymentForm','testGatewayService','replace','FAILED','Payment\x20not\x20found','test_gateway_','Any\x20other\x20card\x20number','Payment\x20processed\x20successfully','successUrl'];a13_0x2770=function(){return _0x2800be;};return a13_0x2770();}class TestGatewayController{constructor(){const _0x587abf=a13_0x10f7a1;this[_0x587abf(0x120)]=async(_0x267430,_0x4ea54a,_0x29cd91)=>{const _0x217a11=_0x587abf;try{const {paymentId:_0x3862c0}=_0x267430['params'];console[_0x217a11(0x12a)](_0x217a11(0x146)+_0x3862c0);const _0x4c3fc3=await database_1[_0x217a11(0x16b)][_0x217a11(0x161)]['findUnique']({'where':{'id':_0x3862c0},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4c3fc3)return _0x4ea54a[_0x217a11(0x176)](0x194)[_0x217a11(0x135)]({'success':![],'message':_0x217a11(0x124)});if(_0x4c3fc3[_0x217a11(0x15f)]!==_0x217a11(0x169))return _0x4ea54a['status'](0x190)[_0x217a11(0x135)]({'success':![],'message':_0x217a11(0x12c)});if(_0x4c3fc3['status']!==_0x217a11(0x177))return _0x4ea54a[_0x217a11(0x176)](0x190)[_0x217a11(0x135)]({'success':![],'message':_0x217a11(0x185)+_0x4c3fc3[_0x217a11(0x176)]+_0x217a11(0x15d)});_0x4ea54a['json']({'success':!![],'result':{'paymentId':_0x4c3fc3['id'],'orderId':_0x4c3fc3[_0x217a11(0x11f)],'amount':_0x4c3fc3[_0x217a11(0x143)],'currency':_0x4c3fc3[_0x217a11(0x12e)],'merchantName':_0x4c3fc3[_0x217a11(0x189)][_0x217a11(0x137)],'description':'Payment\x20to\x20'+_0x4c3fc3[_0x217a11(0x189)][_0x217a11(0x137)],'testInstructions':{'successCard':_0x217a11(0x14d),'failureCard':_0x217a11(0x126),'expiryDate':_0x217a11(0x12d),'cvc':'Any\x203-4\x20digits','holderName':_0x217a11(0x14b)}}});}catch(_0x1b1ba4){_0x29cd91(_0x1b1ba4);}},this[_0x587abf(0x17e)]=async(_0x27aa9f,_0x379e91,_0x5718fa)=>{const _0x3f42f6=_0x587abf;try{const {paymentId:_0x1a9e79}=_0x27aa9f[_0x3f42f6(0x17b)],_0x4d695f=_0x27aa9f[_0x3f42f6(0x16f)];console['log'](_0x3f42f6(0x16d)+_0x1a9e79);const _0x2949b3=await database_1[_0x3f42f6(0x16b)]['payment'][_0x3f42f6(0x14a)]({'where':{'id':_0x1a9e79},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2949b3)return _0x379e91[_0x3f42f6(0x176)](0x194)[_0x3f42f6(0x135)]({'success':![],'message':_0x3f42f6(0x124)});if(_0x2949b3[_0x3f42f6(0x15f)]!=='test_gateway')return _0x379e91['status'](0x190)[_0x3f42f6(0x135)]({'success':![],'message':_0x3f42f6(0x12c)});if(_0x2949b3['status']!=='PENDING')return _0x379e91[_0x3f42f6(0x176)](0x190)[_0x3f42f6(0x135)]({'success':![],'message':_0x3f42f6(0x185)+_0x2949b3[_0x3f42f6(0x176)]+_0x3f42f6(0x15d)});const _0x3fc6d1=await this['testGatewayService'][_0x3f42f6(0x140)]({'paymentId':_0x2949b3['id'],'orderId':_0x2949b3[_0x3f42f6(0x11f)]||_0x2949b3['id'],'amount':_0x2949b3['amount'],'currency':_0x2949b3[_0x3f42f6(0x12e)],'cardData':_0x4d695f});console[_0x3f42f6(0x12a)](_0x3f42f6(0x152),_0x3fc6d1);const _0x23132e={'status':_0x3fc6d1['status'],'updatedAt':new Date()};if(_0x3fc6d1[_0x3f42f6(0x176)]==='PAID')_0x23132e[_0x3f42f6(0x162)]=new Date(),_0x23132e['gatewayPaymentId']=_0x3fc6d1['transactionId'];else _0x3fc6d1['status']===_0x3f42f6(0x123)&&(_0x23132e['failureMessage']=_0x3fc6d1[_0x3f42f6(0x158)]);const _0x4d9e12=_0x4d695f[_0x3f42f6(0x163)][_0x3f42f6(0x122)](/[\s-]/g,'');_0x23132e['cardLast4']=_0x4d9e12[_0x3f42f6(0x180)](-0x4),_0x23132e['paymentMethod']=_0x3f42f6(0x173),await database_1[_0x3f42f6(0x16b)]['payment'][_0x3f42f6(0x136)]({'where':{'id':_0x2949b3['id']},'data':_0x23132e}),await database_1[_0x3f42f6(0x16b)][_0x3f42f6(0x151)][_0x3f42f6(0x154)]({'data':{'paymentId':_0x2949b3['id'],'shopId':_0x2949b3[_0x3f42f6(0x144)],'event':_0x3f42f6(0x125)+_0x3fc6d1['status'][_0x3f42f6(0x15e)](),'statusCode':0xc8,'responseBody':JSON[_0x3f42f6(0x165)]({'oldStatus':'PENDING','newStatus':_0x3fc6d1[_0x3f42f6(0x176)],'transactionId':_0x3fc6d1['transactionId'],'failureReason':_0x3fc6d1[_0x3f42f6(0x158)],'processedAt':new Date()['toISOString']()})}}),await this[_0x3f42f6(0x166)](_0x2949b3,_0x3fc6d1[_0x3f42f6(0x176)],_0x3fc6d1[_0x3f42f6(0x13d)],_0x3fc6d1['failureReason']),await this[_0x3f42f6(0x129)](_0x2949b3,_0x3fc6d1[_0x3f42f6(0x176)]),console['log'](_0x3f42f6(0x13f)+_0x1a9e79+_0x3f42f6(0x15a)+_0x3fc6d1['status']),_0x3fc6d1[_0x3f42f6(0x176)]===_0x3f42f6(0x182)?_0x379e91[_0x3f42f6(0x135)]({'success':!![],'message':_0x3f42f6(0x127),'result':{'status':_0x3f42f6(0x182),'transactionId':_0x3fc6d1['transactionId'],'redirectUrl':_0x2949b3[_0x3f42f6(0x128)]}}):_0x379e91[_0x3f42f6(0x176)](0x190)[_0x3f42f6(0x135)]({'success':![],'message':_0x3f42f6(0x164),'result':{'status':'FAILED','failureReason':_0x3fc6d1['failureReason'],'redirectUrl':_0x2949b3[_0x3f42f6(0x14f)]}});}catch(_0x3c19f4){_0x5718fa(_0x3c19f4);}},this[_0x587abf(0x121)]=new testGatewayService_1['TestGatewayService'](),this[_0x587abf(0x188)]=new webhookService_1['WebhookService']();}async[a13_0x10f7a1(0x166)](_0x19a071,_0x20b0d6,_0x3b39fa,_0x5533f0){const _0x3f0123=a13_0x10f7a1,_0x413fb9=Date[_0x3f0123(0x183)]();try{const _0x59ea5b=_0x19a071[_0x3f0123(0x189)],_0x1c1911=_0x59ea5b['settings'];if(!_0x1c1911?.[_0x3f0123(0x153)]){console[_0x3f0123(0x12a)](_0x3f0123(0x134)+_0x59ea5b['id']);return;}const _0xb92ee7=_0x20b0d6===_0x3f0123(0x182)?_0x3f0123(0x133):_0x3f0123(0x148);let _0x22c871=[];if(_0x1c1911[_0x3f0123(0x18a)])try{_0x22c871=Array[_0x3f0123(0x175)](_0x1c1911[_0x3f0123(0x18a)])?_0x1c1911[_0x3f0123(0x18a)]:JSON[_0x3f0123(0x14e)](_0x1c1911[_0x3f0123(0x18a)]);}catch(_0x440924){console[_0x3f0123(0x156)](_0x3f0123(0x17a),_0x440924),_0x22c871=[];}if(!_0x22c871[_0x3f0123(0x17c)](_0xb92ee7)){console[_0x3f0123(0x12a)](_0x3f0123(0x142)+_0xb92ee7+'\x20not\x20enabled\x20for\x20shop\x20'+_0x59ea5b['id']);return;}const _0x2414e5={'event':_0xb92ee7,'payment':{'id':_0x19a071['id'],'order_id':_0x19a071['orderId'],'gateway_order_id':_0x19a071[_0x3f0123(0x11f)],'gateway':'0000','amount':_0x19a071['amount'],'currency':_0x19a071[_0x3f0123(0x12e)],'status':_0x20b0d6[_0x3f0123(0x15e)](),'customer_email':_0x19a071[_0x3f0123(0x160)],'customer_name':_0x19a071[_0x3f0123(0x139)],'transaction_id':_0x3b39fa,'failure_message':_0x5533f0,'created_at':_0x19a071[_0x3f0123(0x17d)],'updated_at':new Date()}},_0x201797=await fetch(_0x1c1911[_0x3f0123(0x153)],{'method':_0x3f0123(0x168),'headers':{'Content-Type':'application/json','User-Agent':_0x3f0123(0x141)},'body':JSON[_0x3f0123(0x165)](_0x2414e5)}),_0x5d4a72=Date[_0x3f0123(0x183)]()-_0x413fb9;console[_0x3f0123(0x12a)](_0x3f0123(0x13a)+_0x1c1911['webhookUrl']+_0x3f0123(0x186)+_0x201797[_0x3f0123(0x176)]+'\x20('+_0x5d4a72+_0x3f0123(0x13e));}catch(_0x123cc9){console[_0x3f0123(0x156)](_0x3f0123(0x184),_0x123cc9);}}async[a13_0x10f7a1(0x129)](_0x230c1d,_0x5e2a86){const _0x263e09=a13_0x10f7a1;try{const {telegramBotService:_0x4f3d85}=await Promise[_0x263e09(0x16c)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x4542a0={'PAID':_0x263e09(0x12f),'FAILED':_0x263e09(0x138)},_0x290e74=_0x4542a0[_0x5e2a86];if(!_0x290e74)return;await _0x4f3d85[_0x263e09(0x171)](_0x230c1d['shopId'],_0x230c1d,_0x290e74);}catch(_0x46db6){console[_0x263e09(0x156)](_0x263e09(0x131),_0x46db6);}}}exports[a13_0x10f7a1(0x14c)]=TestGatewayController;