'use strict';function a13_0x4331(_0x4cba80,_0x4891ed){const _0xf02b1f=a13_0xf02b();return a13_0x4331=function(_0x433100,_0x5e409c){_0x433100=_0x433100-0x1b2;let _0x2c7f6e=_0xf02b1f[_0x433100];return _0x2c7f6e;},a13_0x4331(_0x4cba80,_0x4891ed);}function a13_0xf02b(){const _0x4686a0=['paymentMethod','gateway','includes','‚úÖ\x20Payment\x20link\x20','paid','Any\x20future\x20date\x20(MM/YY)','stringify','../services/webhookService','../config/database','webhookService','ms)','json','processCardPayment','__setModuleDefault','test_gateway','PENDING','cardLast4','Payment\x20processed\x20successfully','__importDefault','9191688KYwjNH','WebhookService',',\x20status=','defineProperty','Payment\x20failed','4242\x204242\x204242\x204242','Payment\x20to\x20','28529oELZpw','shop','body','83505VVwdwk','configurable','‚ùå\x20Payment\x20link\x20','default','7iqjiNe','hasOwnProperty','amount','params','customerEmail','failureMessage','$transaction','type','customerName','1861432CzkqYN','test_gateway_','8884560DxpUfp','getOwnPropertyNames','36LIXrNw','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failureReason','status','webhookEvents','parse','FAILED','POST','failUrl','sendShopWebhook','\x20not\x20found','../services/telegramBotService','call','currency','length','webhookUrl','COMPLETED','paymentLinkId','\x20->\x20','successUrl','transactionId','TestGatewayController','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Any\x20other\x20card\x20number','orderId','now','SINGLE','name','paidAt','üìà\x20Found\x20payment\x20link\x20','üß™\x20Test\x20Gateway\x20result:','287526nJAhzM','\x20updated:\x20currentPayments=','isArray','testGatewayService','paymentLink','Error\x20parsing\x20webhook\x20events:','application/json','toLowerCase','get','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','__esModule','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','currentPayments','0000','test_card','31514733GNmJqP','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','payment.success','Payment\x20not\x20found','writable','settings','Any\x203-4\x20digits','PAID','Webhook\x20event\x20','createdAt','findUnique','\x20with\x20status\x20','create','../services/gateways/testGatewayService','Payment\x20is\x20not\x20for\x20test\x20gateway','‚úÖ\x20Test\x20Gateway\x20payment\x20','resolve','log','Any\x20name','update','prototype','shopId','gatewayOrderId','processCard','getPaymentForm',',\x20cannot\x20process','sendPaymentStatusNotification','üìà\x20Test\x20Gateway:\x20Payment\x20','error','payment','__createBinding','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','failed'];a13_0xf02b=function(){return _0x4686a0;};return a13_0xf02b();}const a13_0x49157a=a13_0x4331;(function(_0x1910d9,_0xc9d5dd){const _0x2834ea=a13_0x4331,_0x269e32=_0x1910d9();while(!![]){try{const _0x20baa7=-parseInt(_0x2834ea(0x222))/0x1+parseInt(_0x2834ea(0x1b4))/0x2+parseInt(_0x2834ea(0x1d8))/0x3*(parseInt(_0x2834ea(0x1b8))/0x4)+-parseInt(_0x2834ea(0x225))/0x5+parseInt(_0x2834ea(0x21b))/0x6+parseInt(_0x2834ea(0x229))/0x7*(parseInt(_0x2834ea(0x1b6))/0x8)+-parseInt(_0x2834ea(0x1e7))/0x9;if(_0x20baa7===_0xc9d5dd)break;else _0x269e32['push'](_0x269e32['shift']());}catch(_0x281c1f){_0x269e32['push'](_0x269e32['shift']());}}}(a13_0xf02b,0xd9071));var __createBinding=this&&this[a13_0x49157a(0x205)]||(Object['create']?function(_0x1611f4,_0x565578,_0x5e4c96,_0x3a4f37){const _0x4c264c=a13_0x49157a;if(_0x3a4f37===undefined)_0x3a4f37=_0x5e4c96;var _0x5ed6d4=Object['getOwnPropertyDescriptor'](_0x565578,_0x5e4c96);(!_0x5ed6d4||(_0x4c264c(0x1e0)in _0x5ed6d4?!_0x565578[_0x4c264c(0x1e2)]:_0x5ed6d4[_0x4c264c(0x1eb)]||_0x5ed6d4[_0x4c264c(0x226)]))&&(_0x5ed6d4={'enumerable':!![],'get':function(){return _0x565578[_0x5e4c96];}}),Object[_0x4c264c(0x21e)](_0x1611f4,_0x3a4f37,_0x5ed6d4);}:function(_0x5ee132,_0x393f24,_0x5dc9fe,_0x2c2a9e){if(_0x2c2a9e===undefined)_0x2c2a9e=_0x5dc9fe;_0x5ee132[_0x2c2a9e]=_0x393f24[_0x5dc9fe];}),__setModuleDefault=this&&this[a13_0x49157a(0x215)]||(Object[a13_0x49157a(0x1f3)]?function(_0x1d58ce,_0x19fc9e){const _0x1776ad=a13_0x49157a;Object['defineProperty'](_0x1d58ce,_0x1776ad(0x228),{'enumerable':!![],'value':_0x19fc9e});}:function(_0x399d98,_0x5c37e4){const _0x92c602=a13_0x49157a;_0x399d98[_0x92c602(0x228)]=_0x5c37e4;}),__importStar=this&&this['__importStar']||(function(){var _0x3f21b8=function(_0x3a4214){const _0x14d315=a13_0x4331;return _0x3f21b8=Object[_0x14d315(0x1b7)]||function(_0x3b22eb){const _0x21f69c=_0x14d315;var _0x107c6e=[];for(var _0x4d2255 in _0x3b22eb)if(Object[_0x21f69c(0x1fb)][_0x21f69c(0x22a)][_0x21f69c(0x1c4)](_0x3b22eb,_0x4d2255))_0x107c6e[_0x107c6e[_0x21f69c(0x1c6)]]=_0x4d2255;return _0x107c6e;},_0x3f21b8(_0x3a4214);};return function(_0x33de1a){const _0x439f3e=a13_0x4331;if(_0x33de1a&&_0x33de1a[_0x439f3e(0x1e2)])return _0x33de1a;var _0x47c709={};if(_0x33de1a!=null){for(var _0x263cb1=_0x3f21b8(_0x33de1a),_0x25dcb7=0x0;_0x25dcb7<_0x263cb1[_0x439f3e(0x1c6)];_0x25dcb7++)if(_0x263cb1[_0x25dcb7]!==_0x439f3e(0x228))__createBinding(_0x47c709,_0x33de1a,_0x263cb1[_0x25dcb7]);}return __setModuleDefault(_0x47c709,_0x33de1a),_0x47c709;};}()),__importDefault=this&&this[a13_0x49157a(0x21a)]||function(_0x12d416){const _0x17e315=a13_0x49157a;return _0x12d416&&_0x12d416[_0x17e315(0x1e2)]?_0x12d416:{'default':_0x12d416};};Object[a13_0x49157a(0x21e)](exports,a13_0x49157a(0x1e2),{'value':!![]}),exports[a13_0x49157a(0x1cd)]=void 0x0;const testGatewayService_1=require(a13_0x49157a(0x1f4)),webhookService_1=require(a13_0x49157a(0x20f)),database_1=__importDefault(require(a13_0x49157a(0x210)));class TestGatewayController{constructor(){const _0x5e66a2=a13_0x49157a;this[_0x5e66a2(0x1ff)]=async(_0x2f226e,_0x2a9f63,_0x42af03)=>{const _0x341151=_0x5e66a2;try{const {paymentId:_0x530bfa}=_0x2f226e[_0x341151(0x22c)];console[_0x341151(0x1f8)](_0x341151(0x1cf)+_0x530bfa);const _0x473b91=await database_1[_0x341151(0x228)][_0x341151(0x204)]['findUnique']({'where':{'id':_0x530bfa},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x473b91)return _0x2a9f63[_0x341151(0x1bb)](0x194)[_0x341151(0x213)]({'success':![],'message':_0x341151(0x1ea)});if(_0x473b91[_0x341151(0x209)]!=='test_gateway')return _0x2a9f63[_0x341151(0x1bb)](0x190)[_0x341151(0x213)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x473b91[_0x341151(0x1bb)]!==_0x341151(0x217))return _0x2a9f63[_0x341151(0x1bb)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x473b91[_0x341151(0x1bb)]+',\x20cannot\x20process'});_0x2a9f63[_0x341151(0x213)]({'success':!![],'result':{'paymentId':_0x473b91['id'],'orderId':_0x473b91['gatewayOrderId'],'amount':_0x473b91[_0x341151(0x22b)],'currency':_0x473b91['currency'],'merchantName':_0x473b91[_0x341151(0x223)][_0x341151(0x1d4)],'description':_0x341151(0x221)+_0x473b91['shop'][_0x341151(0x1d4)],'testInstructions':{'successCard':_0x341151(0x220),'failureCard':_0x341151(0x1d0),'expiryDate':_0x341151(0x20d),'cvc':_0x341151(0x1ed),'holderName':_0x341151(0x1f9)}}});}catch(_0x5d620b){_0x42af03(_0x5d620b);}},this[_0x5e66a2(0x1fe)]=async(_0x179337,_0x5764ce,_0x28efe2)=>{const _0x40cc39=_0x5e66a2;try{const {paymentId:_0x12522d}=_0x179337[_0x40cc39(0x22c)],_0x28f229=_0x179337[_0x40cc39(0x224)];console[_0x40cc39(0x1f8)](_0x40cc39(0x206)+_0x12522d);const _0x47d56d=await database_1[_0x40cc39(0x228)][_0x40cc39(0x204)][_0x40cc39(0x1f1)]({'where':{'id':_0x12522d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x47d56d)return _0x5764ce[_0x40cc39(0x1bb)](0x194)['json']({'success':![],'message':_0x40cc39(0x1ea)});if(_0x47d56d[_0x40cc39(0x209)]!==_0x40cc39(0x216))return _0x5764ce[_0x40cc39(0x1bb)](0x190)[_0x40cc39(0x213)]({'success':![],'message':_0x40cc39(0x1f5)});if(_0x47d56d[_0x40cc39(0x1bb)]!=='PENDING')return _0x5764ce[_0x40cc39(0x1bb)](0x190)[_0x40cc39(0x213)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x47d56d[_0x40cc39(0x1bb)]+_0x40cc39(0x200)});const _0x2b6ef4=await this[_0x40cc39(0x1db)][_0x40cc39(0x214)]({'paymentId':_0x47d56d['id'],'orderId':_0x47d56d[_0x40cc39(0x1fd)]||_0x47d56d['id'],'amount':_0x47d56d[_0x40cc39(0x22b)],'currency':_0x47d56d[_0x40cc39(0x1c5)],'cardData':_0x28f229});console['log'](_0x40cc39(0x1d7),_0x2b6ef4);const _0x80c6fe={'status':_0x2b6ef4[_0x40cc39(0x1bb)],'updatedAt':new Date()};if(_0x2b6ef4[_0x40cc39(0x1bb)]===_0x40cc39(0x1ee))_0x80c6fe[_0x40cc39(0x1d5)]=new Date(),_0x80c6fe['gatewayPaymentId']=_0x2b6ef4['transactionId'];else _0x2b6ef4['status']===_0x40cc39(0x1be)&&(_0x80c6fe[_0x40cc39(0x22e)]=_0x2b6ef4[_0x40cc39(0x1ba)]);const _0x5459ad=_0x28f229['cardNumber']['replace'](/[\s-]/g,'');_0x80c6fe[_0x40cc39(0x218)]=_0x5459ad['slice'](-0x4),_0x80c6fe[_0x40cc39(0x208)]=_0x40cc39(0x1e6),await database_1[_0x40cc39(0x228)][_0x40cc39(0x204)]['update']({'where':{'id':_0x47d56d['id']},'data':_0x80c6fe});if(_0x2b6ef4[_0x40cc39(0x1bb)]===_0x40cc39(0x1ee)&&_0x47d56d[_0x40cc39(0x1c9)]){console[_0x40cc39(0x1f8)](_0x40cc39(0x202)+_0x47d56d['id']+_0x40cc39(0x1e1));try{await database_1['default'][_0x40cc39(0x22f)](async _0x1e107a=>{const _0x1ff0de=_0x40cc39,_0x2e6673=await _0x1e107a[_0x1ff0de(0x1dc)][_0x1ff0de(0x1f1)]({'where':{'id':_0x47d56d[_0x1ff0de(0x1c9)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2e6673){console[_0x1ff0de(0x1f8)](_0x1ff0de(0x1d6)+_0x2e6673['id']+':\x20type='+_0x2e6673['type']+',\x20currentPayments='+_0x2e6673['currentPayments']+_0x1ff0de(0x21d)+_0x2e6673[_0x1ff0de(0x1bb)]);const _0x503795=_0x2e6673[_0x1ff0de(0x1e4)]+0x1,_0x5ef713=_0x2e6673[_0x1ff0de(0x1b2)]===_0x1ff0de(0x1d3)?_0x1ff0de(0x1c8):_0x2e6673[_0x1ff0de(0x1bb)];await _0x1e107a[_0x1ff0de(0x1dc)][_0x1ff0de(0x1fa)]({'where':{'id':_0x47d56d[_0x1ff0de(0x1c9)]},'data':{'currentPayments':_0x503795,'status':_0x5ef713,'updatedAt':new Date()}}),console[_0x1ff0de(0x1f8)](_0x1ff0de(0x20b)+_0x2e6673['id']+_0x1ff0de(0x1d9)+_0x2e6673[_0x1ff0de(0x1e4)]+_0x1ff0de(0x1ca)+_0x503795+_0x1ff0de(0x21d)+_0x2e6673[_0x1ff0de(0x1bb)]+'\x20->\x20'+_0x5ef713);}else console['log'](_0x1ff0de(0x227)+_0x47d56d[_0x1ff0de(0x1c9)]+_0x1ff0de(0x1c2));});}catch(_0x567949){console['error'](_0x40cc39(0x1ce),_0x567949);}}await database_1[_0x40cc39(0x228)]['webhookLog'][_0x40cc39(0x1f3)]({'data':{'paymentId':_0x47d56d['id'],'shopId':_0x47d56d[_0x40cc39(0x1fc)],'event':_0x40cc39(0x1b5)+_0x2b6ef4[_0x40cc39(0x1bb)][_0x40cc39(0x1df)](),'statusCode':0xc8,'responseBody':JSON[_0x40cc39(0x20e)]({'oldStatus':_0x40cc39(0x217),'newStatus':_0x2b6ef4[_0x40cc39(0x1bb)],'transactionId':_0x2b6ef4['transactionId'],'failureReason':_0x2b6ef4[_0x40cc39(0x1ba)],'processedAt':new Date()['toISOString']()})}}),await this[_0x40cc39(0x1c1)](_0x47d56d,_0x2b6ef4[_0x40cc39(0x1bb)],_0x2b6ef4['transactionId'],_0x2b6ef4[_0x40cc39(0x1ba)]),await this[_0x40cc39(0x201)](_0x47d56d,_0x2b6ef4[_0x40cc39(0x1bb)]),console[_0x40cc39(0x1f8)](_0x40cc39(0x1f6)+_0x12522d+'\x20processed:\x20'+_0x2b6ef4['status']),_0x2b6ef4['status']===_0x40cc39(0x1ee)?_0x5764ce['json']({'success':!![],'message':_0x40cc39(0x219),'result':{'status':_0x40cc39(0x1ee),'transactionId':_0x2b6ef4[_0x40cc39(0x1cc)],'redirectUrl':_0x47d56d[_0x40cc39(0x1cb)]}}):_0x5764ce[_0x40cc39(0x1bb)](0x190)[_0x40cc39(0x213)]({'success':![],'message':_0x40cc39(0x21f),'result':{'status':'FAILED','failureReason':_0x2b6ef4[_0x40cc39(0x1ba)],'redirectUrl':_0x47d56d[_0x40cc39(0x1c0)]}});}catch(_0x443b7f){_0x28efe2(_0x443b7f);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x5e66a2(0x211)]=new webhookService_1[(_0x5e66a2(0x21c))]();}async[a13_0x49157a(0x1c1)](_0x50836f,_0x1ec754,_0x4e651e,_0x4aa24e){const _0x22e04d=a13_0x49157a,_0x3c671=Date[_0x22e04d(0x1d2)]();try{const _0x2e8d00=_0x50836f[_0x22e04d(0x223)],_0x42daa4=_0x2e8d00[_0x22e04d(0x1ec)];if(!_0x42daa4?.[_0x22e04d(0x1c7)]){console[_0x22e04d(0x1f8)](_0x22e04d(0x1e3)+_0x2e8d00['id']);return;}const _0x285987=_0x1ec754===_0x22e04d(0x1ee)?_0x22e04d(0x1e9):'payment.failed';let _0x18fbef=[];if(_0x42daa4[_0x22e04d(0x1bc)])try{_0x18fbef=Array[_0x22e04d(0x1da)](_0x42daa4[_0x22e04d(0x1bc)])?_0x42daa4['webhookEvents']:JSON[_0x22e04d(0x1bd)](_0x42daa4[_0x22e04d(0x1bc)]);}catch(_0x533b5e){console[_0x22e04d(0x203)](_0x22e04d(0x1dd),_0x533b5e),_0x18fbef=[];}if(!_0x18fbef[_0x22e04d(0x20a)](_0x285987)){console[_0x22e04d(0x1f8)](_0x22e04d(0x1ef)+_0x285987+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2e8d00['id']);return;}const _0x591a5f={'event':_0x285987,'payment':{'id':_0x50836f['id'],'order_id':_0x50836f[_0x22e04d(0x1d1)],'gateway_order_id':_0x50836f[_0x22e04d(0x1fd)],'gateway':_0x22e04d(0x1e5),'amount':_0x50836f[_0x22e04d(0x22b)],'currency':_0x50836f['currency'],'status':_0x1ec754[_0x22e04d(0x1df)](),'customer_email':_0x50836f[_0x22e04d(0x22d)],'customer_name':_0x50836f[_0x22e04d(0x1b3)],'transaction_id':_0x4e651e,'failure_message':_0x4aa24e,'created_at':_0x50836f[_0x22e04d(0x1f0)],'updated_at':new Date()}},_0x1d9c92=await fetch(_0x42daa4[_0x22e04d(0x1c7)],{'method':_0x22e04d(0x1bf),'headers':{'Content-Type':_0x22e04d(0x1de),'User-Agent':_0x22e04d(0x1e8)},'body':JSON[_0x22e04d(0x20e)](_0x591a5f)}),_0x1bc8ff=Date[_0x22e04d(0x1d2)]()-_0x3c671;console['log'](_0x22e04d(0x1b9)+_0x42daa4['webhookUrl']+_0x22e04d(0x1f2)+_0x1d9c92['status']+'\x20('+_0x1bc8ff+_0x22e04d(0x212));}catch(_0x2faee5){console[_0x22e04d(0x203)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x2faee5);}}async['sendPaymentStatusNotification'](_0x442634,_0x14cb68){const _0x1792c4=a13_0x49157a;try{const {telegramBotService:_0x26da75}=await Promise[_0x1792c4(0x1f7)]()['then'](()=>__importStar(require(_0x1792c4(0x1c3)))),_0x4f7411={'PAID':_0x1792c4(0x20c),'FAILED':_0x1792c4(0x207)},_0x139475=_0x4f7411[_0x14cb68];if(!_0x139475)return;await _0x26da75['sendPaymentNotification'](_0x442634['shopId'],_0x442634,_0x139475);}catch(_0x54666e){console[_0x1792c4(0x203)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x54666e);}}}exports[a13_0x49157a(0x1cd)]=TestGatewayController;