'use strict';function a14_0x3ae0(){const _0x570492=['TestGatewayController','payment.success','‚ùå\x20Payment\x20link\x20','42lwydbl','FAILED',',\x20cannot\x20process','../services/gateways/testGatewayService','create','__esModule','__setModuleDefault','error','Payment\x20is\x20not\x20for\x20test\x20gateway','payment.failed','Any\x20future\x20date\x20(MM/YY)','22PXvRfZ','Error\x20parsing\x20webhook\x20events:','üìà\x20Found\x20payment\x20link\x20','parse','isArray','Payment\x20status\x20is\x20','üß™\x20Test\x20Gateway\x20result:','2236490ycbxMp','\x20with\x20status\x20','Any\x203-4\x20digits','gateway','Any\x20name','PENDING','ms)','settings','configurable','getOwnPropertyDescriptor','failed','Payment\x20failed','Payment\x20not\x20found','writable','__importDefault','$transaction','1344248saEpRq','\x20not\x20enabled\x20for\x20shop\x20','slice',',\x20status=','replace','orderId','params','payment','get','currency','üìà\x20Test\x20Gateway:\x20Payment\x20','default','createdAt','test_gateway','paidAt','toLowerCase','includes','3899230KRlUeW','testGatewayService','\x20->\x20','42sLUsOQ','failureMessage','12028446KVpDGw','application/json','findUnique','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/telegramBotService','failureReason','../config/database','processCard','getOwnPropertyNames','paymentLink','7642425udDoRo','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','length','json','update','failUrl','then',',\x20currentPayments=','now','webhookEvents','cardNumber','webhookService','gatewayPaymentId','hasOwnProperty','\x20not\x20found','sendPaymentStatusNotification','\x20updated:\x20currentPayments=','8UMjlEz','stringify','shop','status','body','282965gZCHxc','../services/webhookService','currentPayments','webhookUrl','paid','transactionId','shopId','gatewayOrderId','sendShopWebhook','SINGLE','__createBinding','amount','log','Payment\x20processed\x20successfully','‚úÖ\x20Test\x20Gateway\x20payment\x20','defineProperty','call','Payment\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','491676GrUrUj','Payment\x20System/1.0\x20(Test\x20Gateway)','webhookLog','test_card','4242\x204242\x204242\x204242','getPaymentForm',':\x20type=','paymentLinkId','COMPLETED','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','PAID','resolve'];a14_0x3ae0=function(){return _0x570492;};return a14_0x3ae0();}function a14_0x1554(_0x1e9f42,_0x472410){const _0x3ae0bc=a14_0x3ae0();return a14_0x1554=function(_0x155436,_0x35442c){_0x155436=_0x155436-0x1b6;let _0x5ae994=_0x3ae0bc[_0x155436];return _0x5ae994;},a14_0x1554(_0x1e9f42,_0x472410);}const a14_0x45012a=a14_0x1554;(function(_0x325fcc,_0x41fb21){const _0x31d911=a14_0x1554,_0x3521cb=_0x325fcc();while(!![]){try{const _0xabcc87=-parseInt(_0x31d911(0x217))/0x1+parseInt(_0x31d911(0x207))/0x2+parseInt(_0x31d911(0x22b))/0x3*(parseInt(_0x31d911(0x1e6))/0x4)+-parseInt(_0x31d911(0x1d3))/0x5*(-parseInt(_0x31d911(0x1f5))/0x6)+-parseInt(_0x31d911(0x1bd))/0x7*(-parseInt(_0x31d911(0x1ce))/0x8)+-parseInt(_0x31d911(0x22d))/0x9+parseInt(_0x31d911(0x228))/0xa*(-parseInt(_0x31d911(0x200))/0xb);if(_0xabcc87===_0x41fb21)break;else _0x3521cb['push'](_0x3521cb['shift']());}catch(_0x394d7a){_0x3521cb['push'](_0x3521cb['shift']());}}}(a14_0x3ae0,0xd3891));var __createBinding=this&&this[a14_0x45012a(0x1dd)]||(Object[a14_0x45012a(0x1f9)]?function(_0x2bf238,_0x41c976,_0x1d5539,_0x279714){const _0x495917=a14_0x45012a;if(_0x279714===undefined)_0x279714=_0x1d5539;var _0xbca47b=Object[_0x495917(0x210)](_0x41c976,_0x1d5539);(!_0xbca47b||(_0x495917(0x21f)in _0xbca47b?!_0x41c976[_0x495917(0x1fa)]:_0xbca47b[_0x495917(0x214)]||_0xbca47b[_0x495917(0x20f)]))&&(_0xbca47b={'enumerable':!![],'get':function(){return _0x41c976[_0x1d5539];}}),Object[_0x495917(0x1e2)](_0x2bf238,_0x279714,_0xbca47b);}:function(_0x4d4d49,_0x5df7ae,_0x5f5259,_0x5c36a5){if(_0x5c36a5===undefined)_0x5c36a5=_0x5f5259;_0x4d4d49[_0x5c36a5]=_0x5df7ae[_0x5f5259];}),__setModuleDefault=this&&this[a14_0x45012a(0x1fb)]||(Object[a14_0x45012a(0x1f9)]?function(_0xdb7ba4,_0x43b7e6){const _0x3e88cd=a14_0x45012a;Object[_0x3e88cd(0x1e2)](_0xdb7ba4,_0x3e88cd(0x222),{'enumerable':!![],'value':_0x43b7e6});}:function(_0x51fa65,_0x1541ed){const _0x267c9d=a14_0x45012a;_0x51fa65[_0x267c9d(0x222)]=_0x1541ed;}),__importStar=this&&this['__importStar']||(function(){var _0x43e5eb=function(_0x3c79ed){const _0x5a7624=a14_0x1554;return _0x43e5eb=Object[_0x5a7624(0x1bb)]||function(_0x97d47){const _0xaa01d8=_0x5a7624;var _0x4f5299=[];for(var _0x121a45 in _0x97d47)if(Object['prototype'][_0xaa01d8(0x1ca)][_0xaa01d8(0x1e3)](_0x97d47,_0x121a45))_0x4f5299[_0x4f5299[_0xaa01d8(0x1bf)]]=_0x121a45;return _0x4f5299;},_0x43e5eb(_0x3c79ed);};return function(_0x213d7c){const _0x1f8719=a14_0x1554;if(_0x213d7c&&_0x213d7c['__esModule'])return _0x213d7c;var _0x3c7adc={};if(_0x213d7c!=null){for(var _0x273f1e=_0x43e5eb(_0x213d7c),_0x2ef229=0x0;_0x2ef229<_0x273f1e[_0x1f8719(0x1bf)];_0x2ef229++)if(_0x273f1e[_0x2ef229]!==_0x1f8719(0x222))__createBinding(_0x3c7adc,_0x213d7c,_0x273f1e[_0x2ef229]);}return __setModuleDefault(_0x3c7adc,_0x213d7c),_0x3c7adc;};}()),__importDefault=this&&this[a14_0x45012a(0x215)]||function(_0x105e6a){const _0x184aa8=a14_0x45012a;return _0x105e6a&&_0x105e6a[_0x184aa8(0x1fa)]?_0x105e6a:{'default':_0x105e6a};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a14_0x45012a(0x1f2)]=void 0x0;const testGatewayService_1=require(a14_0x45012a(0x1f8)),webhookService_1=require(a14_0x45012a(0x1d4)),database_1=__importDefault(require(a14_0x45012a(0x1b9)));class TestGatewayController{constructor(){const _0x5b66f4=a14_0x45012a;this[_0x5b66f4(0x1eb)]=async(_0x7b2ad4,_0xc25f72,_0x2a0cec)=>{const _0x29ca6d=_0x5b66f4;try{const {paymentId:_0x4ce483}=_0x7b2ad4[_0x29ca6d(0x21d)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4ce483);const _0x3cf3aa=await database_1[_0x29ca6d(0x222)][_0x29ca6d(0x21e)][_0x29ca6d(0x22f)]({'where':{'id':_0x4ce483},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3cf3aa)return _0xc25f72[_0x29ca6d(0x1d1)](0x194)[_0x29ca6d(0x1c0)]({'success':![],'message':_0x29ca6d(0x213)});if(_0x3cf3aa['gateway']!==_0x29ca6d(0x224))return _0xc25f72['status'](0x190)[_0x29ca6d(0x1c0)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3cf3aa['status']!==_0x29ca6d(0x20c))return _0xc25f72[_0x29ca6d(0x1d1)](0x190)[_0x29ca6d(0x1c0)]({'success':![],'message':_0x29ca6d(0x205)+_0x3cf3aa[_0x29ca6d(0x1d1)]+_0x29ca6d(0x1f7)});_0xc25f72['json']({'success':!![],'result':{'paymentId':_0x3cf3aa['id'],'orderId':_0x3cf3aa[_0x29ca6d(0x1da)],'amount':_0x3cf3aa['amount'],'currency':_0x3cf3aa[_0x29ca6d(0x220)],'merchantName':_0x3cf3aa[_0x29ca6d(0x1d0)]['name'],'description':_0x29ca6d(0x1e4)+_0x3cf3aa[_0x29ca6d(0x1d0)]['name'],'testInstructions':{'successCard':_0x29ca6d(0x1ea),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x29ca6d(0x1ff),'cvc':_0x29ca6d(0x209),'holderName':_0x29ca6d(0x20b)}}});}catch(_0x42986e){_0x2a0cec(_0x42986e);}},this[_0x5b66f4(0x1ba)]=async(_0xf0644,_0x43e5c9,_0x13479f)=>{const _0x3e999f=_0x5b66f4;try{const {paymentId:_0x1e6a1}=_0xf0644['params'],_0x25bfd4=_0xf0644[_0x3e999f(0x1d2)];console[_0x3e999f(0x1df)](_0x3e999f(0x1be)+_0x1e6a1);const _0x428e2c=await database_1['default'][_0x3e999f(0x21e)][_0x3e999f(0x22f)]({'where':{'id':_0x1e6a1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x428e2c)return _0x43e5c9[_0x3e999f(0x1d1)](0x194)[_0x3e999f(0x1c0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x428e2c[_0x3e999f(0x20a)]!==_0x3e999f(0x224))return _0x43e5c9[_0x3e999f(0x1d1)](0x190)[_0x3e999f(0x1c0)]({'success':![],'message':_0x3e999f(0x1fd)});if(_0x428e2c['status']!==_0x3e999f(0x20c))return _0x43e5c9[_0x3e999f(0x1d1)](0x190)[_0x3e999f(0x1c0)]({'success':![],'message':_0x3e999f(0x205)+_0x428e2c['status']+_0x3e999f(0x1f7)});const _0x143d04=await this[_0x3e999f(0x229)]['processCardPayment']({'paymentId':_0x428e2c['id'],'orderId':_0x428e2c[_0x3e999f(0x1da)]||_0x428e2c['id'],'amount':_0x428e2c[_0x3e999f(0x1de)],'currency':_0x428e2c['currency'],'cardData':_0x25bfd4});console['log'](_0x3e999f(0x206),_0x143d04);const _0x1d5efd={'status':_0x143d04[_0x3e999f(0x1d1)],'updatedAt':new Date()};if(_0x143d04[_0x3e999f(0x1d1)]===_0x3e999f(0x1f0))_0x1d5efd[_0x3e999f(0x225)]=new Date(),_0x1d5efd[_0x3e999f(0x1c9)]=_0x143d04[_0x3e999f(0x1d8)];else _0x143d04[_0x3e999f(0x1d1)]==='FAILED'&&(_0x1d5efd[_0x3e999f(0x22c)]=_0x143d04[_0x3e999f(0x1b8)]);const _0x509182=_0x25bfd4[_0x3e999f(0x1c7)][_0x3e999f(0x21b)](/[\s-]/g,'');_0x1d5efd['cardLast4']=_0x509182[_0x3e999f(0x219)](-0x4),_0x1d5efd['paymentMethod']=_0x3e999f(0x1e9),await database_1['default']['payment'][_0x3e999f(0x1c1)]({'where':{'id':_0x428e2c['id']},'data':_0x1d5efd});if(_0x143d04[_0x3e999f(0x1d1)]==='PAID'&&_0x428e2c['paymentLinkId']){console[_0x3e999f(0x1df)](_0x3e999f(0x221)+_0x428e2c['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x3e999f(0x216)](async _0x9ca161=>{const _0x3d2334=_0x3e999f,_0xead05a=await _0x9ca161[_0x3d2334(0x1bc)][_0x3d2334(0x22f)]({'where':{'id':_0x428e2c[_0x3d2334(0x1ed)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xead05a){console['log'](_0x3d2334(0x202)+_0xead05a['id']+_0x3d2334(0x1ec)+_0xead05a['type']+_0x3d2334(0x1c4)+_0xead05a[_0x3d2334(0x1d5)]+_0x3d2334(0x21a)+_0xead05a[_0x3d2334(0x1d1)]);const _0x4fe71c=_0xead05a['currentPayments']+0x1,_0x2230be=_0xead05a['type']===_0x3d2334(0x1dc)?_0x3d2334(0x1ee):_0xead05a[_0x3d2334(0x1d1)];await _0x9ca161['paymentLink'][_0x3d2334(0x1c1)]({'where':{'id':_0x428e2c[_0x3d2334(0x1ed)]},'data':{'currentPayments':_0x4fe71c,'status':_0x2230be,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0xead05a['id']+_0x3d2334(0x1cd)+_0xead05a[_0x3d2334(0x1d5)]+_0x3d2334(0x22a)+_0x4fe71c+',\x20status='+_0xead05a[_0x3d2334(0x1d1)]+_0x3d2334(0x22a)+_0x2230be);}else console[_0x3d2334(0x1df)](_0x3d2334(0x1f4)+_0x428e2c[_0x3d2334(0x1ed)]+_0x3d2334(0x1cb));});}catch(_0x314af4){console[_0x3e999f(0x1fc)](_0x3e999f(0x1ef),_0x314af4);}}await database_1['default'][_0x3e999f(0x1e8)]['create']({'data':{'paymentId':_0x428e2c['id'],'shopId':_0x428e2c[_0x3e999f(0x1d9)],'event':'test_gateway_'+_0x143d04[_0x3e999f(0x1d1)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3e999f(0x1cf)]({'oldStatus':'PENDING','newStatus':_0x143d04[_0x3e999f(0x1d1)],'transactionId':_0x143d04[_0x3e999f(0x1d8)],'failureReason':_0x143d04[_0x3e999f(0x1b8)],'processedAt':new Date()['toISOString']()})}}),await this[_0x3e999f(0x1db)](_0x428e2c,_0x143d04[_0x3e999f(0x1d1)],_0x143d04[_0x3e999f(0x1d8)],_0x143d04[_0x3e999f(0x1b8)]),await this[_0x3e999f(0x1cc)](_0x428e2c,_0x143d04['status']),console['log'](_0x3e999f(0x1e1)+_0x1e6a1+'\x20processed:\x20'+_0x143d04[_0x3e999f(0x1d1)]),_0x143d04[_0x3e999f(0x1d1)]===_0x3e999f(0x1f0)?_0x43e5c9['json']({'success':!![],'message':_0x3e999f(0x1e0),'result':{'status':'PAID','transactionId':_0x143d04[_0x3e999f(0x1d8)],'redirectUrl':_0x428e2c['successUrl']}}):_0x43e5c9['status'](0x190)[_0x3e999f(0x1c0)]({'success':![],'message':_0x3e999f(0x212),'result':{'status':_0x3e999f(0x1f6),'failureReason':_0x143d04[_0x3e999f(0x1b8)],'redirectUrl':_0x428e2c[_0x3e999f(0x1c2)]}});}catch(_0x222ce9){_0x13479f(_0x222ce9);}},this[_0x5b66f4(0x229)]=new testGatewayService_1['TestGatewayService'](),this[_0x5b66f4(0x1c8)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x592fde,_0x4357f8,_0x4b5db2,_0x2914b3){const _0x5d50d5=a14_0x45012a,_0x190735=Date['now']();try{const _0x54c544=_0x592fde[_0x5d50d5(0x1d0)],_0x3ef372=_0x54c544[_0x5d50d5(0x20e)];if(!_0x3ef372?.[_0x5d50d5(0x1d6)]){console[_0x5d50d5(0x1df)](_0x5d50d5(0x1b6)+_0x54c544['id']);return;}const _0x52aa5a=_0x4357f8===_0x5d50d5(0x1f0)?_0x5d50d5(0x1f3):_0x5d50d5(0x1fe);let _0x152ffb=[];if(_0x3ef372[_0x5d50d5(0x1c6)])try{_0x152ffb=Array[_0x5d50d5(0x204)](_0x3ef372[_0x5d50d5(0x1c6)])?_0x3ef372[_0x5d50d5(0x1c6)]:JSON[_0x5d50d5(0x203)](_0x3ef372[_0x5d50d5(0x1c6)]);}catch(_0x2d9d2b){console[_0x5d50d5(0x1fc)](_0x5d50d5(0x201),_0x2d9d2b),_0x152ffb=[];}if(!_0x152ffb[_0x5d50d5(0x227)](_0x52aa5a)){console['log']('Webhook\x20event\x20'+_0x52aa5a+_0x5d50d5(0x218)+_0x54c544['id']);return;}const _0x23bef2={'event':_0x52aa5a,'payment':{'id':_0x592fde['id'],'order_id':_0x592fde[_0x5d50d5(0x21c)],'gateway_order_id':_0x592fde[_0x5d50d5(0x1da)],'gateway':'0000','amount':_0x592fde[_0x5d50d5(0x1de)],'currency':_0x592fde[_0x5d50d5(0x220)],'status':_0x4357f8[_0x5d50d5(0x226)](),'customer_email':_0x592fde['customerEmail'],'customer_name':_0x592fde['customerName'],'transaction_id':_0x4b5db2,'failure_message':_0x2914b3,'created_at':_0x592fde[_0x5d50d5(0x223)],'updated_at':new Date()}},_0xb4619f=await fetch(_0x3ef372['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x5d50d5(0x22e),'User-Agent':_0x5d50d5(0x1e7)},'body':JSON[_0x5d50d5(0x1cf)](_0x23bef2)}),_0x4d1408=Date[_0x5d50d5(0x1c5)]()-_0x190735;console[_0x5d50d5(0x1df)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x3ef372['webhookUrl']+_0x5d50d5(0x208)+_0xb4619f['status']+'\x20('+_0x4d1408+_0x5d50d5(0x20d));}catch(_0x5bcb46){console[_0x5d50d5(0x1fc)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x5bcb46);}}async[a14_0x45012a(0x1cc)](_0x3d9895,_0x37a937){const _0x5a5732=a14_0x45012a;try{const {telegramBotService:_0x251e6b}=await Promise[_0x5a5732(0x1f1)]()[_0x5a5732(0x1c3)](()=>__importStar(require(_0x5a5732(0x1b7)))),_0x17d093={'PAID':_0x5a5732(0x1d7),'FAILED':_0x5a5732(0x211)},_0x1bb220=_0x17d093[_0x37a937];if(!_0x1bb220)return;await _0x251e6b['sendPaymentNotification'](_0x3d9895[_0x5a5732(0x1d9)],_0x3d9895,_0x1bb220);}catch(_0x91cde3){console['error'](_0x5a5732(0x1e5),_0x91cde3);}}}exports[a14_0x45012a(0x1f2)]=TestGatewayController;