'use strict';function a15_0x9c59(){const _0x5e2350=['isArray','paymentLink','Error\x20parsing\x20webhook\x20events:','length','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','../services/gateways/testGatewayService','body','paymentLinkId','getPaymentForm','COMPLETED','toISOString','replace','transactionId','update','105KFQbkW','getOwnPropertyDescriptor','failureMessage','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookService','status','test_gateway','1920488VLEsKR','6XrqZoy','Payment\x20System/1.0\x20(Test\x20Gateway)','paid',',\x20currentPayments=','Payment\x20not\x20found',',\x20status=','json','gatewayOrderId','📈\x20Found\x20payment\x20link\x20','72leXUsI','default','FAILED','currentPayments','get','payment',',\x20cannot\x20process','../config/database','getOwnPropertyNames','sendPaymentStatusNotification','Payment\x20failed','webhookEvents','\x20not\x20enabled\x20for\x20shop\x20','TestGatewayController','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/webhookService','writable','\x20updated:\x20currentPayments=','create','defineProperty','currency','../services/telegramBotService','shop','payment.success','✅\x20Test\x20Gateway\x20payment\x20','configurable','5946DnuIln','425041pLkGga','0000','SINGLE','gatewayPaymentId','❌\x20Payment\x20link\x20','\x20processed:\x20','then','Payment\x20status\x20is\x20','788664MkkgfP','sendShopWebhook','error','failUrl','__importDefault','slice','TestGatewayService','webhookUrl','sendPaymentNotification','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','toLowerCase','POST','amount','now','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','testGatewayService','Any\x20future\x20date\x20(MM/YY)','findUnique','createdAt','failureReason','🧪\x20Test\x20Gateway\x20result:','__esModule','WebhookService','__createBinding','438783NtQGRe','test_card','processCard','426330gtLeTS','703805YAAQBJ','\x20not\x20found','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','orderId','cardNumber','✅\x20Payment\x20link\x20','type','PENDING','successUrl','PAID','4242\x204242\x204242\x204242','paymentMethod','\x20->\x20','customerEmail','$transaction','log','Webhook\x20event\x20','payment.failed','params','stringify','application/json','call','paidAt','gateway','includes','Any\x20other\x20card\x20number','__importStar','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'];a15_0x9c59=function(){return _0x5e2350;};return a15_0x9c59();}const a15_0x3e0b59=a15_0x3d48;function a15_0x3d48(_0xea3a09,_0x58d39d){const _0x9c59c9=a15_0x9c59();return a15_0x3d48=function(_0x3d4848,_0x4d9750){_0x3d4848=_0x3d4848-0x12d;let _0xb46789=_0x9c59c9[_0x3d4848];return _0xb46789;},a15_0x3d48(_0xea3a09,_0x58d39d);}(function(_0x2d72a0,_0x352331){const _0x332339=a15_0x3d48,_0x442e43=_0x2d72a0();while(!![]){try{const _0x5249f8=-parseInt(_0x332339(0x170))/0x1+-parseInt(_0x332339(0x14c))/0x2*(-parseInt(_0x332339(0x191))/0x3)+parseInt(_0x332339(0x14b))/0x4+parseInt(_0x332339(0x195))/0x5+-parseInt(_0x332339(0x16f))/0x6*(parseInt(_0x332339(0x144))/0x7)+parseInt(_0x332339(0x178))/0x8+parseInt(_0x332339(0x155))/0x9*(-parseInt(_0x332339(0x194))/0xa);if(_0x5249f8===_0x352331)break;else _0x442e43['push'](_0x442e43['shift']());}catch(_0x1347d4){_0x442e43['push'](_0x442e43['shift']());}}}(a15_0x9c59,0x5c1bf));var __createBinding=this&&this[a15_0x3e0b59(0x190)]||(Object[a15_0x3e0b59(0x167)]?function(_0x555f41,_0x32fe4b,_0x535f37,_0x3cb4bf){const _0x5f04f7=a15_0x3e0b59;if(_0x3cb4bf===undefined)_0x3cb4bf=_0x535f37;var _0x17bbb6=Object[_0x5f04f7(0x145)](_0x32fe4b,_0x535f37);(!_0x17bbb6||(_0x5f04f7(0x159)in _0x17bbb6?!_0x32fe4b[_0x5f04f7(0x18e)]:_0x17bbb6[_0x5f04f7(0x165)]||_0x17bbb6[_0x5f04f7(0x16e)]))&&(_0x17bbb6={'enumerable':!![],'get':function(){return _0x32fe4b[_0x535f37];}}),Object[_0x5f04f7(0x168)](_0x555f41,_0x3cb4bf,_0x17bbb6);}:function(_0x15a5d9,_0x19bc92,_0x5e5c0b,_0x3cc783){if(_0x3cc783===undefined)_0x3cc783=_0x5e5c0b;_0x15a5d9[_0x3cc783]=_0x19bc92[_0x5e5c0b];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a15_0x3e0b59(0x167)]?function(_0x677ac,_0x4f5fdf){const _0x557b12=a15_0x3e0b59;Object[_0x557b12(0x168)](_0x677ac,_0x557b12(0x156),{'enumerable':!![],'value':_0x4f5fdf});}:function(_0x2f286,_0x461c39){_0x2f286['default']=_0x461c39;}),__importStar=this&&this[a15_0x3e0b59(0x134)]||(function(){var _0x176de1=function(_0x6f4318){const _0x1f6f62=a15_0x3d48;return _0x176de1=Object[_0x1f6f62(0x15d)]||function(_0x201096){const _0x2e4ba7=_0x1f6f62;var _0x18af05=[];for(var _0x3d0126 in _0x201096)if(Object['prototype']['hasOwnProperty'][_0x2e4ba7(0x12f)](_0x201096,_0x3d0126))_0x18af05[_0x18af05[_0x2e4ba7(0x139)]]=_0x3d0126;return _0x18af05;},_0x176de1(_0x6f4318);};return function(_0x162126){const _0x1c6c55=a15_0x3d48;if(_0x162126&&_0x162126[_0x1c6c55(0x18e)])return _0x162126;var _0x5a05c6={};if(_0x162126!=null){for(var _0xe9ae05=_0x176de1(_0x162126),_0x1fec27=0x0;_0x1fec27<_0xe9ae05['length'];_0x1fec27++)if(_0xe9ae05[_0x1fec27]!=='default')__createBinding(_0x5a05c6,_0x162126,_0xe9ae05[_0x1fec27]);}return __setModuleDefault(_0x5a05c6,_0x162126),_0x5a05c6;};}()),__importDefault=this&&this[a15_0x3e0b59(0x17c)]||function(_0x1c2f56){const _0x4ecdc1=a15_0x3e0b59;return _0x1c2f56&&_0x1c2f56[_0x4ecdc1(0x18e)]?_0x1c2f56:{'default':_0x1c2f56};};Object[a15_0x3e0b59(0x168)](exports,'__esModule',{'value':!![]}),exports[a15_0x3e0b59(0x162)]=void 0x0;const testGatewayService_1=require(a15_0x3e0b59(0x13b)),webhookService_1=require(a15_0x3e0b59(0x164)),database_1=__importDefault(require(a15_0x3e0b59(0x15c)));class TestGatewayController{constructor(){const _0x5204be=a15_0x3e0b59;this[_0x5204be(0x13e)]=async(_0x4c4b71,_0x14f31a,_0x1ee9bb)=>{const _0x248b4f=_0x5204be;try{const {paymentId:_0x2fd0bf}=_0x4c4b71[_0x248b4f(0x1a7)];console[_0x248b4f(0x1a4)](_0x248b4f(0x13a)+_0x2fd0bf);const _0x52a850=await database_1[_0x248b4f(0x156)]['payment'][_0x248b4f(0x18a)]({'where':{'id':_0x2fd0bf},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x52a850)return _0x14f31a[_0x248b4f(0x149)](0x194)[_0x248b4f(0x152)]({'success':![],'message':_0x248b4f(0x150)});if(_0x52a850[_0x248b4f(0x131)]!==_0x248b4f(0x14a))return _0x14f31a['status'](0x190)[_0x248b4f(0x152)]({'success':![],'message':_0x248b4f(0x186)});if(_0x52a850['status']!==_0x248b4f(0x19c))return _0x14f31a[_0x248b4f(0x149)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x52a850['status']+_0x248b4f(0x15b)});_0x14f31a[_0x248b4f(0x152)]({'success':!![],'result':{'paymentId':_0x52a850['id'],'orderId':_0x52a850['gatewayOrderId'],'amount':_0x52a850['amount'],'currency':_0x52a850['currency'],'merchantName':_0x52a850[_0x248b4f(0x16b)]['name'],'description':'Payment\x20to\x20'+_0x52a850[_0x248b4f(0x16b)]['name'],'testInstructions':{'successCard':_0x248b4f(0x19f),'failureCard':_0x248b4f(0x133),'expiryDate':_0x248b4f(0x189),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x4c6bf3){_0x1ee9bb(_0x4c6bf3);}},this[_0x5204be(0x193)]=async(_0x7539d5,_0x4e6659,_0x58bf60)=>{const _0xefc536=_0x5204be;try{const {paymentId:_0x422bd0}=_0x7539d5['params'],_0xdf94d1=_0x7539d5[_0xefc536(0x13c)];console['log'](_0xefc536(0x135)+_0x422bd0);const _0x2b9b21=await database_1[_0xefc536(0x156)][_0xefc536(0x15a)][_0xefc536(0x18a)]({'where':{'id':_0x422bd0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b9b21)return _0x4e6659['status'](0x194)[_0xefc536(0x152)]({'success':![],'message':_0xefc536(0x150)});if(_0x2b9b21[_0xefc536(0x131)]!==_0xefc536(0x14a))return _0x4e6659[_0xefc536(0x149)](0x190)[_0xefc536(0x152)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2b9b21[_0xefc536(0x149)]!==_0xefc536(0x19c))return _0x4e6659[_0xefc536(0x149)](0x190)[_0xefc536(0x152)]({'success':![],'message':_0xefc536(0x177)+_0x2b9b21[_0xefc536(0x149)]+_0xefc536(0x15b)});const _0x187350=await this['testGatewayService']['processCardPayment']({'paymentId':_0x2b9b21['id'],'orderId':_0x2b9b21[_0xefc536(0x153)]||_0x2b9b21['id'],'amount':_0x2b9b21['amount'],'currency':_0x2b9b21[_0xefc536(0x169)],'cardData':_0xdf94d1});console[_0xefc536(0x1a4)](_0xefc536(0x18d),_0x187350);const _0x28e7f6={'status':_0x187350[_0xefc536(0x149)],'updatedAt':new Date()};if(_0x187350[_0xefc536(0x149)]===_0xefc536(0x19e))_0x28e7f6[_0xefc536(0x130)]=new Date(),_0x28e7f6[_0xefc536(0x173)]=_0x187350[_0xefc536(0x142)];else _0x187350['status']==='FAILED'&&(_0x28e7f6[_0xefc536(0x146)]=_0x187350[_0xefc536(0x18c)]);const _0x43dafa=_0xdf94d1[_0xefc536(0x199)][_0xefc536(0x141)](/[\s-]/g,'');_0x28e7f6['cardLast4']=_0x43dafa[_0xefc536(0x17d)](-0x4),_0x28e7f6[_0xefc536(0x1a0)]=_0xefc536(0x192),await database_1[_0xefc536(0x156)][_0xefc536(0x15a)][_0xefc536(0x143)]({'where':{'id':_0x2b9b21['id']},'data':_0x28e7f6});if(_0x187350[_0xefc536(0x149)]===_0xefc536(0x19e)&&_0x2b9b21[_0xefc536(0x13d)]){console[_0xefc536(0x1a4)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x2b9b21['id']+_0xefc536(0x197));try{await database_1[_0xefc536(0x156)][_0xefc536(0x1a3)](async _0x4af321=>{const _0x36a36a=_0xefc536,_0x471263=await _0x4af321[_0x36a36a(0x137)][_0x36a36a(0x18a)]({'where':{'id':_0x2b9b21[_0x36a36a(0x13d)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x471263){console[_0x36a36a(0x1a4)](_0x36a36a(0x154)+_0x471263['id']+':\x20type='+_0x471263[_0x36a36a(0x19b)]+_0x36a36a(0x14f)+_0x471263[_0x36a36a(0x158)]+_0x36a36a(0x151)+_0x471263[_0x36a36a(0x149)]);const _0x378393=_0x471263[_0x36a36a(0x158)]+0x1,_0x453de4=_0x471263[_0x36a36a(0x19b)]===_0x36a36a(0x172)?_0x36a36a(0x13f):_0x471263[_0x36a36a(0x149)];await _0x4af321['paymentLink'][_0x36a36a(0x143)]({'where':{'id':_0x2b9b21[_0x36a36a(0x13d)]},'data':{'currentPayments':_0x378393,'status':_0x453de4,'updatedAt':new Date()}}),console[_0x36a36a(0x1a4)](_0x36a36a(0x19a)+_0x471263['id']+_0x36a36a(0x166)+_0x471263[_0x36a36a(0x158)]+'\x20->\x20'+_0x378393+',\x20status='+_0x471263[_0x36a36a(0x149)]+_0x36a36a(0x1a1)+_0x453de4);}else console[_0x36a36a(0x1a4)](_0x36a36a(0x174)+_0x2b9b21[_0x36a36a(0x13d)]+_0x36a36a(0x196));});}catch(_0x1186e8){console[_0xefc536(0x17a)](_0xefc536(0x181),_0x1186e8);}}await database_1['default']['webhookLog'][_0xefc536(0x167)]({'data':{'paymentId':_0x2b9b21['id'],'shopId':_0x2b9b21['shopId'],'event':_0xefc536(0x187)+_0x187350[_0xefc536(0x149)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xefc536(0x12d)]({'oldStatus':_0xefc536(0x19c),'newStatus':_0x187350['status'],'transactionId':_0x187350['transactionId'],'failureReason':_0x187350[_0xefc536(0x18c)],'processedAt':new Date()[_0xefc536(0x140)]()})}}),await this[_0xefc536(0x179)](_0x2b9b21,_0x187350[_0xefc536(0x149)],_0x187350[_0xefc536(0x142)],_0x187350[_0xefc536(0x18c)]),await this[_0xefc536(0x15e)](_0x2b9b21,_0x187350[_0xefc536(0x149)]),console[_0xefc536(0x1a4)](_0xefc536(0x16d)+_0x422bd0+_0xefc536(0x175)+_0x187350[_0xefc536(0x149)]),_0x187350[_0xefc536(0x149)]==='PAID'?_0x4e6659['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x187350[_0xefc536(0x142)],'redirectUrl':_0x2b9b21[_0xefc536(0x19d)]}}):_0x4e6659[_0xefc536(0x149)](0x190)[_0xefc536(0x152)]({'success':![],'message':_0xefc536(0x15f),'result':{'status':_0xefc536(0x157),'failureReason':_0x187350[_0xefc536(0x18c)],'redirectUrl':_0x2b9b21[_0xefc536(0x17b)]}});}catch(_0x1ace87){_0x58bf60(_0x1ace87);}},this[_0x5204be(0x188)]=new testGatewayService_1[(_0x5204be(0x17e))](),this[_0x5204be(0x148)]=new webhookService_1[(_0x5204be(0x18f))]();}async[a15_0x3e0b59(0x179)](_0x3893a9,_0x3c17cc,_0x5a3524,_0x4318f4){const _0x14d81c=a15_0x3e0b59,_0x57531e=Date[_0x14d81c(0x185)]();try{const _0x5c2f80=_0x3893a9[_0x14d81c(0x16b)],_0x263c0d=_0x5c2f80['settings'];if(!_0x263c0d?.['webhookUrl']){console['log'](_0x14d81c(0x163)+_0x5c2f80['id']);return;}const _0x301472=_0x3c17cc===_0x14d81c(0x19e)?_0x14d81c(0x16c):_0x14d81c(0x1a6);let _0x3e042b=[];if(_0x263c0d[_0x14d81c(0x160)])try{_0x3e042b=Array[_0x14d81c(0x136)](_0x263c0d[_0x14d81c(0x160)])?_0x263c0d[_0x14d81c(0x160)]:JSON['parse'](_0x263c0d['webhookEvents']);}catch(_0x3b7391){console['error'](_0x14d81c(0x138),_0x3b7391),_0x3e042b=[];}if(!_0x3e042b[_0x14d81c(0x132)](_0x301472)){console[_0x14d81c(0x1a4)](_0x14d81c(0x1a5)+_0x301472+_0x14d81c(0x161)+_0x5c2f80['id']);return;}const _0x528f9f={'event':_0x301472,'payment':{'id':_0x3893a9['id'],'order_id':_0x3893a9[_0x14d81c(0x198)],'gateway_order_id':_0x3893a9[_0x14d81c(0x153)],'gateway':_0x14d81c(0x171),'amount':_0x3893a9[_0x14d81c(0x184)],'currency':_0x3893a9[_0x14d81c(0x169)],'status':_0x3c17cc[_0x14d81c(0x182)](),'customer_email':_0x3893a9[_0x14d81c(0x1a2)],'customer_name':_0x3893a9['customerName'],'transaction_id':_0x5a3524,'failure_message':_0x4318f4,'created_at':_0x3893a9[_0x14d81c(0x18b)],'updated_at':new Date()}},_0x4aed72=await fetch(_0x263c0d[_0x14d81c(0x17f)],{'method':_0x14d81c(0x183),'headers':{'Content-Type':_0x14d81c(0x12e),'User-Agent':_0x14d81c(0x14d)},'body':JSON['stringify'](_0x528f9f)}),_0x3b872f=Date[_0x14d81c(0x185)]()-_0x57531e;console[_0x14d81c(0x1a4)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x263c0d[_0x14d81c(0x17f)]+'\x20with\x20status\x20'+_0x4aed72[_0x14d81c(0x149)]+'\x20('+_0x3b872f+'ms)');}catch(_0xe7974d){console['error'](_0x14d81c(0x147),_0xe7974d);}}async[a15_0x3e0b59(0x15e)](_0x4ac3af,_0x5c4be9){const _0x44f730=a15_0x3e0b59;try{const {telegramBotService:_0xb275dc}=await Promise['resolve']()[_0x44f730(0x176)](()=>__importStar(require(_0x44f730(0x16a)))),_0x2ee393={'PAID':_0x44f730(0x14e),'FAILED':'failed'},_0x48d3e4=_0x2ee393[_0x5c4be9];if(!_0x48d3e4)return;await _0xb275dc[_0x44f730(0x180)](_0x4ac3af['shopId'],_0x4ac3af,_0x48d3e4);}catch(_0x313d58){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x313d58);}}}exports[a15_0x3e0b59(0x162)]=TestGatewayController;