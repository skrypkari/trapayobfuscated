'use strict';const a19_0x4db21d=a19_0x4f05;function a19_0x4f05(_0x2824f7,_0x4bb0c9){_0x2824f7=_0x2824f7-0x85;const _0x433e5a=a19_0x433e();let _0x4f052f=_0x433e5a[_0x2824f7];return _0x4f052f;}(function(_0x5cebd9,_0x5dcf6a){const _0x12cad6=a19_0x4f05,_0x8c356b=_0x5cebd9();while(!![]){try{const _0x26c81f=parseInt(_0x12cad6(0xfa))/0x1+parseInt(_0x12cad6(0x90))/0x2+parseInt(_0x12cad6(0xce))/0x3*(-parseInt(_0x12cad6(0xda))/0x4)+parseInt(_0x12cad6(0xaf))/0x5+parseInt(_0x12cad6(0xd6))/0x6*(-parseInt(_0x12cad6(0xd2))/0x7)+parseInt(_0x12cad6(0xe0))/0x8*(parseInt(_0x12cad6(0xa0))/0x9)+parseInt(_0x12cad6(0x100))/0xa*(parseInt(_0x12cad6(0x9f))/0xb);if(_0x26c81f===_0x5dcf6a)break;else _0x8c356b['push'](_0x8c356b['shift']());}catch(_0xc2e862){_0x8c356b['push'](_0x8c356b['shift']());}}}(a19_0x433e,0xa5d28));function a19_0x433e(){const _0x376497=['defineProperty','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currentPayments','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','replace','payment.success','call','toISOString','\x20not\x20enabled\x20for\x20shop\x20',':\x20type=','customerEmail','\x20with\x20status\x20','Error\x20parsing\x20webhook\x20events:','Any\x20other\x20card\x20number','gatewayOrderId','create','603804KePqNL','paidAt','Test\x20Gateway\x20webhook\x20sent\x20to\x20','‚úÖ\x20Test\x20Gateway\x20payment\x20','409577pheUDN','sendShopWebhook','slice','params','114ojYgbf','üß™\x20Test\x20Gateway\x20result:','../services/webhookService','findUnique','20fkxmST','getOwnPropertyDescriptor','‚ùå\x20Payment\x20link\x20','__esModule',',\x20cannot\x20process','test_card','90968voWpaM','../services/gateways/testGatewayService','transactionId','type','Payment\x20status\x20is\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','üìà\x20Test\x20Gateway:\x20Payment\x20','webhookEvents','get','TestGatewayController','currency','isArray','__importStar','gatewayPaymentId','test_gateway','test_gateway_','paymentLink','COMPLETED','failureReason','successUrl',',\x20status=','failUrl','sendPaymentStatusNotification','writable','getPaymentForm','resolve','134266hliuaa','parse','üìà\x20Found\x20payment\x20link\x20','processCardPayment','prototype','\x20updated:\x20currentPayments=','20UjnQLV','ms)','__importDefault','body','TestGatewayService','Any\x20name','paymentLinkId','Payment\x20not\x20found','createdAt','0000','PENDING','shop','478964gJnonc','Payment\x20to\x20','sendPaymentNotification','failureMessage','\x20processed:\x20','stringify','‚úÖ\x20Payment\x20link\x20','webhookLog','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20failed','paymentMethod','$transaction','Any\x203-4\x20digits','length','status','7096639rOzxtD','333csAaOR','../config/database','FAILED','Payment\x20processed\x20successfully','webhookUrl','../services/telegramBotService','webhookService','gateway','PAID','log','json','testGatewayService','default','4242\x204242\x204242\x204242',',\x20currentPayments=','3562420HZscQf','update','application/json','amount','failed','Webhook\x20event\x20','cardLast4','name','payment','settings','toLowerCase','payment.failed','then','shopId','error'];a19_0x433e=function(){return _0x376497;};return a19_0x433e();}var __createBinding=this&&this['__createBinding']||(Object[a19_0x4db21d(0xcd)]?function(_0x7f5043,_0x357e1f,_0x193039,_0x79a020){const _0x27697a=a19_0x4db21d;if(_0x79a020===undefined)_0x79a020=_0x193039;var _0x5436a9=Object[_0x27697a(0xdb)](_0x357e1f,_0x193039);(!_0x5436a9||(_0x27697a(0xe8)in _0x5436a9?!_0x357e1f[_0x27697a(0xdd)]:_0x5436a9[_0x27697a(0xf7)]||_0x5436a9['configurable']))&&(_0x5436a9={'enumerable':!![],'get':function(){return _0x357e1f[_0x193039];}}),Object[_0x27697a(0xbe)](_0x7f5043,_0x79a020,_0x5436a9);}:function(_0x4a02d3,_0x17ba24,_0x1139ea,_0x535773){if(_0x535773===undefined)_0x535773=_0x1139ea;_0x4a02d3[_0x535773]=_0x17ba24[_0x1139ea];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x462aaa,_0x19ee4f){const _0x2bcf68=a19_0x4db21d;Object['defineProperty'](_0x462aaa,_0x2bcf68(0xac),{'enumerable':!![],'value':_0x19ee4f});}:function(_0x1ca19d,_0x217bb9){const _0x26a094=a19_0x4db21d;_0x1ca19d[_0x26a094(0xac)]=_0x217bb9;}),__importStar=this&&this[a19_0x4db21d(0xec)]||(function(){var _0x2844d4=function(_0x46ee7a){return _0x2844d4=Object['getOwnPropertyNames']||function(_0x10fb5f){const _0x2552bf=a19_0x4f05;var _0x497712=[];for(var _0x31d0b0 in _0x10fb5f)if(Object[_0x2552bf(0xfe)]['hasOwnProperty'][_0x2552bf(0xc4)](_0x10fb5f,_0x31d0b0))_0x497712[_0x497712[_0x2552bf(0x9d)]]=_0x31d0b0;return _0x497712;},_0x2844d4(_0x46ee7a);};return function(_0x2fa440){const _0x3315e9=a19_0x4f05;if(_0x2fa440&&_0x2fa440[_0x3315e9(0xdd)])return _0x2fa440;var _0x1e9c1a={};if(_0x2fa440!=null){for(var _0x4e322d=_0x2844d4(_0x2fa440),_0x2c1a07=0x0;_0x2c1a07<_0x4e322d['length'];_0x2c1a07++)if(_0x4e322d[_0x2c1a07]!==_0x3315e9(0xac))__createBinding(_0x1e9c1a,_0x2fa440,_0x4e322d[_0x2c1a07]);}return __setModuleDefault(_0x1e9c1a,_0x2fa440),_0x1e9c1a;};}()),__importDefault=this&&this[a19_0x4db21d(0x86)]||function(_0x71ad1c){const _0x3a6e6f=a19_0x4db21d;return _0x71ad1c&&_0x71ad1c[_0x3a6e6f(0xdd)]?_0x71ad1c:{'default':_0x71ad1c};};Object[a19_0x4db21d(0xbe)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a19_0x4db21d(0xe1)),webhookService_1=require(a19_0x4db21d(0xd8)),database_1=__importDefault(require(a19_0x4db21d(0xa1)));class TestGatewayController{constructor(){const _0x317817=a19_0x4db21d;this[_0x317817(0xf8)]=async(_0x3047e4,_0xae410,_0x235e43)=>{const _0x345a40=_0x317817;try{const {paymentId:_0x384680}=_0x3047e4[_0x345a40(0xd5)];console[_0x345a40(0xa9)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x384680);const _0x2c1eac=await database_1[_0x345a40(0xac)]['payment'][_0x345a40(0xd9)]({'where':{'id':_0x384680},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2c1eac)return _0xae410[_0x345a40(0x9e)](0x194)[_0x345a40(0xaa)]({'success':![],'message':_0x345a40(0x8b)});if(_0x2c1eac[_0x345a40(0xa7)]!==_0x345a40(0xee))return _0xae410[_0x345a40(0x9e)](0x190)[_0x345a40(0xaa)]({'success':![],'message':_0x345a40(0xe5)});if(_0x2c1eac[_0x345a40(0x9e)]!==_0x345a40(0x8e))return _0xae410['status'](0x190)['json']({'success':![],'message':_0x345a40(0xe4)+_0x2c1eac['status']+_0x345a40(0xde)});_0xae410[_0x345a40(0xaa)]({'success':!![],'result':{'paymentId':_0x2c1eac['id'],'orderId':_0x2c1eac[_0x345a40(0xcc)],'amount':_0x2c1eac[_0x345a40(0xb2)],'currency':_0x2c1eac['currency'],'merchantName':_0x2c1eac[_0x345a40(0x8f)][_0x345a40(0xb6)],'description':_0x345a40(0x91)+_0x2c1eac[_0x345a40(0x8f)]['name'],'testInstructions':{'successCard':_0x345a40(0xad),'failureCard':_0x345a40(0xcb),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x345a40(0x9c),'holderName':_0x345a40(0x89)}}});}catch(_0x311e76){_0x235e43(_0x311e76);}},this['processCard']=async(_0x197532,_0x201672,_0x14bf74)=>{const _0x4a3ce9=_0x317817;try{const {paymentId:_0x1d28a7}=_0x197532['params'],_0x4f6df9=_0x197532[_0x4a3ce9(0x87)];console[_0x4a3ce9(0xa9)](_0x4a3ce9(0x98)+_0x1d28a7);const _0xe4d52b=await database_1[_0x4a3ce9(0xac)][_0x4a3ce9(0xb7)][_0x4a3ce9(0xd9)]({'where':{'id':_0x1d28a7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe4d52b)return _0x201672[_0x4a3ce9(0x9e)](0x194)[_0x4a3ce9(0xaa)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xe4d52b[_0x4a3ce9(0xa7)]!=='test_gateway')return _0x201672['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0xe4d52b['status']!==_0x4a3ce9(0x8e))return _0x201672[_0x4a3ce9(0x9e)](0x190)[_0x4a3ce9(0xaa)]({'success':![],'message':_0x4a3ce9(0xe4)+_0xe4d52b[_0x4a3ce9(0x9e)]+',\x20cannot\x20process'});const _0x5aa925=await this[_0x4a3ce9(0xab)][_0x4a3ce9(0xfd)]({'paymentId':_0xe4d52b['id'],'orderId':_0xe4d52b[_0x4a3ce9(0xcc)]||_0xe4d52b['id'],'amount':_0xe4d52b[_0x4a3ce9(0xb2)],'currency':_0xe4d52b[_0x4a3ce9(0xea)],'cardData':_0x4f6df9});console[_0x4a3ce9(0xa9)](_0x4a3ce9(0xd7),_0x5aa925);const _0x2df4ad={'status':_0x5aa925[_0x4a3ce9(0x9e)],'updatedAt':new Date()};if(_0x5aa925['status']==='PAID')_0x2df4ad[_0x4a3ce9(0xcf)]=new Date(),_0x2df4ad[_0x4a3ce9(0xed)]=_0x5aa925[_0x4a3ce9(0xe2)];else _0x5aa925['status']===_0x4a3ce9(0xa2)&&(_0x2df4ad[_0x4a3ce9(0x93)]=_0x5aa925['failureReason']);const _0x19e780=_0x4f6df9['cardNumber'][_0x4a3ce9(0xc2)](/[\s-]/g,'');_0x2df4ad[_0x4a3ce9(0xb5)]=_0x19e780[_0x4a3ce9(0xd4)](-0x4),_0x2df4ad[_0x4a3ce9(0x9a)]=_0x4a3ce9(0xdf),await database_1['default'][_0x4a3ce9(0xb7)][_0x4a3ce9(0xb0)]({'where':{'id':_0xe4d52b['id']},'data':_0x2df4ad});if(_0x5aa925[_0x4a3ce9(0x9e)]===_0x4a3ce9(0xa8)&&_0xe4d52b[_0x4a3ce9(0x8a)]){console[_0x4a3ce9(0xa9)](_0x4a3ce9(0xe6)+_0xe4d52b['id']+_0x4a3ce9(0xc1));try{await database_1[_0x4a3ce9(0xac)][_0x4a3ce9(0x9b)](async _0x40ec6f=>{const _0x212b5b=_0x4a3ce9,_0x4420a0=await _0x40ec6f[_0x212b5b(0xf0)][_0x212b5b(0xd9)]({'where':{'id':_0xe4d52b[_0x212b5b(0x8a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4420a0){console['log'](_0x212b5b(0xfc)+_0x4420a0['id']+_0x212b5b(0xc7)+_0x4420a0[_0x212b5b(0xe3)]+_0x212b5b(0xae)+_0x4420a0[_0x212b5b(0xc0)]+_0x212b5b(0xf4)+_0x4420a0[_0x212b5b(0x9e)]);const _0x1a7d05=_0x4420a0[_0x212b5b(0xc0)]+0x1,_0x5c2c4a=_0x4420a0[_0x212b5b(0xe3)]==='SINGLE'?_0x212b5b(0xf1):_0x4420a0[_0x212b5b(0x9e)];await _0x40ec6f['paymentLink'][_0x212b5b(0xb0)]({'where':{'id':_0xe4d52b[_0x212b5b(0x8a)]},'data':{'currentPayments':_0x1a7d05,'status':_0x5c2c4a,'updatedAt':new Date()}}),console[_0x212b5b(0xa9)](_0x212b5b(0x96)+_0x4420a0['id']+_0x212b5b(0xff)+_0x4420a0['currentPayments']+'\x20->\x20'+_0x1a7d05+',\x20status='+_0x4420a0[_0x212b5b(0x9e)]+'\x20->\x20'+_0x5c2c4a);}else console[_0x212b5b(0xa9)](_0x212b5b(0xdc)+_0xe4d52b[_0x212b5b(0x8a)]+'\x20not\x20found');});}catch(_0x231670){console[_0x4a3ce9(0xbd)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x231670);}}await database_1['default'][_0x4a3ce9(0x97)][_0x4a3ce9(0xcd)]({'data':{'paymentId':_0xe4d52b['id'],'shopId':_0xe4d52b['shopId'],'event':_0x4a3ce9(0xef)+_0x5aa925['status'][_0x4a3ce9(0xb9)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x5aa925[_0x4a3ce9(0x9e)],'transactionId':_0x5aa925[_0x4a3ce9(0xe2)],'failureReason':_0x5aa925['failureReason'],'processedAt':new Date()[_0x4a3ce9(0xc5)]()})}}),await this[_0x4a3ce9(0xd3)](_0xe4d52b,_0x5aa925['status'],_0x5aa925[_0x4a3ce9(0xe2)],_0x5aa925['failureReason']),await this[_0x4a3ce9(0xf6)](_0xe4d52b,_0x5aa925[_0x4a3ce9(0x9e)]),console['log'](_0x4a3ce9(0xd1)+_0x1d28a7+_0x4a3ce9(0x94)+_0x5aa925[_0x4a3ce9(0x9e)]),_0x5aa925[_0x4a3ce9(0x9e)]==='PAID'?_0x201672['json']({'success':!![],'message':_0x4a3ce9(0xa3),'result':{'status':_0x4a3ce9(0xa8),'transactionId':_0x5aa925[_0x4a3ce9(0xe2)],'redirectUrl':_0xe4d52b[_0x4a3ce9(0xf3)]}}):_0x201672[_0x4a3ce9(0x9e)](0x190)[_0x4a3ce9(0xaa)]({'success':![],'message':_0x4a3ce9(0x99),'result':{'status':'FAILED','failureReason':_0x5aa925[_0x4a3ce9(0xf2)],'redirectUrl':_0xe4d52b[_0x4a3ce9(0xf5)]}});}catch(_0x3087f2){_0x14bf74(_0x3087f2);}},this[_0x317817(0xab)]=new testGatewayService_1[(_0x317817(0x88))](),this[_0x317817(0xa6)]=new webhookService_1['WebhookService']();}async[a19_0x4db21d(0xd3)](_0x4a6f77,_0x295a01,_0xcaeb22,_0x3fcd76){const _0x469448=a19_0x4db21d,_0x3615c9=Date['now']();try{const _0x505b20=_0x4a6f77[_0x469448(0x8f)],_0x57f7ec=_0x505b20[_0x469448(0xb8)];if(!_0x57f7ec?.[_0x469448(0xa4)]){console[_0x469448(0xa9)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x505b20['id']);return;}const _0x5642a0=_0x295a01==='PAID'?_0x469448(0xc3):_0x469448(0xba);let _0x61b312=[];if(_0x57f7ec['webhookEvents'])try{_0x61b312=Array[_0x469448(0xeb)](_0x57f7ec[_0x469448(0xe7)])?_0x57f7ec[_0x469448(0xe7)]:JSON[_0x469448(0xfb)](_0x57f7ec[_0x469448(0xe7)]);}catch(_0x15e869){console[_0x469448(0xbd)](_0x469448(0xca),_0x15e869),_0x61b312=[];}if(!_0x61b312['includes'](_0x5642a0)){console[_0x469448(0xa9)](_0x469448(0xb4)+_0x5642a0+_0x469448(0xc6)+_0x505b20['id']);return;}const _0x725f21={'event':_0x5642a0,'payment':{'id':_0x4a6f77['id'],'order_id':_0x4a6f77['orderId'],'gateway_order_id':_0x4a6f77['gatewayOrderId'],'gateway':_0x469448(0x8d),'amount':_0x4a6f77[_0x469448(0xb2)],'currency':_0x4a6f77['currency'],'status':_0x295a01['toLowerCase'](),'customer_email':_0x4a6f77[_0x469448(0xc8)],'customer_name':_0x4a6f77['customerName'],'transaction_id':_0xcaeb22,'failure_message':_0x3fcd76,'created_at':_0x4a6f77[_0x469448(0x8c)],'updated_at':new Date()}},_0x42e313=await fetch(_0x57f7ec[_0x469448(0xa4)],{'method':'POST','headers':{'Content-Type':_0x469448(0xb1),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x469448(0x95)](_0x725f21)}),_0x18eeb7=Date['now']()-_0x3615c9;console[_0x469448(0xa9)](_0x469448(0xd0)+_0x57f7ec[_0x469448(0xa4)]+_0x469448(0xc9)+_0x42e313[_0x469448(0x9e)]+'\x20('+_0x18eeb7+_0x469448(0x85));}catch(_0x2311e9){console[_0x469448(0xbd)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x2311e9);}}async['sendPaymentStatusNotification'](_0x439854,_0xbf1606){const _0x418e21=a19_0x4db21d;try{const {telegramBotService:_0x19d489}=await Promise[_0x418e21(0xf9)]()[_0x418e21(0xbb)](()=>__importStar(require(_0x418e21(0xa5)))),_0x2ec6e5={'PAID':'paid','FAILED':_0x418e21(0xb3)},_0xab5e69=_0x2ec6e5[_0xbf1606];if(!_0xab5e69)return;await _0x19d489[_0x418e21(0x92)](_0x439854[_0x418e21(0xbc)],_0x439854,_0xab5e69);}catch(_0x33d8d8){console[_0x418e21(0xbd)](_0x418e21(0xbf),_0x33d8d8);}}}exports[a19_0x4db21d(0xe9)]=TestGatewayController;