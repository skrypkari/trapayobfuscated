'use strict';const a13_0x6ba82b=a13_0x29cf;(function(_0x5d9aae,_0x283f4d){const _0xe69e86=a13_0x29cf,_0x2c59df=_0x5d9aae();while(!![]){try{const _0x329e23=parseInt(_0xe69e86(0x161))/0x1*(parseInt(_0xe69e86(0x16e))/0x2)+-parseInt(_0xe69e86(0x174))/0x3+-parseInt(_0xe69e86(0x13c))/0x4+parseInt(_0xe69e86(0x171))/0x5+parseInt(_0xe69e86(0x16d))/0x6+parseInt(_0xe69e86(0x132))/0x7+-parseInt(_0xe69e86(0x146))/0x8;if(_0x329e23===_0x283f4d)break;else _0x2c59df['push'](_0x2c59df['shift']());}catch(_0x204263){_0x2c59df['push'](_0x2c59df['shift']());}}}(a13_0x4bd7,0x7bc31));function a13_0x4bd7(){const _0x2c4533=['../services/telegramBotService','getOwnPropertyNames','parse','Any\x20future\x20date\x20(MM/YY)','get','body','TestGatewayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','failureMessage','transactionId','Payment\x20status\x20is\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','967063VJCVAB','Payment\x20to\x20','processCardPayment','Webhook\x20event\x20','cardLast4','test_gateway','customerName','âœ…\x20Test\x20Gateway\x20payment\x20','PAID','amount','Any\x203-4\x20digits','0000','1728138cycfKG','2NkdIWo','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','payment','2929545mBWXho','slice','__importDefault','2533494NNVBxO','log','status','createdAt','length','default','payment.success','webhookLog','toLowerCase','sendPaymentStatusNotification','defineProperty','cardNumber','TestGatewayController','gateway','name','Payment\x20failed','now','Payment\x20is\x20not\x20for\x20test\x20gateway','resolve','getOwnPropertyDescriptor','Payment\x20processed\x20successfully','prototype','paidAt','params','paymentMethod','successUrl','__esModule','__importStar','currency','stringify','paid','__setModuleDefault','WebhookService','shop','json','customerEmail','error','hasOwnProperty','1313270tKdKQB','shopId','__createBinding','testGatewayService','Any\x20other\x20card\x20number','sendPaymentNotification','settings','webhookUrl','\x20processed:\x20','webhookService','355092JPjqhE',',\x20cannot\x20process','Payment\x20not\x20found','failureReason','sendShopWebhook','Error\x20parsing\x20webhook\x20events:','ms)','getPaymentForm','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','PENDING','4707240nHWTOs','FAILED','gatewayOrderId','isArray','then','\x20with\x20status\x20','failUrl','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failed','toISOString','../config/database','\x20not\x20enabled\x20for\x20shop\x20','create','webhookEvents','orderId'];a13_0x4bd7=function(){return _0x2c4533;};return a13_0x4bd7();}var __createBinding=this&&this[a13_0x6ba82b(0x134)]||(Object['create']?function(_0x4fd03e,_0x5199ac,_0x7b62ad,_0x3ef478){const _0x1248aa=a13_0x6ba82b;if(_0x3ef478===undefined)_0x3ef478=_0x7b62ad;var _0x578136=Object[_0x1248aa(0x187)](_0x5199ac,_0x7b62ad);(!_0x578136||(_0x1248aa(0x159)in _0x578136?!_0x5199ac['__esModule']:_0x578136['writable']||_0x578136['configurable']))&&(_0x578136={'enumerable':!![],'get':function(){return _0x5199ac[_0x7b62ad];}}),Object['defineProperty'](_0x4fd03e,_0x3ef478,_0x578136);}:function(_0x280e5f,_0x1ae264,_0x4c5311,_0x191805){if(_0x191805===undefined)_0x191805=_0x4c5311;_0x280e5f[_0x191805]=_0x1ae264[_0x4c5311];}),__setModuleDefault=this&&this[a13_0x6ba82b(0x193)]||(Object[a13_0x6ba82b(0x152)]?function(_0x2a1d5a,_0x3e5731){const _0x3a17ed=a13_0x6ba82b;Object[_0x3a17ed(0x17e)](_0x2a1d5a,'default',{'enumerable':!![],'value':_0x3e5731});}:function(_0x5277eb,_0x5f02af){const _0xe03226=a13_0x6ba82b;_0x5277eb[_0xe03226(0x179)]=_0x5f02af;}),__importStar=this&&this[a13_0x6ba82b(0x18f)]||(function(){var _0x558d1=function(_0xd24e2d){const _0x4a44b7=a13_0x29cf;return _0x558d1=Object[_0x4a44b7(0x156)]||function(_0x2cdafd){const _0x50d493=_0x4a44b7;var _0x432e03=[];for(var _0x1d306f in _0x2cdafd)if(Object[_0x50d493(0x189)][_0x50d493(0x131)]['call'](_0x2cdafd,_0x1d306f))_0x432e03[_0x432e03[_0x50d493(0x178)]]=_0x1d306f;return _0x432e03;},_0x558d1(_0xd24e2d);};return function(_0x2c3b3a){const _0x1f71e6=a13_0x29cf;if(_0x2c3b3a&&_0x2c3b3a[_0x1f71e6(0x18e)])return _0x2c3b3a;var _0x355a72={};if(_0x2c3b3a!=null){for(var _0x4c36aa=_0x558d1(_0x2c3b3a),_0xd1219c=0x0;_0xd1219c<_0x4c36aa[_0x1f71e6(0x178)];_0xd1219c++)if(_0x4c36aa[_0xd1219c]!=='default')__createBinding(_0x355a72,_0x2c3b3a,_0x4c36aa[_0xd1219c]);}return __setModuleDefault(_0x355a72,_0x2c3b3a),_0x355a72;};}()),__importDefault=this&&this[a13_0x6ba82b(0x173)]||function(_0x3f19a2){return _0x3f19a2&&_0x3f19a2['__esModule']?_0x3f19a2:{'default':_0x3f19a2};};function a13_0x29cf(_0x1b2194,_0x24b2d1){const _0x4bd7cd=a13_0x4bd7();return a13_0x29cf=function(_0x29cf95,_0x3ca2ab){_0x29cf95=_0x29cf95-0x131;let _0x2970e2=_0x4bd7cd[_0x29cf95];return _0x2970e2;},a13_0x29cf(_0x1b2194,_0x24b2d1);}Object['defineProperty'](exports,a13_0x6ba82b(0x18e),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x6ba82b(0x150)));class TestGatewayController{constructor(){const _0x2fea2d=a13_0x6ba82b;this[_0x2fea2d(0x143)]=async(_0xac96b1,_0x5aad00,_0x11b3e8)=>{const _0x5ecae4=_0x2fea2d;try{const {paymentId:_0x44b506}=_0xac96b1['params'];console['log'](_0x5ecae4(0x144)+_0x44b506);const _0x143def=await database_1[_0x5ecae4(0x179)][_0x5ecae4(0x170)]['findUnique']({'where':{'id':_0x44b506},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x143def)return _0x5aad00['status'](0x194)[_0x5ecae4(0x196)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x143def[_0x5ecae4(0x181)]!==_0x5ecae4(0x166))return _0x5aad00[_0x5ecae4(0x176)](0x190)['json']({'success':![],'message':_0x5ecae4(0x185)});if(_0x143def[_0x5ecae4(0x176)]!==_0x5ecae4(0x145))return _0x5aad00[_0x5ecae4(0x176)](0x190)[_0x5ecae4(0x196)]({'success':![],'message':_0x5ecae4(0x15f)+_0x143def[_0x5ecae4(0x176)]+_0x5ecae4(0x13d)});_0x5aad00[_0x5ecae4(0x196)]({'success':!![],'result':{'paymentId':_0x143def['id'],'orderId':_0x143def[_0x5ecae4(0x148)],'amount':_0x143def[_0x5ecae4(0x16a)],'currency':_0x143def[_0x5ecae4(0x190)],'merchantName':_0x143def['shop'][_0x5ecae4(0x182)],'description':_0x5ecae4(0x162)+_0x143def[_0x5ecae4(0x195)][_0x5ecae4(0x182)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5ecae4(0x136),'expiryDate':_0x5ecae4(0x158),'cvc':_0x5ecae4(0x16b),'holderName':'Any\x20name'}}});}catch(_0x490b25){_0x11b3e8(_0x490b25);}},this['processCard']=async(_0x49b836,_0x2b3b52,_0x52cc31)=>{const _0x164c19=_0x2fea2d;try{const {paymentId:_0x525b5f}=_0x49b836[_0x164c19(0x18b)],_0x17616c=_0x49b836[_0x164c19(0x15a)];console[_0x164c19(0x175)](_0x164c19(0x16f)+_0x525b5f);const _0x48591e=await database_1[_0x164c19(0x179)][_0x164c19(0x170)]['findUnique']({'where':{'id':_0x525b5f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x48591e)return _0x2b3b52[_0x164c19(0x176)](0x194)[_0x164c19(0x196)]({'success':![],'message':_0x164c19(0x13e)});if(_0x48591e[_0x164c19(0x181)]!=='test_gateway')return _0x2b3b52[_0x164c19(0x176)](0x190)[_0x164c19(0x196)]({'success':![],'message':_0x164c19(0x185)});if(_0x48591e[_0x164c19(0x176)]!==_0x164c19(0x145))return _0x2b3b52['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x48591e[_0x164c19(0x176)]+_0x164c19(0x13d)});const _0x3c57c6=await this[_0x164c19(0x135)][_0x164c19(0x163)]({'paymentId':_0x48591e['id'],'orderId':_0x48591e[_0x164c19(0x148)]||_0x48591e['id'],'amount':_0x48591e[_0x164c19(0x16a)],'currency':_0x48591e[_0x164c19(0x190)],'cardData':_0x17616c});console[_0x164c19(0x175)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x3c57c6);const _0x4d087e={'status':_0x3c57c6['status'],'updatedAt':new Date()};if(_0x3c57c6[_0x164c19(0x176)]==='PAID')_0x4d087e[_0x164c19(0x18a)]=new Date(),_0x4d087e['gatewayPaymentId']=_0x3c57c6['transactionId'];else _0x3c57c6[_0x164c19(0x176)]===_0x164c19(0x147)&&(_0x4d087e[_0x164c19(0x15d)]=_0x3c57c6[_0x164c19(0x13f)]);const _0x526354=_0x17616c[_0x164c19(0x17f)]['replace'](/[\s-]/g,'');_0x4d087e[_0x164c19(0x165)]=_0x526354[_0x164c19(0x172)](-0x4),_0x4d087e[_0x164c19(0x18c)]='test_card',await database_1[_0x164c19(0x179)][_0x164c19(0x170)]['update']({'where':{'id':_0x48591e['id']},'data':_0x4d087e}),await database_1[_0x164c19(0x179)][_0x164c19(0x17b)][_0x164c19(0x152)]({'data':{'paymentId':_0x48591e['id'],'shopId':_0x48591e[_0x164c19(0x133)],'event':'test_gateway_'+_0x3c57c6[_0x164c19(0x176)][_0x164c19(0x17c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x164c19(0x145),'newStatus':_0x3c57c6[_0x164c19(0x176)],'transactionId':_0x3c57c6[_0x164c19(0x15e)],'failureReason':_0x3c57c6[_0x164c19(0x13f)],'processedAt':new Date()[_0x164c19(0x14f)]()})}}),await this['sendShopWebhook'](_0x48591e,_0x3c57c6[_0x164c19(0x176)],_0x3c57c6[_0x164c19(0x15e)],_0x3c57c6[_0x164c19(0x13f)]),await this[_0x164c19(0x17d)](_0x48591e,_0x3c57c6[_0x164c19(0x176)]),console[_0x164c19(0x175)](_0x164c19(0x168)+_0x525b5f+_0x164c19(0x13a)+_0x3c57c6[_0x164c19(0x176)]),_0x3c57c6['status']==='PAID'?_0x2b3b52['json']({'success':!![],'message':_0x164c19(0x188),'result':{'status':_0x164c19(0x169),'transactionId':_0x3c57c6['transactionId'],'redirectUrl':_0x48591e[_0x164c19(0x18d)]}}):_0x2b3b52['status'](0x190)[_0x164c19(0x196)]({'success':![],'message':_0x164c19(0x183),'result':{'status':_0x164c19(0x147),'failureReason':_0x3c57c6['failureReason'],'redirectUrl':_0x48591e[_0x164c19(0x14c)]}});}catch(_0x3ea6cc){_0x52cc31(_0x3ea6cc);}},this[_0x2fea2d(0x135)]=new testGatewayService_1[(_0x2fea2d(0x15b))](),this[_0x2fea2d(0x13b)]=new webhookService_1[(_0x2fea2d(0x194))]();}async[a13_0x6ba82b(0x140)](_0x5bcb01,_0x200d00,_0x5c7c44,_0x3c75d0){const _0x41beb1=a13_0x6ba82b,_0x2cd9cd=Date[_0x41beb1(0x184)]();try{const _0x258118=_0x5bcb01[_0x41beb1(0x195)],_0x38d0c1=_0x258118[_0x41beb1(0x138)];if(!_0x38d0c1?.[_0x41beb1(0x139)]){console[_0x41beb1(0x175)](_0x41beb1(0x160)+_0x258118['id']);return;}const _0x446574=_0x200d00===_0x41beb1(0x169)?_0x41beb1(0x17a):'payment.failed';let _0x43bcdc=[];if(_0x38d0c1['webhookEvents'])try{_0x43bcdc=Array[_0x41beb1(0x149)](_0x38d0c1[_0x41beb1(0x153)])?_0x38d0c1['webhookEvents']:JSON[_0x41beb1(0x157)](_0x38d0c1[_0x41beb1(0x153)]);}catch(_0x77e2c){console[_0x41beb1(0x198)](_0x41beb1(0x141),_0x77e2c),_0x43bcdc=[];}if(!_0x43bcdc['includes'](_0x446574)){console[_0x41beb1(0x175)](_0x41beb1(0x164)+_0x446574+_0x41beb1(0x151)+_0x258118['id']);return;}const _0x54ad3a={'event':_0x446574,'payment':{'id':_0x5bcb01['id'],'order_id':_0x5bcb01[_0x41beb1(0x154)],'gateway_order_id':_0x5bcb01[_0x41beb1(0x148)],'gateway':_0x41beb1(0x16c),'amount':_0x5bcb01['amount'],'currency':_0x5bcb01[_0x41beb1(0x190)],'status':_0x200d00[_0x41beb1(0x17c)](),'customer_email':_0x5bcb01[_0x41beb1(0x197)],'customer_name':_0x5bcb01[_0x41beb1(0x167)],'transaction_id':_0x5c7c44,'failure_message':_0x3c75d0,'created_at':_0x5bcb01[_0x41beb1(0x177)],'updated_at':new Date()}},_0x16f6da=await fetch(_0x38d0c1[_0x41beb1(0x139)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x41beb1(0x191)](_0x54ad3a)}),_0x285321=Date[_0x41beb1(0x184)]()-_0x2cd9cd;console[_0x41beb1(0x175)](_0x41beb1(0x14d)+_0x38d0c1['webhookUrl']+_0x41beb1(0x14b)+_0x16f6da[_0x41beb1(0x176)]+'\x20('+_0x285321+_0x41beb1(0x142));}catch(_0x1cf703){console[_0x41beb1(0x198)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x1cf703);}}async['sendPaymentStatusNotification'](_0xc67fcc,_0x404eb9){const _0x35a823=a13_0x6ba82b;try{const {telegramBotService:_0x400f78}=await Promise[_0x35a823(0x186)]()[_0x35a823(0x14a)](()=>__importStar(require(_0x35a823(0x155)))),_0x40413b={'PAID':_0x35a823(0x192),'FAILED':_0x35a823(0x14e)},_0x27f8c6=_0x40413b[_0x404eb9];if(!_0x27f8c6)return;await _0x400f78[_0x35a823(0x137)](_0xc67fcc[_0x35a823(0x133)],_0xc67fcc,_0x27f8c6);}catch(_0x2f99e1){console[_0x35a823(0x198)](_0x35a823(0x15c),_0x2f99e1);}}}exports[a13_0x6ba82b(0x180)]=TestGatewayController;