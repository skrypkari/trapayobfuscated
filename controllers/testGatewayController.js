'use strict';const a13_0x4cdf1d=a13_0x6cd3;(function(_0x1f8fab,_0x49beb9){const _0x3fe332=a13_0x6cd3,_0x34ac96=_0x1f8fab();while(!![]){try{const _0x52bc10=-parseInt(_0x3fe332(0x189))/0x1*(parseInt(_0x3fe332(0x18e))/0x2)+-parseInt(_0x3fe332(0x17b))/0x3*(-parseInt(_0x3fe332(0x186))/0x4)+-parseInt(_0x3fe332(0x177))/0x5*(parseInt(_0x3fe332(0x17d))/0x6)+parseInt(_0x3fe332(0x18d))/0x7*(-parseInt(_0x3fe332(0x1a4))/0x8)+-parseInt(_0x3fe332(0x18f))/0x9+parseInt(_0x3fe332(0x132))/0xa+parseInt(_0x3fe332(0x153))/0xb;if(_0x52bc10===_0x49beb9)break;else _0x34ac96['push'](_0x34ac96['shift']());}catch(_0x1c37f3){_0x34ac96['push'](_0x34ac96['shift']());}}}(a13_0x29ad,0x754f1));var __createBinding=this&&this[a13_0x4cdf1d(0x159)]||(Object[a13_0x4cdf1d(0x155)]?function(_0x291f92,_0x20f74a,_0x15f4a8,_0x2386b4){const _0x1470de=a13_0x4cdf1d;if(_0x2386b4===undefined)_0x2386b4=_0x15f4a8;var _0xa80cc6=Object[_0x1470de(0x185)](_0x20f74a,_0x15f4a8);(!_0xa80cc6||(_0x1470de(0x19c)in _0xa80cc6?!_0x20f74a[_0x1470de(0x16e)]:_0xa80cc6[_0x1470de(0x162)]||_0xa80cc6['configurable']))&&(_0xa80cc6={'enumerable':!![],'get':function(){return _0x20f74a[_0x15f4a8];}}),Object['defineProperty'](_0x291f92,_0x2386b4,_0xa80cc6);}:function(_0x482f15,_0x1dd4ce,_0x21fdf0,_0x2f9213){if(_0x2f9213===undefined)_0x2f9213=_0x21fdf0;_0x482f15[_0x2f9213]=_0x1dd4ce[_0x21fdf0];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x4cdf1d(0x155)]?function(_0x50e9f3,_0x2bf7be){const _0x3d2cf3=a13_0x4cdf1d;Object[_0x3d2cf3(0x18c)](_0x50e9f3,_0x3d2cf3(0x157),{'enumerable':!![],'value':_0x2bf7be});}:function(_0x353446,_0x41785b){const _0x431f60=a13_0x4cdf1d;_0x353446[_0x431f60(0x157)]=_0x41785b;}),__importStar=this&&this[a13_0x4cdf1d(0x144)]||(function(){var _0x18072e=function(_0x7a1c3e){const _0x2b1448=a13_0x6cd3;return _0x18072e=Object[_0x2b1448(0x19f)]||function(_0x2d81f4){const _0x340893=_0x2b1448;var _0xe64185=[];for(var _0x32a079 in _0x2d81f4)if(Object[_0x340893(0x182)][_0x340893(0x17e)]['call'](_0x2d81f4,_0x32a079))_0xe64185[_0xe64185[_0x340893(0x141)]]=_0x32a079;return _0xe64185;},_0x18072e(_0x7a1c3e);};return function(_0x23e7ac){const _0x2f549c=a13_0x6cd3;if(_0x23e7ac&&_0x23e7ac[_0x2f549c(0x16e)])return _0x23e7ac;var _0x25053a={};if(_0x23e7ac!=null){for(var _0x383dc8=_0x18072e(_0x23e7ac),_0x41f5b3=0x0;_0x41f5b3<_0x383dc8[_0x2f549c(0x141)];_0x41f5b3++)if(_0x383dc8[_0x41f5b3]!==_0x2f549c(0x157))__createBinding(_0x25053a,_0x23e7ac,_0x383dc8[_0x41f5b3]);}return __setModuleDefault(_0x25053a,_0x23e7ac),_0x25053a;};}()),__importDefault=this&&this[a13_0x4cdf1d(0x137)]||function(_0x48f283){const _0x19a552=a13_0x4cdf1d;return _0x48f283&&_0x48f283[_0x19a552(0x16e)]?_0x48f283:{'default':_0x48f283};};function a13_0x6cd3(_0x78cb72,_0x263372){const _0x29ad99=a13_0x29ad();return a13_0x6cd3=function(_0x6cd3d0,_0x3db45b){_0x6cd3d0=_0x6cd3d0-0x131;let _0xad8247=_0x29ad99[_0x6cd3d0];return _0xad8247;},a13_0x6cd3(_0x78cb72,_0x263372);}Object[a13_0x4cdf1d(0x18c)](exports,a13_0x4cdf1d(0x16e),{'value':!![]}),exports[a13_0x4cdf1d(0x17f)]=void 0x0;function a13_0x29ad(){const _0x1632a6=['Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','transactionId','testGatewayService','writable','amount','failureReason','type','Payment\x20status\x20is\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',',\x20cannot\x20process','test_card','cardNumber','customerName','cardLast4','PENDING','__esModule','payment',',\x20status=','paymentMethod','\x20with\x20status\x20','\x20updated:\x20currentPayments=','toISOString','gateway','now','1515YKJAbx','Payment\x20not\x20found','includes','Any\x203-4\x20digits','1866759HwABfT','log','9384rrEpKM','hasOwnProperty','TestGatewayController','sendShopWebhook','shopId','prototype','webhookService','body','getOwnPropertyDescriptor','4ZiLkFw','paymentLinkId','processCardPayment','3DJXnMc','params','TestGatewayService','defineProperty','7oqhhtj','220554IznEpe','6592671nRziSb','payment.success','‚úÖ\x20Payment\x20link\x20','shop','gatewayOrderId','PAID','failureMessage','Payment\x20is\x20not\x20for\x20test\x20gateway','\x20not\x20enabled\x20for\x20shop\x20','then','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paid','getPaymentForm','get','Any\x20future\x20date\x20(MM/YY)','update','getOwnPropertyNames','FAILED','findUnique','stringify','SINGLE','5997496zcUMYj','0000','3111320PWnFHP','currentPayments','status','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLink','__importDefault','test_gateway','settings','COMPLETED','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','resolve','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20processed:\x20','\x20->\x20','Any\x20other\x20card\x20number','length','test_gateway_','../services/webhookService','__importStar','../config/database','currency','payment.failed','ms)',':\x20type=','Payment\x20processed\x20successfully','sendPaymentStatusNotification','üß™\x20Test\x20Gateway\x20result:','webhookEvents','name','json','webhookUrl','webhookLog','processCard','20174451cMTMwE','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','create','üìà\x20Found\x20payment\x20link\x20','default','Webhook\x20event\x20','__createBinding','gatewayPaymentId','error','Payment\x20to\x20','4242\x204242\x204242\x204242','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter'];a13_0x29ad=function(){return _0x1632a6;};return a13_0x29ad();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x4cdf1d(0x143)),database_1=__importDefault(require(a13_0x4cdf1d(0x145)));class TestGatewayController{constructor(){const _0x5da302=a13_0x4cdf1d;this[_0x5da302(0x19b)]=async(_0xb50692,_0x59236e,_0x3b9e41)=>{const _0x5c0d4a=_0x5da302;try{const {paymentId:_0x533ba6}=_0xb50692['params'];console[_0x5c0d4a(0x17c)](_0x5c0d4a(0x154)+_0x533ba6);const _0x2a6f89=await database_1['default']['payment']['findUnique']({'where':{'id':_0x533ba6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2a6f89)return _0x59236e[_0x5c0d4a(0x134)](0x194)[_0x5c0d4a(0x14f)]({'success':![],'message':_0x5c0d4a(0x178)});if(_0x2a6f89[_0x5c0d4a(0x175)]!==_0x5c0d4a(0x138))return _0x59236e[_0x5c0d4a(0x134)](0x190)[_0x5c0d4a(0x14f)]({'success':![],'message':_0x5c0d4a(0x196)});if(_0x2a6f89['status']!==_0x5c0d4a(0x16d))return _0x59236e[_0x5c0d4a(0x134)](0x190)['json']({'success':![],'message':_0x5c0d4a(0x166)+_0x2a6f89[_0x5c0d4a(0x134)]+_0x5c0d4a(0x168)});_0x59236e[_0x5c0d4a(0x14f)]({'success':!![],'result':{'paymentId':_0x2a6f89['id'],'orderId':_0x2a6f89[_0x5c0d4a(0x193)],'amount':_0x2a6f89['amount'],'currency':_0x2a6f89[_0x5c0d4a(0x146)],'merchantName':_0x2a6f89[_0x5c0d4a(0x192)][_0x5c0d4a(0x14e)],'description':_0x5c0d4a(0x15c)+_0x2a6f89[_0x5c0d4a(0x192)][_0x5c0d4a(0x14e)],'testInstructions':{'successCard':_0x5c0d4a(0x15d),'failureCard':_0x5c0d4a(0x140),'expiryDate':_0x5c0d4a(0x19d),'cvc':_0x5c0d4a(0x17a),'holderName':'Any\x20name'}}});}catch(_0x3889c2){_0x3b9e41(_0x3889c2);}},this[_0x5da302(0x152)]=async(_0x563eba,_0x55281f,_0x3bb2da)=>{const _0x325320=_0x5da302;try{const {paymentId:_0x1a0695}=_0x563eba[_0x325320(0x18a)],_0xa5a9f7=_0x563eba[_0x325320(0x184)];console[_0x325320(0x17c)](_0x325320(0x199)+_0x1a0695);const _0x2c648e=await database_1[_0x325320(0x157)][_0x325320(0x16f)][_0x325320(0x1a1)]({'where':{'id':_0x1a0695},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2c648e)return _0x55281f[_0x325320(0x134)](0x194)[_0x325320(0x14f)]({'success':![],'message':_0x325320(0x178)});if(_0x2c648e[_0x325320(0x175)]!==_0x325320(0x138))return _0x55281f[_0x325320(0x134)](0x190)[_0x325320(0x14f)]({'success':![],'message':_0x325320(0x196)});if(_0x2c648e[_0x325320(0x134)]!==_0x325320(0x16d))return _0x55281f[_0x325320(0x134)](0x190)[_0x325320(0x14f)]({'success':![],'message':_0x325320(0x166)+_0x2c648e['status']+',\x20cannot\x20process'});const _0x421b44=await this[_0x325320(0x161)][_0x325320(0x188)]({'paymentId':_0x2c648e['id'],'orderId':_0x2c648e[_0x325320(0x193)]||_0x2c648e['id'],'amount':_0x2c648e[_0x325320(0x163)],'currency':_0x2c648e[_0x325320(0x146)],'cardData':_0xa5a9f7});console['log'](_0x325320(0x14c),_0x421b44);const _0x1c3f31={'status':_0x421b44[_0x325320(0x134)],'updatedAt':new Date()};if(_0x421b44['status']==='PAID')_0x1c3f31['paidAt']=new Date(),_0x1c3f31[_0x325320(0x15a)]=_0x421b44[_0x325320(0x160)];else _0x421b44[_0x325320(0x134)]===_0x325320(0x1a0)&&(_0x1c3f31[_0x325320(0x195)]=_0x421b44[_0x325320(0x164)]);const _0x4695c3=_0xa5a9f7[_0x325320(0x16a)]['replace'](/[\s-]/g,'');_0x1c3f31[_0x325320(0x16c)]=_0x4695c3['slice'](-0x4),_0x1c3f31[_0x325320(0x171)]=_0x325320(0x169),await database_1[_0x325320(0x157)]['payment'][_0x325320(0x19e)]({'where':{'id':_0x2c648e['id']},'data':_0x1c3f31});if(_0x421b44[_0x325320(0x134)]===_0x325320(0x194)&&_0x2c648e[_0x325320(0x187)]){console[_0x325320(0x17c)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x2c648e['id']+_0x325320(0x15e));try{await database_1[_0x325320(0x157)]['$transaction'](async _0x197ad4=>{const _0x19bf38=_0x325320,_0x1751ea=await _0x197ad4[_0x19bf38(0x136)][_0x19bf38(0x1a1)]({'where':{'id':_0x2c648e[_0x19bf38(0x187)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1751ea){console['log'](_0x19bf38(0x156)+_0x1751ea['id']+_0x19bf38(0x149)+_0x1751ea['type']+',\x20currentPayments='+_0x1751ea[_0x19bf38(0x133)]+_0x19bf38(0x170)+_0x1751ea[_0x19bf38(0x134)]);const _0x480edb=_0x1751ea[_0x19bf38(0x133)]+0x1,_0xb191c0=_0x1751ea[_0x19bf38(0x165)]===_0x19bf38(0x1a3)?_0x19bf38(0x13a):_0x1751ea['status'];await _0x197ad4[_0x19bf38(0x136)]['update']({'where':{'id':_0x2c648e[_0x19bf38(0x187)]},'data':{'currentPayments':_0x480edb,'status':_0xb191c0,'updatedAt':new Date()}}),console['log'](_0x19bf38(0x191)+_0x1751ea['id']+_0x19bf38(0x173)+_0x1751ea['currentPayments']+'\x20->\x20'+_0x480edb+_0x19bf38(0x170)+_0x1751ea[_0x19bf38(0x134)]+_0x19bf38(0x13f)+_0xb191c0);}else console[_0x19bf38(0x17c)]('‚ùå\x20Payment\x20link\x20'+_0x2c648e[_0x19bf38(0x187)]+'\x20not\x20found');});}catch(_0x24c3ce){console[_0x325320(0x15b)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x24c3ce);}}await database_1['default'][_0x325320(0x151)][_0x325320(0x155)]({'data':{'paymentId':_0x2c648e['id'],'shopId':_0x2c648e[_0x325320(0x181)],'event':_0x325320(0x142)+_0x421b44[_0x325320(0x134)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x325320(0x16d),'newStatus':_0x421b44[_0x325320(0x134)],'transactionId':_0x421b44[_0x325320(0x160)],'failureReason':_0x421b44[_0x325320(0x164)],'processedAt':new Date()[_0x325320(0x174)]()})}}),await this[_0x325320(0x180)](_0x2c648e,_0x421b44[_0x325320(0x134)],_0x421b44[_0x325320(0x160)],_0x421b44[_0x325320(0x164)]),await this[_0x325320(0x14b)](_0x2c648e,_0x421b44[_0x325320(0x134)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x1a0695+_0x325320(0x13e)+_0x421b44[_0x325320(0x134)]),_0x421b44[_0x325320(0x134)]===_0x325320(0x194)?_0x55281f[_0x325320(0x14f)]({'success':!![],'message':_0x325320(0x14a),'result':{'status':_0x325320(0x194),'transactionId':_0x421b44['transactionId'],'redirectUrl':_0x2c648e['successUrl']}}):_0x55281f[_0x325320(0x134)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x325320(0x1a0),'failureReason':_0x421b44[_0x325320(0x164)],'redirectUrl':_0x2c648e['failUrl']}});}catch(_0x34153a){_0x3bb2da(_0x34153a);}},this[_0x5da302(0x161)]=new testGatewayService_1[(_0x5da302(0x18b))](),this[_0x5da302(0x183)]=new webhookService_1['WebhookService']();}async[a13_0x4cdf1d(0x180)](_0x5ba6bd,_0x8332d4,_0x12aa76,_0x1f9ced){const _0x3d971b=a13_0x4cdf1d,_0x4d96bb=Date[_0x3d971b(0x176)]();try{const _0xb98dbc=_0x5ba6bd[_0x3d971b(0x192)],_0x1cc6b3=_0xb98dbc[_0x3d971b(0x139)];if(!_0x1cc6b3?.['webhookUrl']){console[_0x3d971b(0x17c)](_0x3d971b(0x167)+_0xb98dbc['id']);return;}const _0x2ff534=_0x8332d4===_0x3d971b(0x194)?_0x3d971b(0x190):_0x3d971b(0x147);let _0x55bb19=[];if(_0x1cc6b3[_0x3d971b(0x14d)])try{_0x55bb19=Array['isArray'](_0x1cc6b3['webhookEvents'])?_0x1cc6b3[_0x3d971b(0x14d)]:JSON['parse'](_0x1cc6b3[_0x3d971b(0x14d)]);}catch(_0x36a19a){console[_0x3d971b(0x15b)]('Error\x20parsing\x20webhook\x20events:',_0x36a19a),_0x55bb19=[];}if(!_0x55bb19[_0x3d971b(0x179)](_0x2ff534)){console[_0x3d971b(0x17c)](_0x3d971b(0x158)+_0x2ff534+_0x3d971b(0x197)+_0xb98dbc['id']);return;}const _0x4c9949={'event':_0x2ff534,'payment':{'id':_0x5ba6bd['id'],'order_id':_0x5ba6bd['orderId'],'gateway_order_id':_0x5ba6bd[_0x3d971b(0x193)],'gateway':_0x3d971b(0x131),'amount':_0x5ba6bd[_0x3d971b(0x163)],'currency':_0x5ba6bd[_0x3d971b(0x146)],'status':_0x8332d4['toLowerCase'](),'customer_email':_0x5ba6bd['customerEmail'],'customer_name':_0x5ba6bd[_0x3d971b(0x16b)],'transaction_id':_0x12aa76,'failure_message':_0x1f9ced,'created_at':_0x5ba6bd['createdAt'],'updated_at':new Date()}},_0x408297=await fetch(_0x1cc6b3[_0x3d971b(0x150)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x3d971b(0x13b)},'body':JSON[_0x3d971b(0x1a2)](_0x4c9949)}),_0x2d39c9=Date['now']()-_0x4d96bb;console[_0x3d971b(0x17c)](_0x3d971b(0x135)+_0x1cc6b3['webhookUrl']+_0x3d971b(0x172)+_0x408297[_0x3d971b(0x134)]+'\x20('+_0x2d39c9+_0x3d971b(0x148));}catch(_0x17c9f0){console[_0x3d971b(0x15b)](_0x3d971b(0x15f),_0x17c9f0);}}async[a13_0x4cdf1d(0x14b)](_0x5f167d,_0x575cbb){const _0x48d59f=a13_0x4cdf1d;try{const {telegramBotService:_0x180190}=await Promise[_0x48d59f(0x13c)]()[_0x48d59f(0x198)](()=>__importStar(require('../services/telegramBotService'))),_0x57eed8={'PAID':_0x48d59f(0x19a),'FAILED':'failed'},_0x903fca=_0x57eed8[_0x575cbb];if(!_0x903fca)return;await _0x180190['sendPaymentNotification'](_0x5f167d[_0x48d59f(0x181)],_0x5f167d,_0x903fca);}catch(_0x3460cf){console['error'](_0x48d59f(0x13d),_0x3460cf);}}}exports[a13_0x4cdf1d(0x17f)]=TestGatewayController;