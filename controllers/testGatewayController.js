'use strict';const a13_0x2fdba9=a13_0x1364;function a13_0x1364(_0x3ae2d9,_0x4f45c2){const _0x4f2b2d=a13_0x4f2b();return a13_0x1364=function(_0x136498,_0x3f2ba6){_0x136498=_0x136498-0x12c;let _0x1c339f=_0x4f2b2d[_0x136498];return _0x1c339f;},a13_0x1364(_0x3ae2d9,_0x4f45c2);}(function(_0x1f503d,_0x5ba782){const _0x4cbee9=a13_0x1364,_0x5b44cf=_0x1f503d();while(!![]){try{const _0xa77d69=parseInt(_0x4cbee9(0x185))/0x1+-parseInt(_0x4cbee9(0x189))/0x2+parseInt(_0x4cbee9(0x130))/0x3*(parseInt(_0x4cbee9(0x132))/0x4)+parseInt(_0x4cbee9(0x168))/0x5*(parseInt(_0x4cbee9(0x184))/0x6)+-parseInt(_0x4cbee9(0x150))/0x7+parseInt(_0x4cbee9(0x178))/0x8+-parseInt(_0x4cbee9(0x138))/0x9*(-parseInt(_0x4cbee9(0x199))/0xa);if(_0xa77d69===_0x5ba782)break;else _0x5b44cf['push'](_0x5b44cf['shift']());}catch(_0x227969){_0x5b44cf['push'](_0x5b44cf['shift']());}}}(a13_0x4f2b,0x7e17a));function a13_0x4f2b(){const _0x5a3d24=['replace','webhookLog','customerName','1217574lectBp','Webhook\x20event\x20','4PfQMIW','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','processCard','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','0000','558IGurTv','Any\x20name','paid','stringify','paymentMethod','\x20not\x20enabled\x20for\x20shop\x20','âœ…\x20Test\x20Gateway\x20payment\x20','body','testGatewayService','ms)','findUnique','includes','PAID','parse','payment.success','settings','defineProperty','create','slice','json','default','cardLast4','__setModuleDefault','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','6826540tGugGh','failureReason','webhookService','toISOString','status','params','ðŸ§ª\x20Test\x20Gateway\x20result:',',\x20cannot\x20process','name','WebhookService','../config/database','toLowerCase','amount','currency','\x20processed:\x20','configurable','__createBinding','Payment\x20status\x20is\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Any\x203-4\x20digits','failed','gateway','gatewayOrderId','webhookEvents','2318130mWMUYB','customerEmail','Error\x20parsing\x20webhook\x20events:','resolve','shop','POST','application/json','test_card','gatewayPaymentId','failUrl','4242\x204242\x204242\x204242','failureMessage','TestGatewayController','PENDING','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','1136304IRCSRf','TestGatewayService','Payment\x20not\x20found','sendPaymentNotification','sendShopWebhook','Payment\x20to\x20','payment','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','error','prototype','Test\x20Gateway\x20webhook\x20sent\x20to\x20','now','6HKXxSh','42141BACewX','Payment\x20failed','\x20with\x20status\x20','writable','577962TChgWt','payment.failed','__importStar','Any\x20future\x20date\x20(MM/YY)','Any\x20other\x20card\x20number','log','isArray','length','getPaymentForm','processCardPayment','paidAt','shopId','__esModule','call','FAILED','Payment\x20processed\x20successfully','117260vURhRa','transactionId'];a13_0x4f2b=function(){return _0x5a3d24;};return a13_0x4f2b();}var __createBinding=this&&this[a13_0x2fdba9(0x160)]||(Object['create']?function(_0x10d428,_0x32c3de,_0x323156,_0x4114e1){const _0xb06176=a13_0x2fdba9;if(_0x4114e1===undefined)_0x4114e1=_0x323156;var _0x23092f=Object['getOwnPropertyDescriptor'](_0x32c3de,_0x323156);(!_0x23092f||('get'in _0x23092f?!_0x32c3de[_0xb06176(0x195)]:_0x23092f[_0xb06176(0x188)]||_0x23092f[_0xb06176(0x15f)]))&&(_0x23092f={'enumerable':!![],'get':function(){return _0x32c3de[_0x323156];}}),Object[_0xb06176(0x148)](_0x10d428,_0x4114e1,_0x23092f);}:function(_0x5799df,_0x20eb16,_0x28c20f,_0x509143){if(_0x509143===undefined)_0x509143=_0x28c20f;_0x5799df[_0x509143]=_0x20eb16[_0x28c20f];}),__setModuleDefault=this&&this[a13_0x2fdba9(0x14e)]||(Object[a13_0x2fdba9(0x149)]?function(_0xe5e2d8,_0x42f01f){const _0x360450=a13_0x2fdba9;Object[_0x360450(0x148)](_0xe5e2d8,_0x360450(0x14c),{'enumerable':!![],'value':_0x42f01f});}:function(_0x5d2bfc,_0x247d37){_0x5d2bfc['default']=_0x247d37;}),__importStar=this&&this[a13_0x2fdba9(0x18b)]||(function(){var _0x1ff75d=function(_0x23a806){return _0x1ff75d=Object['getOwnPropertyNames']||function(_0x2d4105){const _0x3fab79=a13_0x1364;var _0x8dfa3a=[];for(var _0x51e28d in _0x2d4105)if(Object[_0x3fab79(0x181)]['hasOwnProperty'][_0x3fab79(0x196)](_0x2d4105,_0x51e28d))_0x8dfa3a[_0x8dfa3a[_0x3fab79(0x190)]]=_0x51e28d;return _0x8dfa3a;},_0x1ff75d(_0x23a806);};return function(_0x27df71){const _0x85c706=a13_0x1364;if(_0x27df71&&_0x27df71[_0x85c706(0x195)])return _0x27df71;var _0x420339={};if(_0x27df71!=null){for(var _0x5e9a75=_0x1ff75d(_0x27df71),_0x430568=0x0;_0x430568<_0x5e9a75[_0x85c706(0x190)];_0x430568++)if(_0x5e9a75[_0x430568]!=='default')__createBinding(_0x420339,_0x27df71,_0x5e9a75[_0x430568]);}return __setModuleDefault(_0x420339,_0x27df71),_0x420339;};}()),__importDefault=this&&this['__importDefault']||function(_0x2383ba){const _0x1c3086=a13_0x2fdba9;return _0x2383ba&&_0x2383ba[_0x1c3086(0x195)]?_0x2383ba:{'default':_0x2383ba};};Object['defineProperty'](exports,a13_0x2fdba9(0x195),{'value':!![]}),exports[a13_0x2fdba9(0x174)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x2fdba9(0x15a)));class TestGatewayController{constructor(){const _0x2f6a43=a13_0x2fdba9;this[_0x2f6a43(0x191)]=async(_0x2a34f0,_0xb504e4,_0x236673)=>{const _0x25e178=_0x2f6a43;try{const {paymentId:_0x280424}=_0x2a34f0['params'];console['log'](_0x25e178(0x162)+_0x280424);const _0x33fde9=await database_1['default']['payment']['findUnique']({'where':{'id':_0x280424},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x33fde9)return _0xb504e4[_0x25e178(0x154)](0x194)[_0x25e178(0x14b)]({'success':![],'message':_0x25e178(0x17a)});if(_0x33fde9[_0x25e178(0x165)]!=='test_gateway')return _0xb504e4[_0x25e178(0x154)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x33fde9[_0x25e178(0x154)]!==_0x25e178(0x175))return _0xb504e4['status'](0x190)[_0x25e178(0x14b)]({'success':![],'message':_0x25e178(0x161)+_0x33fde9[_0x25e178(0x154)]+_0x25e178(0x157)});_0xb504e4[_0x25e178(0x14b)]({'success':!![],'result':{'paymentId':_0x33fde9['id'],'orderId':_0x33fde9[_0x25e178(0x166)],'amount':_0x33fde9[_0x25e178(0x15c)],'currency':_0x33fde9['currency'],'merchantName':_0x33fde9['shop'][_0x25e178(0x158)],'description':_0x25e178(0x17d)+_0x33fde9['shop'][_0x25e178(0x158)],'testInstructions':{'successCard':_0x25e178(0x172),'failureCard':_0x25e178(0x18d),'expiryDate':_0x25e178(0x18c),'cvc':_0x25e178(0x163),'holderName':_0x25e178(0x139)}}});}catch(_0x4f35f2){_0x236673(_0x4f35f2);}},this[_0x2f6a43(0x134)]=async(_0x160329,_0x416254,_0x68382a)=>{const _0x1e463b=_0x2f6a43;try{const {paymentId:_0x3ad130}=_0x160329[_0x1e463b(0x155)],_0x161c03=_0x160329[_0x1e463b(0x13f)];console[_0x1e463b(0x18e)](_0x1e463b(0x17f)+_0x3ad130);const _0x13e3ac=await database_1['default'][_0x1e463b(0x17e)][_0x1e463b(0x142)]({'where':{'id':_0x3ad130},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x13e3ac)return _0x416254[_0x1e463b(0x154)](0x194)[_0x1e463b(0x14b)]({'success':![],'message':_0x1e463b(0x17a)});if(_0x13e3ac[_0x1e463b(0x165)]!=='test_gateway')return _0x416254[_0x1e463b(0x154)](0x190)[_0x1e463b(0x14b)]({'success':![],'message':_0x1e463b(0x135)});if(_0x13e3ac[_0x1e463b(0x154)]!==_0x1e463b(0x175))return _0x416254[_0x1e463b(0x154)](0x190)[_0x1e463b(0x14b)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x13e3ac[_0x1e463b(0x154)]+_0x1e463b(0x157)});const _0x45e29a=await this[_0x1e463b(0x140)][_0x1e463b(0x192)]({'paymentId':_0x13e3ac['id'],'orderId':_0x13e3ac['gatewayOrderId']||_0x13e3ac['id'],'amount':_0x13e3ac[_0x1e463b(0x15c)],'currency':_0x13e3ac[_0x1e463b(0x15d)],'cardData':_0x161c03});console['log'](_0x1e463b(0x156),_0x45e29a);const _0x11b91e={'status':_0x45e29a[_0x1e463b(0x154)],'updatedAt':new Date()};if(_0x45e29a[_0x1e463b(0x154)]===_0x1e463b(0x144))_0x11b91e[_0x1e463b(0x193)]=new Date(),_0x11b91e[_0x1e463b(0x170)]=_0x45e29a[_0x1e463b(0x12c)];else _0x45e29a[_0x1e463b(0x154)]===_0x1e463b(0x197)&&(_0x11b91e[_0x1e463b(0x173)]=_0x45e29a['failureReason']);const _0xa9028a=_0x161c03['cardNumber'][_0x1e463b(0x12d)](/[\s-]/g,'');_0x11b91e[_0x1e463b(0x14d)]=_0xa9028a[_0x1e463b(0x14a)](-0x4),_0x11b91e[_0x1e463b(0x13c)]=_0x1e463b(0x16f),await database_1[_0x1e463b(0x14c)]['payment']['update']({'where':{'id':_0x13e3ac['id']},'data':_0x11b91e}),await database_1['default'][_0x1e463b(0x12e)][_0x1e463b(0x149)]({'data':{'paymentId':_0x13e3ac['id'],'shopId':_0x13e3ac[_0x1e463b(0x194)],'event':_0x1e463b(0x136)+_0x45e29a[_0x1e463b(0x154)][_0x1e463b(0x15b)](),'statusCode':0xc8,'responseBody':JSON[_0x1e463b(0x13b)]({'oldStatus':_0x1e463b(0x175),'newStatus':_0x45e29a[_0x1e463b(0x154)],'transactionId':_0x45e29a['transactionId'],'failureReason':_0x45e29a[_0x1e463b(0x151)],'processedAt':new Date()[_0x1e463b(0x153)]()})}}),await this[_0x1e463b(0x17c)](_0x13e3ac,_0x45e29a[_0x1e463b(0x154)],_0x45e29a[_0x1e463b(0x12c)],_0x45e29a[_0x1e463b(0x151)]),await this['sendPaymentStatusNotification'](_0x13e3ac,_0x45e29a[_0x1e463b(0x154)]),console['log'](_0x1e463b(0x13e)+_0x3ad130+_0x1e463b(0x15e)+_0x45e29a[_0x1e463b(0x154)]),_0x45e29a[_0x1e463b(0x154)]===_0x1e463b(0x144)?_0x416254[_0x1e463b(0x14b)]({'success':!![],'message':_0x1e463b(0x198),'result':{'status':_0x1e463b(0x144),'transactionId':_0x45e29a[_0x1e463b(0x12c)],'redirectUrl':_0x13e3ac['successUrl']}}):_0x416254[_0x1e463b(0x154)](0x190)[_0x1e463b(0x14b)]({'success':![],'message':_0x1e463b(0x186),'result':{'status':_0x1e463b(0x197),'failureReason':_0x45e29a[_0x1e463b(0x151)],'redirectUrl':_0x13e3ac[_0x1e463b(0x171)]}});}catch(_0x3a9352){_0x68382a(_0x3a9352);}},this[_0x2f6a43(0x140)]=new testGatewayService_1[(_0x2f6a43(0x179))](),this[_0x2f6a43(0x152)]=new webhookService_1[(_0x2f6a43(0x159))]();}async['sendShopWebhook'](_0x2ab219,_0x502f7a,_0x4cf7d2,_0x2c06eb){const _0x591fbf=a13_0x2fdba9,_0x1b5692=Date[_0x591fbf(0x183)]();try{const _0x63d86b=_0x2ab219[_0x591fbf(0x16c)],_0x3aabe4=_0x63d86b[_0x591fbf(0x147)];if(!_0x3aabe4?.['webhookUrl']){console[_0x591fbf(0x18e)](_0x591fbf(0x133)+_0x63d86b['id']);return;}const _0x459500=_0x502f7a===_0x591fbf(0x144)?_0x591fbf(0x146):_0x591fbf(0x18a);let _0x51de0a=[];if(_0x3aabe4['webhookEvents'])try{_0x51de0a=Array[_0x591fbf(0x18f)](_0x3aabe4[_0x591fbf(0x167)])?_0x3aabe4['webhookEvents']:JSON[_0x591fbf(0x145)](_0x3aabe4['webhookEvents']);}catch(_0xea87b8){console[_0x591fbf(0x180)](_0x591fbf(0x16a),_0xea87b8),_0x51de0a=[];}if(!_0x51de0a[_0x591fbf(0x143)](_0x459500)){console['log'](_0x591fbf(0x131)+_0x459500+_0x591fbf(0x13d)+_0x63d86b['id']);return;}const _0x32a44d={'event':_0x459500,'payment':{'id':_0x2ab219['id'],'order_id':_0x2ab219['orderId'],'gateway_order_id':_0x2ab219['gatewayOrderId'],'gateway':_0x591fbf(0x137),'amount':_0x2ab219[_0x591fbf(0x15c)],'currency':_0x2ab219['currency'],'status':_0x502f7a['toLowerCase'](),'customer_email':_0x2ab219[_0x591fbf(0x169)],'customer_name':_0x2ab219[_0x591fbf(0x12f)],'transaction_id':_0x4cf7d2,'failure_message':_0x2c06eb,'created_at':_0x2ab219['createdAt'],'updated_at':new Date()}},_0x18377a=await fetch(_0x3aabe4['webhookUrl'],{'method':_0x591fbf(0x16d),'headers':{'Content-Type':_0x591fbf(0x16e),'User-Agent':_0x591fbf(0x177)},'body':JSON['stringify'](_0x32a44d)}),_0x37116=Date[_0x591fbf(0x183)]()-_0x1b5692;console[_0x591fbf(0x18e)](_0x591fbf(0x182)+_0x3aabe4['webhookUrl']+_0x591fbf(0x187)+_0x18377a['status']+'\x20('+_0x37116+_0x591fbf(0x141));}catch(_0x2e5fdc){console[_0x591fbf(0x180)](_0x591fbf(0x14f),_0x2e5fdc);}}async['sendPaymentStatusNotification'](_0x176026,_0x235613){const _0x154f37=a13_0x2fdba9;try{const {telegramBotService:_0xca2e16}=await Promise[_0x154f37(0x16b)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x51970a={'PAID':_0x154f37(0x13a),'FAILED':_0x154f37(0x164)},_0x551357=_0x51970a[_0x235613];if(!_0x551357)return;await _0xca2e16[_0x154f37(0x17b)](_0x176026[_0x154f37(0x194)],_0x176026,_0x551357);}catch(_0x5c1b09){console['error'](_0x154f37(0x176),_0x5c1b09);}}}exports['TestGatewayController']=TestGatewayController;