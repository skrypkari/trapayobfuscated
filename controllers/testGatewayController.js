'use strict';const a13_0x3f8cfa=a13_0x2289;function a13_0x2289(_0x441f44,_0x5e8abc){const _0x41afe3=a13_0x41af();return a13_0x2289=function(_0x228952,_0x44a9a5){_0x228952=_0x228952-0xc7;let _0xa907d1=_0x41afe3[_0x228952];return _0xa907d1;},a13_0x2289(_0x441f44,_0x5e8abc);}(function(_0x27962a,_0x3d4c5c){const _0x2d4e5e=a13_0x2289,_0x5bf6df=_0x27962a();while(!![]){try{const _0x37335d=-parseInt(_0x2d4e5e(0x10e))/0x1*(parseInt(_0x2d4e5e(0x106))/0x2)+parseInt(_0x2d4e5e(0x129))/0x3+-parseInt(_0x2d4e5e(0x121))/0x4*(parseInt(_0x2d4e5e(0xde))/0x5)+-parseInt(_0x2d4e5e(0xd1))/0x6*(-parseInt(_0x2d4e5e(0xca))/0x7)+parseInt(_0x2d4e5e(0x112))/0x8*(-parseInt(_0x2d4e5e(0xcc))/0x9)+-parseInt(_0x2d4e5e(0x12d))/0xa+parseInt(_0x2d4e5e(0xea))/0xb;if(_0x37335d===_0x3d4c5c)break;else _0x5bf6df['push'](_0x5bf6df['shift']());}catch(_0x14f72b){_0x5bf6df['push'](_0x5bf6df['shift']());}}}(a13_0x41af,0x6c023));var __createBinding=this&&this[a13_0x3f8cfa(0x109)]||(Object['create']?function(_0x2a96ff,_0x186609,_0x178acf,_0x340cf0){const _0x2012d6=a13_0x3f8cfa;if(_0x340cf0===undefined)_0x340cf0=_0x178acf;var _0x16fee8=Object[_0x2012d6(0xce)](_0x186609,_0x178acf);(!_0x16fee8||(_0x2012d6(0x11b)in _0x16fee8?!_0x186609['__esModule']:_0x16fee8['writable']||_0x16fee8['configurable']))&&(_0x16fee8={'enumerable':!![],'get':function(){return _0x186609[_0x178acf];}}),Object['defineProperty'](_0x2a96ff,_0x340cf0,_0x16fee8);}:function(_0x1126a6,_0x54e064,_0x362459,_0xc83e85){if(_0xc83e85===undefined)_0xc83e85=_0x362459;_0x1126a6[_0xc83e85]=_0x54e064[_0x362459];}),__setModuleDefault=this&&this[a13_0x3f8cfa(0x108)]||(Object[a13_0x3f8cfa(0xec)]?function(_0x128720,_0x2c488e){const _0x27bf97=a13_0x3f8cfa;Object[_0x27bf97(0xd5)](_0x128720,_0x27bf97(0xe1),{'enumerable':!![],'value':_0x2c488e});}:function(_0xc7c98,_0x4f3ee5){_0xc7c98['default']=_0x4f3ee5;}),__importStar=this&&this[a13_0x3f8cfa(0xf0)]||(function(){var _0x2c0a06=function(_0x47a0e6){return _0x2c0a06=Object['getOwnPropertyNames']||function(_0x2ea29a){const _0x1a7bdc=a13_0x2289;var _0x195825=[];for(var _0x2db6ce in _0x2ea29a)if(Object[_0x1a7bdc(0x12c)][_0x1a7bdc(0x127)][_0x1a7bdc(0xdb)](_0x2ea29a,_0x2db6ce))_0x195825[_0x195825[_0x1a7bdc(0xd2)]]=_0x2db6ce;return _0x195825;},_0x2c0a06(_0x47a0e6);};return function(_0x2b4c35){const _0x1f8b25=a13_0x2289;if(_0x2b4c35&&_0x2b4c35['__esModule'])return _0x2b4c35;var _0xc71464={};if(_0x2b4c35!=null){for(var _0xeff423=_0x2c0a06(_0x2b4c35),_0x17ea96=0x0;_0x17ea96<_0xeff423[_0x1f8b25(0xd2)];_0x17ea96++)if(_0xeff423[_0x17ea96]!==_0x1f8b25(0xe1))__createBinding(_0xc71464,_0x2b4c35,_0xeff423[_0x17ea96]);}return __setModuleDefault(_0xc71464,_0x2b4c35),_0xc71464;};}()),__importDefault=this&&this[a13_0x3f8cfa(0xfd)]||function(_0x4883d7){const _0x564b51=a13_0x3f8cfa;return _0x4883d7&&_0x4883d7[_0x564b51(0x117)]?_0x4883d7:{'default':_0x4883d7};};Object[a13_0x3f8cfa(0xd5)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x3f8cfa(0x11e)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x42beb6=a13_0x3f8cfa;this[_0x42beb6(0xe4)]=async(_0x191437,_0xf759b1,_0x71ae5e)=>{const _0x2dbf25=_0x42beb6;try{const {paymentId:_0x361546}=_0x191437[_0x2dbf25(0xf1)];console['log'](_0x2dbf25(0xdd)+_0x361546);const _0x4ba82e=await database_1[_0x2dbf25(0xe1)]['payment'][_0x2dbf25(0x128)]({'where':{'id':_0x361546},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4ba82e)return _0xf759b1['status'](0x194)[_0x2dbf25(0xcd)]({'success':![],'message':_0x2dbf25(0xfe)});if(_0x4ba82e[_0x2dbf25(0xc9)]!==_0x2dbf25(0x10b))return _0xf759b1[_0x2dbf25(0xf7)](0x190)[_0x2dbf25(0xcd)]({'success':![],'message':_0x2dbf25(0x10f)});if(_0x4ba82e['status']!==_0x2dbf25(0x110))return _0xf759b1[_0x2dbf25(0xf7)](0x190)[_0x2dbf25(0xcd)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4ba82e[_0x2dbf25(0xf7)]+',\x20cannot\x20process'});_0xf759b1[_0x2dbf25(0xcd)]({'success':!![],'result':{'paymentId':_0x4ba82e['id'],'orderId':_0x4ba82e['gatewayOrderId'],'amount':_0x4ba82e[_0x2dbf25(0xf6)],'currency':_0x4ba82e[_0x2dbf25(0x10c)],'merchantName':_0x4ba82e[_0x2dbf25(0xe6)][_0x2dbf25(0xda)],'description':_0x2dbf25(0x105)+_0x4ba82e['shop'][_0x2dbf25(0xda)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x2dbf25(0x102),'cvc':_0x2dbf25(0x114),'holderName':_0x2dbf25(0xcf)}}});}catch(_0xccd83b){_0x71ae5e(_0xccd83b);}},this['processCard']=async(_0x119642,_0x3ab408,_0x13be2b)=>{const _0x201f20=_0x42beb6;try{const {paymentId:_0x3c1dd4}=_0x119642[_0x201f20(0xf1)],_0x4b76f4=_0x119642['body'];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3c1dd4);const _0x242454=await database_1[_0x201f20(0xe1)][_0x201f20(0x11d)][_0x201f20(0x128)]({'where':{'id':_0x3c1dd4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x242454)return _0x3ab408[_0x201f20(0xf7)](0x194)[_0x201f20(0xcd)]({'success':![],'message':_0x201f20(0xfe)});if(_0x242454[_0x201f20(0xc9)]!==_0x201f20(0x10b))return _0x3ab408[_0x201f20(0xf7)](0x190)[_0x201f20(0xcd)]({'success':![],'message':_0x201f20(0x10f)});if(_0x242454[_0x201f20(0xf7)]!==_0x201f20(0x110))return _0x3ab408['status'](0x190)[_0x201f20(0xcd)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x242454['status']+_0x201f20(0xd8)});const _0xbf4f71=await this['testGatewayService'][_0x201f20(0xe8)]({'paymentId':_0x242454['id'],'orderId':_0x242454['gatewayOrderId']||_0x242454['id'],'amount':_0x242454[_0x201f20(0xf6)],'currency':_0x242454['currency'],'cardData':_0x4b76f4});console[_0x201f20(0xd6)](_0x201f20(0x11a),_0xbf4f71);const _0x414ecf={'status':_0xbf4f71['status'],'updatedAt':new Date()};if(_0xbf4f71[_0x201f20(0xf7)]===_0x201f20(0xdf))_0x414ecf['paidAt']=new Date(),_0x414ecf[_0x201f20(0x101)]=_0xbf4f71[_0x201f20(0xeb)];else _0xbf4f71[_0x201f20(0xf7)]===_0x201f20(0xe9)&&(_0x414ecf[_0x201f20(0x113)]=_0xbf4f71[_0x201f20(0x125)]);const _0x122aa0=_0x4b76f4[_0x201f20(0xf9)][_0x201f20(0x10a)](/[\s-]/g,'');_0x414ecf[_0x201f20(0xfc)]=_0x122aa0[_0x201f20(0xdc)](-0x4),_0x414ecf['paymentMethod']=_0x201f20(0xf4),await database_1[_0x201f20(0xe1)][_0x201f20(0x11d)][_0x201f20(0x118)]({'where':{'id':_0x242454['id']},'data':_0x414ecf}),await database_1[_0x201f20(0xe1)]['webhookLog'][_0x201f20(0xec)]({'data':{'paymentId':_0x242454['id'],'shopId':_0x242454[_0x201f20(0x104)],'event':_0x201f20(0x11c)+_0xbf4f71[_0x201f20(0xf7)][_0x201f20(0x10d)](),'statusCode':0xc8,'responseBody':JSON[_0x201f20(0xcb)]({'oldStatus':_0x201f20(0x110),'newStatus':_0xbf4f71[_0x201f20(0xf7)],'transactionId':_0xbf4f71['transactionId'],'failureReason':_0xbf4f71[_0x201f20(0x125)],'processedAt':new Date()[_0x201f20(0x123)]()})}}),await this['sendShopWebhook'](_0x242454,_0xbf4f71[_0x201f20(0xf7)],_0xbf4f71[_0x201f20(0xeb)],_0xbf4f71[_0x201f20(0x125)]),await this[_0x201f20(0x12b)](_0x242454,_0xbf4f71[_0x201f20(0xf7)]),console[_0x201f20(0xd6)](_0x201f20(0xe0)+_0x3c1dd4+'\x20processed:\x20'+_0xbf4f71['status']),_0xbf4f71[_0x201f20(0xf7)]==='PAID'?_0x3ab408[_0x201f20(0xcd)]({'success':!![],'message':_0x201f20(0x126),'result':{'status':_0x201f20(0xdf),'transactionId':_0xbf4f71[_0x201f20(0xeb)],'redirectUrl':_0x242454[_0x201f20(0x111)]}}):_0x3ab408[_0x201f20(0xf7)](0x190)['json']({'success':![],'message':_0x201f20(0xfb),'result':{'status':_0x201f20(0xe9),'failureReason':_0xbf4f71[_0x201f20(0x125)],'redirectUrl':_0x242454[_0x201f20(0x12a)]}});}catch(_0x462b6f){_0x13be2b(_0x462b6f);}},this['testGatewayService']=new testGatewayService_1[(_0x42beb6(0x120))](),this[_0x42beb6(0x122)]=new webhookService_1[(_0x42beb6(0xe3))]();}async[a13_0x3f8cfa(0xc7)](_0x57d1a5,_0x301b73,_0x1a8f3b,_0x1a9afb){const _0x4cb0fe=a13_0x3f8cfa,_0xf08dcd=Date['now']();try{const _0x16f930=_0x57d1a5[_0x4cb0fe(0xe6)],_0x469b60=_0x16f930[_0x4cb0fe(0xe7)];if(!_0x469b60?.['webhookUrl']){console[_0x4cb0fe(0xd6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x16f930['id']);return;}const _0x134113=_0x301b73===_0x4cb0fe(0xdf)?_0x4cb0fe(0xf5):'payment.failed';let _0x5cea7a=[];if(_0x469b60['webhookEvents'])try{_0x5cea7a=Array[_0x4cb0fe(0x116)](_0x469b60['webhookEvents'])?_0x469b60[_0x4cb0fe(0xd3)]:JSON['parse'](_0x469b60[_0x4cb0fe(0xd3)]);}catch(_0x3694d7){console['error'](_0x4cb0fe(0x11f),_0x3694d7),_0x5cea7a=[];}if(!_0x5cea7a['includes'](_0x134113)){console[_0x4cb0fe(0xd6)]('Webhook\x20event\x20'+_0x134113+_0x4cb0fe(0x119)+_0x16f930['id']);return;}const _0x39f9d9={'event':_0x134113,'payment':{'id':_0x57d1a5['id'],'order_id':_0x57d1a5[_0x4cb0fe(0xef)],'gateway_order_id':_0x57d1a5['gatewayOrderId'],'gateway':_0x4cb0fe(0xd4),'amount':_0x57d1a5[_0x4cb0fe(0xf6)],'currency':_0x57d1a5[_0x4cb0fe(0x10c)],'status':_0x301b73['toLowerCase'](),'customer_email':_0x57d1a5[_0x4cb0fe(0xf3)],'customer_name':_0x57d1a5[_0x4cb0fe(0xf8)],'transaction_id':_0x1a8f3b,'failure_message':_0x1a9afb,'created_at':_0x57d1a5['createdAt'],'updated_at':new Date()}},_0x3258cd=await fetch(_0x469b60[_0x4cb0fe(0xee)],{'method':_0x4cb0fe(0xc8),'headers':{'Content-Type':_0x4cb0fe(0x115),'User-Agent':_0x4cb0fe(0xe5)},'body':JSON['stringify'](_0x39f9d9)}),_0x1a0d58=Date[_0x4cb0fe(0xf2)]()-_0xf08dcd;console[_0x4cb0fe(0xd6)](_0x4cb0fe(0x100)+_0x469b60[_0x4cb0fe(0xee)]+'\x20with\x20status\x20'+_0x3258cd['status']+'\x20('+_0x1a0d58+_0x4cb0fe(0xfa));}catch(_0x92d079){console[_0x4cb0fe(0xd9)](_0x4cb0fe(0xd7),_0x92d079);}}async[a13_0x3f8cfa(0x12b)](_0xca262f,_0x54e2a1){const _0x397717=a13_0x3f8cfa;try{const {telegramBotService:_0x14c3fc}=await Promise[_0x397717(0xed)]()[_0x397717(0x103)](()=>__importStar(require(_0x397717(0xd0)))),_0x4ae764={'PAID':_0x397717(0xe2),'FAILED':'failed'},_0x4f40f0=_0x4ae764[_0x54e2a1];if(!_0x4f40f0)return;await _0x14c3fc[_0x397717(0x124)](_0xca262f[_0x397717(0x104)],_0xca262f,_0x4f40f0);}catch(_0x486330){console[_0x397717(0xd9)](_0x397717(0xff),_0x486330);}}}function a13_0x41af(){const _0x541dd2=['settings','processCardPayment','FAILED','16102119dwRMna','transactionId','create','resolve','webhookUrl','orderId','__importStar','params','now','customerEmail','test_card','payment.success','amount','status','customerName','cardNumber','ms)','Payment\x20failed','cardLast4','__importDefault','Payment\x20not\x20found','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Test\x20Gateway\x20webhook\x20sent\x20to\x20','gatewayPaymentId','Any\x20future\x20date\x20(MM/YY)','then','shopId','Payment\x20to\x20','51082lTiaaC','TestGatewayController','__setModuleDefault','__createBinding','replace','test_gateway','currency','toLowerCase','17jdKhkq','Payment\x20is\x20not\x20for\x20test\x20gateway','PENDING','successUrl','8NbmklT','failureMessage','Any\x203-4\x20digits','application/json','isArray','__esModule','update','\x20not\x20enabled\x20for\x20shop\x20','ðŸ§ª\x20Test\x20Gateway\x20result:','get','test_gateway_','payment','../services/gateways/testGatewayService','Error\x20parsing\x20webhook\x20events:','TestGatewayService','1563316JkbZBJ','webhookService','toISOString','sendPaymentNotification','failureReason','Payment\x20processed\x20successfully','hasOwnProperty','findUnique','302520sFxkOQ','failUrl','sendPaymentStatusNotification','prototype','8297730oTLUPW','sendShopWebhook','POST','gateway','7ZUjOaC','stringify','547137SGOwec','json','getOwnPropertyDescriptor','Any\x20name','../services/telegramBotService','3559956KuAUsT','length','webhookEvents','0000','defineProperty','log','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',',\x20cannot\x20process','error','name','call','slice','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','5ZOCnPo','PAID','âœ…\x20Test\x20Gateway\x20payment\x20','default','paid','WebhookService','getPaymentForm','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','shop'];a13_0x41af=function(){return _0x541dd2;};return a13_0x41af();}exports[a13_0x3f8cfa(0x107)]=TestGatewayController;