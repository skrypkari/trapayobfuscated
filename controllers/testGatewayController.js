'use strict';const a15_0x1972e1=a15_0x2a61;(function(_0xa0d844,_0x25b86c){const _0x468b3a=a15_0x2a61,_0x1a68ed=_0xa0d844();while(!![]){try{const _0x4a1356=-parseInt(_0x468b3a(0x17a))/0x1*(parseInt(_0x468b3a(0x17c))/0x2)+-parseInt(_0x468b3a(0x135))/0x3*(parseInt(_0x468b3a(0x12f))/0x4)+-parseInt(_0x468b3a(0x12e))/0x5*(-parseInt(_0x468b3a(0x150))/0x6)+parseInt(_0x468b3a(0x13d))/0x7+-parseInt(_0x468b3a(0x149))/0x8+parseInt(_0x468b3a(0x166))/0x9+parseInt(_0x468b3a(0x155))/0xa;if(_0x4a1356===_0x25b86c)break;else _0x1a68ed['push'](_0x1a68ed['shift']());}catch(_0x35c087){_0x1a68ed['push'](_0x1a68ed['shift']());}}}(a15_0x2089,0x3542e));function a15_0x2089(){const _0x16c81c=['../services/gateways/testGatewayService','__createBinding','10EeyBOz','4AswjbU','getPaymentForm','test_gateway_','‚úÖ\x20Test\x20Gateway\x20payment\x20','PENDING','__esModule','83751lOGVPt','gateway','configurable','paymentMethod','\x20not\x20found','TestGatewayService','status','call','1079869NCYeTx','processCard','shopId','gatewayPaymentId','name','webhookLog','json','length','then','stringify','../config/database','Payment\x20status\x20is\x20','1501856Krrtyw','get','type','sendShopWebhook','params','paidAt','resolve','630156AmrbxB','Payment\x20processed\x20successfully','‚ùå\x20Payment\x20link\x20','paid','../services/telegramBotService','1347290KlaazQ','üß™\x20Test\x20Gateway\x20result:','log','default','webhookEvents','üìà\x20Found\x20payment\x20link\x20',',\x20cannot\x20process','parse','$transaction','\x20->\x20','Webhook\x20event\x20','failed','Payment\x20is\x20not\x20for\x20test\x20gateway','includes','test_card','Payment\x20not\x20found','Payment\x20to\x20','616491wlicjt','Payment\x20failed','payment','processCardPayment','failureMessage','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','createdAt','getOwnPropertyNames','\x20not\x20enabled\x20for\x20shop\x20','WebhookService','__importStar','Error\x20parsing\x20webhook\x20events:','PAID','gatewayOrderId','üìà\x20Test\x20Gateway:\x20Payment\x20','sendPaymentStatusNotification','COMPLETED','__importDefault','error','\x20updated:\x20currentPayments=','1486pKhgoi','TestGatewayController','180WVkNpR','shop','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','SINGLE','findUnique','Any\x20other\x20card\x20number','hasOwnProperty','failureReason',':\x20type=','webhookUrl','customerEmail','__setModuleDefault','paymentLink','getOwnPropertyDescriptor','update','../services/webhookService','toLowerCase','now','currentPayments','cardNumber','amount','successUrl','FAILED','paymentLinkId','settings','prototype',',\x20status=','failUrl','payment.success','webhookService','writable','currency','slice','orderId','create','application/json','defineProperty','testGatewayService','replace','Test\x20Gateway\x20webhook\x20sent\x20to\x20','transactionId'];a15_0x2089=function(){return _0x16c81c;};return a15_0x2089();}var __createBinding=this&&this[a15_0x1972e1(0x12d)]||(Object['create']?function(_0x2e7ea1,_0x111d62,_0x48282f,_0x26a73c){const _0x28146d=a15_0x1972e1;if(_0x26a73c===undefined)_0x26a73c=_0x48282f;var _0x753679=Object[_0x28146d(0x189)](_0x111d62,_0x48282f);(!_0x753679||(_0x28146d(0x14a)in _0x753679?!_0x111d62[_0x28146d(0x134)]:_0x753679[_0x28146d(0x121)]||_0x753679[_0x28146d(0x137)]))&&(_0x753679={'enumerable':!![],'get':function(){return _0x111d62[_0x48282f];}}),Object[_0x28146d(0x127)](_0x2e7ea1,_0x26a73c,_0x753679);}:function(_0x6f3062,_0x426914,_0x2a63bb,_0x15d613){if(_0x15d613===undefined)_0x15d613=_0x2a63bb;_0x6f3062[_0x15d613]=_0x426914[_0x2a63bb];}),__setModuleDefault=this&&this[a15_0x1972e1(0x187)]||(Object[a15_0x1972e1(0x125)]?function(_0x1ab78d,_0x4160cd){const _0x17fdaa=a15_0x1972e1;Object[_0x17fdaa(0x127)](_0x1ab78d,_0x17fdaa(0x158),{'enumerable':!![],'value':_0x4160cd});}:function(_0x4119ae,_0x58ea5e){_0x4119ae['default']=_0x58ea5e;}),__importStar=this&&this[a15_0x1972e1(0x170)]||(function(){var _0x296543=function(_0x1fd461){const _0x4b3887=a15_0x2a61;return _0x296543=Object[_0x4b3887(0x16d)]||function(_0x3312d7){const _0x3e9d75=_0x4b3887;var _0x472033=[];for(var _0x47b1bc in _0x3312d7)if(Object[_0x3e9d75(0x11c)][_0x3e9d75(0x182)][_0x3e9d75(0x13c)](_0x3312d7,_0x47b1bc))_0x472033[_0x472033[_0x3e9d75(0x144)]]=_0x47b1bc;return _0x472033;},_0x296543(_0x1fd461);};return function(_0x508299){const _0x2bd2e4=a15_0x2a61;if(_0x508299&&_0x508299[_0x2bd2e4(0x134)])return _0x508299;var _0x8cc0d5={};if(_0x508299!=null){for(var _0x4cab8b=_0x296543(_0x508299),_0x9010a4=0x0;_0x9010a4<_0x4cab8b[_0x2bd2e4(0x144)];_0x9010a4++)if(_0x4cab8b[_0x9010a4]!==_0x2bd2e4(0x158))__createBinding(_0x8cc0d5,_0x508299,_0x4cab8b[_0x9010a4]);}return __setModuleDefault(_0x8cc0d5,_0x508299),_0x8cc0d5;};}()),__importDefault=this&&this[a15_0x1972e1(0x177)]||function(_0x2ac43f){return _0x2ac43f&&_0x2ac43f['__esModule']?_0x2ac43f:{'default':_0x2ac43f};};Object['defineProperty'](exports,a15_0x1972e1(0x134),{'value':!![]}),exports[a15_0x1972e1(0x17b)]=void 0x0;const testGatewayService_1=require(a15_0x1972e1(0x12c)),webhookService_1=require(a15_0x1972e1(0x18b)),database_1=__importDefault(require(a15_0x1972e1(0x147)));class TestGatewayController{constructor(){const _0x3ee349=a15_0x1972e1;this[_0x3ee349(0x130)]=async(_0x49bdcd,_0x3ab11e,_0x283c37)=>{const _0x421449=_0x3ee349;try{const {paymentId:_0x383b2e}=_0x49bdcd[_0x421449(0x14d)];console[_0x421449(0x157)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x383b2e);const _0xb28292=await database_1[_0x421449(0x158)]['payment'][_0x421449(0x180)]({'where':{'id':_0x383b2e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xb28292)return _0x3ab11e[_0x421449(0x13b)](0x194)['json']({'success':![],'message':_0x421449(0x164)});if(_0xb28292[_0x421449(0x136)]!=='test_gateway')return _0x3ab11e[_0x421449(0x13b)](0x190)[_0x421449(0x143)]({'success':![],'message':_0x421449(0x161)});if(_0xb28292['status']!=='PENDING')return _0x3ab11e[_0x421449(0x13b)](0x190)[_0x421449(0x143)]({'success':![],'message':_0x421449(0x148)+_0xb28292['status']+_0x421449(0x15b)});_0x3ab11e[_0x421449(0x143)]({'success':!![],'result':{'paymentId':_0xb28292['id'],'orderId':_0xb28292['gatewayOrderId'],'amount':_0xb28292[_0x421449(0x190)],'currency':_0xb28292[_0x421449(0x122)],'merchantName':_0xb28292[_0x421449(0x17d)][_0x421449(0x141)],'description':_0x421449(0x165)+_0xb28292[_0x421449(0x17d)][_0x421449(0x141)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x421449(0x181),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x1b4d57){_0x283c37(_0x1b4d57);}},this[_0x3ee349(0x13e)]=async(_0x4f0875,_0x14b743,_0x16795c)=>{const _0x63a720=_0x3ee349;try{const {paymentId:_0x4726c5}=_0x4f0875[_0x63a720(0x14d)],_0x19a750=_0x4f0875['body'];console[_0x63a720(0x157)](_0x63a720(0x16b)+_0x4726c5);const _0x1fb312=await database_1[_0x63a720(0x158)][_0x63a720(0x168)][_0x63a720(0x180)]({'where':{'id':_0x4726c5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1fb312)return _0x14b743['status'](0x194)[_0x63a720(0x143)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1fb312[_0x63a720(0x136)]!=='test_gateway')return _0x14b743[_0x63a720(0x13b)](0x190)[_0x63a720(0x143)]({'success':![],'message':_0x63a720(0x161)});if(_0x1fb312[_0x63a720(0x13b)]!==_0x63a720(0x133))return _0x14b743[_0x63a720(0x13b)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1fb312[_0x63a720(0x13b)]+_0x63a720(0x15b)});const _0x29d1dc=await this[_0x63a720(0x128)][_0x63a720(0x169)]({'paymentId':_0x1fb312['id'],'orderId':_0x1fb312[_0x63a720(0x173)]||_0x1fb312['id'],'amount':_0x1fb312[_0x63a720(0x190)],'currency':_0x1fb312[_0x63a720(0x122)],'cardData':_0x19a750});console[_0x63a720(0x157)](_0x63a720(0x156),_0x29d1dc);const _0x488311={'status':_0x29d1dc[_0x63a720(0x13b)],'updatedAt':new Date()};if(_0x29d1dc[_0x63a720(0x13b)]===_0x63a720(0x172))_0x488311[_0x63a720(0x14e)]=new Date(),_0x488311[_0x63a720(0x140)]=_0x29d1dc[_0x63a720(0x12b)];else _0x29d1dc['status']===_0x63a720(0x119)&&(_0x488311[_0x63a720(0x16a)]=_0x29d1dc[_0x63a720(0x183)]);const _0x1f2139=_0x19a750[_0x63a720(0x18f)][_0x63a720(0x129)](/[\s-]/g,'');_0x488311['cardLast4']=_0x1f2139[_0x63a720(0x123)](-0x4),_0x488311[_0x63a720(0x138)]=_0x63a720(0x163),await database_1[_0x63a720(0x158)][_0x63a720(0x168)][_0x63a720(0x18a)]({'where':{'id':_0x1fb312['id']},'data':_0x488311});if(_0x29d1dc['status']===_0x63a720(0x172)&&_0x1fb312['paymentLinkId']){console[_0x63a720(0x157)](_0x63a720(0x174)+_0x1fb312['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x63a720(0x158)][_0x63a720(0x15d)](async _0x3b5958=>{const _0x41abe9=_0x63a720,_0x5c3283=await _0x3b5958[_0x41abe9(0x188)][_0x41abe9(0x180)]({'where':{'id':_0x1fb312[_0x41abe9(0x11a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5c3283){console['log'](_0x41abe9(0x15a)+_0x5c3283['id']+_0x41abe9(0x184)+_0x5c3283[_0x41abe9(0x14b)]+',\x20currentPayments='+_0x5c3283['currentPayments']+_0x41abe9(0x11d)+_0x5c3283[_0x41abe9(0x13b)]);const _0x9a7260=_0x5c3283['currentPayments']+0x1,_0x15200a=_0x5c3283['type']===_0x41abe9(0x17f)?_0x41abe9(0x176):_0x5c3283[_0x41abe9(0x13b)];await _0x3b5958[_0x41abe9(0x188)][_0x41abe9(0x18a)]({'where':{'id':_0x1fb312['paymentLinkId']},'data':{'currentPayments':_0x9a7260,'status':_0x15200a,'updatedAt':new Date()}}),console[_0x41abe9(0x157)]('‚úÖ\x20Payment\x20link\x20'+_0x5c3283['id']+_0x41abe9(0x179)+_0x5c3283[_0x41abe9(0x18e)]+'\x20->\x20'+_0x9a7260+_0x41abe9(0x11d)+_0x5c3283[_0x41abe9(0x13b)]+_0x41abe9(0x15e)+_0x15200a);}else console[_0x41abe9(0x157)](_0x41abe9(0x152)+_0x1fb312[_0x41abe9(0x11a)]+_0x41abe9(0x139));});}catch(_0x4573c9){console[_0x63a720(0x178)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x4573c9);}}await database_1[_0x63a720(0x158)][_0x63a720(0x142)][_0x63a720(0x125)]({'data':{'paymentId':_0x1fb312['id'],'shopId':_0x1fb312[_0x63a720(0x13f)],'event':_0x63a720(0x131)+_0x29d1dc[_0x63a720(0x13b)][_0x63a720(0x18c)](),'statusCode':0xc8,'responseBody':JSON[_0x63a720(0x146)]({'oldStatus':'PENDING','newStatus':_0x29d1dc[_0x63a720(0x13b)],'transactionId':_0x29d1dc['transactionId'],'failureReason':_0x29d1dc[_0x63a720(0x183)],'processedAt':new Date()['toISOString']()})}}),await this[_0x63a720(0x14c)](_0x1fb312,_0x29d1dc[_0x63a720(0x13b)],_0x29d1dc[_0x63a720(0x12b)],_0x29d1dc[_0x63a720(0x183)]),await this[_0x63a720(0x175)](_0x1fb312,_0x29d1dc['status']),console['log'](_0x63a720(0x132)+_0x4726c5+'\x20processed:\x20'+_0x29d1dc['status']),_0x29d1dc[_0x63a720(0x13b)]===_0x63a720(0x172)?_0x14b743[_0x63a720(0x143)]({'success':!![],'message':_0x63a720(0x151),'result':{'status':_0x63a720(0x172),'transactionId':_0x29d1dc['transactionId'],'redirectUrl':_0x1fb312[_0x63a720(0x191)]}}):_0x14b743[_0x63a720(0x13b)](0x190)[_0x63a720(0x143)]({'success':![],'message':_0x63a720(0x167),'result':{'status':'FAILED','failureReason':_0x29d1dc[_0x63a720(0x183)],'redirectUrl':_0x1fb312[_0x63a720(0x11e)]}});}catch(_0x4c36f4){_0x16795c(_0x4c36f4);}},this['testGatewayService']=new testGatewayService_1[(_0x3ee349(0x13a))](),this[_0x3ee349(0x120)]=new webhookService_1[(_0x3ee349(0x16f))]();}async['sendShopWebhook'](_0x169424,_0x1436e8,_0x2344a3,_0x4c9850){const _0x30b328=a15_0x1972e1,_0x935101=Date['now']();try{const _0x588b7a=_0x169424[_0x30b328(0x17d)],_0x445763=_0x588b7a[_0x30b328(0x11b)];if(!_0x445763?.[_0x30b328(0x185)]){console['log'](_0x30b328(0x17e)+_0x588b7a['id']);return;}const _0x59d6e2=_0x1436e8===_0x30b328(0x172)?_0x30b328(0x11f):'payment.failed';let _0x501454=[];if(_0x445763[_0x30b328(0x159)])try{_0x501454=Array['isArray'](_0x445763[_0x30b328(0x159)])?_0x445763[_0x30b328(0x159)]:JSON[_0x30b328(0x15c)](_0x445763['webhookEvents']);}catch(_0x42c2c1){console[_0x30b328(0x178)](_0x30b328(0x171),_0x42c2c1),_0x501454=[];}if(!_0x501454[_0x30b328(0x162)](_0x59d6e2)){console[_0x30b328(0x157)](_0x30b328(0x15f)+_0x59d6e2+_0x30b328(0x16e)+_0x588b7a['id']);return;}const _0x6c79a={'event':_0x59d6e2,'payment':{'id':_0x169424['id'],'order_id':_0x169424[_0x30b328(0x124)],'gateway_order_id':_0x169424[_0x30b328(0x173)],'gateway':'0000','amount':_0x169424[_0x30b328(0x190)],'currency':_0x169424[_0x30b328(0x122)],'status':_0x1436e8[_0x30b328(0x18c)](),'customer_email':_0x169424[_0x30b328(0x186)],'customer_name':_0x169424['customerName'],'transaction_id':_0x2344a3,'failure_message':_0x4c9850,'created_at':_0x169424[_0x30b328(0x16c)],'updated_at':new Date()}},_0x4efb3a=await fetch(_0x445763[_0x30b328(0x185)],{'method':'POST','headers':{'Content-Type':_0x30b328(0x126),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x30b328(0x146)](_0x6c79a)}),_0x5c7bb8=Date[_0x30b328(0x18d)]()-_0x935101;console[_0x30b328(0x157)](_0x30b328(0x12a)+_0x445763['webhookUrl']+'\x20with\x20status\x20'+_0x4efb3a['status']+'\x20('+_0x5c7bb8+'ms)');}catch(_0x444eb3){console[_0x30b328(0x178)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x444eb3);}}async[a15_0x1972e1(0x175)](_0x2914d1,_0x325245){const _0x57196a=a15_0x1972e1;try{const {telegramBotService:_0x4686e2}=await Promise[_0x57196a(0x14f)]()[_0x57196a(0x145)](()=>__importStar(require(_0x57196a(0x154)))),_0x4de917={'PAID':_0x57196a(0x153),'FAILED':_0x57196a(0x160)},_0x1339c9=_0x4de917[_0x325245];if(!_0x1339c9)return;await _0x4686e2['sendPaymentNotification'](_0x2914d1['shopId'],_0x2914d1,_0x1339c9);}catch(_0x3a2d03){console[_0x57196a(0x178)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3a2d03);}}}function a15_0x2a61(_0x248774,_0x537098){const _0x20898b=a15_0x2089();return a15_0x2a61=function(_0x2a61cc,_0x2bbb0d){_0x2a61cc=_0x2a61cc-0x119;let _0x42ad6a=_0x20898b[_0x2a61cc];return _0x42ad6a;},a15_0x2a61(_0x248774,_0x537098);}exports[a15_0x1972e1(0x17b)]=TestGatewayController;