'use strict';function a13_0x22a9(_0x438d56,_0x3d149b){const _0x53df1c=a13_0x53df();return a13_0x22a9=function(_0x22a910,_0x3321d2){_0x22a910=_0x22a910-0xf8;let _0x11eb48=_0x53df1c[_0x22a910];return _0x11eb48;},a13_0x22a9(_0x438d56,_0x3d149b);}const a13_0x559202=a13_0x22a9;(function(_0x266317,_0xeef6a3){const _0x24c1d4=a13_0x22a9,_0x44fe3d=_0x266317();while(!![]){try{const _0x31c592=-parseInt(_0x24c1d4(0x161))/0x1+parseInt(_0x24c1d4(0x109))/0x2*(-parseInt(_0x24c1d4(0x155))/0x3)+parseInt(_0x24c1d4(0x114))/0x4*(parseInt(_0x24c1d4(0x151))/0x5)+-parseInt(_0x24c1d4(0x10e))/0x6*(parseInt(_0x24c1d4(0x116))/0x7)+-parseInt(_0x24c1d4(0x122))/0x8+parseInt(_0x24c1d4(0x153))/0x9+parseInt(_0x24c1d4(0x10c))/0xa;if(_0x31c592===_0xeef6a3)break;else _0x44fe3d['push'](_0x44fe3d['shift']());}catch(_0xe0b9aa){_0x44fe3d['push'](_0x44fe3d['shift']());}}}(a13_0x53df,0x7aa20));var __createBinding=this&&this[a13_0x559202(0x113)]||(Object[a13_0x559202(0x163)]?function(_0x792182,_0x3beead,_0x34d640,_0x5b5167){const _0x1bc247=a13_0x559202;if(_0x5b5167===undefined)_0x5b5167=_0x34d640;var _0x283cf8=Object[_0x1bc247(0x11b)](_0x3beead,_0x34d640);(!_0x283cf8||('get'in _0x283cf8?!_0x3beead[_0x1bc247(0x12a)]:_0x283cf8[_0x1bc247(0x102)]||_0x283cf8['configurable']))&&(_0x283cf8={'enumerable':!![],'get':function(){return _0x3beead[_0x34d640];}}),Object['defineProperty'](_0x792182,_0x5b5167,_0x283cf8);}:function(_0x3bcbb9,_0x23f6e9,_0x889324,_0x2b89ce){if(_0x2b89ce===undefined)_0x2b89ce=_0x889324;_0x3bcbb9[_0x2b89ce]=_0x23f6e9[_0x889324];}),__setModuleDefault=this&&this[a13_0x559202(0x111)]||(Object[a13_0x559202(0x163)]?function(_0x446f61,_0x4d02f5){const _0x2d8757=a13_0x559202;Object[_0x2d8757(0x10f)](_0x446f61,_0x2d8757(0x120),{'enumerable':!![],'value':_0x4d02f5});}:function(_0x3fddc5,_0x42d4cd){_0x3fddc5['default']=_0x42d4cd;}),__importStar=this&&this[a13_0x559202(0x123)]||(function(){var _0x4eac4e=function(_0x45f408){const _0x1fca72=a13_0x22a9;return _0x4eac4e=Object[_0x1fca72(0x14a)]||function(_0x396bdd){const _0x2af45f=_0x1fca72;var _0x3effb1=[];for(var _0x2172fc in _0x396bdd)if(Object['prototype'][_0x2af45f(0x13b)][_0x2af45f(0x15d)](_0x396bdd,_0x2172fc))_0x3effb1[_0x3effb1[_0x2af45f(0x11e)]]=_0x2172fc;return _0x3effb1;},_0x4eac4e(_0x45f408);};return function(_0x25c330){const _0x5089ab=a13_0x22a9;if(_0x25c330&&_0x25c330['__esModule'])return _0x25c330;var _0xb96d14={};if(_0x25c330!=null){for(var _0x387dbf=_0x4eac4e(_0x25c330),_0x43a17a=0x0;_0x43a17a<_0x387dbf[_0x5089ab(0x11e)];_0x43a17a++)if(_0x387dbf[_0x43a17a]!==_0x5089ab(0x120))__createBinding(_0xb96d14,_0x25c330,_0x387dbf[_0x43a17a]);}return __setModuleDefault(_0xb96d14,_0x25c330),_0xb96d14;};}()),__importDefault=this&&this[a13_0x559202(0x14f)]||function(_0x5c8ed0){return _0x5c8ed0&&_0x5c8ed0['__esModule']?_0x5c8ed0:{'default':_0x5c8ed0};};Object[a13_0x559202(0x10f)](exports,a13_0x559202(0x12a),{'value':!![]}),exports[a13_0x559202(0x12d)]=void 0x0;const testGatewayService_1=require(a13_0x559202(0x15f)),webhookService_1=require(a13_0x559202(0x13f)),database_1=__importDefault(require(a13_0x559202(0x110)));function a13_0x53df(){const _0x2c1b0c=['21535230KwhocQ','customerEmail','1818XGMory','defineProperty','../config/database','__setModuleDefault','0000','__createBinding','12APFRtV',',\x20cannot\x20process','12145PXbdUF','resolve','processCard','webhookUrl','name','getOwnPropertyDescriptor','paidAt','shop','length','now','default','settings','4839320CkUhxk','__importStar','json','paid','paymentMethod','successUrl','âœ…\x20Test\x20Gateway\x20payment\x20','params','__esModule','testGatewayService','webhookEvents','TestGatewayController','transactionId','gatewayOrderId','includes','getPaymentForm','application/json','Payment\x20to\x20','../services/telegramBotService','currency','stringify','replace','processCardPayment','update','Payment\x20processed\x20successfully','hasOwnProperty','failed','sendPaymentStatusNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/webhookService','Any\x20future\x20date\x20(MM/YY)','TestGatewayService','error','createdAt','WebhookService','payment','ms)','status','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','failureMessage','getOwnPropertyNames','parse','sendShopWebhook','Payment\x20is\x20not\x20for\x20test\x20gateway','slice','__importDefault','\x20not\x20enabled\x20for\x20shop\x20','230785dtHyAl','payment.failed','3635100viIiyr','toISOString','3rcMuUb','cardLast4','Webhook\x20event\x20','webhookLog','shopId','ðŸ§ª\x20Test\x20Gateway\x20result:','POST','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','call','cardNumber','../services/gateways/testGatewayService','amount','634499ghzAXC','payment.success','create','sendPaymentNotification','failureReason','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','gatewayPaymentId','PENDING','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20status\x20is\x20','findUnique','Any\x20other\x20card\x20number','PAID','writable','Payment\x20not\x20found','customerName','test_card','gateway','body','toLowerCase','856942IotDcp','FAILED','log'];a13_0x53df=function(){return _0x2c1b0c;};return a13_0x53df();}class TestGatewayController{constructor(){const _0x163285=a13_0x559202;this[_0x163285(0x131)]=async(_0x572ee5,_0x46fa15,_0x14dab6)=>{const _0x53acaf=_0x163285;try{const {paymentId:_0x53cacc}=_0x572ee5[_0x53acaf(0x129)];console[_0x53acaf(0x10b)](_0x53acaf(0x15c)+_0x53cacc);const _0x4859b1=await database_1[_0x53acaf(0x120)][_0x53acaf(0x145)][_0x53acaf(0xff)]({'where':{'id':_0x53cacc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4859b1)return _0x46fa15[_0x53acaf(0x147)](0x194)['json']({'success':![],'message':_0x53acaf(0x103)});if(_0x4859b1[_0x53acaf(0x106)]!=='test_gateway')return _0x46fa15[_0x53acaf(0x147)](0x190)[_0x53acaf(0x124)]({'success':![],'message':_0x53acaf(0x14d)});if(_0x4859b1['status']!==_0x53acaf(0xfc))return _0x46fa15[_0x53acaf(0x147)](0x190)['json']({'success':![],'message':_0x53acaf(0xfe)+_0x4859b1['status']+_0x53acaf(0x115)});_0x46fa15['json']({'success':!![],'result':{'paymentId':_0x4859b1['id'],'orderId':_0x4859b1[_0x53acaf(0x12f)],'amount':_0x4859b1['amount'],'currency':_0x4859b1[_0x53acaf(0x135)],'merchantName':_0x4859b1['shop'][_0x53acaf(0x11a)],'description':_0x53acaf(0x133)+_0x4859b1['shop'][_0x53acaf(0x11a)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x53acaf(0x100),'expiryDate':_0x53acaf(0x140),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x4fe35a){_0x14dab6(_0x4fe35a);}},this[_0x163285(0x118)]=async(_0x164b64,_0x3b9b35,_0x2d7e86)=>{const _0x2d5d40=_0x163285;try{const {paymentId:_0x40f657}=_0x164b64['params'],_0xbcbb4b=_0x164b64[_0x2d5d40(0x107)];console[_0x2d5d40(0x10b)](_0x2d5d40(0xfa)+_0x40f657);const _0x40f4bc=await database_1['default'][_0x2d5d40(0x145)][_0x2d5d40(0xff)]({'where':{'id':_0x40f657},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40f4bc)return _0x3b9b35[_0x2d5d40(0x147)](0x194)[_0x2d5d40(0x124)]({'success':![],'message':_0x2d5d40(0x103)});if(_0x40f4bc[_0x2d5d40(0x106)]!=='test_gateway')return _0x3b9b35[_0x2d5d40(0x147)](0x190)[_0x2d5d40(0x124)]({'success':![],'message':_0x2d5d40(0x14d)});if(_0x40f4bc['status']!==_0x2d5d40(0xfc))return _0x3b9b35[_0x2d5d40(0x147)](0x190)['json']({'success':![],'message':_0x2d5d40(0xfe)+_0x40f4bc['status']+',\x20cannot\x20process'});const _0x2b0bc9=await this[_0x2d5d40(0x12b)][_0x2d5d40(0x138)]({'paymentId':_0x40f4bc['id'],'orderId':_0x40f4bc[_0x2d5d40(0x12f)]||_0x40f4bc['id'],'amount':_0x40f4bc[_0x2d5d40(0x160)],'currency':_0x40f4bc[_0x2d5d40(0x135)],'cardData':_0xbcbb4b});console[_0x2d5d40(0x10b)](_0x2d5d40(0x15a),_0x2b0bc9);const _0x1fafa0={'status':_0x2b0bc9[_0x2d5d40(0x147)],'updatedAt':new Date()};if(_0x2b0bc9[_0x2d5d40(0x147)]===_0x2d5d40(0x101))_0x1fafa0[_0x2d5d40(0x11c)]=new Date(),_0x1fafa0[_0x2d5d40(0xfb)]=_0x2b0bc9[_0x2d5d40(0x12e)];else _0x2b0bc9[_0x2d5d40(0x147)]===_0x2d5d40(0x10a)&&(_0x1fafa0[_0x2d5d40(0x149)]=_0x2b0bc9[_0x2d5d40(0xf9)]);const _0x4ec63b=_0xbcbb4b[_0x2d5d40(0x15e)][_0x2d5d40(0x137)](/[\s-]/g,'');_0x1fafa0[_0x2d5d40(0x156)]=_0x4ec63b[_0x2d5d40(0x14e)](-0x4),_0x1fafa0[_0x2d5d40(0x126)]=_0x2d5d40(0x105),await database_1['default'][_0x2d5d40(0x145)][_0x2d5d40(0x139)]({'where':{'id':_0x40f4bc['id']},'data':_0x1fafa0}),await database_1[_0x2d5d40(0x120)][_0x2d5d40(0x158)]['create']({'data':{'paymentId':_0x40f4bc['id'],'shopId':_0x40f4bc[_0x2d5d40(0x159)],'event':'test_gateway_'+_0x2b0bc9[_0x2d5d40(0x147)][_0x2d5d40(0x108)](),'statusCode':0xc8,'responseBody':JSON[_0x2d5d40(0x136)]({'oldStatus':_0x2d5d40(0xfc),'newStatus':_0x2b0bc9[_0x2d5d40(0x147)],'transactionId':_0x2b0bc9['transactionId'],'failureReason':_0x2b0bc9[_0x2d5d40(0xf9)],'processedAt':new Date()[_0x2d5d40(0x154)]()})}}),await this['sendShopWebhook'](_0x40f4bc,_0x2b0bc9[_0x2d5d40(0x147)],_0x2b0bc9[_0x2d5d40(0x12e)],_0x2b0bc9[_0x2d5d40(0xf9)]),await this['sendPaymentStatusNotification'](_0x40f4bc,_0x2b0bc9[_0x2d5d40(0x147)]),console[_0x2d5d40(0x10b)](_0x2d5d40(0x128)+_0x40f657+'\x20processed:\x20'+_0x2b0bc9[_0x2d5d40(0x147)]),_0x2b0bc9[_0x2d5d40(0x147)]===_0x2d5d40(0x101)?_0x3b9b35[_0x2d5d40(0x124)]({'success':!![],'message':_0x2d5d40(0x13a),'result':{'status':'PAID','transactionId':_0x2b0bc9[_0x2d5d40(0x12e)],'redirectUrl':_0x40f4bc[_0x2d5d40(0x127)]}}):_0x3b9b35['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x2d5d40(0x10a),'failureReason':_0x2b0bc9[_0x2d5d40(0xf9)],'redirectUrl':_0x40f4bc['failUrl']}});}catch(_0x18042d){_0x2d7e86(_0x18042d);}},this['testGatewayService']=new testGatewayService_1[(_0x163285(0x141))](),this['webhookService']=new webhookService_1[(_0x163285(0x144))]();}async[a13_0x559202(0x14c)](_0x544a5c,_0x5b5f4d,_0x4130b3,_0xc38e0){const _0x4ccc17=a13_0x559202,_0xdfbca4=Date[_0x4ccc17(0x11f)]();try{const _0x5979f0=_0x544a5c[_0x4ccc17(0x11d)],_0x49876c=_0x5979f0[_0x4ccc17(0x121)];if(!_0x49876c?.[_0x4ccc17(0x119)]){console[_0x4ccc17(0x10b)](_0x4ccc17(0x13e)+_0x5979f0['id']);return;}const _0x1b9ea4=_0x5b5f4d===_0x4ccc17(0x101)?_0x4ccc17(0x162):_0x4ccc17(0x152);let _0x150a24=[];if(_0x49876c[_0x4ccc17(0x12c)])try{_0x150a24=Array['isArray'](_0x49876c['webhookEvents'])?_0x49876c[_0x4ccc17(0x12c)]:JSON[_0x4ccc17(0x14b)](_0x49876c['webhookEvents']);}catch(_0x414484){console['error']('Error\x20parsing\x20webhook\x20events:',_0x414484),_0x150a24=[];}if(!_0x150a24[_0x4ccc17(0x130)](_0x1b9ea4)){console[_0x4ccc17(0x10b)](_0x4ccc17(0x157)+_0x1b9ea4+_0x4ccc17(0x150)+_0x5979f0['id']);return;}const _0x244c47={'event':_0x1b9ea4,'payment':{'id':_0x544a5c['id'],'order_id':_0x544a5c['orderId'],'gateway_order_id':_0x544a5c[_0x4ccc17(0x12f)],'gateway':_0x4ccc17(0x112),'amount':_0x544a5c['amount'],'currency':_0x544a5c['currency'],'status':_0x5b5f4d[_0x4ccc17(0x108)](),'customer_email':_0x544a5c[_0x4ccc17(0x10d)],'customer_name':_0x544a5c[_0x4ccc17(0x104)],'transaction_id':_0x4130b3,'failure_message':_0xc38e0,'created_at':_0x544a5c[_0x4ccc17(0x143)],'updated_at':new Date()}},_0x444259=await fetch(_0x49876c['webhookUrl'],{'method':_0x4ccc17(0x15b),'headers':{'Content-Type':_0x4ccc17(0x132),'User-Agent':_0x4ccc17(0x148)},'body':JSON[_0x4ccc17(0x136)](_0x244c47)}),_0x42d822=Date['now']()-_0xdfbca4;console[_0x4ccc17(0x10b)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x49876c[_0x4ccc17(0x119)]+'\x20with\x20status\x20'+_0x444259[_0x4ccc17(0x147)]+'\x20('+_0x42d822+_0x4ccc17(0x146));}catch(_0x16fbae){console['error'](_0x4ccc17(0xfd),_0x16fbae);}}async[a13_0x559202(0x13d)](_0x4b5848,_0x581e59){const _0x44e306=a13_0x559202;try{const {telegramBotService:_0x2ab520}=await Promise[_0x44e306(0x117)]()['then'](()=>__importStar(require(_0x44e306(0x134)))),_0x4c99af={'PAID':_0x44e306(0x125),'FAILED':_0x44e306(0x13c)},_0x3e742b=_0x4c99af[_0x581e59];if(!_0x3e742b)return;await _0x2ab520[_0x44e306(0xf8)](_0x4b5848[_0x44e306(0x159)],_0x4b5848,_0x3e742b);}catch(_0xcd59b0){console[_0x44e306(0x142)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xcd59b0);}}}exports[a13_0x559202(0x12d)]=TestGatewayController;