'use strict';const a13_0x55a824=a13_0x1a1f;(function(_0xb79446,_0x16e970){const _0x247205=a13_0x1a1f,_0x41e06d=_0xb79446();while(!![]){try{const _0x2e6d43=-parseInt(_0x247205(0x9e))/0x1*(-parseInt(_0x247205(0xc3))/0x2)+-parseInt(_0x247205(0xa3))/0x3+parseInt(_0x247205(0x87))/0x4+-parseInt(_0x247205(0x9a))/0x5*(-parseInt(_0x247205(0xe5))/0x6)+-parseInt(_0x247205(0xe1))/0x7+-parseInt(_0x247205(0x9f))/0x8*(parseInt(_0x247205(0xd6))/0x9)+-parseInt(_0x247205(0x8b))/0xa;if(_0x2e6d43===_0x16e970)break;else _0x41e06d['push'](_0x41e06d['shift']());}catch(_0x2cce8c){_0x41e06d['push'](_0x41e06d['shift']());}}}(a13_0x2422,0x84fbb));var __createBinding=this&&this[a13_0x55a824(0xd5)]||(Object[a13_0x55a824(0xcc)]?function(_0x3e2fbc,_0x42ea88,_0x8764c9,_0x559780){const _0x58a305=a13_0x55a824;if(_0x559780===undefined)_0x559780=_0x8764c9;var _0x1c0107=Object[_0x58a305(0xa0)](_0x42ea88,_0x8764c9);(!_0x1c0107||(_0x58a305(0xbd)in _0x1c0107?!_0x42ea88['__esModule']:_0x1c0107[_0x58a305(0x90)]||_0x1c0107[_0x58a305(0x99)]))&&(_0x1c0107={'enumerable':!![],'get':function(){return _0x42ea88[_0x8764c9];}}),Object[_0x58a305(0xcd)](_0x3e2fbc,_0x559780,_0x1c0107);}:function(_0x4a679f,_0x4c0a48,_0x69506d,_0x5c0d5a){if(_0x5c0d5a===undefined)_0x5c0d5a=_0x69506d;_0x4a679f[_0x5c0d5a]=_0x4c0a48[_0x69506d];}),__setModuleDefault=this&&this[a13_0x55a824(0x94)]||(Object[a13_0x55a824(0xcc)]?function(_0x1382a9,_0xc85bf6){const _0x3fd181=a13_0x55a824;Object[_0x3fd181(0xcd)](_0x1382a9,'default',{'enumerable':!![],'value':_0xc85bf6});}:function(_0x287ddd,_0x4f8ef5){_0x287ddd['default']=_0x4f8ef5;}),__importStar=this&&this[a13_0x55a824(0xb9)]||(function(){var _0x27efa8=function(_0x1ba1a0){const _0x163bc6=a13_0x1a1f;return _0x27efa8=Object[_0x163bc6(0xd9)]||function(_0x558f7b){var _0x83f3d8=[];for(var _0x426420 in _0x558f7b)if(Object['prototype']['hasOwnProperty']['call'](_0x558f7b,_0x426420))_0x83f3d8[_0x83f3d8['length']]=_0x426420;return _0x83f3d8;},_0x27efa8(_0x1ba1a0);};return function(_0xefbdba){const _0x20598c=a13_0x1a1f;if(_0xefbdba&&_0xefbdba[_0x20598c(0x9c)])return _0xefbdba;var _0x59bc3c={};if(_0xefbdba!=null){for(var _0x47194e=_0x27efa8(_0xefbdba),_0xfbdb1b=0x0;_0xfbdb1b<_0x47194e[_0x20598c(0x97)];_0xfbdb1b++)if(_0x47194e[_0xfbdb1b]!==_0x20598c(0xdc))__createBinding(_0x59bc3c,_0xefbdba,_0x47194e[_0xfbdb1b]);}return __setModuleDefault(_0x59bc3c,_0xefbdba),_0x59bc3c;};}()),__importDefault=this&&this[a13_0x55a824(0xe6)]||function(_0x44ca44){const _0x126645=a13_0x55a824;return _0x44ca44&&_0x44ca44[_0x126645(0x9c)]?_0x44ca44:{'default':_0x44ca44};};Object[a13_0x55a824(0xcd)](exports,a13_0x55a824(0x9c),{'value':!![]}),exports[a13_0x55a824(0xa2)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x55a824(0xbe)),database_1=__importDefault(require(a13_0x55a824(0xa6)));function a13_0x1a1f(_0x41d5f7,_0x2ab641){const _0x242259=a13_0x2422();return a13_0x1a1f=function(_0x1a1ff7,_0x3feadb){_0x1a1ff7=_0x1a1ff7-0x87;let _0x42ec1c=_0x242259[_0x1a1ff7];return _0x42ec1c;},a13_0x1a1f(_0x41d5f7,_0x2ab641);}class TestGatewayController{constructor(){const _0xef615b=a13_0x55a824;this[_0xef615b(0x8f)]=async(_0xfca257,_0x48eb47,_0x2c5719)=>{const _0xe1dd8e=_0xef615b;try{const {paymentId:_0x17371e}=_0xfca257[_0xe1dd8e(0xe9)];console[_0xe1dd8e(0xc1)](_0xe1dd8e(0xd8)+_0x17371e);const _0xb84aa4=await database_1['default'][_0xe1dd8e(0x92)][_0xe1dd8e(0xb0)]({'where':{'id':_0x17371e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xb84aa4)return _0x48eb47[_0xe1dd8e(0x8c)](0x194)[_0xe1dd8e(0x95)]({'success':![],'message':_0xe1dd8e(0xd1)});if(_0xb84aa4[_0xe1dd8e(0xe4)]!=='test_gateway')return _0x48eb47[_0xe1dd8e(0x8c)](0x190)['json']({'success':![],'message':_0xe1dd8e(0xd2)});if(_0xb84aa4['status']!=='PENDING')return _0x48eb47[_0xe1dd8e(0x8c)](0x190)['json']({'success':![],'message':_0xe1dd8e(0xc9)+_0xb84aa4['status']+_0xe1dd8e(0xc6)});_0x48eb47[_0xe1dd8e(0x95)]({'success':!![],'result':{'paymentId':_0xb84aa4['id'],'orderId':_0xb84aa4[_0xe1dd8e(0xde)],'amount':_0xb84aa4['amount'],'currency':_0xb84aa4[_0xe1dd8e(0xb3)],'merchantName':_0xb84aa4[_0xe1dd8e(0xc7)][_0xe1dd8e(0xba)],'description':_0xe1dd8e(0x8d)+_0xb84aa4['shop'][_0xe1dd8e(0xba)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0xe1dd8e(0xc8),'expiryDate':_0xe1dd8e(0xe8),'cvc':_0xe1dd8e(0xe7),'holderName':'Any\x20name'}}});}catch(_0x20cbcd){_0x2c5719(_0x20cbcd);}},this[_0xef615b(0xe3)]=async(_0x506ace,_0x500bfd,_0x58b99a)=>{const _0x2b5b73=_0xef615b;try{const {paymentId:_0x13997f}=_0x506ace[_0x2b5b73(0xe9)],_0x4c09be=_0x506ace[_0x2b5b73(0xb1)];console[_0x2b5b73(0xc1)](_0x2b5b73(0xbb)+_0x13997f);const _0x716971=await database_1['default'][_0x2b5b73(0x92)][_0x2b5b73(0xb0)]({'where':{'id':_0x13997f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x716971)return _0x500bfd['status'](0x194)[_0x2b5b73(0x95)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x716971[_0x2b5b73(0xe4)]!==_0x2b5b73(0x9b))return _0x500bfd[_0x2b5b73(0x8c)](0x190)[_0x2b5b73(0x95)]({'success':![],'message':_0x2b5b73(0xd2)});if(_0x716971[_0x2b5b73(0x8c)]!==_0x2b5b73(0xc5))return _0x500bfd['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x716971[_0x2b5b73(0x8c)]+',\x20cannot\x20process'});const _0x58944e=await this[_0x2b5b73(0xdf)][_0x2b5b73(0xaf)]({'paymentId':_0x716971['id'],'orderId':_0x716971['gatewayOrderId']||_0x716971['id'],'amount':_0x716971[_0x2b5b73(0x8e)],'currency':_0x716971[_0x2b5b73(0xb3)],'cardData':_0x4c09be});console[_0x2b5b73(0xc1)](_0x2b5b73(0xe2),_0x58944e);const _0x35ad13={'status':_0x58944e['status'],'updatedAt':new Date()};if(_0x58944e[_0x2b5b73(0x8c)]===_0x2b5b73(0xbc))_0x35ad13[_0x2b5b73(0xa7)]=new Date(),_0x35ad13['gatewayPaymentId']=_0x58944e[_0x2b5b73(0xed)];else _0x58944e[_0x2b5b73(0x8c)]===_0x2b5b73(0xae)&&(_0x35ad13[_0x2b5b73(0xab)]=_0x58944e[_0x2b5b73(0xe0)]);const _0xfb2512=_0x4c09be[_0x2b5b73(0xef)][_0x2b5b73(0xb7)](/[\s-]/g,'');_0x35ad13[_0x2b5b73(0xda)]=_0xfb2512[_0x2b5b73(0xc2)](-0x4),_0x35ad13[_0x2b5b73(0x89)]='test_card',await database_1['default'][_0x2b5b73(0x92)][_0x2b5b73(0xb6)]({'where':{'id':_0x716971['id']},'data':_0x35ad13}),await database_1['default'][_0x2b5b73(0x8a)]['create']({'data':{'paymentId':_0x716971['id'],'shopId':_0x716971[_0x2b5b73(0xdd)],'event':_0x2b5b73(0xd4)+_0x58944e[_0x2b5b73(0x8c)][_0x2b5b73(0x9d)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x58944e[_0x2b5b73(0x8c)],'transactionId':_0x58944e[_0x2b5b73(0xed)],'failureReason':_0x58944e[_0x2b5b73(0xe0)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x716971,_0x58944e[_0x2b5b73(0x8c)],_0x58944e['transactionId'],_0x58944e['failureReason']),await this[_0x2b5b73(0xce)](_0x716971,_0x58944e[_0x2b5b73(0x8c)]),console[_0x2b5b73(0xc1)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x13997f+_0x2b5b73(0xee)+_0x58944e[_0x2b5b73(0x8c)]),_0x58944e[_0x2b5b73(0x8c)]==='PAID'?_0x500bfd[_0x2b5b73(0x95)]({'success':!![],'message':_0x2b5b73(0xca),'result':{'status':_0x2b5b73(0xbc),'transactionId':_0x58944e[_0x2b5b73(0xed)],'redirectUrl':_0x716971[_0x2b5b73(0xa9)]}}):_0x500bfd[_0x2b5b73(0x8c)](0x190)[_0x2b5b73(0x95)]({'success':![],'message':_0x2b5b73(0xb2),'result':{'status':_0x2b5b73(0xae),'failureReason':_0x58944e[_0x2b5b73(0xe0)],'redirectUrl':_0x716971[_0x2b5b73(0xa1)]}});}catch(_0x1adb5d){_0x58b99a(_0x1adb5d);}},this[_0xef615b(0xdf)]=new testGatewayService_1[(_0xef615b(0xa8))](),this[_0xef615b(0xad)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x494f6e,_0x4c8d1c,_0x41609f,_0x2f7a34){const _0x2ad136=a13_0x55a824,_0x1f11cb=Date[_0x2ad136(0xeb)]();try{const _0x43bd66=_0x494f6e['shop'],_0x3c82d6=_0x43bd66[_0x2ad136(0xb8)];if(!_0x3c82d6?.[_0x2ad136(0xcb)]){console[_0x2ad136(0xc1)](_0x2ad136(0x88)+_0x43bd66['id']);return;}const _0x36b77e=_0x4c8d1c===_0x2ad136(0xbc)?'payment.success':_0x2ad136(0xb4);let _0x257309=[];if(_0x3c82d6[_0x2ad136(0xbf)])try{_0x257309=Array[_0x2ad136(0xec)](_0x3c82d6['webhookEvents'])?_0x3c82d6[_0x2ad136(0xbf)]:JSON[_0x2ad136(0xd0)](_0x3c82d6['webhookEvents']);}catch(_0x4f817b){console[_0x2ad136(0xd7)](_0x2ad136(0xcf),_0x4f817b),_0x257309=[];}if(!_0x257309[_0x2ad136(0xac)](_0x36b77e)){console[_0x2ad136(0xc1)](_0x2ad136(0x96)+_0x36b77e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x43bd66['id']);return;}const _0x27effd={'event':_0x36b77e,'payment':{'id':_0x494f6e['id'],'order_id':_0x494f6e['orderId'],'gateway_order_id':_0x494f6e[_0x2ad136(0xde)],'gateway':_0x2ad136(0xa5),'amount':_0x494f6e[_0x2ad136(0x8e)],'currency':_0x494f6e[_0x2ad136(0xb3)],'status':_0x4c8d1c['toLowerCase'](),'customer_email':_0x494f6e[_0x2ad136(0xea)],'customer_name':_0x494f6e['customerName'],'transaction_id':_0x41609f,'failure_message':_0x2f7a34,'created_at':_0x494f6e[_0x2ad136(0x98)],'updated_at':new Date()}},_0x5c3781=await fetch(_0x3c82d6[_0x2ad136(0xcb)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x2ad136(0x91)},'body':JSON[_0x2ad136(0xc0)](_0x27effd)}),_0x39679b=Date[_0x2ad136(0xeb)]()-_0x1f11cb;console[_0x2ad136(0xc1)](_0x2ad136(0xb5)+_0x3c82d6[_0x2ad136(0xcb)]+'\x20with\x20status\x20'+_0x5c3781[_0x2ad136(0x8c)]+'\x20('+_0x39679b+'ms)');}catch(_0x556d38){console[_0x2ad136(0xd7)](_0x2ad136(0xc4),_0x556d38);}}async['sendPaymentStatusNotification'](_0x9383ab,_0x38fd76){const _0x245385=a13_0x55a824;try{const {telegramBotService:_0x24cb30}=await Promise[_0x245385(0xd3)]()[_0x245385(0xa4)](()=>__importStar(require('../services/telegramBotService'))),_0xaf92fe={'PAID':_0x245385(0x93),'FAILED':'failed'},_0x570fbb=_0xaf92fe[_0x38fd76];if(!_0x570fbb)return;await _0x24cb30[_0x245385(0xdb)](_0x9383ab[_0x245385(0xdd)],_0x9383ab,_0x570fbb);}catch(_0x7cc24b){console[_0x245385(0xd7)](_0x245385(0xaa),_0x7cc24b);}}}exports[a13_0x55a824(0xa2)]=TestGatewayController;function a13_0x2422(){const _0x4a7f9a=['Any\x203-4\x20digits','Any\x20future\x20date\x20(MM/YY)','params','customerEmail','now','isArray','transactionId','\x20processed:\x20','cardNumber','4097520dkmuEc','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentMethod','webhookLog','3130340bWyAMa','status','Payment\x20to\x20','amount','getPaymentForm','writable','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','payment','paid','__setModuleDefault','json','Webhook\x20event\x20','length','createdAt','configurable','35WRSzuG','test_gateway','__esModule','toLowerCase','7ADQjEd','1609840MVMhcT','getOwnPropertyDescriptor','failUrl','TestGatewayController','1232406zBfywY','then','0000','../config/database','paidAt','TestGatewayService','successUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','failureMessage','includes','webhookService','FAILED','processCardPayment','findUnique','body','Payment\x20failed','currency','payment.failed','Test\x20Gateway\x20webhook\x20sent\x20to\x20','update','replace','settings','__importStar','name','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','PAID','get','../services/webhookService','webhookEvents','stringify','log','slice','31226sLgIeY','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','PENDING',',\x20cannot\x20process','shop','Any\x20other\x20card\x20number','Payment\x20status\x20is\x20','Payment\x20processed\x20successfully','webhookUrl','create','defineProperty','sendPaymentStatusNotification','Error\x20parsing\x20webhook\x20events:','parse','Payment\x20not\x20found','Payment\x20is\x20not\x20for\x20test\x20gateway','resolve','test_gateway_','__createBinding','9AZBJDU','error','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','getOwnPropertyNames','cardLast4','sendPaymentNotification','default','shopId','gatewayOrderId','testGatewayService','failureReason','2867851nFXLES','ðŸ§ª\x20Test\x20Gateway\x20result:','processCard','gateway','639246nIDuOR','__importDefault'];a13_0x2422=function(){return _0x4a7f9a;};return a13_0x2422();}