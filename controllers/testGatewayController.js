'use strict';const a13_0x495c81=a13_0x5396;(function(_0x341128,_0x3a8208){const _0x508989=a13_0x5396,_0x1a8acb=_0x341128();while(!![]){try{const _0x1112b0=-parseInt(_0x508989(0x192))/0x1*(-parseInt(_0x508989(0x19c))/0x2)+-parseInt(_0x508989(0x1a5))/0x3+parseInt(_0x508989(0x18a))/0x4+-parseInt(_0x508989(0x1c0))/0x5+parseInt(_0x508989(0x1ba))/0x6+-parseInt(_0x508989(0x1b5))/0x7+parseInt(_0x508989(0x15b))/0x8*(parseInt(_0x508989(0x1a2))/0x9);if(_0x1112b0===_0x3a8208)break;else _0x1a8acb['push'](_0x1a8acb['shift']());}catch(_0x10440b){_0x1a8acb['push'](_0x1a8acb['shift']());}}}(a13_0x317f,0x90805));function a13_0x317f(){const _0x1104fa=['PENDING','gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','body','hasOwnProperty','\x20not\x20enabled\x20for\x20shop\x20','shopId','../services/webhookService','get','update','__esModule','json','Webhook\x20event\x20','paid','processCardPayment','5885033NhvhOd','failureMessage','getOwnPropertyNames','call','includes','1611216qEJXPW','getOwnPropertyDescriptor','log','Error\x20parsing\x20webhook\x20events:','__importDefault','payment','3860705NSsDjd','cardLast4','application/json','failed','Any\x203-4\x20digits','Payment\x20to\x20','transactionId','18404216JoNbcr','create','Payment\x20is\x20not\x20for\x20test\x20gateway','findUnique','webhookEvents','FAILED','Test\x20Gateway\x20webhook\x20sent\x20to\x20','customerEmail','replace','configurable','getPaymentForm','cardNumber','PAID','Any\x20future\x20date\x20(MM/YY)','../services/telegramBotService','test_gateway_','default','webhookUrl','orderId','Payment\x20processed\x20successfully','WebhookService','processCard','status','ms)','toLowerCase','paidAt','stringify',',\x20cannot\x20process','defineProperty','then','webhookService','writable','Any\x20other\x20card\x20number','__setModuleDefault','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','testGatewayService','toISOString','sendShopWebhook','currency','now','4242\x204242\x204242\x204242','âœ…\x20Test\x20Gateway\x20payment\x20','createdAt','parse','params','payment.success','gatewayPaymentId','2865780zLwWUg','isArray','\x20processed:\x20','name','Payment\x20failed','gatewayOrderId','length','test_card','5NRplQX','Any\x20name','ðŸ§ª\x20Test\x20Gateway\x20result:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TestGatewayController','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20with\x20status\x20','failureReason','amount','sendPaymentStatusNotification','1802xosyqM','test_gateway','0000','Payment\x20not\x20found','shop','error','9zEfkbE','prototype','resolve','3255828rKiAmN'];a13_0x317f=function(){return _0x1104fa;};return a13_0x317f();}var __createBinding=this&&this['__createBinding']||(Object[a13_0x495c81(0x15c)]?function(_0x174ec8,_0x2d35e7,_0x599420,_0x1413b0){const _0x1bad9e=a13_0x495c81;if(_0x1413b0===undefined)_0x1413b0=_0x599420;var _0xf9f59b=Object[_0x1bad9e(0x1bb)](_0x2d35e7,_0x599420);(!_0xf9f59b||(_0x1bad9e(0x1ae)in _0xf9f59b?!_0x2d35e7[_0x1bad9e(0x1b0)]:_0xf9f59b[_0x1bad9e(0x17a)]||_0xf9f59b[_0x1bad9e(0x164)]))&&(_0xf9f59b={'enumerable':!![],'get':function(){return _0x2d35e7[_0x599420];}}),Object[_0x1bad9e(0x177)](_0x174ec8,_0x1413b0,_0xf9f59b);}:function(_0x4d0619,_0x401579,_0x4f982d,_0x9e063){if(_0x9e063===undefined)_0x9e063=_0x4f982d;_0x4d0619[_0x9e063]=_0x401579[_0x4f982d];}),__setModuleDefault=this&&this[a13_0x495c81(0x17c)]||(Object['create']?function(_0x4b4f22,_0x1e5008){const _0x10cf89=a13_0x495c81;Object[_0x10cf89(0x177)](_0x4b4f22,_0x10cf89(0x16b),{'enumerable':!![],'value':_0x1e5008});}:function(_0x28cb4e,_0x2c3b7b){_0x28cb4e['default']=_0x2c3b7b;}),__importStar=this&&this['__importStar']||(function(){var _0x492f9a=function(_0xa2c060){const _0x577d99=a13_0x5396;return _0x492f9a=Object[_0x577d99(0x1b7)]||function(_0x5d2a89){const _0x463fd6=_0x577d99;var _0x114468=[];for(var _0x2c0488 in _0x5d2a89)if(Object[_0x463fd6(0x1a3)][_0x463fd6(0x1aa)][_0x463fd6(0x1b8)](_0x5d2a89,_0x2c0488))_0x114468[_0x114468[_0x463fd6(0x190)]]=_0x2c0488;return _0x114468;},_0x492f9a(_0xa2c060);};return function(_0x5bd5e6){const _0x259155=a13_0x5396;if(_0x5bd5e6&&_0x5bd5e6[_0x259155(0x1b0)])return _0x5bd5e6;var _0x368a15={};if(_0x5bd5e6!=null){for(var _0x219da5=_0x492f9a(_0x5bd5e6),_0x2fca57=0x0;_0x2fca57<_0x219da5[_0x259155(0x190)];_0x2fca57++)if(_0x219da5[_0x2fca57]!==_0x259155(0x16b))__createBinding(_0x368a15,_0x5bd5e6,_0x219da5[_0x2fca57]);}return __setModuleDefault(_0x368a15,_0x5bd5e6),_0x368a15;};}()),__importDefault=this&&this[a13_0x495c81(0x1be)]||function(_0x3dafd8){const _0x5d4ed2=a13_0x495c81;return _0x3dafd8&&_0x3dafd8[_0x5d4ed2(0x1b0)]?_0x3dafd8:{'default':_0x3dafd8};};Object[a13_0x495c81(0x177)](exports,'__esModule',{'value':!![]}),exports[a13_0x495c81(0x196)]=void 0x0;function a13_0x5396(_0x57bc14,_0xdc7243){const _0x317fd6=a13_0x317f();return a13_0x5396=function(_0x5396a8,_0x58d3d1){_0x5396a8=_0x5396a8-0x15b;let _0x4bbde3=_0x317fd6[_0x5396a8];return _0x4bbde3;},a13_0x5396(_0x57bc14,_0xdc7243);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x495c81(0x1ad)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x13b03c=a13_0x495c81;this[_0x13b03c(0x165)]=async(_0x1214b3,_0x305bd3,_0x2a00fc)=>{const _0x102ac4=_0x13b03c;try{const {paymentId:_0xd804ce}=_0x1214b3['params'];console[_0x102ac4(0x1bc)](_0x102ac4(0x17d)+_0xd804ce);const _0x157a8a=await database_1[_0x102ac4(0x16b)][_0x102ac4(0x1bf)][_0x102ac4(0x15e)]({'where':{'id':_0xd804ce},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x157a8a)return _0x305bd3[_0x102ac4(0x171)](0x194)[_0x102ac4(0x1b1)]({'success':![],'message':_0x102ac4(0x19f)});if(_0x157a8a[_0x102ac4(0x1a7)]!==_0x102ac4(0x19d))return _0x305bd3['status'](0x190)[_0x102ac4(0x1b1)]({'success':![],'message':_0x102ac4(0x15d)});if(_0x157a8a[_0x102ac4(0x171)]!==_0x102ac4(0x1a6))return _0x305bd3['status'](0x190)[_0x102ac4(0x1b1)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x157a8a[_0x102ac4(0x171)]+_0x102ac4(0x176)});_0x305bd3[_0x102ac4(0x1b1)]({'success':!![],'result':{'paymentId':_0x157a8a['id'],'orderId':_0x157a8a['gatewayOrderId'],'amount':_0x157a8a[_0x102ac4(0x19a)],'currency':_0x157a8a['currency'],'merchantName':_0x157a8a['shop'][_0x102ac4(0x18d)],'description':_0x102ac4(0x1c5)+_0x157a8a[_0x102ac4(0x1a0)][_0x102ac4(0x18d)],'testInstructions':{'successCard':_0x102ac4(0x183),'failureCard':_0x102ac4(0x17b),'expiryDate':_0x102ac4(0x168),'cvc':_0x102ac4(0x1c4),'holderName':_0x102ac4(0x193)}}});}catch(_0x5555df){_0x2a00fc(_0x5555df);}},this[_0x13b03c(0x170)]=async(_0x32ed8b,_0x2f6c8c,_0x40e725)=>{const _0x2aeb56=_0x13b03c;try{const {paymentId:_0x438223}=_0x32ed8b[_0x2aeb56(0x187)],_0x24f25e=_0x32ed8b[_0x2aeb56(0x1a9)];console[_0x2aeb56(0x1bc)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x438223);const _0x7eda92=await database_1[_0x2aeb56(0x16b)][_0x2aeb56(0x1bf)][_0x2aeb56(0x15e)]({'where':{'id':_0x438223},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x7eda92)return _0x2f6c8c['status'](0x194)[_0x2aeb56(0x1b1)]({'success':![],'message':_0x2aeb56(0x19f)});if(_0x7eda92['gateway']!==_0x2aeb56(0x19d))return _0x2f6c8c[_0x2aeb56(0x171)](0x190)['json']({'success':![],'message':_0x2aeb56(0x15d)});if(_0x7eda92['status']!==_0x2aeb56(0x1a6))return _0x2f6c8c['status'](0x190)[_0x2aeb56(0x1b1)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x7eda92['status']+',\x20cannot\x20process'});const _0x1746c6=await this[_0x2aeb56(0x17e)][_0x2aeb56(0x1b4)]({'paymentId':_0x7eda92['id'],'orderId':_0x7eda92['gatewayOrderId']||_0x7eda92['id'],'amount':_0x7eda92[_0x2aeb56(0x19a)],'currency':_0x7eda92[_0x2aeb56(0x181)],'cardData':_0x24f25e});console[_0x2aeb56(0x1bc)](_0x2aeb56(0x194),_0x1746c6);const _0x41ec03={'status':_0x1746c6['status'],'updatedAt':new Date()};if(_0x1746c6[_0x2aeb56(0x171)]===_0x2aeb56(0x167))_0x41ec03[_0x2aeb56(0x174)]=new Date(),_0x41ec03[_0x2aeb56(0x189)]=_0x1746c6[_0x2aeb56(0x1c6)];else _0x1746c6['status']===_0x2aeb56(0x160)&&(_0x41ec03[_0x2aeb56(0x1b6)]=_0x1746c6[_0x2aeb56(0x199)]);const _0x43eb8d=_0x24f25e[_0x2aeb56(0x166)][_0x2aeb56(0x163)](/[\s-]/g,'');_0x41ec03[_0x2aeb56(0x1c1)]=_0x43eb8d['slice'](-0x4),_0x41ec03['paymentMethod']=_0x2aeb56(0x191),await database_1['default']['payment'][_0x2aeb56(0x1af)]({'where':{'id':_0x7eda92['id']},'data':_0x41ec03}),await database_1[_0x2aeb56(0x16b)]['webhookLog']['create']({'data':{'paymentId':_0x7eda92['id'],'shopId':_0x7eda92[_0x2aeb56(0x1ac)],'event':_0x2aeb56(0x16a)+_0x1746c6['status'][_0x2aeb56(0x173)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2aeb56(0x1a6),'newStatus':_0x1746c6[_0x2aeb56(0x171)],'transactionId':_0x1746c6[_0x2aeb56(0x1c6)],'failureReason':_0x1746c6[_0x2aeb56(0x199)],'processedAt':new Date()[_0x2aeb56(0x17f)]()})}}),await this[_0x2aeb56(0x180)](_0x7eda92,_0x1746c6[_0x2aeb56(0x171)],_0x1746c6[_0x2aeb56(0x1c6)],_0x1746c6[_0x2aeb56(0x199)]),await this[_0x2aeb56(0x19b)](_0x7eda92,_0x1746c6['status']),console[_0x2aeb56(0x1bc)](_0x2aeb56(0x184)+_0x438223+_0x2aeb56(0x18c)+_0x1746c6[_0x2aeb56(0x171)]),_0x1746c6[_0x2aeb56(0x171)]===_0x2aeb56(0x167)?_0x2f6c8c[_0x2aeb56(0x1b1)]({'success':!![],'message':_0x2aeb56(0x16e),'result':{'status':'PAID','transactionId':_0x1746c6[_0x2aeb56(0x1c6)],'redirectUrl':_0x7eda92['successUrl']}}):_0x2f6c8c[_0x2aeb56(0x171)](0x190)['json']({'success':![],'message':_0x2aeb56(0x18e),'result':{'status':_0x2aeb56(0x160),'failureReason':_0x1746c6[_0x2aeb56(0x199)],'redirectUrl':_0x7eda92['failUrl']}});}catch(_0x115b56){_0x40e725(_0x115b56);}},this[_0x13b03c(0x17e)]=new testGatewayService_1['TestGatewayService'](),this[_0x13b03c(0x179)]=new webhookService_1[(_0x13b03c(0x16f))]();}async['sendShopWebhook'](_0x395e10,_0x2313ed,_0x135ed9,_0x560bdc){const _0x4862ce=a13_0x495c81,_0x48c139=Date['now']();try{const _0x27a057=_0x395e10['shop'],_0x4cba47=_0x27a057['settings'];if(!_0x4cba47?.[_0x4862ce(0x16c)]){console[_0x4862ce(0x1bc)](_0x4862ce(0x1a8)+_0x27a057['id']);return;}const _0x438b9b=_0x2313ed===_0x4862ce(0x167)?_0x4862ce(0x188):'payment.failed';let _0x30de9a=[];if(_0x4cba47['webhookEvents'])try{_0x30de9a=Array[_0x4862ce(0x18b)](_0x4cba47['webhookEvents'])?_0x4cba47[_0x4862ce(0x15f)]:JSON[_0x4862ce(0x186)](_0x4cba47[_0x4862ce(0x15f)]);}catch(_0x5dbf21){console['error'](_0x4862ce(0x1bd),_0x5dbf21),_0x30de9a=[];}if(!_0x30de9a[_0x4862ce(0x1b9)](_0x438b9b)){console[_0x4862ce(0x1bc)](_0x4862ce(0x1b2)+_0x438b9b+_0x4862ce(0x1ab)+_0x27a057['id']);return;}const _0x59d39b={'event':_0x438b9b,'payment':{'id':_0x395e10['id'],'order_id':_0x395e10[_0x4862ce(0x16d)],'gateway_order_id':_0x395e10[_0x4862ce(0x18f)],'gateway':_0x4862ce(0x19e),'amount':_0x395e10[_0x4862ce(0x19a)],'currency':_0x395e10[_0x4862ce(0x181)],'status':_0x2313ed[_0x4862ce(0x173)](),'customer_email':_0x395e10[_0x4862ce(0x162)],'customer_name':_0x395e10['customerName'],'transaction_id':_0x135ed9,'failure_message':_0x560bdc,'created_at':_0x395e10[_0x4862ce(0x185)],'updated_at':new Date()}},_0x8b7afa=await fetch(_0x4cba47['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x4862ce(0x1c2),'User-Agent':_0x4862ce(0x197)},'body':JSON[_0x4862ce(0x175)](_0x59d39b)}),_0x499254=Date[_0x4862ce(0x182)]()-_0x48c139;console[_0x4862ce(0x1bc)](_0x4862ce(0x161)+_0x4cba47['webhookUrl']+_0x4862ce(0x198)+_0x8b7afa[_0x4862ce(0x171)]+'\x20('+_0x499254+_0x4862ce(0x172));}catch(_0x17703f){console[_0x4862ce(0x1a1)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x17703f);}}async[a13_0x495c81(0x19b)](_0x168935,_0x3795da){const _0x4fd432=a13_0x495c81;try{const {telegramBotService:_0xb91afd}=await Promise[_0x4fd432(0x1a4)]()[_0x4fd432(0x178)](()=>__importStar(require(_0x4fd432(0x169)))),_0xea1496={'PAID':_0x4fd432(0x1b3),'FAILED':_0x4fd432(0x1c3)},_0x10bfd4=_0xea1496[_0x3795da];if(!_0x10bfd4)return;await _0xb91afd['sendPaymentNotification'](_0x168935['shopId'],_0x168935,_0x10bfd4);}catch(_0x3dc953){console[_0x4fd432(0x1a1)](_0x4fd432(0x195),_0x3dc953);}}}exports[a13_0x495c81(0x196)]=TestGatewayController;