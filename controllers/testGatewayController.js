'use strict';const a15_0x556db7=a15_0x13d9;function a15_0x5a21(){const _0x28c243=['2720eerEUG','body','Payment\x20not\x20found','error','type','update','Payment\x20failed','stringify','0000','includes','status','json','log',':\x20type=','4242\x204242\x204242\x204242','configurable','SINGLE','PAID','settings','now','cardNumber','PENDING','failureReason','currentPayments','gatewayOrderId','create','sendPaymentStatusNotification','parse','Payment\x20status\x20is\x20','toISOString','\x20not\x20found','__createBinding','../services/webhookService','gateway','🧪\x20Test\x20Gateway\x20result:','shop','length','application/json','Error\x20parsing\x20webhook\x20events:','../config/database','Any\x20other\x20card\x20number','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','call','Payment\x20to\x20','../services/telegramBotService','payment.success','replace','POST','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','4174029WHkLGM','resolve','❌\x20Payment\x20link\x20',',\x20status=','webhookService','paidAt','Webhook\x20event\x20','sendPaymentNotification','\x20processed:\x20','amount','23yDjbuo',',\x20cannot\x20process','failUrl','writable','16874oZYUFC','6899912RGFkew','__importDefault','paymentLink','5567793CIQXrp','17303230CZUCII','webhookLog','\x20not\x20enabled\x20for\x20shop\x20','slice','payment.failed','sendShopWebhook','successUrl','customerName','TestGatewayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currency','params','webhookEvents','Any\x20name','default','Payment\x20System/1.0\x20(Test\x20Gateway)','paid','processCard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentLinkId','Payment\x20is\x20not\x20for\x20test\x20gateway','1608cUAomo','getOwnPropertyDescriptor','prototype','toLowerCase','FAILED','webhookUrl','\x20updated:\x20currentPayments=','__importStar','payment','\x20->\x20','transactionId','✅\x20Test\x20Gateway\x20payment\x20','TestGatewayController','orderId','defineProperty','testGatewayService','__setModuleDefault','name','findUnique','shopId',',\x20currentPayments=','test_gateway','__esModule','customerEmail','131151MVEdyU','📈\x20Test\x20Gateway:\x20Payment\x20','12oUttlH','processCardPayment','failureMessage'];a15_0x5a21=function(){return _0x28c243;};return a15_0x5a21();}(function(_0x54e73c,_0x419979){const _0x2891c2=a15_0x13d9,_0x12684f=_0x54e73c();while(!![]){try{const _0x3fbbac=-parseInt(_0x2891c2(0x164))/0x1*(-parseInt(_0x2891c2(0xf2))/0x2)+parseInt(_0x2891c2(0x124))/0x3*(-parseInt(_0x2891c2(0x126))/0x4)+-parseInt(_0x2891c2(0x129))/0x5*(parseInt(_0x2891c2(0x10c))/0x6)+-parseInt(_0x2891c2(0xf6))/0x7+-parseInt(_0x2891c2(0xf3))/0x8+parseInt(_0x2891c2(0x15a))/0x9+parseInt(_0x2891c2(0xf7))/0xa;if(_0x3fbbac===_0x419979)break;else _0x12684f['push'](_0x12684f['shift']());}catch(_0x2cb35b){_0x12684f['push'](_0x12684f['shift']());}}}(a15_0x5a21,0x6eacc));function a15_0x13d9(_0x222bf5,_0x3314b3){const _0x5a21f1=a15_0x5a21();return a15_0x13d9=function(_0x13d969,_0x58a8af){_0x13d969=_0x13d969-0xf2;let _0x4b9de5=_0x5a21f1[_0x13d969];return _0x4b9de5;},a15_0x13d9(_0x222bf5,_0x3314b3);}var __createBinding=this&&this[a15_0x556db7(0x148)]||(Object[a15_0x556db7(0x142)]?function(_0x44ea83,_0x385b28,_0x57df61,_0x424393){const _0x6dd6e9=a15_0x556db7;if(_0x424393===undefined)_0x424393=_0x57df61;var _0xeaf85f=Object[_0x6dd6e9(0x10d)](_0x385b28,_0x57df61);(!_0xeaf85f||('get'in _0xeaf85f?!_0x385b28[_0x6dd6e9(0x122)]:_0xeaf85f[_0x6dd6e9(0x167)]||_0xeaf85f[_0x6dd6e9(0x138)]))&&(_0xeaf85f={'enumerable':!![],'get':function(){return _0x385b28[_0x57df61];}}),Object[_0x6dd6e9(0x11a)](_0x44ea83,_0x424393,_0xeaf85f);}:function(_0x210615,_0x1d28b2,_0x3d4525,_0x304dd7){if(_0x304dd7===undefined)_0x304dd7=_0x3d4525;_0x210615[_0x304dd7]=_0x1d28b2[_0x3d4525];}),__setModuleDefault=this&&this[a15_0x556db7(0x11c)]||(Object['create']?function(_0x406aea,_0x5c52b7){const _0x5082ef=a15_0x556db7;Object[_0x5082ef(0x11a)](_0x406aea,_0x5082ef(0x105),{'enumerable':!![],'value':_0x5c52b7});}:function(_0x5117bc,_0x1abc03){const _0x12f996=a15_0x556db7;_0x5117bc[_0x12f996(0x105)]=_0x1abc03;}),__importStar=this&&this[a15_0x556db7(0x113)]||(function(){var _0x186d28=function(_0x3df436){return _0x186d28=Object['getOwnPropertyNames']||function(_0xa11bb){const _0x1672cc=a15_0x13d9;var _0x542cf2=[];for(var _0x17769d in _0xa11bb)if(Object[_0x1672cc(0x10e)]['hasOwnProperty'][_0x1672cc(0x153)](_0xa11bb,_0x17769d))_0x542cf2[_0x542cf2[_0x1672cc(0x14d)]]=_0x17769d;return _0x542cf2;},_0x186d28(_0x3df436);};return function(_0x10d6f1){const _0xfd3fbe=a15_0x13d9;if(_0x10d6f1&&_0x10d6f1[_0xfd3fbe(0x122)])return _0x10d6f1;var _0x119cbf={};if(_0x10d6f1!=null){for(var _0x5328bd=_0x186d28(_0x10d6f1),_0x4c9baf=0x0;_0x4c9baf<_0x5328bd[_0xfd3fbe(0x14d)];_0x4c9baf++)if(_0x5328bd[_0x4c9baf]!==_0xfd3fbe(0x105))__createBinding(_0x119cbf,_0x10d6f1,_0x5328bd[_0x4c9baf]);}return __setModuleDefault(_0x119cbf,_0x10d6f1),_0x119cbf;};}()),__importDefault=this&&this[a15_0x556db7(0xf4)]||function(_0x3e6338){const _0xa0cd83=a15_0x556db7;return _0x3e6338&&_0x3e6338[_0xa0cd83(0x122)]?_0x3e6338:{'default':_0x3e6338};};Object[a15_0x556db7(0x11a)](exports,a15_0x556db7(0x122),{'value':!![]}),exports[a15_0x556db7(0x118)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a15_0x556db7(0x149)),database_1=__importDefault(require(a15_0x556db7(0x150)));class TestGatewayController{constructor(){const _0x5adace=a15_0x556db7;this['getPaymentForm']=async(_0x3693ce,_0x503f9e,_0x1fde07)=>{const _0x580be4=a15_0x13d9;try{const {paymentId:_0x327a23}=_0x3693ce[_0x580be4(0x102)];console[_0x580be4(0x135)](_0x580be4(0x159)+_0x327a23);const _0x57ed98=await database_1[_0x580be4(0x105)][_0x580be4(0x114)][_0x580be4(0x11e)]({'where':{'id':_0x327a23},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x57ed98)return _0x503f9e[_0x580be4(0x133)](0x194)[_0x580be4(0x134)]({'success':![],'message':_0x580be4(0x12b)});if(_0x57ed98['gateway']!==_0x580be4(0x121))return _0x503f9e[_0x580be4(0x133)](0x190)[_0x580be4(0x134)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x57ed98['status']!==_0x580be4(0x13e))return _0x503f9e[_0x580be4(0x133)](0x190)[_0x580be4(0x134)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x57ed98[_0x580be4(0x133)]+_0x580be4(0x165)});_0x503f9e['json']({'success':!![],'result':{'paymentId':_0x57ed98['id'],'orderId':_0x57ed98[_0x580be4(0x141)],'amount':_0x57ed98[_0x580be4(0x163)],'currency':_0x57ed98[_0x580be4(0x101)],'merchantName':_0x57ed98['shop'][_0x580be4(0x11d)],'description':_0x580be4(0x154)+_0x57ed98[_0x580be4(0x14c)][_0x580be4(0x11d)],'testInstructions':{'successCard':_0x580be4(0x137),'failureCard':_0x580be4(0x151),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x580be4(0x104)}}});}catch(_0x2d7260){_0x1fde07(_0x2d7260);}},this[_0x5adace(0x108)]=async(_0x2e53bb,_0x3adddb,_0x1282ed)=>{const _0x169083=_0x5adace;try{const {paymentId:_0xc4bc76}=_0x2e53bb[_0x169083(0x102)],_0x361b76=_0x2e53bb[_0x169083(0x12a)];console[_0x169083(0x135)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0xc4bc76);const _0x204dbe=await database_1[_0x169083(0x105)][_0x169083(0x114)]['findUnique']({'where':{'id':_0xc4bc76},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x204dbe)return _0x3adddb[_0x169083(0x133)](0x194)[_0x169083(0x134)]({'success':![],'message':_0x169083(0x12b)});if(_0x204dbe[_0x169083(0x14a)]!==_0x169083(0x121))return _0x3adddb['status'](0x190)[_0x169083(0x134)]({'success':![],'message':_0x169083(0x10b)});if(_0x204dbe['status']!=='PENDING')return _0x3adddb[_0x169083(0x133)](0x190)[_0x169083(0x134)]({'success':![],'message':_0x169083(0x145)+_0x204dbe['status']+_0x169083(0x165)});const _0x4d1646=await this[_0x169083(0x11b)][_0x169083(0x127)]({'paymentId':_0x204dbe['id'],'orderId':_0x204dbe[_0x169083(0x141)]||_0x204dbe['id'],'amount':_0x204dbe[_0x169083(0x163)],'currency':_0x204dbe[_0x169083(0x101)],'cardData':_0x361b76});console[_0x169083(0x135)](_0x169083(0x14b),_0x4d1646);const _0x54d9f1={'status':_0x4d1646[_0x169083(0x133)],'updatedAt':new Date()};if(_0x4d1646['status']===_0x169083(0x13a))_0x54d9f1[_0x169083(0x15f)]=new Date(),_0x54d9f1['gatewayPaymentId']=_0x4d1646[_0x169083(0x116)];else _0x4d1646['status']===_0x169083(0x110)&&(_0x54d9f1[_0x169083(0x128)]=_0x4d1646[_0x169083(0x13f)]);const _0x2be9a9=_0x361b76[_0x169083(0x13d)][_0x169083(0x157)](/[\s-]/g,'');_0x54d9f1['cardLast4']=_0x2be9a9[_0x169083(0xfa)](-0x4),_0x54d9f1['paymentMethod']='test_card',await database_1['default']['payment'][_0x169083(0x12e)]({'where':{'id':_0x204dbe['id']},'data':_0x54d9f1});if(_0x4d1646['status']==='PAID'&&_0x204dbe[_0x169083(0x10a)]){console[_0x169083(0x135)](_0x169083(0x125)+_0x204dbe['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x169083(0x105)]['$transaction'](async _0x5f69c7=>{const _0x11c4be=_0x169083,_0x10d618=await _0x5f69c7[_0x11c4be(0xf5)][_0x11c4be(0x11e)]({'where':{'id':_0x204dbe[_0x11c4be(0x10a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x10d618){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x10d618['id']+_0x11c4be(0x136)+_0x10d618[_0x11c4be(0x12d)]+_0x11c4be(0x120)+_0x10d618[_0x11c4be(0x140)]+',\x20status='+_0x10d618[_0x11c4be(0x133)]);const _0x468e84=_0x10d618['currentPayments']+0x1,_0x5101f2=_0x10d618[_0x11c4be(0x12d)]===_0x11c4be(0x139)?'COMPLETED':_0x10d618[_0x11c4be(0x133)];await _0x5f69c7[_0x11c4be(0xf5)][_0x11c4be(0x12e)]({'where':{'id':_0x204dbe[_0x11c4be(0x10a)]},'data':{'currentPayments':_0x468e84,'status':_0x5101f2,'updatedAt':new Date()}}),console[_0x11c4be(0x135)]('✅\x20Payment\x20link\x20'+_0x10d618['id']+_0x11c4be(0x112)+_0x10d618[_0x11c4be(0x140)]+_0x11c4be(0x115)+_0x468e84+_0x11c4be(0x15d)+_0x10d618['status']+_0x11c4be(0x115)+_0x5101f2);}else console[_0x11c4be(0x135)](_0x11c4be(0x15c)+_0x204dbe['paymentLinkId']+_0x11c4be(0x147));});}catch(_0x4247d2){console[_0x169083(0x12c)](_0x169083(0x152),_0x4247d2);}}await database_1[_0x169083(0x105)][_0x169083(0xf8)]['create']({'data':{'paymentId':_0x204dbe['id'],'shopId':_0x204dbe[_0x169083(0x11f)],'event':'test_gateway_'+_0x4d1646['status'][_0x169083(0x10f)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x169083(0x13e),'newStatus':_0x4d1646['status'],'transactionId':_0x4d1646['transactionId'],'failureReason':_0x4d1646[_0x169083(0x13f)],'processedAt':new Date()[_0x169083(0x146)]()})}}),await this[_0x169083(0xfc)](_0x204dbe,_0x4d1646['status'],_0x4d1646['transactionId'],_0x4d1646[_0x169083(0x13f)]),await this[_0x169083(0x143)](_0x204dbe,_0x4d1646[_0x169083(0x133)]),console['log'](_0x169083(0x117)+_0xc4bc76+_0x169083(0x162)+_0x4d1646[_0x169083(0x133)]),_0x4d1646['status']===_0x169083(0x13a)?_0x3adddb[_0x169083(0x134)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x4d1646['transactionId'],'redirectUrl':_0x204dbe[_0x169083(0xfd)]}}):_0x3adddb[_0x169083(0x133)](0x190)[_0x169083(0x134)]({'success':![],'message':_0x169083(0x12f),'result':{'status':_0x169083(0x110),'failureReason':_0x4d1646['failureReason'],'redirectUrl':_0x204dbe[_0x169083(0x166)]}});}catch(_0x4d80b3){_0x1282ed(_0x4d80b3);}},this['testGatewayService']=new testGatewayService_1[(_0x5adace(0xff))](),this[_0x5adace(0x15e)]=new webhookService_1['WebhookService']();}async[a15_0x556db7(0xfc)](_0x54f0d9,_0x346994,_0x1cb2b8,_0x41f8dc){const _0x449e5b=a15_0x556db7,_0x3f68ad=Date[_0x449e5b(0x13c)]();try{const _0x546681=_0x54f0d9[_0x449e5b(0x14c)],_0x3e1655=_0x546681[_0x449e5b(0x13b)];if(!_0x3e1655?.['webhookUrl']){console['log'](_0x449e5b(0x109)+_0x546681['id']);return;}const _0x5127f4=_0x346994==='PAID'?_0x449e5b(0x156):_0x449e5b(0xfb);let _0x214703=[];if(_0x3e1655[_0x449e5b(0x103)])try{_0x214703=Array['isArray'](_0x3e1655[_0x449e5b(0x103)])?_0x3e1655['webhookEvents']:JSON[_0x449e5b(0x144)](_0x3e1655[_0x449e5b(0x103)]);}catch(_0x3455c7){console[_0x449e5b(0x12c)](_0x449e5b(0x14f),_0x3455c7),_0x214703=[];}if(!_0x214703[_0x449e5b(0x132)](_0x5127f4)){console['log'](_0x449e5b(0x160)+_0x5127f4+_0x449e5b(0xf9)+_0x546681['id']);return;}const _0x746ba5={'event':_0x5127f4,'payment':{'id':_0x54f0d9['id'],'order_id':_0x54f0d9[_0x449e5b(0x119)],'gateway_order_id':_0x54f0d9[_0x449e5b(0x141)],'gateway':_0x449e5b(0x131),'amount':_0x54f0d9[_0x449e5b(0x163)],'currency':_0x54f0d9['currency'],'status':_0x346994[_0x449e5b(0x10f)](),'customer_email':_0x54f0d9[_0x449e5b(0x123)],'customer_name':_0x54f0d9[_0x449e5b(0xfe)],'transaction_id':_0x1cb2b8,'failure_message':_0x41f8dc,'created_at':_0x54f0d9['createdAt'],'updated_at':new Date()}},_0x330130=await fetch(_0x3e1655[_0x449e5b(0x111)],{'method':_0x449e5b(0x158),'headers':{'Content-Type':_0x449e5b(0x14e),'User-Agent':_0x449e5b(0x106)},'body':JSON[_0x449e5b(0x130)](_0x746ba5)}),_0x3fa45e=Date[_0x449e5b(0x13c)]()-_0x3f68ad;console[_0x449e5b(0x135)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x3e1655[_0x449e5b(0x111)]+'\x20with\x20status\x20'+_0x330130[_0x449e5b(0x133)]+'\x20('+_0x3fa45e+'ms)');}catch(_0x39b399){console[_0x449e5b(0x12c)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x39b399);}}async[a15_0x556db7(0x143)](_0x26e326,_0x5ecbd8){const _0x1bcb89=a15_0x556db7;try{const {telegramBotService:_0x27149c}=await Promise[_0x1bcb89(0x15b)]()['then'](()=>__importStar(require(_0x1bcb89(0x155)))),_0x25e192={'PAID':_0x1bcb89(0x107),'FAILED':'failed'},_0x44baab=_0x25e192[_0x5ecbd8];if(!_0x44baab)return;await _0x27149c[_0x1bcb89(0x161)](_0x26e326[_0x1bcb89(0x11f)],_0x26e326,_0x44baab);}catch(_0x5e32b4){console[_0x1bcb89(0x12c)](_0x1bcb89(0x100),_0x5e32b4);}}}exports[a15_0x556db7(0x118)]=TestGatewayController;