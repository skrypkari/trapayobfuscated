'use strict';const a13_0x53739a=a13_0xf467;function a13_0x3a4e(){const _0x2c86e7=['Any\x20other\x20card\x20number','length','name','\x20with\x20status\x20','6263225kURPqs','\x20not\x20enabled\x20for\x20shop\x20','19888VQynkz','gatewayOrderId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getOwnPropertyNames','stringify','error','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','params','test_gateway','failureReason','webhookEvents',',\x20cannot\x20process','createdAt','transactionId','../services/telegramBotService','1162477Hxkfee','customerEmail','currency','TestGatewayController','9wAxWqw','7188mkPlph','payment.failed','gatewayPaymentId','shop','default','writable','resolve','FAILED','WebhookService','cardLast4','status','processCard','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','body','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','__setModuleDefault','defineProperty','Payment\x20failed','webhookUrl','paymentMethod','../config/database','Payment\x20not\x20found','json','then','43876DEqANY','get','2tysggJ','6599410RssgCX','568XUxVgn','failUrl','toLowerCase','webhookService','includes','Any\x20future\x20date\x20(MM/YY)','failed','call','\x20processed:\x20','now','cardNumber','paid','3480196qyNuIb','Any\x203-4\x20digits','prototype','Payment\x20is\x20not\x20for\x20test\x20gateway','replace','sendPaymentNotification','paidAt','create','PAID','__importStar','Payment\x20processed\x20successfully','gateway','orderId','testGatewayService','ms)','parse','shopId','__esModule','Payment\x20status\x20is\x20','slice','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','findUnique','log','update','getPaymentForm','isArray','3qnELzB','test_gateway_','../services/webhookService','customerName','POST','amount','sendPaymentStatusNotification','2768568QxAGef','__createBinding','configurable','sendShopWebhook','payment','failureMessage','PENDING'];a13_0x3a4e=function(){return _0x2c86e7;};return a13_0x3a4e();}(function(_0x35931b,_0x2221d9){const _0x34c6cd=a13_0xf467,_0x5dcb61=_0x35931b();while(!![]){try{const _0x5e9aad=parseInt(_0x34c6cd(0x1eb))/0x1*(parseInt(_0x34c6cd(0x19f))/0x2)+-parseInt(_0x34c6cd(0x1c7))/0x3*(-parseInt(_0x34c6cd(0x1ad))/0x4)+parseInt(_0x34c6cd(0x1d9))/0x5+-parseInt(_0x34c6cd(0x1ce))/0x6+-parseInt(_0x34c6cd(0x19d))/0x7*(parseInt(_0x34c6cd(0x1a1))/0x8)+-parseInt(_0x34c6cd(0x1ef))/0x9*(parseInt(_0x34c6cd(0x1a0))/0xa)+-parseInt(_0x34c6cd(0x1db))/0xb*(parseInt(_0x34c6cd(0x1f0))/0xc);if(_0x5e9aad===_0x2221d9)break;else _0x5dcb61['push'](_0x5dcb61['shift']());}catch(_0x1aec36){_0x5dcb61['push'](_0x5dcb61['shift']());}}}(a13_0x3a4e,0x9b386));function a13_0xf467(_0x5aaf29,_0x2364ec){const _0x3a4e21=a13_0x3a4e();return a13_0xf467=function(_0xf46703,_0x737527){_0xf46703=_0xf46703-0x190;let _0x8eb0d5=_0x3a4e21[_0xf46703];return _0x8eb0d5;},a13_0xf467(_0x5aaf29,_0x2364ec);}var __createBinding=this&&this[a13_0x53739a(0x1cf)]||(Object[a13_0x53739a(0x1b4)]?function(_0x263305,_0x5e0918,_0x39ac02,_0x24feaa){const _0x4377e3=a13_0x53739a;if(_0x24feaa===undefined)_0x24feaa=_0x39ac02;var _0x50ffc3=Object['getOwnPropertyDescriptor'](_0x5e0918,_0x39ac02);(!_0x50ffc3||(_0x4377e3(0x19e)in _0x50ffc3?!_0x5e0918[_0x4377e3(0x1be)]:_0x50ffc3[_0x4377e3(0x1f5)]||_0x50ffc3[_0x4377e3(0x1d0)]))&&(_0x50ffc3={'enumerable':!![],'get':function(){return _0x5e0918[_0x39ac02];}}),Object[_0x4377e3(0x195)](_0x263305,_0x24feaa,_0x50ffc3);}:function(_0x107006,_0x31180a,_0x1f64ce,_0x10c956){if(_0x10c956===undefined)_0x10c956=_0x1f64ce;_0x107006[_0x10c956]=_0x31180a[_0x1f64ce];}),__setModuleDefault=this&&this[a13_0x53739a(0x194)]||(Object[a13_0x53739a(0x1b4)]?function(_0x99ca26,_0x2f9e2c){const _0x5b350a=a13_0x53739a;Object[_0x5b350a(0x195)](_0x99ca26,_0x5b350a(0x1f4),{'enumerable':!![],'value':_0x2f9e2c});}:function(_0x6a2a03,_0x40f8e5){const _0x31df9e=a13_0x53739a;_0x6a2a03[_0x31df9e(0x1f4)]=_0x40f8e5;}),__importStar=this&&this[a13_0x53739a(0x1b6)]||(function(){var _0x9d7164=function(_0x38c8f7){const _0x24b38f=a13_0xf467;return _0x9d7164=Object[_0x24b38f(0x1df)]||function(_0x2d7dc6){const _0x21ef3e=_0x24b38f;var _0xb20f2e=[];for(var _0x180b98 in _0x2d7dc6)if(Object[_0x21ef3e(0x1af)]['hasOwnProperty'][_0x21ef3e(0x1a8)](_0x2d7dc6,_0x180b98))_0xb20f2e[_0xb20f2e[_0x21ef3e(0x1d6)]]=_0x180b98;return _0xb20f2e;},_0x9d7164(_0x38c8f7);};return function(_0x30b45f){const _0x265c78=a13_0xf467;if(_0x30b45f&&_0x30b45f['__esModule'])return _0x30b45f;var _0x169d9b={};if(_0x30b45f!=null){for(var _0x5f79d2=_0x9d7164(_0x30b45f),_0x4d8ee1=0x0;_0x4d8ee1<_0x5f79d2[_0x265c78(0x1d6)];_0x4d8ee1++)if(_0x5f79d2[_0x4d8ee1]!==_0x265c78(0x1f4))__createBinding(_0x169d9b,_0x30b45f,_0x5f79d2[_0x4d8ee1]);}return __setModuleDefault(_0x169d9b,_0x30b45f),_0x169d9b;};}()),__importDefault=this&&this['__importDefault']||function(_0x444be7){return _0x444be7&&_0x444be7['__esModule']?_0x444be7:{'default':_0x444be7};};Object[a13_0x53739a(0x195)](exports,a13_0x53739a(0x1be),{'value':!![]}),exports[a13_0x53739a(0x1ee)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x53739a(0x1c9)),database_1=__importDefault(require(a13_0x53739a(0x199)));class TestGatewayController{constructor(){const _0x2448de=a13_0x53739a;this[_0x2448de(0x1c5)]=async(_0xdde37b,_0x389b2c,_0x4bd6ec)=>{const _0x3e7dee=_0x2448de;try{const {paymentId:_0x2bced9}=_0xdde37b[_0x3e7dee(0x1e3)];console['log'](_0x3e7dee(0x1c1)+_0x2bced9);const _0x290209=await database_1[_0x3e7dee(0x1f4)][_0x3e7dee(0x1d2)][_0x3e7dee(0x1c2)]({'where':{'id':_0x2bced9},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x290209)return _0x389b2c[_0x3e7dee(0x1fa)](0x194)['json']({'success':![],'message':_0x3e7dee(0x19a)});if(_0x290209[_0x3e7dee(0x1b8)]!==_0x3e7dee(0x1e4))return _0x389b2c['status'](0x190)[_0x3e7dee(0x19b)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x290209[_0x3e7dee(0x1fa)]!==_0x3e7dee(0x1d4))return _0x389b2c[_0x3e7dee(0x1fa)](0x190)[_0x3e7dee(0x19b)]({'success':![],'message':_0x3e7dee(0x1bf)+_0x290209[_0x3e7dee(0x1fa)]+_0x3e7dee(0x1e7)});_0x389b2c[_0x3e7dee(0x19b)]({'success':!![],'result':{'paymentId':_0x290209['id'],'orderId':_0x290209[_0x3e7dee(0x1dc)],'amount':_0x290209['amount'],'currency':_0x290209[_0x3e7dee(0x1ed)],'merchantName':_0x290209[_0x3e7dee(0x1f3)][_0x3e7dee(0x1d7)],'description':'Payment\x20to\x20'+_0x290209[_0x3e7dee(0x1f3)][_0x3e7dee(0x1d7)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x3e7dee(0x1d5),'expiryDate':_0x3e7dee(0x1a6),'cvc':_0x3e7dee(0x1ae),'holderName':'Any\x20name'}}});}catch(_0x598eca){_0x4bd6ec(_0x598eca);}},this[_0x2448de(0x190)]=async(_0x4c21af,_0x37658a,_0x2e874f)=>{const _0x1f6622=_0x2448de;try{const {paymentId:_0x5ca6c0}=_0x4c21af[_0x1f6622(0x1e3)],_0x5ae9a3=_0x4c21af[_0x1f6622(0x192)];console[_0x1f6622(0x1c3)](_0x1f6622(0x191)+_0x5ca6c0);const _0x1e0fd7=await database_1[_0x1f6622(0x1f4)][_0x1f6622(0x1d2)][_0x1f6622(0x1c2)]({'where':{'id':_0x5ca6c0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1e0fd7)return _0x37658a[_0x1f6622(0x1fa)](0x194)[_0x1f6622(0x19b)]({'success':![],'message':_0x1f6622(0x19a)});if(_0x1e0fd7[_0x1f6622(0x1b8)]!==_0x1f6622(0x1e4))return _0x37658a[_0x1f6622(0x1fa)](0x190)[_0x1f6622(0x19b)]({'success':![],'message':_0x1f6622(0x1b0)});if(_0x1e0fd7[_0x1f6622(0x1fa)]!==_0x1f6622(0x1d4))return _0x37658a[_0x1f6622(0x1fa)](0x190)[_0x1f6622(0x19b)]({'success':![],'message':_0x1f6622(0x1bf)+_0x1e0fd7[_0x1f6622(0x1fa)]+_0x1f6622(0x1e7)});const _0x97e3db=await this[_0x1f6622(0x1ba)]['processCardPayment']({'paymentId':_0x1e0fd7['id'],'orderId':_0x1e0fd7[_0x1f6622(0x1dc)]||_0x1e0fd7['id'],'amount':_0x1e0fd7[_0x1f6622(0x1cc)],'currency':_0x1e0fd7[_0x1f6622(0x1ed)],'cardData':_0x5ae9a3});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x97e3db);const _0x463d37={'status':_0x97e3db[_0x1f6622(0x1fa)],'updatedAt':new Date()};if(_0x97e3db[_0x1f6622(0x1fa)]===_0x1f6622(0x1b5))_0x463d37[_0x1f6622(0x1b3)]=new Date(),_0x463d37[_0x1f6622(0x1f2)]=_0x97e3db[_0x1f6622(0x1e9)];else _0x97e3db[_0x1f6622(0x1fa)]===_0x1f6622(0x1f7)&&(_0x463d37[_0x1f6622(0x1d3)]=_0x97e3db['failureReason']);const _0x1bae43=_0x5ae9a3[_0x1f6622(0x1ab)][_0x1f6622(0x1b1)](/[\s-]/g,'');_0x463d37[_0x1f6622(0x1f9)]=_0x1bae43[_0x1f6622(0x1c0)](-0x4),_0x463d37[_0x1f6622(0x198)]='test_card',await database_1['default'][_0x1f6622(0x1d2)][_0x1f6622(0x1c4)]({'where':{'id':_0x1e0fd7['id']},'data':_0x463d37}),await database_1['default']['webhookLog'][_0x1f6622(0x1b4)]({'data':{'paymentId':_0x1e0fd7['id'],'shopId':_0x1e0fd7[_0x1f6622(0x1bd)],'event':_0x1f6622(0x1c8)+_0x97e3db[_0x1f6622(0x1fa)][_0x1f6622(0x1a3)](),'statusCode':0xc8,'responseBody':JSON[_0x1f6622(0x1e0)]({'oldStatus':_0x1f6622(0x1d4),'newStatus':_0x97e3db[_0x1f6622(0x1fa)],'transactionId':_0x97e3db[_0x1f6622(0x1e9)],'failureReason':_0x97e3db[_0x1f6622(0x1e5)],'processedAt':new Date()['toISOString']()})}}),await this[_0x1f6622(0x1d1)](_0x1e0fd7,_0x97e3db[_0x1f6622(0x1fa)],_0x97e3db[_0x1f6622(0x1e9)],_0x97e3db[_0x1f6622(0x1e5)]),await this[_0x1f6622(0x1cd)](_0x1e0fd7,_0x97e3db[_0x1f6622(0x1fa)]),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x5ca6c0+_0x1f6622(0x1a9)+_0x97e3db[_0x1f6622(0x1fa)]),_0x97e3db['status']===_0x1f6622(0x1b5)?_0x37658a[_0x1f6622(0x19b)]({'success':!![],'message':_0x1f6622(0x1b7),'result':{'status':_0x1f6622(0x1b5),'transactionId':_0x97e3db['transactionId'],'redirectUrl':_0x1e0fd7['successUrl']}}):_0x37658a[_0x1f6622(0x1fa)](0x190)[_0x1f6622(0x19b)]({'success':![],'message':_0x1f6622(0x196),'result':{'status':_0x1f6622(0x1f7),'failureReason':_0x97e3db[_0x1f6622(0x1e5)],'redirectUrl':_0x1e0fd7[_0x1f6622(0x1a2)]}});}catch(_0x2d7587){_0x2e874f(_0x2d7587);}},this[_0x2448de(0x1ba)]=new testGatewayService_1['TestGatewayService'](),this[_0x2448de(0x1a4)]=new webhookService_1[(_0x2448de(0x1f8))]();}async[a13_0x53739a(0x1d1)](_0xad7265,_0x1570c2,_0xe0dd5d,_0x3796cf){const _0x292abd=a13_0x53739a,_0x2ccb0a=Date[_0x292abd(0x1aa)]();try{const _0x28bd1d=_0xad7265[_0x292abd(0x1f3)],_0x1c7801=_0x28bd1d['settings'];if(!_0x1c7801?.[_0x292abd(0x197)]){console[_0x292abd(0x1c3)](_0x292abd(0x1de)+_0x28bd1d['id']);return;}const _0x5ecbc2=_0x1570c2==='PAID'?'payment.success':_0x292abd(0x1f1);let _0x54ad87=[];if(_0x1c7801[_0x292abd(0x1e6)])try{_0x54ad87=Array[_0x292abd(0x1c6)](_0x1c7801[_0x292abd(0x1e6)])?_0x1c7801[_0x292abd(0x1e6)]:JSON[_0x292abd(0x1bc)](_0x1c7801[_0x292abd(0x1e6)]);}catch(_0x3ae6e2){console[_0x292abd(0x1e1)]('Error\x20parsing\x20webhook\x20events:',_0x3ae6e2),_0x54ad87=[];}if(!_0x54ad87[_0x292abd(0x1a5)](_0x5ecbc2)){console[_0x292abd(0x1c3)]('Webhook\x20event\x20'+_0x5ecbc2+_0x292abd(0x1da)+_0x28bd1d['id']);return;}const _0x2601d3={'event':_0x5ecbc2,'payment':{'id':_0xad7265['id'],'order_id':_0xad7265[_0x292abd(0x1b9)],'gateway_order_id':_0xad7265[_0x292abd(0x1dc)],'gateway':'0000','amount':_0xad7265[_0x292abd(0x1cc)],'currency':_0xad7265['currency'],'status':_0x1570c2[_0x292abd(0x1a3)](),'customer_email':_0xad7265[_0x292abd(0x1ec)],'customer_name':_0xad7265[_0x292abd(0x1ca)],'transaction_id':_0xe0dd5d,'failure_message':_0x3796cf,'created_at':_0xad7265[_0x292abd(0x1e8)],'updated_at':new Date()}},_0x447821=await fetch(_0x1c7801[_0x292abd(0x197)],{'method':_0x292abd(0x1cb),'headers':{'Content-Type':'application/json','User-Agent':_0x292abd(0x193)},'body':JSON[_0x292abd(0x1e0)](_0x2601d3)}),_0x252c77=Date[_0x292abd(0x1aa)]()-_0x2ccb0a;console[_0x292abd(0x1c3)](_0x292abd(0x1dd)+_0x1c7801['webhookUrl']+_0x292abd(0x1d8)+_0x447821[_0x292abd(0x1fa)]+'\x20('+_0x252c77+_0x292abd(0x1bb));}catch(_0x51df88){console[_0x292abd(0x1e1)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x51df88);}}async[a13_0x53739a(0x1cd)](_0x2ae1e5,_0x1f67d5){const _0x2f5862=a13_0x53739a;try{const {telegramBotService:_0x18ac45}=await Promise[_0x2f5862(0x1f6)]()[_0x2f5862(0x19c)](()=>__importStar(require(_0x2f5862(0x1ea)))),_0x38fe87={'PAID':_0x2f5862(0x1ac),'FAILED':_0x2f5862(0x1a7)},_0x1408e9=_0x38fe87[_0x1f67d5];if(!_0x1408e9)return;await _0x18ac45[_0x2f5862(0x1b2)](_0x2ae1e5['shopId'],_0x2ae1e5,_0x1408e9);}catch(_0x5265dd){console[_0x2f5862(0x1e1)](_0x2f5862(0x1e2),_0x5265dd);}}}exports[a13_0x53739a(0x1ee)]=TestGatewayController;