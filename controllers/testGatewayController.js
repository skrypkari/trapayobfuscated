'use strict';const a18_0x558ebe=a18_0x3140;(function(_0x186982,_0x1ed251){const _0x3bc9c3=a18_0x3140,_0x1c9d36=_0x186982();while(!![]){try{const _0x3d0fcd=-parseInt(_0x3bc9c3(0x104))/0x1*(-parseInt(_0x3bc9c3(0x13f))/0x2)+parseInt(_0x3bc9c3(0xf8))/0x3*(parseInt(_0x3bc9c3(0x129))/0x4)+parseInt(_0x3bc9c3(0x11a))/0x5*(-parseInt(_0x3bc9c3(0x11b))/0x6)+-parseInt(_0x3bc9c3(0x13d))/0x7+-parseInt(_0x3bc9c3(0xfc))/0x8+parseInt(_0x3bc9c3(0x125))/0x9+parseInt(_0x3bc9c3(0x15e))/0xa;if(_0x3d0fcd===_0x1ed251)break;else _0x1c9d36['push'](_0x1c9d36['shift']());}catch(_0x188360){_0x1c9d36['push'](_0x1c9d36['shift']());}}}(a18_0x3e01,0x92d65));var __createBinding=this&&this['__createBinding']||(Object[a18_0x558ebe(0x115)]?function(_0x377932,_0x59ce25,_0x2c0fc7,_0x26d56c){const _0x41f325=a18_0x558ebe;if(_0x26d56c===undefined)_0x26d56c=_0x2c0fc7;var _0x44c06a=Object[_0x41f325(0x12d)](_0x59ce25,_0x2c0fc7);(!_0x44c06a||(_0x41f325(0x138)in _0x44c06a?!_0x59ce25[_0x41f325(0x14a)]:_0x44c06a[_0x41f325(0x156)]||_0x44c06a[_0x41f325(0x15c)]))&&(_0x44c06a={'enumerable':!![],'get':function(){return _0x59ce25[_0x2c0fc7];}}),Object['defineProperty'](_0x377932,_0x26d56c,_0x44c06a);}:function(_0x1b7100,_0x52a9d6,_0x2ce5ba,_0x10d771){if(_0x10d771===undefined)_0x10d771=_0x2ce5ba;_0x1b7100[_0x10d771]=_0x52a9d6[_0x2ce5ba];}),__setModuleDefault=this&&this[a18_0x558ebe(0x12e)]||(Object['create']?function(_0x10faf9,_0xa3bdad){const _0x77fbce=a18_0x558ebe;Object[_0x77fbce(0xfa)](_0x10faf9,_0x77fbce(0x143),{'enumerable':!![],'value':_0xa3bdad});}:function(_0x33c30b,_0x1d5e58){const _0x647e0d=a18_0x558ebe;_0x33c30b[_0x647e0d(0x143)]=_0x1d5e58;}),__importStar=this&&this[a18_0x558ebe(0xec)]||(function(){var _0x439aab=function(_0x51c987){const _0x30aede=a18_0x3140;return _0x439aab=Object[_0x30aede(0x14c)]||function(_0x2ad3a4){const _0x534af3=_0x30aede;var _0x900f28=[];for(var _0x4e4b9e in _0x2ad3a4)if(Object[_0x534af3(0x11e)][_0x534af3(0x157)][_0x534af3(0xf6)](_0x2ad3a4,_0x4e4b9e))_0x900f28[_0x900f28[_0x534af3(0x14b)]]=_0x4e4b9e;return _0x900f28;},_0x439aab(_0x51c987);};return function(_0x1136c){const _0xfd4bb3=a18_0x3140;if(_0x1136c&&_0x1136c[_0xfd4bb3(0x14a)])return _0x1136c;var _0x2eb635={};if(_0x1136c!=null){for(var _0x293c4d=_0x439aab(_0x1136c),_0xebb687=0x0;_0xebb687<_0x293c4d[_0xfd4bb3(0x14b)];_0xebb687++)if(_0x293c4d[_0xebb687]!=='default')__createBinding(_0x2eb635,_0x1136c,_0x293c4d[_0xebb687]);}return __setModuleDefault(_0x2eb635,_0x1136c),_0x2eb635;};}()),__importDefault=this&&this[a18_0x558ebe(0xf2)]||function(_0x3f5820){const _0x4eb740=a18_0x558ebe;return _0x3f5820&&_0x3f5820[_0x4eb740(0x14a)]?_0x3f5820:{'default':_0x3f5820};};Object['defineProperty'](exports,a18_0x558ebe(0x14a),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a18_0x558ebe(0x112)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));function a18_0x3e01(){const _0x40eed9=['36145KeSsTF','parse','TestGatewayService','Payment\x20processed\x20successfully','WebhookService','$transaction','currency','toLowerCase','toISOString','\x20with\x20status\x20','log','COMPLETED','successUrl','slice','../services/gateways/testGatewayService','gateway','\x20->\x20','create','4242\x204242\x204242\x204242','settings','gatewayOrderId','replace','20ettdLM','1567032SifcfZ','shop','resolve','prototype','Webhook\x20event\x20','TestGatewayController','\x20not\x20enabled\x20for\x20shop\x20','Any\x20other\x20card\x20number','json','getPaymentForm','5144220pGJbhD','paymentLink','status','FAILED','100QigtgL','Any\x20future\x20date\x20(MM/YY)','âœ…\x20Payment\x20link\x20',':\x20type=','getOwnPropertyDescriptor','__setModuleDefault','then','transactionId','customerName','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20processed:\x20','createdAt','webhookService','âœ…\x20Test\x20Gateway\x20payment\x20','name','get','webhookEvents','sendPaymentStatusNotification','Payment\x20status\x20is\x20','failed','7844585bJyYBL','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','38eByiVy',',\x20cannot\x20process','\x20not\x20found','Test\x20Gateway\x20webhook\x20sent\x20to\x20','default','shopId','amount','params','gatewayPaymentId','webhookUrl','../services/telegramBotService','__esModule','length','getOwnPropertyNames','Error\x20parsing\x20webhook\x20events:',',\x20status=','PAID','payment.failed','SINGLE','payment','customerEmail','test_card','Payment\x20to\x20','writable','hasOwnProperty','includes','sendShopWebhook','Any\x203-4\x20digits','update','configurable','processCardPayment','21027650ZVrPjG','test_gateway','processCard','__importStar','0000','now','Payment\x20not\x20found','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','findUnique','__importDefault','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','error','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','call','paymentLinkId','36441pCabYK','testGatewayService','defineProperty','Payment\x20failed','7183896jDSfHv','test_gateway_','Any\x20name','stringify','PENDING','paid','failureReason','currentPayments'];a18_0x3e01=function(){return _0x40eed9;};return a18_0x3e01();}function a18_0x3140(_0x592cae,_0x2e81af){_0x592cae=_0x592cae-0xeb;const _0x3e0199=a18_0x3e01();let _0x314006=_0x3e0199[_0x592cae];return _0x314006;}class TestGatewayController{constructor(){const _0x5545c2=a18_0x558ebe;this[_0x5545c2(0x124)]=async(_0x1d5d51,_0x4f6378,_0x42e7ad)=>{const _0x1a7bdc=_0x5545c2;try{const {paymentId:_0x2b91e3}=_0x1d5d51[_0x1a7bdc(0x146)];console[_0x1a7bdc(0x10e)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2b91e3);const _0x36f055=await database_1[_0x1a7bdc(0x143)][_0x1a7bdc(0x152)][_0x1a7bdc(0xf1)]({'where':{'id':_0x2b91e3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x36f055)return _0x4f6378[_0x1a7bdc(0x127)](0x194)[_0x1a7bdc(0x123)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x36f055[_0x1a7bdc(0x113)]!==_0x1a7bdc(0x15f))return _0x4f6378['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x36f055[_0x1a7bdc(0x127)]!=='PENDING')return _0x4f6378[_0x1a7bdc(0x127)](0x190)['json']({'success':![],'message':_0x1a7bdc(0x13b)+_0x36f055['status']+_0x1a7bdc(0x140)});_0x4f6378[_0x1a7bdc(0x123)]({'success':!![],'result':{'paymentId':_0x36f055['id'],'orderId':_0x36f055[_0x1a7bdc(0x118)],'amount':_0x36f055[_0x1a7bdc(0x145)],'currency':_0x36f055[_0x1a7bdc(0x10a)],'merchantName':_0x36f055[_0x1a7bdc(0x11c)][_0x1a7bdc(0x137)],'description':_0x1a7bdc(0x155)+_0x36f055['shop']['name'],'testInstructions':{'successCard':_0x1a7bdc(0x116),'failureCard':_0x1a7bdc(0x122),'expiryDate':_0x1a7bdc(0x12a),'cvc':_0x1a7bdc(0x15a),'holderName':_0x1a7bdc(0xfe)}}});}catch(_0x12a076){_0x42e7ad(_0x12a076);}},this[_0x5545c2(0xeb)]=async(_0xa45285,_0x40c6a2,_0x210bb7)=>{const _0x4e47b1=_0x5545c2;try{const {paymentId:_0x4a3b18}=_0xa45285[_0x4e47b1(0x146)],_0x3c329e=_0xa45285['body'];console['log'](_0x4e47b1(0xf0)+_0x4a3b18);const _0x3e4898=await database_1[_0x4e47b1(0x143)][_0x4e47b1(0x152)][_0x4e47b1(0xf1)]({'where':{'id':_0x4a3b18},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e4898)return _0x40c6a2[_0x4e47b1(0x127)](0x194)[_0x4e47b1(0x123)]({'success':![],'message':_0x4e47b1(0xef)});if(_0x3e4898[_0x4e47b1(0x113)]!==_0x4e47b1(0x15f))return _0x40c6a2[_0x4e47b1(0x127)](0x190)[_0x4e47b1(0x123)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3e4898[_0x4e47b1(0x127)]!=='PENDING')return _0x40c6a2['status'](0x190)[_0x4e47b1(0x123)]({'success':![],'message':_0x4e47b1(0x13b)+_0x3e4898[_0x4e47b1(0x127)]+_0x4e47b1(0x140)});const _0xcd16dd=await this[_0x4e47b1(0xf9)][_0x4e47b1(0x15d)]({'paymentId':_0x3e4898['id'],'orderId':_0x3e4898[_0x4e47b1(0x118)]||_0x3e4898['id'],'amount':_0x3e4898[_0x4e47b1(0x145)],'currency':_0x3e4898[_0x4e47b1(0x10a)],'cardData':_0x3c329e});console[_0x4e47b1(0x10e)](_0x4e47b1(0x132),_0xcd16dd);const _0x57c1d0={'status':_0xcd16dd[_0x4e47b1(0x127)],'updatedAt':new Date()};if(_0xcd16dd[_0x4e47b1(0x127)]===_0x4e47b1(0x14f))_0x57c1d0['paidAt']=new Date(),_0x57c1d0[_0x4e47b1(0x147)]=_0xcd16dd['transactionId'];else _0xcd16dd[_0x4e47b1(0x127)]==='FAILED'&&(_0x57c1d0['failureMessage']=_0xcd16dd[_0x4e47b1(0x102)]);const _0x18e30f=_0x3c329e['cardNumber'][_0x4e47b1(0x119)](/[\s-]/g,'');_0x57c1d0['cardLast4']=_0x18e30f[_0x4e47b1(0x111)](-0x4),_0x57c1d0['paymentMethod']=_0x4e47b1(0x154),await database_1[_0x4e47b1(0x143)]['payment']['update']({'where':{'id':_0x3e4898['id']},'data':_0x57c1d0});if(_0xcd16dd['status']===_0x4e47b1(0x14f)&&_0x3e4898[_0x4e47b1(0xf7)]){console[_0x4e47b1(0x10e)]('ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20'+_0x3e4898['id']+_0x4e47b1(0xf5));try{await database_1[_0x4e47b1(0x143)][_0x4e47b1(0x109)](async _0x40752e=>{const _0x561c8d=_0x4e47b1,_0x304ffa=await _0x40752e['paymentLink']['findUnique']({'where':{'id':_0x3e4898[_0x561c8d(0xf7)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x304ffa){console['log']('ðŸ“ˆ\x20Found\x20payment\x20link\x20'+_0x304ffa['id']+_0x561c8d(0x12c)+_0x304ffa['type']+',\x20currentPayments='+_0x304ffa[_0x561c8d(0x103)]+_0x561c8d(0x14e)+_0x304ffa['status']);const _0x118bab=_0x304ffa[_0x561c8d(0x103)]+0x1,_0x2dfd36=_0x304ffa['type']===_0x561c8d(0x151)?_0x561c8d(0x10f):_0x304ffa[_0x561c8d(0x127)];await _0x40752e[_0x561c8d(0x126)][_0x561c8d(0x15b)]({'where':{'id':_0x3e4898['paymentLinkId']},'data':{'currentPayments':_0x118bab,'status':_0x2dfd36,'updatedAt':new Date()}}),console[_0x561c8d(0x10e)](_0x561c8d(0x12b)+_0x304ffa['id']+'\x20updated:\x20currentPayments='+_0x304ffa[_0x561c8d(0x103)]+'\x20->\x20'+_0x118bab+_0x561c8d(0x14e)+_0x304ffa[_0x561c8d(0x127)]+_0x561c8d(0x114)+_0x2dfd36);}else console['log']('âŒ\x20Payment\x20link\x20'+_0x3e4898['paymentLinkId']+_0x561c8d(0x141));});}catch(_0x263671){console[_0x4e47b1(0xf4)]('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x263671);}}await database_1['default']['webhookLog'][_0x4e47b1(0x115)]({'data':{'paymentId':_0x3e4898['id'],'shopId':_0x3e4898[_0x4e47b1(0x144)],'event':_0x4e47b1(0xfd)+_0xcd16dd['status'][_0x4e47b1(0x10b)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4e47b1(0x100),'newStatus':_0xcd16dd[_0x4e47b1(0x127)],'transactionId':_0xcd16dd[_0x4e47b1(0x130)],'failureReason':_0xcd16dd[_0x4e47b1(0x102)],'processedAt':new Date()[_0x4e47b1(0x10c)]()})}}),await this[_0x4e47b1(0x159)](_0x3e4898,_0xcd16dd[_0x4e47b1(0x127)],_0xcd16dd[_0x4e47b1(0x130)],_0xcd16dd['failureReason']),await this[_0x4e47b1(0x13a)](_0x3e4898,_0xcd16dd[_0x4e47b1(0x127)]),console[_0x4e47b1(0x10e)](_0x4e47b1(0x136)+_0x4a3b18+_0x4e47b1(0x133)+_0xcd16dd[_0x4e47b1(0x127)]),_0xcd16dd[_0x4e47b1(0x127)]==='PAID'?_0x40c6a2[_0x4e47b1(0x123)]({'success':!![],'message':_0x4e47b1(0x107),'result':{'status':_0x4e47b1(0x14f),'transactionId':_0xcd16dd['transactionId'],'redirectUrl':_0x3e4898[_0x4e47b1(0x110)]}}):_0x40c6a2[_0x4e47b1(0x127)](0x190)[_0x4e47b1(0x123)]({'success':![],'message':_0x4e47b1(0xfb),'result':{'status':_0x4e47b1(0x128),'failureReason':_0xcd16dd[_0x4e47b1(0x102)],'redirectUrl':_0x3e4898['failUrl']}});}catch(_0x4747f8){_0x210bb7(_0x4747f8);}},this[_0x5545c2(0xf9)]=new testGatewayService_1[(_0x5545c2(0x106))](),this[_0x5545c2(0x135)]=new webhookService_1[(_0x5545c2(0x108))]();}async[a18_0x558ebe(0x159)](_0x25da29,_0x113991,_0x49d5ec,_0x54fe81){const _0x7ef573=a18_0x558ebe,_0x4a59d2=Date[_0x7ef573(0xee)]();try{const _0x2a06f7=_0x25da29[_0x7ef573(0x11c)],_0x12e17e=_0x2a06f7[_0x7ef573(0x117)];if(!_0x12e17e?.[_0x7ef573(0x148)]){console[_0x7ef573(0x10e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2a06f7['id']);return;}const _0x3f58bb=_0x113991===_0x7ef573(0x14f)?'payment.success':_0x7ef573(0x150);let _0x313381=[];if(_0x12e17e[_0x7ef573(0x139)])try{_0x313381=Array['isArray'](_0x12e17e['webhookEvents'])?_0x12e17e[_0x7ef573(0x139)]:JSON[_0x7ef573(0x105)](_0x12e17e[_0x7ef573(0x139)]);}catch(_0x32293f){console[_0x7ef573(0xf4)](_0x7ef573(0x14d),_0x32293f),_0x313381=[];}if(!_0x313381[_0x7ef573(0x158)](_0x3f58bb)){console['log'](_0x7ef573(0x11f)+_0x3f58bb+_0x7ef573(0x121)+_0x2a06f7['id']);return;}const _0x5885d2={'event':_0x3f58bb,'payment':{'id':_0x25da29['id'],'order_id':_0x25da29['orderId'],'gateway_order_id':_0x25da29[_0x7ef573(0x118)],'gateway':_0x7ef573(0xed),'amount':_0x25da29[_0x7ef573(0x145)],'currency':_0x25da29[_0x7ef573(0x10a)],'status':_0x113991[_0x7ef573(0x10b)](),'customer_email':_0x25da29[_0x7ef573(0x153)],'customer_name':_0x25da29[_0x7ef573(0x131)],'transaction_id':_0x49d5ec,'failure_message':_0x54fe81,'created_at':_0x25da29[_0x7ef573(0x134)],'updated_at':new Date()}},_0x270bef=await fetch(_0x12e17e['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x7ef573(0xff)](_0x5885d2)}),_0x54a157=Date['now']()-_0x4a59d2;console['log'](_0x7ef573(0x142)+_0x12e17e['webhookUrl']+_0x7ef573(0x10d)+_0x270bef[_0x7ef573(0x127)]+'\x20('+_0x54a157+'ms)');}catch(_0x43957b){console[_0x7ef573(0xf4)](_0x7ef573(0xf3),_0x43957b);}}async[a18_0x558ebe(0x13a)](_0x5ead02,_0x57b927){const _0x432e15=a18_0x558ebe;try{const {telegramBotService:_0x387d24}=await Promise[_0x432e15(0x11d)]()[_0x432e15(0x12f)](()=>__importStar(require(_0x432e15(0x149)))),_0x46e0b9={'PAID':_0x432e15(0x101),'FAILED':_0x432e15(0x13c)},_0x446c30=_0x46e0b9[_0x57b927];if(!_0x446c30)return;await _0x387d24['sendPaymentNotification'](_0x5ead02['shopId'],_0x5ead02,_0x446c30);}catch(_0x1d0d46){console['error'](_0x432e15(0x13e),_0x1d0d46);}}}exports[a18_0x558ebe(0x120)]=TestGatewayController;