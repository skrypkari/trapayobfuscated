'use strict';const a13_0x5c1986=a13_0x21b1;(function(_0x3a66dd,_0x2f1c7c){const _0x4af951=a13_0x21b1,_0x176ee1=_0x3a66dd();while(!![]){try{const _0x11bc4b=-parseInt(_0x4af951(0x1a0))/0x1+parseInt(_0x4af951(0x175))/0x2*(parseInt(_0x4af951(0x17f))/0x3)+parseInt(_0x4af951(0x1b3))/0x4*(parseInt(_0x4af951(0x1be))/0x5)+-parseInt(_0x4af951(0x1a5))/0x6+parseInt(_0x4af951(0x158))/0x7*(-parseInt(_0x4af951(0x17e))/0x8)+parseInt(_0x4af951(0x19c))/0x9+-parseInt(_0x4af951(0x154))/0xa*(parseInt(_0x4af951(0x181))/0xb);if(_0x11bc4b===_0x2f1c7c)break;else _0x176ee1['push'](_0x176ee1['shift']());}catch(_0x17d589){_0x176ee1['push'](_0x176ee1['shift']());}}}(a13_0x394c,0x74321));var __createBinding=this&&this[a13_0x5c1986(0x16d)]||(Object['create']?function(_0x4ca892,_0xa3579e,_0x386bce,_0x5778ec){const _0x2a2ddf=a13_0x5c1986;if(_0x5778ec===undefined)_0x5778ec=_0x386bce;var _0x57a337=Object['getOwnPropertyDescriptor'](_0xa3579e,_0x386bce);(!_0x57a337||(_0x2a2ddf(0x1ae)in _0x57a337?!_0xa3579e[_0x2a2ddf(0x162)]:_0x57a337['writable']||_0x57a337[_0x2a2ddf(0x16f)]))&&(_0x57a337={'enumerable':!![],'get':function(){return _0xa3579e[_0x386bce];}}),Object[_0x2a2ddf(0x198)](_0x4ca892,_0x5778ec,_0x57a337);}:function(_0x4cd0e7,_0x1dc5fe,_0x51e0e3,_0x2f87f8){if(_0x2f87f8===undefined)_0x2f87f8=_0x51e0e3;_0x4cd0e7[_0x2f87f8]=_0x1dc5fe[_0x51e0e3];}),__setModuleDefault=this&&this[a13_0x5c1986(0x161)]||(Object['create']?function(_0x5b7cd4,_0x31c77f){const _0x13858c=a13_0x5c1986;Object['defineProperty'](_0x5b7cd4,_0x13858c(0x191),{'enumerable':!![],'value':_0x31c77f});}:function(_0x5ddbcf,_0x29c691){const _0x280b05=a13_0x5c1986;_0x5ddbcf[_0x280b05(0x191)]=_0x29c691;}),__importStar=this&&this['__importStar']||(function(){var _0x141f3e=function(_0x33c9d6){const _0x4669e0=a13_0x21b1;return _0x141f3e=Object[_0x4669e0(0x1b6)]||function(_0x1374ff){const _0x58658d=_0x4669e0;var _0x3a5564=[];for(var _0xef3353 in _0x1374ff)if(Object[_0x58658d(0x1bd)]['hasOwnProperty'][_0x58658d(0x1ab)](_0x1374ff,_0xef3353))_0x3a5564[_0x3a5564[_0x58658d(0x171)]]=_0xef3353;return _0x3a5564;},_0x141f3e(_0x33c9d6);};return function(_0x1732f4){const _0x35413b=a13_0x21b1;if(_0x1732f4&&_0x1732f4['__esModule'])return _0x1732f4;var _0x3454fd={};if(_0x1732f4!=null){for(var _0x4972ef=_0x141f3e(_0x1732f4),_0x312156=0x0;_0x312156<_0x4972ef[_0x35413b(0x171)];_0x312156++)if(_0x4972ef[_0x312156]!=='default')__createBinding(_0x3454fd,_0x1732f4,_0x4972ef[_0x312156]);}return __setModuleDefault(_0x3454fd,_0x1732f4),_0x3454fd;};}()),__importDefault=this&&this[a13_0x5c1986(0x197)]||function(_0x3f68bb){return _0x3f68bb&&_0x3f68bb['__esModule']?_0x3f68bb:{'default':_0x3f68bb};};Object[a13_0x5c1986(0x198)](exports,'__esModule',{'value':!![]}),exports[a13_0x5c1986(0x18c)]=void 0x0;const testGatewayService_1=require(a13_0x5c1986(0x1af)),webhookService_1=require(a13_0x5c1986(0x163)),database_1=__importDefault(require(a13_0x5c1986(0x1bc)));function a13_0x21b1(_0x25801d,_0x3c43d7){const _0x394c95=a13_0x394c();return a13_0x21b1=function(_0x21b128,_0x1ff650){_0x21b128=_0x21b128-0x150;let _0x57c1af=_0x394c95[_0x21b128];return _0x57c1af;},a13_0x21b1(_0x25801d,_0x3c43d7);}function a13_0x394c(){const _0x19a544=['toLowerCase','create','failureReason','test_gateway','processCardPayment','getPaymentForm','4242\x204242\x204242\x204242','__createBinding','webhookEvents','configurable','sendShopWebhook','length','FAILED','includes','\x20not\x20enabled\x20for\x20shop\x20','2ztIgMz','test_card','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failureMessage','webhookService','application/json','payment.success','isArray','sendPaymentStatusNotification','73984XHHeNF','1527843IplJgK','successUrl','22hQXzZX','error','paidAt','currency','Payment\x20failed','Any\x20future\x20date\x20(MM/YY)','customerName','failUrl','Payment\x20processed\x20successfully','test_gateway_','../services/telegramBotService','TestGatewayController','WebhookService','Payment\x20not\x20found','name','Webhook\x20event\x20','default','then','paid','PAID','replace','shop','__importDefault','defineProperty','PENDING','failed','processCard','7709301NytXIu','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20with\x20status\x20','transactionId','132478guQRIK','customerEmail','orderId',',\x20cannot\x20process','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','1157892QfBAYa','stringify','status','resolve','findUnique','log','call','\x20processed:\x20','update','get','../services/gateways/testGatewayService','Any\x20name','Payment\x20is\x20not\x20for\x20test\x20gateway','testGatewayService','43868tEmBwY','TestGatewayService','gatewayOrderId','getOwnPropertyNames','webhookUrl','POST','Any\x20other\x20card\x20number','gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../config/database','prototype','35hlzvhF','slice','json','body','ms)','339330eejKJu','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','cardLast4','434tocrPy','payment','amount','Error\x20parsing\x20webhook\x20events:','params','Payment\x20status\x20is\x20','shopId','parse','now','__setModuleDefault','__esModule','../services/webhookService','cardNumber','ðŸ§ª\x20Test\x20Gateway\x20result:'];a13_0x394c=function(){return _0x19a544;};return a13_0x394c();}class TestGatewayController{constructor(){const _0x324ce5=a13_0x5c1986;this[_0x324ce5(0x16b)]=async(_0x274c2c,_0x4756d1,_0x58e344)=>{const _0x15fef7=_0x324ce5;try{const {paymentId:_0x209b17}=_0x274c2c[_0x15fef7(0x15c)];console['log'](_0x15fef7(0x1a4)+_0x209b17);const _0x584856=await database_1[_0x15fef7(0x191)][_0x15fef7(0x159)][_0x15fef7(0x1a9)]({'where':{'id':_0x209b17},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x584856)return _0x4756d1[_0x15fef7(0x1a7)](0x194)[_0x15fef7(0x151)]({'success':![],'message':_0x15fef7(0x18e)});if(_0x584856[_0x15fef7(0x1ba)]!==_0x15fef7(0x169))return _0x4756d1[_0x15fef7(0x1a7)](0x190)['json']({'success':![],'message':_0x15fef7(0x1b1)});if(_0x584856['status']!==_0x15fef7(0x199))return _0x4756d1[_0x15fef7(0x1a7)](0x190)[_0x15fef7(0x151)]({'success':![],'message':_0x15fef7(0x15d)+_0x584856['status']+_0x15fef7(0x1a3)});_0x4756d1[_0x15fef7(0x151)]({'success':!![],'result':{'paymentId':_0x584856['id'],'orderId':_0x584856['gatewayOrderId'],'amount':_0x584856[_0x15fef7(0x15a)],'currency':_0x584856[_0x15fef7(0x184)],'merchantName':_0x584856['shop'][_0x15fef7(0x18f)],'description':'Payment\x20to\x20'+_0x584856['shop'][_0x15fef7(0x18f)],'testInstructions':{'successCard':_0x15fef7(0x16c),'failureCard':_0x15fef7(0x1b9),'expiryDate':_0x15fef7(0x186),'cvc':'Any\x203-4\x20digits','holderName':_0x15fef7(0x1b0)}}});}catch(_0x3403e5){_0x58e344(_0x3403e5);}},this[_0x324ce5(0x19b)]=async(_0xea776a,_0x1535a0,_0x2d34e7)=>{const _0x262161=_0x324ce5;try{const {paymentId:_0x31e706}=_0xea776a[_0x262161(0x15c)],_0x514c53=_0xea776a[_0x262161(0x152)];console[_0x262161(0x1aa)](_0x262161(0x156)+_0x31e706);const _0x11bacc=await database_1[_0x262161(0x191)][_0x262161(0x159)][_0x262161(0x1a9)]({'where':{'id':_0x31e706},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x11bacc)return _0x1535a0[_0x262161(0x1a7)](0x194)[_0x262161(0x151)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x11bacc[_0x262161(0x1ba)]!==_0x262161(0x169))return _0x1535a0[_0x262161(0x1a7)](0x190)[_0x262161(0x151)]({'success':![],'message':_0x262161(0x1b1)});if(_0x11bacc['status']!==_0x262161(0x199))return _0x1535a0['status'](0x190)['json']({'success':![],'message':_0x262161(0x15d)+_0x11bacc[_0x262161(0x1a7)]+_0x262161(0x1a3)});const _0x338380=await this[_0x262161(0x1b2)][_0x262161(0x16a)]({'paymentId':_0x11bacc['id'],'orderId':_0x11bacc[_0x262161(0x1b5)]||_0x11bacc['id'],'amount':_0x11bacc[_0x262161(0x15a)],'currency':_0x11bacc[_0x262161(0x184)],'cardData':_0x514c53});console[_0x262161(0x1aa)](_0x262161(0x165),_0x338380);const _0x502614={'status':_0x338380[_0x262161(0x1a7)],'updatedAt':new Date()};if(_0x338380['status']==='PAID')_0x502614[_0x262161(0x183)]=new Date(),_0x502614['gatewayPaymentId']=_0x338380[_0x262161(0x19f)];else _0x338380['status']===_0x262161(0x172)&&(_0x502614[_0x262161(0x178)]=_0x338380[_0x262161(0x168)]);const _0x29602d=_0x514c53[_0x262161(0x164)][_0x262161(0x195)](/[\s-]/g,'');_0x502614[_0x262161(0x157)]=_0x29602d[_0x262161(0x150)](-0x4),_0x502614['paymentMethod']=_0x262161(0x176),await database_1['default']['payment'][_0x262161(0x1ad)]({'where':{'id':_0x11bacc['id']},'data':_0x502614}),await database_1[_0x262161(0x191)]['webhookLog'][_0x262161(0x167)]({'data':{'paymentId':_0x11bacc['id'],'shopId':_0x11bacc[_0x262161(0x15e)],'event':_0x262161(0x18a)+_0x338380[_0x262161(0x1a7)][_0x262161(0x166)](),'statusCode':0xc8,'responseBody':JSON[_0x262161(0x1a6)]({'oldStatus':_0x262161(0x199),'newStatus':_0x338380[_0x262161(0x1a7)],'transactionId':_0x338380[_0x262161(0x19f)],'failureReason':_0x338380['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x262161(0x170)](_0x11bacc,_0x338380[_0x262161(0x1a7)],_0x338380[_0x262161(0x19f)],_0x338380[_0x262161(0x168)]),await this[_0x262161(0x17d)](_0x11bacc,_0x338380[_0x262161(0x1a7)]),console[_0x262161(0x1aa)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x31e706+_0x262161(0x1ac)+_0x338380[_0x262161(0x1a7)]),_0x338380[_0x262161(0x1a7)]==='PAID'?_0x1535a0['json']({'success':!![],'message':_0x262161(0x189),'result':{'status':_0x262161(0x194),'transactionId':_0x338380['transactionId'],'redirectUrl':_0x11bacc[_0x262161(0x180)]}}):_0x1535a0[_0x262161(0x1a7)](0x190)['json']({'success':![],'message':_0x262161(0x185),'result':{'status':'FAILED','failureReason':_0x338380[_0x262161(0x168)],'redirectUrl':_0x11bacc[_0x262161(0x188)]}});}catch(_0x17d889){_0x2d34e7(_0x17d889);}},this[_0x324ce5(0x1b2)]=new testGatewayService_1[(_0x324ce5(0x1b4))](),this[_0x324ce5(0x179)]=new webhookService_1[(_0x324ce5(0x18d))]();}async[a13_0x5c1986(0x170)](_0x509b2a,_0x33d727,_0xd2b965,_0xf3971){const _0x2706d2=a13_0x5c1986,_0x508807=Date[_0x2706d2(0x160)]();try{const _0x4cc63a=_0x509b2a[_0x2706d2(0x196)],_0x282d2b=_0x4cc63a['settings'];if(!_0x282d2b?.['webhookUrl']){console[_0x2706d2(0x1aa)](_0x2706d2(0x177)+_0x4cc63a['id']);return;}const _0x545a80=_0x33d727===_0x2706d2(0x194)?_0x2706d2(0x17b):'payment.failed';let _0x180110=[];if(_0x282d2b[_0x2706d2(0x16e)])try{_0x180110=Array[_0x2706d2(0x17c)](_0x282d2b[_0x2706d2(0x16e)])?_0x282d2b[_0x2706d2(0x16e)]:JSON[_0x2706d2(0x15f)](_0x282d2b[_0x2706d2(0x16e)]);}catch(_0x24f6cb){console[_0x2706d2(0x182)](_0x2706d2(0x15b),_0x24f6cb),_0x180110=[];}if(!_0x180110[_0x2706d2(0x173)](_0x545a80)){console['log'](_0x2706d2(0x190)+_0x545a80+_0x2706d2(0x174)+_0x4cc63a['id']);return;}const _0x5dbbc1={'event':_0x545a80,'payment':{'id':_0x509b2a['id'],'order_id':_0x509b2a[_0x2706d2(0x1a2)],'gateway_order_id':_0x509b2a[_0x2706d2(0x1b5)],'gateway':'0000','amount':_0x509b2a[_0x2706d2(0x15a)],'currency':_0x509b2a[_0x2706d2(0x184)],'status':_0x33d727[_0x2706d2(0x166)](),'customer_email':_0x509b2a[_0x2706d2(0x1a1)],'customer_name':_0x509b2a[_0x2706d2(0x187)],'transaction_id':_0xd2b965,'failure_message':_0xf3971,'created_at':_0x509b2a['createdAt'],'updated_at':new Date()}},_0x5eeb58=await fetch(_0x282d2b[_0x2706d2(0x1b7)],{'method':_0x2706d2(0x1b8),'headers':{'Content-Type':_0x2706d2(0x17a),'User-Agent':_0x2706d2(0x155)},'body':JSON[_0x2706d2(0x1a6)](_0x5dbbc1)}),_0x17cbf9=Date['now']()-_0x508807;console[_0x2706d2(0x1aa)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x282d2b['webhookUrl']+_0x2706d2(0x19e)+_0x5eeb58['status']+'\x20('+_0x17cbf9+_0x2706d2(0x153));}catch(_0x416ff2){console[_0x2706d2(0x182)](_0x2706d2(0x1bb),_0x416ff2);}}async['sendPaymentStatusNotification'](_0x228b50,_0x19c8cd){const _0x128a5d=a13_0x5c1986;try{const {telegramBotService:_0x35c901}=await Promise[_0x128a5d(0x1a8)]()[_0x128a5d(0x192)](()=>__importStar(require(_0x128a5d(0x18b)))),_0x1295e8={'PAID':_0x128a5d(0x193),'FAILED':_0x128a5d(0x19a)},_0x4f10f5=_0x1295e8[_0x19c8cd];if(!_0x4f10f5)return;await _0x35c901['sendPaymentNotification'](_0x228b50['shopId'],_0x228b50,_0x4f10f5);}catch(_0x48f720){console[_0x128a5d(0x182)](_0x128a5d(0x19d),_0x48f720);}}}exports[a13_0x5c1986(0x18c)]=TestGatewayController;