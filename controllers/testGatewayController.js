'use strict';function a21_0xf5e8(_0x487ca9,_0x2864b3){_0x487ca9=_0x487ca9-0x184;const _0x1d3873=a21_0x1d38();let _0xf5e863=_0x1d3873[_0x487ca9];return _0xf5e863;}const a21_0x125ad4=a21_0xf5e8;(function(_0x5016e6,_0x49d9b4){const _0x258c88=a21_0xf5e8,_0x29414f=_0x5016e6();while(!![]){try{const _0x255876=parseInt(_0x258c88(0x1e4))/0x1*(-parseInt(_0x258c88(0x1cd))/0x2)+parseInt(_0x258c88(0x1f0))/0x3+parseInt(_0x258c88(0x1b7))/0x4*(-parseInt(_0x258c88(0x1fe))/0x5)+-parseInt(_0x258c88(0x1d3))/0x6+parseInt(_0x258c88(0x193))/0x7*(-parseInt(_0x258c88(0x1e7))/0x8)+-parseInt(_0x258c88(0x195))/0x9+-parseInt(_0x258c88(0x18c))/0xa*(-parseInt(_0x258c88(0x1ba))/0xb);if(_0x255876===_0x49d9b4)break;else _0x29414f['push'](_0x29414f['shift']());}catch(_0x4e3cfc){_0x29414f['push'](_0x29414f['shift']());}}}(a21_0x1d38,0x5d930));var __createBinding=this&&this['__createBinding']||(Object[a21_0x125ad4(0x1a4)]?function(_0x18a3dc,_0x401aeb,_0xf98ed9,_0x27310b){const _0x1854f7=a21_0x125ad4;if(_0x27310b===undefined)_0x27310b=_0xf98ed9;var _0x4bad2c=Object[_0x1854f7(0x1c6)](_0x401aeb,_0xf98ed9);(!_0x4bad2c||(_0x1854f7(0x191)in _0x4bad2c?!_0x401aeb[_0x1854f7(0x1c1)]:_0x4bad2c['writable']||_0x4bad2c['configurable']))&&(_0x4bad2c={'enumerable':!![],'get':function(){return _0x401aeb[_0xf98ed9];}}),Object['defineProperty'](_0x18a3dc,_0x27310b,_0x4bad2c);}:function(_0xbf142,_0x3ca78f,_0x344944,_0x1cbe77){if(_0x1cbe77===undefined)_0x1cbe77=_0x344944;_0xbf142[_0x1cbe77]=_0x3ca78f[_0x344944];}),__setModuleDefault=this&&this[a21_0x125ad4(0x204)]||(Object[a21_0x125ad4(0x1a4)]?function(_0x7a09b,_0x39e247){const _0xa77b4e=a21_0x125ad4;Object[_0xa77b4e(0x1bf)](_0x7a09b,_0xa77b4e(0x19e),{'enumerable':!![],'value':_0x39e247});}:function(_0x5da200,_0x1eef2f){const _0x1639a0=a21_0x125ad4;_0x5da200[_0x1639a0(0x19e)]=_0x1eef2f;}),__importStar=this&&this['__importStar']||(function(){var _0x58da5a=function(_0x3119ae){const _0x4ec548=a21_0xf5e8;return _0x58da5a=Object[_0x4ec548(0x1dc)]||function(_0x34c53c){const _0x35e4c0=_0x4ec548;var _0x4860e5=[];for(var _0x129b75 in _0x34c53c)if(Object['prototype'][_0x35e4c0(0x1d0)]['call'](_0x34c53c,_0x129b75))_0x4860e5[_0x4860e5[_0x35e4c0(0x1e8)]]=_0x129b75;return _0x4860e5;},_0x58da5a(_0x3119ae);};return function(_0x3f51b0){const _0x4f46ef=a21_0xf5e8;if(_0x3f51b0&&_0x3f51b0[_0x4f46ef(0x1c1)])return _0x3f51b0;var _0x289e7b={};if(_0x3f51b0!=null){for(var _0x1e4cbc=_0x58da5a(_0x3f51b0),_0x4e7c3b=0x0;_0x4e7c3b<_0x1e4cbc['length'];_0x4e7c3b++)if(_0x1e4cbc[_0x4e7c3b]!==_0x4f46ef(0x19e))__createBinding(_0x289e7b,_0x3f51b0,_0x1e4cbc[_0x4e7c3b]);}return __setModuleDefault(_0x289e7b,_0x3f51b0),_0x289e7b;};}()),__importDefault=this&&this[a21_0x125ad4(0x190)]||function(_0x214644){const _0x410bba=a21_0x125ad4;return _0x214644&&_0x214644[_0x410bba(0x1c1)]?_0x214644:{'default':_0x214644};};function a21_0x1d38(){const _0x28c66e=['slice','gatewayPaymentId','now','PAID','toLowerCase',',\x20currentPayments=','Any\x20name','name','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','json','type','amount','findUnique','Any\x20other\x20card\x20number','sendPaymentNotification','sendShopWebhook','failed','processCard','76CppVfX','error','ðŸ§ª\x20Test\x20Gateway\x20result:','318263FQhSMN','Payment\x20failed','customerEmail','params','Payment\x20processed\x20successfully','defineProperty','status','__esModule','includes','Any\x20future\x20date\x20(MM/YY)','replace','digest','getOwnPropertyDescriptor','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','stringify','paid','processCardPayment','POST','transactionId','87106cOGVtD','...','body','hasOwnProperty','not\x20configured','test_gateway','137256hKdNUe','hex','orderId','update','TestGatewayService','shopId','\x20with\x20status\x20','test_card','failureReason','getOwnPropertyNames','\x20not\x20enabled\x20for\x20shop\x20','customerName','âœ…\x20Test\x20Gateway\x20payment\x20','4242\x204242\x204242\x204242','createdAt','PENDING','\x20->\x20','13vZDRAz','../services/gateways/testGatewayService','isArray','80ALYyrS','length','Payment\x20not\x20found','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','currentPayments','../config/database','payment.success',',\x20cannot\x20process','âœ…\x20Payment\x20link\x20','1385328AfpLvs',',\x20status=','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','Payment\x20to\x20','FAILED','webhookUrl','webhookLog','log','cardLast4','ms)','sendPaymentStatusNotification','../services/telegramBotService','test_gateway_','paymentLink','153910ZmfrEu','sha256','ðŸ“ˆ\x20Found\x20payment\x20link\x20','failUrl','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','Any\x203-4\x20digits','__setModuleDefault','gateway','gatewayOrderId','successUrl','webhookService','Payment\x20System/1.0\x20(Test\x20Gateway)','../services/webhookService','SINGLE','ðŸ§ª\x20Sending\x20webhook\x20to\x20','resolve','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','paidAt','webhookEvents','crypto','WebhookService','610KVGlRC','payment','currency','Error\x20parsing\x20webhook\x20events:','__importDefault','get','cardNumber','439271JsPjEv','âš ï¸\x20Webhook\x20event\x20','377604JjzJkU','\x20not\x20found','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','failureMessage','paymentLinkId','TestGatewayController','\x20updated:\x20currentPayments=','Payment\x20is\x20not\x20for\x20test\x20gateway','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','default','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','\x20processed:\x20','COMPLETED','$transaction','shop','create'];a21_0x1d38=function(){return _0x28c66e;};return a21_0x1d38();}Object[a21_0x125ad4(0x1bf)](exports,'__esModule',{'value':!![]}),exports[a21_0x125ad4(0x19a)]=void 0x0;const crypto_1=__importDefault(require(a21_0x125ad4(0x18a))),testGatewayService_1=require(a21_0x125ad4(0x1e5)),webhookService_1=require(a21_0x125ad4(0x20a)),database_1=__importDefault(require(a21_0x125ad4(0x1ec)));class TestGatewayController{constructor(){const _0x56ec19=a21_0x125ad4;this['getPaymentForm']=async(_0x14bf36,_0x4a5b14,_0x1bfbb6)=>{const _0x4569d1=a21_0xf5e8;try{const {paymentId:_0x75e998}=_0x14bf36[_0x4569d1(0x1bd)];console[_0x4569d1(0x1f7)](_0x4569d1(0x1ea)+_0x75e998);const _0x35cd5c=await database_1[_0x4569d1(0x19e)][_0x4569d1(0x18d)][_0x4569d1(0x1b1)]({'where':{'id':_0x75e998},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x35cd5c)return _0x4a5b14[_0x4569d1(0x1c0)](0x194)[_0x4569d1(0x1ae)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x35cd5c[_0x4569d1(0x205)]!==_0x4569d1(0x1d2))return _0x4a5b14[_0x4569d1(0x1c0)](0x190)[_0x4569d1(0x1ae)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x35cd5c[_0x4569d1(0x1c0)]!=='PENDING')return _0x4a5b14[_0x4569d1(0x1c0)](0x190)[_0x4569d1(0x1ae)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x35cd5c['status']+_0x4569d1(0x1ee)});_0x4a5b14['json']({'success':!![],'result':{'paymentId':_0x35cd5c['id'],'orderId':_0x35cd5c[_0x4569d1(0x206)],'amount':_0x35cd5c['amount'],'currency':_0x35cd5c[_0x4569d1(0x18e)],'merchantName':_0x35cd5c[_0x4569d1(0x1a3)][_0x4569d1(0x1ac)],'description':_0x4569d1(0x1f3)+_0x35cd5c[_0x4569d1(0x1a3)][_0x4569d1(0x1ac)],'testInstructions':{'successCard':_0x4569d1(0x1e0),'failureCard':_0x4569d1(0x1b2),'expiryDate':_0x4569d1(0x1c3),'cvc':_0x4569d1(0x203),'holderName':_0x4569d1(0x1ab)}}});}catch(_0x5be447){_0x1bfbb6(_0x5be447);}},this[_0x56ec19(0x1b6)]=async(_0x30eae5,_0x38980a,_0x5d4289)=>{const _0x5ce470=_0x56ec19;try{const {paymentId:_0x3ee757}=_0x30eae5['params'],_0x494f9b=_0x30eae5[_0x5ce470(0x1cf)];console[_0x5ce470(0x1f7)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3ee757);const _0xb7b3ba=await database_1[_0x5ce470(0x19e)]['payment'][_0x5ce470(0x1b1)]({'where':{'id':_0x3ee757},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb7b3ba)return _0x38980a[_0x5ce470(0x1c0)](0x194)[_0x5ce470(0x1ae)]({'success':![],'message':_0x5ce470(0x1e9)});if(_0xb7b3ba[_0x5ce470(0x205)]!==_0x5ce470(0x1d2))return _0x38980a[_0x5ce470(0x1c0)](0x190)['json']({'success':![],'message':_0x5ce470(0x19c)});if(_0xb7b3ba['status']!=='PENDING')return _0x38980a[_0x5ce470(0x1c0)](0x190)[_0x5ce470(0x1ae)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0xb7b3ba[_0x5ce470(0x1c0)]+_0x5ce470(0x1ee)});const _0x35d408=await this['testGatewayService'][_0x5ce470(0x1ca)]({'paymentId':_0xb7b3ba['id'],'orderId':_0xb7b3ba[_0x5ce470(0x206)]||_0xb7b3ba['id'],'amount':_0xb7b3ba[_0x5ce470(0x1b0)],'currency':_0xb7b3ba['currency'],'cardData':_0x494f9b});console[_0x5ce470(0x1f7)](_0x5ce470(0x1b9),_0x35d408);const _0x24b08a={'status':_0x35d408[_0x5ce470(0x1c0)],'updatedAt':new Date()};if(_0x35d408[_0x5ce470(0x1c0)]===_0x5ce470(0x1a8))_0x24b08a[_0x5ce470(0x188)]=new Date(),_0x24b08a[_0x5ce470(0x1a6)]=_0x35d408[_0x5ce470(0x1cc)];else _0x35d408[_0x5ce470(0x1c0)]===_0x5ce470(0x1f4)&&(_0x24b08a[_0x5ce470(0x198)]=_0x35d408['failureReason']);const _0x323be1=_0x494f9b[_0x5ce470(0x192)][_0x5ce470(0x1c4)](/[\s-]/g,'');_0x24b08a[_0x5ce470(0x1f8)]=_0x323be1[_0x5ce470(0x1a5)](-0x4),_0x24b08a['paymentMethod']=_0x5ce470(0x1da),await database_1['default'][_0x5ce470(0x18d)][_0x5ce470(0x1d6)]({'where':{'id':_0xb7b3ba['id']},'data':_0x24b08a});if(_0x35d408['status']===_0x5ce470(0x1a8)&&_0xb7b3ba[_0x5ce470(0x199)]){console['log'](_0x5ce470(0x1f2)+_0xb7b3ba['id']+_0x5ce470(0x197));try{await database_1[_0x5ce470(0x19e)][_0x5ce470(0x1a2)](async _0x531c96=>{const _0x19b86e=_0x5ce470,_0x543269=await _0x531c96[_0x19b86e(0x1fd)]['findUnique']({'where':{'id':_0xb7b3ba[_0x19b86e(0x199)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x543269){console[_0x19b86e(0x1f7)](_0x19b86e(0x200)+_0x543269['id']+':\x20type='+_0x543269[_0x19b86e(0x1af)]+_0x19b86e(0x1aa)+_0x543269[_0x19b86e(0x1eb)]+_0x19b86e(0x1f1)+_0x543269[_0x19b86e(0x1c0)]);const _0xe22a74=_0x543269[_0x19b86e(0x1eb)]+0x1,_0x358070=_0x543269['type']===_0x19b86e(0x184)?_0x19b86e(0x1a1):_0x543269[_0x19b86e(0x1c0)];await _0x531c96[_0x19b86e(0x1fd)][_0x19b86e(0x1d6)]({'where':{'id':_0xb7b3ba[_0x19b86e(0x199)]},'data':{'currentPayments':_0xe22a74,'status':_0x358070,'updatedAt':new Date()}}),console[_0x19b86e(0x1f7)](_0x19b86e(0x1ef)+_0x543269['id']+_0x19b86e(0x19b)+_0x543269['currentPayments']+_0x19b86e(0x1e3)+_0xe22a74+_0x19b86e(0x1f1)+_0x543269['status']+_0x19b86e(0x1e3)+_0x358070);}else console[_0x19b86e(0x1f7)]('âŒ\x20Payment\x20link\x20'+_0xb7b3ba[_0x19b86e(0x199)]+_0x19b86e(0x196));});}catch(_0x3b48a3){console[_0x5ce470(0x1b8)]('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x3b48a3);}}await database_1[_0x5ce470(0x19e)][_0x5ce470(0x1f6)]['create']({'data':{'paymentId':_0xb7b3ba['id'],'shopId':_0xb7b3ba['shopId'],'event':_0x5ce470(0x1fc)+_0x35d408[_0x5ce470(0x1c0)]['toLowerCase'](),'statusCode':_0x35d408[_0x5ce470(0x1c0)]===_0x5ce470(0x1a8)?0xc8:0x190,'responseBody':JSON[_0x5ce470(0x1c8)]({'oldStatus':_0x5ce470(0x1e2),'newStatus':_0x35d408[_0x5ce470(0x1c0)],'transactionId':_0x35d408['transactionId'],'failureReason':_0x35d408[_0x5ce470(0x1db)],'processedAt':new Date()['toISOString']()})}}),console['log'](_0x5ce470(0x202)+_0x35d408['status']+_0x5ce470(0x1ce)),await this['sendShopWebhook'](_0xb7b3ba,_0x35d408[_0x5ce470(0x1c0)],_0x35d408['transactionId'],_0x35d408[_0x5ce470(0x1db)]),console[_0x5ce470(0x1f7)](_0x5ce470(0x19f)+_0x35d408[_0x5ce470(0x1c0)]),console[_0x5ce470(0x1f7)]('ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20'+_0x35d408['status']+_0x5ce470(0x1ce)),await this[_0x5ce470(0x1fa)](_0xb7b3ba,_0x35d408[_0x5ce470(0x1c0)]),console[_0x5ce470(0x1f7)]('ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20'+_0x35d408[_0x5ce470(0x1c0)]),console[_0x5ce470(0x1f7)](_0x5ce470(0x1df)+_0x3ee757+_0x5ce470(0x1a0)+_0x35d408[_0x5ce470(0x1c0)]),_0x35d408[_0x5ce470(0x1c0)]==='PAID'?_0x38980a[_0x5ce470(0x1ae)]({'success':!![],'message':_0x5ce470(0x1be),'result':{'status':_0x5ce470(0x1a8),'transactionId':_0x35d408['transactionId'],'redirectUrl':_0xb7b3ba[_0x5ce470(0x207)]}}):_0x38980a['status'](0x190)['json']({'success':![],'message':_0x5ce470(0x1bb),'result':{'status':'FAILED','failureReason':_0x35d408['failureReason'],'redirectUrl':_0xb7b3ba[_0x5ce470(0x201)]}});}catch(_0xd0775c){_0x5d4289(_0xd0775c);}},this['testGatewayService']=new testGatewayService_1[(_0x56ec19(0x1d7))](),this[_0x56ec19(0x208)]=new webhookService_1[(_0x56ec19(0x18b))]();}async[a21_0x125ad4(0x1b4)](_0x5f2916,_0x2d1cfd,_0xda949e,_0x2db1c0){const _0x2d4b71=a21_0x125ad4,_0x296f72=Date[_0x2d4b71(0x1a7)]();try{const _0x239785=_0x5f2916[_0x2d4b71(0x1a3)],_0x329b2d=_0x239785['settings'];if(!_0x329b2d?.[_0x2d4b71(0x1f5)]){console[_0x2d4b71(0x1f7)](_0x2d4b71(0x1c7)+_0x239785['id']);return;}const _0x54da67=_0x2d1cfd===_0x2d4b71(0x1a8)?_0x2d4b71(0x1ed):'payment.failed';console['log']('ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event='+_0x54da67+',\x20webhookUrl='+(_0x329b2d[_0x2d4b71(0x1f5)]?'configured':_0x2d4b71(0x1d1)));let _0x11db6b=[];if(_0x329b2d['webhookEvents'])try{_0x11db6b=Array[_0x2d4b71(0x1e6)](_0x329b2d[_0x2d4b71(0x189)])?_0x329b2d[_0x2d4b71(0x189)]:JSON['parse'](_0x329b2d['webhookEvents']);}catch(_0x2d8de8){console[_0x2d4b71(0x1b8)](_0x2d4b71(0x18f),_0x2d8de8),_0x11db6b=[];}console[_0x2d4b71(0x1f7)](_0x2d4b71(0x19d),_0x11db6b);if(!_0x11db6b[_0x2d4b71(0x1c2)](_0x54da67)){console['log'](_0x2d4b71(0x194)+_0x54da67+_0x2d4b71(0x1dd)+_0x239785['id']);return;}const _0x32060c={'event':_0x54da67,'payment':{'id':_0x5f2916['id'],'order_id':_0x5f2916[_0x2d4b71(0x1d5)],'gateway_order_id':_0x5f2916['gatewayOrderId'],'gateway':'0000','amount':_0x5f2916[_0x2d4b71(0x1b0)],'currency':_0x5f2916[_0x2d4b71(0x18e)],'status':_0x2d1cfd[_0x2d4b71(0x1a9)](),'customer_email':_0x5f2916[_0x2d4b71(0x1bc)],'customer_name':_0x5f2916[_0x2d4b71(0x1de)],'transaction_id':_0xda949e,'failure_message':_0x2db1c0,'created_at':_0x5f2916[_0x2d4b71(0x1e1)],'updated_at':new Date()}};console['log'](_0x2d4b71(0x185)+_0x329b2d['webhookUrl']+_0x2d4b71(0x1ce)),console[_0x2d4b71(0x1f7)]('ðŸ§ª\x20Webhook\x20payload:',JSON['stringify'](_0x32060c,null,0x2));const _0x455815=JSON[_0x2d4b71(0x1c8)](_0x32060c),_0x29da71=crypto_1['default']['createHmac'](_0x2d4b71(0x1ff),_0x239785['secretKey'])[_0x2d4b71(0x1d6)](_0x455815)[_0x2d4b71(0x1c5)](_0x2d4b71(0x1d4)),_0xc0c612=await fetch(_0x329b2d['webhookUrl'],{'method':_0x2d4b71(0x1cb),'headers':{'Content-Type':'application/json','User-Agent':_0x2d4b71(0x209),'X-Webhook-Signature':_0x29da71},'body':_0x455815}),_0x18fda8=Date[_0x2d4b71(0x1a7)]()-_0x296f72;console[_0x2d4b71(0x1f7)](_0x2d4b71(0x1ad)+_0x329b2d[_0x2d4b71(0x1f5)]+_0x2d4b71(0x1d9)+_0xc0c612['status']+'\x20('+_0x18fda8+_0x2d4b71(0x1f9));}catch(_0xe68f76){console[_0x2d4b71(0x1b8)](_0x2d4b71(0x187),_0xe68f76);}}async['sendPaymentStatusNotification'](_0x588ae2,_0x4b49ac){const _0x3eaa23=a21_0x125ad4;try{const {telegramBotService:_0x43bbcf}=await Promise[_0x3eaa23(0x186)]()['then'](()=>__importStar(require(_0x3eaa23(0x1fb)))),_0x557cfb={'PAID':_0x3eaa23(0x1c9),'FAILED':_0x3eaa23(0x1b5)},_0xe97bcf=_0x557cfb[_0x4b49ac];if(!_0xe97bcf)return;await _0x43bbcf[_0x3eaa23(0x1b3)](_0x588ae2[_0x3eaa23(0x1d8)],_0x588ae2,_0xe97bcf);}catch(_0x29e70d){console[_0x3eaa23(0x1b8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x29e70d);}}}exports[a21_0x125ad4(0x19a)]=TestGatewayController;