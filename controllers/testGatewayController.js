'use strict';const a13_0x2b299c=a13_0x5bd8;function a13_0x5cd6(){const _0x2422d5=['webhookService','create','status','payment.success','webhookEvents','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','json','gatewayOrderId','582ecRBKc','default','payment','sendPaymentStatusNotification','gatewayPaymentId','isArray','Any\x20other\x20card\x20number','sendPaymentNotification','payment.failed','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','paymentMethod','2100258xUSvgH','PAID','error','__setModuleDefault','failureMessage','settings','1fcOMpu','body','8JsQtxX','getOwnPropertyNames','findUnique','\x20with\x20status\x20','currency','now','shop','Payment\x20not\x20found','customerName','Payment\x20failed','WebhookService','Payment\x20is\x20not\x20for\x20test\x20gateway','log','10884qNBKDt','paidAt','../services/gateways/testGatewayService','POST','amount','call','40LcvWNy','shopId','length','hasOwnProperty','params','testGatewayService','TestGatewayController','application/json','webhookUrl','2082858rmXfOi',',\x20cannot\x20process','455402ffzRES','webhookLog','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','then','FAILED','orderId','get','Error\x20parsing\x20webhook\x20events:','failUrl','gateway','../services/webhookService','__importDefault','transactionId','\x20processed:\x20','11595272sGEOAl','test_card','../services/telegramBotService','paid','0000','\x20not\x20enabled\x20for\x20shop\x20','11310201XgpkdC','Webhook\x20event\x20','Any\x203-4\x20digits','processCardPayment','defineProperty','stringify','cardNumber','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','slice','configurable','test_gateway','TestGatewayService','test_gateway_','Any\x20future\x20date\x20(MM/YY)','Payment\x20to\x20','PENDING','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','sendShopWebhook','14905mEWmwE','includes','__importStar','10865EpwDEO','__esModule','âœ…\x20Test\x20Gateway\x20payment\x20','failureReason'];a13_0x5cd6=function(){return _0x2422d5;};return a13_0x5cd6();}(function(_0x4e72e6,_0x1840a6){const _0x46bd91=a13_0x5bd8,_0x44ed7c=_0x4e72e6();while(!![]){try{const _0x594236=-parseInt(_0x46bd91(0x1a8))/0x1*(parseInt(_0x46bd91(0x1c8))/0x2)+parseInt(_0x46bd91(0x1c6))/0x3*(-parseInt(_0x46bd91(0x1aa))/0x4)+parseInt(_0x46bd91(0x1f1))/0x5*(-parseInt(_0x46bd91(0x197))/0x6)+parseInt(_0x46bd91(0x1dc))/0x7+parseInt(_0x46bd91(0x1d6))/0x8+parseInt(_0x46bd91(0x1a2))/0x9*(parseInt(_0x46bd91(0x1bd))/0xa)+-parseInt(_0x46bd91(0x1ee))/0xb*(parseInt(_0x46bd91(0x1b7))/0xc);if(_0x594236===_0x1840a6)break;else _0x44ed7c['push'](_0x44ed7c['shift']());}catch(_0x3c5101){_0x44ed7c['push'](_0x44ed7c['shift']());}}}(a13_0x5cd6,0xe61e1));var __createBinding=this&&this['__createBinding']||(Object[a13_0x2b299c(0x1f6)]?function(_0x148b2d,_0x408064,_0x2444ba,_0x3bebb5){const _0x5acd01=a13_0x2b299c;if(_0x3bebb5===undefined)_0x3bebb5=_0x2444ba;var _0x3fb566=Object['getOwnPropertyDescriptor'](_0x408064,_0x2444ba);(!_0x3fb566||(_0x5acd01(0x1ce)in _0x3fb566?!_0x408064[_0x5acd01(0x1f2)]:_0x3fb566['writable']||_0x3fb566[_0x5acd01(0x1e5)]))&&(_0x3fb566={'enumerable':!![],'get':function(){return _0x408064[_0x2444ba];}}),Object['defineProperty'](_0x148b2d,_0x3bebb5,_0x3fb566);}:function(_0xfd301f,_0x129506,_0x2168ae,_0x59bc3e){if(_0x59bc3e===undefined)_0x59bc3e=_0x2168ae;_0xfd301f[_0x59bc3e]=_0x129506[_0x2168ae];}),__setModuleDefault=this&&this[a13_0x2b299c(0x1a5)]||(Object[a13_0x2b299c(0x1f6)]?function(_0x28b09a,_0x4d0ad6){const _0x1412ad=a13_0x2b299c;Object[_0x1412ad(0x1e0)](_0x28b09a,_0x1412ad(0x198),{'enumerable':!![],'value':_0x4d0ad6});}:function(_0x279bb6,_0xd2b4bf){const _0x5ee598=a13_0x2b299c;_0x279bb6[_0x5ee598(0x198)]=_0xd2b4bf;}),__importStar=this&&this[a13_0x2b299c(0x1f0)]||(function(){var _0x56e0c4=function(_0x21b947){const _0xda9896=a13_0x5bd8;return _0x56e0c4=Object[_0xda9896(0x1ab)]||function(_0x4fd078){const _0x247280=_0xda9896;var _0x43628b=[];for(var _0x48071a in _0x4fd078)if(Object['prototype'][_0x247280(0x1c0)][_0x247280(0x1bc)](_0x4fd078,_0x48071a))_0x43628b[_0x43628b['length']]=_0x48071a;return _0x43628b;},_0x56e0c4(_0x21b947);};return function(_0x2ae841){const _0xdc6cb9=a13_0x5bd8;if(_0x2ae841&&_0x2ae841[_0xdc6cb9(0x1f2)])return _0x2ae841;var _0x37c92d={};if(_0x2ae841!=null){for(var _0x58048c=_0x56e0c4(_0x2ae841),_0x1ade93=0x0;_0x1ade93<_0x58048c[_0xdc6cb9(0x1bf)];_0x1ade93++)if(_0x58048c[_0x1ade93]!==_0xdc6cb9(0x198))__createBinding(_0x37c92d,_0x2ae841,_0x58048c[_0x1ade93]);}return __setModuleDefault(_0x37c92d,_0x2ae841),_0x37c92d;};}()),__importDefault=this&&this[a13_0x2b299c(0x1d3)]||function(_0x63bf14){const _0x288ca8=a13_0x2b299c;return _0x63bf14&&_0x63bf14[_0x288ca8(0x1f2)]?_0x63bf14:{'default':_0x63bf14};};Object[a13_0x2b299c(0x1e0)](exports,a13_0x2b299c(0x1f2),{'value':!![]}),exports[a13_0x2b299c(0x1c3)]=void 0x0;const testGatewayService_1=require(a13_0x2b299c(0x1b9)),webhookService_1=require(a13_0x2b299c(0x1d2)),database_1=__importDefault(require('../config/database'));function a13_0x5bd8(_0x17e907,_0x3c1854){const _0x5cd698=a13_0x5cd6();return a13_0x5bd8=function(_0x5bd86f,_0x1b5aed){_0x5bd86f=_0x5bd86f-0x193;let _0xc42c95=_0x5cd698[_0x5bd86f];return _0xc42c95;},a13_0x5bd8(_0x17e907,_0x3c1854);}class TestGatewayController{constructor(){const _0x5eb31e=a13_0x2b299c;this['getPaymentForm']=async(_0x33c746,_0x20f2a7,_0x4348a1)=>{const _0x49067c=a13_0x5bd8;try{const {paymentId:_0x4bf8e3}=_0x33c746['params'];console[_0x49067c(0x1b6)](_0x49067c(0x1ca)+_0x4bf8e3);const _0x4f8ceb=await database_1['default'][_0x49067c(0x199)]['findUnique']({'where':{'id':_0x4bf8e3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4f8ceb)return _0x20f2a7['status'](0x194)[_0x49067c(0x195)]({'success':![],'message':_0x49067c(0x1b1)});if(_0x4f8ceb[_0x49067c(0x1d1)]!==_0x49067c(0x1e6))return _0x20f2a7[_0x49067c(0x1f7)](0x190)[_0x49067c(0x195)]({'success':![],'message':_0x49067c(0x1b5)});if(_0x4f8ceb['status']!=='PENDING')return _0x20f2a7[_0x49067c(0x1f7)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4f8ceb[_0x49067c(0x1f7)]+_0x49067c(0x1c7)});_0x20f2a7[_0x49067c(0x195)]({'success':!![],'result':{'paymentId':_0x4f8ceb['id'],'orderId':_0x4f8ceb['gatewayOrderId'],'amount':_0x4f8ceb[_0x49067c(0x1bb)],'currency':_0x4f8ceb[_0x49067c(0x1ae)],'merchantName':_0x4f8ceb[_0x49067c(0x1b0)]['name'],'description':_0x49067c(0x1ea)+_0x4f8ceb[_0x49067c(0x1b0)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x49067c(0x19d),'expiryDate':_0x49067c(0x1e9),'cvc':_0x49067c(0x1de),'holderName':'Any\x20name'}}});}catch(_0x21a63b){_0x4348a1(_0x21a63b);}},this['processCard']=async(_0x3ca7a0,_0x393b61,_0x39dfbf)=>{const _0x46b0c7=a13_0x5bd8;try{const {paymentId:_0x3447b1}=_0x3ca7a0[_0x46b0c7(0x1c1)],_0x5902d7=_0x3ca7a0[_0x46b0c7(0x1a9)];console[_0x46b0c7(0x1b6)](_0x46b0c7(0x1ec)+_0x3447b1);const _0x4fe6eb=await database_1['default']['payment'][_0x46b0c7(0x1ac)]({'where':{'id':_0x3447b1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4fe6eb)return _0x393b61['status'](0x194)[_0x46b0c7(0x195)]({'success':![],'message':_0x46b0c7(0x1b1)});if(_0x4fe6eb[_0x46b0c7(0x1d1)]!==_0x46b0c7(0x1e6))return _0x393b61[_0x46b0c7(0x1f7)](0x190)[_0x46b0c7(0x195)]({'success':![],'message':_0x46b0c7(0x1b5)});if(_0x4fe6eb[_0x46b0c7(0x1f7)]!==_0x46b0c7(0x1eb))return _0x393b61[_0x46b0c7(0x1f7)](0x190)[_0x46b0c7(0x195)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4fe6eb['status']+_0x46b0c7(0x1c7)});const _0x1f7932=await this['testGatewayService'][_0x46b0c7(0x1df)]({'paymentId':_0x4fe6eb['id'],'orderId':_0x4fe6eb[_0x46b0c7(0x196)]||_0x4fe6eb['id'],'amount':_0x4fe6eb['amount'],'currency':_0x4fe6eb[_0x46b0c7(0x1ae)],'cardData':_0x5902d7});console[_0x46b0c7(0x1b6)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x1f7932);const _0x3f5555={'status':_0x1f7932[_0x46b0c7(0x1f7)],'updatedAt':new Date()};if(_0x1f7932['status']===_0x46b0c7(0x1a3))_0x3f5555[_0x46b0c7(0x1b8)]=new Date(),_0x3f5555[_0x46b0c7(0x19b)]=_0x1f7932[_0x46b0c7(0x1d4)];else _0x1f7932[_0x46b0c7(0x1f7)]===_0x46b0c7(0x1cc)&&(_0x3f5555[_0x46b0c7(0x1a6)]=_0x1f7932['failureReason']);const _0x196316=_0x5902d7[_0x46b0c7(0x1e2)]['replace'](/[\s-]/g,'');_0x3f5555['cardLast4']=_0x196316[_0x46b0c7(0x1e4)](-0x4),_0x3f5555[_0x46b0c7(0x1a1)]=_0x46b0c7(0x1d7),await database_1[_0x46b0c7(0x198)][_0x46b0c7(0x199)]['update']({'where':{'id':_0x4fe6eb['id']},'data':_0x3f5555}),await database_1[_0x46b0c7(0x198)][_0x46b0c7(0x1c9)][_0x46b0c7(0x1f6)]({'data':{'paymentId':_0x4fe6eb['id'],'shopId':_0x4fe6eb[_0x46b0c7(0x1be)],'event':_0x46b0c7(0x1e8)+_0x1f7932['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x46b0c7(0x1eb),'newStatus':_0x1f7932[_0x46b0c7(0x1f7)],'transactionId':_0x1f7932['transactionId'],'failureReason':_0x1f7932[_0x46b0c7(0x1f4)],'processedAt':new Date()['toISOString']()})}}),await this[_0x46b0c7(0x1ed)](_0x4fe6eb,_0x1f7932[_0x46b0c7(0x1f7)],_0x1f7932['transactionId'],_0x1f7932[_0x46b0c7(0x1f4)]),await this[_0x46b0c7(0x19a)](_0x4fe6eb,_0x1f7932[_0x46b0c7(0x1f7)]),console[_0x46b0c7(0x1b6)](_0x46b0c7(0x1f3)+_0x3447b1+_0x46b0c7(0x1d5)+_0x1f7932[_0x46b0c7(0x1f7)]),_0x1f7932[_0x46b0c7(0x1f7)]===_0x46b0c7(0x1a3)?_0x393b61[_0x46b0c7(0x195)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x46b0c7(0x1a3),'transactionId':_0x1f7932[_0x46b0c7(0x1d4)],'redirectUrl':_0x4fe6eb['successUrl']}}):_0x393b61[_0x46b0c7(0x1f7)](0x190)['json']({'success':![],'message':_0x46b0c7(0x1b3),'result':{'status':'FAILED','failureReason':_0x1f7932[_0x46b0c7(0x1f4)],'redirectUrl':_0x4fe6eb[_0x46b0c7(0x1d0)]}});}catch(_0x40f859){_0x39dfbf(_0x40f859);}},this[_0x5eb31e(0x1c2)]=new testGatewayService_1[(_0x5eb31e(0x1e7))](),this[_0x5eb31e(0x1f5)]=new webhookService_1[(_0x5eb31e(0x1b4))]();}async[a13_0x2b299c(0x1ed)](_0x309bd2,_0x288b1b,_0x439376,_0x508de8){const _0xb6fcd9=a13_0x2b299c,_0x84ecb=Date[_0xb6fcd9(0x1af)]();try{const _0x4d9805=_0x309bd2[_0xb6fcd9(0x1b0)],_0x27a154=_0x4d9805[_0xb6fcd9(0x1a7)];if(!_0x27a154?.[_0xb6fcd9(0x1c5)]){console[_0xb6fcd9(0x1b6)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4d9805['id']);return;}const _0x4c4885=_0x288b1b===_0xb6fcd9(0x1a3)?_0xb6fcd9(0x1f8):_0xb6fcd9(0x19f);let _0x4ef3f8=[];if(_0x27a154[_0xb6fcd9(0x193)])try{_0x4ef3f8=Array[_0xb6fcd9(0x19c)](_0x27a154[_0xb6fcd9(0x193)])?_0x27a154[_0xb6fcd9(0x193)]:JSON['parse'](_0x27a154[_0xb6fcd9(0x193)]);}catch(_0x33004f){console[_0xb6fcd9(0x1a4)](_0xb6fcd9(0x1cf),_0x33004f),_0x4ef3f8=[];}if(!_0x4ef3f8[_0xb6fcd9(0x1ef)](_0x4c4885)){console[_0xb6fcd9(0x1b6)](_0xb6fcd9(0x1dd)+_0x4c4885+_0xb6fcd9(0x1db)+_0x4d9805['id']);return;}const _0x947490={'event':_0x4c4885,'payment':{'id':_0x309bd2['id'],'order_id':_0x309bd2[_0xb6fcd9(0x1cd)],'gateway_order_id':_0x309bd2[_0xb6fcd9(0x196)],'gateway':_0xb6fcd9(0x1da),'amount':_0x309bd2[_0xb6fcd9(0x1bb)],'currency':_0x309bd2[_0xb6fcd9(0x1ae)],'status':_0x288b1b['toLowerCase'](),'customer_email':_0x309bd2['customerEmail'],'customer_name':_0x309bd2[_0xb6fcd9(0x1b2)],'transaction_id':_0x439376,'failure_message':_0x508de8,'created_at':_0x309bd2['createdAt'],'updated_at':new Date()}},_0x25f87a=await fetch(_0x27a154[_0xb6fcd9(0x1c5)],{'method':_0xb6fcd9(0x1ba),'headers':{'Content-Type':_0xb6fcd9(0x1c4),'User-Agent':_0xb6fcd9(0x1a0)},'body':JSON[_0xb6fcd9(0x1e1)](_0x947490)}),_0x1dd56e=Date[_0xb6fcd9(0x1af)]()-_0x84ecb;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x27a154[_0xb6fcd9(0x1c5)]+_0xb6fcd9(0x1ad)+_0x25f87a[_0xb6fcd9(0x1f7)]+'\x20('+_0x1dd56e+'ms)');}catch(_0x44a23e){console[_0xb6fcd9(0x1a4)](_0xb6fcd9(0x1e3),_0x44a23e);}}async[a13_0x2b299c(0x19a)](_0x405f0e,_0x42271b){const _0x5e7a04=a13_0x2b299c;try{const {telegramBotService:_0x4971e2}=await Promise['resolve']()[_0x5e7a04(0x1cb)](()=>__importStar(require(_0x5e7a04(0x1d8)))),_0x40c096={'PAID':_0x5e7a04(0x1d9),'FAILED':'failed'},_0x134e61=_0x40c096[_0x42271b];if(!_0x134e61)return;await _0x4971e2[_0x5e7a04(0x19e)](_0x405f0e[_0x5e7a04(0x1be)],_0x405f0e,_0x134e61);}catch(_0x5d03e3){console[_0x5e7a04(0x1a4)](_0x5e7a04(0x194),_0x5d03e3);}}}exports['TestGatewayController']=TestGatewayController;