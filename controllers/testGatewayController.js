'use strict';const a13_0x29361c=a13_0x2a0c;(function(_0x46bc9a,_0x5c676f){const _0x5442ab=a13_0x2a0c,_0x17b45f=_0x46bc9a();while(!![]){try{const _0x121111=parseInt(_0x5442ab(0x1d4))/0x1*(parseInt(_0x5442ab(0x218))/0x2)+parseInt(_0x5442ab(0x227))/0x3+parseInt(_0x5442ab(0x231))/0x4+parseInt(_0x5442ab(0x209))/0x5+parseInt(_0x5442ab(0x223))/0x6*(-parseInt(_0x5442ab(0x1e7))/0x7)+-parseInt(_0x5442ab(0x1f6))/0x8*(parseInt(_0x5442ab(0x20b))/0x9)+-parseInt(_0x5442ab(0x1d9))/0xa;if(_0x121111===_0x5c676f)break;else _0x17b45f['push'](_0x17b45f['shift']());}catch(_0x381c23){_0x17b45f['push'](_0x17b45f['shift']());}}}(a13_0x34a3,0xa10d7));var __createBinding=this&&this[a13_0x29361c(0x1dc)]||(Object[a13_0x29361c(0x204)]?function(_0x1ebff8,_0x54b05a,_0x42519c,_0x18fdaa){const _0x404c59=a13_0x29361c;if(_0x18fdaa===undefined)_0x18fdaa=_0x42519c;var _0x4c90c5=Object[_0x404c59(0x229)](_0x54b05a,_0x42519c);(!_0x4c90c5||(_0x404c59(0x235)in _0x4c90c5?!_0x54b05a[_0x404c59(0x1ef)]:_0x4c90c5[_0x404c59(0x1f2)]||_0x4c90c5[_0x404c59(0x22a)]))&&(_0x4c90c5={'enumerable':!![],'get':function(){return _0x54b05a[_0x42519c];}}),Object['defineProperty'](_0x1ebff8,_0x18fdaa,_0x4c90c5);}:function(_0xfdce2f,_0x56314b,_0x3c7ce8,_0xf41442){if(_0xf41442===undefined)_0xf41442=_0x3c7ce8;_0xfdce2f[_0xf41442]=_0x56314b[_0x3c7ce8];}),__setModuleDefault=this&&this[a13_0x29361c(0x1ee)]||(Object[a13_0x29361c(0x204)]?function(_0xebaa0b,_0x1c3132){const _0x17c82c=a13_0x29361c;Object[_0x17c82c(0x22e)](_0xebaa0b,_0x17c82c(0x1fa),{'enumerable':!![],'value':_0x1c3132});}:function(_0x1fd88d,_0xf76d1){const _0x3b7288=a13_0x29361c;_0x1fd88d[_0x3b7288(0x1fa)]=_0xf76d1;}),__importStar=this&&this[a13_0x29361c(0x23b)]||(function(){var _0x40e3a4=function(_0x445702){const _0x17b872=a13_0x2a0c;return _0x40e3a4=Object[_0x17b872(0x1db)]||function(_0xd20aa5){const _0x1e6b61=_0x17b872;var _0x4c210f=[];for(var _0x5b0406 in _0xd20aa5)if(Object[_0x1e6b61(0x22b)][_0x1e6b61(0x212)][_0x1e6b61(0x225)](_0xd20aa5,_0x5b0406))_0x4c210f[_0x4c210f[_0x1e6b61(0x1fd)]]=_0x5b0406;return _0x4c210f;},_0x40e3a4(_0x445702);};return function(_0x110e1e){const _0x16e38a=a13_0x2a0c;if(_0x110e1e&&_0x110e1e[_0x16e38a(0x1ef)])return _0x110e1e;var _0x384bef={};if(_0x110e1e!=null){for(var _0xe2524a=_0x40e3a4(_0x110e1e),_0x4c0c56=0x0;_0x4c0c56<_0xe2524a['length'];_0x4c0c56++)if(_0xe2524a[_0x4c0c56]!==_0x16e38a(0x1fa))__createBinding(_0x384bef,_0x110e1e,_0xe2524a[_0x4c0c56]);}return __setModuleDefault(_0x384bef,_0x110e1e),_0x384bef;};}()),__importDefault=this&&this[a13_0x29361c(0x234)]||function(_0x274d53){const _0x121684=a13_0x29361c;return _0x274d53&&_0x274d53[_0x121684(0x1ef)]?_0x274d53:{'default':_0x274d53};};Object[a13_0x29361c(0x22e)](exports,a13_0x29361c(0x1ef),{'value':!![]}),exports[a13_0x29361c(0x233)]=void 0x0;function a13_0x34a3(){const _0x2b4e9d=['getPaymentForm','TestGatewayController','__importDefault','get','paid','failUrl','cardLast4','TestGatewayService','FAILED','__importStar','resolve','Any\x203-4\x20digits','parse','sendPaymentNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','1QUqRDn','../services/gateways/testGatewayService','4242\x204242\x204242\x204242','Payment\x20to\x20','processCard','7377090SQhqlW','name','getOwnPropertyNames','__createBinding','shopId','failureMessage','toISOString','webhookLog','Payment\x20not\x20found','payment.failed','shop','amount','Payment\x20failed','update','14TgHqNy','paidAt','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','PENDING','params','now','then','__setModuleDefault','__esModule','\x20not\x20enabled\x20for\x20shop\x20','0000','writable','PAID','test_gateway','sendPaymentStatusNotification','8ZLxdbD','gatewayOrderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','default','customerEmail','createdAt','length','gateway','toLowerCase','webhookEvents','processCardPayment','WebhookService','webhookService','create','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','test_card','Any\x20future\x20date\x20(MM/YY)','application/json','4466490BIJCQX','replace','7149339pgYghw','error','payment','findUnique','currency','orderId','cardNumber','hasOwnProperty','sendShopWebhook','status','customerName','json','body','2117084taTgrD','includes','Error\x20parsing\x20webhook\x20events:','transactionId','Any\x20other\x20card\x20number','successUrl','../config/database','test_gateway_','\x20with\x20status\x20','failureReason','gatewayPaymentId','1923174IluFnB','testGatewayService','call','webhookUrl','895068roYFVW','settings','getOwnPropertyDescriptor','configurable','prototype',',\x20cannot\x20process','stringify','defineProperty','slice','paymentMethod','2330452NBsfgj'];a13_0x34a3=function(){return _0x2b4e9d;};return a13_0x34a3();}function a13_0x2a0c(_0x2d97bc,_0x2595fe){const _0x34a37e=a13_0x34a3();return a13_0x2a0c=function(_0x2a0c28,_0x33582a){_0x2a0c28=_0x2a0c28-0x1d3;let _0x5f2d75=_0x34a37e[_0x2a0c28];return _0x5f2d75;},a13_0x2a0c(_0x2d97bc,_0x2595fe);}const testGatewayService_1=require(a13_0x29361c(0x1d5)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x29361c(0x21e)));class TestGatewayController{constructor(){const _0x16129d=a13_0x29361c;this[_0x16129d(0x232)]=async(_0x112882,_0x5e24e2,_0x607a26)=>{const _0x2a28fc=_0x16129d;try{const {paymentId:_0x4156ba}=_0x112882[_0x2a28fc(0x1eb)];console[_0x2a28fc(0x1d3)](_0x2a28fc(0x205)+_0x4156ba);const _0x561c15=await database_1['default'][_0x2a28fc(0x20d)][_0x2a28fc(0x20e)]({'where':{'id':_0x4156ba},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x561c15)return _0x5e24e2[_0x2a28fc(0x214)](0x194)[_0x2a28fc(0x216)]({'success':![],'message':_0x2a28fc(0x1e1)});if(_0x561c15[_0x2a28fc(0x1fe)]!==_0x2a28fc(0x1f4))return _0x5e24e2[_0x2a28fc(0x214)](0x190)['json']({'success':![],'message':_0x2a28fc(0x1f9)});if(_0x561c15[_0x2a28fc(0x214)]!==_0x2a28fc(0x1ea))return _0x5e24e2[_0x2a28fc(0x214)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x561c15['status']+_0x2a28fc(0x22c)});_0x5e24e2[_0x2a28fc(0x216)]({'success':!![],'result':{'paymentId':_0x561c15['id'],'orderId':_0x561c15[_0x2a28fc(0x1f7)],'amount':_0x561c15[_0x2a28fc(0x1e4)],'currency':_0x561c15[_0x2a28fc(0x20f)],'merchantName':_0x561c15[_0x2a28fc(0x1e3)][_0x2a28fc(0x1da)],'description':_0x2a28fc(0x1d7)+_0x561c15[_0x2a28fc(0x1e3)][_0x2a28fc(0x1da)],'testInstructions':{'successCard':_0x2a28fc(0x1d6),'failureCard':_0x2a28fc(0x21c),'expiryDate':_0x2a28fc(0x207),'cvc':_0x2a28fc(0x23d),'holderName':'Any\x20name'}}});}catch(_0x385df1){_0x607a26(_0x385df1);}},this[_0x16129d(0x1d8)]=async(_0x597bcc,_0x2ba946,_0x4b42cf)=>{const _0x1b08ef=_0x16129d;try{const {paymentId:_0x55c0fa}=_0x597bcc['params'],_0x265418=_0x597bcc[_0x1b08ef(0x217)];console[_0x1b08ef(0x1d3)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x55c0fa);const _0x49e632=await database_1[_0x1b08ef(0x1fa)]['payment'][_0x1b08ef(0x20e)]({'where':{'id':_0x55c0fa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x49e632)return _0x2ba946[_0x1b08ef(0x214)](0x194)[_0x1b08ef(0x216)]({'success':![],'message':_0x1b08ef(0x1e1)});if(_0x49e632[_0x1b08ef(0x1fe)]!=='test_gateway')return _0x2ba946[_0x1b08ef(0x214)](0x190)['json']({'success':![],'message':_0x1b08ef(0x1f9)});if(_0x49e632[_0x1b08ef(0x214)]!==_0x1b08ef(0x1ea))return _0x2ba946[_0x1b08ef(0x214)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x49e632[_0x1b08ef(0x214)]+',\x20cannot\x20process'});const _0x2ac3c1=await this[_0x1b08ef(0x224)][_0x1b08ef(0x201)]({'paymentId':_0x49e632['id'],'orderId':_0x49e632[_0x1b08ef(0x1f7)]||_0x49e632['id'],'amount':_0x49e632[_0x1b08ef(0x1e4)],'currency':_0x49e632[_0x1b08ef(0x20f)],'cardData':_0x265418});console[_0x1b08ef(0x1d3)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x2ac3c1);const _0x2aec3e={'status':_0x2ac3c1[_0x1b08ef(0x214)],'updatedAt':new Date()};if(_0x2ac3c1['status']===_0x1b08ef(0x1f3))_0x2aec3e[_0x1b08ef(0x1e8)]=new Date(),_0x2aec3e[_0x1b08ef(0x222)]=_0x2ac3c1[_0x1b08ef(0x21b)];else _0x2ac3c1[_0x1b08ef(0x214)]===_0x1b08ef(0x23a)&&(_0x2aec3e[_0x1b08ef(0x1de)]=_0x2ac3c1[_0x1b08ef(0x221)]);const _0x2d6cdc=_0x265418[_0x1b08ef(0x211)][_0x1b08ef(0x20a)](/[\s-]/g,'');_0x2aec3e[_0x1b08ef(0x238)]=_0x2d6cdc[_0x1b08ef(0x22f)](-0x4),_0x2aec3e[_0x1b08ef(0x230)]=_0x1b08ef(0x206),await database_1[_0x1b08ef(0x1fa)][_0x1b08ef(0x20d)][_0x1b08ef(0x1e6)]({'where':{'id':_0x49e632['id']},'data':_0x2aec3e}),await database_1[_0x1b08ef(0x1fa)][_0x1b08ef(0x1e0)][_0x1b08ef(0x204)]({'data':{'paymentId':_0x49e632['id'],'shopId':_0x49e632[_0x1b08ef(0x1dd)],'event':_0x1b08ef(0x21f)+_0x2ac3c1[_0x1b08ef(0x214)][_0x1b08ef(0x1ff)](),'statusCode':0xc8,'responseBody':JSON[_0x1b08ef(0x22d)]({'oldStatus':'PENDING','newStatus':_0x2ac3c1[_0x1b08ef(0x214)],'transactionId':_0x2ac3c1['transactionId'],'failureReason':_0x2ac3c1['failureReason'],'processedAt':new Date()[_0x1b08ef(0x1df)]()})}}),await this[_0x1b08ef(0x213)](_0x49e632,_0x2ac3c1['status'],_0x2ac3c1['transactionId'],_0x2ac3c1[_0x1b08ef(0x221)]),await this[_0x1b08ef(0x1f5)](_0x49e632,_0x2ac3c1[_0x1b08ef(0x214)]),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x55c0fa+'\x20processed:\x20'+_0x2ac3c1[_0x1b08ef(0x214)]),_0x2ac3c1[_0x1b08ef(0x214)]==='PAID'?_0x2ba946['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1b08ef(0x1f3),'transactionId':_0x2ac3c1[_0x1b08ef(0x21b)],'redirectUrl':_0x49e632[_0x1b08ef(0x21d)]}}):_0x2ba946[_0x1b08ef(0x214)](0x190)[_0x1b08ef(0x216)]({'success':![],'message':_0x1b08ef(0x1e5),'result':{'status':_0x1b08ef(0x23a),'failureReason':_0x2ac3c1[_0x1b08ef(0x221)],'redirectUrl':_0x49e632[_0x1b08ef(0x237)]}});}catch(_0x459c6a){_0x4b42cf(_0x459c6a);}},this[_0x16129d(0x224)]=new testGatewayService_1[(_0x16129d(0x239))](),this[_0x16129d(0x203)]=new webhookService_1[(_0x16129d(0x202))]();}async[a13_0x29361c(0x213)](_0xf108e7,_0x524d8f,_0xe4a06f,_0x5419d0){const _0xa29f8a=a13_0x29361c,_0x5f44ab=Date[_0xa29f8a(0x1ec)]();try{const _0x44f214=_0xf108e7[_0xa29f8a(0x1e3)],_0x4a3529=_0x44f214[_0xa29f8a(0x228)];if(!_0x4a3529?.['webhookUrl']){console['log'](_0xa29f8a(0x1f8)+_0x44f214['id']);return;}const _0x2b21c2=_0x524d8f===_0xa29f8a(0x1f3)?'payment.success':_0xa29f8a(0x1e2);let _0x4bf82a=[];if(_0x4a3529[_0xa29f8a(0x200)])try{_0x4bf82a=Array['isArray'](_0x4a3529[_0xa29f8a(0x200)])?_0x4a3529['webhookEvents']:JSON[_0xa29f8a(0x23e)](_0x4a3529[_0xa29f8a(0x200)]);}catch(_0x18d1e0){console[_0xa29f8a(0x20c)](_0xa29f8a(0x21a),_0x18d1e0),_0x4bf82a=[];}if(!_0x4bf82a[_0xa29f8a(0x219)](_0x2b21c2)){console[_0xa29f8a(0x1d3)]('Webhook\x20event\x20'+_0x2b21c2+_0xa29f8a(0x1f0)+_0x44f214['id']);return;}const _0x5f34d7={'event':_0x2b21c2,'payment':{'id':_0xf108e7['id'],'order_id':_0xf108e7[_0xa29f8a(0x210)],'gateway_order_id':_0xf108e7['gatewayOrderId'],'gateway':_0xa29f8a(0x1f1),'amount':_0xf108e7[_0xa29f8a(0x1e4)],'currency':_0xf108e7[_0xa29f8a(0x20f)],'status':_0x524d8f[_0xa29f8a(0x1ff)](),'customer_email':_0xf108e7[_0xa29f8a(0x1fb)],'customer_name':_0xf108e7[_0xa29f8a(0x215)],'transaction_id':_0xe4a06f,'failure_message':_0x5419d0,'created_at':_0xf108e7[_0xa29f8a(0x1fc)],'updated_at':new Date()}},_0x2e720a=await fetch(_0x4a3529[_0xa29f8a(0x226)],{'method':'POST','headers':{'Content-Type':_0xa29f8a(0x208),'User-Agent':_0xa29f8a(0x1e9)},'body':JSON['stringify'](_0x5f34d7)}),_0x469a06=Date['now']()-_0x5f44ab;console[_0xa29f8a(0x1d3)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x4a3529['webhookUrl']+_0xa29f8a(0x220)+_0x2e720a['status']+'\x20('+_0x469a06+'ms)');}catch(_0x23a1e2){console[_0xa29f8a(0x20c)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x23a1e2);}}async[a13_0x29361c(0x1f5)](_0x40944f,_0xa1bb0){const _0x18e575=a13_0x29361c;try{const {telegramBotService:_0x1d703a}=await Promise[_0x18e575(0x23c)]()[_0x18e575(0x1ed)](()=>__importStar(require('../services/telegramBotService'))),_0xdb6527={'PAID':_0x18e575(0x236),'FAILED':'failed'},_0x4b72e5=_0xdb6527[_0xa1bb0];if(!_0x4b72e5)return;await _0x1d703a[_0x18e575(0x23f)](_0x40944f[_0x18e575(0x1dd)],_0x40944f,_0x4b72e5);}catch(_0x1811f9){console[_0x18e575(0x20c)](_0x18e575(0x240),_0x1811f9);}}}exports[a13_0x29361c(0x233)]=TestGatewayController;