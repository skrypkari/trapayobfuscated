'use strict';const a13_0x237f1d=a13_0xc894;(function(_0x127dd1,_0x423ede){const _0x17b1e1=a13_0xc894,_0xfe0b8c=_0x127dd1();while(!![]){try{const _0x1a7624=parseInt(_0x17b1e1(0xe0))/0x1+-parseInt(_0x17b1e1(0xdc))/0x2*(parseInt(_0x17b1e1(0xde))/0x3)+parseInt(_0x17b1e1(0x10a))/0x4+parseInt(_0x17b1e1(0xc2))/0x5+-parseInt(_0x17b1e1(0xef))/0x6*(-parseInt(_0x17b1e1(0xf1))/0x7)+-parseInt(_0x17b1e1(0xc3))/0x8*(parseInt(_0x17b1e1(0xfe))/0x9)+-parseInt(_0x17b1e1(0xb6))/0xa;if(_0x1a7624===_0x423ede)break;else _0xfe0b8c['push'](_0xfe0b8c['shift']());}catch(_0x4255d2){_0xfe0b8c['push'](_0xfe0b8c['shift']());}}}(a13_0x3a11,0x1e0e7));var __createBinding=this&&this[a13_0x237f1d(0x10d)]||(Object[a13_0x237f1d(0x10b)]?function(_0x4494e0,_0xa0cd32,_0x117c35,_0x4e3959){const _0x3b5f60=a13_0x237f1d;if(_0x4e3959===undefined)_0x4e3959=_0x117c35;var _0x586790=Object['getOwnPropertyDescriptor'](_0xa0cd32,_0x117c35);(!_0x586790||('get'in _0x586790?!_0xa0cd32['__esModule']:_0x586790['writable']||_0x586790[_0x3b5f60(0xac)]))&&(_0x586790={'enumerable':!![],'get':function(){return _0xa0cd32[_0x117c35];}}),Object['defineProperty'](_0x4494e0,_0x4e3959,_0x586790);}:function(_0x5e4465,_0x2bc3d4,_0x3d7e09,_0x4db883){if(_0x4db883===undefined)_0x4db883=_0x3d7e09;_0x5e4465[_0x4db883]=_0x2bc3d4[_0x3d7e09];}),__setModuleDefault=this&&this[a13_0x237f1d(0x101)]||(Object['create']?function(_0x48d7a8,_0x33efe7){const _0x2d821c=a13_0x237f1d;Object['defineProperty'](_0x48d7a8,_0x2d821c(0xae),{'enumerable':!![],'value':_0x33efe7});}:function(_0x1259cc,_0x11bd72){const _0x2348b9=a13_0x237f1d;_0x1259cc[_0x2348b9(0xae)]=_0x11bd72;}),__importStar=this&&this[a13_0x237f1d(0xca)]||(function(){var _0x123147=function(_0x36d425){const _0x1017ce=a13_0xc894;return _0x123147=Object[_0x1017ce(0xa7)]||function(_0x50859b){const _0x3a7a91=_0x1017ce;var _0x18000d=[];for(var _0x2dc60f in _0x50859b)if(Object['prototype'][_0x3a7a91(0xf2)]['call'](_0x50859b,_0x2dc60f))_0x18000d[_0x18000d[_0x3a7a91(0xda)]]=_0x2dc60f;return _0x18000d;},_0x123147(_0x36d425);};return function(_0x566077){const _0xe9ff2d=a13_0xc894;if(_0x566077&&_0x566077[_0xe9ff2d(0xb3)])return _0x566077;var _0x509639={};if(_0x566077!=null){for(var _0x275fe8=_0x123147(_0x566077),_0x34a25a=0x0;_0x34a25a<_0x275fe8[_0xe9ff2d(0xda)];_0x34a25a++)if(_0x275fe8[_0x34a25a]!==_0xe9ff2d(0xae))__createBinding(_0x509639,_0x566077,_0x275fe8[_0x34a25a]);}return __setModuleDefault(_0x509639,_0x566077),_0x509639;};}()),__importDefault=this&&this[a13_0x237f1d(0xe2)]||function(_0x4a4791){const _0x402eae=a13_0x237f1d;return _0x4a4791&&_0x4a4791[_0x402eae(0xb3)]?_0x4a4791:{'default':_0x4a4791};};function a13_0xc894(_0x544463,_0x1ad535){const _0x3a113e=a13_0x3a11();return a13_0xc894=function(_0xc894f2,_0x2b3919){_0xc894f2=_0xc894f2-0xa4;let _0x8f8d06=_0x3a113e[_0xc894f2];return _0x8f8d06;},a13_0xc894(_0x544463,_0x1ad535);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x237f1d(0xfc)),webhookService_1=require(a13_0x237f1d(0xcc)),database_1=__importDefault(require(a13_0x237f1d(0xa4)));class TestGatewayController{constructor(){const _0x22f19d=a13_0x237f1d;this[_0x22f19d(0xa6)]=async(_0x4d911f,_0x28c2a9,_0x5855a1)=>{const _0x4fefd3=_0x22f19d;try{const {paymentId:_0x27a9aa}=_0x4d911f[_0x4fefd3(0xe6)];console['log'](_0x4fefd3(0xb5)+_0x27a9aa);const _0x4752c3=await database_1[_0x4fefd3(0xae)][_0x4fefd3(0xb1)]['findUnique']({'where':{'id':_0x27a9aa},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4752c3)return _0x28c2a9[_0x4fefd3(0xf3)](0x194)[_0x4fefd3(0xb9)]({'success':![],'message':_0x4fefd3(0x103)});if(_0x4752c3[_0x4fefd3(0xf7)]!==_0x4fefd3(0xc4))return _0x28c2a9[_0x4fefd3(0xf3)](0x190)['json']({'success':![],'message':_0x4fefd3(0xfa)});if(_0x4752c3['status']!==_0x4fefd3(0xe8))return _0x28c2a9['status'](0x190)[_0x4fefd3(0xb9)]({'success':![],'message':_0x4fefd3(0xcd)+_0x4752c3[_0x4fefd3(0xf3)]+',\x20cannot\x20process'});_0x28c2a9['json']({'success':!![],'result':{'paymentId':_0x4752c3['id'],'orderId':_0x4752c3[_0x4fefd3(0xe4)],'amount':_0x4752c3[_0x4fefd3(0xa9)],'currency':_0x4752c3[_0x4fefd3(0xdb)],'merchantName':_0x4752c3[_0x4fefd3(0xd2)][_0x4fefd3(0xcb)],'description':_0x4fefd3(0xd6)+_0x4752c3[_0x4fefd3(0xd2)]['name'],'testInstructions':{'successCard':_0x4fefd3(0xb2),'failureCard':_0x4fefd3(0xb8),'expiryDate':_0x4fefd3(0xd0),'cvc':'Any\x203-4\x20digits','holderName':_0x4fefd3(0xc9)}}});}catch(_0x67c3ff){_0x5855a1(_0x67c3ff);}},this[_0x22f19d(0xd4)]=async(_0x3c2d90,_0x3992db,_0x2c832f)=>{const _0x191170=_0x22f19d;try{const {paymentId:_0x50f98a}=_0x3c2d90['params'],_0x20f2fb=_0x3c2d90[_0x191170(0xa8)];console[_0x191170(0x106)](_0x191170(0xba)+_0x50f98a);const _0x181fe9=await database_1[_0x191170(0xae)][_0x191170(0xb1)][_0x191170(0x104)]({'where':{'id':_0x50f98a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x181fe9)return _0x3992db[_0x191170(0xf3)](0x194)[_0x191170(0xb9)]({'success':![],'message':_0x191170(0x103)});if(_0x181fe9['gateway']!=='test_gateway')return _0x3992db[_0x191170(0xf3)](0x190)[_0x191170(0xb9)]({'success':![],'message':_0x191170(0xfa)});if(_0x181fe9[_0x191170(0xf3)]!==_0x191170(0xe8))return _0x3992db[_0x191170(0xf3)](0x190)['json']({'success':![],'message':_0x191170(0xcd)+_0x181fe9['status']+',\x20cannot\x20process'});const _0x459176=await this[_0x191170(0xbf)][_0x191170(0xc5)]({'paymentId':_0x181fe9['id'],'orderId':_0x181fe9[_0x191170(0xe4)]||_0x181fe9['id'],'amount':_0x181fe9[_0x191170(0xa9)],'currency':_0x181fe9[_0x191170(0xdb)],'cardData':_0x20f2fb});console[_0x191170(0x106)](_0x191170(0xe1),_0x459176);const _0x22d023={'status':_0x459176[_0x191170(0xf3)],'updatedAt':new Date()};if(_0x459176[_0x191170(0xf3)]===_0x191170(0xad))_0x22d023['paidAt']=new Date(),_0x22d023[_0x191170(0xea)]=_0x459176[_0x191170(0xa5)];else _0x459176[_0x191170(0xf3)]==='FAILED'&&(_0x22d023['failureMessage']=_0x459176[_0x191170(0xf8)]);const _0x2ed05e=_0x20f2fb[_0x191170(0xeb)][_0x191170(0xdf)](/[\s-]/g,'');_0x22d023['cardLast4']=_0x2ed05e[_0x191170(0xb7)](-0x4),_0x22d023[_0x191170(0xe3)]=_0x191170(0x100),await database_1[_0x191170(0xae)][_0x191170(0xb1)]['update']({'where':{'id':_0x181fe9['id']},'data':_0x22d023}),await database_1[_0x191170(0xae)][_0x191170(0xc7)][_0x191170(0x10b)]({'data':{'paymentId':_0x181fe9['id'],'shopId':_0x181fe9[_0x191170(0xee)],'event':'test_gateway_'+_0x459176[_0x191170(0xf3)][_0x191170(0xbe)](),'statusCode':0xc8,'responseBody':JSON[_0x191170(0xd5)]({'oldStatus':_0x191170(0xe8),'newStatus':_0x459176[_0x191170(0xf3)],'transactionId':_0x459176[_0x191170(0xa5)],'failureReason':_0x459176[_0x191170(0xf8)],'processedAt':new Date()[_0x191170(0xc1)]()})}}),await this[_0x191170(0xb4)](_0x181fe9,_0x459176[_0x191170(0xf3)],_0x459176[_0x191170(0xa5)],_0x459176[_0x191170(0xf8)]),await this['sendPaymentStatusNotification'](_0x181fe9,_0x459176['status']),console['log'](_0x191170(0xb0)+_0x50f98a+_0x191170(0xbb)+_0x459176[_0x191170(0xf3)]),_0x459176[_0x191170(0xf3)]===_0x191170(0xad)?_0x3992db[_0x191170(0xb9)]({'success':!![],'message':_0x191170(0xd9),'result':{'status':_0x191170(0xad),'transactionId':_0x459176[_0x191170(0xa5)],'redirectUrl':_0x181fe9[_0x191170(0xfb)]}}):_0x3992db['status'](0x190)[_0x191170(0xb9)]({'success':![],'message':_0x191170(0xff),'result':{'status':_0x191170(0xc8),'failureReason':_0x459176[_0x191170(0xf8)],'redirectUrl':_0x181fe9[_0x191170(0xcf)]}});}catch(_0x36f2b1){_0x2c832f(_0x36f2b1);}},this[_0x22f19d(0xbf)]=new testGatewayService_1['TestGatewayService'](),this[_0x22f19d(0xed)]=new webhookService_1[(_0x22f19d(0xd8))]();}async['sendShopWebhook'](_0x2e2346,_0x179bd0,_0x1e9183,_0xbfe1ea){const _0x5d4ca9=a13_0x237f1d,_0x78c6cd=Date[_0x5d4ca9(0xf4)]();try{const _0x200a8d=_0x2e2346['shop'],_0x4c5bc3=_0x200a8d[_0x5d4ca9(0xd3)];if(!_0x4c5bc3?.[_0x5d4ca9(0xe9)]){console[_0x5d4ca9(0x106)](_0x5d4ca9(0xbd)+_0x200a8d['id']);return;}const _0x11b2c6=_0x179bd0===_0x5d4ca9(0xad)?'payment.success':_0x5d4ca9(0xaf);let _0x51f867=[];if(_0x4c5bc3[_0x5d4ca9(0x102)])try{_0x51f867=Array[_0x5d4ca9(0x10c)](_0x4c5bc3[_0x5d4ca9(0x102)])?_0x4c5bc3[_0x5d4ca9(0x102)]:JSON[_0x5d4ca9(0xec)](_0x4c5bc3[_0x5d4ca9(0x102)]);}catch(_0x30f9e9){console[_0x5d4ca9(0xf0)](_0x5d4ca9(0xce),_0x30f9e9),_0x51f867=[];}if(!_0x51f867[_0x5d4ca9(0xc6)](_0x11b2c6)){console[_0x5d4ca9(0x106)](_0x5d4ca9(0xbc)+_0x11b2c6+'\x20not\x20enabled\x20for\x20shop\x20'+_0x200a8d['id']);return;}const _0x5da78c={'event':_0x11b2c6,'payment':{'id':_0x2e2346['id'],'order_id':_0x2e2346['orderId'],'gateway_order_id':_0x2e2346[_0x5d4ca9(0xe4)],'gateway':_0x5d4ca9(0xf9),'amount':_0x2e2346[_0x5d4ca9(0xa9)],'currency':_0x2e2346[_0x5d4ca9(0xdb)],'status':_0x179bd0['toLowerCase'](),'customer_email':_0x2e2346['customerEmail'],'customer_name':_0x2e2346[_0x5d4ca9(0x109)],'transaction_id':_0x1e9183,'failure_message':_0xbfe1ea,'created_at':_0x2e2346[_0x5d4ca9(0xfd)],'updated_at':new Date()}},_0x79dbb6=await fetch(_0x4c5bc3['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x5d4ca9(0xe5),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x5d4ca9(0xd5)](_0x5da78c)}),_0x4ef31d=Date['now']()-_0x78c6cd;console[_0x5d4ca9(0x106)](_0x5d4ca9(0xc0)+_0x4c5bc3[_0x5d4ca9(0xe9)]+_0x5d4ca9(0x108)+_0x79dbb6[_0x5d4ca9(0xf3)]+'\x20('+_0x4ef31d+_0x5d4ca9(0xab));}catch(_0xe87fcd){console[_0x5d4ca9(0xf0)](_0x5d4ca9(0xf6),_0xe87fcd);}}async[a13_0x237f1d(0xdd)](_0x47a357,_0x45e94d){const _0x4b357a=a13_0x237f1d;try{const {telegramBotService:_0x41bbf5}=await Promise['resolve']()[_0x4b357a(0xaa)](()=>__importStar(require(_0x4b357a(0xe7)))),_0x23ebb9={'PAID':_0x4b357a(0x105),'FAILED':_0x4b357a(0xf5)},_0x4683e9=_0x23ebb9[_0x45e94d];if(!_0x4683e9)return;await _0x41bbf5[_0x4b357a(0x107)](_0x47a357[_0x4b357a(0xee)],_0x47a357,_0x4683e9);}catch(_0x5b8a74){console[_0x4b357a(0xf0)](_0x4b357a(0xd7),_0x5b8a74);}}}function a13_0x3a11(){const _0x310389=['FAILED','Any\x20name','__importStar','name','../services/webhookService','Payment\x20status\x20is\x20','Error\x20parsing\x20webhook\x20events:','failUrl','Any\x20future\x20date\x20(MM/YY)','TestGatewayController','shop','settings','processCard','stringify','Payment\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','WebhookService','Payment\x20processed\x20successfully','length','currency','1438ENiUbt','sendPaymentStatusNotification','471GQFuHM','replace','174617agNgrs','🧪\x20Test\x20Gateway\x20result:','__importDefault','paymentMethod','gatewayOrderId','application/json','params','../services/telegramBotService','PENDING','webhookUrl','gatewayPaymentId','cardNumber','parse','webhookService','shopId','12OVAOCi','error','730618TeEVBv','hasOwnProperty','status','now','failed','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','gateway','failureReason','0000','Payment\x20is\x20not\x20for\x20test\x20gateway','successUrl','../services/gateways/testGatewayService','createdAt','9LMGDKl','Payment\x20failed','test_card','__setModuleDefault','webhookEvents','Payment\x20not\x20found','findUnique','paid','log','sendPaymentNotification','\x20with\x20status\x20','customerName','889796CdwkAL','create','isArray','__createBinding','../config/database','transactionId','getPaymentForm','getOwnPropertyNames','body','amount','then','ms)','configurable','PAID','default','payment.failed','✅\x20Test\x20Gateway\x20payment\x20','payment','4242\x204242\x204242\x204242','__esModule','sendShopWebhook','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','2863480TTHZLc','slice','Any\x20other\x20card\x20number','json','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','\x20processed:\x20','Webhook\x20event\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','testGatewayService','Test\x20Gateway\x20webhook\x20sent\x20to\x20','toISOString','355025tFcvtA','1235816mOqQiZ','test_gateway','processCardPayment','includes','webhookLog'];a13_0x3a11=function(){return _0x310389;};return a13_0x3a11();}exports[a13_0x237f1d(0xd1)]=TestGatewayController;