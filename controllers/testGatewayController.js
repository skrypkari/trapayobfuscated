'use strict';function a13_0x4923(){const _0x540615=['processCardPayment','defineProperty','WebhookService','paymentMethod','TestGatewayController','Payment\x20is\x20not\x20for\x20test\x20gateway','Error\x20parsing\x20webhook\x20events:','currency','params','parse','amount','webhookLog','payment','hasOwnProperty','3IoegbR','42QCRAjy','__importDefault','isArray','shop','../config/database','sendPaymentStatusNotification','stringify','5831676PgFUEN','getPaymentForm','1131130dqOZFS','toLowerCase','PAID','customerName','payment.failed','default','customerEmail','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20to\x20','testGatewayService','failed','432145mvsjso','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','2560052Kxhcns','findUnique','POST','ðŸ§ª\x20Test\x20Gateway\x20result:','gatewayPaymentId','615875wzhGUG','FAILED','PENDING','webhookEvents','length','0000','status','test_gateway','Any\x20name','failureReason','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','getOwnPropertyDescriptor','ms)','\x20with\x20status\x20','__createBinding','gatewayOrderId','2bYQtcm','Any\x203-4\x20digits','paid','configurable','resolve','__esModule','now','replace','prototype','getOwnPropertyNames','761032zGloKh','cardLast4','slice','Payment\x20processed\x20successfully','../services/webhookService','writable','__importStar','âœ…\x20Test\x20Gateway\x20payment\x20','error','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','orderId','webhookService','failUrl','transactionId','__setModuleDefault','test_card','application/json','sendPaymentNotification','toISOString','log','settings','4242\x204242\x204242\x204242','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x20other\x20card\x20number','json','14hjsvLy','21005391FtVFxN','Any\x20future\x20date\x20(MM/YY)','cardNumber',',\x20cannot\x20process','successUrl','../services/telegramBotService','create','shopId','gateway','paidAt','Payment\x20not\x20found','Payment\x20failed','sendShopWebhook','TestGatewayService'];a13_0x4923=function(){return _0x540615;};return a13_0x4923();}const a13_0x174fb3=a13_0x21bf;(function(_0x4d23bf,_0x1ff23b){const _0x54c998=a13_0x21bf,_0x307d51=_0x4d23bf();while(!![]){try{const _0xf9538d=parseInt(_0x54c998(0x139))/0x1*(parseInt(_0x54c998(0xe2))/0x2)+-parseInt(_0x54c998(0x122))/0x3*(-parseInt(_0x54c998(0x13b))/0x4)+-parseInt(_0x54c998(0xd2))/0x5*(-parseInt(_0x54c998(0x123))/0x6)+parseInt(_0x54c998(0x105))/0x7*(-parseInt(_0x54c998(0xec))/0x8)+parseInt(_0x54c998(0x12a))/0x9+parseInt(_0x54c998(0x12c))/0xa+-parseInt(_0x54c998(0x106))/0xb;if(_0xf9538d===_0x1ff23b)break;else _0x307d51['push'](_0x307d51['shift']());}catch(_0x38f0a7){_0x307d51['push'](_0x307d51['shift']());}}}(a13_0x4923,0x916a5));var __createBinding=this&&this[a13_0x174fb3(0xe0)]||(Object[a13_0x174fb3(0x10c)]?function(_0x430de5,_0x452ef0,_0x4eccd3,_0x3be315){const _0x2b26c0=a13_0x174fb3;if(_0x3be315===undefined)_0x3be315=_0x4eccd3;var _0x17dec9=Object[_0x2b26c0(0xdd)](_0x452ef0,_0x4eccd3);(!_0x17dec9||('get'in _0x17dec9?!_0x452ef0[_0x2b26c0(0xe7)]:_0x17dec9[_0x2b26c0(0xf1)]||_0x17dec9[_0x2b26c0(0xe5)]))&&(_0x17dec9={'enumerable':!![],'get':function(){return _0x452ef0[_0x4eccd3];}}),Object[_0x2b26c0(0x115)](_0x430de5,_0x3be315,_0x17dec9);}:function(_0x58d68f,_0x3ede3b,_0x2a898e,_0x2d1bc9){if(_0x2d1bc9===undefined)_0x2d1bc9=_0x2a898e;_0x58d68f[_0x2d1bc9]=_0x3ede3b[_0x2a898e];}),__setModuleDefault=this&&this[a13_0x174fb3(0xfa)]||(Object[a13_0x174fb3(0x10c)]?function(_0x4939c3,_0x388763){const _0x54d282=a13_0x174fb3;Object[_0x54d282(0x115)](_0x4939c3,_0x54d282(0x131),{'enumerable':!![],'value':_0x388763});}:function(_0x3b5302,_0x1f951e){_0x3b5302['default']=_0x1f951e;}),__importStar=this&&this[a13_0x174fb3(0xf2)]||(function(){var _0x5ac58c=function(_0xa4b4af){const _0x41dd24=a13_0x21bf;return _0x5ac58c=Object[_0x41dd24(0xeb)]||function(_0x26629e){const _0x462016=_0x41dd24;var _0x5a5a97=[];for(var _0x34e84e in _0x26629e)if(Object[_0x462016(0xea)][_0x462016(0x121)]['call'](_0x26629e,_0x34e84e))_0x5a5a97[_0x5a5a97[_0x462016(0xd6)]]=_0x34e84e;return _0x5a5a97;},_0x5ac58c(_0xa4b4af);};return function(_0x24c6ff){const _0x401c66=a13_0x21bf;if(_0x24c6ff&&_0x24c6ff[_0x401c66(0xe7)])return _0x24c6ff;var _0x1c08a1={};if(_0x24c6ff!=null){for(var _0x1ed5d2=_0x5ac58c(_0x24c6ff),_0x389349=0x0;_0x389349<_0x1ed5d2[_0x401c66(0xd6)];_0x389349++)if(_0x1ed5d2[_0x389349]!==_0x401c66(0x131))__createBinding(_0x1c08a1,_0x24c6ff,_0x1ed5d2[_0x389349]);}return __setModuleDefault(_0x1c08a1,_0x24c6ff),_0x1c08a1;};}()),__importDefault=this&&this[a13_0x174fb3(0x124)]||function(_0x1d42ac){const _0x144861=a13_0x174fb3;return _0x1d42ac&&_0x1d42ac[_0x144861(0xe7)]?_0x1d42ac:{'default':_0x1d42ac};};Object[a13_0x174fb3(0x115)](exports,a13_0x174fb3(0xe7),{'value':!![]}),exports[a13_0x174fb3(0x118)]=void 0x0;function a13_0x21bf(_0x5727fc,_0x436e88){const _0x49234a=a13_0x4923();return a13_0x21bf=function(_0x21bf1c,_0x31a444){_0x21bf1c=_0x21bf1c-0xce;let _0x233e34=_0x49234a[_0x21bf1c];return _0x233e34;},a13_0x21bf(_0x5727fc,_0x436e88);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x174fb3(0xf0)),database_1=__importDefault(require(a13_0x174fb3(0x127)));class TestGatewayController{constructor(){const _0x1fa69e=a13_0x174fb3;this[_0x1fa69e(0x12b)]=async(_0x476041,_0x2c6952,_0x97702d)=>{const _0x5c786f=_0x1fa69e;try{const {paymentId:_0x441b7a}=_0x476041[_0x5c786f(0x11c)];console['log'](_0x5c786f(0x135)+_0x441b7a);const _0x1a6b96=await database_1[_0x5c786f(0x131)]['payment'][_0x5c786f(0xce)]({'where':{'id':_0x441b7a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1a6b96)return _0x2c6952[_0x5c786f(0xd8)](0x194)[_0x5c786f(0x104)]({'success':![],'message':_0x5c786f(0x110)});if(_0x1a6b96['gateway']!==_0x5c786f(0xd9))return _0x2c6952[_0x5c786f(0xd8)](0x190)[_0x5c786f(0x104)]({'success':![],'message':_0x5c786f(0x119)});if(_0x1a6b96['status']!==_0x5c786f(0xd4))return _0x2c6952[_0x5c786f(0xd8)](0x190)[_0x5c786f(0x104)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1a6b96[_0x5c786f(0xd8)]+',\x20cannot\x20process'});_0x2c6952['json']({'success':!![],'result':{'paymentId':_0x1a6b96['id'],'orderId':_0x1a6b96[_0x5c786f(0xe1)],'amount':_0x1a6b96[_0x5c786f(0x11e)],'currency':_0x1a6b96[_0x5c786f(0x11b)],'merchantName':_0x1a6b96[_0x5c786f(0x126)]['name'],'description':_0x5c786f(0x136)+_0x1a6b96['shop']['name'],'testInstructions':{'successCard':_0x5c786f(0x101),'failureCard':_0x5c786f(0x103),'expiryDate':_0x5c786f(0x107),'cvc':_0x5c786f(0xe3),'holderName':_0x5c786f(0xda)}}});}catch(_0x11863d){_0x97702d(_0x11863d);}},this['processCard']=async(_0x3128f,_0x2b3eda,_0x501487)=>{const _0x28ada1=_0x1fa69e;try{const {paymentId:_0x55cf9c}=_0x3128f[_0x28ada1(0x11c)],_0x5ef3be=_0x3128f['body'];console[_0x28ada1(0xff)](_0x28ada1(0xdc)+_0x55cf9c);const _0x431223=await database_1[_0x28ada1(0x131)][_0x28ada1(0x120)]['findUnique']({'where':{'id':_0x55cf9c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x431223)return _0x2b3eda['status'](0x194)[_0x28ada1(0x104)]({'success':![],'message':_0x28ada1(0x110)});if(_0x431223[_0x28ada1(0x10e)]!=='test_gateway')return _0x2b3eda[_0x28ada1(0xd8)](0x190)[_0x28ada1(0x104)]({'success':![],'message':_0x28ada1(0x119)});if(_0x431223['status']!==_0x28ada1(0xd4))return _0x2b3eda[_0x28ada1(0xd8)](0x190)[_0x28ada1(0x104)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x431223[_0x28ada1(0xd8)]+_0x28ada1(0x109)});const _0x295efc=await this['testGatewayService'][_0x28ada1(0x114)]({'paymentId':_0x431223['id'],'orderId':_0x431223[_0x28ada1(0xe1)]||_0x431223['id'],'amount':_0x431223['amount'],'currency':_0x431223[_0x28ada1(0x11b)],'cardData':_0x5ef3be});console[_0x28ada1(0xff)](_0x28ada1(0xd0),_0x295efc);const _0x47c826={'status':_0x295efc['status'],'updatedAt':new Date()};if(_0x295efc['status']===_0x28ada1(0x12e))_0x47c826[_0x28ada1(0x10f)]=new Date(),_0x47c826[_0x28ada1(0xd1)]=_0x295efc[_0x28ada1(0xf9)];else _0x295efc[_0x28ada1(0xd8)]===_0x28ada1(0xd3)&&(_0x47c826['failureMessage']=_0x295efc[_0x28ada1(0xdb)]);const _0x38b4e7=_0x5ef3be[_0x28ada1(0x108)][_0x28ada1(0xe9)](/[\s-]/g,'');_0x47c826[_0x28ada1(0xed)]=_0x38b4e7[_0x28ada1(0xee)](-0x4),_0x47c826[_0x28ada1(0x117)]=_0x28ada1(0xfb),await database_1['default'][_0x28ada1(0x120)]['update']({'where':{'id':_0x431223['id']},'data':_0x47c826}),await database_1[_0x28ada1(0x131)][_0x28ada1(0x11f)][_0x28ada1(0x10c)]({'data':{'paymentId':_0x431223['id'],'shopId':_0x431223[_0x28ada1(0x10d)],'event':'test_gateway_'+_0x295efc['status'][_0x28ada1(0x12d)](),'statusCode':0xc8,'responseBody':JSON[_0x28ada1(0x129)]({'oldStatus':'PENDING','newStatus':_0x295efc[_0x28ada1(0xd8)],'transactionId':_0x295efc[_0x28ada1(0xf9)],'failureReason':_0x295efc[_0x28ada1(0xdb)],'processedAt':new Date()[_0x28ada1(0xfe)]()})}}),await this[_0x28ada1(0x112)](_0x431223,_0x295efc[_0x28ada1(0xd8)],_0x295efc[_0x28ada1(0xf9)],_0x295efc[_0x28ada1(0xdb)]),await this[_0x28ada1(0x128)](_0x431223,_0x295efc[_0x28ada1(0xd8)]),console[_0x28ada1(0xff)](_0x28ada1(0xf3)+_0x55cf9c+'\x20processed:\x20'+_0x295efc[_0x28ada1(0xd8)]),_0x295efc[_0x28ada1(0xd8)]===_0x28ada1(0x12e)?_0x2b3eda[_0x28ada1(0x104)]({'success':!![],'message':_0x28ada1(0xef),'result':{'status':_0x28ada1(0x12e),'transactionId':_0x295efc[_0x28ada1(0xf9)],'redirectUrl':_0x431223[_0x28ada1(0x10a)]}}):_0x2b3eda[_0x28ada1(0xd8)](0x190)[_0x28ada1(0x104)]({'success':![],'message':_0x28ada1(0x111),'result':{'status':_0x28ada1(0xd3),'failureReason':_0x295efc[_0x28ada1(0xdb)],'redirectUrl':_0x431223[_0x28ada1(0xf8)]}});}catch(_0x5ecbf1){_0x501487(_0x5ecbf1);}},this[_0x1fa69e(0x137)]=new testGatewayService_1[(_0x1fa69e(0x113))](),this[_0x1fa69e(0xf7)]=new webhookService_1[(_0x1fa69e(0x116))]();}async[a13_0x174fb3(0x112)](_0x1f21be,_0x50ac25,_0x5decc0,_0x35fa68){const _0x2860f7=a13_0x174fb3,_0x474853=Date[_0x2860f7(0xe8)]();try{const _0x44d57f=_0x1f21be[_0x2860f7(0x126)],_0x22a8d6=_0x44d57f[_0x2860f7(0x100)];if(!_0x22a8d6?.[_0x2860f7(0x133)]){console[_0x2860f7(0xff)](_0x2860f7(0x13a)+_0x44d57f['id']);return;}const _0x44e6db=_0x50ac25===_0x2860f7(0x12e)?'payment.success':_0x2860f7(0x130);let _0x4dad64=[];if(_0x22a8d6[_0x2860f7(0xd5)])try{_0x4dad64=Array[_0x2860f7(0x125)](_0x22a8d6[_0x2860f7(0xd5)])?_0x22a8d6['webhookEvents']:JSON[_0x2860f7(0x11d)](_0x22a8d6[_0x2860f7(0xd5)]);}catch(_0x3f4432){console[_0x2860f7(0xf4)](_0x2860f7(0x11a),_0x3f4432),_0x4dad64=[];}if(!_0x4dad64['includes'](_0x44e6db)){console['log']('Webhook\x20event\x20'+_0x44e6db+'\x20not\x20enabled\x20for\x20shop\x20'+_0x44d57f['id']);return;}const _0x6b37a5={'event':_0x44e6db,'payment':{'id':_0x1f21be['id'],'order_id':_0x1f21be[_0x2860f7(0xf6)],'gateway_order_id':_0x1f21be[_0x2860f7(0xe1)],'gateway':_0x2860f7(0xd7),'amount':_0x1f21be[_0x2860f7(0x11e)],'currency':_0x1f21be[_0x2860f7(0x11b)],'status':_0x50ac25[_0x2860f7(0x12d)](),'customer_email':_0x1f21be[_0x2860f7(0x132)],'customer_name':_0x1f21be[_0x2860f7(0x12f)],'transaction_id':_0x5decc0,'failure_message':_0x35fa68,'created_at':_0x1f21be['createdAt'],'updated_at':new Date()}},_0x20a631=await fetch(_0x22a8d6[_0x2860f7(0x133)],{'method':_0x2860f7(0xcf),'headers':{'Content-Type':_0x2860f7(0xfc),'User-Agent':_0x2860f7(0x102)},'body':JSON[_0x2860f7(0x129)](_0x6b37a5)}),_0x17cff9=Date[_0x2860f7(0xe8)]()-_0x474853;console[_0x2860f7(0xff)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x22a8d6[_0x2860f7(0x133)]+_0x2860f7(0xdf)+_0x20a631['status']+'\x20('+_0x17cff9+_0x2860f7(0xde));}catch(_0x2c70c4){console[_0x2860f7(0xf4)](_0x2860f7(0xf5),_0x2c70c4);}}async['sendPaymentStatusNotification'](_0x3228a7,_0x3baedf){const _0xb15706=a13_0x174fb3;try{const {telegramBotService:_0x4cc3b3}=await Promise[_0xb15706(0xe6)]()['then'](()=>__importStar(require(_0xb15706(0x10b)))),_0x1ceae5={'PAID':_0xb15706(0xe4),'FAILED':_0xb15706(0x138)},_0x3de729=_0x1ceae5[_0x3baedf];if(!_0x3de729)return;await _0x4cc3b3[_0xb15706(0xfd)](_0x3228a7['shopId'],_0x3228a7,_0x3de729);}catch(_0x17e45d){console[_0xb15706(0xf4)](_0xb15706(0x134),_0x17e45d);}}}exports[a13_0x174fb3(0x118)]=TestGatewayController;