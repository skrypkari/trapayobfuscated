'use strict';const a14_0x2147b9=a14_0x1aec;(function(_0x3569ba,_0x4da670){const _0x56c986=a14_0x1aec,_0x332158=_0x3569ba();while(!![]){try{const _0x53c29a=parseInt(_0x56c986(0xdb))/0x1*(-parseInt(_0x56c986(0xa0))/0x2)+parseInt(_0x56c986(0xdd))/0x3*(-parseInt(_0x56c986(0xd9))/0x4)+-parseInt(_0x56c986(0xc1))/0x5*(parseInt(_0x56c986(0xc9))/0x6)+-parseInt(_0x56c986(0xcc))/0x7*(parseInt(_0x56c986(0xa4))/0x8)+parseInt(_0x56c986(0xc6))/0x9+parseInt(_0x56c986(0xb2))/0xa*(parseInt(_0x56c986(0x8f))/0xb)+parseInt(_0x56c986(0xb4))/0xc;if(_0x53c29a===_0x4da670)break;else _0x332158['push'](_0x332158['shift']());}catch(_0x47a364){_0x332158['push'](_0x332158['shift']());}}}(a14_0x5cdb,0x64489));var __createBinding=this&&this[a14_0x2147b9(0xe6)]||(Object[a14_0x2147b9(0x93)]?function(_0x4615c3,_0x514b2d,_0x3aee49,_0x4d0402){const _0x4cb52a=a14_0x2147b9;if(_0x4d0402===undefined)_0x4d0402=_0x3aee49;var _0x31f0bc=Object[_0x4cb52a(0xa6)](_0x514b2d,_0x3aee49);(!_0x31f0bc||('get'in _0x31f0bc?!_0x514b2d[_0x4cb52a(0xe7)]:_0x31f0bc[_0x4cb52a(0xf5)]||_0x31f0bc[_0x4cb52a(0xc4)]))&&(_0x31f0bc={'enumerable':!![],'get':function(){return _0x514b2d[_0x3aee49];}}),Object['defineProperty'](_0x4615c3,_0x4d0402,_0x31f0bc);}:function(_0x1174e7,_0xadd45c,_0x80254d,_0x137e6b){if(_0x137e6b===undefined)_0x137e6b=_0x80254d;_0x1174e7[_0x137e6b]=_0xadd45c[_0x80254d];}),__setModuleDefault=this&&this[a14_0x2147b9(0xba)]||(Object[a14_0x2147b9(0x93)]?function(_0x109b77,_0x4583dc){Object['defineProperty'](_0x109b77,'default',{'enumerable':!![],'value':_0x4583dc});}:function(_0x3a33ea,_0x4ad4f8){const _0x252765=a14_0x2147b9;_0x3a33ea[_0x252765(0x105)]=_0x4ad4f8;}),__importStar=this&&this[a14_0x2147b9(0x98)]||(function(){var _0x355226=function(_0x18da88){const _0x22fdda=a14_0x1aec;return _0x355226=Object[_0x22fdda(0x97)]||function(_0x727db8){const _0x47c58f=_0x22fdda;var _0x450267=[];for(var _0x562b45 in _0x727db8)if(Object[_0x47c58f(0xbe)][_0x47c58f(0x95)][_0x47c58f(0xb8)](_0x727db8,_0x562b45))_0x450267[_0x450267[_0x47c58f(0xe1)]]=_0x562b45;return _0x450267;},_0x355226(_0x18da88);};return function(_0x2b40e6){const _0x2c0a5c=a14_0x1aec;if(_0x2b40e6&&_0x2b40e6['__esModule'])return _0x2b40e6;var _0x5a21b1={};if(_0x2b40e6!=null){for(var _0x2e3380=_0x355226(_0x2b40e6),_0x523340=0x0;_0x523340<_0x2e3380[_0x2c0a5c(0xe1)];_0x523340++)if(_0x2e3380[_0x523340]!==_0x2c0a5c(0x105))__createBinding(_0x5a21b1,_0x2b40e6,_0x2e3380[_0x523340]);}return __setModuleDefault(_0x5a21b1,_0x2b40e6),_0x5a21b1;};}()),__importDefault=this&&this['__importDefault']||function(_0x2a0f5e){const _0xdb67d5=a14_0x2147b9;return _0x2a0f5e&&_0x2a0f5e[_0xdb67d5(0xe7)]?_0x2a0f5e:{'default':_0x2a0f5e};};Object[a14_0x2147b9(0xa1)](exports,a14_0x2147b9(0xe7),{'value':!![]}),exports[a14_0x2147b9(0x9c)]=void 0x0;function a14_0x1aec(_0x28cb72,_0x18c6f7){const _0x5cdbe3=a14_0x5cdb();return a14_0x1aec=function(_0x1aeca4,_0x2e7ff4){_0x1aeca4=_0x1aeca4-0x86;let _0x3aefd9=_0x5cdbe3[_0x1aeca4];return _0x3aefd9;},a14_0x1aec(_0x28cb72,_0x18c6f7);}const testGatewayService_1=require(a14_0x2147b9(0xee)),webhookService_1=require(a14_0x2147b9(0xca)),database_1=__importDefault(require(a14_0x2147b9(0xc8)));class TestGatewayController{constructor(){const _0x40f20e=a14_0x2147b9;this[_0x40f20e(0xcb)]=async(_0x21849a,_0x1317e2,_0xa5f5e3)=>{const _0x225968=_0x40f20e;try{const {paymentId:_0xcd819}=_0x21849a[_0x225968(0xbc)];console[_0x225968(0x100)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0xcd819);const _0x115ac0=await database_1[_0x225968(0x105)][_0x225968(0xb7)][_0x225968(0xbb)]({'where':{'id':_0xcd819},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x115ac0)return _0x1317e2[_0x225968(0xb9)](0x194)['json']({'success':![],'message':_0x225968(0x86)});if(_0x115ac0['gateway']!==_0x225968(0x88))return _0x1317e2[_0x225968(0xb9)](0x190)[_0x225968(0x9e)]({'success':![],'message':_0x225968(0xfd)});if(_0x115ac0[_0x225968(0xb9)]!==_0x225968(0xe2))return _0x1317e2[_0x225968(0xb9)](0x190)[_0x225968(0x9e)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x115ac0['status']+',\x20cannot\x20process'});_0x1317e2[_0x225968(0x9e)]({'success':!![],'result':{'paymentId':_0x115ac0['id'],'orderId':_0x115ac0['gatewayOrderId'],'amount':_0x115ac0['amount'],'currency':_0x115ac0['currency'],'merchantName':_0x115ac0[_0x225968(0xde)][_0x225968(0xf1)],'description':_0x225968(0xd6)+_0x115ac0[_0x225968(0xde)][_0x225968(0xf1)],'testInstructions':{'successCard':_0x225968(0xff),'failureCard':_0x225968(0x9a),'expiryDate':_0x225968(0xb3),'cvc':_0x225968(0xa8),'holderName':_0x225968(0xf3)}}});}catch(_0x46154d){_0xa5f5e3(_0x46154d);}},this[_0x40f20e(0xd0)]=async(_0x13efe0,_0x4837ca,_0x4611c0)=>{const _0x234da8=_0x40f20e;try{const {paymentId:_0x3ab28a}=_0x13efe0[_0x234da8(0xbc)],_0x2c60b0=_0x13efe0[_0x234da8(0x8a)];console[_0x234da8(0x100)](_0x234da8(0xc5)+_0x3ab28a);const _0x39ef9e=await database_1[_0x234da8(0x105)]['payment']['findUnique']({'where':{'id':_0x3ab28a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x39ef9e)return _0x4837ca[_0x234da8(0xb9)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x39ef9e[_0x234da8(0xe3)]!=='test_gateway')return _0x4837ca[_0x234da8(0xb9)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x39ef9e[_0x234da8(0xb9)]!==_0x234da8(0xe2))return _0x4837ca[_0x234da8(0xb9)](0x190)[_0x234da8(0x9e)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x39ef9e['status']+_0x234da8(0xf9)});const _0x19eba1=await this['testGatewayService'][_0x234da8(0x91)]({'paymentId':_0x39ef9e['id'],'orderId':_0x39ef9e[_0x234da8(0x9d)]||_0x39ef9e['id'],'amount':_0x39ef9e[_0x234da8(0xae)],'currency':_0x39ef9e[_0x234da8(0xcd)],'cardData':_0x2c60b0});console['log'](_0x234da8(0xcf),_0x19eba1);const _0xc8743f={'status':_0x19eba1[_0x234da8(0xb9)],'updatedAt':new Date()};if(_0x19eba1['status']===_0x234da8(0x101))_0xc8743f['paidAt']=new Date(),_0xc8743f['gatewayPaymentId']=_0x19eba1[_0x234da8(0xd7)];else _0x19eba1[_0x234da8(0xb9)]==='FAILED'&&(_0xc8743f[_0x234da8(0xc3)]=_0x19eba1[_0x234da8(0xb5)]);const _0x1eb861=_0x2c60b0['cardNumber'][_0x234da8(0xb0)](/[\s-]/g,'');_0xc8743f['cardLast4']=_0x1eb861[_0x234da8(0xb6)](-0x4),_0xc8743f[_0x234da8(0xd5)]=_0x234da8(0xb1),await database_1[_0x234da8(0x105)][_0x234da8(0xb7)][_0x234da8(0xa2)]({'where':{'id':_0x39ef9e['id']},'data':_0xc8743f});if(_0x19eba1[_0x234da8(0xb9)]===_0x234da8(0x101)&&_0x39ef9e[_0x234da8(0xa5)]){console[_0x234da8(0x100)](_0x234da8(0xf2)+_0x39ef9e['id']+_0x234da8(0x87));try{await database_1[_0x234da8(0x105)][_0x234da8(0x9f)](async _0x4c8d4a=>{const _0x436e5b=_0x234da8,_0x13e8fd=await _0x4c8d4a[_0x436e5b(0x102)][_0x436e5b(0xbb)]({'where':{'id':_0x39ef9e[_0x436e5b(0xa5)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x13e8fd){console[_0x436e5b(0x100)](_0x436e5b(0xc0)+_0x13e8fd['id']+_0x436e5b(0x99)+_0x13e8fd[_0x436e5b(0xef)]+_0x436e5b(0xbd)+_0x13e8fd[_0x436e5b(0xe5)]+',\x20status='+_0x13e8fd[_0x436e5b(0xb9)]);const _0x3c70f7=_0x13e8fd['currentPayments']+0x1,_0x5b8461=_0x13e8fd[_0x436e5b(0xef)]===_0x436e5b(0xf6)?_0x436e5b(0x9b):_0x13e8fd[_0x436e5b(0xb9)];await _0x4c8d4a[_0x436e5b(0x102)]['update']({'where':{'id':_0x39ef9e[_0x436e5b(0xa5)]},'data':{'currentPayments':_0x3c70f7,'status':_0x5b8461,'updatedAt':new Date()}}),console[_0x436e5b(0x100)]('✅\x20Payment\x20link\x20'+_0x13e8fd['id']+_0x436e5b(0xbf)+_0x13e8fd[_0x436e5b(0xe5)]+'\x20->\x20'+_0x3c70f7+_0x436e5b(0xf8)+_0x13e8fd[_0x436e5b(0xb9)]+_0x436e5b(0x8e)+_0x5b8461);}else console['log'](_0x436e5b(0xac)+_0x39ef9e[_0x436e5b(0xa5)]+_0x436e5b(0x104));});}catch(_0x4c8ef5){console[_0x234da8(0xc2)](_0x234da8(0x89),_0x4c8ef5);}}await database_1[_0x234da8(0x105)][_0x234da8(0xeb)]['create']({'data':{'paymentId':_0x39ef9e['id'],'shopId':_0x39ef9e[_0x234da8(0xea)],'event':'test_gateway_'+_0x19eba1[_0x234da8(0xb9)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x234da8(0xdf)]({'oldStatus':'PENDING','newStatus':_0x19eba1[_0x234da8(0xb9)],'transactionId':_0x19eba1['transactionId'],'failureReason':_0x19eba1[_0x234da8(0xb5)],'processedAt':new Date()[_0x234da8(0xed)]()})}}),await this[_0x234da8(0xf0)](_0x39ef9e,_0x19eba1[_0x234da8(0xb9)],_0x19eba1[_0x234da8(0xd7)],_0x19eba1[_0x234da8(0xb5)]),await this[_0x234da8(0x8c)](_0x39ef9e,_0x19eba1[_0x234da8(0xb9)]),console[_0x234da8(0x100)](_0x234da8(0xfa)+_0x3ab28a+_0x234da8(0xe0)+_0x19eba1[_0x234da8(0xb9)]),_0x19eba1[_0x234da8(0xb9)]===_0x234da8(0x101)?_0x4837ca[_0x234da8(0x9e)]({'success':!![],'message':_0x234da8(0xc7),'result':{'status':_0x234da8(0x101),'transactionId':_0x19eba1['transactionId'],'redirectUrl':_0x39ef9e[_0x234da8(0xd3)]}}):_0x4837ca['status'](0x190)[_0x234da8(0x9e)]({'success':![],'message':_0x234da8(0xaf),'result':{'status':_0x234da8(0x92),'failureReason':_0x19eba1[_0x234da8(0xb5)],'redirectUrl':_0x39ef9e[_0x234da8(0xec)]}});}catch(_0x16927a){_0x4611c0(_0x16927a);}},this[_0x40f20e(0xe8)]=new testGatewayService_1[(_0x40f20e(0xdc))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a14_0x2147b9(0xf0)](_0x9cd0c1,_0x57ce7b,_0x554a90,_0x586572){const _0x4807f3=a14_0x2147b9,_0x672dab=Date['now']();try{const _0x1c7bb8=_0x9cd0c1[_0x4807f3(0xde)],_0x4c2b80=_0x1c7bb8['settings'];if(!_0x4c2b80?.[_0x4807f3(0x90)]){console['log'](_0x4807f3(0xd4)+_0x1c7bb8['id']);return;}const _0x37e7c0=_0x57ce7b===_0x4807f3(0x101)?'payment.success':_0x4807f3(0xa7);let _0x1f4f76=[];if(_0x4c2b80['webhookEvents'])try{_0x1f4f76=Array[_0x4807f3(0xe4)](_0x4c2b80[_0x4807f3(0xce)])?_0x4c2b80[_0x4807f3(0xce)]:JSON['parse'](_0x4c2b80[_0x4807f3(0xce)]);}catch(_0x413d1b){console[_0x4807f3(0xc2)](_0x4807f3(0x8b),_0x413d1b),_0x1f4f76=[];}if(!_0x1f4f76[_0x4807f3(0xa3)](_0x37e7c0)){console[_0x4807f3(0x100)](_0x4807f3(0xfc)+_0x37e7c0+_0x4807f3(0xfb)+_0x1c7bb8['id']);return;}const _0x4d5087={'event':_0x37e7c0,'payment':{'id':_0x9cd0c1['id'],'order_id':_0x9cd0c1['orderId'],'gateway_order_id':_0x9cd0c1[_0x4807f3(0x9d)],'gateway':_0x4807f3(0xf7),'amount':_0x9cd0c1[_0x4807f3(0xae)],'currency':_0x9cd0c1[_0x4807f3(0xcd)],'status':_0x57ce7b[_0x4807f3(0xe9)](),'customer_email':_0x9cd0c1[_0x4807f3(0xad)],'customer_name':_0x9cd0c1['customerName'],'transaction_id':_0x554a90,'failure_message':_0x586572,'created_at':_0x9cd0c1[_0x4807f3(0xd2)],'updated_at':new Date()}},_0x51e35c=await fetch(_0x4c2b80[_0x4807f3(0x90)],{'method':_0x4807f3(0xfe),'headers':{'Content-Type':_0x4807f3(0xd8),'User-Agent':_0x4807f3(0x96)},'body':JSON[_0x4807f3(0xdf)](_0x4d5087)}),_0x4968ca=Date[_0x4807f3(0x8d)]()-_0x672dab;console[_0x4807f3(0x100)](_0x4807f3(0x94)+_0x4c2b80[_0x4807f3(0x90)]+'\x20with\x20status\x20'+_0x51e35c[_0x4807f3(0xb9)]+'\x20('+_0x4968ca+_0x4807f3(0x103));}catch(_0x18d6df){console[_0x4807f3(0xc2)](_0x4807f3(0xa9),_0x18d6df);}}async['sendPaymentStatusNotification'](_0x407bca,_0x35e158){const _0x4c2eeb=a14_0x2147b9;try{const {telegramBotService:_0xa3654}=await Promise[_0x4c2eeb(0xd1)]()[_0x4c2eeb(0xaa)](()=>__importStar(require('../services/telegramBotService'))),_0x53d199={'PAID':_0x4c2eeb(0xda),'FAILED':_0x4c2eeb(0xab)},_0x3dd6ea=_0x53d199[_0x35e158];if(!_0x3dd6ea)return;await _0xa3654[_0x4c2eeb(0xf4)](_0x407bca[_0x4c2eeb(0xea)],_0x407bca,_0x3dd6ea);}catch(_0x140027){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x140027);}}}exports[a14_0x2147b9(0x9c)]=TestGatewayController;function a14_0x5cdb(){const _0x27f167=['failureReason','slice','payment','call','status','__setModuleDefault','findUnique','params',',\x20currentPayments=','prototype','\x20updated:\x20currentPayments=','📈\x20Found\x20payment\x20link\x20','315SLFnQk','error','failureMessage','configurable','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','841473DrnzfU','Payment\x20processed\x20successfully','../config/database','10728iQbmPs','../services/webhookService','getPaymentForm','7bLcFys','currency','webhookEvents','🧪\x20Test\x20Gateway\x20result:','processCard','resolve','createdAt','successUrl','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentMethod','Payment\x20to\x20','transactionId','application/json','4rRpthv','paid','1nCIHhu','TestGatewayService','2324643DEpRqh','shop','stringify','\x20processed:\x20','length','PENDING','gateway','isArray','currentPayments','__createBinding','__esModule','testGatewayService','toLowerCase','shopId','webhookLog','failUrl','toISOString','../services/gateways/testGatewayService','type','sendShopWebhook','name','📈\x20Test\x20Gateway:\x20Payment\x20','Any\x20name','sendPaymentNotification','writable','SINGLE','0000',',\x20status=',',\x20cannot\x20process','✅\x20Test\x20Gateway\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','Webhook\x20event\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','POST','4242\x204242\x204242\x204242','log','PAID','paymentLink','ms)','\x20not\x20found','default','Payment\x20not\x20found','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','test_gateway','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','body','Error\x20parsing\x20webhook\x20events:','sendPaymentStatusNotification','now','\x20->\x20','11KQGneg','webhookUrl','processCardPayment','FAILED','create','Test\x20Gateway\x20webhook\x20sent\x20to\x20','hasOwnProperty','Payment\x20System/1.0\x20(Test\x20Gateway)','getOwnPropertyNames','__importStar',':\x20type=','Any\x20other\x20card\x20number','COMPLETED','TestGatewayController','gatewayOrderId','json','$transaction','982578OOAAps','defineProperty','update','includes','6134936FExiTw','paymentLinkId','getOwnPropertyDescriptor','payment.failed','Any\x203-4\x20digits','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','then','failed','❌\x20Payment\x20link\x20','customerEmail','amount','Payment\x20failed','replace','test_card','3760240rEsegj','Any\x20future\x20date\x20(MM/YY)','25043052JnhGcd'];a14_0x5cdb=function(){return _0x27f167;};return a14_0x5cdb();}