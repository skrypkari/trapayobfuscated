'use strict';const a13_0x150160=a13_0x2c82;(function(_0x5a4c2f,_0x36b0f2){const _0x5e5f43=a13_0x2c82,_0x4b175c=_0x5a4c2f();while(!![]){try{const _0x46594f=-parseInt(_0x5e5f43(0x13f))/0x1+parseInt(_0x5e5f43(0x1a7))/0x2*(parseInt(_0x5e5f43(0x149))/0x3)+-parseInt(_0x5e5f43(0x19e))/0x4*(-parseInt(_0x5e5f43(0x174))/0x5)+-parseInt(_0x5e5f43(0x15c))/0x6+parseInt(_0x5e5f43(0x1ad))/0x7+parseInt(_0x5e5f43(0x14b))/0x8*(-parseInt(_0x5e5f43(0x182))/0x9)+parseInt(_0x5e5f43(0x147))/0xa;if(_0x46594f===_0x36b0f2)break;else _0x4b175c['push'](_0x4b175c['shift']());}catch(_0x3ec946){_0x4b175c['push'](_0x4b175c['shift']());}}}(a13_0x42c6,0x28735));function a13_0x42c6(){const _0x3de9a5=['Any\x203-4\x20digits','failureMessage','1046tsSMAG','log','now','0000',':\x20type=','test_gateway_','1339597rbpmly',',\x20cannot\x20process','currentPayments','processCardPayment','__importStar','toLowerCase','length','104349cwhFwp','hasOwnProperty','get','Error\x20parsing\x20webhook\x20events:','Payment\x20not\x20found','failed','\x20->\x20','getOwnPropertyDescriptor','271830PLSezW','PENDING','1362UxOjVk','\x20with\x20status\x20','55896QaRNju','payment','../services/telegramBotService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','test_gateway','create','configurable','customerName','../services/gateways/testGatewayService','__setModuleDefault','webhookUrl','Test\x20Gateway\x20webhook\x20sent\x20to\x20',',\x20status=','processCard','sendShopWebhook','üìà\x20Test\x20Gateway:\x20Payment\x20','orderId','137436VyPgxl','isArray','transactionId','replace','findUnique','gateway','ms)','Any\x20other\x20card\x20number','Any\x20future\x20date\x20(MM/YY)','payment.failed','Payment\x20processed\x20successfully','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','\x20processed:\x20','paid','stringify','‚ùå\x20Payment\x20link\x20','../services/webhookService','\x20not\x20found','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','successUrl','testGatewayService','__importDefault','test_card','amount','10TAADeI','call','json','defineProperty','Payment\x20status\x20is\x20','paymentLinkId','default','paidAt','currency','cardNumber','cardLast4','sendPaymentStatusNotification','shopId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','306VsicwA','toISOString','params','getOwnPropertyNames','‚úÖ\x20Payment\x20link\x20','shop','TestGatewayService','Payment\x20to\x20','__esModule','4242\x204242\x204242\x204242','customerEmail','webhookService','COMPLETED','PAID','üìà\x20Found\x20payment\x20link\x20','Any\x20name','name','failureReason','sendPaymentNotification','Payment\x20is\x20not\x20for\x20test\x20gateway','getPaymentForm','status','FAILED','gatewayOrderId','SINGLE','payment.success','then','prototype','149004woeNIE','error','../config/database','webhookEvents','includes','‚úÖ\x20Test\x20Gateway\x20payment\x20','paymentMethod'];a13_0x42c6=function(){return _0x3de9a5;};return a13_0x42c6();}var __createBinding=this&&this['__createBinding']||(Object[a13_0x150160(0x150)]?function(_0x1fa621,_0x4b233d,_0x2249ed,_0x95059){const _0x49542c=a13_0x150160;if(_0x95059===undefined)_0x95059=_0x2249ed;var _0x448e22=Object[_0x49542c(0x146)](_0x4b233d,_0x2249ed);(!_0x448e22||(_0x49542c(0x141)in _0x448e22?!_0x4b233d[_0x49542c(0x18a)]:_0x448e22['writable']||_0x448e22[_0x49542c(0x151)]))&&(_0x448e22={'enumerable':!![],'get':function(){return _0x4b233d[_0x2249ed];}}),Object[_0x49542c(0x177)](_0x1fa621,_0x95059,_0x448e22);}:function(_0x9d70ba,_0x4b6890,_0x3059c5,_0x40f790){if(_0x40f790===undefined)_0x40f790=_0x3059c5;_0x9d70ba[_0x40f790]=_0x4b6890[_0x3059c5];}),__setModuleDefault=this&&this[a13_0x150160(0x154)]||(Object[a13_0x150160(0x150)]?function(_0x32ff11,_0x47d554){const _0x2cc235=a13_0x150160;Object[_0x2cc235(0x177)](_0x32ff11,_0x2cc235(0x17a),{'enumerable':!![],'value':_0x47d554});}:function(_0x40dc07,_0x47eaf6){const _0x443107=a13_0x150160;_0x40dc07[_0x443107(0x17a)]=_0x47eaf6;}),__importStar=this&&this[a13_0x150160(0x1b1)]||(function(){var _0xed40fd=function(_0xead87e){const _0x318568=a13_0x2c82;return _0xed40fd=Object[_0x318568(0x185)]||function(_0x402db0){const _0x95d7c4=_0x318568;var _0x4aad9d=[];for(var _0x5aa7b8 in _0x402db0)if(Object[_0x95d7c4(0x19d)][_0x95d7c4(0x140)][_0x95d7c4(0x175)](_0x402db0,_0x5aa7b8))_0x4aad9d[_0x4aad9d[_0x95d7c4(0x13e)]]=_0x5aa7b8;return _0x4aad9d;},_0xed40fd(_0xead87e);};return function(_0x1dbb66){const _0x329da5=a13_0x2c82;if(_0x1dbb66&&_0x1dbb66['__esModule'])return _0x1dbb66;var _0x41a70a={};if(_0x1dbb66!=null){for(var _0x407863=_0xed40fd(_0x1dbb66),_0x404a7c=0x0;_0x404a7c<_0x407863['length'];_0x404a7c++)if(_0x407863[_0x404a7c]!==_0x329da5(0x17a))__createBinding(_0x41a70a,_0x1dbb66,_0x407863[_0x404a7c]);}return __setModuleDefault(_0x41a70a,_0x1dbb66),_0x41a70a;};}()),__importDefault=this&&this[a13_0x150160(0x171)]||function(_0x221068){const _0x260f38=a13_0x150160;return _0x221068&&_0x221068[_0x260f38(0x18a)]?_0x221068:{'default':_0x221068};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x150160(0x153)),webhookService_1=require(a13_0x150160(0x16c)),database_1=__importDefault(require(a13_0x150160(0x1a0)));class TestGatewayController{constructor(){const _0x2d0360=a13_0x150160;this[_0x2d0360(0x196)]=async(_0x3c8c59,_0x16a042,_0x14de63)=>{const _0x29b514=_0x2d0360;try{const {paymentId:_0x21043e}=_0x3c8c59[_0x29b514(0x184)];console[_0x29b514(0x1a8)](_0x29b514(0x167)+_0x21043e);const _0x5f5185=await database_1[_0x29b514(0x17a)]['payment'][_0x29b514(0x160)]({'where':{'id':_0x21043e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5f5185)return _0x16a042[_0x29b514(0x197)](0x194)[_0x29b514(0x176)]({'success':![],'message':_0x29b514(0x143)});if(_0x5f5185[_0x29b514(0x161)]!=='test_gateway')return _0x16a042[_0x29b514(0x197)](0x190)[_0x29b514(0x176)]({'success':![],'message':_0x29b514(0x195)});if(_0x5f5185[_0x29b514(0x197)]!=='PENDING')return _0x16a042['status'](0x190)['json']({'success':![],'message':_0x29b514(0x178)+_0x5f5185[_0x29b514(0x197)]+_0x29b514(0x1ae)});_0x16a042[_0x29b514(0x176)]({'success':!![],'result':{'paymentId':_0x5f5185['id'],'orderId':_0x5f5185['gatewayOrderId'],'amount':_0x5f5185[_0x29b514(0x173)],'currency':_0x5f5185[_0x29b514(0x17c)],'merchantName':_0x5f5185[_0x29b514(0x187)][_0x29b514(0x192)],'description':_0x29b514(0x189)+_0x5f5185[_0x29b514(0x187)][_0x29b514(0x192)],'testInstructions':{'successCard':_0x29b514(0x18b),'failureCard':_0x29b514(0x163),'expiryDate':_0x29b514(0x164),'cvc':_0x29b514(0x1a5),'holderName':_0x29b514(0x191)}}});}catch(_0x2cc13e){_0x14de63(_0x2cc13e);}},this[_0x2d0360(0x158)]=async(_0x4be02b,_0x411bc9,_0x18dc18)=>{const _0x1fbba2=_0x2d0360;try{const {paymentId:_0x173ad2}=_0x4be02b[_0x1fbba2(0x184)],_0x57555a=_0x4be02b['body'];console[_0x1fbba2(0x1a8)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x173ad2);const _0x3e9191=await database_1['default']['payment']['findUnique']({'where':{'id':_0x173ad2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e9191)return _0x411bc9[_0x1fbba2(0x197)](0x194)['json']({'success':![],'message':_0x1fbba2(0x143)});if(_0x3e9191[_0x1fbba2(0x161)]!==_0x1fbba2(0x14f))return _0x411bc9[_0x1fbba2(0x197)](0x190)[_0x1fbba2(0x176)]({'success':![],'message':_0x1fbba2(0x195)});if(_0x3e9191['status']!=='PENDING')return _0x411bc9[_0x1fbba2(0x197)](0x190)[_0x1fbba2(0x176)]({'success':![],'message':_0x1fbba2(0x178)+_0x3e9191[_0x1fbba2(0x197)]+_0x1fbba2(0x1ae)});const _0x5865de=await this['testGatewayService'][_0x1fbba2(0x1b0)]({'paymentId':_0x3e9191['id'],'orderId':_0x3e9191[_0x1fbba2(0x199)]||_0x3e9191['id'],'amount':_0x3e9191['amount'],'currency':_0x3e9191[_0x1fbba2(0x17c)],'cardData':_0x57555a});console[_0x1fbba2(0x1a8)]('üß™\x20Test\x20Gateway\x20result:',_0x5865de);const _0x232fc8={'status':_0x5865de[_0x1fbba2(0x197)],'updatedAt':new Date()};if(_0x5865de['status']===_0x1fbba2(0x18f))_0x232fc8[_0x1fbba2(0x17b)]=new Date(),_0x232fc8['gatewayPaymentId']=_0x5865de[_0x1fbba2(0x15e)];else _0x5865de[_0x1fbba2(0x197)]===_0x1fbba2(0x198)&&(_0x232fc8[_0x1fbba2(0x1a6)]=_0x5865de[_0x1fbba2(0x193)]);const _0x66c749=_0x57555a[_0x1fbba2(0x17d)][_0x1fbba2(0x15f)](/[\s-]/g,'');_0x232fc8[_0x1fbba2(0x17e)]=_0x66c749['slice'](-0x4),_0x232fc8[_0x1fbba2(0x1a4)]=_0x1fbba2(0x172),await database_1[_0x1fbba2(0x17a)][_0x1fbba2(0x14c)]['update']({'where':{'id':_0x3e9191['id']},'data':_0x232fc8});if(_0x5865de[_0x1fbba2(0x197)]===_0x1fbba2(0x18f)&&_0x3e9191[_0x1fbba2(0x179)]){console[_0x1fbba2(0x1a8)](_0x1fbba2(0x15a)+_0x3e9191['id']+_0x1fbba2(0x14e));try{await database_1[_0x1fbba2(0x17a)]['$transaction'](async _0x3e6b1d=>{const _0x1b6490=_0x1fbba2,_0x11b2d7=await _0x3e6b1d['paymentLink'][_0x1b6490(0x160)]({'where':{'id':_0x3e9191[_0x1b6490(0x179)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x11b2d7){console[_0x1b6490(0x1a8)](_0x1b6490(0x190)+_0x11b2d7['id']+_0x1b6490(0x1ab)+_0x11b2d7['type']+',\x20currentPayments='+_0x11b2d7[_0x1b6490(0x1af)]+',\x20status='+_0x11b2d7[_0x1b6490(0x197)]);const _0x55182f=_0x11b2d7[_0x1b6490(0x1af)]+0x1,_0x440846=_0x11b2d7['type']===_0x1b6490(0x19a)?_0x1b6490(0x18e):_0x11b2d7[_0x1b6490(0x197)];await _0x3e6b1d['paymentLink']['update']({'where':{'id':_0x3e9191[_0x1b6490(0x179)]},'data':{'currentPayments':_0x55182f,'status':_0x440846,'updatedAt':new Date()}}),console['log'](_0x1b6490(0x186)+_0x11b2d7['id']+'\x20updated:\x20currentPayments='+_0x11b2d7[_0x1b6490(0x1af)]+_0x1b6490(0x145)+_0x55182f+_0x1b6490(0x157)+_0x11b2d7['status']+_0x1b6490(0x145)+_0x440846);}else console['log'](_0x1b6490(0x16b)+_0x3e9191[_0x1b6490(0x179)]+_0x1b6490(0x16d));});}catch(_0x110e00){console[_0x1fbba2(0x19f)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x110e00);}}await database_1[_0x1fbba2(0x17a)]['webhookLog'][_0x1fbba2(0x150)]({'data':{'paymentId':_0x3e9191['id'],'shopId':_0x3e9191[_0x1fbba2(0x180)],'event':_0x1fbba2(0x1ac)+_0x5865de[_0x1fbba2(0x197)][_0x1fbba2(0x1b2)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1fbba2(0x148),'newStatus':_0x5865de[_0x1fbba2(0x197)],'transactionId':_0x5865de[_0x1fbba2(0x15e)],'failureReason':_0x5865de[_0x1fbba2(0x193)],'processedAt':new Date()[_0x1fbba2(0x183)]()})}}),await this[_0x1fbba2(0x159)](_0x3e9191,_0x5865de[_0x1fbba2(0x197)],_0x5865de[_0x1fbba2(0x15e)],_0x5865de['failureReason']),await this['sendPaymentStatusNotification'](_0x3e9191,_0x5865de['status']),console['log'](_0x1fbba2(0x1a3)+_0x173ad2+_0x1fbba2(0x168)+_0x5865de['status']),_0x5865de[_0x1fbba2(0x197)]===_0x1fbba2(0x18f)?_0x411bc9[_0x1fbba2(0x176)]({'success':!![],'message':_0x1fbba2(0x166),'result':{'status':_0x1fbba2(0x18f),'transactionId':_0x5865de[_0x1fbba2(0x15e)],'redirectUrl':_0x3e9191[_0x1fbba2(0x16f)]}}):_0x411bc9['status'](0x190)[_0x1fbba2(0x176)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x5865de['failureReason'],'redirectUrl':_0x3e9191['failUrl']}});}catch(_0x3e0cb7){_0x18dc18(_0x3e0cb7);}},this[_0x2d0360(0x170)]=new testGatewayService_1[(_0x2d0360(0x188))](),this[_0x2d0360(0x18d)]=new webhookService_1['WebhookService']();}async[a13_0x150160(0x159)](_0x4a6ff3,_0x131d54,_0xd87901,_0x28f32b){const _0x2ad30d=a13_0x150160,_0x26cf38=Date[_0x2ad30d(0x1a9)]();try{const _0x3779cf=_0x4a6ff3['shop'],_0x2b47e7=_0x3779cf['settings'];if(!_0x2b47e7?.[_0x2ad30d(0x155)]){console[_0x2ad30d(0x1a8)](_0x2ad30d(0x181)+_0x3779cf['id']);return;}const _0x3cd60d=_0x131d54===_0x2ad30d(0x18f)?_0x2ad30d(0x19b):_0x2ad30d(0x165);let _0x35658e=[];if(_0x2b47e7[_0x2ad30d(0x1a1)])try{_0x35658e=Array[_0x2ad30d(0x15d)](_0x2b47e7[_0x2ad30d(0x1a1)])?_0x2b47e7[_0x2ad30d(0x1a1)]:JSON['parse'](_0x2b47e7['webhookEvents']);}catch(_0x859fbf){console['error'](_0x2ad30d(0x142),_0x859fbf),_0x35658e=[];}if(!_0x35658e[_0x2ad30d(0x1a2)](_0x3cd60d)){console[_0x2ad30d(0x1a8)]('Webhook\x20event\x20'+_0x3cd60d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3779cf['id']);return;}const _0x51ad7f={'event':_0x3cd60d,'payment':{'id':_0x4a6ff3['id'],'order_id':_0x4a6ff3[_0x2ad30d(0x15b)],'gateway_order_id':_0x4a6ff3[_0x2ad30d(0x199)],'gateway':_0x2ad30d(0x1aa),'amount':_0x4a6ff3[_0x2ad30d(0x173)],'currency':_0x4a6ff3[_0x2ad30d(0x17c)],'status':_0x131d54[_0x2ad30d(0x1b2)](),'customer_email':_0x4a6ff3[_0x2ad30d(0x18c)],'customer_name':_0x4a6ff3[_0x2ad30d(0x152)],'transaction_id':_0xd87901,'failure_message':_0x28f32b,'created_at':_0x4a6ff3['createdAt'],'updated_at':new Date()}},_0x5b259e=await fetch(_0x2b47e7[_0x2ad30d(0x155)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x2ad30d(0x16a)](_0x51ad7f)}),_0x4d583b=Date[_0x2ad30d(0x1a9)]()-_0x26cf38;console['log'](_0x2ad30d(0x156)+_0x2b47e7[_0x2ad30d(0x155)]+_0x2ad30d(0x14a)+_0x5b259e[_0x2ad30d(0x197)]+'\x20('+_0x4d583b+_0x2ad30d(0x162));}catch(_0x58c420){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x58c420);}}async[a13_0x150160(0x17f)](_0x3ee75a,_0x332908){const _0x5b069a=a13_0x150160;try{const {telegramBotService:_0x1e2ec1}=await Promise['resolve']()[_0x5b069a(0x19c)](()=>__importStar(require(_0x5b069a(0x14d)))),_0x43b8a6={'PAID':_0x5b069a(0x169),'FAILED':_0x5b069a(0x144)},_0x53ee7d=_0x43b8a6[_0x332908];if(!_0x53ee7d)return;await _0x1e2ec1[_0x5b069a(0x194)](_0x3ee75a[_0x5b069a(0x180)],_0x3ee75a,_0x53ee7d);}catch(_0x4ecd6a){console[_0x5b069a(0x19f)](_0x5b069a(0x16e),_0x4ecd6a);}}}function a13_0x2c82(_0x456aa2,_0x5ea414){const _0x42c6fa=a13_0x42c6();return a13_0x2c82=function(_0x2c82e4,_0x1b279e){_0x2c82e4=_0x2c82e4-0x13e;let _0x576703=_0x42c6fa[_0x2c82e4];return _0x576703;},a13_0x2c82(_0x456aa2,_0x5ea414);}exports['TestGatewayController']=TestGatewayController;