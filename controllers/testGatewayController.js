'use strict';const a14_0x10d0ed=a14_0xc7ec;(function(_0x27670d,_0x3f8120){const _0xf8894b=a14_0xc7ec,_0x3e91f9=_0x27670d();while(!![]){try{const _0x5603a0=parseInt(_0xf8894b(0x22f))/0x1*(parseInt(_0xf8894b(0x254))/0x2)+-parseInt(_0xf8894b(0x21b))/0x3*(parseInt(_0xf8894b(0x1f0))/0x4)+parseInt(_0xf8894b(0x267))/0x5+parseInt(_0xf8894b(0x207))/0x6*(-parseInt(_0xf8894b(0x1ff))/0x7)+parseInt(_0xf8894b(0x24e))/0x8*(-parseInt(_0xf8894b(0x245))/0x9)+parseInt(_0xf8894b(0x239))/0xa*(-parseInt(_0xf8894b(0x265))/0xb)+parseInt(_0xf8894b(0x257))/0xc*(parseInt(_0xf8894b(0x235))/0xd);if(_0x5603a0===_0x3f8120)break;else _0x3e91f9['push'](_0x3e91f9['shift']());}catch(_0x17aeca){_0x3e91f9['push'](_0x3e91f9['shift']());}}}(a14_0x5c71,0x60f5d));var __createBinding=this&&this['__createBinding']||(Object[a14_0x10d0ed(0x259)]?function(_0x4a592a,_0x57c3f3,_0x4d9386,_0x3c0a5c){const _0x11e6df=a14_0x10d0ed;if(_0x3c0a5c===undefined)_0x3c0a5c=_0x4d9386;var _0x2d7821=Object[_0x11e6df(0x223)](_0x57c3f3,_0x4d9386);(!_0x2d7821||(_0x11e6df(0x244)in _0x2d7821?!_0x57c3f3[_0x11e6df(0x203)]:_0x2d7821[_0x11e6df(0x221)]||_0x2d7821[_0x11e6df(0x1fb)]))&&(_0x2d7821={'enumerable':!![],'get':function(){return _0x57c3f3[_0x4d9386];}}),Object['defineProperty'](_0x4a592a,_0x3c0a5c,_0x2d7821);}:function(_0x3205a4,_0x4ecdab,_0x262b19,_0x3c4184){if(_0x3c4184===undefined)_0x3c4184=_0x262b19;_0x3205a4[_0x3c4184]=_0x4ecdab[_0x262b19];}),__setModuleDefault=this&&this[a14_0x10d0ed(0x20c)]||(Object['create']?function(_0xffbd72,_0x171a98){const _0x157d78=a14_0x10d0ed;Object[_0x157d78(0x1f8)](_0xffbd72,_0x157d78(0x21d),{'enumerable':!![],'value':_0x171a98});}:function(_0x2513ee,_0x5189d8){const _0x2d7359=a14_0x10d0ed;_0x2513ee[_0x2d7359(0x21d)]=_0x5189d8;}),__importStar=this&&this[a14_0x10d0ed(0x21f)]||(function(){var _0x2be0b6=function(_0xba6db9){return _0x2be0b6=Object['getOwnPropertyNames']||function(_0x212a40){const _0x23e06d=a14_0xc7ec;var _0x693a8f=[];for(var _0x5623ee in _0x212a40)if(Object[_0x23e06d(0x209)]['hasOwnProperty'][_0x23e06d(0x266)](_0x212a40,_0x5623ee))_0x693a8f[_0x693a8f['length']]=_0x5623ee;return _0x693a8f;},_0x2be0b6(_0xba6db9);};return function(_0x58e598){const _0x1e10b4=a14_0xc7ec;if(_0x58e598&&_0x58e598['__esModule'])return _0x58e598;var _0x488b98={};if(_0x58e598!=null){for(var _0x4e1f56=_0x2be0b6(_0x58e598),_0x251811=0x0;_0x251811<_0x4e1f56[_0x1e10b4(0x22e)];_0x251811++)if(_0x4e1f56[_0x251811]!==_0x1e10b4(0x21d))__createBinding(_0x488b98,_0x58e598,_0x4e1f56[_0x251811]);}return __setModuleDefault(_0x488b98,_0x58e598),_0x488b98;};}()),__importDefault=this&&this[a14_0x10d0ed(0x20a)]||function(_0x450162){const _0x59e9bd=a14_0x10d0ed;return _0x450162&&_0x450162[_0x59e9bd(0x203)]?_0x450162:{'default':_0x450162};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a14_0x10d0ed(0x1ec)]=void 0x0;function a14_0x5c71(){const _0x18cc41=['SINGLE','1740WjLyAq','$transaction','isArray','ms)','test_gateway_','../services/webhookService','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','PENDING','params','sendShopWebhook','get','45PuSjvm','Webhook\x20event\x20','Payment\x20processed\x20successfully','test_card','amount','body','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','cardLast4','Any\x203-4\x20digits','707008ZmPsXK','gateway','paymentLink','log','../config/database','getPaymentForm','86GvEoEr','currency','paidAt','12AOvgto','Payment\x20to\x20','create','failUrl','\x20not\x20found','parse','TestGatewayService','webhookUrl','slice','gatewayOrderId','application/json','Any\x20other\x20card\x20number','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','✅\x20Test\x20Gateway\x20payment\x20','7480CyAQSJ','call','2249865HlIEHz','../services/gateways/testGatewayService','TestGatewayController','Any\x20future\x20date\x20(MM/YY)','findUnique','sendPaymentNotification','213628PRXWxH','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20->\x20','successUrl','PAID','includes','webhookLog','sendPaymentStatusNotification','defineProperty','status','failureReason','configurable','0000','payment','paymentLinkId','7EIaNQl','name','Payment\x20not\x20found','Error\x20parsing\x20webhook\x20events:','__esModule','settings',',\x20status=','customerEmail','2494194uIepwB','cardNumber','prototype','__importDefault','replace','__setModuleDefault','📈\x20Found\x20payment\x20link\x20','payment.success','type','FAILED','currentPayments','\x20processed:\x20','resolve','webhookEvents','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','❌\x20Payment\x20link\x20','\x20with\x20status\x20','test_gateway','orderId','stringify','24kAcSOi','Test\x20Gateway\x20webhook\x20sent\x20to\x20','default','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','__importStar','Payment\x20failed','writable','now','getOwnPropertyDescriptor','shop','webhookService','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','toLowerCase','then','4242\x204242\x204242\x204242','WebhookService','toISOString','paid','error','length','6005seJtHm','transactionId','Payment\x20status\x20is\x20','\x20not\x20enabled\x20for\x20shop\x20','json','failed','14197508WUiwCe',',\x20cannot\x20process','COMPLETED'];a14_0x5c71=function(){return _0x18cc41;};return a14_0x5c71();}function a14_0xc7ec(_0xbfb294,_0x44a87e){const _0x5c7182=a14_0x5c71();return a14_0xc7ec=function(_0xc7eccc,_0x518377){_0xc7eccc=_0xc7eccc-0x1eb;let _0x234e91=_0x5c7182[_0xc7eccc];return _0x234e91;},a14_0xc7ec(_0xbfb294,_0x44a87e);}const testGatewayService_1=require(a14_0x10d0ed(0x1eb)),webhookService_1=require(a14_0x10d0ed(0x23e)),database_1=__importDefault(require(a14_0x10d0ed(0x252)));class TestGatewayController{constructor(){const _0x5b0411=a14_0x10d0ed;this[_0x5b0411(0x253)]=async(_0x343d6a,_0x5a1fcb,_0xdca8f7)=>{const _0x1478b1=_0x5b0411;try{const {paymentId:_0x1c3530}=_0x343d6a[_0x1478b1(0x242)];console[_0x1478b1(0x251)](_0x1478b1(0x21e)+_0x1c3530);const _0x3936af=await database_1['default'][_0x1478b1(0x1fd)][_0x1478b1(0x1ee)]({'where':{'id':_0x1c3530},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3936af)return _0x5a1fcb[_0x1478b1(0x1f9)](0x194)[_0x1478b1(0x233)]({'success':![],'message':_0x1478b1(0x201)});if(_0x3936af[_0x1478b1(0x24f)]!==_0x1478b1(0x218))return _0x5a1fcb[_0x1478b1(0x1f9)](0x190)[_0x1478b1(0x233)]({'success':![],'message':_0x1478b1(0x240)});if(_0x3936af['status']!==_0x1478b1(0x241))return _0x5a1fcb[_0x1478b1(0x1f9)](0x190)[_0x1478b1(0x233)]({'success':![],'message':_0x1478b1(0x231)+_0x3936af[_0x1478b1(0x1f9)]+_0x1478b1(0x236)});_0x5a1fcb['json']({'success':!![],'result':{'paymentId':_0x3936af['id'],'orderId':_0x3936af[_0x1478b1(0x260)],'amount':_0x3936af[_0x1478b1(0x249)],'currency':_0x3936af[_0x1478b1(0x255)],'merchantName':_0x3936af[_0x1478b1(0x224)]['name'],'description':_0x1478b1(0x258)+_0x3936af[_0x1478b1(0x224)][_0x1478b1(0x200)],'testInstructions':{'successCard':_0x1478b1(0x229),'failureCard':_0x1478b1(0x262),'expiryDate':_0x1478b1(0x1ed),'cvc':_0x1478b1(0x24d),'holderName':'Any\x20name'}}});}catch(_0x53dabd){_0xdca8f7(_0x53dabd);}},this['processCard']=async(_0x3de269,_0x217694,_0x43bcd1)=>{const _0xfbe01f=_0x5b0411;try{const {paymentId:_0x25db9e}=_0x3de269[_0xfbe01f(0x242)],_0x48190b=_0x3de269[_0xfbe01f(0x24a)];console[_0xfbe01f(0x251)](_0xfbe01f(0x23f)+_0x25db9e);const _0xc1aab9=await database_1[_0xfbe01f(0x21d)]['payment'][_0xfbe01f(0x1ee)]({'where':{'id':_0x25db9e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xc1aab9)return _0x217694[_0xfbe01f(0x1f9)](0x194)[_0xfbe01f(0x233)]({'success':![],'message':_0xfbe01f(0x201)});if(_0xc1aab9['gateway']!==_0xfbe01f(0x218))return _0x217694['status'](0x190)[_0xfbe01f(0x233)]({'success':![],'message':_0xfbe01f(0x240)});if(_0xc1aab9['status']!==_0xfbe01f(0x241))return _0x217694[_0xfbe01f(0x1f9)](0x190)[_0xfbe01f(0x233)]({'success':![],'message':_0xfbe01f(0x231)+_0xc1aab9[_0xfbe01f(0x1f9)]+_0xfbe01f(0x236)});const _0x5adb36=await this['testGatewayService']['processCardPayment']({'paymentId':_0xc1aab9['id'],'orderId':_0xc1aab9[_0xfbe01f(0x260)]||_0xc1aab9['id'],'amount':_0xc1aab9[_0xfbe01f(0x249)],'currency':_0xc1aab9[_0xfbe01f(0x255)],'cardData':_0x48190b});console[_0xfbe01f(0x251)]('🧪\x20Test\x20Gateway\x20result:',_0x5adb36);const _0x17a0d3={'status':_0x5adb36[_0xfbe01f(0x1f9)],'updatedAt':new Date()};if(_0x5adb36[_0xfbe01f(0x1f9)]===_0xfbe01f(0x1f4))_0x17a0d3[_0xfbe01f(0x256)]=new Date(),_0x17a0d3['gatewayPaymentId']=_0x5adb36[_0xfbe01f(0x230)];else _0x5adb36[_0xfbe01f(0x1f9)]===_0xfbe01f(0x210)&&(_0x17a0d3['failureMessage']=_0x5adb36['failureReason']);const _0x4e729d=_0x48190b[_0xfbe01f(0x208)][_0xfbe01f(0x20b)](/[\s-]/g,'');_0x17a0d3[_0xfbe01f(0x24c)]=_0x4e729d[_0xfbe01f(0x25f)](-0x4),_0x17a0d3['paymentMethod']=_0xfbe01f(0x248),await database_1[_0xfbe01f(0x21d)][_0xfbe01f(0x1fd)]['update']({'where':{'id':_0xc1aab9['id']},'data':_0x17a0d3});if(_0x5adb36[_0xfbe01f(0x1f9)]===_0xfbe01f(0x1f4)&&_0xc1aab9[_0xfbe01f(0x1fe)]){console[_0xfbe01f(0x251)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0xc1aab9['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xfbe01f(0x21d)][_0xfbe01f(0x23a)](async _0x56dee9=>{const _0x9492fb=_0xfbe01f,_0x444197=await _0x56dee9[_0x9492fb(0x250)]['findUnique']({'where':{'id':_0xc1aab9[_0x9492fb(0x1fe)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x444197){console['log'](_0x9492fb(0x20d)+_0x444197['id']+':\x20type='+_0x444197['type']+',\x20currentPayments='+_0x444197[_0x9492fb(0x211)]+_0x9492fb(0x205)+_0x444197[_0x9492fb(0x1f9)]);const _0x3d1afe=_0x444197[_0x9492fb(0x211)]+0x1,_0x4f08a6=_0x444197[_0x9492fb(0x20f)]===_0x9492fb(0x238)?_0x9492fb(0x237):_0x444197[_0x9492fb(0x1f9)];await _0x56dee9[_0x9492fb(0x250)]['update']({'where':{'id':_0xc1aab9[_0x9492fb(0x1fe)]},'data':{'currentPayments':_0x3d1afe,'status':_0x4f08a6,'updatedAt':new Date()}}),console[_0x9492fb(0x251)]('✅\x20Payment\x20link\x20'+_0x444197['id']+'\x20updated:\x20currentPayments='+_0x444197[_0x9492fb(0x211)]+_0x9492fb(0x1f2)+_0x3d1afe+',\x20status='+_0x444197[_0x9492fb(0x1f9)]+_0x9492fb(0x1f2)+_0x4f08a6);}else console['log'](_0x9492fb(0x216)+_0xc1aab9[_0x9492fb(0x1fe)]+_0x9492fb(0x25b));});}catch(_0x3705f5){console[_0xfbe01f(0x22d)](_0xfbe01f(0x263),_0x3705f5);}}await database_1['default'][_0xfbe01f(0x1f6)]['create']({'data':{'paymentId':_0xc1aab9['id'],'shopId':_0xc1aab9['shopId'],'event':_0xfbe01f(0x23d)+_0x5adb36[_0xfbe01f(0x1f9)][_0xfbe01f(0x227)](),'statusCode':0xc8,'responseBody':JSON[_0xfbe01f(0x21a)]({'oldStatus':_0xfbe01f(0x241),'newStatus':_0x5adb36[_0xfbe01f(0x1f9)],'transactionId':_0x5adb36[_0xfbe01f(0x230)],'failureReason':_0x5adb36[_0xfbe01f(0x1fa)],'processedAt':new Date()[_0xfbe01f(0x22b)]()})}}),await this['sendShopWebhook'](_0xc1aab9,_0x5adb36['status'],_0x5adb36[_0xfbe01f(0x230)],_0x5adb36[_0xfbe01f(0x1fa)]),await this[_0xfbe01f(0x1f7)](_0xc1aab9,_0x5adb36[_0xfbe01f(0x1f9)]),console[_0xfbe01f(0x251)](_0xfbe01f(0x264)+_0x25db9e+_0xfbe01f(0x212)+_0x5adb36[_0xfbe01f(0x1f9)]),_0x5adb36[_0xfbe01f(0x1f9)]===_0xfbe01f(0x1f4)?_0x217694[_0xfbe01f(0x233)]({'success':!![],'message':_0xfbe01f(0x247),'result':{'status':_0xfbe01f(0x1f4),'transactionId':_0x5adb36[_0xfbe01f(0x230)],'redirectUrl':_0xc1aab9[_0xfbe01f(0x1f3)]}}):_0x217694[_0xfbe01f(0x1f9)](0x190)[_0xfbe01f(0x233)]({'success':![],'message':_0xfbe01f(0x220),'result':{'status':_0xfbe01f(0x210),'failureReason':_0x5adb36[_0xfbe01f(0x1fa)],'redirectUrl':_0xc1aab9[_0xfbe01f(0x25a)]}});}catch(_0x363120){_0x43bcd1(_0x363120);}},this['testGatewayService']=new testGatewayService_1[(_0x5b0411(0x25d))](),this[_0x5b0411(0x225)]=new webhookService_1[(_0x5b0411(0x22a))]();}async[a14_0x10d0ed(0x243)](_0xefd67b,_0x191cf0,_0x52d927,_0xaa73){const _0x5dc5bb=a14_0x10d0ed,_0x3b94a7=Date[_0x5dc5bb(0x222)]();try{const _0xbbf4cd=_0xefd67b[_0x5dc5bb(0x224)],_0x3de983=_0xbbf4cd[_0x5dc5bb(0x204)];if(!_0x3de983?.['webhookUrl']){console['log'](_0x5dc5bb(0x215)+_0xbbf4cd['id']);return;}const _0x57a06a=_0x191cf0===_0x5dc5bb(0x1f4)?_0x5dc5bb(0x20e):'payment.failed';let _0x16f692=[];if(_0x3de983[_0x5dc5bb(0x214)])try{_0x16f692=Array[_0x5dc5bb(0x23b)](_0x3de983[_0x5dc5bb(0x214)])?_0x3de983['webhookEvents']:JSON[_0x5dc5bb(0x25c)](_0x3de983[_0x5dc5bb(0x214)]);}catch(_0x4607fb){console[_0x5dc5bb(0x22d)](_0x5dc5bb(0x202),_0x4607fb),_0x16f692=[];}if(!_0x16f692[_0x5dc5bb(0x1f5)](_0x57a06a)){console[_0x5dc5bb(0x251)](_0x5dc5bb(0x246)+_0x57a06a+_0x5dc5bb(0x232)+_0xbbf4cd['id']);return;}const _0x295935={'event':_0x57a06a,'payment':{'id':_0xefd67b['id'],'order_id':_0xefd67b[_0x5dc5bb(0x219)],'gateway_order_id':_0xefd67b[_0x5dc5bb(0x260)],'gateway':_0x5dc5bb(0x1fc),'amount':_0xefd67b[_0x5dc5bb(0x249)],'currency':_0xefd67b['currency'],'status':_0x191cf0['toLowerCase'](),'customer_email':_0xefd67b[_0x5dc5bb(0x206)],'customer_name':_0xefd67b['customerName'],'transaction_id':_0x52d927,'failure_message':_0xaa73,'created_at':_0xefd67b['createdAt'],'updated_at':new Date()}},_0x31a3a1=await fetch(_0x3de983[_0x5dc5bb(0x25e)],{'method':'POST','headers':{'Content-Type':_0x5dc5bb(0x261),'User-Agent':_0x5dc5bb(0x226)},'body':JSON[_0x5dc5bb(0x21a)](_0x295935)}),_0x27cfac=Date[_0x5dc5bb(0x222)]()-_0x3b94a7;console['log'](_0x5dc5bb(0x21c)+_0x3de983['webhookUrl']+_0x5dc5bb(0x217)+_0x31a3a1['status']+'\x20('+_0x27cfac+_0x5dc5bb(0x23c));}catch(_0x4d90dc){console[_0x5dc5bb(0x22d)](_0x5dc5bb(0x24b),_0x4d90dc);}}async[a14_0x10d0ed(0x1f7)](_0x1ab905,_0x504e65){const _0x468192=a14_0x10d0ed;try{const {telegramBotService:_0x4661f7}=await Promise[_0x468192(0x213)]()[_0x468192(0x228)](()=>__importStar(require('../services/telegramBotService'))),_0x49a408={'PAID':_0x468192(0x22c),'FAILED':_0x468192(0x234)},_0x169acf=_0x49a408[_0x504e65];if(!_0x169acf)return;await _0x4661f7[_0x468192(0x1ef)](_0x1ab905['shopId'],_0x1ab905,_0x169acf);}catch(_0x34e9d8){console[_0x468192(0x22d)](_0x468192(0x1f1),_0x34e9d8);}}}exports[a14_0x10d0ed(0x1ec)]=TestGatewayController;