'use strict';function a18_0x267e(){const _0x23b726=['createdAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','hasOwnProperty','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paidAt','toISOString','üß™\x20Test\x20Gateway\x20result:','\x20->\x20','\x20processed:\x20','payment','shop','slice','Payment\x20failed','Payment\x20to\x20','currency','__importStar','paymentLink','8ihgmUH','webhookLog','create','cardLast4','Payment\x20processed\x20successfully','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','sendPaymentNotification','defineProperty','failureReason','error','\x20not\x20enabled\x20for\x20shop\x20','payment.success','update','sendPaymentStatusNotification','COMPLETED','status','‚úÖ\x20Payment\x20link\x20','webhookUrl','processCardPayment','../config/database','1236iMAHqt','Payment\x20not\x20found',':\x20type=','WebhookService','TestGatewayService','49814KyeNrh','gateway','üìà\x20Test\x20Gateway:\x20Payment\x20','5816710KYcKTW','customerEmail','settings','26jdInWy','../services/gateways/testGatewayService','FAILED','11645320zoAmRC','8312859uGCrVx','0000','sendShopWebhook','currentPayments','then','log','toLowerCase','Test\x20Gateway\x20webhook\x20sent\x20to\x20','length','TestGatewayController','Any\x203-4\x20digits','test_gateway_','\x20with\x20status\x20','gatewayOrderId','type','includes','transactionId','parse','now','SINGLE','getOwnPropertyDescriptor','4242\x204242\x204242\x204242','isArray','paymentMethod','test_gateway','Webhook\x20event\x20','webhookEvents','ms)','__esModule','body','shopId','__createBinding','getPaymentForm',',\x20status=','call','__setModuleDefault','PENDING','testGatewayService','get','Any\x20other\x20card\x20number','1750ISpOxF','407OaXwKc','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','params','failUrl','json','replace','default','PAID','‚úÖ\x20Test\x20Gateway\x20payment\x20','stringify','name','application/json','amount','‚ùå\x20Payment\x20link\x20','findUnique','gatewayPaymentId',',\x20cannot\x20process','23958OLnRaQ','customerName','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','3uXVjTp','Payment\x20is\x20not\x20for\x20test\x20gateway','paymentLinkId','writable','payment.failed','../services/telegramBotService','2527428fHDpPj','üìà\x20Found\x20payment\x20link\x20','__importDefault'];a18_0x267e=function(){return _0x23b726;};return a18_0x267e();}const a18_0x402797=a18_0x2bae;(function(_0x2a6af8,_0xe92f8d){const _0x5f2c52=a18_0x2bae,_0x344c94=_0x2a6af8();while(!![]){try{const _0x94802c=parseInt(_0x5f2c52(0x1ab))/0x1*(-parseInt(_0x5f2c52(0x1b1))/0x2)+parseInt(_0x5f2c52(0x178))/0x3*(-parseInt(_0x5f2c52(0x17e))/0x4)+-parseInt(_0x5f2c52(0x1ae))/0x5+parseInt(_0x5f2c52(0x174))/0x6*(parseInt(_0x5f2c52(0x1dd))/0x7)+-parseInt(_0x5f2c52(0x192))/0x8*(-parseInt(_0x5f2c52(0x1b5))/0x9)+parseInt(_0x5f2c52(0x1b4))/0xa+parseInt(_0x5f2c52(0x1de))/0xb*(-parseInt(_0x5f2c52(0x1a6))/0xc);if(_0x94802c===_0xe92f8d)break;else _0x344c94['push'](_0x344c94['shift']());}catch(_0x31e35f){_0x344c94['push'](_0x344c94['shift']());}}}(a18_0x267e,0x9c361));function a18_0x2bae(_0x3c534f,_0x18c250){_0x3c534f=_0x3c534f-0x16c;const _0x267e22=a18_0x267e();let _0x2bae86=_0x267e22[_0x3c534f];return _0x2bae86;}var __createBinding=this&&this[a18_0x402797(0x1d4)]||(Object[a18_0x402797(0x194)]?function(_0x49d8b1,_0x4b2574,_0x2ccc33,_0x2fd991){const _0x30d92b=a18_0x402797;if(_0x2fd991===undefined)_0x2fd991=_0x2ccc33;var _0x406b2a=Object[_0x30d92b(0x1c9)](_0x4b2574,_0x2ccc33);(!_0x406b2a||(_0x30d92b(0x1db)in _0x406b2a?!_0x4b2574[_0x30d92b(0x1d1)]:_0x406b2a[_0x30d92b(0x17b)]||_0x406b2a['configurable']))&&(_0x406b2a={'enumerable':!![],'get':function(){return _0x4b2574[_0x2ccc33];}}),Object[_0x30d92b(0x199)](_0x49d8b1,_0x2fd991,_0x406b2a);}:function(_0x18bce4,_0x4c5f02,_0x3ceb85,_0x3b69c5){if(_0x3b69c5===undefined)_0x3b69c5=_0x3ceb85;_0x18bce4[_0x3b69c5]=_0x4c5f02[_0x3ceb85];}),__setModuleDefault=this&&this[a18_0x402797(0x1d8)]||(Object[a18_0x402797(0x194)]?function(_0x26f857,_0x7130c0){const _0xfe9229=a18_0x402797;Object['defineProperty'](_0x26f857,_0xfe9229(0x1e4),{'enumerable':!![],'value':_0x7130c0});}:function(_0x5f765a,_0x256e31){const _0x1163db=a18_0x402797;_0x5f765a[_0x1163db(0x1e4)]=_0x256e31;}),__importStar=this&&this[a18_0x402797(0x190)]||(function(){var _0x11aad5=function(_0x27fd21){return _0x11aad5=Object['getOwnPropertyNames']||function(_0x5320a6){const _0x16d389=a18_0x2bae;var _0x13aa6e=[];for(var _0xae2aa6 in _0x5320a6)if(Object['prototype'][_0x16d389(0x183)][_0x16d389(0x1d7)](_0x5320a6,_0xae2aa6))_0x13aa6e[_0x13aa6e['length']]=_0xae2aa6;return _0x13aa6e;},_0x11aad5(_0x27fd21);};return function(_0x3472a7){const _0x22ccf6=a18_0x2bae;if(_0x3472a7&&_0x3472a7[_0x22ccf6(0x1d1)])return _0x3472a7;var _0x324980={};if(_0x3472a7!=null){for(var _0x303505=_0x11aad5(_0x3472a7),_0x3ceac3=0x0;_0x3ceac3<_0x303505[_0x22ccf6(0x1bd)];_0x3ceac3++)if(_0x303505[_0x3ceac3]!==_0x22ccf6(0x1e4))__createBinding(_0x324980,_0x3472a7,_0x303505[_0x3ceac3]);}return __setModuleDefault(_0x324980,_0x3472a7),_0x324980;};}()),__importDefault=this&&this[a18_0x402797(0x180)]||function(_0x2074f0){const _0x1e069f=a18_0x402797;return _0x2074f0&&_0x2074f0[_0x1e069f(0x1d1)]?_0x2074f0:{'default':_0x2074f0};};Object[a18_0x402797(0x199)](exports,'__esModule',{'value':!![]}),exports[a18_0x402797(0x1be)]=void 0x0;const testGatewayService_1=require(a18_0x402797(0x1b2)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a18_0x402797(0x1a5)));class TestGatewayController{constructor(){const _0x5eea1d=a18_0x402797;this[_0x5eea1d(0x1d5)]=async(_0x3db144,_0x4096a9,_0x3e2cc7)=>{const _0x3a3a90=_0x5eea1d;try{const {paymentId:_0x29be52}=_0x3db144[_0x3a3a90(0x1e0)];console['log'](_0x3a3a90(0x176)+_0x29be52);const _0x531b1b=await database_1[_0x3a3a90(0x1e4)][_0x3a3a90(0x18a)][_0x3a3a90(0x171)]({'where':{'id':_0x29be52},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x531b1b)return _0x4096a9[_0x3a3a90(0x1a1)](0x194)[_0x3a3a90(0x1e2)]({'success':![],'message':_0x3a3a90(0x1a7)});if(_0x531b1b[_0x3a3a90(0x1ac)]!==_0x3a3a90(0x1cd))return _0x4096a9[_0x3a3a90(0x1a1)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x531b1b[_0x3a3a90(0x1a1)]!==_0x3a3a90(0x1d9))return _0x4096a9['status'](0x190)[_0x3a3a90(0x1e2)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x531b1b[_0x3a3a90(0x1a1)]+',\x20cannot\x20process'});_0x4096a9[_0x3a3a90(0x1e2)]({'success':!![],'result':{'paymentId':_0x531b1b['id'],'orderId':_0x531b1b[_0x3a3a90(0x1c2)],'amount':_0x531b1b['amount'],'currency':_0x531b1b[_0x3a3a90(0x18f)],'merchantName':_0x531b1b[_0x3a3a90(0x18b)]['name'],'description':_0x3a3a90(0x18e)+_0x531b1b[_0x3a3a90(0x18b)][_0x3a3a90(0x16d)],'testInstructions':{'successCard':_0x3a3a90(0x1ca),'failureCard':_0x3a3a90(0x1dc),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x3a3a90(0x1bf),'holderName':'Any\x20name'}}});}catch(_0x354d50){_0x3e2cc7(_0x354d50);}},this['processCard']=async(_0x521648,_0x2abb40,_0x4980f9)=>{const _0x2efaf1=_0x5eea1d;try{const {paymentId:_0x34a8ed}=_0x521648[_0x2efaf1(0x1e0)],_0x1d94f1=_0x521648[_0x2efaf1(0x1d2)];console[_0x2efaf1(0x1ba)](_0x2efaf1(0x184)+_0x34a8ed);const _0x468cd4=await database_1[_0x2efaf1(0x1e4)][_0x2efaf1(0x18a)][_0x2efaf1(0x171)]({'where':{'id':_0x34a8ed},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x468cd4)return _0x2abb40[_0x2efaf1(0x1a1)](0x194)[_0x2efaf1(0x1e2)]({'success':![],'message':_0x2efaf1(0x1a7)});if(_0x468cd4['gateway']!=='test_gateway')return _0x2abb40['status'](0x190)['json']({'success':![],'message':_0x2efaf1(0x179)});if(_0x468cd4[_0x2efaf1(0x1a1)]!==_0x2efaf1(0x1d9))return _0x2abb40[_0x2efaf1(0x1a1)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x468cd4[_0x2efaf1(0x1a1)]+_0x2efaf1(0x173)});const _0x9ae740=await this[_0x2efaf1(0x1da)][_0x2efaf1(0x1a4)]({'paymentId':_0x468cd4['id'],'orderId':_0x468cd4[_0x2efaf1(0x1c2)]||_0x468cd4['id'],'amount':_0x468cd4[_0x2efaf1(0x16f)],'currency':_0x468cd4[_0x2efaf1(0x18f)],'cardData':_0x1d94f1});console[_0x2efaf1(0x1ba)](_0x2efaf1(0x187),_0x9ae740);const _0x2ee10b={'status':_0x9ae740[_0x2efaf1(0x1a1)],'updatedAt':new Date()};if(_0x9ae740[_0x2efaf1(0x1a1)]==='PAID')_0x2ee10b[_0x2efaf1(0x185)]=new Date(),_0x2ee10b[_0x2efaf1(0x172)]=_0x9ae740[_0x2efaf1(0x1c5)];else _0x9ae740[_0x2efaf1(0x1a1)]===_0x2efaf1(0x1b3)&&(_0x2ee10b['failureMessage']=_0x9ae740[_0x2efaf1(0x19a)]);const _0x1cdba0=_0x1d94f1['cardNumber'][_0x2efaf1(0x1e3)](/[\s-]/g,'');_0x2ee10b[_0x2efaf1(0x195)]=_0x1cdba0[_0x2efaf1(0x18c)](-0x4),_0x2ee10b[_0x2efaf1(0x1cc)]='test_card',await database_1[_0x2efaf1(0x1e4)][_0x2efaf1(0x18a)]['update']({'where':{'id':_0x468cd4['id']},'data':_0x2ee10b});if(_0x9ae740['status']===_0x2efaf1(0x1e5)&&_0x468cd4[_0x2efaf1(0x17a)]){console[_0x2efaf1(0x1ba)](_0x2efaf1(0x1ad)+_0x468cd4['id']+_0x2efaf1(0x177));try{await database_1[_0x2efaf1(0x1e4)]['$transaction'](async _0x47d744=>{const _0x3aa4ec=_0x2efaf1,_0x24caad=await _0x47d744[_0x3aa4ec(0x191)][_0x3aa4ec(0x171)]({'where':{'id':_0x468cd4['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x24caad){console[_0x3aa4ec(0x1ba)](_0x3aa4ec(0x17f)+_0x24caad['id']+_0x3aa4ec(0x1a8)+_0x24caad['type']+',\x20currentPayments='+_0x24caad[_0x3aa4ec(0x1b8)]+_0x3aa4ec(0x1d6)+_0x24caad[_0x3aa4ec(0x1a1)]);const _0x487edf=_0x24caad[_0x3aa4ec(0x1b8)]+0x1,_0x3536a3=_0x24caad[_0x3aa4ec(0x1c3)]===_0x3aa4ec(0x1c8)?_0x3aa4ec(0x1a0):_0x24caad[_0x3aa4ec(0x1a1)];await _0x47d744[_0x3aa4ec(0x191)][_0x3aa4ec(0x19e)]({'where':{'id':_0x468cd4[_0x3aa4ec(0x17a)]},'data':{'currentPayments':_0x487edf,'status':_0x3536a3,'updatedAt':new Date()}}),console[_0x3aa4ec(0x1ba)](_0x3aa4ec(0x1a2)+_0x24caad['id']+'\x20updated:\x20currentPayments='+_0x24caad['currentPayments']+'\x20->\x20'+_0x487edf+_0x3aa4ec(0x1d6)+_0x24caad[_0x3aa4ec(0x1a1)]+_0x3aa4ec(0x188)+_0x3536a3);}else console[_0x3aa4ec(0x1ba)](_0x3aa4ec(0x170)+_0x468cd4['paymentLinkId']+'\x20not\x20found');});}catch(_0x465bc4){console[_0x2efaf1(0x19b)](_0x2efaf1(0x1df),_0x465bc4);}}await database_1['default'][_0x2efaf1(0x193)]['create']({'data':{'paymentId':_0x468cd4['id'],'shopId':_0x468cd4[_0x2efaf1(0x1d3)],'event':_0x2efaf1(0x1c0)+_0x9ae740[_0x2efaf1(0x1a1)][_0x2efaf1(0x1bb)](),'statusCode':0xc8,'responseBody':JSON[_0x2efaf1(0x16c)]({'oldStatus':_0x2efaf1(0x1d9),'newStatus':_0x9ae740['status'],'transactionId':_0x9ae740[_0x2efaf1(0x1c5)],'failureReason':_0x9ae740['failureReason'],'processedAt':new Date()[_0x2efaf1(0x186)]()})}}),await this[_0x2efaf1(0x1b7)](_0x468cd4,_0x9ae740[_0x2efaf1(0x1a1)],_0x9ae740[_0x2efaf1(0x1c5)],_0x9ae740['failureReason']),await this['sendPaymentStatusNotification'](_0x468cd4,_0x9ae740[_0x2efaf1(0x1a1)]),console[_0x2efaf1(0x1ba)](_0x2efaf1(0x1e6)+_0x34a8ed+_0x2efaf1(0x189)+_0x9ae740['status']),_0x9ae740['status']===_0x2efaf1(0x1e5)?_0x2abb40[_0x2efaf1(0x1e2)]({'success':!![],'message':_0x2efaf1(0x196),'result':{'status':'PAID','transactionId':_0x9ae740[_0x2efaf1(0x1c5)],'redirectUrl':_0x468cd4['successUrl']}}):_0x2abb40[_0x2efaf1(0x1a1)](0x190)[_0x2efaf1(0x1e2)]({'success':![],'message':_0x2efaf1(0x18d),'result':{'status':_0x2efaf1(0x1b3),'failureReason':_0x9ae740[_0x2efaf1(0x19a)],'redirectUrl':_0x468cd4[_0x2efaf1(0x1e1)]}});}catch(_0xbf5b5c){_0x4980f9(_0xbf5b5c);}},this[_0x5eea1d(0x1da)]=new testGatewayService_1[(_0x5eea1d(0x1aa))](),this['webhookService']=new webhookService_1[(_0x5eea1d(0x1a9))]();}async[a18_0x402797(0x1b7)](_0x478819,_0x297773,_0x29d2b1,_0xf37202){const _0x61aa53=a18_0x402797,_0x118bec=Date[_0x61aa53(0x1c7)]();try{const _0x3f0e4e=_0x478819[_0x61aa53(0x18b)],_0x4b3377=_0x3f0e4e[_0x61aa53(0x1b0)];if(!_0x4b3377?.[_0x61aa53(0x1a3)]){console[_0x61aa53(0x1ba)](_0x61aa53(0x182)+_0x3f0e4e['id']);return;}const _0x5e43ad=_0x297773===_0x61aa53(0x1e5)?_0x61aa53(0x19d):_0x61aa53(0x17c);let _0x1e179e=[];if(_0x4b3377[_0x61aa53(0x1cf)])try{_0x1e179e=Array[_0x61aa53(0x1cb)](_0x4b3377['webhookEvents'])?_0x4b3377[_0x61aa53(0x1cf)]:JSON[_0x61aa53(0x1c6)](_0x4b3377[_0x61aa53(0x1cf)]);}catch(_0x502591){console['error']('Error\x20parsing\x20webhook\x20events:',_0x502591),_0x1e179e=[];}if(!_0x1e179e[_0x61aa53(0x1c4)](_0x5e43ad)){console['log'](_0x61aa53(0x1ce)+_0x5e43ad+_0x61aa53(0x19c)+_0x3f0e4e['id']);return;}const _0x54496f={'event':_0x5e43ad,'payment':{'id':_0x478819['id'],'order_id':_0x478819['orderId'],'gateway_order_id':_0x478819[_0x61aa53(0x1c2)],'gateway':_0x61aa53(0x1b6),'amount':_0x478819[_0x61aa53(0x16f)],'currency':_0x478819[_0x61aa53(0x18f)],'status':_0x297773[_0x61aa53(0x1bb)](),'customer_email':_0x478819[_0x61aa53(0x1af)],'customer_name':_0x478819[_0x61aa53(0x175)],'transaction_id':_0x29d2b1,'failure_message':_0xf37202,'created_at':_0x478819[_0x61aa53(0x181)],'updated_at':new Date()}},_0x774087=await fetch(_0x4b3377[_0x61aa53(0x1a3)],{'method':'POST','headers':{'Content-Type':_0x61aa53(0x16e),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x61aa53(0x16c)](_0x54496f)}),_0x1ca887=Date['now']()-_0x118bec;console['log'](_0x61aa53(0x1bc)+_0x4b3377['webhookUrl']+_0x61aa53(0x1c1)+_0x774087[_0x61aa53(0x1a1)]+'\x20('+_0x1ca887+_0x61aa53(0x1d0));}catch(_0x3268c9){console['error'](_0x61aa53(0x197),_0x3268c9);}}async[a18_0x402797(0x19f)](_0x513a6d,_0x1ba1c6){const _0x4555e8=a18_0x402797;try{const {telegramBotService:_0x38ab8c}=await Promise['resolve']()[_0x4555e8(0x1b9)](()=>__importStar(require(_0x4555e8(0x17d)))),_0x2244f3={'PAID':'paid','FAILED':'failed'},_0x3db503=_0x2244f3[_0x1ba1c6];if(!_0x3db503)return;await _0x38ab8c[_0x4555e8(0x198)](_0x513a6d[_0x4555e8(0x1d3)],_0x513a6d,_0x3db503);}catch(_0x556c45){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x556c45);}}}exports[a18_0x402797(0x1be)]=TestGatewayController;