'use strict';const a15_0x5be618=a15_0x1b03;(function(_0x3b41e2,_0x11ca6c){const _0x358069=a15_0x1b03,_0x28202c=_0x3b41e2();while(!![]){try{const _0x331a3a=parseInt(_0x358069(0x9c))/0x1+parseInt(_0x358069(0x9b))/0x2+-parseInt(_0x358069(0xc4))/0x3*(parseInt(_0x358069(0x101))/0x4)+-parseInt(_0x358069(0xed))/0x5+parseInt(_0x358069(0xfa))/0x6*(parseInt(_0x358069(0x113))/0x7)+-parseInt(_0x358069(0xb9))/0x8*(-parseInt(_0x358069(0xf2))/0x9)+parseInt(_0x358069(0xd6))/0xa;if(_0x331a3a===_0x11ca6c)break;else _0x28202c['push'](_0x28202c['shift']());}catch(_0xd849aa){_0x28202c['push'](_0x28202c['shift']());}}}(a15_0x4268,0x5029e));function a15_0x1b03(_0x8b266f,_0x1a8c9d){const _0x4268eb=a15_0x4268();return a15_0x1b03=function(_0x1b03fd,_0x328187){_0x1b03fd=_0x1b03fd-0x97;let _0x2689de=_0x4268eb[_0x1b03fd];return _0x2689de;},a15_0x1b03(_0x8b266f,_0x1a8c9d);}var __createBinding=this&&this[a15_0x5be618(0xa9)]||(Object[a15_0x5be618(0xca)]?function(_0x41f17a,_0x5838d0,_0x595657,_0x3d4284){const _0x34441e=a15_0x5be618;if(_0x3d4284===undefined)_0x3d4284=_0x595657;var _0x53298f=Object[_0x34441e(0xf3)](_0x5838d0,_0x595657);(!_0x53298f||('get'in _0x53298f?!_0x5838d0[_0x34441e(0x114)]:_0x53298f[_0x34441e(0xa3)]||_0x53298f[_0x34441e(0xb5)]))&&(_0x53298f={'enumerable':!![],'get':function(){return _0x5838d0[_0x595657];}}),Object[_0x34441e(0xe3)](_0x41f17a,_0x3d4284,_0x53298f);}:function(_0xfae349,_0x284aa6,_0x28da94,_0x51ed08){if(_0x51ed08===undefined)_0x51ed08=_0x28da94;_0xfae349[_0x51ed08]=_0x284aa6[_0x28da94];}),__setModuleDefault=this&&this[a15_0x5be618(0xd7)]||(Object[a15_0x5be618(0xca)]?function(_0x11db4f,_0x8394e3){const _0x2ad5f2=a15_0x5be618;Object[_0x2ad5f2(0xe3)](_0x11db4f,_0x2ad5f2(0xfb),{'enumerable':!![],'value':_0x8394e3});}:function(_0x8df2ed,_0x511678){const _0x1e11cd=a15_0x5be618;_0x8df2ed[_0x1e11cd(0xfb)]=_0x511678;}),__importStar=this&&this[a15_0x5be618(0xac)]||(function(){var _0x320ada=function(_0x2419d5){return _0x320ada=Object['getOwnPropertyNames']||function(_0x255bfd){const _0x259705=a15_0x1b03;var _0x31225c=[];for(var _0x438fb6 in _0x255bfd)if(Object[_0x259705(0xae)]['hasOwnProperty']['call'](_0x255bfd,_0x438fb6))_0x31225c[_0x31225c[_0x259705(0xc2)]]=_0x438fb6;return _0x31225c;},_0x320ada(_0x2419d5);};return function(_0x2b9312){const _0x306781=a15_0x1b03;if(_0x2b9312&&_0x2b9312[_0x306781(0x114)])return _0x2b9312;var _0x538eda={};if(_0x2b9312!=null){for(var _0x123ee3=_0x320ada(_0x2b9312),_0x581199=0x0;_0x581199<_0x123ee3[_0x306781(0xc2)];_0x581199++)if(_0x123ee3[_0x581199]!==_0x306781(0xfb))__createBinding(_0x538eda,_0x2b9312,_0x123ee3[_0x581199]);}return __setModuleDefault(_0x538eda,_0x2b9312),_0x538eda;};}()),__importDefault=this&&this[a15_0x5be618(0x104)]||function(_0x3b3592){const _0x5f1469=a15_0x5be618;return _0x3b3592&&_0x3b3592[_0x5f1469(0x114)]?_0x3b3592:{'default':_0x3b3592};};Object['defineProperty'](exports,a15_0x5be618(0x114),{'value':!![]}),exports[a15_0x5be618(0xbd)]=void 0x0;const testGatewayService_1=require(a15_0x5be618(0xce)),webhookService_1=require(a15_0x5be618(0xe1)),database_1=__importDefault(require(a15_0x5be618(0xec)));function a15_0x4268(){const _0xcf0c74=['WebhookService','amount','json','testGatewayService','Payment\x20not\x20found','webhookService','✅\x20Test\x20Gateway\x20payment\x20','findUnique','name','2569zZYnHl','__esModule','parse','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Error\x20parsing\x20webhook\x20events:','params','418212eLKYJb','230003efPhYP','TestGatewayService','test_card','Payment\x20status\x20is\x20','orderId','customerEmail','POST','writable','webhookEvents','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','status','Payment\x20failed','sendPaymentStatusNotification','__createBinding','../services/telegramBotService','gatewayOrderId','__importStar','toLowerCase','prototype','paymentMethod','\x20with\x20status\x20','paymentLink','replace','\x20updated:\x20currentPayments=','failed','configurable','slice','toISOString','resolve','4616npYmYg','\x20not\x20found','application/json','paymentLinkId','TestGatewayController','paid','now','Payment\x20is\x20not\x20for\x20test\x20gateway','stringify','length','update','1353342imDPWx','Any\x20other\x20card\x20number','sendPaymentNotification','currentPayments','createdAt',':\x20type=','create','failureMessage','successUrl','log','../services/gateways/testGatewayService','payment','webhookLog',',\x20cannot\x20process','cardNumber','📈\x20Test\x20Gateway:\x20Payment\x20','Any\x20name',',\x20status=','455750kAPnXv','__setModuleDefault','isArray',',\x20currentPayments=','Webhook\x20event\x20','payment.failed','SINGLE','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','shop','\x20not\x20enabled\x20for\x20shop\x20','error','../services/webhookService','type','defineProperty','transactionId','COMPLETED','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failureReason','processCard','PAID','ms)','failUrl','../config/database','1151230XUrDxK','Payment\x20processed\x20successfully','currency','test_gateway','\x20processed:\x20','198TRzgEW','getOwnPropertyDescriptor','processCardPayment','payment.success','sendShopWebhook','✅\x20Payment\x20link\x20','gateway','body','8376exkPaD','default','gatewayPaymentId','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PENDING','4242\x204242\x204242\x204242','4sUqTRF','$transaction','FAILED','__importDefault','includes','0000','🧪\x20Test\x20Gateway\x20result:','shopId','\x20->\x20'];a15_0x4268=function(){return _0xcf0c74;};return a15_0x4268();}class TestGatewayController{constructor(){const _0x1ba1a7=a15_0x5be618;this['getPaymentForm']=async(_0x39149c,_0x1e492c,_0x32c006)=>{const _0x4a07b4=a15_0x1b03;try{const {paymentId:_0xde09f3}=_0x39149c[_0x4a07b4(0x9a)];console[_0x4a07b4(0xcd)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0xde09f3);const _0x5dc6c1=await database_1[_0x4a07b4(0xfb)][_0x4a07b4(0xcf)][_0x4a07b4(0x111)]({'where':{'id':_0xde09f3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5dc6c1)return _0x1e492c[_0x4a07b4(0xa6)](0x194)[_0x4a07b4(0x10c)]({'success':![],'message':_0x4a07b4(0x10e)});if(_0x5dc6c1[_0x4a07b4(0xf8)]!=='test_gateway')return _0x1e492c['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5dc6c1[_0x4a07b4(0xa6)]!=='PENDING')return _0x1e492c['status'](0x190)['json']({'success':![],'message':_0x4a07b4(0x9f)+_0x5dc6c1[_0x4a07b4(0xa6)]+_0x4a07b4(0xd1)});_0x1e492c[_0x4a07b4(0x10c)]({'success':!![],'result':{'paymentId':_0x5dc6c1['id'],'orderId':_0x5dc6c1[_0x4a07b4(0xab)],'amount':_0x5dc6c1['amount'],'currency':_0x5dc6c1[_0x4a07b4(0xef)],'merchantName':_0x5dc6c1[_0x4a07b4(0xde)][_0x4a07b4(0x112)],'description':'Payment\x20to\x20'+_0x5dc6c1['shop']['name'],'testInstructions':{'successCard':_0x4a07b4(0x100),'failureCard':_0x4a07b4(0xc5),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x4a07b4(0xd4)}}});}catch(_0x26a15c){_0x32c006(_0x26a15c);}},this[_0x1ba1a7(0xe8)]=async(_0x54fffd,_0x3346b2,_0x3f99e0)=>{const _0x4c90de=_0x1ba1a7;try{const {paymentId:_0xca398f}=_0x54fffd['params'],_0x3621e5=_0x54fffd[_0x4c90de(0xf9)];console[_0x4c90de(0xcd)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0xca398f);const _0xd88098=await database_1['default'][_0x4c90de(0xcf)][_0x4c90de(0x111)]({'where':{'id':_0xca398f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xd88098)return _0x3346b2[_0x4c90de(0xa6)](0x194)[_0x4c90de(0x10c)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xd88098[_0x4c90de(0xf8)]!==_0x4c90de(0xf0))return _0x3346b2[_0x4c90de(0xa6)](0x190)[_0x4c90de(0x10c)]({'success':![],'message':_0x4c90de(0xc0)});if(_0xd88098[_0x4c90de(0xa6)]!==_0x4c90de(0xff))return _0x3346b2[_0x4c90de(0xa6)](0x190)[_0x4c90de(0x10c)]({'success':![],'message':_0x4c90de(0x9f)+_0xd88098[_0x4c90de(0xa6)]+_0x4c90de(0xd1)});const _0x294cfa=await this[_0x4c90de(0x10d)][_0x4c90de(0xf4)]({'paymentId':_0xd88098['id'],'orderId':_0xd88098[_0x4c90de(0xab)]||_0xd88098['id'],'amount':_0xd88098[_0x4c90de(0x10b)],'currency':_0xd88098[_0x4c90de(0xef)],'cardData':_0x3621e5});console[_0x4c90de(0xcd)](_0x4c90de(0x107),_0x294cfa);const _0x38818c={'status':_0x294cfa[_0x4c90de(0xa6)],'updatedAt':new Date()};if(_0x294cfa['status']===_0x4c90de(0xe9))_0x38818c['paidAt']=new Date(),_0x38818c[_0x4c90de(0xfc)]=_0x294cfa[_0x4c90de(0xe4)];else _0x294cfa['status']===_0x4c90de(0x103)&&(_0x38818c[_0x4c90de(0xcb)]=_0x294cfa[_0x4c90de(0xe7)]);const _0xfdd8f7=_0x3621e5[_0x4c90de(0xd2)][_0x4c90de(0xb2)](/[\s-]/g,'');_0x38818c['cardLast4']=_0xfdd8f7[_0x4c90de(0xb6)](-0x4),_0x38818c[_0x4c90de(0xaf)]=_0x4c90de(0x9e),await database_1['default'][_0x4c90de(0xcf)][_0x4c90de(0xc3)]({'where':{'id':_0xd88098['id']},'data':_0x38818c});if(_0x294cfa[_0x4c90de(0xa6)]===_0x4c90de(0xe9)&&_0xd88098['paymentLinkId']){console[_0x4c90de(0xcd)](_0x4c90de(0xd3)+_0xd88098['id']+_0x4c90de(0xa5));try{await database_1[_0x4c90de(0xfb)][_0x4c90de(0x102)](async _0x1cee29=>{const _0x1577d0=_0x4c90de,_0x24f915=await _0x1cee29[_0x1577d0(0xb1)]['findUnique']({'where':{'id':_0xd88098[_0x1577d0(0xbc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x24f915){console[_0x1577d0(0xcd)]('📈\x20Found\x20payment\x20link\x20'+_0x24f915['id']+_0x1577d0(0xc9)+_0x24f915[_0x1577d0(0xe2)]+_0x1577d0(0xd9)+_0x24f915[_0x1577d0(0xc7)]+_0x1577d0(0xd5)+_0x24f915['status']);const _0xeec1e2=_0x24f915[_0x1577d0(0xc7)]+0x1,_0x424256=_0x24f915[_0x1577d0(0xe2)]===_0x1577d0(0xdc)?_0x1577d0(0xe5):_0x24f915[_0x1577d0(0xa6)];await _0x1cee29[_0x1577d0(0xb1)][_0x1577d0(0xc3)]({'where':{'id':_0xd88098['paymentLinkId']},'data':{'currentPayments':_0xeec1e2,'status':_0x424256,'updatedAt':new Date()}}),console[_0x1577d0(0xcd)](_0x1577d0(0xf7)+_0x24f915['id']+_0x1577d0(0xb3)+_0x24f915[_0x1577d0(0xc7)]+'\x20->\x20'+_0xeec1e2+_0x1577d0(0xd5)+_0x24f915[_0x1577d0(0xa6)]+_0x1577d0(0x109)+_0x424256);}else console[_0x1577d0(0xcd)]('❌\x20Payment\x20link\x20'+_0xd88098[_0x1577d0(0xbc)]+_0x1577d0(0xba));});}catch(_0x22a9e4){console[_0x4c90de(0xe0)](_0x4c90de(0x97),_0x22a9e4);}}await database_1['default'][_0x4c90de(0xd0)]['create']({'data':{'paymentId':_0xd88098['id'],'shopId':_0xd88098[_0x4c90de(0x108)],'event':'test_gateway_'+_0x294cfa['status'][_0x4c90de(0xad)](),'statusCode':0xc8,'responseBody':JSON[_0x4c90de(0xc1)]({'oldStatus':_0x4c90de(0xff),'newStatus':_0x294cfa[_0x4c90de(0xa6)],'transactionId':_0x294cfa[_0x4c90de(0xe4)],'failureReason':_0x294cfa[_0x4c90de(0xe7)],'processedAt':new Date()[_0x4c90de(0xb7)]()})}}),await this[_0x4c90de(0xf6)](_0xd88098,_0x294cfa[_0x4c90de(0xa6)],_0x294cfa[_0x4c90de(0xe4)],_0x294cfa[_0x4c90de(0xe7)]),await this['sendPaymentStatusNotification'](_0xd88098,_0x294cfa['status']),console[_0x4c90de(0xcd)](_0x4c90de(0x110)+_0xca398f+_0x4c90de(0xf1)+_0x294cfa[_0x4c90de(0xa6)]),_0x294cfa['status']===_0x4c90de(0xe9)?_0x3346b2['json']({'success':!![],'message':_0x4c90de(0xee),'result':{'status':'PAID','transactionId':_0x294cfa[_0x4c90de(0xe4)],'redirectUrl':_0xd88098[_0x4c90de(0xcc)]}}):_0x3346b2[_0x4c90de(0xa6)](0x190)[_0x4c90de(0x10c)]({'success':![],'message':_0x4c90de(0xa7),'result':{'status':_0x4c90de(0x103),'failureReason':_0x294cfa[_0x4c90de(0xe7)],'redirectUrl':_0xd88098[_0x4c90de(0xeb)]}});}catch(_0x50452a){_0x3f99e0(_0x50452a);}},this['testGatewayService']=new testGatewayService_1[(_0x1ba1a7(0x9d))](),this[_0x1ba1a7(0x10f)]=new webhookService_1[(_0x1ba1a7(0x10a))]();}async[a15_0x5be618(0xf6)](_0x17907d,_0x445388,_0x5cc5f2,_0x1919f7){const _0x5497dd=a15_0x5be618,_0x4dbe14=Date[_0x5497dd(0xbf)]();try{const _0xaf6e68=_0x17907d[_0x5497dd(0xde)],_0x3259fb=_0xaf6e68['settings'];if(!_0x3259fb?.[_0x5497dd(0xfd)]){console[_0x5497dd(0xcd)](_0x5497dd(0xdd)+_0xaf6e68['id']);return;}const _0x44c0c4=_0x445388===_0x5497dd(0xe9)?_0x5497dd(0xf5):_0x5497dd(0xdb);let _0xbee4b=[];if(_0x3259fb['webhookEvents'])try{_0xbee4b=Array[_0x5497dd(0xd8)](_0x3259fb[_0x5497dd(0xa4)])?_0x3259fb[_0x5497dd(0xa4)]:JSON[_0x5497dd(0x115)](_0x3259fb['webhookEvents']);}catch(_0x4b4271){console[_0x5497dd(0xe0)](_0x5497dd(0x99),_0x4b4271),_0xbee4b=[];}if(!_0xbee4b[_0x5497dd(0x105)](_0x44c0c4)){console[_0x5497dd(0xcd)](_0x5497dd(0xda)+_0x44c0c4+_0x5497dd(0xdf)+_0xaf6e68['id']);return;}const _0xee5152={'event':_0x44c0c4,'payment':{'id':_0x17907d['id'],'order_id':_0x17907d[_0x5497dd(0xa0)],'gateway_order_id':_0x17907d['gatewayOrderId'],'gateway':_0x5497dd(0x106),'amount':_0x17907d['amount'],'currency':_0x17907d[_0x5497dd(0xef)],'status':_0x445388[_0x5497dd(0xad)](),'customer_email':_0x17907d[_0x5497dd(0xa1)],'customer_name':_0x17907d['customerName'],'transaction_id':_0x5cc5f2,'failure_message':_0x1919f7,'created_at':_0x17907d[_0x5497dd(0xc8)],'updated_at':new Date()}},_0x5ac9c1=await fetch(_0x3259fb[_0x5497dd(0xfd)],{'method':_0x5497dd(0xa2),'headers':{'Content-Type':_0x5497dd(0xbb),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x5497dd(0xc1)](_0xee5152)}),_0x3404f8=Date[_0x5497dd(0xbf)]()-_0x4dbe14;console[_0x5497dd(0xcd)](_0x5497dd(0xe6)+_0x3259fb[_0x5497dd(0xfd)]+_0x5497dd(0xb0)+_0x5ac9c1['status']+'\x20('+_0x3404f8+_0x5497dd(0xea));}catch(_0x15a52d){console[_0x5497dd(0xe0)](_0x5497dd(0x98),_0x15a52d);}}async[a15_0x5be618(0xa8)](_0x5329e6,_0x552a0d){const _0x5d5643=a15_0x5be618;try{const {telegramBotService:_0x11828b}=await Promise[_0x5d5643(0xb8)]()['then'](()=>__importStar(require(_0x5d5643(0xaa)))),_0x3dd0aa={'PAID':_0x5d5643(0xbe),'FAILED':_0x5d5643(0xb4)},_0x1e7809=_0x3dd0aa[_0x552a0d];if(!_0x1e7809)return;await _0x11828b[_0x5d5643(0xc6)](_0x5329e6[_0x5d5643(0x108)],_0x5329e6,_0x1e7809);}catch(_0x37ecd8){console[_0x5d5643(0xe0)](_0x5d5643(0xfe),_0x37ecd8);}}}exports['TestGatewayController']=TestGatewayController;