'use strict';function a13_0x55cb(){const _0x11add6=[',\x20currentPayments=','shopId','__importDefault',',\x20cannot\x20process','‚úÖ\x20Payment\x20link\x20','PAID','cardNumber','\x20not\x20found','üß™\x20Test\x20Gateway\x20result:','Any\x203-4\x20digits','190848KfQrGK','currentPayments','../config/database','processCardPayment','status','webhookLog','882324HEocpH','hasOwnProperty','__setModuleDefault','failureReason','payment.success','getOwnPropertyNames','findUnique','paymentLink','customerEmail','116bcOmuc','Payment\x20not\x20found','failureMessage','gatewayOrderId','slice','ms)','1Bvlisy','__importStar','json','isArray','toLowerCase','TestGatewayService','../services/gateways/testGatewayService','processCard','4242\x204242\x204242\x204242','paymentMethod','webhookUrl','paid','FAILED','__createBinding','settings','createdAt','transactionId','üìà\x20Test\x20Gateway:\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paidAt','0000','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','sendPaymentNotification','default','log','test_gateway_','getOwnPropertyDescriptor','testGatewayService','gatewayPaymentId','writable','orderId','shop','Any\x20name','Payment\x20processed\x20successfully','getPaymentForm','1326285kLnXuS','paymentLinkId','../services/webhookService','successUrl','length','‚ùå\x20Payment\x20link\x20','WebhookService',',\x20status=','732vjTLXF','$transaction','prototype','\x20updated:\x20currentPayments=','webhookService','test_gateway','TestGatewayController','toISOString','\x20not\x20enabled\x20for\x20shop\x20','cardLast4','payment.failed','test_card','stringify','webhookEvents','Any\x20other\x20card\x20number','\x20->\x20','__esModule','amount','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','payment','Payment\x20is\x20not\x20for\x20test\x20gateway','get','params','Payment\x20status\x20is\x20','üìà\x20Found\x20payment\x20link\x20','Webhook\x20event\x20','SINGLE','Payment\x20failed','name','error','configurable','parse','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','application/json','Test\x20Gateway\x20webhook\x20sent\x20to\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','887005mReQxy','now','call','update','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','‚úÖ\x20Test\x20Gateway\x20payment\x20','1122163fqtecI','create','../services/telegramBotService','type','body','213862zbihXD','POST','PENDING','gateway','sendShopWebhook','Payment\x20to\x20'];a13_0x55cb=function(){return _0x11add6;};return a13_0x55cb();}const a13_0x1cf838=a13_0x37b2;(function(_0x59f869,_0x354798){const _0x4e7610=a13_0x37b2,_0x1a74f6=_0x59f869();while(!![]){try{const _0x35872b=parseInt(_0x4e7610(0xff))/0x1*(parseInt(_0x4e7610(0xda))/0x2)+parseInt(_0x4e7610(0xaa))/0x3*(parseInt(_0x4e7610(0xf9))/0x4)+parseInt(_0x4e7610(0xcf))/0x5+parseInt(_0x4e7610(0xf0))/0x6+-parseInt(_0x4e7610(0xd5))/0x7+-parseInt(_0x4e7610(0xea))/0x8+-parseInt(_0x4e7610(0xa2))/0x9;if(_0x35872b===_0x354798)break;else _0x1a74f6['push'](_0x1a74f6['shift']());}catch(_0x3c8e90){_0x1a74f6['push'](_0x1a74f6['shift']());}}}(a13_0x55cb,0x1a1b4));function a13_0x37b2(_0x506d4b,_0x381fc5){const _0x55cbe5=a13_0x55cb();return a13_0x37b2=function(_0x37b208,_0x27b7d8){_0x37b208=_0x37b208-0x83;let _0x2d6e86=_0x55cbe5[_0x37b208];return _0x2d6e86;},a13_0x37b2(_0x506d4b,_0x381fc5);}var __createBinding=this&&this[a13_0x1cf838(0x8c)]||(Object[a13_0x1cf838(0xd6)]?function(_0x15a64b,_0x1f7a20,_0x3b4fad,_0x566df2){const _0xe86e72=a13_0x1cf838;if(_0x566df2===undefined)_0x566df2=_0x3b4fad;var _0x2c65ff=Object[_0xe86e72(0x99)](_0x1f7a20,_0x3b4fad);(!_0x2c65ff||(_0xe86e72(0xc0)in _0x2c65ff?!_0x1f7a20['__esModule']:_0x2c65ff[_0xe86e72(0x9c)]||_0x2c65ff[_0xe86e72(0xc9)]))&&(_0x2c65ff={'enumerable':!![],'get':function(){return _0x1f7a20[_0x3b4fad];}}),Object['defineProperty'](_0x15a64b,_0x566df2,_0x2c65ff);}:function(_0x254a86,_0x5bb13a,_0x5912bc,_0x5cf8e3){if(_0x5cf8e3===undefined)_0x5cf8e3=_0x5912bc;_0x254a86[_0x5cf8e3]=_0x5bb13a[_0x5912bc];}),__setModuleDefault=this&&this[a13_0x1cf838(0xf2)]||(Object[a13_0x1cf838(0xd6)]?function(_0x407135,_0x5a45bf){Object['defineProperty'](_0x407135,'default',{'enumerable':!![],'value':_0x5a45bf});}:function(_0x10ed20,_0x16ef3c){_0x10ed20['default']=_0x16ef3c;}),__importStar=this&&this[a13_0x1cf838(0x100)]||(function(){var _0x457ea2=function(_0x14cf5d){const _0x51c058=a13_0x37b2;return _0x457ea2=Object[_0x51c058(0xf5)]||function(_0x3cd4f0){const _0x5e7549=_0x51c058;var _0x1c8f0d=[];for(var _0xc05d1c in _0x3cd4f0)if(Object[_0x5e7549(0xac)][_0x5e7549(0xf1)][_0x5e7549(0xd1)](_0x3cd4f0,_0xc05d1c))_0x1c8f0d[_0x1c8f0d['length']]=_0xc05d1c;return _0x1c8f0d;},_0x457ea2(_0x14cf5d);};return function(_0x5de342){const _0x4e5b5f=a13_0x37b2;if(_0x5de342&&_0x5de342['__esModule'])return _0x5de342;var _0x5124d1={};if(_0x5de342!=null){for(var _0x5b9801=_0x457ea2(_0x5de342),_0x62d57c=0x0;_0x62d57c<_0x5b9801[_0x4e5b5f(0xa6)];_0x62d57c++)if(_0x5b9801[_0x62d57c]!==_0x4e5b5f(0x96))__createBinding(_0x5124d1,_0x5de342,_0x5b9801[_0x62d57c]);}return __setModuleDefault(_0x5124d1,_0x5de342),_0x5124d1;};}()),__importDefault=this&&this[a13_0x1cf838(0xe2)]||function(_0x3fcb0d){const _0x174d16=a13_0x1cf838;return _0x3fcb0d&&_0x3fcb0d[_0x174d16(0xba)]?_0x3fcb0d:{'default':_0x3fcb0d};};Object['defineProperty'](exports,a13_0x1cf838(0xba),{'value':!![]}),exports[a13_0x1cf838(0xb0)]=void 0x0;const testGatewayService_1=require(a13_0x1cf838(0x85)),webhookService_1=require(a13_0x1cf838(0xa4)),database_1=__importDefault(require(a13_0x1cf838(0xec)));class TestGatewayController{constructor(){const _0x1dce6f=a13_0x1cf838;this[_0x1dce6f(0xa1)]=async(_0x6693a2,_0x4bcc9f,_0x191ace)=>{const _0x56a3cc=_0x1dce6f;try{const {paymentId:_0x49bace}=_0x6693a2[_0x56a3cc(0xc1)];console[_0x56a3cc(0x97)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x49bace);const _0x7ba47e=await database_1[_0x56a3cc(0x96)][_0x56a3cc(0xbe)]['findUnique']({'where':{'id':_0x49bace},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x7ba47e)return _0x4bcc9f[_0x56a3cc(0xee)](0x194)[_0x56a3cc(0x101)]({'success':![],'message':_0x56a3cc(0xfa)});if(_0x7ba47e[_0x56a3cc(0xdd)]!==_0x56a3cc(0xaf))return _0x4bcc9f['status'](0x190)[_0x56a3cc(0x101)]({'success':![],'message':_0x56a3cc(0xbf)});if(_0x7ba47e[_0x56a3cc(0xee)]!=='PENDING')return _0x4bcc9f['status'](0x190)['json']({'success':![],'message':_0x56a3cc(0xc2)+_0x7ba47e[_0x56a3cc(0xee)]+_0x56a3cc(0xe3)});_0x4bcc9f[_0x56a3cc(0x101)]({'success':!![],'result':{'paymentId':_0x7ba47e['id'],'orderId':_0x7ba47e[_0x56a3cc(0xfc)],'amount':_0x7ba47e[_0x56a3cc(0xbb)],'currency':_0x7ba47e['currency'],'merchantName':_0x7ba47e['shop'][_0x56a3cc(0xc7)],'description':_0x56a3cc(0xdf)+_0x7ba47e['shop'][_0x56a3cc(0xc7)],'testInstructions':{'successCard':_0x56a3cc(0x87),'failureCard':_0x56a3cc(0xb8),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x56a3cc(0xe9),'holderName':_0x56a3cc(0x9f)}}});}catch(_0x3fe1f7){_0x191ace(_0x3fe1f7);}},this[_0x1dce6f(0x86)]=async(_0x226ae5,_0x573bb5,_0x148c31)=>{const _0x159691=_0x1dce6f;try{const {paymentId:_0x50cc98}=_0x226ae5[_0x159691(0xc1)],_0x4d2ccd=_0x226ae5[_0x159691(0xd9)];console[_0x159691(0x97)](_0x159691(0xce)+_0x50cc98);const _0x5f12cf=await database_1[_0x159691(0x96)]['payment'][_0x159691(0xf6)]({'where':{'id':_0x50cc98},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5f12cf)return _0x573bb5[_0x159691(0xee)](0x194)[_0x159691(0x101)]({'success':![],'message':_0x159691(0xfa)});if(_0x5f12cf[_0x159691(0xdd)]!==_0x159691(0xaf))return _0x573bb5[_0x159691(0xee)](0x190)[_0x159691(0x101)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5f12cf[_0x159691(0xee)]!==_0x159691(0xdc))return _0x573bb5[_0x159691(0xee)](0x190)[_0x159691(0x101)]({'success':![],'message':_0x159691(0xc2)+_0x5f12cf[_0x159691(0xee)]+',\x20cannot\x20process'});const _0x1898ef=await this[_0x159691(0x9a)][_0x159691(0xed)]({'paymentId':_0x5f12cf['id'],'orderId':_0x5f12cf[_0x159691(0xfc)]||_0x5f12cf['id'],'amount':_0x5f12cf[_0x159691(0xbb)],'currency':_0x5f12cf['currency'],'cardData':_0x4d2ccd});console[_0x159691(0x97)](_0x159691(0xe8),_0x1898ef);const _0x36e897={'status':_0x1898ef[_0x159691(0xee)],'updatedAt':new Date()};if(_0x1898ef['status']===_0x159691(0xe5))_0x36e897[_0x159691(0x92)]=new Date(),_0x36e897[_0x159691(0x9b)]=_0x1898ef[_0x159691(0x8f)];else _0x1898ef[_0x159691(0xee)]===_0x159691(0x8b)&&(_0x36e897[_0x159691(0xfb)]=_0x1898ef[_0x159691(0xf3)]);const _0x1965ab=_0x4d2ccd[_0x159691(0xe6)]['replace'](/[\s-]/g,'');_0x36e897[_0x159691(0xb3)]=_0x1965ab[_0x159691(0xfd)](-0x4),_0x36e897[_0x159691(0x88)]=_0x159691(0xb5),await database_1['default'][_0x159691(0xbe)][_0x159691(0xd2)]({'where':{'id':_0x5f12cf['id']},'data':_0x36e897});if(_0x1898ef[_0x159691(0xee)]==='PAID'&&_0x5f12cf[_0x159691(0xa3)]){console[_0x159691(0x97)](_0x159691(0x90)+_0x5f12cf['id']+_0x159691(0xcb));try{await database_1[_0x159691(0x96)][_0x159691(0xab)](async _0x2aac1b=>{const _0x29aa8a=_0x159691,_0x34b15e=await _0x2aac1b[_0x29aa8a(0xf7)][_0x29aa8a(0xf6)]({'where':{'id':_0x5f12cf[_0x29aa8a(0xa3)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x34b15e){console[_0x29aa8a(0x97)](_0x29aa8a(0xc3)+_0x34b15e['id']+':\x20type='+_0x34b15e['type']+_0x29aa8a(0xe0)+_0x34b15e[_0x29aa8a(0xeb)]+_0x29aa8a(0xa9)+_0x34b15e[_0x29aa8a(0xee)]);const _0x35f828=_0x34b15e[_0x29aa8a(0xeb)]+0x1,_0xedbf=_0x34b15e[_0x29aa8a(0xd8)]===_0x29aa8a(0xc5)?'COMPLETED':_0x34b15e[_0x29aa8a(0xee)];await _0x2aac1b['paymentLink']['update']({'where':{'id':_0x5f12cf['paymentLinkId']},'data':{'currentPayments':_0x35f828,'status':_0xedbf,'updatedAt':new Date()}}),console[_0x29aa8a(0x97)](_0x29aa8a(0xe4)+_0x34b15e['id']+_0x29aa8a(0xad)+_0x34b15e['currentPayments']+'\x20->\x20'+_0x35f828+_0x29aa8a(0xa9)+_0x34b15e[_0x29aa8a(0xee)]+_0x29aa8a(0xb9)+_0xedbf);}else console[_0x29aa8a(0x97)](_0x29aa8a(0xa7)+_0x5f12cf[_0x29aa8a(0xa3)]+_0x29aa8a(0xe7));});}catch(_0x3d13d5){console[_0x159691(0xc8)](_0x159691(0xbd),_0x3d13d5);}}await database_1[_0x159691(0x96)][_0x159691(0xef)]['create']({'data':{'paymentId':_0x5f12cf['id'],'shopId':_0x5f12cf[_0x159691(0xe1)],'event':_0x159691(0x98)+_0x1898ef[_0x159691(0xee)][_0x159691(0x83)](),'statusCode':0xc8,'responseBody':JSON[_0x159691(0xb6)]({'oldStatus':'PENDING','newStatus':_0x1898ef[_0x159691(0xee)],'transactionId':_0x1898ef[_0x159691(0x8f)],'failureReason':_0x1898ef[_0x159691(0xf3)],'processedAt':new Date()[_0x159691(0xb1)]()})}}),await this[_0x159691(0xde)](_0x5f12cf,_0x1898ef[_0x159691(0xee)],_0x1898ef['transactionId'],_0x1898ef['failureReason']),await this['sendPaymentStatusNotification'](_0x5f12cf,_0x1898ef[_0x159691(0xee)]),console['log'](_0x159691(0xd4)+_0x50cc98+'\x20processed:\x20'+_0x1898ef[_0x159691(0xee)]),_0x1898ef['status']===_0x159691(0xe5)?_0x573bb5['json']({'success':!![],'message':_0x159691(0xa0),'result':{'status':_0x159691(0xe5),'transactionId':_0x1898ef['transactionId'],'redirectUrl':_0x5f12cf[_0x159691(0xa5)]}}):_0x573bb5[_0x159691(0xee)](0x190)['json']({'success':![],'message':_0x159691(0xc6),'result':{'status':'FAILED','failureReason':_0x1898ef[_0x159691(0xf3)],'redirectUrl':_0x5f12cf['failUrl']}});}catch(_0x2e4b54){_0x148c31(_0x2e4b54);}},this[_0x1dce6f(0x9a)]=new testGatewayService_1[(_0x1dce6f(0x84))](),this[_0x1dce6f(0xae)]=new webhookService_1[(_0x1dce6f(0xa8))]();}async['sendShopWebhook'](_0x430b8c,_0x3768fe,_0x2f1818,_0x34c7fc){const _0x5ee497=a13_0x1cf838,_0x107c47=Date[_0x5ee497(0xd0)]();try{const _0x3bd75c=_0x430b8c[_0x5ee497(0x9e)],_0x4b5910=_0x3bd75c[_0x5ee497(0x8d)];if(!_0x4b5910?.['webhookUrl']){console[_0x5ee497(0x97)](_0x5ee497(0x94)+_0x3bd75c['id']);return;}const _0x472830=_0x3768fe==='PAID'?_0x5ee497(0xf4):_0x5ee497(0xb4);let _0x30eaa1=[];if(_0x4b5910[_0x5ee497(0xb7)])try{_0x30eaa1=Array[_0x5ee497(0x102)](_0x4b5910[_0x5ee497(0xb7)])?_0x4b5910['webhookEvents']:JSON[_0x5ee497(0xca)](_0x4b5910[_0x5ee497(0xb7)]);}catch(_0x560f58){console[_0x5ee497(0xc8)]('Error\x20parsing\x20webhook\x20events:',_0x560f58),_0x30eaa1=[];}if(!_0x30eaa1['includes'](_0x472830)){console[_0x5ee497(0x97)](_0x5ee497(0xc4)+_0x472830+_0x5ee497(0xb2)+_0x3bd75c['id']);return;}const _0x1f6a7f={'event':_0x472830,'payment':{'id':_0x430b8c['id'],'order_id':_0x430b8c[_0x5ee497(0x9d)],'gateway_order_id':_0x430b8c[_0x5ee497(0xfc)],'gateway':_0x5ee497(0x93),'amount':_0x430b8c['amount'],'currency':_0x430b8c['currency'],'status':_0x3768fe['toLowerCase'](),'customer_email':_0x430b8c[_0x5ee497(0xf8)],'customer_name':_0x430b8c['customerName'],'transaction_id':_0x2f1818,'failure_message':_0x34c7fc,'created_at':_0x430b8c[_0x5ee497(0x8e)],'updated_at':new Date()}},_0x5be0a4=await fetch(_0x4b5910[_0x5ee497(0x89)],{'method':_0x5ee497(0xdb),'headers':{'Content-Type':_0x5ee497(0xcc),'User-Agent':_0x5ee497(0xd3)},'body':JSON[_0x5ee497(0xb6)](_0x1f6a7f)}),_0x3417fe=Date[_0x5ee497(0xd0)]()-_0x107c47;console[_0x5ee497(0x97)](_0x5ee497(0xcd)+_0x4b5910['webhookUrl']+'\x20with\x20status\x20'+_0x5be0a4[_0x5ee497(0xee)]+'\x20('+_0x3417fe+_0x5ee497(0xfe));}catch(_0xf96d23){console[_0x5ee497(0xc8)](_0x5ee497(0xbc),_0xf96d23);}}async['sendPaymentStatusNotification'](_0x1fd1cc,_0x5e87c5){const _0x1161ce=a13_0x1cf838;try{const {telegramBotService:_0x15abc2}=await Promise['resolve']()['then'](()=>__importStar(require(_0x1161ce(0xd7)))),_0x5b63d0={'PAID':_0x1161ce(0x8a),'FAILED':'failed'},_0x1f461d=_0x5b63d0[_0x5e87c5];if(!_0x1f461d)return;await _0x15abc2[_0x1161ce(0x95)](_0x1fd1cc[_0x1161ce(0xe1)],_0x1fd1cc,_0x1f461d);}catch(_0xd3cfa9){console[_0x1161ce(0xc8)](_0x1161ce(0x91),_0xd3cfa9);}}}exports['TestGatewayController']=TestGatewayController;