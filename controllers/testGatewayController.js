'use strict';const a13_0x30e812=a13_0x365c;(function(_0x2a7984,_0x329f8f){const _0x59f5d7=a13_0x365c,_0x2053e7=_0x2a7984();while(!![]){try{const _0x3b3472=-parseInt(_0x59f5d7(0xac))/0x1*(parseInt(_0x59f5d7(0xbe))/0x2)+-parseInt(_0x59f5d7(0xc3))/0x3*(-parseInt(_0x59f5d7(0x91))/0x4)+-parseInt(_0x59f5d7(0xdb))/0x5*(-parseInt(_0x59f5d7(0xaf))/0x6)+-parseInt(_0x59f5d7(0x99))/0x7*(-parseInt(_0x59f5d7(0xea))/0x8)+parseInt(_0x59f5d7(0x9e))/0x9*(-parseInt(_0x59f5d7(0xa7))/0xa)+-parseInt(_0x59f5d7(0x88))/0xb*(-parseInt(_0x59f5d7(0xb8))/0xc)+-parseInt(_0x59f5d7(0xa6))/0xd;if(_0x3b3472===_0x329f8f)break;else _0x2053e7['push'](_0x2053e7['shift']());}catch(_0xc4b8a0){_0x2053e7['push'](_0x2053e7['shift']());}}}(a13_0x2b6f,0x2730b));function a13_0x365c(_0x2a73aa,_0x4d0cca){const _0x2b6f6b=a13_0x2b6f();return a13_0x365c=function(_0x365cee,_0x333e38){_0x365cee=_0x365cee-0x76;let _0x19ee2e=_0x2b6f6b[_0x365cee];return _0x19ee2e;},a13_0x365c(_0x2a73aa,_0x4d0cca);}function a13_0x2b6f(){const _0x4200e6=['âœ…\x20Test\x20Gateway\x20payment\x20','1703982DQrKeO','Payment\x20status\x20is\x20','__importStar','getPaymentForm','FAILED','transactionId','failed','body','Webhook\x20event\x20','669108gBzzvy','status','isArray','payment','test_gateway','application/json','358994eMPXOC','now','webhookEvents','sendShopWebhook','__esModule','3nRAsOS','ms)','currency','configurable','update','webhookService','\x20not\x20enabled\x20for\x20shop\x20','__importDefault','processCard','defineProperty','gatewayOrderId','default','prototype','shop','Payment\x20not\x20found','gatewayPaymentId','amount','../services/gateways/testGatewayService','successUrl','failureReason','__createBinding','PAID','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20to\x20','5kLywnb','includes','Any\x20other\x20card\x20number','TestGatewayController','WebhookService','getOwnPropertyDescriptor','getOwnPropertyNames','TestGatewayService','Any\x20future\x20date\x20(MM/YY)','log','test_card','settings','length','paid','0000','1677832KjMXnH','error','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','../services/webhookService','cardNumber','stringify','POST','payment.failed','call','json','4242\x204242\x204242\x204242','params',',\x20cannot\x20process','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','slice','orderId','toISOString','writable','failUrl','PENDING','shopId','11RyzQNK','paidAt','ðŸ§ª\x20Test\x20Gateway\x20result:','Payment\x20failed','\x20processed:\x20','gateway','resolve','../services/telegramBotService','processCardPayment','429684bxcDVY','Error\x20parsing\x20webhook\x20events:','../config/database','testGatewayService','\x20with\x20status\x20','replace','webhookLog','name','7MGsRWZ','create','__setModuleDefault','customerEmail','webhookUrl','994545VNBrbN','Any\x203-4\x20digits','Payment\x20is\x20not\x20for\x20test\x20gateway','payment.success','cardLast4','sendPaymentStatusNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Any\x20name','2682953RJEdGt','10ewvLgc','Payment\x20processed\x20successfully','then','failureMessage','get','1tOldct','findUnique'];a13_0x2b6f=function(){return _0x4200e6;};return a13_0x2b6f();}var __createBinding=this&&this[a13_0x30e812(0xd7)]||(Object['create']?function(_0x343a07,_0xd41281,_0x4f1230,_0x5da50f){const _0x42acdc=a13_0x30e812;if(_0x5da50f===undefined)_0x5da50f=_0x4f1230;var _0x4638b5=Object[_0x42acdc(0xe0)](_0xd41281,_0x4f1230);(!_0x4638b5||(_0x42acdc(0xab)in _0x4638b5?!_0xd41281[_0x42acdc(0xc2)]:_0x4638b5[_0x42acdc(0x84)]||_0x4638b5[_0x42acdc(0xc6)]))&&(_0x4638b5={'enumerable':!![],'get':function(){return _0xd41281[_0x4f1230];}}),Object[_0x42acdc(0xcc)](_0x343a07,_0x5da50f,_0x4638b5);}:function(_0x1c2313,_0x2807bc,_0x1e65ed,_0x12b01f){if(_0x12b01f===undefined)_0x12b01f=_0x1e65ed;_0x1c2313[_0x12b01f]=_0x2807bc[_0x1e65ed];}),__setModuleDefault=this&&this[a13_0x30e812(0x9b)]||(Object[a13_0x30e812(0x9a)]?function(_0x44ac4f,_0x1c13a5){const _0x8c8a76=a13_0x30e812;Object[_0x8c8a76(0xcc)](_0x44ac4f,_0x8c8a76(0xce),{'enumerable':!![],'value':_0x1c13a5});}:function(_0x559d92,_0x4e62c2){const _0x44bd69=a13_0x30e812;_0x559d92[_0x44bd69(0xce)]=_0x4e62c2;}),__importStar=this&&this[a13_0x30e812(0xb1)]||(function(){var _0x43542d=function(_0x1a2600){const _0x5c9a12=a13_0x365c;return _0x43542d=Object[_0x5c9a12(0xe1)]||function(_0x2f1b37){const _0x3c6ce0=_0x5c9a12;var _0x223420=[];for(var _0x452e30 in _0x2f1b37)if(Object[_0x3c6ce0(0xcf)]['hasOwnProperty'][_0x3c6ce0(0x7b)](_0x2f1b37,_0x452e30))_0x223420[_0x223420['length']]=_0x452e30;return _0x223420;},_0x43542d(_0x1a2600);};return function(_0x502329){const _0x2f2781=a13_0x365c;if(_0x502329&&_0x502329[_0x2f2781(0xc2)])return _0x502329;var _0x1106dd={};if(_0x502329!=null){for(var _0x13447a=_0x43542d(_0x502329),_0x56dc4b=0x0;_0x56dc4b<_0x13447a[_0x2f2781(0xe7)];_0x56dc4b++)if(_0x13447a[_0x56dc4b]!==_0x2f2781(0xce))__createBinding(_0x1106dd,_0x502329,_0x13447a[_0x56dc4b]);}return __setModuleDefault(_0x1106dd,_0x502329),_0x1106dd;};}()),__importDefault=this&&this[a13_0x30e812(0xca)]||function(_0x13ed5c){const _0x53094c=a13_0x30e812;return _0x13ed5c&&_0x13ed5c[_0x53094c(0xc2)]?_0x13ed5c:{'default':_0x13ed5c};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x30e812(0xde)]=void 0x0;const testGatewayService_1=require(a13_0x30e812(0xd4)),webhookService_1=require(a13_0x30e812(0x76)),database_1=__importDefault(require(a13_0x30e812(0x93)));class TestGatewayController{constructor(){const _0xbb01da=a13_0x30e812;this[_0xbb01da(0xb2)]=async(_0x330ef4,_0x22ad41,_0x1b2199)=>{const _0x23e24b=_0xbb01da;try{const {paymentId:_0x58c8e6}=_0x330ef4[_0x23e24b(0x7e)];console[_0x23e24b(0xe4)](_0x23e24b(0xec)+_0x58c8e6);const _0x23c564=await database_1[_0x23e24b(0xce)][_0x23e24b(0xbb)][_0x23e24b(0xad)]({'where':{'id':_0x58c8e6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x23c564)return _0x22ad41[_0x23e24b(0xb9)](0x194)[_0x23e24b(0x7c)]({'success':![],'message':_0x23e24b(0xd1)});if(_0x23c564[_0x23e24b(0x8d)]!==_0x23e24b(0xbc))return _0x22ad41[_0x23e24b(0xb9)](0x190)[_0x23e24b(0x7c)]({'success':![],'message':_0x23e24b(0xa0)});if(_0x23c564[_0x23e24b(0xb9)]!=='PENDING')return _0x22ad41[_0x23e24b(0xb9)](0x190)[_0x23e24b(0x7c)]({'success':![],'message':_0x23e24b(0xb0)+_0x23c564['status']+_0x23e24b(0x7f)});_0x22ad41['json']({'success':!![],'result':{'paymentId':_0x23c564['id'],'orderId':_0x23c564[_0x23e24b(0xcd)],'amount':_0x23c564[_0x23e24b(0xd3)],'currency':_0x23c564[_0x23e24b(0xc5)],'merchantName':_0x23c564[_0x23e24b(0xd0)]['name'],'description':_0x23e24b(0xda)+_0x23c564[_0x23e24b(0xd0)][_0x23e24b(0x98)],'testInstructions':{'successCard':_0x23e24b(0x7d),'failureCard':_0x23e24b(0xdd),'expiryDate':_0x23e24b(0xe3),'cvc':_0x23e24b(0x9f),'holderName':_0x23e24b(0xa5)}}});}catch(_0x3a3d39){_0x1b2199(_0x3a3d39);}},this[_0xbb01da(0xcb)]=async(_0x28317d,_0x9e8043,_0x29de77)=>{const _0x3931a0=_0xbb01da;try{const {paymentId:_0x5c76c7}=_0x28317d[_0x3931a0(0x7e)],_0x58829e=_0x28317d[_0x3931a0(0xb6)];console[_0x3931a0(0xe4)](_0x3931a0(0xd9)+_0x5c76c7);const _0x88af4=await database_1[_0x3931a0(0xce)][_0x3931a0(0xbb)][_0x3931a0(0xad)]({'where':{'id':_0x5c76c7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x88af4)return _0x9e8043['status'](0x194)[_0x3931a0(0x7c)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x88af4[_0x3931a0(0x8d)]!=='test_gateway')return _0x9e8043[_0x3931a0(0xb9)](0x190)[_0x3931a0(0x7c)]({'success':![],'message':_0x3931a0(0xa0)});if(_0x88af4[_0x3931a0(0xb9)]!=='PENDING')return _0x9e8043[_0x3931a0(0xb9)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x88af4[_0x3931a0(0xb9)]+_0x3931a0(0x7f)});const _0x347d96=await this[_0x3931a0(0x94)][_0x3931a0(0x90)]({'paymentId':_0x88af4['id'],'orderId':_0x88af4[_0x3931a0(0xcd)]||_0x88af4['id'],'amount':_0x88af4[_0x3931a0(0xd3)],'currency':_0x88af4[_0x3931a0(0xc5)],'cardData':_0x58829e});console[_0x3931a0(0xe4)](_0x3931a0(0x8a),_0x347d96);const _0x3f72ae={'status':_0x347d96[_0x3931a0(0xb9)],'updatedAt':new Date()};if(_0x347d96[_0x3931a0(0xb9)]===_0x3931a0(0xd8))_0x3f72ae[_0x3931a0(0x89)]=new Date(),_0x3f72ae[_0x3931a0(0xd2)]=_0x347d96[_0x3931a0(0xb4)];else _0x347d96[_0x3931a0(0xb9)]===_0x3931a0(0xb3)&&(_0x3f72ae[_0x3931a0(0xaa)]=_0x347d96['failureReason']);const _0x380b0e=_0x58829e[_0x3931a0(0x77)][_0x3931a0(0x96)](/[\s-]/g,'');_0x3f72ae[_0x3931a0(0xa2)]=_0x380b0e[_0x3931a0(0x81)](-0x4),_0x3f72ae['paymentMethod']=_0x3931a0(0xe5),await database_1[_0x3931a0(0xce)][_0x3931a0(0xbb)][_0x3931a0(0xc7)]({'where':{'id':_0x88af4['id']},'data':_0x3f72ae}),await database_1[_0x3931a0(0xce)][_0x3931a0(0x97)][_0x3931a0(0x9a)]({'data':{'paymentId':_0x88af4['id'],'shopId':_0x88af4['shopId'],'event':'test_gateway_'+_0x347d96['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3931a0(0x78)]({'oldStatus':_0x3931a0(0x86),'newStatus':_0x347d96[_0x3931a0(0xb9)],'transactionId':_0x347d96[_0x3931a0(0xb4)],'failureReason':_0x347d96['failureReason'],'processedAt':new Date()[_0x3931a0(0x83)]()})}}),await this[_0x3931a0(0xc1)](_0x88af4,_0x347d96[_0x3931a0(0xb9)],_0x347d96['transactionId'],_0x347d96[_0x3931a0(0xd6)]),await this['sendPaymentStatusNotification'](_0x88af4,_0x347d96[_0x3931a0(0xb9)]),console[_0x3931a0(0xe4)](_0x3931a0(0xae)+_0x5c76c7+_0x3931a0(0x8c)+_0x347d96[_0x3931a0(0xb9)]),_0x347d96[_0x3931a0(0xb9)]===_0x3931a0(0xd8)?_0x9e8043[_0x3931a0(0x7c)]({'success':!![],'message':_0x3931a0(0xa8),'result':{'status':_0x3931a0(0xd8),'transactionId':_0x347d96[_0x3931a0(0xb4)],'redirectUrl':_0x88af4[_0x3931a0(0xd5)]}}):_0x9e8043['status'](0x190)['json']({'success':![],'message':_0x3931a0(0x8b),'result':{'status':'FAILED','failureReason':_0x347d96['failureReason'],'redirectUrl':_0x88af4[_0x3931a0(0x85)]}});}catch(_0x899945){_0x29de77(_0x899945);}},this[_0xbb01da(0x94)]=new testGatewayService_1[(_0xbb01da(0xe2))](),this[_0xbb01da(0xc8)]=new webhookService_1[(_0xbb01da(0xdf))]();}async[a13_0x30e812(0xc1)](_0x53b5ee,_0x1a63d4,_0x2869cf,_0x55c8f1){const _0x289080=a13_0x30e812,_0x5ee5a4=Date['now']();try{const _0x4fed52=_0x53b5ee[_0x289080(0xd0)],_0x57624e=_0x4fed52[_0x289080(0xe6)];if(!_0x57624e?.[_0x289080(0x9d)]){console[_0x289080(0xe4)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4fed52['id']);return;}const _0x35fbf7=_0x1a63d4==='PAID'?_0x289080(0xa1):_0x289080(0x7a);let _0x216f2f=[];if(_0x57624e[_0x289080(0xc0)])try{_0x216f2f=Array[_0x289080(0xba)](_0x57624e[_0x289080(0xc0)])?_0x57624e[_0x289080(0xc0)]:JSON['parse'](_0x57624e[_0x289080(0xc0)]);}catch(_0x400d12){console[_0x289080(0xeb)](_0x289080(0x92),_0x400d12),_0x216f2f=[];}if(!_0x216f2f[_0x289080(0xdc)](_0x35fbf7)){console[_0x289080(0xe4)](_0x289080(0xb7)+_0x35fbf7+_0x289080(0xc9)+_0x4fed52['id']);return;}const _0x5c93b6={'event':_0x35fbf7,'payment':{'id':_0x53b5ee['id'],'order_id':_0x53b5ee[_0x289080(0x82)],'gateway_order_id':_0x53b5ee['gatewayOrderId'],'gateway':_0x289080(0xe9),'amount':_0x53b5ee[_0x289080(0xd3)],'currency':_0x53b5ee[_0x289080(0xc5)],'status':_0x1a63d4['toLowerCase'](),'customer_email':_0x53b5ee[_0x289080(0x9c)],'customer_name':_0x53b5ee['customerName'],'transaction_id':_0x2869cf,'failure_message':_0x55c8f1,'created_at':_0x53b5ee['createdAt'],'updated_at':new Date()}},_0xfa6048=await fetch(_0x57624e[_0x289080(0x9d)],{'method':_0x289080(0x79),'headers':{'Content-Type':_0x289080(0xbd),'User-Agent':_0x289080(0x80)},'body':JSON[_0x289080(0x78)](_0x5c93b6)}),_0x324734=Date[_0x289080(0xbf)]()-_0x5ee5a4;console[_0x289080(0xe4)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x57624e[_0x289080(0x9d)]+_0x289080(0x95)+_0xfa6048[_0x289080(0xb9)]+'\x20('+_0x324734+_0x289080(0xc4));}catch(_0x5ccdc2){console[_0x289080(0xeb)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x5ccdc2);}}async[a13_0x30e812(0xa3)](_0x54383f,_0x3edc8f){const _0x5b6eeb=a13_0x30e812;try{const {telegramBotService:_0x109644}=await Promise[_0x5b6eeb(0x8e)]()[_0x5b6eeb(0xa9)](()=>__importStar(require(_0x5b6eeb(0x8f)))),_0x1f50bb={'PAID':_0x5b6eeb(0xe8),'FAILED':_0x5b6eeb(0xb5)},_0x3df739=_0x1f50bb[_0x3edc8f];if(!_0x3df739)return;await _0x109644['sendPaymentNotification'](_0x54383f[_0x5b6eeb(0x87)],_0x54383f,_0x3df739);}catch(_0x5096fe){console[_0x5b6eeb(0xeb)](_0x5b6eeb(0xa4),_0x5096fe);}}}exports[a13_0x30e812(0xde)]=TestGatewayController;