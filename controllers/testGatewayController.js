'use strict';const a13_0x108947=a13_0x4247;function a13_0x1c6e(){const _0x2f7a4e=['üìà\x20Test\x20Gateway:\x20Payment\x20','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failureReason','PAID','orderId','__esModule','settings','\x20with\x20status\x20','gatewayPaymentId','paymentLinkId','\x20->\x20','TestGatewayController','Payment\x20to\x20','11468810SdhxYN','test_card','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../services/gateways/testGatewayService','FAILED','failed','getOwnPropertyDescriptor','currency','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Any\x20other\x20card\x20number','üìà\x20Found\x20payment\x20link\x20','Payment\x20status\x20is\x20','shopId','TestGatewayService',',\x20status=','\x20not\x20found','webhookUrl','gateway','webhookService','configurable','4707mnQCFZ','currentPayments','6496835hLmIRn','Any\x20name','get','toLowerCase','prototype','SINGLE','sendShopWebhook','PENDING','__importStar','testGatewayService','test_gateway','‚úÖ\x20Payment\x20link\x20','../config/database','failUrl',':\x20type=','isArray','webhookEvents','__setModuleDefault','create','transactionId','0000','getPaymentForm','7568NfnuMn','‚úÖ\x20Test\x20Gateway\x20payment\x20','resolve','20084WCZldN','57CkTtYW','‚ùå\x20Payment\x20link\x20','paidAt','$transaction','paid','1070364JbHfPB','test_gateway_','processCard','json','status','body','Any\x20future\x20date\x20(MM/YY)','amount','sendPaymentStatusNotification','createdAt','payment.success','successUrl','paymentMethod','Payment\x20failed','default','__importDefault','slice','sendPaymentNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/telegramBotService','parse','üß™\x20Test\x20Gateway\x20result:','defineProperty','customerEmail','6MIovvX','update','findUnique','payment.failed','2059338mzMmbT','params','cardNumber','4966353GKvehR','call','shop','gatewayOrderId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','payment','failureMessage','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20not\x20found','log','ms)','cardLast4',',\x20cannot\x20process','error','now','POST','webhookLog','__createBinding','toISOString','type','then'];a13_0x1c6e=function(){return _0x2f7a4e;};return a13_0x1c6e();}(function(_0x3cf931,_0x9c3f19){const _0x12cc8b=a13_0x4247,_0x2d8423=_0x3cf931();while(!![]){try{const _0x50ac5a=-parseInt(_0x12cc8b(0x1f1))/0x1+-parseInt(_0x12cc8b(0x20d))/0x2+parseInt(_0x12cc8b(0x1ec))/0x3*(parseInt(_0x12cc8b(0x1eb))/0x4)+parseInt(_0x12cc8b(0x1d2))/0x5*(parseInt(_0x12cc8b(0x209))/0x6)+parseInt(_0x12cc8b(0x210))/0x7+parseInt(_0x12cc8b(0x1e8))/0x8*(-parseInt(_0x12cc8b(0x1d0))/0x9)+parseInt(_0x12cc8b(0x1bc))/0xa;if(_0x50ac5a===_0x9c3f19)break;else _0x2d8423['push'](_0x2d8423['shift']());}catch(_0x7730d8){_0x2d8423['push'](_0x2d8423['shift']());}}}(a13_0x1c6e,0xa03cf));var __createBinding=this&&this[a13_0x108947(0x221)]||(Object[a13_0x108947(0x1e4)]?function(_0x7d3ef9,_0xc1894a,_0x4b968b,_0x563f52){const _0x4aa82c=a13_0x108947;if(_0x563f52===undefined)_0x563f52=_0x4b968b;var _0x3aabed=Object[_0x4aa82c(0x1c2)](_0xc1894a,_0x4b968b);(!_0x3aabed||(_0x4aa82c(0x1d4)in _0x3aabed?!_0xc1894a['__esModule']:_0x3aabed['writable']||_0x3aabed[_0x4aa82c(0x1cf)]))&&(_0x3aabed={'enumerable':!![],'get':function(){return _0xc1894a[_0x4b968b];}}),Object[_0x4aa82c(0x207)](_0x7d3ef9,_0x563f52,_0x3aabed);}:function(_0x1b023b,_0x209ddd,_0x1463d0,_0x37dc77){if(_0x37dc77===undefined)_0x37dc77=_0x1463d0;_0x1b023b[_0x37dc77]=_0x209ddd[_0x1463d0];}),__setModuleDefault=this&&this[a13_0x108947(0x1e3)]||(Object[a13_0x108947(0x1e4)]?function(_0x16c7bf,_0x2ee4bf){const _0xefa637=a13_0x108947;Object[_0xefa637(0x207)](_0x16c7bf,_0xefa637(0x1ff),{'enumerable':!![],'value':_0x2ee4bf});}:function(_0x5221a2,_0x42a8ac){const _0x55a417=a13_0x108947;_0x5221a2[_0x55a417(0x1ff)]=_0x42a8ac;}),__importStar=this&&this[a13_0x108947(0x1da)]||(function(){var _0x5c3f3f=function(_0x32072c){return _0x5c3f3f=Object['getOwnPropertyNames']||function(_0x1f6775){const _0x1eaa3e=a13_0x4247;var _0x23c1de=[];for(var _0x2844c8 in _0x1f6775)if(Object[_0x1eaa3e(0x1d6)]['hasOwnProperty'][_0x1eaa3e(0x211)](_0x1f6775,_0x2844c8))_0x23c1de[_0x23c1de['length']]=_0x2844c8;return _0x23c1de;},_0x5c3f3f(_0x32072c);};return function(_0x95239b){const _0x266eaa=a13_0x4247;if(_0x95239b&&_0x95239b[_0x266eaa(0x22a)])return _0x95239b;var _0x24c666={};if(_0x95239b!=null){for(var _0x336bee=_0x5c3f3f(_0x95239b),_0x4b00b6=0x0;_0x4b00b6<_0x336bee['length'];_0x4b00b6++)if(_0x336bee[_0x4b00b6]!==_0x266eaa(0x1ff))__createBinding(_0x24c666,_0x95239b,_0x336bee[_0x4b00b6]);}return __setModuleDefault(_0x24c666,_0x95239b),_0x24c666;};}()),__importDefault=this&&this[a13_0x108947(0x200)]||function(_0x62e028){return _0x62e028&&_0x62e028['__esModule']?_0x62e028:{'default':_0x62e028};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x108947(0x1bf)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x108947(0x1de)));function a13_0x4247(_0x25c276,_0x40cb5e){const _0x1c6ecb=a13_0x1c6e();return a13_0x4247=function(_0x42472b,_0x499311){_0x42472b=_0x42472b-0x1bb;let _0x3d1e89=_0x1c6ecb[_0x42472b];return _0x3d1e89;},a13_0x4247(_0x25c276,_0x40cb5e);}class TestGatewayController{constructor(){const _0x39e40c=a13_0x108947;this[_0x39e40c(0x1e7)]=async(_0x42dcdd,_0x109cab,_0x28e3e3)=>{const _0x3bd19=_0x39e40c;try{const {paymentId:_0x8a4d02}=_0x42dcdd['params'];console['log'](_0x3bd19(0x226)+_0x8a4d02);const _0x471e32=await database_1[_0x3bd19(0x1ff)][_0x3bd19(0x215)][_0x3bd19(0x20b)]({'where':{'id':_0x8a4d02},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x471e32)return _0x109cab['status'](0x194)[_0x3bd19(0x1f4)]({'success':![],'message':_0x3bd19(0x218)});if(_0x471e32[_0x3bd19(0x1cd)]!=='test_gateway')return _0x109cab[_0x3bd19(0x1f5)](0x190)[_0x3bd19(0x1f4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x471e32[_0x3bd19(0x1f5)]!==_0x3bd19(0x1d9))return _0x109cab[_0x3bd19(0x1f5)](0x190)[_0x3bd19(0x1f4)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x471e32[_0x3bd19(0x1f5)]+',\x20cannot\x20process'});_0x109cab[_0x3bd19(0x1f4)]({'success':!![],'result':{'paymentId':_0x471e32['id'],'orderId':_0x471e32[_0x3bd19(0x213)],'amount':_0x471e32[_0x3bd19(0x1f8)],'currency':_0x471e32['currency'],'merchantName':_0x471e32[_0x3bd19(0x212)]['name'],'description':_0x3bd19(0x1bb)+_0x471e32[_0x3bd19(0x212)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x3bd19(0x1c5),'expiryDate':_0x3bd19(0x1f7),'cvc':'Any\x203-4\x20digits','holderName':_0x3bd19(0x1d3)}}});}catch(_0x1fb56b){_0x28e3e3(_0x1fb56b);}},this[_0x39e40c(0x1f3)]=async(_0x178409,_0x49b99f,_0x38d786)=>{const _0x47920e=_0x39e40c;try{const {paymentId:_0x276971}=_0x178409[_0x47920e(0x20e)],_0x41c427=_0x178409[_0x47920e(0x1f6)];console[_0x47920e(0x219)](_0x47920e(0x217)+_0x276971);const _0x1bc503=await database_1[_0x47920e(0x1ff)][_0x47920e(0x215)]['findUnique']({'where':{'id':_0x276971},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1bc503)return _0x49b99f[_0x47920e(0x1f5)](0x194)[_0x47920e(0x1f4)]({'success':![],'message':_0x47920e(0x218)});if(_0x1bc503[_0x47920e(0x1cd)]!==_0x47920e(0x1dc))return _0x49b99f[_0x47920e(0x1f5)](0x190)[_0x47920e(0x1f4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x1bc503['status']!==_0x47920e(0x1d9))return _0x49b99f[_0x47920e(0x1f5)](0x190)['json']({'success':![],'message':_0x47920e(0x1c7)+_0x1bc503[_0x47920e(0x1f5)]+_0x47920e(0x21c)});const _0x1c8d46=await this['testGatewayService']['processCardPayment']({'paymentId':_0x1bc503['id'],'orderId':_0x1bc503['gatewayOrderId']||_0x1bc503['id'],'amount':_0x1bc503[_0x47920e(0x1f8)],'currency':_0x1bc503[_0x47920e(0x1c3)],'cardData':_0x41c427});console['log'](_0x47920e(0x206),_0x1c8d46);const _0x4b0882={'status':_0x1c8d46[_0x47920e(0x1f5)],'updatedAt':new Date()};if(_0x1c8d46['status']===_0x47920e(0x228))_0x4b0882[_0x47920e(0x1ee)]=new Date(),_0x4b0882[_0x47920e(0x22d)]=_0x1c8d46[_0x47920e(0x1e5)];else _0x1c8d46[_0x47920e(0x1f5)]===_0x47920e(0x1c0)&&(_0x4b0882[_0x47920e(0x216)]=_0x1c8d46[_0x47920e(0x227)]);const _0x4414d4=_0x41c427[_0x47920e(0x20f)]['replace'](/[\s-]/g,'');_0x4b0882[_0x47920e(0x21b)]=_0x4414d4[_0x47920e(0x201)](-0x4),_0x4b0882[_0x47920e(0x1fd)]=_0x47920e(0x1bd),await database_1[_0x47920e(0x1ff)]['payment'][_0x47920e(0x20a)]({'where':{'id':_0x1bc503['id']},'data':_0x4b0882});if(_0x1c8d46[_0x47920e(0x1f5)]===_0x47920e(0x228)&&_0x1bc503[_0x47920e(0x22e)]){console[_0x47920e(0x219)](_0x47920e(0x225)+_0x1bc503['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x47920e(0x1ff)][_0x47920e(0x1ef)](async _0x1a81f6=>{const _0x4549f0=_0x47920e,_0x5dd142=await _0x1a81f6['paymentLink'][_0x4549f0(0x20b)]({'where':{'id':_0x1bc503['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5dd142){console['log'](_0x4549f0(0x1c6)+_0x5dd142['id']+_0x4549f0(0x1e0)+_0x5dd142['type']+',\x20currentPayments='+_0x5dd142[_0x4549f0(0x1d1)]+_0x4549f0(0x1ca)+_0x5dd142[_0x4549f0(0x1f5)]);const _0x1aa7c8=_0x5dd142[_0x4549f0(0x1d1)]+0x1,_0x2f7296=_0x5dd142[_0x4549f0(0x223)]===_0x4549f0(0x1d7)?'COMPLETED':_0x5dd142[_0x4549f0(0x1f5)];await _0x1a81f6['paymentLink'][_0x4549f0(0x20a)]({'where':{'id':_0x1bc503[_0x4549f0(0x22e)]},'data':{'currentPayments':_0x1aa7c8,'status':_0x2f7296,'updatedAt':new Date()}}),console['log'](_0x4549f0(0x1dd)+_0x5dd142['id']+'\x20updated:\x20currentPayments='+_0x5dd142[_0x4549f0(0x1d1)]+_0x4549f0(0x22f)+_0x1aa7c8+_0x4549f0(0x1ca)+_0x5dd142[_0x4549f0(0x1f5)]+_0x4549f0(0x22f)+_0x2f7296);}else console[_0x4549f0(0x219)](_0x4549f0(0x1ed)+_0x1bc503[_0x4549f0(0x22e)]+_0x4549f0(0x1cb));});}catch(_0x57e50f){console[_0x47920e(0x21d)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x57e50f);}}await database_1[_0x47920e(0x1ff)][_0x47920e(0x220)]['create']({'data':{'paymentId':_0x1bc503['id'],'shopId':_0x1bc503[_0x47920e(0x1c8)],'event':_0x47920e(0x1f2)+_0x1c8d46['status'][_0x47920e(0x1d5)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x47920e(0x1d9),'newStatus':_0x1c8d46[_0x47920e(0x1f5)],'transactionId':_0x1c8d46[_0x47920e(0x1e5)],'failureReason':_0x1c8d46[_0x47920e(0x227)],'processedAt':new Date()[_0x47920e(0x222)]()})}}),await this[_0x47920e(0x1d8)](_0x1bc503,_0x1c8d46[_0x47920e(0x1f5)],_0x1c8d46[_0x47920e(0x1e5)],_0x1c8d46[_0x47920e(0x227)]),await this[_0x47920e(0x1f9)](_0x1bc503,_0x1c8d46[_0x47920e(0x1f5)]),console[_0x47920e(0x219)](_0x47920e(0x1e9)+_0x276971+'\x20processed:\x20'+_0x1c8d46[_0x47920e(0x1f5)]),_0x1c8d46['status']===_0x47920e(0x228)?_0x49b99f[_0x47920e(0x1f4)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x1c8d46[_0x47920e(0x1e5)],'redirectUrl':_0x1bc503[_0x47920e(0x1fc)]}}):_0x49b99f[_0x47920e(0x1f5)](0x190)[_0x47920e(0x1f4)]({'success':![],'message':_0x47920e(0x1fe),'result':{'status':_0x47920e(0x1c0),'failureReason':_0x1c8d46[_0x47920e(0x227)],'redirectUrl':_0x1bc503[_0x47920e(0x1df)]}});}catch(_0x3e639d){_0x38d786(_0x3e639d);}},this[_0x39e40c(0x1db)]=new testGatewayService_1[(_0x39e40c(0x1c9))](),this[_0x39e40c(0x1ce)]=new webhookService_1['WebhookService']();}async[a13_0x108947(0x1d8)](_0x2d6f36,_0x1755c1,_0x31cd6c,_0x413124){const _0x3370f5=a13_0x108947,_0x1cbf99=Date[_0x3370f5(0x21e)]();try{const _0xe028e3=_0x2d6f36[_0x3370f5(0x212)],_0x3ef9a3=_0xe028e3[_0x3370f5(0x22b)];if(!_0x3ef9a3?.[_0x3370f5(0x1cc)]){console[_0x3370f5(0x219)](_0x3370f5(0x203)+_0xe028e3['id']);return;}const _0x4e0e00=_0x1755c1==='PAID'?_0x3370f5(0x1fb):_0x3370f5(0x20c);let _0x5839c6=[];if(_0x3ef9a3['webhookEvents'])try{_0x5839c6=Array[_0x3370f5(0x1e1)](_0x3ef9a3[_0x3370f5(0x1e2)])?_0x3ef9a3['webhookEvents']:JSON[_0x3370f5(0x205)](_0x3ef9a3[_0x3370f5(0x1e2)]);}catch(_0x5d8f2f){console[_0x3370f5(0x21d)]('Error\x20parsing\x20webhook\x20events:',_0x5d8f2f),_0x5839c6=[];}if(!_0x5839c6['includes'](_0x4e0e00)){console[_0x3370f5(0x219)]('Webhook\x20event\x20'+_0x4e0e00+'\x20not\x20enabled\x20for\x20shop\x20'+_0xe028e3['id']);return;}const _0x549a8e={'event':_0x4e0e00,'payment':{'id':_0x2d6f36['id'],'order_id':_0x2d6f36[_0x3370f5(0x229)],'gateway_order_id':_0x2d6f36[_0x3370f5(0x213)],'gateway':_0x3370f5(0x1e6),'amount':_0x2d6f36[_0x3370f5(0x1f8)],'currency':_0x2d6f36[_0x3370f5(0x1c3)],'status':_0x1755c1['toLowerCase'](),'customer_email':_0x2d6f36[_0x3370f5(0x208)],'customer_name':_0x2d6f36['customerName'],'transaction_id':_0x31cd6c,'failure_message':_0x413124,'created_at':_0x2d6f36[_0x3370f5(0x1fa)],'updated_at':new Date()}},_0x4f4f67=await fetch(_0x3ef9a3['webhookUrl'],{'method':_0x3370f5(0x21f),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x549a8e)}),_0x17fbc9=Date['now']()-_0x1cbf99;console['log'](_0x3370f5(0x214)+_0x3ef9a3[_0x3370f5(0x1cc)]+_0x3370f5(0x22c)+_0x4f4f67[_0x3370f5(0x1f5)]+'\x20('+_0x17fbc9+_0x3370f5(0x21a));}catch(_0x3c76f8){console['error'](_0x3370f5(0x1be),_0x3c76f8);}}async[a13_0x108947(0x1f9)](_0x3772a8,_0x734511){const _0x4d3a06=a13_0x108947;try{const {telegramBotService:_0x225fc5}=await Promise[_0x4d3a06(0x1ea)]()[_0x4d3a06(0x224)](()=>__importStar(require(_0x4d3a06(0x204)))),_0x5f8e1={'PAID':_0x4d3a06(0x1f0),'FAILED':_0x4d3a06(0x1c1)},_0x5f22b3=_0x5f8e1[_0x734511];if(!_0x5f22b3)return;await _0x225fc5[_0x4d3a06(0x202)](_0x3772a8[_0x4d3a06(0x1c8)],_0x3772a8,_0x5f22b3);}catch(_0x586000){console[_0x4d3a06(0x21d)](_0x4d3a06(0x1c4),_0x586000);}}}exports[a13_0x108947(0x230)]=TestGatewayController;