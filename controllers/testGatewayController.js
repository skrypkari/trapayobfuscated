'use strict';const a15_0x323d01=a15_0x50cd;(function(_0x35e934,_0x2a272f){const _0x3158f4=a15_0x50cd,_0x4e7df3=_0x35e934();while(!![]){try{const _0x3b47e5=parseInt(_0x3158f4(0xc5))/0x1*(-parseInt(_0x3158f4(0xab))/0x2)+-parseInt(_0x3158f4(0xbd))/0x3+-parseInt(_0x3158f4(0xcb))/0x4*(parseInt(_0x3158f4(0xbb))/0x5)+-parseInt(_0x3158f4(0x119))/0x6+parseInt(_0x3158f4(0xbc))/0x7+parseInt(_0x3158f4(0x113))/0x8*(-parseInt(_0x3158f4(0x115))/0x9)+-parseInt(_0x3158f4(0xb9))/0xa*(-parseInt(_0x3158f4(0xac))/0xb);if(_0x3b47e5===_0x2a272f)break;else _0x4e7df3['push'](_0x4e7df3['shift']());}catch(_0x439e06){_0x4e7df3['push'](_0x4e7df3['shift']());}}}(a15_0x4c0d,0x60cbb));function a15_0x4c0d(){const _0x4d6507=['update','body','type','writable','\x20not\x20found','parse','../config/database','amount','error','resolve','222oFsjUp','240328prbbWn','create','length','Any\x20other\x20card\x20number','failureReason','transactionId','default','log','payment','🧪\x20Test\x20Gateway\x20result:','gatewayPaymentId','name','processCardPayment','840zuviEn','PAID','5zUZvCF','1684410coLgkt','1883526samdjz','failUrl','customerName','$transaction','createdAt','includes','customerEmail','📈\x20Test\x20Gateway:\x20Payment\x20','229inOqDI',',\x20cannot\x20process','SINGLE','testGatewayService','getPaymentForm','shopId','662732xJrbJZ','call','failed','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20to\x20','../services/webhookService','paidAt','0000','processCard','gatewayOrderId','json','📈\x20Found\x20payment\x20link\x20','shop','failureMessage','sendPaymentStatusNotification','test_gateway',':\x20type=','slice','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','params','getOwnPropertyDescriptor','__esModule','Webhook\x20event\x20','PENDING','payment.success','currency','cardLast4','WebhookService','❌\x20Payment\x20link\x20','__setModuleDefault','test_gateway_','Error\x20parsing\x20webhook\x20events:','Payment\x20System/1.0\x20(Test\x20Gateway)','get','test_card','FAILED','paymentLinkId','toISOString','webhookService','paid','replace','TestGatewayController','currentPayments','__createBinding','✅\x20Payment\x20link\x20',',\x20currentPayments=','Payment\x20not\x20found','Any\x203-4\x20digits','\x20processed:\x20','toLowerCase','sendPaymentNotification','status','\x20updated:\x20currentPayments=','webhookUrl','TestGatewayService','sendShopWebhook','prototype','defineProperty','stringify','payment.failed','settings','orderId','__importDefault','\x20->\x20','✅\x20Test\x20Gateway\x20payment\x20','webhookEvents','findUnique','gateway','now','Payment\x20status\x20is\x20','ms)','POST','208UUWQEZ',',\x20status=','43434JhIoLS','Test\x20Gateway\x20webhook\x20sent\x20to\x20','cardNumber','\x20not\x20enabled\x20for\x20shop\x20','4409802ZxoVBR','\x20with\x20status\x20','paymentLink','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','COMPLETED'];a15_0x4c0d=function(){return _0x4d6507;};return a15_0x4c0d();}var __createBinding=this&&this[a15_0x323d01(0xf6)]||(Object[a15_0x323d01(0xad)]?function(_0x4684ab,_0x41d283,_0xd21ca8,_0x28e5e4){const _0xdd4478=a15_0x323d01;if(_0x28e5e4===undefined)_0x28e5e4=_0xd21ca8;var _0x18f846=Object[_0xdd4478(0xdf)](_0x41d283,_0xd21ca8);(!_0x18f846||(_0xdd4478(0xec)in _0x18f846?!_0x41d283[_0xdd4478(0xe0)]:_0x18f846[_0xdd4478(0xa4)]||_0x18f846['configurable']))&&(_0x18f846={'enumerable':!![],'get':function(){return _0x41d283[_0xd21ca8];}}),Object['defineProperty'](_0x4684ab,_0x28e5e4,_0x18f846);}:function(_0xb01da8,_0x45d6be,_0x598f20,_0x144080){if(_0x144080===undefined)_0x144080=_0x598f20;_0xb01da8[_0x144080]=_0x45d6be[_0x598f20];}),__setModuleDefault=this&&this[a15_0x323d01(0xe8)]||(Object[a15_0x323d01(0xad)]?function(_0x198557,_0x448cf8){const _0x468c7b=a15_0x323d01;Object[_0x468c7b(0x104)](_0x198557,_0x468c7b(0xb2),{'enumerable':!![],'value':_0x448cf8});}:function(_0x47081d,_0x270141){const _0x3ee36a=a15_0x323d01;_0x47081d[_0x3ee36a(0xb2)]=_0x270141;}),__importStar=this&&this['__importStar']||(function(){var _0x424ab3=function(_0x564944){return _0x424ab3=Object['getOwnPropertyNames']||function(_0x2b50ad){const _0x54f4ff=a15_0x50cd;var _0xe92d19=[];for(var _0x10605d in _0x2b50ad)if(Object[_0x54f4ff(0x103)]['hasOwnProperty'][_0x54f4ff(0xcc)](_0x2b50ad,_0x10605d))_0xe92d19[_0xe92d19[_0x54f4ff(0xae)]]=_0x10605d;return _0xe92d19;},_0x424ab3(_0x564944);};return function(_0x392d32){const _0x4db8db=a15_0x50cd;if(_0x392d32&&_0x392d32[_0x4db8db(0xe0)])return _0x392d32;var _0xa696ed={};if(_0x392d32!=null){for(var _0x3cf21d=_0x424ab3(_0x392d32),_0x46ef1b=0x0;_0x46ef1b<_0x3cf21d['length'];_0x46ef1b++)if(_0x3cf21d[_0x46ef1b]!==_0x4db8db(0xb2))__createBinding(_0xa696ed,_0x392d32,_0x3cf21d[_0x46ef1b]);}return __setModuleDefault(_0xa696ed,_0x392d32),_0xa696ed;};}()),__importDefault=this&&this[a15_0x323d01(0x109)]||function(_0x432407){return _0x432407&&_0x432407['__esModule']?_0x432407:{'default':_0x432407};};Object[a15_0x323d01(0x104)](exports,a15_0x323d01(0xe0),{'value':!![]}),exports[a15_0x323d01(0xf4)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a15_0x323d01(0xd0)),database_1=__importDefault(require(a15_0x323d01(0xa7)));function a15_0x50cd(_0x31053a,_0x53ad40){const _0x4c0db3=a15_0x4c0d();return a15_0x50cd=function(_0x50cdbf,_0x6b8937){_0x50cdbf=_0x50cdbf-0xa1;let _0x2cec34=_0x4c0db3[_0x50cdbf];return _0x2cec34;},a15_0x50cd(_0x31053a,_0x53ad40);}class TestGatewayController{constructor(){const _0x29ed0f=a15_0x323d01;this[_0x29ed0f(0xc9)]=async(_0x24ad58,_0x523df1,_0x27b38f)=>{const _0x4908ac=_0x29ed0f;try{const {paymentId:_0x26df79}=_0x24ad58[_0x4908ac(0xde)];console['log'](_0x4908ac(0xce)+_0x26df79);const _0x210b77=await database_1[_0x4908ac(0xb2)][_0x4908ac(0xb4)][_0x4908ac(0x10d)]({'where':{'id':_0x26df79},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x210b77)return _0x523df1[_0x4908ac(0xfe)](0x194)[_0x4908ac(0xd5)]({'success':![],'message':_0x4908ac(0xf9)});if(_0x210b77[_0x4908ac(0x10e)]!==_0x4908ac(0xda))return _0x523df1['status'](0x190)[_0x4908ac(0xd5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x210b77[_0x4908ac(0xfe)]!==_0x4908ac(0xe2))return _0x523df1[_0x4908ac(0xfe)](0x190)['json']({'success':![],'message':_0x4908ac(0x110)+_0x210b77['status']+_0x4908ac(0xc6)});_0x523df1[_0x4908ac(0xd5)]({'success':!![],'result':{'paymentId':_0x210b77['id'],'orderId':_0x210b77[_0x4908ac(0xd4)],'amount':_0x210b77[_0x4908ac(0xa8)],'currency':_0x210b77['currency'],'merchantName':_0x210b77[_0x4908ac(0xd7)]['name'],'description':_0x4908ac(0xcf)+_0x210b77[_0x4908ac(0xd7)][_0x4908ac(0xb7)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x4908ac(0xaf),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x4908ac(0xfa),'holderName':'Any\x20name'}}});}catch(_0x28849f){_0x27b38f(_0x28849f);}},this[_0x29ed0f(0xd3)]=async(_0xb8a881,_0x3bfbcf,_0x6b8fd4)=>{const _0x59b4c5=_0x29ed0f;try{const {paymentId:_0x37d077}=_0xb8a881[_0x59b4c5(0xde)],_0x13b6b9=_0xb8a881[_0x59b4c5(0xa2)];console[_0x59b4c5(0xb3)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x37d077);const _0x45b72c=await database_1['default'][_0x59b4c5(0xb4)][_0x59b4c5(0x10d)]({'where':{'id':_0x37d077},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x45b72c)return _0x3bfbcf[_0x59b4c5(0xfe)](0x194)[_0x59b4c5(0xd5)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x45b72c['gateway']!=='test_gateway')return _0x3bfbcf['status'](0x190)[_0x59b4c5(0xd5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x45b72c['status']!==_0x59b4c5(0xe2))return _0x3bfbcf[_0x59b4c5(0xfe)](0x190)[_0x59b4c5(0xd5)]({'success':![],'message':_0x59b4c5(0x110)+_0x45b72c[_0x59b4c5(0xfe)]+_0x59b4c5(0xc6)});const _0x403ce8=await this[_0x59b4c5(0xc8)][_0x59b4c5(0xb8)]({'paymentId':_0x45b72c['id'],'orderId':_0x45b72c[_0x59b4c5(0xd4)]||_0x45b72c['id'],'amount':_0x45b72c[_0x59b4c5(0xa8)],'currency':_0x45b72c['currency'],'cardData':_0x13b6b9});console[_0x59b4c5(0xb3)](_0x59b4c5(0xb5),_0x403ce8);const _0x2a0716={'status':_0x403ce8[_0x59b4c5(0xfe)],'updatedAt':new Date()};if(_0x403ce8[_0x59b4c5(0xfe)]==='PAID')_0x2a0716[_0x59b4c5(0xd1)]=new Date(),_0x2a0716[_0x59b4c5(0xb6)]=_0x403ce8[_0x59b4c5(0xb1)];else _0x403ce8['status']===_0x59b4c5(0xee)&&(_0x2a0716[_0x59b4c5(0xd8)]=_0x403ce8[_0x59b4c5(0xb0)]);const _0x2bdb51=_0x13b6b9[_0x59b4c5(0x117)][_0x59b4c5(0xf3)](/[\s-]/g,'');_0x2a0716[_0x59b4c5(0xe5)]=_0x2bdb51[_0x59b4c5(0xdc)](-0x4),_0x2a0716['paymentMethod']=_0x59b4c5(0xed),await database_1['default'][_0x59b4c5(0xb4)][_0x59b4c5(0xa1)]({'where':{'id':_0x45b72c['id']},'data':_0x2a0716});if(_0x403ce8['status']===_0x59b4c5(0xba)&&_0x45b72c[_0x59b4c5(0xef)]){console[_0x59b4c5(0xb3)](_0x59b4c5(0xc4)+_0x45b72c['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x59b4c5(0xb2)][_0x59b4c5(0xc0)](async _0xd96ad4=>{const _0x23a400=_0x59b4c5,_0x51b629=await _0xd96ad4[_0x23a400(0x11b)]['findUnique']({'where':{'id':_0x45b72c['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x51b629){console[_0x23a400(0xb3)](_0x23a400(0xd6)+_0x51b629['id']+_0x23a400(0xdb)+_0x51b629[_0x23a400(0xa3)]+_0x23a400(0xf8)+_0x51b629[_0x23a400(0xf5)]+',\x20status='+_0x51b629[_0x23a400(0xfe)]);const _0x16327b=_0x51b629[_0x23a400(0xf5)]+0x1,_0x7f0609=_0x51b629[_0x23a400(0xa3)]===_0x23a400(0xc7)?_0x23a400(0x11d):_0x51b629[_0x23a400(0xfe)];await _0xd96ad4[_0x23a400(0x11b)]['update']({'where':{'id':_0x45b72c[_0x23a400(0xef)]},'data':{'currentPayments':_0x16327b,'status':_0x7f0609,'updatedAt':new Date()}}),console[_0x23a400(0xb3)](_0x23a400(0xf7)+_0x51b629['id']+_0x23a400(0xff)+_0x51b629['currentPayments']+_0x23a400(0x10a)+_0x16327b+_0x23a400(0x114)+_0x51b629[_0x23a400(0xfe)]+_0x23a400(0x10a)+_0x7f0609);}else console[_0x23a400(0xb3)](_0x23a400(0xe7)+_0x45b72c[_0x23a400(0xef)]+_0x23a400(0xa5));});}catch(_0x5a31bf){console[_0x59b4c5(0xa9)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x5a31bf);}}await database_1['default']['webhookLog'][_0x59b4c5(0xad)]({'data':{'paymentId':_0x45b72c['id'],'shopId':_0x45b72c[_0x59b4c5(0xca)],'event':_0x59b4c5(0xe9)+_0x403ce8['status'][_0x59b4c5(0xfc)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x59b4c5(0xe2),'newStatus':_0x403ce8[_0x59b4c5(0xfe)],'transactionId':_0x403ce8[_0x59b4c5(0xb1)],'failureReason':_0x403ce8[_0x59b4c5(0xb0)],'processedAt':new Date()[_0x59b4c5(0xf0)]()})}}),await this[_0x59b4c5(0x102)](_0x45b72c,_0x403ce8['status'],_0x403ce8['transactionId'],_0x403ce8[_0x59b4c5(0xb0)]),await this['sendPaymentStatusNotification'](_0x45b72c,_0x403ce8[_0x59b4c5(0xfe)]),console[_0x59b4c5(0xb3)](_0x59b4c5(0x10b)+_0x37d077+_0x59b4c5(0xfb)+_0x403ce8[_0x59b4c5(0xfe)]),_0x403ce8[_0x59b4c5(0xfe)]===_0x59b4c5(0xba)?_0x3bfbcf[_0x59b4c5(0xd5)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x403ce8[_0x59b4c5(0xb1)],'redirectUrl':_0x45b72c['successUrl']}}):_0x3bfbcf[_0x59b4c5(0xfe)](0x190)[_0x59b4c5(0xd5)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x403ce8[_0x59b4c5(0xb0)],'redirectUrl':_0x45b72c[_0x59b4c5(0xbe)]}});}catch(_0x38dece){_0x6b8fd4(_0x38dece);}},this[_0x29ed0f(0xc8)]=new testGatewayService_1[(_0x29ed0f(0x101))](),this[_0x29ed0f(0xf1)]=new webhookService_1[(_0x29ed0f(0xe6))]();}async[a15_0x323d01(0x102)](_0x3b3db8,_0xa5abbe,_0x1c30fb,_0x16c946){const _0x25cba5=a15_0x323d01,_0x10d880=Date[_0x25cba5(0x10f)]();try{const _0x2dfa63=_0x3b3db8[_0x25cba5(0xd7)],_0x29fe37=_0x2dfa63[_0x25cba5(0x107)];if(!_0x29fe37?.['webhookUrl']){console[_0x25cba5(0xb3)](_0x25cba5(0xdd)+_0x2dfa63['id']);return;}const _0x2f1301=_0xa5abbe===_0x25cba5(0xba)?_0x25cba5(0xe3):_0x25cba5(0x106);let _0x48da1b=[];if(_0x29fe37[_0x25cba5(0x10c)])try{_0x48da1b=Array['isArray'](_0x29fe37['webhookEvents'])?_0x29fe37[_0x25cba5(0x10c)]:JSON[_0x25cba5(0xa6)](_0x29fe37['webhookEvents']);}catch(_0x350a19){console[_0x25cba5(0xa9)](_0x25cba5(0xea),_0x350a19),_0x48da1b=[];}if(!_0x48da1b[_0x25cba5(0xc2)](_0x2f1301)){console[_0x25cba5(0xb3)](_0x25cba5(0xe1)+_0x2f1301+_0x25cba5(0x118)+_0x2dfa63['id']);return;}const _0x2f56c8={'event':_0x2f1301,'payment':{'id':_0x3b3db8['id'],'order_id':_0x3b3db8[_0x25cba5(0x108)],'gateway_order_id':_0x3b3db8[_0x25cba5(0xd4)],'gateway':_0x25cba5(0xd2),'amount':_0x3b3db8[_0x25cba5(0xa8)],'currency':_0x3b3db8[_0x25cba5(0xe4)],'status':_0xa5abbe['toLowerCase'](),'customer_email':_0x3b3db8[_0x25cba5(0xc3)],'customer_name':_0x3b3db8[_0x25cba5(0xbf)],'transaction_id':_0x1c30fb,'failure_message':_0x16c946,'created_at':_0x3b3db8[_0x25cba5(0xc1)],'updated_at':new Date()}},_0x28cbd4=await fetch(_0x29fe37[_0x25cba5(0x100)],{'method':_0x25cba5(0x112),'headers':{'Content-Type':'application/json','User-Agent':_0x25cba5(0xeb)},'body':JSON[_0x25cba5(0x105)](_0x2f56c8)}),_0x3cb498=Date[_0x25cba5(0x10f)]()-_0x10d880;console[_0x25cba5(0xb3)](_0x25cba5(0x116)+_0x29fe37[_0x25cba5(0x100)]+_0x25cba5(0x11a)+_0x28cbd4[_0x25cba5(0xfe)]+'\x20('+_0x3cb498+_0x25cba5(0x111));}catch(_0x4a8857){console[_0x25cba5(0xa9)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x4a8857);}}async[a15_0x323d01(0xd9)](_0x53e5c3,_0xb56d97){const _0x499a00=a15_0x323d01;try{const {telegramBotService:_0x6debaf}=await Promise[_0x499a00(0xaa)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0xe521e1={'PAID':_0x499a00(0xf2),'FAILED':_0x499a00(0xcd)},_0x4d54ea=_0xe521e1[_0xb56d97];if(!_0x4d54ea)return;await _0x6debaf[_0x499a00(0xfd)](_0x53e5c3[_0x499a00(0xca)],_0x53e5c3,_0x4d54ea);}catch(_0x2049e0){console[_0x499a00(0xa9)](_0x499a00(0x11c),_0x2049e0);}}}exports[a15_0x323d01(0xf4)]=TestGatewayController;