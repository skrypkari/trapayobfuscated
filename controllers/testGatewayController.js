'use strict';const a13_0xa169ca=a13_0x5bba;(function(_0x443c05,_0x28ddbf){const _0x595c83=a13_0x5bba,_0x309d4e=_0x443c05();while(!![]){try{const _0x7f365d=-parseInt(_0x595c83(0x171))/0x1*(-parseInt(_0x595c83(0x16c))/0x2)+parseInt(_0x595c83(0x149))/0x3*(parseInt(_0x595c83(0x17f))/0x4)+-parseInt(_0x595c83(0x16b))/0x5+parseInt(_0x595c83(0x126))/0x6*(parseInt(_0x595c83(0x128))/0x7)+-parseInt(_0x595c83(0x140))/0x8*(-parseInt(_0x595c83(0x170))/0x9)+-parseInt(_0x595c83(0x15d))/0xa+parseInt(_0x595c83(0x135))/0xb*(-parseInt(_0x595c83(0x169))/0xc);if(_0x7f365d===_0x28ddbf)break;else _0x309d4e['push'](_0x309d4e['shift']());}catch(_0x44ee81){_0x309d4e['push'](_0x309d4e['shift']());}}}(a13_0x3ad5,0xa1a3f));var __createBinding=this&&this[a13_0xa169ca(0x160)]||(Object[a13_0xa169ca(0x167)]?function(_0x5ef80f,_0x3cccd3,_0x40575c,_0x364ce0){const _0x2b1371=a13_0xa169ca;if(_0x364ce0===undefined)_0x364ce0=_0x40575c;var _0x3facc8=Object[_0x2b1371(0x180)](_0x3cccd3,_0x40575c);(!_0x3facc8||('get'in _0x3facc8?!_0x3cccd3[_0x2b1371(0x148)]:_0x3facc8['writable']||_0x3facc8[_0x2b1371(0x11f)]))&&(_0x3facc8={'enumerable':!![],'get':function(){return _0x3cccd3[_0x40575c];}}),Object['defineProperty'](_0x5ef80f,_0x364ce0,_0x3facc8);}:function(_0x277c69,_0x205efe,_0x51ebd6,_0x410c8a){if(_0x410c8a===undefined)_0x410c8a=_0x51ebd6;_0x277c69[_0x410c8a]=_0x205efe[_0x51ebd6];}),__setModuleDefault=this&&this[a13_0xa169ca(0x181)]||(Object[a13_0xa169ca(0x167)]?function(_0x224564,_0x1460af){const _0x20600=a13_0xa169ca;Object[_0x20600(0x121)](_0x224564,'default',{'enumerable':!![],'value':_0x1460af});}:function(_0x19a720,_0x18264c){const _0x3edd9d=a13_0xa169ca;_0x19a720[_0x3edd9d(0x11e)]=_0x18264c;}),__importStar=this&&this['__importStar']||(function(){var _0x35a11c=function(_0x4e8fc5){const _0x2d5a94=a13_0x5bba;return _0x35a11c=Object[_0x2d5a94(0x159)]||function(_0x15e4c3){const _0x2714bb=_0x2d5a94;var _0x8f21f7=[];for(var _0x36b77a in _0x15e4c3)if(Object['prototype'][_0x2714bb(0x179)][_0x2714bb(0x14e)](_0x15e4c3,_0x36b77a))_0x8f21f7[_0x8f21f7[_0x2714bb(0x11c)]]=_0x36b77a;return _0x8f21f7;},_0x35a11c(_0x4e8fc5);};return function(_0x11cda7){const _0x158684=a13_0x5bba;if(_0x11cda7&&_0x11cda7['__esModule'])return _0x11cda7;var _0x46d888={};if(_0x11cda7!=null){for(var _0x4344a9=_0x35a11c(_0x11cda7),_0x3d0fe6=0x0;_0x3d0fe6<_0x4344a9['length'];_0x3d0fe6++)if(_0x4344a9[_0x3d0fe6]!==_0x158684(0x11e))__createBinding(_0x46d888,_0x11cda7,_0x4344a9[_0x3d0fe6]);}return __setModuleDefault(_0x46d888,_0x11cda7),_0x46d888;};}()),__importDefault=this&&this[a13_0xa169ca(0x151)]||function(_0x5a6aba){const _0x214129=a13_0xa169ca;return _0x5a6aba&&_0x5a6aba[_0x214129(0x148)]?_0x5a6aba:{'default':_0x5a6aba};};function a13_0x5bba(_0x2f3a29,_0x24dfa2){const _0x3ad5c5=a13_0x3ad5();return a13_0x5bba=function(_0x5bba41,_0x5f115d){_0x5bba41=_0x5bba41-0x11b;let _0x53ea81=_0x3ad5c5[_0x5bba41];return _0x53ea81;},a13_0x5bba(_0x2f3a29,_0x24dfa2);}function a13_0x3ad5(){const _0x18e2be=['TestGatewayController','toLowerCase','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','failUrl','failureMessage','getOwnPropertyNames','../services/gateways/testGatewayService','âœ…\x20Test\x20Gateway\x20payment\x20','PAID','1026160XDAeeT','error','TestGatewayService','__createBinding','transactionId','resolve','Payment\x20failed','WebhookService',',\x20cannot\x20process','cardLast4','create','customerName','506112idQArv','getPaymentForm','1010100mNSuaR','371896wZybKD','4242\x204242\x204242\x204242','\x20processed:\x20','PENDING','1016343BwjLJc','2zsdZgN','ms)','name','cardNumber','FAILED','paid','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20with\x20status\x20','hasOwnProperty','payment','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','customerEmail','321364fXXIzF','getOwnPropertyDescriptor','__setModuleDefault','stringify','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failureReason','params','toISOString','parse','length','findUnique','default','configurable','Any\x20other\x20card\x20number','defineProperty','amount','settings','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','isArray','6csFuJG','currency','2867011DZVwmY','sendPaymentStatusNotification','gateway','webhookLog','successUrl','Payment\x20not\x20found','../services/telegramBotService','shopId','Payment\x20processed\x20successfully','failed','sendPaymentNotification','webhookEvents','test_card','44WTkgBh','testGatewayService','Payment\x20to\x20','Any\x20future\x20date\x20(MM/YY)','shop','body','now','log','gatewayOrderId','slice','status','8RqMBlJ','includes','json','Any\x20name','Any\x203-4\x20digits','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','then','paidAt','__esModule','9pPypiQ','replace','Payment\x20status\x20is\x20','Webhook\x20event\x20','sendShopWebhook','call','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','__importDefault','paymentMethod','webhookUrl'];a13_0x3ad5=function(){return _0x18e2be;};return a13_0x3ad5();}Object[a13_0xa169ca(0x121)](exports,a13_0xa169ca(0x148),{'value':!![]}),exports[a13_0xa169ca(0x154)]=void 0x0;const testGatewayService_1=require(a13_0xa169ca(0x15a)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0xa7098d=a13_0xa169ca;this[_0xa7098d(0x16a)]=async(_0x299210,_0x1f76f7,_0x3e4bd4)=>{const _0x1d0102=_0xa7098d;try{const {paymentId:_0x529e09}=_0x299210[_0x1d0102(0x185)];console[_0x1d0102(0x13c)](_0x1d0102(0x145)+_0x529e09);const _0x560a4b=await database_1[_0x1d0102(0x11e)][_0x1d0102(0x17a)][_0x1d0102(0x11d)]({'where':{'id':_0x529e09},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x560a4b)return _0x1f76f7[_0x1d0102(0x13f)](0x194)[_0x1d0102(0x142)]({'success':![],'message':_0x1d0102(0x12d)});if(_0x560a4b['gateway']!=='test_gateway')return _0x1f76f7['status'](0x190)['json']({'success':![],'message':_0x1d0102(0x17c)});if(_0x560a4b['status']!==_0x1d0102(0x16f))return _0x1f76f7[_0x1d0102(0x13f)](0x190)[_0x1d0102(0x142)]({'success':![],'message':_0x1d0102(0x14b)+_0x560a4b['status']+_0x1d0102(0x165)});_0x1f76f7['json']({'success':!![],'result':{'paymentId':_0x560a4b['id'],'orderId':_0x560a4b[_0x1d0102(0x13d)],'amount':_0x560a4b[_0x1d0102(0x122)],'currency':_0x560a4b[_0x1d0102(0x127)],'merchantName':_0x560a4b['shop'][_0x1d0102(0x173)],'description':_0x1d0102(0x137)+_0x560a4b['shop'][_0x1d0102(0x173)],'testInstructions':{'successCard':_0x1d0102(0x16d),'failureCard':_0x1d0102(0x120),'expiryDate':_0x1d0102(0x138),'cvc':_0x1d0102(0x144),'holderName':_0x1d0102(0x143)}}});}catch(_0x1d2cdb){_0x3e4bd4(_0x1d2cdb);}},this['processCard']=async(_0x39a519,_0x1da8b0,_0x30e2eb)=>{const _0x3c5a6c=_0xa7098d;try{const {paymentId:_0x11c023}=_0x39a519[_0x3c5a6c(0x185)],_0x173674=_0x39a519[_0x3c5a6c(0x13a)];console[_0x3c5a6c(0x13c)](_0x3c5a6c(0x17d)+_0x11c023);const _0x3ea977=await database_1[_0x3c5a6c(0x11e)][_0x3c5a6c(0x17a)][_0x3c5a6c(0x11d)]({'where':{'id':_0x11c023},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ea977)return _0x1da8b0[_0x3c5a6c(0x13f)](0x194)[_0x3c5a6c(0x142)]({'success':![],'message':_0x3c5a6c(0x12d)});if(_0x3ea977[_0x3c5a6c(0x12a)]!=='test_gateway')return _0x1da8b0[_0x3c5a6c(0x13f)](0x190)[_0x3c5a6c(0x142)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3ea977['status']!=='PENDING')return _0x1da8b0[_0x3c5a6c(0x13f)](0x190)['json']({'success':![],'message':_0x3c5a6c(0x14b)+_0x3ea977[_0x3c5a6c(0x13f)]+_0x3c5a6c(0x165)});const _0x3b6665=await this[_0x3c5a6c(0x136)]['processCardPayment']({'paymentId':_0x3ea977['id'],'orderId':_0x3ea977['gatewayOrderId']||_0x3ea977['id'],'amount':_0x3ea977[_0x3c5a6c(0x122)],'currency':_0x3ea977['currency'],'cardData':_0x173674});console['log'](_0x3c5a6c(0x177),_0x3b6665);const _0x244f22={'status':_0x3b6665['status'],'updatedAt':new Date()};if(_0x3b6665['status']===_0x3c5a6c(0x15c))_0x244f22[_0x3c5a6c(0x147)]=new Date(),_0x244f22['gatewayPaymentId']=_0x3b6665[_0x3c5a6c(0x161)];else _0x3b6665['status']===_0x3c5a6c(0x175)&&(_0x244f22[_0x3c5a6c(0x158)]=_0x3b6665['failureReason']);const _0x5c2331=_0x173674[_0x3c5a6c(0x174)][_0x3c5a6c(0x14a)](/[\s-]/g,'');_0x244f22[_0x3c5a6c(0x166)]=_0x5c2331[_0x3c5a6c(0x13e)](-0x4),_0x244f22[_0x3c5a6c(0x152)]=_0x3c5a6c(0x134),await database_1[_0x3c5a6c(0x11e)][_0x3c5a6c(0x17a)]['update']({'where':{'id':_0x3ea977['id']},'data':_0x244f22}),await database_1[_0x3c5a6c(0x11e)][_0x3c5a6c(0x12b)][_0x3c5a6c(0x167)]({'data':{'paymentId':_0x3ea977['id'],'shopId':_0x3ea977[_0x3c5a6c(0x12f)],'event':'test_gateway_'+_0x3b6665[_0x3c5a6c(0x13f)][_0x3c5a6c(0x155)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3c5a6c(0x16f),'newStatus':_0x3b6665[_0x3c5a6c(0x13f)],'transactionId':_0x3b6665[_0x3c5a6c(0x161)],'failureReason':_0x3b6665[_0x3c5a6c(0x184)],'processedAt':new Date()[_0x3c5a6c(0x186)]()})}}),await this[_0x3c5a6c(0x14d)](_0x3ea977,_0x3b6665[_0x3c5a6c(0x13f)],_0x3b6665[_0x3c5a6c(0x161)],_0x3b6665[_0x3c5a6c(0x184)]),await this[_0x3c5a6c(0x129)](_0x3ea977,_0x3b6665[_0x3c5a6c(0x13f)]),console[_0x3c5a6c(0x13c)](_0x3c5a6c(0x15b)+_0x11c023+_0x3c5a6c(0x16e)+_0x3b6665[_0x3c5a6c(0x13f)]),_0x3b6665[_0x3c5a6c(0x13f)]===_0x3c5a6c(0x15c)?_0x1da8b0[_0x3c5a6c(0x142)]({'success':!![],'message':_0x3c5a6c(0x130),'result':{'status':'PAID','transactionId':_0x3b6665[_0x3c5a6c(0x161)],'redirectUrl':_0x3ea977[_0x3c5a6c(0x12c)]}}):_0x1da8b0[_0x3c5a6c(0x13f)](0x190)['json']({'success':![],'message':_0x3c5a6c(0x163),'result':{'status':_0x3c5a6c(0x175),'failureReason':_0x3b6665[_0x3c5a6c(0x184)],'redirectUrl':_0x3ea977[_0x3c5a6c(0x157)]}});}catch(_0x59e617){_0x30e2eb(_0x59e617);}},this[_0xa7098d(0x136)]=new testGatewayService_1[(_0xa7098d(0x15f))](),this['webhookService']=new webhookService_1[(_0xa7098d(0x164))]();}async[a13_0xa169ca(0x14d)](_0x36884c,_0x288bdd,_0xb33e70,_0x2bffac){const _0x1d963d=a13_0xa169ca,_0x293fd0=Date[_0x1d963d(0x13b)]();try{const _0x29b890=_0x36884c[_0x1d963d(0x139)],_0x37e5eb=_0x29b890[_0x1d963d(0x123)];if(!_0x37e5eb?.[_0x1d963d(0x153)]){console[_0x1d963d(0x13c)](_0x1d963d(0x14f)+_0x29b890['id']);return;}const _0x34f1de=_0x288bdd==='PAID'?'payment.success':'payment.failed';let _0x3d59af=[];if(_0x37e5eb[_0x1d963d(0x133)])try{_0x3d59af=Array[_0x1d963d(0x125)](_0x37e5eb[_0x1d963d(0x133)])?_0x37e5eb[_0x1d963d(0x133)]:JSON[_0x1d963d(0x11b)](_0x37e5eb['webhookEvents']);}catch(_0xf5444b){console[_0x1d963d(0x15e)](_0x1d963d(0x150),_0xf5444b),_0x3d59af=[];}if(!_0x3d59af[_0x1d963d(0x141)](_0x34f1de)){console['log'](_0x1d963d(0x14c)+_0x34f1de+_0x1d963d(0x17b)+_0x29b890['id']);return;}const _0x2dc627={'event':_0x34f1de,'payment':{'id':_0x36884c['id'],'order_id':_0x36884c['orderId'],'gateway_order_id':_0x36884c[_0x1d963d(0x13d)],'gateway':'0000','amount':_0x36884c[_0x1d963d(0x122)],'currency':_0x36884c['currency'],'status':_0x288bdd['toLowerCase'](),'customer_email':_0x36884c[_0x1d963d(0x17e)],'customer_name':_0x36884c[_0x1d963d(0x168)],'transaction_id':_0xb33e70,'failure_message':_0x2bffac,'created_at':_0x36884c['createdAt'],'updated_at':new Date()}},_0x5b080a=await fetch(_0x37e5eb[_0x1d963d(0x153)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x1d963d(0x156)},'body':JSON[_0x1d963d(0x182)](_0x2dc627)}),_0x51400b=Date['now']()-_0x293fd0;console['log'](_0x1d963d(0x183)+_0x37e5eb[_0x1d963d(0x153)]+_0x1d963d(0x178)+_0x5b080a['status']+'\x20('+_0x51400b+_0x1d963d(0x172));}catch(_0x29e1fb){console[_0x1d963d(0x15e)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x29e1fb);}}async[a13_0xa169ca(0x129)](_0x4aa90c,_0x1cf366){const _0x4a8f5f=a13_0xa169ca;try{const {telegramBotService:_0x2f041f}=await Promise[_0x4a8f5f(0x162)]()[_0x4a8f5f(0x146)](()=>__importStar(require(_0x4a8f5f(0x12e)))),_0x9e3b5e={'PAID':_0x4a8f5f(0x176),'FAILED':_0x4a8f5f(0x131)},_0x32a2fd=_0x9e3b5e[_0x1cf366];if(!_0x32a2fd)return;await _0x2f041f[_0x4a8f5f(0x132)](_0x4aa90c[_0x4a8f5f(0x12f)],_0x4aa90c,_0x32a2fd);}catch(_0x28ec30){console[_0x4a8f5f(0x15e)](_0x4a8f5f(0x124),_0x28ec30);}}}exports[a13_0xa169ca(0x154)]=TestGatewayController;