'use strict';const a13_0x2e38db=a13_0x1dfc;(function(_0xb16391,_0x5e9851){const _0x501ba2=a13_0x1dfc,_0x2b0098=_0xb16391();while(!![]){try{const _0x46c0fa=-parseInt(_0x501ba2(0xa9))/0x1*(-parseInt(_0x501ba2(0xc5))/0x2)+-parseInt(_0x501ba2(0xa2))/0x3+-parseInt(_0x501ba2(0xaa))/0x4+-parseInt(_0x501ba2(0xe4))/0x5*(parseInt(_0x501ba2(0xd8))/0x6)+-parseInt(_0x501ba2(0x87))/0x7+parseInt(_0x501ba2(0xbd))/0x8*(-parseInt(_0x501ba2(0xde))/0x9)+parseInt(_0x501ba2(0xed))/0xa;if(_0x46c0fa===_0x5e9851)break;else _0x2b0098['push'](_0x2b0098['shift']());}catch(_0x4b97ed){_0x2b0098['push'](_0x2b0098['shift']());}}}(a13_0x3a78,0x8ed91));var __createBinding=this&&this[a13_0x2e38db(0x79)]||(Object[a13_0x2e38db(0xeb)]?function(_0x5299d9,_0x2d41aa,_0x4255c7,_0x28a22b){const _0x3bcfd7=a13_0x2e38db;if(_0x28a22b===undefined)_0x28a22b=_0x4255c7;var _0x83d6fc=Object['getOwnPropertyDescriptor'](_0x2d41aa,_0x4255c7);(!_0x83d6fc||(_0x3bcfd7(0xb1)in _0x83d6fc?!_0x2d41aa[_0x3bcfd7(0x89)]:_0x83d6fc[_0x3bcfd7(0xf2)]||_0x83d6fc['configurable']))&&(_0x83d6fc={'enumerable':!![],'get':function(){return _0x2d41aa[_0x4255c7];}}),Object[_0x3bcfd7(0x88)](_0x5299d9,_0x28a22b,_0x83d6fc);}:function(_0x785f6,_0x46e247,_0x356381,_0x357106){if(_0x357106===undefined)_0x357106=_0x356381;_0x785f6[_0x357106]=_0x46e247[_0x356381];}),__setModuleDefault=this&&this[a13_0x2e38db(0x9b)]||(Object[a13_0x2e38db(0xeb)]?function(_0x3a76e7,_0x38c934){Object['defineProperty'](_0x3a76e7,'default',{'enumerable':!![],'value':_0x38c934});}:function(_0x4544a2,_0x2db79){_0x4544a2['default']=_0x2db79;}),__importStar=this&&this[a13_0x2e38db(0xd7)]||(function(){var _0x5ce4bf=function(_0x241c5c){return _0x5ce4bf=Object['getOwnPropertyNames']||function(_0x31a7c3){const _0x3bcc48=a13_0x1dfc;var _0x19b303=[];for(var _0x36c1d7 in _0x31a7c3)if(Object[_0x3bcc48(0xe1)][_0x3bcc48(0xc8)]['call'](_0x31a7c3,_0x36c1d7))_0x19b303[_0x19b303['length']]=_0x36c1d7;return _0x19b303;},_0x5ce4bf(_0x241c5c);};return function(_0x153e20){const _0x2f27d6=a13_0x1dfc;if(_0x153e20&&_0x153e20[_0x2f27d6(0x89)])return _0x153e20;var _0x4f830a={};if(_0x153e20!=null){for(var _0x4eda91=_0x5ce4bf(_0x153e20),_0x57ad3d=0x0;_0x57ad3d<_0x4eda91['length'];_0x57ad3d++)if(_0x4eda91[_0x57ad3d]!==_0x2f27d6(0xef))__createBinding(_0x4f830a,_0x153e20,_0x4eda91[_0x57ad3d]);}return __setModuleDefault(_0x4f830a,_0x153e20),_0x4f830a;};}()),__importDefault=this&&this[a13_0x2e38db(0xf0)]||function(_0x4e315b){return _0x4e315b&&_0x4e315b['__esModule']?_0x4e315b:{'default':_0x4e315b};};Object[a13_0x2e38db(0x88)](exports,a13_0x2e38db(0x89),{'value':!![]}),exports[a13_0x2e38db(0x82)]=void 0x0;const testGatewayService_1=require(a13_0x2e38db(0xe2)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x2e38db(0x8a)));class TestGatewayController{constructor(){const _0x226770=a13_0x2e38db;this[_0x226770(0xc7)]=async(_0x51b507,_0x59c1a7,_0x5046c2)=>{const _0x587dcd=_0x226770;try{const {paymentId:_0x551fbb}=_0x51b507[_0x587dcd(0xd5)];console[_0x587dcd(0xae)](_0x587dcd(0xa4)+_0x551fbb);const _0x378c71=await database_1[_0x587dcd(0xef)]['payment']['findUnique']({'where':{'id':_0x551fbb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x378c71)return _0x59c1a7['status'](0x194)['json']({'success':![],'message':_0x587dcd(0x92)});if(_0x378c71['gateway']!==_0x587dcd(0x81))return _0x59c1a7[_0x587dcd(0x8f)](0x190)[_0x587dcd(0xc6)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x378c71[_0x587dcd(0x8f)]!==_0x587dcd(0x7e))return _0x59c1a7[_0x587dcd(0x8f)](0x190)[_0x587dcd(0xc6)]({'success':![],'message':_0x587dcd(0xea)+_0x378c71['status']+',\x20cannot\x20process'});_0x59c1a7[_0x587dcd(0xc6)]({'success':!![],'result':{'paymentId':_0x378c71['id'],'orderId':_0x378c71['gatewayOrderId'],'amount':_0x378c71[_0x587dcd(0xa0)],'currency':_0x378c71[_0x587dcd(0xc9)],'merchantName':_0x378c71[_0x587dcd(0xaf)][_0x587dcd(0xa1)],'description':_0x587dcd(0x8e)+_0x378c71[_0x587dcd(0xaf)][_0x587dcd(0xa1)],'testInstructions':{'successCard':_0x587dcd(0xb7),'failureCard':_0x587dcd(0xc0),'expiryDate':_0x587dcd(0x9a),'cvc':_0x587dcd(0xbc),'holderName':_0x587dcd(0xa3)}}});}catch(_0x5e926f){_0x5046c2(_0x5e926f);}},this[_0x226770(0x91)]=async(_0x916dd5,_0x7cb7b4,_0x3f1254)=>{const _0x5db47f=_0x226770;try{const {paymentId:_0x1c9b2b}=_0x916dd5[_0x5db47f(0xd5)],_0x4ad40b=_0x916dd5[_0x5db47f(0xe5)];console[_0x5db47f(0xae)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1c9b2b);const _0xf5ab94=await database_1['default']['payment'][_0x5db47f(0x84)]({'where':{'id':_0x1c9b2b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xf5ab94)return _0x7cb7b4[_0x5db47f(0x8f)](0x194)[_0x5db47f(0xc6)]({'success':![],'message':_0x5db47f(0x92)});if(_0xf5ab94[_0x5db47f(0xcb)]!=='test_gateway')return _0x7cb7b4[_0x5db47f(0x8f)](0x190)['json']({'success':![],'message':_0x5db47f(0x96)});if(_0xf5ab94[_0x5db47f(0x8f)]!==_0x5db47f(0x7e))return _0x7cb7b4['status'](0x190)['json']({'success':![],'message':_0x5db47f(0xea)+_0xf5ab94[_0x5db47f(0x8f)]+_0x5db47f(0xdc)});const _0x4ad3b7=await this[_0x5db47f(0x7c)][_0x5db47f(0xcf)]({'paymentId':_0xf5ab94['id'],'orderId':_0xf5ab94[_0x5db47f(0xec)]||_0xf5ab94['id'],'amount':_0xf5ab94[_0x5db47f(0xa0)],'currency':_0xf5ab94[_0x5db47f(0xc9)],'cardData':_0x4ad40b});console['log'](_0x5db47f(0x7f),_0x4ad3b7);const _0x5773fe={'status':_0x4ad3b7['status'],'updatedAt':new Date()};if(_0x4ad3b7[_0x5db47f(0x8f)]===_0x5db47f(0xb2))_0x5773fe['paidAt']=new Date(),_0x5773fe[_0x5db47f(0xbf)]=_0x4ad3b7[_0x5db47f(0xd3)];else _0x4ad3b7[_0x5db47f(0x8f)]===_0x5db47f(0xad)&&(_0x5773fe['failureMessage']=_0x4ad3b7[_0x5db47f(0xc2)]);const _0x4c8d1d=_0x4ad40b[_0x5db47f(0xdb)][_0x5db47f(0xca)](/[\s-]/g,'');_0x5773fe[_0x5db47f(0x7b)]=_0x4c8d1d[_0x5db47f(0xe7)](-0x4),_0x5773fe['paymentMethod']=_0x5db47f(0x9d),await database_1[_0x5db47f(0xef)][_0x5db47f(0x99)][_0x5db47f(0x83)]({'where':{'id':_0xf5ab94['id']},'data':_0x5773fe});if(_0x4ad3b7[_0x5db47f(0x8f)]===_0x5db47f(0xb2)&&_0xf5ab94[_0x5db47f(0xe9)]){console[_0x5db47f(0xae)](_0x5db47f(0x93)+_0xf5ab94['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x5db47f(0xef)][_0x5db47f(0x8d)](async _0x490218=>{const _0x213002=_0x5db47f,_0x3ca15b=await _0x490218[_0x213002(0xa8)][_0x213002(0x84)]({'where':{'id':_0xf5ab94['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3ca15b){console[_0x213002(0xae)](_0x213002(0xcc)+_0x3ca15b['id']+_0x213002(0xa7)+_0x3ca15b['type']+_0x213002(0x8b)+_0x3ca15b[_0x213002(0x86)]+_0x213002(0xb9)+_0x3ca15b[_0x213002(0x8f)]);const _0x754dc1=_0x3ca15b['currentPayments']+0x1,_0x5cae23=_0x3ca15b['type']===_0x213002(0xbb)?_0x213002(0xf1):_0x3ca15b[_0x213002(0x8f)];await _0x490218[_0x213002(0xa8)]['update']({'where':{'id':_0xf5ab94[_0x213002(0xe9)]},'data':{'currentPayments':_0x754dc1,'status':_0x5cae23,'updatedAt':new Date()}}),console[_0x213002(0xae)](_0x213002(0xba)+_0x3ca15b['id']+_0x213002(0x9c)+_0x3ca15b['currentPayments']+_0x213002(0xe6)+_0x754dc1+_0x213002(0xb9)+_0x3ca15b[_0x213002(0x8f)]+_0x213002(0xe6)+_0x5cae23);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0xf5ab94[_0x213002(0xe9)]+'\x20not\x20found');});}catch(_0x12a34e){console['error'](_0x5db47f(0x80),_0x12a34e);}}await database_1[_0x5db47f(0xef)][_0x5db47f(0x7d)]['create']({'data':{'paymentId':_0xf5ab94['id'],'shopId':_0xf5ab94[_0x5db47f(0xb5)],'event':_0x5db47f(0xd4)+_0x4ad3b7[_0x5db47f(0x8f)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5db47f(0x90)]({'oldStatus':'PENDING','newStatus':_0x4ad3b7[_0x5db47f(0x8f)],'transactionId':_0x4ad3b7[_0x5db47f(0xd3)],'failureReason':_0x4ad3b7[_0x5db47f(0xc2)],'processedAt':new Date()[_0x5db47f(0xee)]()})}}),await this[_0x5db47f(0x85)](_0xf5ab94,_0x4ad3b7[_0x5db47f(0x8f)],_0x4ad3b7[_0x5db47f(0xd3)],_0x4ad3b7[_0x5db47f(0xc2)]),await this['sendPaymentStatusNotification'](_0xf5ab94,_0x4ad3b7[_0x5db47f(0x8f)]),console[_0x5db47f(0xae)](_0x5db47f(0xd9)+_0x1c9b2b+_0x5db47f(0xdd)+_0x4ad3b7[_0x5db47f(0x8f)]),_0x4ad3b7[_0x5db47f(0x8f)]==='PAID'?_0x7cb7b4[_0x5db47f(0xc6)]({'success':!![],'message':_0x5db47f(0x95),'result':{'status':_0x5db47f(0xb2),'transactionId':_0x4ad3b7[_0x5db47f(0xd3)],'redirectUrl':_0xf5ab94['successUrl']}}):_0x7cb7b4['status'](0x190)['json']({'success':![],'message':_0x5db47f(0xce),'result':{'status':_0x5db47f(0xad),'failureReason':_0x4ad3b7[_0x5db47f(0xc2)],'redirectUrl':_0xf5ab94['failUrl']}});}catch(_0x23d91f){_0x3f1254(_0x23d91f);}},this[_0x226770(0x7c)]=new testGatewayService_1[(_0x226770(0xda))](),this[_0x226770(0x9e)]=new webhookService_1['WebhookService']();}async[a13_0x2e38db(0x85)](_0x10283a,_0x466cb4,_0x376ccc,_0x9a0e22){const _0xd1e615=a13_0x2e38db,_0x3e148a=Date['now']();try{const _0x381c31=_0x10283a[_0xd1e615(0xaf)],_0x3fad47=_0x381c31[_0xd1e615(0xcd)];if(!_0x3fad47?.[_0xd1e615(0x94)]){console[_0xd1e615(0xae)](_0xd1e615(0x98)+_0x381c31['id']);return;}const _0x51e9e0=_0x466cb4==='PAID'?'payment.success':'payment.failed';let _0x36f157=[];if(_0x3fad47[_0xd1e615(0xdf)])try{_0x36f157=Array['isArray'](_0x3fad47[_0xd1e615(0xdf)])?_0x3fad47[_0xd1e615(0xdf)]:JSON[_0xd1e615(0xd2)](_0x3fad47['webhookEvents']);}catch(_0x208cb7){console[_0xd1e615(0xb0)](_0xd1e615(0xb3),_0x208cb7),_0x36f157=[];}if(!_0x36f157[_0xd1e615(0xb6)](_0x51e9e0)){console[_0xd1e615(0xae)](_0xd1e615(0xf3)+_0x51e9e0+_0xd1e615(0xd6)+_0x381c31['id']);return;}const _0xc90212={'event':_0x51e9e0,'payment':{'id':_0x10283a['id'],'order_id':_0x10283a[_0xd1e615(0xc3)],'gateway_order_id':_0x10283a[_0xd1e615(0xec)],'gateway':_0xd1e615(0xab),'amount':_0x10283a[_0xd1e615(0xa0)],'currency':_0x10283a[_0xd1e615(0xc9)],'status':_0x466cb4[_0xd1e615(0xb8)](),'customer_email':_0x10283a[_0xd1e615(0xe8)],'customer_name':_0x10283a[_0xd1e615(0x97)],'transaction_id':_0x376ccc,'failure_message':_0x9a0e22,'created_at':_0x10283a['createdAt'],'updated_at':new Date()}},_0x38591f=await fetch(_0x3fad47['webhookUrl'],{'method':_0xd1e615(0xb4),'headers':{'Content-Type':_0xd1e615(0xc4),'User-Agent':_0xd1e615(0xe0)},'body':JSON['stringify'](_0xc90212)}),_0x3f7298=Date[_0xd1e615(0xac)]()-_0x3e148a;console['log'](_0xd1e615(0xd0)+_0x3fad47['webhookUrl']+'\x20with\x20status\x20'+_0x38591f['status']+'\x20('+_0x3f7298+_0xd1e615(0x7a));}catch(_0x51c0fb){console[_0xd1e615(0xb0)](_0xd1e615(0x8c),_0x51c0fb);}}async[a13_0x2e38db(0xc1)](_0x5031e3,_0x425d8e){const _0x52ca03=a13_0x2e38db;try{const {telegramBotService:_0x3cc3cf}=await Promise[_0x52ca03(0x9f)]()[_0x52ca03(0xa5)](()=>__importStar(require(_0x52ca03(0xe3)))),_0x10b645={'PAID':'paid','FAILED':_0x52ca03(0xbe)},_0x291260=_0x10b645[_0x425d8e];if(!_0x291260)return;await _0x3cc3cf[_0x52ca03(0xa6)](_0x5031e3[_0x52ca03(0xb5)],_0x5031e3,_0x291260);}catch(_0x27bfd0){console[_0x52ca03(0xb0)](_0x52ca03(0xd1),_0x27bfd0);}}}exports[a13_0x2e38db(0x82)]=TestGatewayController;function a13_0x1dfc(_0x1cbac,_0x124ab7){const _0x3a7813=a13_0x3a78();return a13_0x1dfc=function(_0x1dfc85,_0x585f8d){_0x1dfc85=_0x1dfc85-0x79;let _0x345b25=_0x3a7813[_0x1dfc85];return _0x345b25;},a13_0x1dfc(_0x1cbac,_0x124ab7);}function a13_0x3a78(){const _0x804642=['test_gateway','TestGatewayController','update','findUnique','sendShopWebhook','currentPayments','5530637bEwTVf','defineProperty','__esModule','../config/database',',\x20currentPayments=','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','$transaction','Payment\x20to\x20','status','stringify','processCard','Payment\x20not\x20found','üìà\x20Test\x20Gateway:\x20Payment\x20','webhookUrl','Payment\x20processed\x20successfully','Payment\x20is\x20not\x20for\x20test\x20gateway','customerName','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment','Any\x20future\x20date\x20(MM/YY)','__setModuleDefault','\x20updated:\x20currentPayments=','test_card','webhookService','resolve','amount','name','1253004YheWPz','Any\x20name','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','then','sendPaymentNotification',':\x20type=','paymentLink','5lUrqMK','2841940bWqiqT','0000','now','FAILED','log','shop','error','get','PAID','Error\x20parsing\x20webhook\x20events:','POST','shopId','includes','4242\x204242\x204242\x204242','toLowerCase',',\x20status=','‚úÖ\x20Payment\x20link\x20','SINGLE','Any\x203-4\x20digits','8IwGonx','failed','gatewayPaymentId','Any\x20other\x20card\x20number','sendPaymentStatusNotification','failureReason','orderId','application/json','442218btrGCw','json','getPaymentForm','hasOwnProperty','currency','replace','gateway','üìà\x20Found\x20payment\x20link\x20','settings','Payment\x20failed','processCardPayment','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','parse','transactionId','test_gateway_','params','\x20not\x20enabled\x20for\x20shop\x20','__importStar','416532fFrOBZ','‚úÖ\x20Test\x20Gateway\x20payment\x20','TestGatewayService','cardNumber',',\x20cannot\x20process','\x20processed:\x20','5912361skDfZb','webhookEvents','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','prototype','../services/gateways/testGatewayService','../services/telegramBotService','25sNnFJA','body','\x20->\x20','slice','customerEmail','paymentLinkId','Payment\x20status\x20is\x20','create','gatewayOrderId','24018430JlHtEV','toISOString','default','__importDefault','COMPLETED','writable','Webhook\x20event\x20','__createBinding','ms)','cardLast4','testGatewayService','webhookLog','PENDING','üß™\x20Test\x20Gateway\x20result:','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:'];a13_0x3a78=function(){return _0x804642;};return a13_0x3a78();}