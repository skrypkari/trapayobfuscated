'use strict';function a21_0x11c1(){const _0x251456=['processCardPayment','POST','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','Any\x20future\x20date\x20(MM/YY)','failUrl','paymentLinkId','\x20updated:\x20currentPayments=','üß™\x20Sending\x20webhook\x20to\x20','3ZBagfb','hasOwnProperty','üß™\x20Test\x20Gateway\x20webhook:\x20event=','‚úÖ\x20Payment\x20link\x20','sendPaymentStatusNotification','226143jdULcV','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Any\x203-4\x20digits','prototype','../services/gateways/testGatewayService','4242\x204242\x204242\x204242','Any\x20name','10dYXvGt','669216HySGLJ','__importStar','1060092aXGZXs','testGatewayService','name','payment.failed','currentPayments','üìà\x20Test\x20Gateway:\x20Payment\x20','‚ùå\x20Payment\x20link\x20','stringify','...','webhookEvents','shopId','length','\x20processed:\x20','payment','digest','not\x20configured','findUnique','webhookService','üß™\x20Webhook\x20payload:','json','webhookUrl','Payment\x20to\x20','Payment\x20status\x20is\x20','secretKey','24cTtKRr','failureReason','test_gateway','getOwnPropertyNames','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','settings','../services/telegramBotService','type','now','Payment\x20System/1.0\x20(Test\x20Gateway)','PENDING','üìà\x20Found\x20payment\x20link\x20','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','currency','defineProperty','hex','body','create','then','resolve','toLowerCase','118471sulPCs','params','../services/webhookService','PAID','shop','__importDefault','gatewayOrderId','__createBinding','createHmac','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','status','1368VIvQxu','ms)','payment.success','\x20with\x20status\x20','../config/database','1600555DchKYf','TestGatewayController','__esModule',':\x20type=','isArray',',\x20currentPayments=','log','SINGLE','cardNumber','orderId','Error\x20parsing\x20webhook\x20events:','5ogCxRJ','\x20not\x20found','update','default','error','7539JtpKzg','processCard','createdAt','0000','replace','cardLast4','configurable','Payment\x20processed\x20successfully','customerName','amount','TestGatewayService','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','call','58820DuzQwF','sha256','WebhookService',',\x20cannot\x20process','sendShopWebhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','FAILED','__setModuleDefault','gateway','üß™\x20Test\x20Gateway\x20result:',',\x20webhookUrl=','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','‚ö†Ô∏è\x20Webhook\x20event\x20','writable','includes','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paymentLink','parse','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20->\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Payment\x20not\x20found','transactionId'];a21_0x11c1=function(){return _0x251456;};return a21_0x11c1();}const a21_0x128838=a21_0x37b4;(function(_0x378e16,_0x39d341){const _0x3f5546=a21_0x37b4,_0x36cd36=_0x378e16();while(!![]){try{const _0x253ef7=parseInt(_0x3f5546(0x117))/0x1+parseInt(_0x3f5546(0x144))/0x2*(parseInt(_0x3f5546(0x164))/0x3)+-parseInt(_0x3f5546(0xe9))/0x4*(-parseInt(_0x3f5546(0x132))/0x5)+parseInt(_0x3f5546(0x122))/0x6*(-parseInt(_0x3f5546(0x137))/0x7)+parseInt(_0x3f5546(0x101))/0x8*(parseInt(_0x3f5546(0x169))/0x9)+parseInt(_0x3f5546(0xe6))/0xa*(-parseInt(_0x3f5546(0x127))/0xb)+parseInt(_0x3f5546(0xe7))/0xc;if(_0x253ef7===_0x39d341)break;else _0x36cd36['push'](_0x36cd36['shift']());}catch(_0x48e1ac){_0x36cd36['push'](_0x36cd36['shift']());}}}(a21_0x11c1,0x255a0));function a21_0x37b4(_0x4e4cf9,_0x4e4ddc){_0x4e4cf9=_0x4e4cf9-0xe4;const _0x11c1a5=a21_0x11c1();let _0x37b46f=_0x11c1a5[_0x4e4cf9];return _0x37b46f;}var __createBinding=this&&this[a21_0x128838(0x11e)]||(Object['create']?function(_0x3d4da6,_0x271f61,_0x12f216,_0x308543){const _0x32b166=a21_0x128838;if(_0x308543===undefined)_0x308543=_0x12f216;var _0x53e44a=Object['getOwnPropertyDescriptor'](_0x271f61,_0x12f216);(!_0x53e44a||('get'in _0x53e44a?!_0x271f61[_0x32b166(0x129)]:_0x53e44a[_0x32b166(0x151)]||_0x53e44a[_0x32b166(0x13d)]))&&(_0x53e44a={'enumerable':!![],'get':function(){return _0x271f61[_0x12f216];}}),Object[_0x32b166(0x110)](_0x3d4da6,_0x308543,_0x53e44a);}:function(_0x339b34,_0x1fc71b,_0x3bb3eb,_0x5de99e){if(_0x5de99e===undefined)_0x5de99e=_0x3bb3eb;_0x339b34[_0x5de99e]=_0x1fc71b[_0x3bb3eb];}),__setModuleDefault=this&&this[a21_0x128838(0x14b)]||(Object[a21_0x128838(0x113)]?function(_0x40f351,_0x507268){const _0x213c6c=a21_0x128838;Object[_0x213c6c(0x110)](_0x40f351,_0x213c6c(0x135),{'enumerable':!![],'value':_0x507268});}:function(_0x5ce440,_0x3b658f){const _0x1bb2cd=a21_0x128838;_0x5ce440[_0x1bb2cd(0x135)]=_0x3b658f;}),__importStar=this&&this[a21_0x128838(0xe8)]||(function(){var _0x273d28=function(_0x4b6be0){const _0x52c59d=a21_0x37b4;return _0x273d28=Object[_0x52c59d(0x104)]||function(_0x7ba58){const _0x2069a6=_0x52c59d;var _0x2f669c=[];for(var _0xc0ab0f in _0x7ba58)if(Object[_0x2069a6(0x16c)][_0x2069a6(0x165)][_0x2069a6(0x143)](_0x7ba58,_0xc0ab0f))_0x2f669c[_0x2f669c[_0x2069a6(0xf4)]]=_0xc0ab0f;return _0x2f669c;},_0x273d28(_0x4b6be0);};return function(_0x420077){const _0x5b9d83=a21_0x37b4;if(_0x420077&&_0x420077[_0x5b9d83(0x129)])return _0x420077;var _0x1d52fa={};if(_0x420077!=null){for(var _0x4873a5=_0x273d28(_0x420077),_0x5574ab=0x0;_0x5574ab<_0x4873a5[_0x5b9d83(0xf4)];_0x5574ab++)if(_0x4873a5[_0x5574ab]!=='default')__createBinding(_0x1d52fa,_0x420077,_0x4873a5[_0x5574ab]);}return __setModuleDefault(_0x1d52fa,_0x420077),_0x1d52fa;};}()),__importDefault=this&&this[a21_0x128838(0x11c)]||function(_0x3212ed){const _0x259130=a21_0x128838;return _0x3212ed&&_0x3212ed[_0x259130(0x129)]?_0x3212ed:{'default':_0x3212ed};};Object['defineProperty'](exports,a21_0x128838(0x129),{'value':!![]}),exports[a21_0x128838(0x128)]=void 0x0;const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require(a21_0x128838(0x16d)),webhookService_1=require(a21_0x128838(0x119)),database_1=__importDefault(require(a21_0x128838(0x126)));class TestGatewayController{constructor(){const _0x4f6e3e=a21_0x128838;this['getPaymentForm']=async(_0x26476a,_0x247d22,_0x262ef9)=>{const _0x53ba57=a21_0x37b4;try{const {paymentId:_0x1ef085}=_0x26476a[_0x53ba57(0x118)];console[_0x53ba57(0x12d)](_0x53ba57(0x16a)+_0x1ef085);const _0x57b255=await database_1[_0x53ba57(0x135)][_0x53ba57(0xf6)][_0x53ba57(0xf9)]({'where':{'id':_0x1ef085},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x57b255)return _0x247d22[_0x53ba57(0x121)](0x194)[_0x53ba57(0xfc)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x57b255['gateway']!==_0x53ba57(0x103))return _0x247d22[_0x53ba57(0x121)](0x190)[_0x53ba57(0xfc)]({'success':![],'message':_0x53ba57(0x105)});if(_0x57b255['status']!==_0x53ba57(0x10c))return _0x247d22[_0x53ba57(0x121)](0x190)['json']({'success':![],'message':_0x53ba57(0xff)+_0x57b255[_0x53ba57(0x121)]+_0x53ba57(0x147)});_0x247d22[_0x53ba57(0xfc)]({'success':!![],'result':{'paymentId':_0x57b255['id'],'orderId':_0x57b255['gatewayOrderId'],'amount':_0x57b255[_0x53ba57(0x140)],'currency':_0x57b255[_0x53ba57(0x10f)],'merchantName':_0x57b255[_0x53ba57(0x11b)][_0x53ba57(0xeb)],'description':_0x53ba57(0xfe)+_0x57b255[_0x53ba57(0x11b)]['name'],'testInstructions':{'successCard':_0x53ba57(0xe4),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x53ba57(0x15f),'cvc':_0x53ba57(0x16b),'holderName':_0x53ba57(0xe5)}}});}catch(_0x3f40b6){_0x262ef9(_0x3f40b6);}},this[_0x4f6e3e(0x138)]=async(_0x1b0530,_0x370322,_0x33d1bb)=>{const _0x275f82=_0x4f6e3e;try{const {paymentId:_0x59f3fb}=_0x1b0530[_0x275f82(0x118)],_0x4d43eb=_0x1b0530[_0x275f82(0x112)];console[_0x275f82(0x12d)](_0x275f82(0x153)+_0x59f3fb);const _0x111978=await database_1['default']['payment'][_0x275f82(0xf9)]({'where':{'id':_0x59f3fb},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x111978)return _0x370322['status'](0x194)[_0x275f82(0xfc)]({'success':![],'message':_0x275f82(0x15a)});if(_0x111978[_0x275f82(0x14c)]!==_0x275f82(0x103))return _0x370322['status'](0x190)['json']({'success':![],'message':_0x275f82(0x105)});if(_0x111978[_0x275f82(0x121)]!==_0x275f82(0x10c))return _0x370322[_0x275f82(0x121)](0x190)[_0x275f82(0xfc)]({'success':![],'message':_0x275f82(0xff)+_0x111978[_0x275f82(0x121)]+_0x275f82(0x147)});const _0x5e3946=await this[_0x275f82(0xea)][_0x275f82(0x15c)]({'paymentId':_0x111978['id'],'orderId':_0x111978[_0x275f82(0x11d)]||_0x111978['id'],'amount':_0x111978['amount'],'currency':_0x111978[_0x275f82(0x10f)],'cardData':_0x4d43eb});console['log'](_0x275f82(0x14d),_0x5e3946);const _0xabed42={'status':_0x5e3946[_0x275f82(0x121)],'updatedAt':new Date()};if(_0x5e3946[_0x275f82(0x121)]===_0x275f82(0x11a))_0xabed42['paidAt']=new Date(),_0xabed42['gatewayPaymentId']=_0x5e3946[_0x275f82(0x15b)];else _0x5e3946[_0x275f82(0x121)]===_0x275f82(0x14a)&&(_0xabed42['failureMessage']=_0x5e3946[_0x275f82(0x102)]);const _0x5c9cfd=_0x4d43eb[_0x275f82(0x12f)][_0x275f82(0x13b)](/[\s-]/g,'');_0xabed42[_0x275f82(0x13c)]=_0x5c9cfd['slice'](-0x4),_0xabed42['paymentMethod']='test_card',await database_1[_0x275f82(0x135)]['payment'][_0x275f82(0x134)]({'where':{'id':_0x111978['id']},'data':_0xabed42});if(_0x5e3946[_0x275f82(0x121)]===_0x275f82(0x11a)&&_0x111978[_0x275f82(0x161)]){console[_0x275f82(0x12d)](_0x275f82(0xee)+_0x111978['id']+_0x275f82(0x158));try{await database_1[_0x275f82(0x135)]['$transaction'](async _0xc3b97=>{const _0x4a1d39=_0x275f82,_0x45da35=await _0xc3b97[_0x4a1d39(0x154)][_0x4a1d39(0xf9)]({'where':{'id':_0x111978[_0x4a1d39(0x161)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x45da35){console['log'](_0x4a1d39(0x10d)+_0x45da35['id']+_0x4a1d39(0x12a)+_0x45da35[_0x4a1d39(0x109)]+_0x4a1d39(0x12c)+_0x45da35['currentPayments']+',\x20status='+_0x45da35[_0x4a1d39(0x121)]);const _0x47f78a=_0x45da35[_0x4a1d39(0xed)]+0x1,_0x4b4caf=_0x45da35[_0x4a1d39(0x109)]===_0x4a1d39(0x12e)?'COMPLETED':_0x45da35['status'];await _0xc3b97[_0x4a1d39(0x154)][_0x4a1d39(0x134)]({'where':{'id':_0x111978['paymentLinkId']},'data':{'currentPayments':_0x47f78a,'status':_0x4b4caf,'updatedAt':new Date()}}),console[_0x4a1d39(0x12d)](_0x4a1d39(0x167)+_0x45da35['id']+_0x4a1d39(0x162)+_0x45da35['currentPayments']+_0x4a1d39(0x157)+_0x47f78a+',\x20status='+_0x45da35['status']+_0x4a1d39(0x157)+_0x4b4caf);}else console[_0x4a1d39(0x12d)](_0x4a1d39(0xef)+_0x111978[_0x4a1d39(0x161)]+_0x4a1d39(0x133));});}catch(_0x288fe9){console[_0x275f82(0x136)](_0x275f82(0x159),_0x288fe9);}}await database_1[_0x275f82(0x135)]['webhookLog'][_0x275f82(0x113)]({'data':{'paymentId':_0x111978['id'],'shopId':_0x111978['shopId'],'event':_0x275f82(0x106)+_0x5e3946[_0x275f82(0x121)][_0x275f82(0x116)](),'statusCode':_0x5e3946[_0x275f82(0x121)]===_0x275f82(0x11a)?0xc8:0x190,'responseBody':JSON[_0x275f82(0xf0)]({'oldStatus':_0x275f82(0x10c),'newStatus':_0x5e3946[_0x275f82(0x121)],'transactionId':_0x5e3946[_0x275f82(0x15b)],'failureReason':_0x5e3946['failureReason'],'processedAt':new Date()['toISOString']()})}}),console['log'](_0x275f82(0x142)+_0x5e3946['status']+_0x275f82(0xf1)),await this[_0x275f82(0x148)](_0x111978,_0x5e3946[_0x275f82(0x121)],_0x5e3946[_0x275f82(0x15b)],_0x5e3946['failureReason']),console[_0x275f82(0x12d)](_0x275f82(0x14f)+_0x5e3946['status']),console[_0x275f82(0x12d)]('üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20'+_0x5e3946['status']+_0x275f82(0xf1)),await this[_0x275f82(0x168)](_0x111978,_0x5e3946[_0x275f82(0x121)]),console[_0x275f82(0x12d)](_0x275f82(0x15e)+_0x5e3946[_0x275f82(0x121)]),console[_0x275f82(0x12d)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x59f3fb+_0x275f82(0xf5)+_0x5e3946[_0x275f82(0x121)]),_0x5e3946[_0x275f82(0x121)]===_0x275f82(0x11a)?_0x370322[_0x275f82(0xfc)]({'success':!![],'message':_0x275f82(0x13e),'result':{'status':_0x275f82(0x11a),'transactionId':_0x5e3946[_0x275f82(0x15b)],'redirectUrl':_0x111978['successUrl']}}):_0x370322[_0x275f82(0x121)](0x190)[_0x275f82(0xfc)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x275f82(0x14a),'failureReason':_0x5e3946[_0x275f82(0x102)],'redirectUrl':_0x111978[_0x275f82(0x160)]}});}catch(_0xc0083f){_0x33d1bb(_0xc0083f);}},this[_0x4f6e3e(0xea)]=new testGatewayService_1[(_0x4f6e3e(0x141))](),this[_0x4f6e3e(0xfa)]=new webhookService_1[(_0x4f6e3e(0x146))]();}async[a21_0x128838(0x148)](_0x4e1d75,_0x33c3be,_0x3ddaeb,_0x5d5824){const _0x229eb4=a21_0x128838,_0x7caa7=Date[_0x229eb4(0x10a)]();try{const _0x1ef5a1=_0x4e1d75[_0x229eb4(0x11b)],_0x56a4e5=_0x1ef5a1[_0x229eb4(0x107)];if(!_0x56a4e5?.[_0x229eb4(0xfd)]){console[_0x229eb4(0x12d)](_0x229eb4(0x120)+_0x1ef5a1['id']);return;}const _0x463a39=_0x33c3be==='PAID'?_0x229eb4(0x124):_0x229eb4(0xec);console[_0x229eb4(0x12d)](_0x229eb4(0x166)+_0x463a39+_0x229eb4(0x14e)+(_0x56a4e5['webhookUrl']?'configured':_0x229eb4(0xf8)));let _0x5146eb=[];if(_0x56a4e5[_0x229eb4(0xf2)])try{_0x5146eb=Array[_0x229eb4(0x12b)](_0x56a4e5['webhookEvents'])?_0x56a4e5[_0x229eb4(0xf2)]:JSON[_0x229eb4(0x155)](_0x56a4e5[_0x229eb4(0xf2)]);}catch(_0x4e7d2d){console[_0x229eb4(0x136)](_0x229eb4(0x131),_0x4e7d2d),_0x5146eb=[];}console[_0x229eb4(0x12d)](_0x229eb4(0x10e),_0x5146eb);if(!_0x5146eb[_0x229eb4(0x152)](_0x463a39)){console[_0x229eb4(0x12d)](_0x229eb4(0x150)+_0x463a39+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1ef5a1['id']);return;}const _0x2a3c95={'event':_0x463a39,'payment':{'id':_0x4e1d75['id'],'order_id':_0x4e1d75[_0x229eb4(0x130)],'gateway_order_id':_0x4e1d75['gatewayOrderId'],'gateway':_0x229eb4(0x13a),'amount':_0x4e1d75[_0x229eb4(0x140)],'currency':_0x4e1d75[_0x229eb4(0x10f)],'status':_0x33c3be[_0x229eb4(0x116)](),'customer_email':_0x4e1d75['customerEmail'],'customer_name':_0x4e1d75[_0x229eb4(0x13f)],'transaction_id':_0x3ddaeb,'failure_message':_0x5d5824,'created_at':_0x4e1d75[_0x229eb4(0x139)],'updated_at':new Date()}};console[_0x229eb4(0x12d)](_0x229eb4(0x163)+_0x56a4e5[_0x229eb4(0xfd)]+_0x229eb4(0xf1)),console[_0x229eb4(0x12d)](_0x229eb4(0xfb),JSON[_0x229eb4(0xf0)](_0x2a3c95,null,0x2));const _0x2ae214=JSON[_0x229eb4(0xf0)](_0x2a3c95),_0x1c5212=crypto_1['default'][_0x229eb4(0x11f)](_0x229eb4(0x145),_0x1ef5a1[_0x229eb4(0x100)])['update'](_0x2ae214)[_0x229eb4(0xf7)](_0x229eb4(0x111)),_0x5818aa=await fetch(_0x56a4e5[_0x229eb4(0xfd)],{'method':_0x229eb4(0x15d),'headers':{'Content-Type':'application/json','User-Agent':_0x229eb4(0x10b),'X-Webhook-Signature':_0x1c5212},'body':_0x2ae214}),_0x40018e=Date['now']()-_0x7caa7;console[_0x229eb4(0x12d)]('‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x56a4e5['webhookUrl']+_0x229eb4(0x125)+_0x5818aa['status']+'\x20('+_0x40018e+_0x229eb4(0x123));}catch(_0x28ce9d){console[_0x229eb4(0x136)](_0x229eb4(0x156),_0x28ce9d);}}async['sendPaymentStatusNotification'](_0x34c92a,_0x444e35){const _0x3e2c94=a21_0x128838;try{const {telegramBotService:_0x258f1e}=await Promise[_0x3e2c94(0x115)]()[_0x3e2c94(0x114)](()=>__importStar(require(_0x3e2c94(0x108)))),_0x2fd7ca={'PAID':'paid','FAILED':'failed'},_0x1a819c=_0x2fd7ca[_0x444e35];if(!_0x1a819c)return;await _0x258f1e['sendPaymentNotification'](_0x34c92a[_0x3e2c94(0xf3)],_0x34c92a,_0x1a819c);}catch(_0x3e53f6){console[_0x3e2c94(0x136)](_0x3e2c94(0x149),_0x3e53f6);}}}exports[a21_0x128838(0x128)]=TestGatewayController;