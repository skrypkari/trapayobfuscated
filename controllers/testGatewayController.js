'use strict';const a13_0x47821f=a13_0x3ed1;function a13_0x3ed1(_0x57b58c,_0x4cfd1e){const _0x768ce3=a13_0x768c();return a13_0x3ed1=function(_0x3ed131,_0x2a495f){_0x3ed131=_0x3ed131-0xa7;let _0x331dce=_0x768ce3[_0x3ed131];return _0x331dce;},a13_0x3ed1(_0x57b58c,_0x4cfd1e);}(function(_0x3f3991,_0x8c7723){const _0x1fb9a7=a13_0x3ed1,_0x4faeba=_0x3f3991();while(!![]){try{const _0x5d5456=parseInt(_0x1fb9a7(0xe4))/0x1*(-parseInt(_0x1fb9a7(0xbc))/0x2)+parseInt(_0x1fb9a7(0xcc))/0x3+parseInt(_0x1fb9a7(0xc0))/0x4+-parseInt(_0x1fb9a7(0x10f))/0x5*(parseInt(_0x1fb9a7(0xd8))/0x6)+parseInt(_0x1fb9a7(0xd9))/0x7+-parseInt(_0x1fb9a7(0xdb))/0x8+parseInt(_0x1fb9a7(0xeb))/0x9;if(_0x5d5456===_0x8c7723)break;else _0x4faeba['push'](_0x4faeba['shift']());}catch(_0x3a1830){_0x4faeba['push'](_0x4faeba['shift']());}}}(a13_0x768c,0xd08ef));var __createBinding=this&&this[a13_0x47821f(0xbd)]||(Object['create']?function(_0x34ce2c,_0x4eed8a,_0x1fe756,_0x56ac93){const _0x1f0064=a13_0x47821f;if(_0x56ac93===undefined)_0x56ac93=_0x1fe756;var _0x5a39c3=Object[_0x1f0064(0xd6)](_0x4eed8a,_0x1fe756);(!_0x5a39c3||(_0x1f0064(0xd1)in _0x5a39c3?!_0x4eed8a[_0x1f0064(0xc1)]:_0x5a39c3[_0x1f0064(0xe5)]||_0x5a39c3[_0x1f0064(0xb8)]))&&(_0x5a39c3={'enumerable':!![],'get':function(){return _0x4eed8a[_0x1fe756];}}),Object['defineProperty'](_0x34ce2c,_0x56ac93,_0x5a39c3);}:function(_0x1cc123,_0x94b97c,_0x57ea26,_0x59c3a5){if(_0x59c3a5===undefined)_0x59c3a5=_0x57ea26;_0x1cc123[_0x59c3a5]=_0x94b97c[_0x57ea26];}),__setModuleDefault=this&&this[a13_0x47821f(0xad)]||(Object[a13_0x47821f(0x111)]?function(_0x10ba32,_0x355873){const _0x1d3178=a13_0x47821f;Object[_0x1d3178(0xde)](_0x10ba32,_0x1d3178(0xe6),{'enumerable':!![],'value':_0x355873});}:function(_0x2c78bf,_0x590ad0){const _0x589ce1=a13_0x47821f;_0x2c78bf[_0x589ce1(0xe6)]=_0x590ad0;}),__importStar=this&&this[a13_0x47821f(0xdc)]||(function(){var _0x3cf823=function(_0x3eff1c){const _0x64b5ce=a13_0x3ed1;return _0x3cf823=Object[_0x64b5ce(0x104)]||function(_0x20f573){const _0x3202aa=_0x64b5ce;var _0x1099cc=[];for(var _0x5dd4c0 in _0x20f573)if(Object[_0x3202aa(0xe9)][_0x3202aa(0xb0)]['call'](_0x20f573,_0x5dd4c0))_0x1099cc[_0x1099cc[_0x3202aa(0xc9)]]=_0x5dd4c0;return _0x1099cc;},_0x3cf823(_0x3eff1c);};return function(_0x29cd48){const _0xc230a1=a13_0x3ed1;if(_0x29cd48&&_0x29cd48['__esModule'])return _0x29cd48;var _0xf3667a={};if(_0x29cd48!=null){for(var _0x961471=_0x3cf823(_0x29cd48),_0xa92f20=0x0;_0xa92f20<_0x961471[_0xc230a1(0xc9)];_0xa92f20++)if(_0x961471[_0xa92f20]!==_0xc230a1(0xe6))__createBinding(_0xf3667a,_0x29cd48,_0x961471[_0xa92f20]);}return __setModuleDefault(_0xf3667a,_0x29cd48),_0xf3667a;};}()),__importDefault=this&&this[a13_0x47821f(0xe2)]||function(_0x445e8d){const _0xb093fa=a13_0x47821f;return _0x445e8d&&_0x445e8d[_0xb093fa(0xc1)]?_0x445e8d:{'default':_0x445e8d};};function a13_0x768c(){const _0x253d6a=['PAID','configurable','FAILED','createdAt','webhookService','2paWgKe','__createBinding','paymentMethod','âœ…\x20Test\x20Gateway\x20payment\x20','2292844XebTmq','__esModule','TestGatewayService','cardNumber','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','processCard','shopId','successUrl','webhookUrl','length','settings','stringify','1283175Ogrhhu','includes','currency','gatewayOrderId','payment.failed','get','gateway','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','customerName','paidAt','getOwnPropertyDescriptor','Any\x20other\x20card\x20number','2942142RXeFBt','5539632cLTnlv','getPaymentForm','2150872KOdCkr','__importStar','PENDING','defineProperty','testGatewayService','failUrl','slice','__importDefault','\x20with\x20status\x20','1085180yMlMUV','writable','default','payment','4242\x204242\x204242\x204242','prototype','Payment\x20status\x20is\x20','12570264prWdrJ','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','POST','paid','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','body','params','log','name','error','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','../services/telegramBotService','WebhookService','cardLast4','gatewayPaymentId','test_gateway_','Error\x20parsing\x20webhook\x20events:','toLowerCase','resolve','toISOString','amount','Payment\x20to\x20','Payment\x20failed','sendShopWebhook','Payment\x20is\x20not\x20for\x20test\x20gateway','getOwnPropertyNames','webhookEvents','TestGatewayController','then','Any\x203-4\x20digits','transactionId',',\x20cannot\x20process','failureReason','Payment\x20not\x20found','findUnique','now','10oILBZA','\x20processed:\x20','create','Webhook\x20event\x20','json','orderId','status','update','../services/gateways/testGatewayService','shop','sendPaymentStatusNotification','ms)','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__setModuleDefault','sendPaymentNotification','isArray','hasOwnProperty','test_gateway','payment.success','ðŸ§ª\x20Test\x20Gateway\x20result:','failed','failureMessage','webhookLog'];a13_0x768c=function(){return _0x253d6a;};return a13_0x768c();}Object[a13_0x47821f(0xde)](exports,a13_0x47821f(0xc1),{'value':!![]}),exports[a13_0x47821f(0x106)]=void 0x0;const testGatewayService_1=require(a13_0x47821f(0xa8)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x14cf8e=a13_0x47821f;this[_0x14cf8e(0xda)]=async(_0xe7ff90,_0x567602,_0x1a9b79)=>{const _0x3981fb=_0x14cf8e;try{const {paymentId:_0x4aedd3}=_0xe7ff90[_0x3981fb(0xf1)];console[_0x3981fb(0xf2)](_0x3981fb(0xd3)+_0x4aedd3);const _0x128ea8=await database_1['default'][_0x3981fb(0xe7)][_0x3981fb(0x10d)]({'where':{'id':_0x4aedd3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x128ea8)return _0x567602[_0x3981fb(0x115)](0x194)[_0x3981fb(0x113)]({'success':![],'message':_0x3981fb(0x10c)});if(_0x128ea8[_0x3981fb(0xd2)]!=='test_gateway')return _0x567602[_0x3981fb(0x115)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x128ea8[_0x3981fb(0x115)]!==_0x3981fb(0xdd))return _0x567602[_0x3981fb(0x115)](0x190)[_0x3981fb(0x113)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x128ea8['status']+_0x3981fb(0x10a)});_0x567602[_0x3981fb(0x113)]({'success':!![],'result':{'paymentId':_0x128ea8['id'],'orderId':_0x128ea8['gatewayOrderId'],'amount':_0x128ea8[_0x3981fb(0xff)],'currency':_0x128ea8[_0x3981fb(0xce)],'merchantName':_0x128ea8[_0x3981fb(0xa9)][_0x3981fb(0xf3)],'description':_0x3981fb(0x100)+_0x128ea8[_0x3981fb(0xa9)][_0x3981fb(0xf3)],'testInstructions':{'successCard':_0x3981fb(0xe8),'failureCard':_0x3981fb(0xd7),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x3981fb(0x108),'holderName':'Any\x20name'}}});}catch(_0x2fa0be){_0x1a9b79(_0x2fa0be);}},this[_0x14cf8e(0xc5)]=async(_0x3c8393,_0x79e0b7,_0x641ca2)=>{const _0x47c851=_0x14cf8e;try{const {paymentId:_0x45ce01}=_0x3c8393[_0x47c851(0xf1)],_0x45304b=_0x3c8393[_0x47c851(0xf0)];console[_0x47c851(0xf2)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x45ce01);const _0x64d760=await database_1[_0x47c851(0xe6)][_0x47c851(0xe7)][_0x47c851(0x10d)]({'where':{'id':_0x45ce01},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x64d760)return _0x79e0b7[_0x47c851(0x115)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x64d760[_0x47c851(0xd2)]!==_0x47c851(0xb1))return _0x79e0b7[_0x47c851(0x115)](0x190)[_0x47c851(0x113)]({'success':![],'message':_0x47c851(0x103)});if(_0x64d760['status']!==_0x47c851(0xdd))return _0x79e0b7['status'](0x190)['json']({'success':![],'message':_0x47c851(0xea)+_0x64d760['status']+',\x20cannot\x20process'});const _0x4783c2=await this[_0x47c851(0xdf)]['processCardPayment']({'paymentId':_0x64d760['id'],'orderId':_0x64d760['gatewayOrderId']||_0x64d760['id'],'amount':_0x64d760['amount'],'currency':_0x64d760[_0x47c851(0xce)],'cardData':_0x45304b});console['log'](_0x47c851(0xb3),_0x4783c2);const _0x2126cd={'status':_0x4783c2['status'],'updatedAt':new Date()};if(_0x4783c2[_0x47c851(0x115)]==='PAID')_0x2126cd[_0x47c851(0xd5)]=new Date(),_0x2126cd[_0x47c851(0xf9)]=_0x4783c2[_0x47c851(0x109)];else _0x4783c2[_0x47c851(0x115)]===_0x47c851(0xb9)&&(_0x2126cd[_0x47c851(0xb5)]=_0x4783c2['failureReason']);const _0x41f056=_0x45304b[_0x47c851(0xc3)]['replace'](/[\s-]/g,'');_0x2126cd[_0x47c851(0xf8)]=_0x41f056[_0x47c851(0xe1)](-0x4),_0x2126cd[_0x47c851(0xbe)]='test_card',await database_1[_0x47c851(0xe6)]['payment'][_0x47c851(0xa7)]({'where':{'id':_0x64d760['id']},'data':_0x2126cd}),await database_1[_0x47c851(0xe6)][_0x47c851(0xb6)]['create']({'data':{'paymentId':_0x64d760['id'],'shopId':_0x64d760[_0x47c851(0xc6)],'event':_0x47c851(0xfa)+_0x4783c2[_0x47c851(0x115)][_0x47c851(0xfc)](),'statusCode':0xc8,'responseBody':JSON[_0x47c851(0xcb)]({'oldStatus':_0x47c851(0xdd),'newStatus':_0x4783c2[_0x47c851(0x115)],'transactionId':_0x4783c2['transactionId'],'failureReason':_0x4783c2[_0x47c851(0x10b)],'processedAt':new Date()[_0x47c851(0xfe)]()})}}),await this[_0x47c851(0x102)](_0x64d760,_0x4783c2[_0x47c851(0x115)],_0x4783c2['transactionId'],_0x4783c2[_0x47c851(0x10b)]),await this['sendPaymentStatusNotification'](_0x64d760,_0x4783c2[_0x47c851(0x115)]),console[_0x47c851(0xf2)](_0x47c851(0xbf)+_0x45ce01+_0x47c851(0x110)+_0x4783c2[_0x47c851(0x115)]),_0x4783c2[_0x47c851(0x115)]==='PAID'?_0x79e0b7['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x47c851(0xb7),'transactionId':_0x4783c2[_0x47c851(0x109)],'redirectUrl':_0x64d760[_0x47c851(0xc7)]}}):_0x79e0b7[_0x47c851(0x115)](0x190)[_0x47c851(0x113)]({'success':![],'message':_0x47c851(0x101),'result':{'status':_0x47c851(0xb9),'failureReason':_0x4783c2[_0x47c851(0x10b)],'redirectUrl':_0x64d760[_0x47c851(0xe0)]}});}catch(_0x3660a5){_0x641ca2(_0x3660a5);}},this['testGatewayService']=new testGatewayService_1[(_0x14cf8e(0xc2))](),this[_0x14cf8e(0xbb)]=new webhookService_1[(_0x14cf8e(0xf7))]();}async[a13_0x47821f(0x102)](_0x37077c,_0x2dc5fa,_0x4ab727,_0x35cf6e){const _0x39b0a3=a13_0x47821f,_0x6ba240=Date['now']();try{const _0x422256=_0x37077c['shop'],_0x303355=_0x422256[_0x39b0a3(0xca)];if(!_0x303355?.[_0x39b0a3(0xc8)]){console['log'](_0x39b0a3(0xec)+_0x422256['id']);return;}const _0x135634=_0x2dc5fa===_0x39b0a3(0xb7)?_0x39b0a3(0xb2):_0x39b0a3(0xd0);let _0x19a3e8=[];if(_0x303355['webhookEvents'])try{_0x19a3e8=Array[_0x39b0a3(0xaf)](_0x303355['webhookEvents'])?_0x303355[_0x39b0a3(0x105)]:JSON['parse'](_0x303355[_0x39b0a3(0x105)]);}catch(_0x3209b5){console[_0x39b0a3(0xf4)](_0x39b0a3(0xfb),_0x3209b5),_0x19a3e8=[];}if(!_0x19a3e8[_0x39b0a3(0xcd)](_0x135634)){console[_0x39b0a3(0xf2)](_0x39b0a3(0x112)+_0x135634+'\x20not\x20enabled\x20for\x20shop\x20'+_0x422256['id']);return;}const _0x4b59ef={'event':_0x135634,'payment':{'id':_0x37077c['id'],'order_id':_0x37077c[_0x39b0a3(0x114)],'gateway_order_id':_0x37077c[_0x39b0a3(0xcf)],'gateway':'0000','amount':_0x37077c[_0x39b0a3(0xff)],'currency':_0x37077c[_0x39b0a3(0xce)],'status':_0x2dc5fa[_0x39b0a3(0xfc)](),'customer_email':_0x37077c['customerEmail'],'customer_name':_0x37077c[_0x39b0a3(0xd4)],'transaction_id':_0x4ab727,'failure_message':_0x35cf6e,'created_at':_0x37077c[_0x39b0a3(0xba)],'updated_at':new Date()}},_0x21fede=await fetch(_0x303355[_0x39b0a3(0xc8)],{'method':_0x39b0a3(0xed),'headers':{'Content-Type':'application/json','User-Agent':_0x39b0a3(0xf5)},'body':JSON[_0x39b0a3(0xcb)](_0x4b59ef)}),_0x13a1a3=Date[_0x39b0a3(0x10e)]()-_0x6ba240;console['log'](_0x39b0a3(0xac)+_0x303355[_0x39b0a3(0xc8)]+_0x39b0a3(0xe3)+_0x21fede[_0x39b0a3(0x115)]+'\x20('+_0x13a1a3+_0x39b0a3(0xab));}catch(_0x294187){console[_0x39b0a3(0xf4)](_0x39b0a3(0xc4),_0x294187);}}async[a13_0x47821f(0xaa)](_0x55f7af,_0x10a240){const _0x589138=a13_0x47821f;try{const {telegramBotService:_0x15e1e4}=await Promise[_0x589138(0xfd)]()[_0x589138(0x107)](()=>__importStar(require(_0x589138(0xf6)))),_0x4c5719={'PAID':_0x589138(0xee),'FAILED':_0x589138(0xb4)},_0x52c917=_0x4c5719[_0x10a240];if(!_0x52c917)return;await _0x15e1e4[_0x589138(0xae)](_0x55f7af[_0x589138(0xc6)],_0x55f7af,_0x52c917);}catch(_0x495b35){console[_0x589138(0xf4)](_0x589138(0xef),_0x495b35);}}}exports[a13_0x47821f(0x106)]=TestGatewayController;