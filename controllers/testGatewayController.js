'use strict';const a13_0x21f259=a13_0x5784;(function(_0x54547b,_0x1f9b8a){const _0x44b690=a13_0x5784,_0x50238=_0x54547b();while(!![]){try{const _0xde57ad=parseInt(_0x44b690(0x1cc))/0x1+parseInt(_0x44b690(0x1ae))/0x2+-parseInt(_0x44b690(0x1e2))/0x3+parseInt(_0x44b690(0x1bc))/0x4+parseInt(_0x44b690(0x1a5))/0x5*(-parseInt(_0x44b690(0x203))/0x6)+parseInt(_0x44b690(0x1db))/0x7+parseInt(_0x44b690(0x1f6))/0x8*(-parseInt(_0x44b690(0x1ab))/0x9);if(_0xde57ad===_0x1f9b8a)break;else _0x50238['push'](_0x50238['shift']());}catch(_0xa7355c){_0x50238['push'](_0x50238['shift']());}}}(a13_0x2a74,0xe725d));function a13_0x2a74(){const _0x4fbec5=['test_card','751414dSEyxW','âœ…\x20Test\x20Gateway\x20payment\x20','Payment\x20status\x20is\x20','../config/database','getOwnPropertyNames','toLowerCase','create','testGatewayService','webhookUrl','Any\x20future\x20date\x20(MM/YY)','transactionId','processCardPayment','webhookService','../services/webhookService','7371648ZmhLnR','status','Webhook\x20event\x20','error','cardNumber','failureReason','customerEmail','paymentMethod','../services/telegramBotService','log','sendPaymentNotification','PENDING','length','payment','writable','payment.failed','1299438FbJAMf','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getOwnPropertyDescriptor','\x20not\x20enabled\x20for\x20shop\x20','replace','PAID','now','successUrl','slice','__importStar','0000','Payment\x20is\x20not\x20for\x20test\x20gateway','WebhookService','webhookLog','FAILED','6915832TIbfgX','\x20with\x20status\x20','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','webhookEvents','prototype','amount','Payment\x20failed','1867443DuvRRB','TestGatewayService','orderId','then',',\x20cannot\x20process','Payment\x20to\x20','call','json','default','__importDefault','test_gateway_','shop','Test\x20Gateway\x20webhook\x20sent\x20to\x20','resolve','name','Error\x20parsing\x20webhook\x20events:','payment.success','parse','customerName','cardLast4','24WqXEzl','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','params','failureMessage','../services/gateways/testGatewayService','processCard','getPaymentForm','gateway','__setModuleDefault','ms)','sendPaymentStatusNotification','body','408vqzfAX','findUnique','shopId','gatewayOrderId','test_gateway','paid','__esModule','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','POST','sendShopWebhook','__createBinding','8885WNAGJo','failed','stringify','defineProperty','createdAt','Any\x203-4\x20digits','8447805VnlcKE','toISOString'];a13_0x2a74=function(){return _0x4fbec5;};return a13_0x2a74();}function a13_0x5784(_0x4ab704,_0xa45961){const _0x2a741d=a13_0x2a74();return a13_0x5784=function(_0x5784e9,_0x5b7779){_0x5784e9=_0x5784e9-0x19f;let _0x471838=_0x2a741d[_0x5784e9];return _0x471838;},a13_0x5784(_0x4ab704,_0xa45961);}var __createBinding=this&&this[a13_0x21f259(0x1a4)]||(Object['create']?function(_0x29e785,_0x76ffff,_0x3cd703,_0x5df3b6){const _0x513985=a13_0x21f259;if(_0x5df3b6===undefined)_0x5df3b6=_0x3cd703;var _0x344ed5=Object[_0x513985(0x1ce)](_0x76ffff,_0x3cd703);(!_0x344ed5||('get'in _0x344ed5?!_0x76ffff[_0x513985(0x1a0)]:_0x344ed5[_0x513985(0x1ca)]||_0x344ed5['configurable']))&&(_0x344ed5={'enumerable':!![],'get':function(){return _0x76ffff[_0x3cd703];}}),Object[_0x513985(0x1a8)](_0x29e785,_0x5df3b6,_0x344ed5);}:function(_0x5347db,_0x5f436a,_0xdadc93,_0x426977){if(_0x426977===undefined)_0x426977=_0xdadc93;_0x5347db[_0x426977]=_0x5f436a[_0xdadc93];}),__setModuleDefault=this&&this[a13_0x21f259(0x1ff)]||(Object[a13_0x21f259(0x1b4)]?function(_0x119b38,_0x29a04b){const _0x46ee7a=a13_0x21f259;Object['defineProperty'](_0x119b38,_0x46ee7a(0x1ea),{'enumerable':!![],'value':_0x29a04b});}:function(_0x29d317,_0x55ecfe){const _0x206ab1=a13_0x21f259;_0x29d317[_0x206ab1(0x1ea)]=_0x55ecfe;}),__importStar=this&&this[a13_0x21f259(0x1d5)]||(function(){var _0x22dd3e=function(_0x333d6b){const _0x5986a4=a13_0x5784;return _0x22dd3e=Object[_0x5986a4(0x1b2)]||function(_0x4f2948){const _0x496053=_0x5986a4;var _0x235cd0=[];for(var _0x4a06a6 in _0x4f2948)if(Object[_0x496053(0x1df)]['hasOwnProperty'][_0x496053(0x1e8)](_0x4f2948,_0x4a06a6))_0x235cd0[_0x235cd0[_0x496053(0x1c8)]]=_0x4a06a6;return _0x235cd0;},_0x22dd3e(_0x333d6b);};return function(_0x593734){const _0x4d27d4=a13_0x5784;if(_0x593734&&_0x593734['__esModule'])return _0x593734;var _0x3fb2bd={};if(_0x593734!=null){for(var _0x35708a=_0x22dd3e(_0x593734),_0x2246df=0x0;_0x2246df<_0x35708a[_0x4d27d4(0x1c8)];_0x2246df++)if(_0x35708a[_0x2246df]!==_0x4d27d4(0x1ea))__createBinding(_0x3fb2bd,_0x593734,_0x35708a[_0x2246df]);}return __setModuleDefault(_0x3fb2bd,_0x593734),_0x3fb2bd;};}()),__importDefault=this&&this[a13_0x21f259(0x1eb)]||function(_0x22cd2f){return _0x22cd2f&&_0x22cd2f['__esModule']?_0x22cd2f:{'default':_0x22cd2f};};Object[a13_0x21f259(0x1a8)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x21f259(0x1fb)),webhookService_1=require(a13_0x21f259(0x1bb)),database_1=__importDefault(require(a13_0x21f259(0x1b1)));class TestGatewayController{constructor(){const _0x594a87=a13_0x21f259;this[_0x594a87(0x1fd)]=async(_0x3db3e8,_0x29af76,_0x5c4bf1)=>{const _0x5a304f=_0x594a87;try{const {paymentId:_0x5e758b}=_0x3db3e8[_0x5a304f(0x1f9)];console[_0x5a304f(0x1c5)](_0x5a304f(0x1f8)+_0x5e758b);const _0x493105=await database_1[_0x5a304f(0x1ea)][_0x5a304f(0x1c9)][_0x5a304f(0x204)]({'where':{'id':_0x5e758b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x493105)return _0x29af76[_0x5a304f(0x1bd)](0x194)[_0x5a304f(0x1e9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x493105[_0x5a304f(0x1fe)]!==_0x5a304f(0x207))return _0x29af76[_0x5a304f(0x1bd)](0x190)[_0x5a304f(0x1e9)]({'success':![],'message':_0x5a304f(0x1d7)});if(_0x493105[_0x5a304f(0x1bd)]!=='PENDING')return _0x29af76[_0x5a304f(0x1bd)](0x190)['json']({'success':![],'message':_0x5a304f(0x1b0)+_0x493105['status']+_0x5a304f(0x1e6)});_0x29af76[_0x5a304f(0x1e9)]({'success':!![],'result':{'paymentId':_0x493105['id'],'orderId':_0x493105['gatewayOrderId'],'amount':_0x493105[_0x5a304f(0x1e0)],'currency':_0x493105['currency'],'merchantName':_0x493105['shop'][_0x5a304f(0x1f0)],'description':_0x5a304f(0x1e7)+_0x493105['shop']['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x5a304f(0x1b7),'cvc':_0x5a304f(0x1aa),'holderName':'Any\x20name'}}});}catch(_0xdcb664){_0x5c4bf1(_0xdcb664);}},this[_0x594a87(0x1fc)]=async(_0x2df5ac,_0x2d0ed5,_0x2bba8b)=>{const _0x44d0e3=_0x594a87;try{const {paymentId:_0x5caa7d}=_0x2df5ac[_0x44d0e3(0x1f9)],_0x2c435f=_0x2df5ac[_0x44d0e3(0x202)];console[_0x44d0e3(0x1c5)](_0x44d0e3(0x1dd)+_0x5caa7d);const _0x3d0797=await database_1[_0x44d0e3(0x1ea)][_0x44d0e3(0x1c9)][_0x44d0e3(0x204)]({'where':{'id':_0x5caa7d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3d0797)return _0x2d0ed5[_0x44d0e3(0x1bd)](0x194)[_0x44d0e3(0x1e9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3d0797['gateway']!==_0x44d0e3(0x207))return _0x2d0ed5[_0x44d0e3(0x1bd)](0x190)[_0x44d0e3(0x1e9)]({'success':![],'message':_0x44d0e3(0x1d7)});if(_0x3d0797[_0x44d0e3(0x1bd)]!=='PENDING')return _0x2d0ed5['status'](0x190)[_0x44d0e3(0x1e9)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3d0797[_0x44d0e3(0x1bd)]+',\x20cannot\x20process'});const _0x52c285=await this[_0x44d0e3(0x1b5)][_0x44d0e3(0x1b9)]({'paymentId':_0x3d0797['id'],'orderId':_0x3d0797[_0x44d0e3(0x206)]||_0x3d0797['id'],'amount':_0x3d0797[_0x44d0e3(0x1e0)],'currency':_0x3d0797['currency'],'cardData':_0x2c435f});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x52c285);const _0x3a3a91={'status':_0x52c285[_0x44d0e3(0x1bd)],'updatedAt':new Date()};if(_0x52c285[_0x44d0e3(0x1bd)]===_0x44d0e3(0x1d1))_0x3a3a91['paidAt']=new Date(),_0x3a3a91[_0x44d0e3(0x1f7)]=_0x52c285[_0x44d0e3(0x1b8)];else _0x52c285['status']==='FAILED'&&(_0x3a3a91[_0x44d0e3(0x1fa)]=_0x52c285[_0x44d0e3(0x1c1)]);const _0x47d63d=_0x2c435f[_0x44d0e3(0x1c0)][_0x44d0e3(0x1d0)](/[\s-]/g,'');_0x3a3a91[_0x44d0e3(0x1f5)]=_0x47d63d[_0x44d0e3(0x1d4)](-0x4),_0x3a3a91[_0x44d0e3(0x1c3)]=_0x44d0e3(0x1ad),await database_1[_0x44d0e3(0x1ea)][_0x44d0e3(0x1c9)]['update']({'where':{'id':_0x3d0797['id']},'data':_0x3a3a91}),await database_1['default'][_0x44d0e3(0x1d9)][_0x44d0e3(0x1b4)]({'data':{'paymentId':_0x3d0797['id'],'shopId':_0x3d0797[_0x44d0e3(0x205)],'event':_0x44d0e3(0x1ec)+_0x52c285[_0x44d0e3(0x1bd)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x44d0e3(0x1a7)]({'oldStatus':_0x44d0e3(0x1c7),'newStatus':_0x52c285[_0x44d0e3(0x1bd)],'transactionId':_0x52c285[_0x44d0e3(0x1b8)],'failureReason':_0x52c285['failureReason'],'processedAt':new Date()[_0x44d0e3(0x1ac)]()})}}),await this[_0x44d0e3(0x1a3)](_0x3d0797,_0x52c285[_0x44d0e3(0x1bd)],_0x52c285[_0x44d0e3(0x1b8)],_0x52c285[_0x44d0e3(0x1c1)]),await this[_0x44d0e3(0x201)](_0x3d0797,_0x52c285[_0x44d0e3(0x1bd)]),console[_0x44d0e3(0x1c5)](_0x44d0e3(0x1af)+_0x5caa7d+'\x20processed:\x20'+_0x52c285[_0x44d0e3(0x1bd)]),_0x52c285[_0x44d0e3(0x1bd)]===_0x44d0e3(0x1d1)?_0x2d0ed5[_0x44d0e3(0x1e9)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x52c285['transactionId'],'redirectUrl':_0x3d0797[_0x44d0e3(0x1d3)]}}):_0x2d0ed5[_0x44d0e3(0x1bd)](0x190)[_0x44d0e3(0x1e9)]({'success':![],'message':_0x44d0e3(0x1e1),'result':{'status':_0x44d0e3(0x1da),'failureReason':_0x52c285[_0x44d0e3(0x1c1)],'redirectUrl':_0x3d0797['failUrl']}});}catch(_0x20c938){_0x2bba8b(_0x20c938);}},this[_0x594a87(0x1b5)]=new testGatewayService_1[(_0x594a87(0x1e3))](),this[_0x594a87(0x1ba)]=new webhookService_1[(_0x594a87(0x1d8))]();}async['sendShopWebhook'](_0x1d98c9,_0x345617,_0x8a8ac9,_0x2959a8){const _0x4a2895=a13_0x21f259,_0x5c36e1=Date[_0x4a2895(0x1d2)]();try{const _0x4bbb86=_0x1d98c9[_0x4a2895(0x1ed)],_0xc9aa22=_0x4bbb86['settings'];if(!_0xc9aa22?.[_0x4a2895(0x1b6)]){console[_0x4a2895(0x1c5)](_0x4a2895(0x1a1)+_0x4bbb86['id']);return;}const _0x389b17=_0x345617===_0x4a2895(0x1d1)?_0x4a2895(0x1f2):_0x4a2895(0x1cb);let _0x3f319a=[];if(_0xc9aa22[_0x4a2895(0x1de)])try{_0x3f319a=Array['isArray'](_0xc9aa22[_0x4a2895(0x1de)])?_0xc9aa22['webhookEvents']:JSON[_0x4a2895(0x1f3)](_0xc9aa22[_0x4a2895(0x1de)]);}catch(_0x283ebe){console['error'](_0x4a2895(0x1f1),_0x283ebe),_0x3f319a=[];}if(!_0x3f319a['includes'](_0x389b17)){console[_0x4a2895(0x1c5)](_0x4a2895(0x1be)+_0x389b17+_0x4a2895(0x1cf)+_0x4bbb86['id']);return;}const _0x4156f8={'event':_0x389b17,'payment':{'id':_0x1d98c9['id'],'order_id':_0x1d98c9[_0x4a2895(0x1e4)],'gateway_order_id':_0x1d98c9[_0x4a2895(0x206)],'gateway':_0x4a2895(0x1d6),'amount':_0x1d98c9[_0x4a2895(0x1e0)],'currency':_0x1d98c9['currency'],'status':_0x345617[_0x4a2895(0x1b3)](),'customer_email':_0x1d98c9[_0x4a2895(0x1c2)],'customer_name':_0x1d98c9[_0x4a2895(0x1f4)],'transaction_id':_0x8a8ac9,'failure_message':_0x2959a8,'created_at':_0x1d98c9[_0x4a2895(0x1a9)],'updated_at':new Date()}},_0x6e0288=await fetch(_0xc9aa22[_0x4a2895(0x1b6)],{'method':_0x4a2895(0x1a2),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x4a2895(0x1a7)](_0x4156f8)}),_0x2d0f20=Date[_0x4a2895(0x1d2)]()-_0x5c36e1;console[_0x4a2895(0x1c5)](_0x4a2895(0x1ee)+_0xc9aa22[_0x4a2895(0x1b6)]+_0x4a2895(0x1dc)+_0x6e0288[_0x4a2895(0x1bd)]+'\x20('+_0x2d0f20+_0x4a2895(0x200));}catch(_0x30f6bb){console[_0x4a2895(0x1bf)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x30f6bb);}}async['sendPaymentStatusNotification'](_0x421b68,_0x377c27){const _0xf8606e=a13_0x21f259;try{const {telegramBotService:_0x40b0a0}=await Promise[_0xf8606e(0x1ef)]()[_0xf8606e(0x1e5)](()=>__importStar(require(_0xf8606e(0x1c4)))),_0x1770b6={'PAID':_0xf8606e(0x19f),'FAILED':_0xf8606e(0x1a6)},_0x23fa2a=_0x1770b6[_0x377c27];if(!_0x23fa2a)return;await _0x40b0a0[_0xf8606e(0x1c6)](_0x421b68['shopId'],_0x421b68,_0x23fa2a);}catch(_0x4706da){console[_0xf8606e(0x1bf)](_0xf8606e(0x1cd),_0x4706da);}}}exports['TestGatewayController']=TestGatewayController;