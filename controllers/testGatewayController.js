'use strict';const a18_0x3b5128=a18_0x297b;(function(_0x5242a0,_0x26e998){const _0x31c2cc=a18_0x297b,_0x4873f7=_0x5242a0();while(!![]){try{const _0xf21d7e=parseInt(_0x31c2cc(0xd5))/0x1*(parseInt(_0x31c2cc(0xc1))/0x2)+-parseInt(_0x31c2cc(0xe8))/0x3+-parseInt(_0x31c2cc(0xd7))/0x4+-parseInt(_0x31c2cc(0xdf))/0x5+-parseInt(_0x31c2cc(0x128))/0x6*(-parseInt(_0x31c2cc(0xce))/0x7)+-parseInt(_0x31c2cc(0x102))/0x8+parseInt(_0x31c2cc(0x122))/0x9;if(_0xf21d7e===_0x26e998)break;else _0x4873f7['push'](_0x4873f7['shift']());}catch(_0x5da5fa){_0x4873f7['push'](_0x4873f7['shift']());}}}(a18_0x86e4,0xd5afb));function a18_0x297b(_0x52f4ec,_0x16cb90){_0x52f4ec=_0x52f4ec-0xba;const _0x86e401=a18_0x86e4();let _0x297b42=_0x86e401[_0x52f4ec];return _0x297b42;}var __createBinding=this&&this[a18_0x3b5128(0x10e)]||(Object['create']?function(_0x4bf7d4,_0x3945bf,_0x214992,_0x558126){const _0x46fec6=a18_0x3b5128;if(_0x558126===undefined)_0x558126=_0x214992;var _0x5a431=Object[_0x46fec6(0xfe)](_0x3945bf,_0x214992);(!_0x5a431||(_0x46fec6(0x134)in _0x5a431?!_0x3945bf[_0x46fec6(0x114)]:_0x5a431['writable']||_0x5a431[_0x46fec6(0xfc)]))&&(_0x5a431={'enumerable':!![],'get':function(){return _0x3945bf[_0x214992];}}),Object[_0x46fec6(0xd3)](_0x4bf7d4,_0x558126,_0x5a431);}:function(_0x2411a1,_0x46e064,_0x5ca297,_0x8a8f0c){if(_0x8a8f0c===undefined)_0x8a8f0c=_0x5ca297;_0x2411a1[_0x8a8f0c]=_0x46e064[_0x5ca297];}),__setModuleDefault=this&&this[a18_0x3b5128(0xbb)]||(Object[a18_0x3b5128(0x12a)]?function(_0x38f4fa,_0xd571aa){const _0x49262a=a18_0x3b5128;Object[_0x49262a(0xd3)](_0x38f4fa,_0x49262a(0xf9),{'enumerable':!![],'value':_0xd571aa});}:function(_0xa8c98f,_0x485e22){const _0x20b284=a18_0x3b5128;_0xa8c98f[_0x20b284(0xf9)]=_0x485e22;}),__importStar=this&&this[a18_0x3b5128(0xd9)]||(function(){var _0x19c505=function(_0x5cf213){const _0x3eb697=a18_0x297b;return _0x19c505=Object[_0x3eb697(0x104)]||function(_0x19eaac){const _0x23db0c=_0x3eb697;var _0x33fa3d=[];for(var _0x26f42d in _0x19eaac)if(Object[_0x23db0c(0x105)][_0x23db0c(0x123)][_0x23db0c(0x109)](_0x19eaac,_0x26f42d))_0x33fa3d[_0x33fa3d['length']]=_0x26f42d;return _0x33fa3d;},_0x19c505(_0x5cf213);};return function(_0x41a4b2){const _0x432ad2=a18_0x297b;if(_0x41a4b2&&_0x41a4b2['__esModule'])return _0x41a4b2;var _0x126c30={};if(_0x41a4b2!=null){for(var _0x131226=_0x19c505(_0x41a4b2),_0x530e8a=0x0;_0x530e8a<_0x131226[_0x432ad2(0x117)];_0x530e8a++)if(_0x131226[_0x530e8a]!==_0x432ad2(0xf9))__createBinding(_0x126c30,_0x41a4b2,_0x131226[_0x530e8a]);}return __setModuleDefault(_0x126c30,_0x41a4b2),_0x126c30;};}()),__importDefault=this&&this[a18_0x3b5128(0x10f)]||function(_0x16dc45){return _0x16dc45&&_0x16dc45['__esModule']?_0x16dc45:{'default':_0x16dc45};};Object[a18_0x3b5128(0xd3)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a18_0x3b5128(0x131)),webhookService_1=require(a18_0x3b5128(0xe7)),database_1=__importDefault(require(a18_0x3b5128(0xef)));class TestGatewayController{constructor(){const _0x2636bb=a18_0x3b5128;this[_0x2636bb(0xcc)]=async(_0x5d75f5,_0x5754bd,_0x9de678)=>{const _0x45347c=_0x2636bb;try{const {paymentId:_0x2281b3}=_0x5d75f5[_0x45347c(0x11b)];console[_0x45347c(0xeb)](_0x45347c(0x11f)+_0x2281b3);const _0x1149e9=await database_1['default']['payment'][_0x45347c(0x127)]({'where':{'id':_0x2281b3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1149e9)return _0x5754bd[_0x45347c(0xe9)](0x194)['json']({'success':![],'message':_0x45347c(0xc5)});if(_0x1149e9[_0x45347c(0xfb)]!==_0x45347c(0xbd))return _0x5754bd[_0x45347c(0xe9)](0x190)['json']({'success':![],'message':_0x45347c(0xd1)});if(_0x1149e9[_0x45347c(0xe9)]!==_0x45347c(0x12f))return _0x5754bd[_0x45347c(0xe9)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1149e9['status']+_0x45347c(0x12e)});_0x5754bd[_0x45347c(0x126)]({'success':!![],'result':{'paymentId':_0x1149e9['id'],'orderId':_0x1149e9[_0x45347c(0xf3)],'amount':_0x1149e9['amount'],'currency':_0x1149e9[_0x45347c(0xd6)],'merchantName':_0x1149e9[_0x45347c(0x124)]['name'],'description':_0x45347c(0x118)+_0x1149e9[_0x45347c(0x124)][_0x45347c(0x11a)],'testInstructions':{'successCard':_0x45347c(0xf6),'failureCard':_0x45347c(0xff),'expiryDate':_0x45347c(0xbc),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x242fce){_0x9de678(_0x242fce);}},this['processCard']=async(_0xeb1559,_0x2a7798,_0x2f9988)=>{const _0x2069b3=_0x2636bb;try{const {paymentId:_0x52a4c5}=_0xeb1559[_0x2069b3(0x11b)],_0x7c1743=_0xeb1559[_0x2069b3(0x130)];console[_0x2069b3(0xeb)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x52a4c5);const _0x4bc047=await database_1['default']['payment'][_0x2069b3(0x127)]({'where':{'id':_0x52a4c5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4bc047)return _0x2a7798[_0x2069b3(0xe9)](0x194)['json']({'success':![],'message':_0x2069b3(0xc5)});if(_0x4bc047[_0x2069b3(0xfb)]!==_0x2069b3(0xbd))return _0x2a7798[_0x2069b3(0xe9)](0x190)[_0x2069b3(0x126)]({'success':![],'message':_0x2069b3(0xd1)});if(_0x4bc047[_0x2069b3(0xe9)]!=='PENDING')return _0x2a7798['status'](0x190)['json']({'success':![],'message':_0x2069b3(0xd4)+_0x4bc047[_0x2069b3(0xe9)]+_0x2069b3(0x12e)});const _0x5ea07e=await this['testGatewayService'][_0x2069b3(0xc7)]({'paymentId':_0x4bc047['id'],'orderId':_0x4bc047[_0x2069b3(0xf3)]||_0x4bc047['id'],'amount':_0x4bc047[_0x2069b3(0xe0)],'currency':_0x4bc047['currency'],'cardData':_0x7c1743});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x5ea07e);const _0x372056={'status':_0x5ea07e[_0x2069b3(0xe9)],'updatedAt':new Date()};if(_0x5ea07e[_0x2069b3(0xe9)]===_0x2069b3(0xe2))_0x372056[_0x2069b3(0x13a)]=new Date(),_0x372056['gatewayPaymentId']=_0x5ea07e[_0x2069b3(0x11e)];else _0x5ea07e[_0x2069b3(0xe9)]===_0x2069b3(0xd0)&&(_0x372056[_0x2069b3(0xec)]=_0x5ea07e[_0x2069b3(0xe5)]);const _0x9c4c02=_0x7c1743[_0x2069b3(0xe4)][_0x2069b3(0xc9)](/[\s-]/g,'');_0x372056[_0x2069b3(0x113)]=_0x9c4c02[_0x2069b3(0x129)](-0x4),_0x372056[_0x2069b3(0xe1)]=_0x2069b3(0xcf),await database_1[_0x2069b3(0xf9)]['payment'][_0x2069b3(0x106)]({'where':{'id':_0x4bc047['id']},'data':_0x372056});if(_0x5ea07e[_0x2069b3(0xe9)]===_0x2069b3(0xe2)&&_0x4bc047[_0x2069b3(0xca)]){console['log'](_0x2069b3(0xfd)+_0x4bc047['id']+_0x2069b3(0xc2));try{await database_1[_0x2069b3(0xf9)][_0x2069b3(0x116)](async _0x24ad24=>{const _0x5c81e1=_0x2069b3,_0x104c3e=await _0x24ad24['paymentLink'][_0x5c81e1(0x127)]({'where':{'id':_0x4bc047[_0x5c81e1(0xca)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x104c3e){console[_0x5c81e1(0xeb)](_0x5c81e1(0x107)+_0x104c3e['id']+_0x5c81e1(0x111)+_0x104c3e[_0x5c81e1(0x138)]+_0x5c81e1(0x103)+_0x104c3e[_0x5c81e1(0x133)]+_0x5c81e1(0xd8)+_0x104c3e['status']);const _0x175405=_0x104c3e[_0x5c81e1(0x133)]+0x1,_0x489341=_0x104c3e['type']===_0x5c81e1(0xcd)?_0x5c81e1(0x119):_0x104c3e[_0x5c81e1(0xe9)];await _0x24ad24[_0x5c81e1(0xf0)][_0x5c81e1(0x106)]({'where':{'id':_0x4bc047[_0x5c81e1(0xca)]},'data':{'currentPayments':_0x175405,'status':_0x489341,'updatedAt':new Date()}}),console['log'](_0x5c81e1(0xf2)+_0x104c3e['id']+_0x5c81e1(0xc0)+_0x104c3e['currentPayments']+_0x5c81e1(0xe3)+_0x175405+_0x5c81e1(0xd8)+_0x104c3e[_0x5c81e1(0xe9)]+_0x5c81e1(0xe3)+_0x489341);}else console[_0x5c81e1(0xeb)](_0x5c81e1(0xf4)+_0x4bc047[_0x5c81e1(0xca)]+_0x5c81e1(0x132));});}catch(_0x6f5faa){console[_0x2069b3(0xed)](_0x2069b3(0xe6),_0x6f5faa);}}await database_1[_0x2069b3(0xf9)][_0x2069b3(0xf8)][_0x2069b3(0x12a)]({'data':{'paymentId':_0x4bc047['id'],'shopId':_0x4bc047['shopId'],'event':_0x2069b3(0x10c)+_0x5ea07e[_0x2069b3(0xe9)][_0x2069b3(0xc8)](),'statusCode':0xc8,'responseBody':JSON[_0x2069b3(0xbf)]({'oldStatus':_0x2069b3(0x12f),'newStatus':_0x5ea07e[_0x2069b3(0xe9)],'transactionId':_0x5ea07e['transactionId'],'failureReason':_0x5ea07e[_0x2069b3(0xe5)],'processedAt':new Date()[_0x2069b3(0x10a)]()})}}),await this[_0x2069b3(0xc3)](_0x4bc047,_0x5ea07e[_0x2069b3(0xe9)],_0x5ea07e[_0x2069b3(0x11e)],_0x5ea07e['failureReason']),await this[_0x2069b3(0x10d)](_0x4bc047,_0x5ea07e[_0x2069b3(0xe9)]),console[_0x2069b3(0xeb)](_0x2069b3(0xf1)+_0x52a4c5+_0x2069b3(0x115)+_0x5ea07e[_0x2069b3(0xe9)]),_0x5ea07e['status']===_0x2069b3(0xe2)?_0x2a7798['json']({'success':!![],'message':_0x2069b3(0xfa),'result':{'status':_0x2069b3(0xe2),'transactionId':_0x5ea07e[_0x2069b3(0x11e)],'redirectUrl':_0x4bc047[_0x2069b3(0x12b)]}}):_0x2a7798[_0x2069b3(0xe9)](0x190)[_0x2069b3(0x126)]({'success':![],'message':_0x2069b3(0xea),'result':{'status':_0x2069b3(0xd0),'failureReason':_0x5ea07e[_0x2069b3(0xe5)],'redirectUrl':_0x4bc047[_0x2069b3(0x125)]}});}catch(_0x1c3fd2){_0x2f9988(_0x1c3fd2);}},this[_0x2636bb(0x108)]=new testGatewayService_1[(_0x2636bb(0xdb))](),this[_0x2636bb(0x110)]=new webhookService_1[(_0x2636bb(0xda))]();}async['sendShopWebhook'](_0x1dd652,_0x433f76,_0x31c110,_0x50bcef){const _0xed618d=a18_0x3b5128,_0xf92732=Date[_0xed618d(0x100)]();try{const _0x22ee8a=_0x1dd652['shop'],_0x5293b0=_0x22ee8a[_0xed618d(0x101)];if(!_0x5293b0?.[_0xed618d(0x137)]){console['log'](_0xed618d(0xcb)+_0x22ee8a['id']);return;}const _0x82fa8e=_0x433f76===_0xed618d(0xe2)?'payment.success':_0xed618d(0x12d);let _0x52c215=[];if(_0x5293b0[_0xed618d(0x121)])try{_0x52c215=Array['isArray'](_0x5293b0[_0xed618d(0x121)])?_0x5293b0[_0xed618d(0x121)]:JSON['parse'](_0x5293b0['webhookEvents']);}catch(_0x21df93){console[_0xed618d(0xed)](_0xed618d(0xd2),_0x21df93),_0x52c215=[];}if(!_0x52c215[_0xed618d(0x10b)](_0x82fa8e)){console[_0xed618d(0xeb)](_0xed618d(0xf7)+_0x82fa8e+_0xed618d(0xdd)+_0x22ee8a['id']);return;}const _0x5b225a={'event':_0x82fa8e,'payment':{'id':_0x1dd652['id'],'order_id':_0x1dd652[_0xed618d(0xba)],'gateway_order_id':_0x1dd652[_0xed618d(0xf3)],'gateway':_0xed618d(0x136),'amount':_0x1dd652[_0xed618d(0xe0)],'currency':_0x1dd652[_0xed618d(0xd6)],'status':_0x433f76[_0xed618d(0xc8)](),'customer_email':_0x1dd652[_0xed618d(0x112)],'customer_name':_0x1dd652[_0xed618d(0x139)],'transaction_id':_0x31c110,'failure_message':_0x50bcef,'created_at':_0x1dd652[_0xed618d(0xc6)],'updated_at':new Date()}},_0x444da3=await fetch(_0x5293b0[_0xed618d(0x137)],{'method':_0xed618d(0x12c),'headers':{'Content-Type':_0xed618d(0xc4),'User-Agent':_0xed618d(0xde)},'body':JSON[_0xed618d(0xbf)](_0x5b225a)}),_0x3d3cc0=Date[_0xed618d(0x100)]()-_0xf92732;console[_0xed618d(0xeb)](_0xed618d(0x11c)+_0x5293b0[_0xed618d(0x137)]+'\x20with\x20status\x20'+_0x444da3['status']+'\x20('+_0x3d3cc0+_0xed618d(0xf5));}catch(_0x1f6628){console['error'](_0xed618d(0xdc),_0x1f6628);}}async[a18_0x3b5128(0x10d)](_0x13a0fb,_0x3555f7){const _0x38c5e8=a18_0x3b5128;try{const {telegramBotService:_0x5cdd3f}=await Promise['resolve']()[_0x38c5e8(0xbe)](()=>__importStar(require(_0x38c5e8(0x11d)))),_0x57a505={'PAID':'paid','FAILED':_0x38c5e8(0x135)},_0x140af6=_0x57a505[_0x3555f7];if(!_0x140af6)return;await _0x5cdd3f['sendPaymentNotification'](_0x13a0fb[_0x38c5e8(0x120)],_0x13a0fb,_0x140af6);}catch(_0x94bd73){console[_0x38c5e8(0xed)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x94bd73);}}}exports[a18_0x3b5128(0xee)]=TestGatewayController;function a18_0x86e4(){const _0x5d1b60=['name','params','Test\x20Gateway\x20webhook\x20sent\x20to\x20','../services/telegramBotService','transactionId','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','shopId','webhookEvents','12701511PeVRyy','hasOwnProperty','shop','failUrl','json','findUnique','19338aIKfEc','slice','create','successUrl','POST','payment.failed',',\x20cannot\x20process','PENDING','body','../services/gateways/testGatewayService','\x20not\x20found','currentPayments','get','failed','0000','webhookUrl','type','customerName','paidAt','orderId','__setModuleDefault','Any\x20future\x20date\x20(MM/YY)','test_gateway','then','stringify','\x20updated:\x20currentPayments=','118dVyHnL','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','sendShopWebhook','application/json','Payment\x20not\x20found','createdAt','processCardPayment','toLowerCase','replace','paymentLinkId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getPaymentForm','SINGLE','1673UHAZqw','test_card','FAILED','Payment\x20is\x20not\x20for\x20test\x20gateway','Error\x20parsing\x20webhook\x20events:','defineProperty','Payment\x20status\x20is\x20','21695FAaSqQ','currency','2846180XMfJiP',',\x20status=','__importStar','WebhookService','TestGatewayService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','712305RiFmMq','amount','paymentMethod','PAID','\x20->\x20','cardNumber','failureReason','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','../services/webhookService','5163102qChXZZ','status','Payment\x20failed','log','failureMessage','error','TestGatewayController','../config/database','paymentLink','‚úÖ\x20Test\x20Gateway\x20payment\x20','‚úÖ\x20Payment\x20link\x20','gatewayOrderId','‚ùå\x20Payment\x20link\x20','ms)','4242\x204242\x204242\x204242','Webhook\x20event\x20','webhookLog','default','Payment\x20processed\x20successfully','gateway','configurable','üìà\x20Test\x20Gateway:\x20Payment\x20','getOwnPropertyDescriptor','Any\x20other\x20card\x20number','now','settings','90256hmzUsB',',\x20currentPayments=','getOwnPropertyNames','prototype','update','üìà\x20Found\x20payment\x20link\x20','testGatewayService','call','toISOString','includes','test_gateway_','sendPaymentStatusNotification','__createBinding','__importDefault','webhookService',':\x20type=','customerEmail','cardLast4','__esModule','\x20processed:\x20','$transaction','length','Payment\x20to\x20','COMPLETED'];a18_0x86e4=function(){return _0x5d1b60;};return a18_0x86e4();}