'use strict';const a14_0x27ac39=a14_0x5289;(function(_0x26f92b,_0x527eb5){const _0xa0350d=a14_0x5289,_0x229d22=_0x26f92b();while(!![]){try{const _0x56157a=parseInt(_0xa0350d(0x1a7))/0x1+parseInt(_0xa0350d(0x1e0))/0x2*(-parseInt(_0xa0350d(0x1d9))/0x3)+-parseInt(_0xa0350d(0x1da))/0x4*(-parseInt(_0xa0350d(0x1c4))/0x5)+parseInt(_0xa0350d(0x19d))/0x6+-parseInt(_0xa0350d(0x1d8))/0x7+parseInt(_0xa0350d(0x1fd))/0x8+-parseInt(_0xa0350d(0x1b3))/0x9*(parseInt(_0xa0350d(0x1a9))/0xa);if(_0x56157a===_0x527eb5)break;else _0x229d22['push'](_0x229d22['shift']());}catch(_0x5ef4ba){_0x229d22['push'](_0x229d22['shift']());}}}(a14_0x4002,0xf06f4));function a14_0x5289(_0x3b7b47,_0xd155a3){const _0x4002ca=a14_0x4002();return a14_0x5289=function(_0x5289a4,_0x271089){_0x5289a4=_0x5289a4-0x197;let _0x38b140=_0x4002ca[_0x5289a4];return _0x38b140;},a14_0x5289(_0x3b7b47,_0xd155a3);}var __createBinding=this&&this['__createBinding']||(Object[a14_0x27ac39(0x19b)]?function(_0x46f7a2,_0x40384e,_0x23348b,_0xebde70){const _0x200c16=a14_0x27ac39;if(_0xebde70===undefined)_0xebde70=_0x23348b;var _0x38b8b1=Object[_0x200c16(0x1cf)](_0x40384e,_0x23348b);(!_0x38b8b1||('get'in _0x38b8b1?!_0x40384e[_0x200c16(0x1cb)]:_0x38b8b1['writable']||_0x38b8b1[_0x200c16(0x20b)]))&&(_0x38b8b1={'enumerable':!![],'get':function(){return _0x40384e[_0x23348b];}}),Object[_0x200c16(0x20c)](_0x46f7a2,_0xebde70,_0x38b8b1);}:function(_0x2c4653,_0x1d9c9f,_0x213d99,_0x3cbf6e){if(_0x3cbf6e===undefined)_0x3cbf6e=_0x213d99;_0x2c4653[_0x3cbf6e]=_0x1d9c9f[_0x213d99];}),__setModuleDefault=this&&this[a14_0x27ac39(0x1bd)]||(Object[a14_0x27ac39(0x19b)]?function(_0xe9904d,_0x3dd6fe){const _0x13f490=a14_0x27ac39;Object[_0x13f490(0x20c)](_0xe9904d,_0x13f490(0x1be),{'enumerable':!![],'value':_0x3dd6fe});}:function(_0x32a849,_0x5d0518){const _0xbb26e6=a14_0x27ac39;_0x32a849[_0xbb26e6(0x1be)]=_0x5d0518;}),__importStar=this&&this[a14_0x27ac39(0x1a1)]||(function(){var _0x291b36=function(_0x22ac8b){const _0x4ba54=a14_0x5289;return _0x291b36=Object[_0x4ba54(0x1ee)]||function(_0x16c985){const _0x21ebd8=_0x4ba54;var _0x2d28a3=[];for(var _0x1d9d1f in _0x16c985)if(Object[_0x21ebd8(0x1c7)][_0x21ebd8(0x1e2)]['call'](_0x16c985,_0x1d9d1f))_0x2d28a3[_0x2d28a3[_0x21ebd8(0x1fc)]]=_0x1d9d1f;return _0x2d28a3;},_0x291b36(_0x22ac8b);};return function(_0xaea1c4){const _0x323f1=a14_0x5289;if(_0xaea1c4&&_0xaea1c4['__esModule'])return _0xaea1c4;var _0x14343d={};if(_0xaea1c4!=null){for(var _0x5276f9=_0x291b36(_0xaea1c4),_0x233fc4=0x0;_0x233fc4<_0x5276f9['length'];_0x233fc4++)if(_0x5276f9[_0x233fc4]!==_0x323f1(0x1be))__createBinding(_0x14343d,_0xaea1c4,_0x5276f9[_0x233fc4]);}return __setModuleDefault(_0x14343d,_0xaea1c4),_0x14343d;};}()),__importDefault=this&&this[a14_0x27ac39(0x1ed)]||function(_0x278ab7){return _0x278ab7&&_0x278ab7['__esModule']?_0x278ab7:{'default':_0x278ab7};};Object[a14_0x27ac39(0x20c)](exports,'__esModule',{'value':!![]}),exports[a14_0x27ac39(0x1e7)]=void 0x0;function a14_0x4002(){const _0x573a45=['paymentLink',',\x20status=','✅\x20Payment\x20link\x20','error','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','45jcZfom','customerName','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','resolve','slice','currentPayments','sendShopWebhook','status','payment','amount','__setModuleDefault','default','settings','toLowerCase','📈\x20Found\x20payment\x20link\x20','stringify','ms)','1815qswhtP','Payment\x20processed\x20successfully',':\x20type=','prototype','gatewayOrderId','failed','webhookLog','__esModule','❌\x20Payment\x20link\x20','✅\x20Test\x20Gateway\x20payment\x20','../services/gateways/testGatewayService','getOwnPropertyDescriptor','processCardPayment','testGatewayService','transactionId','replace','paidAt',',\x20currentPayments=',',\x20cannot\x20process','isArray','7542248WtYxhN','111EFnoGe','1020rGZFHV','Payment\x20to\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','createdAt','findUnique','Payment\x20not\x20found','48242avRhuB','paymentLinkId','hasOwnProperty','Any\x20future\x20date\x20(MM/YY)','currency','failureMessage','payment.success','TestGatewayController','Any\x20other\x20card\x20number','successUrl','includes','Webhook\x20event\x20','orderId','__importDefault','getOwnPropertyNames','Any\x20name','processCard','../services/telegramBotService','failureReason','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookEvents','failUrl','\x20processed:\x20','now','FAILED','PAID','\x20with\x20status\x20','payment.failed','length','4583040NoCSxH','\x20->\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','../services/webhookService','log','cardLast4','then','webhookUrl','shop','0000','shopId','test_gateway','SINGLE','📈\x20Test\x20Gateway:\x20Payment\x20','configurable','defineProperty','json','name','Any\x203-4\x20digits','PENDING','webhookService','create','TestGatewayService','9102960QiUkVC','POST','test_card','update','__importStar','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','gateway','sendPaymentNotification','params','Payment\x20status\x20is\x20','1502141xBglcc','4242\x204242\x204242\x204242','1459970TNVUbM','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','type'];a14_0x4002=function(){return _0x573a45;};return a14_0x4002();}const testGatewayService_1=require(a14_0x27ac39(0x1ce)),webhookService_1=require(a14_0x27ac39(0x200)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x17c2d=a14_0x27ac39;this['getPaymentForm']=async(_0x1e1812,_0x2ad2ce,_0x5bb443)=>{const _0x354412=a14_0x5289;try{const {paymentId:_0x537de9}=_0x1e1812['params'];console[_0x354412(0x201)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x537de9);const _0x5c55e9=await database_1[_0x354412(0x1be)][_0x354412(0x1bb)][_0x354412(0x1de)]({'where':{'id':_0x537de9},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5c55e9)return _0x2ad2ce[_0x354412(0x1ba)](0x194)[_0x354412(0x20d)]({'success':![],'message':_0x354412(0x1df)});if(_0x5c55e9[_0x354412(0x1a3)]!=='test_gateway')return _0x2ad2ce[_0x354412(0x1ba)](0x190)[_0x354412(0x20d)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5c55e9[_0x354412(0x1ba)]!==_0x354412(0x199))return _0x2ad2ce[_0x354412(0x1ba)](0x190)[_0x354412(0x20d)]({'success':![],'message':_0x354412(0x1a6)+_0x5c55e9[_0x354412(0x1ba)]+_0x354412(0x1d6)});_0x2ad2ce[_0x354412(0x20d)]({'success':!![],'result':{'paymentId':_0x5c55e9['id'],'orderId':_0x5c55e9[_0x354412(0x1c8)],'amount':_0x5c55e9[_0x354412(0x1bc)],'currency':_0x5c55e9[_0x354412(0x1e4)],'merchantName':_0x5c55e9['shop']['name'],'description':_0x354412(0x1db)+_0x5c55e9[_0x354412(0x205)][_0x354412(0x197)],'testInstructions':{'successCard':_0x354412(0x1a8),'failureCard':_0x354412(0x1e8),'expiryDate':_0x354412(0x1e3),'cvc':_0x354412(0x198),'holderName':_0x354412(0x1ef)}}});}catch(_0x58a636){_0x5bb443(_0x58a636);}},this[_0x17c2d(0x1f0)]=async(_0x51d151,_0x787715,_0x828c83)=>{const _0x4abf16=_0x17c2d;try{const {paymentId:_0x50f98d}=_0x51d151[_0x4abf16(0x1a5)],_0x46bd25=_0x51d151['body'];console[_0x4abf16(0x201)](_0x4abf16(0x1b2)+_0x50f98d);const _0x28889d=await database_1['default'][_0x4abf16(0x1bb)][_0x4abf16(0x1de)]({'where':{'id':_0x50f98d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x28889d)return _0x787715[_0x4abf16(0x1ba)](0x194)[_0x4abf16(0x20d)]({'success':![],'message':_0x4abf16(0x1df)});if(_0x28889d[_0x4abf16(0x1a3)]!==_0x4abf16(0x208))return _0x787715[_0x4abf16(0x1ba)](0x190)[_0x4abf16(0x20d)]({'success':![],'message':_0x4abf16(0x1aa)});if(_0x28889d[_0x4abf16(0x1ba)]!=='PENDING')return _0x787715[_0x4abf16(0x1ba)](0x190)['json']({'success':![],'message':_0x4abf16(0x1a6)+_0x28889d[_0x4abf16(0x1ba)]+_0x4abf16(0x1d6)});const _0x511ab1=await this['testGatewayService'][_0x4abf16(0x1d0)]({'paymentId':_0x28889d['id'],'orderId':_0x28889d['gatewayOrderId']||_0x28889d['id'],'amount':_0x28889d[_0x4abf16(0x1bc)],'currency':_0x28889d[_0x4abf16(0x1e4)],'cardData':_0x46bd25});console[_0x4abf16(0x201)]('🧪\x20Test\x20Gateway\x20result:',_0x511ab1);const _0x347e1f={'status':_0x511ab1[_0x4abf16(0x1ba)],'updatedAt':new Date()};if(_0x511ab1['status']==='PAID')_0x347e1f[_0x4abf16(0x1d4)]=new Date(),_0x347e1f['gatewayPaymentId']=_0x511ab1[_0x4abf16(0x1d2)];else _0x511ab1[_0x4abf16(0x1ba)]===_0x4abf16(0x1f8)&&(_0x347e1f[_0x4abf16(0x1e5)]=_0x511ab1[_0x4abf16(0x1f2)]);const _0x1e9d89=_0x46bd25['cardNumber'][_0x4abf16(0x1d3)](/[\s-]/g,'');_0x347e1f[_0x4abf16(0x202)]=_0x1e9d89[_0x4abf16(0x1b7)](-0x4),_0x347e1f['paymentMethod']=_0x4abf16(0x19f),await database_1[_0x4abf16(0x1be)][_0x4abf16(0x1bb)]['update']({'where':{'id':_0x28889d['id']},'data':_0x347e1f});if(_0x511ab1[_0x4abf16(0x1ba)]==='PAID'&&_0x28889d[_0x4abf16(0x1e1)]){console[_0x4abf16(0x201)](_0x4abf16(0x20a)+_0x28889d['id']+_0x4abf16(0x1dc));try{await database_1['default']['$transaction'](async _0xdfd929=>{const _0x4f6df2=_0x4abf16,_0x12921e=await _0xdfd929[_0x4f6df2(0x1ad)][_0x4f6df2(0x1de)]({'where':{'id':_0x28889d['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x12921e){console[_0x4f6df2(0x201)](_0x4f6df2(0x1c1)+_0x12921e['id']+_0x4f6df2(0x1c6)+_0x12921e[_0x4f6df2(0x1ac)]+_0x4f6df2(0x1d5)+_0x12921e['currentPayments']+_0x4f6df2(0x1ae)+_0x12921e['status']);const _0x3b2de9=_0x12921e[_0x4f6df2(0x1b8)]+0x1,_0x48eec9=_0x12921e['type']===_0x4f6df2(0x209)?'COMPLETED':_0x12921e[_0x4f6df2(0x1ba)];await _0xdfd929[_0x4f6df2(0x1ad)][_0x4f6df2(0x1a0)]({'where':{'id':_0x28889d['paymentLinkId']},'data':{'currentPayments':_0x3b2de9,'status':_0x48eec9,'updatedAt':new Date()}}),console[_0x4f6df2(0x201)](_0x4f6df2(0x1af)+_0x12921e['id']+'\x20updated:\x20currentPayments='+_0x12921e['currentPayments']+_0x4f6df2(0x1fe)+_0x3b2de9+_0x4f6df2(0x1ae)+_0x12921e[_0x4f6df2(0x1ba)]+'\x20->\x20'+_0x48eec9);}else console[_0x4f6df2(0x201)](_0x4f6df2(0x1cc)+_0x28889d[_0x4f6df2(0x1e1)]+'\x20not\x20found');});}catch(_0x1855ca){console['error'](_0x4abf16(0x1b5),_0x1855ca);}}await database_1['default'][_0x4abf16(0x1ca)]['create']({'data':{'paymentId':_0x28889d['id'],'shopId':_0x28889d[_0x4abf16(0x207)],'event':_0x4abf16(0x1ab)+_0x511ab1[_0x4abf16(0x1ba)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4abf16(0x199),'newStatus':_0x511ab1[_0x4abf16(0x1ba)],'transactionId':_0x511ab1[_0x4abf16(0x1d2)],'failureReason':_0x511ab1['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x4abf16(0x1b9)](_0x28889d,_0x511ab1[_0x4abf16(0x1ba)],_0x511ab1[_0x4abf16(0x1d2)],_0x511ab1['failureReason']),await this['sendPaymentStatusNotification'](_0x28889d,_0x511ab1['status']),console[_0x4abf16(0x201)](_0x4abf16(0x1cd)+_0x50f98d+_0x4abf16(0x1f6)+_0x511ab1[_0x4abf16(0x1ba)]),_0x511ab1[_0x4abf16(0x1ba)]===_0x4abf16(0x1f9)?_0x787715[_0x4abf16(0x20d)]({'success':!![],'message':_0x4abf16(0x1c5),'result':{'status':_0x4abf16(0x1f9),'transactionId':_0x511ab1[_0x4abf16(0x1d2)],'redirectUrl':_0x28889d[_0x4abf16(0x1e9)]}}):_0x787715['status'](0x190)[_0x4abf16(0x20d)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x4abf16(0x1f8),'failureReason':_0x511ab1['failureReason'],'redirectUrl':_0x28889d[_0x4abf16(0x1f5)]}});}catch(_0x116f22){_0x828c83(_0x116f22);}},this[_0x17c2d(0x1d1)]=new testGatewayService_1[(_0x17c2d(0x19c))](),this[_0x17c2d(0x19a)]=new webhookService_1['WebhookService']();}async[a14_0x27ac39(0x1b9)](_0x354b3f,_0x849b34,_0x3e30d5,_0x17ea28){const _0x2c427e=a14_0x27ac39,_0x3bf910=Date[_0x2c427e(0x1f7)]();try{const _0x5dfd4c=_0x354b3f['shop'],_0x4f7cc9=_0x5dfd4c[_0x2c427e(0x1bf)];if(!_0x4f7cc9?.[_0x2c427e(0x204)]){console[_0x2c427e(0x201)](_0x2c427e(0x1b1)+_0x5dfd4c['id']);return;}const _0x574df3=_0x849b34==='PAID'?_0x2c427e(0x1e6):_0x2c427e(0x1fb);let _0x2f3c48=[];if(_0x4f7cc9['webhookEvents'])try{_0x2f3c48=Array[_0x2c427e(0x1d7)](_0x4f7cc9[_0x2c427e(0x1f4)])?_0x4f7cc9['webhookEvents']:JSON['parse'](_0x4f7cc9[_0x2c427e(0x1f4)]);}catch(_0x1e0933){console['error']('Error\x20parsing\x20webhook\x20events:',_0x1e0933),_0x2f3c48=[];}if(!_0x2f3c48[_0x2c427e(0x1ea)](_0x574df3)){console[_0x2c427e(0x201)](_0x2c427e(0x1eb)+_0x574df3+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5dfd4c['id']);return;}const _0x3a1ab9={'event':_0x574df3,'payment':{'id':_0x354b3f['id'],'order_id':_0x354b3f[_0x2c427e(0x1ec)],'gateway_order_id':_0x354b3f[_0x2c427e(0x1c8)],'gateway':_0x2c427e(0x206),'amount':_0x354b3f['amount'],'currency':_0x354b3f['currency'],'status':_0x849b34[_0x2c427e(0x1c0)](),'customer_email':_0x354b3f['customerEmail'],'customer_name':_0x354b3f[_0x2c427e(0x1b4)],'transaction_id':_0x3e30d5,'failure_message':_0x17ea28,'created_at':_0x354b3f[_0x2c427e(0x1dd)],'updated_at':new Date()}},_0x4745c2=await fetch(_0x4f7cc9[_0x2c427e(0x204)],{'method':_0x2c427e(0x19e),'headers':{'Content-Type':'application/json','User-Agent':_0x2c427e(0x1a2)},'body':JSON[_0x2c427e(0x1c2)](_0x3a1ab9)}),_0x1438d0=Date[_0x2c427e(0x1f7)]()-_0x3bf910;console[_0x2c427e(0x201)](_0x2c427e(0x1ff)+_0x4f7cc9[_0x2c427e(0x204)]+_0x2c427e(0x1fa)+_0x4745c2[_0x2c427e(0x1ba)]+'\x20('+_0x1438d0+_0x2c427e(0x1c3));}catch(_0x468ac8){console[_0x2c427e(0x1b0)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x468ac8);}}async['sendPaymentStatusNotification'](_0x5478ce,_0x134f70){const _0x5cf6f5=a14_0x27ac39;try{const {telegramBotService:_0x3ad538}=await Promise[_0x5cf6f5(0x1b6)]()[_0x5cf6f5(0x203)](()=>__importStar(require(_0x5cf6f5(0x1f1)))),_0x5d27ad={'PAID':'paid','FAILED':_0x5cf6f5(0x1c9)},_0x37c2c6=_0x5d27ad[_0x134f70];if(!_0x37c2c6)return;await _0x3ad538[_0x5cf6f5(0x1a4)](_0x5478ce[_0x5cf6f5(0x207)],_0x5478ce,_0x37c2c6);}catch(_0x264a86){console['error'](_0x5cf6f5(0x1f3),_0x264a86);}}}exports[a14_0x27ac39(0x1e7)]=TestGatewayController;