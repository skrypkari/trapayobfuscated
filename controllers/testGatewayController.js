'use strict';const a13_0x26b118=a13_0x51e7;(function(_0x448b13,_0x24ce5e){const _0x5528f1=a13_0x51e7,_0xc87948=_0x448b13();while(!![]){try{const _0x634e0d=-parseInt(_0x5528f1(0x127))/0x1*(-parseInt(_0x5528f1(0xd9))/0x2)+parseInt(_0x5528f1(0x123))/0x3*(-parseInt(_0x5528f1(0xbd))/0x4)+-parseInt(_0x5528f1(0xda))/0x5+parseInt(_0x5528f1(0x11a))/0x6*(-parseInt(_0x5528f1(0x11b))/0x7)+-parseInt(_0x5528f1(0xaa))/0x8*(parseInt(_0x5528f1(0xab))/0x9)+-parseInt(_0x5528f1(0xc1))/0xa+parseInt(_0x5528f1(0xd6))/0xb*(parseInt(_0x5528f1(0xae))/0xc);if(_0x634e0d===_0x24ce5e)break;else _0xc87948['push'](_0xc87948['shift']());}catch(_0x12c41f){_0xc87948['push'](_0xc87948['shift']());}}}(a13_0x1ed6,0xa45a5));function a13_0x51e7(_0x527d8c,_0x290d5){const _0x1ed6e2=a13_0x1ed6();return a13_0x51e7=function(_0x51e756,_0x3af5aa){_0x51e756=_0x51e756-0xa9;let _0x3bdc7b=_0x1ed6e2[_0x51e756];return _0x3bdc7b;},a13_0x51e7(_0x527d8c,_0x290d5);}function a13_0x1ed6(){const _0x118dd1=['payment.failed','__importStar','isArray','sendShopWebhook','gatewayOrderId','4647304dwhBPT','paid','gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','396080AWpMZU','toISOString','createdAt','failed','parse','PAID','slice','‚ùå\x20Payment\x20link\x20','getOwnPropertyDescriptor','Payment\x20failed','../config/database','webhookLog','\x20updated:\x20currentPayments=','now','status','üìà\x20Test\x20Gateway:\x20Payment\x20','testGatewayService','paymentLinkId','get','test_gateway','__createBinding','77rJgjmu','0000','\x20->\x20','4ehADJG','5967590mdHEqD','payment','SINGLE','amount','Payment\x20not\x20found','create','processCardPayment','../services/gateways/testGatewayService','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','üß™\x20Test\x20Gateway\x20result:','Any\x20future\x20date\x20(MM/YY)','__importDefault','resolve','shop','failureMessage','update','findUnique','Payment\x20processed\x20successfully','Test\x20Gateway\x20webhook\x20sent\x20to\x20','FAILED','../services/webhookService',',\x20currentPayments=','includes','ms)','toLowerCase','payment.success','prototype','json','4242\x204242\x204242\x204242','getPaymentForm','transactionId','PENDING','successUrl','writable','../services/telegramBotService','paymentMethod','customerName','stringify','webhookUrl',',\x20status=','Payment\x20status\x20is\x20','‚úÖ\x20Payment\x20link\x20','default','hasOwnProperty','application/json','webhookService','configurable','cardLast4','Any\x20name','\x20with\x20status\x20','TestGatewayService','paidAt','sendPaymentStatusNotification','WebhookService','failureReason','name','webhookEvents','params','error','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cardNumber','__esModule','shopId','currency','6RiZSDj','7676683PMBLFP','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gatewayPaymentId','\x20not\x20enabled\x20for\x20shop\x20','\x20not\x20found','currentPayments','Webhook\x20event\x20','üìà\x20Found\x20payment\x20link\x20','3DnRyCD','processCard','type','log','381516fqzGJp','\x20processed:\x20','test_gateway_','7156280gQlHPJ','9nFfZDZ',',\x20cannot\x20process','Any\x203-4\x20digits','7365108rgfgyL','Payment\x20to\x20','TestGatewayController','replace','failUrl','defineProperty','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','orderId','length','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'];a13_0x1ed6=function(){return _0x118dd1;};return a13_0x1ed6();}var __createBinding=this&&this[a13_0x26b118(0xd5)]||(Object[a13_0x26b118(0xdf)]?function(_0x27d8d4,_0x4ed8ec,_0x36e37c,_0x571c8a){const _0x5287de=a13_0x26b118;if(_0x571c8a===undefined)_0x571c8a=_0x36e37c;var _0xfb3a11=Object[_0x5287de(0xc9)](_0x4ed8ec,_0x36e37c);(!_0xfb3a11||(_0x5287de(0xd3)in _0xfb3a11?!_0x4ed8ec[_0x5287de(0x117)]:_0xfb3a11[_0x5287de(0xfb)]||_0xfb3a11[_0x5287de(0x108)]))&&(_0xfb3a11={'enumerable':!![],'get':function(){return _0x4ed8ec[_0x36e37c];}}),Object[_0x5287de(0xb3)](_0x27d8d4,_0x571c8a,_0xfb3a11);}:function(_0x3f2fca,_0x226c23,_0x443125,_0x128ca8){if(_0x128ca8===undefined)_0x128ca8=_0x443125;_0x3f2fca[_0x128ca8]=_0x226c23[_0x443125];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x58c5a3,_0x9c2a7e){const _0x4c8fea=a13_0x26b118;Object[_0x4c8fea(0xb3)](_0x58c5a3,'default',{'enumerable':!![],'value':_0x9c2a7e});}:function(_0x2053b2,_0x12db37){const _0x316f75=a13_0x26b118;_0x2053b2[_0x316f75(0x104)]=_0x12db37;}),__importStar=this&&this[a13_0x26b118(0xb9)]||(function(){var _0x127c30=function(_0x3767dc){return _0x127c30=Object['getOwnPropertyNames']||function(_0x3c2cf0){const _0x71c4a6=a13_0x51e7;var _0x5e3818=[];for(var _0x653ad1 in _0x3c2cf0)if(Object[_0x71c4a6(0xf4)][_0x71c4a6(0x105)]['call'](_0x3c2cf0,_0x653ad1))_0x5e3818[_0x5e3818[_0x71c4a6(0xb6)]]=_0x653ad1;return _0x5e3818;},_0x127c30(_0x3767dc);};return function(_0x3781a7){const _0x115dc8=a13_0x51e7;if(_0x3781a7&&_0x3781a7[_0x115dc8(0x117)])return _0x3781a7;var _0x48191a={};if(_0x3781a7!=null){for(var _0xa4ebaf=_0x127c30(_0x3781a7),_0x4ad587=0x0;_0x4ad587<_0xa4ebaf[_0x115dc8(0xb6)];_0x4ad587++)if(_0xa4ebaf[_0x4ad587]!==_0x115dc8(0x104))__createBinding(_0x48191a,_0x3781a7,_0xa4ebaf[_0x4ad587]);}return __setModuleDefault(_0x48191a,_0x3781a7),_0x48191a;};}()),__importDefault=this&&this[a13_0x26b118(0xe5)]||function(_0x1d5390){return _0x1d5390&&_0x1d5390['__esModule']?_0x1d5390:{'default':_0x1d5390};};Object[a13_0x26b118(0xb3)](exports,a13_0x26b118(0x117),{'value':!![]}),exports[a13_0x26b118(0xb0)]=void 0x0;const testGatewayService_1=require(a13_0x26b118(0xe1)),webhookService_1=require(a13_0x26b118(0xee)),database_1=__importDefault(require(a13_0x26b118(0xcb)));class TestGatewayController{constructor(){const _0x1a08da=a13_0x26b118;this[_0x1a08da(0xf7)]=async(_0x398e37,_0x2f6836,_0x5e02be)=>{const _0x375077=_0x1a08da;try{const {paymentId:_0x37e218}=_0x398e37[_0x375077(0x113)];console[_0x375077(0x126)](_0x375077(0xb7)+_0x37e218);const _0x4d0680=await database_1['default'][_0x375077(0xdb)][_0x375077(0xea)]({'where':{'id':_0x37e218},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4d0680)return _0x2f6836[_0x375077(0xcf)](0x194)[_0x375077(0xf5)]({'success':![],'message':_0x375077(0xde)});if(_0x4d0680[_0x375077(0xbf)]!==_0x375077(0xd4))return _0x2f6836[_0x375077(0xcf)](0x190)[_0x375077(0xf5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4d0680[_0x375077(0xcf)]!==_0x375077(0xf9))return _0x2f6836[_0x375077(0xcf)](0x190)[_0x375077(0xf5)]({'success':![],'message':_0x375077(0x102)+_0x4d0680[_0x375077(0xcf)]+_0x375077(0xac)});_0x2f6836[_0x375077(0xf5)]({'success':!![],'result':{'paymentId':_0x4d0680['id'],'orderId':_0x4d0680[_0x375077(0xbc)],'amount':_0x4d0680['amount'],'currency':_0x4d0680[_0x375077(0x119)],'merchantName':_0x4d0680['shop'][_0x375077(0x111)],'description':_0x375077(0xaf)+_0x4d0680[_0x375077(0xe7)][_0x375077(0x111)],'testInstructions':{'successCard':_0x375077(0xf6),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x375077(0xe4),'cvc':_0x375077(0xad),'holderName':_0x375077(0x10a)}}});}catch(_0x36b537){_0x5e02be(_0x36b537);}},this[_0x1a08da(0x124)]=async(_0x96b021,_0x5ca8b4,_0x31bfef)=>{const _0x3589ee=_0x1a08da;try{const {paymentId:_0x39c591}=_0x96b021[_0x3589ee(0x113)],_0x1cd6af=_0x96b021['body'];console[_0x3589ee(0x126)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x39c591);const _0x35cdae=await database_1['default']['payment']['findUnique']({'where':{'id':_0x39c591},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x35cdae)return _0x5ca8b4[_0x3589ee(0xcf)](0x194)[_0x3589ee(0xf5)]({'success':![],'message':_0x3589ee(0xde)});if(_0x35cdae[_0x3589ee(0xbf)]!==_0x3589ee(0xd4))return _0x5ca8b4[_0x3589ee(0xcf)](0x190)[_0x3589ee(0xf5)]({'success':![],'message':_0x3589ee(0xc0)});if(_0x35cdae[_0x3589ee(0xcf)]!==_0x3589ee(0xf9))return _0x5ca8b4[_0x3589ee(0xcf)](0x190)['json']({'success':![],'message':_0x3589ee(0x102)+_0x35cdae[_0x3589ee(0xcf)]+_0x3589ee(0xac)});const _0x526cc1=await this[_0x3589ee(0xd1)][_0x3589ee(0xe0)]({'paymentId':_0x35cdae['id'],'orderId':_0x35cdae['gatewayOrderId']||_0x35cdae['id'],'amount':_0x35cdae[_0x3589ee(0xdd)],'currency':_0x35cdae[_0x3589ee(0x119)],'cardData':_0x1cd6af});console[_0x3589ee(0x126)](_0x3589ee(0xe3),_0x526cc1);const _0x3ffa3b={'status':_0x526cc1[_0x3589ee(0xcf)],'updatedAt':new Date()};if(_0x526cc1['status']===_0x3589ee(0xc6))_0x3ffa3b[_0x3589ee(0x10d)]=new Date(),_0x3ffa3b[_0x3589ee(0x11d)]=_0x526cc1[_0x3589ee(0xf8)];else _0x526cc1[_0x3589ee(0xcf)]===_0x3589ee(0xed)&&(_0x3ffa3b[_0x3589ee(0xe8)]=_0x526cc1[_0x3589ee(0x110)]);const _0x387045=_0x1cd6af[_0x3589ee(0x116)][_0x3589ee(0xb1)](/[\s-]/g,'');_0x3ffa3b[_0x3589ee(0x109)]=_0x387045[_0x3589ee(0xc7)](-0x4),_0x3ffa3b[_0x3589ee(0xfd)]='test_card',await database_1[_0x3589ee(0x104)][_0x3589ee(0xdb)]['update']({'where':{'id':_0x35cdae['id']},'data':_0x3ffa3b});if(_0x526cc1[_0x3589ee(0xcf)]===_0x3589ee(0xc6)&&_0x35cdae[_0x3589ee(0xd2)]){console[_0x3589ee(0x126)](_0x3589ee(0xd0)+_0x35cdae['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default']['$transaction'](async _0x23b2e3=>{const _0x4b1953=_0x3589ee,_0x1d60e6=await _0x23b2e3['paymentLink'][_0x4b1953(0xea)]({'where':{'id':_0x35cdae[_0x4b1953(0xd2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1d60e6){console['log'](_0x4b1953(0x122)+_0x1d60e6['id']+':\x20type='+_0x1d60e6[_0x4b1953(0x125)]+_0x4b1953(0xef)+_0x1d60e6['currentPayments']+_0x4b1953(0x101)+_0x1d60e6[_0x4b1953(0xcf)]);const _0x341e37=_0x1d60e6[_0x4b1953(0x120)]+0x1,_0x3617c1=_0x1d60e6[_0x4b1953(0x125)]===_0x4b1953(0xdc)?'COMPLETED':_0x1d60e6[_0x4b1953(0xcf)];await _0x23b2e3['paymentLink'][_0x4b1953(0xe9)]({'where':{'id':_0x35cdae[_0x4b1953(0xd2)]},'data':{'currentPayments':_0x341e37,'status':_0x3617c1,'updatedAt':new Date()}}),console[_0x4b1953(0x126)](_0x4b1953(0x103)+_0x1d60e6['id']+_0x4b1953(0xcd)+_0x1d60e6[_0x4b1953(0x120)]+'\x20->\x20'+_0x341e37+',\x20status='+_0x1d60e6[_0x4b1953(0xcf)]+_0x4b1953(0xd8)+_0x3617c1);}else console[_0x4b1953(0x126)](_0x4b1953(0xc8)+_0x35cdae['paymentLinkId']+_0x4b1953(0x11f));});}catch(_0x283f27){console[_0x3589ee(0x114)](_0x3589ee(0xe2),_0x283f27);}}await database_1[_0x3589ee(0x104)][_0x3589ee(0xcc)]['create']({'data':{'paymentId':_0x35cdae['id'],'shopId':_0x35cdae['shopId'],'event':_0x3589ee(0xa9)+_0x526cc1[_0x3589ee(0xcf)][_0x3589ee(0xf2)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3589ee(0xf9),'newStatus':_0x526cc1[_0x3589ee(0xcf)],'transactionId':_0x526cc1[_0x3589ee(0xf8)],'failureReason':_0x526cc1[_0x3589ee(0x110)],'processedAt':new Date()[_0x3589ee(0xc2)]()})}}),await this['sendShopWebhook'](_0x35cdae,_0x526cc1[_0x3589ee(0xcf)],_0x526cc1['transactionId'],_0x526cc1[_0x3589ee(0x110)]),await this[_0x3589ee(0x10e)](_0x35cdae,_0x526cc1[_0x3589ee(0xcf)]),console[_0x3589ee(0x126)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x39c591+_0x3589ee(0x128)+_0x526cc1[_0x3589ee(0xcf)]),_0x526cc1[_0x3589ee(0xcf)]===_0x3589ee(0xc6)?_0x5ca8b4[_0x3589ee(0xf5)]({'success':!![],'message':_0x3589ee(0xeb),'result':{'status':_0x3589ee(0xc6),'transactionId':_0x526cc1['transactionId'],'redirectUrl':_0x35cdae[_0x3589ee(0xfa)]}}):_0x5ca8b4[_0x3589ee(0xcf)](0x190)[_0x3589ee(0xf5)]({'success':![],'message':_0x3589ee(0xca),'result':{'status':_0x3589ee(0xed),'failureReason':_0x526cc1[_0x3589ee(0x110)],'redirectUrl':_0x35cdae[_0x3589ee(0xb2)]}});}catch(_0x1b3a00){_0x31bfef(_0x1b3a00);}},this['testGatewayService']=new testGatewayService_1[(_0x1a08da(0x10c))](),this[_0x1a08da(0x107)]=new webhookService_1[(_0x1a08da(0x10f))]();}async[a13_0x26b118(0xbb)](_0x37cfd3,_0xd2f577,_0x3d654b,_0x33d3cb){const _0x1f1d44=a13_0x26b118,_0x7eac40=Date['now']();try{const _0x2aa90b=_0x37cfd3[_0x1f1d44(0xe7)],_0x1736fd=_0x2aa90b['settings'];if(!_0x1736fd?.['webhookUrl']){console[_0x1f1d44(0x126)](_0x1f1d44(0x11c)+_0x2aa90b['id']);return;}const _0x4d6e57=_0xd2f577===_0x1f1d44(0xc6)?_0x1f1d44(0xf3):_0x1f1d44(0xb8);let _0x4fc05a=[];if(_0x1736fd['webhookEvents'])try{_0x4fc05a=Array[_0x1f1d44(0xba)](_0x1736fd[_0x1f1d44(0x112)])?_0x1736fd[_0x1f1d44(0x112)]:JSON[_0x1f1d44(0xc5)](_0x1736fd['webhookEvents']);}catch(_0x933913){console[_0x1f1d44(0x114)]('Error\x20parsing\x20webhook\x20events:',_0x933913),_0x4fc05a=[];}if(!_0x4fc05a[_0x1f1d44(0xf0)](_0x4d6e57)){console[_0x1f1d44(0x126)](_0x1f1d44(0x121)+_0x4d6e57+_0x1f1d44(0x11e)+_0x2aa90b['id']);return;}const _0xb39666={'event':_0x4d6e57,'payment':{'id':_0x37cfd3['id'],'order_id':_0x37cfd3[_0x1f1d44(0xb5)],'gateway_order_id':_0x37cfd3[_0x1f1d44(0xbc)],'gateway':_0x1f1d44(0xd7),'amount':_0x37cfd3[_0x1f1d44(0xdd)],'currency':_0x37cfd3[_0x1f1d44(0x119)],'status':_0xd2f577['toLowerCase'](),'customer_email':_0x37cfd3['customerEmail'],'customer_name':_0x37cfd3[_0x1f1d44(0xfe)],'transaction_id':_0x3d654b,'failure_message':_0x33d3cb,'created_at':_0x37cfd3[_0x1f1d44(0xc3)],'updated_at':new Date()}},_0x559791=await fetch(_0x1736fd[_0x1f1d44(0x100)],{'method':'POST','headers':{'Content-Type':_0x1f1d44(0x106),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x1f1d44(0xff)](_0xb39666)}),_0x3a79df=Date[_0x1f1d44(0xce)]()-_0x7eac40;console[_0x1f1d44(0x126)](_0x1f1d44(0xec)+_0x1736fd['webhookUrl']+_0x1f1d44(0x10b)+_0x559791[_0x1f1d44(0xcf)]+'\x20('+_0x3a79df+_0x1f1d44(0xf1));}catch(_0x2bde1f){console[_0x1f1d44(0x114)](_0x1f1d44(0xb4),_0x2bde1f);}}async[a13_0x26b118(0x10e)](_0x21f344,_0x447dfa){const _0x1ac68a=a13_0x26b118;try{const {telegramBotService:_0x32fcb2}=await Promise[_0x1ac68a(0xe6)]()['then'](()=>__importStar(require(_0x1ac68a(0xfc)))),_0x1043b2={'PAID':_0x1ac68a(0xbe),'FAILED':_0x1ac68a(0xc4)},_0x38bac6=_0x1043b2[_0x447dfa];if(!_0x38bac6)return;await _0x32fcb2['sendPaymentNotification'](_0x21f344[_0x1ac68a(0x118)],_0x21f344,_0x38bac6);}catch(_0x3a952c){console['error'](_0x1ac68a(0x115),_0x3a952c);}}}exports['TestGatewayController']=TestGatewayController;