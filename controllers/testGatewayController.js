'use strict';const a13_0x2da375=a13_0x3d24;function a13_0x5876(){const _0x2e2689=['test_card','Error\x20parsing\x20webhook\x20events:','default','0000','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','shop','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','getOwnPropertyDescriptor','type','251568MFFCUK','currency','json','error','now','__esModule','COMPLETED','188hPzCsi','hasOwnProperty','Payment\x20to\x20','2712aJXCUO','POST','110PknEwb','testGatewayService','‚úÖ\x20Payment\x20link\x20','22767naGJwd','$transaction','writable','üìà\x20Test\x20Gateway:\x20Payment\x20','TestGatewayController','__setModuleDefault',',\x20cannot\x20process','prototype','get','Any\x20name','failUrl','721ryxSLz','webhookUrl','create','12tOtPNM','167166PsVbPv','length','webhookLog','createdAt','__importDefault','currentPayments','then','Payment\x20is\x20not\x20for\x20test\x20gateway','600074EpNyjP','WebhookService','slice','toISOString','test_gateway_','replace','gatewayOrderId',':\x20type=','SINGLE','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Payment\x20status\x20is\x20','defineProperty','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ms)','name','Any\x20future\x20date\x20(MM/YY)','../services/webhookService','Any\x20other\x20card\x20number','params','‚úÖ\x20Test\x20Gateway\x20payment\x20','failureReason','webhookEvents','\x20not\x20enabled\x20for\x20shop\x20','paymentLink',',\x20status=','stringify','findUnique','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','transactionId','\x20->\x20','paidAt','PENDING','update','shopId','üß™\x20Test\x20Gateway\x20result:','\x20processed:\x20','resolve','orderId','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','call','Payment\x20processed\x20successfully','sendShopWebhook','paymentLinkId','FAILED','processCardPayment','payment.success','Payment\x20failed','\x20with\x20status\x20','payment','log','processCard','parse','status','paid','customerName','successUrl','isArray','getPaymentForm','1118931PtehWA','../services/telegramBotService','failureMessage','settings','customerEmail','test_gateway','PAID','amount','application/json','cardLast4','configurable','Any\x203-4\x20digits','cardNumber','sendPaymentStatusNotification','body','sendPaymentNotification','toLowerCase','TestGatewayService','258165TeaQTN','__importStar'];a13_0x5876=function(){return _0x2e2689;};return a13_0x5876();}function a13_0x3d24(_0x4c717f,_0x51f332){const _0x5876a1=a13_0x5876();return a13_0x3d24=function(_0x3d247e,_0x183a66){_0x3d247e=_0x3d247e-0x1bc;let _0x2bc36b=_0x5876a1[_0x3d247e];return _0x2bc36b;},a13_0x3d24(_0x4c717f,_0x51f332);}(function(_0x18f88c,_0x662ee7){const _0x816e04=a13_0x3d24,_0x2f4294=_0x18f88c();while(!![]){try{const _0x389179=-parseInt(_0x816e04(0x20c))/0x1+parseInt(_0x816e04(0x214))/0x2+parseInt(_0x816e04(0x1fd))/0x3*(parseInt(_0x816e04(0x1f5))/0x4)+parseInt(_0x816e04(0x1e3))/0x5*(parseInt(_0x816e04(0x20b))/0x6)+-parseInt(_0x816e04(0x208))/0x7*(-parseInt(_0x816e04(0x1f8))/0x8)+parseInt(_0x816e04(0x1ee))/0x9*(-parseInt(_0x816e04(0x1fa))/0xa)+-parseInt(_0x816e04(0x1d1))/0xb;if(_0x389179===_0x662ee7)break;else _0x2f4294['push'](_0x2f4294['shift']());}catch(_0x1751f4){_0x2f4294['push'](_0x2f4294['shift']());}}}(a13_0x5876,0x355b0));var __createBinding=this&&this['__createBinding']||(Object[a13_0x2da375(0x20a)]?function(_0x4a966c,_0x50b6cf,_0x4327d8,_0x4057bc){const _0x2e90af=a13_0x2da375;if(_0x4057bc===undefined)_0x4057bc=_0x4327d8;var _0x5d757b=Object[_0x2e90af(0x1ec)](_0x50b6cf,_0x4327d8);(!_0x5d757b||(_0x2e90af(0x205)in _0x5d757b?!_0x50b6cf[_0x2e90af(0x1f3)]:_0x5d757b[_0x2e90af(0x1ff)]||_0x5d757b[_0x2e90af(0x1db)]))&&(_0x5d757b={'enumerable':!![],'get':function(){return _0x50b6cf[_0x4327d8];}}),Object[_0x2e90af(0x21f)](_0x4a966c,_0x4057bc,_0x5d757b);}:function(_0x57c8ce,_0x27dfe3,_0x7078a6,_0x3c7cd8){if(_0x3c7cd8===undefined)_0x3c7cd8=_0x7078a6;_0x57c8ce[_0x3c7cd8]=_0x27dfe3[_0x7078a6];}),__setModuleDefault=this&&this[a13_0x2da375(0x202)]||(Object[a13_0x2da375(0x20a)]?function(_0x51c062,_0x16ec4f){const _0x11fc41=a13_0x2da375;Object[_0x11fc41(0x21f)](_0x51c062,'default',{'enumerable':!![],'value':_0x16ec4f});}:function(_0x62e78d,_0x168e81){const _0x25b5ee=a13_0x2da375;_0x62e78d[_0x25b5ee(0x1e7)]=_0x168e81;}),__importStar=this&&this[a13_0x2da375(0x1e4)]||(function(){var _0x3665f2=function(_0x2baf49){return _0x3665f2=Object['getOwnPropertyNames']||function(_0x52bd4a){const _0x3a1b2d=a13_0x3d24;var _0xc51fd5=[];for(var _0x20c034 in _0x52bd4a)if(Object[_0x3a1b2d(0x204)][_0x3a1b2d(0x1f6)][_0x3a1b2d(0x1be)](_0x52bd4a,_0x20c034))_0xc51fd5[_0xc51fd5[_0x3a1b2d(0x20d)]]=_0x20c034;return _0xc51fd5;},_0x3665f2(_0x2baf49);};return function(_0x94e98b){const _0x162e55=a13_0x3d24;if(_0x94e98b&&_0x94e98b[_0x162e55(0x1f3)])return _0x94e98b;var _0x51b2e8={};if(_0x94e98b!=null){for(var _0xb7c5ed=_0x3665f2(_0x94e98b),_0xfc55c1=0x0;_0xfc55c1<_0xb7c5ed[_0x162e55(0x20d)];_0xfc55c1++)if(_0xb7c5ed[_0xfc55c1]!==_0x162e55(0x1e7))__createBinding(_0x51b2e8,_0x94e98b,_0xb7c5ed[_0xfc55c1]);}return __setModuleDefault(_0x51b2e8,_0x94e98b),_0x51b2e8;};}()),__importDefault=this&&this[a13_0x2da375(0x210)]||function(_0x414429){const _0x5c566a=a13_0x2da375;return _0x414429&&_0x414429[_0x5c566a(0x1f3)]?_0x414429:{'default':_0x414429};};Object[a13_0x2da375(0x21f)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x2da375(0x224)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x57b7c6=a13_0x2da375;this[_0x57b7c6(0x1d0)]=async(_0x34607a,_0x50939e,_0x1e5cc3)=>{const _0x1161c4=_0x57b7c6;try{const {paymentId:_0x169b94}=_0x34607a[_0x1161c4(0x226)];console['log'](_0x1161c4(0x1e9)+_0x169b94);const _0x5a5e5a=await database_1[_0x1161c4(0x1e7)][_0x1161c4(0x1c7)][_0x1161c4(0x22e)]({'where':{'id':_0x169b94},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5a5e5a)return _0x50939e[_0x1161c4(0x1cb)](0x194)[_0x1161c4(0x1f0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5a5e5a['gateway']!==_0x1161c4(0x1d6))return _0x50939e[_0x1161c4(0x1cb)](0x190)[_0x1161c4(0x1f0)]({'success':![],'message':_0x1161c4(0x213)});if(_0x5a5e5a[_0x1161c4(0x1cb)]!==_0x1161c4(0x233))return _0x50939e[_0x1161c4(0x1cb)](0x190)[_0x1161c4(0x1f0)]({'success':![],'message':_0x1161c4(0x21e)+_0x5a5e5a[_0x1161c4(0x1cb)]+_0x1161c4(0x203)});_0x50939e['json']({'success':!![],'result':{'paymentId':_0x5a5e5a['id'],'orderId':_0x5a5e5a['gatewayOrderId'],'amount':_0x5a5e5a[_0x1161c4(0x1d8)],'currency':_0x5a5e5a[_0x1161c4(0x1ef)],'merchantName':_0x5a5e5a[_0x1161c4(0x1ea)]['name'],'description':_0x1161c4(0x1f7)+_0x5a5e5a['shop'][_0x1161c4(0x222)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x1161c4(0x225),'expiryDate':_0x1161c4(0x223),'cvc':_0x1161c4(0x1dc),'holderName':_0x1161c4(0x206)}}});}catch(_0x31b953){_0x1e5cc3(_0x31b953);}},this[_0x57b7c6(0x1c9)]=async(_0x11fa64,_0x46dc04,_0xeaa109)=>{const _0x50cda0=_0x57b7c6;try{const {paymentId:_0x101728}=_0x11fa64[_0x50cda0(0x226)],_0x367e79=_0x11fa64[_0x50cda0(0x1df)];console[_0x50cda0(0x1c8)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x101728);const _0x38b020=await database_1[_0x50cda0(0x1e7)][_0x50cda0(0x1c7)][_0x50cda0(0x22e)]({'where':{'id':_0x101728},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x38b020)return _0x46dc04['status'](0x194)[_0x50cda0(0x1f0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x38b020['gateway']!=='test_gateway')return _0x46dc04[_0x50cda0(0x1cb)](0x190)[_0x50cda0(0x1f0)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x38b020[_0x50cda0(0x1cb)]!==_0x50cda0(0x233))return _0x46dc04['status'](0x190)[_0x50cda0(0x1f0)]({'success':![],'message':_0x50cda0(0x21e)+_0x38b020[_0x50cda0(0x1cb)]+_0x50cda0(0x203)});const _0x5025ec=await this[_0x50cda0(0x1fb)][_0x50cda0(0x1c3)]({'paymentId':_0x38b020['id'],'orderId':_0x38b020['gatewayOrderId']||_0x38b020['id'],'amount':_0x38b020[_0x50cda0(0x1d8)],'currency':_0x38b020[_0x50cda0(0x1ef)],'cardData':_0x367e79});console[_0x50cda0(0x1c8)](_0x50cda0(0x236),_0x5025ec);const _0x4ce63e={'status':_0x5025ec[_0x50cda0(0x1cb)],'updatedAt':new Date()};if(_0x5025ec[_0x50cda0(0x1cb)]===_0x50cda0(0x1d7))_0x4ce63e[_0x50cda0(0x232)]=new Date(),_0x4ce63e['gatewayPaymentId']=_0x5025ec['transactionId'];else _0x5025ec['status']==='FAILED'&&(_0x4ce63e[_0x50cda0(0x1d3)]=_0x5025ec[_0x50cda0(0x228)]);const _0x3ad952=_0x367e79[_0x50cda0(0x1dd)][_0x50cda0(0x219)](/[\s-]/g,'');_0x4ce63e[_0x50cda0(0x1da)]=_0x3ad952[_0x50cda0(0x216)](-0x4),_0x4ce63e['paymentMethod']=_0x50cda0(0x1e5),await database_1[_0x50cda0(0x1e7)][_0x50cda0(0x1c7)][_0x50cda0(0x234)]({'where':{'id':_0x38b020['id']},'data':_0x4ce63e});if(_0x5025ec[_0x50cda0(0x1cb)]===_0x50cda0(0x1d7)&&_0x38b020[_0x50cda0(0x1c1)]){console[_0x50cda0(0x1c8)](_0x50cda0(0x200)+_0x38b020['id']+_0x50cda0(0x21d));try{await database_1['default'][_0x50cda0(0x1fe)](async _0x3af433=>{const _0x20d333=_0x50cda0,_0x41968f=await _0x3af433[_0x20d333(0x22b)][_0x20d333(0x22e)]({'where':{'id':_0x38b020[_0x20d333(0x1c1)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x41968f){console[_0x20d333(0x1c8)]('üìà\x20Found\x20payment\x20link\x20'+_0x41968f['id']+_0x20d333(0x21b)+_0x41968f[_0x20d333(0x1ed)]+',\x20currentPayments='+_0x41968f[_0x20d333(0x211)]+_0x20d333(0x22c)+_0x41968f[_0x20d333(0x1cb)]);const _0x54afb2=_0x41968f[_0x20d333(0x211)]+0x1,_0x58def0=_0x41968f[_0x20d333(0x1ed)]===_0x20d333(0x21c)?_0x20d333(0x1f4):_0x41968f['status'];await _0x3af433['paymentLink'][_0x20d333(0x234)]({'where':{'id':_0x38b020[_0x20d333(0x1c1)]},'data':{'currentPayments':_0x54afb2,'status':_0x58def0,'updatedAt':new Date()}}),console[_0x20d333(0x1c8)](_0x20d333(0x1fc)+_0x41968f['id']+'\x20updated:\x20currentPayments='+_0x41968f[_0x20d333(0x211)]+_0x20d333(0x231)+_0x54afb2+',\x20status='+_0x41968f['status']+_0x20d333(0x231)+_0x58def0);}else console[_0x20d333(0x1c8)]('‚ùå\x20Payment\x20link\x20'+_0x38b020[_0x20d333(0x1c1)]+'\x20not\x20found');});}catch(_0x2d57a5){console[_0x50cda0(0x1f1)](_0x50cda0(0x1bd),_0x2d57a5);}}await database_1[_0x50cda0(0x1e7)][_0x50cda0(0x20e)][_0x50cda0(0x20a)]({'data':{'paymentId':_0x38b020['id'],'shopId':_0x38b020['shopId'],'event':_0x50cda0(0x218)+_0x5025ec[_0x50cda0(0x1cb)][_0x50cda0(0x1e1)](),'statusCode':0xc8,'responseBody':JSON[_0x50cda0(0x22d)]({'oldStatus':_0x50cda0(0x233),'newStatus':_0x5025ec['status'],'transactionId':_0x5025ec[_0x50cda0(0x230)],'failureReason':_0x5025ec['failureReason'],'processedAt':new Date()[_0x50cda0(0x217)]()})}}),await this[_0x50cda0(0x1c0)](_0x38b020,_0x5025ec[_0x50cda0(0x1cb)],_0x5025ec[_0x50cda0(0x230)],_0x5025ec[_0x50cda0(0x228)]),await this[_0x50cda0(0x1de)](_0x38b020,_0x5025ec[_0x50cda0(0x1cb)]),console[_0x50cda0(0x1c8)](_0x50cda0(0x227)+_0x101728+_0x50cda0(0x237)+_0x5025ec[_0x50cda0(0x1cb)]),_0x5025ec[_0x50cda0(0x1cb)]==='PAID'?_0x46dc04['json']({'success':!![],'message':_0x50cda0(0x1bf),'result':{'status':_0x50cda0(0x1d7),'transactionId':_0x5025ec['transactionId'],'redirectUrl':_0x38b020[_0x50cda0(0x1ce)]}}):_0x46dc04[_0x50cda0(0x1cb)](0x190)[_0x50cda0(0x1f0)]({'success':![],'message':_0x50cda0(0x1c5),'result':{'status':_0x50cda0(0x1c2),'failureReason':_0x5025ec[_0x50cda0(0x228)],'redirectUrl':_0x38b020[_0x50cda0(0x207)]}});}catch(_0x29f792){_0xeaa109(_0x29f792);}},this['testGatewayService']=new testGatewayService_1[(_0x57b7c6(0x1e2))](),this['webhookService']=new webhookService_1[(_0x57b7c6(0x215))]();}async['sendShopWebhook'](_0x575493,_0x3cfc0d,_0xe14b06,_0x55fc19){const _0x56539f=a13_0x2da375,_0x6d7f3f=Date['now']();try{const _0x473d41=_0x575493[_0x56539f(0x1ea)],_0x758070=_0x473d41[_0x56539f(0x1d4)];if(!_0x758070?.[_0x56539f(0x209)]){console[_0x56539f(0x1c8)](_0x56539f(0x22f)+_0x473d41['id']);return;}const _0x820b3a=_0x3cfc0d==='PAID'?_0x56539f(0x1c4):'payment.failed';let _0x139236=[];if(_0x758070[_0x56539f(0x229)])try{_0x139236=Array[_0x56539f(0x1cf)](_0x758070[_0x56539f(0x229)])?_0x758070['webhookEvents']:JSON[_0x56539f(0x1ca)](_0x758070[_0x56539f(0x229)]);}catch(_0x31f901){console[_0x56539f(0x1f1)](_0x56539f(0x1e6),_0x31f901),_0x139236=[];}if(!_0x139236['includes'](_0x820b3a)){console[_0x56539f(0x1c8)]('Webhook\x20event\x20'+_0x820b3a+_0x56539f(0x22a)+_0x473d41['id']);return;}const _0x361d3d={'event':_0x820b3a,'payment':{'id':_0x575493['id'],'order_id':_0x575493[_0x56539f(0x1bc)],'gateway_order_id':_0x575493[_0x56539f(0x21a)],'gateway':_0x56539f(0x1e8),'amount':_0x575493[_0x56539f(0x1d8)],'currency':_0x575493['currency'],'status':_0x3cfc0d['toLowerCase'](),'customer_email':_0x575493[_0x56539f(0x1d5)],'customer_name':_0x575493[_0x56539f(0x1cd)],'transaction_id':_0xe14b06,'failure_message':_0x55fc19,'created_at':_0x575493[_0x56539f(0x20f)],'updated_at':new Date()}},_0x321abd=await fetch(_0x758070[_0x56539f(0x209)],{'method':_0x56539f(0x1f9),'headers':{'Content-Type':_0x56539f(0x1d9),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x56539f(0x22d)](_0x361d3d)}),_0x48e2bb=Date[_0x56539f(0x1f2)]()-_0x6d7f3f;console[_0x56539f(0x1c8)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x758070[_0x56539f(0x209)]+_0x56539f(0x1c6)+_0x321abd[_0x56539f(0x1cb)]+'\x20('+_0x48e2bb+_0x56539f(0x221));}catch(_0x382a99){console[_0x56539f(0x1f1)](_0x56539f(0x1eb),_0x382a99);}}async[a13_0x2da375(0x1de)](_0x3e59b9,_0x22c76a){const _0x45fb99=a13_0x2da375;try{const {telegramBotService:_0x392470}=await Promise[_0x45fb99(0x238)]()[_0x45fb99(0x212)](()=>__importStar(require(_0x45fb99(0x1d2)))),_0x1d85c3={'PAID':_0x45fb99(0x1cc),'FAILED':'failed'},_0x5f97c0=_0x1d85c3[_0x22c76a];if(!_0x5f97c0)return;await _0x392470[_0x45fb99(0x1e0)](_0x3e59b9[_0x45fb99(0x235)],_0x3e59b9,_0x5f97c0);}catch(_0x37fb91){console['error'](_0x45fb99(0x220),_0x37fb91);}}}exports[a13_0x2da375(0x201)]=TestGatewayController;