'use strict';const a15_0x2aacb6=a15_0x4d35;(function(_0x38ec2,_0x562942){const _0x3c08cb=a15_0x4d35,_0x565e1f=_0x38ec2();while(!![]){try{const _0x2d810f=-parseInt(_0x3c08cb(0x10e))/0x1*(parseInt(_0x3c08cb(0xbd))/0x2)+-parseInt(_0x3c08cb(0x108))/0x3+-parseInt(_0x3c08cb(0xde))/0x4*(parseInt(_0x3c08cb(0x11a))/0x5)+-parseInt(_0x3c08cb(0xc3))/0x6*(-parseInt(_0x3c08cb(0xc5))/0x7)+-parseInt(_0x3c08cb(0xc4))/0x8*(-parseInt(_0x3c08cb(0xdb))/0x9)+-parseInt(_0x3c08cb(0xc6))/0xa*(parseInt(_0x3c08cb(0xda))/0xb)+parseInt(_0x3c08cb(0xf8))/0xc*(parseInt(_0x3c08cb(0xdf))/0xd);if(_0x2d810f===_0x562942)break;else _0x565e1f['push'](_0x565e1f['shift']());}catch(_0x10c5e2){_0x565e1f['push'](_0x565e1f['shift']());}}}(a15_0x1956,0xc4420));function a15_0x4d35(_0x4d2054,_0x38ac1c){const _0x1956ba=a15_0x1956();return a15_0x4d35=function(_0x4d3580,_0x5eac3a){_0x4d3580=_0x4d3580-0xa8;let _0x3e9591=_0x1956ba[_0x4d3580];return _0x3e9591;},a15_0x4d35(_0x4d2054,_0x38ac1c);}function a15_0x1956(){const _0x39f7ce=['failureReason','Any\x20other\x20card\x20number','then','processCardPayment','4524924LFWelt','\x20with\x20status\x20','orderId','failureMessage','📈\x20Test\x20Gateway:\x20Payment\x20','paymentLink','1046377vZeTrz','get','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','📈\x20Found\x20payment\x20link\x20','🧪\x20Test\x20Gateway\x20result:','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','payment.failed','../services/telegramBotService','slice','cardNumber','PENDING','Payment\x20processed\x20successfully','2495335KCZiPA','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','customerName','❌\x20Payment\x20link\x20','Payment\x20not\x20found','ms)','getOwnPropertyNames','__esModule','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','paymentMethod','\x20->\x20','Webhook\x20event\x20','findUnique','webhookUrl','4242\x204242\x204242\x204242','Payment\x20status\x20is\x20','webhookLog','currentPayments','params','PAID','writable','payment','Any\x20name','prototype','getOwnPropertyDescriptor','__createBinding','✅\x20Payment\x20link\x20','toLowerCase','body','resolve','json','configurable','COMPLETED','gateway','2cwzHid','toISOString','customerEmail','gatewayPaymentId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processCard','8418yryjFo','87912PyeHXY','3220RZIBlb','2895950paTbHU','Any\x20future\x20date\x20(MM/YY)','paymentLinkId','WebhookService','\x20updated:\x20currentPayments=','Error\x20parsing\x20webhook\x20events:','\x20not\x20found','parse','error','update','\x20not\x20enabled\x20for\x20shop\x20','log','webhookEvents','Test\x20Gateway\x20webhook\x20sent\x20to\x20','../config/database','test_gateway_','call',',\x20status=','includes','Payment\x20is\x20not\x20for\x20test\x20gateway','11AIGKvL','594bdPENt','currency','POST','4pTjtAj','13jfxAuh','getPaymentForm','payment.success','create','shopId','isArray','testGatewayService','application/json','hasOwnProperty','TestGatewayController','length','test_gateway','successUrl','amount','0000','status',',\x20currentPayments=','webhookService','default','shop','../services/gateways/testGatewayService','paid','FAILED','type','paidAt','33318780XzZsDU','name','TestGatewayService','defineProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','cardLast4',',\x20cannot\x20process','transactionId','stringify','gatewayOrderId','sendPaymentNotification','\x20processed:\x20'];a15_0x1956=function(){return _0x39f7ce;};return a15_0x1956();}var __createBinding=this&&this[a15_0x2aacb6(0xb4)]||(Object[a15_0x2aacb6(0xe2)]?function(_0x8aaa15,_0xd6f695,_0x1fc994,_0x5aa54e){const _0x25c09d=a15_0x2aacb6;if(_0x5aa54e===undefined)_0x5aa54e=_0x1fc994;var _0x2bc3a7=Object[_0x25c09d(0xb3)](_0xd6f695,_0x1fc994);(!_0x2bc3a7||(_0x25c09d(0x10f)in _0x2bc3a7?!_0xd6f695[_0x25c09d(0x121)]:_0x2bc3a7[_0x25c09d(0xaf)]||_0x2bc3a7[_0x25c09d(0xba)]))&&(_0x2bc3a7={'enumerable':!![],'get':function(){return _0xd6f695[_0x1fc994];}}),Object['defineProperty'](_0x8aaa15,_0x5aa54e,_0x2bc3a7);}:function(_0x45e676,_0x1c37c3,_0x350786,_0x301d01){if(_0x301d01===undefined)_0x301d01=_0x350786;_0x45e676[_0x301d01]=_0x1c37c3[_0x350786];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a15_0x2aacb6(0xe2)]?function(_0xd88cd8,_0x4f17a3){const _0x34e213=a15_0x2aacb6;Object[_0x34e213(0xfb)](_0xd88cd8,_0x34e213(0xf1),{'enumerable':!![],'value':_0x4f17a3});}:function(_0x5ebd0e,_0x40e0f1){const _0x19b5e9=a15_0x2aacb6;_0x5ebd0e[_0x19b5e9(0xf1)]=_0x40e0f1;}),__importStar=this&&this['__importStar']||(function(){var _0xb0f0c6=function(_0x270336){const _0x1312ac=a15_0x4d35;return _0xb0f0c6=Object[_0x1312ac(0x120)]||function(_0xd7bfaa){const _0x5a76d4=_0x1312ac;var _0x38126b=[];for(var _0x5c9bc2 in _0xd7bfaa)if(Object[_0x5a76d4(0xb2)][_0x5a76d4(0xe7)][_0x5a76d4(0xd6)](_0xd7bfaa,_0x5c9bc2))_0x38126b[_0x38126b['length']]=_0x5c9bc2;return _0x38126b;},_0xb0f0c6(_0x270336);};return function(_0x50f970){const _0x735182=a15_0x4d35;if(_0x50f970&&_0x50f970[_0x735182(0x121)])return _0x50f970;var _0x329b9f={};if(_0x50f970!=null){for(var _0x58f340=_0xb0f0c6(_0x50f970),_0x2b9a69=0x0;_0x2b9a69<_0x58f340[_0x735182(0xe9)];_0x2b9a69++)if(_0x58f340[_0x2b9a69]!==_0x735182(0xf1))__createBinding(_0x329b9f,_0x50f970,_0x58f340[_0x2b9a69]);}return __setModuleDefault(_0x329b9f,_0x50f970),_0x329b9f;};}()),__importDefault=this&&this['__importDefault']||function(_0x1fa4eb){const _0x1a5c4f=a15_0x2aacb6;return _0x1fa4eb&&_0x1fa4eb[_0x1a5c4f(0x121)]?_0x1fa4eb:{'default':_0x1fa4eb};};Object['defineProperty'](exports,a15_0x2aacb6(0x121),{'value':!![]}),exports[a15_0x2aacb6(0xe8)]=void 0x0;const testGatewayService_1=require(a15_0x2aacb6(0xf3)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a15_0x2aacb6(0xd4)));class TestGatewayController{constructor(){const _0x42a762=a15_0x2aacb6;this[_0x42a762(0xe0)]=async(_0x366ead,_0x43e9e2,_0x2d93e4)=>{const _0x13cd21=_0x42a762;try{const {paymentId:_0x4eb819}=_0x366ead[_0x13cd21(0xad)];console[_0x13cd21(0xd1)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4eb819);const _0x5be918=await database_1[_0x13cd21(0xf1)]['payment'][_0x13cd21(0x126)]({'where':{'id':_0x4eb819},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5be918)return _0x43e9e2[_0x13cd21(0xee)](0x194)['json']({'success':![],'message':_0x13cd21(0x11e)});if(_0x5be918[_0x13cd21(0xbc)]!==_0x13cd21(0xea))return _0x43e9e2[_0x13cd21(0xee)](0x190)[_0x13cd21(0xb9)]({'success':![],'message':_0x13cd21(0xd9)});if(_0x5be918[_0x13cd21(0xee)]!==_0x13cd21(0x118))return _0x43e9e2[_0x13cd21(0xee)](0x190)[_0x13cd21(0xb9)]({'success':![],'message':_0x13cd21(0xaa)+_0x5be918[_0x13cd21(0xee)]+_0x13cd21(0xfe)});_0x43e9e2[_0x13cd21(0xb9)]({'success':!![],'result':{'paymentId':_0x5be918['id'],'orderId':_0x5be918[_0x13cd21(0x101)],'amount':_0x5be918['amount'],'currency':_0x5be918[_0x13cd21(0xdc)],'merchantName':_0x5be918['shop'][_0x13cd21(0xf9)],'description':'Payment\x20to\x20'+_0x5be918[_0x13cd21(0xf2)]['name'],'testInstructions':{'successCard':_0x13cd21(0xa9),'failureCard':_0x13cd21(0x105),'expiryDate':_0x13cd21(0xc7),'cvc':'Any\x203-4\x20digits','holderName':_0x13cd21(0xb1)}}});}catch(_0x203db9){_0x2d93e4(_0x203db9);}},this[_0x42a762(0xc2)]=async(_0x195f9b,_0x578f3d,_0x15b2e8)=>{const _0x13fb69=_0x42a762;try{const {paymentId:_0x39bb70}=_0x195f9b[_0x13fb69(0xad)],_0x45e51f=_0x195f9b[_0x13fb69(0xb7)];console[_0x13fb69(0xd1)](_0x13fb69(0x11b)+_0x39bb70);const _0x4dc776=await database_1[_0x13fb69(0xf1)]['payment']['findUnique']({'where':{'id':_0x39bb70},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4dc776)return _0x578f3d[_0x13fb69(0xee)](0x194)['json']({'success':![],'message':_0x13fb69(0x11e)});if(_0x4dc776[_0x13fb69(0xbc)]!==_0x13fb69(0xea))return _0x578f3d['status'](0x190)['json']({'success':![],'message':_0x13fb69(0xd9)});if(_0x4dc776[_0x13fb69(0xee)]!==_0x13fb69(0x118))return _0x578f3d[_0x13fb69(0xee)](0x190)[_0x13fb69(0xb9)]({'success':![],'message':_0x13fb69(0xaa)+_0x4dc776[_0x13fb69(0xee)]+',\x20cannot\x20process'});const _0x196f4a=await this[_0x13fb69(0xe5)][_0x13fb69(0x107)]({'paymentId':_0x4dc776['id'],'orderId':_0x4dc776[_0x13fb69(0x101)]||_0x4dc776['id'],'amount':_0x4dc776[_0x13fb69(0xec)],'currency':_0x4dc776['currency'],'cardData':_0x45e51f});console[_0x13fb69(0xd1)](_0x13fb69(0x112),_0x196f4a);const _0x1676fd={'status':_0x196f4a[_0x13fb69(0xee)],'updatedAt':new Date()};if(_0x196f4a[_0x13fb69(0xee)]===_0x13fb69(0xae))_0x1676fd[_0x13fb69(0xf7)]=new Date(),_0x1676fd[_0x13fb69(0xc0)]=_0x196f4a['transactionId'];else _0x196f4a['status']===_0x13fb69(0xf5)&&(_0x1676fd[_0x13fb69(0x10b)]=_0x196f4a[_0x13fb69(0x104)]);const _0x1bd6cb=_0x45e51f[_0x13fb69(0x117)]['replace'](/[\s-]/g,'');_0x1676fd[_0x13fb69(0xfd)]=_0x1bd6cb[_0x13fb69(0x116)](-0x4),_0x1676fd[_0x13fb69(0x123)]='test_card',await database_1[_0x13fb69(0xf1)][_0x13fb69(0xb0)]['update']({'where':{'id':_0x4dc776['id']},'data':_0x1676fd});if(_0x196f4a[_0x13fb69(0xee)]==='PAID'&&_0x4dc776[_0x13fb69(0xc8)]){console[_0x13fb69(0xd1)](_0x13fb69(0x10c)+_0x4dc776['id']+_0x13fb69(0x122));try{await database_1[_0x13fb69(0xf1)]['$transaction'](async _0x5774ec=>{const _0x234dd1=_0x13fb69,_0x54e4dc=await _0x5774ec[_0x234dd1(0x10d)][_0x234dd1(0x126)]({'where':{'id':_0x4dc776['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x54e4dc){console[_0x234dd1(0xd1)](_0x234dd1(0x111)+_0x54e4dc['id']+':\x20type='+_0x54e4dc[_0x234dd1(0xf6)]+_0x234dd1(0xef)+_0x54e4dc[_0x234dd1(0xac)]+_0x234dd1(0xd7)+_0x54e4dc[_0x234dd1(0xee)]);const _0x89451a=_0x54e4dc[_0x234dd1(0xac)]+0x1,_0x417dbb=_0x54e4dc[_0x234dd1(0xf6)]==='SINGLE'?_0x234dd1(0xbb):_0x54e4dc['status'];await _0x5774ec[_0x234dd1(0x10d)][_0x234dd1(0xcf)]({'where':{'id':_0x4dc776[_0x234dd1(0xc8)]},'data':{'currentPayments':_0x89451a,'status':_0x417dbb,'updatedAt':new Date()}}),console[_0x234dd1(0xd1)](_0x234dd1(0xb5)+_0x54e4dc['id']+_0x234dd1(0xca)+_0x54e4dc[_0x234dd1(0xac)]+_0x234dd1(0x124)+_0x89451a+_0x234dd1(0xd7)+_0x54e4dc[_0x234dd1(0xee)]+_0x234dd1(0x124)+_0x417dbb);}else console[_0x234dd1(0xd1)](_0x234dd1(0x11d)+_0x4dc776[_0x234dd1(0xc8)]+_0x234dd1(0xcc));});}catch(_0x2a8c23){console['error'](_0x13fb69(0x110),_0x2a8c23);}}await database_1['default'][_0x13fb69(0xab)][_0x13fb69(0xe2)]({'data':{'paymentId':_0x4dc776['id'],'shopId':_0x4dc776['shopId'],'event':_0x13fb69(0xd5)+_0x196f4a[_0x13fb69(0xee)][_0x13fb69(0xb6)](),'statusCode':0xc8,'responseBody':JSON[_0x13fb69(0x100)]({'oldStatus':_0x13fb69(0x118),'newStatus':_0x196f4a[_0x13fb69(0xee)],'transactionId':_0x196f4a[_0x13fb69(0xff)],'failureReason':_0x196f4a[_0x13fb69(0x104)],'processedAt':new Date()[_0x13fb69(0xbe)]()})}}),await this['sendShopWebhook'](_0x4dc776,_0x196f4a[_0x13fb69(0xee)],_0x196f4a[_0x13fb69(0xff)],_0x196f4a[_0x13fb69(0x104)]),await this['sendPaymentStatusNotification'](_0x4dc776,_0x196f4a['status']),console[_0x13fb69(0xd1)]('✅\x20Test\x20Gateway\x20payment\x20'+_0x39bb70+_0x13fb69(0x103)+_0x196f4a[_0x13fb69(0xee)]),_0x196f4a[_0x13fb69(0xee)]==='PAID'?_0x578f3d[_0x13fb69(0xb9)]({'success':!![],'message':_0x13fb69(0x119),'result':{'status':_0x13fb69(0xae),'transactionId':_0x196f4a[_0x13fb69(0xff)],'redirectUrl':_0x4dc776[_0x13fb69(0xeb)]}}):_0x578f3d[_0x13fb69(0xee)](0x190)[_0x13fb69(0xb9)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x13fb69(0xf5),'failureReason':_0x196f4a[_0x13fb69(0x104)],'redirectUrl':_0x4dc776['failUrl']}});}catch(_0x1f8c07){_0x15b2e8(_0x1f8c07);}},this[_0x42a762(0xe5)]=new testGatewayService_1[(_0x42a762(0xfa))](),this[_0x42a762(0xf0)]=new webhookService_1[(_0x42a762(0xc9))]();}async['sendShopWebhook'](_0x4cd294,_0x19912e,_0x317847,_0x3e6ec3){const _0x4ff267=a15_0x2aacb6,_0x20902a=Date['now']();try{const _0x23ec8f=_0x4cd294[_0x4ff267(0xf2)],_0x53efbc=_0x23ec8f['settings'];if(!_0x53efbc?.[_0x4ff267(0xa8)]){console[_0x4ff267(0xd1)](_0x4ff267(0xfc)+_0x23ec8f['id']);return;}const _0x4a2b6e=_0x19912e==='PAID'?_0x4ff267(0xe1):_0x4ff267(0x114);let _0x550675=[];if(_0x53efbc[_0x4ff267(0xd2)])try{_0x550675=Array[_0x4ff267(0xe4)](_0x53efbc[_0x4ff267(0xd2)])?_0x53efbc['webhookEvents']:JSON[_0x4ff267(0xcd)](_0x53efbc['webhookEvents']);}catch(_0xbef7dd){console[_0x4ff267(0xce)](_0x4ff267(0xcb),_0xbef7dd),_0x550675=[];}if(!_0x550675[_0x4ff267(0xd8)](_0x4a2b6e)){console[_0x4ff267(0xd1)](_0x4ff267(0x125)+_0x4a2b6e+_0x4ff267(0xd0)+_0x23ec8f['id']);return;}const _0x338ab7={'event':_0x4a2b6e,'payment':{'id':_0x4cd294['id'],'order_id':_0x4cd294[_0x4ff267(0x10a)],'gateway_order_id':_0x4cd294['gatewayOrderId'],'gateway':_0x4ff267(0xed),'amount':_0x4cd294[_0x4ff267(0xec)],'currency':_0x4cd294['currency'],'status':_0x19912e[_0x4ff267(0xb6)](),'customer_email':_0x4cd294[_0x4ff267(0xbf)],'customer_name':_0x4cd294[_0x4ff267(0x11c)],'transaction_id':_0x317847,'failure_message':_0x3e6ec3,'created_at':_0x4cd294['createdAt'],'updated_at':new Date()}},_0x48ed29=await fetch(_0x53efbc[_0x4ff267(0xa8)],{'method':_0x4ff267(0xdd),'headers':{'Content-Type':_0x4ff267(0xe6),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x4ff267(0x100)](_0x338ab7)}),_0x3a7cdc=Date['now']()-_0x20902a;console[_0x4ff267(0xd1)](_0x4ff267(0xd3)+_0x53efbc[_0x4ff267(0xa8)]+_0x4ff267(0x109)+_0x48ed29['status']+'\x20('+_0x3a7cdc+_0x4ff267(0x11f));}catch(_0x3a2220){console[_0x4ff267(0xce)](_0x4ff267(0x113),_0x3a2220);}}async['sendPaymentStatusNotification'](_0x21c0c1,_0x1de180){const _0x52fd48=a15_0x2aacb6;try{const {telegramBotService:_0x54e59e}=await Promise[_0x52fd48(0xb8)]()[_0x52fd48(0x106)](()=>__importStar(require(_0x52fd48(0x115)))),_0x59f3f7={'PAID':_0x52fd48(0xf4),'FAILED':'failed'},_0x3c064a=_0x59f3f7[_0x1de180];if(!_0x3c064a)return;await _0x54e59e[_0x52fd48(0x102)](_0x21c0c1[_0x52fd48(0xe3)],_0x21c0c1,_0x3c064a);}catch(_0x329f8c){console[_0x52fd48(0xce)](_0x52fd48(0xc1),_0x329f8c);}}}exports['TestGatewayController']=TestGatewayController;