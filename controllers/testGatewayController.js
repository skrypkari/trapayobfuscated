'use strict';const a15_0x1f4ef0=a15_0x4d29;function a15_0x4d29(_0x1c9fe8,_0x25e180){const _0x244cee=a15_0x244c();return a15_0x4d29=function(_0x4d2921,_0x19a8ed){_0x4d2921=_0x4d2921-0xc9;let _0x3b256e=_0x244cee[_0x4d2921];return _0x3b256e;},a15_0x4d29(_0x1c9fe8,_0x25e180);}(function(_0x392334,_0x1de29c){const _0x2d10ae=a15_0x4d29,_0x582cad=_0x392334();while(!![]){try{const _0x304cd9=-parseInt(_0x2d10ae(0xef))/0x1+parseInt(_0x2d10ae(0xde))/0x2+-parseInt(_0x2d10ae(0x126))/0x3+-parseInt(_0x2d10ae(0x110))/0x4+-parseInt(_0x2d10ae(0x13b))/0x5+-parseInt(_0x2d10ae(0xe0))/0x6*(-parseInt(_0x2d10ae(0xdb))/0x7)+parseInt(_0x2d10ae(0x139))/0x8;if(_0x304cd9===_0x1de29c)break;else _0x582cad['push'](_0x582cad['shift']());}catch(_0x1fec28){_0x582cad['push'](_0x582cad['shift']());}}}(a15_0x244c,0x2d869));function a15_0x244c(){const _0x4cc62a=['params','1033504hHqtGx','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Any\x203-4\x20digits','shopId','log','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Error\x20parsing\x20webhook\x20events:','__importStar','\x20->\x20','body','../services/webhookService','customerName','PAID','webhookService','getOwnPropertyDescriptor','test_card','payment.failed','isArray','paymentLinkId','Payment\x20status\x20is\x20','TestGatewayController','Payment\x20System/1.0\x20(Test\x20Gateway)','724011qRvtkF','resolve','prototype','writable','error','paid','Any\x20other\x20card\x20number','defineProperty','../services/telegramBotService','orderId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','processCardPayment','SINGLE','Payment\x20processed\x20successfully','testGatewayService','‚úÖ\x20Test\x20Gateway\x20payment\x20','default','\x20processed:\x20','‚ùå\x20Payment\x20link\x20','3895232avNvPq','WebhookService','1517670xhYPzO','üß™\x20Test\x20Gateway\x20result:','test_gateway_','successUrl','\x20not\x20enabled\x20for\x20shop\x20','slice','customerEmail','‚úÖ\x20Payment\x20link\x20','cardLast4','FAILED','cardNumber','hasOwnProperty','Payment\x20not\x20found','__setModuleDefault','create','0000','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','webhookEvents',',\x20cannot\x20process','sendPaymentStatusNotification','../services/gateways/testGatewayService','payment.success','Any\x20name','findUnique','2381813tIswHO','paymentLink','createdAt','328386obRFrD','toISOString','6tvqifP','parse','Any\x20future\x20date\x20(MM/YY)','../config/database','paidAt','failureMessage','toLowerCase','type','now','__createBinding','paymentMethod','sendShopWebhook','call','gatewayOrderId','üìà\x20Test\x20Gateway:\x20Payment\x20','1636dbDNGd','üìà\x20Found\x20payment\x20link\x20','getOwnPropertyNames','webhookUrl','failureReason','status','__esModule','then',':\x20type=','gateway','configurable','stringify','currentPayments','Payment\x20is\x20not\x20for\x20test\x20gateway','json','PENDING','currency','transactionId','\x20with\x20status\x20','shop',',\x20status=','Payment\x20failed','includes','payment','Payment\x20to\x20','failed','amount','update','COMPLETED','gatewayPaymentId','POST','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:'];a15_0x244c=function(){return _0x4cc62a;};return a15_0x244c();}var __createBinding=this&&this[a15_0x1f4ef0(0xe9)]||(Object['create']?function(_0x3133c0,_0xd96f8a,_0x14b293,_0x4b1206){const _0x5d5140=a15_0x1f4ef0;if(_0x4b1206===undefined)_0x4b1206=_0x14b293;var _0x1f1388=Object[_0x5d5140(0x11e)](_0xd96f8a,_0x14b293);(!_0x1f1388||('get'in _0x1f1388?!_0xd96f8a[_0x5d5140(0xf5)]:_0x1f1388[_0x5d5140(0x129)]||_0x1f1388[_0x5d5140(0xf9)]))&&(_0x1f1388={'enumerable':!![],'get':function(){return _0xd96f8a[_0x14b293];}}),Object[_0x5d5140(0x12d)](_0x3133c0,_0x4b1206,_0x1f1388);}:function(_0x59488b,_0x6654f2,_0x43a52d,_0x277809){if(_0x277809===undefined)_0x277809=_0x43a52d;_0x59488b[_0x277809]=_0x6654f2[_0x43a52d];}),__setModuleDefault=this&&this[a15_0x1f4ef0(0xd0)]||(Object[a15_0x1f4ef0(0xd1)]?function(_0x3f5512,_0x40504e){const _0x28fdba=a15_0x1f4ef0;Object[_0x28fdba(0x12d)](_0x3f5512,'default',{'enumerable':!![],'value':_0x40504e});}:function(_0x518d4f,_0x8f36bb){const _0x8c0965=a15_0x1f4ef0;_0x518d4f[_0x8c0965(0x136)]=_0x8f36bb;}),__importStar=this&&this[a15_0x1f4ef0(0x117)]||(function(){var _0x5aea33=function(_0x2d672f){const _0x53cdbe=a15_0x4d29;return _0x5aea33=Object[_0x53cdbe(0xf1)]||function(_0x50b24c){const _0x59714b=_0x53cdbe;var _0xf2c316=[];for(var _0x236c3c in _0x50b24c)if(Object[_0x59714b(0x128)][_0x59714b(0xce)][_0x59714b(0xec)](_0x50b24c,_0x236c3c))_0xf2c316[_0xf2c316['length']]=_0x236c3c;return _0xf2c316;},_0x5aea33(_0x2d672f);};return function(_0x102d1d){const _0x1f3387=a15_0x4d29;if(_0x102d1d&&_0x102d1d[_0x1f3387(0xf5)])return _0x102d1d;var _0x2291aa={};if(_0x102d1d!=null){for(var _0x2783a8=_0x5aea33(_0x102d1d),_0x338300=0x0;_0x338300<_0x2783a8['length'];_0x338300++)if(_0x2783a8[_0x338300]!==_0x1f3387(0x136))__createBinding(_0x2291aa,_0x102d1d,_0x2783a8[_0x338300]);}return __setModuleDefault(_0x2291aa,_0x102d1d),_0x2291aa;};}()),__importDefault=this&&this['__importDefault']||function(_0x49c945){return _0x49c945&&_0x49c945['__esModule']?_0x49c945:{'default':_0x49c945};};Object['defineProperty'](exports,a15_0x1f4ef0(0xf5),{'value':!![]}),exports[a15_0x1f4ef0(0x124)]=void 0x0;const testGatewayService_1=require(a15_0x1f4ef0(0xd7)),webhookService_1=require(a15_0x1f4ef0(0x11a)),database_1=__importDefault(require(a15_0x1f4ef0(0xe3)));class TestGatewayController{constructor(){const _0x5c3dad=a15_0x1f4ef0;this['getPaymentForm']=async(_0x1b97ce,_0x3fb21a,_0x2a9894)=>{const _0x5cf1bc=a15_0x4d29;try{const {paymentId:_0x5d620a}=_0x1b97ce['params'];console['log'](_0x5cf1bc(0xd3)+_0x5d620a);const _0x563019=await database_1['default'][_0x5cf1bc(0x106)][_0x5cf1bc(0xda)]({'where':{'id':_0x5d620a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x563019)return _0x3fb21a[_0x5cf1bc(0xf4)](0x194)[_0x5cf1bc(0xfd)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x563019[_0x5cf1bc(0xf8)]!=='test_gateway')return _0x3fb21a['status'](0x190)[_0x5cf1bc(0xfd)]({'success':![],'message':_0x5cf1bc(0xfc)});if(_0x563019[_0x5cf1bc(0xf4)]!==_0x5cf1bc(0xfe))return _0x3fb21a[_0x5cf1bc(0xf4)](0x190)[_0x5cf1bc(0xfd)]({'success':![],'message':_0x5cf1bc(0x123)+_0x563019[_0x5cf1bc(0xf4)]+',\x20cannot\x20process'});_0x3fb21a[_0x5cf1bc(0xfd)]({'success':!![],'result':{'paymentId':_0x563019['id'],'orderId':_0x563019[_0x5cf1bc(0xed)],'amount':_0x563019[_0x5cf1bc(0x109)],'currency':_0x563019[_0x5cf1bc(0xff)],'merchantName':_0x563019[_0x5cf1bc(0x102)]['name'],'description':_0x5cf1bc(0x107)+_0x563019[_0x5cf1bc(0x102)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5cf1bc(0x12c),'expiryDate':_0x5cf1bc(0xe2),'cvc':_0x5cf1bc(0x112),'holderName':_0x5cf1bc(0xd9)}}});}catch(_0x59059a){_0x2a9894(_0x59059a);}},this['processCard']=async(_0xacf4,_0x1c0a89,_0x514883)=>{const _0x56e173=a15_0x4d29;try{const {paymentId:_0x292c35}=_0xacf4[_0x56e173(0x10f)],_0x2a60bf=_0xacf4[_0x56e173(0x119)];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x292c35);const _0x33d5e9=await database_1[_0x56e173(0x136)][_0x56e173(0x106)][_0x56e173(0xda)]({'where':{'id':_0x292c35},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33d5e9)return _0x1c0a89[_0x56e173(0xf4)](0x194)['json']({'success':![],'message':_0x56e173(0xcf)});if(_0x33d5e9['gateway']!=='test_gateway')return _0x1c0a89[_0x56e173(0xf4)](0x190)[_0x56e173(0xfd)]({'success':![],'message':_0x56e173(0xfc)});if(_0x33d5e9['status']!=='PENDING')return _0x1c0a89[_0x56e173(0xf4)](0x190)[_0x56e173(0xfd)]({'success':![],'message':_0x56e173(0x123)+_0x33d5e9[_0x56e173(0xf4)]+_0x56e173(0xd5)});const _0x49ed08=await this[_0x56e173(0x134)][_0x56e173(0x131)]({'paymentId':_0x33d5e9['id'],'orderId':_0x33d5e9[_0x56e173(0xed)]||_0x33d5e9['id'],'amount':_0x33d5e9[_0x56e173(0x109)],'currency':_0x33d5e9[_0x56e173(0xff)],'cardData':_0x2a60bf});console[_0x56e173(0x114)](_0x56e173(0x13c),_0x49ed08);const _0x545efa={'status':_0x49ed08[_0x56e173(0xf4)],'updatedAt':new Date()};if(_0x49ed08[_0x56e173(0xf4)]===_0x56e173(0x11c))_0x545efa[_0x56e173(0xe4)]=new Date(),_0x545efa[_0x56e173(0x10c)]=_0x49ed08[_0x56e173(0x100)];else _0x49ed08[_0x56e173(0xf4)]===_0x56e173(0xcc)&&(_0x545efa[_0x56e173(0xe5)]=_0x49ed08['failureReason']);const _0x1b6757=_0x2a60bf[_0x56e173(0xcd)]['replace'](/[\s-]/g,'');_0x545efa[_0x56e173(0xcb)]=_0x1b6757[_0x56e173(0x140)](-0x4),_0x545efa[_0x56e173(0xea)]=_0x56e173(0x11f),await database_1['default'][_0x56e173(0x106)][_0x56e173(0x10a)]({'where':{'id':_0x33d5e9['id']},'data':_0x545efa});if(_0x49ed08[_0x56e173(0xf4)]===_0x56e173(0x11c)&&_0x33d5e9['paymentLinkId']){console[_0x56e173(0x114)](_0x56e173(0xee)+_0x33d5e9['id']+_0x56e173(0x115));try{await database_1[_0x56e173(0x136)]['$transaction'](async _0x3341a8=>{const _0x31efa0=_0x56e173,_0xfe00de=await _0x3341a8['paymentLink']['findUnique']({'where':{'id':_0x33d5e9[_0x31efa0(0x122)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xfe00de){console['log'](_0x31efa0(0xf0)+_0xfe00de['id']+_0x31efa0(0xf7)+_0xfe00de[_0x31efa0(0xe7)]+',\x20currentPayments='+_0xfe00de[_0x31efa0(0xfb)]+_0x31efa0(0x103)+_0xfe00de[_0x31efa0(0xf4)]);const _0x5f0fc4=_0xfe00de[_0x31efa0(0xfb)]+0x1,_0xe99d81=_0xfe00de[_0x31efa0(0xe7)]===_0x31efa0(0x132)?_0x31efa0(0x10b):_0xfe00de[_0x31efa0(0xf4)];await _0x3341a8[_0x31efa0(0xdc)][_0x31efa0(0x10a)]({'where':{'id':_0x33d5e9[_0x31efa0(0x122)]},'data':{'currentPayments':_0x5f0fc4,'status':_0xe99d81,'updatedAt':new Date()}}),console[_0x31efa0(0x114)](_0x31efa0(0xca)+_0xfe00de['id']+'\x20updated:\x20currentPayments='+_0xfe00de[_0x31efa0(0xfb)]+_0x31efa0(0x118)+_0x5f0fc4+',\x20status='+_0xfe00de['status']+_0x31efa0(0x118)+_0xe99d81);}else console['log'](_0x31efa0(0x138)+_0x33d5e9[_0x31efa0(0x122)]+'\x20not\x20found');});}catch(_0x271929){console[_0x56e173(0x12a)](_0x56e173(0x111),_0x271929);}}await database_1[_0x56e173(0x136)]['webhookLog'][_0x56e173(0xd1)]({'data':{'paymentId':_0x33d5e9['id'],'shopId':_0x33d5e9[_0x56e173(0x113)],'event':_0x56e173(0x13d)+_0x49ed08['status'][_0x56e173(0xe6)](),'statusCode':0xc8,'responseBody':JSON[_0x56e173(0xfa)]({'oldStatus':_0x56e173(0xfe),'newStatus':_0x49ed08['status'],'transactionId':_0x49ed08[_0x56e173(0x100)],'failureReason':_0x49ed08[_0x56e173(0xf3)],'processedAt':new Date()[_0x56e173(0xdf)]()})}}),await this['sendShopWebhook'](_0x33d5e9,_0x49ed08[_0x56e173(0xf4)],_0x49ed08['transactionId'],_0x49ed08['failureReason']),await this[_0x56e173(0xd6)](_0x33d5e9,_0x49ed08[_0x56e173(0xf4)]),console[_0x56e173(0x114)](_0x56e173(0x135)+_0x292c35+_0x56e173(0x137)+_0x49ed08[_0x56e173(0xf4)]),_0x49ed08[_0x56e173(0xf4)]===_0x56e173(0x11c)?_0x1c0a89[_0x56e173(0xfd)]({'success':!![],'message':_0x56e173(0x133),'result':{'status':_0x56e173(0x11c),'transactionId':_0x49ed08['transactionId'],'redirectUrl':_0x33d5e9[_0x56e173(0x13e)]}}):_0x1c0a89[_0x56e173(0xf4)](0x190)[_0x56e173(0xfd)]({'success':![],'message':_0x56e173(0x104),'result':{'status':_0x56e173(0xcc),'failureReason':_0x49ed08[_0x56e173(0xf3)],'redirectUrl':_0x33d5e9['failUrl']}});}catch(_0x48b748){_0x514883(_0x48b748);}},this[_0x5c3dad(0x134)]=new testGatewayService_1['TestGatewayService'](),this[_0x5c3dad(0x11d)]=new webhookService_1[(_0x5c3dad(0x13a))]();}async[a15_0x1f4ef0(0xeb)](_0x3f0bf4,_0x24dcd1,_0x3f9b33,_0x493108){const _0x1e9463=a15_0x1f4ef0,_0x5ba11e=Date[_0x1e9463(0xe8)]();try{const _0x4dece1=_0x3f0bf4[_0x1e9463(0x102)],_0x25c7a6=_0x4dece1['settings'];if(!_0x25c7a6?.[_0x1e9463(0xf2)]){console[_0x1e9463(0x114)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4dece1['id']);return;}const _0x41ce5e=_0x24dcd1===_0x1e9463(0x11c)?_0x1e9463(0xd8):_0x1e9463(0x120);let _0x1d3cb2=[];if(_0x25c7a6[_0x1e9463(0xd4)])try{_0x1d3cb2=Array[_0x1e9463(0x121)](_0x25c7a6[_0x1e9463(0xd4)])?_0x25c7a6[_0x1e9463(0xd4)]:JSON[_0x1e9463(0xe1)](_0x25c7a6['webhookEvents']);}catch(_0x1d1f38){console[_0x1e9463(0x12a)](_0x1e9463(0x116),_0x1d1f38),_0x1d3cb2=[];}if(!_0x1d3cb2[_0x1e9463(0x105)](_0x41ce5e)){console[_0x1e9463(0x114)]('Webhook\x20event\x20'+_0x41ce5e+_0x1e9463(0x13f)+_0x4dece1['id']);return;}const _0x5f5c35={'event':_0x41ce5e,'payment':{'id':_0x3f0bf4['id'],'order_id':_0x3f0bf4[_0x1e9463(0x12f)],'gateway_order_id':_0x3f0bf4['gatewayOrderId'],'gateway':_0x1e9463(0xd2),'amount':_0x3f0bf4[_0x1e9463(0x109)],'currency':_0x3f0bf4[_0x1e9463(0xff)],'status':_0x24dcd1[_0x1e9463(0xe6)](),'customer_email':_0x3f0bf4[_0x1e9463(0xc9)],'customer_name':_0x3f0bf4[_0x1e9463(0x11b)],'transaction_id':_0x3f9b33,'failure_message':_0x493108,'created_at':_0x3f0bf4[_0x1e9463(0xdd)],'updated_at':new Date()}},_0x2308e5=await fetch(_0x25c7a6[_0x1e9463(0xf2)],{'method':_0x1e9463(0x10d),'headers':{'Content-Type':'application/json','User-Agent':_0x1e9463(0x125)},'body':JSON[_0x1e9463(0xfa)](_0x5f5c35)}),_0x141620=Date[_0x1e9463(0xe8)]()-_0x5ba11e;console[_0x1e9463(0x114)](_0x1e9463(0x130)+_0x25c7a6[_0x1e9463(0xf2)]+_0x1e9463(0x101)+_0x2308e5[_0x1e9463(0xf4)]+'\x20('+_0x141620+'ms)');}catch(_0x12c1f1){console['error'](_0x1e9463(0x10e),_0x12c1f1);}}async[a15_0x1f4ef0(0xd6)](_0x3305ac,_0x5a83b5){const _0x25e7cc=a15_0x1f4ef0;try{const {telegramBotService:_0x580055}=await Promise[_0x25e7cc(0x127)]()[_0x25e7cc(0xf6)](()=>__importStar(require(_0x25e7cc(0x12e)))),_0x20be77={'PAID':_0x25e7cc(0x12b),'FAILED':_0x25e7cc(0x108)},_0x1398e4=_0x20be77[_0x5a83b5];if(!_0x1398e4)return;await _0x580055['sendPaymentNotification'](_0x3305ac['shopId'],_0x3305ac,_0x1398e4);}catch(_0x1ac9c5){console[_0x25e7cc(0x12a)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1ac9c5);}}}exports[a15_0x1f4ef0(0x124)]=TestGatewayController;