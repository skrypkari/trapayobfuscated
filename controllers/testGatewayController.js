'use strict';const a14_0x54705d=a14_0x5ecf;(function(_0x500023,_0x2953c8){const _0x136ede=a14_0x5ecf,_0x92b9fc=_0x500023();while(!![]){try{const _0x7a9814=-parseInt(_0x136ede(0x213))/0x1*(parseInt(_0x136ede(0x233))/0x2)+parseInt(_0x136ede(0x24f))/0x3*(parseInt(_0x136ede(0x209))/0x4)+-parseInt(_0x136ede(0x211))/0x5+-parseInt(_0x136ede(0x21c))/0x6*(-parseInt(_0x136ede(0x207))/0x7)+-parseInt(_0x136ede(0x231))/0x8+parseInt(_0x136ede(0x20f))/0x9*(parseInt(_0x136ede(0x21f))/0xa)+parseInt(_0x136ede(0x212))/0xb;if(_0x7a9814===_0x2953c8)break;else _0x92b9fc['push'](_0x92b9fc['shift']());}catch(_0x53f32a){_0x92b9fc['push'](_0x92b9fc['shift']());}}}(a14_0x3d1f,0x7a58f));var __createBinding=this&&this[a14_0x54705d(0x255)]||(Object[a14_0x54705d(0x1fd)]?function(_0x2c799b,_0x39fb77,_0x597a36,_0x45ce3e){const _0x332978=a14_0x54705d;if(_0x45ce3e===undefined)_0x45ce3e=_0x597a36;var _0x1036d4=Object['getOwnPropertyDescriptor'](_0x39fb77,_0x597a36);(!_0x1036d4||(_0x332978(0x202)in _0x1036d4?!_0x39fb77['__esModule']:_0x1036d4[_0x332978(0x269)]||_0x1036d4['configurable']))&&(_0x1036d4={'enumerable':!![],'get':function(){return _0x39fb77[_0x597a36];}}),Object[_0x332978(0x236)](_0x2c799b,_0x45ce3e,_0x1036d4);}:function(_0x39680b,_0x59c0c5,_0x422fa7,_0x230d6f){if(_0x230d6f===undefined)_0x230d6f=_0x422fa7;_0x39680b[_0x230d6f]=_0x59c0c5[_0x422fa7];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a14_0x54705d(0x1fd)]?function(_0x39c0a0,_0x3c2da0){const _0x3106b3=a14_0x54705d;Object[_0x3106b3(0x236)](_0x39c0a0,'default',{'enumerable':!![],'value':_0x3c2da0});}:function(_0x20d218,_0x2ce741){_0x20d218['default']=_0x2ce741;}),__importStar=this&&this[a14_0x54705d(0x259)]||(function(){var _0x1ce3a1=function(_0x36ca15){const _0xc8253b=a14_0x5ecf;return _0x1ce3a1=Object[_0xc8253b(0x21a)]||function(_0x58d744){const _0x5dc571=_0xc8253b;var _0x5d8d27=[];for(var _0x35809a in _0x58d744)if(Object[_0x5dc571(0x1f6)]['hasOwnProperty'][_0x5dc571(0x267)](_0x58d744,_0x35809a))_0x5d8d27[_0x5d8d27[_0x5dc571(0x251)]]=_0x35809a;return _0x5d8d27;},_0x1ce3a1(_0x36ca15);};return function(_0x1f70cd){const _0x3957f3=a14_0x5ecf;if(_0x1f70cd&&_0x1f70cd['__esModule'])return _0x1f70cd;var _0xb36c51={};if(_0x1f70cd!=null){for(var _0x68e1c0=_0x1ce3a1(_0x1f70cd),_0x159a5e=0x0;_0x159a5e<_0x68e1c0[_0x3957f3(0x251)];_0x159a5e++)if(_0x68e1c0[_0x159a5e]!=='default')__createBinding(_0xb36c51,_0x1f70cd,_0x68e1c0[_0x159a5e]);}return __setModuleDefault(_0xb36c51,_0x1f70cd),_0xb36c51;};}()),__importDefault=this&&this[a14_0x54705d(0x1f7)]||function(_0x529f68){return _0x529f68&&_0x529f68['__esModule']?_0x529f68:{'default':_0x529f68};};Object[a14_0x54705d(0x236)](exports,a14_0x54705d(0x20a),{'value':!![]}),exports[a14_0x54705d(0x210)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a14_0x54705d(0x245)),database_1=__importDefault(require(a14_0x54705d(0x25c)));function a14_0x3d1f(){const _0x43eba6=[',\x20status=','\x20updated:\x20currentPayments=','toLowerCase','isArray','FAILED','payment','prototype','__importDefault','Webhook\x20event\x20','createdAt','\x20with\x20status\x20','cardLast4','parse','create','cardNumber','paymentLinkId','currency','webhookUrl','get','successUrl','Any\x20other\x20card\x20number','\x20not\x20found','default','59017dQPDOx','COMPLETED','208FnXrvr','__esModule','gateway','Payment\x20status\x20is\x20','stringify','\x20processed:\x20','5334777ZdPhkH','TestGatewayController','4364105DgmeHM','9109892QKvGSN','43724mhKFxu','ms)','Payment\x20failed','findUnique','../services/telegramBotService','amount','paidAt','getOwnPropertyNames','log','120xWXaZO','sendPaymentStatusNotification','settings','10qBqTru','🧪\x20Test\x20Gateway\x20result:','test_card','gatewayPaymentId','PAID','gatewayOrderId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','failed','transactionId','error','WebhookService','params','Payment\x20not\x20found','payment.success','Any\x203-4\x20digits','then','sendShopWebhook','webhookService','1424552WxSbEd','Payment\x20processed\x20successfully','6FxDkFa','currentPayments','failureReason','defineProperty','getPaymentForm','test_gateway',',\x20cannot\x20process','shopId','PENDING','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','name','processCard','Payment\x20to\x20','customerEmail','✅\x20Test\x20Gateway\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','update','testGatewayService','../services/webhookService','$transaction','type','json','failUrl','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','TestGatewayService','replace','now','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','5403mCncjb','📈\x20Found\x20payment\x20link\x20','length','webhookEvents','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','toISOString','__createBinding','paid','paymentLink','4242\x204242\x204242\x204242','__importStar','Error\x20parsing\x20webhook\x20events:','failureMessage','../config/database','✅\x20Payment\x20link\x20',',\x20currentPayments=','test_gateway_','SINGLE','includes','❌\x20Payment\x20link\x20','body','status','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shop','call','Payment\x20System/1.0\x20(Test\x20Gateway)','writable','Any\x20future\x20date\x20(MM/YY)'];a14_0x3d1f=function(){return _0x43eba6;};return a14_0x3d1f();}class TestGatewayController{constructor(){const _0x39f945=a14_0x54705d;this[_0x39f945(0x237)]=async(_0x54208c,_0x5dc1e1,_0x430f75)=>{const _0x47a9dd=_0x39f945;try{const {paymentId:_0x3ad477}=_0x54208c[_0x47a9dd(0x22a)];console['log'](_0x47a9dd(0x24a)+_0x3ad477);const _0x45f7ac=await database_1[_0x47a9dd(0x206)][_0x47a9dd(0x1f5)]['findUnique']({'where':{'id':_0x3ad477},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x45f7ac)return _0x5dc1e1[_0x47a9dd(0x264)](0x194)[_0x47a9dd(0x248)]({'success':![],'message':_0x47a9dd(0x22b)});if(_0x45f7ac['gateway']!==_0x47a9dd(0x238))return _0x5dc1e1[_0x47a9dd(0x264)](0x190)['json']({'success':![],'message':_0x47a9dd(0x242)});if(_0x45f7ac[_0x47a9dd(0x264)]!==_0x47a9dd(0x23b))return _0x5dc1e1[_0x47a9dd(0x264)](0x190)[_0x47a9dd(0x248)]({'success':![],'message':_0x47a9dd(0x20c)+_0x45f7ac[_0x47a9dd(0x264)]+_0x47a9dd(0x239)});_0x5dc1e1[_0x47a9dd(0x248)]({'success':!![],'result':{'paymentId':_0x45f7ac['id'],'orderId':_0x45f7ac[_0x47a9dd(0x224)],'amount':_0x45f7ac['amount'],'currency':_0x45f7ac['currency'],'merchantName':_0x45f7ac[_0x47a9dd(0x266)][_0x47a9dd(0x23d)],'description':_0x47a9dd(0x23f)+_0x45f7ac[_0x47a9dd(0x266)][_0x47a9dd(0x23d)],'testInstructions':{'successCard':_0x47a9dd(0x258),'failureCard':_0x47a9dd(0x204),'expiryDate':_0x47a9dd(0x26a),'cvc':_0x47a9dd(0x22d),'holderName':'Any\x20name'}}});}catch(_0x884a80){_0x430f75(_0x884a80);}},this[_0x39f945(0x23e)]=async(_0x27d6fb,_0x16d81d,_0x1f99ec)=>{const _0x40e447=_0x39f945;try{const {paymentId:_0x348e48}=_0x27d6fb[_0x40e447(0x22a)],_0x4cff2b=_0x27d6fb[_0x40e447(0x263)];console[_0x40e447(0x21b)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x348e48);const _0x5c7f27=await database_1['default'][_0x40e447(0x1f5)][_0x40e447(0x216)]({'where':{'id':_0x348e48},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c7f27)return _0x16d81d[_0x40e447(0x264)](0x194)[_0x40e447(0x248)]({'success':![],'message':_0x40e447(0x22b)});if(_0x5c7f27[_0x40e447(0x20b)]!==_0x40e447(0x238))return _0x16d81d[_0x40e447(0x264)](0x190)[_0x40e447(0x248)]({'success':![],'message':_0x40e447(0x242)});if(_0x5c7f27['status']!==_0x40e447(0x23b))return _0x16d81d[_0x40e447(0x264)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5c7f27['status']+_0x40e447(0x239)});const _0x18cec5=await this['testGatewayService']['processCardPayment']({'paymentId':_0x5c7f27['id'],'orderId':_0x5c7f27[_0x40e447(0x224)]||_0x5c7f27['id'],'amount':_0x5c7f27['amount'],'currency':_0x5c7f27['currency'],'cardData':_0x4cff2b});console[_0x40e447(0x21b)](_0x40e447(0x220),_0x18cec5);const _0x3a3323={'status':_0x18cec5[_0x40e447(0x264)],'updatedAt':new Date()};if(_0x18cec5[_0x40e447(0x264)]===_0x40e447(0x223))_0x3a3323[_0x40e447(0x219)]=new Date(),_0x3a3323[_0x40e447(0x222)]=_0x18cec5[_0x40e447(0x227)];else _0x18cec5[_0x40e447(0x264)]===_0x40e447(0x1f4)&&(_0x3a3323[_0x40e447(0x25b)]=_0x18cec5[_0x40e447(0x235)]);const _0x4898f3=_0x4cff2b[_0x40e447(0x1fe)][_0x40e447(0x24c)](/[\s-]/g,'');_0x3a3323[_0x40e447(0x1fb)]=_0x4898f3['slice'](-0x4),_0x3a3323['paymentMethod']=_0x40e447(0x221),await database_1[_0x40e447(0x206)][_0x40e447(0x1f5)][_0x40e447(0x243)]({'where':{'id':_0x5c7f27['id']},'data':_0x3a3323});if(_0x18cec5[_0x40e447(0x264)]===_0x40e447(0x223)&&_0x5c7f27[_0x40e447(0x1ff)]){console[_0x40e447(0x21b)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x5c7f27['id']+_0x40e447(0x24e));try{await database_1[_0x40e447(0x206)][_0x40e447(0x246)](async _0x5699c9=>{const _0x2677ae=_0x40e447,_0x3e3296=await _0x5699c9[_0x2677ae(0x257)][_0x2677ae(0x216)]({'where':{'id':_0x5c7f27[_0x2677ae(0x1ff)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3e3296){console['log'](_0x2677ae(0x250)+_0x3e3296['id']+':\x20type='+_0x3e3296[_0x2677ae(0x247)]+_0x2677ae(0x25e)+_0x3e3296[_0x2677ae(0x234)]+_0x2677ae(0x26b)+_0x3e3296[_0x2677ae(0x264)]);const _0x25122c=_0x3e3296[_0x2677ae(0x234)]+0x1,_0x2c15d8=_0x3e3296[_0x2677ae(0x247)]===_0x2677ae(0x260)?_0x2677ae(0x208):_0x3e3296[_0x2677ae(0x264)];await _0x5699c9[_0x2677ae(0x257)][_0x2677ae(0x243)]({'where':{'id':_0x5c7f27[_0x2677ae(0x1ff)]},'data':{'currentPayments':_0x25122c,'status':_0x2c15d8,'updatedAt':new Date()}}),console[_0x2677ae(0x21b)](_0x2677ae(0x25d)+_0x3e3296['id']+_0x2677ae(0x26c)+_0x3e3296[_0x2677ae(0x234)]+'\x20->\x20'+_0x25122c+',\x20status='+_0x3e3296[_0x2677ae(0x264)]+'\x20->\x20'+_0x2c15d8);}else console[_0x2677ae(0x21b)](_0x2677ae(0x262)+_0x5c7f27[_0x2677ae(0x1ff)]+_0x2677ae(0x205));});}catch(_0xe7faa5){console[_0x40e447(0x228)](_0x40e447(0x253),_0xe7faa5);}}await database_1[_0x40e447(0x206)]['webhookLog'][_0x40e447(0x1fd)]({'data':{'paymentId':_0x5c7f27['id'],'shopId':_0x5c7f27[_0x40e447(0x23a)],'event':_0x40e447(0x25f)+_0x18cec5['status'][_0x40e447(0x26d)](),'statusCode':0xc8,'responseBody':JSON[_0x40e447(0x20d)]({'oldStatus':_0x40e447(0x23b),'newStatus':_0x18cec5[_0x40e447(0x264)],'transactionId':_0x18cec5['transactionId'],'failureReason':_0x18cec5[_0x40e447(0x235)],'processedAt':new Date()[_0x40e447(0x254)]()})}}),await this[_0x40e447(0x22f)](_0x5c7f27,_0x18cec5[_0x40e447(0x264)],_0x18cec5[_0x40e447(0x227)],_0x18cec5[_0x40e447(0x235)]),await this['sendPaymentStatusNotification'](_0x5c7f27,_0x18cec5['status']),console['log'](_0x40e447(0x241)+_0x348e48+_0x40e447(0x20e)+_0x18cec5[_0x40e447(0x264)]),_0x18cec5['status']==='PAID'?_0x16d81d[_0x40e447(0x248)]({'success':!![],'message':_0x40e447(0x232),'result':{'status':_0x40e447(0x223),'transactionId':_0x18cec5[_0x40e447(0x227)],'redirectUrl':_0x5c7f27[_0x40e447(0x203)]}}):_0x16d81d[_0x40e447(0x264)](0x190)[_0x40e447(0x248)]({'success':![],'message':_0x40e447(0x215),'result':{'status':_0x40e447(0x1f4),'failureReason':_0x18cec5['failureReason'],'redirectUrl':_0x5c7f27[_0x40e447(0x249)]}});}catch(_0x9eacb0){_0x1f99ec(_0x9eacb0);}},this[_0x39f945(0x244)]=new testGatewayService_1[(_0x39f945(0x24b))](),this[_0x39f945(0x230)]=new webhookService_1[(_0x39f945(0x229))]();}async['sendShopWebhook'](_0x2636bc,_0x278fd0,_0x11e167,_0x2d8c55){const _0x1d1fbd=a14_0x54705d,_0x16f78b=Date[_0x1d1fbd(0x24d)]();try{const _0x5a84b4=_0x2636bc[_0x1d1fbd(0x266)],_0x17659b=_0x5a84b4[_0x1d1fbd(0x21e)];if(!_0x17659b?.[_0x1d1fbd(0x201)]){console[_0x1d1fbd(0x21b)](_0x1d1fbd(0x23c)+_0x5a84b4['id']);return;}const _0x1cb0a7=_0x278fd0===_0x1d1fbd(0x223)?_0x1d1fbd(0x22c):'payment.failed';let _0x4ba5a1=[];if(_0x17659b[_0x1d1fbd(0x252)])try{_0x4ba5a1=Array[_0x1d1fbd(0x1f3)](_0x17659b[_0x1d1fbd(0x252)])?_0x17659b[_0x1d1fbd(0x252)]:JSON[_0x1d1fbd(0x1fc)](_0x17659b['webhookEvents']);}catch(_0xedd78b){console[_0x1d1fbd(0x228)](_0x1d1fbd(0x25a),_0xedd78b),_0x4ba5a1=[];}if(!_0x4ba5a1[_0x1d1fbd(0x261)](_0x1cb0a7)){console['log'](_0x1d1fbd(0x1f8)+_0x1cb0a7+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5a84b4['id']);return;}const _0x4ff01e={'event':_0x1cb0a7,'payment':{'id':_0x2636bc['id'],'order_id':_0x2636bc['orderId'],'gateway_order_id':_0x2636bc['gatewayOrderId'],'gateway':'0000','amount':_0x2636bc[_0x1d1fbd(0x218)],'currency':_0x2636bc[_0x1d1fbd(0x200)],'status':_0x278fd0[_0x1d1fbd(0x26d)](),'customer_email':_0x2636bc[_0x1d1fbd(0x240)],'customer_name':_0x2636bc['customerName'],'transaction_id':_0x11e167,'failure_message':_0x2d8c55,'created_at':_0x2636bc[_0x1d1fbd(0x1f9)],'updated_at':new Date()}},_0x183c6f=await fetch(_0x17659b[_0x1d1fbd(0x201)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x1d1fbd(0x268)},'body':JSON[_0x1d1fbd(0x20d)](_0x4ff01e)}),_0x40d9d6=Date['now']()-_0x16f78b;console[_0x1d1fbd(0x21b)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x17659b[_0x1d1fbd(0x201)]+_0x1d1fbd(0x1fa)+_0x183c6f[_0x1d1fbd(0x264)]+'\x20('+_0x40d9d6+_0x1d1fbd(0x214));}catch(_0x1f0a5e){console[_0x1d1fbd(0x228)](_0x1d1fbd(0x225),_0x1f0a5e);}}async[a14_0x54705d(0x21d)](_0x24eb80,_0x1ef604){const _0x581c7c=a14_0x54705d;try{const {telegramBotService:_0x164580}=await Promise['resolve']()[_0x581c7c(0x22e)](()=>__importStar(require(_0x581c7c(0x217)))),_0x27c857={'PAID':_0x581c7c(0x256),'FAILED':_0x581c7c(0x226)},_0x568a88=_0x27c857[_0x1ef604];if(!_0x568a88)return;await _0x164580['sendPaymentNotification'](_0x24eb80[_0x581c7c(0x23a)],_0x24eb80,_0x568a88);}catch(_0x466293){console['error'](_0x581c7c(0x265),_0x466293);}}}function a14_0x5ecf(_0x408461,_0x1fac84){const _0x3d1fee=a14_0x3d1f();return a14_0x5ecf=function(_0x5ecf5a,_0x499b13){_0x5ecf5a=_0x5ecf5a-0x1f3;let _0x58f381=_0x3d1fee[_0x5ecf5a];return _0x58f381;},a14_0x5ecf(_0x408461,_0x1fac84);}exports[a14_0x54705d(0x210)]=TestGatewayController;