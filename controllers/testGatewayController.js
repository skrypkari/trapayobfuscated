'use strict';const a13_0x5ba4cc=a13_0xdfe4;(function(_0x3d6487,_0x1ccfba){const _0x55046a=a13_0xdfe4,_0x35ef90=_0x3d6487();while(!![]){try{const _0x326134=-parseInt(_0x55046a(0x132))/0x1*(-parseInt(_0x55046a(0x112))/0x2)+parseInt(_0x55046a(0xfa))/0x3*(parseInt(_0x55046a(0xca))/0x4)+-parseInt(_0x55046a(0x116))/0x5+-parseInt(_0x55046a(0xc4))/0x6*(parseInt(_0x55046a(0x137))/0x7)+parseInt(_0x55046a(0xeb))/0x8*(-parseInt(_0x55046a(0x107))/0x9)+-parseInt(_0x55046a(0x111))/0xa*(-parseInt(_0x55046a(0xcb))/0xb)+parseInt(_0x55046a(0x134))/0xc*(parseInt(_0x55046a(0x130))/0xd);if(_0x326134===_0x1ccfba)break;else _0x35ef90['push'](_0x35ef90['shift']());}catch(_0x1d1c8f){_0x35ef90['push'](_0x35ef90['shift']());}}}(a13_0x3207,0xe5f01));function a13_0x3207(){const _0xcb82cd=['2371411tdMUNr','sendShopWebhook','ms)','üìà\x20Found\x20payment\x20link\x20','Any\x203-4\x20digits','cardLast4','24HSoHKl','parse','processCard','log','length','Any\x20future\x20date\x20(MM/YY)','11332CMAoWr','343871xqHfAE','‚úÖ\x20Payment\x20link\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','paymentMethod','PAID','failureMessage','Payment\x20failed','failUrl','Any\x20other\x20card\x20number','gatewayPaymentId','orderId','status',',\x20cannot\x20process','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','$transaction','includes','paymentLinkId','0000','payment','settings','Error\x20parsing\x20webhook\x20events:','testGatewayService','Payment\x20status\x20is\x20','TestGatewayService','toLowerCase','webhookUrl','\x20->\x20','error',',\x20currentPayments=','createdAt','type',',\x20status=','353736NUuBdH','now','toISOString','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','getOwnPropertyNames','test_card','shopId','payment.success','../services/webhookService','name','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerEmail','gatewayOrderId','json','759KJNAyV','isArray','Payment\x20is\x20not\x20for\x20test\x20gateway','hasOwnProperty','WebhookService','COMPLETED','Payment\x20not\x20found','prototype','__createBinding','shop','default','webhookEvents','create','153pEJdKm','webhookService','paidAt','successUrl','currency','üß™\x20Test\x20Gateway\x20result:','‚úÖ\x20Test\x20Gateway\x20payment\x20','customerName','resolve','__setModuleDefault','190MEOOVq','62hJqlXg','__esModule','defineProperty','writable','8219385lEDsWj','Payment\x20to\x20','findUnique','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','failureReason','body','\x20processed:\x20','amount','then','getPaymentForm','test_gateway','PENDING','stringify','FAILED','paymentLink','TestGatewayController','gateway','sendPaymentStatusNotification','paid','‚ùå\x20Payment\x20link\x20','failed','currentPayments','slice','update','üìà\x20Test\x20Gateway:\x20Payment\x20','webhookLog','24508653CrgJKW','replace','48274saZpbs','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','12TbiQOs','cardNumber','transactionId'];a13_0x3207=function(){return _0xcb82cd;};return a13_0x3207();}var __createBinding=this&&this[a13_0x5ba4cc(0x102)]||(Object[a13_0x5ba4cc(0x106)]?function(_0x4bfe57,_0x1110fc,_0x536a3f,_0x2d0f43){const _0x555fde=a13_0x5ba4cc;if(_0x2d0f43===undefined)_0x2d0f43=_0x536a3f;var _0x52f30e=Object['getOwnPropertyDescriptor'](_0x1110fc,_0x536a3f);(!_0x52f30e||('get'in _0x52f30e?!_0x1110fc[_0x555fde(0x113)]:_0x52f30e[_0x555fde(0x115)]||_0x52f30e['configurable']))&&(_0x52f30e={'enumerable':!![],'get':function(){return _0x1110fc[_0x536a3f];}}),Object[_0x555fde(0x114)](_0x4bfe57,_0x2d0f43,_0x52f30e);}:function(_0x3a160e,_0x4701e5,_0x44fc44,_0x2f723d){if(_0x2f723d===undefined)_0x2f723d=_0x44fc44;_0x3a160e[_0x2f723d]=_0x4701e5[_0x44fc44];}),__setModuleDefault=this&&this[a13_0x5ba4cc(0x110)]||(Object['create']?function(_0x186001,_0x2d0081){const _0x2025b6=a13_0x5ba4cc;Object[_0x2025b6(0x114)](_0x186001,_0x2025b6(0x104),{'enumerable':!![],'value':_0x2d0081});}:function(_0x4be7af,_0x9e7098){const _0x3f0c84=a13_0x5ba4cc;_0x4be7af[_0x3f0c84(0x104)]=_0x9e7098;}),__importStar=this&&this['__importStar']||(function(){var _0x253484=function(_0x4ba0a1){const _0x320bb3=a13_0xdfe4;return _0x253484=Object[_0x320bb3(0xf0)]||function(_0x18a61b){const _0x1dcdb1=_0x320bb3;var _0x5cae6b=[];for(var _0x22d6dd in _0x18a61b)if(Object[_0x1dcdb1(0x101)][_0x1dcdb1(0xfd)]['call'](_0x18a61b,_0x22d6dd))_0x5cae6b[_0x5cae6b[_0x1dcdb1(0xc8)]]=_0x22d6dd;return _0x5cae6b;},_0x253484(_0x4ba0a1);};return function(_0x31a524){const _0x28d821=a13_0xdfe4;if(_0x31a524&&_0x31a524[_0x28d821(0x113)])return _0x31a524;var _0x42f5c6={};if(_0x31a524!=null){for(var _0x531f0d=_0x253484(_0x31a524),_0x5d3ea7=0x0;_0x5d3ea7<_0x531f0d[_0x28d821(0xc8)];_0x5d3ea7++)if(_0x531f0d[_0x5d3ea7]!==_0x28d821(0x104))__createBinding(_0x42f5c6,_0x31a524,_0x531f0d[_0x5d3ea7]);}return __setModuleDefault(_0x42f5c6,_0x31a524),_0x42f5c6;};}()),__importDefault=this&&this['__importDefault']||function(_0x207b72){return _0x207b72&&_0x207b72['__esModule']?_0x207b72:{'default':_0x207b72};};Object[a13_0x5ba4cc(0x114)](exports,a13_0x5ba4cc(0x113),{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0xdfe4(_0x45e0be,_0x104685){const _0x3207dd=a13_0x3207();return a13_0xdfe4=function(_0xdfe4fc,_0x51f018){_0xdfe4fc=_0xdfe4fc-0xc2;let _0x534df1=_0x3207dd[_0xdfe4fc];return _0x534df1;},a13_0xdfe4(_0x45e0be,_0x104685);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x5ba4cc(0xf4)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x62d887=a13_0x5ba4cc;this[_0x62d887(0x11f)]=async(_0xf33e2d,_0x49795f,_0x34bc59)=>{const _0x441f9e=_0x62d887;try{const {paymentId:_0x1770e8}=_0xf33e2d['params'];console[_0x441f9e(0xc7)](_0x441f9e(0xef)+_0x1770e8);const _0x4f184a=await database_1['default'][_0x441f9e(0xdd)][_0x441f9e(0x118)]({'where':{'id':_0x1770e8},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4f184a)return _0x49795f[_0x441f9e(0xd6)](0x194)[_0x441f9e(0xf9)]({'success':![],'message':_0x441f9e(0x100)});if(_0x4f184a[_0x441f9e(0x126)]!==_0x441f9e(0x120))return _0x49795f[_0x441f9e(0xd6)](0x190)[_0x441f9e(0xf9)]({'success':![],'message':_0x441f9e(0xfc)});if(_0x4f184a[_0x441f9e(0xd6)]!==_0x441f9e(0x121))return _0x49795f[_0x441f9e(0xd6)](0x190)[_0x441f9e(0xf9)]({'success':![],'message':_0x441f9e(0xe1)+_0x4f184a[_0x441f9e(0xd6)]+_0x441f9e(0xd7)});_0x49795f[_0x441f9e(0xf9)]({'success':!![],'result':{'paymentId':_0x4f184a['id'],'orderId':_0x4f184a['gatewayOrderId'],'amount':_0x4f184a['amount'],'currency':_0x4f184a['currency'],'merchantName':_0x4f184a[_0x441f9e(0x103)]['name'],'description':_0x441f9e(0x117)+_0x4f184a[_0x441f9e(0x103)][_0x441f9e(0xf5)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x441f9e(0xd3),'expiryDate':_0x441f9e(0xc9),'cvc':_0x441f9e(0xc2),'holderName':'Any\x20name'}}});}catch(_0x5d8c5c){_0x34bc59(_0x5d8c5c);}},this[_0x62d887(0xc6)]=async(_0x2913d3,_0x4bfcff,_0x55b109)=>{const _0x549ee6=_0x62d887;try{const {paymentId:_0x405157}=_0x2913d3['params'],_0x1c3a44=_0x2913d3[_0x549ee6(0x11b)];console[_0x549ee6(0xc7)](_0x549ee6(0xd8)+_0x405157);const _0x1d47ab=await database_1[_0x549ee6(0x104)][_0x549ee6(0xdd)]['findUnique']({'where':{'id':_0x405157},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d47ab)return _0x4bfcff[_0x549ee6(0xd6)](0x194)['json']({'success':![],'message':_0x549ee6(0x100)});if(_0x1d47ab[_0x549ee6(0x126)]!==_0x549ee6(0x120))return _0x4bfcff[_0x549ee6(0xd6)](0x190)[_0x549ee6(0xf9)]({'success':![],'message':_0x549ee6(0xfc)});if(_0x1d47ab[_0x549ee6(0xd6)]!=='PENDING')return _0x4bfcff[_0x549ee6(0xd6)](0x190)['json']({'success':![],'message':_0x549ee6(0xe1)+_0x1d47ab['status']+_0x549ee6(0xd7)});const _0x4a7594=await this[_0x549ee6(0xe0)]['processCardPayment']({'paymentId':_0x1d47ab['id'],'orderId':_0x1d47ab[_0x549ee6(0xf8)]||_0x1d47ab['id'],'amount':_0x1d47ab[_0x549ee6(0x11d)],'currency':_0x1d47ab[_0x549ee6(0x10b)],'cardData':_0x1c3a44});console[_0x549ee6(0xc7)](_0x549ee6(0x10c),_0x4a7594);const _0x46e881={'status':_0x4a7594[_0x549ee6(0xd6)],'updatedAt':new Date()};if(_0x4a7594[_0x549ee6(0xd6)]===_0x549ee6(0xcf))_0x46e881[_0x549ee6(0x109)]=new Date(),_0x46e881[_0x549ee6(0xd4)]=_0x4a7594[_0x549ee6(0x136)];else _0x4a7594['status']===_0x549ee6(0x123)&&(_0x46e881[_0x549ee6(0xd0)]=_0x4a7594[_0x549ee6(0x11a)]);const _0xd9fd85=_0x1c3a44[_0x549ee6(0x135)][_0x549ee6(0x131)](/[\s-]/g,'');_0x46e881[_0x549ee6(0xc3)]=_0xd9fd85[_0x549ee6(0x12c)](-0x4),_0x46e881[_0x549ee6(0xce)]=_0x549ee6(0xf1),await database_1[_0x549ee6(0x104)][_0x549ee6(0xdd)][_0x549ee6(0x12d)]({'where':{'id':_0x1d47ab['id']},'data':_0x46e881});if(_0x4a7594['status']==='PAID'&&_0x1d47ab[_0x549ee6(0xdb)]){console[_0x549ee6(0xc7)](_0x549ee6(0x12e)+_0x1d47ab['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x549ee6(0xd9)](async _0x22f719=>{const _0x40f915=_0x549ee6,_0x12da49=await _0x22f719[_0x40f915(0x124)][_0x40f915(0x118)]({'where':{'id':_0x1d47ab[_0x40f915(0xdb)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x12da49){console[_0x40f915(0xc7)](_0x40f915(0x13a)+_0x12da49['id']+':\x20type='+_0x12da49[_0x40f915(0xe9)]+_0x40f915(0xe7)+_0x12da49[_0x40f915(0x12b)]+_0x40f915(0xea)+_0x12da49[_0x40f915(0xd6)]);const _0x648b77=_0x12da49[_0x40f915(0x12b)]+0x1,_0x38b9f8=_0x12da49[_0x40f915(0xe9)]==='SINGLE'?_0x40f915(0xff):_0x12da49['status'];await _0x22f719[_0x40f915(0x124)]['update']({'where':{'id':_0x1d47ab['paymentLinkId']},'data':{'currentPayments':_0x648b77,'status':_0x38b9f8,'updatedAt':new Date()}}),console[_0x40f915(0xc7)](_0x40f915(0xcc)+_0x12da49['id']+'\x20updated:\x20currentPayments='+_0x12da49[_0x40f915(0x12b)]+_0x40f915(0xe5)+_0x648b77+_0x40f915(0xea)+_0x12da49[_0x40f915(0xd6)]+_0x40f915(0xe5)+_0x38b9f8);}else console['log'](_0x40f915(0x129)+_0x1d47ab[_0x40f915(0xdb)]+'\x20not\x20found');});}catch(_0x22d263){console['error'](_0x549ee6(0x119),_0x22d263);}}await database_1[_0x549ee6(0x104)][_0x549ee6(0x12f)][_0x549ee6(0x106)]({'data':{'paymentId':_0x1d47ab['id'],'shopId':_0x1d47ab[_0x549ee6(0xf2)],'event':'test_gateway_'+_0x4a7594[_0x549ee6(0xd6)][_0x549ee6(0xe3)](),'statusCode':0xc8,'responseBody':JSON[_0x549ee6(0x122)]({'oldStatus':_0x549ee6(0x121),'newStatus':_0x4a7594[_0x549ee6(0xd6)],'transactionId':_0x4a7594[_0x549ee6(0x136)],'failureReason':_0x4a7594['failureReason'],'processedAt':new Date()[_0x549ee6(0xed)]()})}}),await this[_0x549ee6(0x138)](_0x1d47ab,_0x4a7594[_0x549ee6(0xd6)],_0x4a7594[_0x549ee6(0x136)],_0x4a7594['failureReason']),await this[_0x549ee6(0x127)](_0x1d47ab,_0x4a7594[_0x549ee6(0xd6)]),console['log'](_0x549ee6(0x10d)+_0x405157+_0x549ee6(0x11c)+_0x4a7594[_0x549ee6(0xd6)]),_0x4a7594[_0x549ee6(0xd6)]===_0x549ee6(0xcf)?_0x4bfcff[_0x549ee6(0xf9)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x549ee6(0xcf),'transactionId':_0x4a7594[_0x549ee6(0x136)],'redirectUrl':_0x1d47ab[_0x549ee6(0x10a)]}}):_0x4bfcff[_0x549ee6(0xd6)](0x190)[_0x549ee6(0xf9)]({'success':![],'message':_0x549ee6(0xd1),'result':{'status':_0x549ee6(0x123),'failureReason':_0x4a7594[_0x549ee6(0x11a)],'redirectUrl':_0x1d47ab[_0x549ee6(0xd2)]}});}catch(_0x4e2329){_0x55b109(_0x4e2329);}},this['testGatewayService']=new testGatewayService_1[(_0x62d887(0xe2))](),this[_0x62d887(0x108)]=new webhookService_1[(_0x62d887(0xfe))]();}async['sendShopWebhook'](_0x4f7ba8,_0x2b5451,_0x159d71,_0x134fff){const _0xbb7f7=a13_0x5ba4cc,_0x3e6775=Date['now']();try{const _0xb36ebb=_0x4f7ba8[_0xbb7f7(0x103)],_0x839b48=_0xb36ebb[_0xbb7f7(0xde)];if(!_0x839b48?.[_0xbb7f7(0xe4)]){console[_0xbb7f7(0xc7)](_0xbb7f7(0xf6)+_0xb36ebb['id']);return;}const _0x53fb1d=_0x2b5451===_0xbb7f7(0xcf)?_0xbb7f7(0xf3):'payment.failed';let _0x1a666a=[];if(_0x839b48[_0xbb7f7(0x105)])try{_0x1a666a=Array[_0xbb7f7(0xfb)](_0x839b48[_0xbb7f7(0x105)])?_0x839b48[_0xbb7f7(0x105)]:JSON[_0xbb7f7(0xc5)](_0x839b48[_0xbb7f7(0x105)]);}catch(_0x2165ea){console[_0xbb7f7(0xe6)](_0xbb7f7(0xdf),_0x2165ea),_0x1a666a=[];}if(!_0x1a666a[_0xbb7f7(0xda)](_0x53fb1d)){console['log']('Webhook\x20event\x20'+_0x53fb1d+'\x20not\x20enabled\x20for\x20shop\x20'+_0xb36ebb['id']);return;}const _0x44eb8e={'event':_0x53fb1d,'payment':{'id':_0x4f7ba8['id'],'order_id':_0x4f7ba8[_0xbb7f7(0xd5)],'gateway_order_id':_0x4f7ba8[_0xbb7f7(0xf8)],'gateway':_0xbb7f7(0xdc),'amount':_0x4f7ba8[_0xbb7f7(0x11d)],'currency':_0x4f7ba8['currency'],'status':_0x2b5451[_0xbb7f7(0xe3)](),'customer_email':_0x4f7ba8[_0xbb7f7(0xf7)],'customer_name':_0x4f7ba8[_0xbb7f7(0x10e)],'transaction_id':_0x159d71,'failure_message':_0x134fff,'created_at':_0x4f7ba8[_0xbb7f7(0xe8)],'updated_at':new Date()}},_0x233fd7=await fetch(_0x839b48[_0xbb7f7(0xe4)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0xbb7f7(0x133)},'body':JSON[_0xbb7f7(0x122)](_0x44eb8e)}),_0x32ed05=Date[_0xbb7f7(0xec)]()-_0x3e6775;console[_0xbb7f7(0xc7)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x839b48['webhookUrl']+'\x20with\x20status\x20'+_0x233fd7['status']+'\x20('+_0x32ed05+_0xbb7f7(0x139));}catch(_0xe83909){console[_0xbb7f7(0xe6)](_0xbb7f7(0xcd),_0xe83909);}}async[a13_0x5ba4cc(0x127)](_0x35449a,_0x577b5b){const _0xae117b=a13_0x5ba4cc;try{const {telegramBotService:_0x20ae71}=await Promise[_0xae117b(0x10f)]()[_0xae117b(0x11e)](()=>__importStar(require('../services/telegramBotService'))),_0x3d8dad={'PAID':_0xae117b(0x128),'FAILED':_0xae117b(0x12a)},_0x1de08f=_0x3d8dad[_0x577b5b];if(!_0x1de08f)return;await _0x20ae71['sendPaymentNotification'](_0x35449a[_0xae117b(0xf2)],_0x35449a,_0x1de08f);}catch(_0x1630b4){console[_0xae117b(0xe6)](_0xae117b(0xee),_0x1630b4);}}}exports[a13_0x5ba4cc(0x125)]=TestGatewayController;