'use strict';const a21_0x12bcfc=a21_0x34b4;(function(_0x3856cd,_0x51822f){const _0x1a4342=a21_0x34b4,_0x432fe7=_0x3856cd();while(!![]){try{const _0x13255d=-parseInt(_0x1a4342(0x14d))/0x1*(parseInt(_0x1a4342(0x185))/0x2)+parseInt(_0x1a4342(0x143))/0x3+parseInt(_0x1a4342(0x139))/0x4+-parseInt(_0x1a4342(0x173))/0x5+parseInt(_0x1a4342(0x170))/0x6*(parseInt(_0x1a4342(0x149))/0x7)+-parseInt(_0x1a4342(0x16f))/0x8*(-parseInt(_0x1a4342(0x163))/0x9)+-parseInt(_0x1a4342(0x175))/0xa;if(_0x13255d===_0x51822f)break;else _0x432fe7['push'](_0x432fe7['shift']());}catch(_0x37ce46){_0x432fe7['push'](_0x432fe7['shift']());}}}(a21_0x3eb0,0x79909));function a21_0x3eb0(){const _0x269df7=['TestGatewayService','getOwnPropertyNames','parse','test_card','1176244XmqlfL','sendShopWebhook','WebhookService','orderId','Payment\x20failed','shop','not\x20configured','‚úÖ\x20Test\x20Gateway\x20payment\x20','successUrl','webhookLog','2625858WJPJEy','sha256','type','Any\x203-4\x20digits','paymentLinkId','Payment\x20is\x20not\x20for\x20test\x20gateway','21FBXILO','status','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','configured','1rKpTdA','cardNumber','__importDefault','getPaymentForm','paidAt','create','PAID','‚úÖ\x20Payment\x20link\x20','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','\x20->\x20','__esModule','processCard','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:',',\x20status=','customerName','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','processCardPayment','update','defineProperty','findUnique','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','writable','36ZTsixg','default','webhookService','Payment\x20processed\x20successfully','gatewayOrderId','SINGLE','currentPayments','error','gatewayPaymentId','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','params','644168yMPfuS','1857198YlPRNf','paymentMethod','customerEmail','3858395fymMsS','‚ùå\x20Payment\x20link\x20','3419810AqiEHs','../config/database','../services/webhookService','ms)','TestGatewayController','stringify','payment.failed','includes','\x20processed:\x20','application/json','Any\x20name','secretKey','length','\x20with\x20status\x20','testGatewayService','Any\x20future\x20date\x20(MM/YY)','1616882QyXZIB','paymentLink','üìà\x20Found\x20payment\x20link\x20','log','currency','toLowerCase',':\x20type=','failed','üß™\x20Test\x20Gateway\x20result:','name','settings','hex',',\x20currentPayments=','isArray','Any\x20other\x20card\x20number','payment','__setModuleDefault','amount','body','json','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','failureReason','Payment\x20to\x20','configurable','now',',\x20cannot\x20process','crypto','cardLast4','Payment\x20status\x20is\x20','transactionId','üß™\x20Webhook\x20payload:','‚ö†Ô∏è\x20Webhook\x20event\x20','webhookEvents','hasOwnProperty','sendPaymentNotification','gateway','\x20updated:\x20currentPayments=','webhookUrl','‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20not\x20found','sendPaymentStatusNotification','paid','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','getOwnPropertyDescriptor','createHmac','4242\x204242\x204242\x204242','../services/telegramBotService','FAILED','Payment\x20not\x20found','...','shopId'];a21_0x3eb0=function(){return _0x269df7;};return a21_0x3eb0();}var __createBinding=this&&this['__createBinding']||(Object[a21_0x12bcfc(0x152)]?function(_0x1eb744,_0x5c6f4a,_0x108ae0,_0x4f99e3){const _0x9d27c6=a21_0x12bcfc;if(_0x4f99e3===undefined)_0x4f99e3=_0x108ae0;var _0x4495e8=Object[_0x9d27c6(0x1b0)](_0x5c6f4a,_0x108ae0);(!_0x4495e8||('get'in _0x4495e8?!_0x5c6f4a[_0x9d27c6(0x157)]:_0x4495e8[_0x9d27c6(0x162)]||_0x4495e8[_0x9d27c6(0x19c)]))&&(_0x4495e8={'enumerable':!![],'get':function(){return _0x5c6f4a[_0x108ae0];}}),Object[_0x9d27c6(0x15f)](_0x1eb744,_0x4f99e3,_0x4495e8);}:function(_0x1cf91b,_0xd6c0a7,_0x5e310a,_0x271f45){if(_0x271f45===undefined)_0x271f45=_0x5e310a;_0x1cf91b[_0x271f45]=_0xd6c0a7[_0x5e310a];}),__setModuleDefault=this&&this[a21_0x12bcfc(0x195)]||(Object[a21_0x12bcfc(0x152)]?function(_0x4277f2,_0x5a3c85){const _0x2bdd9a=a21_0x12bcfc;Object[_0x2bdd9a(0x15f)](_0x4277f2,_0x2bdd9a(0x164),{'enumerable':!![],'value':_0x5a3c85});}:function(_0x584407,_0x5af74d){_0x584407['default']=_0x5af74d;}),__importStar=this&&this['__importStar']||(function(){var _0x1ca9a3=function(_0x4e0e24){const _0x4fc64d=a21_0x34b4;return _0x1ca9a3=Object[_0x4fc64d(0x136)]||function(_0x3f2e73){const _0x1c0e9e=_0x4fc64d;var _0x5372e0=[];for(var _0x34f9a3 in _0x3f2e73)if(Object['prototype'][_0x1c0e9e(0x1a6)]['call'](_0x3f2e73,_0x34f9a3))_0x5372e0[_0x5372e0['length']]=_0x34f9a3;return _0x5372e0;},_0x1ca9a3(_0x4e0e24);};return function(_0x568b3b){const _0x5aabc1=a21_0x34b4;if(_0x568b3b&&_0x568b3b[_0x5aabc1(0x157)])return _0x568b3b;var _0x2d5806={};if(_0x568b3b!=null){for(var _0x423d39=_0x1ca9a3(_0x568b3b),_0x39a2f5=0x0;_0x39a2f5<_0x423d39[_0x5aabc1(0x181)];_0x39a2f5++)if(_0x423d39[_0x39a2f5]!==_0x5aabc1(0x164))__createBinding(_0x2d5806,_0x568b3b,_0x423d39[_0x39a2f5]);}return __setModuleDefault(_0x2d5806,_0x568b3b),_0x2d5806;};}()),__importDefault=this&&this[a21_0x12bcfc(0x14f)]||function(_0x18cf50){const _0x4e122b=a21_0x12bcfc;return _0x18cf50&&_0x18cf50[_0x4e122b(0x157)]?_0x18cf50:{'default':_0x18cf50};};Object['defineProperty'](exports,a21_0x12bcfc(0x157),{'value':!![]}),exports[a21_0x12bcfc(0x179)]=void 0x0;const crypto_1=__importDefault(require(a21_0x12bcfc(0x19f))),testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a21_0x12bcfc(0x177)),database_1=__importDefault(require(a21_0x12bcfc(0x176)));function a21_0x34b4(_0x3efdf8,_0x410282){_0x3efdf8=_0x3efdf8-0x130;const _0x3eb09b=a21_0x3eb0();let _0x34b44a=_0x3eb09b[_0x3efdf8];return _0x34b44a;}class TestGatewayController{constructor(){const _0x418060=a21_0x12bcfc;this[_0x418060(0x150)]=async(_0x21b95d,_0x66541b,_0x2035ad)=>{const _0x1753df=_0x418060;try{const {paymentId:_0x4b1ffd}=_0x21b95d['params'];console[_0x1753df(0x188)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4b1ffd);const _0x21d0fc=await database_1['default'][_0x1753df(0x194)]['findUnique']({'where':{'id':_0x4b1ffd},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x21d0fc)return _0x66541b['status'](0x194)[_0x1753df(0x198)]({'success':![],'message':_0x1753df(0x132)});if(_0x21d0fc[_0x1753df(0x1a8)]!=='test_gateway')return _0x66541b[_0x1753df(0x14a)](0x190)['json']({'success':![],'message':_0x1753df(0x148)});if(_0x21d0fc[_0x1753df(0x14a)]!=='PENDING')return _0x66541b[_0x1753df(0x14a)](0x190)[_0x1753df(0x198)]({'success':![],'message':_0x1753df(0x1a1)+_0x21d0fc[_0x1753df(0x14a)]+_0x1753df(0x19e)});_0x66541b[_0x1753df(0x198)]({'success':!![],'result':{'paymentId':_0x21d0fc['id'],'orderId':_0x21d0fc[_0x1753df(0x167)],'amount':_0x21d0fc['amount'],'currency':_0x21d0fc[_0x1753df(0x189)],'merchantName':_0x21d0fc[_0x1753df(0x13e)][_0x1753df(0x18e)],'description':_0x1753df(0x19b)+_0x21d0fc[_0x1753df(0x13e)][_0x1753df(0x18e)],'testInstructions':{'successCard':_0x1753df(0x1b2),'failureCard':_0x1753df(0x193),'expiryDate':_0x1753df(0x184),'cvc':_0x1753df(0x146),'holderName':_0x1753df(0x17f)}}});}catch(_0xff76bb){_0x2035ad(_0xff76bb);}},this[_0x418060(0x158)]=async(_0x2fbd4f,_0x152f08,_0x5bae90)=>{const _0x3fb7f9=_0x418060;try{const {paymentId:_0x1390f4}=_0x2fbd4f[_0x3fb7f9(0x16e)],_0x355eb7=_0x2fbd4f[_0x3fb7f9(0x197)];console[_0x3fb7f9(0x188)](_0x3fb7f9(0x14b)+_0x1390f4);const _0x45ac20=await database_1['default'][_0x3fb7f9(0x194)][_0x3fb7f9(0x160)]({'where':{'id':_0x1390f4},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x45ac20)return _0x152f08[_0x3fb7f9(0x14a)](0x194)[_0x3fb7f9(0x198)]({'success':![],'message':_0x3fb7f9(0x132)});if(_0x45ac20[_0x3fb7f9(0x1a8)]!=='test_gateway')return _0x152f08[_0x3fb7f9(0x14a)](0x190)[_0x3fb7f9(0x198)]({'success':![],'message':_0x3fb7f9(0x148)});if(_0x45ac20[_0x3fb7f9(0x14a)]!=='PENDING')return _0x152f08[_0x3fb7f9(0x14a)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x45ac20[_0x3fb7f9(0x14a)]+_0x3fb7f9(0x19e)});const _0x281df4=await this[_0x3fb7f9(0x183)][_0x3fb7f9(0x15d)]({'paymentId':_0x45ac20['id'],'orderId':_0x45ac20[_0x3fb7f9(0x167)]||_0x45ac20['id'],'amount':_0x45ac20[_0x3fb7f9(0x196)],'currency':_0x45ac20[_0x3fb7f9(0x189)],'cardData':_0x355eb7});console[_0x3fb7f9(0x188)](_0x3fb7f9(0x18d),_0x281df4);const _0x35f18d={'status':_0x281df4[_0x3fb7f9(0x14a)],'updatedAt':new Date()};if(_0x281df4[_0x3fb7f9(0x14a)]===_0x3fb7f9(0x153))_0x35f18d[_0x3fb7f9(0x151)]=new Date(),_0x35f18d[_0x3fb7f9(0x16b)]=_0x281df4[_0x3fb7f9(0x1a2)];else _0x281df4[_0x3fb7f9(0x14a)]===_0x3fb7f9(0x131)&&(_0x35f18d['failureMessage']=_0x281df4[_0x3fb7f9(0x19a)]);const _0x26426e=_0x355eb7[_0x3fb7f9(0x14e)]['replace'](/[\s-]/g,'');_0x35f18d[_0x3fb7f9(0x1a0)]=_0x26426e['slice'](-0x4),_0x35f18d[_0x3fb7f9(0x171)]=_0x3fb7f9(0x138),await database_1[_0x3fb7f9(0x164)]['payment'][_0x3fb7f9(0x15e)]({'where':{'id':_0x45ac20['id']},'data':_0x35f18d});if(_0x281df4[_0x3fb7f9(0x14a)]==='PAID'&&_0x45ac20['paymentLinkId']){console['log']('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x45ac20['id']+_0x3fb7f9(0x15c));try{await database_1[_0x3fb7f9(0x164)]['$transaction'](async _0x38421d=>{const _0x1f5099=_0x3fb7f9,_0x2cbdef=await _0x38421d[_0x1f5099(0x186)]['findUnique']({'where':{'id':_0x45ac20['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2cbdef){console[_0x1f5099(0x188)](_0x1f5099(0x187)+_0x2cbdef['id']+_0x1f5099(0x18b)+_0x2cbdef[_0x1f5099(0x145)]+_0x1f5099(0x191)+_0x2cbdef['currentPayments']+',\x20status='+_0x2cbdef['status']);const _0x564d33=_0x2cbdef[_0x1f5099(0x169)]+0x1,_0x520055=_0x2cbdef[_0x1f5099(0x145)]===_0x1f5099(0x168)?'COMPLETED':_0x2cbdef[_0x1f5099(0x14a)];await _0x38421d[_0x1f5099(0x186)]['update']({'where':{'id':_0x45ac20[_0x1f5099(0x147)]},'data':{'currentPayments':_0x564d33,'status':_0x520055,'updatedAt':new Date()}}),console[_0x1f5099(0x188)](_0x1f5099(0x154)+_0x2cbdef['id']+_0x1f5099(0x1a9)+_0x2cbdef['currentPayments']+_0x1f5099(0x156)+_0x564d33+_0x1f5099(0x15a)+_0x2cbdef[_0x1f5099(0x14a)]+_0x1f5099(0x156)+_0x520055);}else console['log'](_0x1f5099(0x174)+_0x45ac20[_0x1f5099(0x147)]+_0x1f5099(0x1ac));});}catch(_0x435cff){console[_0x3fb7f9(0x16a)](_0x3fb7f9(0x161),_0x435cff);}}await database_1[_0x3fb7f9(0x164)][_0x3fb7f9(0x142)]['create']({'data':{'paymentId':_0x45ac20['id'],'shopId':_0x45ac20[_0x3fb7f9(0x134)],'event':'test_gateway_'+_0x281df4[_0x3fb7f9(0x14a)][_0x3fb7f9(0x18a)](),'statusCode':_0x281df4[_0x3fb7f9(0x14a)]===_0x3fb7f9(0x153)?0xc8:0x190,'responseBody':JSON[_0x3fb7f9(0x17a)]({'oldStatus':'PENDING','newStatus':_0x281df4['status'],'transactionId':_0x281df4[_0x3fb7f9(0x1a2)],'failureReason':_0x281df4[_0x3fb7f9(0x19a)],'processedAt':new Date()['toISOString']()})}}),console[_0x3fb7f9(0x188)](_0x3fb7f9(0x199)+_0x281df4[_0x3fb7f9(0x14a)]+_0x3fb7f9(0x133)),await this[_0x3fb7f9(0x13a)](_0x45ac20,_0x281df4['status'],_0x281df4[_0x3fb7f9(0x1a2)],_0x281df4[_0x3fb7f9(0x19a)]),console[_0x3fb7f9(0x188)](_0x3fb7f9(0x16c)+_0x281df4[_0x3fb7f9(0x14a)]),console[_0x3fb7f9(0x188)](_0x3fb7f9(0x16d)+_0x281df4[_0x3fb7f9(0x14a)]+_0x3fb7f9(0x133)),await this[_0x3fb7f9(0x1ad)](_0x45ac20,_0x281df4['status']),console[_0x3fb7f9(0x188)](_0x3fb7f9(0x155)+_0x281df4['status']),console[_0x3fb7f9(0x188)](_0x3fb7f9(0x140)+_0x1390f4+_0x3fb7f9(0x17d)+_0x281df4[_0x3fb7f9(0x14a)]),_0x281df4[_0x3fb7f9(0x14a)]==='PAID'?_0x152f08['json']({'success':!![],'message':_0x3fb7f9(0x166),'result':{'status':_0x3fb7f9(0x153),'transactionId':_0x281df4[_0x3fb7f9(0x1a2)],'redirectUrl':_0x45ac20[_0x3fb7f9(0x141)]}}):_0x152f08['status'](0x190)['json']({'success':![],'message':_0x3fb7f9(0x13d),'result':{'status':_0x3fb7f9(0x131),'failureReason':_0x281df4[_0x3fb7f9(0x19a)],'redirectUrl':_0x45ac20['failUrl']}});}catch(_0x26a45e){_0x5bae90(_0x26a45e);}},this[_0x418060(0x183)]=new testGatewayService_1[(_0x418060(0x135))](),this[_0x418060(0x165)]=new webhookService_1[(_0x418060(0x13b))]();}async['sendShopWebhook'](_0xc14d47,_0x160b71,_0x3ae583,_0x26b439){const _0x507b18=a21_0x12bcfc,_0x347802=Date[_0x507b18(0x19d)]();try{const _0x237822=_0xc14d47[_0x507b18(0x13e)],_0x4e3dbf=_0x237822[_0x507b18(0x18f)];if(!_0x4e3dbf?.[_0x507b18(0x1aa)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x237822['id']);return;}const _0x237253=_0x160b71===_0x507b18(0x153)?'payment.success':_0x507b18(0x17b);console[_0x507b18(0x188)]('üß™\x20Test\x20Gateway\x20webhook:\x20event='+_0x237253+',\x20webhookUrl='+(_0x4e3dbf[_0x507b18(0x1aa)]?_0x507b18(0x14c):_0x507b18(0x13f)));let _0x4f1232=[];if(_0x4e3dbf[_0x507b18(0x1a5)])try{_0x4f1232=Array[_0x507b18(0x192)](_0x4e3dbf[_0x507b18(0x1a5)])?_0x4e3dbf[_0x507b18(0x1a5)]:JSON[_0x507b18(0x137)](_0x4e3dbf[_0x507b18(0x1a5)]);}catch(_0xf81ae2){console[_0x507b18(0x16a)]('Error\x20parsing\x20webhook\x20events:',_0xf81ae2),_0x4f1232=[];}console[_0x507b18(0x188)](_0x507b18(0x159),_0x4f1232);if(!_0x4f1232[_0x507b18(0x17c)](_0x237253)){console[_0x507b18(0x188)](_0x507b18(0x1a4)+_0x237253+'\x20not\x20enabled\x20for\x20shop\x20'+_0x237822['id']);return;}const _0x33a1a5={'event':_0x237253,'payment':{'id':_0xc14d47['id'],'order_id':_0xc14d47[_0x507b18(0x13c)],'gateway_order_id':_0xc14d47[_0x507b18(0x167)],'gateway':'0000','amount':_0xc14d47[_0x507b18(0x196)],'currency':_0xc14d47[_0x507b18(0x189)],'status':_0x160b71['toLowerCase'](),'customer_email':_0xc14d47[_0x507b18(0x172)],'customer_name':_0xc14d47[_0x507b18(0x15b)],'transaction_id':_0x3ae583,'failure_message':_0x26b439,'created_at':_0xc14d47['createdAt'],'updated_at':new Date()}};console[_0x507b18(0x188)]('üß™\x20Sending\x20webhook\x20to\x20'+_0x4e3dbf[_0x507b18(0x1aa)]+'...'),console[_0x507b18(0x188)](_0x507b18(0x1a3),JSON['stringify'](_0x33a1a5,null,0x2));const _0x63aee5=JSON[_0x507b18(0x17a)](_0x33a1a5),_0x4cc941=crypto_1[_0x507b18(0x164)][_0x507b18(0x1b1)](_0x507b18(0x144),_0x237822[_0x507b18(0x180)])[_0x507b18(0x15e)](_0x63aee5)['digest'](_0x507b18(0x190)),_0x1d4cb0=await fetch(_0x4e3dbf[_0x507b18(0x1aa)],{'method':'POST','headers':{'Content-Type':_0x507b18(0x17e),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)','X-Webhook-Signature':_0x4cc941},'body':_0x63aee5}),_0x153322=Date[_0x507b18(0x19d)]()-_0x347802;console['log'](_0x507b18(0x1ab)+_0x4e3dbf[_0x507b18(0x1aa)]+_0x507b18(0x182)+_0x1d4cb0[_0x507b18(0x14a)]+'\x20('+_0x153322+_0x507b18(0x178));}catch(_0x456cdb){console[_0x507b18(0x16a)](_0x507b18(0x1af),_0x456cdb);}}async['sendPaymentStatusNotification'](_0x5693a6,_0x5de6d9){const _0x4d30d2=a21_0x12bcfc;try{const {telegramBotService:_0x528cec}=await Promise['resolve']()['then'](()=>__importStar(require(_0x4d30d2(0x130)))),_0x112846={'PAID':_0x4d30d2(0x1ae),'FAILED':_0x4d30d2(0x18c)},_0x1c30bf=_0x112846[_0x5de6d9];if(!_0x1c30bf)return;await _0x528cec[_0x4d30d2(0x1a7)](_0x5693a6[_0x4d30d2(0x134)],_0x5693a6,_0x1c30bf);}catch(_0x257cdc){console[_0x4d30d2(0x16a)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x257cdc);}}}exports['TestGatewayController']=TestGatewayController;