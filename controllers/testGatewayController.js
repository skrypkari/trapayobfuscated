'use strict';const a14_0x264290=a14_0x27c2;(function(_0x2dffac,_0x13da6a){const _0x5ee554=a14_0x27c2,_0x5540b4=_0x2dffac();while(!![]){try{const _0x4d079f=parseInt(_0x5ee554(0x1f1))/0x1*(-parseInt(_0x5ee554(0x1e0))/0x2)+parseInt(_0x5ee554(0x1ce))/0x3*(-parseInt(_0x5ee554(0x21e))/0x4)+-parseInt(_0x5ee554(0x238))/0x5+-parseInt(_0x5ee554(0x22e))/0x6+-parseInt(_0x5ee554(0x21d))/0x7+-parseInt(_0x5ee554(0x22a))/0x8*(-parseInt(_0x5ee554(0x1e2))/0x9)+parseInt(_0x5ee554(0x1f3))/0xa*(parseInt(_0x5ee554(0x21b))/0xb);if(_0x4d079f===_0x13da6a)break;else _0x5540b4['push'](_0x5540b4['shift']());}catch(_0x4179bb){_0x5540b4['push'](_0x5540b4['shift']());}}}(a14_0x16cd,0x6ea50));var __createBinding=this&&this['__createBinding']||(Object[a14_0x264290(0x22d)]?function(_0x341f83,_0x7a25a7,_0x319135,_0x392754){const _0x539039=a14_0x264290;if(_0x392754===undefined)_0x392754=_0x319135;var _0x201d86=Object[_0x539039(0x206)](_0x7a25a7,_0x319135);(!_0x201d86||(_0x539039(0x1cd)in _0x201d86?!_0x7a25a7[_0x539039(0x229)]:_0x201d86['writable']||_0x201d86['configurable']))&&(_0x201d86={'enumerable':!![],'get':function(){return _0x7a25a7[_0x319135];}}),Object[_0x539039(0x1e3)](_0x341f83,_0x392754,_0x201d86);}:function(_0x5ef2f0,_0x2c685f,_0x1990bf,_0x5084b5){if(_0x5084b5===undefined)_0x5084b5=_0x1990bf;_0x5ef2f0[_0x5084b5]=_0x2c685f[_0x1990bf];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a14_0x264290(0x22d)]?function(_0x458ce2,_0x2e6eab){Object['defineProperty'](_0x458ce2,'default',{'enumerable':!![],'value':_0x2e6eab});}:function(_0x101d2b,_0x54ac74){const _0x57aa3b=a14_0x264290;_0x101d2b[_0x57aa3b(0x22f)]=_0x54ac74;}),__importStar=this&&this[a14_0x264290(0x1ec)]||(function(){var _0x4c580c=function(_0x1cd22e){return _0x4c580c=Object['getOwnPropertyNames']||function(_0x2772f3){const _0x53ffd5=a14_0x27c2;var _0x3c8c44=[];for(var _0x3c6b23 in _0x2772f3)if(Object[_0x53ffd5(0x226)][_0x53ffd5(0x233)]['call'](_0x2772f3,_0x3c6b23))_0x3c8c44[_0x3c8c44[_0x53ffd5(0x1fb)]]=_0x3c6b23;return _0x3c8c44;},_0x4c580c(_0x1cd22e);};return function(_0x1630ea){const _0x2f3058=a14_0x27c2;if(_0x1630ea&&_0x1630ea['__esModule'])return _0x1630ea;var _0x587fb5={};if(_0x1630ea!=null){for(var _0x400bc0=_0x4c580c(_0x1630ea),_0x1c688c=0x0;_0x1c688c<_0x400bc0[_0x2f3058(0x1fb)];_0x1c688c++)if(_0x400bc0[_0x1c688c]!==_0x2f3058(0x22f))__createBinding(_0x587fb5,_0x1630ea,_0x400bc0[_0x1c688c]);}return __setModuleDefault(_0x587fb5,_0x1630ea),_0x587fb5;};}()),__importDefault=this&&this[a14_0x264290(0x1e9)]||function(_0x15cfc6){return _0x15cfc6&&_0x15cfc6['__esModule']?_0x15cfc6:{'default':_0x15cfc6};};Object[a14_0x264290(0x1e3)](exports,'__esModule',{'value':!![]}),exports[a14_0x264290(0x221)]=void 0x0;const testGatewayService_1=require(a14_0x264290(0x1dd)),webhookService_1=require(a14_0x264290(0x239)),database_1=__importDefault(require(a14_0x264290(0x23c)));class TestGatewayController{constructor(){const _0x445dc6=a14_0x264290;this[_0x445dc6(0x228)]=async(_0x3c1c72,_0x3b40ee,_0x35dc08)=>{const _0x1ca523=_0x445dc6;try{const {paymentId:_0x5f3155}=_0x3c1c72[_0x1ca523(0x217)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5f3155);const _0xa2731e=await database_1['default'][_0x1ca523(0x1d1)]['findUnique']({'where':{'id':_0x5f3155},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xa2731e)return _0x3b40ee[_0x1ca523(0x1d7)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0xa2731e[_0x1ca523(0x222)]!==_0x1ca523(0x1d0))return _0x3b40ee[_0x1ca523(0x1d7)](0x190)[_0x1ca523(0x209)]({'success':![],'message':_0x1ca523(0x204)});if(_0xa2731e[_0x1ca523(0x1d7)]!=='PENDING')return _0x3b40ee['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0xa2731e[_0x1ca523(0x1d7)]+_0x1ca523(0x1d2)});_0x3b40ee['json']({'success':!![],'result':{'paymentId':_0xa2731e['id'],'orderId':_0xa2731e[_0x1ca523(0x1d9)],'amount':_0xa2731e[_0x1ca523(0x1ef)],'currency':_0xa2731e['currency'],'merchantName':_0xa2731e[_0x1ca523(0x1fd)]['name'],'description':_0x1ca523(0x1d4)+_0xa2731e['shop'][_0x1ca523(0x1f9)],'testInstructions':{'successCard':_0x1ca523(0x1ea),'failureCard':_0x1ca523(0x234),'expiryDate':_0x1ca523(0x1e5),'cvc':_0x1ca523(0x208),'holderName':_0x1ca523(0x1de)}}});}catch(_0x27053f){_0x35dc08(_0x27053f);}},this[_0x445dc6(0x20d)]=async(_0x230bfd,_0xea8863,_0x3d3a84)=>{const _0xaaf283=_0x445dc6;try{const {paymentId:_0x299749}=_0x230bfd['params'],_0x9ea9bf=_0x230bfd[_0xaaf283(0x20e)];console[_0xaaf283(0x1c7)](_0xaaf283(0x210)+_0x299749);const _0x2a9ad4=await database_1['default'][_0xaaf283(0x1d1)][_0xaaf283(0x220)]({'where':{'id':_0x299749},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a9ad4)return _0xea8863[_0xaaf283(0x1d7)](0x194)['json']({'success':![],'message':_0xaaf283(0x1e6)});if(_0x2a9ad4[_0xaaf283(0x222)]!==_0xaaf283(0x1d0))return _0xea8863[_0xaaf283(0x1d7)](0x190)[_0xaaf283(0x209)]({'success':![],'message':_0xaaf283(0x204)});if(_0x2a9ad4[_0xaaf283(0x1d7)]!==_0xaaf283(0x1f0))return _0xea8863[_0xaaf283(0x1d7)](0x190)[_0xaaf283(0x209)]({'success':![],'message':_0xaaf283(0x235)+_0x2a9ad4[_0xaaf283(0x1d7)]+',\x20cannot\x20process'});const _0x5a7e3f=await this[_0xaaf283(0x1c8)][_0xaaf283(0x219)]({'paymentId':_0x2a9ad4['id'],'orderId':_0x2a9ad4[_0xaaf283(0x1d9)]||_0x2a9ad4['id'],'amount':_0x2a9ad4[_0xaaf283(0x1ef)],'currency':_0x2a9ad4[_0xaaf283(0x1dc)],'cardData':_0x9ea9bf});console[_0xaaf283(0x1c7)](_0xaaf283(0x237),_0x5a7e3f);const _0x38327d={'status':_0x5a7e3f[_0xaaf283(0x1d7)],'updatedAt':new Date()};if(_0x5a7e3f[_0xaaf283(0x1d7)]===_0xaaf283(0x21c))_0x38327d['paidAt']=new Date(),_0x38327d[_0xaaf283(0x1d8)]=_0x5a7e3f[_0xaaf283(0x1d3)];else _0x5a7e3f[_0xaaf283(0x1d7)]===_0xaaf283(0x207)&&(_0x38327d[_0xaaf283(0x21a)]=_0x5a7e3f[_0xaaf283(0x20c)]);const _0x5bfda8=_0x9ea9bf['cardNumber'][_0xaaf283(0x1f8)](/[\s-]/g,'');_0x38327d[_0xaaf283(0x203)]=_0x5bfda8['slice'](-0x4),_0x38327d[_0xaaf283(0x1ed)]=_0xaaf283(0x236),await database_1[_0xaaf283(0x22f)][_0xaaf283(0x1d1)][_0xaaf283(0x1f7)]({'where':{'id':_0x2a9ad4['id']},'data':_0x38327d});if(_0x5a7e3f[_0xaaf283(0x1d7)]===_0xaaf283(0x21c)&&_0x2a9ad4['paymentLinkId']){console[_0xaaf283(0x1c7)](_0xaaf283(0x20f)+_0x2a9ad4['id']+_0xaaf283(0x1da));try{await database_1[_0xaaf283(0x22f)][_0xaaf283(0x22c)](async _0x3372de=>{const _0x39758e=_0xaaf283,_0x4ad9ce=await _0x3372de['paymentLink']['findUnique']({'where':{'id':_0x2a9ad4[_0x39758e(0x1cf)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4ad9ce){console[_0x39758e(0x1c7)]('üìà\x20Found\x20payment\x20link\x20'+_0x4ad9ce['id']+_0x39758e(0x216)+_0x4ad9ce[_0x39758e(0x201)]+_0x39758e(0x1ca)+_0x4ad9ce['currentPayments']+_0x39758e(0x1f6)+_0x4ad9ce[_0x39758e(0x1d7)]);const _0x4939fb=_0x4ad9ce[_0x39758e(0x227)]+0x1,_0x197e95=_0x4ad9ce['type']===_0x39758e(0x202)?_0x39758e(0x1db):_0x4ad9ce['status'];await _0x3372de[_0x39758e(0x223)]['update']({'where':{'id':_0x2a9ad4['paymentLinkId']},'data':{'currentPayments':_0x4939fb,'status':_0x197e95,'updatedAt':new Date()}}),console[_0x39758e(0x1c7)](_0x39758e(0x1e1)+_0x4ad9ce['id']+_0x39758e(0x1f4)+_0x4ad9ce['currentPayments']+'\x20->\x20'+_0x4939fb+_0x39758e(0x1f6)+_0x4ad9ce[_0x39758e(0x1d7)]+_0x39758e(0x1fe)+_0x197e95);}else console[_0x39758e(0x1c7)](_0x39758e(0x1cb)+_0x2a9ad4[_0x39758e(0x1cf)]+'\x20not\x20found');});}catch(_0x3140e6){console[_0xaaf283(0x1e8)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x3140e6);}}await database_1[_0xaaf283(0x22f)]['webhookLog']['create']({'data':{'paymentId':_0x2a9ad4['id'],'shopId':_0x2a9ad4['shopId'],'event':_0xaaf283(0x1fa)+_0x5a7e3f[_0xaaf283(0x1d7)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xaaf283(0x23e)]({'oldStatus':_0xaaf283(0x1f0),'newStatus':_0x5a7e3f[_0xaaf283(0x1d7)],'transactionId':_0x5a7e3f[_0xaaf283(0x1d3)],'failureReason':_0x5a7e3f['failureReason'],'processedAt':new Date()[_0xaaf283(0x1e4)]()})}}),await this[_0xaaf283(0x225)](_0x2a9ad4,_0x5a7e3f[_0xaaf283(0x1d7)],_0x5a7e3f['transactionId'],_0x5a7e3f['failureReason']),await this[_0xaaf283(0x20a)](_0x2a9ad4,_0x5a7e3f['status']),console['log'](_0xaaf283(0x1f5)+_0x299749+_0xaaf283(0x232)+_0x5a7e3f['status']),_0x5a7e3f[_0xaaf283(0x1d7)]===_0xaaf283(0x21c)?_0xea8863[_0xaaf283(0x209)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0xaaf283(0x21c),'transactionId':_0x5a7e3f[_0xaaf283(0x1d3)],'redirectUrl':_0x2a9ad4[_0xaaf283(0x1d6)]}}):_0xea8863[_0xaaf283(0x1d7)](0x190)[_0xaaf283(0x209)]({'success':![],'message':_0xaaf283(0x21f),'result':{'status':_0xaaf283(0x207),'failureReason':_0x5a7e3f['failureReason'],'redirectUrl':_0x2a9ad4[_0xaaf283(0x1cc)]}});}catch(_0x17ecc3){_0x3d3a84(_0x17ecc3);}},this[_0x445dc6(0x1c8)]=new testGatewayService_1['TestGatewayService'](),this[_0x445dc6(0x213)]=new webhookService_1[(_0x445dc6(0x1f2))]();}async[a14_0x264290(0x225)](_0x4ba832,_0x372517,_0x1ee658,_0x477122){const _0x41b4e7=a14_0x264290,_0x59de4a=Date[_0x41b4e7(0x23a)]();try{const _0x1965b6=_0x4ba832[_0x41b4e7(0x1fd)],_0x10e1d8=_0x1965b6[_0x41b4e7(0x215)];if(!_0x10e1d8?.[_0x41b4e7(0x224)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1965b6['id']);return;}const _0x30ceea=_0x372517===_0x41b4e7(0x21c)?_0x41b4e7(0x20b):'payment.failed';let _0x5f2ac6=[];if(_0x10e1d8[_0x41b4e7(0x205)])try{_0x5f2ac6=Array[_0x41b4e7(0x231)](_0x10e1d8[_0x41b4e7(0x205)])?_0x10e1d8['webhookEvents']:JSON[_0x41b4e7(0x1e7)](_0x10e1d8[_0x41b4e7(0x205)]);}catch(_0x9503eb){console['error'](_0x41b4e7(0x211),_0x9503eb),_0x5f2ac6=[];}if(!_0x5f2ac6[_0x41b4e7(0x23d)](_0x30ceea)){console[_0x41b4e7(0x1c7)](_0x41b4e7(0x212)+_0x30ceea+_0x41b4e7(0x1ee)+_0x1965b6['id']);return;}const _0x64d2fc={'event':_0x30ceea,'payment':{'id':_0x4ba832['id'],'order_id':_0x4ba832['orderId'],'gateway_order_id':_0x4ba832[_0x41b4e7(0x1d9)],'gateway':'0000','amount':_0x4ba832[_0x41b4e7(0x1ef)],'currency':_0x4ba832[_0x41b4e7(0x1dc)],'status':_0x372517[_0x41b4e7(0x218)](),'customer_email':_0x4ba832[_0x41b4e7(0x1ff)],'customer_name':_0x4ba832[_0x41b4e7(0x214)],'transaction_id':_0x1ee658,'failure_message':_0x477122,'created_at':_0x4ba832[_0x41b4e7(0x23b)],'updated_at':new Date()}},_0x54b9e4=await fetch(_0x10e1d8[_0x41b4e7(0x224)],{'method':_0x41b4e7(0x1df),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x64d2fc)}),_0x378757=Date[_0x41b4e7(0x23a)]()-_0x59de4a;console[_0x41b4e7(0x1c7)](_0x41b4e7(0x1d5)+_0x10e1d8[_0x41b4e7(0x224)]+'\x20with\x20status\x20'+_0x54b9e4[_0x41b4e7(0x1d7)]+'\x20('+_0x378757+'ms)');}catch(_0x4cda30){console[_0x41b4e7(0x1e8)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x4cda30);}}async[a14_0x264290(0x20a)](_0xa5f6d1,_0x114032){const _0x28adf9=a14_0x264290;try{const {telegramBotService:_0x5bc266}=await Promise[_0x28adf9(0x22b)]()[_0x28adf9(0x200)](()=>__importStar(require('../services/telegramBotService'))),_0x21ae37={'PAID':_0x28adf9(0x1c9),'FAILED':_0x28adf9(0x1eb)},_0x1ec17d=_0x21ae37[_0x114032];if(!_0x1ec17d)return;await _0x5bc266[_0x28adf9(0x1fc)](_0xa5f6d1[_0x28adf9(0x230)],_0xa5f6d1,_0x1ec17d);}catch(_0x327aa2){console[_0x28adf9(0x1e8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x327aa2);}}}function a14_0x27c2(_0x3a7f19,_0x44e586){const _0x16cd0e=a14_0x16cd();return a14_0x27c2=function(_0x27c23a,_0x37bedb){_0x27c23a=_0x27c23a-0x1c7;let _0x4fd54b=_0x16cd0e[_0x27c23a];return _0x4fd54b;},a14_0x27c2(_0x3a7f19,_0x44e586);}exports[a14_0x264290(0x221)]=TestGatewayController;function a14_0x16cd(){const _0xc645fe=['failureReason','processCard','body','üìà\x20Test\x20Gateway:\x20Payment\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Error\x20parsing\x20webhook\x20events:','Webhook\x20event\x20','webhookService','customerName','settings',':\x20type=','params','toLowerCase','processCardPayment','failureMessage','11pYvuYc','PAID','1347710XFoMKP','1108948KwWGJS','Payment\x20failed','findUnique','TestGatewayController','gateway','paymentLink','webhookUrl','sendShopWebhook','prototype','currentPayments','getPaymentForm','__esModule','256YzGhjU','resolve','$transaction','create','4002408ktvfeG','default','shopId','isArray','\x20processed:\x20','hasOwnProperty','Any\x20other\x20card\x20number','Payment\x20status\x20is\x20','test_card','üß™\x20Test\x20Gateway\x20result:','4448515VrqCUs','../services/webhookService','now','createdAt','../config/database','includes','stringify','log','testGatewayService','paid',',\x20currentPayments=','‚ùå\x20Payment\x20link\x20','failUrl','get','3KOEmdh','paymentLinkId','test_gateway','payment',',\x20cannot\x20process','transactionId','Payment\x20to\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','successUrl','status','gatewayPaymentId','gatewayOrderId','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','COMPLETED','currency','../services/gateways/testGatewayService','Any\x20name','POST','1727762FnCkwu','‚úÖ\x20Payment\x20link\x20','183537uPDSjD','defineProperty','toISOString','Any\x20future\x20date\x20(MM/YY)','Payment\x20not\x20found','parse','error','__importDefault','4242\x204242\x204242\x204242','failed','__importStar','paymentMethod','\x20not\x20enabled\x20for\x20shop\x20','amount','PENDING','1zhSUIr','WebhookService','26910430CrPDcY','\x20updated:\x20currentPayments=','‚úÖ\x20Test\x20Gateway\x20payment\x20',',\x20status=','update','replace','name','test_gateway_','length','sendPaymentNotification','shop','\x20->\x20','customerEmail','then','type','SINGLE','cardLast4','Payment\x20is\x20not\x20for\x20test\x20gateway','webhookEvents','getOwnPropertyDescriptor','FAILED','Any\x203-4\x20digits','json','sendPaymentStatusNotification','payment.success'];a14_0x16cd=function(){return _0xc645fe;};return a14_0x16cd();}