'use strict';const a18_0x59b48a=a18_0x6b40;(function(_0x1bbf9c,_0x17ef35){const _0x39a2f5=a18_0x6b40,_0x28aba5=_0x1bbf9c();while(!![]){try{const _0x1e0722=parseInt(_0x39a2f5(0x19e))/0x1+parseInt(_0x39a2f5(0x194))/0x2+-parseInt(_0x39a2f5(0x178))/0x3+parseInt(_0x39a2f5(0x1e3))/0x4+-parseInt(_0x39a2f5(0x1bd))/0x5*(-parseInt(_0x39a2f5(0x1d0))/0x6)+parseInt(_0x39a2f5(0x1a0))/0x7*(parseInt(_0x39a2f5(0x1c6))/0x8)+-parseInt(_0x39a2f5(0x1de))/0x9;if(_0x1e0722===_0x17ef35)break;else _0x28aba5['push'](_0x28aba5['shift']());}catch(_0x3e89dd){_0x28aba5['push'](_0x28aba5['shift']());}}}(a18_0x4f2f,0x91538));function a18_0x6b40(_0x4e6fcb,_0x2768e2){_0x4e6fcb=_0x4e6fcb-0x170;const _0x4f2f64=a18_0x4f2f();let _0x6b40f6=_0x4f2f64[_0x4e6fcb];return _0x6b40f6;}function a18_0x4f2f(){const _0x9c524b=['COMPLETED','application/json','settings','webhookUrl','sendPaymentStatusNotification','now','$transaction','TestGatewayController','0000','Any\x203-4\x20digits','status','Payment\x20System/1.0\x20(Test\x20Gateway)','testGatewayService','then','name','body','PENDING','Any\x20name','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','configurable','paymentLink','\x20not\x20found','update','__esModule','getOwnPropertyNames','527895HbDgrU','failed','hasOwnProperty','resolve','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayOrderId','log','slice','../services/webhookService','71096qSSvGY','payment.failed','prototype','length','includes','shop','amount','call',',\x20cannot\x20process','parse','66gygdBx','sendShopWebhook','test_gateway','sendPaymentNotification','__setModuleDefault','cardLast4','Any\x20other\x20card\x20number','paid','currentPayments',',\x20currentPayments=','default','TestGatewayService','shopId','params','16786845BpKcqH','\x20->\x20','‚úÖ\x20Payment\x20link\x20','Error\x20parsing\x20webhook\x20events:','failureReason','4430196rwyDCf','cardNumber','customerName','type','payment','paidAt',',\x20status=','findUnique','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','gateway','1781043HSkXKm','Payment\x20failed','isArray','transactionId','Payment\x20status\x20is\x20','getPaymentForm','POST','PAID','Payment\x20processed\x20successfully','webhookEvents','Webhook\x20event\x20','defineProperty','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookService','paymentMethod','__importDefault','__createBinding','successUrl','toLowerCase','ms)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failureMessage','__importStar','Payment\x20to\x20','payment.success','error','üìà\x20Test\x20Gateway:\x20Payment\x20','../services/telegramBotService','780914qHzAkZ','\x20with\x20status\x20','\x20processed:\x20','test_gateway_','currency','paymentLinkId','toISOString','json','FAILED','webhookLog','145931Mhzxdd','üìà\x20Found\x20payment\x20link\x20','196VlzqQj','Payment\x20is\x20not\x20for\x20test\x20gateway','Payment\x20not\x20found','stringify'];a18_0x4f2f=function(){return _0x9c524b;};return a18_0x4f2f();}var __createBinding=this&&this[a18_0x59b48a(0x188)]||(Object['create']?function(_0x5af41f,_0x4397d5,_0x2ac87b,_0x29c8e5){const _0x15ee7d=a18_0x59b48a;if(_0x29c8e5===undefined)_0x29c8e5=_0x2ac87b;var _0x5c0f59=Object['getOwnPropertyDescriptor'](_0x4397d5,_0x2ac87b);(!_0x5c0f59||('get'in _0x5c0f59?!_0x4397d5[_0x15ee7d(0x1bb)]:_0x5c0f59['writable']||_0x5c0f59[_0x15ee7d(0x1b7)]))&&(_0x5c0f59={'enumerable':!![],'get':function(){return _0x4397d5[_0x2ac87b];}}),Object[_0x15ee7d(0x183)](_0x5af41f,_0x29c8e5,_0x5c0f59);}:function(_0x518b1f,_0x131efb,_0x202ca0,_0x392f10){if(_0x392f10===undefined)_0x392f10=_0x202ca0;_0x518b1f[_0x392f10]=_0x131efb[_0x202ca0];}),__setModuleDefault=this&&this[a18_0x59b48a(0x1d4)]||(Object['create']?function(_0x3c6bca,_0x146a1e){const _0x1ee655=a18_0x59b48a;Object[_0x1ee655(0x183)](_0x3c6bca,'default',{'enumerable':!![],'value':_0x146a1e});}:function(_0x9b621a,_0x305030){const _0x6231ca=a18_0x59b48a;_0x9b621a[_0x6231ca(0x1da)]=_0x305030;}),__importStar=this&&this[a18_0x59b48a(0x18e)]||(function(){var _0x5c476e=function(_0x2efa47){const _0x32f768=a18_0x6b40;return _0x5c476e=Object[_0x32f768(0x1bc)]||function(_0x32006e){const _0x4e964f=_0x32f768;var _0x6b1435=[];for(var _0x16e551 in _0x32006e)if(Object[_0x4e964f(0x1c8)][_0x4e964f(0x1bf)][_0x4e964f(0x1cd)](_0x32006e,_0x16e551))_0x6b1435[_0x6b1435['length']]=_0x16e551;return _0x6b1435;},_0x5c476e(_0x2efa47);};return function(_0x5a85ad){const _0x1e2929=a18_0x6b40;if(_0x5a85ad&&_0x5a85ad[_0x1e2929(0x1bb)])return _0x5a85ad;var _0x49f94a={};if(_0x5a85ad!=null){for(var _0x2c8b38=_0x5c476e(_0x5a85ad),_0x1cd2ee=0x0;_0x1cd2ee<_0x2c8b38[_0x1e2929(0x1c9)];_0x1cd2ee++)if(_0x2c8b38[_0x1cd2ee]!==_0x1e2929(0x1da))__createBinding(_0x49f94a,_0x5a85ad,_0x2c8b38[_0x1cd2ee]);}return __setModuleDefault(_0x49f94a,_0x5a85ad),_0x49f94a;};}()),__importDefault=this&&this[a18_0x59b48a(0x187)]||function(_0x3b2351){return _0x3b2351&&_0x3b2351['__esModule']?_0x3b2351:{'default':_0x3b2351};};Object[a18_0x59b48a(0x183)](exports,a18_0x59b48a(0x1bb),{'value':!![]}),exports[a18_0x59b48a(0x1ab)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a18_0x59b48a(0x1c5)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1e9138=a18_0x59b48a;this[_0x1e9138(0x17d)]=async(_0x104765,_0x2d9c3c,_0x1c4693)=>{const _0xeb44d6=_0x1e9138;try{const {paymentId:_0x51aac5}=_0x104765[_0xeb44d6(0x1dd)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x51aac5);const _0x567dda=await database_1[_0xeb44d6(0x1da)]['payment'][_0xeb44d6(0x175)]({'where':{'id':_0x51aac5},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x567dda)return _0x2d9c3c[_0xeb44d6(0x1ae)](0x194)[_0xeb44d6(0x19b)]({'success':![],'message':_0xeb44d6(0x1a2)});if(_0x567dda['gateway']!==_0xeb44d6(0x1d2))return _0x2d9c3c[_0xeb44d6(0x1ae)](0x190)[_0xeb44d6(0x19b)]({'success':![],'message':_0xeb44d6(0x1a1)});if(_0x567dda['status']!==_0xeb44d6(0x1b4))return _0x2d9c3c[_0xeb44d6(0x1ae)](0x190)[_0xeb44d6(0x19b)]({'success':![],'message':_0xeb44d6(0x17c)+_0x567dda[_0xeb44d6(0x1ae)]+_0xeb44d6(0x1ce)});_0x2d9c3c['json']({'success':!![],'result':{'paymentId':_0x567dda['id'],'orderId':_0x567dda[_0xeb44d6(0x1c2)],'amount':_0x567dda[_0xeb44d6(0x1cc)],'currency':_0x567dda['currency'],'merchantName':_0x567dda[_0xeb44d6(0x1cb)]['name'],'description':_0xeb44d6(0x18f)+_0x567dda[_0xeb44d6(0x1cb)][_0xeb44d6(0x1b2)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0xeb44d6(0x1d6),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0xeb44d6(0x1ad),'holderName':_0xeb44d6(0x1b5)}}});}catch(_0x47bf07){_0x1c4693(_0x47bf07);}},this['processCard']=async(_0x1b88f5,_0x53c71c,_0x3ae475)=>{const _0x49a154=_0x1e9138;try{const {paymentId:_0x23ecd7}=_0x1b88f5[_0x49a154(0x1dd)],_0x29c1fa=_0x1b88f5[_0x49a154(0x1b3)];console[_0x49a154(0x1c3)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x23ecd7);const _0x5d8bef=await database_1[_0x49a154(0x1da)][_0x49a154(0x172)][_0x49a154(0x175)]({'where':{'id':_0x23ecd7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d8bef)return _0x53c71c[_0x49a154(0x1ae)](0x194)['json']({'success':![],'message':_0x49a154(0x1a2)});if(_0x5d8bef[_0x49a154(0x177)]!==_0x49a154(0x1d2))return _0x53c71c[_0x49a154(0x1ae)](0x190)['json']({'success':![],'message':_0x49a154(0x1a1)});if(_0x5d8bef['status']!==_0x49a154(0x1b4))return _0x53c71c[_0x49a154(0x1ae)](0x190)[_0x49a154(0x19b)]({'success':![],'message':_0x49a154(0x17c)+_0x5d8bef[_0x49a154(0x1ae)]+_0x49a154(0x1ce)});const _0x5d32c4=await this[_0x49a154(0x1b0)]['processCardPayment']({'paymentId':_0x5d8bef['id'],'orderId':_0x5d8bef['gatewayOrderId']||_0x5d8bef['id'],'amount':_0x5d8bef[_0x49a154(0x1cc)],'currency':_0x5d8bef[_0x49a154(0x198)],'cardData':_0x29c1fa});console[_0x49a154(0x1c3)]('üß™\x20Test\x20Gateway\x20result:',_0x5d32c4);const _0x11b971={'status':_0x5d32c4[_0x49a154(0x1ae)],'updatedAt':new Date()};if(_0x5d32c4[_0x49a154(0x1ae)]==='PAID')_0x11b971[_0x49a154(0x173)]=new Date(),_0x11b971['gatewayPaymentId']=_0x5d32c4[_0x49a154(0x17b)];else _0x5d32c4[_0x49a154(0x1ae)]===_0x49a154(0x19c)&&(_0x11b971[_0x49a154(0x18d)]=_0x5d32c4[_0x49a154(0x1e2)]);const _0x507ff4=_0x29c1fa[_0x49a154(0x1e4)]['replace'](/[\s-]/g,'');_0x11b971[_0x49a154(0x1d5)]=_0x507ff4[_0x49a154(0x1c4)](-0x4),_0x11b971[_0x49a154(0x186)]='test_card',await database_1[_0x49a154(0x1da)][_0x49a154(0x172)][_0x49a154(0x1ba)]({'where':{'id':_0x5d8bef['id']},'data':_0x11b971});if(_0x5d32c4[_0x49a154(0x1ae)]===_0x49a154(0x17f)&&_0x5d8bef[_0x49a154(0x199)]){console[_0x49a154(0x1c3)](_0x49a154(0x192)+_0x5d8bef['id']+_0x49a154(0x1b6));try{await database_1[_0x49a154(0x1da)][_0x49a154(0x1aa)](async _0x2c8c5f=>{const _0x5bc029=_0x49a154,_0x3a4591=await _0x2c8c5f[_0x5bc029(0x1b8)][_0x5bc029(0x175)]({'where':{'id':_0x5d8bef[_0x5bc029(0x199)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3a4591){console[_0x5bc029(0x1c3)](_0x5bc029(0x19f)+_0x3a4591['id']+':\x20type='+_0x3a4591[_0x5bc029(0x171)]+_0x5bc029(0x1d9)+_0x3a4591['currentPayments']+_0x5bc029(0x174)+_0x3a4591[_0x5bc029(0x1ae)]);const _0xecc626=_0x3a4591[_0x5bc029(0x1d8)]+0x1,_0x588f76=_0x3a4591[_0x5bc029(0x171)]==='SINGLE'?_0x5bc029(0x1a4):_0x3a4591['status'];await _0x2c8c5f[_0x5bc029(0x1b8)][_0x5bc029(0x1ba)]({'where':{'id':_0x5d8bef[_0x5bc029(0x199)]},'data':{'currentPayments':_0xecc626,'status':_0x588f76,'updatedAt':new Date()}}),console[_0x5bc029(0x1c3)](_0x5bc029(0x1e0)+_0x3a4591['id']+'\x20updated:\x20currentPayments='+_0x3a4591[_0x5bc029(0x1d8)]+_0x5bc029(0x1df)+_0xecc626+_0x5bc029(0x174)+_0x3a4591['status']+_0x5bc029(0x1df)+_0x588f76);}else console[_0x5bc029(0x1c3)]('‚ùå\x20Payment\x20link\x20'+_0x5d8bef[_0x5bc029(0x199)]+_0x5bc029(0x1b9));});}catch(_0x15a59e){console[_0x49a154(0x191)](_0x49a154(0x176),_0x15a59e);}}await database_1[_0x49a154(0x1da)][_0x49a154(0x19d)]['create']({'data':{'paymentId':_0x5d8bef['id'],'shopId':_0x5d8bef[_0x49a154(0x1dc)],'event':_0x49a154(0x197)+_0x5d32c4[_0x49a154(0x1ae)][_0x49a154(0x18a)](),'statusCode':0xc8,'responseBody':JSON[_0x49a154(0x1a3)]({'oldStatus':_0x49a154(0x1b4),'newStatus':_0x5d32c4[_0x49a154(0x1ae)],'transactionId':_0x5d32c4['transactionId'],'failureReason':_0x5d32c4['failureReason'],'processedAt':new Date()[_0x49a154(0x19a)]()})}}),await this[_0x49a154(0x1d1)](_0x5d8bef,_0x5d32c4[_0x49a154(0x1ae)],_0x5d32c4[_0x49a154(0x17b)],_0x5d32c4[_0x49a154(0x1e2)]),await this[_0x49a154(0x1a8)](_0x5d8bef,_0x5d32c4['status']),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x23ecd7+_0x49a154(0x196)+_0x5d32c4['status']),_0x5d32c4[_0x49a154(0x1ae)]===_0x49a154(0x17f)?_0x53c71c['json']({'success':!![],'message':_0x49a154(0x180),'result':{'status':_0x49a154(0x17f),'transactionId':_0x5d32c4[_0x49a154(0x17b)],'redirectUrl':_0x5d8bef[_0x49a154(0x189)]}}):_0x53c71c['status'](0x190)[_0x49a154(0x19b)]({'success':![],'message':_0x49a154(0x179),'result':{'status':_0x49a154(0x19c),'failureReason':_0x5d32c4[_0x49a154(0x1e2)],'redirectUrl':_0x5d8bef['failUrl']}});}catch(_0x2a8655){_0x3ae475(_0x2a8655);}},this['testGatewayService']=new testGatewayService_1[(_0x1e9138(0x1db))](),this[_0x1e9138(0x185)]=new webhookService_1['WebhookService']();}async[a18_0x59b48a(0x1d1)](_0x50380d,_0xce9bde,_0x5555ed,_0x53f3dd){const _0x46ade3=a18_0x59b48a,_0x126b38=Date[_0x46ade3(0x1a9)]();try{const _0x4e0fd9=_0x50380d[_0x46ade3(0x1cb)],_0x5ebd25=_0x4e0fd9[_0x46ade3(0x1a6)];if(!_0x5ebd25?.[_0x46ade3(0x1a7)]){console[_0x46ade3(0x1c3)](_0x46ade3(0x18c)+_0x4e0fd9['id']);return;}const _0x31dd48=_0xce9bde===_0x46ade3(0x17f)?_0x46ade3(0x190):_0x46ade3(0x1c7);let _0x3e534d=[];if(_0x5ebd25[_0x46ade3(0x181)])try{_0x3e534d=Array[_0x46ade3(0x17a)](_0x5ebd25[_0x46ade3(0x181)])?_0x5ebd25['webhookEvents']:JSON[_0x46ade3(0x1cf)](_0x5ebd25[_0x46ade3(0x181)]);}catch(_0x1d7b1e){console[_0x46ade3(0x191)](_0x46ade3(0x1e1),_0x1d7b1e),_0x3e534d=[];}if(!_0x3e534d[_0x46ade3(0x1ca)](_0x31dd48)){console[_0x46ade3(0x1c3)](_0x46ade3(0x182)+_0x31dd48+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4e0fd9['id']);return;}const _0x4cac13={'event':_0x31dd48,'payment':{'id':_0x50380d['id'],'order_id':_0x50380d['orderId'],'gateway_order_id':_0x50380d[_0x46ade3(0x1c2)],'gateway':_0x46ade3(0x1ac),'amount':_0x50380d[_0x46ade3(0x1cc)],'currency':_0x50380d['currency'],'status':_0xce9bde[_0x46ade3(0x18a)](),'customer_email':_0x50380d['customerEmail'],'customer_name':_0x50380d[_0x46ade3(0x170)],'transaction_id':_0x5555ed,'failure_message':_0x53f3dd,'created_at':_0x50380d['createdAt'],'updated_at':new Date()}},_0x34a5be=await fetch(_0x5ebd25[_0x46ade3(0x1a7)],{'method':_0x46ade3(0x17e),'headers':{'Content-Type':_0x46ade3(0x1a5),'User-Agent':_0x46ade3(0x1af)},'body':JSON[_0x46ade3(0x1a3)](_0x4cac13)}),_0x748d3a=Date[_0x46ade3(0x1a9)]()-_0x126b38;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x5ebd25[_0x46ade3(0x1a7)]+_0x46ade3(0x195)+_0x34a5be['status']+'\x20('+_0x748d3a+_0x46ade3(0x18b));}catch(_0x53b739){console[_0x46ade3(0x191)](_0x46ade3(0x184),_0x53b739);}}async[a18_0x59b48a(0x1a8)](_0x547a69,_0x3f899f){const _0x5db69a=a18_0x59b48a;try{const {telegramBotService:_0x3fb57b}=await Promise[_0x5db69a(0x1c0)]()[_0x5db69a(0x1b1)](()=>__importStar(require(_0x5db69a(0x193)))),_0x4108e2={'PAID':_0x5db69a(0x1d7),'FAILED':_0x5db69a(0x1be)},_0x59690e=_0x4108e2[_0x3f899f];if(!_0x59690e)return;await _0x3fb57b[_0x5db69a(0x1d3)](_0x547a69[_0x5db69a(0x1dc)],_0x547a69,_0x59690e);}catch(_0x4a3be8){console[_0x5db69a(0x191)](_0x5db69a(0x1c1),_0x4a3be8);}}}exports[a18_0x59b48a(0x1ab)]=TestGatewayController;