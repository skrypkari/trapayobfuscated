'use strict';const a13_0x1d3447=a13_0x1b44;(function(_0x994f3d,_0x480f50){const _0x11693c=a13_0x1b44,_0x35126e=_0x994f3d();while(!![]){try{const _0x202914=-parseInt(_0x11693c(0x17c))/0x1+parseInt(_0x11693c(0x199))/0x2+parseInt(_0x11693c(0x13e))/0x3*(parseInt(_0x11693c(0x16b))/0x4)+-parseInt(_0x11693c(0x146))/0x5+-parseInt(_0x11693c(0x136))/0x6+parseInt(_0x11693c(0x159))/0x7*(parseInt(_0x11693c(0x14b))/0x8)+-parseInt(_0x11693c(0x169))/0x9*(-parseInt(_0x11693c(0x141))/0xa);if(_0x202914===_0x480f50)break;else _0x35126e['push'](_0x35126e['shift']());}catch(_0x3b3612){_0x35126e['push'](_0x35126e['shift']());}}}(a13_0x2c07,0x9c04e));var __createBinding=this&&this['__createBinding']||(Object[a13_0x1d3447(0x18c)]?function(_0x4f49ca,_0x44f131,_0x2dc633,_0x3af4cd){const _0x4309c7=a13_0x1d3447;if(_0x3af4cd===undefined)_0x3af4cd=_0x2dc633;var _0x214f96=Object[_0x4309c7(0x154)](_0x44f131,_0x2dc633);(!_0x214f96||(_0x4309c7(0x13c)in _0x214f96?!_0x44f131[_0x4309c7(0x17a)]:_0x214f96[_0x4309c7(0x180)]||_0x214f96[_0x4309c7(0x19b)]))&&(_0x214f96={'enumerable':!![],'get':function(){return _0x44f131[_0x2dc633];}}),Object['defineProperty'](_0x4f49ca,_0x3af4cd,_0x214f96);}:function(_0x26cc18,_0x589da7,_0x531ac9,_0x2e2326){if(_0x2e2326===undefined)_0x2e2326=_0x531ac9;_0x26cc18[_0x2e2326]=_0x589da7[_0x531ac9];}),__setModuleDefault=this&&this[a13_0x1d3447(0x157)]||(Object[a13_0x1d3447(0x18c)]?function(_0x2ec09f,_0x510807){const _0x21d9b2=a13_0x1d3447;Object[_0x21d9b2(0x13b)](_0x2ec09f,_0x21d9b2(0x151),{'enumerable':!![],'value':_0x510807});}:function(_0x4ddbb1,_0x576fde){const _0x409b64=a13_0x1d3447;_0x4ddbb1[_0x409b64(0x151)]=_0x576fde;}),__importStar=this&&this[a13_0x1d3447(0x187)]||(function(){var _0x30e929=function(_0x389947){const _0x24571a=a13_0x1b44;return _0x30e929=Object[_0x24571a(0x135)]||function(_0x1dbe42){const _0x426cfc=_0x24571a;var _0x473056=[];for(var _0x12a0f8 in _0x1dbe42)if(Object[_0x426cfc(0x161)][_0x426cfc(0x164)][_0x426cfc(0x155)](_0x1dbe42,_0x12a0f8))_0x473056[_0x473056[_0x426cfc(0x140)]]=_0x12a0f8;return _0x473056;},_0x30e929(_0x389947);};return function(_0x52d2e8){const _0xe1f8ac=a13_0x1b44;if(_0x52d2e8&&_0x52d2e8[_0xe1f8ac(0x17a)])return _0x52d2e8;var _0xcf285d={};if(_0x52d2e8!=null){for(var _0x522455=_0x30e929(_0x52d2e8),_0x5d6f8b=0x0;_0x5d6f8b<_0x522455[_0xe1f8ac(0x140)];_0x5d6f8b++)if(_0x522455[_0x5d6f8b]!==_0xe1f8ac(0x151))__createBinding(_0xcf285d,_0x52d2e8,_0x522455[_0x5d6f8b]);}return __setModuleDefault(_0xcf285d,_0x52d2e8),_0xcf285d;};}()),__importDefault=this&&this[a13_0x1d3447(0x133)]||function(_0x3104df){const _0x1a9532=a13_0x1d3447;return _0x3104df&&_0x3104df[_0x1a9532(0x17a)]?_0x3104df:{'default':_0x3104df};};function a13_0x2c07(){const _0x3ce21f=['amount','createdAt','Payment\x20failed','Payment\x20status\x20is\x20','currency','Any\x20other\x20card\x20number','failUrl','json','../services/gateways/testGatewayService','failureReason','../services/telegramBotService','payment.success','2225018KDiweG','Payment\x20processed\x20successfully','configurable','\x20processed:\x20','parse','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','PENDING','log','__importDefault','customerEmail','getOwnPropertyNames','5320902TUfbtC','isArray','Any\x20name','PAID','4242\x204242\x204242\x204242','defineProperty','get','Payment\x20to\x20','537DStxfY','TestGatewayService','length','70tiAGtw','Payment\x20is\x20not\x20for\x20test\x20gateway','testGatewayService','gatewayPaymentId','processCardPayment','6364645SELEQe','test_card','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','sendPaymentStatusNotification','sendPaymentNotification','8mjcLnA','WebhookService','name','application/json','\x20not\x20enabled\x20for\x20shop\x20','gateway','default','Webhook\x20event\x20','Payment\x20not\x20found','getOwnPropertyDescriptor','call','now','__setModuleDefault','test_gateway','8716372okwRWn','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookEvents','ðŸ§ª\x20Test\x20Gateway\x20result:','test_gateway_','replace','cardLast4','paymentMethod','prototype','payment','ms)','hasOwnProperty','resolve','sendShopWebhook','\x20with\x20status\x20','params','77229TGLzKK','error','25356XaXosl','findUnique','processCard','shop','âœ…\x20Test\x20Gateway\x20payment\x20','gatewayOrderId','cardNumber','shopId','then','transactionId','body','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','slice','failed','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__esModule','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','753653hvjJqd','status','stringify','webhookUrl','writable','Any\x203-4\x20digits','paid','failureMessage','TestGatewayController','FAILED','webhookLog','__importStar','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerName','orderId','toLowerCase','create'];a13_0x2c07=function(){return _0x3ce21f;};return a13_0x2c07();}Object[a13_0x1d3447(0x13b)](exports,a13_0x1d3447(0x17a),{'value':!![]}),exports[a13_0x1d3447(0x184)]=void 0x0;const testGatewayService_1=require(a13_0x1d3447(0x195)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));function a13_0x1b44(_0x568a04,_0x1cf75b){const _0x2c07eb=a13_0x2c07();return a13_0x1b44=function(_0x1b4411,_0x5744c7){_0x1b4411=_0x1b4411-0x131;let _0x543228=_0x2c07eb[_0x1b4411];return _0x543228;},a13_0x1b44(_0x568a04,_0x1cf75b);}class TestGatewayController{constructor(){const _0x84f8aa=a13_0x1d3447;this['getPaymentForm']=async(_0x2ef3f5,_0x26a6d8,_0x10ff37)=>{const _0x3e8a13=a13_0x1b44;try{const {paymentId:_0x10b5dd}=_0x2ef3f5[_0x3e8a13(0x168)];console[_0x3e8a13(0x132)](_0x3e8a13(0x148)+_0x10b5dd);const _0xf91dd9=await database_1[_0x3e8a13(0x151)][_0x3e8a13(0x162)][_0x3e8a13(0x16c)]({'where':{'id':_0x10b5dd},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xf91dd9)return _0x26a6d8['status'](0x194)[_0x3e8a13(0x194)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xf91dd9[_0x3e8a13(0x150)]!==_0x3e8a13(0x158))return _0x26a6d8[_0x3e8a13(0x17d)](0x190)['json']({'success':![],'message':_0x3e8a13(0x142)});if(_0xf91dd9['status']!==_0x3e8a13(0x131))return _0x26a6d8[_0x3e8a13(0x17d)](0x190)[_0x3e8a13(0x194)]({'success':![],'message':_0x3e8a13(0x190)+_0xf91dd9[_0x3e8a13(0x17d)]+',\x20cannot\x20process'});_0x26a6d8[_0x3e8a13(0x194)]({'success':!![],'result':{'paymentId':_0xf91dd9['id'],'orderId':_0xf91dd9['gatewayOrderId'],'amount':_0xf91dd9[_0x3e8a13(0x18d)],'currency':_0xf91dd9[_0x3e8a13(0x191)],'merchantName':_0xf91dd9[_0x3e8a13(0x16e)][_0x3e8a13(0x14d)],'description':_0x3e8a13(0x13d)+_0xf91dd9[_0x3e8a13(0x16e)]['name'],'testInstructions':{'successCard':_0x3e8a13(0x13a),'failureCard':_0x3e8a13(0x192),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x3e8a13(0x181),'holderName':_0x3e8a13(0x138)}}});}catch(_0xbb579d){_0x10ff37(_0xbb579d);}},this[_0x84f8aa(0x16d)]=async(_0x21e25a,_0x4b5e4a,_0x5194c1)=>{const _0x4b6cc6=_0x84f8aa;try{const {paymentId:_0x5c771d}=_0x21e25a[_0x4b6cc6(0x168)],_0x304249=_0x21e25a[_0x4b6cc6(0x175)];console[_0x4b6cc6(0x132)](_0x4b6cc6(0x19e)+_0x5c771d);const _0x3210f2=await database_1[_0x4b6cc6(0x151)][_0x4b6cc6(0x162)][_0x4b6cc6(0x16c)]({'where':{'id':_0x5c771d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3210f2)return _0x4b5e4a['status'](0x194)[_0x4b6cc6(0x194)]({'success':![],'message':_0x4b6cc6(0x153)});if(_0x3210f2[_0x4b6cc6(0x150)]!==_0x4b6cc6(0x158))return _0x4b5e4a['status'](0x190)['json']({'success':![],'message':_0x4b6cc6(0x142)});if(_0x3210f2[_0x4b6cc6(0x17d)]!==_0x4b6cc6(0x131))return _0x4b5e4a[_0x4b6cc6(0x17d)](0x190)['json']({'success':![],'message':_0x4b6cc6(0x190)+_0x3210f2['status']+',\x20cannot\x20process'});const _0x4ef67f=await this[_0x4b6cc6(0x143)][_0x4b6cc6(0x145)]({'paymentId':_0x3210f2['id'],'orderId':_0x3210f2['gatewayOrderId']||_0x3210f2['id'],'amount':_0x3210f2['amount'],'currency':_0x3210f2[_0x4b6cc6(0x191)],'cardData':_0x304249});console[_0x4b6cc6(0x132)](_0x4b6cc6(0x15c),_0x4ef67f);const _0x45c1c6={'status':_0x4ef67f['status'],'updatedAt':new Date()};if(_0x4ef67f[_0x4b6cc6(0x17d)]==='PAID')_0x45c1c6['paidAt']=new Date(),_0x45c1c6[_0x4b6cc6(0x144)]=_0x4ef67f[_0x4b6cc6(0x174)];else _0x4ef67f[_0x4b6cc6(0x17d)]===_0x4b6cc6(0x185)&&(_0x45c1c6[_0x4b6cc6(0x183)]=_0x4ef67f['failureReason']);const _0x5a0ca5=_0x304249[_0x4b6cc6(0x171)][_0x4b6cc6(0x15e)](/[\s-]/g,'');_0x45c1c6[_0x4b6cc6(0x15f)]=_0x5a0ca5[_0x4b6cc6(0x177)](-0x4),_0x45c1c6[_0x4b6cc6(0x160)]=_0x4b6cc6(0x147),await database_1[_0x4b6cc6(0x151)][_0x4b6cc6(0x162)]['update']({'where':{'id':_0x3210f2['id']},'data':_0x45c1c6}),await database_1[_0x4b6cc6(0x151)][_0x4b6cc6(0x186)][_0x4b6cc6(0x18c)]({'data':{'paymentId':_0x3210f2['id'],'shopId':_0x3210f2[_0x4b6cc6(0x172)],'event':_0x4b6cc6(0x15d)+_0x4ef67f['status'][_0x4b6cc6(0x18b)](),'statusCode':0xc8,'responseBody':JSON[_0x4b6cc6(0x17e)]({'oldStatus':_0x4b6cc6(0x131),'newStatus':_0x4ef67f[_0x4b6cc6(0x17d)],'transactionId':_0x4ef67f[_0x4b6cc6(0x174)],'failureReason':_0x4ef67f[_0x4b6cc6(0x196)],'processedAt':new Date()['toISOString']()})}}),await this[_0x4b6cc6(0x166)](_0x3210f2,_0x4ef67f['status'],_0x4ef67f[_0x4b6cc6(0x174)],_0x4ef67f[_0x4b6cc6(0x196)]),await this[_0x4b6cc6(0x149)](_0x3210f2,_0x4ef67f[_0x4b6cc6(0x17d)]),console['log'](_0x4b6cc6(0x16f)+_0x5c771d+_0x4b6cc6(0x19c)+_0x4ef67f[_0x4b6cc6(0x17d)]),_0x4ef67f[_0x4b6cc6(0x17d)]===_0x4b6cc6(0x139)?_0x4b5e4a[_0x4b6cc6(0x194)]({'success':!![],'message':_0x4b6cc6(0x19a),'result':{'status':_0x4b6cc6(0x139),'transactionId':_0x4ef67f[_0x4b6cc6(0x174)],'redirectUrl':_0x3210f2['successUrl']}}):_0x4b5e4a['status'](0x190)[_0x4b6cc6(0x194)]({'success':![],'message':_0x4b6cc6(0x18f),'result':{'status':_0x4b6cc6(0x185),'failureReason':_0x4ef67f[_0x4b6cc6(0x196)],'redirectUrl':_0x3210f2[_0x4b6cc6(0x193)]}});}catch(_0x641c3f){_0x5194c1(_0x641c3f);}},this[_0x84f8aa(0x143)]=new testGatewayService_1[(_0x84f8aa(0x13f))](),this['webhookService']=new webhookService_1[(_0x84f8aa(0x14c))]();}async[a13_0x1d3447(0x166)](_0x36084c,_0x22a6f1,_0x4521c7,_0x537fef){const _0x37093d=a13_0x1d3447,_0x5bff1f=Date[_0x37093d(0x156)]();try{const _0x2245fc=_0x36084c[_0x37093d(0x16e)],_0x1a9264=_0x2245fc['settings'];if(!_0x1a9264?.[_0x37093d(0x17f)]){console[_0x37093d(0x132)](_0x37093d(0x188)+_0x2245fc['id']);return;}const _0x589e1d=_0x22a6f1===_0x37093d(0x139)?_0x37093d(0x198):'payment.failed';let _0x5c7664=[];if(_0x1a9264[_0x37093d(0x15b)])try{_0x5c7664=Array[_0x37093d(0x137)](_0x1a9264['webhookEvents'])?_0x1a9264[_0x37093d(0x15b)]:JSON[_0x37093d(0x19d)](_0x1a9264[_0x37093d(0x15b)]);}catch(_0x238d4f){console['error']('Error\x20parsing\x20webhook\x20events:',_0x238d4f),_0x5c7664=[];}if(!_0x5c7664['includes'](_0x589e1d)){console['log'](_0x37093d(0x152)+_0x589e1d+_0x37093d(0x14f)+_0x2245fc['id']);return;}const _0x345ddd={'event':_0x589e1d,'payment':{'id':_0x36084c['id'],'order_id':_0x36084c[_0x37093d(0x18a)],'gateway_order_id':_0x36084c[_0x37093d(0x170)],'gateway':'0000','amount':_0x36084c[_0x37093d(0x18d)],'currency':_0x36084c[_0x37093d(0x191)],'status':_0x22a6f1['toLowerCase'](),'customer_email':_0x36084c[_0x37093d(0x134)],'customer_name':_0x36084c[_0x37093d(0x189)],'transaction_id':_0x4521c7,'failure_message':_0x537fef,'created_at':_0x36084c[_0x37093d(0x18e)],'updated_at':new Date()}},_0x49b192=await fetch(_0x1a9264[_0x37093d(0x17f)],{'method':'POST','headers':{'Content-Type':_0x37093d(0x14e),'User-Agent':_0x37093d(0x17b)},'body':JSON['stringify'](_0x345ddd)}),_0x4f2ea7=Date['now']()-_0x5bff1f;console[_0x37093d(0x132)](_0x37093d(0x179)+_0x1a9264[_0x37093d(0x17f)]+_0x37093d(0x167)+_0x49b192[_0x37093d(0x17d)]+'\x20('+_0x4f2ea7+_0x37093d(0x163));}catch(_0x212de1){console[_0x37093d(0x16a)](_0x37093d(0x15a),_0x212de1);}}async[a13_0x1d3447(0x149)](_0x1fc1b2,_0x499b87){const _0x2b7a5e=a13_0x1d3447;try{const {telegramBotService:_0x112893}=await Promise[_0x2b7a5e(0x165)]()[_0x2b7a5e(0x173)](()=>__importStar(require(_0x2b7a5e(0x197)))),_0xdbdeb6={'PAID':_0x2b7a5e(0x182),'FAILED':_0x2b7a5e(0x178)},_0x2857e4=_0xdbdeb6[_0x499b87];if(!_0x2857e4)return;await _0x112893[_0x2b7a5e(0x14a)](_0x1fc1b2['shopId'],_0x1fc1b2,_0x2857e4);}catch(_0x16efbe){console[_0x2b7a5e(0x16a)](_0x2b7a5e(0x176),_0x16efbe);}}}exports['TestGatewayController']=TestGatewayController;