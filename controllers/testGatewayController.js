'use strict';const a21_0x4972ed=a21_0x2460;(function(_0x2cf2bb,_0x2fa01e){const _0x1fd3f8=a21_0x2460,_0x322ec7=_0x2cf2bb();while(!![]){try{const _0x434d9c=-parseInt(_0x1fd3f8(0x1d3))/0x1*(parseInt(_0x1fd3f8(0x190))/0x2)+parseInt(_0x1fd3f8(0x1d6))/0x3+parseInt(_0x1fd3f8(0x17a))/0x4+-parseInt(_0x1fd3f8(0x1cf))/0x5+parseInt(_0x1fd3f8(0x169))/0x6+parseInt(_0x1fd3f8(0x180))/0x7*(parseInt(_0x1fd3f8(0x1c7))/0x8)+-parseInt(_0x1fd3f8(0x187))/0x9;if(_0x434d9c===_0x2fa01e)break;else _0x322ec7['push'](_0x322ec7['shift']());}catch(_0x597fe7){_0x322ec7['push'](_0x322ec7['shift']());}}}(a21_0x1605,0x9a74c));var __createBinding=this&&this['__createBinding']||(Object[a21_0x4972ed(0x1b2)]?function(_0x4fdbfa,_0x14f371,_0xb3a95a,_0x2dc43c){const _0x61dd98=a21_0x4972ed;if(_0x2dc43c===undefined)_0x2dc43c=_0xb3a95a;var _0x32ade4=Object['getOwnPropertyDescriptor'](_0x14f371,_0xb3a95a);(!_0x32ade4||('get'in _0x32ade4?!_0x14f371[_0x61dd98(0x195)]:_0x32ade4[_0x61dd98(0x1d9)]||_0x32ade4['configurable']))&&(_0x32ade4={'enumerable':!![],'get':function(){return _0x14f371[_0xb3a95a];}}),Object[_0x61dd98(0x16b)](_0x4fdbfa,_0x2dc43c,_0x32ade4);}:function(_0x27734c,_0x3450ea,_0x3a57f3,_0x19be77){if(_0x19be77===undefined)_0x19be77=_0x3a57f3;_0x27734c[_0x19be77]=_0x3450ea[_0x3a57f3];}),__setModuleDefault=this&&this[a21_0x4972ed(0x158)]||(Object[a21_0x4972ed(0x1b2)]?function(_0x1c6a25,_0x451cd0){const _0x1eee5e=a21_0x4972ed;Object[_0x1eee5e(0x16b)](_0x1c6a25,_0x1eee5e(0x196),{'enumerable':!![],'value':_0x451cd0});}:function(_0x517ac2,_0xad1f9b){const _0x3b76cd=a21_0x4972ed;_0x517ac2[_0x3b76cd(0x196)]=_0xad1f9b;}),__importStar=this&&this[a21_0x4972ed(0x1b3)]||(function(){var _0x1f94a6=function(_0x268955){const _0x152f1a=a21_0x2460;return _0x1f94a6=Object[_0x152f1a(0x15a)]||function(_0x53d5ff){const _0x1c009b=_0x152f1a;var _0x35859b=[];for(var _0x8896eb in _0x53d5ff)if(Object[_0x1c009b(0x1a4)]['hasOwnProperty']['call'](_0x53d5ff,_0x8896eb))_0x35859b[_0x35859b[_0x1c009b(0x1da)]]=_0x8896eb;return _0x35859b;},_0x1f94a6(_0x268955);};return function(_0x21ec58){const _0x2104f2=a21_0x2460;if(_0x21ec58&&_0x21ec58[_0x2104f2(0x195)])return _0x21ec58;var _0x49ad4f={};if(_0x21ec58!=null){for(var _0x3e3c63=_0x1f94a6(_0x21ec58),_0x7c6c20=0x0;_0x7c6c20<_0x3e3c63[_0x2104f2(0x1da)];_0x7c6c20++)if(_0x3e3c63[_0x7c6c20]!=='default')__createBinding(_0x49ad4f,_0x21ec58,_0x3e3c63[_0x7c6c20]);}return __setModuleDefault(_0x49ad4f,_0x21ec58),_0x49ad4f;};}()),__importDefault=this&&this[a21_0x4972ed(0x1a3)]||function(_0x1bb67d){const _0x4cf2f5=a21_0x4972ed;return _0x1bb67d&&_0x1bb67d[_0x4cf2f5(0x195)]?_0x1bb67d:{'default':_0x1bb67d};};Object['defineProperty'](exports,a21_0x4972ed(0x195),{'value':!![]}),exports[a21_0x4972ed(0x1be)]=void 0x0;function a21_0x1605(){const _0x4b7d41=['findUnique','\x20->\x20','error','isArray','webhookLog','type','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','\x20not\x20found','create','__importStar','payment.success','TestGatewayService','hex','toISOString','ðŸ“ˆ\x20Found\x20payment\x20link\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','ðŸ§ª\x20Test\x20Gateway\x20result:','then',',\x20currentPayments=','update','TestGatewayController','gateway','createHmac','../services/gateways/testGatewayService','transactionId','paymentLink','parse','Error\x20parsing\x20webhook\x20events:','0000','48mWPIlb','payment','Payment\x20processed\x20successfully','gatewayOrderId','failureMessage','sendPaymentStatusNotification','Any\x20future\x20date\x20(MM/YY)','4242\x204242\x204242\x204242','5743890GecsmV','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','Any\x203-4\x20digits','cardLast4','260lqwGps','ms)','Any\x20name','3647997rhjZEF','ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event=','successUrl','writable','length','sendPaymentNotification','failureReason','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20',',\x20status=','currentPayments','__setModuleDefault','âš ï¸\x20Webhook\x20event\x20','getOwnPropertyNames','currency','configured','replace','log','createdAt','customerName','cardNumber','testGatewayService','processCard',',\x20cannot\x20process','paid','$transaction','processCardPayment','webhookUrl','2843982gMOmfe','PENDING','defineProperty','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','\x20with\x20status\x20','shop','ðŸ§ª\x20Webhook\x20payload:',':\x20type=','digest','test_gateway','gatewayPaymentId','payment.failed','customerEmail','stringify','webhookEvents','sendShopWebhook','Payment\x20to\x20','308600TmVLEd','webhookService','paymentMethod','resolve','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','\x20processed:\x20','565327ZpfjTG','COMPLETED','name','now','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','params','Payment\x20not\x20found','1361358gSSWfD','Payment\x20System/1.0\x20(Test\x20Gateway)','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','SINGLE','\x20updated:\x20currentPayments=','status','Any\x20other\x20card\x20number','secretKey','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','2454IxmwbS','Payment\x20is\x20not\x20for\x20test\x20gateway','WebhookService','json','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','__esModule','default','not\x20configured','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','...','slice','toLowerCase','shopId','paymentLinkId','âŒ\x20Payment\x20link\x20','application/json','orderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','FAILED','__importDefault','prototype','POST','PAID','sha256','includes','amount'];a21_0x1605=function(){return _0x4b7d41;};return a21_0x1605();}function a21_0x2460(_0xd75b10,_0x481d7c){_0xd75b10=_0xd75b10-0x155;const _0x160594=a21_0x1605();let _0x2460cf=_0x160594[_0xd75b10];return _0x2460cf;}const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require(a21_0x4972ed(0x1c1)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x35684d=a21_0x4972ed;this['getPaymentForm']=async(_0x154f03,_0x11ff0a,_0x599fae)=>{const _0x4a06b0=a21_0x2460;try{const {paymentId:_0x3d33e2}=_0x154f03[_0x4a06b0(0x185)];console[_0x4a06b0(0x15e)](_0x4a06b0(0x1b9)+_0x3d33e2);const _0x456d39=await database_1['default'][_0x4a06b0(0x1c8)][_0x4a06b0(0x1aa)]({'where':{'id':_0x3d33e2},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x456d39)return _0x11ff0a['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x456d39['gateway']!==_0x4a06b0(0x172))return _0x11ff0a['status'](0x190)[_0x4a06b0(0x193)]({'success':![],'message':_0x4a06b0(0x191)});if(_0x456d39['status']!==_0x4a06b0(0x16a))return _0x11ff0a['status'](0x190)[_0x4a06b0(0x193)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x456d39[_0x4a06b0(0x18c)]+_0x4a06b0(0x164)});_0x11ff0a[_0x4a06b0(0x193)]({'success':!![],'result':{'paymentId':_0x456d39['id'],'orderId':_0x456d39[_0x4a06b0(0x1ca)],'amount':_0x456d39[_0x4a06b0(0x1a9)],'currency':_0x456d39[_0x4a06b0(0x15b)],'merchantName':_0x456d39[_0x4a06b0(0x16e)]['name'],'description':_0x4a06b0(0x179)+_0x456d39[_0x4a06b0(0x16e)][_0x4a06b0(0x182)],'testInstructions':{'successCard':_0x4a06b0(0x1ce),'failureCard':_0x4a06b0(0x18d),'expiryDate':_0x4a06b0(0x1cd),'cvc':_0x4a06b0(0x1d1),'holderName':_0x4a06b0(0x1d5)}}});}catch(_0x38853a){_0x599fae(_0x38853a);}},this[_0x35684d(0x163)]=async(_0x473610,_0x44c6d2,_0x259036)=>{const _0x336dfb=_0x35684d;try{const {paymentId:_0x4fe693}=_0x473610[_0x336dfb(0x185)],_0x1df04b=_0x473610['body'];console[_0x336dfb(0x15e)](_0x336dfb(0x198)+_0x4fe693);const _0x33f989=await database_1['default'][_0x336dfb(0x1c8)]['findUnique']({'where':{'id':_0x4fe693},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33f989)return _0x44c6d2[_0x336dfb(0x18c)](0x194)[_0x336dfb(0x193)]({'success':![],'message':_0x336dfb(0x186)});if(_0x33f989[_0x336dfb(0x1bf)]!=='test_gateway')return _0x44c6d2[_0x336dfb(0x18c)](0x190)[_0x336dfb(0x193)]({'success':![],'message':_0x336dfb(0x191)});if(_0x33f989[_0x336dfb(0x18c)]!=='PENDING')return _0x44c6d2[_0x336dfb(0x18c)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x33f989[_0x336dfb(0x18c)]+_0x336dfb(0x164)});const _0x5efaf7=await this['testGatewayService'][_0x336dfb(0x167)]({'paymentId':_0x33f989['id'],'orderId':_0x33f989[_0x336dfb(0x1ca)]||_0x33f989['id'],'amount':_0x33f989[_0x336dfb(0x1a9)],'currency':_0x33f989[_0x336dfb(0x15b)],'cardData':_0x1df04b});console['log'](_0x336dfb(0x1ba),_0x5efaf7);const _0x1f43f0={'status':_0x5efaf7[_0x336dfb(0x18c)],'updatedAt':new Date()};if(_0x5efaf7[_0x336dfb(0x18c)]==='PAID')_0x1f43f0['paidAt']=new Date(),_0x1f43f0[_0x336dfb(0x173)]=_0x5efaf7[_0x336dfb(0x1c2)];else _0x5efaf7[_0x336dfb(0x18c)]===_0x336dfb(0x1a2)&&(_0x1f43f0[_0x336dfb(0x1cb)]=_0x5efaf7[_0x336dfb(0x1dc)]);const _0x543ad=_0x1df04b[_0x336dfb(0x161)][_0x336dfb(0x15d)](/[\s-]/g,'');_0x1f43f0[_0x336dfb(0x1d2)]=_0x543ad[_0x336dfb(0x19a)](-0x4),_0x1f43f0[_0x336dfb(0x17c)]='test_card',await database_1['default'][_0x336dfb(0x1c8)][_0x336dfb(0x1bd)]({'where':{'id':_0x33f989['id']},'data':_0x1f43f0});if(_0x5efaf7[_0x336dfb(0x18c)]===_0x336dfb(0x1a6)&&_0x33f989[_0x336dfb(0x19d)]){console['log'](_0x336dfb(0x1b0)+_0x33f989['id']+_0x336dfb(0x189));try{await database_1['default'][_0x336dfb(0x166)](async _0x3c7863=>{const _0x34518c=_0x336dfb,_0x266052=await _0x3c7863[_0x34518c(0x1c3)][_0x34518c(0x1aa)]({'where':{'id':_0x33f989[_0x34518c(0x19d)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x266052){console[_0x34518c(0x15e)](_0x34518c(0x1b8)+_0x266052['id']+_0x34518c(0x170)+_0x266052[_0x34518c(0x1af)]+_0x34518c(0x1bc)+_0x266052[_0x34518c(0x157)]+_0x34518c(0x156)+_0x266052[_0x34518c(0x18c)]);const _0x473043=_0x266052['currentPayments']+0x1,_0x21d2e4=_0x266052[_0x34518c(0x1af)]===_0x34518c(0x18a)?_0x34518c(0x181):_0x266052['status'];await _0x3c7863[_0x34518c(0x1c3)][_0x34518c(0x1bd)]({'where':{'id':_0x33f989[_0x34518c(0x19d)]},'data':{'currentPayments':_0x473043,'status':_0x21d2e4,'updatedAt':new Date()}}),console[_0x34518c(0x15e)]('âœ…\x20Payment\x20link\x20'+_0x266052['id']+_0x34518c(0x18b)+_0x266052[_0x34518c(0x157)]+_0x34518c(0x1ab)+_0x473043+_0x34518c(0x156)+_0x266052[_0x34518c(0x18c)]+_0x34518c(0x1ab)+_0x21d2e4);}else console[_0x34518c(0x15e)](_0x34518c(0x19e)+_0x33f989[_0x34518c(0x19d)]+_0x34518c(0x1b1));});}catch(_0x530275){console[_0x336dfb(0x1ac)](_0x336dfb(0x194),_0x530275);}}await database_1['default'][_0x336dfb(0x1ae)]['create']({'data':{'paymentId':_0x33f989['id'],'shopId':_0x33f989[_0x336dfb(0x19c)],'event':'test_gateway_'+_0x5efaf7[_0x336dfb(0x18c)]['toLowerCase'](),'statusCode':_0x5efaf7[_0x336dfb(0x18c)]===_0x336dfb(0x1a6)?0xc8:0x190,'responseBody':JSON[_0x336dfb(0x176)]({'oldStatus':_0x336dfb(0x16a),'newStatus':_0x5efaf7[_0x336dfb(0x18c)],'transactionId':_0x5efaf7[_0x336dfb(0x1c2)],'failureReason':_0x5efaf7['failureReason'],'processedAt':new Date()[_0x336dfb(0x1b7)]()})}}),console[_0x336dfb(0x15e)]('ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20'+_0x5efaf7[_0x336dfb(0x18c)]+_0x336dfb(0x199)),await this['sendShopWebhook'](_0x33f989,_0x5efaf7['status'],_0x5efaf7[_0x336dfb(0x1c2)],_0x5efaf7[_0x336dfb(0x1dc)]),console[_0x336dfb(0x15e)](_0x336dfb(0x184)+_0x5efaf7[_0x336dfb(0x18c)]),console[_0x336dfb(0x15e)](_0x336dfb(0x17e)+_0x5efaf7['status']+_0x336dfb(0x199)),await this[_0x336dfb(0x1cc)](_0x33f989,_0x5efaf7['status']),console['log'](_0x336dfb(0x16c)+_0x5efaf7['status']),console[_0x336dfb(0x15e)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x4fe693+_0x336dfb(0x17f)+_0x5efaf7[_0x336dfb(0x18c)]),_0x5efaf7[_0x336dfb(0x18c)]===_0x336dfb(0x1a6)?_0x44c6d2['json']({'success':!![],'message':_0x336dfb(0x1c9),'result':{'status':_0x336dfb(0x1a6),'transactionId':_0x5efaf7['transactionId'],'redirectUrl':_0x33f989[_0x336dfb(0x1d8)]}}):_0x44c6d2[_0x336dfb(0x18c)](0x190)[_0x336dfb(0x193)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x336dfb(0x1a2),'failureReason':_0x5efaf7['failureReason'],'redirectUrl':_0x33f989['failUrl']}});}catch(_0xe88ddc){_0x259036(_0xe88ddc);}},this[_0x35684d(0x162)]=new testGatewayService_1[(_0x35684d(0x1b5))](),this[_0x35684d(0x17b)]=new webhookService_1[(_0x35684d(0x192))]();}async[a21_0x4972ed(0x178)](_0x723efb,_0x171178,_0x5347a6,_0x49e45c){const _0x2ec609=a21_0x4972ed,_0x325c89=Date['now']();try{const _0x2e09a3=_0x723efb[_0x2ec609(0x16e)],_0x402df8=_0x2e09a3['settings'];if(!_0x402df8?.[_0x2ec609(0x168)]){console[_0x2ec609(0x15e)](_0x2ec609(0x1a1)+_0x2e09a3['id']);return;}const _0x1c8453=_0x171178===_0x2ec609(0x1a6)?_0x2ec609(0x1b4):_0x2ec609(0x174);console[_0x2ec609(0x15e)](_0x2ec609(0x1d7)+_0x1c8453+',\x20webhookUrl='+(_0x402df8[_0x2ec609(0x168)]?_0x2ec609(0x15c):_0x2ec609(0x197)));let _0x18adb3=[];if(_0x402df8[_0x2ec609(0x177)])try{_0x18adb3=Array[_0x2ec609(0x1ad)](_0x402df8['webhookEvents'])?_0x402df8[_0x2ec609(0x177)]:JSON[_0x2ec609(0x1c4)](_0x402df8[_0x2ec609(0x177)]);}catch(_0x4393b8){console[_0x2ec609(0x1ac)](_0x2ec609(0x1c5),_0x4393b8),_0x18adb3=[];}console[_0x2ec609(0x15e)](_0x2ec609(0x1d0),_0x18adb3);if(!_0x18adb3[_0x2ec609(0x1a8)](_0x1c8453)){console['log'](_0x2ec609(0x159)+_0x1c8453+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2e09a3['id']);return;}const _0x55742b={'event':_0x1c8453,'payment':{'id':_0x723efb['id'],'order_id':_0x723efb[_0x2ec609(0x1a0)],'gateway_order_id':_0x723efb[_0x2ec609(0x1ca)],'gateway':_0x2ec609(0x1c6),'amount':_0x723efb['amount'],'currency':_0x723efb['currency'],'status':_0x171178[_0x2ec609(0x19b)](),'customer_email':_0x723efb[_0x2ec609(0x175)],'customer_name':_0x723efb[_0x2ec609(0x160)],'transaction_id':_0x5347a6,'failure_message':_0x49e45c,'created_at':_0x723efb[_0x2ec609(0x15f)],'updated_at':new Date()}};console[_0x2ec609(0x15e)]('ðŸ§ª\x20Sending\x20webhook\x20to\x20'+_0x402df8[_0x2ec609(0x168)]+_0x2ec609(0x199)),console[_0x2ec609(0x15e)](_0x2ec609(0x16f),JSON[_0x2ec609(0x176)](_0x55742b,null,0x2));const _0xc32049=JSON[_0x2ec609(0x176)](_0x55742b),_0x561cd8=crypto_1[_0x2ec609(0x196)][_0x2ec609(0x1c0)](_0x2ec609(0x1a7),_0x2e09a3[_0x2ec609(0x18e)])[_0x2ec609(0x1bd)](_0xc32049)[_0x2ec609(0x171)](_0x2ec609(0x1b6)),_0x2838f1=await fetch(_0x402df8['webhookUrl'],{'method':_0x2ec609(0x1a5),'headers':{'Content-Type':_0x2ec609(0x19f),'User-Agent':_0x2ec609(0x188),'X-Webhook-Signature':_0x561cd8},'body':_0xc32049}),_0x3f328b=Date[_0x2ec609(0x183)]()-_0x325c89;console['log'](_0x2ec609(0x155)+_0x402df8[_0x2ec609(0x168)]+_0x2ec609(0x16d)+_0x2838f1['status']+'\x20('+_0x3f328b+_0x2ec609(0x1d4));}catch(_0x557d33){console[_0x2ec609(0x1ac)](_0x2ec609(0x18f),_0x557d33);}}async[a21_0x4972ed(0x1cc)](_0x5cbb89,_0x2949fc){const _0x2af06c=a21_0x4972ed;try{const {telegramBotService:_0x4dc670}=await Promise[_0x2af06c(0x17d)]()[_0x2af06c(0x1bb)](()=>__importStar(require('../services/telegramBotService'))),_0x418251={'PAID':_0x2af06c(0x165),'FAILED':'failed'},_0x3372a4=_0x418251[_0x2949fc];if(!_0x3372a4)return;await _0x4dc670[_0x2af06c(0x1db)](_0x5cbb89[_0x2af06c(0x19c)],_0x5cbb89,_0x3372a4);}catch(_0x5a21e2){console[_0x2af06c(0x1ac)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5a21e2);}}}exports['TestGatewayController']=TestGatewayController;