'use strict';const a13_0x64f45c=a13_0x124c;(function(_0x19964b,_0x491091){const _0x33bb5b=a13_0x124c,_0x16ee18=_0x19964b();while(!![]){try{const _0xc8a178=parseInt(_0x33bb5b(0x1c1))/0x1*(-parseInt(_0x33bb5b(0x1cc))/0x2)+parseInt(_0x33bb5b(0x1a9))/0x3*(parseInt(_0x33bb5b(0x195))/0x4)+-parseInt(_0x33bb5b(0x1d7))/0x5+parseInt(_0x33bb5b(0x1d6))/0x6*(-parseInt(_0x33bb5b(0x1ca))/0x7)+-parseInt(_0x33bb5b(0x1a3))/0x8+parseInt(_0x33bb5b(0x199))/0x9+parseInt(_0x33bb5b(0x1ea))/0xa;if(_0xc8a178===_0x491091)break;else _0x16ee18['push'](_0x16ee18['shift']());}catch(_0x4fa366){_0x16ee18['push'](_0x16ee18['shift']());}}}(a13_0x46a0,0x4db15));var __createBinding=this&&this[a13_0x64f45c(0x1db)]||(Object[a13_0x64f45c(0x1c3)]?function(_0x2afed9,_0x41fc98,_0x149f66,_0x16ac9b){const _0x2b4685=a13_0x64f45c;if(_0x16ac9b===undefined)_0x16ac9b=_0x149f66;var _0x4e16c5=Object[_0x2b4685(0x1aa)](_0x41fc98,_0x149f66);(!_0x4e16c5||(_0x2b4685(0x1e2)in _0x4e16c5?!_0x41fc98['__esModule']:_0x4e16c5[_0x2b4685(0x1c8)]||_0x4e16c5[_0x2b4685(0x1cb)]))&&(_0x4e16c5={'enumerable':!![],'get':function(){return _0x41fc98[_0x149f66];}}),Object[_0x2b4685(0x196)](_0x2afed9,_0x16ac9b,_0x4e16c5);}:function(_0x425d5c,_0x32fd95,_0x26234a,_0x37b174){if(_0x37b174===undefined)_0x37b174=_0x26234a;_0x425d5c[_0x37b174]=_0x32fd95[_0x26234a];}),__setModuleDefault=this&&this[a13_0x64f45c(0x1ac)]||(Object[a13_0x64f45c(0x1c3)]?function(_0x37b158,_0x568d9d){const _0x3eac51=a13_0x64f45c;Object[_0x3eac51(0x196)](_0x37b158,'default',{'enumerable':!![],'value':_0x568d9d});}:function(_0x26d8eb,_0x46f23d){const _0x196547=a13_0x64f45c;_0x26d8eb[_0x196547(0x1c6)]=_0x46f23d;}),__importStar=this&&this['__importStar']||(function(){var _0xc808be=function(_0x37d128){const _0x36b578=a13_0x124c;return _0xc808be=Object[_0x36b578(0x1a7)]||function(_0x218024){const _0x3b1385=_0x36b578;var _0xda4270=[];for(var _0x4e05c1 in _0x218024)if(Object[_0x3b1385(0x1c4)][_0x3b1385(0x1ab)][_0x3b1385(0x1da)](_0x218024,_0x4e05c1))_0xda4270[_0xda4270[_0x3b1385(0x1be)]]=_0x4e05c1;return _0xda4270;},_0xc808be(_0x37d128);};return function(_0x450e05){const _0x16a8aa=a13_0x124c;if(_0x450e05&&_0x450e05[_0x16a8aa(0x1b5)])return _0x450e05;var _0x34b734={};if(_0x450e05!=null){for(var _0x4c6ca0=_0xc808be(_0x450e05),_0x148d4c=0x0;_0x148d4c<_0x4c6ca0[_0x16a8aa(0x1be)];_0x148d4c++)if(_0x4c6ca0[_0x148d4c]!==_0x16a8aa(0x1c6))__createBinding(_0x34b734,_0x450e05,_0x4c6ca0[_0x148d4c]);}return __setModuleDefault(_0x34b734,_0x450e05),_0x34b734;};}()),__importDefault=this&&this['__importDefault']||function(_0x4f6909){const _0x3bcb16=a13_0x64f45c;return _0x4f6909&&_0x4f6909[_0x3bcb16(0x1b5)]?_0x4f6909:{'default':_0x4f6909};};Object[a13_0x64f45c(0x196)](exports,'__esModule',{'value':!![]}),exports[a13_0x64f45c(0x1d1)]=void 0x0;const testGatewayService_1=require(a13_0x64f45c(0x18e)),webhookService_1=require(a13_0x64f45c(0x1ef)),database_1=__importDefault(require(a13_0x64f45c(0x1a6)));function a13_0x124c(_0x3b3eb4,_0x351539){const _0x46a048=a13_0x46a0();return a13_0x124c=function(_0x124c38,_0x3c418c){_0x124c38=_0x124c38-0x189;let _0x2bf6c5=_0x46a048[_0x124c38];return _0x2bf6c5;},a13_0x124c(_0x3b3eb4,_0x351539);}class TestGatewayController{constructor(){const _0x54d1d5=a13_0x64f45c;this[_0x54d1d5(0x1e3)]=async(_0x337b8d,_0x5b2bef,_0x46504c)=>{const _0x2188b0=_0x54d1d5;try{const {paymentId:_0x494dbc}=_0x337b8d[_0x2188b0(0x1ed)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x494dbc);const _0x38cc1d=await database_1['default'][_0x2188b0(0x18d)]['findUnique']({'where':{'id':_0x494dbc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x38cc1d)return _0x5b2bef[_0x2188b0(0x1eb)](0x194)[_0x2188b0(0x198)]({'success':![],'message':_0x2188b0(0x1e1)});if(_0x38cc1d[_0x2188b0(0x1b1)]!=='test_gateway')return _0x5b2bef['status'](0x190)[_0x2188b0(0x198)]({'success':![],'message':_0x2188b0(0x18c)});if(_0x38cc1d[_0x2188b0(0x1eb)]!==_0x2188b0(0x18f))return _0x5b2bef[_0x2188b0(0x1eb)](0x190)[_0x2188b0(0x198)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x38cc1d[_0x2188b0(0x1eb)]+_0x2188b0(0x1d3)});_0x5b2bef[_0x2188b0(0x198)]({'success':!![],'result':{'paymentId':_0x38cc1d['id'],'orderId':_0x38cc1d['gatewayOrderId'],'amount':_0x38cc1d['amount'],'currency':_0x38cc1d['currency'],'merchantName':_0x38cc1d[_0x2188b0(0x1b0)][_0x2188b0(0x1b7)],'description':_0x2188b0(0x1b6)+_0x38cc1d[_0x2188b0(0x1b0)]['name'],'testInstructions':{'successCard':_0x2188b0(0x190),'failureCard':_0x2188b0(0x1e8),'expiryDate':_0x2188b0(0x1b8),'cvc':_0x2188b0(0x1d8),'holderName':_0x2188b0(0x19c)}}});}catch(_0x16e574){_0x46504c(_0x16e574);}},this[_0x54d1d5(0x1b9)]=async(_0x53fc3d,_0xe77408,_0x2d8d1d)=>{const _0x20fac1=_0x54d1d5;try{const {paymentId:_0x3981ef}=_0x53fc3d[_0x20fac1(0x1ed)],_0x6d7d25=_0x53fc3d[_0x20fac1(0x1ce)];console[_0x20fac1(0x1dd)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3981ef);const _0x34e70c=await database_1[_0x20fac1(0x1c6)][_0x20fac1(0x18d)]['findUnique']({'where':{'id':_0x3981ef},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34e70c)return _0xe77408['status'](0x194)['json']({'success':![],'message':_0x20fac1(0x1e1)});if(_0x34e70c[_0x20fac1(0x1b1)]!==_0x20fac1(0x1b2))return _0xe77408['status'](0x190)[_0x20fac1(0x198)]({'success':![],'message':_0x20fac1(0x18c)});if(_0x34e70c[_0x20fac1(0x1eb)]!==_0x20fac1(0x18f))return _0xe77408['status'](0x190)[_0x20fac1(0x198)]({'success':![],'message':_0x20fac1(0x1bc)+_0x34e70c[_0x20fac1(0x1eb)]+_0x20fac1(0x1d3)});const _0x1b62f7=await this['testGatewayService'][_0x20fac1(0x1e5)]({'paymentId':_0x34e70c['id'],'orderId':_0x34e70c[_0x20fac1(0x1de)]||_0x34e70c['id'],'amount':_0x34e70c[_0x20fac1(0x1a1)],'currency':_0x34e70c[_0x20fac1(0x1bf)],'cardData':_0x6d7d25});console['log'](_0x20fac1(0x1e9),_0x1b62f7);const _0x37287c={'status':_0x1b62f7['status'],'updatedAt':new Date()};if(_0x1b62f7[_0x20fac1(0x1eb)]===_0x20fac1(0x1f1))_0x37287c['paidAt']=new Date(),_0x37287c['gatewayPaymentId']=_0x1b62f7[_0x20fac1(0x1c9)];else _0x1b62f7['status']==='FAILED'&&(_0x37287c[_0x20fac1(0x1a2)]=_0x1b62f7[_0x20fac1(0x1cd)]);const _0x23cf02=_0x6d7d25[_0x20fac1(0x1a4)]['replace'](/[\s-]/g,'');_0x37287c[_0x20fac1(0x1ec)]=_0x23cf02['slice'](-0x4),_0x37287c[_0x20fac1(0x1d0)]=_0x20fac1(0x1ee),await database_1[_0x20fac1(0x1c6)][_0x20fac1(0x18d)]['update']({'where':{'id':_0x34e70c['id']},'data':_0x37287c}),await database_1[_0x20fac1(0x1c6)][_0x20fac1(0x1ae)][_0x20fac1(0x1c3)]({'data':{'paymentId':_0x34e70c['id'],'shopId':_0x34e70c['shopId'],'event':_0x20fac1(0x1af)+_0x1b62f7[_0x20fac1(0x1eb)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x20fac1(0x19a)]({'oldStatus':'PENDING','newStatus':_0x1b62f7['status'],'transactionId':_0x1b62f7[_0x20fac1(0x1c9)],'failureReason':_0x1b62f7[_0x20fac1(0x1cd)],'processedAt':new Date()[_0x20fac1(0x18b)]()})}}),await this['sendShopWebhook'](_0x34e70c,_0x1b62f7[_0x20fac1(0x1eb)],_0x1b62f7[_0x20fac1(0x1c9)],_0x1b62f7[_0x20fac1(0x1cd)]),await this[_0x20fac1(0x197)](_0x34e70c,_0x1b62f7[_0x20fac1(0x1eb)]),console[_0x20fac1(0x1dd)](_0x20fac1(0x19f)+_0x3981ef+_0x20fac1(0x1f0)+_0x1b62f7['status']),_0x1b62f7[_0x20fac1(0x1eb)]===_0x20fac1(0x1f1)?_0xe77408[_0x20fac1(0x198)]({'success':!![],'message':_0x20fac1(0x1c2),'result':{'status':'PAID','transactionId':_0x1b62f7[_0x20fac1(0x1c9)],'redirectUrl':_0x34e70c[_0x20fac1(0x1bd)]}}):_0xe77408[_0x20fac1(0x1eb)](0x190)[_0x20fac1(0x198)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x20fac1(0x1c5),'failureReason':_0x1b62f7[_0x20fac1(0x1cd)],'redirectUrl':_0x34e70c['failUrl']}});}catch(_0x353857){_0x2d8d1d(_0x353857);}},this[_0x54d1d5(0x1e6)]=new testGatewayService_1[(_0x54d1d5(0x1dc))](),this[_0x54d1d5(0x1d2)]=new webhookService_1[(_0x54d1d5(0x1f2))]();}async[a13_0x64f45c(0x1d9)](_0x567fa3,_0x439d16,_0x580faf,_0x443622){const _0x3eca42=a13_0x64f45c,_0x265010=Date['now']();try{const _0x5d8323=_0x567fa3[_0x3eca42(0x1b0)],_0x4f3d73=_0x5d8323['settings'];if(!_0x4f3d73?.[_0x3eca42(0x1a5)]){console[_0x3eca42(0x1dd)](_0x3eca42(0x1b3)+_0x5d8323['id']);return;}const _0x20a86b=_0x439d16===_0x3eca42(0x1f1)?_0x3eca42(0x1bb):_0x3eca42(0x1ad);let _0x18557a=[];if(_0x4f3d73['webhookEvents'])try{_0x18557a=Array['isArray'](_0x4f3d73['webhookEvents'])?_0x4f3d73[_0x3eca42(0x1c0)]:JSON[_0x3eca42(0x1e4)](_0x4f3d73[_0x3eca42(0x1c0)]);}catch(_0x27900d){console['error']('Error\x20parsing\x20webhook\x20events:',_0x27900d),_0x18557a=[];}if(!_0x18557a['includes'](_0x20a86b)){console[_0x3eca42(0x1dd)](_0x3eca42(0x194)+_0x20a86b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5d8323['id']);return;}const _0x49c5c3={'event':_0x20a86b,'payment':{'id':_0x567fa3['id'],'order_id':_0x567fa3[_0x3eca42(0x1b4)],'gateway_order_id':_0x567fa3[_0x3eca42(0x1de)],'gateway':_0x3eca42(0x1d4),'amount':_0x567fa3['amount'],'currency':_0x567fa3[_0x3eca42(0x1bf)],'status':_0x439d16[_0x3eca42(0x1cf)](),'customer_email':_0x567fa3[_0x3eca42(0x189)],'customer_name':_0x567fa3[_0x3eca42(0x1a0)],'transaction_id':_0x580faf,'failure_message':_0x443622,'created_at':_0x567fa3['createdAt'],'updated_at':new Date()}},_0x5b922a=await fetch(_0x4f3d73['webhookUrl'],{'method':_0x3eca42(0x1e0),'headers':{'Content-Type':_0x3eca42(0x1a8),'User-Agent':_0x3eca42(0x192)},'body':JSON[_0x3eca42(0x19a)](_0x49c5c3)}),_0x35bbd8=Date[_0x3eca42(0x1df)]()-_0x265010;console[_0x3eca42(0x1dd)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x4f3d73[_0x3eca42(0x1a5)]+'\x20with\x20status\x20'+_0x5b922a[_0x3eca42(0x1eb)]+'\x20('+_0x35bbd8+_0x3eca42(0x1d5));}catch(_0x1d3581){console[_0x3eca42(0x1c7)](_0x3eca42(0x19b),_0x1d3581);}}async[a13_0x64f45c(0x197)](_0x635a72,_0x425dd1){const _0x378268=a13_0x64f45c;try{const {telegramBotService:_0x295e95}=await Promise['resolve']()[_0x378268(0x18a)](()=>__importStar(require(_0x378268(0x1e7)))),_0x1b87dd={'PAID':_0x378268(0x191),'FAILED':_0x378268(0x19d)},_0x5addf8=_0x1b87dd[_0x425dd1];if(!_0x5addf8)return;await _0x295e95[_0x378268(0x193)](_0x635a72[_0x378268(0x19e)],_0x635a72,_0x5addf8);}catch(_0x3ff2f6){console[_0x378268(0x1c7)](_0x378268(0x1ba),_0x3ff2f6);}}}function a13_0x46a0(){const _0x205158=['42308lHTujo','configurable','10XYDqgq','failureReason','body','toLowerCase','paymentMethod','TestGatewayController','webhookService',',\x20cannot\x20process','0000','ms)','12XLQjEE','2151000YAjYQm','Any\x203-4\x20digits','sendShopWebhook','call','__createBinding','TestGatewayService','log','gatewayOrderId','now','POST','Payment\x20not\x20found','get','getPaymentForm','parse','processCardPayment','testGatewayService','../services/telegramBotService','Any\x20other\x20card\x20number','ðŸ§ª\x20Test\x20Gateway\x20result:','10240430kDfonk','status','cardLast4','params','test_card','../services/webhookService','\x20processed:\x20','PAID','WebhookService','customerEmail','then','toISOString','Payment\x20is\x20not\x20for\x20test\x20gateway','payment','../services/gateways/testGatewayService','PENDING','4242\x204242\x204242\x204242','paid','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','sendPaymentNotification','Webhook\x20event\x20','276DcGxqc','defineProperty','sendPaymentStatusNotification','json','141219JffxdM','stringify','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Any\x20name','failed','shopId','âœ…\x20Test\x20Gateway\x20payment\x20','customerName','amount','failureMessage','3354120lKQXiB','cardNumber','webhookUrl','../config/database','getOwnPropertyNames','application/json','23931IvTkTz','getOwnPropertyDescriptor','hasOwnProperty','__setModuleDefault','payment.failed','webhookLog','test_gateway_','shop','gateway','test_gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','orderId','__esModule','Payment\x20to\x20','name','Any\x20future\x20date\x20(MM/YY)','processCard','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.success','Payment\x20status\x20is\x20','successUrl','length','currency','webhookEvents','82073jAegvH','Payment\x20processed\x20successfully','create','prototype','FAILED','default','error','writable','transactionId'];a13_0x46a0=function(){return _0x205158;};return a13_0x46a0();}exports[a13_0x64f45c(0x1d1)]=TestGatewayController;