'use strict';const a18_0xa37a91=a18_0x1668;(function(_0x57a43c,_0x9ba9e7){const _0x1aea6a=a18_0x1668,_0x1e7dcb=_0x57a43c();while(!![]){try{const _0x371b77=parseInt(_0x1aea6a(0x181))/0x1+parseInt(_0x1aea6a(0x19e))/0x2*(parseInt(_0x1aea6a(0x1c6))/0x3)+-parseInt(_0x1aea6a(0x183))/0x4*(parseInt(_0x1aea6a(0x187))/0x5)+-parseInt(_0x1aea6a(0x16b))/0x6*(parseInt(_0x1aea6a(0x1a7))/0x7)+parseInt(_0x1aea6a(0x1aa))/0x8+parseInt(_0x1aea6a(0x1cd))/0x9+-parseInt(_0x1aea6a(0x1af))/0xa;if(_0x371b77===_0x9ba9e7)break;else _0x1e7dcb['push'](_0x1e7dcb['shift']());}catch(_0x222f41){_0x1e7dcb['push'](_0x1e7dcb['shift']());}}}(a18_0x555a,0xb2d7e));function a18_0x555a(){const _0x84b22e=['No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','params','\x20->\x20','\x20updated:\x20currentPayments=','getOwnPropertyDescriptor','\x20with\x20status\x20','WebhookService','üìà\x20Found\x20payment\x20link\x20','__esModule','\x20not\x20enabled\x20for\x20shop\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','6TAcigN','Any\x20other\x20card\x20number','Any\x203-4\x20digits','payment','customerName','settings','test_gateway','test_card','now','__createBinding','paymentLink','paid','Payment\x20not\x20found','resolve','Payment\x20to\x20','currentPayments','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','toLowerCase','default','getPaymentForm','../services/webhookService','prototype','1463834LOJWMY','length','51148GszXXA','POST','currency','status','355zPfjlV','cardNumber','type','name','webhookEvents','body','Any\x20future\x20date\x20(MM/YY)','test_gateway_','paymentLinkId','payment.failed','log','0000','Payment\x20System/1.0\x20(Test\x20Gateway)','üß™\x20Test\x20Gateway\x20result:','paidAt','../services/gateways/testGatewayService','toISOString','configurable','shopId','orderId','Payment\x20processed\x20successfully','../services/telegramBotService','‚úÖ\x20Test\x20Gateway\x20payment\x20','368716HAvwIY','Error\x20parsing\x20webhook\x20events:','call','webhookService','webhookUrl',',\x20status=','json','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','get','9853109ywkygD','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','customerEmail','8545232pqGPmd','processCard','PAID','getOwnPropertyNames','error','9700220zGiehT','‚ùå\x20Payment\x20link\x20','findUnique','Payment\x20is\x20not\x20for\x20test\x20gateway','processCardPayment',',\x20cannot\x20process','defineProperty','\x20processed:\x20','../config/database','amount','update','transactionId','create','successUrl','webhookLog','‚úÖ\x20Payment\x20link\x20','testGatewayService','4242\x204242\x204242\x204242','TestGatewayController','TestGatewayService','stringify','Payment\x20status\x20is\x20','PENDING','6yHRIuH','gatewayOrderId','failureMessage','failureReason','then','gateway','createdAt','10055916vmpnzv','cardLast4','ms)','payment.success','writable','gatewayPaymentId','sendShopWebhook','FAILED','sendPaymentStatusNotification','__importStar','shop','parse',',\x20currentPayments=','üìà\x20Test\x20Gateway:\x20Payment\x20','$transaction','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:'];a18_0x555a=function(){return _0x84b22e;};return a18_0x555a();}var __createBinding=this&&this[a18_0xa37a91(0x174)]||(Object[a18_0xa37a91(0x1bb)]?function(_0x936cf1,_0x408371,_0x9b6d7a,_0x56b55e){const _0x2a24ee=a18_0xa37a91;if(_0x56b55e===undefined)_0x56b55e=_0x9b6d7a;var _0x1ed9f4=Object[_0x2a24ee(0x1e1)](_0x408371,_0x9b6d7a);(!_0x1ed9f4||(_0x2a24ee(0x1a6)in _0x1ed9f4?!_0x408371[_0x2a24ee(0x1e5)]:_0x1ed9f4[_0x2a24ee(0x1d1)]||_0x1ed9f4[_0x2a24ee(0x198)]))&&(_0x1ed9f4={'enumerable':!![],'get':function(){return _0x408371[_0x9b6d7a];}}),Object[_0x2a24ee(0x1b5)](_0x936cf1,_0x56b55e,_0x1ed9f4);}:function(_0x1a6b8b,_0x4afe42,_0x212ac4,_0x46ee48){if(_0x46ee48===undefined)_0x46ee48=_0x212ac4;_0x1a6b8b[_0x46ee48]=_0x4afe42[_0x212ac4];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a18_0xa37a91(0x1bb)]?function(_0x3d35c1,_0x32004a){const _0x5eb5de=a18_0xa37a91;Object[_0x5eb5de(0x1b5)](_0x3d35c1,_0x5eb5de(0x17d),{'enumerable':!![],'value':_0x32004a});}:function(_0x45dc4e,_0x21a071){const _0x4df402=a18_0xa37a91;_0x45dc4e[_0x4df402(0x17d)]=_0x21a071;}),__importStar=this&&this[a18_0xa37a91(0x1d6)]||(function(){var _0x57a5b0=function(_0x5e525e){const _0x127b5b=a18_0x1668;return _0x57a5b0=Object[_0x127b5b(0x1ad)]||function(_0x43a495){const _0x4f6591=_0x127b5b;var _0x573a13=[];for(var _0x1c1689 in _0x43a495)if(Object[_0x4f6591(0x180)]['hasOwnProperty'][_0x4f6591(0x1a0)](_0x43a495,_0x1c1689))_0x573a13[_0x573a13['length']]=_0x1c1689;return _0x573a13;},_0x57a5b0(_0x5e525e);};return function(_0x9161b1){const _0x5e2050=a18_0x1668;if(_0x9161b1&&_0x9161b1[_0x5e2050(0x1e5)])return _0x9161b1;var _0x1f72d7={};if(_0x9161b1!=null){for(var _0x4dcb93=_0x57a5b0(_0x9161b1),_0x3b4871=0x0;_0x3b4871<_0x4dcb93[_0x5e2050(0x182)];_0x3b4871++)if(_0x4dcb93[_0x3b4871]!=='default')__createBinding(_0x1f72d7,_0x9161b1,_0x4dcb93[_0x3b4871]);}return __setModuleDefault(_0x1f72d7,_0x9161b1),_0x1f72d7;};}()),__importDefault=this&&this['__importDefault']||function(_0x802c3e){const _0x5aa109=a18_0xa37a91;return _0x802c3e&&_0x802c3e[_0x5aa109(0x1e5)]?_0x802c3e:{'default':_0x802c3e};};Object[a18_0xa37a91(0x1b5)](exports,a18_0xa37a91(0x1e5),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a18_0xa37a91(0x196)),webhookService_1=require(a18_0xa37a91(0x17f)),database_1=__importDefault(require(a18_0xa37a91(0x1b7)));class TestGatewayController{constructor(){const _0x159988=a18_0xa37a91;this[_0x159988(0x17e)]=async(_0xcbb796,_0x485209,_0x3d89f0)=>{const _0xfb5097=_0x159988;try{const {paymentId:_0x2848e8}=_0xcbb796['params'];console[_0xfb5097(0x191)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2848e8);const _0x361f41=await database_1[_0xfb5097(0x17d)][_0xfb5097(0x16e)][_0xfb5097(0x1b1)]({'where':{'id':_0x2848e8},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x361f41)return _0x485209[_0xfb5097(0x186)](0x194)[_0xfb5097(0x1a4)]({'success':![],'message':_0xfb5097(0x177)});if(_0x361f41[_0xfb5097(0x1cb)]!==_0xfb5097(0x171))return _0x485209[_0xfb5097(0x186)](0x190)[_0xfb5097(0x1a4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x361f41['status']!==_0xfb5097(0x1c5))return _0x485209[_0xfb5097(0x186)](0x190)['json']({'success':![],'message':_0xfb5097(0x1c4)+_0x361f41[_0xfb5097(0x186)]+_0xfb5097(0x1b4)});_0x485209[_0xfb5097(0x1a4)]({'success':!![],'result':{'paymentId':_0x361f41['id'],'orderId':_0x361f41['gatewayOrderId'],'amount':_0x361f41[_0xfb5097(0x1b8)],'currency':_0x361f41[_0xfb5097(0x185)],'merchantName':_0x361f41[_0xfb5097(0x1d7)]['name'],'description':_0xfb5097(0x179)+_0x361f41[_0xfb5097(0x1d7)][_0xfb5097(0x18a)],'testInstructions':{'successCard':_0xfb5097(0x1c0),'failureCard':_0xfb5097(0x16c),'expiryDate':_0xfb5097(0x18d),'cvc':_0xfb5097(0x16d),'holderName':'Any\x20name'}}});}catch(_0x54f5f0){_0x3d89f0(_0x54f5f0);}},this[_0x159988(0x1ab)]=async(_0x34e296,_0x3ff388,_0x5131d6)=>{const _0x39b34c=_0x159988;try{const {paymentId:_0x5ee640}=_0x34e296[_0x39b34c(0x1de)],_0x310bcb=_0x34e296[_0x39b34c(0x18c)];console[_0x39b34c(0x191)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x5ee640);const _0x1a9cc9=await database_1[_0x39b34c(0x17d)][_0x39b34c(0x16e)][_0x39b34c(0x1b1)]({'where':{'id':_0x5ee640},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1a9cc9)return _0x3ff388[_0x39b34c(0x186)](0x194)[_0x39b34c(0x1a4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1a9cc9[_0x39b34c(0x1cb)]!==_0x39b34c(0x171))return _0x3ff388[_0x39b34c(0x186)](0x190)['json']({'success':![],'message':_0x39b34c(0x1b2)});if(_0x1a9cc9['status']!==_0x39b34c(0x1c5))return _0x3ff388[_0x39b34c(0x186)](0x190)[_0x39b34c(0x1a4)]({'success':![],'message':_0x39b34c(0x1c4)+_0x1a9cc9['status']+_0x39b34c(0x1b4)});const _0x3f9b1d=await this[_0x39b34c(0x1bf)][_0x39b34c(0x1b3)]({'paymentId':_0x1a9cc9['id'],'orderId':_0x1a9cc9[_0x39b34c(0x1c7)]||_0x1a9cc9['id'],'amount':_0x1a9cc9[_0x39b34c(0x1b8)],'currency':_0x1a9cc9[_0x39b34c(0x185)],'cardData':_0x310bcb});console['log'](_0x39b34c(0x194),_0x3f9b1d);const _0x2a5ef1={'status':_0x3f9b1d[_0x39b34c(0x186)],'updatedAt':new Date()};if(_0x3f9b1d['status']===_0x39b34c(0x1ac))_0x2a5ef1[_0x39b34c(0x195)]=new Date(),_0x2a5ef1[_0x39b34c(0x1d2)]=_0x3f9b1d[_0x39b34c(0x1ba)];else _0x3f9b1d['status']==='FAILED'&&(_0x2a5ef1[_0x39b34c(0x1c8)]=_0x3f9b1d[_0x39b34c(0x1c9)]);const _0x577e94=_0x310bcb[_0x39b34c(0x188)]['replace'](/[\s-]/g,'');_0x2a5ef1[_0x39b34c(0x1ce)]=_0x577e94['slice'](-0x4),_0x2a5ef1['paymentMethod']=_0x39b34c(0x172),await database_1[_0x39b34c(0x17d)][_0x39b34c(0x16e)]['update']({'where':{'id':_0x1a9cc9['id']},'data':_0x2a5ef1});if(_0x3f9b1d[_0x39b34c(0x186)]===_0x39b34c(0x1ac)&&_0x1a9cc9[_0x39b34c(0x18f)]){console[_0x39b34c(0x191)](_0x39b34c(0x1da)+_0x1a9cc9['id']+_0x39b34c(0x17b));try{await database_1[_0x39b34c(0x17d)][_0x39b34c(0x1db)](async _0x1eb33c=>{const _0x47c3c0=_0x39b34c,_0x49eabc=await _0x1eb33c[_0x47c3c0(0x175)][_0x47c3c0(0x1b1)]({'where':{'id':_0x1a9cc9[_0x47c3c0(0x18f)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x49eabc){console['log'](_0x47c3c0(0x1e4)+_0x49eabc['id']+':\x20type='+_0x49eabc[_0x47c3c0(0x189)]+_0x47c3c0(0x1d9)+_0x49eabc[_0x47c3c0(0x17a)]+_0x47c3c0(0x1a3)+_0x49eabc[_0x47c3c0(0x186)]);const _0xe73af8=_0x49eabc[_0x47c3c0(0x17a)]+0x1,_0x4f6e88=_0x49eabc['type']==='SINGLE'?'COMPLETED':_0x49eabc[_0x47c3c0(0x186)];await _0x1eb33c['paymentLink'][_0x47c3c0(0x1b9)]({'where':{'id':_0x1a9cc9[_0x47c3c0(0x18f)]},'data':{'currentPayments':_0xe73af8,'status':_0x4f6e88,'updatedAt':new Date()}}),console[_0x47c3c0(0x191)](_0x47c3c0(0x1be)+_0x49eabc['id']+_0x47c3c0(0x1e0)+_0x49eabc[_0x47c3c0(0x17a)]+_0x47c3c0(0x1df)+_0xe73af8+_0x47c3c0(0x1a3)+_0x49eabc[_0x47c3c0(0x186)]+_0x47c3c0(0x1df)+_0x4f6e88);}else console[_0x47c3c0(0x191)](_0x47c3c0(0x1b0)+_0x1a9cc9['paymentLinkId']+'\x20not\x20found');});}catch(_0x2c3a44){console['error'](_0x39b34c(0x1dc),_0x2c3a44);}}await database_1['default'][_0x39b34c(0x1bd)][_0x39b34c(0x1bb)]({'data':{'paymentId':_0x1a9cc9['id'],'shopId':_0x1a9cc9[_0x39b34c(0x199)],'event':_0x39b34c(0x18e)+_0x3f9b1d['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x39b34c(0x1c3)]({'oldStatus':'PENDING','newStatus':_0x3f9b1d[_0x39b34c(0x186)],'transactionId':_0x3f9b1d[_0x39b34c(0x1ba)],'failureReason':_0x3f9b1d[_0x39b34c(0x1c9)],'processedAt':new Date()[_0x39b34c(0x197)]()})}}),await this['sendShopWebhook'](_0x1a9cc9,_0x3f9b1d[_0x39b34c(0x186)],_0x3f9b1d[_0x39b34c(0x1ba)],_0x3f9b1d[_0x39b34c(0x1c9)]),await this[_0x39b34c(0x1d5)](_0x1a9cc9,_0x3f9b1d['status']),console[_0x39b34c(0x191)](_0x39b34c(0x19d)+_0x5ee640+_0x39b34c(0x1b6)+_0x3f9b1d['status']),_0x3f9b1d[_0x39b34c(0x186)]==='PAID'?_0x3ff388['json']({'success':!![],'message':_0x39b34c(0x19b),'result':{'status':_0x39b34c(0x1ac),'transactionId':_0x3f9b1d[_0x39b34c(0x1ba)],'redirectUrl':_0x1a9cc9[_0x39b34c(0x1bc)]}}):_0x3ff388[_0x39b34c(0x186)](0x190)[_0x39b34c(0x1a4)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x39b34c(0x1d4),'failureReason':_0x3f9b1d[_0x39b34c(0x1c9)],'redirectUrl':_0x1a9cc9['failUrl']}});}catch(_0x33ebff){_0x5131d6(_0x33ebff);}},this[_0x159988(0x1bf)]=new testGatewayService_1[(_0x159988(0x1c2))](),this[_0x159988(0x1a1)]=new webhookService_1[(_0x159988(0x1e3))]();}async[a18_0xa37a91(0x1d3)](_0x1cf2c8,_0x5696a2,_0x379d8,_0x4b5158){const _0xc6d78a=a18_0xa37a91,_0x5e4c68=Date['now']();try{const _0x53dc98=_0x1cf2c8[_0xc6d78a(0x1d7)],_0x56ada8=_0x53dc98[_0xc6d78a(0x170)];if(!_0x56ada8?.[_0xc6d78a(0x1a2)]){console['log'](_0xc6d78a(0x1dd)+_0x53dc98['id']);return;}const _0x1ab116=_0x5696a2===_0xc6d78a(0x1ac)?_0xc6d78a(0x1d0):_0xc6d78a(0x190);let _0xc93223=[];if(_0x56ada8[_0xc6d78a(0x18b)])try{_0xc93223=Array['isArray'](_0x56ada8[_0xc6d78a(0x18b)])?_0x56ada8['webhookEvents']:JSON[_0xc6d78a(0x1d8)](_0x56ada8[_0xc6d78a(0x18b)]);}catch(_0xbc5182){console['error'](_0xc6d78a(0x19f),_0xbc5182),_0xc93223=[];}if(!_0xc93223['includes'](_0x1ab116)){console['log']('Webhook\x20event\x20'+_0x1ab116+_0xc6d78a(0x169)+_0x53dc98['id']);return;}const _0x20a24e={'event':_0x1ab116,'payment':{'id':_0x1cf2c8['id'],'order_id':_0x1cf2c8[_0xc6d78a(0x19a)],'gateway_order_id':_0x1cf2c8[_0xc6d78a(0x1c7)],'gateway':_0xc6d78a(0x192),'amount':_0x1cf2c8[_0xc6d78a(0x1b8)],'currency':_0x1cf2c8[_0xc6d78a(0x185)],'status':_0x5696a2[_0xc6d78a(0x17c)](),'customer_email':_0x1cf2c8[_0xc6d78a(0x1a9)],'customer_name':_0x1cf2c8[_0xc6d78a(0x16f)],'transaction_id':_0x379d8,'failure_message':_0x4b5158,'created_at':_0x1cf2c8[_0xc6d78a(0x1cc)],'updated_at':new Date()}},_0x3e20cd=await fetch(_0x56ada8['webhookUrl'],{'method':_0xc6d78a(0x184),'headers':{'Content-Type':'application/json','User-Agent':_0xc6d78a(0x193)},'body':JSON[_0xc6d78a(0x1c3)](_0x20a24e)}),_0x430209=Date[_0xc6d78a(0x173)]()-_0x5e4c68;console['log'](_0xc6d78a(0x16a)+_0x56ada8[_0xc6d78a(0x1a2)]+_0xc6d78a(0x1e2)+_0x3e20cd['status']+'\x20('+_0x430209+_0xc6d78a(0x1cf));}catch(_0xd6e20a){console[_0xc6d78a(0x1ae)](_0xc6d78a(0x1a8),_0xd6e20a);}}async['sendPaymentStatusNotification'](_0x36e3b7,_0x2bee04){const _0x458bfd=a18_0xa37a91;try{const {telegramBotService:_0x9b29a2}=await Promise[_0x458bfd(0x178)]()[_0x458bfd(0x1ca)](()=>__importStar(require(_0x458bfd(0x19c)))),_0x4ee088={'PAID':_0x458bfd(0x176),'FAILED':'failed'},_0x4edc2a=_0x4ee088[_0x2bee04];if(!_0x4edc2a)return;await _0x9b29a2['sendPaymentNotification'](_0x36e3b7[_0x458bfd(0x199)],_0x36e3b7,_0x4edc2a);}catch(_0x236523){console[_0x458bfd(0x1ae)](_0x458bfd(0x1a5),_0x236523);}}}function a18_0x1668(_0x3a3e9e,_0x18b73c){_0x3a3e9e=_0x3a3e9e-0x169;const _0x555aba=a18_0x555a();let _0x16685b=_0x555aba[_0x3a3e9e];return _0x16685b;}exports[a18_0xa37a91(0x1c1)]=TestGatewayController;