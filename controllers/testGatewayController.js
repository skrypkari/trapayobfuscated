'use strict';const a18_0x2b807c=a18_0x3a87;(function(_0x16be83,_0x5940f8){const _0x24260f=a18_0x3a87,_0x1d6c2c=_0x16be83();while(!![]){try{const _0x52fbe3=parseInt(_0x24260f(0x1f7))/0x1*(-parseInt(_0x24260f(0x1f2))/0x2)+-parseInt(_0x24260f(0x228))/0x3*(parseInt(_0x24260f(0x200))/0x4)+parseInt(_0x24260f(0x1bb))/0x5*(parseInt(_0x24260f(0x1fc))/0x6)+parseInt(_0x24260f(0x218))/0x7+parseInt(_0x24260f(0x1f9))/0x8+parseInt(_0x24260f(0x1d6))/0x9*(parseInt(_0x24260f(0x1e9))/0xa)+-parseInt(_0x24260f(0x1bd))/0xb*(parseInt(_0x24260f(0x1f6))/0xc);if(_0x52fbe3===_0x5940f8)break;else _0x1d6c2c['push'](_0x1d6c2c['shift']());}catch(_0x4e1c12){_0x1d6c2c['push'](_0x1d6c2c['shift']());}}}(a18_0x2aee,0xcda9d));var __createBinding=this&&this[a18_0x2b807c(0x222)]||(Object[a18_0x2b807c(0x202)]?function(_0x1a7083,_0x353316,_0x1108c7,_0x26e466){const _0x476d77=a18_0x2b807c;if(_0x26e466===undefined)_0x26e466=_0x1108c7;var _0x41d6e2=Object['getOwnPropertyDescriptor'](_0x353316,_0x1108c7);(!_0x41d6e2||(_0x476d77(0x1cf)in _0x41d6e2?!_0x353316['__esModule']:_0x41d6e2['writable']||_0x41d6e2[_0x476d77(0x208)]))&&(_0x41d6e2={'enumerable':!![],'get':function(){return _0x353316[_0x1108c7];}}),Object[_0x476d77(0x1e8)](_0x1a7083,_0x26e466,_0x41d6e2);}:function(_0x26a8a5,_0x393583,_0x1a1175,_0x5e8840){if(_0x5e8840===undefined)_0x5e8840=_0x1a1175;_0x26a8a5[_0x5e8840]=_0x393583[_0x1a1175];}),__setModuleDefault=this&&this[a18_0x2b807c(0x216)]||(Object[a18_0x2b807c(0x202)]?function(_0x23f01d,_0x988c8a){const _0x18cbf5=a18_0x2b807c;Object['defineProperty'](_0x23f01d,_0x18cbf5(0x1b6),{'enumerable':!![],'value':_0x988c8a});}:function(_0x35eeb5,_0x4e10c6){const _0x19b7f7=a18_0x2b807c;_0x35eeb5[_0x19b7f7(0x1b6)]=_0x4e10c6;}),__importStar=this&&this[a18_0x2b807c(0x1ed)]||(function(){var _0x479af2=function(_0x2105ce){const _0x307357=a18_0x3a87;return _0x479af2=Object[_0x307357(0x1de)]||function(_0x1e6424){const _0x59a2d4=_0x307357;var _0x408e49=[];for(var _0x41be71 in _0x1e6424)if(Object[_0x59a2d4(0x1fa)][_0x59a2d4(0x1c1)][_0x59a2d4(0x224)](_0x1e6424,_0x41be71))_0x408e49[_0x408e49[_0x59a2d4(0x1d8)]]=_0x41be71;return _0x408e49;},_0x479af2(_0x2105ce);};return function(_0x395103){const _0x203b52=a18_0x3a87;if(_0x395103&&_0x395103[_0x203b52(0x207)])return _0x395103;var _0x145e50={};if(_0x395103!=null){for(var _0x10476e=_0x479af2(_0x395103),_0x3c56cf=0x0;_0x3c56cf<_0x10476e[_0x203b52(0x1d8)];_0x3c56cf++)if(_0x10476e[_0x3c56cf]!==_0x203b52(0x1b6))__createBinding(_0x145e50,_0x395103,_0x10476e[_0x3c56cf]);}return __setModuleDefault(_0x145e50,_0x395103),_0x145e50;};}()),__importDefault=this&&this[a18_0x2b807c(0x1dd)]||function(_0x5eb202){const _0x361445=a18_0x2b807c;return _0x5eb202&&_0x5eb202[_0x361445(0x207)]?_0x5eb202:{'default':_0x5eb202};};Object[a18_0x2b807c(0x1e8)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;function a18_0x3a87(_0x16a6fd,_0x4c5f01){_0x16a6fd=_0x16a6fd-0x1b1;const _0x2aee22=a18_0x2aee();let _0x3a8723=_0x2aee22[_0x16a6fd];return _0x3a8723;}const testGatewayService_1=require(a18_0x2b807c(0x1c7)),webhookService_1=require(a18_0x2b807c(0x204)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x5676f4=a18_0x2b807c;this['getPaymentForm']=async(_0x3126b0,_0x175cfd,_0x47ead7)=>{const _0x152c15=a18_0x3a87;try{const {paymentId:_0x3dcf29}=_0x3126b0[_0x152c15(0x205)];console[_0x152c15(0x1be)](_0x152c15(0x1b2)+_0x3dcf29);const _0x14794f=await database_1[_0x152c15(0x1b6)][_0x152c15(0x1f0)][_0x152c15(0x227)]({'where':{'id':_0x3dcf29},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x14794f)return _0x175cfd['status'](0x194)[_0x152c15(0x20e)]({'success':![],'message':_0x152c15(0x1df)});if(_0x14794f['gateway']!==_0x152c15(0x1eb))return _0x175cfd[_0x152c15(0x21d)](0x190)[_0x152c15(0x20e)]({'success':![],'message':_0x152c15(0x1d9)});if(_0x14794f['status']!==_0x152c15(0x1c3))return _0x175cfd[_0x152c15(0x21d)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x14794f[_0x152c15(0x21d)]+_0x152c15(0x1da)});_0x175cfd['json']({'success':!![],'result':{'paymentId':_0x14794f['id'],'orderId':_0x14794f[_0x152c15(0x1b3)],'amount':_0x14794f[_0x152c15(0x221)],'currency':_0x14794f[_0x152c15(0x1b9)],'merchantName':_0x14794f[_0x152c15(0x1f5)][_0x152c15(0x1db)],'description':_0x152c15(0x21e)+_0x14794f[_0x152c15(0x1f5)]['name'],'testInstructions':{'successCard':_0x152c15(0x1e2),'failureCard':_0x152c15(0x1c6),'expiryDate':_0x152c15(0x1ef),'cvc':_0x152c15(0x1d1),'holderName':'Any\x20name'}}});}catch(_0x548d49){_0x47ead7(_0x548d49);}},this[_0x5676f4(0x1c4)]=async(_0x2545ab,_0x5d526b,_0x3dca21)=>{const _0x4bb17b=_0x5676f4;try{const {paymentId:_0x5788ba}=_0x2545ab[_0x4bb17b(0x205)],_0x4ff993=_0x2545ab[_0x4bb17b(0x209)];console[_0x4bb17b(0x1be)](_0x4bb17b(0x1ec)+_0x5788ba);const _0x5574b1=await database_1['default'][_0x4bb17b(0x1f0)][_0x4bb17b(0x227)]({'where':{'id':_0x5788ba},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5574b1)return _0x5d526b[_0x4bb17b(0x21d)](0x194)[_0x4bb17b(0x20e)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5574b1[_0x4bb17b(0x1d2)]!=='test_gateway')return _0x5d526b[_0x4bb17b(0x21d)](0x190)['json']({'success':![],'message':_0x4bb17b(0x1d9)});if(_0x5574b1[_0x4bb17b(0x21d)]!==_0x4bb17b(0x1c3))return _0x5d526b[_0x4bb17b(0x21d)](0x190)[_0x4bb17b(0x20e)]({'success':![],'message':_0x4bb17b(0x1b4)+_0x5574b1[_0x4bb17b(0x21d)]+_0x4bb17b(0x1da)});const _0xe2f7e1=await this['testGatewayService']['processCardPayment']({'paymentId':_0x5574b1['id'],'orderId':_0x5574b1[_0x4bb17b(0x1b3)]||_0x5574b1['id'],'amount':_0x5574b1[_0x4bb17b(0x221)],'currency':_0x5574b1[_0x4bb17b(0x1b9)],'cardData':_0x4ff993});console[_0x4bb17b(0x1be)](_0x4bb17b(0x1ba),_0xe2f7e1);const _0x54b999={'status':_0xe2f7e1[_0x4bb17b(0x21d)],'updatedAt':new Date()};if(_0xe2f7e1['status']===_0x4bb17b(0x220))_0x54b999[_0x4bb17b(0x20b)]=new Date(),_0x54b999['gatewayPaymentId']=_0xe2f7e1[_0x4bb17b(0x1e0)];else _0xe2f7e1['status']===_0x4bb17b(0x1f3)&&(_0x54b999['failureMessage']=_0xe2f7e1[_0x4bb17b(0x1c9)]);const _0x17d97b=_0x4ff993['cardNumber'][_0x4bb17b(0x1c5)](/[\s-]/g,'');_0x54b999['cardLast4']=_0x17d97b[_0x4bb17b(0x1cd)](-0x4),_0x54b999[_0x4bb17b(0x1fd)]=_0x4bb17b(0x1e6),await database_1[_0x4bb17b(0x1b6)][_0x4bb17b(0x1f0)][_0x4bb17b(0x1e5)]({'where':{'id':_0x5574b1['id']},'data':_0x54b999});if(_0xe2f7e1[_0x4bb17b(0x21d)]===_0x4bb17b(0x220)&&_0x5574b1['paymentLinkId']){console[_0x4bb17b(0x1be)](_0x4bb17b(0x1d7)+_0x5574b1['id']+_0x4bb17b(0x225));try{await database_1['default'][_0x4bb17b(0x215)](async _0x44331e=>{const _0x129db2=_0x4bb17b,_0x4a1277=await _0x44331e['paymentLink']['findUnique']({'where':{'id':_0x5574b1[_0x129db2(0x20d)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4a1277){console[_0x129db2(0x1be)](_0x129db2(0x219)+_0x4a1277['id']+':\x20type='+_0x4a1277[_0x129db2(0x1ff)]+_0x129db2(0x1ce)+_0x4a1277[_0x129db2(0x211)]+_0x129db2(0x203)+_0x4a1277[_0x129db2(0x21d)]);const _0x366a2c=_0x4a1277['currentPayments']+0x1,_0x5bf3ec=_0x4a1277[_0x129db2(0x1ff)]==='SINGLE'?'COMPLETED':_0x4a1277[_0x129db2(0x21d)];await _0x44331e[_0x129db2(0x1cc)][_0x129db2(0x1e5)]({'where':{'id':_0x5574b1['paymentLinkId']},'data':{'currentPayments':_0x366a2c,'status':_0x5bf3ec,'updatedAt':new Date()}}),console[_0x129db2(0x1be)]('âœ…\x20Payment\x20link\x20'+_0x4a1277['id']+_0x129db2(0x1b7)+_0x4a1277[_0x129db2(0x211)]+_0x129db2(0x20a)+_0x366a2c+_0x129db2(0x203)+_0x4a1277['status']+_0x129db2(0x20a)+_0x5bf3ec);}else console[_0x129db2(0x1be)](_0x129db2(0x21f)+_0x5574b1['paymentLinkId']+_0x129db2(0x210));});}catch(_0x474272){console['error'](_0x4bb17b(0x1b8),_0x474272);}}await database_1['default'][_0x4bb17b(0x1d5)]['create']({'data':{'paymentId':_0x5574b1['id'],'shopId':_0x5574b1[_0x4bb17b(0x213)],'event':_0x4bb17b(0x1c8)+_0xe2f7e1[_0x4bb17b(0x21d)][_0x4bb17b(0x1ca)](),'statusCode':0xc8,'responseBody':JSON[_0x4bb17b(0x1e1)]({'oldStatus':_0x4bb17b(0x1c3),'newStatus':_0xe2f7e1[_0x4bb17b(0x21d)],'transactionId':_0xe2f7e1[_0x4bb17b(0x1e0)],'failureReason':_0xe2f7e1[_0x4bb17b(0x1c9)],'processedAt':new Date()[_0x4bb17b(0x1d3)]()})}}),await this[_0x4bb17b(0x20f)](_0x5574b1,_0xe2f7e1['status'],_0xe2f7e1['transactionId'],_0xe2f7e1['failureReason']),await this[_0x4bb17b(0x1d4)](_0x5574b1,_0xe2f7e1[_0x4bb17b(0x21d)]),console['log'](_0x4bb17b(0x223)+_0x5788ba+_0x4bb17b(0x217)+_0xe2f7e1[_0x4bb17b(0x21d)]),_0xe2f7e1[_0x4bb17b(0x21d)]===_0x4bb17b(0x220)?_0x5d526b[_0x4bb17b(0x20e)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0xe2f7e1[_0x4bb17b(0x1e0)],'redirectUrl':_0x5574b1[_0x4bb17b(0x1b1)]}}):_0x5d526b[_0x4bb17b(0x21d)](0x190)['json']({'success':![],'message':_0x4bb17b(0x20c),'result':{'status':_0x4bb17b(0x1f3),'failureReason':_0xe2f7e1[_0x4bb17b(0x1c9)],'redirectUrl':_0x5574b1['failUrl']}});}catch(_0x538945){_0x3dca21(_0x538945);}},this[_0x5676f4(0x214)]=new testGatewayService_1[(_0x5676f4(0x1c0))](),this[_0x5676f4(0x226)]=new webhookService_1[(_0x5676f4(0x1bc))]();}async[a18_0x2b807c(0x20f)](_0x447fff,_0x1228dd,_0x2515b9,_0x1137a6){const _0x23f113=a18_0x2b807c,_0x251795=Date[_0x23f113(0x21a)]();try{const _0x23546=_0x447fff[_0x23f113(0x1f5)],_0x219f28=_0x23546[_0x23f113(0x1d0)];if(!_0x219f28?.[_0x23f113(0x1c2)]){console[_0x23f113(0x1be)](_0x23f113(0x201)+_0x23546['id']);return;}const _0x29ba12=_0x1228dd===_0x23f113(0x220)?_0x23f113(0x1fb):'payment.failed';let _0x76fa34=[];if(_0x219f28[_0x23f113(0x206)])try{_0x76fa34=Array[_0x23f113(0x1f4)](_0x219f28[_0x23f113(0x206)])?_0x219f28[_0x23f113(0x206)]:JSON['parse'](_0x219f28['webhookEvents']);}catch(_0x28f061){console[_0x23f113(0x1cb)](_0x23f113(0x1e3),_0x28f061),_0x76fa34=[];}if(!_0x76fa34['includes'](_0x29ba12)){console[_0x23f113(0x1be)]('Webhook\x20event\x20'+_0x29ba12+_0x23f113(0x1bf)+_0x23546['id']);return;}const _0x4e1c08={'event':_0x29ba12,'payment':{'id':_0x447fff['id'],'order_id':_0x447fff[_0x23f113(0x1e4)],'gateway_order_id':_0x447fff['gatewayOrderId'],'gateway':_0x23f113(0x1ee),'amount':_0x447fff[_0x23f113(0x221)],'currency':_0x447fff['currency'],'status':_0x1228dd[_0x23f113(0x1ca)](),'customer_email':_0x447fff[_0x23f113(0x1ea)],'customer_name':_0x447fff['customerName'],'transaction_id':_0x2515b9,'failure_message':_0x1137a6,'created_at':_0x447fff[_0x23f113(0x21c)],'updated_at':new Date()}},_0x2e6280=await fetch(_0x219f28[_0x23f113(0x1c2)],{'method':_0x23f113(0x1e7),'headers':{'Content-Type':'application/json','User-Agent':_0x23f113(0x1fe)},'body':JSON[_0x23f113(0x1e1)](_0x4e1c08)}),_0x319d50=Date[_0x23f113(0x21a)]()-_0x251795;console[_0x23f113(0x1be)](_0x23f113(0x21b)+_0x219f28[_0x23f113(0x1c2)]+_0x23f113(0x212)+_0x2e6280[_0x23f113(0x21d)]+'\x20('+_0x319d50+_0x23f113(0x1f8));}catch(_0x5c7e0a){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x5c7e0a);}}async[a18_0x2b807c(0x1d4)](_0x47e72e,_0x4f74cc){const _0x2ed1bc=a18_0x2b807c;try{const {telegramBotService:_0x2ba0c2}=await Promise[_0x2ed1bc(0x1f1)]()[_0x2ed1bc(0x1dc)](()=>__importStar(require('../services/telegramBotService'))),_0xa2bdc0={'PAID':_0x2ed1bc(0x1b5),'FAILED':'failed'},_0x4277e6=_0xa2bdc0[_0x4f74cc];if(!_0x4277e6)return;await _0x2ba0c2['sendPaymentNotification'](_0x47e72e[_0x2ed1bc(0x213)],_0x47e72e,_0x4277e6);}catch(_0x5e5a97){console[_0x2ed1bc(0x1cb)](_0x2ed1bc(0x229),_0x5e5a97);}}}function a18_0x2aee(){const _0x28fc23=['Payment\x20failed','paymentLinkId','json','sendShopWebhook','\x20not\x20found','currentPayments','\x20with\x20status\x20','shopId','testGatewayService','$transaction','__setModuleDefault','\x20processed:\x20','5787551skDckR','ðŸ“ˆ\x20Found\x20payment\x20link\x20','now','Test\x20Gateway\x20webhook\x20sent\x20to\x20','createdAt','status','Payment\x20to\x20','âŒ\x20Payment\x20link\x20','PAID','amount','__createBinding','âœ…\x20Test\x20Gateway\x20payment\x20','call','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','webhookService','findUnique','408IifGwR','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','successUrl','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','gatewayOrderId','Payment\x20status\x20is\x20','paid','default','\x20updated:\x20currentPayments=','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','currency','ðŸ§ª\x20Test\x20Gateway\x20result:','1079455uZebDL','WebhookService','24015167STuuLO','log','\x20not\x20enabled\x20for\x20shop\x20','TestGatewayService','hasOwnProperty','webhookUrl','PENDING','processCard','replace','Any\x20other\x20card\x20number','../services/gateways/testGatewayService','test_gateway_','failureReason','toLowerCase','error','paymentLink','slice',',\x20currentPayments=','get','settings','Any\x203-4\x20digits','gateway','toISOString','sendPaymentStatusNotification','webhookLog','2936943plTSvt','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','length','Payment\x20is\x20not\x20for\x20test\x20gateway',',\x20cannot\x20process','name','then','__importDefault','getOwnPropertyNames','Payment\x20not\x20found','transactionId','stringify','4242\x204242\x204242\x204242','Error\x20parsing\x20webhook\x20events:','orderId','update','test_card','POST','defineProperty','50LFVOMe','customerEmail','test_gateway','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importStar','0000','Any\x20future\x20date\x20(MM/YY)','payment','resolve','5314EVWOyX','FAILED','isArray','shop','12zOZePi','71PoGvjM','ms)','8215504jCGiza','prototype','payment.success','6QxGeEc','paymentMethod','Payment\x20System/1.0\x20(Test\x20Gateway)','type','14324cCMKAI','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create',',\x20status=','../services/webhookService','params','webhookEvents','__esModule','configurable','body','\x20->\x20','paidAt'];a18_0x2aee=function(){return _0x28fc23;};return a18_0x2aee();}exports['TestGatewayController']=TestGatewayController;