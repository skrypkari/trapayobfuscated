'use strict';const a13_0x1887fa=a13_0x2a8b;(function(_0x3051d2,_0xe1cf0){const _0x547f56=a13_0x2a8b,_0x417d36=_0x3051d2();while(!![]){try{const _0x19cb62=parseInt(_0x547f56(0x146))/0x1+parseInt(_0x547f56(0x161))/0x2+parseInt(_0x547f56(0x14d))/0x3*(-parseInt(_0x547f56(0x165))/0x4)+parseInt(_0x547f56(0x1a2))/0x5*(parseInt(_0x547f56(0x188))/0x6)+parseInt(_0x547f56(0x197))/0x7*(-parseInt(_0x547f56(0x156))/0x8)+parseInt(_0x547f56(0x15c))/0x9*(-parseInt(_0x547f56(0x143))/0xa)+parseInt(_0x547f56(0x179))/0xb;if(_0x19cb62===_0xe1cf0)break;else _0x417d36['push'](_0x417d36['shift']());}catch(_0x81d70c){_0x417d36['push'](_0x417d36['shift']());}}}(a13_0x341e,0xdd4d9));function a13_0x2a8b(_0x2d887d,_0x354dac){const _0x341efb=a13_0x341e();return a13_0x2a8b=function(_0x2a8bf7,_0x4f1954){_0x2a8bf7=_0x2a8bf7-0x130;let _0x408956=_0x341efb[_0x2a8bf7];return _0x408956;},a13_0x2a8b(_0x2d887d,_0x354dac);}var __createBinding=this&&this['__createBinding']||(Object[a13_0x1887fa(0x18b)]?function(_0x5157a8,_0x2b8626,_0x17044e,_0x3165e3){const _0x3408f1=a13_0x1887fa;if(_0x3165e3===undefined)_0x3165e3=_0x17044e;var _0x9d569=Object[_0x3408f1(0x14b)](_0x2b8626,_0x17044e);(!_0x9d569||(_0x3408f1(0x18f)in _0x9d569?!_0x2b8626[_0x3408f1(0x17f)]:_0x9d569[_0x3408f1(0x13d)]||_0x9d569[_0x3408f1(0x157)]))&&(_0x9d569={'enumerable':!![],'get':function(){return _0x2b8626[_0x17044e];}}),Object['defineProperty'](_0x5157a8,_0x3165e3,_0x9d569);}:function(_0x3fe726,_0x525302,_0x2309e4,_0x55140d){if(_0x55140d===undefined)_0x55140d=_0x2309e4;_0x3fe726[_0x55140d]=_0x525302[_0x2309e4];}),__setModuleDefault=this&&this[a13_0x1887fa(0x18d)]||(Object[a13_0x1887fa(0x18b)]?function(_0x7cb514,_0x360ab0){const _0x4a3828=a13_0x1887fa;Object[_0x4a3828(0x131)](_0x7cb514,'default',{'enumerable':!![],'value':_0x360ab0});}:function(_0x329d2c,_0x4335e3){_0x329d2c['default']=_0x4335e3;}),__importStar=this&&this[a13_0x1887fa(0x198)]||(function(){var _0x466bbf=function(_0xec04ca){const _0x1aa086=a13_0x2a8b;return _0x466bbf=Object[_0x1aa086(0x13a)]||function(_0x146491){const _0x1853f5=_0x1aa086;var _0x401b38=[];for(var _0x33cd9c in _0x146491)if(Object[_0x1853f5(0x180)][_0x1853f5(0x132)][_0x1853f5(0x174)](_0x146491,_0x33cd9c))_0x401b38[_0x401b38[_0x1853f5(0x178)]]=_0x33cd9c;return _0x401b38;},_0x466bbf(_0xec04ca);};return function(_0x5d6781){const _0x45a4ff=a13_0x2a8b;if(_0x5d6781&&_0x5d6781['__esModule'])return _0x5d6781;var _0x34c42={};if(_0x5d6781!=null){for(var _0x35672f=_0x466bbf(_0x5d6781),_0x65df85=0x0;_0x65df85<_0x35672f[_0x45a4ff(0x178)];_0x65df85++)if(_0x35672f[_0x65df85]!=='default')__createBinding(_0x34c42,_0x5d6781,_0x35672f[_0x65df85]);}return __setModuleDefault(_0x34c42,_0x5d6781),_0x34c42;};}()),__importDefault=this&&this[a13_0x1887fa(0x163)]||function(_0x3b457c){const _0x55eda0=a13_0x1887fa;return _0x3b457c&&_0x3b457c[_0x55eda0(0x17f)]?_0x3b457c:{'default':_0x3b457c};};function a13_0x341e(){const _0x3c335b=['Test\x20Gateway\x20webhook\x20sent\x20to\x20','ms)','sendPaymentStatusNotification','toLowerCase','../services/webhookService','14achThw','__importStar','failureReason','TestGatewayService','$transaction','Payment\x20is\x20not\x20for\x20test\x20gateway','\x20not\x20enabled\x20for\x20shop\x20','WebhookService','\x20processed:\x20','orderId','processCardPayment','590yHOWKs','failureMessage',',\x20cannot\x20process','0000','SINGLE','POST','cardNumber','defineProperty','hasOwnProperty','\x20not\x20found','log','shopId','📈\x20Test\x20Gateway:\x20Payment\x20','currentPayments','../services/gateways/testGatewayService','payment.success','getOwnPropertyNames','name','body','writable','gatewayPaymentId','currency','replace','../services/telegramBotService','🧪\x20Test\x20Gateway\x20result:','8117710wxXTWv','paymentLink','processCard','1640070rOOPjv','sendPaymentNotification','stringify','now','status','getOwnPropertyDescriptor','type','2452056SpDEJX','webhookUrl','\x20with\x20status\x20','default','test_gateway','FAILED','gateway','shop','error','6582296rqbYsq','configurable','PAID','Payment\x20processed\x20successfully','✅\x20Test\x20Gateway\x20payment\x20','Webhook\x20event\x20','9qTagUP','../config/database','amount','sendShopWebhook','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','2170006psvASK','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','__importDefault','paidAt','8ePXYkY','Payment\x20status\x20is\x20','resolve','transactionId','json','then','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','update','TestGatewayController',',\x20status=','isArray','Any\x20other\x20card\x20number','testGatewayService','params','call','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','findUnique','PENDING','length','12510619qQbLZi','slice','webhookEvents','📈\x20Found\x20payment\x20link\x20','payment','paymentLinkId','__esModule','prototype','✅\x20Payment\x20link\x20',',\x20currentPayments=','gatewayOrderId','failed','includes','Error\x20parsing\x20webhook\x20events:','customerEmail','57768xeNvSF','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20->\x20','create','successUrl','__setModuleDefault','\x20updated:\x20currentPayments=','get','Payment\x20failed','getPaymentForm'];a13_0x341e=function(){return _0x3c335b;};return a13_0x341e();}Object[a13_0x1887fa(0x131)](exports,a13_0x1887fa(0x17f),{'value':!![]}),exports[a13_0x1887fa(0x16e)]=void 0x0;const testGatewayService_1=require(a13_0x1887fa(0x138)),webhookService_1=require(a13_0x1887fa(0x196)),database_1=__importDefault(require(a13_0x1887fa(0x15d)));class TestGatewayController{constructor(){const _0x544d57=a13_0x1887fa;this[_0x544d57(0x191)]=async(_0x6b0e18,_0x53a7aa,_0x243615)=>{const _0x30a159=_0x544d57;try{const {paymentId:_0x3e1e26}=_0x6b0e18['params'];console['log']('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3e1e26);const _0xc5ba0=await database_1[_0x30a159(0x150)][_0x30a159(0x17d)]['findUnique']({'where':{'id':_0x3e1e26},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xc5ba0)return _0x53a7aa['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0xc5ba0[_0x30a159(0x153)]!=='test_gateway')return _0x53a7aa[_0x30a159(0x14a)](0x190)[_0x30a159(0x169)]({'success':![],'message':_0x30a159(0x19c)});if(_0xc5ba0[_0x30a159(0x14a)]!=='PENDING')return _0x53a7aa['status'](0x190)[_0x30a159(0x169)]({'success':![],'message':_0x30a159(0x166)+_0xc5ba0[_0x30a159(0x14a)]+_0x30a159(0x1a4)});_0x53a7aa[_0x30a159(0x169)]({'success':!![],'result':{'paymentId':_0xc5ba0['id'],'orderId':_0xc5ba0[_0x30a159(0x183)],'amount':_0xc5ba0[_0x30a159(0x15e)],'currency':_0xc5ba0[_0x30a159(0x13f)],'merchantName':_0xc5ba0[_0x30a159(0x154)][_0x30a159(0x13b)],'description':'Payment\x20to\x20'+_0xc5ba0[_0x30a159(0x154)][_0x30a159(0x13b)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x30a159(0x171),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x557c9f){_0x243615(_0x557c9f);}},this[_0x544d57(0x145)]=async(_0x5fc78d,_0x37d4b8,_0x2bd8e5)=>{const _0x40530c=_0x544d57;try{const {paymentId:_0x18671e}=_0x5fc78d[_0x40530c(0x173)],_0x1ba034=_0x5fc78d[_0x40530c(0x13c)];console[_0x40530c(0x134)](_0x40530c(0x16b)+_0x18671e);const _0x346ef2=await database_1[_0x40530c(0x150)][_0x40530c(0x17d)]['findUnique']({'where':{'id':_0x18671e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x346ef2)return _0x37d4b8[_0x40530c(0x14a)](0x194)[_0x40530c(0x169)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x346ef2['gateway']!==_0x40530c(0x151))return _0x37d4b8['status'](0x190)[_0x40530c(0x169)]({'success':![],'message':_0x40530c(0x19c)});if(_0x346ef2[_0x40530c(0x14a)]!==_0x40530c(0x177))return _0x37d4b8[_0x40530c(0x14a)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x346ef2[_0x40530c(0x14a)]+_0x40530c(0x1a4)});const _0x1fde78=await this[_0x40530c(0x172)][_0x40530c(0x1a1)]({'paymentId':_0x346ef2['id'],'orderId':_0x346ef2[_0x40530c(0x183)]||_0x346ef2['id'],'amount':_0x346ef2['amount'],'currency':_0x346ef2[_0x40530c(0x13f)],'cardData':_0x1ba034});console['log'](_0x40530c(0x142),_0x1fde78);const _0x4e4881={'status':_0x1fde78[_0x40530c(0x14a)],'updatedAt':new Date()};if(_0x1fde78[_0x40530c(0x14a)]==='PAID')_0x4e4881[_0x40530c(0x164)]=new Date(),_0x4e4881[_0x40530c(0x13e)]=_0x1fde78[_0x40530c(0x168)];else _0x1fde78[_0x40530c(0x14a)]===_0x40530c(0x152)&&(_0x4e4881[_0x40530c(0x1a3)]=_0x1fde78['failureReason']);const _0x48458f=_0x1ba034[_0x40530c(0x130)][_0x40530c(0x140)](/[\s-]/g,'');_0x4e4881['cardLast4']=_0x48458f[_0x40530c(0x17a)](-0x4),_0x4e4881['paymentMethod']='test_card',await database_1[_0x40530c(0x150)][_0x40530c(0x17d)][_0x40530c(0x16d)]({'where':{'id':_0x346ef2['id']},'data':_0x4e4881});if(_0x1fde78['status']==='PAID'&&_0x346ef2[_0x40530c(0x17e)]){console[_0x40530c(0x134)](_0x40530c(0x136)+_0x346ef2['id']+_0x40530c(0x162));try{await database_1['default'][_0x40530c(0x19b)](async _0x2f92f4=>{const _0x38aa8b=_0x40530c,_0x4d048b=await _0x2f92f4['paymentLink'][_0x38aa8b(0x176)]({'where':{'id':_0x346ef2[_0x38aa8b(0x17e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4d048b){console[_0x38aa8b(0x134)](_0x38aa8b(0x17c)+_0x4d048b['id']+':\x20type='+_0x4d048b['type']+_0x38aa8b(0x182)+_0x4d048b[_0x38aa8b(0x137)]+_0x38aa8b(0x16f)+_0x4d048b[_0x38aa8b(0x14a)]);const _0x9dbbe7=_0x4d048b['currentPayments']+0x1,_0x382baf=_0x4d048b[_0x38aa8b(0x14c)]===_0x38aa8b(0x1a6)?'COMPLETED':_0x4d048b[_0x38aa8b(0x14a)];await _0x2f92f4[_0x38aa8b(0x144)][_0x38aa8b(0x16d)]({'where':{'id':_0x346ef2[_0x38aa8b(0x17e)]},'data':{'currentPayments':_0x9dbbe7,'status':_0x382baf,'updatedAt':new Date()}}),console['log'](_0x38aa8b(0x181)+_0x4d048b['id']+_0x38aa8b(0x18e)+_0x4d048b[_0x38aa8b(0x137)]+'\x20->\x20'+_0x9dbbe7+_0x38aa8b(0x16f)+_0x4d048b[_0x38aa8b(0x14a)]+_0x38aa8b(0x18a)+_0x382baf);}else console[_0x38aa8b(0x134)]('❌\x20Payment\x20link\x20'+_0x346ef2[_0x38aa8b(0x17e)]+_0x38aa8b(0x133));});}catch(_0x10f658){console[_0x40530c(0x155)](_0x40530c(0x16c),_0x10f658);}}await database_1[_0x40530c(0x150)]['webhookLog']['create']({'data':{'paymentId':_0x346ef2['id'],'shopId':_0x346ef2[_0x40530c(0x135)],'event':'test_gateway_'+_0x1fde78[_0x40530c(0x14a)][_0x40530c(0x195)](),'statusCode':0xc8,'responseBody':JSON[_0x40530c(0x148)]({'oldStatus':'PENDING','newStatus':_0x1fde78[_0x40530c(0x14a)],'transactionId':_0x1fde78[_0x40530c(0x168)],'failureReason':_0x1fde78[_0x40530c(0x199)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x346ef2,_0x1fde78[_0x40530c(0x14a)],_0x1fde78[_0x40530c(0x168)],_0x1fde78[_0x40530c(0x199)]),await this[_0x40530c(0x194)](_0x346ef2,_0x1fde78[_0x40530c(0x14a)]),console[_0x40530c(0x134)](_0x40530c(0x15a)+_0x18671e+_0x40530c(0x19f)+_0x1fde78[_0x40530c(0x14a)]),_0x1fde78[_0x40530c(0x14a)]===_0x40530c(0x158)?_0x37d4b8['json']({'success':!![],'message':_0x40530c(0x159),'result':{'status':_0x40530c(0x158),'transactionId':_0x1fde78[_0x40530c(0x168)],'redirectUrl':_0x346ef2[_0x40530c(0x18c)]}}):_0x37d4b8[_0x40530c(0x14a)](0x190)['json']({'success':![],'message':_0x40530c(0x190),'result':{'status':_0x40530c(0x152),'failureReason':_0x1fde78[_0x40530c(0x199)],'redirectUrl':_0x346ef2['failUrl']}});}catch(_0x1523d7){_0x2bd8e5(_0x1523d7);}},this['testGatewayService']=new testGatewayService_1[(_0x544d57(0x19a))](),this['webhookService']=new webhookService_1[(_0x544d57(0x19e))]();}async[a13_0x1887fa(0x15f)](_0xe7fbeb,_0x37430e,_0x4f3d46,_0x13c6b3){const _0x23a263=a13_0x1887fa,_0x16d9ea=Date[_0x23a263(0x149)]();try{const _0x35b561=_0xe7fbeb[_0x23a263(0x154)],_0x3a1156=_0x35b561['settings'];if(!_0x3a1156?.[_0x23a263(0x14e)]){console[_0x23a263(0x134)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x35b561['id']);return;}const _0x53b39c=_0x37430e===_0x23a263(0x158)?_0x23a263(0x139):'payment.failed';let _0xa4fa89=[];if(_0x3a1156['webhookEvents'])try{_0xa4fa89=Array[_0x23a263(0x170)](_0x3a1156['webhookEvents'])?_0x3a1156[_0x23a263(0x17b)]:JSON['parse'](_0x3a1156[_0x23a263(0x17b)]);}catch(_0x2901f9){console['error'](_0x23a263(0x186),_0x2901f9),_0xa4fa89=[];}if(!_0xa4fa89[_0x23a263(0x185)](_0x53b39c)){console['log'](_0x23a263(0x15b)+_0x53b39c+_0x23a263(0x19d)+_0x35b561['id']);return;}const _0x56988e={'event':_0x53b39c,'payment':{'id':_0xe7fbeb['id'],'order_id':_0xe7fbeb[_0x23a263(0x1a0)],'gateway_order_id':_0xe7fbeb[_0x23a263(0x183)],'gateway':_0x23a263(0x1a5),'amount':_0xe7fbeb[_0x23a263(0x15e)],'currency':_0xe7fbeb[_0x23a263(0x13f)],'status':_0x37430e[_0x23a263(0x195)](),'customer_email':_0xe7fbeb[_0x23a263(0x187)],'customer_name':_0xe7fbeb['customerName'],'transaction_id':_0x4f3d46,'failure_message':_0x13c6b3,'created_at':_0xe7fbeb['createdAt'],'updated_at':new Date()}},_0x1c3048=await fetch(_0x3a1156['webhookUrl'],{'method':_0x23a263(0x1a7),'headers':{'Content-Type':'application/json','User-Agent':_0x23a263(0x189)},'body':JSON[_0x23a263(0x148)](_0x56988e)}),_0x217308=Date[_0x23a263(0x149)]()-_0x16d9ea;console[_0x23a263(0x134)](_0x23a263(0x192)+_0x3a1156[_0x23a263(0x14e)]+_0x23a263(0x14f)+_0x1c3048[_0x23a263(0x14a)]+'\x20('+_0x217308+_0x23a263(0x193));}catch(_0x187047){console['error'](_0x23a263(0x175),_0x187047);}}async[a13_0x1887fa(0x194)](_0x10c2a3,_0x16e79e){const _0x7f1b96=a13_0x1887fa;try{const {telegramBotService:_0x1bd922}=await Promise[_0x7f1b96(0x167)]()[_0x7f1b96(0x16a)](()=>__importStar(require(_0x7f1b96(0x141)))),_0x5af9e8={'PAID':'paid','FAILED':_0x7f1b96(0x184)},_0x2926f5=_0x5af9e8[_0x16e79e];if(!_0x2926f5)return;await _0x1bd922[_0x7f1b96(0x147)](_0x10c2a3['shopId'],_0x10c2a3,_0x2926f5);}catch(_0x4c651c){console[_0x7f1b96(0x155)](_0x7f1b96(0x160),_0x4c651c);}}}exports[a13_0x1887fa(0x16e)]=TestGatewayController;