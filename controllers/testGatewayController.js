'use strict';const a13_0x28981a=a13_0xe79a;(function(_0x3939af,_0xb62d5d){const _0x25fcf9=a13_0xe79a,_0x477024=_0x3939af();while(!![]){try{const _0x3124f3=-parseInt(_0x25fcf9(0xe3))/0x1+parseInt(_0x25fcf9(0xa6))/0x2+parseInt(_0x25fcf9(0xdd))/0x3+-parseInt(_0x25fcf9(0x9d))/0x4*(parseInt(_0x25fcf9(0x97))/0x5)+-parseInt(_0x25fcf9(0xed))/0x6+parseInt(_0x25fcf9(0xc8))/0x7+-parseInt(_0x25fcf9(0xc3))/0x8*(-parseInt(_0x25fcf9(0xea))/0x9);if(_0x3124f3===_0xb62d5d)break;else _0x477024['push'](_0x477024['shift']());}catch(_0x4020d7){_0x477024['push'](_0x477024['shift']());}}}(a13_0xe88f,0x73624));var __createBinding=this&&this[a13_0x28981a(0xec)]||(Object['create']?function(_0x2ff022,_0xf5627c,_0x550162,_0x31d867){const _0x5ccd89=a13_0x28981a;if(_0x31d867===undefined)_0x31d867=_0x550162;var _0x3e4c12=Object['getOwnPropertyDescriptor'](_0xf5627c,_0x550162);(!_0x3e4c12||(_0x5ccd89(0xc1)in _0x3e4c12?!_0xf5627c['__esModule']:_0x3e4c12['writable']||_0x3e4c12['configurable']))&&(_0x3e4c12={'enumerable':!![],'get':function(){return _0xf5627c[_0x550162];}}),Object['defineProperty'](_0x2ff022,_0x31d867,_0x3e4c12);}:function(_0x536aa4,_0x23cb81,_0x5b239a,_0x3c62af){if(_0x3c62af===undefined)_0x3c62af=_0x5b239a;_0x536aa4[_0x3c62af]=_0x23cb81[_0x5b239a];}),__setModuleDefault=this&&this[a13_0x28981a(0xb1)]||(Object[a13_0x28981a(0xeb)]?function(_0x4aca11,_0x458385){const _0x322207=a13_0x28981a;Object[_0x322207(0xa4)](_0x4aca11,_0x322207(0xc5),{'enumerable':!![],'value':_0x458385});}:function(_0x566892,_0x19f14d){_0x566892['default']=_0x19f14d;}),__importStar=this&&this[a13_0x28981a(0xdc)]||(function(){var _0xa92171=function(_0xe96bee){const _0x243346=a13_0xe79a;return _0xa92171=Object[_0x243346(0xd1)]||function(_0x26b866){const _0x108dbb=_0x243346;var _0x14551c=[];for(var _0x30c226 in _0x26b866)if(Object[_0x108dbb(0xe9)][_0x108dbb(0xe2)]['call'](_0x26b866,_0x30c226))_0x14551c[_0x14551c[_0x108dbb(0x89)]]=_0x30c226;return _0x14551c;},_0xa92171(_0xe96bee);};return function(_0x80221a){const _0x47738d=a13_0xe79a;if(_0x80221a&&_0x80221a[_0x47738d(0xdb)])return _0x80221a;var _0x4e46ec={};if(_0x80221a!=null){for(var _0x1e9c94=_0xa92171(_0x80221a),_0x1f059c=0x0;_0x1f059c<_0x1e9c94[_0x47738d(0x89)];_0x1f059c++)if(_0x1e9c94[_0x1f059c]!==_0x47738d(0xc5))__createBinding(_0x4e46ec,_0x80221a,_0x1e9c94[_0x1f059c]);}return __setModuleDefault(_0x4e46ec,_0x80221a),_0x4e46ec;};}()),__importDefault=this&&this['__importDefault']||function(_0xd840e){const _0x1fb302=a13_0x28981a;return _0xd840e&&_0xd840e[_0x1fb302(0xdb)]?_0xd840e:{'default':_0xd840e};};function a13_0xe79a(_0x22e9da,_0xb4a78){const _0xe88f3d=a13_0xe88f();return a13_0xe79a=function(_0xe79ada,_0x47918e){_0xe79ada=_0xe79ada-0x89;let _0x493e9a=_0xe88f3d[_0xe79ada];return _0x493e9a;},a13_0xe79a(_0x22e9da,_0xb4a78);}Object[a13_0x28981a(0xa4)](exports,a13_0x28981a(0xdb),{'value':!![]}),exports[a13_0x28981a(0xf1)]=void 0x0;function a13_0xe88f(){const _0x3e8f62=['No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20not\x20enabled\x20for\x20shop\x20','error','getOwnPropertyNames','4242\x204242\x204242\x204242','âœ…\x20Test\x20Gateway\x20payment\x20','0000','test_gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../services/telegramBotService','body','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','cardLast4','__esModule','__importStar','1312536eXfZCZ','Payment\x20processed\x20successfully','gatewayPaymentId','webhookUrl','customerEmail','hasOwnProperty','395970pTVGyR','currency','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','test_card','stringify','gatewayOrderId','prototype','5168889ZtQVfs','create','__createBinding','2200560fPnhbq','json','Any\x20other\x20card\x20number','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TestGatewayController','\x20with\x20status\x20','length','cardNumber','\x20processed:\x20','webhookEvents','customerName','payment','../config/database','../services/gateways/testGatewayService','failureReason','slice','gateway','amount','Webhook\x20event\x20','params','1405qcOjVx','Payment\x20status\x20is\x20','PENDING','sendPaymentStatusNotification','failUrl','POST','8956GlAJmi','Any\x20name','toLowerCase','isArray','Payment\x20to\x20','processCard','findUnique','defineProperty','includes','890268UStLrK','shop','payment.failed','sendShopWebhook','failureMessage','log','TestGatewayService','Any\x20future\x20date\x20(MM/YY)','name','webhookService','ðŸ§ª\x20Test\x20Gateway\x20result:','__setModuleDefault','parse','orderId','testGatewayService','then','now','Payment\x20is\x20not\x20for\x20test\x20gateway','toISOString','paymentMethod','createdAt','resolve','FAILED','getPaymentForm','sendPaymentNotification','payment.success','Payment\x20failed','get','WebhookService','8sChzTg','paid','default','status','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','2852738kdQOPs','replace','shopId','Payment\x20not\x20found','transactionId','PAID'];a13_0xe88f=function(){return _0x3e8f62;};return a13_0xe88f();}const testGatewayService_1=require(a13_0x28981a(0x90)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x28981a(0x8f)));class TestGatewayController{constructor(){const _0x37f52c=a13_0x28981a;this[_0x37f52c(0xbd)]=async(_0x1d29bf,_0x3c3db3,_0xba64e7)=>{const _0xba5f1d=_0x37f52c;try{const {paymentId:_0x29e501}=_0x1d29bf['params'];console[_0xba5f1d(0xab)](_0xba5f1d(0xd9)+_0x29e501);const _0xd2aa52=await database_1[_0xba5f1d(0xc5)][_0xba5f1d(0x8e)][_0xba5f1d(0xa3)]({'where':{'id':_0x29e501},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xd2aa52)return _0x3c3db3[_0xba5f1d(0xc6)](0x194)['json']({'success':![],'message':_0xba5f1d(0xcb)});if(_0xd2aa52[_0xba5f1d(0x93)]!==_0xba5f1d(0xd5))return _0x3c3db3[_0xba5f1d(0xc6)](0x190)[_0xba5f1d(0xee)]({'success':![],'message':_0xba5f1d(0xb7)});if(_0xd2aa52[_0xba5f1d(0xc6)]!==_0xba5f1d(0x99))return _0x3c3db3[_0xba5f1d(0xc6)](0x190)[_0xba5f1d(0xee)]({'success':![],'message':_0xba5f1d(0x98)+_0xd2aa52[_0xba5f1d(0xc6)]+',\x20cannot\x20process'});_0x3c3db3[_0xba5f1d(0xee)]({'success':!![],'result':{'paymentId':_0xd2aa52['id'],'orderId':_0xd2aa52['gatewayOrderId'],'amount':_0xd2aa52[_0xba5f1d(0x94)],'currency':_0xd2aa52[_0xba5f1d(0xe4)],'merchantName':_0xd2aa52['shop']['name'],'description':_0xba5f1d(0xa1)+_0xd2aa52[_0xba5f1d(0xa7)][_0xba5f1d(0xae)],'testInstructions':{'successCard':_0xba5f1d(0xd2),'failureCard':_0xba5f1d(0xef),'expiryDate':_0xba5f1d(0xad),'cvc':'Any\x203-4\x20digits','holderName':_0xba5f1d(0x9e)}}});}catch(_0x57a9d8){_0xba64e7(_0x57a9d8);}},this[_0x37f52c(0xa2)]=async(_0x28a3af,_0x34db3f,_0x267565)=>{const _0x55866e=_0x37f52c;try{const {paymentId:_0x34fc77}=_0x28a3af[_0x55866e(0x96)],_0x1426f3=_0x28a3af[_0x55866e(0xd8)];console[_0x55866e(0xab)](_0x55866e(0xe5)+_0x34fc77);const _0x95c4df=await database_1[_0x55866e(0xc5)][_0x55866e(0x8e)][_0x55866e(0xa3)]({'where':{'id':_0x34fc77},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x95c4df)return _0x34db3f['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x95c4df[_0x55866e(0x93)]!==_0x55866e(0xd5))return _0x34db3f[_0x55866e(0xc6)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x95c4df[_0x55866e(0xc6)]!=='PENDING')return _0x34db3f[_0x55866e(0xc6)](0x190)[_0x55866e(0xee)]({'success':![],'message':_0x55866e(0x98)+_0x95c4df[_0x55866e(0xc6)]+',\x20cannot\x20process'});const _0x29da84=await this[_0x55866e(0xb4)]['processCardPayment']({'paymentId':_0x95c4df['id'],'orderId':_0x95c4df[_0x55866e(0xe8)]||_0x95c4df['id'],'amount':_0x95c4df[_0x55866e(0x94)],'currency':_0x95c4df['currency'],'cardData':_0x1426f3});console[_0x55866e(0xab)](_0x55866e(0xb0),_0x29da84);const _0x2a7663={'status':_0x29da84[_0x55866e(0xc6)],'updatedAt':new Date()};if(_0x29da84[_0x55866e(0xc6)]===_0x55866e(0xcd))_0x2a7663['paidAt']=new Date(),_0x2a7663[_0x55866e(0xdf)]=_0x29da84[_0x55866e(0xcc)];else _0x29da84[_0x55866e(0xc6)]===_0x55866e(0xbc)&&(_0x2a7663[_0x55866e(0xaa)]=_0x29da84[_0x55866e(0x91)]);const _0x335e0c=_0x1426f3[_0x55866e(0x8a)][_0x55866e(0xc9)](/[\s-]/g,'');_0x2a7663[_0x55866e(0xda)]=_0x335e0c[_0x55866e(0x92)](-0x4),_0x2a7663[_0x55866e(0xb9)]=_0x55866e(0xe6),await database_1['default'][_0x55866e(0x8e)]['update']({'where':{'id':_0x95c4df['id']},'data':_0x2a7663}),await database_1[_0x55866e(0xc5)]['webhookLog'][_0x55866e(0xeb)]({'data':{'paymentId':_0x95c4df['id'],'shopId':_0x95c4df['shopId'],'event':'test_gateway_'+_0x29da84['status'][_0x55866e(0x9f)](),'statusCode':0xc8,'responseBody':JSON[_0x55866e(0xe7)]({'oldStatus':_0x55866e(0x99),'newStatus':_0x29da84['status'],'transactionId':_0x29da84['transactionId'],'failureReason':_0x29da84[_0x55866e(0x91)],'processedAt':new Date()[_0x55866e(0xb8)]()})}}),await this[_0x55866e(0xa9)](_0x95c4df,_0x29da84['status'],_0x29da84['transactionId'],_0x29da84[_0x55866e(0x91)]),await this['sendPaymentStatusNotification'](_0x95c4df,_0x29da84[_0x55866e(0xc6)]),console[_0x55866e(0xab)](_0x55866e(0xd3)+_0x34fc77+_0x55866e(0x8b)+_0x29da84[_0x55866e(0xc6)]),_0x29da84[_0x55866e(0xc6)]===_0x55866e(0xcd)?_0x34db3f['json']({'success':!![],'message':_0x55866e(0xde),'result':{'status':_0x55866e(0xcd),'transactionId':_0x29da84[_0x55866e(0xcc)],'redirectUrl':_0x95c4df['successUrl']}}):_0x34db3f['status'](0x190)[_0x55866e(0xee)]({'success':![],'message':_0x55866e(0xc0),'result':{'status':'FAILED','failureReason':_0x29da84[_0x55866e(0x91)],'redirectUrl':_0x95c4df[_0x55866e(0x9b)]}});}catch(_0x552e30){_0x267565(_0x552e30);}},this[_0x37f52c(0xb4)]=new testGatewayService_1[(_0x37f52c(0xac))](),this[_0x37f52c(0xaf)]=new webhookService_1[(_0x37f52c(0xc2))]();}async[a13_0x28981a(0xa9)](_0x41e92b,_0x1ada35,_0x363699,_0x593685){const _0x5ab45e=a13_0x28981a,_0x4de916=Date[_0x5ab45e(0xb6)]();try{const _0x4b60be=_0x41e92b[_0x5ab45e(0xa7)],_0x1fb21d=_0x4b60be['settings'];if(!_0x1fb21d?.[_0x5ab45e(0xe0)]){console[_0x5ab45e(0xab)](_0x5ab45e(0xce)+_0x4b60be['id']);return;}const _0x2fdbf9=_0x1ada35===_0x5ab45e(0xcd)?_0x5ab45e(0xbf):_0x5ab45e(0xa8);let _0x32f19d=[];if(_0x1fb21d[_0x5ab45e(0x8c)])try{_0x32f19d=Array[_0x5ab45e(0xa0)](_0x1fb21d[_0x5ab45e(0x8c)])?_0x1fb21d[_0x5ab45e(0x8c)]:JSON[_0x5ab45e(0xb2)](_0x1fb21d[_0x5ab45e(0x8c)]);}catch(_0x1e3adb){console['error']('Error\x20parsing\x20webhook\x20events:',_0x1e3adb),_0x32f19d=[];}if(!_0x32f19d[_0x5ab45e(0xa5)](_0x2fdbf9)){console[_0x5ab45e(0xab)](_0x5ab45e(0x95)+_0x2fdbf9+_0x5ab45e(0xcf)+_0x4b60be['id']);return;}const _0x4bb311={'event':_0x2fdbf9,'payment':{'id':_0x41e92b['id'],'order_id':_0x41e92b[_0x5ab45e(0xb3)],'gateway_order_id':_0x41e92b['gatewayOrderId'],'gateway':_0x5ab45e(0xd4),'amount':_0x41e92b[_0x5ab45e(0x94)],'currency':_0x41e92b[_0x5ab45e(0xe4)],'status':_0x1ada35[_0x5ab45e(0x9f)](),'customer_email':_0x41e92b[_0x5ab45e(0xe1)],'customer_name':_0x41e92b[_0x5ab45e(0x8d)],'transaction_id':_0x363699,'failure_message':_0x593685,'created_at':_0x41e92b[_0x5ab45e(0xba)],'updated_at':new Date()}},_0x49b7d4=await fetch(_0x1fb21d[_0x5ab45e(0xe0)],{'method':_0x5ab45e(0x9c),'headers':{'Content-Type':'application/json','User-Agent':_0x5ab45e(0xc7)},'body':JSON[_0x5ab45e(0xe7)](_0x4bb311)}),_0x25778a=Date[_0x5ab45e(0xb6)]()-_0x4de916;console[_0x5ab45e(0xab)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x1fb21d['webhookUrl']+_0x5ab45e(0xf2)+_0x49b7d4[_0x5ab45e(0xc6)]+'\x20('+_0x25778a+'ms)');}catch(_0x25a7b7){console[_0x5ab45e(0xd0)](_0x5ab45e(0xd6),_0x25a7b7);}}async[a13_0x28981a(0x9a)](_0x52a90a,_0x17d7b3){const _0x549b2f=a13_0x28981a;try{const {telegramBotService:_0x41bec3}=await Promise[_0x549b2f(0xbb)]()[_0x549b2f(0xb5)](()=>__importStar(require(_0x549b2f(0xd7)))),_0x176df6={'PAID':_0x549b2f(0xc4),'FAILED':'failed'},_0x3a64e7=_0x176df6[_0x17d7b3];if(!_0x3a64e7)return;await _0x41bec3[_0x549b2f(0xbe)](_0x52a90a[_0x549b2f(0xca)],_0x52a90a,_0x3a64e7);}catch(_0x30aaa4){console[_0x549b2f(0xd0)](_0x549b2f(0xf0),_0x30aaa4);}}}exports[a13_0x28981a(0xf1)]=TestGatewayController;