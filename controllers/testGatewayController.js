'use strict';const a13_0x5e207a=a13_0x3199;(function(_0x59055a,_0x547b1d){const _0x28623f=a13_0x3199,_0x20a3b9=_0x59055a();while(!![]){try{const _0x2e6f02=-parseInt(_0x28623f(0x1af))/0x1*(parseInt(_0x28623f(0x19f))/0x2)+-parseInt(_0x28623f(0x1b8))/0x3+parseInt(_0x28623f(0x17a))/0x4*(-parseInt(_0x28623f(0x18a))/0x5)+-parseInt(_0x28623f(0x178))/0x6+parseInt(_0x28623f(0x1c8))/0x7*(parseInt(_0x28623f(0x17b))/0x8)+parseInt(_0x28623f(0x176))/0x9+parseInt(_0x28623f(0x19c))/0xa*(parseInt(_0x28623f(0x18d))/0xb);if(_0x2e6f02===_0x547b1d)break;else _0x20a3b9['push'](_0x20a3b9['shift']());}catch(_0x2d11fb){_0x20a3b9['push'](_0x20a3b9['shift']());}}}(a13_0x4b31,0x60170));function a13_0x3199(_0x5bf5dc,_0x4c5521){const _0x4b310f=a13_0x4b31();return a13_0x3199=function(_0x319989,_0x310c54){_0x319989=_0x319989-0x167;let _0x531957=_0x4b310f[_0x319989];return _0x531957;},a13_0x3199(_0x5bf5dc,_0x4c5521);}var __createBinding=this&&this[a13_0x5e207a(0x168)]||(Object[a13_0x5e207a(0x16b)]?function(_0x5c03af,_0x3b819a,_0x20d32d,_0x7d9ace){const _0x883c5a=a13_0x5e207a;if(_0x7d9ace===undefined)_0x7d9ace=_0x20d32d;var _0x150b2a=Object[_0x883c5a(0x1a6)](_0x3b819a,_0x20d32d);(!_0x150b2a||(_0x883c5a(0x1c7)in _0x150b2a?!_0x3b819a[_0x883c5a(0x197)]:_0x150b2a[_0x883c5a(0x175)]||_0x150b2a[_0x883c5a(0x1b5)]))&&(_0x150b2a={'enumerable':!![],'get':function(){return _0x3b819a[_0x20d32d];}}),Object[_0x883c5a(0x194)](_0x5c03af,_0x7d9ace,_0x150b2a);}:function(_0x36d2b4,_0x2ed204,_0x259d79,_0x3c3f48){if(_0x3c3f48===undefined)_0x3c3f48=_0x259d79;_0x36d2b4[_0x3c3f48]=_0x2ed204[_0x259d79];}),__setModuleDefault=this&&this[a13_0x5e207a(0x17f)]||(Object['create']?function(_0x34f9c5,_0x5dddbf){const _0x52a5ee=a13_0x5e207a;Object[_0x52a5ee(0x194)](_0x34f9c5,_0x52a5ee(0x1d8),{'enumerable':!![],'value':_0x5dddbf});}:function(_0x57b1bf,_0x132d82){const _0x36726a=a13_0x5e207a;_0x57b1bf[_0x36726a(0x1d8)]=_0x132d82;}),__importStar=this&&this[a13_0x5e207a(0x1a9)]||(function(){var _0x3fe907=function(_0x35b60c){const _0x2ff1ce=a13_0x3199;return _0x3fe907=Object[_0x2ff1ce(0x18f)]||function(_0x5cb082){const _0x2debc3=_0x2ff1ce;var _0x3f9622=[];for(var _0x53b053 in _0x5cb082)if(Object[_0x2debc3(0x1bb)][_0x2debc3(0x17d)][_0x2debc3(0x19e)](_0x5cb082,_0x53b053))_0x3f9622[_0x3f9622[_0x2debc3(0x1c2)]]=_0x53b053;return _0x3f9622;},_0x3fe907(_0x35b60c);};return function(_0x542d9e){const _0x4ec680=a13_0x3199;if(_0x542d9e&&_0x542d9e[_0x4ec680(0x197)])return _0x542d9e;var _0x2df56a={};if(_0x542d9e!=null){for(var _0x411b92=_0x3fe907(_0x542d9e),_0x2ea2ea=0x0;_0x2ea2ea<_0x411b92['length'];_0x2ea2ea++)if(_0x411b92[_0x2ea2ea]!==_0x4ec680(0x1d8))__createBinding(_0x2df56a,_0x542d9e,_0x411b92[_0x2ea2ea]);}return __setModuleDefault(_0x2df56a,_0x542d9e),_0x2df56a;};}()),__importDefault=this&&this[a13_0x5e207a(0x1bf)]||function(_0x2ebe55){const _0x1128af=a13_0x5e207a;return _0x2ebe55&&_0x2ebe55[_0x1128af(0x197)]?_0x2ebe55:{'default':_0x2ebe55};};Object[a13_0x5e207a(0x194)](exports,a13_0x5e207a(0x197),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x5e207a(0x192)),database_1=__importDefault(require(a13_0x5e207a(0x1cc)));class TestGatewayController{constructor(){const _0x4a347f=a13_0x5e207a;this['getPaymentForm']=async(_0x4bb58a,_0x2fcd0f,_0x2a3b88)=>{const _0x291f6a=a13_0x3199;try{const {paymentId:_0x40020b}=_0x4bb58a['params'];console[_0x291f6a(0x184)](_0x291f6a(0x167)+_0x40020b);const _0x15bab0=await database_1[_0x291f6a(0x1d8)]['payment']['findUnique']({'where':{'id':_0x40020b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x15bab0)return _0x2fcd0f[_0x291f6a(0x1d3)](0x194)[_0x291f6a(0x1b7)]({'success':![],'message':_0x291f6a(0x1b3)});if(_0x15bab0['gateway']!=='test_gateway')return _0x2fcd0f[_0x291f6a(0x1d3)](0x190)[_0x291f6a(0x1b7)]({'success':![],'message':_0x291f6a(0x193)});if(_0x15bab0[_0x291f6a(0x1d3)]!==_0x291f6a(0x1d1))return _0x2fcd0f[_0x291f6a(0x1d3)](0x190)['json']({'success':![],'message':_0x291f6a(0x171)+_0x15bab0[_0x291f6a(0x1d3)]+_0x291f6a(0x181)});_0x2fcd0f[_0x291f6a(0x1b7)]({'success':!![],'result':{'paymentId':_0x15bab0['id'],'orderId':_0x15bab0[_0x291f6a(0x1ac)],'amount':_0x15bab0[_0x291f6a(0x1a1)],'currency':_0x15bab0[_0x291f6a(0x1c3)],'merchantName':_0x15bab0[_0x291f6a(0x16f)]['name'],'description':_0x291f6a(0x1a2)+_0x15bab0['shop']['name'],'testInstructions':{'successCard':_0x291f6a(0x16c),'failureCard':_0x291f6a(0x1d2),'expiryDate':_0x291f6a(0x1b1),'cvc':_0x291f6a(0x186),'holderName':_0x291f6a(0x1b2)}}});}catch(_0x34da78){_0x2a3b88(_0x34da78);}},this[_0x4a347f(0x18e)]=async(_0x2088be,_0x1abb7c,_0x145653)=>{const _0x418c66=_0x4a347f;try{const {paymentId:_0x5e998c}=_0x2088be[_0x418c66(0x199)],_0x3641ae=_0x2088be['body'];console[_0x418c66(0x184)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x5e998c);const _0x1ee942=await database_1[_0x418c66(0x1d8)]['payment'][_0x418c66(0x169)]({'where':{'id':_0x5e998c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ee942)return _0x1abb7c[_0x418c66(0x1d3)](0x194)[_0x418c66(0x1b7)]({'success':![],'message':_0x418c66(0x1b3)});if(_0x1ee942[_0x418c66(0x1ab)]!=='test_gateway')return _0x1abb7c[_0x418c66(0x1d3)](0x190)[_0x418c66(0x1b7)]({'success':![],'message':_0x418c66(0x193)});if(_0x1ee942[_0x418c66(0x1d3)]!==_0x418c66(0x1d1))return _0x1abb7c[_0x418c66(0x1d3)](0x190)['json']({'success':![],'message':_0x418c66(0x171)+_0x1ee942['status']+',\x20cannot\x20process'});const _0xd7d811=await this[_0x418c66(0x1ce)][_0x418c66(0x1aa)]({'paymentId':_0x1ee942['id'],'orderId':_0x1ee942[_0x418c66(0x1ac)]||_0x1ee942['id'],'amount':_0x1ee942[_0x418c66(0x1a1)],'currency':_0x1ee942[_0x418c66(0x1c3)],'cardData':_0x3641ae});console['log'](_0x418c66(0x1db),_0xd7d811);const _0x245f17={'status':_0xd7d811[_0x418c66(0x1d3)],'updatedAt':new Date()};if(_0xd7d811[_0x418c66(0x1d3)]===_0x418c66(0x1b0))_0x245f17['paidAt']=new Date(),_0x245f17[_0x418c66(0x16e)]=_0xd7d811[_0x418c66(0x188)];else _0xd7d811[_0x418c66(0x1d3)]===_0x418c66(0x1ae)&&(_0x245f17['failureMessage']=_0xd7d811[_0x418c66(0x185)]);const _0x1d67fb=_0x3641ae['cardNumber'][_0x418c66(0x1b6)](/[\s-]/g,'');_0x245f17[_0x418c66(0x183)]=_0x1d67fb[_0x418c66(0x1c0)](-0x4),_0x245f17['paymentMethod']='test_card',await database_1[_0x418c66(0x1d8)]['payment'][_0x418c66(0x1cf)]({'where':{'id':_0x1ee942['id']},'data':_0x245f17});if(_0xd7d811['status']===_0x418c66(0x1b0)&&_0x1ee942[_0x418c66(0x1bc)]){console[_0x418c66(0x184)](_0x418c66(0x1b9)+_0x1ee942['id']+_0x418c66(0x1ad));try{await database_1['default']['$transaction'](async _0x5b690d=>{const _0x56b9c4=_0x418c66,_0x12930f=await _0x5b690d[_0x56b9c4(0x17e)][_0x56b9c4(0x169)]({'where':{'id':_0x1ee942[_0x56b9c4(0x1bc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x12930f){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x12930f['id']+_0x56b9c4(0x189)+_0x12930f[_0x56b9c4(0x191)]+_0x56b9c4(0x182)+_0x12930f[_0x56b9c4(0x18c)]+_0x56b9c4(0x196)+_0x12930f[_0x56b9c4(0x1d3)]);const _0x1d5198=_0x12930f[_0x56b9c4(0x18c)]+0x1,_0x31cfd4=_0x12930f[_0x56b9c4(0x191)]==='SINGLE'?'COMPLETED':_0x12930f['status'];await _0x5b690d['paymentLink'][_0x56b9c4(0x1cf)]({'where':{'id':_0x1ee942[_0x56b9c4(0x1bc)]},'data':{'currentPayments':_0x1d5198,'status':_0x31cfd4,'updatedAt':new Date()}}),console[_0x56b9c4(0x184)](_0x56b9c4(0x17c)+_0x12930f['id']+'\x20updated:\x20currentPayments='+_0x12930f[_0x56b9c4(0x18c)]+_0x56b9c4(0x195)+_0x1d5198+_0x56b9c4(0x196)+_0x12930f[_0x56b9c4(0x1d3)]+_0x56b9c4(0x195)+_0x31cfd4);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x1ee942[_0x56b9c4(0x1bc)]+_0x56b9c4(0x1bd));});}catch(_0x257fb5){console[_0x418c66(0x1a8)](_0x418c66(0x177),_0x257fb5);}}await database_1['default']['webhookLog'][_0x418c66(0x16b)]({'data':{'paymentId':_0x1ee942['id'],'shopId':_0x1ee942[_0x418c66(0x1d7)],'event':_0x418c66(0x1c5)+_0xd7d811['status'][_0x418c66(0x1d0)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x418c66(0x1d1),'newStatus':_0xd7d811[_0x418c66(0x1d3)],'transactionId':_0xd7d811[_0x418c66(0x188)],'failureReason':_0xd7d811[_0x418c66(0x185)],'processedAt':new Date()[_0x418c66(0x1d5)]()})}}),await this['sendShopWebhook'](_0x1ee942,_0xd7d811[_0x418c66(0x1d3)],_0xd7d811[_0x418c66(0x188)],_0xd7d811[_0x418c66(0x185)]),await this[_0x418c66(0x1d4)](_0x1ee942,_0xd7d811[_0x418c66(0x1d3)]),console[_0x418c66(0x184)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x5e998c+_0x418c66(0x1da)+_0xd7d811[_0x418c66(0x1d3)]),_0xd7d811['status']===_0x418c66(0x1b0)?_0x1abb7c[_0x418c66(0x1b7)]({'success':!![],'message':_0x418c66(0x172),'result':{'status':_0x418c66(0x1b0),'transactionId':_0xd7d811[_0x418c66(0x188)],'redirectUrl':_0x1ee942[_0x418c66(0x180)]}}):_0x1abb7c[_0x418c66(0x1d3)](0x190)[_0x418c66(0x1b7)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x418c66(0x1ae),'failureReason':_0xd7d811[_0x418c66(0x185)],'redirectUrl':_0x1ee942['failUrl']}});}catch(_0x4f2d56){_0x145653(_0x4f2d56);}},this[_0x4a347f(0x1ce)]=new testGatewayService_1[(_0x4a347f(0x1c1))](),this[_0x4a347f(0x1b4)]=new webhookService_1[(_0x4a347f(0x1a0))]();}async[a13_0x5e207a(0x16d)](_0x32a993,_0x4d88cc,_0x2a762d,_0x564dd7){const _0x1a8234=a13_0x5e207a,_0x372fc4=Date['now']();try{const _0x45f72c=_0x32a993[_0x1a8234(0x16f)],_0x4acbc5=_0x45f72c['settings'];if(!_0x4acbc5?.['webhookUrl']){console[_0x1a8234(0x184)](_0x1a8234(0x19a)+_0x45f72c['id']);return;}const _0x2a4bb9=_0x4d88cc==='PAID'?_0x1a8234(0x1cd):_0x1a8234(0x1c9);let _0x30e8fe=[];if(_0x4acbc5[_0x1a8234(0x174)])try{_0x30e8fe=Array[_0x1a8234(0x173)](_0x4acbc5[_0x1a8234(0x174)])?_0x4acbc5[_0x1a8234(0x174)]:JSON['parse'](_0x4acbc5['webhookEvents']);}catch(_0x5dbcdb){console[_0x1a8234(0x1a8)](_0x1a8234(0x1a7),_0x5dbcdb),_0x30e8fe=[];}if(!_0x30e8fe[_0x1a8234(0x198)](_0x2a4bb9)){console[_0x1a8234(0x184)]('Webhook\x20event\x20'+_0x2a4bb9+_0x1a8234(0x190)+_0x45f72c['id']);return;}const _0x4e50cc={'event':_0x2a4bb9,'payment':{'id':_0x32a993['id'],'order_id':_0x32a993[_0x1a8234(0x16a)],'gateway_order_id':_0x32a993['gatewayOrderId'],'gateway':_0x1a8234(0x1ca),'amount':_0x32a993[_0x1a8234(0x1a1)],'currency':_0x32a993[_0x1a8234(0x1c3)],'status':_0x4d88cc[_0x1a8234(0x1d0)](),'customer_email':_0x32a993[_0x1a8234(0x170)],'customer_name':_0x32a993['customerName'],'transaction_id':_0x2a762d,'failure_message':_0x564dd7,'created_at':_0x32a993[_0x1a8234(0x1d6)],'updated_at':new Date()}},_0x135956=await fetch(_0x4acbc5['webhookUrl'],{'method':_0x1a8234(0x1be),'headers':{'Content-Type':_0x1a8234(0x1c6),'User-Agent':_0x1a8234(0x1a4)},'body':JSON[_0x1a8234(0x1d9)](_0x4e50cc)}),_0x43d468=Date[_0x1a8234(0x18b)]()-_0x372fc4;console[_0x1a8234(0x184)](_0x1a8234(0x1cb)+_0x4acbc5[_0x1a8234(0x1ba)]+'\x20with\x20status\x20'+_0x135956[_0x1a8234(0x1d3)]+'\x20('+_0x43d468+_0x1a8234(0x1c4));}catch(_0x21a307){console[_0x1a8234(0x1a8)](_0x1a8234(0x19d),_0x21a307);}}async[a13_0x5e207a(0x1d4)](_0x8d5dd6,_0x95fa5c){const _0x13cd59=a13_0x5e207a;try{const {telegramBotService:_0x1bcc28}=await Promise[_0x13cd59(0x1a5)]()[_0x13cd59(0x179)](()=>__importStar(require(_0x13cd59(0x1dc)))),_0x35fff1={'PAID':_0x13cd59(0x19b),'FAILED':'failed'},_0x4880db=_0x35fff1[_0x95fa5c];if(!_0x4880db)return;await _0x1bcc28[_0x13cd59(0x1a3)](_0x8d5dd6[_0x13cd59(0x1d7)],_0x8d5dd6,_0x4880db);}catch(_0x62731d){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x62731d);}}}exports[a13_0x5e207a(0x187)]=TestGatewayController;function a13_0x4b31(){const _0x440290=['toLowerCase','PENDING','Any\x20other\x20card\x20number','status','sendPaymentStatusNotification','toISOString','createdAt','shopId','default','stringify','\x20processed:\x20','üß™\x20Test\x20Gateway\x20result:','../services/telegramBotService','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','__createBinding','findUnique','orderId','create','4242\x204242\x204242\x204242','sendShopWebhook','gatewayPaymentId','shop','customerEmail','Payment\x20status\x20is\x20','Payment\x20processed\x20successfully','isArray','webhookEvents','writable','4870323RsTVEn','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','227058rrLfJK','then','36aeVMkd','924408dLlmfZ','‚úÖ\x20Payment\x20link\x20','hasOwnProperty','paymentLink','__setModuleDefault','successUrl',',\x20cannot\x20process',',\x20currentPayments=','cardLast4','log','failureReason','Any\x203-4\x20digits','TestGatewayController','transactionId',':\x20type=','258645nWftuj','now','currentPayments','22oDjUuW','processCard','getOwnPropertyNames','\x20not\x20enabled\x20for\x20shop\x20','type','../services/webhookService','Payment\x20is\x20not\x20for\x20test\x20gateway','defineProperty','\x20->\x20',',\x20status=','__esModule','includes','params','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paid','4774540dnvDUx','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','call','328134tJlepJ','WebhookService','amount','Payment\x20to\x20','sendPaymentNotification','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','resolve','getOwnPropertyDescriptor','Error\x20parsing\x20webhook\x20events:','error','__importStar','processCardPayment','gateway','gatewayOrderId','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','FAILED','3sUBoLt','PAID','Any\x20future\x20date\x20(MM/YY)','Any\x20name','Payment\x20not\x20found','webhookService','configurable','replace','json','1360557ebUrXv','üìà\x20Test\x20Gateway:\x20Payment\x20','webhookUrl','prototype','paymentLinkId','\x20not\x20found','POST','__importDefault','slice','TestGatewayService','length','currency','ms)','test_gateway_','application/json','get','21coeJmg','payment.failed','0000','Test\x20Gateway\x20webhook\x20sent\x20to\x20','../config/database','payment.success','testGatewayService','update'];a13_0x4b31=function(){return _0x440290;};return a13_0x4b31();}