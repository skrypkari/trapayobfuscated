'use strict';const a13_0x57b6bd=a13_0x1996;(function(_0x4e9029,_0x482652){const _0x702657=a13_0x1996,_0x1f846d=_0x4e9029();while(!![]){try{const _0x24e18f=parseInt(_0x702657(0x1fb))/0x1*(parseInt(_0x702657(0x213))/0x2)+parseInt(_0x702657(0x228))/0x3*(-parseInt(_0x702657(0x21a))/0x4)+-parseInt(_0x702657(0x1f7))/0x5+-parseInt(_0x702657(0x23f))/0x6*(parseInt(_0x702657(0x237))/0x7)+-parseInt(_0x702657(0x1f9))/0x8+-parseInt(_0x702657(0x241))/0x9*(parseInt(_0x702657(0x1e5))/0xa)+parseInt(_0x702657(0x1da))/0xb;if(_0x24e18f===_0x482652)break;else _0x1f846d['push'](_0x1f846d['shift']());}catch(_0x83d279){_0x1f846d['push'](_0x1f846d['shift']());}}}(a13_0x4510,0x1ac22));function a13_0x4510(){const _0x368281=['\x20->\x20','850602suqHCI','default','122643abergQ','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20',',\x20currentPayments=','../services/gateways/testGatewayService','stringify','sendShopWebhook','toLowerCase','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20not\x20enabled\x20for\x20shop\x20','Any\x20future\x20date\x20(MM/YY)','TestGatewayService','webhookEvents','body','test_gateway','create','9306011tdtKIV','application/json','4242\x204242\x204242\x204242','Payment\x20status\x20is\x20','üìà\x20Test\x20Gateway:\x20Payment\x20','call','cardLast4','PAID','sendPaymentNotification','Any\x20name','json','150NUYape','orderId','configurable','__importDefault','webhookService','üìà\x20Found\x20payment\x20link\x20','$transaction','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','now','update','paidAt','prototype','test_gateway_','../services/telegramBotService','TestGatewayController','payment.success','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','findUnique','574290RDRloi','params','1070736FViGca','testGatewayService','179ClapLg','paid','gateway','FAILED','0000','replace','‚úÖ\x20Payment\x20link\x20','shopId','payment','length','test_card','settings','ms)','__createBinding','customerEmail','sendPaymentStatusNotification','Payment\x20to\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','‚úÖ\x20Test\x20Gateway\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PENDING','Error\x20parsing\x20webhook\x20events:','üß™\x20Test\x20Gateway\x20result:','payment.failed','746OdAvjK','status',',\x20cannot\x20process',':\x20type=','successUrl','toISOString','getOwnPropertyDescriptor','833176JSlMVQ','log','name','paymentLink','paymentMethod','webhookUrl','cardNumber','Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20not\x20found','amount','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','error','currency','../services/webhookService','3XZgpMn','shop','failureMessage',',\x20status=','resolve','getPaymentForm','transactionId','Payment\x20failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__esModule','createdAt','Payment\x20not\x20found','paymentLinkId','gatewayOrderId','Any\x203-4\x20digits','7AgmXgX','currentPayments','\x20with\x20status\x20','get','defineProperty','type','failureReason'];a13_0x4510=function(){return _0x368281;};return a13_0x4510();}function a13_0x1996(_0xc90806,_0x5b8f64){const _0x451053=a13_0x4510();return a13_0x1996=function(_0x19961e,_0x409a3e){_0x19961e=_0x19961e-0x1ce;let _0x135536=_0x451053[_0x19961e];return _0x135536;},a13_0x1996(_0xc90806,_0x5b8f64);}var __createBinding=this&&this[a13_0x57b6bd(0x208)]||(Object[a13_0x57b6bd(0x1d9)]?function(_0x579205,_0x5adeac,_0x33ff11,_0x50a638){const _0x16df22=a13_0x57b6bd;if(_0x50a638===undefined)_0x50a638=_0x33ff11;var _0x57dfe9=Object[_0x16df22(0x219)](_0x5adeac,_0x33ff11);(!_0x57dfe9||(_0x16df22(0x23a)in _0x57dfe9?!_0x5adeac[_0x16df22(0x231)]:_0x57dfe9['writable']||_0x57dfe9[_0x16df22(0x1e7)]))&&(_0x57dfe9={'enumerable':!![],'get':function(){return _0x5adeac[_0x33ff11];}}),Object[_0x16df22(0x23b)](_0x579205,_0x50a638,_0x57dfe9);}:function(_0x45400d,_0x275d76,_0x2c5fdd,_0x519e9f){if(_0x519e9f===undefined)_0x519e9f=_0x2c5fdd;_0x45400d[_0x519e9f]=_0x275d76[_0x2c5fdd];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x57b6bd(0x1d9)]?function(_0x520c91,_0x38df28){const _0x34c894=a13_0x57b6bd;Object[_0x34c894(0x23b)](_0x520c91,_0x34c894(0x240),{'enumerable':!![],'value':_0x38df28});}:function(_0x13f08b,_0x4a0c9b){_0x13f08b['default']=_0x4a0c9b;}),__importStar=this&&this['__importStar']||(function(){var _0x477644=function(_0x2c4443){return _0x477644=Object['getOwnPropertyNames']||function(_0x27eb91){const _0x2c1529=a13_0x1996;var _0x36401b=[];for(var _0xbd9211 in _0x27eb91)if(Object[_0x2c1529(0x1f0)]['hasOwnProperty'][_0x2c1529(0x1df)](_0x27eb91,_0xbd9211))_0x36401b[_0x36401b[_0x2c1529(0x204)]]=_0xbd9211;return _0x36401b;},_0x477644(_0x2c4443);};return function(_0x1bfcd0){const _0x97d6a3=a13_0x1996;if(_0x1bfcd0&&_0x1bfcd0[_0x97d6a3(0x231)])return _0x1bfcd0;var _0x3d38c1={};if(_0x1bfcd0!=null){for(var _0x1ef8e8=_0x477644(_0x1bfcd0),_0x15ff88=0x0;_0x15ff88<_0x1ef8e8[_0x97d6a3(0x204)];_0x15ff88++)if(_0x1ef8e8[_0x15ff88]!==_0x97d6a3(0x240))__createBinding(_0x3d38c1,_0x1bfcd0,_0x1ef8e8[_0x15ff88]);}return __setModuleDefault(_0x3d38c1,_0x1bfcd0),_0x3d38c1;};}()),__importDefault=this&&this[a13_0x57b6bd(0x1e8)]||function(_0xc088b5){const _0x558112=a13_0x57b6bd;return _0xc088b5&&_0xc088b5[_0x558112(0x231)]?_0xc088b5:{'default':_0xc088b5};};Object[a13_0x57b6bd(0x23b)](exports,a13_0x57b6bd(0x231),{'value':!![]}),exports[a13_0x57b6bd(0x1f3)]=void 0x0;const testGatewayService_1=require(a13_0x57b6bd(0x1ce)),webhookService_1=require(a13_0x57b6bd(0x227)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x4de35f=a13_0x57b6bd;this[_0x4de35f(0x22d)]=async(_0x427ac6,_0x4b87b5,_0xea3ad0)=>{const _0x4a5b66=_0x4de35f;try{const {paymentId:_0x1eb573}=_0x427ac6[_0x4a5b66(0x1f8)];console[_0x4a5b66(0x21b)](_0x4a5b66(0x224)+_0x1eb573);const _0x17f162=await database_1[_0x4a5b66(0x240)][_0x4a5b66(0x203)]['findUnique']({'where':{'id':_0x1eb573},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x17f162)return _0x4b87b5['status'](0x194)[_0x4a5b66(0x1e4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x17f162['gateway']!==_0x4a5b66(0x1d8))return _0x4b87b5[_0x4a5b66(0x214)](0x190)['json']({'success':![],'message':_0x4a5b66(0x20c)});if(_0x17f162[_0x4a5b66(0x214)]!==_0x4a5b66(0x20f))return _0x4b87b5[_0x4a5b66(0x214)](0x190)[_0x4a5b66(0x1e4)]({'success':![],'message':_0x4a5b66(0x1dd)+_0x17f162[_0x4a5b66(0x214)]+_0x4a5b66(0x215)});_0x4b87b5[_0x4a5b66(0x1e4)]({'success':!![],'result':{'paymentId':_0x17f162['id'],'orderId':_0x17f162['gatewayOrderId'],'amount':_0x17f162[_0x4a5b66(0x223)],'currency':_0x17f162[_0x4a5b66(0x226)],'merchantName':_0x17f162[_0x4a5b66(0x229)][_0x4a5b66(0x21c)],'description':_0x4a5b66(0x20b)+_0x17f162[_0x4a5b66(0x229)][_0x4a5b66(0x21c)],'testInstructions':{'successCard':_0x4a5b66(0x1dc),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x4a5b66(0x1d4),'cvc':_0x4a5b66(0x236),'holderName':_0x4a5b66(0x1e3)}}});}catch(_0x409288){_0xea3ad0(_0x409288);}},this['processCard']=async(_0xd09f32,_0x367964,_0xc661dd)=>{const _0xca226c=_0x4de35f;try{const {paymentId:_0x1b1f67}=_0xd09f32[_0xca226c(0x1f8)],_0x40cb2e=_0xd09f32[_0xca226c(0x1d7)];console[_0xca226c(0x21b)](_0xca226c(0x242)+_0x1b1f67);const _0x2f4486=await database_1[_0xca226c(0x240)][_0xca226c(0x203)][_0xca226c(0x1f6)]({'where':{'id':_0x1b1f67},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f4486)return _0x367964['status'](0x194)[_0xca226c(0x1e4)]({'success':![],'message':_0xca226c(0x233)});if(_0x2f4486[_0xca226c(0x1fd)]!=='test_gateway')return _0x367964['status'](0x190)[_0xca226c(0x1e4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2f4486[_0xca226c(0x214)]!=='PENDING')return _0x367964['status'](0x190)[_0xca226c(0x1e4)]({'success':![],'message':_0xca226c(0x1dd)+_0x2f4486[_0xca226c(0x214)]+',\x20cannot\x20process'});const _0x3feef8=await this[_0xca226c(0x1fa)]['processCardPayment']({'paymentId':_0x2f4486['id'],'orderId':_0x2f4486[_0xca226c(0x235)]||_0x2f4486['id'],'amount':_0x2f4486['amount'],'currency':_0x2f4486[_0xca226c(0x226)],'cardData':_0x40cb2e});console[_0xca226c(0x21b)](_0xca226c(0x211),_0x3feef8);const _0x3b62c1={'status':_0x3feef8[_0xca226c(0x214)],'updatedAt':new Date()};if(_0x3feef8[_0xca226c(0x214)]===_0xca226c(0x1e1))_0x3b62c1[_0xca226c(0x1ef)]=new Date(),_0x3b62c1['gatewayPaymentId']=_0x3feef8[_0xca226c(0x22e)];else _0x3feef8[_0xca226c(0x214)]===_0xca226c(0x1fe)&&(_0x3b62c1[_0xca226c(0x22a)]=_0x3feef8['failureReason']);const _0x16256a=_0x40cb2e[_0xca226c(0x220)][_0xca226c(0x200)](/[\s-]/g,'');_0x3b62c1[_0xca226c(0x1e0)]=_0x16256a['slice'](-0x4),_0x3b62c1[_0xca226c(0x21e)]=_0xca226c(0x205),await database_1[_0xca226c(0x240)][_0xca226c(0x203)][_0xca226c(0x1ee)]({'where':{'id':_0x2f4486['id']},'data':_0x3b62c1});if(_0x3feef8['status']==='PAID'&&_0x2f4486['paymentLinkId']){console[_0xca226c(0x21b)](_0xca226c(0x1de)+_0x2f4486['id']+_0xca226c(0x1ec));try{await database_1[_0xca226c(0x240)][_0xca226c(0x1eb)](async _0x5dd3f5=>{const _0x2743ce=_0xca226c,_0x1c1910=await _0x5dd3f5[_0x2743ce(0x21d)][_0x2743ce(0x1f6)]({'where':{'id':_0x2f4486[_0x2743ce(0x234)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1c1910){console[_0x2743ce(0x21b)](_0x2743ce(0x1ea)+_0x1c1910['id']+_0x2743ce(0x216)+_0x1c1910[_0x2743ce(0x23c)]+_0x2743ce(0x243)+_0x1c1910[_0x2743ce(0x238)]+_0x2743ce(0x22b)+_0x1c1910[_0x2743ce(0x214)]);const _0x518c4e=_0x1c1910[_0x2743ce(0x238)]+0x1,_0x56efb7=_0x1c1910[_0x2743ce(0x23c)]==='SINGLE'?'COMPLETED':_0x1c1910[_0x2743ce(0x214)];await _0x5dd3f5[_0x2743ce(0x21d)]['update']({'where':{'id':_0x2f4486['paymentLinkId']},'data':{'currentPayments':_0x518c4e,'status':_0x56efb7,'updatedAt':new Date()}}),console['log'](_0x2743ce(0x201)+_0x1c1910['id']+'\x20updated:\x20currentPayments='+_0x1c1910[_0x2743ce(0x238)]+_0x2743ce(0x23e)+_0x518c4e+_0x2743ce(0x22b)+_0x1c1910[_0x2743ce(0x214)]+'\x20->\x20'+_0x56efb7);}else console[_0x2743ce(0x21b)]('‚ùå\x20Payment\x20link\x20'+_0x2f4486[_0x2743ce(0x234)]+_0x2743ce(0x222));});}catch(_0x5d8399){console[_0xca226c(0x225)](_0xca226c(0x1d2),_0x5d8399);}}await database_1[_0xca226c(0x240)]['webhookLog'][_0xca226c(0x1d9)]({'data':{'paymentId':_0x2f4486['id'],'shopId':_0x2f4486[_0xca226c(0x202)],'event':_0xca226c(0x1f1)+_0x3feef8[_0xca226c(0x214)][_0xca226c(0x1d1)](),'statusCode':0xc8,'responseBody':JSON[_0xca226c(0x1cf)]({'oldStatus':_0xca226c(0x20f),'newStatus':_0x3feef8[_0xca226c(0x214)],'transactionId':_0x3feef8[_0xca226c(0x22e)],'failureReason':_0x3feef8[_0xca226c(0x23d)],'processedAt':new Date()[_0xca226c(0x218)]()})}}),await this[_0xca226c(0x1d0)](_0x2f4486,_0x3feef8[_0xca226c(0x214)],_0x3feef8[_0xca226c(0x22e)],_0x3feef8[_0xca226c(0x23d)]),await this[_0xca226c(0x20a)](_0x2f4486,_0x3feef8[_0xca226c(0x214)]),console[_0xca226c(0x21b)](_0xca226c(0x20d)+_0x1b1f67+'\x20processed:\x20'+_0x3feef8[_0xca226c(0x214)]),_0x3feef8['status']==='PAID'?_0x367964[_0xca226c(0x1e4)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x3feef8[_0xca226c(0x22e)],'redirectUrl':_0x2f4486[_0xca226c(0x217)]}}):_0x367964['status'](0x190)[_0xca226c(0x1e4)]({'success':![],'message':_0xca226c(0x22f),'result':{'status':_0xca226c(0x1fe),'failureReason':_0x3feef8[_0xca226c(0x23d)],'redirectUrl':_0x2f4486['failUrl']}});}catch(_0x4603b0){_0xc661dd(_0x4603b0);}},this[_0x4de35f(0x1fa)]=new testGatewayService_1[(_0x4de35f(0x1d5))](),this[_0x4de35f(0x1e9)]=new webhookService_1['WebhookService']();}async[a13_0x57b6bd(0x1d0)](_0x26b3bc,_0x504fa5,_0x1fdd7d,_0x16227f){const _0x5c3a78=a13_0x57b6bd,_0x285114=Date['now']();try{const _0x4a57e7=_0x26b3bc[_0x5c3a78(0x229)],_0x1049a9=_0x4a57e7[_0x5c3a78(0x206)];if(!_0x1049a9?.['webhookUrl']){console[_0x5c3a78(0x21b)](_0x5c3a78(0x230)+_0x4a57e7['id']);return;}const _0x52e22d=_0x504fa5===_0x5c3a78(0x1e1)?_0x5c3a78(0x1f4):_0x5c3a78(0x212);let _0x2fa12c=[];if(_0x1049a9[_0x5c3a78(0x1d6)])try{_0x2fa12c=Array['isArray'](_0x1049a9['webhookEvents'])?_0x1049a9['webhookEvents']:JSON['parse'](_0x1049a9[_0x5c3a78(0x1d6)]);}catch(_0x3514e4){console[_0x5c3a78(0x225)](_0x5c3a78(0x210),_0x3514e4),_0x2fa12c=[];}if(!_0x2fa12c['includes'](_0x52e22d)){console[_0x5c3a78(0x21b)]('Webhook\x20event\x20'+_0x52e22d+_0x5c3a78(0x1d3)+_0x4a57e7['id']);return;}const _0x2919d4={'event':_0x52e22d,'payment':{'id':_0x26b3bc['id'],'order_id':_0x26b3bc[_0x5c3a78(0x1e6)],'gateway_order_id':_0x26b3bc[_0x5c3a78(0x235)],'gateway':_0x5c3a78(0x1ff),'amount':_0x26b3bc[_0x5c3a78(0x223)],'currency':_0x26b3bc[_0x5c3a78(0x226)],'status':_0x504fa5[_0x5c3a78(0x1d1)](),'customer_email':_0x26b3bc[_0x5c3a78(0x209)],'customer_name':_0x26b3bc['customerName'],'transaction_id':_0x1fdd7d,'failure_message':_0x16227f,'created_at':_0x26b3bc[_0x5c3a78(0x232)],'updated_at':new Date()}},_0x536330=await fetch(_0x1049a9[_0x5c3a78(0x21f)],{'method':'POST','headers':{'Content-Type':_0x5c3a78(0x1db),'User-Agent':_0x5c3a78(0x1f5)},'body':JSON['stringify'](_0x2919d4)}),_0x164dd1=Date[_0x5c3a78(0x1ed)]()-_0x285114;console[_0x5c3a78(0x21b)](_0x5c3a78(0x221)+_0x1049a9[_0x5c3a78(0x21f)]+_0x5c3a78(0x239)+_0x536330[_0x5c3a78(0x214)]+'\x20('+_0x164dd1+_0x5c3a78(0x207));}catch(_0x528e20){console[_0x5c3a78(0x225)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x528e20);}}async['sendPaymentStatusNotification'](_0x3ef9ee,_0xfa79bd){const _0x20c9f0=a13_0x57b6bd;try{const {telegramBotService:_0x31b4d8}=await Promise[_0x20c9f0(0x22c)]()['then'](()=>__importStar(require(_0x20c9f0(0x1f2)))),_0x5095af={'PAID':_0x20c9f0(0x1fc),'FAILED':'failed'},_0x3e58c1=_0x5095af[_0xfa79bd];if(!_0x3e58c1)return;await _0x31b4d8[_0x20c9f0(0x1e2)](_0x3ef9ee[_0x20c9f0(0x202)],_0x3ef9ee,_0x3e58c1);}catch(_0x144645){console['error'](_0x20c9f0(0x20e),_0x144645);}}}exports[a13_0x57b6bd(0x1f3)]=TestGatewayController;