'use strict';function a13_0x34b9(){const _0x17459a=['paid','update','paymentMethod','payment.success','stringify','getOwnPropertyNames','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','0000','payment','__importStar','sendPaymentStatusNotification','createdAt','Any\x20future\x20date\x20(MM/YY)','Payment\x20to\x20','40MbnNZO','includes','TestGatewayController','ðŸ§ª\x20Test\x20Gateway\x20result:','toISOString','328XtEtlk','name','application/json','Payment\x20processed\x20successfully','__createBinding','paidAt','âœ…\x20Test\x20Gateway\x20payment\x20','Error\x20parsing\x20webhook\x20events:','create','webhookLog','status','__esModule','cardNumber','prototype','currency','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','ms)','4205UWmOHm','processCardPayment','getOwnPropertyDescriptor','webhookUrl','sendShopWebhook','amount','../services/telegramBotService','7302gGVZhl','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importDefault','slice','PAID','TestGatewayService','hasOwnProperty','transactionId','processCard','6701497GvElNG','test_card','json','Payment\x20failed','2229OdEdhl','215748LzkJfz','2148bcGsza','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','5439028baZkXP','successUrl','Payment\x20is\x20not\x20for\x20test\x20gateway','../services/gateways/testGatewayService','webhookEvents','failureMessage','__setModuleDefault','PENDING','payment.failed','now','sendPaymentNotification','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','gatewayPaymentId','defineProperty','testGatewayService','FAILED','gateway','default','Any\x20other\x20card\x20number','Payment\x20not\x20found','869828XSKCIK','\x20processed:\x20','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shop','error','findUnique','1469354tgwrRk',',\x20cannot\x20process','Any\x203-4\x20digits','test_gateway','Payment\x20status\x20is\x20','log','params','Test\x20Gateway\x20webhook\x20sent\x20to\x20','configurable','\x20not\x20enabled\x20for\x20shop\x20','failureReason','orderId','shopId','length','customerEmail','body','gatewayOrderId','toLowerCase'];a13_0x34b9=function(){return _0x17459a;};return a13_0x34b9();}const a13_0x396c17=a13_0x40a1;(function(_0x1e50e9,_0x3f6a89){const _0x262637=a13_0x40a1,_0x3715d6=_0x1e50e9();while(!![]){try{const _0x3b2346=-parseInt(_0x262637(0x125))/0x1+parseInt(_0x262637(0x12c))/0x2+parseInt(_0x262637(0x10d))/0x3*(parseInt(_0x262637(0x10f))/0x4)+-parseInt(_0x262637(0x162))/0x5*(-parseInt(_0x262637(0x169))/0x6)+parseInt(_0x262637(0x111))/0x7+-parseInt(_0x262637(0x151))/0x8*(-parseInt(_0x262637(0x10e))/0x9)+parseInt(_0x262637(0x14c))/0xa*(-parseInt(_0x262637(0x109))/0xb);if(_0x3b2346===_0x3f6a89)break;else _0x3715d6['push'](_0x3715d6['shift']());}catch(_0x91af4a){_0x3715d6['push'](_0x3715d6['shift']());}}}(a13_0x34b9,0x94fed));function a13_0x40a1(_0x35d83f,_0x119f04){const _0x34b951=a13_0x34b9();return a13_0x40a1=function(_0x40a1b4,_0x508b97){_0x40a1b4=_0x40a1b4-0x109;let _0x440e03=_0x34b951[_0x40a1b4];return _0x440e03;},a13_0x40a1(_0x35d83f,_0x119f04);}var __createBinding=this&&this[a13_0x396c17(0x155)]||(Object['create']?function(_0x3728e5,_0x564a80,_0x4dd722,_0x3e37cb){const _0x2703db=a13_0x396c17;if(_0x3e37cb===undefined)_0x3e37cb=_0x4dd722;var _0x53e0c9=Object[_0x2703db(0x164)](_0x564a80,_0x4dd722);(!_0x53e0c9||('get'in _0x53e0c9?!_0x564a80[_0x2703db(0x15c)]:_0x53e0c9['writable']||_0x53e0c9[_0x2703db(0x134)]))&&(_0x53e0c9={'enumerable':!![],'get':function(){return _0x564a80[_0x4dd722];}}),Object['defineProperty'](_0x3728e5,_0x3e37cb,_0x53e0c9);}:function(_0x5137a9,_0x495361,_0xd426fc,_0x784927){if(_0x784927===undefined)_0x784927=_0xd426fc;_0x5137a9[_0x784927]=_0x495361[_0xd426fc];}),__setModuleDefault=this&&this[a13_0x396c17(0x117)]||(Object[a13_0x396c17(0x159)]?function(_0x1851dd,_0x286df5){const _0x1aaac9=a13_0x396c17;Object[_0x1aaac9(0x11e)](_0x1851dd,_0x1aaac9(0x122),{'enumerable':!![],'value':_0x286df5});}:function(_0x19022f,_0x12ddb5){const _0x208e0d=a13_0x396c17;_0x19022f[_0x208e0d(0x122)]=_0x12ddb5;}),__importStar=this&&this[a13_0x396c17(0x147)]||(function(){var _0x2fff41=function(_0x53c091){const _0x500dd4=a13_0x40a1;return _0x2fff41=Object[_0x500dd4(0x143)]||function(_0x1365bf){const _0x205fd2=_0x500dd4;var _0xfa4ba1=[];for(var _0x5ac4b6 in _0x1365bf)if(Object[_0x205fd2(0x15e)][_0x205fd2(0x16f)]['call'](_0x1365bf,_0x5ac4b6))_0xfa4ba1[_0xfa4ba1[_0x205fd2(0x139)]]=_0x5ac4b6;return _0xfa4ba1;},_0x2fff41(_0x53c091);};return function(_0x178e9f){const _0x54edac=a13_0x40a1;if(_0x178e9f&&_0x178e9f['__esModule'])return _0x178e9f;var _0x5da566={};if(_0x178e9f!=null){for(var _0x897092=_0x2fff41(_0x178e9f),_0x39a461=0x0;_0x39a461<_0x897092[_0x54edac(0x139)];_0x39a461++)if(_0x897092[_0x39a461]!==_0x54edac(0x122))__createBinding(_0x5da566,_0x178e9f,_0x897092[_0x39a461]);}return __setModuleDefault(_0x5da566,_0x178e9f),_0x5da566;};}()),__importDefault=this&&this[a13_0x396c17(0x16b)]||function(_0x41b510){const _0x4f1856=a13_0x396c17;return _0x41b510&&_0x41b510[_0x4f1856(0x15c)]?_0x41b510:{'default':_0x41b510};};Object[a13_0x396c17(0x11e)](exports,a13_0x396c17(0x15c),{'value':!![]}),exports[a13_0x396c17(0x14e)]=void 0x0;const testGatewayService_1=require(a13_0x396c17(0x114)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x138939=a13_0x396c17;this['getPaymentForm']=async(_0x36cd2b,_0x1aa7ce,_0x419755)=>{const _0x4889e6=a13_0x40a1;try{const {paymentId:_0x57977f}=_0x36cd2b[_0x4889e6(0x132)];console['log'](_0x4889e6(0x144)+_0x57977f);const _0x2ba697=await database_1[_0x4889e6(0x122)][_0x4889e6(0x146)][_0x4889e6(0x12b)]({'where':{'id':_0x57977f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2ba697)return _0x1aa7ce['status'](0x194)[_0x4889e6(0x10b)]({'success':![],'message':_0x4889e6(0x124)});if(_0x2ba697['gateway']!==_0x4889e6(0x12f))return _0x1aa7ce[_0x4889e6(0x15b)](0x190)[_0x4889e6(0x10b)]({'success':![],'message':_0x4889e6(0x113)});if(_0x2ba697[_0x4889e6(0x15b)]!==_0x4889e6(0x118))return _0x1aa7ce[_0x4889e6(0x15b)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2ba697['status']+_0x4889e6(0x12d)});_0x1aa7ce[_0x4889e6(0x10b)]({'success':!![],'result':{'paymentId':_0x2ba697['id'],'orderId':_0x2ba697[_0x4889e6(0x13c)],'amount':_0x2ba697[_0x4889e6(0x167)],'currency':_0x2ba697[_0x4889e6(0x15f)],'merchantName':_0x2ba697[_0x4889e6(0x129)][_0x4889e6(0x152)],'description':_0x4889e6(0x14b)+_0x2ba697[_0x4889e6(0x129)][_0x4889e6(0x152)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x4889e6(0x123),'expiryDate':_0x4889e6(0x14a),'cvc':_0x4889e6(0x12e),'holderName':'Any\x20name'}}});}catch(_0x2c24b8){_0x419755(_0x2c24b8);}},this[_0x138939(0x171)]=async(_0x4de318,_0x4920cb,_0x3ac973)=>{const _0xb99a3a=_0x138939;try{const {paymentId:_0x1bbe62}=_0x4de318['params'],_0x29c035=_0x4de318[_0xb99a3a(0x13b)];console[_0xb99a3a(0x131)](_0xb99a3a(0x16a)+_0x1bbe62);const _0x22504b=await database_1[_0xb99a3a(0x122)][_0xb99a3a(0x146)]['findUnique']({'where':{'id':_0x1bbe62},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22504b)return _0x4920cb[_0xb99a3a(0x15b)](0x194)[_0xb99a3a(0x10b)]({'success':![],'message':_0xb99a3a(0x124)});if(_0x22504b[_0xb99a3a(0x121)]!==_0xb99a3a(0x12f))return _0x4920cb[_0xb99a3a(0x15b)](0x190)[_0xb99a3a(0x10b)]({'success':![],'message':_0xb99a3a(0x113)});if(_0x22504b['status']!==_0xb99a3a(0x118))return _0x4920cb[_0xb99a3a(0x15b)](0x190)[_0xb99a3a(0x10b)]({'success':![],'message':_0xb99a3a(0x130)+_0x22504b[_0xb99a3a(0x15b)]+',\x20cannot\x20process'});const _0x2f621e=await this[_0xb99a3a(0x11f)][_0xb99a3a(0x163)]({'paymentId':_0x22504b['id'],'orderId':_0x22504b[_0xb99a3a(0x13c)]||_0x22504b['id'],'amount':_0x22504b['amount'],'currency':_0x22504b['currency'],'cardData':_0x29c035});console[_0xb99a3a(0x131)](_0xb99a3a(0x14f),_0x2f621e);const _0x207c1a={'status':_0x2f621e[_0xb99a3a(0x15b)],'updatedAt':new Date()};if(_0x2f621e[_0xb99a3a(0x15b)]===_0xb99a3a(0x16d))_0x207c1a[_0xb99a3a(0x156)]=new Date(),_0x207c1a[_0xb99a3a(0x11d)]=_0x2f621e['transactionId'];else _0x2f621e[_0xb99a3a(0x15b)]===_0xb99a3a(0x120)&&(_0x207c1a[_0xb99a3a(0x116)]=_0x2f621e[_0xb99a3a(0x136)]);const _0x5c61ad=_0x29c035[_0xb99a3a(0x15d)]['replace'](/[\s-]/g,'');_0x207c1a['cardLast4']=_0x5c61ad[_0xb99a3a(0x16c)](-0x4),_0x207c1a[_0xb99a3a(0x140)]=_0xb99a3a(0x10a),await database_1['default']['payment'][_0xb99a3a(0x13f)]({'where':{'id':_0x22504b['id']},'data':_0x207c1a}),await database_1[_0xb99a3a(0x122)][_0xb99a3a(0x15a)][_0xb99a3a(0x159)]({'data':{'paymentId':_0x22504b['id'],'shopId':_0x22504b[_0xb99a3a(0x138)],'event':'test_gateway_'+_0x2f621e[_0xb99a3a(0x15b)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xb99a3a(0x118),'newStatus':_0x2f621e['status'],'transactionId':_0x2f621e[_0xb99a3a(0x170)],'failureReason':_0x2f621e[_0xb99a3a(0x136)],'processedAt':new Date()[_0xb99a3a(0x150)]()})}}),await this[_0xb99a3a(0x166)](_0x22504b,_0x2f621e['status'],_0x2f621e[_0xb99a3a(0x170)],_0x2f621e[_0xb99a3a(0x136)]),await this['sendPaymentStatusNotification'](_0x22504b,_0x2f621e[_0xb99a3a(0x15b)]),console[_0xb99a3a(0x131)](_0xb99a3a(0x157)+_0x1bbe62+_0xb99a3a(0x126)+_0x2f621e[_0xb99a3a(0x15b)]),_0x2f621e[_0xb99a3a(0x15b)]===_0xb99a3a(0x16d)?_0x4920cb[_0xb99a3a(0x10b)]({'success':!![],'message':_0xb99a3a(0x154),'result':{'status':'PAID','transactionId':_0x2f621e[_0xb99a3a(0x170)],'redirectUrl':_0x22504b[_0xb99a3a(0x112)]}}):_0x4920cb[_0xb99a3a(0x15b)](0x190)[_0xb99a3a(0x10b)]({'success':![],'message':_0xb99a3a(0x10c),'result':{'status':_0xb99a3a(0x120),'failureReason':_0x2f621e[_0xb99a3a(0x136)],'redirectUrl':_0x22504b['failUrl']}});}catch(_0x868e54){_0x3ac973(_0x868e54);}},this[_0x138939(0x11f)]=new testGatewayService_1[(_0x138939(0x16e))](),this['webhookService']=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x457eca,_0x45ce55,_0x72dad8,_0x2c5396){const _0x20b701=a13_0x396c17,_0x1cc1b5=Date[_0x20b701(0x11a)]();try{const _0x12204b=_0x457eca['shop'],_0x835788=_0x12204b['settings'];if(!_0x835788?.['webhookUrl']){console['log'](_0x20b701(0x110)+_0x12204b['id']);return;}const _0x1671f8=_0x45ce55===_0x20b701(0x16d)?_0x20b701(0x141):_0x20b701(0x119);let _0x54e2d2=[];if(_0x835788[_0x20b701(0x115)])try{_0x54e2d2=Array['isArray'](_0x835788[_0x20b701(0x115)])?_0x835788[_0x20b701(0x115)]:JSON['parse'](_0x835788[_0x20b701(0x115)]);}catch(_0x9da3b9){console[_0x20b701(0x12a)](_0x20b701(0x158),_0x9da3b9),_0x54e2d2=[];}if(!_0x54e2d2[_0x20b701(0x14d)](_0x1671f8)){console[_0x20b701(0x131)]('Webhook\x20event\x20'+_0x1671f8+_0x20b701(0x135)+_0x12204b['id']);return;}const _0x38ce15={'event':_0x1671f8,'payment':{'id':_0x457eca['id'],'order_id':_0x457eca[_0x20b701(0x137)],'gateway_order_id':_0x457eca[_0x20b701(0x13c)],'gateway':_0x20b701(0x145),'amount':_0x457eca[_0x20b701(0x167)],'currency':_0x457eca[_0x20b701(0x15f)],'status':_0x45ce55[_0x20b701(0x13d)](),'customer_email':_0x457eca[_0x20b701(0x13a)],'customer_name':_0x457eca['customerName'],'transaction_id':_0x72dad8,'failure_message':_0x2c5396,'created_at':_0x457eca[_0x20b701(0x149)],'updated_at':new Date()}},_0x2022be=await fetch(_0x835788[_0x20b701(0x165)],{'method':'POST','headers':{'Content-Type':_0x20b701(0x153),'User-Agent':_0x20b701(0x160)},'body':JSON[_0x20b701(0x142)](_0x38ce15)}),_0x107dce=Date[_0x20b701(0x11a)]()-_0x1cc1b5;console['log'](_0x20b701(0x133)+_0x835788[_0x20b701(0x165)]+'\x20with\x20status\x20'+_0x2022be[_0x20b701(0x15b)]+'\x20('+_0x107dce+_0x20b701(0x161));}catch(_0x1b6ce1){console[_0x20b701(0x12a)](_0x20b701(0x11c),_0x1b6ce1);}}async[a13_0x396c17(0x148)](_0x59229a,_0x92121e){const _0x22548a=a13_0x396c17;try{const {telegramBotService:_0x56e4e5}=await Promise['resolve']()['then'](()=>__importStar(require(_0x22548a(0x168)))),_0x5c62fe={'PAID':_0x22548a(0x13e),'FAILED':_0x22548a(0x127)},_0x9df320=_0x5c62fe[_0x92121e];if(!_0x9df320)return;await _0x56e4e5[_0x22548a(0x11b)](_0x59229a[_0x22548a(0x138)],_0x59229a,_0x9df320);}catch(_0x3df2d2){console['error'](_0x22548a(0x128),_0x3df2d2);}}}exports['TestGatewayController']=TestGatewayController;