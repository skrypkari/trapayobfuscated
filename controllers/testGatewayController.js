'use strict';const a13_0x2dd94d=a13_0x20ac;function a13_0x20ac(_0x3d53c0,_0x265068){const _0x29f5ec=a13_0x29f5();return a13_0x20ac=function(_0x20ac43,_0xf51a1a){_0x20ac43=_0x20ac43-0xb6;let _0x179ca4=_0x29f5ec[_0x20ac43];return _0x179ca4;},a13_0x20ac(_0x3d53c0,_0x265068);}(function(_0x39d41a,_0x4ee72f){const _0x38791e=a13_0x20ac,_0x463a1d=_0x39d41a();while(!![]){try{const _0x50d537=-parseInt(_0x38791e(0x106))/0x1+parseInt(_0x38791e(0xfc))/0x2*(-parseInt(_0x38791e(0xc1))/0x3)+-parseInt(_0x38791e(0x119))/0x4+parseInt(_0x38791e(0xfe))/0x5*(parseInt(_0x38791e(0x115))/0x6)+-parseInt(_0x38791e(0xc5))/0x7+-parseInt(_0x38791e(0x118))/0x8*(-parseInt(_0x38791e(0xe0))/0x9)+parseInt(_0x38791e(0xcb))/0xa;if(_0x50d537===_0x4ee72f)break;else _0x463a1d['push'](_0x463a1d['shift']());}catch(_0x9d4824){_0x463a1d['push'](_0x463a1d['shift']());}}}(a13_0x29f5,0x4d509));var __createBinding=this&&this[a13_0x2dd94d(0xe6)]||(Object[a13_0x2dd94d(0xcd)]?function(_0x55cefe,_0x5ef4c1,_0x480cd6,_0x3344a3){const _0x38d54c=a13_0x2dd94d;if(_0x3344a3===undefined)_0x3344a3=_0x480cd6;var _0x1d1d56=Object[_0x38d54c(0xba)](_0x5ef4c1,_0x480cd6);(!_0x1d1d56||('get'in _0x1d1d56?!_0x5ef4c1[_0x38d54c(0x110)]:_0x1d1d56[_0x38d54c(0xc2)]||_0x1d1d56['configurable']))&&(_0x1d1d56={'enumerable':!![],'get':function(){return _0x5ef4c1[_0x480cd6];}}),Object[_0x38d54c(0x113)](_0x55cefe,_0x3344a3,_0x1d1d56);}:function(_0x244447,_0x1e2502,_0x256958,_0x35783a){if(_0x35783a===undefined)_0x35783a=_0x256958;_0x244447[_0x35783a]=_0x1e2502[_0x256958];}),__setModuleDefault=this&&this[a13_0x2dd94d(0xe8)]||(Object[a13_0x2dd94d(0xcd)]?function(_0x20b21b,_0x2319f4){const _0x559924=a13_0x2dd94d;Object[_0x559924(0x113)](_0x20b21b,_0x559924(0xea),{'enumerable':!![],'value':_0x2319f4});}:function(_0x108404,_0xde387e){const _0x56508e=a13_0x2dd94d;_0x108404[_0x56508e(0xea)]=_0xde387e;}),__importStar=this&&this[a13_0x2dd94d(0xd1)]||(function(){var _0x483f1a=function(_0x1e8a35){const _0x1a15d9=a13_0x20ac;return _0x483f1a=Object[_0x1a15d9(0xdd)]||function(_0x125b51){const _0x3ad358=_0x1a15d9;var _0xe12975=[];for(var _0x344e7c in _0x125b51)if(Object[_0x3ad358(0xe7)][_0x3ad358(0xde)][_0x3ad358(0x112)](_0x125b51,_0x344e7c))_0xe12975[_0xe12975['length']]=_0x344e7c;return _0xe12975;},_0x483f1a(_0x1e8a35);};return function(_0x4c62df){const _0x990912=a13_0x20ac;if(_0x4c62df&&_0x4c62df[_0x990912(0x110)])return _0x4c62df;var _0x579fdd={};if(_0x4c62df!=null){for(var _0x19b542=_0x483f1a(_0x4c62df),_0x5b146d=0x0;_0x5b146d<_0x19b542['length'];_0x5b146d++)if(_0x19b542[_0x5b146d]!=='default')__createBinding(_0x579fdd,_0x4c62df,_0x19b542[_0x5b146d]);}return __setModuleDefault(_0x579fdd,_0x4c62df),_0x579fdd;};}()),__importDefault=this&&this[a13_0x2dd94d(0x107)]||function(_0x5c734b){const _0x23055a=a13_0x2dd94d;return _0x5c734b&&_0x5c734b[_0x23055a(0x110)]?_0x5c734b:{'default':_0x5c734b};};Object[a13_0x2dd94d(0x113)](exports,'__esModule',{'value':!![]}),exports[a13_0x2dd94d(0x10c)]=void 0x0;const testGatewayService_1=require(a13_0x2dd94d(0x114)),webhookService_1=require(a13_0x2dd94d(0x102)),database_1=__importDefault(require(a13_0x2dd94d(0xce)));class TestGatewayController{constructor(){const _0x445059=a13_0x2dd94d;this[_0x445059(0xb9)]=async(_0x2ec518,_0x46dd85,_0x24341c)=>{const _0x341197=_0x445059;try{const {paymentId:_0x4de971}=_0x2ec518[_0x341197(0xe3)];console[_0x341197(0xf2)](_0x341197(0xf6)+_0x4de971);const _0x44f98e=await database_1[_0x341197(0xea)][_0x341197(0xf7)][_0x341197(0xb7)]({'where':{'id':_0x4de971},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x44f98e)return _0x46dd85['status'](0x194)[_0x341197(0xe5)]({'success':![],'message':_0x341197(0xbb)});if(_0x44f98e[_0x341197(0xeb)]!==_0x341197(0xbc))return _0x46dd85['status'](0x190)['json']({'success':![],'message':_0x341197(0xe4)});if(_0x44f98e['status']!==_0x341197(0xd0))return _0x46dd85[_0x341197(0xdb)](0x190)[_0x341197(0xe5)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x44f98e[_0x341197(0xdb)]+_0x341197(0x11c)});_0x46dd85[_0x341197(0xe5)]({'success':!![],'result':{'paymentId':_0x44f98e['id'],'orderId':_0x44f98e['gatewayOrderId'],'amount':_0x44f98e[_0x341197(0xf8)],'currency':_0x44f98e[_0x341197(0xd2)],'merchantName':_0x44f98e[_0x341197(0xcf)][_0x341197(0xe2)],'description':_0x341197(0xf0)+_0x44f98e[_0x341197(0xcf)]['name'],'testInstructions':{'successCard':_0x341197(0xfa),'failureCard':_0x341197(0x103),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x341197(0xed),'holderName':_0x341197(0xb6)}}});}catch(_0x296624){_0x24341c(_0x296624);}},this[_0x445059(0x100)]=async(_0x6d1f72,_0x4060f7,_0x448949)=>{const _0x2872a0=_0x445059;try{const {paymentId:_0x1587b8}=_0x6d1f72[_0x2872a0(0xe3)],_0x19ce7e=_0x6d1f72[_0x2872a0(0xdf)];console[_0x2872a0(0xf2)](_0x2872a0(0xd6)+_0x1587b8);const _0x21d36d=await database_1[_0x2872a0(0xea)][_0x2872a0(0xf7)][_0x2872a0(0xb7)]({'where':{'id':_0x1587b8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x21d36d)return _0x4060f7[_0x2872a0(0xdb)](0x194)[_0x2872a0(0xe5)]({'success':![],'message':_0x2872a0(0xbb)});if(_0x21d36d[_0x2872a0(0xeb)]!==_0x2872a0(0xbc))return _0x4060f7[_0x2872a0(0xdb)](0x190)[_0x2872a0(0xe5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x21d36d[_0x2872a0(0xdb)]!=='PENDING')return _0x4060f7['status'](0x190)[_0x2872a0(0xe5)]({'success':![],'message':_0x2872a0(0x10e)+_0x21d36d[_0x2872a0(0xdb)]+_0x2872a0(0x11c)});const _0x224743=await this[_0x2872a0(0xf3)]['processCardPayment']({'paymentId':_0x21d36d['id'],'orderId':_0x21d36d['gatewayOrderId']||_0x21d36d['id'],'amount':_0x21d36d[_0x2872a0(0xf8)],'currency':_0x21d36d[_0x2872a0(0xd2)],'cardData':_0x19ce7e});console['log'](_0x2872a0(0xca),_0x224743);const _0x2ed815={'status':_0x224743[_0x2872a0(0xdb)],'updatedAt':new Date()};if(_0x224743[_0x2872a0(0xdb)]==='PAID')_0x2ed815['paidAt']=new Date(),_0x2ed815[_0x2872a0(0xff)]=_0x224743[_0x2872a0(0x10f)];else _0x224743['status']==='FAILED'&&(_0x2ed815[_0x2872a0(0x109)]=_0x224743[_0x2872a0(0x10a)]);const _0x4f4452=_0x19ce7e[_0x2872a0(0xb8)][_0x2872a0(0xc0)](/[\s-]/g,'');_0x2ed815['cardLast4']=_0x4f4452['slice'](-0x4),_0x2ed815[_0x2872a0(0xee)]='test_card',await database_1[_0x2872a0(0xea)][_0x2872a0(0xf7)][_0x2872a0(0xc9)]({'where':{'id':_0x21d36d['id']},'data':_0x2ed815}),await database_1[_0x2872a0(0xea)]['webhookLog'][_0x2872a0(0xcd)]({'data':{'paymentId':_0x21d36d['id'],'shopId':_0x21d36d['shopId'],'event':_0x2872a0(0xc8)+_0x224743[_0x2872a0(0xdb)][_0x2872a0(0xe9)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2872a0(0xd0),'newStatus':_0x224743[_0x2872a0(0xdb)],'transactionId':_0x224743[_0x2872a0(0x10f)],'failureReason':_0x224743[_0x2872a0(0x10a)],'processedAt':new Date()[_0x2872a0(0xdc)]()})}}),await this['sendShopWebhook'](_0x21d36d,_0x224743[_0x2872a0(0xdb)],_0x224743[_0x2872a0(0x10f)],_0x224743[_0x2872a0(0x10a)]),await this['sendPaymentStatusNotification'](_0x21d36d,_0x224743['status']),console['log'](_0x2872a0(0xef)+_0x1587b8+'\x20processed:\x20'+_0x224743['status']),_0x224743[_0x2872a0(0xdb)]===_0x2872a0(0xf9)?_0x4060f7[_0x2872a0(0xe5)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2872a0(0xf9),'transactionId':_0x224743[_0x2872a0(0x10f)],'redirectUrl':_0x21d36d[_0x2872a0(0xd5)]}}):_0x4060f7[_0x2872a0(0xdb)](0x190)[_0x2872a0(0xe5)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x224743[_0x2872a0(0x10a)],'redirectUrl':_0x21d36d['failUrl']}});}catch(_0x6fb43){_0x448949(_0x6fb43);}},this[_0x445059(0xf3)]=new testGatewayService_1[(_0x445059(0xe1))](),this[_0x445059(0xc6)]=new webhookService_1[(_0x445059(0xec))]();}async[a13_0x2dd94d(0xfd)](_0x4d8de6,_0x41be29,_0xf1a0c1,_0x28a81a){const _0x42b47d=a13_0x2dd94d,_0x5ca449=Date[_0x42b47d(0xd7)]();try{const _0x5b2459=_0x4d8de6[_0x42b47d(0xcf)],_0x56464f=_0x5b2459['settings'];if(!_0x56464f?.['webhookUrl']){console[_0x42b47d(0xf2)](_0x42b47d(0xcc)+_0x5b2459['id']);return;}const _0x46330b=_0x41be29==='PAID'?_0x42b47d(0x101):_0x42b47d(0x104);let _0x262964=[];if(_0x56464f[_0x42b47d(0xbd)])try{_0x262964=Array[_0x42b47d(0xc3)](_0x56464f[_0x42b47d(0xbd)])?_0x56464f[_0x42b47d(0xbd)]:JSON[_0x42b47d(0x11d)](_0x56464f[_0x42b47d(0xbd)]);}catch(_0x4619a0){console['error'](_0x42b47d(0xf1),_0x4619a0),_0x262964=[];}if(!_0x262964[_0x42b47d(0x11a)](_0x46330b)){console[_0x42b47d(0xf2)](_0x42b47d(0xc7)+_0x46330b+_0x42b47d(0xbf)+_0x5b2459['id']);return;}const _0x341ff1={'event':_0x46330b,'payment':{'id':_0x4d8de6['id'],'order_id':_0x4d8de6['orderId'],'gateway_order_id':_0x4d8de6[_0x42b47d(0x117)],'gateway':_0x42b47d(0x11b),'amount':_0x4d8de6[_0x42b47d(0xf8)],'currency':_0x4d8de6[_0x42b47d(0xd2)],'status':_0x41be29[_0x42b47d(0xe9)](),'customer_email':_0x4d8de6['customerEmail'],'customer_name':_0x4d8de6[_0x42b47d(0xc4)],'transaction_id':_0xf1a0c1,'failure_message':_0x28a81a,'created_at':_0x4d8de6[_0x42b47d(0xf5)],'updated_at':new Date()}},_0x588eb9=await fetch(_0x56464f[_0x42b47d(0xd8)],{'method':'POST','headers':{'Content-Type':_0x42b47d(0x108),'User-Agent':_0x42b47d(0xd9)},'body':JSON[_0x42b47d(0x105)](_0x341ff1)}),_0x316994=Date[_0x42b47d(0xd7)]()-_0x5ca449;console[_0x42b47d(0xf2)](_0x42b47d(0xfb)+_0x56464f[_0x42b47d(0xd8)]+'\x20with\x20status\x20'+_0x588eb9[_0x42b47d(0xdb)]+'\x20('+_0x316994+_0x42b47d(0x10d));}catch(_0x2650bf){console[_0x42b47d(0xf4)](_0x42b47d(0xd3),_0x2650bf);}}async['sendPaymentStatusNotification'](_0x346465,_0x40286f){const _0x3b6960=a13_0x2dd94d;try{const {telegramBotService:_0x2d1a50}=await Promise[_0x3b6960(0x111)]()[_0x3b6960(0xbe)](()=>__importStar(require('../services/telegramBotService'))),_0x31edb2={'PAID':'paid','FAILED':_0x3b6960(0xda)},_0x225e1d=_0x31edb2[_0x40286f];if(!_0x225e1d)return;await _0x2d1a50[_0x3b6960(0x10b)](_0x346465[_0x3b6960(0x116)],_0x346465,_0x225e1d);}catch(_0x434c69){console['error'](_0x3b6960(0xd4),_0x434c69);}}}exports[a13_0x2dd94d(0x10c)]=TestGatewayController;function a13_0x29f5(){const _0x2ad0b5=['Any\x203-4\x20digits','paymentMethod','✅\x20Test\x20Gateway\x20payment\x20','Payment\x20to\x20','Error\x20parsing\x20webhook\x20events:','log','testGatewayService','error','createdAt','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','payment','amount','PAID','4242\x204242\x204242\x204242','Test\x20Gateway\x20webhook\x20sent\x20to\x20','956gPoprg','sendShopWebhook','2494210MIDKrZ','gatewayPaymentId','processCard','payment.success','../services/webhookService','Any\x20other\x20card\x20number','payment.failed','stringify','229665apcLVV','__importDefault','application/json','failureMessage','failureReason','sendPaymentNotification','TestGatewayController','ms)','Payment\x20status\x20is\x20','transactionId','__esModule','resolve','call','defineProperty','../services/gateways/testGatewayService','6lFnPMt','shopId','gatewayOrderId','8KNixeR','783784NiprXC','includes','0000',',\x20cannot\x20process','parse','Any\x20name','findUnique','cardNumber','getPaymentForm','getOwnPropertyDescriptor','Payment\x20not\x20found','test_gateway','webhookEvents','then','\x20not\x20enabled\x20for\x20shop\x20','replace','1347zKaGXI','writable','isArray','customerName','3506391AXGYjv','webhookService','Webhook\x20event\x20','test_gateway_','update','🧪\x20Test\x20Gateway\x20result:','8330770vPVhtN','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create','../config/database','shop','PENDING','__importStar','currency','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','successUrl','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','now','webhookUrl','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','failed','status','toISOString','getOwnPropertyNames','hasOwnProperty','body','1133172hJLpxc','TestGatewayService','name','params','Payment\x20is\x20not\x20for\x20test\x20gateway','json','__createBinding','prototype','__setModuleDefault','toLowerCase','default','gateway','WebhookService'];a13_0x29f5=function(){return _0x2ad0b5;};return a13_0x29f5();}