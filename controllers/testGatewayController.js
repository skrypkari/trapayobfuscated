'use strict';const a19_0x2300e2=a19_0x3290;(function(_0x41e4f3,_0x31f0ac){const _0x3c1b8b=a19_0x3290,_0x514646=_0x41e4f3();while(!![]){try{const _0x3749f7=parseInt(_0x3c1b8b(0x260))/0x1+-parseInt(_0x3c1b8b(0x1f7))/0x2*(parseInt(_0x3c1b8b(0x251))/0x3)+parseInt(_0x3c1b8b(0x1f1))/0x4*(-parseInt(_0x3c1b8b(0x262))/0x5)+parseInt(_0x3c1b8b(0x204))/0x6+-parseInt(_0x3c1b8b(0x224))/0x7*(parseInt(_0x3c1b8b(0x23a))/0x8)+-parseInt(_0x3c1b8b(0x20d))/0x9+parseInt(_0x3c1b8b(0x263))/0xa*(parseInt(_0x3c1b8b(0x227))/0xb);if(_0x3749f7===_0x31f0ac)break;else _0x514646['push'](_0x514646['shift']());}catch(_0x3253e4){_0x514646['push'](_0x514646['shift']());}}}(a19_0x4b5d,0x80629));var __createBinding=this&&this['__createBinding']||(Object[a19_0x2300e2(0x25c)]?function(_0x279d8a,_0xe5ce58,_0x3dcb3c,_0xd4b55d){const _0x203a9b=a19_0x2300e2;if(_0xd4b55d===undefined)_0xd4b55d=_0x3dcb3c;var _0x4a5a52=Object[_0x203a9b(0x258)](_0xe5ce58,_0x3dcb3c);(!_0x4a5a52||(_0x203a9b(0x238)in _0x4a5a52?!_0xe5ce58[_0x203a9b(0x1f8)]:_0x4a5a52['writable']||_0x4a5a52[_0x203a9b(0x22b)]))&&(_0x4a5a52={'enumerable':!![],'get':function(){return _0xe5ce58[_0x3dcb3c];}}),Object[_0x203a9b(0x205)](_0x279d8a,_0xd4b55d,_0x4a5a52);}:function(_0x342c90,_0x24ba60,_0x16438d,_0x4eeb1c){if(_0x4eeb1c===undefined)_0x4eeb1c=_0x16438d;_0x342c90[_0x4eeb1c]=_0x24ba60[_0x16438d];}),__setModuleDefault=this&&this[a19_0x2300e2(0x231)]||(Object[a19_0x2300e2(0x25c)]?function(_0xc5a2d6,_0x26d189){const _0x22c887=a19_0x2300e2;Object[_0x22c887(0x205)](_0xc5a2d6,_0x22c887(0x21a),{'enumerable':!![],'value':_0x26d189});}:function(_0x3ee073,_0xbbf7aa){const _0x4d34d5=a19_0x2300e2;_0x3ee073[_0x4d34d5(0x21a)]=_0xbbf7aa;}),__importStar=this&&this[a19_0x2300e2(0x253)]||(function(){var _0x58fc2a=function(_0x33f2d7){const _0x333e76=a19_0x3290;return _0x58fc2a=Object[_0x333e76(0x217)]||function(_0x2c4ccc){const _0x5680d2=_0x333e76;var _0x3b6b6e=[];for(var _0x41c963 in _0x2c4ccc)if(Object[_0x5680d2(0x1fb)]['hasOwnProperty'][_0x5680d2(0x21f)](_0x2c4ccc,_0x41c963))_0x3b6b6e[_0x3b6b6e['length']]=_0x41c963;return _0x3b6b6e;},_0x58fc2a(_0x33f2d7);};return function(_0x432781){const _0x2470c0=a19_0x3290;if(_0x432781&&_0x432781[_0x2470c0(0x1f8)])return _0x432781;var _0x3a9330={};if(_0x432781!=null){for(var _0xa315ef=_0x58fc2a(_0x432781),_0x1ee5a1=0x0;_0x1ee5a1<_0xa315ef[_0x2470c0(0x215)];_0x1ee5a1++)if(_0xa315ef[_0x1ee5a1]!=='default')__createBinding(_0x3a9330,_0x432781,_0xa315ef[_0x1ee5a1]);}return __setModuleDefault(_0x3a9330,_0x432781),_0x3a9330;};}()),__importDefault=this&&this['__importDefault']||function(_0x2ec171){return _0x2ec171&&_0x2ec171['__esModule']?_0x2ec171:{'default':_0x2ec171};};Object[a19_0x2300e2(0x205)](exports,'__esModule',{'value':!![]}),exports[a19_0x2300e2(0x218)]=void 0x0;const testGatewayService_1=require(a19_0x2300e2(0x255)),webhookService_1=require(a19_0x2300e2(0x232)),database_1=__importDefault(require('../config/database'));function a19_0x4b5d(){const _0x204019=['__importStar','test_gateway','../services/gateways/testGatewayService','Payment\x20failed','failureMessage','getOwnPropertyDescriptor','currentPayments','body','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','create','paid','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','177296aCblzY','replace','1655drmSdI','10myoxqT','Payment\x20not\x20found','sendPaymentNotification','2948YReHAQ','test_card','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','params','status','244VGspIL','__esModule','sendPaymentStatusNotification','\x20not\x20found','prototype','cardLast4',',\x20cannot\x20process','Any\x203-4\x20digits','toISOString','payment.success','testGatewayService','stringify','payment.failed','2681166xqBzcG','defineProperty','payment','gatewayOrderId',',\x20status=','Test\x20Gateway\x20webhook\x20sent\x20to\x20','FAILED','../services/telegramBotService','update','8738775RCBoVb','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','createdAt','paymentLinkId','webhookUrl','slice','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','sendShopWebhook','length','webhookLog','getOwnPropertyNames','TestGatewayController','paidAt','default','shop','WebhookService','name','\x20not\x20enabled\x20for\x20shop\x20','call','PENDING','\x20->\x20','SINGLE','type','6746341AWHjLi','currency','paymentLink','31529487ZqlGap','log','customerName','gateway','configurable','paymentMethod','Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x20name','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','ðŸ“ˆ\x20Found\x20payment\x20link\x20','__setModuleDefault','../services/webhookService','toLowerCase','$transaction','failureReason','findUnique','POST','get','COMPLETED','8UkPvlp','amount','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20with\x20status\x20',',\x20currentPayments=','Error\x20parsing\x20webhook\x20events:','Any\x20other\x20card\x20number','webhookService','now','webhookEvents','orderId','shopId','cardNumber','processCard','error','Payment\x20is\x20not\x20for\x20test\x20gateway','includes','âŒ\x20Payment\x20link\x20','PAID','\x20processed:\x20','transactionId','json','Any\x20future\x20date\x20(MM/YY)','19326wTKQUG','getPaymentForm'];a19_0x4b5d=function(){return _0x204019;};return a19_0x4b5d();}function a19_0x3290(_0x1d7b4f,_0x1984d3){_0x1d7b4f=_0x1d7b4f-0x1f1;const _0x4b5d70=a19_0x4b5d();let _0x329007=_0x4b5d70[_0x1d7b4f];return _0x329007;}class TestGatewayController{constructor(){const _0x12a697=a19_0x2300e2;this[_0x12a697(0x252)]=async(_0x48b06f,_0x53a708,_0x205a8b)=>{const _0x5ca6ac=_0x12a697;try{const {paymentId:_0x577870}=_0x48b06f[_0x5ca6ac(0x1f5)];console['log'](_0x5ca6ac(0x25e)+_0x577870);const _0x4feabf=await database_1['default'][_0x5ca6ac(0x206)][_0x5ca6ac(0x236)]({'where':{'id':_0x577870},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4feabf)return _0x53a708[_0x5ca6ac(0x1f6)](0x194)[_0x5ca6ac(0x24f)]({'success':![],'message':_0x5ca6ac(0x264)});if(_0x4feabf['gateway']!==_0x5ca6ac(0x254))return _0x53a708[_0x5ca6ac(0x1f6)](0x190)[_0x5ca6ac(0x24f)]({'success':![],'message':_0x5ca6ac(0x249)});if(_0x4feabf[_0x5ca6ac(0x1f6)]!==_0x5ca6ac(0x220))return _0x53a708[_0x5ca6ac(0x1f6)](0x190)[_0x5ca6ac(0x24f)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4feabf['status']+_0x5ca6ac(0x1fd)});_0x53a708[_0x5ca6ac(0x24f)]({'success':!![],'result':{'paymentId':_0x4feabf['id'],'orderId':_0x4feabf[_0x5ca6ac(0x207)],'amount':_0x4feabf[_0x5ca6ac(0x23b)],'currency':_0x4feabf['currency'],'merchantName':_0x4feabf[_0x5ca6ac(0x21b)]['name'],'description':'Payment\x20to\x20'+_0x4feabf['shop'][_0x5ca6ac(0x21d)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5ca6ac(0x240),'expiryDate':_0x5ca6ac(0x250),'cvc':_0x5ca6ac(0x1fe),'holderName':_0x5ca6ac(0x22e)}}});}catch(_0x3293df){_0x205a8b(_0x3293df);}},this[_0x12a697(0x247)]=async(_0x5a08fc,_0x3cf7e2,_0x56d0fa)=>{const _0x2da56a=_0x12a697;try{const {paymentId:_0x2667f4}=_0x5a08fc[_0x2da56a(0x1f5)],_0x3d4a32=_0x5a08fc[_0x2da56a(0x25a)];console['log'](_0x2da56a(0x22f)+_0x2667f4);const _0x4337f3=await database_1[_0x2da56a(0x21a)][_0x2da56a(0x206)][_0x2da56a(0x236)]({'where':{'id':_0x2667f4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4337f3)return _0x3cf7e2['status'](0x194)[_0x2da56a(0x24f)]({'success':![],'message':_0x2da56a(0x264)});if(_0x4337f3[_0x2da56a(0x22a)]!==_0x2da56a(0x254))return _0x3cf7e2['status'](0x190)['json']({'success':![],'message':_0x2da56a(0x249)});if(_0x4337f3[_0x2da56a(0x1f6)]!==_0x2da56a(0x220))return _0x3cf7e2[_0x2da56a(0x1f6)](0x190)[_0x2da56a(0x24f)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4337f3[_0x2da56a(0x1f6)]+_0x2da56a(0x1fd)});const _0x5906f3=await this[_0x2da56a(0x201)]['processCardPayment']({'paymentId':_0x4337f3['id'],'orderId':_0x4337f3[_0x2da56a(0x207)]||_0x4337f3['id'],'amount':_0x4337f3[_0x2da56a(0x23b)],'currency':_0x4337f3[_0x2da56a(0x225)],'cardData':_0x3d4a32});console[_0x2da56a(0x228)](_0x2da56a(0x23c),_0x5906f3);const _0x27f75f={'status':_0x5906f3['status'],'updatedAt':new Date()};if(_0x5906f3[_0x2da56a(0x1f6)]===_0x2da56a(0x24c))_0x27f75f[_0x2da56a(0x219)]=new Date(),_0x27f75f['gatewayPaymentId']=_0x5906f3[_0x2da56a(0x24e)];else _0x5906f3[_0x2da56a(0x1f6)]==='FAILED'&&(_0x27f75f[_0x2da56a(0x257)]=_0x5906f3[_0x2da56a(0x235)]);const _0x409022=_0x3d4a32[_0x2da56a(0x246)][_0x2da56a(0x261)](/[\s-]/g,'');_0x27f75f[_0x2da56a(0x1fc)]=_0x409022[_0x2da56a(0x212)](-0x4),_0x27f75f[_0x2da56a(0x22c)]=_0x2da56a(0x1f2),await database_1['default']['payment'][_0x2da56a(0x20c)]({'where':{'id':_0x4337f3['id']},'data':_0x27f75f});if(_0x5906f3[_0x2da56a(0x1f6)]===_0x2da56a(0x24c)&&_0x4337f3[_0x2da56a(0x210)]){console[_0x2da56a(0x228)](_0x2da56a(0x25f)+_0x4337f3['id']+_0x2da56a(0x25b));try{await database_1[_0x2da56a(0x21a)][_0x2da56a(0x234)](async _0x4c103a=>{const _0x4bebac=_0x2da56a,_0x3856d6=await _0x4c103a['paymentLink'][_0x4bebac(0x236)]({'where':{'id':_0x4337f3[_0x4bebac(0x210)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3856d6){console[_0x4bebac(0x228)](_0x4bebac(0x230)+_0x3856d6['id']+':\x20type='+_0x3856d6[_0x4bebac(0x223)]+_0x4bebac(0x23e)+_0x3856d6[_0x4bebac(0x259)]+_0x4bebac(0x208)+_0x3856d6[_0x4bebac(0x1f6)]);const _0x13f0fd=_0x3856d6[_0x4bebac(0x259)]+0x1,_0xa52394=_0x3856d6['type']===_0x4bebac(0x222)?_0x4bebac(0x239):_0x3856d6[_0x4bebac(0x1f6)];await _0x4c103a[_0x4bebac(0x226)][_0x4bebac(0x20c)]({'where':{'id':_0x4337f3[_0x4bebac(0x210)]},'data':{'currentPayments':_0x13f0fd,'status':_0xa52394,'updatedAt':new Date()}}),console['log']('âœ…\x20Payment\x20link\x20'+_0x3856d6['id']+'\x20updated:\x20currentPayments='+_0x3856d6['currentPayments']+_0x4bebac(0x221)+_0x13f0fd+_0x4bebac(0x208)+_0x3856d6['status']+'\x20->\x20'+_0xa52394);}else console[_0x4bebac(0x228)](_0x4bebac(0x24b)+_0x4337f3['paymentLinkId']+_0x4bebac(0x1fa));});}catch(_0x139b01){console[_0x2da56a(0x248)](_0x2da56a(0x213),_0x139b01);}}await database_1[_0x2da56a(0x21a)][_0x2da56a(0x216)]['create']({'data':{'paymentId':_0x4337f3['id'],'shopId':_0x4337f3[_0x2da56a(0x245)],'event':'test_gateway_'+_0x5906f3[_0x2da56a(0x1f6)][_0x2da56a(0x233)](),'statusCode':0xc8,'responseBody':JSON[_0x2da56a(0x202)]({'oldStatus':_0x2da56a(0x220),'newStatus':_0x5906f3['status'],'transactionId':_0x5906f3[_0x2da56a(0x24e)],'failureReason':_0x5906f3[_0x2da56a(0x235)],'processedAt':new Date()[_0x2da56a(0x1ff)]()})}}),await this[_0x2da56a(0x214)](_0x4337f3,_0x5906f3[_0x2da56a(0x1f6)],_0x5906f3[_0x2da56a(0x24e)],_0x5906f3[_0x2da56a(0x235)]),await this[_0x2da56a(0x1f9)](_0x4337f3,_0x5906f3['status']),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x2667f4+_0x2da56a(0x24d)+_0x5906f3[_0x2da56a(0x1f6)]),_0x5906f3[_0x2da56a(0x1f6)]===_0x2da56a(0x24c)?_0x3cf7e2[_0x2da56a(0x24f)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2da56a(0x24c),'transactionId':_0x5906f3['transactionId'],'redirectUrl':_0x4337f3['successUrl']}}):_0x3cf7e2[_0x2da56a(0x1f6)](0x190)[_0x2da56a(0x24f)]({'success':![],'message':_0x2da56a(0x256),'result':{'status':_0x2da56a(0x20a),'failureReason':_0x5906f3[_0x2da56a(0x235)],'redirectUrl':_0x4337f3['failUrl']}});}catch(_0x29819f){_0x56d0fa(_0x29819f);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x12a697(0x241)]=new webhookService_1[(_0x12a697(0x21c))]();}async[a19_0x2300e2(0x214)](_0x5406b1,_0x11c58f,_0x51d02b,_0x166fd8){const _0x3d2d4b=a19_0x2300e2,_0x5cf4f2=Date[_0x3d2d4b(0x242)]();try{const _0x2a3f93=_0x5406b1[_0x3d2d4b(0x21b)],_0x4a26d9=_0x2a3f93['settings'];if(!_0x4a26d9?.[_0x3d2d4b(0x211)]){console[_0x3d2d4b(0x228)](_0x3d2d4b(0x20e)+_0x2a3f93['id']);return;}const _0xeacc8e=_0x11c58f==='PAID'?_0x3d2d4b(0x200):_0x3d2d4b(0x203);let _0x29b50b=[];if(_0x4a26d9[_0x3d2d4b(0x243)])try{_0x29b50b=Array['isArray'](_0x4a26d9[_0x3d2d4b(0x243)])?_0x4a26d9[_0x3d2d4b(0x243)]:JSON['parse'](_0x4a26d9['webhookEvents']);}catch(_0x372dc8){console[_0x3d2d4b(0x248)](_0x3d2d4b(0x23f),_0x372dc8),_0x29b50b=[];}if(!_0x29b50b[_0x3d2d4b(0x24a)](_0xeacc8e)){console[_0x3d2d4b(0x228)]('Webhook\x20event\x20'+_0xeacc8e+_0x3d2d4b(0x21e)+_0x2a3f93['id']);return;}const _0x47ed97={'event':_0xeacc8e,'payment':{'id':_0x5406b1['id'],'order_id':_0x5406b1[_0x3d2d4b(0x244)],'gateway_order_id':_0x5406b1['gatewayOrderId'],'gateway':'0000','amount':_0x5406b1['amount'],'currency':_0x5406b1['currency'],'status':_0x11c58f[_0x3d2d4b(0x233)](),'customer_email':_0x5406b1['customerEmail'],'customer_name':_0x5406b1[_0x3d2d4b(0x229)],'transaction_id':_0x51d02b,'failure_message':_0x166fd8,'created_at':_0x5406b1[_0x3d2d4b(0x20f)],'updated_at':new Date()}},_0xe6b130=await fetch(_0x4a26d9[_0x3d2d4b(0x211)],{'method':_0x3d2d4b(0x237),'headers':{'Content-Type':'application/json','User-Agent':_0x3d2d4b(0x22d)},'body':JSON[_0x3d2d4b(0x202)](_0x47ed97)}),_0x51bf33=Date['now']()-_0x5cf4f2;console[_0x3d2d4b(0x228)](_0x3d2d4b(0x209)+_0x4a26d9[_0x3d2d4b(0x211)]+_0x3d2d4b(0x23d)+_0xe6b130[_0x3d2d4b(0x1f6)]+'\x20('+_0x51bf33+'ms)');}catch(_0x1c4c64){console[_0x3d2d4b(0x248)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x1c4c64);}}async['sendPaymentStatusNotification'](_0xa473a3,_0x53c652){const _0x5f23b7=a19_0x2300e2;try{const {telegramBotService:_0x1f7e40}=await Promise['resolve']()['then'](()=>__importStar(require(_0x5f23b7(0x20b)))),_0x3c6ac3={'PAID':_0x5f23b7(0x25d),'FAILED':_0x5f23b7(0x1f3)},_0x5080fe=_0x3c6ac3[_0x53c652];if(!_0x5080fe)return;await _0x1f7e40[_0x5f23b7(0x265)](_0xa473a3[_0x5f23b7(0x245)],_0xa473a3,_0x5080fe);}catch(_0x4fbfa5){console['error'](_0x5f23b7(0x1f4),_0x4fbfa5);}}}exports[a19_0x2300e2(0x218)]=TestGatewayController;