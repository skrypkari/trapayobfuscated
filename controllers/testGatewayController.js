'use strict';function a13_0x8ed6(){const _0x5a7cf4=['log','3877551cnzjFu','Any\x203-4\x20digits','processCard','length','params','Payment\x20not\x20found','gateway','ms)','toLowerCase','findUnique','\x20not\x20found','error','name','webhookEvents','‚úÖ\x20Test\x20Gateway\x20payment\x20','Payment\x20processed\x20successfully','status','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20',',\x20cannot\x20process','configurable','WebhookService','update','webhookUrl','11HZQKOx','defineProperty','then','testGatewayService','1206sYoNQK','2092880ttMojj','Payment\x20failed','PENDING','‚ùå\x20Payment\x20link\x20','getOwnPropertyDescriptor','\x20processed:\x20','4802358HBcDGn','‚úÖ\x20Payment\x20link\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','processCardPayment','default',',\x20status=','failureReason','paymentLinkId','application/json','Payment\x20is\x20not\x20for\x20test\x20gateway','3576808MspkRd','__setModuleDefault','1491nQmjzx','cardNumber','gatewayOrderId','3747hCuetm','currentPayments','FAILED','json','test_gateway_','Test\x20Gateway\x20webhook\x20sent\x20to\x20','1412mWzVgq','get','getPaymentForm','payment.success','type','442wFrtdl',':\x20type=','../services/gateways/testGatewayService','üß™\x20Test\x20Gateway\x20result:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','paymentMethod','replace','PAID','stringify','payment.failed','call','failUrl','body','Any\x20other\x20card\x20number','TestGatewayController','7kqaVhV','__createBinding','webhookLog','failureMessage','\x20not\x20enabled\x20for\x20shop\x20','amount','paymentLink','COMPLETED','__esModule','sendPaymentNotification','test_gateway','toISOString','\x20updated:\x20currentPayments=','Payment\x20to\x20','../config/database','hasOwnProperty','5qNjuxB','shop','payment','üìà\x20Test\x20Gateway:\x20Payment\x20','customerName','paid','slice','\x20->\x20','Payment\x20status\x20is\x20','üìà\x20Found\x20payment\x20link\x20','now','writable','resolve','parse','create','prototype','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','customerEmail','paidAt','Webhook\x20event\x20','currency','482664wNXrsO','settings','Error\x20parsing\x20webhook\x20events:','transactionId','webhookService',',\x20currentPayments=','successUrl'];a13_0x8ed6=function(){return _0x5a7cf4;};return a13_0x8ed6();}const a13_0x475c98=a13_0x2cb7;(function(_0x12a651,_0x53dd44){const _0x5e411e=a13_0x2cb7,_0x3ef311=_0x12a651();while(!![]){try{const _0x3d9e2d=parseInt(_0x5e411e(0x94))/0x1*(-parseInt(_0x5e411e(0x81))/0x2)+-parseInt(_0x5e411e(0x97))/0x3*(parseInt(_0x5e411e(0x9d))/0x4)+-parseInt(_0x5e411e(0xc1))/0x5*(-parseInt(_0x5e411e(0x88))/0x6)+parseInt(_0x5e411e(0xb1))/0x7*(-parseInt(_0x5e411e(0x92))/0x8)+parseInt(_0x5e411e(0xde))/0x9+parseInt(_0x5e411e(0x82))/0xa*(-parseInt(_0x5e411e(0xf5))/0xb)+-parseInt(_0x5e411e(0xd6))/0xc*(-parseInt(_0x5e411e(0xa2))/0xd);if(_0x3d9e2d===_0x53dd44)break;else _0x3ef311['push'](_0x3ef311['shift']());}catch(_0x5501d3){_0x3ef311['push'](_0x3ef311['shift']());}}}(a13_0x8ed6,0x93135));var __createBinding=this&&this[a13_0x475c98(0xb2)]||(Object['create']?function(_0x9a52d1,_0xea8ffe,_0x5d2af7,_0x3c63c2){const _0x1a66b7=a13_0x475c98;if(_0x3c63c2===undefined)_0x3c63c2=_0x5d2af7;var _0x55a10c=Object[_0x1a66b7(0x86)](_0xea8ffe,_0x5d2af7);(!_0x55a10c||(_0x1a66b7(0x9e)in _0x55a10c?!_0xea8ffe[_0x1a66b7(0xb9)]:_0x55a10c[_0x1a66b7(0xcc)]||_0x55a10c[_0x1a66b7(0xf1)]))&&(_0x55a10c={'enumerable':!![],'get':function(){return _0xea8ffe[_0x5d2af7];}}),Object[_0x1a66b7(0xf6)](_0x9a52d1,_0x3c63c2,_0x55a10c);}:function(_0x4fbba1,_0x566606,_0xde3f94,_0x37ce98){if(_0x37ce98===undefined)_0x37ce98=_0xde3f94;_0x4fbba1[_0x37ce98]=_0x566606[_0xde3f94];}),__setModuleDefault=this&&this[a13_0x475c98(0x93)]||(Object[a13_0x475c98(0xcf)]?function(_0x15160d,_0x346566){const _0x5332b0=a13_0x475c98;Object['defineProperty'](_0x15160d,_0x5332b0(0x8c),{'enumerable':!![],'value':_0x346566});}:function(_0x2bd8ce,_0x364a8c){const _0x4081d8=a13_0x475c98;_0x2bd8ce[_0x4081d8(0x8c)]=_0x364a8c;}),__importStar=this&&this['__importStar']||(function(){var _0x4ac62c=function(_0x277281){return _0x4ac62c=Object['getOwnPropertyNames']||function(_0x2632a2){const _0x555956=a13_0x2cb7;var _0x1eab61=[];for(var _0x496595 in _0x2632a2)if(Object[_0x555956(0xd0)][_0x555956(0xc0)][_0x555956(0xac)](_0x2632a2,_0x496595))_0x1eab61[_0x1eab61[_0x555956(0xe1)]]=_0x496595;return _0x1eab61;},_0x4ac62c(_0x277281);};return function(_0x23cba5){const _0x9056f0=a13_0x2cb7;if(_0x23cba5&&_0x23cba5[_0x9056f0(0xb9)])return _0x23cba5;var _0x39e713={};if(_0x23cba5!=null){for(var _0x7f31a2=_0x4ac62c(_0x23cba5),_0x528502=0x0;_0x528502<_0x7f31a2[_0x9056f0(0xe1)];_0x528502++)if(_0x7f31a2[_0x528502]!==_0x9056f0(0x8c))__createBinding(_0x39e713,_0x23cba5,_0x7f31a2[_0x528502]);}return __setModuleDefault(_0x39e713,_0x23cba5),_0x39e713;};}()),__importDefault=this&&this['__importDefault']||function(_0xb0ab72){const _0x28cce8=a13_0x475c98;return _0xb0ab72&&_0xb0ab72[_0x28cce8(0xb9)]?_0xb0ab72:{'default':_0xb0ab72};};Object[a13_0x475c98(0xf6)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x2cb7(_0x380498,_0x1754c6){const _0x8ed6c7=a13_0x8ed6();return a13_0x2cb7=function(_0x2cb709,_0x59a679){_0x2cb709=_0x2cb709-0x81;let _0x803951=_0x8ed6c7[_0x2cb709];return _0x803951;},a13_0x2cb7(_0x380498,_0x1754c6);}const testGatewayService_1=require(a13_0x475c98(0xa4)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x475c98(0xbf)));class TestGatewayController{constructor(){const _0x1c23ed=a13_0x475c98;this[_0x1c23ed(0x9f)]=async(_0x61d67b,_0x13ff90,_0x52caf8)=>{const _0xc36bc=_0x1c23ed;try{const {paymentId:_0x2ba912}=_0x61d67b[_0xc36bc(0xe2)];console[_0xc36bc(0xdd)](_0xc36bc(0xef)+_0x2ba912);const _0x5ed67b=await database_1[_0xc36bc(0x8c)][_0xc36bc(0xc3)][_0xc36bc(0xe7)]({'where':{'id':_0x2ba912},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5ed67b)return _0x13ff90['status'](0x194)['json']({'success':![],'message':_0xc36bc(0xe3)});if(_0x5ed67b[_0xc36bc(0xe4)]!==_0xc36bc(0xbb))return _0x13ff90[_0xc36bc(0xee)](0x190)[_0xc36bc(0x9a)]({'success':![],'message':_0xc36bc(0x91)});if(_0x5ed67b[_0xc36bc(0xee)]!==_0xc36bc(0x84))return _0x13ff90[_0xc36bc(0xee)](0x190)[_0xc36bc(0x9a)]({'success':![],'message':_0xc36bc(0xc9)+_0x5ed67b[_0xc36bc(0xee)]+_0xc36bc(0xf0)});_0x13ff90[_0xc36bc(0x9a)]({'success':!![],'result':{'paymentId':_0x5ed67b['id'],'orderId':_0x5ed67b[_0xc36bc(0x96)],'amount':_0x5ed67b['amount'],'currency':_0x5ed67b[_0xc36bc(0xd5)],'merchantName':_0x5ed67b[_0xc36bc(0xc2)]['name'],'description':_0xc36bc(0xbe)+_0x5ed67b['shop'][_0xc36bc(0xea)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0xc36bc(0xaf),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0xc36bc(0xdf),'holderName':'Any\x20name'}}});}catch(_0x32e873){_0x52caf8(_0x32e873);}},this[_0x1c23ed(0xe0)]=async(_0x148304,_0x4ff184,_0x49e690)=>{const _0x42603a=_0x1c23ed;try{const {paymentId:_0x4f46a5}=_0x148304['params'],_0x10cc72=_0x148304[_0x42603a(0xae)];console[_0x42603a(0xdd)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4f46a5);const _0xb06291=await database_1[_0x42603a(0x8c)][_0x42603a(0xc3)][_0x42603a(0xe7)]({'where':{'id':_0x4f46a5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb06291)return _0x4ff184[_0x42603a(0xee)](0x194)[_0x42603a(0x9a)]({'success':![],'message':_0x42603a(0xe3)});if(_0xb06291[_0x42603a(0xe4)]!==_0x42603a(0xbb))return _0x4ff184[_0x42603a(0xee)](0x190)[_0x42603a(0x9a)]({'success':![],'message':_0x42603a(0x91)});if(_0xb06291[_0x42603a(0xee)]!=='PENDING')return _0x4ff184[_0x42603a(0xee)](0x190)[_0x42603a(0x9a)]({'success':![],'message':_0x42603a(0xc9)+_0xb06291[_0x42603a(0xee)]+_0x42603a(0xf0)});const _0x430537=await this[_0x42603a(0xf8)][_0x42603a(0x8b)]({'paymentId':_0xb06291['id'],'orderId':_0xb06291[_0x42603a(0x96)]||_0xb06291['id'],'amount':_0xb06291[_0x42603a(0xb6)],'currency':_0xb06291[_0x42603a(0xd5)],'cardData':_0x10cc72});console[_0x42603a(0xdd)](_0x42603a(0xa5),_0x430537);const _0x5965b0={'status':_0x430537[_0x42603a(0xee)],'updatedAt':new Date()};if(_0x430537[_0x42603a(0xee)]===_0x42603a(0xa9))_0x5965b0[_0x42603a(0xd3)]=new Date(),_0x5965b0['gatewayPaymentId']=_0x430537[_0x42603a(0xd9)];else _0x430537[_0x42603a(0xee)]===_0x42603a(0x99)&&(_0x5965b0[_0x42603a(0xb4)]=_0x430537[_0x42603a(0x8e)]);const _0x42eb8d=_0x10cc72[_0x42603a(0x95)][_0x42603a(0xa8)](/[\s-]/g,'');_0x5965b0['cardLast4']=_0x42eb8d[_0x42603a(0xc7)](-0x4),_0x5965b0[_0x42603a(0xa7)]='test_card',await database_1[_0x42603a(0x8c)][_0x42603a(0xc3)][_0x42603a(0xf3)]({'where':{'id':_0xb06291['id']},'data':_0x5965b0});if(_0x430537[_0x42603a(0xee)]==='PAID'&&_0xb06291[_0x42603a(0x8f)]){console['log'](_0x42603a(0xc4)+_0xb06291['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x42603a(0x8c)]['$transaction'](async _0x3b04ba=>{const _0x46b2e5=_0x42603a,_0x41b255=await _0x3b04ba[_0x46b2e5(0xb7)][_0x46b2e5(0xe7)]({'where':{'id':_0xb06291['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x41b255){console[_0x46b2e5(0xdd)](_0x46b2e5(0xca)+_0x41b255['id']+_0x46b2e5(0xa3)+_0x41b255[_0x46b2e5(0xa1)]+_0x46b2e5(0xdb)+_0x41b255[_0x46b2e5(0x98)]+',\x20status='+_0x41b255[_0x46b2e5(0xee)]);const _0x260270=_0x41b255[_0x46b2e5(0x98)]+0x1,_0x130df3=_0x41b255[_0x46b2e5(0xa1)]==='SINGLE'?_0x46b2e5(0xb8):_0x41b255[_0x46b2e5(0xee)];await _0x3b04ba[_0x46b2e5(0xb7)][_0x46b2e5(0xf3)]({'where':{'id':_0xb06291[_0x46b2e5(0x8f)]},'data':{'currentPayments':_0x260270,'status':_0x130df3,'updatedAt':new Date()}}),console[_0x46b2e5(0xdd)](_0x46b2e5(0x89)+_0x41b255['id']+_0x46b2e5(0xbd)+_0x41b255['currentPayments']+_0x46b2e5(0xc8)+_0x260270+_0x46b2e5(0x8d)+_0x41b255['status']+_0x46b2e5(0xc8)+_0x130df3);}else console[_0x46b2e5(0xdd)](_0x46b2e5(0x85)+_0xb06291[_0x46b2e5(0x8f)]+_0x46b2e5(0xe8));});}catch(_0xb5503a){console[_0x42603a(0xe9)](_0x42603a(0xd1),_0xb5503a);}}await database_1[_0x42603a(0x8c)][_0x42603a(0xb3)][_0x42603a(0xcf)]({'data':{'paymentId':_0xb06291['id'],'shopId':_0xb06291['shopId'],'event':_0x42603a(0x9b)+_0x430537['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x42603a(0xaa)]({'oldStatus':_0x42603a(0x84),'newStatus':_0x430537[_0x42603a(0xee)],'transactionId':_0x430537[_0x42603a(0xd9)],'failureReason':_0x430537[_0x42603a(0x8e)],'processedAt':new Date()[_0x42603a(0xbc)]()})}}),await this['sendShopWebhook'](_0xb06291,_0x430537[_0x42603a(0xee)],_0x430537['transactionId'],_0x430537['failureReason']),await this['sendPaymentStatusNotification'](_0xb06291,_0x430537['status']),console['log'](_0x42603a(0xec)+_0x4f46a5+_0x42603a(0x87)+_0x430537[_0x42603a(0xee)]),_0x430537[_0x42603a(0xee)]===_0x42603a(0xa9)?_0x4ff184[_0x42603a(0x9a)]({'success':!![],'message':_0x42603a(0xed),'result':{'status':_0x42603a(0xa9),'transactionId':_0x430537[_0x42603a(0xd9)],'redirectUrl':_0xb06291[_0x42603a(0xdc)]}}):_0x4ff184[_0x42603a(0xee)](0x190)[_0x42603a(0x9a)]({'success':![],'message':_0x42603a(0x83),'result':{'status':_0x42603a(0x99),'failureReason':_0x430537[_0x42603a(0x8e)],'redirectUrl':_0xb06291[_0x42603a(0xad)]}});}catch(_0x38044f){_0x49e690(_0x38044f);}},this[_0x1c23ed(0xf8)]=new testGatewayService_1['TestGatewayService'](),this[_0x1c23ed(0xda)]=new webhookService_1[(_0x1c23ed(0xf2))]();}async['sendShopWebhook'](_0x1fcf20,_0x5ac14e,_0x27d3f3,_0x481136){const _0x31353a=a13_0x475c98,_0x3a04e0=Date[_0x31353a(0xcb)]();try{const _0x2bd860=_0x1fcf20[_0x31353a(0xc2)],_0x187d8f=_0x2bd860[_0x31353a(0xd7)];if(!_0x187d8f?.['webhookUrl']){console[_0x31353a(0xdd)](_0x31353a(0x8a)+_0x2bd860['id']);return;}const _0x1409df=_0x5ac14e===_0x31353a(0xa9)?_0x31353a(0xa0):_0x31353a(0xab);let _0x1254f9=[];if(_0x187d8f[_0x31353a(0xeb)])try{_0x1254f9=Array['isArray'](_0x187d8f[_0x31353a(0xeb)])?_0x187d8f[_0x31353a(0xeb)]:JSON[_0x31353a(0xce)](_0x187d8f[_0x31353a(0xeb)]);}catch(_0x71bf49){console['error'](_0x31353a(0xd8),_0x71bf49),_0x1254f9=[];}if(!_0x1254f9['includes'](_0x1409df)){console[_0x31353a(0xdd)](_0x31353a(0xd4)+_0x1409df+_0x31353a(0xb5)+_0x2bd860['id']);return;}const _0x39a70c={'event':_0x1409df,'payment':{'id':_0x1fcf20['id'],'order_id':_0x1fcf20['orderId'],'gateway_order_id':_0x1fcf20[_0x31353a(0x96)],'gateway':'0000','amount':_0x1fcf20[_0x31353a(0xb6)],'currency':_0x1fcf20[_0x31353a(0xd5)],'status':_0x5ac14e[_0x31353a(0xe6)](),'customer_email':_0x1fcf20[_0x31353a(0xd2)],'customer_name':_0x1fcf20[_0x31353a(0xc5)],'transaction_id':_0x27d3f3,'failure_message':_0x481136,'created_at':_0x1fcf20['createdAt'],'updated_at':new Date()}},_0x420c79=await fetch(_0x187d8f[_0x31353a(0xf4)],{'method':'POST','headers':{'Content-Type':_0x31353a(0x90),'User-Agent':_0x31353a(0xa6)},'body':JSON[_0x31353a(0xaa)](_0x39a70c)}),_0x2b5231=Date['now']()-_0x3a04e0;console[_0x31353a(0xdd)](_0x31353a(0x9c)+_0x187d8f['webhookUrl']+'\x20with\x20status\x20'+_0x420c79['status']+'\x20('+_0x2b5231+_0x31353a(0xe5));}catch(_0x3a36cb){console[_0x31353a(0xe9)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x3a36cb);}}async['sendPaymentStatusNotification'](_0x55648f,_0x294b77){const _0xcc7998=a13_0x475c98;try{const {telegramBotService:_0x3b46e1}=await Promise[_0xcc7998(0xcd)]()[_0xcc7998(0xf7)](()=>__importStar(require('../services/telegramBotService'))),_0x33ec4a={'PAID':_0xcc7998(0xc6),'FAILED':'failed'},_0x1c4e5a=_0x33ec4a[_0x294b77];if(!_0x1c4e5a)return;await _0x3b46e1[_0xcc7998(0xba)](_0x55648f['shopId'],_0x55648f,_0x1c4e5a);}catch(_0x389c2a){console[_0xcc7998(0xe9)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x389c2a);}}}exports[a13_0x475c98(0xb0)]=TestGatewayController;