'use strict';function a13_0x324b(_0x5eb9b0,_0x2f961d){const _0x16f115=a13_0x16f1();return a13_0x324b=function(_0x324b3a,_0x265e30){_0x324b3a=_0x324b3a-0x125;let _0x4d4154=_0x16f115[_0x324b3a];return _0x4d4154;},a13_0x324b(_0x5eb9b0,_0x2f961d);}const a13_0x532b01=a13_0x324b;(function(_0x31824a,_0xe94edf){const _0x49ea0d=a13_0x324b,_0x35404=_0x31824a();while(!![]){try{const _0x3bfab0=parseInt(_0x49ea0d(0x197))/0x1*(-parseInt(_0x49ea0d(0x153))/0x2)+-parseInt(_0x49ea0d(0x15e))/0x3*(parseInt(_0x49ea0d(0x148))/0x4)+-parseInt(_0x49ea0d(0x16a))/0x5*(parseInt(_0x49ea0d(0x16d))/0x6)+parseInt(_0x49ea0d(0x12e))/0x7+parseInt(_0x49ea0d(0x15a))/0x8*(-parseInt(_0x49ea0d(0x152))/0x9)+-parseInt(_0x49ea0d(0x139))/0xa+parseInt(_0x49ea0d(0x167))/0xb;if(_0x3bfab0===_0xe94edf)break;else _0x35404['push'](_0x35404['shift']());}catch(_0x9da7c2){_0x35404['push'](_0x35404['shift']());}}}(a13_0x16f1,0x9977a));var __createBinding=this&&this[a13_0x532b01(0x17e)]||(Object[a13_0x532b01(0x159)]?function(_0x2ed549,_0x3141a7,_0x1bc8d6,_0xb5b97f){const _0x4e3d82=a13_0x532b01;if(_0xb5b97f===undefined)_0xb5b97f=_0x1bc8d6;var _0x1cbdd7=Object[_0x4e3d82(0x163)](_0x3141a7,_0x1bc8d6);(!_0x1cbdd7||(_0x4e3d82(0x178)in _0x1cbdd7?!_0x3141a7[_0x4e3d82(0x149)]:_0x1cbdd7[_0x4e3d82(0x133)]||_0x1cbdd7[_0x4e3d82(0x195)]))&&(_0x1cbdd7={'enumerable':!![],'get':function(){return _0x3141a7[_0x1bc8d6];}}),Object['defineProperty'](_0x2ed549,_0xb5b97f,_0x1cbdd7);}:function(_0x1e512c,_0x27993b,_0x15c5b4,_0x2e4ef6){if(_0x2e4ef6===undefined)_0x2e4ef6=_0x15c5b4;_0x1e512c[_0x2e4ef6]=_0x27993b[_0x15c5b4];}),__setModuleDefault=this&&this[a13_0x532b01(0x140)]||(Object[a13_0x532b01(0x159)]?function(_0x16ef4a,_0x36eb68){const _0x5af795=a13_0x532b01;Object['defineProperty'](_0x16ef4a,_0x5af795(0x13b),{'enumerable':!![],'value':_0x36eb68});}:function(_0x167578,_0x2d5b05){const _0x926470=a13_0x532b01;_0x167578[_0x926470(0x13b)]=_0x2d5b05;}),__importStar=this&&this['__importStar']||(function(){var _0x27a731=function(_0x1648e5){const _0x508838=a13_0x324b;return _0x27a731=Object[_0x508838(0x146)]||function(_0x5a3e5a){const _0x18e45a=_0x508838;var _0x526588=[];for(var _0x39fa7e in _0x5a3e5a)if(Object[_0x18e45a(0x136)][_0x18e45a(0x14f)]['call'](_0x5a3e5a,_0x39fa7e))_0x526588[_0x526588[_0x18e45a(0x16b)]]=_0x39fa7e;return _0x526588;},_0x27a731(_0x1648e5);};return function(_0x1fd290){const _0x4030e0=a13_0x324b;if(_0x1fd290&&_0x1fd290[_0x4030e0(0x149)])return _0x1fd290;var _0x49ba6a={};if(_0x1fd290!=null){for(var _0x468d75=_0x27a731(_0x1fd290),_0x211a5b=0x0;_0x211a5b<_0x468d75['length'];_0x211a5b++)if(_0x468d75[_0x211a5b]!==_0x4030e0(0x13b))__createBinding(_0x49ba6a,_0x1fd290,_0x468d75[_0x211a5b]);}return __setModuleDefault(_0x49ba6a,_0x1fd290),_0x49ba6a;};}()),__importDefault=this&&this[a13_0x532b01(0x18f)]||function(_0x3dd6de){const _0x243efe=a13_0x532b01;return _0x3dd6de&&_0x3dd6de[_0x243efe(0x149)]?_0x3dd6de:{'default':_0x3dd6de};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x532b01(0x181)]=void 0x0;function a13_0x16f1(){const _0x43c214=['test_gateway','Payment\x20status\x20is\x20','writable','gatewayPaymentId','gatewayOrderId','prototype','\x20with\x20status\x20','paymentLinkId','10466630zuADui','testGatewayService','default','webhookService','\x20not\x20found','TestGatewayService','amount','__setModuleDefault','error','üß™\x20Test\x20Gateway\x20result:','webhookUrl','../services/gateways/testGatewayService','4242\x204242\x204242\x204242','getOwnPropertyNames','test_gateway_','2584948NaXCvc','__esModule','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','toISOString','payment','parse','json','hasOwnProperty','paymentMethod','createdAt','9zFfcHQ','14lLzYgs','WebhookService','Any\x203-4\x20digits','../config/database','sendPaymentNotification',',\x20cannot\x20process','create','6737032kyKPJD','log','then','sendShopWebhook','3kMlHDm','settings','orderId','stringify','ms)','getOwnPropertyDescriptor','replace','now','POST','40366447SqexPF','SINGLE','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','5aITIcg','length','paymentLink','5479878tGEDNV','\x20processed:\x20','update','paid','Any\x20other\x20card\x20number','Payment\x20is\x20not\x20for\x20test\x20gateway','gateway','../services/webhookService','webhookEvents','toLowerCase','\x20->\x20','get','‚ùå\x20Payment\x20link\x20','failed','payment.failed','customerName','cardNumber','__createBinding','findUnique',',\x20currentPayments=','TestGatewayController','status','failureReason','test_card','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','processCard','PENDING','successUrl','Error\x20parsing\x20webhook\x20events:','Payment\x20not\x20found','slice','PAID','transactionId','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importDefault','cardLast4','shop','$transaction','currentPayments','webhookLog','configurable','type','30679JUBydj','üìà\x20Test\x20Gateway:\x20Payment\x20',',\x20status=','processCardPayment','currency','failureMessage','customerEmail','\x20updated:\x20currentPayments=','FAILED','Payment\x20processed\x20successfully','sendPaymentStatusNotification','shopId','paidAt','resolve','4354140HRwNvG','payment.success','getPaymentForm'];a13_0x16f1=function(){return _0x43c214;};return a13_0x16f1();}const testGatewayService_1=require(a13_0x532b01(0x144)),webhookService_1=require(a13_0x532b01(0x174)),database_1=__importDefault(require(a13_0x532b01(0x156)));class TestGatewayController{constructor(){const _0x5e5941=a13_0x532b01;this[_0x5e5941(0x130)]=async(_0x5b963b,_0x4aaf60,_0x29b45e)=>{const _0x26e477=_0x5e5941;try{const {paymentId:_0xc7c6e1}=_0x5b963b['params'];console[_0x26e477(0x15b)](_0x26e477(0x14a)+_0xc7c6e1);const _0x2602ad=await database_1[_0x26e477(0x13b)][_0x26e477(0x14c)][_0x26e477(0x17f)]({'where':{'id':_0xc7c6e1},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2602ad)return _0x4aaf60[_0x26e477(0x182)](0x194)[_0x26e477(0x14e)]({'success':![],'message':_0x26e477(0x18a)});if(_0x2602ad[_0x26e477(0x173)]!==_0x26e477(0x131))return _0x4aaf60[_0x26e477(0x182)](0x190)[_0x26e477(0x14e)]({'success':![],'message':_0x26e477(0x172)});if(_0x2602ad[_0x26e477(0x182)]!==_0x26e477(0x187))return _0x4aaf60[_0x26e477(0x182)](0x190)['json']({'success':![],'message':_0x26e477(0x132)+_0x2602ad[_0x26e477(0x182)]+_0x26e477(0x158)});_0x4aaf60[_0x26e477(0x14e)]({'success':!![],'result':{'paymentId':_0x2602ad['id'],'orderId':_0x2602ad[_0x26e477(0x135)],'amount':_0x2602ad[_0x26e477(0x13f)],'currency':_0x2602ad[_0x26e477(0x19b)],'merchantName':_0x2602ad['shop']['name'],'description':'Payment\x20to\x20'+_0x2602ad['shop']['name'],'testInstructions':{'successCard':_0x26e477(0x145),'failureCard':_0x26e477(0x171),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x26e477(0x155),'holderName':'Any\x20name'}}});}catch(_0x2eb74a){_0x29b45e(_0x2eb74a);}},this[_0x5e5941(0x186)]=async(_0xf60a3c,_0x4203ed,_0x46e954)=>{const _0xff9ada=_0x5e5941;try{const {paymentId:_0x3f8fdc}=_0xf60a3c['params'],_0x214ec0=_0xf60a3c['body'];console['log'](_0xff9ada(0x18e)+_0x3f8fdc);const _0x4ac327=await database_1['default'][_0xff9ada(0x14c)][_0xff9ada(0x17f)]({'where':{'id':_0x3f8fdc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ac327)return _0x4203ed[_0xff9ada(0x182)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x4ac327[_0xff9ada(0x173)]!=='test_gateway')return _0x4203ed[_0xff9ada(0x182)](0x190)[_0xff9ada(0x14e)]({'success':![],'message':_0xff9ada(0x172)});if(_0x4ac327['status']!==_0xff9ada(0x187))return _0x4203ed[_0xff9ada(0x182)](0x190)[_0xff9ada(0x14e)]({'success':![],'message':_0xff9ada(0x132)+_0x4ac327[_0xff9ada(0x182)]+_0xff9ada(0x158)});const _0x1c6405=await this[_0xff9ada(0x13a)][_0xff9ada(0x19a)]({'paymentId':_0x4ac327['id'],'orderId':_0x4ac327['gatewayOrderId']||_0x4ac327['id'],'amount':_0x4ac327['amount'],'currency':_0x4ac327[_0xff9ada(0x19b)],'cardData':_0x214ec0});console[_0xff9ada(0x15b)](_0xff9ada(0x142),_0x1c6405);const _0x2e9d1e={'status':_0x1c6405[_0xff9ada(0x182)],'updatedAt':new Date()};if(_0x1c6405[_0xff9ada(0x182)]==='PAID')_0x2e9d1e[_0xff9ada(0x12c)]=new Date(),_0x2e9d1e[_0xff9ada(0x134)]=_0x1c6405['transactionId'];else _0x1c6405['status']===_0xff9ada(0x128)&&(_0x2e9d1e[_0xff9ada(0x125)]=_0x1c6405[_0xff9ada(0x183)]);const _0x20444c=_0x214ec0[_0xff9ada(0x17d)][_0xff9ada(0x164)](/[\s-]/g,'');_0x2e9d1e[_0xff9ada(0x190)]=_0x20444c[_0xff9ada(0x18b)](-0x4),_0x2e9d1e[_0xff9ada(0x150)]=_0xff9ada(0x184),await database_1[_0xff9ada(0x13b)][_0xff9ada(0x14c)][_0xff9ada(0x16f)]({'where':{'id':_0x4ac327['id']},'data':_0x2e9d1e});if(_0x1c6405['status']==='PAID'&&_0x4ac327[_0xff9ada(0x138)]){console['log'](_0xff9ada(0x198)+_0x4ac327['id']+_0xff9ada(0x185));try{await database_1[_0xff9ada(0x13b)][_0xff9ada(0x192)](async _0x5028bb=>{const _0x41d57d=_0xff9ada,_0x439ac3=await _0x5028bb['paymentLink']['findUnique']({'where':{'id':_0x4ac327[_0x41d57d(0x138)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x439ac3){console[_0x41d57d(0x15b)]('üìà\x20Found\x20payment\x20link\x20'+_0x439ac3['id']+':\x20type='+_0x439ac3[_0x41d57d(0x196)]+_0x41d57d(0x180)+_0x439ac3[_0x41d57d(0x193)]+_0x41d57d(0x199)+_0x439ac3[_0x41d57d(0x182)]);const _0x5748c8=_0x439ac3[_0x41d57d(0x193)]+0x1,_0x1fef14=_0x439ac3[_0x41d57d(0x196)]===_0x41d57d(0x168)?'COMPLETED':_0x439ac3[_0x41d57d(0x182)];await _0x5028bb[_0x41d57d(0x16c)][_0x41d57d(0x16f)]({'where':{'id':_0x4ac327[_0x41d57d(0x138)]},'data':{'currentPayments':_0x5748c8,'status':_0x1fef14,'updatedAt':new Date()}}),console[_0x41d57d(0x15b)]('‚úÖ\x20Payment\x20link\x20'+_0x439ac3['id']+_0x41d57d(0x127)+_0x439ac3[_0x41d57d(0x193)]+_0x41d57d(0x177)+_0x5748c8+_0x41d57d(0x199)+_0x439ac3[_0x41d57d(0x182)]+_0x41d57d(0x177)+_0x1fef14);}else console[_0x41d57d(0x15b)](_0x41d57d(0x179)+_0x4ac327['paymentLinkId']+_0x41d57d(0x13d));});}catch(_0x2c8799){console[_0xff9ada(0x141)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x2c8799);}}await database_1['default'][_0xff9ada(0x194)][_0xff9ada(0x159)]({'data':{'paymentId':_0x4ac327['id'],'shopId':_0x4ac327[_0xff9ada(0x12b)],'event':_0xff9ada(0x147)+_0x1c6405[_0xff9ada(0x182)][_0xff9ada(0x176)](),'statusCode':0xc8,'responseBody':JSON[_0xff9ada(0x161)]({'oldStatus':'PENDING','newStatus':_0x1c6405['status'],'transactionId':_0x1c6405[_0xff9ada(0x18d)],'failureReason':_0x1c6405[_0xff9ada(0x183)],'processedAt':new Date()[_0xff9ada(0x14b)]()})}}),await this[_0xff9ada(0x15d)](_0x4ac327,_0x1c6405[_0xff9ada(0x182)],_0x1c6405[_0xff9ada(0x18d)],_0x1c6405['failureReason']),await this[_0xff9ada(0x12a)](_0x4ac327,_0x1c6405[_0xff9ada(0x182)]),console[_0xff9ada(0x15b)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x3f8fdc+_0xff9ada(0x16e)+_0x1c6405[_0xff9ada(0x182)]),_0x1c6405[_0xff9ada(0x182)]===_0xff9ada(0x18c)?_0x4203ed['json']({'success':!![],'message':_0xff9ada(0x129),'result':{'status':'PAID','transactionId':_0x1c6405[_0xff9ada(0x18d)],'redirectUrl':_0x4ac327[_0xff9ada(0x188)]}}):_0x4203ed['status'](0x190)[_0xff9ada(0x14e)]({'success':![],'message':'Payment\x20failed','result':{'status':_0xff9ada(0x128),'failureReason':_0x1c6405['failureReason'],'redirectUrl':_0x4ac327['failUrl']}});}catch(_0x3facb7){_0x46e954(_0x3facb7);}},this[_0x5e5941(0x13a)]=new testGatewayService_1[(_0x5e5941(0x13e))](),this[_0x5e5941(0x13c)]=new webhookService_1[(_0x5e5941(0x154))]();}async[a13_0x532b01(0x15d)](_0x59ddea,_0x367596,_0x2c34f7,_0x874cee){const _0x28e986=a13_0x532b01,_0x192b0a=Date[_0x28e986(0x165)]();try{const _0xbc9e42=_0x59ddea[_0x28e986(0x191)],_0x609379=_0xbc9e42[_0x28e986(0x15f)];if(!_0x609379?.['webhookUrl']){console[_0x28e986(0x15b)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xbc9e42['id']);return;}const _0x555b5d=_0x367596==='PAID'?_0x28e986(0x12f):_0x28e986(0x17b);let _0x59c8c4=[];if(_0x609379['webhookEvents'])try{_0x59c8c4=Array['isArray'](_0x609379[_0x28e986(0x175)])?_0x609379['webhookEvents']:JSON[_0x28e986(0x14d)](_0x609379['webhookEvents']);}catch(_0x2e3d47){console[_0x28e986(0x141)](_0x28e986(0x189),_0x2e3d47),_0x59c8c4=[];}if(!_0x59c8c4['includes'](_0x555b5d)){console[_0x28e986(0x15b)]('Webhook\x20event\x20'+_0x555b5d+'\x20not\x20enabled\x20for\x20shop\x20'+_0xbc9e42['id']);return;}const _0x45a4f8={'event':_0x555b5d,'payment':{'id':_0x59ddea['id'],'order_id':_0x59ddea[_0x28e986(0x160)],'gateway_order_id':_0x59ddea[_0x28e986(0x135)],'gateway':'0000','amount':_0x59ddea[_0x28e986(0x13f)],'currency':_0x59ddea[_0x28e986(0x19b)],'status':_0x367596[_0x28e986(0x176)](),'customer_email':_0x59ddea[_0x28e986(0x126)],'customer_name':_0x59ddea[_0x28e986(0x17c)],'transaction_id':_0x2c34f7,'failure_message':_0x874cee,'created_at':_0x59ddea[_0x28e986(0x151)],'updated_at':new Date()}},_0x158e9e=await fetch(_0x609379[_0x28e986(0x143)],{'method':_0x28e986(0x166),'headers':{'Content-Type':'application/json','User-Agent':_0x28e986(0x169)},'body':JSON[_0x28e986(0x161)](_0x45a4f8)}),_0x4ae605=Date[_0x28e986(0x165)]()-_0x192b0a;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x609379[_0x28e986(0x143)]+_0x28e986(0x137)+_0x158e9e['status']+'\x20('+_0x4ae605+_0x28e986(0x162));}catch(_0x4807a9){console[_0x28e986(0x141)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x4807a9);}}async['sendPaymentStatusNotification'](_0x50947b,_0x4ba755){const _0x34f93f=a13_0x532b01;try{const {telegramBotService:_0x3f228b}=await Promise[_0x34f93f(0x12d)]()[_0x34f93f(0x15c)](()=>__importStar(require('../services/telegramBotService'))),_0x5eac10={'PAID':_0x34f93f(0x170),'FAILED':_0x34f93f(0x17a)},_0x346650=_0x5eac10[_0x4ba755];if(!_0x346650)return;await _0x3f228b[_0x34f93f(0x157)](_0x50947b[_0x34f93f(0x12b)],_0x50947b,_0x346650);}catch(_0xb57f44){console[_0x34f93f(0x141)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xb57f44);}}}exports[a13_0x532b01(0x181)]=TestGatewayController;