'use strict';const a21_0x1114e7=a21_0x13fe;(function(_0x52300f,_0x4bcd15){const _0x4b7e8d=a21_0x13fe,_0x201861=_0x52300f();while(!![]){try{const _0x3705f9=-parseInt(_0x4b7e8d(0x1b2))/0x1*(-parseInt(_0x4b7e8d(0x1f7))/0x2)+parseInt(_0x4b7e8d(0x1ba))/0x3*(parseInt(_0x4b7e8d(0x1b9))/0x4)+parseInt(_0x4b7e8d(0x194))/0x5*(parseInt(_0x4b7e8d(0x1b4))/0x6)+-parseInt(_0x4b7e8d(0x1f2))/0x7+-parseInt(_0x4b7e8d(0x1c4))/0x8*(-parseInt(_0x4b7e8d(0x1fe))/0x9)+parseInt(_0x4b7e8d(0x206))/0xa*(-parseInt(_0x4b7e8d(0x1f3))/0xb)+parseInt(_0x4b7e8d(0x1ae))/0xc;if(_0x3705f9===_0x4bcd15)break;else _0x201861['push'](_0x201861['shift']());}catch(_0xf79937){_0x201861['push'](_0x201861['shift']());}}}(a21_0x1227,0x70631));var __createBinding=this&&this[a21_0x1114e7(0x1ce)]||(Object[a21_0x1114e7(0x19b)]?function(_0x173142,_0x7db958,_0x39a678,_0x25c98f){const _0x5833ac=a21_0x1114e7;if(_0x25c98f===undefined)_0x25c98f=_0x39a678;var _0x1eb312=Object[_0x5833ac(0x1e8)](_0x7db958,_0x39a678);(!_0x1eb312||(_0x5833ac(0x18a)in _0x1eb312?!_0x7db958[_0x5833ac(0x1ed)]:_0x1eb312[_0x5833ac(0x1ef)]||_0x1eb312[_0x5833ac(0x1b3)]))&&(_0x1eb312={'enumerable':!![],'get':function(){return _0x7db958[_0x39a678];}}),Object[_0x5833ac(0x1d1)](_0x173142,_0x25c98f,_0x1eb312);}:function(_0x5cbd32,_0x4de03c,_0x24a5dd,_0x322f2d){if(_0x322f2d===undefined)_0x322f2d=_0x24a5dd;_0x5cbd32[_0x322f2d]=_0x4de03c[_0x24a5dd];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a21_0x1114e7(0x19b)]?function(_0x22d718,_0x45bca5){const _0x57687e=a21_0x1114e7;Object[_0x57687e(0x1d1)](_0x22d718,_0x57687e(0x19d),{'enumerable':!![],'value':_0x45bca5});}:function(_0x73f6d9,_0x206caf){const _0x26ed5c=a21_0x1114e7;_0x73f6d9[_0x26ed5c(0x19d)]=_0x206caf;}),__importStar=this&&this['__importStar']||(function(){var _0x16051c=function(_0x53767d){const _0x3e5a9d=a21_0x13fe;return _0x16051c=Object[_0x3e5a9d(0x1ea)]||function(_0xd7412a){const _0x53ae08=_0x3e5a9d;var _0x557675=[];for(var _0x229368 in _0xd7412a)if(Object[_0x53ae08(0x1a7)]['hasOwnProperty'][_0x53ae08(0x20e)](_0xd7412a,_0x229368))_0x557675[_0x557675[_0x53ae08(0x1c5)]]=_0x229368;return _0x557675;},_0x16051c(_0x53767d);};return function(_0x2a8149){const _0x1ec1d7=a21_0x13fe;if(_0x2a8149&&_0x2a8149[_0x1ec1d7(0x1ed)])return _0x2a8149;var _0x3e1220={};if(_0x2a8149!=null){for(var _0x2d0fa9=_0x16051c(_0x2a8149),_0x268e61=0x0;_0x268e61<_0x2d0fa9['length'];_0x268e61++)if(_0x2d0fa9[_0x268e61]!==_0x1ec1d7(0x19d))__createBinding(_0x3e1220,_0x2a8149,_0x2d0fa9[_0x268e61]);}return __setModuleDefault(_0x3e1220,_0x2a8149),_0x3e1220;};}()),__importDefault=this&&this[a21_0x1114e7(0x1aa)]||function(_0x51ac7e){const _0x5ef4c5=a21_0x1114e7;return _0x51ac7e&&_0x51ac7e[_0x5ef4c5(0x1ed)]?_0x51ac7e:{'default':_0x51ac7e};};Object[a21_0x1114e7(0x1d1)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;function a21_0x1227(){const _0x11904a=['16qHCnty','439116trrynu','âŒ\x20Payment\x20link\x20','0000','Payment\x20failed','failUrl','gatewayOrderId','then','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','sendPaymentStatusNotification','application/json','584344tDBxTv','length','failureReason','FAILED','parse','...','orderId','amount','Payment\x20to\x20','../services/gateways/testGatewayService','__createBinding','customerName','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','defineProperty','âœ…\x20Payment\x20link\x20','replace','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','name','Error\x20parsing\x20webhook\x20events:','ðŸ§ª\x20Test\x20Gateway\x20result:','WebhookService','PENDING','json','gatewayPaymentId','âš ï¸\x20Webhook\x20event\x20','update','webhookLog','test_gateway','toLowerCase','status','body','createHmac','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','digest','currentPayments',',\x20cannot\x20process','getOwnPropertyDescriptor','resolve','getOwnPropertyNames','includes','Payment\x20is\x20not\x20for\x20test\x20gateway','__esModule','ðŸ“ˆ\x20Found\x20payment\x20link\x20','writable','paymentLinkId','paid','1973188eGzeOq','1002793YKNRdd','Payment\x20not\x20found','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','test_card','502dfaPTS','TestGatewayService','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','customerEmail',':\x20type=','failed','webhookUrl','36bHvqtn','SINGLE','payment','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','\x20processed:\x20','type','sha256','COMPLETED','80dvsCne','shopId','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event=','transactionId','4242\x204242\x204242\x204242','ðŸ§ª\x20Sending\x20webhook\x20to\x20','toISOString','call','Payment\x20System/1.0\x20(Test\x20Gateway)','PAID','hex','get','\x20with\x20status\x20','\x20not\x20enabled\x20for\x20shop\x20','configured','paidAt','createdAt','$transaction','Payment\x20status\x20is\x20',',\x20status=','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','390NTpjhP','TestGatewayController',',\x20webhookUrl=','gateway','findUnique','log','test_gateway_','create','now','default','sendPaymentNotification','âœ…\x20Test\x20Gateway\x20payment\x20','processCardPayment','webhookEvents','slice','cardLast4','shop','\x20->\x20','cardNumber','prototype','failureMessage','Any\x203-4\x20digits','__importDefault','Any\x20name','isArray','paymentLink','8484xGIHfE','Any\x20other\x20card\x20number','../config/database','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','356GEvVCH','configurable','38754QRWqXm','error','webhookService','currency','sendShopWebhook'];a21_0x1227=function(){return _0x11904a;};return a21_0x1227();}function a21_0x13fe(_0xa2778d,_0x51b463){_0xa2778d=_0xa2778d-0x18a;const _0x1227a9=a21_0x1227();let _0x13fe55=_0x1227a9[_0xa2778d];return _0x13fe55;}const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require(a21_0x1114e7(0x1cd)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a21_0x1114e7(0x1b0)));class TestGatewayController{constructor(){const _0x1135a8=a21_0x1114e7;this['getPaymentForm']=async(_0x4b3cdf,_0xb19a3a,_0x8b62e6)=>{const _0x1145e9=a21_0x13fe;try{const {paymentId:_0x3eb629}=_0x4b3cdf['params'];console['log'](_0x1145e9(0x1d4)+_0x3eb629);const _0x39b513=await database_1[_0x1145e9(0x19d)][_0x1145e9(0x200)][_0x1145e9(0x198)]({'where':{'id':_0x3eb629},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x39b513)return _0xb19a3a[_0x1145e9(0x1e1)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x39b513[_0x1145e9(0x197)]!==_0x1145e9(0x1df))return _0xb19a3a['status'](0x190)[_0x1145e9(0x1da)]({'success':![],'message':_0x1145e9(0x1ec)});if(_0x39b513[_0x1145e9(0x1e1)]!==_0x1145e9(0x1d9))return _0xb19a3a['status'](0x190)['json']({'success':![],'message':_0x1145e9(0x191)+_0x39b513[_0x1145e9(0x1e1)]+',\x20cannot\x20process'});_0xb19a3a[_0x1145e9(0x1da)]({'success':!![],'result':{'paymentId':_0x39b513['id'],'orderId':_0x39b513['gatewayOrderId'],'amount':_0x39b513[_0x1145e9(0x1cb)],'currency':_0x39b513[_0x1145e9(0x1b7)],'merchantName':_0x39b513['shop'][_0x1145e9(0x1d5)],'description':_0x1145e9(0x1cc)+_0x39b513[_0x1145e9(0x1a4)][_0x1145e9(0x1d5)],'testInstructions':{'successCard':_0x1145e9(0x20b),'failureCard':_0x1145e9(0x1af),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x1145e9(0x1a9),'holderName':_0x1145e9(0x1ab)}}});}catch(_0x5e839d){_0x8b62e6(_0x5e839d);}},this['processCard']=async(_0x1d3899,_0x28efed,_0x1f5587)=>{const _0x168d09=a21_0x13fe;try{const {paymentId:_0x18ab36}=_0x1d3899['params'],_0x4caa77=_0x1d3899[_0x168d09(0x1e2)];console[_0x168d09(0x199)](_0x168d09(0x1e4)+_0x18ab36);const _0x3f8b92=await database_1[_0x168d09(0x19d)][_0x168d09(0x200)][_0x168d09(0x198)]({'where':{'id':_0x18ab36},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f8b92)return _0x28efed[_0x168d09(0x1e1)](0x194)[_0x168d09(0x1da)]({'success':![],'message':_0x168d09(0x1f4)});if(_0x3f8b92['gateway']!==_0x168d09(0x1df))return _0x28efed[_0x168d09(0x1e1)](0x190)[_0x168d09(0x1da)]({'success':![],'message':_0x168d09(0x1ec)});if(_0x3f8b92[_0x168d09(0x1e1)]!==_0x168d09(0x1d9))return _0x28efed['status'](0x190)[_0x168d09(0x1da)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3f8b92['status']+_0x168d09(0x1e7)});const _0x270a1d=await this['testGatewayService'][_0x168d09(0x1a0)]({'paymentId':_0x3f8b92['id'],'orderId':_0x3f8b92[_0x168d09(0x1bf)]||_0x3f8b92['id'],'amount':_0x3f8b92['amount'],'currency':_0x3f8b92[_0x168d09(0x1b7)],'cardData':_0x4caa77});console[_0x168d09(0x199)](_0x168d09(0x1d7),_0x270a1d);const _0x4784c6={'status':_0x270a1d['status'],'updatedAt':new Date()};if(_0x270a1d['status']==='PAID')_0x4784c6[_0x168d09(0x18e)]=new Date(),_0x4784c6[_0x168d09(0x1db)]=_0x270a1d[_0x168d09(0x20a)];else _0x270a1d[_0x168d09(0x1e1)]===_0x168d09(0x1c7)&&(_0x4784c6[_0x168d09(0x1a8)]=_0x270a1d[_0x168d09(0x1c6)]);const _0x3cb104=_0x4caa77[_0x168d09(0x1a6)][_0x168d09(0x1d3)](/[\s-]/g,'');_0x4784c6[_0x168d09(0x1a3)]=_0x3cb104[_0x168d09(0x1a2)](-0x4),_0x4784c6['paymentMethod']=_0x168d09(0x1f6),await database_1['default'][_0x168d09(0x200)][_0x168d09(0x1dd)]({'where':{'id':_0x3f8b92['id']},'data':_0x4784c6});if(_0x270a1d[_0x168d09(0x1e1)]==='PAID'&&_0x3f8b92[_0x168d09(0x1f0)]){console[_0x168d09(0x199)](_0x168d09(0x201)+_0x3f8b92['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x168d09(0x190)](async _0x54f43a=>{const _0x1ea81f=_0x168d09,_0x2757d4=await _0x54f43a[_0x1ea81f(0x1ad)][_0x1ea81f(0x198)]({'where':{'id':_0x3f8b92['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2757d4){console['log'](_0x1ea81f(0x1ee)+_0x2757d4['id']+_0x1ea81f(0x1fb)+_0x2757d4[_0x1ea81f(0x203)]+',\x20currentPayments='+_0x2757d4[_0x1ea81f(0x1e6)]+_0x1ea81f(0x192)+_0x2757d4[_0x1ea81f(0x1e1)]);const _0xbe74b9=_0x2757d4[_0x1ea81f(0x1e6)]+0x1,_0x2fdaf1=_0x2757d4['type']===_0x1ea81f(0x1ff)?_0x1ea81f(0x205):_0x2757d4[_0x1ea81f(0x1e1)];await _0x54f43a[_0x1ea81f(0x1ad)][_0x1ea81f(0x1dd)]({'where':{'id':_0x3f8b92[_0x1ea81f(0x1f0)]},'data':{'currentPayments':_0xbe74b9,'status':_0x2fdaf1,'updatedAt':new Date()}}),console[_0x1ea81f(0x199)](_0x1ea81f(0x1d2)+_0x2757d4['id']+'\x20updated:\x20currentPayments='+_0x2757d4[_0x1ea81f(0x1e6)]+_0x1ea81f(0x1a5)+_0xbe74b9+_0x1ea81f(0x192)+_0x2757d4[_0x1ea81f(0x1e1)]+_0x1ea81f(0x1a5)+_0x2fdaf1);}else console[_0x1ea81f(0x199)](_0x1ea81f(0x1bb)+_0x3f8b92['paymentLinkId']+'\x20not\x20found');});}catch(_0x13da69){console[_0x168d09(0x1b5)](_0x168d09(0x1f9),_0x13da69);}}await database_1['default'][_0x168d09(0x1de)][_0x168d09(0x19b)]({'data':{'paymentId':_0x3f8b92['id'],'shopId':_0x3f8b92[_0x168d09(0x207)],'event':_0x168d09(0x19a)+_0x270a1d[_0x168d09(0x1e1)][_0x168d09(0x1e0)](),'statusCode':_0x270a1d['status']===_0x168d09(0x210)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':_0x168d09(0x1d9),'newStatus':_0x270a1d['status'],'transactionId':_0x270a1d[_0x168d09(0x20a)],'failureReason':_0x270a1d[_0x168d09(0x1c6)],'processedAt':new Date()[_0x168d09(0x20d)]()})}}),console[_0x168d09(0x199)]('ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20'+_0x270a1d[_0x168d09(0x1e1)]+_0x168d09(0x1c9)),await this[_0x168d09(0x1b8)](_0x3f8b92,_0x270a1d['status'],_0x270a1d[_0x168d09(0x20a)],_0x270a1d[_0x168d09(0x1c6)]),console[_0x168d09(0x199)](_0x168d09(0x1f5)+_0x270a1d[_0x168d09(0x1e1)]),console[_0x168d09(0x199)](_0x168d09(0x208)+_0x270a1d[_0x168d09(0x1e1)]+_0x168d09(0x1c9)),await this[_0x168d09(0x1c2)](_0x3f8b92,_0x270a1d[_0x168d09(0x1e1)]),console['log'](_0x168d09(0x1c1)+_0x270a1d['status']),console[_0x168d09(0x199)](_0x168d09(0x19f)+_0x18ab36+_0x168d09(0x202)+_0x270a1d[_0x168d09(0x1e1)]),_0x270a1d[_0x168d09(0x1e1)]==='PAID'?_0x28efed[_0x168d09(0x1da)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x168d09(0x210),'transactionId':_0x270a1d[_0x168d09(0x20a)],'redirectUrl':_0x3f8b92['successUrl']}}):_0x28efed[_0x168d09(0x1e1)](0x190)[_0x168d09(0x1da)]({'success':![],'message':_0x168d09(0x1bd),'result':{'status':_0x168d09(0x1c7),'failureReason':_0x270a1d[_0x168d09(0x1c6)],'redirectUrl':_0x3f8b92[_0x168d09(0x1be)]}});}catch(_0x5c9316){_0x1f5587(_0x5c9316);}},this['testGatewayService']=new testGatewayService_1[(_0x1135a8(0x1f8))](),this[_0x1135a8(0x1b6)]=new webhookService_1[(_0x1135a8(0x1d8))]();}async[a21_0x1114e7(0x1b8)](_0x4bead3,_0x3ac1e8,_0x51c86d,_0x3c7749){const _0x406dc8=a21_0x1114e7,_0x56ca5e=Date[_0x406dc8(0x19c)]();try{const _0x34f72a=_0x4bead3[_0x406dc8(0x1a4)],_0x3f14f8=_0x34f72a['settings'];if(!_0x3f14f8?.[_0x406dc8(0x1fd)]){console[_0x406dc8(0x199)](_0x406dc8(0x1b1)+_0x34f72a['id']);return;}const _0x29442c=_0x3ac1e8==='PAID'?'payment.success':'payment.failed';console[_0x406dc8(0x199)](_0x406dc8(0x209)+_0x29442c+_0x406dc8(0x196)+(_0x3f14f8['webhookUrl']?_0x406dc8(0x18d):'not\x20configured'));let _0x1e2df0=[];if(_0x3f14f8[_0x406dc8(0x1a1)])try{_0x1e2df0=Array[_0x406dc8(0x1ac)](_0x3f14f8['webhookEvents'])?_0x3f14f8[_0x406dc8(0x1a1)]:JSON[_0x406dc8(0x1c8)](_0x3f14f8[_0x406dc8(0x1a1)]);}catch(_0x4b603b){console['error'](_0x406dc8(0x1d6),_0x4b603b),_0x1e2df0=[];}console['log'](_0x406dc8(0x193),_0x1e2df0);if(!_0x1e2df0[_0x406dc8(0x1eb)](_0x29442c)){console[_0x406dc8(0x199)](_0x406dc8(0x1dc)+_0x29442c+_0x406dc8(0x18c)+_0x34f72a['id']);return;}const _0x595e67={'event':_0x29442c,'payment':{'id':_0x4bead3['id'],'order_id':_0x4bead3[_0x406dc8(0x1ca)],'gateway_order_id':_0x4bead3[_0x406dc8(0x1bf)],'gateway':_0x406dc8(0x1bc),'amount':_0x4bead3['amount'],'currency':_0x4bead3['currency'],'status':_0x3ac1e8[_0x406dc8(0x1e0)](),'customer_email':_0x4bead3[_0x406dc8(0x1fa)],'customer_name':_0x4bead3[_0x406dc8(0x1cf)],'transaction_id':_0x51c86d,'failure_message':_0x3c7749,'created_at':_0x4bead3[_0x406dc8(0x18f)],'updated_at':new Date()}};console[_0x406dc8(0x199)](_0x406dc8(0x20c)+_0x3f14f8[_0x406dc8(0x1fd)]+'...'),console['log']('ðŸ§ª\x20Webhook\x20payload:',JSON['stringify'](_0x595e67,null,0x2));const _0x39b733=JSON['stringify'](_0x595e67),_0x156fb3=crypto_1[_0x406dc8(0x19d)][_0x406dc8(0x1e3)](_0x406dc8(0x204),_0x34f72a['secretKey'])[_0x406dc8(0x1dd)](_0x39b733)[_0x406dc8(0x1e5)](_0x406dc8(0x211)),_0x532a17=await fetch(_0x3f14f8['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x406dc8(0x1c3),'User-Agent':_0x406dc8(0x20f),'X-Webhook-Signature':_0x156fb3},'body':_0x39b733}),_0x381430=Date['now']()-_0x56ca5e;console[_0x406dc8(0x199)]('âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x3f14f8['webhookUrl']+_0x406dc8(0x18b)+_0x532a17['status']+'\x20('+_0x381430+'ms)');}catch(_0x330293){console['error'](_0x406dc8(0x1d0),_0x330293);}}async[a21_0x1114e7(0x1c2)](_0x6368ed,_0x85b038){const _0x261b39=a21_0x1114e7;try{const {telegramBotService:_0x55b746}=await Promise[_0x261b39(0x1e9)]()[_0x261b39(0x1c0)](()=>__importStar(require('../services/telegramBotService'))),_0x15a2cb={'PAID':_0x261b39(0x1f1),'FAILED':_0x261b39(0x1fc)},_0x417911=_0x15a2cb[_0x85b038];if(!_0x417911)return;await _0x55b746[_0x261b39(0x19e)](_0x6368ed[_0x261b39(0x207)],_0x6368ed,_0x417911);}catch(_0x2247c9){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2247c9);}}}exports[a21_0x1114e7(0x195)]=TestGatewayController;