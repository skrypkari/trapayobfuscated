'use strict';function a19_0x4305(){const _0xb7e69c=['../services/gateways/testGatewayService','body','0000','createdAt','__createBinding','shop','Payment\x20not\x20found','failUrl','cardNumber','33544DvCFUh','webhookEvents','isArray','payment','457txLquQ','includes','paymentLinkId','Any\x20future\x20date\x20(MM/YY)','gateway','872PxaauO','âŒ\x20Payment\x20link\x20','test_gateway_','../config/database','settings','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','44ATuduK','3156aLBlwG','TestGatewayService','params','webhookService','__importDefault','Payment\x20processed\x20successfully','TestGatewayController','Payment\x20failed','transactionId','shopId','replace','âœ…\x20Test\x20Gateway\x20payment\x20','POST','parse','slice','1314gYxGkx','payment.failed','1038888bgSFVY',',\x20status=','getPaymentForm','defineProperty','get','Any\x20other\x20card\x20number','successUrl','paid','type','hasOwnProperty','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','5109260nYuauD','customerEmail','__esModule','sendShopWebhook','PENDING','default','Webhook\x20event\x20',':\x20type=','274233HDEWiH','paymentMethod','Payment\x20to\x20','prototype','373471XirHWS','status','customerName','error','Payment\x20status\x20is\x20','\x20processed:\x20','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','then','now','1810WRlJiX','currentPayments','testGatewayService','6pRFEVe','amount','Test\x20Gateway\x20webhook\x20sent\x20to\x20','test_gateway','Any\x203-4\x20digits','FAILED','configurable','__setModuleDefault','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','toISOString','findUnique','gatewayPaymentId','4242\x204242\x204242\x204242','../services/telegramBotService','paymentLink','ðŸ“ˆ\x20Found\x20payment\x20link\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','update','\x20not\x20found','\x20not\x20enabled\x20for\x20shop\x20','failureReason',',\x20currentPayments=','gatewayOrderId','processCardPayment','json','COMPLETED','getOwnPropertyNames','name','../services/webhookService','PAID','stringify','create','\x20->\x20','call','webhookUrl','cardLast4','WebhookService','Payment\x20System/1.0\x20(Test\x20Gateway)','ms)','failed','currency',',\x20cannot\x20process','toLowerCase','log','Payment\x20is\x20not\x20for\x20test\x20gateway','webhookLog','Error\x20parsing\x20webhook\x20events:','orderId','__importStar'];a19_0x4305=function(){return _0xb7e69c;};return a19_0x4305();}const a19_0xe21958=a19_0x178e;(function(_0x1edc80,_0x5bc1a1){const _0xd23b74=a19_0x178e,_0xb1238=_0x1edc80();while(!![]){try{const _0x1c0469=parseInt(_0xd23b74(0x124))/0x1*(parseInt(_0xd23b74(0x129))/0x2)+-parseInt(_0xd23b74(0x154))/0x3+parseInt(_0xd23b74(0x130))/0x4*(-parseInt(_0xd23b74(0x161))/0x5)+-parseInt(_0xd23b74(0x164))/0x6*(-parseInt(_0xd23b74(0x158))/0x7)+parseInt(_0xd23b74(0x19e))/0x8*(parseInt(_0xd23b74(0x13f))/0x9)+-parseInt(_0xd23b74(0x14c))/0xa+-parseInt(_0xd23b74(0x12f))/0xb*(-parseInt(_0xd23b74(0x141))/0xc);if(_0x1c0469===_0x5bc1a1)break;else _0xb1238['push'](_0xb1238['shift']());}catch(_0x48463e){_0xb1238['push'](_0xb1238['shift']());}}}(a19_0x4305,0x4ee34));var __createBinding=this&&this[a19_0xe21958(0x199)]||(Object['create']?function(_0x4aa8b4,_0x4dac47,_0xe84c2d,_0x2cf9ad){const _0x3a3b5e=a19_0xe21958;if(_0x2cf9ad===undefined)_0x2cf9ad=_0xe84c2d;var _0x1dd9d2=Object['getOwnPropertyDescriptor'](_0x4dac47,_0xe84c2d);(!_0x1dd9d2||(_0x3a3b5e(0x145)in _0x1dd9d2?!_0x4dac47['__esModule']:_0x1dd9d2['writable']||_0x1dd9d2[_0x3a3b5e(0x16a)]))&&(_0x1dd9d2={'enumerable':!![],'get':function(){return _0x4dac47[_0xe84c2d];}}),Object['defineProperty'](_0x4aa8b4,_0x2cf9ad,_0x1dd9d2);}:function(_0x53ac25,_0xdd8bfe,_0xad35f5,_0xb8dc6e){if(_0xb8dc6e===undefined)_0xb8dc6e=_0xad35f5;_0x53ac25[_0xb8dc6e]=_0xdd8bfe[_0xad35f5];}),__setModuleDefault=this&&this[a19_0xe21958(0x16b)]||(Object[a19_0xe21958(0x183)]?function(_0x3075c8,_0x4ec52){const _0xc81172=a19_0xe21958;Object['defineProperty'](_0x3075c8,_0xc81172(0x151),{'enumerable':!![],'value':_0x4ec52});}:function(_0x172d2d,_0x217be5){const _0x2a4d38=a19_0xe21958;_0x172d2d[_0x2a4d38(0x151)]=_0x217be5;}),__importStar=this&&this[a19_0xe21958(0x194)]||(function(){var _0x4be1df=function(_0x112c3e){const _0x5b5a07=a19_0x178e;return _0x4be1df=Object[_0x5b5a07(0x17e)]||function(_0x42042){const _0x26584c=_0x5b5a07;var _0x5c1971=[];for(var _0x3045f2 in _0x42042)if(Object[_0x26584c(0x157)][_0x26584c(0x14a)][_0x26584c(0x185)](_0x42042,_0x3045f2))_0x5c1971[_0x5c1971['length']]=_0x3045f2;return _0x5c1971;},_0x4be1df(_0x112c3e);};return function(_0x27e9c6){const _0x39055f=a19_0x178e;if(_0x27e9c6&&_0x27e9c6[_0x39055f(0x14e)])return _0x27e9c6;var _0x1791bc={};if(_0x27e9c6!=null){for(var _0xf5c6e2=_0x4be1df(_0x27e9c6),_0x364e31=0x0;_0x364e31<_0xf5c6e2['length'];_0x364e31++)if(_0xf5c6e2[_0x364e31]!==_0x39055f(0x151))__createBinding(_0x1791bc,_0x27e9c6,_0xf5c6e2[_0x364e31]);}return __setModuleDefault(_0x1791bc,_0x27e9c6),_0x1791bc;};}()),__importDefault=this&&this[a19_0xe21958(0x134)]||function(_0x4913cb){const _0x2c48b7=a19_0xe21958;return _0x4913cb&&_0x4913cb[_0x2c48b7(0x14e)]?_0x4913cb:{'default':_0x4913cb};};Object[a19_0xe21958(0x144)](exports,a19_0xe21958(0x14e),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a19_0xe21958(0x195)),webhookService_1=require(a19_0xe21958(0x180)),database_1=__importDefault(require(a19_0xe21958(0x12c)));class TestGatewayController{constructor(){const _0x677ae0=a19_0xe21958;this[_0x677ae0(0x143)]=async(_0x188cb6,_0x4c1ea0,_0x423d64)=>{const _0x2be78b=_0x677ae0;try{const {paymentId:_0x2f1ddb}=_0x188cb6[_0x2be78b(0x132)];console[_0x2be78b(0x18f)](_0x2be78b(0x174)+_0x2f1ddb);const _0x23c847=await database_1[_0x2be78b(0x151)][_0x2be78b(0x123)][_0x2be78b(0x16e)]({'where':{'id':_0x2f1ddb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x23c847)return _0x4c1ea0[_0x2be78b(0x159)](0x194)[_0x2be78b(0x17c)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x23c847[_0x2be78b(0x128)]!=='test_gateway')return _0x4c1ea0['status'](0x190)['json']({'success':![],'message':_0x2be78b(0x190)});if(_0x23c847[_0x2be78b(0x159)]!=='PENDING')return _0x4c1ea0[_0x2be78b(0x159)](0x190)[_0x2be78b(0x17c)]({'success':![],'message':_0x2be78b(0x15c)+_0x23c847['status']+_0x2be78b(0x18d)});_0x4c1ea0[_0x2be78b(0x17c)]({'success':!![],'result':{'paymentId':_0x23c847['id'],'orderId':_0x23c847['gatewayOrderId'],'amount':_0x23c847[_0x2be78b(0x165)],'currency':_0x23c847['currency'],'merchantName':_0x23c847[_0x2be78b(0x19a)][_0x2be78b(0x17f)],'description':_0x2be78b(0x156)+_0x23c847[_0x2be78b(0x19a)][_0x2be78b(0x17f)],'testInstructions':{'successCard':_0x2be78b(0x170),'failureCard':_0x2be78b(0x146),'expiryDate':_0x2be78b(0x127),'cvc':_0x2be78b(0x168),'holderName':'Any\x20name'}}});}catch(_0x2e705c){_0x423d64(_0x2e705c);}},this['processCard']=async(_0x33795e,_0x2860cc,_0x2a6dad)=>{const _0x4f1663=_0x677ae0;try{const {paymentId:_0x18d613}=_0x33795e[_0x4f1663(0x132)],_0x59add6=_0x33795e[_0x4f1663(0x196)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x18d613);const _0x1d641e=await database_1['default']['payment']['findUnique']({'where':{'id':_0x18d613},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1d641e)return _0x2860cc[_0x4f1663(0x159)](0x194)['json']({'success':![],'message':_0x4f1663(0x19b)});if(_0x1d641e[_0x4f1663(0x128)]!==_0x4f1663(0x167))return _0x2860cc[_0x4f1663(0x159)](0x190)[_0x4f1663(0x17c)]({'success':![],'message':_0x4f1663(0x190)});if(_0x1d641e[_0x4f1663(0x159)]!==_0x4f1663(0x150))return _0x2860cc[_0x4f1663(0x159)](0x190)[_0x4f1663(0x17c)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1d641e[_0x4f1663(0x159)]+_0x4f1663(0x18d)});const _0x3f9468=await this[_0x4f1663(0x163)][_0x4f1663(0x17b)]({'paymentId':_0x1d641e['id'],'orderId':_0x1d641e[_0x4f1663(0x17a)]||_0x1d641e['id'],'amount':_0x1d641e[_0x4f1663(0x165)],'currency':_0x1d641e['currency'],'cardData':_0x59add6});console[_0x4f1663(0x18f)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x3f9468);const _0x2b4d4e={'status':_0x3f9468['status'],'updatedAt':new Date()};if(_0x3f9468[_0x4f1663(0x159)]==='PAID')_0x2b4d4e['paidAt']=new Date(),_0x2b4d4e[_0x4f1663(0x16f)]=_0x3f9468['transactionId'];else _0x3f9468[_0x4f1663(0x159)]===_0x4f1663(0x169)&&(_0x2b4d4e['failureMessage']=_0x3f9468[_0x4f1663(0x178)]);const _0x1630a9=_0x59add6[_0x4f1663(0x19d)][_0x4f1663(0x13a)](/[\s-]/g,'');_0x2b4d4e[_0x4f1663(0x187)]=_0x1630a9[_0x4f1663(0x13e)](-0x4),_0x2b4d4e[_0x4f1663(0x155)]='test_card',await database_1[_0x4f1663(0x151)][_0x4f1663(0x123)][_0x4f1663(0x175)]({'where':{'id':_0x1d641e['id']},'data':_0x2b4d4e});if(_0x3f9468[_0x4f1663(0x159)]==='PAID'&&_0x1d641e['paymentLinkId']){console[_0x4f1663(0x18f)](_0x4f1663(0x15e)+_0x1d641e['id']+_0x4f1663(0x14b));try{await database_1[_0x4f1663(0x151)]['$transaction'](async _0x5ef8de=>{const _0x352673=_0x4f1663,_0x13b03c=await _0x5ef8de['paymentLink'][_0x352673(0x16e)]({'where':{'id':_0x1d641e[_0x352673(0x126)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x13b03c){console['log'](_0x352673(0x173)+_0x13b03c['id']+_0x352673(0x153)+_0x13b03c[_0x352673(0x149)]+_0x352673(0x179)+_0x13b03c[_0x352673(0x162)]+_0x352673(0x142)+_0x13b03c['status']);const _0x14098a=_0x13b03c[_0x352673(0x162)]+0x1,_0x76e62b=_0x13b03c[_0x352673(0x149)]==='SINGLE'?_0x352673(0x17d):_0x13b03c['status'];await _0x5ef8de[_0x352673(0x172)][_0x352673(0x175)]({'where':{'id':_0x1d641e['paymentLinkId']},'data':{'currentPayments':_0x14098a,'status':_0x76e62b,'updatedAt':new Date()}}),console['log']('âœ…\x20Payment\x20link\x20'+_0x13b03c['id']+'\x20updated:\x20currentPayments='+_0x13b03c[_0x352673(0x162)]+_0x352673(0x184)+_0x14098a+',\x20status='+_0x13b03c[_0x352673(0x159)]+'\x20->\x20'+_0x76e62b);}else console['log'](_0x352673(0x12a)+_0x1d641e[_0x352673(0x126)]+_0x352673(0x176));});}catch(_0x3b7403){console['error']('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x3b7403);}}await database_1[_0x4f1663(0x151)][_0x4f1663(0x191)][_0x4f1663(0x183)]({'data':{'paymentId':_0x1d641e['id'],'shopId':_0x1d641e[_0x4f1663(0x139)],'event':_0x4f1663(0x12b)+_0x3f9468[_0x4f1663(0x159)][_0x4f1663(0x18e)](),'statusCode':0xc8,'responseBody':JSON[_0x4f1663(0x182)]({'oldStatus':'PENDING','newStatus':_0x3f9468[_0x4f1663(0x159)],'transactionId':_0x3f9468[_0x4f1663(0x138)],'failureReason':_0x3f9468[_0x4f1663(0x178)],'processedAt':new Date()[_0x4f1663(0x16d)]()})}}),await this[_0x4f1663(0x14f)](_0x1d641e,_0x3f9468[_0x4f1663(0x159)],_0x3f9468[_0x4f1663(0x138)],_0x3f9468[_0x4f1663(0x178)]),await this['sendPaymentStatusNotification'](_0x1d641e,_0x3f9468[_0x4f1663(0x159)]),console[_0x4f1663(0x18f)](_0x4f1663(0x13b)+_0x18d613+_0x4f1663(0x15d)+_0x3f9468['status']),_0x3f9468[_0x4f1663(0x159)]===_0x4f1663(0x181)?_0x2860cc[_0x4f1663(0x17c)]({'success':!![],'message':_0x4f1663(0x135),'result':{'status':'PAID','transactionId':_0x3f9468[_0x4f1663(0x138)],'redirectUrl':_0x1d641e[_0x4f1663(0x147)]}}):_0x2860cc[_0x4f1663(0x159)](0x190)[_0x4f1663(0x17c)]({'success':![],'message':_0x4f1663(0x137),'result':{'status':_0x4f1663(0x169),'failureReason':_0x3f9468[_0x4f1663(0x178)],'redirectUrl':_0x1d641e[_0x4f1663(0x19c)]}});}catch(_0x4e03e1){_0x2a6dad(_0x4e03e1);}},this['testGatewayService']=new testGatewayService_1[(_0x677ae0(0x131))](),this[_0x677ae0(0x133)]=new webhookService_1[(_0x677ae0(0x188))]();}async[a19_0xe21958(0x14f)](_0x2c7a30,_0x84ee09,_0x506055,_0x2d2ee8){const _0x540dba=a19_0xe21958,_0x48bd39=Date[_0x540dba(0x160)]();try{const _0x243f70=_0x2c7a30[_0x540dba(0x19a)],_0x18ddcc=_0x243f70[_0x540dba(0x12d)];if(!_0x18ddcc?.[_0x540dba(0x186)]){console[_0x540dba(0x18f)](_0x540dba(0x12e)+_0x243f70['id']);return;}const _0x27ee18=_0x84ee09===_0x540dba(0x181)?'payment.success':_0x540dba(0x140);let _0x4c309=[];if(_0x18ddcc[_0x540dba(0x121)])try{_0x4c309=Array[_0x540dba(0x122)](_0x18ddcc['webhookEvents'])?_0x18ddcc[_0x540dba(0x121)]:JSON[_0x540dba(0x13d)](_0x18ddcc[_0x540dba(0x121)]);}catch(_0x47f9c8){console[_0x540dba(0x15b)](_0x540dba(0x192),_0x47f9c8),_0x4c309=[];}if(!_0x4c309[_0x540dba(0x125)](_0x27ee18)){console[_0x540dba(0x18f)](_0x540dba(0x152)+_0x27ee18+_0x540dba(0x177)+_0x243f70['id']);return;}const _0x400796={'event':_0x27ee18,'payment':{'id':_0x2c7a30['id'],'order_id':_0x2c7a30[_0x540dba(0x193)],'gateway_order_id':_0x2c7a30[_0x540dba(0x17a)],'gateway':_0x540dba(0x197),'amount':_0x2c7a30[_0x540dba(0x165)],'currency':_0x2c7a30[_0x540dba(0x18c)],'status':_0x84ee09[_0x540dba(0x18e)](),'customer_email':_0x2c7a30[_0x540dba(0x14d)],'customer_name':_0x2c7a30[_0x540dba(0x15a)],'transaction_id':_0x506055,'failure_message':_0x2d2ee8,'created_at':_0x2c7a30[_0x540dba(0x198)],'updated_at':new Date()}},_0xdda51f=await fetch(_0x18ddcc[_0x540dba(0x186)],{'method':_0x540dba(0x13c),'headers':{'Content-Type':'application/json','User-Agent':_0x540dba(0x189)},'body':JSON[_0x540dba(0x182)](_0x400796)}),_0x1dbcd9=Date[_0x540dba(0x160)]()-_0x48bd39;console[_0x540dba(0x18f)](_0x540dba(0x166)+_0x18ddcc['webhookUrl']+'\x20with\x20status\x20'+_0xdda51f['status']+'\x20('+_0x1dbcd9+_0x540dba(0x18a));}catch(_0x540956){console[_0x540dba(0x15b)](_0x540dba(0x16c),_0x540956);}}async['sendPaymentStatusNotification'](_0x4301d3,_0x17c5d2){const _0x2e58d7=a19_0xe21958;try{const {telegramBotService:_0x1bb252}=await Promise['resolve']()[_0x2e58d7(0x15f)](()=>__importStar(require(_0x2e58d7(0x171)))),_0x2e0011={'PAID':_0x2e58d7(0x148),'FAILED':_0x2e58d7(0x18b)},_0x42703d=_0x2e0011[_0x17c5d2];if(!_0x42703d)return;await _0x1bb252['sendPaymentNotification'](_0x4301d3[_0x2e58d7(0x139)],_0x4301d3,_0x42703d);}catch(_0x183a06){console[_0x2e58d7(0x15b)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x183a06);}}}function a19_0x178e(_0x261d94,_0x3170a3){_0x261d94=_0x261d94-0x121;const _0x4305e5=a19_0x4305();let _0x178ef7=_0x4305e5[_0x261d94];return _0x178ef7;}exports[a19_0xe21958(0x136)]=TestGatewayController;