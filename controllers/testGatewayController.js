'use strict';const a13_0x1b08b0=a13_0x4a58;(function(_0x1f5126,_0x57d12d){const _0x45ab41=a13_0x4a58,_0x1387f3=_0x1f5126();while(!![]){try{const _0x6d70dc=-parseInt(_0x45ab41(0x1ba))/0x1*(-parseInt(_0x45ab41(0x1af))/0x2)+parseInt(_0x45ab41(0x1c6))/0x3*(-parseInt(_0x45ab41(0x1c2))/0x4)+-parseInt(_0x45ab41(0x1c0))/0x5*(-parseInt(_0x45ab41(0x1d1))/0x6)+parseInt(_0x45ab41(0x1e9))/0x7*(parseInt(_0x45ab41(0x1f1))/0x8)+-parseInt(_0x45ab41(0x1b8))/0x9*(parseInt(_0x45ab41(0x1e7))/0xa)+parseInt(_0x45ab41(0x1a7))/0xb*(-parseInt(_0x45ab41(0x1b2))/0xc)+parseInt(_0x45ab41(0x1d7))/0xd;if(_0x6d70dc===_0x57d12d)break;else _0x1387f3['push'](_0x1387f3['shift']());}catch(_0x2a80e2){_0x1387f3['push'](_0x1387f3['shift']());}}}(a13_0xcd5a,0xd217b));var __createBinding=this&&this[a13_0x1b08b0(0x1a1)]||(Object['create']?function(_0x5171a9,_0x1ec994,_0x559cba,_0x53be5e){const _0x4ebcfb=a13_0x1b08b0;if(_0x53be5e===undefined)_0x53be5e=_0x559cba;var _0x2f1759=Object[_0x4ebcfb(0x1df)](_0x1ec994,_0x559cba);(!_0x2f1759||('get'in _0x2f1759?!_0x1ec994['__esModule']:_0x2f1759[_0x4ebcfb(0x196)]||_0x2f1759['configurable']))&&(_0x2f1759={'enumerable':!![],'get':function(){return _0x1ec994[_0x559cba];}}),Object[_0x4ebcfb(0x1ec)](_0x5171a9,_0x53be5e,_0x2f1759);}:function(_0x215ad4,_0x587206,_0x469a14,_0x2f2132){if(_0x2f2132===undefined)_0x2f2132=_0x469a14;_0x215ad4[_0x2f2132]=_0x587206[_0x469a14];}),__setModuleDefault=this&&this[a13_0x1b08b0(0x1a6)]||(Object['create']?function(_0x2b96b2,_0x1fd391){const _0x18c385=a13_0x1b08b0;Object[_0x18c385(0x1ec)](_0x2b96b2,_0x18c385(0x1e0),{'enumerable':!![],'value':_0x1fd391});}:function(_0x404fd3,_0x41658b){const _0x3701e3=a13_0x1b08b0;_0x404fd3[_0x3701e3(0x1e0)]=_0x41658b;}),__importStar=this&&this[a13_0x1b08b0(0x190)]||(function(){var _0x5edd72=function(_0x253e06){return _0x5edd72=Object['getOwnPropertyNames']||function(_0x18deb4){const _0x5e5c35=a13_0x4a58;var _0x41417c=[];for(var _0x425945 in _0x18deb4)if(Object[_0x5e5c35(0x1cd)]['hasOwnProperty']['call'](_0x18deb4,_0x425945))_0x41417c[_0x41417c[_0x5e5c35(0x19e)]]=_0x425945;return _0x41417c;},_0x5edd72(_0x253e06);};return function(_0x4db54d){const _0xdded1e=a13_0x4a58;if(_0x4db54d&&_0x4db54d[_0xdded1e(0x1ed)])return _0x4db54d;var _0x34e0c5={};if(_0x4db54d!=null){for(var _0x55c984=_0x5edd72(_0x4db54d),_0x2aaf1b=0x0;_0x2aaf1b<_0x55c984[_0xdded1e(0x19e)];_0x2aaf1b++)if(_0x55c984[_0x2aaf1b]!==_0xdded1e(0x1e0))__createBinding(_0x34e0c5,_0x4db54d,_0x55c984[_0x2aaf1b]);}return __setModuleDefault(_0x34e0c5,_0x4db54d),_0x34e0c5;};}()),__importDefault=this&&this['__importDefault']||function(_0xec12b3){const _0x42ff33=a13_0x1b08b0;return _0xec12b3&&_0xec12b3[_0x42ff33(0x1ed)]?_0xec12b3:{'default':_0xec12b3};};Object[a13_0x1b08b0(0x1ec)](exports,a13_0x1b08b0(0x1ed),{'value':!![]}),exports[a13_0x1b08b0(0x1da)]=void 0x0;const testGatewayService_1=require(a13_0x1b08b0(0x1c5)),webhookService_1=require(a13_0x1b08b0(0x1d9)),database_1=__importDefault(require(a13_0x1b08b0(0x1d6)));class TestGatewayController{constructor(){const _0x28d733=a13_0x1b08b0;this[_0x28d733(0x1ee)]=async(_0x37e483,_0x239ff8,_0x4653f3)=>{const _0x59017b=_0x28d733;try{const {paymentId:_0x185fb8}=_0x37e483[_0x59017b(0x19c)];console[_0x59017b(0x1a0)](_0x59017b(0x1fc)+_0x185fb8);const _0x3610ff=await database_1[_0x59017b(0x1e0)]['payment'][_0x59017b(0x1e2)]({'where':{'id':_0x185fb8},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3610ff)return _0x239ff8[_0x59017b(0x1db)](0x194)[_0x59017b(0x1b6)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3610ff[_0x59017b(0x1fa)]!==_0x59017b(0x19b))return _0x239ff8[_0x59017b(0x1db)](0x190)['json']({'success':![],'message':_0x59017b(0x1e3)});if(_0x3610ff[_0x59017b(0x1db)]!=='PENDING')return _0x239ff8[_0x59017b(0x1db)](0x190)[_0x59017b(0x1b6)]({'success':![],'message':_0x59017b(0x1c4)+_0x3610ff[_0x59017b(0x1db)]+_0x59017b(0x1b9)});_0x239ff8[_0x59017b(0x1b6)]({'success':!![],'result':{'paymentId':_0x3610ff['id'],'orderId':_0x3610ff[_0x59017b(0x1a5)],'amount':_0x3610ff[_0x59017b(0x1d2)],'currency':_0x3610ff[_0x59017b(0x197)],'merchantName':_0x3610ff[_0x59017b(0x1f5)]['name'],'description':_0x59017b(0x19a)+_0x3610ff['shop'][_0x59017b(0x1a2)],'testInstructions':{'successCard':_0x59017b(0x1d5),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x59017b(0x1cc)}}});}catch(_0x39103d){_0x4653f3(_0x39103d);}},this[_0x28d733(0x1c3)]=async(_0x1a504e,_0x2e561d,_0x5f50e8)=>{const _0x1fe0e1=_0x28d733;try{const {paymentId:_0x15611f}=_0x1a504e['params'],_0x109038=_0x1a504e['body'];console[_0x1fe0e1(0x1a0)](_0x1fe0e1(0x1ac)+_0x15611f);const _0x5d8cf3=await database_1[_0x1fe0e1(0x1e0)][_0x1fe0e1(0x1e4)][_0x1fe0e1(0x1e2)]({'where':{'id':_0x15611f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d8cf3)return _0x2e561d[_0x1fe0e1(0x1db)](0x194)[_0x1fe0e1(0x1b6)]({'success':![],'message':_0x1fe0e1(0x1dd)});if(_0x5d8cf3[_0x1fe0e1(0x1fa)]!==_0x1fe0e1(0x19b))return _0x2e561d['status'](0x190)['json']({'success':![],'message':_0x1fe0e1(0x1e3)});if(_0x5d8cf3[_0x1fe0e1(0x1db)]!=='PENDING')return _0x2e561d[_0x1fe0e1(0x1db)](0x190)[_0x1fe0e1(0x1b6)]({'success':![],'message':_0x1fe0e1(0x1c4)+_0x5d8cf3[_0x1fe0e1(0x1db)]+_0x1fe0e1(0x1b9)});const _0x5e19be=await this[_0x1fe0e1(0x1c7)][_0x1fe0e1(0x1eb)]({'paymentId':_0x5d8cf3['id'],'orderId':_0x5d8cf3[_0x1fe0e1(0x1a5)]||_0x5d8cf3['id'],'amount':_0x5d8cf3[_0x1fe0e1(0x1d2)],'currency':_0x5d8cf3[_0x1fe0e1(0x197)],'cardData':_0x109038});console[_0x1fe0e1(0x1a0)](_0x1fe0e1(0x1be),_0x5e19be);const _0x3ebfed={'status':_0x5e19be[_0x1fe0e1(0x1db)],'updatedAt':new Date()};if(_0x5e19be[_0x1fe0e1(0x1db)]===_0x1fe0e1(0x1e8))_0x3ebfed['paidAt']=new Date(),_0x3ebfed['gatewayPaymentId']=_0x5e19be[_0x1fe0e1(0x1b7)];else _0x5e19be[_0x1fe0e1(0x1db)]==='FAILED'&&(_0x3ebfed[_0x1fe0e1(0x1b3)]=_0x5e19be[_0x1fe0e1(0x1d3)]);const _0xe7a788=_0x109038['cardNumber'][_0x1fe0e1(0x1dc)](/[\s-]/g,'');_0x3ebfed[_0x1fe0e1(0x1fd)]=_0xe7a788[_0x1fe0e1(0x1ab)](-0x4),_0x3ebfed[_0x1fe0e1(0x193)]=_0x1fe0e1(0x198),await database_1[_0x1fe0e1(0x1e0)][_0x1fe0e1(0x1e4)][_0x1fe0e1(0x1f3)]({'where':{'id':_0x5d8cf3['id']},'data':_0x3ebfed}),await database_1[_0x1fe0e1(0x1e0)][_0x1fe0e1(0x1d8)][_0x1fe0e1(0x1c8)]({'data':{'paymentId':_0x5d8cf3['id'],'shopId':_0x5d8cf3[_0x1fe0e1(0x1d4)],'event':_0x1fe0e1(0x1e5)+_0x5e19be[_0x1fe0e1(0x1db)][_0x1fe0e1(0x1ad)](),'statusCode':0xc8,'responseBody':JSON[_0x1fe0e1(0x192)]({'oldStatus':'PENDING','newStatus':_0x5e19be[_0x1fe0e1(0x1db)],'transactionId':_0x5e19be[_0x1fe0e1(0x1b7)],'failureReason':_0x5e19be[_0x1fe0e1(0x1d3)],'processedAt':new Date()[_0x1fe0e1(0x1fb)]()})}}),await this[_0x1fe0e1(0x1f6)](_0x5d8cf3,_0x5e19be[_0x1fe0e1(0x1db)],_0x5e19be[_0x1fe0e1(0x1b7)],_0x5e19be['failureReason']),await this['sendPaymentStatusNotification'](_0x5d8cf3,_0x5e19be['status']),console[_0x1fe0e1(0x1a0)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x15611f+_0x1fe0e1(0x1e1)+_0x5e19be[_0x1fe0e1(0x1db)]),_0x5e19be[_0x1fe0e1(0x1db)]===_0x1fe0e1(0x1e8)?_0x2e561d[_0x1fe0e1(0x1b6)]({'success':!![],'message':_0x1fe0e1(0x1f2),'result':{'status':_0x1fe0e1(0x1e8),'transactionId':_0x5e19be[_0x1fe0e1(0x1b7)],'redirectUrl':_0x5d8cf3[_0x1fe0e1(0x1a9)]}}):_0x2e561d['status'](0x190)[_0x1fe0e1(0x1b6)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x5e19be[_0x1fe0e1(0x1d3)],'redirectUrl':_0x5d8cf3[_0x1fe0e1(0x1c9)]}});}catch(_0x49bb14){_0x5f50e8(_0x49bb14);}},this[_0x28d733(0x1c7)]=new testGatewayService_1[(_0x28d733(0x1cb))](),this[_0x28d733(0x1f0)]=new webhookService_1[(_0x28d733(0x1e6))]();}async[a13_0x1b08b0(0x1f6)](_0x14737f,_0x1a9c04,_0x39e2b5,_0x49714b){const _0x30433a=a13_0x1b08b0,_0x227bdb=Date[_0x30433a(0x1a3)]();try{const _0x492f19=_0x14737f[_0x30433a(0x1f5)],_0x5f2632=_0x492f19[_0x30433a(0x1f7)];if(!_0x5f2632?.[_0x30433a(0x1bd)]){console[_0x30433a(0x1a0)](_0x30433a(0x1a8)+_0x492f19['id']);return;}const _0x29c594=_0x1a9c04===_0x30433a(0x1e8)?_0x30433a(0x1ea):_0x30433a(0x1f4);let _0x5e4fb6=[];if(_0x5f2632[_0x30433a(0x1ca)])try{_0x5e4fb6=Array[_0x30433a(0x1b1)](_0x5f2632[_0x30433a(0x1ca)])?_0x5f2632['webhookEvents']:JSON[_0x30433a(0x1f9)](_0x5f2632['webhookEvents']);}catch(_0x2a8b4f){console['error']('Error\x20parsing\x20webhook\x20events:',_0x2a8b4f),_0x5e4fb6=[];}if(!_0x5e4fb6[_0x30433a(0x1f8)](_0x29c594)){console[_0x30433a(0x1a0)](_0x30433a(0x1d0)+_0x29c594+_0x30433a(0x1bf)+_0x492f19['id']);return;}const _0x2e0a7b={'event':_0x29c594,'payment':{'id':_0x14737f['id'],'order_id':_0x14737f[_0x30433a(0x1ae)],'gateway_order_id':_0x14737f[_0x30433a(0x1a5)],'gateway':_0x30433a(0x1bc),'amount':_0x14737f[_0x30433a(0x1d2)],'currency':_0x14737f['currency'],'status':_0x1a9c04['toLowerCase'](),'customer_email':_0x14737f[_0x30433a(0x1cf)],'customer_name':_0x14737f[_0x30433a(0x1ce)],'transaction_id':_0x39e2b5,'failure_message':_0x49714b,'created_at':_0x14737f[_0x30433a(0x1bb)],'updated_at':new Date()}},_0x329053=await fetch(_0x5f2632[_0x30433a(0x1bd)],{'method':_0x30433a(0x1c1),'headers':{'Content-Type':_0x30433a(0x199),'User-Agent':_0x30433a(0x1ef)},'body':JSON[_0x30433a(0x192)](_0x2e0a7b)}),_0x188196=Date[_0x30433a(0x1a3)]()-_0x227bdb;console['log'](_0x30433a(0x194)+_0x5f2632[_0x30433a(0x1bd)]+_0x30433a(0x1b4)+_0x329053[_0x30433a(0x1db)]+'\x20('+_0x188196+_0x30433a(0x191));}catch(_0x3bd599){console[_0x30433a(0x195)](_0x30433a(0x19f),_0x3bd599);}}async[a13_0x1b08b0(0x19d)](_0x51a558,_0x9ca1bf){const _0x556e62=a13_0x1b08b0;try{const {telegramBotService:_0xed47a9}=await Promise['resolve']()['then'](()=>__importStar(require(_0x556e62(0x1de)))),_0x17794b={'PAID':_0x556e62(0x1b0),'FAILED':_0x556e62(0x1b5)},_0x5e35ee=_0x17794b[_0x9ca1bf];if(!_0x5e35ee)return;await _0xed47a9[_0x556e62(0x1aa)](_0x51a558[_0x556e62(0x1d4)],_0x51a558,_0x5e35ee);}catch(_0x137430){console[_0x556e62(0x195)](_0x556e62(0x1a4),_0x137430);}}}exports[a13_0x1b08b0(0x1da)]=TestGatewayController;function a13_0x4a58(_0x4cef12,_0x33c0d6){const _0xcd5ab7=a13_0xcd5a();return a13_0x4a58=function(_0x4a58c6,_0x4275d9){_0x4a58c6=_0x4a58c6-0x190;let _0x4aa6f4=_0xcd5ab7[_0x4a58c6];return _0x4aa6f4;},a13_0x4a58(_0x4cef12,_0x33c0d6);}function a13_0xcd5a(){const _0x18f58d=['shop','sendShopWebhook','settings','includes','parse','gateway','toISOString','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','cardLast4','__importStar','ms)','stringify','paymentMethod','Test\x20Gateway\x20webhook\x20sent\x20to\x20','error','writable','currency','test_card','application/json','Payment\x20to\x20','test_gateway','params','sendPaymentStatusNotification','length','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','log','__createBinding','name','now','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayOrderId','__setModuleDefault','77aDrvdd','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','successUrl','sendPaymentNotification','slice','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','toLowerCase','orderId','2GQsLMZ','paid','isArray','1229052nUtngV','failureMessage','\x20with\x20status\x20','failed','json','transactionId','6018237IZdKAg',',\x20cannot\x20process','209771DQBDek','createdAt','0000','webhookUrl','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20not\x20enabled\x20for\x20shop\x20','15PazOAZ','POST','1928qilouP','processCard','Payment\x20status\x20is\x20','../services/gateways/testGatewayService','8787Zuqpce','testGatewayService','create','failUrl','webhookEvents','TestGatewayService','Any\x20name','prototype','customerName','customerEmail','Webhook\x20event\x20','1664220glUqJs','amount','failureReason','shopId','4242\x204242\x204242\x204242','../config/database','21121022JASfHU','webhookLog','../services/webhookService','TestGatewayController','status','replace','Payment\x20not\x20found','../services/telegramBotService','getOwnPropertyDescriptor','default','\x20processed:\x20','findUnique','Payment\x20is\x20not\x20for\x20test\x20gateway','payment','test_gateway_','WebhookService','10IxrrmQ','PAID','3469837icOsVE','payment.success','processCardPayment','defineProperty','__esModule','getPaymentForm','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','webhookService','16fyhyPx','Payment\x20processed\x20successfully','update','payment.failed'];a13_0xcd5a=function(){return _0x18f58d;};return a13_0xcd5a();}