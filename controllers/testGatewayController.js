'use strict';const a13_0x165c94=a13_0x469e;(function(_0x4392ca,_0x529df5){const _0x3de6e1=a13_0x469e,_0x214035=_0x4392ca();while(!![]){try{const _0x35203f=parseInt(_0x3de6e1(0x194))/0x1+parseInt(_0x3de6e1(0x1c9))/0x2*(parseInt(_0x3de6e1(0x18b))/0x3)+-parseInt(_0x3de6e1(0x188))/0x4+-parseInt(_0x3de6e1(0x173))/0x5+parseInt(_0x3de6e1(0x186))/0x6*(parseInt(_0x3de6e1(0x1a3))/0x7)+-parseInt(_0x3de6e1(0x1ba))/0x8*(parseInt(_0x3de6e1(0x198))/0x9)+parseInt(_0x3de6e1(0x1ac))/0xa;if(_0x35203f===_0x529df5)break;else _0x214035['push'](_0x214035['shift']());}catch(_0x3f8a3a){_0x214035['push'](_0x214035['shift']());}}}(a13_0x5b72,0x3498c));function a13_0x469e(_0x1cf987,_0x1e6a6b){const _0x5b72ee=a13_0x5b72();return a13_0x469e=function(_0x469e8d,_0x11bd42){_0x469e8d=_0x469e8d-0x170;let _0x4f88cc=_0x5b72ee[_0x469e8d];return _0x4f88cc;},a13_0x469e(_0x1cf987,_0x1e6a6b);}var __createBinding=this&&this[a13_0x165c94(0x1a6)]||(Object[a13_0x165c94(0x1b6)]?function(_0x2877e2,_0x318a77,_0x4f1f62,_0x118e38){const _0x2d1990=a13_0x165c94;if(_0x118e38===undefined)_0x118e38=_0x4f1f62;var _0x1c44eb=Object['getOwnPropertyDescriptor'](_0x318a77,_0x4f1f62);(!_0x1c44eb||('get'in _0x1c44eb?!_0x318a77['__esModule']:_0x1c44eb[_0x2d1990(0x1a7)]||_0x1c44eb[_0x2d1990(0x1c0)]))&&(_0x1c44eb={'enumerable':!![],'get':function(){return _0x318a77[_0x4f1f62];}}),Object['defineProperty'](_0x2877e2,_0x118e38,_0x1c44eb);}:function(_0x3ad745,_0x16daf8,_0x28fdaa,_0x3055fb){if(_0x3055fb===undefined)_0x3055fb=_0x28fdaa;_0x3ad745[_0x3055fb]=_0x16daf8[_0x28fdaa];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x165c94(0x1b6)]?function(_0x428bbe,_0x3351be){const _0x2348d3=a13_0x165c94;Object[_0x2348d3(0x18f)](_0x428bbe,_0x2348d3(0x1af),{'enumerable':!![],'value':_0x3351be});}:function(_0x431bf5,_0x31a3ec){const _0x4008db=a13_0x165c94;_0x431bf5[_0x4008db(0x1af)]=_0x31a3ec;}),__importStar=this&&this['__importStar']||(function(){var _0x5c7d76=function(_0x2ec3e0){return _0x5c7d76=Object['getOwnPropertyNames']||function(_0x253d99){const _0x1d3feb=a13_0x469e;var _0x403fd6=[];for(var _0xd2dfb6 in _0x253d99)if(Object[_0x1d3feb(0x185)]['hasOwnProperty'][_0x1d3feb(0x1bf)](_0x253d99,_0xd2dfb6))_0x403fd6[_0x403fd6[_0x1d3feb(0x19e)]]=_0xd2dfb6;return _0x403fd6;},_0x5c7d76(_0x2ec3e0);};return function(_0x351ba0){const _0x2b5c54=a13_0x469e;if(_0x351ba0&&_0x351ba0[_0x2b5c54(0x1c8)])return _0x351ba0;var _0x775bce={};if(_0x351ba0!=null){for(var _0x27dcdc=_0x5c7d76(_0x351ba0),_0x1a0b6f=0x0;_0x1a0b6f<_0x27dcdc[_0x2b5c54(0x19e)];_0x1a0b6f++)if(_0x27dcdc[_0x1a0b6f]!=='default')__createBinding(_0x775bce,_0x351ba0,_0x27dcdc[_0x1a0b6f]);}return __setModuleDefault(_0x775bce,_0x351ba0),_0x775bce;};}()),__importDefault=this&&this['__importDefault']||function(_0x3d73c8){const _0x217496=a13_0x165c94;return _0x3d73c8&&_0x3d73c8[_0x217496(0x1c8)]?_0x3d73c8:{'default':_0x3d73c8};};Object[a13_0x165c94(0x18f)](exports,a13_0x165c94(0x1c8),{'value':!![]}),exports[a13_0x165c94(0x1bc)]=void 0x0;const testGatewayService_1=require(a13_0x165c94(0x1b3)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x165c94(0x1a4)));class TestGatewayController{constructor(){const _0x1691df=a13_0x165c94;this[_0x1691df(0x1c5)]=async(_0x29ed19,_0x1c99d0,_0x3f66e7)=>{const _0x3798e4=_0x1691df;try{const {paymentId:_0x94b7b}=_0x29ed19[_0x3798e4(0x1d3)];console[_0x3798e4(0x1bb)](_0x3798e4(0x1b7)+_0x94b7b);const _0x3370aa=await database_1[_0x3798e4(0x1af)]['payment']['findUnique']({'where':{'id':_0x94b7b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3370aa)return _0x1c99d0['status'](0x194)[_0x3798e4(0x193)]({'success':![],'message':_0x3798e4(0x187)});if(_0x3370aa[_0x3798e4(0x1ce)]!==_0x3798e4(0x179))return _0x1c99d0[_0x3798e4(0x174)](0x190)['json']({'success':![],'message':_0x3798e4(0x172)});if(_0x3370aa[_0x3798e4(0x174)]!=='PENDING')return _0x1c99d0[_0x3798e4(0x174)](0x190)[_0x3798e4(0x193)]({'success':![],'message':_0x3798e4(0x199)+_0x3370aa[_0x3798e4(0x174)]+_0x3798e4(0x1c3)});_0x1c99d0['json']({'success':!![],'result':{'paymentId':_0x3370aa['id'],'orderId':_0x3370aa[_0x3798e4(0x17c)],'amount':_0x3370aa['amount'],'currency':_0x3370aa['currency'],'merchantName':_0x3370aa[_0x3798e4(0x192)][_0x3798e4(0x17f)],'description':_0x3798e4(0x1d1)+_0x3370aa['shop'][_0x3798e4(0x17f)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x3798e4(0x19d),'expiryDate':_0x3798e4(0x191),'cvc':_0x3798e4(0x19f),'holderName':_0x3798e4(0x1b8)}}});}catch(_0x4d4513){_0x3f66e7(_0x4d4513);}},this[_0x1691df(0x1aa)]=async(_0x1c6376,_0x31bf48,_0x42ce67)=>{const _0x2f46a1=_0x1691df;try{const {paymentId:_0x2c6a7e}=_0x1c6376['params'],_0x29e14a=_0x1c6376['body'];console['log'](_0x2f46a1(0x1ad)+_0x2c6a7e);const _0x5716d1=await database_1['default']['payment'][_0x2f46a1(0x1a1)]({'where':{'id':_0x2c6a7e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5716d1)return _0x31bf48[_0x2f46a1(0x174)](0x194)[_0x2f46a1(0x193)]({'success':![],'message':_0x2f46a1(0x187)});if(_0x5716d1['gateway']!=='test_gateway')return _0x31bf48[_0x2f46a1(0x174)](0x190)[_0x2f46a1(0x193)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5716d1['status']!==_0x2f46a1(0x175))return _0x31bf48[_0x2f46a1(0x174)](0x190)[_0x2f46a1(0x193)]({'success':![],'message':_0x2f46a1(0x199)+_0x5716d1['status']+_0x2f46a1(0x1c3)});const _0x38f5a7=await this[_0x2f46a1(0x1cb)]['processCardPayment']({'paymentId':_0x5716d1['id'],'orderId':_0x5716d1[_0x2f46a1(0x17c)]||_0x5716d1['id'],'amount':_0x5716d1[_0x2f46a1(0x17a)],'currency':_0x5716d1['currency'],'cardData':_0x29e14a});console[_0x2f46a1(0x1bb)](_0x2f46a1(0x1b0),_0x38f5a7);const _0x1081c9={'status':_0x38f5a7[_0x2f46a1(0x174)],'updatedAt':new Date()};if(_0x38f5a7[_0x2f46a1(0x174)]==='PAID')_0x1081c9[_0x2f46a1(0x1ca)]=new Date(),_0x1081c9[_0x2f46a1(0x178)]=_0x38f5a7['transactionId'];else _0x38f5a7[_0x2f46a1(0x174)]===_0x2f46a1(0x1b1)&&(_0x1081c9[_0x2f46a1(0x19b)]=_0x38f5a7[_0x2f46a1(0x19a)]);const _0x278d8e=_0x29e14a[_0x2f46a1(0x196)][_0x2f46a1(0x1ae)](/[\s-]/g,'');_0x1081c9[_0x2f46a1(0x180)]=_0x278d8e[_0x2f46a1(0x18c)](-0x4),_0x1081c9['paymentMethod']=_0x2f46a1(0x182),await database_1['default'][_0x2f46a1(0x1bd)][_0x2f46a1(0x1a5)]({'where':{'id':_0x5716d1['id']},'data':_0x1081c9}),await database_1[_0x2f46a1(0x1af)][_0x2f46a1(0x18d)][_0x2f46a1(0x1b6)]({'data':{'paymentId':_0x5716d1['id'],'shopId':_0x5716d1['shopId'],'event':'test_gateway_'+_0x38f5a7['status'][_0x2f46a1(0x17d)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2f46a1(0x175),'newStatus':_0x38f5a7['status'],'transactionId':_0x38f5a7[_0x2f46a1(0x195)],'failureReason':_0x38f5a7[_0x2f46a1(0x19a)],'processedAt':new Date()[_0x2f46a1(0x1d0)]()})}}),await this[_0x2f46a1(0x171)](_0x5716d1,_0x38f5a7[_0x2f46a1(0x174)],_0x38f5a7[_0x2f46a1(0x195)],_0x38f5a7[_0x2f46a1(0x19a)]),await this[_0x2f46a1(0x1b5)](_0x5716d1,_0x38f5a7[_0x2f46a1(0x174)]),console[_0x2f46a1(0x1bb)](_0x2f46a1(0x17e)+_0x2c6a7e+_0x2f46a1(0x177)+_0x38f5a7[_0x2f46a1(0x174)]),_0x38f5a7['status']===_0x2f46a1(0x184)?_0x31bf48[_0x2f46a1(0x193)]({'success':!![],'message':_0x2f46a1(0x189),'result':{'status':_0x2f46a1(0x184),'transactionId':_0x38f5a7['transactionId'],'redirectUrl':_0x5716d1['successUrl']}}):_0x31bf48['status'](0x190)['json']({'success':![],'message':_0x2f46a1(0x1ab),'result':{'status':_0x2f46a1(0x1b1),'failureReason':_0x38f5a7[_0x2f46a1(0x19a)],'redirectUrl':_0x5716d1['failUrl']}});}catch(_0x3da00d){_0x42ce67(_0x3da00d);}},this[_0x1691df(0x1cb)]=new testGatewayService_1[(_0x1691df(0x1a2))](),this[_0x1691df(0x17b)]=new webhookService_1[(_0x1691df(0x1be))]();}async[a13_0x165c94(0x171)](_0x1e59b5,_0x29ad1d,_0xa128b8,_0x2f71d9){const _0x257669=a13_0x165c94,_0x378ad9=Date[_0x257669(0x1d2)]();try{const _0x1785c1=_0x1e59b5[_0x257669(0x192)],_0x1a60ce=_0x1785c1['settings'];if(!_0x1a60ce?.[_0x257669(0x18e)]){console[_0x257669(0x1bb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1785c1['id']);return;}const _0xdcc357=_0x29ad1d==='PAID'?_0x257669(0x1cc):_0x257669(0x176);let _0xd51c3e=[];if(_0x1a60ce[_0x257669(0x1c7)])try{_0xd51c3e=Array[_0x257669(0x197)](_0x1a60ce[_0x257669(0x1c7)])?_0x1a60ce[_0x257669(0x1c7)]:JSON[_0x257669(0x1a9)](_0x1a60ce[_0x257669(0x1c7)]);}catch(_0xc0e562){console[_0x257669(0x1cf)](_0x257669(0x1c2),_0xc0e562),_0xd51c3e=[];}if(!_0xd51c3e[_0x257669(0x1c1)](_0xdcc357)){console[_0x257669(0x1bb)](_0x257669(0x18a)+_0xdcc357+_0x257669(0x170)+_0x1785c1['id']);return;}const _0x4e531={'event':_0xdcc357,'payment':{'id':_0x1e59b5['id'],'order_id':_0x1e59b5[_0x257669(0x1a8)],'gateway_order_id':_0x1e59b5[_0x257669(0x17c)],'gateway':_0x257669(0x183),'amount':_0x1e59b5['amount'],'currency':_0x1e59b5['currency'],'status':_0x29ad1d['toLowerCase'](),'customer_email':_0x1e59b5['customerEmail'],'customer_name':_0x1e59b5[_0x257669(0x1a0)],'transaction_id':_0xa128b8,'failure_message':_0x2f71d9,'created_at':_0x1e59b5[_0x257669(0x190)],'updated_at':new Date()}},_0x26d3db=await fetch(_0x1a60ce[_0x257669(0x18e)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x257669(0x1c6)},'body':JSON[_0x257669(0x181)](_0x4e531)}),_0x13c624=Date[_0x257669(0x1d2)]()-_0x378ad9;console[_0x257669(0x1bb)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x1a60ce[_0x257669(0x18e)]+_0x257669(0x1d4)+_0x26d3db['status']+'\x20('+_0x13c624+_0x257669(0x1c4));}catch(_0x2ca003){console[_0x257669(0x1cf)](_0x257669(0x19c),_0x2ca003);}}async[a13_0x165c94(0x1b5)](_0x5b5022,_0x58f434){const _0x5b9a15=a13_0x165c94;try{const {telegramBotService:_0x4716df}=await Promise[_0x5b9a15(0x1b2)]()[_0x5b9a15(0x1cd)](()=>__importStar(require('../services/telegramBotService'))),_0x23fbe2={'PAID':'paid','FAILED':'failed'},_0x16b4e=_0x23fbe2[_0x58f434];if(!_0x16b4e)return;await _0x4716df['sendPaymentNotification'](_0x5b5022[_0x5b9a15(0x1b9)],_0x5b5022,_0x16b4e);}catch(_0x9a35df){console[_0x5b9a15(0x1cf)](_0x5b9a15(0x1b4),_0x9a35df);}}}exports['TestGatewayController']=TestGatewayController;function a13_0x5b72(){const _0x14e97f=['Payment\x20to\x20','now','params','\x20with\x20status\x20','\x20not\x20enabled\x20for\x20shop\x20','sendShopWebhook','Payment\x20is\x20not\x20for\x20test\x20gateway','777910CUIXsY','status','PENDING','payment.failed','\x20processed:\x20','gatewayPaymentId','test_gateway','amount','webhookService','gatewayOrderId','toLowerCase','✅\x20Test\x20Gateway\x20payment\x20','name','cardLast4','stringify','test_card','0000','PAID','prototype','1788438ZCtCup','Payment\x20not\x20found','702704mpIFum','Payment\x20processed\x20successfully','Webhook\x20event\x20','298974qErUJE','slice','webhookLog','webhookUrl','defineProperty','createdAt','Any\x20future\x20date\x20(MM/YY)','shop','json','319886CNUxIj','transactionId','cardNumber','isArray','9WqCOjM','Payment\x20status\x20is\x20','failureReason','failureMessage','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Any\x20other\x20card\x20number','length','Any\x203-4\x20digits','customerName','findUnique','TestGatewayService','7cbHkvw','../config/database','update','__createBinding','writable','orderId','parse','processCard','Payment\x20failed','2573120wDrAhu','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','replace','default','🧪\x20Test\x20Gateway\x20result:','FAILED','resolve','../services/gateways/testGatewayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentStatusNotification','create','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Any\x20name','shopId','3425880AyozjW','log','TestGatewayController','payment','WebhookService','call','configurable','includes','Error\x20parsing\x20webhook\x20events:',',\x20cannot\x20process','ms)','getPaymentForm','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','webhookEvents','__esModule','2RGFFny','paidAt','testGatewayService','payment.success','then','gateway','error','toISOString'];a13_0x5b72=function(){return _0x14e97f;};return a13_0x5b72();}