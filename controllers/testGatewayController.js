'use strict';const a13_0x303eef=a13_0x4d20;(function(_0xea63b5,_0x23b288){const _0x44fb43=a13_0x4d20,_0x32bbf9=_0xea63b5();while(!![]){try{const _0x1ae089=parseInt(_0x44fb43(0x135))/0x1*(parseInt(_0x44fb43(0x174))/0x2)+-parseInt(_0x44fb43(0x17f))/0x3+parseInt(_0x44fb43(0x133))/0x4+-parseInt(_0x44fb43(0x15e))/0x5*(-parseInt(_0x44fb43(0x129))/0x6)+parseInt(_0x44fb43(0x167))/0x7+-parseInt(_0x44fb43(0x118))/0x8+parseInt(_0x44fb43(0x11f))/0x9*(-parseInt(_0x44fb43(0x15f))/0xa);if(_0x1ae089===_0x23b288)break;else _0x32bbf9['push'](_0x32bbf9['shift']());}catch(_0x21032d){_0x32bbf9['push'](_0x32bbf9['shift']());}}}(a13_0x5139,0x58a33));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x74dd,_0x3c2775,_0x19efaf,_0x1023f6){const _0x586db9=a13_0x4d20;if(_0x1023f6===undefined)_0x1023f6=_0x19efaf;var _0x55f68f=Object[_0x586db9(0x143)](_0x3c2775,_0x19efaf);(!_0x55f68f||(_0x586db9(0x138)in _0x55f68f?!_0x3c2775[_0x586db9(0x131)]:_0x55f68f['writable']||_0x55f68f[_0x586db9(0x137)]))&&(_0x55f68f={'enumerable':!![],'get':function(){return _0x3c2775[_0x19efaf];}}),Object[_0x586db9(0x11d)](_0x74dd,_0x1023f6,_0x55f68f);}:function(_0x3d4483,_0x176211,_0x5d70f7,_0x1b5903){if(_0x1b5903===undefined)_0x1b5903=_0x5d70f7;_0x3d4483[_0x1b5903]=_0x176211[_0x5d70f7];}),__setModuleDefault=this&&this[a13_0x303eef(0x176)]||(Object[a13_0x303eef(0x130)]?function(_0x5de6cd,_0x5196f8){const _0x3fa38f=a13_0x303eef;Object[_0x3fa38f(0x11d)](_0x5de6cd,_0x3fa38f(0x14e),{'enumerable':!![],'value':_0x5196f8});}:function(_0x2141fd,_0x3eceab){_0x2141fd['default']=_0x3eceab;}),__importStar=this&&this[a13_0x303eef(0x12d)]||(function(){var _0x11aaeb=function(_0x32642c){const _0x5d495c=a13_0x4d20;return _0x11aaeb=Object[_0x5d495c(0x170)]||function(_0x58e55b){const _0x19c7dc=_0x5d495c;var _0x29de31=[];for(var _0x1638d2 in _0x58e55b)if(Object[_0x19c7dc(0x125)][_0x19c7dc(0x12a)][_0x19c7dc(0x13c)](_0x58e55b,_0x1638d2))_0x29de31[_0x29de31['length']]=_0x1638d2;return _0x29de31;},_0x11aaeb(_0x32642c);};return function(_0x5ad095){const _0x278410=a13_0x4d20;if(_0x5ad095&&_0x5ad095[_0x278410(0x131)])return _0x5ad095;var _0x114275={};if(_0x5ad095!=null){for(var _0x7fec48=_0x11aaeb(_0x5ad095),_0x310688=0x0;_0x310688<_0x7fec48[_0x278410(0x146)];_0x310688++)if(_0x7fec48[_0x310688]!==_0x278410(0x14e))__createBinding(_0x114275,_0x5ad095,_0x7fec48[_0x310688]);}return __setModuleDefault(_0x114275,_0x5ad095),_0x114275;};}()),__importDefault=this&&this[a13_0x303eef(0x161)]||function(_0x387433){const _0x3e3324=a13_0x303eef;return _0x387433&&_0x387433[_0x3e3324(0x131)]?_0x387433:{'default':_0x387433};};Object[a13_0x303eef(0x11d)](exports,a13_0x303eef(0x131),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x303eef(0x105)),database_1=__importDefault(require(a13_0x303eef(0x150)));class TestGatewayController{constructor(){const _0x527d55=a13_0x303eef;this[_0x527d55(0x110)]=async(_0x57c6ec,_0x24b733,_0x3dddf4)=>{const _0x142e21=_0x527d55;try{const {paymentId:_0x21429f}=_0x57c6ec[_0x142e21(0x124)];console[_0x142e21(0x141)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x21429f);const _0x27e36d=await database_1['default']['payment'][_0x142e21(0x14f)]({'where':{'id':_0x21429f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x27e36d)return _0x24b733[_0x142e21(0x10b)](0x194)[_0x142e21(0x158)]({'success':![],'message':_0x142e21(0x156)});if(_0x27e36d[_0x142e21(0x136)]!=='test_gateway')return _0x24b733[_0x142e21(0x10b)](0x190)[_0x142e21(0x158)]({'success':![],'message':_0x142e21(0x165)});if(_0x27e36d[_0x142e21(0x10b)]!==_0x142e21(0x14b))return _0x24b733[_0x142e21(0x10b)](0x190)[_0x142e21(0x158)]({'success':![],'message':_0x142e21(0x10f)+_0x27e36d[_0x142e21(0x10b)]+_0x142e21(0x12f)});_0x24b733['json']({'success':!![],'result':{'paymentId':_0x27e36d['id'],'orderId':_0x27e36d['gatewayOrderId'],'amount':_0x27e36d[_0x142e21(0x142)],'currency':_0x27e36d['currency'],'merchantName':_0x27e36d[_0x142e21(0x14d)][_0x142e21(0x16a)],'description':_0x142e21(0x169)+_0x27e36d[_0x142e21(0x14d)][_0x142e21(0x16a)],'testInstructions':{'successCard':_0x142e21(0x128),'failureCard':_0x142e21(0x15b),'expiryDate':_0x142e21(0x106),'cvc':_0x142e21(0x144),'holderName':_0x142e21(0x149)}}});}catch(_0x1356c9){_0x3dddf4(_0x1356c9);}},this[_0x527d55(0x152)]=async(_0x19f14f,_0x36344a,_0x50046a)=>{const _0x590cd5=_0x527d55;try{const {paymentId:_0x202f54}=_0x19f14f[_0x590cd5(0x124)],_0x505b17=_0x19f14f[_0x590cd5(0x14c)];console['log'](_0x590cd5(0x155)+_0x202f54);const _0x2a4a74=await database_1[_0x590cd5(0x14e)][_0x590cd5(0x104)][_0x590cd5(0x14f)]({'where':{'id':_0x202f54},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a4a74)return _0x36344a[_0x590cd5(0x10b)](0x194)[_0x590cd5(0x158)]({'success':![],'message':_0x590cd5(0x156)});if(_0x2a4a74[_0x590cd5(0x136)]!==_0x590cd5(0x12c))return _0x36344a[_0x590cd5(0x10b)](0x190)['json']({'success':![],'message':_0x590cd5(0x165)});if(_0x2a4a74[_0x590cd5(0x10b)]!==_0x590cd5(0x14b))return _0x36344a[_0x590cd5(0x10b)](0x190)[_0x590cd5(0x158)]({'success':![],'message':_0x590cd5(0x10f)+_0x2a4a74[_0x590cd5(0x10b)]+',\x20cannot\x20process'});const _0x131e5e=await this[_0x590cd5(0x127)][_0x590cd5(0x151)]({'paymentId':_0x2a4a74['id'],'orderId':_0x2a4a74[_0x590cd5(0x114)]||_0x2a4a74['id'],'amount':_0x2a4a74[_0x590cd5(0x142)],'currency':_0x2a4a74['currency'],'cardData':_0x505b17});console[_0x590cd5(0x141)](_0x590cd5(0x15c),_0x131e5e);const _0x356791={'status':_0x131e5e['status'],'updatedAt':new Date()};if(_0x131e5e['status']===_0x590cd5(0x121))_0x356791[_0x590cd5(0x117)]=new Date(),_0x356791['gatewayPaymentId']=_0x131e5e['transactionId'];else _0x131e5e[_0x590cd5(0x10b)]===_0x590cd5(0x10c)&&(_0x356791[_0x590cd5(0x13f)]=_0x131e5e[_0x590cd5(0x17b)]);const _0x2fa9b3=_0x505b17['cardNumber'][_0x590cd5(0x16e)](/[\s-]/g,'');_0x356791[_0x590cd5(0x11c)]=_0x2fa9b3[_0x590cd5(0x181)](-0x4),_0x356791[_0x590cd5(0x178)]=_0x590cd5(0x13d),await database_1[_0x590cd5(0x14e)]['payment']['update']({'where':{'id':_0x2a4a74['id']},'data':_0x356791});if(_0x131e5e[_0x590cd5(0x10b)]===_0x590cd5(0x121)&&_0x2a4a74['paymentLinkId']){console['log'](_0x590cd5(0x12e)+_0x2a4a74['id']+_0x590cd5(0x134));try{await database_1[_0x590cd5(0x14e)][_0x590cd5(0x172)](async _0x499c7c=>{const _0x52a109=_0x590cd5,_0x3e46e9=await _0x499c7c[_0x52a109(0x113)]['findUnique']({'where':{'id':_0x2a4a74[_0x52a109(0x154)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3e46e9){console[_0x52a109(0x141)](_0x52a109(0x175)+_0x3e46e9['id']+_0x52a109(0x166)+_0x3e46e9[_0x52a109(0x182)]+_0x52a109(0x16b)+_0x3e46e9[_0x52a109(0x116)]+_0x52a109(0x122)+_0x3e46e9[_0x52a109(0x10b)]);const _0x255339=_0x3e46e9[_0x52a109(0x116)]+0x1,_0x4ac57e=_0x3e46e9['type']===_0x52a109(0x108)?'COMPLETED':_0x3e46e9[_0x52a109(0x10b)];await _0x499c7c[_0x52a109(0x113)][_0x52a109(0x157)]({'where':{'id':_0x2a4a74[_0x52a109(0x154)]},'data':{'currentPayments':_0x255339,'status':_0x4ac57e,'updatedAt':new Date()}}),console['log'](_0x52a109(0x107)+_0x3e46e9['id']+'\x20updated:\x20currentPayments='+_0x3e46e9[_0x52a109(0x116)]+_0x52a109(0x177)+_0x255339+_0x52a109(0x122)+_0x3e46e9[_0x52a109(0x10b)]+'\x20->\x20'+_0x4ac57e);}else console['log'](_0x52a109(0x11b)+_0x2a4a74['paymentLinkId']+_0x52a109(0x139));});}catch(_0x321f00){console[_0x590cd5(0x13b)](_0x590cd5(0x112),_0x321f00);}}await database_1[_0x590cd5(0x14e)][_0x590cd5(0x145)]['create']({'data':{'paymentId':_0x2a4a74['id'],'shopId':_0x2a4a74['shopId'],'event':_0x590cd5(0x168)+_0x131e5e['status'][_0x590cd5(0x173)](),'statusCode':0xc8,'responseBody':JSON[_0x590cd5(0x12b)]({'oldStatus':'PENDING','newStatus':_0x131e5e[_0x590cd5(0x10b)],'transactionId':_0x131e5e[_0x590cd5(0x10d)],'failureReason':_0x131e5e[_0x590cd5(0x17b)],'processedAt':new Date()[_0x590cd5(0x10e)]()})}}),await this['sendShopWebhook'](_0x2a4a74,_0x131e5e[_0x590cd5(0x10b)],_0x131e5e[_0x590cd5(0x10d)],_0x131e5e[_0x590cd5(0x17b)]),await this[_0x590cd5(0x132)](_0x2a4a74,_0x131e5e['status']),console[_0x590cd5(0x141)](_0x590cd5(0x123)+_0x202f54+_0x590cd5(0x180)+_0x131e5e['status']),_0x131e5e[_0x590cd5(0x10b)]===_0x590cd5(0x121)?_0x36344a[_0x590cd5(0x158)]({'success':!![],'message':_0x590cd5(0x148),'result':{'status':_0x590cd5(0x121),'transactionId':_0x131e5e['transactionId'],'redirectUrl':_0x2a4a74[_0x590cd5(0x109)]}}):_0x36344a[_0x590cd5(0x10b)](0x190)[_0x590cd5(0x158)]({'success':![],'message':_0x590cd5(0x17a),'result':{'status':_0x590cd5(0x10c),'failureReason':_0x131e5e[_0x590cd5(0x17b)],'redirectUrl':_0x2a4a74[_0x590cd5(0x17d)]}});}catch(_0x73cc61){_0x50046a(_0x73cc61);}},this['testGatewayService']=new testGatewayService_1[(_0x527d55(0x147))](),this[_0x527d55(0x171)]=new webhookService_1[(_0x527d55(0x119))]();}async[a13_0x303eef(0x164)](_0x160ea0,_0x3ad445,_0x2d80cc,_0x220463){const _0x1f3761=a13_0x303eef,_0x26f139=Date[_0x1f3761(0x15a)]();try{const _0x89d76d=_0x160ea0[_0x1f3761(0x14d)],_0x47cea5=_0x89d76d['settings'];if(!_0x47cea5?.[_0x1f3761(0x179)]){console[_0x1f3761(0x141)](_0x1f3761(0x153)+_0x89d76d['id']);return;}const _0xc9459c=_0x3ad445==='PAID'?_0x1f3761(0x162):_0x1f3761(0x13e);let _0x45670c=[];if(_0x47cea5[_0x1f3761(0x16f)])try{_0x45670c=Array[_0x1f3761(0x16c)](_0x47cea5[_0x1f3761(0x16f)])?_0x47cea5['webhookEvents']:JSON[_0x1f3761(0x16d)](_0x47cea5[_0x1f3761(0x16f)]);}catch(_0x44fefd){console[_0x1f3761(0x13b)](_0x1f3761(0x115),_0x44fefd),_0x45670c=[];}if(!_0x45670c[_0x1f3761(0x14a)](_0xc9459c)){console[_0x1f3761(0x141)](_0x1f3761(0x17e)+_0xc9459c+'\x20not\x20enabled\x20for\x20shop\x20'+_0x89d76d['id']);return;}const _0x2975a0={'event':_0xc9459c,'payment':{'id':_0x160ea0['id'],'order_id':_0x160ea0[_0x1f3761(0x111)],'gateway_order_id':_0x160ea0['gatewayOrderId'],'gateway':'0000','amount':_0x160ea0['amount'],'currency':_0x160ea0[_0x1f3761(0x10a)],'status':_0x3ad445[_0x1f3761(0x173)](),'customer_email':_0x160ea0['customerEmail'],'customer_name':_0x160ea0[_0x1f3761(0x11e)],'transaction_id':_0x2d80cc,'failure_message':_0x220463,'created_at':_0x160ea0[_0x1f3761(0x17c)],'updated_at':new Date()}},_0x295688=await fetch(_0x47cea5[_0x1f3761(0x179)],{'method':'POST','headers':{'Content-Type':_0x1f3761(0x15d),'User-Agent':_0x1f3761(0x163)},'body':JSON[_0x1f3761(0x12b)](_0x2975a0)}),_0x217018=Date[_0x1f3761(0x15a)]()-_0x26f139;console[_0x1f3761(0x141)](_0x1f3761(0x159)+_0x47cea5[_0x1f3761(0x179)]+'\x20with\x20status\x20'+_0x295688['status']+'\x20('+_0x217018+'ms)');}catch(_0x182369){console[_0x1f3761(0x13b)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x182369);}}async[a13_0x303eef(0x132)](_0x3b775e,_0x475bf5){const _0x3a82ef=a13_0x303eef;try{const {telegramBotService:_0x4725e4}=await Promise[_0x3a82ef(0x13a)]()[_0x3a82ef(0x140)](()=>__importStar(require(_0x3a82ef(0x126)))),_0x599276={'PAID':_0x3a82ef(0x160),'FAILED':_0x3a82ef(0x11a)},_0x17b2bb=_0x599276[_0x475bf5];if(!_0x17b2bb)return;await _0x4725e4['sendPaymentNotification'](_0x3b775e[_0x3a82ef(0x183)],_0x3b775e,_0x17b2bb);}catch(_0x413b0a){console['error'](_0x3a82ef(0x120),_0x413b0a);}}}function a13_0x4d20(_0x429e7b,_0x248435){const _0x5139c8=a13_0x5139();return a13_0x4d20=function(_0x4d2001,_0x1a8243){_0x4d2001=_0x4d2001-0x104;let _0x5b4643=_0x5139c8[_0x4d2001];return _0x5b4643;},a13_0x4d20(_0x429e7b,_0x248435);}function a13_0x5139(){const _0x420445=['\x20processed:\x20','slice','type','shopId','payment','../services/webhookService','Any\x20future\x20date\x20(MM/YY)','✅\x20Payment\x20link\x20','SINGLE','successUrl','currency','status','FAILED','transactionId','toISOString','Payment\x20status\x20is\x20','getPaymentForm','orderId','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','paymentLink','gatewayOrderId','Error\x20parsing\x20webhook\x20events:','currentPayments','paidAt','354360nRhVwM','WebhookService','failed','❌\x20Payment\x20link\x20','cardLast4','defineProperty','customerName','9UtXtqv','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PAID',',\x20status=','✅\x20Test\x20Gateway\x20payment\x20','params','prototype','../services/telegramBotService','testGatewayService','4242\x204242\x204242\x204242','1536162BEIANs','hasOwnProperty','stringify','test_gateway','__importStar','📈\x20Test\x20Gateway:\x20Payment\x20',',\x20cannot\x20process','create','__esModule','sendPaymentStatusNotification','1768600bKAmoQ','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','217qfMQuc','gateway','configurable','get','\x20not\x20found','resolve','error','call','test_card','payment.failed','failureMessage','then','log','amount','getOwnPropertyDescriptor','Any\x203-4\x20digits','webhookLog','length','TestGatewayService','Payment\x20processed\x20successfully','Any\x20name','includes','PENDING','body','shop','default','findUnique','../config/database','processCardPayment','processCard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentLinkId','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20not\x20found','update','json','Test\x20Gateway\x20webhook\x20sent\x20to\x20','now','Any\x20other\x20card\x20number','🧪\x20Test\x20Gateway\x20result:','application/json','5UZYLXm','5881880IUXEYN','paid','__importDefault','payment.success','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','sendShopWebhook','Payment\x20is\x20not\x20for\x20test\x20gateway',':\x20type=','2726220zJgWWv','test_gateway_','Payment\x20to\x20','name',',\x20currentPayments=','isArray','parse','replace','webhookEvents','getOwnPropertyNames','webhookService','$transaction','toLowerCase','5806fbnmEv','📈\x20Found\x20payment\x20link\x20','__setModuleDefault','\x20->\x20','paymentMethod','webhookUrl','Payment\x20failed','failureReason','createdAt','failUrl','Webhook\x20event\x20','2166138eGExmi'];a13_0x5139=function(){return _0x420445;};return a13_0x5139();}exports['TestGatewayController']=TestGatewayController;