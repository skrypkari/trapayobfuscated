'use strict';function a13_0xb855(){const _0x331b75=['PENDING','__createBinding','Test\x20Gateway\x20webhook\x20sent\x20to\x20','toLowerCase','../services/gateways/testGatewayService','slice','settings','__importDefault','10rfljPS','getPaymentForm','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','ms)','currency','json','amount','call','gateway','Any\x20other\x20card\x20number','__setModuleDefault','customerName','orderId','\x20not\x20enabled\x20for\x20shop\x20','defineProperty','test_gateway','application/json','ðŸ§ª\x20Test\x20Gateway\x20result:','TestGatewayService','4242\x204242\x204242\x204242','../services/webhookService','âœ…\x20Test\x20Gateway\x20payment\x20','FAILED','log','failureReason','TestGatewayController','resolve','create','gatewayOrderId','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','\x20processed:\x20','findUnique','21ZYpZqF','318589YwxHkt','hasOwnProperty','failed','Payment\x20not\x20found','getOwnPropertyNames','replace','payment','getOwnPropertyDescriptor','30BQTLqg','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','stringify','default','successUrl','transactionId','WebhookService','cardNumber','8034774hZxRPy','paymentMethod','customerEmail','1698088ISDcAU','5XTiCmv','update','webhookService','gatewayPaymentId','sendPaymentNotification','status','webhookUrl','11695860mMvorN','6458544LUMUUh','parse','prototype','sendShopWebhook','4545167syXkcR','Any\x20future\x20date\x20(MM/YY)','testGatewayService','get','writable','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','test_card','shopId','\x20with\x20status\x20','length',',\x20cannot\x20process','then','Payment\x20to\x20','paid','now','configurable','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.success','error','PAID','0000','sendPaymentStatusNotification','4737435VZRWmw','payment.failed','Payment\x20failed','webhookEvents','Any\x203-4\x20digits','params','name','Payment\x20is\x20not\x20for\x20test\x20gateway','POST','failUrl','Any\x20name','__esModule','shop','processCard','../config/database'];a13_0xb855=function(){return _0x331b75;};return a13_0xb855();}function a13_0x5e7a(_0x55167c,_0x5c326f){const _0xb85563=a13_0xb855();return a13_0x5e7a=function(_0x5e7a10,_0x28da65){_0x5e7a10=_0x5e7a10-0xdd;let _0x3f4227=_0xb85563[_0x5e7a10];return _0x3f4227;},a13_0x5e7a(_0x55167c,_0x5c326f);}const a13_0x294d46=a13_0x5e7a;(function(_0x2de8f3,_0x306d23){const _0xb7bcfe=a13_0x5e7a,_0x5292e3=_0x2de8f3();while(!![]){try{const _0x4d544e=parseInt(_0xb7bcfe(0x103))/0x1*(parseInt(_0xb7bcfe(0xe2))/0x2)+-parseInt(_0xb7bcfe(0x139))/0x3+-parseInt(_0xb7bcfe(0x11f))/0x4*(-parseInt(_0xb7bcfe(0x117))/0x5)+-parseInt(_0xb7bcfe(0x113))/0x6+-parseInt(_0xb7bcfe(0x102))/0x7*(-parseInt(_0xb7bcfe(0x116))/0x8)+-parseInt(_0xb7bcfe(0x11e))/0x9+-parseInt(_0xb7bcfe(0x10b))/0xa*(-parseInt(_0xb7bcfe(0x123))/0xb);if(_0x4d544e===_0x306d23)break;else _0x5292e3['push'](_0x5292e3['shift']());}catch(_0x31e333){_0x5292e3['push'](_0x5292e3['shift']());}}}(a13_0xb855,0xd375d));var __createBinding=this&&this[a13_0x294d46(0x149)]||(Object[a13_0x294d46(0xfd)]?function(_0x456cdc,_0x3eb1a4,_0x1dd88b,_0x5428bf){const _0x4b622d=a13_0x294d46;if(_0x5428bf===undefined)_0x5428bf=_0x1dd88b;var _0xce06ed=Object[_0x4b622d(0x10a)](_0x3eb1a4,_0x1dd88b);(!_0xce06ed||(_0x4b622d(0x126)in _0xce06ed?!_0x3eb1a4[_0x4b622d(0x144)]:_0xce06ed[_0x4b622d(0x127)]||_0xce06ed[_0x4b622d(0x132)]))&&(_0xce06ed={'enumerable':!![],'get':function(){return _0x3eb1a4[_0x1dd88b];}}),Object['defineProperty'](_0x456cdc,_0x5428bf,_0xce06ed);}:function(_0x5b59f8,_0x18233e,_0x4a896b,_0x1546eb){if(_0x1546eb===undefined)_0x1546eb=_0x4a896b;_0x5b59f8[_0x1546eb]=_0x18233e[_0x4a896b];}),__setModuleDefault=this&&this[a13_0x294d46(0xec)]||(Object['create']?function(_0x11e43e,_0x3079b5){const _0x5b7c52=a13_0x294d46;Object[_0x5b7c52(0xf0)](_0x11e43e,_0x5b7c52(0x10e),{'enumerable':!![],'value':_0x3079b5});}:function(_0x7383cc,_0x1811f9){const _0x43645c=a13_0x294d46;_0x7383cc[_0x43645c(0x10e)]=_0x1811f9;}),__importStar=this&&this['__importStar']||(function(){var _0xcdf1dc=function(_0x1e65f8){const _0x3659db=a13_0x5e7a;return _0xcdf1dc=Object[_0x3659db(0x107)]||function(_0x5028c5){const _0x113934=_0x3659db;var _0x1cd723=[];for(var _0x5b1ad5 in _0x5028c5)if(Object[_0x113934(0x121)][_0x113934(0x104)][_0x113934(0xe9)](_0x5028c5,_0x5b1ad5))_0x1cd723[_0x1cd723[_0x113934(0x12c)]]=_0x5b1ad5;return _0x1cd723;},_0xcdf1dc(_0x1e65f8);};return function(_0x517fb7){const _0xe66540=a13_0x5e7a;if(_0x517fb7&&_0x517fb7[_0xe66540(0x144)])return _0x517fb7;var _0x10a256={};if(_0x517fb7!=null){for(var _0x31d404=_0xcdf1dc(_0x517fb7),_0x528c27=0x0;_0x528c27<_0x31d404[_0xe66540(0x12c)];_0x528c27++)if(_0x31d404[_0x528c27]!==_0xe66540(0x10e))__createBinding(_0x10a256,_0x517fb7,_0x31d404[_0x528c27]);}return __setModuleDefault(_0x10a256,_0x517fb7),_0x10a256;};}()),__importDefault=this&&this[a13_0x294d46(0xe1)]||function(_0x147aff){const _0x4da829=a13_0x294d46;return _0x147aff&&_0x147aff[_0x4da829(0x144)]?_0x147aff:{'default':_0x147aff};};Object[a13_0x294d46(0xf0)](exports,a13_0x294d46(0x144),{'value':!![]}),exports[a13_0x294d46(0xfb)]=void 0x0;const testGatewayService_1=require(a13_0x294d46(0xde)),webhookService_1=require(a13_0x294d46(0xf6)),database_1=__importDefault(require(a13_0x294d46(0x147)));class TestGatewayController{constructor(){const _0x2f2b29=a13_0x294d46;this[_0x2f2b29(0xe3)]=async(_0x20e25e,_0xc54cce,_0x4b6ed5)=>{const _0x1252bd=_0x2f2b29;try{const {paymentId:_0x511bdf}=_0x20e25e[_0x1252bd(0x13e)];console[_0x1252bd(0xf9)](_0x1252bd(0xff)+_0x511bdf);const _0x5b4779=await database_1[_0x1252bd(0x10e)][_0x1252bd(0x109)][_0x1252bd(0x101)]({'where':{'id':_0x511bdf},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5b4779)return _0xc54cce[_0x1252bd(0x11c)](0x194)[_0x1252bd(0xe7)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5b4779[_0x1252bd(0xea)]!==_0x1252bd(0xf1))return _0xc54cce[_0x1252bd(0x11c)](0x190)[_0x1252bd(0xe7)]({'success':![],'message':_0x1252bd(0x140)});if(_0x5b4779[_0x1252bd(0x11c)]!==_0x1252bd(0x148))return _0xc54cce[_0x1252bd(0x11c)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5b4779[_0x1252bd(0x11c)]+_0x1252bd(0x12d)});_0xc54cce[_0x1252bd(0xe7)]({'success':!![],'result':{'paymentId':_0x5b4779['id'],'orderId':_0x5b4779[_0x1252bd(0xfe)],'amount':_0x5b4779[_0x1252bd(0xe8)],'currency':_0x5b4779[_0x1252bd(0xe6)],'merchantName':_0x5b4779['shop']['name'],'description':_0x1252bd(0x12f)+_0x5b4779[_0x1252bd(0x145)][_0x1252bd(0x13f)],'testInstructions':{'successCard':_0x1252bd(0xf5),'failureCard':_0x1252bd(0xeb),'expiryDate':_0x1252bd(0x124),'cvc':_0x1252bd(0x13d),'holderName':_0x1252bd(0x143)}}});}catch(_0x1f61b4){_0x4b6ed5(_0x1f61b4);}},this[_0x2f2b29(0x146)]=async(_0x4e2d5e,_0x429d7f,_0x256dce)=>{const _0x5c3b1c=_0x2f2b29;try{const {paymentId:_0x517bdb}=_0x4e2d5e[_0x5c3b1c(0x13e)],_0x2e7af8=_0x4e2d5e['body'];console[_0x5c3b1c(0xf9)](_0x5c3b1c(0x10c)+_0x517bdb);const _0x299295=await database_1[_0x5c3b1c(0x10e)][_0x5c3b1c(0x109)][_0x5c3b1c(0x101)]({'where':{'id':_0x517bdb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x299295)return _0x429d7f['status'](0x194)[_0x5c3b1c(0xe7)]({'success':![],'message':_0x5c3b1c(0x106)});if(_0x299295[_0x5c3b1c(0xea)]!==_0x5c3b1c(0xf1))return _0x429d7f[_0x5c3b1c(0x11c)](0x190)['json']({'success':![],'message':_0x5c3b1c(0x140)});if(_0x299295['status']!==_0x5c3b1c(0x148))return _0x429d7f[_0x5c3b1c(0x11c)](0x190)[_0x5c3b1c(0xe7)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x299295[_0x5c3b1c(0x11c)]+_0x5c3b1c(0x12d)});const _0x536e80=await this[_0x5c3b1c(0x125)]['processCardPayment']({'paymentId':_0x299295['id'],'orderId':_0x299295[_0x5c3b1c(0xfe)]||_0x299295['id'],'amount':_0x299295['amount'],'currency':_0x299295[_0x5c3b1c(0xe6)],'cardData':_0x2e7af8});console[_0x5c3b1c(0xf9)](_0x5c3b1c(0xf3),_0x536e80);const _0x20e530={'status':_0x536e80[_0x5c3b1c(0x11c)],'updatedAt':new Date()};if(_0x536e80[_0x5c3b1c(0x11c)]===_0x5c3b1c(0x136))_0x20e530['paidAt']=new Date(),_0x20e530[_0x5c3b1c(0x11a)]=_0x536e80[_0x5c3b1c(0x110)];else _0x536e80[_0x5c3b1c(0x11c)]==='FAILED'&&(_0x20e530['failureMessage']=_0x536e80[_0x5c3b1c(0xfa)]);const _0x54ba85=_0x2e7af8[_0x5c3b1c(0x112)][_0x5c3b1c(0x108)](/[\s-]/g,'');_0x20e530['cardLast4']=_0x54ba85[_0x5c3b1c(0xdf)](-0x4),_0x20e530[_0x5c3b1c(0x114)]=_0x5c3b1c(0x129),await database_1[_0x5c3b1c(0x10e)][_0x5c3b1c(0x109)][_0x5c3b1c(0x118)]({'where':{'id':_0x299295['id']},'data':_0x20e530}),await database_1[_0x5c3b1c(0x10e)]['webhookLog'][_0x5c3b1c(0xfd)]({'data':{'paymentId':_0x299295['id'],'shopId':_0x299295[_0x5c3b1c(0x12a)],'event':'test_gateway_'+_0x536e80[_0x5c3b1c(0x11c)][_0x5c3b1c(0xdd)](),'statusCode':0xc8,'responseBody':JSON[_0x5c3b1c(0x10d)]({'oldStatus':_0x5c3b1c(0x148),'newStatus':_0x536e80['status'],'transactionId':_0x536e80['transactionId'],'failureReason':_0x536e80['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x5c3b1c(0x122)](_0x299295,_0x536e80[_0x5c3b1c(0x11c)],_0x536e80[_0x5c3b1c(0x110)],_0x536e80[_0x5c3b1c(0xfa)]),await this[_0x5c3b1c(0x138)](_0x299295,_0x536e80[_0x5c3b1c(0x11c)]),console['log'](_0x5c3b1c(0xf7)+_0x517bdb+_0x5c3b1c(0x100)+_0x536e80[_0x5c3b1c(0x11c)]),_0x536e80[_0x5c3b1c(0x11c)]===_0x5c3b1c(0x136)?_0x429d7f[_0x5c3b1c(0xe7)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x536e80[_0x5c3b1c(0x110)],'redirectUrl':_0x299295[_0x5c3b1c(0x10f)]}}):_0x429d7f[_0x5c3b1c(0x11c)](0x190)[_0x5c3b1c(0xe7)]({'success':![],'message':_0x5c3b1c(0x13b),'result':{'status':_0x5c3b1c(0xf8),'failureReason':_0x536e80[_0x5c3b1c(0xfa)],'redirectUrl':_0x299295[_0x5c3b1c(0x142)]}});}catch(_0x349e7d){_0x256dce(_0x349e7d);}},this['testGatewayService']=new testGatewayService_1[(_0x2f2b29(0xf4))](),this[_0x2f2b29(0x119)]=new webhookService_1[(_0x2f2b29(0x111))]();}async[a13_0x294d46(0x122)](_0x33b050,_0x247c31,_0x5c27e2,_0x343182){const _0x200fca=a13_0x294d46,_0x36be31=Date[_0x200fca(0x131)]();try{const _0x5b9503=_0x33b050['shop'],_0x6b59f5=_0x5b9503[_0x200fca(0xe0)];if(!_0x6b59f5?.[_0x200fca(0x11d)]){console[_0x200fca(0xf9)](_0x200fca(0x133)+_0x5b9503['id']);return;}const _0x181ba6=_0x247c31==='PAID'?_0x200fca(0x134):_0x200fca(0x13a);let _0x194a8b=[];if(_0x6b59f5['webhookEvents'])try{_0x194a8b=Array['isArray'](_0x6b59f5[_0x200fca(0x13c)])?_0x6b59f5[_0x200fca(0x13c)]:JSON[_0x200fca(0x120)](_0x6b59f5['webhookEvents']);}catch(_0x4ae69b){console[_0x200fca(0x135)]('Error\x20parsing\x20webhook\x20events:',_0x4ae69b),_0x194a8b=[];}if(!_0x194a8b['includes'](_0x181ba6)){console[_0x200fca(0xf9)]('Webhook\x20event\x20'+_0x181ba6+_0x200fca(0xef)+_0x5b9503['id']);return;}const _0x52a45a={'event':_0x181ba6,'payment':{'id':_0x33b050['id'],'order_id':_0x33b050[_0x200fca(0xee)],'gateway_order_id':_0x33b050[_0x200fca(0xfe)],'gateway':_0x200fca(0x137),'amount':_0x33b050[_0x200fca(0xe8)],'currency':_0x33b050[_0x200fca(0xe6)],'status':_0x247c31['toLowerCase'](),'customer_email':_0x33b050[_0x200fca(0x115)],'customer_name':_0x33b050[_0x200fca(0xed)],'transaction_id':_0x5c27e2,'failure_message':_0x343182,'created_at':_0x33b050['createdAt'],'updated_at':new Date()}},_0x2a8299=await fetch(_0x6b59f5[_0x200fca(0x11d)],{'method':_0x200fca(0x141),'headers':{'Content-Type':_0x200fca(0xf2),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x52a45a)}),_0x50768b=Date[_0x200fca(0x131)]()-_0x36be31;console['log'](_0x200fca(0x14a)+_0x6b59f5['webhookUrl']+_0x200fca(0x12b)+_0x2a8299[_0x200fca(0x11c)]+'\x20('+_0x50768b+_0x200fca(0xe5));}catch(_0x145b0a){console[_0x200fca(0x135)](_0x200fca(0xe4),_0x145b0a);}}async['sendPaymentStatusNotification'](_0x3f0e63,_0x5e0582){const _0x21a8cf=a13_0x294d46;try{const {telegramBotService:_0x572e81}=await Promise[_0x21a8cf(0xfc)]()[_0x21a8cf(0x12e)](()=>__importStar(require('../services/telegramBotService'))),_0x1ebc87={'PAID':_0x21a8cf(0x130),'FAILED':_0x21a8cf(0x105)},_0x5a5ad3=_0x1ebc87[_0x5e0582];if(!_0x5a5ad3)return;await _0x572e81[_0x21a8cf(0x11b)](_0x3f0e63[_0x21a8cf(0x12a)],_0x3f0e63,_0x5a5ad3);}catch(_0x19c9f9){console[_0x21a8cf(0x135)](_0x21a8cf(0x128),_0x19c9f9);}}}exports[a13_0x294d46(0xfb)]=TestGatewayController;