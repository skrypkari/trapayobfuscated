'use strict';const a19_0x264d8b=a19_0x1830;function a19_0x1830(_0x1681e7,_0xefac05){_0x1681e7=_0x1681e7-0xe8;const _0x544d4a=a19_0x544d();let _0x183054=_0x544d4a[_0x1681e7];return _0x183054;}(function(_0x2d7ef8,_0x62dd){const _0x26c1af=a19_0x1830,_0x459c9e=_0x2d7ef8();while(!![]){try{const _0x2eaa96=-parseInt(_0x26c1af(0xef))/0x1*(parseInt(_0x26c1af(0x152))/0x2)+-parseInt(_0x26c1af(0x10b))/0x3+-parseInt(_0x26c1af(0x140))/0x4+-parseInt(_0x26c1af(0x103))/0x5+parseInt(_0x26c1af(0xfc))/0x6+parseInt(_0x26c1af(0x11a))/0x7+-parseInt(_0x26c1af(0x101))/0x8*(-parseInt(_0x26c1af(0xf3))/0x9);if(_0x2eaa96===_0x62dd)break;else _0x459c9e['push'](_0x459c9e['shift']());}catch(_0x5abc09){_0x459c9e['push'](_0x459c9e['shift']());}}}(a19_0x544d,0x4ad45));var __createBinding=this&&this[a19_0x264d8b(0x14b)]||(Object[a19_0x264d8b(0x115)]?function(_0x557579,_0x452963,_0xc203ee,_0x56ac6b){const _0x5c5b3a=a19_0x264d8b;if(_0x56ac6b===undefined)_0x56ac6b=_0xc203ee;var _0x327f61=Object[_0x5c5b3a(0x15f)](_0x452963,_0xc203ee);(!_0x327f61||(_0x5c5b3a(0xee)in _0x327f61?!_0x452963['__esModule']:_0x327f61['writable']||_0x327f61['configurable']))&&(_0x327f61={'enumerable':!![],'get':function(){return _0x452963[_0xc203ee];}}),Object['defineProperty'](_0x557579,_0x56ac6b,_0x327f61);}:function(_0x4cfc70,_0x3dc73e,_0x49ba4c,_0x14e552){if(_0x14e552===undefined)_0x14e552=_0x49ba4c;_0x4cfc70[_0x14e552]=_0x3dc73e[_0x49ba4c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a19_0x264d8b(0x115)]?function(_0x5030ac,_0x4734d6){const _0x13f20d=a19_0x264d8b;Object[_0x13f20d(0x141)](_0x5030ac,'default',{'enumerable':!![],'value':_0x4734d6});}:function(_0x24b7ef,_0x52109c){const _0x35b70a=a19_0x264d8b;_0x24b7ef[_0x35b70a(0x14e)]=_0x52109c;}),__importStar=this&&this[a19_0x264d8b(0x14d)]||(function(){var _0x4035a9=function(_0x47ad72){const _0x15ffac=a19_0x1830;return _0x4035a9=Object[_0x15ffac(0x11c)]||function(_0x3ad151){const _0x91c4ef=_0x15ffac;var _0x4a9e21=[];for(var _0x43dec8 in _0x3ad151)if(Object[_0x91c4ef(0x12e)][_0x91c4ef(0x124)][_0x91c4ef(0x159)](_0x3ad151,_0x43dec8))_0x4a9e21[_0x4a9e21[_0x91c4ef(0x126)]]=_0x43dec8;return _0x4a9e21;},_0x4035a9(_0x47ad72);};return function(_0x23e4c9){const _0x20cef7=a19_0x1830;if(_0x23e4c9&&_0x23e4c9['__esModule'])return _0x23e4c9;var _0x4cb579={};if(_0x23e4c9!=null){for(var _0x49b8e5=_0x4035a9(_0x23e4c9),_0x306680=0x0;_0x306680<_0x49b8e5[_0x20cef7(0x126)];_0x306680++)if(_0x49b8e5[_0x306680]!==_0x20cef7(0x14e))__createBinding(_0x4cb579,_0x23e4c9,_0x49b8e5[_0x306680]);}return __setModuleDefault(_0x4cb579,_0x23e4c9),_0x4cb579;};}()),__importDefault=this&&this[a19_0x264d8b(0x144)]||function(_0x139c8c){const _0x48906f=a19_0x264d8b;return _0x139c8c&&_0x139c8c[_0x48906f(0x14f)]?_0x139c8c:{'default':_0x139c8c};};function a19_0x544d(){const _0xe59151=['test_gateway','stringify','call','Payment\x20System/1.0\x20(Test\x20Gateway)','status','then','\x20processed:\x20','âœ…\x20Test\x20Gateway\x20payment\x20','getOwnPropertyDescriptor','POST','type','../services/telegramBotService','PENDING','âŒ\x20Payment\x20link\x20',',\x20status=','get','24971BCsFDb','Payment\x20to\x20','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','gateway','11619081rkgZWS','0000','Any\x20future\x20date\x20(MM/YY)','../services/gateways/testGatewayService','createdAt','resolve','Payment\x20not\x20found','ðŸ§ª\x20Test\x20Gateway\x20result:','paymentMethod','2687892yItYWK','log','webhookLog','webhookUrl','test_gateway_','8MAuWbc','payment','2071240zopyNd','test_card','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','customerName','application/json','âœ…\x20Payment\x20link\x20','Webhook\x20event\x20','paidAt','1682997ftbugY','payment.success','payment.failed','getPaymentForm','orderId','ms)','COMPLETED','findUnique','../services/webhookService','toLowerCase','create','Payment\x20failed','testGatewayService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','now','2733486GgugnS','shopId','getOwnPropertyNames','\x20not\x20found',',\x20currentPayments=','Any\x20other\x20card\x20number','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failureReason','TestGatewayController','gatewayOrderId','hasOwnProperty','webhookService','length','cardNumber','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','json','paymentLinkId','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','currency','transactionId','prototype','sendPaymentStatusNotification','../config/database','update','\x20->\x20','includes','processCard','Payment\x20status\x20is\x20','shop','name','parse',',\x20cannot\x20process','amount','Payment\x20processed\x20successfully','cardLast4','PAID','\x20updated:\x20currentPayments=','currentPayments','1493168YltDUg','defineProperty','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','paymentLink','__importDefault',':\x20type=','sendShopWebhook','processCardPayment','failed','params','webhookEvents','__createBinding','Any\x203-4\x20digits','__importStar','default','__esModule','Payment\x20is\x20not\x20for\x20test\x20gateway','FAILED','38xrbraX','sendPaymentNotification','isArray','error','customerEmail'];a19_0x544d=function(){return _0xe59151;};return a19_0x544d();}Object[a19_0x264d8b(0x141)](exports,a19_0x264d8b(0x14f),{'value':!![]}),exports[a19_0x264d8b(0x122)]=void 0x0;const testGatewayService_1=require(a19_0x264d8b(0xf6)),webhookService_1=require(a19_0x264d8b(0x113)),database_1=__importDefault(require(a19_0x264d8b(0x130)));class TestGatewayController{constructor(){const _0x34353e=a19_0x264d8b;this[_0x34353e(0x10e)]=async(_0x402f85,_0x55ebf5,_0xac98bb)=>{const _0x1d62a4=_0x34353e;try{const {paymentId:_0x2d5ab0}=_0x402f85[_0x1d62a4(0x149)];console[_0x1d62a4(0xfd)](_0x1d62a4(0x142)+_0x2d5ab0);const _0x182a6a=await database_1[_0x1d62a4(0x14e)][_0x1d62a4(0x102)]['findUnique']({'where':{'id':_0x2d5ab0},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x182a6a)return _0x55ebf5[_0x1d62a4(0x15b)](0x194)[_0x1d62a4(0x129)]({'success':![],'message':_0x1d62a4(0xf9)});if(_0x182a6a['gateway']!==_0x1d62a4(0x157))return _0x55ebf5['status'](0x190)[_0x1d62a4(0x129)]({'success':![],'message':_0x1d62a4(0x150)});if(_0x182a6a[_0x1d62a4(0x15b)]!==_0x1d62a4(0xeb))return _0x55ebf5[_0x1d62a4(0x15b)](0x190)[_0x1d62a4(0x129)]({'success':![],'message':_0x1d62a4(0x135)+_0x182a6a[_0x1d62a4(0x15b)]+_0x1d62a4(0x139)});_0x55ebf5[_0x1d62a4(0x129)]({'success':!![],'result':{'paymentId':_0x182a6a['id'],'orderId':_0x182a6a['gatewayOrderId'],'amount':_0x182a6a[_0x1d62a4(0x13a)],'currency':_0x182a6a[_0x1d62a4(0x12c)],'merchantName':_0x182a6a[_0x1d62a4(0x136)][_0x1d62a4(0x137)],'description':_0x1d62a4(0xf0)+_0x182a6a[_0x1d62a4(0x136)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x1d62a4(0x11f),'expiryDate':_0x1d62a4(0xf5),'cvc':_0x1d62a4(0x14c),'holderName':'Any\x20name'}}});}catch(_0x376ac1){_0xac98bb(_0x376ac1);}},this[_0x34353e(0x134)]=async(_0x306776,_0x4dee11,_0x1f4eec)=>{const _0xeb1c3e=_0x34353e;try{const {paymentId:_0x137d32}=_0x306776[_0xeb1c3e(0x149)],_0x497e04=_0x306776['body'];console[_0xeb1c3e(0xfd)](_0xeb1c3e(0x105)+_0x137d32);const _0x1afa7d=await database_1['default'][_0xeb1c3e(0x102)]['findUnique']({'where':{'id':_0x137d32},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1afa7d)return _0x4dee11[_0xeb1c3e(0x15b)](0x194)[_0xeb1c3e(0x129)]({'success':![],'message':_0xeb1c3e(0xf9)});if(_0x1afa7d[_0xeb1c3e(0xf2)]!=='test_gateway')return _0x4dee11['status'](0x190)[_0xeb1c3e(0x129)]({'success':![],'message':_0xeb1c3e(0x150)});if(_0x1afa7d['status']!==_0xeb1c3e(0xeb))return _0x4dee11[_0xeb1c3e(0x15b)](0x190)[_0xeb1c3e(0x129)]({'success':![],'message':_0xeb1c3e(0x135)+_0x1afa7d[_0xeb1c3e(0x15b)]+',\x20cannot\x20process'});const _0x4c22ba=await this[_0xeb1c3e(0x117)][_0xeb1c3e(0x147)]({'paymentId':_0x1afa7d['id'],'orderId':_0x1afa7d[_0xeb1c3e(0x123)]||_0x1afa7d['id'],'amount':_0x1afa7d['amount'],'currency':_0x1afa7d[_0xeb1c3e(0x12c)],'cardData':_0x497e04});console[_0xeb1c3e(0xfd)](_0xeb1c3e(0xfa),_0x4c22ba);const _0x75d0bc={'status':_0x4c22ba[_0xeb1c3e(0x15b)],'updatedAt':new Date()};if(_0x4c22ba['status']==='PAID')_0x75d0bc[_0xeb1c3e(0x10a)]=new Date(),_0x75d0bc['gatewayPaymentId']=_0x4c22ba['transactionId'];else _0x4c22ba[_0xeb1c3e(0x15b)]===_0xeb1c3e(0x151)&&(_0x75d0bc['failureMessage']=_0x4c22ba[_0xeb1c3e(0x121)]);const _0xece62=_0x497e04[_0xeb1c3e(0x127)]['replace'](/[\s-]/g,'');_0x75d0bc[_0xeb1c3e(0x13c)]=_0xece62['slice'](-0x4),_0x75d0bc[_0xeb1c3e(0xfb)]=_0xeb1c3e(0x104),await database_1[_0xeb1c3e(0x14e)]['payment'][_0xeb1c3e(0x131)]({'where':{'id':_0x1afa7d['id']},'data':_0x75d0bc});if(_0x4c22ba[_0xeb1c3e(0x15b)]===_0xeb1c3e(0x13d)&&_0x1afa7d[_0xeb1c3e(0x12a)]){console[_0xeb1c3e(0xfd)](_0xeb1c3e(0xf1)+_0x1afa7d['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xeb1c3e(0x14e)]['$transaction'](async _0x5f19e5=>{const _0x4617aa=_0xeb1c3e,_0x4c739b=await _0x5f19e5['paymentLink'][_0x4617aa(0x112)]({'where':{'id':_0x1afa7d[_0x4617aa(0x12a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4c739b){console['log']('ðŸ“ˆ\x20Found\x20payment\x20link\x20'+_0x4c739b['id']+_0x4617aa(0x145)+_0x4c739b[_0x4617aa(0xe9)]+_0x4617aa(0x11e)+_0x4c739b['currentPayments']+_0x4617aa(0xed)+_0x4c739b[_0x4617aa(0x15b)]);const _0x1f2475=_0x4c739b[_0x4617aa(0x13f)]+0x1,_0xdde77=_0x4c739b['type']==='SINGLE'?_0x4617aa(0x111):_0x4c739b[_0x4617aa(0x15b)];await _0x5f19e5[_0x4617aa(0x143)]['update']({'where':{'id':_0x1afa7d['paymentLinkId']},'data':{'currentPayments':_0x1f2475,'status':_0xdde77,'updatedAt':new Date()}}),console[_0x4617aa(0xfd)](_0x4617aa(0x108)+_0x4c739b['id']+_0x4617aa(0x13e)+_0x4c739b[_0x4617aa(0x13f)]+_0x4617aa(0x132)+_0x1f2475+',\x20status='+_0x4c739b[_0x4617aa(0x15b)]+_0x4617aa(0x132)+_0xdde77);}else console[_0x4617aa(0xfd)](_0x4617aa(0xec)+_0x1afa7d[_0x4617aa(0x12a)]+_0x4617aa(0x11d));});}catch(_0xaed6f0){console['error'](_0xeb1c3e(0x12b),_0xaed6f0);}}await database_1[_0xeb1c3e(0x14e)][_0xeb1c3e(0xfe)][_0xeb1c3e(0x115)]({'data':{'paymentId':_0x1afa7d['id'],'shopId':_0x1afa7d[_0xeb1c3e(0x11b)],'event':_0xeb1c3e(0x100)+_0x4c22ba[_0xeb1c3e(0x15b)][_0xeb1c3e(0x114)](),'statusCode':0xc8,'responseBody':JSON[_0xeb1c3e(0x158)]({'oldStatus':_0xeb1c3e(0xeb),'newStatus':_0x4c22ba[_0xeb1c3e(0x15b)],'transactionId':_0x4c22ba[_0xeb1c3e(0x12d)],'failureReason':_0x4c22ba[_0xeb1c3e(0x121)],'processedAt':new Date()['toISOString']()})}}),await this[_0xeb1c3e(0x146)](_0x1afa7d,_0x4c22ba[_0xeb1c3e(0x15b)],_0x4c22ba[_0xeb1c3e(0x12d)],_0x4c22ba[_0xeb1c3e(0x121)]),await this[_0xeb1c3e(0x12f)](_0x1afa7d,_0x4c22ba[_0xeb1c3e(0x15b)]),console[_0xeb1c3e(0xfd)](_0xeb1c3e(0x15e)+_0x137d32+_0xeb1c3e(0x15d)+_0x4c22ba['status']),_0x4c22ba[_0xeb1c3e(0x15b)]===_0xeb1c3e(0x13d)?_0x4dee11[_0xeb1c3e(0x129)]({'success':!![],'message':_0xeb1c3e(0x13b),'result':{'status':_0xeb1c3e(0x13d),'transactionId':_0x4c22ba[_0xeb1c3e(0x12d)],'redirectUrl':_0x1afa7d['successUrl']}}):_0x4dee11['status'](0x190)['json']({'success':![],'message':_0xeb1c3e(0x116),'result':{'status':'FAILED','failureReason':_0x4c22ba[_0xeb1c3e(0x121)],'redirectUrl':_0x1afa7d['failUrl']}});}catch(_0x148d47){_0x1f4eec(_0x148d47);}},this[_0x34353e(0x117)]=new testGatewayService_1['TestGatewayService'](),this[_0x34353e(0x125)]=new webhookService_1['WebhookService']();}async[a19_0x264d8b(0x146)](_0xcd16d7,_0x3b6d06,_0x49e977,_0x55cea1){const _0x12b47b=a19_0x264d8b,_0x2550e8=Date[_0x12b47b(0x119)]();try{const _0x2ec38c=_0xcd16d7['shop'],_0x4e35e3=_0x2ec38c['settings'];if(!_0x4e35e3?.[_0x12b47b(0xff)]){console[_0x12b47b(0xfd)](_0x12b47b(0x128)+_0x2ec38c['id']);return;}const _0x39639f=_0x3b6d06===_0x12b47b(0x13d)?_0x12b47b(0x10c):_0x12b47b(0x10d);let _0x2cdff5=[];if(_0x4e35e3[_0x12b47b(0x14a)])try{_0x2cdff5=Array[_0x12b47b(0x154)](_0x4e35e3[_0x12b47b(0x14a)])?_0x4e35e3[_0x12b47b(0x14a)]:JSON[_0x12b47b(0x138)](_0x4e35e3[_0x12b47b(0x14a)]);}catch(_0x1bb846){console['error']('Error\x20parsing\x20webhook\x20events:',_0x1bb846),_0x2cdff5=[];}if(!_0x2cdff5[_0x12b47b(0x133)](_0x39639f)){console[_0x12b47b(0xfd)](_0x12b47b(0x109)+_0x39639f+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2ec38c['id']);return;}const _0x64aedc={'event':_0x39639f,'payment':{'id':_0xcd16d7['id'],'order_id':_0xcd16d7[_0x12b47b(0x10f)],'gateway_order_id':_0xcd16d7[_0x12b47b(0x123)],'gateway':_0x12b47b(0xf4),'amount':_0xcd16d7[_0x12b47b(0x13a)],'currency':_0xcd16d7['currency'],'status':_0x3b6d06[_0x12b47b(0x114)](),'customer_email':_0xcd16d7[_0x12b47b(0x156)],'customer_name':_0xcd16d7[_0x12b47b(0x106)],'transaction_id':_0x49e977,'failure_message':_0x55cea1,'created_at':_0xcd16d7[_0x12b47b(0xf7)],'updated_at':new Date()}},_0x562a16=await fetch(_0x4e35e3[_0x12b47b(0xff)],{'method':_0x12b47b(0xe8),'headers':{'Content-Type':_0x12b47b(0x107),'User-Agent':_0x12b47b(0x15a)},'body':JSON[_0x12b47b(0x158)](_0x64aedc)}),_0x19b2b8=Date[_0x12b47b(0x119)]()-_0x2550e8;console[_0x12b47b(0xfd)](_0x12b47b(0x120)+_0x4e35e3[_0x12b47b(0xff)]+'\x20with\x20status\x20'+_0x562a16[_0x12b47b(0x15b)]+'\x20('+_0x19b2b8+_0x12b47b(0x110));}catch(_0x8e1ca8){console[_0x12b47b(0x155)](_0x12b47b(0x118),_0x8e1ca8);}}async['sendPaymentStatusNotification'](_0x5d981c,_0x5cf048){const _0xc60876=a19_0x264d8b;try{const {telegramBotService:_0x195083}=await Promise[_0xc60876(0xf8)]()[_0xc60876(0x15c)](()=>__importStar(require(_0xc60876(0xea)))),_0x397759={'PAID':'paid','FAILED':_0xc60876(0x148)},_0x3dcbf9=_0x397759[_0x5cf048];if(!_0x3dcbf9)return;await _0x195083[_0xc60876(0x153)](_0x5d981c['shopId'],_0x5d981c,_0x3dcbf9);}catch(_0x552420){console[_0xc60876(0x155)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x552420);}}}exports['TestGatewayController']=TestGatewayController;