'use strict';const a13_0x56eb54=a13_0x5d76;function a13_0x4e6b(){const _0x2ecc6e=['326433ohrcrr','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','currentPayments','Test\x20Gateway\x20webhook\x20sent\x20to\x20','now','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PAID','processCard',',\x20status=','0000','name','Payment\x20processed\x20successfully','sendPaymentStatusNotification','paidAt','Any\x20future\x20date\x20(MM/YY)','‚úÖ\x20Test\x20Gateway\x20payment\x20','2889736JqEUAu','__setModuleDefault','stringify','POST','Payment\x20to\x20','‚ùå\x20Payment\x20link\x20','üß™\x20Test\x20Gateway\x20result:','toLowerCase','orderId','Payment\x20status\x20is\x20','paid','Payment\x20failed','resolve',',\x20currentPayments=','writable','Error\x20parsing\x20webhook\x20events:','\x20updated:\x20currentPayments=','findUnique','json','shop','defineProperty','WebhookService','2839653VrTzNF','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importStar','gatewayPaymentId','gatewayOrderId','254444jIEMOM','create','7CPfTPm','isArray','üìà\x20Test\x20Gateway:\x20Payment\x20','cardNumber','application/json','Payment\x20is\x20not\x20for\x20test\x20gateway','TestGatewayController','\x20->\x20','../services/webhookService','status','ms)','parse','Payment\x20not\x20found','payment','failureReason','\x20not\x20found','300342ClWLOP','slice','25EnpeZh','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','includes','webhookUrl','TestGatewayService','error','body','testGatewayService','webhookLog','__esModule','PENDING','cardLast4','sendShopWebhook','test_gateway_',':\x20type=','FAILED','currency','then','shopId','__importDefault','paymentLink','amount','Webhook\x20event\x20','webhookEvents','toISOString','transactionId','paymentLinkId','gateway','successUrl','620504izIYCN','log','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','update','üìà\x20Found\x20payment\x20link\x20','type','\x20not\x20enabled\x20for\x20shop\x20','8463640pNqOKA','18DkGLYk','customerName','customerEmail','default','Any\x203-4\x20digits',',\x20cannot\x20process','getPaymentForm','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','__createBinding','length','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:'];a13_0x4e6b=function(){return _0x2ecc6e;};return a13_0x4e6b();}(function(_0x3ec08c,_0x3b4b67){const _0x5703d3=a13_0x5d76,_0x404fad=_0x3ec08c();while(!![]){try{const _0x58dd1f=-parseInt(_0x5703d3(0x1ad))/0x1+parseInt(_0x5703d3(0x19a))/0x2+parseInt(_0x5703d3(0x1a2))/0x3*(parseInt(_0x5703d3(0x169))/0x4)+parseInt(_0x5703d3(0x17d))/0x5*(-parseInt(_0x5703d3(0x17b))/0x6)+parseInt(_0x5703d3(0x16b))/0x7*(-parseInt(_0x5703d3(0x1bd))/0x8)+-parseInt(_0x5703d3(0x1d3))/0x9+parseInt(_0x5703d3(0x1a1))/0xa;if(_0x58dd1f===_0x3b4b67)break;else _0x404fad['push'](_0x404fad['shift']());}catch(_0x37c9b8){_0x404fad['push'](_0x404fad['shift']());}}}(a13_0x4e6b,0x4589e));var __createBinding=this&&this[a13_0x56eb54(0x1aa)]||(Object[a13_0x56eb54(0x16a)]?function(_0x5bb95d,_0x376573,_0x1a6456,_0x5dbef8){const _0x15eba6=a13_0x56eb54;if(_0x5dbef8===undefined)_0x5dbef8=_0x1a6456;var _0x4238bd=Object['getOwnPropertyDescriptor'](_0x376573,_0x1a6456);(!_0x4238bd||('get'in _0x4238bd?!_0x376573[_0x15eba6(0x186)]:_0x4238bd[_0x15eba6(0x1cb)]||_0x4238bd['configurable']))&&(_0x4238bd={'enumerable':!![],'get':function(){return _0x376573[_0x1a6456];}}),Object[_0x15eba6(0x1d1)](_0x5bb95d,_0x5dbef8,_0x4238bd);}:function(_0x14e276,_0x550211,_0x2bddff,_0x3ddd19){if(_0x3ddd19===undefined)_0x3ddd19=_0x2bddff;_0x14e276[_0x3ddd19]=_0x550211[_0x2bddff];}),__setModuleDefault=this&&this[a13_0x56eb54(0x1be)]||(Object[a13_0x56eb54(0x16a)]?function(_0x15a3ef,_0x925c8b){const _0xef26d3=a13_0x56eb54;Object[_0xef26d3(0x1d1)](_0x15a3ef,_0xef26d3(0x1a5),{'enumerable':!![],'value':_0x925c8b});}:function(_0x4a2ce0,_0x2b9ab4){const _0x1c34d2=a13_0x56eb54;_0x4a2ce0[_0x1c34d2(0x1a5)]=_0x2b9ab4;}),__importStar=this&&this[a13_0x56eb54(0x1d5)]||(function(){var _0xb99d54=function(_0x318374){return _0xb99d54=Object['getOwnPropertyNames']||function(_0x3303f7){const _0x38f7a1=a13_0x5d76;var _0x4de951=[];for(var _0x1e93ae in _0x3303f7)if(Object['prototype']['hasOwnProperty']['call'](_0x3303f7,_0x1e93ae))_0x4de951[_0x4de951[_0x38f7a1(0x1ab)]]=_0x1e93ae;return _0x4de951;},_0xb99d54(_0x318374);};return function(_0x4fa9c8){const _0x314960=a13_0x5d76;if(_0x4fa9c8&&_0x4fa9c8[_0x314960(0x186)])return _0x4fa9c8;var _0x463588={};if(_0x4fa9c8!=null){for(var _0x5a701b=_0xb99d54(_0x4fa9c8),_0x3ee04d=0x0;_0x3ee04d<_0x5a701b[_0x314960(0x1ab)];_0x3ee04d++)if(_0x5a701b[_0x3ee04d]!=='default')__createBinding(_0x463588,_0x4fa9c8,_0x5a701b[_0x3ee04d]);}return __setModuleDefault(_0x463588,_0x4fa9c8),_0x463588;};}()),__importDefault=this&&this[a13_0x56eb54(0x190)]||function(_0x5203ba){return _0x5203ba&&_0x5203ba['__esModule']?_0x5203ba:{'default':_0x5203ba};};Object[a13_0x56eb54(0x1d1)](exports,a13_0x56eb54(0x186),{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x5d76(_0x441c9c,_0x5723e0){const _0x4e6b37=a13_0x4e6b();return a13_0x5d76=function(_0x5d76aa,_0x50c3c7){_0x5d76aa=_0x5d76aa-0x168;let _0x4d8a82=_0x4e6b37[_0x5d76aa];return _0x4d8a82;},a13_0x5d76(_0x441c9c,_0x5723e0);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x56eb54(0x173)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1721ae=a13_0x56eb54;this[_0x1721ae(0x1a8)]=async(_0x51f27e,_0x55cbe1,_0x3d3538)=>{const _0x1b3f6e=_0x1721ae;try{const {paymentId:_0x1a0c26}=_0x51f27e['params'];console[_0x1b3f6e(0x19b)](_0x1b3f6e(0x1ae)+_0x1a0c26);const _0x210527=await database_1[_0x1b3f6e(0x1a5)][_0x1b3f6e(0x178)][_0x1b3f6e(0x1ce)]({'where':{'id':_0x1a0c26},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x210527)return _0x55cbe1[_0x1b3f6e(0x174)](0x194)[_0x1b3f6e(0x1cf)]({'success':![],'message':_0x1b3f6e(0x177)});if(_0x210527[_0x1b3f6e(0x198)]!=='test_gateway')return _0x55cbe1['status'](0x190)[_0x1b3f6e(0x1cf)]({'success':![],'message':_0x1b3f6e(0x170)});if(_0x210527['status']!=='PENDING')return _0x55cbe1[_0x1b3f6e(0x174)](0x190)[_0x1b3f6e(0x1cf)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x210527[_0x1b3f6e(0x174)]+_0x1b3f6e(0x1a7)});_0x55cbe1['json']({'success':!![],'result':{'paymentId':_0x210527['id'],'orderId':_0x210527[_0x1b3f6e(0x168)],'amount':_0x210527[_0x1b3f6e(0x192)],'currency':_0x210527['currency'],'merchantName':_0x210527[_0x1b3f6e(0x1d0)][_0x1b3f6e(0x1b7)],'description':_0x1b3f6e(0x1c1)+_0x210527['shop'][_0x1b3f6e(0x1b7)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x1b3f6e(0x1bb),'cvc':_0x1b3f6e(0x1a6),'holderName':'Any\x20name'}}});}catch(_0x37d5fc){_0x3d3538(_0x37d5fc);}},this[_0x1721ae(0x1b4)]=async(_0x49436f,_0x1b08b3,_0x2f9e0c)=>{const _0x1b77ff=_0x1721ae;try{const {paymentId:_0x2e1e10}=_0x49436f['params'],_0x3d0bbd=_0x49436f[_0x1b77ff(0x183)];console[_0x1b77ff(0x19b)](_0x1b77ff(0x1d4)+_0x2e1e10);const _0x95f64=await database_1['default']['payment'][_0x1b77ff(0x1ce)]({'where':{'id':_0x2e1e10},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x95f64)return _0x1b08b3[_0x1b77ff(0x174)](0x194)[_0x1b77ff(0x1cf)]({'success':![],'message':_0x1b77ff(0x177)});if(_0x95f64[_0x1b77ff(0x198)]!=='test_gateway')return _0x1b08b3[_0x1b77ff(0x174)](0x190)[_0x1b77ff(0x1cf)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x95f64[_0x1b77ff(0x174)]!==_0x1b77ff(0x187))return _0x1b08b3[_0x1b77ff(0x174)](0x190)[_0x1b77ff(0x1cf)]({'success':![],'message':_0x1b77ff(0x1c6)+_0x95f64[_0x1b77ff(0x174)]+_0x1b77ff(0x1a7)});const _0x583529=await this[_0x1b77ff(0x184)]['processCardPayment']({'paymentId':_0x95f64['id'],'orderId':_0x95f64[_0x1b77ff(0x168)]||_0x95f64['id'],'amount':_0x95f64['amount'],'currency':_0x95f64[_0x1b77ff(0x18d)],'cardData':_0x3d0bbd});console['log'](_0x1b77ff(0x1c3),_0x583529);const _0x4a07db={'status':_0x583529[_0x1b77ff(0x174)],'updatedAt':new Date()};if(_0x583529[_0x1b77ff(0x174)]===_0x1b77ff(0x1b3))_0x4a07db[_0x1b77ff(0x1ba)]=new Date(),_0x4a07db[_0x1b77ff(0x1d6)]=_0x583529[_0x1b77ff(0x196)];else _0x583529['status']===_0x1b77ff(0x18c)&&(_0x4a07db['failureMessage']=_0x583529[_0x1b77ff(0x179)]);const _0x53f027=_0x3d0bbd[_0x1b77ff(0x16e)]['replace'](/[\s-]/g,'');_0x4a07db[_0x1b77ff(0x188)]=_0x53f027[_0x1b77ff(0x17c)](-0x4),_0x4a07db['paymentMethod']='test_card',await database_1['default'][_0x1b77ff(0x178)]['update']({'where':{'id':_0x95f64['id']},'data':_0x4a07db});if(_0x583529[_0x1b77ff(0x174)]===_0x1b77ff(0x1b3)&&_0x95f64[_0x1b77ff(0x197)]){console[_0x1b77ff(0x19b)](_0x1b77ff(0x16d)+_0x95f64['id']+_0x1b77ff(0x1a9));try{await database_1[_0x1b77ff(0x1a5)]['$transaction'](async _0x265249=>{const _0x249e9a=_0x1b77ff,_0xe952cc=await _0x265249[_0x249e9a(0x191)][_0x249e9a(0x1ce)]({'where':{'id':_0x95f64[_0x249e9a(0x197)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xe952cc){console['log'](_0x249e9a(0x19e)+_0xe952cc['id']+_0x249e9a(0x18b)+_0xe952cc[_0x249e9a(0x19f)]+_0x249e9a(0x1ca)+_0xe952cc[_0x249e9a(0x1af)]+',\x20status='+_0xe952cc[_0x249e9a(0x174)]);const _0x1707da=_0xe952cc[_0x249e9a(0x1af)]+0x1,_0x1ebd3e=_0xe952cc[_0x249e9a(0x19f)]==='SINGLE'?'COMPLETED':_0xe952cc[_0x249e9a(0x174)];await _0x265249[_0x249e9a(0x191)][_0x249e9a(0x19d)]({'where':{'id':_0x95f64[_0x249e9a(0x197)]},'data':{'currentPayments':_0x1707da,'status':_0x1ebd3e,'updatedAt':new Date()}}),console[_0x249e9a(0x19b)]('‚úÖ\x20Payment\x20link\x20'+_0xe952cc['id']+_0x249e9a(0x1cd)+_0xe952cc[_0x249e9a(0x1af)]+_0x249e9a(0x172)+_0x1707da+_0x249e9a(0x1b5)+_0xe952cc[_0x249e9a(0x174)]+_0x249e9a(0x172)+_0x1ebd3e);}else console['log'](_0x249e9a(0x1c2)+_0x95f64[_0x249e9a(0x197)]+_0x249e9a(0x17a));});}catch(_0x49e73f){console[_0x1b77ff(0x182)](_0x1b77ff(0x1ac),_0x49e73f);}}await database_1[_0x1b77ff(0x1a5)][_0x1b77ff(0x185)][_0x1b77ff(0x16a)]({'data':{'paymentId':_0x95f64['id'],'shopId':_0x95f64[_0x1b77ff(0x18f)],'event':_0x1b77ff(0x18a)+_0x583529[_0x1b77ff(0x174)][_0x1b77ff(0x1c4)](),'statusCode':0xc8,'responseBody':JSON[_0x1b77ff(0x1bf)]({'oldStatus':_0x1b77ff(0x187),'newStatus':_0x583529[_0x1b77ff(0x174)],'transactionId':_0x583529[_0x1b77ff(0x196)],'failureReason':_0x583529[_0x1b77ff(0x179)],'processedAt':new Date()[_0x1b77ff(0x195)]()})}}),await this[_0x1b77ff(0x189)](_0x95f64,_0x583529[_0x1b77ff(0x174)],_0x583529[_0x1b77ff(0x196)],_0x583529[_0x1b77ff(0x179)]),await this[_0x1b77ff(0x1b9)](_0x95f64,_0x583529[_0x1b77ff(0x174)]),console[_0x1b77ff(0x19b)](_0x1b77ff(0x1bc)+_0x2e1e10+'\x20processed:\x20'+_0x583529[_0x1b77ff(0x174)]),_0x583529[_0x1b77ff(0x174)]==='PAID'?_0x1b08b3[_0x1b77ff(0x1cf)]({'success':!![],'message':_0x1b77ff(0x1b8),'result':{'status':_0x1b77ff(0x1b3),'transactionId':_0x583529['transactionId'],'redirectUrl':_0x95f64[_0x1b77ff(0x199)]}}):_0x1b08b3[_0x1b77ff(0x174)](0x190)[_0x1b77ff(0x1cf)]({'success':![],'message':_0x1b77ff(0x1c8),'result':{'status':_0x1b77ff(0x18c),'failureReason':_0x583529[_0x1b77ff(0x179)],'redirectUrl':_0x95f64['failUrl']}});}catch(_0x166ef4){_0x2f9e0c(_0x166ef4);}},this[_0x1721ae(0x184)]=new testGatewayService_1[(_0x1721ae(0x181))](),this['webhookService']=new webhookService_1[(_0x1721ae(0x1d2))]();}async[a13_0x56eb54(0x189)](_0x151c1b,_0x5c1cd3,_0x3fcd99,_0x31fc14){const _0x1dae18=a13_0x56eb54,_0x20e267=Date[_0x1dae18(0x1b1)]();try{const _0xfe5648=_0x151c1b['shop'],_0x39fc68=_0xfe5648['settings'];if(!_0x39fc68?.[_0x1dae18(0x180)]){console[_0x1dae18(0x19b)](_0x1dae18(0x1b2)+_0xfe5648['id']);return;}const _0x50c584=_0x5c1cd3==='PAID'?'payment.success':'payment.failed';let _0x5ed64b=[];if(_0x39fc68['webhookEvents'])try{_0x5ed64b=Array[_0x1dae18(0x16c)](_0x39fc68[_0x1dae18(0x194)])?_0x39fc68[_0x1dae18(0x194)]:JSON[_0x1dae18(0x176)](_0x39fc68[_0x1dae18(0x194)]);}catch(_0x37174a){console[_0x1dae18(0x182)](_0x1dae18(0x1cc),_0x37174a),_0x5ed64b=[];}if(!_0x5ed64b[_0x1dae18(0x17f)](_0x50c584)){console[_0x1dae18(0x19b)](_0x1dae18(0x193)+_0x50c584+_0x1dae18(0x1a0)+_0xfe5648['id']);return;}const _0x1231bb={'event':_0x50c584,'payment':{'id':_0x151c1b['id'],'order_id':_0x151c1b[_0x1dae18(0x1c5)],'gateway_order_id':_0x151c1b['gatewayOrderId'],'gateway':_0x1dae18(0x1b6),'amount':_0x151c1b[_0x1dae18(0x192)],'currency':_0x151c1b[_0x1dae18(0x18d)],'status':_0x5c1cd3['toLowerCase'](),'customer_email':_0x151c1b[_0x1dae18(0x1a4)],'customer_name':_0x151c1b[_0x1dae18(0x1a3)],'transaction_id':_0x3fcd99,'failure_message':_0x31fc14,'created_at':_0x151c1b['createdAt'],'updated_at':new Date()}},_0x408679=await fetch(_0x39fc68[_0x1dae18(0x180)],{'method':_0x1dae18(0x1c0),'headers':{'Content-Type':_0x1dae18(0x16f),'User-Agent':_0x1dae18(0x19c)},'body':JSON[_0x1dae18(0x1bf)](_0x1231bb)}),_0x50df3d=Date[_0x1dae18(0x1b1)]()-_0x20e267;console[_0x1dae18(0x19b)](_0x1dae18(0x1b0)+_0x39fc68[_0x1dae18(0x180)]+'\x20with\x20status\x20'+_0x408679[_0x1dae18(0x174)]+'\x20('+_0x50df3d+_0x1dae18(0x175));}catch(_0xe62f6a){console[_0x1dae18(0x182)](_0x1dae18(0x17e),_0xe62f6a);}}async['sendPaymentStatusNotification'](_0x10c680,_0xd6ba43){const _0x1e05be=a13_0x56eb54;try{const {telegramBotService:_0x250e5d}=await Promise[_0x1e05be(0x1c9)]()[_0x1e05be(0x18e)](()=>__importStar(require('../services/telegramBotService'))),_0x3946bf={'PAID':_0x1e05be(0x1c7),'FAILED':'failed'},_0x5b81ef=_0x3946bf[_0xd6ba43];if(!_0x5b81ef)return;await _0x250e5d['sendPaymentNotification'](_0x10c680[_0x1e05be(0x18f)],_0x10c680,_0x5b81ef);}catch(_0x2140a5){console[_0x1e05be(0x182)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2140a5);}}}exports[a13_0x56eb54(0x171)]=TestGatewayController;