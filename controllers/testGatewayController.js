'use strict';const a13_0x2c2674=a13_0x37c3;(function(_0x5b2173,_0x3c3791){const _0x47e706=a13_0x37c3,_0x3d572d=_0x5b2173();while(!![]){try{const _0x114461=parseInt(_0x47e706(0x120))/0x1*(-parseInt(_0x47e706(0xfa))/0x2)+-parseInt(_0x47e706(0x127))/0x3*(-parseInt(_0x47e706(0x133))/0x4)+-parseInt(_0x47e706(0x134))/0x5+parseInt(_0x47e706(0x123))/0x6*(-parseInt(_0x47e706(0x141))/0x7)+-parseInt(_0x47e706(0xf6))/0x8+-parseInt(_0x47e706(0x10c))/0x9+-parseInt(_0x47e706(0xea))/0xa*(-parseInt(_0x47e706(0x109))/0xb);if(_0x114461===_0x3c3791)break;else _0x3d572d['push'](_0x3d572d['shift']());}catch(_0x378964){_0x3d572d['push'](_0x3d572d['shift']());}}}(a13_0x22fc,0xa759d));var __createBinding=this&&this[a13_0x2c2674(0xf5)]||(Object[a13_0x2c2674(0xeb)]?function(_0x2de8ec,_0x1b4e30,_0xcb7466,_0x1dd2a5){const _0x44a812=a13_0x2c2674;if(_0x1dd2a5===undefined)_0x1dd2a5=_0xcb7466;var _0xc65bd2=Object[_0x44a812(0xfd)](_0x1b4e30,_0xcb7466);(!_0xc65bd2||(_0x44a812(0x108)in _0xc65bd2?!_0x1b4e30[_0x44a812(0x118)]:_0xc65bd2[_0x44a812(0x14e)]||_0xc65bd2[_0x44a812(0xf2)]))&&(_0xc65bd2={'enumerable':!![],'get':function(){return _0x1b4e30[_0xcb7466];}}),Object[_0x44a812(0x110)](_0x2de8ec,_0x1dd2a5,_0xc65bd2);}:function(_0x675478,_0x4fe4bc,_0x5a4149,_0x1825f5){if(_0x1825f5===undefined)_0x1825f5=_0x5a4149;_0x675478[_0x1825f5]=_0x4fe4bc[_0x5a4149];}),__setModuleDefault=this&&this[a13_0x2c2674(0xf7)]||(Object[a13_0x2c2674(0xeb)]?function(_0x4b54f4,_0x1689a3){const _0x3285da=a13_0x2c2674;Object[_0x3285da(0x110)](_0x4b54f4,'default',{'enumerable':!![],'value':_0x1689a3});}:function(_0x698b88,_0x283285){const _0x34f397=a13_0x2c2674;_0x698b88[_0x34f397(0x143)]=_0x283285;}),__importStar=this&&this[a13_0x2c2674(0x146)]||(function(){var _0x3b05ca=function(_0x4065b3){return _0x3b05ca=Object['getOwnPropertyNames']||function(_0x2d3aa5){const _0x198aa4=a13_0x37c3;var _0x4ad32a=[];for(var _0x33529 in _0x2d3aa5)if(Object[_0x198aa4(0x124)][_0x198aa4(0x107)][_0x198aa4(0xfb)](_0x2d3aa5,_0x33529))_0x4ad32a[_0x4ad32a['length']]=_0x33529;return _0x4ad32a;},_0x3b05ca(_0x4065b3);};return function(_0x2b9af8){const _0x3f8ece=a13_0x37c3;if(_0x2b9af8&&_0x2b9af8[_0x3f8ece(0x118)])return _0x2b9af8;var _0x538e97={};if(_0x2b9af8!=null){for(var _0x483755=_0x3b05ca(_0x2b9af8),_0x3b8075=0x0;_0x3b8075<_0x483755[_0x3f8ece(0x122)];_0x3b8075++)if(_0x483755[_0x3b8075]!==_0x3f8ece(0x143))__createBinding(_0x538e97,_0x2b9af8,_0x483755[_0x3b8075]);}return __setModuleDefault(_0x538e97,_0x2b9af8),_0x538e97;};}()),__importDefault=this&&this[a13_0x2c2674(0xe7)]||function(_0x53950a){const _0x4b1c0d=a13_0x2c2674;return _0x53950a&&_0x53950a[_0x4b1c0d(0x118)]?_0x53950a:{'default':_0x53950a};};Object['defineProperty'](exports,a13_0x2c2674(0x118),{'value':!![]}),exports[a13_0x2c2674(0x102)]=void 0x0;function a13_0x37c3(_0x46f377,_0x5e122e){const _0x22fccb=a13_0x22fc();return a13_0x37c3=function(_0x37c33c,_0x2900fb){_0x37c33c=_0x37c33c-0xe5;let _0x117070=_0x22fccb[_0x37c33c];return _0x117070;},a13_0x37c3(_0x46f377,_0x5e122e);}const testGatewayService_1=require(a13_0x2c2674(0xf9)),webhookService_1=require(a13_0x2c2674(0x125)),database_1=__importDefault(require(a13_0x2c2674(0x100)));class TestGatewayController{constructor(){const _0x187267=a13_0x2c2674;this['getPaymentForm']=async(_0x19edc0,_0x3dfd5f,_0x3f81ca)=>{const _0x178bad=a13_0x37c3;try{const {paymentId:_0x2802f3}=_0x19edc0['params'];console[_0x178bad(0x12a)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2802f3);const _0x43fd0e=await database_1['default'][_0x178bad(0x117)][_0x178bad(0x114)]({'where':{'id':_0x2802f3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x43fd0e)return _0x3dfd5f[_0x178bad(0x135)](0x194)[_0x178bad(0x12d)]({'success':![],'message':_0x178bad(0x115)});if(_0x43fd0e[_0x178bad(0x103)]!==_0x178bad(0x128))return _0x3dfd5f[_0x178bad(0x135)](0x190)[_0x178bad(0x12d)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x43fd0e[_0x178bad(0x135)]!==_0x178bad(0x148))return _0x3dfd5f[_0x178bad(0x135)](0x190)[_0x178bad(0x12d)]({'success':![],'message':_0x178bad(0x13b)+_0x43fd0e[_0x178bad(0x135)]+_0x178bad(0x116)});_0x3dfd5f[_0x178bad(0x12d)]({'success':!![],'result':{'paymentId':_0x43fd0e['id'],'orderId':_0x43fd0e[_0x178bad(0x12c)],'amount':_0x43fd0e[_0x178bad(0xe6)],'currency':_0x43fd0e[_0x178bad(0x101)],'merchantName':_0x43fd0e[_0x178bad(0x138)][_0x178bad(0x13e)],'description':_0x178bad(0x14d)+_0x43fd0e[_0x178bad(0x138)]['name'],'testInstructions':{'successCard':_0x178bad(0x13f),'failureCard':_0x178bad(0x113),'expiryDate':_0x178bad(0x10d),'cvc':_0x178bad(0x11e),'holderName':'Any\x20name'}}});}catch(_0x305bfe){_0x3f81ca(_0x305bfe);}},this[_0x187267(0xf0)]=async(_0x2998ba,_0x1985de,_0x234d8c)=>{const _0x4038b8=_0x187267;try{const {paymentId:_0x558983}=_0x2998ba[_0x4038b8(0x14c)],_0x3a8097=_0x2998ba['body'];console[_0x4038b8(0x12a)](_0x4038b8(0x14b)+_0x558983);const _0x29607e=await database_1['default']['payment'][_0x4038b8(0x114)]({'where':{'id':_0x558983},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29607e)return _0x1985de[_0x4038b8(0x135)](0x194)[_0x4038b8(0x12d)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x29607e['gateway']!==_0x4038b8(0x128))return _0x1985de[_0x4038b8(0x135)](0x190)[_0x4038b8(0x12d)]({'success':![],'message':_0x4038b8(0x126)});if(_0x29607e['status']!==_0x4038b8(0x148))return _0x1985de[_0x4038b8(0x135)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x29607e['status']+',\x20cannot\x20process'});const _0x128d1c=await this[_0x4038b8(0x11a)][_0x4038b8(0x12e)]({'paymentId':_0x29607e['id'],'orderId':_0x29607e[_0x4038b8(0x12c)]||_0x29607e['id'],'amount':_0x29607e[_0x4038b8(0xe6)],'currency':_0x29607e[_0x4038b8(0x101)],'cardData':_0x3a8097});console[_0x4038b8(0x12a)](_0x4038b8(0xed),_0x128d1c);const _0x472cdf={'status':_0x128d1c['status'],'updatedAt':new Date()};if(_0x128d1c[_0x4038b8(0x135)]===_0x4038b8(0xff))_0x472cdf[_0x4038b8(0x13a)]=new Date(),_0x472cdf['gatewayPaymentId']=_0x128d1c[_0x4038b8(0x13c)];else _0x128d1c['status']===_0x4038b8(0x10b)&&(_0x472cdf[_0x4038b8(0x12f)]=_0x128d1c['failureReason']);const _0x4b8077=_0x3a8097[_0x4038b8(0x121)][_0x4038b8(0xe5)](/[\s-]/g,'');_0x472cdf[_0x4038b8(0x149)]=_0x4b8077[_0x4038b8(0xec)](-0x4),_0x472cdf['paymentMethod']='test_card',await database_1['default']['payment'][_0x4038b8(0xf3)]({'where':{'id':_0x29607e['id']},'data':_0x472cdf}),await database_1[_0x4038b8(0x143)]['webhookLog'][_0x4038b8(0xeb)]({'data':{'paymentId':_0x29607e['id'],'shopId':_0x29607e[_0x4038b8(0x14f)],'event':_0x4038b8(0x136)+_0x128d1c['status'][_0x4038b8(0xee)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x4038b8(0x148),'newStatus':_0x128d1c[_0x4038b8(0x135)],'transactionId':_0x128d1c[_0x4038b8(0x13c)],'failureReason':_0x128d1c[_0x4038b8(0x130)],'processedAt':new Date()['toISOString']()})}}),await this[_0x4038b8(0x10a)](_0x29607e,_0x128d1c['status'],_0x128d1c[_0x4038b8(0x13c)],_0x128d1c[_0x4038b8(0x130)]),await this[_0x4038b8(0x140)](_0x29607e,_0x128d1c[_0x4038b8(0x135)]),console[_0x4038b8(0x12a)](_0x4038b8(0x14a)+_0x558983+_0x4038b8(0x150)+_0x128d1c[_0x4038b8(0x135)]),_0x128d1c[_0x4038b8(0x135)]===_0x4038b8(0xff)?_0x1985de[_0x4038b8(0x12d)]({'success':!![],'message':_0x4038b8(0x119),'result':{'status':'PAID','transactionId':_0x128d1c[_0x4038b8(0x13c)],'redirectUrl':_0x29607e[_0x4038b8(0x145)]}}):_0x1985de['status'](0x190)['json']({'success':![],'message':_0x4038b8(0xfc),'result':{'status':_0x4038b8(0x10b),'failureReason':_0x128d1c[_0x4038b8(0x130)],'redirectUrl':_0x29607e[_0x4038b8(0x152)]}});}catch(_0x361bf5){_0x234d8c(_0x361bf5);}},this[_0x187267(0x11a)]=new testGatewayService_1[(_0x187267(0x137))](),this['webhookService']=new webhookService_1[(_0x187267(0x111))]();}async[a13_0x2c2674(0x10a)](_0x1b1c4e,_0x12dca4,_0x1535d2,_0x297ab8){const _0x5a0b6f=a13_0x2c2674,_0x1eb8a7=Date[_0x5a0b6f(0x129)]();try{const _0x4ad9db=_0x1b1c4e[_0x5a0b6f(0x138)],_0x41f783=_0x4ad9db[_0x5a0b6f(0x12b)];if(!_0x41f783?.['webhookUrl']){console[_0x5a0b6f(0x12a)](_0x5a0b6f(0xf4)+_0x4ad9db['id']);return;}const _0x33f5da=_0x12dca4===_0x5a0b6f(0xff)?_0x5a0b6f(0x142):_0x5a0b6f(0xe9);let _0x4d5139=[];if(_0x41f783[_0x5a0b6f(0x10f)])try{_0x4d5139=Array[_0x5a0b6f(0xf8)](_0x41f783[_0x5a0b6f(0x10f)])?_0x41f783[_0x5a0b6f(0x10f)]:JSON[_0x5a0b6f(0xfe)](_0x41f783[_0x5a0b6f(0x10f)]);}catch(_0x43719e){console[_0x5a0b6f(0x11f)](_0x5a0b6f(0x104),_0x43719e),_0x4d5139=[];}if(!_0x4d5139[_0x5a0b6f(0xf1)](_0x33f5da)){console[_0x5a0b6f(0x12a)](_0x5a0b6f(0x132)+_0x33f5da+_0x5a0b6f(0x131)+_0x4ad9db['id']);return;}const _0x46ad06={'event':_0x33f5da,'payment':{'id':_0x1b1c4e['id'],'order_id':_0x1b1c4e[_0x5a0b6f(0x139)],'gateway_order_id':_0x1b1c4e['gatewayOrderId'],'gateway':_0x5a0b6f(0x11d),'amount':_0x1b1c4e[_0x5a0b6f(0xe6)],'currency':_0x1b1c4e[_0x5a0b6f(0x101)],'status':_0x12dca4['toLowerCase'](),'customer_email':_0x1b1c4e[_0x5a0b6f(0x11b)],'customer_name':_0x1b1c4e['customerName'],'transaction_id':_0x1535d2,'failure_message':_0x297ab8,'created_at':_0x1b1c4e[_0x5a0b6f(0x151)],'updated_at':new Date()}},_0x5b36a6=await fetch(_0x41f783[_0x5a0b6f(0x105)],{'method':_0x5a0b6f(0x144),'headers':{'Content-Type':_0x5a0b6f(0x11c),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x46ad06)}),_0x1d8824=Date['now']()-_0x1eb8a7;console['log'](_0x5a0b6f(0x106)+_0x41f783[_0x5a0b6f(0x105)]+'\x20with\x20status\x20'+_0x5b36a6[_0x5a0b6f(0x135)]+'\x20('+_0x1d8824+_0x5a0b6f(0xe8));}catch(_0x210943){console[_0x5a0b6f(0x11f)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x210943);}}async[a13_0x2c2674(0x140)](_0x5e6545,_0x141670){const _0x1246f1=a13_0x2c2674;try{const {telegramBotService:_0x1d6fd4}=await Promise[_0x1246f1(0x112)]()[_0x1246f1(0xef)](()=>__importStar(require(_0x1246f1(0x10e)))),_0x33b2f0={'PAID':_0x1246f1(0x13d),'FAILED':_0x1246f1(0x147)},_0x5a890e=_0x33b2f0[_0x141670];if(!_0x5a890e)return;await _0x1d6fd4[_0x1246f1(0x153)](_0x5e6545[_0x1246f1(0x14f)],_0x5e6545,_0x5a890e);}catch(_0x4b4dd4){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4b4dd4);}}}exports['TestGatewayController']=TestGatewayController;function a13_0x22fc(){const _0x2fb971=['failed','PENDING','cardLast4','âœ…\x20Test\x20Gateway\x20payment\x20','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','params','Payment\x20to\x20','writable','shopId','\x20processed:\x20','createdAt','failUrl','sendPaymentNotification','replace','amount','__importDefault','ms)','payment.failed','12170wpOgwP','create','slice','ðŸ§ª\x20Test\x20Gateway\x20result:','toLowerCase','then','processCard','includes','configurable','update','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__createBinding','8317888BrrYfj','__setModuleDefault','isArray','../services/gateways/testGatewayService','4904dXBFGR','call','Payment\x20failed','getOwnPropertyDescriptor','parse','PAID','../config/database','currency','TestGatewayController','gateway','Error\x20parsing\x20webhook\x20events:','webhookUrl','Test\x20Gateway\x20webhook\x20sent\x20to\x20','hasOwnProperty','get','33165blrwfL','sendShopWebhook','FAILED','6668397plEnEz','Any\x20future\x20date\x20(MM/YY)','../services/telegramBotService','webhookEvents','defineProperty','WebhookService','resolve','Any\x20other\x20card\x20number','findUnique','Payment\x20not\x20found',',\x20cannot\x20process','payment','__esModule','Payment\x20processed\x20successfully','testGatewayService','customerEmail','application/json','0000','Any\x203-4\x20digits','error','249RgEoUK','cardNumber','length','2503518SBkZPf','prototype','../services/webhookService','Payment\x20is\x20not\x20for\x20test\x20gateway','723RAFnQx','test_gateway','now','log','settings','gatewayOrderId','json','processCardPayment','failureMessage','failureReason','\x20not\x20enabled\x20for\x20shop\x20','Webhook\x20event\x20','19628pstCEA','4703250moSeqB','status','test_gateway_','TestGatewayService','shop','orderId','paidAt','Payment\x20status\x20is\x20','transactionId','paid','name','4242\x204242\x204242\x204242','sendPaymentStatusNotification','14pdlMvK','payment.success','default','POST','successUrl','__importStar'];a13_0x22fc=function(){return _0x2fb971;};return a13_0x22fc();}