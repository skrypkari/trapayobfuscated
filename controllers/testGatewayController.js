'use strict';const a13_0x1517b8=a13_0x3f6e;function a13_0x1deb(){const _0x5ba79e=['No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','transactionId','__esModule','stringify','webhookLog','__importDefault','test_card','defineProperty','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','create','json','Payment\x20processed\x20successfully','processCardPayment','failureReason','configurable','1443852BaNpvS','params','3960840Yjfgxz','0000','shop','log','payment','currency','webhookUrl','14917qTxWKF','sendShopWebhook','length','paidAt','8986CcRbDP','gateway','cardLast4','parse','now','amount','38985624aGMBHU','payment.success','prototype','4664JxrGFy','slice','POST','WebhookService','hasOwnProperty','\x20with\x20status\x20','Error\x20parsing\x20webhook\x20events:','createdAt','test_gateway_','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','default','failed','shopId','gatewayPaymentId','application/json','getPaymentForm','toISOString','findUnique','\x20processed:\x20','customerEmail','successUrl','failureMessage','failUrl','__setModuleDefault','processCard','4242\x204242\x204242\x204242','toLowerCase','PENDING','name','testGatewayService','PAID','Any\x20name','update','paid','ðŸ§ª\x20Test\x20Gateway\x20result:','Any\x203-4\x20digits','Any\x20future\x20date\x20(MM/YY)','replace','gatewayOrderId','Payment\x20failed','FAILED','sendPaymentNotification','call','\x20not\x20enabled\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TestGatewayController','../services/gateways/testGatewayService','payment.failed','sendPaymentStatusNotification','body','writable','ms)','webhookService','includes','210DjvWEL','webhookEvents','5349610FCVnpP','error','4557450ICaryn','test_gateway','getOwnPropertyDescriptor','Payment\x20is\x20not\x20for\x20test\x20gateway','cardNumber','get','Payment\x20not\x20found','customerName','Payment\x20status\x20is\x20','../config/database','status','settings','then',',\x20cannot\x20process'];a13_0x1deb=function(){return _0x5ba79e;};return a13_0x1deb();}(function(_0xe3f2a7,_0x4642c2){const _0x20f330=a13_0x3f6e,_0x524c79=_0xe3f2a7();while(!![]){try{const _0x25ca00=-parseInt(_0x20f330(0xf5))/0x1*(parseInt(_0x20f330(0x134))/0x2)+-parseInt(_0x20f330(0xea))/0x3+-parseInt(_0x20f330(0xe8))/0x4+parseInt(_0x20f330(0x136))/0x5+-parseInt(_0x20f330(0x138))/0x6+-parseInt(_0x20f330(0xf1))/0x7*(parseInt(_0x20f330(0xfe))/0x8)+parseInt(_0x20f330(0xfb))/0x9;if(_0x25ca00===_0x4642c2)break;else _0x524c79['push'](_0x524c79['shift']());}catch(_0x31e006){_0x524c79['push'](_0x524c79['shift']());}}}(a13_0x1deb,0xbd319));function a13_0x3f6e(_0x3df265,_0x32f191){const _0x1deb2e=a13_0x1deb();return a13_0x3f6e=function(_0x3f6e21,_0x344bbe){_0x3f6e21=_0x3f6e21-0xcc;let _0x52e2e5=_0x1deb2e[_0x3f6e21];return _0x52e2e5;},a13_0x3f6e(_0x3df265,_0x32f191);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x7e160c,_0x224809,_0x5c1dc8,_0x137c57){const _0x284f4d=a13_0x3f6e;if(_0x137c57===undefined)_0x137c57=_0x5c1dc8;var _0x3ee60f=Object[_0x284f4d(0xcd)](_0x224809,_0x5c1dc8);(!_0x3ee60f||(_0x284f4d(0xd0)in _0x3ee60f?!_0x224809[_0x284f4d(0xdb)]:_0x3ee60f[_0x284f4d(0x130)]||_0x3ee60f[_0x284f4d(0xe7)]))&&(_0x3ee60f={'enumerable':!![],'get':function(){return _0x224809[_0x5c1dc8];}}),Object['defineProperty'](_0x7e160c,_0x137c57,_0x3ee60f);}:function(_0x27d18f,_0x243b6f,_0x23e88a,_0x55e563){if(_0x55e563===undefined)_0x55e563=_0x23e88a;_0x27d18f[_0x55e563]=_0x243b6f[_0x23e88a];}),__setModuleDefault=this&&this[a13_0x1517b8(0x115)]||(Object['create']?function(_0x393386,_0x53eeb0){const _0x30fe1b=a13_0x1517b8;Object[_0x30fe1b(0xe0)](_0x393386,'default',{'enumerable':!![],'value':_0x53eeb0});}:function(_0x45bee7,_0x659b45){const _0x45bc13=a13_0x1517b8;_0x45bee7[_0x45bc13(0x108)]=_0x659b45;}),__importStar=this&&this['__importStar']||(function(){var _0x53ec2a=function(_0x2257fb){return _0x53ec2a=Object['getOwnPropertyNames']||function(_0x455eaa){const _0x261ebc=a13_0x3f6e;var _0x36c1c1=[];for(var _0x5a173b in _0x455eaa)if(Object[_0x261ebc(0xfd)][_0x261ebc(0x102)][_0x261ebc(0x128)](_0x455eaa,_0x5a173b))_0x36c1c1[_0x36c1c1[_0x261ebc(0xf3)]]=_0x5a173b;return _0x36c1c1;},_0x53ec2a(_0x2257fb);};return function(_0x472532){const _0x55fa20=a13_0x3f6e;if(_0x472532&&_0x472532['__esModule'])return _0x472532;var _0xf09551={};if(_0x472532!=null){for(var _0x29b453=_0x53ec2a(_0x472532),_0x5b76da=0x0;_0x5b76da<_0x29b453['length'];_0x5b76da++)if(_0x29b453[_0x5b76da]!==_0x55fa20(0x108))__createBinding(_0xf09551,_0x472532,_0x29b453[_0x5b76da]);}return __setModuleDefault(_0xf09551,_0x472532),_0xf09551;};}()),__importDefault=this&&this[a13_0x1517b8(0xde)]||function(_0x44b0bb){return _0x44b0bb&&_0x44b0bb['__esModule']?_0x44b0bb:{'default':_0x44b0bb};};Object[a13_0x1517b8(0xe0)](exports,a13_0x1517b8(0xdb),{'value':!![]}),exports[a13_0x1517b8(0x12b)]=void 0x0;const testGatewayService_1=require(a13_0x1517b8(0x12c)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x1517b8(0xd4)));class TestGatewayController{constructor(){const _0x37e7d8=a13_0x1517b8;this[_0x37e7d8(0x10d)]=async(_0x970efe,_0x37159a,_0x412130)=>{const _0x5dbe42=_0x37e7d8;try{const {paymentId:_0x30f444}=_0x970efe[_0x5dbe42(0xe9)];console['log'](_0x5dbe42(0x107)+_0x30f444);const _0x545a4c=await database_1[_0x5dbe42(0x108)][_0x5dbe42(0xee)][_0x5dbe42(0x10f)]({'where':{'id':_0x30f444},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x545a4c)return _0x37159a[_0x5dbe42(0xd5)](0x194)[_0x5dbe42(0xe3)]({'success':![],'message':_0x5dbe42(0xd1)});if(_0x545a4c[_0x5dbe42(0xf6)]!==_0x5dbe42(0xcc))return _0x37159a[_0x5dbe42(0xd5)](0x190)[_0x5dbe42(0xe3)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x545a4c[_0x5dbe42(0xd5)]!==_0x5dbe42(0x119))return _0x37159a[_0x5dbe42(0xd5)](0x190)[_0x5dbe42(0xe3)]({'success':![],'message':_0x5dbe42(0xd3)+_0x545a4c[_0x5dbe42(0xd5)]+_0x5dbe42(0xd8)});_0x37159a[_0x5dbe42(0xe3)]({'success':!![],'result':{'paymentId':_0x545a4c['id'],'orderId':_0x545a4c[_0x5dbe42(0x124)],'amount':_0x545a4c['amount'],'currency':_0x545a4c[_0x5dbe42(0xef)],'merchantName':_0x545a4c['shop'][_0x5dbe42(0x11a)],'description':'Payment\x20to\x20'+_0x545a4c[_0x5dbe42(0xec)][_0x5dbe42(0x11a)],'testInstructions':{'successCard':_0x5dbe42(0x117),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x5dbe42(0x122),'cvc':_0x5dbe42(0x121),'holderName':_0x5dbe42(0x11d)}}});}catch(_0x1606d1){_0x412130(_0x1606d1);}},this[_0x37e7d8(0x116)]=async(_0x51af5c,_0x359157,_0x771120)=>{const _0x34b1b3=_0x37e7d8;try{const {paymentId:_0x20b882}=_0x51af5c[_0x34b1b3(0xe9)],_0x15b16b=_0x51af5c[_0x34b1b3(0x12f)];console[_0x34b1b3(0xed)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x20b882);const _0x17c6c0=await database_1[_0x34b1b3(0x108)]['payment'][_0x34b1b3(0x10f)]({'where':{'id':_0x20b882},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x17c6c0)return _0x359157['status'](0x194)[_0x34b1b3(0xe3)]({'success':![],'message':_0x34b1b3(0xd1)});if(_0x17c6c0[_0x34b1b3(0xf6)]!==_0x34b1b3(0xcc))return _0x359157['status'](0x190)[_0x34b1b3(0xe3)]({'success':![],'message':_0x34b1b3(0xce)});if(_0x17c6c0[_0x34b1b3(0xd5)]!==_0x34b1b3(0x119))return _0x359157[_0x34b1b3(0xd5)](0x190)['json']({'success':![],'message':_0x34b1b3(0xd3)+_0x17c6c0[_0x34b1b3(0xd5)]+_0x34b1b3(0xd8)});const _0x382450=await this[_0x34b1b3(0x11b)][_0x34b1b3(0xe5)]({'paymentId':_0x17c6c0['id'],'orderId':_0x17c6c0['gatewayOrderId']||_0x17c6c0['id'],'amount':_0x17c6c0[_0x34b1b3(0xfa)],'currency':_0x17c6c0[_0x34b1b3(0xef)],'cardData':_0x15b16b});console['log'](_0x34b1b3(0x120),_0x382450);const _0x5f3489={'status':_0x382450[_0x34b1b3(0xd5)],'updatedAt':new Date()};if(_0x382450[_0x34b1b3(0xd5)]===_0x34b1b3(0x11c))_0x5f3489[_0x34b1b3(0xf4)]=new Date(),_0x5f3489[_0x34b1b3(0x10b)]=_0x382450['transactionId'];else _0x382450[_0x34b1b3(0xd5)]===_0x34b1b3(0x126)&&(_0x5f3489[_0x34b1b3(0x113)]=_0x382450['failureReason']);const _0x5278da=_0x15b16b[_0x34b1b3(0xcf)][_0x34b1b3(0x123)](/[\s-]/g,'');_0x5f3489[_0x34b1b3(0xf7)]=_0x5278da[_0x34b1b3(0xff)](-0x4),_0x5f3489['paymentMethod']=_0x34b1b3(0xdf),await database_1[_0x34b1b3(0x108)][_0x34b1b3(0xee)][_0x34b1b3(0x11e)]({'where':{'id':_0x17c6c0['id']},'data':_0x5f3489}),await database_1[_0x34b1b3(0x108)][_0x34b1b3(0xdd)][_0x34b1b3(0xe2)]({'data':{'paymentId':_0x17c6c0['id'],'shopId':_0x17c6c0[_0x34b1b3(0x10a)],'event':_0x34b1b3(0x106)+_0x382450[_0x34b1b3(0xd5)][_0x34b1b3(0x118)](),'statusCode':0xc8,'responseBody':JSON[_0x34b1b3(0xdc)]({'oldStatus':'PENDING','newStatus':_0x382450[_0x34b1b3(0xd5)],'transactionId':_0x382450[_0x34b1b3(0xda)],'failureReason':_0x382450[_0x34b1b3(0xe6)],'processedAt':new Date()[_0x34b1b3(0x10e)]()})}}),await this[_0x34b1b3(0xf2)](_0x17c6c0,_0x382450[_0x34b1b3(0xd5)],_0x382450[_0x34b1b3(0xda)],_0x382450['failureReason']),await this['sendPaymentStatusNotification'](_0x17c6c0,_0x382450[_0x34b1b3(0xd5)]),console[_0x34b1b3(0xed)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x20b882+_0x34b1b3(0x110)+_0x382450[_0x34b1b3(0xd5)]),_0x382450[_0x34b1b3(0xd5)]===_0x34b1b3(0x11c)?_0x359157[_0x34b1b3(0xe3)]({'success':!![],'message':_0x34b1b3(0xe4),'result':{'status':'PAID','transactionId':_0x382450[_0x34b1b3(0xda)],'redirectUrl':_0x17c6c0[_0x34b1b3(0x112)]}}):_0x359157[_0x34b1b3(0xd5)](0x190)[_0x34b1b3(0xe3)]({'success':![],'message':_0x34b1b3(0x125),'result':{'status':_0x34b1b3(0x126),'failureReason':_0x382450[_0x34b1b3(0xe6)],'redirectUrl':_0x17c6c0[_0x34b1b3(0x114)]}});}catch(_0x463091){_0x771120(_0x463091);}},this[_0x37e7d8(0x11b)]=new testGatewayService_1['TestGatewayService'](),this[_0x37e7d8(0x132)]=new webhookService_1[(_0x37e7d8(0x101))]();}async[a13_0x1517b8(0xf2)](_0x2e1c02,_0xbddaaa,_0x46ff2b,_0x91b389){const _0x5b721b=a13_0x1517b8,_0xc30b37=Date[_0x5b721b(0xf9)]();try{const _0x23ec90=_0x2e1c02['shop'],_0x482900=_0x23ec90[_0x5b721b(0xd6)];if(!_0x482900?.[_0x5b721b(0xf0)]){console[_0x5b721b(0xed)](_0x5b721b(0xd9)+_0x23ec90['id']);return;}const _0x2b33ae=_0xbddaaa===_0x5b721b(0x11c)?_0x5b721b(0xfc):_0x5b721b(0x12d);let _0x525516=[];if(_0x482900[_0x5b721b(0x135)])try{_0x525516=Array['isArray'](_0x482900['webhookEvents'])?_0x482900[_0x5b721b(0x135)]:JSON[_0x5b721b(0xf8)](_0x482900[_0x5b721b(0x135)]);}catch(_0x3b7bb8){console[_0x5b721b(0x137)](_0x5b721b(0x104),_0x3b7bb8),_0x525516=[];}if(!_0x525516[_0x5b721b(0x133)](_0x2b33ae)){console[_0x5b721b(0xed)]('Webhook\x20event\x20'+_0x2b33ae+_0x5b721b(0x129)+_0x23ec90['id']);return;}const _0x512fd={'event':_0x2b33ae,'payment':{'id':_0x2e1c02['id'],'order_id':_0x2e1c02['orderId'],'gateway_order_id':_0x2e1c02['gatewayOrderId'],'gateway':_0x5b721b(0xeb),'amount':_0x2e1c02['amount'],'currency':_0x2e1c02['currency'],'status':_0xbddaaa[_0x5b721b(0x118)](),'customer_email':_0x2e1c02[_0x5b721b(0x111)],'customer_name':_0x2e1c02[_0x5b721b(0xd2)],'transaction_id':_0x46ff2b,'failure_message':_0x91b389,'created_at':_0x2e1c02[_0x5b721b(0x105)],'updated_at':new Date()}},_0x5b7616=await fetch(_0x482900['webhookUrl'],{'method':_0x5b721b(0x100),'headers':{'Content-Type':_0x5b721b(0x10c),'User-Agent':_0x5b721b(0xe1)},'body':JSON['stringify'](_0x512fd)}),_0x5d3852=Date['now']()-_0xc30b37;console[_0x5b721b(0xed)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x482900[_0x5b721b(0xf0)]+_0x5b721b(0x103)+_0x5b7616['status']+'\x20('+_0x5d3852+_0x5b721b(0x131));}catch(_0x19f19c){console[_0x5b721b(0x137)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x19f19c);}}async[a13_0x1517b8(0x12e)](_0x117705,_0x4fc00e){const _0x573227=a13_0x1517b8;try{const {telegramBotService:_0x1689d9}=await Promise['resolve']()[_0x573227(0xd7)](()=>__importStar(require('../services/telegramBotService'))),_0x57c5f8={'PAID':_0x573227(0x11f),'FAILED':_0x573227(0x109)},_0x421cc1=_0x57c5f8[_0x4fc00e];if(!_0x421cc1)return;await _0x1689d9[_0x573227(0x127)](_0x117705[_0x573227(0x10a)],_0x117705,_0x421cc1);}catch(_0x3ddd34){console[_0x573227(0x137)](_0x573227(0x12a),_0x3ddd34);}}}exports['TestGatewayController']=TestGatewayController;