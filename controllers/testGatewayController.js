'use strict';const a13_0x201053=a13_0xd048;(function(_0x3804bb,_0x5b869a){const _0x193020=a13_0xd048,_0x34c351=_0x3804bb();while(!![]){try{const _0x58153a=-parseInt(_0x193020(0x76))/0x1*(-parseInt(_0x193020(0x88))/0x2)+-parseInt(_0x193020(0xda))/0x3+-parseInt(_0x193020(0xdc))/0x4+-parseInt(_0x193020(0xca))/0x5*(-parseInt(_0x193020(0x91))/0x6)+-parseInt(_0x193020(0xd4))/0x7+parseInt(_0x193020(0x97))/0x8*(parseInt(_0x193020(0xce))/0x9)+parseInt(_0x193020(0x84))/0xa*(parseInt(_0x193020(0x9f))/0xb);if(_0x58153a===_0x5b869a)break;else _0x34c351['push'](_0x34c351['shift']());}catch(_0xe1d9c7){_0x34c351['push'](_0x34c351['shift']());}}}(a13_0x5305,0x763f2));var __createBinding=this&&this[a13_0x201053(0x92)]||(Object['create']?function(_0x3496b7,_0x34033f,_0x10db76,_0x3c683f){const _0x581aed=a13_0x201053;if(_0x3c683f===undefined)_0x3c683f=_0x10db76;var _0x23b611=Object[_0x581aed(0x81)](_0x34033f,_0x10db76);(!_0x23b611||(_0x581aed(0xb6)in _0x23b611?!_0x34033f[_0x581aed(0x96)]:_0x23b611[_0x581aed(0xc6)]||_0x23b611[_0x581aed(0xe1)]))&&(_0x23b611={'enumerable':!![],'get':function(){return _0x34033f[_0x10db76];}}),Object[_0x581aed(0x94)](_0x3496b7,_0x3c683f,_0x23b611);}:function(_0x2bd9f8,_0x20eda6,_0x415a9c,_0x51365c){if(_0x51365c===undefined)_0x51365c=_0x415a9c;_0x2bd9f8[_0x51365c]=_0x20eda6[_0x415a9c];}),__setModuleDefault=this&&this[a13_0x201053(0xc7)]||(Object[a13_0x201053(0xbb)]?function(_0x2d15c0,_0x4fcfa8){const _0x41eea6=a13_0x201053;Object['defineProperty'](_0x2d15c0,_0x41eea6(0xcb),{'enumerable':!![],'value':_0x4fcfa8});}:function(_0x56a1e0,_0x2a9a13){const _0x133857=a13_0x201053;_0x56a1e0[_0x133857(0xcb)]=_0x2a9a13;}),__importStar=this&&this['__importStar']||(function(){var _0x569075=function(_0x404bc0){const _0x5c2e66=a13_0xd048;return _0x569075=Object[_0x5c2e66(0xd5)]||function(_0x46688e){const _0x236834=_0x5c2e66;var _0x576ba8=[];for(var _0x4534f2 in _0x46688e)if(Object[_0x236834(0xe4)][_0x236834(0xa6)][_0x236834(0x7a)](_0x46688e,_0x4534f2))_0x576ba8[_0x576ba8[_0x236834(0xa2)]]=_0x4534f2;return _0x576ba8;},_0x569075(_0x404bc0);};return function(_0x285cac){const _0x242352=a13_0xd048;if(_0x285cac&&_0x285cac[_0x242352(0x96)])return _0x285cac;var _0x2df703={};if(_0x285cac!=null){for(var _0x13cd94=_0x569075(_0x285cac),_0x378646=0x0;_0x378646<_0x13cd94[_0x242352(0xa2)];_0x378646++)if(_0x13cd94[_0x378646]!==_0x242352(0xcb))__createBinding(_0x2df703,_0x285cac,_0x13cd94[_0x378646]);}return __setModuleDefault(_0x2df703,_0x285cac),_0x2df703;};}()),__importDefault=this&&this[a13_0x201053(0xcd)]||function(_0x3c6370){return _0x3c6370&&_0x3c6370['__esModule']?_0x3c6370:{'default':_0x3c6370};};Object[a13_0x201053(0x94)](exports,a13_0x201053(0x96),{'value':!![]}),exports[a13_0x201053(0x9a)]=void 0x0;function a13_0xd048(_0x3f626e,_0x26c783){const _0x530592=a13_0x5305();return a13_0xd048=function(_0xd048d4,_0x22bc7d){_0xd048d4=_0xd048d4-0x76;let _0x185db2=_0x530592[_0xd048d4];return _0x185db2;},a13_0xd048(_0x3f626e,_0x26c783);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x898e19=a13_0x201053;this[_0x898e19(0x8e)]=async(_0x9c2753,_0x4e874d,_0x493a7b)=>{const _0x26a7cd=_0x898e19;try{const {paymentId:_0x5d0f9d}=_0x9c2753[_0x26a7cd(0x83)];console[_0x26a7cd(0xdb)](_0x26a7cd(0xdf)+_0x5d0f9d);const _0x7c77b2=await database_1['default'][_0x26a7cd(0xb8)]['findUnique']({'where':{'id':_0x5d0f9d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x7c77b2)return _0x4e874d[_0x26a7cd(0x87)](0x194)[_0x26a7cd(0xbc)]({'success':![],'message':_0x26a7cd(0xc0)});if(_0x7c77b2['gateway']!==_0x26a7cd(0x7b))return _0x4e874d[_0x26a7cd(0x87)](0x190)[_0x26a7cd(0xbc)]({'success':![],'message':_0x26a7cd(0x8d)});if(_0x7c77b2[_0x26a7cd(0x87)]!==_0x26a7cd(0xbe))return _0x4e874d['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x7c77b2[_0x26a7cd(0x87)]+_0x26a7cd(0xad)});_0x4e874d[_0x26a7cd(0xbc)]({'success':!![],'result':{'paymentId':_0x7c77b2['id'],'orderId':_0x7c77b2[_0x26a7cd(0xa8)],'amount':_0x7c77b2[_0x26a7cd(0xd8)],'currency':_0x7c77b2[_0x26a7cd(0x8c)],'merchantName':_0x7c77b2[_0x26a7cd(0xc4)][_0x26a7cd(0xdd)],'description':_0x26a7cd(0x98)+_0x7c77b2[_0x26a7cd(0xc4)][_0x26a7cd(0xdd)],'testInstructions':{'successCard':_0x26a7cd(0xc1),'failureCard':_0x26a7cd(0xcf),'expiryDate':_0x26a7cd(0x8b),'cvc':_0x26a7cd(0xaa),'holderName':_0x26a7cd(0xb5)}}});}catch(_0x311347){_0x493a7b(_0x311347);}},this[_0x898e19(0xb1)]=async(_0x4ce6e3,_0x5807fb,_0x51c35a)=>{const _0x53a60d=_0x898e19;try{const {paymentId:_0x280daf}=_0x4ce6e3[_0x53a60d(0x83)],_0x3e2b2b=_0x4ce6e3[_0x53a60d(0xb9)];console['log'](_0x53a60d(0xba)+_0x280daf);const _0x28df58=await database_1[_0x53a60d(0xcb)][_0x53a60d(0xb8)]['findUnique']({'where':{'id':_0x280daf},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x28df58)return _0x5807fb[_0x53a60d(0x87)](0x194)[_0x53a60d(0xbc)]({'success':![],'message':_0x53a60d(0xc0)});if(_0x28df58[_0x53a60d(0xe3)]!=='test_gateway')return _0x5807fb['status'](0x190)[_0x53a60d(0xbc)]({'success':![],'message':_0x53a60d(0x8d)});if(_0x28df58[_0x53a60d(0x87)]!==_0x53a60d(0xbe))return _0x5807fb['status'](0x190)[_0x53a60d(0xbc)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x28df58[_0x53a60d(0x87)]+_0x53a60d(0xad)});const _0x4ea76d=await this['testGatewayService'][_0x53a60d(0x9c)]({'paymentId':_0x28df58['id'],'orderId':_0x28df58[_0x53a60d(0xa8)]||_0x28df58['id'],'amount':_0x28df58[_0x53a60d(0xd8)],'currency':_0x28df58['currency'],'cardData':_0x3e2b2b});console[_0x53a60d(0xdb)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x4ea76d);const _0x273577={'status':_0x4ea76d[_0x53a60d(0x87)],'updatedAt':new Date()};if(_0x4ea76d[_0x53a60d(0x87)]==='PAID')_0x273577[_0x53a60d(0xd2)]=new Date(),_0x273577['gatewayPaymentId']=_0x4ea76d[_0x53a60d(0xb4)];else _0x4ea76d['status']===_0x53a60d(0x8f)&&(_0x273577[_0x53a60d(0xd3)]=_0x4ea76d[_0x53a60d(0x77)]);const _0xed71e0=_0x3e2b2b[_0x53a60d(0xc8)][_0x53a60d(0xa5)](/[\s-]/g,'');_0x273577[_0x53a60d(0xb0)]=_0xed71e0[_0x53a60d(0xb3)](-0x4),_0x273577[_0x53a60d(0xb2)]='test_card',await database_1[_0x53a60d(0xcb)][_0x53a60d(0xb8)][_0x53a60d(0xa4)]({'where':{'id':_0x28df58['id']},'data':_0x273577}),await database_1[_0x53a60d(0xcb)][_0x53a60d(0x79)][_0x53a60d(0xbb)]({'data':{'paymentId':_0x28df58['id'],'shopId':_0x28df58[_0x53a60d(0xaf)],'event':'test_gateway_'+_0x4ea76d[_0x53a60d(0x87)][_0x53a60d(0x7f)](),'statusCode':0xc8,'responseBody':JSON[_0x53a60d(0xac)]({'oldStatus':_0x53a60d(0xbe),'newStatus':_0x4ea76d['status'],'transactionId':_0x4ea76d[_0x53a60d(0xb4)],'failureReason':_0x4ea76d[_0x53a60d(0x77)],'processedAt':new Date()[_0x53a60d(0x80)]()})}}),await this[_0x53a60d(0x7e)](_0x28df58,_0x4ea76d['status'],_0x4ea76d[_0x53a60d(0xb4)],_0x4ea76d[_0x53a60d(0x77)]),await this[_0x53a60d(0xc9)](_0x28df58,_0x4ea76d[_0x53a60d(0x87)]),console['log'](_0x53a60d(0xd6)+_0x280daf+_0x53a60d(0x95)+_0x4ea76d[_0x53a60d(0x87)]),_0x4ea76d['status']==='PAID'?_0x5807fb['json']({'success':!![],'message':_0x53a60d(0xe0),'result':{'status':_0x53a60d(0xb7),'transactionId':_0x4ea76d['transactionId'],'redirectUrl':_0x28df58[_0x53a60d(0xbf)]}}):_0x5807fb[_0x53a60d(0x87)](0x190)[_0x53a60d(0xbc)]({'success':![],'message':_0x53a60d(0x7c),'result':{'status':_0x53a60d(0x8f),'failureReason':_0x4ea76d['failureReason'],'redirectUrl':_0x28df58[_0x53a60d(0xab)]}});}catch(_0x54ba87){_0x51c35a(_0x54ba87);}},this['testGatewayService']=new testGatewayService_1[(_0x898e19(0xe2))](),this[_0x898e19(0xc5)]=new webhookService_1['WebhookService']();}async[a13_0x201053(0x7e)](_0x41411f,_0x5f3548,_0x12eaf9,_0x12153d){const _0x36f108=a13_0x201053,_0x26516d=Date[_0x36f108(0x78)]();try{const _0x1a266b=_0x41411f[_0x36f108(0xc4)],_0x55bb0e=_0x1a266b[_0x36f108(0xa3)];if(!_0x55bb0e?.[_0x36f108(0xde)]){console[_0x36f108(0xdb)](_0x36f108(0x99)+_0x1a266b['id']);return;}const _0xc2fe6c=_0x5f3548===_0x36f108(0xb7)?_0x36f108(0xd1):_0x36f108(0xcc);let _0x1490ac=[];if(_0x55bb0e['webhookEvents'])try{_0x1490ac=Array[_0x36f108(0xa7)](_0x55bb0e[_0x36f108(0x9b)])?_0x55bb0e[_0x36f108(0x9b)]:JSON[_0x36f108(0xe5)](_0x55bb0e[_0x36f108(0x9b)]);}catch(_0x3a5759){console[_0x36f108(0xa0)](_0x36f108(0xd0),_0x3a5759),_0x1490ac=[];}if(!_0x1490ac[_0x36f108(0x9d)](_0xc2fe6c)){console[_0x36f108(0xdb)](_0x36f108(0x82)+_0xc2fe6c+_0x36f108(0xc3)+_0x1a266b['id']);return;}const _0x4e2e0b={'event':_0xc2fe6c,'payment':{'id':_0x41411f['id'],'order_id':_0x41411f[_0x36f108(0x90)],'gateway_order_id':_0x41411f[_0x36f108(0xa8)],'gateway':'0000','amount':_0x41411f[_0x36f108(0xd8)],'currency':_0x41411f['currency'],'status':_0x5f3548[_0x36f108(0x7f)](),'customer_email':_0x41411f[_0x36f108(0xae)],'customer_name':_0x41411f[_0x36f108(0x9e)],'transaction_id':_0x12eaf9,'failure_message':_0x12153d,'created_at':_0x41411f[_0x36f108(0x85)],'updated_at':new Date()}},_0x2773a2=await fetch(_0x55bb0e[_0x36f108(0xde)],{'method':_0x36f108(0x89),'headers':{'Content-Type':_0x36f108(0x7d),'User-Agent':_0x36f108(0x86)},'body':JSON['stringify'](_0x4e2e0b)}),_0x3523b7=Date[_0x36f108(0x78)]()-_0x26516d;console[_0x36f108(0xdb)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x55bb0e['webhookUrl']+_0x36f108(0xa1)+_0x2773a2[_0x36f108(0x87)]+'\x20('+_0x3523b7+_0x36f108(0x8a));}catch(_0x3d2144){console[_0x36f108(0xa0)](_0x36f108(0x93),_0x3d2144);}}async[a13_0x201053(0xc9)](_0x16c177,_0x1fe567){const _0x336d8c=a13_0x201053;try{const {telegramBotService:_0x3a4527}=await Promise['resolve']()[_0x336d8c(0xc2)](()=>__importStar(require(_0x336d8c(0xa9)))),_0x3c04be={'PAID':_0x336d8c(0xd7),'FAILED':_0x336d8c(0xbd)},_0x478013=_0x3c04be[_0x1fe567];if(!_0x478013)return;await _0x3a4527['sendPaymentNotification'](_0x16c177['shopId'],_0x16c177,_0x478013);}catch(_0x1bf8dc){console[_0x336d8c(0xa0)](_0x336d8c(0xd9),_0x1bf8dc);}}}exports[a13_0x201053(0x9a)]=TestGatewayController;function a13_0x5305(){const _0x3cc756=['length','settings','update','replace','hasOwnProperty','isArray','gatewayOrderId','../services/telegramBotService','Any\x203-4\x20digits','failUrl','stringify',',\x20cannot\x20process','customerEmail','shopId','cardLast4','processCard','paymentMethod','slice','transactionId','Any\x20name','get','PAID','payment','body','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','create','json','failed','PENDING','successUrl','Payment\x20not\x20found','4242\x204242\x204242\x204242','then','\x20not\x20enabled\x20for\x20shop\x20','shop','webhookService','writable','__setModuleDefault','cardNumber','sendPaymentStatusNotification','890eSdAUu','default','payment.failed','__importDefault','43857NYGfuX','Any\x20other\x20card\x20number','Error\x20parsing\x20webhook\x20events:','payment.success','paidAt','failureMessage','764505PtFZIw','getOwnPropertyNames','âœ…\x20Test\x20Gateway\x20payment\x20','paid','amount','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','2197680LKVUWB','log','3725120IBNcxk','name','webhookUrl','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20processed\x20successfully','configurable','TestGatewayService','gateway','prototype','parse','3356oSNqMJ','failureReason','now','webhookLog','call','test_gateway','Payment\x20failed','application/json','sendShopWebhook','toLowerCase','toISOString','getOwnPropertyDescriptor','Webhook\x20event\x20','params','4732180asWlta','createdAt','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','status','398YQGphY','POST','ms)','Any\x20future\x20date\x20(MM/YY)','currency','Payment\x20is\x20not\x20for\x20test\x20gateway','getPaymentForm','FAILED','orderId','7716HdPXUK','__createBinding','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','defineProperty','\x20processed:\x20','__esModule','680nWhpRA','Payment\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','TestGatewayController','webhookEvents','processCardPayment','includes','customerName','22GdlyGo','error','\x20with\x20status\x20'];a13_0x5305=function(){return _0x3cc756;};return a13_0x5305();}