'use strict';const a13_0x178d8c=a13_0x40a4;(function(_0x51439a,_0x3ff214){const _0x4d06e2=a13_0x40a4,_0x4386c6=_0x51439a();while(!![]){try{const _0x443fd9=-parseInt(_0x4d06e2(0x16f))/0x1*(parseInt(_0x4d06e2(0x194))/0x2)+parseInt(_0x4d06e2(0x19a))/0x3*(parseInt(_0x4d06e2(0x14e))/0x4)+-parseInt(_0x4d06e2(0x18c))/0x5*(parseInt(_0x4d06e2(0x187))/0x6)+-parseInt(_0x4d06e2(0x18d))/0x7+parseInt(_0x4d06e2(0x172))/0x8*(-parseInt(_0x4d06e2(0x17e))/0x9)+parseInt(_0x4d06e2(0x17b))/0xa*(parseInt(_0x4d06e2(0x1a0))/0xb)+parseInt(_0x4d06e2(0x186))/0xc;if(_0x443fd9===_0x3ff214)break;else _0x4386c6['push'](_0x4386c6['shift']());}catch(_0x2870f0){_0x4386c6['push'](_0x4386c6['shift']());}}}(a13_0x2c84,0xa2cf9));function a13_0x2c84(){const _0x34df24=['TestGatewayService','../config/database','defineProperty','TestGatewayController','toISOString','gatewayPaymentId','name','failed','params','âœ…\x20Test\x20Gateway\x20payment\x20','error','Payment\x20to\x20','../services/telegramBotService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20status\x20is\x20','get','cardNumber','orderId','1vtuFOC','toLowerCase','transactionId','10160dnXkTi','gatewayOrderId','payment.failed','Payment\x20not\x20found','payment.success','paid','WebhookService','webhookUrl','successUrl','148040koHjMA','PENDING','\x20with\x20status\x20','1089TLOWDj','processCard','customerEmail','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','now','application/json','paidAt','payment','11029824pawogC','90492cuINeb','webhookEvents','failureMessage','status','shopId','70yCkGiY','4871510SpKLgJ','POST','getPaymentForm','\x20not\x20enabled\x20for\x20shop\x20','__setModuleDefault','isArray','body','740206GYGYQE','PAID','Any\x203-4\x20digits','test_card','testGatewayService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','2025708CCwovt','default','getOwnPropertyDescriptor','writable','../services/webhookService','includes','374hNWexq','Test\x20Gateway\x20webhook\x20sent\x20to\x20','parse','createdAt','amount','hasOwnProperty','__createBinding','sendShopWebhook','ðŸ§ª\x20Test\x20Gateway\x20result:','Payment\x20is\x20not\x20for\x20test\x20gateway','findUnique','failureReason','shop','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Any\x20name','currency','webhookLog','__esModule','Payment\x20failed','length','slice','stringify','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','ms)','4kBLxPo',',\x20cannot\x20process','call','../services/gateways/testGatewayService','log','create','json','configurable','__importStar','then','settings','FAILED','resolve','getOwnPropertyNames','test_gateway'];a13_0x2c84=function(){return _0x34df24;};return a13_0x2c84();}var __createBinding=this&&this[a13_0x178d8c(0x1a6)]||(Object[a13_0x178d8c(0x153)]?function(_0x2b68e0,_0x5d8008,_0x12382b,_0x1dc613){const _0x4e2d51=a13_0x178d8c;if(_0x1dc613===undefined)_0x1dc613=_0x12382b;var _0x363b08=Object[_0x4e2d51(0x19c)](_0x5d8008,_0x12382b);(!_0x363b08||(_0x4e2d51(0x16c)in _0x363b08?!_0x5d8008[_0x4e2d51(0x147)]:_0x363b08[_0x4e2d51(0x19d)]||_0x363b08[_0x4e2d51(0x155)]))&&(_0x363b08={'enumerable':!![],'get':function(){return _0x5d8008[_0x12382b];}}),Object[_0x4e2d51(0x15f)](_0x2b68e0,_0x1dc613,_0x363b08);}:function(_0x523873,_0x5daece,_0x2c3e8a,_0x292bca){if(_0x292bca===undefined)_0x292bca=_0x2c3e8a;_0x523873[_0x292bca]=_0x5daece[_0x2c3e8a];}),__setModuleDefault=this&&this[a13_0x178d8c(0x191)]||(Object[a13_0x178d8c(0x153)]?function(_0x1f496c,_0x1bebb1){const _0x4fd555=a13_0x178d8c;Object[_0x4fd555(0x15f)](_0x1f496c,_0x4fd555(0x19b),{'enumerable':!![],'value':_0x1bebb1});}:function(_0x32195a,_0x58d82e){const _0x2ddf88=a13_0x178d8c;_0x32195a[_0x2ddf88(0x19b)]=_0x58d82e;}),__importStar=this&&this[a13_0x178d8c(0x156)]||(function(){var _0x2a1db5=function(_0x1c3bbf){const _0x20774f=a13_0x40a4;return _0x2a1db5=Object[_0x20774f(0x15b)]||function(_0x245486){const _0x3d8c96=_0x20774f;var _0x26cadd=[];for(var _0xd4fbaf in _0x245486)if(Object['prototype'][_0x3d8c96(0x1a5)][_0x3d8c96(0x150)](_0x245486,_0xd4fbaf))_0x26cadd[_0x26cadd[_0x3d8c96(0x149)]]=_0xd4fbaf;return _0x26cadd;},_0x2a1db5(_0x1c3bbf);};return function(_0x52ef7a){const _0x58dc42=a13_0x40a4;if(_0x52ef7a&&_0x52ef7a[_0x58dc42(0x147)])return _0x52ef7a;var _0x40a8fc={};if(_0x52ef7a!=null){for(var _0x198041=_0x2a1db5(_0x52ef7a),_0x36b04e=0x0;_0x36b04e<_0x198041[_0x58dc42(0x149)];_0x36b04e++)if(_0x198041[_0x36b04e]!==_0x58dc42(0x19b))__createBinding(_0x40a8fc,_0x52ef7a,_0x198041[_0x36b04e]);}return __setModuleDefault(_0x40a8fc,_0x52ef7a),_0x40a8fc;};}()),__importDefault=this&&this['__importDefault']||function(_0x55a948){return _0x55a948&&_0x55a948['__esModule']?_0x55a948:{'default':_0x55a948};};Object[a13_0x178d8c(0x15f)](exports,a13_0x178d8c(0x147),{'value':!![]}),exports[a13_0x178d8c(0x160)]=void 0x0;function a13_0x40a4(_0x494d88,_0x6d810a){const _0x2c84c0=a13_0x2c84();return a13_0x40a4=function(_0x40a43e,_0x301d81){_0x40a43e=_0x40a43e-0x13e;let _0x2f1027=_0x2c84c0[_0x40a43e];return _0x2f1027;},a13_0x40a4(_0x494d88,_0x6d810a);}const testGatewayService_1=require(a13_0x178d8c(0x151)),webhookService_1=require(a13_0x178d8c(0x19e)),database_1=__importDefault(require(a13_0x178d8c(0x15e)));class TestGatewayController{constructor(){const _0x551f7c=a13_0x178d8c;this[_0x551f7c(0x18f)]=async(_0x4003d6,_0x2673c4,_0x49fa37)=>{const _0x57ba81=_0x551f7c;try{const {paymentId:_0x47614a}=_0x4003d6[_0x57ba81(0x165)];console[_0x57ba81(0x152)](_0x57ba81(0x181)+_0x47614a);const _0x176a1a=await database_1[_0x57ba81(0x19b)][_0x57ba81(0x185)][_0x57ba81(0x140)]({'where':{'id':_0x47614a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x176a1a)return _0x2673c4[_0x57ba81(0x18a)](0x194)[_0x57ba81(0x154)]({'success':![],'message':_0x57ba81(0x175)});if(_0x176a1a['gateway']!==_0x57ba81(0x15c))return _0x2673c4[_0x57ba81(0x18a)](0x190)[_0x57ba81(0x154)]({'success':![],'message':_0x57ba81(0x13f)});if(_0x176a1a['status']!=='PENDING')return _0x2673c4[_0x57ba81(0x18a)](0x190)[_0x57ba81(0x154)]({'success':![],'message':_0x57ba81(0x16b)+_0x176a1a[_0x57ba81(0x18a)]+_0x57ba81(0x14f)});_0x2673c4[_0x57ba81(0x154)]({'success':!![],'result':{'paymentId':_0x176a1a['id'],'orderId':_0x176a1a[_0x57ba81(0x173)],'amount':_0x176a1a[_0x57ba81(0x1a4)],'currency':_0x176a1a['currency'],'merchantName':_0x176a1a[_0x57ba81(0x142)][_0x57ba81(0x163)],'description':_0x57ba81(0x168)+_0x176a1a[_0x57ba81(0x142)][_0x57ba81(0x163)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x57ba81(0x196),'holderName':_0x57ba81(0x144)}}});}catch(_0x4a9fb9){_0x49fa37(_0x4a9fb9);}},this[_0x551f7c(0x17f)]=async(_0x532913,_0x1ec6cd,_0x274568)=>{const _0x47f115=_0x551f7c;try{const {paymentId:_0x1b55ea}=_0x532913['params'],_0x40d5d1=_0x532913[_0x47f115(0x193)];console['log'](_0x47f115(0x14c)+_0x1b55ea);const _0x3a6fce=await database_1['default']['payment'][_0x47f115(0x140)]({'where':{'id':_0x1b55ea},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3a6fce)return _0x1ec6cd['status'](0x194)[_0x47f115(0x154)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3a6fce['gateway']!==_0x47f115(0x15c))return _0x1ec6cd['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3a6fce[_0x47f115(0x18a)]!=='PENDING')return _0x1ec6cd[_0x47f115(0x18a)](0x190)[_0x47f115(0x154)]({'success':![],'message':_0x47f115(0x16b)+_0x3a6fce[_0x47f115(0x18a)]+_0x47f115(0x14f)});const _0xf58f5=await this[_0x47f115(0x198)]['processCardPayment']({'paymentId':_0x3a6fce['id'],'orderId':_0x3a6fce[_0x47f115(0x173)]||_0x3a6fce['id'],'amount':_0x3a6fce[_0x47f115(0x1a4)],'currency':_0x3a6fce['currency'],'cardData':_0x40d5d1});console[_0x47f115(0x152)](_0x47f115(0x13e),_0xf58f5);const _0x3ce1af={'status':_0xf58f5['status'],'updatedAt':new Date()};if(_0xf58f5[_0x47f115(0x18a)]===_0x47f115(0x195))_0x3ce1af[_0x47f115(0x184)]=new Date(),_0x3ce1af[_0x47f115(0x162)]=_0xf58f5[_0x47f115(0x171)];else _0xf58f5[_0x47f115(0x18a)]===_0x47f115(0x159)&&(_0x3ce1af[_0x47f115(0x189)]=_0xf58f5['failureReason']);const _0x540833=_0x40d5d1[_0x47f115(0x16d)]['replace'](/[\s-]/g,'');_0x3ce1af['cardLast4']=_0x540833[_0x47f115(0x14a)](-0x4),_0x3ce1af['paymentMethod']=_0x47f115(0x197),await database_1[_0x47f115(0x19b)][_0x47f115(0x185)]['update']({'where':{'id':_0x3a6fce['id']},'data':_0x3ce1af}),await database_1[_0x47f115(0x19b)][_0x47f115(0x146)][_0x47f115(0x153)]({'data':{'paymentId':_0x3a6fce['id'],'shopId':_0x3a6fce[_0x47f115(0x18b)],'event':'test_gateway_'+_0xf58f5[_0x47f115(0x18a)][_0x47f115(0x170)](),'statusCode':0xc8,'responseBody':JSON[_0x47f115(0x14b)]({'oldStatus':_0x47f115(0x17c),'newStatus':_0xf58f5[_0x47f115(0x18a)],'transactionId':_0xf58f5[_0x47f115(0x171)],'failureReason':_0xf58f5[_0x47f115(0x141)],'processedAt':new Date()[_0x47f115(0x161)]()})}}),await this[_0x47f115(0x1a7)](_0x3a6fce,_0xf58f5[_0x47f115(0x18a)],_0xf58f5['transactionId'],_0xf58f5[_0x47f115(0x141)]),await this['sendPaymentStatusNotification'](_0x3a6fce,_0xf58f5[_0x47f115(0x18a)]),console[_0x47f115(0x152)](_0x47f115(0x166)+_0x1b55ea+'\x20processed:\x20'+_0xf58f5[_0x47f115(0x18a)]),_0xf58f5['status']===_0x47f115(0x195)?_0x1ec6cd[_0x47f115(0x154)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x47f115(0x195),'transactionId':_0xf58f5['transactionId'],'redirectUrl':_0x3a6fce[_0x47f115(0x17a)]}}):_0x1ec6cd[_0x47f115(0x18a)](0x190)[_0x47f115(0x154)]({'success':![],'message':_0x47f115(0x148),'result':{'status':'FAILED','failureReason':_0xf58f5['failureReason'],'redirectUrl':_0x3a6fce['failUrl']}});}catch(_0x154cf5){_0x274568(_0x154cf5);}},this[_0x551f7c(0x198)]=new testGatewayService_1[(_0x551f7c(0x15d))](),this['webhookService']=new webhookService_1[(_0x551f7c(0x178))]();}async['sendShopWebhook'](_0x185ddb,_0x444c63,_0x255cae,_0x161c7e){const _0x2026c1=a13_0x178d8c,_0x26948a=Date[_0x2026c1(0x182)]();try{const _0x4c9161=_0x185ddb[_0x2026c1(0x142)],_0x8b566e=_0x4c9161[_0x2026c1(0x158)];if(!_0x8b566e?.['webhookUrl']){console['log'](_0x2026c1(0x199)+_0x4c9161['id']);return;}const _0xb6d0e1=_0x444c63===_0x2026c1(0x195)?_0x2026c1(0x176):_0x2026c1(0x174);let _0x4ba430=[];if(_0x8b566e[_0x2026c1(0x188)])try{_0x4ba430=Array[_0x2026c1(0x192)](_0x8b566e[_0x2026c1(0x188)])?_0x8b566e['webhookEvents']:JSON[_0x2026c1(0x1a2)](_0x8b566e['webhookEvents']);}catch(_0xdb722a){console['error']('Error\x20parsing\x20webhook\x20events:',_0xdb722a),_0x4ba430=[];}if(!_0x4ba430[_0x2026c1(0x19f)](_0xb6d0e1)){console[_0x2026c1(0x152)]('Webhook\x20event\x20'+_0xb6d0e1+_0x2026c1(0x190)+_0x4c9161['id']);return;}const _0x86c83a={'event':_0xb6d0e1,'payment':{'id':_0x185ddb['id'],'order_id':_0x185ddb[_0x2026c1(0x16e)],'gateway_order_id':_0x185ddb[_0x2026c1(0x173)],'gateway':'0000','amount':_0x185ddb[_0x2026c1(0x1a4)],'currency':_0x185ddb[_0x2026c1(0x145)],'status':_0x444c63[_0x2026c1(0x170)](),'customer_email':_0x185ddb[_0x2026c1(0x180)],'customer_name':_0x185ddb['customerName'],'transaction_id':_0x255cae,'failure_message':_0x161c7e,'created_at':_0x185ddb[_0x2026c1(0x1a3)],'updated_at':new Date()}},_0x371b12=await fetch(_0x8b566e[_0x2026c1(0x179)],{'method':_0x2026c1(0x18e),'headers':{'Content-Type':_0x2026c1(0x183),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x2026c1(0x14b)](_0x86c83a)}),_0x5b0cc3=Date[_0x2026c1(0x182)]()-_0x26948a;console[_0x2026c1(0x152)](_0x2026c1(0x1a1)+_0x8b566e['webhookUrl']+_0x2026c1(0x17d)+_0x371b12[_0x2026c1(0x18a)]+'\x20('+_0x5b0cc3+_0x2026c1(0x14d));}catch(_0x598cff){console[_0x2026c1(0x167)](_0x2026c1(0x143),_0x598cff);}}async['sendPaymentStatusNotification'](_0xe1aefa,_0x2af8a9){const _0x57635d=a13_0x178d8c;try{const {telegramBotService:_0x1d9d95}=await Promise[_0x57635d(0x15a)]()[_0x57635d(0x157)](()=>__importStar(require(_0x57635d(0x169)))),_0x1f9b7c={'PAID':_0x57635d(0x177),'FAILED':_0x57635d(0x164)},_0x568d8f=_0x1f9b7c[_0x2af8a9];if(!_0x568d8f)return;await _0x1d9d95['sendPaymentNotification'](_0xe1aefa['shopId'],_0xe1aefa,_0x568d8f);}catch(_0x35fa95){console[_0x57635d(0x167)](_0x57635d(0x16a),_0x35fa95);}}}exports[a13_0x178d8c(0x160)]=TestGatewayController;