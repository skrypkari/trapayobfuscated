'use strict';function a13_0x4203(){const _0x581363=['9027256bzScnb','isArray','8898480AMRtEz','resolve','WebhookService','4380280hAcgem','webhookEvents','toISOString','failed','$transaction','status','then','üìà\x20Test\x20Gateway:\x20Payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayOrderId','3848008OQnYHO','Any\x20future\x20date\x20(MM/YY)','amount','Payment\x20processed\x20successfully','failureMessage','Any\x203-4\x20digits','configurable','log','Payment\x20is\x20not\x20for\x20test\x20gateway','params','successUrl','4810796XqGvnR','update','test_card','settings','COMPLETED','Any\x20other\x20card\x20number','now','toLowerCase','paid','\x20not\x20enabled\x20for\x20shop\x20','../services/gateways/testGatewayService','test_gateway','sendShopWebhook','getPaymentForm','Payment\x20to\x20','‚úÖ\x20Payment\x20link\x20','\x20->\x20','application/json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__esModule','PENDING','shop','TestGatewayService','transactionId','testGatewayService','920088AHoYRN','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','length','‚ùå\x20Payment\x20link\x20','orderId','writable','\x20with\x20status\x20','Payment\x20status\x20is\x20','sendPaymentStatusNotification','createdAt','200yXTAtr','stringify','PAID','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','2sSCsdb','FAILED','paymentLinkId','paymentLink','Error\x20parsing\x20webhook\x20events:','gatewayPaymentId','webhookUrl','findUnique',':\x20type=','üìà\x20Found\x20payment\x20link\x20','Webhook\x20event\x20','ms)','\x20updated:\x20currentPayments=','payment','shopId','Payment\x20failed','3ppMvHS','POST','slice','\x20processed:\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','4242\x204242\x204242\x204242','payment.failed','customerEmail','SINGLE','‚úÖ\x20Test\x20Gateway\x20payment\x20','getOwnPropertyNames','failureReason','defineProperty','test_gateway_','Payment\x20not\x20found','create','__importDefault','../services/telegramBotService','0000','../services/webhookService','gateway','TestGatewayController','json','replace','sendPaymentNotification','1252022cWXNZv','name','payment.success','error','currency','body',',\x20cannot\x20process','getOwnPropertyDescriptor','paidAt','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','webhookLog','type','currentPayments','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20',',\x20status=','default','parse'];a13_0x4203=function(){return _0x581363;};return a13_0x4203();}function a13_0x908c(_0x2b02a7,_0x3000f6){const _0x420379=a13_0x4203();return a13_0x908c=function(_0x908cff,_0x5f3c5e){_0x908cff=_0x908cff-0xd1;let _0x4c07b0=_0x420379[_0x908cff];return _0x4c07b0;},a13_0x908c(_0x2b02a7,_0x3000f6);}const a13_0x4fe380=a13_0x908c;(function(_0x2dad82,_0x348b18){const _0x382276=a13_0x908c,_0x49f3f6=_0x2dad82();while(!![]){try{const _0xc2cb6d=-parseInt(_0x382276(0xf3))/0x1*(parseInt(_0x382276(0x145))/0x2)+parseInt(_0x382276(0xda))/0x3*(-parseInt(_0x382276(0x11e))/0x4)+parseInt(_0x382276(0x109))/0x5+-parseInt(_0x382276(0x106))/0x6+parseInt(_0x382276(0x104))/0x7+parseInt(_0x382276(0x113))/0x8+-parseInt(_0x382276(0x137))/0x9*(-parseInt(_0x382276(0x141))/0xa);if(_0xc2cb6d===_0x348b18)break;else _0x49f3f6['push'](_0x49f3f6['shift']());}catch(_0xf14b09){_0x49f3f6['push'](_0x49f3f6['shift']());}}}(a13_0x4203,0xb7f60));var __createBinding=this&&this['__createBinding']||(Object[a13_0x4fe380(0xe9)]?function(_0xfe5185,_0x3e1133,_0x4a521f,_0x2d692a){const _0x396ac7=a13_0x4fe380;if(_0x2d692a===undefined)_0x2d692a=_0x4a521f;var _0x5141b0=Object[_0x396ac7(0xfa)](_0x3e1133,_0x4a521f);(!_0x5141b0||('get'in _0x5141b0?!_0x3e1133['__esModule']:_0x5141b0[_0x396ac7(0x13c)]||_0x5141b0[_0x396ac7(0x119)]))&&(_0x5141b0={'enumerable':!![],'get':function(){return _0x3e1133[_0x4a521f];}}),Object['defineProperty'](_0xfe5185,_0x2d692a,_0x5141b0);}:function(_0x4350d6,_0x3854b7,_0x251957,_0x5e2205){if(_0x5e2205===undefined)_0x5e2205=_0x251957;_0x4350d6[_0x5e2205]=_0x3854b7[_0x251957];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x4fe380(0xe9)]?function(_0x351308,_0x332ec5){const _0x214b65=a13_0x4fe380;Object[_0x214b65(0xe6)](_0x351308,_0x214b65(0x102),{'enumerable':!![],'value':_0x332ec5});}:function(_0x2fb94f,_0x28637d){const _0x5e8d19=a13_0x4fe380;_0x2fb94f[_0x5e8d19(0x102)]=_0x28637d;}),__importStar=this&&this['__importStar']||(function(){var _0x4a30b6=function(_0x5e5021){const _0x4c2497=a13_0x908c;return _0x4a30b6=Object[_0x4c2497(0xe4)]||function(_0x3f89f7){const _0x139fa6=_0x4c2497;var _0x5473ce=[];for(var _0x26f9e2 in _0x3f89f7)if(Object['prototype']['hasOwnProperty']['call'](_0x3f89f7,_0x26f9e2))_0x5473ce[_0x5473ce[_0x139fa6(0x139)]]=_0x26f9e2;return _0x5473ce;},_0x4a30b6(_0x5e5021);};return function(_0x294f9d){const _0x5076ed=a13_0x908c;if(_0x294f9d&&_0x294f9d[_0x5076ed(0x131)])return _0x294f9d;var _0x4bcf28={};if(_0x294f9d!=null){for(var _0x31b219=_0x4a30b6(_0x294f9d),_0x59f989=0x0;_0x59f989<_0x31b219[_0x5076ed(0x139)];_0x59f989++)if(_0x31b219[_0x59f989]!=='default')__createBinding(_0x4bcf28,_0x294f9d,_0x31b219[_0x59f989]);}return __setModuleDefault(_0x4bcf28,_0x294f9d),_0x4bcf28;};}()),__importDefault=this&&this[a13_0x4fe380(0xea)]||function(_0x276087){const _0x956446=a13_0x4fe380;return _0x276087&&_0x276087[_0x956446(0x131)]?_0x276087:{'default':_0x276087};};Object['defineProperty'](exports,a13_0x4fe380(0x131),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x4fe380(0x128)),webhookService_1=require(a13_0x4fe380(0xed)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x472608=a13_0x4fe380;this[_0x472608(0x12b)]=async(_0x61b38d,_0x428f39,_0x41c6d1)=>{const _0x4999d5=_0x472608;try{const {paymentId:_0x2eef6b}=_0x61b38d[_0x4999d5(0x11c)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2eef6b);const _0x1e18d4=await database_1[_0x4999d5(0x102)][_0x4999d5(0xd7)][_0x4999d5(0xd1)]({'where':{'id':_0x2eef6b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1e18d4)return _0x428f39[_0x4999d5(0x10e)](0x194)[_0x4999d5(0xf0)]({'success':![],'message':_0x4999d5(0xe8)});if(_0x1e18d4[_0x4999d5(0xee)]!==_0x4999d5(0x129))return _0x428f39['status'](0x190)[_0x4999d5(0xf0)]({'success':![],'message':_0x4999d5(0x11b)});if(_0x1e18d4[_0x4999d5(0x10e)]!==_0x4999d5(0x132))return _0x428f39[_0x4999d5(0x10e)](0x190)[_0x4999d5(0xf0)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1e18d4['status']+_0x4999d5(0xf9)});_0x428f39[_0x4999d5(0xf0)]({'success':!![],'result':{'paymentId':_0x1e18d4['id'],'orderId':_0x1e18d4[_0x4999d5(0x112)],'amount':_0x1e18d4[_0x4999d5(0x115)],'currency':_0x1e18d4[_0x4999d5(0xf7)],'merchantName':_0x1e18d4['shop'][_0x4999d5(0xf4)],'description':_0x4999d5(0x12c)+_0x1e18d4[_0x4999d5(0x133)][_0x4999d5(0xf4)],'testInstructions':{'successCard':_0x4999d5(0xdf),'failureCard':_0x4999d5(0x123),'expiryDate':_0x4999d5(0x114),'cvc':_0x4999d5(0x118),'holderName':'Any\x20name'}}});}catch(_0x233a7a){_0x41c6d1(_0x233a7a);}},this['processCard']=async(_0x1b2791,_0x2c13a0,_0x585280)=>{const _0x35d0c8=_0x472608;try{const {paymentId:_0x24c289}=_0x1b2791['params'],_0xb8db8a=_0x1b2791[_0x35d0c8(0xf8)];console['log'](_0x35d0c8(0x100)+_0x24c289);const _0x1ab97d=await database_1[_0x35d0c8(0x102)][_0x35d0c8(0xd7)]['findUnique']({'where':{'id':_0x24c289},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ab97d)return _0x2c13a0[_0x35d0c8(0x10e)](0x194)[_0x35d0c8(0xf0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1ab97d[_0x35d0c8(0xee)]!==_0x35d0c8(0x129))return _0x2c13a0['status'](0x190)[_0x35d0c8(0xf0)]({'success':![],'message':_0x35d0c8(0x11b)});if(_0x1ab97d['status']!==_0x35d0c8(0x132))return _0x2c13a0[_0x35d0c8(0x10e)](0x190)['json']({'success':![],'message':_0x35d0c8(0x13e)+_0x1ab97d[_0x35d0c8(0x10e)]+_0x35d0c8(0xf9)});const _0x26bb83=await this[_0x35d0c8(0x136)]['processCardPayment']({'paymentId':_0x1ab97d['id'],'orderId':_0x1ab97d[_0x35d0c8(0x112)]||_0x1ab97d['id'],'amount':_0x1ab97d['amount'],'currency':_0x1ab97d[_0x35d0c8(0xf7)],'cardData':_0xb8db8a});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x26bb83);const _0x5e1eb7={'status':_0x26bb83[_0x35d0c8(0x10e)],'updatedAt':new Date()};if(_0x26bb83[_0x35d0c8(0x10e)]==='PAID')_0x5e1eb7[_0x35d0c8(0xfb)]=new Date(),_0x5e1eb7[_0x35d0c8(0x14a)]=_0x26bb83[_0x35d0c8(0x135)];else _0x26bb83[_0x35d0c8(0x10e)]===_0x35d0c8(0x146)&&(_0x5e1eb7[_0x35d0c8(0x117)]=_0x26bb83[_0x35d0c8(0xe5)]);const _0x1e9155=_0xb8db8a['cardNumber'][_0x35d0c8(0xf1)](/[\s-]/g,'');_0x5e1eb7['cardLast4']=_0x1e9155[_0x35d0c8(0xdc)](-0x4),_0x5e1eb7['paymentMethod']=_0x35d0c8(0x120),await database_1['default'][_0x35d0c8(0xd7)]['update']({'where':{'id':_0x1ab97d['id']},'data':_0x5e1eb7});if(_0x26bb83[_0x35d0c8(0x10e)]===_0x35d0c8(0x143)&&_0x1ab97d[_0x35d0c8(0x147)]){console[_0x35d0c8(0x11a)](_0x35d0c8(0x110)+_0x1ab97d['id']+_0x35d0c8(0x138));try{await database_1[_0x35d0c8(0x102)][_0x35d0c8(0x10d)](async _0x543de0=>{const _0x51a444=_0x35d0c8,_0x37954c=await _0x543de0[_0x51a444(0x148)][_0x51a444(0xd1)]({'where':{'id':_0x1ab97d[_0x51a444(0x147)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x37954c){console[_0x51a444(0x11a)](_0x51a444(0xd3)+_0x37954c['id']+_0x51a444(0xd2)+_0x37954c['type']+',\x20currentPayments='+_0x37954c['currentPayments']+_0x51a444(0x101)+_0x37954c['status']);const _0x55e046=_0x37954c[_0x51a444(0xff)]+0x1,_0x1af4f7=_0x37954c[_0x51a444(0xfe)]===_0x51a444(0xe2)?_0x51a444(0x122):_0x37954c[_0x51a444(0x10e)];await _0x543de0[_0x51a444(0x148)][_0x51a444(0x11f)]({'where':{'id':_0x1ab97d[_0x51a444(0x147)]},'data':{'currentPayments':_0x55e046,'status':_0x1af4f7,'updatedAt':new Date()}}),console[_0x51a444(0x11a)](_0x51a444(0x12d)+_0x37954c['id']+_0x51a444(0xd6)+_0x37954c[_0x51a444(0xff)]+_0x51a444(0x12e)+_0x55e046+_0x51a444(0x101)+_0x37954c[_0x51a444(0x10e)]+_0x51a444(0x12e)+_0x1af4f7);}else console[_0x51a444(0x11a)](_0x51a444(0x13a)+_0x1ab97d['paymentLinkId']+'\x20not\x20found');});}catch(_0x2aa7d2){console[_0x35d0c8(0xf6)](_0x35d0c8(0xfc),_0x2aa7d2);}}await database_1[_0x35d0c8(0x102)][_0x35d0c8(0xfd)][_0x35d0c8(0xe9)]({'data':{'paymentId':_0x1ab97d['id'],'shopId':_0x1ab97d[_0x35d0c8(0xd8)],'event':_0x35d0c8(0xe7)+_0x26bb83[_0x35d0c8(0x10e)][_0x35d0c8(0x125)](),'statusCode':0xc8,'responseBody':JSON[_0x35d0c8(0x142)]({'oldStatus':_0x35d0c8(0x132),'newStatus':_0x26bb83[_0x35d0c8(0x10e)],'transactionId':_0x26bb83[_0x35d0c8(0x135)],'failureReason':_0x26bb83[_0x35d0c8(0xe5)],'processedAt':new Date()[_0x35d0c8(0x10b)]()})}}),await this[_0x35d0c8(0x12a)](_0x1ab97d,_0x26bb83['status'],_0x26bb83['transactionId'],_0x26bb83[_0x35d0c8(0xe5)]),await this['sendPaymentStatusNotification'](_0x1ab97d,_0x26bb83['status']),console[_0x35d0c8(0x11a)](_0x35d0c8(0xe3)+_0x24c289+_0x35d0c8(0xdd)+_0x26bb83[_0x35d0c8(0x10e)]),_0x26bb83[_0x35d0c8(0x10e)]===_0x35d0c8(0x143)?_0x2c13a0[_0x35d0c8(0xf0)]({'success':!![],'message':_0x35d0c8(0x116),'result':{'status':_0x35d0c8(0x143),'transactionId':_0x26bb83[_0x35d0c8(0x135)],'redirectUrl':_0x1ab97d[_0x35d0c8(0x11d)]}}):_0x2c13a0['status'](0x190)[_0x35d0c8(0xf0)]({'success':![],'message':_0x35d0c8(0xd9),'result':{'status':_0x35d0c8(0x146),'failureReason':_0x26bb83['failureReason'],'redirectUrl':_0x1ab97d['failUrl']}});}catch(_0xdf860c){_0x585280(_0xdf860c);}},this[_0x472608(0x136)]=new testGatewayService_1[(_0x472608(0x134))](),this['webhookService']=new webhookService_1[(_0x472608(0x108))]();}async[a13_0x4fe380(0x12a)](_0x5afe9b,_0x2fdb86,_0x9c6cd2,_0x31b744){const _0x147594=a13_0x4fe380,_0x348d15=Date[_0x147594(0x124)]();try{const _0x50f491=_0x5afe9b['shop'],_0x43b668=_0x50f491[_0x147594(0x121)];if(!_0x43b668?.[_0x147594(0x14b)]){console[_0x147594(0x11a)](_0x147594(0x130)+_0x50f491['id']);return;}const _0x40e2dc=_0x2fdb86===_0x147594(0x143)?_0x147594(0xf5):_0x147594(0xe0);let _0x817499=[];if(_0x43b668[_0x147594(0x10a)])try{_0x817499=Array[_0x147594(0x105)](_0x43b668['webhookEvents'])?_0x43b668[_0x147594(0x10a)]:JSON[_0x147594(0x103)](_0x43b668['webhookEvents']);}catch(_0x1672a4){console['error'](_0x147594(0x149),_0x1672a4),_0x817499=[];}if(!_0x817499['includes'](_0x40e2dc)){console[_0x147594(0x11a)](_0x147594(0xd4)+_0x40e2dc+_0x147594(0x127)+_0x50f491['id']);return;}const _0x17c212={'event':_0x40e2dc,'payment':{'id':_0x5afe9b['id'],'order_id':_0x5afe9b[_0x147594(0x13b)],'gateway_order_id':_0x5afe9b[_0x147594(0x112)],'gateway':_0x147594(0xec),'amount':_0x5afe9b[_0x147594(0x115)],'currency':_0x5afe9b['currency'],'status':_0x2fdb86[_0x147594(0x125)](),'customer_email':_0x5afe9b[_0x147594(0xe1)],'customer_name':_0x5afe9b['customerName'],'transaction_id':_0x9c6cd2,'failure_message':_0x31b744,'created_at':_0x5afe9b[_0x147594(0x140)],'updated_at':new Date()}},_0x4953ff=await fetch(_0x43b668[_0x147594(0x14b)],{'method':_0x147594(0xdb),'headers':{'Content-Type':_0x147594(0x12f),'User-Agent':_0x147594(0x144)},'body':JSON['stringify'](_0x17c212)}),_0x40bd53=Date[_0x147594(0x124)]()-_0x348d15;console[_0x147594(0x11a)](_0x147594(0xde)+_0x43b668[_0x147594(0x14b)]+_0x147594(0x13d)+_0x4953ff[_0x147594(0x10e)]+'\x20('+_0x40bd53+_0x147594(0xd5));}catch(_0x19c54e){console[_0x147594(0xf6)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x19c54e);}}async[a13_0x4fe380(0x13f)](_0xa0d549,_0x152492){const _0x418106=a13_0x4fe380;try{const {telegramBotService:_0x46b353}=await Promise[_0x418106(0x107)]()[_0x418106(0x10f)](()=>__importStar(require(_0x418106(0xeb)))),_0x20fcf5={'PAID':_0x418106(0x126),'FAILED':_0x418106(0x10c)},_0x3f0841=_0x20fcf5[_0x152492];if(!_0x3f0841)return;await _0x46b353[_0x418106(0xf2)](_0xa0d549[_0x418106(0xd8)],_0xa0d549,_0x3f0841);}catch(_0x27aa14){console['error'](_0x418106(0x111),_0x27aa14);}}}exports[a13_0x4fe380(0xef)]=TestGatewayController;