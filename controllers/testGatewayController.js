'use strict';const a13_0x1de0d1=a13_0x2384;(function(_0x3eb73f,_0x58354e){const _0x31d1eb=a13_0x2384,_0x16cc9d=_0x3eb73f();while(!![]){try{const _0x28b0b7=parseInt(_0x31d1eb(0xcf))/0x1*(parseInt(_0x31d1eb(0xd4))/0x2)+-parseInt(_0x31d1eb(0x87))/0x3*(parseInt(_0x31d1eb(0xdc))/0x4)+-parseInt(_0x31d1eb(0x7f))/0x5*(-parseInt(_0x31d1eb(0xa3))/0x6)+-parseInt(_0x31d1eb(0xd3))/0x7+-parseInt(_0x31d1eb(0xc0))/0x8+parseInt(_0x31d1eb(0x9e))/0x9*(-parseInt(_0x31d1eb(0x89))/0xa)+parseInt(_0x31d1eb(0xa8))/0xb;if(_0x28b0b7===_0x58354e)break;else _0x16cc9d['push'](_0x16cc9d['shift']());}catch(_0x349986){_0x16cc9d['push'](_0x16cc9d['shift']());}}}(a13_0xfbe3,0xa669b));function a13_0x2384(_0xa816e8,_0xffb0b4){const _0xfbe321=a13_0xfbe3();return a13_0x2384=function(_0x2384a8,_0x5c5624){_0x2384a8=_0x2384a8-0x76;let _0x3edeb5=_0xfbe321[_0x2384a8];return _0x3edeb5;},a13_0x2384(_0xa816e8,_0xffb0b4);}var __createBinding=this&&this[a13_0x1de0d1(0xa1)]||(Object[a13_0x1de0d1(0xd7)]?function(_0x27b017,_0x43df24,_0x4506ac,_0x14ae96){const _0x334ca0=a13_0x1de0d1;if(_0x14ae96===undefined)_0x14ae96=_0x4506ac;var _0x10d316=Object[_0x334ca0(0x9d)](_0x43df24,_0x4506ac);(!_0x10d316||(_0x334ca0(0xaf)in _0x10d316?!_0x43df24[_0x334ca0(0x8f)]:_0x10d316[_0x334ca0(0x8a)]||_0x10d316[_0x334ca0(0xc7)]))&&(_0x10d316={'enumerable':!![],'get':function(){return _0x43df24[_0x4506ac];}}),Object[_0x334ca0(0xe7)](_0x27b017,_0x14ae96,_0x10d316);}:function(_0x5cee6b,_0x192a5b,_0x177f33,_0x24f252){if(_0x24f252===undefined)_0x24f252=_0x177f33;_0x5cee6b[_0x24f252]=_0x192a5b[_0x177f33];}),__setModuleDefault=this&&this[a13_0x1de0d1(0xac)]||(Object[a13_0x1de0d1(0xd7)]?function(_0x1fbc51,_0x777c6a){const _0x46c8ff=a13_0x1de0d1;Object[_0x46c8ff(0xe7)](_0x1fbc51,_0x46c8ff(0xb6),{'enumerable':!![],'value':_0x777c6a});}:function(_0x248383,_0x3f7a62){const _0x139899=a13_0x1de0d1;_0x248383[_0x139899(0xb6)]=_0x3f7a62;}),__importStar=this&&this[a13_0x1de0d1(0xdd)]||(function(){var _0x598c33=function(_0x153dd5){return _0x598c33=Object['getOwnPropertyNames']||function(_0x806cfa){const _0x2840ac=a13_0x2384;var _0x15dec3=[];for(var _0x2d9330 in _0x806cfa)if(Object[_0x2840ac(0xd8)][_0x2840ac(0xa5)][_0x2840ac(0xc2)](_0x806cfa,_0x2d9330))_0x15dec3[_0x15dec3[_0x2840ac(0xeb)]]=_0x2d9330;return _0x15dec3;},_0x598c33(_0x153dd5);};return function(_0x2fff9d){const _0x4a272a=a13_0x2384;if(_0x2fff9d&&_0x2fff9d[_0x4a272a(0x8f)])return _0x2fff9d;var _0x1cd1d4={};if(_0x2fff9d!=null){for(var _0x1b5608=_0x598c33(_0x2fff9d),_0x172d38=0x0;_0x172d38<_0x1b5608[_0x4a272a(0xeb)];_0x172d38++)if(_0x1b5608[_0x172d38]!==_0x4a272a(0xb6))__createBinding(_0x1cd1d4,_0x2fff9d,_0x1b5608[_0x172d38]);}return __setModuleDefault(_0x1cd1d4,_0x2fff9d),_0x1cd1d4;};}()),__importDefault=this&&this[a13_0x1de0d1(0xa0)]||function(_0x532a78){return _0x532a78&&_0x532a78['__esModule']?_0x532a78:{'default':_0x532a78};};Object[a13_0x1de0d1(0xe7)](exports,a13_0x1de0d1(0x8f),{'value':!![]}),exports[a13_0x1de0d1(0x8c)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x1de0d1(0xaa)),database_1=__importDefault(require(a13_0x1de0d1(0xde)));class TestGatewayController{constructor(){const _0x369c9d=a13_0x1de0d1;this[_0x369c9d(0xec)]=async(_0x533301,_0x55d775,_0x386cea)=>{const _0x2e4687=_0x369c9d;try{const {paymentId:_0x2ce806}=_0x533301[_0x2e4687(0x8b)];console[_0x2e4687(0xae)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2ce806);const _0x5b1a29=await database_1[_0x2e4687(0xb6)][_0x2e4687(0xb8)][_0x2e4687(0xc4)]({'where':{'id':_0x2ce806},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5b1a29)return _0x55d775['status'](0x194)[_0x2e4687(0xdb)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5b1a29[_0x2e4687(0xa9)]!==_0x2e4687(0x77))return _0x55d775[_0x2e4687(0x84)](0x190)[_0x2e4687(0xdb)]({'success':![],'message':_0x2e4687(0xa7)});if(_0x5b1a29[_0x2e4687(0x84)]!==_0x2e4687(0x76))return _0x55d775[_0x2e4687(0x84)](0x190)[_0x2e4687(0xdb)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5b1a29[_0x2e4687(0x84)]+_0x2e4687(0x78)});_0x55d775['json']({'success':!![],'result':{'paymentId':_0x5b1a29['id'],'orderId':_0x5b1a29[_0x2e4687(0xda)],'amount':_0x5b1a29[_0x2e4687(0xb9)],'currency':_0x5b1a29[_0x2e4687(0xed)],'merchantName':_0x5b1a29[_0x2e4687(0x79)][_0x2e4687(0x7d)],'description':'Payment\x20to\x20'+_0x5b1a29[_0x2e4687(0x79)][_0x2e4687(0x7d)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x2e4687(0xb3),'expiryDate':_0x2e4687(0x93),'cvc':_0x2e4687(0xc8),'holderName':_0x2e4687(0x99)}}});}catch(_0xe4d1c8){_0x386cea(_0xe4d1c8);}},this[_0x369c9d(0xe8)]=async(_0xda2848,_0x1b95de,_0x3e6d88)=>{const _0x231ebc=_0x369c9d;try{const {paymentId:_0x57c6e4}=_0xda2848[_0x231ebc(0x8b)],_0x52631d=_0xda2848['body'];console[_0x231ebc(0xae)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x57c6e4);const _0x310d55=await database_1[_0x231ebc(0xb6)][_0x231ebc(0xb8)][_0x231ebc(0xc4)]({'where':{'id':_0x57c6e4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x310d55)return _0x1b95de[_0x231ebc(0x84)](0x194)[_0x231ebc(0xdb)]({'success':![],'message':_0x231ebc(0xa6)});if(_0x310d55['gateway']!==_0x231ebc(0x77))return _0x1b95de[_0x231ebc(0x84)](0x190)['json']({'success':![],'message':_0x231ebc(0xa7)});if(_0x310d55[_0x231ebc(0x84)]!==_0x231ebc(0x76))return _0x1b95de[_0x231ebc(0x84)](0x190)['json']({'success':![],'message':_0x231ebc(0xab)+_0x310d55[_0x231ebc(0x84)]+_0x231ebc(0x78)});const _0x44b7d7=await this[_0x231ebc(0xd1)][_0x231ebc(0xb0)]({'paymentId':_0x310d55['id'],'orderId':_0x310d55['gatewayOrderId']||_0x310d55['id'],'amount':_0x310d55[_0x231ebc(0xb9)],'currency':_0x310d55[_0x231ebc(0xed)],'cardData':_0x52631d});console[_0x231ebc(0xae)]('üß™\x20Test\x20Gateway\x20result:',_0x44b7d7);const _0x594194={'status':_0x44b7d7[_0x231ebc(0x84)],'updatedAt':new Date()};if(_0x44b7d7[_0x231ebc(0x84)]===_0x231ebc(0x92))_0x594194[_0x231ebc(0xe2)]=new Date(),_0x594194[_0x231ebc(0x82)]=_0x44b7d7[_0x231ebc(0x9c)];else _0x44b7d7[_0x231ebc(0x84)]==='FAILED'&&(_0x594194[_0x231ebc(0xe5)]=_0x44b7d7['failureReason']);const _0x3ba745=_0x52631d[_0x231ebc(0x9b)][_0x231ebc(0xc3)](/[\s-]/g,'');_0x594194[_0x231ebc(0xd5)]=_0x3ba745['slice'](-0x4),_0x594194[_0x231ebc(0xa4)]=_0x231ebc(0xc6),await database_1[_0x231ebc(0xb6)][_0x231ebc(0xb8)][_0x231ebc(0xcb)]({'where':{'id':_0x310d55['id']},'data':_0x594194});if(_0x44b7d7[_0x231ebc(0x84)]===_0x231ebc(0x92)&&_0x310d55['paymentLinkId']){console[_0x231ebc(0xae)](_0x231ebc(0xb4)+_0x310d55['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x231ebc(0xb6)]['$transaction'](async _0x63a122=>{const _0x4aae4f=_0x231ebc,_0x2a5de3=await _0x63a122[_0x4aae4f(0xf0)][_0x4aae4f(0xc4)]({'where':{'id':_0x310d55[_0x4aae4f(0x9f)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2a5de3){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x2a5de3['id']+':\x20type='+_0x2a5de3[_0x4aae4f(0xd0)]+_0x4aae4f(0x95)+_0x2a5de3[_0x4aae4f(0xe9)]+_0x4aae4f(0x98)+_0x2a5de3[_0x4aae4f(0x84)]);const _0x3d938b=_0x2a5de3[_0x4aae4f(0xe9)]+0x1,_0x1cc987=_0x2a5de3['type']===_0x4aae4f(0xee)?_0x4aae4f(0xc9):_0x2a5de3[_0x4aae4f(0x84)];await _0x63a122[_0x4aae4f(0xf0)][_0x4aae4f(0xcb)]({'where':{'id':_0x310d55[_0x4aae4f(0x9f)]},'data':{'currentPayments':_0x3d938b,'status':_0x1cc987,'updatedAt':new Date()}}),console[_0x4aae4f(0xae)](_0x4aae4f(0xb1)+_0x2a5de3['id']+_0x4aae4f(0xd6)+_0x2a5de3['currentPayments']+_0x4aae4f(0xe3)+_0x3d938b+_0x4aae4f(0x98)+_0x2a5de3[_0x4aae4f(0x84)]+_0x4aae4f(0xe3)+_0x1cc987);}else console[_0x4aae4f(0xae)]('‚ùå\x20Payment\x20link\x20'+_0x310d55[_0x4aae4f(0x9f)]+'\x20not\x20found');});}catch(_0x160b17){console['error'](_0x231ebc(0x97),_0x160b17);}}await database_1['default'][_0x231ebc(0xa2)][_0x231ebc(0xd7)]({'data':{'paymentId':_0x310d55['id'],'shopId':_0x310d55['shopId'],'event':_0x231ebc(0x8e)+_0x44b7d7['status'][_0x231ebc(0xcd)](),'statusCode':0xc8,'responseBody':JSON[_0x231ebc(0x86)]({'oldStatus':'PENDING','newStatus':_0x44b7d7['status'],'transactionId':_0x44b7d7['transactionId'],'failureReason':_0x44b7d7[_0x231ebc(0xd9)],'processedAt':new Date()[_0x231ebc(0xbd)]()})}}),await this['sendShopWebhook'](_0x310d55,_0x44b7d7[_0x231ebc(0x84)],_0x44b7d7[_0x231ebc(0x9c)],_0x44b7d7[_0x231ebc(0xd9)]),await this[_0x231ebc(0xca)](_0x310d55,_0x44b7d7[_0x231ebc(0x84)]),console[_0x231ebc(0xae)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x57c6e4+'\x20processed:\x20'+_0x44b7d7['status']),_0x44b7d7[_0x231ebc(0x84)]==='PAID'?_0x1b95de[_0x231ebc(0xdb)]({'success':!![],'message':_0x231ebc(0xc1),'result':{'status':_0x231ebc(0x92),'transactionId':_0x44b7d7['transactionId'],'redirectUrl':_0x310d55[_0x231ebc(0x90)]}}):_0x1b95de[_0x231ebc(0x84)](0x190)[_0x231ebc(0xdb)]({'success':![],'message':_0x231ebc(0xe4),'result':{'status':'FAILED','failureReason':_0x44b7d7[_0x231ebc(0xd9)],'redirectUrl':_0x310d55[_0x231ebc(0x7a)]}});}catch(_0x416562){_0x3e6d88(_0x416562);}},this[_0x369c9d(0xd1)]=new testGatewayService_1[(_0x369c9d(0xb2))](),this[_0x369c9d(0x94)]=new webhookService_1[(_0x369c9d(0xad))]();}async['sendShopWebhook'](_0x4d4b5a,_0x50b1dd,_0x11c4d6,_0xcfbb94){const _0x1b650d=a13_0x1de0d1,_0x6ba3e0=Date[_0x1b650d(0xce)]();try{const _0x218071=_0x4d4b5a[_0x1b650d(0x79)],_0x6898c2=_0x218071['settings'];if(!_0x6898c2?.[_0x1b650d(0x7e)]){console[_0x1b650d(0xae)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x218071['id']);return;}const _0x3d0e42=_0x50b1dd===_0x1b650d(0x92)?_0x1b650d(0xdf):_0x1b650d(0xc5);let _0x995742=[];if(_0x6898c2[_0x1b650d(0xe0)])try{_0x995742=Array['isArray'](_0x6898c2[_0x1b650d(0xe0)])?_0x6898c2['webhookEvents']:JSON[_0x1b650d(0xcc)](_0x6898c2[_0x1b650d(0xe0)]);}catch(_0x2b56d8){console[_0x1b650d(0xd2)](_0x1b650d(0x7c),_0x2b56d8),_0x995742=[];}if(!_0x995742[_0x1b650d(0xbc)](_0x3d0e42)){console[_0x1b650d(0xae)](_0x1b650d(0x9a)+_0x3d0e42+_0x1b650d(0xef)+_0x218071['id']);return;}const _0x174b24={'event':_0x3d0e42,'payment':{'id':_0x4d4b5a['id'],'order_id':_0x4d4b5a[_0x1b650d(0xe6)],'gateway_order_id':_0x4d4b5a['gatewayOrderId'],'gateway':_0x1b650d(0xea),'amount':_0x4d4b5a[_0x1b650d(0xb9)],'currency':_0x4d4b5a[_0x1b650d(0xed)],'status':_0x50b1dd['toLowerCase'](),'customer_email':_0x4d4b5a[_0x1b650d(0xbf)],'customer_name':_0x4d4b5a[_0x1b650d(0x80)],'transaction_id':_0x11c4d6,'failure_message':_0xcfbb94,'created_at':_0x4d4b5a[_0x1b650d(0x85)],'updated_at':new Date()}},_0x306855=await fetch(_0x6898c2[_0x1b650d(0x7e)],{'method':_0x1b650d(0xb7),'headers':{'Content-Type':_0x1b650d(0xe1),'User-Agent':_0x1b650d(0x81)},'body':JSON[_0x1b650d(0x86)](_0x174b24)}),_0x1e0e44=Date[_0x1b650d(0xce)]()-_0x6ba3e0;console[_0x1b650d(0xae)](_0x1b650d(0xba)+_0x6898c2[_0x1b650d(0x7e)]+_0x1b650d(0x88)+_0x306855[_0x1b650d(0x84)]+'\x20('+_0x1e0e44+_0x1b650d(0xbb));}catch(_0x8cbdde){console['error'](_0x1b650d(0x8d),_0x8cbdde);}}async[a13_0x1de0d1(0xca)](_0x228fce,_0x4c4979){const _0x365be7=a13_0x1de0d1;try{const {telegramBotService:_0x26edb8}=await Promise['resolve']()[_0x365be7(0x7b)](()=>__importStar(require('../services/telegramBotService'))),_0x2ea734={'PAID':_0x365be7(0xb5),'FAILED':_0x365be7(0x96)},_0x4e414b=_0x2ea734[_0x4c4979];if(!_0x4e414b)return;await _0x26edb8[_0x365be7(0xbe)](_0x228fce[_0x365be7(0x91)],_0x228fce,_0x4e414b);}catch(_0x13353b){console[_0x365be7(0xd2)](_0x365be7(0x83),_0x13353b);}}}function a13_0xfbe3(){const _0x3b132e=['cardNumber','transactionId','getOwnPropertyDescriptor','1475235tHCIhs','paymentLinkId','__importDefault','__createBinding','webhookLog','15198XCqnii','paymentMethod','hasOwnProperty','Payment\x20not\x20found','Payment\x20is\x20not\x20for\x20test\x20gateway','19108496AhDJBv','gateway','../services/webhookService','Payment\x20status\x20is\x20','__setModuleDefault','WebhookService','log','get','processCardPayment','‚úÖ\x20Payment\x20link\x20','TestGatewayService','Any\x20other\x20card\x20number','üìà\x20Test\x20Gateway:\x20Payment\x20','paid','default','POST','payment','amount','Test\x20Gateway\x20webhook\x20sent\x20to\x20','ms)','includes','toISOString','sendPaymentNotification','customerEmail','1486608DtpHcY','Payment\x20processed\x20successfully','call','replace','findUnique','payment.failed','test_card','configurable','Any\x203-4\x20digits','COMPLETED','sendPaymentStatusNotification','update','parse','toLowerCase','now','773ZoejNX','type','testGatewayService','error','8093925HbFken','586NXKXIp','cardLast4','\x20updated:\x20currentPayments=','create','prototype','failureReason','gatewayOrderId','json','200IhDZFr','__importStar','../config/database','payment.success','webhookEvents','application/json','paidAt','\x20->\x20','Payment\x20failed','failureMessage','orderId','defineProperty','processCard','currentPayments','0000','length','getPaymentForm','currency','SINGLE','\x20not\x20enabled\x20for\x20shop\x20','paymentLink','PENDING','test_gateway',',\x20cannot\x20process','shop','failUrl','then','Error\x20parsing\x20webhook\x20events:','name','webhookUrl','2055lehVXC','customerName','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','gatewayPaymentId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','status','createdAt','stringify','19518vsGvaU','\x20with\x20status\x20','40GINmfz','writable','params','TestGatewayController','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','test_gateway_','__esModule','successUrl','shopId','PAID','Any\x20future\x20date\x20(MM/YY)','webhookService',',\x20currentPayments=','failed','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',',\x20status=','Any\x20name','Webhook\x20event\x20'];a13_0xfbe3=function(){return _0x3b132e;};return a13_0xfbe3();}exports['TestGatewayController']=TestGatewayController;