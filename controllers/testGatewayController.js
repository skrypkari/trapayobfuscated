'use strict';function a13_0x3679(_0x1acebf,_0x28a56d){const _0x5cfecf=a13_0x5cfe();return a13_0x3679=function(_0x3679dd,_0x144bdd){_0x3679dd=_0x3679dd-0x112;let _0x3b1224=_0x5cfecf[_0x3679dd];return _0x3b1224;},a13_0x3679(_0x1acebf,_0x28a56d);}const a13_0x3bc2c8=a13_0x3679;(function(_0x5b9901,_0x147cef){const _0x4c9742=a13_0x3679,_0x17c32e=_0x5b9901();while(!![]){try{const _0x439038=-parseInt(_0x4c9742(0x156))/0x1+-parseInt(_0x4c9742(0x13c))/0x2+-parseInt(_0x4c9742(0x171))/0x3*(-parseInt(_0x4c9742(0x162))/0x4)+parseInt(_0x4c9742(0x155))/0x5*(parseInt(_0x4c9742(0x12a))/0x6)+parseInt(_0x4c9742(0x117))/0x7+parseInt(_0x4c9742(0x168))/0x8+parseInt(_0x4c9742(0x154))/0x9*(-parseInt(_0x4c9742(0x15a))/0xa);if(_0x439038===_0x147cef)break;else _0x17c32e['push'](_0x17c32e['shift']());}catch(_0x59c412){_0x17c32e['push'](_0x17c32e['shift']());}}}(a13_0x5cfe,0xe06e4));var __createBinding=this&&this[a13_0x3bc2c8(0x16b)]||(Object[a13_0x3bc2c8(0x160)]?function(_0x10800c,_0x2806ba,_0x382ef5,_0x4015a7){const _0x4e874f=a13_0x3bc2c8;if(_0x4015a7===undefined)_0x4015a7=_0x382ef5;var _0x516221=Object[_0x4e874f(0x11e)](_0x2806ba,_0x382ef5);(!_0x516221||(_0x4e874f(0x157)in _0x516221?!_0x2806ba[_0x4e874f(0x128)]:_0x516221['writable']||_0x516221['configurable']))&&(_0x516221={'enumerable':!![],'get':function(){return _0x2806ba[_0x382ef5];}}),Object[_0x4e874f(0x14d)](_0x10800c,_0x4015a7,_0x516221);}:function(_0x278690,_0x4de506,_0x16b3c8,_0x4fac65){if(_0x4fac65===undefined)_0x4fac65=_0x16b3c8;_0x278690[_0x4fac65]=_0x4de506[_0x16b3c8];}),__setModuleDefault=this&&this[a13_0x3bc2c8(0x179)]||(Object['create']?function(_0x45992a,_0x9e2f38){const _0x463789=a13_0x3bc2c8;Object[_0x463789(0x14d)](_0x45992a,_0x463789(0x17c),{'enumerable':!![],'value':_0x9e2f38});}:function(_0x5c4eea,_0x386091){const _0x446dc6=a13_0x3bc2c8;_0x5c4eea[_0x446dc6(0x17c)]=_0x386091;}),__importStar=this&&this[a13_0x3bc2c8(0x12e)]||(function(){var _0xcf83f8=function(_0x4f19e3){return _0xcf83f8=Object['getOwnPropertyNames']||function(_0x49341e){const _0x3c6938=a13_0x3679;var _0x2d958a=[];for(var _0x15688e in _0x49341e)if(Object[_0x3c6938(0x15b)][_0x3c6938(0x12c)][_0x3c6938(0x165)](_0x49341e,_0x15688e))_0x2d958a[_0x2d958a[_0x3c6938(0x148)]]=_0x15688e;return _0x2d958a;},_0xcf83f8(_0x4f19e3);};return function(_0x1bfe21){const _0x3a5115=a13_0x3679;if(_0x1bfe21&&_0x1bfe21[_0x3a5115(0x128)])return _0x1bfe21;var _0x14a5ed={};if(_0x1bfe21!=null){for(var _0x2043e0=_0xcf83f8(_0x1bfe21),_0x48d2f9=0x0;_0x48d2f9<_0x2043e0['length'];_0x48d2f9++)if(_0x2043e0[_0x48d2f9]!==_0x3a5115(0x17c))__createBinding(_0x14a5ed,_0x1bfe21,_0x2043e0[_0x48d2f9]);}return __setModuleDefault(_0x14a5ed,_0x1bfe21),_0x14a5ed;};}()),__importDefault=this&&this[a13_0x3bc2c8(0x170)]||function(_0x1296b4){const _0x2f4e2b=a13_0x3bc2c8;return _0x1296b4&&_0x1296b4[_0x2f4e2b(0x128)]?_0x1296b4:{'default':_0x1296b4};};Object[a13_0x3bc2c8(0x14d)](exports,a13_0x3bc2c8(0x128),{'value':!![]}),exports[a13_0x3bc2c8(0x12d)]=void 0x0;const testGatewayService_1=require(a13_0x3bc2c8(0x151)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x3bc2c8(0x13a)));class TestGatewayController{constructor(){const _0x3138b9=a13_0x3bc2c8;this[_0x3138b9(0x15d)]=async(_0x25447b,_0x100c07,_0x49491c)=>{const _0x3b22f0=_0x3138b9;try{const {paymentId:_0x3b5126}=_0x25447b['params'];console[_0x3b22f0(0x172)](_0x3b22f0(0x139)+_0x3b5126);const _0x16e69f=await database_1[_0x3b22f0(0x17c)][_0x3b22f0(0x173)][_0x3b22f0(0x125)]({'where':{'id':_0x3b5126},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x16e69f)return _0x100c07[_0x3b22f0(0x16c)](0x194)[_0x3b22f0(0x17b)]({'success':![],'message':_0x3b22f0(0x163)});if(_0x16e69f[_0x3b22f0(0x144)]!=='test_gateway')return _0x100c07[_0x3b22f0(0x16c)](0x190)[_0x3b22f0(0x17b)]({'success':![],'message':_0x3b22f0(0x11d)});if(_0x16e69f[_0x3b22f0(0x16c)]!==_0x3b22f0(0x133))return _0x100c07[_0x3b22f0(0x16c)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x16e69f[_0x3b22f0(0x16c)]+_0x3b22f0(0x159)});_0x100c07[_0x3b22f0(0x17b)]({'success':!![],'result':{'paymentId':_0x16e69f['id'],'orderId':_0x16e69f[_0x3b22f0(0x161)],'amount':_0x16e69f['amount'],'currency':_0x16e69f[_0x3b22f0(0x130)],'merchantName':_0x16e69f[_0x3b22f0(0x150)]['name'],'description':_0x3b22f0(0x132)+_0x16e69f[_0x3b22f0(0x150)][_0x3b22f0(0x120)],'testInstructions':{'successCard':_0x3b22f0(0x166),'failureCard':_0x3b22f0(0x146),'expiryDate':_0x3b22f0(0x127),'cvc':_0x3b22f0(0x174),'holderName':_0x3b22f0(0x164)}}});}catch(_0x5a6966){_0x49491c(_0x5a6966);}},this['processCard']=async(_0x187b94,_0x124da4,_0x35ab20)=>{const _0x613803=_0x3138b9;try{const {paymentId:_0x1e42d4}=_0x187b94[_0x613803(0x141)],_0x48e2b8=_0x187b94[_0x613803(0x14b)];console[_0x613803(0x172)](_0x613803(0x17a)+_0x1e42d4);const _0x63b674=await database_1[_0x613803(0x17c)]['payment']['findUnique']({'where':{'id':_0x1e42d4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x63b674)return _0x124da4[_0x613803(0x16c)](0x194)[_0x613803(0x17b)]({'success':![],'message':_0x613803(0x163)});if(_0x63b674['gateway']!==_0x613803(0x13b))return _0x124da4[_0x613803(0x16c)](0x190)['json']({'success':![],'message':_0x613803(0x11d)});if(_0x63b674[_0x613803(0x16c)]!=='PENDING')return _0x124da4[_0x613803(0x16c)](0x190)['json']({'success':![],'message':_0x613803(0x129)+_0x63b674['status']+_0x613803(0x159)});const _0x1e3f4a=await this['testGatewayService'][_0x613803(0x178)]({'paymentId':_0x63b674['id'],'orderId':_0x63b674['gatewayOrderId']||_0x63b674['id'],'amount':_0x63b674[_0x613803(0x15c)],'currency':_0x63b674[_0x613803(0x130)],'cardData':_0x48e2b8});console[_0x613803(0x172)](_0x613803(0x14f),_0x1e3f4a);const _0x563cb4={'status':_0x1e3f4a[_0x613803(0x16c)],'updatedAt':new Date()};if(_0x1e3f4a[_0x613803(0x16c)]===_0x613803(0x121))_0x563cb4[_0x613803(0x118)]=new Date(),_0x563cb4['gatewayPaymentId']=_0x1e3f4a['transactionId'];else _0x1e3f4a[_0x613803(0x16c)]===_0x613803(0x135)&&(_0x563cb4[_0x613803(0x12b)]=_0x1e3f4a['failureReason']);const _0x16787e=_0x48e2b8['cardNumber']['replace'](/[\s-]/g,'');_0x563cb4[_0x613803(0x13e)]=_0x16787e[_0x613803(0x11a)](-0x4),_0x563cb4[_0x613803(0x112)]=_0x613803(0x115),await database_1[_0x613803(0x17c)]['payment'][_0x613803(0x169)]({'where':{'id':_0x63b674['id']},'data':_0x563cb4}),await database_1[_0x613803(0x17c)][_0x613803(0x13d)][_0x613803(0x160)]({'data':{'paymentId':_0x63b674['id'],'shopId':_0x63b674[_0x613803(0x17d)],'event':'test_gateway_'+_0x1e3f4a['status'][_0x613803(0x15e)](),'statusCode':0xc8,'responseBody':JSON[_0x613803(0x11b)]({'oldStatus':_0x613803(0x133),'newStatus':_0x1e3f4a[_0x613803(0x16c)],'transactionId':_0x1e3f4a[_0x613803(0x116)],'failureReason':_0x1e3f4a['failureReason'],'processedAt':new Date()[_0x613803(0x153)]()})}}),await this[_0x613803(0x136)](_0x63b674,_0x1e3f4a['status'],_0x1e3f4a[_0x613803(0x116)],_0x1e3f4a[_0x613803(0x113)]),await this[_0x613803(0x16f)](_0x63b674,_0x1e3f4a['status']),console[_0x613803(0x172)](_0x613803(0x16d)+_0x1e42d4+_0x613803(0x137)+_0x1e3f4a[_0x613803(0x16c)]),_0x1e3f4a[_0x613803(0x16c)]===_0x613803(0x121)?_0x124da4[_0x613803(0x17b)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x1e3f4a[_0x613803(0x116)],'redirectUrl':_0x63b674['successUrl']}}):_0x124da4[_0x613803(0x16c)](0x190)[_0x613803(0x17b)]({'success':![],'message':_0x613803(0x123),'result':{'status':_0x613803(0x135),'failureReason':_0x1e3f4a[_0x613803(0x113)],'redirectUrl':_0x63b674[_0x613803(0x138)]}});}catch(_0xb9edd7){_0x35ab20(_0xb9edd7);}},this[_0x3138b9(0x126)]=new testGatewayService_1[(_0x3138b9(0x12f))](),this[_0x3138b9(0x176)]=new webhookService_1[(_0x3138b9(0x119))]();}async[a13_0x3bc2c8(0x136)](_0x5b4324,_0x49c214,_0x437ffe,_0x835e5b){const _0x427338=a13_0x3bc2c8,_0x5797de=Date[_0x427338(0x142)]();try{const _0x14c1a6=_0x5b4324[_0x427338(0x150)],_0x53d28b=_0x14c1a6[_0x427338(0x140)];if(!_0x53d28b?.['webhookUrl']){console['log'](_0x427338(0x158)+_0x14c1a6['id']);return;}const _0x528bae=_0x49c214===_0x427338(0x121)?'payment.success':_0x427338(0x11c);let _0x174a78=[];if(_0x53d28b[_0x427338(0x167)])try{_0x174a78=Array[_0x427338(0x134)](_0x53d28b[_0x427338(0x167)])?_0x53d28b[_0x427338(0x167)]:JSON[_0x427338(0x14e)](_0x53d28b[_0x427338(0x167)]);}catch(_0x4c84c6){console[_0x427338(0x14a)](_0x427338(0x149),_0x4c84c6),_0x174a78=[];}if(!_0x174a78[_0x427338(0x145)](_0x528bae)){console[_0x427338(0x172)](_0x427338(0x147)+_0x528bae+'\x20not\x20enabled\x20for\x20shop\x20'+_0x14c1a6['id']);return;}const _0x4e0be2={'event':_0x528bae,'payment':{'id':_0x5b4324['id'],'order_id':_0x5b4324[_0x427338(0x124)],'gateway_order_id':_0x5b4324[_0x427338(0x161)],'gateway':_0x427338(0x122),'amount':_0x5b4324['amount'],'currency':_0x5b4324[_0x427338(0x130)],'status':_0x49c214['toLowerCase'](),'customer_email':_0x5b4324['customerEmail'],'customer_name':_0x5b4324[_0x427338(0x13f)],'transaction_id':_0x437ffe,'failure_message':_0x835e5b,'created_at':_0x5b4324['createdAt'],'updated_at':new Date()}},_0x57d890=await fetch(_0x53d28b[_0x427338(0x114)],{'method':'POST','headers':{'Content-Type':_0x427338(0x15f),'User-Agent':_0x427338(0x14c)},'body':JSON[_0x427338(0x11b)](_0x4e0be2)}),_0x20f43c=Date[_0x427338(0x142)]()-_0x5797de;console[_0x427338(0x172)](_0x427338(0x16a)+_0x53d28b[_0x427338(0x114)]+'\x20with\x20status\x20'+_0x57d890['status']+'\x20('+_0x20f43c+_0x427338(0x177));}catch(_0x3f3bb3){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x3f3bb3);}}async['sendPaymentStatusNotification'](_0xa51a16,_0x13337a){const _0x53ead6=a13_0x3bc2c8;try{const {telegramBotService:_0x409306}=await Promise[_0x53ead6(0x16e)]()[_0x53ead6(0x11f)](()=>__importStar(require(_0x53ead6(0x175)))),_0x57bdb0={'PAID':_0x53ead6(0x143),'FAILED':_0x53ead6(0x152)},_0x1be341=_0x57bdb0[_0x13337a];if(!_0x1be341)return;await _0x409306['sendPaymentNotification'](_0xa51a16[_0x53ead6(0x17d)],_0xa51a16,_0x1be341);}catch(_0x3d4cd9){console[_0x53ead6(0x14a)](_0x53ead6(0x131),_0x3d4cd9);}}}function a13_0x5cfe(){const _0x1df5cf=['webhookService','ms)','processCardPayment','__setModuleDefault','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','json','default','shopId','paymentMethod','failureReason','webhookUrl','test_card','transactionId','11038965qywlLj','paidAt','WebhookService','slice','stringify','payment.failed','Payment\x20is\x20not\x20for\x20test\x20gateway','getOwnPropertyDescriptor','then','name','PAID','0000','Payment\x20failed','orderId','findUnique','testGatewayService','Any\x20future\x20date\x20(MM/YY)','__esModule','Payment\x20status\x20is\x20','16314HCIEOd','failureMessage','hasOwnProperty','TestGatewayController','__importStar','TestGatewayService','currency','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20to\x20','PENDING','isArray','FAILED','sendShopWebhook','\x20processed:\x20','failUrl','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','../config/database','test_gateway','291280ReArLT','webhookLog','cardLast4','customerName','settings','params','now','paid','gateway','includes','Any\x20other\x20card\x20number','Webhook\x20event\x20','length','Error\x20parsing\x20webhook\x20events:','error','body','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','defineProperty','parse','🧪\x20Test\x20Gateway\x20result:','shop','../services/gateways/testGatewayService','failed','toISOString','29331468HIurXM','2685VIgHmX','391308kmcXFz','get','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',',\x20cannot\x20process','10SQkuCD','prototype','amount','getPaymentForm','toLowerCase','application/json','create','gatewayOrderId','856FyzqyJ','Payment\x20not\x20found','Any\x20name','call','4242\x204242\x204242\x204242','webhookEvents','10588576zEFZRY','update','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__createBinding','status','✅\x20Test\x20Gateway\x20payment\x20','resolve','sendPaymentStatusNotification','__importDefault','4971PsaNXd','log','payment','Any\x203-4\x20digits','../services/telegramBotService'];a13_0x5cfe=function(){return _0x1df5cf;};return a13_0x5cfe();}exports[a13_0x3bc2c8(0x12d)]=TestGatewayController;