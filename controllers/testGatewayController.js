'use strict';function a21_0x6ede(_0x47a1b1,_0x55a057){_0x47a1b1=_0x47a1b1-0x13e;const _0x43130e=a21_0x4313();let _0x6ede24=_0x43130e[_0x47a1b1];return _0x6ede24;}const a21_0x567a99=a21_0x6ede;(function(_0x394b43,_0x56648b){const _0x251805=a21_0x6ede,_0x3c12e3=_0x394b43();while(!![]){try{const _0x47422b=-parseInt(_0x251805(0x1af))/0x1+-parseInt(_0x251805(0x148))/0x2*(-parseInt(_0x251805(0x143))/0x3)+parseInt(_0x251805(0x14b))/0x4*(-parseInt(_0x251805(0x1b3))/0x5)+parseInt(_0x251805(0x198))/0x6*(parseInt(_0x251805(0x18e))/0x7)+-parseInt(_0x251805(0x179))/0x8+-parseInt(_0x251805(0x182))/0x9+parseInt(_0x251805(0x173))/0xa;if(_0x47422b===_0x56648b)break;else _0x3c12e3['push'](_0x3c12e3['shift']());}catch(_0x306d9a){_0x3c12e3['push'](_0x3c12e3['shift']());}}}(a21_0x4313,0xb84cb));var __createBinding=this&&this[a21_0x567a99(0x19a)]||(Object[a21_0x567a99(0x167)]?function(_0xb99167,_0x2716eb,_0x5e40b7,_0x4d45b2){const _0x19da2c=a21_0x567a99;if(_0x4d45b2===undefined)_0x4d45b2=_0x5e40b7;var _0x42417a=Object[_0x19da2c(0x140)](_0x2716eb,_0x5e40b7);(!_0x42417a||(_0x19da2c(0x17b)in _0x42417a?!_0x2716eb['__esModule']:_0x42417a['writable']||_0x42417a[_0x19da2c(0x18a)]))&&(_0x42417a={'enumerable':!![],'get':function(){return _0x2716eb[_0x5e40b7];}}),Object[_0x19da2c(0x18d)](_0xb99167,_0x4d45b2,_0x42417a);}:function(_0x5c52c4,_0x3dfed8,_0x3facd4,_0x270f53){if(_0x270f53===undefined)_0x270f53=_0x3facd4;_0x5c52c4[_0x270f53]=_0x3dfed8[_0x3facd4];}),__setModuleDefault=this&&this[a21_0x567a99(0x1a1)]||(Object['create']?function(_0x2ac718,_0x3d49fe){const _0x3499ab=a21_0x567a99;Object[_0x3499ab(0x18d)](_0x2ac718,_0x3499ab(0x19e),{'enumerable':!![],'value':_0x3d49fe});}:function(_0x98dee0,_0x446bd3){const _0x3eb412=a21_0x567a99;_0x98dee0[_0x3eb412(0x19e)]=_0x446bd3;}),__importStar=this&&this[a21_0x567a99(0x17d)]||(function(){var _0x3e0fc3=function(_0x427679){const _0x189f07=a21_0x6ede;return _0x3e0fc3=Object[_0x189f07(0x186)]||function(_0x1c6e70){const _0x47647a=_0x189f07;var _0x245c63=[];for(var _0xd1f6b in _0x1c6e70)if(Object[_0x47647a(0x141)]['hasOwnProperty'][_0x47647a(0x16d)](_0x1c6e70,_0xd1f6b))_0x245c63[_0x245c63[_0x47647a(0x1b2)]]=_0xd1f6b;return _0x245c63;},_0x3e0fc3(_0x427679);};return function(_0x5f5e05){const _0x53fe99=a21_0x6ede;if(_0x5f5e05&&_0x5f5e05[_0x53fe99(0x174)])return _0x5f5e05;var _0x141340={};if(_0x5f5e05!=null){for(var _0x92525f=_0x3e0fc3(_0x5f5e05),_0x4ef706=0x0;_0x4ef706<_0x92525f[_0x53fe99(0x1b2)];_0x4ef706++)if(_0x92525f[_0x4ef706]!==_0x53fe99(0x19e))__createBinding(_0x141340,_0x5f5e05,_0x92525f[_0x4ef706]);}return __setModuleDefault(_0x141340,_0x5f5e05),_0x141340;};}()),__importDefault=this&&this[a21_0x567a99(0x1b9)]||function(_0x1feb78){const _0x2bc09b=a21_0x567a99;return _0x1feb78&&_0x1feb78[_0x2bc09b(0x174)]?_0x1feb78:{'default':_0x1feb78};};Object[a21_0x567a99(0x18d)](exports,a21_0x567a99(0x174),{'value':!![]}),exports['TestGatewayController']=void 0x0;function a21_0x4313(){const _0x105e6f=['ðŸ§ª\x20Webhook\x20payload:','sendPaymentStatusNotification','âš ï¸\x20Webhook\x20event\x20','type','createdAt','failureReason','findUnique','failed','sha256','paid','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','...','failUrl','TestGatewayController','../config/database','Payment\x20processed\x20successfully','not\x20configured','TestGatewayService','amount','ðŸ“ˆ\x20Found\x20payment\x20link\x20','0000','status','gatewayOrderId','4242\x204242\x204242\x204242','create','createHmac','hex','resolve','testGatewayService','toLowerCase','call','ðŸ§ª\x20Test\x20Gateway\x20result:','ms)','isArray','paymentLinkId','cardLast4','25790790QkRxMb','__esModule',':\x20type=','Any\x20future\x20date\x20(MM/YY)','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','stringify','7525696ZpcIVv','processCard','get','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','__importStar','body','secretKey','Any\x20name','Error\x20parsing\x20webhook\x20events:','2515536CPmzaw','paymentMethod','webhookService','COMPLETED','getOwnPropertyNames','ðŸ§ª\x20Sending\x20webhook\x20to\x20','update','Payment\x20not\x20found','configurable','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','digest','defineProperty','581QQyPbb','webhookEvents','\x20not\x20found','PAID','gateway','Payment\x20failed','Payment\x20System/1.0\x20(Test\x20Gateway)','slice','paidAt','payment.success','40098XPzcSR','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','__createBinding','toISOString','transactionId','âœ…\x20Test\x20Gateway\x20payment\x20','default','settings','âœ…\x20Payment\x20link\x20','__setModuleDefault',',\x20cannot\x20process','customerEmail','log','currency','webhookLog','customerName','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20status\x20is\x20','json','shop','then','PENDING','1067515kZgkXh','shopId','$transaction','length','1120KDXCmn','gatewayPaymentId','processCardPayment','payment','FAILED','error','__importDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','cardNumber','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getOwnPropertyDescriptor','prototype','test_gateway','6IHluwU','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20to\x20','webhookUrl','successUrl','1067158rclrsE','Any\x203-4\x20digits','currentPayments','20684gmSOjr','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20',',\x20webhookUrl=','now'];a21_0x4313=function(){return _0x105e6f;};return a21_0x4313();}const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a21_0x567a99(0x15d)));class TestGatewayController{constructor(){const _0x5ada7c=a21_0x567a99;this['getPaymentForm']=async(_0x2de588,_0x4986ea,_0x33a771)=>{const _0x454ef5=a21_0x6ede;try{const {paymentId:_0x4d290f}=_0x2de588['params'];console[_0x454ef5(0x1a4)](_0x454ef5(0x14c)+_0x4d290f);const _0x4d5fcc=await database_1[_0x454ef5(0x19e)]['payment']['findUnique']({'where':{'id':_0x4d290f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4d5fcc)return _0x4986ea[_0x454ef5(0x164)](0x194)[_0x454ef5(0x1ab)]({'success':![],'message':_0x454ef5(0x189)});if(_0x4d5fcc[_0x454ef5(0x192)]!==_0x454ef5(0x142))return _0x4986ea[_0x454ef5(0x164)](0x190)[_0x454ef5(0x1ab)]({'success':![],'message':_0x454ef5(0x1ba)});if(_0x4d5fcc[_0x454ef5(0x164)]!==_0x454ef5(0x1ae))return _0x4986ea[_0x454ef5(0x164)](0x190)['json']({'success':![],'message':_0x454ef5(0x1aa)+_0x4d5fcc[_0x454ef5(0x164)]+_0x454ef5(0x1a2)});_0x4986ea[_0x454ef5(0x1ab)]({'success':!![],'result':{'paymentId':_0x4d5fcc['id'],'orderId':_0x4d5fcc['gatewayOrderId'],'amount':_0x4d5fcc[_0x454ef5(0x161)],'currency':_0x4d5fcc[_0x454ef5(0x1a5)],'merchantName':_0x4d5fcc[_0x454ef5(0x1ac)]['name'],'description':_0x454ef5(0x145)+_0x4d5fcc['shop']['name'],'testInstructions':{'successCard':_0x454ef5(0x166),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x454ef5(0x176),'cvc':_0x454ef5(0x149),'holderName':_0x454ef5(0x180)}}});}catch(_0x48fd3e){_0x33a771(_0x48fd3e);}},this[_0x5ada7c(0x17a)]=async(_0x266f52,_0x4530ef,_0x3ea56a)=>{const _0xdf4e4b=_0x5ada7c;try{const {paymentId:_0x1ef96f}=_0x266f52['params'],_0x454ef2=_0x266f52[_0xdf4e4b(0x17e)];console[_0xdf4e4b(0x1a4)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1ef96f);const _0x19de64=await database_1[_0xdf4e4b(0x19e)]['payment'][_0xdf4e4b(0x155)]({'where':{'id':_0x1ef96f},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x19de64)return _0x4530ef['status'](0x194)[_0xdf4e4b(0x1ab)]({'success':![],'message':_0xdf4e4b(0x189)});if(_0x19de64[_0xdf4e4b(0x192)]!==_0xdf4e4b(0x142))return _0x4530ef[_0xdf4e4b(0x164)](0x190)[_0xdf4e4b(0x1ab)]({'success':![],'message':_0xdf4e4b(0x1ba)});if(_0x19de64[_0xdf4e4b(0x164)]!==_0xdf4e4b(0x1ae))return _0x4530ef[_0xdf4e4b(0x164)](0x190)[_0xdf4e4b(0x1ab)]({'success':![],'message':_0xdf4e4b(0x1aa)+_0x19de64['status']+_0xdf4e4b(0x1a2)});const _0x56395a=await this['testGatewayService'][_0xdf4e4b(0x1b5)]({'paymentId':_0x19de64['id'],'orderId':_0x19de64[_0xdf4e4b(0x165)]||_0x19de64['id'],'amount':_0x19de64['amount'],'currency':_0x19de64[_0xdf4e4b(0x1a5)],'cardData':_0x454ef2});console[_0xdf4e4b(0x1a4)](_0xdf4e4b(0x16e),_0x56395a);const _0x1e050b={'status':_0x56395a[_0xdf4e4b(0x164)],'updatedAt':new Date()};if(_0x56395a['status']==='PAID')_0x1e050b[_0xdf4e4b(0x196)]=new Date(),_0x1e050b[_0xdf4e4b(0x1b4)]=_0x56395a[_0xdf4e4b(0x19c)];else _0x56395a[_0xdf4e4b(0x164)]===_0xdf4e4b(0x1b7)&&(_0x1e050b['failureMessage']=_0x56395a['failureReason']);const _0x555544=_0x454ef2[_0xdf4e4b(0x1bb)]['replace'](/[\s-]/g,'');_0x1e050b[_0xdf4e4b(0x172)]=_0x555544[_0xdf4e4b(0x195)](-0x4),_0x1e050b[_0xdf4e4b(0x183)]='test_card',await database_1['default'][_0xdf4e4b(0x1b6)]['update']({'where':{'id':_0x19de64['id']},'data':_0x1e050b});if(_0x56395a['status']===_0xdf4e4b(0x191)&&_0x19de64[_0xdf4e4b(0x171)]){console[_0xdf4e4b(0x1a4)]('ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20'+_0x19de64['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xdf4e4b(0x19e)][_0xdf4e4b(0x1b1)](async _0x4c9cb2=>{const _0x5749ab=_0xdf4e4b,_0x3ec25e=await _0x4c9cb2['paymentLink'][_0x5749ab(0x155)]({'where':{'id':_0x19de64[_0x5749ab(0x171)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3ec25e){console[_0x5749ab(0x1a4)](_0x5749ab(0x162)+_0x3ec25e['id']+_0x5749ab(0x175)+_0x3ec25e[_0x5749ab(0x152)]+',\x20currentPayments='+_0x3ec25e[_0x5749ab(0x14a)]+',\x20status='+_0x3ec25e['status']);const _0x2feae8=_0x3ec25e['currentPayments']+0x1,_0x374fc0=_0x3ec25e[_0x5749ab(0x152)]==='SINGLE'?_0x5749ab(0x185):_0x3ec25e[_0x5749ab(0x164)];await _0x4c9cb2['paymentLink'][_0x5749ab(0x188)]({'where':{'id':_0x19de64[_0x5749ab(0x171)]},'data':{'currentPayments':_0x2feae8,'status':_0x374fc0,'updatedAt':new Date()}}),console['log'](_0x5749ab(0x1a0)+_0x3ec25e['id']+'\x20updated:\x20currentPayments='+_0x3ec25e[_0x5749ab(0x14a)]+'\x20->\x20'+_0x2feae8+',\x20status='+_0x3ec25e[_0x5749ab(0x164)]+'\x20->\x20'+_0x374fc0);}else console['log']('âŒ\x20Payment\x20link\x20'+_0x19de64['paymentLinkId']+_0x5749ab(0x190));});}catch(_0x50353d){console[_0xdf4e4b(0x1b8)](_0xdf4e4b(0x17c),_0x50353d);}}await database_1['default'][_0xdf4e4b(0x1a6)]['create']({'data':{'paymentId':_0x19de64['id'],'shopId':_0x19de64['shopId'],'event':'test_gateway_'+_0x56395a[_0xdf4e4b(0x164)][_0xdf4e4b(0x16c)](),'statusCode':_0x56395a[_0xdf4e4b(0x164)]===_0xdf4e4b(0x191)?0xc8:0x190,'responseBody':JSON[_0xdf4e4b(0x178)]({'oldStatus':_0xdf4e4b(0x1ae),'newStatus':_0x56395a[_0xdf4e4b(0x164)],'transactionId':_0x56395a[_0xdf4e4b(0x19c)],'failureReason':_0x56395a[_0xdf4e4b(0x154)],'processedAt':new Date()[_0xdf4e4b(0x19b)]()})}}),console[_0xdf4e4b(0x1a4)](_0xdf4e4b(0x199)+_0x56395a[_0xdf4e4b(0x164)]+_0xdf4e4b(0x15a)),await this['sendShopWebhook'](_0x19de64,_0x56395a[_0xdf4e4b(0x164)],_0x56395a[_0xdf4e4b(0x19c)],_0x56395a[_0xdf4e4b(0x154)]),console[_0xdf4e4b(0x1a4)](_0xdf4e4b(0x18b)+_0x56395a['status']),console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20'+_0x56395a[_0xdf4e4b(0x164)]+_0xdf4e4b(0x15a)),await this['sendPaymentStatusNotification'](_0x19de64,_0x56395a[_0xdf4e4b(0x164)]),console[_0xdf4e4b(0x1a4)](_0xdf4e4b(0x13e)+_0x56395a['status']),console[_0xdf4e4b(0x1a4)](_0xdf4e4b(0x19d)+_0x1ef96f+'\x20processed:\x20'+_0x56395a[_0xdf4e4b(0x164)]),_0x56395a[_0xdf4e4b(0x164)]==='PAID'?_0x4530ef['json']({'success':!![],'message':_0xdf4e4b(0x15e),'result':{'status':'PAID','transactionId':_0x56395a['transactionId'],'redirectUrl':_0x19de64[_0xdf4e4b(0x147)]}}):_0x4530ef['status'](0x190)[_0xdf4e4b(0x1ab)]({'success':![],'message':_0xdf4e4b(0x193),'result':{'status':_0xdf4e4b(0x1b7),'failureReason':_0x56395a[_0xdf4e4b(0x154)],'redirectUrl':_0x19de64[_0xdf4e4b(0x15b)]}});}catch(_0x1a891a){_0x3ea56a(_0x1a891a);}},this[_0x5ada7c(0x16b)]=new testGatewayService_1[(_0x5ada7c(0x160))](),this[_0x5ada7c(0x184)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x5b2154,_0x703a91,_0x4a41dd,_0x511f14){const _0x482b00=a21_0x567a99,_0x8fa48a=Date[_0x482b00(0x14e)]();try{const _0xcd2796=_0x5b2154[_0x482b00(0x1ac)],_0x590eb2=_0xcd2796[_0x482b00(0x19f)];if(!_0x590eb2?.[_0x482b00(0x146)]){console[_0x482b00(0x1a4)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xcd2796['id']);return;}const _0x44c674=_0x703a91==='PAID'?_0x482b00(0x197):'payment.failed';console[_0x482b00(0x1a4)]('ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event='+_0x44c674+_0x482b00(0x14d)+(_0x590eb2[_0x482b00(0x146)]?'configured':_0x482b00(0x15f)));let _0x1188be=[];if(_0x590eb2['webhookEvents'])try{_0x1188be=Array[_0x482b00(0x170)](_0x590eb2[_0x482b00(0x18f)])?_0x590eb2[_0x482b00(0x18f)]:JSON['parse'](_0x590eb2['webhookEvents']);}catch(_0x58510f){console[_0x482b00(0x1b8)](_0x482b00(0x181),_0x58510f),_0x1188be=[];}console[_0x482b00(0x1a4)](_0x482b00(0x177),_0x1188be);if(!_0x1188be['includes'](_0x44c674)){console['log'](_0x482b00(0x151)+_0x44c674+_0x482b00(0x1a9)+_0xcd2796['id']);return;}const _0x257217={'event':_0x44c674,'payment':{'id':_0x5b2154['id'],'order_id':_0x5b2154['orderId'],'gateway_order_id':_0x5b2154[_0x482b00(0x165)],'gateway':_0x482b00(0x163),'amount':_0x5b2154[_0x482b00(0x161)],'currency':_0x5b2154[_0x482b00(0x1a5)],'status':_0x703a91[_0x482b00(0x16c)](),'customer_email':_0x5b2154[_0x482b00(0x1a3)],'customer_name':_0x5b2154[_0x482b00(0x1a7)],'transaction_id':_0x4a41dd,'failure_message':_0x511f14,'created_at':_0x5b2154[_0x482b00(0x153)],'updated_at':new Date()}};console[_0x482b00(0x1a4)](_0x482b00(0x187)+_0x590eb2[_0x482b00(0x146)]+_0x482b00(0x15a)),console[_0x482b00(0x1a4)](_0x482b00(0x14f),JSON['stringify'](_0x257217,null,0x2));const _0x202a28=JSON['stringify'](_0x257217),_0x2c2b9f=crypto_1[_0x482b00(0x19e)][_0x482b00(0x168)](_0x482b00(0x157),_0xcd2796[_0x482b00(0x17f)])[_0x482b00(0x188)](_0x202a28)[_0x482b00(0x18c)](_0x482b00(0x169)),_0x2dcf9b=await fetch(_0x590eb2[_0x482b00(0x146)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x482b00(0x194),'X-Webhook-Signature':_0x2c2b9f},'body':_0x202a28}),_0x4d0856=Date[_0x482b00(0x14e)]()-_0x8fa48a;console['log'](_0x482b00(0x159)+_0x590eb2[_0x482b00(0x146)]+'\x20with\x20status\x20'+_0x2dcf9b[_0x482b00(0x164)]+'\x20('+_0x4d0856+_0x482b00(0x16f));}catch(_0xce0a2d){console[_0x482b00(0x1b8)](_0x482b00(0x144),_0xce0a2d);}}async[a21_0x567a99(0x150)](_0x10abf7,_0x344e93){const _0x50729d=a21_0x567a99;try{const {telegramBotService:_0x39f207}=await Promise[_0x50729d(0x16a)]()[_0x50729d(0x1ad)](()=>__importStar(require('../services/telegramBotService'))),_0x1557ee={'PAID':_0x50729d(0x158),'FAILED':_0x50729d(0x156)},_0x51357c=_0x1557ee[_0x344e93];if(!_0x51357c)return;await _0x39f207[_0x50729d(0x1a8)](_0x10abf7[_0x50729d(0x1b0)],_0x10abf7,_0x51357c);}catch(_0x57e16b){console[_0x50729d(0x1b8)](_0x50729d(0x13f),_0x57e16b);}}}exports[a21_0x567a99(0x15c)]=TestGatewayController;