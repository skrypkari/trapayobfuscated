'use strict';const a13_0x582656=a13_0x2337;function a13_0x2337(_0x5ac95a,_0x4f3904){const _0x4098b0=a13_0x4098();return a13_0x2337=function(_0x2337e1,_0x4046f6){_0x2337e1=_0x2337e1-0x178;let _0x5ec98c=_0x4098b0[_0x2337e1];return _0x5ec98c;},a13_0x2337(_0x5ac95a,_0x4f3904);}(function(_0x599eab,_0x44f5f0){const _0x24269c=a13_0x2337,_0x1d5eaa=_0x599eab();while(!![]){try{const _0x5949fa=-parseInt(_0x24269c(0x195))/0x1*(-parseInt(_0x24269c(0x190))/0x2)+parseInt(_0x24269c(0x1db))/0x3+-parseInt(_0x24269c(0x1b8))/0x4*(parseInt(_0x24269c(0x1a9))/0x5)+parseInt(_0x24269c(0x1c6))/0x6+-parseInt(_0x24269c(0x180))/0x7+-parseInt(_0x24269c(0x1b4))/0x8+parseInt(_0x24269c(0x19a))/0x9;if(_0x5949fa===_0x44f5f0)break;else _0x1d5eaa['push'](_0x1d5eaa['shift']());}catch(_0x2180bc){_0x1d5eaa['push'](_0x1d5eaa['shift']());}}}(a13_0x4098,0xbcf5f));var __createBinding=this&&this[a13_0x582656(0x1ac)]||(Object[a13_0x582656(0x189)]?function(_0x33584e,_0x1e50bb,_0x24cbf3,_0x9ea0c0){const _0x599f2e=a13_0x582656;if(_0x9ea0c0===undefined)_0x9ea0c0=_0x24cbf3;var _0xd8ab0c=Object[_0x599f2e(0x1c2)](_0x1e50bb,_0x24cbf3);(!_0xd8ab0c||(_0x599f2e(0x192)in _0xd8ab0c?!_0x1e50bb['__esModule']:_0xd8ab0c[_0x599f2e(0x194)]||_0xd8ab0c[_0x599f2e(0x198)]))&&(_0xd8ab0c={'enumerable':!![],'get':function(){return _0x1e50bb[_0x24cbf3];}}),Object[_0x599f2e(0x1c8)](_0x33584e,_0x9ea0c0,_0xd8ab0c);}:function(_0x39494b,_0x228687,_0x7a5787,_0x5b0baa){if(_0x5b0baa===undefined)_0x5b0baa=_0x7a5787;_0x39494b[_0x5b0baa]=_0x228687[_0x7a5787];}),__setModuleDefault=this&&this[a13_0x582656(0x1b2)]||(Object['create']?function(_0x5a421c,_0x2014d9){Object['defineProperty'](_0x5a421c,'default',{'enumerable':!![],'value':_0x2014d9});}:function(_0x56b0a9,_0x24b183){const _0x400374=a13_0x582656;_0x56b0a9[_0x400374(0x1bf)]=_0x24b183;}),__importStar=this&&this[a13_0x582656(0x19d)]||(function(){var _0x36d04a=function(_0x23b537){const _0x4e772c=a13_0x2337;return _0x36d04a=Object[_0x4e772c(0x1a7)]||function(_0x3c3768){const _0x1fce04=_0x4e772c;var _0x6df3fb=[];for(var _0x59abe5 in _0x3c3768)if(Object[_0x1fce04(0x1ce)][_0x1fce04(0x1a5)][_0x1fce04(0x18d)](_0x3c3768,_0x59abe5))_0x6df3fb[_0x6df3fb[_0x1fce04(0x1b7)]]=_0x59abe5;return _0x6df3fb;},_0x36d04a(_0x23b537);};return function(_0x1bc59d){const _0x23288a=a13_0x2337;if(_0x1bc59d&&_0x1bc59d[_0x23288a(0x1b5)])return _0x1bc59d;var _0x3fc915={};if(_0x1bc59d!=null){for(var _0x40d9ed=_0x36d04a(_0x1bc59d),_0x48b16a=0x0;_0x48b16a<_0x40d9ed[_0x23288a(0x1b7)];_0x48b16a++)if(_0x40d9ed[_0x48b16a]!==_0x23288a(0x1bf))__createBinding(_0x3fc915,_0x1bc59d,_0x40d9ed[_0x48b16a]);}return __setModuleDefault(_0x3fc915,_0x1bc59d),_0x3fc915;};}()),__importDefault=this&&this['__importDefault']||function(_0x5400ac){const _0x552063=a13_0x582656;return _0x5400ac&&_0x5400ac[_0x552063(0x1b5)]?_0x5400ac:{'default':_0x5400ac};};Object['defineProperty'](exports,a13_0x582656(0x1b5),{'value':!![]}),exports[a13_0x582656(0x1dc)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x582656(0x1a1)),database_1=__importDefault(require(a13_0x582656(0x1d8)));class TestGatewayController{constructor(){const _0x459f52=a13_0x582656;this[_0x459f52(0x18c)]=async(_0x5ea0cb,_0x1ef57d,_0x1d8f45)=>{const _0x5bb2f7=_0x459f52;try{const {paymentId:_0x1f7e53}=_0x5ea0cb['params'];console[_0x5bb2f7(0x199)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x1f7e53);const _0x3ed2fc=await database_1['default']['payment']['findUnique']({'where':{'id':_0x1f7e53},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3ed2fc)return _0x1ef57d['status'](0x194)[_0x5bb2f7(0x1bd)]({'success':![],'message':_0x5bb2f7(0x1a3)});if(_0x3ed2fc['gateway']!=='test_gateway')return _0x1ef57d[_0x5bb2f7(0x1dd)](0x190)['json']({'success':![],'message':_0x5bb2f7(0x1b3)});if(_0x3ed2fc['status']!==_0x5bb2f7(0x196))return _0x1ef57d[_0x5bb2f7(0x1dd)](0x190)['json']({'success':![],'message':_0x5bb2f7(0x1d5)+_0x3ed2fc[_0x5bb2f7(0x1dd)]+_0x5bb2f7(0x1b9)});_0x1ef57d['json']({'success':!![],'result':{'paymentId':_0x3ed2fc['id'],'orderId':_0x3ed2fc['gatewayOrderId'],'amount':_0x3ed2fc[_0x5bb2f7(0x17b)],'currency':_0x3ed2fc['currency'],'merchantName':_0x3ed2fc[_0x5bb2f7(0x1cd)][_0x5bb2f7(0x18a)],'description':_0x5bb2f7(0x1cc)+_0x3ed2fc['shop'][_0x5bb2f7(0x18a)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5bb2f7(0x1c1),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x5bb2f7(0x1ca),'holderName':'Any\x20name'}}});}catch(_0x3faf67){_0x1d8f45(_0x3faf67);}},this['processCard']=async(_0x5a97b1,_0x5bb9ce,_0x23ba5c)=>{const _0x3a9de2=_0x459f52;try{const {paymentId:_0xdb0474}=_0x5a97b1[_0x3a9de2(0x17d)],_0x2fcbe5=_0x5a97b1[_0x3a9de2(0x1d2)];console['log'](_0x3a9de2(0x1c5)+_0xdb0474);const _0x3f6a1c=await database_1[_0x3a9de2(0x1bf)][_0x3a9de2(0x188)][_0x3a9de2(0x1bb)]({'where':{'id':_0xdb0474},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3f6a1c)return _0x5bb9ce[_0x3a9de2(0x1dd)](0x194)[_0x3a9de2(0x1bd)]({'success':![],'message':_0x3a9de2(0x1a3)});if(_0x3f6a1c[_0x3a9de2(0x185)]!==_0x3a9de2(0x18f))return _0x5bb9ce[_0x3a9de2(0x1dd)](0x190)['json']({'success':![],'message':_0x3a9de2(0x1b3)});if(_0x3f6a1c[_0x3a9de2(0x1dd)]!==_0x3a9de2(0x196))return _0x5bb9ce[_0x3a9de2(0x1dd)](0x190)[_0x3a9de2(0x1bd)]({'success':![],'message':_0x3a9de2(0x1d5)+_0x3f6a1c['status']+_0x3a9de2(0x1b9)});const _0x3f6ea6=await this[_0x3a9de2(0x184)][_0x3a9de2(0x1ba)]({'paymentId':_0x3f6a1c['id'],'orderId':_0x3f6a1c[_0x3a9de2(0x17a)]||_0x3f6a1c['id'],'amount':_0x3f6a1c[_0x3a9de2(0x17b)],'currency':_0x3f6a1c['currency'],'cardData':_0x2fcbe5});console['log'](_0x3a9de2(0x182),_0x3f6ea6);const _0x37b185={'status':_0x3f6ea6[_0x3a9de2(0x1dd)],'updatedAt':new Date()};if(_0x3f6ea6[_0x3a9de2(0x1dd)]===_0x3a9de2(0x193))_0x37b185['paidAt']=new Date(),_0x37b185[_0x3a9de2(0x1c4)]=_0x3f6ea6[_0x3a9de2(0x181)];else _0x3f6ea6[_0x3a9de2(0x1dd)]===_0x3a9de2(0x18e)&&(_0x37b185['failureMessage']=_0x3f6ea6['failureReason']);const _0x56a452=_0x2fcbe5['cardNumber'][_0x3a9de2(0x1a2)](/[\s-]/g,'');_0x37b185[_0x3a9de2(0x1d0)]=_0x56a452[_0x3a9de2(0x197)](-0x4),_0x37b185['paymentMethod']=_0x3a9de2(0x19b),await database_1[_0x3a9de2(0x1bf)][_0x3a9de2(0x188)][_0x3a9de2(0x178)]({'where':{'id':_0x3f6a1c['id']},'data':_0x37b185}),await database_1[_0x3a9de2(0x1bf)][_0x3a9de2(0x1de)][_0x3a9de2(0x189)]({'data':{'paymentId':_0x3f6a1c['id'],'shopId':_0x3f6a1c[_0x3a9de2(0x1da)],'event':_0x3a9de2(0x19c)+_0x3f6ea6['status'][_0x3a9de2(0x1d7)](),'statusCode':0xc8,'responseBody':JSON[_0x3a9de2(0x1d4)]({'oldStatus':_0x3a9de2(0x196),'newStatus':_0x3f6ea6[_0x3a9de2(0x1dd)],'transactionId':_0x3f6ea6[_0x3a9de2(0x181)],'failureReason':_0x3f6ea6[_0x3a9de2(0x1b1)],'processedAt':new Date()[_0x3a9de2(0x183)]()})}}),await this[_0x3a9de2(0x1aa)](_0x3f6a1c,_0x3f6ea6[_0x3a9de2(0x1dd)],_0x3f6ea6[_0x3a9de2(0x181)],_0x3f6ea6[_0x3a9de2(0x1b1)]),await this[_0x3a9de2(0x187)](_0x3f6a1c,_0x3f6ea6['status']),console[_0x3a9de2(0x199)](_0x3a9de2(0x1d1)+_0xdb0474+_0x3a9de2(0x19f)+_0x3f6ea6[_0x3a9de2(0x1dd)]),_0x3f6ea6[_0x3a9de2(0x1dd)]==='PAID'?_0x5bb9ce[_0x3a9de2(0x1bd)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3a9de2(0x193),'transactionId':_0x3f6ea6[_0x3a9de2(0x181)],'redirectUrl':_0x3f6a1c[_0x3a9de2(0x191)]}}):_0x5bb9ce[_0x3a9de2(0x1dd)](0x190)[_0x3a9de2(0x1bd)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x3a9de2(0x18e),'failureReason':_0x3f6ea6[_0x3a9de2(0x1b1)],'redirectUrl':_0x3f6a1c[_0x3a9de2(0x1af)]}});}catch(_0x709c9f){_0x23ba5c(_0x709c9f);}},this[_0x459f52(0x184)]=new testGatewayService_1[(_0x459f52(0x186))](),this[_0x459f52(0x1ad)]=new webhookService_1[(_0x459f52(0x1c0))]();}async[a13_0x582656(0x1aa)](_0x4199ec,_0x197003,_0x944509,_0x35a711){const _0x452cde=a13_0x582656,_0x3d4ecd=Date['now']();try{const _0x6cc0a4=_0x4199ec[_0x452cde(0x1cd)],_0x441d69=_0x6cc0a4[_0x452cde(0x1a4)];if(!_0x441d69?.[_0x452cde(0x1ae)]){console[_0x452cde(0x199)](_0x452cde(0x1a6)+_0x6cc0a4['id']);return;}const _0x58932b=_0x197003===_0x452cde(0x193)?'payment.success':_0x452cde(0x179);let _0x5ce486=[];if(_0x441d69[_0x452cde(0x1be)])try{_0x5ce486=Array[_0x452cde(0x1d9)](_0x441d69['webhookEvents'])?_0x441d69[_0x452cde(0x1be)]:JSON[_0x452cde(0x1c3)](_0x441d69['webhookEvents']);}catch(_0x4b3f16){console['error'](_0x452cde(0x1ab),_0x4b3f16),_0x5ce486=[];}if(!_0x5ce486[_0x452cde(0x1b6)](_0x58932b)){console[_0x452cde(0x199)](_0x452cde(0x1c9)+_0x58932b+_0x452cde(0x18b)+_0x6cc0a4['id']);return;}const _0x4c9c2f={'event':_0x58932b,'payment':{'id':_0x4199ec['id'],'order_id':_0x4199ec[_0x452cde(0x17c)],'gateway_order_id':_0x4199ec['gatewayOrderId'],'gateway':_0x452cde(0x1d6),'amount':_0x4199ec['amount'],'currency':_0x4199ec[_0x452cde(0x1cb)],'status':_0x197003['toLowerCase'](),'customer_email':_0x4199ec[_0x452cde(0x1a0)],'customer_name':_0x4199ec['customerName'],'transaction_id':_0x944509,'failure_message':_0x35a711,'created_at':_0x4199ec['createdAt'],'updated_at':new Date()}},_0x38d2a2=await fetch(_0x441d69['webhookUrl'],{'method':_0x452cde(0x1bc),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x452cde(0x1d4)](_0x4c9c2f)}),_0x5aa592=Date['now']()-_0x3d4ecd;console[_0x452cde(0x199)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x441d69['webhookUrl']+'\x20with\x20status\x20'+_0x38d2a2[_0x452cde(0x1dd)]+'\x20('+_0x5aa592+_0x452cde(0x17f));}catch(_0x5e4f92){console[_0x452cde(0x1c7)](_0x452cde(0x17e),_0x5e4f92);}}async[a13_0x582656(0x187)](_0x3a5069,_0x3e8d7f){const _0xb8bf4d=a13_0x582656;try{const {telegramBotService:_0x38ae10}=await Promise[_0xb8bf4d(0x19e)]()[_0xb8bf4d(0x1a8)](()=>__importStar(require('../services/telegramBotService'))),_0x22eda5={'PAID':'paid','FAILED':_0xb8bf4d(0x1b0)},_0x2dcfb6=_0x22eda5[_0x3e8d7f];if(!_0x2dcfb6)return;await _0x38ae10[_0xb8bf4d(0x1d3)](_0x3a5069['shopId'],_0x3a5069,_0x2dcfb6);}catch(_0x30e38a){console['error'](_0xb8bf4d(0x1cf),_0x30e38a);}}}function a13_0x4098(){const _0x589a72=['replace','Payment\x20not\x20found','settings','hasOwnProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getOwnPropertyNames','then','6835eFJoRu','sendShopWebhook','Error\x20parsing\x20webhook\x20events:','__createBinding','webhookService','webhookUrl','failUrl','failed','failureReason','__setModuleDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','688872pmMffo','__esModule','includes','length','3532DPGKBY',',\x20cannot\x20process','processCardPayment','findUnique','POST','json','webhookEvents','default','WebhookService','Any\x20other\x20card\x20number','getOwnPropertyDescriptor','parse','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','5159808HwvINa','error','defineProperty','Webhook\x20event\x20','Any\x203-4\x20digits','currency','Payment\x20to\x20','shop','prototype','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','cardLast4','âœ…\x20Test\x20Gateway\x20payment\x20','body','sendPaymentNotification','stringify','Payment\x20status\x20is\x20','0000','toLowerCase','../config/database','isArray','shopId','95478IlqtZr','TestGatewayController','status','webhookLog','update','payment.failed','gatewayOrderId','amount','orderId','params','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','ms)','3781603pxcHkt','transactionId','ðŸ§ª\x20Test\x20Gateway\x20result:','toISOString','testGatewayService','gateway','TestGatewayService','sendPaymentStatusNotification','payment','create','name','\x20not\x20enabled\x20for\x20shop\x20','getPaymentForm','call','FAILED','test_gateway','934kAUQQb','successUrl','get','PAID','writable','2814LOaiby','PENDING','slice','configurable','log','3613050gvsNZy','test_card','test_gateway_','__importStar','resolve','\x20processed:\x20','customerEmail','../services/webhookService'];a13_0x4098=function(){return _0x589a72;};return a13_0x4098();}exports['TestGatewayController']=TestGatewayController;