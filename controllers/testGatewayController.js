'use strict';const a15_0x500c99=a15_0x4070;function a15_0x4070(_0x224949,_0x3f53d8){const _0x5c7b83=a15_0x5c7b();return a15_0x4070=function(_0x407048,_0x938dc0){_0x407048=_0x407048-0x188;let _0x14ef34=_0x5c7b83[_0x407048];return _0x14ef34;},a15_0x4070(_0x224949,_0x3f53d8);}(function(_0x383909,_0x37ba36){const _0x34dd7a=a15_0x4070,_0x58627b=_0x383909();while(!![]){try{const _0x1d8087=parseInt(_0x34dd7a(0x1e7))/0x1+parseInt(_0x34dd7a(0x196))/0x2+-parseInt(_0x34dd7a(0x1a4))/0x3+-parseInt(_0x34dd7a(0x197))/0x4*(-parseInt(_0x34dd7a(0x1f4))/0x5)+-parseInt(_0x34dd7a(0x1d6))/0x6*(-parseInt(_0x34dd7a(0x1cc))/0x7)+parseInt(_0x34dd7a(0x1fc))/0x8+parseInt(_0x34dd7a(0x1ad))/0x9*(-parseInt(_0x34dd7a(0x1f3))/0xa);if(_0x1d8087===_0x37ba36)break;else _0x58627b['push'](_0x58627b['shift']());}catch(_0x22cac9){_0x58627b['push'](_0x58627b['shift']());}}}(a15_0x5c7b,0x6dc36));function a15_0x5c7b(){const _0x5a90b1=['now','resolve','\x20->\x20','cardLast4','testGatewayService','webhookEvents','getPaymentForm','cardNumber','POST','failed','SINGLE','Payment\x20not\x20found','209472YzFKEU','Payment\x20status\x20is\x20','status','webhookLog','getOwnPropertyDescriptor','WebhookService','gateway','../services/telegramBotService','failureReason','configurable','prototype','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','208690ZaDDyE','5205ZDUlMw','webhookService','payment.success','update','Error\x20parsing\x20webhook\x20events:','name','default','type','7135424hfPnhi',',\x20status=','PENDING','sendPaymentStatusNotification','\x20not\x20enabled\x20for\x20shop\x20','../config/database','json','shop','paymentMethod','0000','params','../services/gateways/testGatewayService','__esModule','test_gateway_','failUrl','gatewayOrderId','PAID','1424912eMstWi','468mgrlEc','call','test_card','📈\x20Found\x20payment\x20link\x20','__importStar','\x20not\x20found','length','Any\x203-4\x20digits','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','COMPLETED','writable','log','hasOwnProperty','1773873GJEbUO','test_gateway','4242\x204242\x204242\x204242','sendShopWebhook','toLowerCase',',\x20currentPayments=','application/json','error','defineProperty','603hgQqiv','__setModuleDefault','currency','Payment\x20System/1.0\x20(Test\x20Gateway)','processCardPayment','Any\x20other\x20card\x20number','🧪\x20Test\x20Gateway\x20result:','shopId','getOwnPropertyNames','payment','paymentLinkId','$transaction','Any\x20name','✅\x20Payment\x20link\x20','../services/webhookService','webhookUrl','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','TestGatewayController','\x20updated:\x20currentPayments=','isArray','settings','transactionId','findUnique','customerName','successUrl','Payment\x20is\x20not\x20for\x20test\x20gateway','stringify','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','✅\x20Test\x20Gateway\x20payment\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLink','91lSqzJf','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create','amount','payment.failed','get','customerEmail','Any\x20future\x20date\x20(MM/YY)','slice','toISOString','232362aaTGmZ','failureMessage','Webhook\x20event\x20','currentPayments','FAILED'];a15_0x5c7b=function(){return _0x5a90b1;};return a15_0x5c7b();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x306d85,_0xb0e75a,_0x34f5f9,_0x358646){const _0x61b556=a15_0x4070;if(_0x358646===undefined)_0x358646=_0x34f5f9;var _0x34ce67=Object[_0x61b556(0x1eb)](_0xb0e75a,_0x34f5f9);(!_0x34ce67||(_0x61b556(0x1d1)in _0x34ce67?!_0xb0e75a[_0x61b556(0x191)]:_0x34ce67[_0x61b556(0x1a1)]||_0x34ce67[_0x61b556(0x1f0)]))&&(_0x34ce67={'enumerable':!![],'get':function(){return _0xb0e75a[_0x34f5f9];}}),Object['defineProperty'](_0x306d85,_0x358646,_0x34ce67);}:function(_0x4c1734,_0x3cafe3,_0x1595dc,_0x3efec2){if(_0x3efec2===undefined)_0x3efec2=_0x1595dc;_0x4c1734[_0x3efec2]=_0x3cafe3[_0x1595dc];}),__setModuleDefault=this&&this[a15_0x500c99(0x1ae)]||(Object[a15_0x500c99(0x1ce)]?function(_0x4d160f,_0x59dbff){const _0xb0e4ee=a15_0x500c99;Object[_0xb0e4ee(0x1ac)](_0x4d160f,_0xb0e4ee(0x1fa),{'enumerable':!![],'value':_0x59dbff});}:function(_0x7b717e,_0xb93a26){const _0x16d93f=a15_0x500c99;_0x7b717e[_0x16d93f(0x1fa)]=_0xb93a26;}),__importStar=this&&this[a15_0x500c99(0x19b)]||(function(){var _0x4fc931=function(_0x5bd713){const _0x14195e=a15_0x4070;return _0x4fc931=Object[_0x14195e(0x1b5)]||function(_0x316a7e){const _0x4ecd06=_0x14195e;var _0x353e27=[];for(var _0x2e9769 in _0x316a7e)if(Object[_0x4ecd06(0x1f1)][_0x4ecd06(0x1a3)][_0x4ecd06(0x198)](_0x316a7e,_0x2e9769))_0x353e27[_0x353e27[_0x4ecd06(0x19d)]]=_0x2e9769;return _0x353e27;},_0x4fc931(_0x5bd713);};return function(_0x179cb8){const _0x261b0f=a15_0x4070;if(_0x179cb8&&_0x179cb8[_0x261b0f(0x191)])return _0x179cb8;var _0x303644={};if(_0x179cb8!=null){for(var _0x21b341=_0x4fc931(_0x179cb8),_0x169753=0x0;_0x169753<_0x21b341['length'];_0x169753++)if(_0x21b341[_0x169753]!==_0x261b0f(0x1fa))__createBinding(_0x303644,_0x179cb8,_0x21b341[_0x169753]);}return __setModuleDefault(_0x303644,_0x179cb8),_0x303644;};}()),__importDefault=this&&this['__importDefault']||function(_0x328a97){const _0x12398f=a15_0x500c99;return _0x328a97&&_0x328a97[_0x12398f(0x191)]?_0x328a97:{'default':_0x328a97};};Object[a15_0x500c99(0x1ac)](exports,'__esModule',{'value':!![]}),exports[a15_0x500c99(0x1be)]=void 0x0;const testGatewayService_1=require(a15_0x500c99(0x190)),webhookService_1=require(a15_0x500c99(0x1bb)),database_1=__importDefault(require(a15_0x500c99(0x18a)));class TestGatewayController{constructor(){const _0x469e32=a15_0x500c99;this[_0x469e32(0x1e1)]=async(_0x3e021e,_0x2eb0ba,_0x166865)=>{const _0x670568=_0x469e32;try{const {paymentId:_0x5ed16f}=_0x3e021e[_0x670568(0x18f)];console[_0x670568(0x1a2)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5ed16f);const _0x3c7ecd=await database_1[_0x670568(0x1fa)][_0x670568(0x1b6)][_0x670568(0x1c3)]({'where':{'id':_0x5ed16f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3c7ecd)return _0x2eb0ba[_0x670568(0x1e9)](0x194)['json']({'success':![],'message':_0x670568(0x1e6)});if(_0x3c7ecd['gateway']!==_0x670568(0x1a5))return _0x2eb0ba['status'](0x190)[_0x670568(0x18b)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3c7ecd[_0x670568(0x1e9)]!=='PENDING')return _0x2eb0ba[_0x670568(0x1e9)](0x190)[_0x670568(0x18b)]({'success':![],'message':_0x670568(0x1e8)+_0x3c7ecd['status']+',\x20cannot\x20process'});_0x2eb0ba['json']({'success':!![],'result':{'paymentId':_0x3c7ecd['id'],'orderId':_0x3c7ecd['gatewayOrderId'],'amount':_0x3c7ecd['amount'],'currency':_0x3c7ecd['currency'],'merchantName':_0x3c7ecd['shop'][_0x670568(0x1f9)],'description':'Payment\x20to\x20'+_0x3c7ecd[_0x670568(0x18c)][_0x670568(0x1f9)],'testInstructions':{'successCard':_0x670568(0x1a6),'failureCard':_0x670568(0x1b2),'expiryDate':_0x670568(0x1d3),'cvc':_0x670568(0x19e),'holderName':_0x670568(0x1b9)}}});}catch(_0x5ae493){_0x166865(_0x5ae493);}},this['processCard']=async(_0x4c1e94,_0xa0954c,_0x25c4a7)=>{const _0xf9d057=_0x469e32;try{const {paymentId:_0x180911}=_0x4c1e94[_0xf9d057(0x18f)],_0x522841=_0x4c1e94['body'];console['log'](_0xf9d057(0x1f2)+_0x180911);const _0x3528a0=await database_1[_0xf9d057(0x1fa)][_0xf9d057(0x1b6)][_0xf9d057(0x1c3)]({'where':{'id':_0x180911},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3528a0)return _0xa0954c[_0xf9d057(0x1e9)](0x194)[_0xf9d057(0x18b)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3528a0[_0xf9d057(0x1ed)]!=='test_gateway')return _0xa0954c[_0xf9d057(0x1e9)](0x190)[_0xf9d057(0x18b)]({'success':![],'message':_0xf9d057(0x1c6)});if(_0x3528a0['status']!==_0xf9d057(0x1fe))return _0xa0954c[_0xf9d057(0x1e9)](0x190)[_0xf9d057(0x18b)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3528a0[_0xf9d057(0x1e9)]+',\x20cannot\x20process'});const _0x4016c3=await this[_0xf9d057(0x1df)][_0xf9d057(0x1b1)]({'paymentId':_0x3528a0['id'],'orderId':_0x3528a0[_0xf9d057(0x194)]||_0x3528a0['id'],'amount':_0x3528a0['amount'],'currency':_0x3528a0[_0xf9d057(0x1af)],'cardData':_0x522841});console[_0xf9d057(0x1a2)](_0xf9d057(0x1b3),_0x4016c3);const _0x42ae74={'status':_0x4016c3[_0xf9d057(0x1e9)],'updatedAt':new Date()};if(_0x4016c3[_0xf9d057(0x1e9)]===_0xf9d057(0x195))_0x42ae74['paidAt']=new Date(),_0x42ae74['gatewayPaymentId']=_0x4016c3[_0xf9d057(0x1c2)];else _0x4016c3['status']==='FAILED'&&(_0x42ae74[_0xf9d057(0x1d7)]=_0x4016c3[_0xf9d057(0x1ef)]);const _0x51864e=_0x522841[_0xf9d057(0x1e2)]['replace'](/[\s-]/g,'');_0x42ae74[_0xf9d057(0x1de)]=_0x51864e[_0xf9d057(0x1d4)](-0x4),_0x42ae74[_0xf9d057(0x18d)]=_0xf9d057(0x199),await database_1['default'][_0xf9d057(0x1b6)][_0xf9d057(0x1f7)]({'where':{'id':_0x3528a0['id']},'data':_0x42ae74});if(_0x4016c3[_0xf9d057(0x1e9)]==='PAID'&&_0x3528a0[_0xf9d057(0x1b7)]){console[_0xf9d057(0x1a2)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x3528a0['id']+_0xf9d057(0x1bd));try{await database_1['default'][_0xf9d057(0x1b8)](async _0x207d5c=>{const _0x1fd8db=_0xf9d057,_0x3f3aa6=await _0x207d5c[_0x1fd8db(0x1cb)][_0x1fd8db(0x1c3)]({'where':{'id':_0x3528a0[_0x1fd8db(0x1b7)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3f3aa6){console[_0x1fd8db(0x1a2)](_0x1fd8db(0x19a)+_0x3f3aa6['id']+':\x20type='+_0x3f3aa6[_0x1fd8db(0x1fb)]+_0x1fd8db(0x1a9)+_0x3f3aa6['currentPayments']+_0x1fd8db(0x1fd)+_0x3f3aa6[_0x1fd8db(0x1e9)]);const _0x4bc8d9=_0x3f3aa6[_0x1fd8db(0x1d9)]+0x1,_0x25ae58=_0x3f3aa6['type']===_0x1fd8db(0x1e5)?_0x1fd8db(0x1a0):_0x3f3aa6[_0x1fd8db(0x1e9)];await _0x207d5c[_0x1fd8db(0x1cb)]['update']({'where':{'id':_0x3528a0['paymentLinkId']},'data':{'currentPayments':_0x4bc8d9,'status':_0x25ae58,'updatedAt':new Date()}}),console[_0x1fd8db(0x1a2)](_0x1fd8db(0x1ba)+_0x3f3aa6['id']+_0x1fd8db(0x1bf)+_0x3f3aa6['currentPayments']+_0x1fd8db(0x1dd)+_0x4bc8d9+_0x1fd8db(0x1fd)+_0x3f3aa6['status']+_0x1fd8db(0x1dd)+_0x25ae58);}else console[_0x1fd8db(0x1a2)]('❌\x20Payment\x20link\x20'+_0x3528a0[_0x1fd8db(0x1b7)]+_0x1fd8db(0x19c));});}catch(_0x63e789){console[_0xf9d057(0x1ab)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x63e789);}}await database_1['default'][_0xf9d057(0x1ea)][_0xf9d057(0x1ce)]({'data':{'paymentId':_0x3528a0['id'],'shopId':_0x3528a0['shopId'],'event':_0xf9d057(0x192)+_0x4016c3[_0xf9d057(0x1e9)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xf9d057(0x1c7)]({'oldStatus':_0xf9d057(0x1fe),'newStatus':_0x4016c3[_0xf9d057(0x1e9)],'transactionId':_0x4016c3[_0xf9d057(0x1c2)],'failureReason':_0x4016c3[_0xf9d057(0x1ef)],'processedAt':new Date()[_0xf9d057(0x1d5)]()})}}),await this['sendShopWebhook'](_0x3528a0,_0x4016c3[_0xf9d057(0x1e9)],_0x4016c3['transactionId'],_0x4016c3[_0xf9d057(0x1ef)]),await this[_0xf9d057(0x188)](_0x3528a0,_0x4016c3[_0xf9d057(0x1e9)]),console[_0xf9d057(0x1a2)](_0xf9d057(0x1c9)+_0x180911+'\x20processed:\x20'+_0x4016c3['status']),_0x4016c3['status']===_0xf9d057(0x195)?_0xa0954c['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0xf9d057(0x195),'transactionId':_0x4016c3[_0xf9d057(0x1c2)],'redirectUrl':_0x3528a0[_0xf9d057(0x1c5)]}}):_0xa0954c[_0xf9d057(0x1e9)](0x190)[_0xf9d057(0x18b)]({'success':![],'message':'Payment\x20failed','result':{'status':_0xf9d057(0x1da),'failureReason':_0x4016c3['failureReason'],'redirectUrl':_0x3528a0[_0xf9d057(0x193)]}});}catch(_0x391ed2){_0x25c4a7(_0x391ed2);}},this[_0x469e32(0x1df)]=new testGatewayService_1['TestGatewayService'](),this[_0x469e32(0x1f5)]=new webhookService_1[(_0x469e32(0x1ec))]();}async[a15_0x500c99(0x1a7)](_0x2f5b3f,_0x4d00e9,_0x37af51,_0x22f851){const _0xc7b85f=a15_0x500c99,_0x46dd8f=Date[_0xc7b85f(0x1db)]();try{const _0x417228=_0x2f5b3f['shop'],_0x144c25=_0x417228[_0xc7b85f(0x1c1)];if(!_0x144c25?.[_0xc7b85f(0x1bc)]){console[_0xc7b85f(0x1a2)](_0xc7b85f(0x1cd)+_0x417228['id']);return;}const _0x3adfa1=_0x4d00e9==='PAID'?_0xc7b85f(0x1f6):_0xc7b85f(0x1d0);let _0x38e0f5=[];if(_0x144c25[_0xc7b85f(0x1e0)])try{_0x38e0f5=Array[_0xc7b85f(0x1c0)](_0x144c25[_0xc7b85f(0x1e0)])?_0x144c25[_0xc7b85f(0x1e0)]:JSON['parse'](_0x144c25['webhookEvents']);}catch(_0x395c08){console[_0xc7b85f(0x1ab)](_0xc7b85f(0x1f8),_0x395c08),_0x38e0f5=[];}if(!_0x38e0f5['includes'](_0x3adfa1)){console[_0xc7b85f(0x1a2)](_0xc7b85f(0x1d8)+_0x3adfa1+_0xc7b85f(0x189)+_0x417228['id']);return;}const _0xa773c8={'event':_0x3adfa1,'payment':{'id':_0x2f5b3f['id'],'order_id':_0x2f5b3f['orderId'],'gateway_order_id':_0x2f5b3f[_0xc7b85f(0x194)],'gateway':_0xc7b85f(0x18e),'amount':_0x2f5b3f[_0xc7b85f(0x1cf)],'currency':_0x2f5b3f[_0xc7b85f(0x1af)],'status':_0x4d00e9[_0xc7b85f(0x1a8)](),'customer_email':_0x2f5b3f[_0xc7b85f(0x1d2)],'customer_name':_0x2f5b3f[_0xc7b85f(0x1c4)],'transaction_id':_0x37af51,'failure_message':_0x22f851,'created_at':_0x2f5b3f['createdAt'],'updated_at':new Date()}},_0x56b9ad=await fetch(_0x144c25[_0xc7b85f(0x1bc)],{'method':_0xc7b85f(0x1e3),'headers':{'Content-Type':_0xc7b85f(0x1aa),'User-Agent':_0xc7b85f(0x1b0)},'body':JSON[_0xc7b85f(0x1c7)](_0xa773c8)}),_0xc472b9=Date[_0xc7b85f(0x1db)]()-_0x46dd8f;console[_0xc7b85f(0x1a2)](_0xc7b85f(0x1ca)+_0x144c25[_0xc7b85f(0x1bc)]+'\x20with\x20status\x20'+_0x56b9ad[_0xc7b85f(0x1e9)]+'\x20('+_0xc472b9+'ms)');}catch(_0x25ec74){console['error'](_0xc7b85f(0x19f),_0x25ec74);}}async[a15_0x500c99(0x188)](_0x353ee4,_0x307018){const _0x5bacf1=a15_0x500c99;try{const {telegramBotService:_0x39758d}=await Promise[_0x5bacf1(0x1dc)]()['then'](()=>__importStar(require(_0x5bacf1(0x1ee)))),_0x1a5f1e={'PAID':'paid','FAILED':_0x5bacf1(0x1e4)},_0x2501ba=_0x1a5f1e[_0x307018];if(!_0x2501ba)return;await _0x39758d['sendPaymentNotification'](_0x353ee4[_0x5bacf1(0x1b4)],_0x353ee4,_0x2501ba);}catch(_0x41c115){console[_0x5bacf1(0x1ab)](_0x5bacf1(0x1c8),_0x41c115);}}}exports[a15_0x500c99(0x1be)]=TestGatewayController;