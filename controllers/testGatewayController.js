'use strict';const a13_0x223f36=a13_0x47e6;(function(_0x46f345,_0x22171f){const _0x3df1e8=a13_0x47e6,_0x16610f=_0x46f345();while(!![]){try{const _0x400102=-parseInt(_0x3df1e8(0x1af))/0x1+-parseInt(_0x3df1e8(0x1c9))/0x2*(-parseInt(_0x3df1e8(0x1a0))/0x3)+parseInt(_0x3df1e8(0x1d2))/0x4*(parseInt(_0x3df1e8(0x1b0))/0x5)+parseInt(_0x3df1e8(0x1aa))/0x6*(parseInt(_0x3df1e8(0x1d6))/0x7)+-parseInt(_0x3df1e8(0x1c1))/0x8+parseInt(_0x3df1e8(0x1b2))/0x9+parseInt(_0x3df1e8(0x1a6))/0xa*(-parseInt(_0x3df1e8(0x1b9))/0xb);if(_0x400102===_0x22171f)break;else _0x16610f['push'](_0x16610f['shift']());}catch(_0x342d1e){_0x16610f['push'](_0x16610f['shift']());}}}(a13_0x3926,0x3010c));var __createBinding=this&&this[a13_0x223f36(0x1b5)]||(Object[a13_0x223f36(0x1bc)]?function(_0xc50495,_0x1db6d8,_0xa47a7a,_0x3749eb){const _0xa28bb4=a13_0x223f36;if(_0x3749eb===undefined)_0x3749eb=_0xa47a7a;var _0x327b0e=Object[_0xa28bb4(0x1c0)](_0x1db6d8,_0xa47a7a);(!_0x327b0e||(_0xa28bb4(0x1c4)in _0x327b0e?!_0x1db6d8['__esModule']:_0x327b0e['writable']||_0x327b0e[_0xa28bb4(0x1b6)]))&&(_0x327b0e={'enumerable':!![],'get':function(){return _0x1db6d8[_0xa47a7a];}}),Object[_0xa28bb4(0x1fc)](_0xc50495,_0x3749eb,_0x327b0e);}:function(_0xc2116b,_0xd20890,_0x3bbca7,_0x1f0176){if(_0x1f0176===undefined)_0x1f0176=_0x3bbca7;_0xc2116b[_0x1f0176]=_0xd20890[_0x3bbca7];}),__setModuleDefault=this&&this[a13_0x223f36(0x1ad)]||(Object['create']?function(_0x373b52,_0x140914){const _0x3a6d98=a13_0x223f36;Object[_0x3a6d98(0x1fc)](_0x373b52,_0x3a6d98(0x203),{'enumerable':!![],'value':_0x140914});}:function(_0x14b44c,_0xf549a6){const _0x33ccb0=a13_0x223f36;_0x14b44c[_0x33ccb0(0x203)]=_0xf549a6;}),__importStar=this&&this[a13_0x223f36(0x1c6)]||(function(){var _0x23586b=function(_0x37ac6e){const _0x12ba1d=a13_0x47e6;return _0x23586b=Object[_0x12ba1d(0x1cb)]||function(_0x425ffc){const _0x51f5b9=_0x12ba1d;var _0x55ac3b=[];for(var _0x1ed158 in _0x425ffc)if(Object[_0x51f5b9(0x201)][_0x51f5b9(0x1c3)][_0x51f5b9(0x1e6)](_0x425ffc,_0x1ed158))_0x55ac3b[_0x55ac3b[_0x51f5b9(0x1b4)]]=_0x1ed158;return _0x55ac3b;},_0x23586b(_0x37ac6e);};return function(_0x39dd45){const _0x478dd6=a13_0x47e6;if(_0x39dd45&&_0x39dd45['__esModule'])return _0x39dd45;var _0x32a894={};if(_0x39dd45!=null){for(var _0x595948=_0x23586b(_0x39dd45),_0x36df88=0x0;_0x36df88<_0x595948[_0x478dd6(0x1b4)];_0x36df88++)if(_0x595948[_0x36df88]!==_0x478dd6(0x203))__createBinding(_0x32a894,_0x39dd45,_0x595948[_0x36df88]);}return __setModuleDefault(_0x32a894,_0x39dd45),_0x32a894;};}()),__importDefault=this&&this[a13_0x223f36(0x1d1)]||function(_0x583a48){const _0x24fd92=a13_0x223f36;return _0x583a48&&_0x583a48[_0x24fd92(0x1c5)]?_0x583a48:{'default':_0x583a48};};function a13_0x47e6(_0x3cdde9,_0x3c2caf){const _0x392681=a13_0x3926();return a13_0x47e6=function(_0x47e612,_0x4eb10e){_0x47e612=_0x47e612-0x199;let _0x52e4aa=_0x392681[_0x47e612];return _0x52e4aa;},a13_0x47e6(_0x3cdde9,_0x3c2caf);}Object[a13_0x223f36(0x1fc)](exports,a13_0x223f36(0x1c5),{'value':!![]}),exports[a13_0x223f36(0x1cd)]=void 0x0;const testGatewayService_1=require(a13_0x223f36(0x1e4)),webhookService_1=require(a13_0x223f36(0x1fd)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x288769=a13_0x223f36;this[_0x288769(0x1a1)]=async(_0x176f57,_0x573d00,_0x33e652)=>{const _0x4bdfa5=_0x288769;try{const {paymentId:_0x179082}=_0x176f57[_0x4bdfa5(0x1cc)];console[_0x4bdfa5(0x1c7)](_0x4bdfa5(0x1f6)+_0x179082);const _0x329832=await database_1['default'][_0x4bdfa5(0x1e2)][_0x4bdfa5(0x1fe)]({'where':{'id':_0x179082},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x329832)return _0x573d00[_0x4bdfa5(0x1d8)](0x194)[_0x4bdfa5(0x1d4)]({'success':![],'message':_0x4bdfa5(0x1c8)});if(_0x329832[_0x4bdfa5(0x207)]!==_0x4bdfa5(0x19e))return _0x573d00[_0x4bdfa5(0x1d8)](0x190)['json']({'success':![],'message':_0x4bdfa5(0x1b7)});if(_0x329832['status']!==_0x4bdfa5(0x1cf))return _0x573d00[_0x4bdfa5(0x1d8)](0x190)['json']({'success':![],'message':_0x4bdfa5(0x1d3)+_0x329832[_0x4bdfa5(0x1d8)]+_0x4bdfa5(0x1f4)});_0x573d00[_0x4bdfa5(0x1d4)]({'success':!![],'result':{'paymentId':_0x329832['id'],'orderId':_0x329832[_0x4bdfa5(0x1ce)],'amount':_0x329832[_0x4bdfa5(0x1f1)],'currency':_0x329832[_0x4bdfa5(0x1a5)],'merchantName':_0x329832[_0x4bdfa5(0x1e8)]['name'],'description':_0x4bdfa5(0x205)+_0x329832[_0x4bdfa5(0x1e8)][_0x4bdfa5(0x206)],'testInstructions':{'successCard':_0x4bdfa5(0x1f7),'failureCard':_0x4bdfa5(0x204),'expiryDate':_0x4bdfa5(0x1f5),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x2574b7){_0x33e652(_0x2574b7);}},this[_0x288769(0x1dd)]=async(_0x3ce4cb,_0x26cd0b,_0x1795ea)=>{const _0x257302=_0x288769;try{const {paymentId:_0x5ed9e6}=_0x3ce4cb[_0x257302(0x1cc)],_0x389564=_0x3ce4cb[_0x257302(0x1db)];console[_0x257302(0x1c7)](_0x257302(0x1d5)+_0x5ed9e6);const _0x2ba110=await database_1['default'][_0x257302(0x1e2)][_0x257302(0x1fe)]({'where':{'id':_0x5ed9e6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ba110)return _0x26cd0b[_0x257302(0x1d8)](0x194)[_0x257302(0x1d4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2ba110[_0x257302(0x207)]!==_0x257302(0x19e))return _0x26cd0b[_0x257302(0x1d8)](0x190)['json']({'success':![],'message':_0x257302(0x1b7)});if(_0x2ba110[_0x257302(0x1d8)]!==_0x257302(0x1cf))return _0x26cd0b[_0x257302(0x1d8)](0x190)['json']({'success':![],'message':_0x257302(0x1d3)+_0x2ba110[_0x257302(0x1d8)]+_0x257302(0x1f4)});const _0x42798f=await this[_0x257302(0x1e7)]['processCardPayment']({'paymentId':_0x2ba110['id'],'orderId':_0x2ba110['gatewayOrderId']||_0x2ba110['id'],'amount':_0x2ba110[_0x257302(0x1f1)],'currency':_0x2ba110[_0x257302(0x1a5)],'cardData':_0x389564});console[_0x257302(0x1c7)](_0x257302(0x1f9),_0x42798f);const _0x1258fb={'status':_0x42798f[_0x257302(0x1d8)],'updatedAt':new Date()};if(_0x42798f[_0x257302(0x1d8)]===_0x257302(0x1dc))_0x1258fb[_0x257302(0x1c2)]=new Date(),_0x1258fb[_0x257302(0x202)]=_0x42798f['transactionId'];else _0x42798f[_0x257302(0x1d8)]==='FAILED'&&(_0x1258fb[_0x257302(0x1f3)]=_0x42798f['failureReason']);const _0x159b26=_0x389564[_0x257302(0x199)][_0x257302(0x1be)](/[\s-]/g,'');_0x1258fb[_0x257302(0x1ae)]=_0x159b26[_0x257302(0x1a9)](-0x4),_0x1258fb[_0x257302(0x1d0)]='test_card',await database_1[_0x257302(0x203)][_0x257302(0x1e2)][_0x257302(0x1ed)]({'where':{'id':_0x2ba110['id']},'data':_0x1258fb}),await database_1['default']['webhookLog'][_0x257302(0x1bc)]({'data':{'paymentId':_0x2ba110['id'],'shopId':_0x2ba110[_0x257302(0x1fb)],'event':'test_gateway_'+_0x42798f[_0x257302(0x1d8)][_0x257302(0x1f0)](),'statusCode':0xc8,'responseBody':JSON[_0x257302(0x1bf)]({'oldStatus':'PENDING','newStatus':_0x42798f['status'],'transactionId':_0x42798f['transactionId'],'failureReason':_0x42798f[_0x257302(0x200)],'processedAt':new Date()['toISOString']()})}}),await this[_0x257302(0x1e5)](_0x2ba110,_0x42798f[_0x257302(0x1d8)],_0x42798f[_0x257302(0x1df)],_0x42798f[_0x257302(0x200)]),await this[_0x257302(0x1b1)](_0x2ba110,_0x42798f[_0x257302(0x1d8)]),console[_0x257302(0x1c7)](_0x257302(0x1ec)+_0x5ed9e6+'\x20processed:\x20'+_0x42798f[_0x257302(0x1d8)]),_0x42798f[_0x257302(0x1d8)]==='PAID'?_0x26cd0b['json']({'success':!![],'message':_0x257302(0x1ac),'result':{'status':_0x257302(0x1dc),'transactionId':_0x42798f['transactionId'],'redirectUrl':_0x2ba110[_0x257302(0x1e3)]}}):_0x26cd0b[_0x257302(0x1d8)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x257302(0x1bd),'failureReason':_0x42798f[_0x257302(0x200)],'redirectUrl':_0x2ba110[_0x257302(0x1b8)]}});}catch(_0x425408){_0x1795ea(_0x425408);}},this['testGatewayService']=new testGatewayService_1[(_0x288769(0x1ca))](),this[_0x288769(0x19c)]=new webhookService_1[(_0x288769(0x1a4))]();}async[a13_0x223f36(0x1e5)](_0x5040e9,_0x57848c,_0x1dc6b2,_0x448981){const _0x4ff299=a13_0x223f36,_0x5c0109=Date[_0x4ff299(0x1ff)]();try{const _0x2cac24=_0x5040e9[_0x4ff299(0x1e8)],_0x35bd4d=_0x2cac24[_0x4ff299(0x1a3)];if(!_0x35bd4d?.[_0x4ff299(0x1e0)]){console[_0x4ff299(0x1c7)](_0x4ff299(0x19b)+_0x2cac24['id']);return;}const _0x58ba4e=_0x57848c===_0x4ff299(0x1dc)?'payment.success':_0x4ff299(0x1e9);let _0x479d7b=[];if(_0x35bd4d['webhookEvents'])try{_0x479d7b=Array[_0x4ff299(0x1ab)](_0x35bd4d[_0x4ff299(0x1fa)])?_0x35bd4d[_0x4ff299(0x1fa)]:JSON['parse'](_0x35bd4d[_0x4ff299(0x1fa)]);}catch(_0x593de1){console[_0x4ff299(0x1f8)](_0x4ff299(0x1ba),_0x593de1),_0x479d7b=[];}if(!_0x479d7b[_0x4ff299(0x1bb)](_0x58ba4e)){console[_0x4ff299(0x1c7)](_0x4ff299(0x19d)+_0x58ba4e+_0x4ff299(0x19f)+_0x2cac24['id']);return;}const _0x1cf6b6={'event':_0x58ba4e,'payment':{'id':_0x5040e9['id'],'order_id':_0x5040e9[_0x4ff299(0x1de)],'gateway_order_id':_0x5040e9['gatewayOrderId'],'gateway':_0x4ff299(0x1da),'amount':_0x5040e9[_0x4ff299(0x1f1)],'currency':_0x5040e9[_0x4ff299(0x1a5)],'status':_0x57848c['toLowerCase'](),'customer_email':_0x5040e9[_0x4ff299(0x1ef)],'customer_name':_0x5040e9[_0x4ff299(0x1d7)],'transaction_id':_0x1dc6b2,'failure_message':_0x448981,'created_at':_0x5040e9[_0x4ff299(0x1ea)],'updated_at':new Date()}},_0x291699=await fetch(_0x35bd4d[_0x4ff299(0x1e0)],{'method':_0x4ff299(0x1f2),'headers':{'Content-Type':'application/json','User-Agent':_0x4ff299(0x1a8)},'body':JSON[_0x4ff299(0x1bf)](_0x1cf6b6)}),_0x3599b1=Date[_0x4ff299(0x1ff)]()-_0x5c0109;console['log'](_0x4ff299(0x19a)+_0x35bd4d['webhookUrl']+_0x4ff299(0x1e1)+_0x291699[_0x4ff299(0x1d8)]+'\x20('+_0x3599b1+_0x4ff299(0x1a2));}catch(_0x1a0dc6){console[_0x4ff299(0x1f8)](_0x4ff299(0x1a7),_0x1a0dc6);}}async[a13_0x223f36(0x1b1)](_0x34641e,_0x393a62){const _0x482bf9=a13_0x223f36;try{const {telegramBotService:_0x5de611}=await Promise['resolve']()[_0x482bf9(0x1b3)](()=>__importStar(require(_0x482bf9(0x1d9)))),_0x1e6516={'PAID':_0x482bf9(0x1eb),'FAILED':'failed'},_0x207edc=_0x1e6516[_0x393a62];if(!_0x207edc)return;await _0x5de611[_0x482bf9(0x1ee)](_0x34641e['shopId'],_0x34641e,_0x207edc);}catch(_0x46d7d5){console[_0x482bf9(0x1f8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x46d7d5);}}}function a13_0x3926(){const _0x3a6122=['399cHgeLA','customerName','status','../services/telegramBotService','0000','body','PAID','processCard','orderId','transactionId','webhookUrl','\x20with\x20status\x20','payment','successUrl','../services/gateways/testGatewayService','sendShopWebhook','call','testGatewayService','shop','payment.failed','createdAt','paid','✅\x20Test\x20Gateway\x20payment\x20','update','sendPaymentNotification','customerEmail','toLowerCase','amount','POST','failureMessage',',\x20cannot\x20process','Any\x20future\x20date\x20(MM/YY)','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','4242\x204242\x204242\x204242','error','🧪\x20Test\x20Gateway\x20result:','webhookEvents','shopId','defineProperty','../services/webhookService','findUnique','now','failureReason','prototype','gatewayPaymentId','default','Any\x20other\x20card\x20number','Payment\x20to\x20','name','gateway','cardNumber','Test\x20Gateway\x20webhook\x20sent\x20to\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookService','Webhook\x20event\x20','test_gateway','\x20not\x20enabled\x20for\x20shop\x20','57459lqylPZ','getPaymentForm','ms)','settings','WebhookService','currency','957230jFPQsr','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','slice','39594VRlbfL','isArray','Payment\x20processed\x20successfully','__setModuleDefault','cardLast4','135853suPgsB','1080845JrgtvX','sendPaymentStatusNotification','825687FLOZXP','then','length','__createBinding','configurable','Payment\x20is\x20not\x20for\x20test\x20gateway','failUrl','22jdqOms','Error\x20parsing\x20webhook\x20events:','includes','create','FAILED','replace','stringify','getOwnPropertyDescriptor','2964504HjxCmp','paidAt','hasOwnProperty','get','__esModule','__importStar','log','Payment\x20not\x20found','22CBiXYe','TestGatewayService','getOwnPropertyNames','params','TestGatewayController','gatewayOrderId','PENDING','paymentMethod','__importDefault','4CoEogu','Payment\x20status\x20is\x20','json','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'];a13_0x3926=function(){return _0x3a6122;};return a13_0x3926();}exports[a13_0x223f36(0x1cd)]=TestGatewayController;