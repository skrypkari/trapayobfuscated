'use strict';const a13_0xf85f0d=a13_0x5f48;function a13_0x5f48(_0x2b234d,_0x2bffdb){const _0x188ac9=a13_0x188a();return a13_0x5f48=function(_0x5f4864,_0x4ea9aa){_0x5f4864=_0x5f4864-0x185;let _0x39161a=_0x188ac9[_0x5f4864];return _0x39161a;},a13_0x5f48(_0x2b234d,_0x2bffdb);}(function(_0x10d685,_0x41c86e){const _0x935415=a13_0x5f48,_0x163334=_0x10d685();while(!![]){try{const _0x28cd58=-parseInt(_0x935415(0x1a3))/0x1+-parseInt(_0x935415(0x1aa))/0x2*(-parseInt(_0x935415(0x1fc))/0x3)+parseInt(_0x935415(0x1a0))/0x4+parseInt(_0x935415(0x1b5))/0x5*(-parseInt(_0x935415(0x1fd))/0x6)+-parseInt(_0x935415(0x1a4))/0x7+-parseInt(_0x935415(0x1d0))/0x8*(-parseInt(_0x935415(0x1d2))/0x9)+-parseInt(_0x935415(0x1c2))/0xa;if(_0x28cd58===_0x41c86e)break;else _0x163334['push'](_0x163334['shift']());}catch(_0x25ea48){_0x163334['push'](_0x163334['shift']());}}}(a13_0x188a,0x3e5e2));var __createBinding=this&&this[a13_0xf85f0d(0x1fe)]||(Object[a13_0xf85f0d(0x1d8)]?function(_0x9827e3,_0x431012,_0x14363a,_0x28e0ea){const _0x350062=a13_0xf85f0d;if(_0x28e0ea===undefined)_0x28e0ea=_0x14363a;var _0x143637=Object['getOwnPropertyDescriptor'](_0x431012,_0x14363a);(!_0x143637||(_0x350062(0x1e7)in _0x143637?!_0x431012[_0x350062(0x19e)]:_0x143637[_0x350062(0x192)]||_0x143637['configurable']))&&(_0x143637={'enumerable':!![],'get':function(){return _0x431012[_0x14363a];}}),Object[_0x350062(0x1d1)](_0x9827e3,_0x28e0ea,_0x143637);}:function(_0x3d8db0,_0x223303,_0x2ccae2,_0x45c63b){if(_0x45c63b===undefined)_0x45c63b=_0x2ccae2;_0x3d8db0[_0x45c63b]=_0x223303[_0x2ccae2];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x523b4f,_0xa03e12){const _0x508033=a13_0xf85f0d;Object[_0x508033(0x1d1)](_0x523b4f,_0x508033(0x1c8),{'enumerable':!![],'value':_0xa03e12});}:function(_0x46dddf,_0x52bbc9){const _0xbf48b8=a13_0xf85f0d;_0x46dddf[_0xbf48b8(0x1c8)]=_0x52bbc9;}),__importStar=this&&this[a13_0xf85f0d(0x1dd)]||(function(){var _0x10fe61=function(_0x259ee0){const _0x45b5c2=a13_0x5f48;return _0x10fe61=Object[_0x45b5c2(0x193)]||function(_0x36280d){const _0x43c38a=_0x45b5c2;var _0x2181df=[];for(var _0xaf263 in _0x36280d)if(Object[_0x43c38a(0x185)][_0x43c38a(0x18e)][_0x43c38a(0x1b0)](_0x36280d,_0xaf263))_0x2181df[_0x2181df['length']]=_0xaf263;return _0x2181df;},_0x10fe61(_0x259ee0);};return function(_0x23110d){const _0x2019bd=a13_0x5f48;if(_0x23110d&&_0x23110d[_0x2019bd(0x19e)])return _0x23110d;var _0x1c7072={};if(_0x23110d!=null){for(var _0x120a59=_0x10fe61(_0x23110d),_0x444aaf=0x0;_0x444aaf<_0x120a59[_0x2019bd(0x1b2)];_0x444aaf++)if(_0x120a59[_0x444aaf]!==_0x2019bd(0x1c8))__createBinding(_0x1c7072,_0x23110d,_0x120a59[_0x444aaf]);}return __setModuleDefault(_0x1c7072,_0x23110d),_0x1c7072;};}()),__importDefault=this&&this[a13_0xf85f0d(0x1f3)]||function(_0x2f5c91){return _0x2f5c91&&_0x2f5c91['__esModule']?_0x2f5c91:{'default':_0x2f5c91};};function a13_0x188a(){const _0x70fab5=['\x20not\x20enabled\x20for\x20shop\x20','40geWVLG','defineProperty','908811CkFLFE','isArray','test_gateway_','processCard','gatewayOrderId','gatewayPaymentId','create','paymentLink','paid','body','sendPaymentStatusNotification','__importStar','Payment\x20processed\x20successfully','payment.failed','currentPayments','payment','sendPaymentNotification','customerName','FAILED','../config/database','replace','get','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','json','name','testGatewayService','type','test_gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','Any\x20other\x20card\x20number','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20not\x20found','failureReason','__importDefault','TestGatewayController','failUrl','Payment\x20to\x20','includes',',\x20cannot\x20process','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20',',\x20status=','paymentLinkId','1218846YkcItJ','2365506HlAcLo','__createBinding','WebhookService','SINGLE','prototype','update','\x20->\x20','paymentMethod','status','processCardPayment','parse','gateway','Payment\x20status\x20is\x20','hasOwnProperty','customerEmail','orderId','Any\x20name','writable','getOwnPropertyNames','currency','\x20not\x20found','webhookService','findUnique','❌\x20Payment\x20link\x20','paidAt','successUrl','webhookLog','getPaymentForm','params','__esModule','../services/gateways/testGatewayService','1700644iFpZfz','ms)','shop','138253tPQPTC','175266dgDztI','📈\x20Found\x20payment\x20link\x20','sendShopWebhook','transactionId','resolve',',\x20currentPayments=','2sOBmnL','\x20updated:\x20currentPayments=','settings','\x20processed:\x20','PAID','shopId','call','now','length','POST','✅\x20Test\x20Gateway\x20payment\x20','5RMJzEE','application/json','Webhook\x20event\x20','Any\x20future\x20date\x20(MM/YY)','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','payment.success','slice','webhookUrl','PENDING','Payment\x20failed','webhookEvents','0000','cardNumber','5233380mISAHd','$transaction','error','4242\x204242\x204242\x204242','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','createdAt','default','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','failureMessage','🧪\x20Test\x20Gateway\x20result:','amount','COMPLETED','log'];a13_0x188a=function(){return _0x70fab5;};return a13_0x188a();}Object[a13_0xf85f0d(0x1d1)](exports,a13_0xf85f0d(0x19e),{'value':!![]}),exports[a13_0xf85f0d(0x1f4)]=void 0x0;const testGatewayService_1=require(a13_0xf85f0d(0x19f)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0xf85f0d(0x1e5)));class TestGatewayController{constructor(){const _0x54cbe9=a13_0xf85f0d;this[_0x54cbe9(0x19c)]=async(_0x182165,_0x4111b3,_0x526578)=>{const _0x36308e=_0x54cbe9;try{const {paymentId:_0xbe3567}=_0x182165[_0x36308e(0x19d)];console['log'](_0x36308e(0x1f9)+_0xbe3567);const _0x506acc=await database_1[_0x36308e(0x1c8)][_0x36308e(0x1e1)][_0x36308e(0x197)]({'where':{'id':_0xbe3567},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x506acc)return _0x4111b3['status'](0x194)[_0x36308e(0x1e9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x506acc[_0x36308e(0x18c)]!==_0x36308e(0x1ed))return _0x4111b3[_0x36308e(0x189)](0x190)['json']({'success':![],'message':_0x36308e(0x1ee)});if(_0x506acc[_0x36308e(0x189)]!==_0x36308e(0x1bd))return _0x4111b3[_0x36308e(0x189)](0x190)[_0x36308e(0x1e9)]({'success':![],'message':_0x36308e(0x18d)+_0x506acc[_0x36308e(0x189)]+_0x36308e(0x1f8)});_0x4111b3[_0x36308e(0x1e9)]({'success':!![],'result':{'paymentId':_0x506acc['id'],'orderId':_0x506acc[_0x36308e(0x1d6)],'amount':_0x506acc[_0x36308e(0x1cc)],'currency':_0x506acc[_0x36308e(0x194)],'merchantName':_0x506acc['shop'][_0x36308e(0x1ea)],'description':_0x36308e(0x1f6)+_0x506acc['shop'][_0x36308e(0x1ea)],'testInstructions':{'successCard':_0x36308e(0x1c5),'failureCard':_0x36308e(0x1ef),'expiryDate':_0x36308e(0x1b8),'cvc':'Any\x203-4\x20digits','holderName':_0x36308e(0x191)}}});}catch(_0x44dcf3){_0x526578(_0x44dcf3);}},this[_0x54cbe9(0x1d5)]=async(_0x3d9b9c,_0xb22de4,_0x5689e8)=>{const _0x22139f=_0x54cbe9;try{const {paymentId:_0x1b2420}=_0x3d9b9c['params'],_0x5becde=_0x3d9b9c[_0x22139f(0x1db)];console[_0x22139f(0x1ce)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1b2420);const _0x578934=await database_1['default'][_0x22139f(0x1e1)][_0x22139f(0x197)]({'where':{'id':_0x1b2420},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x578934)return _0xb22de4['status'](0x194)[_0x22139f(0x1e9)]({'success':![],'message':_0x22139f(0x1f1)});if(_0x578934[_0x22139f(0x18c)]!=='test_gateway')return _0xb22de4[_0x22139f(0x189)](0x190)['json']({'success':![],'message':_0x22139f(0x1ee)});if(_0x578934[_0x22139f(0x189)]!==_0x22139f(0x1bd))return _0xb22de4[_0x22139f(0x189)](0x190)[_0x22139f(0x1e9)]({'success':![],'message':_0x22139f(0x18d)+_0x578934[_0x22139f(0x189)]+_0x22139f(0x1f8)});const _0x1b8e7b=await this[_0x22139f(0x1eb)][_0x22139f(0x18a)]({'paymentId':_0x578934['id'],'orderId':_0x578934[_0x22139f(0x1d6)]||_0x578934['id'],'amount':_0x578934['amount'],'currency':_0x578934[_0x22139f(0x194)],'cardData':_0x5becde});console[_0x22139f(0x1ce)](_0x22139f(0x1cb),_0x1b8e7b);const _0x1c02ce={'status':_0x1b8e7b[_0x22139f(0x189)],'updatedAt':new Date()};if(_0x1b8e7b[_0x22139f(0x189)]===_0x22139f(0x1ae))_0x1c02ce[_0x22139f(0x199)]=new Date(),_0x1c02ce[_0x22139f(0x1d7)]=_0x1b8e7b[_0x22139f(0x1a7)];else _0x1b8e7b[_0x22139f(0x189)]===_0x22139f(0x1e4)&&(_0x1c02ce[_0x22139f(0x1ca)]=_0x1b8e7b[_0x22139f(0x1f2)]);const _0x2665e3=_0x5becde[_0x22139f(0x1c1)][_0x22139f(0x1e6)](/[\s-]/g,'');_0x1c02ce['cardLast4']=_0x2665e3[_0x22139f(0x1bb)](-0x4),_0x1c02ce[_0x22139f(0x188)]='test_card',await database_1[_0x22139f(0x1c8)]['payment'][_0x22139f(0x186)]({'where':{'id':_0x578934['id']},'data':_0x1c02ce});if(_0x1b8e7b['status']===_0x22139f(0x1ae)&&_0x578934[_0x22139f(0x1fb)]){console[_0x22139f(0x1ce)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x578934['id']+_0x22139f(0x1c9));try{await database_1[_0x22139f(0x1c8)][_0x22139f(0x1c3)](async _0x558644=>{const _0x266285=_0x22139f,_0x7476f9=await _0x558644[_0x266285(0x1d9)][_0x266285(0x197)]({'where':{'id':_0x578934[_0x266285(0x1fb)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x7476f9){console[_0x266285(0x1ce)](_0x266285(0x1a5)+_0x7476f9['id']+':\x20type='+_0x7476f9[_0x266285(0x1ec)]+_0x266285(0x1a9)+_0x7476f9[_0x266285(0x1e0)]+_0x266285(0x1fa)+_0x7476f9[_0x266285(0x189)]);const _0x34667e=_0x7476f9[_0x266285(0x1e0)]+0x1,_0xd5febd=_0x7476f9['type']===_0x266285(0x200)?_0x266285(0x1cd):_0x7476f9['status'];await _0x558644[_0x266285(0x1d9)][_0x266285(0x186)]({'where':{'id':_0x578934[_0x266285(0x1fb)]},'data':{'currentPayments':_0x34667e,'status':_0xd5febd,'updatedAt':new Date()}}),console[_0x266285(0x1ce)]('✅\x20Payment\x20link\x20'+_0x7476f9['id']+_0x266285(0x1ab)+_0x7476f9['currentPayments']+_0x266285(0x187)+_0x34667e+_0x266285(0x1fa)+_0x7476f9['status']+_0x266285(0x187)+_0xd5febd);}else console['log'](_0x266285(0x198)+_0x578934[_0x266285(0x1fb)]+_0x266285(0x195));});}catch(_0x448d77){console[_0x22139f(0x1c4)](_0x22139f(0x1e8),_0x448d77);}}await database_1[_0x22139f(0x1c8)][_0x22139f(0x19b)]['create']({'data':{'paymentId':_0x578934['id'],'shopId':_0x578934[_0x22139f(0x1af)],'event':_0x22139f(0x1d4)+_0x1b8e7b[_0x22139f(0x189)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x22139f(0x1bd),'newStatus':_0x1b8e7b[_0x22139f(0x189)],'transactionId':_0x1b8e7b[_0x22139f(0x1a7)],'failureReason':_0x1b8e7b[_0x22139f(0x1f2)],'processedAt':new Date()['toISOString']()})}}),await this[_0x22139f(0x1a6)](_0x578934,_0x1b8e7b[_0x22139f(0x189)],_0x1b8e7b['transactionId'],_0x1b8e7b['failureReason']),await this[_0x22139f(0x1dc)](_0x578934,_0x1b8e7b[_0x22139f(0x189)]),console['log'](_0x22139f(0x1b4)+_0x1b2420+_0x22139f(0x1ad)+_0x1b8e7b['status']),_0x1b8e7b['status']===_0x22139f(0x1ae)?_0xb22de4[_0x22139f(0x1e9)]({'success':!![],'message':_0x22139f(0x1de),'result':{'status':'PAID','transactionId':_0x1b8e7b['transactionId'],'redirectUrl':_0x578934[_0x22139f(0x19a)]}}):_0xb22de4['status'](0x190)[_0x22139f(0x1e9)]({'success':![],'message':_0x22139f(0x1be),'result':{'status':_0x22139f(0x1e4),'failureReason':_0x1b8e7b[_0x22139f(0x1f2)],'redirectUrl':_0x578934[_0x22139f(0x1f5)]}});}catch(_0x3a5e37){_0x5689e8(_0x3a5e37);}},this[_0x54cbe9(0x1eb)]=new testGatewayService_1['TestGatewayService'](),this[_0x54cbe9(0x196)]=new webhookService_1[(_0x54cbe9(0x1ff))]();}async[a13_0xf85f0d(0x1a6)](_0x95cee6,_0xd87abc,_0xf6d0ff,_0x4728a2){const _0x22151f=a13_0xf85f0d,_0x49831d=Date[_0x22151f(0x1b1)]();try{const _0x3a76d3=_0x95cee6[_0x22151f(0x1a2)],_0x3d2227=_0x3a76d3[_0x22151f(0x1ac)];if(!_0x3d2227?.[_0x22151f(0x1bc)]){console[_0x22151f(0x1ce)](_0x22151f(0x1c6)+_0x3a76d3['id']);return;}const _0xd1e9aa=_0xd87abc===_0x22151f(0x1ae)?_0x22151f(0x1ba):_0x22151f(0x1df);let _0x26b325=[];if(_0x3d2227['webhookEvents'])try{_0x26b325=Array[_0x22151f(0x1d3)](_0x3d2227[_0x22151f(0x1bf)])?_0x3d2227[_0x22151f(0x1bf)]:JSON[_0x22151f(0x18b)](_0x3d2227['webhookEvents']);}catch(_0x459a33){console[_0x22151f(0x1c4)]('Error\x20parsing\x20webhook\x20events:',_0x459a33),_0x26b325=[];}if(!_0x26b325[_0x22151f(0x1f7)](_0xd1e9aa)){console[_0x22151f(0x1ce)](_0x22151f(0x1b7)+_0xd1e9aa+_0x22151f(0x1cf)+_0x3a76d3['id']);return;}const _0x17d86a={'event':_0xd1e9aa,'payment':{'id':_0x95cee6['id'],'order_id':_0x95cee6[_0x22151f(0x190)],'gateway_order_id':_0x95cee6[_0x22151f(0x1d6)],'gateway':_0x22151f(0x1c0),'amount':_0x95cee6[_0x22151f(0x1cc)],'currency':_0x95cee6[_0x22151f(0x194)],'status':_0xd87abc['toLowerCase'](),'customer_email':_0x95cee6[_0x22151f(0x18f)],'customer_name':_0x95cee6[_0x22151f(0x1e3)],'transaction_id':_0xf6d0ff,'failure_message':_0x4728a2,'created_at':_0x95cee6[_0x22151f(0x1c7)],'updated_at':new Date()}},_0x3c8266=await fetch(_0x3d2227[_0x22151f(0x1bc)],{'method':_0x22151f(0x1b3),'headers':{'Content-Type':_0x22151f(0x1b6),'User-Agent':_0x22151f(0x1b9)},'body':JSON['stringify'](_0x17d86a)}),_0x245363=Date[_0x22151f(0x1b1)]()-_0x49831d;console[_0x22151f(0x1ce)](_0x22151f(0x1f0)+_0x3d2227[_0x22151f(0x1bc)]+'\x20with\x20status\x20'+_0x3c8266['status']+'\x20('+_0x245363+_0x22151f(0x1a1));}catch(_0x408457){console[_0x22151f(0x1c4)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x408457);}}async[a13_0xf85f0d(0x1dc)](_0x3d50b8,_0x2335c){const _0x15a150=a13_0xf85f0d;try{const {telegramBotService:_0x22251f}=await Promise[_0x15a150(0x1a8)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x38ed9d={'PAID':_0x15a150(0x1da),'FAILED':'failed'},_0x56ee0d=_0x38ed9d[_0x2335c];if(!_0x56ee0d)return;await _0x22251f[_0x15a150(0x1e2)](_0x3d50b8['shopId'],_0x3d50b8,_0x56ee0d);}catch(_0x372f17){console[_0x15a150(0x1c4)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x372f17);}}}exports['TestGatewayController']=TestGatewayController;