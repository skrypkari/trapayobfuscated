'use strict';function a13_0x3acc(_0x2eb980,_0x2fa54e){const _0x532ead=a13_0x532e();return a13_0x3acc=function(_0x3accd1,_0x14893c){_0x3accd1=_0x3accd1-0x1e4;let _0x4e6e4e=_0x532ead[_0x3accd1];return _0x4e6e4e;},a13_0x3acc(_0x2eb980,_0x2fa54e);}const a13_0x5ec311=a13_0x3acc;(function(_0x55861c,_0x5dfa30){const _0x3af75e=a13_0x3acc,_0xaef7fd=_0x55861c();while(!![]){try{const _0x2a5429=parseInt(_0x3af75e(0x209))/0x1+parseInt(_0x3af75e(0x25b))/0x2*(-parseInt(_0x3af75e(0x246))/0x3)+-parseInt(_0x3af75e(0x241))/0x4+parseInt(_0x3af75e(0x1ec))/0x5*(-parseInt(_0x3af75e(0x244))/0x6)+-parseInt(_0x3af75e(0x213))/0x7+-parseInt(_0x3af75e(0x1fe))/0x8*(-parseInt(_0x3af75e(0x250))/0x9)+parseInt(_0x3af75e(0x216))/0xa;if(_0x2a5429===_0x5dfa30)break;else _0xaef7fd['push'](_0xaef7fd['shift']());}catch(_0xdccf50){_0xaef7fd['push'](_0xaef7fd['shift']());}}}(a13_0x532e,0x6fad6));var __createBinding=this&&this['__createBinding']||(Object[a13_0x5ec311(0x249)]?function(_0x3d9def,_0x45cd3c,_0x1651c5,_0x1d66f0){const _0x3392f8=a13_0x5ec311;if(_0x1d66f0===undefined)_0x1d66f0=_0x1651c5;var _0x13a49f=Object[_0x3392f8(0x25f)](_0x45cd3c,_0x1651c5);(!_0x13a49f||(_0x3392f8(0x1f4)in _0x13a49f?!_0x45cd3c[_0x3392f8(0x228)]:_0x13a49f[_0x3392f8(0x21a)]||_0x13a49f[_0x3392f8(0x229)]))&&(_0x13a49f={'enumerable':!![],'get':function(){return _0x45cd3c[_0x1651c5];}}),Object[_0x3392f8(0x222)](_0x3d9def,_0x1d66f0,_0x13a49f);}:function(_0x1c979d,_0xa14dbb,_0x3e1dd9,_0x21d9f4){if(_0x21d9f4===undefined)_0x21d9f4=_0x3e1dd9;_0x1c979d[_0x21d9f4]=_0xa14dbb[_0x3e1dd9];}),__setModuleDefault=this&&this[a13_0x5ec311(0x21e)]||(Object[a13_0x5ec311(0x249)]?function(_0x17e309,_0x361a1e){const _0x4db077=a13_0x5ec311;Object[_0x4db077(0x222)](_0x17e309,_0x4db077(0x23d),{'enumerable':!![],'value':_0x361a1e});}:function(_0x35cd51,_0x179ded){const _0x3a7052=a13_0x5ec311;_0x35cd51[_0x3a7052(0x23d)]=_0x179ded;}),__importStar=this&&this['__importStar']||(function(){var _0x5d08c8=function(_0x1c28ab){const _0x22d518=a13_0x3acc;return _0x5d08c8=Object[_0x22d518(0x217)]||function(_0x57152){const _0xa547bb=_0x22d518;var _0x2e3173=[];for(var _0x340422 in _0x57152)if(Object[_0xa547bb(0x1e6)]['hasOwnProperty'][_0xa547bb(0x1e5)](_0x57152,_0x340422))_0x2e3173[_0x2e3173[_0xa547bb(0x20d)]]=_0x340422;return _0x2e3173;},_0x5d08c8(_0x1c28ab);};return function(_0x49b4a1){const _0xff18a0=a13_0x3acc;if(_0x49b4a1&&_0x49b4a1[_0xff18a0(0x228)])return _0x49b4a1;var _0x1e16e0={};if(_0x49b4a1!=null){for(var _0x31b0d5=_0x5d08c8(_0x49b4a1),_0x441244=0x0;_0x441244<_0x31b0d5[_0xff18a0(0x20d)];_0x441244++)if(_0x31b0d5[_0x441244]!==_0xff18a0(0x23d))__createBinding(_0x1e16e0,_0x49b4a1,_0x31b0d5[_0x441244]);}return __setModuleDefault(_0x1e16e0,_0x49b4a1),_0x1e16e0;};}()),__importDefault=this&&this[a13_0x5ec311(0x227)]||function(_0x27eac4){const _0x9ba175=a13_0x5ec311;return _0x27eac4&&_0x27eac4[_0x9ba175(0x228)]?_0x27eac4:{'default':_0x27eac4};};Object[a13_0x5ec311(0x222)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x532e(){const _0x48d071=['test_gateway','name','get','slice','PAID','webhookUrl','Payment\x20is\x20not\x20for\x20test\x20gateway','Payment\x20not\x20found','cardNumber','shop','../services/gateways/testGatewayService','failureMessage','43792PALRlz','paymentMethod','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','toISOString','test_card','gatewayOrderId','params','Any\x203-4\x20digits','sendPaymentStatusNotification','shopId','paymentLink','380393yeBIwm','parse','testGatewayService','now','length','test_gateway_','processCard','findUnique','✅\x20Test\x20Gateway\x20payment\x20','\x20processed:\x20','2259803hujSmw','failed','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','14875760THJTqO','getOwnPropertyNames','transactionId','getPaymentForm','writable','sendPaymentNotification','Error\x20parsing\x20webhook\x20events:','\x20with\x20status\x20','__setModuleDefault','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','payment','Any\x20name','defineProperty','amount','🧪\x20Test\x20Gateway\x20result:','body','cardLast4','__importDefault','__esModule','configurable','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','createdAt','ms)','then','gateway','Any\x20future\x20date\x20(MM/YY)','failureReason','processCardPayment','isArray','Payment\x20processed\x20successfully',',\x20currentPayments=','COMPLETED','Any\x20other\x20card\x20number','json','sendShopWebhook','includes','currentPayments','default','Payment\x20status\x20is\x20','FAILED',',\x20cannot\x20process','1745336UIcFKq','webhookEvents','$transaction','9084jBWjjh','\x20not\x20enabled\x20for\x20shop\x20','57DdLhgw','\x20not\x20found','Payment\x20to\x20','create','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','../config/database','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paid','gatewayPaymentId','payment.success','567uYorqm','Payment\x20failed','orderId','log','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','TestGatewayController','0000','customerName','POST','status','error','69328kvFhFp','stringify','replace','4242\x204242\x204242\x204242','getOwnPropertyDescriptor','webhookLog','currency','update','📈\x20Found\x20payment\x20link\x20','\x20->\x20','type','call','prototype','❌\x20Payment\x20link\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',',\x20status=','\x20updated:\x20currentPayments=','successUrl','1115HITvSD','paymentLinkId','../services/telegramBotService','PENDING','resolve','SINGLE'];a13_0x532e=function(){return _0x48d071;};return a13_0x532e();}const testGatewayService_1=require(a13_0x5ec311(0x1fc)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x5ec311(0x24b)));class TestGatewayController{constructor(){const _0x25f521=a13_0x5ec311;this[_0x25f521(0x219)]=async(_0xa46489,_0x58c7d5,_0x42dc75)=>{const _0x14586c=_0x25f521;try{const {paymentId:_0x464846}=_0xa46489[_0x14586c(0x204)];console['log'](_0x14586c(0x254)+_0x464846);const _0x4ce1af=await database_1['default']['payment'][_0x14586c(0x210)]({'where':{'id':_0x464846},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4ce1af)return _0x58c7d5['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x4ce1af['gateway']!==_0x14586c(0x1f2))return _0x58c7d5[_0x14586c(0x259)](0x190)['json']({'success':![],'message':_0x14586c(0x1f8)});if(_0x4ce1af['status']!==_0x14586c(0x1ef))return _0x58c7d5[_0x14586c(0x259)](0x190)[_0x14586c(0x239)]({'success':![],'message':_0x14586c(0x23e)+_0x4ce1af[_0x14586c(0x259)]+_0x14586c(0x240)});_0x58c7d5[_0x14586c(0x239)]({'success':!![],'result':{'paymentId':_0x4ce1af['id'],'orderId':_0x4ce1af[_0x14586c(0x203)],'amount':_0x4ce1af[_0x14586c(0x223)],'currency':_0x4ce1af[_0x14586c(0x261)],'merchantName':_0x4ce1af[_0x14586c(0x1fb)][_0x14586c(0x1f3)],'description':_0x14586c(0x248)+_0x4ce1af[_0x14586c(0x1fb)][_0x14586c(0x1f3)],'testInstructions':{'successCard':_0x14586c(0x25e),'failureCard':_0x14586c(0x238),'expiryDate':_0x14586c(0x231),'cvc':_0x14586c(0x205),'holderName':_0x14586c(0x221)}}});}catch(_0x389a52){_0x42dc75(_0x389a52);}},this[_0x25f521(0x20f)]=async(_0x41affd,_0x57635d,_0x485e82)=>{const _0x4dffc7=_0x25f521;try{const {paymentId:_0xe5a0e4}=_0x41affd[_0x4dffc7(0x204)],_0x5d30d0=_0x41affd[_0x4dffc7(0x225)];console['log'](_0x4dffc7(0x215)+_0xe5a0e4);const _0x5f2fec=await database_1[_0x4dffc7(0x23d)][_0x4dffc7(0x220)][_0x4dffc7(0x210)]({'where':{'id':_0xe5a0e4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5f2fec)return _0x57635d[_0x4dffc7(0x259)](0x194)[_0x4dffc7(0x239)]({'success':![],'message':_0x4dffc7(0x1f9)});if(_0x5f2fec[_0x4dffc7(0x230)]!==_0x4dffc7(0x1f2))return _0x57635d['status'](0x190)[_0x4dffc7(0x239)]({'success':![],'message':_0x4dffc7(0x1f8)});if(_0x5f2fec[_0x4dffc7(0x259)]!==_0x4dffc7(0x1ef))return _0x57635d[_0x4dffc7(0x259)](0x190)[_0x4dffc7(0x239)]({'success':![],'message':_0x4dffc7(0x23e)+_0x5f2fec[_0x4dffc7(0x259)]+',\x20cannot\x20process'});const _0x54bfa4=await this[_0x4dffc7(0x20b)][_0x4dffc7(0x233)]({'paymentId':_0x5f2fec['id'],'orderId':_0x5f2fec[_0x4dffc7(0x203)]||_0x5f2fec['id'],'amount':_0x5f2fec[_0x4dffc7(0x223)],'currency':_0x5f2fec['currency'],'cardData':_0x5d30d0});console[_0x4dffc7(0x253)](_0x4dffc7(0x224),_0x54bfa4);const _0x1eed21={'status':_0x54bfa4[_0x4dffc7(0x259)],'updatedAt':new Date()};if(_0x54bfa4['status']===_0x4dffc7(0x1f6))_0x1eed21['paidAt']=new Date(),_0x1eed21[_0x4dffc7(0x24e)]=_0x54bfa4[_0x4dffc7(0x218)];else _0x54bfa4[_0x4dffc7(0x259)]===_0x4dffc7(0x23f)&&(_0x1eed21[_0x4dffc7(0x1fd)]=_0x54bfa4[_0x4dffc7(0x232)]);const _0x322e48=_0x5d30d0[_0x4dffc7(0x1fa)][_0x4dffc7(0x25d)](/[\s-]/g,'');_0x1eed21[_0x4dffc7(0x226)]=_0x322e48[_0x4dffc7(0x1f5)](-0x4),_0x1eed21[_0x4dffc7(0x1ff)]=_0x4dffc7(0x202),await database_1['default'][_0x4dffc7(0x220)][_0x4dffc7(0x262)]({'where':{'id':_0x5f2fec['id']},'data':_0x1eed21});if(_0x54bfa4[_0x4dffc7(0x259)]===_0x4dffc7(0x1f6)&&_0x5f2fec[_0x4dffc7(0x1ed)]){console[_0x4dffc7(0x253)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x5f2fec['id']+_0x4dffc7(0x21f));try{await database_1['default'][_0x4dffc7(0x243)](async _0x5f26ef=>{const _0x93adc0=_0x4dffc7,_0x20a70f=await _0x5f26ef[_0x93adc0(0x208)]['findUnique']({'where':{'id':_0x5f2fec[_0x93adc0(0x1ed)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x20a70f){console[_0x93adc0(0x253)](_0x93adc0(0x263)+_0x20a70f['id']+':\x20type='+_0x20a70f[_0x93adc0(0x1e4)]+_0x93adc0(0x236)+_0x20a70f[_0x93adc0(0x23c)]+_0x93adc0(0x1e9)+_0x20a70f[_0x93adc0(0x259)]);const _0x419b13=_0x20a70f[_0x93adc0(0x23c)]+0x1,_0x29b860=_0x20a70f['type']===_0x93adc0(0x1f1)?_0x93adc0(0x237):_0x20a70f[_0x93adc0(0x259)];await _0x5f26ef['paymentLink']['update']({'where':{'id':_0x5f2fec[_0x93adc0(0x1ed)]},'data':{'currentPayments':_0x419b13,'status':_0x29b860,'updatedAt':new Date()}}),console[_0x93adc0(0x253)]('✅\x20Payment\x20link\x20'+_0x20a70f['id']+_0x93adc0(0x1ea)+_0x20a70f[_0x93adc0(0x23c)]+_0x93adc0(0x264)+_0x419b13+',\x20status='+_0x20a70f[_0x93adc0(0x259)]+_0x93adc0(0x264)+_0x29b860);}else console['log'](_0x93adc0(0x1e7)+_0x5f2fec[_0x93adc0(0x1ed)]+_0x93adc0(0x247));});}catch(_0x2f7913){console[_0x4dffc7(0x25a)](_0x4dffc7(0x200),_0x2f7913);}}await database_1[_0x4dffc7(0x23d)][_0x4dffc7(0x260)]['create']({'data':{'paymentId':_0x5f2fec['id'],'shopId':_0x5f2fec[_0x4dffc7(0x207)],'event':_0x4dffc7(0x20e)+_0x54bfa4[_0x4dffc7(0x259)][_0x4dffc7(0x22b)](),'statusCode':0xc8,'responseBody':JSON[_0x4dffc7(0x25c)]({'oldStatus':_0x4dffc7(0x1ef),'newStatus':_0x54bfa4['status'],'transactionId':_0x54bfa4[_0x4dffc7(0x218)],'failureReason':_0x54bfa4[_0x4dffc7(0x232)],'processedAt':new Date()[_0x4dffc7(0x201)]()})}}),await this[_0x4dffc7(0x23a)](_0x5f2fec,_0x54bfa4[_0x4dffc7(0x259)],_0x54bfa4[_0x4dffc7(0x218)],_0x54bfa4[_0x4dffc7(0x232)]),await this[_0x4dffc7(0x206)](_0x5f2fec,_0x54bfa4['status']),console['log'](_0x4dffc7(0x211)+_0xe5a0e4+_0x4dffc7(0x212)+_0x54bfa4[_0x4dffc7(0x259)]),_0x54bfa4[_0x4dffc7(0x259)]===_0x4dffc7(0x1f6)?_0x57635d[_0x4dffc7(0x239)]({'success':!![],'message':_0x4dffc7(0x235),'result':{'status':'PAID','transactionId':_0x54bfa4[_0x4dffc7(0x218)],'redirectUrl':_0x5f2fec[_0x4dffc7(0x1eb)]}}):_0x57635d['status'](0x190)[_0x4dffc7(0x239)]({'success':![],'message':_0x4dffc7(0x251),'result':{'status':_0x4dffc7(0x23f),'failureReason':_0x54bfa4['failureReason'],'redirectUrl':_0x5f2fec['failUrl']}});}catch(_0x2da7d5){_0x485e82(_0x2da7d5);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x2907b3,_0x536e48,_0x3e56ec,_0x3aecc7){const _0x2f6325=a13_0x5ec311,_0x1f824a=Date[_0x2f6325(0x20c)]();try{const _0x377409=_0x2907b3[_0x2f6325(0x1fb)],_0x25a297=_0x377409['settings'];if(!_0x25a297?.['webhookUrl']){console[_0x2f6325(0x253)](_0x2f6325(0x1e8)+_0x377409['id']);return;}const _0x55a8a3=_0x536e48===_0x2f6325(0x1f6)?_0x2f6325(0x24f):'payment.failed';let _0x2323f9=[];if(_0x25a297['webhookEvents'])try{_0x2323f9=Array[_0x2f6325(0x234)](_0x25a297[_0x2f6325(0x242)])?_0x25a297[_0x2f6325(0x242)]:JSON[_0x2f6325(0x20a)](_0x25a297[_0x2f6325(0x242)]);}catch(_0x540a6c){console[_0x2f6325(0x25a)](_0x2f6325(0x21c),_0x540a6c),_0x2323f9=[];}if(!_0x2323f9[_0x2f6325(0x23b)](_0x55a8a3)){console[_0x2f6325(0x253)]('Webhook\x20event\x20'+_0x55a8a3+_0x2f6325(0x245)+_0x377409['id']);return;}const _0x18da84={'event':_0x55a8a3,'payment':{'id':_0x2907b3['id'],'order_id':_0x2907b3[_0x2f6325(0x252)],'gateway_order_id':_0x2907b3['gatewayOrderId'],'gateway':_0x2f6325(0x256),'amount':_0x2907b3[_0x2f6325(0x223)],'currency':_0x2907b3[_0x2f6325(0x261)],'status':_0x536e48[_0x2f6325(0x22b)](),'customer_email':_0x2907b3['customerEmail'],'customer_name':_0x2907b3[_0x2f6325(0x257)],'transaction_id':_0x3e56ec,'failure_message':_0x3aecc7,'created_at':_0x2907b3[_0x2f6325(0x22d)],'updated_at':new Date()}},_0x119459=await fetch(_0x25a297[_0x2f6325(0x1f7)],{'method':_0x2f6325(0x258),'headers':{'Content-Type':'application/json','User-Agent':_0x2f6325(0x24a)},'body':JSON[_0x2f6325(0x25c)](_0x18da84)}),_0x50db4b=Date['now']()-_0x1f824a;console[_0x2f6325(0x253)](_0x2f6325(0x24c)+_0x25a297[_0x2f6325(0x1f7)]+_0x2f6325(0x21d)+_0x119459[_0x2f6325(0x259)]+'\x20('+_0x50db4b+_0x2f6325(0x22e));}catch(_0x270edd){console[_0x2f6325(0x25a)](_0x2f6325(0x22a),_0x270edd);}}async[a13_0x5ec311(0x206)](_0x467fcb,_0xc7d088){const _0x2f7380=a13_0x5ec311;try{const {telegramBotService:_0x35bf6c}=await Promise[_0x2f7380(0x1f0)]()[_0x2f7380(0x22f)](()=>__importStar(require(_0x2f7380(0x1ee)))),_0x45d6f8={'PAID':_0x2f7380(0x24d),'FAILED':_0x2f7380(0x214)},_0x10dd38=_0x45d6f8[_0xc7d088];if(!_0x10dd38)return;await _0x35bf6c[_0x2f7380(0x21b)](_0x467fcb[_0x2f7380(0x207)],_0x467fcb,_0x10dd38);}catch(_0x4af7c5){console[_0x2f7380(0x25a)](_0x2f7380(0x22c),_0x4af7c5);}}}exports[a13_0x5ec311(0x255)]=TestGatewayController;