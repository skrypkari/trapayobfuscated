'use strict';function a13_0x1831(){const _0x189e18=['status','paymentLinkId','toISOString','settings','1523750THASiD','processCard','payment','payment.failed','get','failureMessage','ms)','‚úÖ\x20Test\x20Gateway\x20payment\x20','prototype','COMPLETED','FAILED','sendShopWebhook','Any\x20future\x20date\x20(MM/YY)',',\x20currentPayments=','../services/telegramBotService','1611423xWtEiQ','PENDING','log','paidAt','transactionId','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20failed','shop','Payment\x20processed\x20successfully','paymentMethod','Payment\x20is\x20not\x20for\x20test\x20gateway','../config/database','__esModule','TestGatewayService','paid','failureReason','\x20->\x20','call','../services/gateways/testGatewayService','1862154PYwhdy','../services/webhookService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','parse','\x20updated:\x20currentPayments=','0000','Any\x203-4\x20digits',',\x20status=','$transaction','isArray','POST','getPaymentForm','paymentLink','__importStar','json','2yUDRJs','PAID','now','shopId','default','4242\x204242\x204242\x204242','webhookEvents','getOwnPropertyNames','WebhookService','2554731VGcjgV','1179152SUOfWh','payment.success','stringify','cardNumber','\x20not\x20enabled\x20for\x20shop\x20','findUnique','test_card','Error\x20parsing\x20webhook\x20events:','Any\x20name','__createBinding','currentPayments','test_gateway_','__importDefault','867056YvqEdK','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20cannot\x20process','gatewayOrderId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','successUrl','configurable','failUrl','update','toLowerCase','392161EyGJff','testGatewayService','üß™\x20Test\x20Gateway\x20result:','‚úÖ\x20Payment\x20link\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','amount','getOwnPropertyDescriptor','error','resolve','TestGatewayController','orderId','create','params','\x20with\x20status\x20','7EOZOxD','processCardPayment','replace','webhookUrl','currency','defineProperty','customerEmail','\x20not\x20found','type','\x20processed:\x20','gateway','cardLast4','application/json','üìà\x20Test\x20Gateway:\x20Payment\x20','then','sendPaymentStatusNotification'];a13_0x1831=function(){return _0x189e18;};return a13_0x1831();}const a13_0x58ee82=a13_0x3312;(function(_0x202664,_0x21b612){const _0x44357e=a13_0x3312,_0x2d5b03=_0x202664();while(!![]){try{const _0x833ea=parseInt(_0x44357e(0x213))/0x1*(-parseInt(_0x44357e(0x1f2))/0x2)+-parseInt(_0x44357e(0x1d0))/0x3+parseInt(_0x44357e(0x1fc))/0x4+parseInt(_0x44357e(0x1c1))/0x5+parseInt(_0x44357e(0x1e3))/0x6+-parseInt(_0x44357e(0x1ad))/0x7*(-parseInt(_0x44357e(0x209))/0x8)+parseInt(_0x44357e(0x1fb))/0x9;if(_0x833ea===_0x21b612)break;else _0x2d5b03['push'](_0x2d5b03['shift']());}catch(_0x4b3452){_0x2d5b03['push'](_0x2d5b03['shift']());}}}(a13_0x1831,0x5b064));var __createBinding=this&&this[a13_0x58ee82(0x205)]||(Object[a13_0x58ee82(0x1aa)]?function(_0x19941d,_0x267c88,_0x5dfc3c,_0x178765){const _0x4d2c3d=a13_0x58ee82;if(_0x178765===undefined)_0x178765=_0x5dfc3c;var _0x57bb5e=Object[_0x4d2c3d(0x1a5)](_0x267c88,_0x5dfc3c);(!_0x57bb5e||(_0x4d2c3d(0x1c5)in _0x57bb5e?!_0x267c88[_0x4d2c3d(0x1dc)]:_0x57bb5e['writable']||_0x57bb5e[_0x4d2c3d(0x20f)]))&&(_0x57bb5e={'enumerable':!![],'get':function(){return _0x267c88[_0x5dfc3c];}}),Object[_0x4d2c3d(0x1b2)](_0x19941d,_0x178765,_0x57bb5e);}:function(_0x4bdb7e,_0x49d091,_0x44b58b,_0x3ae564){if(_0x3ae564===undefined)_0x3ae564=_0x44b58b;_0x4bdb7e[_0x3ae564]=_0x49d091[_0x44b58b];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0xc11535,_0x510593){const _0x2259d9=a13_0x58ee82;Object[_0x2259d9(0x1b2)](_0xc11535,_0x2259d9(0x1f6),{'enumerable':!![],'value':_0x510593});}:function(_0x5c72ba,_0x34ae25){const _0x18fb29=a13_0x58ee82;_0x5c72ba[_0x18fb29(0x1f6)]=_0x34ae25;}),__importStar=this&&this[a13_0x58ee82(0x1f0)]||(function(){var _0x44d8=function(_0x56cf22){const _0x23a444=a13_0x3312;return _0x44d8=Object[_0x23a444(0x1f9)]||function(_0x2cfb81){const _0xf0acd7=_0x23a444;var _0x4577ca=[];for(var _0x40479b in _0x2cfb81)if(Object[_0xf0acd7(0x1c9)]['hasOwnProperty'][_0xf0acd7(0x1e1)](_0x2cfb81,_0x40479b))_0x4577ca[_0x4577ca['length']]=_0x40479b;return _0x4577ca;},_0x44d8(_0x56cf22);};return function(_0x4303da){const _0x4159cd=a13_0x3312;if(_0x4303da&&_0x4303da[_0x4159cd(0x1dc)])return _0x4303da;var _0x262669={};if(_0x4303da!=null){for(var _0x3c7752=_0x44d8(_0x4303da),_0x1f0394=0x0;_0x1f0394<_0x3c7752['length'];_0x1f0394++)if(_0x3c7752[_0x1f0394]!==_0x4159cd(0x1f6))__createBinding(_0x262669,_0x4303da,_0x3c7752[_0x1f0394]);}return __setModuleDefault(_0x262669,_0x4303da),_0x262669;};}()),__importDefault=this&&this[a13_0x58ee82(0x208)]||function(_0x38a00a){const _0x505e04=a13_0x58ee82;return _0x38a00a&&_0x38a00a[_0x505e04(0x1dc)]?_0x38a00a:{'default':_0x38a00a};};function a13_0x3312(_0x335382,_0x47798b){const _0x18318a=a13_0x1831();return a13_0x3312=function(_0x3312e8,_0x299ce0){_0x3312e8=_0x3312e8-0x1a5;let _0x38952e=_0x18318a[_0x3312e8];return _0x38952e;},a13_0x3312(_0x335382,_0x47798b);}Object[a13_0x58ee82(0x1b2)](exports,a13_0x58ee82(0x1dc),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x58ee82(0x1e2)),webhookService_1=require(a13_0x58ee82(0x1e4)),database_1=__importDefault(require(a13_0x58ee82(0x1db)));class TestGatewayController{constructor(){const _0x35538e=a13_0x58ee82;this[_0x35538e(0x1ee)]=async(_0x12795c,_0x222cc5,_0xd31adb)=>{const _0xf81b90=_0x35538e;try{const {paymentId:_0x541d66}=_0x12795c[_0xf81b90(0x1ab)];console[_0xf81b90(0x1d2)](_0xf81b90(0x1d5)+_0x541d66);const _0x32b978=await database_1[_0xf81b90(0x1f6)][_0xf81b90(0x1c3)][_0xf81b90(0x201)]({'where':{'id':_0x541d66},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x32b978)return _0x222cc5['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x32b978[_0xf81b90(0x1b7)]!=='test_gateway')return _0x222cc5['status'](0x190)['json']({'success':![],'message':_0xf81b90(0x1da)});if(_0x32b978[_0xf81b90(0x1bd)]!==_0xf81b90(0x1d1))return _0x222cc5['status'](0x190)[_0xf81b90(0x1f1)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x32b978[_0xf81b90(0x1bd)]+_0xf81b90(0x20b)});_0x222cc5[_0xf81b90(0x1f1)]({'success':!![],'result':{'paymentId':_0x32b978['id'],'orderId':_0x32b978[_0xf81b90(0x20c)],'amount':_0x32b978['amount'],'currency':_0x32b978[_0xf81b90(0x1b1)],'merchantName':_0x32b978[_0xf81b90(0x1d7)]['name'],'description':'Payment\x20to\x20'+_0x32b978[_0xf81b90(0x1d7)]['name'],'testInstructions':{'successCard':_0xf81b90(0x1f7),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0xf81b90(0x1cd),'cvc':_0xf81b90(0x1e9),'holderName':_0xf81b90(0x204)}}});}catch(_0x294b3f){_0xd31adb(_0x294b3f);}},this[_0x35538e(0x1c2)]=async(_0x475ffd,_0x206e42,_0xd7cdbb)=>{const _0x20cc0d=_0x35538e;try{const {paymentId:_0x2dd700}=_0x475ffd['params'],_0x471b9c=_0x475ffd['body'];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x2dd700);const _0x2316b5=await database_1[_0x20cc0d(0x1f6)][_0x20cc0d(0x1c3)]['findUnique']({'where':{'id':_0x2dd700},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2316b5)return _0x206e42[_0x20cc0d(0x1bd)](0x194)[_0x20cc0d(0x1f1)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2316b5[_0x20cc0d(0x1b7)]!=='test_gateway')return _0x206e42[_0x20cc0d(0x1bd)](0x190)['json']({'success':![],'message':_0x20cc0d(0x1da)});if(_0x2316b5['status']!=='PENDING')return _0x206e42[_0x20cc0d(0x1bd)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2316b5['status']+_0x20cc0d(0x20b)});const _0x2b0b3f=await this['testGatewayService'][_0x20cc0d(0x1ae)]({'paymentId':_0x2316b5['id'],'orderId':_0x2316b5['gatewayOrderId']||_0x2316b5['id'],'amount':_0x2316b5[_0x20cc0d(0x218)],'currency':_0x2316b5[_0x20cc0d(0x1b1)],'cardData':_0x471b9c});console['log'](_0x20cc0d(0x215),_0x2b0b3f);const _0x4406c8={'status':_0x2b0b3f[_0x20cc0d(0x1bd)],'updatedAt':new Date()};if(_0x2b0b3f[_0x20cc0d(0x1bd)]===_0x20cc0d(0x1f3))_0x4406c8[_0x20cc0d(0x1d3)]=new Date(),_0x4406c8['gatewayPaymentId']=_0x2b0b3f[_0x20cc0d(0x1d4)];else _0x2b0b3f[_0x20cc0d(0x1bd)]===_0x20cc0d(0x1cb)&&(_0x4406c8[_0x20cc0d(0x1c6)]=_0x2b0b3f[_0x20cc0d(0x1df)]);const _0x5d2d39=_0x471b9c[_0x20cc0d(0x1ff)][_0x20cc0d(0x1af)](/[\s-]/g,'');_0x4406c8[_0x20cc0d(0x1b8)]=_0x5d2d39['slice'](-0x4),_0x4406c8[_0x20cc0d(0x1d9)]=_0x20cc0d(0x202),await database_1[_0x20cc0d(0x1f6)]['payment'][_0x20cc0d(0x211)]({'where':{'id':_0x2316b5['id']},'data':_0x4406c8});if(_0x2b0b3f[_0x20cc0d(0x1bd)]===_0x20cc0d(0x1f3)&&_0x2316b5[_0x20cc0d(0x1be)]){console['log'](_0x20cc0d(0x1ba)+_0x2316b5['id']+_0x20cc0d(0x1e5));try{await database_1['default'][_0x20cc0d(0x1eb)](async _0x4c0670=>{const _0x11e312=_0x20cc0d,_0x764f29=await _0x4c0670['paymentLink'][_0x11e312(0x201)]({'where':{'id':_0x2316b5[_0x11e312(0x1be)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x764f29){console[_0x11e312(0x1d2)]('üìà\x20Found\x20payment\x20link\x20'+_0x764f29['id']+':\x20type='+_0x764f29[_0x11e312(0x1b5)]+_0x11e312(0x1ce)+_0x764f29[_0x11e312(0x206)]+_0x11e312(0x1ea)+_0x764f29['status']);const _0x383556=_0x764f29['currentPayments']+0x1,_0x47e39d=_0x764f29[_0x11e312(0x1b5)]==='SINGLE'?_0x11e312(0x1ca):_0x764f29[_0x11e312(0x1bd)];await _0x4c0670[_0x11e312(0x1ef)]['update']({'where':{'id':_0x2316b5[_0x11e312(0x1be)]},'data':{'currentPayments':_0x383556,'status':_0x47e39d,'updatedAt':new Date()}}),console['log'](_0x11e312(0x216)+_0x764f29['id']+_0x11e312(0x1e7)+_0x764f29[_0x11e312(0x206)]+_0x11e312(0x1e0)+_0x383556+_0x11e312(0x1ea)+_0x764f29[_0x11e312(0x1bd)]+_0x11e312(0x1e0)+_0x47e39d);}else console[_0x11e312(0x1d2)]('‚ùå\x20Payment\x20link\x20'+_0x2316b5[_0x11e312(0x1be)]+_0x11e312(0x1b4));});}catch(_0x2a9da8){console[_0x20cc0d(0x1a6)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x2a9da8);}}await database_1[_0x20cc0d(0x1f6)]['webhookLog'][_0x20cc0d(0x1aa)]({'data':{'paymentId':_0x2316b5['id'],'shopId':_0x2316b5[_0x20cc0d(0x1f5)],'event':_0x20cc0d(0x207)+_0x2b0b3f['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x20cc0d(0x1d1),'newStatus':_0x2b0b3f[_0x20cc0d(0x1bd)],'transactionId':_0x2b0b3f[_0x20cc0d(0x1d4)],'failureReason':_0x2b0b3f['failureReason'],'processedAt':new Date()[_0x20cc0d(0x1bf)]()})}}),await this['sendShopWebhook'](_0x2316b5,_0x2b0b3f[_0x20cc0d(0x1bd)],_0x2b0b3f['transactionId'],_0x2b0b3f[_0x20cc0d(0x1df)]),await this['sendPaymentStatusNotification'](_0x2316b5,_0x2b0b3f[_0x20cc0d(0x1bd)]),console['log'](_0x20cc0d(0x1c8)+_0x2dd700+_0x20cc0d(0x1b6)+_0x2b0b3f[_0x20cc0d(0x1bd)]),_0x2b0b3f[_0x20cc0d(0x1bd)]===_0x20cc0d(0x1f3)?_0x206e42['json']({'success':!![],'message':_0x20cc0d(0x1d8),'result':{'status':'PAID','transactionId':_0x2b0b3f[_0x20cc0d(0x1d4)],'redirectUrl':_0x2316b5[_0x20cc0d(0x20e)]}}):_0x206e42[_0x20cc0d(0x1bd)](0x190)[_0x20cc0d(0x1f1)]({'success':![],'message':_0x20cc0d(0x1d6),'result':{'status':_0x20cc0d(0x1cb),'failureReason':_0x2b0b3f[_0x20cc0d(0x1df)],'redirectUrl':_0x2316b5[_0x20cc0d(0x210)]}});}catch(_0x136ff4){_0xd7cdbb(_0x136ff4);}},this[_0x35538e(0x214)]=new testGatewayService_1[(_0x35538e(0x1dd))](),this['webhookService']=new webhookService_1[(_0x35538e(0x1fa))]();}async[a13_0x58ee82(0x1cc)](_0x52afe8,_0x293418,_0x5db704,_0x155313){const _0x35d89a=a13_0x58ee82,_0x54c712=Date[_0x35d89a(0x1f4)]();try{const _0x5b4869=_0x52afe8[_0x35d89a(0x1d7)],_0x26550e=_0x5b4869[_0x35d89a(0x1c0)];if(!_0x26550e?.[_0x35d89a(0x1b0)]){console['log'](_0x35d89a(0x217)+_0x5b4869['id']);return;}const _0x2d7650=_0x293418==='PAID'?_0x35d89a(0x1fd):_0x35d89a(0x1c4);let _0x1e6ab9=[];if(_0x26550e[_0x35d89a(0x1f8)])try{_0x1e6ab9=Array[_0x35d89a(0x1ec)](_0x26550e[_0x35d89a(0x1f8)])?_0x26550e['webhookEvents']:JSON[_0x35d89a(0x1e6)](_0x26550e[_0x35d89a(0x1f8)]);}catch(_0x480e13){console[_0x35d89a(0x1a6)](_0x35d89a(0x203),_0x480e13),_0x1e6ab9=[];}if(!_0x1e6ab9['includes'](_0x2d7650)){console['log']('Webhook\x20event\x20'+_0x2d7650+_0x35d89a(0x200)+_0x5b4869['id']);return;}const _0x578b0f={'event':_0x2d7650,'payment':{'id':_0x52afe8['id'],'order_id':_0x52afe8[_0x35d89a(0x1a9)],'gateway_order_id':_0x52afe8['gatewayOrderId'],'gateway':_0x35d89a(0x1e8),'amount':_0x52afe8[_0x35d89a(0x218)],'currency':_0x52afe8[_0x35d89a(0x1b1)],'status':_0x293418[_0x35d89a(0x212)](),'customer_email':_0x52afe8[_0x35d89a(0x1b3)],'customer_name':_0x52afe8['customerName'],'transaction_id':_0x5db704,'failure_message':_0x155313,'created_at':_0x52afe8['createdAt'],'updated_at':new Date()}},_0x1c29b5=await fetch(_0x26550e[_0x35d89a(0x1b0)],{'method':_0x35d89a(0x1ed),'headers':{'Content-Type':_0x35d89a(0x1b9),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x35d89a(0x1fe)](_0x578b0f)}),_0x4f8a93=Date[_0x35d89a(0x1f4)]()-_0x54c712;console['log'](_0x35d89a(0x20d)+_0x26550e[_0x35d89a(0x1b0)]+_0x35d89a(0x1ac)+_0x1c29b5[_0x35d89a(0x1bd)]+'\x20('+_0x4f8a93+_0x35d89a(0x1c7));}catch(_0xecbfff){console[_0x35d89a(0x1a6)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0xecbfff);}}async[a13_0x58ee82(0x1bc)](_0xcf1b4a,_0x2d9c81){const _0x96bc4d=a13_0x58ee82;try{const {telegramBotService:_0x50af3a}=await Promise[_0x96bc4d(0x1a7)]()[_0x96bc4d(0x1bb)](()=>__importStar(require(_0x96bc4d(0x1cf)))),_0x4741af={'PAID':_0x96bc4d(0x1de),'FAILED':'failed'},_0x3bd807=_0x4741af[_0x2d9c81];if(!_0x3bd807)return;await _0x50af3a['sendPaymentNotification'](_0xcf1b4a[_0x96bc4d(0x1f5)],_0xcf1b4a,_0x3bd807);}catch(_0x5eae85){console[_0x96bc4d(0x1a6)](_0x96bc4d(0x20a),_0x5eae85);}}}exports[a13_0x58ee82(0x1a8)]=TestGatewayController;