'use strict';const a13_0x4c7208=a13_0x1792;(function(_0xffbc5a,_0xdd8fea){const _0x5a7e4e=a13_0x1792,_0x4f7086=_0xffbc5a();while(!![]){try{const _0x5d7709=-parseInt(_0x5a7e4e(0xde))/0x1*(-parseInt(_0x5a7e4e(0xe0))/0x2)+parseInt(_0x5a7e4e(0xd6))/0x3*(parseInt(_0x5a7e4e(0x9d))/0x4)+parseInt(_0x5a7e4e(0xce))/0x5+parseInt(_0x5a7e4e(0xe1))/0x6+parseInt(_0x5a7e4e(0xfb))/0x7*(-parseInt(_0x5a7e4e(0xbb))/0x8)+-parseInt(_0x5a7e4e(0xf9))/0x9+-parseInt(_0x5a7e4e(0xc6))/0xa*(parseInt(_0x5a7e4e(0xb3))/0xb);if(_0x5d7709===_0xdd8fea)break;else _0x4f7086['push'](_0x4f7086['shift']());}catch(_0x1aecfe){_0x4f7086['push'](_0x4f7086['shift']());}}}(a13_0x123d,0x1f0ef));function a13_0x1792(_0x5b8fb8,_0x11bc49){const _0x123d59=a13_0x123d();return a13_0x1792=function(_0x17929f,_0x4463a9){_0x17929f=_0x17929f-0x8d;let _0x313ac6=_0x123d59[_0x17929f];return _0x313ac6;},a13_0x1792(_0x5b8fb8,_0x11bc49);}var __createBinding=this&&this[a13_0x4c7208(0xb7)]||(Object[a13_0x4c7208(0xf8)]?function(_0x442dbd,_0x12f8b7,_0x1d788e,_0x3552f9){const _0x52c222=a13_0x4c7208;if(_0x3552f9===undefined)_0x3552f9=_0x1d788e;var _0x273c9a=Object[_0x52c222(0x96)](_0x12f8b7,_0x1d788e);(!_0x273c9a||(_0x52c222(0xef)in _0x273c9a?!_0x12f8b7[_0x52c222(0xb9)]:_0x273c9a[_0x52c222(0xfd)]||_0x273c9a[_0x52c222(0xdc)]))&&(_0x273c9a={'enumerable':!![],'get':function(){return _0x12f8b7[_0x1d788e];}}),Object[_0x52c222(0xab)](_0x442dbd,_0x3552f9,_0x273c9a);}:function(_0x476a1f,_0x1a44e8,_0x46d4d1,_0x533148){if(_0x533148===undefined)_0x533148=_0x46d4d1;_0x476a1f[_0x533148]=_0x1a44e8[_0x46d4d1];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5274c0,_0x5ce3f5){const _0x31b3c3=a13_0x4c7208;Object[_0x31b3c3(0xab)](_0x5274c0,_0x31b3c3(0x8e),{'enumerable':!![],'value':_0x5ce3f5});}:function(_0x173584,_0x518ee4){_0x173584['default']=_0x518ee4;}),__importStar=this&&this['__importStar']||(function(){var _0x10d504=function(_0x4f9bdb){return _0x10d504=Object['getOwnPropertyNames']||function(_0x55c433){const _0x4fbd43=a13_0x1792;var _0x22a3ae=[];for(var _0x41e4ed in _0x55c433)if(Object[_0x4fbd43(0xda)]['hasOwnProperty'][_0x4fbd43(0x97)](_0x55c433,_0x41e4ed))_0x22a3ae[_0x22a3ae[_0x4fbd43(0xc9)]]=_0x41e4ed;return _0x22a3ae;},_0x10d504(_0x4f9bdb);};return function(_0xa7d196){const _0x5195cf=a13_0x1792;if(_0xa7d196&&_0xa7d196[_0x5195cf(0xb9)])return _0xa7d196;var _0x181c23={};if(_0xa7d196!=null){for(var _0x51200a=_0x10d504(_0xa7d196),_0x664430=0x0;_0x664430<_0x51200a[_0x5195cf(0xc9)];_0x664430++)if(_0x51200a[_0x664430]!==_0x5195cf(0x8e))__createBinding(_0x181c23,_0xa7d196,_0x51200a[_0x664430]);}return __setModuleDefault(_0x181c23,_0xa7d196),_0x181c23;};}()),__importDefault=this&&this[a13_0x4c7208(0x9e)]||function(_0x2e7738){const _0x18b806=a13_0x4c7208;return _0x2e7738&&_0x2e7738[_0x18b806(0xb9)]?_0x2e7738:{'default':_0x2e7738};};function a13_0x123d(){const _0x5ebc69=['webhookLog','error','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookUrl','‚ùå\x20Payment\x20link\x20','create','1263735HwCvyk','test_card','915404KhIdgY','successUrl','writable','currentPayments','default','sendShopWebhook','findUnique','paymentLinkId','status','\x20with\x20status\x20','$transaction','getPaymentForm','getOwnPropertyDescriptor','call','Webhook\x20event\x20',',\x20status=','amount','update','transactionId','3680RNZaZA','__importDefault','cardLast4','paymentLink','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','payment.failed','PENDING','type','paid','PAID','gateway','isArray','stringify','parse','defineProperty','failUrl','shop','ms)','failureReason','cardNumber','Payment\x20is\x20not\x20for\x20test\x20gateway','json','231gRpujF','4242\x204242\x204242\x204242','FAILED','body','__createBinding','0000','__esModule','testGatewayService','8dtUdpK','slice','processCardPayment','application/json','\x20not\x20found','TestGatewayController','log','üìà\x20Found\x20payment\x20link\x20','toISOString','createdAt','POST','63710dmCvRR','test_gateway_','sendPaymentStatusNotification','length','TestGatewayService','gatewayOrderId','shopId','WebhookService','595475NzeHIz','customerName','currency','webhookEvents','\x20processed:\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter',':\x20type=','Payment\x20processed\x20successfully','669hodUee','resolve','failureMessage','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','prototype','payment','configurable','Payment\x20not\x20found','22531mQZfEO','Any\x20future\x20date\x20(MM/YY)','14UBfqCV','301326dSWDlh','processCard','üìà\x20Test\x20Gateway:\x20Payment\x20','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20failed','toLowerCase','params','SINGLE','../services/webhookService','Error\x20parsing\x20webhook\x20events:','\x20->\x20',',\x20currentPayments=','sendPaymentNotification','settings','get','Payment\x20status\x20is\x20',',\x20cannot\x20process','paymentMethod'];a13_0x123d=function(){return _0x5ebc69;};return a13_0x123d();}Object['defineProperty'](exports,a13_0x4c7208(0xb9),{'value':!![]}),exports[a13_0x4c7208(0xc0)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x4c7208(0xe9)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x6528a6=a13_0x4c7208;this[_0x6528a6(0x95)]=async(_0x18d589,_0x1f3d49,_0x134901)=>{const _0x35331f=_0x6528a6;try{const {paymentId:_0x3cb76e}=_0x18d589[_0x35331f(0xe7)];console[_0x35331f(0xc1)](_0x35331f(0xd9)+_0x3cb76e);const _0x26682c=await database_1[_0x35331f(0x8e)][_0x35331f(0xdb)][_0x35331f(0x90)]({'where':{'id':_0x3cb76e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x26682c)return _0x1f3d49['status'](0x194)[_0x35331f(0xb2)]({'success':![],'message':_0x35331f(0xdd)});if(_0x26682c[_0x35331f(0xa7)]!=='test_gateway')return _0x1f3d49['status'](0x190)[_0x35331f(0xb2)]({'success':![],'message':_0x35331f(0xb1)});if(_0x26682c[_0x35331f(0x92)]!==_0x35331f(0xa3))return _0x1f3d49[_0x35331f(0x92)](0x190)[_0x35331f(0xb2)]({'success':![],'message':_0x35331f(0xf0)+_0x26682c[_0x35331f(0x92)]+',\x20cannot\x20process'});_0x1f3d49[_0x35331f(0xb2)]({'success':!![],'result':{'paymentId':_0x26682c['id'],'orderId':_0x26682c[_0x35331f(0xcb)],'amount':_0x26682c['amount'],'currency':_0x26682c['currency'],'merchantName':_0x26682c[_0x35331f(0xad)]['name'],'description':'Payment\x20to\x20'+_0x26682c['shop']['name'],'testInstructions':{'successCard':_0x35331f(0xb4),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x35331f(0xdf),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x3ee0b8){_0x134901(_0x3ee0b8);}},this[_0x6528a6(0xe2)]=async(_0x2600c0,_0x3ae529,_0x5cc134)=>{const _0xb385fb=_0x6528a6;try{const {paymentId:_0x280b9b}=_0x2600c0[_0xb385fb(0xe7)],_0x281454=_0x2600c0[_0xb385fb(0xb6)];console['log'](_0xb385fb(0xa1)+_0x280b9b);const _0x25a6b7=await database_1['default'][_0xb385fb(0xdb)]['findUnique']({'where':{'id':_0x280b9b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25a6b7)return _0x3ae529[_0xb385fb(0x92)](0x194)[_0xb385fb(0xb2)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x25a6b7[_0xb385fb(0xa7)]!=='test_gateway')return _0x3ae529[_0xb385fb(0x92)](0x190)[_0xb385fb(0xb2)]({'success':![],'message':_0xb385fb(0xb1)});if(_0x25a6b7[_0xb385fb(0x92)]!==_0xb385fb(0xa3))return _0x3ae529[_0xb385fb(0x92)](0x190)[_0xb385fb(0xb2)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x25a6b7[_0xb385fb(0x92)]+_0xb385fb(0xf1)});const _0x4495c7=await this['testGatewayService'][_0xb385fb(0xbd)]({'paymentId':_0x25a6b7['id'],'orderId':_0x25a6b7['gatewayOrderId']||_0x25a6b7['id'],'amount':_0x25a6b7[_0xb385fb(0x9a)],'currency':_0x25a6b7[_0xb385fb(0xd0)],'cardData':_0x281454});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x4495c7);const _0x4a39c2={'status':_0x4495c7[_0xb385fb(0x92)],'updatedAt':new Date()};if(_0x4495c7['status']===_0xb385fb(0xa6))_0x4a39c2['paidAt']=new Date(),_0x4a39c2['gatewayPaymentId']=_0x4495c7[_0xb385fb(0x9c)];else _0x4495c7[_0xb385fb(0x92)]==='FAILED'&&(_0x4a39c2[_0xb385fb(0xd8)]=_0x4495c7[_0xb385fb(0xaf)]);const _0x1d2e9a=_0x281454[_0xb385fb(0xb0)]['replace'](/[\s-]/g,'');_0x4a39c2[_0xb385fb(0x9f)]=_0x1d2e9a[_0xb385fb(0xbc)](-0x4),_0x4a39c2[_0xb385fb(0xf2)]=_0xb385fb(0xfa),await database_1[_0xb385fb(0x8e)]['payment']['update']({'where':{'id':_0x25a6b7['id']},'data':_0x4a39c2});if(_0x4495c7[_0xb385fb(0x92)]===_0xb385fb(0xa6)&&_0x25a6b7[_0xb385fb(0x91)]){console[_0xb385fb(0xc1)](_0xb385fb(0xe3)+_0x25a6b7['id']+_0xb385fb(0xd3));try{await database_1[_0xb385fb(0x8e)][_0xb385fb(0x94)](async _0x521b23=>{const _0xa6a4ee=_0xb385fb,_0x2f5894=await _0x521b23[_0xa6a4ee(0xa0)][_0xa6a4ee(0x90)]({'where':{'id':_0x25a6b7[_0xa6a4ee(0x91)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2f5894){console['log'](_0xa6a4ee(0xc2)+_0x2f5894['id']+_0xa6a4ee(0xd4)+_0x2f5894[_0xa6a4ee(0xa4)]+_0xa6a4ee(0xec)+_0x2f5894[_0xa6a4ee(0x8d)]+_0xa6a4ee(0x99)+_0x2f5894[_0xa6a4ee(0x92)]);const _0x5f456e=_0x2f5894['currentPayments']+0x1,_0x1c8f73=_0x2f5894[_0xa6a4ee(0xa4)]===_0xa6a4ee(0xe8)?'COMPLETED':_0x2f5894['status'];await _0x521b23['paymentLink'][_0xa6a4ee(0x9b)]({'where':{'id':_0x25a6b7[_0xa6a4ee(0x91)]},'data':{'currentPayments':_0x5f456e,'status':_0x1c8f73,'updatedAt':new Date()}}),console[_0xa6a4ee(0xc1)]('‚úÖ\x20Payment\x20link\x20'+_0x2f5894['id']+'\x20updated:\x20currentPayments='+_0x2f5894[_0xa6a4ee(0x8d)]+'\x20->\x20'+_0x5f456e+',\x20status='+_0x2f5894[_0xa6a4ee(0x92)]+_0xa6a4ee(0xeb)+_0x1c8f73);}else console[_0xa6a4ee(0xc1)](_0xa6a4ee(0xf7)+_0x25a6b7[_0xa6a4ee(0x91)]+_0xa6a4ee(0xbf));});}catch(_0x391485){console[_0xb385fb(0xf4)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x391485);}}await database_1[_0xb385fb(0x8e)][_0xb385fb(0xf3)][_0xb385fb(0xf8)]({'data':{'paymentId':_0x25a6b7['id'],'shopId':_0x25a6b7['shopId'],'event':_0xb385fb(0xc7)+_0x4495c7['status'][_0xb385fb(0xe6)](),'statusCode':0xc8,'responseBody':JSON[_0xb385fb(0xa9)]({'oldStatus':_0xb385fb(0xa3),'newStatus':_0x4495c7['status'],'transactionId':_0x4495c7[_0xb385fb(0x9c)],'failureReason':_0x4495c7[_0xb385fb(0xaf)],'processedAt':new Date()[_0xb385fb(0xc3)]()})}}),await this[_0xb385fb(0x8f)](_0x25a6b7,_0x4495c7['status'],_0x4495c7[_0xb385fb(0x9c)],_0x4495c7[_0xb385fb(0xaf)]),await this[_0xb385fb(0xc8)](_0x25a6b7,_0x4495c7[_0xb385fb(0x92)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x280b9b+_0xb385fb(0xd2)+_0x4495c7[_0xb385fb(0x92)]),_0x4495c7[_0xb385fb(0x92)]==='PAID'?_0x3ae529[_0xb385fb(0xb2)]({'success':!![],'message':_0xb385fb(0xd5),'result':{'status':_0xb385fb(0xa6),'transactionId':_0x4495c7[_0xb385fb(0x9c)],'redirectUrl':_0x25a6b7[_0xb385fb(0xfc)]}}):_0x3ae529['status'](0x190)['json']({'success':![],'message':_0xb385fb(0xe5),'result':{'status':_0xb385fb(0xb5),'failureReason':_0x4495c7[_0xb385fb(0xaf)],'redirectUrl':_0x25a6b7[_0xb385fb(0xac)]}});}catch(_0x46faae){_0x5cc134(_0x46faae);}},this[_0x6528a6(0xba)]=new testGatewayService_1[(_0x6528a6(0xca))](),this['webhookService']=new webhookService_1[(_0x6528a6(0xcd))]();}async[a13_0x4c7208(0x8f)](_0x3f9336,_0x2cbaa5,_0x3145c6,_0x1d11e7){const _0x1110df=a13_0x4c7208,_0x327ef8=Date['now']();try{const _0x4e585a=_0x3f9336['shop'],_0x264da3=_0x4e585a[_0x1110df(0xee)];if(!_0x264da3?.[_0x1110df(0xf6)]){console[_0x1110df(0xc1)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4e585a['id']);return;}const _0x918da8=_0x2cbaa5===_0x1110df(0xa6)?'payment.success':_0x1110df(0xa2);let _0x548d09=[];if(_0x264da3['webhookEvents'])try{_0x548d09=Array[_0x1110df(0xa8)](_0x264da3[_0x1110df(0xd1)])?_0x264da3[_0x1110df(0xd1)]:JSON[_0x1110df(0xaa)](_0x264da3[_0x1110df(0xd1)]);}catch(_0x560610){console[_0x1110df(0xf4)](_0x1110df(0xea),_0x560610),_0x548d09=[];}if(!_0x548d09['includes'](_0x918da8)){console[_0x1110df(0xc1)](_0x1110df(0x98)+_0x918da8+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4e585a['id']);return;}const _0x1fde0e={'event':_0x918da8,'payment':{'id':_0x3f9336['id'],'order_id':_0x3f9336['orderId'],'gateway_order_id':_0x3f9336[_0x1110df(0xcb)],'gateway':_0x1110df(0xb8),'amount':_0x3f9336[_0x1110df(0x9a)],'currency':_0x3f9336['currency'],'status':_0x2cbaa5[_0x1110df(0xe6)](),'customer_email':_0x3f9336['customerEmail'],'customer_name':_0x3f9336[_0x1110df(0xcf)],'transaction_id':_0x3145c6,'failure_message':_0x1d11e7,'created_at':_0x3f9336[_0x1110df(0xc4)],'updated_at':new Date()}},_0x1d8dec=await fetch(_0x264da3[_0x1110df(0xf6)],{'method':_0x1110df(0xc5),'headers':{'Content-Type':_0x1110df(0xbe),'User-Agent':_0x1110df(0xe4)},'body':JSON['stringify'](_0x1fde0e)}),_0x4021cb=Date['now']()-_0x327ef8;console[_0x1110df(0xc1)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x264da3[_0x1110df(0xf6)]+_0x1110df(0x93)+_0x1d8dec['status']+'\x20('+_0x4021cb+_0x1110df(0xae));}catch(_0x2df24c){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x2df24c);}}async[a13_0x4c7208(0xc8)](_0x182f39,_0x64eaa){const _0x3e9472=a13_0x4c7208;try{const {telegramBotService:_0xd695}=await Promise[_0x3e9472(0xd7)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x12413d={'PAID':_0x3e9472(0xa5),'FAILED':'failed'},_0x1289e8=_0x12413d[_0x64eaa];if(!_0x1289e8)return;await _0xd695[_0x3e9472(0xed)](_0x182f39[_0x3e9472(0xcc)],_0x182f39,_0x1289e8);}catch(_0x489c5e){console[_0x3e9472(0xf4)](_0x3e9472(0xf5),_0x489c5e);}}}exports[a13_0x4c7208(0xc0)]=TestGatewayController;