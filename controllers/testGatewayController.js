'use strict';function a13_0x173f(){const _0x40334d=['writable','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','$transaction','currency','customerEmail','776yUmFXH','74809lDtHfs','gatewayPaymentId','successUrl','stringify','Payment\x20to\x20','6345336qHHRgi','slice','2EYiXGi','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__esModule','sendPaymentStatusNotification','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','payment.success',':\x20type=','resolve','Payment\x20not\x20found','test_gateway','30DmhDHf','replace','length','Payment\x20status\x20is\x20','__importStar',',\x20currentPayments=','PENDING','paid','Any\x20other\x20card\x20number','gateway','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment','FAILED','get','paymentLinkId','üß™\x20Test\x20Gateway\x20result:','default','failed','Webhook\x20event\x20','Any\x20name','‚úÖ\x20Payment\x20link\x20','transactionId','\x20->\x20','test_gateway_','error','16120xAXhdF','body','getPaymentForm','update','PAID','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','webhookEvents','704eAaTcO','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','0000','failureMessage','name','getOwnPropertyDescriptor','POST','includes','configurable','474vJPFOM','webhookLog','13QPAJPT','json','Payment\x20processed\x20successfully','SINGLE','COMPLETED','settings','Error\x20parsing\x20webhook\x20events:','call','toISOString','type','failureReason','\x20updated:\x20currentPayments=','Any\x203-4\x20digits','findUnique','toLowerCase','processCard',',\x20status=','customerName','4329090EIhdyv','../services/webhookService','currentPayments','paymentLink','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','shop','log','TestGatewayController','create','webhookUrl','../config/database','status','application/json','isArray','then','13784IkqPSe','\x20processed:\x20','üìà\x20Test\x20Gateway:\x20Payment\x20','amount','parse','paidAt','orderId','sendShopWebhook','payment.failed','hasOwnProperty','paymentMethod','getOwnPropertyNames','cardLast4','../services/gateways/testGatewayService','../services/telegramBotService','79011vZyUVv','defineProperty','test_card','processCardPayment','301508AbsXKy','shopId','gatewayOrderId','WebhookService','webhookService','ms)'];a13_0x173f=function(){return _0x40334d;};return a13_0x173f();}const a13_0x2071bc=a13_0xa9da;(function(_0x33c8ff,_0x21344c){const _0x394a52=a13_0xa9da,_0x1d85ae=_0x33c8ff();while(!![]){try{const _0xa9e5fd=-parseInt(_0x394a52(0x146))/0x1*(-parseInt(_0x394a52(0x159))/0x2)+parseInt(_0x394a52(0x164))/0x3*(parseInt(_0x394a52(0x1b0))/0x4)+parseInt(_0x394a52(0x1a1))/0x5+parseInt(_0x394a52(0x18d))/0x6*(-parseInt(_0x394a52(0x152))/0x7)+-parseInt(_0x394a52(0x151))/0x8*(-parseInt(_0x394a52(0x142))/0x9)+-parseInt(_0x394a52(0x17d))/0xa*(parseInt(_0x394a52(0x184))/0xb)+parseInt(_0x394a52(0x157))/0xc*(-parseInt(_0x394a52(0x18f))/0xd);if(_0xa9e5fd===_0x21344c)break;else _0x1d85ae['push'](_0x1d85ae['shift']());}catch(_0x36dff7){_0x1d85ae['push'](_0x1d85ae['shift']());}}}(a13_0x173f,0x8ce6a));var __createBinding=this&&this['__createBinding']||(Object[a13_0x2071bc(0x1a9)]?function(_0x441a07,_0x3e64a1,_0x9179b4,_0x24153e){const _0x13d09f=a13_0x2071bc;if(_0x24153e===undefined)_0x24153e=_0x9179b4;var _0x1f33f5=Object[_0x13d09f(0x189)](_0x3e64a1,_0x9179b4);(!_0x1f33f5||(_0x13d09f(0x171)in _0x1f33f5?!_0x3e64a1[_0x13d09f(0x15b)]:_0x1f33f5[_0x13d09f(0x14c)]||_0x1f33f5[_0x13d09f(0x18c)]))&&(_0x1f33f5={'enumerable':!![],'get':function(){return _0x3e64a1[_0x9179b4];}}),Object[_0x13d09f(0x143)](_0x441a07,_0x24153e,_0x1f33f5);}:function(_0x1fbed3,_0x188804,_0x1533c8,_0x1e1401){if(_0x1e1401===undefined)_0x1e1401=_0x1533c8;_0x1fbed3[_0x1e1401]=_0x188804[_0x1533c8];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x2071bc(0x1a9)]?function(_0x56d280,_0x1565e0){const _0x3bf8e1=a13_0x2071bc;Object[_0x3bf8e1(0x143)](_0x56d280,'default',{'enumerable':!![],'value':_0x1565e0});}:function(_0x28226c,_0x54abce){_0x28226c['default']=_0x54abce;}),__importStar=this&&this[a13_0x2071bc(0x168)]||(function(){var _0x2cfd77=function(_0x1a3b51){const _0x5b344a=a13_0xa9da;return _0x2cfd77=Object[_0x5b344a(0x13e)]||function(_0x1220c1){const _0x5c5f9e=_0x5b344a;var _0xb7e4e8=[];for(var _0x44f739 in _0x1220c1)if(Object['prototype'][_0x5c5f9e(0x1b9)][_0x5c5f9e(0x196)](_0x1220c1,_0x44f739))_0xb7e4e8[_0xb7e4e8[_0x5c5f9e(0x166)]]=_0x44f739;return _0xb7e4e8;},_0x2cfd77(_0x1a3b51);};return function(_0xc405b){const _0x4edee9=a13_0xa9da;if(_0xc405b&&_0xc405b['__esModule'])return _0xc405b;var _0x45d4cf={};if(_0xc405b!=null){for(var _0x185a54=_0x2cfd77(_0xc405b),_0x4beff9=0x0;_0x4beff9<_0x185a54[_0x4edee9(0x166)];_0x4beff9++)if(_0x185a54[_0x4beff9]!=='default')__createBinding(_0x45d4cf,_0xc405b,_0x185a54[_0x4beff9]);}return __setModuleDefault(_0x45d4cf,_0xc405b),_0x45d4cf;};}()),__importDefault=this&&this['__importDefault']||function(_0x2ed2a1){const _0x1856f5=a13_0x2071bc;return _0x2ed2a1&&_0x2ed2a1[_0x1856f5(0x15b)]?_0x2ed2a1:{'default':_0x2ed2a1};};Object[a13_0x2071bc(0x143)](exports,a13_0x2071bc(0x15b),{'value':!![]}),exports[a13_0x2071bc(0x1a8)]=void 0x0;function a13_0xa9da(_0x48ed35,_0x143782){const _0x173f7b=a13_0x173f();return a13_0xa9da=function(_0xa9dace,_0x3457eb){_0xa9dace=_0xa9dace-0x13e;let _0xd8e671=_0x173f7b[_0xa9dace];return _0xd8e671;},a13_0xa9da(_0x48ed35,_0x143782);}const testGatewayService_1=require(a13_0x2071bc(0x140)),webhookService_1=require(a13_0x2071bc(0x1a2)),database_1=__importDefault(require(a13_0x2071bc(0x1ab)));class TestGatewayController{constructor(){const _0x3aa506=a13_0x2071bc;this[_0x3aa506(0x17f)]=async(_0x37f460,_0xb89da9,_0x14a155)=>{const _0x292a98=_0x3aa506;try{const {paymentId:_0x19e44a}=_0x37f460['params'];console[_0x292a98(0x1a7)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x19e44a);const _0x5550a0=await database_1[_0x292a98(0x174)][_0x292a98(0x16f)]['findUnique']({'where':{'id':_0x19e44a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5550a0)return _0xb89da9[_0x292a98(0x1ac)](0x194)['json']({'success':![],'message':_0x292a98(0x162)});if(_0x5550a0[_0x292a98(0x16d)]!==_0x292a98(0x163))return _0xb89da9[_0x292a98(0x1ac)](0x190)['json']({'success':![],'message':_0x292a98(0x15e)});if(_0x5550a0['status']!==_0x292a98(0x16a))return _0xb89da9[_0x292a98(0x1ac)](0x190)[_0x292a98(0x190)]({'success':![],'message':_0x292a98(0x167)+_0x5550a0[_0x292a98(0x1ac)]+',\x20cannot\x20process'});_0xb89da9[_0x292a98(0x190)]({'success':!![],'result':{'paymentId':_0x5550a0['id'],'orderId':_0x5550a0['gatewayOrderId'],'amount':_0x5550a0['amount'],'currency':_0x5550a0[_0x292a98(0x14f)],'merchantName':_0x5550a0[_0x292a98(0x1a6)][_0x292a98(0x188)],'description':_0x292a98(0x156)+_0x5550a0[_0x292a98(0x1a6)][_0x292a98(0x188)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x292a98(0x16c),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x292a98(0x19b),'holderName':_0x292a98(0x177)}}});}catch(_0x34f2af){_0x14a155(_0x34f2af);}},this[_0x3aa506(0x19e)]=async(_0x5823e6,_0x5d3db5,_0x470061)=>{const _0x59ce90=_0x3aa506;try{const {paymentId:_0x47cae0}=_0x5823e6['params'],_0xbd08cc=_0x5823e6[_0x59ce90(0x17e)];console[_0x59ce90(0x1a7)](_0x59ce90(0x15d)+_0x47cae0);const _0x2a6b9b=await database_1['default']['payment']['findUnique']({'where':{'id':_0x47cae0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a6b9b)return _0x5d3db5[_0x59ce90(0x1ac)](0x194)[_0x59ce90(0x190)]({'success':![],'message':_0x59ce90(0x162)});if(_0x2a6b9b[_0x59ce90(0x16d)]!==_0x59ce90(0x163))return _0x5d3db5[_0x59ce90(0x1ac)](0x190)[_0x59ce90(0x190)]({'success':![],'message':_0x59ce90(0x15e)});if(_0x2a6b9b[_0x59ce90(0x1ac)]!==_0x59ce90(0x16a))return _0x5d3db5[_0x59ce90(0x1ac)](0x190)[_0x59ce90(0x190)]({'success':![],'message':_0x59ce90(0x167)+_0x2a6b9b[_0x59ce90(0x1ac)]+',\x20cannot\x20process'});const _0x285dd2=await this['testGatewayService'][_0x59ce90(0x145)]({'paymentId':_0x2a6b9b['id'],'orderId':_0x2a6b9b[_0x59ce90(0x148)]||_0x2a6b9b['id'],'amount':_0x2a6b9b[_0x59ce90(0x1b3)],'currency':_0x2a6b9b['currency'],'cardData':_0xbd08cc});console['log'](_0x59ce90(0x173),_0x285dd2);const _0x598f60={'status':_0x285dd2[_0x59ce90(0x1ac)],'updatedAt':new Date()};if(_0x285dd2['status']===_0x59ce90(0x181))_0x598f60[_0x59ce90(0x1b5)]=new Date(),_0x598f60[_0x59ce90(0x153)]=_0x285dd2['transactionId'];else _0x285dd2[_0x59ce90(0x1ac)]==='FAILED'&&(_0x598f60[_0x59ce90(0x187)]=_0x285dd2[_0x59ce90(0x199)]);const _0xf8844a=_0xbd08cc['cardNumber'][_0x59ce90(0x165)](/[\s-]/g,'');_0x598f60[_0x59ce90(0x13f)]=_0xf8844a[_0x59ce90(0x158)](-0x4),_0x598f60[_0x59ce90(0x1ba)]=_0x59ce90(0x144),await database_1['default'][_0x59ce90(0x16f)]['update']({'where':{'id':_0x2a6b9b['id']},'data':_0x598f60});if(_0x285dd2[_0x59ce90(0x1ac)]==='PAID'&&_0x2a6b9b['paymentLinkId']){console['log'](_0x59ce90(0x1b2)+_0x2a6b9b['id']+_0x59ce90(0x185));try{await database_1[_0x59ce90(0x174)][_0x59ce90(0x14e)](async _0x440b43=>{const _0x20a53d=_0x59ce90,_0x5f280b=await _0x440b43[_0x20a53d(0x1a4)][_0x20a53d(0x19c)]({'where':{'id':_0x2a6b9b[_0x20a53d(0x172)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5f280b){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x5f280b['id']+_0x20a53d(0x160)+_0x5f280b[_0x20a53d(0x198)]+_0x20a53d(0x169)+_0x5f280b[_0x20a53d(0x1a3)]+',\x20status='+_0x5f280b[_0x20a53d(0x1ac)]);const _0x374184=_0x5f280b[_0x20a53d(0x1a3)]+0x1,_0x4e801a=_0x5f280b[_0x20a53d(0x198)]===_0x20a53d(0x192)?_0x20a53d(0x193):_0x5f280b[_0x20a53d(0x1ac)];await _0x440b43['paymentLink'][_0x20a53d(0x180)]({'where':{'id':_0x2a6b9b[_0x20a53d(0x172)]},'data':{'currentPayments':_0x374184,'status':_0x4e801a,'updatedAt':new Date()}}),console[_0x20a53d(0x1a7)](_0x20a53d(0x178)+_0x5f280b['id']+_0x20a53d(0x19a)+_0x5f280b[_0x20a53d(0x1a3)]+_0x20a53d(0x17a)+_0x374184+_0x20a53d(0x19f)+_0x5f280b[_0x20a53d(0x1ac)]+_0x20a53d(0x17a)+_0x4e801a);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x2a6b9b[_0x20a53d(0x172)]+'\x20not\x20found');});}catch(_0x429911){console[_0x59ce90(0x17c)](_0x59ce90(0x182),_0x429911);}}await database_1[_0x59ce90(0x174)][_0x59ce90(0x18e)][_0x59ce90(0x1a9)]({'data':{'paymentId':_0x2a6b9b['id'],'shopId':_0x2a6b9b['shopId'],'event':_0x59ce90(0x17b)+_0x285dd2[_0x59ce90(0x1ac)][_0x59ce90(0x19d)](),'statusCode':0xc8,'responseBody':JSON[_0x59ce90(0x155)]({'oldStatus':_0x59ce90(0x16a),'newStatus':_0x285dd2[_0x59ce90(0x1ac)],'transactionId':_0x285dd2[_0x59ce90(0x179)],'failureReason':_0x285dd2[_0x59ce90(0x199)],'processedAt':new Date()[_0x59ce90(0x197)]()})}}),await this[_0x59ce90(0x1b7)](_0x2a6b9b,_0x285dd2[_0x59ce90(0x1ac)],_0x285dd2[_0x59ce90(0x179)],_0x285dd2[_0x59ce90(0x199)]),await this['sendPaymentStatusNotification'](_0x2a6b9b,_0x285dd2[_0x59ce90(0x1ac)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x47cae0+_0x59ce90(0x1b1)+_0x285dd2[_0x59ce90(0x1ac)]),_0x285dd2[_0x59ce90(0x1ac)]===_0x59ce90(0x181)?_0x5d3db5[_0x59ce90(0x190)]({'success':!![],'message':_0x59ce90(0x191),'result':{'status':_0x59ce90(0x181),'transactionId':_0x285dd2[_0x59ce90(0x179)],'redirectUrl':_0x2a6b9b[_0x59ce90(0x154)]}}):_0x5d3db5[_0x59ce90(0x1ac)](0x190)[_0x59ce90(0x190)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x59ce90(0x170),'failureReason':_0x285dd2[_0x59ce90(0x199)],'redirectUrl':_0x2a6b9b['failUrl']}});}catch(_0x1f9d89){_0x470061(_0x1f9d89);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x3aa506(0x14a)]=new webhookService_1[(_0x3aa506(0x149))]();}async['sendShopWebhook'](_0x2cc86b,_0x36d549,_0x10033f,_0x3b8e68){const _0x54a330=a13_0x2071bc,_0x17013d=Date['now']();try{const _0x1c917d=_0x2cc86b['shop'],_0x2d47f9=_0x1c917d[_0x54a330(0x194)];if(!_0x2d47f9?.[_0x54a330(0x1aa)]){console['log'](_0x54a330(0x1a5)+_0x1c917d['id']);return;}const _0x127d43=_0x36d549===_0x54a330(0x181)?_0x54a330(0x15f):_0x54a330(0x1b8);let _0x1c46eb=[];if(_0x2d47f9[_0x54a330(0x183)])try{_0x1c46eb=Array[_0x54a330(0x1ae)](_0x2d47f9[_0x54a330(0x183)])?_0x2d47f9['webhookEvents']:JSON[_0x54a330(0x1b4)](_0x2d47f9[_0x54a330(0x183)]);}catch(_0x3f0a93){console['error'](_0x54a330(0x195),_0x3f0a93),_0x1c46eb=[];}if(!_0x1c46eb[_0x54a330(0x18b)](_0x127d43)){console[_0x54a330(0x1a7)](_0x54a330(0x176)+_0x127d43+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1c917d['id']);return;}const _0x404a14={'event':_0x127d43,'payment':{'id':_0x2cc86b['id'],'order_id':_0x2cc86b[_0x54a330(0x1b6)],'gateway_order_id':_0x2cc86b['gatewayOrderId'],'gateway':_0x54a330(0x186),'amount':_0x2cc86b[_0x54a330(0x1b3)],'currency':_0x2cc86b[_0x54a330(0x14f)],'status':_0x36d549[_0x54a330(0x19d)](),'customer_email':_0x2cc86b[_0x54a330(0x150)],'customer_name':_0x2cc86b[_0x54a330(0x1a0)],'transaction_id':_0x10033f,'failure_message':_0x3b8e68,'created_at':_0x2cc86b['createdAt'],'updated_at':new Date()}},_0x3dc609=await fetch(_0x2d47f9[_0x54a330(0x1aa)],{'method':_0x54a330(0x18a),'headers':{'Content-Type':_0x54a330(0x1ad),'User-Agent':_0x54a330(0x14d)},'body':JSON['stringify'](_0x404a14)}),_0x3a8c94=Date['now']()-_0x17013d;console['log'](_0x54a330(0x15a)+_0x2d47f9[_0x54a330(0x1aa)]+'\x20with\x20status\x20'+_0x3dc609['status']+'\x20('+_0x3a8c94+_0x54a330(0x14b));}catch(_0x513298){console[_0x54a330(0x17c)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x513298);}}async[a13_0x2071bc(0x15c)](_0x1e291a,_0x5ae31f){const _0x4fe514=a13_0x2071bc;try{const {telegramBotService:_0x26cc9a}=await Promise[_0x4fe514(0x161)]()[_0x4fe514(0x1af)](()=>__importStar(require(_0x4fe514(0x141)))),_0x3b4757={'PAID':_0x4fe514(0x16b),'FAILED':_0x4fe514(0x175)},_0x4c8abf=_0x3b4757[_0x5ae31f];if(!_0x4c8abf)return;await _0x26cc9a['sendPaymentNotification'](_0x1e291a[_0x4fe514(0x147)],_0x1e291a,_0x4c8abf);}catch(_0x1a80de){console['error'](_0x4fe514(0x16e),_0x1a80de);}}}exports['TestGatewayController']=TestGatewayController;