'use strict';const a21_0x92a2f3=a21_0x2c40;(function(_0x9adff,_0x218cb2){const _0x1c9db9=a21_0x2c40,_0x271e0d=_0x9adff();while(!![]){try{const _0x2833f8=parseInt(_0x1c9db9(0x1a3))/0x1*(-parseInt(_0x1c9db9(0x14d))/0x2)+parseInt(_0x1c9db9(0x171))/0x3+parseInt(_0x1c9db9(0x14e))/0x4*(-parseInt(_0x1c9db9(0x1c1))/0x5)+-parseInt(_0x1c9db9(0x149))/0x6*(-parseInt(_0x1c9db9(0x14b))/0x7)+parseInt(_0x1c9db9(0x15a))/0x8*(-parseInt(_0x1c9db9(0x1a0))/0x9)+parseInt(_0x1c9db9(0x156))/0xa+parseInt(_0x1c9db9(0x13e))/0xb;if(_0x2833f8===_0x218cb2)break;else _0x271e0d['push'](_0x271e0d['shift']());}catch(_0x5171fc){_0x271e0d['push'](_0x271e0d['shift']());}}}(a21_0x42f2,0x8220a));var __createBinding=this&&this[a21_0x92a2f3(0x161)]||(Object['create']?function(_0x2d7ae4,_0x209b57,_0x5b5400,_0x15b264){const _0x2e6fe3=a21_0x92a2f3;if(_0x15b264===undefined)_0x15b264=_0x5b5400;var _0xa66ab9=Object['getOwnPropertyDescriptor'](_0x209b57,_0x5b5400);(!_0xa66ab9||(_0x2e6fe3(0x151)in _0xa66ab9?!_0x209b57[_0x2e6fe3(0x140)]:_0xa66ab9[_0x2e6fe3(0x13c)]||_0xa66ab9[_0x2e6fe3(0x1ac)]))&&(_0xa66ab9={'enumerable':!![],'get':function(){return _0x209b57[_0x5b5400];}}),Object['defineProperty'](_0x2d7ae4,_0x15b264,_0xa66ab9);}:function(_0x40dd04,_0x2d6c75,_0x23ed8a,_0x4b13e5){if(_0x4b13e5===undefined)_0x4b13e5=_0x23ed8a;_0x40dd04[_0x4b13e5]=_0x2d6c75[_0x23ed8a];}),__setModuleDefault=this&&this[a21_0x92a2f3(0x1a6)]||(Object[a21_0x92a2f3(0x168)]?function(_0x37c730,_0x3e7d8b){const _0x2774ec=a21_0x92a2f3;Object[_0x2774ec(0x1c3)](_0x37c730,'default',{'enumerable':!![],'value':_0x3e7d8b});}:function(_0x4d141e,_0x57be04){const _0x5b6a14=a21_0x92a2f3;_0x4d141e[_0x5b6a14(0x1a2)]=_0x57be04;}),__importStar=this&&this[a21_0x92a2f3(0x15c)]||(function(){var _0x12d9e1=function(_0x51b24d){const _0x410122=a21_0x2c40;return _0x12d9e1=Object[_0x410122(0x170)]||function(_0x416539){const _0x56d21d=_0x410122;var _0x13f433=[];for(var _0x5b8c35 in _0x416539)if(Object[_0x56d21d(0x179)][_0x56d21d(0x153)][_0x56d21d(0x1b0)](_0x416539,_0x5b8c35))_0x13f433[_0x13f433['length']]=_0x5b8c35;return _0x13f433;},_0x12d9e1(_0x51b24d);};return function(_0x58a4a2){const _0x344a65=a21_0x2c40;if(_0x58a4a2&&_0x58a4a2[_0x344a65(0x140)])return _0x58a4a2;var _0x41d7bc={};if(_0x58a4a2!=null){for(var _0x1b5dd7=_0x12d9e1(_0x58a4a2),_0x335a0a=0x0;_0x335a0a<_0x1b5dd7['length'];_0x335a0a++)if(_0x1b5dd7[_0x335a0a]!==_0x344a65(0x1a2))__createBinding(_0x41d7bc,_0x58a4a2,_0x1b5dd7[_0x335a0a]);}return __setModuleDefault(_0x41d7bc,_0x58a4a2),_0x41d7bc;};}()),__importDefault=this&&this['__importDefault']||function(_0x4ee17d){const _0x5ad213=a21_0x92a2f3;return _0x4ee17d&&_0x4ee17d[_0x5ad213(0x140)]?_0x4ee17d:{'default':_0x4ee17d};};function a21_0x42f2(){const _0x5ea6aa=['shopId','gatewayPaymentId',',\x20status=','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','toLowerCase','parse','âŒ\x20Payment\x20link\x20','failUrl','getPaymentForm','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','COMPLETED','../services/telegramBotService',':\x20type=','failureReason','SINGLE','payment.success','PAID','testGatewayService','currency','\x20not\x20enabled\x20for\x20shop\x20','sendPaymentNotification','TestGatewayService','POST','crypto','processCardPayment','failed','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','name','1204767deKfeO','ðŸ§ª\x20Sending\x20webhook\x20to\x20','default','1zIRQev','Any\x20name','\x20not\x20found','__setModuleDefault','../services/webhookService','failureMessage','status','test_gateway_','../services/gateways/testGatewayService','configurable','settings','FAILED','webhookEvents','call',',\x20webhookUrl=','shop','gatewayOrderId','paymentLink','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','update',',\x20cannot\x20process','toISOString','stringify','processCard','Any\x203-4\x20digits','hex','payment','json','transactionId','sendShopWebhook','3360095HMRwyt','ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event=','defineProperty','../config/database','error','paymentLinkId','Payment\x20processed\x20successfully','createHmac','writable','Payment\x20is\x20not\x20for\x20test\x20gateway','16056271DqOtlv','findUnique','__esModule','webhookService','params','amount','...','âš ï¸\x20Webhook\x20event\x20','replace','digest','application/json','156246ipmKuQ','sha256','42PnEyhV','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','421262HBDltd','4oqvoys','slice','includes','get','WebhookService','hasOwnProperty','then','ðŸ“ˆ\x20Found\x20payment\x20link\x20','1166830JgakVp','\x20updated:\x20currentPayments=','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paidAt','32zLEvLh','0000','__importStar','isArray','gateway','paid','âœ…\x20Payment\x20link\x20','__createBinding','orderId','Error\x20parsing\x20webhook\x20events:','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','log','body','Any\x20other\x20card\x20number','create','\x20processed:\x20','Payment\x20not\x20found','Payment\x20to\x20','Any\x20future\x20date\x20(MM/YY)','test_gateway','now','ðŸ§ª\x20Webhook\x20payload:','getOwnPropertyNames','655542fiGNxb','paymentMethod','Payment\x20status\x20is\x20','type','test_card','payment.failed','currentPayments',',\x20currentPayments=','prototype','ðŸ§ª\x20Test\x20Gateway\x20result:','not\x20configured','customerName','ms)','\x20->\x20','PENDING','TestGatewayController','Payment\x20failed'];a21_0x42f2=function(){return _0x5ea6aa;};return a21_0x42f2();}Object[a21_0x92a2f3(0x1c3)](exports,a21_0x92a2f3(0x140),{'value':!![]}),exports[a21_0x92a2f3(0x180)]=void 0x0;const crypto_1=__importDefault(require(a21_0x92a2f3(0x199))),testGatewayService_1=require(a21_0x92a2f3(0x1ab)),webhookService_1=require(a21_0x92a2f3(0x1a7)),database_1=__importDefault(require(a21_0x92a2f3(0x1c4)));function a21_0x2c40(_0x15ebc3,_0x5781a7){_0x15ebc3=_0x15ebc3-0x139;const _0x42f2ec=a21_0x42f2();let _0x2c40d9=_0x42f2ec[_0x15ebc3];return _0x2c40d9;}class TestGatewayController{constructor(){const _0x514e4e=a21_0x92a2f3;this[_0x514e4e(0x18a)]=async(_0x2081a4,_0x1ed45f,_0x76816d)=>{const _0x4c5d21=_0x514e4e;try{const {paymentId:_0x5e7a14}=_0x2081a4[_0x4c5d21(0x142)];console[_0x4c5d21(0x165)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5e7a14);const _0x9a0059=await database_1['default'][_0x4c5d21(0x1bd)][_0x4c5d21(0x13f)]({'where':{'id':_0x5e7a14},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x9a0059)return _0x1ed45f[_0x4c5d21(0x1a9)](0x194)[_0x4c5d21(0x1be)]({'success':![],'message':_0x4c5d21(0x16a)});if(_0x9a0059[_0x4c5d21(0x15e)]!==_0x4c5d21(0x16d))return _0x1ed45f[_0x4c5d21(0x1a9)](0x190)['json']({'success':![],'message':_0x4c5d21(0x13d)});if(_0x9a0059['status']!==_0x4c5d21(0x17f))return _0x1ed45f['status'](0x190)[_0x4c5d21(0x1be)]({'success':![],'message':_0x4c5d21(0x173)+_0x9a0059[_0x4c5d21(0x1a9)]+',\x20cannot\x20process'});_0x1ed45f[_0x4c5d21(0x1be)]({'success':!![],'result':{'paymentId':_0x9a0059['id'],'orderId':_0x9a0059['gatewayOrderId'],'amount':_0x9a0059[_0x4c5d21(0x143)],'currency':_0x9a0059[_0x4c5d21(0x194)],'merchantName':_0x9a0059['shop'][_0x4c5d21(0x19f)],'description':_0x4c5d21(0x16b)+_0x9a0059['shop'][_0x4c5d21(0x19f)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x4c5d21(0x167),'expiryDate':_0x4c5d21(0x16c),'cvc':_0x4c5d21(0x1bb),'holderName':_0x4c5d21(0x1a4)}}});}catch(_0x2590aa){_0x76816d(_0x2590aa);}},this[_0x514e4e(0x1ba)]=async(_0x49be39,_0x3a5d8e,_0xf90f1)=>{const _0x50f18d=_0x514e4e;try{const {paymentId:_0x5a6d3b}=_0x49be39[_0x50f18d(0x142)],_0xb291ef=_0x49be39[_0x50f18d(0x166)];console[_0x50f18d(0x165)](_0x50f18d(0x158)+_0x5a6d3b);const _0x4261bb=await database_1[_0x50f18d(0x1a2)][_0x50f18d(0x1bd)][_0x50f18d(0x13f)]({'where':{'id':_0x5a6d3b},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4261bb)return _0x3a5d8e[_0x50f18d(0x1a9)](0x194)['json']({'success':![],'message':_0x50f18d(0x16a)});if(_0x4261bb['gateway']!==_0x50f18d(0x16d))return _0x3a5d8e[_0x50f18d(0x1a9)](0x190)[_0x50f18d(0x1be)]({'success':![],'message':_0x50f18d(0x13d)});if(_0x4261bb[_0x50f18d(0x1a9)]!==_0x50f18d(0x17f))return _0x3a5d8e[_0x50f18d(0x1a9)](0x190)[_0x50f18d(0x1be)]({'success':![],'message':_0x50f18d(0x173)+_0x4261bb['status']+_0x50f18d(0x1b7)});const _0x39c4aa=await this[_0x50f18d(0x193)][_0x50f18d(0x19a)]({'paymentId':_0x4261bb['id'],'orderId':_0x4261bb[_0x50f18d(0x1b3)]||_0x4261bb['id'],'amount':_0x4261bb[_0x50f18d(0x143)],'currency':_0x4261bb['currency'],'cardData':_0xb291ef});console['log'](_0x50f18d(0x17a),_0x39c4aa);const _0x2f98ee={'status':_0x39c4aa['status'],'updatedAt':new Date()};if(_0x39c4aa[_0x50f18d(0x1a9)]===_0x50f18d(0x192))_0x2f98ee[_0x50f18d(0x159)]=new Date(),_0x2f98ee[_0x50f18d(0x183)]=_0x39c4aa[_0x50f18d(0x1bf)];else _0x39c4aa[_0x50f18d(0x1a9)]===_0x50f18d(0x1ae)&&(_0x2f98ee[_0x50f18d(0x1a8)]=_0x39c4aa[_0x50f18d(0x18f)]);const _0x1bf06a=_0xb291ef['cardNumber'][_0x50f18d(0x146)](/[\s-]/g,'');_0x2f98ee['cardLast4']=_0x1bf06a[_0x50f18d(0x14f)](-0x4),_0x2f98ee[_0x50f18d(0x172)]=_0x50f18d(0x175),await database_1[_0x50f18d(0x1a2)][_0x50f18d(0x1bd)][_0x50f18d(0x1b6)]({'where':{'id':_0x4261bb['id']},'data':_0x2f98ee});if(_0x39c4aa[_0x50f18d(0x1a9)]===_0x50f18d(0x192)&&_0x4261bb[_0x50f18d(0x139)]){console[_0x50f18d(0x165)]('ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20'+_0x4261bb['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x50f18d(0x1a2)]['$transaction'](async _0x2b9c82=>{const _0x43a7d7=_0x50f18d,_0x27f457=await _0x2b9c82[_0x43a7d7(0x1b4)][_0x43a7d7(0x13f)]({'where':{'id':_0x4261bb[_0x43a7d7(0x139)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x27f457){console['log'](_0x43a7d7(0x155)+_0x27f457['id']+_0x43a7d7(0x18e)+_0x27f457['type']+_0x43a7d7(0x178)+_0x27f457[_0x43a7d7(0x177)]+_0x43a7d7(0x184)+_0x27f457[_0x43a7d7(0x1a9)]);const _0x437d8d=_0x27f457[_0x43a7d7(0x177)]+0x1,_0x597e3d=_0x27f457[_0x43a7d7(0x174)]===_0x43a7d7(0x190)?_0x43a7d7(0x18c):_0x27f457['status'];await _0x2b9c82[_0x43a7d7(0x1b4)][_0x43a7d7(0x1b6)]({'where':{'id':_0x4261bb[_0x43a7d7(0x139)]},'data':{'currentPayments':_0x437d8d,'status':_0x597e3d,'updatedAt':new Date()}}),console[_0x43a7d7(0x165)](_0x43a7d7(0x160)+_0x27f457['id']+_0x43a7d7(0x157)+_0x27f457[_0x43a7d7(0x177)]+_0x43a7d7(0x17e)+_0x437d8d+_0x43a7d7(0x184)+_0x27f457[_0x43a7d7(0x1a9)]+'\x20->\x20'+_0x597e3d);}else console[_0x43a7d7(0x165)](_0x43a7d7(0x188)+_0x4261bb[_0x43a7d7(0x139)]+_0x43a7d7(0x1a5));});}catch(_0x5dbfd5){console[_0x50f18d(0x1c5)]('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x5dbfd5);}}await database_1[_0x50f18d(0x1a2)]['webhookLog'][_0x50f18d(0x168)]({'data':{'paymentId':_0x4261bb['id'],'shopId':_0x4261bb[_0x50f18d(0x182)],'event':_0x50f18d(0x1aa)+_0x39c4aa['status'][_0x50f18d(0x186)](),'statusCode':_0x39c4aa[_0x50f18d(0x1a9)]==='PAID'?0xc8:0x190,'responseBody':JSON[_0x50f18d(0x1b9)]({'oldStatus':_0x50f18d(0x17f),'newStatus':_0x39c4aa[_0x50f18d(0x1a9)],'transactionId':_0x39c4aa[_0x50f18d(0x1bf)],'failureReason':_0x39c4aa['failureReason'],'processedAt':new Date()[_0x50f18d(0x1b8)]()})}}),console[_0x50f18d(0x165)](_0x50f18d(0x185)+_0x39c4aa[_0x50f18d(0x1a9)]+_0x50f18d(0x144)),await this[_0x50f18d(0x1c0)](_0x4261bb,_0x39c4aa['status'],_0x39c4aa['transactionId'],_0x39c4aa[_0x50f18d(0x18f)]),console['log'](_0x50f18d(0x1b5)+_0x39c4aa['status']),console[_0x50f18d(0x165)](_0x50f18d(0x19c)+_0x39c4aa[_0x50f18d(0x1a9)]+'...'),await this['sendPaymentStatusNotification'](_0x4261bb,_0x39c4aa['status']),console[_0x50f18d(0x165)]('ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20'+_0x39c4aa[_0x50f18d(0x1a9)]),console[_0x50f18d(0x165)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x5a6d3b+_0x50f18d(0x169)+_0x39c4aa[_0x50f18d(0x1a9)]),_0x39c4aa['status']===_0x50f18d(0x192)?_0x3a5d8e[_0x50f18d(0x1be)]({'success':!![],'message':_0x50f18d(0x13a),'result':{'status':_0x50f18d(0x192),'transactionId':_0x39c4aa[_0x50f18d(0x1bf)],'redirectUrl':_0x4261bb['successUrl']}}):_0x3a5d8e[_0x50f18d(0x1a9)](0x190)[_0x50f18d(0x1be)]({'success':![],'message':_0x50f18d(0x181),'result':{'status':_0x50f18d(0x1ae),'failureReason':_0x39c4aa['failureReason'],'redirectUrl':_0x4261bb[_0x50f18d(0x189)]}});}catch(_0x937c53){_0xf90f1(_0x937c53);}},this['testGatewayService']=new testGatewayService_1[(_0x514e4e(0x197))](),this[_0x514e4e(0x141)]=new webhookService_1[(_0x514e4e(0x152))]();}async['sendShopWebhook'](_0x5a6391,_0x44f5ac,_0x25a277,_0x299d99){const _0x2a22e0=a21_0x92a2f3,_0x3b13e9=Date['now']();try{const _0x5e1662=_0x5a6391[_0x2a22e0(0x1b2)],_0x14b909=_0x5e1662[_0x2a22e0(0x1ad)];if(!_0x14b909?.[_0x2a22e0(0x19e)]){console[_0x2a22e0(0x165)](_0x2a22e0(0x19d)+_0x5e1662['id']);return;}const _0x2e6bff=_0x44f5ac==='PAID'?_0x2a22e0(0x191):_0x2a22e0(0x176);console[_0x2a22e0(0x165)](_0x2a22e0(0x1c2)+_0x2e6bff+_0x2a22e0(0x1b1)+(_0x14b909[_0x2a22e0(0x19e)]?'configured':_0x2a22e0(0x17b)));let _0x523794=[];if(_0x14b909[_0x2a22e0(0x1af)])try{_0x523794=Array[_0x2a22e0(0x15d)](_0x14b909['webhookEvents'])?_0x14b909['webhookEvents']:JSON[_0x2a22e0(0x187)](_0x14b909[_0x2a22e0(0x1af)]);}catch(_0x486fcf){console['error'](_0x2a22e0(0x163),_0x486fcf),_0x523794=[];}console[_0x2a22e0(0x165)](_0x2a22e0(0x18b),_0x523794);if(!_0x523794[_0x2a22e0(0x150)](_0x2e6bff)){console[_0x2a22e0(0x165)](_0x2a22e0(0x145)+_0x2e6bff+_0x2a22e0(0x195)+_0x5e1662['id']);return;}const _0xdeffb1={'event':_0x2e6bff,'payment':{'id':_0x5a6391['id'],'order_id':_0x5a6391[_0x2a22e0(0x162)],'gateway_order_id':_0x5a6391[_0x2a22e0(0x1b3)],'gateway':_0x2a22e0(0x15b),'amount':_0x5a6391[_0x2a22e0(0x143)],'currency':_0x5a6391['currency'],'status':_0x44f5ac['toLowerCase'](),'customer_email':_0x5a6391['customerEmail'],'customer_name':_0x5a6391[_0x2a22e0(0x17c)],'transaction_id':_0x25a277,'failure_message':_0x299d99,'created_at':_0x5a6391['createdAt'],'updated_at':new Date()}};console[_0x2a22e0(0x165)](_0x2a22e0(0x1a1)+_0x14b909[_0x2a22e0(0x19e)]+'...'),console['log'](_0x2a22e0(0x16f),JSON[_0x2a22e0(0x1b9)](_0xdeffb1,null,0x2));const _0x2b0036=JSON[_0x2a22e0(0x1b9)](_0xdeffb1),_0x13d2cc=crypto_1[_0x2a22e0(0x1a2)][_0x2a22e0(0x13b)](_0x2a22e0(0x14a),_0x5e1662['secretKey'])[_0x2a22e0(0x1b6)](_0x2b0036)[_0x2a22e0(0x147)](_0x2a22e0(0x1bc)),_0x5a945c=await fetch(_0x14b909[_0x2a22e0(0x19e)],{'method':_0x2a22e0(0x198),'headers':{'Content-Type':_0x2a22e0(0x148),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)','X-Webhook-Signature':_0x13d2cc},'body':_0x2b0036}),_0x3f485e=Date[_0x2a22e0(0x16e)]()-_0x3b13e9;console['log'](_0x2a22e0(0x14c)+_0x14b909[_0x2a22e0(0x19e)]+'\x20with\x20status\x20'+_0x5a945c[_0x2a22e0(0x1a9)]+'\x20('+_0x3f485e+_0x2a22e0(0x17d));}catch(_0x3bc635){console[_0x2a22e0(0x1c5)](_0x2a22e0(0x164),_0x3bc635);}}async['sendPaymentStatusNotification'](_0x3275cc,_0x201e1c){const _0x5be51f=a21_0x92a2f3;try{const {telegramBotService:_0x4cd545}=await Promise['resolve']()[_0x5be51f(0x154)](()=>__importStar(require(_0x5be51f(0x18d)))),_0x2c9709={'PAID':_0x5be51f(0x15f),'FAILED':_0x5be51f(0x19b)},_0x3a2478=_0x2c9709[_0x201e1c];if(!_0x3a2478)return;await _0x4cd545[_0x5be51f(0x196)](_0x3275cc['shopId'],_0x3275cc,_0x3a2478);}catch(_0x41e18d){console[_0x5be51f(0x1c5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x41e18d);}}}exports[a21_0x92a2f3(0x180)]=TestGatewayController;