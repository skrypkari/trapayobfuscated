'use strict';const a13_0x20abf8=a13_0x3ddd;(function(_0x23143b,_0x228c6e){const _0x15098c=a13_0x3ddd,_0x31bbed=_0x23143b();while(!![]){try{const _0x4872de=parseInt(_0x15098c(0x1b2))/0x1+-parseInt(_0x15098c(0x1c8))/0x2*(-parseInt(_0x15098c(0x206))/0x3)+-parseInt(_0x15098c(0x1c1))/0x4*(-parseInt(_0x15098c(0x1e4))/0x5)+-parseInt(_0x15098c(0x1d6))/0x6+parseInt(_0x15098c(0x200))/0x7+-parseInt(_0x15098c(0x1bb))/0x8+parseInt(_0x15098c(0x1f4))/0x9*(parseInt(_0x15098c(0x1eb))/0xa);if(_0x4872de===_0x228c6e)break;else _0x31bbed['push'](_0x31bbed['shift']());}catch(_0x377479){_0x31bbed['push'](_0x31bbed['shift']());}}}(a13_0x55d4,0x9c0d9));function a13_0x55d4(){const _0x4b20c0=['slice','4120NyvyLH','params',',\x20cannot\x20process','failed','update','settings','Payment\x20not\x20found','Payment\x20is\x20not\x20for\x20test\x20gateway','Test\x20Gateway\x20webhook\x20sent\x20to\x20','20547OyZBrU','stringify','create','prototype','length','Error\x20parsing\x20webhook\x20events:','testGatewayService','__importDefault','PENDING','shop','failureMessage','Any\x20name','2746541gFILiy','gatewayOrderId','transactionId','resolve','__setModuleDefault','configurable','3RjFXXb','default','webhookService','sendShopWebhook','Payment\x20failed','includes','__esModule','Any\x20future\x20date\x20(MM/YY)','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__createBinding','writable','Payment\x20to\x20','currency','TestGatewayController','customerEmail','../services/gateways/testGatewayService','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','0000','then','failUrl','sendPaymentStatusNotification','__importStar','../services/telegramBotService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','log','toLowerCase','toISOString','4242\x204242\x204242\x204242','gateway','parse','1206555FvcZMj','defineProperty','getOwnPropertyNames','POST','test_card','gatewayPaymentId','FAILED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Any\x20other\x20card\x20number','7836392oDSeKS','paymentMethod','processCard','payment.success','Any\x203-4\x20digits','findUnique','515876voCadU','now','webhookEvents','failureReason','getOwnPropertyDescriptor','test_gateway','amount','406586GrMjNm','get','cardNumber','Webhook\x20event\x20','webhookUrl','TestGatewayService','error','application/json','../services/webhookService','\x20processed:\x20','WebhookService','PAID','isArray','getPaymentForm','7518204AEqZQD','status','paid','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20status\x20is\x20','json','name','payment','processCardPayment','shopId','payment.failed','paidAt','ðŸ§ª\x20Test\x20Gateway\x20result:','createdAt','5dHsqcg','ms)','âœ…\x20Test\x20Gateway\x20payment\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20processed\x20successfully','orderId'];a13_0x55d4=function(){return _0x4b20c0;};return a13_0x55d4();}var __createBinding=this&&this[a13_0x20abf8(0x20f)]||(Object[a13_0x20abf8(0x1f6)]?function(_0x4eb9a9,_0x1cd380,_0x2f0675,_0x40212c){const _0x3f66fa=a13_0x20abf8;if(_0x40212c===undefined)_0x40212c=_0x2f0675;var _0x191962=Object[_0x3f66fa(0x1c5)](_0x1cd380,_0x2f0675);(!_0x191962||(_0x3f66fa(0x1c9)in _0x191962?!_0x1cd380[_0x3f66fa(0x20c)]:_0x191962[_0x3f66fa(0x210)]||_0x191962[_0x3f66fa(0x205)]))&&(_0x191962={'enumerable':!![],'get':function(){return _0x1cd380[_0x2f0675];}}),Object[_0x3f66fa(0x1b3)](_0x4eb9a9,_0x40212c,_0x191962);}:function(_0x3b2a67,_0x157085,_0x4cc3c2,_0xa94540){if(_0xa94540===undefined)_0xa94540=_0x4cc3c2;_0x3b2a67[_0xa94540]=_0x157085[_0x4cc3c2];}),__setModuleDefault=this&&this[a13_0x20abf8(0x204)]||(Object[a13_0x20abf8(0x1f6)]?function(_0x4662d7,_0x441532){const _0x3f7387=a13_0x20abf8;Object[_0x3f7387(0x1b3)](_0x4662d7,_0x3f7387(0x207),{'enumerable':!![],'value':_0x441532});}:function(_0x1dddec,_0x27a4d2){_0x1dddec['default']=_0x27a4d2;}),__importStar=this&&this[a13_0x20abf8(0x1a9)]||(function(){var _0x54ed1d=function(_0x2a3394){const _0x2426b1=a13_0x3ddd;return _0x54ed1d=Object[_0x2426b1(0x1b4)]||function(_0x153566){const _0x58e00b=_0x2426b1;var _0x82eb25=[];for(var _0x448f90 in _0x153566)if(Object[_0x58e00b(0x1f7)]['hasOwnProperty']['call'](_0x153566,_0x448f90))_0x82eb25[_0x82eb25[_0x58e00b(0x1f8)]]=_0x448f90;return _0x82eb25;},_0x54ed1d(_0x2a3394);};return function(_0x1e0fd9){const _0xbcf5d6=a13_0x3ddd;if(_0x1e0fd9&&_0x1e0fd9['__esModule'])return _0x1e0fd9;var _0x5af185={};if(_0x1e0fd9!=null){for(var _0x148f95=_0x54ed1d(_0x1e0fd9),_0x5cf99c=0x0;_0x5cf99c<_0x148f95['length'];_0x5cf99c++)if(_0x148f95[_0x5cf99c]!==_0xbcf5d6(0x207))__createBinding(_0x5af185,_0x1e0fd9,_0x148f95[_0x5cf99c]);}return __setModuleDefault(_0x5af185,_0x1e0fd9),_0x5af185;};}()),__importDefault=this&&this[a13_0x20abf8(0x1fb)]||function(_0x1b184f){const _0x34cdfd=a13_0x20abf8;return _0x1b184f&&_0x1b184f[_0x34cdfd(0x20c)]?_0x1b184f:{'default':_0x1b184f};};Object[a13_0x20abf8(0x1b3)](exports,a13_0x20abf8(0x20c),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x20abf8(0x1a3)),webhookService_1=require(a13_0x20abf8(0x1d0)),database_1=__importDefault(require('../config/database'));function a13_0x3ddd(_0x50452e,_0x373b80){const _0x55d4f6=a13_0x55d4();return a13_0x3ddd=function(_0x3dddeb,_0x2f5130){_0x3dddeb=_0x3dddeb-0x1a3;let _0x192a21=_0x55d4f6[_0x3dddeb];return _0x192a21;},a13_0x3ddd(_0x50452e,_0x373b80);}class TestGatewayController{constructor(){const _0x14306f=a13_0x20abf8;this[_0x14306f(0x1d5)]=async(_0x52e954,_0x260434,_0x464a95)=>{const _0x337273=_0x14306f;try{const {paymentId:_0x509765}=_0x52e954['params'];console[_0x337273(0x1ac)](_0x337273(0x1e7)+_0x509765);const _0x1423e0=await database_1[_0x337273(0x207)]['payment'][_0x337273(0x1c0)]({'where':{'id':_0x509765},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1423e0)return _0x260434[_0x337273(0x1d7)](0x194)[_0x337273(0x1db)]({'success':![],'message':_0x337273(0x1f1)});if(_0x1423e0[_0x337273(0x1b0)]!==_0x337273(0x1c6))return _0x260434[_0x337273(0x1d7)](0x190)[_0x337273(0x1db)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x1423e0['status']!==_0x337273(0x1fc))return _0x260434[_0x337273(0x1d7)](0x190)[_0x337273(0x1db)]({'success':![],'message':_0x337273(0x1da)+_0x1423e0[_0x337273(0x1d7)]+_0x337273(0x1ed)});_0x260434['json']({'success':!![],'result':{'paymentId':_0x1423e0['id'],'orderId':_0x1423e0['gatewayOrderId'],'amount':_0x1423e0[_0x337273(0x1c7)],'currency':_0x1423e0[_0x337273(0x212)],'merchantName':_0x1423e0[_0x337273(0x1fd)][_0x337273(0x1dc)],'description':_0x337273(0x211)+_0x1423e0[_0x337273(0x1fd)][_0x337273(0x1dc)],'testInstructions':{'successCard':_0x337273(0x1af),'failureCard':_0x337273(0x1ba),'expiryDate':_0x337273(0x20d),'cvc':_0x337273(0x1bf),'holderName':_0x337273(0x1ff)}}});}catch(_0x12f619){_0x464a95(_0x12f619);}},this[_0x14306f(0x1bd)]=async(_0x4e2a74,_0x48aca8,_0x5341c2)=>{const _0x18a1c8=_0x14306f;try{const {paymentId:_0x18ba45}=_0x4e2a74[_0x18a1c8(0x1ec)],_0x177545=_0x4e2a74['body'];console[_0x18a1c8(0x1ac)](_0x18a1c8(0x20e)+_0x18ba45);const _0x3075c0=await database_1[_0x18a1c8(0x207)][_0x18a1c8(0x1dd)][_0x18a1c8(0x1c0)]({'where':{'id':_0x18ba45},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3075c0)return _0x48aca8[_0x18a1c8(0x1d7)](0x194)[_0x18a1c8(0x1db)]({'success':![],'message':_0x18a1c8(0x1f1)});if(_0x3075c0[_0x18a1c8(0x1b0)]!=='test_gateway')return _0x48aca8[_0x18a1c8(0x1d7)](0x190)['json']({'success':![],'message':_0x18a1c8(0x1f2)});if(_0x3075c0[_0x18a1c8(0x1d7)]!==_0x18a1c8(0x1fc))return _0x48aca8['status'](0x190)['json']({'success':![],'message':_0x18a1c8(0x1da)+_0x3075c0[_0x18a1c8(0x1d7)]+_0x18a1c8(0x1ed)});const _0x3c1a64=await this[_0x18a1c8(0x1fa)][_0x18a1c8(0x1de)]({'paymentId':_0x3075c0['id'],'orderId':_0x3075c0[_0x18a1c8(0x201)]||_0x3075c0['id'],'amount':_0x3075c0[_0x18a1c8(0x1c7)],'currency':_0x3075c0[_0x18a1c8(0x212)],'cardData':_0x177545});console[_0x18a1c8(0x1ac)](_0x18a1c8(0x1e2),_0x3c1a64);const _0x942264={'status':_0x3c1a64['status'],'updatedAt':new Date()};if(_0x3c1a64['status']===_0x18a1c8(0x1d3))_0x942264[_0x18a1c8(0x1e1)]=new Date(),_0x942264[_0x18a1c8(0x1b7)]=_0x3c1a64[_0x18a1c8(0x202)];else _0x3c1a64['status']==='FAILED'&&(_0x942264[_0x18a1c8(0x1fe)]=_0x3c1a64[_0x18a1c8(0x1c4)]);const _0x5916ab=_0x177545[_0x18a1c8(0x1ca)]['replace'](/[\s-]/g,'');_0x942264['cardLast4']=_0x5916ab[_0x18a1c8(0x1ea)](-0x4),_0x942264[_0x18a1c8(0x1bc)]=_0x18a1c8(0x1b6),await database_1['default'][_0x18a1c8(0x1dd)][_0x18a1c8(0x1ef)]({'where':{'id':_0x3075c0['id']},'data':_0x942264}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x3075c0['id'],'shopId':_0x3075c0[_0x18a1c8(0x1df)],'event':'test_gateway_'+_0x3c1a64['status'][_0x18a1c8(0x1ad)](),'statusCode':0xc8,'responseBody':JSON[_0x18a1c8(0x1f5)]({'oldStatus':_0x18a1c8(0x1fc),'newStatus':_0x3c1a64[_0x18a1c8(0x1d7)],'transactionId':_0x3c1a64['transactionId'],'failureReason':_0x3c1a64['failureReason'],'processedAt':new Date()[_0x18a1c8(0x1ae)]()})}}),await this[_0x18a1c8(0x209)](_0x3075c0,_0x3c1a64[_0x18a1c8(0x1d7)],_0x3c1a64[_0x18a1c8(0x202)],_0x3c1a64['failureReason']),await this[_0x18a1c8(0x1a8)](_0x3075c0,_0x3c1a64[_0x18a1c8(0x1d7)]),console[_0x18a1c8(0x1ac)](_0x18a1c8(0x1e6)+_0x18ba45+_0x18a1c8(0x1d1)+_0x3c1a64[_0x18a1c8(0x1d7)]),_0x3c1a64[_0x18a1c8(0x1d7)]===_0x18a1c8(0x1d3)?_0x48aca8['json']({'success':!![],'message':_0x18a1c8(0x1e8),'result':{'status':_0x18a1c8(0x1d3),'transactionId':_0x3c1a64[_0x18a1c8(0x202)],'redirectUrl':_0x3075c0['successUrl']}}):_0x48aca8[_0x18a1c8(0x1d7)](0x190)[_0x18a1c8(0x1db)]({'success':![],'message':_0x18a1c8(0x20a),'result':{'status':_0x18a1c8(0x1b8),'failureReason':_0x3c1a64[_0x18a1c8(0x1c4)],'redirectUrl':_0x3075c0[_0x18a1c8(0x1a7)]}});}catch(_0x3124b1){_0x5341c2(_0x3124b1);}},this[_0x14306f(0x1fa)]=new testGatewayService_1[(_0x14306f(0x1cd))](),this[_0x14306f(0x208)]=new webhookService_1[(_0x14306f(0x1d2))]();}async[a13_0x20abf8(0x209)](_0x4d5264,_0x435abc,_0x6a2655,_0x3f6484){const _0x4ce118=a13_0x20abf8,_0x53784e=Date[_0x4ce118(0x1c2)]();try{const _0x123823=_0x4d5264[_0x4ce118(0x1fd)],_0x2c087a=_0x123823[_0x4ce118(0x1f0)];if(!_0x2c087a?.[_0x4ce118(0x1cc)]){console['log'](_0x4ce118(0x1ab)+_0x123823['id']);return;}const _0x32c989=_0x435abc===_0x4ce118(0x1d3)?_0x4ce118(0x1be):_0x4ce118(0x1e0);let _0x21281a=[];if(_0x2c087a['webhookEvents'])try{_0x21281a=Array[_0x4ce118(0x1d4)](_0x2c087a[_0x4ce118(0x1c3)])?_0x2c087a[_0x4ce118(0x1c3)]:JSON[_0x4ce118(0x1b1)](_0x2c087a[_0x4ce118(0x1c3)]);}catch(_0x929c9){console['error'](_0x4ce118(0x1f9),_0x929c9),_0x21281a=[];}if(!_0x21281a[_0x4ce118(0x20b)](_0x32c989)){console[_0x4ce118(0x1ac)](_0x4ce118(0x1cb)+_0x32c989+_0x4ce118(0x1d9)+_0x123823['id']);return;}const _0xc9d264={'event':_0x32c989,'payment':{'id':_0x4d5264['id'],'order_id':_0x4d5264[_0x4ce118(0x1e9)],'gateway_order_id':_0x4d5264[_0x4ce118(0x201)],'gateway':_0x4ce118(0x1a5),'amount':_0x4d5264[_0x4ce118(0x1c7)],'currency':_0x4d5264[_0x4ce118(0x212)],'status':_0x435abc[_0x4ce118(0x1ad)](),'customer_email':_0x4d5264[_0x4ce118(0x214)],'customer_name':_0x4d5264['customerName'],'transaction_id':_0x6a2655,'failure_message':_0x3f6484,'created_at':_0x4d5264[_0x4ce118(0x1e3)],'updated_at':new Date()}},_0x53ff2e=await fetch(_0x2c087a['webhookUrl'],{'method':_0x4ce118(0x1b5),'headers':{'Content-Type':_0x4ce118(0x1cf),'User-Agent':_0x4ce118(0x1a4)},'body':JSON[_0x4ce118(0x1f5)](_0xc9d264)}),_0x164f70=Date[_0x4ce118(0x1c2)]()-_0x53784e;console['log'](_0x4ce118(0x1f3)+_0x2c087a['webhookUrl']+'\x20with\x20status\x20'+_0x53ff2e[_0x4ce118(0x1d7)]+'\x20('+_0x164f70+_0x4ce118(0x1e5));}catch(_0x3fa574){console[_0x4ce118(0x1ce)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x3fa574);}}async[a13_0x20abf8(0x1a8)](_0x58387a,_0x1bed3f){const _0x3979e0=a13_0x20abf8;try{const {telegramBotService:_0xe91427}=await Promise[_0x3979e0(0x203)]()[_0x3979e0(0x1a6)](()=>__importStar(require(_0x3979e0(0x1aa)))),_0x48fb51={'PAID':_0x3979e0(0x1d8),'FAILED':_0x3979e0(0x1ee)},_0x3500a3=_0x48fb51[_0x1bed3f];if(!_0x3500a3)return;await _0xe91427['sendPaymentNotification'](_0x58387a[_0x3979e0(0x1df)],_0x58387a,_0x3500a3);}catch(_0x469296){console[_0x3979e0(0x1ce)](_0x3979e0(0x1b9),_0x469296);}}}exports[a13_0x20abf8(0x213)]=TestGatewayController;