'use strict';const a18_0x2fd386=a18_0x3093;(function(_0x3cae49,_0x4f476e){const _0x34aa47=a18_0x3093,_0x4a5980=_0x3cae49();while(!![]){try{const _0x1180d9=-parseInt(_0x34aa47(0x1df))/0x1*(-parseInt(_0x34aa47(0x1e6))/0x2)+parseInt(_0x34aa47(0x1fd))/0x3*(parseInt(_0x34aa47(0x1ad))/0x4)+parseInt(_0x34aa47(0x1e5))/0x5+-parseInt(_0x34aa47(0x1b0))/0x6+-parseInt(_0x34aa47(0x1a8))/0x7+parseInt(_0x34aa47(0x1e8))/0x8*(-parseInt(_0x34aa47(0x1f2))/0x9)+-parseInt(_0x34aa47(0x1f5))/0xa;if(_0x1180d9===_0x4f476e)break;else _0x4a5980['push'](_0x4a5980['shift']());}catch(_0x3257e6){_0x4a5980['push'](_0x4a5980['shift']());}}}(a18_0x32df,0x6a19b));function a18_0x32df(){const _0x55ae1c=['toLowerCase','__createBinding','20PQjNOo','params','test_gateway','WebhookService','Any\x20name','webhookService','4345855DbcvnJ','84628inMFBy','sendPaymentNotification','37832bpuJaj','isArray','hasOwnProperty','default','__importDefault','stringify','webhookEvents','\x20->\x20','failureMessage','__esModule','1233ZUoBpC',',\x20cannot\x20process','getPaymentForm','1483610EYfSxr','slice','PAID','currentPayments','\x20not\x20found','FAILED','PENDING','Payment\x20is\x20not\x20for\x20test\x20gateway','363ZCWfSN','\x20with\x20status\x20','payment.success','prototype','webhookUrl','currency','Payment\x20status\x20is\x20','Any\x20other\x20card\x20number','Payment\x20to\x20','paid','üß™\x20Test\x20Gateway\x20result:','getOwnPropertyDescriptor','findUnique','paymentLink','ms)','Error\x20parsing\x20webhook\x20events:','\x20processed:\x20','shop','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','test_gateway_','status','4242\x204242\x204242\x204242','resolve','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failUrl','name','now','replace','Any\x203-4\x20digits','sendShopWebhook','json','paidAt','orderId','log','processCardPayment','payment','\x20updated:\x20currentPayments=','type','4279996uUFocW','parse','‚úÖ\x20Test\x20Gateway\x20payment\x20','Webhook\x20event\x20','payment.failed','27976kObaCt','defineProperty','processCard','4316856PjrPLb','error','Any\x20future\x20date\x20(MM/YY)','settings','0000',':\x20type=','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','customerName',',\x20currentPayments=','customerEmail','Payment\x20processed\x20successfully','\x20not\x20enabled\x20for\x20shop\x20','‚ùå\x20Payment\x20link\x20','body','sendPaymentStatusNotification','gateway','testGatewayService','createdAt','call','shopId','paymentLinkId','../services/webhookService','create','configurable','Payment\x20failed','TestGatewayController','gatewayOrderId','amount','getOwnPropertyNames','__setModuleDefault','failed','../services/telegramBotService','gatewayPaymentId','length','failureReason','then','../services/gateways/testGatewayService','Payment\x20not\x20found','update','webhookLog','POST','transactionId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',',\x20status=','paymentMethod'];a18_0x32df=function(){return _0x55ae1c;};return a18_0x32df();}var __createBinding=this&&this[a18_0x2fd386(0x1de)]||(Object[a18_0x2fd386(0x1c6)]?function(_0x117cd0,_0x5329ff,_0x1a9354,_0x14b57a){const _0x2504f9=a18_0x2fd386;if(_0x14b57a===undefined)_0x14b57a=_0x1a9354;var _0x151eff=Object[_0x2504f9(0x208)](_0x5329ff,_0x1a9354);(!_0x151eff||('get'in _0x151eff?!_0x5329ff[_0x2504f9(0x1f1)]:_0x151eff['writable']||_0x151eff[_0x2504f9(0x1c7)]))&&(_0x151eff={'enumerable':!![],'get':function(){return _0x5329ff[_0x1a9354];}}),Object[_0x2504f9(0x1ae)](_0x117cd0,_0x14b57a,_0x151eff);}:function(_0x1cfe51,_0x3b45d5,_0x2ce180,_0x18b403){if(_0x18b403===undefined)_0x18b403=_0x2ce180;_0x1cfe51[_0x18b403]=_0x3b45d5[_0x2ce180];}),__setModuleDefault=this&&this[a18_0x2fd386(0x1cd)]||(Object[a18_0x2fd386(0x1c6)]?function(_0x4b2df2,_0x51bb89){const _0x401a52=a18_0x2fd386;Object[_0x401a52(0x1ae)](_0x4b2df2,_0x401a52(0x1eb),{'enumerable':!![],'value':_0x51bb89});}:function(_0x49f6c8,_0x5a48bb){const _0x307f42=a18_0x2fd386;_0x49f6c8[_0x307f42(0x1eb)]=_0x5a48bb;}),__importStar=this&&this['__importStar']||(function(){var _0x1d27e8=function(_0x2cded9){const _0x156729=a18_0x3093;return _0x1d27e8=Object[_0x156729(0x1cc)]||function(_0x203b42){const _0x42d443=_0x156729;var _0x2d7fdc=[];for(var _0x269223 in _0x203b42)if(Object[_0x42d443(0x200)][_0x42d443(0x1ea)][_0x42d443(0x1c2)](_0x203b42,_0x269223))_0x2d7fdc[_0x2d7fdc[_0x42d443(0x1d1)]]=_0x269223;return _0x2d7fdc;},_0x1d27e8(_0x2cded9);};return function(_0x5ab54f){const _0x2c0a7e=a18_0x3093;if(_0x5ab54f&&_0x5ab54f['__esModule'])return _0x5ab54f;var _0x25f87a={};if(_0x5ab54f!=null){for(var _0x2098f4=_0x1d27e8(_0x5ab54f),_0x114c48=0x0;_0x114c48<_0x2098f4[_0x2c0a7e(0x1d1)];_0x114c48++)if(_0x2098f4[_0x114c48]!==_0x2c0a7e(0x1eb))__createBinding(_0x25f87a,_0x5ab54f,_0x2098f4[_0x114c48]);}return __setModuleDefault(_0x25f87a,_0x5ab54f),_0x25f87a;};}()),__importDefault=this&&this[a18_0x2fd386(0x1ec)]||function(_0x34ddaf){return _0x34ddaf&&_0x34ddaf['__esModule']?_0x34ddaf:{'default':_0x34ddaf};};Object[a18_0x2fd386(0x1ae)](exports,a18_0x2fd386(0x1f1),{'value':!![]}),exports[a18_0x2fd386(0x1c9)]=void 0x0;const testGatewayService_1=require(a18_0x2fd386(0x1d4)),webhookService_1=require(a18_0x2fd386(0x1c5)),database_1=__importDefault(require('../config/database'));function a18_0x3093(_0x1fa9de,_0x2d3419){_0x1fa9de=_0x1fa9de-0x196;const _0x32dfa8=a18_0x32df();let _0x30932e=_0x32dfa8[_0x1fa9de];return _0x30932e;}class TestGatewayController{constructor(){const _0x34a957=a18_0x2fd386;this[_0x34a957(0x1f4)]=async(_0x2cb129,_0x5a8a13,_0x3a884f)=>{const _0x18a932=_0x34a957;try{const {paymentId:_0x5ce616}=_0x2cb129[_0x18a932(0x1e0)];console[_0x18a932(0x1a3)](_0x18a932(0x20f)+_0x5ce616);const _0x33e666=await database_1[_0x18a932(0x1eb)]['payment'][_0x18a932(0x209)]({'where':{'id':_0x5ce616},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x33e666)return _0x5a8a13[_0x18a932(0x196)](0x194)[_0x18a932(0x1a0)]({'success':![],'message':_0x18a932(0x1d5)});if(_0x33e666[_0x18a932(0x1bf)]!=='test_gateway')return _0x5a8a13[_0x18a932(0x196)](0x190)[_0x18a932(0x1a0)]({'success':![],'message':_0x18a932(0x1fc)});if(_0x33e666['status']!=='PENDING')return _0x5a8a13[_0x18a932(0x196)](0x190)[_0x18a932(0x1a0)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x33e666[_0x18a932(0x196)]+',\x20cannot\x20process'});_0x5a8a13[_0x18a932(0x1a0)]({'success':!![],'result':{'paymentId':_0x33e666['id'],'orderId':_0x33e666[_0x18a932(0x1ca)],'amount':_0x33e666[_0x18a932(0x1cb)],'currency':_0x33e666[_0x18a932(0x202)],'merchantName':_0x33e666[_0x18a932(0x20e)][_0x18a932(0x19b)],'description':_0x18a932(0x205)+_0x33e666[_0x18a932(0x20e)][_0x18a932(0x19b)],'testInstructions':{'successCard':_0x18a932(0x197),'failureCard':_0x18a932(0x204),'expiryDate':_0x18a932(0x1b2),'cvc':_0x18a932(0x19e),'holderName':_0x18a932(0x1e3)}}});}catch(_0x1b156a){_0x3a884f(_0x1b156a);}},this[_0x34a957(0x1af)]=async(_0x8c9172,_0x5c4010,_0x410fe2)=>{const _0x543654=_0x34a957;try{const {paymentId:_0x12d4fc}=_0x8c9172[_0x543654(0x1e0)],_0x59abfe=_0x8c9172[_0x543654(0x1bd)];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x12d4fc);const _0x1ace77=await database_1['default'][_0x543654(0x1a5)]['findUnique']({'where':{'id':_0x12d4fc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ace77)return _0x5c4010[_0x543654(0x196)](0x194)[_0x543654(0x1a0)]({'success':![],'message':_0x543654(0x1d5)});if(_0x1ace77['gateway']!==_0x543654(0x1e1))return _0x5c4010['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x1ace77[_0x543654(0x196)]!==_0x543654(0x1fb))return _0x5c4010[_0x543654(0x196)](0x190)[_0x543654(0x1a0)]({'success':![],'message':_0x543654(0x203)+_0x1ace77['status']+_0x543654(0x1f3)});const _0x393fc9=await this[_0x543654(0x1c0)][_0x543654(0x1a4)]({'paymentId':_0x1ace77['id'],'orderId':_0x1ace77[_0x543654(0x1ca)]||_0x1ace77['id'],'amount':_0x1ace77[_0x543654(0x1cb)],'currency':_0x1ace77['currency'],'cardData':_0x59abfe});console[_0x543654(0x1a3)](_0x543654(0x207),_0x393fc9);const _0x59e079={'status':_0x393fc9['status'],'updatedAt':new Date()};if(_0x393fc9[_0x543654(0x196)]===_0x543654(0x1f7))_0x59e079[_0x543654(0x1a1)]=new Date(),_0x59e079[_0x543654(0x1d0)]=_0x393fc9[_0x543654(0x1d9)];else _0x393fc9['status']===_0x543654(0x1fa)&&(_0x59e079[_0x543654(0x1f0)]=_0x393fc9[_0x543654(0x1d2)]);const _0x5a4b75=_0x59abfe['cardNumber'][_0x543654(0x19d)](/[\s-]/g,'');_0x59e079['cardLast4']=_0x5a4b75[_0x543654(0x1f6)](-0x4),_0x59e079[_0x543654(0x1dc)]='test_card',await database_1['default']['payment'][_0x543654(0x1d6)]({'where':{'id':_0x1ace77['id']},'data':_0x59e079});if(_0x393fc9['status']===_0x543654(0x1f7)&&_0x1ace77['paymentLinkId']){console['log']('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x1ace77['id']+_0x543654(0x210));try{await database_1[_0x543654(0x1eb)]['$transaction'](async _0x20227c=>{const _0x5ef6f9=_0x543654,_0x3f6513=await _0x20227c[_0x5ef6f9(0x20a)]['findUnique']({'where':{'id':_0x1ace77[_0x5ef6f9(0x1c4)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3f6513){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x3f6513['id']+_0x5ef6f9(0x1b5)+_0x3f6513['type']+_0x5ef6f9(0x1b8)+_0x3f6513[_0x5ef6f9(0x1f8)]+_0x5ef6f9(0x1db)+_0x3f6513[_0x5ef6f9(0x196)]);const _0x5259a4=_0x3f6513[_0x5ef6f9(0x1f8)]+0x1,_0x23fa6d=_0x3f6513[_0x5ef6f9(0x1a7)]==='SINGLE'?'COMPLETED':_0x3f6513[_0x5ef6f9(0x196)];await _0x20227c[_0x5ef6f9(0x20a)][_0x5ef6f9(0x1d6)]({'where':{'id':_0x1ace77[_0x5ef6f9(0x1c4)]},'data':{'currentPayments':_0x5259a4,'status':_0x23fa6d,'updatedAt':new Date()}}),console[_0x5ef6f9(0x1a3)]('‚úÖ\x20Payment\x20link\x20'+_0x3f6513['id']+_0x5ef6f9(0x1a6)+_0x3f6513[_0x5ef6f9(0x1f8)]+_0x5ef6f9(0x1ef)+_0x5259a4+_0x5ef6f9(0x1db)+_0x3f6513[_0x5ef6f9(0x196)]+_0x5ef6f9(0x1ef)+_0x23fa6d);}else console['log'](_0x5ef6f9(0x1bc)+_0x1ace77[_0x5ef6f9(0x1c4)]+_0x5ef6f9(0x1f9));});}catch(_0x520af5){console[_0x543654(0x1b1)](_0x543654(0x1b6),_0x520af5);}}await database_1[_0x543654(0x1eb)][_0x543654(0x1d7)][_0x543654(0x1c6)]({'data':{'paymentId':_0x1ace77['id'],'shopId':_0x1ace77[_0x543654(0x1c3)],'event':_0x543654(0x211)+_0x393fc9[_0x543654(0x196)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x543654(0x1ed)]({'oldStatus':_0x543654(0x1fb),'newStatus':_0x393fc9[_0x543654(0x196)],'transactionId':_0x393fc9[_0x543654(0x1d9)],'failureReason':_0x393fc9[_0x543654(0x1d2)],'processedAt':new Date()['toISOString']()})}}),await this[_0x543654(0x19f)](_0x1ace77,_0x393fc9[_0x543654(0x196)],_0x393fc9[_0x543654(0x1d9)],_0x393fc9['failureReason']),await this['sendPaymentStatusNotification'](_0x1ace77,_0x393fc9[_0x543654(0x196)]),console[_0x543654(0x1a3)](_0x543654(0x1aa)+_0x12d4fc+_0x543654(0x20d)+_0x393fc9[_0x543654(0x196)]),_0x393fc9[_0x543654(0x196)]===_0x543654(0x1f7)?_0x5c4010['json']({'success':!![],'message':_0x543654(0x1ba),'result':{'status':'PAID','transactionId':_0x393fc9['transactionId'],'redirectUrl':_0x1ace77['successUrl']}}):_0x5c4010[_0x543654(0x196)](0x190)[_0x543654(0x1a0)]({'success':![],'message':_0x543654(0x1c8),'result':{'status':_0x543654(0x1fa),'failureReason':_0x393fc9['failureReason'],'redirectUrl':_0x1ace77[_0x543654(0x19a)]}});}catch(_0x2b2240){_0x410fe2(_0x2b2240);}},this[_0x34a957(0x1c0)]=new testGatewayService_1['TestGatewayService'](),this[_0x34a957(0x1e4)]=new webhookService_1[(_0x34a957(0x1e2))]();}async[a18_0x2fd386(0x19f)](_0x5a8d75,_0x2df101,_0x2e446d,_0x4189d4){const _0x4ac982=a18_0x2fd386,_0x30a3de=Date['now']();try{const _0x32d61c=_0x5a8d75[_0x4ac982(0x20e)],_0x21ade0=_0x32d61c[_0x4ac982(0x1b3)];if(!_0x21ade0?.[_0x4ac982(0x201)]){console[_0x4ac982(0x1a3)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x32d61c['id']);return;}const _0x55ed75=_0x2df101===_0x4ac982(0x1f7)?_0x4ac982(0x1ff):_0x4ac982(0x1ac);let _0xca46cf=[];if(_0x21ade0[_0x4ac982(0x1ee)])try{_0xca46cf=Array[_0x4ac982(0x1e9)](_0x21ade0[_0x4ac982(0x1ee)])?_0x21ade0['webhookEvents']:JSON[_0x4ac982(0x1a9)](_0x21ade0[_0x4ac982(0x1ee)]);}catch(_0x4a3479){console[_0x4ac982(0x1b1)](_0x4ac982(0x20c),_0x4a3479),_0xca46cf=[];}if(!_0xca46cf['includes'](_0x55ed75)){console[_0x4ac982(0x1a3)](_0x4ac982(0x1ab)+_0x55ed75+_0x4ac982(0x1bb)+_0x32d61c['id']);return;}const _0x5efea0={'event':_0x55ed75,'payment':{'id':_0x5a8d75['id'],'order_id':_0x5a8d75[_0x4ac982(0x1a2)],'gateway_order_id':_0x5a8d75[_0x4ac982(0x1ca)],'gateway':_0x4ac982(0x1b4),'amount':_0x5a8d75[_0x4ac982(0x1cb)],'currency':_0x5a8d75[_0x4ac982(0x202)],'status':_0x2df101[_0x4ac982(0x1dd)](),'customer_email':_0x5a8d75[_0x4ac982(0x1b9)],'customer_name':_0x5a8d75[_0x4ac982(0x1b7)],'transaction_id':_0x2e446d,'failure_message':_0x4189d4,'created_at':_0x5a8d75[_0x4ac982(0x1c1)],'updated_at':new Date()}},_0x18a571=await fetch(_0x21ade0[_0x4ac982(0x201)],{'method':_0x4ac982(0x1d8),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x4ac982(0x1ed)](_0x5efea0)}),_0xb60387=Date[_0x4ac982(0x19c)]()-_0x30a3de;console[_0x4ac982(0x1a3)](_0x4ac982(0x199)+_0x21ade0['webhookUrl']+_0x4ac982(0x1fe)+_0x18a571[_0x4ac982(0x196)]+'\x20('+_0xb60387+_0x4ac982(0x20b));}catch(_0x200d91){console[_0x4ac982(0x1b1)](_0x4ac982(0x1da),_0x200d91);}}async[a18_0x2fd386(0x1be)](_0x30d97c,_0x439637){const _0x43e5ff=a18_0x2fd386;try{const {telegramBotService:_0x2690b3}=await Promise[_0x43e5ff(0x198)]()[_0x43e5ff(0x1d3)](()=>__importStar(require(_0x43e5ff(0x1cf)))),_0x5e9674={'PAID':_0x43e5ff(0x206),'FAILED':_0x43e5ff(0x1ce)},_0x52f269=_0x5e9674[_0x439637];if(!_0x52f269)return;await _0x2690b3[_0x43e5ff(0x1e7)](_0x30d97c[_0x43e5ff(0x1c3)],_0x30d97c,_0x52f269);}catch(_0x3fdbd8){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3fdbd8);}}}exports[a18_0x2fd386(0x1c9)]=TestGatewayController;