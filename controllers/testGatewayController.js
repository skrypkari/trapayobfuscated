'use strict';const a15_0xacb810=a15_0x1154;(function(_0x56a5b8,_0x33e631){const _0x5a1ae4=a15_0x1154,_0x1776b7=_0x56a5b8();while(!![]){try{const _0x345f32=-parseInt(_0x5a1ae4(0x11f))/0x1+-parseInt(_0x5a1ae4(0xc4))/0x2*(parseInt(_0x5a1ae4(0xcb))/0x3)+parseInt(_0x5a1ae4(0x11c))/0x4+-parseInt(_0x5a1ae4(0xca))/0x5*(parseInt(_0x5a1ae4(0x105))/0x6)+parseInt(_0x5a1ae4(0xce))/0x7*(-parseInt(_0x5a1ae4(0xd6))/0x8)+-parseInt(_0x5a1ae4(0xe3))/0x9+parseInt(_0x5a1ae4(0xcc))/0xa;if(_0x345f32===_0x33e631)break;else _0x1776b7['push'](_0x1776b7['shift']());}catch(_0xf89209){_0x1776b7['push'](_0x1776b7['shift']());}}}(a15_0x1a39,0xab7d1));var __createBinding=this&&this[a15_0xacb810(0xc7)]||(Object[a15_0xacb810(0x124)]?function(_0x402b2f,_0x16507a,_0x18c491,_0x5d255f){const _0x338cfd=a15_0xacb810;if(_0x5d255f===undefined)_0x5d255f=_0x18c491;var _0x3f9a60=Object[_0x338cfd(0x107)](_0x16507a,_0x18c491);(!_0x3f9a60||(_0x338cfd(0xc6)in _0x3f9a60?!_0x16507a[_0x338cfd(0x122)]:_0x3f9a60[_0x338cfd(0xe5)]||_0x3f9a60[_0x338cfd(0x111)]))&&(_0x3f9a60={'enumerable':!![],'get':function(){return _0x16507a[_0x18c491];}}),Object['defineProperty'](_0x402b2f,_0x5d255f,_0x3f9a60);}:function(_0x4f453b,_0x1ee1f1,_0x138ce6,_0xbfc8bf){if(_0xbfc8bf===undefined)_0xbfc8bf=_0x138ce6;_0x4f453b[_0xbfc8bf]=_0x1ee1f1[_0x138ce6];}),__setModuleDefault=this&&this[a15_0xacb810(0x109)]||(Object[a15_0xacb810(0x124)]?function(_0x51568b,_0x69cb2){const _0x415595=a15_0xacb810;Object[_0x415595(0x117)](_0x51568b,_0x415595(0xf0),{'enumerable':!![],'value':_0x69cb2});}:function(_0x2a15ab,_0x55fcc5){const _0x2cccf3=a15_0xacb810;_0x2a15ab[_0x2cccf3(0xf0)]=_0x55fcc5;}),__importStar=this&&this[a15_0xacb810(0x118)]||(function(){var _0x11c79f=function(_0x3dc2d9){const _0x13e80e=a15_0x1154;return _0x11c79f=Object[_0x13e80e(0x139)]||function(_0x4a12ea){const _0x5b6d6c=_0x13e80e;var _0x33b7ca=[];for(var _0x7a5baa in _0x4a12ea)if(Object[_0x5b6d6c(0x100)][_0x5b6d6c(0xda)][_0x5b6d6c(0xef)](_0x4a12ea,_0x7a5baa))_0x33b7ca[_0x33b7ca['length']]=_0x7a5baa;return _0x33b7ca;},_0x11c79f(_0x3dc2d9);};return function(_0x51209b){const _0xd7736e=a15_0x1154;if(_0x51209b&&_0x51209b[_0xd7736e(0x122)])return _0x51209b;var _0x76bf75={};if(_0x51209b!=null){for(var _0x5948af=_0x11c79f(_0x51209b),_0x5df810=0x0;_0x5df810<_0x5948af['length'];_0x5df810++)if(_0x5948af[_0x5df810]!==_0xd7736e(0xf0))__createBinding(_0x76bf75,_0x51209b,_0x5948af[_0x5df810]);}return __setModuleDefault(_0x76bf75,_0x51209b),_0x76bf75;};}()),__importDefault=this&&this[a15_0xacb810(0xc5)]||function(_0x2b7f17){return _0x2b7f17&&_0x2b7f17['__esModule']?_0x2b7f17:{'default':_0x2b7f17};};function a15_0x1a39(){const _0x3d6f75=['settings','../services/gateways/testGatewayService','1044772cxLaRc','webhookService','Payment\x20status\x20is\x20','656481qIxReE','shopId',',\x20currentPayments=','__esModule','webhookEvents','create','\x20not\x20enabled\x20for\x20shop\x20','processCard','params','Any\x20name','shop',',\x20cannot\x20process','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4242\x204242\x204242\x204242','then','POST','gateway','customerEmail','payment.success','slice','$transaction','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','stringify','paymentLink','PAID','getOwnPropertyNames','processCardPayment','includes','status','Any\x20future\x20date\x20(MM/YY)','FAILED','📈\x20Found\x20payment\x20link\x20','4BZAaFe','__importDefault','get','__createBinding','toLowerCase','../config/database','5CTJdin','235446gVYCqU','33093640qIAUpA','\x20->\x20','2751wnubyf','Error\x20parsing\x20webhook\x20events:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20processed:\x20','transactionId','type','findUnique','paymentMethod','5384DlgVVb','toISOString','SINGLE','failUrl','hasOwnProperty','Payment\x20failed','Payment\x20processed\x20successfully','TestGatewayService','json','payment.failed','gatewayOrderId','currentPayments','body','12324528hySxVc','webhookLog','writable','✅\x20Test\x20Gateway\x20payment\x20','webhookUrl','PENDING','✅\x20Payment\x20link\x20','0000','📈\x20Test\x20Gateway:\x20Payment\x20','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20',',\x20status=','paidAt','call','default','Any\x20other\x20card\x20number','customerName','name','paid','\x20not\x20found','isArray','failureMessage','WebhookService','sendShopWebhook','cardNumber',':\x20type=','Payment\x20not\x20found','ms)','payment','now','prototype','log','replace','test_gateway','\x20with\x20status\x20','2524884eeXpWP','failureReason','getOwnPropertyDescriptor','gatewayPaymentId','__setModuleDefault','currency','update','Payment\x20System/1.0\x20(Test\x20Gateway)','error','successUrl','amount','sendPaymentNotification','configurable','TestGatewayController','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLinkId','test_gateway_','testGatewayService','defineProperty','__importStar','Payment\x20is\x20not\x20for\x20test\x20gateway'];a15_0x1a39=function(){return _0x3d6f75;};return a15_0x1a39();}function a15_0x1154(_0x243cb3,_0x4c082d){const _0x1a3921=a15_0x1a39();return a15_0x1154=function(_0x115402,_0x15d250){_0x115402=_0x115402-0xc4;let _0xad14f=_0x1a3921[_0x115402];return _0xad14f;},a15_0x1154(_0x243cb3,_0x4c082d);}Object[a15_0xacb810(0x117)](exports,'__esModule',{'value':!![]}),exports[a15_0xacb810(0x112)]=void 0x0;const testGatewayService_1=require(a15_0xacb810(0x11b)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a15_0xacb810(0xc9)));class TestGatewayController{constructor(){const _0x35507d=a15_0xacb810;this['getPaymentForm']=async(_0x3113b7,_0x380766,_0x29fc9c)=>{const _0x30e62f=a15_0x1154;try{const {paymentId:_0x358d38}=_0x3113b7[_0x30e62f(0x127)];console['log'](_0x30e62f(0xec)+_0x358d38);const _0x17284b=await database_1[_0x30e62f(0xf0)][_0x30e62f(0xfe)][_0x30e62f(0xd4)]({'where':{'id':_0x358d38},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x17284b)return _0x380766[_0x30e62f(0x13c)](0x194)[_0x30e62f(0xde)]({'success':![],'message':_0x30e62f(0xfc)});if(_0x17284b[_0x30e62f(0x12f)]!==_0x30e62f(0x103))return _0x380766[_0x30e62f(0x13c)](0x190)[_0x30e62f(0xde)]({'success':![],'message':_0x30e62f(0x119)});if(_0x17284b[_0x30e62f(0x13c)]!==_0x30e62f(0xe8))return _0x380766[_0x30e62f(0x13c)](0x190)['json']({'success':![],'message':_0x30e62f(0x11e)+_0x17284b[_0x30e62f(0x13c)]+_0x30e62f(0x12a)});_0x380766[_0x30e62f(0xde)]({'success':!![],'result':{'paymentId':_0x17284b['id'],'orderId':_0x17284b[_0x30e62f(0xe0)],'amount':_0x17284b[_0x30e62f(0x10f)],'currency':_0x17284b[_0x30e62f(0x10a)],'merchantName':_0x17284b[_0x30e62f(0x129)][_0x30e62f(0xf3)],'description':'Payment\x20to\x20'+_0x17284b[_0x30e62f(0x129)][_0x30e62f(0xf3)],'testInstructions':{'successCard':_0x30e62f(0x12c),'failureCard':_0x30e62f(0xf1),'expiryDate':_0x30e62f(0x13d),'cvc':'Any\x203-4\x20digits','holderName':_0x30e62f(0x128)}}});}catch(_0x3d6540){_0x29fc9c(_0x3d6540);}},this[_0x35507d(0x126)]=async(_0x4f71ef,_0x4cc95f,_0x3dbfc2)=>{const _0x34b5fc=_0x35507d;try{const {paymentId:_0x3a1878}=_0x4f71ef[_0x34b5fc(0x127)],_0x35b76e=_0x4f71ef[_0x34b5fc(0xe2)];console[_0x34b5fc(0x101)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3a1878);const _0x501894=await database_1['default'][_0x34b5fc(0xfe)][_0x34b5fc(0xd4)]({'where':{'id':_0x3a1878},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x501894)return _0x4cc95f[_0x34b5fc(0x13c)](0x194)['json']({'success':![],'message':_0x34b5fc(0xfc)});if(_0x501894[_0x34b5fc(0x12f)]!==_0x34b5fc(0x103))return _0x4cc95f[_0x34b5fc(0x13c)](0x190)[_0x34b5fc(0xde)]({'success':![],'message':_0x34b5fc(0x119)});if(_0x501894[_0x34b5fc(0x13c)]!==_0x34b5fc(0xe8))return _0x4cc95f[_0x34b5fc(0x13c)](0x190)['json']({'success':![],'message':_0x34b5fc(0x11e)+_0x501894[_0x34b5fc(0x13c)]+_0x34b5fc(0x12a)});const _0x46fa34=await this[_0x34b5fc(0x116)][_0x34b5fc(0x13a)]({'paymentId':_0x501894['id'],'orderId':_0x501894[_0x34b5fc(0xe0)]||_0x501894['id'],'amount':_0x501894[_0x34b5fc(0x10f)],'currency':_0x501894['currency'],'cardData':_0x35b76e});console[_0x34b5fc(0x101)]('🧪\x20Test\x20Gateway\x20result:',_0x46fa34);const _0x324282={'status':_0x46fa34['status'],'updatedAt':new Date()};if(_0x46fa34[_0x34b5fc(0x13c)]===_0x34b5fc(0x138))_0x324282[_0x34b5fc(0xee)]=new Date(),_0x324282[_0x34b5fc(0x108)]=_0x46fa34[_0x34b5fc(0xd2)];else _0x46fa34[_0x34b5fc(0x13c)]===_0x34b5fc(0x13e)&&(_0x324282[_0x34b5fc(0xf7)]=_0x46fa34['failureReason']);const _0x40d288=_0x35b76e[_0x34b5fc(0xfa)][_0x34b5fc(0x102)](/[\s-]/g,'');_0x324282['cardLast4']=_0x40d288[_0x34b5fc(0x132)](-0x4),_0x324282[_0x34b5fc(0xd5)]='test_card',await database_1[_0x34b5fc(0xf0)]['payment'][_0x34b5fc(0x10b)]({'where':{'id':_0x501894['id']},'data':_0x324282});if(_0x46fa34['status']===_0x34b5fc(0x138)&&_0x501894[_0x34b5fc(0x114)]){console[_0x34b5fc(0x101)](_0x34b5fc(0xeb)+_0x501894['id']+_0x34b5fc(0x135));try{await database_1['default'][_0x34b5fc(0x133)](async _0x5e0eda=>{const _0x46fd13=_0x34b5fc,_0x1e74f6=await _0x5e0eda[_0x46fd13(0x137)][_0x46fd13(0xd4)]({'where':{'id':_0x501894[_0x46fd13(0x114)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1e74f6){console['log'](_0x46fd13(0x13f)+_0x1e74f6['id']+_0x46fd13(0xfb)+_0x1e74f6['type']+_0x46fd13(0x121)+_0x1e74f6[_0x46fd13(0xe1)]+',\x20status='+_0x1e74f6[_0x46fd13(0x13c)]);const _0x5e33b2=_0x1e74f6['currentPayments']+0x1,_0x24d5e=_0x1e74f6[_0x46fd13(0xd3)]===_0x46fd13(0xd8)?'COMPLETED':_0x1e74f6[_0x46fd13(0x13c)];await _0x5e0eda[_0x46fd13(0x137)][_0x46fd13(0x10b)]({'where':{'id':_0x501894[_0x46fd13(0x114)]},'data':{'currentPayments':_0x5e33b2,'status':_0x24d5e,'updatedAt':new Date()}}),console[_0x46fd13(0x101)](_0x46fd13(0xe9)+_0x1e74f6['id']+'\x20updated:\x20currentPayments='+_0x1e74f6[_0x46fd13(0xe1)]+_0x46fd13(0xcd)+_0x5e33b2+_0x46fd13(0xed)+_0x1e74f6['status']+_0x46fd13(0xcd)+_0x24d5e);}else console[_0x46fd13(0x101)]('❌\x20Payment\x20link\x20'+_0x501894[_0x46fd13(0x114)]+_0x46fd13(0xf5));});}catch(_0x55a45c){console[_0x34b5fc(0x10d)](_0x34b5fc(0x134),_0x55a45c);}}await database_1[_0x34b5fc(0xf0)][_0x34b5fc(0xe4)]['create']({'data':{'paymentId':_0x501894['id'],'shopId':_0x501894['shopId'],'event':_0x34b5fc(0x115)+_0x46fa34[_0x34b5fc(0x13c)][_0x34b5fc(0xc8)](),'statusCode':0xc8,'responseBody':JSON[_0x34b5fc(0x136)]({'oldStatus':_0x34b5fc(0xe8),'newStatus':_0x46fa34[_0x34b5fc(0x13c)],'transactionId':_0x46fa34[_0x34b5fc(0xd2)],'failureReason':_0x46fa34[_0x34b5fc(0x106)],'processedAt':new Date()[_0x34b5fc(0xd7)]()})}}),await this[_0x34b5fc(0xf9)](_0x501894,_0x46fa34[_0x34b5fc(0x13c)],_0x46fa34[_0x34b5fc(0xd2)],_0x46fa34[_0x34b5fc(0x106)]),await this['sendPaymentStatusNotification'](_0x501894,_0x46fa34[_0x34b5fc(0x13c)]),console[_0x34b5fc(0x101)](_0x34b5fc(0xe6)+_0x3a1878+_0x34b5fc(0xd1)+_0x46fa34[_0x34b5fc(0x13c)]),_0x46fa34['status']==='PAID'?_0x4cc95f['json']({'success':!![],'message':_0x34b5fc(0xdc),'result':{'status':'PAID','transactionId':_0x46fa34[_0x34b5fc(0xd2)],'redirectUrl':_0x501894[_0x34b5fc(0x10e)]}}):_0x4cc95f[_0x34b5fc(0x13c)](0x190)[_0x34b5fc(0xde)]({'success':![],'message':_0x34b5fc(0xdb),'result':{'status':_0x34b5fc(0x13e),'failureReason':_0x46fa34[_0x34b5fc(0x106)],'redirectUrl':_0x501894[_0x34b5fc(0xd9)]}});}catch(_0xb0eb41){_0x3dbfc2(_0xb0eb41);}},this[_0x35507d(0x116)]=new testGatewayService_1[(_0x35507d(0xdd))](),this[_0x35507d(0x11d)]=new webhookService_1[(_0x35507d(0xf8))]();}async['sendShopWebhook'](_0x1a188d,_0x16802e,_0x387fc2,_0x1ba3a1){const _0x293403=a15_0xacb810,_0x11addb=Date[_0x293403(0xff)]();try{const _0x2578a0=_0x1a188d['shop'],_0x3878e3=_0x2578a0[_0x293403(0x11a)];if(!_0x3878e3?.[_0x293403(0xe7)]){console['log'](_0x293403(0xd0)+_0x2578a0['id']);return;}const _0x3bac8f=_0x16802e==='PAID'?_0x293403(0x131):_0x293403(0xdf);let _0x326dc1=[];if(_0x3878e3['webhookEvents'])try{_0x326dc1=Array[_0x293403(0xf6)](_0x3878e3['webhookEvents'])?_0x3878e3['webhookEvents']:JSON['parse'](_0x3878e3[_0x293403(0x123)]);}catch(_0x392111){console[_0x293403(0x10d)](_0x293403(0xcf),_0x392111),_0x326dc1=[];}if(!_0x326dc1[_0x293403(0x13b)](_0x3bac8f)){console['log']('Webhook\x20event\x20'+_0x3bac8f+_0x293403(0x125)+_0x2578a0['id']);return;}const _0x35ddd5={'event':_0x3bac8f,'payment':{'id':_0x1a188d['id'],'order_id':_0x1a188d['orderId'],'gateway_order_id':_0x1a188d['gatewayOrderId'],'gateway':_0x293403(0xea),'amount':_0x1a188d[_0x293403(0x10f)],'currency':_0x1a188d[_0x293403(0x10a)],'status':_0x16802e[_0x293403(0xc8)](),'customer_email':_0x1a188d[_0x293403(0x130)],'customer_name':_0x1a188d[_0x293403(0xf2)],'transaction_id':_0x387fc2,'failure_message':_0x1ba3a1,'created_at':_0x1a188d['createdAt'],'updated_at':new Date()}},_0x36f5cc=await fetch(_0x3878e3[_0x293403(0xe7)],{'method':_0x293403(0x12e),'headers':{'Content-Type':'application/json','User-Agent':_0x293403(0x10c)},'body':JSON[_0x293403(0x136)](_0x35ddd5)}),_0x59a003=Date[_0x293403(0xff)]()-_0x11addb;console[_0x293403(0x101)](_0x293403(0x113)+_0x3878e3['webhookUrl']+_0x293403(0x104)+_0x36f5cc[_0x293403(0x13c)]+'\x20('+_0x59a003+_0x293403(0xfd));}catch(_0x54d8b8){console[_0x293403(0x10d)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x54d8b8);}}async['sendPaymentStatusNotification'](_0x20e361,_0x554598){const _0x41ab6e=a15_0xacb810;try{const {telegramBotService:_0x3db9c5}=await Promise['resolve']()[_0x41ab6e(0x12d)](()=>__importStar(require('../services/telegramBotService'))),_0x9b19d8={'PAID':_0x41ab6e(0xf4),'FAILED':'failed'},_0x3ecd7a=_0x9b19d8[_0x554598];if(!_0x3ecd7a)return;await _0x3db9c5[_0x41ab6e(0x110)](_0x20e361[_0x41ab6e(0x120)],_0x20e361,_0x3ecd7a);}catch(_0x2bbb94){console[_0x41ab6e(0x10d)](_0x41ab6e(0x12b),_0x2bbb94);}}}exports[a15_0xacb810(0x112)]=TestGatewayController;