'use strict';function a13_0x16b5(){const _0x40d02d=['failed','json','4530130ajKNtq','isArray','webhookUrl',',\x20cannot\x20process','defineProperty','shopId','2NfVtcE','âœ…\x20Test\x20Gateway\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','call','processCardPayment','2474925fprRqe','toISOString','failUrl','3976488RcXeyV','test_gateway','currency','update','sendShopWebhook','__createBinding','length','hasOwnProperty','4807040mIXBcQ','test_gateway_','processCard','createdAt','cardNumber','toLowerCase','sendPaymentStatusNotification','webhookService','Any\x203-4\x20digits','resolve','settings','amount','default','\x20processed:\x20','__esModule','payment.success','testGatewayService','transactionId','paymentMethod','4242\x204242\x204242\x204242','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','prototype','Payment\x20is\x20not\x20for\x20test\x20gateway','now','writable','get','Payment\x20not\x20found','orderId','14514228oWmbDo','\x20not\x20enabled\x20for\x20shop\x20','Any\x20future\x20date\x20(MM/YY)','paid','617748RdRkAx','Error\x20parsing\x20webhook\x20events:','Webhook\x20event\x20','then','Payment\x20to\x20','failureReason','ms)','Any\x20name','getOwnPropertyDescriptor','paidAt','shop','WebhookService','payment.failed','configurable','webhookEvents','POST','Payment\x20processed\x20successfully','parse','Payment\x20status\x20is\x20','__setModuleDefault','failureMessage','params','\x20with\x20status\x20','../services/gateways/testGatewayService','sendPaymentNotification','getOwnPropertyNames','ðŸ§ª\x20Test\x20Gateway\x20result:','../services/webhookService','log','stringify','42vjRcto','34691HWWiJQ','name','PENDING','findUnique','TestGatewayController','gateway','status','error','PAID','customerEmail','payment','replace','create','Test\x20Gateway\x20webhook\x20sent\x20to\x20','body','gatewayOrderId'];a13_0x16b5=function(){return _0x40d02d;};return a13_0x16b5();}const a13_0x5d241e=a13_0x1e8f;(function(_0x756432,_0x1dac7e){const _0xfca356=a13_0x1e8f,_0x2aeee3=_0x756432();while(!![]){try{const _0x29b1c8=parseInt(_0xfca356(0x20c))/0x1*(parseInt(_0xfca356(0x1bd))/0x2)+parseInt(_0xfca356(0x1c2))/0x3+-parseInt(_0xfca356(0x1c5))/0x4+-parseInt(_0xfca356(0x1b7))/0x5+parseInt(_0xfca356(0x1ed))/0x6*(-parseInt(_0xfca356(0x20b))/0x7)+parseInt(_0xfca356(0x1cd))/0x8+parseInt(_0xfca356(0x1e9))/0x9;if(_0x29b1c8===_0x1dac7e)break;else _0x2aeee3['push'](_0x2aeee3['shift']());}catch(_0x4bc637){_0x2aeee3['push'](_0x2aeee3['shift']());}}}(a13_0x16b5,0x8794e));function a13_0x1e8f(_0x4059d4,_0x4f7699){const _0x16b57f=a13_0x16b5();return a13_0x1e8f=function(_0x1e8f82,_0x1284d6){_0x1e8f82=_0x1e8f82-0x1a7;let _0x51baaa=_0x16b57f[_0x1e8f82];return _0x51baaa;},a13_0x1e8f(_0x4059d4,_0x4f7699);}var __createBinding=this&&this[a13_0x5d241e(0x1ca)]||(Object[a13_0x5d241e(0x1b1)]?function(_0x1cdb1d,_0xc47a70,_0xc7f514,_0x28e9e6){const _0xa9ac06=a13_0x5d241e;if(_0x28e9e6===undefined)_0x28e9e6=_0xc7f514;var _0x3d3590=Object[_0xa9ac06(0x1f5)](_0xc47a70,_0xc7f514);(!_0x3d3590||(_0xa9ac06(0x1e6)in _0x3d3590?!_0xc47a70[_0xa9ac06(0x1db)]:_0x3d3590[_0xa9ac06(0x1e5)]||_0x3d3590[_0xa9ac06(0x1fa)]))&&(_0x3d3590={'enumerable':!![],'get':function(){return _0xc47a70[_0xc7f514];}}),Object['defineProperty'](_0x1cdb1d,_0x28e9e6,_0x3d3590);}:function(_0x1e9043,_0x3fe101,_0x533154,_0x301113){if(_0x301113===undefined)_0x301113=_0x533154;_0x1e9043[_0x301113]=_0x3fe101[_0x533154];}),__setModuleDefault=this&&this[a13_0x5d241e(0x200)]||(Object['create']?function(_0x5f2d6c,_0x3ad812){const _0x1bb28c=a13_0x5d241e;Object[_0x1bb28c(0x1bb)](_0x5f2d6c,'default',{'enumerable':!![],'value':_0x3ad812});}:function(_0x2aa0a6,_0x5bcf70){_0x2aa0a6['default']=_0x5bcf70;}),__importStar=this&&this['__importStar']||(function(){var _0x282ed2=function(_0xfa66f1){const _0x3b51ce=a13_0x1e8f;return _0x282ed2=Object[_0x3b51ce(0x206)]||function(_0x991e49){const _0x25dfb0=_0x3b51ce;var _0x2c23d3=[];for(var _0x16f2e1 in _0x991e49)if(Object[_0x25dfb0(0x1e2)][_0x25dfb0(0x1cc)][_0x25dfb0(0x1c0)](_0x991e49,_0x16f2e1))_0x2c23d3[_0x2c23d3[_0x25dfb0(0x1cb)]]=_0x16f2e1;return _0x2c23d3;},_0x282ed2(_0xfa66f1);};return function(_0x8d74cd){const _0xba0d9e=a13_0x1e8f;if(_0x8d74cd&&_0x8d74cd[_0xba0d9e(0x1db)])return _0x8d74cd;var _0x354238={};if(_0x8d74cd!=null){for(var _0x2a0020=_0x282ed2(_0x8d74cd),_0x200874=0x0;_0x200874<_0x2a0020[_0xba0d9e(0x1cb)];_0x200874++)if(_0x2a0020[_0x200874]!=='default')__createBinding(_0x354238,_0x8d74cd,_0x2a0020[_0x200874]);}return __setModuleDefault(_0x354238,_0x8d74cd),_0x354238;};}()),__importDefault=this&&this['__importDefault']||function(_0xa9012e){const _0x3e219=a13_0x5d241e;return _0xa9012e&&_0xa9012e[_0x3e219(0x1db)]?_0xa9012e:{'default':_0xa9012e};};Object[a13_0x5d241e(0x1bb)](exports,a13_0x5d241e(0x1db),{'value':!![]}),exports[a13_0x5d241e(0x1a9)]=void 0x0;const testGatewayService_1=require(a13_0x5d241e(0x204)),webhookService_1=require(a13_0x5d241e(0x208)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x3306e6=a13_0x5d241e;this['getPaymentForm']=async(_0x2264c8,_0x4c89ad,_0x4175e6)=>{const _0x46237b=a13_0x1e8f;try{const {paymentId:_0xcbad46}=_0x2264c8[_0x46237b(0x202)];console[_0x46237b(0x209)](_0x46237b(0x1e1)+_0xcbad46);const _0x3cf701=await database_1[_0x46237b(0x1d9)][_0x46237b(0x1af)][_0x46237b(0x1a8)]({'where':{'id':_0xcbad46},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3cf701)return _0x4c89ad[_0x46237b(0x1ab)](0x194)[_0x46237b(0x1b6)]({'success':![],'message':_0x46237b(0x1e7)});if(_0x3cf701[_0x46237b(0x1aa)]!==_0x46237b(0x1c6))return _0x4c89ad[_0x46237b(0x1ab)](0x190)[_0x46237b(0x1b6)]({'success':![],'message':_0x46237b(0x1e3)});if(_0x3cf701[_0x46237b(0x1ab)]!=='PENDING')return _0x4c89ad[_0x46237b(0x1ab)](0x190)['json']({'success':![],'message':_0x46237b(0x1ff)+_0x3cf701[_0x46237b(0x1ab)]+_0x46237b(0x1ba)});_0x4c89ad['json']({'success':!![],'result':{'paymentId':_0x3cf701['id'],'orderId':_0x3cf701[_0x46237b(0x1b4)],'amount':_0x3cf701[_0x46237b(0x1d8)],'currency':_0x3cf701[_0x46237b(0x1c7)],'merchantName':_0x3cf701[_0x46237b(0x1f7)][_0x46237b(0x20d)],'description':_0x46237b(0x1f1)+_0x3cf701[_0x46237b(0x1f7)][_0x46237b(0x20d)],'testInstructions':{'successCard':_0x46237b(0x1e0),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x46237b(0x1eb),'cvc':_0x46237b(0x1d5),'holderName':_0x46237b(0x1f4)}}});}catch(_0x551278){_0x4175e6(_0x551278);}},this[_0x3306e6(0x1cf)]=async(_0x48d13f,_0x57dabc,_0x30bf90)=>{const _0x17136b=_0x3306e6;try{const {paymentId:_0x4d1dcd}=_0x48d13f[_0x17136b(0x202)],_0x452cc5=_0x48d13f[_0x17136b(0x1b3)];console[_0x17136b(0x209)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4d1dcd);const _0x181466=await database_1[_0x17136b(0x1d9)][_0x17136b(0x1af)][_0x17136b(0x1a8)]({'where':{'id':_0x4d1dcd},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x181466)return _0x57dabc[_0x17136b(0x1ab)](0x194)[_0x17136b(0x1b6)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x181466['gateway']!==_0x17136b(0x1c6))return _0x57dabc[_0x17136b(0x1ab)](0x190)[_0x17136b(0x1b6)]({'success':![],'message':_0x17136b(0x1e3)});if(_0x181466['status']!==_0x17136b(0x1a7))return _0x57dabc[_0x17136b(0x1ab)](0x190)[_0x17136b(0x1b6)]({'success':![],'message':_0x17136b(0x1ff)+_0x181466[_0x17136b(0x1ab)]+_0x17136b(0x1ba)});const _0xf2d8ce=await this['testGatewayService'][_0x17136b(0x1c1)]({'paymentId':_0x181466['id'],'orderId':_0x181466[_0x17136b(0x1b4)]||_0x181466['id'],'amount':_0x181466[_0x17136b(0x1d8)],'currency':_0x181466[_0x17136b(0x1c7)],'cardData':_0x452cc5});console[_0x17136b(0x209)](_0x17136b(0x207),_0xf2d8ce);const _0x48aa74={'status':_0xf2d8ce['status'],'updatedAt':new Date()};if(_0xf2d8ce[_0x17136b(0x1ab)]===_0x17136b(0x1ad))_0x48aa74[_0x17136b(0x1f6)]=new Date(),_0x48aa74['gatewayPaymentId']=_0xf2d8ce[_0x17136b(0x1de)];else _0xf2d8ce[_0x17136b(0x1ab)]==='FAILED'&&(_0x48aa74[_0x17136b(0x201)]=_0xf2d8ce[_0x17136b(0x1f2)]);const _0x49d667=_0x452cc5[_0x17136b(0x1d1)][_0x17136b(0x1b0)](/[\s-]/g,'');_0x48aa74['cardLast4']=_0x49d667['slice'](-0x4),_0x48aa74[_0x17136b(0x1df)]='test_card',await database_1['default']['payment'][_0x17136b(0x1c8)]({'where':{'id':_0x181466['id']},'data':_0x48aa74}),await database_1['default']['webhookLog'][_0x17136b(0x1b1)]({'data':{'paymentId':_0x181466['id'],'shopId':_0x181466[_0x17136b(0x1bc)],'event':_0x17136b(0x1ce)+_0xf2d8ce[_0x17136b(0x1ab)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x17136b(0x20a)]({'oldStatus':'PENDING','newStatus':_0xf2d8ce[_0x17136b(0x1ab)],'transactionId':_0xf2d8ce[_0x17136b(0x1de)],'failureReason':_0xf2d8ce[_0x17136b(0x1f2)],'processedAt':new Date()[_0x17136b(0x1c3)]()})}}),await this[_0x17136b(0x1c9)](_0x181466,_0xf2d8ce[_0x17136b(0x1ab)],_0xf2d8ce[_0x17136b(0x1de)],_0xf2d8ce[_0x17136b(0x1f2)]),await this[_0x17136b(0x1d3)](_0x181466,_0xf2d8ce[_0x17136b(0x1ab)]),console['log'](_0x17136b(0x1be)+_0x4d1dcd+_0x17136b(0x1da)+_0xf2d8ce[_0x17136b(0x1ab)]),_0xf2d8ce[_0x17136b(0x1ab)]===_0x17136b(0x1ad)?_0x57dabc[_0x17136b(0x1b6)]({'success':!![],'message':_0x17136b(0x1fd),'result':{'status':'PAID','transactionId':_0xf2d8ce[_0x17136b(0x1de)],'redirectUrl':_0x181466['successUrl']}}):_0x57dabc[_0x17136b(0x1ab)](0x190)[_0x17136b(0x1b6)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0xf2d8ce[_0x17136b(0x1f2)],'redirectUrl':_0x181466[_0x17136b(0x1c4)]}});}catch(_0x3f71e1){_0x30bf90(_0x3f71e1);}},this[_0x3306e6(0x1dd)]=new testGatewayService_1['TestGatewayService'](),this[_0x3306e6(0x1d4)]=new webhookService_1[(_0x3306e6(0x1f8))]();}async['sendShopWebhook'](_0x27fc0e,_0x3bc8a1,_0x2e06a8,_0x418166){const _0x44a9bf=a13_0x5d241e,_0x22fbc0=Date[_0x44a9bf(0x1e4)]();try{const _0x56fa53=_0x27fc0e[_0x44a9bf(0x1f7)],_0x50e165=_0x56fa53[_0x44a9bf(0x1d7)];if(!_0x50e165?.[_0x44a9bf(0x1b9)]){console['log'](_0x44a9bf(0x1bf)+_0x56fa53['id']);return;}const _0x369d47=_0x3bc8a1==='PAID'?_0x44a9bf(0x1dc):_0x44a9bf(0x1f9);let _0xf73dd9=[];if(_0x50e165[_0x44a9bf(0x1fb)])try{_0xf73dd9=Array[_0x44a9bf(0x1b8)](_0x50e165[_0x44a9bf(0x1fb)])?_0x50e165['webhookEvents']:JSON[_0x44a9bf(0x1fe)](_0x50e165['webhookEvents']);}catch(_0x4470eb){console[_0x44a9bf(0x1ac)](_0x44a9bf(0x1ee),_0x4470eb),_0xf73dd9=[];}if(!_0xf73dd9['includes'](_0x369d47)){console['log'](_0x44a9bf(0x1ef)+_0x369d47+_0x44a9bf(0x1ea)+_0x56fa53['id']);return;}const _0x25ac78={'event':_0x369d47,'payment':{'id':_0x27fc0e['id'],'order_id':_0x27fc0e[_0x44a9bf(0x1e8)],'gateway_order_id':_0x27fc0e['gatewayOrderId'],'gateway':'0000','amount':_0x27fc0e['amount'],'currency':_0x27fc0e[_0x44a9bf(0x1c7)],'status':_0x3bc8a1[_0x44a9bf(0x1d2)](),'customer_email':_0x27fc0e[_0x44a9bf(0x1ae)],'customer_name':_0x27fc0e['customerName'],'transaction_id':_0x2e06a8,'failure_message':_0x418166,'created_at':_0x27fc0e[_0x44a9bf(0x1d0)],'updated_at':new Date()}},_0x3a0516=await fetch(_0x50e165[_0x44a9bf(0x1b9)],{'method':_0x44a9bf(0x1fc),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x44a9bf(0x20a)](_0x25ac78)}),_0x3c643c=Date['now']()-_0x22fbc0;console[_0x44a9bf(0x209)](_0x44a9bf(0x1b2)+_0x50e165['webhookUrl']+_0x44a9bf(0x203)+_0x3a0516[_0x44a9bf(0x1ab)]+'\x20('+_0x3c643c+_0x44a9bf(0x1f3));}catch(_0x483781){console[_0x44a9bf(0x1ac)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x483781);}}async[a13_0x5d241e(0x1d3)](_0x12c192,_0x4dfcd7){const _0x1519d9=a13_0x5d241e;try{const {telegramBotService:_0x229d2a}=await Promise[_0x1519d9(0x1d6)]()[_0x1519d9(0x1f0)](()=>__importStar(require('../services/telegramBotService'))),_0x31fdf7={'PAID':_0x1519d9(0x1ec),'FAILED':_0x1519d9(0x1b5)},_0x2b3bcd=_0x31fdf7[_0x4dfcd7];if(!_0x2b3bcd)return;await _0x229d2a[_0x1519d9(0x205)](_0x12c192[_0x1519d9(0x1bc)],_0x12c192,_0x2b3bcd);}catch(_0xecdff7){console[_0x1519d9(0x1ac)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xecdff7);}}}exports[a13_0x5d241e(0x1a9)]=TestGatewayController;