'use strict';function a13_0x58af(_0x37b683,_0x5e2103){const _0x923497=a13_0x9234();return a13_0x58af=function(_0x58afe8,_0x30be43){_0x58afe8=_0x58afe8-0x1de;let _0x1ef1be=_0x923497[_0x58afe8];return _0x1ef1be;},a13_0x58af(_0x37b683,_0x5e2103);}function a13_0x9234(){const _0x1aa95e=['isArray','webhookEvents','webhookService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','91856apEvwO','sendPaymentNotification','replace','get','ðŸ§ª\x20Test\x20Gateway\x20result:','orderId','Payment\x20status\x20is\x20','TestGatewayService','failureReason','defineProperty','Any\x20name','PAID','call','failUrl','__esModule','currency','prototype','Payment\x20processed\x20successfully','__createBinding','0000','ms)','test_card','parse','Test\x20Gateway\x20webhook\x20sent\x20to\x20','258222iDtQbR','length','../services/gateways/testGatewayService','paidAt','paid','\x20processed:\x20','WebhookService','error','name','now','Any\x20other\x20card\x20number','4771840MgeAeY','update','\x20not\x20enabled\x20for\x20shop\x20','16qMvamb','cardLast4','shopId','Error\x20parsing\x20webhook\x20events:','gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookUrl','914040kvgKGF','sendPaymentStatusNotification','toLowerCase','PENDING','__importStar','successUrl','includes','gatewayOrderId','createdAt','__importDefault','Webhook\x20event\x20','FAILED','testGatewayService','TestGatewayController','body','failed','application/json','Any\x203-4\x20digits','843683EqiEfu','Payment\x20failed','writable','json','Payment\x20is\x20not\x20for\x20test\x20gateway','stringify','customerEmail','params','../services/telegramBotService','processCardPayment',',\x20cannot\x20process','transactionId','settings','7ZJVhgr','sendShopWebhook','default','âœ…\x20Test\x20Gateway\x20payment\x20','processCard','135126QkknKQ','status','getPaymentForm','failureMessage','toISOString','log','1231392QOXFTU','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20with\x20status\x20','amount','create','shop','findUnique','getOwnPropertyNames','Payment\x20not\x20found','webhookLog','cardNumber'];a13_0x9234=function(){return _0x1aa95e;};return a13_0x9234();}const a13_0x5bfe09=a13_0x58af;(function(_0x8c4d76,_0x28a1b5){const _0x2b992a=a13_0x58af,_0x102739=_0x8c4d76();while(!![]){try{const _0x13a8ea=-parseInt(_0x2b992a(0x1e5))/0x1+-parseInt(_0x2b992a(0x20c))/0x2+parseInt(_0x2b992a(0x239))/0x3+parseInt(_0x2b992a(0x1fd))/0x4+parseInt(_0x2b992a(0x22f))/0x5+parseInt(_0x2b992a(0x224))/0x6*(-parseInt(_0x2b992a(0x1f2))/0x7)+-parseInt(_0x2b992a(0x232))/0x8*(parseInt(_0x2b992a(0x1f7))/0x9);if(_0x13a8ea===_0x28a1b5)break;else _0x102739['push'](_0x102739['shift']());}catch(_0x47c29b){_0x102739['push'](_0x102739['shift']());}}}(a13_0x9234,0x9383c));var __createBinding=this&&this[a13_0x5bfe09(0x21e)]||(Object['create']?function(_0x3bf6e2,_0x5d890a,_0x401c83,_0xaa1d4b){const _0x4c7a00=a13_0x5bfe09;if(_0xaa1d4b===undefined)_0xaa1d4b=_0x401c83;var _0x3d0ac7=Object['getOwnPropertyDescriptor'](_0x5d890a,_0x401c83);(!_0x3d0ac7||(_0x4c7a00(0x20f)in _0x3d0ac7?!_0x5d890a['__esModule']:_0x3d0ac7[_0x4c7a00(0x1e7)]||_0x3d0ac7['configurable']))&&(_0x3d0ac7={'enumerable':!![],'get':function(){return _0x5d890a[_0x401c83];}}),Object['defineProperty'](_0x3bf6e2,_0xaa1d4b,_0x3d0ac7);}:function(_0x3ed5ac,_0xc3532a,_0x4ead35,_0x4a6616){if(_0x4a6616===undefined)_0x4a6616=_0x4ead35;_0x3ed5ac[_0x4a6616]=_0xc3532a[_0x4ead35];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x5bfe09(0x201)]?function(_0x578cce,_0x5c736e){const _0x46b384=a13_0x5bfe09;Object[_0x46b384(0x215)](_0x578cce,_0x46b384(0x1f4),{'enumerable':!![],'value':_0x5c736e});}:function(_0x552f5f,_0x479c08){const _0x316a49=a13_0x5bfe09;_0x552f5f[_0x316a49(0x1f4)]=_0x479c08;}),__importStar=this&&this[a13_0x5bfe09(0x23d)]||(function(){var _0xb2302a=function(_0x2d87c2){const _0x2bc167=a13_0x58af;return _0xb2302a=Object[_0x2bc167(0x204)]||function(_0x4cf981){const _0x3176ce=_0x2bc167;var _0x143189=[];for(var _0x2b6262 in _0x4cf981)if(Object[_0x3176ce(0x21c)]['hasOwnProperty'][_0x3176ce(0x218)](_0x4cf981,_0x2b6262))_0x143189[_0x143189[_0x3176ce(0x225)]]=_0x2b6262;return _0x143189;},_0xb2302a(_0x2d87c2);};return function(_0x76526b){if(_0x76526b&&_0x76526b['__esModule'])return _0x76526b;var _0x2bf581={};if(_0x76526b!=null){for(var _0x180ffa=_0xb2302a(_0x76526b),_0x3de655=0x0;_0x3de655<_0x180ffa['length'];_0x3de655++)if(_0x180ffa[_0x3de655]!=='default')__createBinding(_0x2bf581,_0x76526b,_0x180ffa[_0x3de655]);}return __setModuleDefault(_0x2bf581,_0x76526b),_0x2bf581;};}()),__importDefault=this&&this[a13_0x5bfe09(0x242)]||function(_0x3c9ab1){const _0x19f421=a13_0x5bfe09;return _0x3c9ab1&&_0x3c9ab1[_0x19f421(0x21a)]?_0x3c9ab1:{'default':_0x3c9ab1};};Object[a13_0x5bfe09(0x215)](exports,a13_0x5bfe09(0x21a),{'value':!![]}),exports[a13_0x5bfe09(0x1e0)]=void 0x0;const testGatewayService_1=require(a13_0x5bfe09(0x226)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x539887=a13_0x5bfe09;this[_0x539887(0x1f9)]=async(_0x26733b,_0x20022c,_0x3be664)=>{const _0x28bead=_0x539887;try{const {paymentId:_0x33fdee}=_0x26733b[_0x28bead(0x1ec)];console[_0x28bead(0x1fc)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x33fdee);const _0x1684dd=await database_1[_0x28bead(0x1f4)]['payment'][_0x28bead(0x203)]({'where':{'id':_0x33fdee},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1684dd)return _0x20022c[_0x28bead(0x1f8)](0x194)[_0x28bead(0x1e8)]({'success':![],'message':_0x28bead(0x205)});if(_0x1684dd[_0x28bead(0x236)]!=='test_gateway')return _0x20022c[_0x28bead(0x1f8)](0x190)[_0x28bead(0x1e8)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x1684dd[_0x28bead(0x1f8)]!==_0x28bead(0x23c))return _0x20022c[_0x28bead(0x1f8)](0x190)[_0x28bead(0x1e8)]({'success':![],'message':_0x28bead(0x212)+_0x1684dd[_0x28bead(0x1f8)]+_0x28bead(0x1ef)});_0x20022c[_0x28bead(0x1e8)]({'success':!![],'result':{'paymentId':_0x1684dd['id'],'orderId':_0x1684dd[_0x28bead(0x240)],'amount':_0x1684dd[_0x28bead(0x200)],'currency':_0x1684dd[_0x28bead(0x21b)],'merchantName':_0x1684dd[_0x28bead(0x202)][_0x28bead(0x22c)],'description':'Payment\x20to\x20'+_0x1684dd[_0x28bead(0x202)][_0x28bead(0x22c)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x28bead(0x22e),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x28bead(0x1e4),'holderName':_0x28bead(0x216)}}});}catch(_0x57fb80){_0x3be664(_0x57fb80);}},this[_0x539887(0x1f6)]=async(_0x29abb9,_0x13057a,_0x27cfb4)=>{const _0x4c4de6=_0x539887;try{const {paymentId:_0x216aea}=_0x29abb9[_0x4c4de6(0x1ec)],_0x4ea43b=_0x29abb9[_0x4c4de6(0x1e1)];console[_0x4c4de6(0x1fc)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x216aea);const _0xd9bac7=await database_1['default']['payment'][_0x4c4de6(0x203)]({'where':{'id':_0x216aea},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xd9bac7)return _0x13057a['status'](0x194)['json']({'success':![],'message':_0x4c4de6(0x205)});if(_0xd9bac7[_0x4c4de6(0x236)]!=='test_gateway')return _0x13057a[_0x4c4de6(0x1f8)](0x190)[_0x4c4de6(0x1e8)]({'success':![],'message':_0x4c4de6(0x1e9)});if(_0xd9bac7['status']!==_0x4c4de6(0x23c))return _0x13057a[_0x4c4de6(0x1f8)](0x190)[_0x4c4de6(0x1e8)]({'success':![],'message':_0x4c4de6(0x212)+_0xd9bac7[_0x4c4de6(0x1f8)]+_0x4c4de6(0x1ef)});const _0x798995=await this[_0x4c4de6(0x1df)][_0x4c4de6(0x1ee)]({'paymentId':_0xd9bac7['id'],'orderId':_0xd9bac7[_0x4c4de6(0x240)]||_0xd9bac7['id'],'amount':_0xd9bac7['amount'],'currency':_0xd9bac7[_0x4c4de6(0x21b)],'cardData':_0x4ea43b});console[_0x4c4de6(0x1fc)](_0x4c4de6(0x210),_0x798995);const _0x3eb934={'status':_0x798995[_0x4c4de6(0x1f8)],'updatedAt':new Date()};if(_0x798995[_0x4c4de6(0x1f8)]===_0x4c4de6(0x217))_0x3eb934[_0x4c4de6(0x227)]=new Date(),_0x3eb934['gatewayPaymentId']=_0x798995[_0x4c4de6(0x1f0)];else _0x798995[_0x4c4de6(0x1f8)]===_0x4c4de6(0x1de)&&(_0x3eb934[_0x4c4de6(0x1fa)]=_0x798995['failureReason']);const _0x2c0f97=_0x4ea43b[_0x4c4de6(0x207)][_0x4c4de6(0x20e)](/[\s-]/g,'');_0x3eb934[_0x4c4de6(0x233)]=_0x2c0f97['slice'](-0x4),_0x3eb934['paymentMethod']=_0x4c4de6(0x221),await database_1[_0x4c4de6(0x1f4)]['payment'][_0x4c4de6(0x230)]({'where':{'id':_0xd9bac7['id']},'data':_0x3eb934}),await database_1[_0x4c4de6(0x1f4)][_0x4c4de6(0x206)][_0x4c4de6(0x201)]({'data':{'paymentId':_0xd9bac7['id'],'shopId':_0xd9bac7['shopId'],'event':'test_gateway_'+_0x798995[_0x4c4de6(0x1f8)][_0x4c4de6(0x23b)](),'statusCode':0xc8,'responseBody':JSON[_0x4c4de6(0x1ea)]({'oldStatus':_0x4c4de6(0x23c),'newStatus':_0x798995[_0x4c4de6(0x1f8)],'transactionId':_0x798995['transactionId'],'failureReason':_0x798995['failureReason'],'processedAt':new Date()[_0x4c4de6(0x1fb)]()})}}),await this[_0x4c4de6(0x1f3)](_0xd9bac7,_0x798995[_0x4c4de6(0x1f8)],_0x798995[_0x4c4de6(0x1f0)],_0x798995[_0x4c4de6(0x214)]),await this[_0x4c4de6(0x23a)](_0xd9bac7,_0x798995[_0x4c4de6(0x1f8)]),console[_0x4c4de6(0x1fc)](_0x4c4de6(0x1f5)+_0x216aea+_0x4c4de6(0x229)+_0x798995['status']),_0x798995[_0x4c4de6(0x1f8)]===_0x4c4de6(0x217)?_0x13057a[_0x4c4de6(0x1e8)]({'success':!![],'message':_0x4c4de6(0x21d),'result':{'status':_0x4c4de6(0x217),'transactionId':_0x798995[_0x4c4de6(0x1f0)],'redirectUrl':_0xd9bac7[_0x4c4de6(0x23e)]}}):_0x13057a['status'](0x190)[_0x4c4de6(0x1e8)]({'success':![],'message':_0x4c4de6(0x1e6),'result':{'status':_0x4c4de6(0x1de),'failureReason':_0x798995[_0x4c4de6(0x214)],'redirectUrl':_0xd9bac7[_0x4c4de6(0x219)]}});}catch(_0xebf011){_0x27cfb4(_0xebf011);}},this['testGatewayService']=new testGatewayService_1[(_0x539887(0x213))](),this[_0x539887(0x20a)]=new webhookService_1[(_0x539887(0x22a))]();}async[a13_0x5bfe09(0x1f3)](_0x31a768,_0x4cb559,_0x330ee1,_0x2a9dcb){const _0x198fb6=a13_0x5bfe09,_0x1ac6b4=Date[_0x198fb6(0x22d)]();try{const _0x2fff06=_0x31a768['shop'],_0x36ee59=_0x2fff06[_0x198fb6(0x1f1)];if(!_0x36ee59?.[_0x198fb6(0x238)]){console['log'](_0x198fb6(0x20b)+_0x2fff06['id']);return;}const _0x2045b2=_0x4cb559===_0x198fb6(0x217)?'payment.success':'payment.failed';let _0x25b325=[];if(_0x36ee59[_0x198fb6(0x209)])try{_0x25b325=Array[_0x198fb6(0x208)](_0x36ee59[_0x198fb6(0x209)])?_0x36ee59[_0x198fb6(0x209)]:JSON[_0x198fb6(0x222)](_0x36ee59[_0x198fb6(0x209)]);}catch(_0x23b9b6){console['error'](_0x198fb6(0x235),_0x23b9b6),_0x25b325=[];}if(!_0x25b325[_0x198fb6(0x23f)](_0x2045b2)){console['log'](_0x198fb6(0x243)+_0x2045b2+_0x198fb6(0x231)+_0x2fff06['id']);return;}const _0x203561={'event':_0x2045b2,'payment':{'id':_0x31a768['id'],'order_id':_0x31a768[_0x198fb6(0x211)],'gateway_order_id':_0x31a768[_0x198fb6(0x240)],'gateway':_0x198fb6(0x21f),'amount':_0x31a768[_0x198fb6(0x200)],'currency':_0x31a768[_0x198fb6(0x21b)],'status':_0x4cb559['toLowerCase'](),'customer_email':_0x31a768[_0x198fb6(0x1eb)],'customer_name':_0x31a768['customerName'],'transaction_id':_0x330ee1,'failure_message':_0x2a9dcb,'created_at':_0x31a768[_0x198fb6(0x241)],'updated_at':new Date()}},_0x57ba5b=await fetch(_0x36ee59[_0x198fb6(0x238)],{'method':'POST','headers':{'Content-Type':_0x198fb6(0x1e3),'User-Agent':_0x198fb6(0x1fe)},'body':JSON['stringify'](_0x203561)}),_0x5ad250=Date[_0x198fb6(0x22d)]()-_0x1ac6b4;console[_0x198fb6(0x1fc)](_0x198fb6(0x223)+_0x36ee59[_0x198fb6(0x238)]+_0x198fb6(0x1ff)+_0x57ba5b[_0x198fb6(0x1f8)]+'\x20('+_0x5ad250+_0x198fb6(0x220));}catch(_0x4968de){console[_0x198fb6(0x22b)](_0x198fb6(0x237),_0x4968de);}}async[a13_0x5bfe09(0x23a)](_0x543293,_0x5cb92c){const _0x3915db=a13_0x5bfe09;try{const {telegramBotService:_0x4f225b}=await Promise['resolve']()['then'](()=>__importStar(require(_0x3915db(0x1ed)))),_0x597481={'PAID':_0x3915db(0x228),'FAILED':_0x3915db(0x1e2)},_0x36552a=_0x597481[_0x5cb92c];if(!_0x36552a)return;await _0x4f225b[_0x3915db(0x20d)](_0x543293[_0x3915db(0x234)],_0x543293,_0x36552a);}catch(_0x5c4e52){console[_0x3915db(0x22b)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5c4e52);}}}exports[a13_0x5bfe09(0x1e0)]=TestGatewayController;