'use strict';const a14_0x42e9d2=a14_0x2bf2;(function(_0x40ef09,_0x244710){const _0x4d9fbe=a14_0x2bf2,_0x32c8c6=_0x40ef09();while(!![]){try{const _0x3b18fa=parseInt(_0x4d9fbe(0xeb))/0x1*(parseInt(_0x4d9fbe(0xf7))/0x2)+-parseInt(_0x4d9fbe(0xf9))/0x3+parseInt(_0x4d9fbe(0x129))/0x4+-parseInt(_0x4d9fbe(0xf2))/0x5*(-parseInt(_0x4d9fbe(0x150))/0x6)+parseInt(_0x4d9fbe(0x138))/0x7*(-parseInt(_0x4d9fbe(0x111))/0x8)+parseInt(_0x4d9fbe(0xee))/0x9*(parseInt(_0x4d9fbe(0x119))/0xa)+-parseInt(_0x4d9fbe(0x105))/0xb;if(_0x3b18fa===_0x244710)break;else _0x32c8c6['push'](_0x32c8c6['shift']());}catch(_0x474315){_0x32c8c6['push'](_0x32c8c6['shift']());}}}(a14_0x1e36,0x265fa));var __createBinding=this&&this[a14_0x42e9d2(0x14e)]||(Object[a14_0x42e9d2(0x102)]?function(_0x207b85,_0x5c1603,_0x16ebf9,_0x42099f){const _0x284d06=a14_0x42e9d2;if(_0x42099f===undefined)_0x42099f=_0x16ebf9;var _0xc4b02a=Object['getOwnPropertyDescriptor'](_0x5c1603,_0x16ebf9);(!_0xc4b02a||('get'in _0xc4b02a?!_0x5c1603['__esModule']:_0xc4b02a[_0x284d06(0xf3)]||_0xc4b02a[_0x284d06(0x15a)]))&&(_0xc4b02a={'enumerable':!![],'get':function(){return _0x5c1603[_0x16ebf9];}}),Object[_0x284d06(0x12e)](_0x207b85,_0x42099f,_0xc4b02a);}:function(_0x47e404,_0x3c915c,_0x4b89ef,_0x12ee95){if(_0x12ee95===undefined)_0x12ee95=_0x4b89ef;_0x47e404[_0x12ee95]=_0x3c915c[_0x4b89ef];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a14_0x42e9d2(0x102)]?function(_0xdc10,_0x25949a){const _0x54075a=a14_0x42e9d2;Object[_0x54075a(0x12e)](_0xdc10,_0x54075a(0x117),{'enumerable':!![],'value':_0x25949a});}:function(_0x1b0fbd,_0xae3a4d){const _0x4d7ed5=a14_0x42e9d2;_0x1b0fbd[_0x4d7ed5(0x117)]=_0xae3a4d;}),__importStar=this&&this[a14_0x42e9d2(0x136)]||(function(){var _0x1aa128=function(_0x190bfe){const _0x3e354e=a14_0x2bf2;return _0x1aa128=Object[_0x3e354e(0x11d)]||function(_0x31c061){const _0x459475=_0x3e354e;var _0x34b326=[];for(var _0x4416d6 in _0x31c061)if(Object[_0x459475(0x14a)][_0x459475(0x153)]['call'](_0x31c061,_0x4416d6))_0x34b326[_0x34b326[_0x459475(0xfa)]]=_0x4416d6;return _0x34b326;},_0x1aa128(_0x190bfe);};return function(_0x392214){const _0x280d7f=a14_0x2bf2;if(_0x392214&&_0x392214[_0x280d7f(0x147)])return _0x392214;var _0x1c93b2={};if(_0x392214!=null){for(var _0x5eb59f=_0x1aa128(_0x392214),_0xf5a294=0x0;_0xf5a294<_0x5eb59f[_0x280d7f(0xfa)];_0xf5a294++)if(_0x5eb59f[_0xf5a294]!==_0x280d7f(0x117))__createBinding(_0x1c93b2,_0x392214,_0x5eb59f[_0xf5a294]);}return __setModuleDefault(_0x1c93b2,_0x392214),_0x1c93b2;};}()),__importDefault=this&&this[a14_0x42e9d2(0x100)]||function(_0x5e2cbc){const _0x53f03f=a14_0x42e9d2;return _0x5e2cbc&&_0x5e2cbc[_0x53f03f(0x147)]?_0x5e2cbc:{'default':_0x5e2cbc};};Object[a14_0x42e9d2(0x12e)](exports,a14_0x42e9d2(0x147),{'value':!![]}),exports[a14_0x42e9d2(0x134)]=void 0x0;function a14_0x2bf2(_0x181c63,_0x4fcdf1){const _0x1e36c7=a14_0x1e36();return a14_0x2bf2=function(_0x2bf2f9,_0x3f5e19){_0x2bf2f9=_0x2bf2f9-0xe9;let _0x7ea021=_0x1e36c7[_0x2bf2f9];return _0x7ea021;},a14_0x2bf2(_0x181c63,_0x4fcdf1);}const testGatewayService_1=require(a14_0x42e9d2(0x13e)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a14_0x42e9d2(0xfc)));function a14_0x1e36(){const _0x312a21=['paymentLinkId','Any\x20name','resolve','sendPaymentStatusNotification','configurable','successUrl','failUrl','paymentMethod','700ybtvNi','payment','currentPayments','2124dIdgrC','paymentLink','amount','\x20->\x20','25635NEptJW','writable','currency','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20not\x20found','70GhKbqZ','Any\x20future\x20date\x20(MM/YY)','524532dbzOUg','length','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../config/database','TestGatewayService','webhookUrl','createdAt','__importDefault','\x20updated:\x20currentPayments=','create','Webhook\x20event\x20','name','1609465yGfsvR','shop','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','parse','sendShopWebhook',':\x20type=','Payment\x20status\x20is\x20','failed','🧪\x20Test\x20Gateway\x20result:',',\x20status=','replace','transactionId','40gjifgh','Payment\x20is\x20not\x20for\x20test\x20gateway','then','FAILED','Any\x20other\x20card\x20number','cardLast4','default','status','11820gDjVqn','webhookEvents','includes','failureReason','getOwnPropertyNames',',\x20currentPayments=','test_card','customerEmail','now','gateway','testGatewayService','PAID','paidAt','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','isArray','\x20with\x20status\x20','854372XkgKMa','json','body','processCard','log','defineProperty','findUnique','SINGLE','settings','Payment\x20processed\x20successfully','Any\x203-4\x20digits','TestGatewayController','params','__importStar','gatewayPaymentId','97258MXDmHT','application/json','webhookLog',',\x20cannot\x20process','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','📈\x20Found\x20payment\x20link\x20','../services/gateways/testGatewayService','PENDING','toISOString','gatewayOrderId','WebhookService','ms)','getPaymentForm','shopId','❌\x20Payment\x20link\x20','__esModule','orderId','test_gateway','prototype','\x20processed:\x20','webhookService','✅\x20Test\x20Gateway\x20payment\x20','__createBinding','Payment\x20to\x20','36skTBQd','test_gateway_','toLowerCase','hasOwnProperty','Payment\x20failed','error'];a14_0x1e36=function(){return _0x312a21;};return a14_0x1e36();}class TestGatewayController{constructor(){const _0x4ffdf9=a14_0x42e9d2;this[_0x4ffdf9(0x144)]=async(_0x247b12,_0x5ad187,_0x2ae2fb)=>{const _0x3a3f48=_0x4ffdf9;try{const {paymentId:_0x2ecc3f}=_0x247b12[_0x3a3f48(0x135)];console[_0x3a3f48(0x12d)](_0x3a3f48(0x126)+_0x2ecc3f);const _0x32d914=await database_1[_0x3a3f48(0x117)][_0x3a3f48(0xec)][_0x3a3f48(0x12f)]({'where':{'id':_0x2ecc3f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x32d914)return _0x5ad187[_0x3a3f48(0x118)](0x194)[_0x3a3f48(0x12a)]({'success':![],'message':_0x3a3f48(0xf6)});if(_0x32d914[_0x3a3f48(0x122)]!=='test_gateway')return _0x5ad187['status'](0x190)[_0x3a3f48(0x12a)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x32d914[_0x3a3f48(0x118)]!=='PENDING')return _0x5ad187[_0x3a3f48(0x118)](0x190)[_0x3a3f48(0x12a)]({'success':![],'message':_0x3a3f48(0x10b)+_0x32d914[_0x3a3f48(0x118)]+_0x3a3f48(0x13b)});_0x5ad187['json']({'success':!![],'result':{'paymentId':_0x32d914['id'],'orderId':_0x32d914[_0x3a3f48(0x141)],'amount':_0x32d914[_0x3a3f48(0xf0)],'currency':_0x32d914[_0x3a3f48(0xf4)],'merchantName':_0x32d914[_0x3a3f48(0x106)]['name'],'description':_0x3a3f48(0x14f)+_0x32d914['shop'][_0x3a3f48(0x104)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x3a3f48(0x115),'expiryDate':_0x3a3f48(0xf8),'cvc':_0x3a3f48(0x133),'holderName':_0x3a3f48(0x157)}}});}catch(_0x18286f){_0x2ae2fb(_0x18286f);}},this[_0x4ffdf9(0x12c)]=async(_0x56b16f,_0x41e6df,_0x27d059)=>{const _0x464645=_0x4ffdf9;try{const {paymentId:_0x2bc65c}=_0x56b16f[_0x464645(0x135)],_0x5c819b=_0x56b16f[_0x464645(0x12b)];console[_0x464645(0x12d)](_0x464645(0x107)+_0x2bc65c);const _0x1a466e=await database_1[_0x464645(0x117)][_0x464645(0xec)][_0x464645(0x12f)]({'where':{'id':_0x2bc65c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1a466e)return _0x41e6df[_0x464645(0x118)](0x194)[_0x464645(0x12a)]({'success':![],'message':_0x464645(0xf6)});if(_0x1a466e[_0x464645(0x122)]!==_0x464645(0x149))return _0x41e6df[_0x464645(0x118)](0x190)[_0x464645(0x12a)]({'success':![],'message':_0x464645(0x112)});if(_0x1a466e[_0x464645(0x118)]!=='PENDING')return _0x41e6df[_0x464645(0x118)](0x190)[_0x464645(0x12a)]({'success':![],'message':_0x464645(0x10b)+_0x1a466e[_0x464645(0x118)]+_0x464645(0x13b)});const _0x553636=await this[_0x464645(0x123)]['processCardPayment']({'paymentId':_0x1a466e['id'],'orderId':_0x1a466e[_0x464645(0x141)]||_0x1a466e['id'],'amount':_0x1a466e['amount'],'currency':_0x1a466e['currency'],'cardData':_0x5c819b});console[_0x464645(0x12d)](_0x464645(0x10d),_0x553636);const _0x117f47={'status':_0x553636[_0x464645(0x118)],'updatedAt':new Date()};if(_0x553636[_0x464645(0x118)]===_0x464645(0x124))_0x117f47[_0x464645(0x125)]=new Date(),_0x117f47[_0x464645(0x137)]=_0x553636[_0x464645(0x110)];else _0x553636['status']===_0x464645(0x114)&&(_0x117f47['failureMessage']=_0x553636[_0x464645(0x11c)]);const _0x300e5b=_0x5c819b['cardNumber'][_0x464645(0x10f)](/[\s-]/g,'');_0x117f47[_0x464645(0x116)]=_0x300e5b['slice'](-0x4),_0x117f47[_0x464645(0xea)]=_0x464645(0x11f),await database_1['default'][_0x464645(0xec)]['update']({'where':{'id':_0x1a466e['id']},'data':_0x117f47});if(_0x553636[_0x464645(0x118)]===_0x464645(0x124)&&_0x1a466e[_0x464645(0x156)]){console['log']('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x1a466e['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x464645(0x117)]['$transaction'](async _0x258df0=>{const _0x48fc92=_0x464645,_0x280c3a=await _0x258df0[_0x48fc92(0xef)][_0x48fc92(0x12f)]({'where':{'id':_0x1a466e[_0x48fc92(0x156)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x280c3a){console['log'](_0x48fc92(0x13d)+_0x280c3a['id']+_0x48fc92(0x10a)+_0x280c3a['type']+_0x48fc92(0x11e)+_0x280c3a[_0x48fc92(0xed)]+_0x48fc92(0x10e)+_0x280c3a['status']);const _0x27b52=_0x280c3a[_0x48fc92(0xed)]+0x1,_0xc69380=_0x280c3a['type']===_0x48fc92(0x130)?'COMPLETED':_0x280c3a[_0x48fc92(0x118)];await _0x258df0[_0x48fc92(0xef)]['update']({'where':{'id':_0x1a466e[_0x48fc92(0x156)]},'data':{'currentPayments':_0x27b52,'status':_0xc69380,'updatedAt':new Date()}}),console[_0x48fc92(0x12d)]('✅\x20Payment\x20link\x20'+_0x280c3a['id']+_0x48fc92(0x101)+_0x280c3a[_0x48fc92(0xed)]+'\x20->\x20'+_0x27b52+_0x48fc92(0x10e)+_0x280c3a[_0x48fc92(0x118)]+_0x48fc92(0xf1)+_0xc69380);}else console[_0x48fc92(0x12d)](_0x48fc92(0x146)+_0x1a466e[_0x48fc92(0x156)]+'\x20not\x20found');});}catch(_0x1369c6){console[_0x464645(0x155)](_0x464645(0x13c),_0x1369c6);}}await database_1['default'][_0x464645(0x13a)]['create']({'data':{'paymentId':_0x1a466e['id'],'shopId':_0x1a466e[_0x464645(0x145)],'event':_0x464645(0x151)+_0x553636[_0x464645(0x118)][_0x464645(0x152)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x464645(0x13f),'newStatus':_0x553636['status'],'transactionId':_0x553636['transactionId'],'failureReason':_0x553636[_0x464645(0x11c)],'processedAt':new Date()[_0x464645(0x140)]()})}}),await this[_0x464645(0x109)](_0x1a466e,_0x553636[_0x464645(0x118)],_0x553636[_0x464645(0x110)],_0x553636[_0x464645(0x11c)]),await this[_0x464645(0x159)](_0x1a466e,_0x553636[_0x464645(0x118)]),console[_0x464645(0x12d)](_0x464645(0x14d)+_0x2bc65c+_0x464645(0x14b)+_0x553636[_0x464645(0x118)]),_0x553636['status']===_0x464645(0x124)?_0x41e6df['json']({'success':!![],'message':_0x464645(0x132),'result':{'status':_0x464645(0x124),'transactionId':_0x553636[_0x464645(0x110)],'redirectUrl':_0x1a466e[_0x464645(0x15b)]}}):_0x41e6df['status'](0x190)[_0x464645(0x12a)]({'success':![],'message':_0x464645(0x154),'result':{'status':_0x464645(0x114),'failureReason':_0x553636[_0x464645(0x11c)],'redirectUrl':_0x1a466e[_0x464645(0xe9)]}});}catch(_0x363d9e){_0x27d059(_0x363d9e);}},this[_0x4ffdf9(0x123)]=new testGatewayService_1[(_0x4ffdf9(0xfd))](),this[_0x4ffdf9(0x14c)]=new webhookService_1[(_0x4ffdf9(0x142))]();}async[a14_0x42e9d2(0x109)](_0x1c7647,_0x5d35a1,_0x5650ac,_0x2d193a){const _0x314372=a14_0x42e9d2,_0x3a48b5=Date[_0x314372(0x121)]();try{const _0xd133f=_0x1c7647['shop'],_0x2766d0=_0xd133f[_0x314372(0x131)];if(!_0x2766d0?.[_0x314372(0xfe)]){console['log'](_0x314372(0xfb)+_0xd133f['id']);return;}const _0x50560b=_0x5d35a1===_0x314372(0x124)?'payment.success':'payment.failed';let _0x200ab4=[];if(_0x2766d0[_0x314372(0x11a)])try{_0x200ab4=Array[_0x314372(0x127)](_0x2766d0[_0x314372(0x11a)])?_0x2766d0[_0x314372(0x11a)]:JSON[_0x314372(0x108)](_0x2766d0[_0x314372(0x11a)]);}catch(_0x373fea){console[_0x314372(0x155)]('Error\x20parsing\x20webhook\x20events:',_0x373fea),_0x200ab4=[];}if(!_0x200ab4[_0x314372(0x11b)](_0x50560b)){console[_0x314372(0x12d)](_0x314372(0x103)+_0x50560b+'\x20not\x20enabled\x20for\x20shop\x20'+_0xd133f['id']);return;}const _0x1afc83={'event':_0x50560b,'payment':{'id':_0x1c7647['id'],'order_id':_0x1c7647[_0x314372(0x148)],'gateway_order_id':_0x1c7647['gatewayOrderId'],'gateway':'0000','amount':_0x1c7647[_0x314372(0xf0)],'currency':_0x1c7647[_0x314372(0xf4)],'status':_0x5d35a1['toLowerCase'](),'customer_email':_0x1c7647[_0x314372(0x120)],'customer_name':_0x1c7647['customerName'],'transaction_id':_0x5650ac,'failure_message':_0x2d193a,'created_at':_0x1c7647[_0x314372(0xff)],'updated_at':new Date()}},_0x37618b=await fetch(_0x2766d0['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x314372(0x139),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x1afc83)}),_0x3d3e11=Date[_0x314372(0x121)]()-_0x3a48b5;console['log'](_0x314372(0xf5)+_0x2766d0['webhookUrl']+_0x314372(0x128)+_0x37618b[_0x314372(0x118)]+'\x20('+_0x3d3e11+_0x314372(0x143));}catch(_0x1cd2dd){console[_0x314372(0x155)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x1cd2dd);}}async[a14_0x42e9d2(0x159)](_0x132a15,_0xdba5d8){const _0x5a7434=a14_0x42e9d2;try{const {telegramBotService:_0x4b3527}=await Promise[_0x5a7434(0x158)]()[_0x5a7434(0x113)](()=>__importStar(require('../services/telegramBotService'))),_0x2f11b4={'PAID':'paid','FAILED':_0x5a7434(0x10c)},_0x130585=_0x2f11b4[_0xdba5d8];if(!_0x130585)return;await _0x4b3527['sendPaymentNotification'](_0x132a15[_0x5a7434(0x145)],_0x132a15,_0x130585);}catch(_0x5e97dc){console[_0x5a7434(0x155)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5e97dc);}}}exports[a14_0x42e9d2(0x134)]=TestGatewayController;