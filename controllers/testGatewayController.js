'use strict';const a13_0x636c9=a13_0xdbc6;(function(_0x477d48,_0x2606fb){const _0x168eae=a13_0xdbc6,_0x15ffbb=_0x477d48();while(!![]){try{const _0x27cec3=-parseInt(_0x168eae(0x1ef))/0x1*(parseInt(_0x168eae(0x22f))/0x2)+parseInt(_0x168eae(0x259))/0x3*(-parseInt(_0x168eae(0x246))/0x4)+-parseInt(_0x168eae(0x208))/0x5*(parseInt(_0x168eae(0x225))/0x6)+parseInt(_0x168eae(0x1eb))/0x7+-parseInt(_0x168eae(0x248))/0x8+parseInt(_0x168eae(0x249))/0x9+-parseInt(_0x168eae(0x21c))/0xa*(-parseInt(_0x168eae(0x212))/0xb);if(_0x27cec3===_0x2606fb)break;else _0x15ffbb['push'](_0x15ffbb['shift']());}catch(_0x55e7f1){_0x15ffbb['push'](_0x15ffbb['shift']());}}}(a13_0x470b,0x3693f));var __createBinding=this&&this[a13_0x636c9(0x1e9)]||(Object[a13_0x636c9(0x1f8)]?function(_0x596805,_0x4c14a9,_0x7b2ecc,_0x66d4ef){const _0x2584a0=a13_0x636c9;if(_0x66d4ef===undefined)_0x66d4ef=_0x7b2ecc;var _0x154221=Object[_0x2584a0(0x1f2)](_0x4c14a9,_0x7b2ecc);(!_0x154221||(_0x2584a0(0x25e)in _0x154221?!_0x4c14a9[_0x2584a0(0x1ee)]:_0x154221[_0x2584a0(0x241)]||_0x154221[_0x2584a0(0x253)]))&&(_0x154221={'enumerable':!![],'get':function(){return _0x4c14a9[_0x7b2ecc];}}),Object[_0x2584a0(0x226)](_0x596805,_0x66d4ef,_0x154221);}:function(_0x5e3106,_0x4c2ce9,_0x2751de,_0x157488){if(_0x157488===undefined)_0x157488=_0x2751de;_0x5e3106[_0x157488]=_0x4c2ce9[_0x2751de];}),__setModuleDefault=this&&this[a13_0x636c9(0x234)]||(Object[a13_0x636c9(0x1f8)]?function(_0x262510,_0xfc1def){const _0x5547bb=a13_0x636c9;Object[_0x5547bb(0x226)](_0x262510,_0x5547bb(0x24d),{'enumerable':!![],'value':_0xfc1def});}:function(_0x3ba1f9,_0x5b47f5){const _0x2ccf09=a13_0x636c9;_0x3ba1f9[_0x2ccf09(0x24d)]=_0x5b47f5;}),__importStar=this&&this[a13_0x636c9(0x223)]||(function(){var _0x779d83=function(_0x5179e1){const _0x8fec7b=a13_0xdbc6;return _0x779d83=Object[_0x8fec7b(0x243)]||function(_0x581404){const _0x5d0d73=_0x8fec7b;var _0x293919=[];for(var _0x5cb2d4 in _0x581404)if(Object[_0x5d0d73(0x213)]['hasOwnProperty'][_0x5d0d73(0x217)](_0x581404,_0x5cb2d4))_0x293919[_0x293919[_0x5d0d73(0x1fe)]]=_0x5cb2d4;return _0x293919;},_0x779d83(_0x5179e1);};return function(_0x3cbaf){const _0x51e7b4=a13_0xdbc6;if(_0x3cbaf&&_0x3cbaf[_0x51e7b4(0x1ee)])return _0x3cbaf;var _0x25d8f3={};if(_0x3cbaf!=null){for(var _0x5b9565=_0x779d83(_0x3cbaf),_0x227c3b=0x0;_0x227c3b<_0x5b9565[_0x51e7b4(0x1fe)];_0x227c3b++)if(_0x5b9565[_0x227c3b]!==_0x51e7b4(0x24d))__createBinding(_0x25d8f3,_0x3cbaf,_0x5b9565[_0x227c3b]);}return __setModuleDefault(_0x25d8f3,_0x3cbaf),_0x25d8f3;};}()),__importDefault=this&&this[a13_0x636c9(0x24a)]||function(_0x3ec50f){const _0x30bfcb=a13_0x636c9;return _0x3ec50f&&_0x3ec50f[_0x30bfcb(0x1ee)]?_0x3ec50f:{'default':_0x3ec50f};};Object[a13_0x636c9(0x226)](exports,'__esModule',{'value':!![]}),exports[a13_0x636c9(0x201)]=void 0x0;const testGatewayService_1=require(a13_0x636c9(0x21d)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x636c9(0x207)));function a13_0xdbc6(_0x1b038d,_0x4ec504){const _0x470b5f=a13_0x470b();return a13_0xdbc6=function(_0xdbc67e,_0x105afc){_0xdbc67e=_0xdbc67e-0x1e4;let _0xfdd7cd=_0x470b5f[_0xdbc67e];return _0xfdd7cd;},a13_0xdbc6(_0x1b038d,_0x4ec504);}class TestGatewayController{constructor(){const _0x4715bd=a13_0x636c9;this[_0x4715bd(0x1ec)]=async(_0x13e88c,_0x1ace4b,_0x1ecd76)=>{const _0x3a950f=_0x4715bd;try{const {paymentId:_0x1ba4ed}=_0x13e88c['params'];console[_0x3a950f(0x256)](_0x3a950f(0x1f4)+_0x1ba4ed);const _0x41bc5c=await database_1[_0x3a950f(0x24d)][_0x3a950f(0x20b)][_0x3a950f(0x20c)]({'where':{'id':_0x1ba4ed},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x41bc5c)return _0x1ace4b['status'](0x194)[_0x3a950f(0x1e7)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x41bc5c[_0x3a950f(0x237)]!=='test_gateway')return _0x1ace4b[_0x3a950f(0x206)](0x190)[_0x3a950f(0x1e7)]({'success':![],'message':_0x3a950f(0x23a)});if(_0x41bc5c['status']!=='PENDING')return _0x1ace4b[_0x3a950f(0x206)](0x190)[_0x3a950f(0x1e7)]({'success':![],'message':_0x3a950f(0x1e6)+_0x41bc5c[_0x3a950f(0x206)]+_0x3a950f(0x218)});_0x1ace4b[_0x3a950f(0x1e7)]({'success':!![],'result':{'paymentId':_0x41bc5c['id'],'orderId':_0x41bc5c[_0x3a950f(0x209)],'amount':_0x41bc5c['amount'],'currency':_0x41bc5c[_0x3a950f(0x252)],'merchantName':_0x41bc5c[_0x3a950f(0x202)][_0x3a950f(0x210)],'description':_0x3a950f(0x1ea)+_0x41bc5c['shop'][_0x3a950f(0x210)],'testInstructions':{'successCard':_0x3a950f(0x20f),'failureCard':_0x3a950f(0x247),'expiryDate':_0x3a950f(0x251),'cvc':_0x3a950f(0x250),'holderName':'Any\x20name'}}});}catch(_0x4d5496){_0x1ecd76(_0x4d5496);}},this[_0x4715bd(0x1f3)]=async(_0x28ab28,_0x4cf1d6,_0x1dcf11)=>{const _0xc583a2=_0x4715bd;try{const {paymentId:_0xadcfd9}=_0x28ab28[_0xc583a2(0x200)],_0x29b1c0=_0x28ab28[_0xc583a2(0x22a)];console[_0xc583a2(0x256)](_0xc583a2(0x1fa)+_0xadcfd9);const _0x34bf99=await database_1[_0xc583a2(0x24d)][_0xc583a2(0x20b)][_0xc583a2(0x20c)]({'where':{'id':_0xadcfd9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34bf99)return _0x4cf1d6[_0xc583a2(0x206)](0x194)[_0xc583a2(0x1e7)]({'success':![],'message':_0xc583a2(0x230)});if(_0x34bf99[_0xc583a2(0x237)]!==_0xc583a2(0x254))return _0x4cf1d6['status'](0x190)[_0xc583a2(0x1e7)]({'success':![],'message':_0xc583a2(0x23a)});if(_0x34bf99['status']!==_0xc583a2(0x255))return _0x4cf1d6['status'](0x190)[_0xc583a2(0x1e7)]({'success':![],'message':_0xc583a2(0x1e6)+_0x34bf99[_0xc583a2(0x206)]+_0xc583a2(0x218)});const _0x151439=await this['testGatewayService'][_0xc583a2(0x245)]({'paymentId':_0x34bf99['id'],'orderId':_0x34bf99[_0xc583a2(0x209)]||_0x34bf99['id'],'amount':_0x34bf99[_0xc583a2(0x21a)],'currency':_0x34bf99[_0xc583a2(0x252)],'cardData':_0x29b1c0});console[_0xc583a2(0x256)](_0xc583a2(0x214),_0x151439);const _0x22581f={'status':_0x151439[_0xc583a2(0x206)],'updatedAt':new Date()};if(_0x151439['status']===_0xc583a2(0x23d))_0x22581f[_0xc583a2(0x238)]=new Date(),_0x22581f[_0xc583a2(0x21f)]=_0x151439[_0xc583a2(0x229)];else _0x151439[_0xc583a2(0x206)]===_0xc583a2(0x22e)&&(_0x22581f['failureMessage']=_0x151439[_0xc583a2(0x203)]);const _0x354fe0=_0x29b1c0[_0xc583a2(0x23c)][_0xc583a2(0x25f)](/[\s-]/g,'');_0x22581f[_0xc583a2(0x23b)]=_0x354fe0[_0xc583a2(0x236)](-0x4),_0x22581f[_0xc583a2(0x205)]=_0xc583a2(0x22b),await database_1[_0xc583a2(0x24d)][_0xc583a2(0x20b)][_0xc583a2(0x235)]({'where':{'id':_0x34bf99['id']},'data':_0x22581f});if(_0x151439[_0xc583a2(0x206)]===_0xc583a2(0x23d)&&_0x34bf99[_0xc583a2(0x1fd)]){console[_0xc583a2(0x256)](_0xc583a2(0x242)+_0x34bf99['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xc583a2(0x24d)][_0xc583a2(0x23f)](async _0x46aebe=>{const _0x4cb464=_0xc583a2,_0x3f15f0=await _0x46aebe[_0x4cb464(0x1ff)][_0x4cb464(0x20c)]({'where':{'id':_0x34bf99[_0x4cb464(0x1fd)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3f15f0){console[_0x4cb464(0x256)](_0x4cb464(0x233)+_0x3f15f0['id']+_0x4cb464(0x220)+_0x3f15f0[_0x4cb464(0x231)]+_0x4cb464(0x24e)+_0x3f15f0[_0x4cb464(0x228)]+_0x4cb464(0x21e)+_0x3f15f0['status']);const _0x280bbc=_0x3f15f0[_0x4cb464(0x228)]+0x1,_0x55a250=_0x3f15f0[_0x4cb464(0x231)]===_0x4cb464(0x232)?_0x4cb464(0x219):_0x3f15f0[_0x4cb464(0x206)];await _0x46aebe[_0x4cb464(0x1ff)][_0x4cb464(0x235)]({'where':{'id':_0x34bf99[_0x4cb464(0x1fd)]},'data':{'currentPayments':_0x280bbc,'status':_0x55a250,'updatedAt':new Date()}}),console[_0x4cb464(0x256)](_0x4cb464(0x24c)+_0x3f15f0['id']+'\x20updated:\x20currentPayments='+_0x3f15f0['currentPayments']+_0x4cb464(0x222)+_0x280bbc+_0x4cb464(0x21e)+_0x3f15f0[_0x4cb464(0x206)]+_0x4cb464(0x222)+_0x55a250);}else console[_0x4cb464(0x256)](_0x4cb464(0x1e5)+_0x34bf99['paymentLinkId']+'\x20not\x20found');});}catch(_0x530e98){console['error'](_0xc583a2(0x1e4),_0x530e98);}}await database_1[_0xc583a2(0x24d)]['webhookLog'][_0xc583a2(0x1f8)]({'data':{'paymentId':_0x34bf99['id'],'shopId':_0x34bf99[_0xc583a2(0x25c)],'event':'test_gateway_'+_0x151439[_0xc583a2(0x206)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xc583a2(0x215)]({'oldStatus':_0xc583a2(0x255),'newStatus':_0x151439[_0xc583a2(0x206)],'transactionId':_0x151439['transactionId'],'failureReason':_0x151439['failureReason'],'processedAt':new Date()[_0xc583a2(0x1f5)]()})}}),await this['sendShopWebhook'](_0x34bf99,_0x151439[_0xc583a2(0x206)],_0x151439[_0xc583a2(0x229)],_0x151439[_0xc583a2(0x203)]),await this[_0xc583a2(0x244)](_0x34bf99,_0x151439[_0xc583a2(0x206)]),console[_0xc583a2(0x256)](_0xc583a2(0x1f6)+_0xadcfd9+_0xc583a2(0x24b)+_0x151439['status']),_0x151439['status']===_0xc583a2(0x23d)?_0x4cf1d6[_0xc583a2(0x1e7)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x151439[_0xc583a2(0x229)],'redirectUrl':_0x34bf99[_0xc583a2(0x258)]}}):_0x4cf1d6[_0xc583a2(0x206)](0x190)[_0xc583a2(0x1e7)]({'success':![],'message':_0xc583a2(0x257),'result':{'status':_0xc583a2(0x22e),'failureReason':_0x151439[_0xc583a2(0x203)],'redirectUrl':_0x34bf99['failUrl']}});}catch(_0x3338cb){_0x1dcf11(_0x3338cb);}},this[_0x4715bd(0x211)]=new testGatewayService_1[(_0x4715bd(0x1e8))](),this[_0x4715bd(0x1f1)]=new webhookService_1['WebhookService']();}async[a13_0x636c9(0x1ed)](_0x15b283,_0x3ab377,_0x12d915,_0xe3d35c){const _0x123189=a13_0x636c9,_0x1b4caf=Date[_0x123189(0x20e)]();try{const _0x28b263=_0x15b283[_0x123189(0x202)],_0x131c7a=_0x28b263['settings'];if(!_0x131c7a?.['webhookUrl']){console[_0x123189(0x256)](_0x123189(0x227)+_0x28b263['id']);return;}const _0x49b845=_0x3ab377==='PAID'?'payment.success':'payment.failed';let _0x269bbc=[];if(_0x131c7a[_0x123189(0x25b)])try{_0x269bbc=Array[_0x123189(0x24f)](_0x131c7a[_0x123189(0x25b)])?_0x131c7a[_0x123189(0x25b)]:JSON[_0x123189(0x1fc)](_0x131c7a['webhookEvents']);}catch(_0x3ea8a5){console[_0x123189(0x240)]('Error\x20parsing\x20webhook\x20events:',_0x3ea8a5),_0x269bbc=[];}if(!_0x269bbc[_0x123189(0x20d)](_0x49b845)){console['log']('Webhook\x20event\x20'+_0x49b845+'\x20not\x20enabled\x20for\x20shop\x20'+_0x28b263['id']);return;}const _0x5b3c78={'event':_0x49b845,'payment':{'id':_0x15b283['id'],'order_id':_0x15b283[_0x123189(0x1f9)],'gateway_order_id':_0x15b283[_0x123189(0x209)],'gateway':_0x123189(0x1f0),'amount':_0x15b283[_0x123189(0x21a)],'currency':_0x15b283[_0x123189(0x252)],'status':_0x3ab377['toLowerCase'](),'customer_email':_0x15b283['customerEmail'],'customer_name':_0x15b283[_0x123189(0x221)],'transaction_id':_0x12d915,'failure_message':_0xe3d35c,'created_at':_0x15b283[_0x123189(0x25d)],'updated_at':new Date()}},_0x462be3=await fetch(_0x131c7a[_0x123189(0x23e)],{'method':_0x123189(0x20a),'headers':{'Content-Type':_0x123189(0x22d),'User-Agent':_0x123189(0x22c)},'body':JSON[_0x123189(0x215)](_0x5b3c78)}),_0x18c068=Date[_0x123189(0x20e)]()-_0x1b4caf;console[_0x123189(0x256)](_0x123189(0x239)+_0x131c7a[_0x123189(0x23e)]+_0x123189(0x204)+_0x462be3[_0x123189(0x206)]+'\x20('+_0x18c068+_0x123189(0x1fb));}catch(_0x4a701c){console[_0x123189(0x240)](_0x123189(0x25a),_0x4a701c);}}async[a13_0x636c9(0x244)](_0x40b68a,_0x50d136){const _0x47ccca=a13_0x636c9;try{const {telegramBotService:_0x4eb817}=await Promise[_0x47ccca(0x1f7)]()[_0x47ccca(0x21b)](()=>__importStar(require(_0x47ccca(0x224)))),_0x599a56={'PAID':'paid','FAILED':_0x47ccca(0x216)},_0x8f7d24=_0x599a56[_0x50d136];if(!_0x8f7d24)return;await _0x4eb817['sendPaymentNotification'](_0x40b68a['shopId'],_0x40b68a,_0x8f7d24);}catch(_0x16f339){console[_0x47ccca(0x240)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x16f339);}}}function a13_0x470b(){const _0x57062c=['36012chwHsM','defineProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','currentPayments','transactionId','body','test_card','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','application/json','FAILED','6614kLXBCo','Payment\x20not\x20found','type','SINGLE','📈\x20Found\x20payment\x20link\x20','__setModuleDefault','update','slice','gateway','paidAt','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','cardLast4','cardNumber','PAID','webhookUrl','$transaction','error','writable','📈\x20Test\x20Gateway:\x20Payment\x20','getOwnPropertyNames','sendPaymentStatusNotification','processCardPayment','12csNpbK','Any\x20other\x20card\x20number','2585744cfbmqO','261189oCkpZL','__importDefault','\x20processed:\x20','✅\x20Payment\x20link\x20','default',',\x20currentPayments=','isArray','Any\x203-4\x20digits','Any\x20future\x20date\x20(MM/YY)','currency','configurable','test_gateway','PENDING','log','Payment\x20failed','successUrl','19254SdsfDQ','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookEvents','shopId','createdAt','get','replace','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','❌\x20Payment\x20link\x20','Payment\x20status\x20is\x20','json','TestGatewayService','__createBinding','Payment\x20to\x20','1513792yruBQX','getPaymentForm','sendShopWebhook','__esModule','2tcFNOn','0000','webhookService','getOwnPropertyDescriptor','processCard','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','toISOString','✅\x20Test\x20Gateway\x20payment\x20','resolve','create','orderId','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','ms)','parse','paymentLinkId','length','paymentLink','params','TestGatewayController','shop','failureReason','\x20with\x20status\x20','paymentMethod','status','../config/database','100OixRkl','gatewayOrderId','POST','payment','findUnique','includes','now','4242\x204242\x204242\x204242','name','testGatewayService','44oLrrUJ','prototype','🧪\x20Test\x20Gateway\x20result:','stringify','failed','call',',\x20cannot\x20process','COMPLETED','amount','then','1118500ElAeDh','../services/gateways/testGatewayService',',\x20status=','gatewayPaymentId',':\x20type=','customerName','\x20->\x20','__importStar','../services/telegramBotService'];a13_0x470b=function(){return _0x57062c;};return a13_0x470b();}exports['TestGatewayController']=TestGatewayController;