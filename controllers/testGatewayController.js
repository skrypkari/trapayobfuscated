'use strict';const a13_0x133801=a13_0x2dd9;(function(_0x2704e4,_0x103127){const _0x1f5ead=a13_0x2dd9,_0x51e38e=_0x2704e4();while(!![]){try{const _0x44ef5c=parseInt(_0x1f5ead(0x177))/0x1+parseInt(_0x1f5ead(0x13d))/0x2+parseInt(_0x1f5ead(0x15e))/0x3*(parseInt(_0x1f5ead(0x179))/0x4)+parseInt(_0x1f5ead(0x139))/0x5*(parseInt(_0x1f5ead(0x160))/0x6)+-parseInt(_0x1f5ead(0x12f))/0x7+-parseInt(_0x1f5ead(0x15f))/0x8*(-parseInt(_0x1f5ead(0x149))/0x9)+parseInt(_0x1f5ead(0x166))/0xa*(-parseInt(_0x1f5ead(0x133))/0xb);if(_0x44ef5c===_0x103127)break;else _0x51e38e['push'](_0x51e38e['shift']());}catch(_0x402f8c){_0x51e38e['push'](_0x51e38e['shift']());}}}(a13_0x167e,0x56383));var __createBinding=this&&this['__createBinding']||(Object[a13_0x133801(0x169)]?function(_0x558890,_0x4f93b2,_0x417429,_0x28f493){const _0x536079=a13_0x133801;if(_0x28f493===undefined)_0x28f493=_0x417429;var _0x31d639=Object['getOwnPropertyDescriptor'](_0x4f93b2,_0x417429);(!_0x31d639||(_0x536079(0x136)in _0x31d639?!_0x4f93b2[_0x536079(0x134)]:_0x31d639['writable']||_0x31d639[_0x536079(0x16b)]))&&(_0x31d639={'enumerable':!![],'get':function(){return _0x4f93b2[_0x417429];}}),Object['defineProperty'](_0x558890,_0x28f493,_0x31d639);}:function(_0x488382,_0x99af5c,_0x4ae3db,_0x38e3d4){if(_0x38e3d4===undefined)_0x38e3d4=_0x4ae3db;_0x488382[_0x38e3d4]=_0x99af5c[_0x4ae3db];}),__setModuleDefault=this&&this[a13_0x133801(0x11b)]||(Object[a13_0x133801(0x169)]?function(_0x38148c,_0x3049ce){const _0x323a5f=a13_0x133801;Object['defineProperty'](_0x38148c,_0x323a5f(0x141),{'enumerable':!![],'value':_0x3049ce});}:function(_0x49d4a,_0x1c670e){const _0x1a2122=a13_0x133801;_0x49d4a[_0x1a2122(0x141)]=_0x1c670e;}),__importStar=this&&this['__importStar']||(function(){var _0x192bc3=function(_0x2089f1){return _0x192bc3=Object['getOwnPropertyNames']||function(_0x32281e){const _0x53677a=a13_0x2dd9;var _0xea7a8d=[];for(var _0x2c63e3 in _0x32281e)if(Object[_0x53677a(0x163)][_0x53677a(0x15c)]['call'](_0x32281e,_0x2c63e3))_0xea7a8d[_0xea7a8d[_0x53677a(0x17d)]]=_0x2c63e3;return _0xea7a8d;},_0x192bc3(_0x2089f1);};return function(_0x40b6d8){const _0x5adeaf=a13_0x2dd9;if(_0x40b6d8&&_0x40b6d8[_0x5adeaf(0x134)])return _0x40b6d8;var _0x412cab={};if(_0x40b6d8!=null){for(var _0x4d374=_0x192bc3(_0x40b6d8),_0x57f6f0=0x0;_0x57f6f0<_0x4d374[_0x5adeaf(0x17d)];_0x57f6f0++)if(_0x4d374[_0x57f6f0]!==_0x5adeaf(0x141))__createBinding(_0x412cab,_0x40b6d8,_0x4d374[_0x57f6f0]);}return __setModuleDefault(_0x412cab,_0x40b6d8),_0x412cab;};}()),__importDefault=this&&this[a13_0x133801(0x14d)]||function(_0x16d86e){const _0x54516d=a13_0x133801;return _0x16d86e&&_0x16d86e[_0x54516d(0x134)]?_0x16d86e:{'default':_0x16d86e};};function a13_0x2dd9(_0x488831,_0x2523fd){const _0x167ed8=a13_0x167e();return a13_0x2dd9=function(_0x2dd9e2,_0x3688b1){_0x2dd9e2=_0x2dd9e2-0x11a;let _0x2facc6=_0x167ed8[_0x2dd9e2];return _0x2facc6;},a13_0x2dd9(_0x488831,_0x2523fd);}Object[a13_0x133801(0x16f)](exports,'__esModule',{'value':!![]}),exports[a13_0x133801(0x12a)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x133801(0x183)),database_1=__importDefault(require(a13_0x133801(0x165)));class TestGatewayController{constructor(){const _0xa3a5d2=a13_0x133801;this[_0xa3a5d2(0x17a)]=async(_0xee954e,_0x5d7dd1,_0x2e157d)=>{const _0x3897c7=_0xa3a5d2;try{const {paymentId:_0x134be6}=_0xee954e['params'];console[_0x3897c7(0x140)](_0x3897c7(0x153)+_0x134be6);const _0x1a4957=await database_1[_0x3897c7(0x141)][_0x3897c7(0x12b)]['findUnique']({'where':{'id':_0x134be6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1a4957)return _0x5d7dd1[_0x3897c7(0x11f)](0x194)[_0x3897c7(0x151)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1a4957[_0x3897c7(0x12e)]!=='test_gateway')return _0x5d7dd1[_0x3897c7(0x11f)](0x190)['json']({'success':![],'message':_0x3897c7(0x17f)});if(_0x1a4957[_0x3897c7(0x11f)]!==_0x3897c7(0x123))return _0x5d7dd1[_0x3897c7(0x11f)](0x190)[_0x3897c7(0x151)]({'success':![],'message':_0x3897c7(0x11a)+_0x1a4957[_0x3897c7(0x11f)]+_0x3897c7(0x14b)});_0x5d7dd1[_0x3897c7(0x151)]({'success':!![],'result':{'paymentId':_0x1a4957['id'],'orderId':_0x1a4957[_0x3897c7(0x155)],'amount':_0x1a4957['amount'],'currency':_0x1a4957['currency'],'merchantName':_0x1a4957['shop']['name'],'description':_0x3897c7(0x145)+_0x1a4957[_0x3897c7(0x15d)][_0x3897c7(0x143)],'testInstructions':{'successCard':_0x3897c7(0x131),'failureCard':_0x3897c7(0x128),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x3897c7(0x158),'holderName':_0x3897c7(0x150)}}});}catch(_0x2b32b0){_0x2e157d(_0x2b32b0);}},this[_0xa3a5d2(0x11e)]=async(_0x26809c,_0x4464ef,_0x2dc3bf)=>{const _0x48f7b4=_0xa3a5d2;try{const {paymentId:_0x426fb4}=_0x26809c[_0x48f7b4(0x144)],_0x1b4a8a=_0x26809c[_0x48f7b4(0x13c)];console[_0x48f7b4(0x140)](_0x48f7b4(0x137)+_0x426fb4);const _0x577cbb=await database_1[_0x48f7b4(0x141)][_0x48f7b4(0x12b)][_0x48f7b4(0x14a)]({'where':{'id':_0x426fb4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x577cbb)return _0x4464ef[_0x48f7b4(0x11f)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x577cbb[_0x48f7b4(0x12e)]!==_0x48f7b4(0x11c))return _0x4464ef[_0x48f7b4(0x11f)](0x190)[_0x48f7b4(0x151)]({'success':![],'message':_0x48f7b4(0x17f)});if(_0x577cbb[_0x48f7b4(0x11f)]!=='PENDING')return _0x4464ef['status'](0x190)[_0x48f7b4(0x151)]({'success':![],'message':_0x48f7b4(0x11a)+_0x577cbb[_0x48f7b4(0x11f)]+_0x48f7b4(0x14b)});const _0xf8eb4f=await this[_0x48f7b4(0x146)][_0x48f7b4(0x148)]({'paymentId':_0x577cbb['id'],'orderId':_0x577cbb[_0x48f7b4(0x155)]||_0x577cbb['id'],'amount':_0x577cbb[_0x48f7b4(0x17c)],'currency':_0x577cbb[_0x48f7b4(0x13a)],'cardData':_0x1b4a8a});console[_0x48f7b4(0x140)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0xf8eb4f);const _0x11c856={'status':_0xf8eb4f['status'],'updatedAt':new Date()};if(_0xf8eb4f[_0x48f7b4(0x11f)]===_0x48f7b4(0x14e))_0x11c856[_0x48f7b4(0x154)]=new Date(),_0x11c856[_0x48f7b4(0x173)]=_0xf8eb4f[_0x48f7b4(0x11d)];else _0xf8eb4f[_0x48f7b4(0x11f)]===_0x48f7b4(0x176)&&(_0x11c856[_0x48f7b4(0x152)]=_0xf8eb4f[_0x48f7b4(0x164)]);const _0x1b0324=_0x1b4a8a[_0x48f7b4(0x132)][_0x48f7b4(0x15b)](/[\s-]/g,'');_0x11c856[_0x48f7b4(0x181)]=_0x1b0324['slice'](-0x4),_0x11c856[_0x48f7b4(0x16e)]=_0x48f7b4(0x172),await database_1[_0x48f7b4(0x141)][_0x48f7b4(0x12b)][_0x48f7b4(0x167)]({'where':{'id':_0x577cbb['id']},'data':_0x11c856}),await database_1[_0x48f7b4(0x141)][_0x48f7b4(0x161)]['create']({'data':{'paymentId':_0x577cbb['id'],'shopId':_0x577cbb['shopId'],'event':'test_gateway_'+_0xf8eb4f[_0x48f7b4(0x11f)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x48f7b4(0x180)]({'oldStatus':_0x48f7b4(0x123),'newStatus':_0xf8eb4f[_0x48f7b4(0x11f)],'transactionId':_0xf8eb4f['transactionId'],'failureReason':_0xf8eb4f[_0x48f7b4(0x164)],'processedAt':new Date()[_0x48f7b4(0x16a)]()})}}),await this[_0x48f7b4(0x120)](_0x577cbb,_0xf8eb4f['status'],_0xf8eb4f[_0x48f7b4(0x11d)],_0xf8eb4f['failureReason']),await this[_0x48f7b4(0x14f)](_0x577cbb,_0xf8eb4f[_0x48f7b4(0x11f)]),console[_0x48f7b4(0x140)](_0x48f7b4(0x16c)+_0x426fb4+_0x48f7b4(0x129)+_0xf8eb4f[_0x48f7b4(0x11f)]),_0xf8eb4f['status']===_0x48f7b4(0x14e)?_0x4464ef[_0x48f7b4(0x151)]({'success':!![],'message':_0x48f7b4(0x127),'result':{'status':'PAID','transactionId':_0xf8eb4f[_0x48f7b4(0x11d)],'redirectUrl':_0x577cbb[_0x48f7b4(0x142)]}}):_0x4464ef[_0x48f7b4(0x11f)](0x190)[_0x48f7b4(0x151)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x48f7b4(0x176),'failureReason':_0xf8eb4f[_0x48f7b4(0x164)],'redirectUrl':_0x577cbb[_0x48f7b4(0x122)]}});}catch(_0xe57fb4){_0x2dc3bf(_0xe57fb4);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0xa3a5d2(0x12c)]=new webhookService_1[(_0xa3a5d2(0x174))]();}async[a13_0x133801(0x120)](_0x2be91b,_0x3f8301,_0x145beb,_0x2b39d1){const _0x1e5e4b=a13_0x133801,_0xbbda3e=Date['now']();try{const _0xc436a9=_0x2be91b[_0x1e5e4b(0x15d)],_0x365d18=_0xc436a9[_0x1e5e4b(0x159)];if(!_0x365d18?.['webhookUrl']){console[_0x1e5e4b(0x140)](_0x1e5e4b(0x147)+_0xc436a9['id']);return;}const _0x499bf7=_0x3f8301===_0x1e5e4b(0x14e)?'payment.success':_0x1e5e4b(0x157);let _0x1ba664=[];if(_0x365d18[_0x1e5e4b(0x13b)])try{_0x1ba664=Array[_0x1e5e4b(0x162)](_0x365d18['webhookEvents'])?_0x365d18[_0x1e5e4b(0x13b)]:JSON['parse'](_0x365d18['webhookEvents']);}catch(_0x263358){console[_0x1e5e4b(0x13f)](_0x1e5e4b(0x178),_0x263358),_0x1ba664=[];}if(!_0x1ba664[_0x1e5e4b(0x126)](_0x499bf7)){console[_0x1e5e4b(0x140)](_0x1e5e4b(0x130)+_0x499bf7+'\x20not\x20enabled\x20for\x20shop\x20'+_0xc436a9['id']);return;}const _0x51d5b6={'event':_0x499bf7,'payment':{'id':_0x2be91b['id'],'order_id':_0x2be91b[_0x1e5e4b(0x138)],'gateway_order_id':_0x2be91b[_0x1e5e4b(0x155)],'gateway':_0x1e5e4b(0x175),'amount':_0x2be91b[_0x1e5e4b(0x17c)],'currency':_0x2be91b[_0x1e5e4b(0x13a)],'status':_0x3f8301[_0x1e5e4b(0x135)](),'customer_email':_0x2be91b[_0x1e5e4b(0x14c)],'customer_name':_0x2be91b['customerName'],'transaction_id':_0x145beb,'failure_message':_0x2b39d1,'created_at':_0x2be91b[_0x1e5e4b(0x125)],'updated_at':new Date()}},_0x27486d=await fetch(_0x365d18['webhookUrl'],{'method':_0x1e5e4b(0x17e),'headers':{'Content-Type':_0x1e5e4b(0x17b),'User-Agent':_0x1e5e4b(0x121)},'body':JSON['stringify'](_0x51d5b6)}),_0x5aae10=Date[_0x1e5e4b(0x168)]()-_0xbbda3e;console[_0x1e5e4b(0x140)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x365d18[_0x1e5e4b(0x171)]+'\x20with\x20status\x20'+_0x27486d[_0x1e5e4b(0x11f)]+'\x20('+_0x5aae10+_0x1e5e4b(0x182));}catch(_0x61cf4){console[_0x1e5e4b(0x13f)](_0x1e5e4b(0x15a),_0x61cf4);}}async[a13_0x133801(0x14f)](_0x3f301f,_0x1e2d55){const _0x58c186=a13_0x133801;try{const {telegramBotService:_0x8fd490}=await Promise[_0x58c186(0x124)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x4012ca={'PAID':_0x58c186(0x12d),'FAILED':_0x58c186(0x170)},_0x8e77bd=_0x4012ca[_0x1e2d55];if(!_0x8e77bd)return;await _0x8fd490[_0x58c186(0x13e)](_0x3f301f[_0x58c186(0x16d)],_0x3f301f,_0x8e77bd);}catch(_0x5c6090){console[_0x58c186(0x13f)](_0x58c186(0x156),_0x5c6090);}}}exports['TestGatewayController']=TestGatewayController;function a13_0x167e(){const _0x811cd=['length','POST','Payment\x20is\x20not\x20for\x20test\x20gateway','stringify','cardLast4','ms)','../services/webhookService','Payment\x20status\x20is\x20','__setModuleDefault','test_gateway','transactionId','processCard','status','sendShopWebhook','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','failUrl','PENDING','resolve','createdAt','includes','Payment\x20processed\x20successfully','Any\x20other\x20card\x20number','\x20processed:\x20','TestGatewayController','payment','webhookService','paid','gateway','3886701YFSDNE','Webhook\x20event\x20','4242\x204242\x204242\x204242','cardNumber','121XUekFB','__esModule','toLowerCase','get','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','orderId','328355nrHGme','currency','webhookEvents','body','105342YVEpss','sendPaymentNotification','error','log','default','successUrl','name','params','Payment\x20to\x20','testGatewayService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','processCardPayment','279Ulzbcg','findUnique',',\x20cannot\x20process','customerEmail','__importDefault','PAID','sendPaymentStatusNotification','Any\x20name','json','failureMessage','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','paidAt','gatewayOrderId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.failed','Any\x203-4\x20digits','settings','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','replace','hasOwnProperty','shop','24OYrWZu','62824royZXs','60UrioOF','webhookLog','isArray','prototype','failureReason','../config/database','367210ABKhKl','update','now','create','toISOString','configurable','âœ…\x20Test\x20Gateway\x20payment\x20','shopId','paymentMethod','defineProperty','failed','webhookUrl','test_card','gatewayPaymentId','WebhookService','0000','FAILED','114097OYrOrX','Error\x20parsing\x20webhook\x20events:','122704nXozpw','getPaymentForm','application/json','amount'];a13_0x167e=function(){return _0x811cd;};return a13_0x167e();}