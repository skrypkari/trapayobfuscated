'use strict';const a21_0x18826b=a21_0x3424;(function(_0x30db47,_0x355aeb){const _0xa439c0=a21_0x3424,_0x465eb2=_0x30db47();while(!![]){try{const _0x2886a7=parseInt(_0xa439c0(0xea))/0x1+parseInt(_0xa439c0(0x12f))/0x2+-parseInt(_0xa439c0(0xc6))/0x3+parseInt(_0xa439c0(0x110))/0x4*(parseInt(_0xa439c0(0x117))/0x5)+parseInt(_0xa439c0(0xad))/0x6*(parseInt(_0xa439c0(0xef))/0x7)+parseInt(_0xa439c0(0xda))/0x8*(-parseInt(_0xa439c0(0xb1))/0x9)+-parseInt(_0xa439c0(0xdf))/0xa;if(_0x2886a7===_0x355aeb)break;else _0x465eb2['push'](_0x465eb2['shift']());}catch(_0x2cbd7d){_0x465eb2['push'](_0x465eb2['shift']());}}}(a21_0x247e,0x1920f));function a21_0x3424(_0x225922,_0x29fc40){_0x225922=_0x225922-0xad;const _0x247e9a=a21_0x247e();let _0x342449=_0x247e9a[_0x225922];return _0x342449;}var __createBinding=this&&this[a21_0x18826b(0xdc)]||(Object['create']?function(_0x1800aa,_0x39ca39,_0x2b9ff6,_0x51d5ad){const _0x45a16c=a21_0x18826b;if(_0x51d5ad===undefined)_0x51d5ad=_0x2b9ff6;var _0x5d0126=Object[_0x45a16c(0xbe)](_0x39ca39,_0x2b9ff6);(!_0x5d0126||(_0x45a16c(0xb0)in _0x5d0126?!_0x39ca39[_0x45a16c(0xc0)]:_0x5d0126[_0x45a16c(0xb8)]||_0x5d0126[_0x45a16c(0xf2)]))&&(_0x5d0126={'enumerable':!![],'get':function(){return _0x39ca39[_0x2b9ff6];}}),Object[_0x45a16c(0x113)](_0x1800aa,_0x51d5ad,_0x5d0126);}:function(_0x48e6de,_0xc708f6,_0x112f1b,_0x244323){if(_0x244323===undefined)_0x244323=_0x112f1b;_0x48e6de[_0x244323]=_0xc708f6[_0x112f1b];}),__setModuleDefault=this&&this[a21_0x18826b(0xe6)]||(Object['create']?function(_0x26d340,_0x57b0ae){const _0x36bd35=a21_0x18826b;Object[_0x36bd35(0x113)](_0x26d340,_0x36bd35(0xce),{'enumerable':!![],'value':_0x57b0ae});}:function(_0x374d10,_0x20355a){const _0x474b5e=a21_0x18826b;_0x374d10[_0x474b5e(0xce)]=_0x20355a;}),__importStar=this&&this[a21_0x18826b(0x125)]||(function(){var _0x5e4d65=function(_0x284a92){const _0x4b1984=a21_0x3424;return _0x5e4d65=Object[_0x4b1984(0x114)]||function(_0x4c6fb3){const _0x2bf976=_0x4b1984;var _0x67bf02=[];for(var _0x3542be in _0x4c6fb3)if(Object[_0x2bf976(0x111)][_0x2bf976(0xe8)]['call'](_0x4c6fb3,_0x3542be))_0x67bf02[_0x67bf02[_0x2bf976(0x12b)]]=_0x3542be;return _0x67bf02;},_0x5e4d65(_0x284a92);};return function(_0x4653d2){const _0x834154=a21_0x3424;if(_0x4653d2&&_0x4653d2['__esModule'])return _0x4653d2;var _0x265593={};if(_0x4653d2!=null){for(var _0x327906=_0x5e4d65(_0x4653d2),_0x200ac6=0x0;_0x200ac6<_0x327906[_0x834154(0x12b)];_0x200ac6++)if(_0x327906[_0x200ac6]!==_0x834154(0xce))__createBinding(_0x265593,_0x4653d2,_0x327906[_0x200ac6]);}return __setModuleDefault(_0x265593,_0x4653d2),_0x265593;};}()),__importDefault=this&&this['__importDefault']||function(_0xdd1170){const _0x24aa78=a21_0x18826b;return _0xdd1170&&_0xdd1170[_0x24aa78(0xc0)]?_0xdd1170:{'default':_0xdd1170};};function a21_0x247e(){const _0x2864bd=['PAID','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','currency','findUnique','4HyGAAK','prototype','webhookUrl','defineProperty','getOwnPropertyNames','create','shop','995655DBKvrG','\x20not\x20found','hex','type','settings','then','sha256','test_card','error','not\x20configured','test_gateway_','failed','ðŸ§ª\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','ðŸ“ˆ\x20Found\x20payment\x20link\x20','__importStar','Any\x20future\x20date\x20(MM/YY)','POST','âœ…\x20Payment\x20link\x20','TestGatewayService','PENDING','length','\x20not\x20enabled\x20for\x20shop\x20','now','name','201692ejXCaf','../services/telegramBotService','toLowerCase','FAILED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','orderId','30tvJmsG','parse','webhookLog','get','132111uHjCSg','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20',',\x20status=','ðŸ§ª\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','0000','log','getPaymentForm','writable','âš ï¸\x20Webhook\x20event\x20','testGatewayService','...','toISOString','update','getOwnPropertyDescriptor','createdAt','__esModule','sendShopWebhook','Payment\x20to\x20','gatewayOrderId','../services/webhookService','payment.failed','456330ELaMbp','Any\x20other\x20card\x20number','crypto','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20',',\x20cannot\x20process','$transaction','default','âŒ\x20Payment\x20link\x20','status','configured','\x20->\x20','application/json','../config/database','test_gateway','WebhookService','paidAt','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20System/1.0\x20(Test\x20Gateway)','8qMqrXZ','\x20processed:\x20','__createBinding','paymentLink','createHmac','1905930iSILvN','COMPLETED','shopId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','secretKey','Payment\x20is\x20not\x20for\x20test\x20gateway','failUrl','__setModuleDefault','json','hasOwnProperty','ms)','54972sQDnFd','failureMessage','transactionId','payment.success','processCardPayment','147504LNOOBt','paid','Payment\x20status\x20is\x20','configurable','ðŸ§ª\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','TestGatewayController','currentPayments','ðŸ§ª\x20Webhook\x20payload:','âœ…\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','includes','webhookEvents','isArray','Payment\x20not\x20found',',\x20currentPayments=','payment','resolve','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','successUrl','slice','failureReason','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','amount','customerName','SINGLE','params','Any\x203-4\x20digits','gateway','sendPaymentNotification','paymentLinkId'];a21_0x247e=function(){return _0x2864bd;};return a21_0x247e();}Object['defineProperty'](exports,a21_0x18826b(0xc0),{'value':!![]}),exports[a21_0x18826b(0xf4)]=void 0x0;const crypto_1=__importDefault(require(a21_0x18826b(0xc8))),testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a21_0x18826b(0xc4)),database_1=__importDefault(require(a21_0x18826b(0xd4)));class TestGatewayController{constructor(){const _0x3943ed=a21_0x18826b;this[_0x3943ed(0xb7)]=async(_0x2bb45f,_0x23b241,_0x210a47)=>{const _0x419aed=_0x3943ed;try{const {paymentId:_0x19ec14}=_0x2bb45f[_0x419aed(0x107)];console[_0x419aed(0xb6)](_0x419aed(0x103)+_0x19ec14);const _0x38f2c3=await database_1['default'][_0x419aed(0xfd)][_0x419aed(0x10f)]({'where':{'id':_0x19ec14},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x38f2c3)return _0x23b241[_0x419aed(0xd0)](0x194)['json']({'success':![],'message':_0x419aed(0xfb)});if(_0x38f2c3[_0x419aed(0x109)]!==_0x419aed(0xd5))return _0x23b241[_0x419aed(0xd0)](0x190)[_0x419aed(0xe7)]({'success':![],'message':_0x419aed(0xe4)});if(_0x38f2c3[_0x419aed(0xd0)]!==_0x419aed(0x12a))return _0x23b241[_0x419aed(0xd0)](0x190)[_0x419aed(0xe7)]({'success':![],'message':_0x419aed(0xf1)+_0x38f2c3[_0x419aed(0xd0)]+_0x419aed(0xcc)});_0x23b241['json']({'success':!![],'result':{'paymentId':_0x38f2c3['id'],'orderId':_0x38f2c3[_0x419aed(0xc3)],'amount':_0x38f2c3['amount'],'currency':_0x38f2c3[_0x419aed(0x10e)],'merchantName':_0x38f2c3[_0x419aed(0x116)][_0x419aed(0x12e)],'description':_0x419aed(0xc2)+_0x38f2c3[_0x419aed(0x116)][_0x419aed(0x12e)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x419aed(0xc7),'expiryDate':_0x419aed(0x126),'cvc':_0x419aed(0x108),'holderName':'Any\x20name'}}});}catch(_0x407127){_0x210a47(_0x407127);}},this['processCard']=async(_0x47a2ba,_0x5adfd8,_0x38736a)=>{const _0x3a2163=_0x3943ed;try{const {paymentId:_0x1f9681}=_0x47a2ba[_0x3a2163(0x107)],_0x2734f0=_0x47a2ba['body'];console[_0x3a2163(0xb6)](_0x3a2163(0xff)+_0x1f9681);const _0x4fb76b=await database_1[_0x3a2163(0xce)][_0x3a2163(0xfd)][_0x3a2163(0x10f)]({'where':{'id':_0x1f9681},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4fb76b)return _0x5adfd8[_0x3a2163(0xd0)](0x194)[_0x3a2163(0xe7)]({'success':![],'message':_0x3a2163(0xfb)});if(_0x4fb76b['gateway']!==_0x3a2163(0xd5))return _0x5adfd8['status'](0x190)[_0x3a2163(0xe7)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4fb76b[_0x3a2163(0xd0)]!=='PENDING')return _0x5adfd8[_0x3a2163(0xd0)](0x190)[_0x3a2163(0xe7)]({'success':![],'message':_0x3a2163(0xf1)+_0x4fb76b[_0x3a2163(0xd0)]+_0x3a2163(0xcc)});const _0x428f14=await this[_0x3a2163(0xba)][_0x3a2163(0xee)]({'paymentId':_0x4fb76b['id'],'orderId':_0x4fb76b[_0x3a2163(0xc3)]||_0x4fb76b['id'],'amount':_0x4fb76b[_0x3a2163(0x104)],'currency':_0x4fb76b[_0x3a2163(0x10e)],'cardData':_0x2734f0});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x428f14);const _0x20573a={'status':_0x428f14['status'],'updatedAt':new Date()};if(_0x428f14[_0x3a2163(0xd0)]===_0x3a2163(0x10c))_0x20573a[_0x3a2163(0xd7)]=new Date(),_0x20573a[_0x3a2163(0xc9)]=_0x428f14[_0x3a2163(0xec)];else _0x428f14['status']===_0x3a2163(0x132)&&(_0x20573a[_0x3a2163(0xeb)]=_0x428f14[_0x3a2163(0x102)]);const _0x2b48d0=_0x2734f0['cardNumber']['replace'](/[\s-]/g,'');_0x20573a['cardLast4']=_0x2b48d0[_0x3a2163(0x101)](-0x4),_0x20573a['paymentMethod']=_0x3a2163(0x11e),await database_1[_0x3a2163(0xce)][_0x3a2163(0xfd)][_0x3a2163(0xbd)]({'where':{'id':_0x4fb76b['id']},'data':_0x20573a});if(_0x428f14[_0x3a2163(0xd0)]===_0x3a2163(0x10c)&&_0x4fb76b['paymentLinkId']){console['log'](_0x3a2163(0xcb)+_0x4fb76b['id']+_0x3a2163(0x10d));try{await database_1[_0x3a2163(0xce)][_0x3a2163(0xcd)](async _0x1aa869=>{const _0x5eef41=_0x3a2163,_0x150ac7=await _0x1aa869[_0x5eef41(0xdd)][_0x5eef41(0x10f)]({'where':{'id':_0x4fb76b['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x150ac7){console['log'](_0x5eef41(0x124)+_0x150ac7['id']+':\x20type='+_0x150ac7[_0x5eef41(0x11a)]+_0x5eef41(0xfc)+_0x150ac7[_0x5eef41(0xf5)]+',\x20status='+_0x150ac7[_0x5eef41(0xd0)]);const _0x40fe6d=_0x150ac7[_0x5eef41(0xf5)]+0x1,_0x1dd719=_0x150ac7[_0x5eef41(0x11a)]===_0x5eef41(0x106)?_0x5eef41(0xe0):_0x150ac7['status'];await _0x1aa869[_0x5eef41(0xdd)][_0x5eef41(0xbd)]({'where':{'id':_0x4fb76b[_0x5eef41(0x10b)]},'data':{'currentPayments':_0x40fe6d,'status':_0x1dd719,'updatedAt':new Date()}}),console[_0x5eef41(0xb6)](_0x5eef41(0x128)+_0x150ac7['id']+'\x20updated:\x20currentPayments='+_0x150ac7[_0x5eef41(0xf5)]+_0x5eef41(0xd2)+_0x40fe6d+_0x5eef41(0xb3)+_0x150ac7[_0x5eef41(0xd0)]+_0x5eef41(0xd2)+_0x1dd719);}else console[_0x5eef41(0xb6)](_0x5eef41(0xcf)+_0x4fb76b[_0x5eef41(0x10b)]+_0x5eef41(0x118));});}catch(_0x5bf8a5){console['error']('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x5bf8a5);}}await database_1[_0x3a2163(0xce)][_0x3a2163(0xaf)][_0x3a2163(0x115)]({'data':{'paymentId':_0x4fb76b['id'],'shopId':_0x4fb76b['shopId'],'event':_0x3a2163(0x121)+_0x428f14[_0x3a2163(0xd0)][_0x3a2163(0x131)](),'statusCode':_0x428f14[_0x3a2163(0xd0)]===_0x3a2163(0x10c)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':_0x3a2163(0x12a),'newStatus':_0x428f14['status'],'transactionId':_0x428f14[_0x3a2163(0xec)],'failureReason':_0x428f14[_0x3a2163(0x102)],'processedAt':new Date()[_0x3a2163(0xbc)]()})}}),console[_0x3a2163(0xb6)](_0x3a2163(0xb2)+_0x428f14[_0x3a2163(0xd0)]+'...'),await this[_0x3a2163(0xc1)](_0x4fb76b,_0x428f14[_0x3a2163(0xd0)],_0x428f14[_0x3a2163(0xec)],_0x428f14[_0x3a2163(0x102)]),console['log'](_0x3a2163(0xca)+_0x428f14[_0x3a2163(0xd0)]),console['log'](_0x3a2163(0xf3)+_0x428f14[_0x3a2163(0xd0)]+_0x3a2163(0xbb)),await this['sendPaymentStatusNotification'](_0x4fb76b,_0x428f14[_0x3a2163(0xd0)]),console[_0x3a2163(0xb6)](_0x3a2163(0x123)+_0x428f14[_0x3a2163(0xd0)]),console[_0x3a2163(0xb6)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x1f9681+_0x3a2163(0xdb)+_0x428f14[_0x3a2163(0xd0)]),_0x428f14[_0x3a2163(0xd0)]===_0x3a2163(0x10c)?_0x5adfd8['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x428f14[_0x3a2163(0xec)],'redirectUrl':_0x4fb76b[_0x3a2163(0x100)]}}):_0x5adfd8['status'](0x190)[_0x3a2163(0xe7)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x3a2163(0x132),'failureReason':_0x428f14[_0x3a2163(0x102)],'redirectUrl':_0x4fb76b[_0x3a2163(0xe5)]}});}catch(_0x40d104){_0x38736a(_0x40d104);}},this[_0x3943ed(0xba)]=new testGatewayService_1[(_0x3943ed(0x129))](),this['webhookService']=new webhookService_1[(_0x3943ed(0xd6))]();}async[a21_0x18826b(0xc1)](_0x564e72,_0x13066c,_0x5929ea,_0x3c8ffd){const _0xfe09bc=a21_0x18826b,_0x31423e=Date[_0xfe09bc(0x12d)]();try{const _0x567fa5=_0x564e72[_0xfe09bc(0x116)],_0x286a98=_0x567fa5[_0xfe09bc(0x11b)];if(!_0x286a98?.[_0xfe09bc(0x112)]){console['log'](_0xfe09bc(0xe2)+_0x567fa5['id']);return;}const _0x1394e5=_0x13066c===_0xfe09bc(0x10c)?_0xfe09bc(0xed):_0xfe09bc(0xc5);console[_0xfe09bc(0xb6)]('ðŸ§ª\x20Test\x20Gateway\x20webhook:\x20event='+_0x1394e5+',\x20webhookUrl='+(_0x286a98[_0xfe09bc(0x112)]?_0xfe09bc(0xd1):_0xfe09bc(0x120)));let _0x5f11d0=[];if(_0x286a98[_0xfe09bc(0xf9)])try{_0x5f11d0=Array[_0xfe09bc(0xfa)](_0x286a98[_0xfe09bc(0xf9)])?_0x286a98['webhookEvents']:JSON[_0xfe09bc(0xae)](_0x286a98[_0xfe09bc(0xf9)]);}catch(_0x2920d6){console[_0xfe09bc(0x11f)]('Error\x20parsing\x20webhook\x20events:',_0x2920d6),_0x5f11d0=[];}console['log'](_0xfe09bc(0xb4),_0x5f11d0);if(!_0x5f11d0[_0xfe09bc(0xf8)](_0x1394e5)){console['log'](_0xfe09bc(0xb9)+_0x1394e5+_0xfe09bc(0x12c)+_0x567fa5['id']);return;}const _0x409770={'event':_0x1394e5,'payment':{'id':_0x564e72['id'],'order_id':_0x564e72[_0xfe09bc(0x134)],'gateway_order_id':_0x564e72['gatewayOrderId'],'gateway':_0xfe09bc(0xb5),'amount':_0x564e72[_0xfe09bc(0x104)],'currency':_0x564e72[_0xfe09bc(0x10e)],'status':_0x13066c[_0xfe09bc(0x131)](),'customer_email':_0x564e72['customerEmail'],'customer_name':_0x564e72[_0xfe09bc(0x105)],'transaction_id':_0x5929ea,'failure_message':_0x3c8ffd,'created_at':_0x564e72[_0xfe09bc(0xbf)],'updated_at':new Date()}};console[_0xfe09bc(0xb6)]('ðŸ§ª\x20Sending\x20webhook\x20to\x20'+_0x286a98[_0xfe09bc(0x112)]+_0xfe09bc(0xbb)),console[_0xfe09bc(0xb6)](_0xfe09bc(0xf6),JSON['stringify'](_0x409770,null,0x2));const _0x3bdb19=JSON['stringify'](_0x409770),_0x4558d6=crypto_1[_0xfe09bc(0xce)][_0xfe09bc(0xde)](_0xfe09bc(0x11d),_0x567fa5[_0xfe09bc(0xe3)])[_0xfe09bc(0xbd)](_0x3bdb19)['digest'](_0xfe09bc(0x119)),_0x483901=await fetch(_0x286a98['webhookUrl'],{'method':_0xfe09bc(0x127),'headers':{'Content-Type':_0xfe09bc(0xd3),'User-Agent':_0xfe09bc(0xd9),'X-Webhook-Signature':_0x4558d6},'body':_0x3bdb19}),_0x3a4ff9=Date['now']()-_0x31423e;console[_0xfe09bc(0xb6)](_0xfe09bc(0xf7)+_0x286a98[_0xfe09bc(0x112)]+'\x20with\x20status\x20'+_0x483901['status']+'\x20('+_0x3a4ff9+_0xfe09bc(0xe9));}catch(_0x9e8bba){console[_0xfe09bc(0x11f)](_0xfe09bc(0xd8),_0x9e8bba);}}async['sendPaymentStatusNotification'](_0x47d306,_0x258bb6){const _0x522b76=a21_0x18826b;try{const {telegramBotService:_0x55467e}=await Promise[_0x522b76(0xfe)]()[_0x522b76(0x11c)](()=>__importStar(require(_0x522b76(0x130)))),_0x5dc5fa={'PAID':_0x522b76(0xf0),'FAILED':_0x522b76(0x122)},_0x31a965=_0x5dc5fa[_0x258bb6];if(!_0x31a965)return;await _0x55467e[_0x522b76(0x10a)](_0x47d306[_0x522b76(0xe1)],_0x47d306,_0x31a965);}catch(_0x5d31bf){console[_0x522b76(0x11f)](_0x522b76(0x133),_0x5d31bf);}}}exports[a21_0x18826b(0xf4)]=TestGatewayController;