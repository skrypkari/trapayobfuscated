'use strict';function a13_0x10b5(_0x56fd43,_0x23ce5d){const _0x20488e=a13_0x2048();return a13_0x10b5=function(_0x10b591,_0x57b93c){_0x10b591=_0x10b591-0x153;let _0x5b2a11=_0x20488e[_0x10b591];return _0x5b2a11;},a13_0x10b5(_0x56fd43,_0x23ce5d);}const a13_0x1c0efc=a13_0x10b5;(function(_0x4b8fb9,_0x48f696){const _0x58ff1b=a13_0x10b5,_0x4c1688=_0x4b8fb9();while(!![]){try{const _0x3d5009=parseInt(_0x58ff1b(0x188))/0x1*(-parseInt(_0x58ff1b(0x16e))/0x2)+-parseInt(_0x58ff1b(0x1b2))/0x3*(-parseInt(_0x58ff1b(0x16c))/0x4)+parseInt(_0x58ff1b(0x19f))/0x5+-parseInt(_0x58ff1b(0x1b1))/0x6*(parseInt(_0x58ff1b(0x195))/0x7)+-parseInt(_0x58ff1b(0x163))/0x8*(parseInt(_0x58ff1b(0x191))/0x9)+parseInt(_0x58ff1b(0x1b4))/0xa+-parseInt(_0x58ff1b(0x166))/0xb;if(_0x3d5009===_0x48f696)break;else _0x4c1688['push'](_0x4c1688['shift']());}catch(_0x109c90){_0x4c1688['push'](_0x4c1688['shift']());}}}(a13_0x2048,0xc8675));var __createBinding=this&&this[a13_0x1c0efc(0x1b0)]||(Object[a13_0x1c0efc(0x189)]?function(_0x2f326c,_0x4b101f,_0x38e169,_0x5819c6){const _0x75dfe9=a13_0x1c0efc;if(_0x5819c6===undefined)_0x5819c6=_0x38e169;var _0x98cbdc=Object[_0x75dfe9(0x15e)](_0x4b101f,_0x38e169);(!_0x98cbdc||(_0x75dfe9(0x182)in _0x98cbdc?!_0x4b101f['__esModule']:_0x98cbdc[_0x75dfe9(0x1a1)]||_0x98cbdc['configurable']))&&(_0x98cbdc={'enumerable':!![],'get':function(){return _0x4b101f[_0x38e169];}}),Object[_0x75dfe9(0x1b3)](_0x2f326c,_0x5819c6,_0x98cbdc);}:function(_0x44b817,_0x2d3e1c,_0x65349d,_0x58127e){if(_0x58127e===undefined)_0x58127e=_0x65349d;_0x44b817[_0x58127e]=_0x2d3e1c[_0x65349d];}),__setModuleDefault=this&&this[a13_0x1c0efc(0x167)]||(Object['create']?function(_0xba3cd0,_0x165727){const _0x3ce0d6=a13_0x1c0efc;Object['defineProperty'](_0xba3cd0,_0x3ce0d6(0x18b),{'enumerable':!![],'value':_0x165727});}:function(_0x29737c,_0x33f3df){const _0x9ed26d=a13_0x1c0efc;_0x29737c[_0x9ed26d(0x18b)]=_0x33f3df;}),__importStar=this&&this['__importStar']||(function(){var _0x157ced=function(_0x334005){return _0x157ced=Object['getOwnPropertyNames']||function(_0x33e157){const _0x525884=a13_0x10b5;var _0x4c8285=[];for(var _0x3620ea in _0x33e157)if(Object[_0x525884(0x17e)][_0x525884(0x199)][_0x525884(0x177)](_0x33e157,_0x3620ea))_0x4c8285[_0x4c8285['length']]=_0x3620ea;return _0x4c8285;},_0x157ced(_0x334005);};return function(_0x3d7709){const _0x587f61=a13_0x10b5;if(_0x3d7709&&_0x3d7709[_0x587f61(0x161)])return _0x3d7709;var _0x27b99a={};if(_0x3d7709!=null){for(var _0x4cc0f4=_0x157ced(_0x3d7709),_0x3bbc0e=0x0;_0x3bbc0e<_0x4cc0f4[_0x587f61(0x162)];_0x3bbc0e++)if(_0x4cc0f4[_0x3bbc0e]!==_0x587f61(0x18b))__createBinding(_0x27b99a,_0x3d7709,_0x4cc0f4[_0x3bbc0e]);}return __setModuleDefault(_0x27b99a,_0x3d7709),_0x27b99a;};}()),__importDefault=this&&this[a13_0x1c0efc(0x18e)]||function(_0x10f0be){const _0x44b11f=a13_0x1c0efc;return _0x10f0be&&_0x10f0be[_0x44b11f(0x161)]?_0x10f0be:{'default':_0x10f0be};};Object[a13_0x1c0efc(0x1b3)](exports,a13_0x1c0efc(0x161),{'value':!![]}),exports[a13_0x1c0efc(0x185)]=void 0x0;function a13_0x2048(){const _0x249c67=['Payment\x20not\x20found','now','30565lrunIt','create','test_gateway','default','sendPaymentStatusNotification','webhookUrl','__importDefault','successUrl','amount','10134315VyYUNQ','FAILED','webhookService','sendPaymentNotification','4778487eakSdV','error','failureReason','Webhook\x20event\x20','hasOwnProperty','âœ…\x20Test\x20Gateway\x20payment\x20','params','toISOString','PAID',',\x20cannot\x20process','7620640mjUYTh','failureMessage','writable','orderId','Payment\x20status\x20is\x20','ms)','gateway','toLowerCase','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','payment','status','parse','Any\x20other\x20card\x20number','../services/telegramBotService','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','shopId','__createBinding','6qqSKlX','33avTkdD','defineProperty','14283380mkRCIm','../services/gateways/testGatewayService','settings','Any\x203-4\x20digits','customerEmail','../config/database','json','payment.success','PENDING','\x20with\x20status\x20','findUnique','log','Payment\x20processed\x20successfully','cardNumber','webhookLog','POST','test_gateway_','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','getOwnPropertyDescriptor','Any\x20future\x20date\x20(MM/YY)','cardLast4','__esModule','length','8SvXeCN','then','4242\x204242\x204242\x204242','8092678kwexim','__setModuleDefault','webhookEvents','shop','Payment\x20to\x20','transactionId','172324dVEhEl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4cFQDff','resolve','testGatewayService','isArray','sendShopWebhook','paid','currency','processCard','getPaymentForm','call','stringify','gatewayOrderId','name','test_card','0000','TestGatewayService','prototype','Error\x20parsing\x20webhook\x20events:','Payment\x20is\x20not\x20for\x20test\x20gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','get','createdAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','TestGatewayController'];a13_0x2048=function(){return _0x249c67;};return a13_0x2048();}const testGatewayService_1=require(a13_0x1c0efc(0x1b5)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x1c0efc(0x1b9)));class TestGatewayController{constructor(){const _0x15fe2a=a13_0x1c0efc;this[_0x15fe2a(0x176)]=async(_0x5a2491,_0x5b3ba9,_0x57b90e)=>{const _0x1c667a=_0x15fe2a;try{const {paymentId:_0x2d2f90}=_0x5a2491[_0x1c667a(0x19b)];console['log'](_0x1c667a(0x1a8)+_0x2d2f90);const _0x1ebac6=await database_1[_0x1c667a(0x18b)]['payment'][_0x1c667a(0x156)]({'where':{'id':_0x2d2f90},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1ebac6)return _0x5b3ba9[_0x1c667a(0x1aa)](0x194)[_0x1c667a(0x1ba)]({'success':![],'message':_0x1c667a(0x186)});if(_0x1ebac6[_0x1c667a(0x1a5)]!=='test_gateway')return _0x5b3ba9['status'](0x190)['json']({'success':![],'message':_0x1c667a(0x180)});if(_0x1ebac6['status']!==_0x1c667a(0x154))return _0x5b3ba9[_0x1c667a(0x1aa)](0x190)[_0x1c667a(0x1ba)]({'success':![],'message':_0x1c667a(0x1a3)+_0x1ebac6[_0x1c667a(0x1aa)]+_0x1c667a(0x19e)});_0x5b3ba9[_0x1c667a(0x1ba)]({'success':!![],'result':{'paymentId':_0x1ebac6['id'],'orderId':_0x1ebac6[_0x1c667a(0x179)],'amount':_0x1ebac6[_0x1c667a(0x190)],'currency':_0x1ebac6[_0x1c667a(0x174)],'merchantName':_0x1ebac6[_0x1c667a(0x169)][_0x1c667a(0x17a)],'description':_0x1c667a(0x16a)+_0x1ebac6[_0x1c667a(0x169)][_0x1c667a(0x17a)],'testInstructions':{'successCard':_0x1c667a(0x165),'failureCard':_0x1c667a(0x1ac),'expiryDate':_0x1c667a(0x15f),'cvc':_0x1c667a(0x1b7),'holderName':'Any\x20name'}}});}catch(_0x5a8f07){_0x57b90e(_0x5a8f07);}},this[_0x15fe2a(0x175)]=async(_0x4b8855,_0x26db52,_0x211643)=>{const _0x1e995a=_0x15fe2a;try{const {paymentId:_0x538b01}=_0x4b8855[_0x1e995a(0x19b)],_0x4cd727=_0x4b8855['body'];console[_0x1e995a(0x157)](_0x1e995a(0x1ae)+_0x538b01);const _0x423e30=await database_1[_0x1e995a(0x18b)][_0x1e995a(0x1a9)]['findUnique']({'where':{'id':_0x538b01},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x423e30)return _0x26db52[_0x1e995a(0x1aa)](0x194)[_0x1e995a(0x1ba)]({'success':![],'message':_0x1e995a(0x186)});if(_0x423e30[_0x1e995a(0x1a5)]!==_0x1e995a(0x18a))return _0x26db52[_0x1e995a(0x1aa)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x423e30[_0x1e995a(0x1aa)]!==_0x1e995a(0x154))return _0x26db52['status'](0x190)[_0x1e995a(0x1ba)]({'success':![],'message':_0x1e995a(0x1a3)+_0x423e30['status']+_0x1e995a(0x19e)});const _0x485099=await this[_0x1e995a(0x170)]['processCardPayment']({'paymentId':_0x423e30['id'],'orderId':_0x423e30[_0x1e995a(0x179)]||_0x423e30['id'],'amount':_0x423e30[_0x1e995a(0x190)],'currency':_0x423e30[_0x1e995a(0x174)],'cardData':_0x4cd727});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x485099);const _0x4ac4da={'status':_0x485099[_0x1e995a(0x1aa)],'updatedAt':new Date()};if(_0x485099[_0x1e995a(0x1aa)]===_0x1e995a(0x19d))_0x4ac4da['paidAt']=new Date(),_0x4ac4da[_0x1e995a(0x1a7)]=_0x485099[_0x1e995a(0x16b)];else _0x485099['status']===_0x1e995a(0x192)&&(_0x4ac4da[_0x1e995a(0x1a0)]=_0x485099[_0x1e995a(0x197)]);const _0x177144=_0x4cd727[_0x1e995a(0x159)]['replace'](/[\s-]/g,'');_0x4ac4da[_0x1e995a(0x160)]=_0x177144['slice'](-0x4),_0x4ac4da['paymentMethod']=_0x1e995a(0x17b),await database_1[_0x1e995a(0x18b)][_0x1e995a(0x1a9)]['update']({'where':{'id':_0x423e30['id']},'data':_0x4ac4da}),await database_1[_0x1e995a(0x18b)][_0x1e995a(0x15a)][_0x1e995a(0x189)]({'data':{'paymentId':_0x423e30['id'],'shopId':_0x423e30[_0x1e995a(0x1af)],'event':_0x1e995a(0x15c)+_0x485099[_0x1e995a(0x1aa)][_0x1e995a(0x1a6)](),'statusCode':0xc8,'responseBody':JSON[_0x1e995a(0x178)]({'oldStatus':'PENDING','newStatus':_0x485099[_0x1e995a(0x1aa)],'transactionId':_0x485099[_0x1e995a(0x16b)],'failureReason':_0x485099[_0x1e995a(0x197)],'processedAt':new Date()[_0x1e995a(0x19c)]()})}}),await this[_0x1e995a(0x172)](_0x423e30,_0x485099['status'],_0x485099[_0x1e995a(0x16b)],_0x485099[_0x1e995a(0x197)]),await this[_0x1e995a(0x18c)](_0x423e30,_0x485099[_0x1e995a(0x1aa)]),console[_0x1e995a(0x157)](_0x1e995a(0x19a)+_0x538b01+'\x20processed:\x20'+_0x485099[_0x1e995a(0x1aa)]),_0x485099[_0x1e995a(0x1aa)]==='PAID'?_0x26db52[_0x1e995a(0x1ba)]({'success':!![],'message':_0x1e995a(0x158),'result':{'status':'PAID','transactionId':_0x485099[_0x1e995a(0x16b)],'redirectUrl':_0x423e30[_0x1e995a(0x18f)]}}):_0x26db52[_0x1e995a(0x1aa)](0x190)[_0x1e995a(0x1ba)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x485099[_0x1e995a(0x197)],'redirectUrl':_0x423e30['failUrl']}});}catch(_0x106e90){_0x211643(_0x106e90);}},this[_0x15fe2a(0x170)]=new testGatewayService_1[(_0x15fe2a(0x17d))](),this[_0x15fe2a(0x193)]=new webhookService_1['WebhookService']();}async[a13_0x1c0efc(0x172)](_0x1a82e1,_0x5ae941,_0x5c40bb,_0x2a91c5){const _0x34b75c=a13_0x1c0efc,_0x44118=Date[_0x34b75c(0x187)]();try{const _0x2b4075=_0x1a82e1['shop'],_0x83ae04=_0x2b4075[_0x34b75c(0x1b6)];if(!_0x83ae04?.[_0x34b75c(0x18d)]){console['log'](_0x34b75c(0x184)+_0x2b4075['id']);return;}const _0x1bef65=_0x5ae941===_0x34b75c(0x19d)?_0x34b75c(0x153):'payment.failed';let _0x31eb54=[];if(_0x83ae04[_0x34b75c(0x168)])try{_0x31eb54=Array[_0x34b75c(0x171)](_0x83ae04[_0x34b75c(0x168)])?_0x83ae04['webhookEvents']:JSON[_0x34b75c(0x1ab)](_0x83ae04['webhookEvents']);}catch(_0x263332){console[_0x34b75c(0x196)](_0x34b75c(0x17f),_0x263332),_0x31eb54=[];}if(!_0x31eb54['includes'](_0x1bef65)){console[_0x34b75c(0x157)](_0x34b75c(0x198)+_0x1bef65+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2b4075['id']);return;}const _0x56e182={'event':_0x1bef65,'payment':{'id':_0x1a82e1['id'],'order_id':_0x1a82e1[_0x34b75c(0x1a2)],'gateway_order_id':_0x1a82e1[_0x34b75c(0x179)],'gateway':_0x34b75c(0x17c),'amount':_0x1a82e1['amount'],'currency':_0x1a82e1[_0x34b75c(0x174)],'status':_0x5ae941[_0x34b75c(0x1a6)](),'customer_email':_0x1a82e1[_0x34b75c(0x1b8)],'customer_name':_0x1a82e1['customerName'],'transaction_id':_0x5c40bb,'failure_message':_0x2a91c5,'created_at':_0x1a82e1[_0x34b75c(0x183)],'updated_at':new Date()}},_0xc57aa=await fetch(_0x83ae04[_0x34b75c(0x18d)],{'method':_0x34b75c(0x15b),'headers':{'Content-Type':'application/json','User-Agent':_0x34b75c(0x15d)},'body':JSON[_0x34b75c(0x178)](_0x56e182)}),_0x344c88=Date['now']()-_0x44118;console[_0x34b75c(0x157)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x83ae04['webhookUrl']+_0x34b75c(0x155)+_0xc57aa[_0x34b75c(0x1aa)]+'\x20('+_0x344c88+_0x34b75c(0x1a4));}catch(_0x5cd110){console[_0x34b75c(0x196)](_0x34b75c(0x181),_0x5cd110);}}async['sendPaymentStatusNotification'](_0x322b05,_0x4e6b04){const _0x326c21=a13_0x1c0efc;try{const {telegramBotService:_0x5778c2}=await Promise[_0x326c21(0x16f)]()[_0x326c21(0x164)](()=>__importStar(require(_0x326c21(0x1ad)))),_0x2a0d44={'PAID':_0x326c21(0x173),'FAILED':'failed'},_0x4f409d=_0x2a0d44[_0x4e6b04];if(!_0x4f409d)return;await _0x5778c2[_0x326c21(0x194)](_0x322b05[_0x326c21(0x1af)],_0x322b05,_0x4f409d);}catch(_0x4545e9){console[_0x326c21(0x196)](_0x326c21(0x16d),_0x4545e9);}}}exports[a13_0x1c0efc(0x185)]=TestGatewayController;