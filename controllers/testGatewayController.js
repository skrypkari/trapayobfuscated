'use strict';const a14_0xdc6bd7=a14_0x83c5;(function(_0x277cc4,_0x2555b3){const _0x16e271=a14_0x83c5,_0x1b6361=_0x277cc4();while(!![]){try{const _0x3b458e=parseInt(_0x16e271(0x1bf))/0x1+-parseInt(_0x16e271(0x1e8))/0x2+parseInt(_0x16e271(0x1e7))/0x3*(-parseInt(_0x16e271(0x1ea))/0x4)+parseInt(_0x16e271(0x1b7))/0x5+-parseInt(_0x16e271(0x1c6))/0x6+parseInt(_0x16e271(0x196))/0x7+parseInt(_0x16e271(0x1ab))/0x8*(parseInt(_0x16e271(0x1b2))/0x9);if(_0x3b458e===_0x2555b3)break;else _0x1b6361['push'](_0x1b6361['shift']());}catch(_0x39de83){_0x1b6361['push'](_0x1b6361['shift']());}}}(a14_0x35a3,0xeade9));function a14_0x35a3(){const _0x2b04f9=['transactionId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create','toLowerCase','430611zsGGOT','2961736VxQhHo','test_gateway_','52NUeBHo','paid','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','currentPayments','❌\x20Payment\x20link\x20','📈\x20Test\x20Gateway:\x20Payment\x20','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','customerName','Webhook\x20event\x20','testGatewayService','PENDING','getPaymentForm','✅\x20Payment\x20link\x20','defineProperty','payment','paymentLinkId','successUrl','configurable','test_gateway','createdAt','gatewayOrderId','Payment\x20failed','WebhookService','then','✅\x20Test\x20Gateway\x20payment\x20','findUnique','processCardPayment','currency','Any\x20name','call','params','paidAt','resolve','0000','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','../config/database','10959641zyhZqW','Payment\x20status\x20is\x20','__importDefault','../services/webhookService','PAID','get','sendPaymentStatusNotification','Any\x20other\x20card\x20number','4242\x204242\x204242\x204242','TestGatewayController',',\x20cannot\x20process','update','type','writable','\x20->\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','getOwnPropertyNames','failed','webhookEvents','log','prototype','20014544YKTVzx','includes','__esModule','payment.success','failUrl','stringify','📈\x20Found\x20payment\x20link\x20','9XqvMjF','processCard','error','__createBinding','paymentMethod','3911170nguxnk','name','toISOString','__importStar','status','gateway','Payment\x20System/1.0\x20(Test\x20Gateway)','\x20processed:\x20','1203822GxwTYi','now','POST','webhookLog','sendShopWebhook','Payment\x20processed\x20successfully','webhookUrl','10467978WjoKKB','__setModuleDefault','paymentLink','COMPLETED','sendPaymentNotification','Error\x20parsing\x20webhook\x20events:','failureMessage',',\x20currentPayments=','json','amount','test_card','../services/gateways/testGatewayService','\x20with\x20status\x20','Any\x203-4\x20digits','isArray','$transaction','application/json','Any\x20future\x20date\x20(MM/YY)','failureReason','shop','default','customerEmail',',\x20status=','orderId','shopId','🧪\x20Test\x20Gateway\x20result:','Test\x20Gateway\x20webhook\x20sent\x20to\x20','settings','Payment\x20not\x20found'];a14_0x35a3=function(){return _0x2b04f9;};return a14_0x35a3();}var __createBinding=this&&this[a14_0xdc6bd7(0x1b5)]||(Object[a14_0xdc6bd7(0x1e5)]?function(_0x5f5b09,_0x54c088,_0x2a3c61,_0x1d15d8){const _0x4bde72=a14_0xdc6bd7;if(_0x1d15d8===undefined)_0x1d15d8=_0x2a3c61;var _0x441a4a=Object['getOwnPropertyDescriptor'](_0x54c088,_0x2a3c61);(!_0x441a4a||(_0x4bde72(0x19b)in _0x441a4a?!_0x54c088[_0x4bde72(0x1ad)]:_0x441a4a[_0x4bde72(0x1a3)]||_0x441a4a[_0x4bde72(0x183)]))&&(_0x441a4a={'enumerable':!![],'get':function(){return _0x54c088[_0x2a3c61];}}),Object[_0x4bde72(0x17f)](_0x5f5b09,_0x1d15d8,_0x441a4a);}:function(_0x4b3a09,_0x52e04b,_0x3d4efe,_0x24cc23){if(_0x24cc23===undefined)_0x24cc23=_0x3d4efe;_0x4b3a09[_0x24cc23]=_0x52e04b[_0x3d4efe];}),__setModuleDefault=this&&this[a14_0xdc6bd7(0x1c7)]||(Object[a14_0xdc6bd7(0x1e5)]?function(_0x5a354c,_0x15ad9f){const _0x428f37=a14_0xdc6bd7;Object[_0x428f37(0x17f)](_0x5a354c,_0x428f37(0x1da),{'enumerable':!![],'value':_0x15ad9f});}:function(_0x1ba481,_0x1b97d7){const _0x341a64=a14_0xdc6bd7;_0x1ba481[_0x341a64(0x1da)]=_0x1b97d7;}),__importStar=this&&this[a14_0xdc6bd7(0x1ba)]||(function(){var _0x274c14=function(_0x5b4bd6){const _0x4f1c1d=a14_0x83c5;return _0x274c14=Object[_0x4f1c1d(0x1a6)]||function(_0x413f91){const _0x140c1f=_0x4f1c1d;var _0x3efa08=[];for(var _0x25fede in _0x413f91)if(Object[_0x140c1f(0x1aa)]['hasOwnProperty'][_0x140c1f(0x18f)](_0x413f91,_0x25fede))_0x3efa08[_0x3efa08['length']]=_0x25fede;return _0x3efa08;},_0x274c14(_0x5b4bd6);};return function(_0x42ebbe){if(_0x42ebbe&&_0x42ebbe['__esModule'])return _0x42ebbe;var _0x225027={};if(_0x42ebbe!=null){for(var _0x362041=_0x274c14(_0x42ebbe),_0x2ad9de=0x0;_0x2ad9de<_0x362041['length'];_0x2ad9de++)if(_0x362041[_0x2ad9de]!=='default')__createBinding(_0x225027,_0x42ebbe,_0x362041[_0x2ad9de]);}return __setModuleDefault(_0x225027,_0x42ebbe),_0x225027;};}()),__importDefault=this&&this[a14_0xdc6bd7(0x198)]||function(_0x33d12f){const _0x3248a6=a14_0xdc6bd7;return _0x33d12f&&_0x33d12f[_0x3248a6(0x1ad)]?_0x33d12f:{'default':_0x33d12f};};Object[a14_0xdc6bd7(0x17f)](exports,a14_0xdc6bd7(0x1ad),{'value':!![]}),exports[a14_0xdc6bd7(0x19f)]=void 0x0;const testGatewayService_1=require(a14_0xdc6bd7(0x1d1)),webhookService_1=require(a14_0xdc6bd7(0x199)),database_1=__importDefault(require(a14_0xdc6bd7(0x195)));class TestGatewayController{constructor(){const _0x18e8af=a14_0xdc6bd7;this[_0x18e8af(0x17d)]=async(_0x41f6c9,_0x133fb3,_0x33866c)=>{const _0x4dd270=_0x18e8af;try{const {paymentId:_0x409084}=_0x41f6c9['params'];console[_0x4dd270(0x1a9)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x409084);const _0x19c4d8=await database_1[_0x4dd270(0x1da)][_0x4dd270(0x180)][_0x4dd270(0x18b)]({'where':{'id':_0x409084},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x19c4d8)return _0x133fb3[_0x4dd270(0x1bb)](0x194)[_0x4dd270(0x1ce)]({'success':![],'message':_0x4dd270(0x1e2)});if(_0x19c4d8[_0x4dd270(0x1bc)]!=='test_gateway')return _0x133fb3[_0x4dd270(0x1bb)](0x190)['json']({'success':![],'message':_0x4dd270(0x1a5)});if(_0x19c4d8['status']!==_0x4dd270(0x17c))return _0x133fb3['status'](0x190)[_0x4dd270(0x1ce)]({'success':![],'message':_0x4dd270(0x197)+_0x19c4d8[_0x4dd270(0x1bb)]+_0x4dd270(0x1a0)});_0x133fb3[_0x4dd270(0x1ce)]({'success':!![],'result':{'paymentId':_0x19c4d8['id'],'orderId':_0x19c4d8[_0x4dd270(0x186)],'amount':_0x19c4d8[_0x4dd270(0x1cf)],'currency':_0x19c4d8['currency'],'merchantName':_0x19c4d8['shop'][_0x4dd270(0x1b8)],'description':'Payment\x20to\x20'+_0x19c4d8[_0x4dd270(0x1d9)][_0x4dd270(0x1b8)],'testInstructions':{'successCard':_0x4dd270(0x19e),'failureCard':_0x4dd270(0x19d),'expiryDate':_0x4dd270(0x1d7),'cvc':_0x4dd270(0x1d3),'holderName':_0x4dd270(0x18e)}}});}catch(_0x530f0b){_0x33866c(_0x530f0b);}},this[_0x18e8af(0x1b3)]=async(_0x1a0527,_0x404205,_0xee9b18)=>{const _0x19fc9b=_0x18e8af;try{const {paymentId:_0x4423c5}=_0x1a0527[_0x19fc9b(0x190)],_0x1c6142=_0x1a0527['body'];console['log'](_0x19fc9b(0x1ec)+_0x4423c5);const _0x2ab938=await database_1['default'][_0x19fc9b(0x180)][_0x19fc9b(0x18b)]({'where':{'id':_0x4423c5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ab938)return _0x404205[_0x19fc9b(0x1bb)](0x194)[_0x19fc9b(0x1ce)]({'success':![],'message':_0x19fc9b(0x1e2)});if(_0x2ab938[_0x19fc9b(0x1bc)]!==_0x19fc9b(0x184))return _0x404205[_0x19fc9b(0x1bb)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2ab938[_0x19fc9b(0x1bb)]!==_0x19fc9b(0x17c))return _0x404205[_0x19fc9b(0x1bb)](0x190)[_0x19fc9b(0x1ce)]({'success':![],'message':_0x19fc9b(0x197)+_0x2ab938['status']+_0x19fc9b(0x1a0)});const _0x432766=await this[_0x19fc9b(0x17b)][_0x19fc9b(0x18c)]({'paymentId':_0x2ab938['id'],'orderId':_0x2ab938['gatewayOrderId']||_0x2ab938['id'],'amount':_0x2ab938[_0x19fc9b(0x1cf)],'currency':_0x2ab938[_0x19fc9b(0x18d)],'cardData':_0x1c6142});console[_0x19fc9b(0x1a9)](_0x19fc9b(0x1df),_0x432766);const _0x1456a0={'status':_0x432766[_0x19fc9b(0x1bb)],'updatedAt':new Date()};if(_0x432766['status']==='PAID')_0x1456a0[_0x19fc9b(0x191)]=new Date(),_0x1456a0['gatewayPaymentId']=_0x432766[_0x19fc9b(0x1e3)];else _0x432766[_0x19fc9b(0x1bb)]==='FAILED'&&(_0x1456a0[_0x19fc9b(0x1cc)]=_0x432766[_0x19fc9b(0x1d8)]);const _0x522624=_0x1c6142['cardNumber']['replace'](/[\s-]/g,'');_0x1456a0['cardLast4']=_0x522624['slice'](-0x4),_0x1456a0[_0x19fc9b(0x1b6)]=_0x19fc9b(0x1d0),await database_1[_0x19fc9b(0x1da)]['payment'][_0x19fc9b(0x1a1)]({'where':{'id':_0x2ab938['id']},'data':_0x1456a0});if(_0x432766[_0x19fc9b(0x1bb)]===_0x19fc9b(0x19a)&&_0x2ab938['paymentLinkId']){console[_0x19fc9b(0x1a9)](_0x19fc9b(0x1f0)+_0x2ab938['id']+_0x19fc9b(0x194));try{await database_1['default'][_0x19fc9b(0x1d5)](async _0x59343a=>{const _0x36567f=_0x19fc9b,_0x268a23=await _0x59343a[_0x36567f(0x1c8)]['findUnique']({'where':{'id':_0x2ab938['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x268a23){console[_0x36567f(0x1a9)](_0x36567f(0x1b1)+_0x268a23['id']+':\x20type='+_0x268a23[_0x36567f(0x1a2)]+_0x36567f(0x1cd)+_0x268a23[_0x36567f(0x1ee)]+_0x36567f(0x1dc)+_0x268a23[_0x36567f(0x1bb)]);const _0x5a8c31=_0x268a23[_0x36567f(0x1ee)]+0x1,_0x464b9f=_0x268a23[_0x36567f(0x1a2)]==='SINGLE'?_0x36567f(0x1c9):_0x268a23[_0x36567f(0x1bb)];await _0x59343a[_0x36567f(0x1c8)][_0x36567f(0x1a1)]({'where':{'id':_0x2ab938[_0x36567f(0x181)]},'data':{'currentPayments':_0x5a8c31,'status':_0x464b9f,'updatedAt':new Date()}}),console[_0x36567f(0x1a9)](_0x36567f(0x17e)+_0x268a23['id']+'\x20updated:\x20currentPayments='+_0x268a23[_0x36567f(0x1ee)]+_0x36567f(0x1a4)+_0x5a8c31+_0x36567f(0x1dc)+_0x268a23['status']+_0x36567f(0x1a4)+_0x464b9f);}else console['log'](_0x36567f(0x1ef)+_0x2ab938[_0x36567f(0x181)]+'\x20not\x20found');});}catch(_0x4eaa3e){console[_0x19fc9b(0x1b4)](_0x19fc9b(0x1f1),_0x4eaa3e);}}await database_1[_0x19fc9b(0x1da)][_0x19fc9b(0x1c2)][_0x19fc9b(0x1e5)]({'data':{'paymentId':_0x2ab938['id'],'shopId':_0x2ab938[_0x19fc9b(0x1de)],'event':_0x19fc9b(0x1e9)+_0x432766[_0x19fc9b(0x1bb)][_0x19fc9b(0x1e6)](),'statusCode':0xc8,'responseBody':JSON[_0x19fc9b(0x1b0)]({'oldStatus':_0x19fc9b(0x17c),'newStatus':_0x432766[_0x19fc9b(0x1bb)],'transactionId':_0x432766[_0x19fc9b(0x1e3)],'failureReason':_0x432766[_0x19fc9b(0x1d8)],'processedAt':new Date()[_0x19fc9b(0x1b9)]()})}}),await this[_0x19fc9b(0x1c3)](_0x2ab938,_0x432766['status'],_0x432766['transactionId'],_0x432766[_0x19fc9b(0x1d8)]),await this['sendPaymentStatusNotification'](_0x2ab938,_0x432766[_0x19fc9b(0x1bb)]),console[_0x19fc9b(0x1a9)](_0x19fc9b(0x18a)+_0x4423c5+_0x19fc9b(0x1be)+_0x432766[_0x19fc9b(0x1bb)]),_0x432766[_0x19fc9b(0x1bb)]==='PAID'?_0x404205['json']({'success':!![],'message':_0x19fc9b(0x1c4),'result':{'status':'PAID','transactionId':_0x432766[_0x19fc9b(0x1e3)],'redirectUrl':_0x2ab938[_0x19fc9b(0x182)]}}):_0x404205['status'](0x190)[_0x19fc9b(0x1ce)]({'success':![],'message':_0x19fc9b(0x187),'result':{'status':'FAILED','failureReason':_0x432766['failureReason'],'redirectUrl':_0x2ab938[_0x19fc9b(0x1af)]}});}catch(_0x1c5c80){_0xee9b18(_0x1c5c80);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1[(_0x18e8af(0x188))]();}async[a14_0xdc6bd7(0x1c3)](_0x241ae4,_0x34be98,_0x13ea9f,_0x1a1800){const _0x2f1e10=a14_0xdc6bd7,_0x1ad66c=Date[_0x2f1e10(0x1c0)]();try{const _0x1323cc=_0x241ae4[_0x2f1e10(0x1d9)],_0x1c7b0f=_0x1323cc[_0x2f1e10(0x1e1)];if(!_0x1c7b0f?.[_0x2f1e10(0x1c5)]){console[_0x2f1e10(0x1a9)](_0x2f1e10(0x1e4)+_0x1323cc['id']);return;}const _0x3486fb=_0x34be98===_0x2f1e10(0x19a)?_0x2f1e10(0x1ae):'payment.failed';let _0xad6d14=[];if(_0x1c7b0f[_0x2f1e10(0x1a8)])try{_0xad6d14=Array[_0x2f1e10(0x1d4)](_0x1c7b0f[_0x2f1e10(0x1a8)])?_0x1c7b0f[_0x2f1e10(0x1a8)]:JSON['parse'](_0x1c7b0f[_0x2f1e10(0x1a8)]);}catch(_0x4c7fa7){console[_0x2f1e10(0x1b4)](_0x2f1e10(0x1cb),_0x4c7fa7),_0xad6d14=[];}if(!_0xad6d14[_0x2f1e10(0x1ac)](_0x3486fb)){console['log'](_0x2f1e10(0x1f3)+_0x3486fb+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1323cc['id']);return;}const _0x585d6a={'event':_0x3486fb,'payment':{'id':_0x241ae4['id'],'order_id':_0x241ae4[_0x2f1e10(0x1dd)],'gateway_order_id':_0x241ae4[_0x2f1e10(0x186)],'gateway':_0x2f1e10(0x193),'amount':_0x241ae4['amount'],'currency':_0x241ae4['currency'],'status':_0x34be98[_0x2f1e10(0x1e6)](),'customer_email':_0x241ae4[_0x2f1e10(0x1db)],'customer_name':_0x241ae4[_0x2f1e10(0x1f2)],'transaction_id':_0x13ea9f,'failure_message':_0x1a1800,'created_at':_0x241ae4[_0x2f1e10(0x185)],'updated_at':new Date()}},_0x291071=await fetch(_0x1c7b0f[_0x2f1e10(0x1c5)],{'method':_0x2f1e10(0x1c1),'headers':{'Content-Type':_0x2f1e10(0x1d6),'User-Agent':_0x2f1e10(0x1bd)},'body':JSON[_0x2f1e10(0x1b0)](_0x585d6a)}),_0x3ddb93=Date[_0x2f1e10(0x1c0)]()-_0x1ad66c;console[_0x2f1e10(0x1a9)](_0x2f1e10(0x1e0)+_0x1c7b0f[_0x2f1e10(0x1c5)]+_0x2f1e10(0x1d2)+_0x291071[_0x2f1e10(0x1bb)]+'\x20('+_0x3ddb93+'ms)');}catch(_0x572aa2){console[_0x2f1e10(0x1b4)](_0x2f1e10(0x1ed),_0x572aa2);}}async[a14_0xdc6bd7(0x19c)](_0x484150,_0x14747f){const _0x395ae7=a14_0xdc6bd7;try{const {telegramBotService:_0x2a4de1}=await Promise[_0x395ae7(0x192)]()[_0x395ae7(0x189)](()=>__importStar(require('../services/telegramBotService'))),_0x5c944e={'PAID':_0x395ae7(0x1eb),'FAILED':_0x395ae7(0x1a7)},_0x3d62e2=_0x5c944e[_0x14747f];if(!_0x3d62e2)return;await _0x2a4de1[_0x395ae7(0x1ca)](_0x484150['shopId'],_0x484150,_0x3d62e2);}catch(_0x59403c){console[_0x395ae7(0x1b4)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x59403c);}}}function a14_0x83c5(_0x1db00a,_0xbaa551){const _0x35a306=a14_0x35a3();return a14_0x83c5=function(_0x83c50a,_0x233836){_0x83c50a=_0x83c50a-0x17b;let _0x348c23=_0x35a306[_0x83c50a];return _0x348c23;},a14_0x83c5(_0x1db00a,_0xbaa551);}exports['TestGatewayController']=TestGatewayController;