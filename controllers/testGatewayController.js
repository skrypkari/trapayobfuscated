'use strict';const a13_0x5dc182=a13_0x853e;(function(_0x4c7bb5,_0x18eb86){const _0x53afb2=a13_0x853e,_0x5bbfd0=_0x4c7bb5();while(!![]){try{const _0x2d3dec=parseInt(_0x53afb2(0x79))/0x1*(parseInt(_0x53afb2(0x78))/0x2)+parseInt(_0x53afb2(0x72))/0x3+parseInt(_0x53afb2(0xc4))/0x4*(-parseInt(_0x53afb2(0xaf))/0x5)+parseInt(_0x53afb2(0xd5))/0x6*(-parseInt(_0x53afb2(0xd3))/0x7)+parseInt(_0x53afb2(0x71))/0x8*(parseInt(_0x53afb2(0x90))/0x9)+-parseInt(_0x53afb2(0x7c))/0xa*(-parseInt(_0x53afb2(0xbd))/0xb)+parseInt(_0x53afb2(0x74))/0xc*(-parseInt(_0x53afb2(0x82))/0xd);if(_0x2d3dec===_0x18eb86)break;else _0x5bbfd0['push'](_0x5bbfd0['shift']());}catch(_0x2c3144){_0x5bbfd0['push'](_0x5bbfd0['shift']());}}}(a13_0x51e4,0x84c8e));function a13_0x853e(_0xfb8f22,_0x4c518a){const _0x51e47e=a13_0x51e4();return a13_0x853e=function(_0x853e75,_0x1711e4){_0x853e75=_0x853e75-0x71;let _0xdb4667=_0x51e47e[_0x853e75];return _0xdb4667;},a13_0x853e(_0xfb8f22,_0x4c518a);}var __createBinding=this&&this[a13_0x5dc182(0x8a)]||(Object['create']?function(_0x23c848,_0x52cb87,_0x2761bb,_0x50c125){const _0x5687bf=a13_0x5dc182;if(_0x50c125===undefined)_0x50c125=_0x2761bb;var _0x5730bf=Object[_0x5687bf(0xab)](_0x52cb87,_0x2761bb);(!_0x5730bf||(_0x5687bf(0xa6)in _0x5730bf?!_0x52cb87[_0x5687bf(0xb4)]:_0x5730bf[_0x5687bf(0xcf)]||_0x5730bf[_0x5687bf(0xc9)]))&&(_0x5730bf={'enumerable':!![],'get':function(){return _0x52cb87[_0x2761bb];}}),Object['defineProperty'](_0x23c848,_0x50c125,_0x5730bf);}:function(_0x216628,_0x3c4a2c,_0xb331ec,_0x463e7b){if(_0x463e7b===undefined)_0x463e7b=_0xb331ec;_0x216628[_0x463e7b]=_0x3c4a2c[_0xb331ec];}),__setModuleDefault=this&&this[a13_0x5dc182(0xd8)]||(Object['create']?function(_0x4ab724,_0xa57e29){const _0x3b25ba=a13_0x5dc182;Object[_0x3b25ba(0xd1)](_0x4ab724,_0x3b25ba(0x76),{'enumerable':!![],'value':_0xa57e29});}:function(_0x6e93b7,_0x551365){const _0x46e0d8=a13_0x5dc182;_0x6e93b7[_0x46e0d8(0x76)]=_0x551365;}),__importStar=this&&this[a13_0x5dc182(0xce)]||(function(){var _0x10078d=function(_0x371571){const _0xa29524=a13_0x853e;return _0x10078d=Object[_0xa29524(0xa2)]||function(_0x4ba773){const _0x1a188e=_0xa29524;var _0x35d5a9=[];for(var _0x3a79c0 in _0x4ba773)if(Object[_0x1a188e(0x7a)]['hasOwnProperty'][_0x1a188e(0x81)](_0x4ba773,_0x3a79c0))_0x35d5a9[_0x35d5a9['length']]=_0x3a79c0;return _0x35d5a9;},_0x10078d(_0x371571);};return function(_0x551c23){const _0x109715=a13_0x853e;if(_0x551c23&&_0x551c23['__esModule'])return _0x551c23;var _0x5c9615={};if(_0x551c23!=null){for(var _0x33c81b=_0x10078d(_0x551c23),_0x3975a5=0x0;_0x3975a5<_0x33c81b[_0x109715(0x80)];_0x3975a5++)if(_0x33c81b[_0x3975a5]!==_0x109715(0x76))__createBinding(_0x5c9615,_0x551c23,_0x33c81b[_0x3975a5]);}return __setModuleDefault(_0x5c9615,_0x551c23),_0x5c9615;};}()),__importDefault=this&&this[a13_0x5dc182(0xd6)]||function(_0x2e34ee){const _0x10e03a=a13_0x5dc182;return _0x2e34ee&&_0x2e34ee[_0x10e03a(0xb4)]?_0x2e34ee:{'default':_0x2e34ee};};function a13_0x51e4(){const _0x40d891=['getOwnPropertyDescriptor','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','POST','Error\x20parsing\x20webhook\x20events:','190oEgZQV',',\x20cannot\x20process','ðŸ§ª\x20Test\x20Gateway\x20result:','payment.success','then','__esModule','sendShopWebhook','customerEmail','TestGatewayService','now','4242\x204242\x204242\x204242','Payment\x20status\x20is\x20','test_gateway','log','378257iiYDkk','processCardPayment','cardNumber','Payment\x20not\x20found','gatewayOrderId','../config/database','failureMessage','45348AEMAfN','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','../services/webhookService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20to\x20','configurable','test_card','PENDING','FAILED','currency','__importStar','writable','params','defineProperty','webhookLog','60613BPXOch','âœ…\x20Test\x20Gateway\x20payment\x20','204OYcyfT','__importDefault','create','__setModuleDefault','stringify','paidAt','failed','344ifnRaM','1488804URfKYe','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1505964sTcLIw','Payment\x20failed','default','shopId','2euYxPF','284730Vezfoz','prototype','webhookEvents','10XZAAUe','paid','paymentMethod','update','length','call','13ddQvTX','toLowerCase','failureReason','gatewayPaymentId','shop','gateway','\x20processed:\x20','../services/telegramBotService','__createBinding','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x20other\x20card\x20number','payment','error','TestGatewayController','121230MHUqHv','failUrl','resolve','PAID','sendPaymentNotification','webhookUrl','transactionId','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','application/json','json','getPaymentForm','test_gateway_','findUnique','0000','sendPaymentStatusNotification','Any\x203-4\x20digits','status','parse','getOwnPropertyNames','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','webhookService','get','body','ms)','payment.failed','amount'];a13_0x51e4=function(){return _0x40d891;};return a13_0x51e4();}Object['defineProperty'](exports,a13_0x5dc182(0xb4),{'value':!![]}),exports[a13_0x5dc182(0x8f)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x5dc182(0xc6)),database_1=__importDefault(require(a13_0x5dc182(0xc2)));class TestGatewayController{constructor(){const _0x313a11=a13_0x5dc182;this[_0x313a11(0x9a)]=async(_0x3c9a9a,_0x3f10b3,_0xeadc1)=>{const _0x27058c=_0x313a11;try{const {paymentId:_0xfc59cf}=_0x3c9a9a['params'];console[_0x27058c(0xbc)](_0x27058c(0xc5)+_0xfc59cf);const _0x25d857=await database_1[_0x27058c(0x76)][_0x27058c(0x8d)][_0x27058c(0x9c)]({'where':{'id':_0xfc59cf},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x25d857)return _0x3f10b3[_0x27058c(0xa0)](0x194)['json']({'success':![],'message':_0x27058c(0xc0)});if(_0x25d857[_0x27058c(0x87)]!==_0x27058c(0xbb))return _0x3f10b3[_0x27058c(0xa0)](0x190)[_0x27058c(0x99)]({'success':![],'message':_0x27058c(0xa4)});if(_0x25d857[_0x27058c(0xa0)]!==_0x27058c(0xcb))return _0x3f10b3[_0x27058c(0xa0)](0x190)[_0x27058c(0x99)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x25d857[_0x27058c(0xa0)]+_0x27058c(0xb0)});_0x3f10b3[_0x27058c(0x99)]({'success':!![],'result':{'paymentId':_0x25d857['id'],'orderId':_0x25d857['gatewayOrderId'],'amount':_0x25d857[_0x27058c(0xaa)],'currency':_0x25d857[_0x27058c(0xcd)],'merchantName':_0x25d857['shop']['name'],'description':_0x27058c(0xc8)+_0x25d857[_0x27058c(0x86)]['name'],'testInstructions':{'successCard':_0x27058c(0xb9),'failureCard':_0x27058c(0x8c),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x27058c(0x9f),'holderName':'Any\x20name'}}});}catch(_0x285f1a){_0xeadc1(_0x285f1a);}},this['processCard']=async(_0x47c690,_0x4f7fdf,_0x4de911)=>{const _0x13d598=_0x313a11;try{const {paymentId:_0x5c035c}=_0x47c690[_0x13d598(0xd0)],_0x492e5a=_0x47c690[_0x13d598(0xa7)];console[_0x13d598(0xbc)](_0x13d598(0x97)+_0x5c035c);const _0x55bc83=await database_1[_0x13d598(0x76)]['payment'][_0x13d598(0x9c)]({'where':{'id':_0x5c035c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x55bc83)return _0x4f7fdf['status'](0x194)[_0x13d598(0x99)]({'success':![],'message':_0x13d598(0xc0)});if(_0x55bc83[_0x13d598(0x87)]!==_0x13d598(0xbb))return _0x4f7fdf[_0x13d598(0xa0)](0x190)[_0x13d598(0x99)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x55bc83[_0x13d598(0xa0)]!==_0x13d598(0xcb))return _0x4f7fdf[_0x13d598(0xa0)](0x190)[_0x13d598(0x99)]({'success':![],'message':_0x13d598(0xba)+_0x55bc83[_0x13d598(0xa0)]+_0x13d598(0xb0)});const _0x31218a=await this['testGatewayService'][_0x13d598(0xbe)]({'paymentId':_0x55bc83['id'],'orderId':_0x55bc83[_0x13d598(0xc1)]||_0x55bc83['id'],'amount':_0x55bc83[_0x13d598(0xaa)],'currency':_0x55bc83[_0x13d598(0xcd)],'cardData':_0x492e5a});console['log'](_0x13d598(0xb1),_0x31218a);const _0x1f20be={'status':_0x31218a['status'],'updatedAt':new Date()};if(_0x31218a['status']===_0x13d598(0x93))_0x1f20be[_0x13d598(0xda)]=new Date(),_0x1f20be[_0x13d598(0x85)]=_0x31218a[_0x13d598(0x96)];else _0x31218a[_0x13d598(0xa0)]===_0x13d598(0xcc)&&(_0x1f20be[_0x13d598(0xc3)]=_0x31218a[_0x13d598(0x84)]);const _0x33f767=_0x492e5a[_0x13d598(0xbf)]['replace'](/[\s-]/g,'');_0x1f20be['cardLast4']=_0x33f767['slice'](-0x4),_0x1f20be[_0x13d598(0x7e)]=_0x13d598(0xca),await database_1['default']['payment'][_0x13d598(0x7f)]({'where':{'id':_0x55bc83['id']},'data':_0x1f20be}),await database_1[_0x13d598(0x76)][_0x13d598(0xd2)][_0x13d598(0xd7)]({'data':{'paymentId':_0x55bc83['id'],'shopId':_0x55bc83[_0x13d598(0x77)],'event':_0x13d598(0x9b)+_0x31218a[_0x13d598(0xa0)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x13d598(0xd9)]({'oldStatus':'PENDING','newStatus':_0x31218a[_0x13d598(0xa0)],'transactionId':_0x31218a['transactionId'],'failureReason':_0x31218a['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x55bc83,_0x31218a['status'],_0x31218a[_0x13d598(0x96)],_0x31218a[_0x13d598(0x84)]),await this['sendPaymentStatusNotification'](_0x55bc83,_0x31218a[_0x13d598(0xa0)]),console[_0x13d598(0xbc)](_0x13d598(0xd4)+_0x5c035c+_0x13d598(0x88)+_0x31218a['status']),_0x31218a[_0x13d598(0xa0)]===_0x13d598(0x93)?_0x4f7fdf[_0x13d598(0x99)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x31218a[_0x13d598(0x96)],'redirectUrl':_0x55bc83['successUrl']}}):_0x4f7fdf['status'](0x190)['json']({'success':![],'message':_0x13d598(0x75),'result':{'status':_0x13d598(0xcc),'failureReason':_0x31218a[_0x13d598(0x84)],'redirectUrl':_0x55bc83[_0x13d598(0x91)]}});}catch(_0x23ccd0){_0x4de911(_0x23ccd0);}},this['testGatewayService']=new testGatewayService_1[(_0x313a11(0xb7))](),this[_0x313a11(0xa5)]=new webhookService_1['WebhookService']();}async[a13_0x5dc182(0xb5)](_0x16f8a2,_0x3e0244,_0x203266,_0x2a9eec){const _0x4d6071=a13_0x5dc182,_0x2d0bcc=Date['now']();try{const _0x408028=_0x16f8a2['shop'],_0x2728cf=_0x408028['settings'];if(!_0x2728cf?.['webhookUrl']){console['log'](_0x4d6071(0xac)+_0x408028['id']);return;}const _0xc61da0=_0x3e0244===_0x4d6071(0x93)?_0x4d6071(0xb2):_0x4d6071(0xa9);let _0x1b3a5a=[];if(_0x2728cf[_0x4d6071(0x7b)])try{_0x1b3a5a=Array['isArray'](_0x2728cf['webhookEvents'])?_0x2728cf[_0x4d6071(0x7b)]:JSON[_0x4d6071(0xa1)](_0x2728cf[_0x4d6071(0x7b)]);}catch(_0x2d3f6a){console[_0x4d6071(0x8e)](_0x4d6071(0xae),_0x2d3f6a),_0x1b3a5a=[];}if(!_0x1b3a5a['includes'](_0xc61da0)){console[_0x4d6071(0xbc)]('Webhook\x20event\x20'+_0xc61da0+_0x4d6071(0xa3)+_0x408028['id']);return;}const _0x585724={'event':_0xc61da0,'payment':{'id':_0x16f8a2['id'],'order_id':_0x16f8a2['orderId'],'gateway_order_id':_0x16f8a2[_0x4d6071(0xc1)],'gateway':_0x4d6071(0x9d),'amount':_0x16f8a2[_0x4d6071(0xaa)],'currency':_0x16f8a2[_0x4d6071(0xcd)],'status':_0x3e0244[_0x4d6071(0x83)](),'customer_email':_0x16f8a2[_0x4d6071(0xb6)],'customer_name':_0x16f8a2['customerName'],'transaction_id':_0x203266,'failure_message':_0x2a9eec,'created_at':_0x16f8a2['createdAt'],'updated_at':new Date()}},_0x5bde31=await fetch(_0x2728cf[_0x4d6071(0x95)],{'method':_0x4d6071(0xad),'headers':{'Content-Type':_0x4d6071(0x98),'User-Agent':_0x4d6071(0x8b)},'body':JSON['stringify'](_0x585724)}),_0x4826a1=Date[_0x4d6071(0xb8)]()-_0x2d0bcc;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2728cf[_0x4d6071(0x95)]+'\x20with\x20status\x20'+_0x5bde31[_0x4d6071(0xa0)]+'\x20('+_0x4826a1+_0x4d6071(0xa8));}catch(_0x3ef84a){console[_0x4d6071(0x8e)](_0x4d6071(0xc7),_0x3ef84a);}}async[a13_0x5dc182(0x9e)](_0x505f24,_0x5eeb23){const _0x279eac=a13_0x5dc182;try{const {telegramBotService:_0xb641bb}=await Promise[_0x279eac(0x92)]()[_0x279eac(0xb3)](()=>__importStar(require(_0x279eac(0x89)))),_0x258ecd={'PAID':_0x279eac(0x7d),'FAILED':_0x279eac(0xdb)},_0x533bfc=_0x258ecd[_0x5eeb23];if(!_0x533bfc)return;await _0xb641bb[_0x279eac(0x94)](_0x505f24[_0x279eac(0x77)],_0x505f24,_0x533bfc);}catch(_0x30a082){console[_0x279eac(0x8e)](_0x279eac(0x73),_0x30a082);}}}exports[a13_0x5dc182(0x8f)]=TestGatewayController;