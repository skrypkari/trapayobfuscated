'use strict';const a18_0x10ccae=a18_0x403c;(function(_0x48bedc,_0x23b7f7){const _0x46a5a1=a18_0x403c,_0x4c10bf=_0x48bedc();while(!![]){try{const _0x307195=-parseInt(_0x46a5a1(0x120))/0x1+-parseInt(_0x46a5a1(0x133))/0x2+-parseInt(_0x46a5a1(0x18f))/0x3*(parseInt(_0x46a5a1(0x192))/0x4)+-parseInt(_0x46a5a1(0x183))/0x5*(-parseInt(_0x46a5a1(0x12c))/0x6)+parseInt(_0x46a5a1(0x12a))/0x7+-parseInt(_0x46a5a1(0x11a))/0x8*(-parseInt(_0x46a5a1(0x174))/0x9)+-parseInt(_0x46a5a1(0x17c))/0xa*(-parseInt(_0x46a5a1(0x173))/0xb);if(_0x307195===_0x23b7f7)break;else _0x4c10bf['push'](_0x4c10bf['shift']());}catch(_0x33be69){_0x4c10bf['push'](_0x4c10bf['shift']());}}}(a18_0x5f52,0x31d80));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0xb57dd4,_0x558394,_0x368a57,_0x15a8b0){const _0x2c6c63=a18_0x403c;if(_0x15a8b0===undefined)_0x15a8b0=_0x368a57;var _0xc20f06=Object[_0x2c6c63(0x168)](_0x558394,_0x368a57);(!_0xc20f06||('get'in _0xc20f06?!_0x558394[_0x2c6c63(0x147)]:_0xc20f06[_0x2c6c63(0x13b)]||_0xc20f06[_0x2c6c63(0x154)]))&&(_0xc20f06={'enumerable':!![],'get':function(){return _0x558394[_0x368a57];}}),Object[_0x2c6c63(0x148)](_0xb57dd4,_0x15a8b0,_0xc20f06);}:function(_0x3a92a6,_0x2dd274,_0x3c9ade,_0x4f5c43){if(_0x4f5c43===undefined)_0x4f5c43=_0x3c9ade;_0x3a92a6[_0x4f5c43]=_0x2dd274[_0x3c9ade];}),__setModuleDefault=this&&this[a18_0x10ccae(0x16e)]||(Object[a18_0x10ccae(0x162)]?function(_0x488d14,_0x2bf4a4){const _0x2c838b=a18_0x10ccae;Object[_0x2c838b(0x148)](_0x488d14,_0x2c838b(0x13e),{'enumerable':!![],'value':_0x2bf4a4});}:function(_0x5b2e33,_0x5414a0){_0x5b2e33['default']=_0x5414a0;}),__importStar=this&&this[a18_0x10ccae(0x163)]||(function(){var _0x205a87=function(_0x179325){const _0x22f471=a18_0x403c;return _0x205a87=Object[_0x22f471(0x160)]||function(_0xbbe8c1){const _0x261a0d=_0x22f471;var _0x274aa7=[];for(var _0x26f4e7 in _0xbbe8c1)if(Object[_0x261a0d(0x15d)]['hasOwnProperty'][_0x261a0d(0x190)](_0xbbe8c1,_0x26f4e7))_0x274aa7[_0x274aa7[_0x261a0d(0x119)]]=_0x26f4e7;return _0x274aa7;},_0x205a87(_0x179325);};return function(_0x2e234c){const _0x5adf6b=a18_0x403c;if(_0x2e234c&&_0x2e234c[_0x5adf6b(0x147)])return _0x2e234c;var _0x553300={};if(_0x2e234c!=null){for(var _0xba7a54=_0x205a87(_0x2e234c),_0x191ac5=0x0;_0x191ac5<_0xba7a54[_0x5adf6b(0x119)];_0x191ac5++)if(_0xba7a54[_0x191ac5]!==_0x5adf6b(0x13e))__createBinding(_0x553300,_0x2e234c,_0xba7a54[_0x191ac5]);}return __setModuleDefault(_0x553300,_0x2e234c),_0x553300;};}()),__importDefault=this&&this[a18_0x10ccae(0x130)]||function(_0x3cfc88){const _0x301c55=a18_0x10ccae;return _0x3cfc88&&_0x3cfc88[_0x301c55(0x147)]?_0x3cfc88:{'default':_0x3cfc88};};function a18_0x403c(_0x4a3e45,_0x3ac164){_0x4a3e45=_0x4a3e45-0x119;const _0x5f52dc=a18_0x5f52();let _0x403c7f=_0x5f52dc[_0x4a3e45];return _0x403c7f;}Object[a18_0x10ccae(0x148)](exports,a18_0x10ccae(0x147),{'value':!![]}),exports[a18_0x10ccae(0x171)]=void 0x0;function a18_0x5f52(){const _0x4169cc=['successUrl','344572yOdhWM','\x20processed:\x20','sendShopWebhook','\x20not\x20found','ðŸ“ˆ\x20Found\x20payment\x20link\x20',',\x20cannot\x20process','âœ…\x20Payment\x20link\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','âœ…\x20Test\x20Gateway\x20payment\x20','payment','1341704pYWDjz','then','10968ZHRCpE','ms)','failed','stringify','__importDefault','paidAt','orderId','513752HCBSny','webhookLog','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','../services/webhookService','resolve','sendPaymentNotification','writable','COMPLETED','Webhook\x20event\x20','default','findUnique','transactionId','Payment\x20not\x20found','status','failUrl','params','now','gatewayOrderId','__esModule','defineProperty','createdAt','log','\x20->\x20','WebhookService','Any\x203-4\x20digits',',\x20currentPayments=',',\x20status=','\x20updated:\x20currentPayments=','sendPaymentStatusNotification','error','paymentLink','configurable','currency','shop','test_card','webhookEvents','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','update','shopId','Payment\x20processed\x20successfully','prototype','../config/database','parse','getOwnPropertyNames','Payment\x20failed','create','__importStar','type','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20not\x20enabled\x20for\x20shop\x20','currentPayments','getOwnPropertyDescriptor','includes','settings','TestGatewayService','test_gateway','amount','__setModuleDefault','webhookUrl','paymentMethod','TestGatewayController','test_gateway_','30272qMAFDj','230427APnajG','webhookService','isArray','Payment\x20status\x20is\x20','testGatewayService','replace','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','../services/gateways/testGatewayService','1910nxYNeS','json','name','0000','cardNumber','failureReason','PENDING','910CgtNOP',':\x20type=','paymentLinkId','SINGLE','PAID','gatewayPaymentId','cardLast4','processCardPayment','Any\x20other\x20card\x20number','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','payment.failed','$transaction','1117221jgXUOQ','call','payment.success','4zaKlZh','length','40mpomRu','application/json','toLowerCase','ðŸ§ª\x20Test\x20Gateway\x20result:','customerName'];a18_0x5f52=function(){return _0x4169cc;};return a18_0x5f52();}const testGatewayService_1=require(a18_0x10ccae(0x17b)),webhookService_1=require(a18_0x10ccae(0x138)),database_1=__importDefault(require(a18_0x10ccae(0x15e)));class TestGatewayController{constructor(){const _0x1a0661=a18_0x10ccae;this['getPaymentForm']=async(_0x391e1f,_0x16923c,_0x26a627)=>{const _0x28815a=a18_0x403c;try{const {paymentId:_0x5f0df3}=_0x391e1f[_0x28815a(0x144)];console[_0x28815a(0x14a)](_0x28815a(0x135)+_0x5f0df3);const _0x528375=await database_1[_0x28815a(0x13e)][_0x28815a(0x129)]['findUnique']({'where':{'id':_0x5f0df3},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x528375)return _0x16923c[_0x28815a(0x142)](0x194)[_0x28815a(0x17d)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x528375['gateway']!==_0x28815a(0x16c))return _0x16923c[_0x28815a(0x142)](0x190)[_0x28815a(0x17d)]({'success':![],'message':_0x28815a(0x127)});if(_0x528375[_0x28815a(0x142)]!==_0x28815a(0x182))return _0x16923c[_0x28815a(0x142)](0x190)[_0x28815a(0x17d)]({'success':![],'message':_0x28815a(0x177)+_0x528375[_0x28815a(0x142)]+',\x20cannot\x20process'});_0x16923c[_0x28815a(0x17d)]({'success':!![],'result':{'paymentId':_0x528375['id'],'orderId':_0x528375[_0x28815a(0x146)],'amount':_0x528375[_0x28815a(0x16d)],'currency':_0x528375[_0x28815a(0x155)],'merchantName':_0x528375[_0x28815a(0x156)][_0x28815a(0x17e)],'description':'Payment\x20to\x20'+_0x528375[_0x28815a(0x156)][_0x28815a(0x17e)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x28815a(0x18b),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x28815a(0x14d),'holderName':'Any\x20name'}}});}catch(_0x5dc56a){_0x26a627(_0x5dc56a);}},this['processCard']=async(_0x4c8ffa,_0x132287,_0x380b78)=>{const _0x128320=a18_0x403c;try{const {paymentId:_0x5c010a}=_0x4c8ffa[_0x128320(0x144)],_0x2c9187=_0x4c8ffa['body'];console[_0x128320(0x14a)](_0x128320(0x17a)+_0x5c010a);const _0x556a42=await database_1[_0x128320(0x13e)]['payment'][_0x128320(0x13f)]({'where':{'id':_0x5c010a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x556a42)return _0x132287[_0x128320(0x142)](0x194)['json']({'success':![],'message':_0x128320(0x141)});if(_0x556a42['gateway']!=='test_gateway')return _0x132287[_0x128320(0x142)](0x190)[_0x128320(0x17d)]({'success':![],'message':_0x128320(0x127)});if(_0x556a42[_0x128320(0x142)]!==_0x128320(0x182))return _0x132287[_0x128320(0x142)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x556a42['status']+_0x128320(0x125)});const _0x680c12=await this[_0x128320(0x178)][_0x128320(0x18a)]({'paymentId':_0x556a42['id'],'orderId':_0x556a42[_0x128320(0x146)]||_0x556a42['id'],'amount':_0x556a42[_0x128320(0x16d)],'currency':_0x556a42['currency'],'cardData':_0x2c9187});console[_0x128320(0x14a)](_0x128320(0x11d),_0x680c12);const _0xb544f9={'status':_0x680c12[_0x128320(0x142)],'updatedAt':new Date()};if(_0x680c12['status']===_0x128320(0x187))_0xb544f9[_0x128320(0x131)]=new Date(),_0xb544f9[_0x128320(0x188)]=_0x680c12[_0x128320(0x140)];else _0x680c12['status']==='FAILED'&&(_0xb544f9['failureMessage']=_0x680c12['failureReason']);const _0x2f4871=_0x2c9187[_0x128320(0x180)][_0x128320(0x179)](/[\s-]/g,'');_0xb544f9[_0x128320(0x189)]=_0x2f4871['slice'](-0x4),_0xb544f9[_0x128320(0x170)]=_0x128320(0x157),await database_1['default'][_0x128320(0x129)][_0x128320(0x15a)]({'where':{'id':_0x556a42['id']},'data':_0xb544f9});if(_0x680c12[_0x128320(0x142)]==='PAID'&&_0x556a42[_0x128320(0x185)]){console[_0x128320(0x14a)]('ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20'+_0x556a42['id']+_0x128320(0x137));try{await database_1[_0x128320(0x13e)][_0x128320(0x18e)](async _0x2a136c=>{const _0x5b9de2=_0x128320,_0x227c86=await _0x2a136c[_0x5b9de2(0x153)][_0x5b9de2(0x13f)]({'where':{'id':_0x556a42[_0x5b9de2(0x185)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x227c86){console[_0x5b9de2(0x14a)](_0x5b9de2(0x124)+_0x227c86['id']+_0x5b9de2(0x184)+_0x227c86[_0x5b9de2(0x164)]+_0x5b9de2(0x14e)+_0x227c86[_0x5b9de2(0x167)]+_0x5b9de2(0x14f)+_0x227c86[_0x5b9de2(0x142)]);const _0x49ee78=_0x227c86[_0x5b9de2(0x167)]+0x1,_0xb7ac45=_0x227c86[_0x5b9de2(0x164)]===_0x5b9de2(0x186)?_0x5b9de2(0x13c):_0x227c86['status'];await _0x2a136c[_0x5b9de2(0x153)][_0x5b9de2(0x15a)]({'where':{'id':_0x556a42[_0x5b9de2(0x185)]},'data':{'currentPayments':_0x49ee78,'status':_0xb7ac45,'updatedAt':new Date()}}),console[_0x5b9de2(0x14a)](_0x5b9de2(0x126)+_0x227c86['id']+_0x5b9de2(0x150)+_0x227c86[_0x5b9de2(0x167)]+_0x5b9de2(0x14b)+_0x49ee78+_0x5b9de2(0x14f)+_0x227c86[_0x5b9de2(0x142)]+_0x5b9de2(0x14b)+_0xb7ac45);}else console[_0x5b9de2(0x14a)]('âŒ\x20Payment\x20link\x20'+_0x556a42['paymentLinkId']+_0x5b9de2(0x123));});}catch(_0xaa087){console[_0x128320(0x152)](_0x128320(0x165),_0xaa087);}}await database_1[_0x128320(0x13e)][_0x128320(0x134)][_0x128320(0x162)]({'data':{'paymentId':_0x556a42['id'],'shopId':_0x556a42[_0x128320(0x15b)],'event':_0x128320(0x172)+_0x680c12[_0x128320(0x142)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x128320(0x12f)]({'oldStatus':'PENDING','newStatus':_0x680c12[_0x128320(0x142)],'transactionId':_0x680c12['transactionId'],'failureReason':_0x680c12['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x128320(0x122)](_0x556a42,_0x680c12['status'],_0x680c12[_0x128320(0x140)],_0x680c12['failureReason']),await this['sendPaymentStatusNotification'](_0x556a42,_0x680c12['status']),console[_0x128320(0x14a)](_0x128320(0x128)+_0x5c010a+_0x128320(0x121)+_0x680c12[_0x128320(0x142)]),_0x680c12[_0x128320(0x142)]==='PAID'?_0x132287[_0x128320(0x17d)]({'success':!![],'message':_0x128320(0x15c),'result':{'status':_0x128320(0x187),'transactionId':_0x680c12['transactionId'],'redirectUrl':_0x556a42[_0x128320(0x11f)]}}):_0x132287['status'](0x190)[_0x128320(0x17d)]({'success':![],'message':_0x128320(0x161),'result':{'status':'FAILED','failureReason':_0x680c12[_0x128320(0x181)],'redirectUrl':_0x556a42[_0x128320(0x143)]}});}catch(_0x21993c){_0x380b78(_0x21993c);}},this[_0x1a0661(0x178)]=new testGatewayService_1[(_0x1a0661(0x16b))](),this[_0x1a0661(0x175)]=new webhookService_1[(_0x1a0661(0x14c))]();}async[a18_0x10ccae(0x122)](_0x5a3232,_0xf46f98,_0x6baab4,_0x34099a){const _0xc1a9f4=a18_0x10ccae,_0x1fa934=Date[_0xc1a9f4(0x145)]();try{const _0x4026dc=_0x5a3232['shop'],_0x546a61=_0x4026dc[_0xc1a9f4(0x16a)];if(!_0x546a61?.[_0xc1a9f4(0x16f)]){console[_0xc1a9f4(0x14a)](_0xc1a9f4(0x159)+_0x4026dc['id']);return;}const _0xf00f09=_0xf46f98===_0xc1a9f4(0x187)?_0xc1a9f4(0x191):_0xc1a9f4(0x18d);let _0x161698=[];if(_0x546a61[_0xc1a9f4(0x158)])try{_0x161698=Array[_0xc1a9f4(0x176)](_0x546a61[_0xc1a9f4(0x158)])?_0x546a61[_0xc1a9f4(0x158)]:JSON[_0xc1a9f4(0x15f)](_0x546a61['webhookEvents']);}catch(_0x4330c3){console[_0xc1a9f4(0x152)]('Error\x20parsing\x20webhook\x20events:',_0x4330c3),_0x161698=[];}if(!_0x161698[_0xc1a9f4(0x169)](_0xf00f09)){console[_0xc1a9f4(0x14a)](_0xc1a9f4(0x13d)+_0xf00f09+_0xc1a9f4(0x166)+_0x4026dc['id']);return;}const _0x417dc3={'event':_0xf00f09,'payment':{'id':_0x5a3232['id'],'order_id':_0x5a3232[_0xc1a9f4(0x132)],'gateway_order_id':_0x5a3232[_0xc1a9f4(0x146)],'gateway':_0xc1a9f4(0x17f),'amount':_0x5a3232[_0xc1a9f4(0x16d)],'currency':_0x5a3232[_0xc1a9f4(0x155)],'status':_0xf46f98[_0xc1a9f4(0x11c)](),'customer_email':_0x5a3232['customerEmail'],'customer_name':_0x5a3232[_0xc1a9f4(0x11e)],'transaction_id':_0x6baab4,'failure_message':_0x34099a,'created_at':_0x5a3232[_0xc1a9f4(0x149)],'updated_at':new Date()}},_0x3e1f86=await fetch(_0x546a61[_0xc1a9f4(0x16f)],{'method':'POST','headers':{'Content-Type':_0xc1a9f4(0x11b),'User-Agent':_0xc1a9f4(0x136)},'body':JSON[_0xc1a9f4(0x12f)](_0x417dc3)}),_0x4aff43=Date[_0xc1a9f4(0x145)]()-_0x1fa934;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x546a61[_0xc1a9f4(0x16f)]+'\x20with\x20status\x20'+_0x3e1f86[_0xc1a9f4(0x142)]+'\x20('+_0x4aff43+_0xc1a9f4(0x12d));}catch(_0x2b85aa){console['error'](_0xc1a9f4(0x18c),_0x2b85aa);}}async[a18_0x10ccae(0x151)](_0x457a29,_0x26a620){const _0x297a15=a18_0x10ccae;try{const {telegramBotService:_0x5d60fe}=await Promise[_0x297a15(0x139)]()[_0x297a15(0x12b)](()=>__importStar(require('../services/telegramBotService'))),_0x1677af={'PAID':'paid','FAILED':_0x297a15(0x12e)},_0x38e665=_0x1677af[_0x26a620];if(!_0x38e665)return;await _0x5d60fe[_0x297a15(0x13a)](_0x457a29[_0x297a15(0x15b)],_0x457a29,_0x38e665);}catch(_0x1ae938){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1ae938);}}}exports[a18_0x10ccae(0x171)]=TestGatewayController;