'use strict';const a19_0x5d2b1b=a19_0x5d06;function a19_0xce3a(){const _0x16f014=['successUrl','Any\x203-4\x20digits','PAID','\x20not\x20found','ms)','configurable','../config/database','webhookEvents','sendPaymentNotification','2538VaaWQq','cardLast4','getOwnPropertyNames','test_gateway_','error','gatewayPaymentId','7165mJaTsy','defineProperty','TestGatewayService','4389504hYkgkU','2890445FnsFAx','9GUztpa','TestGatewayController','default','‚úÖ\x20Payment\x20link\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','Payment\x20to\x20','customerName','toISOString','settings','webhookLog','paid','../services/webhookService','status','gateway','failed','body','test_gateway','slice','sendPaymentStatusNotification','sendShopWebhook','COMPLETED','Payment\x20not\x20found','processCardPayment','Payment\x20status\x20is\x20','$transaction','cardNumber','shopId','update','getOwnPropertyDescriptor','now','hasOwnProperty','FAILED','\x20->\x20','processCard','__setModuleDefault','currentPayments','Webhook\x20event\x20','getPaymentForm','7362410kQuLQY','payment','transactionId','paymentLinkId','failUrl','__esModule','\x20updated:\x20currentPayments=','payment.success','162hBJVWQ','../services/telegramBotService','writable','stringify','Test\x20Gateway\x20webhook\x20sent\x20to\x20','../services/gateways/testGatewayService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20with\x20status\x20','üìà\x20Found\x20payment\x20link\x20','gatewayOrderId','amount','currency','üß™\x20Test\x20Gateway\x20result:','length','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','createdAt','39742307AqNAuS','name','__importStar','PENDING','__importDefault','\x20not\x20enabled\x20for\x20shop\x20',',\x20status=','toLowerCase','payment.failed','json','Payment\x20System/1.0\x20(Test\x20Gateway)','customerEmail',',\x20currentPayments=','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','test_card','Error\x20parsing\x20webhook\x20events:','paymentMethod','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','testGatewayService','üìà\x20Test\x20Gateway:\x20Payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','call','type','WebhookService','failureReason','shop','\x20processed:\x20',',\x20cannot\x20process','then','Any\x20name','webhookUrl','Payment\x20failed','23488bgrfKR','params','create','POST','parse','paidAt','findUnique','‚úÖ\x20Test\x20Gateway\x20payment\x20','Payment\x20processed\x20successfully','2163wudTpE','3428ctvduW','log'];a19_0xce3a=function(){return _0x16f014;};return a19_0xce3a();}(function(_0x5ed4d8,_0x2e6c09){const _0x166512=a19_0x5d06,_0x522ca0=_0x5ed4d8();while(!![]){try{const _0x5d4c48=parseInt(_0x166512(0x221))/0x1*(-parseInt(_0x166512(0x254))/0x2)+parseInt(_0x166512(0x21b))/0x3*(-parseInt(_0x166512(0x210))/0x4)+parseInt(_0x166512(0x225))/0x5+-parseInt(_0x166512(0x224))/0x6+parseInt(_0x166512(0x20f))/0x7*(-parseInt(_0x166512(0x206))/0x8)+parseInt(_0x166512(0x226))/0x9*(-parseInt(_0x166512(0x24c))/0xa)+parseInt(_0x166512(0x1e6))/0xb;if(_0x5d4c48===_0x2e6c09)break;else _0x522ca0['push'](_0x522ca0['shift']());}catch(_0x224699){_0x522ca0['push'](_0x522ca0['shift']());}}}(a19_0xce3a,0x7ca7e));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x24100f,_0x132fb3,_0x31b0ce,_0x282737){const _0x2c7084=a19_0x5d06;if(_0x282737===undefined)_0x282737=_0x31b0ce;var _0x4170e7=Object[_0x2c7084(0x242)](_0x132fb3,_0x31b0ce);(!_0x4170e7||('get'in _0x4170e7?!_0x132fb3[_0x2c7084(0x251)]:_0x4170e7[_0x2c7084(0x256)]||_0x4170e7[_0x2c7084(0x217)]))&&(_0x4170e7={'enumerable':!![],'get':function(){return _0x132fb3[_0x31b0ce];}}),Object['defineProperty'](_0x24100f,_0x282737,_0x4170e7);}:function(_0x1df503,_0x5c24fd,_0xc675e8,_0x47ee32){if(_0x47ee32===undefined)_0x47ee32=_0xc675e8;_0x1df503[_0x47ee32]=_0x5c24fd[_0xc675e8];}),__setModuleDefault=this&&this[a19_0x5d2b1b(0x248)]||(Object[a19_0x5d2b1b(0x208)]?function(_0x4382dd,_0x14a9cb){const _0x54fbac=a19_0x5d2b1b;Object['defineProperty'](_0x4382dd,_0x54fbac(0x228),{'enumerable':!![],'value':_0x14a9cb});}:function(_0x16a2ca,_0x371c3e){const _0x5e58cd=a19_0x5d2b1b;_0x16a2ca[_0x5e58cd(0x228)]=_0x371c3e;}),__importStar=this&&this[a19_0x5d2b1b(0x1e8)]||(function(){var _0x51c8f3=function(_0x2c8ab6){const _0x4f37d4=a19_0x5d06;return _0x51c8f3=Object[_0x4f37d4(0x21d)]||function(_0x1e91eb){const _0x24adc1=_0x4f37d4;var _0x5c5ddf=[];for(var _0x580ed7 in _0x1e91eb)if(Object['prototype'][_0x24adc1(0x244)][_0x24adc1(0x1fb)](_0x1e91eb,_0x580ed7))_0x5c5ddf[_0x5c5ddf[_0x24adc1(0x1e2)]]=_0x580ed7;return _0x5c5ddf;},_0x51c8f3(_0x2c8ab6);};return function(_0x2d5386){if(_0x2d5386&&_0x2d5386['__esModule'])return _0x2d5386;var _0x13c250={};if(_0x2d5386!=null){for(var _0x520879=_0x51c8f3(_0x2d5386),_0x3b5739=0x0;_0x3b5739<_0x520879['length'];_0x3b5739++)if(_0x520879[_0x3b5739]!=='default')__createBinding(_0x13c250,_0x2d5386,_0x520879[_0x3b5739]);}return __setModuleDefault(_0x13c250,_0x2d5386),_0x13c250;};}()),__importDefault=this&&this[a19_0x5d2b1b(0x1ea)]||function(_0x4ba327){const _0x25b5d0=a19_0x5d2b1b;return _0x4ba327&&_0x4ba327[_0x25b5d0(0x251)]?_0x4ba327:{'default':_0x4ba327};};Object[a19_0x5d2b1b(0x222)](exports,a19_0x5d2b1b(0x251),{'value':!![]}),exports[a19_0x5d2b1b(0x227)]=void 0x0;function a19_0x5d06(_0x28024d,_0x3673d5){_0x28024d=_0x28024d-0x1dc;const _0xce3ad1=a19_0xce3a();let _0x5d06a5=_0xce3ad1[_0x28024d];return _0x5d06a5;}const testGatewayService_1=require(a19_0x5d2b1b(0x259)),webhookService_1=require(a19_0x5d2b1b(0x231)),database_1=__importDefault(require(a19_0x5d2b1b(0x218)));class TestGatewayController{constructor(){const _0x59d75f=a19_0x5d2b1b;this[_0x59d75f(0x24b)]=async(_0x1c0563,_0x3b3b0a,_0x402697)=>{const _0x5c5d3d=_0x59d75f;try{const {paymentId:_0x4d7c8c}=_0x1c0563['params'];console[_0x5c5d3d(0x211)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4d7c8c);const _0x89c25b=await database_1[_0x5c5d3d(0x228)][_0x5c5d3d(0x24d)][_0x5c5d3d(0x20c)]({'where':{'id':_0x4d7c8c},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x89c25b)return _0x3b3b0a['status'](0x194)[_0x5c5d3d(0x1ef)]({'success':![],'message':_0x5c5d3d(0x23b)});if(_0x89c25b[_0x5c5d3d(0x233)]!==_0x5c5d3d(0x236))return _0x3b3b0a[_0x5c5d3d(0x232)](0x190)[_0x5c5d3d(0x1ef)]({'success':![],'message':_0x5c5d3d(0x22a)});if(_0x89c25b[_0x5c5d3d(0x232)]!==_0x5c5d3d(0x1e9))return _0x3b3b0a[_0x5c5d3d(0x232)](0x190)['json']({'success':![],'message':_0x5c5d3d(0x23d)+_0x89c25b[_0x5c5d3d(0x232)]+_0x5c5d3d(0x201)});_0x3b3b0a[_0x5c5d3d(0x1ef)]({'success':!![],'result':{'paymentId':_0x89c25b['id'],'orderId':_0x89c25b[_0x5c5d3d(0x1de)],'amount':_0x89c25b['amount'],'currency':_0x89c25b[_0x5c5d3d(0x1e0)],'merchantName':_0x89c25b['shop'][_0x5c5d3d(0x1e7)],'description':_0x5c5d3d(0x22b)+_0x89c25b[_0x5c5d3d(0x1ff)][_0x5c5d3d(0x1e7)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x5c5d3d(0x213),'holderName':_0x5c5d3d(0x203)}}});}catch(_0x4444b1){_0x402697(_0x4444b1);}},this[_0x59d75f(0x247)]=async(_0x5463ad,_0x396e7e,_0x5147b9)=>{const _0x11ecaf=_0x59d75f;try{const {paymentId:_0x1c20df}=_0x5463ad[_0x11ecaf(0x207)],_0x1d0d00=_0x5463ad[_0x11ecaf(0x235)];console['log'](_0x11ecaf(0x1e3)+_0x1c20df);const _0x278f54=await database_1[_0x11ecaf(0x228)][_0x11ecaf(0x24d)][_0x11ecaf(0x20c)]({'where':{'id':_0x1c20df},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x278f54)return _0x396e7e[_0x11ecaf(0x232)](0x194)[_0x11ecaf(0x1ef)]({'success':![],'message':_0x11ecaf(0x23b)});if(_0x278f54[_0x11ecaf(0x233)]!==_0x11ecaf(0x236))return _0x396e7e[_0x11ecaf(0x232)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x278f54[_0x11ecaf(0x232)]!==_0x11ecaf(0x1e9))return _0x396e7e[_0x11ecaf(0x232)](0x190)[_0x11ecaf(0x1ef)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x278f54[_0x11ecaf(0x232)]+',\x20cannot\x20process'});const _0x571faa=await this['testGatewayService'][_0x11ecaf(0x23c)]({'paymentId':_0x278f54['id'],'orderId':_0x278f54['gatewayOrderId']||_0x278f54['id'],'amount':_0x278f54[_0x11ecaf(0x1df)],'currency':_0x278f54['currency'],'cardData':_0x1d0d00});console[_0x11ecaf(0x211)](_0x11ecaf(0x1e1),_0x571faa);const _0x316e20={'status':_0x571faa[_0x11ecaf(0x232)],'updatedAt':new Date()};if(_0x571faa[_0x11ecaf(0x232)]===_0x11ecaf(0x214))_0x316e20[_0x11ecaf(0x20b)]=new Date(),_0x316e20[_0x11ecaf(0x220)]=_0x571faa['transactionId'];else _0x571faa[_0x11ecaf(0x232)]===_0x11ecaf(0x245)&&(_0x316e20['failureMessage']=_0x571faa['failureReason']);const _0x323775=_0x1d0d00[_0x11ecaf(0x23f)]['replace'](/[\s-]/g,'');_0x316e20[_0x11ecaf(0x21c)]=_0x323775[_0x11ecaf(0x237)](-0x4),_0x316e20[_0x11ecaf(0x1f6)]=_0x11ecaf(0x1f4),await database_1['default'][_0x11ecaf(0x24d)][_0x11ecaf(0x241)]({'where':{'id':_0x278f54['id']},'data':_0x316e20});if(_0x571faa[_0x11ecaf(0x232)]===_0x11ecaf(0x214)&&_0x278f54['paymentLinkId']){console[_0x11ecaf(0x211)](_0x11ecaf(0x1f9)+_0x278f54['id']+_0x11ecaf(0x25a));try{await database_1[_0x11ecaf(0x228)][_0x11ecaf(0x23e)](async _0x14b38e=>{const _0x158a9a=_0x11ecaf,_0x57bdc8=await _0x14b38e['paymentLink'][_0x158a9a(0x20c)]({'where':{'id':_0x278f54[_0x158a9a(0x24f)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x57bdc8){console[_0x158a9a(0x211)](_0x158a9a(0x1dd)+_0x57bdc8['id']+':\x20type='+_0x57bdc8[_0x158a9a(0x1fc)]+_0x158a9a(0x1f2)+_0x57bdc8[_0x158a9a(0x249)]+_0x158a9a(0x1ec)+_0x57bdc8[_0x158a9a(0x232)]);const _0x4d7ed9=_0x57bdc8[_0x158a9a(0x249)]+0x1,_0x1b24e1=_0x57bdc8[_0x158a9a(0x1fc)]==='SINGLE'?_0x158a9a(0x23a):_0x57bdc8[_0x158a9a(0x232)];await _0x14b38e['paymentLink'][_0x158a9a(0x241)]({'where':{'id':_0x278f54['paymentLinkId']},'data':{'currentPayments':_0x4d7ed9,'status':_0x1b24e1,'updatedAt':new Date()}}),console[_0x158a9a(0x211)](_0x158a9a(0x229)+_0x57bdc8['id']+_0x158a9a(0x252)+_0x57bdc8[_0x158a9a(0x249)]+_0x158a9a(0x246)+_0x4d7ed9+_0x158a9a(0x1ec)+_0x57bdc8[_0x158a9a(0x232)]+_0x158a9a(0x246)+_0x1b24e1);}else console[_0x158a9a(0x211)]('‚ùå\x20Payment\x20link\x20'+_0x278f54['paymentLinkId']+_0x158a9a(0x215));});}catch(_0x21bb91){console[_0x11ecaf(0x21f)](_0x11ecaf(0x1e4),_0x21bb91);}}await database_1[_0x11ecaf(0x228)][_0x11ecaf(0x22f)][_0x11ecaf(0x208)]({'data':{'paymentId':_0x278f54['id'],'shopId':_0x278f54[_0x11ecaf(0x240)],'event':_0x11ecaf(0x21e)+_0x571faa[_0x11ecaf(0x232)][_0x11ecaf(0x1ed)](),'statusCode':0xc8,'responseBody':JSON[_0x11ecaf(0x257)]({'oldStatus':_0x11ecaf(0x1e9),'newStatus':_0x571faa[_0x11ecaf(0x232)],'transactionId':_0x571faa[_0x11ecaf(0x24e)],'failureReason':_0x571faa['failureReason'],'processedAt':new Date()[_0x11ecaf(0x22d)]()})}}),await this[_0x11ecaf(0x239)](_0x278f54,_0x571faa[_0x11ecaf(0x232)],_0x571faa[_0x11ecaf(0x24e)],_0x571faa[_0x11ecaf(0x1fe)]),await this[_0x11ecaf(0x238)](_0x278f54,_0x571faa['status']),console[_0x11ecaf(0x211)](_0x11ecaf(0x20d)+_0x1c20df+_0x11ecaf(0x200)+_0x571faa['status']),_0x571faa['status']===_0x11ecaf(0x214)?_0x396e7e[_0x11ecaf(0x1ef)]({'success':!![],'message':_0x11ecaf(0x20e),'result':{'status':'PAID','transactionId':_0x571faa[_0x11ecaf(0x24e)],'redirectUrl':_0x278f54[_0x11ecaf(0x212)]}}):_0x396e7e[_0x11ecaf(0x232)](0x190)[_0x11ecaf(0x1ef)]({'success':![],'message':_0x11ecaf(0x205),'result':{'status':_0x11ecaf(0x245),'failureReason':_0x571faa[_0x11ecaf(0x1fe)],'redirectUrl':_0x278f54[_0x11ecaf(0x250)]}});}catch(_0x1292f4){_0x5147b9(_0x1292f4);}},this[_0x59d75f(0x1f8)]=new testGatewayService_1[(_0x59d75f(0x223))](),this['webhookService']=new webhookService_1[(_0x59d75f(0x1fd))]();}async[a19_0x5d2b1b(0x239)](_0x1a3481,_0x4be7b6,_0x22681b,_0x3aba2a){const _0x3d8fa8=a19_0x5d2b1b,_0x2852c3=Date[_0x3d8fa8(0x243)]();try{const _0x56697f=_0x1a3481[_0x3d8fa8(0x1ff)],_0x27e30e=_0x56697f[_0x3d8fa8(0x22e)];if(!_0x27e30e?.[_0x3d8fa8(0x204)]){console['log'](_0x3d8fa8(0x1fa)+_0x56697f['id']);return;}const _0x525fcc=_0x4be7b6===_0x3d8fa8(0x214)?_0x3d8fa8(0x253):_0x3d8fa8(0x1ee);let _0x450ce1=[];if(_0x27e30e[_0x3d8fa8(0x219)])try{_0x450ce1=Array['isArray'](_0x27e30e[_0x3d8fa8(0x219)])?_0x27e30e[_0x3d8fa8(0x219)]:JSON[_0x3d8fa8(0x20a)](_0x27e30e['webhookEvents']);}catch(_0x263acc){console[_0x3d8fa8(0x21f)](_0x3d8fa8(0x1f5),_0x263acc),_0x450ce1=[];}if(!_0x450ce1['includes'](_0x525fcc)){console[_0x3d8fa8(0x211)](_0x3d8fa8(0x24a)+_0x525fcc+_0x3d8fa8(0x1eb)+_0x56697f['id']);return;}const _0x9c06cf={'event':_0x525fcc,'payment':{'id':_0x1a3481['id'],'order_id':_0x1a3481['orderId'],'gateway_order_id':_0x1a3481[_0x3d8fa8(0x1de)],'gateway':'0000','amount':_0x1a3481[_0x3d8fa8(0x1df)],'currency':_0x1a3481[_0x3d8fa8(0x1e0)],'status':_0x4be7b6[_0x3d8fa8(0x1ed)](),'customer_email':_0x1a3481[_0x3d8fa8(0x1f1)],'customer_name':_0x1a3481[_0x3d8fa8(0x22c)],'transaction_id':_0x22681b,'failure_message':_0x3aba2a,'created_at':_0x1a3481[_0x3d8fa8(0x1e5)],'updated_at':new Date()}},_0x10ecdc=await fetch(_0x27e30e[_0x3d8fa8(0x204)],{'method':_0x3d8fa8(0x209),'headers':{'Content-Type':'application/json','User-Agent':_0x3d8fa8(0x1f0)},'body':JSON[_0x3d8fa8(0x257)](_0x9c06cf)}),_0x33f693=Date[_0x3d8fa8(0x243)]()-_0x2852c3;console['log'](_0x3d8fa8(0x258)+_0x27e30e[_0x3d8fa8(0x204)]+_0x3d8fa8(0x1dc)+_0x10ecdc[_0x3d8fa8(0x232)]+'\x20('+_0x33f693+_0x3d8fa8(0x216));}catch(_0x21e127){console['error'](_0x3d8fa8(0x1f3),_0x21e127);}}async['sendPaymentStatusNotification'](_0x3e1a54,_0x494283){const _0x56438d=a19_0x5d2b1b;try{const {telegramBotService:_0x52963e}=await Promise['resolve']()[_0x56438d(0x202)](()=>__importStar(require(_0x56438d(0x255)))),_0x5dde80={'PAID':_0x56438d(0x230),'FAILED':_0x56438d(0x234)},_0xadcc63=_0x5dde80[_0x494283];if(!_0xadcc63)return;await _0x52963e[_0x56438d(0x21a)](_0x3e1a54['shopId'],_0x3e1a54,_0xadcc63);}catch(_0x3e9785){console[_0x56438d(0x21f)](_0x56438d(0x1f7),_0x3e9785);}}}exports['TestGatewayController']=TestGatewayController;