'use strict';const a13_0x422557=a13_0x4561;function a13_0x4561(_0x214fe0,_0x86a887){const _0x1bfbe3=a13_0x1bfb();return a13_0x4561=function(_0x456192,_0x86ca16){_0x456192=_0x456192-0x188;let _0x1046e7=_0x1bfbe3[_0x456192];return _0x1046e7;},a13_0x4561(_0x214fe0,_0x86a887);}(function(_0x17a62b,_0x4bb74c){const _0x1236e4=a13_0x4561,_0x135bdc=_0x17a62b();while(!![]){try{const _0x39833b=parseInt(_0x1236e4(0x1f4))/0x1*(parseInt(_0x1236e4(0x19e))/0x2)+-parseInt(_0x1236e4(0x1b9))/0x3*(-parseInt(_0x1236e4(0x1c1))/0x4)+-parseInt(_0x1236e4(0x1d6))/0x5+-parseInt(_0x1236e4(0x188))/0x6*(-parseInt(_0x1236e4(0x1e0))/0x7)+-parseInt(_0x1236e4(0x1be))/0x8*(parseInt(_0x1236e4(0x1c3))/0x9)+parseInt(_0x1236e4(0x1aa))/0xa+-parseInt(_0x1236e4(0x1ba))/0xb;if(_0x39833b===_0x4bb74c)break;else _0x135bdc['push'](_0x135bdc['shift']());}catch(_0x239fd7){_0x135bdc['push'](_0x135bdc['shift']());}}}(a13_0x1bfb,0x2bb21));var __createBinding=this&&this[a13_0x422557(0x1c0)]||(Object['create']?function(_0x37f708,_0x4b42a9,_0x14d30c,_0x1d6afc){const _0x18af82=a13_0x422557;if(_0x1d6afc===undefined)_0x1d6afc=_0x14d30c;var _0x23177a=Object[_0x18af82(0x18d)](_0x4b42a9,_0x14d30c);(!_0x23177a||(_0x18af82(0x1a8)in _0x23177a?!_0x4b42a9[_0x18af82(0x1d1)]:_0x23177a['writable']||_0x23177a[_0x18af82(0x1b2)]))&&(_0x23177a={'enumerable':!![],'get':function(){return _0x4b42a9[_0x14d30c];}}),Object['defineProperty'](_0x37f708,_0x1d6afc,_0x23177a);}:function(_0x113eb8,_0x14d17f,_0x103d7f,_0x3654b5){if(_0x3654b5===undefined)_0x3654b5=_0x103d7f;_0x113eb8[_0x3654b5]=_0x14d17f[_0x103d7f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x422557(0x1d7)]?function(_0x9daf08,_0x53750b){const _0x10736d=a13_0x422557;Object['defineProperty'](_0x9daf08,_0x10736d(0x1e1),{'enumerable':!![],'value':_0x53750b});}:function(_0x4dd20b,_0x206b75){_0x4dd20b['default']=_0x206b75;}),__importStar=this&&this['__importStar']||(function(){var _0x2c1471=function(_0x38c1b9){const _0xd6ba0b=a13_0x4561;return _0x2c1471=Object[_0xd6ba0b(0x193)]||function(_0x403c5e){const _0x30586d=_0xd6ba0b;var _0x28d5b9=[];for(var _0x1c2753 in _0x403c5e)if(Object['prototype'][_0x30586d(0x1cf)][_0x30586d(0x1f1)](_0x403c5e,_0x1c2753))_0x28d5b9[_0x28d5b9[_0x30586d(0x1a2)]]=_0x1c2753;return _0x28d5b9;},_0x2c1471(_0x38c1b9);};return function(_0x4dd912){const _0x215a16=a13_0x4561;if(_0x4dd912&&_0x4dd912[_0x215a16(0x1d1)])return _0x4dd912;var _0x2f1e6b={};if(_0x4dd912!=null){for(var _0x49b55b=_0x2c1471(_0x4dd912),_0x12576d=0x0;_0x12576d<_0x49b55b[_0x215a16(0x1a2)];_0x12576d++)if(_0x49b55b[_0x12576d]!==_0x215a16(0x1e1))__createBinding(_0x2f1e6b,_0x4dd912,_0x49b55b[_0x12576d]);}return __setModuleDefault(_0x2f1e6b,_0x4dd912),_0x2f1e6b;};}()),__importDefault=this&&this[a13_0x422557(0x198)]||function(_0x349954){const _0x58aeba=a13_0x422557;return _0x349954&&_0x349954[_0x58aeba(0x1d1)]?_0x349954:{'default':_0x349954};};Object[a13_0x422557(0x19b)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x422557(0x1ec)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x422557(0x1f0)));function a13_0x1bfb(){const _0x276b53=['Payment\x20not\x20found','createdAt','WebhookService','get','slice','3131220AaNeKl','\x20processed:\x20','settings','sendShopWebhook','../services/telegramBotService','testGatewayService','cardLast4','failed','configurable','params','processCardPayment','Payment\x20status\x20is\x20','Any\x20other\x20card\x20number','log','transactionId','962769DduqnO','5947117ZRYhul','json','shop','Webhook\x20event\x20','104KrqNgG','sendPaymentStatusNotification','__createBinding','4qQbYxG','name','145206BRJDFQ','Payment\x20failed','amount','currency','Any\x20future\x20date\x20(MM/YY)','getPaymentForm','webhookService','payment.failed','webhookEvents','âœ…\x20Test\x20Gateway\x20payment\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','update','hasOwnProperty','test_card','__esModule','successUrl','ðŸ§ª\x20Test\x20Gateway\x20result:','webhookLog','shopId','778385VWMSOe','create','payment','gateway','gatewayPaymentId','customerName','POST','test_gateway_','Payment\x20to\x20','failUrl','7nyHLLV','default','error','test_gateway','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','includes','toLowerCase','Any\x20name','PAID','\x20with\x20status\x20','cardNumber','orderId','../services/gateways/testGatewayService','paid','failureReason','now','../config/database','call','Any\x203-4\x20digits',',\x20cannot\x20process','8022KXApzz','1935876zCDsuZ','payment.success','Payment\x20is\x20not\x20for\x20test\x20gateway','gatewayOrderId','paidAt','getOwnPropertyDescriptor','body','0000','ms)','webhookUrl','Error\x20parsing\x20webhook\x20events:','getOwnPropertyNames','status','application/json','sendPaymentNotification','then','__importDefault','\x20not\x20enabled\x20for\x20shop\x20','failureMessage','defineProperty','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','findUnique','32BIOxDm','stringify','PENDING','TestGatewayController','length','processCard','paymentMethod'];a13_0x1bfb=function(){return _0x276b53;};return a13_0x1bfb();}class TestGatewayController{constructor(){const _0x2eb962=a13_0x422557;this[_0x2eb962(0x1c8)]=async(_0x56890f,_0x162f33,_0x350840)=>{const _0x5a47dc=_0x2eb962;try{const {paymentId:_0x10bbce}=_0x56890f[_0x5a47dc(0x1b3)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x10bbce);const _0x857a78=await database_1[_0x5a47dc(0x1e1)][_0x5a47dc(0x1d8)][_0x5a47dc(0x19d)]({'where':{'id':_0x10bbce},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x857a78)return _0x162f33[_0x5a47dc(0x194)](0x194)['json']({'success':![],'message':_0x5a47dc(0x1a5)});if(_0x857a78[_0x5a47dc(0x1d9)]!==_0x5a47dc(0x1e3))return _0x162f33['status'](0x190)[_0x5a47dc(0x1bb)]({'success':![],'message':_0x5a47dc(0x18a)});if(_0x857a78['status']!==_0x5a47dc(0x1a0))return _0x162f33['status'](0x190)[_0x5a47dc(0x1bb)]({'success':![],'message':_0x5a47dc(0x1b5)+_0x857a78[_0x5a47dc(0x194)]+',\x20cannot\x20process'});_0x162f33[_0x5a47dc(0x1bb)]({'success':!![],'result':{'paymentId':_0x857a78['id'],'orderId':_0x857a78[_0x5a47dc(0x18b)],'amount':_0x857a78[_0x5a47dc(0x1c5)],'currency':_0x857a78[_0x5a47dc(0x1c6)],'merchantName':_0x857a78[_0x5a47dc(0x1bc)]['name'],'description':_0x5a47dc(0x1de)+_0x857a78[_0x5a47dc(0x1bc)][_0x5a47dc(0x1c2)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5a47dc(0x1b6),'expiryDate':_0x5a47dc(0x1c7),'cvc':_0x5a47dc(0x1f2),'holderName':_0x5a47dc(0x1e7)}}});}catch(_0x4a1f4e){_0x350840(_0x4a1f4e);}},this[_0x2eb962(0x1a3)]=async(_0x5b3d6e,_0x3d544e,_0x132847)=>{const _0x3758c1=_0x2eb962;try{const {paymentId:_0x4dc1ec}=_0x5b3d6e[_0x3758c1(0x1b3)],_0x4b72c6=_0x5b3d6e[_0x3758c1(0x18e)];console[_0x3758c1(0x1b7)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4dc1ec);const _0x2f93d6=await database_1['default'][_0x3758c1(0x1d8)][_0x3758c1(0x19d)]({'where':{'id':_0x4dc1ec},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2f93d6)return _0x3d544e[_0x3758c1(0x194)](0x194)[_0x3758c1(0x1bb)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2f93d6[_0x3758c1(0x1d9)]!=='test_gateway')return _0x3d544e[_0x3758c1(0x194)](0x190)[_0x3758c1(0x1bb)]({'success':![],'message':_0x3758c1(0x18a)});if(_0x2f93d6[_0x3758c1(0x194)]!==_0x3758c1(0x1a0))return _0x3d544e[_0x3758c1(0x194)](0x190)[_0x3758c1(0x1bb)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2f93d6[_0x3758c1(0x194)]+_0x3758c1(0x1f3)});const _0x3442d3=await this[_0x3758c1(0x1af)][_0x3758c1(0x1b4)]({'paymentId':_0x2f93d6['id'],'orderId':_0x2f93d6[_0x3758c1(0x18b)]||_0x2f93d6['id'],'amount':_0x2f93d6[_0x3758c1(0x1c5)],'currency':_0x2f93d6[_0x3758c1(0x1c6)],'cardData':_0x4b72c6});console[_0x3758c1(0x1b7)](_0x3758c1(0x1d3),_0x3442d3);const _0x5c5d54={'status':_0x3442d3[_0x3758c1(0x194)],'updatedAt':new Date()};if(_0x3442d3[_0x3758c1(0x194)]===_0x3758c1(0x1e8))_0x5c5d54[_0x3758c1(0x18c)]=new Date(),_0x5c5d54[_0x3758c1(0x1da)]=_0x3442d3[_0x3758c1(0x1b8)];else _0x3442d3[_0x3758c1(0x194)]==='FAILED'&&(_0x5c5d54[_0x3758c1(0x19a)]=_0x3442d3['failureReason']);const _0x3a26e2=_0x4b72c6[_0x3758c1(0x1ea)]['replace'](/[\s-]/g,'');_0x5c5d54[_0x3758c1(0x1b0)]=_0x3a26e2[_0x3758c1(0x1a9)](-0x4),_0x5c5d54[_0x3758c1(0x1a4)]=_0x3758c1(0x1d0),await database_1[_0x3758c1(0x1e1)][_0x3758c1(0x1d8)][_0x3758c1(0x1ce)]({'where':{'id':_0x2f93d6['id']},'data':_0x5c5d54}),await database_1[_0x3758c1(0x1e1)][_0x3758c1(0x1d4)][_0x3758c1(0x1d7)]({'data':{'paymentId':_0x2f93d6['id'],'shopId':_0x2f93d6[_0x3758c1(0x1d5)],'event':_0x3758c1(0x1dd)+_0x3442d3[_0x3758c1(0x194)][_0x3758c1(0x1e6)](),'statusCode':0xc8,'responseBody':JSON[_0x3758c1(0x19f)]({'oldStatus':_0x3758c1(0x1a0),'newStatus':_0x3442d3['status'],'transactionId':_0x3442d3['transactionId'],'failureReason':_0x3442d3['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x3758c1(0x1ad)](_0x2f93d6,_0x3442d3[_0x3758c1(0x194)],_0x3442d3[_0x3758c1(0x1b8)],_0x3442d3[_0x3758c1(0x1ee)]),await this['sendPaymentStatusNotification'](_0x2f93d6,_0x3442d3[_0x3758c1(0x194)]),console['log'](_0x3758c1(0x1cc)+_0x4dc1ec+_0x3758c1(0x1ab)+_0x3442d3[_0x3758c1(0x194)]),_0x3442d3[_0x3758c1(0x194)]===_0x3758c1(0x1e8)?_0x3d544e[_0x3758c1(0x1bb)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3758c1(0x1e8),'transactionId':_0x3442d3['transactionId'],'redirectUrl':_0x2f93d6[_0x3758c1(0x1d2)]}}):_0x3d544e[_0x3758c1(0x194)](0x190)[_0x3758c1(0x1bb)]({'success':![],'message':_0x3758c1(0x1c4),'result':{'status':'FAILED','failureReason':_0x3442d3[_0x3758c1(0x1ee)],'redirectUrl':_0x2f93d6[_0x3758c1(0x1df)]}});}catch(_0x40005e){_0x132847(_0x40005e);}},this[_0x2eb962(0x1af)]=new testGatewayService_1['TestGatewayService'](),this[_0x2eb962(0x1c9)]=new webhookService_1[(_0x2eb962(0x1a7))]();}async[a13_0x422557(0x1ad)](_0x5e99c3,_0x2efbc6,_0x326cc6,_0x197d2d){const _0x543e16=a13_0x422557,_0x1a98c9=Date[_0x543e16(0x1ef)]();try{const _0x57c02a=_0x5e99c3[_0x543e16(0x1bc)],_0x1ff90a=_0x57c02a[_0x543e16(0x1ac)];if(!_0x1ff90a?.[_0x543e16(0x191)]){console[_0x543e16(0x1b7)](_0x543e16(0x19c)+_0x57c02a['id']);return;}const _0x4b8829=_0x2efbc6===_0x543e16(0x1e8)?_0x543e16(0x189):_0x543e16(0x1ca);let _0x54dc82=[];if(_0x1ff90a[_0x543e16(0x1cb)])try{_0x54dc82=Array['isArray'](_0x1ff90a['webhookEvents'])?_0x1ff90a[_0x543e16(0x1cb)]:JSON['parse'](_0x1ff90a['webhookEvents']);}catch(_0x180239){console[_0x543e16(0x1e2)](_0x543e16(0x192),_0x180239),_0x54dc82=[];}if(!_0x54dc82[_0x543e16(0x1e5)](_0x4b8829)){console[_0x543e16(0x1b7)](_0x543e16(0x1bd)+_0x4b8829+_0x543e16(0x199)+_0x57c02a['id']);return;}const _0x272ac7={'event':_0x4b8829,'payment':{'id':_0x5e99c3['id'],'order_id':_0x5e99c3[_0x543e16(0x1eb)],'gateway_order_id':_0x5e99c3[_0x543e16(0x18b)],'gateway':_0x543e16(0x18f),'amount':_0x5e99c3[_0x543e16(0x1c5)],'currency':_0x5e99c3[_0x543e16(0x1c6)],'status':_0x2efbc6[_0x543e16(0x1e6)](),'customer_email':_0x5e99c3['customerEmail'],'customer_name':_0x5e99c3[_0x543e16(0x1db)],'transaction_id':_0x326cc6,'failure_message':_0x197d2d,'created_at':_0x5e99c3[_0x543e16(0x1a6)],'updated_at':new Date()}},_0x217549=await fetch(_0x1ff90a[_0x543e16(0x191)],{'method':_0x543e16(0x1dc),'headers':{'Content-Type':_0x543e16(0x195),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x543e16(0x19f)](_0x272ac7)}),_0x328d0e=Date[_0x543e16(0x1ef)]()-_0x1a98c9;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x1ff90a['webhookUrl']+_0x543e16(0x1e9)+_0x217549[_0x543e16(0x194)]+'\x20('+_0x328d0e+_0x543e16(0x190));}catch(_0x49a875){console[_0x543e16(0x1e2)](_0x543e16(0x1cd),_0x49a875);}}async[a13_0x422557(0x1bf)](_0x3d1984,_0x28b73a){const _0x5191ca=a13_0x422557;try{const {telegramBotService:_0x132e7e}=await Promise['resolve']()[_0x5191ca(0x197)](()=>__importStar(require(_0x5191ca(0x1ae)))),_0x573a6f={'PAID':_0x5191ca(0x1ed),'FAILED':_0x5191ca(0x1b1)},_0x3e6f8a=_0x573a6f[_0x28b73a];if(!_0x3e6f8a)return;await _0x132e7e[_0x5191ca(0x196)](_0x3d1984[_0x5191ca(0x1d5)],_0x3d1984,_0x3e6f8a);}catch(_0xa6a504){console[_0x5191ca(0x1e2)](_0x5191ca(0x1e4),_0xa6a504);}}}exports[a13_0x422557(0x1a1)]=TestGatewayController;