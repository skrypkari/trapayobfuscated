'use strict';const a15_0x25e28a=a15_0x1fdc;(function(_0x1a9691,_0x466df0){const _0x224412=a15_0x1fdc,_0x1dac4f=_0x1a9691();while(!![]){try{const _0x122158=-parseInt(_0x224412(0x11d))/0x1+parseInt(_0x224412(0x127))/0x2*(-parseInt(_0x224412(0x106))/0x3)+-parseInt(_0x224412(0x100))/0x4*(-parseInt(_0x224412(0xfe))/0x5)+-parseInt(_0x224412(0x152))/0x6*(-parseInt(_0x224412(0x13f))/0x7)+-parseInt(_0x224412(0x165))/0x8*(-parseInt(_0x224412(0x162))/0x9)+-parseInt(_0x224412(0x142))/0xa+parseInt(_0x224412(0x172))/0xb;if(_0x122158===_0x466df0)break;else _0x1dac4f['push'](_0x1dac4f['shift']());}catch(_0x2d7833){_0x1dac4f['push'](_0x1dac4f['shift']());}}}(a15_0x5492,0xdcf50));var __createBinding=this&&this[a15_0x25e28a(0x128)]||(Object['create']?function(_0x13e208,_0x315ba2,_0x209995,_0x188336){const _0x5d64e3=a15_0x25e28a;if(_0x188336===undefined)_0x188336=_0x209995;var _0x243b32=Object[_0x5d64e3(0x168)](_0x315ba2,_0x209995);(!_0x243b32||(_0x5d64e3(0x117)in _0x243b32?!_0x315ba2[_0x5d64e3(0x15c)]:_0x243b32[_0x5d64e3(0x175)]||_0x243b32[_0x5d64e3(0x109)]))&&(_0x243b32={'enumerable':!![],'get':function(){return _0x315ba2[_0x209995];}}),Object[_0x5d64e3(0x140)](_0x13e208,_0x188336,_0x243b32);}:function(_0x3dc089,_0x16843b,_0x5b9692,_0x25fc08){if(_0x25fc08===undefined)_0x25fc08=_0x5b9692;_0x3dc089[_0x25fc08]=_0x16843b[_0x5b9692];}),__setModuleDefault=this&&this[a15_0x25e28a(0x15d)]||(Object[a15_0x25e28a(0x143)]?function(_0x454501,_0xfea22e){const _0x565583=a15_0x25e28a;Object[_0x565583(0x140)](_0x454501,'default',{'enumerable':!![],'value':_0xfea22e});}:function(_0x5a899a,_0xb7c49d){const _0x449873=a15_0x25e28a;_0x5a899a[_0x449873(0x135)]=_0xb7c49d;}),__importStar=this&&this[a15_0x25e28a(0x111)]||(function(){var _0x35a7ad=function(_0x27c754){return _0x35a7ad=Object['getOwnPropertyNames']||function(_0x3eb1bd){const _0x250716=a15_0x1fdc;var _0x38468a=[];for(var _0xb7869e in _0x3eb1bd)if(Object[_0x250716(0x16f)]['hasOwnProperty']['call'](_0x3eb1bd,_0xb7869e))_0x38468a[_0x38468a['length']]=_0xb7869e;return _0x38468a;},_0x35a7ad(_0x27c754);};return function(_0x2f6999){const _0x30abf9=a15_0x1fdc;if(_0x2f6999&&_0x2f6999[_0x30abf9(0x15c)])return _0x2f6999;var _0x154415={};if(_0x2f6999!=null){for(var _0x120f71=_0x35a7ad(_0x2f6999),_0x20fff3=0x0;_0x20fff3<_0x120f71[_0x30abf9(0x107)];_0x20fff3++)if(_0x120f71[_0x20fff3]!==_0x30abf9(0x135))__createBinding(_0x154415,_0x2f6999,_0x120f71[_0x20fff3]);}return __setModuleDefault(_0x154415,_0x2f6999),_0x154415;};}()),__importDefault=this&&this[a15_0x25e28a(0x13e)]||function(_0x5e1e28){const _0x180d55=a15_0x25e28a;return _0x5e1e28&&_0x5e1e28[_0x180d55(0x15c)]?_0x5e1e28:{'default':_0x5e1e28};};Object[a15_0x25e28a(0x140)](exports,a15_0x25e28a(0x15c),{'value':!![]}),exports[a15_0x25e28a(0x132)]=void 0x0;function a15_0x5492(){const _0x5cbef2=['transactionId','sendPaymentNotification','Payment\x20to\x20','sendShopWebhook','replace','✅\x20Payment\x20link\x20','📈\x20Test\x20Gateway:\x20Payment\x20','23148udeuBi','__createBinding','status','SINGLE','customerName','\x20->\x20','gatewayOrderId','error','COMPLETED','Webhook\x20event\x20','\x20not\x20found','TestGatewayController','paid','slice','default','includes','0000','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','name','webhookService','PAID','toISOString','TestGatewayService','__importDefault','168YVcRYe','defineProperty','sendPaymentStatusNotification','14058320NwICro','create','❌\x20Payment\x20link\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../services/webhookService','Payment\x20failed','paymentMethod','Payment\x20is\x20not\x20for\x20test\x20gateway','Any\x20name','Any\x20other\x20card\x20number','testGatewayService','Payment\x20System/1.0\x20(Test\x20Gateway)','resolve',':\x20type=','log','cardLast4','29676eCevDn','Payment\x20processed\x20successfully','currency','settings','params','gateway','webhookUrl','gatewayPaymentId',',\x20cannot\x20process','Any\x203-4\x20digits','__esModule','__setModuleDefault','successUrl','processCard','body','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','90seAYgi','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','application/json','625880xAkYyZ','../config/database','POST','getOwnPropertyDescriptor','paymentLinkId','Payment\x20not\x20found','createdAt','Payment\x20status\x20is\x20','🧪\x20Test\x20Gateway\x20result:','test_gateway_','prototype','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','parse','13568060uHbCHb','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paidAt','writable','../services/telegramBotService','failUrl','\x20not\x20enabled\x20for\x20shop\x20','10kOKuIr','failed','1872968PdeGSH','update','failureReason',',\x20status=','isArray','\x20processed:\x20','18xtqtZa','length','toLowerCase','configurable','payment','cardNumber','test_gateway','shop','FAILED','currentPayments','now','__importStar','findUnique','paymentLink','payment.success','type','test_card','get','amount','shopId','json','PENDING','webhookEvents','690682DQfCNE',',\x20currentPayments=','../services/gateways/testGatewayService'];a15_0x5492=function(){return _0x5cbef2;};return a15_0x5492();}const testGatewayService_1=require(a15_0x25e28a(0x11f)),webhookService_1=require(a15_0x25e28a(0x146)),database_1=__importDefault(require(a15_0x25e28a(0x166)));class TestGatewayController{constructor(){const _0x583541=a15_0x25e28a;this['getPaymentForm']=async(_0x41f23f,_0x4c3413,_0x215a6d)=>{const _0x18c5fe=a15_0x1fdc;try{const {paymentId:_0x10082a}=_0x41f23f[_0x18c5fe(0x156)];console[_0x18c5fe(0x150)](_0x18c5fe(0x163)+_0x10082a);const _0x46987a=await database_1[_0x18c5fe(0x135)][_0x18c5fe(0x10a)][_0x18c5fe(0x112)]({'where':{'id':_0x10082a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x46987a)return _0x4c3413[_0x18c5fe(0x129)](0x194)[_0x18c5fe(0x11a)]({'success':![],'message':_0x18c5fe(0x16a)});if(_0x46987a[_0x18c5fe(0x157)]!=='test_gateway')return _0x4c3413['status'](0x190)[_0x18c5fe(0x11a)]({'success':![],'message':_0x18c5fe(0x149)});if(_0x46987a['status']!==_0x18c5fe(0x11b))return _0x4c3413[_0x18c5fe(0x129)](0x190)[_0x18c5fe(0x11a)]({'success':![],'message':_0x18c5fe(0x16c)+_0x46987a[_0x18c5fe(0x129)]+_0x18c5fe(0x15a)});_0x4c3413[_0x18c5fe(0x11a)]({'success':!![],'result':{'paymentId':_0x46987a['id'],'orderId':_0x46987a[_0x18c5fe(0x12d)],'amount':_0x46987a[_0x18c5fe(0x118)],'currency':_0x46987a[_0x18c5fe(0x154)],'merchantName':_0x46987a[_0x18c5fe(0x10d)][_0x18c5fe(0x139)],'description':_0x18c5fe(0x122)+_0x46987a['shop']['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x18c5fe(0x14b),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x18c5fe(0x15b),'holderName':_0x18c5fe(0x14a)}}});}catch(_0x40078d){_0x215a6d(_0x40078d);}},this[_0x583541(0x15f)]=async(_0x184738,_0x2703f9,_0x2fd440)=>{const _0x5bfe22=_0x583541;try{const {paymentId:_0x4d1fc2}=_0x184738['params'],_0x1d1d4d=_0x184738[_0x5bfe22(0x160)];console['log'](_0x5bfe22(0x161)+_0x4d1fc2);const _0x350e57=await database_1[_0x5bfe22(0x135)]['payment'][_0x5bfe22(0x112)]({'where':{'id':_0x4d1fc2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x350e57)return _0x2703f9[_0x5bfe22(0x129)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x350e57[_0x5bfe22(0x157)]!==_0x5bfe22(0x10c))return _0x2703f9[_0x5bfe22(0x129)](0x190)['json']({'success':![],'message':_0x5bfe22(0x149)});if(_0x350e57['status']!==_0x5bfe22(0x11b))return _0x2703f9[_0x5bfe22(0x129)](0x190)['json']({'success':![],'message':_0x5bfe22(0x16c)+_0x350e57[_0x5bfe22(0x129)]+_0x5bfe22(0x15a)});const _0x512ad0=await this[_0x5bfe22(0x14c)]['processCardPayment']({'paymentId':_0x350e57['id'],'orderId':_0x350e57['gatewayOrderId']||_0x350e57['id'],'amount':_0x350e57[_0x5bfe22(0x118)],'currency':_0x350e57[_0x5bfe22(0x154)],'cardData':_0x1d1d4d});console[_0x5bfe22(0x150)](_0x5bfe22(0x16d),_0x512ad0);const _0x59efa3={'status':_0x512ad0[_0x5bfe22(0x129)],'updatedAt':new Date()};if(_0x512ad0['status']==='PAID')_0x59efa3[_0x5bfe22(0x174)]=new Date(),_0x59efa3[_0x5bfe22(0x159)]=_0x512ad0['transactionId'];else _0x512ad0[_0x5bfe22(0x129)]===_0x5bfe22(0x10e)&&(_0x59efa3['failureMessage']=_0x512ad0['failureReason']);const _0x5ea22b=_0x1d1d4d[_0x5bfe22(0x10b)][_0x5bfe22(0x124)](/[\s-]/g,'');_0x59efa3[_0x5bfe22(0x151)]=_0x5ea22b[_0x5bfe22(0x134)](-0x4),_0x59efa3[_0x5bfe22(0x148)]=_0x5bfe22(0x116),await database_1[_0x5bfe22(0x135)][_0x5bfe22(0x10a)][_0x5bfe22(0x101)]({'where':{'id':_0x350e57['id']},'data':_0x59efa3});if(_0x512ad0['status']===_0x5bfe22(0x13b)&&_0x350e57['paymentLinkId']){console[_0x5bfe22(0x150)](_0x5bfe22(0x126)+_0x350e57['id']+_0x5bfe22(0x138));try{await database_1[_0x5bfe22(0x135)]['$transaction'](async _0x83b38d=>{const _0x4af656=_0x5bfe22,_0x335861=await _0x83b38d[_0x4af656(0x113)][_0x4af656(0x112)]({'where':{'id':_0x350e57[_0x4af656(0x169)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x335861){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x335861['id']+_0x4af656(0x14f)+_0x335861['type']+_0x4af656(0x11e)+_0x335861[_0x4af656(0x10f)]+_0x4af656(0x103)+_0x335861[_0x4af656(0x129)]);const _0x3386dc=_0x335861[_0x4af656(0x10f)]+0x1,_0x475d5f=_0x335861[_0x4af656(0x115)]===_0x4af656(0x12a)?_0x4af656(0x12f):_0x335861['status'];await _0x83b38d[_0x4af656(0x113)][_0x4af656(0x101)]({'where':{'id':_0x350e57['paymentLinkId']},'data':{'currentPayments':_0x3386dc,'status':_0x475d5f,'updatedAt':new Date()}}),console[_0x4af656(0x150)](_0x4af656(0x125)+_0x335861['id']+'\x20updated:\x20currentPayments='+_0x335861[_0x4af656(0x10f)]+'\x20->\x20'+_0x3386dc+',\x20status='+_0x335861[_0x4af656(0x129)]+_0x4af656(0x12c)+_0x475d5f);}else console['log'](_0x4af656(0x144)+_0x350e57[_0x4af656(0x169)]+_0x4af656(0x131));});}catch(_0x37a344){console['error'](_0x5bfe22(0x170),_0x37a344);}}await database_1['default']['webhookLog'][_0x5bfe22(0x143)]({'data':{'paymentId':_0x350e57['id'],'shopId':_0x350e57[_0x5bfe22(0x119)],'event':_0x5bfe22(0x16e)+_0x512ad0[_0x5bfe22(0x129)][_0x5bfe22(0x108)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5bfe22(0x11b),'newStatus':_0x512ad0[_0x5bfe22(0x129)],'transactionId':_0x512ad0[_0x5bfe22(0x120)],'failureReason':_0x512ad0[_0x5bfe22(0x102)],'processedAt':new Date()[_0x5bfe22(0x13c)]()})}}),await this[_0x5bfe22(0x123)](_0x350e57,_0x512ad0[_0x5bfe22(0x129)],_0x512ad0['transactionId'],_0x512ad0[_0x5bfe22(0x102)]),await this['sendPaymentStatusNotification'](_0x350e57,_0x512ad0[_0x5bfe22(0x129)]),console[_0x5bfe22(0x150)]('✅\x20Test\x20Gateway\x20payment\x20'+_0x4d1fc2+_0x5bfe22(0x105)+_0x512ad0[_0x5bfe22(0x129)]),_0x512ad0[_0x5bfe22(0x129)]==='PAID'?_0x2703f9[_0x5bfe22(0x11a)]({'success':!![],'message':_0x5bfe22(0x153),'result':{'status':_0x5bfe22(0x13b),'transactionId':_0x512ad0['transactionId'],'redirectUrl':_0x350e57[_0x5bfe22(0x15e)]}}):_0x2703f9['status'](0x190)[_0x5bfe22(0x11a)]({'success':![],'message':_0x5bfe22(0x147),'result':{'status':_0x5bfe22(0x10e),'failureReason':_0x512ad0[_0x5bfe22(0x102)],'redirectUrl':_0x350e57[_0x5bfe22(0xfc)]}});}catch(_0x13fae3){_0x2fd440(_0x13fae3);}},this['testGatewayService']=new testGatewayService_1[(_0x583541(0x13d))](),this[_0x583541(0x13a)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x21a0e3,_0x1c92e1,_0xab41ed,_0x6791a6){const _0x5e596=a15_0x25e28a,_0x329bff=Date[_0x5e596(0x110)]();try{const _0x12d4cb=_0x21a0e3[_0x5e596(0x10d)],_0x14bdda=_0x12d4cb[_0x5e596(0x155)];if(!_0x14bdda?.[_0x5e596(0x158)]){console[_0x5e596(0x150)](_0x5e596(0x173)+_0x12d4cb['id']);return;}const _0x5ddd4f=_0x1c92e1==='PAID'?_0x5e596(0x114):'payment.failed';let _0x298d11=[];if(_0x14bdda[_0x5e596(0x11c)])try{_0x298d11=Array[_0x5e596(0x104)](_0x14bdda[_0x5e596(0x11c)])?_0x14bdda[_0x5e596(0x11c)]:JSON[_0x5e596(0x171)](_0x14bdda[_0x5e596(0x11c)]);}catch(_0x3b60af){console[_0x5e596(0x12e)]('Error\x20parsing\x20webhook\x20events:',_0x3b60af),_0x298d11=[];}if(!_0x298d11[_0x5e596(0x136)](_0x5ddd4f)){console[_0x5e596(0x150)](_0x5e596(0x130)+_0x5ddd4f+_0x5e596(0xfd)+_0x12d4cb['id']);return;}const _0x23e52e={'event':_0x5ddd4f,'payment':{'id':_0x21a0e3['id'],'order_id':_0x21a0e3['orderId'],'gateway_order_id':_0x21a0e3['gatewayOrderId'],'gateway':_0x5e596(0x137),'amount':_0x21a0e3[_0x5e596(0x118)],'currency':_0x21a0e3[_0x5e596(0x154)],'status':_0x1c92e1['toLowerCase'](),'customer_email':_0x21a0e3['customerEmail'],'customer_name':_0x21a0e3[_0x5e596(0x12b)],'transaction_id':_0xab41ed,'failure_message':_0x6791a6,'created_at':_0x21a0e3[_0x5e596(0x16b)],'updated_at':new Date()}},_0x312c77=await fetch(_0x14bdda[_0x5e596(0x158)],{'method':_0x5e596(0x167),'headers':{'Content-Type':_0x5e596(0x164),'User-Agent':_0x5e596(0x14d)},'body':JSON['stringify'](_0x23e52e)}),_0x3d098f=Date[_0x5e596(0x110)]()-_0x329bff;console[_0x5e596(0x150)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x14bdda[_0x5e596(0x158)]+'\x20with\x20status\x20'+_0x312c77[_0x5e596(0x129)]+'\x20('+_0x3d098f+'ms)');}catch(_0x38a812){console['error'](_0x5e596(0x145),_0x38a812);}}async[a15_0x25e28a(0x141)](_0x4742f9,_0x574321){const _0x2c6aed=a15_0x25e28a;try{const {telegramBotService:_0x45b8c4}=await Promise[_0x2c6aed(0x14e)]()['then'](()=>__importStar(require(_0x2c6aed(0x176)))),_0x2ca7fc={'PAID':_0x2c6aed(0x133),'FAILED':_0x2c6aed(0xff)},_0x32e40c=_0x2ca7fc[_0x574321];if(!_0x32e40c)return;await _0x45b8c4[_0x2c6aed(0x121)](_0x4742f9[_0x2c6aed(0x119)],_0x4742f9,_0x32e40c);}catch(_0x4d3e7e){console[_0x2c6aed(0x12e)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4d3e7e);}}}function a15_0x1fdc(_0x5d30cf,_0x5d53d2){const _0x5492d6=a15_0x5492();return a15_0x1fdc=function(_0x1fdcec,_0x34a092){_0x1fdcec=_0x1fdcec-0xfc;let _0x2134b0=_0x5492d6[_0x1fdcec];return _0x2134b0;},a15_0x1fdc(_0x5d30cf,_0x5d53d2);}exports[a15_0x25e28a(0x132)]=TestGatewayController;