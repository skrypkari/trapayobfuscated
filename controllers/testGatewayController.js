'use strict';function a13_0x39c2(_0x58f100,_0x4e123a){const _0xc7c3dc=a13_0xc7c3();return a13_0x39c2=function(_0x39c2dd,_0x14dd51){_0x39c2dd=_0x39c2dd-0x17d;let _0x491618=_0xc7c3dc[_0x39c2dd];return _0x491618;},a13_0x39c2(_0x58f100,_0x4e123a);}const a13_0x506d3d=a13_0x39c2;(function(_0x5f47a7,_0x127886){const _0x3409c8=a13_0x39c2,_0x2070c0=_0x5f47a7();while(!![]){try{const _0x5da4fe=parseInt(_0x3409c8(0x194))/0x1+parseInt(_0x3409c8(0x183))/0x2*(-parseInt(_0x3409c8(0x1f2))/0x3)+-parseInt(_0x3409c8(0x1a2))/0x4*(-parseInt(_0x3409c8(0x1ed))/0x5)+parseInt(_0x3409c8(0x1e3))/0x6+-parseInt(_0x3409c8(0x184))/0x7+parseInt(_0x3409c8(0x1c9))/0x8+-parseInt(_0x3409c8(0x1e0))/0x9;if(_0x5da4fe===_0x127886)break;else _0x2070c0['push'](_0x2070c0['shift']());}catch(_0x244379){_0x2070c0['push'](_0x2070c0['shift']());}}}(a13_0xc7c3,0x7cf3a));function a13_0xc7c3(){const _0xc7321c=['__importStar',',\x20cannot\x20process','__setModuleDefault','toLowerCase','\x20not\x20enabled\x20for\x20shop\x20','includes','body','Payment\x20to\x20','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importDefault','sendPaymentNotification','📈\x20Test\x20Gateway:\x20Payment\x20','application/json',',\x20currentPayments=','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','paymentLinkId','test_gateway','✅\x20Test\x20Gateway\x20payment\x20','PENDING','Any\x20future\x20date\x20(MM/YY)','call','webhookLog','✅\x20Payment\x20link\x20','isArray','customerName','POST','webhookUrl','params','status','error','processCardPayment','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','processCard','$transaction','test_gateway_','Payment\x20processed\x20successfully','6223720dTQMpF','❌\x20Payment\x20link\x20','writable','sendShopWebhook','now','Error\x20parsing\x20webhook\x20events:','Test\x20Gateway\x20webhook\x20sent\x20to\x20','configurable','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20->\x20','\x20with\x20status\x20','FAILED','create','../services/webhookService','failureReason','4242\x204242\x204242\x204242',':\x20type=','gatewayOrderId','testGatewayService','payment.failed','log','Any\x20name','Any\x20other\x20card\x20number','12812229TOVscR','then','../services/telegramBotService','5247594daqJAO','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','getPaymentForm','webhookEvents','cardNumber','PAID','Payment\x20not\x20found','shopId','findUnique','stringify','15xisgZU',',\x20status=','defineProperty','__esModule','failed','1081221ohXDRr','parse','orderId','get','../config/database','customerEmail','currentPayments','transactionId','cardLast4','gateway','name','length','test_card','2AgeAre','4398016kgGvMB','0000','\x20updated:\x20currentPayments=','settings','TestGatewayController','currency','paymentLink','webhookService','shop','Payment\x20is\x20not\x20for\x20test\x20gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment','__createBinding','failureMessage','Payment\x20failed','gatewayPaymentId','519096RrGmbf','getOwnPropertyNames','default','payment.success','prototype','getOwnPropertyDescriptor','sendPaymentStatusNotification','Payment\x20status\x20is\x20','amount','successUrl','Any\x203-4\x20digits','json','createdAt','\x20processed:\x20','1003224EkxDPb','WebhookService','update'];a13_0xc7c3=function(){return _0xc7321c;};return a13_0xc7c3();}var __createBinding=this&&this[a13_0x506d3d(0x190)]||(Object[a13_0x506d3d(0x1d5)]?function(_0x2529d3,_0x3467a3,_0x4dc81c,_0x234c68){const _0x1fba92=a13_0x506d3d;if(_0x234c68===undefined)_0x234c68=_0x4dc81c;var _0x64ae2e=Object[_0x1fba92(0x199)](_0x3467a3,_0x4dc81c);(!_0x64ae2e||(_0x1fba92(0x1f5)in _0x64ae2e?!_0x3467a3[_0x1fba92(0x1f0)]:_0x64ae2e[_0x1fba92(0x1cb)]||_0x64ae2e[_0x1fba92(0x1d0)]))&&(_0x64ae2e={'enumerable':!![],'get':function(){return _0x3467a3[_0x4dc81c];}}),Object[_0x1fba92(0x1ef)](_0x2529d3,_0x234c68,_0x64ae2e);}:function(_0x5c16a1,_0x1a314d,_0x5e8cad,_0x91d5d){if(_0x91d5d===undefined)_0x91d5d=_0x5e8cad;_0x5c16a1[_0x91d5d]=_0x1a314d[_0x5e8cad];}),__setModuleDefault=this&&this[a13_0x506d3d(0x1a7)]||(Object[a13_0x506d3d(0x1d5)]?function(_0x14440d,_0x25c63d){const _0xb8e68f=a13_0x506d3d;Object[_0xb8e68f(0x1ef)](_0x14440d,_0xb8e68f(0x196),{'enumerable':!![],'value':_0x25c63d});}:function(_0x46ce23,_0x3cb51a){const _0x489c07=a13_0x506d3d;_0x46ce23[_0x489c07(0x196)]=_0x3cb51a;}),__importStar=this&&this[a13_0x506d3d(0x1a5)]||(function(){var _0x7f6801=function(_0x745a5e){const _0x281aba=a13_0x39c2;return _0x7f6801=Object[_0x281aba(0x195)]||function(_0x5c0bf4){const _0x423409=_0x281aba;var _0x54dc3e=[];for(var _0x1d2e34 in _0x5c0bf4)if(Object[_0x423409(0x198)]['hasOwnProperty'][_0x423409(0x1b9)](_0x5c0bf4,_0x1d2e34))_0x54dc3e[_0x54dc3e[_0x423409(0x181)]]=_0x1d2e34;return _0x54dc3e;},_0x7f6801(_0x745a5e);};return function(_0x1c88e0){const _0x5863ec=a13_0x39c2;if(_0x1c88e0&&_0x1c88e0['__esModule'])return _0x1c88e0;var _0x2c4325={};if(_0x1c88e0!=null){for(var _0x4f0c9c=_0x7f6801(_0x1c88e0),_0x55d442=0x0;_0x55d442<_0x4f0c9c['length'];_0x55d442++)if(_0x4f0c9c[_0x55d442]!==_0x5863ec(0x196))__createBinding(_0x2c4325,_0x1c88e0,_0x4f0c9c[_0x55d442]);}return __setModuleDefault(_0x2c4325,_0x1c88e0),_0x2c4325;};}()),__importDefault=this&&this[a13_0x506d3d(0x1ae)]||function(_0x451e41){const _0x17c10e=a13_0x506d3d;return _0x451e41&&_0x451e41[_0x17c10e(0x1f0)]?_0x451e41:{'default':_0x451e41};};Object[a13_0x506d3d(0x1ef)](exports,a13_0x506d3d(0x1f0),{'value':!![]}),exports[a13_0x506d3d(0x188)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x506d3d(0x1d6)),database_1=__importDefault(require(a13_0x506d3d(0x1f6)));class TestGatewayController{constructor(){const _0x960b7f=a13_0x506d3d;this[_0x960b7f(0x1e5)]=async(_0x54559e,_0x46e127,_0x1312a8)=>{const _0x4e14f7=_0x960b7f;try{const {paymentId:_0x466f58}=_0x54559e[_0x4e14f7(0x1c0)];console[_0x4e14f7(0x1dd)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x466f58);const _0x8ba35c=await database_1[_0x4e14f7(0x196)]['payment']['findUnique']({'where':{'id':_0x466f58},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x8ba35c)return _0x46e127[_0x4e14f7(0x1c1)](0x194)['json']({'success':![],'message':_0x4e14f7(0x1e9)});if(_0x8ba35c['gateway']!==_0x4e14f7(0x1b5))return _0x46e127[_0x4e14f7(0x1c1)](0x190)[_0x4e14f7(0x19f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x8ba35c['status']!==_0x4e14f7(0x1b7))return _0x46e127['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x8ba35c[_0x4e14f7(0x1c1)]+_0x4e14f7(0x1a6)});_0x46e127['json']({'success':!![],'result':{'paymentId':_0x8ba35c['id'],'orderId':_0x8ba35c['gatewayOrderId'],'amount':_0x8ba35c[_0x4e14f7(0x19c)],'currency':_0x8ba35c[_0x4e14f7(0x189)],'merchantName':_0x8ba35c['shop'][_0x4e14f7(0x180)],'description':_0x4e14f7(0x1ac)+_0x8ba35c[_0x4e14f7(0x18c)][_0x4e14f7(0x180)],'testInstructions':{'successCard':_0x4e14f7(0x1d8),'failureCard':_0x4e14f7(0x1df),'expiryDate':_0x4e14f7(0x1b8),'cvc':_0x4e14f7(0x19e),'holderName':_0x4e14f7(0x1de)}}});}catch(_0x9ed4f6){_0x1312a8(_0x9ed4f6);}},this[_0x960b7f(0x1c5)]=async(_0x118b71,_0x4d7d02,_0x29f875)=>{const _0x5471e3=_0x960b7f;try{const {paymentId:_0x1c3ddf}=_0x118b71[_0x5471e3(0x1c0)],_0x4ba924=_0x118b71[_0x5471e3(0x1ab)];console[_0x5471e3(0x1dd)](_0x5471e3(0x1ad)+_0x1c3ddf);const _0x10e2b6=await database_1[_0x5471e3(0x196)][_0x5471e3(0x18f)][_0x5471e3(0x1eb)]({'where':{'id':_0x1c3ddf},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x10e2b6)return _0x4d7d02[_0x5471e3(0x1c1)](0x194)[_0x5471e3(0x19f)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x10e2b6[_0x5471e3(0x17f)]!==_0x5471e3(0x1b5))return _0x4d7d02[_0x5471e3(0x1c1)](0x190)[_0x5471e3(0x19f)]({'success':![],'message':_0x5471e3(0x18d)});if(_0x10e2b6[_0x5471e3(0x1c1)]!=='PENDING')return _0x4d7d02[_0x5471e3(0x1c1)](0x190)[_0x5471e3(0x19f)]({'success':![],'message':_0x5471e3(0x19b)+_0x10e2b6[_0x5471e3(0x1c1)]+',\x20cannot\x20process'});const _0x14cd9a=await this[_0x5471e3(0x1db)][_0x5471e3(0x1c3)]({'paymentId':_0x10e2b6['id'],'orderId':_0x10e2b6[_0x5471e3(0x1da)]||_0x10e2b6['id'],'amount':_0x10e2b6[_0x5471e3(0x19c)],'currency':_0x10e2b6[_0x5471e3(0x189)],'cardData':_0x4ba924});console[_0x5471e3(0x1dd)]('🧪\x20Test\x20Gateway\x20result:',_0x14cd9a);const _0x3a299b={'status':_0x14cd9a[_0x5471e3(0x1c1)],'updatedAt':new Date()};if(_0x14cd9a['status']==='PAID')_0x3a299b['paidAt']=new Date(),_0x3a299b[_0x5471e3(0x193)]=_0x14cd9a[_0x5471e3(0x17d)];else _0x14cd9a[_0x5471e3(0x1c1)]===_0x5471e3(0x1d4)&&(_0x3a299b[_0x5471e3(0x191)]=_0x14cd9a['failureReason']);const _0x15a895=_0x4ba924[_0x5471e3(0x1e7)]['replace'](/[\s-]/g,'');_0x3a299b[_0x5471e3(0x17e)]=_0x15a895['slice'](-0x4),_0x3a299b['paymentMethod']=_0x5471e3(0x182),await database_1['default'][_0x5471e3(0x18f)][_0x5471e3(0x1a4)]({'where':{'id':_0x10e2b6['id']},'data':_0x3a299b});if(_0x14cd9a[_0x5471e3(0x1c1)]===_0x5471e3(0x1e8)&&_0x10e2b6[_0x5471e3(0x1b4)]){console[_0x5471e3(0x1dd)](_0x5471e3(0x1b0)+_0x10e2b6['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x5471e3(0x196)][_0x5471e3(0x1c6)](async _0x2adb97=>{const _0x19a2ab=_0x5471e3,_0x5d56f4=await _0x2adb97[_0x19a2ab(0x18a)][_0x19a2ab(0x1eb)]({'where':{'id':_0x10e2b6[_0x19a2ab(0x1b4)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5d56f4){console[_0x19a2ab(0x1dd)]('📈\x20Found\x20payment\x20link\x20'+_0x5d56f4['id']+_0x19a2ab(0x1d9)+_0x5d56f4['type']+_0x19a2ab(0x1b2)+_0x5d56f4[_0x19a2ab(0x1f8)]+_0x19a2ab(0x1ee)+_0x5d56f4[_0x19a2ab(0x1c1)]);const _0x2bb1e8=_0x5d56f4[_0x19a2ab(0x1f8)]+0x1,_0x3fea2a=_0x5d56f4['type']==='SINGLE'?'COMPLETED':_0x5d56f4['status'];await _0x2adb97[_0x19a2ab(0x18a)][_0x19a2ab(0x1a4)]({'where':{'id':_0x10e2b6[_0x19a2ab(0x1b4)]},'data':{'currentPayments':_0x2bb1e8,'status':_0x3fea2a,'updatedAt':new Date()}}),console[_0x19a2ab(0x1dd)](_0x19a2ab(0x1bb)+_0x5d56f4['id']+_0x19a2ab(0x186)+_0x5d56f4[_0x19a2ab(0x1f8)]+_0x19a2ab(0x1d2)+_0x2bb1e8+_0x19a2ab(0x1ee)+_0x5d56f4[_0x19a2ab(0x1c1)]+_0x19a2ab(0x1d2)+_0x3fea2a);}else console[_0x19a2ab(0x1dd)](_0x19a2ab(0x1ca)+_0x10e2b6['paymentLinkId']+'\x20not\x20found');});}catch(_0x584446){console[_0x5471e3(0x1c2)](_0x5471e3(0x1c4),_0x584446);}}await database_1[_0x5471e3(0x196)][_0x5471e3(0x1ba)][_0x5471e3(0x1d5)]({'data':{'paymentId':_0x10e2b6['id'],'shopId':_0x10e2b6['shopId'],'event':_0x5471e3(0x1c7)+_0x14cd9a[_0x5471e3(0x1c1)][_0x5471e3(0x1a8)](),'statusCode':0xc8,'responseBody':JSON[_0x5471e3(0x1ec)]({'oldStatus':_0x5471e3(0x1b7),'newStatus':_0x14cd9a['status'],'transactionId':_0x14cd9a['transactionId'],'failureReason':_0x14cd9a[_0x5471e3(0x1d7)],'processedAt':new Date()['toISOString']()})}}),await this[_0x5471e3(0x1cc)](_0x10e2b6,_0x14cd9a[_0x5471e3(0x1c1)],_0x14cd9a[_0x5471e3(0x17d)],_0x14cd9a['failureReason']),await this[_0x5471e3(0x19a)](_0x10e2b6,_0x14cd9a['status']),console[_0x5471e3(0x1dd)](_0x5471e3(0x1b6)+_0x1c3ddf+_0x5471e3(0x1a1)+_0x14cd9a[_0x5471e3(0x1c1)]),_0x14cd9a[_0x5471e3(0x1c1)]===_0x5471e3(0x1e8)?_0x4d7d02[_0x5471e3(0x19f)]({'success':!![],'message':_0x5471e3(0x1c8),'result':{'status':_0x5471e3(0x1e8),'transactionId':_0x14cd9a['transactionId'],'redirectUrl':_0x10e2b6[_0x5471e3(0x19d)]}}):_0x4d7d02['status'](0x190)[_0x5471e3(0x19f)]({'success':![],'message':_0x5471e3(0x192),'result':{'status':_0x5471e3(0x1d4),'failureReason':_0x14cd9a['failureReason'],'redirectUrl':_0x10e2b6['failUrl']}});}catch(_0x50f3cc){_0x29f875(_0x50f3cc);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x960b7f(0x18b)]=new webhookService_1[(_0x960b7f(0x1a3))]();}async[a13_0x506d3d(0x1cc)](_0x356db1,_0xa6e565,_0x43cecd,_0x425c1d){const _0x4d31b5=a13_0x506d3d,_0x3f68c8=Date['now']();try{const _0x58d56a=_0x356db1[_0x4d31b5(0x18c)],_0x164b0e=_0x58d56a[_0x4d31b5(0x187)];if(!_0x164b0e?.['webhookUrl']){console[_0x4d31b5(0x1dd)](_0x4d31b5(0x18e)+_0x58d56a['id']);return;}const _0x342e9e=_0xa6e565==='PAID'?_0x4d31b5(0x197):_0x4d31b5(0x1dc);let _0x3f4678=[];if(_0x164b0e['webhookEvents'])try{_0x3f4678=Array[_0x4d31b5(0x1bc)](_0x164b0e['webhookEvents'])?_0x164b0e[_0x4d31b5(0x1e6)]:JSON[_0x4d31b5(0x1f3)](_0x164b0e[_0x4d31b5(0x1e6)]);}catch(_0x470712){console[_0x4d31b5(0x1c2)](_0x4d31b5(0x1ce),_0x470712),_0x3f4678=[];}if(!_0x3f4678[_0x4d31b5(0x1aa)](_0x342e9e)){console['log']('Webhook\x20event\x20'+_0x342e9e+_0x4d31b5(0x1a9)+_0x58d56a['id']);return;}const _0xb7adfb={'event':_0x342e9e,'payment':{'id':_0x356db1['id'],'order_id':_0x356db1[_0x4d31b5(0x1f4)],'gateway_order_id':_0x356db1['gatewayOrderId'],'gateway':_0x4d31b5(0x185),'amount':_0x356db1[_0x4d31b5(0x19c)],'currency':_0x356db1[_0x4d31b5(0x189)],'status':_0xa6e565['toLowerCase'](),'customer_email':_0x356db1[_0x4d31b5(0x1f7)],'customer_name':_0x356db1[_0x4d31b5(0x1bd)],'transaction_id':_0x43cecd,'failure_message':_0x425c1d,'created_at':_0x356db1[_0x4d31b5(0x1a0)],'updated_at':new Date()}},_0x583e14=await fetch(_0x164b0e['webhookUrl'],{'method':_0x4d31b5(0x1be),'headers':{'Content-Type':_0x4d31b5(0x1b1),'User-Agent':_0x4d31b5(0x1e4)},'body':JSON[_0x4d31b5(0x1ec)](_0xb7adfb)}),_0x2a42c5=Date[_0x4d31b5(0x1cd)]()-_0x3f68c8;console['log'](_0x4d31b5(0x1cf)+_0x164b0e[_0x4d31b5(0x1bf)]+_0x4d31b5(0x1d3)+_0x583e14[_0x4d31b5(0x1c1)]+'\x20('+_0x2a42c5+'ms)');}catch(_0x410bdc){console[_0x4d31b5(0x1c2)](_0x4d31b5(0x1b3),_0x410bdc);}}async[a13_0x506d3d(0x19a)](_0x2675f6,_0x288ad2){const _0x6d8b3b=a13_0x506d3d;try{const {telegramBotService:_0x56175d}=await Promise['resolve']()[_0x6d8b3b(0x1e1)](()=>__importStar(require(_0x6d8b3b(0x1e2)))),_0x2c61c9={'PAID':'paid','FAILED':_0x6d8b3b(0x1f1)},_0x17eade=_0x2c61c9[_0x288ad2];if(!_0x17eade)return;await _0x56175d[_0x6d8b3b(0x1af)](_0x2675f6[_0x6d8b3b(0x1ea)],_0x2675f6,_0x17eade);}catch(_0x9d5178){console[_0x6d8b3b(0x1c2)](_0x6d8b3b(0x1d1),_0x9d5178);}}}exports[a13_0x506d3d(0x188)]=TestGatewayController;