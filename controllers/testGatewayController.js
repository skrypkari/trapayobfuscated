'use strict';function a13_0x7343(){const _0x44a453=['shopId','currency','createdAt','\x20->\x20','../services/gateways/testGatewayService','customerName','getPaymentForm','payment.success','5711652lZKOQE','type','25262755dTUgPg','gatewayPaymentId','üìà\x20Found\x20payment\x20link\x20','isArray','webhookUrl','SINGLE','then','test_gateway_','defineProperty','successUrl','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20not\x20found','FAILED','sendPaymentNotification','hasOwnProperty','body','webhookLog','configurable','customerEmail','processCardPayment','error','transactionId','Payment\x20is\x20not\x20for\x20test\x20gateway','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','getOwnPropertyDescriptor','stringify','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','update','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20to\x20','status','params','__importStar','sendPaymentStatusNotification','cardLast4','findUnique','test_gateway','resolve','Payment\x20status\x20is\x20','writable','üìà\x20Test\x20Gateway:\x20Payment\x20','create','paymentMethod','getOwnPropertyNames','processCard','toISOString','Any\x20name','\x20updated:\x20currentPayments=','paidAt','replace','settings','now','$transaction','391417DyqzcG','failureMessage','testGatewayService','payment','../config/database','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLinkId','log','shop','Any\x20future\x20date\x20(MM/YY)','Any\x203-4\x20digits','orderId','__createBinding','../services/telegramBotService','amount','Payment\x20not\x20found','prototype',',\x20currentPayments=','COMPLETED','WebhookService','PENDING',',\x20status=',':\x20type=','851100Cymxfx','webhookEvents','paid','POST','call','parse','failUrl','application/json','sendShopWebhook','871560AUbURJ','gatewayOrderId','paymentLink','\x20not\x20enabled\x20for\x20shop\x20','failureReason','1780760tgzhxa','PAID','__esModule','payment.failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','default','length','cardNumber','webhookService','test_card','‚ùå\x20Payment\x20link\x20','TestGatewayService',',\x20cannot\x20process','toLowerCase','currentPayments','TestGatewayController','json','name','\x20with\x20status\x20','‚úÖ\x20Payment\x20link\x20','get','2190018LQAzJR','üß™\x20Test\x20Gateway\x20result:','ms)'];a13_0x7343=function(){return _0x44a453;};return a13_0x7343();}const a13_0x330a69=a13_0x2f33;function a13_0x2f33(_0x257853,_0xa7b20e){const _0x7343fb=a13_0x7343();return a13_0x2f33=function(_0x2f3366,_0xb04098){_0x2f3366=_0x2f3366-0x10d;let _0x3e33b1=_0x7343fb[_0x2f3366];return _0x3e33b1;},a13_0x2f33(_0x257853,_0xa7b20e);}(function(_0x5d8170,_0x27aa01){const _0x505cce=a13_0x2f33,_0x9e8162=_0x5d8170();while(!![]){try{const _0x3c670d=-parseInt(_0x505cce(0x11b))/0x1+-parseInt(_0x505cce(0x155))/0x2+-parseInt(_0x505cce(0x132))/0x3+-parseInt(_0x505cce(0x140))/0x4+parseInt(_0x505cce(0x13b))/0x5+-parseInt(_0x505cce(0x160))/0x6+parseInt(_0x505cce(0x162))/0x7;if(_0x3c670d===_0x27aa01)break;else _0x9e8162['push'](_0x9e8162['shift']());}catch(_0xfd4e51){_0x9e8162['push'](_0x9e8162['shift']());}}}(a13_0x7343,0x96653));var __createBinding=this&&this[a13_0x330a69(0x127)]||(Object[a13_0x330a69(0x10f)]?function(_0x1499a3,_0x17130c,_0x226cc7,_0x39aa92){const _0x5ce786=a13_0x330a69;if(_0x39aa92===undefined)_0x39aa92=_0x226cc7;var _0x5ed143=Object[_0x5ce786(0x17a)](_0x17130c,_0x226cc7);(!_0x5ed143||(_0x5ce786(0x154)in _0x5ed143?!_0x17130c[_0x5ce786(0x142)]:_0x5ed143[_0x5ce786(0x10d)]||_0x5ed143[_0x5ce786(0x173)]))&&(_0x5ed143={'enumerable':!![],'get':function(){return _0x17130c[_0x226cc7];}}),Object[_0x5ce786(0x16a)](_0x1499a3,_0x39aa92,_0x5ed143);}:function(_0x2ca723,_0x4bd7f0,_0x5dd37c,_0x49cbf1){if(_0x49cbf1===undefined)_0x49cbf1=_0x5dd37c;_0x2ca723[_0x49cbf1]=_0x4bd7f0[_0x5dd37c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x330a69(0x10f)]?function(_0x39677c,_0x199ce1){const _0x180a68=a13_0x330a69;Object[_0x180a68(0x16a)](_0x39677c,_0x180a68(0x145),{'enumerable':!![],'value':_0x199ce1});}:function(_0x3a5c35,_0x138970){_0x3a5c35['default']=_0x138970;}),__importStar=this&&this[a13_0x330a69(0x182)]||(function(){var _0x2aa883=function(_0x3db767){const _0x4ff300=a13_0x2f33;return _0x2aa883=Object[_0x4ff300(0x111)]||function(_0x209264){const _0x332181=_0x4ff300;var _0x148d2a=[];for(var _0x284818 in _0x209264)if(Object[_0x332181(0x12b)][_0x332181(0x170)][_0x332181(0x136)](_0x209264,_0x284818))_0x148d2a[_0x148d2a[_0x332181(0x146)]]=_0x284818;return _0x148d2a;},_0x2aa883(_0x3db767);};return function(_0x33b0b6){const _0x3a3774=a13_0x2f33;if(_0x33b0b6&&_0x33b0b6[_0x3a3774(0x142)])return _0x33b0b6;var _0x1558c6={};if(_0x33b0b6!=null){for(var _0x666120=_0x2aa883(_0x33b0b6),_0x3c502e=0x0;_0x3c502e<_0x666120['length'];_0x3c502e++)if(_0x666120[_0x3c502e]!=='default')__createBinding(_0x1558c6,_0x33b0b6,_0x666120[_0x3c502e]);}return __setModuleDefault(_0x1558c6,_0x33b0b6),_0x1558c6;};}()),__importDefault=this&&this['__importDefault']||function(_0x5e514a){const _0x37a2cf=a13_0x330a69;return _0x5e514a&&_0x5e514a[_0x37a2cf(0x142)]?_0x5e514a:{'default':_0x5e514a};};Object[a13_0x330a69(0x16a)](exports,a13_0x330a69(0x142),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x330a69(0x15c)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x330a69(0x11f)));class TestGatewayController{constructor(){const _0x11af9b=a13_0x330a69;this[_0x11af9b(0x15e)]=async(_0x5ef733,_0x5c50c7,_0x3b037b)=>{const _0x3de1e0=_0x11af9b;try{const {paymentId:_0x402cd4}=_0x5ef733[_0x3de1e0(0x181)];console[_0x3de1e0(0x122)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x402cd4);const _0x4dec85=await database_1['default'][_0x3de1e0(0x11e)]['findUnique']({'where':{'id':_0x402cd4},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4dec85)return _0x5c50c7['status'](0x194)[_0x3de1e0(0x150)]({'success':![],'message':_0x3de1e0(0x12a)});if(_0x4dec85['gateway']!==_0x3de1e0(0x186))return _0x5c50c7[_0x3de1e0(0x180)](0x190)[_0x3de1e0(0x150)]({'success':![],'message':_0x3de1e0(0x178)});if(_0x4dec85['status']!=='PENDING')return _0x5c50c7[_0x3de1e0(0x180)](0x190)[_0x3de1e0(0x150)]({'success':![],'message':_0x3de1e0(0x188)+_0x4dec85[_0x3de1e0(0x180)]+_0x3de1e0(0x14c)});_0x5c50c7[_0x3de1e0(0x150)]({'success':!![],'result':{'paymentId':_0x4dec85['id'],'orderId':_0x4dec85[_0x3de1e0(0x13c)],'amount':_0x4dec85[_0x3de1e0(0x129)],'currency':_0x4dec85[_0x3de1e0(0x159)],'merchantName':_0x4dec85[_0x3de1e0(0x123)][_0x3de1e0(0x151)],'description':_0x3de1e0(0x17f)+_0x4dec85['shop'][_0x3de1e0(0x151)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x3de1e0(0x124),'cvc':_0x3de1e0(0x125),'holderName':_0x3de1e0(0x114)}}});}catch(_0x2d7665){_0x3b037b(_0x2d7665);}},this[_0x11af9b(0x112)]=async(_0x208665,_0x475292,_0x3290f8)=>{const _0x2afcdc=_0x11af9b;try{const {paymentId:_0x384a90}=_0x208665[_0x2afcdc(0x181)],_0x862e81=_0x208665[_0x2afcdc(0x171)];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x384a90);const _0x2ef581=await database_1[_0x2afcdc(0x145)][_0x2afcdc(0x11e)][_0x2afcdc(0x185)]({'where':{'id':_0x384a90},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ef581)return _0x475292[_0x2afcdc(0x180)](0x194)[_0x2afcdc(0x150)]({'success':![],'message':_0x2afcdc(0x12a)});if(_0x2ef581['gateway']!==_0x2afcdc(0x186))return _0x475292['status'](0x190)[_0x2afcdc(0x150)]({'success':![],'message':_0x2afcdc(0x178)});if(_0x2ef581['status']!==_0x2afcdc(0x12f))return _0x475292[_0x2afcdc(0x180)](0x190)[_0x2afcdc(0x150)]({'success':![],'message':_0x2afcdc(0x188)+_0x2ef581[_0x2afcdc(0x180)]+_0x2afcdc(0x14c)});const _0x3c07c6=await this[_0x2afcdc(0x11d)][_0x2afcdc(0x175)]({'paymentId':_0x2ef581['id'],'orderId':_0x2ef581[_0x2afcdc(0x13c)]||_0x2ef581['id'],'amount':_0x2ef581[_0x2afcdc(0x129)],'currency':_0x2ef581[_0x2afcdc(0x159)],'cardData':_0x862e81});console[_0x2afcdc(0x122)](_0x2afcdc(0x156),_0x3c07c6);const _0x61afca={'status':_0x3c07c6[_0x2afcdc(0x180)],'updatedAt':new Date()};if(_0x3c07c6[_0x2afcdc(0x180)]==='PAID')_0x61afca[_0x2afcdc(0x116)]=new Date(),_0x61afca[_0x2afcdc(0x163)]=_0x3c07c6['transactionId'];else _0x3c07c6[_0x2afcdc(0x180)]==='FAILED'&&(_0x61afca[_0x2afcdc(0x11c)]=_0x3c07c6[_0x2afcdc(0x13f)]);const _0x52e070=_0x862e81[_0x2afcdc(0x147)][_0x2afcdc(0x117)](/[\s-]/g,'');_0x61afca[_0x2afcdc(0x184)]=_0x52e070['slice'](-0x4),_0x61afca[_0x2afcdc(0x110)]=_0x2afcdc(0x149),await database_1[_0x2afcdc(0x145)]['payment']['update']({'where':{'id':_0x2ef581['id']},'data':_0x61afca});if(_0x3c07c6['status']===_0x2afcdc(0x141)&&_0x2ef581[_0x2afcdc(0x121)]){console[_0x2afcdc(0x122)](_0x2afcdc(0x10e)+_0x2ef581['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x2afcdc(0x11a)](async _0x19fd8d=>{const _0x1b2a5d=_0x2afcdc,_0x20076d=await _0x19fd8d['paymentLink'][_0x1b2a5d(0x185)]({'where':{'id':_0x2ef581[_0x1b2a5d(0x121)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x20076d){console[_0x1b2a5d(0x122)](_0x1b2a5d(0x164)+_0x20076d['id']+_0x1b2a5d(0x131)+_0x20076d[_0x1b2a5d(0x161)]+_0x1b2a5d(0x12c)+_0x20076d['currentPayments']+',\x20status='+_0x20076d[_0x1b2a5d(0x180)]);const _0x46efdf=_0x20076d[_0x1b2a5d(0x14e)]+0x1,_0x227e7a=_0x20076d[_0x1b2a5d(0x161)]===_0x1b2a5d(0x167)?_0x1b2a5d(0x12d):_0x20076d['status'];await _0x19fd8d[_0x1b2a5d(0x13d)][_0x1b2a5d(0x17d)]({'where':{'id':_0x2ef581[_0x1b2a5d(0x121)]},'data':{'currentPayments':_0x46efdf,'status':_0x227e7a,'updatedAt':new Date()}}),console[_0x1b2a5d(0x122)](_0x1b2a5d(0x153)+_0x20076d['id']+_0x1b2a5d(0x115)+_0x20076d['currentPayments']+_0x1b2a5d(0x15b)+_0x46efdf+_0x1b2a5d(0x130)+_0x20076d[_0x1b2a5d(0x180)]+'\x20->\x20'+_0x227e7a);}else console[_0x1b2a5d(0x122)](_0x1b2a5d(0x14a)+_0x2ef581[_0x1b2a5d(0x121)]+_0x1b2a5d(0x16d));});}catch(_0x4d36bc){console[_0x2afcdc(0x176)](_0x2afcdc(0x179),_0x4d36bc);}}await database_1[_0x2afcdc(0x145)][_0x2afcdc(0x172)]['create']({'data':{'paymentId':_0x2ef581['id'],'shopId':_0x2ef581['shopId'],'event':_0x2afcdc(0x169)+_0x3c07c6[_0x2afcdc(0x180)][_0x2afcdc(0x14d)](),'statusCode':0xc8,'responseBody':JSON[_0x2afcdc(0x17b)]({'oldStatus':'PENDING','newStatus':_0x3c07c6[_0x2afcdc(0x180)],'transactionId':_0x3c07c6[_0x2afcdc(0x177)],'failureReason':_0x3c07c6['failureReason'],'processedAt':new Date()[_0x2afcdc(0x113)]()})}}),await this['sendShopWebhook'](_0x2ef581,_0x3c07c6[_0x2afcdc(0x180)],_0x3c07c6[_0x2afcdc(0x177)],_0x3c07c6[_0x2afcdc(0x13f)]),await this[_0x2afcdc(0x183)](_0x2ef581,_0x3c07c6[_0x2afcdc(0x180)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x384a90+'\x20processed:\x20'+_0x3c07c6['status']),_0x3c07c6[_0x2afcdc(0x180)]===_0x2afcdc(0x141)?_0x475292[_0x2afcdc(0x150)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2afcdc(0x141),'transactionId':_0x3c07c6[_0x2afcdc(0x177)],'redirectUrl':_0x2ef581[_0x2afcdc(0x16b)]}}):_0x475292[_0x2afcdc(0x180)](0x190)[_0x2afcdc(0x150)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x2afcdc(0x16e),'failureReason':_0x3c07c6[_0x2afcdc(0x13f)],'redirectUrl':_0x2ef581[_0x2afcdc(0x138)]}});}catch(_0x233392){_0x3290f8(_0x233392);}},this[_0x11af9b(0x11d)]=new testGatewayService_1[(_0x11af9b(0x14b))](),this[_0x11af9b(0x148)]=new webhookService_1[(_0x11af9b(0x12e))]();}async[a13_0x330a69(0x13a)](_0x55d771,_0x548df7,_0x591298,_0x297550){const _0x275679=a13_0x330a69,_0x455519=Date[_0x275679(0x119)]();try{const _0x5890e5=_0x55d771['shop'],_0x1d0f9f=_0x5890e5[_0x275679(0x118)];if(!_0x1d0f9f?.[_0x275679(0x166)]){console[_0x275679(0x122)](_0x275679(0x17c)+_0x5890e5['id']);return;}const _0x406441=_0x548df7===_0x275679(0x141)?_0x275679(0x15f):_0x275679(0x143);let _0x3fb92b=[];if(_0x1d0f9f[_0x275679(0x133)])try{_0x3fb92b=Array[_0x275679(0x165)](_0x1d0f9f[_0x275679(0x133)])?_0x1d0f9f['webhookEvents']:JSON[_0x275679(0x137)](_0x1d0f9f[_0x275679(0x133)]);}catch(_0x189bf7){console['error']('Error\x20parsing\x20webhook\x20events:',_0x189bf7),_0x3fb92b=[];}if(!_0x3fb92b['includes'](_0x406441)){console['log']('Webhook\x20event\x20'+_0x406441+_0x275679(0x13e)+_0x5890e5['id']);return;}const _0x2f0966={'event':_0x406441,'payment':{'id':_0x55d771['id'],'order_id':_0x55d771[_0x275679(0x126)],'gateway_order_id':_0x55d771['gatewayOrderId'],'gateway':'0000','amount':_0x55d771[_0x275679(0x129)],'currency':_0x55d771[_0x275679(0x159)],'status':_0x548df7[_0x275679(0x14d)](),'customer_email':_0x55d771[_0x275679(0x174)],'customer_name':_0x55d771[_0x275679(0x15d)],'transaction_id':_0x591298,'failure_message':_0x297550,'created_at':_0x55d771[_0x275679(0x15a)],'updated_at':new Date()}},_0x9d5bcf=await fetch(_0x1d0f9f[_0x275679(0x166)],{'method':_0x275679(0x135),'headers':{'Content-Type':_0x275679(0x139),'User-Agent':_0x275679(0x16c)},'body':JSON['stringify'](_0x2f0966)}),_0x194407=Date[_0x275679(0x119)]()-_0x455519;console['log'](_0x275679(0x120)+_0x1d0f9f['webhookUrl']+_0x275679(0x152)+_0x9d5bcf[_0x275679(0x180)]+'\x20('+_0x194407+_0x275679(0x157));}catch(_0xf80272){console[_0x275679(0x176)](_0x275679(0x17e),_0xf80272);}}async[a13_0x330a69(0x183)](_0x5f57bf,_0x42f384){const _0x530eef=a13_0x330a69;try{const {telegramBotService:_0x4b9f3d}=await Promise[_0x530eef(0x187)]()[_0x530eef(0x168)](()=>__importStar(require(_0x530eef(0x128)))),_0x24d222={'PAID':_0x530eef(0x134),'FAILED':'failed'},_0x32e45e=_0x24d222[_0x42f384];if(!_0x32e45e)return;await _0x4b9f3d[_0x530eef(0x16f)](_0x5f57bf[_0x530eef(0x158)],_0x5f57bf,_0x32e45e);}catch(_0x3fa6d7){console[_0x530eef(0x176)](_0x530eef(0x144),_0x3fa6d7);}}}exports[a13_0x330a69(0x14f)]=TestGatewayController;