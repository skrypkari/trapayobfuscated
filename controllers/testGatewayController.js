'use strict';const a13_0xbd320b=a13_0x5667;function a13_0x5667(_0xaa801f,_0x38ed20){const _0x4fd372=a13_0x4fd3();return a13_0x5667=function(_0x566772,_0x140956){_0x566772=_0x566772-0xc6;let _0x210af4=_0x4fd372[_0x566772];return _0x210af4;},a13_0x5667(_0xaa801f,_0x38ed20);}(function(_0x163a65,_0x295948){const _0x1a5b96=a13_0x5667,_0x223266=_0x163a65();while(!![]){try{const _0x14b57a=-parseInt(_0x1a5b96(0x13b))/0x1+parseInt(_0x1a5b96(0x12c))/0x2*(-parseInt(_0x1a5b96(0x100))/0x3)+-parseInt(_0x1a5b96(0x10b))/0x4+-parseInt(_0x1a5b96(0x11f))/0x5+-parseInt(_0x1a5b96(0xcb))/0x6+parseInt(_0x1a5b96(0x114))/0x7+parseInt(_0x1a5b96(0xcd))/0x8;if(_0x14b57a===_0x295948)break;else _0x223266['push'](_0x223266['shift']());}catch(_0x3c44da){_0x223266['push'](_0x223266['shift']());}}}(a13_0x4fd3,0x84a0c));function a13_0x4fd3(){const _0x2fc6f6=['test_gateway_','includes','params','TestGatewayController','body','getOwnPropertyNames','280287uWapvf','\x20->\x20','currentPayments','stringify','test_gateway','findUnique','\x20processed:\x20','4587576YrdRJk','update','18039592jIantO','paidAt','currency','Any\x20name','cardLast4','customerEmail','paid','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',',\x20currentPayments=','shop','COMPLETED','log','webhookEvents','name','settings','webhookUrl','call','SINGLE','gatewayPaymentId','cardNumber','failUrl','isArray','webhookService','slice','defineProperty','\x20not\x20found',':\x20type=',',\x20status=','create','gatewayOrderId','__importDefault','\x20with\x20status\x20','now','testGatewayService','Payment\x20not\x20found','get','failed','writable','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Webhook\x20event\x20','getOwnPropertyDescriptor','FAILED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚ùå\x20Payment\x20link\x20','\x20not\x20enabled\x20for\x20shop\x20','PAID','resolve','üìà\x20Found\x20payment\x20link\x20','webhookLog','‚úÖ\x20Test\x20Gateway\x20payment\x20','json','3ytbhWy','payment.failed','../services/telegramBotService','Payment\x20status\x20is\x20','\x20updated:\x20currentPayments=','error','amount','sendShopWebhook','getPaymentForm','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','PENDING','2495328sDBwpf','__importStar','payment','Error\x20parsing\x20webhook\x20events:','transactionId','Payment\x20is\x20not\x20for\x20test\x20gateway','__setModuleDefault','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__esModule','1743854oxzMee','üß™\x20Test\x20Gateway\x20result:','default','WebhookService','0000','replace','status','processCard','‚úÖ\x20Payment\x20link\x20','toISOString','failureReason','963325QYgfra','hasOwnProperty','Any\x20other\x20card\x20number','shopId','failureMessage','Payment\x20processed\x20successfully','toLowerCase','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','$transaction','Any\x20future\x20date\x20(MM/YY)','paymentLinkId','Any\x203-4\x20digits','gateway','198894fLtiGV','then','length','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20to\x20','configurable','sendPaymentStatusNotification',',\x20cannot\x20process','Payment\x20failed'];a13_0x4fd3=function(){return _0x2fc6f6;};return a13_0x4fd3();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x15cc43,_0x1f5a9f,_0x7f3fa5,_0x100518){const _0x500209=a13_0x5667;if(_0x100518===undefined)_0x100518=_0x7f3fa5;var _0x5e10f6=Object[_0x500209(0xf5)](_0x1f5a9f,_0x7f3fa5);(!_0x5e10f6||(_0x500209(0xf0)in _0x5e10f6?!_0x1f5a9f['__esModule']:_0x5e10f6[_0x500209(0xf2)]||_0x5e10f6[_0x500209(0x131)]))&&(_0x5e10f6={'enumerable':!![],'get':function(){return _0x1f5a9f[_0x7f3fa5];}}),Object[_0x500209(0xe5)](_0x15cc43,_0x100518,_0x5e10f6);}:function(_0x38b643,_0x3f9560,_0x374a64,_0x22f5bd){if(_0x22f5bd===undefined)_0x22f5bd=_0x374a64;_0x38b643[_0x22f5bd]=_0x3f9560[_0x374a64];}),__setModuleDefault=this&&this[a13_0xbd320b(0x111)]||(Object[a13_0xbd320b(0xe9)]?function(_0x4b606c,_0x19e64a){const _0x2abc6a=a13_0xbd320b;Object[_0x2abc6a(0xe5)](_0x4b606c,'default',{'enumerable':!![],'value':_0x19e64a});}:function(_0x3e869b,_0x3932b3){const _0x3a4d4e=a13_0xbd320b;_0x3e869b[_0x3a4d4e(0x116)]=_0x3932b3;}),__importStar=this&&this[a13_0xbd320b(0x10c)]||(function(){var _0x413ede=function(_0x40f5be){const _0x2400dc=a13_0x5667;return _0x413ede=Object[_0x2400dc(0x13a)]||function(_0x2ba9fc){const _0x23ace8=_0x2400dc;var _0x23b7b2=[];for(var _0x1fa27f in _0x2ba9fc)if(Object['prototype'][_0x23ace8(0x120)][_0x23ace8(0xdd)](_0x2ba9fc,_0x1fa27f))_0x23b7b2[_0x23b7b2[_0x23ace8(0x12e)]]=_0x1fa27f;return _0x23b7b2;},_0x413ede(_0x40f5be);};return function(_0x886b9b){const _0x1a85fd=a13_0x5667;if(_0x886b9b&&_0x886b9b[_0x1a85fd(0x113)])return _0x886b9b;var _0x3904dd={};if(_0x886b9b!=null){for(var _0x2e124=_0x413ede(_0x886b9b),_0x1afc40=0x0;_0x1afc40<_0x2e124[_0x1a85fd(0x12e)];_0x1afc40++)if(_0x2e124[_0x1afc40]!==_0x1a85fd(0x116))__createBinding(_0x3904dd,_0x886b9b,_0x2e124[_0x1afc40]);}return __setModuleDefault(_0x3904dd,_0x886b9b),_0x3904dd;};}()),__importDefault=this&&this[a13_0xbd320b(0xeb)]||function(_0x1dc6f9){const _0x171ad9=a13_0xbd320b;return _0x1dc6f9&&_0x1dc6f9[_0x171ad9(0x113)]?_0x1dc6f9:{'default':_0x1dc6f9};};Object[a13_0xbd320b(0xe5)](exports,a13_0xbd320b(0x113),{'value':!![]}),exports[a13_0xbd320b(0x138)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x48e72e=a13_0xbd320b;this[_0x48e72e(0x108)]=async(_0x5e22bf,_0x1cf349,_0x5eb889)=>{const _0x57986c=_0x48e72e;try{const {paymentId:_0x4f48e2}=_0x5e22bf[_0x57986c(0x137)];console['log'](_0x57986c(0x109)+_0x4f48e2);const _0xc86e58=await database_1[_0x57986c(0x116)]['payment'][_0x57986c(0xc9)]({'where':{'id':_0x4f48e2},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xc86e58)return _0x1cf349['status'](0x194)[_0x57986c(0xff)]({'success':![],'message':_0x57986c(0xef)});if(_0xc86e58[_0x57986c(0x12b)]!==_0x57986c(0xc8))return _0x1cf349['status'](0x190)[_0x57986c(0xff)]({'success':![],'message':_0x57986c(0x110)});if(_0xc86e58[_0x57986c(0x11a)]!=='PENDING')return _0x1cf349[_0x57986c(0x11a)](0x190)[_0x57986c(0xff)]({'success':![],'message':_0x57986c(0x103)+_0xc86e58[_0x57986c(0x11a)]+_0x57986c(0x133)});_0x1cf349[_0x57986c(0xff)]({'success':!![],'result':{'paymentId':_0xc86e58['id'],'orderId':_0xc86e58[_0x57986c(0xea)],'amount':_0xc86e58['amount'],'currency':_0xc86e58[_0x57986c(0xcf)],'merchantName':_0xc86e58[_0x57986c(0xd6)]['name'],'description':_0x57986c(0x130)+_0xc86e58[_0x57986c(0xd6)][_0x57986c(0xda)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x57986c(0x121),'expiryDate':_0x57986c(0x128),'cvc':_0x57986c(0x12a),'holderName':_0x57986c(0xd0)}}});}catch(_0x5e819b){_0x5eb889(_0x5e819b);}},this[_0x48e72e(0x11b)]=async(_0x463609,_0xac7647,_0x12a6ca)=>{const _0x242e93=_0x48e72e;try{const {paymentId:_0x34d20e}=_0x463609['params'],_0x55fceb=_0x463609[_0x242e93(0x139)];console[_0x242e93(0xd8)](_0x242e93(0x112)+_0x34d20e);const _0x50f0e7=await database_1[_0x242e93(0x116)][_0x242e93(0x10d)]['findUnique']({'where':{'id':_0x34d20e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50f0e7)return _0xac7647[_0x242e93(0x11a)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x50f0e7['gateway']!=='test_gateway')return _0xac7647[_0x242e93(0x11a)](0x190)[_0x242e93(0xff)]({'success':![],'message':_0x242e93(0x110)});if(_0x50f0e7[_0x242e93(0x11a)]!=='PENDING')return _0xac7647[_0x242e93(0x11a)](0x190)['json']({'success':![],'message':_0x242e93(0x103)+_0x50f0e7[_0x242e93(0x11a)]+_0x242e93(0x133)});const _0x46d99d=await this[_0x242e93(0xee)]['processCardPayment']({'paymentId':_0x50f0e7['id'],'orderId':_0x50f0e7[_0x242e93(0xea)]||_0x50f0e7['id'],'amount':_0x50f0e7[_0x242e93(0x106)],'currency':_0x50f0e7[_0x242e93(0xcf)],'cardData':_0x55fceb});console[_0x242e93(0xd8)](_0x242e93(0x115),_0x46d99d);const _0x540e3b={'status':_0x46d99d[_0x242e93(0x11a)],'updatedAt':new Date()};if(_0x46d99d['status']===_0x242e93(0xfa))_0x540e3b[_0x242e93(0xce)]=new Date(),_0x540e3b[_0x242e93(0xdf)]=_0x46d99d[_0x242e93(0x10f)];else _0x46d99d['status']===_0x242e93(0xf6)&&(_0x540e3b[_0x242e93(0x123)]=_0x46d99d[_0x242e93(0x11e)]);const _0x12bb30=_0x55fceb[_0x242e93(0xe0)][_0x242e93(0x119)](/[\s-]/g,'');_0x540e3b[_0x242e93(0xd1)]=_0x12bb30[_0x242e93(0xe4)](-0x4),_0x540e3b['paymentMethod']='test_card',await database_1[_0x242e93(0x116)][_0x242e93(0x10d)]['update']({'where':{'id':_0x50f0e7['id']},'data':_0x540e3b});if(_0x46d99d[_0x242e93(0x11a)]===_0x242e93(0xfa)&&_0x50f0e7[_0x242e93(0x129)]){console[_0x242e93(0xd8)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x50f0e7['id']+_0x242e93(0x126));try{await database_1[_0x242e93(0x116)][_0x242e93(0x127)](async _0x85b699=>{const _0x2736da=_0x242e93,_0x1bee2d=await _0x85b699['paymentLink']['findUnique']({'where':{'id':_0x50f0e7['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1bee2d){console[_0x2736da(0xd8)](_0x2736da(0xfc)+_0x1bee2d['id']+_0x2736da(0xe7)+_0x1bee2d['type']+_0x2736da(0xd5)+_0x1bee2d[_0x2736da(0xc6)]+_0x2736da(0xe8)+_0x1bee2d['status']);const _0x66d3c6=_0x1bee2d['currentPayments']+0x1,_0x4d7d35=_0x1bee2d['type']===_0x2736da(0xde)?_0x2736da(0xd7):_0x1bee2d[_0x2736da(0x11a)];await _0x85b699['paymentLink'][_0x2736da(0xcc)]({'where':{'id':_0x50f0e7[_0x2736da(0x129)]},'data':{'currentPayments':_0x66d3c6,'status':_0x4d7d35,'updatedAt':new Date()}}),console['log'](_0x2736da(0x11c)+_0x1bee2d['id']+_0x2736da(0x104)+_0x1bee2d[_0x2736da(0xc6)]+_0x2736da(0x13c)+_0x66d3c6+_0x2736da(0xe8)+_0x1bee2d[_0x2736da(0x11a)]+'\x20->\x20'+_0x4d7d35);}else console[_0x2736da(0xd8)](_0x2736da(0xf8)+_0x50f0e7[_0x2736da(0x129)]+_0x2736da(0xe6));});}catch(_0x45937f){console[_0x242e93(0x105)](_0x242e93(0xd4),_0x45937f);}}await database_1[_0x242e93(0x116)][_0x242e93(0xfd)]['create']({'data':{'paymentId':_0x50f0e7['id'],'shopId':_0x50f0e7[_0x242e93(0x122)],'event':_0x242e93(0x135)+_0x46d99d[_0x242e93(0x11a)][_0x242e93(0x125)](),'statusCode':0xc8,'responseBody':JSON[_0x242e93(0xc7)]({'oldStatus':_0x242e93(0x10a),'newStatus':_0x46d99d[_0x242e93(0x11a)],'transactionId':_0x46d99d[_0x242e93(0x10f)],'failureReason':_0x46d99d[_0x242e93(0x11e)],'processedAt':new Date()[_0x242e93(0x11d)]()})}}),await this['sendShopWebhook'](_0x50f0e7,_0x46d99d['status'],_0x46d99d[_0x242e93(0x10f)],_0x46d99d[_0x242e93(0x11e)]),await this[_0x242e93(0x132)](_0x50f0e7,_0x46d99d[_0x242e93(0x11a)]),console[_0x242e93(0xd8)](_0x242e93(0xfe)+_0x34d20e+_0x242e93(0xca)+_0x46d99d[_0x242e93(0x11a)]),_0x46d99d[_0x242e93(0x11a)]===_0x242e93(0xfa)?_0xac7647[_0x242e93(0xff)]({'success':!![],'message':_0x242e93(0x124),'result':{'status':_0x242e93(0xfa),'transactionId':_0x46d99d[_0x242e93(0x10f)],'redirectUrl':_0x50f0e7['successUrl']}}):_0xac7647[_0x242e93(0x11a)](0x190)['json']({'success':![],'message':_0x242e93(0x134),'result':{'status':_0x242e93(0xf6),'failureReason':_0x46d99d[_0x242e93(0x11e)],'redirectUrl':_0x50f0e7[_0x242e93(0xe1)]}});}catch(_0x2d63ad){_0x12a6ca(_0x2d63ad);}},this[_0x48e72e(0xee)]=new testGatewayService_1['TestGatewayService'](),this[_0x48e72e(0xe3)]=new webhookService_1[(_0x48e72e(0x117))]();}async[a13_0xbd320b(0x107)](_0x5d0a26,_0xc5752f,_0x24e2ca,_0x4b7b33){const _0x67649b=a13_0xbd320b,_0x280c39=Date[_0x67649b(0xed)]();try{const _0x17a1e6=_0x5d0a26[_0x67649b(0xd6)],_0x50a669=_0x17a1e6[_0x67649b(0xdb)];if(!_0x50a669?.[_0x67649b(0xdc)]){console[_0x67649b(0xd8)](_0x67649b(0xf7)+_0x17a1e6['id']);return;}const _0x51645a=_0xc5752f===_0x67649b(0xfa)?'payment.success':_0x67649b(0x101);let _0x4e2983=[];if(_0x50a669[_0x67649b(0xd9)])try{_0x4e2983=Array[_0x67649b(0xe2)](_0x50a669['webhookEvents'])?_0x50a669[_0x67649b(0xd9)]:JSON['parse'](_0x50a669[_0x67649b(0xd9)]);}catch(_0x54a575){console[_0x67649b(0x105)](_0x67649b(0x10e),_0x54a575),_0x4e2983=[];}if(!_0x4e2983[_0x67649b(0x136)](_0x51645a)){console[_0x67649b(0xd8)](_0x67649b(0xf4)+_0x51645a+_0x67649b(0xf9)+_0x17a1e6['id']);return;}const _0x228012={'event':_0x51645a,'payment':{'id':_0x5d0a26['id'],'order_id':_0x5d0a26['orderId'],'gateway_order_id':_0x5d0a26[_0x67649b(0xea)],'gateway':_0x67649b(0x118),'amount':_0x5d0a26[_0x67649b(0x106)],'currency':_0x5d0a26['currency'],'status':_0xc5752f['toLowerCase'](),'customer_email':_0x5d0a26[_0x67649b(0xd2)],'customer_name':_0x5d0a26['customerName'],'transaction_id':_0x24e2ca,'failure_message':_0x4b7b33,'created_at':_0x5d0a26['createdAt'],'updated_at':new Date()}},_0x5dfe02=await fetch(_0x50a669[_0x67649b(0xdc)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x67649b(0x12f)},'body':JSON[_0x67649b(0xc7)](_0x228012)}),_0x44211c=Date[_0x67649b(0xed)]()-_0x280c39;console[_0x67649b(0xd8)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x50a669[_0x67649b(0xdc)]+_0x67649b(0xec)+_0x5dfe02[_0x67649b(0x11a)]+'\x20('+_0x44211c+'ms)');}catch(_0x3bc769){console[_0x67649b(0x105)](_0x67649b(0xf3),_0x3bc769);}}async[a13_0xbd320b(0x132)](_0x429a35,_0x4c5b05){const _0x1ca95b=a13_0xbd320b;try{const {telegramBotService:_0x384940}=await Promise[_0x1ca95b(0xfb)]()[_0x1ca95b(0x12d)](()=>__importStar(require(_0x1ca95b(0x102)))),_0xa7ef3={'PAID':_0x1ca95b(0xd3),'FAILED':_0x1ca95b(0xf1)},_0x384fd6=_0xa7ef3[_0x4c5b05];if(!_0x384fd6)return;await _0x384940['sendPaymentNotification'](_0x429a35[_0x1ca95b(0x122)],_0x429a35,_0x384fd6);}catch(_0x52dd21){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x52dd21);}}}exports[a13_0xbd320b(0x138)]=TestGatewayController;