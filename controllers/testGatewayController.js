'use strict';const a19_0x176a64=a19_0x2d10;(function(_0x2bda98,_0xb27182){const _0x47afd7=a19_0x2d10,_0x48c8d1=_0x2bda98();while(!![]){try{const _0x3ed447=-parseInt(_0x47afd7(0xfb))/0x1+-parseInt(_0x47afd7(0x111))/0x2+-parseInt(_0x47afd7(0xdb))/0x3*(-parseInt(_0x47afd7(0xa7))/0x4)+-parseInt(_0x47afd7(0xc9))/0x5*(-parseInt(_0x47afd7(0x10c))/0x6)+parseInt(_0x47afd7(0x95))/0x7*(parseInt(_0x47afd7(0xc4))/0x8)+-parseInt(_0x47afd7(0xed))/0x9+-parseInt(_0x47afd7(0x96))/0xa*(-parseInt(_0x47afd7(0x90))/0xb);if(_0x3ed447===_0xb27182)break;else _0x48c8d1['push'](_0x48c8d1['shift']());}catch(_0x3b472c){_0x48c8d1['push'](_0x48c8d1['shift']());}}}(a19_0x29f6,0x7c618));function a19_0x2d10(_0x201898,_0x5cf3b8){_0x201898=_0x201898-0x8c;const _0x29f6e0=a19_0x29f6();let _0x2d10d2=_0x29f6e0[_0x201898];return _0x2d10d2;}function a19_0x29f6(){const _0x3d62f4=[',\x20cannot\x20process','failureReason','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','../services/webhookService','PENDING','name','\x20processed:\x20','‚úÖ\x20Payment\x20link\x20','\x20with\x20status\x20','Any\x20name','üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','params','writable','‚úÖ\x20Test\x20Gateway\x20payment\x20','ms)','isArray','18672LdQSFq','webhookEvents','type','Payment\x20is\x20not\x20for\x20test\x20gateway','Error\x20parsing\x20webhook\x20events:','925736hdWHhQ','default','cardNumber','\x20->\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','currency','33NeQsCl','WebhookService',',\x20currentPayments=','test_gateway','FAILED','84jbbkFZ','1943140PNtaGA','Any\x20other\x20card\x20number','json','payment.failed','transactionId','successUrl',',\x20webhookUrl=','üìà\x20Test\x20Gateway:\x20Payment\x20','TestGatewayController','log','0000','test_card','payment','error','__setModuleDefault','then','gatewayOrderId','525988QAOomS','Payment\x20processed\x20successfully','customerName','\x20not\x20found','$transaction','Payment\x20not\x20found','getPaymentForm','__importStar','cardLast4','‚ö†Ô∏è\x20Webhook\x20event\x20','shop','application/json',',\x20status=','sendShopWebhook','paid','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookService','sendPaymentStatusNotification','gateway','‚ùå\x20Payment\x20link\x20','hasOwnProperty','Payment\x20status\x20is\x20','replace','__importDefault','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','toLowerCase','stringify',':\x20type=','not\x20configured','343976XpNUzh','defineProperty','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','sendPaymentNotification','üß™\x20Test\x20Gateway\x20result:','795QSYSpZ','POST','get','webhookUrl','PAID','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','webhookLog','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLinkId','status','getOwnPropertyNames','currentPayments','call','testGatewayService','includes','shopId','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','12raOPyl','__esModule','4242\x204242\x204242\x204242','orderId','length','paidAt','Payment\x20failed','createdAt','paymentMethod','configured','update','test_gateway_','Payment\x20to\x20','üìà\x20Found\x20payment\x20link\x20','../config/database','amount','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','6242283NYhTVj','body','now','...','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üß™\x20Webhook\x20payload:','create','findUnique','\x20updated:\x20currentPayments=','settings','failed','payment.success','failureMessage','paymentLink','453783Gqxicu'];a19_0x29f6=function(){return _0x3d62f4;};return a19_0x29f6();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x2cd89c,_0x4732a4,_0x1632f5,_0x253465){const _0xb9f7c0=a19_0x2d10;if(_0x253465===undefined)_0x253465=_0x1632f5;var _0x2919e7=Object['getOwnPropertyDescriptor'](_0x4732a4,_0x1632f5);(!_0x2919e7||(_0xb9f7c0(0xcb)in _0x2919e7?!_0x4732a4[_0xb9f7c0(0xdc)]:_0x2919e7[_0xb9f7c0(0x108)]||_0x2919e7['configurable']))&&(_0x2919e7={'enumerable':!![],'get':function(){return _0x4732a4[_0x1632f5];}}),Object['defineProperty'](_0x2cd89c,_0x253465,_0x2919e7);}:function(_0x2be07f,_0x241aa8,_0x5c1860,_0x58bd7c){if(_0x58bd7c===undefined)_0x58bd7c=_0x5c1860;_0x2be07f[_0x58bd7c]=_0x241aa8[_0x5c1860];}),__setModuleDefault=this&&this[a19_0x176a64(0xa4)]||(Object[a19_0x176a64(0xf3)]?function(_0x41f8d7,_0x2beb68){const _0x1df7ff=a19_0x176a64;Object[_0x1df7ff(0xc5)](_0x41f8d7,'default',{'enumerable':!![],'value':_0x2beb68});}:function(_0x481b7b,_0x1e3559){const _0x31c2bc=a19_0x176a64;_0x481b7b[_0x31c2bc(0x112)]=_0x1e3559;}),__importStar=this&&this[a19_0x176a64(0xae)]||(function(){var _0x17134a=function(_0x51cf26){const _0x37c2d4=a19_0x2d10;return _0x17134a=Object[_0x37c2d4(0xd4)]||function(_0x12a337){const _0xfe4637=_0x37c2d4;var _0x1dc548=[];for(var _0x4d1a33 in _0x12a337)if(Object['prototype'][_0xfe4637(0xbb)][_0xfe4637(0xd6)](_0x12a337,_0x4d1a33))_0x1dc548[_0x1dc548[_0xfe4637(0xdf)]]=_0x4d1a33;return _0x1dc548;},_0x17134a(_0x51cf26);};return function(_0x44640d){const _0x549d6c=a19_0x2d10;if(_0x44640d&&_0x44640d['__esModule'])return _0x44640d;var _0x444f9e={};if(_0x44640d!=null){for(var _0x34e7e8=_0x17134a(_0x44640d),_0x51cb41=0x0;_0x51cb41<_0x34e7e8[_0x549d6c(0xdf)];_0x51cb41++)if(_0x34e7e8[_0x51cb41]!=='default')__createBinding(_0x444f9e,_0x44640d,_0x34e7e8[_0x51cb41]);}return __setModuleDefault(_0x444f9e,_0x44640d),_0x444f9e;};}()),__importDefault=this&&this[a19_0x176a64(0xbe)]||function(_0xfe743f){const _0x4163f4=a19_0x176a64;return _0xfe743f&&_0xfe743f[_0x4163f4(0xdc)]?_0xfe743f:{'default':_0xfe743f};};Object[a19_0x176a64(0xc5)](exports,a19_0x176a64(0xdc),{'value':!![]}),exports[a19_0x176a64(0x9e)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a19_0x176a64(0xff)),database_1=__importDefault(require(a19_0x176a64(0xe9)));class TestGatewayController{constructor(){const _0x90c928=a19_0x176a64;this[_0x90c928(0xad)]=async(_0x3283b7,_0x197044,_0x1a8afb)=>{const _0xa76afd=_0x90c928;try{const {paymentId:_0xfb80a8}=_0x3283b7['params'];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0xfb80a8);const _0x229e4e=await database_1[_0xa76afd(0x112)][_0xa76afd(0xa2)][_0xa76afd(0xf4)]({'where':{'id':_0xfb80a8},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x229e4e)return _0x197044[_0xa76afd(0xd3)](0x194)[_0xa76afd(0x98)]({'success':![],'message':_0xa76afd(0xac)});if(_0x229e4e[_0xa76afd(0xb9)]!==_0xa76afd(0x93))return _0x197044[_0xa76afd(0xd3)](0x190)[_0xa76afd(0x98)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x229e4e[_0xa76afd(0xd3)]!==_0xa76afd(0x100))return _0x197044[_0xa76afd(0xd3)](0x190)[_0xa76afd(0x98)]({'success':![],'message':_0xa76afd(0xbc)+_0x229e4e[_0xa76afd(0xd3)]+_0xa76afd(0xfc)});_0x197044[_0xa76afd(0x98)]({'success':!![],'result':{'paymentId':_0x229e4e['id'],'orderId':_0x229e4e['gatewayOrderId'],'amount':_0x229e4e[_0xa76afd(0xea)],'currency':_0x229e4e['currency'],'merchantName':_0x229e4e['shop'][_0xa76afd(0x101)],'description':_0xa76afd(0xe7)+_0x229e4e['shop'][_0xa76afd(0x101)],'testInstructions':{'successCard':_0xa76afd(0xdd),'failureCard':_0xa76afd(0x97),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0xa76afd(0x105)}}});}catch(_0x1a87d4){_0x1a8afb(_0x1a87d4);}},this['processCard']=async(_0x11f685,_0x3a8cab,_0x56e21f)=>{const _0x3fc676=_0x90c928;try{const {paymentId:_0x9b2652}=_0x11f685[_0x3fc676(0x107)],_0x1054a5=_0x11f685[_0x3fc676(0xee)];console[_0x3fc676(0x9f)](_0x3fc676(0xc6)+_0x9b2652);const _0x4abefe=await database_1[_0x3fc676(0x112)][_0x3fc676(0xa2)][_0x3fc676(0xf4)]({'where':{'id':_0x9b2652},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4abefe)return _0x3a8cab[_0x3fc676(0xd3)](0x194)[_0x3fc676(0x98)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x4abefe[_0x3fc676(0xb9)]!==_0x3fc676(0x93))return _0x3a8cab[_0x3fc676(0xd3)](0x190)['json']({'success':![],'message':_0x3fc676(0x10f)});if(_0x4abefe['status']!==_0x3fc676(0x100))return _0x3a8cab[_0x3fc676(0xd3)](0x190)['json']({'success':![],'message':_0x3fc676(0xbc)+_0x4abefe[_0x3fc676(0xd3)]+_0x3fc676(0xfc)});const _0x1d6a29=await this['testGatewayService']['processCardPayment']({'paymentId':_0x4abefe['id'],'orderId':_0x4abefe[_0x3fc676(0xa6)]||_0x4abefe['id'],'amount':_0x4abefe['amount'],'currency':_0x4abefe['currency'],'cardData':_0x1054a5});console['log'](_0x3fc676(0xc8),_0x1d6a29);const _0x3c6b2a={'status':_0x1d6a29['status'],'updatedAt':new Date()};if(_0x1d6a29['status']==='PAID')_0x3c6b2a[_0x3fc676(0xe0)]=new Date(),_0x3c6b2a['gatewayPaymentId']=_0x1d6a29[_0x3fc676(0x9a)];else _0x1d6a29['status']===_0x3fc676(0x94)&&(_0x3c6b2a[_0x3fc676(0xf9)]=_0x1d6a29[_0x3fc676(0xfd)]);const _0x3534ea=_0x1054a5[_0x3fc676(0x8c)][_0x3fc676(0xbd)](/[\s-]/g,'');_0x3c6b2a[_0x3fc676(0xaf)]=_0x3534ea['slice'](-0x4),_0x3c6b2a[_0x3fc676(0xe3)]=_0x3fc676(0xa1),await database_1[_0x3fc676(0x112)][_0x3fc676(0xa2)][_0x3fc676(0xe5)]({'where':{'id':_0x4abefe['id']},'data':_0x3c6b2a});if(_0x1d6a29[_0x3fc676(0xd3)]==='PAID'&&_0x4abefe[_0x3fc676(0xd2)]){console['log'](_0x3fc676(0x9d)+_0x4abefe['id']+_0x3fc676(0x8e));try{await database_1['default'][_0x3fc676(0xab)](async _0x2dbe4c=>{const _0x342329=_0x3fc676,_0x516a4f=await _0x2dbe4c[_0x342329(0xfa)][_0x342329(0xf4)]({'where':{'id':_0x4abefe['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x516a4f){console[_0x342329(0x9f)](_0x342329(0xe8)+_0x516a4f['id']+_0x342329(0xc2)+_0x516a4f[_0x342329(0x10e)]+_0x342329(0x92)+_0x516a4f[_0x342329(0xd5)]+_0x342329(0xb3)+_0x516a4f[_0x342329(0xd3)]);const _0x4e3024=_0x516a4f[_0x342329(0xd5)]+0x1,_0x7d11ec=_0x516a4f[_0x342329(0x10e)]==='SINGLE'?'COMPLETED':_0x516a4f['status'];await _0x2dbe4c['paymentLink'][_0x342329(0xe5)]({'where':{'id':_0x4abefe[_0x342329(0xd2)]},'data':{'currentPayments':_0x4e3024,'status':_0x7d11ec,'updatedAt':new Date()}}),console[_0x342329(0x9f)](_0x342329(0x103)+_0x516a4f['id']+_0x342329(0xf5)+_0x516a4f[_0x342329(0xd5)]+_0x342329(0x8d)+_0x4e3024+_0x342329(0xb3)+_0x516a4f[_0x342329(0xd3)]+_0x342329(0x8d)+_0x7d11ec);}else console[_0x342329(0x9f)](_0x342329(0xba)+_0x4abefe['paymentLinkId']+_0x342329(0xaa));});}catch(_0x15ffd9){console[_0x3fc676(0xa3)](_0x3fc676(0xce),_0x15ffd9);}}await database_1['default'][_0x3fc676(0xcf)]['create']({'data':{'paymentId':_0x4abefe['id'],'shopId':_0x4abefe[_0x3fc676(0xd9)],'event':_0x3fc676(0xe6)+_0x1d6a29[_0x3fc676(0xd3)]['toLowerCase'](),'statusCode':_0x1d6a29[_0x3fc676(0xd3)]==='PAID'?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':_0x3fc676(0x100),'newStatus':_0x1d6a29['status'],'transactionId':_0x1d6a29[_0x3fc676(0x9a)],'failureReason':_0x1d6a29[_0x3fc676(0xfd)],'processedAt':new Date()['toISOString']()})}}),console[_0x3fc676(0x9f)](_0x3fc676(0xfe)+_0x1d6a29[_0x3fc676(0xd3)]+'...'),await this[_0x3fc676(0xb4)](_0x4abefe,_0x1d6a29[_0x3fc676(0xd3)],_0x1d6a29[_0x3fc676(0x9a)],_0x1d6a29['failureReason']),console[_0x3fc676(0x9f)]('üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20'+_0x1d6a29[_0x3fc676(0xd3)]),console[_0x3fc676(0x9f)](_0x3fc676(0x106)+_0x1d6a29[_0x3fc676(0xd3)]+_0x3fc676(0xf0)),await this[_0x3fc676(0xb8)](_0x4abefe,_0x1d6a29[_0x3fc676(0xd3)]),console[_0x3fc676(0x9f)](_0x3fc676(0xda)+_0x1d6a29[_0x3fc676(0xd3)]),console[_0x3fc676(0x9f)](_0x3fc676(0x109)+_0x9b2652+_0x3fc676(0x102)+_0x1d6a29[_0x3fc676(0xd3)]),_0x1d6a29[_0x3fc676(0xd3)]===_0x3fc676(0xcd)?_0x3a8cab['json']({'success':!![],'message':_0x3fc676(0xa8),'result':{'status':_0x3fc676(0xcd),'transactionId':_0x1d6a29[_0x3fc676(0x9a)],'redirectUrl':_0x4abefe[_0x3fc676(0x9b)]}}):_0x3a8cab[_0x3fc676(0xd3)](0x190)[_0x3fc676(0x98)]({'success':![],'message':_0x3fc676(0xe1),'result':{'status':_0x3fc676(0x94),'failureReason':_0x1d6a29[_0x3fc676(0xfd)],'redirectUrl':_0x4abefe['failUrl']}});}catch(_0x102c44){_0x56e21f(_0x102c44);}},this[_0x90c928(0xd7)]=new testGatewayService_1['TestGatewayService'](),this[_0x90c928(0xb7)]=new webhookService_1[(_0x90c928(0x91))]();}async[a19_0x176a64(0xb4)](_0x4bdcb5,_0x1b972a,_0x194b94,_0x43f0a5){const _0x20ead8=a19_0x176a64,_0x281704=Date[_0x20ead8(0xef)]();try{const _0x3e1f59=_0x4bdcb5[_0x20ead8(0xb1)],_0x4d7fa5=_0x3e1f59[_0x20ead8(0xf6)];if(!_0x4d7fa5?.['webhookUrl']){console[_0x20ead8(0x9f)](_0x20ead8(0xb6)+_0x3e1f59['id']);return;}const _0x39988e=_0x1b972a===_0x20ead8(0xcd)?_0x20ead8(0xf8):_0x20ead8(0x99);console['log']('üß™\x20Test\x20Gateway\x20webhook:\x20event='+_0x39988e+_0x20ead8(0x9c)+(_0x4d7fa5[_0x20ead8(0xcc)]?_0x20ead8(0xe4):_0x20ead8(0xc3)));let _0x26a04d=[];if(_0x4d7fa5[_0x20ead8(0x10d)])try{_0x26a04d=Array[_0x20ead8(0x10b)](_0x4d7fa5[_0x20ead8(0x10d)])?_0x4d7fa5[_0x20ead8(0x10d)]:JSON['parse'](_0x4d7fa5['webhookEvents']);}catch(_0xce2033){console[_0x20ead8(0xa3)](_0x20ead8(0x110),_0xce2033),_0x26a04d=[];}console[_0x20ead8(0x9f)](_0x20ead8(0xbf),_0x26a04d);if(!_0x26a04d[_0x20ead8(0xd8)](_0x39988e)){console['log'](_0x20ead8(0xb0)+_0x39988e+_0x20ead8(0xeb)+_0x3e1f59['id']);return;}const _0x35b5d1={'event':_0x39988e,'payment':{'id':_0x4bdcb5['id'],'order_id':_0x4bdcb5[_0x20ead8(0xde)],'gateway_order_id':_0x4bdcb5[_0x20ead8(0xa6)],'gateway':_0x20ead8(0xa0),'amount':_0x4bdcb5[_0x20ead8(0xea)],'currency':_0x4bdcb5[_0x20ead8(0x8f)],'status':_0x1b972a[_0x20ead8(0xc0)](),'customer_email':_0x4bdcb5['customerEmail'],'customer_name':_0x4bdcb5[_0x20ead8(0xa9)],'transaction_id':_0x194b94,'failure_message':_0x43f0a5,'created_at':_0x4bdcb5[_0x20ead8(0xe2)],'updated_at':new Date()}};console['log']('üß™\x20Sending\x20webhook\x20to\x20'+_0x4d7fa5['webhookUrl']+'...'),console[_0x20ead8(0x9f)](_0x20ead8(0xf2),JSON[_0x20ead8(0xc1)](_0x35b5d1,null,0x2));const _0x4c2755=await fetch(_0x4d7fa5[_0x20ead8(0xcc)],{'method':_0x20ead8(0xca),'headers':{'Content-Type':_0x20ead8(0xb2),'User-Agent':_0x20ead8(0xec)},'body':JSON[_0x20ead8(0xc1)](_0x35b5d1)}),_0x486fe1=Date[_0x20ead8(0xef)]()-_0x281704;console['log'](_0x20ead8(0xd1)+_0x4d7fa5[_0x20ead8(0xcc)]+_0x20ead8(0x104)+_0x4c2755[_0x20ead8(0xd3)]+'\x20('+_0x486fe1+_0x20ead8(0x10a));}catch(_0x3df573){console[_0x20ead8(0xa3)](_0x20ead8(0xd0),_0x3df573);}}async[a19_0x176a64(0xb8)](_0x28dd5e,_0x460708){const _0x460434=a19_0x176a64;try{const {telegramBotService:_0x5432f9}=await Promise['resolve']()[_0x460434(0xa5)](()=>__importStar(require('../services/telegramBotService'))),_0x19c78e={'PAID':_0x460434(0xb5),'FAILED':_0x460434(0xf7)},_0x340957=_0x19c78e[_0x460708];if(!_0x340957)return;await _0x5432f9[_0x460434(0xc7)](_0x28dd5e[_0x460434(0xd9)],_0x28dd5e,_0x340957);}catch(_0x236ae3){console['error'](_0x460434(0xf1),_0x236ae3);}}}exports[a19_0x176a64(0x9e)]=TestGatewayController;