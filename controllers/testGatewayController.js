'use strict';const a13_0x58b7f5=a13_0x117a;(function(_0x13c617,_0x3ad6ad){const _0x378407=a13_0x117a,_0x412346=_0x13c617();while(!![]){try{const _0x117a98=parseInt(_0x378407(0x1bb))/0x1*(parseInt(_0x378407(0x196))/0x2)+-parseInt(_0x378407(0x191))/0x3*(parseInt(_0x378407(0x197))/0x4)+-parseInt(_0x378407(0x19f))/0x5*(-parseInt(_0x378407(0x1a9))/0x6)+parseInt(_0x378407(0x1bf))/0x7*(parseInt(_0x378407(0x17b))/0x8)+parseInt(_0x378407(0x186))/0x9*(-parseInt(_0x378407(0x17a))/0xa)+-parseInt(_0x378407(0x16a))/0xb+parseInt(_0x378407(0x1a3))/0xc*(parseInt(_0x378407(0x16b))/0xd);if(_0x117a98===_0x3ad6ad)break;else _0x412346['push'](_0x412346['shift']());}catch(_0x44fd8e){_0x412346['push'](_0x412346['shift']());}}}(a13_0x17ff,0x6a6bd));function a13_0x17ff(){const _0x4cfed9=['webhookEvents','sendPaymentNotification','1020BEDoNz','9632XqrKyv','ðŸ§ª\x20Test\x20Gateway\x20result:','json','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','shopId','test_gateway_','transactionId','../services/webhookService','hasOwnProperty','test_gateway','settings','38061BNNbfU','testGatewayService','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','isArray','processCard','\x20not\x20enabled\x20for\x20shop\x20','Any\x203-4\x20digits','log','payment','Payment\x20status\x20is\x20','currency','66QtcfcK','Error\x20parsing\x20webhook\x20events:','Payment\x20is\x20not\x20for\x20test\x20gateway','âœ…\x20Test\x20Gateway\x20payment\x20','TestGatewayService','2FZAUhk','17668NvERui','payment.success','TestGatewayController','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shop','../config/database','configurable','\x20processed:\x20','35DxjRts','successUrl','Payment\x20not\x20found','gatewayOrderId','36jDzadv','toLowerCase','get','then','customerEmail','__esModule','707862xunWYg','Test\x20Gateway\x20webhook\x20sent\x20to\x20','failureReason','0000','Payment\x20processed\x20successfully','__importStar','sendPaymentStatusNotification','Any\x20other\x20card\x20number','getPaymentForm','test_card','error','paid','defineProperty','failed','failureMessage','resolve','Any\x20name','sendShopWebhook','21388TNvMYy','PAID','body','payment.failed','497EYqeAs','WebhookService','paidAt','getOwnPropertyNames','POST','status','length','application/json','ms)','__importDefault','findUnique','create','getOwnPropertyDescriptor','Any\x20future\x20date\x20(MM/YY)','params','writable','webhookLog','Payment\x20failed','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','orderId','name','gateway','gatewayPaymentId','../services/gateways/testGatewayService','FAILED','461901GrQBoC','319423RfNRde','Webhook\x20event\x20','amount','default','webhookUrl','processCardPayment','Payment\x20to\x20','PENDING',',\x20cannot\x20process','now','includes','../services/telegramBotService','createdAt'];a13_0x17ff=function(){return _0x4cfed9;};return a13_0x17ff();}function a13_0x117a(_0x20816d,_0x34ccf8){const _0x17ffe7=a13_0x17ff();return a13_0x117a=function(_0x117a0a,_0x2637c9){_0x117a0a=_0x117a0a-0x160;let _0xa2b01f=_0x17ffe7[_0x117a0a];return _0xa2b01f;},a13_0x117a(_0x20816d,_0x34ccf8);}var __createBinding=this&&this['__createBinding']||(Object[a13_0x58b7f5(0x1ca)]?function(_0x2574fe,_0x5ca584,_0x481092,_0x51819c){const _0x48b7cd=a13_0x58b7f5;if(_0x51819c===undefined)_0x51819c=_0x481092;var _0x4eac5f=Object[_0x48b7cd(0x1cb)](_0x5ca584,_0x481092);(!_0x4eac5f||(_0x48b7cd(0x1a5)in _0x4eac5f?!_0x5ca584[_0x48b7cd(0x1a8)]:_0x4eac5f[_0x48b7cd(0x160)]||_0x4eac5f[_0x48b7cd(0x19d)]))&&(_0x4eac5f={'enumerable':!![],'get':function(){return _0x5ca584[_0x481092];}}),Object[_0x48b7cd(0x1b5)](_0x2574fe,_0x51819c,_0x4eac5f);}:function(_0x2a2485,_0x372199,_0x1e3515,_0x16cf8f){if(_0x16cf8f===undefined)_0x16cf8f=_0x1e3515;_0x2a2485[_0x16cf8f]=_0x372199[_0x1e3515];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x2c91f9,_0x94f703){const _0x4e5bab=a13_0x58b7f5;Object['defineProperty'](_0x2c91f9,_0x4e5bab(0x16e),{'enumerable':!![],'value':_0x94f703});}:function(_0xcf1d77,_0xb4fbde){_0xcf1d77['default']=_0xb4fbde;}),__importStar=this&&this[a13_0x58b7f5(0x1ae)]||(function(){var _0xa4c970=function(_0x387d66){const _0x109514=a13_0x117a;return _0xa4c970=Object[_0x109514(0x1c2)]||function(_0x5345f3){const _0x1e26ab=_0x109514;var _0x17d32d=[];for(var _0x3461de in _0x5345f3)if(Object['prototype'][_0x1e26ab(0x183)]['call'](_0x5345f3,_0x3461de))_0x17d32d[_0x17d32d['length']]=_0x3461de;return _0x17d32d;},_0xa4c970(_0x387d66);};return function(_0x29f2c2){const _0x438f22=a13_0x117a;if(_0x29f2c2&&_0x29f2c2['__esModule'])return _0x29f2c2;var _0x3cc57a={};if(_0x29f2c2!=null){for(var _0x331d6a=_0xa4c970(_0x29f2c2),_0x450649=0x0;_0x450649<_0x331d6a[_0x438f22(0x1c5)];_0x450649++)if(_0x331d6a[_0x450649]!==_0x438f22(0x16e))__createBinding(_0x3cc57a,_0x29f2c2,_0x331d6a[_0x450649]);}return __setModuleDefault(_0x3cc57a,_0x29f2c2),_0x3cc57a;};}()),__importDefault=this&&this[a13_0x58b7f5(0x1c8)]||function(_0x86efeb){const _0x36173a=a13_0x58b7f5;return _0x86efeb&&_0x86efeb[_0x36173a(0x1a8)]?_0x86efeb:{'default':_0x86efeb};};Object['defineProperty'](exports,a13_0x58b7f5(0x1a8),{'value':!![]}),exports[a13_0x58b7f5(0x199)]=void 0x0;const testGatewayService_1=require(a13_0x58b7f5(0x168)),webhookService_1=require(a13_0x58b7f5(0x182)),database_1=__importDefault(require(a13_0x58b7f5(0x19c)));class TestGatewayController{constructor(){const _0x55fb69=a13_0x58b7f5;this[_0x55fb69(0x1b1)]=async(_0x1e26e8,_0x2194cc,_0x3f8b07)=>{const _0x65d2f4=_0x55fb69;try{const {paymentId:_0x4ba111}=_0x1e26e8[_0x65d2f4(0x1cd)];console[_0x65d2f4(0x18d)](_0x65d2f4(0x188)+_0x4ba111);const _0x40688f=await database_1[_0x65d2f4(0x16e)][_0x65d2f4(0x18e)]['findUnique']({'where':{'id':_0x4ba111},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x40688f)return _0x2194cc[_0x65d2f4(0x1c4)](0x194)[_0x65d2f4(0x17d)]({'success':![],'message':_0x65d2f4(0x1a1)});if(_0x40688f['gateway']!==_0x65d2f4(0x184))return _0x2194cc[_0x65d2f4(0x1c4)](0x190)[_0x65d2f4(0x17d)]({'success':![],'message':_0x65d2f4(0x193)});if(_0x40688f[_0x65d2f4(0x1c4)]!=='PENDING')return _0x2194cc['status'](0x190)['json']({'success':![],'message':_0x65d2f4(0x18f)+_0x40688f[_0x65d2f4(0x1c4)]+',\x20cannot\x20process'});_0x2194cc[_0x65d2f4(0x17d)]({'success':!![],'result':{'paymentId':_0x40688f['id'],'orderId':_0x40688f['gatewayOrderId'],'amount':_0x40688f[_0x65d2f4(0x16d)],'currency':_0x40688f['currency'],'merchantName':_0x40688f[_0x65d2f4(0x19b)]['name'],'description':_0x65d2f4(0x171)+_0x40688f[_0x65d2f4(0x19b)][_0x65d2f4(0x165)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x65d2f4(0x1b0),'expiryDate':_0x65d2f4(0x1cc),'cvc':_0x65d2f4(0x18c),'holderName':_0x65d2f4(0x1b9)}}});}catch(_0x8982a0){_0x3f8b07(_0x8982a0);}},this[_0x55fb69(0x18a)]=async(_0x3f270d,_0x1d1cca,_0xd795)=>{const _0x400bdb=_0x55fb69;try{const {paymentId:_0x41e55c}=_0x3f270d[_0x400bdb(0x1cd)],_0x57cc03=_0x3f270d[_0x400bdb(0x1bd)];console[_0x400bdb(0x18d)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x41e55c);const _0x102fdc=await database_1[_0x400bdb(0x16e)][_0x400bdb(0x18e)][_0x400bdb(0x1c9)]({'where':{'id':_0x41e55c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x102fdc)return _0x1d1cca[_0x400bdb(0x1c4)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x102fdc[_0x400bdb(0x166)]!=='test_gateway')return _0x1d1cca[_0x400bdb(0x1c4)](0x190)['json']({'success':![],'message':_0x400bdb(0x193)});if(_0x102fdc[_0x400bdb(0x1c4)]!==_0x400bdb(0x172))return _0x1d1cca[_0x400bdb(0x1c4)](0x190)[_0x400bdb(0x17d)]({'success':![],'message':_0x400bdb(0x18f)+_0x102fdc[_0x400bdb(0x1c4)]+_0x400bdb(0x173)});const _0x28dda5=await this[_0x400bdb(0x187)][_0x400bdb(0x170)]({'paymentId':_0x102fdc['id'],'orderId':_0x102fdc[_0x400bdb(0x1a2)]||_0x102fdc['id'],'amount':_0x102fdc[_0x400bdb(0x16d)],'currency':_0x102fdc[_0x400bdb(0x190)],'cardData':_0x57cc03});console[_0x400bdb(0x18d)](_0x400bdb(0x17c),_0x28dda5);const _0x58232d={'status':_0x28dda5['status'],'updatedAt':new Date()};if(_0x28dda5[_0x400bdb(0x1c4)]===_0x400bdb(0x1bc))_0x58232d[_0x400bdb(0x1c1)]=new Date(),_0x58232d[_0x400bdb(0x167)]=_0x28dda5[_0x400bdb(0x181)];else _0x28dda5[_0x400bdb(0x1c4)]===_0x400bdb(0x169)&&(_0x58232d[_0x400bdb(0x1b7)]=_0x28dda5[_0x400bdb(0x1ab)]);const _0x1306fd=_0x57cc03['cardNumber']['replace'](/[\s-]/g,'');_0x58232d['cardLast4']=_0x1306fd['slice'](-0x4),_0x58232d['paymentMethod']=_0x400bdb(0x1b2),await database_1[_0x400bdb(0x16e)]['payment']['update']({'where':{'id':_0x102fdc['id']},'data':_0x58232d}),await database_1['default'][_0x400bdb(0x161)]['create']({'data':{'paymentId':_0x102fdc['id'],'shopId':_0x102fdc[_0x400bdb(0x17f)],'event':_0x400bdb(0x180)+_0x28dda5['status'][_0x400bdb(0x1a4)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x400bdb(0x172),'newStatus':_0x28dda5[_0x400bdb(0x1c4)],'transactionId':_0x28dda5[_0x400bdb(0x181)],'failureReason':_0x28dda5['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x400bdb(0x1ba)](_0x102fdc,_0x28dda5[_0x400bdb(0x1c4)],_0x28dda5['transactionId'],_0x28dda5['failureReason']),await this['sendPaymentStatusNotification'](_0x102fdc,_0x28dda5['status']),console[_0x400bdb(0x18d)](_0x400bdb(0x194)+_0x41e55c+_0x400bdb(0x19e)+_0x28dda5[_0x400bdb(0x1c4)]),_0x28dda5[_0x400bdb(0x1c4)]===_0x400bdb(0x1bc)?_0x1d1cca['json']({'success':!![],'message':_0x400bdb(0x1ad),'result':{'status':'PAID','transactionId':_0x28dda5[_0x400bdb(0x181)],'redirectUrl':_0x102fdc[_0x400bdb(0x1a0)]}}):_0x1d1cca[_0x400bdb(0x1c4)](0x190)[_0x400bdb(0x17d)]({'success':![],'message':_0x400bdb(0x162),'result':{'status':_0x400bdb(0x169),'failureReason':_0x28dda5[_0x400bdb(0x1ab)],'redirectUrl':_0x102fdc['failUrl']}});}catch(_0x155014){_0xd795(_0x155014);}},this[_0x55fb69(0x187)]=new testGatewayService_1[(_0x55fb69(0x195))](),this['webhookService']=new webhookService_1[(_0x55fb69(0x1c0))]();}async[a13_0x58b7f5(0x1ba)](_0x192c05,_0x11f943,_0x12a61f,_0x2fba14){const _0x4cdb49=a13_0x58b7f5,_0x3c21f9=Date[_0x4cdb49(0x174)]();try{const _0x7e6ae9=_0x192c05[_0x4cdb49(0x19b)],_0x2a7135=_0x7e6ae9[_0x4cdb49(0x185)];if(!_0x2a7135?.[_0x4cdb49(0x16f)]){console[_0x4cdb49(0x18d)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x7e6ae9['id']);return;}const _0x198e21=_0x11f943===_0x4cdb49(0x1bc)?_0x4cdb49(0x198):_0x4cdb49(0x1be);let _0x127248=[];if(_0x2a7135[_0x4cdb49(0x178)])try{_0x127248=Array[_0x4cdb49(0x189)](_0x2a7135[_0x4cdb49(0x178)])?_0x2a7135['webhookEvents']:JSON['parse'](_0x2a7135[_0x4cdb49(0x178)]);}catch(_0x774fb2){console[_0x4cdb49(0x1b3)](_0x4cdb49(0x192),_0x774fb2),_0x127248=[];}if(!_0x127248[_0x4cdb49(0x175)](_0x198e21)){console[_0x4cdb49(0x18d)](_0x4cdb49(0x16c)+_0x198e21+_0x4cdb49(0x18b)+_0x7e6ae9['id']);return;}const _0x3d9ed0={'event':_0x198e21,'payment':{'id':_0x192c05['id'],'order_id':_0x192c05[_0x4cdb49(0x164)],'gateway_order_id':_0x192c05[_0x4cdb49(0x1a2)],'gateway':_0x4cdb49(0x1ac),'amount':_0x192c05[_0x4cdb49(0x16d)],'currency':_0x192c05[_0x4cdb49(0x190)],'status':_0x11f943[_0x4cdb49(0x1a4)](),'customer_email':_0x192c05[_0x4cdb49(0x1a7)],'customer_name':_0x192c05['customerName'],'transaction_id':_0x12a61f,'failure_message':_0x2fba14,'created_at':_0x192c05[_0x4cdb49(0x177)],'updated_at':new Date()}},_0x112406=await fetch(_0x2a7135[_0x4cdb49(0x16f)],{'method':_0x4cdb49(0x1c3),'headers':{'Content-Type':_0x4cdb49(0x1c6),'User-Agent':_0x4cdb49(0x17e)},'body':JSON['stringify'](_0x3d9ed0)}),_0x1d7c5c=Date[_0x4cdb49(0x174)]()-_0x3c21f9;console[_0x4cdb49(0x18d)](_0x4cdb49(0x1aa)+_0x2a7135[_0x4cdb49(0x16f)]+'\x20with\x20status\x20'+_0x112406[_0x4cdb49(0x1c4)]+'\x20('+_0x1d7c5c+_0x4cdb49(0x1c7));}catch(_0x40c123){console[_0x4cdb49(0x1b3)](_0x4cdb49(0x163),_0x40c123);}}async[a13_0x58b7f5(0x1af)](_0x3ff1e5,_0x20265){const _0x211b2e=a13_0x58b7f5;try{const {telegramBotService:_0x372bd0}=await Promise[_0x211b2e(0x1b8)]()[_0x211b2e(0x1a6)](()=>__importStar(require(_0x211b2e(0x176)))),_0x4436bb={'PAID':_0x211b2e(0x1b4),'FAILED':_0x211b2e(0x1b6)},_0x23ddcb=_0x4436bb[_0x20265];if(!_0x23ddcb)return;await _0x372bd0[_0x211b2e(0x179)](_0x3ff1e5[_0x211b2e(0x17f)],_0x3ff1e5,_0x23ddcb);}catch(_0xf7ed24){console['error'](_0x211b2e(0x19a),_0xf7ed24);}}}exports[a13_0x58b7f5(0x199)]=TestGatewayController;