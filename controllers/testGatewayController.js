'use strict';const a13_0x502ff0=a13_0x363b;(function(_0x46ce2b,_0x133402){const _0x39112e=a13_0x363b,_0x4be2fa=_0x46ce2b();while(!![]){try{const _0x4a2cad=parseInt(_0x39112e(0x1da))/0x1*(-parseInt(_0x39112e(0x1d2))/0x2)+parseInt(_0x39112e(0x1ef))/0x3*(parseInt(_0x39112e(0x1cf))/0x4)+parseInt(_0x39112e(0x1f1))/0x5+parseInt(_0x39112e(0x1a7))/0x6+-parseInt(_0x39112e(0x1d5))/0x7*(parseInt(_0x39112e(0x1c2))/0x8)+-parseInt(_0x39112e(0x1be))/0x9*(parseInt(_0x39112e(0x1ce))/0xa)+parseInt(_0x39112e(0x1c6))/0xb;if(_0x4a2cad===_0x133402)break;else _0x4be2fa['push'](_0x4be2fa['shift']());}catch(_0x1d131f){_0x4be2fa['push'](_0x4be2fa['shift']());}}}(a13_0x2b0f,0x852b2));function a13_0x2b0f(){const _0x277209=['webhookService','stringify','\x20with\x20status\x20','3fJhOwh','test_card','143400otpbvN','body','payment.success','status','âœ…\x20Test\x20Gateway\x20payment\x20','webhookLog','__setModuleDefault','test_gateway_','payment.failed','defineProperty','transactionId','findUnique','ms)','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Webhook\x20event\x20','writable','error','Any\x20other\x20card\x20number','../services/gateways/testGatewayService','../services/webhookService','FAILED','sendPaymentStatusNotification','failed','TestGatewayService','default','isArray','Error\x20parsing\x20webhook\x20events:','resolve','WebhookService','toISOString','../services/telegramBotService','amount','paid','6034590yMyrLt','Payment\x20is\x20not\x20for\x20test\x20gateway','webhookEvents','prototype','sendShopWebhook','customerEmail','call','4242\x204242\x204242\x204242','PENDING','createdAt','configurable','TestGatewayController','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__createBinding','then','0000','POST','testGatewayService','orderId','../config/database','log','Payment\x20failed','cardNumber','3776796goCKPs','params','gatewayOrderId','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','27432fTTwgE','shopId','create','sendPaymentNotification','15646389BAiZVt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerName','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','currency','hasOwnProperty','failureMessage','PAID','20qRLCsU','893948PHMICU','name','failureReason','4vbCWBL','toLowerCase',',\x20cannot\x20process','1505dyoLOI','getPaymentForm','__esModule','Any\x20future\x20date\x20(MM/YY)','shop','279175eMESiK','webhookUrl','gatewayPaymentId','cardLast4','payment','length','\x20not\x20enabled\x20for\x20shop\x20','parse','gateway','Any\x203-4\x20digits','Payment\x20to\x20','successUrl','Payment\x20status\x20is\x20','Any\x20name','slice','Payment\x20processed\x20successfully','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','json'];a13_0x2b0f=function(){return _0x277209;};return a13_0x2b0f();}var __createBinding=this&&this[a13_0x502ff0(0x1b4)]||(Object[a13_0x502ff0(0x1c4)]?function(_0x46f9c8,_0x21cd07,_0x36407b,_0x3299d6){const _0x41a72c=a13_0x502ff0;if(_0x3299d6===undefined)_0x3299d6=_0x36407b;var _0x206103=Object['getOwnPropertyDescriptor'](_0x21cd07,_0x36407b);(!_0x206103||('get'in _0x206103?!_0x21cd07[_0x41a72c(0x1d7)]:_0x206103[_0x41a72c(0x195)]||_0x206103[_0x41a72c(0x1b1)]))&&(_0x206103={'enumerable':!![],'get':function(){return _0x21cd07[_0x36407b];}}),Object[_0x41a72c(0x18f)](_0x46f9c8,_0x3299d6,_0x206103);}:function(_0x47be09,_0x5b7d89,_0x3708a9,_0x19a4f7){if(_0x19a4f7===undefined)_0x19a4f7=_0x3708a9;_0x47be09[_0x19a4f7]=_0x5b7d89[_0x3708a9];}),__setModuleDefault=this&&this[a13_0x502ff0(0x1f7)]||(Object[a13_0x502ff0(0x1c4)]?function(_0x157c7e,_0x5ca9ea){const _0x5b084c=a13_0x502ff0;Object[_0x5b084c(0x18f)](_0x157c7e,'default',{'enumerable':!![],'value':_0x5ca9ea});}:function(_0x1a6762,_0x5bb6a3){const _0xdb62ab=a13_0x502ff0;_0x1a6762[_0xdb62ab(0x19e)]=_0x5bb6a3;}),__importStar=this&&this['__importStar']||(function(){var _0x102ffd=function(_0x44e173){return _0x102ffd=Object['getOwnPropertyNames']||function(_0x2ac767){const _0x5852b7=a13_0x363b;var _0x2d1a06=[];for(var _0x5204c1 in _0x2ac767)if(Object[_0x5852b7(0x1aa)][_0x5852b7(0x1cb)][_0x5852b7(0x1ad)](_0x2ac767,_0x5204c1))_0x2d1a06[_0x2d1a06['length']]=_0x5204c1;return _0x2d1a06;},_0x102ffd(_0x44e173);};return function(_0x3a3890){const _0x58466f=a13_0x363b;if(_0x3a3890&&_0x3a3890[_0x58466f(0x1d7)])return _0x3a3890;var _0xcd2d97={};if(_0x3a3890!=null){for(var _0x216c35=_0x102ffd(_0x3a3890),_0x135379=0x0;_0x135379<_0x216c35[_0x58466f(0x1df)];_0x135379++)if(_0x216c35[_0x135379]!==_0x58466f(0x19e))__createBinding(_0xcd2d97,_0x3a3890,_0x216c35[_0x135379]);}return __setModuleDefault(_0xcd2d97,_0x3a3890),_0xcd2d97;};}()),__importDefault=this&&this['__importDefault']||function(_0x123c23){const _0x5d2869=a13_0x502ff0;return _0x123c23&&_0x123c23[_0x5d2869(0x1d7)]?_0x123c23:{'default':_0x123c23};};Object[a13_0x502ff0(0x18f)](exports,a13_0x502ff0(0x1d7),{'value':!![]}),exports[a13_0x502ff0(0x1b2)]=void 0x0;const testGatewayService_1=require(a13_0x502ff0(0x198)),webhookService_1=require(a13_0x502ff0(0x199)),database_1=__importDefault(require(a13_0x502ff0(0x1ba)));class TestGatewayController{constructor(){const _0x1c40e2=a13_0x502ff0;this[_0x1c40e2(0x1d6)]=async(_0x2b097e,_0x177d23,_0xecbb19)=>{const _0xaf7932=_0x1c40e2;try{const {paymentId:_0x4cd7bb}=_0x2b097e[_0xaf7932(0x1bf)];console['log'](_0xaf7932(0x1c9)+_0x4cd7bb);const _0x1627ff=await database_1[_0xaf7932(0x19e)]['payment']['findUnique']({'where':{'id':_0x4cd7bb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1627ff)return _0x177d23[_0xaf7932(0x1f4)](0x194)[_0xaf7932(0x1eb)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1627ff[_0xaf7932(0x1e2)]!=='test_gateway')return _0x177d23[_0xaf7932(0x1f4)](0x190)['json']({'success':![],'message':_0xaf7932(0x1a8)});if(_0x1627ff[_0xaf7932(0x1f4)]!=='PENDING')return _0x177d23['status'](0x190)[_0xaf7932(0x1eb)]({'success':![],'message':_0xaf7932(0x1e6)+_0x1627ff['status']+_0xaf7932(0x1d4)});_0x177d23['json']({'success':!![],'result':{'paymentId':_0x1627ff['id'],'orderId':_0x1627ff[_0xaf7932(0x1c0)],'amount':_0x1627ff[_0xaf7932(0x1a5)],'currency':_0x1627ff['currency'],'merchantName':_0x1627ff['shop'][_0xaf7932(0x1d0)],'description':_0xaf7932(0x1e4)+_0x1627ff['shop'][_0xaf7932(0x1d0)],'testInstructions':{'successCard':_0xaf7932(0x1ae),'failureCard':_0xaf7932(0x197),'expiryDate':_0xaf7932(0x1d8),'cvc':_0xaf7932(0x1e3),'holderName':_0xaf7932(0x1e7)}}});}catch(_0x103009){_0xecbb19(_0x103009);}},this['processCard']=async(_0x2c9780,_0x18f3df,_0x3cd955)=>{const _0x5acfc8=_0x1c40e2;try{const {paymentId:_0x11aaa8}=_0x2c9780[_0x5acfc8(0x1bf)],_0x226f7c=_0x2c9780[_0x5acfc8(0x1f2)];console['log'](_0x5acfc8(0x1ea)+_0x11aaa8);const _0x451217=await database_1[_0x5acfc8(0x19e)][_0x5acfc8(0x1de)][_0x5acfc8(0x191)]({'where':{'id':_0x11aaa8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x451217)return _0x18f3df[_0x5acfc8(0x1f4)](0x194)[_0x5acfc8(0x1eb)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x451217[_0x5acfc8(0x1e2)]!=='test_gateway')return _0x18f3df[_0x5acfc8(0x1f4)](0x190)[_0x5acfc8(0x1eb)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x451217[_0x5acfc8(0x1f4)]!==_0x5acfc8(0x1af))return _0x18f3df[_0x5acfc8(0x1f4)](0x190)[_0x5acfc8(0x1eb)]({'success':![],'message':_0x5acfc8(0x1e6)+_0x451217[_0x5acfc8(0x1f4)]+_0x5acfc8(0x1d4)});const _0x526f0b=await this[_0x5acfc8(0x1b8)]['processCardPayment']({'paymentId':_0x451217['id'],'orderId':_0x451217[_0x5acfc8(0x1c0)]||_0x451217['id'],'amount':_0x451217[_0x5acfc8(0x1a5)],'currency':_0x451217[_0x5acfc8(0x1ca)],'cardData':_0x226f7c});console[_0x5acfc8(0x1bb)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x526f0b);const _0x169987={'status':_0x526f0b[_0x5acfc8(0x1f4)],'updatedAt':new Date()};if(_0x526f0b[_0x5acfc8(0x1f4)]===_0x5acfc8(0x1cd))_0x169987['paidAt']=new Date(),_0x169987[_0x5acfc8(0x1dc)]=_0x526f0b['transactionId'];else _0x526f0b['status']===_0x5acfc8(0x19a)&&(_0x169987[_0x5acfc8(0x1cc)]=_0x526f0b[_0x5acfc8(0x1d1)]);const _0x4c53c6=_0x226f7c[_0x5acfc8(0x1bd)]['replace'](/[\s-]/g,'');_0x169987[_0x5acfc8(0x1dd)]=_0x4c53c6[_0x5acfc8(0x1e8)](-0x4),_0x169987['paymentMethod']=_0x5acfc8(0x1f0),await database_1[_0x5acfc8(0x19e)][_0x5acfc8(0x1de)]['update']({'where':{'id':_0x451217['id']},'data':_0x169987}),await database_1[_0x5acfc8(0x19e)][_0x5acfc8(0x1f6)][_0x5acfc8(0x1c4)]({'data':{'paymentId':_0x451217['id'],'shopId':_0x451217[_0x5acfc8(0x1c3)],'event':_0x5acfc8(0x1f8)+_0x526f0b[_0x5acfc8(0x1f4)][_0x5acfc8(0x1d3)](),'statusCode':0xc8,'responseBody':JSON[_0x5acfc8(0x1ed)]({'oldStatus':_0x5acfc8(0x1af),'newStatus':_0x526f0b[_0x5acfc8(0x1f4)],'transactionId':_0x526f0b[_0x5acfc8(0x190)],'failureReason':_0x526f0b[_0x5acfc8(0x1d1)],'processedAt':new Date()[_0x5acfc8(0x1a3)]()})}}),await this[_0x5acfc8(0x1ab)](_0x451217,_0x526f0b['status'],_0x526f0b[_0x5acfc8(0x190)],_0x526f0b[_0x5acfc8(0x1d1)]),await this[_0x5acfc8(0x19b)](_0x451217,_0x526f0b[_0x5acfc8(0x1f4)]),console['log'](_0x5acfc8(0x1f5)+_0x11aaa8+'\x20processed:\x20'+_0x526f0b[_0x5acfc8(0x1f4)]),_0x526f0b[_0x5acfc8(0x1f4)]===_0x5acfc8(0x1cd)?_0x18f3df[_0x5acfc8(0x1eb)]({'success':!![],'message':_0x5acfc8(0x1e9),'result':{'status':'PAID','transactionId':_0x526f0b['transactionId'],'redirectUrl':_0x451217[_0x5acfc8(0x1e5)]}}):_0x18f3df[_0x5acfc8(0x1f4)](0x190)['json']({'success':![],'message':_0x5acfc8(0x1bc),'result':{'status':'FAILED','failureReason':_0x526f0b[_0x5acfc8(0x1d1)],'redirectUrl':_0x451217['failUrl']}});}catch(_0x50f7cc){_0x3cd955(_0x50f7cc);}},this[_0x1c40e2(0x1b8)]=new testGatewayService_1[(_0x1c40e2(0x19d))](),this[_0x1c40e2(0x1ec)]=new webhookService_1[(_0x1c40e2(0x1a2))]();}async[a13_0x502ff0(0x1ab)](_0x3690ed,_0x1187ce,_0x2b82f4,_0x19a25b){const _0x1cc377=a13_0x502ff0,_0x1440b4=Date['now']();try{const _0x470b38=_0x3690ed[_0x1cc377(0x1d9)],_0x32acc2=_0x470b38['settings'];if(!_0x32acc2?.[_0x1cc377(0x1db)]){console[_0x1cc377(0x1bb)](_0x1cc377(0x1c7)+_0x470b38['id']);return;}const _0x599698=_0x1187ce==='PAID'?_0x1cc377(0x1f3):_0x1cc377(0x18e);let _0x3736d6=[];if(_0x32acc2[_0x1cc377(0x1a9)])try{_0x3736d6=Array[_0x1cc377(0x19f)](_0x32acc2['webhookEvents'])?_0x32acc2['webhookEvents']:JSON[_0x1cc377(0x1e1)](_0x32acc2[_0x1cc377(0x1a9)]);}catch(_0x5e5035){console['error'](_0x1cc377(0x1a0),_0x5e5035),_0x3736d6=[];}if(!_0x3736d6['includes'](_0x599698)){console[_0x1cc377(0x1bb)](_0x1cc377(0x194)+_0x599698+_0x1cc377(0x1e0)+_0x470b38['id']);return;}const _0x4e433e={'event':_0x599698,'payment':{'id':_0x3690ed['id'],'order_id':_0x3690ed[_0x1cc377(0x1b9)],'gateway_order_id':_0x3690ed[_0x1cc377(0x1c0)],'gateway':_0x1cc377(0x1b6),'amount':_0x3690ed[_0x1cc377(0x1a5)],'currency':_0x3690ed[_0x1cc377(0x1ca)],'status':_0x1187ce[_0x1cc377(0x1d3)](),'customer_email':_0x3690ed[_0x1cc377(0x1ac)],'customer_name':_0x3690ed[_0x1cc377(0x1c8)],'transaction_id':_0x2b82f4,'failure_message':_0x19a25b,'created_at':_0x3690ed[_0x1cc377(0x1b0)],'updated_at':new Date()}},_0x4544af=await fetch(_0x32acc2[_0x1cc377(0x1db)],{'method':_0x1cc377(0x1b7),'headers':{'Content-Type':'application/json','User-Agent':_0x1cc377(0x1c1)},'body':JSON[_0x1cc377(0x1ed)](_0x4e433e)}),_0x355c69=Date['now']()-_0x1440b4;console['log'](_0x1cc377(0x1b3)+_0x32acc2[_0x1cc377(0x1db)]+_0x1cc377(0x1ee)+_0x4544af[_0x1cc377(0x1f4)]+'\x20('+_0x355c69+_0x1cc377(0x192));}catch(_0x3be72a){console['error'](_0x1cc377(0x193),_0x3be72a);}}async[a13_0x502ff0(0x19b)](_0x42289b,_0x5f1b0d){const _0x2ad5c4=a13_0x502ff0;try{const {telegramBotService:_0x4f5155}=await Promise[_0x2ad5c4(0x1a1)]()[_0x2ad5c4(0x1b5)](()=>__importStar(require(_0x2ad5c4(0x1a4)))),_0x4dc2a4={'PAID':_0x2ad5c4(0x1a6),'FAILED':_0x2ad5c4(0x19c)},_0x57e16c=_0x4dc2a4[_0x5f1b0d];if(!_0x57e16c)return;await _0x4f5155[_0x2ad5c4(0x1c5)](_0x42289b['shopId'],_0x42289b,_0x57e16c);}catch(_0x12f66a){console[_0x2ad5c4(0x196)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x12f66a);}}}function a13_0x363b(_0x9c961f,_0x79146e){const _0x2b0fb0=a13_0x2b0f();return a13_0x363b=function(_0x363bc0,_0x5a1bad){_0x363bc0=_0x363bc0-0x18e;let _0x517543=_0x2b0fb0[_0x363bc0];return _0x517543;},a13_0x363b(_0x9c961f,_0x79146e);}exports['TestGatewayController']=TestGatewayController;