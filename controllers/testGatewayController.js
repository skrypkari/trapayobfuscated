'use strict';const a21_0x530559=a21_0x32bd;(function(_0x1db54d,_0x1e37a1){const _0x5dad27=a21_0x32bd,_0x456407=_0x1db54d();while(!![]){try{const _0xe86b93=parseInt(_0x5dad27(0xdc))/0x1*(-parseInt(_0x5dad27(0x7a))/0x2)+parseInt(_0x5dad27(0xd3))/0x3+parseInt(_0x5dad27(0xe5))/0x4+parseInt(_0x5dad27(0x90))/0x5+-parseInt(_0x5dad27(0x9f))/0x6+parseInt(_0x5dad27(0x87))/0x7+-parseInt(_0x5dad27(0xf4))/0x8;if(_0xe86b93===_0x1e37a1)break;else _0x456407['push'](_0x456407['shift']());}catch(_0x3290f9){_0x456407['push'](_0x456407['shift']());}}}(a21_0x3dc2,0xecfc8));var __createBinding=this&&this[a21_0x530559(0xb8)]||(Object[a21_0x530559(0x7d)]?function(_0x83777e,_0x1b2d3a,_0x10ccb7,_0x204c66){const _0x4e123d=a21_0x530559;if(_0x204c66===undefined)_0x204c66=_0x10ccb7;var _0xabb7b0=Object[_0x4e123d(0xcf)](_0x1b2d3a,_0x10ccb7);(!_0xabb7b0||(_0x4e123d(0x81)in _0xabb7b0?!_0x1b2d3a[_0x4e123d(0x8e)]:_0xabb7b0[_0x4e123d(0xe7)]||_0xabb7b0[_0x4e123d(0xcd)]))&&(_0xabb7b0={'enumerable':!![],'get':function(){return _0x1b2d3a[_0x10ccb7];}}),Object[_0x4e123d(0xa7)](_0x83777e,_0x204c66,_0xabb7b0);}:function(_0x4d9ac8,_0x4f5e4e,_0x5c3a67,_0x471a47){if(_0x471a47===undefined)_0x471a47=_0x5c3a67;_0x4d9ac8[_0x471a47]=_0x4f5e4e[_0x5c3a67];}),__setModuleDefault=this&&this[a21_0x530559(0xd6)]||(Object[a21_0x530559(0x7d)]?function(_0x28e5dd,_0x8c4e58){const _0x2e2410=a21_0x530559;Object[_0x2e2410(0xa7)](_0x28e5dd,_0x2e2410(0x83),{'enumerable':!![],'value':_0x8c4e58});}:function(_0x5b5aab,_0x2201fa){const _0x3bcb62=a21_0x530559;_0x5b5aab[_0x3bcb62(0x83)]=_0x2201fa;}),__importStar=this&&this[a21_0x530559(0x73)]||(function(){var _0x37e169=function(_0x4fbea2){const _0x2d8359=a21_0x32bd;return _0x37e169=Object[_0x2d8359(0x89)]||function(_0x589c20){const _0x209d35=_0x2d8359;var _0xd53b1=[];for(var _0xbdcc9f in _0x589c20)if(Object['prototype'][_0x209d35(0xbd)][_0x209d35(0x80)](_0x589c20,_0xbdcc9f))_0xd53b1[_0xd53b1[_0x209d35(0xc9)]]=_0xbdcc9f;return _0xd53b1;},_0x37e169(_0x4fbea2);};return function(_0x603721){const _0x46b4d7=a21_0x32bd;if(_0x603721&&_0x603721[_0x46b4d7(0x8e)])return _0x603721;var _0x2fe70a={};if(_0x603721!=null){for(var _0xde7a5d=_0x37e169(_0x603721),_0x36f95d=0x0;_0x36f95d<_0xde7a5d[_0x46b4d7(0xc9)];_0x36f95d++)if(_0xde7a5d[_0x36f95d]!==_0x46b4d7(0x83))__createBinding(_0x2fe70a,_0x603721,_0xde7a5d[_0x36f95d]);}return __setModuleDefault(_0x2fe70a,_0x603721),_0x2fe70a;};}()),__importDefault=this&&this[a21_0x530559(0xed)]||function(_0x37a602){const _0x5341e2=a21_0x530559;return _0x37a602&&_0x37a602[_0x5341e2(0x8e)]?_0x37a602:{'default':_0x37a602};};Object['defineProperty'](exports,a21_0x530559(0x8e),{'value':!![]}),exports['TestGatewayController']=void 0x0;const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require(a21_0x530559(0x8c)),webhookService_1=require(a21_0x530559(0xc7)),database_1=__importDefault(require(a21_0x530559(0xa9)));class TestGatewayController{constructor(){const _0x3e79ad=a21_0x530559;this[_0x3e79ad(0xb5)]=async(_0x2124d4,_0x1db568,_0x2c0497)=>{const _0x254273=_0x3e79ad;try{const {paymentId:_0x58736e}=_0x2124d4[_0x254273(0x95)];console[_0x254273(0xb7)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x58736e);const _0x4c6b16=await database_1[_0x254273(0x83)][_0x254273(0xe4)][_0x254273(0xd5)]({'where':{'id':_0x58736e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4c6b16)return _0x1db568[_0x254273(0xb6)](0x194)[_0x254273(0xf2)]({'success':![],'message':_0x254273(0x9d)});if(_0x4c6b16[_0x254273(0xab)]!==_0x254273(0xd8))return _0x1db568[_0x254273(0xb6)](0x190)[_0x254273(0xf2)]({'success':![],'message':_0x254273(0x71)});if(_0x4c6b16[_0x254273(0xb6)]!==_0x254273(0xd4))return _0x1db568[_0x254273(0xb6)](0x190)['json']({'success':![],'message':_0x254273(0xe9)+_0x4c6b16[_0x254273(0xb6)]+',\x20cannot\x20process'});_0x1db568[_0x254273(0xf2)]({'success':!![],'result':{'paymentId':_0x4c6b16['id'],'orderId':_0x4c6b16[_0x254273(0xb9)],'amount':_0x4c6b16['amount'],'currency':_0x4c6b16['currency'],'merchantName':_0x4c6b16[_0x254273(0xeb)][_0x254273(0xf5)],'description':_0x254273(0xae)+_0x4c6b16[_0x254273(0xeb)][_0x254273(0xf5)],'testInstructions':{'successCard':_0x254273(0xa2),'failureCard':_0x254273(0xde),'expiryDate':_0x254273(0xa6),'cvc':_0x254273(0x88),'holderName':_0x254273(0x76)}}});}catch(_0x870bbe){_0x2c0497(_0x870bbe);}},this[_0x3e79ad(0x94)]=async(_0x2811bf,_0x4342e0,_0x33d4de)=>{const _0x328cd5=_0x3e79ad;try{const {paymentId:_0x3bcb64}=_0x2811bf[_0x328cd5(0x95)],_0x598e60=_0x2811bf[_0x328cd5(0xe6)];console[_0x328cd5(0xb7)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3bcb64);const _0x2607af=await database_1[_0x328cd5(0x83)][_0x328cd5(0xe4)][_0x328cd5(0xd5)]({'where':{'id':_0x3bcb64},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2607af)return _0x4342e0[_0x328cd5(0xb6)](0x194)[_0x328cd5(0xf2)]({'success':![],'message':_0x328cd5(0x9d)});if(_0x2607af[_0x328cd5(0xab)]!==_0x328cd5(0xd8))return _0x4342e0['status'](0x190)[_0x328cd5(0xf2)]({'success':![],'message':_0x328cd5(0x71)});if(_0x2607af[_0x328cd5(0xb6)]!==_0x328cd5(0xd4))return _0x4342e0[_0x328cd5(0xb6)](0x190)[_0x328cd5(0xf2)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2607af[_0x328cd5(0xb6)]+_0x328cd5(0xb3)});const _0xba5ef9=await this[_0x328cd5(0x82)][_0x328cd5(0xcc)]({'paymentId':_0x2607af['id'],'orderId':_0x2607af[_0x328cd5(0xb9)]||_0x2607af['id'],'amount':_0x2607af[_0x328cd5(0x8a)],'currency':_0x2607af[_0x328cd5(0xf0)],'cardData':_0x598e60});console[_0x328cd5(0xb7)](_0x328cd5(0xbf),_0xba5ef9);const _0x48dd56={'status':_0xba5ef9[_0x328cd5(0xb6)],'updatedAt':new Date()};if(_0xba5ef9['status']===_0x328cd5(0xc1))_0x48dd56['paidAt']=new Date(),_0x48dd56[_0x328cd5(0x91)]=_0xba5ef9[_0x328cd5(0xd9)];else _0xba5ef9['status']===_0x328cd5(0xa4)&&(_0x48dd56[_0x328cd5(0x6f)]=_0xba5ef9['failureReason']);const _0x1dc064=_0x598e60[_0x328cd5(0x9c)][_0x328cd5(0x8f)](/[\s-]/g,'');_0x48dd56['cardLast4']=_0x1dc064[_0x328cd5(0x8b)](-0x4),_0x48dd56['paymentMethod']=_0x328cd5(0xc5),await database_1['default'][_0x328cd5(0xe4)]['update']({'where':{'id':_0x2607af['id']},'data':_0x48dd56});if(_0xba5ef9[_0x328cd5(0xb6)]===_0x328cd5(0xc1)&&_0x2607af[_0x328cd5(0xb4)]){console[_0x328cd5(0xb7)](_0x328cd5(0xcb)+_0x2607af['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x328cd5(0x8d)](async _0x424eb3=>{const _0x521e6e=_0x328cd5,_0x4df2e8=await _0x424eb3['paymentLink'][_0x521e6e(0xd5)]({'where':{'id':_0x2607af[_0x521e6e(0xb4)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4df2e8){console[_0x521e6e(0xb7)](_0x521e6e(0x99)+_0x4df2e8['id']+_0x521e6e(0xa5)+_0x4df2e8[_0x521e6e(0xd0)]+_0x521e6e(0xb2)+_0x4df2e8[_0x521e6e(0xe3)]+_0x521e6e(0xf3)+_0x4df2e8[_0x521e6e(0xb6)]);const _0x5b63a7=_0x4df2e8[_0x521e6e(0xe3)]+0x1,_0x252e48=_0x4df2e8[_0x521e6e(0xd0)]===_0x521e6e(0xa1)?_0x521e6e(0xee):_0x4df2e8['status'];await _0x424eb3['paymentLink'][_0x521e6e(0xf6)]({'where':{'id':_0x2607af[_0x521e6e(0xb4)]},'data':{'currentPayments':_0x5b63a7,'status':_0x252e48,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x4df2e8['id']+_0x521e6e(0x93)+_0x4df2e8[_0x521e6e(0xe3)]+_0x521e6e(0xca)+_0x5b63a7+',\x20status='+_0x4df2e8[_0x521e6e(0xb6)]+_0x521e6e(0xca)+_0x252e48);}else console[_0x521e6e(0xb7)](_0x521e6e(0xaf)+_0x2607af[_0x521e6e(0xb4)]+_0x521e6e(0x78));});}catch(_0x1a2206){console[_0x328cd5(0x9e)](_0x328cd5(0xea),_0x1a2206);}}await database_1[_0x328cd5(0x83)]['webhookLog'][_0x328cd5(0x7d)]({'data':{'paymentId':_0x2607af['id'],'shopId':_0x2607af[_0x328cd5(0xc6)],'event':_0x328cd5(0x75)+_0xba5ef9[_0x328cd5(0xb6)][_0x328cd5(0xe0)](),'statusCode':_0xba5ef9[_0x328cd5(0xb6)]===_0x328cd5(0xc1)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':_0x328cd5(0xd4),'newStatus':_0xba5ef9['status'],'transactionId':_0xba5ef9['transactionId'],'failureReason':_0xba5ef9['failureReason'],'processedAt':new Date()[_0x328cd5(0x84)]()})}}),console[_0x328cd5(0xb7)](_0x328cd5(0xc2)+_0xba5ef9['status']+_0x328cd5(0xbe)),await this[_0x328cd5(0xef)](_0x2607af,_0xba5ef9[_0x328cd5(0xb6)],_0xba5ef9[_0x328cd5(0xd9)],_0xba5ef9['failureReason']),console[_0x328cd5(0xb7)](_0x328cd5(0x7b)+_0xba5ef9['status']),console['log'](_0x328cd5(0xc0)+_0xba5ef9[_0x328cd5(0xb6)]+'...'),await this[_0x328cd5(0xba)](_0x2607af,_0xba5ef9[_0x328cd5(0xb6)]),console[_0x328cd5(0xb7)](_0x328cd5(0x92)+_0xba5ef9['status']),console[_0x328cd5(0xb7)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x3bcb64+_0x328cd5(0xdf)+_0xba5ef9[_0x328cd5(0xb6)]),_0xba5ef9[_0x328cd5(0xb6)]===_0x328cd5(0xc1)?_0x4342e0['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0xba5ef9[_0x328cd5(0xd9)],'redirectUrl':_0x2607af[_0x328cd5(0x70)]}}):_0x4342e0[_0x328cd5(0xb6)](0x190)[_0x328cd5(0xf2)]({'success':![],'message':_0x328cd5(0x7c),'result':{'status':_0x328cd5(0xa4),'failureReason':_0xba5ef9['failureReason'],'redirectUrl':_0x2607af[_0x328cd5(0xf1)]}});}catch(_0x221fca){_0x33d4de(_0x221fca);}},this[_0x3e79ad(0x82)]=new testGatewayService_1[(_0x3e79ad(0xd7))](),this[_0x3e79ad(0xce)]=new webhookService_1[(_0x3e79ad(0x9b))]();}async[a21_0x530559(0xef)](_0xe72288,_0x2c9a22,_0x238dce,_0x4bb878){const _0x3eb687=a21_0x530559,_0x41c36e=Date[_0x3eb687(0xa3)]();try{const _0x7b3875=_0xe72288[_0x3eb687(0xeb)],_0x47fe27=_0x7b3875['settings'];if(!_0x47fe27?.[_0x3eb687(0xa8)]){console[_0x3eb687(0xb7)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x7b3875['id']);return;}const _0x372618=_0x2c9a22===_0x3eb687(0xc1)?_0x3eb687(0xe1):_0x3eb687(0x98);console['log'](_0x3eb687(0x96)+_0x372618+_0x3eb687(0x77)+(_0x47fe27[_0x3eb687(0xa8)]?'configured':_0x3eb687(0x7f)));let _0x329961=[];if(_0x47fe27[_0x3eb687(0xc8)])try{_0x329961=Array[_0x3eb687(0xd2)](_0x47fe27['webhookEvents'])?_0x47fe27[_0x3eb687(0xc8)]:JSON[_0x3eb687(0xa0)](_0x47fe27[_0x3eb687(0xc8)]);}catch(_0x32b197){console[_0x3eb687(0x9e)](_0x3eb687(0x74),_0x32b197),_0x329961=[];}console[_0x3eb687(0xb7)](_0x3eb687(0xad),_0x329961);if(!_0x329961['includes'](_0x372618)){console['log']('‚ö†Ô∏è\x20Webhook\x20event\x20'+_0x372618+_0x3eb687(0x79)+_0x7b3875['id']);return;}const _0x330f97={'event':_0x372618,'payment':{'id':_0xe72288['id'],'order_id':_0xe72288[_0x3eb687(0x9a)],'gateway_order_id':_0xe72288[_0x3eb687(0xb9)],'gateway':_0x3eb687(0xc3),'amount':_0xe72288[_0x3eb687(0x8a)],'currency':_0xe72288[_0x3eb687(0xf0)],'status':_0x2c9a22[_0x3eb687(0xe0)](),'customer_email':_0xe72288[_0x3eb687(0xaa)],'customer_name':_0xe72288[_0x3eb687(0xec)],'transaction_id':_0x238dce,'failure_message':_0x4bb878,'created_at':_0xe72288[_0x3eb687(0xb1)],'updated_at':new Date()}};console[_0x3eb687(0xb7)]('üß™\x20Sending\x20webhook\x20to\x20'+_0x47fe27['webhookUrl']+_0x3eb687(0xbe)),console['log'](_0x3eb687(0xd1),JSON['stringify'](_0x330f97,null,0x2));const _0x28d7bb=JSON[_0x3eb687(0xe8)](_0x330f97),_0x518ce1=crypto_1[_0x3eb687(0x83)][_0x3eb687(0xbb)](_0x3eb687(0x86),_0x7b3875[_0x3eb687(0x72)])[_0x3eb687(0xf6)](_0x28d7bb)['digest'](_0x3eb687(0x97)),_0x364565=await fetch(_0x47fe27[_0x3eb687(0xa8)],{'method':_0x3eb687(0xbc),'headers':{'Content-Type':_0x3eb687(0x85),'User-Agent':_0x3eb687(0xb0),'X-Webhook-Signature':_0x518ce1},'body':_0x28d7bb}),_0x3ea16f=Date['now']()-_0x41c36e;console[_0x3eb687(0xb7)]('‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x47fe27['webhookUrl']+_0x3eb687(0xdb)+_0x364565[_0x3eb687(0xb6)]+'\x20('+_0x3ea16f+'ms)');}catch(_0x5c02e1){console[_0x3eb687(0x9e)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x5c02e1);}}async[a21_0x530559(0xba)](_0x4fed15,_0x23621e){const _0x4fb61c=a21_0x530559;try{const {telegramBotService:_0x5932c2}=await Promise[_0x4fb61c(0xda)]()[_0x4fb61c(0xc4)](()=>__importStar(require('../services/telegramBotService'))),_0x4fcb2d={'PAID':_0x4fb61c(0xac),'FAILED':'failed'},_0x1cbf8b=_0x4fcb2d[_0x23621e];if(!_0x1cbf8b)return;await _0x5932c2[_0x4fb61c(0xe2)](_0x4fed15[_0x4fb61c(0xc6)],_0x4fed15,_0x1cbf8b);}catch(_0x373735){console[_0x4fb61c(0x9e)](_0x4fb61c(0x7e),_0x373735);}}}function a21_0x32bd(_0xf1b7c8,_0x4b95dd){_0xf1b7c8=_0xf1b7c8-0x6f;const _0x3dc2c6=a21_0x3dc2();let _0x32bd24=_0x3dc2c6[_0xf1b7c8];return _0x32bd24;}function a21_0x3dc2(){const _0x5c2ce3=['secretKey','__importStar','Error\x20parsing\x20webhook\x20events:','test_gateway_','Any\x20name',',\x20webhookUrl=','\x20not\x20found','\x20not\x20enabled\x20for\x20shop\x20','2pHmjmP','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','Payment\x20failed','create','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','not\x20configured','call','get','testGatewayService','default','toISOString','application/json','sha256','8473283cWkZVT','Any\x203-4\x20digits','getOwnPropertyNames','amount','slice','../services/gateways/testGatewayService','$transaction','__esModule','replace','1229845Axgffk','gatewayPaymentId','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','\x20updated:\x20currentPayments=','processCard','params','üß™\x20Test\x20Gateway\x20webhook:\x20event=','hex','payment.failed','üìà\x20Found\x20payment\x20link\x20','orderId','WebhookService','cardNumber','Payment\x20not\x20found','error','5600988EIPTYl','parse','SINGLE','4242\x204242\x204242\x204242','now','FAILED',':\x20type=','Any\x20future\x20date\x20(MM/YY)','defineProperty','webhookUrl','../config/database','customerEmail','gateway','paid','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','Payment\x20to\x20','‚ùå\x20Payment\x20link\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','createdAt',',\x20currentPayments=',',\x20cannot\x20process','paymentLinkId','getPaymentForm','status','log','__createBinding','gatewayOrderId','sendPaymentStatusNotification','createHmac','POST','hasOwnProperty','...','üß™\x20Test\x20Gateway\x20result:','üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','PAID','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','0000','then','test_card','shopId','../services/webhookService','webhookEvents','length','\x20->\x20','üìà\x20Test\x20Gateway:\x20Payment\x20','processCardPayment','configurable','webhookService','getOwnPropertyDescriptor','type','üß™\x20Webhook\x20payload:','isArray','4195419vlbrzW','PENDING','findUnique','__setModuleDefault','TestGatewayService','test_gateway','transactionId','resolve','\x20with\x20status\x20','394993KynDSW','TestGatewayController','Any\x20other\x20card\x20number','\x20processed:\x20','toLowerCase','payment.success','sendPaymentNotification','currentPayments','payment','5610912beBGbY','body','writable','stringify','Payment\x20status\x20is\x20','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','shop','customerName','__importDefault','COMPLETED','sendShopWebhook','currency','failUrl','json',',\x20status=','15667616XvYBnH','name','update','failureMessage','successUrl','Payment\x20is\x20not\x20for\x20test\x20gateway'];a21_0x3dc2=function(){return _0x5c2ce3;};return a21_0x3dc2();}exports[a21_0x530559(0xdd)]=TestGatewayController;