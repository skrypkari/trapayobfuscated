'use strict';const a13_0x55b35b=a13_0x4577;(function(_0x19d542,_0x37aedb){const _0x3338f3=a13_0x4577,_0x4ccd24=_0x19d542();while(!![]){try{const _0x4f9000=parseInt(_0x3338f3(0x15f))/0x1+parseInt(_0x3338f3(0x194))/0x2+parseInt(_0x3338f3(0x158))/0x3*(parseInt(_0x3338f3(0x17d))/0x4)+-parseInt(_0x3338f3(0x148))/0x5+parseInt(_0x3338f3(0x164))/0x6+-parseInt(_0x3338f3(0x175))/0x7+-parseInt(_0x3338f3(0x185))/0x8*(parseInt(_0x3338f3(0x16b))/0x9);if(_0x4f9000===_0x37aedb)break;else _0x4ccd24['push'](_0x4ccd24['shift']());}catch(_0x1887a6){_0x4ccd24['push'](_0x4ccd24['shift']());}}}(a13_0x139f,0xb7bb4));function a13_0x4577(_0x234393,_0x4366b2){const _0x139faf=a13_0x139f();return a13_0x4577=function(_0x457758,_0x3e00ee){_0x457758=_0x457758-0x13b;let _0x9b5111=_0x139faf[_0x457758];return _0x9b5111;},a13_0x4577(_0x234393,_0x4366b2);}function a13_0x139f(){const _0x455606=['2283560WtVeRy','__esModule','test_gateway_','stringify','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20status\x20is\x20','Any\x20future\x20date\x20(MM/YY)','test_card','sendShopWebhook',',\x20cannot\x20process','prototype','create','paidAt','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','parse','FAILED','Test\x20Gateway\x20webhook\x20sent\x20to\x20','createdAt','hasOwnProperty','defineProperty','getOwnPropertyNames','failureMessage','WebhookService','orderId','slice','log','5963095gBcfxD','\x20processed:\x20','now','shopId','TestGatewayController','findUnique','paymentMethod','length','payment.success','get','webhookUrl','writable','Payment\x20is\x20not\x20for\x20test\x20gateway','__setModuleDefault','gatewayOrderId','payment','6189oHlvqy','default','customerEmail','replace','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20with\x20status\x20','Payment\x20processed\x20successfully','1279225wnpzQG','paid','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','configurable','Payment\x20not\x20found','5353038TviLut','successUrl','POST','webhookLog','currency','transactionId','webhookService','4040361mFeMwM','processCardPayment','failed','ms)','Any\x20other\x20card\x20number','TestGatewayService','getOwnPropertyDescriptor','payment.failed','PENDING','__createBinding','982863cbqTjS','then','shop','status','toLowerCase','settings','Payment\x20failed','amount','1972WcWOzT','name','test_gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Any\x20name','4242\x204242\x204242\x204242','customerName','testGatewayService','40wcPIEa','update','processCard','cardLast4','PAID','Error\x20parsing\x20webhook\x20events:','../config/database','../services/gateways/testGatewayService','resolve','getPaymentForm','failureReason','json','error','params','webhookEvents'];a13_0x139f=function(){return _0x455606;};return a13_0x139f();}var __createBinding=this&&this[a13_0x55b35b(0x174)]||(Object[a13_0x55b35b(0x19f)]?function(_0x598228,_0x181250,_0x467e81,_0x5a2c98){const _0x1cfa58=a13_0x55b35b;if(_0x5a2c98===undefined)_0x5a2c98=_0x467e81;var _0x8fcf08=Object[_0x1cfa58(0x171)](_0x181250,_0x467e81);(!_0x8fcf08||(_0x1cfa58(0x151)in _0x8fcf08?!_0x181250[_0x1cfa58(0x195)]:_0x8fcf08[_0x1cfa58(0x153)]||_0x8fcf08[_0x1cfa58(0x162)]))&&(_0x8fcf08={'enumerable':!![],'get':function(){return _0x181250[_0x467e81];}}),Object[_0x1cfa58(0x141)](_0x598228,_0x5a2c98,_0x8fcf08);}:function(_0x517adf,_0x3ec4be,_0x3ab807,_0x3802df){if(_0x3802df===undefined)_0x3802df=_0x3ab807;_0x517adf[_0x3802df]=_0x3ec4be[_0x3ab807];}),__setModuleDefault=this&&this[a13_0x55b35b(0x155)]||(Object['create']?function(_0x920ff2,_0x36e7cd){const _0x11054a=a13_0x55b35b;Object[_0x11054a(0x141)](_0x920ff2,_0x11054a(0x159),{'enumerable':!![],'value':_0x36e7cd});}:function(_0x7b565c,_0x117fe0){_0x7b565c['default']=_0x117fe0;}),__importStar=this&&this['__importStar']||(function(){var _0x54c40c=function(_0x191bcd){const _0x241814=a13_0x4577;return _0x54c40c=Object[_0x241814(0x142)]||function(_0x20ade3){const _0x3967f3=_0x241814;var _0x557a58=[];for(var _0x2bf2cb in _0x20ade3)if(Object[_0x3967f3(0x19e)][_0x3967f3(0x140)]['call'](_0x20ade3,_0x2bf2cb))_0x557a58[_0x557a58[_0x3967f3(0x14f)]]=_0x2bf2cb;return _0x557a58;},_0x54c40c(_0x191bcd);};return function(_0x390d23){const _0x24c15c=a13_0x4577;if(_0x390d23&&_0x390d23['__esModule'])return _0x390d23;var _0x4b4f1f={};if(_0x390d23!=null){for(var _0x49909a=_0x54c40c(_0x390d23),_0xb8783c=0x0;_0xb8783c<_0x49909a[_0x24c15c(0x14f)];_0xb8783c++)if(_0x49909a[_0xb8783c]!==_0x24c15c(0x159))__createBinding(_0x4b4f1f,_0x390d23,_0x49909a[_0xb8783c]);}return __setModuleDefault(_0x4b4f1f,_0x390d23),_0x4b4f1f;};}()),__importDefault=this&&this['__importDefault']||function(_0x2921fc){return _0x2921fc&&_0x2921fc['__esModule']?_0x2921fc:{'default':_0x2921fc};};Object[a13_0x55b35b(0x141)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x55b35b(0x18c)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x55b35b(0x18b)));class TestGatewayController{constructor(){const _0xec79ac=a13_0x55b35b;this[_0xec79ac(0x18e)]=async(_0x4ae5e2,_0x1574b1,_0x443d30)=>{const _0x475a69=_0xec79ac;try{const {paymentId:_0x5bf2ef}=_0x4ae5e2[_0x475a69(0x192)];console[_0x475a69(0x147)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5bf2ef);const _0x33a91b=await database_1['default']['payment'][_0x475a69(0x14d)]({'where':{'id':_0x5bf2ef},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x33a91b)return _0x1574b1[_0x475a69(0x178)](0x194)[_0x475a69(0x190)]({'success':![],'message':_0x475a69(0x163)});if(_0x33a91b['gateway']!==_0x475a69(0x17f))return _0x1574b1[_0x475a69(0x178)](0x190)[_0x475a69(0x190)]({'success':![],'message':_0x475a69(0x154)});if(_0x33a91b[_0x475a69(0x178)]!==_0x475a69(0x173))return _0x1574b1[_0x475a69(0x178)](0x190)[_0x475a69(0x190)]({'success':![],'message':_0x475a69(0x199)+_0x33a91b['status']+_0x475a69(0x19d)});_0x1574b1[_0x475a69(0x190)]({'success':!![],'result':{'paymentId':_0x33a91b['id'],'orderId':_0x33a91b[_0x475a69(0x156)],'amount':_0x33a91b[_0x475a69(0x17c)],'currency':_0x33a91b[_0x475a69(0x168)],'merchantName':_0x33a91b[_0x475a69(0x177)][_0x475a69(0x17e)],'description':'Payment\x20to\x20'+_0x33a91b[_0x475a69(0x177)][_0x475a69(0x17e)],'testInstructions':{'successCard':_0x475a69(0x182),'failureCard':_0x475a69(0x16f),'expiryDate':_0x475a69(0x19a),'cvc':'Any\x203-4\x20digits','holderName':_0x475a69(0x181)}}});}catch(_0xced174){_0x443d30(_0xced174);}},this[_0xec79ac(0x187)]=async(_0x1990d7,_0x462362,_0x46dde9)=>{const _0x28d963=_0xec79ac;try{const {paymentId:_0x4461bf}=_0x1990d7[_0x28d963(0x192)],_0x558ba8=_0x1990d7['body'];console[_0x28d963(0x147)](_0x28d963(0x13b)+_0x4461bf);const _0x5f0dad=await database_1[_0x28d963(0x159)][_0x28d963(0x157)][_0x28d963(0x14d)]({'where':{'id':_0x4461bf},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5f0dad)return _0x462362[_0x28d963(0x178)](0x194)[_0x28d963(0x190)]({'success':![],'message':_0x28d963(0x163)});if(_0x5f0dad['gateway']!=='test_gateway')return _0x462362['status'](0x190)[_0x28d963(0x190)]({'success':![],'message':_0x28d963(0x154)});if(_0x5f0dad['status']!==_0x28d963(0x173))return _0x462362[_0x28d963(0x178)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5f0dad['status']+_0x28d963(0x19d)});const _0x8c2fe2=await this[_0x28d963(0x184)][_0x28d963(0x16c)]({'paymentId':_0x5f0dad['id'],'orderId':_0x5f0dad[_0x28d963(0x156)]||_0x5f0dad['id'],'amount':_0x5f0dad[_0x28d963(0x17c)],'currency':_0x5f0dad[_0x28d963(0x168)],'cardData':_0x558ba8});console['log'](_0x28d963(0x15c),_0x8c2fe2);const _0x207d41={'status':_0x8c2fe2[_0x28d963(0x178)],'updatedAt':new Date()};if(_0x8c2fe2[_0x28d963(0x178)]==='PAID')_0x207d41[_0x28d963(0x1a0)]=new Date(),_0x207d41['gatewayPaymentId']=_0x8c2fe2[_0x28d963(0x169)];else _0x8c2fe2['status']===_0x28d963(0x13d)&&(_0x207d41[_0x28d963(0x143)]=_0x8c2fe2[_0x28d963(0x18f)]);const _0x202c31=_0x558ba8['cardNumber'][_0x28d963(0x15b)](/[\s-]/g,'');_0x207d41[_0x28d963(0x188)]=_0x202c31[_0x28d963(0x146)](-0x4),_0x207d41[_0x28d963(0x14e)]=_0x28d963(0x19b),await database_1['default']['payment'][_0x28d963(0x186)]({'where':{'id':_0x5f0dad['id']},'data':_0x207d41}),await database_1[_0x28d963(0x159)][_0x28d963(0x167)][_0x28d963(0x19f)]({'data':{'paymentId':_0x5f0dad['id'],'shopId':_0x5f0dad[_0x28d963(0x14b)],'event':_0x28d963(0x196)+_0x8c2fe2['status'][_0x28d963(0x179)](),'statusCode':0xc8,'responseBody':JSON[_0x28d963(0x197)]({'oldStatus':_0x28d963(0x173),'newStatus':_0x8c2fe2[_0x28d963(0x178)],'transactionId':_0x8c2fe2[_0x28d963(0x169)],'failureReason':_0x8c2fe2[_0x28d963(0x18f)],'processedAt':new Date()['toISOString']()})}}),await this[_0x28d963(0x19c)](_0x5f0dad,_0x8c2fe2[_0x28d963(0x178)],_0x8c2fe2[_0x28d963(0x169)],_0x8c2fe2['failureReason']),await this['sendPaymentStatusNotification'](_0x5f0dad,_0x8c2fe2['status']),console[_0x28d963(0x147)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x4461bf+_0x28d963(0x149)+_0x8c2fe2[_0x28d963(0x178)]),_0x8c2fe2['status']===_0x28d963(0x189)?_0x462362[_0x28d963(0x190)]({'success':!![],'message':_0x28d963(0x15e),'result':{'status':_0x28d963(0x189),'transactionId':_0x8c2fe2[_0x28d963(0x169)],'redirectUrl':_0x5f0dad[_0x28d963(0x165)]}}):_0x462362['status'](0x190)[_0x28d963(0x190)]({'success':![],'message':_0x28d963(0x17b),'result':{'status':_0x28d963(0x13d),'failureReason':_0x8c2fe2[_0x28d963(0x18f)],'redirectUrl':_0x5f0dad['failUrl']}});}catch(_0x525f16){_0x46dde9(_0x525f16);}},this[_0xec79ac(0x184)]=new testGatewayService_1[(_0xec79ac(0x170))](),this[_0xec79ac(0x16a)]=new webhookService_1[(_0xec79ac(0x144))]();}async[a13_0x55b35b(0x19c)](_0x90221f,_0x1bce93,_0x18619c,_0x17c1c6){const _0x36e28a=a13_0x55b35b,_0x25e844=Date[_0x36e28a(0x14a)]();try{const _0x1183d8=_0x90221f[_0x36e28a(0x177)],_0x54bc00=_0x1183d8[_0x36e28a(0x17a)];if(!_0x54bc00?.[_0x36e28a(0x152)]){console[_0x36e28a(0x147)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1183d8['id']);return;}const _0x158202=_0x1bce93===_0x36e28a(0x189)?_0x36e28a(0x150):_0x36e28a(0x172);let _0x384905=[];if(_0x54bc00['webhookEvents'])try{_0x384905=Array['isArray'](_0x54bc00[_0x36e28a(0x193)])?_0x54bc00[_0x36e28a(0x193)]:JSON[_0x36e28a(0x13c)](_0x54bc00[_0x36e28a(0x193)]);}catch(_0x109054){console[_0x36e28a(0x191)](_0x36e28a(0x18a),_0x109054),_0x384905=[];}if(!_0x384905['includes'](_0x158202)){console[_0x36e28a(0x147)]('Webhook\x20event\x20'+_0x158202+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1183d8['id']);return;}const _0x438ace={'event':_0x158202,'payment':{'id':_0x90221f['id'],'order_id':_0x90221f[_0x36e28a(0x145)],'gateway_order_id':_0x90221f[_0x36e28a(0x156)],'gateway':'0000','amount':_0x90221f[_0x36e28a(0x17c)],'currency':_0x90221f['currency'],'status':_0x1bce93[_0x36e28a(0x179)](),'customer_email':_0x90221f[_0x36e28a(0x15a)],'customer_name':_0x90221f[_0x36e28a(0x183)],'transaction_id':_0x18619c,'failure_message':_0x17c1c6,'created_at':_0x90221f[_0x36e28a(0x13f)],'updated_at':new Date()}},_0x25f434=await fetch(_0x54bc00[_0x36e28a(0x152)],{'method':_0x36e28a(0x166),'headers':{'Content-Type':'application/json','User-Agent':_0x36e28a(0x198)},'body':JSON[_0x36e28a(0x197)](_0x438ace)}),_0x16972e=Date['now']()-_0x25e844;console['log'](_0x36e28a(0x13e)+_0x54bc00[_0x36e28a(0x152)]+_0x36e28a(0x15d)+_0x25f434[_0x36e28a(0x178)]+'\x20('+_0x16972e+_0x36e28a(0x16e));}catch(_0x4a32e5){console['error'](_0x36e28a(0x180),_0x4a32e5);}}async['sendPaymentStatusNotification'](_0x56157b,_0x13d546){const _0xc5d795=a13_0x55b35b;try{const {telegramBotService:_0xd3b321}=await Promise[_0xc5d795(0x18d)]()[_0xc5d795(0x176)](()=>__importStar(require('../services/telegramBotService'))),_0x8794a3={'PAID':_0xc5d795(0x160),'FAILED':_0xc5d795(0x16d)},_0x4ec920=_0x8794a3[_0x13d546];if(!_0x4ec920)return;await _0xd3b321['sendPaymentNotification'](_0x56157b['shopId'],_0x56157b,_0x4ec920);}catch(_0x27b3df){console[_0xc5d795(0x191)](_0xc5d795(0x161),_0x27b3df);}}}exports[a13_0x55b35b(0x14c)]=TestGatewayController;