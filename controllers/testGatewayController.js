'use strict';const a13_0x5b8942=a13_0x1725;function a13_0x1725(_0x5cf9a6,_0x189550){const _0x41ea5f=a13_0x41ea();return a13_0x1725=function(_0x17251b,_0x55aa66){_0x17251b=_0x17251b-0x17d;let _0x5a6b41=_0x41ea5f[_0x17251b];return _0x5a6b41;},a13_0x1725(_0x5cf9a6,_0x189550);}(function(_0x5c57a5,_0x5e825f){const _0x2c3c67=a13_0x1725,_0xd869dd=_0x5c57a5();while(!![]){try{const _0x3a32ad=-parseInt(_0x2c3c67(0x1aa))/0x1+-parseInt(_0x2c3c67(0x18f))/0x2+parseInt(_0x2c3c67(0x1dd))/0x3+-parseInt(_0x2c3c67(0x184))/0x4+-parseInt(_0x2c3c67(0x1e2))/0x5+-parseInt(_0x2c3c67(0x193))/0x6*(parseInt(_0x2c3c67(0x1b3))/0x7)+-parseInt(_0x2c3c67(0x19e))/0x8*(-parseInt(_0x2c3c67(0x1d6))/0x9);if(_0x3a32ad===_0x5e825f)break;else _0xd869dd['push'](_0xd869dd['shift']());}catch(_0x1b248a){_0xd869dd['push'](_0xd869dd['shift']());}}}(a13_0x41ea,0x26181));var __createBinding=this&&this[a13_0x5b8942(0x1d3)]||(Object[a13_0x5b8942(0x1a0)]?function(_0x29b27d,_0x170024,_0x12a290,_0x192320){const _0x4a14ff=a13_0x5b8942;if(_0x192320===undefined)_0x192320=_0x12a290;var _0x26d457=Object[_0x4a14ff(0x1b1)](_0x170024,_0x12a290);(!_0x26d457||(_0x4a14ff(0x17f)in _0x26d457?!_0x170024[_0x4a14ff(0x17e)]:_0x26d457[_0x4a14ff(0x1c1)]||_0x26d457[_0x4a14ff(0x1da)]))&&(_0x26d457={'enumerable':!![],'get':function(){return _0x170024[_0x12a290];}}),Object[_0x4a14ff(0x189)](_0x29b27d,_0x192320,_0x26d457);}:function(_0x3e5c5b,_0x37233b,_0x166e00,_0x196255){if(_0x196255===undefined)_0x196255=_0x166e00;_0x3e5c5b[_0x196255]=_0x37233b[_0x166e00];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0xc78a83,_0x437e70){const _0x22a42a=a13_0x5b8942;Object[_0x22a42a(0x189)](_0xc78a83,_0x22a42a(0x1a7),{'enumerable':!![],'value':_0x437e70});}:function(_0x351ee0,_0x3e28cb){const _0x15953e=a13_0x5b8942;_0x351ee0[_0x15953e(0x1a7)]=_0x3e28cb;}),__importStar=this&&this[a13_0x5b8942(0x18a)]||(function(){var _0x8f4244=function(_0x1cda6a){const _0x17bd7f=a13_0x1725;return _0x8f4244=Object[_0x17bd7f(0x186)]||function(_0x18b75b){const _0x32ed95=_0x17bd7f;var _0x368722=[];for(var _0x4bbec2 in _0x18b75b)if(Object[_0x32ed95(0x1a2)][_0x32ed95(0x1e5)]['call'](_0x18b75b,_0x4bbec2))_0x368722[_0x368722[_0x32ed95(0x1ba)]]=_0x4bbec2;return _0x368722;},_0x8f4244(_0x1cda6a);};return function(_0x7048d3){const _0x4f6945=a13_0x1725;if(_0x7048d3&&_0x7048d3[_0x4f6945(0x17e)])return _0x7048d3;var _0x33a5b1={};if(_0x7048d3!=null){for(var _0x357d87=_0x8f4244(_0x7048d3),_0x3d09fb=0x0;_0x3d09fb<_0x357d87['length'];_0x3d09fb++)if(_0x357d87[_0x3d09fb]!==_0x4f6945(0x1a7))__createBinding(_0x33a5b1,_0x7048d3,_0x357d87[_0x3d09fb]);}return __setModuleDefault(_0x33a5b1,_0x7048d3),_0x33a5b1;};}()),__importDefault=this&&this[a13_0x5b8942(0x181)]||function(_0x26206c){return _0x26206c&&_0x26206c['__esModule']?_0x26206c:{'default':_0x26206c};};function a13_0x41ea(){const _0x10c9ab=['update','gatewayPaymentId','failureReason','__createBinding','failed','now','4612203hWkeXd','customerName','webhookEvents','FAILED','configurable','processCard','error','602979hhqMHE','PAID','getPaymentForm','resolve','body','305615IJwUJc','Any\x20name','successUrl','hasOwnProperty','shopId','Payment\x20processed\x20successfully','status','failUrl','__esModule','get','replace','__importDefault','âœ…\x20Test\x20Gateway\x20payment\x20','webhookLog','544780EdCrdf',',\x20cannot\x20process','getOwnPropertyNames','toLowerCase','paid','defineProperty','__importStar','isArray','WebhookService','amount','\x20not\x20enabled\x20for\x20shop\x20','225784idNynm','ðŸ§ª\x20Test\x20Gateway\x20result:','paymentMethod','Payment\x20to\x20','69804lkhkbf','stringify','4242\x204242\x204242\x204242','test_card','POST','Test\x20Gateway\x20webhook\x20sent\x20to\x20','toISOString','Payment\x20is\x20not\x20for\x20test\x20gateway','PENDING','findUnique','Payment\x20not\x20found','8Necdao','\x20with\x20status\x20','create','transactionId','prototype','TestGatewayController','gatewayOrderId','../services/webhookService','sendPaymentNotification','default','payment','Error\x20parsing\x20webhook\x20events:','2903AgutJj','cardNumber','../services/telegramBotService','sendShopWebhook','application/json','webhookUrl','\x20processed:\x20','getOwnPropertyDescriptor','params','147LQowcH','customerEmail','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','createdAt','name','cardLast4','currency','length','log','sendPaymentStatusNotification','TestGatewayService','Payment\x20status\x20is\x20','gateway','paidAt','writable','ms)','Payment\x20failed','testGatewayService','shop','Any\x203-4\x20digits','test_gateway_','webhookService','includes','../config/database','json','0000','processCardPayment','slice','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'];a13_0x41ea=function(){return _0x10c9ab;};return a13_0x41ea();}Object[a13_0x5b8942(0x189)](exports,a13_0x5b8942(0x17e),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x5b8942(0x1a5)),database_1=__importDefault(require(a13_0x5b8942(0x1ca)));class TestGatewayController{constructor(){const _0xea6246=a13_0x5b8942;this[_0xea6246(0x1df)]=async(_0x37c5c5,_0x5613b1,_0x369de2)=>{const _0x53ae6c=_0xea6246;try{const {paymentId:_0x569ef4}=_0x37c5c5['params'];console[_0x53ae6c(0x1bb)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x569ef4);const _0x3965e0=await database_1[_0x53ae6c(0x1a7)][_0x53ae6c(0x1a8)][_0x53ae6c(0x19c)]({'where':{'id':_0x569ef4},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3965e0)return _0x5613b1[_0x53ae6c(0x1e8)](0x194)[_0x53ae6c(0x1cb)]({'success':![],'message':_0x53ae6c(0x19d)});if(_0x3965e0[_0x53ae6c(0x1bf)]!=='test_gateway')return _0x5613b1[_0x53ae6c(0x1e8)](0x190)['json']({'success':![],'message':_0x53ae6c(0x19a)});if(_0x3965e0['status']!==_0x53ae6c(0x19b))return _0x5613b1[_0x53ae6c(0x1e8)](0x190)[_0x53ae6c(0x1cb)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3965e0[_0x53ae6c(0x1e8)]+',\x20cannot\x20process'});_0x5613b1[_0x53ae6c(0x1cb)]({'success':!![],'result':{'paymentId':_0x3965e0['id'],'orderId':_0x3965e0[_0x53ae6c(0x1a4)],'amount':_0x3965e0['amount'],'currency':_0x3965e0[_0x53ae6c(0x1b9)],'merchantName':_0x3965e0['shop']['name'],'description':_0x53ae6c(0x192)+_0x3965e0['shop'][_0x53ae6c(0x1b7)],'testInstructions':{'successCard':_0x53ae6c(0x195),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x53ae6c(0x1c6),'holderName':_0x53ae6c(0x1e3)}}});}catch(_0x59e07e){_0x369de2(_0x59e07e);}},this[_0xea6246(0x1db)]=async(_0x4b75a1,_0x446dc3,_0x2743c7)=>{const _0x523705=_0xea6246;try{const {paymentId:_0x33b886}=_0x4b75a1[_0x523705(0x1b2)],_0x38ef18=_0x4b75a1[_0x523705(0x1e1)];console[_0x523705(0x1bb)](_0x523705(0x1cf)+_0x33b886);const _0x317572=await database_1['default'][_0x523705(0x1a8)][_0x523705(0x19c)]({'where':{'id':_0x33b886},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x317572)return _0x446dc3[_0x523705(0x1e8)](0x194)[_0x523705(0x1cb)]({'success':![],'message':_0x523705(0x19d)});if(_0x317572[_0x523705(0x1bf)]!=='test_gateway')return _0x446dc3[_0x523705(0x1e8)](0x190)[_0x523705(0x1cb)]({'success':![],'message':_0x523705(0x19a)});if(_0x317572[_0x523705(0x1e8)]!==_0x523705(0x19b))return _0x446dc3['status'](0x190)['json']({'success':![],'message':_0x523705(0x1be)+_0x317572['status']+_0x523705(0x185)});const _0x2fe9ff=await this[_0x523705(0x1c4)][_0x523705(0x1cd)]({'paymentId':_0x317572['id'],'orderId':_0x317572[_0x523705(0x1a4)]||_0x317572['id'],'amount':_0x317572[_0x523705(0x18d)],'currency':_0x317572[_0x523705(0x1b9)],'cardData':_0x38ef18});console[_0x523705(0x1bb)](_0x523705(0x190),_0x2fe9ff);const _0x1e6f55={'status':_0x2fe9ff[_0x523705(0x1e8)],'updatedAt':new Date()};if(_0x2fe9ff[_0x523705(0x1e8)]===_0x523705(0x1de))_0x1e6f55[_0x523705(0x1c0)]=new Date(),_0x1e6f55[_0x523705(0x1d1)]=_0x2fe9ff['transactionId'];else _0x2fe9ff[_0x523705(0x1e8)]===_0x523705(0x1d9)&&(_0x1e6f55['failureMessage']=_0x2fe9ff[_0x523705(0x1d2)]);const _0x368925=_0x38ef18[_0x523705(0x1ab)][_0x523705(0x180)](/[\s-]/g,'');_0x1e6f55[_0x523705(0x1b8)]=_0x368925[_0x523705(0x1ce)](-0x4),_0x1e6f55[_0x523705(0x191)]=_0x523705(0x196),await database_1[_0x523705(0x1a7)][_0x523705(0x1a8)][_0x523705(0x1d0)]({'where':{'id':_0x317572['id']},'data':_0x1e6f55}),await database_1[_0x523705(0x1a7)][_0x523705(0x183)][_0x523705(0x1a0)]({'data':{'paymentId':_0x317572['id'],'shopId':_0x317572['shopId'],'event':_0x523705(0x1c7)+_0x2fe9ff[_0x523705(0x1e8)][_0x523705(0x187)](),'statusCode':0xc8,'responseBody':JSON[_0x523705(0x194)]({'oldStatus':_0x523705(0x19b),'newStatus':_0x2fe9ff[_0x523705(0x1e8)],'transactionId':_0x2fe9ff['transactionId'],'failureReason':_0x2fe9ff['failureReason'],'processedAt':new Date()[_0x523705(0x199)]()})}}),await this[_0x523705(0x1ad)](_0x317572,_0x2fe9ff[_0x523705(0x1e8)],_0x2fe9ff[_0x523705(0x1a1)],_0x2fe9ff[_0x523705(0x1d2)]),await this[_0x523705(0x1bc)](_0x317572,_0x2fe9ff[_0x523705(0x1e8)]),console[_0x523705(0x1bb)](_0x523705(0x182)+_0x33b886+_0x523705(0x1b0)+_0x2fe9ff['status']),_0x2fe9ff[_0x523705(0x1e8)]===_0x523705(0x1de)?_0x446dc3['json']({'success':!![],'message':_0x523705(0x1e7),'result':{'status':_0x523705(0x1de),'transactionId':_0x2fe9ff[_0x523705(0x1a1)],'redirectUrl':_0x317572[_0x523705(0x1e4)]}}):_0x446dc3[_0x523705(0x1e8)](0x190)[_0x523705(0x1cb)]({'success':![],'message':_0x523705(0x1c3),'result':{'status':_0x523705(0x1d9),'failureReason':_0x2fe9ff[_0x523705(0x1d2)],'redirectUrl':_0x317572[_0x523705(0x17d)]}});}catch(_0x41ff61){_0x2743c7(_0x41ff61);}},this['testGatewayService']=new testGatewayService_1[(_0xea6246(0x1bd))](),this[_0xea6246(0x1c8)]=new webhookService_1[(_0xea6246(0x18c))]();}async[a13_0x5b8942(0x1ad)](_0x85d5df,_0x5d6d15,_0x4d8a3c,_0x4746e8){const _0x517693=a13_0x5b8942,_0x395297=Date[_0x517693(0x1d5)]();try{const _0x5c059f=_0x85d5df[_0x517693(0x1c5)],_0x11b00a=_0x5c059f['settings'];if(!_0x11b00a?.[_0x517693(0x1af)]){console[_0x517693(0x1bb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5c059f['id']);return;}const _0x5a4f23=_0x5d6d15===_0x517693(0x1de)?'payment.success':'payment.failed';let _0x2ff78b=[];if(_0x11b00a['webhookEvents'])try{_0x2ff78b=Array[_0x517693(0x18b)](_0x11b00a['webhookEvents'])?_0x11b00a[_0x517693(0x1d8)]:JSON['parse'](_0x11b00a[_0x517693(0x1d8)]);}catch(_0x79a78d){console[_0x517693(0x1dc)](_0x517693(0x1a9),_0x79a78d),_0x2ff78b=[];}if(!_0x2ff78b[_0x517693(0x1c9)](_0x5a4f23)){console[_0x517693(0x1bb)]('Webhook\x20event\x20'+_0x5a4f23+_0x517693(0x18e)+_0x5c059f['id']);return;}const _0x531e9f={'event':_0x5a4f23,'payment':{'id':_0x85d5df['id'],'order_id':_0x85d5df['orderId'],'gateway_order_id':_0x85d5df[_0x517693(0x1a4)],'gateway':_0x517693(0x1cc),'amount':_0x85d5df['amount'],'currency':_0x85d5df[_0x517693(0x1b9)],'status':_0x5d6d15[_0x517693(0x187)](),'customer_email':_0x85d5df[_0x517693(0x1b4)],'customer_name':_0x85d5df[_0x517693(0x1d7)],'transaction_id':_0x4d8a3c,'failure_message':_0x4746e8,'created_at':_0x85d5df[_0x517693(0x1b6)],'updated_at':new Date()}},_0x53de1c=await fetch(_0x11b00a[_0x517693(0x1af)],{'method':_0x517693(0x197),'headers':{'Content-Type':_0x517693(0x1ae),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x517693(0x194)](_0x531e9f)}),_0x54aaf5=Date[_0x517693(0x1d5)]()-_0x395297;console[_0x517693(0x1bb)](_0x517693(0x198)+_0x11b00a[_0x517693(0x1af)]+_0x517693(0x19f)+_0x53de1c['status']+'\x20('+_0x54aaf5+_0x517693(0x1c2));}catch(_0x5b7b4c){console[_0x517693(0x1dc)](_0x517693(0x1b5),_0x5b7b4c);}}async[a13_0x5b8942(0x1bc)](_0x59ded3,_0x42b77a){const _0x313e60=a13_0x5b8942;try{const {telegramBotService:_0x4bde38}=await Promise[_0x313e60(0x1e0)]()['then'](()=>__importStar(require(_0x313e60(0x1ac)))),_0x55400e={'PAID':_0x313e60(0x188),'FAILED':_0x313e60(0x1d4)},_0x2bcb53=_0x55400e[_0x42b77a];if(!_0x2bcb53)return;await _0x4bde38[_0x313e60(0x1a6)](_0x59ded3[_0x313e60(0x1e6)],_0x59ded3,_0x2bcb53);}catch(_0x228add){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x228add);}}}exports[a13_0x5b8942(0x1a3)]=TestGatewayController;