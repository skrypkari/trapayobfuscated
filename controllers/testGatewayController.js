'use strict';const a15_0x456674=a15_0x4676;function a15_0x1c7d(){const _0x2dbf45=['then','1719040bawMhV',',\x20currentPayments=','paymentLink','paid','amount','FAILED','create','now','__importStar','transactionId','update','failureReason','sendShopWebhook','Webhook\x20event\x20','1544104eirBcL','payment.success','length','type','status','POST','log','processCard','Payment\x20System/1.0\x20(Test\x20Gateway)','failed','45278GiKTOv','../services/telegramBotService','gateway','\x20with\x20status\x20','PENDING','gatewayOrderId','currentPayments','settings','findUnique','\x20->\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','toLowerCase','Any\x20future\x20date\x20(MM/YY)','json','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Any\x203-4\x20digits','paidAt','6731697EzEzOS','name','sendPaymentStatusNotification','\x20processed:\x20','Payment\x20status\x20is\x20','failUrl','webhookEvents','default','SINGLE','PAID','üìà\x20Test\x20Gateway:\x20Payment\x20','isArray','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','__setModuleDefault','parse','test_gateway_','\x20updated:\x20currentPayments=','gatewayPaymentId','Payment\x20not\x20found','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','error','Payment\x20failed','Test\x20Gateway\x20webhook\x20sent\x20to\x20','test_gateway','getPaymentForm','$transaction','testGatewayService','replace','../config/database','__importDefault',':\x20type=','4242\x204242\x204242\x204242','Payment\x20to\x20','1213068JoFHpx','TestGatewayController','successUrl','getOwnPropertyDescriptor','888nyXOjD','hasOwnProperty','Payment\x20processed\x20successfully','0000','Any\x20name','application/json','__esModule','shop','../services/gateways/testGatewayService','orderId','createdAt','__createBinding','slice','toISOString','get','payment.failed','shopId','webhookUrl','‚úÖ\x20Payment\x20link\x20','getOwnPropertyNames','Payment\x20is\x20not\x20for\x20test\x20gateway','120402erWKQa','96080lUlrQp','stringify','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','currency','paymentLinkId','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20not\x20found','resolve','params','../services/webhookService','TestGatewayService','payment',',\x20cannot\x20process','93fNkomb','defineProperty','COMPLETED','sendPaymentNotification','failureMessage'];a15_0x1c7d=function(){return _0x2dbf45;};return a15_0x1c7d();}(function(_0x3435e2,_0x5b717f){const _0x690510=a15_0x4676,_0x3d9761=_0x3435e2();while(!![]){try{const _0xd8b0f2=-parseInt(_0x690510(0x238))/0x1+-parseInt(_0x690510(0x22e))/0x2+parseInt(_0x690510(0x21a))/0x3*(parseInt(_0x690510(0x20d))/0x4)+parseInt(_0x690510(0x220))/0x5+-parseInt(_0x690510(0x1f3))/0x6+-parseInt(_0x690510(0x249))/0x7+parseInt(_0x690510(0x1f7))/0x8*(parseInt(_0x690510(0x20c))/0x9);if(_0xd8b0f2===_0x5b717f)break;else _0x3d9761['push'](_0x3d9761['shift']());}catch(_0x421514){_0x3d9761['push'](_0x3d9761['shift']());}}}(a15_0x1c7d,0x9094f));var __createBinding=this&&this[a15_0x456674(0x202)]||(Object['create']?function(_0x1f77f7,_0x425b9d,_0x158fc6,_0x45015c){const _0x4d70eb=a15_0x456674;if(_0x45015c===undefined)_0x45015c=_0x158fc6;var _0x5a0b74=Object[_0x4d70eb(0x1f6)](_0x425b9d,_0x158fc6);(!_0x5a0b74||(_0x4d70eb(0x205)in _0x5a0b74?!_0x425b9d[_0x4d70eb(0x1fd)]:_0x5a0b74['writable']||_0x5a0b74['configurable']))&&(_0x5a0b74={'enumerable':!![],'get':function(){return _0x425b9d[_0x158fc6];}}),Object['defineProperty'](_0x1f77f7,_0x45015c,_0x5a0b74);}:function(_0x1dc3be,_0x2e4c52,_0x4a802c,_0x1dce3f){if(_0x1dce3f===undefined)_0x1dce3f=_0x4a802c;_0x1dc3be[_0x1dce3f]=_0x2e4c52[_0x4a802c];}),__setModuleDefault=this&&this[a15_0x456674(0x256)]||(Object['create']?function(_0x1ea59a,_0x141169){const _0x42f6fd=a15_0x456674;Object[_0x42f6fd(0x21b)](_0x1ea59a,'default',{'enumerable':!![],'value':_0x141169});}:function(_0x4a0c95,_0x9584db){const _0x3d51b6=a15_0x456674;_0x4a0c95[_0x3d51b6(0x250)]=_0x9584db;}),__importStar=this&&this[a15_0x456674(0x228)]||(function(){var _0x3f87d8=function(_0x3fea25){const _0x7b8216=a15_0x4676;return _0x3f87d8=Object[_0x7b8216(0x20a)]||function(_0x2b1817){const _0x2daa01=_0x7b8216;var _0x38e65b=[];for(var _0x227ea5 in _0x2b1817)if(Object['prototype'][_0x2daa01(0x1f8)]['call'](_0x2b1817,_0x227ea5))_0x38e65b[_0x38e65b['length']]=_0x227ea5;return _0x38e65b;},_0x3f87d8(_0x3fea25);};return function(_0x53c26d){const _0x3a9b78=a15_0x4676;if(_0x53c26d&&_0x53c26d['__esModule'])return _0x53c26d;var _0x4c453c={};if(_0x53c26d!=null){for(var _0x383d79=_0x3f87d8(_0x53c26d),_0x380a10=0x0;_0x380a10<_0x383d79[_0x3a9b78(0x230)];_0x380a10++)if(_0x383d79[_0x380a10]!==_0x3a9b78(0x250))__createBinding(_0x4c453c,_0x53c26d,_0x383d79[_0x380a10]);}return __setModuleDefault(_0x4c453c,_0x53c26d),_0x4c453c;};}()),__importDefault=this&&this[a15_0x456674(0x1ef)]||function(_0x20fa78){return _0x20fa78&&_0x20fa78['__esModule']?_0x20fa78:{'default':_0x20fa78};};function a15_0x4676(_0x379fb6,_0x197003){const _0x1c7d01=a15_0x1c7d();return a15_0x4676=function(_0x467676,_0x31360c){_0x467676=_0x467676-0x1e8;let _0x1effe4=_0x1c7d01[_0x467676];return _0x1effe4;},a15_0x4676(_0x379fb6,_0x197003);}Object['defineProperty'](exports,a15_0x456674(0x1fd),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a15_0x456674(0x1ff)),webhookService_1=require(a15_0x456674(0x216)),database_1=__importDefault(require(a15_0x456674(0x1ee)));class TestGatewayController{constructor(){const _0x2763f4=a15_0x456674;this[_0x2763f4(0x1ea)]=async(_0x1aa557,_0xfc232b,_0x237c40)=>{const _0x238052=_0x2763f4;try{const {paymentId:_0x5b9689}=_0x1aa557['params'];console['log'](_0x238052(0x20f)+_0x5b9689);const _0x10db24=await database_1[_0x238052(0x250)]['payment'][_0x238052(0x240)]({'where':{'id':_0x5b9689},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x10db24)return _0xfc232b['status'](0x194)[_0x238052(0x245)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x10db24[_0x238052(0x23a)]!==_0x238052(0x1e9))return _0xfc232b[_0x238052(0x232)](0x190)[_0x238052(0x245)]({'success':![],'message':_0x238052(0x20b)});if(_0x10db24['status']!==_0x238052(0x23c))return _0xfc232b['status'](0x190)[_0x238052(0x245)]({'success':![],'message':_0x238052(0x24d)+_0x10db24[_0x238052(0x232)]+_0x238052(0x219)});_0xfc232b[_0x238052(0x245)]({'success':!![],'result':{'paymentId':_0x10db24['id'],'orderId':_0x10db24[_0x238052(0x23d)],'amount':_0x10db24[_0x238052(0x224)],'currency':_0x10db24['currency'],'merchantName':_0x10db24[_0x238052(0x1fe)][_0x238052(0x24a)],'description':_0x238052(0x1f2)+_0x10db24[_0x238052(0x1fe)][_0x238052(0x24a)],'testInstructions':{'successCard':_0x238052(0x1f1),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x238052(0x244),'cvc':_0x238052(0x247),'holderName':_0x238052(0x1fb)}}});}catch(_0x31f4af){_0x237c40(_0x31f4af);}},this[_0x2763f4(0x235)]=async(_0x248dee,_0x4adf40,_0x875408)=>{const _0x2471cf=_0x2763f4;try{const {paymentId:_0x15088d}=_0x248dee[_0x2471cf(0x215)],_0x58a68d=_0x248dee['body'];console[_0x2471cf(0x234)](_0x2471cf(0x246)+_0x15088d);const _0x2e8e36=await database_1[_0x2471cf(0x250)]['payment']['findUnique']({'where':{'id':_0x15088d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2e8e36)return _0x4adf40[_0x2471cf(0x232)](0x194)['json']({'success':![],'message':_0x2471cf(0x25b)});if(_0x2e8e36[_0x2471cf(0x23a)]!==_0x2471cf(0x1e9))return _0x4adf40['status'](0x190)[_0x2471cf(0x245)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2e8e36[_0x2471cf(0x232)]!=='PENDING')return _0x4adf40[_0x2471cf(0x232)](0x190)[_0x2471cf(0x245)]({'success':![],'message':_0x2471cf(0x24d)+_0x2e8e36[_0x2471cf(0x232)]+',\x20cannot\x20process'});const _0x1a69b5=await this[_0x2471cf(0x1ec)]['processCardPayment']({'paymentId':_0x2e8e36['id'],'orderId':_0x2e8e36[_0x2471cf(0x23d)]||_0x2e8e36['id'],'amount':_0x2e8e36['amount'],'currency':_0x2e8e36[_0x2471cf(0x210)],'cardData':_0x58a68d});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x1a69b5);const _0x2a6d19={'status':_0x1a69b5[_0x2471cf(0x232)],'updatedAt':new Date()};if(_0x1a69b5[_0x2471cf(0x232)]==='PAID')_0x2a6d19[_0x2471cf(0x248)]=new Date(),_0x2a6d19[_0x2471cf(0x25a)]=_0x1a69b5[_0x2471cf(0x229)];else _0x1a69b5[_0x2471cf(0x232)]===_0x2471cf(0x225)&&(_0x2a6d19[_0x2471cf(0x21e)]=_0x1a69b5[_0x2471cf(0x22b)]);const _0x17dd6b=_0x58a68d['cardNumber'][_0x2471cf(0x1ed)](/[\s-]/g,'');_0x2a6d19['cardLast4']=_0x17dd6b[_0x2471cf(0x203)](-0x4),_0x2a6d19['paymentMethod']='test_card',await database_1['default'][_0x2471cf(0x218)]['update']({'where':{'id':_0x2e8e36['id']},'data':_0x2a6d19});if(_0x1a69b5['status']===_0x2471cf(0x252)&&_0x2e8e36[_0x2471cf(0x211)]){console[_0x2471cf(0x234)](_0x2471cf(0x253)+_0x2e8e36['id']+_0x2471cf(0x212));try{await database_1[_0x2471cf(0x250)][_0x2471cf(0x1eb)](async _0x369e34=>{const _0x3f4842=_0x2471cf,_0x32098e=await _0x369e34['paymentLink'][_0x3f4842(0x240)]({'where':{'id':_0x2e8e36[_0x3f4842(0x211)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x32098e){console[_0x3f4842(0x234)]('üìà\x20Found\x20payment\x20link\x20'+_0x32098e['id']+_0x3f4842(0x1f0)+_0x32098e[_0x3f4842(0x231)]+_0x3f4842(0x221)+_0x32098e[_0x3f4842(0x23e)]+',\x20status='+_0x32098e[_0x3f4842(0x232)]);const _0x4b892a=_0x32098e[_0x3f4842(0x23e)]+0x1,_0x5380c6=_0x32098e[_0x3f4842(0x231)]===_0x3f4842(0x251)?_0x3f4842(0x21c):_0x32098e[_0x3f4842(0x232)];await _0x369e34[_0x3f4842(0x222)][_0x3f4842(0x22a)]({'where':{'id':_0x2e8e36[_0x3f4842(0x211)]},'data':{'currentPayments':_0x4b892a,'status':_0x5380c6,'updatedAt':new Date()}}),console[_0x3f4842(0x234)](_0x3f4842(0x209)+_0x32098e['id']+_0x3f4842(0x259)+_0x32098e[_0x3f4842(0x23e)]+_0x3f4842(0x241)+_0x4b892a+',\x20status='+_0x32098e[_0x3f4842(0x232)]+_0x3f4842(0x241)+_0x5380c6);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x2e8e36[_0x3f4842(0x211)]+_0x3f4842(0x213));});}catch(_0x4bd752){console[_0x2471cf(0x25d)](_0x2471cf(0x255),_0x4bd752);}}await database_1[_0x2471cf(0x250)]['webhookLog'][_0x2471cf(0x226)]({'data':{'paymentId':_0x2e8e36['id'],'shopId':_0x2e8e36[_0x2471cf(0x207)],'event':_0x2471cf(0x258)+_0x1a69b5[_0x2471cf(0x232)][_0x2471cf(0x243)](),'statusCode':0xc8,'responseBody':JSON[_0x2471cf(0x20e)]({'oldStatus':_0x2471cf(0x23c),'newStatus':_0x1a69b5[_0x2471cf(0x232)],'transactionId':_0x1a69b5['transactionId'],'failureReason':_0x1a69b5['failureReason'],'processedAt':new Date()[_0x2471cf(0x204)]()})}}),await this[_0x2471cf(0x22c)](_0x2e8e36,_0x1a69b5[_0x2471cf(0x232)],_0x1a69b5[_0x2471cf(0x229)],_0x1a69b5[_0x2471cf(0x22b)]),await this[_0x2471cf(0x24b)](_0x2e8e36,_0x1a69b5[_0x2471cf(0x232)]),console[_0x2471cf(0x234)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x15088d+_0x2471cf(0x24c)+_0x1a69b5['status']),_0x1a69b5[_0x2471cf(0x232)]===_0x2471cf(0x252)?_0x4adf40[_0x2471cf(0x245)]({'success':!![],'message':_0x2471cf(0x1f9),'result':{'status':_0x2471cf(0x252),'transactionId':_0x1a69b5[_0x2471cf(0x229)],'redirectUrl':_0x2e8e36[_0x2471cf(0x1f5)]}}):_0x4adf40[_0x2471cf(0x232)](0x190)[_0x2471cf(0x245)]({'success':![],'message':_0x2471cf(0x25e),'result':{'status':_0x2471cf(0x225),'failureReason':_0x1a69b5[_0x2471cf(0x22b)],'redirectUrl':_0x2e8e36[_0x2471cf(0x24e)]}});}catch(_0x5de510){_0x875408(_0x5de510);}},this[_0x2763f4(0x1ec)]=new testGatewayService_1[(_0x2763f4(0x217))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a15_0x456674(0x22c)](_0x570f37,_0x135b61,_0x506ede,_0x325127){const _0x1d5ae3=a15_0x456674,_0x50340e=Date[_0x1d5ae3(0x227)]();try{const _0x447a64=_0x570f37[_0x1d5ae3(0x1fe)],_0x48eab4=_0x447a64[_0x1d5ae3(0x23f)];if(!_0x48eab4?.[_0x1d5ae3(0x208)]){console['log'](_0x1d5ae3(0x25c)+_0x447a64['id']);return;}const _0x5b1436=_0x135b61===_0x1d5ae3(0x252)?_0x1d5ae3(0x22f):_0x1d5ae3(0x206);let _0x56d4c1=[];if(_0x48eab4[_0x1d5ae3(0x24f)])try{_0x56d4c1=Array[_0x1d5ae3(0x254)](_0x48eab4['webhookEvents'])?_0x48eab4[_0x1d5ae3(0x24f)]:JSON[_0x1d5ae3(0x257)](_0x48eab4[_0x1d5ae3(0x24f)]);}catch(_0x2ed6b3){console[_0x1d5ae3(0x25d)]('Error\x20parsing\x20webhook\x20events:',_0x2ed6b3),_0x56d4c1=[];}if(!_0x56d4c1['includes'](_0x5b1436)){console[_0x1d5ae3(0x234)](_0x1d5ae3(0x22d)+_0x5b1436+'\x20not\x20enabled\x20for\x20shop\x20'+_0x447a64['id']);return;}const _0x538ec0={'event':_0x5b1436,'payment':{'id':_0x570f37['id'],'order_id':_0x570f37[_0x1d5ae3(0x200)],'gateway_order_id':_0x570f37[_0x1d5ae3(0x23d)],'gateway':_0x1d5ae3(0x1fa),'amount':_0x570f37['amount'],'currency':_0x570f37[_0x1d5ae3(0x210)],'status':_0x135b61[_0x1d5ae3(0x243)](),'customer_email':_0x570f37['customerEmail'],'customer_name':_0x570f37['customerName'],'transaction_id':_0x506ede,'failure_message':_0x325127,'created_at':_0x570f37[_0x1d5ae3(0x201)],'updated_at':new Date()}},_0x5d880f=await fetch(_0x48eab4[_0x1d5ae3(0x208)],{'method':_0x1d5ae3(0x233),'headers':{'Content-Type':_0x1d5ae3(0x1fc),'User-Agent':_0x1d5ae3(0x236)},'body':JSON[_0x1d5ae3(0x20e)](_0x538ec0)}),_0x171c56=Date['now']()-_0x50340e;console[_0x1d5ae3(0x234)](_0x1d5ae3(0x1e8)+_0x48eab4[_0x1d5ae3(0x208)]+_0x1d5ae3(0x23b)+_0x5d880f[_0x1d5ae3(0x232)]+'\x20('+_0x171c56+'ms)');}catch(_0x2bb4aa){console[_0x1d5ae3(0x25d)](_0x1d5ae3(0x242),_0x2bb4aa);}}async[a15_0x456674(0x24b)](_0xd7398e,_0x4ef755){const _0x32d031=a15_0x456674;try{const {telegramBotService:_0x5b6d0e}=await Promise[_0x32d031(0x214)]()[_0x32d031(0x21f)](()=>__importStar(require(_0x32d031(0x239)))),_0x1b98c2={'PAID':_0x32d031(0x223),'FAILED':_0x32d031(0x237)},_0x235d8c=_0x1b98c2[_0x4ef755];if(!_0x235d8c)return;await _0x5b6d0e[_0x32d031(0x21d)](_0xd7398e[_0x32d031(0x207)],_0xd7398e,_0x235d8c);}catch(_0x2de1e1){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2de1e1);}}}exports[a15_0x456674(0x1f4)]=TestGatewayController;