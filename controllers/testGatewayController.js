'use strict';const a13_0x2a1e3c=a13_0x4f01;(function(_0x168e71,_0x12d517){const _0x4966d3=a13_0x4f01,_0x4a260f=_0x168e71();while(!![]){try{const _0xa1606d=parseInt(_0x4966d3(0x12c))/0x1*(-parseInt(_0x4966d3(0x116))/0x2)+parseInt(_0x4966d3(0x10b))/0x3+-parseInt(_0x4966d3(0xf7))/0x4+parseInt(_0x4966d3(0xde))/0x5*(-parseInt(_0x4966d3(0x12a))/0x6)+-parseInt(_0x4966d3(0x127))/0x7*(-parseInt(_0x4966d3(0x110))/0x8)+parseInt(_0x4966d3(0x103))/0x9*(-parseInt(_0x4966d3(0xdb))/0xa)+parseInt(_0x4966d3(0x12d))/0xb;if(_0xa1606d===_0x12d517)break;else _0x4a260f['push'](_0x4a260f['shift']());}catch(_0x7dbdd4){_0x4a260f['push'](_0x4a260f['shift']());}}}(a13_0x2c13,0xf18b1));function a13_0x2c13(){const _0x210332=['call',',\x20cannot\x20process','getOwnPropertyDescriptor','4439853MHbnVY','orderId','customerName','cardNumber','test_card','16VGgDuL','test_gateway_','Any\x20other\x20card\x20number','shopId','successUrl','payment.failed','6130BPCDLi','\x20not\x20enabled\x20for\x20shop\x20','amount','Payment\x20not\x20found','payment.success','../config/database','ms)','Any\x20name','testGatewayService','length','toLowerCase','settings','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','test_gateway','gateway','create','log','3248686BHjNmg','ðŸ§ª\x20Test\x20Gateway\x20result:','status','42ggETht','Payment\x20failed','542VRppQr','41143894ApngvD','configurable','error','paidAt','failureMessage','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','application/json','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','POST','then','PAID','body','Payment\x20is\x20not\x20for\x20test\x20gateway','failUrl','processCardPayment','webhookEvents','Any\x20future\x20date\x20(MM/YY)','290leXsan','webhookLog','TestGatewayController','1197380basLaX','getOwnPropertyNames','sendPaymentNotification','stringify','default','defineProperty','toISOString','failed','shop','writable','failureReason','webhookService','getPaymentForm','params','Error\x20parsing\x20webhook\x20events:','update','gatewayOrderId','transactionId','cardLast4','__setModuleDefault','slice','customerEmail','parse','json','currency','3373864mVttbG','paymentMethod','FAILED','paid','4242\x204242\x204242\x204242','sendPaymentStatusNotification','name','__esModule','payment','Payment\x20status\x20is\x20','now','findUnique','303552jnolVq','resolve','prototype','webhookUrl','PENDING'];a13_0x2c13=function(){return _0x210332;};return a13_0x2c13();}function a13_0x4f01(_0xda4ef3,_0x2e8bed){const _0x2c1378=a13_0x2c13();return a13_0x4f01=function(_0x4f0122,_0x2866eb){_0x4f0122=_0x4f0122-0xd7;let _0x3ff866=_0x2c1378[_0x4f0122];return _0x3ff866;},a13_0x4f01(_0xda4ef3,_0x2e8bed);}var __createBinding=this&&this['__createBinding']||(Object[a13_0x2a1e3c(0x125)]?function(_0x8d8b31,_0x400e93,_0x11401b,_0xb34e98){const _0x43bd87=a13_0x2a1e3c;if(_0xb34e98===undefined)_0xb34e98=_0x11401b;var _0x5cb1a6=Object[_0x43bd87(0x10a)](_0x400e93,_0x11401b);(!_0x5cb1a6||('get'in _0x5cb1a6?!_0x400e93[_0x43bd87(0xfe)]:_0x5cb1a6[_0x43bd87(0xe7)]||_0x5cb1a6[_0x43bd87(0x12e)]))&&(_0x5cb1a6={'enumerable':!![],'get':function(){return _0x400e93[_0x11401b];}}),Object[_0x43bd87(0xe3)](_0x8d8b31,_0xb34e98,_0x5cb1a6);}:function(_0x29a415,_0x232a3c,_0x368bd9,_0x20809f){if(_0x20809f===undefined)_0x20809f=_0x368bd9;_0x29a415[_0x20809f]=_0x232a3c[_0x368bd9];}),__setModuleDefault=this&&this[a13_0x2a1e3c(0xf1)]||(Object['create']?function(_0x2eaddd,_0x36731e){const _0x2b2c2c=a13_0x2a1e3c;Object[_0x2b2c2c(0xe3)](_0x2eaddd,_0x2b2c2c(0xe2),{'enumerable':!![],'value':_0x36731e});}:function(_0x40b8e3,_0x18dbb3){const _0x3b9be0=a13_0x2a1e3c;_0x40b8e3[_0x3b9be0(0xe2)]=_0x18dbb3;}),__importStar=this&&this['__importStar']||(function(){var _0x4402b5=function(_0x135add){const _0x1899dd=a13_0x4f01;return _0x4402b5=Object[_0x1899dd(0xdf)]||function(_0x5b3bfe){const _0xc54a47=_0x1899dd;var _0x18149a=[];for(var _0x1b39ff in _0x5b3bfe)if(Object[_0xc54a47(0x105)]['hasOwnProperty'][_0xc54a47(0x108)](_0x5b3bfe,_0x1b39ff))_0x18149a[_0x18149a[_0xc54a47(0x11f)]]=_0x1b39ff;return _0x18149a;},_0x4402b5(_0x135add);};return function(_0x33a66b){const _0x3ead67=a13_0x4f01;if(_0x33a66b&&_0x33a66b[_0x3ead67(0xfe)])return _0x33a66b;var _0xcda65e={};if(_0x33a66b!=null){for(var _0x47756c=_0x4402b5(_0x33a66b),_0x34064f=0x0;_0x34064f<_0x47756c[_0x3ead67(0x11f)];_0x34064f++)if(_0x47756c[_0x34064f]!=='default')__createBinding(_0xcda65e,_0x33a66b,_0x47756c[_0x34064f]);}return __setModuleDefault(_0xcda65e,_0x33a66b),_0xcda65e;};}()),__importDefault=this&&this['__importDefault']||function(_0x5b4b2f){const _0x19d0dc=a13_0x2a1e3c;return _0x5b4b2f&&_0x5b4b2f[_0x19d0dc(0xfe)]?_0x5b4b2f:{'default':_0x5b4b2f};};Object[a13_0x2a1e3c(0xe3)](exports,a13_0x2a1e3c(0xfe),{'value':!![]}),exports[a13_0x2a1e3c(0xdd)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x2a1e3c(0x11b)));class TestGatewayController{constructor(){const _0x4cb279=a13_0x2a1e3c;this[_0x4cb279(0xea)]=async(_0x949446,_0xefaa3b,_0x1ecef8)=>{const _0x4f9c70=_0x4cb279;try{const {paymentId:_0x1017f7}=_0x949446[_0x4f9c70(0xeb)];console[_0x4f9c70(0x126)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x1017f7);const _0x473559=await database_1[_0x4f9c70(0xe2)][_0x4f9c70(0xff)][_0x4f9c70(0x102)]({'where':{'id':_0x1017f7},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x473559)return _0xefaa3b[_0x4f9c70(0x129)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x473559[_0x4f9c70(0x124)]!==_0x4f9c70(0x123))return _0xefaa3b[_0x4f9c70(0x129)](0x190)[_0x4f9c70(0xf5)]({'success':![],'message':_0x4f9c70(0x13a)});if(_0x473559[_0x4f9c70(0x129)]!==_0x4f9c70(0x107))return _0xefaa3b['status'](0x190)['json']({'success':![],'message':_0x4f9c70(0x100)+_0x473559[_0x4f9c70(0x129)]+',\x20cannot\x20process'});_0xefaa3b[_0x4f9c70(0xf5)]({'success':!![],'result':{'paymentId':_0x473559['id'],'orderId':_0x473559[_0x4f9c70(0xee)],'amount':_0x473559[_0x4f9c70(0x118)],'currency':_0x473559[_0x4f9c70(0xf6)],'merchantName':_0x473559[_0x4f9c70(0xe6)][_0x4f9c70(0xfd)],'description':'Payment\x20to\x20'+_0x473559[_0x4f9c70(0xe6)][_0x4f9c70(0xfd)],'testInstructions':{'successCard':_0x4f9c70(0xfb),'failureCard':_0x4f9c70(0x112),'expiryDate':_0x4f9c70(0xda),'cvc':'Any\x203-4\x20digits','holderName':_0x4f9c70(0x11d)}}});}catch(_0x4c8989){_0x1ecef8(_0x4c8989);}},this['processCard']=async(_0x2ee75d,_0x169fba,_0x468ba5)=>{const _0x51704f=_0x4cb279;try{const {paymentId:_0x4e8019}=_0x2ee75d[_0x51704f(0xeb)],_0x24000b=_0x2ee75d[_0x51704f(0x139)];console[_0x51704f(0x126)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4e8019);const _0x1a17bb=await database_1[_0x51704f(0xe2)][_0x51704f(0xff)][_0x51704f(0x102)]({'where':{'id':_0x4e8019},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1a17bb)return _0x169fba[_0x51704f(0x129)](0x194)['json']({'success':![],'message':_0x51704f(0x119)});if(_0x1a17bb[_0x51704f(0x124)]!==_0x51704f(0x123))return _0x169fba[_0x51704f(0x129)](0x190)[_0x51704f(0xf5)]({'success':![],'message':_0x51704f(0x13a)});if(_0x1a17bb[_0x51704f(0x129)]!==_0x51704f(0x107))return _0x169fba[_0x51704f(0x129)](0x190)['json']({'success':![],'message':_0x51704f(0x100)+_0x1a17bb[_0x51704f(0x129)]+_0x51704f(0x109)});const _0x1e5c7d=await this['testGatewayService'][_0x51704f(0xd8)]({'paymentId':_0x1a17bb['id'],'orderId':_0x1a17bb[_0x51704f(0xee)]||_0x1a17bb['id'],'amount':_0x1a17bb[_0x51704f(0x118)],'currency':_0x1a17bb[_0x51704f(0xf6)],'cardData':_0x24000b});console[_0x51704f(0x126)](_0x51704f(0x128),_0x1e5c7d);const _0x159ac1={'status':_0x1e5c7d[_0x51704f(0x129)],'updatedAt':new Date()};if(_0x1e5c7d[_0x51704f(0x129)]==='PAID')_0x159ac1[_0x51704f(0x130)]=new Date(),_0x159ac1['gatewayPaymentId']=_0x1e5c7d[_0x51704f(0xef)];else _0x1e5c7d['status']===_0x51704f(0xf9)&&(_0x159ac1[_0x51704f(0x131)]=_0x1e5c7d[_0x51704f(0xe8)]);const _0x162bd2=_0x24000b[_0x51704f(0x10e)]['replace'](/[\s-]/g,'');_0x159ac1[_0x51704f(0xf0)]=_0x162bd2[_0x51704f(0xf2)](-0x4),_0x159ac1[_0x51704f(0xf8)]=_0x51704f(0x10f),await database_1[_0x51704f(0xe2)][_0x51704f(0xff)][_0x51704f(0xed)]({'where':{'id':_0x1a17bb['id']},'data':_0x159ac1}),await database_1[_0x51704f(0xe2)][_0x51704f(0xdc)][_0x51704f(0x125)]({'data':{'paymentId':_0x1a17bb['id'],'shopId':_0x1a17bb[_0x51704f(0x113)],'event':_0x51704f(0x111)+_0x1e5c7d[_0x51704f(0x129)][_0x51704f(0x120)](),'statusCode':0xc8,'responseBody':JSON[_0x51704f(0xe1)]({'oldStatus':'PENDING','newStatus':_0x1e5c7d['status'],'transactionId':_0x1e5c7d[_0x51704f(0xef)],'failureReason':_0x1e5c7d[_0x51704f(0xe8)],'processedAt':new Date()[_0x51704f(0xe4)]()})}}),await this['sendShopWebhook'](_0x1a17bb,_0x1e5c7d[_0x51704f(0x129)],_0x1e5c7d[_0x51704f(0xef)],_0x1e5c7d[_0x51704f(0xe8)]),await this[_0x51704f(0xfc)](_0x1a17bb,_0x1e5c7d[_0x51704f(0x129)]),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x4e8019+'\x20processed:\x20'+_0x1e5c7d[_0x51704f(0x129)]),_0x1e5c7d[_0x51704f(0x129)]===_0x51704f(0x138)?_0x169fba[_0x51704f(0xf5)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x1e5c7d['transactionId'],'redirectUrl':_0x1a17bb[_0x51704f(0x114)]}}):_0x169fba[_0x51704f(0x129)](0x190)['json']({'success':![],'message':_0x51704f(0x12b),'result':{'status':_0x51704f(0xf9),'failureReason':_0x1e5c7d[_0x51704f(0xe8)],'redirectUrl':_0x1a17bb[_0x51704f(0xd7)]}});}catch(_0x435fe9){_0x468ba5(_0x435fe9);}},this[_0x4cb279(0x11e)]=new testGatewayService_1['TestGatewayService'](),this[_0x4cb279(0xe9)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x4aae1d,_0x33d773,_0x447af7,_0x3e1d9b){const _0x5c8227=a13_0x2a1e3c,_0x32d011=Date[_0x5c8227(0x101)]();try{const _0x739343=_0x4aae1d[_0x5c8227(0xe6)],_0x2608be=_0x739343[_0x5c8227(0x121)];if(!_0x2608be?.['webhookUrl']){console['log'](_0x5c8227(0x135)+_0x739343['id']);return;}const _0x217de1=_0x33d773==='PAID'?_0x5c8227(0x11a):_0x5c8227(0x115);let _0x12fff0=[];if(_0x2608be['webhookEvents'])try{_0x12fff0=Array['isArray'](_0x2608be[_0x5c8227(0xd9)])?_0x2608be[_0x5c8227(0xd9)]:JSON[_0x5c8227(0xf4)](_0x2608be['webhookEvents']);}catch(_0x52d985){console['error'](_0x5c8227(0xec),_0x52d985),_0x12fff0=[];}if(!_0x12fff0['includes'](_0x217de1)){console[_0x5c8227(0x126)]('Webhook\x20event\x20'+_0x217de1+_0x5c8227(0x117)+_0x739343['id']);return;}const _0x37b476={'event':_0x217de1,'payment':{'id':_0x4aae1d['id'],'order_id':_0x4aae1d[_0x5c8227(0x10c)],'gateway_order_id':_0x4aae1d[_0x5c8227(0xee)],'gateway':'0000','amount':_0x4aae1d[_0x5c8227(0x118)],'currency':_0x4aae1d[_0x5c8227(0xf6)],'status':_0x33d773[_0x5c8227(0x120)](),'customer_email':_0x4aae1d[_0x5c8227(0xf3)],'customer_name':_0x4aae1d[_0x5c8227(0x10d)],'transaction_id':_0x447af7,'failure_message':_0x3e1d9b,'created_at':_0x4aae1d['createdAt'],'updated_at':new Date()}},_0x5d7e06=await fetch(_0x2608be[_0x5c8227(0x106)],{'method':_0x5c8227(0x136),'headers':{'Content-Type':_0x5c8227(0x133),'User-Agent':_0x5c8227(0x134)},'body':JSON['stringify'](_0x37b476)}),_0x2f837c=Date['now']()-_0x32d011;console[_0x5c8227(0x126)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2608be[_0x5c8227(0x106)]+'\x20with\x20status\x20'+_0x5d7e06[_0x5c8227(0x129)]+'\x20('+_0x2f837c+_0x5c8227(0x11c));}catch(_0xad307f){console[_0x5c8227(0x12f)](_0x5c8227(0x122),_0xad307f);}}async['sendPaymentStatusNotification'](_0x708e57,_0x2b0368){const _0x26c88d=a13_0x2a1e3c;try{const {telegramBotService:_0x5a911f}=await Promise[_0x26c88d(0x104)]()[_0x26c88d(0x137)](()=>__importStar(require('../services/telegramBotService'))),_0x51f905={'PAID':_0x26c88d(0xfa),'FAILED':_0x26c88d(0xe5)},_0x3fbc8d=_0x51f905[_0x2b0368];if(!_0x3fbc8d)return;await _0x5a911f[_0x26c88d(0xe0)](_0x708e57[_0x26c88d(0x113)],_0x708e57,_0x3fbc8d);}catch(_0x3c3578){console['error'](_0x26c88d(0x132),_0x3c3578);}}}exports[a13_0x2a1e3c(0xdd)]=TestGatewayController;