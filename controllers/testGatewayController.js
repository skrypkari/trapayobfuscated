'use strict';const a13_0x558ebb=a13_0x509a;function a13_0x509a(_0x5d62b3,_0x49823a){const _0x288db0=a13_0x288d();return a13_0x509a=function(_0x509ad7,_0x5c53f4){_0x509ad7=_0x509ad7-0x1c7;let _0x35d5ad=_0x288db0[_0x509ad7];return _0x35d5ad;},a13_0x509a(_0x5d62b3,_0x49823a);}(function(_0x10a9db,_0x5a2139){const _0x247f4d=a13_0x509a,_0x2ec8d1=_0x10a9db();while(!![]){try{const _0x5b0409=-parseInt(_0x247f4d(0x1f8))/0x1*(-parseInt(_0x247f4d(0x22b))/0x2)+parseInt(_0x247f4d(0x20a))/0x3*(-parseInt(_0x247f4d(0x1eb))/0x4)+-parseInt(_0x247f4d(0x1ec))/0x5+parseInt(_0x247f4d(0x227))/0x6+-parseInt(_0x247f4d(0x21d))/0x7+parseInt(_0x247f4d(0x1f4))/0x8+parseInt(_0x247f4d(0x1dc))/0x9;if(_0x5b0409===_0x5a2139)break;else _0x2ec8d1['push'](_0x2ec8d1['shift']());}catch(_0x37dc81){_0x2ec8d1['push'](_0x2ec8d1['shift']());}}}(a13_0x288d,0x36a76));var __createBinding=this&&this[a13_0x558ebb(0x216)]||(Object['create']?function(_0x518339,_0xdf5d26,_0x14cc4c,_0x560d81){const _0x145f2e=a13_0x558ebb;if(_0x560d81===undefined)_0x560d81=_0x14cc4c;var _0x353d35=Object[_0x145f2e(0x1c8)](_0xdf5d26,_0x14cc4c);(!_0x353d35||(_0x145f2e(0x1d5)in _0x353d35?!_0xdf5d26[_0x145f2e(0x1d6)]:_0x353d35['writable']||_0x353d35[_0x145f2e(0x1c9)]))&&(_0x353d35={'enumerable':!![],'get':function(){return _0xdf5d26[_0x14cc4c];}}),Object['defineProperty'](_0x518339,_0x560d81,_0x353d35);}:function(_0x4a36d8,_0x1294df,_0x16f512,_0xed8452){if(_0xed8452===undefined)_0xed8452=_0x16f512;_0x4a36d8[_0xed8452]=_0x1294df[_0x16f512];}),__setModuleDefault=this&&this[a13_0x558ebb(0x206)]||(Object[a13_0x558ebb(0x20f)]?function(_0x5e637a,_0x2da1f3){const _0x1540f1=a13_0x558ebb;Object['defineProperty'](_0x5e637a,_0x1540f1(0x205),{'enumerable':!![],'value':_0x2da1f3});}:function(_0x3e7b97,_0x593a39){const _0x3f2c85=a13_0x558ebb;_0x3e7b97[_0x3f2c85(0x205)]=_0x593a39;}),__importStar=this&&this[a13_0x558ebb(0x200)]||(function(){var _0x513b1b=function(_0x1e7442){return _0x513b1b=Object['getOwnPropertyNames']||function(_0x249a4f){const _0x54b18b=a13_0x509a;var _0x216744=[];for(var _0x53467f in _0x249a4f)if(Object[_0x54b18b(0x20e)][_0x54b18b(0x229)][_0x54b18b(0x218)](_0x249a4f,_0x53467f))_0x216744[_0x216744['length']]=_0x53467f;return _0x216744;},_0x513b1b(_0x1e7442);};return function(_0x3228a4){const _0xf286ed=a13_0x509a;if(_0x3228a4&&_0x3228a4[_0xf286ed(0x1d6)])return _0x3228a4;var _0x182a85={};if(_0x3228a4!=null){for(var _0x22d97f=_0x513b1b(_0x3228a4),_0x165e61=0x0;_0x165e61<_0x22d97f[_0xf286ed(0x1d4)];_0x165e61++)if(_0x22d97f[_0x165e61]!==_0xf286ed(0x205))__createBinding(_0x182a85,_0x3228a4,_0x22d97f[_0x165e61]);}return __setModuleDefault(_0x182a85,_0x3228a4),_0x182a85;};}()),__importDefault=this&&this['__importDefault']||function(_0x2158a4){const _0x5bd804=a13_0x558ebb;return _0x2158a4&&_0x2158a4[_0x5bd804(0x1d6)]?_0x2158a4:{'default':_0x2158a4};};Object[a13_0x558ebb(0x1ee)](exports,a13_0x558ebb(0x1d6),{'value':!![]}),exports[a13_0x558ebb(0x20b)]=void 0x0;function a13_0x288d(){const _0x3d4992=['getOwnPropertyDescriptor','configurable','name','cardLast4','now','payment.failed','../services/telegramBotService','âœ…\x20Test\x20Gateway\x20payment\x20','PENDING','ðŸ§ª\x20Test\x20Gateway\x20result:','json','sendShopWebhook','length','get','__esModule','gatewayOrderId','createdAt','parse','webhookLog','Error\x20parsing\x20webhook\x20events:','2702484FEIYir','../services/gateways/testGatewayService','successUrl','testGatewayService','Webhook\x20event\x20','4242\x204242\x204242\x204242','Any\x20other\x20card\x20number','amount','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','update','WebhookService','Test\x20Gateway\x20webhook\x20sent\x20to\x20','payment','params','paymentMethod','32RblsJi','155600kVyJVl','resolve','defineProperty','processCardPayment','error','shop',',\x20cannot\x20process','../services/webhookService','1545664UsAgSN','shopId','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','webhookUrl','87051srYglx','Any\x20name','failureReason','toLowerCase','POST','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PAID','\x20with\x20status\x20','__importStar','gateway','test_card','application/json','slice','default','__setModuleDefault','orderId','sendPaymentStatusNotification','Payment\x20not\x20found','155301fwnvqs','TestGatewayController','failUrl','currency','prototype','create','webhookEvents','Any\x20future\x20date\x20(MM/YY)','Payment\x20processed\x20successfully','Payment\x20status\x20is\x20','0000','findUnique','__createBinding','customerEmail','call','failureMessage','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','log','285194QUZwwp','test_gateway_','test_gateway','stringify','sendPaymentNotification','Payment\x20is\x20not\x20for\x20test\x20gateway','transactionId','includes','Any\x203-4\x20digits','then','775950mVAOvf','FAILED','hasOwnProperty','\x20not\x20enabled\x20for\x20shop\x20','2UcyMzq','status'];a13_0x288d=function(){return _0x3d4992;};return a13_0x288d();}const testGatewayService_1=require(a13_0x558ebb(0x1dd)),webhookService_1=require(a13_0x558ebb(0x1f3)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x28d772=a13_0x558ebb;this['getPaymentForm']=async(_0x46ee88,_0x3a9ae5,_0x53f578)=>{const _0x1fcc02=a13_0x509a;try{const {paymentId:_0x2b9013}=_0x46ee88['params'];console[_0x1fcc02(0x21c)](_0x1fcc02(0x1e4)+_0x2b9013);const _0x460103=await database_1['default'][_0x1fcc02(0x1e8)][_0x1fcc02(0x215)]({'where':{'id':_0x2b9013},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x460103)return _0x3a9ae5[_0x1fcc02(0x1c7)](0x194)[_0x1fcc02(0x1d2)]({'success':![],'message':_0x1fcc02(0x209)});if(_0x460103[_0x1fcc02(0x201)]!=='test_gateway')return _0x3a9ae5['status'](0x190)[_0x1fcc02(0x1d2)]({'success':![],'message':_0x1fcc02(0x222)});if(_0x460103['status']!==_0x1fcc02(0x1d0))return _0x3a9ae5[_0x1fcc02(0x1c7)](0x190)[_0x1fcc02(0x1d2)]({'success':![],'message':_0x1fcc02(0x213)+_0x460103['status']+',\x20cannot\x20process'});_0x3a9ae5[_0x1fcc02(0x1d2)]({'success':!![],'result':{'paymentId':_0x460103['id'],'orderId':_0x460103[_0x1fcc02(0x1d7)],'amount':_0x460103[_0x1fcc02(0x1e3)],'currency':_0x460103[_0x1fcc02(0x20d)],'merchantName':_0x460103[_0x1fcc02(0x1f1)]['name'],'description':'Payment\x20to\x20'+_0x460103[_0x1fcc02(0x1f1)][_0x1fcc02(0x1ca)],'testInstructions':{'successCard':_0x1fcc02(0x1e1),'failureCard':_0x1fcc02(0x1e2),'expiryDate':_0x1fcc02(0x211),'cvc':_0x1fcc02(0x225),'holderName':_0x1fcc02(0x1f9)}}});}catch(_0x452f1d){_0x53f578(_0x452f1d);}},this['processCard']=async(_0x5dc6c7,_0x4b5f90,_0x48a3a0)=>{const _0x2468c7=a13_0x509a;try{const {paymentId:_0x5014b8}=_0x5dc6c7[_0x2468c7(0x1e9)],_0x1b7f68=_0x5dc6c7['body'];console[_0x2468c7(0x21c)](_0x2468c7(0x21a)+_0x5014b8);const _0x523d17=await database_1[_0x2468c7(0x205)][_0x2468c7(0x1e8)][_0x2468c7(0x215)]({'where':{'id':_0x5014b8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x523d17)return _0x4b5f90[_0x2468c7(0x1c7)](0x194)[_0x2468c7(0x1d2)]({'success':![],'message':_0x2468c7(0x209)});if(_0x523d17[_0x2468c7(0x201)]!==_0x2468c7(0x21f))return _0x4b5f90[_0x2468c7(0x1c7)](0x190)['json']({'success':![],'message':_0x2468c7(0x222)});if(_0x523d17[_0x2468c7(0x1c7)]!=='PENDING')return _0x4b5f90[_0x2468c7(0x1c7)](0x190)[_0x2468c7(0x1d2)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x523d17[_0x2468c7(0x1c7)]+_0x2468c7(0x1f2)});const _0x20c966=await this[_0x2468c7(0x1df)][_0x2468c7(0x1ef)]({'paymentId':_0x523d17['id'],'orderId':_0x523d17['gatewayOrderId']||_0x523d17['id'],'amount':_0x523d17[_0x2468c7(0x1e3)],'currency':_0x523d17[_0x2468c7(0x20d)],'cardData':_0x1b7f68});console['log'](_0x2468c7(0x1d1),_0x20c966);const _0x224687={'status':_0x20c966[_0x2468c7(0x1c7)],'updatedAt':new Date()};if(_0x20c966['status']===_0x2468c7(0x1fe))_0x224687['paidAt']=new Date(),_0x224687['gatewayPaymentId']=_0x20c966['transactionId'];else _0x20c966[_0x2468c7(0x1c7)]===_0x2468c7(0x228)&&(_0x224687[_0x2468c7(0x219)]=_0x20c966['failureReason']);const _0x5cf086=_0x1b7f68['cardNumber']['replace'](/[\s-]/g,'');_0x224687[_0x2468c7(0x1cb)]=_0x5cf086[_0x2468c7(0x204)](-0x4),_0x224687[_0x2468c7(0x1ea)]=_0x2468c7(0x202),await database_1[_0x2468c7(0x205)]['payment'][_0x2468c7(0x1e5)]({'where':{'id':_0x523d17['id']},'data':_0x224687}),await database_1[_0x2468c7(0x205)][_0x2468c7(0x1da)]['create']({'data':{'paymentId':_0x523d17['id'],'shopId':_0x523d17[_0x2468c7(0x1f5)],'event':_0x2468c7(0x21e)+_0x20c966[_0x2468c7(0x1c7)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2468c7(0x220)]({'oldStatus':_0x2468c7(0x1d0),'newStatus':_0x20c966[_0x2468c7(0x1c7)],'transactionId':_0x20c966['transactionId'],'failureReason':_0x20c966[_0x2468c7(0x1fa)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x523d17,_0x20c966[_0x2468c7(0x1c7)],_0x20c966['transactionId'],_0x20c966[_0x2468c7(0x1fa)]),await this[_0x2468c7(0x208)](_0x523d17,_0x20c966[_0x2468c7(0x1c7)]),console[_0x2468c7(0x21c)](_0x2468c7(0x1cf)+_0x5014b8+'\x20processed:\x20'+_0x20c966[_0x2468c7(0x1c7)]),_0x20c966['status']===_0x2468c7(0x1fe)?_0x4b5f90[_0x2468c7(0x1d2)]({'success':!![],'message':_0x2468c7(0x212),'result':{'status':_0x2468c7(0x1fe),'transactionId':_0x20c966[_0x2468c7(0x223)],'redirectUrl':_0x523d17[_0x2468c7(0x1de)]}}):_0x4b5f90[_0x2468c7(0x1c7)](0x190)[_0x2468c7(0x1d2)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x20c966[_0x2468c7(0x1fa)],'redirectUrl':_0x523d17[_0x2468c7(0x20c)]}});}catch(_0x4d91ec){_0x48a3a0(_0x4d91ec);}},this[_0x28d772(0x1df)]=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1[(_0x28d772(0x1e6))]();}async[a13_0x558ebb(0x1d3)](_0x4ff344,_0x1d3911,_0xbad5c2,_0x11340b){const _0x4e8215=a13_0x558ebb,_0x501bf3=Date[_0x4e8215(0x1cc)]();try{const _0x5654a0=_0x4ff344['shop'],_0x3803bb=_0x5654a0['settings'];if(!_0x3803bb?.[_0x4e8215(0x1f7)]){console[_0x4e8215(0x21c)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5654a0['id']);return;}const _0x30fb63=_0x1d3911===_0x4e8215(0x1fe)?'payment.success':_0x4e8215(0x1cd);let _0x3b8977=[];if(_0x3803bb[_0x4e8215(0x210)])try{_0x3b8977=Array['isArray'](_0x3803bb[_0x4e8215(0x210)])?_0x3803bb[_0x4e8215(0x210)]:JSON[_0x4e8215(0x1d9)](_0x3803bb[_0x4e8215(0x210)]);}catch(_0x3ceead){console['error'](_0x4e8215(0x1db),_0x3ceead),_0x3b8977=[];}if(!_0x3b8977[_0x4e8215(0x224)](_0x30fb63)){console[_0x4e8215(0x21c)](_0x4e8215(0x1e0)+_0x30fb63+_0x4e8215(0x22a)+_0x5654a0['id']);return;}const _0x36ccf4={'event':_0x30fb63,'payment':{'id':_0x4ff344['id'],'order_id':_0x4ff344[_0x4e8215(0x207)],'gateway_order_id':_0x4ff344[_0x4e8215(0x1d7)],'gateway':_0x4e8215(0x214),'amount':_0x4ff344[_0x4e8215(0x1e3)],'currency':_0x4ff344[_0x4e8215(0x20d)],'status':_0x1d3911[_0x4e8215(0x1fb)](),'customer_email':_0x4ff344[_0x4e8215(0x217)],'customer_name':_0x4ff344['customerName'],'transaction_id':_0xbad5c2,'failure_message':_0x11340b,'created_at':_0x4ff344[_0x4e8215(0x1d8)],'updated_at':new Date()}},_0x1d7c4c=await fetch(_0x3803bb[_0x4e8215(0x1f7)],{'method':_0x4e8215(0x1fc),'headers':{'Content-Type':_0x4e8215(0x203),'User-Agent':_0x4e8215(0x1f6)},'body':JSON[_0x4e8215(0x220)](_0x36ccf4)}),_0x326eeb=Date[_0x4e8215(0x1cc)]()-_0x501bf3;console[_0x4e8215(0x21c)](_0x4e8215(0x1e7)+_0x3803bb[_0x4e8215(0x1f7)]+_0x4e8215(0x1ff)+_0x1d7c4c[_0x4e8215(0x1c7)]+'\x20('+_0x326eeb+'ms)');}catch(_0x2b79d2){console[_0x4e8215(0x1f0)](_0x4e8215(0x21b),_0x2b79d2);}}async[a13_0x558ebb(0x208)](_0x47aab3,_0x2ca1e8){const _0x702022=a13_0x558ebb;try{const {telegramBotService:_0x4a1482}=await Promise[_0x702022(0x1ed)]()[_0x702022(0x226)](()=>__importStar(require(_0x702022(0x1ce)))),_0x41157={'PAID':'paid','FAILED':'failed'},_0x3df76a=_0x41157[_0x2ca1e8];if(!_0x3df76a)return;await _0x4a1482[_0x702022(0x221)](_0x47aab3[_0x702022(0x1f5)],_0x47aab3,_0x3df76a);}catch(_0x492e47){console[_0x702022(0x1f0)](_0x702022(0x1fd),_0x492e47);}}}exports[a13_0x558ebb(0x20b)]=TestGatewayController;