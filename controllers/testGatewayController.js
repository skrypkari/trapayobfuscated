'use strict';const a13_0x50c6a5=a13_0x2cbf;(function(_0x3ae048,_0x4b9c66){const _0x2614be=a13_0x2cbf,_0x472d9f=_0x3ae048();while(!![]){try{const _0x3df5e7=-parseInt(_0x2614be(0x144))/0x1+-parseInt(_0x2614be(0x170))/0x2*(parseInt(_0x2614be(0x129))/0x3)+parseInt(_0x2614be(0x153))/0x4*(-parseInt(_0x2614be(0x11f))/0x5)+parseInt(_0x2614be(0x131))/0x6+parseInt(_0x2614be(0x12d))/0x7+-parseInt(_0x2614be(0x188))/0x8*(-parseInt(_0x2614be(0x12b))/0x9)+parseInt(_0x2614be(0x189))/0xa;if(_0x3df5e7===_0x4b9c66)break;else _0x472d9f['push'](_0x472d9f['shift']());}catch(_0x58adb3){_0x472d9f['push'](_0x472d9f['shift']());}}}(a13_0x28e2,0x34f69));function a13_0x2cbf(_0x2c9192,_0x29b296){const _0x28e230=a13_0x28e2();return a13_0x2cbf=function(_0x2cbf51,_0x52c10d){_0x2cbf51=_0x2cbf51-0x10d;let _0xc8f664=_0x28e230[_0x2cbf51];return _0xc8f664;},a13_0x2cbf(_0x2c9192,_0x29b296);}var __createBinding=this&&this[a13_0x50c6a5(0x11b)]||(Object['create']?function(_0x1e7f94,_0x20eefb,_0x2c4791,_0x408119){const _0x5ef9ac=a13_0x50c6a5;if(_0x408119===undefined)_0x408119=_0x2c4791;var _0x17004a=Object[_0x5ef9ac(0x173)](_0x20eefb,_0x2c4791);(!_0x17004a||(_0x5ef9ac(0x135)in _0x17004a?!_0x20eefb[_0x5ef9ac(0x14b)]:_0x17004a[_0x5ef9ac(0x130)]||_0x17004a[_0x5ef9ac(0x154)]))&&(_0x17004a={'enumerable':!![],'get':function(){return _0x20eefb[_0x2c4791];}}),Object[_0x5ef9ac(0x17c)](_0x1e7f94,_0x408119,_0x17004a);}:function(_0x58ee79,_0x3210b4,_0x287ffb,_0x3e99f8){if(_0x3e99f8===undefined)_0x3e99f8=_0x287ffb;_0x58ee79[_0x3e99f8]=_0x3210b4[_0x287ffb];}),__setModuleDefault=this&&this[a13_0x50c6a5(0x115)]||(Object[a13_0x50c6a5(0x134)]?function(_0x2ef0d9,_0x527a98){const _0x5d4405=a13_0x50c6a5;Object[_0x5d4405(0x17c)](_0x2ef0d9,_0x5d4405(0x126),{'enumerable':!![],'value':_0x527a98});}:function(_0x50e035,_0x2dbea2){const _0x2ed174=a13_0x50c6a5;_0x50e035[_0x2ed174(0x126)]=_0x2dbea2;}),__importStar=this&&this[a13_0x50c6a5(0x12a)]||(function(){var _0x42f496=function(_0x4e9c31){const _0x1f2e50=a13_0x2cbf;return _0x42f496=Object[_0x1f2e50(0x124)]||function(_0x32fd4b){const _0x13d5da=_0x1f2e50;var _0x23db8a=[];for(var _0x2e3b03 in _0x32fd4b)if(Object[_0x13d5da(0x17b)][_0x13d5da(0x10e)][_0x13d5da(0x174)](_0x32fd4b,_0x2e3b03))_0x23db8a[_0x23db8a['length']]=_0x2e3b03;return _0x23db8a;},_0x42f496(_0x4e9c31);};return function(_0x120947){const _0x30fc03=a13_0x2cbf;if(_0x120947&&_0x120947[_0x30fc03(0x14b)])return _0x120947;var _0x16d387={};if(_0x120947!=null){for(var _0x149ee3=_0x42f496(_0x120947),_0x121d96=0x0;_0x121d96<_0x149ee3[_0x30fc03(0x185)];_0x121d96++)if(_0x149ee3[_0x121d96]!==_0x30fc03(0x126))__createBinding(_0x16d387,_0x120947,_0x149ee3[_0x121d96]);}return __setModuleDefault(_0x16d387,_0x120947),_0x16d387;};}()),__importDefault=this&&this[a13_0x50c6a5(0x16d)]||function(_0x36c5ac){const _0x3e77fe=a13_0x50c6a5;return _0x36c5ac&&_0x36c5ac[_0x3e77fe(0x14b)]?_0x36c5ac:{'default':_0x36c5ac};};Object[a13_0x50c6a5(0x17c)](exports,a13_0x50c6a5(0x14b),{'value':!![]}),exports[a13_0x50c6a5(0x15a)]=void 0x0;const testGatewayService_1=require(a13_0x50c6a5(0x17a)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x50c6a5(0x166)));function a13_0x28e2(){const _0x233536=['❌\x20Payment\x20link\x20','now','Payment\x20processed\x20successfully','Payment\x20not\x20found','isArray','webhookLog','__esModule','0000','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20',':\x20type=','Payment\x20is\x20not\x20for\x20test\x20gateway','webhookEvents','Error\x20parsing\x20webhook\x20events:','../services/telegramBotService','28pWzpKq','configurable','FAILED','POST','WebhookService','payment.success','paymentLinkId','TestGatewayController','PAID','TestGatewayService','update','orderId','Any\x20name',',\x20cannot\x20process','gateway','currency','resolve','sendPaymentStatusNotification','parse','../config/database','processCard','paidAt','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','shopId','includes','SINGLE','__importDefault','📈\x20Found\x20payment\x20link\x20',',\x20currentPayments=','26482tfqrhc','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','✅\x20Test\x20Gateway\x20payment\x20','getOwnPropertyDescriptor','call','webhookService','amount','stringify','PENDING','transactionId','../services/gateways/testGatewayService','prototype','defineProperty','\x20->\x20','paymentLink','Payment\x20failed',',\x20status=','gatewayPaymentId','settings','application/json','\x20updated:\x20currentPayments=','length','\x20not\x20found','cardLast4','637928eZozkT','2569880OVvrbU','Payment\x20status\x20is\x20','paid','processCardPayment','error','payment','replace','hasOwnProperty','Test\x20Gateway\x20webhook\x20sent\x20to\x20','then','toLowerCase','\x20not\x20enabled\x20for\x20shop\x20','log','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','__setModuleDefault','currentPayments','cardNumber','Any\x203-4\x20digits','params','COMPLETED','__createBinding','4242\x204242\x204242\x204242','customerEmail','📈\x20Test\x20Gateway:\x20Payment\x20','99555lLYmAI','findUnique','testGatewayService','status','failUrl','getOwnPropertyNames','gatewayOrderId','default','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failureReason','57ZcYsac','__importStar','9sToOLV','name','1069656WkZdIL','test_gateway_','ms)','writable','1090632uDnCIx','$transaction','failureMessage','create','get','payment.failed','slice','type','body','\x20processed:\x20','toISOString','paymentMethod','sendShopWebhook','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','webhookUrl','getPaymentForm','shop','json','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','63416TUmoqm'];a13_0x28e2=function(){return _0x233536;};return a13_0x28e2();}class TestGatewayController{constructor(){const _0x3afd33=a13_0x50c6a5;this[_0x3afd33(0x140)]=async(_0x4bcfae,_0x1b47a4,_0x1f6205)=>{const _0x38434e=_0x3afd33;try{const {paymentId:_0x3f970c}=_0x4bcfae['params'];console[_0x38434e(0x113)](_0x38434e(0x127)+_0x3f970c);const _0x15cf58=await database_1[_0x38434e(0x126)][_0x38434e(0x18e)][_0x38434e(0x120)]({'where':{'id':_0x3f970c},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x15cf58)return _0x1b47a4[_0x38434e(0x122)](0x194)[_0x38434e(0x142)]({'success':![],'message':_0x38434e(0x148)});if(_0x15cf58['gateway']!=='test_gateway')return _0x1b47a4['status'](0x190)[_0x38434e(0x142)]({'success':![],'message':_0x38434e(0x14f)});if(_0x15cf58[_0x38434e(0x122)]!==_0x38434e(0x178))return _0x1b47a4[_0x38434e(0x122)](0x190)[_0x38434e(0x142)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x15cf58[_0x38434e(0x122)]+_0x38434e(0x160)});_0x1b47a4[_0x38434e(0x142)]({'success':!![],'result':{'paymentId':_0x15cf58['id'],'orderId':_0x15cf58[_0x38434e(0x125)],'amount':_0x15cf58['amount'],'currency':_0x15cf58[_0x38434e(0x162)],'merchantName':_0x15cf58[_0x38434e(0x141)]['name'],'description':'Payment\x20to\x20'+_0x15cf58[_0x38434e(0x141)][_0x38434e(0x12c)],'testInstructions':{'successCard':_0x38434e(0x11c),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x38434e(0x118),'holderName':_0x38434e(0x15f)}}});}catch(_0x3332ad){_0x1f6205(_0x3332ad);}},this[_0x3afd33(0x167)]=async(_0x1f1ce1,_0xbbe9b3,_0x190dac)=>{const _0x1068fd=_0x3afd33;try{const {paymentId:_0x2d3ab0}=_0x1f1ce1[_0x1068fd(0x119)],_0xc82c65=_0x1f1ce1[_0x1068fd(0x139)];console[_0x1068fd(0x113)](_0x1068fd(0x13e)+_0x2d3ab0);const _0x4475b0=await database_1[_0x1068fd(0x126)]['payment'][_0x1068fd(0x120)]({'where':{'id':_0x2d3ab0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4475b0)return _0xbbe9b3[_0x1068fd(0x122)](0x194)[_0x1068fd(0x142)]({'success':![],'message':_0x1068fd(0x148)});if(_0x4475b0[_0x1068fd(0x161)]!=='test_gateway')return _0xbbe9b3[_0x1068fd(0x122)](0x190)[_0x1068fd(0x142)]({'success':![],'message':_0x1068fd(0x14f)});if(_0x4475b0['status']!==_0x1068fd(0x178))return _0xbbe9b3['status'](0x190)['json']({'success':![],'message':_0x1068fd(0x18a)+_0x4475b0[_0x1068fd(0x122)]+_0x1068fd(0x160)});const _0x1327a5=await this[_0x1068fd(0x121)][_0x1068fd(0x18c)]({'paymentId':_0x4475b0['id'],'orderId':_0x4475b0['gatewayOrderId']||_0x4475b0['id'],'amount':_0x4475b0[_0x1068fd(0x176)],'currency':_0x4475b0['currency'],'cardData':_0xc82c65});console[_0x1068fd(0x113)]('🧪\x20Test\x20Gateway\x20result:',_0x1327a5);const _0x2c34c3={'status':_0x1327a5['status'],'updatedAt':new Date()};if(_0x1327a5[_0x1068fd(0x122)]===_0x1068fd(0x15b))_0x2c34c3[_0x1068fd(0x168)]=new Date(),_0x2c34c3[_0x1068fd(0x181)]=_0x1327a5[_0x1068fd(0x179)];else _0x1327a5[_0x1068fd(0x122)]===_0x1068fd(0x155)&&(_0x2c34c3[_0x1068fd(0x133)]=_0x1327a5[_0x1068fd(0x128)]);const _0x250039=_0xc82c65[_0x1068fd(0x117)][_0x1068fd(0x10d)](/[\s-]/g,'');_0x2c34c3[_0x1068fd(0x187)]=_0x250039[_0x1068fd(0x137)](-0x4),_0x2c34c3[_0x1068fd(0x13c)]='test_card',await database_1[_0x1068fd(0x126)][_0x1068fd(0x18e)][_0x1068fd(0x15d)]({'where':{'id':_0x4475b0['id']},'data':_0x2c34c3});if(_0x1327a5[_0x1068fd(0x122)]==='PAID'&&_0x4475b0[_0x1068fd(0x159)]){console[_0x1068fd(0x113)](_0x1068fd(0x11e)+_0x4475b0['id']+_0x1068fd(0x169));try{await database_1[_0x1068fd(0x126)][_0x1068fd(0x132)](async _0x5e8614=>{const _0x35838d=_0x1068fd,_0x16ff21=await _0x5e8614[_0x35838d(0x17e)][_0x35838d(0x120)]({'where':{'id':_0x4475b0[_0x35838d(0x159)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x16ff21){console[_0x35838d(0x113)](_0x35838d(0x16e)+_0x16ff21['id']+_0x35838d(0x14e)+_0x16ff21['type']+_0x35838d(0x16f)+_0x16ff21[_0x35838d(0x116)]+_0x35838d(0x180)+_0x16ff21['status']);const _0xb10dd=_0x16ff21[_0x35838d(0x116)]+0x1,_0x38f077=_0x16ff21[_0x35838d(0x138)]===_0x35838d(0x16c)?_0x35838d(0x11a):_0x16ff21['status'];await _0x5e8614[_0x35838d(0x17e)][_0x35838d(0x15d)]({'where':{'id':_0x4475b0['paymentLinkId']},'data':{'currentPayments':_0xb10dd,'status':_0x38f077,'updatedAt':new Date()}}),console[_0x35838d(0x113)]('✅\x20Payment\x20link\x20'+_0x16ff21['id']+_0x35838d(0x184)+_0x16ff21[_0x35838d(0x116)]+_0x35838d(0x17d)+_0xb10dd+_0x35838d(0x180)+_0x16ff21[_0x35838d(0x122)]+'\x20->\x20'+_0x38f077);}else console[_0x35838d(0x113)](_0x35838d(0x145)+_0x4475b0[_0x35838d(0x159)]+_0x35838d(0x186));});}catch(_0x39bed8){console[_0x1068fd(0x18d)](_0x1068fd(0x171),_0x39bed8);}}await database_1[_0x1068fd(0x126)][_0x1068fd(0x14a)][_0x1068fd(0x134)]({'data':{'paymentId':_0x4475b0['id'],'shopId':_0x4475b0[_0x1068fd(0x16a)],'event':_0x1068fd(0x12e)+_0x1327a5[_0x1068fd(0x122)][_0x1068fd(0x111)](),'statusCode':0xc8,'responseBody':JSON[_0x1068fd(0x177)]({'oldStatus':_0x1068fd(0x178),'newStatus':_0x1327a5[_0x1068fd(0x122)],'transactionId':_0x1327a5[_0x1068fd(0x179)],'failureReason':_0x1327a5[_0x1068fd(0x128)],'processedAt':new Date()[_0x1068fd(0x13b)]()})}}),await this[_0x1068fd(0x13d)](_0x4475b0,_0x1327a5[_0x1068fd(0x122)],_0x1327a5[_0x1068fd(0x179)],_0x1327a5['failureReason']),await this['sendPaymentStatusNotification'](_0x4475b0,_0x1327a5['status']),console[_0x1068fd(0x113)](_0x1068fd(0x172)+_0x2d3ab0+_0x1068fd(0x13a)+_0x1327a5[_0x1068fd(0x122)]),_0x1327a5[_0x1068fd(0x122)]===_0x1068fd(0x15b)?_0xbbe9b3[_0x1068fd(0x142)]({'success':!![],'message':_0x1068fd(0x147),'result':{'status':_0x1068fd(0x15b),'transactionId':_0x1327a5[_0x1068fd(0x179)],'redirectUrl':_0x4475b0['successUrl']}}):_0xbbe9b3[_0x1068fd(0x122)](0x190)[_0x1068fd(0x142)]({'success':![],'message':_0x1068fd(0x17f),'result':{'status':'FAILED','failureReason':_0x1327a5[_0x1068fd(0x128)],'redirectUrl':_0x4475b0[_0x1068fd(0x123)]}});}catch(_0x47192b){_0x190dac(_0x47192b);}},this[_0x3afd33(0x121)]=new testGatewayService_1[(_0x3afd33(0x15c))](),this[_0x3afd33(0x175)]=new webhookService_1[(_0x3afd33(0x157))]();}async[a13_0x50c6a5(0x13d)](_0xec3049,_0x1376d4,_0x3bdaa7,_0x291e7d){const _0xa54a2d=a13_0x50c6a5,_0x30a498=Date[_0xa54a2d(0x146)]();try{const _0x7829c0=_0xec3049[_0xa54a2d(0x141)],_0x192d01=_0x7829c0[_0xa54a2d(0x182)];if(!_0x192d01?.['webhookUrl']){console[_0xa54a2d(0x113)](_0xa54a2d(0x14d)+_0x7829c0['id']);return;}const _0x13002f=_0x1376d4===_0xa54a2d(0x15b)?_0xa54a2d(0x158):_0xa54a2d(0x136);let _0x13e02e=[];if(_0x192d01['webhookEvents'])try{_0x13e02e=Array[_0xa54a2d(0x149)](_0x192d01['webhookEvents'])?_0x192d01[_0xa54a2d(0x150)]:JSON[_0xa54a2d(0x165)](_0x192d01[_0xa54a2d(0x150)]);}catch(_0x1fd058){console['error'](_0xa54a2d(0x151),_0x1fd058),_0x13e02e=[];}if(!_0x13e02e[_0xa54a2d(0x16b)](_0x13002f)){console[_0xa54a2d(0x113)]('Webhook\x20event\x20'+_0x13002f+_0xa54a2d(0x112)+_0x7829c0['id']);return;}const _0x590175={'event':_0x13002f,'payment':{'id':_0xec3049['id'],'order_id':_0xec3049[_0xa54a2d(0x15e)],'gateway_order_id':_0xec3049['gatewayOrderId'],'gateway':_0xa54a2d(0x14c),'amount':_0xec3049[_0xa54a2d(0x176)],'currency':_0xec3049['currency'],'status':_0x1376d4['toLowerCase'](),'customer_email':_0xec3049[_0xa54a2d(0x11d)],'customer_name':_0xec3049['customerName'],'transaction_id':_0x3bdaa7,'failure_message':_0x291e7d,'created_at':_0xec3049['createdAt'],'updated_at':new Date()}},_0x4ff119=await fetch(_0x192d01[_0xa54a2d(0x13f)],{'method':_0xa54a2d(0x156),'headers':{'Content-Type':_0xa54a2d(0x183),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0xa54a2d(0x177)](_0x590175)}),_0x175572=Date[_0xa54a2d(0x146)]()-_0x30a498;console[_0xa54a2d(0x113)](_0xa54a2d(0x10f)+_0x192d01['webhookUrl']+'\x20with\x20status\x20'+_0x4ff119[_0xa54a2d(0x122)]+'\x20('+_0x175572+_0xa54a2d(0x12f));}catch(_0x5c84b9){console[_0xa54a2d(0x18d)](_0xa54a2d(0x143),_0x5c84b9);}}async[a13_0x50c6a5(0x164)](_0x343b53,_0x560c4f){const _0x3de6be=a13_0x50c6a5;try{const {telegramBotService:_0x5ecbab}=await Promise[_0x3de6be(0x163)]()[_0x3de6be(0x110)](()=>__importStar(require(_0x3de6be(0x152)))),_0x6edc47={'PAID':_0x3de6be(0x18b),'FAILED':'failed'},_0x7320a9=_0x6edc47[_0x560c4f];if(!_0x7320a9)return;await _0x5ecbab['sendPaymentNotification'](_0x343b53[_0x3de6be(0x16a)],_0x343b53,_0x7320a9);}catch(_0x54da96){console[_0x3de6be(0x18d)](_0x3de6be(0x114),_0x54da96);}}}exports['TestGatewayController']=TestGatewayController;