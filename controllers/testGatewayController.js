'use strict';const a14_0x939a27=a14_0x8f96;function a14_0x2afd(){const _0x1b27a9=['slice','amount','4242\x204242\x204242\x204242','POST','Payment\x20status\x20is\x20','Any\x20future\x20date\x20(MM/YY)','length','Error\x20parsing\x20webhook\x20events:','customerName','__esModule','WebhookService','paymentLinkId','body','cardLast4','testGatewayService','__importStar','hasOwnProperty','__createBinding','name','getOwnPropertyDescriptor','../config/database','12TxcNra','findUnique','Payment\x20processed\x20successfully','\x20updated:\x20currentPayments=','270419qAbweZ','PENDING','error','7KSenhs','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','parse','\x20with\x20status\x20','payment.success','526074obQieG','ms)','sendPaymentStatusNotification','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','0000','type','Payment\x20failed','Payment\x20System/1.0\x20(Test\x20Gateway)','cardNumber','$transaction','update','Payment\x20to\x20','TestGatewayService','__importDefault','transactionId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','status','toISOString','../services/gateways/testGatewayService','paymentLink','\x20->\x20','üß™\x20Test\x20Gateway\x20result:','getOwnPropertyNames','defineProperty','Payment\x20is\x20not\x20for\x20test\x20gateway','createdAt','currentPayments','üìà\x20Test\x20Gateway:\x20Payment\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','log','call','settings','FAILED','json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','‚ùå\x20Payment\x20link\x20','449212JXXdxL','configurable','sendShopWebhook','__setModuleDefault','41060GLpADF','create','processCard','‚úÖ\x20Test\x20Gateway\x20payment\x20','payment','get','now','failUrl','2459898obYIDX','application/json','getPaymentForm','prototype','2141760nOzrqm','webhookEvents','stringify','../services/telegramBotService','../services/webhookService','test_gateway_','params','Payment\x20not\x20found','shopId',',\x20status=','Any\x20name','shop','webhookUrl','customerEmail','SINGLE','906725zCizzI','successUrl','sendPaymentNotification','paidAt','gatewayPaymentId','Any\x203-4\x20digits','failureMessage','isArray','default','COMPLETED','‚úÖ\x20Payment\x20link\x20','then','Any\x20other\x20card\x20number','resolve','Webhook\x20event\x20','PAID','TestGatewayController','\x20not\x20found','toLowerCase','webhookService','payment.failed','currency','failureReason','webhookLog','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','396UmKGJZ','gatewayOrderId','test_gateway','orderId'];a14_0x2afd=function(){return _0x1b27a9;};return a14_0x2afd();}(function(_0x1545ef,_0x5442a9){const _0xdd9bed=a14_0x8f96,_0x420c72=_0x1545ef();while(!![]){try{const _0x233169=parseInt(_0xdd9bed(0xf0))/0x1+-parseInt(_0xdd9bed(0xf8))/0x2+parseInt(_0xdd9bed(0xec))/0x3*(-parseInt(_0xdd9bed(0x9b))/0x4)+parseInt(_0xdd9bed(0xba))/0x5+parseInt(_0xdd9bed(0xa7))/0x6*(parseInt(_0xdd9bed(0xf3))/0x7)+parseInt(_0xdd9bed(0xab))/0x8+-parseInt(_0xdd9bed(0xd3))/0x9*(parseInt(_0xdd9bed(0x9f))/0xa);if(_0x233169===_0x5442a9)break;else _0x420c72['push'](_0x420c72['shift']());}catch(_0x40d885){_0x420c72['push'](_0x420c72['shift']());}}}(a14_0x2afd,0x39c0a));var __createBinding=this&&this[a14_0x939a27(0xe8)]||(Object[a14_0x939a27(0xa0)]?function(_0x35b512,_0x1ec279,_0x2ef33b,_0x2513f6){const _0x2d34be=a14_0x939a27;if(_0x2513f6===undefined)_0x2513f6=_0x2ef33b;var _0x38b97f=Object[_0x2d34be(0xea)](_0x1ec279,_0x2ef33b);(!_0x38b97f||(_0x2d34be(0xa4)in _0x38b97f?!_0x1ec279[_0x2d34be(0xe0)]:_0x38b97f['writable']||_0x38b97f[_0x2d34be(0x9c)]))&&(_0x38b97f={'enumerable':!![],'get':function(){return _0x1ec279[_0x2ef33b];}}),Object[_0x2d34be(0x8e)](_0x35b512,_0x2513f6,_0x38b97f);}:function(_0x5dcd39,_0x5111cf,_0x278786,_0x18e1bc){if(_0x18e1bc===undefined)_0x18e1bc=_0x278786;_0x5dcd39[_0x18e1bc]=_0x5111cf[_0x278786];}),__setModuleDefault=this&&this[a14_0x939a27(0x9e)]||(Object[a14_0x939a27(0xa0)]?function(_0x4d7ea9,_0x4c69b7){const _0x2bac44=a14_0x939a27;Object[_0x2bac44(0x8e)](_0x4d7ea9,_0x2bac44(0xc2),{'enumerable':!![],'value':_0x4c69b7});}:function(_0x36f618,_0x35a1b7){_0x36f618['default']=_0x35a1b7;}),__importStar=this&&this[a14_0x939a27(0xe6)]||(function(){var _0x21aed0=function(_0x2bbb59){const _0x40e58a=a14_0x8f96;return _0x21aed0=Object[_0x40e58a(0x8d)]||function(_0xb2fd1){const _0x3981d0=_0x40e58a;var _0x5c9909=[];for(var _0x57f2fc in _0xb2fd1)if(Object[_0x3981d0(0xaa)][_0x3981d0(0xe7)][_0x3981d0(0x95)](_0xb2fd1,_0x57f2fc))_0x5c9909[_0x5c9909[_0x3981d0(0xdd)]]=_0x57f2fc;return _0x5c9909;},_0x21aed0(_0x2bbb59);};return function(_0x10ff3a){const _0x350eb7=a14_0x8f96;if(_0x10ff3a&&_0x10ff3a[_0x350eb7(0xe0)])return _0x10ff3a;var _0x9a86a1={};if(_0x10ff3a!=null){for(var _0x7805b8=_0x21aed0(_0x10ff3a),_0x2dbbae=0x0;_0x2dbbae<_0x7805b8[_0x350eb7(0xdd)];_0x2dbbae++)if(_0x7805b8[_0x2dbbae]!==_0x350eb7(0xc2))__createBinding(_0x9a86a1,_0x10ff3a,_0x7805b8[_0x2dbbae]);}return __setModuleDefault(_0x9a86a1,_0x10ff3a),_0x9a86a1;};}()),__importDefault=this&&this[a14_0x939a27(0x105)]||function(_0x31c68e){return _0x31c68e&&_0x31c68e['__esModule']?_0x31c68e:{'default':_0x31c68e};};function a14_0x8f96(_0x41e873,_0x358b84){const _0x2afd9e=a14_0x2afd();return a14_0x8f96=function(_0x8f96ba,_0x2e1469){_0x8f96ba=_0x8f96ba-0x88;let _0x193fa5=_0x2afd9e[_0x8f96ba];return _0x193fa5;},a14_0x8f96(_0x41e873,_0x358b84);}Object[a14_0x939a27(0x8e)](exports,a14_0x939a27(0xe0),{'value':!![]}),exports[a14_0x939a27(0xca)]=void 0x0;const testGatewayService_1=require(a14_0x939a27(0x89)),webhookService_1=require(a14_0x939a27(0xaf)),database_1=__importDefault(require(a14_0x939a27(0xeb)));class TestGatewayController{constructor(){const _0x1e0949=a14_0x939a27;this[_0x1e0949(0xa9)]=async(_0x2ee8eb,_0x212c24,_0x42b650)=>{const _0x8085fa=_0x1e0949;try{const {paymentId:_0x391741}=_0x2ee8eb[_0x8085fa(0xb1)];console[_0x8085fa(0x94)](_0x8085fa(0xfb)+_0x391741);const _0x24ef78=await database_1[_0x8085fa(0xc2)]['payment'][_0x8085fa(0xed)]({'where':{'id':_0x391741},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x24ef78)return _0x212c24['status'](0x194)['json']({'success':![],'message':_0x8085fa(0xb2)});if(_0x24ef78['gateway']!==_0x8085fa(0xd5))return _0x212c24[_0x8085fa(0x108)](0x190)[_0x8085fa(0x98)]({'success':![],'message':_0x8085fa(0x8f)});if(_0x24ef78[_0x8085fa(0x108)]!==_0x8085fa(0xf1))return _0x212c24[_0x8085fa(0x108)](0x190)[_0x8085fa(0x98)]({'success':![],'message':_0x8085fa(0xdb)+_0x24ef78[_0x8085fa(0x108)]+',\x20cannot\x20process'});_0x212c24['json']({'success':!![],'result':{'paymentId':_0x24ef78['id'],'orderId':_0x24ef78['gatewayOrderId'],'amount':_0x24ef78[_0x8085fa(0xd8)],'currency':_0x24ef78[_0x8085fa(0xcf)],'merchantName':_0x24ef78[_0x8085fa(0xb6)]['name'],'description':_0x8085fa(0x103)+_0x24ef78[_0x8085fa(0xb6)][_0x8085fa(0xe9)],'testInstructions':{'successCard':_0x8085fa(0xd9),'failureCard':_0x8085fa(0xc6),'expiryDate':_0x8085fa(0xdc),'cvc':_0x8085fa(0xbf),'holderName':_0x8085fa(0xb5)}}});}catch(_0x426173){_0x42b650(_0x426173);}},this[_0x1e0949(0xa1)]=async(_0x192762,_0x374b87,_0x1792ff)=>{const _0x538248=_0x1e0949;try{const {paymentId:_0x4a62dc}=_0x192762[_0x538248(0xb1)],_0xa76543=_0x192762[_0x538248(0xe3)];console['log'](_0x538248(0x93)+_0x4a62dc);const _0x4b557d=await database_1['default'][_0x538248(0xa3)]['findUnique']({'where':{'id':_0x4a62dc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4b557d)return _0x374b87[_0x538248(0x108)](0x194)[_0x538248(0x98)]({'success':![],'message':_0x538248(0xb2)});if(_0x4b557d['gateway']!=='test_gateway')return _0x374b87[_0x538248(0x108)](0x190)[_0x538248(0x98)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4b557d[_0x538248(0x108)]!==_0x538248(0xf1))return _0x374b87[_0x538248(0x108)](0x190)[_0x538248(0x98)]({'success':![],'message':_0x538248(0xdb)+_0x4b557d[_0x538248(0x108)]+',\x20cannot\x20process'});const _0x43d887=await this[_0x538248(0xe5)]['processCardPayment']({'paymentId':_0x4b557d['id'],'orderId':_0x4b557d['gatewayOrderId']||_0x4b557d['id'],'amount':_0x4b557d['amount'],'currency':_0x4b557d['currency'],'cardData':_0xa76543});console[_0x538248(0x94)](_0x538248(0x8c),_0x43d887);const _0x22af5e={'status':_0x43d887[_0x538248(0x108)],'updatedAt':new Date()};if(_0x43d887[_0x538248(0x108)]===_0x538248(0xc9))_0x22af5e[_0x538248(0xbd)]=new Date(),_0x22af5e[_0x538248(0xbe)]=_0x43d887[_0x538248(0x106)];else _0x43d887[_0x538248(0x108)]===_0x538248(0x97)&&(_0x22af5e[_0x538248(0xc0)]=_0x43d887[_0x538248(0xd0)]);const _0x597ef8=_0xa76543[_0x538248(0x100)]['replace'](/[\s-]/g,'');_0x22af5e[_0x538248(0xe4)]=_0x597ef8[_0x538248(0xd7)](-0x4),_0x22af5e['paymentMethod']='test_card',await database_1[_0x538248(0xc2)][_0x538248(0xa3)][_0x538248(0x102)]({'where':{'id':_0x4b557d['id']},'data':_0x22af5e});if(_0x43d887[_0x538248(0x108)]===_0x538248(0xc9)&&_0x4b557d[_0x538248(0xe2)]){console[_0x538248(0x94)](_0x538248(0x92)+_0x4b557d['id']+_0x538248(0xd2));try{await database_1[_0x538248(0xc2)][_0x538248(0x101)](async _0x3ee9b6=>{const _0x25c0de=_0x538248,_0x244dee=await _0x3ee9b6[_0x25c0de(0x8a)][_0x25c0de(0xed)]({'where':{'id':_0x4b557d[_0x25c0de(0xe2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x244dee){console[_0x25c0de(0x94)]('üìà\x20Found\x20payment\x20link\x20'+_0x244dee['id']+':\x20type='+_0x244dee[_0x25c0de(0xfd)]+',\x20currentPayments='+_0x244dee[_0x25c0de(0x91)]+_0x25c0de(0xb4)+_0x244dee['status']);const _0x341236=_0x244dee[_0x25c0de(0x91)]+0x1,_0x3cfbd8=_0x244dee[_0x25c0de(0xfd)]===_0x25c0de(0xb9)?_0x25c0de(0xc3):_0x244dee['status'];await _0x3ee9b6[_0x25c0de(0x8a)][_0x25c0de(0x102)]({'where':{'id':_0x4b557d[_0x25c0de(0xe2)]},'data':{'currentPayments':_0x341236,'status':_0x3cfbd8,'updatedAt':new Date()}}),console[_0x25c0de(0x94)](_0x25c0de(0xc4)+_0x244dee['id']+_0x25c0de(0xef)+_0x244dee[_0x25c0de(0x91)]+_0x25c0de(0x8b)+_0x341236+',\x20status='+_0x244dee[_0x25c0de(0x108)]+'\x20->\x20'+_0x3cfbd8);}else console[_0x25c0de(0x94)](_0x25c0de(0x9a)+_0x4b557d['paymentLinkId']+_0x25c0de(0xcb));});}catch(_0x5f1474){console[_0x538248(0xf2)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x5f1474);}}await database_1['default'][_0x538248(0xd1)][_0x538248(0xa0)]({'data':{'paymentId':_0x4b557d['id'],'shopId':_0x4b557d[_0x538248(0xb3)],'event':_0x538248(0xb0)+_0x43d887[_0x538248(0x108)][_0x538248(0xcc)](),'statusCode':0xc8,'responseBody':JSON[_0x538248(0xad)]({'oldStatus':_0x538248(0xf1),'newStatus':_0x43d887[_0x538248(0x108)],'transactionId':_0x43d887['transactionId'],'failureReason':_0x43d887[_0x538248(0xd0)],'processedAt':new Date()[_0x538248(0x88)]()})}}),await this[_0x538248(0x9d)](_0x4b557d,_0x43d887['status'],_0x43d887['transactionId'],_0x43d887[_0x538248(0xd0)]),await this[_0x538248(0xfa)](_0x4b557d,_0x43d887[_0x538248(0x108)]),console[_0x538248(0x94)](_0x538248(0xa2)+_0x4a62dc+'\x20processed:\x20'+_0x43d887[_0x538248(0x108)]),_0x43d887[_0x538248(0x108)]==='PAID'?_0x374b87['json']({'success':!![],'message':_0x538248(0xee),'result':{'status':_0x538248(0xc9),'transactionId':_0x43d887[_0x538248(0x106)],'redirectUrl':_0x4b557d[_0x538248(0xbb)]}}):_0x374b87['status'](0x190)[_0x538248(0x98)]({'success':![],'message':_0x538248(0xfe),'result':{'status':_0x538248(0x97),'failureReason':_0x43d887[_0x538248(0xd0)],'redirectUrl':_0x4b557d[_0x538248(0xa6)]}});}catch(_0x548ae6){_0x1792ff(_0x548ae6);}},this[_0x1e0949(0xe5)]=new testGatewayService_1[(_0x1e0949(0x104))](),this[_0x1e0949(0xcd)]=new webhookService_1[(_0x1e0949(0xe1))]();}async[a14_0x939a27(0x9d)](_0x406a6a,_0x2bcbf2,_0x59ffae,_0x3e89fd){const _0x966a5e=a14_0x939a27,_0x217155=Date[_0x966a5e(0xa5)]();try{const _0xf06142=_0x406a6a[_0x966a5e(0xb6)],_0x16c15e=_0xf06142[_0x966a5e(0x96)];if(!_0x16c15e?.[_0x966a5e(0xb7)]){console['log'](_0x966a5e(0x99)+_0xf06142['id']);return;}const _0x3035e4=_0x2bcbf2===_0x966a5e(0xc9)?_0x966a5e(0xf7):_0x966a5e(0xce);let _0x34c2b7=[];if(_0x16c15e['webhookEvents'])try{_0x34c2b7=Array[_0x966a5e(0xc1)](_0x16c15e[_0x966a5e(0xac)])?_0x16c15e['webhookEvents']:JSON[_0x966a5e(0xf5)](_0x16c15e[_0x966a5e(0xac)]);}catch(_0x4c931e){console['error'](_0x966a5e(0xde),_0x4c931e),_0x34c2b7=[];}if(!_0x34c2b7['includes'](_0x3035e4)){console[_0x966a5e(0x94)](_0x966a5e(0xc8)+_0x3035e4+'\x20not\x20enabled\x20for\x20shop\x20'+_0xf06142['id']);return;}const _0x357890={'event':_0x3035e4,'payment':{'id':_0x406a6a['id'],'order_id':_0x406a6a[_0x966a5e(0xd6)],'gateway_order_id':_0x406a6a[_0x966a5e(0xd4)],'gateway':_0x966a5e(0xfc),'amount':_0x406a6a[_0x966a5e(0xd8)],'currency':_0x406a6a[_0x966a5e(0xcf)],'status':_0x2bcbf2[_0x966a5e(0xcc)](),'customer_email':_0x406a6a[_0x966a5e(0xb8)],'customer_name':_0x406a6a[_0x966a5e(0xdf)],'transaction_id':_0x59ffae,'failure_message':_0x3e89fd,'created_at':_0x406a6a[_0x966a5e(0x90)],'updated_at':new Date()}},_0x281af1=await fetch(_0x16c15e[_0x966a5e(0xb7)],{'method':_0x966a5e(0xda),'headers':{'Content-Type':_0x966a5e(0xa8),'User-Agent':_0x966a5e(0xff)},'body':JSON[_0x966a5e(0xad)](_0x357890)}),_0x52d52e=Date[_0x966a5e(0xa5)]()-_0x217155;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x16c15e[_0x966a5e(0xb7)]+_0x966a5e(0xf6)+_0x281af1[_0x966a5e(0x108)]+'\x20('+_0x52d52e+_0x966a5e(0xf9));}catch(_0x49bda8){console[_0x966a5e(0xf2)](_0x966a5e(0xf4),_0x49bda8);}}async[a14_0x939a27(0xfa)](_0x74abcd,_0x1f18de){const _0x48fe50=a14_0x939a27;try{const {telegramBotService:_0x5d637c}=await Promise[_0x48fe50(0xc7)]()[_0x48fe50(0xc5)](()=>__importStar(require(_0x48fe50(0xae)))),_0x2339f0={'PAID':'paid','FAILED':'failed'},_0x555ee6=_0x2339f0[_0x1f18de];if(!_0x555ee6)return;await _0x5d637c[_0x48fe50(0xbc)](_0x74abcd['shopId'],_0x74abcd,_0x555ee6);}catch(_0x47789d){console[_0x48fe50(0xf2)](_0x48fe50(0x107),_0x47789d);}}}exports[a14_0x939a27(0xca)]=TestGatewayController;