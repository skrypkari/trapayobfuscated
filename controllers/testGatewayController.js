'use strict';const a13_0xf91cc7=a13_0x528b;(function(_0x212a5f,_0x42e59f){const _0x423b7a=a13_0x528b,_0x1530e6=_0x212a5f();while(!![]){try{const _0x240c91=-parseInt(_0x423b7a(0x1e3))/0x1+parseInt(_0x423b7a(0x208))/0x2*(parseInt(_0x423b7a(0x1f8))/0x3)+-parseInt(_0x423b7a(0x1bf))/0x4*(parseInt(_0x423b7a(0x206))/0x5)+-parseInt(_0x423b7a(0x1c0))/0x6+parseInt(_0x423b7a(0x1e7))/0x7+-parseInt(_0x423b7a(0x21a))/0x8+-parseInt(_0x423b7a(0x1c1))/0x9*(-parseInt(_0x423b7a(0x1b8))/0xa);if(_0x240c91===_0x42e59f)break;else _0x1530e6['push'](_0x1530e6['shift']());}catch(_0x4172a6){_0x1530e6['push'](_0x1530e6['shift']());}}}(a13_0x3297,0xe8b1b));function a13_0x528b(_0xdfd4fb,_0x52502e){const _0x3297be=a13_0x3297();return a13_0x528b=function(_0x528b74,_0x1d2eee){_0x528b74=_0x528b74-0x1b0;let _0x1b0065=_0x3297be[_0x528b74];return _0x1b0065;},a13_0x528b(_0xdfd4fb,_0x52502e);}var __createBinding=this&&this[a13_0xf91cc7(0x1d7)]||(Object[a13_0xf91cc7(0x1c6)]?function(_0x145072,_0x2fa445,_0x3c2d0d,_0x48608c){const _0x4423dd=a13_0xf91cc7;if(_0x48608c===undefined)_0x48608c=_0x3c2d0d;var _0x257fa1=Object[_0x4423dd(0x1db)](_0x2fa445,_0x3c2d0d);(!_0x257fa1||('get'in _0x257fa1?!_0x2fa445[_0x4423dd(0x1ce)]:_0x257fa1[_0x4423dd(0x1bb)]||_0x257fa1[_0x4423dd(0x21c)]))&&(_0x257fa1={'enumerable':!![],'get':function(){return _0x2fa445[_0x3c2d0d];}}),Object[_0x4423dd(0x200)](_0x145072,_0x48608c,_0x257fa1);}:function(_0x46f3b4,_0x264e84,_0x8d4f72,_0x2287c6){if(_0x2287c6===undefined)_0x2287c6=_0x8d4f72;_0x46f3b4[_0x2287c6]=_0x264e84[_0x8d4f72];}),__setModuleDefault=this&&this[a13_0xf91cc7(0x1f4)]||(Object['create']?function(_0x45b1a6,_0x155ec1){const _0x1accff=a13_0xf91cc7;Object[_0x1accff(0x200)](_0x45b1a6,_0x1accff(0x1b2),{'enumerable':!![],'value':_0x155ec1});}:function(_0x495154,_0x46c263){const _0x9ba8c5=a13_0xf91cc7;_0x495154[_0x9ba8c5(0x1b2)]=_0x46c263;}),__importStar=this&&this[a13_0xf91cc7(0x1c8)]||(function(){var _0x2a17c8=function(_0x411d29){return _0x2a17c8=Object['getOwnPropertyNames']||function(_0x682cf1){const _0x848527=a13_0x528b;var _0x800009=[];for(var _0x2d2122 in _0x682cf1)if(Object[_0x848527(0x21b)][_0x848527(0x1b5)]['call'](_0x682cf1,_0x2d2122))_0x800009[_0x800009[_0x848527(0x1d9)]]=_0x2d2122;return _0x800009;},_0x2a17c8(_0x411d29);};return function(_0x51bb6e){const _0x1546af=a13_0x528b;if(_0x51bb6e&&_0x51bb6e['__esModule'])return _0x51bb6e;var _0xacea3c={};if(_0x51bb6e!=null){for(var _0xa33dd1=_0x2a17c8(_0x51bb6e),_0x2c3f4f=0x0;_0x2c3f4f<_0xa33dd1[_0x1546af(0x1d9)];_0x2c3f4f++)if(_0xa33dd1[_0x2c3f4f]!==_0x1546af(0x1b2))__createBinding(_0xacea3c,_0x51bb6e,_0xa33dd1[_0x2c3f4f]);}return __setModuleDefault(_0xacea3c,_0x51bb6e),_0xacea3c;};}()),__importDefault=this&&this['__importDefault']||function(_0x184e53){const _0x32862d=a13_0xf91cc7;return _0x184e53&&_0x184e53[_0x32862d(0x1ce)]?_0x184e53:{'default':_0x184e53};};Object[a13_0xf91cc7(0x200)](exports,a13_0xf91cc7(0x1ce),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0xf91cc7(0x1f5)),webhookService_1=require(a13_0xf91cc7(0x219)),database_1=__importDefault(require(a13_0xf91cc7(0x1ee)));class TestGatewayController{constructor(){const _0x179d78=a13_0xf91cc7;this['getPaymentForm']=async(_0x78fc0f,_0x325617,_0x434380)=>{const _0x593987=a13_0x528b;try{const {paymentId:_0x54d814}=_0x78fc0f['params'];console[_0x593987(0x204)](_0x593987(0x1c2)+_0x54d814);const _0x49897c=await database_1['default']['payment'][_0x593987(0x207)]({'where':{'id':_0x54d814},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x49897c)return _0x325617[_0x593987(0x229)](0x194)[_0x593987(0x1eb)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x49897c[_0x593987(0x20d)]!=='test_gateway')return _0x325617[_0x593987(0x229)](0x190)[_0x593987(0x1eb)]({'success':![],'message':_0x593987(0x1e8)});if(_0x49897c[_0x593987(0x229)]!==_0x593987(0x1e4))return _0x325617[_0x593987(0x229)](0x190)[_0x593987(0x1eb)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x49897c[_0x593987(0x229)]+_0x593987(0x227)});_0x325617[_0x593987(0x1eb)]({'success':!![],'result':{'paymentId':_0x49897c['id'],'orderId':_0x49897c['gatewayOrderId'],'amount':_0x49897c['amount'],'currency':_0x49897c[_0x593987(0x212)],'merchantName':_0x49897c[_0x593987(0x1e0)][_0x593987(0x203)],'description':_0x593987(0x226)+_0x49897c[_0x593987(0x1e0)][_0x593987(0x203)],'testInstructions':{'successCard':_0x593987(0x1d6),'failureCard':_0x593987(0x1da),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x593987(0x1dc),'holderName':'Any\x20name'}}});}catch(_0x121aad){_0x434380(_0x121aad);}},this[_0x179d78(0x1fb)]=async(_0x119ad0,_0x3be00c,_0xb870c2)=>{const _0x2f2070=_0x179d78;try{const {paymentId:_0x3018b0}=_0x119ad0['params'],_0x3fedd7=_0x119ad0[_0x2f2070(0x1de)];console[_0x2f2070(0x204)](_0x2f2070(0x1bc)+_0x3018b0);const _0x2ee201=await database_1[_0x2f2070(0x1b2)][_0x2f2070(0x1b9)][_0x2f2070(0x207)]({'where':{'id':_0x3018b0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ee201)return _0x3be00c[_0x2f2070(0x229)](0x194)[_0x2f2070(0x1eb)]({'success':![],'message':_0x2f2070(0x1b6)});if(_0x2ee201['gateway']!=='test_gateway')return _0x3be00c[_0x2f2070(0x229)](0x190)[_0x2f2070(0x1eb)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2ee201[_0x2f2070(0x229)]!==_0x2f2070(0x1e4))return _0x3be00c[_0x2f2070(0x229)](0x190)[_0x2f2070(0x1eb)]({'success':![],'message':_0x2f2070(0x224)+_0x2ee201[_0x2f2070(0x229)]+_0x2f2070(0x227)});const _0x2af8b0=await this['testGatewayService'][_0x2f2070(0x223)]({'paymentId':_0x2ee201['id'],'orderId':_0x2ee201[_0x2f2070(0x1e6)]||_0x2ee201['id'],'amount':_0x2ee201[_0x2f2070(0x1fd)],'currency':_0x2ee201[_0x2f2070(0x212)],'cardData':_0x3fedd7});console[_0x2f2070(0x204)]('üß™\x20Test\x20Gateway\x20result:',_0x2af8b0);const _0x532d1d={'status':_0x2af8b0[_0x2f2070(0x229)],'updatedAt':new Date()};if(_0x2af8b0[_0x2f2070(0x229)]===_0x2f2070(0x1f0))_0x532d1d['paidAt']=new Date(),_0x532d1d[_0x2f2070(0x228)]=_0x2af8b0[_0x2f2070(0x1fa)];else _0x2af8b0['status']==='FAILED'&&(_0x532d1d[_0x2f2070(0x209)]=_0x2af8b0['failureReason']);const _0x314d77=_0x3fedd7[_0x2f2070(0x1c7)][_0x2f2070(0x1cc)](/[\s-]/g,'');_0x532d1d[_0x2f2070(0x1b0)]=_0x314d77[_0x2f2070(0x1e1)](-0x4),_0x532d1d[_0x2f2070(0x1f6)]=_0x2f2070(0x215),await database_1[_0x2f2070(0x1b2)][_0x2f2070(0x1b9)][_0x2f2070(0x20b)]({'where':{'id':_0x2ee201['id']},'data':_0x532d1d});if(_0x2af8b0[_0x2f2070(0x229)]===_0x2f2070(0x1f0)&&_0x2ee201[_0x2f2070(0x1dd)]){console[_0x2f2070(0x204)](_0x2f2070(0x1c5)+_0x2ee201['id']+_0x2f2070(0x1e2));try{await database_1['default'][_0x2f2070(0x1c9)](async _0x32e99a=>{const _0x39c56e=_0x2f2070,_0x4f9fac=await _0x32e99a[_0x39c56e(0x1bd)][_0x39c56e(0x207)]({'where':{'id':_0x2ee201['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4f9fac){console['log'](_0x39c56e(0x1d2)+_0x4f9fac['id']+_0x39c56e(0x201)+_0x4f9fac[_0x39c56e(0x1be)]+_0x39c56e(0x216)+_0x4f9fac[_0x39c56e(0x21d)]+_0x39c56e(0x1d1)+_0x4f9fac[_0x39c56e(0x229)]);const _0xe72f64=_0x4f9fac[_0x39c56e(0x21d)]+0x1,_0x5a6d0a=_0x4f9fac[_0x39c56e(0x1be)]===_0x39c56e(0x210)?'COMPLETED':_0x4f9fac[_0x39c56e(0x229)];await _0x32e99a['paymentLink']['update']({'where':{'id':_0x2ee201['paymentLinkId']},'data':{'currentPayments':_0xe72f64,'status':_0x5a6d0a,'updatedAt':new Date()}}),console[_0x39c56e(0x204)](_0x39c56e(0x1fc)+_0x4f9fac['id']+_0x39c56e(0x220)+_0x4f9fac[_0x39c56e(0x21d)]+_0x39c56e(0x217)+_0xe72f64+_0x39c56e(0x1d1)+_0x4f9fac['status']+_0x39c56e(0x217)+_0x5a6d0a);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x2ee201[_0x39c56e(0x1dd)]+_0x39c56e(0x20c));});}catch(_0x1974e2){console[_0x2f2070(0x1cb)](_0x2f2070(0x211),_0x1974e2);}}await database_1[_0x2f2070(0x1b2)][_0x2f2070(0x1ba)][_0x2f2070(0x1c6)]({'data':{'paymentId':_0x2ee201['id'],'shopId':_0x2ee201[_0x2f2070(0x1ed)],'event':_0x2f2070(0x1c3)+_0x2af8b0[_0x2f2070(0x229)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2f2070(0x1df)]({'oldStatus':'PENDING','newStatus':_0x2af8b0[_0x2f2070(0x229)],'transactionId':_0x2af8b0['transactionId'],'failureReason':_0x2af8b0[_0x2f2070(0x1b4)],'processedAt':new Date()[_0x2f2070(0x1d4)]()})}}),await this[_0x2f2070(0x21f)](_0x2ee201,_0x2af8b0[_0x2f2070(0x229)],_0x2af8b0['transactionId'],_0x2af8b0[_0x2f2070(0x1b4)]),await this[_0x2f2070(0x1d0)](_0x2ee201,_0x2af8b0[_0x2f2070(0x229)]),console[_0x2f2070(0x204)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x3018b0+_0x2f2070(0x1f3)+_0x2af8b0[_0x2f2070(0x229)]),_0x2af8b0[_0x2f2070(0x229)]===_0x2f2070(0x1f0)?_0x3be00c['json']({'success':!![],'message':_0x2f2070(0x1f9),'result':{'status':_0x2f2070(0x1f0),'transactionId':_0x2af8b0[_0x2f2070(0x1fa)],'redirectUrl':_0x2ee201[_0x2f2070(0x1c4)]}}):_0x3be00c['status'](0x190)[_0x2f2070(0x1eb)]({'success':![],'message':_0x2f2070(0x20f),'result':{'status':'FAILED','failureReason':_0x2af8b0[_0x2f2070(0x1b4)],'redirectUrl':_0x2ee201[_0x2f2070(0x1d3)]}});}catch(_0x4558d7){_0xb870c2(_0x4558d7);}},this['testGatewayService']=new testGatewayService_1[(_0x179d78(0x1f7))](),this[_0x179d78(0x1d8)]=new webhookService_1[(_0x179d78(0x1fe))]();}async['sendShopWebhook'](_0x2aef1e,_0x1b8da5,_0x2f1e71,_0x3d8192){const _0x161ff8=a13_0xf91cc7,_0x3e7d70=Date['now']();try{const _0x2cb1d4=_0x2aef1e[_0x161ff8(0x1e0)],_0x1bf5f2=_0x2cb1d4[_0x161ff8(0x1d5)];if(!_0x1bf5f2?.[_0x161ff8(0x225)]){console[_0x161ff8(0x204)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2cb1d4['id']);return;}const _0x1a9efe=_0x1b8da5===_0x161ff8(0x1f0)?_0x161ff8(0x214):_0x161ff8(0x1cf);let _0x1f00b9=[];if(_0x1bf5f2[_0x161ff8(0x218)])try{_0x1f00b9=Array[_0x161ff8(0x1cd)](_0x1bf5f2[_0x161ff8(0x218)])?_0x1bf5f2[_0x161ff8(0x218)]:JSON['parse'](_0x1bf5f2[_0x161ff8(0x218)]);}catch(_0x3a13d2){console['error'](_0x161ff8(0x21e),_0x3a13d2),_0x1f00b9=[];}if(!_0x1f00b9[_0x161ff8(0x1b3)](_0x1a9efe)){console[_0x161ff8(0x204)]('Webhook\x20event\x20'+_0x1a9efe+_0x161ff8(0x221)+_0x2cb1d4['id']);return;}const _0x119165={'event':_0x1a9efe,'payment':{'id':_0x2aef1e['id'],'order_id':_0x2aef1e[_0x161ff8(0x20a)],'gateway_order_id':_0x2aef1e[_0x161ff8(0x1e6)],'gateway':_0x161ff8(0x1b1),'amount':_0x2aef1e['amount'],'currency':_0x2aef1e[_0x161ff8(0x212)],'status':_0x1b8da5['toLowerCase'](),'customer_email':_0x2aef1e[_0x161ff8(0x1ec)],'customer_name':_0x2aef1e[_0x161ff8(0x1ef)],'transaction_id':_0x2f1e71,'failure_message':_0x3d8192,'created_at':_0x2aef1e[_0x161ff8(0x20e)],'updated_at':new Date()}},_0x1d063f=await fetch(_0x1bf5f2['webhookUrl'],{'method':_0x161ff8(0x1e9),'headers':{'Content-Type':_0x161ff8(0x202),'User-Agent':_0x161ff8(0x1b7)},'body':JSON[_0x161ff8(0x1df)](_0x119165)}),_0x82ca7e=Date[_0x161ff8(0x1e5)]()-_0x3e7d70;console[_0x161ff8(0x204)](_0x161ff8(0x222)+_0x1bf5f2[_0x161ff8(0x225)]+'\x20with\x20status\x20'+_0x1d063f[_0x161ff8(0x229)]+'\x20('+_0x82ca7e+_0x161ff8(0x1ca));}catch(_0x51bb9a){console[_0x161ff8(0x1cb)](_0x161ff8(0x205),_0x51bb9a);}}async['sendPaymentStatusNotification'](_0x36b438,_0x4e6d32){const _0xf8aa44=a13_0xf91cc7;try{const {telegramBotService:_0x54f92a}=await Promise['resolve']()[_0xf8aa44(0x1ff)](()=>__importStar(require('../services/telegramBotService'))),_0x398cfd={'PAID':_0xf8aa44(0x213),'FAILED':_0xf8aa44(0x1f1)},_0x1db3a3=_0x398cfd[_0x4e6d32];if(!_0x1db3a3)return;await _0x54f92a['sendPaymentNotification'](_0x36b438[_0xf8aa44(0x1ed)],_0x36b438,_0x1db3a3);}catch(_0x2282de){console[_0xf8aa44(0x1cb)](_0xf8aa44(0x1f2),_0x2282de);}}}function a13_0x3297(){const _0x28e726=['length','Any\x20other\x20card\x20number','getOwnPropertyDescriptor','Any\x203-4\x20digits','paymentLinkId','body','stringify','shop','slice','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','1379251wIDPeO','PENDING','now','gatewayOrderId','1095829CCUoeS','Payment\x20is\x20not\x20for\x20test\x20gateway','POST','TestGatewayController','json','customerEmail','shopId','../config/database','customerName','PAID','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20processed:\x20','__setModuleDefault','../services/gateways/testGatewayService','paymentMethod','TestGatewayService','1895466DPiWPw','Payment\x20processed\x20successfully','transactionId','processCard','‚úÖ\x20Payment\x20link\x20','amount','WebhookService','then','defineProperty',':\x20type=','application/json','name','log','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','9605OCWzff','findUnique','4oFxCCu','failureMessage','orderId','update','\x20not\x20found','gateway','createdAt','Payment\x20failed','SINGLE','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','currency','paid','payment.success','test_card',',\x20currentPayments=','\x20->\x20','webhookEvents','../services/webhookService','2036256YFhKHE','prototype','configurable','currentPayments','Error\x20parsing\x20webhook\x20events:','sendShopWebhook','\x20updated:\x20currentPayments=','\x20not\x20enabled\x20for\x20shop\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','processCardPayment','Payment\x20status\x20is\x20','webhookUrl','Payment\x20to\x20',',\x20cannot\x20process','gatewayPaymentId','status','cardLast4','0000','default','includes','failureReason','hasOwnProperty','Payment\x20not\x20found','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','6150BhqoDl','payment','webhookLog','writable','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paymentLink','type','996HqLlIh','3196074BmdAXn','31869LlVbCJ','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','test_gateway_','successUrl','üìà\x20Test\x20Gateway:\x20Payment\x20','create','cardNumber','__importStar','$transaction','ms)','error','replace','isArray','__esModule','payment.failed','sendPaymentStatusNotification',',\x20status=','üìà\x20Found\x20payment\x20link\x20','failUrl','toISOString','settings','4242\x204242\x204242\x204242','__createBinding','webhookService'];a13_0x3297=function(){return _0x28e726;};return a13_0x3297();}exports[a13_0xf91cc7(0x1ea)]=TestGatewayController;