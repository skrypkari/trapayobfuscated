'use strict';const a13_0x1b2204=a13_0x235b;(function(_0x4f6451,_0x28cfef){const _0x7944b8=a13_0x235b,_0x8994f9=_0x4f6451();while(!![]){try{const _0x2cd2c9=parseInt(_0x7944b8(0x166))/0x1+-parseInt(_0x7944b8(0x152))/0x2*(parseInt(_0x7944b8(0x156))/0x3)+-parseInt(_0x7944b8(0x133))/0x4*(-parseInt(_0x7944b8(0x15b))/0x5)+parseInt(_0x7944b8(0x106))/0x6+parseInt(_0x7944b8(0x123))/0x7*(-parseInt(_0x7944b8(0x13f))/0x8)+parseInt(_0x7944b8(0x120))/0x9+parseInt(_0x7944b8(0x114))/0xa*(-parseInt(_0x7944b8(0x100))/0xb);if(_0x2cd2c9===_0x28cfef)break;else _0x8994f9['push'](_0x8994f9['shift']());}catch(_0x4b92d8){_0x8994f9['push'](_0x8994f9['shift']());}}}(a13_0x53e5,0x8996d));function a13_0x53e5(){const _0x6082b5=['4147440tywYMw','Payment\x20processed\x20successfully','isArray','resolve','failureMessage','shopId','create','log','\x20not\x20enabled\x20for\x20shop\x20','Any\x20future\x20date\x20(MM/YY)','Any\x20name','payment.success','Test\x20Gateway\x20webhook\x20sent\x20to\x20','toLowerCase','6161530CrdLcP','test_card','webhookLog','WebhookService','orderId','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x20other\x20card\x20number','status','Any\x203-4\x20digits','../config/database','../services/gateways/testGatewayService','amount','8105634NRyupJ','TestGatewayController','test_gateway_','3878pgDuUY','findUnique','Payment\x20failed','successUrl','getPaymentForm','gatewayPaymentId',',\x20cannot\x20process','cardLast4','then','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getOwnPropertyNames','Payment\x20to\x20','Error\x20parsing\x20webhook\x20events:','update','paymentMethod','Webhook\x20event\x20','207752emmoYT','now','__importDefault','testGatewayService','PAID','cardNumber','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','body','__createBinding','default','slice','customerEmail','12680uUyJyn','sendPaymentStatusNotification','createdAt','\x20processed:\x20','json','customerName','processCard','../services/telegramBotService','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','prototype','paid','params','shop','parse','PENDING','ms)','processCardPayment','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','gatewayOrderId','6twtQvn','writable','\x20with\x20status\x20','getOwnPropertyDescriptor','675723rRgQut','stringify','webhookUrl','0000','transactionId','105bGFyxH','includes','error','__esModule','payment','FAILED','defineProperty','failureReason','currency','failed','call','50967QajFWs','configurable','__setModuleDefault','__importStar','Payment\x20not\x20found','11WWbEEY','get','webhookEvents','gateway','replace','length'];a13_0x53e5=function(){return _0x6082b5;};return a13_0x53e5();}function a13_0x235b(_0x39fcf4,_0x5a9650){const _0x53e5ea=a13_0x53e5();return a13_0x235b=function(_0x235b20,_0x4b1807){_0x235b20=_0x235b20-0xfe;let _0x2c1fa5=_0x53e5ea[_0x235b20];return _0x2c1fa5;},a13_0x235b(_0x39fcf4,_0x5a9650);}var __createBinding=this&&this[a13_0x1b2204(0x13b)]||(Object[a13_0x1b2204(0x10c)]?function(_0x4adf02,_0x35dc0d,_0x47185c,_0x382199){const _0x12cf5a=a13_0x1b2204;if(_0x382199===undefined)_0x382199=_0x47185c;var _0x5561b5=Object[_0x12cf5a(0x155)](_0x35dc0d,_0x47185c);(!_0x5561b5||(_0x12cf5a(0x101)in _0x5561b5?!_0x35dc0d[_0x12cf5a(0x15e)]:_0x5561b5[_0x12cf5a(0x153)]||_0x5561b5[_0x12cf5a(0x167)]))&&(_0x5561b5={'enumerable':!![],'get':function(){return _0x35dc0d[_0x47185c];}}),Object[_0x12cf5a(0x161)](_0x4adf02,_0x382199,_0x5561b5);}:function(_0x303b84,_0x5543c7,_0x47d79b,_0x32c1c5){if(_0x32c1c5===undefined)_0x32c1c5=_0x47d79b;_0x303b84[_0x32c1c5]=_0x5543c7[_0x47d79b];}),__setModuleDefault=this&&this[a13_0x1b2204(0x168)]||(Object[a13_0x1b2204(0x10c)]?function(_0x17a2a5,_0x3acbb2){const _0x3e3b52=a13_0x1b2204;Object[_0x3e3b52(0x161)](_0x17a2a5,_0x3e3b52(0x13c),{'enumerable':!![],'value':_0x3acbb2});}:function(_0x3aa970,_0x2add58){const _0x2600c1=a13_0x1b2204;_0x3aa970[_0x2600c1(0x13c)]=_0x2add58;}),__importStar=this&&this[a13_0x1b2204(0xfe)]||(function(){var _0x1d2469=function(_0x153093){const _0x2dc5b4=a13_0x235b;return _0x1d2469=Object[_0x2dc5b4(0x12d)]||function(_0x3e770b){const _0x4cbec8=_0x2dc5b4;var _0x35040c=[];for(var _0x58d8b5 in _0x3e770b)if(Object[_0x4cbec8(0x148)]['hasOwnProperty'][_0x4cbec8(0x165)](_0x3e770b,_0x58d8b5))_0x35040c[_0x35040c[_0x4cbec8(0x105)]]=_0x58d8b5;return _0x35040c;},_0x1d2469(_0x153093);};return function(_0x1c1b15){const _0x3f2077=a13_0x235b;if(_0x1c1b15&&_0x1c1b15[_0x3f2077(0x15e)])return _0x1c1b15;var _0x8fe46f={};if(_0x1c1b15!=null){for(var _0x471575=_0x1d2469(_0x1c1b15),_0x31aabf=0x0;_0x31aabf<_0x471575[_0x3f2077(0x105)];_0x31aabf++)if(_0x471575[_0x31aabf]!==_0x3f2077(0x13c))__createBinding(_0x8fe46f,_0x1c1b15,_0x471575[_0x31aabf]);}return __setModuleDefault(_0x8fe46f,_0x1c1b15),_0x8fe46f;};}()),__importDefault=this&&this[a13_0x1b2204(0x135)]||function(_0x38c5e9){const _0x208ad2=a13_0x1b2204;return _0x38c5e9&&_0x38c5e9[_0x208ad2(0x15e)]?_0x38c5e9:{'default':_0x38c5e9};};Object['defineProperty'](exports,a13_0x1b2204(0x15e),{'value':!![]}),exports[a13_0x1b2204(0x121)]=void 0x0;const testGatewayService_1=require(a13_0x1b2204(0x11e)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x1b2204(0x11d)));class TestGatewayController{constructor(){const _0x558248=a13_0x1b2204;this[_0x558248(0x127)]=async(_0x49d809,_0x3a90f5,_0x50e22c)=>{const _0x2a766e=_0x558248;try{const {paymentId:_0x5e231d}=_0x49d809[_0x2a766e(0x14a)];console[_0x2a766e(0x10d)](_0x2a766e(0x150)+_0x5e231d);const _0x5e0482=await database_1[_0x2a766e(0x13c)][_0x2a766e(0x15f)][_0x2a766e(0x124)]({'where':{'id':_0x5e231d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5e0482)return _0x3a90f5[_0x2a766e(0x11b)](0x194)[_0x2a766e(0x143)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5e0482['gateway']!=='test_gateway')return _0x3a90f5[_0x2a766e(0x11b)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5e0482[_0x2a766e(0x11b)]!=='PENDING')return _0x3a90f5[_0x2a766e(0x11b)](0x190)[_0x2a766e(0x143)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5e0482[_0x2a766e(0x11b)]+_0x2a766e(0x129)});_0x3a90f5[_0x2a766e(0x143)]({'success':!![],'result':{'paymentId':_0x5e0482['id'],'orderId':_0x5e0482['gatewayOrderId'],'amount':_0x5e0482[_0x2a766e(0x11f)],'currency':_0x5e0482[_0x2a766e(0x163)],'merchantName':_0x5e0482[_0x2a766e(0x14b)]['name'],'description':_0x2a766e(0x12e)+_0x5e0482[_0x2a766e(0x14b)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x2a766e(0x11a),'expiryDate':_0x2a766e(0x10f),'cvc':_0x2a766e(0x11c),'holderName':_0x2a766e(0x110)}}});}catch(_0x15698c){_0x50e22c(_0x15698c);}},this[_0x558248(0x145)]=async(_0x4a676e,_0x429971,_0x24d25c)=>{const _0x4fd5ae=_0x558248;try{const {paymentId:_0x22fd19}=_0x4a676e[_0x4fd5ae(0x14a)],_0x5e7b28=_0x4a676e[_0x4fd5ae(0x13a)];console[_0x4fd5ae(0x10d)](_0x4fd5ae(0x147)+_0x22fd19);const _0x161d1f=await database_1[_0x4fd5ae(0x13c)]['payment']['findUnique']({'where':{'id':_0x22fd19},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x161d1f)return _0x429971['status'](0x194)[_0x4fd5ae(0x143)]({'success':![],'message':_0x4fd5ae(0xff)});if(_0x161d1f[_0x4fd5ae(0x103)]!=='test_gateway')return _0x429971[_0x4fd5ae(0x11b)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x161d1f[_0x4fd5ae(0x11b)]!==_0x4fd5ae(0x14d))return _0x429971['status'](0x190)[_0x4fd5ae(0x143)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x161d1f[_0x4fd5ae(0x11b)]+',\x20cannot\x20process'});const _0x153741=await this[_0x4fd5ae(0x136)][_0x4fd5ae(0x14f)]({'paymentId':_0x161d1f['id'],'orderId':_0x161d1f[_0x4fd5ae(0x151)]||_0x161d1f['id'],'amount':_0x161d1f[_0x4fd5ae(0x11f)],'currency':_0x161d1f['currency'],'cardData':_0x5e7b28});console[_0x4fd5ae(0x10d)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x153741);const _0x160ff4={'status':_0x153741[_0x4fd5ae(0x11b)],'updatedAt':new Date()};if(_0x153741[_0x4fd5ae(0x11b)]==='PAID')_0x160ff4['paidAt']=new Date(),_0x160ff4[_0x4fd5ae(0x128)]=_0x153741['transactionId'];else _0x153741[_0x4fd5ae(0x11b)]===_0x4fd5ae(0x160)&&(_0x160ff4[_0x4fd5ae(0x10a)]=_0x153741['failureReason']);const _0x250780=_0x5e7b28[_0x4fd5ae(0x138)][_0x4fd5ae(0x104)](/[\s-]/g,'');_0x160ff4[_0x4fd5ae(0x12a)]=_0x250780[_0x4fd5ae(0x13d)](-0x4),_0x160ff4[_0x4fd5ae(0x131)]=_0x4fd5ae(0x115),await database_1[_0x4fd5ae(0x13c)][_0x4fd5ae(0x15f)][_0x4fd5ae(0x130)]({'where':{'id':_0x161d1f['id']},'data':_0x160ff4}),await database_1['default'][_0x4fd5ae(0x116)][_0x4fd5ae(0x10c)]({'data':{'paymentId':_0x161d1f['id'],'shopId':_0x161d1f[_0x4fd5ae(0x10b)],'event':_0x4fd5ae(0x122)+_0x153741['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x4fd5ae(0x157)]({'oldStatus':'PENDING','newStatus':_0x153741[_0x4fd5ae(0x11b)],'transactionId':_0x153741[_0x4fd5ae(0x15a)],'failureReason':_0x153741[_0x4fd5ae(0x162)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x161d1f,_0x153741['status'],_0x153741[_0x4fd5ae(0x15a)],_0x153741[_0x4fd5ae(0x162)]),await this[_0x4fd5ae(0x140)](_0x161d1f,_0x153741[_0x4fd5ae(0x11b)]),console[_0x4fd5ae(0x10d)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x22fd19+_0x4fd5ae(0x142)+_0x153741[_0x4fd5ae(0x11b)]),_0x153741[_0x4fd5ae(0x11b)]===_0x4fd5ae(0x137)?_0x429971[_0x4fd5ae(0x143)]({'success':!![],'message':_0x4fd5ae(0x107),'result':{'status':_0x4fd5ae(0x137),'transactionId':_0x153741[_0x4fd5ae(0x15a)],'redirectUrl':_0x161d1f[_0x4fd5ae(0x126)]}}):_0x429971[_0x4fd5ae(0x11b)](0x190)[_0x4fd5ae(0x143)]({'success':![],'message':_0x4fd5ae(0x125),'result':{'status':_0x4fd5ae(0x160),'failureReason':_0x153741[_0x4fd5ae(0x162)],'redirectUrl':_0x161d1f['failUrl']}});}catch(_0x377e8c){_0x24d25c(_0x377e8c);}},this[_0x558248(0x136)]=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1[(_0x558248(0x117))]();}async['sendShopWebhook'](_0xa7aef4,_0xd891ab,_0x3f07f1,_0x27bacb){const _0x53f899=a13_0x1b2204,_0x2298b1=Date[_0x53f899(0x134)]();try{const _0x2e9474=_0xa7aef4[_0x53f899(0x14b)],_0x32518a=_0x2e9474['settings'];if(!_0x32518a?.[_0x53f899(0x158)]){console[_0x53f899(0x10d)](_0x53f899(0x12c)+_0x2e9474['id']);return;}const _0x34a36e=_0xd891ab==='PAID'?_0x53f899(0x111):'payment.failed';let _0x39ab9b=[];if(_0x32518a[_0x53f899(0x102)])try{_0x39ab9b=Array[_0x53f899(0x108)](_0x32518a['webhookEvents'])?_0x32518a[_0x53f899(0x102)]:JSON[_0x53f899(0x14c)](_0x32518a[_0x53f899(0x102)]);}catch(_0xc631a6){console['error'](_0x53f899(0x12f),_0xc631a6),_0x39ab9b=[];}if(!_0x39ab9b[_0x53f899(0x15c)](_0x34a36e)){console[_0x53f899(0x10d)](_0x53f899(0x132)+_0x34a36e+_0x53f899(0x10e)+_0x2e9474['id']);return;}const _0x1647ae={'event':_0x34a36e,'payment':{'id':_0xa7aef4['id'],'order_id':_0xa7aef4[_0x53f899(0x118)],'gateway_order_id':_0xa7aef4[_0x53f899(0x151)],'gateway':_0x53f899(0x159),'amount':_0xa7aef4[_0x53f899(0x11f)],'currency':_0xa7aef4['currency'],'status':_0xd891ab[_0x53f899(0x113)](),'customer_email':_0xa7aef4[_0x53f899(0x13e)],'customer_name':_0xa7aef4[_0x53f899(0x144)],'transaction_id':_0x3f07f1,'failure_message':_0x27bacb,'created_at':_0xa7aef4[_0x53f899(0x141)],'updated_at':new Date()}},_0xb45e4=await fetch(_0x32518a[_0x53f899(0x158)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x53f899(0x119)},'body':JSON[_0x53f899(0x157)](_0x1647ae)}),_0x452c72=Date[_0x53f899(0x134)]()-_0x2298b1;console['log'](_0x53f899(0x112)+_0x32518a[_0x53f899(0x158)]+_0x53f899(0x154)+_0xb45e4[_0x53f899(0x11b)]+'\x20('+_0x452c72+_0x53f899(0x14e));}catch(_0x5622d7){console[_0x53f899(0x15d)](_0x53f899(0x139),_0x5622d7);}}async['sendPaymentStatusNotification'](_0x2d5ed2,_0x3ce4f5){const _0x3d2cc3=a13_0x1b2204;try{const {telegramBotService:_0x422935}=await Promise[_0x3d2cc3(0x109)]()[_0x3d2cc3(0x12b)](()=>__importStar(require(_0x3d2cc3(0x146)))),_0x581aed={'PAID':_0x3d2cc3(0x149),'FAILED':_0x3d2cc3(0x164)},_0x4fe8ad=_0x581aed[_0x3ce4f5];if(!_0x4fe8ad)return;await _0x422935['sendPaymentNotification'](_0x2d5ed2[_0x3d2cc3(0x10b)],_0x2d5ed2,_0x4fe8ad);}catch(_0x247523){console[_0x3d2cc3(0x15d)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x247523);}}}exports['TestGatewayController']=TestGatewayController;