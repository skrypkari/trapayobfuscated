'use strict';const a13_0x49c40e=a13_0x3d3e;(function(_0x40053c,_0x68249){const _0xdfb000=a13_0x3d3e,_0x40053d=_0x40053c();while(!![]){try{const _0x279284=-parseInt(_0xdfb000(0x1ea))/0x1*(-parseInt(_0xdfb000(0x1f5))/0x2)+-parseInt(_0xdfb000(0x22b))/0x3*(parseInt(_0xdfb000(0x22a))/0x4)+parseInt(_0xdfb000(0x1f1))/0x5+-parseInt(_0xdfb000(0x20e))/0x6*(parseInt(_0xdfb000(0x241))/0x7)+-parseInt(_0xdfb000(0x203))/0x8*(parseInt(_0xdfb000(0x23b))/0x9)+parseInt(_0xdfb000(0x1f2))/0xa*(-parseInt(_0xdfb000(0x250))/0xb)+parseInt(_0xdfb000(0x220))/0xc;if(_0x279284===_0x68249)break;else _0x40053d['push'](_0x40053d['shift']());}catch(_0x46578e){_0x40053d['push'](_0x40053d['shift']());}}}(a13_0x5029,0x40351));var __createBinding=this&&this['__createBinding']||(Object[a13_0x49c40e(0x23c)]?function(_0x56f182,_0x5976ad,_0x427905,_0x488add){const _0x59ba16=a13_0x49c40e;if(_0x488add===undefined)_0x488add=_0x427905;var _0x199397=Object[_0x59ba16(0x1ef)](_0x5976ad,_0x427905);(!_0x199397||(_0x59ba16(0x1fa)in _0x199397?!_0x5976ad[_0x59ba16(0x218)]:_0x199397[_0x59ba16(0x1f4)]||_0x199397[_0x59ba16(0x217)]))&&(_0x199397={'enumerable':!![],'get':function(){return _0x5976ad[_0x427905];}}),Object[_0x59ba16(0x230)](_0x56f182,_0x488add,_0x199397);}:function(_0x32b830,_0x273c53,_0x441ea1,_0x3fd42d){if(_0x3fd42d===undefined)_0x3fd42d=_0x441ea1;_0x32b830[_0x3fd42d]=_0x273c53[_0x441ea1];}),__setModuleDefault=this&&this[a13_0x49c40e(0x1f0)]||(Object[a13_0x49c40e(0x23c)]?function(_0x3392ec,_0x5d275b){const _0x83c778=a13_0x49c40e;Object[_0x83c778(0x230)](_0x3392ec,_0x83c778(0x200),{'enumerable':!![],'value':_0x5d275b});}:function(_0x130485,_0x1e6447){_0x130485['default']=_0x1e6447;}),__importStar=this&&this[a13_0x49c40e(0x1e8)]||(function(){var _0x5c5678=function(_0x15cec7){const _0x575d56=a13_0x3d3e;return _0x5c5678=Object[_0x575d56(0x1f8)]||function(_0x2f80ef){const _0x16f058=_0x575d56;var _0x26f613=[];for(var _0x3eb77 in _0x2f80ef)if(Object['prototype'][_0x16f058(0x21b)][_0x16f058(0x213)](_0x2f80ef,_0x3eb77))_0x26f613[_0x26f613[_0x16f058(0x229)]]=_0x3eb77;return _0x26f613;},_0x5c5678(_0x15cec7);};return function(_0x259379){const _0x464515=a13_0x3d3e;if(_0x259379&&_0x259379['__esModule'])return _0x259379;var _0x560bac={};if(_0x259379!=null){for(var _0x3a5fdf=_0x5c5678(_0x259379),_0xfc930a=0x0;_0xfc930a<_0x3a5fdf[_0x464515(0x229)];_0xfc930a++)if(_0x3a5fdf[_0xfc930a]!==_0x464515(0x200))__createBinding(_0x560bac,_0x259379,_0x3a5fdf[_0xfc930a]);}return __setModuleDefault(_0x560bac,_0x259379),_0x560bac;};}()),__importDefault=this&&this[a13_0x49c40e(0x1e7)]||function(_0x4653d1){return _0x4653d1&&_0x4653d1['__esModule']?_0x4653d1:{'default':_0x4653d1};};Object[a13_0x49c40e(0x230)](exports,a13_0x49c40e(0x218),{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x3d3e(_0x580da0,_0x11567c){const _0x50298f=a13_0x5029();return a13_0x3d3e=function(_0x3d3e3a,_0x41e6cd){_0x3d3e3a=_0x3d3e3a-0x1e6;let _0x984128=_0x50298f[_0x3d3e3a];return _0x984128;},a13_0x3d3e(_0x580da0,_0x11567c);}function a13_0x5029(){const _0x19805e=['settings','length','116iQMLWN','25149vEUpYC','../config/database','includes','amount','toISOString','defineProperty','then','body','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','processCard','paid','Any\x20other\x20card\x20number','Payment\x20is\x20not\x20for\x20test\x20gateway','ðŸ§ª\x20Test\x20Gateway\x20result:','shopId','transactionId','9ozvsON','create','createdAt','parse','params','Any\x20future\x20date\x20(MM/YY)','2807399MakPLF','Any\x203-4\x20digits','paidAt','Test\x20Gateway\x20webhook\x20sent\x20to\x20','application/json','isArray','sendShopWebhook','webhookUrl','TestGatewayService','test_gateway','stringify','webhookLog','toLowerCase','webhookEvents','Webhook\x20event\x20','11VhwMHm','json','sendPaymentNotification','__importDefault','__importStar','orderId','7GPiZsa','resolve','âœ…\x20Test\x20Gateway\x20payment\x20','webhookService','shop','getOwnPropertyDescriptor','__setModuleDefault','1760330fgQOaE','5136400cOQpgg','Any\x20name','writable','126508tQXstP','processCardPayment','failureReason','getOwnPropertyNames','../services/webhookService','get','\x20processed:\x20','failed','PAID','replace','\x20with\x20status\x20','default','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','ms)','1002392mKNdXB','customerName','currency','now','testGatewayService','0000','payment','sendPaymentStatusNotification','4242\x204242\x204242\x204242','slice','PENDING','6XoPffz','cardLast4','gatewayOrderId','gatewayPaymentId','\x20not\x20enabled\x20for\x20shop\x20','call','customerEmail','name','test_gateway_','configurable','__esModule','Payment\x20failed','gateway','hasOwnProperty',',\x20cannot\x20process','paymentMethod','log','../services/gateways/testGatewayService','9015024UXSItb','payment.failed','error','Payment\x20not\x20found','status','Payment\x20to\x20','FAILED','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:'];a13_0x5029=function(){return _0x19805e;};return a13_0x5029();}const testGatewayService_1=require(a13_0x49c40e(0x21f)),webhookService_1=require(a13_0x49c40e(0x1f9)),database_1=__importDefault(require(a13_0x49c40e(0x22c)));class TestGatewayController{constructor(){const _0x19af06=a13_0x49c40e;this['getPaymentForm']=async(_0x1f63e2,_0x114af9,_0x1262b2)=>{const _0x491d53=a13_0x3d3e;try{const {paymentId:_0x125abc}=_0x1f63e2[_0x491d53(0x23f)];console['log'](_0x491d53(0x233)+_0x125abc);const _0x1597ec=await database_1[_0x491d53(0x200)]['payment']['findUnique']({'where':{'id':_0x125abc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1597ec)return _0x114af9[_0x491d53(0x224)](0x194)[_0x491d53(0x251)]({'success':![],'message':_0x491d53(0x223)});if(_0x1597ec[_0x491d53(0x21a)]!==_0x491d53(0x24a))return _0x114af9[_0x491d53(0x224)](0x190)['json']({'success':![],'message':_0x491d53(0x237)});if(_0x1597ec[_0x491d53(0x224)]!==_0x491d53(0x20d))return _0x114af9[_0x491d53(0x224)](0x190)[_0x491d53(0x251)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1597ec['status']+',\x20cannot\x20process'});_0x114af9['json']({'success':!![],'result':{'paymentId':_0x1597ec['id'],'orderId':_0x1597ec[_0x491d53(0x210)],'amount':_0x1597ec[_0x491d53(0x22e)],'currency':_0x1597ec['currency'],'merchantName':_0x1597ec[_0x491d53(0x1ee)][_0x491d53(0x215)],'description':_0x491d53(0x225)+_0x1597ec['shop'][_0x491d53(0x215)],'testInstructions':{'successCard':_0x491d53(0x20b),'failureCard':_0x491d53(0x236),'expiryDate':_0x491d53(0x240),'cvc':_0x491d53(0x242),'holderName':_0x491d53(0x1f3)}}});}catch(_0xfe5cab){_0x1262b2(_0xfe5cab);}},this[_0x19af06(0x234)]=async(_0x197dba,_0x28e4c3,_0x40e574)=>{const _0x434fd9=_0x19af06;try{const {paymentId:_0x5668dd}=_0x197dba[_0x434fd9(0x23f)],_0x4d832f=_0x197dba[_0x434fd9(0x232)];console[_0x434fd9(0x21e)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x5668dd);const _0x4647a0=await database_1['default'][_0x434fd9(0x209)]['findUnique']({'where':{'id':_0x5668dd},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4647a0)return _0x28e4c3[_0x434fd9(0x224)](0x194)['json']({'success':![],'message':_0x434fd9(0x223)});if(_0x4647a0[_0x434fd9(0x21a)]!==_0x434fd9(0x24a))return _0x28e4c3[_0x434fd9(0x224)](0x190)['json']({'success':![],'message':_0x434fd9(0x237)});if(_0x4647a0[_0x434fd9(0x224)]!==_0x434fd9(0x20d))return _0x28e4c3[_0x434fd9(0x224)](0x190)[_0x434fd9(0x251)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4647a0['status']+_0x434fd9(0x21c)});const _0x1885c0=await this[_0x434fd9(0x207)][_0x434fd9(0x1f6)]({'paymentId':_0x4647a0['id'],'orderId':_0x4647a0[_0x434fd9(0x210)]||_0x4647a0['id'],'amount':_0x4647a0[_0x434fd9(0x22e)],'currency':_0x4647a0[_0x434fd9(0x205)],'cardData':_0x4d832f});console[_0x434fd9(0x21e)](_0x434fd9(0x238),_0x1885c0);const _0x1c2296={'status':_0x1885c0[_0x434fd9(0x224)],'updatedAt':new Date()};if(_0x1885c0[_0x434fd9(0x224)]==='PAID')_0x1c2296[_0x434fd9(0x243)]=new Date(),_0x1c2296[_0x434fd9(0x211)]=_0x1885c0[_0x434fd9(0x23a)];else _0x1885c0['status']===_0x434fd9(0x226)&&(_0x1c2296['failureMessage']=_0x1885c0[_0x434fd9(0x1f7)]);const _0xc17af8=_0x4d832f['cardNumber'][_0x434fd9(0x1fe)](/[\s-]/g,'');_0x1c2296[_0x434fd9(0x20f)]=_0xc17af8[_0x434fd9(0x20c)](-0x4),_0x1c2296[_0x434fd9(0x21d)]='test_card',await database_1['default'][_0x434fd9(0x209)]['update']({'where':{'id':_0x4647a0['id']},'data':_0x1c2296}),await database_1[_0x434fd9(0x200)][_0x434fd9(0x24c)][_0x434fd9(0x23c)]({'data':{'paymentId':_0x4647a0['id'],'shopId':_0x4647a0[_0x434fd9(0x239)],'event':_0x434fd9(0x216)+_0x1885c0[_0x434fd9(0x224)][_0x434fd9(0x24d)](),'statusCode':0xc8,'responseBody':JSON[_0x434fd9(0x24b)]({'oldStatus':_0x434fd9(0x20d),'newStatus':_0x1885c0[_0x434fd9(0x224)],'transactionId':_0x1885c0[_0x434fd9(0x23a)],'failureReason':_0x1885c0[_0x434fd9(0x1f7)],'processedAt':new Date()[_0x434fd9(0x22f)]()})}}),await this[_0x434fd9(0x247)](_0x4647a0,_0x1885c0['status'],_0x1885c0[_0x434fd9(0x23a)],_0x1885c0['failureReason']),await this[_0x434fd9(0x20a)](_0x4647a0,_0x1885c0[_0x434fd9(0x224)]),console[_0x434fd9(0x21e)](_0x434fd9(0x1ec)+_0x5668dd+_0x434fd9(0x1fb)+_0x1885c0[_0x434fd9(0x224)]),_0x1885c0[_0x434fd9(0x224)]==='PAID'?_0x28e4c3[_0x434fd9(0x251)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x434fd9(0x1fd),'transactionId':_0x1885c0[_0x434fd9(0x23a)],'redirectUrl':_0x4647a0['successUrl']}}):_0x28e4c3[_0x434fd9(0x224)](0x190)[_0x434fd9(0x251)]({'success':![],'message':_0x434fd9(0x219),'result':{'status':'FAILED','failureReason':_0x1885c0[_0x434fd9(0x1f7)],'redirectUrl':_0x4647a0['failUrl']}});}catch(_0x3658f8){_0x40e574(_0x3658f8);}},this[_0x19af06(0x207)]=new testGatewayService_1[(_0x19af06(0x249))](),this[_0x19af06(0x1ed)]=new webhookService_1['WebhookService']();}async[a13_0x49c40e(0x247)](_0x20838b,_0x397442,_0x4e86cd,_0x28f7f3){const _0x373cd6=a13_0x49c40e,_0x4b57c9=Date['now']();try{const _0x456c47=_0x20838b[_0x373cd6(0x1ee)],_0x3c9cf3=_0x456c47[_0x373cd6(0x228)];if(!_0x3c9cf3?.[_0x373cd6(0x248)]){console[_0x373cd6(0x21e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x456c47['id']);return;}const _0x3b8503=_0x397442===_0x373cd6(0x1fd)?'payment.success':_0x373cd6(0x221);let _0x4e08cd=[];if(_0x3c9cf3[_0x373cd6(0x24e)])try{_0x4e08cd=Array[_0x373cd6(0x246)](_0x3c9cf3['webhookEvents'])?_0x3c9cf3[_0x373cd6(0x24e)]:JSON[_0x373cd6(0x23e)](_0x3c9cf3[_0x373cd6(0x24e)]);}catch(_0x58f17a){console[_0x373cd6(0x222)]('Error\x20parsing\x20webhook\x20events:',_0x58f17a),_0x4e08cd=[];}if(!_0x4e08cd[_0x373cd6(0x22d)](_0x3b8503)){console['log'](_0x373cd6(0x24f)+_0x3b8503+_0x373cd6(0x212)+_0x456c47['id']);return;}const _0x1899fe={'event':_0x3b8503,'payment':{'id':_0x20838b['id'],'order_id':_0x20838b[_0x373cd6(0x1e9)],'gateway_order_id':_0x20838b[_0x373cd6(0x210)],'gateway':_0x373cd6(0x208),'amount':_0x20838b[_0x373cd6(0x22e)],'currency':_0x20838b[_0x373cd6(0x205)],'status':_0x397442[_0x373cd6(0x24d)](),'customer_email':_0x20838b[_0x373cd6(0x214)],'customer_name':_0x20838b[_0x373cd6(0x204)],'transaction_id':_0x4e86cd,'failure_message':_0x28f7f3,'created_at':_0x20838b[_0x373cd6(0x23d)],'updated_at':new Date()}},_0x23cd03=await fetch(_0x3c9cf3[_0x373cd6(0x248)],{'method':'POST','headers':{'Content-Type':_0x373cd6(0x245),'User-Agent':_0x373cd6(0x201)},'body':JSON['stringify'](_0x1899fe)}),_0x130f16=Date[_0x373cd6(0x206)]()-_0x4b57c9;console[_0x373cd6(0x21e)](_0x373cd6(0x244)+_0x3c9cf3[_0x373cd6(0x248)]+_0x373cd6(0x1ff)+_0x23cd03['status']+'\x20('+_0x130f16+_0x373cd6(0x202));}catch(_0x396f2d){console[_0x373cd6(0x222)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x396f2d);}}async[a13_0x49c40e(0x20a)](_0x9c980a,_0x2adcc4){const _0x267a35=a13_0x49c40e;try{const {telegramBotService:_0x582712}=await Promise[_0x267a35(0x1eb)]()[_0x267a35(0x231)](()=>__importStar(require('../services/telegramBotService'))),_0x1adde6={'PAID':_0x267a35(0x235),'FAILED':_0x267a35(0x1fc)},_0x430aa8=_0x1adde6[_0x2adcc4];if(!_0x430aa8)return;await _0x582712[_0x267a35(0x1e6)](_0x9c980a[_0x267a35(0x239)],_0x9c980a,_0x430aa8);}catch(_0x23ace7){console[_0x267a35(0x222)](_0x267a35(0x227),_0x23ace7);}}}exports['TestGatewayController']=TestGatewayController;