'use strict';const a13_0x46249d=a13_0x2297;(function(_0x559c69,_0x495bd3){const _0x2e679a=a13_0x2297,_0x479c54=_0x559c69();while(!![]){try{const _0x4a3307=parseInt(_0x2e679a(0xb2))/0x1*(parseInt(_0x2e679a(0x98))/0x2)+-parseInt(_0x2e679a(0xb9))/0x3+-parseInt(_0x2e679a(0xa7))/0x4+parseInt(_0x2e679a(0xc0))/0x5+parseInt(_0x2e679a(0xf6))/0x6+-parseInt(_0x2e679a(0x9b))/0x7*(-parseInt(_0x2e679a(0x102))/0x8)+-parseInt(_0x2e679a(0xaa))/0x9;if(_0x4a3307===_0x495bd3)break;else _0x479c54['push'](_0x479c54['shift']());}catch(_0x3d4221){_0x479c54['push'](_0x479c54['shift']());}}}(a13_0x3522,0xd7cab));function a13_0x3522(){const _0x2ff398=['payment','‚úÖ\x20Test\x20Gateway\x20payment\x20','test_gateway','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','\x20updated:\x20currentPayments=','477057fRzfRq','processCardPayment','currentPayments','shopId','failureMessage','update','__esModule','5416865zOtJoc','resolve','stringify','../services/telegramBotService','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','get','cardLast4','4242\x204242\x204242\x204242','webhookEvents','TestGatewayService','Payment\x20is\x20not\x20for\x20test\x20gateway','failureReason','payment.success','paymentMethod','sendPaymentNotification','__setModuleDefault','type','WebhookService','SINGLE','../services/gateways/testGatewayService','__importDefault','findUnique','webhookService','\x20->\x20','failUrl','paymentLinkId','COMPLETED','now','Payment\x20failed','length','‚ùå\x20Payment\x20link\x20','Payment\x20not\x20found','defineProperty','testGatewayService','payment.failed','üìà\x20Test\x20Gateway:\x20Payment\x20','default','toISOString','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20not\x20enabled\x20for\x20shop\x20','orderId','includes','hasOwnProperty','Any\x203-4\x20digits','PENDING','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentLink','status','toLowerCase','TestGatewayController','createdAt','Payment\x20status\x20is\x20','log','body','451266njWglA',',\x20status=','Payment\x20to\x20','FAILED','üìà\x20Found\x20payment\x20link\x20','create','error','PAID','transactionId','POST','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Any\x20future\x20date\x20(MM/YY)','48EQtGpd','sendPaymentStatusNotification','failed','getOwnPropertyNames','\x20not\x20found','__createBinding','amount','gatewayOrderId','settings','paid','customerName','\x20with\x20status\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Payment\x20processed\x20successfully','315950aevyyX','writable','getPaymentForm','1823479tPUHtC','customerEmail','currency','Test\x20Gateway\x20webhook\x20sent\x20to\x20','shop','Error\x20parsing\x20webhook\x20events:','\x20processed:\x20','processCard','gateway','0000','params',',\x20currentPayments=','708612Awnhxc','isArray','slice','14935374lpAgUb','json','name','../services/webhookService','webhookUrl','test_gateway_','Webhook\x20event\x20','$transaction','1zbayKN','sendShopWebhook'];a13_0x3522=function(){return _0x2ff398;};return a13_0x3522();}function a13_0x2297(_0xdd0589,_0x52b629){const _0x3522ef=a13_0x3522();return a13_0x2297=function(_0x229721,_0x38de96){_0x229721=_0x229721-0x95;let _0x5aeef9=_0x3522ef[_0x229721];return _0x5aeef9;},a13_0x2297(_0xdd0589,_0x52b629);}var __createBinding=this&&this[a13_0x46249d(0x107)]||(Object[a13_0x46249d(0xfb)]?function(_0xd65bab,_0x19efd5,_0x527cdd,_0xe713e5){const _0x217539=a13_0x46249d;if(_0xe713e5===undefined)_0xe713e5=_0x527cdd;var _0x367cda=Object['getOwnPropertyDescriptor'](_0x19efd5,_0x527cdd);(!_0x367cda||(_0x217539(0xc5)in _0x367cda?!_0x19efd5[_0x217539(0xbf)]:_0x367cda[_0x217539(0x99)]||_0x367cda['configurable']))&&(_0x367cda={'enumerable':!![],'get':function(){return _0x19efd5[_0x527cdd];}}),Object[_0x217539(0xe0)](_0xd65bab,_0xe713e5,_0x367cda);}:function(_0x3ab891,_0x3bb2e8,_0x594202,_0x57c5a1){if(_0x57c5a1===undefined)_0x57c5a1=_0x594202;_0x3ab891[_0x57c5a1]=_0x3bb2e8[_0x594202];}),__setModuleDefault=this&&this[a13_0x46249d(0xcf)]||(Object[a13_0x46249d(0xfb)]?function(_0x232037,_0x45e171){Object['defineProperty'](_0x232037,'default',{'enumerable':!![],'value':_0x45e171});}:function(_0x3c8277,_0x4e5b51){const _0x3a3776=a13_0x46249d;_0x3c8277[_0x3a3776(0xe4)]=_0x4e5b51;}),__importStar=this&&this['__importStar']||(function(){var _0x5abcd3=function(_0xc7b884){const _0x53005d=a13_0x2297;return _0x5abcd3=Object[_0x53005d(0x105)]||function(_0x191ceb){const _0x32342f=_0x53005d;var _0x24b34b=[];for(var _0x2a2caf in _0x191ceb)if(Object['prototype'][_0x32342f(0xea)]['call'](_0x191ceb,_0x2a2caf))_0x24b34b[_0x24b34b[_0x32342f(0xdd)]]=_0x2a2caf;return _0x24b34b;},_0x5abcd3(_0xc7b884);};return function(_0x692c9a){const _0x58227f=a13_0x2297;if(_0x692c9a&&_0x692c9a[_0x58227f(0xbf)])return _0x692c9a;var _0x67c9d4={};if(_0x692c9a!=null){for(var _0x281e7a=_0x5abcd3(_0x692c9a),_0x3d8521=0x0;_0x3d8521<_0x281e7a['length'];_0x3d8521++)if(_0x281e7a[_0x3d8521]!==_0x58227f(0xe4))__createBinding(_0x67c9d4,_0x692c9a,_0x281e7a[_0x3d8521]);}return __setModuleDefault(_0x67c9d4,_0x692c9a),_0x67c9d4;};}()),__importDefault=this&&this[a13_0x46249d(0xd4)]||function(_0x4c7f7e){return _0x4c7f7e&&_0x4c7f7e['__esModule']?_0x4c7f7e:{'default':_0x4c7f7e};};Object[a13_0x46249d(0xe0)](exports,a13_0x46249d(0xbf),{'value':!![]}),exports[a13_0x46249d(0xf1)]=void 0x0;const testGatewayService_1=require(a13_0x46249d(0xd3)),webhookService_1=require(a13_0x46249d(0xad)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x4c5d9b=a13_0x46249d;this[_0x4c5d9b(0x9a)]=async(_0x27a02,_0x5e19e0,_0x3dd28d)=>{const _0x38b51c=_0x4c5d9b;try{const {paymentId:_0x30737a}=_0x27a02[_0x38b51c(0xa5)];console[_0x38b51c(0xf4)](_0x38b51c(0xc4)+_0x30737a);const _0x3ae2ce=await database_1[_0x38b51c(0xe4)][_0x38b51c(0xb4)][_0x38b51c(0xd5)]({'where':{'id':_0x30737a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3ae2ce)return _0x5e19e0[_0x38b51c(0xef)](0x194)[_0x38b51c(0xab)]({'success':![],'message':_0x38b51c(0xdf)});if(_0x3ae2ce[_0x38b51c(0xa3)]!==_0x38b51c(0xb6))return _0x5e19e0[_0x38b51c(0xef)](0x190)[_0x38b51c(0xab)]({'success':![],'message':_0x38b51c(0xca)});if(_0x3ae2ce['status']!==_0x38b51c(0xec))return _0x5e19e0['status'](0x190)[_0x38b51c(0xab)]({'success':![],'message':_0x38b51c(0xf3)+_0x3ae2ce['status']+',\x20cannot\x20process'});_0x5e19e0[_0x38b51c(0xab)]({'success':!![],'result':{'paymentId':_0x3ae2ce['id'],'orderId':_0x3ae2ce['gatewayOrderId'],'amount':_0x3ae2ce['amount'],'currency':_0x3ae2ce[_0x38b51c(0x9d)],'merchantName':_0x3ae2ce[_0x38b51c(0x9f)][_0x38b51c(0xac)],'description':_0x38b51c(0xf8)+_0x3ae2ce[_0x38b51c(0x9f)][_0x38b51c(0xac)],'testInstructions':{'successCard':_0x38b51c(0xc7),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x38b51c(0x101),'cvc':_0x38b51c(0xeb),'holderName':'Any\x20name'}}});}catch(_0x2b02f1){_0x3dd28d(_0x2b02f1);}},this[_0x4c5d9b(0xa2)]=async(_0x42dc8a,_0xb98f64,_0x2b8559)=>{const _0x3f10d9=_0x4c5d9b;try{const {paymentId:_0x11ef5f}=_0x42dc8a[_0x3f10d9(0xa5)],_0x231505=_0x42dc8a[_0x3f10d9(0xf5)];console[_0x3f10d9(0xf4)](_0x3f10d9(0xb7)+_0x11ef5f);const _0x1c06d8=await database_1[_0x3f10d9(0xe4)][_0x3f10d9(0xb4)][_0x3f10d9(0xd5)]({'where':{'id':_0x11ef5f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1c06d8)return _0xb98f64[_0x3f10d9(0xef)](0x194)[_0x3f10d9(0xab)]({'success':![],'message':_0x3f10d9(0xdf)});if(_0x1c06d8['gateway']!==_0x3f10d9(0xb6))return _0xb98f64['status'](0x190)[_0x3f10d9(0xab)]({'success':![],'message':_0x3f10d9(0xca)});if(_0x1c06d8[_0x3f10d9(0xef)]!=='PENDING')return _0xb98f64[_0x3f10d9(0xef)](0x190)[_0x3f10d9(0xab)]({'success':![],'message':_0x3f10d9(0xf3)+_0x1c06d8[_0x3f10d9(0xef)]+',\x20cannot\x20process'});const _0x2e19f8=await this[_0x3f10d9(0xe1)][_0x3f10d9(0xba)]({'paymentId':_0x1c06d8['id'],'orderId':_0x1c06d8[_0x3f10d9(0x109)]||_0x1c06d8['id'],'amount':_0x1c06d8[_0x3f10d9(0x108)],'currency':_0x1c06d8[_0x3f10d9(0x9d)],'cardData':_0x231505});console[_0x3f10d9(0xf4)]('üß™\x20Test\x20Gateway\x20result:',_0x2e19f8);const _0x22f05e={'status':_0x2e19f8[_0x3f10d9(0xef)],'updatedAt':new Date()};if(_0x2e19f8['status']===_0x3f10d9(0xfd))_0x22f05e['paidAt']=new Date(),_0x22f05e['gatewayPaymentId']=_0x2e19f8[_0x3f10d9(0xfe)];else _0x2e19f8[_0x3f10d9(0xef)]===_0x3f10d9(0xf9)&&(_0x22f05e[_0x3f10d9(0xbd)]=_0x2e19f8['failureReason']);const _0x3d1327=_0x231505['cardNumber']['replace'](/[\s-]/g,'');_0x22f05e[_0x3f10d9(0xc6)]=_0x3d1327[_0x3f10d9(0xa9)](-0x4),_0x22f05e[_0x3f10d9(0xcd)]='test_card',await database_1['default'][_0x3f10d9(0xb4)][_0x3f10d9(0xbe)]({'where':{'id':_0x1c06d8['id']},'data':_0x22f05e});if(_0x2e19f8[_0x3f10d9(0xef)]===_0x3f10d9(0xfd)&&_0x1c06d8[_0x3f10d9(0xd9)]){console[_0x3f10d9(0xf4)](_0x3f10d9(0xe3)+_0x1c06d8['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x3f10d9(0xe4)][_0x3f10d9(0xb1)](async _0x3982ec=>{const _0x49eb30=_0x3f10d9,_0x3ea908=await _0x3982ec[_0x49eb30(0xee)]['findUnique']({'where':{'id':_0x1c06d8[_0x49eb30(0xd9)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3ea908){console['log'](_0x49eb30(0xfa)+_0x3ea908['id']+':\x20type='+_0x3ea908[_0x49eb30(0xd0)]+_0x49eb30(0xa6)+_0x3ea908['currentPayments']+_0x49eb30(0xf7)+_0x3ea908[_0x49eb30(0xef)]);const _0x3eeede=_0x3ea908['currentPayments']+0x1,_0x33a72a=_0x3ea908[_0x49eb30(0xd0)]===_0x49eb30(0xd2)?_0x49eb30(0xda):_0x3ea908[_0x49eb30(0xef)];await _0x3982ec['paymentLink']['update']({'where':{'id':_0x1c06d8['paymentLinkId']},'data':{'currentPayments':_0x3eeede,'status':_0x33a72a,'updatedAt':new Date()}}),console[_0x49eb30(0xf4)]('‚úÖ\x20Payment\x20link\x20'+_0x3ea908['id']+_0x49eb30(0xb8)+_0x3ea908[_0x49eb30(0xbb)]+_0x49eb30(0xd7)+_0x3eeede+',\x20status='+_0x3ea908[_0x49eb30(0xef)]+'\x20->\x20'+_0x33a72a);}else console['log'](_0x49eb30(0xde)+_0x1c06d8[_0x49eb30(0xd9)]+_0x49eb30(0x106));});}catch(_0x30166e){console[_0x3f10d9(0xfc)](_0x3f10d9(0x100),_0x30166e);}}await database_1[_0x3f10d9(0xe4)]['webhookLog'][_0x3f10d9(0xfb)]({'data':{'paymentId':_0x1c06d8['id'],'shopId':_0x1c06d8[_0x3f10d9(0xbc)],'event':_0x3f10d9(0xaf)+_0x2e19f8[_0x3f10d9(0xef)][_0x3f10d9(0xf0)](),'statusCode':0xc8,'responseBody':JSON[_0x3f10d9(0xc2)]({'oldStatus':'PENDING','newStatus':_0x2e19f8[_0x3f10d9(0xef)],'transactionId':_0x2e19f8[_0x3f10d9(0xfe)],'failureReason':_0x2e19f8[_0x3f10d9(0xcb)],'processedAt':new Date()[_0x3f10d9(0xe5)]()})}}),await this[_0x3f10d9(0xb3)](_0x1c06d8,_0x2e19f8['status'],_0x2e19f8['transactionId'],_0x2e19f8['failureReason']),await this[_0x3f10d9(0x103)](_0x1c06d8,_0x2e19f8[_0x3f10d9(0xef)]),console[_0x3f10d9(0xf4)](_0x3f10d9(0xb5)+_0x11ef5f+_0x3f10d9(0xa1)+_0x2e19f8['status']),_0x2e19f8['status']===_0x3f10d9(0xfd)?_0xb98f64['json']({'success':!![],'message':_0x3f10d9(0x97),'result':{'status':_0x3f10d9(0xfd),'transactionId':_0x2e19f8[_0x3f10d9(0xfe)],'redirectUrl':_0x1c06d8['successUrl']}}):_0xb98f64[_0x3f10d9(0xef)](0x190)[_0x3f10d9(0xab)]({'success':![],'message':_0x3f10d9(0xdc),'result':{'status':'FAILED','failureReason':_0x2e19f8[_0x3f10d9(0xcb)],'redirectUrl':_0x1c06d8[_0x3f10d9(0xd8)]}});}catch(_0x1a70f5){_0x2b8559(_0x1a70f5);}},this['testGatewayService']=new testGatewayService_1[(_0x4c5d9b(0xc9))](),this[_0x4c5d9b(0xd6)]=new webhookService_1[(_0x4c5d9b(0xd1))]();}async[a13_0x46249d(0xb3)](_0x5059b0,_0xbf95f6,_0x1849d4,_0x1e8f4d){const _0x451ea9=a13_0x46249d,_0x3459c4=Date[_0x451ea9(0xdb)]();try{const _0x1d81e8=_0x5059b0['shop'],_0x2366ee=_0x1d81e8[_0x451ea9(0x10a)];if(!_0x2366ee?.['webhookUrl']){console[_0x451ea9(0xf4)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1d81e8['id']);return;}const _0x5ca7c8=_0xbf95f6===_0x451ea9(0xfd)?_0x451ea9(0xcc):_0x451ea9(0xe2);let _0x269802=[];if(_0x2366ee[_0x451ea9(0xc8)])try{_0x269802=Array[_0x451ea9(0xa8)](_0x2366ee[_0x451ea9(0xc8)])?_0x2366ee['webhookEvents']:JSON['parse'](_0x2366ee[_0x451ea9(0xc8)]);}catch(_0x250907){console[_0x451ea9(0xfc)](_0x451ea9(0xa0),_0x250907),_0x269802=[];}if(!_0x269802[_0x451ea9(0xe9)](_0x5ca7c8)){console[_0x451ea9(0xf4)](_0x451ea9(0xb0)+_0x5ca7c8+_0x451ea9(0xe7)+_0x1d81e8['id']);return;}const _0x5e56ac={'event':_0x5ca7c8,'payment':{'id':_0x5059b0['id'],'order_id':_0x5059b0[_0x451ea9(0xe8)],'gateway_order_id':_0x5059b0['gatewayOrderId'],'gateway':_0x451ea9(0xa4),'amount':_0x5059b0['amount'],'currency':_0x5059b0[_0x451ea9(0x9d)],'status':_0xbf95f6['toLowerCase'](),'customer_email':_0x5059b0[_0x451ea9(0x9c)],'customer_name':_0x5059b0[_0x451ea9(0x10c)],'transaction_id':_0x1849d4,'failure_message':_0x1e8f4d,'created_at':_0x5059b0[_0x451ea9(0xf2)],'updated_at':new Date()}},_0x29a916=await fetch(_0x2366ee[_0x451ea9(0xae)],{'method':_0x451ea9(0xff),'headers':{'Content-Type':'application/json','User-Agent':_0x451ea9(0xe6)},'body':JSON['stringify'](_0x5e56ac)}),_0x347743=Date['now']()-_0x3459c4;console[_0x451ea9(0xf4)](_0x451ea9(0x9e)+_0x2366ee[_0x451ea9(0xae)]+_0x451ea9(0x95)+_0x29a916[_0x451ea9(0xef)]+'\x20('+_0x347743+'ms)');}catch(_0x3ee75f){console[_0x451ea9(0xfc)](_0x451ea9(0x96),_0x3ee75f);}}async['sendPaymentStatusNotification'](_0x198485,_0x5882ee){const _0x293a11=a13_0x46249d;try{const {telegramBotService:_0x14baa7}=await Promise[_0x293a11(0xc1)]()['then'](()=>__importStar(require(_0x293a11(0xc3)))),_0x474c98={'PAID':_0x293a11(0x10b),'FAILED':_0x293a11(0x104)},_0x2459e9=_0x474c98[_0x5882ee];if(!_0x2459e9)return;await _0x14baa7[_0x293a11(0xce)](_0x198485[_0x293a11(0xbc)],_0x198485,_0x2459e9);}catch(_0x214394){console[_0x293a11(0xfc)](_0x293a11(0xed),_0x214394);}}}exports[a13_0x46249d(0xf1)]=TestGatewayController;