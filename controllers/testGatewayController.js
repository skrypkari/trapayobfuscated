'use strict';const a13_0x42b72b=a13_0xe98f;function a13_0xe98f(_0x2a4d21,_0x344470){const _0x2113cb=a13_0x2113();return a13_0xe98f=function(_0xe98f87,_0x2b9f91){_0xe98f87=_0xe98f87-0x1b7;let _0x487664=_0x2113cb[_0xe98f87];return _0x487664;},a13_0xe98f(_0x2a4d21,_0x344470);}(function(_0x4bc523,_0x100d05){const _0x55885a=a13_0xe98f,_0xf919d1=_0x4bc523();while(!![]){try{const _0x45cb28=-parseInt(_0x55885a(0x1db))/0x1*(parseInt(_0x55885a(0x208))/0x2)+parseInt(_0x55885a(0x1e3))/0x3+parseInt(_0x55885a(0x20b))/0x4*(parseInt(_0x55885a(0x1be))/0x5)+-parseInt(_0x55885a(0x1fe))/0x6*(-parseInt(_0x55885a(0x205))/0x7)+-parseInt(_0x55885a(0x209))/0x8*(-parseInt(_0x55885a(0x1c1))/0x9)+-parseInt(_0x55885a(0x214))/0xa+parseInt(_0x55885a(0x1d4))/0xb;if(_0x45cb28===_0x100d05)break;else _0xf919d1['push'](_0xf919d1['shift']());}catch(_0x2427d1){_0xf919d1['push'](_0xf919d1['shift']());}}}(a13_0x2113,0xf241a));var __createBinding=this&&this[a13_0x42b72b(0x1fc)]||(Object['create']?function(_0x412a8d,_0x31d5d9,_0x590c70,_0xc9800a){const _0x1292ab=a13_0x42b72b;if(_0xc9800a===undefined)_0xc9800a=_0x590c70;var _0x1cc6fe=Object[_0x1292ab(0x1ce)](_0x31d5d9,_0x590c70);(!_0x1cc6fe||(_0x1292ab(0x203)in _0x1cc6fe?!_0x31d5d9['__esModule']:_0x1cc6fe[_0x1292ab(0x223)]||_0x1cc6fe[_0x1292ab(0x224)]))&&(_0x1cc6fe={'enumerable':!![],'get':function(){return _0x31d5d9[_0x590c70];}}),Object[_0x1292ab(0x1d3)](_0x412a8d,_0xc9800a,_0x1cc6fe);}:function(_0x7e3118,_0xcffbcd,_0x2c1e5b,_0x39a43b){if(_0x39a43b===undefined)_0x39a43b=_0x2c1e5b;_0x7e3118[_0x39a43b]=_0xcffbcd[_0x2c1e5b];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x42b72b(0x206)]?function(_0x241978,_0x59a4f1){const _0x9459d6=a13_0x42b72b;Object[_0x9459d6(0x1d3)](_0x241978,_0x9459d6(0x217),{'enumerable':!![],'value':_0x59a4f1});}:function(_0x1cc8e8,_0x192130){_0x1cc8e8['default']=_0x192130;}),__importStar=this&&this[a13_0x42b72b(0x1f6)]||(function(){var _0x1d5a2d=function(_0x442190){const _0x153a78=a13_0xe98f;return _0x1d5a2d=Object[_0x153a78(0x1fb)]||function(_0x174718){const _0x39badd=_0x153a78;var _0x11c7ec=[];for(var _0x27a7cc in _0x174718)if(Object[_0x39badd(0x1c6)]['hasOwnProperty'][_0x39badd(0x21f)](_0x174718,_0x27a7cc))_0x11c7ec[_0x11c7ec[_0x39badd(0x1ea)]]=_0x27a7cc;return _0x11c7ec;},_0x1d5a2d(_0x442190);};return function(_0x19a2b4){const _0x461002=a13_0xe98f;if(_0x19a2b4&&_0x19a2b4['__esModule'])return _0x19a2b4;var _0x30ddf7={};if(_0x19a2b4!=null){for(var _0x1b2e99=_0x1d5a2d(_0x19a2b4),_0x28024e=0x0;_0x28024e<_0x1b2e99['length'];_0x28024e++)if(_0x1b2e99[_0x28024e]!==_0x461002(0x217))__createBinding(_0x30ddf7,_0x19a2b4,_0x1b2e99[_0x28024e]);}return __setModuleDefault(_0x30ddf7,_0x19a2b4),_0x30ddf7;};}()),__importDefault=this&&this[a13_0x42b72b(0x215)]||function(_0x53b096){const _0x2a0e49=a13_0x42b72b;return _0x53b096&&_0x53b096[_0x2a0e49(0x1e8)]?_0x53b096:{'default':_0x53b096};};Object['defineProperty'](exports,a13_0x42b72b(0x1e8),{'value':!![]}),exports[a13_0x42b72b(0x1eb)]=void 0x0;function a13_0x2113(){const _0xc10559=['206VoEUPc','232snBeZa','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','4RdsLOE','webhookUrl','toLowerCase','gatewayPaymentId','sendPaymentStatusNotification','amount','orderId','payment.failed','Any\x20name','5775080cddAiu','__importDefault','slice','default','payment.success','sendShopWebhook','payment','failureMessage','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',',\x20cannot\x20process','customerEmail','call','failUrl','status','webhookEvents','writable','configurable','resolve','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Any\x203-4\x20digits','Payment\x20processed\x20successfully','gateway','stringify','failureReason','539635VypRfr','test_gateway','Payment\x20status\x20is\x20','288324ZNvJXJ','name','processCardPayment','findUnique','ðŸ§ª\x20Test\x20Gateway\x20result:','prototype','shopId','PAID','update','../services/telegramBotService','gatewayOrderId','application/json','test_gateway_','getOwnPropertyDescriptor','currency','test_card','replace','log','defineProperty','16884362NDVkxN','successUrl','Payment\x20is\x20not\x20for\x20test\x20gateway','failed','\x20not\x20enabled\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','FAILED','13659zQEccS','cardLast4','Payment\x20to\x20','âœ…\x20Test\x20Gateway\x20payment\x20','0000','getPaymentForm','ms)','transactionId','1083738qnApqc','now','POST','../services/webhookService','4242\x204242\x204242\x204242','__esModule','paymentMethod','length','TestGatewayController','paid','\x20processed:\x20','json','error','shop','isArray','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','WebhookService','PENDING','cardNumber','__importStar','createdAt','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','params','Payment\x20not\x20found','getOwnPropertyNames','__createBinding','settings','438QwTdIb','body','testGatewayService','parse','Any\x20future\x20date\x20(MM/YY)','get','includes','4172oZVybR','create','../config/database'];a13_0x2113=function(){return _0xc10559;};return a13_0x2113();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x42b72b(0x1e6)),database_1=__importDefault(require(a13_0x42b72b(0x207)));class TestGatewayController{constructor(){const _0x4972aa=a13_0x42b72b;this[_0x4972aa(0x1e0)]=async(_0x4dd097,_0x102ed6,_0x80ccc6)=>{const _0x55b8c1=_0x4972aa;try{const {paymentId:_0x1172d8}=_0x4dd097[_0x55b8c1(0x1f9)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x1172d8);const _0x331666=await database_1[_0x55b8c1(0x217)][_0x55b8c1(0x21a)]['findUnique']({'where':{'id':_0x1172d8},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x331666)return _0x102ed6[_0x55b8c1(0x221)](0x194)[_0x55b8c1(0x1ee)]({'success':![],'message':_0x55b8c1(0x1fa)});if(_0x331666[_0x55b8c1(0x1bb)]!==_0x55b8c1(0x1bf))return _0x102ed6['status'](0x190)[_0x55b8c1(0x1ee)]({'success':![],'message':_0x55b8c1(0x1d6)});if(_0x331666[_0x55b8c1(0x221)]!==_0x55b8c1(0x1f4))return _0x102ed6[_0x55b8c1(0x221)](0x190)[_0x55b8c1(0x1ee)]({'success':![],'message':_0x55b8c1(0x1c0)+_0x331666['status']+_0x55b8c1(0x21d)});_0x102ed6[_0x55b8c1(0x1ee)]({'success':!![],'result':{'paymentId':_0x331666['id'],'orderId':_0x331666[_0x55b8c1(0x1cb)],'amount':_0x331666[_0x55b8c1(0x210)],'currency':_0x331666[_0x55b8c1(0x1cf)],'merchantName':_0x331666['shop'][_0x55b8c1(0x1c2)],'description':_0x55b8c1(0x1dd)+_0x331666[_0x55b8c1(0x1f0)][_0x55b8c1(0x1c2)],'testInstructions':{'successCard':_0x55b8c1(0x1e7),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x55b8c1(0x202),'cvc':_0x55b8c1(0x1b9),'holderName':_0x55b8c1(0x213)}}});}catch(_0x5bcb6b){_0x80ccc6(_0x5bcb6b);}},this['processCard']=async(_0x443fbe,_0x4cc4e0,_0x42fddc)=>{const _0x89f447=_0x4972aa;try{const {paymentId:_0x9bb250}=_0x443fbe[_0x89f447(0x1f9)],_0x3dea23=_0x443fbe[_0x89f447(0x1ff)];console[_0x89f447(0x1d2)](_0x89f447(0x20a)+_0x9bb250);const _0x3cfd58=await database_1[_0x89f447(0x217)][_0x89f447(0x21a)][_0x89f447(0x1c4)]({'where':{'id':_0x9bb250},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3cfd58)return _0x4cc4e0['status'](0x194)[_0x89f447(0x1ee)]({'success':![],'message':_0x89f447(0x1fa)});if(_0x3cfd58[_0x89f447(0x1bb)]!==_0x89f447(0x1bf))return _0x4cc4e0[_0x89f447(0x221)](0x190)['json']({'success':![],'message':_0x89f447(0x1d6)});if(_0x3cfd58[_0x89f447(0x221)]!=='PENDING')return _0x4cc4e0[_0x89f447(0x221)](0x190)['json']({'success':![],'message':_0x89f447(0x1c0)+_0x3cfd58[_0x89f447(0x221)]+',\x20cannot\x20process'});const _0x184073=await this[_0x89f447(0x200)][_0x89f447(0x1c3)]({'paymentId':_0x3cfd58['id'],'orderId':_0x3cfd58['gatewayOrderId']||_0x3cfd58['id'],'amount':_0x3cfd58['amount'],'currency':_0x3cfd58['currency'],'cardData':_0x3dea23});console['log'](_0x89f447(0x1c5),_0x184073);const _0x58e29c={'status':_0x184073[_0x89f447(0x221)],'updatedAt':new Date()};if(_0x184073[_0x89f447(0x221)]===_0x89f447(0x1c8))_0x58e29c['paidAt']=new Date(),_0x58e29c[_0x89f447(0x20e)]=_0x184073[_0x89f447(0x1e2)];else _0x184073[_0x89f447(0x221)]===_0x89f447(0x1da)&&(_0x58e29c[_0x89f447(0x21b)]=_0x184073[_0x89f447(0x1bd)]);const _0x70d952=_0x3dea23[_0x89f447(0x1f5)][_0x89f447(0x1d1)](/[\s-]/g,'');_0x58e29c[_0x89f447(0x1dc)]=_0x70d952[_0x89f447(0x216)](-0x4),_0x58e29c[_0x89f447(0x1e9)]=_0x89f447(0x1d0),await database_1['default']['payment'][_0x89f447(0x1c9)]({'where':{'id':_0x3cfd58['id']},'data':_0x58e29c}),await database_1[_0x89f447(0x217)]['webhookLog'][_0x89f447(0x206)]({'data':{'paymentId':_0x3cfd58['id'],'shopId':_0x3cfd58[_0x89f447(0x1c7)],'event':_0x89f447(0x1cd)+_0x184073[_0x89f447(0x221)][_0x89f447(0x20d)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x89f447(0x1f4),'newStatus':_0x184073[_0x89f447(0x221)],'transactionId':_0x184073['transactionId'],'failureReason':_0x184073[_0x89f447(0x1bd)],'processedAt':new Date()['toISOString']()})}}),await this[_0x89f447(0x219)](_0x3cfd58,_0x184073[_0x89f447(0x221)],_0x184073[_0x89f447(0x1e2)],_0x184073['failureReason']),await this[_0x89f447(0x20f)](_0x3cfd58,_0x184073[_0x89f447(0x221)]),console['log'](_0x89f447(0x1de)+_0x9bb250+_0x89f447(0x1ed)+_0x184073['status']),_0x184073[_0x89f447(0x221)]===_0x89f447(0x1c8)?_0x4cc4e0[_0x89f447(0x1ee)]({'success':!![],'message':_0x89f447(0x1ba),'result':{'status':_0x89f447(0x1c8),'transactionId':_0x184073['transactionId'],'redirectUrl':_0x3cfd58[_0x89f447(0x1d5)]}}):_0x4cc4e0[_0x89f447(0x221)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x89f447(0x1da),'failureReason':_0x184073[_0x89f447(0x1bd)],'redirectUrl':_0x3cfd58[_0x89f447(0x220)]}});}catch(_0x2e90d7){_0x42fddc(_0x2e90d7);}},this[_0x4972aa(0x200)]=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1[(_0x4972aa(0x1f3))]();}async['sendShopWebhook'](_0x4037ca,_0x363601,_0x3872f8,_0x2dafce){const _0x380e17=a13_0x42b72b,_0xcbc559=Date[_0x380e17(0x1e4)]();try{const _0x34afd3=_0x4037ca[_0x380e17(0x1f0)],_0x1b01fb=_0x34afd3[_0x380e17(0x1fd)];if(!_0x1b01fb?.[_0x380e17(0x20c)]){console[_0x380e17(0x1d2)](_0x380e17(0x1f2)+_0x34afd3['id']);return;}const _0x1e3397=_0x363601===_0x380e17(0x1c8)?_0x380e17(0x218):_0x380e17(0x212);let _0x19a71a=[];if(_0x1b01fb[_0x380e17(0x222)])try{_0x19a71a=Array[_0x380e17(0x1f1)](_0x1b01fb[_0x380e17(0x222)])?_0x1b01fb[_0x380e17(0x222)]:JSON[_0x380e17(0x201)](_0x1b01fb[_0x380e17(0x222)]);}catch(_0x546471){console[_0x380e17(0x1ef)](_0x380e17(0x1d9),_0x546471),_0x19a71a=[];}if(!_0x19a71a[_0x380e17(0x204)](_0x1e3397)){console[_0x380e17(0x1d2)]('Webhook\x20event\x20'+_0x1e3397+_0x380e17(0x1d8)+_0x34afd3['id']);return;}const _0x3d26c8={'event':_0x1e3397,'payment':{'id':_0x4037ca['id'],'order_id':_0x4037ca[_0x380e17(0x211)],'gateway_order_id':_0x4037ca[_0x380e17(0x1cb)],'gateway':_0x380e17(0x1df),'amount':_0x4037ca[_0x380e17(0x210)],'currency':_0x4037ca[_0x380e17(0x1cf)],'status':_0x363601[_0x380e17(0x20d)](),'customer_email':_0x4037ca[_0x380e17(0x21e)],'customer_name':_0x4037ca['customerName'],'transaction_id':_0x3872f8,'failure_message':_0x2dafce,'created_at':_0x4037ca[_0x380e17(0x1f7)],'updated_at':new Date()}},_0x7a9dd8=await fetch(_0x1b01fb['webhookUrl'],{'method':_0x380e17(0x1e5),'headers':{'Content-Type':_0x380e17(0x1cc),'User-Agent':_0x380e17(0x1f8)},'body':JSON[_0x380e17(0x1bc)](_0x3d26c8)}),_0x31d33c=Date[_0x380e17(0x1e4)]()-_0xcbc559;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x1b01fb[_0x380e17(0x20c)]+'\x20with\x20status\x20'+_0x7a9dd8[_0x380e17(0x221)]+'\x20('+_0x31d33c+_0x380e17(0x1e1));}catch(_0x392868){console[_0x380e17(0x1ef)](_0x380e17(0x21c),_0x392868);}}async[a13_0x42b72b(0x20f)](_0x2bd485,_0x2db0fd){const _0x1d66e3=a13_0x42b72b;try{const {telegramBotService:_0x387780}=await Promise[_0x1d66e3(0x1b7)]()['then'](()=>__importStar(require(_0x1d66e3(0x1ca)))),_0x40032d={'PAID':_0x1d66e3(0x1ec),'FAILED':_0x1d66e3(0x1d7)},_0x125664=_0x40032d[_0x2db0fd];if(!_0x125664)return;await _0x387780['sendPaymentNotification'](_0x2bd485[_0x1d66e3(0x1c7)],_0x2bd485,_0x125664);}catch(_0x38141d){console[_0x1d66e3(0x1ef)](_0x1d66e3(0x1b8),_0x38141d);}}}exports[a13_0x42b72b(0x1eb)]=TestGatewayController;