'use strict';const a15_0x59d36c=a15_0xcd26;function a15_0xcd26(_0x5218c8,_0x922f75){const _0x1c9578=a15_0x1c95();return a15_0xcd26=function(_0xcd265e,_0x28d9c4){_0xcd265e=_0xcd265e-0x8e;let _0x339f03=_0x1c9578[_0xcd265e];return _0x339f03;},a15_0xcd26(_0x5218c8,_0x922f75);}(function(_0x38fef3,_0xe2552f){const _0x3aed8e=a15_0xcd26,_0x14924c=_0x38fef3();while(!![]){try{const _0x4ef38f=parseInt(_0x3aed8e(0xfb))/0x1+-parseInt(_0x3aed8e(0xef))/0x2+parseInt(_0x3aed8e(0x8f))/0x3*(-parseInt(_0x3aed8e(0xc2))/0x4)+-parseInt(_0x3aed8e(0xdc))/0x5+parseInt(_0x3aed8e(0xde))/0x6+-parseInt(_0x3aed8e(0xfc))/0x7+parseInt(_0x3aed8e(0xcb))/0x8;if(_0x4ef38f===_0xe2552f)break;else _0x14924c['push'](_0x14924c['shift']());}catch(_0x1d2f2f){_0x14924c['push'](_0x14924c['shift']());}}}(a15_0x1c95,0x80339));var __createBinding=this&&this[a15_0x59d36c(0xae)]||(Object[a15_0x59d36c(0xf0)]?function(_0x915f28,_0x37fcec,_0x287f8f,_0x489632){const _0x33c3c2=a15_0x59d36c;if(_0x489632===undefined)_0x489632=_0x287f8f;var _0xf0188a=Object[_0x33c3c2(0xe1)](_0x37fcec,_0x287f8f);(!_0xf0188a||(_0x33c3c2(0xe8)in _0xf0188a?!_0x37fcec[_0x33c3c2(0xb7)]:_0xf0188a[_0x33c3c2(0xc0)]||_0xf0188a[_0x33c3c2(0xf3)]))&&(_0xf0188a={'enumerable':!![],'get':function(){return _0x37fcec[_0x287f8f];}}),Object[_0x33c3c2(0xe9)](_0x915f28,_0x489632,_0xf0188a);}:function(_0x5d858f,_0x28cb71,_0x64e692,_0x42331a){if(_0x42331a===undefined)_0x42331a=_0x64e692;_0x5d858f[_0x42331a]=_0x28cb71[_0x64e692];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a15_0x59d36c(0xf0)]?function(_0x360082,_0x1ce6eb){const _0x31622d=a15_0x59d36c;Object[_0x31622d(0xe9)](_0x360082,_0x31622d(0x94),{'enumerable':!![],'value':_0x1ce6eb});}:function(_0x316f80,_0x2d6c9a){const _0x30cfed=a15_0x59d36c;_0x316f80[_0x30cfed(0x94)]=_0x2d6c9a;}),__importStar=this&&this[a15_0x59d36c(0xa6)]||(function(){var _0xe3cc93=function(_0x259c99){const _0x39bc0d=a15_0xcd26;return _0xe3cc93=Object[_0x39bc0d(0x8e)]||function(_0x3b0283){const _0x4fef0b=_0x39bc0d;var _0x1f9e5f=[];for(var _0x4d5a5c in _0x3b0283)if(Object[_0x4fef0b(0xbd)][_0x4fef0b(0xba)][_0x4fef0b(0x9a)](_0x3b0283,_0x4d5a5c))_0x1f9e5f[_0x1f9e5f[_0x4fef0b(0xda)]]=_0x4d5a5c;return _0x1f9e5f;},_0xe3cc93(_0x259c99);};return function(_0x255520){const _0x220cf2=a15_0xcd26;if(_0x255520&&_0x255520[_0x220cf2(0xb7)])return _0x255520;var _0x4d91a7={};if(_0x255520!=null){for(var _0x276e8e=_0xe3cc93(_0x255520),_0x302bb0=0x0;_0x302bb0<_0x276e8e['length'];_0x302bb0++)if(_0x276e8e[_0x302bb0]!==_0x220cf2(0x94))__createBinding(_0x4d91a7,_0x255520,_0x276e8e[_0x302bb0]);}return __setModuleDefault(_0x4d91a7,_0x255520),_0x4d91a7;};}()),__importDefault=this&&this[a15_0x59d36c(0x104)]||function(_0x38b804){const _0x2c2a2b=a15_0x59d36c;return _0x38b804&&_0x38b804[_0x2c2a2b(0xb7)]?_0x38b804:{'default':_0x38b804};};function a15_0x1c95(){const _0x5eb3cd=['sendShopWebhook','2703880wTywbM','replace','4293948mivfcZ','Payment\x20not\x20found','../services/webhookService','getOwnPropertyDescriptor','webhookEvents','$transaction','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','webhookService',',\x20status=','get','defineProperty','toISOString','successUrl','TestGatewayController','Error\x20parsing\x20webhook\x20events:','log','1918060ZFgRZn','create','test_gateway_','Payment\x20status\x20is\x20','configurable','processCardPayment','test_card','settings','then','paid','customerEmail','../services/gateways/testGatewayService','554339TlGFIN','2826845bQDoAG','paymentLink','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','status','findUnique','testGatewayService','failureReason','\x20not\x20found','__importDefault','TestGatewayService','getOwnPropertyNames','95253mcfYPN','SINGLE','cardNumber',':\x20type=','4242\x204242\x204242\x204242','default','cardLast4','gatewayOrderId','amount','sendPaymentStatusNotification','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','call','\x20->\x20','gateway','../config/database','Payment\x20to\x20','includes',',\x20cannot\x20process','update','‚úÖ\x20Test\x20Gateway\x20payment\x20','getPaymentForm','Any\x20other\x20card\x20number','currency','__importStar','transactionId','sendPaymentNotification','Payment\x20processed\x20successfully','üß™\x20Test\x20Gateway\x20result:','ms)','shopId','paymentLinkId','__createBinding','params','FAILED','currentPayments','webhookLog','failed','processCard','\x20not\x20enabled\x20for\x20shop\x20','stringify','__esModule','Payment\x20is\x20not\x20for\x20test\x20gateway','shop','hasOwnProperty','\x20updated:\x20currentPayments=','payment.success','prototype','now','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','writable','paymentMethod','16qWnYOK','customerName','../services/telegramBotService','Webhook\x20event\x20','payment','Any\x20name','slice','PENDING','0000','10286088TUenXW','test_gateway','COMPLETED','failUrl','gatewayPaymentId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','error','isArray','PAID','\x20processed:\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','parse','payment.failed','json','type','length'];a15_0x1c95=function(){return _0x5eb3cd;};return a15_0x1c95();}Object['defineProperty'](exports,a15_0x59d36c(0xb7),{'value':!![]}),exports[a15_0x59d36c(0xec)]=void 0x0;const testGatewayService_1=require(a15_0x59d36c(0xfa)),webhookService_1=require(a15_0x59d36c(0xe0)),database_1=__importDefault(require(a15_0x59d36c(0x9d)));class TestGatewayController{constructor(){const _0x3d1fa2=a15_0x59d36c;this[_0x3d1fa2(0xa3)]=async(_0x2e1b59,_0x141aea,_0x45f233)=>{const _0x109780=_0x3d1fa2;try{const {paymentId:_0x38680a}=_0x2e1b59[_0x109780(0xaf)];console[_0x109780(0xee)](_0x109780(0xbf)+_0x38680a);const _0x54fcf4=await database_1[_0x109780(0x94)]['payment'][_0x109780(0x100)]({'where':{'id':_0x38680a},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x54fcf4)return _0x141aea[_0x109780(0xff)](0x194)[_0x109780(0xd8)]({'success':![],'message':_0x109780(0xdf)});if(_0x54fcf4[_0x109780(0x9c)]!==_0x109780(0xcc))return _0x141aea[_0x109780(0xff)](0x190)[_0x109780(0xd8)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x54fcf4[_0x109780(0xff)]!==_0x109780(0xc9))return _0x141aea['status'](0x190)[_0x109780(0xd8)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x54fcf4[_0x109780(0xff)]+_0x109780(0xa0)});_0x141aea[_0x109780(0xd8)]({'success':!![],'result':{'paymentId':_0x54fcf4['id'],'orderId':_0x54fcf4[_0x109780(0x96)],'amount':_0x54fcf4['amount'],'currency':_0x54fcf4['currency'],'merchantName':_0x54fcf4[_0x109780(0xb9)]['name'],'description':_0x109780(0x9e)+_0x54fcf4[_0x109780(0xb9)]['name'],'testInstructions':{'successCard':_0x109780(0x93),'failureCard':_0x109780(0xa4),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x109780(0xc7)}}});}catch(_0x37bb0d){_0x45f233(_0x37bb0d);}},this[_0x3d1fa2(0xb4)]=async(_0x293638,_0x313b6d,_0x507a1d)=>{const _0x3237dd=_0x3d1fa2;try{const {paymentId:_0x2a4aaa}=_0x293638[_0x3237dd(0xaf)],_0x4b4c73=_0x293638['body'];console[_0x3237dd(0xee)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x2a4aaa);const _0xb6fc7a=await database_1[_0x3237dd(0x94)][_0x3237dd(0xc6)][_0x3237dd(0x100)]({'where':{'id':_0x2a4aaa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb6fc7a)return _0x313b6d[_0x3237dd(0xff)](0x194)['json']({'success':![],'message':_0x3237dd(0xdf)});if(_0xb6fc7a[_0x3237dd(0x9c)]!==_0x3237dd(0xcc))return _0x313b6d[_0x3237dd(0xff)](0x190)[_0x3237dd(0xd8)]({'success':![],'message':_0x3237dd(0xb8)});if(_0xb6fc7a[_0x3237dd(0xff)]!=='PENDING')return _0x313b6d[_0x3237dd(0xff)](0x190)[_0x3237dd(0xd8)]({'success':![],'message':_0x3237dd(0xf2)+_0xb6fc7a[_0x3237dd(0xff)]+',\x20cannot\x20process'});const _0x115ba0=await this[_0x3237dd(0x101)][_0x3237dd(0xf4)]({'paymentId':_0xb6fc7a['id'],'orderId':_0xb6fc7a[_0x3237dd(0x96)]||_0xb6fc7a['id'],'amount':_0xb6fc7a['amount'],'currency':_0xb6fc7a['currency'],'cardData':_0x4b4c73});console[_0x3237dd(0xee)](_0x3237dd(0xaa),_0x115ba0);const _0x4fe87a={'status':_0x115ba0[_0x3237dd(0xff)],'updatedAt':new Date()};if(_0x115ba0[_0x3237dd(0xff)]===_0x3237dd(0xd3))_0x4fe87a['paidAt']=new Date(),_0x4fe87a[_0x3237dd(0xcf)]=_0x115ba0[_0x3237dd(0xa7)];else _0x115ba0['status']==='FAILED'&&(_0x4fe87a['failureMessage']=_0x115ba0['failureReason']);const _0x5e9175=_0x4b4c73[_0x3237dd(0x91)][_0x3237dd(0xdd)](/[\s-]/g,'');_0x4fe87a[_0x3237dd(0x95)]=_0x5e9175[_0x3237dd(0xc8)](-0x4),_0x4fe87a[_0x3237dd(0xc1)]=_0x3237dd(0xf5),await database_1['default'][_0x3237dd(0xc6)][_0x3237dd(0xa1)]({'where':{'id':_0xb6fc7a['id']},'data':_0x4fe87a});if(_0x115ba0[_0x3237dd(0xff)]===_0x3237dd(0xd3)&&_0xb6fc7a[_0x3237dd(0xad)]){console[_0x3237dd(0xee)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0xb6fc7a['id']+_0x3237dd(0xfe));try{await database_1['default'][_0x3237dd(0xe3)](async _0x3515b1=>{const _0x4f020c=_0x3237dd,_0x4adb41=await _0x3515b1[_0x4f020c(0xfd)]['findUnique']({'where':{'id':_0xb6fc7a[_0x4f020c(0xad)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4adb41){console['log']('üìà\x20Found\x20payment\x20link\x20'+_0x4adb41['id']+_0x4f020c(0x92)+_0x4adb41[_0x4f020c(0xd9)]+',\x20currentPayments='+_0x4adb41[_0x4f020c(0xb1)]+_0x4f020c(0xe7)+_0x4adb41[_0x4f020c(0xff)]);const _0x3f3b98=_0x4adb41[_0x4f020c(0xb1)]+0x1,_0x5af2c5=_0x4adb41[_0x4f020c(0xd9)]===_0x4f020c(0x90)?_0x4f020c(0xcd):_0x4adb41[_0x4f020c(0xff)];await _0x3515b1[_0x4f020c(0xfd)]['update']({'where':{'id':_0xb6fc7a[_0x4f020c(0xad)]},'data':{'currentPayments':_0x3f3b98,'status':_0x5af2c5,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x4adb41['id']+_0x4f020c(0xbb)+_0x4adb41['currentPayments']+_0x4f020c(0x9b)+_0x3f3b98+',\x20status='+_0x4adb41['status']+_0x4f020c(0x9b)+_0x5af2c5);}else console[_0x4f020c(0xee)]('‚ùå\x20Payment\x20link\x20'+_0xb6fc7a['paymentLinkId']+_0x4f020c(0x103));});}catch(_0x3192a6){console['error'](_0x3237dd(0x99),_0x3192a6);}}await database_1[_0x3237dd(0x94)][_0x3237dd(0xb2)]['create']({'data':{'paymentId':_0xb6fc7a['id'],'shopId':_0xb6fc7a[_0x3237dd(0xac)],'event':_0x3237dd(0xf1)+_0x115ba0[_0x3237dd(0xff)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3237dd(0xc9),'newStatus':_0x115ba0[_0x3237dd(0xff)],'transactionId':_0x115ba0['transactionId'],'failureReason':_0x115ba0[_0x3237dd(0x102)],'processedAt':new Date()[_0x3237dd(0xea)]()})}}),await this[_0x3237dd(0xdb)](_0xb6fc7a,_0x115ba0[_0x3237dd(0xff)],_0x115ba0[_0x3237dd(0xa7)],_0x115ba0[_0x3237dd(0x102)]),await this['sendPaymentStatusNotification'](_0xb6fc7a,_0x115ba0[_0x3237dd(0xff)]),console[_0x3237dd(0xee)](_0x3237dd(0xa2)+_0x2a4aaa+_0x3237dd(0xd4)+_0x115ba0[_0x3237dd(0xff)]),_0x115ba0[_0x3237dd(0xff)]===_0x3237dd(0xd3)?_0x313b6d['json']({'success':!![],'message':_0x3237dd(0xa9),'result':{'status':_0x3237dd(0xd3),'transactionId':_0x115ba0[_0x3237dd(0xa7)],'redirectUrl':_0xb6fc7a[_0x3237dd(0xeb)]}}):_0x313b6d['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x3237dd(0xb0),'failureReason':_0x115ba0[_0x3237dd(0x102)],'redirectUrl':_0xb6fc7a[_0x3237dd(0xce)]}});}catch(_0x3d46a1){_0x507a1d(_0x3d46a1);}},this['testGatewayService']=new testGatewayService_1[(_0x3d1fa2(0x105))](),this[_0x3d1fa2(0xe6)]=new webhookService_1['WebhookService']();}async[a15_0x59d36c(0xdb)](_0x33c3e7,_0x5860ba,_0x3e4408,_0x316c3a){const _0x49eb20=a15_0x59d36c,_0x16bcc0=Date[_0x49eb20(0xbe)]();try{const _0xfd3e90=_0x33c3e7['shop'],_0x2111a6=_0xfd3e90[_0x49eb20(0xf6)];if(!_0x2111a6?.['webhookUrl']){console[_0x49eb20(0xee)](_0x49eb20(0xe4)+_0xfd3e90['id']);return;}const _0x2ad9dc=_0x5860ba===_0x49eb20(0xd3)?_0x49eb20(0xbc):_0x49eb20(0xd7);let _0x3bbb4c=[];if(_0x2111a6['webhookEvents'])try{_0x3bbb4c=Array[_0x49eb20(0xd2)](_0x2111a6[_0x49eb20(0xe2)])?_0x2111a6[_0x49eb20(0xe2)]:JSON[_0x49eb20(0xd6)](_0x2111a6[_0x49eb20(0xe2)]);}catch(_0x28486f){console[_0x49eb20(0xd1)](_0x49eb20(0xed),_0x28486f),_0x3bbb4c=[];}if(!_0x3bbb4c[_0x49eb20(0x9f)](_0x2ad9dc)){console['log'](_0x49eb20(0xc5)+_0x2ad9dc+_0x49eb20(0xb5)+_0xfd3e90['id']);return;}const _0x5b4dff={'event':_0x2ad9dc,'payment':{'id':_0x33c3e7['id'],'order_id':_0x33c3e7['orderId'],'gateway_order_id':_0x33c3e7[_0x49eb20(0x96)],'gateway':_0x49eb20(0xca),'amount':_0x33c3e7[_0x49eb20(0x97)],'currency':_0x33c3e7[_0x49eb20(0xa5)],'status':_0x5860ba['toLowerCase'](),'customer_email':_0x33c3e7[_0x49eb20(0xf9)],'customer_name':_0x33c3e7[_0x49eb20(0xc3)],'transaction_id':_0x3e4408,'failure_message':_0x316c3a,'created_at':_0x33c3e7['createdAt'],'updated_at':new Date()}},_0x48183b=await fetch(_0x2111a6['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x49eb20(0xb6)](_0x5b4dff)}),_0x4c8d6c=Date[_0x49eb20(0xbe)]()-_0x16bcc0;console[_0x49eb20(0xee)](_0x49eb20(0xd0)+_0x2111a6[_0x49eb20(0xe5)]+'\x20with\x20status\x20'+_0x48183b[_0x49eb20(0xff)]+'\x20('+_0x4c8d6c+_0x49eb20(0xab));}catch(_0x29a89f){console['error'](_0x49eb20(0xd5),_0x29a89f);}}async[a15_0x59d36c(0x98)](_0x186007,_0x281f50){const _0x2d5d55=a15_0x59d36c;try{const {telegramBotService:_0x132ff6}=await Promise['resolve']()[_0x2d5d55(0xf7)](()=>__importStar(require(_0x2d5d55(0xc4)))),_0x5f3ae2={'PAID':_0x2d5d55(0xf8),'FAILED':_0x2d5d55(0xb3)},_0x343b62=_0x5f3ae2[_0x281f50];if(!_0x343b62)return;await _0x132ff6[_0x2d5d55(0xa8)](_0x186007['shopId'],_0x186007,_0x343b62);}catch(_0x8421e7){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x8421e7);}}}exports[a15_0x59d36c(0xec)]=TestGatewayController;