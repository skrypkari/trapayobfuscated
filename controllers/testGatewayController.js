'use strict';function a18_0x30a1(){const _0x1b5b32=['paymentLinkId','body','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','getOwnPropertyDescriptor','orderId','shopId','\x20with\x20status\x20','successUrl','paymentLink','configurable','31836RtFrCr','cardLast4','toLowerCase','get','paid','1424UjUPZD','32FueWlo','error','transactionId','../services/gateways/testGatewayService','ðŸ“ˆ\x20Found\x20payment\x20link\x20','payment.success','FAILED','failureReason','2552185iVaPsX','webhookEvents','status','paymentMethod','511iyptDR','SINGLE','\x20processed:\x20','PAID','1613272YLZNxD','toISOString','Payment\x20not\x20found','../services/telegramBotService','ðŸ§ª\x20Test\x20Gateway\x20result:','currency','__setModuleDefault','TestGatewayService','writable','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','payment','customerName','webhookUrl','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__importStar','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','$transaction','shop','27mFrNAz','Error\x20parsing\x20webhook\x20events:','create','paidAt','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processCard','6923560QOztbf','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','isArray','length','COMPLETED','log','Any\x20future\x20date\x20(MM/YY)','âŒ\x20Payment\x20link\x20','\x20->\x20','params','Payment\x20status\x20is\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','findUnique','cardNumber','test_gateway','hasOwnProperty','7623QMcLby','currentPayments','amount','payment.failed','Any\x20name','type','default','Webhook\x20event\x20','gatewayOrderId','getOwnPropertyNames','then','35220PqFYFv','TestGatewayController','update','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','954965kljlEY','../config/database','PENDING','WebhookService','testGatewayService','application/json','processCardPayment','failed','includes','Payment\x20failed','âœ…\x20Test\x20Gateway\x20payment\x20','customerEmail','\x20not\x20found','ms)','json','stringify','defineProperty',',\x20currentPayments=','__importDefault','webhookService','sendShopWebhook','Payment\x20System/1.0\x20(Test\x20Gateway)','0000','name','now','\x20updated:\x20currentPayments=','sendPaymentStatusNotification','getPaymentForm','__esModule'];a18_0x30a1=function(){return _0x1b5b32;};return a18_0x30a1();}const a18_0x2703a1=a18_0x17d5;(function(_0x1a0cbe,_0x46f0a8){const _0x2d93d6=a18_0x17d5,_0x4df30d=_0x1a0cbe();while(!![]){try{const _0x5a1641=-parseInt(_0x2d93d6(0xde))/0x1*(parseInt(_0x2d93d6(0x10f))/0x2)+-parseInt(_0x2d93d6(0x149))/0x3*(-parseInt(_0x2d93d6(0x10e))/0x4)+parseInt(_0x2d93d6(0x117))/0x5+-parseInt(_0x2d93d6(0x109))/0x6*(parseInt(_0x2d93d6(0x11b))/0x7)+-parseInt(_0x2d93d6(0x11f))/0x8*(parseInt(_0x2d93d6(0x133))/0x9)+parseInt(_0x2d93d6(0x139))/0xa+-parseInt(_0x2d93d6(0xe2))/0xb;if(_0x5a1641===_0x46f0a8)break;else _0x4df30d['push'](_0x4df30d['shift']());}catch(_0xe653f4){_0x4df30d['push'](_0x4df30d['shift']());}}}(a18_0x30a1,0x71763));function a18_0x17d5(_0x1339ae,_0x9257f){_0x1339ae=_0x1339ae-0xd4;const _0x30a18a=a18_0x30a1();let _0x17d5b2=_0x30a18a[_0x1339ae];return _0x17d5b2;}var __createBinding=this&&this['__createBinding']||(Object[a18_0x2703a1(0x135)]?function(_0x4759e2,_0xfe03ef,_0x3ea0ac,_0x1869f3){const _0x9f340b=a18_0x2703a1;if(_0x1869f3===undefined)_0x1869f3=_0x3ea0ac;var _0x37be4c=Object[_0x9f340b(0x102)](_0xfe03ef,_0x3ea0ac);(!_0x37be4c||(_0x9f340b(0x10c)in _0x37be4c?!_0xfe03ef[_0x9f340b(0xfe)]:_0x37be4c[_0x9f340b(0x127)]||_0x37be4c[_0x9f340b(0x108)]))&&(_0x37be4c={'enumerable':!![],'get':function(){return _0xfe03ef[_0x3ea0ac];}}),Object[_0x9f340b(0xf2)](_0x4759e2,_0x1869f3,_0x37be4c);}:function(_0x5b8c8d,_0x2293eb,_0x3b6587,_0x5ef247){if(_0x5ef247===undefined)_0x5ef247=_0x3b6587;_0x5b8c8d[_0x5ef247]=_0x2293eb[_0x3b6587];}),__setModuleDefault=this&&this[a18_0x2703a1(0x125)]||(Object['create']?function(_0x59ee2e,_0x11c7dd){const _0x31077a=a18_0x2703a1;Object[_0x31077a(0xf2)](_0x59ee2e,'default',{'enumerable':!![],'value':_0x11c7dd});}:function(_0x31bcb5,_0x5d8f4e){_0x31bcb5['default']=_0x5d8f4e;}),__importStar=this&&this[a18_0x2703a1(0x12e)]||(function(){var _0x49de2c=function(_0x200563){const _0x3daa9f=a18_0x17d5;return _0x49de2c=Object[_0x3daa9f(0xdc)]||function(_0x345303){const _0x2d4ad4=_0x3daa9f;var _0x336aba=[];for(var _0x501dd7 in _0x345303)if(Object['prototype'][_0x2d4ad4(0x148)]['call'](_0x345303,_0x501dd7))_0x336aba[_0x336aba[_0x2d4ad4(0x13c)]]=_0x501dd7;return _0x336aba;},_0x49de2c(_0x200563);};return function(_0x1489cc){const _0x4734f2=a18_0x17d5;if(_0x1489cc&&_0x1489cc[_0x4734f2(0xfe)])return _0x1489cc;var _0x3c85ff={};if(_0x1489cc!=null){for(var _0x1edb0f=_0x49de2c(_0x1489cc),_0x46c114=0x0;_0x46c114<_0x1edb0f[_0x4734f2(0x13c)];_0x46c114++)if(_0x1edb0f[_0x46c114]!==_0x4734f2(0xd9))__createBinding(_0x3c85ff,_0x1489cc,_0x1edb0f[_0x46c114]);}return __setModuleDefault(_0x3c85ff,_0x1489cc),_0x3c85ff;};}()),__importDefault=this&&this[a18_0x2703a1(0xf4)]||function(_0x5ee058){const _0x118d43=a18_0x2703a1;return _0x5ee058&&_0x5ee058[_0x118d43(0xfe)]?_0x5ee058:{'default':_0x5ee058};};Object[a18_0x2703a1(0xf2)](exports,a18_0x2703a1(0xfe),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a18_0x2703a1(0x112)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a18_0x2703a1(0xe3)));class TestGatewayController{constructor(){const _0x354e1f=a18_0x2703a1;this[_0x354e1f(0xfd)]=async(_0x328f33,_0xb94fcd,_0x37dc4b)=>{const _0x47fbb1=_0x354e1f;try{const {paymentId:_0x44cc35}=_0x328f33[_0x47fbb1(0x142)];console[_0x47fbb1(0x13e)](_0x47fbb1(0x101)+_0x44cc35);const _0x2000d2=await database_1['default'][_0x47fbb1(0x12a)][_0x47fbb1(0x145)]({'where':{'id':_0x44cc35},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2000d2)return _0xb94fcd[_0x47fbb1(0x119)](0x194)[_0x47fbb1(0xf0)]({'success':![],'message':_0x47fbb1(0x121)});if(_0x2000d2['gateway']!==_0x47fbb1(0x147))return _0xb94fcd[_0x47fbb1(0x119)](0x190)[_0x47fbb1(0xf0)]({'success':![],'message':_0x47fbb1(0x12f)});if(_0x2000d2['status']!=='PENDING')return _0xb94fcd[_0x47fbb1(0x119)](0x190)[_0x47fbb1(0xf0)]({'success':![],'message':_0x47fbb1(0x143)+_0x2000d2['status']+',\x20cannot\x20process'});_0xb94fcd[_0x47fbb1(0xf0)]({'success':!![],'result':{'paymentId':_0x2000d2['id'],'orderId':_0x2000d2[_0x47fbb1(0xdb)],'amount':_0x2000d2[_0x47fbb1(0xd5)],'currency':_0x2000d2[_0x47fbb1(0x124)],'merchantName':_0x2000d2[_0x47fbb1(0x132)][_0x47fbb1(0xf9)],'description':'Payment\x20to\x20'+_0x2000d2[_0x47fbb1(0x132)][_0x47fbb1(0xf9)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x47fbb1(0x13f),'cvc':'Any\x203-4\x20digits','holderName':_0x47fbb1(0xd7)}}});}catch(_0x477292){_0x37dc4b(_0x477292);}},this[_0x354e1f(0x138)]=async(_0x622b40,_0xc84719,_0x354dfa)=>{const _0x2fa162=_0x354e1f;try{const {paymentId:_0x4d0652}=_0x622b40['params'],_0x358123=_0x622b40[_0x2fa162(0x100)];console['log'](_0x2fa162(0xe1)+_0x4d0652);const _0x316817=await database_1['default'][_0x2fa162(0x12a)][_0x2fa162(0x145)]({'where':{'id':_0x4d0652},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x316817)return _0xc84719['status'](0x194)[_0x2fa162(0xf0)]({'success':![],'message':_0x2fa162(0x121)});if(_0x316817['gateway']!==_0x2fa162(0x147))return _0xc84719[_0x2fa162(0x119)](0x190)[_0x2fa162(0xf0)]({'success':![],'message':_0x2fa162(0x12f)});if(_0x316817[_0x2fa162(0x119)]!=='PENDING')return _0xc84719[_0x2fa162(0x119)](0x190)[_0x2fa162(0xf0)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x316817['status']+',\x20cannot\x20process'});const _0x47d2b4=await this[_0x2fa162(0xe6)][_0x2fa162(0xe8)]({'paymentId':_0x316817['id'],'orderId':_0x316817['gatewayOrderId']||_0x316817['id'],'amount':_0x316817[_0x2fa162(0xd5)],'currency':_0x316817['currency'],'cardData':_0x358123});console[_0x2fa162(0x13e)](_0x2fa162(0x123),_0x47d2b4);const _0x67afca={'status':_0x47d2b4[_0x2fa162(0x119)],'updatedAt':new Date()};if(_0x47d2b4[_0x2fa162(0x119)]===_0x2fa162(0x11e))_0x67afca[_0x2fa162(0x136)]=new Date(),_0x67afca['gatewayPaymentId']=_0x47d2b4[_0x2fa162(0x111)];else _0x47d2b4['status']==='FAILED'&&(_0x67afca['failureMessage']=_0x47d2b4[_0x2fa162(0x116)]);const _0xb04aa7=_0x358123[_0x2fa162(0x146)]['replace'](/[\s-]/g,'');_0x67afca[_0x2fa162(0x10a)]=_0xb04aa7['slice'](-0x4),_0x67afca[_0x2fa162(0x11a)]='test_card',await database_1[_0x2fa162(0xd9)][_0x2fa162(0x12a)][_0x2fa162(0xe0)]({'where':{'id':_0x316817['id']},'data':_0x67afca});if(_0x47d2b4[_0x2fa162(0x119)]===_0x2fa162(0x11e)&&_0x316817[_0x2fa162(0xff)]){console[_0x2fa162(0x13e)](_0x2fa162(0x13a)+_0x316817['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x2fa162(0xd9)][_0x2fa162(0x131)](async _0x33b679=>{const _0x2bbd40=_0x2fa162,_0xb67ba1=await _0x33b679[_0x2bbd40(0x107)][_0x2bbd40(0x145)]({'where':{'id':_0x316817[_0x2bbd40(0xff)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xb67ba1){console[_0x2bbd40(0x13e)](_0x2bbd40(0x113)+_0xb67ba1['id']+':\x20type='+_0xb67ba1[_0x2bbd40(0xd8)]+_0x2bbd40(0xf3)+_0xb67ba1[_0x2bbd40(0xd4)]+',\x20status='+_0xb67ba1[_0x2bbd40(0x119)]);const _0x37c502=_0xb67ba1[_0x2bbd40(0xd4)]+0x1,_0x3949c6=_0xb67ba1[_0x2bbd40(0xd8)]===_0x2bbd40(0x11c)?_0x2bbd40(0x13d):_0xb67ba1[_0x2bbd40(0x119)];await _0x33b679[_0x2bbd40(0x107)]['update']({'where':{'id':_0x316817[_0x2bbd40(0xff)]},'data':{'currentPayments':_0x37c502,'status':_0x3949c6,'updatedAt':new Date()}}),console[_0x2bbd40(0x13e)]('âœ…\x20Payment\x20link\x20'+_0xb67ba1['id']+_0x2bbd40(0xfb)+_0xb67ba1[_0x2bbd40(0xd4)]+_0x2bbd40(0x141)+_0x37c502+',\x20status='+_0xb67ba1[_0x2bbd40(0x119)]+_0x2bbd40(0x141)+_0x3949c6);}else console[_0x2bbd40(0x13e)](_0x2bbd40(0x140)+_0x316817['paymentLinkId']+_0x2bbd40(0xee));});}catch(_0x325b56){console[_0x2fa162(0x110)]('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x325b56);}}await database_1['default']['webhookLog'][_0x2fa162(0x135)]({'data':{'paymentId':_0x316817['id'],'shopId':_0x316817[_0x2fa162(0x104)],'event':_0x2fa162(0x130)+_0x47d2b4[_0x2fa162(0x119)][_0x2fa162(0x10b)](),'statusCode':0xc8,'responseBody':JSON[_0x2fa162(0xf1)]({'oldStatus':_0x2fa162(0xe4),'newStatus':_0x47d2b4[_0x2fa162(0x119)],'transactionId':_0x47d2b4[_0x2fa162(0x111)],'failureReason':_0x47d2b4['failureReason'],'processedAt':new Date()[_0x2fa162(0x120)]()})}}),await this['sendShopWebhook'](_0x316817,_0x47d2b4['status'],_0x47d2b4[_0x2fa162(0x111)],_0x47d2b4[_0x2fa162(0x116)]),await this[_0x2fa162(0xfc)](_0x316817,_0x47d2b4[_0x2fa162(0x119)]),console['log'](_0x2fa162(0xec)+_0x4d0652+_0x2fa162(0x11d)+_0x47d2b4['status']),_0x47d2b4[_0x2fa162(0x119)]==='PAID'?_0xc84719[_0x2fa162(0xf0)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2fa162(0x11e),'transactionId':_0x47d2b4[_0x2fa162(0x111)],'redirectUrl':_0x316817[_0x2fa162(0x106)]}}):_0xc84719[_0x2fa162(0x119)](0x190)[_0x2fa162(0xf0)]({'success':![],'message':_0x2fa162(0xeb),'result':{'status':_0x2fa162(0x115),'failureReason':_0x47d2b4[_0x2fa162(0x116)],'redirectUrl':_0x316817['failUrl']}});}catch(_0xb04465){_0x354dfa(_0xb04465);}},this[_0x354e1f(0xe6)]=new testGatewayService_1[(_0x354e1f(0x126))](),this[_0x354e1f(0xf5)]=new webhookService_1[(_0x354e1f(0xe5))]();}async[a18_0x2703a1(0xf6)](_0x19d846,_0x37c54e,_0x20ad1d,_0x122ad5){const _0x73d6c8=a18_0x2703a1,_0x2e477d=Date[_0x73d6c8(0xfa)]();try{const _0x106677=_0x19d846[_0x73d6c8(0x132)],_0x57c0ff=_0x106677['settings'];if(!_0x57c0ff?.[_0x73d6c8(0x12c)]){console[_0x73d6c8(0x13e)](_0x73d6c8(0x12d)+_0x106677['id']);return;}const _0x31b3fd=_0x37c54e==='PAID'?_0x73d6c8(0x114):_0x73d6c8(0xd6);let _0xb1c9d6=[];if(_0x57c0ff[_0x73d6c8(0x118)])try{_0xb1c9d6=Array[_0x73d6c8(0x13b)](_0x57c0ff[_0x73d6c8(0x118)])?_0x57c0ff['webhookEvents']:JSON['parse'](_0x57c0ff[_0x73d6c8(0x118)]);}catch(_0x397b08){console[_0x73d6c8(0x110)](_0x73d6c8(0x134),_0x397b08),_0xb1c9d6=[];}if(!_0xb1c9d6[_0x73d6c8(0xea)](_0x31b3fd)){console['log'](_0x73d6c8(0xda)+_0x31b3fd+_0x73d6c8(0x129)+_0x106677['id']);return;}const _0x592a20={'event':_0x31b3fd,'payment':{'id':_0x19d846['id'],'order_id':_0x19d846[_0x73d6c8(0x103)],'gateway_order_id':_0x19d846[_0x73d6c8(0xdb)],'gateway':_0x73d6c8(0xf8),'amount':_0x19d846[_0x73d6c8(0xd5)],'currency':_0x19d846['currency'],'status':_0x37c54e[_0x73d6c8(0x10b)](),'customer_email':_0x19d846[_0x73d6c8(0xed)],'customer_name':_0x19d846[_0x73d6c8(0x12b)],'transaction_id':_0x20ad1d,'failure_message':_0x122ad5,'created_at':_0x19d846['createdAt'],'updated_at':new Date()}},_0x54f1e6=await fetch(_0x57c0ff[_0x73d6c8(0x12c)],{'method':'POST','headers':{'Content-Type':_0x73d6c8(0xe7),'User-Agent':_0x73d6c8(0xf7)},'body':JSON[_0x73d6c8(0xf1)](_0x592a20)}),_0xf48e10=Date['now']()-_0x2e477d;console[_0x73d6c8(0x13e)](_0x73d6c8(0x144)+_0x57c0ff[_0x73d6c8(0x12c)]+_0x73d6c8(0x105)+_0x54f1e6[_0x73d6c8(0x119)]+'\x20('+_0xf48e10+_0x73d6c8(0xef));}catch(_0x1f9ddb){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x1f9ddb);}}async['sendPaymentStatusNotification'](_0x2f736d,_0x14d948){const _0x2b8447=a18_0x2703a1;try{const {telegramBotService:_0x5d708e}=await Promise['resolve']()[_0x2b8447(0xdd)](()=>__importStar(require(_0x2b8447(0x122)))),_0x3a2f0d={'PAID':_0x2b8447(0x10d),'FAILED':_0x2b8447(0xe9)},_0x4715d3=_0x3a2f0d[_0x14d948];if(!_0x4715d3)return;await _0x5d708e[_0x2b8447(0x128)](_0x2f736d[_0x2b8447(0x104)],_0x2f736d,_0x4715d3);}catch(_0xac8ad2){console[_0x2b8447(0x110)](_0x2b8447(0x137),_0xac8ad2);}}}exports[a18_0x2703a1(0xdf)]=TestGatewayController;