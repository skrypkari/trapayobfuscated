'use strict';function a13_0x5335(){const _0x228ee1=['Error\x20parsing\x20webhook\x20events:','paidAt','__importStar','getOwnPropertyNames','gatewayPaymentId','failureMessage','Any\x20future\x20date\x20(MM/YY)','shopId','webhookUrl','Payment\x20status\x20is\x20','../services/webhookService','Payment\x20to\x20','paymentMethod','stringify','Any\x203-4\x20digits','currency','default','cardNumber','Any\x20other\x20card\x20number','Any\x20name','5iElqVa','processCardPayment','isArray','body','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20cannot\x20process','__setModuleDefault','__esModule','759132bqjxzn','3320FwrEuL','test_card','toLowerCase','status','gatewayOrderId','includes','createdAt','processCard','âœ…\x20Test\x20Gateway\x20payment\x20','test_gateway_','toISOString','0000','slice','../services/gateways/testGatewayService','sendShopWebhook','4242\x204242\x204242\x204242','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','testGatewayService','217275KaOQbi','webhookLog','cardLast4','FAILED','ðŸ§ª\x20Test\x20Gateway\x20result:','failureReason','update','getOwnPropertyDescriptor','defineProperty','log','3788547yYvZNk','customerName','name','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20processed:\x20','__createBinding','746836BenGOW','create','14985ZqQYTV','call','3347804sthPWr','prototype','error','\x20with\x20status\x20','json','transactionId','test_gateway','amount','ms)','failUrl','params','replace','\x20not\x20enabled\x20for\x20shop\x20','TestGatewayService','Payment\x20is\x20not\x20for\x20test\x20gateway','now','findUnique','successUrl','sendPaymentStatusNotification','webhookEvents','__importDefault','../config/database','PAID','WebhookService','shop','sendPaymentNotification','customerEmail','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','gateway','payment.success','1873980WcBoRL','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20not\x20found','webhookService','payment','PENDING'];a13_0x5335=function(){return _0x228ee1;};return a13_0x5335();}function a13_0x28a9(_0xcfc3d6,_0x3e13a4){const _0x5335ed=a13_0x5335();return a13_0x28a9=function(_0x28a91c,_0x46e36f){_0x28a91c=_0x28a91c-0x97;let _0x4c9d26=_0x5335ed[_0x28a91c];return _0x4c9d26;},a13_0x28a9(_0xcfc3d6,_0x3e13a4);}const a13_0x50d0f6=a13_0x28a9;(function(_0xc3f960,_0x5c28c2){const _0x53ada3=a13_0x28a9,_0x23377e=_0xc3f960();while(!![]){try{const _0x5536a8=parseInt(_0x53ada3(0xd9))/0x1+-parseInt(_0x53ada3(0xfc))/0x2+parseInt(_0x53ada3(0xec))/0x3+parseInt(_0x53ada3(0x99))/0x4*(parseInt(_0x53ada3(0xd1))/0x5)+-parseInt(_0x53ada3(0xb7))/0x6+parseInt(_0x53ada3(0xf6))/0x7+parseInt(_0x53ada3(0xda))/0x8*(-parseInt(_0x53ada3(0x97))/0x9);if(_0x5536a8===_0x5c28c2)break;else _0x23377e['push'](_0x23377e['shift']());}catch(_0x15c297){_0x23377e['push'](_0x23377e['shift']());}}}(a13_0x5335,0xcb5ee));var __createBinding=this&&this[a13_0x50d0f6(0xfb)]||(Object[a13_0x50d0f6(0xfd)]?function(_0x5f039a,_0x9a6288,_0x457dda,_0x857fbb){const _0x5626ff=a13_0x50d0f6;if(_0x857fbb===undefined)_0x857fbb=_0x457dda;var _0x5d7319=Object[_0x5626ff(0xf3)](_0x9a6288,_0x457dda);(!_0x5d7319||('get'in _0x5d7319?!_0x9a6288[_0x5626ff(0xd8)]:_0x5d7319['writable']||_0x5d7319['configurable']))&&(_0x5d7319={'enumerable':!![],'get':function(){return _0x9a6288[_0x457dda];}}),Object[_0x5626ff(0xf4)](_0x5f039a,_0x857fbb,_0x5d7319);}:function(_0x51e958,_0x567f78,_0x19d93e,_0x2207ab){if(_0x2207ab===undefined)_0x2207ab=_0x19d93e;_0x51e958[_0x2207ab]=_0x567f78[_0x19d93e];}),__setModuleDefault=this&&this[a13_0x50d0f6(0xd7)]||(Object[a13_0x50d0f6(0xfd)]?function(_0x18ce09,_0x1f493d){const _0x543d8a=a13_0x50d0f6;Object[_0x543d8a(0xf4)](_0x18ce09,_0x543d8a(0xcd),{'enumerable':!![],'value':_0x1f493d});}:function(_0x2abeca,_0x25d5dc){const _0x52ca74=a13_0x50d0f6;_0x2abeca[_0x52ca74(0xcd)]=_0x25d5dc;}),__importStar=this&&this[a13_0x50d0f6(0xbf)]||(function(){var _0x5dd0e4=function(_0x52425a){const _0xf4ccf5=a13_0x28a9;return _0x5dd0e4=Object[_0xf4ccf5(0xc0)]||function(_0x103490){const _0x12ad5b=_0xf4ccf5;var _0x5223c7=[];for(var _0x22f17f in _0x103490)if(Object[_0x12ad5b(0x9a)]['hasOwnProperty'][_0x12ad5b(0x98)](_0x103490,_0x22f17f))_0x5223c7[_0x5223c7['length']]=_0x22f17f;return _0x5223c7;},_0x5dd0e4(_0x52425a);};return function(_0x533ce5){const _0x1a6723=a13_0x28a9;if(_0x533ce5&&_0x533ce5['__esModule'])return _0x533ce5;var _0x46a5ad={};if(_0x533ce5!=null){for(var _0x257e16=_0x5dd0e4(_0x533ce5),_0x2c8025=0x0;_0x2c8025<_0x257e16['length'];_0x2c8025++)if(_0x257e16[_0x2c8025]!==_0x1a6723(0xcd))__createBinding(_0x46a5ad,_0x533ce5,_0x257e16[_0x2c8025]);}return __setModuleDefault(_0x46a5ad,_0x533ce5),_0x46a5ad;};}()),__importDefault=this&&this[a13_0x50d0f6(0xad)]||function(_0x225b26){const _0x28ac23=a13_0x50d0f6;return _0x225b26&&_0x225b26[_0x28ac23(0xd8)]?_0x225b26:{'default':_0x225b26};};Object['defineProperty'](exports,a13_0x50d0f6(0xd8),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x50d0f6(0xe7)),webhookService_1=require(a13_0x50d0f6(0xc7)),database_1=__importDefault(require(a13_0x50d0f6(0xae)));class TestGatewayController{constructor(){const _0x194ff9=a13_0x50d0f6;this['getPaymentForm']=async(_0xea7eee,_0x3439e3,_0x4bc57e)=>{const _0x3a52fe=a13_0x28a9;try{const {paymentId:_0x1d0a6c}=_0xea7eee[_0x3a52fe(0xa3)];console[_0x3a52fe(0xf5)](_0x3a52fe(0xb4)+_0x1d0a6c);const _0x4ccba9=await database_1[_0x3a52fe(0xcd)]['payment'][_0x3a52fe(0xa9)]({'where':{'id':_0x1d0a6c},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4ccba9)return _0x3439e3['status'](0x194)['json']({'success':![],'message':_0x3a52fe(0xb9)});if(_0x4ccba9[_0x3a52fe(0xb5)]!==_0x3a52fe(0x9f))return _0x3439e3[_0x3a52fe(0xdd)](0x190)['json']({'success':![],'message':_0x3a52fe(0xa7)});if(_0x4ccba9[_0x3a52fe(0xdd)]!==_0x3a52fe(0xbc))return _0x3439e3['status'](0x190)[_0x3a52fe(0x9d)]({'success':![],'message':_0x3a52fe(0xc6)+_0x4ccba9[_0x3a52fe(0xdd)]+_0x3a52fe(0xd6)});_0x3439e3['json']({'success':!![],'result':{'paymentId':_0x4ccba9['id'],'orderId':_0x4ccba9[_0x3a52fe(0xde)],'amount':_0x4ccba9[_0x3a52fe(0xa0)],'currency':_0x4ccba9[_0x3a52fe(0xcc)],'merchantName':_0x4ccba9[_0x3a52fe(0xb1)][_0x3a52fe(0xf8)],'description':_0x3a52fe(0xc8)+_0x4ccba9[_0x3a52fe(0xb1)]['name'],'testInstructions':{'successCard':_0x3a52fe(0xe9),'failureCard':_0x3a52fe(0xcf),'expiryDate':_0x3a52fe(0xc3),'cvc':_0x3a52fe(0xcb),'holderName':_0x3a52fe(0xd0)}}});}catch(_0x29f009){_0x4bc57e(_0x29f009);}},this[_0x194ff9(0xe1)]=async(_0x238b8f,_0x22857b,_0x45262d)=>{const _0x170c70=_0x194ff9;try{const {paymentId:_0x3914d1}=_0x238b8f[_0x170c70(0xa3)],_0x351a47=_0x238b8f[_0x170c70(0xd4)];console[_0x170c70(0xf5)](_0x170c70(0xea)+_0x3914d1);const _0x545f01=await database_1['default'][_0x170c70(0xbb)][_0x170c70(0xa9)]({'where':{'id':_0x3914d1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x545f01)return _0x22857b[_0x170c70(0xdd)](0x194)[_0x170c70(0x9d)]({'success':![],'message':_0x170c70(0xb9)});if(_0x545f01[_0x170c70(0xb5)]!=='test_gateway')return _0x22857b['status'](0x190)[_0x170c70(0x9d)]({'success':![],'message':_0x170c70(0xa7)});if(_0x545f01['status']!==_0x170c70(0xbc))return _0x22857b[_0x170c70(0xdd)](0x190)[_0x170c70(0x9d)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x545f01[_0x170c70(0xdd)]+',\x20cannot\x20process'});const _0x1b8569=await this[_0x170c70(0xeb)][_0x170c70(0xd2)]({'paymentId':_0x545f01['id'],'orderId':_0x545f01[_0x170c70(0xde)]||_0x545f01['id'],'amount':_0x545f01[_0x170c70(0xa0)],'currency':_0x545f01[_0x170c70(0xcc)],'cardData':_0x351a47});console[_0x170c70(0xf5)](_0x170c70(0xf0),_0x1b8569);const _0x40429d={'status':_0x1b8569['status'],'updatedAt':new Date()};if(_0x1b8569[_0x170c70(0xdd)]===_0x170c70(0xaf))_0x40429d[_0x170c70(0xbe)]=new Date(),_0x40429d[_0x170c70(0xc1)]=_0x1b8569['transactionId'];else _0x1b8569[_0x170c70(0xdd)]===_0x170c70(0xef)&&(_0x40429d[_0x170c70(0xc2)]=_0x1b8569[_0x170c70(0xf1)]);const _0x2013a6=_0x351a47[_0x170c70(0xce)][_0x170c70(0xa4)](/[\s-]/g,'');_0x40429d[_0x170c70(0xee)]=_0x2013a6[_0x170c70(0xe6)](-0x4),_0x40429d[_0x170c70(0xc9)]=_0x170c70(0xdb),await database_1[_0x170c70(0xcd)]['payment'][_0x170c70(0xf2)]({'where':{'id':_0x545f01['id']},'data':_0x40429d}),await database_1['default'][_0x170c70(0xed)][_0x170c70(0xfd)]({'data':{'paymentId':_0x545f01['id'],'shopId':_0x545f01[_0x170c70(0xc4)],'event':_0x170c70(0xe3)+_0x1b8569[_0x170c70(0xdd)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x170c70(0xbc),'newStatus':_0x1b8569[_0x170c70(0xdd)],'transactionId':_0x1b8569['transactionId'],'failureReason':_0x1b8569[_0x170c70(0xf1)],'processedAt':new Date()[_0x170c70(0xe4)]()})}}),await this[_0x170c70(0xe8)](_0x545f01,_0x1b8569['status'],_0x1b8569[_0x170c70(0x9e)],_0x1b8569['failureReason']),await this[_0x170c70(0xab)](_0x545f01,_0x1b8569[_0x170c70(0xdd)]),console[_0x170c70(0xf5)](_0x170c70(0xe2)+_0x3914d1+_0x170c70(0xfa)+_0x1b8569['status']),_0x1b8569[_0x170c70(0xdd)]==='PAID'?_0x22857b[_0x170c70(0x9d)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x170c70(0xaf),'transactionId':_0x1b8569[_0x170c70(0x9e)],'redirectUrl':_0x545f01[_0x170c70(0xaa)]}}):_0x22857b[_0x170c70(0xdd)](0x190)[_0x170c70(0x9d)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x170c70(0xef),'failureReason':_0x1b8569['failureReason'],'redirectUrl':_0x545f01[_0x170c70(0xa2)]}});}catch(_0x229633){_0x45262d(_0x229633);}},this[_0x194ff9(0xeb)]=new testGatewayService_1[(_0x194ff9(0xa6))](),this[_0x194ff9(0xba)]=new webhookService_1[(_0x194ff9(0xb0))]();}async[a13_0x50d0f6(0xe8)](_0x5624f1,_0x4e1db1,_0x2bd9a0,_0x38a30b){const _0x10b499=a13_0x50d0f6,_0x76065a=Date[_0x10b499(0xa8)]();try{const _0x25663b=_0x5624f1['shop'],_0x2f8ff5=_0x25663b['settings'];if(!_0x2f8ff5?.['webhookUrl']){console[_0x10b499(0xf5)](_0x10b499(0xb8)+_0x25663b['id']);return;}const _0x594e35=_0x4e1db1===_0x10b499(0xaf)?_0x10b499(0xb6):'payment.failed';let _0x466094=[];if(_0x2f8ff5[_0x10b499(0xac)])try{_0x466094=Array[_0x10b499(0xd3)](_0x2f8ff5[_0x10b499(0xac)])?_0x2f8ff5['webhookEvents']:JSON['parse'](_0x2f8ff5[_0x10b499(0xac)]);}catch(_0x3123d7){console[_0x10b499(0x9b)](_0x10b499(0xbd),_0x3123d7),_0x466094=[];}if(!_0x466094[_0x10b499(0xdf)](_0x594e35)){console[_0x10b499(0xf5)]('Webhook\x20event\x20'+_0x594e35+_0x10b499(0xa5)+_0x25663b['id']);return;}const _0x51fdd5={'event':_0x594e35,'payment':{'id':_0x5624f1['id'],'order_id':_0x5624f1['orderId'],'gateway_order_id':_0x5624f1['gatewayOrderId'],'gateway':_0x10b499(0xe5),'amount':_0x5624f1[_0x10b499(0xa0)],'currency':_0x5624f1[_0x10b499(0xcc)],'status':_0x4e1db1[_0x10b499(0xdc)](),'customer_email':_0x5624f1[_0x10b499(0xb3)],'customer_name':_0x5624f1[_0x10b499(0xf7)],'transaction_id':_0x2bd9a0,'failure_message':_0x38a30b,'created_at':_0x5624f1[_0x10b499(0xe0)],'updated_at':new Date()}},_0x427ee4=await fetch(_0x2f8ff5[_0x10b499(0xc5)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x10b499(0xca)](_0x51fdd5)}),_0x1e660c=Date['now']()-_0x76065a;console[_0x10b499(0xf5)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2f8ff5['webhookUrl']+_0x10b499(0x9c)+_0x427ee4[_0x10b499(0xdd)]+'\x20('+_0x1e660c+_0x10b499(0xa1));}catch(_0x55957f){console[_0x10b499(0x9b)](_0x10b499(0xf9),_0x55957f);}}async[a13_0x50d0f6(0xab)](_0x586b53,_0x4c36d0){const _0x137aac=a13_0x50d0f6;try{const {telegramBotService:_0xc0bbb5}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0xc906c5={'PAID':'paid','FAILED':'failed'},_0x5d227f=_0xc906c5[_0x4c36d0];if(!_0x5d227f)return;await _0xc0bbb5[_0x137aac(0xb2)](_0x586b53[_0x137aac(0xc4)],_0x586b53,_0x5d227f);}catch(_0x1f58a){console['error'](_0x137aac(0xd5),_0x1f58a);}}}exports['TestGatewayController']=TestGatewayController;