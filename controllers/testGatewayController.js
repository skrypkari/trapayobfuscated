'use strict';function a13_0xa524(){const _0x413e63=['paid','createdAt','failureReason','360007HhEYfv','webhookLog','\x20->\x20','findUnique','log','isArray','5577132epWUXc','update','replace','successUrl',':\x20type=',',\x20currentPayments=','paymentLink','5127645DShskC','processCard','üß™\x20Test\x20Gateway\x20result:','defineProperty','payment','params','Payment\x20not\x20found','default','test_gateway_','resolve','‚ùå\x20Payment\x20link\x20','Any\x20name','\x20with\x20status\x20','Payment\x20to\x20','transactionId','PAID','then','configurable','shop','__createBinding','stringify','getOwnPropertyDescriptor','now','processCardPayment','status','‚úÖ\x20Payment\x20link\x20','currentPayments','settings','\x20processed:\x20','toISOString','shopId','gateway','writable','__importStar','webhookEvents','16105203DmqKoZ','266838wQVkMi','Any\x20other\x20card\x20number','2487296RGjOMv','0000','üìà\x20Found\x20payment\x20link\x20','create','TestGatewayController','$transaction','testGatewayService','TestGatewayService',',\x20status=','4iVEVZc','../config/database','../services/webhookService','getOwnPropertyNames','Payment\x20failed','sendShopWebhook','sendPaymentStatusNotification','Any\x203-4\x20digits','gatewayPaymentId','paidAt','currency','failureMessage','includes','parse','16804LWdfJT','length','webhookUrl','__importDefault','customerEmail','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','COMPLETED','slice','call','failed','üìà\x20Test\x20Gateway:\x20Payment\x20','paymentLinkId','orderId','name','4242\x204242\x204242\x204242','PENDING','POST','7awazSb','__setModuleDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','Error\x20parsing\x20webhook\x20events:','amount','failUrl','__esModule','FAILED','Payment\x20status\x20is\x20','application/json','Test\x20Gateway\x20webhook\x20sent\x20to\x20','cardNumber','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20cannot\x20process','‚úÖ\x20Test\x20Gateway\x20payment\x20','toLowerCase','webhookService','test_gateway','type','error','gatewayOrderId','getPaymentForm','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','json','prototype','\x20not\x20found','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','sendPaymentNotification'];a13_0xa524=function(){return _0x413e63;};return a13_0xa524();}const a13_0x4c6a47=a13_0x5ca2;(function(_0x337535,_0x1e9a06){const _0x5e0d0d=a13_0x5ca2,_0x30fe36=_0x337535();while(!![]){try{const _0x3c8167=parseInt(_0x5e0d0d(0x196))/0x1+parseInt(_0x5e0d0d(0x166))/0x2+-parseInt(_0x5e0d0d(0x14d))/0x3+-parseInt(_0x5e0d0d(0x158))/0x4*(-parseInt(_0x5e0d0d(0x129))/0x5)+-parseInt(_0x5e0d0d(0x19c))/0x6*(-parseInt(_0x5e0d0d(0x177))/0x7)+parseInt(_0x5e0d0d(0x14f))/0x8+-parseInt(_0x5e0d0d(0x14c))/0x9;if(_0x3c8167===_0x1e9a06)break;else _0x30fe36['push'](_0x30fe36['shift']());}catch(_0x1b13fd){_0x30fe36['push'](_0x30fe36['shift']());}}}(a13_0xa524,0xb88f7));var __createBinding=this&&this[a13_0x4c6a47(0x13c)]||(Object[a13_0x4c6a47(0x152)]?function(_0x3bb505,_0x4ce4dd,_0x85edec,_0x11c5e6){const _0x11be41=a13_0x4c6a47;if(_0x11c5e6===undefined)_0x11c5e6=_0x85edec;var _0x488c14=Object[_0x11be41(0x13e)](_0x4ce4dd,_0x85edec);(!_0x488c14||('get'in _0x488c14?!_0x4ce4dd[_0x11be41(0x17d)]:_0x488c14[_0x11be41(0x149)]||_0x488c14[_0x11be41(0x13a)]))&&(_0x488c14={'enumerable':!![],'get':function(){return _0x4ce4dd[_0x85edec];}}),Object[_0x11be41(0x12c)](_0x3bb505,_0x11c5e6,_0x488c14);}:function(_0x10f29c,_0x4ffb14,_0xf81c01,_0x4df548){if(_0x4df548===undefined)_0x4df548=_0xf81c01;_0x10f29c[_0x4df548]=_0x4ffb14[_0xf81c01];}),__setModuleDefault=this&&this[a13_0x4c6a47(0x178)]||(Object[a13_0x4c6a47(0x152)]?function(_0x578df0,_0x424705){const _0x33ff81=a13_0x4c6a47;Object[_0x33ff81(0x12c)](_0x578df0,_0x33ff81(0x130),{'enumerable':!![],'value':_0x424705});}:function(_0x40e4fd,_0x4aa16d){const _0x2cfce3=a13_0x4c6a47;_0x40e4fd[_0x2cfce3(0x130)]=_0x4aa16d;}),__importStar=this&&this[a13_0x4c6a47(0x14a)]||(function(){var _0x1aaeb2=function(_0xc7c324){const _0x420341=a13_0x5ca2;return _0x1aaeb2=Object[_0x420341(0x15b)]||function(_0x296564){const _0x3b3c2e=_0x420341;var _0x4e4f6b=[];for(var _0x141479 in _0x296564)if(Object[_0x3b3c2e(0x18f)]['hasOwnProperty'][_0x3b3c2e(0x16e)](_0x296564,_0x141479))_0x4e4f6b[_0x4e4f6b[_0x3b3c2e(0x167)]]=_0x141479;return _0x4e4f6b;},_0x1aaeb2(_0xc7c324);};return function(_0x555e07){const _0x11fab8=a13_0x5ca2;if(_0x555e07&&_0x555e07[_0x11fab8(0x17d)])return _0x555e07;var _0x24da07={};if(_0x555e07!=null){for(var _0xb831d7=_0x1aaeb2(_0x555e07),_0x2a6baa=0x0;_0x2a6baa<_0xb831d7[_0x11fab8(0x167)];_0x2a6baa++)if(_0xb831d7[_0x2a6baa]!=='default')__createBinding(_0x24da07,_0x555e07,_0xb831d7[_0x2a6baa]);}return __setModuleDefault(_0x24da07,_0x555e07),_0x24da07;};}()),__importDefault=this&&this[a13_0x4c6a47(0x169)]||function(_0x2ee34f){return _0x2ee34f&&_0x2ee34f['__esModule']?_0x2ee34f:{'default':_0x2ee34f};};Object[a13_0x4c6a47(0x12c)](exports,a13_0x4c6a47(0x17d),{'value':!![]}),exports[a13_0x4c6a47(0x153)]=void 0x0;function a13_0x5ca2(_0x3e8805,_0x4275fe){const _0xa5247a=a13_0xa524();return a13_0x5ca2=function(_0x5ca2cc,_0x285321){_0x5ca2cc=_0x5ca2cc-0x125;let _0x224758=_0xa5247a[_0x5ca2cc];return _0x224758;},a13_0x5ca2(_0x3e8805,_0x4275fe);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x4c6a47(0x15a)),database_1=__importDefault(require(a13_0x4c6a47(0x159)));class TestGatewayController{constructor(){const _0x2e2246=a13_0x4c6a47;this[_0x2e2246(0x18c)]=async(_0x3850ac,_0x2298b6,_0x25261f)=>{const _0x4e35d2=_0x2e2246;try{const {paymentId:_0x12d20b}=_0x3850ac[_0x4e35d2(0x12e)];console[_0x4e35d2(0x19a)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x12d20b);const _0x1ae851=await database_1[_0x4e35d2(0x130)]['payment']['findUnique']({'where':{'id':_0x12d20b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1ae851)return _0x2298b6[_0x4e35d2(0x141)](0x194)[_0x4e35d2(0x18e)]({'success':![],'message':_0x4e35d2(0x12f)});if(_0x1ae851[_0x4e35d2(0x148)]!=='test_gateway')return _0x2298b6[_0x4e35d2(0x141)](0x190)[_0x4e35d2(0x18e)]({'success':![],'message':_0x4e35d2(0x179)});if(_0x1ae851[_0x4e35d2(0x141)]!==_0x4e35d2(0x175))return _0x2298b6[_0x4e35d2(0x141)](0x190)[_0x4e35d2(0x18e)]({'success':![],'message':_0x4e35d2(0x17f)+_0x1ae851[_0x4e35d2(0x141)]+_0x4e35d2(0x184)});_0x2298b6[_0x4e35d2(0x18e)]({'success':!![],'result':{'paymentId':_0x1ae851['id'],'orderId':_0x1ae851[_0x4e35d2(0x18b)],'amount':_0x1ae851[_0x4e35d2(0x17b)],'currency':_0x1ae851[_0x4e35d2(0x162)],'merchantName':_0x1ae851[_0x4e35d2(0x13b)]['name'],'description':_0x4e35d2(0x136)+_0x1ae851[_0x4e35d2(0x13b)][_0x4e35d2(0x173)],'testInstructions':{'successCard':_0x4e35d2(0x174),'failureCard':_0x4e35d2(0x14e),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x4e35d2(0x15f),'holderName':_0x4e35d2(0x134)}}});}catch(_0x13ac55){_0x25261f(_0x13ac55);}},this[_0x2e2246(0x12a)]=async(_0x7e74fe,_0x3be4ca,_0x6cafb7)=>{const _0x57b9ae=_0x2e2246;try{const {paymentId:_0x3d15a9}=_0x7e74fe[_0x57b9ae(0x12e)],_0x1b9b70=_0x7e74fe['body'];console[_0x57b9ae(0x19a)](_0x57b9ae(0x191)+_0x3d15a9);const _0xe36a59=await database_1[_0x57b9ae(0x130)][_0x57b9ae(0x12d)][_0x57b9ae(0x199)]({'where':{'id':_0x3d15a9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe36a59)return _0x3be4ca[_0x57b9ae(0x141)](0x194)[_0x57b9ae(0x18e)]({'success':![],'message':_0x57b9ae(0x12f)});if(_0xe36a59[_0x57b9ae(0x148)]!==_0x57b9ae(0x188))return _0x3be4ca[_0x57b9ae(0x141)](0x190)[_0x57b9ae(0x18e)]({'success':![],'message':_0x57b9ae(0x179)});if(_0xe36a59[_0x57b9ae(0x141)]!=='PENDING')return _0x3be4ca[_0x57b9ae(0x141)](0x190)['json']({'success':![],'message':_0x57b9ae(0x17f)+_0xe36a59[_0x57b9ae(0x141)]+',\x20cannot\x20process'});const _0x53211d=await this[_0x57b9ae(0x155)][_0x57b9ae(0x140)]({'paymentId':_0xe36a59['id'],'orderId':_0xe36a59[_0x57b9ae(0x18b)]||_0xe36a59['id'],'amount':_0xe36a59[_0x57b9ae(0x17b)],'currency':_0xe36a59[_0x57b9ae(0x162)],'cardData':_0x1b9b70});console[_0x57b9ae(0x19a)](_0x57b9ae(0x12b),_0x53211d);const _0x56064f={'status':_0x53211d[_0x57b9ae(0x141)],'updatedAt':new Date()};if(_0x53211d[_0x57b9ae(0x141)]===_0x57b9ae(0x138))_0x56064f[_0x57b9ae(0x161)]=new Date(),_0x56064f[_0x57b9ae(0x160)]=_0x53211d['transactionId'];else _0x53211d[_0x57b9ae(0x141)]===_0x57b9ae(0x17e)&&(_0x56064f[_0x57b9ae(0x163)]=_0x53211d[_0x57b9ae(0x195)]);const _0x360941=_0x1b9b70[_0x57b9ae(0x182)][_0x57b9ae(0x19e)](/[\s-]/g,'');_0x56064f['cardLast4']=_0x360941[_0x57b9ae(0x16d)](-0x4),_0x56064f['paymentMethod']='test_card',await database_1[_0x57b9ae(0x130)]['payment'][_0x57b9ae(0x19d)]({'where':{'id':_0xe36a59['id']},'data':_0x56064f});if(_0x53211d[_0x57b9ae(0x141)]===_0x57b9ae(0x138)&&_0xe36a59[_0x57b9ae(0x171)]){console['log'](_0x57b9ae(0x170)+_0xe36a59['id']+_0x57b9ae(0x16b));try{await database_1[_0x57b9ae(0x130)][_0x57b9ae(0x154)](async _0x55d31b=>{const _0x2b9362=_0x57b9ae,_0x5725a2=await _0x55d31b[_0x2b9362(0x128)][_0x2b9362(0x199)]({'where':{'id':_0xe36a59['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5725a2){console['log'](_0x2b9362(0x151)+_0x5725a2['id']+_0x2b9362(0x126)+_0x5725a2[_0x2b9362(0x189)]+_0x2b9362(0x127)+_0x5725a2[_0x2b9362(0x143)]+_0x2b9362(0x157)+_0x5725a2[_0x2b9362(0x141)]);const _0x71bd96=_0x5725a2[_0x2b9362(0x143)]+0x1,_0x1b8498=_0x5725a2[_0x2b9362(0x189)]==='SINGLE'?_0x2b9362(0x16c):_0x5725a2[_0x2b9362(0x141)];await _0x55d31b[_0x2b9362(0x128)][_0x2b9362(0x19d)]({'where':{'id':_0xe36a59[_0x2b9362(0x171)]},'data':{'currentPayments':_0x71bd96,'status':_0x1b8498,'updatedAt':new Date()}}),console[_0x2b9362(0x19a)](_0x2b9362(0x142)+_0x5725a2['id']+'\x20updated:\x20currentPayments='+_0x5725a2[_0x2b9362(0x143)]+_0x2b9362(0x198)+_0x71bd96+_0x2b9362(0x157)+_0x5725a2[_0x2b9362(0x141)]+_0x2b9362(0x198)+_0x1b8498);}else console[_0x2b9362(0x19a)](_0x2b9362(0x133)+_0xe36a59[_0x2b9362(0x171)]+_0x2b9362(0x190));});}catch(_0x31dfd5){console['error'](_0x57b9ae(0x18d),_0x31dfd5);}}await database_1[_0x57b9ae(0x130)][_0x57b9ae(0x197)]['create']({'data':{'paymentId':_0xe36a59['id'],'shopId':_0xe36a59[_0x57b9ae(0x147)],'event':_0x57b9ae(0x131)+_0x53211d[_0x57b9ae(0x141)][_0x57b9ae(0x186)](),'statusCode':0xc8,'responseBody':JSON[_0x57b9ae(0x13d)]({'oldStatus':_0x57b9ae(0x175),'newStatus':_0x53211d[_0x57b9ae(0x141)],'transactionId':_0x53211d[_0x57b9ae(0x137)],'failureReason':_0x53211d[_0x57b9ae(0x195)],'processedAt':new Date()[_0x57b9ae(0x146)]()})}}),await this['sendShopWebhook'](_0xe36a59,_0x53211d['status'],_0x53211d[_0x57b9ae(0x137)],_0x53211d[_0x57b9ae(0x195)]),await this[_0x57b9ae(0x15e)](_0xe36a59,_0x53211d[_0x57b9ae(0x141)]),console[_0x57b9ae(0x19a)](_0x57b9ae(0x185)+_0x3d15a9+_0x57b9ae(0x145)+_0x53211d[_0x57b9ae(0x141)]),_0x53211d['status']===_0x57b9ae(0x138)?_0x3be4ca[_0x57b9ae(0x18e)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x57b9ae(0x138),'transactionId':_0x53211d[_0x57b9ae(0x137)],'redirectUrl':_0xe36a59[_0x57b9ae(0x125)]}}):_0x3be4ca[_0x57b9ae(0x141)](0x190)['json']({'success':![],'message':_0x57b9ae(0x15c),'result':{'status':_0x57b9ae(0x17e),'failureReason':_0x53211d[_0x57b9ae(0x195)],'redirectUrl':_0xe36a59[_0x57b9ae(0x17c)]}});}catch(_0x4782b2){_0x6cafb7(_0x4782b2);}},this[_0x2e2246(0x155)]=new testGatewayService_1[(_0x2e2246(0x156))](),this[_0x2e2246(0x187)]=new webhookService_1['WebhookService']();}async[a13_0x4c6a47(0x15d)](_0x56401f,_0x15850a,_0x2d9be1,_0x20a2e3){const _0x1fb8b3=a13_0x4c6a47,_0x3d2e30=Date[_0x1fb8b3(0x13f)]();try{const _0x6e17ea=_0x56401f['shop'],_0x1579a2=_0x6e17ea[_0x1fb8b3(0x144)];if(!_0x1579a2?.[_0x1fb8b3(0x168)]){console[_0x1fb8b3(0x19a)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x6e17ea['id']);return;}const _0x27ace0=_0x15850a===_0x1fb8b3(0x138)?'payment.success':'payment.failed';let _0x2e9f9c=[];if(_0x1579a2[_0x1fb8b3(0x14b)])try{_0x2e9f9c=Array[_0x1fb8b3(0x19b)](_0x1579a2[_0x1fb8b3(0x14b)])?_0x1579a2[_0x1fb8b3(0x14b)]:JSON[_0x1fb8b3(0x165)](_0x1579a2[_0x1fb8b3(0x14b)]);}catch(_0x20a448){console[_0x1fb8b3(0x18a)](_0x1fb8b3(0x17a),_0x20a448),_0x2e9f9c=[];}if(!_0x2e9f9c[_0x1fb8b3(0x164)](_0x27ace0)){console[_0x1fb8b3(0x19a)]('Webhook\x20event\x20'+_0x27ace0+'\x20not\x20enabled\x20for\x20shop\x20'+_0x6e17ea['id']);return;}const _0x49328d={'event':_0x27ace0,'payment':{'id':_0x56401f['id'],'order_id':_0x56401f[_0x1fb8b3(0x172)],'gateway_order_id':_0x56401f[_0x1fb8b3(0x18b)],'gateway':_0x1fb8b3(0x150),'amount':_0x56401f[_0x1fb8b3(0x17b)],'currency':_0x56401f['currency'],'status':_0x15850a[_0x1fb8b3(0x186)](),'customer_email':_0x56401f[_0x1fb8b3(0x16a)],'customer_name':_0x56401f['customerName'],'transaction_id':_0x2d9be1,'failure_message':_0x20a2e3,'created_at':_0x56401f[_0x1fb8b3(0x194)],'updated_at':new Date()}},_0x2001a5=await fetch(_0x1579a2[_0x1fb8b3(0x168)],{'method':_0x1fb8b3(0x176),'headers':{'Content-Type':_0x1fb8b3(0x180),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x1fb8b3(0x13d)](_0x49328d)}),_0x3fdd40=Date['now']()-_0x3d2e30;console['log'](_0x1fb8b3(0x181)+_0x1579a2[_0x1fb8b3(0x168)]+_0x1fb8b3(0x135)+_0x2001a5['status']+'\x20('+_0x3fdd40+'ms)');}catch(_0x399048){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x399048);}}async[a13_0x4c6a47(0x15e)](_0x66013a,_0x441a04){const _0x588609=a13_0x4c6a47;try{const {telegramBotService:_0x41de9d}=await Promise[_0x588609(0x132)]()[_0x588609(0x139)](()=>__importStar(require('../services/telegramBotService'))),_0x334913={'PAID':_0x588609(0x193),'FAILED':_0x588609(0x16f)},_0x13f544=_0x334913[_0x441a04];if(!_0x13f544)return;await _0x41de9d[_0x588609(0x192)](_0x66013a[_0x588609(0x147)],_0x66013a,_0x13f544);}catch(_0xf0d149){console[_0x588609(0x18a)](_0x588609(0x183),_0xf0d149);}}}exports[a13_0x4c6a47(0x153)]=TestGatewayController;