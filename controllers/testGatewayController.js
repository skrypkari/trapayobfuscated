'use strict';const a13_0x11f911=a13_0x8b4f;(function(_0x53d01c,_0x36e7b1){const _0x4aee31=a13_0x8b4f,_0x48d194=_0x53d01c();while(!![]){try{const _0x3e8fa2=-parseInt(_0x4aee31(0x1a7))/0x1*(parseInt(_0x4aee31(0x18c))/0x2)+-parseInt(_0x4aee31(0x1fc))/0x3+parseInt(_0x4aee31(0x1a9))/0x4*(-parseInt(_0x4aee31(0x1df))/0x5)+parseInt(_0x4aee31(0x1f6))/0x6+parseInt(_0x4aee31(0x1e2))/0x7+parseInt(_0x4aee31(0x1d3))/0x8*(parseInt(_0x4aee31(0x1dc))/0x9)+parseInt(_0x4aee31(0x19b))/0xa*(parseInt(_0x4aee31(0x1ce))/0xb);if(_0x3e8fa2===_0x36e7b1)break;else _0x48d194['push'](_0x48d194['shift']());}catch(_0x4d0866){_0x48d194['push'](_0x48d194['shift']());}}}(a13_0x2c3c,0x7ee8a));function a13_0x8b4f(_0x5101af,_0xc5a213){const _0x2c3c06=a13_0x2c3c();return a13_0x8b4f=function(_0x8b4f25,_0x10a753){_0x8b4f25=_0x8b4f25-0x188;let _0xa0a98f=_0x2c3c06[_0x8b4f25];return _0xa0a98f;},a13_0x8b4f(_0x5101af,_0xc5a213);}var __createBinding=this&&this['__createBinding']||(Object[a13_0x11f911(0x1ea)]?function(_0x42ee02,_0xc0dcc9,_0x31583c,_0x1f33ab){const _0x2485c2=a13_0x11f911;if(_0x1f33ab===undefined)_0x1f33ab=_0x31583c;var _0xbfb4c7=Object[_0x2485c2(0x1db)](_0xc0dcc9,_0x31583c);(!_0xbfb4c7||('get'in _0xbfb4c7?!_0xc0dcc9['__esModule']:_0xbfb4c7[_0x2485c2(0x1f1)]||_0xbfb4c7[_0x2485c2(0x1f5)]))&&(_0xbfb4c7={'enumerable':!![],'get':function(){return _0xc0dcc9[_0x31583c];}}),Object['defineProperty'](_0x42ee02,_0x1f33ab,_0xbfb4c7);}:function(_0x257a7e,_0x4e2c11,_0xf3ff8e,_0x217dfa){if(_0x217dfa===undefined)_0x217dfa=_0xf3ff8e;_0x257a7e[_0x217dfa]=_0x4e2c11[_0xf3ff8e];}),__setModuleDefault=this&&this[a13_0x11f911(0x196)]||(Object[a13_0x11f911(0x1ea)]?function(_0x3716c0,_0x29606d){const _0x51ba82=a13_0x11f911;Object[_0x51ba82(0x195)](_0x3716c0,_0x51ba82(0x1d7),{'enumerable':!![],'value':_0x29606d});}:function(_0x2c0d7f,_0x184962){const _0x775913=a13_0x11f911;_0x2c0d7f[_0x775913(0x1d7)]=_0x184962;}),__importStar=this&&this[a13_0x11f911(0x1d5)]||(function(){var _0x47b9d2=function(_0x178b1e){return _0x47b9d2=Object['getOwnPropertyNames']||function(_0x5a0455){const _0xd00a06=a13_0x8b4f;var _0x4a94a1=[];for(var _0x3d9324 in _0x5a0455)if(Object[_0xd00a06(0x1b7)]['hasOwnProperty'][_0xd00a06(0x1b4)](_0x5a0455,_0x3d9324))_0x4a94a1[_0x4a94a1[_0xd00a06(0x1a2)]]=_0x3d9324;return _0x4a94a1;},_0x47b9d2(_0x178b1e);};return function(_0x1c70e4){const _0x1a58b9=a13_0x8b4f;if(_0x1c70e4&&_0x1c70e4['__esModule'])return _0x1c70e4;var _0x3cee3f={};if(_0x1c70e4!=null){for(var _0x56d6fa=_0x47b9d2(_0x1c70e4),_0x5e808b=0x0;_0x5e808b<_0x56d6fa[_0x1a58b9(0x1a2)];_0x5e808b++)if(_0x56d6fa[_0x5e808b]!==_0x1a58b9(0x1d7))__createBinding(_0x3cee3f,_0x1c70e4,_0x56d6fa[_0x5e808b]);}return __setModuleDefault(_0x3cee3f,_0x1c70e4),_0x3cee3f;};}()),__importDefault=this&&this['__importDefault']||function(_0x3244ac){const _0xc21685=a13_0x11f911;return _0x3244ac&&_0x3244ac[_0xc21685(0x197)]?_0x3244ac:{'default':_0x3244ac};};Object['defineProperty'](exports,a13_0x11f911(0x197),{'value':!![]}),exports[a13_0x11f911(0x194)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x11f911(0x1bf)),database_1=__importDefault(require(a13_0x11f911(0x19c)));function a13_0x2c3c(){const _0x2aa118=['620916WLTGis','toISOString','includes','../services/telegramBotService','COMPLETED','processCardPayment','1800840SGQetm','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gateway','json','Test\x20Gateway\x20webhook\x20sent\x20to\x20','gatewayOrderId','292214teOjxu','error','webhookUrl','\x20not\x20enabled\x20for\x20shop\x20','📈\x20Test\x20Gateway:\x20Payment\x20','slice','test_card','shopId','TestGatewayController','defineProperty','__setModuleDefault','__esModule','successUrl','test_gateway_','4242\x204242\x204242\x204242','160DljAIy','../config/database','Payment\x20not\x20found','failed','\x20not\x20found','paymentMethod','failureReason','length','PAID','status','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','0000','7YfYocI','resolve','226396EDzZCs','shop','getPaymentForm','webhookEvents','update','type',',\x20cannot\x20process','transactionId','✅\x20Payment\x20link\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','name','call','Payment\x20failed','test_gateway','prototype','✅\x20Test\x20Gateway\x20payment\x20','\x20->\x20','paymentLinkId','testGatewayService',',\x20currentPayments=','Payment\x20processed\x20successfully','toLowerCase','../services/webhookService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','SINGLE','TestGatewayService','body','sendPaymentNotification','application/json','POST','processCard','cardLast4','PENDING','WebhookService',':\x20type=','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','❌\x20Payment\x20link\x20','999548sjQwWN','sendPaymentStatusNotification','paymentLink','$transaction','findUnique','16IGAdXB','payment','__importStar','\x20processed:\x20','default','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','amount','customerEmail','getOwnPropertyDescriptor','3072051jJhJGb','Payment\x20is\x20not\x20for\x20test\x20gateway','gatewayPaymentId','70KHSCMx','orderId','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','4866267sAYGnH','sendShopWebhook','log','ms)','Any\x203-4\x20digits','Any\x20name','webhookLog','webhookService','create','📈\x20Found\x20payment\x20link\x20','FAILED','currentPayments','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','stringify','currency','writable','Error\x20parsing\x20webhook\x20events:','Payment\x20status\x20is\x20','params','configurable'];a13_0x2c3c=function(){return _0x2aa118;};return a13_0x2c3c();}class TestGatewayController{constructor(){const _0x24a326=a13_0x11f911;this[_0x24a326(0x1ab)]=async(_0x9d31f1,_0x22280c,_0x596ace)=>{const _0x248055=_0x24a326;try{const {paymentId:_0x36c153}=_0x9d31f1['params'];console[_0x248055(0x1e4)](_0x248055(0x1a5)+_0x36c153);const _0x108090=await database_1[_0x248055(0x1d7)]['payment'][_0x248055(0x1d2)]({'where':{'id':_0x36c153},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x108090)return _0x22280c[_0x248055(0x1a4)](0x194)[_0x248055(0x189)]({'success':![],'message':_0x248055(0x19d)});if(_0x108090[_0x248055(0x188)]!==_0x248055(0x1b6))return _0x22280c[_0x248055(0x1a4)](0x190)[_0x248055(0x189)]({'success':![],'message':_0x248055(0x1dd)});if(_0x108090['status']!==_0x248055(0x1c9))return _0x22280c[_0x248055(0x1a4)](0x190)[_0x248055(0x189)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x108090[_0x248055(0x1a4)]+',\x20cannot\x20process'});_0x22280c[_0x248055(0x189)]({'success':!![],'result':{'paymentId':_0x108090['id'],'orderId':_0x108090[_0x248055(0x18b)],'amount':_0x108090[_0x248055(0x1d9)],'currency':_0x108090[_0x248055(0x1f0)],'merchantName':_0x108090[_0x248055(0x1aa)][_0x248055(0x1b3)],'description':'Payment\x20to\x20'+_0x108090[_0x248055(0x1aa)]['name'],'testInstructions':{'successCard':_0x248055(0x19a),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x248055(0x1e6),'holderName':_0x248055(0x1e7)}}});}catch(_0xbfd6b3){_0x596ace(_0xbfd6b3);}},this[_0x24a326(0x1c7)]=async(_0x2bf1be,_0x14e431,_0x5c865e)=>{const _0x4a847f=_0x24a326;try{const {paymentId:_0x3ef770}=_0x2bf1be[_0x4a847f(0x1f4)],_0xcfebf6=_0x2bf1be[_0x4a847f(0x1c3)];console[_0x4a847f(0x1e4)](_0x4a847f(0x1ee)+_0x3ef770);const _0x216bf3=await database_1[_0x4a847f(0x1d7)][_0x4a847f(0x1d4)][_0x4a847f(0x1d2)]({'where':{'id':_0x3ef770},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x216bf3)return _0x14e431[_0x4a847f(0x1a4)](0x194)['json']({'success':![],'message':_0x4a847f(0x19d)});if(_0x216bf3[_0x4a847f(0x188)]!==_0x4a847f(0x1b6))return _0x14e431[_0x4a847f(0x1a4)](0x190)['json']({'success':![],'message':_0x4a847f(0x1dd)});if(_0x216bf3['status']!==_0x4a847f(0x1c9))return _0x14e431['status'](0x190)['json']({'success':![],'message':_0x4a847f(0x1f3)+_0x216bf3[_0x4a847f(0x1a4)]+_0x4a847f(0x1af)});const _0x2d189d=await this[_0x4a847f(0x1bb)][_0x4a847f(0x1fb)]({'paymentId':_0x216bf3['id'],'orderId':_0x216bf3[_0x4a847f(0x18b)]||_0x216bf3['id'],'amount':_0x216bf3['amount'],'currency':_0x216bf3['currency'],'cardData':_0xcfebf6});console[_0x4a847f(0x1e4)]('🧪\x20Test\x20Gateway\x20result:',_0x2d189d);const _0x5c600e={'status':_0x2d189d[_0x4a847f(0x1a4)],'updatedAt':new Date()};if(_0x2d189d[_0x4a847f(0x1a4)]===_0x4a847f(0x1a3))_0x5c600e['paidAt']=new Date(),_0x5c600e[_0x4a847f(0x1de)]=_0x2d189d[_0x4a847f(0x1b0)];else _0x2d189d[_0x4a847f(0x1a4)]===_0x4a847f(0x1ec)&&(_0x5c600e['failureMessage']=_0x2d189d[_0x4a847f(0x1a1)]);const _0xc84b0b=_0xcfebf6['cardNumber']['replace'](/[\s-]/g,'');_0x5c600e[_0x4a847f(0x1c8)]=_0xc84b0b[_0x4a847f(0x191)](-0x4),_0x5c600e[_0x4a847f(0x1a0)]=_0x4a847f(0x192),await database_1[_0x4a847f(0x1d7)][_0x4a847f(0x1d4)][_0x4a847f(0x1ad)]({'where':{'id':_0x216bf3['id']},'data':_0x5c600e});if(_0x2d189d['status']==='PAID'&&_0x216bf3['paymentLinkId']){console[_0x4a847f(0x1e4)](_0x4a847f(0x190)+_0x216bf3['id']+_0x4a847f(0x1c0));try{await database_1[_0x4a847f(0x1d7)][_0x4a847f(0x1d1)](async _0x306c53=>{const _0x58f11a=_0x4a847f,_0x254d4f=await _0x306c53[_0x58f11a(0x1d0)][_0x58f11a(0x1d2)]({'where':{'id':_0x216bf3[_0x58f11a(0x1ba)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x254d4f){console['log'](_0x58f11a(0x1eb)+_0x254d4f['id']+_0x58f11a(0x1cb)+_0x254d4f[_0x58f11a(0x1ae)]+_0x58f11a(0x1bc)+_0x254d4f['currentPayments']+',\x20status='+_0x254d4f[_0x58f11a(0x1a4)]);const _0x15b7b0=_0x254d4f['currentPayments']+0x1,_0x3ff37a=_0x254d4f[_0x58f11a(0x1ae)]===_0x58f11a(0x1c1)?_0x58f11a(0x1fa):_0x254d4f[_0x58f11a(0x1a4)];await _0x306c53['paymentLink']['update']({'where':{'id':_0x216bf3[_0x58f11a(0x1ba)]},'data':{'currentPayments':_0x15b7b0,'status':_0x3ff37a,'updatedAt':new Date()}}),console[_0x58f11a(0x1e4)](_0x58f11a(0x1b1)+_0x254d4f['id']+'\x20updated:\x20currentPayments='+_0x254d4f[_0x58f11a(0x1ed)]+_0x58f11a(0x1b9)+_0x15b7b0+',\x20status='+_0x254d4f[_0x58f11a(0x1a4)]+_0x58f11a(0x1b9)+_0x3ff37a);}else console['log'](_0x58f11a(0x1cd)+_0x216bf3[_0x58f11a(0x1ba)]+_0x58f11a(0x19f));});}catch(_0x3473c0){console[_0x4a847f(0x18d)](_0x4a847f(0x1e1),_0x3473c0);}}await database_1[_0x4a847f(0x1d7)][_0x4a847f(0x1e8)][_0x4a847f(0x1ea)]({'data':{'paymentId':_0x216bf3['id'],'shopId':_0x216bf3['shopId'],'event':_0x4a847f(0x199)+_0x2d189d[_0x4a847f(0x1a4)][_0x4a847f(0x1be)](),'statusCode':0xc8,'responseBody':JSON[_0x4a847f(0x1ef)]({'oldStatus':_0x4a847f(0x1c9),'newStatus':_0x2d189d[_0x4a847f(0x1a4)],'transactionId':_0x2d189d[_0x4a847f(0x1b0)],'failureReason':_0x2d189d[_0x4a847f(0x1a1)],'processedAt':new Date()[_0x4a847f(0x1f7)]()})}}),await this[_0x4a847f(0x1e3)](_0x216bf3,_0x2d189d[_0x4a847f(0x1a4)],_0x2d189d[_0x4a847f(0x1b0)],_0x2d189d[_0x4a847f(0x1a1)]),await this[_0x4a847f(0x1cf)](_0x216bf3,_0x2d189d['status']),console[_0x4a847f(0x1e4)](_0x4a847f(0x1b8)+_0x3ef770+_0x4a847f(0x1d6)+_0x2d189d[_0x4a847f(0x1a4)]),_0x2d189d[_0x4a847f(0x1a4)]===_0x4a847f(0x1a3)?_0x14e431['json']({'success':!![],'message':_0x4a847f(0x1bd),'result':{'status':_0x4a847f(0x1a3),'transactionId':_0x2d189d['transactionId'],'redirectUrl':_0x216bf3[_0x4a847f(0x198)]}}):_0x14e431['status'](0x190)['json']({'success':![],'message':_0x4a847f(0x1b5),'result':{'status':_0x4a847f(0x1ec),'failureReason':_0x2d189d[_0x4a847f(0x1a1)],'redirectUrl':_0x216bf3['failUrl']}});}catch(_0x11c9c3){_0x5c865e(_0x11c9c3);}},this[_0x24a326(0x1bb)]=new testGatewayService_1[(_0x24a326(0x1c2))](),this[_0x24a326(0x1e9)]=new webhookService_1[(_0x24a326(0x1ca))]();}async[a13_0x11f911(0x1e3)](_0x3db480,_0x2432f3,_0x2d5793,_0x44435d){const _0x1ad56e=a13_0x11f911,_0x4d87ba=Date['now']();try{const _0xb42005=_0x3db480[_0x1ad56e(0x1aa)],_0xa60146=_0xb42005['settings'];if(!_0xa60146?.[_0x1ad56e(0x18e)]){console['log'](_0x1ad56e(0x1fd)+_0xb42005['id']);return;}const _0x451b3a=_0x2432f3===_0x1ad56e(0x1a3)?'payment.success':'payment.failed';let _0x43b114=[];if(_0xa60146[_0x1ad56e(0x1ac)])try{_0x43b114=Array['isArray'](_0xa60146['webhookEvents'])?_0xa60146[_0x1ad56e(0x1ac)]:JSON['parse'](_0xa60146['webhookEvents']);}catch(_0x4bdc2e){console[_0x1ad56e(0x18d)](_0x1ad56e(0x1f2),_0x4bdc2e),_0x43b114=[];}if(!_0x43b114[_0x1ad56e(0x1f8)](_0x451b3a)){console[_0x1ad56e(0x1e4)]('Webhook\x20event\x20'+_0x451b3a+_0x1ad56e(0x18f)+_0xb42005['id']);return;}const _0x4bac2c={'event':_0x451b3a,'payment':{'id':_0x3db480['id'],'order_id':_0x3db480[_0x1ad56e(0x1e0)],'gateway_order_id':_0x3db480[_0x1ad56e(0x18b)],'gateway':_0x1ad56e(0x1a6),'amount':_0x3db480[_0x1ad56e(0x1d9)],'currency':_0x3db480['currency'],'status':_0x2432f3[_0x1ad56e(0x1be)](),'customer_email':_0x3db480[_0x1ad56e(0x1da)],'customer_name':_0x3db480['customerName'],'transaction_id':_0x2d5793,'failure_message':_0x44435d,'created_at':_0x3db480['createdAt'],'updated_at':new Date()}},_0x4f50fb=await fetch(_0xa60146[_0x1ad56e(0x18e)],{'method':_0x1ad56e(0x1c6),'headers':{'Content-Type':_0x1ad56e(0x1c5),'User-Agent':_0x1ad56e(0x1d8)},'body':JSON[_0x1ad56e(0x1ef)](_0x4bac2c)}),_0x2d70e0=Date['now']()-_0x4d87ba;console[_0x1ad56e(0x1e4)](_0x1ad56e(0x18a)+_0xa60146[_0x1ad56e(0x18e)]+'\x20with\x20status\x20'+_0x4f50fb[_0x1ad56e(0x1a4)]+'\x20('+_0x2d70e0+_0x1ad56e(0x1e5));}catch(_0x4451fe){console[_0x1ad56e(0x18d)](_0x1ad56e(0x1b2),_0x4451fe);}}async['sendPaymentStatusNotification'](_0x4a15ff,_0x255900){const _0x58ba55=a13_0x11f911;try{const {telegramBotService:_0x452de6}=await Promise[_0x58ba55(0x1a8)]()['then'](()=>__importStar(require(_0x58ba55(0x1f9)))),_0x1fc789={'PAID':'paid','FAILED':_0x58ba55(0x19e)},_0x1afbb4=_0x1fc789[_0x255900];if(!_0x1afbb4)return;await _0x452de6[_0x58ba55(0x1c4)](_0x4a15ff[_0x58ba55(0x193)],_0x4a15ff,_0x1afbb4);}catch(_0x2c76e9){console['error'](_0x58ba55(0x1cc),_0x2c76e9);}}}exports[a13_0x11f911(0x194)]=TestGatewayController;