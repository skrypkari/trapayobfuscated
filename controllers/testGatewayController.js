'use strict';const a13_0x2d9043=a13_0x5b58;(function(_0x27a341,_0x3d57cf){const _0x2dccb7=a13_0x5b58,_0x38e5b1=_0x27a341();while(!![]){try{const _0x4662ca=-parseInt(_0x2dccb7(0xf7))/0x1+-parseInt(_0x2dccb7(0x110))/0x2*(parseInt(_0x2dccb7(0xfe))/0x3)+-parseInt(_0x2dccb7(0x117))/0x4+-parseInt(_0x2dccb7(0xf1))/0x5+parseInt(_0x2dccb7(0x147))/0x6+-parseInt(_0x2dccb7(0x159))/0x7*(parseInt(_0x2dccb7(0x108))/0x8)+parseInt(_0x2dccb7(0x145))/0x9;if(_0x4662ca===_0x3d57cf)break;else _0x38e5b1['push'](_0x38e5b1['shift']());}catch(_0x1338b4){_0x38e5b1['push'](_0x38e5b1['shift']());}}}(a13_0x2a73,0x7d724));var __createBinding=this&&this[a13_0x2d9043(0x113)]||(Object[a13_0x2d9043(0x116)]?function(_0x1e463d,_0xc2448,_0x19d503,_0x49c7b7){const _0x1a7af7=a13_0x2d9043;if(_0x49c7b7===undefined)_0x49c7b7=_0x19d503;var _0x110dcc=Object[_0x1a7af7(0x12f)](_0xc2448,_0x19d503);(!_0x110dcc||(_0x1a7af7(0xf4)in _0x110dcc?!_0xc2448[_0x1a7af7(0x13e)]:_0x110dcc['writable']||_0x110dcc['configurable']))&&(_0x110dcc={'enumerable':!![],'get':function(){return _0xc2448[_0x19d503];}}),Object[_0x1a7af7(0x141)](_0x1e463d,_0x49c7b7,_0x110dcc);}:function(_0x1dd051,_0x487d68,_0x424e3a,_0x51bc72){if(_0x51bc72===undefined)_0x51bc72=_0x424e3a;_0x1dd051[_0x51bc72]=_0x487d68[_0x424e3a];}),__setModuleDefault=this&&this[a13_0x2d9043(0x138)]||(Object['create']?function(_0xbf2bbf,_0x523e2b){const _0x5a04e7=a13_0x2d9043;Object[_0x5a04e7(0x141)](_0xbf2bbf,'default',{'enumerable':!![],'value':_0x523e2b});}:function(_0x1bbaa2,_0x5709ff){const _0x108684=a13_0x2d9043;_0x1bbaa2[_0x108684(0x11e)]=_0x5709ff;}),__importStar=this&&this['__importStar']||(function(){var _0x19f41c=function(_0x379dcd){const _0x4cf280=a13_0x5b58;return _0x19f41c=Object[_0x4cf280(0x14a)]||function(_0x16b0a3){const _0x1198a0=_0x4cf280;var _0x28807c=[];for(var _0x4394f4 in _0x16b0a3)if(Object[_0x1198a0(0x104)][_0x1198a0(0x140)]['call'](_0x16b0a3,_0x4394f4))_0x28807c[_0x28807c[_0x1198a0(0x150)]]=_0x4394f4;return _0x28807c;},_0x19f41c(_0x379dcd);};return function(_0x256df6){const _0x3020b4=a13_0x5b58;if(_0x256df6&&_0x256df6[_0x3020b4(0x13e)])return _0x256df6;var _0x3ab695={};if(_0x256df6!=null){for(var _0x3e2be7=_0x19f41c(_0x256df6),_0x80c8f9=0x0;_0x80c8f9<_0x3e2be7['length'];_0x80c8f9++)if(_0x3e2be7[_0x80c8f9]!=='default')__createBinding(_0x3ab695,_0x256df6,_0x3e2be7[_0x80c8f9]);}return __setModuleDefault(_0x3ab695,_0x256df6),_0x3ab695;};}()),__importDefault=this&&this[a13_0x2d9043(0x146)]||function(_0x462276){const _0x3dbdc7=a13_0x2d9043;return _0x462276&&_0x462276[_0x3dbdc7(0x13e)]?_0x462276:{'default':_0x462276};};function a13_0x5b58(_0x3edb05,_0x34522f){const _0x2a73b6=a13_0x2a73();return a13_0x5b58=function(_0x5b58b4,_0x16eabd){_0x5b58b4=_0x5b58b4-0xef;let _0x13858e=_0x2a73b6[_0x5b58b4];return _0x13858e;},a13_0x5b58(_0x3edb05,_0x34522f);}Object[a13_0x2d9043(0x141)](exports,a13_0x2d9043(0x13e),{'value':!![]}),exports[a13_0x2d9043(0x154)]=void 0x0;const testGatewayService_1=require(a13_0x2d9043(0x158)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x15fc15=a13_0x2d9043;this[_0x15fc15(0x11c)]=async(_0x46a8b1,_0xd5897a,_0x5280c2)=>{const _0x21f3f7=_0x15fc15;try{const {paymentId:_0xa887f0}=_0x46a8b1[_0x21f3f7(0x11b)];console[_0x21f3f7(0x127)](_0x21f3f7(0x118)+_0xa887f0);const _0x3ce817=await database_1[_0x21f3f7(0x11e)][_0x21f3f7(0x13f)][_0x21f3f7(0x153)]({'where':{'id':_0xa887f0},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3ce817)return _0xd5897a[_0x21f3f7(0xf9)](0x194)[_0x21f3f7(0x106)]({'success':![],'message':_0x21f3f7(0x130)});if(_0x3ce817[_0x21f3f7(0x131)]!==_0x21f3f7(0x111))return _0xd5897a['status'](0x190)['json']({'success':![],'message':_0x21f3f7(0x10e)});if(_0x3ce817[_0x21f3f7(0xf9)]!=='PENDING')return _0xd5897a['status'](0x190)[_0x21f3f7(0x106)]({'success':![],'message':_0x21f3f7(0x121)+_0x3ce817[_0x21f3f7(0xf9)]+_0x21f3f7(0x123)});_0xd5897a[_0x21f3f7(0x106)]({'success':!![],'result':{'paymentId':_0x3ce817['id'],'orderId':_0x3ce817['gatewayOrderId'],'amount':_0x3ce817['amount'],'currency':_0x3ce817[_0x21f3f7(0x13a)],'merchantName':_0x3ce817[_0x21f3f7(0xef)][_0x21f3f7(0x14e)],'description':_0x21f3f7(0x143)+_0x3ce817[_0x21f3f7(0xef)][_0x21f3f7(0x14e)],'testInstructions':{'successCard':_0x21f3f7(0x136),'failureCard':_0x21f3f7(0x139),'expiryDate':_0x21f3f7(0x129),'cvc':_0x21f3f7(0x102),'holderName':_0x21f3f7(0x10c)}}});}catch(_0x11a5dd){_0x5280c2(_0x11a5dd);}},this[_0x15fc15(0xf2)]=async(_0xd0f3ce,_0x5ce48b,_0x5aec80)=>{const _0xe7ee73=_0x15fc15;try{const {paymentId:_0x7bbd48}=_0xd0f3ce[_0xe7ee73(0x11b)],_0x40b72f=_0xd0f3ce[_0xe7ee73(0xfc)];console[_0xe7ee73(0x127)](_0xe7ee73(0x105)+_0x7bbd48);const _0x4c867a=await database_1[_0xe7ee73(0x11e)][_0xe7ee73(0x13f)][_0xe7ee73(0x153)]({'where':{'id':_0x7bbd48},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4c867a)return _0x5ce48b['status'](0x194)[_0xe7ee73(0x106)]({'success':![],'message':_0xe7ee73(0x130)});if(_0x4c867a[_0xe7ee73(0x131)]!==_0xe7ee73(0x111))return _0x5ce48b[_0xe7ee73(0xf9)](0x190)[_0xe7ee73(0x106)]({'success':![],'message':_0xe7ee73(0x10e)});if(_0x4c867a[_0xe7ee73(0xf9)]!==_0xe7ee73(0x122))return _0x5ce48b[_0xe7ee73(0xf9)](0x190)[_0xe7ee73(0x106)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4c867a[_0xe7ee73(0xf9)]+_0xe7ee73(0x123)});const _0x1ea44d=await this[_0xe7ee73(0x120)]['processCardPayment']({'paymentId':_0x4c867a['id'],'orderId':_0x4c867a['gatewayOrderId']||_0x4c867a['id'],'amount':_0x4c867a['amount'],'currency':_0x4c867a['currency'],'cardData':_0x40b72f});console[_0xe7ee73(0x127)](_0xe7ee73(0x119),_0x1ea44d);const _0x54c289={'status':_0x1ea44d[_0xe7ee73(0xf9)],'updatedAt':new Date()};if(_0x1ea44d[_0xe7ee73(0xf9)]==='PAID')_0x54c289[_0xe7ee73(0x126)]=new Date(),_0x54c289[_0xe7ee73(0x112)]=_0x1ea44d[_0xe7ee73(0x12d)];else _0x1ea44d[_0xe7ee73(0xf9)]==='FAILED'&&(_0x54c289[_0xe7ee73(0xf3)]=_0x1ea44d[_0xe7ee73(0xff)]);const _0x3ccbf9=_0x40b72f[_0xe7ee73(0x103)]['replace'](/[\s-]/g,'');_0x54c289[_0xe7ee73(0xf6)]=_0x3ccbf9['slice'](-0x4),_0x54c289['paymentMethod']=_0xe7ee73(0xf0),await database_1[_0xe7ee73(0x11e)]['payment'][_0xe7ee73(0x124)]({'where':{'id':_0x4c867a['id']},'data':_0x54c289}),await database_1[_0xe7ee73(0x11e)][_0xe7ee73(0x12c)]['create']({'data':{'paymentId':_0x4c867a['id'],'shopId':_0x4c867a[_0xe7ee73(0x157)],'event':_0xe7ee73(0xf8)+_0x1ea44d[_0xe7ee73(0xf9)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0xe7ee73(0x152)]({'oldStatus':'PENDING','newStatus':_0x1ea44d[_0xe7ee73(0xf9)],'transactionId':_0x1ea44d['transactionId'],'failureReason':_0x1ea44d[_0xe7ee73(0xff)],'processedAt':new Date()[_0xe7ee73(0x10b)]()})}}),await this['sendShopWebhook'](_0x4c867a,_0x1ea44d[_0xe7ee73(0xf9)],_0x1ea44d[_0xe7ee73(0x12d)],_0x1ea44d[_0xe7ee73(0xff)]),await this[_0xe7ee73(0xfa)](_0x4c867a,_0x1ea44d[_0xe7ee73(0xf9)]),console[_0xe7ee73(0x127)](_0xe7ee73(0x13d)+_0x7bbd48+_0xe7ee73(0x15a)+_0x1ea44d['status']),_0x1ea44d['status']===_0xe7ee73(0x142)?_0x5ce48b[_0xe7ee73(0x106)]({'success':!![],'message':_0xe7ee73(0x12e),'result':{'status':'PAID','transactionId':_0x1ea44d[_0xe7ee73(0x12d)],'redirectUrl':_0x4c867a[_0xe7ee73(0x11d)]}}):_0x5ce48b[_0xe7ee73(0xf9)](0x190)['json']({'success':![],'message':_0xe7ee73(0x10a),'result':{'status':'FAILED','failureReason':_0x1ea44d[_0xe7ee73(0xff)],'redirectUrl':_0x4c867a[_0xe7ee73(0x11f)]}});}catch(_0x59daa1){_0x5aec80(_0x59daa1);}},this[_0x15fc15(0x120)]=new testGatewayService_1[(_0x15fc15(0xfd))](),this[_0x15fc15(0x12a)]=new webhookService_1[(_0x15fc15(0x14c))]();}async[a13_0x2d9043(0x13c)](_0x48b06a,_0x2506ad,_0x5bfea4,_0xca30d8){const _0x445c57=a13_0x2d9043,_0x32059f=Date[_0x445c57(0x14f)]();try{const _0x450c2a=_0x48b06a[_0x445c57(0xef)],_0x36f8aa=_0x450c2a[_0x445c57(0x100)];if(!_0x36f8aa?.['webhookUrl']){console['log'](_0x445c57(0x13b)+_0x450c2a['id']);return;}const _0x373980=_0x2506ad===_0x445c57(0x142)?_0x445c57(0x135):'payment.failed';let _0x3f82a3=[];if(_0x36f8aa['webhookEvents'])try{_0x3f82a3=Array[_0x445c57(0x109)](_0x36f8aa[_0x445c57(0x115)])?_0x36f8aa[_0x445c57(0x115)]:JSON[_0x445c57(0x149)](_0x36f8aa[_0x445c57(0x115)]);}catch(_0x203840){console[_0x445c57(0x14b)](_0x445c57(0x156),_0x203840),_0x3f82a3=[];}if(!_0x3f82a3['includes'](_0x373980)){console['log'](_0x445c57(0x132)+_0x373980+_0x445c57(0x10f)+_0x450c2a['id']);return;}const _0x26d738={'event':_0x373980,'payment':{'id':_0x48b06a['id'],'order_id':_0x48b06a['orderId'],'gateway_order_id':_0x48b06a[_0x445c57(0x133)],'gateway':_0x445c57(0x128),'amount':_0x48b06a[_0x445c57(0x14d)],'currency':_0x48b06a[_0x445c57(0x13a)],'status':_0x2506ad[_0x445c57(0x11a)](),'customer_email':_0x48b06a[_0x445c57(0x148)],'customer_name':_0x48b06a[_0x445c57(0x144)],'transaction_id':_0x5bfea4,'failure_message':_0xca30d8,'created_at':_0x48b06a[_0x445c57(0x10d)],'updated_at':new Date()}},_0x19d8d5=await fetch(_0x36f8aa['webhookUrl'],{'method':_0x445c57(0x107),'headers':{'Content-Type':'application/json','User-Agent':_0x445c57(0x101)},'body':JSON['stringify'](_0x26d738)}),_0xca69e1=Date[_0x445c57(0x14f)]()-_0x32059f;console[_0x445c57(0x127)](_0x445c57(0x155)+_0x36f8aa[_0x445c57(0xfb)]+_0x445c57(0x125)+_0x19d8d5[_0x445c57(0xf9)]+'\x20('+_0xca69e1+'ms)');}catch(_0x33dfd3){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x33dfd3);}}async[a13_0x2d9043(0xfa)](_0xba627,_0x4c8262){const _0x2814e1=a13_0x2d9043;try{const {telegramBotService:_0x5a2afa}=await Promise[_0x2814e1(0x137)]()[_0x2814e1(0x134)](()=>__importStar(require(_0x2814e1(0x12b)))),_0x96d571={'PAID':_0x2814e1(0x114),'FAILED':_0x2814e1(0xf5)},_0x2fa63d=_0x96d571[_0x4c8262];if(!_0x2fa63d)return;await _0x5a2afa['sendPaymentNotification'](_0xba627['shopId'],_0xba627,_0x2fa63d);}catch(_0x1690e2){console[_0x2814e1(0x14b)](_0x2814e1(0x151),_0x1690e2);}}}function a13_0x2a73(){const _0x5689b7=['failureMessage','get','failed','cardLast4','830131LZTxen','test_gateway_','status','sendPaymentStatusNotification','webhookUrl','body','TestGatewayService','191328wJzfWZ','failureReason','settings','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x203-4\x20digits','cardNumber','prototype','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','json','POST','3408064XhweUK','isArray','Payment\x20failed','toISOString','Any\x20name','createdAt','Payment\x20is\x20not\x20for\x20test\x20gateway','\x20not\x20enabled\x20for\x20shop\x20','32zSxxMT','test_gateway','gatewayPaymentId','__createBinding','paid','webhookEvents','create','980340jlIUQd','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','🧪\x20Test\x20Gateway\x20result:','toLowerCase','params','getPaymentForm','successUrl','default','failUrl','testGatewayService','Payment\x20status\x20is\x20','PENDING',',\x20cannot\x20process','update','\x20with\x20status\x20','paidAt','log','0000','Any\x20future\x20date\x20(MM/YY)','webhookService','../services/telegramBotService','webhookLog','transactionId','Payment\x20processed\x20successfully','getOwnPropertyDescriptor','Payment\x20not\x20found','gateway','Webhook\x20event\x20','gatewayOrderId','then','payment.success','4242\x204242\x204242\x204242','resolve','__setModuleDefault','Any\x20other\x20card\x20number','currency','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','sendShopWebhook','✅\x20Test\x20Gateway\x20payment\x20','__esModule','payment','hasOwnProperty','defineProperty','PAID','Payment\x20to\x20','customerName','31179294XepSeE','__importDefault','2439696IMFdLI','customerEmail','parse','getOwnPropertyNames','error','WebhookService','amount','name','now','length','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','stringify','findUnique','TestGatewayController','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Error\x20parsing\x20webhook\x20events:','shopId','../services/gateways/testGatewayService','7gHMjNo','\x20processed:\x20','shop','test_card','4177570EqsqJj','processCard'];a13_0x2a73=function(){return _0x5689b7;};return a13_0x2a73();}exports[a13_0x2d9043(0x154)]=TestGatewayController;