'use strict';const a13_0x4edef2=a13_0x2c20;(function(_0x1f919a,_0x2a4b6c){const _0x4c4018=a13_0x2c20,_0x5600c9=_0x1f919a();while(!![]){try{const _0x3d35a9=-parseInt(_0x4c4018(0xa9))/0x1+-parseInt(_0x4c4018(0xc3))/0x2*(-parseInt(_0x4c4018(0xa6))/0x3)+parseInt(_0x4c4018(0xb8))/0x4*(parseInt(_0x4c4018(0x71))/0x5)+-parseInt(_0x4c4018(0xc1))/0x6+-parseInt(_0x4c4018(0xdc))/0x7*(parseInt(_0x4c4018(0xa7))/0x8)+parseInt(_0x4c4018(0x9f))/0x9+-parseInt(_0x4c4018(0x9c))/0xa*(parseInt(_0x4c4018(0x92))/0xb);if(_0x3d35a9===_0x2a4b6c)break;else _0x5600c9['push'](_0x5600c9['shift']());}catch(_0x13cc72){_0x5600c9['push'](_0x5600c9['shift']());}}}(a13_0x596c,0xb7597));var __createBinding=this&&this[a13_0x4edef2(0x85)]||(Object[a13_0x4edef2(0x73)]?function(_0x45341b,_0x2d59ef,_0x2ef48f,_0x1eb143){const _0x1f0933=a13_0x4edef2;if(_0x1eb143===undefined)_0x1eb143=_0x2ef48f;var _0x37db5b=Object[_0x1f0933(0xb7)](_0x2d59ef,_0x2ef48f);(!_0x37db5b||(_0x1f0933(0x7a)in _0x37db5b?!_0x2d59ef[_0x1f0933(0xc2)]:_0x37db5b[_0x1f0933(0x96)]||_0x37db5b[_0x1f0933(0xb0)]))&&(_0x37db5b={'enumerable':!![],'get':function(){return _0x2d59ef[_0x2ef48f];}}),Object[_0x1f0933(0x9b)](_0x45341b,_0x1eb143,_0x37db5b);}:function(_0x8fa538,_0x33b3c3,_0x29d9c0,_0x349a0b){if(_0x349a0b===undefined)_0x349a0b=_0x29d9c0;_0x8fa538[_0x349a0b]=_0x33b3c3[_0x29d9c0];}),__setModuleDefault=this&&this[a13_0x4edef2(0xb1)]||(Object[a13_0x4edef2(0x73)]?function(_0x26060c,_0x1be06b){const _0x335eb3=a13_0x4edef2;Object[_0x335eb3(0x9b)](_0x26060c,_0x335eb3(0xda),{'enumerable':!![],'value':_0x1be06b});}:function(_0x501142,_0x4888c9){_0x501142['default']=_0x4888c9;}),__importStar=this&&this[a13_0x4edef2(0x82)]||(function(){var _0x39da16=function(_0x4ce3c2){const _0x435e82=a13_0x2c20;return _0x39da16=Object[_0x435e82(0xb9)]||function(_0xa689e4){const _0x28610c=_0x435e82;var _0x1b702d=[];for(var _0x24dbd1 in _0xa689e4)if(Object[_0x28610c(0x90)][_0x28610c(0x94)]['call'](_0xa689e4,_0x24dbd1))_0x1b702d[_0x1b702d['length']]=_0x24dbd1;return _0x1b702d;},_0x39da16(_0x4ce3c2);};return function(_0x419269){const _0x34497d=a13_0x2c20;if(_0x419269&&_0x419269[_0x34497d(0xc2)])return _0x419269;var _0xd2fa48={};if(_0x419269!=null){for(var _0x110680=_0x39da16(_0x419269),_0x4ad015=0x0;_0x4ad015<_0x110680[_0x34497d(0x74)];_0x4ad015++)if(_0x110680[_0x4ad015]!==_0x34497d(0xda))__createBinding(_0xd2fa48,_0x419269,_0x110680[_0x4ad015]);}return __setModuleDefault(_0xd2fa48,_0x419269),_0xd2fa48;};}()),__importDefault=this&&this[a13_0x4edef2(0x88)]||function(_0x2426d9){return _0x2426d9&&_0x2426d9['__esModule']?_0x2426d9:{'default':_0x2426d9};};Object[a13_0x4edef2(0x9b)](exports,a13_0x4edef2(0xc2),{'value':!![]}),exports[a13_0x4edef2(0xaf)]=void 0x0;const testGatewayService_1=require(a13_0x4edef2(0xcf)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));function a13_0x2c20(_0x5ca782,_0x7d8dbc){const _0x596c54=a13_0x596c();return a13_0x2c20=function(_0x2c20a9,_0x295c03){_0x2c20a9=_0x2c20a9-0x71;let _0x11b0c9=_0x596c54[_0x2c20a9];return _0x11b0c9;},a13_0x2c20(_0x5ca782,_0x7d8dbc);}function a13_0x596c(){const _0x56d962=['configurable','__setModuleDefault','âœ…\x20Test\x20Gateway\x20payment\x20','stringify','../services/telegramBotService','WebhookService','webhookEvents','getOwnPropertyDescriptor','5724tsJxTb','getOwnPropertyNames','customerName','gatewayOrderId','orderId','slice','test_gateway','includes','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','5189226oJSNTD','__esModule','2QLAHaH','successUrl','params','settings','body','toISOString','status','json','amount','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','sendShopWebhook','\x20not\x20enabled\x20for\x20shop\x20','../services/gateways/testGatewayService','Webhook\x20event\x20','TestGatewayService','then','resolve','toLowerCase','testGatewayService','paidAt','Error\x20parsing\x20webhook\x20events:','POST','processCardPayment','default','Any\x203-4\x20digits','14OcaRnc','webhookUrl','failureReason','findUnique','Payment\x20failed','payment.failed','3455grIXqP','createdAt','create','length','transactionId','replace','gateway','gatewayPaymentId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','get','customerEmail','webhookService','Payment\x20is\x20not\x20for\x20test\x20gateway','PAID','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','cardLast4','Payment\x20not\x20found','__importStar','payment.success','failureMessage','__createBinding','sendPaymentNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','__importDefault','shop','isArray','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','sendPaymentStatusNotification','Any\x20other\x20card\x20number','Any\x20future\x20date\x20(MM/YY)','Payment\x20processed\x20successfully','prototype','name','2677565cdkYsE','PENDING','hasOwnProperty','payment','writable','paymentMethod','\x20with\x20status\x20','FAILED','processCard','defineProperty','10RVEEMy','Payment\x20to\x20','error','11835801axAsMM','\x20processed:\x20','Payment\x20status\x20is\x20','getPaymentForm','currency','Any\x20name','application/json','4502991IDEcOe','3602216TLxiCx','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','1045068vQmLGw','4242\x204242\x204242\x204242','0000','failUrl','webhookLog','log','TestGatewayController'];a13_0x596c=function(){return _0x56d962;};return a13_0x596c();}class TestGatewayController{constructor(){const _0x48e070=a13_0x4edef2;this[_0x48e070(0xa2)]=async(_0x46648b,_0x5eeb92,_0x4f3c13)=>{const _0x3f3116=_0x48e070;try{const {paymentId:_0x19edcc}=_0x46648b['params'];console[_0x3f3116(0xae)](_0x3f3116(0x8b)+_0x19edcc);const _0x6aeb88=await database_1[_0x3f3116(0xda)][_0x3f3116(0x95)][_0x3f3116(0xdf)]({'where':{'id':_0x19edcc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x6aeb88)return _0x5eeb92['status'](0x194)[_0x3f3116(0xca)]({'success':![],'message':_0x3f3116(0x81)});if(_0x6aeb88['gateway']!==_0x3f3116(0xbe))return _0x5eeb92[_0x3f3116(0xc9)](0x190)[_0x3f3116(0xca)]({'success':![],'message':_0x3f3116(0x7d)});if(_0x6aeb88[_0x3f3116(0xc9)]!=='PENDING')return _0x5eeb92['status'](0x190)[_0x3f3116(0xca)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x6aeb88[_0x3f3116(0xc9)]+',\x20cannot\x20process'});_0x5eeb92[_0x3f3116(0xca)]({'success':!![],'result':{'paymentId':_0x6aeb88['id'],'orderId':_0x6aeb88['gatewayOrderId'],'amount':_0x6aeb88[_0x3f3116(0xcb)],'currency':_0x6aeb88['currency'],'merchantName':_0x6aeb88[_0x3f3116(0x89)][_0x3f3116(0x91)],'description':_0x3f3116(0x9d)+_0x6aeb88[_0x3f3116(0x89)][_0x3f3116(0x91)],'testInstructions':{'successCard':_0x3f3116(0xaa),'failureCard':_0x3f3116(0x8d),'expiryDate':_0x3f3116(0x8e),'cvc':_0x3f3116(0xdb),'holderName':_0x3f3116(0xa4)}}});}catch(_0x40a820){_0x4f3c13(_0x40a820);}},this[_0x48e070(0x9a)]=async(_0x25e66f,_0x1539a4,_0x221db1)=>{const _0x48fd62=_0x48e070;try{const {paymentId:_0x48d1e4}=_0x25e66f[_0x48fd62(0xc5)],_0x224454=_0x25e66f[_0x48fd62(0xc7)];console[_0x48fd62(0xae)](_0x48fd62(0xcc)+_0x48d1e4);const _0x52530b=await database_1[_0x48fd62(0xda)]['payment'][_0x48fd62(0xdf)]({'where':{'id':_0x48d1e4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52530b)return _0x1539a4[_0x48fd62(0xc9)](0x194)[_0x48fd62(0xca)]({'success':![],'message':_0x48fd62(0x81)});if(_0x52530b[_0x48fd62(0x77)]!=='test_gateway')return _0x1539a4[_0x48fd62(0xc9)](0x190)['json']({'success':![],'message':_0x48fd62(0x7d)});if(_0x52530b['status']!==_0x48fd62(0x93))return _0x1539a4['status'](0x190)[_0x48fd62(0xca)]({'success':![],'message':_0x48fd62(0xa1)+_0x52530b['status']+',\x20cannot\x20process'});const _0x25fcda=await this[_0x48fd62(0xd5)][_0x48fd62(0xd9)]({'paymentId':_0x52530b['id'],'orderId':_0x52530b[_0x48fd62(0xbb)]||_0x52530b['id'],'amount':_0x52530b[_0x48fd62(0xcb)],'currency':_0x52530b['currency'],'cardData':_0x224454});console[_0x48fd62(0xae)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x25fcda);const _0x42d5a2={'status':_0x25fcda[_0x48fd62(0xc9)],'updatedAt':new Date()};if(_0x25fcda[_0x48fd62(0xc9)]===_0x48fd62(0x7e))_0x42d5a2[_0x48fd62(0xd6)]=new Date(),_0x42d5a2[_0x48fd62(0x78)]=_0x25fcda[_0x48fd62(0x75)];else _0x25fcda['status']==='FAILED'&&(_0x42d5a2[_0x48fd62(0x84)]=_0x25fcda[_0x48fd62(0xde)]);const _0x4e71cd=_0x224454['cardNumber'][_0x48fd62(0x76)](/[\s-]/g,'');_0x42d5a2[_0x48fd62(0x80)]=_0x4e71cd[_0x48fd62(0xbd)](-0x4),_0x42d5a2[_0x48fd62(0x97)]='test_card',await database_1[_0x48fd62(0xda)][_0x48fd62(0x95)]['update']({'where':{'id':_0x52530b['id']},'data':_0x42d5a2}),await database_1['default'][_0x48fd62(0xad)][_0x48fd62(0x73)]({'data':{'paymentId':_0x52530b['id'],'shopId':_0x52530b['shopId'],'event':'test_gateway_'+_0x25fcda[_0x48fd62(0xc9)][_0x48fd62(0xd4)](),'statusCode':0xc8,'responseBody':JSON[_0x48fd62(0xb3)]({'oldStatus':_0x48fd62(0x93),'newStatus':_0x25fcda['status'],'transactionId':_0x25fcda[_0x48fd62(0x75)],'failureReason':_0x25fcda['failureReason'],'processedAt':new Date()[_0x48fd62(0xc8)]()})}}),await this[_0x48fd62(0xcd)](_0x52530b,_0x25fcda[_0x48fd62(0xc9)],_0x25fcda['transactionId'],_0x25fcda[_0x48fd62(0xde)]),await this[_0x48fd62(0x8c)](_0x52530b,_0x25fcda[_0x48fd62(0xc9)]),console[_0x48fd62(0xae)](_0x48fd62(0xb2)+_0x48d1e4+_0x48fd62(0xa0)+_0x25fcda[_0x48fd62(0xc9)]),_0x25fcda[_0x48fd62(0xc9)]===_0x48fd62(0x7e)?_0x1539a4[_0x48fd62(0xca)]({'success':!![],'message':_0x48fd62(0x8f),'result':{'status':'PAID','transactionId':_0x25fcda['transactionId'],'redirectUrl':_0x52530b[_0x48fd62(0xc4)]}}):_0x1539a4[_0x48fd62(0xc9)](0x190)['json']({'success':![],'message':_0x48fd62(0xe0),'result':{'status':_0x48fd62(0x99),'failureReason':_0x25fcda[_0x48fd62(0xde)],'redirectUrl':_0x52530b[_0x48fd62(0xac)]}});}catch(_0x574380){_0x221db1(_0x574380);}},this[_0x48e070(0xd5)]=new testGatewayService_1[(_0x48e070(0xd1))](),this[_0x48e070(0x7c)]=new webhookService_1[(_0x48e070(0xb5))]();}async[a13_0x4edef2(0xcd)](_0x37656b,_0xb571d8,_0x620222,_0x3c736a){const _0x24b72e=a13_0x4edef2,_0x544731=Date['now']();try{const _0x2ced47=_0x37656b[_0x24b72e(0x89)],_0x4cf13e=_0x2ced47[_0x24b72e(0xc6)];if(!_0x4cf13e?.['webhookUrl']){console[_0x24b72e(0xae)](_0x24b72e(0xc0)+_0x2ced47['id']);return;}const _0x13db53=_0xb571d8==='PAID'?_0x24b72e(0x83):_0x24b72e(0xe1);let _0x5543d5=[];if(_0x4cf13e['webhookEvents'])try{_0x5543d5=Array[_0x24b72e(0x8a)](_0x4cf13e[_0x24b72e(0xb6)])?_0x4cf13e[_0x24b72e(0xb6)]:JSON['parse'](_0x4cf13e[_0x24b72e(0xb6)]);}catch(_0x49fd6b){console[_0x24b72e(0x9e)](_0x24b72e(0xd7),_0x49fd6b),_0x5543d5=[];}if(!_0x5543d5[_0x24b72e(0xbf)](_0x13db53)){console[_0x24b72e(0xae)](_0x24b72e(0xd0)+_0x13db53+_0x24b72e(0xce)+_0x2ced47['id']);return;}const _0x1bc675={'event':_0x13db53,'payment':{'id':_0x37656b['id'],'order_id':_0x37656b[_0x24b72e(0xbc)],'gateway_order_id':_0x37656b['gatewayOrderId'],'gateway':_0x24b72e(0xab),'amount':_0x37656b[_0x24b72e(0xcb)],'currency':_0x37656b[_0x24b72e(0xa3)],'status':_0xb571d8['toLowerCase'](),'customer_email':_0x37656b[_0x24b72e(0x7b)],'customer_name':_0x37656b[_0x24b72e(0xba)],'transaction_id':_0x620222,'failure_message':_0x3c736a,'created_at':_0x37656b[_0x24b72e(0x72)],'updated_at':new Date()}},_0x465716=await fetch(_0x4cf13e[_0x24b72e(0xdd)],{'method':_0x24b72e(0xd8),'headers':{'Content-Type':_0x24b72e(0xa5),'User-Agent':_0x24b72e(0x7f)},'body':JSON[_0x24b72e(0xb3)](_0x1bc675)}),_0x4d2107=Date['now']()-_0x544731;console[_0x24b72e(0xae)](_0x24b72e(0x79)+_0x4cf13e[_0x24b72e(0xdd)]+_0x24b72e(0x98)+_0x465716[_0x24b72e(0xc9)]+'\x20('+_0x4d2107+'ms)');}catch(_0x1d3b0b){console['error'](_0x24b72e(0xa8),_0x1d3b0b);}}async[a13_0x4edef2(0x8c)](_0x2bf7ea,_0x4047ff){const _0x2d4c86=a13_0x4edef2;try{const {telegramBotService:_0x4971f5}=await Promise[_0x2d4c86(0xd3)]()[_0x2d4c86(0xd2)](()=>__importStar(require(_0x2d4c86(0xb4)))),_0x43120e={'PAID':'paid','FAILED':'failed'},_0x257fd7=_0x43120e[_0x4047ff];if(!_0x257fd7)return;await _0x4971f5[_0x2d4c86(0x86)](_0x2bf7ea['shopId'],_0x2bf7ea,_0x257fd7);}catch(_0x30b1a1){console['error'](_0x2d4c86(0x87),_0x30b1a1);}}}exports[a13_0x4edef2(0xaf)]=TestGatewayController;