'use strict';const a13_0x501c76=a13_0x5da6;(function(_0x29b484,_0x73ba58){const _0x448759=a13_0x5da6,_0x33c1ff=_0x29b484();while(!![]){try{const _0x4ebd34=parseInt(_0x448759(0xe5))/0x1+-parseInt(_0x448759(0xf4))/0x2*(-parseInt(_0x448759(0x107))/0x3)+parseInt(_0x448759(0xe7))/0x4*(-parseInt(_0x448759(0x14c))/0x5)+-parseInt(_0x448759(0xf9))/0x6+-parseInt(_0x448759(0x14b))/0x7*(-parseInt(_0x448759(0x133))/0x8)+parseInt(_0x448759(0x10a))/0x9+-parseInt(_0x448759(0x10d))/0xa*(parseInt(_0x448759(0xe8))/0xb);if(_0x4ebd34===_0x73ba58)break;else _0x33c1ff['push'](_0x33c1ff['shift']());}catch(_0x51296d){_0x33c1ff['push'](_0x33c1ff['shift']());}}}(a13_0x1e51,0x96532));function a13_0x1e51(){const _0x333642=['âœ…\x20Test\x20Gateway\x20payment\x20','4242\x204242\x204242\x204242','gatewayPaymentId','error','Error\x20parsing\x20webhook\x20events:','Payment\x20status\x20is\x20','log','parse','application/json','FAILED','isArray','TestGatewayController','../services/gateways/testGatewayService','configurable','\x20processed:\x20','WebhookService','slice','prototype','failUrl','\x20not\x20enabled\x20for\x20shop\x20','successUrl','PAID','POST','webhookService','orderId','now','replace','params','gatewayOrderId','8296NwmNmn','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','sendShopWebhook','createdAt','testGatewayService','failureReason','webhookUrl','json','cardNumber','__createBinding','cardLast4','defineProperty','Payment\x20is\x20not\x20for\x20test\x20gateway','length','ms)','amount','Any\x203-4\x20digits','../config/database','writable','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','__importDefault','getOwnPropertyNames',',\x20cannot\x20process','1197vJhkNx','35VpKxAJ','../services/webhookService','test_gateway','1013659TRgaCr','paymentMethod','394072MfcQDH','67958WhjIzJ','findUnique','payment.failed','getOwnPropertyDescriptor','customerEmail','create','__esModule','TestGatewayService','payment.success','default','status','sendPaymentStatusNotification','22GQOAxJ','currency','Payment\x20not\x20found','Payment\x20failed','getPaymentForm','6313032mneKmC','webhookEvents','paid','Payment\x20to\x20','Webhook\x20event\x20','body','payment','test_card','stringify','resolve','then','shopId','gateway','webhookLog','268860SxzeXQ','customerName','toLowerCase','7909524kbUYUJ','PENDING','shop','1130tCHbRm','processCardPayment','sendPaymentNotification','\x20with\x20status\x20','processCard','includes','__importStar','failed','Payment\x20processed\x20successfully'];a13_0x1e51=function(){return _0x333642;};return a13_0x1e51();}var __createBinding=this&&this[a13_0x501c76(0x13d)]||(Object[a13_0x501c76(0xed)]?function(_0x1c8e43,_0x61e97a,_0x51e836,_0x496510){const _0x5053c4=a13_0x501c76;if(_0x496510===undefined)_0x496510=_0x51e836;var _0x3bced2=Object[_0x5053c4(0xeb)](_0x61e97a,_0x51e836);(!_0x3bced2||('get'in _0x3bced2?!_0x61e97a[_0x5053c4(0xee)]:_0x3bced2[_0x5053c4(0x146)]||_0x3bced2[_0x5053c4(0x123)]))&&(_0x3bced2={'enumerable':!![],'get':function(){return _0x61e97a[_0x51e836];}}),Object['defineProperty'](_0x1c8e43,_0x496510,_0x3bced2);}:function(_0x52deb5,_0x49c035,_0x4c91ae,_0x5370a9){if(_0x5370a9===undefined)_0x5370a9=_0x4c91ae;_0x52deb5[_0x5370a9]=_0x49c035[_0x4c91ae];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x501c76(0xed)]?function(_0xdf889d,_0x33a128){const _0x46d2e3=a13_0x501c76;Object[_0x46d2e3(0x13f)](_0xdf889d,_0x46d2e3(0xf1),{'enumerable':!![],'value':_0x33a128});}:function(_0x2905ad,_0x386aa7){const _0x38c6c1=a13_0x501c76;_0x2905ad[_0x38c6c1(0xf1)]=_0x386aa7;}),__importStar=this&&this[a13_0x501c76(0x113)]||(function(){var _0x4c4d93=function(_0x3e87e4){const _0x51996f=a13_0x5da6;return _0x4c4d93=Object[_0x51996f(0x149)]||function(_0x54e95b){const _0x1cd787=_0x51996f;var _0x129a97=[];for(var _0x45d31d in _0x54e95b)if(Object[_0x1cd787(0x127)]['hasOwnProperty']['call'](_0x54e95b,_0x45d31d))_0x129a97[_0x129a97[_0x1cd787(0x141)]]=_0x45d31d;return _0x129a97;},_0x4c4d93(_0x3e87e4);};return function(_0x46dff6){const _0x189e16=a13_0x5da6;if(_0x46dff6&&_0x46dff6[_0x189e16(0xee)])return _0x46dff6;var _0x39456d={};if(_0x46dff6!=null){for(var _0x7ff8bc=_0x4c4d93(_0x46dff6),_0x520e56=0x0;_0x520e56<_0x7ff8bc['length'];_0x520e56++)if(_0x7ff8bc[_0x520e56]!==_0x189e16(0xf1))__createBinding(_0x39456d,_0x46dff6,_0x7ff8bc[_0x520e56]);}return __setModuleDefault(_0x39456d,_0x46dff6),_0x39456d;};}()),__importDefault=this&&this[a13_0x501c76(0x148)]||function(_0x17c03b){const _0x2d2b27=a13_0x501c76;return _0x17c03b&&_0x17c03b[_0x2d2b27(0xee)]?_0x17c03b:{'default':_0x17c03b};};Object[a13_0x501c76(0x13f)](exports,a13_0x501c76(0xee),{'value':!![]}),exports[a13_0x501c76(0x121)]=void 0x0;function a13_0x5da6(_0x5336f7,_0x4f0434){const _0x1e51fe=a13_0x1e51();return a13_0x5da6=function(_0x5da658,_0x3160ad){_0x5da658=_0x5da658-0xe4;let _0x1f9f07=_0x1e51fe[_0x5da658];return _0x1f9f07;},a13_0x5da6(_0x5336f7,_0x4f0434);}const testGatewayService_1=require(a13_0x501c76(0x122)),webhookService_1=require(a13_0x501c76(0x14d)),database_1=__importDefault(require(a13_0x501c76(0x145)));class TestGatewayController{constructor(){const _0x1c0ff0=a13_0x501c76;this[_0x1c0ff0(0xf8)]=async(_0x526a4a,_0x250b93,_0x354de1)=>{const _0x403605=_0x1c0ff0;try{const {paymentId:_0x411b78}=_0x526a4a['params'];console[_0x403605(0x11c)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x411b78);const _0x4b28ad=await database_1['default']['payment'][_0x403605(0xe9)]({'where':{'id':_0x411b78},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4b28ad)return _0x250b93[_0x403605(0xf2)](0x194)[_0x403605(0x13b)]({'success':![],'message':_0x403605(0xf6)});if(_0x4b28ad[_0x403605(0x105)]!==_0x403605(0xe4))return _0x250b93[_0x403605(0xf2)](0x190)[_0x403605(0x13b)]({'success':![],'message':_0x403605(0x140)});if(_0x4b28ad[_0x403605(0xf2)]!==_0x403605(0x10b))return _0x250b93[_0x403605(0xf2)](0x190)[_0x403605(0x13b)]({'success':![],'message':_0x403605(0x11b)+_0x4b28ad[_0x403605(0xf2)]+_0x403605(0x14a)});_0x250b93[_0x403605(0x13b)]({'success':!![],'result':{'paymentId':_0x4b28ad['id'],'orderId':_0x4b28ad[_0x403605(0x132)],'amount':_0x4b28ad[_0x403605(0x143)],'currency':_0x4b28ad[_0x403605(0xf5)],'merchantName':_0x4b28ad[_0x403605(0x10c)]['name'],'description':_0x403605(0xfc)+_0x4b28ad[_0x403605(0x10c)]['name'],'testInstructions':{'successCard':_0x403605(0x117),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x403605(0x144),'holderName':'Any\x20name'}}});}catch(_0x2b3342){_0x354de1(_0x2b3342);}},this[_0x1c0ff0(0x111)]=async(_0x594292,_0x219968,_0x1218d8)=>{const _0x1e58c1=_0x1c0ff0;try{const {paymentId:_0x5c026c}=_0x594292[_0x1e58c1(0x131)],_0x1fc270=_0x594292[_0x1e58c1(0xfe)];console[_0x1e58c1(0x11c)](_0x1e58c1(0x134)+_0x5c026c);const _0x561927=await database_1[_0x1e58c1(0xf1)]['payment'][_0x1e58c1(0xe9)]({'where':{'id':_0x5c026c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x561927)return _0x219968['status'](0x194)[_0x1e58c1(0x13b)]({'success':![],'message':_0x1e58c1(0xf6)});if(_0x561927[_0x1e58c1(0x105)]!==_0x1e58c1(0xe4))return _0x219968[_0x1e58c1(0xf2)](0x190)[_0x1e58c1(0x13b)]({'success':![],'message':_0x1e58c1(0x140)});if(_0x561927['status']!==_0x1e58c1(0x10b))return _0x219968[_0x1e58c1(0xf2)](0x190)[_0x1e58c1(0x13b)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x561927[_0x1e58c1(0xf2)]+_0x1e58c1(0x14a)});const _0x52bdf0=await this[_0x1e58c1(0x138)][_0x1e58c1(0x10e)]({'paymentId':_0x561927['id'],'orderId':_0x561927[_0x1e58c1(0x132)]||_0x561927['id'],'amount':_0x561927[_0x1e58c1(0x143)],'currency':_0x561927[_0x1e58c1(0xf5)],'cardData':_0x1fc270});console[_0x1e58c1(0x11c)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x52bdf0);const _0x233fab={'status':_0x52bdf0[_0x1e58c1(0xf2)],'updatedAt':new Date()};if(_0x52bdf0[_0x1e58c1(0xf2)]==='PAID')_0x233fab['paidAt']=new Date(),_0x233fab[_0x1e58c1(0x118)]=_0x52bdf0['transactionId'];else _0x52bdf0[_0x1e58c1(0xf2)]===_0x1e58c1(0x11f)&&(_0x233fab['failureMessage']=_0x52bdf0[_0x1e58c1(0x139)]);const _0x14e26e=_0x1fc270[_0x1e58c1(0x13c)][_0x1e58c1(0x130)](/[\s-]/g,'');_0x233fab[_0x1e58c1(0x13e)]=_0x14e26e[_0x1e58c1(0x126)](-0x4),_0x233fab[_0x1e58c1(0xe6)]=_0x1e58c1(0x100),await database_1[_0x1e58c1(0xf1)][_0x1e58c1(0xff)]['update']({'where':{'id':_0x561927['id']},'data':_0x233fab}),await database_1['default'][_0x1e58c1(0x106)][_0x1e58c1(0xed)]({'data':{'paymentId':_0x561927['id'],'shopId':_0x561927[_0x1e58c1(0x104)],'event':'test_gateway_'+_0x52bdf0[_0x1e58c1(0xf2)][_0x1e58c1(0x109)](),'statusCode':0xc8,'responseBody':JSON[_0x1e58c1(0x101)]({'oldStatus':_0x1e58c1(0x10b),'newStatus':_0x52bdf0[_0x1e58c1(0xf2)],'transactionId':_0x52bdf0['transactionId'],'failureReason':_0x52bdf0[_0x1e58c1(0x139)],'processedAt':new Date()['toISOString']()})}}),await this[_0x1e58c1(0x136)](_0x561927,_0x52bdf0[_0x1e58c1(0xf2)],_0x52bdf0['transactionId'],_0x52bdf0[_0x1e58c1(0x139)]),await this[_0x1e58c1(0xf3)](_0x561927,_0x52bdf0[_0x1e58c1(0xf2)]),console[_0x1e58c1(0x11c)](_0x1e58c1(0x116)+_0x5c026c+_0x1e58c1(0x124)+_0x52bdf0[_0x1e58c1(0xf2)]),_0x52bdf0[_0x1e58c1(0xf2)]===_0x1e58c1(0x12b)?_0x219968[_0x1e58c1(0x13b)]({'success':!![],'message':_0x1e58c1(0x115),'result':{'status':_0x1e58c1(0x12b),'transactionId':_0x52bdf0['transactionId'],'redirectUrl':_0x561927[_0x1e58c1(0x12a)]}}):_0x219968['status'](0x190)[_0x1e58c1(0x13b)]({'success':![],'message':_0x1e58c1(0xf7),'result':{'status':'FAILED','failureReason':_0x52bdf0[_0x1e58c1(0x139)],'redirectUrl':_0x561927[_0x1e58c1(0x128)]}});}catch(_0x34e5cf){_0x1218d8(_0x34e5cf);}},this['testGatewayService']=new testGatewayService_1[(_0x1c0ff0(0xef))](),this[_0x1c0ff0(0x12d)]=new webhookService_1[(_0x1c0ff0(0x125))]();}async[a13_0x501c76(0x136)](_0x49626c,_0x2b3997,_0x3553a5,_0x2d86a1){const _0x3925e6=a13_0x501c76,_0x474038=Date[_0x3925e6(0x12f)]();try{const _0x1a5236=_0x49626c['shop'],_0x14fb54=_0x1a5236['settings'];if(!_0x14fb54?.[_0x3925e6(0x13a)]){console[_0x3925e6(0x11c)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1a5236['id']);return;}const _0x3836cf=_0x2b3997==='PAID'?_0x3925e6(0xf0):_0x3925e6(0xea);let _0x2248d3=[];if(_0x14fb54[_0x3925e6(0xfa)])try{_0x2248d3=Array[_0x3925e6(0x120)](_0x14fb54['webhookEvents'])?_0x14fb54[_0x3925e6(0xfa)]:JSON[_0x3925e6(0x11d)](_0x14fb54[_0x3925e6(0xfa)]);}catch(_0x4fdcee){console[_0x3925e6(0x119)](_0x3925e6(0x11a),_0x4fdcee),_0x2248d3=[];}if(!_0x2248d3[_0x3925e6(0x112)](_0x3836cf)){console[_0x3925e6(0x11c)](_0x3925e6(0xfd)+_0x3836cf+_0x3925e6(0x129)+_0x1a5236['id']);return;}const _0x55cca6={'event':_0x3836cf,'payment':{'id':_0x49626c['id'],'order_id':_0x49626c[_0x3925e6(0x12e)],'gateway_order_id':_0x49626c[_0x3925e6(0x132)],'gateway':'0000','amount':_0x49626c[_0x3925e6(0x143)],'currency':_0x49626c[_0x3925e6(0xf5)],'status':_0x2b3997[_0x3925e6(0x109)](),'customer_email':_0x49626c[_0x3925e6(0xec)],'customer_name':_0x49626c[_0x3925e6(0x108)],'transaction_id':_0x3553a5,'failure_message':_0x2d86a1,'created_at':_0x49626c[_0x3925e6(0x137)],'updated_at':new Date()}},_0x3d1238=await fetch(_0x14fb54[_0x3925e6(0x13a)],{'method':_0x3925e6(0x12c),'headers':{'Content-Type':_0x3925e6(0x11e),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3925e6(0x101)](_0x55cca6)}),_0x59552d=Date[_0x3925e6(0x12f)]()-_0x474038;console[_0x3925e6(0x11c)](_0x3925e6(0x135)+_0x14fb54[_0x3925e6(0x13a)]+_0x3925e6(0x110)+_0x3d1238[_0x3925e6(0xf2)]+'\x20('+_0x59552d+_0x3925e6(0x142));}catch(_0x19ce9b){console[_0x3925e6(0x119)](_0x3925e6(0x147),_0x19ce9b);}}async['sendPaymentStatusNotification'](_0x59ea4a,_0x23d2fd){const _0x21414a=a13_0x501c76;try{const {telegramBotService:_0x338c42}=await Promise[_0x21414a(0x102)]()[_0x21414a(0x103)](()=>__importStar(require('../services/telegramBotService'))),_0x205695={'PAID':_0x21414a(0xfb),'FAILED':_0x21414a(0x114)},_0x3fed99=_0x205695[_0x23d2fd];if(!_0x3fed99)return;await _0x338c42[_0x21414a(0x10f)](_0x59ea4a[_0x21414a(0x104)],_0x59ea4a,_0x3fed99);}catch(_0x3ecfd2){console[_0x21414a(0x119)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3ecfd2);}}}exports[a13_0x501c76(0x121)]=TestGatewayController;