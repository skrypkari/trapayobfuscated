'use strict';const a13_0xe4ec7e=a13_0x2b62;(function(_0x2e48b4,_0x5cf40f){const _0x4fba7e=a13_0x2b62,_0x10459b=_0x2e48b4();while(!![]){try{const _0x23f185=parseInt(_0x4fba7e(0x227))/0x1+-parseInt(_0x4fba7e(0x22c))/0x2*(parseInt(_0x4fba7e(0x221))/0x3)+-parseInt(_0x4fba7e(0x234))/0x4+parseInt(_0x4fba7e(0x24b))/0x5+-parseInt(_0x4fba7e(0x1fb))/0x6*(-parseInt(_0x4fba7e(0x246))/0x7)+parseInt(_0x4fba7e(0x1f1))/0x8*(parseInt(_0x4fba7e(0x1fa))/0x9)+parseInt(_0x4fba7e(0x1f8))/0xa;if(_0x23f185===_0x5cf40f)break;else _0x10459b['push'](_0x10459b['shift']());}catch(_0x2c3f77){_0x10459b['push'](_0x10459b['shift']());}}}(a13_0xa8d3,0x7fd91));var __createBinding=this&&this[a13_0xe4ec7e(0x238)]||(Object['create']?function(_0x530a84,_0x2b08f6,_0x1464fb,_0x4b3c48){const _0x1ba612=a13_0xe4ec7e;if(_0x4b3c48===undefined)_0x4b3c48=_0x1464fb;var _0x28eef3=Object['getOwnPropertyDescriptor'](_0x2b08f6,_0x1464fb);(!_0x28eef3||('get'in _0x28eef3?!_0x2b08f6['__esModule']:_0x28eef3[_0x1ba612(0x241)]||_0x28eef3[_0x1ba612(0x20b)]))&&(_0x28eef3={'enumerable':!![],'get':function(){return _0x2b08f6[_0x1464fb];}}),Object[_0x1ba612(0x1ef)](_0x530a84,_0x4b3c48,_0x28eef3);}:function(_0x5a42a2,_0xcfa571,_0x2484f6,_0x443b8c){if(_0x443b8c===undefined)_0x443b8c=_0x2484f6;_0x5a42a2[_0x443b8c]=_0xcfa571[_0x2484f6];}),__setModuleDefault=this&&this[a13_0xe4ec7e(0x232)]||(Object[a13_0xe4ec7e(0x252)]?function(_0x1c3a69,_0x23e564){const _0x16b3f9=a13_0xe4ec7e;Object[_0x16b3f9(0x1ef)](_0x1c3a69,_0x16b3f9(0x224),{'enumerable':!![],'value':_0x23e564});}:function(_0x38d7ad,_0x2ccfb9){const _0x486158=a13_0xe4ec7e;_0x38d7ad[_0x486158(0x224)]=_0x2ccfb9;}),__importStar=this&&this[a13_0xe4ec7e(0x215)]||(function(){var _0x1a5b7b=function(_0x3e0866){const _0xfeab9f=a13_0x2b62;return _0x1a5b7b=Object[_0xfeab9f(0x202)]||function(_0x87bd89){const _0x37f813=_0xfeab9f;var _0x56c8f9=[];for(var _0x20277d in _0x87bd89)if(Object['prototype'][_0x37f813(0x22b)]['call'](_0x87bd89,_0x20277d))_0x56c8f9[_0x56c8f9[_0x37f813(0x205)]]=_0x20277d;return _0x56c8f9;},_0x1a5b7b(_0x3e0866);};return function(_0x55e5e9){const _0x4c2460=a13_0x2b62;if(_0x55e5e9&&_0x55e5e9[_0x4c2460(0x1fd)])return _0x55e5e9;var _0x124074={};if(_0x55e5e9!=null){for(var _0x56dc3e=_0x1a5b7b(_0x55e5e9),_0x32a5fd=0x0;_0x32a5fd<_0x56dc3e[_0x4c2460(0x205)];_0x32a5fd++)if(_0x56dc3e[_0x32a5fd]!==_0x4c2460(0x224))__createBinding(_0x124074,_0x55e5e9,_0x56dc3e[_0x32a5fd]);}return __setModuleDefault(_0x124074,_0x55e5e9),_0x124074;};}()),__importDefault=this&&this[a13_0xe4ec7e(0x1ff)]||function(_0x442008){const _0x45441b=a13_0xe4ec7e;return _0x442008&&_0x442008[_0x45441b(0x1fd)]?_0x442008:{'default':_0x442008};};Object[a13_0xe4ec7e(0x1ef)](exports,'__esModule',{'value':!![]}),exports[a13_0xe4ec7e(0x208)]=void 0x0;function a13_0x2b62(_0x5afaaa,_0xa9e03f){const _0xa8d3ad=a13_0xa8d3();return a13_0x2b62=function(_0x2b6235,_0x2c3835){_0x2b6235=_0x2b6235-0x1ef;let _0x31ccd9=_0xa8d3ad[_0x2b6235];return _0x31ccd9;},a13_0x2b62(_0x5afaaa,_0xa9e03f);}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0xe4ec7e(0x230)),database_1=__importDefault(require('../config/database'));function a13_0xa8d3(){const _0x44db8a=['webhookService','PENDING','testGatewayService','toLowerCase','gatewayOrderId','payment','replace','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','__importStar','parse','getPaymentForm','âœ…\x20Test\x20Gateway\x20payment\x20','currency',',\x20cannot\x20process','Payment\x20processed\x20successfully','stringify','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20status\x20is\x20','4242\x204242\x204242\x204242','Payment\x20not\x20found','3oMrEXW','paid','FAILED','default','createdAt','orderId','556682PbiflL','TestGatewayService','now','0000','hasOwnProperty','1567498EXafco','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','failureMessage','webhookEvents','../services/webhookService','Webhook\x20event\x20','__setModuleDefault','ms)','921148DeABym','findUnique','Any\x20future\x20date\x20(MM/YY)','webhookUrl','__createBinding','params','shopId','Payment\x20to\x20','name','customerEmail','PAID','toISOString','isArray','writable','resolve','error','payment.failed','paidAt','1010562lQrhIT','update','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','settings','3536770SjbRaz','transactionId','cardLast4','\x20with\x20status\x20','payment.success','Payment\x20failed','json','create','test_card','test_gateway_','processCard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ðŸ§ª\x20Test\x20Gateway\x20result:','\x20processed:\x20','defineProperty','shop','40XegcEy','gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','failureReason','test_gateway','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Error\x20parsing\x20webhook\x20events:','399840zwKzzG','then','160767lRZHUb','6BwMfgT','cardNumber','__esModule','processCardPayment','__importDefault','status','includes','getOwnPropertyNames','Any\x20name','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','length','../services/telegramBotService','log','TestGatewayController','failed','Test\x20Gateway\x20webhook\x20sent\x20to\x20','configurable','application/json'];a13_0xa8d3=function(){return _0x44db8a;};return a13_0xa8d3();}class TestGatewayController{constructor(){const _0x3629f3=a13_0xe4ec7e;this[_0x3629f3(0x217)]=async(_0x301fda,_0x3c6cc,_0x5347b2)=>{const _0x3837ac=_0x3629f3;try{const {paymentId:_0x576723}=_0x301fda['params'];console[_0x3837ac(0x207)](_0x3837ac(0x21d)+_0x576723);const _0x5c308b=await database_1[_0x3837ac(0x224)]['payment'][_0x3837ac(0x235)]({'where':{'id':_0x576723},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5c308b)return _0x3c6cc[_0x3837ac(0x200)](0x194)[_0x3837ac(0x251)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5c308b[_0x3837ac(0x1f2)]!==_0x3837ac(0x1f5))return _0x3c6cc[_0x3837ac(0x200)](0x190)[_0x3837ac(0x251)]({'success':![],'message':_0x3837ac(0x1f3)});if(_0x5c308b[_0x3837ac(0x200)]!==_0x3837ac(0x20e))return _0x3c6cc[_0x3837ac(0x200)](0x190)[_0x3837ac(0x251)]({'success':![],'message':_0x3837ac(0x21e)+_0x5c308b[_0x3837ac(0x200)]+_0x3837ac(0x21a)});_0x3c6cc[_0x3837ac(0x251)]({'success':!![],'result':{'paymentId':_0x5c308b['id'],'orderId':_0x5c308b['gatewayOrderId'],'amount':_0x5c308b['amount'],'currency':_0x5c308b[_0x3837ac(0x219)],'merchantName':_0x5c308b['shop'][_0x3837ac(0x23c)],'description':_0x3837ac(0x23b)+_0x5c308b[_0x3837ac(0x1f0)][_0x3837ac(0x23c)],'testInstructions':{'successCard':_0x3837ac(0x21f),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x3837ac(0x236),'cvc':'Any\x203-4\x20digits','holderName':_0x3837ac(0x203)}}});}catch(_0x448d09){_0x5347b2(_0x448d09);}},this[_0x3629f3(0x255)]=async(_0x1a30f1,_0x435c0a,_0x3d0760)=>{const _0x872d07=_0x3629f3;try{const {paymentId:_0x548273}=_0x1a30f1[_0x872d07(0x239)],_0x23afb8=_0x1a30f1['body'];console[_0x872d07(0x207)](_0x872d07(0x204)+_0x548273);const _0x483a23=await database_1[_0x872d07(0x224)][_0x872d07(0x212)][_0x872d07(0x235)]({'where':{'id':_0x548273},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x483a23)return _0x435c0a[_0x872d07(0x200)](0x194)[_0x872d07(0x251)]({'success':![],'message':_0x872d07(0x220)});if(_0x483a23[_0x872d07(0x1f2)]!=='test_gateway')return _0x435c0a[_0x872d07(0x200)](0x190)['json']({'success':![],'message':_0x872d07(0x1f3)});if(_0x483a23['status']!=='PENDING')return _0x435c0a[_0x872d07(0x200)](0x190)[_0x872d07(0x251)]({'success':![],'message':_0x872d07(0x21e)+_0x483a23[_0x872d07(0x200)]+_0x872d07(0x21a)});const _0xf128ad=await this['testGatewayService'][_0x872d07(0x1fe)]({'paymentId':_0x483a23['id'],'orderId':_0x483a23[_0x872d07(0x211)]||_0x483a23['id'],'amount':_0x483a23['amount'],'currency':_0x483a23['currency'],'cardData':_0x23afb8});console[_0x872d07(0x207)](_0x872d07(0x257),_0xf128ad);const _0x5817ff={'status':_0xf128ad[_0x872d07(0x200)],'updatedAt':new Date()};if(_0xf128ad[_0x872d07(0x200)]===_0x872d07(0x23e))_0x5817ff[_0x872d07(0x245)]=new Date(),_0x5817ff['gatewayPaymentId']=_0xf128ad[_0x872d07(0x24c)];else _0xf128ad[_0x872d07(0x200)]===_0x872d07(0x223)&&(_0x5817ff[_0x872d07(0x22e)]=_0xf128ad[_0x872d07(0x1f4)]);const _0x470eac=_0x23afb8[_0x872d07(0x1fc)][_0x872d07(0x213)](/[\s-]/g,'');_0x5817ff[_0x872d07(0x24d)]=_0x470eac['slice'](-0x4),_0x5817ff['paymentMethod']=_0x872d07(0x253),await database_1[_0x872d07(0x224)][_0x872d07(0x212)][_0x872d07(0x247)]({'where':{'id':_0x483a23['id']},'data':_0x5817ff}),await database_1[_0x872d07(0x224)]['webhookLog'][_0x872d07(0x252)]({'data':{'paymentId':_0x483a23['id'],'shopId':_0x483a23[_0x872d07(0x23a)],'event':_0x872d07(0x254)+_0xf128ad['status'][_0x872d07(0x210)](),'statusCode':0xc8,'responseBody':JSON[_0x872d07(0x21c)]({'oldStatus':_0x872d07(0x20e),'newStatus':_0xf128ad[_0x872d07(0x200)],'transactionId':_0xf128ad[_0x872d07(0x24c)],'failureReason':_0xf128ad['failureReason'],'processedAt':new Date()[_0x872d07(0x23f)]()})}}),await this['sendShopWebhook'](_0x483a23,_0xf128ad[_0x872d07(0x200)],_0xf128ad['transactionId'],_0xf128ad[_0x872d07(0x1f4)]),await this['sendPaymentStatusNotification'](_0x483a23,_0xf128ad[_0x872d07(0x200)]),console['log'](_0x872d07(0x218)+_0x548273+_0x872d07(0x258)+_0xf128ad[_0x872d07(0x200)]),_0xf128ad['status']===_0x872d07(0x23e)?_0x435c0a[_0x872d07(0x251)]({'success':!![],'message':_0x872d07(0x21b),'result':{'status':_0x872d07(0x23e),'transactionId':_0xf128ad['transactionId'],'redirectUrl':_0x483a23['successUrl']}}):_0x435c0a['status'](0x190)[_0x872d07(0x251)]({'success':![],'message':_0x872d07(0x250),'result':{'status':_0x872d07(0x223),'failureReason':_0xf128ad['failureReason'],'redirectUrl':_0x483a23['failUrl']}});}catch(_0x450159){_0x3d0760(_0x450159);}},this[_0x3629f3(0x20f)]=new testGatewayService_1[(_0x3629f3(0x228))](),this[_0x3629f3(0x20d)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x1baee8,_0xe2cbd9,_0x646b2a,_0x46adee){const _0x39753d=a13_0xe4ec7e,_0x3236c2=Date[_0x39753d(0x229)]();try{const _0x2f7f6b=_0x1baee8[_0x39753d(0x1f0)],_0x1079a5=_0x2f7f6b[_0x39753d(0x24a)];if(!_0x1079a5?.[_0x39753d(0x237)]){console[_0x39753d(0x207)](_0x39753d(0x256)+_0x2f7f6b['id']);return;}const _0x1c0fee=_0xe2cbd9===_0x39753d(0x23e)?_0x39753d(0x24f):_0x39753d(0x244);let _0x12fa8d=[];if(_0x1079a5[_0x39753d(0x22f)])try{_0x12fa8d=Array[_0x39753d(0x240)](_0x1079a5[_0x39753d(0x22f)])?_0x1079a5[_0x39753d(0x22f)]:JSON[_0x39753d(0x216)](_0x1079a5[_0x39753d(0x22f)]);}catch(_0x48e38f){console['error'](_0x39753d(0x1f7),_0x48e38f),_0x12fa8d=[];}if(!_0x12fa8d[_0x39753d(0x201)](_0x1c0fee)){console[_0x39753d(0x207)](_0x39753d(0x231)+_0x1c0fee+_0x39753d(0x249)+_0x2f7f6b['id']);return;}const _0x4e94f1={'event':_0x1c0fee,'payment':{'id':_0x1baee8['id'],'order_id':_0x1baee8[_0x39753d(0x226)],'gateway_order_id':_0x1baee8[_0x39753d(0x211)],'gateway':_0x39753d(0x22a),'amount':_0x1baee8['amount'],'currency':_0x1baee8[_0x39753d(0x219)],'status':_0xe2cbd9[_0x39753d(0x210)](),'customer_email':_0x1baee8[_0x39753d(0x23d)],'customer_name':_0x1baee8['customerName'],'transaction_id':_0x646b2a,'failure_message':_0x46adee,'created_at':_0x1baee8[_0x39753d(0x225)],'updated_at':new Date()}},_0x3077ff=await fetch(_0x1079a5[_0x39753d(0x237)],{'method':'POST','headers':{'Content-Type':_0x39753d(0x20c),'User-Agent':_0x39753d(0x22d)},'body':JSON[_0x39753d(0x21c)](_0x4e94f1)}),_0x2079ee=Date[_0x39753d(0x229)]()-_0x3236c2;console['log'](_0x39753d(0x20a)+_0x1079a5[_0x39753d(0x237)]+_0x39753d(0x24e)+_0x3077ff[_0x39753d(0x200)]+'\x20('+_0x2079ee+_0x39753d(0x233));}catch(_0x2c6d54){console[_0x39753d(0x243)](_0x39753d(0x214),_0x2c6d54);}}async['sendPaymentStatusNotification'](_0x539087,_0x54272a){const _0x217478=a13_0xe4ec7e;try{const {telegramBotService:_0x2eb9d2}=await Promise[_0x217478(0x242)]()[_0x217478(0x1f9)](()=>__importStar(require(_0x217478(0x206)))),_0x37e103={'PAID':_0x217478(0x222),'FAILED':_0x217478(0x209)},_0x2ebb1e=_0x37e103[_0x54272a];if(!_0x2ebb1e)return;await _0x2eb9d2[_0x217478(0x248)](_0x539087[_0x217478(0x23a)],_0x539087,_0x2ebb1e);}catch(_0x434b2a){console['error'](_0x217478(0x1f6),_0x434b2a);}}}exports[a13_0xe4ec7e(0x208)]=TestGatewayController;