'use strict';const a19_0x13f55a=a19_0x5d5d;function a19_0x1383(){const _0xca709b=['cardLast4','name','payment.success','13264299cttQhI','params','failUrl','../services/gateways/testGatewayService','üß™\x20Test\x20Gateway\x20result:','\x20->\x20','Error\x20parsing\x20webhook\x20events:','285544DbUIiM','cardNumber','failed','TestGatewayController','includes','8nOdyai','4242\x204242\x204242\x204242','Payment\x20to\x20','amount','replace','Payment\x20failed','\x20not\x20enabled\x20for\x20shop\x20',',\x20currentPayments=','status','body','gateway','1344140VufZrs','48cusTNF','log','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20processed:\x20',':\x20type=','SINGLE','Any\x20future\x20date\x20(MM/YY)','WebhookService','‚úÖ\x20Test\x20Gateway\x20payment\x20','settings','paymentMethod','Any\x20name','findUnique','TestGatewayService','toLowerCase','prototype','currency','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/telegramBotService','testGatewayService','sendPaymentStatusNotification','Payment\x20not\x20found','ms)','customerName','paymentLink','defineProperty','FAILED','createdAt','2822732NiwwEg','customerEmail','toISOString','\x20not\x20found','webhookEvents','transactionId','paymentLinkId','test_gateway','gatewayPaymentId','orderId','now','type','‚ùå\x20Payment\x20link\x20','__esModule','getOwnPropertyNames','Payment\x20status\x20is\x20','4444611iFsqsa','slice','currentPayments','error','../services/webhookService','paid','call',',\x20status=','default','__setModuleDefault','writable','webhookUrl','processCard','Payment\x20is\x20not\x20for\x20test\x20gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','90194kMttFW','PENDING','gatewayOrderId','payment','isArray','PAID','Any\x203-4\x20digits','create','0000',',\x20cannot\x20process','test_card','processCardPayment','2HHyVXd','__createBinding','__importDefault','webhookLog','paidAt','üìà\x20Found\x20payment\x20link\x20','application/json','failureMessage','getOwnPropertyDescriptor','json','Webhook\x20event\x20','\x20updated:\x20currentPayments=','shop','\x20with\x20status\x20','‚úÖ\x20Payment\x20link\x20','failureReason','get','42794360GyrNlR','shopId','COMPLETED','update','test_gateway_','stringify','$transaction'];a19_0x1383=function(){return _0xca709b;};return a19_0x1383();}(function(_0x586438,_0x688946){const _0x4cb0ce=a19_0x5d5d,_0x5b0d28=_0x586438();while(!![]){try{const _0x33fc60=parseInt(_0x4cb0ce(0xa5))/0x1+-parseInt(_0x4cb0ce(0xb1))/0x2*(parseInt(_0x4cb0ce(0x95))/0x3)+-parseInt(_0x4cb0ce(0x85))/0x4+-parseInt(_0x4cb0ce(0xe3))/0x5+parseInt(_0x4cb0ce(0xe4))/0x6*(parseInt(_0x4cb0ce(0xd3))/0x7)+parseInt(_0x4cb0ce(0xd8))/0x8*(-parseInt(_0x4cb0ce(0xcc))/0x9)+parseInt(_0x4cb0ce(0xc2))/0xa;if(_0x33fc60===_0x688946)break;else _0x5b0d28['push'](_0x5b0d28['shift']());}catch(_0x189837){_0x5b0d28['push'](_0x5b0d28['shift']());}}}(a19_0x1383,0xbb09b));var __createBinding=this&&this[a19_0x13f55a(0xb2)]||(Object['create']?function(_0x2d9517,_0x58305e,_0x77d18a,_0x240658){const _0x4f897f=a19_0x13f55a;if(_0x240658===undefined)_0x240658=_0x77d18a;var _0x834aa5=Object[_0x4f897f(0xb9)](_0x58305e,_0x77d18a);(!_0x834aa5||(_0x4f897f(0xc1)in _0x834aa5?!_0x58305e[_0x4f897f(0x92)]:_0x834aa5[_0x4f897f(0x9f)]||_0x834aa5['configurable']))&&(_0x834aa5={'enumerable':!![],'get':function(){return _0x58305e[_0x77d18a];}}),Object[_0x4f897f(0x82)](_0x2d9517,_0x240658,_0x834aa5);}:function(_0x34f280,_0x2115e9,_0xa3d913,_0x93b1e5){if(_0x93b1e5===undefined)_0x93b1e5=_0xa3d913;_0x34f280[_0x93b1e5]=_0x2115e9[_0xa3d913];}),__setModuleDefault=this&&this[a19_0x13f55a(0x9e)]||(Object[a19_0x13f55a(0xac)]?function(_0x36146c,_0x398641){const _0xb51fe0=a19_0x13f55a;Object[_0xb51fe0(0x82)](_0x36146c,'default',{'enumerable':!![],'value':_0x398641});}:function(_0x5f2d22,_0x4ee3e6){const _0x80f19=a19_0x13f55a;_0x5f2d22[_0x80f19(0x9d)]=_0x4ee3e6;}),__importStar=this&&this['__importStar']||(function(){var _0x34dd85=function(_0x31328d){const _0x3c2169=a19_0x5d5d;return _0x34dd85=Object[_0x3c2169(0x93)]||function(_0x166668){const _0xfbf59f=_0x3c2169;var _0x1b056b=[];for(var _0x17cd45 in _0x166668)if(Object[_0xfbf59f(0x78)]['hasOwnProperty'][_0xfbf59f(0x9b)](_0x166668,_0x17cd45))_0x1b056b[_0x1b056b['length']]=_0x17cd45;return _0x1b056b;},_0x34dd85(_0x31328d);};return function(_0x5a3b81){const _0x3b2b59=a19_0x5d5d;if(_0x5a3b81&&_0x5a3b81[_0x3b2b59(0x92)])return _0x5a3b81;var _0x14181a={};if(_0x5a3b81!=null){for(var _0x29ba3d=_0x34dd85(_0x5a3b81),_0x61ab87=0x0;_0x61ab87<_0x29ba3d['length'];_0x61ab87++)if(_0x29ba3d[_0x61ab87]!==_0x3b2b59(0x9d))__createBinding(_0x14181a,_0x5a3b81,_0x29ba3d[_0x61ab87]);}return __setModuleDefault(_0x14181a,_0x5a3b81),_0x14181a;};}()),__importDefault=this&&this[a19_0x13f55a(0xb3)]||function(_0x2ef7c8){return _0x2ef7c8&&_0x2ef7c8['__esModule']?_0x2ef7c8:{'default':_0x2ef7c8};};Object[a19_0x13f55a(0x82)](exports,a19_0x13f55a(0x92),{'value':!![]}),exports[a19_0x13f55a(0xd6)]=void 0x0;const testGatewayService_1=require(a19_0x13f55a(0xcf)),webhookService_1=require(a19_0x13f55a(0x99)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1376f3=a19_0x13f55a;this['getPaymentForm']=async(_0x10f050,_0x209e26,_0x44f749)=>{const _0x9365bd=a19_0x5d5d;try{const {paymentId:_0x4e7194}=_0x10f050['params'];console[_0x9365bd(0x6a)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4e7194);const _0x5779d3=await database_1[_0x9365bd(0x9d)][_0x9365bd(0xa8)][_0x9365bd(0x75)]({'where':{'id':_0x4e7194},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5779d3)return _0x209e26['status'](0x194)[_0x9365bd(0xba)]({'success':![],'message':_0x9365bd(0x7e)});if(_0x5779d3['gateway']!==_0x9365bd(0x8c))return _0x209e26[_0x9365bd(0xe0)](0x190)[_0x9365bd(0xba)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x5779d3[_0x9365bd(0xe0)]!=='PENDING')return _0x209e26[_0x9365bd(0xe0)](0x190)[_0x9365bd(0xba)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5779d3[_0x9365bd(0xe0)]+_0x9365bd(0xae)});_0x209e26[_0x9365bd(0xba)]({'success':!![],'result':{'paymentId':_0x5779d3['id'],'orderId':_0x5779d3['gatewayOrderId'],'amount':_0x5779d3['amount'],'currency':_0x5779d3['currency'],'merchantName':_0x5779d3[_0x9365bd(0xbd)][_0x9365bd(0xca)],'description':_0x9365bd(0xda)+_0x5779d3['shop'][_0x9365bd(0xca)],'testInstructions':{'successCard':_0x9365bd(0xd9),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x9365bd(0x6f),'cvc':_0x9365bd(0xab),'holderName':_0x9365bd(0x74)}}});}catch(_0x1bee74){_0x44f749(_0x1bee74);}},this[_0x1376f3(0xa1)]=async(_0xdcd21e,_0x3c515d,_0x2f6a94)=>{const _0x31a96c=_0x1376f3;try{const {paymentId:_0x4bf015}=_0xdcd21e[_0x31a96c(0xcd)],_0x5e49d0=_0xdcd21e[_0x31a96c(0xe1)];console[_0x31a96c(0x6a)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4bf015);const _0xd1029e=await database_1[_0x31a96c(0x9d)][_0x31a96c(0xa8)][_0x31a96c(0x75)]({'where':{'id':_0x4bf015},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xd1029e)return _0x3c515d['status'](0x194)[_0x31a96c(0xba)]({'success':![],'message':_0x31a96c(0x7e)});if(_0xd1029e[_0x31a96c(0xe2)]!==_0x31a96c(0x8c))return _0x3c515d['status'](0x190)['json']({'success':![],'message':_0x31a96c(0xa2)});if(_0xd1029e['status']!==_0x31a96c(0xa6))return _0x3c515d[_0x31a96c(0xe0)](0x190)[_0x31a96c(0xba)]({'success':![],'message':_0x31a96c(0x94)+_0xd1029e[_0x31a96c(0xe0)]+',\x20cannot\x20process'});const _0x4a20fd=await this[_0x31a96c(0x7c)][_0x31a96c(0xb0)]({'paymentId':_0xd1029e['id'],'orderId':_0xd1029e[_0x31a96c(0xa7)]||_0xd1029e['id'],'amount':_0xd1029e[_0x31a96c(0xdb)],'currency':_0xd1029e[_0x31a96c(0x79)],'cardData':_0x5e49d0});console['log'](_0x31a96c(0xd0),_0x4a20fd);const _0x4a89b7={'status':_0x4a20fd['status'],'updatedAt':new Date()};if(_0x4a20fd['status']===_0x31a96c(0xaa))_0x4a89b7[_0x31a96c(0xb5)]=new Date(),_0x4a89b7[_0x31a96c(0x8d)]=_0x4a20fd[_0x31a96c(0x8a)];else _0x4a20fd['status']===_0x31a96c(0x83)&&(_0x4a89b7[_0x31a96c(0xb8)]=_0x4a20fd[_0x31a96c(0xc0)]);const _0x579a4c=_0x5e49d0[_0x31a96c(0xd4)][_0x31a96c(0xdc)](/[\s-]/g,'');_0x4a89b7[_0x31a96c(0xc9)]=_0x579a4c[_0x31a96c(0x96)](-0x4),_0x4a89b7[_0x31a96c(0x73)]=_0x31a96c(0xaf),await database_1[_0x31a96c(0x9d)][_0x31a96c(0xa8)][_0x31a96c(0xc5)]({'where':{'id':_0xd1029e['id']},'data':_0x4a89b7});if(_0x4a20fd[_0x31a96c(0xe0)]==='PAID'&&_0xd1029e[_0x31a96c(0x8b)]){console[_0x31a96c(0x6a)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0xd1029e['id']+_0x31a96c(0xa4));try{await database_1[_0x31a96c(0x9d)][_0x31a96c(0xc8)](async _0x2f416a=>{const _0x47ccde=_0x31a96c,_0x410025=await _0x2f416a[_0x47ccde(0x81)][_0x47ccde(0x75)]({'where':{'id':_0xd1029e['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x410025){console['log'](_0x47ccde(0xb6)+_0x410025['id']+_0x47ccde(0x6d)+_0x410025[_0x47ccde(0x90)]+_0x47ccde(0xdf)+_0x410025[_0x47ccde(0x97)]+_0x47ccde(0x9c)+_0x410025[_0x47ccde(0xe0)]);const _0xade55f=_0x410025[_0x47ccde(0x97)]+0x1,_0x59316e=_0x410025[_0x47ccde(0x90)]===_0x47ccde(0x6e)?_0x47ccde(0xc4):_0x410025[_0x47ccde(0xe0)];await _0x2f416a['paymentLink']['update']({'where':{'id':_0xd1029e['paymentLinkId']},'data':{'currentPayments':_0xade55f,'status':_0x59316e,'updatedAt':new Date()}}),console[_0x47ccde(0x6a)](_0x47ccde(0xbf)+_0x410025['id']+_0x47ccde(0xbc)+_0x410025[_0x47ccde(0x97)]+'\x20->\x20'+_0xade55f+_0x47ccde(0x9c)+_0x410025[_0x47ccde(0xe0)]+_0x47ccde(0xd1)+_0x59316e);}else console[_0x47ccde(0x6a)](_0x47ccde(0x91)+_0xd1029e[_0x47ccde(0x8b)]+_0x47ccde(0x88));});}catch(_0x2f1285){console['error'](_0x31a96c(0x6b),_0x2f1285);}}await database_1[_0x31a96c(0x9d)][_0x31a96c(0xb4)]['create']({'data':{'paymentId':_0xd1029e['id'],'shopId':_0xd1029e[_0x31a96c(0xc3)],'event':_0x31a96c(0xc6)+_0x4a20fd[_0x31a96c(0xe0)][_0x31a96c(0x77)](),'statusCode':0xc8,'responseBody':JSON[_0x31a96c(0xc7)]({'oldStatus':_0x31a96c(0xa6),'newStatus':_0x4a20fd[_0x31a96c(0xe0)],'transactionId':_0x4a20fd[_0x31a96c(0x8a)],'failureReason':_0x4a20fd[_0x31a96c(0xc0)],'processedAt':new Date()[_0x31a96c(0x87)]()})}}),await this['sendShopWebhook'](_0xd1029e,_0x4a20fd[_0x31a96c(0xe0)],_0x4a20fd['transactionId'],_0x4a20fd[_0x31a96c(0xc0)]),await this[_0x31a96c(0x7d)](_0xd1029e,_0x4a20fd[_0x31a96c(0xe0)]),console[_0x31a96c(0x6a)](_0x31a96c(0x71)+_0x4bf015+_0x31a96c(0x6c)+_0x4a20fd[_0x31a96c(0xe0)]),_0x4a20fd[_0x31a96c(0xe0)]===_0x31a96c(0xaa)?_0x3c515d[_0x31a96c(0xba)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x31a96c(0xaa),'transactionId':_0x4a20fd[_0x31a96c(0x8a)],'redirectUrl':_0xd1029e['successUrl']}}):_0x3c515d[_0x31a96c(0xe0)](0x190)['json']({'success':![],'message':_0x31a96c(0xdd),'result':{'status':_0x31a96c(0x83),'failureReason':_0x4a20fd['failureReason'],'redirectUrl':_0xd1029e[_0x31a96c(0xce)]}});}catch(_0x1a54a8){_0x2f6a94(_0x1a54a8);}},this[_0x1376f3(0x7c)]=new testGatewayService_1[(_0x1376f3(0x76))](),this['webhookService']=new webhookService_1[(_0x1376f3(0x70))]();}async['sendShopWebhook'](_0x5bda91,_0x43e3c7,_0x4676e,_0x3c4e4f){const _0x5f0a0b=a19_0x13f55a,_0x44b639=Date[_0x5f0a0b(0x8f)]();try{const _0x1ca541=_0x5bda91['shop'],_0x56cd6c=_0x1ca541[_0x5f0a0b(0x72)];if(!_0x56cd6c?.[_0x5f0a0b(0xa0)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1ca541['id']);return;}const _0x386c22=_0x43e3c7===_0x5f0a0b(0xaa)?_0x5f0a0b(0xcb):'payment.failed';let _0x45af10=[];if(_0x56cd6c[_0x5f0a0b(0x89)])try{_0x45af10=Array[_0x5f0a0b(0xa9)](_0x56cd6c[_0x5f0a0b(0x89)])?_0x56cd6c[_0x5f0a0b(0x89)]:JSON['parse'](_0x56cd6c['webhookEvents']);}catch(_0x5548a5){console[_0x5f0a0b(0x98)](_0x5f0a0b(0xd2),_0x5548a5),_0x45af10=[];}if(!_0x45af10[_0x5f0a0b(0xd7)](_0x386c22)){console['log'](_0x5f0a0b(0xbb)+_0x386c22+_0x5f0a0b(0xde)+_0x1ca541['id']);return;}const _0x299d6c={'event':_0x386c22,'payment':{'id':_0x5bda91['id'],'order_id':_0x5bda91[_0x5f0a0b(0x8e)],'gateway_order_id':_0x5bda91[_0x5f0a0b(0xa7)],'gateway':_0x5f0a0b(0xad),'amount':_0x5bda91['amount'],'currency':_0x5bda91[_0x5f0a0b(0x79)],'status':_0x43e3c7[_0x5f0a0b(0x77)](),'customer_email':_0x5bda91[_0x5f0a0b(0x86)],'customer_name':_0x5bda91[_0x5f0a0b(0x80)],'transaction_id':_0x4676e,'failure_message':_0x3c4e4f,'created_at':_0x5bda91[_0x5f0a0b(0x84)],'updated_at':new Date()}},_0x4d5baf=await fetch(_0x56cd6c[_0x5f0a0b(0xa0)],{'method':'POST','headers':{'Content-Type':_0x5f0a0b(0xb7),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x5f0a0b(0xc7)](_0x299d6c)}),_0x31527f=Date[_0x5f0a0b(0x8f)]()-_0x44b639;console[_0x5f0a0b(0x6a)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x56cd6c[_0x5f0a0b(0xa0)]+_0x5f0a0b(0xbe)+_0x4d5baf[_0x5f0a0b(0xe0)]+'\x20('+_0x31527f+_0x5f0a0b(0x7f));}catch(_0x180103){console[_0x5f0a0b(0x98)](_0x5f0a0b(0xa3),_0x180103);}}async[a19_0x13f55a(0x7d)](_0x5e1336,_0x27abcb){const _0x3390c7=a19_0x13f55a;try{const {telegramBotService:_0x572c22}=await Promise['resolve']()['then'](()=>__importStar(require(_0x3390c7(0x7b)))),_0x5e24a7={'PAID':_0x3390c7(0x9a),'FAILED':_0x3390c7(0xd5)},_0x3beb60=_0x5e24a7[_0x27abcb];if(!_0x3beb60)return;await _0x572c22['sendPaymentNotification'](_0x5e1336[_0x3390c7(0xc3)],_0x5e1336,_0x3beb60);}catch(_0x4e5d82){console['error'](_0x3390c7(0x7a),_0x4e5d82);}}}function a19_0x5d5d(_0x79cbcf,_0x394af3){_0x79cbcf=_0x79cbcf-0x6a;const _0x1383da=a19_0x1383();let _0x5d5dee=_0x1383da[_0x79cbcf];return _0x5d5dee;}exports[a19_0x13f55a(0xd6)]=TestGatewayController;