'use strict';const a13_0x4d89ea=a13_0x325d;(function(_0x5254d0,_0x5519e7){const _0x8d48de=a13_0x325d,_0x225c1a=_0x5254d0();while(!![]){try{const _0x591349=parseInt(_0x8d48de(0x211))/0x1*(-parseInt(_0x8d48de(0x261))/0x2)+-parseInt(_0x8d48de(0x25e))/0x3+-parseInt(_0x8d48de(0x235))/0x4+parseInt(_0x8d48de(0x20d))/0x5*(parseInt(_0x8d48de(0x1fb))/0x6)+parseInt(_0x8d48de(0x241))/0x7*(-parseInt(_0x8d48de(0x221))/0x8)+parseInt(_0x8d48de(0x204))/0x9*(-parseInt(_0x8d48de(0x201))/0xa)+parseInt(_0x8d48de(0x203))/0xb*(parseInt(_0x8d48de(0x220))/0xc);if(_0x591349===_0x5519e7)break;else _0x225c1a['push'](_0x225c1a['shift']());}catch(_0x46713f){_0x225c1a['push'](_0x225c1a['shift']());}}}(a13_0x1c7f,0x6ae7f));var __createBinding=this&&this[a13_0x4d89ea(0x24c)]||(Object[a13_0x4d89ea(0x21a)]?function(_0x42d4a9,_0x1c92fc,_0x1eb8a9,_0x1886be){const _0x1c5fed=a13_0x4d89ea;if(_0x1886be===undefined)_0x1886be=_0x1eb8a9;var _0x5a2894=Object[_0x1c5fed(0x232)](_0x1c92fc,_0x1eb8a9);(!_0x5a2894||('get'in _0x5a2894?!_0x1c92fc[_0x1c5fed(0x1f7)]:_0x5a2894[_0x1c5fed(0x22e)]||_0x5a2894[_0x1c5fed(0x23c)]))&&(_0x5a2894={'enumerable':!![],'get':function(){return _0x1c92fc[_0x1eb8a9];}}),Object[_0x1c5fed(0x260)](_0x42d4a9,_0x1886be,_0x5a2894);}:function(_0x21d543,_0x3a1665,_0x22e28a,_0x1ea45e){if(_0x1ea45e===undefined)_0x1ea45e=_0x22e28a;_0x21d543[_0x1ea45e]=_0x3a1665[_0x22e28a];}),__setModuleDefault=this&&this[a13_0x4d89ea(0x20e)]||(Object[a13_0x4d89ea(0x21a)]?function(_0x11083c,_0x417734){const _0x2ecfbb=a13_0x4d89ea;Object[_0x2ecfbb(0x260)](_0x11083c,_0x2ecfbb(0x23a),{'enumerable':!![],'value':_0x417734});}:function(_0x2c7453,_0x224522){const _0x22b22f=a13_0x4d89ea;_0x2c7453[_0x22b22f(0x23a)]=_0x224522;}),__importStar=this&&this[a13_0x4d89ea(0x229)]||(function(){var _0x51a70e=function(_0x1c2fd4){const _0x1302b3=a13_0x325d;return _0x51a70e=Object[_0x1302b3(0x23f)]||function(_0x401382){const _0x1520e1=_0x1302b3;var _0x6fd83b=[];for(var _0x3396f1 in _0x401382)if(Object[_0x1520e1(0x244)][_0x1520e1(0x1fc)][_0x1520e1(0x255)](_0x401382,_0x3396f1))_0x6fd83b[_0x6fd83b[_0x1520e1(0x252)]]=_0x3396f1;return _0x6fd83b;},_0x51a70e(_0x1c2fd4);};return function(_0x2d9975){const _0x12f99c=a13_0x325d;if(_0x2d9975&&_0x2d9975['__esModule'])return _0x2d9975;var _0x36675e={};if(_0x2d9975!=null){for(var _0x279a67=_0x51a70e(_0x2d9975),_0x22b2d2=0x0;_0x22b2d2<_0x279a67[_0x12f99c(0x252)];_0x22b2d2++)if(_0x279a67[_0x22b2d2]!=='default')__createBinding(_0x36675e,_0x2d9975,_0x279a67[_0x22b2d2]);}return __setModuleDefault(_0x36675e,_0x2d9975),_0x36675e;};}()),__importDefault=this&&this[a13_0x4d89ea(0x23e)]||function(_0x48eab5){const _0x518eb8=a13_0x4d89ea;return _0x48eab5&&_0x48eab5[_0x518eb8(0x1f7)]?_0x48eab5:{'default':_0x48eab5};};function a13_0x1c7f(){const _0xc8b992=['🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20status\x20is\x20','1203092TgHqoj','📈\x20Found\x20payment\x20link\x20','failureMessage','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','amount','default','sendShopWebhook','configurable','TestGatewayController','__importDefault','getOwnPropertyNames','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','507087MOwWur','Payment\x20is\x20not\x20for\x20test\x20gateway',',\x20status=','prototype','transactionId','successUrl','webhookEvents','failed','\x20with\x20status\x20','gateway','processCard','__createBinding','TestGatewayService','type',':\x20type=','includes','\x20updated:\x20currentPayments=','length','paymentLinkId','🧪\x20Test\x20Gateway\x20result:','call','params','currency','payment.failed',',\x20currentPayments=',',\x20cannot\x20process','customerName','status','error','1755063pbAEIl','Payment\x20not\x20found','defineProperty','22VOyTeK','test_card','FAILED','update','paymentLink','shop','PAID','Webhook\x20event\x20','now','Any\x203-4\x20digits','toISOString','failureReason','ms)','\x20->\x20','name','sendPaymentStatusNotification','__esModule','../services/webhookService','Error\x20parsing\x20webhook\x20events:','\x20processed:\x20','1392LXxOWA','hasOwnProperty','log','json','PENDING','toLowerCase','3610hoqYsr','webhookService','9091874lVOZOe','14166nhflSy','0000','findUnique','test_gateway','gatewayPaymentId','customerEmail','❌\x20Payment\x20link\x20','paid','settings','9770DAsPkM','__setModuleDefault','Payment\x20processed\x20successfully','shopId','6329stAzIf','../services/gateways/testGatewayService','currentPayments','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','test_gateway_','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paidAt','Payment\x20failed','Payment\x20to\x20','create','Any\x20name','processCardPayment','../config/database','\x20not\x20enabled\x20for\x20shop\x20','then','24SQXVRL','16omjCKs','body','createdAt','WebhookService','✅\x20Payment\x20link\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentMethod','failUrl','__importStar','slice','✅\x20Test\x20Gateway\x20payment\x20','gatewayOrderId','4242\x204242\x204242\x204242','writable','SINGLE','webhookUrl','parse','getOwnPropertyDescriptor'];a13_0x1c7f=function(){return _0xc8b992;};return a13_0x1c7f();}Object[a13_0x4d89ea(0x260)](exports,a13_0x4d89ea(0x1f7),{'value':!![]}),exports[a13_0x4d89ea(0x23d)]=void 0x0;function a13_0x325d(_0x851a2b,_0x1b5fcd){const _0x1c7faf=a13_0x1c7f();return a13_0x325d=function(_0x325d87,_0x4ed072){_0x325d87=_0x325d87-0x1eb;let _0x5594c9=_0x1c7faf[_0x325d87];return _0x5594c9;},a13_0x325d(_0x851a2b,_0x1b5fcd);}const testGatewayService_1=require(a13_0x4d89ea(0x212)),webhookService_1=require(a13_0x4d89ea(0x1f8)),database_1=__importDefault(require(a13_0x4d89ea(0x21d)));class TestGatewayController{constructor(){const _0x4dedc6=a13_0x4d89ea;this['getPaymentForm']=async(_0xc4535c,_0xccaa58,_0x5bea63)=>{const _0x5353e0=a13_0x325d;try{const {paymentId:_0x11617f}=_0xc4535c['params'];console[_0x5353e0(0x1fd)](_0x5353e0(0x214)+_0x11617f);const _0x1c239e=await database_1[_0x5353e0(0x23a)]['payment'][_0x5353e0(0x206)]({'where':{'id':_0x11617f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1c239e)return _0xccaa58[_0x5353e0(0x25c)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x1c239e['gateway']!==_0x5353e0(0x207))return _0xccaa58[_0x5353e0(0x25c)](0x190)['json']({'success':![],'message':_0x5353e0(0x242)});if(_0x1c239e[_0x5353e0(0x25c)]!==_0x5353e0(0x1ff))return _0xccaa58[_0x5353e0(0x25c)](0x190)[_0x5353e0(0x1fe)]({'success':![],'message':_0x5353e0(0x234)+_0x1c239e[_0x5353e0(0x25c)]+_0x5353e0(0x25a)});_0xccaa58[_0x5353e0(0x1fe)]({'success':!![],'result':{'paymentId':_0x1c239e['id'],'orderId':_0x1c239e['gatewayOrderId'],'amount':_0x1c239e[_0x5353e0(0x239)],'currency':_0x1c239e[_0x5353e0(0x257)],'merchantName':_0x1c239e[_0x5353e0(0x1ec)][_0x5353e0(0x1f5)],'description':_0x5353e0(0x219)+_0x1c239e[_0x5353e0(0x1ec)][_0x5353e0(0x1f5)],'testInstructions':{'successCard':_0x5353e0(0x22d),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x5353e0(0x1f0),'holderName':_0x5353e0(0x21b)}}});}catch(_0x6bd3c0){_0x5bea63(_0x6bd3c0);}},this[_0x4dedc6(0x24b)]=async(_0x478454,_0x39f188,_0x496da0)=>{const _0x9ba912=_0x4dedc6;try{const {paymentId:_0x29de36}=_0x478454[_0x9ba912(0x256)],_0x13f902=_0x478454[_0x9ba912(0x222)];console[_0x9ba912(0x1fd)](_0x9ba912(0x233)+_0x29de36);const _0x54d569=await database_1[_0x9ba912(0x23a)]['payment'][_0x9ba912(0x206)]({'where':{'id':_0x29de36},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x54d569)return _0x39f188[_0x9ba912(0x25c)](0x194)[_0x9ba912(0x1fe)]({'success':![],'message':_0x9ba912(0x25f)});if(_0x54d569[_0x9ba912(0x24a)]!==_0x9ba912(0x207))return _0x39f188['status'](0x190)[_0x9ba912(0x1fe)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x54d569[_0x9ba912(0x25c)]!=='PENDING')return _0x39f188[_0x9ba912(0x25c)](0x190)[_0x9ba912(0x1fe)]({'success':![],'message':_0x9ba912(0x234)+_0x54d569[_0x9ba912(0x25c)]+_0x9ba912(0x25a)});const _0x352e9f=await this['testGatewayService'][_0x9ba912(0x21c)]({'paymentId':_0x54d569['id'],'orderId':_0x54d569[_0x9ba912(0x22c)]||_0x54d569['id'],'amount':_0x54d569[_0x9ba912(0x239)],'currency':_0x54d569[_0x9ba912(0x257)],'cardData':_0x13f902});console['log'](_0x9ba912(0x254),_0x352e9f);const _0x285a67={'status':_0x352e9f['status'],'updatedAt':new Date()};if(_0x352e9f[_0x9ba912(0x25c)]===_0x9ba912(0x1ed))_0x285a67[_0x9ba912(0x217)]=new Date(),_0x285a67[_0x9ba912(0x208)]=_0x352e9f[_0x9ba912(0x245)];else _0x352e9f['status']===_0x9ba912(0x263)&&(_0x285a67[_0x9ba912(0x237)]=_0x352e9f['failureReason']);const _0x2e5c6f=_0x13f902['cardNumber']['replace'](/[\s-]/g,'');_0x285a67['cardLast4']=_0x2e5c6f[_0x9ba912(0x22a)](-0x4),_0x285a67[_0x9ba912(0x227)]=_0x9ba912(0x262),await database_1[_0x9ba912(0x23a)]['payment'][_0x9ba912(0x264)]({'where':{'id':_0x54d569['id']},'data':_0x285a67});if(_0x352e9f[_0x9ba912(0x25c)]===_0x9ba912(0x1ed)&&_0x54d569[_0x9ba912(0x253)]){console['log']('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x54d569['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x9ba912(0x23a)]['$transaction'](async _0x512797=>{const _0x9a4bea=_0x9ba912,_0x4014cd=await _0x512797[_0x9a4bea(0x1eb)][_0x9a4bea(0x206)]({'where':{'id':_0x54d569[_0x9a4bea(0x253)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4014cd){console[_0x9a4bea(0x1fd)](_0x9a4bea(0x236)+_0x4014cd['id']+_0x9a4bea(0x24f)+_0x4014cd[_0x9a4bea(0x24e)]+_0x9a4bea(0x259)+_0x4014cd[_0x9a4bea(0x213)]+_0x9a4bea(0x243)+_0x4014cd[_0x9a4bea(0x25c)]);const _0x4ac103=_0x4014cd[_0x9a4bea(0x213)]+0x1,_0x2bc379=_0x4014cd[_0x9a4bea(0x24e)]===_0x9a4bea(0x22f)?'COMPLETED':_0x4014cd[_0x9a4bea(0x25c)];await _0x512797[_0x9a4bea(0x1eb)][_0x9a4bea(0x264)]({'where':{'id':_0x54d569[_0x9a4bea(0x253)]},'data':{'currentPayments':_0x4ac103,'status':_0x2bc379,'updatedAt':new Date()}}),console[_0x9a4bea(0x1fd)](_0x9a4bea(0x225)+_0x4014cd['id']+_0x9a4bea(0x251)+_0x4014cd['currentPayments']+_0x9a4bea(0x1f4)+_0x4ac103+_0x9a4bea(0x243)+_0x4014cd[_0x9a4bea(0x25c)]+_0x9a4bea(0x1f4)+_0x2bc379);}else console[_0x9a4bea(0x1fd)](_0x9a4bea(0x20a)+_0x54d569[_0x9a4bea(0x253)]+'\x20not\x20found');});}catch(_0x127bf6){console[_0x9ba912(0x25d)]('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x127bf6);}}await database_1['default']['webhookLog'][_0x9ba912(0x21a)]({'data':{'paymentId':_0x54d569['id'],'shopId':_0x54d569[_0x9ba912(0x210)],'event':_0x9ba912(0x215)+_0x352e9f[_0x9ba912(0x25c)][_0x9ba912(0x200)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x352e9f[_0x9ba912(0x25c)],'transactionId':_0x352e9f['transactionId'],'failureReason':_0x352e9f['failureReason'],'processedAt':new Date()[_0x9ba912(0x1f1)]()})}}),await this['sendShopWebhook'](_0x54d569,_0x352e9f[_0x9ba912(0x25c)],_0x352e9f['transactionId'],_0x352e9f[_0x9ba912(0x1f2)]),await this[_0x9ba912(0x1f6)](_0x54d569,_0x352e9f['status']),console[_0x9ba912(0x1fd)](_0x9ba912(0x22b)+_0x29de36+_0x9ba912(0x1fa)+_0x352e9f[_0x9ba912(0x25c)]),_0x352e9f[_0x9ba912(0x25c)]==='PAID'?_0x39f188['json']({'success':!![],'message':_0x9ba912(0x20f),'result':{'status':_0x9ba912(0x1ed),'transactionId':_0x352e9f['transactionId'],'redirectUrl':_0x54d569[_0x9ba912(0x246)]}}):_0x39f188[_0x9ba912(0x25c)](0x190)[_0x9ba912(0x1fe)]({'success':![],'message':_0x9ba912(0x218),'result':{'status':_0x9ba912(0x263),'failureReason':_0x352e9f['failureReason'],'redirectUrl':_0x54d569[_0x9ba912(0x228)]}});}catch(_0x386d5b){_0x496da0(_0x386d5b);}},this['testGatewayService']=new testGatewayService_1[(_0x4dedc6(0x24d))](),this[_0x4dedc6(0x202)]=new webhookService_1[(_0x4dedc6(0x224))]();}async[a13_0x4d89ea(0x23b)](_0x51400e,_0x15e36f,_0x2799ef,_0x402924){const _0x2e4d7b=a13_0x4d89ea,_0x2f384c=Date[_0x2e4d7b(0x1ef)]();try{const _0x422cab=_0x51400e[_0x2e4d7b(0x1ec)],_0x387d35=_0x422cab[_0x2e4d7b(0x20c)];if(!_0x387d35?.['webhookUrl']){console[_0x2e4d7b(0x1fd)](_0x2e4d7b(0x240)+_0x422cab['id']);return;}const _0xbfccb=_0x15e36f===_0x2e4d7b(0x1ed)?'payment.success':_0x2e4d7b(0x258);let _0x174201=[];if(_0x387d35[_0x2e4d7b(0x247)])try{_0x174201=Array['isArray'](_0x387d35['webhookEvents'])?_0x387d35[_0x2e4d7b(0x247)]:JSON[_0x2e4d7b(0x231)](_0x387d35[_0x2e4d7b(0x247)]);}catch(_0x395303){console[_0x2e4d7b(0x25d)](_0x2e4d7b(0x1f9),_0x395303),_0x174201=[];}if(!_0x174201[_0x2e4d7b(0x250)](_0xbfccb)){console['log'](_0x2e4d7b(0x1ee)+_0xbfccb+_0x2e4d7b(0x21e)+_0x422cab['id']);return;}const _0x4a9c82={'event':_0xbfccb,'payment':{'id':_0x51400e['id'],'order_id':_0x51400e['orderId'],'gateway_order_id':_0x51400e[_0x2e4d7b(0x22c)],'gateway':_0x2e4d7b(0x205),'amount':_0x51400e[_0x2e4d7b(0x239)],'currency':_0x51400e[_0x2e4d7b(0x257)],'status':_0x15e36f[_0x2e4d7b(0x200)](),'customer_email':_0x51400e[_0x2e4d7b(0x209)],'customer_name':_0x51400e[_0x2e4d7b(0x25b)],'transaction_id':_0x2799ef,'failure_message':_0x402924,'created_at':_0x51400e[_0x2e4d7b(0x223)],'updated_at':new Date()}},_0x8d6bc8=await fetch(_0x387d35['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x4a9c82)}),_0xd5bac=Date['now']()-_0x2f384c;console[_0x2e4d7b(0x1fd)](_0x2e4d7b(0x216)+_0x387d35[_0x2e4d7b(0x230)]+_0x2e4d7b(0x249)+_0x8d6bc8['status']+'\x20('+_0xd5bac+_0x2e4d7b(0x1f3));}catch(_0x4fafc2){console['error'](_0x2e4d7b(0x238),_0x4fafc2);}}async[a13_0x4d89ea(0x1f6)](_0x514b9d,_0xaf88bb){const _0x155213=a13_0x4d89ea;try{const {telegramBotService:_0x1a3648}=await Promise['resolve']()[_0x155213(0x21f)](()=>__importStar(require('../services/telegramBotService'))),_0x1b9822={'PAID':_0x155213(0x20b),'FAILED':_0x155213(0x248)},_0x3bd8d0=_0x1b9822[_0xaf88bb];if(!_0x3bd8d0)return;await _0x1a3648['sendPaymentNotification'](_0x514b9d[_0x155213(0x210)],_0x514b9d,_0x3bd8d0);}catch(_0x7d0975){console[_0x155213(0x25d)](_0x155213(0x226),_0x7d0975);}}}exports[a13_0x4d89ea(0x23d)]=TestGatewayController;