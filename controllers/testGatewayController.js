'use strict';function a13_0x229a(){const _0x4a058d=['customerEmail','shop','toLowerCase','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','sendPaymentNotification','TestGatewayService','cardNumber','\x20not\x20found','payment','webhookService','0000','test_gateway','sendShopWebhook','payment.failed','test_card','includes','PENDING','findUnique','cardLast4','\x20->\x20','$transaction',',\x20cannot\x20process','customerName','Payment\x20failed','1177862NUAGEP','length','default','POST','gatewayOrderId','resolve','‚úÖ\x20Payment\x20link\x20','Any\x20other\x20card\x20number','\x20with\x20status\x20','failureReason','transactionId','parse','Payment\x20not\x20found','paymentMethod','__importStar','üìà\x20Test\x20Gateway:\x20Payment\x20','currency','__importDefault','gateway','Payment\x20status\x20is\x20','../services/telegramBotService','480998kVdAAb','getOwnPropertyDescriptor','body','Error\x20parsing\x20webhook\x20events:','writable','status','sendPaymentStatusNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','SINGLE','test_gateway_','failed','‚ùå\x20Payment\x20link\x20','prototype','slice','payment.success','update','__esModule','Payment\x20processed\x20successfully','4242\x204242\x204242\x204242','../services/gateways/testGatewayService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','paidAt','../services/webhookService','paymentLinkId','getPaymentForm','shopId','failureMessage','2111856IYehdr','__createBinding','paymentLink','application/json','\x20not\x20enabled\x20for\x20shop\x20','stringify','Any\x20name','configurable','name','testGatewayService','Webhook\x20event\x20','Any\x20future\x20date\x20(MM/YY)','settings','webhookLog','isArray','create','hasOwnProperty','FAILED','failUrl','ms)','7203672gaEIyA','5385723PLHvME','Any\x203-4\x20digits','PAID','log','üìà\x20Found\x20payment\x20link\x20','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','defineProperty','type','error','2764892LIilwG','TestGatewayController','replace','processCard','webhookUrl','üß™\x20Test\x20Gateway\x20result:','getOwnPropertyNames','../config/database','Payment\x20is\x20not\x20for\x20test\x20gateway',',\x20currentPayments=','currentPayments','amount','2281000FXewMZ','\x20processed:\x20','now','COMPLETED','webhookEvents','3CXxWYj','params','json'];a13_0x229a=function(){return _0x4a058d;};return a13_0x229a();}const a13_0x220370=a13_0x8f15;(function(_0x276515,_0x296eed){const _0x477f38=a13_0x8f15,_0x365bfa=_0x276515();while(!![]){try{const _0x55dec4=-parseInt(_0x477f38(0x19a))/0x1+parseInt(_0x477f38(0x185))/0x2+-parseInt(_0x477f38(0x1e4))/0x3*(-parseInt(_0x477f38(0x1d3))/0x4)+-parseInt(_0x477f38(0x1df))/0x5+parseInt(_0x477f38(0x1b5))/0x6+parseInt(_0x477f38(0x1ca))/0x7+-parseInt(_0x477f38(0x1c9))/0x8;if(_0x55dec4===_0x296eed)break;else _0x365bfa['push'](_0x365bfa['shift']());}catch(_0x5b759f){_0x365bfa['push'](_0x365bfa['shift']());}}}(a13_0x229a,0x89a96));var __createBinding=this&&this[a13_0x220370(0x1b6)]||(Object[a13_0x220370(0x1c4)]?function(_0x59708d,_0xd7abc3,_0x3aa93e,_0x194638){const _0x57e814=a13_0x220370;if(_0x194638===undefined)_0x194638=_0x3aa93e;var _0x5374f4=Object[_0x57e814(0x19b)](_0xd7abc3,_0x3aa93e);(!_0x5374f4||('get'in _0x5374f4?!_0xd7abc3[_0x57e814(0x1aa)]:_0x5374f4[_0x57e814(0x19e)]||_0x5374f4[_0x57e814(0x1bc)]))&&(_0x5374f4={'enumerable':!![],'get':function(){return _0xd7abc3[_0x3aa93e];}}),Object[_0x57e814(0x1d0)](_0x59708d,_0x194638,_0x5374f4);}:function(_0x2aa604,_0x41fd7,_0x3ca3d9,_0x353be4){if(_0x353be4===undefined)_0x353be4=_0x3ca3d9;_0x2aa604[_0x353be4]=_0x41fd7[_0x3ca3d9];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x220370(0x1c4)]?function(_0x58d160,_0x429678){const _0x55c2cd=a13_0x220370;Object['defineProperty'](_0x58d160,_0x55c2cd(0x187),{'enumerable':!![],'value':_0x429678});}:function(_0x5cc91b,_0x5a8d99){_0x5cc91b['default']=_0x5a8d99;}),__importStar=this&&this[a13_0x220370(0x193)]||(function(){var _0x44def1=function(_0x5d1c5a){const _0x216b5e=a13_0x8f15;return _0x44def1=Object[_0x216b5e(0x1d9)]||function(_0x2f01dd){const _0xce92f2=_0x216b5e;var _0x2bd80d=[];for(var _0x1c2162 in _0x2f01dd)if(Object[_0xce92f2(0x1a6)][_0xce92f2(0x1c5)]['call'](_0x2f01dd,_0x1c2162))_0x2bd80d[_0x2bd80d[_0xce92f2(0x186)]]=_0x1c2162;return _0x2bd80d;},_0x44def1(_0x5d1c5a);};return function(_0x2e163d){const _0x26d5a2=a13_0x8f15;if(_0x2e163d&&_0x2e163d[_0x26d5a2(0x1aa)])return _0x2e163d;var _0x5745a3={};if(_0x2e163d!=null){for(var _0x1a1d9e=_0x44def1(_0x2e163d),_0x1d3829=0x0;_0x1d3829<_0x1a1d9e[_0x26d5a2(0x186)];_0x1d3829++)if(_0x1a1d9e[_0x1d3829]!==_0x26d5a2(0x187))__createBinding(_0x5745a3,_0x2e163d,_0x1a1d9e[_0x1d3829]);}return __setModuleDefault(_0x5745a3,_0x2e163d),_0x5745a3;};}()),__importDefault=this&&this[a13_0x220370(0x196)]||function(_0x4aba3f){return _0x4aba3f&&_0x4aba3f['__esModule']?_0x4aba3f:{'default':_0x4aba3f};};Object[a13_0x220370(0x1d0)](exports,a13_0x220370(0x1aa),{'value':!![]}),exports[a13_0x220370(0x1d4)]=void 0x0;const testGatewayService_1=require(a13_0x220370(0x1ad)),webhookService_1=require(a13_0x220370(0x1b0)),database_1=__importDefault(require(a13_0x220370(0x1da)));class TestGatewayController{constructor(){const _0x19b642=a13_0x220370;this[_0x19b642(0x1b2)]=async(_0x28ac43,_0x14e1b8,_0x1fd5cd)=>{const _0x4ca9d8=_0x19b642;try{const {paymentId:_0x40084b}=_0x28ac43['params'];console[_0x4ca9d8(0x1cd)](_0x4ca9d8(0x1cf)+_0x40084b);const _0xa6184c=await database_1[_0x4ca9d8(0x187)]['payment']['findUnique']({'where':{'id':_0x40084b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xa6184c)return _0x14e1b8[_0x4ca9d8(0x19f)](0x194)[_0x4ca9d8(0x1e6)]({'success':![],'message':_0x4ca9d8(0x191)});if(_0xa6184c[_0x4ca9d8(0x197)]!==_0x4ca9d8(0x1f2))return _0x14e1b8[_0x4ca9d8(0x19f)](0x190)[_0x4ca9d8(0x1e6)]({'success':![],'message':_0x4ca9d8(0x1db)});if(_0xa6184c['status']!==_0x4ca9d8(0x17d))return _0x14e1b8['status'](0x190)[_0x4ca9d8(0x1e6)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0xa6184c[_0x4ca9d8(0x19f)]+_0x4ca9d8(0x182)});_0x14e1b8['json']({'success':!![],'result':{'paymentId':_0xa6184c['id'],'orderId':_0xa6184c[_0x4ca9d8(0x189)],'amount':_0xa6184c[_0x4ca9d8(0x1de)],'currency':_0xa6184c[_0x4ca9d8(0x195)],'merchantName':_0xa6184c[_0x4ca9d8(0x1e8)][_0x4ca9d8(0x1bd)],'description':'Payment\x20to\x20'+_0xa6184c[_0x4ca9d8(0x1e8)][_0x4ca9d8(0x1bd)],'testInstructions':{'successCard':_0x4ca9d8(0x1ac),'failureCard':_0x4ca9d8(0x18c),'expiryDate':_0x4ca9d8(0x1c0),'cvc':_0x4ca9d8(0x1cb),'holderName':_0x4ca9d8(0x1bb)}}});}catch(_0x1d19c8){_0x1fd5cd(_0x1d19c8);}},this[_0x19b642(0x1d6)]=async(_0x4b1020,_0x5b83b1,_0xca77c1)=>{const _0x21a80c=_0x19b642;try{const {paymentId:_0x5df72a}=_0x4b1020[_0x21a80c(0x1e5)],_0x457e54=_0x4b1020[_0x21a80c(0x19c)];console['log']('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x5df72a);const _0x4f481d=await database_1[_0x21a80c(0x187)]['payment'][_0x21a80c(0x17e)]({'where':{'id':_0x5df72a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4f481d)return _0x5b83b1[_0x21a80c(0x19f)](0x194)[_0x21a80c(0x1e6)]({'success':![],'message':_0x21a80c(0x191)});if(_0x4f481d[_0x21a80c(0x197)]!==_0x21a80c(0x1f2))return _0x5b83b1[_0x21a80c(0x19f)](0x190)[_0x21a80c(0x1e6)]({'success':![],'message':_0x21a80c(0x1db)});if(_0x4f481d['status']!==_0x21a80c(0x17d))return _0x5b83b1[_0x21a80c(0x19f)](0x190)[_0x21a80c(0x1e6)]({'success':![],'message':_0x21a80c(0x198)+_0x4f481d[_0x21a80c(0x19f)]+',\x20cannot\x20process'});const _0x4dfdc7=await this[_0x21a80c(0x1be)]['processCardPayment']({'paymentId':_0x4f481d['id'],'orderId':_0x4f481d[_0x21a80c(0x189)]||_0x4f481d['id'],'amount':_0x4f481d[_0x21a80c(0x1de)],'currency':_0x4f481d[_0x21a80c(0x195)],'cardData':_0x457e54});console[_0x21a80c(0x1cd)](_0x21a80c(0x1d8),_0x4dfdc7);const _0x5bdb0c={'status':_0x4dfdc7['status'],'updatedAt':new Date()};if(_0x4dfdc7[_0x21a80c(0x19f)]===_0x21a80c(0x1cc))_0x5bdb0c[_0x21a80c(0x1af)]=new Date(),_0x5bdb0c['gatewayPaymentId']=_0x4dfdc7['transactionId'];else _0x4dfdc7['status']==='FAILED'&&(_0x5bdb0c[_0x21a80c(0x1b4)]=_0x4dfdc7[_0x21a80c(0x18e)]);const _0x5b7d54=_0x457e54[_0x21a80c(0x1ed)][_0x21a80c(0x1d5)](/[\s-]/g,'');_0x5bdb0c[_0x21a80c(0x17f)]=_0x5b7d54[_0x21a80c(0x1a7)](-0x4),_0x5bdb0c[_0x21a80c(0x192)]=_0x21a80c(0x1f5),await database_1[_0x21a80c(0x187)][_0x21a80c(0x1ef)][_0x21a80c(0x1a9)]({'where':{'id':_0x4f481d['id']},'data':_0x5bdb0c});if(_0x4dfdc7[_0x21a80c(0x19f)]==='PAID'&&_0x4f481d[_0x21a80c(0x1b1)]){console['log'](_0x21a80c(0x194)+_0x4f481d['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x21a80c(0x187)][_0x21a80c(0x181)](async _0x5dab4b=>{const _0x20fdb2=_0x21a80c,_0x4e75bf=await _0x5dab4b[_0x20fdb2(0x1b7)]['findUnique']({'where':{'id':_0x4f481d[_0x20fdb2(0x1b1)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4e75bf){console['log'](_0x20fdb2(0x1ce)+_0x4e75bf['id']+':\x20type='+_0x4e75bf['type']+_0x20fdb2(0x1dc)+_0x4e75bf['currentPayments']+',\x20status='+_0x4e75bf[_0x20fdb2(0x19f)]);const _0x196e04=_0x4e75bf[_0x20fdb2(0x1dd)]+0x1,_0x1e120e=_0x4e75bf[_0x20fdb2(0x1d1)]===_0x20fdb2(0x1a2)?_0x20fdb2(0x1e2):_0x4e75bf[_0x20fdb2(0x19f)];await _0x5dab4b['paymentLink']['update']({'where':{'id':_0x4f481d[_0x20fdb2(0x1b1)]},'data':{'currentPayments':_0x196e04,'status':_0x1e120e,'updatedAt':new Date()}}),console[_0x20fdb2(0x1cd)](_0x20fdb2(0x18b)+_0x4e75bf['id']+'\x20updated:\x20currentPayments='+_0x4e75bf[_0x20fdb2(0x1dd)]+_0x20fdb2(0x180)+_0x196e04+',\x20status='+_0x4e75bf[_0x20fdb2(0x19f)]+'\x20->\x20'+_0x1e120e);}else console[_0x20fdb2(0x1cd)](_0x20fdb2(0x1a5)+_0x4f481d['paymentLinkId']+_0x20fdb2(0x1ee));});}catch(_0x18fc55){console[_0x21a80c(0x1d2)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x18fc55);}}await database_1[_0x21a80c(0x187)][_0x21a80c(0x1c2)][_0x21a80c(0x1c4)]({'data':{'paymentId':_0x4f481d['id'],'shopId':_0x4f481d[_0x21a80c(0x1b3)],'event':_0x21a80c(0x1a3)+_0x4dfdc7[_0x21a80c(0x19f)][_0x21a80c(0x1e9)](),'statusCode':0xc8,'responseBody':JSON[_0x21a80c(0x1ba)]({'oldStatus':'PENDING','newStatus':_0x4dfdc7[_0x21a80c(0x19f)],'transactionId':_0x4dfdc7['transactionId'],'failureReason':_0x4dfdc7['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x21a80c(0x1f3)](_0x4f481d,_0x4dfdc7['status'],_0x4dfdc7[_0x21a80c(0x18f)],_0x4dfdc7['failureReason']),await this[_0x21a80c(0x1a0)](_0x4f481d,_0x4dfdc7[_0x21a80c(0x19f)]),console[_0x21a80c(0x1cd)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x5df72a+_0x21a80c(0x1e0)+_0x4dfdc7['status']),_0x4dfdc7[_0x21a80c(0x19f)]==='PAID'?_0x5b83b1[_0x21a80c(0x1e6)]({'success':!![],'message':_0x21a80c(0x1ab),'result':{'status':_0x21a80c(0x1cc),'transactionId':_0x4dfdc7[_0x21a80c(0x18f)],'redirectUrl':_0x4f481d['successUrl']}}):_0x5b83b1[_0x21a80c(0x19f)](0x190)[_0x21a80c(0x1e6)]({'success':![],'message':_0x21a80c(0x184),'result':{'status':_0x21a80c(0x1c6),'failureReason':_0x4dfdc7['failureReason'],'redirectUrl':_0x4f481d[_0x21a80c(0x1c7)]}});}catch(_0x137cb3){_0xca77c1(_0x137cb3);}},this[_0x19b642(0x1be)]=new testGatewayService_1[(_0x19b642(0x1ec))](),this[_0x19b642(0x1f0)]=new webhookService_1['WebhookService']();}async[a13_0x220370(0x1f3)](_0x3d046f,_0x59bc6b,_0x3c596e,_0x4e7d0d){const _0x48d83b=a13_0x220370,_0x4d506a=Date[_0x48d83b(0x1e1)]();try{const _0x3e32ce=_0x3d046f[_0x48d83b(0x1e8)],_0x2315a5=_0x3e32ce[_0x48d83b(0x1c1)];if(!_0x2315a5?.[_0x48d83b(0x1d7)]){console[_0x48d83b(0x1cd)](_0x48d83b(0x1a1)+_0x3e32ce['id']);return;}const _0x2c616a=_0x59bc6b===_0x48d83b(0x1cc)?_0x48d83b(0x1a8):_0x48d83b(0x1f4);let _0x57e2ce=[];if(_0x2315a5['webhookEvents'])try{_0x57e2ce=Array[_0x48d83b(0x1c3)](_0x2315a5[_0x48d83b(0x1e3)])?_0x2315a5[_0x48d83b(0x1e3)]:JSON[_0x48d83b(0x190)](_0x2315a5[_0x48d83b(0x1e3)]);}catch(_0x3fcbd3){console[_0x48d83b(0x1d2)](_0x48d83b(0x19d),_0x3fcbd3),_0x57e2ce=[];}if(!_0x57e2ce[_0x48d83b(0x17c)](_0x2c616a)){console['log'](_0x48d83b(0x1bf)+_0x2c616a+_0x48d83b(0x1b9)+_0x3e32ce['id']);return;}const _0xed0630={'event':_0x2c616a,'payment':{'id':_0x3d046f['id'],'order_id':_0x3d046f['orderId'],'gateway_order_id':_0x3d046f[_0x48d83b(0x189)],'gateway':_0x48d83b(0x1f1),'amount':_0x3d046f[_0x48d83b(0x1de)],'currency':_0x3d046f[_0x48d83b(0x195)],'status':_0x59bc6b[_0x48d83b(0x1e9)](),'customer_email':_0x3d046f[_0x48d83b(0x1e7)],'customer_name':_0x3d046f[_0x48d83b(0x183)],'transaction_id':_0x3c596e,'failure_message':_0x4e7d0d,'created_at':_0x3d046f['createdAt'],'updated_at':new Date()}},_0x56657e=await fetch(_0x2315a5[_0x48d83b(0x1d7)],{'method':_0x48d83b(0x188),'headers':{'Content-Type':_0x48d83b(0x1b8),'User-Agent':_0x48d83b(0x1ea)},'body':JSON[_0x48d83b(0x1ba)](_0xed0630)}),_0x575af8=Date[_0x48d83b(0x1e1)]()-_0x4d506a;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2315a5['webhookUrl']+_0x48d83b(0x18d)+_0x56657e[_0x48d83b(0x19f)]+'\x20('+_0x575af8+_0x48d83b(0x1c8));}catch(_0x500beb){console[_0x48d83b(0x1d2)](_0x48d83b(0x1ae),_0x500beb);}}async[a13_0x220370(0x1a0)](_0x4c0f5d,_0x1b3a11){const _0x37a188=a13_0x220370;try{const {telegramBotService:_0x5f29c5}=await Promise[_0x37a188(0x18a)]()['then'](()=>__importStar(require(_0x37a188(0x199)))),_0x114f29={'PAID':'paid','FAILED':_0x37a188(0x1a4)},_0x493dd9=_0x114f29[_0x1b3a11];if(!_0x493dd9)return;await _0x5f29c5[_0x37a188(0x1eb)](_0x4c0f5d[_0x37a188(0x1b3)],_0x4c0f5d,_0x493dd9);}catch(_0x54da20){console[_0x37a188(0x1d2)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x54da20);}}}function a13_0x8f15(_0xf8e150,_0x13756b){const _0x229af3=a13_0x229a();return a13_0x8f15=function(_0x8f1550,_0x32dd9c){_0x8f1550=_0x8f1550-0x17c;let _0x14d7e8=_0x229af3[_0x8f1550];return _0x14d7e8;},a13_0x8f15(_0xf8e150,_0x13756b);}exports[a13_0x220370(0x1d4)]=TestGatewayController;