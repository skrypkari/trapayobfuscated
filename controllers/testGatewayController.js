'use strict';const a13_0x514f48=a13_0x2817;(function(_0x2a5b68,_0x396ad7){const _0x372c7c=a13_0x2817,_0x5adb62=_0x2a5b68();while(!![]){try{const _0x295ecd=parseInt(_0x372c7c(0x132))/0x1+-parseInt(_0x372c7c(0x112))/0x2+parseInt(_0x372c7c(0x10a))/0x3*(parseInt(_0x372c7c(0xf6))/0x4)+-parseInt(_0x372c7c(0x108))/0x5*(parseInt(_0x372c7c(0xf9))/0x6)+-parseInt(_0x372c7c(0x140))/0x7*(parseInt(_0x372c7c(0xf8))/0x8)+parseInt(_0x372c7c(0x14e))/0x9*(parseInt(_0x372c7c(0x14f))/0xa)+parseInt(_0x372c7c(0xf4))/0xb;if(_0x295ecd===_0x396ad7)break;else _0x5adb62['push'](_0x5adb62['shift']());}catch(_0xc9697){_0x5adb62['push'](_0x5adb62['shift']());}}}(a13_0xa72b,0x94ef6));var __createBinding=this&&this['__createBinding']||(Object[a13_0x514f48(0x149)]?function(_0x5baeba,_0x2ef991,_0x5b2f6c,_0x58c0d9){const _0x17d68e=a13_0x514f48;if(_0x58c0d9===undefined)_0x58c0d9=_0x5b2f6c;var _0x2c4859=Object[_0x17d68e(0x10e)](_0x2ef991,_0x5b2f6c);(!_0x2c4859||(_0x17d68e(0x13c)in _0x2c4859?!_0x2ef991[_0x17d68e(0x128)]:_0x2c4859[_0x17d68e(0x130)]||_0x2c4859[_0x17d68e(0x142)]))&&(_0x2c4859={'enumerable':!![],'get':function(){return _0x2ef991[_0x5b2f6c];}}),Object[_0x17d68e(0x118)](_0x5baeba,_0x58c0d9,_0x2c4859);}:function(_0x737712,_0x5d7bf6,_0x4a6f57,_0x2280a6){if(_0x2280a6===undefined)_0x2280a6=_0x4a6f57;_0x737712[_0x2280a6]=_0x5d7bf6[_0x4a6f57];}),__setModuleDefault=this&&this[a13_0x514f48(0x129)]||(Object[a13_0x514f48(0x149)]?function(_0x41012d,_0x3dad66){const _0xdae2f5=a13_0x514f48;Object[_0xdae2f5(0x118)](_0x41012d,_0xdae2f5(0x121),{'enumerable':!![],'value':_0x3dad66});}:function(_0xa2943f,_0x19eecf){const _0x5957c7=a13_0x514f48;_0xa2943f[_0x5957c7(0x121)]=_0x19eecf;}),__importStar=this&&this[a13_0x514f48(0x101)]||(function(){var _0x463928=function(_0x276d46){const _0x2d66db=a13_0x2817;return _0x463928=Object[_0x2d66db(0x153)]||function(_0x4bc506){const _0x5f4295=_0x2d66db;var _0x4fff24=[];for(var _0x4c9695 in _0x4bc506)if(Object['prototype'][_0x5f4295(0x11e)][_0x5f4295(0x12e)](_0x4bc506,_0x4c9695))_0x4fff24[_0x4fff24[_0x5f4295(0x117)]]=_0x4c9695;return _0x4fff24;},_0x463928(_0x276d46);};return function(_0x29d2f4){const _0x8edcdc=a13_0x2817;if(_0x29d2f4&&_0x29d2f4[_0x8edcdc(0x128)])return _0x29d2f4;var _0x7a432a={};if(_0x29d2f4!=null){for(var _0x5c8b60=_0x463928(_0x29d2f4),_0x436934=0x0;_0x436934<_0x5c8b60[_0x8edcdc(0x117)];_0x436934++)if(_0x5c8b60[_0x436934]!=='default')__createBinding(_0x7a432a,_0x29d2f4,_0x5c8b60[_0x436934]);}return __setModuleDefault(_0x7a432a,_0x29d2f4),_0x7a432a;};}()),__importDefault=this&&this[a13_0x514f48(0xed)]||function(_0x2279c2){const _0xe9221f=a13_0x514f48;return _0x2279c2&&_0x2279c2[_0xe9221f(0x128)]?_0x2279c2:{'default':_0x2279c2};};function a13_0x2817(_0x24f18b,_0x428e3b){const _0xa72b70=a13_0xa72b();return a13_0x2817=function(_0x281789,_0x3707cd){_0x281789=_0x281789-0xea;let _0x288922=_0xa72b70[_0x281789];return _0x288922;},a13_0x2817(_0x24f18b,_0x428e3b);}Object[a13_0x514f48(0x118)](exports,a13_0x514f48(0x128),{'value':!![]}),exports[a13_0x514f48(0x116)]=void 0x0;const testGatewayService_1=require(a13_0x514f48(0xfb)),webhookService_1=require(a13_0x514f48(0x11b)),database_1=__importDefault(require(a13_0x514f48(0x12d)));class TestGatewayController{constructor(){const _0x5104fa=a13_0x514f48;this[_0x5104fa(0xf3)]=async(_0x517526,_0x2c539f,_0x28e758)=>{const _0x5da4b0=_0x5104fa;try{const {paymentId:_0x4d04c7}=_0x517526[_0x5da4b0(0x11f)];console['log']('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4d04c7);const _0x599600=await database_1['default'][_0x5da4b0(0x11c)][_0x5da4b0(0x126)]({'where':{'id':_0x4d04c7},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x599600)return _0x2c539f[_0x5da4b0(0x120)](0x194)[_0x5da4b0(0x15b)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x599600['gateway']!==_0x5da4b0(0x13a))return _0x2c539f[_0x5da4b0(0x120)](0x190)[_0x5da4b0(0x15b)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x599600[_0x5da4b0(0x120)]!==_0x5da4b0(0x111))return _0x2c539f[_0x5da4b0(0x120)](0x190)[_0x5da4b0(0x15b)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x599600['status']+_0x5da4b0(0x113)});_0x2c539f[_0x5da4b0(0x15b)]({'success':!![],'result':{'paymentId':_0x599600['id'],'orderId':_0x599600[_0x5da4b0(0x12f)],'amount':_0x599600[_0x5da4b0(0xf0)],'currency':_0x599600[_0x5da4b0(0x147)],'merchantName':_0x599600[_0x5da4b0(0x143)][_0x5da4b0(0x125)],'description':_0x5da4b0(0xee)+_0x599600[_0x5da4b0(0x143)]['name'],'testInstructions':{'successCard':_0x5da4b0(0xfa),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x5da4b0(0xef),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x1a27a2){_0x28e758(_0x1a27a2);}},this['processCard']=async(_0x4568a0,_0xde93f5,_0x5e3816)=>{const _0x425dc2=_0x5104fa;try{const {paymentId:_0x193c21}=_0x4568a0[_0x425dc2(0x11f)],_0x32f968=_0x4568a0[_0x425dc2(0x10b)];console['log'](_0x425dc2(0x145)+_0x193c21);const _0x5aa7fa=await database_1[_0x425dc2(0x121)][_0x425dc2(0x11c)][_0x425dc2(0x126)]({'where':{'id':_0x193c21},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5aa7fa)return _0xde93f5[_0x425dc2(0x120)](0x194)[_0x425dc2(0x15b)]({'success':![],'message':_0x425dc2(0x124)});if(_0x5aa7fa[_0x425dc2(0xff)]!==_0x425dc2(0x13a))return _0xde93f5['status'](0x190)[_0x425dc2(0x15b)]({'success':![],'message':_0x425dc2(0x103)});if(_0x5aa7fa[_0x425dc2(0x120)]!=='PENDING')return _0xde93f5['status'](0x190)[_0x425dc2(0x15b)]({'success':![],'message':_0x425dc2(0x12c)+_0x5aa7fa[_0x425dc2(0x120)]+',\x20cannot\x20process'});const _0x340ec2=await this[_0x425dc2(0x14d)][_0x425dc2(0x122)]({'paymentId':_0x5aa7fa['id'],'orderId':_0x5aa7fa[_0x425dc2(0x12f)]||_0x5aa7fa['id'],'amount':_0x5aa7fa[_0x425dc2(0xf0)],'currency':_0x5aa7fa[_0x425dc2(0x147)],'cardData':_0x32f968});console[_0x425dc2(0x115)]('üß™\x20Test\x20Gateway\x20result:',_0x340ec2);const _0xc2cd9d={'status':_0x340ec2['status'],'updatedAt':new Date()};if(_0x340ec2[_0x425dc2(0x120)]===_0x425dc2(0x133))_0xc2cd9d['paidAt']=new Date(),_0xc2cd9d[_0x425dc2(0x13f)]=_0x340ec2[_0x425dc2(0x100)];else _0x340ec2[_0x425dc2(0x120)]===_0x425dc2(0x110)&&(_0xc2cd9d['failureMessage']=_0x340ec2[_0x425dc2(0x137)]);const _0x56e5fa=_0x32f968[_0x425dc2(0x159)][_0x425dc2(0x10f)](/[\s-]/g,'');_0xc2cd9d[_0x425dc2(0xf2)]=_0x56e5fa[_0x425dc2(0x127)](-0x4),_0xc2cd9d[_0x425dc2(0x155)]='test_card',await database_1[_0x425dc2(0x121)][_0x425dc2(0x11c)][_0x425dc2(0x15c)]({'where':{'id':_0x5aa7fa['id']},'data':_0xc2cd9d});if(_0x340ec2['status']===_0x425dc2(0x133)&&_0x5aa7fa[_0x425dc2(0x131)]){console['log'](_0x425dc2(0xfe)+_0x5aa7fa['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x425dc2(0x138)](async _0x1bbecb=>{const _0x4b49c9=_0x425dc2,_0x1bd108=await _0x1bbecb[_0x4b49c9(0x156)][_0x4b49c9(0x126)]({'where':{'id':_0x5aa7fa[_0x4b49c9(0x131)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1bd108){console[_0x4b49c9(0x115)](_0x4b49c9(0x144)+_0x1bd108['id']+':\x20type='+_0x1bd108[_0x4b49c9(0x11d)]+_0x4b49c9(0x104)+_0x1bd108[_0x4b49c9(0x13e)]+_0x4b49c9(0x14b)+_0x1bd108[_0x4b49c9(0x120)]);const _0x449581=_0x1bd108[_0x4b49c9(0x13e)]+0x1,_0x275c62=_0x1bd108['type']===_0x4b49c9(0x136)?'COMPLETED':_0x1bd108[_0x4b49c9(0x120)];await _0x1bbecb[_0x4b49c9(0x156)][_0x4b49c9(0x15c)]({'where':{'id':_0x5aa7fa['paymentLinkId']},'data':{'currentPayments':_0x449581,'status':_0x275c62,'updatedAt':new Date()}}),console[_0x4b49c9(0x115)](_0x4b49c9(0x105)+_0x1bd108['id']+'\x20updated:\x20currentPayments='+_0x1bd108[_0x4b49c9(0x13e)]+_0x4b49c9(0x106)+_0x449581+_0x4b49c9(0x14b)+_0x1bd108[_0x4b49c9(0x120)]+_0x4b49c9(0x106)+_0x275c62);}else console[_0x4b49c9(0x115)](_0x4b49c9(0x11a)+_0x5aa7fa[_0x4b49c9(0x131)]+_0x4b49c9(0x123));});}catch(_0x3f57d6){console[_0x425dc2(0xeb)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x3f57d6);}}await database_1[_0x425dc2(0x121)]['webhookLog'][_0x425dc2(0x149)]({'data':{'paymentId':_0x5aa7fa['id'],'shopId':_0x5aa7fa[_0x425dc2(0x158)],'event':_0x425dc2(0xec)+_0x340ec2[_0x425dc2(0x120)][_0x425dc2(0x12b)](),'statusCode':0xc8,'responseBody':JSON[_0x425dc2(0x107)]({'oldStatus':_0x425dc2(0x111),'newStatus':_0x340ec2['status'],'transactionId':_0x340ec2[_0x425dc2(0x100)],'failureReason':_0x340ec2[_0x425dc2(0x137)],'processedAt':new Date()[_0x425dc2(0x109)]()})}}),await this[_0x425dc2(0x14c)](_0x5aa7fa,_0x340ec2[_0x425dc2(0x120)],_0x340ec2[_0x425dc2(0x100)],_0x340ec2[_0x425dc2(0x137)]),await this[_0x425dc2(0x150)](_0x5aa7fa,_0x340ec2[_0x425dc2(0x120)]),console[_0x425dc2(0x115)](_0x425dc2(0x151)+_0x193c21+'\x20processed:\x20'+_0x340ec2[_0x425dc2(0x120)]),_0x340ec2['status']==='PAID'?_0xde93f5[_0x425dc2(0x15b)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x425dc2(0x133),'transactionId':_0x340ec2[_0x425dc2(0x100)],'redirectUrl':_0x5aa7fa[_0x425dc2(0x157)]}}):_0xde93f5['status'](0x190)[_0x425dc2(0x15b)]({'success':![],'message':_0x425dc2(0x12a),'result':{'status':_0x425dc2(0x110),'failureReason':_0x340ec2[_0x425dc2(0x137)],'redirectUrl':_0x5aa7fa[_0x425dc2(0x14a)]}});}catch(_0x4b73bd){_0x5e3816(_0x4b73bd);}},this[_0x5104fa(0x14d)]=new testGatewayService_1[(_0x5104fa(0x119))](),this[_0x5104fa(0x148)]=new webhookService_1[(_0x5104fa(0x134))]();}async[a13_0x514f48(0x14c)](_0x2007c7,_0x29441b,_0x5e222c,_0x1bc17e){const _0x310f8a=a13_0x514f48,_0x71e673=Date['now']();try{const _0x4e2c1e=_0x2007c7['shop'],_0x233813=_0x4e2c1e['settings'];if(!_0x233813?.[_0x310f8a(0x154)]){console[_0x310f8a(0x115)](_0x310f8a(0x135)+_0x4e2c1e['id']);return;}const _0x3d6822=_0x29441b===_0x310f8a(0x133)?_0x310f8a(0xf7):'payment.failed';let _0x3df2d1=[];if(_0x233813[_0x310f8a(0xf5)])try{_0x3df2d1=Array['isArray'](_0x233813[_0x310f8a(0xf5)])?_0x233813[_0x310f8a(0xf5)]:JSON[_0x310f8a(0x152)](_0x233813[_0x310f8a(0xf5)]);}catch(_0x29c727){console[_0x310f8a(0xeb)](_0x310f8a(0xf1),_0x29c727),_0x3df2d1=[];}if(!_0x3df2d1['includes'](_0x3d6822)){console['log'](_0x310f8a(0x141)+_0x3d6822+_0x310f8a(0x114)+_0x4e2c1e['id']);return;}const _0x110378={'event':_0x3d6822,'payment':{'id':_0x2007c7['id'],'order_id':_0x2007c7['orderId'],'gateway_order_id':_0x2007c7[_0x310f8a(0x12f)],'gateway':_0x310f8a(0xea),'amount':_0x2007c7[_0x310f8a(0xf0)],'currency':_0x2007c7[_0x310f8a(0x147)],'status':_0x29441b[_0x310f8a(0x12b)](),'customer_email':_0x2007c7[_0x310f8a(0xfd)],'customer_name':_0x2007c7['customerName'],'transaction_id':_0x5e222c,'failure_message':_0x1bc17e,'created_at':_0x2007c7[_0x310f8a(0x13b)],'updated_at':new Date()}},_0x4f08f9=await fetch(_0x233813[_0x310f8a(0x154)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x310f8a(0xfc)},'body':JSON[_0x310f8a(0x107)](_0x110378)}),_0x2dff11=Date['now']()-_0x71e673;console['log'](_0x310f8a(0x139)+_0x233813[_0x310f8a(0x154)]+'\x20with\x20status\x20'+_0x4f08f9[_0x310f8a(0x120)]+'\x20('+_0x2dff11+_0x310f8a(0x146));}catch(_0x273e12){console[_0x310f8a(0xeb)](_0x310f8a(0x10c),_0x273e12);}}async[a13_0x514f48(0x150)](_0x31fb87,_0x5c73a8){const _0x61bacf=a13_0x514f48;try{const {telegramBotService:_0x22a927}=await Promise[_0x61bacf(0x15a)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x28bd00={'PAID':_0x61bacf(0x102),'FAILED':_0x61bacf(0x10d)},_0x150c50=_0x28bd00[_0x5c73a8];if(!_0x150c50)return;await _0x22a927['sendPaymentNotification'](_0x31fb87[_0x61bacf(0x158)],_0x31fb87,_0x150c50);}catch(_0x5522fb){console[_0x61bacf(0xeb)](_0x61bacf(0x13d),_0x5522fb);}}}exports['TestGatewayController']=TestGatewayController;function a13_0xa72b(){const _0x194fb4=['SINGLE','failureReason','$transaction','Test\x20Gateway\x20webhook\x20sent\x20to\x20','test_gateway','createdAt','get','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currentPayments','gatewayPaymentId','7370398JUevwK','Webhook\x20event\x20','configurable','shop','üìà\x20Found\x20payment\x20link\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','ms)','currency','webhookService','create','failUrl',',\x20status=','sendShopWebhook','testGatewayService','1980CGgqFo','30bUGmNz','sendPaymentStatusNotification','‚úÖ\x20Test\x20Gateway\x20payment\x20','parse','getOwnPropertyNames','webhookUrl','paymentMethod','paymentLink','successUrl','shopId','cardNumber','resolve','json','update','0000','error','test_gateway_','__importDefault','Payment\x20to\x20','Any\x20future\x20date\x20(MM/YY)','amount','Error\x20parsing\x20webhook\x20events:','cardLast4','getPaymentForm','20888076TwtWMK','webhookEvents','810776XLNRzy','payment.success','8JWezld','1595346zMsuBK','4242\x204242\x204242\x204242','../services/gateways/testGatewayService','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','customerEmail','üìà\x20Test\x20Gateway:\x20Payment\x20','gateway','transactionId','__importStar','paid','Payment\x20is\x20not\x20for\x20test\x20gateway',',\x20currentPayments=','‚úÖ\x20Payment\x20link\x20','\x20->\x20','stringify','5tyzSiS','toISOString','6rYbqMa','body','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','failed','getOwnPropertyDescriptor','replace','FAILED','PENDING','1937668boAQoc',',\x20cannot\x20process','\x20not\x20enabled\x20for\x20shop\x20','log','TestGatewayController','length','defineProperty','TestGatewayService','‚ùå\x20Payment\x20link\x20','../services/webhookService','payment','type','hasOwnProperty','params','status','default','processCardPayment','\x20not\x20found','Payment\x20not\x20found','name','findUnique','slice','__esModule','__setModuleDefault','Payment\x20failed','toLowerCase','Payment\x20status\x20is\x20','../config/database','call','gatewayOrderId','writable','paymentLinkId','592713QlripY','PAID','WebhookService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'];a13_0xa72b=function(){return _0x194fb4;};return a13_0xa72b();}