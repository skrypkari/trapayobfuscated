'use strict';const a13_0x4b1759=a13_0x1503;(function(_0x292657,_0x8c48c0){const _0x5e2732=a13_0x1503,_0x9ac9c=_0x292657();while(!![]){try{const _0x25607f=parseInt(_0x5e2732(0x12a))/0x1+parseInt(_0x5e2732(0x151))/0x2+-parseInt(_0x5e2732(0x111))/0x3*(parseInt(_0x5e2732(0x142))/0x4)+-parseInt(_0x5e2732(0x137))/0x5+-parseInt(_0x5e2732(0x14e))/0x6*(parseInt(_0x5e2732(0x10c))/0x7)+-parseInt(_0x5e2732(0x145))/0x8+parseInt(_0x5e2732(0x123))/0x9;if(_0x25607f===_0x8c48c0)break;else _0x9ac9c['push'](_0x9ac9c['shift']());}catch(_0x4ecfb3){_0x9ac9c['push'](_0x9ac9c['shift']());}}}(a13_0x1997,0x9ee82));var __createBinding=this&&this[a13_0x4b1759(0x144)]||(Object[a13_0x4b1759(0x121)]?function(_0x4d778a,_0x5ce8f0,_0x544e50,_0x5ecae3){const _0xfb1ed=a13_0x4b1759;if(_0x5ecae3===undefined)_0x5ecae3=_0x544e50;var _0x2d9584=Object[_0xfb1ed(0x126)](_0x5ce8f0,_0x544e50);(!_0x2d9584||(_0xfb1ed(0x14b)in _0x2d9584?!_0x5ce8f0['__esModule']:_0x2d9584[_0xfb1ed(0x113)]||_0x2d9584[_0xfb1ed(0x132)]))&&(_0x2d9584={'enumerable':!![],'get':function(){return _0x5ce8f0[_0x544e50];}}),Object['defineProperty'](_0x4d778a,_0x5ecae3,_0x2d9584);}:function(_0x359750,_0x590ad4,_0xfd09e8,_0x5698c5){if(_0x5698c5===undefined)_0x5698c5=_0xfd09e8;_0x359750[_0x5698c5]=_0x590ad4[_0xfd09e8];}),__setModuleDefault=this&&this[a13_0x4b1759(0x128)]||(Object[a13_0x4b1759(0x121)]?function(_0x508cfc,_0x39ba0b){const _0x455d7c=a13_0x4b1759;Object[_0x455d7c(0x157)](_0x508cfc,'default',{'enumerable':!![],'value':_0x39ba0b});}:function(_0x10592d,_0x1767ed){_0x10592d['default']=_0x1767ed;}),__importStar=this&&this[a13_0x4b1759(0x162)]||(function(){var _0x4eb36a=function(_0x38ce32){return _0x4eb36a=Object['getOwnPropertyNames']||function(_0x22e0f9){const _0x1c0ae2=a13_0x1503;var _0x480e60=[];for(var _0x533a1e in _0x22e0f9)if(Object[_0x1c0ae2(0x124)]['hasOwnProperty'][_0x1c0ae2(0x146)](_0x22e0f9,_0x533a1e))_0x480e60[_0x480e60[_0x1c0ae2(0x14a)]]=_0x533a1e;return _0x480e60;},_0x4eb36a(_0x38ce32);};return function(_0x43a846){const _0x4eb2e7=a13_0x1503;if(_0x43a846&&_0x43a846[_0x4eb2e7(0x110)])return _0x43a846;var _0x226b37={};if(_0x43a846!=null){for(var _0x5c9c8b=_0x4eb36a(_0x43a846),_0x40bfd6=0x0;_0x40bfd6<_0x5c9c8b['length'];_0x40bfd6++)if(_0x5c9c8b[_0x40bfd6]!==_0x4eb2e7(0x14f))__createBinding(_0x226b37,_0x43a846,_0x5c9c8b[_0x40bfd6]);}return __setModuleDefault(_0x226b37,_0x43a846),_0x226b37;};}()),__importDefault=this&&this[a13_0x4b1759(0x104)]||function(_0xd90a96){return _0xd90a96&&_0xd90a96['__esModule']?_0xd90a96:{'default':_0xd90a96};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x4b1759(0x103)),database_1=__importDefault(require(a13_0x4b1759(0x10e)));function a13_0x1997(){const _0xd13640=['length','get','shop','Payment\x20status\x20is\x20','5070468yqIict','default','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','1453174rgcxhH','stringify','TestGatewayController','4242\x204242\x204242\x204242','payment','processCard','defineProperty','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','ms)','replace','Any\x203-4\x20digits','payment.success','payment.failed','Error\x20parsing\x20webhook\x20events:','webhookUrl','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','sendShopWebhook','__importStar','error','parse','test_gateway_','gatewayPaymentId','gatewayOrderId','log','ðŸ§ª\x20Test\x20Gateway\x20result:','json','../services/webhookService','__importDefault','createdAt','now','paymentMethod','isArray','params','customerName','TestGatewayService','7omcNaq','Payment\x20to\x20','../config/database','\x20processed:\x20','__esModule','27rNAdds','failureReason','writable','\x20not\x20enabled\x20for\x20shop\x20','sendPaymentNotification','PAID','Payment\x20is\x20not\x20for\x20test\x20gateway','toLowerCase','testGatewayService','paidAt','update','gateway',',\x20cannot\x20process','shopId','../services/telegramBotService','Payment\x20processed\x20successfully','create','successUrl','14348835jVLPKD','prototype','Test\x20Gateway\x20webhook\x20sent\x20to\x20','getOwnPropertyDescriptor','WebhookService','__setModuleDefault','Any\x20future\x20date\x20(MM/YY)','1228205apdGRn','then','cardLast4','transactionId','resolve','PENDING','application/json','Webhook\x20event\x20','configurable','sendPaymentStatusNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paid','cardNumber','3466710RlSAGA','webhookLog','status','test_gateway','webhookEvents','findUnique','amount','failUrl','name','slice','FAILED','324844ScDQIh','settings','__createBinding','5031248nMAWel','call','Payment\x20not\x20found','POST','currency'];a13_0x1997=function(){return _0xd13640;};return a13_0x1997();}function a13_0x1503(_0x4fa499,_0x3c5a6f){const _0x199788=a13_0x1997();return a13_0x1503=function(_0x1503de,_0x156a9d){_0x1503de=_0x1503de-0x102;let _0x594c1d=_0x199788[_0x1503de];return _0x594c1d;},a13_0x1503(_0x4fa499,_0x3c5a6f);}class TestGatewayController{constructor(){const _0xe1dd60=a13_0x4b1759;this['getPaymentForm']=async(_0x516310,_0x32122e,_0x10c90a)=>{const _0x5adcf8=a13_0x1503;try{const {paymentId:_0x443dea}=_0x516310['params'];console[_0x5adcf8(0x168)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x443dea);const _0x29b797=await database_1[_0x5adcf8(0x14f)]['payment'][_0x5adcf8(0x13c)]({'where':{'id':_0x443dea},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x29b797)return _0x32122e[_0x5adcf8(0x139)](0x194)['json']({'success':![],'message':_0x5adcf8(0x147)});if(_0x29b797[_0x5adcf8(0x11c)]!=='test_gateway')return _0x32122e['status'](0x190)[_0x5adcf8(0x102)]({'success':![],'message':_0x5adcf8(0x117)});if(_0x29b797[_0x5adcf8(0x139)]!=='PENDING')return _0x32122e[_0x5adcf8(0x139)](0x190)['json']({'success':![],'message':_0x5adcf8(0x14d)+_0x29b797[_0x5adcf8(0x139)]+_0x5adcf8(0x11d)});_0x32122e[_0x5adcf8(0x102)]({'success':!![],'result':{'paymentId':_0x29b797['id'],'orderId':_0x29b797[_0x5adcf8(0x167)],'amount':_0x29b797[_0x5adcf8(0x13d)],'currency':_0x29b797[_0x5adcf8(0x149)],'merchantName':_0x29b797['shop'][_0x5adcf8(0x13f)],'description':_0x5adcf8(0x10d)+_0x29b797[_0x5adcf8(0x14c)]['name'],'testInstructions':{'successCard':_0x5adcf8(0x154),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x5adcf8(0x129),'cvc':_0x5adcf8(0x15b),'holderName':'Any\x20name'}}});}catch(_0x2775f1){_0x10c90a(_0x2775f1);}},this[_0xe1dd60(0x156)]=async(_0x235fc5,_0xabfa88,_0x526e9f)=>{const _0x23510b=_0xe1dd60;try{const {paymentId:_0x1b4156}=_0x235fc5[_0x23510b(0x109)],_0x27d5c1=_0x235fc5['body'];console[_0x23510b(0x168)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1b4156);const _0x206f1c=await database_1[_0x23510b(0x14f)][_0x23510b(0x155)][_0x23510b(0x13c)]({'where':{'id':_0x1b4156},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x206f1c)return _0xabfa88[_0x23510b(0x139)](0x194)[_0x23510b(0x102)]({'success':![],'message':_0x23510b(0x147)});if(_0x206f1c['gateway']!==_0x23510b(0x13a))return _0xabfa88['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x206f1c[_0x23510b(0x139)]!==_0x23510b(0x12f))return _0xabfa88[_0x23510b(0x139)](0x190)['json']({'success':![],'message':_0x23510b(0x14d)+_0x206f1c[_0x23510b(0x139)]+_0x23510b(0x11d)});const _0x1dff8b=await this['testGatewayService']['processCardPayment']({'paymentId':_0x206f1c['id'],'orderId':_0x206f1c[_0x23510b(0x167)]||_0x206f1c['id'],'amount':_0x206f1c[_0x23510b(0x13d)],'currency':_0x206f1c[_0x23510b(0x149)],'cardData':_0x27d5c1});console['log'](_0x23510b(0x169),_0x1dff8b);const _0x4aa931={'status':_0x1dff8b[_0x23510b(0x139)],'updatedAt':new Date()};if(_0x1dff8b[_0x23510b(0x139)]===_0x23510b(0x116))_0x4aa931[_0x23510b(0x11a)]=new Date(),_0x4aa931[_0x23510b(0x166)]=_0x1dff8b['transactionId'];else _0x1dff8b[_0x23510b(0x139)]==='FAILED'&&(_0x4aa931['failureMessage']=_0x1dff8b[_0x23510b(0x112)]);const _0x71167c=_0x27d5c1[_0x23510b(0x136)][_0x23510b(0x15a)](/[\s-]/g,'');_0x4aa931[_0x23510b(0x12c)]=_0x71167c[_0x23510b(0x140)](-0x4),_0x4aa931[_0x23510b(0x107)]='test_card',await database_1[_0x23510b(0x14f)][_0x23510b(0x155)][_0x23510b(0x11b)]({'where':{'id':_0x206f1c['id']},'data':_0x4aa931}),await database_1[_0x23510b(0x14f)][_0x23510b(0x138)][_0x23510b(0x121)]({'data':{'paymentId':_0x206f1c['id'],'shopId':_0x206f1c[_0x23510b(0x11e)],'event':_0x23510b(0x165)+_0x1dff8b[_0x23510b(0x139)][_0x23510b(0x118)](),'statusCode':0xc8,'responseBody':JSON[_0x23510b(0x152)]({'oldStatus':'PENDING','newStatus':_0x1dff8b[_0x23510b(0x139)],'transactionId':_0x1dff8b[_0x23510b(0x12d)],'failureReason':_0x1dff8b[_0x23510b(0x112)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x206f1c,_0x1dff8b[_0x23510b(0x139)],_0x1dff8b['transactionId'],_0x1dff8b[_0x23510b(0x112)]),await this[_0x23510b(0x133)](_0x206f1c,_0x1dff8b['status']),console[_0x23510b(0x168)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x1b4156+_0x23510b(0x10f)+_0x1dff8b['status']),_0x1dff8b[_0x23510b(0x139)]==='PAID'?_0xabfa88[_0x23510b(0x102)]({'success':!![],'message':_0x23510b(0x120),'result':{'status':_0x23510b(0x116),'transactionId':_0x1dff8b[_0x23510b(0x12d)],'redirectUrl':_0x206f1c[_0x23510b(0x122)]}}):_0xabfa88[_0x23510b(0x139)](0x190)[_0x23510b(0x102)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x23510b(0x141),'failureReason':_0x1dff8b['failureReason'],'redirectUrl':_0x206f1c[_0x23510b(0x13e)]}});}catch(_0x23a161){_0x526e9f(_0x23a161);}},this[_0xe1dd60(0x119)]=new testGatewayService_1[(_0xe1dd60(0x10b))](),this['webhookService']=new webhookService_1[(_0xe1dd60(0x127))]();}async[a13_0x4b1759(0x161)](_0x2e7101,_0x45336a,_0x161d27,_0x3ce7a1){const _0x5ef039=a13_0x4b1759,_0x37247f=Date[_0x5ef039(0x106)]();try{const _0x173178=_0x2e7101['shop'],_0x3df2fc=_0x173178[_0x5ef039(0x143)];if(!_0x3df2fc?.['webhookUrl']){console[_0x5ef039(0x168)](_0x5ef039(0x160)+_0x173178['id']);return;}const _0x327e5f=_0x45336a==='PAID'?_0x5ef039(0x15c):_0x5ef039(0x15d);let _0x49d1d5=[];if(_0x3df2fc[_0x5ef039(0x13b)])try{_0x49d1d5=Array[_0x5ef039(0x108)](_0x3df2fc['webhookEvents'])?_0x3df2fc['webhookEvents']:JSON[_0x5ef039(0x164)](_0x3df2fc['webhookEvents']);}catch(_0x1e2e7e){console['error'](_0x5ef039(0x15e),_0x1e2e7e),_0x49d1d5=[];}if(!_0x49d1d5['includes'](_0x327e5f)){console[_0x5ef039(0x168)](_0x5ef039(0x131)+_0x327e5f+_0x5ef039(0x114)+_0x173178['id']);return;}const _0xf6bca6={'event':_0x327e5f,'payment':{'id':_0x2e7101['id'],'order_id':_0x2e7101['orderId'],'gateway_order_id':_0x2e7101[_0x5ef039(0x167)],'gateway':'0000','amount':_0x2e7101[_0x5ef039(0x13d)],'currency':_0x2e7101[_0x5ef039(0x149)],'status':_0x45336a[_0x5ef039(0x118)](),'customer_email':_0x2e7101['customerEmail'],'customer_name':_0x2e7101[_0x5ef039(0x10a)],'transaction_id':_0x161d27,'failure_message':_0x3ce7a1,'created_at':_0x2e7101[_0x5ef039(0x105)],'updated_at':new Date()}},_0x26f946=await fetch(_0x3df2fc[_0x5ef039(0x15f)],{'method':_0x5ef039(0x148),'headers':{'Content-Type':_0x5ef039(0x130),'User-Agent':_0x5ef039(0x150)},'body':JSON['stringify'](_0xf6bca6)}),_0x584583=Date[_0x5ef039(0x106)]()-_0x37247f;console['log'](_0x5ef039(0x125)+_0x3df2fc[_0x5ef039(0x15f)]+'\x20with\x20status\x20'+_0x26f946[_0x5ef039(0x139)]+'\x20('+_0x584583+_0x5ef039(0x159));}catch(_0x11ca25){console[_0x5ef039(0x163)](_0x5ef039(0x158),_0x11ca25);}}async[a13_0x4b1759(0x133)](_0x5a8133,_0x431476){const _0x127f82=a13_0x4b1759;try{const {telegramBotService:_0x3d00e7}=await Promise[_0x127f82(0x12e)]()[_0x127f82(0x12b)](()=>__importStar(require(_0x127f82(0x11f)))),_0x4e53c2={'PAID':_0x127f82(0x135),'FAILED':'failed'},_0x384dc7=_0x4e53c2[_0x431476];if(!_0x384dc7)return;await _0x3d00e7[_0x127f82(0x115)](_0x5a8133[_0x127f82(0x11e)],_0x5a8133,_0x384dc7);}catch(_0x4a425f){console[_0x127f82(0x163)](_0x127f82(0x134),_0x4a425f);}}}exports[a13_0x4b1759(0x153)]=TestGatewayController;