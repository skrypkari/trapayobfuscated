'use strict';const a14_0x397c13=a14_0x49ce;function a14_0x49ce(_0x2b29dc,_0x1d9cca){const _0x5ebccf=a14_0x5ebc();return a14_0x49ce=function(_0x49ce79,_0x1adade){_0x49ce79=_0x49ce79-0x138;let _0x52aedc=_0x5ebccf[_0x49ce79];return _0x52aedc;},a14_0x49ce(_0x2b29dc,_0x1d9cca);}(function(_0x5cff47,_0x42160c){const _0x37b00b=a14_0x49ce,_0xa32ad5=_0x5cff47();while(!![]){try{const _0x2d81ea=parseInt(_0x37b00b(0x140))/0x1*(-parseInt(_0x37b00b(0x155))/0x2)+-parseInt(_0x37b00b(0x184))/0x3+parseInt(_0x37b00b(0x163))/0x4+-parseInt(_0x37b00b(0x141))/0x5+-parseInt(_0x37b00b(0x173))/0x6+-parseInt(_0x37b00b(0x150))/0x7+parseInt(_0x37b00b(0x15f))/0x8;if(_0x2d81ea===_0x42160c)break;else _0xa32ad5['push'](_0xa32ad5['shift']());}catch(_0x48adae){_0xa32ad5['push'](_0xa32ad5['shift']());}}}(a14_0x5ebc,0xe80fa));var __createBinding=this&&this[a14_0x397c13(0x196)]||(Object[a14_0x397c13(0x1aa)]?function(_0x3d3c33,_0x1f5016,_0x3cc047,_0x2ccc20){const _0xbb4cd3=a14_0x397c13;if(_0x2ccc20===undefined)_0x2ccc20=_0x3cc047;var _0x2161b5=Object[_0xbb4cd3(0x15a)](_0x1f5016,_0x3cc047);(!_0x2161b5||(_0xbb4cd3(0x1b4)in _0x2161b5?!_0x1f5016[_0xbb4cd3(0x178)]:_0x2161b5[_0xbb4cd3(0x181)]||_0x2161b5[_0xbb4cd3(0x15e)]))&&(_0x2161b5={'enumerable':!![],'get':function(){return _0x1f5016[_0x3cc047];}}),Object[_0xbb4cd3(0x1af)](_0x3d3c33,_0x2ccc20,_0x2161b5);}:function(_0x300d35,_0x1a1afd,_0x4fea56,_0x3ebd4c){if(_0x3ebd4c===undefined)_0x3ebd4c=_0x4fea56;_0x300d35[_0x3ebd4c]=_0x1a1afd[_0x4fea56];}),__setModuleDefault=this&&this[a14_0x397c13(0x193)]||(Object[a14_0x397c13(0x1aa)]?function(_0x43eea1,_0x95cda3){const _0x4ebd8b=a14_0x397c13;Object[_0x4ebd8b(0x1af)](_0x43eea1,_0x4ebd8b(0x16a),{'enumerable':!![],'value':_0x95cda3});}:function(_0x2ecb2f,_0x2141b5){const _0x3e8ac5=a14_0x397c13;_0x2ecb2f[_0x3e8ac5(0x16a)]=_0x2141b5;}),__importStar=this&&this[a14_0x397c13(0x185)]||(function(){var _0x3ce1e1=function(_0x107649){const _0x5222b4=a14_0x49ce;return _0x3ce1e1=Object[_0x5222b4(0x1ae)]||function(_0x4b7658){const _0x2fecd2=_0x5222b4;var _0xbebaf8=[];for(var _0x37425e in _0x4b7658)if(Object[_0x2fecd2(0x162)][_0x2fecd2(0x13a)][_0x2fecd2(0x19c)](_0x4b7658,_0x37425e))_0xbebaf8[_0xbebaf8['length']]=_0x37425e;return _0xbebaf8;},_0x3ce1e1(_0x107649);};return function(_0x2c9633){const _0x129f2d=a14_0x49ce;if(_0x2c9633&&_0x2c9633[_0x129f2d(0x178)])return _0x2c9633;var _0x449377={};if(_0x2c9633!=null){for(var _0xe5446f=_0x3ce1e1(_0x2c9633),_0x166c58=0x0;_0x166c58<_0xe5446f[_0x129f2d(0x147)];_0x166c58++)if(_0xe5446f[_0x166c58]!==_0x129f2d(0x16a))__createBinding(_0x449377,_0x2c9633,_0xe5446f[_0x166c58]);}return __setModuleDefault(_0x449377,_0x2c9633),_0x449377;};}()),__importDefault=this&&this['__importDefault']||function(_0x27a3da){const _0x30db69=a14_0x397c13;return _0x27a3da&&_0x27a3da[_0x30db69(0x178)]?_0x27a3da:{'default':_0x27a3da};};Object[a14_0x397c13(0x1af)](exports,a14_0x397c13(0x178),{'value':!![]}),exports[a14_0x397c13(0x153)]=void 0x0;const testGatewayService_1=require(a14_0x397c13(0x1a7)),webhookService_1=require(a14_0x397c13(0x195)),database_1=__importDefault(require(a14_0x397c13(0x14d)));function a14_0x5ebc(){const _0x17ff7f=['271752zfMiDf','paidAt','Any\x203-4\x20digits','4242\x204242\x204242\x204242','processCardPayment','name','sendPaymentStatusNotification','default','successUrl','findUnique','then','toLowerCase','webhookEvents','\x20with\x20status\x20','test_gateway_','test_gateway','9974754QgmZQF','PENDING','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',':\x20type=','__esModule','error','failed','currentPayments','paymentMethod','PAID','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','payment.failed','Error\x20parsing\x20webhook\x20events:','writable','webhookUrl','includes','4636920xyOsjf','__importStar','currency','Payment\x20is\x20not\x20for\x20test\x20gateway','payment','Webhook\x20event\x20','gatewayOrderId','FAILED','update','isArray','sendShopWebhook','orderId','resolve','type','json','__setModuleDefault','Payment\x20to\x20','../services/webhookService','__createBinding','webhookService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ms)','gatewayPaymentId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','call','failUrl','paymentLink','SINGLE','test_card','Payment\x20failed','status','gateway','0000',',\x20status=','📈\x20Found\x20payment\x20link\x20','../services/gateways/testGatewayService','Payment\x20not\x20found','cardNumber','create','amount','transactionId','settings','getOwnPropertyNames','defineProperty','❌\x20Payment\x20link\x20','stringify','replace','Any\x20name','get','\x20not\x20enabled\x20for\x20shop\x20','🧪\x20Test\x20Gateway\x20result:','\x20updated:\x20currentPayments=','hasOwnProperty','customerName','paid','paymentLinkId','\x20->\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','362019dqeQpw','6494755DYbkZk','body','WebhookService','toISOString',',\x20currentPayments=','$transaction','length','webhookLog','✅\x20Payment\x20link\x20','\x20processed:\x20','failureReason','shopId','../config/database','log','sendPaymentNotification','3312288BCyBkV','testGatewayService','createdAt','TestGatewayController','params','10myosIo','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','shop','COMPLETED','payment.success','getOwnPropertyDescriptor','processCard','failureMessage','Payment\x20status\x20is\x20','configurable','61383304RZYOZQ','now','Any\x20future\x20date\x20(MM/YY)','prototype'];a14_0x5ebc=function(){return _0x17ff7f;};return a14_0x5ebc();}class TestGatewayController{constructor(){const _0x5c535b=a14_0x397c13;this['getPaymentForm']=async(_0x1998a1,_0x42708b,_0x496f73)=>{const _0x1bad74=a14_0x49ce;try{const {paymentId:_0x10861d}=_0x1998a1[_0x1bad74(0x154)];console['log']('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x10861d);const _0x2cd1c3=await database_1['default'][_0x1bad74(0x188)][_0x1bad74(0x16c)]({'where':{'id':_0x10861d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2cd1c3)return _0x42708b[_0x1bad74(0x1a2)](0x194)[_0x1bad74(0x192)]({'success':![],'message':_0x1bad74(0x1a8)});if(_0x2cd1c3['gateway']!==_0x1bad74(0x172))return _0x42708b[_0x1bad74(0x1a2)](0x190)[_0x1bad74(0x192)]({'success':![],'message':_0x1bad74(0x187)});if(_0x2cd1c3['status']!==_0x1bad74(0x174))return _0x42708b['status'](0x190)[_0x1bad74(0x192)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2cd1c3[_0x1bad74(0x1a2)]+',\x20cannot\x20process'});_0x42708b[_0x1bad74(0x192)]({'success':!![],'result':{'paymentId':_0x2cd1c3['id'],'orderId':_0x2cd1c3[_0x1bad74(0x18a)],'amount':_0x2cd1c3[_0x1bad74(0x1ab)],'currency':_0x2cd1c3[_0x1bad74(0x186)],'merchantName':_0x2cd1c3[_0x1bad74(0x157)][_0x1bad74(0x168)],'description':_0x1bad74(0x194)+_0x2cd1c3[_0x1bad74(0x157)][_0x1bad74(0x168)],'testInstructions':{'successCard':_0x1bad74(0x166),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x1bad74(0x161),'cvc':_0x1bad74(0x165),'holderName':_0x1bad74(0x1b3)}}});}catch(_0x323540){_0x496f73(_0x323540);}},this[_0x5c535b(0x15b)]=async(_0x1b094f,_0x459230,_0x4a5130)=>{const _0x3dcd28=_0x5c535b;try{const {paymentId:_0x53231f}=_0x1b094f[_0x3dcd28(0x154)],_0x7b331a=_0x1b094f[_0x3dcd28(0x142)];console[_0x3dcd28(0x14e)](_0x3dcd28(0x17e)+_0x53231f);const _0x3ae172=await database_1[_0x3dcd28(0x16a)][_0x3dcd28(0x188)][_0x3dcd28(0x16c)]({'where':{'id':_0x53231f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ae172)return _0x459230[_0x3dcd28(0x1a2)](0x194)[_0x3dcd28(0x192)]({'success':![],'message':_0x3dcd28(0x1a8)});if(_0x3ae172[_0x3dcd28(0x1a3)]!==_0x3dcd28(0x172))return _0x459230[_0x3dcd28(0x1a2)](0x190)[_0x3dcd28(0x192)]({'success':![],'message':_0x3dcd28(0x187)});if(_0x3ae172[_0x3dcd28(0x1a2)]!==_0x3dcd28(0x174))return _0x459230['status'](0x190)[_0x3dcd28(0x192)]({'success':![],'message':_0x3dcd28(0x15d)+_0x3ae172[_0x3dcd28(0x1a2)]+',\x20cannot\x20process'});const _0x3aa21c=await this[_0x3dcd28(0x151)][_0x3dcd28(0x167)]({'paymentId':_0x3ae172['id'],'orderId':_0x3ae172[_0x3dcd28(0x18a)]||_0x3ae172['id'],'amount':_0x3ae172[_0x3dcd28(0x1ab)],'currency':_0x3ae172['currency'],'cardData':_0x7b331a});console[_0x3dcd28(0x14e)](_0x3dcd28(0x138),_0x3aa21c);const _0x522de2={'status':_0x3aa21c[_0x3dcd28(0x1a2)],'updatedAt':new Date()};if(_0x3aa21c[_0x3dcd28(0x1a2)]===_0x3dcd28(0x17d))_0x522de2[_0x3dcd28(0x164)]=new Date(),_0x522de2[_0x3dcd28(0x19a)]=_0x3aa21c['transactionId'];else _0x3aa21c[_0x3dcd28(0x1a2)]===_0x3dcd28(0x18b)&&(_0x522de2[_0x3dcd28(0x15c)]=_0x3aa21c['failureReason']);const _0x59c430=_0x7b331a[_0x3dcd28(0x1a9)][_0x3dcd28(0x1b2)](/[\s-]/g,'');_0x522de2['cardLast4']=_0x59c430['slice'](-0x4),_0x522de2[_0x3dcd28(0x17c)]=_0x3dcd28(0x1a0),await database_1['default'][_0x3dcd28(0x188)][_0x3dcd28(0x18c)]({'where':{'id':_0x3ae172['id']},'data':_0x522de2});if(_0x3aa21c[_0x3dcd28(0x1a2)]===_0x3dcd28(0x17d)&&_0x3ae172[_0x3dcd28(0x13d)]){console[_0x3dcd28(0x14e)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x3ae172['id']+_0x3dcd28(0x156));try{await database_1[_0x3dcd28(0x16a)][_0x3dcd28(0x146)](async _0x2bf185=>{const _0x44d7dc=_0x3dcd28,_0x5be971=await _0x2bf185[_0x44d7dc(0x19e)][_0x44d7dc(0x16c)]({'where':{'id':_0x3ae172['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5be971){console[_0x44d7dc(0x14e)](_0x44d7dc(0x1a6)+_0x5be971['id']+_0x44d7dc(0x177)+_0x5be971[_0x44d7dc(0x191)]+_0x44d7dc(0x145)+_0x5be971[_0x44d7dc(0x17b)]+_0x44d7dc(0x1a5)+_0x5be971['status']);const _0xa8d5f4=_0x5be971[_0x44d7dc(0x17b)]+0x1,_0x1c6ec5=_0x5be971[_0x44d7dc(0x191)]===_0x44d7dc(0x19f)?_0x44d7dc(0x158):_0x5be971[_0x44d7dc(0x1a2)];await _0x2bf185[_0x44d7dc(0x19e)]['update']({'where':{'id':_0x3ae172[_0x44d7dc(0x13d)]},'data':{'currentPayments':_0xa8d5f4,'status':_0x1c6ec5,'updatedAt':new Date()}}),console[_0x44d7dc(0x14e)](_0x44d7dc(0x149)+_0x5be971['id']+_0x44d7dc(0x139)+_0x5be971['currentPayments']+_0x44d7dc(0x13e)+_0xa8d5f4+_0x44d7dc(0x1a5)+_0x5be971[_0x44d7dc(0x1a2)]+_0x44d7dc(0x13e)+_0x1c6ec5);}else console[_0x44d7dc(0x14e)](_0x44d7dc(0x1b0)+_0x3ae172[_0x44d7dc(0x13d)]+'\x20not\x20found');});}catch(_0xf2549f){console[_0x3dcd28(0x179)](_0x3dcd28(0x176),_0xf2549f);}}await database_1[_0x3dcd28(0x16a)][_0x3dcd28(0x148)][_0x3dcd28(0x1aa)]({'data':{'paymentId':_0x3ae172['id'],'shopId':_0x3ae172[_0x3dcd28(0x14c)],'event':_0x3dcd28(0x171)+_0x3aa21c['status'][_0x3dcd28(0x16e)](),'statusCode':0xc8,'responseBody':JSON[_0x3dcd28(0x1b1)]({'oldStatus':_0x3dcd28(0x174),'newStatus':_0x3aa21c[_0x3dcd28(0x1a2)],'transactionId':_0x3aa21c[_0x3dcd28(0x1ac)],'failureReason':_0x3aa21c[_0x3dcd28(0x14b)],'processedAt':new Date()[_0x3dcd28(0x144)]()})}}),await this[_0x3dcd28(0x18e)](_0x3ae172,_0x3aa21c[_0x3dcd28(0x1a2)],_0x3aa21c[_0x3dcd28(0x1ac)],_0x3aa21c[_0x3dcd28(0x14b)]),await this[_0x3dcd28(0x169)](_0x3ae172,_0x3aa21c[_0x3dcd28(0x1a2)]),console['log']('✅\x20Test\x20Gateway\x20payment\x20'+_0x53231f+_0x3dcd28(0x14a)+_0x3aa21c['status']),_0x3aa21c['status']===_0x3dcd28(0x17d)?_0x459230['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3dcd28(0x17d),'transactionId':_0x3aa21c[_0x3dcd28(0x1ac)],'redirectUrl':_0x3ae172[_0x3dcd28(0x16b)]}}):_0x459230[_0x3dcd28(0x1a2)](0x190)[_0x3dcd28(0x192)]({'success':![],'message':_0x3dcd28(0x1a1),'result':{'status':_0x3dcd28(0x18b),'failureReason':_0x3aa21c[_0x3dcd28(0x14b)],'redirectUrl':_0x3ae172[_0x3dcd28(0x19d)]}});}catch(_0x589b8a){_0x4a5130(_0x589b8a);}},this[_0x5c535b(0x151)]=new testGatewayService_1['TestGatewayService'](),this[_0x5c535b(0x197)]=new webhookService_1[(_0x5c535b(0x143))]();}async[a14_0x397c13(0x18e)](_0x1445f5,_0x4dd59a,_0x5adfe0,_0x3ae8d9){const _0x56cc6f=a14_0x397c13,_0x4993f9=Date[_0x56cc6f(0x160)]();try{const _0x25fe78=_0x1445f5[_0x56cc6f(0x157)],_0x117269=_0x25fe78[_0x56cc6f(0x1ad)];if(!_0x117269?.[_0x56cc6f(0x182)]){console[_0x56cc6f(0x14e)](_0x56cc6f(0x198)+_0x25fe78['id']);return;}const _0x3fe59f=_0x4dd59a===_0x56cc6f(0x17d)?_0x56cc6f(0x159):_0x56cc6f(0x17f);let _0x1aa4b0=[];if(_0x117269[_0x56cc6f(0x16f)])try{_0x1aa4b0=Array[_0x56cc6f(0x18d)](_0x117269[_0x56cc6f(0x16f)])?_0x117269[_0x56cc6f(0x16f)]:JSON['parse'](_0x117269[_0x56cc6f(0x16f)]);}catch(_0x1a1900){console[_0x56cc6f(0x179)](_0x56cc6f(0x180),_0x1a1900),_0x1aa4b0=[];}if(!_0x1aa4b0[_0x56cc6f(0x183)](_0x3fe59f)){console[_0x56cc6f(0x14e)](_0x56cc6f(0x189)+_0x3fe59f+_0x56cc6f(0x1b5)+_0x25fe78['id']);return;}const _0x517daf={'event':_0x3fe59f,'payment':{'id':_0x1445f5['id'],'order_id':_0x1445f5[_0x56cc6f(0x18f)],'gateway_order_id':_0x1445f5[_0x56cc6f(0x18a)],'gateway':_0x56cc6f(0x1a4),'amount':_0x1445f5[_0x56cc6f(0x1ab)],'currency':_0x1445f5[_0x56cc6f(0x186)],'status':_0x4dd59a[_0x56cc6f(0x16e)](),'customer_email':_0x1445f5['customerEmail'],'customer_name':_0x1445f5[_0x56cc6f(0x13b)],'transaction_id':_0x5adfe0,'failure_message':_0x3ae8d9,'created_at':_0x1445f5[_0x56cc6f(0x152)],'updated_at':new Date()}},_0x49e5a0=await fetch(_0x117269[_0x56cc6f(0x182)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x56cc6f(0x1b1)](_0x517daf)}),_0x2caf8c=Date['now']()-_0x4993f9;console[_0x56cc6f(0x14e)](_0x56cc6f(0x13f)+_0x117269[_0x56cc6f(0x182)]+_0x56cc6f(0x170)+_0x49e5a0[_0x56cc6f(0x1a2)]+'\x20('+_0x2caf8c+_0x56cc6f(0x199));}catch(_0x3baaab){console[_0x56cc6f(0x179)](_0x56cc6f(0x19b),_0x3baaab);}}async['sendPaymentStatusNotification'](_0x13833d,_0x64c39a){const _0x4a7e0b=a14_0x397c13;try{const {telegramBotService:_0x5d6672}=await Promise[_0x4a7e0b(0x190)]()[_0x4a7e0b(0x16d)](()=>__importStar(require('../services/telegramBotService'))),_0x5c8dad={'PAID':_0x4a7e0b(0x13c),'FAILED':_0x4a7e0b(0x17a)},_0x4e8b95=_0x5c8dad[_0x64c39a];if(!_0x4e8b95)return;await _0x5d6672[_0x4a7e0b(0x14f)](_0x13833d['shopId'],_0x13833d,_0x4e8b95);}catch(_0x1264e2){console[_0x4a7e0b(0x179)](_0x4a7e0b(0x175),_0x1264e2);}}}exports['TestGatewayController']=TestGatewayController;