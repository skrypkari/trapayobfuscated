'use strict';const a13_0x528b0b=a13_0x564b;function a13_0x564b(_0x2494a1,_0x26df8){const _0x388190=a13_0x3881();return a13_0x564b=function(_0x564b63,_0xa3acb5){_0x564b63=_0x564b63-0x98;let _0x2435ad=_0x388190[_0x564b63];return _0x2435ad;},a13_0x564b(_0x2494a1,_0x26df8);}(function(_0x5ea31b,_0xab0ced){const _0x116fb8=a13_0x564b,_0x4063b9=_0x5ea31b();while(!![]){try{const _0x402829=-parseInt(_0x116fb8(0xff))/0x1*(-parseInt(_0x116fb8(0xe4))/0x2)+-parseInt(_0x116fb8(0xdc))/0x3+-parseInt(_0x116fb8(0xa6))/0x4*(parseInt(_0x116fb8(0xc3))/0x5)+parseInt(_0x116fb8(0x101))/0x6+-parseInt(_0x116fb8(0xc7))/0x7*(-parseInt(_0x116fb8(0xb5))/0x8)+-parseInt(_0x116fb8(0xf3))/0x9*(parseInt(_0x116fb8(0xc4))/0xa)+parseInt(_0x116fb8(0xf5))/0xb*(-parseInt(_0x116fb8(0xae))/0xc);if(_0x402829===_0xab0ced)break;else _0x4063b9['push'](_0x4063b9['shift']());}catch(_0xb972d1){_0x4063b9['push'](_0x4063b9['shift']());}}}(a13_0x3881,0x78c0d));var __createBinding=this&&this['__createBinding']||(Object[a13_0x528b0b(0xfd)]?function(_0x3f1de3,_0x5252de,_0x48d597,_0x2a90d8){const _0x54a15e=a13_0x528b0b;if(_0x2a90d8===undefined)_0x2a90d8=_0x48d597;var _0x44e612=Object[_0x54a15e(0x99)](_0x5252de,_0x48d597);(!_0x44e612||(_0x54a15e(0xf7)in _0x44e612?!_0x5252de['__esModule']:_0x44e612[_0x54a15e(0x98)]||_0x44e612['configurable']))&&(_0x44e612={'enumerable':!![],'get':function(){return _0x5252de[_0x48d597];}}),Object[_0x54a15e(0xe2)](_0x3f1de3,_0x2a90d8,_0x44e612);}:function(_0x447944,_0x1e2058,_0x13e7c8,_0x316cda){if(_0x316cda===undefined)_0x316cda=_0x13e7c8;_0x447944[_0x316cda]=_0x1e2058[_0x13e7c8];}),__setModuleDefault=this&&this[a13_0x528b0b(0xbc)]||(Object[a13_0x528b0b(0xfd)]?function(_0x1dbb34,_0x47fe00){const _0x326c59=a13_0x528b0b;Object[_0x326c59(0xe2)](_0x1dbb34,'default',{'enumerable':!![],'value':_0x47fe00});}:function(_0x28de02,_0x567378){const _0x3ee910=a13_0x528b0b;_0x28de02[_0x3ee910(0xcd)]=_0x567378;}),__importStar=this&&this[a13_0x528b0b(0xa0)]||(function(){var _0x47f4a0=function(_0x5940b5){return _0x47f4a0=Object['getOwnPropertyNames']||function(_0x3e7c33){const _0x1caf16=a13_0x564b;var _0x459ee4=[];for(var _0x296b38 in _0x3e7c33)if(Object[_0x1caf16(0xa9)][_0x1caf16(0xc5)][_0x1caf16(0xe7)](_0x3e7c33,_0x296b38))_0x459ee4[_0x459ee4['length']]=_0x296b38;return _0x459ee4;},_0x47f4a0(_0x5940b5);};return function(_0x25782d){const _0x8ac587=a13_0x564b;if(_0x25782d&&_0x25782d['__esModule'])return _0x25782d;var _0x19e1fc={};if(_0x25782d!=null){for(var _0xe02075=_0x47f4a0(_0x25782d),_0x527cb9=0x0;_0x527cb9<_0xe02075[_0x8ac587(0xe6)];_0x527cb9++)if(_0xe02075[_0x527cb9]!==_0x8ac587(0xcd))__createBinding(_0x19e1fc,_0x25782d,_0xe02075[_0x527cb9]);}return __setModuleDefault(_0x19e1fc,_0x25782d),_0x19e1fc;};}()),__importDefault=this&&this[a13_0x528b0b(0xc6)]||function(_0x4652e8){const _0x402bc4=a13_0x528b0b;return _0x4652e8&&_0x4652e8[_0x402bc4(0xec)]?_0x4652e8:{'default':_0x4652e8};};Object[a13_0x528b0b(0xe2)](exports,a13_0x528b0b(0xec),{'value':!![]}),exports[a13_0x528b0b(0xde)]=void 0x0;const testGatewayService_1=require(a13_0x528b0b(0x9a)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x528b0b(0xd1)));function a13_0x3881(){const _0x29ae1e=['customerEmail','amount','payment.success','sendPaymentNotification',':\x20type=','default','📈\x20Test\x20Gateway:\x20Payment\x20','failureReason','json','../config/database','error','transactionId','POST','❌\x20Payment\x20link\x20','stringify','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','../services/telegramBotService','Payment\x20failed','Error\x20parsing\x20webhook\x20events:','PENDING','443889OrUWsZ','resolve','TestGatewayController','testGatewayService','TestGatewayService','test_gateway','defineProperty','\x20with\x20status\x20','869948JanSZO','Payment\x20processed\x20successfully','length','call','Payment\x20status\x20is\x20','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','paymentLink','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__esModule','body','shopId','PAID','Any\x203-4\x20digits','shop','payment','4968261EDAfRO','type','30118jRwcha','✅\x20Test\x20Gateway\x20payment\x20','get','failed','\x20not\x20enabled\x20for\x20shop\x20','successUrl',',\x20status=','currency','create','📈\x20Found\x20payment\x20link\x20','2OlACxT','params','983490UOKxvT','test_gateway_','gatewayOrderId','slice','COMPLETED','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','findUnique','✅\x20Payment\x20link\x20','log','\x20not\x20found','4242\x204242\x204242\x204242','test_card','Any\x20other\x20card\x20number','Any\x20future\x20date\x20(MM/YY)','writable','getOwnPropertyDescriptor','../services/gateways/testGatewayService','SINGLE','paymentLinkId','Payment\x20not\x20found','name','customerName','__importStar','status','update','now','currentPayments','paid','921532ggErkz','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','prototype','paidAt','gateway','includes','🧪\x20Test\x20Gateway\x20result:','1104LkAShQ','isArray','Any\x20name','WebhookService','processCardPayment','createdAt','FAILED','5432NDDXKH','webhookUrl','gatewayPaymentId','toLowerCase','\x20->\x20','$transaction','webhookService','__setModuleDefault','application/json','cardLast4','webhookEvents',',\x20currentPayments=','sendShopWebhook','sendPaymentStatusNotification','5mRoqDQ','10juCbpS','hasOwnProperty','__importDefault','6629pZImos'];a13_0x3881=function(){return _0x29ae1e;};return a13_0x3881();}class TestGatewayController{constructor(){const _0x1e1de4=a13_0x528b0b;this['getPaymentForm']=async(_0x309348,_0x365513,_0x16157d)=>{const _0x53c056=a13_0x564b;try{const {paymentId:_0x483bfb}=_0x309348[_0x53c056(0x100)];console[_0x53c056(0x109)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x483bfb);const _0x3fa370=await database_1['default'][_0x53c056(0xf2)]['findUnique']({'where':{'id':_0x483bfb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3fa370)return _0x365513[_0x53c056(0xa1)](0x194)[_0x53c056(0xd0)]({'success':![],'message':_0x53c056(0x9d)});if(_0x3fa370[_0x53c056(0xab)]!==_0x53c056(0xe1))return _0x365513[_0x53c056(0xa1)](0x190)[_0x53c056(0xd0)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3fa370[_0x53c056(0xa1)]!=='PENDING')return _0x365513[_0x53c056(0xa1)](0x190)[_0x53c056(0xd0)]({'success':![],'message':_0x53c056(0xe8)+_0x3fa370[_0x53c056(0xa1)]+',\x20cannot\x20process'});_0x365513[_0x53c056(0xd0)]({'success':!![],'result':{'paymentId':_0x3fa370['id'],'orderId':_0x3fa370[_0x53c056(0x103)],'amount':_0x3fa370['amount'],'currency':_0x3fa370['currency'],'merchantName':_0x3fa370[_0x53c056(0xf1)][_0x53c056(0x9e)],'description':'Payment\x20to\x20'+_0x3fa370[_0x53c056(0xf1)]['name'],'testInstructions':{'successCard':_0x53c056(0x10b),'failureCard':_0x53c056(0x10d),'expiryDate':_0x53c056(0x10e),'cvc':_0x53c056(0xf0),'holderName':_0x53c056(0xb0)}}});}catch(_0x3995ea){_0x16157d(_0x3995ea);}},this['processCard']=async(_0x4fdfcd,_0x136788,_0x1a261f)=>{const _0x4c823c=a13_0x564b;try{const {paymentId:_0x259617}=_0x4fdfcd[_0x4c823c(0x100)],_0x559587=_0x4fdfcd[_0x4c823c(0xed)];console[_0x4c823c(0x109)](_0x4c823c(0xeb)+_0x259617);const _0x33e96e=await database_1[_0x4c823c(0xcd)]['payment'][_0x4c823c(0x107)]({'where':{'id':_0x259617},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33e96e)return _0x136788[_0x4c823c(0xa1)](0x194)[_0x4c823c(0xd0)]({'success':![],'message':_0x4c823c(0x9d)});if(_0x33e96e[_0x4c823c(0xab)]!==_0x4c823c(0xe1))return _0x136788[_0x4c823c(0xa1)](0x190)[_0x4c823c(0xd0)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x33e96e['status']!==_0x4c823c(0xdb))return _0x136788[_0x4c823c(0xa1)](0x190)[_0x4c823c(0xd0)]({'success':![],'message':_0x4c823c(0xe8)+_0x33e96e[_0x4c823c(0xa1)]+',\x20cannot\x20process'});const _0x2c922f=await this['testGatewayService'][_0x4c823c(0xb2)]({'paymentId':_0x33e96e['id'],'orderId':_0x33e96e[_0x4c823c(0x103)]||_0x33e96e['id'],'amount':_0x33e96e['amount'],'currency':_0x33e96e['currency'],'cardData':_0x559587});console[_0x4c823c(0x109)](_0x4c823c(0xad),_0x2c922f);const _0x61bb02={'status':_0x2c922f[_0x4c823c(0xa1)],'updatedAt':new Date()};if(_0x2c922f['status']===_0x4c823c(0xef))_0x61bb02[_0x4c823c(0xaa)]=new Date(),_0x61bb02[_0x4c823c(0xb7)]=_0x2c922f['transactionId'];else _0x2c922f['status']==='FAILED'&&(_0x61bb02['failureMessage']=_0x2c922f['failureReason']);const _0x1c72cc=_0x559587['cardNumber']['replace'](/[\s-]/g,'');_0x61bb02[_0x4c823c(0xbe)]=_0x1c72cc[_0x4c823c(0x104)](-0x4),_0x61bb02['paymentMethod']=_0x4c823c(0x10c),await database_1[_0x4c823c(0xcd)][_0x4c823c(0xf2)][_0x4c823c(0xa2)]({'where':{'id':_0x33e96e['id']},'data':_0x61bb02});if(_0x2c922f[_0x4c823c(0xa1)]===_0x4c823c(0xef)&&_0x33e96e[_0x4c823c(0x9c)]){console[_0x4c823c(0x109)](_0x4c823c(0xce)+_0x33e96e['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x4c823c(0xcd)][_0x4c823c(0xba)](async _0x4bced2=>{const _0x2e47a3=_0x4c823c,_0x4f0a25=await _0x4bced2[_0x2e47a3(0xea)][_0x2e47a3(0x107)]({'where':{'id':_0x33e96e[_0x2e47a3(0x9c)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4f0a25){console[_0x2e47a3(0x109)](_0x2e47a3(0xfe)+_0x4f0a25['id']+_0x2e47a3(0xcc)+_0x4f0a25['type']+_0x2e47a3(0xc0)+_0x4f0a25[_0x2e47a3(0xa4)]+_0x2e47a3(0xfb)+_0x4f0a25[_0x2e47a3(0xa1)]);const _0x432247=_0x4f0a25[_0x2e47a3(0xa4)]+0x1,_0x16dbc7=_0x4f0a25[_0x2e47a3(0xf4)]===_0x2e47a3(0x9b)?_0x2e47a3(0x105):_0x4f0a25['status'];await _0x4bced2[_0x2e47a3(0xea)][_0x2e47a3(0xa2)]({'where':{'id':_0x33e96e['paymentLinkId']},'data':{'currentPayments':_0x432247,'status':_0x16dbc7,'updatedAt':new Date()}}),console[_0x2e47a3(0x109)](_0x2e47a3(0x108)+_0x4f0a25['id']+'\x20updated:\x20currentPayments='+_0x4f0a25['currentPayments']+'\x20->\x20'+_0x432247+',\x20status='+_0x4f0a25[_0x2e47a3(0xa1)]+_0x2e47a3(0xb9)+_0x16dbc7);}else console[_0x2e47a3(0x109)](_0x2e47a3(0xd5)+_0x33e96e[_0x2e47a3(0x9c)]+_0x2e47a3(0x10a));});}catch(_0xa84a9d){console[_0x4c823c(0xd2)](_0x4c823c(0x106),_0xa84a9d);}}await database_1[_0x4c823c(0xcd)]['webhookLog'][_0x4c823c(0xfd)]({'data':{'paymentId':_0x33e96e['id'],'shopId':_0x33e96e['shopId'],'event':_0x4c823c(0x102)+_0x2c922f['status'][_0x4c823c(0xb8)](),'statusCode':0xc8,'responseBody':JSON[_0x4c823c(0xd6)]({'oldStatus':_0x4c823c(0xdb),'newStatus':_0x2c922f[_0x4c823c(0xa1)],'transactionId':_0x2c922f[_0x4c823c(0xd3)],'failureReason':_0x2c922f['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x4c823c(0xc1)](_0x33e96e,_0x2c922f[_0x4c823c(0xa1)],_0x2c922f[_0x4c823c(0xd3)],_0x2c922f['failureReason']),await this[_0x4c823c(0xc2)](_0x33e96e,_0x2c922f[_0x4c823c(0xa1)]),console[_0x4c823c(0x109)](_0x4c823c(0xf6)+_0x259617+'\x20processed:\x20'+_0x2c922f[_0x4c823c(0xa1)]),_0x2c922f[_0x4c823c(0xa1)]===_0x4c823c(0xef)?_0x136788['json']({'success':!![],'message':_0x4c823c(0xe5),'result':{'status':'PAID','transactionId':_0x2c922f[_0x4c823c(0xd3)],'redirectUrl':_0x33e96e[_0x4c823c(0xfa)]}}):_0x136788[_0x4c823c(0xa1)](0x190)[_0x4c823c(0xd0)]({'success':![],'message':_0x4c823c(0xd9),'result':{'status':_0x4c823c(0xb4),'failureReason':_0x2c922f[_0x4c823c(0xcf)],'redirectUrl':_0x33e96e['failUrl']}});}catch(_0x5cec5b){_0x1a261f(_0x5cec5b);}},this[_0x1e1de4(0xdf)]=new testGatewayService_1[(_0x1e1de4(0xe0))](),this[_0x1e1de4(0xbb)]=new webhookService_1[(_0x1e1de4(0xb1))]();}async['sendShopWebhook'](_0x5293e3,_0x4b73c6,_0x1596a7,_0x117d52){const _0x422be9=a13_0x528b0b,_0x3365b4=Date[_0x422be9(0xa3)]();try{const _0x5a771f=_0x5293e3[_0x422be9(0xf1)],_0x5acd2d=_0x5a771f['settings'];if(!_0x5acd2d?.[_0x422be9(0xb6)]){console['log'](_0x422be9(0xa7)+_0x5a771f['id']);return;}const _0x1c90ad=_0x4b73c6===_0x422be9(0xef)?_0x422be9(0xca):'payment.failed';let _0x5ab5b7=[];if(_0x5acd2d['webhookEvents'])try{_0x5ab5b7=Array[_0x422be9(0xaf)](_0x5acd2d[_0x422be9(0xbf)])?_0x5acd2d[_0x422be9(0xbf)]:JSON['parse'](_0x5acd2d['webhookEvents']);}catch(_0x4a5d37){console[_0x422be9(0xd2)](_0x422be9(0xda),_0x4a5d37),_0x5ab5b7=[];}if(!_0x5ab5b7[_0x422be9(0xac)](_0x1c90ad)){console[_0x422be9(0x109)]('Webhook\x20event\x20'+_0x1c90ad+_0x422be9(0xf9)+_0x5a771f['id']);return;}const _0x513963={'event':_0x1c90ad,'payment':{'id':_0x5293e3['id'],'order_id':_0x5293e3['orderId'],'gateway_order_id':_0x5293e3[_0x422be9(0x103)],'gateway':'0000','amount':_0x5293e3[_0x422be9(0xc9)],'currency':_0x5293e3[_0x422be9(0xfc)],'status':_0x4b73c6[_0x422be9(0xb8)](),'customer_email':_0x5293e3[_0x422be9(0xc8)],'customer_name':_0x5293e3[_0x422be9(0x9f)],'transaction_id':_0x1596a7,'failure_message':_0x117d52,'created_at':_0x5293e3[_0x422be9(0xb3)],'updated_at':new Date()}},_0x781558=await fetch(_0x5acd2d['webhookUrl'],{'method':_0x422be9(0xd4),'headers':{'Content-Type':_0x422be9(0xbd),'User-Agent':_0x422be9(0xe9)},'body':JSON['stringify'](_0x513963)}),_0xe0fee=Date[_0x422be9(0xa3)]()-_0x3365b4;console[_0x422be9(0x109)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x5acd2d[_0x422be9(0xb6)]+_0x422be9(0xe3)+_0x781558['status']+'\x20('+_0xe0fee+'ms)');}catch(_0x32fa28){console[_0x422be9(0xd2)](_0x422be9(0xd7),_0x32fa28);}}async[a13_0x528b0b(0xc2)](_0x30c482,_0x5dc5fd){const _0x2857ec=a13_0x528b0b;try{const {telegramBotService:_0x194429}=await Promise[_0x2857ec(0xdd)]()['then'](()=>__importStar(require(_0x2857ec(0xd8)))),_0x93cb27={'PAID':_0x2857ec(0xa5),'FAILED':_0x2857ec(0xf8)},_0x1c786a=_0x93cb27[_0x5dc5fd];if(!_0x1c786a)return;await _0x194429[_0x2857ec(0xcb)](_0x30c482[_0x2857ec(0xee)],_0x30c482,_0x1c786a);}catch(_0x5a5c2a){console[_0x2857ec(0xd2)](_0x2857ec(0xa8),_0x5a5c2a);}}}exports['TestGatewayController']=TestGatewayController;