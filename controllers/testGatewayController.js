'use strict';const a14_0x5b1ae2=a14_0x22d5;(function(_0xc45438,_0x5e61c7){const _0x306ed7=a14_0x22d5,_0x1fb2a5=_0xc45438();while(!![]){try{const _0x5e52b6=-parseInt(_0x306ed7(0x19a))/0x1*(-parseInt(_0x306ed7(0x14e))/0x2)+parseInt(_0x306ed7(0x172))/0x3+parseInt(_0x306ed7(0x168))/0x4*(parseInt(_0x306ed7(0x157))/0x5)+parseInt(_0x306ed7(0x163))/0x6+-parseInt(_0x306ed7(0x15b))/0x7+-parseInt(_0x306ed7(0x14a))/0x8+-parseInt(_0x306ed7(0x191))/0x9*(parseInt(_0x306ed7(0x140))/0xa);if(_0x5e52b6===_0x5e61c7)break;else _0x1fb2a5['push'](_0x1fb2a5['shift']());}catch(_0x5e8fa7){_0x1fb2a5['push'](_0x1fb2a5['shift']());}}}(a14_0x42b6,0x23882));var __createBinding=this&&this['__createBinding']||(Object[a14_0x5b1ae2(0x19d)]?function(_0x1a5ab5,_0x2510a0,_0x551bc7,_0x2aac69){const _0x1bf43c=a14_0x5b1ae2;if(_0x2aac69===undefined)_0x2aac69=_0x551bc7;var _0x12af6b=Object['getOwnPropertyDescriptor'](_0x2510a0,_0x551bc7);(!_0x12af6b||(_0x1bf43c(0x186)in _0x12af6b?!_0x2510a0[_0x1bf43c(0x176)]:_0x12af6b[_0x1bf43c(0x18b)]||_0x12af6b[_0x1bf43c(0x177)]))&&(_0x12af6b={'enumerable':!![],'get':function(){return _0x2510a0[_0x551bc7];}}),Object[_0x1bf43c(0x180)](_0x1a5ab5,_0x2aac69,_0x12af6b);}:function(_0x111a78,_0x2f0a12,_0x2f1796,_0x110c44){if(_0x110c44===undefined)_0x110c44=_0x2f1796;_0x111a78[_0x110c44]=_0x2f0a12[_0x2f1796];}),__setModuleDefault=this&&this[a14_0x5b1ae2(0x166)]||(Object[a14_0x5b1ae2(0x19d)]?function(_0x626292,_0x1499bd){const _0x2c9094=a14_0x5b1ae2;Object['defineProperty'](_0x626292,_0x2c9094(0x143),{'enumerable':!![],'value':_0x1499bd});}:function(_0x73abaf,_0x1cc551){const _0x5ba2d0=a14_0x5b1ae2;_0x73abaf[_0x5ba2d0(0x143)]=_0x1cc551;}),__importStar=this&&this[a14_0x5b1ae2(0x154)]||(function(){var _0x21ae7a=function(_0xc6eabd){return _0x21ae7a=Object['getOwnPropertyNames']||function(_0x133ac0){const _0x244896=a14_0x22d5;var _0x3810e1=[];for(var _0x37ae65 in _0x133ac0)if(Object[_0x244896(0x16e)][_0x244896(0x144)]['call'](_0x133ac0,_0x37ae65))_0x3810e1[_0x3810e1[_0x244896(0x16f)]]=_0x37ae65;return _0x3810e1;},_0x21ae7a(_0xc6eabd);};return function(_0x138166){const _0x49ef11=a14_0x22d5;if(_0x138166&&_0x138166[_0x49ef11(0x176)])return _0x138166;var _0x58823b={};if(_0x138166!=null){for(var _0x37c1a5=_0x21ae7a(_0x138166),_0x224f86=0x0;_0x224f86<_0x37c1a5[_0x49ef11(0x16f)];_0x224f86++)if(_0x37c1a5[_0x224f86]!==_0x49ef11(0x143))__createBinding(_0x58823b,_0x138166,_0x37c1a5[_0x224f86]);}return __setModuleDefault(_0x58823b,_0x138166),_0x58823b;};}()),__importDefault=this&&this[a14_0x5b1ae2(0x15e)]||function(_0x34f2a1){const _0x3d957d=a14_0x5b1ae2;return _0x34f2a1&&_0x34f2a1[_0x3d957d(0x176)]?_0x34f2a1:{'default':_0x34f2a1};};Object[a14_0x5b1ae2(0x180)](exports,a14_0x5b1ae2(0x176),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a14_0x5b1ae2(0x1b1)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a14_0x5b1ae2(0x159)));function a14_0x22d5(_0x531ed2,_0x253953){const _0x42b6f9=a14_0x42b6();return a14_0x22d5=function(_0x22d58b,_0x30717e){_0x22d58b=_0x22d58b-0x13f;let _0x347a9b=_0x42b6f9[_0x22d58b];return _0x347a9b;},a14_0x22d5(_0x531ed2,_0x253953);}class TestGatewayController{constructor(){const _0x4eaed5=a14_0x5b1ae2;this[_0x4eaed5(0x17e)]=async(_0x449b9c,_0xdeeba3,_0x42481d)=>{const _0x1802a6=_0x4eaed5;try{const {paymentId:_0x3df155}=_0x449b9c[_0x1802a6(0x152)];console[_0x1802a6(0x149)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3df155);const _0x4fd70c=await database_1[_0x1802a6(0x143)][_0x1802a6(0x17c)][_0x1802a6(0x173)]({'where':{'id':_0x3df155},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4fd70c)return _0xdeeba3[_0x1802a6(0x146)](0x194)[_0x1802a6(0x1ac)]({'success':![],'message':_0x1802a6(0x1a7)});if(_0x4fd70c[_0x1802a6(0x153)]!==_0x1802a6(0x19b))return _0xdeeba3[_0x1802a6(0x146)](0x190)[_0x1802a6(0x1ac)]({'success':![],'message':_0x1802a6(0x195)});if(_0x4fd70c[_0x1802a6(0x146)]!==_0x1802a6(0x187))return _0xdeeba3[_0x1802a6(0x146)](0x190)[_0x1802a6(0x1ac)]({'success':![],'message':_0x1802a6(0x1a5)+_0x4fd70c[_0x1802a6(0x146)]+_0x1802a6(0x145)});_0xdeeba3['json']({'success':!![],'result':{'paymentId':_0x4fd70c['id'],'orderId':_0x4fd70c[_0x1802a6(0x171)],'amount':_0x4fd70c['amount'],'currency':_0x4fd70c[_0x1802a6(0x1b0)],'merchantName':_0x4fd70c['shop'][_0x1802a6(0x193)],'description':_0x1802a6(0x170)+_0x4fd70c[_0x1802a6(0x160)][_0x1802a6(0x193)],'testInstructions':{'successCard':_0x1802a6(0x1af),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x1802a6(0x198)}}});}catch(_0x30392d){_0x42481d(_0x30392d);}},this['processCard']=async(_0x39b13f,_0x301128,_0x4e879f)=>{const _0x5dc837=_0x4eaed5;try{const {paymentId:_0x59a923}=_0x39b13f['params'],_0xb51539=_0x39b13f['body'];console['log'](_0x5dc837(0x17b)+_0x59a923);const _0x55bd42=await database_1[_0x5dc837(0x143)][_0x5dc837(0x17c)][_0x5dc837(0x173)]({'where':{'id':_0x59a923},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x55bd42)return _0x301128[_0x5dc837(0x146)](0x194)[_0x5dc837(0x1ac)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x55bd42[_0x5dc837(0x153)]!==_0x5dc837(0x19b))return _0x301128[_0x5dc837(0x146)](0x190)[_0x5dc837(0x1ac)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x55bd42[_0x5dc837(0x146)]!==_0x5dc837(0x187))return _0x301128[_0x5dc837(0x146)](0x190)['json']({'success':![],'message':_0x5dc837(0x1a5)+_0x55bd42[_0x5dc837(0x146)]+_0x5dc837(0x145)});const _0x391f05=await this['testGatewayService'][_0x5dc837(0x179)]({'paymentId':_0x55bd42['id'],'orderId':_0x55bd42[_0x5dc837(0x171)]||_0x55bd42['id'],'amount':_0x55bd42[_0x5dc837(0x19c)],'currency':_0x55bd42['currency'],'cardData':_0xb51539});console[_0x5dc837(0x149)](_0x5dc837(0x192),_0x391f05);const _0x39de11={'status':_0x391f05['status'],'updatedAt':new Date()};if(_0x391f05[_0x5dc837(0x146)]===_0x5dc837(0x183))_0x39de11[_0x5dc837(0x174)]=new Date(),_0x39de11[_0x5dc837(0x1a8)]=_0x391f05[_0x5dc837(0x197)];else _0x391f05[_0x5dc837(0x146)]===_0x5dc837(0x16d)&&(_0x39de11[_0x5dc837(0x17f)]=_0x391f05[_0x5dc837(0x1ae)]);const _0xb0cf08=_0xb51539[_0x5dc837(0x141)][_0x5dc837(0x1a4)](/[\s-]/g,'');_0x39de11[_0x5dc837(0x14b)]=_0xb0cf08[_0x5dc837(0x15c)](-0x4),_0x39de11[_0x5dc837(0x196)]=_0x5dc837(0x158),await database_1[_0x5dc837(0x143)][_0x5dc837(0x17c)]['update']({'where':{'id':_0x55bd42['id']},'data':_0x39de11});if(_0x391f05['status']===_0x5dc837(0x183)&&_0x55bd42[_0x5dc837(0x18e)]){console['log']('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x55bd42['id']+_0x5dc837(0x16c));try{await database_1['default'][_0x5dc837(0x175)](async _0x291fe5=>{const _0x1e82c5=_0x5dc837,_0x2a4d82=await _0x291fe5[_0x1e82c5(0x1a2)][_0x1e82c5(0x173)]({'where':{'id':_0x55bd42[_0x1e82c5(0x18e)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x2a4d82){console[_0x1e82c5(0x149)](_0x1e82c5(0x165)+_0x2a4d82['id']+_0x1e82c5(0x1ad)+_0x2a4d82[_0x1e82c5(0x150)]+',\x20currentPayments='+_0x2a4d82[_0x1e82c5(0x1a6)]+_0x1e82c5(0x194)+_0x2a4d82[_0x1e82c5(0x146)]);const _0x4db809=_0x2a4d82[_0x1e82c5(0x1a6)]+0x1,_0x225839=_0x2a4d82['type']===_0x1e82c5(0x15d)?_0x1e82c5(0x156):_0x2a4d82[_0x1e82c5(0x146)];await _0x291fe5[_0x1e82c5(0x1a2)][_0x1e82c5(0x1a9)]({'where':{'id':_0x55bd42[_0x1e82c5(0x18e)]},'data':{'currentPayments':_0x4db809,'status':_0x225839,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x2a4d82['id']+_0x1e82c5(0x1aa)+_0x2a4d82[_0x1e82c5(0x1a6)]+_0x1e82c5(0x17d)+_0x4db809+_0x1e82c5(0x194)+_0x2a4d82[_0x1e82c5(0x146)]+_0x1e82c5(0x17d)+_0x225839);}else console[_0x1e82c5(0x149)]('‚ùå\x20Payment\x20link\x20'+_0x55bd42['paymentLinkId']+'\x20not\x20found');});}catch(_0x33cc1f){console[_0x5dc837(0x15f)](_0x5dc837(0x188),_0x33cc1f);}}await database_1[_0x5dc837(0x143)][_0x5dc837(0x178)][_0x5dc837(0x19d)]({'data':{'paymentId':_0x55bd42['id'],'shopId':_0x55bd42[_0x5dc837(0x18a)],'event':_0x5dc837(0x167)+_0x391f05[_0x5dc837(0x146)][_0x5dc837(0x15a)](),'statusCode':0xc8,'responseBody':JSON[_0x5dc837(0x14d)]({'oldStatus':_0x5dc837(0x187),'newStatus':_0x391f05[_0x5dc837(0x146)],'transactionId':_0x391f05[_0x5dc837(0x197)],'failureReason':_0x391f05[_0x5dc837(0x1ae)],'processedAt':new Date()[_0x5dc837(0x182)]()})}}),await this[_0x5dc837(0x148)](_0x55bd42,_0x391f05['status'],_0x391f05[_0x5dc837(0x197)],_0x391f05[_0x5dc837(0x1ae)]),await this[_0x5dc837(0x190)](_0x55bd42,_0x391f05[_0x5dc837(0x146)]),console['log']('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x59a923+_0x5dc837(0x1a0)+_0x391f05['status']),_0x391f05['status']===_0x5dc837(0x183)?_0x301128[_0x5dc837(0x1ac)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x391f05['transactionId'],'redirectUrl':_0x55bd42['successUrl']}}):_0x301128[_0x5dc837(0x146)](0x190)[_0x5dc837(0x1ac)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x391f05[_0x5dc837(0x1ae)],'redirectUrl':_0x55bd42[_0x5dc837(0x1a3)]}});}catch(_0x1db109){_0x4e879f(_0x1db109);}},this['testGatewayService']=new testGatewayService_1[(_0x4eaed5(0x18c))](),this[_0x4eaed5(0x19f)]=new webhookService_1[(_0x4eaed5(0x18f))]();}async[a14_0x5b1ae2(0x148)](_0x21bd2f,_0x7e1a94,_0x1a712f,_0x3157f8){const _0x1386de=a14_0x5b1ae2,_0x42422d=Date[_0x1386de(0x18d)]();try{const _0x325867=_0x21bd2f['shop'],_0x3655a5=_0x325867[_0x1386de(0x1a1)];if(!_0x3655a5?.[_0x1386de(0x169)]){console[_0x1386de(0x149)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x325867['id']);return;}const _0x54283b=_0x7e1a94==='PAID'?'payment.success':_0x1386de(0x16a);let _0x113fe8=[];if(_0x3655a5[_0x1386de(0x17a)])try{_0x113fe8=Array['isArray'](_0x3655a5[_0x1386de(0x17a)])?_0x3655a5[_0x1386de(0x17a)]:JSON[_0x1386de(0x16b)](_0x3655a5[_0x1386de(0x17a)]);}catch(_0x3e2879){console[_0x1386de(0x15f)]('Error\x20parsing\x20webhook\x20events:',_0x3e2879),_0x113fe8=[];}if(!_0x113fe8[_0x1386de(0x184)](_0x54283b)){console['log'](_0x1386de(0x199)+_0x54283b+_0x1386de(0x162)+_0x325867['id']);return;}const _0x5eaa8f={'event':_0x54283b,'payment':{'id':_0x21bd2f['id'],'order_id':_0x21bd2f[_0x1386de(0x161)],'gateway_order_id':_0x21bd2f[_0x1386de(0x171)],'gateway':_0x1386de(0x151),'amount':_0x21bd2f[_0x1386de(0x19c)],'currency':_0x21bd2f['currency'],'status':_0x7e1a94[_0x1386de(0x15a)](),'customer_email':_0x21bd2f['customerEmail'],'customer_name':_0x21bd2f[_0x1386de(0x155)],'transaction_id':_0x1a712f,'failure_message':_0x3157f8,'created_at':_0x21bd2f[_0x1386de(0x181)],'updated_at':new Date()}},_0x2713c1=await fetch(_0x3655a5['webhookUrl'],{'method':_0x1386de(0x1b3),'headers':{'Content-Type':'application/json','User-Agent':_0x1386de(0x147)},'body':JSON[_0x1386de(0x14d)](_0x5eaa8f)}),_0x4cc113=Date['now']()-_0x42422d;console['log'](_0x1386de(0x1b2)+_0x3655a5[_0x1386de(0x169)]+_0x1386de(0x19e)+_0x2713c1['status']+'\x20('+_0x4cc113+_0x1386de(0x14f));}catch(_0x106414){console[_0x1386de(0x15f)](_0x1386de(0x185),_0x106414);}}async[a14_0x5b1ae2(0x190)](_0x290db2,_0xdb90f){const _0x329164=a14_0x5b1ae2;try{const {telegramBotService:_0x586c0e}=await Promise[_0x329164(0x142)]()['then'](()=>__importStar(require(_0x329164(0x164)))),_0x3acfe2={'PAID':_0x329164(0x189),'FAILED':_0x329164(0x1ab)},_0x180e5a=_0x3acfe2[_0xdb90f];if(!_0x180e5a)return;await _0x586c0e[_0x329164(0x14c)](_0x290db2[_0x329164(0x18a)],_0x290db2,_0x180e5a);}catch(_0x3b7995){console[_0x329164(0x15f)](_0x329164(0x13f),_0x3b7995);}}}exports['TestGatewayController']=TestGatewayController;function a14_0x42b6(){const _0x1f8156=['slice','SINGLE','__importDefault','error','shop','orderId','\x20not\x20enabled\x20for\x20shop\x20','431298odOejm','../services/telegramBotService','üìà\x20Found\x20payment\x20link\x20','__setModuleDefault','test_gateway_','108720TlxmzH','webhookUrl','payment.failed','parse','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','FAILED','prototype','length','Payment\x20to\x20','gatewayOrderId','803370TgQfJw','findUnique','paidAt','$transaction','__esModule','configurable','webhookLog','processCardPayment','webhookEvents','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','payment','\x20->\x20','getPaymentForm','failureMessage','defineProperty','createdAt','toISOString','PAID','includes','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','get','PENDING','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','paid','shopId','writable','TestGatewayService','now','paymentLinkId','WebhookService','sendPaymentStatusNotification','32589FiBucm','üß™\x20Test\x20Gateway\x20result:','name',',\x20status=','Payment\x20is\x20not\x20for\x20test\x20gateway','paymentMethod','transactionId','Any\x20name','Webhook\x20event\x20','17NXzYWI','test_gateway','amount','create','\x20with\x20status\x20','webhookService','\x20processed:\x20','settings','paymentLink','failUrl','replace','Payment\x20status\x20is\x20','currentPayments','Payment\x20not\x20found','gatewayPaymentId','update','\x20updated:\x20currentPayments=','failed','json',':\x20type=','failureReason','4242\x204242\x204242\x204242','currency','../services/gateways/testGatewayService','Test\x20Gateway\x20webhook\x20sent\x20to\x20','POST','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','280ezhASc','cardNumber','resolve','default','hasOwnProperty',',\x20cannot\x20process','status','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','sendShopWebhook','log','93736UUPfve','cardLast4','sendPaymentNotification','stringify','7114jDxRxB','ms)','type','0000','params','gateway','__importStar','customerName','COMPLETED','25RHgFPw','test_card','../config/database','toLowerCase','1941793XOjEko'];a14_0x42b6=function(){return _0x1f8156;};return a14_0x42b6();}