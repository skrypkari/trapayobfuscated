'use strict';const a19_0x2b2051=a19_0x1609;(function(_0x541de6,_0x5ca94e){const _0x351084=a19_0x1609,_0x294f4f=_0x541de6();while(!![]){try{const _0x47f853=-parseInt(_0x351084(0x1e1))/0x1*(-parseInt(_0x351084(0x1c6))/0x2)+parseInt(_0x351084(0x1ff))/0x3*(parseInt(_0x351084(0x1ca))/0x4)+parseInt(_0x351084(0x213))/0x5*(parseInt(_0x351084(0x1db))/0x6)+-parseInt(_0x351084(0x218))/0x7*(parseInt(_0x351084(0x1d1))/0x8)+-parseInt(_0x351084(0x221))/0x9+-parseInt(_0x351084(0x1d0))/0xa+-parseInt(_0x351084(0x222))/0xb*(parseInt(_0x351084(0x1d5))/0xc);if(_0x47f853===_0x5ca94e)break;else _0x294f4f['push'](_0x294f4f['shift']());}catch(_0x221e38){_0x294f4f['push'](_0x294f4f['shift']());}}}(a19_0x43c8,0xdfe97));function a19_0x1609(_0x17b3e2,_0x1ce330){_0x17b3e2=_0x17b3e2-0x1b4;const _0x43c8cf=a19_0x43c8();let _0x160978=_0x43c8cf[_0x17b3e2];return _0x160978;}function a19_0x43c8(){const _0x5ba052=['webhookLog','gatewayOrderId','orderId','../services/telegramBotService','webhookService','default','Payment\x20status\x20is\x20','sendPaymentNotification','test_card','245faTLWg','update','__importDefault','length','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','1150156TgFNHi','gateway','findUnique','üìà\x20Found\x20payment\x20link\x20','COMPLETED','Payment\x20is\x20not\x20for\x20test\x20gateway','toISOString','__esModule','../services/gateways/testGatewayService','11315916pVeXbd','535073DhuoHA','application/json','successUrl','$transaction','Payment\x20failed','__setModuleDefault','PAID','create',',\x20status=','WebhookService','transactionId','\x20updated:\x20currentPayments=','0000','\x20->\x20','paymentLinkId','failureReason','paid',',\x20currentPayments=','PENDING','failureMessage','payment.failed','Any\x20future\x20date\x20(MM/YY)','webhookUrl','isArray','sendPaymentStatusNotification','16YSqRxi','\x20not\x20enabled\x20for\x20shop\x20','cardNumber','__importStar','33212hJMRxF','call','currency','body','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','error','2313090deTeTy','32WukUAR','\x20not\x20found','paidAt','now','108wgaVKw','failed','../config/database','shop','writable','test_gateway','158568vgiIIW','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Any\x20other\x20card\x20number','Payment\x20not\x20found','type','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','125236ohWoKK','parse','amount','TestGatewayController','getOwnPropertyDescriptor','prototype','webhookEvents','hasOwnProperty','name','cardLast4','\x20with\x20status\x20','log','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','params',':\x20type=','shopId','failUrl','currentPayments','Payment\x20to\x20','defineProperty','status','üìà\x20Test\x20Gateway:\x20Payment\x20','payment.success','json','gatewayPaymentId','getOwnPropertyNames','replace','customerName','‚úÖ\x20Payment\x20link\x20','üß™\x20Test\x20Gateway\x20result:','435ZcUnfq','‚úÖ\x20Test\x20Gateway\x20payment\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Webhook\x20event\x20','stringify','paymentMethod','toLowerCase',',\x20cannot\x20process','sendShopWebhook','Any\x203-4\x20digits','testGatewayService'];a19_0x43c8=function(){return _0x5ba052;};return a19_0x43c8();}var __createBinding=this&&this['__createBinding']||(Object[a19_0x2b2051(0x1b4)]?function(_0xcecc4d,_0x2a95e8,_0x3a0bb3,_0x510a27){const _0x43e01b=a19_0x2b2051;if(_0x510a27===undefined)_0x510a27=_0x3a0bb3;var _0x4c0c7b=Object[_0x43e01b(0x1e5)](_0x2a95e8,_0x3a0bb3);(!_0x4c0c7b||('get'in _0x4c0c7b?!_0x2a95e8[_0x43e01b(0x21f)]:_0x4c0c7b[_0x43e01b(0x1d9)]||_0x4c0c7b['configurable']))&&(_0x4c0c7b={'enumerable':!![],'get':function(){return _0x2a95e8[_0x3a0bb3];}}),Object[_0x43e01b(0x1f4)](_0xcecc4d,_0x510a27,_0x4c0c7b);}:function(_0xda58cc,_0x44fad3,_0x52991c,_0x15516e){if(_0x15516e===undefined)_0x15516e=_0x52991c;_0xda58cc[_0x15516e]=_0x44fad3[_0x52991c];}),__setModuleDefault=this&&this[a19_0x2b2051(0x227)]||(Object[a19_0x2b2051(0x1b4)]?function(_0x243d3a,_0x1ad650){const _0x351e5a=a19_0x2b2051;Object[_0x351e5a(0x1f4)](_0x243d3a,_0x351e5a(0x20f),{'enumerable':!![],'value':_0x1ad650});}:function(_0x426d96,_0x593eac){_0x426d96['default']=_0x593eac;}),__importStar=this&&this[a19_0x2b2051(0x1c9)]||(function(){var _0x3d4d1b=function(_0xa4b4f2){const _0x511030=a19_0x1609;return _0x3d4d1b=Object[_0x511030(0x1fa)]||function(_0x48e514){const _0x297a26=_0x511030;var _0x2188f5=[];for(var _0x597517 in _0x48e514)if(Object[_0x297a26(0x1e6)][_0x297a26(0x1e8)][_0x297a26(0x1cb)](_0x48e514,_0x597517))_0x2188f5[_0x2188f5['length']]=_0x597517;return _0x2188f5;},_0x3d4d1b(_0xa4b4f2);};return function(_0x43066f){const _0x18d7d9=a19_0x1609;if(_0x43066f&&_0x43066f[_0x18d7d9(0x21f)])return _0x43066f;var _0x1c6d8e={};if(_0x43066f!=null){for(var _0x3bf55a=_0x3d4d1b(_0x43066f),_0x669c1f=0x0;_0x669c1f<_0x3bf55a[_0x18d7d9(0x216)];_0x669c1f++)if(_0x3bf55a[_0x669c1f]!==_0x18d7d9(0x20f))__createBinding(_0x1c6d8e,_0x43066f,_0x3bf55a[_0x669c1f]);}return __setModuleDefault(_0x1c6d8e,_0x43066f),_0x1c6d8e;};}()),__importDefault=this&&this[a19_0x2b2051(0x215)]||function(_0x3835d0){return _0x3835d0&&_0x3835d0['__esModule']?_0x3835d0:{'default':_0x3835d0};};Object[a19_0x2b2051(0x1f4)](exports,a19_0x2b2051(0x21f),{'value':!![]}),exports[a19_0x2b2051(0x1e4)]=void 0x0;const testGatewayService_1=require(a19_0x2b2051(0x220)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a19_0x2b2051(0x1d7)));class TestGatewayController{constructor(){const _0x585de9=a19_0x2b2051;this['getPaymentForm']=async(_0x1016bf,_0x3284e1,_0x106d95)=>{const _0x466189=a19_0x1609;try{const {paymentId:_0x266502}=_0x1016bf[_0x466189(0x1ee)];console[_0x466189(0x1ec)](_0x466189(0x217)+_0x266502);const _0x5b0a44=await database_1['default']['payment'][_0x466189(0x21a)]({'where':{'id':_0x266502},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5b0a44)return _0x3284e1['status'](0x194)[_0x466189(0x1f8)]({'success':![],'message':_0x466189(0x1de)});if(_0x5b0a44[_0x466189(0x219)]!==_0x466189(0x1da))return _0x3284e1[_0x466189(0x1f5)](0x190)[_0x466189(0x1f8)]({'success':![],'message':_0x466189(0x21d)});if(_0x5b0a44[_0x466189(0x1f5)]!==_0x466189(0x1bf))return _0x3284e1['status'](0x190)['json']({'success':![],'message':_0x466189(0x210)+_0x5b0a44[_0x466189(0x1f5)]+_0x466189(0x206)});_0x3284e1['json']({'success':!![],'result':{'paymentId':_0x5b0a44['id'],'orderId':_0x5b0a44[_0x466189(0x20b)],'amount':_0x5b0a44[_0x466189(0x1e3)],'currency':_0x5b0a44[_0x466189(0x1cc)],'merchantName':_0x5b0a44[_0x466189(0x1d8)][_0x466189(0x1e9)],'description':_0x466189(0x1f3)+_0x5b0a44[_0x466189(0x1d8)][_0x466189(0x1e9)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x466189(0x1dd),'expiryDate':_0x466189(0x1c2),'cvc':_0x466189(0x208),'holderName':'Any\x20name'}}});}catch(_0x58efdf){_0x106d95(_0x58efdf);}},this['processCard']=async(_0x41e716,_0x257e9a,_0x1808c2)=>{const _0x4e6901=a19_0x1609;try{const {paymentId:_0xc60eff}=_0x41e716[_0x4e6901(0x1ee)],_0x16d1dc=_0x41e716[_0x4e6901(0x1cd)];console[_0x4e6901(0x1ec)](_0x4e6901(0x1ed)+_0xc60eff);const _0x3e2577=await database_1[_0x4e6901(0x20f)]['payment']['findUnique']({'where':{'id':_0xc60eff},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3e2577)return _0x257e9a[_0x4e6901(0x1f5)](0x194)[_0x4e6901(0x1f8)]({'success':![],'message':_0x4e6901(0x1de)});if(_0x3e2577['gateway']!==_0x4e6901(0x1da))return _0x257e9a[_0x4e6901(0x1f5)](0x190)['json']({'success':![],'message':_0x4e6901(0x21d)});if(_0x3e2577['status']!==_0x4e6901(0x1bf))return _0x257e9a[_0x4e6901(0x1f5)](0x190)[_0x4e6901(0x1f8)]({'success':![],'message':_0x4e6901(0x210)+_0x3e2577[_0x4e6901(0x1f5)]+_0x4e6901(0x206)});const _0x411585=await this[_0x4e6901(0x209)]['processCardPayment']({'paymentId':_0x3e2577['id'],'orderId':_0x3e2577[_0x4e6901(0x20b)]||_0x3e2577['id'],'amount':_0x3e2577[_0x4e6901(0x1e3)],'currency':_0x3e2577['currency'],'cardData':_0x16d1dc});console['log'](_0x4e6901(0x1fe),_0x411585);const _0x1efb17={'status':_0x411585[_0x4e6901(0x1f5)],'updatedAt':new Date()};if(_0x411585[_0x4e6901(0x1f5)]===_0x4e6901(0x228))_0x1efb17[_0x4e6901(0x1d3)]=new Date(),_0x1efb17[_0x4e6901(0x1f9)]=_0x411585[_0x4e6901(0x1b7)];else _0x411585['status']==='FAILED'&&(_0x1efb17[_0x4e6901(0x1c0)]=_0x411585['failureReason']);const _0x14e806=_0x16d1dc[_0x4e6901(0x1c8)][_0x4e6901(0x1fb)](/[\s-]/g,'');_0x1efb17[_0x4e6901(0x1ea)]=_0x14e806['slice'](-0x4),_0x1efb17[_0x4e6901(0x204)]=_0x4e6901(0x212),await database_1[_0x4e6901(0x20f)]['payment']['update']({'where':{'id':_0x3e2577['id']},'data':_0x1efb17});if(_0x411585[_0x4e6901(0x1f5)]===_0x4e6901(0x228)&&_0x3e2577[_0x4e6901(0x1bb)]){console[_0x4e6901(0x1ec)](_0x4e6901(0x1f6)+_0x3e2577['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0x4e6901(0x225)](async _0x59f987=>{const _0x4001fb=_0x4e6901,_0x1ead3f=await _0x59f987['paymentLink']['findUnique']({'where':{'id':_0x3e2577[_0x4001fb(0x1bb)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1ead3f){console['log'](_0x4001fb(0x21b)+_0x1ead3f['id']+_0x4001fb(0x1ef)+_0x1ead3f[_0x4001fb(0x1df)]+_0x4001fb(0x1be)+_0x1ead3f[_0x4001fb(0x1f2)]+_0x4001fb(0x1b5)+_0x1ead3f[_0x4001fb(0x1f5)]);const _0x155a8a=_0x1ead3f[_0x4001fb(0x1f2)]+0x1,_0x58711c=_0x1ead3f[_0x4001fb(0x1df)]==='SINGLE'?_0x4001fb(0x21c):_0x1ead3f[_0x4001fb(0x1f5)];await _0x59f987['paymentLink'][_0x4001fb(0x214)]({'where':{'id':_0x3e2577[_0x4001fb(0x1bb)]},'data':{'currentPayments':_0x155a8a,'status':_0x58711c,'updatedAt':new Date()}}),console[_0x4001fb(0x1ec)](_0x4001fb(0x1fd)+_0x1ead3f['id']+_0x4001fb(0x1b8)+_0x1ead3f[_0x4001fb(0x1f2)]+_0x4001fb(0x1ba)+_0x155a8a+',\x20status='+_0x1ead3f[_0x4001fb(0x1f5)]+'\x20->\x20'+_0x58711c);}else console[_0x4001fb(0x1ec)]('‚ùå\x20Payment\x20link\x20'+_0x3e2577[_0x4001fb(0x1bb)]+_0x4001fb(0x1d2));});}catch(_0x1cfb1e){console[_0x4e6901(0x1cf)](_0x4e6901(0x1dc),_0x1cfb1e);}}await database_1[_0x4e6901(0x20f)][_0x4e6901(0x20a)][_0x4e6901(0x1b4)]({'data':{'paymentId':_0x3e2577['id'],'shopId':_0x3e2577[_0x4e6901(0x1f0)],'event':'test_gateway_'+_0x411585['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x411585[_0x4e6901(0x1f5)],'transactionId':_0x411585['transactionId'],'failureReason':_0x411585[_0x4e6901(0x1bc)],'processedAt':new Date()[_0x4e6901(0x21e)]()})}}),await this['sendShopWebhook'](_0x3e2577,_0x411585[_0x4e6901(0x1f5)],_0x411585[_0x4e6901(0x1b7)],_0x411585[_0x4e6901(0x1bc)]),await this[_0x4e6901(0x1c5)](_0x3e2577,_0x411585[_0x4e6901(0x1f5)]),console[_0x4e6901(0x1ec)](_0x4e6901(0x200)+_0xc60eff+'\x20processed:\x20'+_0x411585[_0x4e6901(0x1f5)]),_0x411585['status']===_0x4e6901(0x228)?_0x257e9a['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x4e6901(0x228),'transactionId':_0x411585[_0x4e6901(0x1b7)],'redirectUrl':_0x3e2577[_0x4e6901(0x224)]}}):_0x257e9a[_0x4e6901(0x1f5)](0x190)[_0x4e6901(0x1f8)]({'success':![],'message':_0x4e6901(0x226),'result':{'status':'FAILED','failureReason':_0x411585[_0x4e6901(0x1bc)],'redirectUrl':_0x3e2577[_0x4e6901(0x1f1)]}});}catch(_0x15035d){_0x1808c2(_0x15035d);}},this[_0x585de9(0x209)]=new testGatewayService_1['TestGatewayService'](),this[_0x585de9(0x20e)]=new webhookService_1[(_0x585de9(0x1b6))]();}async[a19_0x2b2051(0x207)](_0x344e5b,_0x42ab23,_0x1cb90d,_0x5ee422){const _0x2bc88c=a19_0x2b2051,_0x2bc818=Date['now']();try{const _0x272154=_0x344e5b['shop'],_0xae657f=_0x272154['settings'];if(!_0xae657f?.[_0x2bc88c(0x1c3)]){console[_0x2bc88c(0x1ec)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x272154['id']);return;}const _0x2cfe48=_0x42ab23===_0x2bc88c(0x228)?_0x2bc88c(0x1f7):_0x2bc88c(0x1c1);let _0xee4c70=[];if(_0xae657f[_0x2bc88c(0x1e7)])try{_0xee4c70=Array[_0x2bc88c(0x1c4)](_0xae657f[_0x2bc88c(0x1e7)])?_0xae657f['webhookEvents']:JSON[_0x2bc88c(0x1e2)](_0xae657f['webhookEvents']);}catch(_0x4a3425){console[_0x2bc88c(0x1cf)]('Error\x20parsing\x20webhook\x20events:',_0x4a3425),_0xee4c70=[];}if(!_0xee4c70['includes'](_0x2cfe48)){console[_0x2bc88c(0x1ec)](_0x2bc88c(0x202)+_0x2cfe48+_0x2bc88c(0x1c7)+_0x272154['id']);return;}const _0x184412={'event':_0x2cfe48,'payment':{'id':_0x344e5b['id'],'order_id':_0x344e5b[_0x2bc88c(0x20c)],'gateway_order_id':_0x344e5b['gatewayOrderId'],'gateway':_0x2bc88c(0x1b9),'amount':_0x344e5b['amount'],'currency':_0x344e5b[_0x2bc88c(0x1cc)],'status':_0x42ab23[_0x2bc88c(0x205)](),'customer_email':_0x344e5b['customerEmail'],'customer_name':_0x344e5b[_0x2bc88c(0x1fc)],'transaction_id':_0x1cb90d,'failure_message':_0x5ee422,'created_at':_0x344e5b['createdAt'],'updated_at':new Date()}},_0x53d350=await fetch(_0xae657f['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x2bc88c(0x223),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x2bc88c(0x203)](_0x184412)}),_0x289235=Date[_0x2bc88c(0x1d4)]()-_0x2bc818;console[_0x2bc88c(0x1ec)](_0x2bc88c(0x201)+_0xae657f[_0x2bc88c(0x1c3)]+_0x2bc88c(0x1eb)+_0x53d350['status']+'\x20('+_0x289235+'ms)');}catch(_0x883040){console[_0x2bc88c(0x1cf)](_0x2bc88c(0x1e0),_0x883040);}}async[a19_0x2b2051(0x1c5)](_0x506be0,_0x2607ef){const _0x15d3ba=a19_0x2b2051;try{const {telegramBotService:_0xb35b88}=await Promise['resolve']()['then'](()=>__importStar(require(_0x15d3ba(0x20d)))),_0x321cf9={'PAID':_0x15d3ba(0x1bd),'FAILED':_0x15d3ba(0x1d6)},_0x255565=_0x321cf9[_0x2607ef];if(!_0x255565)return;await _0xb35b88[_0x15d3ba(0x211)](_0x506be0['shopId'],_0x506be0,_0x255565);}catch(_0x16fff1){console[_0x15d3ba(0x1cf)](_0x15d3ba(0x1ce),_0x16fff1);}}}exports[a19_0x2b2051(0x1e4)]=TestGatewayController;