'use strict';const a13_0x19f204=a13_0x1b6f;(function(_0x416de1,_0x5aff1b){const _0x5bcdef=a13_0x1b6f,_0x401d9d=_0x416de1();while(!![]){try{const _0x5d6452=parseInt(_0x5bcdef(0x16c))/0x1+parseInt(_0x5bcdef(0x129))/0x2+-parseInt(_0x5bcdef(0x120))/0x3+parseInt(_0x5bcdef(0x13b))/0x4*(parseInt(_0x5bcdef(0x11e))/0x5)+parseInt(_0x5bcdef(0x15f))/0x6*(-parseInt(_0x5bcdef(0x126))/0x7)+-parseInt(_0x5bcdef(0x10f))/0x8*(parseInt(_0x5bcdef(0x138))/0x9)+parseInt(_0x5bcdef(0x147))/0xa;if(_0x5d6452===_0x5aff1b)break;else _0x401d9d['push'](_0x401d9d['shift']());}catch(_0x273c3e){_0x401d9d['push'](_0x401d9d['shift']());}}}(a13_0xe4d7,0x1bf0a));function a13_0xe4d7(){const _0x387b58=['parse','Error\x20parsing\x20webhook\x20events:','TestGatewayService','shop','testGatewayService','Payment\x20processed\x20successfully','88805SugSeV','\x20not\x20enabled\x20for\x20shop\x20','462426mitrjm','\x20processed:\x20','createdAt','update','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','PENDING','22834JPDnOg','toLowerCase','getPaymentForm','421360cNVOTZ','findUnique','includes','params','name','body','hasOwnProperty','WebhookService','log','writable','ðŸ§ª\x20Test\x20Gateway\x20result:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getOwnPropertyNames','settings','Payment\x20status\x20is\x20','35667ebrhKH','get','cardLast4','4wteRyA',',\x20cannot\x20process','length','TestGatewayController','../services/telegramBotService','gateway','getOwnPropertyDescriptor','defineProperty','test_gateway','status','Webhook\x20event\x20','shopId','3734440mEJxWY','webhookEvents','processCard','4242\x204242\x204242\x204242','customerName','Any\x20future\x20date\x20(MM/YY)','isArray','test_card','Payment\x20is\x20not\x20for\x20test\x20gateway','PAID','gatewayOrderId','sendPaymentStatusNotification','webhookLog','paymentMethod','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importStar','Any\x203-4\x20digits','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/webhookService','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','successUrl','payment','../config/database','FAILED','414PauCht','Payment\x20to\x20','sendPaymentNotification','âœ…\x20Test\x20Gateway\x20payment\x20','transactionId','failureMessage','default','gatewayPaymentId','Payment\x20not\x20found','json','0000','__esModule','POST','46334yMzXSu','failed','replace','cardNumber','error','slice','currency','../services/gateways/testGatewayService','create','__setModuleDefault','payment.failed','paidAt','stringify','sendShopWebhook','__createBinding','312ISYxVq','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','prototype','failureReason','call','amount','webhookUrl','orderId','paid'];a13_0xe4d7=function(){return _0x387b58;};return a13_0xe4d7();}var __createBinding=this&&this[a13_0x19f204(0x10e)]||(Object[a13_0x19f204(0x108)]?function(_0x2c4564,_0x1b160b,_0x2f0a12,_0xc99dc8){const _0x1dc234=a13_0x19f204;if(_0xc99dc8===undefined)_0xc99dc8=_0x2f0a12;var _0x3f77ac=Object[_0x1dc234(0x141)](_0x1b160b,_0x2f0a12);(!_0x3f77ac||(_0x1dc234(0x139)in _0x3f77ac?!_0x1b160b[_0x1dc234(0x16a)]:_0x3f77ac[_0x1dc234(0x132)]||_0x3f77ac['configurable']))&&(_0x3f77ac={'enumerable':!![],'get':function(){return _0x1b160b[_0x2f0a12];}}),Object[_0x1dc234(0x142)](_0x2c4564,_0xc99dc8,_0x3f77ac);}:function(_0x25701a,_0x202f42,_0xb063e4,_0x446a73){if(_0x446a73===undefined)_0x446a73=_0xb063e4;_0x25701a[_0x446a73]=_0x202f42[_0xb063e4];}),__setModuleDefault=this&&this[a13_0x19f204(0x109)]||(Object[a13_0x19f204(0x108)]?function(_0x36925d,_0x52202d){const _0x4533eb=a13_0x19f204;Object[_0x4533eb(0x142)](_0x36925d,'default',{'enumerable':!![],'value':_0x52202d});}:function(_0x1bfa51,_0x296810){const _0x5626db=a13_0x19f204;_0x1bfa51[_0x5626db(0x165)]=_0x296810;}),__importStar=this&&this[a13_0x19f204(0x156)]||(function(){var _0x41b76c=function(_0x54fd0d){const _0x438eba=a13_0x1b6f;return _0x41b76c=Object[_0x438eba(0x135)]||function(_0x463044){const _0x4eda96=_0x438eba;var _0x53ef8c=[];for(var _0x25cd73 in _0x463044)if(Object[_0x4eda96(0x111)][_0x4eda96(0x12f)][_0x4eda96(0x113)](_0x463044,_0x25cd73))_0x53ef8c[_0x53ef8c[_0x4eda96(0x13d)]]=_0x25cd73;return _0x53ef8c;},_0x41b76c(_0x54fd0d);};return function(_0x42ce20){const _0x48b05c=a13_0x1b6f;if(_0x42ce20&&_0x42ce20[_0x48b05c(0x16a)])return _0x42ce20;var _0x335e65={};if(_0x42ce20!=null){for(var _0x2f5834=_0x41b76c(_0x42ce20),_0x28a17c=0x0;_0x28a17c<_0x2f5834[_0x48b05c(0x13d)];_0x28a17c++)if(_0x2f5834[_0x28a17c]!=='default')__createBinding(_0x335e65,_0x42ce20,_0x2f5834[_0x28a17c]);}return __setModuleDefault(_0x335e65,_0x42ce20),_0x335e65;};}()),__importDefault=this&&this['__importDefault']||function(_0x41d0de){const _0x4fdd13=a13_0x19f204;return _0x41d0de&&_0x41d0de[_0x4fdd13(0x16a)]?_0x41d0de:{'default':_0x41d0de};};Object[a13_0x19f204(0x142)](exports,'__esModule',{'value':!![]}),exports[a13_0x19f204(0x13e)]=void 0x0;function a13_0x1b6f(_0x2335f9,_0x470b1b){const _0xe4d765=a13_0xe4d7();return a13_0x1b6f=function(_0x1b6fd6,_0x32ec5c){_0x1b6fd6=_0x1b6fd6-0x103;let _0xa3bdf8=_0xe4d765[_0x1b6fd6];return _0xa3bdf8;},a13_0x1b6f(_0x2335f9,_0x470b1b);}const testGatewayService_1=require(a13_0x19f204(0x107)),webhookService_1=require(a13_0x19f204(0x159)),database_1=__importDefault(require(a13_0x19f204(0x15d)));class TestGatewayController{constructor(){const _0x47d578=a13_0x19f204;this[_0x47d578(0x128)]=async(_0x171cab,_0x40645e,_0x14bfbd)=>{const _0x136d7e=_0x47d578;try{const {paymentId:_0x4cb24e}=_0x171cab[_0x136d7e(0x12c)];console[_0x136d7e(0x131)](_0x136d7e(0x124)+_0x4cb24e);const _0x4cec17=await database_1[_0x136d7e(0x165)][_0x136d7e(0x15c)][_0x136d7e(0x12a)]({'where':{'id':_0x4cb24e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4cec17)return _0x40645e[_0x136d7e(0x144)](0x194)[_0x136d7e(0x168)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x4cec17[_0x136d7e(0x140)]!==_0x136d7e(0x143))return _0x40645e[_0x136d7e(0x144)](0x190)[_0x136d7e(0x168)]({'success':![],'message':_0x136d7e(0x14f)});if(_0x4cec17['status']!=='PENDING')return _0x40645e['status'](0x190)[_0x136d7e(0x168)]({'success':![],'message':_0x136d7e(0x137)+_0x4cec17[_0x136d7e(0x144)]+_0x136d7e(0x13c)});_0x40645e['json']({'success':!![],'result':{'paymentId':_0x4cec17['id'],'orderId':_0x4cec17['gatewayOrderId'],'amount':_0x4cec17[_0x136d7e(0x114)],'currency':_0x4cec17[_0x136d7e(0x106)],'merchantName':_0x4cec17[_0x136d7e(0x11b)][_0x136d7e(0x12d)],'description':_0x136d7e(0x160)+_0x4cec17[_0x136d7e(0x11b)][_0x136d7e(0x12d)],'testInstructions':{'successCard':_0x136d7e(0x14a),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x136d7e(0x14c),'cvc':_0x136d7e(0x157),'holderName':'Any\x20name'}}});}catch(_0x10895b){_0x14bfbd(_0x10895b);}},this[_0x47d578(0x149)]=async(_0x3adea5,_0x48bbe2,_0xcffc5f)=>{const _0x168627=_0x47d578;try{const {paymentId:_0x2c09d3}=_0x3adea5['params'],_0x27da77=_0x3adea5[_0x168627(0x12e)];console['log'](_0x168627(0x155)+_0x2c09d3);const _0x4705e1=await database_1[_0x168627(0x165)][_0x168627(0x15c)][_0x168627(0x12a)]({'where':{'id':_0x2c09d3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4705e1)return _0x48bbe2[_0x168627(0x144)](0x194)[_0x168627(0x168)]({'success':![],'message':_0x168627(0x167)});if(_0x4705e1[_0x168627(0x140)]!=='test_gateway')return _0x48bbe2['status'](0x190)[_0x168627(0x168)]({'success':![],'message':_0x168627(0x14f)});if(_0x4705e1[_0x168627(0x144)]!==_0x168627(0x125))return _0x48bbe2[_0x168627(0x144)](0x190)[_0x168627(0x168)]({'success':![],'message':_0x168627(0x137)+_0x4705e1['status']+_0x168627(0x13c)});const _0x2e3db1=await this['testGatewayService']['processCardPayment']({'paymentId':_0x4705e1['id'],'orderId':_0x4705e1[_0x168627(0x151)]||_0x4705e1['id'],'amount':_0x4705e1[_0x168627(0x114)],'currency':_0x4705e1[_0x168627(0x106)],'cardData':_0x27da77});console[_0x168627(0x131)](_0x168627(0x133),_0x2e3db1);const _0x17ab14={'status':_0x2e3db1['status'],'updatedAt':new Date()};if(_0x2e3db1[_0x168627(0x144)]===_0x168627(0x150))_0x17ab14[_0x168627(0x10b)]=new Date(),_0x17ab14[_0x168627(0x166)]=_0x2e3db1[_0x168627(0x163)];else _0x2e3db1[_0x168627(0x144)]===_0x168627(0x15e)&&(_0x17ab14[_0x168627(0x164)]=_0x2e3db1['failureReason']);const _0x4de2a3=_0x27da77[_0x168627(0x103)][_0x168627(0x16e)](/[\s-]/g,'');_0x17ab14[_0x168627(0x13a)]=_0x4de2a3[_0x168627(0x105)](-0x4),_0x17ab14[_0x168627(0x154)]=_0x168627(0x14e),await database_1['default'][_0x168627(0x15c)][_0x168627(0x123)]({'where':{'id':_0x4705e1['id']},'data':_0x17ab14}),await database_1['default'][_0x168627(0x153)][_0x168627(0x108)]({'data':{'paymentId':_0x4705e1['id'],'shopId':_0x4705e1[_0x168627(0x146)],'event':'test_gateway_'+_0x2e3db1[_0x168627(0x144)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x168627(0x10c)]({'oldStatus':_0x168627(0x125),'newStatus':_0x2e3db1[_0x168627(0x144)],'transactionId':_0x2e3db1[_0x168627(0x163)],'failureReason':_0x2e3db1['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x168627(0x10d)](_0x4705e1,_0x2e3db1[_0x168627(0x144)],_0x2e3db1[_0x168627(0x163)],_0x2e3db1[_0x168627(0x112)]),await this['sendPaymentStatusNotification'](_0x4705e1,_0x2e3db1['status']),console['log'](_0x168627(0x162)+_0x2c09d3+_0x168627(0x121)+_0x2e3db1[_0x168627(0x144)]),_0x2e3db1[_0x168627(0x144)]==='PAID'?_0x48bbe2[_0x168627(0x168)]({'success':!![],'message':_0x168627(0x11d),'result':{'status':_0x168627(0x150),'transactionId':_0x2e3db1[_0x168627(0x163)],'redirectUrl':_0x4705e1[_0x168627(0x15b)]}}):_0x48bbe2[_0x168627(0x144)](0x190)[_0x168627(0x168)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x2e3db1['failureReason'],'redirectUrl':_0x4705e1['failUrl']}});}catch(_0x158784){_0xcffc5f(_0x158784);}},this[_0x47d578(0x11c)]=new testGatewayService_1[(_0x47d578(0x11a))](),this['webhookService']=new webhookService_1[(_0x47d578(0x130))]();}async[a13_0x19f204(0x10d)](_0x53a965,_0x42f293,_0x4d2150,_0x442d64){const _0x5db60a=a13_0x19f204,_0x1e42b5=Date['now']();try{const _0x16359a=_0x53a965['shop'],_0x5eb577=_0x16359a[_0x5db60a(0x136)];if(!_0x5eb577?.[_0x5db60a(0x115)]){console['log'](_0x5db60a(0x134)+_0x16359a['id']);return;}const _0x2365f2=_0x42f293===_0x5db60a(0x150)?'payment.success':_0x5db60a(0x10a);let _0x200f07=[];if(_0x5eb577['webhookEvents'])try{_0x200f07=Array[_0x5db60a(0x14d)](_0x5eb577[_0x5db60a(0x148)])?_0x5eb577['webhookEvents']:JSON[_0x5db60a(0x118)](_0x5eb577[_0x5db60a(0x148)]);}catch(_0x80aa13){console[_0x5db60a(0x104)](_0x5db60a(0x119),_0x80aa13),_0x200f07=[];}if(!_0x200f07[_0x5db60a(0x12b)](_0x2365f2)){console['log'](_0x5db60a(0x145)+_0x2365f2+_0x5db60a(0x11f)+_0x16359a['id']);return;}const _0x14eaae={'event':_0x2365f2,'payment':{'id':_0x53a965['id'],'order_id':_0x53a965[_0x5db60a(0x116)],'gateway_order_id':_0x53a965['gatewayOrderId'],'gateway':_0x5db60a(0x169),'amount':_0x53a965['amount'],'currency':_0x53a965[_0x5db60a(0x106)],'status':_0x42f293[_0x5db60a(0x127)](),'customer_email':_0x53a965['customerEmail'],'customer_name':_0x53a965[_0x5db60a(0x14b)],'transaction_id':_0x4d2150,'failure_message':_0x442d64,'created_at':_0x53a965[_0x5db60a(0x122)],'updated_at':new Date()}},_0x24e1f3=await fetch(_0x5eb577[_0x5db60a(0x115)],{'method':_0x5db60a(0x16b),'headers':{'Content-Type':'application/json','User-Agent':_0x5db60a(0x15a)},'body':JSON[_0x5db60a(0x10c)](_0x14eaae)}),_0x347597=Date['now']()-_0x1e42b5;console[_0x5db60a(0x131)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x5eb577['webhookUrl']+'\x20with\x20status\x20'+_0x24e1f3[_0x5db60a(0x144)]+'\x20('+_0x347597+'ms)');}catch(_0x37ae7b){console['error'](_0x5db60a(0x110),_0x37ae7b);}}async[a13_0x19f204(0x152)](_0x5d8a22,_0x331a3b){const _0x2891bb=a13_0x19f204;try{const {telegramBotService:_0x26ba45}=await Promise['resolve']()['then'](()=>__importStar(require(_0x2891bb(0x13f)))),_0x2f1379={'PAID':_0x2891bb(0x117),'FAILED':_0x2891bb(0x16d)},_0x5588b0=_0x2f1379[_0x331a3b];if(!_0x5588b0)return;await _0x26ba45[_0x2891bb(0x161)](_0x5d8a22[_0x2891bb(0x146)],_0x5d8a22,_0x5588b0);}catch(_0x1fc419){console[_0x2891bb(0x104)](_0x2891bb(0x158),_0x1fc419);}}}exports[a13_0x19f204(0x13e)]=TestGatewayController;