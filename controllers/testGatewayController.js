'use strict';function a13_0x4658(){const _0x130ba5=['defineProperty','gateway','TestGatewayController',',\x20cannot\x20process','shopId','status','payment.failed','test_gateway','WebhookService','payment','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','amount','settings','writable','successUrl','webhookService','229esMazA','webhookEvents','replace','190jgQmzk','FAILED','transactionId','shop','includes','ðŸ§ª\x20Test\x20Gateway\x20result:','currency','âœ…\x20Test\x20Gateway\x20payment\x20','Any\x20name','error','paymentMethod','cardLast4','hasOwnProperty','toISOString','gatewayOrderId','update','../services/gateways/testGatewayService','testGatewayService','1196392ewhJOB','Payment\x20to\x20','findUnique','test_card','webhookLog','Any\x20future\x20date\x20(MM/YY)','810068eprJCb','__importStar','PENDING','call','Test\x20Gateway\x20webhook\x20sent\x20to\x20','get','11286930KZjlVO','slice','default','getPaymentForm','Payment\x20is\x20not\x20for\x20test\x20gateway','failUrl','../config/database','\x20not\x20enabled\x20for\x20shop\x20','prototype','resolve','51416UUwyQU','paidAt','customerEmail','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','parse','isArray','3baKsnk','toLowerCase','customerName','Payment\x20failed','cardNumber','Any\x20other\x20card\x20number','json','failureReason','application/json','paid','Payment\x20not\x20found','\x20processed:\x20','4242\x204242\x204242\x204242','processCardPayment','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','1224hVQKZx','log','failureMessage','now','length','1949346BsUwiA','Payment\x20processed\x20successfully','create','82350EyyWRZ','stringify','sendShopWebhook','0000','sendPaymentNotification','test_gateway_','params','__esModule','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','PAID','name','body','ms)','webhookUrl','getOwnPropertyNames','Payment\x20status\x20is\x20','failed','../services/webhookService'];a13_0x4658=function(){return _0x130ba5;};return a13_0x4658();}const a13_0x33b2d5=a13_0x13ce;(function(_0x48c3a3,_0x26b291){const _0xf8eb6e=a13_0x13ce,_0x56372b=_0x48c3a3();while(!![]){try{const _0x26bbbf=-parseInt(_0xf8eb6e(0x186))/0x1*(parseInt(_0xf8eb6e(0x15c))/0x2)+-parseInt(_0xf8eb6e(0x14d))/0x3*(parseInt(_0xf8eb6e(0x147))/0x4)+-parseInt(_0xf8eb6e(0x11f))/0x5*(parseInt(_0xf8eb6e(0x164))/0x6)+-parseInt(_0xf8eb6e(0x137))/0x7+parseInt(_0xf8eb6e(0x131))/0x8+-parseInt(_0xf8eb6e(0x161))/0x9+parseInt(_0xf8eb6e(0x13d))/0xa;if(_0x26bbbf===_0x26b291)break;else _0x56372b['push'](_0x56372b['shift']());}catch(_0x4cee76){_0x56372b['push'](_0x56372b['shift']());}}}(a13_0x4658,0x4240c));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x81b3cb,_0x525251,_0x141103,_0x491f1d){const _0x394213=a13_0x13ce;if(_0x491f1d===undefined)_0x491f1d=_0x141103;var _0x344534=Object['getOwnPropertyDescriptor'](_0x525251,_0x141103);(!_0x344534||(_0x394213(0x13c)in _0x344534?!_0x525251['__esModule']:_0x344534[_0x394213(0x183)]||_0x344534['configurable']))&&(_0x344534={'enumerable':!![],'get':function(){return _0x525251[_0x141103];}}),Object[_0x394213(0x176)](_0x81b3cb,_0x491f1d,_0x344534);}:function(_0x353806,_0x284f98,_0x1acc22,_0x25949d){if(_0x25949d===undefined)_0x25949d=_0x1acc22;_0x353806[_0x25949d]=_0x284f98[_0x1acc22];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x4cb825,_0xd1ab90){const _0x304c03=a13_0x13ce;Object[_0x304c03(0x176)](_0x4cb825,'default',{'enumerable':!![],'value':_0xd1ab90});}:function(_0x418946,_0xba2b57){const _0x2ddcfa=a13_0x13ce;_0x418946[_0x2ddcfa(0x13f)]=_0xba2b57;}),__importStar=this&&this[a13_0x33b2d5(0x138)]||(function(){var _0x48d53a=function(_0x36ce27){const _0x5f2c8a=a13_0x13ce;return _0x48d53a=Object[_0x5f2c8a(0x172)]||function(_0x51dd1e){const _0x281dd2=_0x5f2c8a;var _0xa84131=[];for(var _0x20f68a in _0x51dd1e)if(Object[_0x281dd2(0x145)][_0x281dd2(0x12b)][_0x281dd2(0x13a)](_0x51dd1e,_0x20f68a))_0xa84131[_0xa84131[_0x281dd2(0x160)]]=_0x20f68a;return _0xa84131;},_0x48d53a(_0x36ce27);};return function(_0x472585){const _0xb444a1=a13_0x13ce;if(_0x472585&&_0x472585[_0xb444a1(0x16b)])return _0x472585;var _0x3b00e2={};if(_0x472585!=null){for(var _0x2f790b=_0x48d53a(_0x472585),_0x329c68=0x0;_0x329c68<_0x2f790b[_0xb444a1(0x160)];_0x329c68++)if(_0x2f790b[_0x329c68]!=='default')__createBinding(_0x3b00e2,_0x472585,_0x2f790b[_0x329c68]);}return __setModuleDefault(_0x3b00e2,_0x472585),_0x3b00e2;};}()),__importDefault=this&&this['__importDefault']||function(_0xd5d83c){const _0x4189de=a13_0x33b2d5;return _0xd5d83c&&_0xd5d83c[_0x4189de(0x16b)]?_0xd5d83c:{'default':_0xd5d83c};};Object[a13_0x33b2d5(0x176)](exports,a13_0x33b2d5(0x16b),{'value':!![]}),exports[a13_0x33b2d5(0x178)]=void 0x0;const testGatewayService_1=require(a13_0x33b2d5(0x12f)),webhookService_1=require(a13_0x33b2d5(0x175)),database_1=__importDefault(require(a13_0x33b2d5(0x143)));function a13_0x13ce(_0x17a1cf,_0x48e25f){const _0x4658ed=a13_0x4658();return a13_0x13ce=function(_0x13cefb,_0x2e21dc){_0x13cefb=_0x13cefb-0x11f;let _0x1c8278=_0x4658ed[_0x13cefb];return _0x1c8278;},a13_0x13ce(_0x17a1cf,_0x48e25f);}class TestGatewayController{constructor(){const _0x57d921=a13_0x33b2d5;this[_0x57d921(0x140)]=async(_0x4a4b3d,_0x35ebda,_0x173f96)=>{const _0x3f23d3=_0x57d921;try{const {paymentId:_0x3a9c6b}=_0x4a4b3d[_0x3f23d3(0x16a)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3a9c6b);const _0x4a20f9=await database_1[_0x3f23d3(0x13f)][_0x3f23d3(0x17f)]['findUnique']({'where':{'id':_0x3a9c6b},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4a20f9)return _0x35ebda[_0x3f23d3(0x17b)](0x194)[_0x3f23d3(0x153)]({'success':![],'message':_0x3f23d3(0x157)});if(_0x4a20f9[_0x3f23d3(0x177)]!==_0x3f23d3(0x17d))return _0x35ebda[_0x3f23d3(0x17b)](0x190)[_0x3f23d3(0x153)]({'success':![],'message':_0x3f23d3(0x141)});if(_0x4a20f9[_0x3f23d3(0x17b)]!=='PENDING')return _0x35ebda[_0x3f23d3(0x17b)](0x190)[_0x3f23d3(0x153)]({'success':![],'message':_0x3f23d3(0x173)+_0x4a20f9[_0x3f23d3(0x17b)]+_0x3f23d3(0x179)});_0x35ebda[_0x3f23d3(0x153)]({'success':!![],'result':{'paymentId':_0x4a20f9['id'],'orderId':_0x4a20f9[_0x3f23d3(0x12d)],'amount':_0x4a20f9[_0x3f23d3(0x181)],'currency':_0x4a20f9[_0x3f23d3(0x125)],'merchantName':_0x4a20f9[_0x3f23d3(0x122)][_0x3f23d3(0x16e)],'description':_0x3f23d3(0x132)+_0x4a20f9[_0x3f23d3(0x122)][_0x3f23d3(0x16e)],'testInstructions':{'successCard':_0x3f23d3(0x159),'failureCard':_0x3f23d3(0x152),'expiryDate':_0x3f23d3(0x136),'cvc':'Any\x203-4\x20digits','holderName':_0x3f23d3(0x127)}}});}catch(_0x2b45c1){_0x173f96(_0x2b45c1);}},this['processCard']=async(_0x47f2c5,_0x554620,_0x1f2905)=>{const _0x2f1b98=_0x57d921;try{const {paymentId:_0x286a6a}=_0x47f2c5[_0x2f1b98(0x16a)],_0x32acab=_0x47f2c5[_0x2f1b98(0x16f)];console[_0x2f1b98(0x15d)](_0x2f1b98(0x14a)+_0x286a6a);const _0x1cd94e=await database_1['default'][_0x2f1b98(0x17f)][_0x2f1b98(0x133)]({'where':{'id':_0x286a6a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1cd94e)return _0x554620['status'](0x194)[_0x2f1b98(0x153)]({'success':![],'message':_0x2f1b98(0x157)});if(_0x1cd94e['gateway']!==_0x2f1b98(0x17d))return _0x554620[_0x2f1b98(0x17b)](0x190)[_0x2f1b98(0x153)]({'success':![],'message':_0x2f1b98(0x141)});if(_0x1cd94e['status']!==_0x2f1b98(0x139))return _0x554620[_0x2f1b98(0x17b)](0x190)[_0x2f1b98(0x153)]({'success':![],'message':_0x2f1b98(0x173)+_0x1cd94e[_0x2f1b98(0x17b)]+_0x2f1b98(0x179)});const _0x2af789=await this[_0x2f1b98(0x130)][_0x2f1b98(0x15a)]({'paymentId':_0x1cd94e['id'],'orderId':_0x1cd94e[_0x2f1b98(0x12d)]||_0x1cd94e['id'],'amount':_0x1cd94e[_0x2f1b98(0x181)],'currency':_0x1cd94e[_0x2f1b98(0x125)],'cardData':_0x32acab});console[_0x2f1b98(0x15d)](_0x2f1b98(0x124),_0x2af789);const _0x26237a={'status':_0x2af789[_0x2f1b98(0x17b)],'updatedAt':new Date()};if(_0x2af789[_0x2f1b98(0x17b)]===_0x2f1b98(0x16d))_0x26237a[_0x2f1b98(0x148)]=new Date(),_0x26237a['gatewayPaymentId']=_0x2af789[_0x2f1b98(0x121)];else _0x2af789[_0x2f1b98(0x17b)]===_0x2f1b98(0x120)&&(_0x26237a[_0x2f1b98(0x15e)]=_0x2af789[_0x2f1b98(0x154)]);const _0x19f66b=_0x32acab[_0x2f1b98(0x151)][_0x2f1b98(0x188)](/[\s-]/g,'');_0x26237a[_0x2f1b98(0x12a)]=_0x19f66b[_0x2f1b98(0x13e)](-0x4),_0x26237a[_0x2f1b98(0x129)]=_0x2f1b98(0x134),await database_1[_0x2f1b98(0x13f)][_0x2f1b98(0x17f)][_0x2f1b98(0x12e)]({'where':{'id':_0x1cd94e['id']},'data':_0x26237a}),await database_1[_0x2f1b98(0x13f)][_0x2f1b98(0x135)][_0x2f1b98(0x163)]({'data':{'paymentId':_0x1cd94e['id'],'shopId':_0x1cd94e['shopId'],'event':_0x2f1b98(0x169)+_0x2af789['status'][_0x2f1b98(0x14e)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2f1b98(0x139),'newStatus':_0x2af789[_0x2f1b98(0x17b)],'transactionId':_0x2af789[_0x2f1b98(0x121)],'failureReason':_0x2af789['failureReason'],'processedAt':new Date()[_0x2f1b98(0x12c)]()})}}),await this[_0x2f1b98(0x166)](_0x1cd94e,_0x2af789[_0x2f1b98(0x17b)],_0x2af789[_0x2f1b98(0x121)],_0x2af789['failureReason']),await this['sendPaymentStatusNotification'](_0x1cd94e,_0x2af789['status']),console[_0x2f1b98(0x15d)](_0x2f1b98(0x126)+_0x286a6a+_0x2f1b98(0x158)+_0x2af789[_0x2f1b98(0x17b)]),_0x2af789['status']===_0x2f1b98(0x16d)?_0x554620[_0x2f1b98(0x153)]({'success':!![],'message':_0x2f1b98(0x162),'result':{'status':'PAID','transactionId':_0x2af789[_0x2f1b98(0x121)],'redirectUrl':_0x1cd94e[_0x2f1b98(0x184)]}}):_0x554620[_0x2f1b98(0x17b)](0x190)[_0x2f1b98(0x153)]({'success':![],'message':_0x2f1b98(0x150),'result':{'status':_0x2f1b98(0x120),'failureReason':_0x2af789[_0x2f1b98(0x154)],'redirectUrl':_0x1cd94e[_0x2f1b98(0x142)]}});}catch(_0x8e2db6){_0x1f2905(_0x8e2db6);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x57d921(0x185)]=new webhookService_1[(_0x57d921(0x17e))]();}async[a13_0x33b2d5(0x166)](_0x17d29a,_0x1f0ea,_0x2dd5bf,_0x5438fc){const _0x1db4ae=a13_0x33b2d5,_0x5f6fe3=Date[_0x1db4ae(0x15f)]();try{const _0x818ab0=_0x17d29a[_0x1db4ae(0x122)],_0x452d83=_0x818ab0[_0x1db4ae(0x182)];if(!_0x452d83?.[_0x1db4ae(0x171)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x818ab0['id']);return;}const _0x191a53=_0x1f0ea===_0x1db4ae(0x16d)?'payment.success':_0x1db4ae(0x17c);let _0x6eed83=[];if(_0x452d83[_0x1db4ae(0x187)])try{_0x6eed83=Array[_0x1db4ae(0x14c)](_0x452d83[_0x1db4ae(0x187)])?_0x452d83[_0x1db4ae(0x187)]:JSON[_0x1db4ae(0x14b)](_0x452d83[_0x1db4ae(0x187)]);}catch(_0x3aedfd){console[_0x1db4ae(0x128)]('Error\x20parsing\x20webhook\x20events:',_0x3aedfd),_0x6eed83=[];}if(!_0x6eed83[_0x1db4ae(0x123)](_0x191a53)){console[_0x1db4ae(0x15d)]('Webhook\x20event\x20'+_0x191a53+_0x1db4ae(0x144)+_0x818ab0['id']);return;}const _0xff5279={'event':_0x191a53,'payment':{'id':_0x17d29a['id'],'order_id':_0x17d29a['orderId'],'gateway_order_id':_0x17d29a[_0x1db4ae(0x12d)],'gateway':_0x1db4ae(0x167),'amount':_0x17d29a['amount'],'currency':_0x17d29a[_0x1db4ae(0x125)],'status':_0x1f0ea[_0x1db4ae(0x14e)](),'customer_email':_0x17d29a[_0x1db4ae(0x149)],'customer_name':_0x17d29a[_0x1db4ae(0x14f)],'transaction_id':_0x2dd5bf,'failure_message':_0x5438fc,'created_at':_0x17d29a['createdAt'],'updated_at':new Date()}},_0x32fd25=await fetch(_0x452d83['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1db4ae(0x155),'User-Agent':_0x1db4ae(0x16c)},'body':JSON[_0x1db4ae(0x165)](_0xff5279)}),_0x127ddb=Date[_0x1db4ae(0x15f)]()-_0x5f6fe3;console[_0x1db4ae(0x15d)](_0x1db4ae(0x13b)+_0x452d83[_0x1db4ae(0x171)]+'\x20with\x20status\x20'+_0x32fd25[_0x1db4ae(0x17b)]+'\x20('+_0x127ddb+_0x1db4ae(0x170));}catch(_0x4e6416){console[_0x1db4ae(0x128)](_0x1db4ae(0x15b),_0x4e6416);}}async['sendPaymentStatusNotification'](_0xc02d83,_0x5e7554){const _0x4a9b54=a13_0x33b2d5;try{const {telegramBotService:_0x3d8689}=await Promise[_0x4a9b54(0x146)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x130dc9={'PAID':_0x4a9b54(0x156),'FAILED':_0x4a9b54(0x174)},_0x2cf3f1=_0x130dc9[_0x5e7554];if(!_0x2cf3f1)return;await _0x3d8689[_0x4a9b54(0x168)](_0xc02d83[_0x4a9b54(0x17a)],_0xc02d83,_0x2cf3f1);}catch(_0x2e6b94){console[_0x4a9b54(0x128)](_0x4a9b54(0x180),_0x2e6b94);}}}exports[a13_0x33b2d5(0x178)]=TestGatewayController;