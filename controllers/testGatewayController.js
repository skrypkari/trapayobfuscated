'use strict';function a18_0x54b7(){const _0xebefa2=['slice','PENDING','2465340wdfRJO','failed','getPaymentForm','../services/telegramBotService','ms)','Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','shopId','gatewayPaymentId','call','ðŸ§ª\x20Test\x20Gateway\x20result:','prototype','SINGLE','payment.failed','json','\x20not\x20found','paymentMethod','getOwnPropertyDescriptor','replace','COMPLETED','testGatewayService','customerName','createdAt','writable','webhookUrl','WebhookService','log','\x20updated:\x20currentPayments=','paymentLinkId','configurable','application/json','test_gateway_','gateway','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','settings','default','get','processCard','5300680jtmfvy','11060182QcFizM','paidAt','name','sendPaymentNotification','currentPayments','isArray',':\x20type=','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20',',\x20cannot\x20process','amount','update',',\x20status=','params','__importStar','Payment\x20status\x20is\x20','55090PZQEew','webhookLog','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','processCardPayment','FAILED','Payment\x20System/1.0\x20(Test\x20Gateway)','28375443RyqWTW','failureReason','webhookService','ðŸ“ˆ\x20Found\x20payment\x20link\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','currency','sendShopWebhook','0000','âœ…\x20Test\x20Gateway\x20payment\x20','transactionId','then','defineProperty','3727125wMVglo','paymentLink','\x20->\x20','shop','length','test_gateway','getOwnPropertyNames','toLowerCase','stringify','cardLast4','790450GBJBVk','../services/gateways/testGatewayService','Payment\x20failed','Any\x20future\x20date\x20(MM/YY)','1PunZqc','Webhook\x20event\x20','paid','\x20processed:\x20','findUnique','customerEmail','Payment\x20is\x20not\x20for\x20test\x20gateway','failureMessage','failUrl','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','8SnGrkL','body','payment','webhookEvents','PAID','TestGatewayService','error','resolve','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__setModuleDefault','hasOwnProperty','POST','status',',\x20currentPayments=','sendPaymentStatusNotification','test_card','now','../services/webhookService','Any\x203-4\x20digits','4242\x204242\x204242\x204242','Any\x20other\x20card\x20number','__esModule','Payment\x20to\x20','type','âœ…\x20Payment\x20link\x20','Error\x20parsing\x20webhook\x20events:','gatewayOrderId','includes','successUrl','cardNumber','\x20not\x20enabled\x20for\x20shop\x20'];a18_0x54b7=function(){return _0xebefa2;};return a18_0x54b7();}const a18_0x2a1791=a18_0x4644;(function(_0x45edb4,_0x18a175){const _0x102e23=a18_0x4644,_0x5b8062=_0x45edb4();while(!![]){try{const _0x494a4c=parseInt(_0x102e23(0x169))/0x1*(-parseInt(_0x102e23(0x148))/0x2)+parseInt(_0x102e23(0x15b))/0x3+-parseInt(_0x102e23(0x138))/0x4+-parseInt(_0x102e23(0x165))/0x5+-parseInt(_0x102e23(0x112))/0x6+-parseInt(_0x102e23(0x139))/0x7+-parseInt(_0x102e23(0xf1))/0x8*(-parseInt(_0x102e23(0x14e))/0x9);if(_0x494a4c===_0x18a175)break;else _0x5b8062['push'](_0x5b8062['shift']());}catch(_0x461a92){_0x5b8062['push'](_0x5b8062['shift']());}}}(a18_0x54b7,0xda229));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x5bb12b,_0x449ea0,_0x192171,_0x2c6080){const _0x1ba2db=a18_0x4644;if(_0x2c6080===undefined)_0x2c6080=_0x192171;var _0x4f5f72=Object[_0x1ba2db(0x123)](_0x449ea0,_0x192171);(!_0x4f5f72||(_0x1ba2db(0x136)in _0x4f5f72?!_0x449ea0[_0x1ba2db(0x106)]:_0x4f5f72[_0x1ba2db(0x129)]||_0x4f5f72[_0x1ba2db(0x12f)]))&&(_0x4f5f72={'enumerable':!![],'get':function(){return _0x449ea0[_0x192171];}}),Object[_0x1ba2db(0x15a)](_0x5bb12b,_0x2c6080,_0x4f5f72);}:function(_0x4ae04c,_0xf2581a,_0x3f078a,_0x442bae){if(_0x442bae===undefined)_0x442bae=_0x3f078a;_0x4ae04c[_0x442bae]=_0xf2581a[_0x3f078a];}),__setModuleDefault=this&&this[a18_0x2a1791(0xfa)]||(Object['create']?function(_0xbc1336,_0x3a68bc){const _0x444079=a18_0x2a1791;Object['defineProperty'](_0xbc1336,_0x444079(0x135),{'enumerable':!![],'value':_0x3a68bc});}:function(_0x529e39,_0x2a368d){const _0x3b1479=a18_0x2a1791;_0x529e39[_0x3b1479(0x135)]=_0x2a368d;}),__importStar=this&&this[a18_0x2a1791(0x146)]||(function(){var _0x261351=function(_0x13a6f4){const _0x2be983=a18_0x4644;return _0x261351=Object[_0x2be983(0x161)]||function(_0x6cc5c8){const _0x3a4a7a=_0x2be983;var _0x286651=[];for(var _0x249d39 in _0x6cc5c8)if(Object[_0x3a4a7a(0x11d)][_0x3a4a7a(0xfb)][_0x3a4a7a(0x11b)](_0x6cc5c8,_0x249d39))_0x286651[_0x286651['length']]=_0x249d39;return _0x286651;},_0x261351(_0x13a6f4);};return function(_0x55edc1){const _0x4c1660=a18_0x4644;if(_0x55edc1&&_0x55edc1[_0x4c1660(0x106)])return _0x55edc1;var _0x37b884={};if(_0x55edc1!=null){for(var _0x46aa9e=_0x261351(_0x55edc1),_0x46db57=0x0;_0x46db57<_0x46aa9e[_0x4c1660(0x15f)];_0x46db57++)if(_0x46aa9e[_0x46db57]!=='default')__createBinding(_0x37b884,_0x55edc1,_0x46aa9e[_0x46db57]);}return __setModuleDefault(_0x37b884,_0x55edc1),_0x37b884;};}()),__importDefault=this&&this['__importDefault']||function(_0x840f25){return _0x840f25&&_0x840f25['__esModule']?_0x840f25:{'default':_0x840f25};};Object['defineProperty'](exports,a18_0x2a1791(0x106),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a18_0x2a1791(0x166)),webhookService_1=require(a18_0x2a1791(0x102)),database_1=__importDefault(require('../config/database'));function a18_0x4644(_0x4a6533,_0x384449){_0x4a6533=_0x4a6533-0xec;const _0x54b7f5=a18_0x54b7();let _0x4644ef=_0x54b7f5[_0x4a6533];return _0x4644ef;}class TestGatewayController{constructor(){const _0x52d775=a18_0x2a1791;this[_0x52d775(0x114)]=async(_0x49dc05,_0x165dfc,_0x900ad3)=>{const _0x160a5e=_0x52d775;try{const {paymentId:_0x43816e}=_0x49dc05['params'];console['log'](_0x160a5e(0x14a)+_0x43816e);const _0x19b115=await database_1[_0x160a5e(0x135)][_0x160a5e(0xf3)][_0x160a5e(0x16d)]({'where':{'id':_0x43816e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x19b115)return _0x165dfc[_0x160a5e(0xfd)](0x194)[_0x160a5e(0x120)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x19b115[_0x160a5e(0x132)]!==_0x160a5e(0x160))return _0x165dfc['status'](0x190)[_0x160a5e(0x120)]({'success':![],'message':_0x160a5e(0xed)});if(_0x19b115[_0x160a5e(0xfd)]!==_0x160a5e(0x111))return _0x165dfc[_0x160a5e(0xfd)](0x190)[_0x160a5e(0x120)]({'success':![],'message':_0x160a5e(0x147)+_0x19b115[_0x160a5e(0xfd)]+_0x160a5e(0x141)});_0x165dfc[_0x160a5e(0x120)]({'success':!![],'result':{'paymentId':_0x19b115['id'],'orderId':_0x19b115[_0x160a5e(0x10b)],'amount':_0x19b115[_0x160a5e(0x142)],'currency':_0x19b115['currency'],'merchantName':_0x19b115[_0x160a5e(0x15e)][_0x160a5e(0x13b)],'description':_0x160a5e(0x107)+_0x19b115[_0x160a5e(0x15e)][_0x160a5e(0x13b)],'testInstructions':{'successCard':_0x160a5e(0x104),'failureCard':_0x160a5e(0x105),'expiryDate':_0x160a5e(0x168),'cvc':_0x160a5e(0x103),'holderName':'Any\x20name'}}});}catch(_0x2691be){_0x900ad3(_0x2691be);}},this[_0x52d775(0x137)]=async(_0x1b042d,_0x3d565e,_0x511469)=>{const _0x5df5cd=_0x52d775;try{const {paymentId:_0x447f81}=_0x1b042d[_0x5df5cd(0x145)],_0x33db55=_0x1b042d[_0x5df5cd(0xf2)];console[_0x5df5cd(0x12c)](_0x5df5cd(0x140)+_0x447f81);const _0x6d9ff8=await database_1[_0x5df5cd(0x135)][_0x5df5cd(0xf3)][_0x5df5cd(0x16d)]({'where':{'id':_0x447f81},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x6d9ff8)return _0x3d565e['status'](0x194)[_0x5df5cd(0x120)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x6d9ff8['gateway']!==_0x5df5cd(0x160))return _0x3d565e['status'](0x190)[_0x5df5cd(0x120)]({'success':![],'message':_0x5df5cd(0xed)});if(_0x6d9ff8['status']!==_0x5df5cd(0x111))return _0x3d565e[_0x5df5cd(0xfd)](0x190)[_0x5df5cd(0x120)]({'success':![],'message':_0x5df5cd(0x147)+_0x6d9ff8['status']+_0x5df5cd(0x141)});const _0x349763=await this['testGatewayService'][_0x5df5cd(0x14b)]({'paymentId':_0x6d9ff8['id'],'orderId':_0x6d9ff8['gatewayOrderId']||_0x6d9ff8['id'],'amount':_0x6d9ff8[_0x5df5cd(0x142)],'currency':_0x6d9ff8[_0x5df5cd(0x154)],'cardData':_0x33db55});console[_0x5df5cd(0x12c)](_0x5df5cd(0x11c),_0x349763);const _0xc7274={'status':_0x349763[_0x5df5cd(0xfd)],'updatedAt':new Date()};if(_0x349763[_0x5df5cd(0xfd)]===_0x5df5cd(0xf5))_0xc7274[_0x5df5cd(0x13a)]=new Date(),_0xc7274[_0x5df5cd(0x11a)]=_0x349763[_0x5df5cd(0x158)];else _0x349763[_0x5df5cd(0xfd)]==='FAILED'&&(_0xc7274[_0x5df5cd(0xee)]=_0x349763[_0x5df5cd(0x14f)]);const _0x4147e1=_0x33db55[_0x5df5cd(0x10e)][_0x5df5cd(0x124)](/[\s-]/g,'');_0xc7274[_0x5df5cd(0x164)]=_0x4147e1[_0x5df5cd(0x110)](-0x4),_0xc7274[_0x5df5cd(0x122)]=_0x5df5cd(0x100),await database_1[_0x5df5cd(0x135)][_0x5df5cd(0xf3)][_0x5df5cd(0x143)]({'where':{'id':_0x6d9ff8['id']},'data':_0xc7274});if(_0x349763[_0x5df5cd(0xfd)]===_0x5df5cd(0xf5)&&_0x6d9ff8[_0x5df5cd(0x12e)]){console[_0x5df5cd(0x12c)](_0x5df5cd(0x153)+_0x6d9ff8['id']+_0x5df5cd(0x118));try{await database_1['default']['$transaction'](async _0x1ccf5c=>{const _0xac6032=_0x5df5cd,_0x5ec8b8=await _0x1ccf5c[_0xac6032(0x15c)]['findUnique']({'where':{'id':_0x6d9ff8['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5ec8b8){console[_0xac6032(0x12c)](_0xac6032(0x151)+_0x5ec8b8['id']+_0xac6032(0x13f)+_0x5ec8b8[_0xac6032(0x108)]+_0xac6032(0xfe)+_0x5ec8b8[_0xac6032(0x13d)]+_0xac6032(0x144)+_0x5ec8b8[_0xac6032(0xfd)]);const _0x5ad3f2=_0x5ec8b8[_0xac6032(0x13d)]+0x1,_0x500c83=_0x5ec8b8[_0xac6032(0x108)]===_0xac6032(0x11e)?_0xac6032(0x125):_0x5ec8b8[_0xac6032(0xfd)];await _0x1ccf5c[_0xac6032(0x15c)]['update']({'where':{'id':_0x6d9ff8[_0xac6032(0x12e)]},'data':{'currentPayments':_0x5ad3f2,'status':_0x500c83,'updatedAt':new Date()}}),console[_0xac6032(0x12c)](_0xac6032(0x109)+_0x5ec8b8['id']+_0xac6032(0x12d)+_0x5ec8b8['currentPayments']+_0xac6032(0x15d)+_0x5ad3f2+_0xac6032(0x144)+_0x5ec8b8[_0xac6032(0xfd)]+_0xac6032(0x15d)+_0x500c83);}else console[_0xac6032(0x12c)]('âŒ\x20Payment\x20link\x20'+_0x6d9ff8[_0xac6032(0x12e)]+_0xac6032(0x121));});}catch(_0x2f7a65){console[_0x5df5cd(0xf7)](_0x5df5cd(0x133),_0x2f7a65);}}await database_1[_0x5df5cd(0x135)][_0x5df5cd(0x149)]['create']({'data':{'paymentId':_0x6d9ff8['id'],'shopId':_0x6d9ff8['shopId'],'event':_0x5df5cd(0x131)+_0x349763[_0x5df5cd(0xfd)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5df5cd(0x163)]({'oldStatus':_0x5df5cd(0x111),'newStatus':_0x349763[_0x5df5cd(0xfd)],'transactionId':_0x349763[_0x5df5cd(0x158)],'failureReason':_0x349763[_0x5df5cd(0x14f)],'processedAt':new Date()['toISOString']()})}}),await this[_0x5df5cd(0x155)](_0x6d9ff8,_0x349763[_0x5df5cd(0xfd)],_0x349763[_0x5df5cd(0x158)],_0x349763[_0x5df5cd(0x14f)]),await this[_0x5df5cd(0xff)](_0x6d9ff8,_0x349763['status']),console[_0x5df5cd(0x12c)](_0x5df5cd(0x157)+_0x447f81+_0x5df5cd(0x16c)+_0x349763[_0x5df5cd(0xfd)]),_0x349763[_0x5df5cd(0xfd)]===_0x5df5cd(0xf5)?_0x3d565e[_0x5df5cd(0x120)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x5df5cd(0xf5),'transactionId':_0x349763['transactionId'],'redirectUrl':_0x6d9ff8[_0x5df5cd(0x10d)]}}):_0x3d565e[_0x5df5cd(0xfd)](0x190)[_0x5df5cd(0x120)]({'success':![],'message':_0x5df5cd(0x167),'result':{'status':_0x5df5cd(0x14c),'failureReason':_0x349763[_0x5df5cd(0x14f)],'redirectUrl':_0x6d9ff8[_0x5df5cd(0xef)]}});}catch(_0x4c80f7){_0x511469(_0x4c80f7);}},this[_0x52d775(0x126)]=new testGatewayService_1[(_0x52d775(0xf6))](),this[_0x52d775(0x150)]=new webhookService_1[(_0x52d775(0x12b))]();}async[a18_0x2a1791(0x155)](_0x142c03,_0x1eee55,_0x50cc45,_0x42fea6){const _0x40f090=a18_0x2a1791,_0x39fc37=Date['now']();try{const _0xbc2e32=_0x142c03[_0x40f090(0x15e)],_0x42a278=_0xbc2e32[_0x40f090(0x134)];if(!_0x42a278?.[_0x40f090(0x12a)]){console[_0x40f090(0x12c)](_0x40f090(0xf9)+_0xbc2e32['id']);return;}const _0x1cf72b=_0x1eee55===_0x40f090(0xf5)?'payment.success':_0x40f090(0x11f);let _0x381742=[];if(_0x42a278[_0x40f090(0xf4)])try{_0x381742=Array[_0x40f090(0x13e)](_0x42a278[_0x40f090(0xf4)])?_0x42a278['webhookEvents']:JSON['parse'](_0x42a278[_0x40f090(0xf4)]);}catch(_0x409067){console['error'](_0x40f090(0x10a),_0x409067),_0x381742=[];}if(!_0x381742[_0x40f090(0x10c)](_0x1cf72b)){console[_0x40f090(0x12c)](_0x40f090(0x16a)+_0x1cf72b+_0x40f090(0x10f)+_0xbc2e32['id']);return;}const _0x308a78={'event':_0x1cf72b,'payment':{'id':_0x142c03['id'],'order_id':_0x142c03['orderId'],'gateway_order_id':_0x142c03['gatewayOrderId'],'gateway':_0x40f090(0x156),'amount':_0x142c03[_0x40f090(0x142)],'currency':_0x142c03[_0x40f090(0x154)],'status':_0x1eee55[_0x40f090(0x162)](),'customer_email':_0x142c03[_0x40f090(0xec)],'customer_name':_0x142c03[_0x40f090(0x127)],'transaction_id':_0x50cc45,'failure_message':_0x42fea6,'created_at':_0x142c03[_0x40f090(0x128)],'updated_at':new Date()}},_0x4d5451=await fetch(_0x42a278[_0x40f090(0x12a)],{'method':_0x40f090(0xfc),'headers':{'Content-Type':_0x40f090(0x130),'User-Agent':_0x40f090(0x14d)},'body':JSON[_0x40f090(0x163)](_0x308a78)}),_0x4dd153=Date[_0x40f090(0x101)]()-_0x39fc37;console[_0x40f090(0x12c)](_0x40f090(0x117)+_0x42a278[_0x40f090(0x12a)]+'\x20with\x20status\x20'+_0x4d5451[_0x40f090(0xfd)]+'\x20('+_0x4dd153+_0x40f090(0x116));}catch(_0x50c262){console[_0x40f090(0xf7)](_0x40f090(0xf0),_0x50c262);}}async[a18_0x2a1791(0xff)](_0x5a7a6d,_0x3c2073){const _0x20093b=a18_0x2a1791;try{const {telegramBotService:_0x4e6585}=await Promise[_0x20093b(0xf8)]()[_0x20093b(0x159)](()=>__importStar(require(_0x20093b(0x115)))),_0x342ac4={'PAID':_0x20093b(0x16b),'FAILED':_0x20093b(0x113)},_0x2e2186=_0x342ac4[_0x3c2073];if(!_0x2e2186)return;await _0x4e6585[_0x20093b(0x13c)](_0x5a7a6d[_0x20093b(0x119)],_0x5a7a6d,_0x2e2186);}catch(_0x3b0aa7){console[_0x20093b(0xf7)](_0x20093b(0x152),_0x3b0aa7);}}}exports['TestGatewayController']=TestGatewayController;