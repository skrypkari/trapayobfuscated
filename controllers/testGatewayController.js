'use strict';const a13_0x356844=a13_0x9381;(function(_0x1b1353,_0x2118f1){const _0x3fc1da=a13_0x9381,_0x57f5eb=_0x1b1353();while(!![]){try{const _0x30677f=-parseInt(_0x3fc1da(0x1b5))/0x1+parseInt(_0x3fc1da(0x1f1))/0x2+-parseInt(_0x3fc1da(0x1a2))/0x3+-parseInt(_0x3fc1da(0x1e8))/0x4*(parseInt(_0x3fc1da(0x1b8))/0x5)+-parseInt(_0x3fc1da(0x1f5))/0x6*(-parseInt(_0x3fc1da(0x1f0))/0x7)+-parseInt(_0x3fc1da(0x1b1))/0x8*(-parseInt(_0x3fc1da(0x1bf))/0x9)+parseInt(_0x3fc1da(0x1bd))/0xa;if(_0x30677f===_0x2118f1)break;else _0x57f5eb['push'](_0x57f5eb['shift']());}catch(_0x4a653c){_0x57f5eb['push'](_0x57f5eb['shift']());}}}(a13_0x33bb,0x54827));var __createBinding=this&&this[a13_0x356844(0x1c8)]||(Object[a13_0x356844(0x20f)]?function(_0x37da16,_0x2a5085,_0x4abddf,_0x2f6de3){const _0x3b39fe=a13_0x356844;if(_0x2f6de3===undefined)_0x2f6de3=_0x4abddf;var _0x2873ff=Object[_0x3b39fe(0x1d8)](_0x2a5085,_0x4abddf);(!_0x2873ff||(_0x3b39fe(0x1d2)in _0x2873ff?!_0x2a5085[_0x3b39fe(0x1ee)]:_0x2873ff[_0x3b39fe(0x1c9)]||_0x2873ff[_0x3b39fe(0x1cf)]))&&(_0x2873ff={'enumerable':!![],'get':function(){return _0x2a5085[_0x4abddf];}}),Object[_0x3b39fe(0x19e)](_0x37da16,_0x2f6de3,_0x2873ff);}:function(_0x468963,_0x1932b2,_0x230f6b,_0x9f3864){if(_0x9f3864===undefined)_0x9f3864=_0x230f6b;_0x468963[_0x9f3864]=_0x1932b2[_0x230f6b];}),__setModuleDefault=this&&this[a13_0x356844(0x1a4)]||(Object['create']?function(_0x8734dd,_0x334613){const _0x114eba=a13_0x356844;Object[_0x114eba(0x19e)](_0x8734dd,_0x114eba(0x1a8),{'enumerable':!![],'value':_0x334613});}:function(_0x55fc3e,_0xc4152d){const _0x3d3e0c=a13_0x356844;_0x55fc3e[_0x3d3e0c(0x1a8)]=_0xc4152d;}),__importStar=this&&this[a13_0x356844(0x1dd)]||(function(){var _0x100a62=function(_0x153733){return _0x100a62=Object['getOwnPropertyNames']||function(_0x5227be){const _0x37d973=a13_0x9381;var _0x15cb6e=[];for(var _0x5225c1 in _0x5227be)if(Object[_0x37d973(0x1f3)]['hasOwnProperty'][_0x37d973(0x1c6)](_0x5227be,_0x5225c1))_0x15cb6e[_0x15cb6e['length']]=_0x5225c1;return _0x15cb6e;},_0x100a62(_0x153733);};return function(_0xe960f4){const _0x5c9f18=a13_0x9381;if(_0xe960f4&&_0xe960f4[_0x5c9f18(0x1ee)])return _0xe960f4;var _0x3d3ffb={};if(_0xe960f4!=null){for(var _0x56aff5=_0x100a62(_0xe960f4),_0x282147=0x0;_0x282147<_0x56aff5['length'];_0x282147++)if(_0x56aff5[_0x282147]!=='default')__createBinding(_0x3d3ffb,_0xe960f4,_0x56aff5[_0x282147]);}return __setModuleDefault(_0x3d3ffb,_0xe960f4),_0x3d3ffb;};}()),__importDefault=this&&this[a13_0x356844(0x1db)]||function(_0x29281a){const _0x57a5e1=a13_0x356844;return _0x29281a&&_0x29281a[_0x57a5e1(0x1ee)]?_0x29281a:{'default':_0x29281a};};Object[a13_0x356844(0x19e)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x33bb(){const _0x30c8c4=['‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','customerEmail','toLowerCase',':\x20type=','webhookLog','configurable','testGatewayService','shop','get','Payment\x20failed','webhookEvents','error','‚úÖ\x20Test\x20Gateway\x20payment\x20','params','getOwnPropertyDescriptor','../config/database','paymentLink','__importDefault','status','__importStar','isArray','paid','paymentLinkId','body','orderId','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','processCardPayment','Payment\x20not\x20found','Payment\x20to\x20','4QvpXcs','gatewayPaymentId','payment.success','Any\x20future\x20date\x20(MM/YY)','slice','sendPaymentNotification','__esModule','json','567bzcErK','856192kdEDwL','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','prototype','type','25512qhtRdt','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)',',\x20status=','payment.failed','cardNumber','\x20->\x20','0000','sendShopWebhook','getPaymentForm','\x20updated:\x20currentPayments=','SINGLE','Any\x20name','currency','üìà\x20Found\x20payment\x20link\x20','processCard','\x20not\x20found','now','Any\x20other\x20card\x20number','FAILED','Error\x20parsing\x20webhook\x20events:','successUrl','name','webhookService','$transaction','failureReason','COMPLETED','create','\x20processed:\x20','test_gateway','log','customerName','PAID','shopId','defineProperty','\x20not\x20enabled\x20for\x20shop\x20','sendPaymentStatusNotification','stringify','1745721aoIGRP','currentPayments','__setModuleDefault','createdAt','then','amount','default','4242\x204242\x204242\x204242','gatewayOrderId','cardLast4','TestGatewayService',',\x20cannot\x20process','gateway','payment','findUnique','933008yhvgkQ','POST','../services/telegramBotService','application/json','35488FVITcd','üìà\x20Test\x20Gateway:\x20Payment\x20','paymentMethod','2100785wtvJHu','Payment\x20status\x20is\x20','webhookUrl',',\x20currentPayments=','transactionId','2613170iRXHRA','settings','27OHLJYD','update','TestGatewayController','Any\x203-4\x20digits','PENDING','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','call','replace','__createBinding','writable'];a13_0x33bb=function(){return _0x30c8c4;};return a13_0x33bb();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x356844(0x1d9)));class TestGatewayController{constructor(){const _0x571e99=a13_0x356844;this[_0x571e99(0x1fd)]=async(_0x592609,_0x3bd7f4,_0x2f520d)=>{const _0x574cb7=_0x571e99;try{const {paymentId:_0x4867a6}=_0x592609['params'];console[_0x574cb7(0x212)](_0x574cb7(0x1e3)+_0x4867a6);const _0x1247a5=await database_1[_0x574cb7(0x1a8)][_0x574cb7(0x1af)][_0x574cb7(0x1b0)]({'where':{'id':_0x4867a6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1247a5)return _0x3bd7f4[_0x574cb7(0x1dc)](0x194)['json']({'success':![],'message':_0x574cb7(0x1e6)});if(_0x1247a5[_0x574cb7(0x1ae)]!=='test_gateway')return _0x3bd7f4[_0x574cb7(0x1dc)](0x190)[_0x574cb7(0x1ef)]({'success':![],'message':_0x574cb7(0x1e4)});if(_0x1247a5['status']!=='PENDING')return _0x3bd7f4['status'](0x190)[_0x574cb7(0x1ef)]({'success':![],'message':_0x574cb7(0x1b9)+_0x1247a5['status']+_0x574cb7(0x1ad)});_0x3bd7f4['json']({'success':!![],'result':{'paymentId':_0x1247a5['id'],'orderId':_0x1247a5[_0x574cb7(0x1aa)],'amount':_0x1247a5[_0x574cb7(0x1a7)],'currency':_0x1247a5[_0x574cb7(0x201)],'merchantName':_0x1247a5[_0x574cb7(0x1d1)][_0x574cb7(0x20a)],'description':_0x574cb7(0x1e7)+_0x1247a5[_0x574cb7(0x1d1)][_0x574cb7(0x20a)],'testInstructions':{'successCard':_0x574cb7(0x1a9),'failureCard':_0x574cb7(0x206),'expiryDate':_0x574cb7(0x1eb),'cvc':_0x574cb7(0x1c2),'holderName':_0x574cb7(0x200)}}});}catch(_0x380e73){_0x2f520d(_0x380e73);}},this[_0x571e99(0x203)]=async(_0x200de7,_0x2b346d,_0x5f189b)=>{const _0x31d4b1=_0x571e99;try{const {paymentId:_0x43d13f}=_0x200de7[_0x31d4b1(0x1d7)],_0x57e49b=_0x200de7[_0x31d4b1(0x1e1)];console['log'](_0x31d4b1(0x1c5)+_0x43d13f);const _0x397caf=await database_1[_0x31d4b1(0x1a8)]['payment'][_0x31d4b1(0x1b0)]({'where':{'id':_0x43d13f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x397caf)return _0x2b346d[_0x31d4b1(0x1dc)](0x194)[_0x31d4b1(0x1ef)]({'success':![],'message':_0x31d4b1(0x1e6)});if(_0x397caf[_0x31d4b1(0x1ae)]!==_0x31d4b1(0x211))return _0x2b346d[_0x31d4b1(0x1dc)](0x190)[_0x31d4b1(0x1ef)]({'success':![],'message':_0x31d4b1(0x1e4)});if(_0x397caf['status']!=='PENDING')return _0x2b346d[_0x31d4b1(0x1dc)](0x190)['json']({'success':![],'message':_0x31d4b1(0x1b9)+_0x397caf['status']+_0x31d4b1(0x1ad)});const _0x354575=await this[_0x31d4b1(0x1d0)][_0x31d4b1(0x1e5)]({'paymentId':_0x397caf['id'],'orderId':_0x397caf[_0x31d4b1(0x1aa)]||_0x397caf['id'],'amount':_0x397caf['amount'],'currency':_0x397caf['currency'],'cardData':_0x57e49b});console[_0x31d4b1(0x212)]('üß™\x20Test\x20Gateway\x20result:',_0x354575);const _0x3ed89e={'status':_0x354575[_0x31d4b1(0x1dc)],'updatedAt':new Date()};if(_0x354575[_0x31d4b1(0x1dc)]===_0x31d4b1(0x19c))_0x3ed89e['paidAt']=new Date(),_0x3ed89e[_0x31d4b1(0x1e9)]=_0x354575[_0x31d4b1(0x1bc)];else _0x354575['status']===_0x31d4b1(0x207)&&(_0x3ed89e['failureMessage']=_0x354575[_0x31d4b1(0x20d)]);const _0x5913e9=_0x57e49b[_0x31d4b1(0x1f9)][_0x31d4b1(0x1c7)](/[\s-]/g,'');_0x3ed89e[_0x31d4b1(0x1ab)]=_0x5913e9[_0x31d4b1(0x1ec)](-0x4),_0x3ed89e[_0x31d4b1(0x1b7)]='test_card',await database_1[_0x31d4b1(0x1a8)][_0x31d4b1(0x1af)][_0x31d4b1(0x1c0)]({'where':{'id':_0x397caf['id']},'data':_0x3ed89e});if(_0x354575['status']===_0x31d4b1(0x19c)&&_0x397caf[_0x31d4b1(0x1e0)]){console['log'](_0x31d4b1(0x1b6)+_0x397caf['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x31d4b1(0x1a8)][_0x31d4b1(0x20c)](async _0x98c39=>{const _0x35f077=_0x31d4b1,_0x3e346f=await _0x98c39[_0x35f077(0x1da)][_0x35f077(0x1b0)]({'where':{'id':_0x397caf[_0x35f077(0x1e0)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3e346f){console[_0x35f077(0x212)](_0x35f077(0x202)+_0x3e346f['id']+_0x35f077(0x1cd)+_0x3e346f[_0x35f077(0x1f4)]+_0x35f077(0x1bb)+_0x3e346f['currentPayments']+_0x35f077(0x1f7)+_0x3e346f[_0x35f077(0x1dc)]);const _0xc8df3e=_0x3e346f['currentPayments']+0x1,_0x59837c=_0x3e346f['type']===_0x35f077(0x1ff)?_0x35f077(0x20e):_0x3e346f['status'];await _0x98c39[_0x35f077(0x1da)][_0x35f077(0x1c0)]({'where':{'id':_0x397caf[_0x35f077(0x1e0)]},'data':{'currentPayments':_0xc8df3e,'status':_0x59837c,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x3e346f['id']+_0x35f077(0x1fe)+_0x3e346f[_0x35f077(0x1a3)]+_0x35f077(0x1fa)+_0xc8df3e+',\x20status='+_0x3e346f[_0x35f077(0x1dc)]+'\x20->\x20'+_0x59837c);}else console[_0x35f077(0x212)]('‚ùå\x20Payment\x20link\x20'+_0x397caf[_0x35f077(0x1e0)]+_0x35f077(0x204));});}catch(_0x38370a){console[_0x31d4b1(0x1d5)](_0x31d4b1(0x1ca),_0x38370a);}}await database_1['default'][_0x31d4b1(0x1ce)][_0x31d4b1(0x20f)]({'data':{'paymentId':_0x397caf['id'],'shopId':_0x397caf[_0x31d4b1(0x19d)],'event':'test_gateway_'+_0x354575[_0x31d4b1(0x1dc)][_0x31d4b1(0x1cc)](),'statusCode':0xc8,'responseBody':JSON[_0x31d4b1(0x1a1)]({'oldStatus':_0x31d4b1(0x1c3),'newStatus':_0x354575['status'],'transactionId':_0x354575[_0x31d4b1(0x1bc)],'failureReason':_0x354575['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x31d4b1(0x1fc)](_0x397caf,_0x354575[_0x31d4b1(0x1dc)],_0x354575[_0x31d4b1(0x1bc)],_0x354575['failureReason']),await this[_0x31d4b1(0x1a0)](_0x397caf,_0x354575[_0x31d4b1(0x1dc)]),console[_0x31d4b1(0x212)](_0x31d4b1(0x1d6)+_0x43d13f+_0x31d4b1(0x210)+_0x354575['status']),_0x354575[_0x31d4b1(0x1dc)]===_0x31d4b1(0x19c)?_0x2b346d[_0x31d4b1(0x1ef)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x31d4b1(0x19c),'transactionId':_0x354575[_0x31d4b1(0x1bc)],'redirectUrl':_0x397caf[_0x31d4b1(0x209)]}}):_0x2b346d[_0x31d4b1(0x1dc)](0x190)[_0x31d4b1(0x1ef)]({'success':![],'message':_0x31d4b1(0x1d3),'result':{'status':_0x31d4b1(0x207),'failureReason':_0x354575[_0x31d4b1(0x20d)],'redirectUrl':_0x397caf['failUrl']}});}catch(_0x223317){_0x5f189b(_0x223317);}},this[_0x571e99(0x1d0)]=new testGatewayService_1[(_0x571e99(0x1ac))](),this[_0x571e99(0x20b)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x545022,_0x2703d4,_0x1eeaee,_0x3aa8f6){const _0xdc53b5=a13_0x356844,_0x45f8a2=Date[_0xdc53b5(0x205)]();try{const _0x3555a0=_0x545022[_0xdc53b5(0x1d1)],_0xa2c6fa=_0x3555a0[_0xdc53b5(0x1be)];if(!_0xa2c6fa?.[_0xdc53b5(0x1ba)]){console['log'](_0xdc53b5(0x1f2)+_0x3555a0['id']);return;}const _0x38c2c0=_0x2703d4===_0xdc53b5(0x19c)?_0xdc53b5(0x1ea):_0xdc53b5(0x1f8);let _0x1518fe=[];if(_0xa2c6fa[_0xdc53b5(0x1d4)])try{_0x1518fe=Array[_0xdc53b5(0x1de)](_0xa2c6fa[_0xdc53b5(0x1d4)])?_0xa2c6fa[_0xdc53b5(0x1d4)]:JSON['parse'](_0xa2c6fa[_0xdc53b5(0x1d4)]);}catch(_0x1318c4){console[_0xdc53b5(0x1d5)](_0xdc53b5(0x208),_0x1318c4),_0x1518fe=[];}if(!_0x1518fe['includes'](_0x38c2c0)){console[_0xdc53b5(0x212)]('Webhook\x20event\x20'+_0x38c2c0+_0xdc53b5(0x19f)+_0x3555a0['id']);return;}const _0x38d5c1={'event':_0x38c2c0,'payment':{'id':_0x545022['id'],'order_id':_0x545022[_0xdc53b5(0x1e2)],'gateway_order_id':_0x545022[_0xdc53b5(0x1aa)],'gateway':_0xdc53b5(0x1fb),'amount':_0x545022['amount'],'currency':_0x545022['currency'],'status':_0x2703d4[_0xdc53b5(0x1cc)](),'customer_email':_0x545022[_0xdc53b5(0x1cb)],'customer_name':_0x545022[_0xdc53b5(0x19b)],'transaction_id':_0x1eeaee,'failure_message':_0x3aa8f6,'created_at':_0x545022[_0xdc53b5(0x1a5)],'updated_at':new Date()}},_0x3decef=await fetch(_0xa2c6fa[_0xdc53b5(0x1ba)],{'method':_0xdc53b5(0x1b2),'headers':{'Content-Type':_0xdc53b5(0x1b4),'User-Agent':_0xdc53b5(0x1f6)},'body':JSON[_0xdc53b5(0x1a1)](_0x38d5c1)}),_0x9d7202=Date[_0xdc53b5(0x205)]()-_0x45f8a2;console[_0xdc53b5(0x212)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0xa2c6fa['webhookUrl']+'\x20with\x20status\x20'+_0x3decef['status']+'\x20('+_0x9d7202+'ms)');}catch(_0x2b4a62){console[_0xdc53b5(0x1d5)](_0xdc53b5(0x1c4),_0x2b4a62);}}async['sendPaymentStatusNotification'](_0x381052,_0x48a386){const _0x11712d=a13_0x356844;try{const {telegramBotService:_0x291915}=await Promise['resolve']()[_0x11712d(0x1a6)](()=>__importStar(require(_0x11712d(0x1b3)))),_0x389b98={'PAID':_0x11712d(0x1df),'FAILED':'failed'},_0x42139b=_0x389b98[_0x48a386];if(!_0x42139b)return;await _0x291915[_0x11712d(0x1ed)](_0x381052[_0x11712d(0x19d)],_0x381052,_0x42139b);}catch(_0xb985fe){console[_0x11712d(0x1d5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xb985fe);}}}function a13_0x9381(_0x52eafd,_0x59402f){const _0x33bbd5=a13_0x33bb();return a13_0x9381=function(_0x938121,_0x4cae52){_0x938121=_0x938121-0x19b;let _0x5e703d=_0x33bbd5[_0x938121];return _0x5e703d;},a13_0x9381(_0x52eafd,_0x59402f);}exports[a13_0x356844(0x1c1)]=TestGatewayController;