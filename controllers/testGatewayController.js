'use strict';const a13_0x447330=a13_0x18e0;(function(_0x392b87,_0x5b8acb){const _0xf180b8=a13_0x18e0,_0x2a9904=_0x392b87();while(!![]){try{const _0x3a04e5=parseInt(_0xf180b8(0x157))/0x1+-parseInt(_0xf180b8(0x134))/0x2+parseInt(_0xf180b8(0x110))/0x3+-parseInt(_0xf180b8(0x108))/0x4*(-parseInt(_0xf180b8(0x101))/0x5)+-parseInt(_0xf180b8(0x113))/0x6+parseInt(_0xf180b8(0x137))/0x7+parseInt(_0xf180b8(0xe9))/0x8*(-parseInt(_0xf180b8(0x153))/0x9);if(_0x3a04e5===_0x5b8acb)break;else _0x2a9904['push'](_0x2a9904['shift']());}catch(_0x1e8272){_0x2a9904['push'](_0x2a9904['shift']());}}}(a13_0x2e7c,0x3a12c));var __createBinding=this&&this[a13_0x447330(0x14d)]||(Object['create']?function(_0x5dfe76,_0x152ce1,_0x3a6a8c,_0x1e5f80){const _0xd0c5e=a13_0x447330;if(_0x1e5f80===undefined)_0x1e5f80=_0x3a6a8c;var _0x30471e=Object[_0xd0c5e(0x14c)](_0x152ce1,_0x3a6a8c);(!_0x30471e||(_0xd0c5e(0x14a)in _0x30471e?!_0x152ce1[_0xd0c5e(0x14b)]:_0x30471e[_0xd0c5e(0x123)]||_0x30471e[_0xd0c5e(0x150)]))&&(_0x30471e={'enumerable':!![],'get':function(){return _0x152ce1[_0x3a6a8c];}}),Object[_0xd0c5e(0x151)](_0x5dfe76,_0x1e5f80,_0x30471e);}:function(_0x5521c3,_0x18a9ef,_0x59637c,_0x43db1b){if(_0x43db1b===undefined)_0x43db1b=_0x59637c;_0x5521c3[_0x43db1b]=_0x18a9ef[_0x59637c];}),__setModuleDefault=this&&this[a13_0x447330(0x131)]||(Object[a13_0x447330(0x127)]?function(_0x17e48a,_0x3fbcd5){const _0x36be74=a13_0x447330;Object[_0x36be74(0x151)](_0x17e48a,_0x36be74(0xe2),{'enumerable':!![],'value':_0x3fbcd5});}:function(_0x47d595,_0x137475){const _0x5aa98c=a13_0x447330;_0x47d595[_0x5aa98c(0xe2)]=_0x137475;}),__importStar=this&&this[a13_0x447330(0x138)]||(function(){var _0x8ba71c=function(_0x412ba2){const _0x142188=a13_0x18e0;return _0x8ba71c=Object[_0x142188(0x12e)]||function(_0x4b0de2){const _0x1eefd9=_0x142188;var _0x18339f=[];for(var _0x322060 in _0x4b0de2)if(Object[_0x1eefd9(0x129)]['hasOwnProperty'][_0x1eefd9(0x13f)](_0x4b0de2,_0x322060))_0x18339f[_0x18339f['length']]=_0x322060;return _0x18339f;},_0x8ba71c(_0x412ba2);};return function(_0x3af676){const _0xf9960b=a13_0x18e0;if(_0x3af676&&_0x3af676['__esModule'])return _0x3af676;var _0x5f397b={};if(_0x3af676!=null){for(var _0x4f90da=_0x8ba71c(_0x3af676),_0x5db0e4=0x0;_0x5db0e4<_0x4f90da['length'];_0x5db0e4++)if(_0x4f90da[_0x5db0e4]!==_0xf9960b(0xe2))__createBinding(_0x5f397b,_0x3af676,_0x4f90da[_0x5db0e4]);}return __setModuleDefault(_0x5f397b,_0x3af676),_0x5f397b;};}()),__importDefault=this&&this[a13_0x447330(0xf8)]||function(_0x1ec05e){const _0x432101=a13_0x447330;return _0x1ec05e&&_0x1ec05e[_0x432101(0x14b)]?_0x1ec05e:{'default':_0x1ec05e};};Object[a13_0x447330(0x151)](exports,a13_0x447330(0x14b),{'value':!![]}),exports[a13_0x447330(0xe5)]=void 0x0;function a13_0x2e7c(){const _0x56d320=['❌\x20Payment\x20link\x20','params','Error\x20parsing\x20webhook\x20events:','COMPLETED','get','__esModule','getOwnPropertyDescriptor','__createBinding','getPaymentForm','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','configurable','defineProperty','toISOString','1891674PCzDZy','stringify','Payment\x20to\x20','paymentLink','243341yhoNmh','✅\x20Payment\x20link\x20','Payment\x20failed','$transaction','body','payment','test_gateway','findUnique','default','processCard','\x20not\x20enabled\x20for\x20shop\x20','TestGatewayController','log','\x20not\x20found',',\x20cannot\x20process','8gqvEdU','settings','paidAt','now','payment.success','failureReason','transactionId','gateway','\x20with\x20status\x20','failed','Payment\x20not\x20found','application/json','shop','../services/telegramBotService','✅\x20Test\x20Gateway\x20payment\x20','__importDefault','Webhook\x20event\x20','parse','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gatewayOrderId','cardLast4','SINGLE','then','orderId','60wKMHAO','processCardPayment','test_gateway_','webhookService','webhookUrl','Any\x20name','sendPaymentNotification','104288nwMFNa','0000','includes','webhookEvents',',\x20currentPayments=','../services/webhookService','4242\x204242\x204242\x204242','currentPayments','1303140yAjMAR','Any\x203-4\x20digits','WebhookService','1552056NKcEip','📈\x20Found\x20payment\x20link\x20','status','toLowerCase','Payment\x20status\x20is\x20','currency','error','paymentLinkId','cardNumber','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','test_card','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20processed:\x20','name','createdAt','shopId','writable','customerEmail','Any\x20future\x20date\x20(MM/YY)','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','create',',\x20status=','prototype','paymentMethod','🧪\x20Test\x20Gateway\x20result:','../services/gateways/testGatewayService','sendPaymentStatusNotification','getOwnPropertyNames','📈\x20Test\x20Gateway:\x20Payment\x20','PENDING','__setModuleDefault','slice','update','606926ujMzuj','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','type','137256SmOqlh','__importStar','isArray','POST','testGatewayService','amount','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20is\x20not\x20for\x20test\x20gateway','call','sendShopWebhook','json','PAID','successUrl','\x20updated:\x20currentPayments=','FAILED'];a13_0x2e7c=function(){return _0x56d320;};return a13_0x2e7c();}const testGatewayService_1=require(a13_0x447330(0x12c)),webhookService_1=require(a13_0x447330(0x10d)),database_1=__importDefault(require('../config/database'));function a13_0x18e0(_0x31ced4,_0x55107e){const _0x2e7cb9=a13_0x2e7c();return a13_0x18e0=function(_0x18e01b,_0x1b4b48){_0x18e01b=_0x18e01b-0xdc;let _0x440c3c=_0x2e7cb9[_0x18e01b];return _0x440c3c;},a13_0x18e0(_0x31ced4,_0x55107e);}class TestGatewayController{constructor(){const _0x55f39c=a13_0x447330;this[_0x55f39c(0x14e)]=async(_0x54784b,_0x8eb3cc,_0x533549)=>{const _0x46cfe5=_0x55f39c;try{const {paymentId:_0x5edd6d}=_0x54784b[_0x46cfe5(0x147)];console[_0x46cfe5(0xe6)](_0x46cfe5(0x11c)+_0x5edd6d);const _0x5bc8bc=await database_1[_0x46cfe5(0xe2)][_0x46cfe5(0xdf)]['findUnique']({'where':{'id':_0x5edd6d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5bc8bc)return _0x8eb3cc[_0x46cfe5(0x115)](0x194)[_0x46cfe5(0x141)]({'success':![],'message':_0x46cfe5(0xf3)});if(_0x5bc8bc[_0x46cfe5(0xf0)]!==_0x46cfe5(0xe0))return _0x8eb3cc[_0x46cfe5(0x115)](0x190)['json']({'success':![],'message':_0x46cfe5(0x13e)});if(_0x5bc8bc[_0x46cfe5(0x115)]!==_0x46cfe5(0x130))return _0x8eb3cc[_0x46cfe5(0x115)](0x190)[_0x46cfe5(0x141)]({'success':![],'message':_0x46cfe5(0x117)+_0x5bc8bc[_0x46cfe5(0x115)]+_0x46cfe5(0xe8)});_0x8eb3cc['json']({'success':!![],'result':{'paymentId':_0x5bc8bc['id'],'orderId':_0x5bc8bc[_0x46cfe5(0xfc)],'amount':_0x5bc8bc[_0x46cfe5(0x13c)],'currency':_0x5bc8bc[_0x46cfe5(0x118)],'merchantName':_0x5bc8bc[_0x46cfe5(0xf5)][_0x46cfe5(0x120)],'description':_0x46cfe5(0x155)+_0x5bc8bc['shop'][_0x46cfe5(0x120)],'testInstructions':{'successCard':_0x46cfe5(0x10e),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x46cfe5(0x125),'cvc':_0x46cfe5(0x111),'holderName':_0x46cfe5(0x106)}}});}catch(_0xa6f69){_0x533549(_0xa6f69);}},this[_0x55f39c(0xe3)]=async(_0x50c965,_0x4e3a5e,_0x3a77d7)=>{const _0x1dc9c5=_0x55f39c;try{const {paymentId:_0x2242e6}=_0x50c965[_0x1dc9c5(0x147)],_0x3abc53=_0x50c965[_0x1dc9c5(0xde)];console['log'](_0x1dc9c5(0x14f)+_0x2242e6);const _0x1e76b4=await database_1[_0x1dc9c5(0xe2)]['payment'][_0x1dc9c5(0xe1)]({'where':{'id':_0x2242e6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1e76b4)return _0x4e3a5e['status'](0x194)[_0x1dc9c5(0x141)]({'success':![],'message':_0x1dc9c5(0xf3)});if(_0x1e76b4[_0x1dc9c5(0xf0)]!==_0x1dc9c5(0xe0))return _0x4e3a5e[_0x1dc9c5(0x115)](0x190)[_0x1dc9c5(0x141)]({'success':![],'message':_0x1dc9c5(0x13e)});if(_0x1e76b4[_0x1dc9c5(0x115)]!=='PENDING')return _0x4e3a5e[_0x1dc9c5(0x115)](0x190)['json']({'success':![],'message':_0x1dc9c5(0x117)+_0x1e76b4[_0x1dc9c5(0x115)]+',\x20cannot\x20process'});const _0x1b49c7=await this[_0x1dc9c5(0x13b)][_0x1dc9c5(0x102)]({'paymentId':_0x1e76b4['id'],'orderId':_0x1e76b4[_0x1dc9c5(0xfc)]||_0x1e76b4['id'],'amount':_0x1e76b4['amount'],'currency':_0x1e76b4[_0x1dc9c5(0x118)],'cardData':_0x3abc53});console[_0x1dc9c5(0xe6)](_0x1dc9c5(0x12b),_0x1b49c7);const _0x266967={'status':_0x1b49c7[_0x1dc9c5(0x115)],'updatedAt':new Date()};if(_0x1b49c7['status']==='PAID')_0x266967[_0x1dc9c5(0xeb)]=new Date(),_0x266967['gatewayPaymentId']=_0x1b49c7[_0x1dc9c5(0xef)];else _0x1b49c7[_0x1dc9c5(0x115)]===_0x1dc9c5(0x145)&&(_0x266967['failureMessage']=_0x1b49c7['failureReason']);const _0x16bd44=_0x3abc53[_0x1dc9c5(0x11b)]['replace'](/[\s-]/g,'');_0x266967[_0x1dc9c5(0xfd)]=_0x16bd44[_0x1dc9c5(0x132)](-0x4),_0x266967[_0x1dc9c5(0x12a)]=_0x1dc9c5(0x11d),await database_1[_0x1dc9c5(0xe2)][_0x1dc9c5(0xdf)]['update']({'where':{'id':_0x1e76b4['id']},'data':_0x266967});if(_0x1b49c7[_0x1dc9c5(0x115)]===_0x1dc9c5(0x142)&&_0x1e76b4[_0x1dc9c5(0x11a)]){console[_0x1dc9c5(0xe6)](_0x1dc9c5(0x12f)+_0x1e76b4['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x1dc9c5(0xe2)][_0x1dc9c5(0xdd)](async _0x373954=>{const _0xdd7fa8=_0x1dc9c5,_0x54240b=await _0x373954[_0xdd7fa8(0x156)][_0xdd7fa8(0xe1)]({'where':{'id':_0x1e76b4[_0xdd7fa8(0x11a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x54240b){console[_0xdd7fa8(0xe6)](_0xdd7fa8(0x114)+_0x54240b['id']+':\x20type='+_0x54240b['type']+_0xdd7fa8(0x10c)+_0x54240b[_0xdd7fa8(0x10f)]+_0xdd7fa8(0x128)+_0x54240b[_0xdd7fa8(0x115)]);const _0x5397b6=_0x54240b[_0xdd7fa8(0x10f)]+0x1,_0x2d7991=_0x54240b[_0xdd7fa8(0x136)]===_0xdd7fa8(0xfe)?_0xdd7fa8(0x149):_0x54240b[_0xdd7fa8(0x115)];await _0x373954[_0xdd7fa8(0x156)][_0xdd7fa8(0x133)]({'where':{'id':_0x1e76b4[_0xdd7fa8(0x11a)]},'data':{'currentPayments':_0x5397b6,'status':_0x2d7991,'updatedAt':new Date()}}),console[_0xdd7fa8(0xe6)](_0xdd7fa8(0x158)+_0x54240b['id']+_0xdd7fa8(0x144)+_0x54240b[_0xdd7fa8(0x10f)]+'\x20->\x20'+_0x5397b6+_0xdd7fa8(0x128)+_0x54240b['status']+'\x20->\x20'+_0x2d7991);}else console[_0xdd7fa8(0xe6)](_0xdd7fa8(0x146)+_0x1e76b4[_0xdd7fa8(0x11a)]+_0xdd7fa8(0xe7));});}catch(_0x29504d){console[_0x1dc9c5(0x119)](_0x1dc9c5(0x135),_0x29504d);}}await database_1['default']['webhookLog'][_0x1dc9c5(0x127)]({'data':{'paymentId':_0x1e76b4['id'],'shopId':_0x1e76b4['shopId'],'event':_0x1dc9c5(0x103)+_0x1b49c7[_0x1dc9c5(0x115)][_0x1dc9c5(0x116)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1dc9c5(0x130),'newStatus':_0x1b49c7[_0x1dc9c5(0x115)],'transactionId':_0x1b49c7[_0x1dc9c5(0xef)],'failureReason':_0x1b49c7['failureReason'],'processedAt':new Date()[_0x1dc9c5(0x152)]()})}}),await this['sendShopWebhook'](_0x1e76b4,_0x1b49c7[_0x1dc9c5(0x115)],_0x1b49c7[_0x1dc9c5(0xef)],_0x1b49c7[_0x1dc9c5(0xee)]),await this[_0x1dc9c5(0x12d)](_0x1e76b4,_0x1b49c7[_0x1dc9c5(0x115)]),console[_0x1dc9c5(0xe6)](_0x1dc9c5(0xf7)+_0x2242e6+_0x1dc9c5(0x11f)+_0x1b49c7[_0x1dc9c5(0x115)]),_0x1b49c7['status']===_0x1dc9c5(0x142)?_0x4e3a5e[_0x1dc9c5(0x141)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1dc9c5(0x142),'transactionId':_0x1b49c7['transactionId'],'redirectUrl':_0x1e76b4[_0x1dc9c5(0x143)]}}):_0x4e3a5e[_0x1dc9c5(0x115)](0x190)['json']({'success':![],'message':_0x1dc9c5(0xdc),'result':{'status':_0x1dc9c5(0x145),'failureReason':_0x1b49c7[_0x1dc9c5(0xee)],'redirectUrl':_0x1e76b4['failUrl']}});}catch(_0x5c750e){_0x3a77d7(_0x5c750e);}},this[_0x55f39c(0x13b)]=new testGatewayService_1['TestGatewayService'](),this[_0x55f39c(0x104)]=new webhookService_1[(_0x55f39c(0x112))]();}async[a13_0x447330(0x140)](_0x117d9a,_0x45f197,_0x585bca,_0x548343){const _0x435b11=a13_0x447330,_0x20f704=Date[_0x435b11(0xec)]();try{const _0x31d86f=_0x117d9a['shop'],_0x13a18a=_0x31d86f[_0x435b11(0xea)];if(!_0x13a18a?.[_0x435b11(0x105)]){console[_0x435b11(0xe6)](_0x435b11(0xfb)+_0x31d86f['id']);return;}const _0x7c3b6e=_0x45f197===_0x435b11(0x142)?_0x435b11(0xed):'payment.failed';let _0x212eb6=[];if(_0x13a18a[_0x435b11(0x10b)])try{_0x212eb6=Array[_0x435b11(0x139)](_0x13a18a[_0x435b11(0x10b)])?_0x13a18a[_0x435b11(0x10b)]:JSON[_0x435b11(0xfa)](_0x13a18a[_0x435b11(0x10b)]);}catch(_0x119759){console[_0x435b11(0x119)](_0x435b11(0x148),_0x119759),_0x212eb6=[];}if(!_0x212eb6[_0x435b11(0x10a)](_0x7c3b6e)){console['log'](_0x435b11(0xf9)+_0x7c3b6e+_0x435b11(0xe4)+_0x31d86f['id']);return;}const _0x16e968={'event':_0x7c3b6e,'payment':{'id':_0x117d9a['id'],'order_id':_0x117d9a[_0x435b11(0x100)],'gateway_order_id':_0x117d9a['gatewayOrderId'],'gateway':_0x435b11(0x109),'amount':_0x117d9a[_0x435b11(0x13c)],'currency':_0x117d9a[_0x435b11(0x118)],'status':_0x45f197[_0x435b11(0x116)](),'customer_email':_0x117d9a[_0x435b11(0x124)],'customer_name':_0x117d9a['customerName'],'transaction_id':_0x585bca,'failure_message':_0x548343,'created_at':_0x117d9a[_0x435b11(0x121)],'updated_at':new Date()}},_0x180f0b=await fetch(_0x13a18a[_0x435b11(0x105)],{'method':_0x435b11(0x13a),'headers':{'Content-Type':_0x435b11(0xf4),'User-Agent':_0x435b11(0x13d)},'body':JSON[_0x435b11(0x154)](_0x16e968)}),_0x1f57da=Date[_0x435b11(0xec)]()-_0x20f704;console[_0x435b11(0xe6)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x13a18a[_0x435b11(0x105)]+_0x435b11(0xf1)+_0x180f0b[_0x435b11(0x115)]+'\x20('+_0x1f57da+'ms)');}catch(_0x327a9b){console[_0x435b11(0x119)](_0x435b11(0x126),_0x327a9b);}}async[a13_0x447330(0x12d)](_0x8df750,_0x25bc70){const _0x1df33b=a13_0x447330;try{const {telegramBotService:_0x3d3b49}=await Promise['resolve']()[_0x1df33b(0xff)](()=>__importStar(require(_0x1df33b(0xf6)))),_0x24bc6b={'PAID':'paid','FAILED':_0x1df33b(0xf2)},_0x2ba02a=_0x24bc6b[_0x25bc70];if(!_0x2ba02a)return;await _0x3d3b49[_0x1df33b(0x107)](_0x8df750[_0x1df33b(0x122)],_0x8df750,_0x2ba02a);}catch(_0x310172){console['error'](_0x1df33b(0x11e),_0x310172);}}}exports[a13_0x447330(0xe5)]=TestGatewayController;