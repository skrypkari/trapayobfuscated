'use strict';const a13_0x1089a5=a13_0x5385;(function(_0x37db13,_0x257e69){const _0x4ea648=a13_0x5385,_0x3514b3=_0x37db13();while(!![]){try{const _0x111c3f=parseInt(_0x4ea648(0x126))/0x1*(-parseInt(_0x4ea648(0x135))/0x2)+-parseInt(_0x4ea648(0x143))/0x3+parseInt(_0x4ea648(0x15d))/0x4*(-parseInt(_0x4ea648(0x169))/0x5)+-parseInt(_0x4ea648(0x12c))/0x6*(-parseInt(_0x4ea648(0x160))/0x7)+parseInt(_0x4ea648(0x167))/0x8+parseInt(_0x4ea648(0x16c))/0x9+-parseInt(_0x4ea648(0x13a))/0xa;if(_0x111c3f===_0x257e69)break;else _0x3514b3['push'](_0x3514b3['shift']());}catch(_0x45a5de){_0x3514b3['push'](_0x3514b3['shift']());}}}(a13_0x3d53,0x6d65c));function a13_0x3d53(){const _0x574623=['failed','includes','__esModule','settings','Any\x20future\x20date\x20(MM/YY)','json','sendPaymentStatusNotification',',\x20cannot\x20process','0000','Payment\x20to\x20','PENDING','2475388KtkNJt','test_gateway_','payment','14gyBsCZ','Payment\x20processed\x20successfully','failureReason','Any\x20other\x20card\x20number','__createBinding','transactionId','payment.success','4737880pYtfZt','amount','5ckSwIp','params','shopId','7237035LyunLz','error','webhookEvents','update','configurable','../services/gateways/testGatewayService','default','test_gateway','FAILED','../services/webhookService','parse','length','shop','gatewayPaymentId','createdAt','\x20processed:\x20','status','toLowerCase','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','test_card','TestGatewayService','name','paymentMethod','webhookUrl','Webhook\x20event\x20','__importStar','currency','processCardPayment','TestGatewayController','findUnique','5539iHJcwP','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','log','writable','application/json','gateway','2119206RlIPVy','stringify','4242\x204242\x204242\x204242','successUrl','cardLast4','get','slice','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','getOwnPropertyNames','22PksTGb','body','now','Payment\x20failed','customerName','1331490AoVmoK','Payment\x20is\x20not\x20for\x20test\x20gateway','../services/telegramBotService','failureMessage','call','PAID','WebhookService','hasOwnProperty','create','2525205eQAISQ','testGatewayService','payment.failed','getPaymentForm','isArray','webhookLog','sendShopWebhook','\x20with\x20status\x20','replace','Payment\x20not\x20found','ms)','defineProperty','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x203-4\x20digits','cardNumber'];a13_0x3d53=function(){return _0x574623;};return a13_0x3d53();}var __createBinding=this&&this[a13_0x1089a5(0x164)]||(Object[a13_0x1089a5(0x142)]?function(_0x1828d7,_0x171d91,_0x60ddf4,_0x20b299){const _0x59207e=a13_0x1089a5;if(_0x20b299===undefined)_0x20b299=_0x60ddf4;var _0x11837a=Object['getOwnPropertyDescriptor'](_0x171d91,_0x60ddf4);(!_0x11837a||(_0x59207e(0x131)in _0x11837a?!_0x171d91[_0x59207e(0x154)]:_0x11837a[_0x59207e(0x129)]||_0x11837a[_0x59207e(0x170)]))&&(_0x11837a={'enumerable':!![],'get':function(){return _0x171d91[_0x60ddf4];}}),Object['defineProperty'](_0x1828d7,_0x20b299,_0x11837a);}:function(_0x5b8ad4,_0x530216,_0x2d9461,_0x108f16){if(_0x108f16===undefined)_0x108f16=_0x2d9461;_0x5b8ad4[_0x108f16]=_0x530216[_0x2d9461];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x1089a5(0x142)]?function(_0x148ca6,_0x5ca916){const _0xd5136a=a13_0x1089a5;Object[_0xd5136a(0x14e)](_0x148ca6,_0xd5136a(0x172),{'enumerable':!![],'value':_0x5ca916});}:function(_0xce627e,_0x267c6f){_0xce627e['default']=_0x267c6f;}),__importStar=this&&this[a13_0x1089a5(0x121)]||(function(){var _0x4112d5=function(_0x150ccf){const _0xf67905=a13_0x5385;return _0x4112d5=Object[_0xf67905(0x134)]||function(_0x15a1e6){const _0x26a95b=_0xf67905;var _0x19c5b4=[];for(var _0x48e23d in _0x15a1e6)if(Object['prototype'][_0x26a95b(0x141)][_0x26a95b(0x13e)](_0x15a1e6,_0x48e23d))_0x19c5b4[_0x19c5b4[_0x26a95b(0x177)]]=_0x48e23d;return _0x19c5b4;},_0x4112d5(_0x150ccf);};return function(_0xde18ff){const _0x19c6c6=a13_0x5385;if(_0xde18ff&&_0xde18ff[_0x19c6c6(0x154)])return _0xde18ff;var _0x1047ac={};if(_0xde18ff!=null){for(var _0x2371d6=_0x4112d5(_0xde18ff),_0x335db9=0x0;_0x335db9<_0x2371d6['length'];_0x335db9++)if(_0x2371d6[_0x335db9]!=='default')__createBinding(_0x1047ac,_0xde18ff,_0x2371d6[_0x335db9]);}return __setModuleDefault(_0x1047ac,_0xde18ff),_0x1047ac;};}()),__importDefault=this&&this['__importDefault']||function(_0x124214){const _0xc1750f=a13_0x1089a5;return _0x124214&&_0x124214[_0xc1750f(0x154)]?_0x124214:{'default':_0x124214};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x1089a5(0x124)]=void 0x0;function a13_0x5385(_0x354454,_0x103dfb){const _0x3d5365=a13_0x3d53();return a13_0x5385=function(_0x538592,_0x53e6dc){_0x538592=_0x538592-0x115;let _0x4a1616=_0x3d5365[_0x538592];return _0x4a1616;},a13_0x5385(_0x354454,_0x103dfb);}const testGatewayService_1=require(a13_0x1089a5(0x171)),webhookService_1=require(a13_0x1089a5(0x175)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x5c6814=a13_0x1089a5;this[_0x5c6814(0x146)]=async(_0x386d96,_0x4c6ae3,_0x27b2a9)=>{const _0x48ba8b=_0x5c6814;try{const {paymentId:_0x4a3f70}=_0x386d96[_0x48ba8b(0x16a)];console[_0x48ba8b(0x128)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x4a3f70);const _0x4cce98=await database_1[_0x48ba8b(0x172)][_0x48ba8b(0x15f)][_0x48ba8b(0x125)]({'where':{'id':_0x4a3f70},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4cce98)return _0x4c6ae3[_0x48ba8b(0x118)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x4cce98['gateway']!==_0x48ba8b(0x173))return _0x4c6ae3[_0x48ba8b(0x118)](0x190)[_0x48ba8b(0x157)]({'success':![],'message':_0x48ba8b(0x13b)});if(_0x4cce98['status']!==_0x48ba8b(0x15c))return _0x4c6ae3[_0x48ba8b(0x118)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4cce98['status']+_0x48ba8b(0x159)});_0x4c6ae3[_0x48ba8b(0x157)]({'success':!![],'result':{'paymentId':_0x4cce98['id'],'orderId':_0x4cce98['gatewayOrderId'],'amount':_0x4cce98[_0x48ba8b(0x168)],'currency':_0x4cce98[_0x48ba8b(0x122)],'merchantName':_0x4cce98[_0x48ba8b(0x178)][_0x48ba8b(0x11d)],'description':_0x48ba8b(0x15b)+_0x4cce98[_0x48ba8b(0x178)]['name'],'testInstructions':{'successCard':_0x48ba8b(0x12e),'failureCard':_0x48ba8b(0x163),'expiryDate':_0x48ba8b(0x156),'cvc':_0x48ba8b(0x150),'holderName':'Any\x20name'}}});}catch(_0x27cff3){_0x27b2a9(_0x27cff3);}},this['processCard']=async(_0x1d1cb9,_0x6de96a,_0xde3c68)=>{const _0x257b45=_0x5c6814;try{const {paymentId:_0x4e546c}=_0x1d1cb9['params'],_0x149f0d=_0x1d1cb9[_0x257b45(0x136)];console[_0x257b45(0x128)](_0x257b45(0x133)+_0x4e546c);const _0x40a435=await database_1['default'][_0x257b45(0x15f)][_0x257b45(0x125)]({'where':{'id':_0x4e546c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40a435)return _0x6de96a['status'](0x194)[_0x257b45(0x157)]({'success':![],'message':_0x257b45(0x14c)});if(_0x40a435[_0x257b45(0x12b)]!==_0x257b45(0x173))return _0x6de96a[_0x257b45(0x118)](0x190)[_0x257b45(0x157)]({'success':![],'message':_0x257b45(0x13b)});if(_0x40a435[_0x257b45(0x118)]!=='PENDING')return _0x6de96a[_0x257b45(0x118)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x40a435[_0x257b45(0x118)]+_0x257b45(0x159)});const _0x8bf982=await this[_0x257b45(0x144)][_0x257b45(0x123)]({'paymentId':_0x40a435['id'],'orderId':_0x40a435['gatewayOrderId']||_0x40a435['id'],'amount':_0x40a435['amount'],'currency':_0x40a435[_0x257b45(0x122)],'cardData':_0x149f0d});console[_0x257b45(0x128)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x8bf982);const _0x2dde28={'status':_0x8bf982[_0x257b45(0x118)],'updatedAt':new Date()};if(_0x8bf982[_0x257b45(0x118)]==='PAID')_0x2dde28['paidAt']=new Date(),_0x2dde28[_0x257b45(0x115)]=_0x8bf982[_0x257b45(0x165)];else _0x8bf982[_0x257b45(0x118)]===_0x257b45(0x174)&&(_0x2dde28[_0x257b45(0x13d)]=_0x8bf982[_0x257b45(0x162)]);const _0x1ce5ac=_0x149f0d[_0x257b45(0x151)][_0x257b45(0x14b)](/[\s-]/g,'');_0x2dde28[_0x257b45(0x130)]=_0x1ce5ac[_0x257b45(0x132)](-0x4),_0x2dde28[_0x257b45(0x11e)]=_0x257b45(0x11b),await database_1[_0x257b45(0x172)][_0x257b45(0x15f)][_0x257b45(0x16f)]({'where':{'id':_0x40a435['id']},'data':_0x2dde28}),await database_1[_0x257b45(0x172)][_0x257b45(0x148)][_0x257b45(0x142)]({'data':{'paymentId':_0x40a435['id'],'shopId':_0x40a435[_0x257b45(0x16b)],'event':_0x257b45(0x15e)+_0x8bf982[_0x257b45(0x118)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x257b45(0x15c),'newStatus':_0x8bf982['status'],'transactionId':_0x8bf982[_0x257b45(0x165)],'failureReason':_0x8bf982[_0x257b45(0x162)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x40a435,_0x8bf982[_0x257b45(0x118)],_0x8bf982[_0x257b45(0x165)],_0x8bf982[_0x257b45(0x162)]),await this[_0x257b45(0x158)](_0x40a435,_0x8bf982[_0x257b45(0x118)]),console[_0x257b45(0x128)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x4e546c+_0x257b45(0x117)+_0x8bf982['status']),_0x8bf982[_0x257b45(0x118)]===_0x257b45(0x13f)?_0x6de96a[_0x257b45(0x157)]({'success':!![],'message':_0x257b45(0x161),'result':{'status':_0x257b45(0x13f),'transactionId':_0x8bf982[_0x257b45(0x165)],'redirectUrl':_0x40a435[_0x257b45(0x12f)]}}):_0x6de96a[_0x257b45(0x118)](0x190)[_0x257b45(0x157)]({'success':![],'message':_0x257b45(0x138),'result':{'status':'FAILED','failureReason':_0x8bf982[_0x257b45(0x162)],'redirectUrl':_0x40a435['failUrl']}});}catch(_0x2bcd95){_0xde3c68(_0x2bcd95);}},this[_0x5c6814(0x144)]=new testGatewayService_1[(_0x5c6814(0x11c))](),this['webhookService']=new webhookService_1[(_0x5c6814(0x140))]();}async[a13_0x1089a5(0x149)](_0x5c3198,_0x3acb91,_0x284204,_0x282703){const _0xf880f2=a13_0x1089a5,_0x321c97=Date[_0xf880f2(0x137)]();try{const _0x24cfb3=_0x5c3198[_0xf880f2(0x178)],_0x4908f7=_0x24cfb3[_0xf880f2(0x155)];if(!_0x4908f7?.['webhookUrl']){console[_0xf880f2(0x128)](_0xf880f2(0x11a)+_0x24cfb3['id']);return;}const _0x5c1bf9=_0x3acb91===_0xf880f2(0x13f)?_0xf880f2(0x166):_0xf880f2(0x145);let _0x13e537=[];if(_0x4908f7[_0xf880f2(0x16e)])try{_0x13e537=Array[_0xf880f2(0x147)](_0x4908f7[_0xf880f2(0x16e)])?_0x4908f7[_0xf880f2(0x16e)]:JSON[_0xf880f2(0x176)](_0x4908f7[_0xf880f2(0x16e)]);}catch(_0x119898){console[_0xf880f2(0x16d)]('Error\x20parsing\x20webhook\x20events:',_0x119898),_0x13e537=[];}if(!_0x13e537[_0xf880f2(0x153)](_0x5c1bf9)){console['log'](_0xf880f2(0x120)+_0x5c1bf9+'\x20not\x20enabled\x20for\x20shop\x20'+_0x24cfb3['id']);return;}const _0x47ec21={'event':_0x5c1bf9,'payment':{'id':_0x5c3198['id'],'order_id':_0x5c3198['orderId'],'gateway_order_id':_0x5c3198['gatewayOrderId'],'gateway':_0xf880f2(0x15a),'amount':_0x5c3198[_0xf880f2(0x168)],'currency':_0x5c3198[_0xf880f2(0x122)],'status':_0x3acb91[_0xf880f2(0x119)](),'customer_email':_0x5c3198['customerEmail'],'customer_name':_0x5c3198[_0xf880f2(0x139)],'transaction_id':_0x284204,'failure_message':_0x282703,'created_at':_0x5c3198[_0xf880f2(0x116)],'updated_at':new Date()}},_0x118121=await fetch(_0x4908f7[_0xf880f2(0x11f)],{'method':'POST','headers':{'Content-Type':_0xf880f2(0x12a),'User-Agent':_0xf880f2(0x14f)},'body':JSON[_0xf880f2(0x12d)](_0x47ec21)}),_0x58bee4=Date[_0xf880f2(0x137)]()-_0x321c97;console[_0xf880f2(0x128)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x4908f7[_0xf880f2(0x11f)]+_0xf880f2(0x14a)+_0x118121['status']+'\x20('+_0x58bee4+_0xf880f2(0x14d));}catch(_0x3571ba){console[_0xf880f2(0x16d)](_0xf880f2(0x127),_0x3571ba);}}async[a13_0x1089a5(0x158)](_0x1594dd,_0x2c881e){const _0x3242ad=a13_0x1089a5;try{const {telegramBotService:_0xfd80ce}=await Promise['resolve']()['then'](()=>__importStar(require(_0x3242ad(0x13c)))),_0x5bf13a={'PAID':'paid','FAILED':_0x3242ad(0x152)},_0x33b42d=_0x5bf13a[_0x2c881e];if(!_0x33b42d)return;await _0xfd80ce['sendPaymentNotification'](_0x1594dd[_0x3242ad(0x16b)],_0x1594dd,_0x33b42d);}catch(_0x565c69){console[_0x3242ad(0x16d)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x565c69);}}}exports[a13_0x1089a5(0x124)]=TestGatewayController;