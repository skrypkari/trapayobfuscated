'use strict';const a13_0x2ace25=a13_0xdc25;(function(_0x2df160,_0x5e2e2e){const _0x21f7f0=a13_0xdc25,_0x24a8b6=_0x2df160();while(!![]){try{const _0x27f532=-parseInt(_0x21f7f0(0x10b))/0x1+-parseInt(_0x21f7f0(0x10e))/0x2*(-parseInt(_0x21f7f0(0x163))/0x3)+parseInt(_0x21f7f0(0x101))/0x4*(parseInt(_0x21f7f0(0x155))/0x5)+-parseInt(_0x21f7f0(0x124))/0x6*(-parseInt(_0x21f7f0(0x151))/0x7)+parseInt(_0x21f7f0(0x134))/0x8*(parseInt(_0x21f7f0(0x12c))/0x9)+parseInt(_0x21f7f0(0x112))/0xa+-parseInt(_0x21f7f0(0x14b))/0xb*(parseInt(_0x21f7f0(0x132))/0xc);if(_0x27f532===_0x5e2e2e)break;else _0x24a8b6['push'](_0x24a8b6['shift']());}catch(_0x373d1d){_0x24a8b6['push'](_0x24a8b6['shift']());}}}(a13_0x554d,0xe49f2));var __createBinding=this&&this['__createBinding']||(Object[a13_0x2ace25(0x15a)]?function(_0x516497,_0x51fd88,_0x17219e,_0xced62b){const _0x38cfdb=a13_0x2ace25;if(_0xced62b===undefined)_0xced62b=_0x17219e;var _0xec49fe=Object[_0x38cfdb(0x14d)](_0x51fd88,_0x17219e);(!_0xec49fe||('get'in _0xec49fe?!_0x51fd88[_0x38cfdb(0xeb)]:_0xec49fe[_0x38cfdb(0x102)]||_0xec49fe[_0x38cfdb(0xec)]))&&(_0xec49fe={'enumerable':!![],'get':function(){return _0x51fd88[_0x17219e];}}),Object[_0x38cfdb(0xff)](_0x516497,_0xced62b,_0xec49fe);}:function(_0x580bf2,_0x32e8a1,_0x9dd142,_0x26e995){if(_0x26e995===undefined)_0x26e995=_0x9dd142;_0x580bf2[_0x26e995]=_0x32e8a1[_0x9dd142];}),__setModuleDefault=this&&this[a13_0x2ace25(0x13b)]||(Object[a13_0x2ace25(0x15a)]?function(_0x150d2f,_0x1a651b){const _0x5b51d2=a13_0x2ace25;Object[_0x5b51d2(0xff)](_0x150d2f,_0x5b51d2(0xf8),{'enumerable':!![],'value':_0x1a651b});}:function(_0x196656,_0x3cbb59){_0x196656['default']=_0x3cbb59;}),__importStar=this&&this[a13_0x2ace25(0x115)]||(function(){var _0x1ea9ae=function(_0x4d0e56){const _0xbd655=a13_0xdc25;return _0x1ea9ae=Object[_0xbd655(0x11e)]||function(_0x5af591){const _0x47fa14=_0xbd655;var _0x251517=[];for(var _0x503dad in _0x5af591)if(Object[_0x47fa14(0xf9)][_0x47fa14(0xe8)][_0x47fa14(0x123)](_0x5af591,_0x503dad))_0x251517[_0x251517[_0x47fa14(0x139)]]=_0x503dad;return _0x251517;},_0x1ea9ae(_0x4d0e56);};return function(_0x269611){const _0x4bfaaa=a13_0xdc25;if(_0x269611&&_0x269611[_0x4bfaaa(0xeb)])return _0x269611;var _0x17a3ea={};if(_0x269611!=null){for(var _0x1618e5=_0x1ea9ae(_0x269611),_0x5cb08d=0x0;_0x5cb08d<_0x1618e5[_0x4bfaaa(0x139)];_0x5cb08d++)if(_0x1618e5[_0x5cb08d]!==_0x4bfaaa(0xf8))__createBinding(_0x17a3ea,_0x269611,_0x1618e5[_0x5cb08d]);}return __setModuleDefault(_0x17a3ea,_0x269611),_0x17a3ea;};}()),__importDefault=this&&this['__importDefault']||function(_0x122080){const _0x4ae89f=a13_0x2ace25;return _0x122080&&_0x122080[_0x4ae89f(0xeb)]?_0x122080:{'default':_0x122080};};Object[a13_0x2ace25(0xff)](exports,'__esModule',{'value':!![]}),exports[a13_0x2ace25(0x118)]=void 0x0;function a13_0x554d(){const _0x537a92=['prototype','failureReason','\x20not\x20found','failUrl','4242\x204242\x204242\x204242','Payment\x20not\x20found','defineProperty','includes','787196UWtDmg','writable','../services/telegramBotService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','currentPayments','paymentMethod','name','Any\x20other\x20card\x20number','WebhookService','toISOString','1293673GFGEJD','TestGatewayService','params','4354emXeFP','0000','📈\x20Found\x20payment\x20link\x20','failed','17339590vHnpmu','📈\x20Test\x20Gateway:\x20Payment\x20','COMPLETED','__importStar','✅\x20Test\x20Gateway\x20payment\x20','\x20updated:\x20currentPayments=','TestGatewayController','sendPaymentStatusNotification','PENDING','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','test_card','Payment\x20to\x20','getOwnPropertyNames','paidAt','\x20->\x20','🧪\x20Test\x20Gateway\x20result:','Payment\x20is\x20not\x20for\x20test\x20gateway','call','6021684twDCZt','cardNumber','webhookUrl','paymentLink','Payment\x20status\x20is\x20','sendPaymentNotification','successUrl','../services/gateways/testGatewayService','2475ePaejK','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','testGatewayService','Webhook\x20event\x20','orderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','12CSygFD','processCardPayment','13224htFnUg','Any\x20name','body','PAID','currency','length','findUnique','__setModuleDefault','error','settings','cardLast4','\x20with\x20status\x20','json',',\x20currentPayments=','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Any\x20future\x20date\x20(MM/YY)','gateway','\x20not\x20enabled\x20for\x20shop\x20','update','../services/webhookService','failureMessage','Error\x20parsing\x20webhook\x20events:',':\x20type=','42139669LFUshw','amount','getOwnPropertyDescriptor','webhookEvents','status','customerEmail','7zKZQOG','test_gateway_','slice','toLowerCase','35JqToCt','processCard',',\x20cannot\x20process','shopId','payment','create','stringify','paid','log','getPaymentForm','$transaction','Any\x203-4\x20digits','FAILED','sendShopWebhook','2055uUuScS','shop','hasOwnProperty','paymentLinkId',',\x20status=','__esModule','configurable','gatewayPaymentId','transactionId','SINGLE','payment.success','isArray','Payment\x20processed\x20successfully','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','type','gatewayOrderId','test_gateway','✅\x20Payment\x20link\x20','default'];a13_0x554d=function(){return _0x537a92;};return a13_0x554d();}const testGatewayService_1=require(a13_0x2ace25(0x12b)),webhookService_1=require(a13_0x2ace25(0x147)),database_1=__importDefault(require('../config/database'));function a13_0xdc25(_0x3d131b,_0x2229b1){const _0x554d0e=a13_0x554d();return a13_0xdc25=function(_0xdc25d6,_0x4824b1){_0xdc25d6=_0xdc25d6-0xe7;let _0x18526a=_0x554d0e[_0xdc25d6];return _0x18526a;},a13_0xdc25(_0x3d131b,_0x2229b1);}class TestGatewayController{constructor(){const _0x5599e3=a13_0x2ace25;this[_0x5599e3(0x15e)]=async(_0x4c0478,_0x55205a,_0x3026c8)=>{const _0x460c20=_0x5599e3;try{const {paymentId:_0x53efbc}=_0x4c0478[_0x460c20(0x10d)];console['log'](_0x460c20(0xf3)+_0x53efbc);const _0x1e80b2=await database_1[_0x460c20(0xf8)][_0x460c20(0x159)][_0x460c20(0x13a)]({'where':{'id':_0x53efbc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1e80b2)return _0x55205a['status'](0x194)[_0x460c20(0x140)]({'success':![],'message':_0x460c20(0xfe)});if(_0x1e80b2[_0x460c20(0x144)]!=='test_gateway')return _0x55205a[_0x460c20(0x14f)](0x190)[_0x460c20(0x140)]({'success':![],'message':_0x460c20(0x122)});if(_0x1e80b2[_0x460c20(0x14f)]!==_0x460c20(0x11a))return _0x55205a[_0x460c20(0x14f)](0x190)[_0x460c20(0x140)]({'success':![],'message':_0x460c20(0x128)+_0x1e80b2[_0x460c20(0x14f)]+_0x460c20(0x157)});_0x55205a[_0x460c20(0x140)]({'success':!![],'result':{'paymentId':_0x1e80b2['id'],'orderId':_0x1e80b2[_0x460c20(0xf5)],'amount':_0x1e80b2[_0x460c20(0x14c)],'currency':_0x1e80b2['currency'],'merchantName':_0x1e80b2[_0x460c20(0xe7)][_0x460c20(0x107)],'description':_0x460c20(0x11d)+_0x1e80b2[_0x460c20(0xe7)][_0x460c20(0x107)],'testInstructions':{'successCard':_0x460c20(0xfd),'failureCard':_0x460c20(0x108),'expiryDate':_0x460c20(0x143),'cvc':_0x460c20(0x160),'holderName':_0x460c20(0x135)}}});}catch(_0x13efca){_0x3026c8(_0x13efca);}},this[_0x5599e3(0x156)]=async(_0x44e6e4,_0x2374ee,_0x21ddc9)=>{const _0x576e8b=_0x5599e3;try{const {paymentId:_0x512f26}=_0x44e6e4[_0x576e8b(0x10d)],_0xd605f0=_0x44e6e4[_0x576e8b(0x136)];console[_0x576e8b(0x15d)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x512f26);const _0x133f1e=await database_1[_0x576e8b(0xf8)][_0x576e8b(0x159)]['findUnique']({'where':{'id':_0x512f26},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x133f1e)return _0x2374ee[_0x576e8b(0x14f)](0x194)[_0x576e8b(0x140)]({'success':![],'message':_0x576e8b(0xfe)});if(_0x133f1e[_0x576e8b(0x144)]!==_0x576e8b(0xf6))return _0x2374ee[_0x576e8b(0x14f)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x133f1e[_0x576e8b(0x14f)]!=='PENDING')return _0x2374ee[_0x576e8b(0x14f)](0x190)[_0x576e8b(0x140)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x133f1e[_0x576e8b(0x14f)]+',\x20cannot\x20process'});const _0x5d24d1=await this[_0x576e8b(0x12e)][_0x576e8b(0x133)]({'paymentId':_0x133f1e['id'],'orderId':_0x133f1e[_0x576e8b(0xf5)]||_0x133f1e['id'],'amount':_0x133f1e['amount'],'currency':_0x133f1e[_0x576e8b(0x138)],'cardData':_0xd605f0});console['log'](_0x576e8b(0x121),_0x5d24d1);const _0x4f04b9={'status':_0x5d24d1[_0x576e8b(0x14f)],'updatedAt':new Date()};if(_0x5d24d1[_0x576e8b(0x14f)]===_0x576e8b(0x137))_0x4f04b9[_0x576e8b(0x11f)]=new Date(),_0x4f04b9[_0x576e8b(0xed)]=_0x5d24d1[_0x576e8b(0xee)];else _0x5d24d1[_0x576e8b(0x14f)]===_0x576e8b(0x161)&&(_0x4f04b9[_0x576e8b(0x148)]=_0x5d24d1['failureReason']);const _0x56208e=_0xd605f0[_0x576e8b(0x125)]['replace'](/[\s-]/g,'');_0x4f04b9[_0x576e8b(0x13e)]=_0x56208e[_0x576e8b(0x153)](-0x4),_0x4f04b9[_0x576e8b(0x106)]=_0x576e8b(0x11c),await database_1[_0x576e8b(0xf8)]['payment'][_0x576e8b(0x146)]({'where':{'id':_0x133f1e['id']},'data':_0x4f04b9});if(_0x5d24d1[_0x576e8b(0x14f)]===_0x576e8b(0x137)&&_0x133f1e['paymentLinkId']){console[_0x576e8b(0x15d)](_0x576e8b(0x113)+_0x133f1e['id']+_0x576e8b(0x12d));try{await database_1[_0x576e8b(0xf8)][_0x576e8b(0x15f)](async _0x22b0a9=>{const _0xbbd12a=_0x576e8b,_0x47cfaa=await _0x22b0a9[_0xbbd12a(0x127)][_0xbbd12a(0x13a)]({'where':{'id':_0x133f1e[_0xbbd12a(0xe9)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x47cfaa){console[_0xbbd12a(0x15d)](_0xbbd12a(0x110)+_0x47cfaa['id']+_0xbbd12a(0x14a)+_0x47cfaa['type']+_0xbbd12a(0x141)+_0x47cfaa['currentPayments']+_0xbbd12a(0xea)+_0x47cfaa[_0xbbd12a(0x14f)]);const _0x2774b9=_0x47cfaa['currentPayments']+0x1,_0x285b78=_0x47cfaa[_0xbbd12a(0xf4)]===_0xbbd12a(0xef)?_0xbbd12a(0x114):_0x47cfaa[_0xbbd12a(0x14f)];await _0x22b0a9[_0xbbd12a(0x127)][_0xbbd12a(0x146)]({'where':{'id':_0x133f1e['paymentLinkId']},'data':{'currentPayments':_0x2774b9,'status':_0x285b78,'updatedAt':new Date()}}),console[_0xbbd12a(0x15d)](_0xbbd12a(0xf7)+_0x47cfaa['id']+_0xbbd12a(0x117)+_0x47cfaa[_0xbbd12a(0x105)]+_0xbbd12a(0x120)+_0x2774b9+_0xbbd12a(0xea)+_0x47cfaa[_0xbbd12a(0x14f)]+_0xbbd12a(0x120)+_0x285b78);}else console['log']('❌\x20Payment\x20link\x20'+_0x133f1e['paymentLinkId']+_0xbbd12a(0xfb));});}catch(_0x3cd326){console[_0x576e8b(0x13c)](_0x576e8b(0x142),_0x3cd326);}}await database_1['default']['webhookLog'][_0x576e8b(0x15a)]({'data':{'paymentId':_0x133f1e['id'],'shopId':_0x133f1e[_0x576e8b(0x158)],'event':_0x576e8b(0x152)+_0x5d24d1['status'][_0x576e8b(0x154)](),'statusCode':0xc8,'responseBody':JSON[_0x576e8b(0x15b)]({'oldStatus':_0x576e8b(0x11a),'newStatus':_0x5d24d1[_0x576e8b(0x14f)],'transactionId':_0x5d24d1[_0x576e8b(0xee)],'failureReason':_0x5d24d1[_0x576e8b(0xfa)],'processedAt':new Date()[_0x576e8b(0x10a)]()})}}),await this[_0x576e8b(0x162)](_0x133f1e,_0x5d24d1[_0x576e8b(0x14f)],_0x5d24d1[_0x576e8b(0xee)],_0x5d24d1[_0x576e8b(0xfa)]),await this[_0x576e8b(0x119)](_0x133f1e,_0x5d24d1['status']),console[_0x576e8b(0x15d)](_0x576e8b(0x116)+_0x512f26+'\x20processed:\x20'+_0x5d24d1[_0x576e8b(0x14f)]),_0x5d24d1['status']==='PAID'?_0x2374ee['json']({'success':!![],'message':_0x576e8b(0xf2),'result':{'status':'PAID','transactionId':_0x5d24d1[_0x576e8b(0xee)],'redirectUrl':_0x133f1e[_0x576e8b(0x12a)]}}):_0x2374ee[_0x576e8b(0x14f)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x576e8b(0x161),'failureReason':_0x5d24d1[_0x576e8b(0xfa)],'redirectUrl':_0x133f1e[_0x576e8b(0xfc)]}});}catch(_0xacdb19){_0x21ddc9(_0xacdb19);}},this[_0x5599e3(0x12e)]=new testGatewayService_1[(_0x5599e3(0x10c))](),this['webhookService']=new webhookService_1[(_0x5599e3(0x109))]();}async[a13_0x2ace25(0x162)](_0x1ceb9c,_0x2b025d,_0x5c9b94,_0x416ee6){const _0x4342af=a13_0x2ace25,_0x558d53=Date['now']();try{const _0x8948ef=_0x1ceb9c[_0x4342af(0xe7)],_0x2dfd48=_0x8948ef[_0x4342af(0x13d)];if(!_0x2dfd48?.[_0x4342af(0x126)]){console[_0x4342af(0x15d)](_0x4342af(0x131)+_0x8948ef['id']);return;}const _0x59d2de=_0x2b025d==='PAID'?_0x4342af(0xf0):'payment.failed';let _0x2f9cb4=[];if(_0x2dfd48[_0x4342af(0x14e)])try{_0x2f9cb4=Array[_0x4342af(0xf1)](_0x2dfd48['webhookEvents'])?_0x2dfd48['webhookEvents']:JSON['parse'](_0x2dfd48[_0x4342af(0x14e)]);}catch(_0x1c61f2){console[_0x4342af(0x13c)](_0x4342af(0x149),_0x1c61f2),_0x2f9cb4=[];}if(!_0x2f9cb4[_0x4342af(0x100)](_0x59d2de)){console[_0x4342af(0x15d)](_0x4342af(0x12f)+_0x59d2de+_0x4342af(0x145)+_0x8948ef['id']);return;}const _0x36f752={'event':_0x59d2de,'payment':{'id':_0x1ceb9c['id'],'order_id':_0x1ceb9c[_0x4342af(0x130)],'gateway_order_id':_0x1ceb9c[_0x4342af(0xf5)],'gateway':_0x4342af(0x10f),'amount':_0x1ceb9c[_0x4342af(0x14c)],'currency':_0x1ceb9c[_0x4342af(0x138)],'status':_0x2b025d[_0x4342af(0x154)](),'customer_email':_0x1ceb9c[_0x4342af(0x150)],'customer_name':_0x1ceb9c['customerName'],'transaction_id':_0x5c9b94,'failure_message':_0x416ee6,'created_at':_0x1ceb9c['createdAt'],'updated_at':new Date()}},_0x3f66ec=await fetch(_0x2dfd48[_0x4342af(0x126)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x4342af(0x11b)},'body':JSON[_0x4342af(0x15b)](_0x36f752)}),_0x348028=Date['now']()-_0x558d53;console[_0x4342af(0x15d)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x2dfd48[_0x4342af(0x126)]+_0x4342af(0x13f)+_0x3f66ec[_0x4342af(0x14f)]+'\x20('+_0x348028+'ms)');}catch(_0x1085b3){console[_0x4342af(0x13c)](_0x4342af(0x104),_0x1085b3);}}async[a13_0x2ace25(0x119)](_0x57fc61,_0x2552b6){const _0x59bab1=a13_0x2ace25;try{const {telegramBotService:_0x412449}=await Promise['resolve']()['then'](()=>__importStar(require(_0x59bab1(0x103)))),_0x153d0d={'PAID':_0x59bab1(0x15c),'FAILED':_0x59bab1(0x111)},_0x24732b=_0x153d0d[_0x2552b6];if(!_0x24732b)return;await _0x412449[_0x59bab1(0x129)](_0x57fc61[_0x59bab1(0x158)],_0x57fc61,_0x24732b);}catch(_0x4a731c){console[_0x59bab1(0x13c)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4a731c);}}}exports[a13_0x2ace25(0x118)]=TestGatewayController;