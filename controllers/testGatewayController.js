'use strict';const a13_0x2c6556=a13_0x2b9b;(function(_0x24ebcf,_0x59ac77){const _0x74082b=a13_0x2b9b,_0x161442=_0x24ebcf();while(!![]){try{const _0x26b656=parseInt(_0x74082b(0x216))/0x1*(parseInt(_0x74082b(0x1d0))/0x2)+-parseInt(_0x74082b(0x1ca))/0x3+parseInt(_0x74082b(0x1e3))/0x4+parseInt(_0x74082b(0x223))/0x5+parseInt(_0x74082b(0x1ff))/0x6+-parseInt(_0x74082b(0x1e6))/0x7+-parseInt(_0x74082b(0x1f9))/0x8;if(_0x26b656===_0x59ac77)break;else _0x161442['push'](_0x161442['shift']());}catch(_0x537d97){_0x161442['push'](_0x161442['shift']());}}}(a13_0xdfe0,0xe70db));function a13_0xdfe0(){const _0x52a745=['test_card','paidAt','now','__importDefault','processCard','545467HmdFlX','get','name','webhookUrl','TestGatewayService','replace','Payment\x20processed\x20successfully','Payment\x20not\x20found','amount','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','json','ms)','failUrl','4848455wvKenw',',\x20cannot\x20process','Any\x20future\x20date\x20(MM/YY)','paid','toLowerCase','stringify','getPaymentForm','webhookEvents','payment.failed','Payment\x20is\x20not\x20for\x20test\x20gateway','includes','PENDING','cardNumber','transactionId','getOwnPropertyDescriptor','default','3034629YRgTVK','payment','settings','PAID','application/json','customerName','4JvLBBo','shop','__importStar','findUnique','processCardPayment','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','create','then','successUrl','call','Payment\x20status\x20is\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','length','paymentMethod','currency','test_gateway','shopId','Webhook\x20event\x20','failureReason','4942608cvIefI','cardLast4','toISOString','10715187cOHEmp','__setModuleDefault','log','params','isArray','defineProperty','Any\x20other\x20card\x20number','update','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','../services/webhookService','payment.success','gatewayOrderId','4242\x204242\x204242\x204242','Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20with\x20status\x20','failed','test_gateway_','\x20not\x20enabled\x20for\x20shop\x20','sendShopWebhook','10392416ShCmIy','hasOwnProperty','error','__createBinding','\x20processed:\x20','ðŸ§ª\x20Test\x20Gateway\x20result:','8948724hlIEec','parse','orderId','failureMessage','TestGatewayController','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerEmail','WebhookService','testGatewayService','status','prototype','__esModule','slice','FAILED','sendPaymentNotification','getOwnPropertyNames','sendPaymentStatusNotification','createdAt'];a13_0xdfe0=function(){return _0x52a745;};return a13_0xdfe0();}var __createBinding=this&&this[a13_0x2c6556(0x1fc)]||(Object[a13_0x2c6556(0x1d6)]?function(_0x4813ab,_0x2c2bc4,_0x5dd8e5,_0x368140){const _0x5e2c60=a13_0x2c6556;if(_0x368140===undefined)_0x368140=_0x5dd8e5;var _0x3a58ec=Object[_0x5e2c60(0x1c8)](_0x2c2bc4,_0x5dd8e5);(!_0x3a58ec||(_0x5e2c60(0x217)in _0x3a58ec?!_0x2c2bc4[_0x5e2c60(0x20a)]:_0x3a58ec['writable']||_0x3a58ec['configurable']))&&(_0x3a58ec={'enumerable':!![],'get':function(){return _0x2c2bc4[_0x5dd8e5];}}),Object['defineProperty'](_0x4813ab,_0x368140,_0x3a58ec);}:function(_0x130562,_0x3e2892,_0x2fce89,_0x17b1c8){if(_0x17b1c8===undefined)_0x17b1c8=_0x2fce89;_0x130562[_0x17b1c8]=_0x3e2892[_0x2fce89];}),__setModuleDefault=this&&this[a13_0x2c6556(0x1e7)]||(Object[a13_0x2c6556(0x1d6)]?function(_0x25c321,_0x319f69){const _0x192b04=a13_0x2c6556;Object[_0x192b04(0x1eb)](_0x25c321,'default',{'enumerable':!![],'value':_0x319f69});}:function(_0x56ab70,_0x4aca4e){const _0x47d433=a13_0x2c6556;_0x56ab70[_0x47d433(0x1c9)]=_0x4aca4e;}),__importStar=this&&this[a13_0x2c6556(0x1d2)]||(function(){var _0x5ca810=function(_0x1650f7){const _0xd896c5=a13_0x2b9b;return _0x5ca810=Object[_0xd896c5(0x20e)]||function(_0x5f2764){const _0x5e242c=_0xd896c5;var _0x4a31cc=[];for(var _0xf719a4 in _0x5f2764)if(Object[_0x5e242c(0x209)][_0x5e242c(0x1fa)][_0x5e242c(0x1d9)](_0x5f2764,_0xf719a4))_0x4a31cc[_0x4a31cc[_0x5e242c(0x1dc)]]=_0xf719a4;return _0x4a31cc;},_0x5ca810(_0x1650f7);};return function(_0x458ca2){const _0x277521=a13_0x2b9b;if(_0x458ca2&&_0x458ca2[_0x277521(0x20a)])return _0x458ca2;var _0x443d72={};if(_0x458ca2!=null){for(var _0x408af2=_0x5ca810(_0x458ca2),_0x84f2b9=0x0;_0x84f2b9<_0x408af2[_0x277521(0x1dc)];_0x84f2b9++)if(_0x408af2[_0x84f2b9]!==_0x277521(0x1c9))__createBinding(_0x443d72,_0x458ca2,_0x408af2[_0x84f2b9]);}return __setModuleDefault(_0x443d72,_0x458ca2),_0x443d72;};}()),__importDefault=this&&this[a13_0x2c6556(0x214)]||function(_0x484717){const _0x3a4942=a13_0x2c6556;return _0x484717&&_0x484717[_0x3a4942(0x20a)]?_0x484717:{'default':_0x484717};};function a13_0x2b9b(_0x165a64,_0x5aedea){const _0xdfe0d7=a13_0xdfe0();return a13_0x2b9b=function(_0x2b9bdf,_0x24c5e8){_0x2b9bdf=_0x2b9bdf-0x1c1;let _0x8800bf=_0xdfe0d7[_0x2b9bdf];return _0x8800bf;},a13_0x2b9b(_0x165a64,_0x5aedea);}Object[a13_0x2c6556(0x1eb)](exports,a13_0x2c6556(0x20a),{'value':!![]}),exports[a13_0x2c6556(0x203)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0x2c6556(0x1ef)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x2d3620=a13_0x2c6556;this[_0x2d3620(0x229)]=async(_0xc7ea78,_0x487997,_0x563cef)=>{const _0x5768ab=_0x2d3620;try{const {paymentId:_0x16a91c}=_0xc7ea78[_0x5768ab(0x1e9)];console[_0x5768ab(0x1e8)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x16a91c);const _0x3f6e28=await database_1['default'][_0x5768ab(0x1cb)][_0x5768ab(0x1d3)]({'where':{'id':_0x16a91c},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3f6e28)return _0x487997['status'](0x194)[_0x5768ab(0x220)]({'success':![],'message':_0x5768ab(0x21d)});if(_0x3f6e28['gateway']!==_0x5768ab(0x1df))return _0x487997[_0x5768ab(0x208)](0x190)[_0x5768ab(0x220)]({'success':![],'message':_0x5768ab(0x1c3)});if(_0x3f6e28[_0x5768ab(0x208)]!==_0x5768ab(0x1c5))return _0x487997['status'](0x190)['json']({'success':![],'message':_0x5768ab(0x1da)+_0x3f6e28['status']+_0x5768ab(0x224)});_0x487997[_0x5768ab(0x220)]({'success':!![],'result':{'paymentId':_0x3f6e28['id'],'orderId':_0x3f6e28[_0x5768ab(0x1f1)],'amount':_0x3f6e28[_0x5768ab(0x21e)],'currency':_0x3f6e28['currency'],'merchantName':_0x3f6e28[_0x5768ab(0x1d1)]['name'],'description':'Payment\x20to\x20'+_0x3f6e28[_0x5768ab(0x1d1)][_0x5768ab(0x218)],'testInstructions':{'successCard':_0x5768ab(0x1f2),'failureCard':_0x5768ab(0x1ec),'expiryDate':_0x5768ab(0x225),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x44af3c){_0x563cef(_0x44af3c);}},this[_0x2d3620(0x215)]=async(_0x3904d6,_0x130176,_0x2e83c1)=>{const _0x175e83=_0x2d3620;try{const {paymentId:_0x418bcf}=_0x3904d6[_0x175e83(0x1e9)],_0x3a76f0=_0x3904d6['body'];console['log'](_0x175e83(0x21f)+_0x418bcf);const _0x5613c1=await database_1['default']['payment'][_0x175e83(0x1d3)]({'where':{'id':_0x418bcf},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5613c1)return _0x130176['status'](0x194)[_0x175e83(0x220)]({'success':![],'message':_0x175e83(0x21d)});if(_0x5613c1['gateway']!=='test_gateway')return _0x130176[_0x175e83(0x208)](0x190)['json']({'success':![],'message':_0x175e83(0x1c3)});if(_0x5613c1[_0x175e83(0x208)]!==_0x175e83(0x1c5))return _0x130176['status'](0x190)[_0x175e83(0x220)]({'success':![],'message':_0x175e83(0x1da)+_0x5613c1['status']+',\x20cannot\x20process'});const _0x272fef=await this[_0x175e83(0x207)][_0x175e83(0x1d4)]({'paymentId':_0x5613c1['id'],'orderId':_0x5613c1[_0x175e83(0x1f1)]||_0x5613c1['id'],'amount':_0x5613c1[_0x175e83(0x21e)],'currency':_0x5613c1[_0x175e83(0x1de)],'cardData':_0x3a76f0});console[_0x175e83(0x1e8)](_0x175e83(0x1fe),_0x272fef);const _0x4135c4={'status':_0x272fef[_0x175e83(0x208)],'updatedAt':new Date()};if(_0x272fef[_0x175e83(0x208)]===_0x175e83(0x1cd))_0x4135c4[_0x175e83(0x212)]=new Date(),_0x4135c4['gatewayPaymentId']=_0x272fef['transactionId'];else _0x272fef[_0x175e83(0x208)]===_0x175e83(0x20c)&&(_0x4135c4[_0x175e83(0x202)]=_0x272fef[_0x175e83(0x1e2)]);const _0x403cd0=_0x3a76f0[_0x175e83(0x1c6)][_0x175e83(0x21b)](/[\s-]/g,'');_0x4135c4[_0x175e83(0x1e4)]=_0x403cd0[_0x175e83(0x20b)](-0x4),_0x4135c4[_0x175e83(0x1dd)]=_0x175e83(0x211),await database_1['default'][_0x175e83(0x1cb)][_0x175e83(0x1ed)]({'where':{'id':_0x5613c1['id']},'data':_0x4135c4}),await database_1[_0x175e83(0x1c9)]['webhookLog'][_0x175e83(0x1d6)]({'data':{'paymentId':_0x5613c1['id'],'shopId':_0x5613c1['shopId'],'event':_0x175e83(0x1f6)+_0x272fef[_0x175e83(0x208)][_0x175e83(0x227)](),'statusCode':0xc8,'responseBody':JSON[_0x175e83(0x228)]({'oldStatus':_0x175e83(0x1c5),'newStatus':_0x272fef[_0x175e83(0x208)],'transactionId':_0x272fef[_0x175e83(0x1c7)],'failureReason':_0x272fef[_0x175e83(0x1e2)],'processedAt':new Date()[_0x175e83(0x1e5)]()})}}),await this[_0x175e83(0x1f8)](_0x5613c1,_0x272fef[_0x175e83(0x208)],_0x272fef[_0x175e83(0x1c7)],_0x272fef[_0x175e83(0x1e2)]),await this[_0x175e83(0x20f)](_0x5613c1,_0x272fef[_0x175e83(0x208)]),console[_0x175e83(0x1e8)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x418bcf+_0x175e83(0x1fd)+_0x272fef[_0x175e83(0x208)]),_0x272fef[_0x175e83(0x208)]===_0x175e83(0x1cd)?_0x130176['json']({'success':!![],'message':_0x175e83(0x21c),'result':{'status':_0x175e83(0x1cd),'transactionId':_0x272fef[_0x175e83(0x1c7)],'redirectUrl':_0x5613c1[_0x175e83(0x1d8)]}}):_0x130176['status'](0x190)[_0x175e83(0x220)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x272fef[_0x175e83(0x1e2)],'redirectUrl':_0x5613c1[_0x175e83(0x222)]}});}catch(_0x5268ee){_0x2e83c1(_0x5268ee);}},this[_0x2d3620(0x207)]=new testGatewayService_1[(_0x2d3620(0x21a))](),this['webhookService']=new webhookService_1[(_0x2d3620(0x206))]();}async['sendShopWebhook'](_0x27c086,_0x119ecf,_0x1653c3,_0x23fc88){const _0x2bdcc0=a13_0x2c6556,_0x1b63cc=Date[_0x2bdcc0(0x213)]();try{const _0x140a87=_0x27c086['shop'],_0x1cf0b8=_0x140a87[_0x2bdcc0(0x1cc)];if(!_0x1cf0b8?.[_0x2bdcc0(0x219)]){console[_0x2bdcc0(0x1e8)](_0x2bdcc0(0x204)+_0x140a87['id']);return;}const _0x3f3fde=_0x119ecf==='PAID'?_0x2bdcc0(0x1f0):_0x2bdcc0(0x1c2);let _0x613452=[];if(_0x1cf0b8['webhookEvents'])try{_0x613452=Array[_0x2bdcc0(0x1ea)](_0x1cf0b8[_0x2bdcc0(0x1c1)])?_0x1cf0b8['webhookEvents']:JSON[_0x2bdcc0(0x200)](_0x1cf0b8[_0x2bdcc0(0x1c1)]);}catch(_0x1ad995){console[_0x2bdcc0(0x1fb)]('Error\x20parsing\x20webhook\x20events:',_0x1ad995),_0x613452=[];}if(!_0x613452[_0x2bdcc0(0x1c4)](_0x3f3fde)){console[_0x2bdcc0(0x1e8)](_0x2bdcc0(0x1e1)+_0x3f3fde+_0x2bdcc0(0x1f7)+_0x140a87['id']);return;}const _0x8a6e8b={'event':_0x3f3fde,'payment':{'id':_0x27c086['id'],'order_id':_0x27c086[_0x2bdcc0(0x201)],'gateway_order_id':_0x27c086[_0x2bdcc0(0x1f1)],'gateway':'0000','amount':_0x27c086['amount'],'currency':_0x27c086[_0x2bdcc0(0x1de)],'status':_0x119ecf[_0x2bdcc0(0x227)](),'customer_email':_0x27c086[_0x2bdcc0(0x205)],'customer_name':_0x27c086[_0x2bdcc0(0x1cf)],'transaction_id':_0x1653c3,'failure_message':_0x23fc88,'created_at':_0x27c086[_0x2bdcc0(0x210)],'updated_at':new Date()}},_0x50de01=await fetch(_0x1cf0b8[_0x2bdcc0(0x219)],{'method':'POST','headers':{'Content-Type':_0x2bdcc0(0x1ce),'User-Agent':_0x2bdcc0(0x1ee)},'body':JSON[_0x2bdcc0(0x228)](_0x8a6e8b)}),_0x49624d=Date[_0x2bdcc0(0x213)]()-_0x1b63cc;console[_0x2bdcc0(0x1e8)](_0x2bdcc0(0x1f3)+_0x1cf0b8[_0x2bdcc0(0x219)]+_0x2bdcc0(0x1f4)+_0x50de01[_0x2bdcc0(0x208)]+'\x20('+_0x49624d+_0x2bdcc0(0x221));}catch(_0x3d2428){console['error'](_0x2bdcc0(0x1d5),_0x3d2428);}}async['sendPaymentStatusNotification'](_0x306c12,_0x129417){const _0x7753ca=a13_0x2c6556;try{const {telegramBotService:_0x26e26d}=await Promise['resolve']()[_0x7753ca(0x1d7)](()=>__importStar(require('../services/telegramBotService'))),_0x21919f={'PAID':_0x7753ca(0x226),'FAILED':_0x7753ca(0x1f5)},_0xd5f0ac=_0x21919f[_0x129417];if(!_0xd5f0ac)return;await _0x26e26d[_0x7753ca(0x20d)](_0x306c12[_0x7753ca(0x1e0)],_0x306c12,_0xd5f0ac);}catch(_0x3b8d6b){console['error'](_0x7753ca(0x1db),_0x3b8d6b);}}}exports[a13_0x2c6556(0x203)]=TestGatewayController;