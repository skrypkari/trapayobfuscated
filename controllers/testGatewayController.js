'use strict';const a13_0x4bfaf9=a13_0x3ac7;(function(_0x54b321,_0x454728){const _0x170fa7=a13_0x3ac7,_0x2bc120=_0x54b321();while(!![]){try{const _0x261a86=-parseInt(_0x170fa7(0x1dd))/0x1*(-parseInt(_0x170fa7(0x1e6))/0x2)+-parseInt(_0x170fa7(0x1f5))/0x3*(-parseInt(_0x170fa7(0x1fb))/0x4)+parseInt(_0x170fa7(0x1f0))/0x5*(-parseInt(_0x170fa7(0x1cd))/0x6)+-parseInt(_0x170fa7(0x208))/0x7+parseInt(_0x170fa7(0x203))/0x8+parseInt(_0x170fa7(0x207))/0x9+-parseInt(_0x170fa7(0x1f8))/0xa*(parseInt(_0x170fa7(0x21d))/0xb);if(_0x261a86===_0x454728)break;else _0x2bc120['push'](_0x2bc120['shift']());}catch(_0x2a4ce2){_0x2bc120['push'](_0x2bc120['shift']());}}}(a13_0x26b7,0x5fd4c));function a13_0x26b7(){const _0x2a36db=['Payment\x20failed','\x20processed:\x20','shop','Payment\x20is\x20not\x20for\x20test\x20gateway','payment.failed','30047bKrmAn','gatewayPaymentId','toISOString','paidAt','create','replace','Payment\x20not\x20found','Any\x20name','../services/gateways/testGatewayService','40vBqWjM','sendPaymentStatusNotification','failUrl','now','../services/webhookService','shopId','4242\x204242\x204242\x204242','includes','test_gateway_','ðŸ§ª\x20Test\x20Gateway\x20result:','5OUPSPy','paymentMethod','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','update','744945BovBIR','cardNumber','processCardPayment','10AfpXIr','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookUrl','12MNlmsY','configurable','TestGatewayController','Payment\x20processed\x20successfully','failureMessage','TestGatewayService','error','writable','6220552NBlGXn','âœ…\x20Test\x20Gateway\x20payment\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','prototype','1496835AiTczp','3734612niHsLH','ms)','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.success','slice','failed','PENDING','params','webhookEvents','FAILED','json','customerName','default','getPaymentForm','length','findUnique','WebhookService','PAID','toLowerCase','log','getOwnPropertyNames','14836646spGVvd','status','../services/telegramBotService','defineProperty','Payment\x20to\x20','isArray','Payment\x20status\x20is\x20','Webhook\x20event\x20','amount','transactionId','webhookLog','then','createdAt','0000','testGatewayService','orderId','Any\x20other\x20card\x20number','currency',',\x20cannot\x20process','gateway','resolve','name','cardLast4','successUrl','stringify','\x20with\x20status\x20','test_gateway','__importDefault','gatewayOrderId','failureReason','paid','89658glyljV','../config/database','parse','__importStar','__setModuleDefault','get','__esModule','webhookService','payment','Any\x203-4\x20digits','application/json'];a13_0x26b7=function(){return _0x2a36db;};return a13_0x26b7();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x3efa5a,_0x19c24e,_0x24f5b0,_0x54217d){const _0x5a9fb5=a13_0x3ac7;if(_0x54217d===undefined)_0x54217d=_0x24f5b0;var _0x15ffda=Object['getOwnPropertyDescriptor'](_0x19c24e,_0x24f5b0);(!_0x15ffda||(_0x5a9fb5(0x1d2)in _0x15ffda?!_0x19c24e[_0x5a9fb5(0x1d3)]:_0x15ffda[_0x5a9fb5(0x202)]||_0x15ffda[_0x5a9fb5(0x1fc)]))&&(_0x15ffda={'enumerable':!![],'get':function(){return _0x19c24e[_0x24f5b0];}}),Object[_0x5a9fb5(0x220)](_0x3efa5a,_0x54217d,_0x15ffda);}:function(_0x2a1df8,_0x50d998,_0x27e3cd,_0x35925c){if(_0x35925c===undefined)_0x35925c=_0x27e3cd;_0x2a1df8[_0x35925c]=_0x50d998[_0x27e3cd];}),__setModuleDefault=this&&this[a13_0x4bfaf9(0x1d1)]||(Object[a13_0x4bfaf9(0x1e1)]?function(_0x23dde4,_0x23551e){const _0x173f8e=a13_0x4bfaf9;Object[_0x173f8e(0x220)](_0x23dde4,_0x173f8e(0x214),{'enumerable':!![],'value':_0x23551e});}:function(_0xa3173c,_0x18c87d){const _0x139588=a13_0x4bfaf9;_0xa3173c[_0x139588(0x214)]=_0x18c87d;}),__importStar=this&&this[a13_0x4bfaf9(0x1d0)]||(function(){var _0x1568c5=function(_0xd473fc){const _0xc953d0=a13_0x3ac7;return _0x1568c5=Object[_0xc953d0(0x21c)]||function(_0x365a52){const _0x4de942=_0xc953d0;var _0x3b26e1=[];for(var _0x1e5572 in _0x365a52)if(Object[_0x4de942(0x206)]['hasOwnProperty']['call'](_0x365a52,_0x1e5572))_0x3b26e1[_0x3b26e1[_0x4de942(0x216)]]=_0x1e5572;return _0x3b26e1;},_0x1568c5(_0xd473fc);};return function(_0x573dd9){const _0x1812a1=a13_0x3ac7;if(_0x573dd9&&_0x573dd9['__esModule'])return _0x573dd9;var _0x4504e5={};if(_0x573dd9!=null){for(var _0x3801bb=_0x1568c5(_0x573dd9),_0x4904d7=0x0;_0x4904d7<_0x3801bb[_0x1812a1(0x216)];_0x4904d7++)if(_0x3801bb[_0x4904d7]!==_0x1812a1(0x214))__createBinding(_0x4504e5,_0x573dd9,_0x3801bb[_0x4904d7]);}return __setModuleDefault(_0x4504e5,_0x573dd9),_0x4504e5;};}()),__importDefault=this&&this[a13_0x4bfaf9(0x1c9)]||function(_0xef907f){const _0x4fbb3e=a13_0x4bfaf9;return _0xef907f&&_0xef907f[_0x4fbb3e(0x1d3)]?_0xef907f:{'default':_0xef907f};};function a13_0x3ac7(_0x5da2e0,_0x8892c1){const _0x26b7f4=a13_0x26b7();return a13_0x3ac7=function(_0x3ac7aa,_0x1d7919){_0x3ac7aa=_0x3ac7aa-0x1b5;let _0x2fa1c7=_0x26b7f4[_0x3ac7aa];return _0x2fa1c7;},a13_0x3ac7(_0x5da2e0,_0x8892c1);}Object[a13_0x4bfaf9(0x220)](exports,a13_0x4bfaf9(0x1d3),{'value':!![]}),exports[a13_0x4bfaf9(0x1fd)]=void 0x0;const testGatewayService_1=require(a13_0x4bfaf9(0x1e5)),webhookService_1=require(a13_0x4bfaf9(0x1ea)),database_1=__importDefault(require(a13_0x4bfaf9(0x1ce)));class TestGatewayController{constructor(){const _0x22284d=a13_0x4bfaf9;this[_0x22284d(0x215)]=async(_0x57c69a,_0xf421d3,_0x188500)=>{const _0x4e9b94=_0x22284d;try{const {paymentId:_0x29c9a0}=_0x57c69a[_0x4e9b94(0x20f)];console['log'](_0x4e9b94(0x205)+_0x29c9a0);const _0x493a5e=await database_1[_0x4e9b94(0x214)][_0x4e9b94(0x1d5)]['findUnique']({'where':{'id':_0x29c9a0},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x493a5e)return _0xf421d3['status'](0x194)['json']({'success':![],'message':_0x4e9b94(0x1e3)});if(_0x493a5e[_0x4e9b94(0x1c1)]!==_0x4e9b94(0x1c8))return _0xf421d3[_0x4e9b94(0x21e)](0x190)[_0x4e9b94(0x212)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x493a5e[_0x4e9b94(0x21e)]!==_0x4e9b94(0x20e))return _0xf421d3[_0x4e9b94(0x21e)](0x190)[_0x4e9b94(0x212)]({'success':![],'message':_0x4e9b94(0x223)+_0x493a5e[_0x4e9b94(0x21e)]+',\x20cannot\x20process'});_0xf421d3[_0x4e9b94(0x212)]({'success':!![],'result':{'paymentId':_0x493a5e['id'],'orderId':_0x493a5e[_0x4e9b94(0x1ca)],'amount':_0x493a5e[_0x4e9b94(0x1b6)],'currency':_0x493a5e['currency'],'merchantName':_0x493a5e['shop'][_0x4e9b94(0x1c3)],'description':_0x4e9b94(0x221)+_0x493a5e[_0x4e9b94(0x1da)]['name'],'testInstructions':{'successCard':_0x4e9b94(0x1ec),'failureCard':_0x4e9b94(0x1be),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x4e9b94(0x1d6),'holderName':_0x4e9b94(0x1e4)}}});}catch(_0x3c3263){_0x188500(_0x3c3263);}},this['processCard']=async(_0x4378c9,_0x437a84,_0xce9e06)=>{const _0x1a508b=_0x22284d;try{const {paymentId:_0x53ead0}=_0x4378c9[_0x1a508b(0x20f)],_0x369952=_0x4378c9['body'];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x53ead0);const _0xc7ccc=await database_1[_0x1a508b(0x214)][_0x1a508b(0x1d5)][_0x1a508b(0x217)]({'where':{'id':_0x53ead0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xc7ccc)return _0x437a84[_0x1a508b(0x21e)](0x194)[_0x1a508b(0x212)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xc7ccc[_0x1a508b(0x1c1)]!==_0x1a508b(0x1c8))return _0x437a84[_0x1a508b(0x21e)](0x190)['json']({'success':![],'message':_0x1a508b(0x1db)});if(_0xc7ccc[_0x1a508b(0x21e)]!==_0x1a508b(0x20e))return _0x437a84[_0x1a508b(0x21e)](0x190)[_0x1a508b(0x212)]({'success':![],'message':_0x1a508b(0x223)+_0xc7ccc[_0x1a508b(0x21e)]+_0x1a508b(0x1c0)});const _0x84892e=await this[_0x1a508b(0x1bc)][_0x1a508b(0x1f7)]({'paymentId':_0xc7ccc['id'],'orderId':_0xc7ccc['gatewayOrderId']||_0xc7ccc['id'],'amount':_0xc7ccc[_0x1a508b(0x1b6)],'currency':_0xc7ccc['currency'],'cardData':_0x369952});console[_0x1a508b(0x21b)](_0x1a508b(0x1ef),_0x84892e);const _0x535f5f={'status':_0x84892e[_0x1a508b(0x21e)],'updatedAt':new Date()};if(_0x84892e[_0x1a508b(0x21e)]==='PAID')_0x535f5f[_0x1a508b(0x1e0)]=new Date(),_0x535f5f[_0x1a508b(0x1de)]=_0x84892e[_0x1a508b(0x1b7)];else _0x84892e[_0x1a508b(0x21e)]===_0x1a508b(0x211)&&(_0x535f5f[_0x1a508b(0x1ff)]=_0x84892e['failureReason']);const _0x42c880=_0x369952[_0x1a508b(0x1f6)][_0x1a508b(0x1e2)](/[\s-]/g,'');_0x535f5f[_0x1a508b(0x1c4)]=_0x42c880[_0x1a508b(0x20c)](-0x4),_0x535f5f[_0x1a508b(0x1f1)]='test_card',await database_1['default']['payment'][_0x1a508b(0x1f4)]({'where':{'id':_0xc7ccc['id']},'data':_0x535f5f}),await database_1[_0x1a508b(0x214)][_0x1a508b(0x1b8)][_0x1a508b(0x1e1)]({'data':{'paymentId':_0xc7ccc['id'],'shopId':_0xc7ccc[_0x1a508b(0x1eb)],'event':_0x1a508b(0x1ee)+_0x84892e[_0x1a508b(0x21e)][_0x1a508b(0x21a)](),'statusCode':0xc8,'responseBody':JSON[_0x1a508b(0x1c6)]({'oldStatus':'PENDING','newStatus':_0x84892e['status'],'transactionId':_0x84892e[_0x1a508b(0x1b7)],'failureReason':_0x84892e[_0x1a508b(0x1cb)],'processedAt':new Date()[_0x1a508b(0x1df)]()})}}),await this['sendShopWebhook'](_0xc7ccc,_0x84892e[_0x1a508b(0x21e)],_0x84892e[_0x1a508b(0x1b7)],_0x84892e[_0x1a508b(0x1cb)]),await this[_0x1a508b(0x1e7)](_0xc7ccc,_0x84892e[_0x1a508b(0x21e)]),console[_0x1a508b(0x21b)](_0x1a508b(0x204)+_0x53ead0+_0x1a508b(0x1d9)+_0x84892e[_0x1a508b(0x21e)]),_0x84892e[_0x1a508b(0x21e)]==='PAID'?_0x437a84[_0x1a508b(0x212)]({'success':!![],'message':_0x1a508b(0x1fe),'result':{'status':'PAID','transactionId':_0x84892e['transactionId'],'redirectUrl':_0xc7ccc[_0x1a508b(0x1c5)]}}):_0x437a84[_0x1a508b(0x21e)](0x190)[_0x1a508b(0x212)]({'success':![],'message':_0x1a508b(0x1d8),'result':{'status':_0x1a508b(0x211),'failureReason':_0x84892e[_0x1a508b(0x1cb)],'redirectUrl':_0xc7ccc[_0x1a508b(0x1e8)]}});}catch(_0x22c9d5){_0xce9e06(_0x22c9d5);}},this[_0x22284d(0x1bc)]=new testGatewayService_1[(_0x22284d(0x200))](),this[_0x22284d(0x1d4)]=new webhookService_1[(_0x22284d(0x218))]();}async['sendShopWebhook'](_0x4d64ff,_0x2e3791,_0x1e7128,_0x1d394c){const _0x3fbb72=a13_0x4bfaf9,_0x1e3e61=Date[_0x3fbb72(0x1e9)]();try{const _0x113d5d=_0x4d64ff[_0x3fbb72(0x1da)],_0x3d5fec=_0x113d5d['settings'];if(!_0x3d5fec?.[_0x3fbb72(0x1fa)]){console[_0x3fbb72(0x21b)](_0x3fbb72(0x1f2)+_0x113d5d['id']);return;}const _0x4c3390=_0x2e3791===_0x3fbb72(0x219)?_0x3fbb72(0x20b):_0x3fbb72(0x1dc);let _0x233e1a=[];if(_0x3d5fec[_0x3fbb72(0x210)])try{_0x233e1a=Array[_0x3fbb72(0x222)](_0x3d5fec[_0x3fbb72(0x210)])?_0x3d5fec[_0x3fbb72(0x210)]:JSON[_0x3fbb72(0x1cf)](_0x3d5fec['webhookEvents']);}catch(_0x594427){console['error'](_0x3fbb72(0x1f3),_0x594427),_0x233e1a=[];}if(!_0x233e1a[_0x3fbb72(0x1ed)](_0x4c3390)){console[_0x3fbb72(0x21b)](_0x3fbb72(0x1b5)+_0x4c3390+'\x20not\x20enabled\x20for\x20shop\x20'+_0x113d5d['id']);return;}const _0xba5cff={'event':_0x4c3390,'payment':{'id':_0x4d64ff['id'],'order_id':_0x4d64ff[_0x3fbb72(0x1bd)],'gateway_order_id':_0x4d64ff[_0x3fbb72(0x1ca)],'gateway':_0x3fbb72(0x1bb),'amount':_0x4d64ff[_0x3fbb72(0x1b6)],'currency':_0x4d64ff[_0x3fbb72(0x1bf)],'status':_0x2e3791[_0x3fbb72(0x21a)](),'customer_email':_0x4d64ff['customerEmail'],'customer_name':_0x4d64ff[_0x3fbb72(0x213)],'transaction_id':_0x1e7128,'failure_message':_0x1d394c,'created_at':_0x4d64ff[_0x3fbb72(0x1ba)],'updated_at':new Date()}},_0x28921=await fetch(_0x3d5fec['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x3fbb72(0x1d7),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3fbb72(0x1c6)](_0xba5cff)}),_0x3be3ea=Date[_0x3fbb72(0x1e9)]()-_0x1e3e61;console[_0x3fbb72(0x21b)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x3d5fec[_0x3fbb72(0x1fa)]+_0x3fbb72(0x1c7)+_0x28921[_0x3fbb72(0x21e)]+'\x20('+_0x3be3ea+_0x3fbb72(0x209));}catch(_0xeda4aa){console[_0x3fbb72(0x201)](_0x3fbb72(0x1f9),_0xeda4aa);}}async[a13_0x4bfaf9(0x1e7)](_0x4681e0,_0xbe960e){const _0x507c51=a13_0x4bfaf9;try{const {telegramBotService:_0x17b781}=await Promise[_0x507c51(0x1c2)]()[_0x507c51(0x1b9)](()=>__importStar(require(_0x507c51(0x21f)))),_0x10acf8={'PAID':_0x507c51(0x1cc),'FAILED':_0x507c51(0x20d)},_0x2bfd89=_0x10acf8[_0xbe960e];if(!_0x2bfd89)return;await _0x17b781['sendPaymentNotification'](_0x4681e0[_0x507c51(0x1eb)],_0x4681e0,_0x2bfd89);}catch(_0x45aa3f){console[_0x507c51(0x201)](_0x507c51(0x20a),_0x45aa3f);}}}exports[a13_0x4bfaf9(0x1fd)]=TestGatewayController;