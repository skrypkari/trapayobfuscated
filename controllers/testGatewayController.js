'use strict';function a19_0x2346(){const _0x526473=['test_gateway_','FAILED','__importDefault','successUrl','cardLast4','__esModule','Any\x20name','PENDING','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','hasOwnProperty','isArray','\x20processed:\x20','test_card','4242\x204242\x204242\x204242','âœ…\x20Test\x20Gateway\x20payment\x20','findUnique','get',',\x20cannot\x20process','gateway','Payment\x20processed\x20successfully','stringify','default','currency','error','TestGatewayService','slice','ðŸ§ª\x20Test\x20Gateway\x20result:','processCardPayment','$transaction','../services/telegramBotService','then','failureMessage','TestGatewayController','5UoogpQ','4633461tBTvtM','call','7976OZQafQ','âŒ\x20Payment\x20link\x20','createdAt','orderId','shopId','failureReason','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','13612060YRhtah','defineProperty','âœ…\x20Payment\x20link\x20','shop','create','application/json','\x20not\x20found','type','__setModuleDefault','payment','__createBinding','parse','369FJKAfy','now','2820632IFXjGB','transactionId','COMPLETED','testGatewayService','getOwnPropertyDescriptor','Test\x20Gateway\x20webhook\x20sent\x20to\x20','currentPayments','Any\x20future\x20date\x20(MM/YY)','webhookUrl','paymentLink','53217SSCeyn','settings','Payment\x20is\x20not\x20for\x20test\x20gateway','toISOString','params','Error\x20parsing\x20webhook\x20events:','\x20updated:\x20currentPayments=','replace','name','SINGLE','sendShopWebhook','gatewayOrderId','Payment\x20status\x20is\x20','Webhook\x20event\x20','14RUMBsm','payment.success','../config/database','amount','prototype','update','log','failUrl','992740dfdebZ','getOwnPropertyNames','Payment\x20System/1.0\x20(Test\x20Gateway)','Any\x203-4\x20digits','paidAt','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','customerName','967926KCKVPB','Payment\x20failed','Any\x20other\x20card\x20number','ms)',',\x20status=','sendPaymentStatusNotification','0000','test_gateway','status','ðŸ“ˆ\x20Found\x20payment\x20link\x20','payment.failed','PAID','POST','webhookEvents','includes','paymentLinkId','json','webhookService','Payment\x20not\x20found','\x20with\x20status\x20','webhookLog','\x20->\x20','getPaymentForm'];a19_0x2346=function(){return _0x526473;};return a19_0x2346();}const a19_0x52df8a=a19_0x2b96;(function(_0x1b8d9d,_0x3e87f7){const _0x344e50=a19_0x2b96,_0x4d7c2d=_0x1b8d9d();while(!![]){try{const _0x4bb557=parseInt(_0x344e50(0x1d1))/0x1*(-parseInt(_0x344e50(0x1df))/0x2)+-parseInt(_0x344e50(0x1c5))/0x3*(parseInt(_0x344e50(0x1b2))/0x4)+parseInt(_0x344e50(0x1af))/0x5*(-parseInt(_0x344e50(0x1ee))/0x6)+-parseInt(_0x344e50(0x1e7))/0x7+parseInt(_0x344e50(0x1c7))/0x8+-parseInt(_0x344e50(0x1b0))/0x9+parseInt(_0x344e50(0x1b9))/0xa;if(_0x4bb557===_0x3e87f7)break;else _0x4d7c2d['push'](_0x4d7c2d['shift']());}catch(_0x47ac12){_0x4d7c2d['push'](_0x4d7c2d['shift']());}}}(a19_0x2346,0x43e12));var __createBinding=this&&this[a19_0x52df8a(0x1c3)]||(Object[a19_0x52df8a(0x1bd)]?function(_0x93f9ea,_0x4d27ab,_0x4d6b63,_0x3115a0){const _0x14d230=a19_0x52df8a;if(_0x3115a0===undefined)_0x3115a0=_0x4d6b63;var _0x385af4=Object[_0x14d230(0x1cb)](_0x4d27ab,_0x4d6b63);(!_0x385af4||(_0x14d230(0x19e)in _0x385af4?!_0x4d27ab[_0x14d230(0x20a)]:_0x385af4['writable']||_0x385af4['configurable']))&&(_0x385af4={'enumerable':!![],'get':function(){return _0x4d27ab[_0x4d6b63];}}),Object[_0x14d230(0x1ba)](_0x93f9ea,_0x3115a0,_0x385af4);}:function(_0x56e5b7,_0x55704f,_0x8ffbf6,_0x1ed117){if(_0x1ed117===undefined)_0x1ed117=_0x8ffbf6;_0x56e5b7[_0x1ed117]=_0x55704f[_0x8ffbf6];}),__setModuleDefault=this&&this[a19_0x52df8a(0x1c1)]||(Object[a19_0x52df8a(0x1bd)]?function(_0x3d5108,_0x170c2b){const _0x2daf3a=a19_0x52df8a;Object[_0x2daf3a(0x1ba)](_0x3d5108,_0x2daf3a(0x1a3),{'enumerable':!![],'value':_0x170c2b});}:function(_0x180a9b,_0x27e897){const _0x12ccf8=a19_0x52df8a;_0x180a9b[_0x12ccf8(0x1a3)]=_0x27e897;}),__importStar=this&&this['__importStar']||(function(){var _0x2fadfd=function(_0x88fd03){const _0x48e837=a19_0x2b96;return _0x2fadfd=Object[_0x48e837(0x1e8)]||function(_0x541a14){const _0x13d6a7=_0x48e837;var _0x9b49bb=[];for(var _0x4cc7c6 in _0x541a14)if(Object[_0x13d6a7(0x1e3)][_0x13d6a7(0x20f)][_0x13d6a7(0x1b1)](_0x541a14,_0x4cc7c6))_0x9b49bb[_0x9b49bb['length']]=_0x4cc7c6;return _0x9b49bb;},_0x2fadfd(_0x88fd03);};return function(_0x2c771d){const _0x548da5=a19_0x2b96;if(_0x2c771d&&_0x2c771d[_0x548da5(0x20a)])return _0x2c771d;var _0xb80186={};if(_0x2c771d!=null){for(var _0xb2444c=_0x2fadfd(_0x2c771d),_0x3533b9=0x0;_0x3533b9<_0xb2444c['length'];_0x3533b9++)if(_0xb2444c[_0x3533b9]!==_0x548da5(0x1a3))__createBinding(_0xb80186,_0x2c771d,_0xb2444c[_0x3533b9]);}return __setModuleDefault(_0xb80186,_0x2c771d),_0xb80186;};}()),__importDefault=this&&this[a19_0x52df8a(0x207)]||function(_0x5bddc8){const _0x17faf4=a19_0x52df8a;return _0x5bddc8&&_0x5bddc8[_0x17faf4(0x20a)]?_0x5bddc8:{'default':_0x5bddc8};};Object[a19_0x52df8a(0x1ba)](exports,'__esModule',{'value':!![]}),exports[a19_0x52df8a(0x1ae)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a19_0x52df8a(0x1e1)));class TestGatewayController{constructor(){const _0xcac0d8=a19_0x52df8a;this[_0xcac0d8(0x204)]=async(_0x2fc663,_0x28bfb7,_0x7acace)=>{const _0x5a2dbe=_0xcac0d8;try{const {paymentId:_0x1451ea}=_0x2fc663[_0x5a2dbe(0x1d5)];console[_0x5a2dbe(0x1e5)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x1451ea);const _0x2c0fb8=await database_1[_0x5a2dbe(0x1a3)][_0x5a2dbe(0x1c2)][_0x5a2dbe(0x19d)]({'where':{'id':_0x1451ea},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2c0fb8)return _0x28bfb7[_0x5a2dbe(0x1f6)](0x194)[_0x5a2dbe(0x1fe)]({'success':![],'message':_0x5a2dbe(0x200)});if(_0x2c0fb8[_0x5a2dbe(0x1a0)]!==_0x5a2dbe(0x1f5))return _0x28bfb7[_0x5a2dbe(0x1f6)](0x190)[_0x5a2dbe(0x1fe)]({'success':![],'message':_0x5a2dbe(0x1d3)});if(_0x2c0fb8[_0x5a2dbe(0x1f6)]!==_0x5a2dbe(0x20c))return _0x28bfb7['status'](0x190)[_0x5a2dbe(0x1fe)]({'success':![],'message':_0x5a2dbe(0x1dd)+_0x2c0fb8[_0x5a2dbe(0x1f6)]+_0x5a2dbe(0x19f)});_0x28bfb7[_0x5a2dbe(0x1fe)]({'success':!![],'result':{'paymentId':_0x2c0fb8['id'],'orderId':_0x2c0fb8[_0x5a2dbe(0x1dc)],'amount':_0x2c0fb8['amount'],'currency':_0x2c0fb8[_0x5a2dbe(0x1a4)],'merchantName':_0x2c0fb8['shop'][_0x5a2dbe(0x1d9)],'description':'Payment\x20to\x20'+_0x2c0fb8[_0x5a2dbe(0x1bc)]['name'],'testInstructions':{'successCard':_0x5a2dbe(0x213),'failureCard':_0x5a2dbe(0x1f0),'expiryDate':_0x5a2dbe(0x1ce),'cvc':_0x5a2dbe(0x1ea),'holderName':_0x5a2dbe(0x20b)}}});}catch(_0xb406f8){_0x7acace(_0xb406f8);}},this['processCard']=async(_0x3ca209,_0x34bfa6,_0xeae95)=>{const _0x46fce4=_0xcac0d8;try{const {paymentId:_0x4932a7}=_0x3ca209[_0x46fce4(0x1d5)],_0xd24022=_0x3ca209['body'];console[_0x46fce4(0x1e5)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x4932a7);const _0x4a8861=await database_1[_0x46fce4(0x1a3)][_0x46fce4(0x1c2)]['findUnique']({'where':{'id':_0x4932a7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4a8861)return _0x34bfa6[_0x46fce4(0x1f6)](0x194)[_0x46fce4(0x1fe)]({'success':![],'message':_0x46fce4(0x200)});if(_0x4a8861[_0x46fce4(0x1a0)]!==_0x46fce4(0x1f5))return _0x34bfa6[_0x46fce4(0x1f6)](0x190)[_0x46fce4(0x1fe)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4a8861['status']!==_0x46fce4(0x20c))return _0x34bfa6[_0x46fce4(0x1f6)](0x190)[_0x46fce4(0x1fe)]({'success':![],'message':_0x46fce4(0x1dd)+_0x4a8861['status']+_0x46fce4(0x19f)});const _0x10d166=await this[_0x46fce4(0x1ca)][_0x46fce4(0x1a9)]({'paymentId':_0x4a8861['id'],'orderId':_0x4a8861[_0x46fce4(0x1dc)]||_0x4a8861['id'],'amount':_0x4a8861[_0x46fce4(0x1e2)],'currency':_0x4a8861[_0x46fce4(0x1a4)],'cardData':_0xd24022});console['log'](_0x46fce4(0x1a8),_0x10d166);const _0x56e480={'status':_0x10d166[_0x46fce4(0x1f6)],'updatedAt':new Date()};if(_0x10d166[_0x46fce4(0x1f6)]===_0x46fce4(0x1f9))_0x56e480[_0x46fce4(0x1eb)]=new Date(),_0x56e480['gatewayPaymentId']=_0x10d166[_0x46fce4(0x1c8)];else _0x10d166[_0x46fce4(0x1f6)]===_0x46fce4(0x206)&&(_0x56e480[_0x46fce4(0x1ad)]=_0x10d166[_0x46fce4(0x1b7)]);const _0x4c5d58=_0xd24022['cardNumber'][_0x46fce4(0x1d8)](/[\s-]/g,'');_0x56e480[_0x46fce4(0x209)]=_0x4c5d58[_0x46fce4(0x1a7)](-0x4),_0x56e480['paymentMethod']=_0x46fce4(0x212),await database_1['default'][_0x46fce4(0x1c2)][_0x46fce4(0x1e4)]({'where':{'id':_0x4a8861['id']},'data':_0x56e480});if(_0x10d166[_0x46fce4(0x1f6)]===_0x46fce4(0x1f9)&&_0x4a8861[_0x46fce4(0x1fd)]){console['log'](_0x46fce4(0x1b8)+_0x4a8861['id']+_0x46fce4(0x1ec));try{await database_1[_0x46fce4(0x1a3)][_0x46fce4(0x1aa)](async _0x166bbd=>{const _0x652005=_0x46fce4,_0x483505=await _0x166bbd[_0x652005(0x1d0)][_0x652005(0x19d)]({'where':{'id':_0x4a8861[_0x652005(0x1fd)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x483505){console[_0x652005(0x1e5)](_0x652005(0x1f7)+_0x483505['id']+':\x20type='+_0x483505['type']+',\x20currentPayments='+_0x483505['currentPayments']+',\x20status='+_0x483505[_0x652005(0x1f6)]);const _0x2628c0=_0x483505[_0x652005(0x1cd)]+0x1,_0x40c9f4=_0x483505[_0x652005(0x1c0)]===_0x652005(0x1da)?_0x652005(0x1c9):_0x483505[_0x652005(0x1f6)];await _0x166bbd['paymentLink']['update']({'where':{'id':_0x4a8861[_0x652005(0x1fd)]},'data':{'currentPayments':_0x2628c0,'status':_0x40c9f4,'updatedAt':new Date()}}),console[_0x652005(0x1e5)](_0x652005(0x1bb)+_0x483505['id']+_0x652005(0x1d7)+_0x483505[_0x652005(0x1cd)]+_0x652005(0x203)+_0x2628c0+_0x652005(0x1f2)+_0x483505[_0x652005(0x1f6)]+'\x20->\x20'+_0x40c9f4);}else console[_0x652005(0x1e5)](_0x652005(0x1b3)+_0x4a8861[_0x652005(0x1fd)]+_0x652005(0x1bf));});}catch(_0x4f5e18){console[_0x46fce4(0x1a5)]('âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x4f5e18);}}await database_1[_0x46fce4(0x1a3)][_0x46fce4(0x202)][_0x46fce4(0x1bd)]({'data':{'paymentId':_0x4a8861['id'],'shopId':_0x4a8861[_0x46fce4(0x1b6)],'event':_0x46fce4(0x205)+_0x10d166['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x46fce4(0x20c),'newStatus':_0x10d166['status'],'transactionId':_0x10d166['transactionId'],'failureReason':_0x10d166['failureReason'],'processedAt':new Date()[_0x46fce4(0x1d4)]()})}}),await this[_0x46fce4(0x1db)](_0x4a8861,_0x10d166['status'],_0x10d166[_0x46fce4(0x1c8)],_0x10d166['failureReason']),await this['sendPaymentStatusNotification'](_0x4a8861,_0x10d166['status']),console[_0x46fce4(0x1e5)](_0x46fce4(0x19c)+_0x4932a7+_0x46fce4(0x211)+_0x10d166['status']),_0x10d166[_0x46fce4(0x1f6)]===_0x46fce4(0x1f9)?_0x34bfa6[_0x46fce4(0x1fe)]({'success':!![],'message':_0x46fce4(0x1a1),'result':{'status':_0x46fce4(0x1f9),'transactionId':_0x10d166[_0x46fce4(0x1c8)],'redirectUrl':_0x4a8861[_0x46fce4(0x208)]}}):_0x34bfa6[_0x46fce4(0x1f6)](0x190)[_0x46fce4(0x1fe)]({'success':![],'message':_0x46fce4(0x1ef),'result':{'status':_0x46fce4(0x206),'failureReason':_0x10d166[_0x46fce4(0x1b7)],'redirectUrl':_0x4a8861[_0x46fce4(0x1e6)]}});}catch(_0x365744){_0xeae95(_0x365744);}},this[_0xcac0d8(0x1ca)]=new testGatewayService_1[(_0xcac0d8(0x1a6))](),this[_0xcac0d8(0x1ff)]=new webhookService_1['WebhookService']();}async[a19_0x52df8a(0x1db)](_0x14e29e,_0x4a86a6,_0x55c798,_0x1b3582){const _0x40ed9e=a19_0x52df8a,_0x47c2aa=Date[_0x40ed9e(0x1c6)]();try{const _0x1bc65b=_0x14e29e['shop'],_0x54da9c=_0x1bc65b[_0x40ed9e(0x1d2)];if(!_0x54da9c?.[_0x40ed9e(0x1cf)]){console[_0x40ed9e(0x1e5)](_0x40ed9e(0x20d)+_0x1bc65b['id']);return;}const _0x2270cf=_0x4a86a6===_0x40ed9e(0x1f9)?_0x40ed9e(0x1e0):_0x40ed9e(0x1f8);let _0x1c505a=[];if(_0x54da9c[_0x40ed9e(0x1fb)])try{_0x1c505a=Array[_0x40ed9e(0x210)](_0x54da9c[_0x40ed9e(0x1fb)])?_0x54da9c[_0x40ed9e(0x1fb)]:JSON[_0x40ed9e(0x1c4)](_0x54da9c['webhookEvents']);}catch(_0x3e1c03){console[_0x40ed9e(0x1a5)](_0x40ed9e(0x1d6),_0x3e1c03),_0x1c505a=[];}if(!_0x1c505a[_0x40ed9e(0x1fc)](_0x2270cf)){console['log'](_0x40ed9e(0x1de)+_0x2270cf+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1bc65b['id']);return;}const _0x325dbf={'event':_0x2270cf,'payment':{'id':_0x14e29e['id'],'order_id':_0x14e29e[_0x40ed9e(0x1b5)],'gateway_order_id':_0x14e29e[_0x40ed9e(0x1dc)],'gateway':_0x40ed9e(0x1f4),'amount':_0x14e29e[_0x40ed9e(0x1e2)],'currency':_0x14e29e[_0x40ed9e(0x1a4)],'status':_0x4a86a6[_0x40ed9e(0x20e)](),'customer_email':_0x14e29e['customerEmail'],'customer_name':_0x14e29e[_0x40ed9e(0x1ed)],'transaction_id':_0x55c798,'failure_message':_0x1b3582,'created_at':_0x14e29e[_0x40ed9e(0x1b4)],'updated_at':new Date()}},_0x7b1ff3=await fetch(_0x54da9c[_0x40ed9e(0x1cf)],{'method':_0x40ed9e(0x1fa),'headers':{'Content-Type':_0x40ed9e(0x1be),'User-Agent':_0x40ed9e(0x1e9)},'body':JSON[_0x40ed9e(0x1a2)](_0x325dbf)}),_0x202fcb=Date[_0x40ed9e(0x1c6)]()-_0x47c2aa;console[_0x40ed9e(0x1e5)](_0x40ed9e(0x1cc)+_0x54da9c['webhookUrl']+_0x40ed9e(0x201)+_0x7b1ff3['status']+'\x20('+_0x202fcb+_0x40ed9e(0x1f1));}catch(_0x2de409){console[_0x40ed9e(0x1a5)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x2de409);}}async[a19_0x52df8a(0x1f3)](_0x476c06,_0x189fb4){const _0x25e95a=a19_0x52df8a;try{const {telegramBotService:_0x3c772a}=await Promise['resolve']()[_0x25e95a(0x1ac)](()=>__importStar(require(_0x25e95a(0x1ab)))),_0x3f7c50={'PAID':'paid','FAILED':'failed'},_0x432b1b=_0x3f7c50[_0x189fb4];if(!_0x432b1b)return;await _0x3c772a['sendPaymentNotification'](_0x476c06['shopId'],_0x476c06,_0x432b1b);}catch(_0x44c4b8){console[_0x25e95a(0x1a5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x44c4b8);}}}function a19_0x2b96(_0x423adb,_0x430d24){_0x423adb=_0x423adb-0x19c;const _0x2346f5=a19_0x2346();let _0x2b9643=_0x2346f5[_0x423adb];return _0x2b9643;}exports[a19_0x52df8a(0x1ae)]=TestGatewayController;