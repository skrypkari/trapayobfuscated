'use strict';const a13_0x211003=a13_0x4c4b;(function(_0x5d6264,_0x48f2e6){const _0x22e120=a13_0x4c4b,_0x1fbb5b=_0x5d6264();while(!![]){try{const _0x513172=-parseInt(_0x22e120(0x151))/0x1*(parseInt(_0x22e120(0x13c))/0x2)+-parseInt(_0x22e120(0x187))/0x3*(-parseInt(_0x22e120(0x133))/0x4)+-parseInt(_0x22e120(0x11e))/0x5*(-parseInt(_0x22e120(0x152))/0x6)+parseInt(_0x22e120(0x15c))/0x7+-parseInt(_0x22e120(0x185))/0x8*(parseInt(_0x22e120(0x190))/0x9)+-parseInt(_0x22e120(0x129))/0xa*(-parseInt(_0x22e120(0x141))/0xb)+-parseInt(_0x22e120(0x170))/0xc;if(_0x513172===_0x48f2e6)break;else _0x1fbb5b['push'](_0x1fbb5b['shift']());}catch(_0x4ab449){_0x1fbb5b['push'](_0x1fbb5b['shift']());}}}(a13_0x3f26,0xbf612));var __createBinding=this&&this[a13_0x211003(0x137)]||(Object[a13_0x211003(0x144)]?function(_0x1fa65c,_0x4a1b74,_0x2f425a,_0x3c8e14){const _0x2f149d=a13_0x211003;if(_0x3c8e14===undefined)_0x3c8e14=_0x2f425a;var _0x2e461c=Object['getOwnPropertyDescriptor'](_0x4a1b74,_0x2f425a);(!_0x2e461c||('get'in _0x2e461c?!_0x4a1b74[_0x2f149d(0x121)]:_0x2e461c['writable']||_0x2e461c[_0x2f149d(0x142)]))&&(_0x2e461c={'enumerable':!![],'get':function(){return _0x4a1b74[_0x2f425a];}}),Object[_0x2f149d(0x163)](_0x1fa65c,_0x3c8e14,_0x2e461c);}:function(_0x1067bd,_0xf20c0a,_0x395f8,_0x445172){if(_0x445172===undefined)_0x445172=_0x395f8;_0x1067bd[_0x445172]=_0xf20c0a[_0x395f8];}),__setModuleDefault=this&&this[a13_0x211003(0x178)]||(Object['create']?function(_0x25d4fb,_0x486cc8){const _0x1a1658=a13_0x211003;Object[_0x1a1658(0x163)](_0x25d4fb,_0x1a1658(0x18d),{'enumerable':!![],'value':_0x486cc8});}:function(_0x5f064d,_0x44832e){const _0x584754=a13_0x211003;_0x5f064d[_0x584754(0x18d)]=_0x44832e;}),__importStar=this&&this[a13_0x211003(0x15b)]||(function(){var _0x149b28=function(_0x206d84){return _0x149b28=Object['getOwnPropertyNames']||function(_0x4c583f){const _0x2a6ab0=a13_0x4c4b;var _0x39d52c=[];for(var _0x39ebd2 in _0x4c583f)if(Object['prototype']['hasOwnProperty'][_0x2a6ab0(0x120)](_0x4c583f,_0x39ebd2))_0x39d52c[_0x39d52c[_0x2a6ab0(0x172)]]=_0x39ebd2;return _0x39d52c;},_0x149b28(_0x206d84);};return function(_0x18dc3f){const _0x20dd6c=a13_0x4c4b;if(_0x18dc3f&&_0x18dc3f[_0x20dd6c(0x121)])return _0x18dc3f;var _0x2e18d7={};if(_0x18dc3f!=null){for(var _0x3e0cd3=_0x149b28(_0x18dc3f),_0x144547=0x0;_0x144547<_0x3e0cd3[_0x20dd6c(0x172)];_0x144547++)if(_0x3e0cd3[_0x144547]!=='default')__createBinding(_0x2e18d7,_0x18dc3f,_0x3e0cd3[_0x144547]);}return __setModuleDefault(_0x2e18d7,_0x18dc3f),_0x2e18d7;};}()),__importDefault=this&&this['__importDefault']||function(_0x300b7e){const _0x46c946=a13_0x211003;return _0x300b7e&&_0x300b7e[_0x46c946(0x121)]?_0x300b7e:{'default':_0x300b7e};};function a13_0x3f26(){const _0x5467cd=['__setModuleDefault','shopId','\x20not\x20enabled\x20for\x20shop\x20','\x20->\x20','transactionId','currentPayments','settings','Error\x20parsing\x20webhook\x20events:','successUrl','Payment\x20not\x20found','\x20processed:\x20','gateway','sendPaymentNotification','975552ePlvoT','📈\x20Found\x20payment\x20link\x20','5709wYOeZJ','COMPLETED','Payment\x20is\x20not\x20for\x20test\x20gateway','TestGatewayService','body','paymentLink','default','$transaction','Payment\x20status\x20is\x20','90fEeKjI','ms)','3200545dgPazj','webhookService','call','__esModule','test_gateway','now',',\x20cannot\x20process','webhookEvents','processCardPayment','../services/telegramBotService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','10ydfmEj','gatewayPaymentId',':\x20type=','PAID','amount','Any\x20other\x20card\x20number','currency',',\x20currentPayments=','TestGatewayController','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','2344urbhvk','sendShopWebhook','params','webhookUrl','__createBinding','Any\x20name','gatewayOrderId','PENDING','then','826400NerlQS','../services/gateways/testGatewayService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','sendPaymentStatusNotification','failed','11761717dOwwUV','configurable','0000','create','test_gateway_','replace','toLowerCase','Payment\x20to\x20','toISOString','📈\x20Test\x20Gateway:\x20Payment\x20','update','testGatewayService','application/json','log','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.success','1KrcJYF','6oSfrnn','resolve','WebhookService','stringify','parse','❌\x20Payment\x20link\x20','payment.failed','failureReason','findUnique','__importStar','5308191tuufmQ','🧪\x20Test\x20Gateway\x20result:',',\x20status=','processCard','\x20updated:\x20currentPayments=','test_card','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','defineProperty','shop','paymentLinkId','Payment\x20processed\x20successfully','SINGLE','Test\x20Gateway\x20webhook\x20sent\x20to\x20','FAILED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','json','✅\x20Payment\x20link\x20','Any\x203-4\x20digits','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','error','13995564MzmBSh','customerName','length','../services/webhookService','orderId','cardLast4','status','payment'];a13_0x3f26=function(){return _0x5467cd;};return a13_0x3f26();}Object[a13_0x211003(0x163)](exports,a13_0x211003(0x121),{'value':!![]}),exports[a13_0x211003(0x131)]=void 0x0;const testGatewayService_1=require(a13_0x211003(0x13d)),webhookService_1=require(a13_0x211003(0x173)),database_1=__importDefault(require('../config/database'));function a13_0x4c4b(_0x2fdd69,_0x538038){const _0x3f2632=a13_0x3f26();return a13_0x4c4b=function(_0x4c4bf0,_0x380a6d){_0x4c4bf0=_0x4c4bf0-0x11e;let _0x5b5d77=_0x3f2632[_0x4c4bf0];return _0x5b5d77;},a13_0x4c4b(_0x2fdd69,_0x538038);}class TestGatewayController{constructor(){const _0x323751=a13_0x211003;this['getPaymentForm']=async(_0x431479,_0x15581e,_0x462acd)=>{const _0xc95231=a13_0x4c4b;try{const {paymentId:_0x11d573}=_0x431479[_0xc95231(0x135)];console[_0xc95231(0x14e)](_0xc95231(0x132)+_0x11d573);const _0x2f8a52=await database_1[_0xc95231(0x18d)][_0xc95231(0x177)][_0xc95231(0x15a)]({'where':{'id':_0x11d573},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2f8a52)return _0x15581e[_0xc95231(0x176)](0x194)[_0xc95231(0x16b)]({'success':![],'message':_0xc95231(0x181)});if(_0x2f8a52[_0xc95231(0x183)]!==_0xc95231(0x122))return _0x15581e[_0xc95231(0x176)](0x190)[_0xc95231(0x16b)]({'success':![],'message':_0xc95231(0x189)});if(_0x2f8a52[_0xc95231(0x176)]!==_0xc95231(0x13a))return _0x15581e['status'](0x190)['json']({'success':![],'message':_0xc95231(0x18f)+_0x2f8a52[_0xc95231(0x176)]+_0xc95231(0x124)});_0x15581e[_0xc95231(0x16b)]({'success':!![],'result':{'paymentId':_0x2f8a52['id'],'orderId':_0x2f8a52[_0xc95231(0x139)],'amount':_0x2f8a52[_0xc95231(0x12d)],'currency':_0x2f8a52[_0xc95231(0x12f)],'merchantName':_0x2f8a52[_0xc95231(0x164)]['name'],'description':_0xc95231(0x148)+_0x2f8a52['shop']['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0xc95231(0x12e),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0xc95231(0x16d),'holderName':_0xc95231(0x138)}}});}catch(_0x19412a){_0x462acd(_0x19412a);}},this[_0x323751(0x15f)]=async(_0x45c4f0,_0x58d4c9,_0x575fa5)=>{const _0x4020f1=_0x323751;try{const {paymentId:_0x404b44}=_0x45c4f0['params'],_0x5147d5=_0x45c4f0[_0x4020f1(0x18b)];console[_0x4020f1(0x14e)](_0x4020f1(0x162)+_0x404b44);const _0x21c4d3=await database_1[_0x4020f1(0x18d)][_0x4020f1(0x177)][_0x4020f1(0x15a)]({'where':{'id':_0x404b44},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x21c4d3)return _0x58d4c9['status'](0x194)[_0x4020f1(0x16b)]({'success':![],'message':_0x4020f1(0x181)});if(_0x21c4d3[_0x4020f1(0x183)]!==_0x4020f1(0x122))return _0x58d4c9[_0x4020f1(0x176)](0x190)[_0x4020f1(0x16b)]({'success':![],'message':_0x4020f1(0x189)});if(_0x21c4d3[_0x4020f1(0x176)]!=='PENDING')return _0x58d4c9[_0x4020f1(0x176)](0x190)[_0x4020f1(0x16b)]({'success':![],'message':_0x4020f1(0x18f)+_0x21c4d3[_0x4020f1(0x176)]+_0x4020f1(0x124)});const _0x20134a=await this[_0x4020f1(0x14c)][_0x4020f1(0x126)]({'paymentId':_0x21c4d3['id'],'orderId':_0x21c4d3[_0x4020f1(0x139)]||_0x21c4d3['id'],'amount':_0x21c4d3[_0x4020f1(0x12d)],'currency':_0x21c4d3['currency'],'cardData':_0x5147d5});console[_0x4020f1(0x14e)](_0x4020f1(0x15d),_0x20134a);const _0x21317a={'status':_0x20134a[_0x4020f1(0x176)],'updatedAt':new Date()};if(_0x20134a[_0x4020f1(0x176)]===_0x4020f1(0x12c))_0x21317a['paidAt']=new Date(),_0x21317a[_0x4020f1(0x12a)]=_0x20134a[_0x4020f1(0x17c)];else _0x20134a['status']===_0x4020f1(0x169)&&(_0x21317a['failureMessage']=_0x20134a[_0x4020f1(0x159)]);const _0x865b90=_0x5147d5['cardNumber'][_0x4020f1(0x146)](/[\s-]/g,'');_0x21317a[_0x4020f1(0x175)]=_0x865b90['slice'](-0x4),_0x21317a['paymentMethod']=_0x4020f1(0x161),await database_1[_0x4020f1(0x18d)][_0x4020f1(0x177)][_0x4020f1(0x14b)]({'where':{'id':_0x21c4d3['id']},'data':_0x21317a});if(_0x20134a[_0x4020f1(0x176)]===_0x4020f1(0x12c)&&_0x21c4d3[_0x4020f1(0x165)]){console[_0x4020f1(0x14e)](_0x4020f1(0x14a)+_0x21c4d3['id']+_0x4020f1(0x13e));try{await database_1[_0x4020f1(0x18d)][_0x4020f1(0x18e)](async _0x431f36=>{const _0x2aeaf6=_0x4020f1,_0x3536c3=await _0x431f36[_0x2aeaf6(0x18c)]['findUnique']({'where':{'id':_0x21c4d3['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3536c3){console[_0x2aeaf6(0x14e)](_0x2aeaf6(0x186)+_0x3536c3['id']+_0x2aeaf6(0x12b)+_0x3536c3['type']+_0x2aeaf6(0x130)+_0x3536c3[_0x2aeaf6(0x17d)]+',\x20status='+_0x3536c3[_0x2aeaf6(0x176)]);const _0x24b72c=_0x3536c3[_0x2aeaf6(0x17d)]+0x1,_0x2f21ac=_0x3536c3['type']===_0x2aeaf6(0x167)?_0x2aeaf6(0x188):_0x3536c3[_0x2aeaf6(0x176)];await _0x431f36[_0x2aeaf6(0x18c)][_0x2aeaf6(0x14b)]({'where':{'id':_0x21c4d3[_0x2aeaf6(0x165)]},'data':{'currentPayments':_0x24b72c,'status':_0x2f21ac,'updatedAt':new Date()}}),console['log'](_0x2aeaf6(0x16c)+_0x3536c3['id']+_0x2aeaf6(0x160)+_0x3536c3['currentPayments']+_0x2aeaf6(0x17b)+_0x24b72c+_0x2aeaf6(0x15e)+_0x3536c3['status']+_0x2aeaf6(0x17b)+_0x2f21ac);}else console[_0x2aeaf6(0x14e)](_0x2aeaf6(0x157)+_0x21c4d3[_0x2aeaf6(0x165)]+'\x20not\x20found');});}catch(_0x3507d7){console['error']('❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x3507d7);}}await database_1['default']['webhookLog'][_0x4020f1(0x144)]({'data':{'paymentId':_0x21c4d3['id'],'shopId':_0x21c4d3[_0x4020f1(0x179)],'event':_0x4020f1(0x145)+_0x20134a[_0x4020f1(0x176)][_0x4020f1(0x147)](),'statusCode':0xc8,'responseBody':JSON[_0x4020f1(0x155)]({'oldStatus':_0x4020f1(0x13a),'newStatus':_0x20134a[_0x4020f1(0x176)],'transactionId':_0x20134a[_0x4020f1(0x17c)],'failureReason':_0x20134a[_0x4020f1(0x159)],'processedAt':new Date()[_0x4020f1(0x149)]()})}}),await this[_0x4020f1(0x134)](_0x21c4d3,_0x20134a['status'],_0x20134a[_0x4020f1(0x17c)],_0x20134a[_0x4020f1(0x159)]),await this[_0x4020f1(0x13f)](_0x21c4d3,_0x20134a['status']),console[_0x4020f1(0x14e)]('✅\x20Test\x20Gateway\x20payment\x20'+_0x404b44+_0x4020f1(0x182)+_0x20134a[_0x4020f1(0x176)]),_0x20134a[_0x4020f1(0x176)]===_0x4020f1(0x12c)?_0x58d4c9['json']({'success':!![],'message':_0x4020f1(0x166),'result':{'status':'PAID','transactionId':_0x20134a[_0x4020f1(0x17c)],'redirectUrl':_0x21c4d3[_0x4020f1(0x180)]}}):_0x58d4c9['status'](0x190)[_0x4020f1(0x16b)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x4020f1(0x169),'failureReason':_0x20134a['failureReason'],'redirectUrl':_0x21c4d3['failUrl']}});}catch(_0x33462b){_0x575fa5(_0x33462b);}},this['testGatewayService']=new testGatewayService_1[(_0x323751(0x18a))](),this[_0x323751(0x11f)]=new webhookService_1[(_0x323751(0x154))]();}async[a13_0x211003(0x134)](_0x23d806,_0x29ff90,_0x164b0a,_0x24294b){const _0x70bf08=a13_0x211003,_0x40c468=Date['now']();try{const _0x3c19d7=_0x23d806[_0x70bf08(0x164)],_0x1c560f=_0x3c19d7[_0x70bf08(0x17e)];if(!_0x1c560f?.[_0x70bf08(0x136)]){console[_0x70bf08(0x14e)](_0x70bf08(0x16a)+_0x3c19d7['id']);return;}const _0x5004a0=_0x29ff90===_0x70bf08(0x12c)?_0x70bf08(0x150):_0x70bf08(0x158);let _0x5a6b36=[];if(_0x1c560f[_0x70bf08(0x125)])try{_0x5a6b36=Array['isArray'](_0x1c560f['webhookEvents'])?_0x1c560f[_0x70bf08(0x125)]:JSON[_0x70bf08(0x156)](_0x1c560f[_0x70bf08(0x125)]);}catch(_0x1b2157){console['error'](_0x70bf08(0x17f),_0x1b2157),_0x5a6b36=[];}if(!_0x5a6b36['includes'](_0x5004a0)){console[_0x70bf08(0x14e)]('Webhook\x20event\x20'+_0x5004a0+_0x70bf08(0x17a)+_0x3c19d7['id']);return;}const _0xfc5485={'event':_0x5004a0,'payment':{'id':_0x23d806['id'],'order_id':_0x23d806[_0x70bf08(0x174)],'gateway_order_id':_0x23d806[_0x70bf08(0x139)],'gateway':_0x70bf08(0x143),'amount':_0x23d806['amount'],'currency':_0x23d806[_0x70bf08(0x12f)],'status':_0x29ff90[_0x70bf08(0x147)](),'customer_email':_0x23d806['customerEmail'],'customer_name':_0x23d806[_0x70bf08(0x171)],'transaction_id':_0x164b0a,'failure_message':_0x24294b,'created_at':_0x23d806['createdAt'],'updated_at':new Date()}},_0x3d6297=await fetch(_0x1c560f[_0x70bf08(0x136)],{'method':'POST','headers':{'Content-Type':_0x70bf08(0x14d),'User-Agent':_0x70bf08(0x16e)},'body':JSON[_0x70bf08(0x155)](_0xfc5485)}),_0x5cc70b=Date[_0x70bf08(0x123)]()-_0x40c468;console['log'](_0x70bf08(0x168)+_0x1c560f['webhookUrl']+'\x20with\x20status\x20'+_0x3d6297['status']+'\x20('+_0x5cc70b+_0x70bf08(0x191));}catch(_0x291084){console[_0x70bf08(0x16f)](_0x70bf08(0x128),_0x291084);}}async['sendPaymentStatusNotification'](_0x22f0f5,_0x5b5961){const _0x1c510d=a13_0x211003;try{const {telegramBotService:_0x1fda32}=await Promise[_0x1c510d(0x153)]()[_0x1c510d(0x13b)](()=>__importStar(require(_0x1c510d(0x127)))),_0x2f7a23={'PAID':'paid','FAILED':_0x1c510d(0x140)},_0x45cbb6=_0x2f7a23[_0x5b5961];if(!_0x45cbb6)return;await _0x1fda32[_0x1c510d(0x184)](_0x22f0f5[_0x1c510d(0x179)],_0x22f0f5,_0x45cbb6);}catch(_0x26ccc1){console[_0x1c510d(0x16f)](_0x1c510d(0x14f),_0x26ccc1);}}}exports['TestGatewayController']=TestGatewayController;