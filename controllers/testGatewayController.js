'use strict';const a13_0x530709=a13_0x3b73;(function(_0x1ca918,_0x1646e2){const _0x1786b3=a13_0x3b73,_0x421fd4=_0x1ca918();while(!![]){try{const _0x17c081=parseInt(_0x1786b3(0xea))/0x1*(-parseInt(_0x1786b3(0x125))/0x2)+-parseInt(_0x1786b3(0xe5))/0x3*(parseInt(_0x1786b3(0x108))/0x4)+-parseInt(_0x1786b3(0x13f))/0x5+-parseInt(_0x1786b3(0x120))/0x6+-parseInt(_0x1786b3(0xfd))/0x7*(parseInt(_0x1786b3(0x126))/0x8)+parseInt(_0x1786b3(0x11c))/0x9+parseInt(_0x1786b3(0x11e))/0xa;if(_0x17c081===_0x1646e2)break;else _0x421fd4['push'](_0x421fd4['shift']());}catch(_0x3d3c6f){_0x421fd4['push'](_0x421fd4['shift']());}}}(a13_0x1369,0x73d95));var __createBinding=this&&this['__createBinding']||(Object[a13_0x530709(0x129)]?function(_0x3fd3d1,_0x13c0e7,_0x4d62fc,_0x2b50d5){const _0xfda109=a13_0x530709;if(_0x2b50d5===undefined)_0x2b50d5=_0x4d62fc;var _0x48075b=Object[_0xfda109(0x110)](_0x13c0e7,_0x4d62fc);(!_0x48075b||(_0xfda109(0xe4)in _0x48075b?!_0x13c0e7['__esModule']:_0x48075b[_0xfda109(0x11f)]||_0x48075b[_0xfda109(0x137)]))&&(_0x48075b={'enumerable':!![],'get':function(){return _0x13c0e7[_0x4d62fc];}}),Object[_0xfda109(0x139)](_0x3fd3d1,_0x2b50d5,_0x48075b);}:function(_0x5e09e3,_0x13eabf,_0x115a82,_0x4d5904){if(_0x4d5904===undefined)_0x4d5904=_0x115a82;_0x5e09e3[_0x4d5904]=_0x13eabf[_0x115a82];}),__setModuleDefault=this&&this[a13_0x530709(0xec)]||(Object[a13_0x530709(0x129)]?function(_0xe038b3,_0x58e8bd){const _0x2229ed=a13_0x530709;Object[_0x2229ed(0x139)](_0xe038b3,'default',{'enumerable':!![],'value':_0x58e8bd});}:function(_0x316e9e,_0x24228d){const _0x1d680f=a13_0x530709;_0x316e9e[_0x1d680f(0xeb)]=_0x24228d;}),__importStar=this&&this['__importStar']||(function(){var _0x1a243d=function(_0x2bd580){return _0x1a243d=Object['getOwnPropertyNames']||function(_0x3e0cb0){const _0x1f636a=a13_0x3b73;var _0x5dcda4=[];for(var _0x257b74 in _0x3e0cb0)if(Object[_0x1f636a(0xef)][_0x1f636a(0x107)][_0x1f636a(0xf6)](_0x3e0cb0,_0x257b74))_0x5dcda4[_0x5dcda4[_0x1f636a(0x13c)]]=_0x257b74;return _0x5dcda4;},_0x1a243d(_0x2bd580);};return function(_0x3389af){const _0x441d08=a13_0x3b73;if(_0x3389af&&_0x3389af[_0x441d08(0x119)])return _0x3389af;var _0xa35242={};if(_0x3389af!=null){for(var _0x56c35b=_0x1a243d(_0x3389af),_0x4dd79d=0x0;_0x4dd79d<_0x56c35b[_0x441d08(0x13c)];_0x4dd79d++)if(_0x56c35b[_0x4dd79d]!==_0x441d08(0xeb))__createBinding(_0xa35242,_0x3389af,_0x56c35b[_0x4dd79d]);}return __setModuleDefault(_0xa35242,_0x3389af),_0xa35242;};}()),__importDefault=this&&this['__importDefault']||function(_0x44ac32){return _0x44ac32&&_0x44ac32['__esModule']?_0x44ac32:{'default':_0x44ac32};};Object[a13_0x530709(0x139)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x530709(0x12c)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x530709(0x10e)));function a13_0x3b73(_0x3bc6eb,_0x33f650){const _0x13694b=a13_0x1369();return a13_0x3b73=function(_0x3b73a0,_0x8e5c2){_0x3b73a0=_0x3b73a0-0xde;let _0x4c5db4=_0x13694b[_0x3b73a0];return _0x4c5db4;},a13_0x3b73(_0x3bc6eb,_0x33f650);}function a13_0x1369(){const _0x5a39be=['139909jOCEvA','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','amount','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookEvents','orderId','now','testGatewayService','sendPaymentNotification','payment.failed','hasOwnProperty','4CBsVxb','toLowerCase','json','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','sendPaymentStatusNotification','../config/database','Test\x20Gateway\x20webhook\x20sent\x20to\x20','getOwnPropertyDescriptor',',\x20cannot\x20process','Any\x20name','parse','cardLast4','test_gateway','replace','TestGatewayController','Payment\x20not\x20found','__esModule','successUrl','PAID','8393877ngPvvh','paid','20572680chozSh','writable','838590NwlDzh','params','shop','toISOString','failed','2nochWG','296meNWTl','gateway','test_card','create','Any\x20future\x20date\x20(MM/YY)','Payment\x20status\x20is\x20','../services/gateways/testGatewayService','status','failUrl','payment','shopId','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','customerEmail','resolve','gatewayPaymentId','POST','findUnique','configurable','0000','defineProperty','Webhook\x20event\x20','log','length','ðŸ§ª\x20Test\x20Gateway\x20result:','FAILED','4524765MzYkgN','stringify','then','failureReason','payment.success','test_gateway_','WebhookService','Any\x20other\x20card\x20number','sendShopWebhook','includes','name','get','1808328mBXkVq','transactionId','processCardPayment','Error\x20parsing\x20webhook\x20events:','error','128391VAtTDD','default','__setModuleDefault','currency','gatewayOrderId','prototype','TestGatewayService','createdAt','\x20not\x20enabled\x20for\x20shop\x20','customerName','paymentMethod','getPaymentForm','call','PENDING','processCard','body','cardNumber','update','Payment\x20is\x20not\x20for\x20test\x20gateway'];a13_0x1369=function(){return _0x5a39be;};return a13_0x1369();}class TestGatewayController{constructor(){const _0x4e5bba=a13_0x530709;this[_0x4e5bba(0xf5)]=async(_0x1b24c1,_0x2ea642,_0x4e89c5)=>{const _0x50a5c1=_0x4e5bba;try{const {paymentId:_0x25f17e}=_0x1b24c1['params'];console['log'](_0x50a5c1(0x131)+_0x25f17e);const _0x496d33=await database_1[_0x50a5c1(0xeb)][_0x50a5c1(0x12f)][_0x50a5c1(0x136)]({'where':{'id':_0x25f17e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x496d33)return _0x2ea642[_0x50a5c1(0x12d)](0x194)[_0x50a5c1(0x10a)]({'success':![],'message':_0x50a5c1(0x118)});if(_0x496d33[_0x50a5c1(0x127)]!=='test_gateway')return _0x2ea642['status'](0x190)[_0x50a5c1(0x10a)]({'success':![],'message':_0x50a5c1(0xfc)});if(_0x496d33[_0x50a5c1(0x12d)]!==_0x50a5c1(0xf7))return _0x2ea642[_0x50a5c1(0x12d)](0x190)[_0x50a5c1(0x10a)]({'success':![],'message':_0x50a5c1(0x12b)+_0x496d33[_0x50a5c1(0x12d)]+_0x50a5c1(0x111)});_0x2ea642[_0x50a5c1(0x10a)]({'success':!![],'result':{'paymentId':_0x496d33['id'],'orderId':_0x496d33[_0x50a5c1(0xee)],'amount':_0x496d33[_0x50a5c1(0xff)],'currency':_0x496d33[_0x50a5c1(0xed)],'merchantName':_0x496d33[_0x50a5c1(0x122)][_0x50a5c1(0xe3)],'description':'Payment\x20to\x20'+_0x496d33[_0x50a5c1(0x122)][_0x50a5c1(0xe3)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x50a5c1(0xe0),'expiryDate':_0x50a5c1(0x12a),'cvc':'Any\x203-4\x20digits','holderName':_0x50a5c1(0x112)}}});}catch(_0x231e95){_0x4e89c5(_0x231e95);}},this[_0x4e5bba(0xf8)]=async(_0x417327,_0x39cb41,_0x3f8dc4)=>{const _0x53410c=_0x4e5bba;try{const {paymentId:_0x3b870d}=_0x417327[_0x53410c(0x121)],_0x3fed18=_0x417327[_0x53410c(0xf9)];console[_0x53410c(0x13b)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3b870d);const _0x65a040=await database_1['default'][_0x53410c(0x12f)][_0x53410c(0x136)]({'where':{'id':_0x3b870d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x65a040)return _0x39cb41[_0x53410c(0x12d)](0x194)[_0x53410c(0x10a)]({'success':![],'message':_0x53410c(0x118)});if(_0x65a040[_0x53410c(0x127)]!==_0x53410c(0x115))return _0x39cb41['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x65a040[_0x53410c(0x12d)]!=='PENDING')return _0x39cb41['status'](0x190)[_0x53410c(0x10a)]({'success':![],'message':_0x53410c(0x12b)+_0x65a040[_0x53410c(0x12d)]+',\x20cannot\x20process'});const _0x1495bb=await this[_0x53410c(0x104)][_0x53410c(0xe7)]({'paymentId':_0x65a040['id'],'orderId':_0x65a040['gatewayOrderId']||_0x65a040['id'],'amount':_0x65a040[_0x53410c(0xff)],'currency':_0x65a040['currency'],'cardData':_0x3fed18});console[_0x53410c(0x13b)](_0x53410c(0x13d),_0x1495bb);const _0x40c543={'status':_0x1495bb[_0x53410c(0x12d)],'updatedAt':new Date()};if(_0x1495bb[_0x53410c(0x12d)]===_0x53410c(0x11b))_0x40c543['paidAt']=new Date(),_0x40c543[_0x53410c(0x134)]=_0x1495bb['transactionId'];else _0x1495bb[_0x53410c(0x12d)]===_0x53410c(0x13e)&&(_0x40c543['failureMessage']=_0x1495bb[_0x53410c(0x142)]);const _0xde74f2=_0x3fed18[_0x53410c(0xfa)][_0x53410c(0x116)](/[\s-]/g,'');_0x40c543[_0x53410c(0x114)]=_0xde74f2['slice'](-0x4),_0x40c543[_0x53410c(0xf4)]=_0x53410c(0x128),await database_1[_0x53410c(0xeb)]['payment'][_0x53410c(0xfb)]({'where':{'id':_0x65a040['id']},'data':_0x40c543}),await database_1['default']['webhookLog'][_0x53410c(0x129)]({'data':{'paymentId':_0x65a040['id'],'shopId':_0x65a040[_0x53410c(0x130)],'event':_0x53410c(0xde)+_0x1495bb[_0x53410c(0x12d)][_0x53410c(0x109)](),'statusCode':0xc8,'responseBody':JSON[_0x53410c(0x140)]({'oldStatus':_0x53410c(0xf7),'newStatus':_0x1495bb['status'],'transactionId':_0x1495bb[_0x53410c(0xe6)],'failureReason':_0x1495bb[_0x53410c(0x142)],'processedAt':new Date()[_0x53410c(0x123)]()})}}),await this['sendShopWebhook'](_0x65a040,_0x1495bb['status'],_0x1495bb[_0x53410c(0xe6)],_0x1495bb[_0x53410c(0x142)]),await this[_0x53410c(0x10d)](_0x65a040,_0x1495bb[_0x53410c(0x12d)]),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x3b870d+'\x20processed:\x20'+_0x1495bb[_0x53410c(0x12d)]),_0x1495bb[_0x53410c(0x12d)]===_0x53410c(0x11b)?_0x39cb41[_0x53410c(0x10a)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x53410c(0x11b),'transactionId':_0x1495bb['transactionId'],'redirectUrl':_0x65a040[_0x53410c(0x11a)]}}):_0x39cb41[_0x53410c(0x12d)](0x190)[_0x53410c(0x10a)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x1495bb[_0x53410c(0x142)],'redirectUrl':_0x65a040[_0x53410c(0x12e)]}});}catch(_0x3b2514){_0x3f8dc4(_0x3b2514);}},this[_0x4e5bba(0x104)]=new testGatewayService_1[(_0x4e5bba(0xf0))](),this['webhookService']=new webhookService_1[(_0x4e5bba(0xdf))]();}async[a13_0x530709(0xe1)](_0x40369f,_0x46c578,_0x216f37,_0x2d8865){const _0x13d154=a13_0x530709,_0x8f7314=Date[_0x13d154(0x103)]();try{const _0x148e2a=_0x40369f['shop'],_0x14b02e=_0x148e2a['settings'];if(!_0x14b02e?.['webhookUrl']){console['log'](_0x13d154(0x100)+_0x148e2a['id']);return;}const _0x303f9e=_0x46c578===_0x13d154(0x11b)?_0x13d154(0x143):_0x13d154(0x106);let _0x1ec440=[];if(_0x14b02e[_0x13d154(0x101)])try{_0x1ec440=Array['isArray'](_0x14b02e[_0x13d154(0x101)])?_0x14b02e[_0x13d154(0x101)]:JSON[_0x13d154(0x113)](_0x14b02e[_0x13d154(0x101)]);}catch(_0x26e9f2){console[_0x13d154(0xe9)](_0x13d154(0xe8),_0x26e9f2),_0x1ec440=[];}if(!_0x1ec440[_0x13d154(0xe2)](_0x303f9e)){console[_0x13d154(0x13b)](_0x13d154(0x13a)+_0x303f9e+_0x13d154(0xf2)+_0x148e2a['id']);return;}const _0x40812a={'event':_0x303f9e,'payment':{'id':_0x40369f['id'],'order_id':_0x40369f[_0x13d154(0x102)],'gateway_order_id':_0x40369f[_0x13d154(0xee)],'gateway':_0x13d154(0x138),'amount':_0x40369f['amount'],'currency':_0x40369f[_0x13d154(0xed)],'status':_0x46c578['toLowerCase'](),'customer_email':_0x40369f[_0x13d154(0x132)],'customer_name':_0x40369f[_0x13d154(0xf3)],'transaction_id':_0x216f37,'failure_message':_0x2d8865,'created_at':_0x40369f[_0x13d154(0xf1)],'updated_at':new Date()}},_0x5b9f25=await fetch(_0x14b02e['webhookUrl'],{'method':_0x13d154(0x135),'headers':{'Content-Type':'application/json','User-Agent':_0x13d154(0xfe)},'body':JSON[_0x13d154(0x140)](_0x40812a)}),_0x4698f1=Date[_0x13d154(0x103)]()-_0x8f7314;console[_0x13d154(0x13b)](_0x13d154(0x10f)+_0x14b02e['webhookUrl']+'\x20with\x20status\x20'+_0x5b9f25[_0x13d154(0x12d)]+'\x20('+_0x4698f1+'ms)');}catch(_0x23678f){console[_0x13d154(0xe9)](_0x13d154(0x10c),_0x23678f);}}async[a13_0x530709(0x10d)](_0x1a9e92,_0x58dbe1){const _0x3afcac=a13_0x530709;try{const {telegramBotService:_0x32ff07}=await Promise[_0x3afcac(0x133)]()[_0x3afcac(0x141)](()=>__importStar(require('../services/telegramBotService'))),_0x48a714={'PAID':_0x3afcac(0x11d),'FAILED':_0x3afcac(0x124)},_0x7c9020=_0x48a714[_0x58dbe1];if(!_0x7c9020)return;await _0x32ff07[_0x3afcac(0x105)](_0x1a9e92[_0x3afcac(0x130)],_0x1a9e92,_0x7c9020);}catch(_0x5de0cd){console[_0x3afcac(0xe9)](_0x3afcac(0x10b),_0x5de0cd);}}}exports[a13_0x530709(0x117)]=TestGatewayController;