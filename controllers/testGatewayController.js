'use strict';const a13_0x3bf0c9=a13_0x4458;(function(_0x5bc33c,_0xcf9da7){const _0x4475f5=a13_0x4458,_0x22d98b=_0x5bc33c();while(!![]){try{const _0x50687a=parseInt(_0x4475f5(0xa9))/0x1*(-parseInt(_0x4475f5(0xa3))/0x2)+-parseInt(_0x4475f5(0x75))/0x3*(parseInt(_0x4475f5(0x9b))/0x4)+parseInt(_0x4475f5(0x8f))/0x5+parseInt(_0x4475f5(0xc6))/0x6*(parseInt(_0x4475f5(0xc3))/0x7)+-parseInt(_0x4475f5(0x9e))/0x8*(parseInt(_0x4475f5(0x73))/0x9)+parseInt(_0x4475f5(0xb2))/0xa+parseInt(_0x4475f5(0xb8))/0xb*(parseInt(_0x4475f5(0xce))/0xc);if(_0x50687a===_0xcf9da7)break;else _0x22d98b['push'](_0x22d98b['shift']());}catch(_0x1dcb18){_0x22d98b['push'](_0x22d98b['shift']());}}}(a13_0x6ed8,0x70f95));var __createBinding=this&&this[a13_0x3bf0c9(0x82)]||(Object[a13_0x3bf0c9(0xc0)]?function(_0x1f66f7,_0x9c8810,_0xf0622b,_0x3c0ca1){const _0x5c4924=a13_0x3bf0c9;if(_0x3c0ca1===undefined)_0x3c0ca1=_0xf0622b;var _0xee8e81=Object[_0x5c4924(0xc5)](_0x9c8810,_0xf0622b);(!_0xee8e81||('get'in _0xee8e81?!_0x9c8810[_0x5c4924(0xd1)]:_0xee8e81[_0x5c4924(0xa8)]||_0xee8e81['configurable']))&&(_0xee8e81={'enumerable':!![],'get':function(){return _0x9c8810[_0xf0622b];}}),Object[_0x5c4924(0x96)](_0x1f66f7,_0x3c0ca1,_0xee8e81);}:function(_0x1820d9,_0x3828b1,_0x36d5fb,_0x57232f){if(_0x57232f===undefined)_0x57232f=_0x36d5fb;_0x1820d9[_0x57232f]=_0x3828b1[_0x36d5fb];}),__setModuleDefault=this&&this[a13_0x3bf0c9(0x99)]||(Object[a13_0x3bf0c9(0xc0)]?function(_0x3a7a50,_0x48a100){const _0x432a5a=a13_0x3bf0c9;Object['defineProperty'](_0x3a7a50,_0x432a5a(0xac),{'enumerable':!![],'value':_0x48a100});}:function(_0x52f3a4,_0x3dce94){const _0x58d307=a13_0x3bf0c9;_0x52f3a4[_0x58d307(0xac)]=_0x3dce94;}),__importStar=this&&this[a13_0x3bf0c9(0xa2)]||(function(){var _0x5eb969=function(_0x31396b){const _0x56a93c=a13_0x4458;return _0x5eb969=Object[_0x56a93c(0xcf)]||function(_0x57cc57){const _0x3f1ec6=_0x56a93c;var _0x3b127c=[];for(var _0x42d2c7 in _0x57cc57)if(Object[_0x3f1ec6(0xae)]['hasOwnProperty'][_0x3f1ec6(0xcc)](_0x57cc57,_0x42d2c7))_0x3b127c[_0x3b127c[_0x3f1ec6(0xd6)]]=_0x42d2c7;return _0x3b127c;},_0x5eb969(_0x31396b);};return function(_0x51f381){const _0x2c2357=a13_0x4458;if(_0x51f381&&_0x51f381['__esModule'])return _0x51f381;var _0x5dabd5={};if(_0x51f381!=null){for(var _0x5fe04e=_0x5eb969(_0x51f381),_0x5c6083=0x0;_0x5c6083<_0x5fe04e['length'];_0x5c6083++)if(_0x5fe04e[_0x5c6083]!==_0x2c2357(0xac))__createBinding(_0x5dabd5,_0x51f381,_0x5fe04e[_0x5c6083]);}return __setModuleDefault(_0x5dabd5,_0x51f381),_0x5dabd5;};}()),__importDefault=this&&this[a13_0x3bf0c9(0x81)]||function(_0x112406){const _0x3a2627=a13_0x3bf0c9;return _0x112406&&_0x112406[_0x3a2627(0xd1)]?_0x112406:{'default':_0x112406};};function a13_0x6ed8(){const _0x537a0e=['gateway','error','paymentMethod','Any\x203-4\x20digits','Test\x20Gateway\x20webhook\x20sent\x20to\x20','gatewayPaymentId','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Error\x20parsing\x20webhook\x20events:','json','settings','__importDefault','__createBinding','Any\x20name','0000','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','Payment\x20processed\x20successfully','WebhookService','Payment\x20failed','transactionId','TestGatewayService','findUnique','webhookService','shopId','162245fnxbwW','name','../config/database','createdAt','âœ…\x20Test\x20Gateway\x20payment\x20','../services/telegramBotService','gatewayOrderId','defineProperty','4242\x204242\x204242\x204242','amount','__setModuleDefault','Payment\x20status\x20is\x20','4LfarCM','cardNumber','now','8MXtYPy','orderId','ðŸ§ª\x20Test\x20Gateway\x20result:','PAID','__importStar','4258RmMgsL','log','currency','successUrl','params','writable','146YgJlPx','failureMessage','POST','default','parse','prototype','TestGatewayController','\x20processed:\x20','\x20with\x20status\x20','4579350hzVEBO','../services/webhookService','processCard','cardLast4','failUrl',',\x20cannot\x20process','294426oNQpfU','body','payment.success','ms)','Payment\x20not\x20found','webhookLog','toLowerCase','payment','create','failureReason','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','308yTGRUS','sendShopWebhook','getOwnPropertyDescriptor','97062SRlPyc','slice','FAILED','sendPaymentStatusNotification','paid','toISOString','call','shop','204yjkgep','getOwnPropertyNames','failed','__esModule','Payment\x20to\x20','Webhook\x20event\x20','update','../services/gateways/testGatewayService','length','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','testGatewayService','webhookUrl','resolve','customerEmail','stringify','PENDING','webhookEvents','3106395EQkcbx','sendPaymentNotification','1615392Aorbib','status'];a13_0x6ed8=function(){return _0x537a0e;};return a13_0x6ed8();}Object[a13_0x3bf0c9(0x96)](exports,a13_0x3bf0c9(0xd1),{'value':!![]}),exports[a13_0x3bf0c9(0xaf)]=void 0x0;const testGatewayService_1=require(a13_0x3bf0c9(0xd5)),webhookService_1=require(a13_0x3bf0c9(0xb3)),database_1=__importDefault(require(a13_0x3bf0c9(0x91)));class TestGatewayController{constructor(){const _0x5a3e8f=a13_0x3bf0c9;this['getPaymentForm']=async(_0x8e0a1b,_0x59fddf,_0x270b77)=>{const _0x5ba0c4=a13_0x4458;try{const {paymentId:_0x3fa1f9}=_0x8e0a1b[_0x5ba0c4(0xa7)];console[_0x5ba0c4(0xa4)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3fa1f9);const _0x4f4043=await database_1['default'][_0x5ba0c4(0xbf)][_0x5ba0c4(0x8c)]({'where':{'id':_0x3fa1f9},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4f4043)return _0x59fddf[_0x5ba0c4(0x76)](0x194)[_0x5ba0c4(0x7f)]({'success':![],'message':_0x5ba0c4(0xbc)});if(_0x4f4043[_0x5ba0c4(0x77)]!=='test_gateway')return _0x59fddf[_0x5ba0c4(0x76)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x4f4043['status']!==_0x5ba0c4(0x71))return _0x59fddf[_0x5ba0c4(0x76)](0x190)['json']({'success':![],'message':_0x5ba0c4(0x9a)+_0x4f4043['status']+_0x5ba0c4(0xb7)});_0x59fddf['json']({'success':!![],'result':{'paymentId':_0x4f4043['id'],'orderId':_0x4f4043[_0x5ba0c4(0x95)],'amount':_0x4f4043['amount'],'currency':_0x4f4043[_0x5ba0c4(0xa5)],'merchantName':_0x4f4043[_0x5ba0c4(0xcd)][_0x5ba0c4(0x90)],'description':_0x5ba0c4(0xd2)+_0x4f4043['shop']['name'],'testInstructions':{'successCard':_0x5ba0c4(0x97),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x5ba0c4(0x7a),'holderName':_0x5ba0c4(0x83)}}});}catch(_0x221a6f){_0x270b77(_0x221a6f);}},this[_0x5a3e8f(0xb4)]=async(_0x1ef24a,_0x4ac3cc,_0x5dcf17)=>{const _0x5b85b6=_0x5a3e8f;try{const {paymentId:_0x406f50}=_0x1ef24a[_0x5b85b6(0xa7)],_0x97c6a8=_0x1ef24a[_0x5b85b6(0xb9)];console[_0x5b85b6(0xa4)](_0x5b85b6(0x7d)+_0x406f50);const _0x4a3d1e=await database_1[_0x5b85b6(0xac)][_0x5b85b6(0xbf)][_0x5b85b6(0x8c)]({'where':{'id':_0x406f50},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4a3d1e)return _0x4ac3cc['status'](0x194)[_0x5b85b6(0x7f)]({'success':![],'message':_0x5b85b6(0xbc)});if(_0x4a3d1e['gateway']!=='test_gateway')return _0x4ac3cc[_0x5b85b6(0x76)](0x190)[_0x5b85b6(0x7f)]({'success':![],'message':_0x5b85b6(0x86)});if(_0x4a3d1e[_0x5b85b6(0x76)]!==_0x5b85b6(0x71))return _0x4ac3cc[_0x5b85b6(0x76)](0x190)[_0x5b85b6(0x7f)]({'success':![],'message':_0x5b85b6(0x9a)+_0x4a3d1e[_0x5b85b6(0x76)]+_0x5b85b6(0xb7)});const _0x4baad2=await this[_0x5b85b6(0xd8)]['processCardPayment']({'paymentId':_0x4a3d1e['id'],'orderId':_0x4a3d1e[_0x5b85b6(0x95)]||_0x4a3d1e['id'],'amount':_0x4a3d1e[_0x5b85b6(0x98)],'currency':_0x4a3d1e[_0x5b85b6(0xa5)],'cardData':_0x97c6a8});console[_0x5b85b6(0xa4)](_0x5b85b6(0xa0),_0x4baad2);const _0x2eb547={'status':_0x4baad2[_0x5b85b6(0x76)],'updatedAt':new Date()};if(_0x4baad2['status']==='PAID')_0x2eb547['paidAt']=new Date(),_0x2eb547[_0x5b85b6(0x7c)]=_0x4baad2[_0x5b85b6(0x8a)];else _0x4baad2[_0x5b85b6(0x76)]===_0x5b85b6(0xc8)&&(_0x2eb547[_0x5b85b6(0xaa)]=_0x4baad2['failureReason']);const _0x262f4b=_0x97c6a8[_0x5b85b6(0x9c)]['replace'](/[\s-]/g,'');_0x2eb547[_0x5b85b6(0xb5)]=_0x262f4b[_0x5b85b6(0xc7)](-0x4),_0x2eb547[_0x5b85b6(0x79)]='test_card',await database_1['default'][_0x5b85b6(0xbf)][_0x5b85b6(0xd4)]({'where':{'id':_0x4a3d1e['id']},'data':_0x2eb547}),await database_1[_0x5b85b6(0xac)][_0x5b85b6(0xbd)]['create']({'data':{'paymentId':_0x4a3d1e['id'],'shopId':_0x4a3d1e[_0x5b85b6(0x8e)],'event':'test_gateway_'+_0x4baad2[_0x5b85b6(0x76)][_0x5b85b6(0xbe)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5b85b6(0x71),'newStatus':_0x4baad2[_0x5b85b6(0x76)],'transactionId':_0x4baad2[_0x5b85b6(0x8a)],'failureReason':_0x4baad2[_0x5b85b6(0xc1)],'processedAt':new Date()[_0x5b85b6(0xcb)]()})}}),await this[_0x5b85b6(0xc4)](_0x4a3d1e,_0x4baad2[_0x5b85b6(0x76)],_0x4baad2[_0x5b85b6(0x8a)],_0x4baad2[_0x5b85b6(0xc1)]),await this[_0x5b85b6(0xc9)](_0x4a3d1e,_0x4baad2[_0x5b85b6(0x76)]),console['log'](_0x5b85b6(0x93)+_0x406f50+_0x5b85b6(0xb0)+_0x4baad2[_0x5b85b6(0x76)]),_0x4baad2[_0x5b85b6(0x76)]==='PAID'?_0x4ac3cc['json']({'success':!![],'message':_0x5b85b6(0x87),'result':{'status':_0x5b85b6(0xa1),'transactionId':_0x4baad2['transactionId'],'redirectUrl':_0x4a3d1e[_0x5b85b6(0xa6)]}}):_0x4ac3cc[_0x5b85b6(0x76)](0x190)[_0x5b85b6(0x7f)]({'success':![],'message':_0x5b85b6(0x89),'result':{'status':_0x5b85b6(0xc8),'failureReason':_0x4baad2[_0x5b85b6(0xc1)],'redirectUrl':_0x4a3d1e[_0x5b85b6(0xb6)]}});}catch(_0xbab053){_0x5dcf17(_0xbab053);}},this[_0x5a3e8f(0xd8)]=new testGatewayService_1[(_0x5a3e8f(0x8b))](),this[_0x5a3e8f(0x8d)]=new webhookService_1[(_0x5a3e8f(0x88))]();}async[a13_0x3bf0c9(0xc4)](_0x4eac7a,_0x5b5575,_0x4b0171,_0x515ed7){const _0x3e8e0b=a13_0x3bf0c9,_0x48f7a9=Date[_0x3e8e0b(0x9d)]();try{const _0xdf67b=_0x4eac7a[_0x3e8e0b(0xcd)],_0x25d99b=_0xdf67b[_0x3e8e0b(0x80)];if(!_0x25d99b?.['webhookUrl']){console[_0x3e8e0b(0xa4)](_0x3e8e0b(0xd7)+_0xdf67b['id']);return;}const _0x177bc5=_0x5b5575==='PAID'?_0x3e8e0b(0xba):'payment.failed';let _0x48a98a=[];if(_0x25d99b['webhookEvents'])try{_0x48a98a=Array['isArray'](_0x25d99b[_0x3e8e0b(0x72)])?_0x25d99b[_0x3e8e0b(0x72)]:JSON[_0x3e8e0b(0xad)](_0x25d99b[_0x3e8e0b(0x72)]);}catch(_0x24f314){console['error'](_0x3e8e0b(0x7e),_0x24f314),_0x48a98a=[];}if(!_0x48a98a['includes'](_0x177bc5)){console[_0x3e8e0b(0xa4)](_0x3e8e0b(0xd3)+_0x177bc5+_0x3e8e0b(0x85)+_0xdf67b['id']);return;}const _0x19cf49={'event':_0x177bc5,'payment':{'id':_0x4eac7a['id'],'order_id':_0x4eac7a[_0x3e8e0b(0x9f)],'gateway_order_id':_0x4eac7a['gatewayOrderId'],'gateway':_0x3e8e0b(0x84),'amount':_0x4eac7a[_0x3e8e0b(0x98)],'currency':_0x4eac7a[_0x3e8e0b(0xa5)],'status':_0x5b5575[_0x3e8e0b(0xbe)](),'customer_email':_0x4eac7a[_0x3e8e0b(0x6f)],'customer_name':_0x4eac7a['customerName'],'transaction_id':_0x4b0171,'failure_message':_0x515ed7,'created_at':_0x4eac7a[_0x3e8e0b(0x92)],'updated_at':new Date()}},_0x385bd9=await fetch(_0x25d99b[_0x3e8e0b(0x6d)],{'method':_0x3e8e0b(0xab),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3e8e0b(0x70)](_0x19cf49)}),_0x527b89=Date[_0x3e8e0b(0x9d)]()-_0x48f7a9;console['log'](_0x3e8e0b(0x7b)+_0x25d99b[_0x3e8e0b(0x6d)]+_0x3e8e0b(0xb1)+_0x385bd9[_0x3e8e0b(0x76)]+'\x20('+_0x527b89+_0x3e8e0b(0xbb));}catch(_0x139dbe){console[_0x3e8e0b(0x78)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x139dbe);}}async['sendPaymentStatusNotification'](_0x238114,_0x46e9b8){const _0x16ef47=a13_0x3bf0c9;try{const {telegramBotService:_0x4c6084}=await Promise[_0x16ef47(0x6e)]()['then'](()=>__importStar(require(_0x16ef47(0x94)))),_0x4e831a={'PAID':_0x16ef47(0xca),'FAILED':_0x16ef47(0xd0)},_0x30bf98=_0x4e831a[_0x46e9b8];if(!_0x30bf98)return;await _0x4c6084[_0x16ef47(0x74)](_0x238114[_0x16ef47(0x8e)],_0x238114,_0x30bf98);}catch(_0x2ceb62){console['error'](_0x16ef47(0xc2),_0x2ceb62);}}}function a13_0x4458(_0x243e33,_0x2d22aa){const _0x6ed841=a13_0x6ed8();return a13_0x4458=function(_0x445816,_0x12414c){_0x445816=_0x445816-0x6d;let _0x4c130c=_0x6ed841[_0x445816];return _0x4c130c;},a13_0x4458(_0x243e33,_0x2d22aa);}exports[a13_0x3bf0c9(0xaf)]=TestGatewayController;