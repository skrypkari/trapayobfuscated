'use strict';const a13_0x5abff5=a13_0x523d;(function(_0x4ad741,_0xc510e5){const _0x11fa6e=a13_0x523d,_0x353b13=_0x4ad741();while(!![]){try{const _0x4576bb=-parseInt(_0x11fa6e(0xea))/0x1*(parseInt(_0x11fa6e(0x138))/0x2)+-parseInt(_0x11fa6e(0x100))/0x3*(-parseInt(_0x11fa6e(0x126))/0x4)+-parseInt(_0x11fa6e(0x115))/0x5+-parseInt(_0x11fa6e(0xed))/0x6*(parseInt(_0x11fa6e(0x13e))/0x7)+parseInt(_0x11fa6e(0x119))/0x8*(parseInt(_0x11fa6e(0x11f))/0x9)+parseInt(_0x11fa6e(0x13a))/0xa+parseInt(_0x11fa6e(0xee))/0xb;if(_0x4576bb===_0xc510e5)break;else _0x353b13['push'](_0x353b13['shift']());}catch(_0x373077){_0x353b13['push'](_0x353b13['shift']());}}}(a13_0x4d86,0xa44ca));var __createBinding=this&&this[a13_0x5abff5(0x12f)]||(Object[a13_0x5abff5(0x145)]?function(_0x1721c0,_0x37647a,_0x504641,_0x307c95){const _0x41ab62=a13_0x5abff5;if(_0x307c95===undefined)_0x307c95=_0x504641;var _0x3d7664=Object[_0x41ab62(0x130)](_0x37647a,_0x504641);(!_0x3d7664||(_0x41ab62(0x102)in _0x3d7664?!_0x37647a[_0x41ab62(0x140)]:_0x3d7664[_0x41ab62(0xf4)]||_0x3d7664[_0x41ab62(0x108)]))&&(_0x3d7664={'enumerable':!![],'get':function(){return _0x37647a[_0x504641];}}),Object['defineProperty'](_0x1721c0,_0x307c95,_0x3d7664);}:function(_0x109f05,_0x4d1631,_0x35d679,_0x199c32){if(_0x199c32===undefined)_0x199c32=_0x35d679;_0x109f05[_0x199c32]=_0x4d1631[_0x35d679];}),__setModuleDefault=this&&this[a13_0x5abff5(0x10c)]||(Object[a13_0x5abff5(0x145)]?function(_0x15219f,_0x4b4eed){const _0x2531cf=a13_0x5abff5;Object['defineProperty'](_0x15219f,_0x2531cf(0x11d),{'enumerable':!![],'value':_0x4b4eed});}:function(_0x5e3bd7,_0x746d93){const _0x5a64e6=a13_0x5abff5;_0x5e3bd7[_0x5a64e6(0x11d)]=_0x746d93;}),__importStar=this&&this[a13_0x5abff5(0x154)]||(function(){var _0x5187a9=function(_0x34fffa){const _0x51dfb8=a13_0x523d;return _0x5187a9=Object[_0x51dfb8(0x11c)]||function(_0x3de2ba){const _0x445c32=_0x51dfb8;var _0x188d52=[];for(var _0x255fea in _0x3de2ba)if(Object[_0x445c32(0x152)][_0x445c32(0x113)][_0x445c32(0x127)](_0x3de2ba,_0x255fea))_0x188d52[_0x188d52['length']]=_0x255fea;return _0x188d52;},_0x5187a9(_0x34fffa);};return function(_0x421643){const _0x76330b=a13_0x523d;if(_0x421643&&_0x421643[_0x76330b(0x140)])return _0x421643;var _0x9cbd6e={};if(_0x421643!=null){for(var _0xb4cc9b=_0x5187a9(_0x421643),_0x501541=0x0;_0x501541<_0xb4cc9b[_0x76330b(0x109)];_0x501541++)if(_0xb4cc9b[_0x501541]!==_0x76330b(0x11d))__createBinding(_0x9cbd6e,_0x421643,_0xb4cc9b[_0x501541]);}return __setModuleDefault(_0x9cbd6e,_0x421643),_0x9cbd6e;};}()),__importDefault=this&&this['__importDefault']||function(_0x4c35e3){const _0x15589=a13_0x5abff5;return _0x4c35e3&&_0x4c35e3[_0x15589(0x140)]?_0x4c35e3:{'default':_0x4c35e3};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x5abff5(0xf1)]=void 0x0;function a13_0x4d86(){const _0x3e99ac=['sendShopWebhook','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.success','application/json','log','202812ZfhzUE','call','Payment\x20processed\x20successfully','test_gateway','payment','\x20processed:\x20','Error\x20parsing\x20webhook\x20events:','failureReason','POST','__createBinding','getOwnPropertyDescriptor','findUnique','Any\x20future\x20date\x20(MM/YY)','paymentMethod','testGatewayService','failureMessage',',\x20cannot\x20process','WebhookService','16MWYelG','toLowerCase','3220190OaEJNX','error','shopId','webhookUrl','5201RpEOiX','customerEmail','__esModule','PAID','../services/telegramBotService','isArray','stringify','create','PENDING','ðŸ§ª\x20Test\x20Gateway\x20result:','../config/database','currency','Payment\x20status\x20is\x20','Payment\x20failed','paid','test_card','customerName','json','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Test\x20Gateway\x20webhook\x20sent\x20to\x20','prototype','payment.failed','__importStar','sendPaymentStatusNotification','44497sJlaBK','sendPaymentNotification','now','5532asBhwZ','19293659cbCYPu','paidAt','webhookLog','TestGatewayController','Any\x20name','status','writable','Any\x20other\x20card\x20number','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failed','then','gatewayOrderId','processCardPayment','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookEvents','FAILED','gatewayPaymentId','replace','3yMhIle','TestGatewayService','get','test_gateway_','settings','0000','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20to\x20','configurable','length','Payment\x20not\x20found','resolve','__setModuleDefault','parse','Any\x203-4\x20digits','successUrl','shop','toISOString','../services/gateways/testGatewayService','hasOwnProperty','gateway','5014575RmPCkM','cardNumber','cardLast4','4242\x204242\x204242\x204242','62128mjmwHH','slice','name','getOwnPropertyNames','default','amount','684KqigPt','transactionId'];a13_0x4d86=function(){return _0x3e99ac;};return a13_0x4d86();}const testGatewayService_1=require(a13_0x5abff5(0x112)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x5abff5(0x148)));class TestGatewayController{constructor(){const _0x2df65e=a13_0x5abff5;this['getPaymentForm']=async(_0x5a84f1,_0x206e66,_0x4cb1ca)=>{const _0x466722=a13_0x523d;try{const {paymentId:_0x48c491}=_0x5a84f1['params'];console[_0x466722(0x125)](_0x466722(0xf6)+_0x48c491);const _0x572446=await database_1[_0x466722(0x11d)][_0x466722(0x12a)][_0x466722(0x131)]({'where':{'id':_0x48c491},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x572446)return _0x206e66['status'](0x194)[_0x466722(0x14f)]({'success':![],'message':_0x466722(0x10a)});if(_0x572446[_0x466722(0x114)]!==_0x466722(0x129))return _0x206e66[_0x466722(0xf3)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x572446[_0x466722(0xf3)]!=='PENDING')return _0x206e66[_0x466722(0xf3)](0x190)['json']({'success':![],'message':_0x466722(0x14a)+_0x572446['status']+_0x466722(0x136)});_0x206e66[_0x466722(0x14f)]({'success':!![],'result':{'paymentId':_0x572446['id'],'orderId':_0x572446[_0x466722(0xf9)],'amount':_0x572446[_0x466722(0x11e)],'currency':_0x572446[_0x466722(0x149)],'merchantName':_0x572446['shop'][_0x466722(0x11b)],'description':_0x466722(0x107)+_0x572446[_0x466722(0x110)]['name'],'testInstructions':{'successCard':_0x466722(0x118),'failureCard':_0x466722(0xf5),'expiryDate':_0x466722(0x132),'cvc':_0x466722(0x10e),'holderName':_0x466722(0xf2)}}});}catch(_0x296a97){_0x4cb1ca(_0x296a97);}},this['processCard']=async(_0x40acea,_0x8ffe62,_0x4c7344)=>{const _0x5dead3=a13_0x523d;try{const {paymentId:_0x8cf6c6}=_0x40acea['params'],_0x30e70f=_0x40acea['body'];console[_0x5dead3(0x125)](_0x5dead3(0x106)+_0x8cf6c6);const _0x3561c4=await database_1[_0x5dead3(0x11d)][_0x5dead3(0x12a)][_0x5dead3(0x131)]({'where':{'id':_0x8cf6c6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3561c4)return _0x8ffe62[_0x5dead3(0xf3)](0x194)[_0x5dead3(0x14f)]({'success':![],'message':_0x5dead3(0x10a)});if(_0x3561c4[_0x5dead3(0x114)]!==_0x5dead3(0x129))return _0x8ffe62['status'](0x190)[_0x5dead3(0x14f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3561c4['status']!==_0x5dead3(0x146))return _0x8ffe62[_0x5dead3(0xf3)](0x190)[_0x5dead3(0x14f)]({'success':![],'message':_0x5dead3(0x14a)+_0x3561c4[_0x5dead3(0xf3)]+',\x20cannot\x20process'});const _0x207e22=await this[_0x5dead3(0x134)][_0x5dead3(0xfa)]({'paymentId':_0x3561c4['id'],'orderId':_0x3561c4[_0x5dead3(0xf9)]||_0x3561c4['id'],'amount':_0x3561c4[_0x5dead3(0x11e)],'currency':_0x3561c4['currency'],'cardData':_0x30e70f});console['log'](_0x5dead3(0x147),_0x207e22);const _0x1b443f={'status':_0x207e22[_0x5dead3(0xf3)],'updatedAt':new Date()};if(_0x207e22[_0x5dead3(0xf3)]===_0x5dead3(0x141))_0x1b443f[_0x5dead3(0xef)]=new Date(),_0x1b443f[_0x5dead3(0xfe)]=_0x207e22[_0x5dead3(0x120)];else _0x207e22[_0x5dead3(0xf3)]==='FAILED'&&(_0x1b443f[_0x5dead3(0x135)]=_0x207e22[_0x5dead3(0x12d)]);const _0x4e2909=_0x30e70f[_0x5dead3(0x116)][_0x5dead3(0xff)](/[\s-]/g,'');_0x1b443f[_0x5dead3(0x117)]=_0x4e2909[_0x5dead3(0x11a)](-0x4),_0x1b443f[_0x5dead3(0x133)]=_0x5dead3(0x14d),await database_1[_0x5dead3(0x11d)]['payment']['update']({'where':{'id':_0x3561c4['id']},'data':_0x1b443f}),await database_1[_0x5dead3(0x11d)][_0x5dead3(0xf0)]['create']({'data':{'paymentId':_0x3561c4['id'],'shopId':_0x3561c4[_0x5dead3(0x13c)],'event':_0x5dead3(0x103)+_0x207e22[_0x5dead3(0xf3)][_0x5dead3(0x139)](),'statusCode':0xc8,'responseBody':JSON[_0x5dead3(0x144)]({'oldStatus':_0x5dead3(0x146),'newStatus':_0x207e22['status'],'transactionId':_0x207e22[_0x5dead3(0x120)],'failureReason':_0x207e22[_0x5dead3(0x12d)],'processedAt':new Date()[_0x5dead3(0x111)]()})}}),await this[_0x5dead3(0x121)](_0x3561c4,_0x207e22['status'],_0x207e22['transactionId'],_0x207e22['failureReason']),await this[_0x5dead3(0x155)](_0x3561c4,_0x207e22['status']),console[_0x5dead3(0x125)]('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x8cf6c6+_0x5dead3(0x12b)+_0x207e22[_0x5dead3(0xf3)]),_0x207e22[_0x5dead3(0xf3)]===_0x5dead3(0x141)?_0x8ffe62[_0x5dead3(0x14f)]({'success':!![],'message':_0x5dead3(0x128),'result':{'status':'PAID','transactionId':_0x207e22[_0x5dead3(0x120)],'redirectUrl':_0x3561c4[_0x5dead3(0x10f)]}}):_0x8ffe62[_0x5dead3(0xf3)](0x190)['json']({'success':![],'message':_0x5dead3(0x14b),'result':{'status':_0x5dead3(0xfd),'failureReason':_0x207e22[_0x5dead3(0x12d)],'redirectUrl':_0x3561c4['failUrl']}});}catch(_0x193b75){_0x4c7344(_0x193b75);}},this[_0x2df65e(0x134)]=new testGatewayService_1[(_0x2df65e(0x101))](),this['webhookService']=new webhookService_1[(_0x2df65e(0x137))]();}async[a13_0x5abff5(0x121)](_0x2e46d1,_0x303c68,_0x422055,_0xbc37dc){const _0x27b994=a13_0x5abff5,_0x12ba05=Date['now']();try{const _0x450068=_0x2e46d1[_0x27b994(0x110)],_0x490cd9=_0x450068[_0x27b994(0x104)];if(!_0x490cd9?.[_0x27b994(0x13d)]){console[_0x27b994(0x125)](_0x27b994(0x122)+_0x450068['id']);return;}const _0x413d5d=_0x303c68==='PAID'?_0x27b994(0x123):_0x27b994(0x153);let _0x123dcc=[];if(_0x490cd9[_0x27b994(0xfc)])try{_0x123dcc=Array[_0x27b994(0x143)](_0x490cd9[_0x27b994(0xfc)])?_0x490cd9['webhookEvents']:JSON[_0x27b994(0x10d)](_0x490cd9[_0x27b994(0xfc)]);}catch(_0x1e57e6){console[_0x27b994(0x13b)](_0x27b994(0x12c),_0x1e57e6),_0x123dcc=[];}if(!_0x123dcc['includes'](_0x413d5d)){console[_0x27b994(0x125)]('Webhook\x20event\x20'+_0x413d5d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x450068['id']);return;}const _0x5a8bdf={'event':_0x413d5d,'payment':{'id':_0x2e46d1['id'],'order_id':_0x2e46d1['orderId'],'gateway_order_id':_0x2e46d1['gatewayOrderId'],'gateway':_0x27b994(0x105),'amount':_0x2e46d1['amount'],'currency':_0x2e46d1[_0x27b994(0x149)],'status':_0x303c68[_0x27b994(0x139)](),'customer_email':_0x2e46d1[_0x27b994(0x13f)],'customer_name':_0x2e46d1[_0x27b994(0x14e)],'transaction_id':_0x422055,'failure_message':_0xbc37dc,'created_at':_0x2e46d1['createdAt'],'updated_at':new Date()}},_0x1209b3=await fetch(_0x490cd9[_0x27b994(0x13d)],{'method':_0x27b994(0x12e),'headers':{'Content-Type':_0x27b994(0x124),'User-Agent':_0x27b994(0x150)},'body':JSON['stringify'](_0x5a8bdf)}),_0x2fb0a5=Date[_0x27b994(0xec)]()-_0x12ba05;console[_0x27b994(0x125)](_0x27b994(0x151)+_0x490cd9[_0x27b994(0x13d)]+'\x20with\x20status\x20'+_0x1209b3[_0x27b994(0xf3)]+'\x20('+_0x2fb0a5+'ms)');}catch(_0x47f2df){console[_0x27b994(0x13b)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x47f2df);}}async[a13_0x5abff5(0x155)](_0x1596f6,_0x23b8e8){const _0x1377ca=a13_0x5abff5;try{const {telegramBotService:_0x57d988}=await Promise[_0x1377ca(0x10b)]()[_0x1377ca(0xf8)](()=>__importStar(require(_0x1377ca(0x142)))),_0x545fb9={'PAID':_0x1377ca(0x14c),'FAILED':_0x1377ca(0xf7)},_0x525abb=_0x545fb9[_0x23b8e8];if(!_0x525abb)return;await _0x57d988[_0x1377ca(0xeb)](_0x1596f6[_0x1377ca(0x13c)],_0x1596f6,_0x525abb);}catch(_0x1f92b1){console[_0x1377ca(0x13b)](_0x1377ca(0xfb),_0x1f92b1);}}}function a13_0x523d(_0x39d5f1,_0xe286d1){const _0x4d867e=a13_0x4d86();return a13_0x523d=function(_0x523d98,_0x442240){_0x523d98=_0x523d98-0xea;let _0x18a2e1=_0x4d867e[_0x523d98];return _0x18a2e1;},a13_0x523d(_0x39d5f1,_0xe286d1);}exports['TestGatewayController']=TestGatewayController;