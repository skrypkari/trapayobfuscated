'use strict';const a21_0x3b9194=a21_0x152d;function a21_0x3e90(){const _0x5c4ce3=['gateway','Payment\x20System/1.0\x20(Test\x20Gateway)','includes','WebhookService','testGatewayService','application/json','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','toLowerCase','default','4xlfmLl','paid','hex','‚ùå\x20Payment\x20link\x20','\x20processed:\x20','isArray','webhookEvents','amount','length','__importDefault','PAID','üß™\x20Test\x20Gateway\x20webhook:\x20event=','getPaymentForm','cardNumber','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','now','failed','replace','../services/webhookService','PENDING','Payment\x20processed\x20successfully','createHmac','../services/telegramBotService','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20->\x20','webhookUrl','25503560vlaYDG',',\x20webhookUrl=','params','json','shop','log','9392922vBrdpz','...','‚ö†Ô∏è\x20Webhook\x20event\x20','defineProperty','toISOString','$transaction','parse','__createBinding','Payment\x20not\x20found','hasOwnProperty','TestGatewayController','8555208cRwzHa','stringify','767223ZqKUDw','üìà\x20Found\x20payment\x20link\x20','paymentLinkId','5dHehoK','paymentLink','status','getOwnPropertyDescriptor','sendShopWebhook',',\x20status=','currency','TestGatewayService','gatewayPaymentId','../config/database',',\x20currentPayments=','customerEmail','digest','writable',',\x20cannot\x20process','failUrl','test_card','create','Payment\x20status\x20is\x20','üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Any\x20future\x20date\x20(MM/YY)','7KsLeqC','payment','SINGLE','Payment\x20is\x20not\x20for\x20test\x20gateway','shopId','prototype','test_gateway','webhookLog','4242\x204242\x204242\x204242','test_gateway_','then','238287thzKbV','üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20','findUnique','failureReason','Any\x20name','1253128ZFQlPT','Payment\x20failed','üìà\x20Test\x20Gateway:\x20Payment\x20','type','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','POST','gatewayOrderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','cardLast4','sendPaymentNotification','name','\x20not\x20found','5525706mHiCpZ','orderId','‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','update','FAILED','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','currentPayments','createdAt','error','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','0000','__esModule','configurable','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','üß™\x20Test\x20Gateway\x20result:','customerName','get','payment.failed','transactionId','__setModuleDefault','settings','üß™\x20Sending\x20webhook\x20to\x20','üß™\x20Webhook\x20payload:','secretKey','successUrl','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','call','body','not\x20configured','__importStar'];a21_0x3e90=function(){return _0x5c4ce3;};return a21_0x3e90();}(function(_0x22cec5,_0x504f70){const _0x3f9d4b=a21_0x152d,_0x52cfcf=_0x22cec5();while(!![]){try{const _0x4a2e0a=parseInt(_0x3f9d4b(0x1aa))/0x1*(parseInt(_0x3f9d4b(0x1e2))/0x2)+parseInt(_0x3f9d4b(0x186))/0x3+parseInt(_0x3f9d4b(0x1af))/0x4*(parseInt(_0x3f9d4b(0x189))/0x5)+-parseInt(_0x3f9d4b(0x1bb))/0x6+parseInt(_0x3f9d4b(0x19f))/0x7*(-parseInt(_0x3f9d4b(0x184))/0x8)+-parseInt(_0x3f9d4b(0x179))/0x9+parseInt(_0x3f9d4b(0x173))/0xa;if(_0x4a2e0a===_0x504f70)break;else _0x52cfcf['push'](_0x52cfcf['shift']());}catch(_0x14e6b6){_0x52cfcf['push'](_0x52cfcf['shift']());}}}(a21_0x3e90,0x89317));function a21_0x152d(_0x189713,_0x11bb56){_0x189713=_0x189713-0x15d;const _0x3e902d=a21_0x3e90();let _0x152d91=_0x3e902d[_0x189713];return _0x152d91;}var __createBinding=this&&this[a21_0x3b9194(0x180)]||(Object['create']?function(_0xd94608,_0x2d9846,_0x1052ba,_0x231f11){const _0x4594e0=a21_0x3b9194;if(_0x231f11===undefined)_0x231f11=_0x1052ba;var _0xd688cf=Object[_0x4594e0(0x18c)](_0x2d9846,_0x1052ba);(!_0xd688cf||(_0x4594e0(0x1cb)in _0xd688cf?!_0x2d9846['__esModule']:_0xd688cf[_0x4594e0(0x196)]||_0xd688cf[_0x4594e0(0x1c7)]))&&(_0xd688cf={'enumerable':!![],'get':function(){return _0x2d9846[_0x1052ba];}}),Object[_0x4594e0(0x17c)](_0xd94608,_0x231f11,_0xd688cf);}:function(_0x17fe26,_0x19c049,_0x672ad0,_0x316abc){if(_0x316abc===undefined)_0x316abc=_0x672ad0;_0x17fe26[_0x316abc]=_0x19c049[_0x672ad0];}),__setModuleDefault=this&&this[a21_0x3b9194(0x1ce)]||(Object[a21_0x3b9194(0x19a)]?function(_0x20deaf,_0x1a4cf4){const _0x2b03cd=a21_0x3b9194;Object[_0x2b03cd(0x17c)](_0x20deaf,'default',{'enumerable':!![],'value':_0x1a4cf4});}:function(_0x2bb333,_0x4ab3ff){const _0x4bd1ee=a21_0x3b9194;_0x2bb333[_0x4bd1ee(0x1e1)]=_0x4ab3ff;}),__importStar=this&&this[a21_0x3b9194(0x1d8)]||(function(){var _0x4df704=function(_0x115370){return _0x4df704=Object['getOwnPropertyNames']||function(_0x5f50f9){const _0x2a24d6=a21_0x152d;var _0x120340=[];for(var _0x57bef4 in _0x5f50f9)if(Object[_0x2a24d6(0x1a4)][_0x2a24d6(0x182)][_0x2a24d6(0x1d5)](_0x5f50f9,_0x57bef4))_0x120340[_0x120340[_0x2a24d6(0x161)]]=_0x57bef4;return _0x120340;},_0x4df704(_0x115370);};return function(_0x32986a){const _0x523239=a21_0x152d;if(_0x32986a&&_0x32986a[_0x523239(0x1c6)])return _0x32986a;var _0x4f8e33={};if(_0x32986a!=null){for(var _0x331454=_0x4df704(_0x32986a),_0x23bbd4=0x0;_0x23bbd4<_0x331454[_0x523239(0x161)];_0x23bbd4++)if(_0x331454[_0x23bbd4]!==_0x523239(0x1e1))__createBinding(_0x4f8e33,_0x32986a,_0x331454[_0x23bbd4]);}return __setModuleDefault(_0x4f8e33,_0x32986a),_0x4f8e33;};}()),__importDefault=this&&this[a21_0x3b9194(0x162)]||function(_0x59d0c0){const _0x428fba=a21_0x3b9194;return _0x59d0c0&&_0x59d0c0[_0x428fba(0x1c6)]?_0x59d0c0:{'default':_0x59d0c0};};Object[a21_0x3b9194(0x17c)](exports,a21_0x3b9194(0x1c6),{'value':!![]}),exports[a21_0x3b9194(0x183)]=void 0x0;const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a21_0x3b9194(0x16b)),database_1=__importDefault(require(a21_0x3b9194(0x192)));class TestGatewayController{constructor(){const _0x49cc34=a21_0x3b9194;this[_0x49cc34(0x165)]=async(_0x2845bd,_0xaa6970,_0x3e010b)=>{const _0x7f9f57=_0x49cc34;try{const {paymentId:_0xc2c362}=_0x2845bd['params'];console[_0x7f9f57(0x178)](_0x7f9f57(0x1c0)+_0xc2c362);const _0x3678a4=await database_1[_0x7f9f57(0x1e1)]['payment'][_0x7f9f57(0x1ac)]({'where':{'id':_0xc2c362},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3678a4)return _0xaa6970['status'](0x194)[_0x7f9f57(0x176)]({'success':![],'message':_0x7f9f57(0x181)});if(_0x3678a4[_0x7f9f57(0x1d9)]!==_0x7f9f57(0x1a5))return _0xaa6970[_0x7f9f57(0x18b)](0x190)[_0x7f9f57(0x176)]({'success':![],'message':_0x7f9f57(0x1a2)});if(_0x3678a4[_0x7f9f57(0x18b)]!=='PENDING')return _0xaa6970[_0x7f9f57(0x18b)](0x190)[_0x7f9f57(0x176)]({'success':![],'message':_0x7f9f57(0x19b)+_0x3678a4[_0x7f9f57(0x18b)]+_0x7f9f57(0x197)});_0xaa6970[_0x7f9f57(0x176)]({'success':!![],'result':{'paymentId':_0x3678a4['id'],'orderId':_0x3678a4[_0x7f9f57(0x1b5)],'amount':_0x3678a4[_0x7f9f57(0x160)],'currency':_0x3678a4[_0x7f9f57(0x18f)],'merchantName':_0x3678a4['shop']['name'],'description':'Payment\x20to\x20'+_0x3678a4[_0x7f9f57(0x177)][_0x7f9f57(0x1b9)],'testInstructions':{'successCard':_0x7f9f57(0x1a7),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x7f9f57(0x19e),'cvc':'Any\x203-4\x20digits','holderName':_0x7f9f57(0x1ae)}}});}catch(_0x55be86){_0x3e010b(_0x55be86);}},this['processCard']=async(_0x1f1236,_0x166761,_0x2eca76)=>{const _0xfafe1e=_0x49cc34;try{const {paymentId:_0x59d388}=_0x1f1236[_0xfafe1e(0x175)],_0x39e5c9=_0x1f1236[_0xfafe1e(0x1d6)];console[_0xfafe1e(0x178)](_0xfafe1e(0x19d)+_0x59d388);const _0x3d0b6e=await database_1[_0xfafe1e(0x1e1)][_0xfafe1e(0x1a0)][_0xfafe1e(0x1ac)]({'where':{'id':_0x59d388},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3d0b6e)return _0x166761[_0xfafe1e(0x18b)](0x194)[_0xfafe1e(0x176)]({'success':![],'message':_0xfafe1e(0x181)});if(_0x3d0b6e['gateway']!==_0xfafe1e(0x1a5))return _0x166761[_0xfafe1e(0x18b)](0x190)[_0xfafe1e(0x176)]({'success':![],'message':_0xfafe1e(0x1a2)});if(_0x3d0b6e['status']!==_0xfafe1e(0x16c))return _0x166761[_0xfafe1e(0x18b)](0x190)['json']({'success':![],'message':_0xfafe1e(0x19b)+_0x3d0b6e['status']+_0xfafe1e(0x197)});const _0x293b72=await this[_0xfafe1e(0x1dd)]['processCardPayment']({'paymentId':_0x3d0b6e['id'],'orderId':_0x3d0b6e['gatewayOrderId']||_0x3d0b6e['id'],'amount':_0x3d0b6e[_0xfafe1e(0x160)],'currency':_0x3d0b6e[_0xfafe1e(0x18f)],'cardData':_0x39e5c9});console[_0xfafe1e(0x178)](_0xfafe1e(0x1c9),_0x293b72);const _0x43fe96={'status':_0x293b72['status'],'updatedAt':new Date()};if(_0x293b72[_0xfafe1e(0x18b)]==='PAID')_0x43fe96['paidAt']=new Date(),_0x43fe96[_0xfafe1e(0x191)]=_0x293b72[_0xfafe1e(0x1cd)];else _0x293b72[_0xfafe1e(0x18b)]===_0xfafe1e(0x1bf)&&(_0x43fe96['failureMessage']=_0x293b72[_0xfafe1e(0x1ad)]);const _0x24f53c=_0x39e5c9[_0xfafe1e(0x166)][_0xfafe1e(0x16a)](/[\s-]/g,'');_0x43fe96[_0xfafe1e(0x1b7)]=_0x24f53c['slice'](-0x4),_0x43fe96['paymentMethod']=_0xfafe1e(0x199),await database_1[_0xfafe1e(0x1e1)][_0xfafe1e(0x1a0)]['update']({'where':{'id':_0x3d0b6e['id']},'data':_0x43fe96});if(_0x293b72[_0xfafe1e(0x18b)]===_0xfafe1e(0x163)&&_0x3d0b6e[_0xfafe1e(0x188)]){console[_0xfafe1e(0x178)](_0xfafe1e(0x1b1)+_0x3d0b6e['id']+_0xfafe1e(0x1d4));try{await database_1[_0xfafe1e(0x1e1)][_0xfafe1e(0x17e)](async _0x7304e4=>{const _0x545720=_0xfafe1e,_0x26b504=await _0x7304e4[_0x545720(0x18a)][_0x545720(0x1ac)]({'where':{'id':_0x3d0b6e[_0x545720(0x188)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x26b504){console['log'](_0x545720(0x187)+_0x26b504['id']+':\x20type='+_0x26b504[_0x545720(0x1b2)]+_0x545720(0x193)+_0x26b504[_0x545720(0x1c1)]+_0x545720(0x18e)+_0x26b504[_0x545720(0x18b)]);const _0x444f08=_0x26b504['currentPayments']+0x1,_0xb39866=_0x26b504[_0x545720(0x1b2)]===_0x545720(0x1a1)?'COMPLETED':_0x26b504['status'];await _0x7304e4[_0x545720(0x18a)][_0x545720(0x1be)]({'where':{'id':_0x3d0b6e[_0x545720(0x188)]},'data':{'currentPayments':_0x444f08,'status':_0xb39866,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x26b504['id']+'\x20updated:\x20currentPayments='+_0x26b504['currentPayments']+_0x545720(0x171)+_0x444f08+_0x545720(0x18e)+_0x26b504[_0x545720(0x18b)]+'\x20->\x20'+_0xb39866);}else console[_0x545720(0x178)](_0x545720(0x1e5)+_0x3d0b6e[_0x545720(0x188)]+_0x545720(0x1ba));});}catch(_0x35c99d){console[_0xfafe1e(0x1c3)](_0xfafe1e(0x170),_0x35c99d);}}await database_1[_0xfafe1e(0x1e1)][_0xfafe1e(0x1a6)][_0xfafe1e(0x19a)]({'data':{'paymentId':_0x3d0b6e['id'],'shopId':_0x3d0b6e[_0xfafe1e(0x1a3)],'event':_0xfafe1e(0x1a8)+_0x293b72['status'][_0xfafe1e(0x1e0)](),'statusCode':_0x293b72[_0xfafe1e(0x18b)]==='PAID'?0xc8:0x190,'responseBody':JSON[_0xfafe1e(0x185)]({'oldStatus':_0xfafe1e(0x16c),'newStatus':_0x293b72[_0xfafe1e(0x18b)],'transactionId':_0x293b72['transactionId'],'failureReason':_0x293b72[_0xfafe1e(0x1ad)],'processedAt':new Date()[_0xfafe1e(0x17d)]()})}}),console[_0xfafe1e(0x178)](_0xfafe1e(0x1c4)+_0x293b72['status']+_0xfafe1e(0x17a)),await this['sendShopWebhook'](_0x3d0b6e,_0x293b72[_0xfafe1e(0x18b)],_0x293b72[_0xfafe1e(0x1cd)],_0x293b72[_0xfafe1e(0x1ad)]),console[_0xfafe1e(0x178)](_0xfafe1e(0x1ab)+_0x293b72[_0xfafe1e(0x18b)]),console['log'](_0xfafe1e(0x19c)+_0x293b72[_0xfafe1e(0x18b)]+'...'),await this['sendPaymentStatusNotification'](_0x3d0b6e,_0x293b72[_0xfafe1e(0x18b)]),console[_0xfafe1e(0x178)](_0xfafe1e(0x1b3)+_0x293b72[_0xfafe1e(0x18b)]),console[_0xfafe1e(0x178)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x59d388+_0xfafe1e(0x15d)+_0x293b72['status']),_0x293b72['status']===_0xfafe1e(0x163)?_0x166761[_0xfafe1e(0x176)]({'success':!![],'message':_0xfafe1e(0x16d),'result':{'status':_0xfafe1e(0x163),'transactionId':_0x293b72[_0xfafe1e(0x1cd)],'redirectUrl':_0x3d0b6e[_0xfafe1e(0x1d3)]}}):_0x166761[_0xfafe1e(0x18b)](0x190)['json']({'success':![],'message':_0xfafe1e(0x1b0),'result':{'status':_0xfafe1e(0x1bf),'failureReason':_0x293b72[_0xfafe1e(0x1ad)],'redirectUrl':_0x3d0b6e[_0xfafe1e(0x198)]}});}catch(_0x2f84d5){_0x2eca76(_0x2f84d5);}},this[_0x49cc34(0x1dd)]=new testGatewayService_1[(_0x49cc34(0x190))](),this['webhookService']=new webhookService_1[(_0x49cc34(0x1dc))]();}async[a21_0x3b9194(0x18d)](_0x4dcbfc,_0xed01c5,_0x1d85ac,_0x450453){const _0xb4b161=a21_0x3b9194,_0xfb65f4=Date[_0xb4b161(0x168)]();try{const _0x2cfaa2=_0x4dcbfc[_0xb4b161(0x177)],_0x3e64bb=_0x2cfaa2[_0xb4b161(0x1cf)];if(!_0x3e64bb?.[_0xb4b161(0x172)]){console[_0xb4b161(0x178)](_0xb4b161(0x1b6)+_0x2cfaa2['id']);return;}const _0xa04d7f=_0xed01c5===_0xb4b161(0x163)?'payment.success':_0xb4b161(0x1cc);console[_0xb4b161(0x178)](_0xb4b161(0x164)+_0xa04d7f+_0xb4b161(0x174)+(_0x3e64bb['webhookUrl']?'configured':_0xb4b161(0x1d7)));let _0x212dd3=[];if(_0x3e64bb[_0xb4b161(0x15f)])try{_0x212dd3=Array[_0xb4b161(0x15e)](_0x3e64bb['webhookEvents'])?_0x3e64bb[_0xb4b161(0x15f)]:JSON[_0xb4b161(0x17f)](_0x3e64bb['webhookEvents']);}catch(_0x4ffeb2){console[_0xb4b161(0x1c3)]('Error\x20parsing\x20webhook\x20events:',_0x4ffeb2),_0x212dd3=[];}console['log'](_0xb4b161(0x1c8),_0x212dd3);if(!_0x212dd3[_0xb4b161(0x1db)](_0xa04d7f)){console[_0xb4b161(0x178)](_0xb4b161(0x17b)+_0xa04d7f+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2cfaa2['id']);return;}const _0x11297e={'event':_0xa04d7f,'payment':{'id':_0x4dcbfc['id'],'order_id':_0x4dcbfc[_0xb4b161(0x1bc)],'gateway_order_id':_0x4dcbfc['gatewayOrderId'],'gateway':_0xb4b161(0x1c5),'amount':_0x4dcbfc['amount'],'currency':_0x4dcbfc[_0xb4b161(0x18f)],'status':_0xed01c5['toLowerCase'](),'customer_email':_0x4dcbfc[_0xb4b161(0x194)],'customer_name':_0x4dcbfc[_0xb4b161(0x1ca)],'transaction_id':_0x1d85ac,'failure_message':_0x450453,'created_at':_0x4dcbfc[_0xb4b161(0x1c2)],'updated_at':new Date()}};console[_0xb4b161(0x178)](_0xb4b161(0x1d0)+_0x3e64bb[_0xb4b161(0x172)]+_0xb4b161(0x17a)),console[_0xb4b161(0x178)](_0xb4b161(0x1d1),JSON[_0xb4b161(0x185)](_0x11297e,null,0x2));const _0x42ed9a=JSON['stringify'](_0x11297e),_0x5c349d=crypto_1[_0xb4b161(0x1e1)][_0xb4b161(0x16e)]('sha256',_0x2cfaa2[_0xb4b161(0x1d2)])[_0xb4b161(0x1be)](_0x42ed9a)[_0xb4b161(0x195)](_0xb4b161(0x1e4)),_0x5e8040=await fetch(_0x3e64bb[_0xb4b161(0x172)],{'method':_0xb4b161(0x1b4),'headers':{'Content-Type':_0xb4b161(0x1de),'User-Agent':_0xb4b161(0x1da),'X-Webhook-Signature':_0x5c349d},'body':_0x42ed9a}),_0x5f493d=Date[_0xb4b161(0x168)]()-_0xfb65f4;console[_0xb4b161(0x178)](_0xb4b161(0x1bd)+_0x3e64bb[_0xb4b161(0x172)]+'\x20with\x20status\x20'+_0x5e8040[_0xb4b161(0x18b)]+'\x20('+_0x5f493d+'ms)');}catch(_0x45f7ac){console[_0xb4b161(0x1c3)](_0xb4b161(0x1df),_0x45f7ac);}}async['sendPaymentStatusNotification'](_0x5ba87b,_0x2648cd){const _0x10df59=a21_0x3b9194;try{const {telegramBotService:_0x390f6a}=await Promise['resolve']()[_0x10df59(0x1a9)](()=>__importStar(require(_0x10df59(0x16f)))),_0x54b92a={'PAID':_0x10df59(0x1e3),'FAILED':_0x10df59(0x169)},_0x119a60=_0x54b92a[_0x2648cd];if(!_0x119a60)return;await _0x390f6a[_0x10df59(0x1b8)](_0x5ba87b[_0x10df59(0x1a3)],_0x5ba87b,_0x119a60);}catch(_0x53b57d){console['error'](_0x10df59(0x167),_0x53b57d);}}}exports[a21_0x3b9194(0x183)]=TestGatewayController;