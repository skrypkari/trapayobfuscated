'use strict';const a13_0x4ec456=a13_0x3c1e;(function(_0x16f8d5,_0x500a45){const _0x565c9a=a13_0x3c1e,_0x1b1137=_0x16f8d5();while(!![]){try{const _0x5a3487=parseInt(_0x565c9a(0x121))/0x1+-parseInt(_0x565c9a(0x107))/0x2*(-parseInt(_0x565c9a(0xc8))/0x3)+parseInt(_0x565c9a(0xb6))/0x4+parseInt(_0x565c9a(0xb3))/0x5+parseInt(_0x565c9a(0xd0))/0x6*(parseInt(_0x565c9a(0xce))/0x7)+parseInt(_0x565c9a(0x116))/0x8*(-parseInt(_0x565c9a(0x124))/0x9)+-parseInt(_0x565c9a(0xd8))/0xa*(parseInt(_0x565c9a(0xe7))/0xb);if(_0x5a3487===_0x500a45)break;else _0x1b1137['push'](_0x1b1137['shift']());}catch(_0x4d66e9){_0x1b1137['push'](_0x1b1137['shift']());}}}(a13_0x3c03,0x7c5da));function a13_0x3c1e(_0x4f7306,_0x4528ec){const _0x3c03db=a13_0x3c03();return a13_0x3c1e=function(_0x3c1e50,_0xba7d5c){_0x3c1e50=_0x3c1e50-0xb0;let _0xf5d8f5=_0x3c03db[_0x3c1e50];return _0xf5d8f5;},a13_0x3c1e(_0x4f7306,_0x4528ec);}var __createBinding=this&&this['__createBinding']||(Object[a13_0x4ec456(0x10e)]?function(_0x10e2d8,_0xb06d24,_0x1cf0aa,_0x290bd9){const _0x13c91e=a13_0x4ec456;if(_0x290bd9===undefined)_0x290bd9=_0x1cf0aa;var _0x4d24bb=Object[_0x13c91e(0xb7)](_0xb06d24,_0x1cf0aa);(!_0x4d24bb||(_0x13c91e(0xc4)in _0x4d24bb?!_0xb06d24[_0x13c91e(0x120)]:_0x4d24bb[_0x13c91e(0x11e)]||_0x4d24bb['configurable']))&&(_0x4d24bb={'enumerable':!![],'get':function(){return _0xb06d24[_0x1cf0aa];}}),Object[_0x13c91e(0xed)](_0x10e2d8,_0x290bd9,_0x4d24bb);}:function(_0xc69110,_0x7dec6a,_0x50333c,_0x292094){if(_0x292094===undefined)_0x292094=_0x50333c;_0xc69110[_0x292094]=_0x7dec6a[_0x50333c];}),__setModuleDefault=this&&this[a13_0x4ec456(0xd5)]||(Object[a13_0x4ec456(0x10e)]?function(_0x2efabf,_0x44c716){const _0x3f7d51=a13_0x4ec456;Object[_0x3f7d51(0xed)](_0x2efabf,'default',{'enumerable':!![],'value':_0x44c716});}:function(_0xec9491,_0x2f55a1){const _0x3d8dbc=a13_0x4ec456;_0xec9491[_0x3d8dbc(0xd3)]=_0x2f55a1;}),__importStar=this&&this['__importStar']||(function(){var _0xc76f6d=function(_0x24ae3e){const _0x4371b3=a13_0x3c1e;return _0xc76f6d=Object[_0x4371b3(0x117)]||function(_0x2ecd42){const _0xacec7b=_0x4371b3;var _0x249a2c=[];for(var _0x56cd95 in _0x2ecd42)if(Object[_0xacec7b(0x10b)]['hasOwnProperty'][_0xacec7b(0xee)](_0x2ecd42,_0x56cd95))_0x249a2c[_0x249a2c[_0xacec7b(0xbc)]]=_0x56cd95;return _0x249a2c;},_0xc76f6d(_0x24ae3e);};return function(_0xfcefc3){const _0x474319=a13_0x3c1e;if(_0xfcefc3&&_0xfcefc3[_0x474319(0x120)])return _0xfcefc3;var _0x49d4bc={};if(_0xfcefc3!=null){for(var _0x20e2c1=_0xc76f6d(_0xfcefc3),_0x5bdc71=0x0;_0x5bdc71<_0x20e2c1[_0x474319(0xbc)];_0x5bdc71++)if(_0x20e2c1[_0x5bdc71]!==_0x474319(0xd3))__createBinding(_0x49d4bc,_0xfcefc3,_0x20e2c1[_0x5bdc71]);}return __setModuleDefault(_0x49d4bc,_0xfcefc3),_0x49d4bc;};}()),__importDefault=this&&this[a13_0x4ec456(0xf1)]||function(_0x11d0c3){return _0x11d0c3&&_0x11d0c3['__esModule']?_0x11d0c3:{'default':_0x11d0c3};};Object['defineProperty'](exports,a13_0x4ec456(0x120),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x4ec456(0xc9)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x58bd41=a13_0x4ec456;this[_0x58bd41(0xba)]=async(_0x1f0f97,_0x295d97,_0x364dc8)=>{const _0x4b69eb=_0x58bd41;try{const {paymentId:_0x582735}=_0x1f0f97[_0x4b69eb(0x100)];console[_0x4b69eb(0xec)](_0x4b69eb(0x123)+_0x582735);const _0x3c2ffe=await database_1[_0x4b69eb(0xd3)][_0x4b69eb(0x10a)][_0x4b69eb(0xe1)]({'where':{'id':_0x582735},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3c2ffe)return _0x295d97[_0x4b69eb(0x106)](0x194)['json']({'success':![],'message':_0x4b69eb(0xc7)});if(_0x3c2ffe[_0x4b69eb(0xf9)]!=='test_gateway')return _0x295d97[_0x4b69eb(0x106)](0x190)['json']({'success':![],'message':_0x4b69eb(0xcc)});if(_0x3c2ffe[_0x4b69eb(0x106)]!==_0x4b69eb(0x127))return _0x295d97[_0x4b69eb(0x106)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3c2ffe['status']+_0x4b69eb(0xdc)});_0x295d97[_0x4b69eb(0xf3)]({'success':!![],'result':{'paymentId':_0x3c2ffe['id'],'orderId':_0x3c2ffe[_0x4b69eb(0xdb)],'amount':_0x3c2ffe[_0x4b69eb(0xcd)],'currency':_0x3c2ffe[_0x4b69eb(0xb9)],'merchantName':_0x3c2ffe['shop'][_0x4b69eb(0xc3)],'description':_0x4b69eb(0x12d)+_0x3c2ffe[_0x4b69eb(0xe0)][_0x4b69eb(0xc3)],'testInstructions':{'successCard':_0x4b69eb(0xf5),'failureCard':_0x4b69eb(0x126),'expiryDate':_0x4b69eb(0x113),'cvc':'Any\x203-4\x20digits','holderName':_0x4b69eb(0xb8)}}});}catch(_0x23e8ee){_0x364dc8(_0x23e8ee);}},this['processCard']=async(_0x3f7e3e,_0x3f4812,_0x4ceef9)=>{const _0x56d939=_0x58bd41;try{const {paymentId:_0x1e9392}=_0x3f7e3e[_0x56d939(0x100)],_0xc91986=_0x3f7e3e[_0x56d939(0xf6)];console[_0x56d939(0xec)](_0x56d939(0x115)+_0x1e9392);const _0x52200a=await database_1[_0x56d939(0xd3)][_0x56d939(0x10a)][_0x56d939(0xe1)]({'where':{'id':_0x1e9392},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52200a)return _0x3f4812['status'](0x194)[_0x56d939(0xf3)]({'success':![],'message':_0x56d939(0xc7)});if(_0x52200a['gateway']!==_0x56d939(0xbd))return _0x3f4812[_0x56d939(0x106)](0x190)['json']({'success':![],'message':_0x56d939(0xcc)});if(_0x52200a[_0x56d939(0x106)]!==_0x56d939(0x127))return _0x3f4812[_0x56d939(0x106)](0x190)['json']({'success':![],'message':_0x56d939(0xf2)+_0x52200a[_0x56d939(0x106)]+_0x56d939(0xdc)});const _0x1b9b87=await this[_0x56d939(0x101)][_0x56d939(0x110)]({'paymentId':_0x52200a['id'],'orderId':_0x52200a[_0x56d939(0xdb)]||_0x52200a['id'],'amount':_0x52200a['amount'],'currency':_0x52200a['currency'],'cardData':_0xc91986});console[_0x56d939(0xec)]('🧪\x20Test\x20Gateway\x20result:',_0x1b9b87);const _0x4aad54={'status':_0x1b9b87[_0x56d939(0x106)],'updatedAt':new Date()};if(_0x1b9b87[_0x56d939(0x106)]===_0x56d939(0x108))_0x4aad54[_0x56d939(0x12c)]=new Date(),_0x4aad54[_0x56d939(0xfa)]=_0x1b9b87[_0x56d939(0xc2)];else _0x1b9b87[_0x56d939(0x106)]===_0x56d939(0xe8)&&(_0x4aad54[_0x56d939(0xd2)]=_0x1b9b87['failureReason']);const _0x902768=_0xc91986['cardNumber'][_0x56d939(0xcf)](/[\s-]/g,'');_0x4aad54[_0x56d939(0xbf)]=_0x902768[_0x56d939(0xd9)](-0x4),_0x4aad54[_0x56d939(0xc0)]=_0x56d939(0xe9),await database_1['default'][_0x56d939(0x10a)][_0x56d939(0x11b)]({'where':{'id':_0x52200a['id']},'data':_0x4aad54});if(_0x1b9b87[_0x56d939(0x106)]==='PAID'&&_0x52200a[_0x56d939(0xb1)]){console['log'](_0x56d939(0xb0)+_0x52200a['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x56d939(0xd3)][_0x56d939(0x103)](async _0x4ec37e=>{const _0x333386=_0x56d939,_0x214e80=await _0x4ec37e['paymentLink'][_0x333386(0xe1)]({'where':{'id':_0x52200a['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x214e80){console[_0x333386(0xec)](_0x333386(0x12e)+_0x214e80['id']+':\x20type='+_0x214e80[_0x333386(0xe6)]+_0x333386(0x102)+_0x214e80[_0x333386(0xbe)]+_0x333386(0x10d)+_0x214e80[_0x333386(0x106)]);const _0x56add7=_0x214e80[_0x333386(0xbe)]+0x1,_0x80aaee=_0x214e80[_0x333386(0xe6)]==='SINGLE'?_0x333386(0xf4):_0x214e80[_0x333386(0x106)];await _0x4ec37e[_0x333386(0x118)][_0x333386(0x11b)]({'where':{'id':_0x52200a[_0x333386(0xb1)]},'data':{'currentPayments':_0x56add7,'status':_0x80aaee,'updatedAt':new Date()}}),console['log'](_0x333386(0xfe)+_0x214e80['id']+_0x333386(0xe3)+_0x214e80['currentPayments']+_0x333386(0xe4)+_0x56add7+_0x333386(0x10d)+_0x214e80[_0x333386(0x106)]+_0x333386(0xe4)+_0x80aaee);}else console[_0x333386(0xec)](_0x333386(0xea)+_0x52200a[_0x333386(0xb1)]+_0x333386(0x111));});}catch(_0x541a83){console['error'](_0x56d939(0x12a),_0x541a83);}}await database_1[_0x56d939(0xd3)][_0x56d939(0xd4)][_0x56d939(0x10e)]({'data':{'paymentId':_0x52200a['id'],'shopId':_0x52200a[_0x56d939(0xbb)],'event':_0x56d939(0xd1)+_0x1b9b87[_0x56d939(0x106)][_0x56d939(0x11f)](),'statusCode':0xc8,'responseBody':JSON[_0x56d939(0x125)]({'oldStatus':_0x56d939(0x127),'newStatus':_0x1b9b87['status'],'transactionId':_0x1b9b87[_0x56d939(0xc2)],'failureReason':_0x1b9b87[_0x56d939(0xd7)],'processedAt':new Date()[_0x56d939(0xff)]()})}}),await this[_0x56d939(0xde)](_0x52200a,_0x1b9b87[_0x56d939(0x106)],_0x1b9b87['transactionId'],_0x1b9b87['failureReason']),await this[_0x56d939(0xef)](_0x52200a,_0x1b9b87[_0x56d939(0x106)]),console[_0x56d939(0xec)](_0x56d939(0x11d)+_0x1e9392+'\x20processed:\x20'+_0x1b9b87['status']),_0x1b9b87['status']===_0x56d939(0x108)?_0x3f4812[_0x56d939(0xf3)]({'success':!![],'message':_0x56d939(0x109),'result':{'status':'PAID','transactionId':_0x1b9b87[_0x56d939(0xc2)],'redirectUrl':_0x52200a[_0x56d939(0x104)]}}):_0x3f4812[_0x56d939(0x106)](0x190)[_0x56d939(0xf3)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x56d939(0xe8),'failureReason':_0x1b9b87[_0x56d939(0xd7)],'redirectUrl':_0x52200a[_0x56d939(0xd6)]}});}catch(_0x5edc0c){_0x4ceef9(_0x5edc0c);}},this[_0x58bd41(0x101)]=new testGatewayService_1['TestGatewayService'](),this[_0x58bd41(0x105)]=new webhookService_1[(_0x58bd41(0xb2))]();}async['sendShopWebhook'](_0x4defe1,_0xe9df54,_0x4d3b95,_0x3ccdb8){const _0x5dcfee=a13_0x4ec456,_0x3328fc=Date[_0x5dcfee(0xe2)]();try{const _0x397c5a=_0x4defe1['shop'],_0x43b1d6=_0x397c5a[_0x5dcfee(0xda)];if(!_0x43b1d6?.['webhookUrl']){console[_0x5dcfee(0xec)](_0x5dcfee(0xf7)+_0x397c5a['id']);return;}const _0x26fb28=_0xe9df54==='PAID'?_0x5dcfee(0x11a):_0x5dcfee(0x10c);let _0x47d73d=[];if(_0x43b1d6[_0x5dcfee(0xdd)])try{_0x47d73d=Array[_0x5dcfee(0xb4)](_0x43b1d6['webhookEvents'])?_0x43b1d6['webhookEvents']:JSON[_0x5dcfee(0xf8)](_0x43b1d6[_0x5dcfee(0xdd)]);}catch(_0x119431){console['error'](_0x5dcfee(0x119),_0x119431),_0x47d73d=[];}if(!_0x47d73d['includes'](_0x26fb28)){console['log']('Webhook\x20event\x20'+_0x26fb28+'\x20not\x20enabled\x20for\x20shop\x20'+_0x397c5a['id']);return;}const _0x204839={'event':_0x26fb28,'payment':{'id':_0x4defe1['id'],'order_id':_0x4defe1[_0x5dcfee(0x112)],'gateway_order_id':_0x4defe1[_0x5dcfee(0xdb)],'gateway':_0x5dcfee(0xfd),'amount':_0x4defe1['amount'],'currency':_0x4defe1[_0x5dcfee(0xb9)],'status':_0xe9df54[_0x5dcfee(0x11f)](),'customer_email':_0x4defe1[_0x5dcfee(0x129)],'customer_name':_0x4defe1[_0x5dcfee(0xeb)],'transaction_id':_0x4d3b95,'failure_message':_0x3ccdb8,'created_at':_0x4defe1[_0x5dcfee(0xcb)],'updated_at':new Date()}},_0x213d22=await fetch(_0x43b1d6[_0x5dcfee(0x12b)],{'method':_0x5dcfee(0x122),'headers':{'Content-Type':_0x5dcfee(0x114),'User-Agent':_0x5dcfee(0xdf)},'body':JSON[_0x5dcfee(0x125)](_0x204839)}),_0x5a6ee3=Date[_0x5dcfee(0xe2)]()-_0x3328fc;console[_0x5dcfee(0xec)](_0x5dcfee(0xe5)+_0x43b1d6[_0x5dcfee(0x12b)]+_0x5dcfee(0x128)+_0x213d22[_0x5dcfee(0x106)]+'\x20('+_0x5a6ee3+'ms)');}catch(_0xea7b7c){console[_0x5dcfee(0x10f)](_0x5dcfee(0xb5),_0xea7b7c);}}async['sendPaymentStatusNotification'](_0xc7d9f5,_0x288fa0){const _0x46f35d=a13_0x4ec456;try{const {telegramBotService:_0x435418}=await Promise[_0x46f35d(0xc6)]()[_0x46f35d(0x11c)](()=>__importStar(require(_0x46f35d(0xf0)))),_0x289064={'PAID':_0x46f35d(0xfb),'FAILED':_0x46f35d(0xca)},_0x3c5b96=_0x289064[_0x288fa0];if(!_0x3c5b96)return;await _0x435418[_0x46f35d(0xfc)](_0xc7d9f5[_0x46f35d(0xbb)],_0xc7d9f5,_0x3c5b96);}catch(_0xfce096){console[_0x46f35d(0x10f)](_0x46f35d(0xc5),_0xfce096);}}}exports[a13_0x4ec456(0xc1)]=TestGatewayController;function a13_0x3c03(){const _0x2be3c0=['payment.failed',',\x20status=','create','error','processCardPayment','\x20not\x20found','orderId','Any\x20future\x20date\x20(MM/YY)','application/json','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','22864wcEzCq','getOwnPropertyNames','paymentLink','Error\x20parsing\x20webhook\x20events:','payment.success','update','then','✅\x20Test\x20Gateway\x20payment\x20','writable','toLowerCase','__esModule','157680eSodra','POST','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','9veASFu','stringify','Any\x20other\x20card\x20number','PENDING','\x20with\x20status\x20','customerEmail','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','webhookUrl','paidAt','Payment\x20to\x20','📈\x20Found\x20payment\x20link\x20','📈\x20Test\x20Gateway:\x20Payment\x20','paymentLinkId','WebhookService','1386155dTbUSB','isArray','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','2034404rFEuWJ','getOwnPropertyDescriptor','Any\x20name','currency','getPaymentForm','shopId','length','test_gateway','currentPayments','cardLast4','paymentMethod','TestGatewayController','transactionId','name','get','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','resolve','Payment\x20not\x20found','489GKBbTi','../services/gateways/testGatewayService','failed','createdAt','Payment\x20is\x20not\x20for\x20test\x20gateway','amount','2177vfUfuk','replace','18342DtqgxE','test_gateway_','failureMessage','default','webhookLog','__setModuleDefault','failUrl','failureReason','544980RKEmUr','slice','settings','gatewayOrderId',',\x20cannot\x20process','webhookEvents','sendShopWebhook','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','shop','findUnique','now','\x20updated:\x20currentPayments=','\x20->\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','type','429mtXEuP','FAILED','test_card','❌\x20Payment\x20link\x20','customerName','log','defineProperty','call','sendPaymentStatusNotification','../services/telegramBotService','__importDefault','Payment\x20status\x20is\x20','json','COMPLETED','4242\x204242\x204242\x204242','body','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','parse','gateway','gatewayPaymentId','paid','sendPaymentNotification','0000','✅\x20Payment\x20link\x20','toISOString','params','testGatewayService',',\x20currentPayments=','$transaction','successUrl','webhookService','status','9122HIiogh','PAID','Payment\x20processed\x20successfully','payment','prototype'];a13_0x3c03=function(){return _0x2be3c0;};return a13_0x3c03();}