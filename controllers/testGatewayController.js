'use strict';const a13_0x50fcb0=a13_0x5100;function a13_0x10a1(){const _0xce1033=['WebhookService','0000','create','__importDefault','__esModule','Any\x203-4\x20digits','Any\x20other\x20card\x20number','sendShopWebhook','gatewayOrderId','then','getPaymentForm','\x20processed:\x20','settings','name','cardNumber','sendPaymentNotification','Error\x20parsing\x20webhook\x20events:','error','../config/database','Any\x20future\x20date\x20(MM/YY)','customerEmail','PENDING','length','sendPaymentStatusNotification','default','testGatewayService','__createBinding','cardLast4','91892QPsaMp','TestGatewayService','1986424MgcsFb','currency','shop','json','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processCardPayment','prototype','toLowerCase','ðŸ§ª\x20Test\x20Gateway\x20result:','Test\x20Gateway\x20webhook\x20sent\x20to\x20','2545020JtlLFL','TestGatewayController','Payment\x20failed','parse','toISOString','getOwnPropertyNames','webhookEvents','test_card','hasOwnProperty','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failureMessage','status','../services/gateways/testGatewayService','4242\x204242\x204242\x204242','shopId','webhookUrl','params','log','successUrl','Payment\x20status\x20is\x20','Webhook\x20event\x20','paid','1310820xeUQPx','failUrl','9247XuJYEp','replace','slice','../services/telegramBotService','resolve','../services/webhookService','5758784OehJLz','stringify','PAID','payment','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','amount','orderId','test_gateway','isArray','customerName','2893293CBIOkH','__importStar','configurable','createdAt','\x20with\x20status\x20','paidAt','Payment\x20not\x20found','failureReason','get','13768rBjKod','Any\x20name','defineProperty','Payment\x20is\x20not\x20for\x20test\x20gateway','FAILED',',\x20cannot\x20process','findUnique','POST','Payment\x20to\x20','test_gateway_','gateway','âœ…\x20Test\x20Gateway\x20payment\x20','transactionId'];a13_0x10a1=function(){return _0xce1033;};return a13_0x10a1();}function a13_0x5100(_0x44ba2e,_0x36f77d){const _0x10a12c=a13_0x10a1();return a13_0x5100=function(_0x5100a9,_0xf520f3){_0x5100a9=_0x5100a9-0x14e;let _0x449d08=_0x10a12c[_0x5100a9];return _0x449d08;},a13_0x5100(_0x44ba2e,_0x36f77d);}(function(_0x5ee374,_0x3a8787){const _0x2e1b9f=a13_0x5100,_0x1687a8=_0x5ee374();while(!![]){try{const _0x41cdcd=-parseInt(_0x2e1b9f(0x19f))/0x1+parseInt(_0x2e1b9f(0x1a1))/0x2+parseInt(_0x2e1b9f(0x16d))/0x3+parseInt(_0x2e1b9f(0x163))/0x4+-parseInt(_0x2e1b9f(0x1ab))/0x5+parseInt(_0x2e1b9f(0x15b))/0x6+-parseInt(_0x2e1b9f(0x15d))/0x7*(parseInt(_0x2e1b9f(0x176))/0x8);if(_0x41cdcd===_0x3a8787)break;else _0x1687a8['push'](_0x1687a8['shift']());}catch(_0x20c254){_0x1687a8['push'](_0x1687a8['shift']());}}}(a13_0x10a1,0xb5060));var __createBinding=this&&this[a13_0x50fcb0(0x19d)]||(Object['create']?function(_0x1af7bc,_0xdda6ac,_0x1a98fc,_0x22dec4){const _0x37d805=a13_0x50fcb0;if(_0x22dec4===undefined)_0x22dec4=_0x1a98fc;var _0xe7372e=Object['getOwnPropertyDescriptor'](_0xdda6ac,_0x1a98fc);(!_0xe7372e||(_0x37d805(0x175)in _0xe7372e?!_0xdda6ac['__esModule']:_0xe7372e['writable']||_0xe7372e[_0x37d805(0x16f)]))&&(_0xe7372e={'enumerable':!![],'get':function(){return _0xdda6ac[_0x1a98fc];}}),Object[_0x37d805(0x178)](_0x1af7bc,_0x22dec4,_0xe7372e);}:function(_0x3ed172,_0x364bf2,_0x3ddb8c,_0x5de556){if(_0x5de556===undefined)_0x5de556=_0x3ddb8c;_0x3ed172[_0x5de556]=_0x364bf2[_0x3ddb8c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x50fcb0(0x185)]?function(_0x26e810,_0x423a80){const _0x2f1447=a13_0x50fcb0;Object[_0x2f1447(0x178)](_0x26e810,'default',{'enumerable':!![],'value':_0x423a80});}:function(_0x551976,_0x378156){_0x551976['default']=_0x378156;}),__importStar=this&&this[a13_0x50fcb0(0x16e)]||(function(){var _0x50ac9b=function(_0x2cf1b5){const _0x41f564=a13_0x5100;return _0x50ac9b=Object[_0x41f564(0x1b0)]||function(_0x2b2464){const _0x569689=_0x41f564;var _0x2ffdae=[];for(var _0x997ad9 in _0x2b2464)if(Object[_0x569689(0x1a7)][_0x569689(0x1b3)]['call'](_0x2b2464,_0x997ad9))_0x2ffdae[_0x2ffdae[_0x569689(0x199)]]=_0x997ad9;return _0x2ffdae;},_0x50ac9b(_0x2cf1b5);};return function(_0x3100b1){const _0x4aeff2=a13_0x5100;if(_0x3100b1&&_0x3100b1[_0x4aeff2(0x187)])return _0x3100b1;var _0x2f28d1={};if(_0x3100b1!=null){for(var _0x3b60c6=_0x50ac9b(_0x3100b1),_0x5a56d7=0x0;_0x5a56d7<_0x3b60c6[_0x4aeff2(0x199)];_0x5a56d7++)if(_0x3b60c6[_0x5a56d7]!==_0x4aeff2(0x19b))__createBinding(_0x2f28d1,_0x3100b1,_0x3b60c6[_0x5a56d7]);}return __setModuleDefault(_0x2f28d1,_0x3100b1),_0x2f28d1;};}()),__importDefault=this&&this[a13_0x50fcb0(0x186)]||function(_0x3e02a0){const _0x1062a8=a13_0x50fcb0;return _0x3e02a0&&_0x3e02a0[_0x1062a8(0x187)]?_0x3e02a0:{'default':_0x3e02a0};};Object[a13_0x50fcb0(0x178)](exports,a13_0x50fcb0(0x187),{'value':!![]}),exports[a13_0x50fcb0(0x1ac)]=void 0x0;const testGatewayService_1=require(a13_0x50fcb0(0x151)),webhookService_1=require(a13_0x50fcb0(0x162)),database_1=__importDefault(require(a13_0x50fcb0(0x195)));class TestGatewayController{constructor(){const _0x52239c=a13_0x50fcb0;this[_0x52239c(0x18d)]=async(_0xd157a1,_0x36ffa8,_0x318642)=>{const _0x61b1fb=_0x52239c;try{const {paymentId:_0x58027d}=_0xd157a1[_0x61b1fb(0x155)];console[_0x61b1fb(0x156)](_0x61b1fb(0x14e)+_0x58027d);const _0x406331=await database_1[_0x61b1fb(0x19b)][_0x61b1fb(0x166)][_0x61b1fb(0x17c)]({'where':{'id':_0x58027d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x406331)return _0x36ffa8[_0x61b1fb(0x150)](0x194)[_0x61b1fb(0x1a4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x406331[_0x61b1fb(0x180)]!==_0x61b1fb(0x16a))return _0x36ffa8[_0x61b1fb(0x150)](0x190)[_0x61b1fb(0x1a4)]({'success':![],'message':_0x61b1fb(0x179)});if(_0x406331['status']!==_0x61b1fb(0x198))return _0x36ffa8[_0x61b1fb(0x150)](0x190)['json']({'success':![],'message':_0x61b1fb(0x158)+_0x406331[_0x61b1fb(0x150)]+_0x61b1fb(0x17b)});_0x36ffa8[_0x61b1fb(0x1a4)]({'success':!![],'result':{'paymentId':_0x406331['id'],'orderId':_0x406331['gatewayOrderId'],'amount':_0x406331[_0x61b1fb(0x168)],'currency':_0x406331[_0x61b1fb(0x1a2)],'merchantName':_0x406331['shop']['name'],'description':_0x61b1fb(0x17e)+_0x406331[_0x61b1fb(0x1a3)][_0x61b1fb(0x190)],'testInstructions':{'successCard':_0x61b1fb(0x152),'failureCard':_0x61b1fb(0x189),'expiryDate':_0x61b1fb(0x196),'cvc':_0x61b1fb(0x188),'holderName':_0x61b1fb(0x177)}}});}catch(_0xa12f7c){_0x318642(_0xa12f7c);}},this['processCard']=async(_0x4b2b2c,_0x2d63f4,_0x1dfa77)=>{const _0x589884=_0x52239c;try{const {paymentId:_0x435eac}=_0x4b2b2c['params'],_0x4d0092=_0x4b2b2c['body'];console[_0x589884(0x156)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x435eac);const _0xfb5666=await database_1[_0x589884(0x19b)]['payment'][_0x589884(0x17c)]({'where':{'id':_0x435eac},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xfb5666)return _0x2d63f4['status'](0x194)[_0x589884(0x1a4)]({'success':![],'message':_0x589884(0x173)});if(_0xfb5666[_0x589884(0x180)]!=='test_gateway')return _0x2d63f4[_0x589884(0x150)](0x190)['json']({'success':![],'message':_0x589884(0x179)});if(_0xfb5666[_0x589884(0x150)]!==_0x589884(0x198))return _0x2d63f4[_0x589884(0x150)](0x190)['json']({'success':![],'message':_0x589884(0x158)+_0xfb5666['status']+_0x589884(0x17b)});const _0x2227d5=await this[_0x589884(0x19c)][_0x589884(0x1a6)]({'paymentId':_0xfb5666['id'],'orderId':_0xfb5666['gatewayOrderId']||_0xfb5666['id'],'amount':_0xfb5666[_0x589884(0x168)],'currency':_0xfb5666['currency'],'cardData':_0x4d0092});console[_0x589884(0x156)](_0x589884(0x1a9),_0x2227d5);const _0x223b9c={'status':_0x2227d5[_0x589884(0x150)],'updatedAt':new Date()};if(_0x2227d5[_0x589884(0x150)]===_0x589884(0x165))_0x223b9c[_0x589884(0x172)]=new Date(),_0x223b9c['gatewayPaymentId']=_0x2227d5['transactionId'];else _0x2227d5[_0x589884(0x150)]===_0x589884(0x17a)&&(_0x223b9c[_0x589884(0x14f)]=_0x2227d5[_0x589884(0x174)]);const _0x1aebf7=_0x4d0092[_0x589884(0x191)][_0x589884(0x15e)](/[\s-]/g,'');_0x223b9c[_0x589884(0x19e)]=_0x1aebf7[_0x589884(0x15f)](-0x4),_0x223b9c['paymentMethod']=_0x589884(0x1b2),await database_1[_0x589884(0x19b)][_0x589884(0x166)]['update']({'where':{'id':_0xfb5666['id']},'data':_0x223b9c}),await database_1[_0x589884(0x19b)]['webhookLog'][_0x589884(0x185)]({'data':{'paymentId':_0xfb5666['id'],'shopId':_0xfb5666['shopId'],'event':_0x589884(0x17f)+_0x2227d5[_0x589884(0x150)][_0x589884(0x1a8)](),'statusCode':0xc8,'responseBody':JSON[_0x589884(0x164)]({'oldStatus':'PENDING','newStatus':_0x2227d5[_0x589884(0x150)],'transactionId':_0x2227d5[_0x589884(0x182)],'failureReason':_0x2227d5[_0x589884(0x174)],'processedAt':new Date()[_0x589884(0x1af)]()})}}),await this[_0x589884(0x18a)](_0xfb5666,_0x2227d5[_0x589884(0x150)],_0x2227d5[_0x589884(0x182)],_0x2227d5[_0x589884(0x174)]),await this['sendPaymentStatusNotification'](_0xfb5666,_0x2227d5[_0x589884(0x150)]),console[_0x589884(0x156)](_0x589884(0x181)+_0x435eac+_0x589884(0x18e)+_0x2227d5['status']),_0x2227d5['status']===_0x589884(0x165)?_0x2d63f4[_0x589884(0x1a4)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x589884(0x165),'transactionId':_0x2227d5[_0x589884(0x182)],'redirectUrl':_0xfb5666[_0x589884(0x157)]}}):_0x2d63f4[_0x589884(0x150)](0x190)['json']({'success':![],'message':_0x589884(0x1ad),'result':{'status':'FAILED','failureReason':_0x2227d5[_0x589884(0x174)],'redirectUrl':_0xfb5666[_0x589884(0x15c)]}});}catch(_0x5af8bd){_0x1dfa77(_0x5af8bd);}},this[_0x52239c(0x19c)]=new testGatewayService_1[(_0x52239c(0x1a0))](),this['webhookService']=new webhookService_1[(_0x52239c(0x183))]();}async[a13_0x50fcb0(0x18a)](_0x473f49,_0x336a1b,_0x54605c,_0x57e9ad){const _0x1960e2=a13_0x50fcb0,_0x233709=Date['now']();try{const _0x3a3f86=_0x473f49['shop'],_0xbbe7d5=_0x3a3f86[_0x1960e2(0x18f)];if(!_0xbbe7d5?.[_0x1960e2(0x154)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3a3f86['id']);return;}const _0x53cef4=_0x336a1b===_0x1960e2(0x165)?'payment.success':'payment.failed';let _0x4b1b18=[];if(_0xbbe7d5[_0x1960e2(0x1b1)])try{_0x4b1b18=Array[_0x1960e2(0x16b)](_0xbbe7d5['webhookEvents'])?_0xbbe7d5['webhookEvents']:JSON[_0x1960e2(0x1ae)](_0xbbe7d5[_0x1960e2(0x1b1)]);}catch(_0x58a5db){console[_0x1960e2(0x194)](_0x1960e2(0x193),_0x58a5db),_0x4b1b18=[];}if(!_0x4b1b18['includes'](_0x53cef4)){console['log'](_0x1960e2(0x159)+_0x53cef4+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3a3f86['id']);return;}const _0x4ea34f={'event':_0x53cef4,'payment':{'id':_0x473f49['id'],'order_id':_0x473f49[_0x1960e2(0x169)],'gateway_order_id':_0x473f49[_0x1960e2(0x18b)],'gateway':_0x1960e2(0x184),'amount':_0x473f49['amount'],'currency':_0x473f49[_0x1960e2(0x1a2)],'status':_0x336a1b[_0x1960e2(0x1a8)](),'customer_email':_0x473f49[_0x1960e2(0x197)],'customer_name':_0x473f49[_0x1960e2(0x16c)],'transaction_id':_0x54605c,'failure_message':_0x57e9ad,'created_at':_0x473f49[_0x1960e2(0x170)],'updated_at':new Date()}},_0x573ba6=await fetch(_0xbbe7d5[_0x1960e2(0x154)],{'method':_0x1960e2(0x17d),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x1960e2(0x164)](_0x4ea34f)}),_0x310444=Date['now']()-_0x233709;console[_0x1960e2(0x156)](_0x1960e2(0x1aa)+_0xbbe7d5[_0x1960e2(0x154)]+_0x1960e2(0x171)+_0x573ba6[_0x1960e2(0x150)]+'\x20('+_0x310444+'ms)');}catch(_0xd01fa9){console[_0x1960e2(0x194)](_0x1960e2(0x167),_0xd01fa9);}}async[a13_0x50fcb0(0x19a)](_0x2af197,_0x670627){const _0xa5ee2e=a13_0x50fcb0;try{const {telegramBotService:_0xc68544}=await Promise[_0xa5ee2e(0x161)]()[_0xa5ee2e(0x18c)](()=>__importStar(require(_0xa5ee2e(0x160)))),_0x730725={'PAID':_0xa5ee2e(0x15a),'FAILED':'failed'},_0x2551ae=_0x730725[_0x670627];if(!_0x2551ae)return;await _0xc68544[_0xa5ee2e(0x192)](_0x2af197[_0xa5ee2e(0x153)],_0x2af197,_0x2551ae);}catch(_0xdc9f2a){console[_0xa5ee2e(0x194)](_0xa5ee2e(0x1a5),_0xdc9f2a);}}}exports[a13_0x50fcb0(0x1ac)]=TestGatewayController;