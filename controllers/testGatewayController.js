'use strict';function a21_0x29eb(){const _0x4fe6d6=['__esModule','__setModuleDefault','4242\x204242\x204242\x204242','Payment\x20processed\x20successfully','shopId','\x20updated:\x20currentPayments=','createHmac','Payment\x20not\x20found','Any\x20future\x20date\x20(MM/YY)','83833kisFqA','598692DlZAsU','COMPLETED','18642DVvQQt','cardLast4','__createBinding','webhookUrl','status','üß™\x20Sending\x20webhook\x20to\x20','‚úÖ\x20Payment\x20link\x20','currency','prototype','payment.success','parse','11zyKIrz','digest','failUrl','FAILED','sendPaymentNotification','Payment\x20System/1.0\x20(Test\x20Gateway)','\x20processed:\x20','includes','Error\x20parsing\x20webhook\x20events:','POST','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','__importStar','üß™\x20Test\x20Gateway:\x20Sending\x20webhook\x20for\x20status\x20','591672GcXZrr','__importDefault','üß™\x20Test\x20Gateway:\x20Telegram\x20notification\x20sent\x20for\x20status\x20','configured','writable','transactionId','then','test_card','‚úÖ\x20Test\x20Gateway\x20webhook\x20sent\x20to\x20','name','json','webhookLog','orderId',',\x20status=','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20not\x20found','2859424zDAPcW','payment.failed','TestGatewayController','isArray','üìà\x20Test\x20Gateway:\x20Payment\x20','18DFLRAV','üìà\x20Found\x20payment\x20link\x20','amount','sendShopWebhook','...','\x20->\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','error','create','call','üß™\x20Test\x20Gateway\x20result:','18WQbtAD','paymentMethod',':\x20type=','ms)','webhookService','WebhookService','slice','shop','Payment\x20to\x20',',\x20cannot\x20process','cardNumber','Any\x20other\x20card\x20number','application/json','length','failureMessage','Any\x203-4\x20digits','payment','successUrl','defineProperty','Payment\x20status\x20is\x20','stringify','currentPayments','now','failureReason','getOwnPropertyNames','default','findUnique','gatewayPaymentId','get','PENDING','1841XPmXRe','test_gateway','gatewayOrderId','üß™\x20Webhook\x20payload:','paymentLinkId','0000','type','webhookEvents','gateway','not\x20configured','10330pptmKp','‚ö†Ô∏è\x20Webhook\x20event\x20','SINGLE','../services/gateways/testGatewayService',',\x20webhookUrl=','paid','Payment\x20is\x20not\x20for\x20test\x20gateway','\x20with\x20status\x20','update','\x20not\x20enabled\x20for\x20shop\x20','852pTzjnm','createdAt','log','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PAID','params','sendPaymentStatusNotification','8085340aFTmTl','üß™\x20Test\x20Gateway:\x20enabled\x20webhook\x20events:','toLowerCase','paidAt','replace','testGatewayService','hex'];a21_0x29eb=function(){return _0x4fe6d6;};return a21_0x29eb();}const a21_0x206f7e=a21_0x2894;(function(_0x53a35c,_0x55126e){const _0x36bbb0=a21_0x2894,_0x2c3d7f=_0x53a35c();while(!![]){try{const _0x5b7686=-parseInt(_0x36bbb0(0x103))/0x1*(parseInt(_0x36bbb0(0xba))/0x2)+-parseInt(_0x36bbb0(0x11e))/0x3+parseInt(_0x36bbb0(0xec))/0x4*(parseInt(_0x36bbb0(0xe2))/0x5)+-parseInt(_0x36bbb0(0x106))/0x6*(-parseInt(_0x36bbb0(0xd8))/0x7)+-parseInt(_0x36bbb0(0xaa))/0x8*(parseInt(_0x36bbb0(0xaf))/0x9)+parseInt(_0x36bbb0(0xf3))/0xa+-parseInt(_0x36bbb0(0x111))/0xb*(-parseInt(_0x36bbb0(0x104))/0xc);if(_0x5b7686===_0x55126e)break;else _0x2c3d7f['push'](_0x2c3d7f['shift']());}catch(_0x35dfd5){_0x2c3d7f['push'](_0x2c3d7f['shift']());}}}(a21_0x29eb,0x6da17));var __createBinding=this&&this[a21_0x206f7e(0x108)]||(Object[a21_0x206f7e(0xb7)]?function(_0xc979d7,_0x2b2d8b,_0x2cb46e,_0x54685d){const _0x440999=a21_0x206f7e;if(_0x54685d===undefined)_0x54685d=_0x2cb46e;var _0x323372=Object['getOwnPropertyDescriptor'](_0x2b2d8b,_0x2cb46e);(!_0x323372||(_0x440999(0xd6)in _0x323372?!_0x2b2d8b[_0x440999(0xfa)]:_0x323372[_0x440999(0x9e)]||_0x323372['configurable']))&&(_0x323372={'enumerable':!![],'get':function(){return _0x2b2d8b[_0x2cb46e];}}),Object[_0x440999(0xcc)](_0xc979d7,_0x54685d,_0x323372);}:function(_0x16af88,_0x51fb13,_0x244a39,_0x263848){if(_0x263848===undefined)_0x263848=_0x244a39;_0x16af88[_0x263848]=_0x51fb13[_0x244a39];}),__setModuleDefault=this&&this[a21_0x206f7e(0xfb)]||(Object['create']?function(_0x36a4e8,_0x1e3bea){const _0x2b70bc=a21_0x206f7e;Object[_0x2b70bc(0xcc)](_0x36a4e8,_0x2b70bc(0xd3),{'enumerable':!![],'value':_0x1e3bea});}:function(_0x5ab5a0,_0x11b8e2){const _0x58567c=a21_0x206f7e;_0x5ab5a0[_0x58567c(0xd3)]=_0x11b8e2;}),__importStar=this&&this[a21_0x206f7e(0x11c)]||(function(){var _0x1057db=function(_0x5f9f37){const _0x6a3b27=a21_0x2894;return _0x1057db=Object[_0x6a3b27(0xd2)]||function(_0x500c1e){const _0x21b1aa=_0x6a3b27;var _0x1b8f95=[];for(var _0x5ad728 in _0x500c1e)if(Object[_0x21b1aa(0x10e)]['hasOwnProperty'][_0x21b1aa(0xb8)](_0x500c1e,_0x5ad728))_0x1b8f95[_0x1b8f95[_0x21b1aa(0xc7)]]=_0x5ad728;return _0x1b8f95;},_0x1057db(_0x5f9f37);};return function(_0x254a08){const _0xca7592=a21_0x2894;if(_0x254a08&&_0x254a08[_0xca7592(0xfa)])return _0x254a08;var _0x114592={};if(_0x254a08!=null){for(var _0x50500f=_0x1057db(_0x254a08),_0x45f9a8=0x0;_0x45f9a8<_0x50500f[_0xca7592(0xc7)];_0x45f9a8++)if(_0x50500f[_0x45f9a8]!==_0xca7592(0xd3))__createBinding(_0x114592,_0x254a08,_0x50500f[_0x45f9a8]);}return __setModuleDefault(_0x114592,_0x254a08),_0x114592;};}()),__importDefault=this&&this[a21_0x206f7e(0x11f)]||function(_0x2a5b04){return _0x2a5b04&&_0x2a5b04['__esModule']?_0x2a5b04:{'default':_0x2a5b04};};Object[a21_0x206f7e(0xcc)](exports,'__esModule',{'value':!![]}),exports[a21_0x206f7e(0xac)]=void 0x0;function a21_0x2894(_0x3cec05,_0x3d54ea){_0x3cec05=_0x3cec05-0x9e;const _0x29eb31=a21_0x29eb();let _0x28941f=_0x29eb31[_0x3cec05];return _0x28941f;}const crypto_1=__importDefault(require('crypto')),testGatewayService_1=require(a21_0x206f7e(0xe5)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x3f22a3=a21_0x206f7e;this['getPaymentForm']=async(_0x566bb8,_0x34f0bf,_0x4897f)=>{const _0xb2903d=a21_0x2894;try{const {paymentId:_0x5a44b6}=_0x566bb8[_0xb2903d(0xf1)];console[_0xb2903d(0xee)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x5a44b6);const _0x3b3f18=await database_1[_0xb2903d(0xd3)]['payment'][_0xb2903d(0xd4)]({'where':{'id':_0x5a44b6},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3b3f18)return _0x34f0bf[_0xb2903d(0x10a)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x3b3f18[_0xb2903d(0xe0)]!==_0xb2903d(0xd9))return _0x34f0bf['status'](0x190)[_0xb2903d(0xa4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3b3f18['status']!==_0xb2903d(0xd7))return _0x34f0bf[_0xb2903d(0x10a)](0x190)['json']({'success':![],'message':_0xb2903d(0xcd)+_0x3b3f18[_0xb2903d(0x10a)]+_0xb2903d(0xc3)});_0x34f0bf[_0xb2903d(0xa4)]({'success':!![],'result':{'paymentId':_0x3b3f18['id'],'orderId':_0x3b3f18[_0xb2903d(0xda)],'amount':_0x3b3f18[_0xb2903d(0xb1)],'currency':_0x3b3f18['currency'],'merchantName':_0x3b3f18[_0xb2903d(0xc1)][_0xb2903d(0xa3)],'description':_0xb2903d(0xc2)+_0x3b3f18[_0xb2903d(0xc1)][_0xb2903d(0xa3)],'testInstructions':{'successCard':_0xb2903d(0xfc),'failureCard':_0xb2903d(0xc5),'expiryDate':_0xb2903d(0x102),'cvc':_0xb2903d(0xc9),'holderName':'Any\x20name'}}});}catch(_0x544b8b){_0x4897f(_0x544b8b);}},this['processCard']=async(_0x3506c2,_0x585905,_0x9e3ac5)=>{const _0xd4b2fe=a21_0x2894;try{const {paymentId:_0x803633}=_0x3506c2[_0xd4b2fe(0xf1)],_0x106c5e=_0x3506c2['body'];console[_0xd4b2fe(0xee)](_0xd4b2fe(0x11b)+_0x803633);const _0x18af2b=await database_1[_0xd4b2fe(0xd3)][_0xd4b2fe(0xca)][_0xd4b2fe(0xd4)]({'where':{'id':_0x803633},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x18af2b)return _0x585905[_0xd4b2fe(0x10a)](0x194)[_0xd4b2fe(0xa4)]({'success':![],'message':_0xd4b2fe(0x101)});if(_0x18af2b['gateway']!==_0xd4b2fe(0xd9))return _0x585905[_0xd4b2fe(0x10a)](0x190)[_0xd4b2fe(0xa4)]({'success':![],'message':_0xd4b2fe(0xe8)});if(_0x18af2b[_0xd4b2fe(0x10a)]!==_0xd4b2fe(0xd7))return _0x585905[_0xd4b2fe(0x10a)](0x190)[_0xd4b2fe(0xa4)]({'success':![],'message':_0xd4b2fe(0xcd)+_0x18af2b[_0xd4b2fe(0x10a)]+_0xd4b2fe(0xc3)});const _0x2856d8=await this['testGatewayService']['processCardPayment']({'paymentId':_0x18af2b['id'],'orderId':_0x18af2b[_0xd4b2fe(0xda)]||_0x18af2b['id'],'amount':_0x18af2b[_0xd4b2fe(0xb1)],'currency':_0x18af2b[_0xd4b2fe(0x10d)],'cardData':_0x106c5e});console[_0xd4b2fe(0xee)](_0xd4b2fe(0xb9),_0x2856d8);const _0x25701b={'status':_0x2856d8['status'],'updatedAt':new Date()};if(_0x2856d8[_0xd4b2fe(0x10a)]===_0xd4b2fe(0xf0))_0x25701b[_0xd4b2fe(0xf6)]=new Date(),_0x25701b[_0xd4b2fe(0xd5)]=_0x2856d8[_0xd4b2fe(0x9f)];else _0x2856d8['status']===_0xd4b2fe(0x114)&&(_0x25701b[_0xd4b2fe(0xc8)]=_0x2856d8['failureReason']);const _0x575855=_0x106c5e[_0xd4b2fe(0xc4)][_0xd4b2fe(0xf7)](/[\s-]/g,'');_0x25701b[_0xd4b2fe(0x107)]=_0x575855[_0xd4b2fe(0xc0)](-0x4),_0x25701b[_0xd4b2fe(0xbb)]=_0xd4b2fe(0xa1),await database_1['default'][_0xd4b2fe(0xca)][_0xd4b2fe(0xea)]({'where':{'id':_0x18af2b['id']},'data':_0x25701b});if(_0x2856d8[_0xd4b2fe(0x10a)]===_0xd4b2fe(0xf0)&&_0x18af2b['paymentLinkId']){console['log'](_0xd4b2fe(0xae)+_0x18af2b['id']+_0xd4b2fe(0xb5));try{await database_1[_0xd4b2fe(0xd3)]['$transaction'](async _0x46589e=>{const _0x5e214d=_0xd4b2fe,_0x555113=await _0x46589e['paymentLink']['findUnique']({'where':{'id':_0x18af2b[_0x5e214d(0xdc)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x555113){console[_0x5e214d(0xee)](_0x5e214d(0xb0)+_0x555113['id']+_0x5e214d(0xbc)+_0x555113[_0x5e214d(0xde)]+',\x20currentPayments='+_0x555113['currentPayments']+_0x5e214d(0xa7)+_0x555113[_0x5e214d(0x10a)]);const _0x267609=_0x555113[_0x5e214d(0xcf)]+0x1,_0x26c149=_0x555113['type']===_0x5e214d(0xe4)?_0x5e214d(0x105):_0x555113[_0x5e214d(0x10a)];await _0x46589e['paymentLink']['update']({'where':{'id':_0x18af2b['paymentLinkId']},'data':{'currentPayments':_0x267609,'status':_0x26c149,'updatedAt':new Date()}}),console[_0x5e214d(0xee)](_0x5e214d(0x10c)+_0x555113['id']+_0x5e214d(0xff)+_0x555113['currentPayments']+_0x5e214d(0xb4)+_0x267609+_0x5e214d(0xa7)+_0x555113[_0x5e214d(0x10a)]+_0x5e214d(0xb4)+_0x26c149);}else console['log']('‚ùå\x20Payment\x20link\x20'+_0x18af2b[_0x5e214d(0xdc)]+_0x5e214d(0xa9));});}catch(_0x5baa1d){console[_0xd4b2fe(0xb6)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x5baa1d);}}await database_1[_0xd4b2fe(0xd3)][_0xd4b2fe(0xa5)][_0xd4b2fe(0xb7)]({'data':{'paymentId':_0x18af2b['id'],'shopId':_0x18af2b[_0xd4b2fe(0xfe)],'event':'test_gateway_'+_0x2856d8[_0xd4b2fe(0x10a)][_0xd4b2fe(0xf5)](),'statusCode':_0x2856d8['status']===_0xd4b2fe(0xf0)?0xc8:0x190,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x2856d8[_0xd4b2fe(0x10a)],'transactionId':_0x2856d8[_0xd4b2fe(0x9f)],'failureReason':_0x2856d8[_0xd4b2fe(0xd1)],'processedAt':new Date()['toISOString']()})}}),console[_0xd4b2fe(0xee)](_0xd4b2fe(0x11d)+_0x2856d8['status']+_0xd4b2fe(0xb3)),await this[_0xd4b2fe(0xb2)](_0x18af2b,_0x2856d8[_0xd4b2fe(0x10a)],_0x2856d8['transactionId'],_0x2856d8[_0xd4b2fe(0xd1)]),console[_0xd4b2fe(0xee)]('üß™\x20Test\x20Gateway:\x20Webhook\x20sent\x20for\x20status\x20'+_0x2856d8[_0xd4b2fe(0x10a)]),console[_0xd4b2fe(0xee)]('üß™\x20Test\x20Gateway:\x20Sending\x20Telegram\x20notification\x20for\x20status\x20'+_0x2856d8[_0xd4b2fe(0x10a)]+'...'),await this['sendPaymentStatusNotification'](_0x18af2b,_0x2856d8[_0xd4b2fe(0x10a)]),console['log'](_0xd4b2fe(0x120)+_0x2856d8[_0xd4b2fe(0x10a)]),console[_0xd4b2fe(0xee)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x803633+_0xd4b2fe(0x117)+_0x2856d8['status']),_0x2856d8[_0xd4b2fe(0x10a)]===_0xd4b2fe(0xf0)?_0x585905[_0xd4b2fe(0xa4)]({'success':!![],'message':_0xd4b2fe(0xfd),'result':{'status':_0xd4b2fe(0xf0),'transactionId':_0x2856d8['transactionId'],'redirectUrl':_0x18af2b[_0xd4b2fe(0xcb)]}}):_0x585905[_0xd4b2fe(0x10a)](0x190)[_0xd4b2fe(0xa4)]({'success':![],'message':'Payment\x20failed','result':{'status':_0xd4b2fe(0x114),'failureReason':_0x2856d8[_0xd4b2fe(0xd1)],'redirectUrl':_0x18af2b[_0xd4b2fe(0x113)]}});}catch(_0x313fb9){_0x9e3ac5(_0x313fb9);}},this[_0x3f22a3(0xf8)]=new testGatewayService_1['TestGatewayService'](),this[_0x3f22a3(0xbe)]=new webhookService_1[(_0x3f22a3(0xbf))]();}async[a21_0x206f7e(0xb2)](_0x5acb70,_0x51f934,_0x5d36a5,_0x4103b4){const _0x487793=a21_0x206f7e,_0xacbb53=Date[_0x487793(0xd0)]();try{const _0x5be31d=_0x5acb70['shop'],_0xf595d4=_0x5be31d['settings'];if(!_0xf595d4?.[_0x487793(0x109)]){console[_0x487793(0xee)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5be31d['id']);return;}const _0x3bbe84=_0x51f934===_0x487793(0xf0)?_0x487793(0x10f):_0x487793(0xab);console[_0x487793(0xee)]('üß™\x20Test\x20Gateway\x20webhook:\x20event='+_0x3bbe84+_0x487793(0xe6)+(_0xf595d4['webhookUrl']?_0x487793(0x121):_0x487793(0xe1)));let _0x5fe31e=[];if(_0xf595d4[_0x487793(0xdf)])try{_0x5fe31e=Array[_0x487793(0xad)](_0xf595d4[_0x487793(0xdf)])?_0xf595d4['webhookEvents']:JSON[_0x487793(0x110)](_0xf595d4[_0x487793(0xdf)]);}catch(_0x18eabd){console[_0x487793(0xb6)](_0x487793(0x119),_0x18eabd),_0x5fe31e=[];}console[_0x487793(0xee)](_0x487793(0xf4),_0x5fe31e);if(!_0x5fe31e[_0x487793(0x118)](_0x3bbe84)){console[_0x487793(0xee)](_0x487793(0xe3)+_0x3bbe84+_0x487793(0xeb)+_0x5be31d['id']);return;}const _0x326afd={'event':_0x3bbe84,'payment':{'id':_0x5acb70['id'],'order_id':_0x5acb70[_0x487793(0xa6)],'gateway_order_id':_0x5acb70[_0x487793(0xda)],'gateway':_0x487793(0xdd),'amount':_0x5acb70[_0x487793(0xb1)],'currency':_0x5acb70[_0x487793(0x10d)],'status':_0x51f934[_0x487793(0xf5)](),'customer_email':_0x5acb70['customerEmail'],'customer_name':_0x5acb70['customerName'],'transaction_id':_0x5d36a5,'failure_message':_0x4103b4,'created_at':_0x5acb70[_0x487793(0xed)],'updated_at':new Date()}};console[_0x487793(0xee)](_0x487793(0x10b)+_0xf595d4['webhookUrl']+_0x487793(0xb3)),console[_0x487793(0xee)](_0x487793(0xdb),JSON[_0x487793(0xce)](_0x326afd,null,0x2));const _0x21dabc=JSON['stringify'](_0x326afd),_0x9b7999=crypto_1['default'][_0x487793(0x100)]('sha256',_0x5be31d['secretKey'])['update'](_0x21dabc)[_0x487793(0x112)](_0x487793(0xf9)),_0x119722=await fetch(_0xf595d4[_0x487793(0x109)],{'method':_0x487793(0x11a),'headers':{'Content-Type':_0x487793(0xc6),'User-Agent':_0x487793(0x116),'X-Webhook-Signature':_0x9b7999},'body':_0x21dabc}),_0x4df019=Date[_0x487793(0xd0)]()-_0xacbb53;console[_0x487793(0xee)](_0x487793(0xa2)+_0xf595d4[_0x487793(0x109)]+_0x487793(0xe9)+_0x119722[_0x487793(0x10a)]+'\x20('+_0x4df019+_0x487793(0xbd));}catch(_0x3753ba){console['error'](_0x487793(0xa8),_0x3753ba);}}async[a21_0x206f7e(0xf2)](_0x517365,_0x444b84){const _0x396e51=a21_0x206f7e;try{const {telegramBotService:_0x5d741a}=await Promise['resolve']()[_0x396e51(0xa0)](()=>__importStar(require('../services/telegramBotService'))),_0x5397b8={'PAID':_0x396e51(0xe7),'FAILED':'failed'},_0x403604=_0x5397b8[_0x444b84];if(!_0x403604)return;await _0x5d741a[_0x396e51(0x115)](_0x517365[_0x396e51(0xfe)],_0x517365,_0x403604);}catch(_0x32810c){console['error'](_0x396e51(0xef),_0x32810c);}}}exports[a21_0x206f7e(0xac)]=TestGatewayController;