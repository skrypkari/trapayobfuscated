'use strict';const a13_0x2e25b3=a13_0x3e01;(function(_0x5dc1fd,_0x365a5e){const _0x416665=a13_0x3e01,_0x50e458=_0x5dc1fd();while(!![]){try{const _0xf2417a=-parseInt(_0x416665(0xc1))/0x1+parseInt(_0x416665(0x107))/0x2+-parseInt(_0x416665(0xef))/0x3+parseInt(_0x416665(0x108))/0x4*(-parseInt(_0x416665(0xd5))/0x5)+parseInt(_0x416665(0x10a))/0x6+parseInt(_0x416665(0xe4))/0x7*(-parseInt(_0x416665(0xd0))/0x8)+parseInt(_0x416665(0x105))/0x9;if(_0xf2417a===_0x365a5e)break;else _0x50e458['push'](_0x50e458['shift']());}catch(_0xa7010c){_0x50e458['push'](_0x50e458['shift']());}}}(a13_0x3e6a,0x39207));function a13_0x3e01(_0x297941,_0x5493ee){const _0x3e6a5b=a13_0x3e6a();return a13_0x3e01=function(_0x3e01bd,_0x197cb6){_0x3e01bd=_0x3e01bd-0xb9;let _0x297e2c=_0x3e6a5b[_0x3e01bd];return _0x297e2c;},a13_0x3e01(_0x297941,_0x5493ee);}var __createBinding=this&&this[a13_0x2e25b3(0xf2)]||(Object[a13_0x2e25b3(0xdf)]?function(_0x49bc6d,_0x1ab889,_0x174448,_0x578cf0){const _0x3497be=a13_0x2e25b3;if(_0x578cf0===undefined)_0x578cf0=_0x174448;var _0x21e7e4=Object[_0x3497be(0xfe)](_0x1ab889,_0x174448);(!_0x21e7e4||(_0x3497be(0xbd)in _0x21e7e4?!_0x1ab889['__esModule']:_0x21e7e4['writable']||_0x21e7e4[_0x3497be(0xe9)]))&&(_0x21e7e4={'enumerable':!![],'get':function(){return _0x1ab889[_0x174448];}}),Object[_0x3497be(0xe8)](_0x49bc6d,_0x578cf0,_0x21e7e4);}:function(_0x154083,_0x54f2d8,_0x252210,_0x354667){if(_0x354667===undefined)_0x354667=_0x252210;_0x154083[_0x354667]=_0x54f2d8[_0x252210];}),__setModuleDefault=this&&this[a13_0x2e25b3(0x101)]||(Object[a13_0x2e25b3(0xdf)]?function(_0x3d394c,_0x592f50){Object['defineProperty'](_0x3d394c,'default',{'enumerable':!![],'value':_0x592f50});}:function(_0x3226a1,_0x1f0c29){const _0x240c7b=a13_0x2e25b3;_0x3226a1[_0x240c7b(0xdb)]=_0x1f0c29;}),__importStar=this&&this[a13_0x2e25b3(0xee)]||(function(){var _0x3cf9ae=function(_0x4cc1f9){return _0x3cf9ae=Object['getOwnPropertyNames']||function(_0x44ec27){const _0x8fc831=a13_0x3e01;var _0x428463=[];for(var _0x2dfcf5 in _0x44ec27)if(Object['prototype'][_0x8fc831(0xe5)][_0x8fc831(0xd8)](_0x44ec27,_0x2dfcf5))_0x428463[_0x428463[_0x8fc831(0x10f)]]=_0x2dfcf5;return _0x428463;},_0x3cf9ae(_0x4cc1f9);};return function(_0x4b4077){const _0x4b3d43=a13_0x3e01;if(_0x4b4077&&_0x4b4077[_0x4b3d43(0xd7)])return _0x4b4077;var _0x1b8883={};if(_0x4b4077!=null){for(var _0x2a592e=_0x3cf9ae(_0x4b4077),_0xdab855=0x0;_0xdab855<_0x2a592e[_0x4b3d43(0x10f)];_0xdab855++)if(_0x2a592e[_0xdab855]!==_0x4b3d43(0xdb))__createBinding(_0x1b8883,_0x4b4077,_0x2a592e[_0xdab855]);}return __setModuleDefault(_0x1b8883,_0x4b4077),_0x1b8883;};}()),__importDefault=this&&this['__importDefault']||function(_0x6c2157){const _0x4556bf=a13_0x2e25b3;return _0x6c2157&&_0x6c2157[_0x4556bf(0xd7)]?_0x6c2157:{'default':_0x6c2157};};function a13_0x3e6a(){const _0x40ea66=['application/json','findUnique','length','resolve','paid','toLowerCase','then','testGatewayService','update','json','settings','POST','\x20with\x20status\x20','payment','ðŸ§ª\x20Test\x20Gateway\x20result:','../services/webhookService','\x20not\x20enabled\x20for\x20shop\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','cardLast4','ms)','shop','replace','get','amount','Any\x20name','processCardPayment','454699xEKFQD','stringify','sendPaymentNotification','payment.failed','../config/database','error','paymentMethod','failureMessage','name','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','processCard','âœ…\x20Test\x20Gateway\x20payment\x20','../services/gateways/testGatewayService','webhookEvents','Payment\x20to\x20','816VBpJDs','shopId','status','Any\x203-4\x20digits','Test\x20Gateway\x20webhook\x20sent\x20to\x20','20lksNGH','test_card','__esModule','call','sendShopWebhook','Payment\x20failed','default','webhookLog',',\x20cannot\x20process','successUrl','create','Payment\x20status\x20is\x20','gateway','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','PAID','9366MFxveJ','hasOwnProperty','TestGatewayController','Payment\x20processed\x20successfully','defineProperty','configurable','params','currency','test_gateway','failureReason','__importStar','618894wRbVYJ','\x20processed:\x20','body','__createBinding','4242\x204242\x204242\x204242','TestGatewayService','now','PENDING','customerEmail','sendPaymentStatusNotification','Payment\x20is\x20not\x20for\x20test\x20gateway','WebhookService','getPaymentForm','FAILED','webhookUrl','getOwnPropertyDescriptor','test_gateway_','Any\x20other\x20card\x20number','__setModuleDefault','../services/telegramBotService','Any\x20future\x20date\x20(MM/YY)','gatewayOrderId','7024608sAZjqo','includes','515376zfZlgS','371616LFkkIM','transactionId','2189280hBKmoR','createdAt','Payment\x20not\x20found'];a13_0x3e6a=function(){return _0x40ea66;};return a13_0x3e6a();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x2e25b3(0xe6)]=void 0x0;const testGatewayService_1=require(a13_0x2e25b3(0xcd)),webhookService_1=require(a13_0x2e25b3(0x11c)),database_1=__importDefault(require(a13_0x2e25b3(0xc5)));class TestGatewayController{constructor(){const _0x421419=a13_0x2e25b3;this[_0x421419(0xfb)]=async(_0x4db149,_0xebe9af,_0x20756d)=>{const _0x34a1b4=_0x421419;try{const {paymentId:_0x2a0f11}=_0x4db149[_0x34a1b4(0xea)];console[_0x34a1b4(0x11f)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2a0f11);const _0x680f0a=await database_1[_0x34a1b4(0xdb)][_0x34a1b4(0x11a)][_0x34a1b4(0x10e)]({'where':{'id':_0x2a0f11},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x680f0a)return _0xebe9af[_0x34a1b4(0xd2)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x680f0a[_0x34a1b4(0xe1)]!==_0x34a1b4(0xec))return _0xebe9af['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x680f0a['status']!==_0x34a1b4(0xf6))return _0xebe9af[_0x34a1b4(0xd2)](0x190)[_0x34a1b4(0x116)]({'success':![],'message':_0x34a1b4(0xe0)+_0x680f0a[_0x34a1b4(0xd2)]+',\x20cannot\x20process'});_0xebe9af[_0x34a1b4(0x116)]({'success':!![],'result':{'paymentId':_0x680f0a['id'],'orderId':_0x680f0a[_0x34a1b4(0x104)],'amount':_0x680f0a[_0x34a1b4(0xbe)],'currency':_0x680f0a[_0x34a1b4(0xeb)],'merchantName':_0x680f0a['shop'][_0x34a1b4(0xc9)],'description':_0x34a1b4(0xcf)+_0x680f0a['shop'][_0x34a1b4(0xc9)],'testInstructions':{'successCard':_0x34a1b4(0xf3),'failureCard':_0x34a1b4(0x100),'expiryDate':_0x34a1b4(0x103),'cvc':_0x34a1b4(0xd3),'holderName':_0x34a1b4(0xbf)}}});}catch(_0x27e52e){_0x20756d(_0x27e52e);}},this[_0x421419(0xcb)]=async(_0xda622d,_0x4b85bf,_0x20784d)=>{const _0x500452=_0x421419;try{const {paymentId:_0x150042}=_0xda622d[_0x500452(0xea)],_0x21e304=_0xda622d[_0x500452(0xf1)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x150042);const _0x241b29=await database_1[_0x500452(0xdb)]['payment']['findUnique']({'where':{'id':_0x150042},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x241b29)return _0x4b85bf[_0x500452(0xd2)](0x194)[_0x500452(0x116)]({'success':![],'message':_0x500452(0x10c)});if(_0x241b29[_0x500452(0xe1)]!==_0x500452(0xec))return _0x4b85bf[_0x500452(0xd2)](0x190)['json']({'success':![],'message':_0x500452(0xf9)});if(_0x241b29[_0x500452(0xd2)]!==_0x500452(0xf6))return _0x4b85bf[_0x500452(0xd2)](0x190)[_0x500452(0x116)]({'success':![],'message':_0x500452(0xe0)+_0x241b29[_0x500452(0xd2)]+_0x500452(0xdd)});const _0x309a63=await this[_0x500452(0x114)][_0x500452(0xc0)]({'paymentId':_0x241b29['id'],'orderId':_0x241b29[_0x500452(0x104)]||_0x241b29['id'],'amount':_0x241b29[_0x500452(0xbe)],'currency':_0x241b29[_0x500452(0xeb)],'cardData':_0x21e304});console['log'](_0x500452(0x11b),_0x309a63);const _0x44aac3={'status':_0x309a63[_0x500452(0xd2)],'updatedAt':new Date()};if(_0x309a63[_0x500452(0xd2)]===_0x500452(0xe3))_0x44aac3['paidAt']=new Date(),_0x44aac3['gatewayPaymentId']=_0x309a63[_0x500452(0x109)];else _0x309a63['status']===_0x500452(0xfc)&&(_0x44aac3[_0x500452(0xc8)]=_0x309a63['failureReason']);const _0x4b4cab=_0x21e304['cardNumber'][_0x500452(0xbc)](/[\s-]/g,'');_0x44aac3[_0x500452(0xb9)]=_0x4b4cab['slice'](-0x4),_0x44aac3[_0x500452(0xc7)]=_0x500452(0xd6),await database_1[_0x500452(0xdb)][_0x500452(0x11a)][_0x500452(0x115)]({'where':{'id':_0x241b29['id']},'data':_0x44aac3}),await database_1['default'][_0x500452(0xdc)][_0x500452(0xdf)]({'data':{'paymentId':_0x241b29['id'],'shopId':_0x241b29[_0x500452(0xd1)],'event':_0x500452(0xff)+_0x309a63['status'][_0x500452(0x112)](),'statusCode':0xc8,'responseBody':JSON[_0x500452(0xc2)]({'oldStatus':_0x500452(0xf6),'newStatus':_0x309a63[_0x500452(0xd2)],'transactionId':_0x309a63[_0x500452(0x109)],'failureReason':_0x309a63[_0x500452(0xed)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x241b29,_0x309a63[_0x500452(0xd2)],_0x309a63[_0x500452(0x109)],_0x309a63[_0x500452(0xed)]),await this[_0x500452(0xf8)](_0x241b29,_0x309a63[_0x500452(0xd2)]),console[_0x500452(0x11f)](_0x500452(0xcc)+_0x150042+_0x500452(0xf0)+_0x309a63[_0x500452(0xd2)]),_0x309a63[_0x500452(0xd2)]===_0x500452(0xe3)?_0x4b85bf[_0x500452(0x116)]({'success':!![],'message':_0x500452(0xe7),'result':{'status':_0x500452(0xe3),'transactionId':_0x309a63[_0x500452(0x109)],'redirectUrl':_0x241b29[_0x500452(0xde)]}}):_0x4b85bf[_0x500452(0xd2)](0x190)[_0x500452(0x116)]({'success':![],'message':_0x500452(0xda),'result':{'status':_0x500452(0xfc),'failureReason':_0x309a63[_0x500452(0xed)],'redirectUrl':_0x241b29['failUrl']}});}catch(_0x1d22cc){_0x20784d(_0x1d22cc);}},this[_0x421419(0x114)]=new testGatewayService_1[(_0x421419(0xf4))](),this['webhookService']=new webhookService_1[(_0x421419(0xfa))]();}async[a13_0x2e25b3(0xd9)](_0x4d7376,_0xeb4228,_0x3a08f1,_0x327bd7){const _0x29b50c=a13_0x2e25b3,_0x16db9a=Date[_0x29b50c(0xf5)]();try{const _0x2b5a6b=_0x4d7376[_0x29b50c(0xbb)],_0x253fc8=_0x2b5a6b[_0x29b50c(0x117)];if(!_0x253fc8?.['webhookUrl']){console[_0x29b50c(0x11f)](_0x29b50c(0xca)+_0x2b5a6b['id']);return;}const _0x4fc5f8=_0xeb4228===_0x29b50c(0xe3)?'payment.success':_0x29b50c(0xc4);let _0x142a5a=[];if(_0x253fc8[_0x29b50c(0xce)])try{_0x142a5a=Array['isArray'](_0x253fc8[_0x29b50c(0xce)])?_0x253fc8[_0x29b50c(0xce)]:JSON['parse'](_0x253fc8['webhookEvents']);}catch(_0xd5242f){console[_0x29b50c(0xc6)]('Error\x20parsing\x20webhook\x20events:',_0xd5242f),_0x142a5a=[];}if(!_0x142a5a[_0x29b50c(0x106)](_0x4fc5f8)){console[_0x29b50c(0x11f)]('Webhook\x20event\x20'+_0x4fc5f8+_0x29b50c(0x11d)+_0x2b5a6b['id']);return;}const _0xb126b4={'event':_0x4fc5f8,'payment':{'id':_0x4d7376['id'],'order_id':_0x4d7376['orderId'],'gateway_order_id':_0x4d7376[_0x29b50c(0x104)],'gateway':'0000','amount':_0x4d7376[_0x29b50c(0xbe)],'currency':_0x4d7376[_0x29b50c(0xeb)],'status':_0xeb4228[_0x29b50c(0x112)](),'customer_email':_0x4d7376[_0x29b50c(0xf7)],'customer_name':_0x4d7376['customerName'],'transaction_id':_0x3a08f1,'failure_message':_0x327bd7,'created_at':_0x4d7376[_0x29b50c(0x10b)],'updated_at':new Date()}},_0x1c538a=await fetch(_0x253fc8['webhookUrl'],{'method':_0x29b50c(0x118),'headers':{'Content-Type':_0x29b50c(0x10d),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x29b50c(0xc2)](_0xb126b4)}),_0x2506dc=Date['now']()-_0x16db9a;console[_0x29b50c(0x11f)](_0x29b50c(0xd4)+_0x253fc8[_0x29b50c(0xfd)]+_0x29b50c(0x119)+_0x1c538a[_0x29b50c(0xd2)]+'\x20('+_0x2506dc+_0x29b50c(0xba));}catch(_0x19adcd){console['error'](_0x29b50c(0xe2),_0x19adcd);}}async['sendPaymentStatusNotification'](_0x350069,_0x4d2bbc){const _0x57bc05=a13_0x2e25b3;try{const {telegramBotService:_0x5623ca}=await Promise[_0x57bc05(0x110)]()[_0x57bc05(0x113)](()=>__importStar(require(_0x57bc05(0x102)))),_0x334be2={'PAID':_0x57bc05(0x111),'FAILED':'failed'},_0x578768=_0x334be2[_0x4d2bbc];if(!_0x578768)return;await _0x5623ca[_0x57bc05(0xc3)](_0x350069['shopId'],_0x350069,_0x578768);}catch(_0x118312){console[_0x57bc05(0xc6)](_0x57bc05(0x11e),_0x118312);}}}exports['TestGatewayController']=TestGatewayController;