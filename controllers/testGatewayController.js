'use strict';const a13_0x3f5ee3=a13_0x3c2b;(function(_0x27b123,_0x4c1270){const _0x3362b4=a13_0x3c2b,_0x342281=_0x27b123();while(!![]){try{const _0x2f5aa9=parseInt(_0x3362b4(0xf8))/0x1+-parseInt(_0x3362b4(0xfb))/0x2*(-parseInt(_0x3362b4(0x11d))/0x3)+-parseInt(_0x3362b4(0x127))/0x4*(-parseInt(_0x3362b4(0x12f))/0x5)+-parseInt(_0x3362b4(0x113))/0x6*(parseInt(_0x3362b4(0xdd))/0x7)+-parseInt(_0x3362b4(0x123))/0x8*(-parseInt(_0x3362b4(0x115))/0x9)+parseInt(_0x3362b4(0xfa))/0xa+-parseInt(_0x3362b4(0xda))/0xb*(parseInt(_0x3362b4(0x12e))/0xc);if(_0x2f5aa9===_0x4c1270)break;else _0x342281['push'](_0x342281['shift']());}catch(_0x1a4157){_0x342281['push'](_0x342281['shift']());}}}(a13_0x19e3,0x26363));function a13_0x3c2b(_0x3cee75,_0xe98c3d){const _0x19e3d1=a13_0x19e3();return a13_0x3c2b=function(_0x3c2b1b,_0x287593){_0x3c2b1b=_0x3c2b1b-0xcf;let _0x8191c4=_0x19e3d1[_0x3c2b1b];return _0x8191c4;},a13_0x3c2b(_0x3cee75,_0xe98c3d);}var __createBinding=this&&this[a13_0x3f5ee3(0xe0)]||(Object[a13_0x3f5ee3(0xfc)]?function(_0x154a77,_0x1ae589,_0x32fa6c,_0x44be59){const _0x3f8df1=a13_0x3f5ee3;if(_0x44be59===undefined)_0x44be59=_0x32fa6c;var _0x6323be=Object[_0x3f8df1(0x132)](_0x1ae589,_0x32fa6c);(!_0x6323be||(_0x3f8df1(0x117)in _0x6323be?!_0x1ae589[_0x3f8df1(0xdc)]:_0x6323be[_0x3f8df1(0xd5)]||_0x6323be[_0x3f8df1(0xe5)]))&&(_0x6323be={'enumerable':!![],'get':function(){return _0x1ae589[_0x32fa6c];}}),Object[_0x3f8df1(0xe3)](_0x154a77,_0x44be59,_0x6323be);}:function(_0x34433f,_0x1c9573,_0x30eac2,_0x1e0ed9){if(_0x1e0ed9===undefined)_0x1e0ed9=_0x30eac2;_0x34433f[_0x1e0ed9]=_0x1c9573[_0x30eac2];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x59ec48,_0xd6de79){const _0x121413=a13_0x3f5ee3;Object['defineProperty'](_0x59ec48,_0x121413(0xf9),{'enumerable':!![],'value':_0xd6de79});}:function(_0x11cccb,_0x4e6970){const _0x5e972e=a13_0x3f5ee3;_0x11cccb[_0x5e972e(0xf9)]=_0x4e6970;}),__importStar=this&&this[a13_0x3f5ee3(0xd7)]||(function(){var _0x2a00fb=function(_0x463e16){const _0x564f1e=a13_0x3c2b;return _0x2a00fb=Object[_0x564f1e(0x128)]||function(_0x2373f4){const _0x505864=_0x564f1e;var _0x7c907f=[];for(var _0x4f3161 in _0x2373f4)if(Object[_0x505864(0x131)][_0x505864(0x138)][_0x505864(0xfd)](_0x2373f4,_0x4f3161))_0x7c907f[_0x7c907f[_0x505864(0xdf)]]=_0x4f3161;return _0x7c907f;},_0x2a00fb(_0x463e16);};return function(_0x85e20a){const _0x4432dc=a13_0x3c2b;if(_0x85e20a&&_0x85e20a[_0x4432dc(0xdc)])return _0x85e20a;var _0x52a4bd={};if(_0x85e20a!=null){for(var _0xebeb25=_0x2a00fb(_0x85e20a),_0x4d8d19=0x0;_0x4d8d19<_0xebeb25['length'];_0x4d8d19++)if(_0xebeb25[_0x4d8d19]!==_0x4432dc(0xf9))__createBinding(_0x52a4bd,_0x85e20a,_0xebeb25[_0x4d8d19]);}return __setModuleDefault(_0x52a4bd,_0x85e20a),_0x52a4bd;};}()),__importDefault=this&&this[a13_0x3f5ee3(0xf5)]||function(_0x41829d){return _0x41829d&&_0x41829d['__esModule']?_0x41829d:{'default':_0x41829d};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x3f5ee3(0x142)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x3f5ee3(0x136)));function a13_0x19e3(){const _0x178e27=['../config/database','replace','hasOwnProperty','gatewayOrderId','\x20with\x20status\x20','customerEmail','POST','\x20processed:\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','PAID','Any\x20future\x20date\x20(MM/YY)','WebhookService','TestGatewayController','paidAt','slice','getPaymentForm','webhookEvents','sendPaymentStatusNotification','testGatewayService','writable','4242\x204242\x204242\x204242','__importStar','params','Payment\x20to\x20','4473403kVGKBE','error','__esModule','14tuLemu','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','length','__createBinding','gateway','shopId','defineProperty','Payment\x20failed','configurable','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','cardLast4','payment','webhookService','findUnique','processCardPayment','Any\x203-4\x20digits','Error\x20parsing\x20webhook\x20events:','failureMessage','payment.failed','orderId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','stringify','toLowerCase','TestGatewayService','__importDefault','Payment\x20is\x20not\x20for\x20test\x20gateway','FAILED','311623TWVCID','default','3065360gPvMRS','2054HaDobQ','create','call','failed','currency','failureReason','ðŸ§ª\x20Test\x20Gateway\x20result:','webhookUrl','Webhook\x20event\x20','now','body','Payment\x20not\x20found','isArray','json','Test\x20Gateway\x20webhook\x20sent\x20to\x20','log','test_gateway','amount','Payment\x20status\x20is\x20','../services/telegramBotService','includes','test_card','0000','then','298572HcALbG','âœ…\x20Test\x20Gateway\x20payment\x20','18yjJeKK','sendShopWebhook','get','Any\x20other\x20card\x20number','createdAt','update','resolve','ms)','177SMvauS','shop','Payment\x20processed\x20successfully','successUrl','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','cardNumber','1040432FTMfYT','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','processCard','customerName','460bsEMfG','getOwnPropertyNames','settings','Any\x20name','transactionId','name','gatewayPaymentId','24IWZlHJ','5675iSRfQT','status','prototype','getOwnPropertyDescriptor','payment.success','\x20not\x20enabled\x20for\x20shop\x20',',\x20cannot\x20process'];a13_0x19e3=function(){return _0x178e27;};return a13_0x19e3();}class TestGatewayController{constructor(){const _0x337223=a13_0x3f5ee3;this[_0x337223(0xd1)]=async(_0xff2dc6,_0x1d6ede,_0x3587f1)=>{const _0x541d46=_0x337223;try{const {paymentId:_0x35c5ee}=_0xff2dc6[_0x541d46(0xd8)];console[_0x541d46(0x10a)](_0x541d46(0x13e)+_0x35c5ee);const _0x4ee272=await database_1[_0x541d46(0xf9)][_0x541d46(0xe8)]['findUnique']({'where':{'id':_0x35c5ee},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4ee272)return _0x1d6ede[_0x541d46(0x130)](0x194)['json']({'success':![],'message':_0x541d46(0x106)});if(_0x4ee272[_0x541d46(0xe1)]!==_0x541d46(0x10b))return _0x1d6ede[_0x541d46(0x130)](0x190)[_0x541d46(0x108)]({'success':![],'message':_0x541d46(0xf6)});if(_0x4ee272[_0x541d46(0x130)]!=='PENDING')return _0x1d6ede[_0x541d46(0x130)](0x190)[_0x541d46(0x108)]({'success':![],'message':_0x541d46(0x10d)+_0x4ee272[_0x541d46(0x130)]+_0x541d46(0x135)});_0x1d6ede[_0x541d46(0x108)]({'success':!![],'result':{'paymentId':_0x4ee272['id'],'orderId':_0x4ee272[_0x541d46(0x139)],'amount':_0x4ee272[_0x541d46(0x10c)],'currency':_0x4ee272['currency'],'merchantName':_0x4ee272[_0x541d46(0x11e)][_0x541d46(0x12c)],'description':_0x541d46(0xd9)+_0x4ee272[_0x541d46(0x11e)][_0x541d46(0x12c)],'testInstructions':{'successCard':_0x541d46(0xd6),'failureCard':_0x541d46(0x118),'expiryDate':_0x541d46(0x140),'cvc':_0x541d46(0xec),'holderName':_0x541d46(0x12a)}}});}catch(_0x4ff18b){_0x3587f1(_0x4ff18b);}},this[_0x337223(0x125)]=async(_0x2ca7d8,_0x550a02,_0x20e4dc)=>{const _0x3fcd30=_0x337223;try{const {paymentId:_0x554de2}=_0x2ca7d8['params'],_0x406b14=_0x2ca7d8[_0x3fcd30(0x105)];console[_0x3fcd30(0x10a)](_0x3fcd30(0x124)+_0x554de2);const _0x2d59d2=await database_1[_0x3fcd30(0xf9)][_0x3fcd30(0xe8)][_0x3fcd30(0xea)]({'where':{'id':_0x554de2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2d59d2)return _0x550a02[_0x3fcd30(0x130)](0x194)[_0x3fcd30(0x108)]({'success':![],'message':_0x3fcd30(0x106)});if(_0x2d59d2[_0x3fcd30(0xe1)]!=='test_gateway')return _0x550a02[_0x3fcd30(0x130)](0x190)[_0x3fcd30(0x108)]({'success':![],'message':_0x3fcd30(0xf6)});if(_0x2d59d2[_0x3fcd30(0x130)]!=='PENDING')return _0x550a02[_0x3fcd30(0x130)](0x190)['json']({'success':![],'message':_0x3fcd30(0x10d)+_0x2d59d2['status']+_0x3fcd30(0x135)});const _0x12d090=await this[_0x3fcd30(0xd4)][_0x3fcd30(0xeb)]({'paymentId':_0x2d59d2['id'],'orderId':_0x2d59d2[_0x3fcd30(0x139)]||_0x2d59d2['id'],'amount':_0x2d59d2['amount'],'currency':_0x2d59d2[_0x3fcd30(0xff)],'cardData':_0x406b14});console[_0x3fcd30(0x10a)](_0x3fcd30(0x101),_0x12d090);const _0x37036c={'status':_0x12d090[_0x3fcd30(0x130)],'updatedAt':new Date()};if(_0x12d090[_0x3fcd30(0x130)]===_0x3fcd30(0x13f))_0x37036c[_0x3fcd30(0xcf)]=new Date(),_0x37036c[_0x3fcd30(0x12d)]=_0x12d090['transactionId'];else _0x12d090['status']===_0x3fcd30(0xf7)&&(_0x37036c[_0x3fcd30(0xee)]=_0x12d090[_0x3fcd30(0x100)]);const _0x4b2415=_0x406b14[_0x3fcd30(0x122)][_0x3fcd30(0x137)](/[\s-]/g,'');_0x37036c[_0x3fcd30(0xe7)]=_0x4b2415[_0x3fcd30(0xd0)](-0x4),_0x37036c['paymentMethod']=_0x3fcd30(0x110),await database_1[_0x3fcd30(0xf9)]['payment'][_0x3fcd30(0x11a)]({'where':{'id':_0x2d59d2['id']},'data':_0x37036c}),await database_1[_0x3fcd30(0xf9)]['webhookLog'][_0x3fcd30(0xfc)]({'data':{'paymentId':_0x2d59d2['id'],'shopId':_0x2d59d2[_0x3fcd30(0xe2)],'event':'test_gateway_'+_0x12d090[_0x3fcd30(0x130)][_0x3fcd30(0xf3)](),'statusCode':0xc8,'responseBody':JSON[_0x3fcd30(0xf2)]({'oldStatus':'PENDING','newStatus':_0x12d090[_0x3fcd30(0x130)],'transactionId':_0x12d090[_0x3fcd30(0x12b)],'failureReason':_0x12d090[_0x3fcd30(0x100)],'processedAt':new Date()['toISOString']()})}}),await this[_0x3fcd30(0x116)](_0x2d59d2,_0x12d090[_0x3fcd30(0x130)],_0x12d090[_0x3fcd30(0x12b)],_0x12d090[_0x3fcd30(0x100)]),await this['sendPaymentStatusNotification'](_0x2d59d2,_0x12d090['status']),console[_0x3fcd30(0x10a)](_0x3fcd30(0x114)+_0x554de2+_0x3fcd30(0x13d)+_0x12d090[_0x3fcd30(0x130)]),_0x12d090[_0x3fcd30(0x130)]===_0x3fcd30(0x13f)?_0x550a02['json']({'success':!![],'message':_0x3fcd30(0x11f),'result':{'status':_0x3fcd30(0x13f),'transactionId':_0x12d090[_0x3fcd30(0x12b)],'redirectUrl':_0x2d59d2[_0x3fcd30(0x120)]}}):_0x550a02[_0x3fcd30(0x130)](0x190)[_0x3fcd30(0x108)]({'success':![],'message':_0x3fcd30(0xe4),'result':{'status':'FAILED','failureReason':_0x12d090[_0x3fcd30(0x100)],'redirectUrl':_0x2d59d2['failUrl']}});}catch(_0xb22fee){_0x20e4dc(_0xb22fee);}},this['testGatewayService']=new testGatewayService_1[(_0x337223(0xf4))](),this[_0x337223(0xe9)]=new webhookService_1[(_0x337223(0x141))]();}async['sendShopWebhook'](_0x334a5f,_0xf9cde3,_0x38a97b,_0x4b2df1){const _0x183731=a13_0x3f5ee3,_0x4cc0d9=Date[_0x183731(0x104)]();try{const _0x223d07=_0x334a5f[_0x183731(0x11e)],_0x2475f2=_0x223d07[_0x183731(0x129)];if(!_0x2475f2?.[_0x183731(0x102)]){console[_0x183731(0x10a)](_0x183731(0xf1)+_0x223d07['id']);return;}const _0x11a1d3=_0xf9cde3===_0x183731(0x13f)?_0x183731(0x133):_0x183731(0xef);let _0x66f12d=[];if(_0x2475f2[_0x183731(0xd2)])try{_0x66f12d=Array[_0x183731(0x107)](_0x2475f2['webhookEvents'])?_0x2475f2[_0x183731(0xd2)]:JSON['parse'](_0x2475f2[_0x183731(0xd2)]);}catch(_0x3e8ada){console[_0x183731(0xdb)](_0x183731(0xed),_0x3e8ada),_0x66f12d=[];}if(!_0x66f12d[_0x183731(0x10f)](_0x11a1d3)){console[_0x183731(0x10a)](_0x183731(0x103)+_0x11a1d3+_0x183731(0x134)+_0x223d07['id']);return;}const _0x29f47f={'event':_0x11a1d3,'payment':{'id':_0x334a5f['id'],'order_id':_0x334a5f[_0x183731(0xf0)],'gateway_order_id':_0x334a5f[_0x183731(0x139)],'gateway':_0x183731(0x111),'amount':_0x334a5f[_0x183731(0x10c)],'currency':_0x334a5f[_0x183731(0xff)],'status':_0xf9cde3[_0x183731(0xf3)](),'customer_email':_0x334a5f[_0x183731(0x13b)],'customer_name':_0x334a5f[_0x183731(0x126)],'transaction_id':_0x38a97b,'failure_message':_0x4b2df1,'created_at':_0x334a5f[_0x183731(0x119)],'updated_at':new Date()}},_0x56f9df=await fetch(_0x2475f2[_0x183731(0x102)],{'method':_0x183731(0x13c),'headers':{'Content-Type':'application/json','User-Agent':_0x183731(0x121)},'body':JSON[_0x183731(0xf2)](_0x29f47f)}),_0x599563=Date[_0x183731(0x104)]()-_0x4cc0d9;console[_0x183731(0x10a)](_0x183731(0x109)+_0x2475f2[_0x183731(0x102)]+_0x183731(0x13a)+_0x56f9df[_0x183731(0x130)]+'\x20('+_0x599563+_0x183731(0x11c));}catch(_0x2a7df8){console[_0x183731(0xdb)](_0x183731(0xe6),_0x2a7df8);}}async[a13_0x3f5ee3(0xd3)](_0x17f6ff,_0x5991ea){const _0x1001f3=a13_0x3f5ee3;try{const {telegramBotService:_0x6e795b}=await Promise[_0x1001f3(0x11b)]()[_0x1001f3(0x112)](()=>__importStar(require(_0x1001f3(0x10e)))),_0x58e668={'PAID':'paid','FAILED':_0x1001f3(0xfe)},_0x15e8ff=_0x58e668[_0x5991ea];if(!_0x15e8ff)return;await _0x6e795b['sendPaymentNotification'](_0x17f6ff[_0x1001f3(0xe2)],_0x17f6ff,_0x15e8ff);}catch(_0x33e286){console[_0x1001f3(0xdb)](_0x1001f3(0xde),_0x33e286);}}}exports['TestGatewayController']=TestGatewayController;