'use strict';const a18_0x4477c9=a18_0x4678;(function(_0x1eeef5,_0x7f450a){const _0x100864=a18_0x4678,_0x451ab8=_0x1eeef5();while(!![]){try{const _0x244ed8=parseInt(_0x100864(0xac))/0x1+parseInt(_0x100864(0x84))/0x2*(parseInt(_0x100864(0xc2))/0x3)+-parseInt(_0x100864(0x7e))/0x4+-parseInt(_0x100864(0xc7))/0x5*(-parseInt(_0x100864(0x9d))/0x6)+parseInt(_0x100864(0xc8))/0x7+-parseInt(_0x100864(0xd0))/0x8+-parseInt(_0x100864(0x7c))/0x9;if(_0x244ed8===_0x7f450a)break;else _0x451ab8['push'](_0x451ab8['shift']());}catch(_0x425fe1){_0x451ab8['push'](_0x451ab8['shift']());}}}(a18_0xfa09,0xc1052));function a18_0x4678(_0x24f185,_0x582efc){_0x24f185=_0x24f185-0x65;const _0xfa09f6=a18_0xfa09();let _0x467835=_0xfa09f6[_0x24f185];return _0x467835;}function a18_0xfa09(){const _0x29c7fa=['__createBinding','paymentMethod','body','resolve','failureReason','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','update','amount','hasOwnProperty','../services/telegramBotService','gatewayOrderId','customerName','\x20not\x20enabled\x20for\x20shop\x20','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','15392736ZLVrrK','\x20with\x20status\x20','3920020ClcxRg','PAID','cardLast4','length','isArray','log','122VUVGqD','üìà\x20Found\x20payment\x20link\x20','sendPaymentNotification','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','type','ms)','currency','processCardPayment',',\x20status=','failed','__importDefault','replace','findUnique','Payment\x20status\x20is\x20','webhookLog','webhookService','\x20->\x20','__setModuleDefault','TestGatewayController','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','test_gateway','defineProperty','currentPayments','sendPaymentStatusNotification','Payment\x20processed\x20successfully','222996tUGsAp','webhookUrl','\x20updated:\x20currentPayments=','shop','prototype','successUrl','json','sendShopWebhook',',\x20cannot\x20process','paid','name','application/json','stringify','customerEmail','now','1284055CRosym','Payment\x20is\x20not\x20for\x20test\x20gateway','Test\x20Gateway\x20webhook\x20sent\x20to\x20','toLowerCase','../services/webhookService','status','paymentLinkId','../config/database','PENDING','payment.failed','payment','getOwnPropertyDescriptor','POST','writable','transactionId','‚ùå\x20Payment\x20link\x20','payment.success','failureMessage','__esModule','0000','COMPLETED','Webhook\x20event\x20','55023ckiGcQ','params','paymentLink','Payment\x20to\x20','default','60VvwNBV','9380007qRlMYu','üß™\x20Test\x20Gateway\x20result:','paidAt','create','FAILED','shopId','Any\x20other\x20card\x20number','webhookEvents','5663440DUdQdx','cardNumber','test_card','createdAt','processCard','\x20not\x20found','Any\x20future\x20date\x20(MM/YY)','__importStar','testGatewayService','gateway','slice','includes','Payment\x20not\x20found','error'];a18_0xfa09=function(){return _0x29c7fa;};return a18_0xfa09();}var __createBinding=this&&this[a18_0x4477c9(0x6d)]||(Object[a18_0x4477c9(0xcb)]?function(_0x464fd1,_0x1ad62c,_0x2d2056,_0x358719){const _0x263aa5=a18_0x4477c9;if(_0x358719===undefined)_0x358719=_0x2d2056;var _0x386ac1=Object[_0x263aa5(0xb7)](_0x1ad62c,_0x2d2056);(!_0x386ac1||('get'in _0x386ac1?!_0x1ad62c[_0x263aa5(0xbe)]:_0x386ac1[_0x263aa5(0xb9)]||_0x386ac1['configurable']))&&(_0x386ac1={'enumerable':!![],'get':function(){return _0x1ad62c[_0x2d2056];}}),Object['defineProperty'](_0x464fd1,_0x358719,_0x386ac1);}:function(_0x17b317,_0x4a167e,_0x2fa12e,_0xbc7fc7){if(_0xbc7fc7===undefined)_0xbc7fc7=_0x2fa12e;_0x17b317[_0xbc7fc7]=_0x4a167e[_0x2fa12e];}),__setModuleDefault=this&&this[a18_0x4477c9(0x95)]||(Object['create']?function(_0x4cafe5,_0x5f33f0){const _0x586a5d=a18_0x4477c9;Object[_0x586a5d(0x99)](_0x4cafe5,_0x586a5d(0xc6),{'enumerable':!![],'value':_0x5f33f0});}:function(_0xc5446e,_0x254061){const _0x13e658=a18_0x4477c9;_0xc5446e[_0x13e658(0xc6)]=_0x254061;}),__importStar=this&&this[a18_0x4477c9(0x66)]||(function(){var _0x104a01=function(_0x14f5e7){return _0x104a01=Object['getOwnPropertyNames']||function(_0x2563c0){const _0x4dd660=a18_0x4678;var _0x24e225=[];for(var _0x1861c8 in _0x2563c0)if(Object[_0x4dd660(0xa1)][_0x4dd660(0x75)]['call'](_0x2563c0,_0x1861c8))_0x24e225[_0x24e225[_0x4dd660(0x81)]]=_0x1861c8;return _0x24e225;},_0x104a01(_0x14f5e7);};return function(_0x337b83){const _0x2b97aa=a18_0x4678;if(_0x337b83&&_0x337b83[_0x2b97aa(0xbe)])return _0x337b83;var _0x2fd1e6={};if(_0x337b83!=null){for(var _0x41c962=_0x104a01(_0x337b83),_0x1dc2dc=0x0;_0x1dc2dc<_0x41c962[_0x2b97aa(0x81)];_0x1dc2dc++)if(_0x41c962[_0x1dc2dc]!=='default')__createBinding(_0x2fd1e6,_0x337b83,_0x41c962[_0x1dc2dc]);}return __setModuleDefault(_0x2fd1e6,_0x337b83),_0x2fd1e6;};}()),__importDefault=this&&this[a18_0x4477c9(0x8e)]||function(_0x466597){return _0x466597&&_0x466597['__esModule']?_0x466597:{'default':_0x466597};};Object['defineProperty'](exports,a18_0x4477c9(0xbe),{'value':!![]}),exports[a18_0x4477c9(0x96)]=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a18_0x4477c9(0xb0)),database_1=__importDefault(require(a18_0x4477c9(0xb3)));class TestGatewayController{constructor(){const _0xd7f9fb=a18_0x4477c9;this['getPaymentForm']=async(_0xb71b08,_0x4f509f,_0xd3a32c)=>{const _0x559282=a18_0x4678;try{const {paymentId:_0x47ab67}=_0xb71b08['params'];console[_0x559282(0x83)]('üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x47ab67);const _0x58208b=await database_1[_0x559282(0xc6)]['payment'][_0x559282(0x90)]({'where':{'id':_0x47ab67},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x58208b)return _0x4f509f['status'](0x194)[_0x559282(0xa3)]({'success':![],'message':_0x559282(0x6b)});if(_0x58208b[_0x559282(0x68)]!==_0x559282(0x98))return _0x4f509f['status'](0x190)[_0x559282(0xa3)]({'success':![],'message':_0x559282(0xad)});if(_0x58208b[_0x559282(0xb1)]!=='PENDING')return _0x4f509f[_0x559282(0xb1)](0x190)['json']({'success':![],'message':_0x559282(0x91)+_0x58208b[_0x559282(0xb1)]+_0x559282(0xa5)});_0x4f509f['json']({'success':!![],'result':{'paymentId':_0x58208b['id'],'orderId':_0x58208b[_0x559282(0x77)],'amount':_0x58208b[_0x559282(0x74)],'currency':_0x58208b[_0x559282(0x8a)],'merchantName':_0x58208b[_0x559282(0xa0)]['name'],'description':_0x559282(0xc5)+_0x58208b[_0x559282(0xa0)][_0x559282(0xa7)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x559282(0xce),'expiryDate':_0x559282(0x65),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x4dca52){_0xd3a32c(_0x4dca52);}},this[_0xd7f9fb(0xd4)]=async(_0x21d4d0,_0xb99355,_0x32fd8b)=>{const _0xddf476=_0xd7f9fb;try{const {paymentId:_0x1a0595}=_0x21d4d0[_0xddf476(0xc3)],_0x1c8045=_0x21d4d0[_0xddf476(0x6f)];console[_0xddf476(0x83)](_0xddf476(0x7a)+_0x1a0595);const _0x512e71=await database_1[_0xddf476(0xc6)][_0xddf476(0xb6)][_0xddf476(0x90)]({'where':{'id':_0x1a0595},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x512e71)return _0xb99355[_0xddf476(0xb1)](0x194)[_0xddf476(0xa3)]({'success':![],'message':_0xddf476(0x6b)});if(_0x512e71['gateway']!==_0xddf476(0x98))return _0xb99355[_0xddf476(0xb1)](0x190)[_0xddf476(0xa3)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x512e71[_0xddf476(0xb1)]!==_0xddf476(0xb4))return _0xb99355[_0xddf476(0xb1)](0x190)['json']({'success':![],'message':_0xddf476(0x91)+_0x512e71[_0xddf476(0xb1)]+',\x20cannot\x20process'});const _0x1cda09=await this[_0xddf476(0x67)][_0xddf476(0x8b)]({'paymentId':_0x512e71['id'],'orderId':_0x512e71[_0xddf476(0x77)]||_0x512e71['id'],'amount':_0x512e71[_0xddf476(0x74)],'currency':_0x512e71['currency'],'cardData':_0x1c8045});console[_0xddf476(0x83)](_0xddf476(0xc9),_0x1cda09);const _0x3e7632={'status':_0x1cda09[_0xddf476(0xb1)],'updatedAt':new Date()};if(_0x1cda09[_0xddf476(0xb1)]===_0xddf476(0x7f))_0x3e7632[_0xddf476(0xca)]=new Date(),_0x3e7632['gatewayPaymentId']=_0x1cda09[_0xddf476(0xba)];else _0x1cda09[_0xddf476(0xb1)]==='FAILED'&&(_0x3e7632[_0xddf476(0xbd)]=_0x1cda09[_0xddf476(0x71)]);const _0xd0685a=_0x1c8045[_0xddf476(0xd1)][_0xddf476(0x8f)](/[\s-]/g,'');_0x3e7632[_0xddf476(0x80)]=_0xd0685a[_0xddf476(0x69)](-0x4),_0x3e7632[_0xddf476(0x6e)]=_0xddf476(0xd2),await database_1[_0xddf476(0xc6)][_0xddf476(0xb6)][_0xddf476(0x73)]({'where':{'id':_0x512e71['id']},'data':_0x3e7632});if(_0x1cda09['status']===_0xddf476(0x7f)&&_0x512e71[_0xddf476(0xb2)]){console[_0xddf476(0x83)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x512e71['id']+_0xddf476(0x97));try{await database_1[_0xddf476(0xc6)]['$transaction'](async _0x5e87f5=>{const _0x433403=_0xddf476,_0x33138c=await _0x5e87f5[_0x433403(0xc4)][_0x433403(0x90)]({'where':{'id':_0x512e71[_0x433403(0xb2)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x33138c){console['log'](_0x433403(0x85)+_0x33138c['id']+':\x20type='+_0x33138c[_0x433403(0x88)]+',\x20currentPayments='+_0x33138c[_0x433403(0x9a)]+_0x433403(0x8c)+_0x33138c[_0x433403(0xb1)]);const _0x31cf54=_0x33138c['currentPayments']+0x1,_0x269a67=_0x33138c[_0x433403(0x88)]==='SINGLE'?_0x433403(0xc0):_0x33138c['status'];await _0x5e87f5[_0x433403(0xc4)][_0x433403(0x73)]({'where':{'id':_0x512e71[_0x433403(0xb2)]},'data':{'currentPayments':_0x31cf54,'status':_0x269a67,'updatedAt':new Date()}}),console[_0x433403(0x83)]('‚úÖ\x20Payment\x20link\x20'+_0x33138c['id']+_0x433403(0x9f)+_0x33138c[_0x433403(0x9a)]+'\x20->\x20'+_0x31cf54+_0x433403(0x8c)+_0x33138c[_0x433403(0xb1)]+_0x433403(0x94)+_0x269a67);}else console[_0x433403(0x83)](_0x433403(0xbb)+_0x512e71['paymentLinkId']+_0x433403(0xd5));});}catch(_0x327656){console[_0xddf476(0x6c)](_0xddf476(0x72),_0x327656);}}await database_1[_0xddf476(0xc6)][_0xddf476(0x92)][_0xddf476(0xcb)]({'data':{'paymentId':_0x512e71['id'],'shopId':_0x512e71['shopId'],'event':'test_gateway_'+_0x1cda09['status'][_0xddf476(0xaf)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xddf476(0xb4),'newStatus':_0x1cda09[_0xddf476(0xb1)],'transactionId':_0x1cda09[_0xddf476(0xba)],'failureReason':_0x1cda09[_0xddf476(0x71)],'processedAt':new Date()['toISOString']()})}}),await this[_0xddf476(0xa4)](_0x512e71,_0x1cda09['status'],_0x1cda09[_0xddf476(0xba)],_0x1cda09[_0xddf476(0x71)]),await this[_0xddf476(0x9b)](_0x512e71,_0x1cda09['status']),console[_0xddf476(0x83)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x1a0595+'\x20processed:\x20'+_0x1cda09[_0xddf476(0xb1)]),_0x1cda09[_0xddf476(0xb1)]===_0xddf476(0x7f)?_0xb99355[_0xddf476(0xa3)]({'success':!![],'message':_0xddf476(0x9c),'result':{'status':_0xddf476(0x7f),'transactionId':_0x1cda09[_0xddf476(0xba)],'redirectUrl':_0x512e71[_0xddf476(0xa2)]}}):_0xb99355[_0xddf476(0xb1)](0x190)[_0xddf476(0xa3)]({'success':![],'message':'Payment\x20failed','result':{'status':_0xddf476(0xcc),'failureReason':_0x1cda09[_0xddf476(0x71)],'redirectUrl':_0x512e71['failUrl']}});}catch(_0x3cf4cb){_0x32fd8b(_0x3cf4cb);}},this[_0xd7f9fb(0x67)]=new testGatewayService_1['TestGatewayService'](),this[_0xd7f9fb(0x93)]=new webhookService_1['WebhookService']();}async[a18_0x4477c9(0xa4)](_0x348925,_0xc100c4,_0x45c6e2,_0x232b2e){const _0x3f8c54=a18_0x4477c9,_0x11bcd1=Date[_0x3f8c54(0xab)]();try{const _0x33dece=_0x348925[_0x3f8c54(0xa0)],_0x3f12ec=_0x33dece['settings'];if(!_0x3f12ec?.[_0x3f8c54(0x9e)]){console[_0x3f8c54(0x83)](_0x3f8c54(0x7b)+_0x33dece['id']);return;}const _0x468972=_0xc100c4===_0x3f8c54(0x7f)?_0x3f8c54(0xbc):_0x3f8c54(0xb5);let _0x2f0311=[];if(_0x3f12ec[_0x3f8c54(0xcf)])try{_0x2f0311=Array[_0x3f8c54(0x82)](_0x3f12ec[_0x3f8c54(0xcf)])?_0x3f12ec[_0x3f8c54(0xcf)]:JSON['parse'](_0x3f12ec[_0x3f8c54(0xcf)]);}catch(_0x446522){console['error']('Error\x20parsing\x20webhook\x20events:',_0x446522),_0x2f0311=[];}if(!_0x2f0311[_0x3f8c54(0x6a)](_0x468972)){console['log'](_0x3f8c54(0xc1)+_0x468972+_0x3f8c54(0x79)+_0x33dece['id']);return;}const _0x4877de={'event':_0x468972,'payment':{'id':_0x348925['id'],'order_id':_0x348925['orderId'],'gateway_order_id':_0x348925[_0x3f8c54(0x77)],'gateway':_0x3f8c54(0xbf),'amount':_0x348925[_0x3f8c54(0x74)],'currency':_0x348925['currency'],'status':_0xc100c4[_0x3f8c54(0xaf)](),'customer_email':_0x348925[_0x3f8c54(0xaa)],'customer_name':_0x348925[_0x3f8c54(0x78)],'transaction_id':_0x45c6e2,'failure_message':_0x232b2e,'created_at':_0x348925[_0x3f8c54(0xd3)],'updated_at':new Date()}},_0x568115=await fetch(_0x3f12ec[_0x3f8c54(0x9e)],{'method':_0x3f8c54(0xb8),'headers':{'Content-Type':_0x3f8c54(0xa8),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3f8c54(0xa9)](_0x4877de)}),_0x4c7b54=Date[_0x3f8c54(0xab)]()-_0x11bcd1;console[_0x3f8c54(0x83)](_0x3f8c54(0xae)+_0x3f12ec[_0x3f8c54(0x9e)]+_0x3f8c54(0x7d)+_0x568115[_0x3f8c54(0xb1)]+'\x20('+_0x4c7b54+_0x3f8c54(0x89));}catch(_0x23779d){console[_0x3f8c54(0x6c)](_0x3f8c54(0x87),_0x23779d);}}async[a18_0x4477c9(0x9b)](_0x246c85,_0x1a4b04){const _0x276861=a18_0x4477c9;try{const {telegramBotService:_0x15c418}=await Promise[_0x276861(0x70)]()['then'](()=>__importStar(require(_0x276861(0x76)))),_0x788f7e={'PAID':_0x276861(0xa6),'FAILED':_0x276861(0x8d)},_0x565539=_0x788f7e[_0x1a4b04];if(!_0x565539)return;await _0x15c418[_0x276861(0x86)](_0x246c85[_0x276861(0xcd)],_0x246c85,_0x565539);}catch(_0x38bfa4){console[_0x276861(0x6c)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x38bfa4);}}}exports[a18_0x4477c9(0x96)]=TestGatewayController;