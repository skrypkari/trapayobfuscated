'use strict';const a15_0x4f18dc=a15_0x1df1;(function(_0x203714,_0x517ae6){const _0x3c6f89=a15_0x1df1,_0x1208e8=_0x203714();while(!![]){try{const _0x53645e=-parseInt(_0x3c6f89(0x138))/0x1*(parseInt(_0x3c6f89(0x165))/0x2)+-parseInt(_0x3c6f89(0x146))/0x3+parseInt(_0x3c6f89(0x14e))/0x4+-parseInt(_0x3c6f89(0xf7))/0x5*(parseInt(_0x3c6f89(0x13c))/0x6)+parseInt(_0x3c6f89(0x168))/0x7+-parseInt(_0x3c6f89(0x148))/0x8+parseInt(_0x3c6f89(0x147))/0x9*(parseInt(_0x3c6f89(0x12f))/0xa);if(_0x53645e===_0x517ae6)break;else _0x1208e8['push'](_0x1208e8['shift']());}catch(_0x44fa3e){_0x1208e8['push'](_0x1208e8['shift']());}}}(a15_0xdab4,0x4da42));function a15_0xdab4(){const _0x2708c8=['call','application/json','6EtbJJA','shop','payment.failed','Any\x20name','length','then','Any\x20future\x20date\x20(MM/YY)','create','Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20not\x20found','1629672HwGcgP','351eMDsal','1415496XGJJWD','includes','COMPLETED','writable','currentPayments','status','54460dBdOdV','Payment\x20to\x20','successUrl','webhookUrl',':\x20type=',',\x20cannot\x20process','test_gateway','webhookLog','TestGatewayController','slice','__setModuleDefault','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','paymentLinkId','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','customerEmail','currency','error','hasOwnProperty','sendShopWebhook','__esModule','Payment\x20not\x20found',',\x20status=','update','45666dllNQj','gatewayPaymentId','params','3072601teGyDi','paymentMethod','Error\x20parsing\x20webhook\x20events:','payment','stringify','transactionId','2508705rdcdQJ','📈\x20Test\x20Gateway:\x20Payment\x20','getOwnPropertyNames','paid','Payment\x20processed\x20successfully','FAILED','toLowerCase','toISOString','\x20->\x20','failUrl','replace','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4242\x204242\x204242\x204242','log','test_card','defineProperty','name','type','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','PENDING','gatewayOrderId','Any\x20other\x20card\x20number','now',',\x20currentPayments=','webhookEvents','PAID','sendPaymentStatusNotification','gateway','\x20not\x20enabled\x20for\x20shop\x20','resolve','../services/telegramBotService','__importStar','paidAt','prototype','webhookService','settings','shopId','amount','processCardPayment','0000','payment.success','findUnique','✅\x20Payment\x20link\x20','json','sendPaymentNotification','paymentLink','testGatewayService','body','Payment\x20status\x20is\x20','failureReason','\x20processed:\x20','getOwnPropertyDescriptor','cardNumber','../services/gateways/testGatewayService','SINGLE','getPaymentForm','290520ASdqCh','processCard','default','failureMessage','Webhook\x20event\x20','\x20with\x20status\x20','customerName','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway_','2AlzvyS','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'];a15_0xdab4=function(){return _0x2708c8;};return a15_0xdab4();}var __createBinding=this&&this['__createBinding']||(Object[a15_0x4f18dc(0x143)]?function(_0x191271,_0x5901c0,_0x3c0822,_0x255649){const _0x341198=a15_0x4f18dc;if(_0x255649===undefined)_0x255649=_0x3c0822;var _0x29053a=Object[_0x341198(0x12a)](_0x5901c0,_0x3c0822);(!_0x29053a||('get'in _0x29053a?!_0x5901c0[_0x341198(0x161)]:_0x29053a[_0x341198(0x14b)]||_0x29053a['configurable']))&&(_0x29053a={'enumerable':!![],'get':function(){return _0x5901c0[_0x3c0822];}}),Object[_0x341198(0x106)](_0x191271,_0x255649,_0x29053a);}:function(_0x4abdfd,_0x30650e,_0x4a041e,_0x388ac0){if(_0x388ac0===undefined)_0x388ac0=_0x4a041e;_0x4abdfd[_0x388ac0]=_0x30650e[_0x4a041e];}),__setModuleDefault=this&&this[a15_0x4f18dc(0x158)]||(Object[a15_0x4f18dc(0x143)]?function(_0x19028f,_0x4b7cc6){const _0x1f7e33=a15_0x4f18dc;Object['defineProperty'](_0x19028f,_0x1f7e33(0x131),{'enumerable':!![],'value':_0x4b7cc6});}:function(_0x3af389,_0xd6bb7f){const _0x67b7c9=a15_0x4f18dc;_0x3af389[_0x67b7c9(0x131)]=_0xd6bb7f;}),__importStar=this&&this[a15_0x4f18dc(0x116)]||(function(){var _0x5e6d43=function(_0x2bdc06){const _0x2dc4e9=a15_0x1df1;return _0x5e6d43=Object[_0x2dc4e9(0xf9)]||function(_0x119127){const _0x5e5134=_0x2dc4e9;var _0x5325fe=[];for(var _0x3110de in _0x119127)if(Object[_0x5e5134(0x118)][_0x5e5134(0x15f)][_0x5e5134(0x13a)](_0x119127,_0x3110de))_0x5325fe[_0x5325fe[_0x5e5134(0x140)]]=_0x3110de;return _0x5325fe;},_0x5e6d43(_0x2bdc06);};return function(_0x41bac9){const _0xbb2363=a15_0x1df1;if(_0x41bac9&&_0x41bac9[_0xbb2363(0x161)])return _0x41bac9;var _0x3123fd={};if(_0x41bac9!=null){for(var _0x13c7b7=_0x5e6d43(_0x41bac9),_0x100394=0x0;_0x100394<_0x13c7b7[_0xbb2363(0x140)];_0x100394++)if(_0x13c7b7[_0x100394]!==_0xbb2363(0x131))__createBinding(_0x3123fd,_0x41bac9,_0x13c7b7[_0x100394]);}return __setModuleDefault(_0x3123fd,_0x41bac9),_0x3123fd;};}()),__importDefault=this&&this['__importDefault']||function(_0x388de5){const _0x1aa560=a15_0x4f18dc;return _0x388de5&&_0x388de5[_0x1aa560(0x161)]?_0x388de5:{'default':_0x388de5};};Object[a15_0x4f18dc(0x106)](exports,a15_0x4f18dc(0x161),{'value':!![]}),exports[a15_0x4f18dc(0x156)]=void 0x0;const testGatewayService_1=require(a15_0x4f18dc(0x12c)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));function a15_0x1df1(_0x953174,_0x4d5ac2){const _0xdab4eb=a15_0xdab4();return a15_0x1df1=function(_0x1df107,_0x5bf024){_0x1df107=_0x1df107-0xf4;let _0x429aad=_0xdab4eb[_0x1df107];return _0x429aad;},a15_0x1df1(_0x953174,_0x4d5ac2);}class TestGatewayController{constructor(){const _0x15eb63=a15_0x4f18dc;this[_0x15eb63(0x12e)]=async(_0x5055cb,_0x929347,_0x59ec49)=>{const _0x1a5d77=_0x15eb63;try{const {paymentId:_0x3b2d18}=_0x5055cb[_0x1a5d77(0x167)];console[_0x1a5d77(0x104)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x3b2d18);const _0xd24a18=await database_1[_0x1a5d77(0x131)][_0x1a5d77(0xf4)][_0x1a5d77(0x120)]({'where':{'id':_0x3b2d18},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0xd24a18)return _0x929347['status'](0x194)['json']({'success':![],'message':_0x1a5d77(0x162)});if(_0xd24a18['gateway']!=='test_gateway')return _0x929347[_0x1a5d77(0x14d)](0x190)[_0x1a5d77(0x122)]({'success':![],'message':_0x1a5d77(0x136)});if(_0xd24a18['status']!==_0x1a5d77(0x10a))return _0x929347[_0x1a5d77(0x14d)](0x190)[_0x1a5d77(0x122)]({'success':![],'message':_0x1a5d77(0x127)+_0xd24a18['status']+_0x1a5d77(0x153)});_0x929347[_0x1a5d77(0x122)]({'success':!![],'result':{'paymentId':_0xd24a18['id'],'orderId':_0xd24a18[_0x1a5d77(0x10b)],'amount':_0xd24a18[_0x1a5d77(0x11c)],'currency':_0xd24a18[_0x1a5d77(0x15d)],'merchantName':_0xd24a18[_0x1a5d77(0x13d)][_0x1a5d77(0x107)],'description':_0x1a5d77(0x14f)+_0xd24a18['shop'][_0x1a5d77(0x107)],'testInstructions':{'successCard':_0x1a5d77(0x103),'failureCard':_0x1a5d77(0x10c),'expiryDate':_0x1a5d77(0x142),'cvc':'Any\x203-4\x20digits','holderName':_0x1a5d77(0x13f)}}});}catch(_0x3dfa41){_0x59ec49(_0x3dfa41);}},this[_0x15eb63(0x130)]=async(_0x41ba02,_0x10ddc3,_0x2e5abe)=>{const _0x2ace6f=_0x15eb63;try{const {paymentId:_0x10462a}=_0x41ba02[_0x2ace6f(0x167)],_0x5e29e3=_0x41ba02[_0x2ace6f(0x126)];console[_0x2ace6f(0x104)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x10462a);const _0x5adc62=await database_1[_0x2ace6f(0x131)][_0x2ace6f(0xf4)]['findUnique']({'where':{'id':_0x10462a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5adc62)return _0x10ddc3['status'](0x194)[_0x2ace6f(0x122)]({'success':![],'message':_0x2ace6f(0x162)});if(_0x5adc62[_0x2ace6f(0x112)]!==_0x2ace6f(0x154))return _0x10ddc3[_0x2ace6f(0x14d)](0x190)[_0x2ace6f(0x122)]({'success':![],'message':_0x2ace6f(0x136)});if(_0x5adc62[_0x2ace6f(0x14d)]!=='PENDING')return _0x10ddc3['status'](0x190)[_0x2ace6f(0x122)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5adc62['status']+',\x20cannot\x20process'});const _0x46e8b8=await this[_0x2ace6f(0x125)][_0x2ace6f(0x11d)]({'paymentId':_0x5adc62['id'],'orderId':_0x5adc62['gatewayOrderId']||_0x5adc62['id'],'amount':_0x5adc62[_0x2ace6f(0x11c)],'currency':_0x5adc62[_0x2ace6f(0x15d)],'cardData':_0x5e29e3});console['log']('🧪\x20Test\x20Gateway\x20result:',_0x46e8b8);const _0x54e51b={'status':_0x46e8b8[_0x2ace6f(0x14d)],'updatedAt':new Date()};if(_0x46e8b8[_0x2ace6f(0x14d)]===_0x2ace6f(0x110))_0x54e51b[_0x2ace6f(0x117)]=new Date(),_0x54e51b[_0x2ace6f(0x166)]=_0x46e8b8[_0x2ace6f(0xf6)];else _0x46e8b8[_0x2ace6f(0x14d)]===_0x2ace6f(0xfc)&&(_0x54e51b[_0x2ace6f(0x132)]=_0x46e8b8[_0x2ace6f(0x128)]);const _0x59ddb9=_0x5e29e3[_0x2ace6f(0x12b)][_0x2ace6f(0x101)](/[\s-]/g,'');_0x54e51b['cardLast4']=_0x59ddb9[_0x2ace6f(0x157)](-0x4),_0x54e51b[_0x2ace6f(0x169)]=_0x2ace6f(0x105),await database_1['default'][_0x2ace6f(0xf4)][_0x2ace6f(0x164)]({'where':{'id':_0x5adc62['id']},'data':_0x54e51b});if(_0x46e8b8['status']==='PAID'&&_0x5adc62[_0x2ace6f(0x15a)]){console[_0x2ace6f(0x104)](_0x2ace6f(0xf8)+_0x5adc62['id']+_0x2ace6f(0x109));try{await database_1[_0x2ace6f(0x131)]['$transaction'](async _0x2af912=>{const _0xa0af95=_0x2ace6f,_0x3a9778=await _0x2af912[_0xa0af95(0x124)]['findUnique']({'where':{'id':_0x5adc62[_0xa0af95(0x15a)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3a9778){console[_0xa0af95(0x104)]('📈\x20Found\x20payment\x20link\x20'+_0x3a9778['id']+_0xa0af95(0x152)+_0x3a9778[_0xa0af95(0x108)]+_0xa0af95(0x10e)+_0x3a9778[_0xa0af95(0x14c)]+_0xa0af95(0x163)+_0x3a9778[_0xa0af95(0x14d)]);const _0x542c0c=_0x3a9778[_0xa0af95(0x14c)]+0x1,_0x1633eb=_0x3a9778[_0xa0af95(0x108)]===_0xa0af95(0x12d)?_0xa0af95(0x14a):_0x3a9778['status'];await _0x2af912[_0xa0af95(0x124)][_0xa0af95(0x164)]({'where':{'id':_0x5adc62[_0xa0af95(0x15a)]},'data':{'currentPayments':_0x542c0c,'status':_0x1633eb,'updatedAt':new Date()}}),console['log'](_0xa0af95(0x121)+_0x3a9778['id']+'\x20updated:\x20currentPayments='+_0x3a9778[_0xa0af95(0x14c)]+_0xa0af95(0xff)+_0x542c0c+_0xa0af95(0x163)+_0x3a9778[_0xa0af95(0x14d)]+_0xa0af95(0xff)+_0x1633eb);}else console[_0xa0af95(0x104)]('❌\x20Payment\x20link\x20'+_0x5adc62['paymentLinkId']+_0xa0af95(0x145));});}catch(_0x17545f){console[_0x2ace6f(0x15e)](_0x2ace6f(0x159),_0x17545f);}}await database_1[_0x2ace6f(0x131)][_0x2ace6f(0x155)][_0x2ace6f(0x143)]({'data':{'paymentId':_0x5adc62['id'],'shopId':_0x5adc62['shopId'],'event':_0x2ace6f(0x137)+_0x46e8b8[_0x2ace6f(0x14d)][_0x2ace6f(0xfd)](),'statusCode':0xc8,'responseBody':JSON[_0x2ace6f(0xf5)]({'oldStatus':_0x2ace6f(0x10a),'newStatus':_0x46e8b8[_0x2ace6f(0x14d)],'transactionId':_0x46e8b8[_0x2ace6f(0xf6)],'failureReason':_0x46e8b8['failureReason'],'processedAt':new Date()[_0x2ace6f(0xfe)]()})}}),await this[_0x2ace6f(0x160)](_0x5adc62,_0x46e8b8[_0x2ace6f(0x14d)],_0x46e8b8[_0x2ace6f(0xf6)],_0x46e8b8[_0x2ace6f(0x128)]),await this[_0x2ace6f(0x111)](_0x5adc62,_0x46e8b8[_0x2ace6f(0x14d)]),console[_0x2ace6f(0x104)]('✅\x20Test\x20Gateway\x20payment\x20'+_0x10462a+_0x2ace6f(0x129)+_0x46e8b8['status']),_0x46e8b8[_0x2ace6f(0x14d)]==='PAID'?_0x10ddc3[_0x2ace6f(0x122)]({'success':!![],'message':_0x2ace6f(0xfb),'result':{'status':_0x2ace6f(0x110),'transactionId':_0x46e8b8['transactionId'],'redirectUrl':_0x5adc62[_0x2ace6f(0x150)]}}):_0x10ddc3[_0x2ace6f(0x14d)](0x190)[_0x2ace6f(0x122)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x46e8b8['failureReason'],'redirectUrl':_0x5adc62[_0x2ace6f(0x100)]}});}catch(_0x44c94c){_0x2e5abe(_0x44c94c);}},this[_0x15eb63(0x125)]=new testGatewayService_1['TestGatewayService'](),this[_0x15eb63(0x119)]=new webhookService_1['WebhookService']();}async[a15_0x4f18dc(0x160)](_0x3f3364,_0x2425b5,_0x495982,_0x5c39bc){const _0x3bc00b=a15_0x4f18dc,_0x342ab6=Date[_0x3bc00b(0x10d)]();try{const _0x5b7229=_0x3f3364[_0x3bc00b(0x13d)],_0x228a3c=_0x5b7229[_0x3bc00b(0x11a)];if(!_0x228a3c?.['webhookUrl']){console['log'](_0x3bc00b(0x139)+_0x5b7229['id']);return;}const _0x1ee09a=_0x2425b5===_0x3bc00b(0x110)?_0x3bc00b(0x11f):_0x3bc00b(0x13e);let _0x40c178=[];if(_0x228a3c[_0x3bc00b(0x10f)])try{_0x40c178=Array['isArray'](_0x228a3c[_0x3bc00b(0x10f)])?_0x228a3c[_0x3bc00b(0x10f)]:JSON['parse'](_0x228a3c['webhookEvents']);}catch(_0x5ad52f){console[_0x3bc00b(0x15e)](_0x3bc00b(0x16a),_0x5ad52f),_0x40c178=[];}if(!_0x40c178[_0x3bc00b(0x149)](_0x1ee09a)){console[_0x3bc00b(0x104)](_0x3bc00b(0x133)+_0x1ee09a+_0x3bc00b(0x113)+_0x5b7229['id']);return;}const _0x160bf5={'event':_0x1ee09a,'payment':{'id':_0x3f3364['id'],'order_id':_0x3f3364['orderId'],'gateway_order_id':_0x3f3364[_0x3bc00b(0x10b)],'gateway':_0x3bc00b(0x11e),'amount':_0x3f3364[_0x3bc00b(0x11c)],'currency':_0x3f3364[_0x3bc00b(0x15d)],'status':_0x2425b5[_0x3bc00b(0xfd)](),'customer_email':_0x3f3364[_0x3bc00b(0x15c)],'customer_name':_0x3f3364[_0x3bc00b(0x135)],'transaction_id':_0x495982,'failure_message':_0x5c39bc,'created_at':_0x3f3364['createdAt'],'updated_at':new Date()}},_0x4e1bd5=await fetch(_0x228a3c[_0x3bc00b(0x151)],{'method':'POST','headers':{'Content-Type':_0x3bc00b(0x13b),'User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3bc00b(0xf5)](_0x160bf5)}),_0x51bcd7=Date['now']()-_0x342ab6;console[_0x3bc00b(0x104)](_0x3bc00b(0x144)+_0x228a3c[_0x3bc00b(0x151)]+_0x3bc00b(0x134)+_0x4e1bd5[_0x3bc00b(0x14d)]+'\x20('+_0x51bcd7+'ms)');}catch(_0x54eb91){console[_0x3bc00b(0x15e)](_0x3bc00b(0x15b),_0x54eb91);}}async[a15_0x4f18dc(0x111)](_0x16a43d,_0x47bec0){const _0x48399e=a15_0x4f18dc;try{const {telegramBotService:_0x5bf191}=await Promise[_0x48399e(0x114)]()[_0x48399e(0x141)](()=>__importStar(require(_0x48399e(0x115)))),_0x8d102c={'PAID':_0x48399e(0xfa),'FAILED':'failed'},_0x2b6574=_0x8d102c[_0x47bec0];if(!_0x2b6574)return;await _0x5bf191[_0x48399e(0x123)](_0x16a43d[_0x48399e(0x11b)],_0x16a43d,_0x2b6574);}catch(_0x22b225){console['error'](_0x48399e(0x102),_0x22b225);}}}exports['TestGatewayController']=TestGatewayController;