'use strict';const a13_0x55ce4e=a13_0x26ac;(function(_0x23248b,_0x22c028){const _0x13ee7d=a13_0x26ac,_0x1ad8d5=_0x23248b();while(!![]){try{const _0x15ce64=parseInt(_0x13ee7d(0x8c))/0x1*(-parseInt(_0x13ee7d(0x7e))/0x2)+parseInt(_0x13ee7d(0x96))/0x3+parseInt(_0x13ee7d(0xcd))/0x4*(parseInt(_0x13ee7d(0x75))/0x5)+parseInt(_0x13ee7d(0xba))/0x6*(-parseInt(_0x13ee7d(0xa4))/0x7)+parseInt(_0x13ee7d(0xa7))/0x8+parseInt(_0x13ee7d(0xab))/0x9+parseInt(_0x13ee7d(0xe3))/0xa*(-parseInt(_0x13ee7d(0xd4))/0xb);if(_0x15ce64===_0x22c028)break;else _0x1ad8d5['push'](_0x1ad8d5['shift']());}catch(_0x1aea9e){_0x1ad8d5['push'](_0x1ad8d5['shift']());}}}(a13_0x5829,0xe303d));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x1d05d3,_0x591d2e,_0x3eb2c5,_0x2a959b){const _0x395d28=a13_0x26ac;if(_0x2a959b===undefined)_0x2a959b=_0x3eb2c5;var _0x4c4612=Object[_0x395d28(0xd1)](_0x591d2e,_0x3eb2c5);(!_0x4c4612||(_0x395d28(0xee)in _0x4c4612?!_0x591d2e[_0x395d28(0x9a)]:_0x4c4612['writable']||_0x4c4612[_0x395d28(0x74)]))&&(_0x4c4612={'enumerable':!![],'get':function(){return _0x591d2e[_0x3eb2c5];}}),Object[_0x395d28(0xa6)](_0x1d05d3,_0x2a959b,_0x4c4612);}:function(_0x5bcba8,_0x4bb8a0,_0x532934,_0x16eb3b){if(_0x16eb3b===undefined)_0x16eb3b=_0x532934;_0x5bcba8[_0x16eb3b]=_0x4bb8a0[_0x532934];}),__setModuleDefault=this&&this[a13_0x55ce4e(0xbc)]||(Object[a13_0x55ce4e(0xe6)]?function(_0x24101f,_0x10f14e){const _0x525211=a13_0x55ce4e;Object[_0x525211(0xa6)](_0x24101f,_0x525211(0x97),{'enumerable':!![],'value':_0x10f14e});}:function(_0x4c43ad,_0x24e02a){const _0x148887=a13_0x55ce4e;_0x4c43ad[_0x148887(0x97)]=_0x24e02a;}),__importStar=this&&this[a13_0x55ce4e(0xcb)]||(function(){var _0xb3ed6a=function(_0x15e32b){const _0x5768b2=a13_0x26ac;return _0xb3ed6a=Object[_0x5768b2(0x83)]||function(_0x3898f6){const _0x32c6a1=_0x5768b2;var _0x12a0e9=[];for(var _0x4c5c6f in _0x3898f6)if(Object['prototype'][_0x32c6a1(0xc4)]['call'](_0x3898f6,_0x4c5c6f))_0x12a0e9[_0x12a0e9['length']]=_0x4c5c6f;return _0x12a0e9;},_0xb3ed6a(_0x15e32b);};return function(_0x4c2c9c){const _0x3c75c0=a13_0x26ac;if(_0x4c2c9c&&_0x4c2c9c[_0x3c75c0(0x9a)])return _0x4c2c9c;var _0x2c6368={};if(_0x4c2c9c!=null){for(var _0x439a1f=_0xb3ed6a(_0x4c2c9c),_0x2de95d=0x0;_0x2de95d<_0x439a1f[_0x3c75c0(0x9f)];_0x2de95d++)if(_0x439a1f[_0x2de95d]!=='default')__createBinding(_0x2c6368,_0x4c2c9c,_0x439a1f[_0x2de95d]);}return __setModuleDefault(_0x2c6368,_0x4c2c9c),_0x2c6368;};}()),__importDefault=this&&this[a13_0x55ce4e(0xc2)]||function(_0x5f1c47){const _0x445673=a13_0x55ce4e;return _0x5f1c47&&_0x5f1c47[_0x445673(0x9a)]?_0x5f1c47:{'default':_0x5f1c47};};Object[a13_0x55ce4e(0xa6)](exports,a13_0x55ce4e(0x9a),{'value':!![]}),exports['TestGatewayController']=void 0x0;function a13_0x5829(){const _0x10ca66=['__importDefault','Payment\x20status\x20is\x20','hasOwnProperty','slice','4242\x204242\x204242\x204242','update','../services/gateways/testGatewayService','WebhookService','customerEmail','__importStar','TestGatewayService','12UwwncT','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','Payment\x20processed\x20successfully','webhookService','getOwnPropertyDescriptor','\x20not\x20found','\x20updated:\x20currentPayments=','165RucLEB','sendPaymentNotification','test_gateway_','\x20with\x20status\x20','processCard','PAID',':\x20type=','🧪\x20Test\x20Gateway\x20result:','paymentMethod','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','replace','sendShopWebhook','$transaction','payment.failed','testGatewayService','291530FTEQXf','PENDING','then','create','currency','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','type','gatewayPaymentId','error','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','stringify','get','test_card','configurable','1234535RuCjhW','log','\x20->\x20','createdAt',',\x20cannot\x20process','gatewayOrderId','parse','test_gateway','POST','54cvcbvJ','Test\x20Gateway\x20webhook\x20sent\x20to\x20','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20to\x20','Any\x203-4\x20digits','getOwnPropertyNames','status','amount','orderId','toLowerCase','now','settings','webhookLog','successUrl','45137aVkfkT','shopId','Payment\x20is\x20not\x20for\x20test\x20gateway','gateway','✅\x20Test\x20Gateway\x20payment\x20','shop','Any\x20other\x20card\x20number','📈\x20Test\x20Gateway:\x20Payment\x20','payment','\x20processed:\x20','1764765irBlHh','default','failed','findUnique','__esModule','failureReason','params','paid','customerName','length','ms)','SINGLE','name','webhookEvents','12464921MRplxp','📈\x20Found\x20payment\x20link\x20','defineProperty','11133312CRTuzW','body','Any\x20future\x20date\x20(MM/YY)','../services/webhookService','14813190vCCZvh','json',',\x20currentPayments=','cardLast4','FAILED','❌\x20Payment\x20link\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentStatusNotification','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','includes','Payment\x20not\x20found','transactionId','paymentLinkId','../config/database','Error\x20parsing\x20webhook\x20events:','6fuZOrF','../services/telegramBotService','__setModuleDefault','getPaymentForm','webhookUrl','currentPayments','COMPLETED','failUrl'];a13_0x5829=function(){return _0x10ca66;};return a13_0x5829();}function a13_0x26ac(_0x490e4b,_0xfc635b){const _0x582981=a13_0x5829();return a13_0x26ac=function(_0x26ac18,_0xf74145){_0x26ac18=_0x26ac18-0x74;let _0x5896ed=_0x582981[_0x26ac18];return _0x5896ed;},a13_0x26ac(_0x490e4b,_0xfc635b);}const testGatewayService_1=require(a13_0x55ce4e(0xc8)),webhookService_1=require(a13_0x55ce4e(0xaa)),database_1=__importDefault(require(a13_0x55ce4e(0xb8)));class TestGatewayController{constructor(){const _0x1698da=a13_0x55ce4e;this[_0x1698da(0xbd)]=async(_0x211cf4,_0x2f2cb0,_0x3ff5bc)=>{const _0x271cbd=_0x1698da;try{const {paymentId:_0x47e4a4}=_0x211cf4[_0x271cbd(0x9c)];console[_0x271cbd(0x76)](_0x271cbd(0xb3)+_0x47e4a4);const _0x1da128=await database_1[_0x271cbd(0x97)][_0x271cbd(0x94)]['findUnique']({'where':{'id':_0x47e4a4},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1da128)return _0x2f2cb0[_0x271cbd(0x84)](0x194)[_0x271cbd(0xac)]({'success':![],'message':_0x271cbd(0xb5)});if(_0x1da128[_0x271cbd(0x8f)]!==_0x271cbd(0x7c))return _0x2f2cb0['status'](0x190)[_0x271cbd(0xac)]({'success':![],'message':_0x271cbd(0x8e)});if(_0x1da128[_0x271cbd(0x84)]!==_0x271cbd(0xe4))return _0x2f2cb0[_0x271cbd(0x84)](0x190)[_0x271cbd(0xac)]({'success':![],'message':_0x271cbd(0xc3)+_0x1da128['status']+_0x271cbd(0x79)});_0x2f2cb0[_0x271cbd(0xac)]({'success':!![],'result':{'paymentId':_0x1da128['id'],'orderId':_0x1da128['gatewayOrderId'],'amount':_0x1da128[_0x271cbd(0x85)],'currency':_0x1da128['currency'],'merchantName':_0x1da128[_0x271cbd(0x91)][_0x271cbd(0xa2)],'description':_0x271cbd(0x81)+_0x1da128[_0x271cbd(0x91)][_0x271cbd(0xa2)],'testInstructions':{'successCard':_0x271cbd(0xc6),'failureCard':_0x271cbd(0x92),'expiryDate':_0x271cbd(0xa9),'cvc':_0x271cbd(0x82),'holderName':'Any\x20name'}}});}catch(_0x459a4c){_0x3ff5bc(_0x459a4c);}},this[_0x1698da(0xd8)]=async(_0x5a640c,_0x2b3c05,_0x27f969)=>{const _0x504020=_0x1698da;try{const {paymentId:_0x3eec45}=_0x5a640c[_0x504020(0x9c)],_0x505713=_0x5a640c[_0x504020(0xa8)];console[_0x504020(0x76)](_0x504020(0x80)+_0x3eec45);const _0x800d38=await database_1[_0x504020(0x97)][_0x504020(0x94)]['findUnique']({'where':{'id':_0x3eec45},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x800d38)return _0x2b3c05[_0x504020(0x84)](0x194)[_0x504020(0xac)]({'success':![],'message':_0x504020(0xb5)});if(_0x800d38['gateway']!==_0x504020(0x7c))return _0x2b3c05[_0x504020(0x84)](0x190)['json']({'success':![],'message':_0x504020(0x8e)});if(_0x800d38['status']!==_0x504020(0xe4))return _0x2b3c05[_0x504020(0x84)](0x190)[_0x504020(0xac)]({'success':![],'message':_0x504020(0xc3)+_0x800d38[_0x504020(0x84)]+_0x504020(0x79)});const _0xb76796=await this[_0x504020(0xe2)]['processCardPayment']({'paymentId':_0x800d38['id'],'orderId':_0x800d38['gatewayOrderId']||_0x800d38['id'],'amount':_0x800d38[_0x504020(0x85)],'currency':_0x800d38['currency'],'cardData':_0x505713});console[_0x504020(0x76)](_0x504020(0xdb),_0xb76796);const _0x2a4625={'status':_0xb76796[_0x504020(0x84)],'updatedAt':new Date()};if(_0xb76796[_0x504020(0x84)]===_0x504020(0xd9))_0x2a4625['paidAt']=new Date(),_0x2a4625[_0x504020(0xea)]=_0xb76796[_0x504020(0xb6)];else _0xb76796[_0x504020(0x84)]===_0x504020(0xaf)&&(_0x2a4625['failureMessage']=_0xb76796[_0x504020(0x9b)]);const _0x58d97f=_0x505713['cardNumber'][_0x504020(0xde)](/[\s-]/g,'');_0x2a4625[_0x504020(0xae)]=_0x58d97f[_0x504020(0xc5)](-0x4),_0x2a4625[_0x504020(0xdc)]=_0x504020(0xef),await database_1[_0x504020(0x97)][_0x504020(0x94)][_0x504020(0xc7)]({'where':{'id':_0x800d38['id']},'data':_0x2a4625});if(_0xb76796[_0x504020(0x84)]==='PAID'&&_0x800d38[_0x504020(0xb7)]){console[_0x504020(0x76)](_0x504020(0x93)+_0x800d38['id']+_0x504020(0xec));try{await database_1[_0x504020(0x97)][_0x504020(0xe0)](async _0x30df2c=>{const _0xeaa0b0=_0x504020,_0x15801a=await _0x30df2c['paymentLink'][_0xeaa0b0(0x99)]({'where':{'id':_0x800d38[_0xeaa0b0(0xb7)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x15801a){console[_0xeaa0b0(0x76)](_0xeaa0b0(0xa5)+_0x15801a['id']+_0xeaa0b0(0xda)+_0x15801a[_0xeaa0b0(0xe9)]+_0xeaa0b0(0xad)+_0x15801a[_0xeaa0b0(0xbf)]+',\x20status='+_0x15801a[_0xeaa0b0(0x84)]);const _0x620cdf=_0x15801a[_0xeaa0b0(0xbf)]+0x1,_0x2bdc99=_0x15801a[_0xeaa0b0(0xe9)]===_0xeaa0b0(0xa1)?_0xeaa0b0(0xc0):_0x15801a[_0xeaa0b0(0x84)];await _0x30df2c['paymentLink'][_0xeaa0b0(0xc7)]({'where':{'id':_0x800d38['paymentLinkId']},'data':{'currentPayments':_0x620cdf,'status':_0x2bdc99,'updatedAt':new Date()}}),console[_0xeaa0b0(0x76)]('✅\x20Payment\x20link\x20'+_0x15801a['id']+_0xeaa0b0(0xd3)+_0x15801a['currentPayments']+'\x20->\x20'+_0x620cdf+',\x20status='+_0x15801a['status']+_0xeaa0b0(0x77)+_0x2bdc99);}else console[_0xeaa0b0(0x76)](_0xeaa0b0(0xb0)+_0x800d38['paymentLinkId']+_0xeaa0b0(0xd2));});}catch(_0x12edac){console['error'](_0x504020(0xce),_0x12edac);}}await database_1[_0x504020(0x97)][_0x504020(0x8a)]['create']({'data':{'paymentId':_0x800d38['id'],'shopId':_0x800d38[_0x504020(0x8d)],'event':_0x504020(0xd6)+_0xb76796[_0x504020(0x84)][_0x504020(0x87)](),'statusCode':0xc8,'responseBody':JSON[_0x504020(0xed)]({'oldStatus':_0x504020(0xe4),'newStatus':_0xb76796[_0x504020(0x84)],'transactionId':_0xb76796[_0x504020(0xb6)],'failureReason':_0xb76796['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x504020(0xdf)](_0x800d38,_0xb76796['status'],_0xb76796[_0x504020(0xb6)],_0xb76796[_0x504020(0x9b)]),await this[_0x504020(0xb2)](_0x800d38,_0xb76796[_0x504020(0x84)]),console[_0x504020(0x76)](_0x504020(0x90)+_0x3eec45+_0x504020(0x95)+_0xb76796[_0x504020(0x84)]),_0xb76796['status']===_0x504020(0xd9)?_0x2b3c05['json']({'success':!![],'message':_0x504020(0xcf),'result':{'status':'PAID','transactionId':_0xb76796[_0x504020(0xb6)],'redirectUrl':_0x800d38[_0x504020(0x8b)]}}):_0x2b3c05[_0x504020(0x84)](0x190)[_0x504020(0xac)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x504020(0xaf),'failureReason':_0xb76796[_0x504020(0x9b)],'redirectUrl':_0x800d38[_0x504020(0xc1)]}});}catch(_0x5eb989){_0x27f969(_0x5eb989);}},this[_0x1698da(0xe2)]=new testGatewayService_1[(_0x1698da(0xcc))](),this[_0x1698da(0xd0)]=new webhookService_1[(_0x1698da(0xc9))]();}async[a13_0x55ce4e(0xdf)](_0x57eb50,_0x573233,_0x41ec2b,_0xbcea57){const _0xcfd659=a13_0x55ce4e,_0x5cac23=Date[_0xcfd659(0x88)]();try{const _0x286388=_0x57eb50['shop'],_0x141bd9=_0x286388[_0xcfd659(0x89)];if(!_0x141bd9?.[_0xcfd659(0xbe)]){console[_0xcfd659(0x76)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x286388['id']);return;}const _0x4ecfc1=_0x573233===_0xcfd659(0xd9)?'payment.success':_0xcfd659(0xe1);let _0x4b5db2=[];if(_0x141bd9[_0xcfd659(0xa3)])try{_0x4b5db2=Array['isArray'](_0x141bd9[_0xcfd659(0xa3)])?_0x141bd9[_0xcfd659(0xa3)]:JSON[_0xcfd659(0x7b)](_0x141bd9[_0xcfd659(0xa3)]);}catch(_0x3629ec){console[_0xcfd659(0xeb)](_0xcfd659(0xb9),_0x3629ec),_0x4b5db2=[];}if(!_0x4b5db2[_0xcfd659(0xb4)](_0x4ecfc1)){console[_0xcfd659(0x76)]('Webhook\x20event\x20'+_0x4ecfc1+'\x20not\x20enabled\x20for\x20shop\x20'+_0x286388['id']);return;}const _0x3a1492={'event':_0x4ecfc1,'payment':{'id':_0x57eb50['id'],'order_id':_0x57eb50[_0xcfd659(0x86)],'gateway_order_id':_0x57eb50[_0xcfd659(0x7a)],'gateway':'0000','amount':_0x57eb50[_0xcfd659(0x85)],'currency':_0x57eb50[_0xcfd659(0xe7)],'status':_0x573233[_0xcfd659(0x87)](),'customer_email':_0x57eb50[_0xcfd659(0xca)],'customer_name':_0x57eb50[_0xcfd659(0x9e)],'transaction_id':_0x41ec2b,'failure_message':_0xbcea57,'created_at':_0x57eb50[_0xcfd659(0x78)],'updated_at':new Date()}},_0x2161ba=await fetch(_0x141bd9[_0xcfd659(0xbe)],{'method':_0xcfd659(0x7d),'headers':{'Content-Type':'application/json','User-Agent':_0xcfd659(0xe8)},'body':JSON[_0xcfd659(0xed)](_0x3a1492)}),_0x43ea37=Date[_0xcfd659(0x88)]()-_0x5cac23;console['log'](_0xcfd659(0x7f)+_0x141bd9[_0xcfd659(0xbe)]+_0xcfd659(0xd7)+_0x2161ba[_0xcfd659(0x84)]+'\x20('+_0x43ea37+_0xcfd659(0xa0));}catch(_0xe1657f){console[_0xcfd659(0xeb)](_0xcfd659(0xdd),_0xe1657f);}}async[a13_0x55ce4e(0xb2)](_0x40a016,_0x8032e2){const _0x30d714=a13_0x55ce4e;try{const {telegramBotService:_0x326be0}=await Promise['resolve']()[_0x30d714(0xe5)](()=>__importStar(require(_0x30d714(0xbb)))),_0x1cb765={'PAID':_0x30d714(0x9d),'FAILED':_0x30d714(0x98)},_0x4fd73f=_0x1cb765[_0x8032e2];if(!_0x4fd73f)return;await _0x326be0[_0x30d714(0xd5)](_0x40a016[_0x30d714(0x8d)],_0x40a016,_0x4fd73f);}catch(_0x4fdc55){console[_0x30d714(0xeb)](_0x30d714(0xb1),_0x4fdc55);}}}exports['TestGatewayController']=TestGatewayController;