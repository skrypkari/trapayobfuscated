'use strict';const a13_0x350398=a13_0x4977;(function(_0x31b2c2,_0x57dcd3){const _0x32c8ba=a13_0x4977,_0x14975d=_0x31b2c2();while(!![]){try{const _0x7280fb=parseInt(_0x32c8ba(0xf5))/0x1*(parseInt(_0x32c8ba(0xca))/0x2)+-parseInt(_0x32c8ba(0xae))/0x3+-parseInt(_0x32c8ba(0xdb))/0x4+parseInt(_0x32c8ba(0xd5))/0x5*(parseInt(_0x32c8ba(0xc2))/0x6)+parseInt(_0x32c8ba(0xeb))/0x7+parseInt(_0x32c8ba(0xe3))/0x8*(-parseInt(_0x32c8ba(0xa3))/0x9)+-parseInt(_0x32c8ba(0xf7))/0xa*(-parseInt(_0x32c8ba(0xe0))/0xb);if(_0x7280fb===_0x57dcd3)break;else _0x14975d['push'](_0x14975d['shift']());}catch(_0x3c2366){_0x14975d['push'](_0x14975d['shift']());}}}(a13_0x3510,0xb5e0e));function a13_0x4977(_0x1ba22a,_0x5ed16f){const _0x351044=a13_0x3510();return a13_0x4977=function(_0x4977ed,_0xfda4d5){_0x4977ed=_0x4977ed-0x9b;let _0x3d9169=_0x351044[_0x4977ed];return _0x3d9169;},a13_0x4977(_0x1ba22a,_0x5ed16f);}var __createBinding=this&&this[a13_0x350398(0xc4)]||(Object[a13_0x350398(0xf8)]?function(_0x2d44cd,_0x5530be,_0x2b64d4,_0x299afa){const _0x4452aa=a13_0x350398;if(_0x299afa===undefined)_0x299afa=_0x2b64d4;var _0x329ff1=Object[_0x4452aa(0xb7)](_0x5530be,_0x2b64d4);(!_0x329ff1||('get'in _0x329ff1?!_0x5530be[_0x4452aa(0xd7)]:_0x329ff1[_0x4452aa(0xc5)]||_0x329ff1[_0x4452aa(0xe4)]))&&(_0x329ff1={'enumerable':!![],'get':function(){return _0x5530be[_0x2b64d4];}}),Object['defineProperty'](_0x2d44cd,_0x299afa,_0x329ff1);}:function(_0x49a64a,_0x40a4e0,_0xa07a73,_0x138416){if(_0x138416===undefined)_0x138416=_0xa07a73;_0x49a64a[_0x138416]=_0x40a4e0[_0xa07a73];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x2aa9e5,_0xe6630c){const _0x4505d1=a13_0x350398;Object[_0x4505d1(0xa9)](_0x2aa9e5,'default',{'enumerable':!![],'value':_0xe6630c});}:function(_0x3a6c01,_0x23a778){_0x3a6c01['default']=_0x23a778;}),__importStar=this&&this[a13_0x350398(0xa6)]||(function(){var _0x33e594=function(_0x47a992){return _0x33e594=Object['getOwnPropertyNames']||function(_0x2c5b66){const _0x49cdc2=a13_0x4977;var _0x20b89b=[];for(var _0x4849f0 in _0x2c5b66)if(Object[_0x49cdc2(0xaa)]['hasOwnProperty']['call'](_0x2c5b66,_0x4849f0))_0x20b89b[_0x20b89b[_0x49cdc2(0xf6)]]=_0x4849f0;return _0x20b89b;},_0x33e594(_0x47a992);};return function(_0x567c6c){const _0x4c65e4=a13_0x4977;if(_0x567c6c&&_0x567c6c['__esModule'])return _0x567c6c;var _0xd08ba8={};if(_0x567c6c!=null){for(var _0x272117=_0x33e594(_0x567c6c),_0x1aa29c=0x0;_0x1aa29c<_0x272117['length'];_0x1aa29c++)if(_0x272117[_0x1aa29c]!==_0x4c65e4(0x9c))__createBinding(_0xd08ba8,_0x567c6c,_0x272117[_0x1aa29c]);}return __setModuleDefault(_0xd08ba8,_0x567c6c),_0xd08ba8;};}()),__importDefault=this&&this[a13_0x350398(0x104)]||function(_0x2a9196){return _0x2a9196&&_0x2a9196['__esModule']?_0x2a9196:{'default':_0x2a9196};};Object[a13_0x350398(0xa9)](exports,a13_0x350398(0xd7),{'value':!![]}),exports[a13_0x350398(0xff)]=void 0x0;function a13_0x3510(){const _0x556fd6=['failUrl','509658ULSJqH','length','10AEPEul','create','payment','POST','params','now','stringify','customerName','TestGatewayController',',\x20cannot\x20process','webhookUrl','cardNumber','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','__importDefault','amount','getPaymentForm','default','toLowerCase','test_gateway_','createdAt','application/json','body','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1062rvarwl','4242\x204242\x204242\x204242','isArray','__importStar','transactionId','test_gateway','defineProperty','prototype','WebhookService','Payment\x20status\x20is\x20','Payment\x20processed\x20successfully','2493429czXDWW','PENDING','findUnique','gateway','paidAt','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','0000','getOwnPropertyDescriptor','webhookService','ðŸ§ª\x20Test\x20Gateway\x20result:','PAID','Error\x20parsing\x20webhook\x20events:','Any\x203-4\x20digits','replace','../config/database','Webhook\x20event\x20','includes','customerEmail','131874rCqpqn','status','__createBinding','writable','shopId','âœ…\x20Test\x20Gateway\x20payment\x20','../services/telegramBotService','log','2OkwQYn','\x20not\x20enabled\x20for\x20shop\x20','processCard','webhookEvents','shop','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','orderId','FAILED','parse','name','slice','275BZDVhP','failed','__esModule','ms)','failureReason','Test\x20Gateway\x20webhook\x20sent\x20to\x20','5277436wuDgiR','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','currency','sendShopWebhook','Any\x20future\x20date\x20(MM/YY)','14133999zwMvHO','json','payment.failed','28376JJfpTX','configurable','Any\x20name','webhookLog','\x20processed:\x20','sendPaymentStatusNotification','resolve','successUrl','2174270bFRKjg','update','testGatewayService','cardLast4','gatewayPaymentId','payment.success','TestGatewayService','error','gatewayOrderId'];a13_0x3510=function(){return _0x556fd6;};return a13_0x3510();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x350398(0xbe)));class TestGatewayController{constructor(){const _0x3b6153=a13_0x350398;this[_0x3b6153(0x9b)]=async(_0x14c96c,_0x299134,_0x5257c5)=>{const _0x561b16=_0x3b6153;try{const {paymentId:_0x30b490}=_0x14c96c[_0x561b16(0xfb)];console[_0x561b16(0xc9)](_0x561b16(0x103)+_0x30b490);const _0x17126f=await database_1[_0x561b16(0x9c)][_0x561b16(0xf9)][_0x561b16(0xb0)]({'where':{'id':_0x30b490},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x17126f)return _0x299134[_0x561b16(0xc3)](0x194)[_0x561b16(0xe1)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x17126f[_0x561b16(0xb1)]!==_0x561b16(0xa8))return _0x299134[_0x561b16(0xc3)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x17126f['status']!=='PENDING')return _0x299134[_0x561b16(0xc3)](0x190)['json']({'success':![],'message':_0x561b16(0xac)+_0x17126f['status']+_0x561b16(0x100)});_0x299134[_0x561b16(0xe1)]({'success':!![],'result':{'paymentId':_0x17126f['id'],'orderId':_0x17126f['gatewayOrderId'],'amount':_0x17126f[_0x561b16(0x105)],'currency':_0x17126f[_0x561b16(0xdd)],'merchantName':_0x17126f['shop']['name'],'description':'Payment\x20to\x20'+_0x17126f[_0x561b16(0xce)][_0x561b16(0xd3)],'testInstructions':{'successCard':_0x561b16(0xa4),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x561b16(0xdf),'cvc':_0x561b16(0xbc),'holderName':_0x561b16(0xe5)}}});}catch(_0x22908d){_0x5257c5(_0x22908d);}},this[_0x3b6153(0xcc)]=async(_0x62833c,_0x322edb,_0xcb8e39)=>{const _0x2ec262=_0x3b6153;try{const {paymentId:_0x246c20}=_0x62833c[_0x2ec262(0xfb)],_0x39f2e5=_0x62833c[_0x2ec262(0xa1)];console[_0x2ec262(0xc9)](_0x2ec262(0xb3)+_0x246c20);const _0x3a48c5=await database_1['default'][_0x2ec262(0xf9)]['findUnique']({'where':{'id':_0x246c20},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3a48c5)return _0x322edb[_0x2ec262(0xc3)](0x194)[_0x2ec262(0xe1)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x3a48c5[_0x2ec262(0xb1)]!==_0x2ec262(0xa8))return _0x322edb['status'](0x190)[_0x2ec262(0xe1)]({'success':![],'message':_0x2ec262(0xb4)});if(_0x3a48c5[_0x2ec262(0xc3)]!==_0x2ec262(0xaf))return _0x322edb['status'](0x190)['json']({'success':![],'message':_0x2ec262(0xac)+_0x3a48c5['status']+_0x2ec262(0x100)});const _0x47f268=await this['testGatewayService']['processCardPayment']({'paymentId':_0x3a48c5['id'],'orderId':_0x3a48c5[_0x2ec262(0xf3)]||_0x3a48c5['id'],'amount':_0x3a48c5[_0x2ec262(0x105)],'currency':_0x3a48c5[_0x2ec262(0xdd)],'cardData':_0x39f2e5});console['log'](_0x2ec262(0xb9),_0x47f268);const _0x445de2={'status':_0x47f268['status'],'updatedAt':new Date()};if(_0x47f268[_0x2ec262(0xc3)]===_0x2ec262(0xba))_0x445de2[_0x2ec262(0xb2)]=new Date(),_0x445de2[_0x2ec262(0xef)]=_0x47f268['transactionId'];else _0x47f268['status']===_0x2ec262(0xd1)&&(_0x445de2['failureMessage']=_0x47f268[_0x2ec262(0xd9)]);const _0x1db3b3=_0x39f2e5[_0x2ec262(0x102)][_0x2ec262(0xbd)](/[\s-]/g,'');_0x445de2[_0x2ec262(0xee)]=_0x1db3b3[_0x2ec262(0xd4)](-0x4),_0x445de2['paymentMethod']='test_card',await database_1[_0x2ec262(0x9c)]['payment'][_0x2ec262(0xec)]({'where':{'id':_0x3a48c5['id']},'data':_0x445de2}),await database_1[_0x2ec262(0x9c)][_0x2ec262(0xe6)][_0x2ec262(0xf8)]({'data':{'paymentId':_0x3a48c5['id'],'shopId':_0x3a48c5[_0x2ec262(0xc6)],'event':_0x2ec262(0x9e)+_0x47f268[_0x2ec262(0xc3)][_0x2ec262(0x9d)](),'statusCode':0xc8,'responseBody':JSON[_0x2ec262(0xfd)]({'oldStatus':_0x2ec262(0xaf),'newStatus':_0x47f268[_0x2ec262(0xc3)],'transactionId':_0x47f268['transactionId'],'failureReason':_0x47f268[_0x2ec262(0xd9)],'processedAt':new Date()['toISOString']()})}}),await this[_0x2ec262(0xde)](_0x3a48c5,_0x47f268[_0x2ec262(0xc3)],_0x47f268[_0x2ec262(0xa7)],_0x47f268[_0x2ec262(0xd9)]),await this[_0x2ec262(0xe8)](_0x3a48c5,_0x47f268[_0x2ec262(0xc3)]),console[_0x2ec262(0xc9)](_0x2ec262(0xc7)+_0x246c20+_0x2ec262(0xe7)+_0x47f268[_0x2ec262(0xc3)]),_0x47f268['status']===_0x2ec262(0xba)?_0x322edb[_0x2ec262(0xe1)]({'success':!![],'message':_0x2ec262(0xad),'result':{'status':'PAID','transactionId':_0x47f268[_0x2ec262(0xa7)],'redirectUrl':_0x3a48c5[_0x2ec262(0xea)]}}):_0x322edb[_0x2ec262(0xc3)](0x190)[_0x2ec262(0xe1)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x2ec262(0xd1),'failureReason':_0x47f268[_0x2ec262(0xd9)],'redirectUrl':_0x3a48c5[_0x2ec262(0xf4)]}});}catch(_0x246bdc){_0xcb8e39(_0x246bdc);}},this[_0x3b6153(0xed)]=new testGatewayService_1[(_0x3b6153(0xf1))](),this[_0x3b6153(0xb8)]=new webhookService_1[(_0x3b6153(0xab))]();}async[a13_0x350398(0xde)](_0x14b14d,_0x3f998a,_0x55504f,_0x1093f6){const _0x4ca8cb=a13_0x350398,_0x2adf26=Date[_0x4ca8cb(0xfc)]();try{const _0x549e4d=_0x14b14d[_0x4ca8cb(0xce)],_0x2b5966=_0x549e4d['settings'];if(!_0x2b5966?.[_0x4ca8cb(0x101)]){console['log'](_0x4ca8cb(0xb5)+_0x549e4d['id']);return;}const _0x3a7caf=_0x3f998a===_0x4ca8cb(0xba)?_0x4ca8cb(0xf0):_0x4ca8cb(0xe2);let _0x38f511=[];if(_0x2b5966[_0x4ca8cb(0xcd)])try{_0x38f511=Array[_0x4ca8cb(0xa5)](_0x2b5966[_0x4ca8cb(0xcd)])?_0x2b5966['webhookEvents']:JSON[_0x4ca8cb(0xd2)](_0x2b5966[_0x4ca8cb(0xcd)]);}catch(_0x2867cb){console[_0x4ca8cb(0xf2)](_0x4ca8cb(0xbb),_0x2867cb),_0x38f511=[];}if(!_0x38f511[_0x4ca8cb(0xc0)](_0x3a7caf)){console['log'](_0x4ca8cb(0xbf)+_0x3a7caf+_0x4ca8cb(0xcb)+_0x549e4d['id']);return;}const _0x220d77={'event':_0x3a7caf,'payment':{'id':_0x14b14d['id'],'order_id':_0x14b14d[_0x4ca8cb(0xd0)],'gateway_order_id':_0x14b14d[_0x4ca8cb(0xf3)],'gateway':_0x4ca8cb(0xb6),'amount':_0x14b14d['amount'],'currency':_0x14b14d[_0x4ca8cb(0xdd)],'status':_0x3f998a[_0x4ca8cb(0x9d)](),'customer_email':_0x14b14d[_0x4ca8cb(0xc1)],'customer_name':_0x14b14d[_0x4ca8cb(0xfe)],'transaction_id':_0x55504f,'failure_message':_0x1093f6,'created_at':_0x14b14d[_0x4ca8cb(0x9f)],'updated_at':new Date()}},_0x3427c4=await fetch(_0x2b5966[_0x4ca8cb(0x101)],{'method':_0x4ca8cb(0xfa),'headers':{'Content-Type':_0x4ca8cb(0xa0),'User-Agent':_0x4ca8cb(0xcf)},'body':JSON[_0x4ca8cb(0xfd)](_0x220d77)}),_0x45af32=Date['now']()-_0x2adf26;console[_0x4ca8cb(0xc9)](_0x4ca8cb(0xda)+_0x2b5966[_0x4ca8cb(0x101)]+'\x20with\x20status\x20'+_0x3427c4[_0x4ca8cb(0xc3)]+'\x20('+_0x45af32+_0x4ca8cb(0xd8));}catch(_0x327485){console[_0x4ca8cb(0xf2)](_0x4ca8cb(0xdc),_0x327485);}}async[a13_0x350398(0xe8)](_0x4c3171,_0x1b8748){const _0x2ad245=a13_0x350398;try{const {telegramBotService:_0x37666f}=await Promise[_0x2ad245(0xe9)]()['then'](()=>__importStar(require(_0x2ad245(0xc8)))),_0x38119e={'PAID':'paid','FAILED':_0x2ad245(0xd6)},_0x4ca9d3=_0x38119e[_0x1b8748];if(!_0x4ca9d3)return;await _0x37666f['sendPaymentNotification'](_0x4c3171['shopId'],_0x4c3171,_0x4ca9d3);}catch(_0x55a0f4){console[_0x2ad245(0xf2)](_0x2ad245(0xa2),_0x55a0f4);}}}exports[a13_0x350398(0xff)]=TestGatewayController;