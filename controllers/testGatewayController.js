'use strict';function a14_0x3ed2(_0x24d30a,_0x3690a9){const _0x24552a=a14_0x2455();return a14_0x3ed2=function(_0x3ed2e5,_0x5a1d32){_0x3ed2e5=_0x3ed2e5-0xb4;let _0x3e3693=_0x24552a[_0x3ed2e5];return _0x3e3693;},a14_0x3ed2(_0x24d30a,_0x3690a9);}const a14_0x4774bf=a14_0x3ed2;(function(_0x10a1ef,_0x42fe83){const _0x3ce39c=a14_0x3ed2,_0x189d83=_0x10a1ef();while(!![]){try{const _0x58acdb=-parseInt(_0x3ce39c(0xe8))/0x1*(parseInt(_0x3ce39c(0x12d))/0x2)+-parseInt(_0x3ce39c(0x101))/0x3+parseInt(_0x3ce39c(0x10e))/0x4+parseInt(_0x3ce39c(0x125))/0x5*(-parseInt(_0x3ce39c(0xf5))/0x6)+-parseInt(_0x3ce39c(0xd9))/0x7*(-parseInt(_0x3ce39c(0xb8))/0x8)+-parseInt(_0x3ce39c(0xed))/0x9+parseInt(_0x3ce39c(0xf8))/0xa*(parseInt(_0x3ce39c(0xf9))/0xb);if(_0x58acdb===_0x42fe83)break;else _0x189d83['push'](_0x189d83['shift']());}catch(_0x5112ce){_0x189d83['push'](_0x189d83['shift']());}}}(a14_0x2455,0xab289));var __createBinding=this&&this[a14_0x4774bf(0x121)]||(Object[a14_0x4774bf(0x123)]?function(_0x2d5e7f,_0x2fa3d3,_0x479dd1,_0x4724dd){const _0x2434e7=a14_0x4774bf;if(_0x4724dd===undefined)_0x4724dd=_0x479dd1;var _0x1366eb=Object['getOwnPropertyDescriptor'](_0x2fa3d3,_0x479dd1);(!_0x1366eb||(_0x2434e7(0x109)in _0x1366eb?!_0x2fa3d3['__esModule']:_0x1366eb[_0x2434e7(0xd4)]||_0x1366eb[_0x2434e7(0xbb)]))&&(_0x1366eb={'enumerable':!![],'get':function(){return _0x2fa3d3[_0x479dd1];}}),Object[_0x2434e7(0x11d)](_0x2d5e7f,_0x4724dd,_0x1366eb);}:function(_0x30338e,_0x43e22b,_0x23d260,_0x1b8d27){if(_0x1b8d27===undefined)_0x1b8d27=_0x23d260;_0x30338e[_0x1b8d27]=_0x43e22b[_0x23d260];}),__setModuleDefault=this&&this[a14_0x4774bf(0xc5)]||(Object[a14_0x4774bf(0x123)]?function(_0xf0a62f,_0x15b9da){const _0xf6a895=a14_0x4774bf;Object[_0xf6a895(0x11d)](_0xf0a62f,'default',{'enumerable':!![],'value':_0x15b9da});}:function(_0x45c59,_0x1109cc){_0x45c59['default']=_0x1109cc;}),__importStar=this&&this[a14_0x4774bf(0xd8)]||(function(){var _0x12e1ee=function(_0xd46e3e){const _0x1c8e15=a14_0x3ed2;return _0x12e1ee=Object[_0x1c8e15(0xe0)]||function(_0x25b7a7){const _0x515edf=_0x1c8e15;var _0x4ce9f3=[];for(var _0x3b081e in _0x25b7a7)if(Object[_0x515edf(0xb7)]['hasOwnProperty'][_0x515edf(0xc2)](_0x25b7a7,_0x3b081e))_0x4ce9f3[_0x4ce9f3[_0x515edf(0xd2)]]=_0x3b081e;return _0x4ce9f3;},_0x12e1ee(_0xd46e3e);};return function(_0x43dd1f){const _0x353bbd=a14_0x3ed2;if(_0x43dd1f&&_0x43dd1f[_0x353bbd(0x105)])return _0x43dd1f;var _0x5a9ab0={};if(_0x43dd1f!=null){for(var _0x1f908b=_0x12e1ee(_0x43dd1f),_0x2d5912=0x0;_0x2d5912<_0x1f908b[_0x353bbd(0xd2)];_0x2d5912++)if(_0x1f908b[_0x2d5912]!==_0x353bbd(0x108))__createBinding(_0x5a9ab0,_0x43dd1f,_0x1f908b[_0x2d5912]);}return __setModuleDefault(_0x5a9ab0,_0x43dd1f),_0x5a9ab0;};}()),__importDefault=this&&this['__importDefault']||function(_0x177851){return _0x177851&&_0x177851['__esModule']?_0x177851:{'default':_0x177851};};Object[a14_0x4774bf(0x11d)](exports,'__esModule',{'value':!![]}),exports[a14_0x4774bf(0xe9)]=void 0x0;const testGatewayService_1=require(a14_0x4774bf(0x112)),webhookService_1=require(a14_0x4774bf(0x102)),database_1=__importDefault(require(a14_0x4774bf(0x122)));function a14_0x2455(){const _0x5c4042=[',\x20status=','sendPaymentNotification','Any\x203-4\x20digits','sendPaymentStatusNotification','📈\x20Found\x20payment\x20link\x20','payment','transactionId','68235fnIXwo','TestGatewayController','Payment\x20not\x20found','params','status','5900193rUTnRx','resolve','sendShopWebhook','paymentLinkId','json','$transaction','successUrl','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','30afVYLg','slice','cardNumber','145420CizZMI','1375VwJOaV','cardLast4','currentPayments','processCardPayment','test_card','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','PENDING','customerName','2148921qtgeYY','../services/webhookService','\x20with\x20status\x20','Payment\x20System/1.0\x20(Test\x20Gateway)','__esModule','PAID','ms)','default','get','testGatewayService','application/json','0000','✅\x20Payment\x20link\x20','3823528empJCz','Payment\x20to\x20','Any\x20other\x20card\x20number','stringify','../services/gateways/testGatewayService',',\x20cannot\x20process','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','\x20not\x20enabled\x20for\x20shop\x20','🧪\x20Test\x20Gateway\x20result:','replace','COMPLETED','payment.success','paid','orderId','paymentMethod','defineProperty','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','webhookEvents','gateway','__createBinding','../config/database','create',',\x20currentPayments=','260175sIEXwi','failureMessage','currency','error','isArray','includes','update','amount','16ggtyWj','body','Payment\x20processed\x20successfully','shop','failed','type','failUrl','4242\x204242\x204242\x204242','prototype','144dfHWpi','gatewayOrderId','Payment\x20failed','configurable','failureReason','settings','test_gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','paymentLink','webhookUrl','call','toISOString','Test\x20Gateway\x20webhook\x20sent\x20to\x20','__setModuleDefault','toLowerCase','payment.failed','findUnique','📈\x20Test\x20Gateway:\x20Payment\x20','now','\x20->\x20','paidAt','Webhook\x20event\x20','Any\x20name','webhookService','WebhookService','Error\x20parsing\x20webhook\x20events:','length','createdAt','writable','Payment\x20status\x20is\x20','\x20processed:\x20',':\x20type=','__importStar','40978IWZQlM','name','../services/telegramBotService','✅\x20Test\x20Gateway\x20payment\x20','FAILED','log','❌\x20Payment\x20link\x20','getOwnPropertyNames'];a14_0x2455=function(){return _0x5c4042;};return a14_0x2455();}class TestGatewayController{constructor(){const _0x45d2eb=a14_0x4774bf;this['getPaymentForm']=async(_0x3795b7,_0x1cf4ca,_0x5ebc2e)=>{const _0x20a510=a14_0x3ed2;try{const {paymentId:_0x3f8598}=_0x3795b7[_0x20a510(0xeb)];console[_0x20a510(0xde)](_0x20a510(0x114)+_0x3f8598);const _0x380728=await database_1[_0x20a510(0x108)]['payment'][_0x20a510(0xc8)]({'where':{'id':_0x3f8598},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x380728)return _0x1cf4ca[_0x20a510(0xec)](0x194)['json']({'success':![],'message':_0x20a510(0xea)});if(_0x380728[_0x20a510(0x120)]!==_0x20a510(0xbe))return _0x1cf4ca[_0x20a510(0xec)](0x190)[_0x20a510(0xf1)]({'success':![],'message':_0x20a510(0xbf)});if(_0x380728[_0x20a510(0xec)]!=='PENDING')return _0x1cf4ca[_0x20a510(0xec)](0x190)[_0x20a510(0xf1)]({'success':![],'message':_0x20a510(0xd5)+_0x380728['status']+_0x20a510(0x113)});_0x1cf4ca['json']({'success':!![],'result':{'paymentId':_0x380728['id'],'orderId':_0x380728['gatewayOrderId'],'amount':_0x380728[_0x20a510(0x12c)],'currency':_0x380728['currency'],'merchantName':_0x380728['shop'][_0x20a510(0xda)],'description':_0x20a510(0x10f)+_0x380728['shop']['name'],'testInstructions':{'successCard':_0x20a510(0xb6),'failureCard':_0x20a510(0x110),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x20a510(0xe3),'holderName':_0x20a510(0xce)}}});}catch(_0x388034){_0x5ebc2e(_0x388034);}},this['processCard']=async(_0x3eb04a,_0x305530,_0x5907f9)=>{const _0x1d976a=a14_0x3ed2;try{const {paymentId:_0x57d5ba}=_0x3eb04a[_0x1d976a(0xeb)],_0x85ccfc=_0x3eb04a[_0x1d976a(0x12e)];console[_0x1d976a(0xde)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x57d5ba);const _0x359d29=await database_1[_0x1d976a(0x108)]['payment'][_0x1d976a(0xc8)]({'where':{'id':_0x57d5ba},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x359d29)return _0x305530[_0x1d976a(0xec)](0x194)[_0x1d976a(0xf1)]({'success':![],'message':_0x1d976a(0xea)});if(_0x359d29[_0x1d976a(0x120)]!==_0x1d976a(0xbe))return _0x305530[_0x1d976a(0xec)](0x190)[_0x1d976a(0xf1)]({'success':![],'message':_0x1d976a(0xbf)});if(_0x359d29[_0x1d976a(0xec)]!==_0x1d976a(0xff))return _0x305530[_0x1d976a(0xec)](0x190)[_0x1d976a(0xf1)]({'success':![],'message':_0x1d976a(0xd5)+_0x359d29[_0x1d976a(0xec)]+_0x1d976a(0x113)});const _0x53ab10=await this[_0x1d976a(0x10a)][_0x1d976a(0xfc)]({'paymentId':_0x359d29['id'],'orderId':_0x359d29[_0x1d976a(0xb9)]||_0x359d29['id'],'amount':_0x359d29[_0x1d976a(0x12c)],'currency':_0x359d29['currency'],'cardData':_0x85ccfc});console[_0x1d976a(0xde)](_0x1d976a(0x116),_0x53ab10);const _0xda263f={'status':_0x53ab10['status'],'updatedAt':new Date()};if(_0x53ab10[_0x1d976a(0xec)]===_0x1d976a(0x106))_0xda263f[_0x1d976a(0xcc)]=new Date(),_0xda263f['gatewayPaymentId']=_0x53ab10[_0x1d976a(0xe7)];else _0x53ab10[_0x1d976a(0xec)]===_0x1d976a(0xdd)&&(_0xda263f[_0x1d976a(0x126)]=_0x53ab10[_0x1d976a(0xbc)]);const _0x463162=_0x85ccfc[_0x1d976a(0xf7)][_0x1d976a(0x117)](/[\s-]/g,'');_0xda263f[_0x1d976a(0xfa)]=_0x463162[_0x1d976a(0xf6)](-0x4),_0xda263f[_0x1d976a(0x11c)]=_0x1d976a(0xfd),await database_1[_0x1d976a(0x108)][_0x1d976a(0xe6)][_0x1d976a(0x12b)]({'where':{'id':_0x359d29['id']},'data':_0xda263f});if(_0x53ab10['status']===_0x1d976a(0x106)&&_0x359d29[_0x1d976a(0xf0)]){console[_0x1d976a(0xde)](_0x1d976a(0xc9)+_0x359d29['id']+_0x1d976a(0xf4));try{await database_1[_0x1d976a(0x108)][_0x1d976a(0xf2)](async _0x197016=>{const _0x56a022=_0x1d976a,_0x283e8b=await _0x197016[_0x56a022(0xc0)][_0x56a022(0xc8)]({'where':{'id':_0x359d29[_0x56a022(0xf0)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x283e8b){console[_0x56a022(0xde)](_0x56a022(0xe5)+_0x283e8b['id']+_0x56a022(0xd7)+_0x283e8b[_0x56a022(0xb4)]+_0x56a022(0x124)+_0x283e8b[_0x56a022(0xfb)]+_0x56a022(0xe1)+_0x283e8b[_0x56a022(0xec)]);const _0x87ceec=_0x283e8b['currentPayments']+0x1,_0x329276=_0x283e8b[_0x56a022(0xb4)]==='SINGLE'?_0x56a022(0x118):_0x283e8b[_0x56a022(0xec)];await _0x197016[_0x56a022(0xc0)][_0x56a022(0x12b)]({'where':{'id':_0x359d29[_0x56a022(0xf0)]},'data':{'currentPayments':_0x87ceec,'status':_0x329276,'updatedAt':new Date()}}),console[_0x56a022(0xde)](_0x56a022(0x10d)+_0x283e8b['id']+'\x20updated:\x20currentPayments='+_0x283e8b[_0x56a022(0xfb)]+_0x56a022(0xcb)+_0x87ceec+',\x20status='+_0x283e8b[_0x56a022(0xec)]+'\x20->\x20'+_0x329276);}else console['log'](_0x56a022(0xdf)+_0x359d29[_0x56a022(0xf0)]+'\x20not\x20found');});}catch(_0x494f5d){console[_0x1d976a(0x128)](_0x1d976a(0xfe),_0x494f5d);}}await database_1['default']['webhookLog'][_0x1d976a(0x123)]({'data':{'paymentId':_0x359d29['id'],'shopId':_0x359d29['shopId'],'event':'test_gateway_'+_0x53ab10[_0x1d976a(0xec)][_0x1d976a(0xc6)](),'statusCode':0xc8,'responseBody':JSON[_0x1d976a(0x111)]({'oldStatus':_0x1d976a(0xff),'newStatus':_0x53ab10[_0x1d976a(0xec)],'transactionId':_0x53ab10[_0x1d976a(0xe7)],'failureReason':_0x53ab10[_0x1d976a(0xbc)],'processedAt':new Date()[_0x1d976a(0xc3)]()})}}),await this[_0x1d976a(0xef)](_0x359d29,_0x53ab10[_0x1d976a(0xec)],_0x53ab10['transactionId'],_0x53ab10['failureReason']),await this[_0x1d976a(0xe4)](_0x359d29,_0x53ab10[_0x1d976a(0xec)]),console[_0x1d976a(0xde)](_0x1d976a(0xdc)+_0x57d5ba+_0x1d976a(0xd6)+_0x53ab10[_0x1d976a(0xec)]),_0x53ab10['status']===_0x1d976a(0x106)?_0x305530[_0x1d976a(0xf1)]({'success':!![],'message':_0x1d976a(0x12f),'result':{'status':_0x1d976a(0x106),'transactionId':_0x53ab10[_0x1d976a(0xe7)],'redirectUrl':_0x359d29[_0x1d976a(0xf3)]}}):_0x305530[_0x1d976a(0xec)](0x190)[_0x1d976a(0xf1)]({'success':![],'message':_0x1d976a(0xba),'result':{'status':'FAILED','failureReason':_0x53ab10[_0x1d976a(0xbc)],'redirectUrl':_0x359d29[_0x1d976a(0xb5)]}});}catch(_0x5b5a23){_0x5907f9(_0x5b5a23);}},this[_0x45d2eb(0x10a)]=new testGatewayService_1['TestGatewayService'](),this[_0x45d2eb(0xcf)]=new webhookService_1[(_0x45d2eb(0xd0))]();}async[a14_0x4774bf(0xef)](_0x187ed4,_0x9dc80d,_0x3f28b5,_0x1151b8){const _0x2f1c72=a14_0x4774bf,_0x1638a4=Date['now']();try{const _0x269c28=_0x187ed4[_0x2f1c72(0x130)],_0x1c8cfd=_0x269c28[_0x2f1c72(0xbd)];if(!_0x1c8cfd?.['webhookUrl']){console[_0x2f1c72(0xde)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x269c28['id']);return;}const _0x5d2787=_0x9dc80d===_0x2f1c72(0x106)?_0x2f1c72(0x119):_0x2f1c72(0xc7);let _0x1de690=[];if(_0x1c8cfd[_0x2f1c72(0x11f)])try{_0x1de690=Array[_0x2f1c72(0x129)](_0x1c8cfd[_0x2f1c72(0x11f)])?_0x1c8cfd[_0x2f1c72(0x11f)]:JSON['parse'](_0x1c8cfd[_0x2f1c72(0x11f)]);}catch(_0x4c3b65){console[_0x2f1c72(0x128)](_0x2f1c72(0xd1),_0x4c3b65),_0x1de690=[];}if(!_0x1de690[_0x2f1c72(0x12a)](_0x5d2787)){console[_0x2f1c72(0xde)](_0x2f1c72(0xcd)+_0x5d2787+_0x2f1c72(0x115)+_0x269c28['id']);return;}const _0x58f065={'event':_0x5d2787,'payment':{'id':_0x187ed4['id'],'order_id':_0x187ed4[_0x2f1c72(0x11b)],'gateway_order_id':_0x187ed4['gatewayOrderId'],'gateway':_0x2f1c72(0x10c),'amount':_0x187ed4[_0x2f1c72(0x12c)],'currency':_0x187ed4[_0x2f1c72(0x127)],'status':_0x9dc80d[_0x2f1c72(0xc6)](),'customer_email':_0x187ed4['customerEmail'],'customer_name':_0x187ed4[_0x2f1c72(0x100)],'transaction_id':_0x3f28b5,'failure_message':_0x1151b8,'created_at':_0x187ed4[_0x2f1c72(0xd3)],'updated_at':new Date()}},_0x3aab7b=await fetch(_0x1c8cfd[_0x2f1c72(0xc1)],{'method':'POST','headers':{'Content-Type':_0x2f1c72(0x10b),'User-Agent':_0x2f1c72(0x104)},'body':JSON[_0x2f1c72(0x111)](_0x58f065)}),_0x2c0ac5=Date[_0x2f1c72(0xca)]()-_0x1638a4;console[_0x2f1c72(0xde)](_0x2f1c72(0xc4)+_0x1c8cfd[_0x2f1c72(0xc1)]+_0x2f1c72(0x103)+_0x3aab7b[_0x2f1c72(0xec)]+'\x20('+_0x2c0ac5+_0x2f1c72(0x107));}catch(_0x28d6b2){console[_0x2f1c72(0x128)](_0x2f1c72(0x11e),_0x28d6b2);}}async[a14_0x4774bf(0xe4)](_0x432e39,_0x5519ef){const _0x12e58b=a14_0x4774bf;try{const {telegramBotService:_0x4003b4}=await Promise[_0x12e58b(0xee)]()['then'](()=>__importStar(require(_0x12e58b(0xdb)))),_0xb959be={'PAID':_0x12e58b(0x11a),'FAILED':_0x12e58b(0x131)},_0x569ed6=_0xb959be[_0x5519ef];if(!_0x569ed6)return;await _0x4003b4[_0x12e58b(0xe2)](_0x432e39['shopId'],_0x432e39,_0x569ed6);}catch(_0x5b3e8f){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5b3e8f);}}}exports['TestGatewayController']=TestGatewayController;