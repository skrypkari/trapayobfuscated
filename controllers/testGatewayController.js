'use strict';const a14_0x34e77f=a14_0x33e8;function a14_0x33e8(_0x3503a2,_0x170d73){const _0x5321ee=a14_0x5321();return a14_0x33e8=function(_0x33e845,_0x1ee254){_0x33e845=_0x33e845-0x138;let _0x2f1702=_0x5321ee[_0x33e845];return _0x2f1702;},a14_0x33e8(_0x3503a2,_0x170d73);}(function(_0x34bd9c,_0x88ae79){const _0x1f5132=a14_0x33e8,_0x1790c4=_0x34bd9c();while(!![]){try{const _0x29279b=parseInt(_0x1f5132(0x162))/0x1*(-parseInt(_0x1f5132(0x1a8))/0x2)+parseInt(_0x1f5132(0x144))/0x3*(parseInt(_0x1f5132(0x1ab))/0x4)+-parseInt(_0x1f5132(0x19a))/0x5+-parseInt(_0x1f5132(0x180))/0x6*(parseInt(_0x1f5132(0x167))/0x7)+-parseInt(_0x1f5132(0x172))/0x8*(-parseInt(_0x1f5132(0x196))/0x9)+-parseInt(_0x1f5132(0x179))/0xa+parseInt(_0x1f5132(0x14d))/0xb*(parseInt(_0x1f5132(0x15e))/0xc);if(_0x29279b===_0x88ae79)break;else _0x1790c4['push'](_0x1790c4['shift']());}catch(_0x260242){_0x1790c4['push'](_0x1790c4['shift']());}}}(a14_0x5321,0x27477));function a14_0x5321(){const _0x2e644d=['üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','739293ZglQOJ','sendPaymentNotification','PENDING','PAID','paymentLinkId','COMPLETED','TestGatewayService','failed','../services/webhookService','6528401DZzdZH',',\x20status=','FAILED','test_card','application/json','cardNumber','üìà\x20Found\x20payment\x20link\x20','hasOwnProperty','includes','../services/telegramBotService','json','$transaction','amount','prototype','processCardPayment','shop','webhookUrl','12LdjMWy','SINGLE','test_gateway_','params','206959Lkfjbc','__createBinding','orderId','\x20with\x20status\x20','name','7opbTUe','__esModule','Webhook\x20event\x20','webhookEvents','customerEmail','update','__importStar','TestGatewayController','getPaymentForm',',\x20cannot\x20process','Payment\x20is\x20not\x20for\x20test\x20gateway','7760lsotYM','gatewayOrderId','__importDefault','üß™\x20Test\x20Gateway\x20result:','paymentLink',',\x20currentPayments=','\x20->\x20','3031490BepANp','gateway','getOwnPropertyNames','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','Error\x20parsing\x20webhook\x20events:','currentPayments','failureReason','1034718WcZFOd','‚ùå\x20Payment\x20link\x20','payment.success','__setModuleDefault','Payment\x20failed','stringify','Payment\x20status\x20is\x20','0000','call','Any\x20other\x20card\x20number','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ms)','processCard','Payment\x20processed\x20successfully','log','type','transactionId','cardLast4','defineProperty','default','Any\x203-4\x20digits','replace','2718ututyd','‚úÖ\x20Payment\x20link\x20','create','Payment\x20System/1.0\x20(Test\x20Gateway)','1447070TDTTXO','settings',':\x20type=','successUrl','payment','length','\x20updated:\x20currentPayments=','findUnique','test_gateway','Payment\x20not\x20found','testGatewayService','4242\x204242\x204242\x204242','toLowerCase','error','2cfOGAA','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','createdAt','4gwzIQV','now','Any\x20future\x20date\x20(MM/YY)','../services/gateways/testGatewayService','\x20not\x20found','get','webhookLog','Payment\x20to\x20','status','failureMessage','body','getOwnPropertyDescriptor','currency','paidAt','shopId','WebhookService','sendShopWebhook'];a14_0x5321=function(){return _0x2e644d;};return a14_0x5321();}var __createBinding=this&&this[a14_0x34e77f(0x163)]||(Object[a14_0x34e77f(0x198)]?function(_0x3e76f8,_0x375a84,_0x90dded,_0x43b58){const _0x2d40b9=a14_0x34e77f;if(_0x43b58===undefined)_0x43b58=_0x90dded;var _0x4d6edd=Object[_0x2d40b9(0x13d)](_0x375a84,_0x90dded);(!_0x4d6edd||(_0x2d40b9(0x1b0)in _0x4d6edd?!_0x375a84[_0x2d40b9(0x168)]:_0x4d6edd['writable']||_0x4d6edd['configurable']))&&(_0x4d6edd={'enumerable':!![],'get':function(){return _0x375a84[_0x90dded];}}),Object[_0x2d40b9(0x192)](_0x3e76f8,_0x43b58,_0x4d6edd);}:function(_0x4b1d98,_0x99e766,_0x3ef45e,_0x2cdd3f){if(_0x2cdd3f===undefined)_0x2cdd3f=_0x3ef45e;_0x4b1d98[_0x2cdd3f]=_0x99e766[_0x3ef45e];}),__setModuleDefault=this&&this[a14_0x34e77f(0x183)]||(Object[a14_0x34e77f(0x198)]?function(_0x2e0f0f,_0x51eaf0){const _0x1fedc1=a14_0x34e77f;Object['defineProperty'](_0x2e0f0f,_0x1fedc1(0x193),{'enumerable':!![],'value':_0x51eaf0});}:function(_0x42d2dc,_0x8f9843){const _0x108efb=a14_0x34e77f;_0x42d2dc[_0x108efb(0x193)]=_0x8f9843;}),__importStar=this&&this[a14_0x34e77f(0x16d)]||(function(){var _0x2d8a9f=function(_0x315200){const _0x56625f=a14_0x33e8;return _0x2d8a9f=Object[_0x56625f(0x17b)]||function(_0xf1916){const _0x28fc5c=_0x56625f;var _0x79c9c=[];for(var _0xdb3d26 in _0xf1916)if(Object[_0x28fc5c(0x15a)][_0x28fc5c(0x154)][_0x28fc5c(0x188)](_0xf1916,_0xdb3d26))_0x79c9c[_0x79c9c[_0x28fc5c(0x19f)]]=_0xdb3d26;return _0x79c9c;},_0x2d8a9f(_0x315200);};return function(_0x138695){const _0x573a9a=a14_0x33e8;if(_0x138695&&_0x138695['__esModule'])return _0x138695;var _0x4feec2={};if(_0x138695!=null){for(var _0x3a1e7e=_0x2d8a9f(_0x138695),_0x5098b9=0x0;_0x5098b9<_0x3a1e7e[_0x573a9a(0x19f)];_0x5098b9++)if(_0x3a1e7e[_0x5098b9]!==_0x573a9a(0x193))__createBinding(_0x4feec2,_0x138695,_0x3a1e7e[_0x5098b9]);}return __setModuleDefault(_0x4feec2,_0x138695),_0x4feec2;};}()),__importDefault=this&&this[a14_0x34e77f(0x174)]||function(_0x5170d5){const _0x2a1137=a14_0x34e77f;return _0x5170d5&&_0x5170d5[_0x2a1137(0x168)]?_0x5170d5:{'default':_0x5170d5};};Object[a14_0x34e77f(0x192)](exports,a14_0x34e77f(0x168),{'value':!![]}),exports[a14_0x34e77f(0x16e)]=void 0x0;const testGatewayService_1=require(a14_0x34e77f(0x1ae)),webhookService_1=require(a14_0x34e77f(0x14c)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x5edece=a14_0x34e77f;this[_0x5edece(0x16f)]=async(_0x22890c,_0x490359,_0x98612a)=>{const _0x3140a2=_0x5edece;try{const {paymentId:_0x2e4061}=_0x22890c[_0x3140a2(0x161)];console[_0x3140a2(0x18e)](_0x3140a2(0x143)+_0x2e4061);const _0x4a1cc1=await database_1[_0x3140a2(0x193)][_0x3140a2(0x19e)][_0x3140a2(0x1a1)]({'where':{'id':_0x2e4061},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x4a1cc1)return _0x490359['status'](0x194)['json']({'success':![],'message':_0x3140a2(0x1a3)});if(_0x4a1cc1[_0x3140a2(0x17a)]!==_0x3140a2(0x1a2))return _0x490359[_0x3140a2(0x13a)](0x190)['json']({'success':![],'message':_0x3140a2(0x171)});if(_0x4a1cc1[_0x3140a2(0x13a)]!=='PENDING')return _0x490359['status'](0x190)[_0x3140a2(0x157)]({'success':![],'message':_0x3140a2(0x186)+_0x4a1cc1['status']+',\x20cannot\x20process'});_0x490359[_0x3140a2(0x157)]({'success':!![],'result':{'paymentId':_0x4a1cc1['id'],'orderId':_0x4a1cc1[_0x3140a2(0x173)],'amount':_0x4a1cc1[_0x3140a2(0x159)],'currency':_0x4a1cc1[_0x3140a2(0x13e)],'merchantName':_0x4a1cc1[_0x3140a2(0x15c)][_0x3140a2(0x166)],'description':_0x3140a2(0x139)+_0x4a1cc1['shop'][_0x3140a2(0x166)],'testInstructions':{'successCard':_0x3140a2(0x1a5),'failureCard':_0x3140a2(0x189),'expiryDate':_0x3140a2(0x1ad),'cvc':_0x3140a2(0x194),'holderName':'Any\x20name'}}});}catch(_0x34279a){_0x98612a(_0x34279a);}},this[_0x5edece(0x18c)]=async(_0xaa39d4,_0x580ff6,_0x5b2802)=>{const _0x10fc84=_0x5edece;try{const {paymentId:_0x28d45c}=_0xaa39d4[_0x10fc84(0x161)],_0x85f474=_0xaa39d4[_0x10fc84(0x13c)];console[_0x10fc84(0x18e)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x28d45c);const _0x40d7ae=await database_1[_0x10fc84(0x193)][_0x10fc84(0x19e)]['findUnique']({'where':{'id':_0x28d45c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x40d7ae)return _0x580ff6[_0x10fc84(0x13a)](0x194)[_0x10fc84(0x157)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x40d7ae['gateway']!==_0x10fc84(0x1a2))return _0x580ff6[_0x10fc84(0x13a)](0x190)[_0x10fc84(0x157)]({'success':![],'message':_0x10fc84(0x171)});if(_0x40d7ae[_0x10fc84(0x13a)]!==_0x10fc84(0x146))return _0x580ff6[_0x10fc84(0x13a)](0x190)[_0x10fc84(0x157)]({'success':![],'message':_0x10fc84(0x186)+_0x40d7ae[_0x10fc84(0x13a)]+_0x10fc84(0x170)});const _0x4a677b=await this[_0x10fc84(0x1a4)][_0x10fc84(0x15b)]({'paymentId':_0x40d7ae['id'],'orderId':_0x40d7ae[_0x10fc84(0x173)]||_0x40d7ae['id'],'amount':_0x40d7ae[_0x10fc84(0x159)],'currency':_0x40d7ae[_0x10fc84(0x13e)],'cardData':_0x85f474});console['log'](_0x10fc84(0x175),_0x4a677b);const _0x139776={'status':_0x4a677b[_0x10fc84(0x13a)],'updatedAt':new Date()};if(_0x4a677b[_0x10fc84(0x13a)]===_0x10fc84(0x147))_0x139776[_0x10fc84(0x13f)]=new Date(),_0x139776['gatewayPaymentId']=_0x4a677b[_0x10fc84(0x190)];else _0x4a677b[_0x10fc84(0x13a)]===_0x10fc84(0x14f)&&(_0x139776[_0x10fc84(0x13b)]=_0x4a677b[_0x10fc84(0x17f)]);const _0x492ef9=_0x85f474[_0x10fc84(0x152)][_0x10fc84(0x195)](/[\s-]/g,'');_0x139776[_0x10fc84(0x191)]=_0x492ef9['slice'](-0x4),_0x139776['paymentMethod']=_0x10fc84(0x150),await database_1['default']['payment']['update']({'where':{'id':_0x40d7ae['id']},'data':_0x139776});if(_0x4a677b['status']===_0x10fc84(0x147)&&_0x40d7ae['paymentLinkId']){console[_0x10fc84(0x18e)]('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x40d7ae['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x10fc84(0x193)][_0x10fc84(0x158)](async _0x24edca=>{const _0x4b10e7=_0x10fc84,_0x4d9621=await _0x24edca[_0x4b10e7(0x176)]['findUnique']({'where':{'id':_0x40d7ae[_0x4b10e7(0x148)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4d9621){console[_0x4b10e7(0x18e)](_0x4b10e7(0x153)+_0x4d9621['id']+_0x4b10e7(0x19c)+_0x4d9621[_0x4b10e7(0x18f)]+_0x4b10e7(0x177)+_0x4d9621[_0x4b10e7(0x17e)]+',\x20status='+_0x4d9621[_0x4b10e7(0x13a)]);const _0x23a34c=_0x4d9621[_0x4b10e7(0x17e)]+0x1,_0xdf7fd5=_0x4d9621['type']===_0x4b10e7(0x15f)?_0x4b10e7(0x149):_0x4d9621[_0x4b10e7(0x13a)];await _0x24edca[_0x4b10e7(0x176)][_0x4b10e7(0x16c)]({'where':{'id':_0x40d7ae[_0x4b10e7(0x148)]},'data':{'currentPayments':_0x23a34c,'status':_0xdf7fd5,'updatedAt':new Date()}}),console[_0x4b10e7(0x18e)](_0x4b10e7(0x197)+_0x4d9621['id']+_0x4b10e7(0x1a0)+_0x4d9621[_0x4b10e7(0x17e)]+'\x20->\x20'+_0x23a34c+_0x4b10e7(0x14e)+_0x4d9621[_0x4b10e7(0x13a)]+_0x4b10e7(0x178)+_0xdf7fd5);}else console[_0x4b10e7(0x18e)](_0x4b10e7(0x181)+_0x40d7ae['paymentLinkId']+_0x4b10e7(0x1af));});}catch(_0x2a02fb){console[_0x10fc84(0x1a7)](_0x10fc84(0x1a9),_0x2a02fb);}}await database_1[_0x10fc84(0x193)][_0x10fc84(0x138)][_0x10fc84(0x198)]({'data':{'paymentId':_0x40d7ae['id'],'shopId':_0x40d7ae[_0x10fc84(0x140)],'event':_0x10fc84(0x160)+_0x4a677b[_0x10fc84(0x13a)][_0x10fc84(0x1a6)](),'statusCode':0xc8,'responseBody':JSON[_0x10fc84(0x185)]({'oldStatus':_0x10fc84(0x146),'newStatus':_0x4a677b[_0x10fc84(0x13a)],'transactionId':_0x4a677b[_0x10fc84(0x190)],'failureReason':_0x4a677b[_0x10fc84(0x17f)],'processedAt':new Date()['toISOString']()})}}),await this[_0x10fc84(0x142)](_0x40d7ae,_0x4a677b[_0x10fc84(0x13a)],_0x4a677b[_0x10fc84(0x190)],_0x4a677b['failureReason']),await this['sendPaymentStatusNotification'](_0x40d7ae,_0x4a677b['status']),console[_0x10fc84(0x18e)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x28d45c+'\x20processed:\x20'+_0x4a677b['status']),_0x4a677b[_0x10fc84(0x13a)]===_0x10fc84(0x147)?_0x580ff6[_0x10fc84(0x157)]({'success':!![],'message':_0x10fc84(0x18d),'result':{'status':_0x10fc84(0x147),'transactionId':_0x4a677b[_0x10fc84(0x190)],'redirectUrl':_0x40d7ae[_0x10fc84(0x19d)]}}):_0x580ff6[_0x10fc84(0x13a)](0x190)['json']({'success':![],'message':_0x10fc84(0x184),'result':{'status':'FAILED','failureReason':_0x4a677b['failureReason'],'redirectUrl':_0x40d7ae['failUrl']}});}catch(_0x57c69e){_0x5b2802(_0x57c69e);}},this[_0x5edece(0x1a4)]=new testGatewayService_1[(_0x5edece(0x14a))](),this['webhookService']=new webhookService_1[(_0x5edece(0x141))]();}async[a14_0x34e77f(0x142)](_0x338615,_0x510efb,_0x2c2d42,_0x2c6349){const _0x89af34=a14_0x34e77f,_0x4f8b3c=Date[_0x89af34(0x1ac)]();try{const _0x4c3187=_0x338615['shop'],_0x41adfa=_0x4c3187[_0x89af34(0x19b)];if(!_0x41adfa?.[_0x89af34(0x15d)]){console[_0x89af34(0x18e)](_0x89af34(0x18a)+_0x4c3187['id']);return;}const _0x425231=_0x510efb===_0x89af34(0x147)?_0x89af34(0x182):'payment.failed';let _0x21e3d0=[];if(_0x41adfa[_0x89af34(0x16a)])try{_0x21e3d0=Array['isArray'](_0x41adfa[_0x89af34(0x16a)])?_0x41adfa[_0x89af34(0x16a)]:JSON['parse'](_0x41adfa[_0x89af34(0x16a)]);}catch(_0x18ad22){console['error'](_0x89af34(0x17d),_0x18ad22),_0x21e3d0=[];}if(!_0x21e3d0[_0x89af34(0x155)](_0x425231)){console['log'](_0x89af34(0x169)+_0x425231+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4c3187['id']);return;}const _0x213c20={'event':_0x425231,'payment':{'id':_0x338615['id'],'order_id':_0x338615[_0x89af34(0x164)],'gateway_order_id':_0x338615['gatewayOrderId'],'gateway':_0x89af34(0x187),'amount':_0x338615['amount'],'currency':_0x338615[_0x89af34(0x13e)],'status':_0x510efb['toLowerCase'](),'customer_email':_0x338615[_0x89af34(0x16b)],'customer_name':_0x338615['customerName'],'transaction_id':_0x2c2d42,'failure_message':_0x2c6349,'created_at':_0x338615[_0x89af34(0x1aa)],'updated_at':new Date()}},_0x2d81d8=await fetch(_0x41adfa[_0x89af34(0x15d)],{'method':'POST','headers':{'Content-Type':_0x89af34(0x151),'User-Agent':_0x89af34(0x199)},'body':JSON[_0x89af34(0x185)](_0x213c20)}),_0x3cbab2=Date['now']()-_0x4f8b3c;console[_0x89af34(0x18e)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x41adfa[_0x89af34(0x15d)]+_0x89af34(0x165)+_0x2d81d8[_0x89af34(0x13a)]+'\x20('+_0x3cbab2+_0x89af34(0x18b));}catch(_0x4888c1){console[_0x89af34(0x1a7)](_0x89af34(0x17c),_0x4888c1);}}async['sendPaymentStatusNotification'](_0x449e50,_0x591551){const _0x260451=a14_0x34e77f;try{const {telegramBotService:_0x7a28c1}=await Promise['resolve']()['then'](()=>__importStar(require(_0x260451(0x156)))),_0x29fa1c={'PAID':'paid','FAILED':_0x260451(0x14b)},_0x48d9eb=_0x29fa1c[_0x591551];if(!_0x48d9eb)return;await _0x7a28c1[_0x260451(0x145)](_0x449e50[_0x260451(0x140)],_0x449e50,_0x48d9eb);}catch(_0x13aee4){console[_0x260451(0x1a7)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x13aee4);}}}exports[a14_0x34e77f(0x16e)]=TestGatewayController;