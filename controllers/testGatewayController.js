'use strict';function a13_0x5607(_0x2513b7,_0x23158c){const _0x3080a9=a13_0x3080();return a13_0x5607=function(_0x5607a4,_0x4acf98){_0x5607a4=_0x5607a4-0x6d;let _0x26d8f5=_0x3080a9[_0x5607a4];return _0x26d8f5;},a13_0x5607(_0x2513b7,_0x23158c);}const a13_0x50b7d5=a13_0x5607;(function(_0x3c0b6e,_0x109ed6){const _0x2b1339=a13_0x5607,_0x1c61a5=_0x3c0b6e();while(!![]){try{const _0x5942db=parseInt(_0x2b1339(0xc9))/0x1*(parseInt(_0x2b1339(0x9e))/0x2)+parseInt(_0x2b1339(0xdf))/0x3+-parseInt(_0x2b1339(0xcc))/0x4*(-parseInt(_0x2b1339(0xcb))/0x5)+parseInt(_0x2b1339(0xc3))/0x6+-parseInt(_0x2b1339(0xe3))/0x7*(-parseInt(_0x2b1339(0x71))/0x8)+parseInt(_0x2b1339(0xbb))/0x9+-parseInt(_0x2b1339(0x96))/0xa;if(_0x5942db===_0x109ed6)break;else _0x1c61a5['push'](_0x1c61a5['shift']());}catch(_0x36c176){_0x1c61a5['push'](_0x1c61a5['shift']());}}}(a13_0x3080,0x2f2f6));var __createBinding=this&&this[a13_0x50b7d5(0xa2)]||(Object[a13_0x50b7d5(0xc5)]?function(_0x111191,_0x183c97,_0x3b0868,_0x985f20){const _0x3fabe9=a13_0x50b7d5;if(_0x985f20===undefined)_0x985f20=_0x3b0868;var _0x4de60e=Object['getOwnPropertyDescriptor'](_0x183c97,_0x3b0868);(!_0x4de60e||(_0x3fabe9(0xa7)in _0x4de60e?!_0x183c97[_0x3fabe9(0xe1)]:_0x4de60e[_0x3fabe9(0xd4)]||_0x4de60e[_0x3fabe9(0x8c)]))&&(_0x4de60e={'enumerable':!![],'get':function(){return _0x183c97[_0x3b0868];}}),Object[_0x3fabe9(0x9f)](_0x111191,_0x985f20,_0x4de60e);}:function(_0x105071,_0x5a9671,_0x49af98,_0x33c414){if(_0x33c414===undefined)_0x33c414=_0x49af98;_0x105071[_0x33c414]=_0x5a9671[_0x49af98];}),__setModuleDefault=this&&this[a13_0x50b7d5(0x94)]||(Object[a13_0x50b7d5(0xc5)]?function(_0x28e476,_0x368560){const _0x10731f=a13_0x50b7d5;Object[_0x10731f(0x9f)](_0x28e476,'default',{'enumerable':!![],'value':_0x368560});}:function(_0x16fff8,_0x435d48){const _0x3ad7d4=a13_0x50b7d5;_0x16fff8[_0x3ad7d4(0x86)]=_0x435d48;}),__importStar=this&&this[a13_0x50b7d5(0xb2)]||(function(){var _0x5b7551=function(_0x2c6cc9){return _0x5b7551=Object['getOwnPropertyNames']||function(_0x1f5683){const _0x1652f8=a13_0x5607;var _0x31cc8b=[];for(var _0x2f7145 in _0x1f5683)if(Object[_0x1652f8(0x7e)][_0x1652f8(0xa0)][_0x1652f8(0x91)](_0x1f5683,_0x2f7145))_0x31cc8b[_0x31cc8b[_0x1652f8(0x99)]]=_0x2f7145;return _0x31cc8b;},_0x5b7551(_0x2c6cc9);};return function(_0x10b2b3){const _0x320e7d=a13_0x5607;if(_0x10b2b3&&_0x10b2b3[_0x320e7d(0xe1)])return _0x10b2b3;var _0xf37557={};if(_0x10b2b3!=null){for(var _0x5272b9=_0x5b7551(_0x10b2b3),_0xb81d0a=0x0;_0xb81d0a<_0x5272b9[_0x320e7d(0x99)];_0xb81d0a++)if(_0x5272b9[_0xb81d0a]!==_0x320e7d(0x86))__createBinding(_0xf37557,_0x10b2b3,_0x5272b9[_0xb81d0a]);}return __setModuleDefault(_0xf37557,_0x10b2b3),_0xf37557;};}()),__importDefault=this&&this[a13_0x50b7d5(0x8f)]||function(_0x18f354){const _0x2b088a=a13_0x50b7d5;return _0x18f354&&_0x18f354[_0x2b088a(0xe1)]?_0x18f354:{'default':_0x18f354};};Object[a13_0x50b7d5(0x9f)](exports,a13_0x50b7d5(0xe1),{'value':!![]}),exports[a13_0x50b7d5(0x75)]=void 0x0;function a13_0x3080(){const _0x39808d=['toISOString','Payment\x20is\x20not\x20for\x20test\x20gateway','test_gateway','437736lciUpH','replace','__esModule','failureReason','1673ySOIaA','paymentLink','body','Error\x20parsing\x20webhook\x20events:','cardLast4','4520WoZnVm','webhookUrl','findUnique','shopId','TestGatewayController','status','\x20updated:\x20currentPayments=','cardNumber','\x20->\x20','payment.failed','paymentLinkId','shop','Payment\x20status\x20is\x20','prototype','Any\x20other\x20card\x20number','../services/telegramBotService','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','transactionId','customerEmail','FAILED','processCard','default','../config/database','amount','POST','createdAt','test_card','configurable','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','__importDefault','parse','call','Test\x20Gateway\x20webhook\x20sent\x20to\x20','currentPayments','__setModuleDefault','❌\x20Payment\x20link\x20','8893930MpaSGF','processCardPayment','🧪\x20Test\x20Gateway\x20result:','length','Payment\x20failed','application/json','json','payment.success','377414txoZrb','defineProperty','hasOwnProperty','paidAt','__createBinding','PENDING','slice','Payment\x20not\x20found','Payment\x20to\x20','get','testGatewayService','SINGLE','update','Any\x20future\x20date\x20(MM/YY)','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','type','\x20with\x20status\x20','Any\x203-4\x20digits','log','payment','__importStar','TestGatewayService','settings','gatewayOrderId',',\x20currentPayments=','\x20processed:\x20','paymentMethod','failed','$transaction','2804391gHBTgP','webhookLog','params','currency','gateway','isArray','✅\x20Test\x20Gateway\x20payment\x20','sendPaymentStatusNotification','1712430YXrODk','name','create','4242\x204242\x204242\x204242','toLowerCase','error','1dRUNaW','webhookEvents','80025vnKuZg','4Xmyham','failUrl','stringify','successUrl','test_gateway_','sendShopWebhook','Payment\x20processed\x20successfully','\x20not\x20enabled\x20for\x20shop\x20','writable',',\x20cannot\x20process','COMPLETED','resolve','gatewayPaymentId',',\x20status=','📈\x20Test\x20Gateway:\x20Payment\x20','PAID'];a13_0x3080=function(){return _0x39808d;};return a13_0x3080();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a13_0x50b7d5(0x87)));class TestGatewayController{constructor(){const _0x2155df=a13_0x50b7d5;this['getPaymentForm']=async(_0x581918,_0x5a4e4a,_0x377bec)=>{const _0x14e9c1=a13_0x5607;try{const {paymentId:_0x57275e}=_0x581918[_0x14e9c1(0xbd)];console['log']('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x57275e);const _0x5ca544=await database_1[_0x14e9c1(0x86)][_0x14e9c1(0xb1)][_0x14e9c1(0x73)]({'where':{'id':_0x57275e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5ca544)return _0x5a4e4a[_0x14e9c1(0x76)](0x194)['json']({'success':![],'message':_0x14e9c1(0xa5)});if(_0x5ca544['gateway']!==_0x14e9c1(0xde))return _0x5a4e4a['status'](0x190)[_0x14e9c1(0x9c)]({'success':![],'message':_0x14e9c1(0xdd)});if(_0x5ca544[_0x14e9c1(0x76)]!==_0x14e9c1(0xa3))return _0x5a4e4a[_0x14e9c1(0x76)](0x190)['json']({'success':![],'message':_0x14e9c1(0x7d)+_0x5ca544[_0x14e9c1(0x76)]+_0x14e9c1(0xd5)});_0x5a4e4a[_0x14e9c1(0x9c)]({'success':!![],'result':{'paymentId':_0x5ca544['id'],'orderId':_0x5ca544[_0x14e9c1(0xb5)],'amount':_0x5ca544['amount'],'currency':_0x5ca544[_0x14e9c1(0xbe)],'merchantName':_0x5ca544[_0x14e9c1(0x7c)][_0x14e9c1(0xc4)],'description':_0x14e9c1(0xa6)+_0x5ca544[_0x14e9c1(0x7c)][_0x14e9c1(0xc4)],'testInstructions':{'successCard':_0x14e9c1(0xc6),'failureCard':_0x14e9c1(0x7f),'expiryDate':_0x14e9c1(0xab),'cvc':_0x14e9c1(0xaf),'holderName':'Any\x20name'}}});}catch(_0x3ccf7c){_0x377bec(_0x3ccf7c);}},this[_0x2155df(0x85)]=async(_0x72054b,_0x4775af,_0x567fe5)=>{const _0x9b66fc=_0x2155df;try{const {paymentId:_0x13d9b5}=_0x72054b[_0x9b66fc(0xbd)],_0x1dbe8e=_0x72054b[_0x9b66fc(0x6e)];console[_0x9b66fc(0xb0)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x13d9b5);const _0x29c706=await database_1[_0x9b66fc(0x86)][_0x9b66fc(0xb1)][_0x9b66fc(0x73)]({'where':{'id':_0x13d9b5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x29c706)return _0x4775af['status'](0x194)[_0x9b66fc(0x9c)]({'success':![],'message':_0x9b66fc(0xa5)});if(_0x29c706[_0x9b66fc(0xbf)]!==_0x9b66fc(0xde))return _0x4775af[_0x9b66fc(0x76)](0x190)[_0x9b66fc(0x9c)]({'success':![],'message':_0x9b66fc(0xdd)});if(_0x29c706['status']!==_0x9b66fc(0xa3))return _0x4775af[_0x9b66fc(0x76)](0x190)[_0x9b66fc(0x9c)]({'success':![],'message':_0x9b66fc(0x7d)+_0x29c706[_0x9b66fc(0x76)]+_0x9b66fc(0xd5)});const _0x5d2fc8=await this['testGatewayService'][_0x9b66fc(0x97)]({'paymentId':_0x29c706['id'],'orderId':_0x29c706[_0x9b66fc(0xb5)]||_0x29c706['id'],'amount':_0x29c706[_0x9b66fc(0x88)],'currency':_0x29c706[_0x9b66fc(0xbe)],'cardData':_0x1dbe8e});console[_0x9b66fc(0xb0)](_0x9b66fc(0x98),_0x5d2fc8);const _0x37de2e={'status':_0x5d2fc8[_0x9b66fc(0x76)],'updatedAt':new Date()};if(_0x5d2fc8['status']===_0x9b66fc(0xdb))_0x37de2e[_0x9b66fc(0xa1)]=new Date(),_0x37de2e[_0x9b66fc(0xd8)]=_0x5d2fc8[_0x9b66fc(0x82)];else _0x5d2fc8[_0x9b66fc(0x76)]===_0x9b66fc(0x84)&&(_0x37de2e['failureMessage']=_0x5d2fc8[_0x9b66fc(0xe2)]);const _0x37c52e=_0x1dbe8e[_0x9b66fc(0x78)][_0x9b66fc(0xe0)](/[\s-]/g,'');_0x37de2e[_0x9b66fc(0x70)]=_0x37c52e[_0x9b66fc(0xa4)](-0x4),_0x37de2e[_0x9b66fc(0xb8)]=_0x9b66fc(0x8b),await database_1['default'][_0x9b66fc(0xb1)][_0x9b66fc(0xaa)]({'where':{'id':_0x29c706['id']},'data':_0x37de2e});if(_0x5d2fc8[_0x9b66fc(0x76)]===_0x9b66fc(0xdb)&&_0x29c706['paymentLinkId']){console['log'](_0x9b66fc(0xda)+_0x29c706['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0x9b66fc(0x86)][_0x9b66fc(0xba)](async _0x205b89=>{const _0xc93ad2=_0x9b66fc,_0x118976=await _0x205b89[_0xc93ad2(0x6d)][_0xc93ad2(0x73)]({'where':{'id':_0x29c706[_0xc93ad2(0x7b)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x118976){console['log']('📈\x20Found\x20payment\x20link\x20'+_0x118976['id']+':\x20type='+_0x118976[_0xc93ad2(0xad)]+_0xc93ad2(0xb6)+_0x118976[_0xc93ad2(0x93)]+_0xc93ad2(0xd9)+_0x118976[_0xc93ad2(0x76)]);const _0xf7dc4b=_0x118976[_0xc93ad2(0x93)]+0x1,_0x29237a=_0x118976[_0xc93ad2(0xad)]===_0xc93ad2(0xa9)?_0xc93ad2(0xd6):_0x118976[_0xc93ad2(0x76)];await _0x205b89[_0xc93ad2(0x6d)][_0xc93ad2(0xaa)]({'where':{'id':_0x29c706['paymentLinkId']},'data':{'currentPayments':_0xf7dc4b,'status':_0x29237a,'updatedAt':new Date()}}),console['log']('✅\x20Payment\x20link\x20'+_0x118976['id']+_0xc93ad2(0x77)+_0x118976['currentPayments']+_0xc93ad2(0x79)+_0xf7dc4b+_0xc93ad2(0xd9)+_0x118976[_0xc93ad2(0x76)]+_0xc93ad2(0x79)+_0x29237a);}else console[_0xc93ad2(0xb0)](_0xc93ad2(0x95)+_0x29c706[_0xc93ad2(0x7b)]+'\x20not\x20found');});}catch(_0x4e51b6){console[_0x9b66fc(0xc8)](_0x9b66fc(0xac),_0x4e51b6);}}await database_1[_0x9b66fc(0x86)][_0x9b66fc(0xbc)][_0x9b66fc(0xc5)]({'data':{'paymentId':_0x29c706['id'],'shopId':_0x29c706[_0x9b66fc(0x74)],'event':_0x9b66fc(0xd0)+_0x5d2fc8[_0x9b66fc(0x76)][_0x9b66fc(0xc7)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x9b66fc(0xa3),'newStatus':_0x5d2fc8[_0x9b66fc(0x76)],'transactionId':_0x5d2fc8[_0x9b66fc(0x82)],'failureReason':_0x5d2fc8[_0x9b66fc(0xe2)],'processedAt':new Date()[_0x9b66fc(0xdc)]()})}}),await this[_0x9b66fc(0xd1)](_0x29c706,_0x5d2fc8[_0x9b66fc(0x76)],_0x5d2fc8['transactionId'],_0x5d2fc8['failureReason']),await this['sendPaymentStatusNotification'](_0x29c706,_0x5d2fc8['status']),console[_0x9b66fc(0xb0)](_0x9b66fc(0xc1)+_0x13d9b5+_0x9b66fc(0xb7)+_0x5d2fc8[_0x9b66fc(0x76)]),_0x5d2fc8[_0x9b66fc(0x76)]===_0x9b66fc(0xdb)?_0x4775af[_0x9b66fc(0x9c)]({'success':!![],'message':_0x9b66fc(0xd2),'result':{'status':_0x9b66fc(0xdb),'transactionId':_0x5d2fc8['transactionId'],'redirectUrl':_0x29c706[_0x9b66fc(0xcf)]}}):_0x4775af[_0x9b66fc(0x76)](0x190)[_0x9b66fc(0x9c)]({'success':![],'message':_0x9b66fc(0x9a),'result':{'status':_0x9b66fc(0x84),'failureReason':_0x5d2fc8[_0x9b66fc(0xe2)],'redirectUrl':_0x29c706[_0x9b66fc(0xcd)]}});}catch(_0x3808f9){_0x567fe5(_0x3808f9);}},this[_0x2155df(0xa8)]=new testGatewayService_1[(_0x2155df(0xb3))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a13_0x50b7d5(0xd1)](_0x1c74fb,_0x20ea36,_0x508e55,_0x3336ca){const _0x1333d8=a13_0x50b7d5,_0x284a8c=Date['now']();try{const _0x59b4d5=_0x1c74fb['shop'],_0xe0cbdf=_0x59b4d5[_0x1333d8(0xb4)];if(!_0xe0cbdf?.[_0x1333d8(0x72)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x59b4d5['id']);return;}const _0x13d8ac=_0x20ea36===_0x1333d8(0xdb)?_0x1333d8(0x9d):_0x1333d8(0x7a);let _0xf1f091=[];if(_0xe0cbdf[_0x1333d8(0xca)])try{_0xf1f091=Array[_0x1333d8(0xc0)](_0xe0cbdf[_0x1333d8(0xca)])?_0xe0cbdf['webhookEvents']:JSON[_0x1333d8(0x90)](_0xe0cbdf['webhookEvents']);}catch(_0x24aa70){console[_0x1333d8(0xc8)](_0x1333d8(0x6f),_0x24aa70),_0xf1f091=[];}if(!_0xf1f091['includes'](_0x13d8ac)){console[_0x1333d8(0xb0)]('Webhook\x20event\x20'+_0x13d8ac+_0x1333d8(0xd3)+_0x59b4d5['id']);return;}const _0x3a03db={'event':_0x13d8ac,'payment':{'id':_0x1c74fb['id'],'order_id':_0x1c74fb['orderId'],'gateway_order_id':_0x1c74fb['gatewayOrderId'],'gateway':'0000','amount':_0x1c74fb[_0x1333d8(0x88)],'currency':_0x1c74fb[_0x1333d8(0xbe)],'status':_0x20ea36[_0x1333d8(0xc7)](),'customer_email':_0x1c74fb[_0x1333d8(0x83)],'customer_name':_0x1c74fb['customerName'],'transaction_id':_0x508e55,'failure_message':_0x3336ca,'created_at':_0x1c74fb[_0x1333d8(0x8a)],'updated_at':new Date()}},_0x5155c0=await fetch(_0xe0cbdf['webhookUrl'],{'method':_0x1333d8(0x89),'headers':{'Content-Type':_0x1333d8(0x9b),'User-Agent':_0x1333d8(0x8e)},'body':JSON[_0x1333d8(0xce)](_0x3a03db)}),_0x1c7724=Date['now']()-_0x284a8c;console[_0x1333d8(0xb0)](_0x1333d8(0x92)+_0xe0cbdf[_0x1333d8(0x72)]+_0x1333d8(0xae)+_0x5155c0[_0x1333d8(0x76)]+'\x20('+_0x1c7724+'ms)');}catch(_0xd02eb2){console[_0x1333d8(0xc8)](_0x1333d8(0x81),_0xd02eb2);}}async[a13_0x50b7d5(0xc2)](_0x856293,_0x3cbc1e){const _0x37d8d7=a13_0x50b7d5;try{const {telegramBotService:_0x4bc00c}=await Promise[_0x37d8d7(0xd7)]()['then'](()=>__importStar(require(_0x37d8d7(0x80)))),_0x52220f={'PAID':'paid','FAILED':_0x37d8d7(0xb9)},_0x25815b=_0x52220f[_0x3cbc1e];if(!_0x25815b)return;await _0x4bc00c['sendPaymentNotification'](_0x856293[_0x37d8d7(0x74)],_0x856293,_0x25815b);}catch(_0x2ac05b){console[_0x37d8d7(0xc8)](_0x37d8d7(0x8d),_0x2ac05b);}}}exports['TestGatewayController']=TestGatewayController;