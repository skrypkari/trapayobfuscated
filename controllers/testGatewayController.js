'use strict';const a14_0xcafd41=a14_0x5449;(function(_0x449328,_0x7e7a6f){const _0x396db9=a14_0x5449,_0x1402dc=_0x449328();while(!![]){try{const _0x2838f4=-parseInt(_0x396db9(0x215))/0x1+parseInt(_0x396db9(0x1e0))/0x2*(parseInt(_0x396db9(0x248))/0x3)+parseInt(_0x396db9(0x224))/0x4*(-parseInt(_0x396db9(0x220))/0x5)+-parseInt(_0x396db9(0x228))/0x6*(parseInt(_0x396db9(0x1f2))/0x7)+parseInt(_0x396db9(0x207))/0x8*(-parseInt(_0x396db9(0x1de))/0x9)+-parseInt(_0x396db9(0x247))/0xa*(-parseInt(_0x396db9(0x251))/0xb)+parseInt(_0x396db9(0x23b))/0xc;if(_0x2838f4===_0x7e7a6f)break;else _0x1402dc['push'](_0x1402dc['shift']());}catch(_0x5789ef){_0x1402dc['push'](_0x1402dc['shift']());}}}(a14_0x64d8,0xee9e2));function a14_0x5449(_0x171c27,_0x328ff8){const _0x64d84=a14_0x64d8();return a14_0x5449=function(_0x5449c0,_0x298747){_0x5449c0=_0x5449c0-0x1d0;let _0x1f69af=_0x64d84[_0x5449c0];return _0x1f69af;},a14_0x5449(_0x171c27,_0x328ff8);}var __createBinding=this&&this[a14_0xcafd41(0x1d5)]||(Object[a14_0xcafd41(0x241)]?function(_0x11b42b,_0x4f0058,_0x309bb7,_0x2e46d0){const _0x216b59=a14_0xcafd41;if(_0x2e46d0===undefined)_0x2e46d0=_0x309bb7;var _0x45d146=Object[_0x216b59(0x1ef)](_0x4f0058,_0x309bb7);(!_0x45d146||(_0x216b59(0x1e3)in _0x45d146?!_0x4f0058[_0x216b59(0x201)]:_0x45d146[_0x216b59(0x1ff)]||_0x45d146[_0x216b59(0x1f7)]))&&(_0x45d146={'enumerable':!![],'get':function(){return _0x4f0058[_0x309bb7];}}),Object[_0x216b59(0x200)](_0x11b42b,_0x2e46d0,_0x45d146);}:function(_0x196f8e,_0x49c91b,_0xb8fb99,_0x2e77b9){if(_0x2e77b9===undefined)_0x2e77b9=_0xb8fb99;_0x196f8e[_0x2e77b9]=_0x49c91b[_0xb8fb99];}),__setModuleDefault=this&&this[a14_0xcafd41(0x20a)]||(Object['create']?function(_0x4e4a28,_0x14ad23){const _0x592f54=a14_0xcafd41;Object[_0x592f54(0x200)](_0x4e4a28,_0x592f54(0x1dd),{'enumerable':!![],'value':_0x14ad23});}:function(_0x2bddd1,_0x425692){const _0x4a50ee=a14_0xcafd41;_0x2bddd1[_0x4a50ee(0x1dd)]=_0x425692;}),__importStar=this&&this[a14_0xcafd41(0x1e6)]||(function(){var _0x560a40=function(_0x33b63c){const _0x2b3385=a14_0x5449;return _0x560a40=Object[_0x2b3385(0x229)]||function(_0xf04428){const _0x6122ca=_0x2b3385;var _0x36aea9=[];for(var _0x301ab5 in _0xf04428)if(Object[_0x6122ca(0x223)][_0x6122ca(0x230)][_0x6122ca(0x24a)](_0xf04428,_0x301ab5))_0x36aea9[_0x36aea9['length']]=_0x301ab5;return _0x36aea9;},_0x560a40(_0x33b63c);};return function(_0x4d0608){const _0x4146ca=a14_0x5449;if(_0x4d0608&&_0x4d0608['__esModule'])return _0x4d0608;var _0x43b268={};if(_0x4d0608!=null){for(var _0x4ef8f2=_0x560a40(_0x4d0608),_0x5c3f44=0x0;_0x5c3f44<_0x4ef8f2[_0x4146ca(0x244)];_0x5c3f44++)if(_0x4ef8f2[_0x5c3f44]!==_0x4146ca(0x1dd))__createBinding(_0x43b268,_0x4d0608,_0x4ef8f2[_0x5c3f44]);}return __setModuleDefault(_0x43b268,_0x4d0608),_0x43b268;};}()),__importDefault=this&&this[a14_0xcafd41(0x1fd)]||function(_0x3cfc44){const _0xc06e70=a14_0xcafd41;return _0x3cfc44&&_0x3cfc44[_0xc06e70(0x201)]?_0x3cfc44:{'default':_0x3cfc44};};Object[a14_0xcafd41(0x200)](exports,a14_0xcafd41(0x201),{'value':!![]}),exports[a14_0xcafd41(0x217)]=void 0x0;const testGatewayService_1=require(a14_0xcafd41(0x22e)),webhookService_1=require(a14_0xcafd41(0x236)),database_1=__importDefault(require(a14_0xcafd41(0x1db)));class TestGatewayController{constructor(){const _0x2c7d14=a14_0xcafd41;this[_0x2c7d14(0x1d1)]=async(_0x1ecbc0,_0xf3e5df,_0x214e32)=>{const _0x4ad6c0=_0x2c7d14;try{const {paymentId:_0x17e89d}=_0x1ecbc0['params'];console[_0x4ad6c0(0x1d0)](_0x4ad6c0(0x24b)+_0x17e89d);const _0x20ab15=await database_1['default'][_0x4ad6c0(0x232)][_0x4ad6c0(0x1e8)]({'where':{'id':_0x17e89d},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x20ab15)return _0xf3e5df[_0x4ad6c0(0x205)](0x194)[_0x4ad6c0(0x1f0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x20ab15[_0x4ad6c0(0x252)]!==_0x4ad6c0(0x1fe))return _0xf3e5df[_0x4ad6c0(0x205)](0x190)[_0x4ad6c0(0x1f0)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x20ab15[_0x4ad6c0(0x205)]!==_0x4ad6c0(0x206))return _0xf3e5df[_0x4ad6c0(0x205)](0x190)[_0x4ad6c0(0x1f0)]({'success':![],'message':_0x4ad6c0(0x1df)+_0x20ab15[_0x4ad6c0(0x205)]+_0x4ad6c0(0x1f4)});_0xf3e5df[_0x4ad6c0(0x1f0)]({'success':!![],'result':{'paymentId':_0x20ab15['id'],'orderId':_0x20ab15['gatewayOrderId'],'amount':_0x20ab15[_0x4ad6c0(0x245)],'currency':_0x20ab15[_0x4ad6c0(0x203)],'merchantName':_0x20ab15['shop']['name'],'description':'Payment\x20to\x20'+_0x20ab15[_0x4ad6c0(0x233)][_0x4ad6c0(0x22f)],'testInstructions':{'successCard':_0x4ad6c0(0x242),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x4ad6c0(0x1dc),'cvc':_0x4ad6c0(0x1d4),'holderName':_0x4ad6c0(0x23c)}}});}catch(_0x4cb2bf){_0x214e32(_0x4cb2bf);}},this[_0x2c7d14(0x23a)]=async(_0x2c1f9c,_0x3870af,_0x4a6d59)=>{const _0xbdbcc1=_0x2c7d14;try{const {paymentId:_0x3b728e}=_0x2c1f9c['params'],_0x478a59=_0x2c1f9c['body'];console['log'](_0xbdbcc1(0x1f3)+_0x3b728e);const _0x1939bc=await database_1['default'][_0xbdbcc1(0x232)][_0xbdbcc1(0x1e8)]({'where':{'id':_0x3b728e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1939bc)return _0x3870af[_0xbdbcc1(0x205)](0x194)[_0xbdbcc1(0x1f0)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1939bc['gateway']!=='test_gateway')return _0x3870af[_0xbdbcc1(0x205)](0x190)[_0xbdbcc1(0x1f0)]({'success':![],'message':_0xbdbcc1(0x211)});if(_0x1939bc[_0xbdbcc1(0x205)]!==_0xbdbcc1(0x206))return _0x3870af[_0xbdbcc1(0x205)](0x190)[_0xbdbcc1(0x1f0)]({'success':![],'message':_0xbdbcc1(0x1df)+_0x1939bc['status']+',\x20cannot\x20process'});const _0x11a84f=await this[_0xbdbcc1(0x221)][_0xbdbcc1(0x237)]({'paymentId':_0x1939bc['id'],'orderId':_0x1939bc[_0xbdbcc1(0x22c)]||_0x1939bc['id'],'amount':_0x1939bc['amount'],'currency':_0x1939bc[_0xbdbcc1(0x203)],'cardData':_0x478a59});console[_0xbdbcc1(0x1d0)](_0xbdbcc1(0x1d3),_0x11a84f);const _0x20b484={'status':_0x11a84f['status'],'updatedAt':new Date()};if(_0x11a84f[_0xbdbcc1(0x205)]===_0xbdbcc1(0x1e5))_0x20b484[_0xbdbcc1(0x208)]=new Date(),_0x20b484[_0xbdbcc1(0x213)]=_0x11a84f[_0xbdbcc1(0x21f)];else _0x11a84f[_0xbdbcc1(0x205)]===_0xbdbcc1(0x1ed)&&(_0x20b484[_0xbdbcc1(0x1ee)]=_0x11a84f[_0xbdbcc1(0x1e7)]);const _0x545958=_0x478a59[_0xbdbcc1(0x20e)]['replace'](/[\s-]/g,'');_0x20b484[_0xbdbcc1(0x250)]=_0x545958[_0xbdbcc1(0x243)](-0x4),_0x20b484[_0xbdbcc1(0x1d6)]=_0xbdbcc1(0x1fc),await database_1[_0xbdbcc1(0x1dd)][_0xbdbcc1(0x232)]['update']({'where':{'id':_0x1939bc['id']},'data':_0x20b484});if(_0x11a84f[_0xbdbcc1(0x205)]===_0xbdbcc1(0x1e5)&&_0x1939bc[_0xbdbcc1(0x21d)]){console[_0xbdbcc1(0x1d0)](_0xbdbcc1(0x1ec)+_0x1939bc['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xbdbcc1(0x1dd)][_0xbdbcc1(0x1f6)](async _0x2da064=>{const _0x1f7c68=_0xbdbcc1,_0x36ac53=await _0x2da064[_0x1f7c68(0x23d)]['findUnique']({'where':{'id':_0x1939bc[_0x1f7c68(0x21d)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x36ac53){console['log'](_0x1f7c68(0x1f9)+_0x36ac53['id']+_0x1f7c68(0x210)+_0x36ac53[_0x1f7c68(0x1f1)]+_0x1f7c68(0x21e)+_0x36ac53[_0x1f7c68(0x1e1)]+_0x1f7c68(0x202)+_0x36ac53[_0x1f7c68(0x205)]);const _0x4f4c0f=_0x36ac53['currentPayments']+0x1,_0xcdf534=_0x36ac53['type']===_0x1f7c68(0x1e9)?_0x1f7c68(0x1d2):_0x36ac53[_0x1f7c68(0x205)];await _0x2da064['paymentLink'][_0x1f7c68(0x249)]({'where':{'id':_0x1939bc['paymentLinkId']},'data':{'currentPayments':_0x4f4c0f,'status':_0xcdf534,'updatedAt':new Date()}}),console[_0x1f7c68(0x1d0)]('✅\x20Payment\x20link\x20'+_0x36ac53['id']+_0x1f7c68(0x240)+_0x36ac53['currentPayments']+'\x20->\x20'+_0x4f4c0f+_0x1f7c68(0x202)+_0x36ac53['status']+_0x1f7c68(0x1da)+_0xcdf534);}else console[_0x1f7c68(0x1d0)]('❌\x20Payment\x20link\x20'+_0x1939bc[_0x1f7c68(0x21d)]+_0x1f7c68(0x22a));});}catch(_0x132a15){console[_0xbdbcc1(0x1f8)](_0xbdbcc1(0x214),_0x132a15);}}await database_1['default']['webhookLog'][_0xbdbcc1(0x241)]({'data':{'paymentId':_0x1939bc['id'],'shopId':_0x1939bc['shopId'],'event':'test_gateway_'+_0x11a84f[_0xbdbcc1(0x205)][_0xbdbcc1(0x231)](),'statusCode':0xc8,'responseBody':JSON[_0xbdbcc1(0x246)]({'oldStatus':_0xbdbcc1(0x206),'newStatus':_0x11a84f[_0xbdbcc1(0x205)],'transactionId':_0x11a84f[_0xbdbcc1(0x21f)],'failureReason':_0x11a84f[_0xbdbcc1(0x1e7)],'processedAt':new Date()[_0xbdbcc1(0x1eb)]()})}}),await this[_0xbdbcc1(0x22b)](_0x1939bc,_0x11a84f['status'],_0x11a84f[_0xbdbcc1(0x21f)],_0x11a84f[_0xbdbcc1(0x1e7)]),await this[_0xbdbcc1(0x24f)](_0x1939bc,_0x11a84f[_0xbdbcc1(0x205)]),console[_0xbdbcc1(0x1d0)](_0xbdbcc1(0x20f)+_0x3b728e+_0xbdbcc1(0x1e4)+_0x11a84f[_0xbdbcc1(0x205)]),_0x11a84f[_0xbdbcc1(0x205)]===_0xbdbcc1(0x1e5)?_0x3870af[_0xbdbcc1(0x1f0)]({'success':!![],'message':_0xbdbcc1(0x23e),'result':{'status':_0xbdbcc1(0x1e5),'transactionId':_0x11a84f['transactionId'],'redirectUrl':_0x1939bc[_0xbdbcc1(0x218)]}}):_0x3870af[_0xbdbcc1(0x205)](0x190)[_0xbdbcc1(0x1f0)]({'success':![],'message':_0xbdbcc1(0x20c),'result':{'status':_0xbdbcc1(0x1ed),'failureReason':_0x11a84f[_0xbdbcc1(0x1e7)],'redirectUrl':_0x1939bc[_0xbdbcc1(0x209)]}});}catch(_0x5ab91){_0x4a6d59(_0x5ab91);}},this[_0x2c7d14(0x221)]=new testGatewayService_1[(_0x2c7d14(0x1fb))](),this['webhookService']=new webhookService_1[(_0x2c7d14(0x234))]();}async[a14_0xcafd41(0x22b)](_0x131b1c,_0xe9fb63,_0x271d5f,_0x5bdf52){const _0x3ea3f4=a14_0xcafd41,_0x58b67b=Date['now']();try{const _0x41718f=_0x131b1c[_0x3ea3f4(0x233)],_0x787e10=_0x41718f[_0x3ea3f4(0x219)];if(!_0x787e10?.[_0x3ea3f4(0x222)]){console[_0x3ea3f4(0x1d0)](_0x3ea3f4(0x1fa)+_0x41718f['id']);return;}const _0x112acb=_0xe9fb63===_0x3ea3f4(0x1e5)?'payment.success':_0x3ea3f4(0x20d);let _0x3337ee=[];if(_0x787e10[_0x3ea3f4(0x204)])try{_0x3337ee=Array[_0x3ea3f4(0x24c)](_0x787e10['webhookEvents'])?_0x787e10[_0x3ea3f4(0x204)]:JSON[_0x3ea3f4(0x235)](_0x787e10[_0x3ea3f4(0x204)]);}catch(_0x509bb4){console['error'](_0x3ea3f4(0x1d9),_0x509bb4),_0x3337ee=[];}if(!_0x3337ee[_0x3ea3f4(0x1e2)](_0x112acb)){console[_0x3ea3f4(0x1d0)](_0x3ea3f4(0x1f5)+_0x112acb+'\x20not\x20enabled\x20for\x20shop\x20'+_0x41718f['id']);return;}const _0x246d3d={'event':_0x112acb,'payment':{'id':_0x131b1c['id'],'order_id':_0x131b1c[_0x3ea3f4(0x212)],'gateway_order_id':_0x131b1c[_0x3ea3f4(0x22c)],'gateway':'0000','amount':_0x131b1c[_0x3ea3f4(0x245)],'currency':_0x131b1c[_0x3ea3f4(0x203)],'status':_0xe9fb63[_0x3ea3f4(0x231)](),'customer_email':_0x131b1c[_0x3ea3f4(0x216)],'customer_name':_0x131b1c['customerName'],'transaction_id':_0x271d5f,'failure_message':_0x5bdf52,'created_at':_0x131b1c[_0x3ea3f4(0x22d)],'updated_at':new Date()}},_0x59e4af=await fetch(_0x787e10[_0x3ea3f4(0x222)],{'method':_0x3ea3f4(0x21c),'headers':{'Content-Type':_0x3ea3f4(0x24e),'User-Agent':_0x3ea3f4(0x21b)},'body':JSON[_0x3ea3f4(0x246)](_0x246d3d)}),_0x2b337c=Date[_0x3ea3f4(0x238)]()-_0x58b67b;console[_0x3ea3f4(0x1d0)](_0x3ea3f4(0x1d8)+_0x787e10[_0x3ea3f4(0x222)]+_0x3ea3f4(0x225)+_0x59e4af[_0x3ea3f4(0x205)]+'\x20('+_0x2b337c+_0x3ea3f4(0x20b));}catch(_0x5f4f91){console[_0x3ea3f4(0x1f8)](_0x3ea3f4(0x24d),_0x5f4f91);}}async[a14_0xcafd41(0x24f)](_0x31f0a9,_0xcb21cf){const _0x36d6ee=a14_0xcafd41;try{const {telegramBotService:_0x35dc8d}=await Promise[_0x36d6ee(0x1ea)]()[_0x36d6ee(0x1d7)](()=>__importStar(require(_0x36d6ee(0x23f)))),_0x332552={'PAID':'paid','FAILED':_0x36d6ee(0x21a)},_0x93ceba=_0x332552[_0xcb21cf];if(!_0x93ceba)return;await _0x35dc8d[_0x36d6ee(0x227)](_0x31f0a9[_0x36d6ee(0x239)],_0x31f0a9,_0x93ceba);}catch(_0x4fd66e){console['error'](_0x36d6ee(0x226),_0x4fd66e);}}}function a14_0x64d8(){const _0x32611a=['json','type','160762BNTJiO','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20',',\x20cannot\x20process','Webhook\x20event\x20','$transaction','configurable','error','📈\x20Found\x20payment\x20link\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','TestGatewayService','test_card','__importDefault','test_gateway','writable','defineProperty','__esModule',',\x20status=','currency','webhookEvents','status','PENDING','7912GNaRfS','paidAt','failUrl','__setModuleDefault','ms)','Payment\x20failed','payment.failed','cardNumber','✅\x20Test\x20Gateway\x20payment\x20',':\x20type=','Payment\x20is\x20not\x20for\x20test\x20gateway','orderId','gatewayPaymentId','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','1365007ITeKgV','customerEmail','TestGatewayController','successUrl','settings','failed','Payment\x20System/1.0\x20(Test\x20Gateway)','POST','paymentLinkId',',\x20currentPayments=','transactionId','6857675VgAULG','testGatewayService','webhookUrl','prototype','4dxeYRw','\x20with\x20status\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentNotification','156yYUTqy','getOwnPropertyNames','\x20not\x20found','sendShopWebhook','gatewayOrderId','createdAt','../services/gateways/testGatewayService','name','hasOwnProperty','toLowerCase','payment','shop','WebhookService','parse','../services/webhookService','processCardPayment','now','shopId','processCard','28472652EGNEXc','Any\x20name','paymentLink','Payment\x20processed\x20successfully','../services/telegramBotService','\x20updated:\x20currentPayments=','create','4242\x204242\x204242\x204242','slice','length','amount','stringify','32980HPcBMB','606kueWdF','update','call','🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','isArray','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','application/json','sendPaymentStatusNotification','cardLast4','4609VhnIpY','gateway','log','getPaymentForm','COMPLETED','🧪\x20Test\x20Gateway\x20result:','Any\x203-4\x20digits','__createBinding','paymentMethod','then','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Error\x20parsing\x20webhook\x20events:','\x20->\x20','../config/database','Any\x20future\x20date\x20(MM/YY)','default','5949FDXYPa','Payment\x20status\x20is\x20','11982oTSyji','currentPayments','includes','get','\x20processed:\x20','PAID','__importStar','failureReason','findUnique','SINGLE','resolve','toISOString','📈\x20Test\x20Gateway:\x20Payment\x20','FAILED','failureMessage','getOwnPropertyDescriptor'];a14_0x64d8=function(){return _0x32611a;};return a14_0x64d8();}exports[a14_0xcafd41(0x217)]=TestGatewayController;