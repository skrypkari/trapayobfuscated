'use strict';const a13_0x43a211=a13_0x3d59;(function(_0x1e62b8,_0x55176d){const _0x17d4c2=a13_0x3d59,_0x2804a7=_0x1e62b8();while(!![]){try{const _0xbc621e=parseInt(_0x17d4c2(0x1e8))/0x1+-parseInt(_0x17d4c2(0x201))/0x2+parseInt(_0x17d4c2(0x21b))/0x3+-parseInt(_0x17d4c2(0x20d))/0x4*(parseInt(_0x17d4c2(0x232))/0x5)+-parseInt(_0x17d4c2(0x20a))/0x6+-parseInt(_0x17d4c2(0x20e))/0x7*(parseInt(_0x17d4c2(0x22d))/0x8)+-parseInt(_0x17d4c2(0x1ed))/0x9*(-parseInt(_0x17d4c2(0x1f0))/0xa);if(_0xbc621e===_0x55176d)break;else _0x2804a7['push'](_0x2804a7['shift']());}catch(_0x3a1473){_0x2804a7['push'](_0x2804a7['shift']());}}}(a13_0x5413,0xb6342));function a13_0x5413(){const _0x26e579=['successUrl','4128660YJVXfA','webhookEvents','transactionId','30YtiDxk','../config/database','paymentMethod','params','payment.success','log','Payment\x20to\x20','paid','shopId','amount','createdAt','../services/gateways/testGatewayService','WebhookService','status','__esModule','__importStar','findUnique','1549272gXCPBT','webhookService','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','create','0000','Error\x20parsing\x20webhook\x20events:','webhookLog','Payment\x20is\x20not\x20for\x20test\x20gateway','âœ…\x20Test\x20Gateway\x20payment\x20','7176870YhsFhE','writable','Any\x20name','20AVUEwF','1330fWdvcI','POST','Any\x203-4\x20digits','TestGatewayController','payment','Payment\x20failed','resolve','sendPaymentNotification','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','stringify','Webhook\x20event\x20','slice','__setModuleDefault','2659434QGpsok','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','FAILED','orderId','toLowerCase','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','testGatewayService','PAID','gateway','now','paidAt','toISOString','sendPaymentStatusNotification','Payment\x20processed\x20successfully','failureMessage','Payment\x20not\x20found','shop','name','4000HkEKYE','failureReason','ðŸ§ª\x20Test\x20Gateway\x20result:','processCard','json','725425ObCAfR','default','defineProperty','gatewayOrderId','cardLast4','payment.failed','getPaymentForm','configurable','Any\x20other\x20card\x20number','\x20with\x20status\x20','error','cardNumber','prototype','length','test_gateway_','settings','replace','update','body','TestGatewayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',',\x20cannot\x20process','4242\x204242\x204242\x204242','webhookUrl','PENDING','test_gateway','__createBinding','../services/webhookService','ms)','get','1274814jvaKYU','getOwnPropertyDescriptor','failed','currency'];a13_0x5413=function(){return _0x26e579;};return a13_0x5413();}function a13_0x3d59(_0xdeda46,_0x8a18e5){const _0x54135d=a13_0x5413();return a13_0x3d59=function(_0x3d59d6,_0xca283e){_0x3d59d6=_0x3d59d6-0x1df;let _0x100982=_0x54135d[_0x3d59d6];return _0x100982;},a13_0x3d59(_0xdeda46,_0x8a18e5);}var __createBinding=this&&this[a13_0x43a211(0x1e4)]||(Object[a13_0x43a211(0x204)]?function(_0x288641,_0x163474,_0x34fb09,_0x1eccee){const _0x5d5ae7=a13_0x43a211;if(_0x1eccee===undefined)_0x1eccee=_0x34fb09;var _0x31e300=Object[_0x5d5ae7(0x1e9)](_0x163474,_0x34fb09);(!_0x31e300||(_0x5d5ae7(0x1e7)in _0x31e300?!_0x163474[_0x5d5ae7(0x1fe)]:_0x31e300[_0x5d5ae7(0x20b)]||_0x31e300[_0x5d5ae7(0x239)]))&&(_0x31e300={'enumerable':!![],'get':function(){return _0x163474[_0x34fb09];}}),Object[_0x5d5ae7(0x234)](_0x288641,_0x1eccee,_0x31e300);}:function(_0x3a7398,_0x23a0fd,_0x21438c,_0x1a6e31){if(_0x1a6e31===undefined)_0x1a6e31=_0x21438c;_0x3a7398[_0x1a6e31]=_0x23a0fd[_0x21438c];}),__setModuleDefault=this&&this[a13_0x43a211(0x21a)]||(Object['create']?function(_0x492eeb,_0x381868){const _0x447baf=a13_0x43a211;Object[_0x447baf(0x234)](_0x492eeb,_0x447baf(0x233),{'enumerable':!![],'value':_0x381868});}:function(_0x3330ab,_0x48bfcf){_0x3330ab['default']=_0x48bfcf;}),__importStar=this&&this[a13_0x43a211(0x1ff)]||(function(){var _0x31fba3=function(_0x3aec08){return _0x31fba3=Object['getOwnPropertyNames']||function(_0x3da1e5){const _0x4da665=a13_0x3d59;var _0x535909=[];for(var _0x3c6682 in _0x3da1e5)if(Object[_0x4da665(0x23e)]['hasOwnProperty']['call'](_0x3da1e5,_0x3c6682))_0x535909[_0x535909[_0x4da665(0x23f)]]=_0x3c6682;return _0x535909;},_0x31fba3(_0x3aec08);};return function(_0x176a68){const _0x8ad380=a13_0x3d59;if(_0x176a68&&_0x176a68[_0x8ad380(0x1fe)])return _0x176a68;var _0xcbfb94={};if(_0x176a68!=null){for(var _0x36ca6d=_0x31fba3(_0x176a68),_0x26ced4=0x0;_0x26ced4<_0x36ca6d[_0x8ad380(0x23f)];_0x26ced4++)if(_0x36ca6d[_0x26ced4]!==_0x8ad380(0x233))__createBinding(_0xcbfb94,_0x176a68,_0x36ca6d[_0x26ced4]);}return __setModuleDefault(_0xcbfb94,_0x176a68),_0xcbfb94;};}()),__importDefault=this&&this['__importDefault']||function(_0x520f32){const _0x2e4e10=a13_0x43a211;return _0x520f32&&_0x520f32[_0x2e4e10(0x1fe)]?_0x520f32:{'default':_0x520f32};};Object[a13_0x43a211(0x234)](exports,a13_0x43a211(0x1fe),{'value':!![]}),exports[a13_0x43a211(0x211)]=void 0x0;const testGatewayService_1=require(a13_0x43a211(0x1fb)),webhookService_1=require(a13_0x43a211(0x1e5)),database_1=__importDefault(require(a13_0x43a211(0x1f1)));class TestGatewayController{constructor(){const _0x44b36c=a13_0x43a211;this[_0x44b36c(0x238)]=async(_0x331879,_0x5cb67a,_0xc687e0)=>{const _0x56173d=_0x44b36c;try{const {paymentId:_0x31cb13}=_0x331879['params'];console['log'](_0x56173d(0x21c)+_0x31cb13);const _0x502876=await database_1['default'][_0x56173d(0x212)][_0x56173d(0x200)]({'where':{'id':_0x31cb13},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x502876)return _0x5cb67a['status'](0x194)[_0x56173d(0x231)]({'success':![],'message':_0x56173d(0x22a)});if(_0x502876['gateway']!==_0x56173d(0x1e3))return _0x5cb67a[_0x56173d(0x1fd)](0x190)[_0x56173d(0x231)]({'success':![],'message':_0x56173d(0x208)});if(_0x502876[_0x56173d(0x1fd)]!==_0x56173d(0x1e2))return _0x5cb67a[_0x56173d(0x1fd)](0x190)[_0x56173d(0x231)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x502876[_0x56173d(0x1fd)]+',\x20cannot\x20process'});_0x5cb67a[_0x56173d(0x231)]({'success':!![],'result':{'paymentId':_0x502876['id'],'orderId':_0x502876[_0x56173d(0x235)],'amount':_0x502876[_0x56173d(0x1f9)],'currency':_0x502876[_0x56173d(0x1eb)],'merchantName':_0x502876[_0x56173d(0x22b)][_0x56173d(0x22c)],'description':_0x56173d(0x1f6)+_0x502876[_0x56173d(0x22b)][_0x56173d(0x22c)],'testInstructions':{'successCard':_0x56173d(0x1e0),'failureCard':_0x56173d(0x23a),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x56173d(0x210),'holderName':_0x56173d(0x20c)}}});}catch(_0x29fded){_0xc687e0(_0x29fded);}},this[_0x44b36c(0x230)]=async(_0x15d8d2,_0x1b688c,_0x2793e6)=>{const _0x513629=_0x44b36c;try{const {paymentId:_0x2cb392}=_0x15d8d2[_0x513629(0x1f3)],_0x5672b6=_0x15d8d2[_0x513629(0x244)];console[_0x513629(0x1f5)](_0x513629(0x216)+_0x2cb392);const _0x4ab8eb=await database_1[_0x513629(0x233)]['payment'][_0x513629(0x200)]({'where':{'id':_0x2cb392},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4ab8eb)return _0x1b688c[_0x513629(0x1fd)](0x194)[_0x513629(0x231)]({'success':![],'message':_0x513629(0x22a)});if(_0x4ab8eb[_0x513629(0x223)]!==_0x513629(0x1e3))return _0x1b688c['status'](0x190)[_0x513629(0x231)]({'success':![],'message':_0x513629(0x208)});if(_0x4ab8eb[_0x513629(0x1fd)]!==_0x513629(0x1e2))return _0x1b688c[_0x513629(0x1fd)](0x190)[_0x513629(0x231)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4ab8eb[_0x513629(0x1fd)]+_0x513629(0x1df)});const _0x20164f=await this[_0x513629(0x221)]['processCardPayment']({'paymentId':_0x4ab8eb['id'],'orderId':_0x4ab8eb[_0x513629(0x235)]||_0x4ab8eb['id'],'amount':_0x4ab8eb[_0x513629(0x1f9)],'currency':_0x4ab8eb[_0x513629(0x1eb)],'cardData':_0x5672b6});console[_0x513629(0x1f5)](_0x513629(0x22f),_0x20164f);const _0x3c7963={'status':_0x20164f[_0x513629(0x1fd)],'updatedAt':new Date()};if(_0x20164f['status']===_0x513629(0x222))_0x3c7963[_0x513629(0x225)]=new Date(),_0x3c7963['gatewayPaymentId']=_0x20164f[_0x513629(0x1ef)];else _0x20164f['status']===_0x513629(0x21d)&&(_0x3c7963[_0x513629(0x229)]=_0x20164f[_0x513629(0x22e)]);const _0x553e10=_0x5672b6[_0x513629(0x23d)][_0x513629(0x242)](/[\s-]/g,'');_0x3c7963[_0x513629(0x236)]=_0x553e10[_0x513629(0x219)](-0x4),_0x3c7963[_0x513629(0x1f2)]='test_card',await database_1[_0x513629(0x233)][_0x513629(0x212)][_0x513629(0x243)]({'where':{'id':_0x4ab8eb['id']},'data':_0x3c7963}),await database_1[_0x513629(0x233)][_0x513629(0x207)][_0x513629(0x204)]({'data':{'paymentId':_0x4ab8eb['id'],'shopId':_0x4ab8eb[_0x513629(0x1f8)],'event':_0x513629(0x240)+_0x20164f[_0x513629(0x1fd)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x513629(0x1e2),'newStatus':_0x20164f[_0x513629(0x1fd)],'transactionId':_0x20164f[_0x513629(0x1ef)],'failureReason':_0x20164f[_0x513629(0x22e)],'processedAt':new Date()[_0x513629(0x226)]()})}}),await this['sendShopWebhook'](_0x4ab8eb,_0x20164f[_0x513629(0x1fd)],_0x20164f[_0x513629(0x1ef)],_0x20164f[_0x513629(0x22e)]),await this[_0x513629(0x227)](_0x4ab8eb,_0x20164f[_0x513629(0x1fd)]),console[_0x513629(0x1f5)](_0x513629(0x209)+_0x2cb392+'\x20processed:\x20'+_0x20164f[_0x513629(0x1fd)]),_0x20164f[_0x513629(0x1fd)]==='PAID'?_0x1b688c[_0x513629(0x231)]({'success':!![],'message':_0x513629(0x228),'result':{'status':'PAID','transactionId':_0x20164f[_0x513629(0x1ef)],'redirectUrl':_0x4ab8eb[_0x513629(0x1ec)]}}):_0x1b688c['status'](0x190)[_0x513629(0x231)]({'success':![],'message':_0x513629(0x213),'result':{'status':_0x513629(0x21d),'failureReason':_0x20164f[_0x513629(0x22e)],'redirectUrl':_0x4ab8eb['failUrl']}});}catch(_0x5b08ce){_0x2793e6(_0x5b08ce);}},this[_0x44b36c(0x221)]=new testGatewayService_1[(_0x44b36c(0x245))](),this[_0x44b36c(0x202)]=new webhookService_1[(_0x44b36c(0x1fc))]();}async['sendShopWebhook'](_0x3311ff,_0x4b3e38,_0x362585,_0x491cfc){const _0x5228a0=a13_0x43a211,_0x1b739b=Date[_0x5228a0(0x224)]();try{const _0x507704=_0x3311ff['shop'],_0x3aa918=_0x507704[_0x5228a0(0x241)];if(!_0x3aa918?.[_0x5228a0(0x1e1)]){console[_0x5228a0(0x1f5)](_0x5228a0(0x220)+_0x507704['id']);return;}const _0x149365=_0x4b3e38==='PAID'?_0x5228a0(0x1f4):_0x5228a0(0x237);let _0x24e577=[];if(_0x3aa918[_0x5228a0(0x1ee)])try{_0x24e577=Array['isArray'](_0x3aa918[_0x5228a0(0x1ee)])?_0x3aa918[_0x5228a0(0x1ee)]:JSON['parse'](_0x3aa918['webhookEvents']);}catch(_0x53c19b){console[_0x5228a0(0x23c)](_0x5228a0(0x206),_0x53c19b),_0x24e577=[];}if(!_0x24e577['includes'](_0x149365)){console[_0x5228a0(0x1f5)](_0x5228a0(0x218)+_0x149365+'\x20not\x20enabled\x20for\x20shop\x20'+_0x507704['id']);return;}const _0x5b148c={'event':_0x149365,'payment':{'id':_0x3311ff['id'],'order_id':_0x3311ff[_0x5228a0(0x21e)],'gateway_order_id':_0x3311ff[_0x5228a0(0x235)],'gateway':_0x5228a0(0x205),'amount':_0x3311ff[_0x5228a0(0x1f9)],'currency':_0x3311ff[_0x5228a0(0x1eb)],'status':_0x4b3e38[_0x5228a0(0x21f)](),'customer_email':_0x3311ff['customerEmail'],'customer_name':_0x3311ff['customerName'],'transaction_id':_0x362585,'failure_message':_0x491cfc,'created_at':_0x3311ff[_0x5228a0(0x1fa)],'updated_at':new Date()}},_0x912ae=await fetch(_0x3aa918[_0x5228a0(0x1e1)],{'method':_0x5228a0(0x20f),'headers':{'Content-Type':'application/json','User-Agent':_0x5228a0(0x203)},'body':JSON[_0x5228a0(0x217)](_0x5b148c)}),_0x408822=Date['now']()-_0x1b739b;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x3aa918[_0x5228a0(0x1e1)]+_0x5228a0(0x23b)+_0x912ae[_0x5228a0(0x1fd)]+'\x20('+_0x408822+_0x5228a0(0x1e6));}catch(_0x41404e){console[_0x5228a0(0x23c)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x41404e);}}async['sendPaymentStatusNotification'](_0x574d7e,_0x49b44e){const _0x5b603d=a13_0x43a211;try{const {telegramBotService:_0x2a8660}=await Promise[_0x5b603d(0x214)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x410687={'PAID':_0x5b603d(0x1f7),'FAILED':_0x5b603d(0x1ea)},_0xbd2a2a=_0x410687[_0x49b44e];if(!_0xbd2a2a)return;await _0x2a8660[_0x5b603d(0x215)](_0x574d7e[_0x5b603d(0x1f8)],_0x574d7e,_0xbd2a2a);}catch(_0x1c3f8a){console[_0x5b603d(0x23c)](_0x5b603d(0x246),_0x1c3f8a);}}}exports[a13_0x43a211(0x211)]=TestGatewayController;