'use strict';const a15_0x1db78=a15_0x3971;function a15_0x3971(_0x3390cf,_0x124c00){const _0x21276f=a15_0x2127();return a15_0x3971=function(_0x397187,_0x1d8e8a){_0x397187=_0x397187-0x77;let _0x557e7b=_0x21276f[_0x397187];return _0x557e7b;},a15_0x3971(_0x3390cf,_0x124c00);}(function(_0x2b9d62,_0x9c6c17){const _0x5a48f4=a15_0x3971,_0x6bab0f=_0x2b9d62();while(!![]){try{const _0x261ccb=-parseInt(_0x5a48f4(0x83))/0x1*(parseInt(_0x5a48f4(0xda))/0x2)+-parseInt(_0x5a48f4(0xcb))/0x3*(parseInt(_0x5a48f4(0xcc))/0x4)+parseInt(_0x5a48f4(0x91))/0x5+-parseInt(_0x5a48f4(0x84))/0x6*(-parseInt(_0x5a48f4(0xdf))/0x7)+parseInt(_0x5a48f4(0xde))/0x8+-parseInt(_0x5a48f4(0xa5))/0x9*(-parseInt(_0x5a48f4(0xc0))/0xa)+-parseInt(_0x5a48f4(0xa3))/0xb;if(_0x261ccb===_0x9c6c17)break;else _0x6bab0f['push'](_0x6bab0f['shift']());}catch(_0x489cf2){_0x6bab0f['push'](_0x6bab0f['shift']());}}}(a15_0x2127,0x66d52));var __createBinding=this&&this[a15_0x1db78(0xb6)]||(Object[a15_0x1db78(0xc8)]?function(_0xfa2c,_0x25fee,_0x306705,_0x4ea798){const _0x4c6a92=a15_0x1db78;if(_0x4ea798===undefined)_0x4ea798=_0x306705;var _0x3c1a6a=Object['getOwnPropertyDescriptor'](_0x25fee,_0x306705);(!_0x3c1a6a||(_0x4c6a92(0xa8)in _0x3c1a6a?!_0x25fee[_0x4c6a92(0xdb)]:_0x3c1a6a[_0x4c6a92(0xa0)]||_0x3c1a6a[_0x4c6a92(0xd3)]))&&(_0x3c1a6a={'enumerable':!![],'get':function(){return _0x25fee[_0x306705];}}),Object[_0x4c6a92(0x8f)](_0xfa2c,_0x4ea798,_0x3c1a6a);}:function(_0x24a533,_0x283ee0,_0x376858,_0x30e58e){if(_0x30e58e===undefined)_0x30e58e=_0x376858;_0x24a533[_0x30e58e]=_0x283ee0[_0x376858];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x2f468e,_0x12fb4d){const _0x56c853=a15_0x1db78;Object[_0x56c853(0x8f)](_0x2f468e,_0x56c853(0xd5),{'enumerable':!![],'value':_0x12fb4d});}:function(_0x4cf940,_0x1d8757){const _0x127625=a15_0x1db78;_0x4cf940[_0x127625(0xd5)]=_0x1d8757;}),__importStar=this&&this['__importStar']||(function(){var _0x19ccc1=function(_0x45da26){const _0x240c09=a15_0x3971;return _0x19ccc1=Object[_0x240c09(0xb7)]||function(_0x3510cf){const _0x3ef479=_0x240c09;var _0x3eb597=[];for(var _0x16f7d0 in _0x3510cf)if(Object[_0x3ef479(0x9a)][_0x3ef479(0x87)]['call'](_0x3510cf,_0x16f7d0))_0x3eb597[_0x3eb597[_0x3ef479(0xc6)]]=_0x16f7d0;return _0x3eb597;},_0x19ccc1(_0x45da26);};return function(_0x39abd3){const _0x2cf47e=a15_0x3971;if(_0x39abd3&&_0x39abd3[_0x2cf47e(0xdb)])return _0x39abd3;var _0x47b988={};if(_0x39abd3!=null){for(var _0x2c926d=_0x19ccc1(_0x39abd3),_0x4716c9=0x0;_0x4716c9<_0x2c926d[_0x2cf47e(0xc6)];_0x4716c9++)if(_0x2c926d[_0x4716c9]!==_0x2cf47e(0xd5))__createBinding(_0x47b988,_0x39abd3,_0x2c926d[_0x4716c9]);}return __setModuleDefault(_0x47b988,_0x39abd3),_0x47b988;};}()),__importDefault=this&&this[a15_0x1db78(0x8c)]||function(_0x4cf11b){return _0x4cf11b&&_0x4cf11b['__esModule']?_0x4cf11b:{'default':_0x4cf11b};};Object[a15_0x1db78(0x8f)](exports,a15_0x1db78(0xdb),{'value':!![]}),exports[a15_0x1db78(0xdc)]=void 0x0;function a15_0x2127(){const _0xde908f=['defineProperty',',\x20currentPayments=','1606725hTpWxw','\x20updated:\x20currentPayments=','paymentLinkId','Payment\x20System/1.0\x20(Test\x20Gateway)','getPaymentForm','Payment\x20processed\x20successfully','createdAt','currentPayments','\x20->\x20','prototype','failureReason','sendShopWebhook','test_card','gatewayPaymentId','Any\x203-4\x20digits','writable','failureMessage','failUrl','10843338TQAgEa','sendPaymentStatusNotification','5860521lvweTi','customerEmail','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','get','json','stringify','\x20not\x20found','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.failed','gateway',',\x20status=','webhookLog','now','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Webhook\x20event\x20','üìà\x20Test\x20Gateway:\x20Payment\x20','update','__createBinding','getOwnPropertyNames','‚úÖ\x20Payment\x20link\x20','\x20with\x20status\x20','processCardPayment','ms)','../services/webhookService','findUnique','POST','orderId','10YUapOl','Any\x20future\x20date\x20(MM/YY)','shopId','‚úÖ\x20Test\x20Gateway\x20payment\x20','settings','Payment\x20status\x20is\x20','length','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','create','4242\x204242\x204242\x204242','body','3GNWAjd','1536588VUZzfg','type','cardNumber','Payment\x20is\x20not\x20for\x20test\x20gateway','gatewayOrderId','resolve','shop','configurable','\x20processed:\x20','default','name','‚ùå\x20Payment\x20link\x20','error','log','25742ZSTKMG','__esModule','TestGatewayController','payment','6716896fAOLsr','7YOOcHS','üìà\x20Found\x20payment\x20link\x20','testGatewayService','params','toLowerCase',',\x20cannot\x20process','status','parse','SINGLE','includes','../config/database','amount','then','customerName','paymentLink','processCard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookService','test_gateway','Any\x20other\x20card\x20number','webhookUrl','paidAt','PAID','PENDING','failed','32wiyCZl','2345118vsTyDV','paymentMethod','COMPLETED','hasOwnProperty','webhookEvents','Any\x20name','$transaction','slice','__importDefault','FAILED','transactionId'];a15_0x2127=function(){return _0xde908f;};return a15_0x2127();}const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a15_0x1db78(0xbc)),database_1=__importDefault(require(a15_0x1db78(0xe9)));class TestGatewayController{constructor(){const _0x493e8e=a15_0x1db78;this[_0x493e8e(0x95)]=async(_0x3808ea,_0x567cd8,_0x586160)=>{const _0xc6173=_0x493e8e;try{const {paymentId:_0x4fcaf1}=_0x3808ea[_0xc6173(0xe2)];console[_0xc6173(0xd9)](_0xc6173(0xa7)+_0x4fcaf1);const _0x147c76=await database_1[_0xc6173(0xd5)][_0xc6173(0xdd)][_0xc6173(0xbd)]({'where':{'id':_0x4fcaf1},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x147c76)return _0x567cd8[_0xc6173(0xe5)](0x194)[_0xc6173(0xa9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x147c76[_0xc6173(0xae)]!==_0xc6173(0x7c))return _0x567cd8[_0xc6173(0xe5)](0x190)[_0xc6173(0xa9)]({'success':![],'message':_0xc6173(0xcf)});if(_0x147c76[_0xc6173(0xe5)]!=='PENDING')return _0x567cd8[_0xc6173(0xe5)](0x190)[_0xc6173(0xa9)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x147c76[_0xc6173(0xe5)]+_0xc6173(0xe4)});_0x567cd8[_0xc6173(0xa9)]({'success':!![],'result':{'paymentId':_0x147c76['id'],'orderId':_0x147c76[_0xc6173(0xd0)],'amount':_0x147c76[_0xc6173(0xea)],'currency':_0x147c76['currency'],'merchantName':_0x147c76[_0xc6173(0xd2)][_0xc6173(0xd6)],'description':'Payment\x20to\x20'+_0x147c76[_0xc6173(0xd2)][_0xc6173(0xd6)],'testInstructions':{'successCard':_0xc6173(0xc9),'failureCard':_0xc6173(0x7d),'expiryDate':_0xc6173(0xc1),'cvc':_0xc6173(0x9f),'holderName':_0xc6173(0x89)}}});}catch(_0x195782){_0x586160(_0x195782);}},this[_0x493e8e(0x79)]=async(_0x4a9d0c,_0x53a53b,_0xfade18)=>{const _0x511fae=_0x493e8e;try{const {paymentId:_0x30f0d8}=_0x4a9d0c[_0x511fae(0xe2)],_0x542dc6=_0x4a9d0c[_0x511fae(0xca)];console[_0x511fae(0xd9)](_0x511fae(0xb2)+_0x30f0d8);const _0x560fdc=await database_1[_0x511fae(0xd5)][_0x511fae(0xdd)][_0x511fae(0xbd)]({'where':{'id':_0x30f0d8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x560fdc)return _0x53a53b[_0x511fae(0xe5)](0x194)[_0x511fae(0xa9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x560fdc[_0x511fae(0xae)]!==_0x511fae(0x7c))return _0x53a53b[_0x511fae(0xe5)](0x190)[_0x511fae(0xa9)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x560fdc[_0x511fae(0xe5)]!==_0x511fae(0x81))return _0x53a53b['status'](0x190)[_0x511fae(0xa9)]({'success':![],'message':_0x511fae(0xc5)+_0x560fdc[_0x511fae(0xe5)]+_0x511fae(0xe4)});const _0x4dce1d=await this['testGatewayService'][_0x511fae(0xba)]({'paymentId':_0x560fdc['id'],'orderId':_0x560fdc[_0x511fae(0xd0)]||_0x560fdc['id'],'amount':_0x560fdc[_0x511fae(0xea)],'currency':_0x560fdc['currency'],'cardData':_0x542dc6});console['log']('üß™\x20Test\x20Gateway\x20result:',_0x4dce1d);const _0x2d28c8={'status':_0x4dce1d[_0x511fae(0xe5)],'updatedAt':new Date()};if(_0x4dce1d['status']==='PAID')_0x2d28c8[_0x511fae(0x7f)]=new Date(),_0x2d28c8[_0x511fae(0x9e)]=_0x4dce1d[_0x511fae(0x8e)];else _0x4dce1d[_0x511fae(0xe5)]===_0x511fae(0x8d)&&(_0x2d28c8[_0x511fae(0xa1)]=_0x4dce1d[_0x511fae(0x9b)]);const _0x5ea636=_0x542dc6[_0x511fae(0xce)]['replace'](/[\s-]/g,'');_0x2d28c8['cardLast4']=_0x5ea636[_0x511fae(0x8b)](-0x4),_0x2d28c8[_0x511fae(0x85)]=_0x511fae(0x9d),await database_1[_0x511fae(0xd5)]['payment'][_0x511fae(0xb5)]({'where':{'id':_0x560fdc['id']},'data':_0x2d28c8});if(_0x4dce1d[_0x511fae(0xe5)]===_0x511fae(0x80)&&_0x560fdc[_0x511fae(0x93)]){console[_0x511fae(0xd9)](_0x511fae(0xb4)+_0x560fdc['id']+_0x511fae(0xc7));try{await database_1[_0x511fae(0xd5)][_0x511fae(0x8a)](async _0x5c847a=>{const _0x352479=_0x511fae,_0xb4d437=await _0x5c847a[_0x352479(0x78)][_0x352479(0xbd)]({'where':{'id':_0x560fdc[_0x352479(0x93)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xb4d437){console[_0x352479(0xd9)](_0x352479(0xe0)+_0xb4d437['id']+':\x20type='+_0xb4d437[_0x352479(0xcd)]+_0x352479(0x90)+_0xb4d437[_0x352479(0x98)]+_0x352479(0xaf)+_0xb4d437[_0x352479(0xe5)]);const _0x1846e6=_0xb4d437[_0x352479(0x98)]+0x1,_0x348ee3=_0xb4d437[_0x352479(0xcd)]===_0x352479(0xe7)?_0x352479(0x86):_0xb4d437[_0x352479(0xe5)];await _0x5c847a[_0x352479(0x78)][_0x352479(0xb5)]({'where':{'id':_0x560fdc['paymentLinkId']},'data':{'currentPayments':_0x1846e6,'status':_0x348ee3,'updatedAt':new Date()}}),console[_0x352479(0xd9)](_0x352479(0xb8)+_0xb4d437['id']+_0x352479(0x92)+_0xb4d437[_0x352479(0x98)]+_0x352479(0x99)+_0x1846e6+_0x352479(0xaf)+_0xb4d437['status']+_0x352479(0x99)+_0x348ee3);}else console[_0x352479(0xd9)](_0x352479(0xd7)+_0x560fdc['paymentLinkId']+_0x352479(0xab));});}catch(_0x57d36c){console[_0x511fae(0xd8)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x57d36c);}}await database_1[_0x511fae(0xd5)][_0x511fae(0xb0)][_0x511fae(0xc8)]({'data':{'paymentId':_0x560fdc['id'],'shopId':_0x560fdc[_0x511fae(0xc2)],'event':'test_gateway_'+_0x4dce1d[_0x511fae(0xe5)][_0x511fae(0xe3)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x511fae(0x81),'newStatus':_0x4dce1d[_0x511fae(0xe5)],'transactionId':_0x4dce1d['transactionId'],'failureReason':_0x4dce1d[_0x511fae(0x9b)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x560fdc,_0x4dce1d[_0x511fae(0xe5)],_0x4dce1d[_0x511fae(0x8e)],_0x4dce1d[_0x511fae(0x9b)]),await this['sendPaymentStatusNotification'](_0x560fdc,_0x4dce1d['status']),console[_0x511fae(0xd9)](_0x511fae(0xc3)+_0x30f0d8+_0x511fae(0xd4)+_0x4dce1d[_0x511fae(0xe5)]),_0x4dce1d[_0x511fae(0xe5)]==='PAID'?_0x53a53b[_0x511fae(0xa9)]({'success':!![],'message':_0x511fae(0x96),'result':{'status':'PAID','transactionId':_0x4dce1d['transactionId'],'redirectUrl':_0x560fdc['successUrl']}}):_0x53a53b['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','failureReason':_0x4dce1d[_0x511fae(0x9b)],'redirectUrl':_0x560fdc[_0x511fae(0xa2)]}});}catch(_0x16b030){_0xfade18(_0x16b030);}},this[_0x493e8e(0xe1)]=new testGatewayService_1['TestGatewayService'](),this[_0x493e8e(0x7b)]=new webhookService_1['WebhookService']();}async[a15_0x1db78(0x9c)](_0x137e4c,_0x5013c8,_0x2558de,_0x454f66){const _0x2a74cf=a15_0x1db78,_0xc86a89=Date[_0x2a74cf(0xb1)]();try{const _0x346e2c=_0x137e4c['shop'],_0x5623ce=_0x346e2c[_0x2a74cf(0xc4)];if(!_0x5623ce?.[_0x2a74cf(0x7e)]){console['log'](_0x2a74cf(0x7a)+_0x346e2c['id']);return;}const _0xdba442=_0x5013c8===_0x2a74cf(0x80)?'payment.success':_0x2a74cf(0xad);let _0x3cc0ab=[];if(_0x5623ce[_0x2a74cf(0x88)])try{_0x3cc0ab=Array['isArray'](_0x5623ce[_0x2a74cf(0x88)])?_0x5623ce[_0x2a74cf(0x88)]:JSON[_0x2a74cf(0xe6)](_0x5623ce[_0x2a74cf(0x88)]);}catch(_0x105d8e){console[_0x2a74cf(0xd8)]('Error\x20parsing\x20webhook\x20events:',_0x105d8e),_0x3cc0ab=[];}if(!_0x3cc0ab[_0x2a74cf(0xe8)](_0xdba442)){console[_0x2a74cf(0xd9)](_0x2a74cf(0xb3)+_0xdba442+'\x20not\x20enabled\x20for\x20shop\x20'+_0x346e2c['id']);return;}const _0x5c0ffb={'event':_0xdba442,'payment':{'id':_0x137e4c['id'],'order_id':_0x137e4c[_0x2a74cf(0xbf)],'gateway_order_id':_0x137e4c[_0x2a74cf(0xd0)],'gateway':'0000','amount':_0x137e4c[_0x2a74cf(0xea)],'currency':_0x137e4c['currency'],'status':_0x5013c8['toLowerCase'](),'customer_email':_0x137e4c[_0x2a74cf(0xa6)],'customer_name':_0x137e4c[_0x2a74cf(0x77)],'transaction_id':_0x2558de,'failure_message':_0x454f66,'created_at':_0x137e4c[_0x2a74cf(0x97)],'updated_at':new Date()}},_0x14bb09=await fetch(_0x5623ce[_0x2a74cf(0x7e)],{'method':_0x2a74cf(0xbe),'headers':{'Content-Type':'application/json','User-Agent':_0x2a74cf(0x94)},'body':JSON[_0x2a74cf(0xaa)](_0x5c0ffb)}),_0x3e23c4=Date[_0x2a74cf(0xb1)]()-_0xc86a89;console['log']('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x5623ce[_0x2a74cf(0x7e)]+_0x2a74cf(0xb9)+_0x14bb09[_0x2a74cf(0xe5)]+'\x20('+_0x3e23c4+_0x2a74cf(0xbb));}catch(_0x54406a){console[_0x2a74cf(0xd8)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x54406a);}}async[a15_0x1db78(0xa4)](_0x570f82,_0x414970){const _0x519e97=a15_0x1db78;try{const {telegramBotService:_0x432be9}=await Promise[_0x519e97(0xd1)]()[_0x519e97(0xeb)](()=>__importStar(require('../services/telegramBotService'))),_0x422b6d={'PAID':'paid','FAILED':_0x519e97(0x82)},_0x2bb54a=_0x422b6d[_0x414970];if(!_0x2bb54a)return;await _0x432be9['sendPaymentNotification'](_0x570f82[_0x519e97(0xc2)],_0x570f82,_0x2bb54a);}catch(_0x398af7){console[_0x519e97(0xd8)](_0x519e97(0xac),_0x398af7);}}}exports['TestGatewayController']=TestGatewayController;