'use strict';function a13_0x4a52(_0x37ea2d,_0xe3bb41){const _0xc2151c=a13_0xc215();return a13_0x4a52=function(_0x4a5209,_0x19b332){_0x4a5209=_0x4a5209-0x1e2;let _0x33f1bc=_0xc2151c[_0x4a5209];return _0x33f1bc;},a13_0x4a52(_0x37ea2d,_0xe3bb41);}const a13_0x11357e=a13_0x4a52;(function(_0xa20555,_0x3ac3e6){const _0x2f7da3=a13_0x4a52,_0x183cb1=_0xa20555();while(!![]){try{const _0x44176a=parseInt(_0x2f7da3(0x230))/0x1+-parseInt(_0x2f7da3(0x20c))/0x2+parseInt(_0x2f7da3(0x202))/0x3*(-parseInt(_0x2f7da3(0x1e2))/0x4)+parseInt(_0x2f7da3(0x224))/0x5+parseInt(_0x2f7da3(0x219))/0x6+-parseInt(_0x2f7da3(0x1ea))/0x7*(parseInt(_0x2f7da3(0x203))/0x8)+parseInt(_0x2f7da3(0x24f))/0x9*(parseInt(_0x2f7da3(0x231))/0xa);if(_0x44176a===_0x3ac3e6)break;else _0x183cb1['push'](_0x183cb1['shift']());}catch(_0x2fb436){_0x183cb1['push'](_0x183cb1['shift']());}}}(a13_0xc215,0xc53bc));var __createBinding=this&&this[a13_0x11357e(0x243)]||(Object['create']?function(_0x61bad4,_0x2fd9e0,_0x9995f0,_0x54b18d){const _0x13b0d2=a13_0x11357e;if(_0x54b18d===undefined)_0x54b18d=_0x9995f0;var _0x1d5f3b=Object['getOwnPropertyDescriptor'](_0x2fd9e0,_0x9995f0);(!_0x1d5f3b||('get'in _0x1d5f3b?!_0x2fd9e0['__esModule']:_0x1d5f3b[_0x13b0d2(0x21d)]||_0x1d5f3b[_0x13b0d2(0x225)]))&&(_0x1d5f3b={'enumerable':!![],'get':function(){return _0x2fd9e0[_0x9995f0];}}),Object[_0x13b0d2(0x1f2)](_0x61bad4,_0x54b18d,_0x1d5f3b);}:function(_0x2c3269,_0x258af9,_0x1bfb70,_0x3e0165){if(_0x3e0165===undefined)_0x3e0165=_0x1bfb70;_0x2c3269[_0x3e0165]=_0x258af9[_0x1bfb70];}),__setModuleDefault=this&&this[a13_0x11357e(0x245)]||(Object[a13_0x11357e(0x200)]?function(_0x3b552d,_0x57e225){const _0x1bc497=a13_0x11357e;Object[_0x1bc497(0x1f2)](_0x3b552d,_0x1bc497(0x223),{'enumerable':!![],'value':_0x57e225});}:function(_0x16817d,_0x289fb6){const _0x2846ac=a13_0x11357e;_0x16817d[_0x2846ac(0x223)]=_0x289fb6;}),__importStar=this&&this['__importStar']||(function(){var _0xf08026=function(_0x4539f6){const _0x164de9=a13_0x4a52;return _0xf08026=Object[_0x164de9(0x240)]||function(_0x2f4bef){const _0xa2bc1d=_0x164de9;var _0xf8d2e2=[];for(var _0x56da19 in _0x2f4bef)if(Object[_0xa2bc1d(0x23d)][_0xa2bc1d(0x216)][_0xa2bc1d(0x236)](_0x2f4bef,_0x56da19))_0xf8d2e2[_0xf8d2e2[_0xa2bc1d(0x208)]]=_0x56da19;return _0xf8d2e2;},_0xf08026(_0x4539f6);};return function(_0x2fe8ef){const _0x5f1547=a13_0x4a52;if(_0x2fe8ef&&_0x2fe8ef[_0x5f1547(0x228)])return _0x2fe8ef;var _0x2c6b1c={};if(_0x2fe8ef!=null){for(var _0x288980=_0xf08026(_0x2fe8ef),_0x173f0b=0x0;_0x173f0b<_0x288980[_0x5f1547(0x208)];_0x173f0b++)if(_0x288980[_0x173f0b]!==_0x5f1547(0x223))__createBinding(_0x2c6b1c,_0x2fe8ef,_0x288980[_0x173f0b]);}return __setModuleDefault(_0x2c6b1c,_0x2fe8ef),_0x2c6b1c;};}()),__importDefault=this&&this['__importDefault']||function(_0x39c9af){const _0x3da12f=a13_0x11357e;return _0x39c9af&&_0x39c9af[_0x3da12f(0x228)]?_0x39c9af:{'default':_0x39c9af};};Object['defineProperty'](exports,a13_0x11357e(0x228),{'value':!![]}),exports[a13_0x11357e(0x20a)]=void 0x0;function a13_0xc215(){const _0x42c538=['paymentMethod','FAILED','default','3134920fvnCYg','configurable','Test\x20Gateway\x20webhook\x20sent\x20to\x20','sendPaymentNotification','__esModule','processCardPayment','findUnique','webhookUrl','cardNumber','webhookLog','error','../services/gateways/testGatewayService','855337LewiHW','10ufjIUp','name','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','paid','shopId','call','createdAt','PENDING','status','test_gateway_','parse','\x20processed:\x20','prototype','replace','Any\x20name','getOwnPropertyNames','processCard','webhookService','__createBinding','test_gateway','__setModuleDefault','failureMessage','settings','currency','customerName','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','body','\x20with\x20status\x20','amount','gateway','30280923hNiBHB','3195788ZpsSDT','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','0000','payment.failed','ms)','orderId','Payment\x20not\x20found','Error\x20parsing\x20webhook\x20events:','3633yGKrBD','stringify','webhookEvents','4242\x204242\x204242\x204242','../config/database','payment','params','json','defineProperty','Webhook\x20event\x20','Payment\x20to\x20','failed','sendShopWebhook','../services/webhookService','cardLast4','Any\x20other\x20card\x20number','customerEmail','shop','Payment\x20failed','failureReason','toISOString','toLowerCase','create','Payment\x20processed\x20successfully','6Bobeid','21688lPgAZi','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','PAID','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','length','transactionId','TestGatewayController',',\x20cannot\x20process','3021382cFplqn','\x20not\x20enabled\x20for\x20shop\x20','âœ…\x20Test\x20Gateway\x20payment\x20','sendPaymentStatusNotification','resolve','failUrl','Payment\x20is\x20not\x20for\x20test\x20gateway','payment.success','slice','successUrl','hasOwnProperty','includes','then','2859564ZodZhY','../services/telegramBotService','ðŸ§ª\x20Test\x20Gateway\x20result:','testGatewayService','writable','gatewayOrderId','POST','now'];a13_0xc215=function(){return _0x42c538;};return a13_0xc215();}const testGatewayService_1=require(a13_0x11357e(0x22f)),webhookService_1=require(a13_0x11357e(0x1f7)),database_1=__importDefault(require(a13_0x11357e(0x1ee)));class TestGatewayController{constructor(){const _0x5dad2f=a13_0x11357e;this['getPaymentForm']=async(_0xee790b,_0x300cd2,_0x5089a6)=>{const _0x4933b8=a13_0x4a52;try{const {paymentId:_0xed020e}=_0xee790b['params'];console['log'](_0x4933b8(0x24a)+_0xed020e);const _0x1ffa21=await database_1[_0x4933b8(0x223)]['payment']['findUnique']({'where':{'id':_0xed020e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x1ffa21)return _0x300cd2[_0x4933b8(0x239)](0x194)[_0x4933b8(0x1f1)]({'success':![],'message':_0x4933b8(0x1e8)});if(_0x1ffa21[_0x4933b8(0x24e)]!==_0x4933b8(0x244))return _0x300cd2['status'](0x190)[_0x4933b8(0x1f1)]({'success':![],'message':_0x4933b8(0x212)});if(_0x1ffa21[_0x4933b8(0x239)]!==_0x4933b8(0x238))return _0x300cd2['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1ffa21[_0x4933b8(0x239)]+_0x4933b8(0x20b)});_0x300cd2[_0x4933b8(0x1f1)]({'success':!![],'result':{'paymentId':_0x1ffa21['id'],'orderId':_0x1ffa21[_0x4933b8(0x21e)],'amount':_0x1ffa21[_0x4933b8(0x24d)],'currency':_0x1ffa21[_0x4933b8(0x248)],'merchantName':_0x1ffa21[_0x4933b8(0x1fb)]['name'],'description':_0x4933b8(0x1f4)+_0x1ffa21[_0x4933b8(0x1fb)][_0x4933b8(0x232)],'testInstructions':{'successCard':_0x4933b8(0x1ed),'failureCard':_0x4933b8(0x1f9),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':'Any\x203-4\x20digits','holderName':_0x4933b8(0x23f)}}});}catch(_0x3a73da){_0x5089a6(_0x3a73da);}},this[_0x5dad2f(0x241)]=async(_0xc5c213,_0x491739,_0x361c1c)=>{const _0x42486d=_0x5dad2f;try{const {paymentId:_0x48efe5}=_0xc5c213[_0x42486d(0x1f0)],_0x3ff7a6=_0xc5c213[_0x42486d(0x24b)];console[_0x42486d(0x207)](_0x42486d(0x233)+_0x48efe5);const _0x5d2506=await database_1['default'][_0x42486d(0x1ef)][_0x42486d(0x22a)]({'where':{'id':_0x48efe5},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5d2506)return _0x491739[_0x42486d(0x239)](0x194)[_0x42486d(0x1f1)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5d2506[_0x42486d(0x24e)]!==_0x42486d(0x244))return _0x491739[_0x42486d(0x239)](0x190)[_0x42486d(0x1f1)]({'success':![],'message':_0x42486d(0x212)});if(_0x5d2506[_0x42486d(0x239)]!==_0x42486d(0x238))return _0x491739[_0x42486d(0x239)](0x190)[_0x42486d(0x1f1)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5d2506[_0x42486d(0x239)]+_0x42486d(0x20b)});const _0x495134=await this[_0x42486d(0x21c)][_0x42486d(0x229)]({'paymentId':_0x5d2506['id'],'orderId':_0x5d2506['gatewayOrderId']||_0x5d2506['id'],'amount':_0x5d2506[_0x42486d(0x24d)],'currency':_0x5d2506['currency'],'cardData':_0x3ff7a6});console[_0x42486d(0x207)](_0x42486d(0x21b),_0x495134);const _0x2d9017={'status':_0x495134[_0x42486d(0x239)],'updatedAt':new Date()};if(_0x495134['status']===_0x42486d(0x205))_0x2d9017['paidAt']=new Date(),_0x2d9017['gatewayPaymentId']=_0x495134['transactionId'];else _0x495134[_0x42486d(0x239)]===_0x42486d(0x222)&&(_0x2d9017[_0x42486d(0x246)]=_0x495134[_0x42486d(0x1fd)]);const _0x167ff4=_0x3ff7a6[_0x42486d(0x22c)][_0x42486d(0x23e)](/[\s-]/g,'');_0x2d9017[_0x42486d(0x1f8)]=_0x167ff4[_0x42486d(0x214)](-0x4),_0x2d9017[_0x42486d(0x221)]='test_card',await database_1[_0x42486d(0x223)][_0x42486d(0x1ef)]['update']({'where':{'id':_0x5d2506['id']},'data':_0x2d9017}),await database_1[_0x42486d(0x223)][_0x42486d(0x22d)]['create']({'data':{'paymentId':_0x5d2506['id'],'shopId':_0x5d2506[_0x42486d(0x235)],'event':_0x42486d(0x23a)+_0x495134[_0x42486d(0x239)][_0x42486d(0x1ff)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x42486d(0x238),'newStatus':_0x495134[_0x42486d(0x239)],'transactionId':_0x495134[_0x42486d(0x209)],'failureReason':_0x495134[_0x42486d(0x1fd)],'processedAt':new Date()[_0x42486d(0x1fe)]()})}}),await this[_0x42486d(0x1f6)](_0x5d2506,_0x495134[_0x42486d(0x239)],_0x495134[_0x42486d(0x209)],_0x495134[_0x42486d(0x1fd)]),await this[_0x42486d(0x20f)](_0x5d2506,_0x495134[_0x42486d(0x239)]),console[_0x42486d(0x207)](_0x42486d(0x20e)+_0x48efe5+_0x42486d(0x23c)+_0x495134['status']),_0x495134['status']===_0x42486d(0x205)?_0x491739[_0x42486d(0x1f1)]({'success':!![],'message':_0x42486d(0x201),'result':{'status':_0x42486d(0x205),'transactionId':_0x495134[_0x42486d(0x209)],'redirectUrl':_0x5d2506[_0x42486d(0x215)]}}):_0x491739[_0x42486d(0x239)](0x190)['json']({'success':![],'message':_0x42486d(0x1fc),'result':{'status':_0x42486d(0x222),'failureReason':_0x495134[_0x42486d(0x1fd)],'redirectUrl':_0x5d2506[_0x42486d(0x211)]}});}catch(_0x16b23d){_0x361c1c(_0x16b23d);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x5dad2f(0x242)]=new webhookService_1['WebhookService']();}async[a13_0x11357e(0x1f6)](_0x45c8e1,_0x42b562,_0x26db76,_0x999924){const _0x3b5b95=a13_0x11357e,_0x42b6f2=Date[_0x3b5b95(0x220)]();try{const _0x1afaaf=_0x45c8e1['shop'],_0x1c9ee2=_0x1afaaf[_0x3b5b95(0x247)];if(!_0x1c9ee2?.[_0x3b5b95(0x22b)]){console[_0x3b5b95(0x207)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1afaaf['id']);return;}const _0x22bfe3=_0x42b562===_0x3b5b95(0x205)?_0x3b5b95(0x213):_0x3b5b95(0x1e5);let _0x26c64e=[];if(_0x1c9ee2[_0x3b5b95(0x1ec)])try{_0x26c64e=Array['isArray'](_0x1c9ee2['webhookEvents'])?_0x1c9ee2[_0x3b5b95(0x1ec)]:JSON[_0x3b5b95(0x23b)](_0x1c9ee2[_0x3b5b95(0x1ec)]);}catch(_0x414820){console['error'](_0x3b5b95(0x1e9),_0x414820),_0x26c64e=[];}if(!_0x26c64e[_0x3b5b95(0x217)](_0x22bfe3)){console[_0x3b5b95(0x207)](_0x3b5b95(0x1f3)+_0x22bfe3+_0x3b5b95(0x20d)+_0x1afaaf['id']);return;}const _0x12da1b={'event':_0x22bfe3,'payment':{'id':_0x45c8e1['id'],'order_id':_0x45c8e1[_0x3b5b95(0x1e7)],'gateway_order_id':_0x45c8e1[_0x3b5b95(0x21e)],'gateway':_0x3b5b95(0x1e4),'amount':_0x45c8e1['amount'],'currency':_0x45c8e1[_0x3b5b95(0x248)],'status':_0x42b562['toLowerCase'](),'customer_email':_0x45c8e1[_0x3b5b95(0x1fa)],'customer_name':_0x45c8e1[_0x3b5b95(0x249)],'transaction_id':_0x26db76,'failure_message':_0x999924,'created_at':_0x45c8e1[_0x3b5b95(0x237)],'updated_at':new Date()}},_0x524c03=await fetch(_0x1c9ee2[_0x3b5b95(0x22b)],{'method':_0x3b5b95(0x21f),'headers':{'Content-Type':'application/json','User-Agent':_0x3b5b95(0x204)},'body':JSON[_0x3b5b95(0x1eb)](_0x12da1b)}),_0x518cef=Date['now']()-_0x42b6f2;console['log'](_0x3b5b95(0x226)+_0x1c9ee2[_0x3b5b95(0x22b)]+_0x3b5b95(0x24c)+_0x524c03[_0x3b5b95(0x239)]+'\x20('+_0x518cef+_0x3b5b95(0x1e6));}catch(_0x2bda0a){console[_0x3b5b95(0x22e)](_0x3b5b95(0x1e3),_0x2bda0a);}}async[a13_0x11357e(0x20f)](_0x213a2a,_0x1cf478){const _0x1dc6a7=a13_0x11357e;try{const {telegramBotService:_0x28af20}=await Promise[_0x1dc6a7(0x210)]()[_0x1dc6a7(0x218)](()=>__importStar(require(_0x1dc6a7(0x21a)))),_0x4801bf={'PAID':_0x1dc6a7(0x234),'FAILED':_0x1dc6a7(0x1f5)},_0x20d974=_0x4801bf[_0x1cf478];if(!_0x20d974)return;await _0x28af20[_0x1dc6a7(0x227)](_0x213a2a[_0x1dc6a7(0x235)],_0x213a2a,_0x20d974);}catch(_0x4a6190){console[_0x1dc6a7(0x22e)](_0x1dc6a7(0x206),_0x4a6190);}}}exports[a13_0x11357e(0x20a)]=TestGatewayController;