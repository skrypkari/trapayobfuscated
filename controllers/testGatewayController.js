'use strict';function a13_0x43eb(){const _0x1ef0c8=['üìà\x20Test\x20Gateway:\x20Payment\x20','webhookLog','defineProperty','get','test_gateway','orderId','resolve','$transaction','amount','SINGLE','shop','TestGatewayController','paymentLink','286778oDMXtG','failUrl','Any\x20future\x20date\x20(MM/YY)','19280952UtUQgy','log','Any\x20other\x20card\x20number','WebhookService','findUnique','Payment\x20processed\x20successfully','sendPaymentStatusNotification','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','__importStar','\x20not\x20found','parse','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','isArray','settings','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getOwnPropertyNames','create','sendShopWebhook','20IceSwK','\x20not\x20enabled\x20for\x20shop\x20','currency','__esModule','Payment\x20to\x20','paidAt','stringify','currentPayments','cardNumber','9712176ROengB','status','../services/gateways/testGatewayService','Payment\x20status\x20is\x20','now','\x20updated:\x20currentPayments=','application/json','replace','test_gateway_','3272928MRmUQV',',\x20status=','1022214UYCMVL','includes','default','webhookEvents','length','2282736zZyqGE','prototype',':\x20type=','../services/telegramBotService','gateway','transactionId','FAILED','Any\x203-4\x20digits','createdAt','customerEmail','\x20->\x20','failureMessage','Any\x20name','Test\x20Gateway\x20webhook\x20sent\x20to\x20','1VaSuBs','paymentLinkId','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)',',\x20cannot\x20process','getOwnPropertyDescriptor','PAID','webhookUrl','failureReason','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','COMPLETED','toLowerCase','__createBinding','Payment\x20failed','processCardPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','6852860BXzMZS','PENDING','call','TestGatewayService','update','name','gatewayOrderId','payment.failed','shopId','sendPaymentNotification','payment','body','successUrl','failed','paymentMethod','configurable','json','testGatewayService','webhookService','payment.success','type','slice','ms)','Payment\x20is\x20not\x20for\x20test\x20gateway','getPaymentForm','\x20with\x20status\x20','4242\x204242\x204242\x204242','writable','params','error','Payment\x20not\x20found','processCard'];a13_0x43eb=function(){return _0x1ef0c8;};return a13_0x43eb();}function a13_0xc0ad(_0x16b6a7,_0x2ce6a9){const _0x43eb52=a13_0x43eb();return a13_0xc0ad=function(_0xc0ad9f,_0x160c94){_0xc0ad9f=_0xc0ad9f-0x112;let _0x3804b1=_0x43eb52[_0xc0ad9f];return _0x3804b1;},a13_0xc0ad(_0x16b6a7,_0x2ce6a9);}const a13_0x1f20e1=a13_0xc0ad;(function(_0x58cce4,_0x4bb5fa){const _0xb1b625=a13_0xc0ad,_0x419d1c=_0x58cce4();while(!![]){try{const _0x54a7e3=parseInt(_0xb1b625(0x161))/0x1*(-parseInt(_0xb1b625(0x125))/0x2)+parseInt(_0xb1b625(0x153))/0x3+parseInt(_0xb1b625(0x14c))/0x4+-parseInt(_0xb1b625(0x13a))/0x5*(parseInt(_0xb1b625(0x14e))/0x6)+parseInt(_0xb1b625(0x170))/0x7+parseInt(_0xb1b625(0x143))/0x8+-parseInt(_0xb1b625(0x128))/0x9;if(_0x54a7e3===_0x4bb5fa)break;else _0x419d1c['push'](_0x419d1c['shift']());}catch(_0x14a122){_0x419d1c['push'](_0x419d1c['shift']());}}}(a13_0x43eb,0xc4859));var __createBinding=this&&this[a13_0x1f20e1(0x16c)]||(Object[a13_0x1f20e1(0x138)]?function(_0x36f6b1,_0x2843b0,_0x52f2dd,_0x15c0ca){const _0x4befc3=a13_0x1f20e1;if(_0x15c0ca===undefined)_0x15c0ca=_0x52f2dd;var _0x3bd35d=Object[_0x4befc3(0x165)](_0x2843b0,_0x52f2dd);(!_0x3bd35d||(_0x4befc3(0x11b)in _0x3bd35d?!_0x2843b0['__esModule']:_0x3bd35d[_0x4befc3(0x113)]||_0x3bd35d[_0x4befc3(0x17f)]))&&(_0x3bd35d={'enumerable':!![],'get':function(){return _0x2843b0[_0x52f2dd];}}),Object[_0x4befc3(0x11a)](_0x36f6b1,_0x15c0ca,_0x3bd35d);}:function(_0x28855f,_0xb28979,_0x252fcd,_0x3d203a){if(_0x3d203a===undefined)_0x3d203a=_0x252fcd;_0x28855f[_0x3d203a]=_0xb28979[_0x252fcd];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a13_0x1f20e1(0x138)]?function(_0x5b933e,_0x474691){const _0x5c893e=a13_0x1f20e1;Object[_0x5c893e(0x11a)](_0x5b933e,_0x5c893e(0x150),{'enumerable':!![],'value':_0x474691});}:function(_0x183b5a,_0x23172f){const _0x530578=a13_0x1f20e1;_0x183b5a[_0x530578(0x150)]=_0x23172f;}),__importStar=this&&this[a13_0x1f20e1(0x130)]||(function(){var _0x2021a4=function(_0x2d3695){const _0x1c9c7e=a13_0xc0ad;return _0x2021a4=Object[_0x1c9c7e(0x137)]||function(_0x330a79){const _0x3ef765=_0x1c9c7e;var _0x3dcefb=[];for(var _0x539e40 in _0x330a79)if(Object[_0x3ef765(0x154)]['hasOwnProperty'][_0x3ef765(0x172)](_0x330a79,_0x539e40))_0x3dcefb[_0x3dcefb[_0x3ef765(0x152)]]=_0x539e40;return _0x3dcefb;},_0x2021a4(_0x2d3695);};return function(_0x51033f){const _0x42bc62=a13_0xc0ad;if(_0x51033f&&_0x51033f[_0x42bc62(0x13d)])return _0x51033f;var _0x26a30c={};if(_0x51033f!=null){for(var _0x3891a4=_0x2021a4(_0x51033f),_0xae11ba=0x0;_0xae11ba<_0x3891a4['length'];_0xae11ba++)if(_0x3891a4[_0xae11ba]!=='default')__createBinding(_0x26a30c,_0x51033f,_0x3891a4[_0xae11ba]);}return __setModuleDefault(_0x26a30c,_0x51033f),_0x26a30c;};}()),__importDefault=this&&this['__importDefault']||function(_0x58cd9b){const _0x5bf4a5=a13_0x1f20e1;return _0x58cd9b&&_0x58cd9b[_0x5bf4a5(0x13d)]?_0x58cd9b:{'default':_0x58cd9b};};Object[a13_0x1f20e1(0x11a)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x1f20e1(0x145)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x1bdc31=a13_0x1f20e1;this[_0x1bdc31(0x188)]=async(_0x2dde6d,_0x4aa6db,_0x3cd990)=>{const _0x56fa1f=_0x1bdc31;try{const {paymentId:_0x33cebb}=_0x2dde6d[_0x56fa1f(0x114)];console['log'](_0x56fa1f(0x133)+_0x33cebb);const _0x10fafa=await database_1[_0x56fa1f(0x150)]['payment']['findUnique']({'where':{'id':_0x33cebb},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x10fafa)return _0x4aa6db[_0x56fa1f(0x144)](0x194)[_0x56fa1f(0x180)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x10fafa[_0x56fa1f(0x157)]!==_0x56fa1f(0x11c))return _0x4aa6db[_0x56fa1f(0x144)](0x190)[_0x56fa1f(0x180)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x10fafa[_0x56fa1f(0x144)]!==_0x56fa1f(0x171))return _0x4aa6db[_0x56fa1f(0x144)](0x190)[_0x56fa1f(0x180)]({'success':![],'message':_0x56fa1f(0x146)+_0x10fafa[_0x56fa1f(0x144)]+',\x20cannot\x20process'});_0x4aa6db[_0x56fa1f(0x180)]({'success':!![],'result':{'paymentId':_0x10fafa['id'],'orderId':_0x10fafa[_0x56fa1f(0x176)],'amount':_0x10fafa[_0x56fa1f(0x120)],'currency':_0x10fafa[_0x56fa1f(0x13c)],'merchantName':_0x10fafa[_0x56fa1f(0x122)][_0x56fa1f(0x175)],'description':_0x56fa1f(0x13e)+_0x10fafa[_0x56fa1f(0x122)][_0x56fa1f(0x175)],'testInstructions':{'successCard':_0x56fa1f(0x112),'failureCard':_0x56fa1f(0x12a),'expiryDate':_0x56fa1f(0x127),'cvc':_0x56fa1f(0x15a),'holderName':_0x56fa1f(0x15f)}}});}catch(_0x201d3f){_0x3cd990(_0x201d3f);}},this[_0x1bdc31(0x117)]=async(_0x3bbc7b,_0x261afe,_0x190904)=>{const _0xe32706=_0x1bdc31;try{const {paymentId:_0x142171}=_0x3bbc7b['params'],_0x3f8da1=_0x3bbc7b[_0xe32706(0x17b)];console[_0xe32706(0x129)]('üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x142171);const _0x1eca5f=await database_1[_0xe32706(0x150)][_0xe32706(0x17a)][_0xe32706(0x12c)]({'where':{'id':_0x142171},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1eca5f)return _0x261afe['status'](0x194)[_0xe32706(0x180)]({'success':![],'message':_0xe32706(0x116)});if(_0x1eca5f[_0xe32706(0x157)]!==_0xe32706(0x11c))return _0x261afe['status'](0x190)[_0xe32706(0x180)]({'success':![],'message':_0xe32706(0x187)});if(_0x1eca5f['status']!=='PENDING')return _0x261afe[_0xe32706(0x144)](0x190)[_0xe32706(0x180)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1eca5f[_0xe32706(0x144)]+_0xe32706(0x164)});const _0x3bb4a4=await this['testGatewayService'][_0xe32706(0x16e)]({'paymentId':_0x1eca5f['id'],'orderId':_0x1eca5f[_0xe32706(0x176)]||_0x1eca5f['id'],'amount':_0x1eca5f[_0xe32706(0x120)],'currency':_0x1eca5f[_0xe32706(0x13c)],'cardData':_0x3f8da1});console[_0xe32706(0x129)]('üß™\x20Test\x20Gateway\x20result:',_0x3bb4a4);const _0x2f9658={'status':_0x3bb4a4[_0xe32706(0x144)],'updatedAt':new Date()};if(_0x3bb4a4[_0xe32706(0x144)]==='PAID')_0x2f9658[_0xe32706(0x13f)]=new Date(),_0x2f9658['gatewayPaymentId']=_0x3bb4a4['transactionId'];else _0x3bb4a4[_0xe32706(0x144)]===_0xe32706(0x159)&&(_0x2f9658[_0xe32706(0x15e)]=_0x3bb4a4['failureReason']);const _0x1a0ce5=_0x3f8da1[_0xe32706(0x142)][_0xe32706(0x14a)](/[\s-]/g,'');_0x2f9658['cardLast4']=_0x1a0ce5[_0xe32706(0x185)](-0x4),_0x2f9658[_0xe32706(0x17e)]='test_card',await database_1[_0xe32706(0x150)][_0xe32706(0x17a)][_0xe32706(0x174)]({'where':{'id':_0x1eca5f['id']},'data':_0x2f9658});if(_0x3bb4a4['status']==='PAID'&&_0x1eca5f[_0xe32706(0x162)]){console['log'](_0xe32706(0x118)+_0x1eca5f['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1[_0xe32706(0x150)][_0xe32706(0x11f)](async _0x15f223=>{const _0x45f752=_0xe32706,_0x4c30d8=await _0x15f223[_0x45f752(0x124)]['findUnique']({'where':{'id':_0x1eca5f['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4c30d8){console[_0x45f752(0x129)]('üìà\x20Found\x20payment\x20link\x20'+_0x4c30d8['id']+_0x45f752(0x155)+_0x4c30d8[_0x45f752(0x184)]+',\x20currentPayments='+_0x4c30d8[_0x45f752(0x141)]+',\x20status='+_0x4c30d8[_0x45f752(0x144)]);const _0x1caba3=_0x4c30d8[_0x45f752(0x141)]+0x1,_0x68600a=_0x4c30d8[_0x45f752(0x184)]===_0x45f752(0x121)?_0x45f752(0x16a):_0x4c30d8['status'];await _0x15f223[_0x45f752(0x124)][_0x45f752(0x174)]({'where':{'id':_0x1eca5f[_0x45f752(0x162)]},'data':{'currentPayments':_0x1caba3,'status':_0x68600a,'updatedAt':new Date()}}),console['log']('‚úÖ\x20Payment\x20link\x20'+_0x4c30d8['id']+_0x45f752(0x148)+_0x4c30d8['currentPayments']+_0x45f752(0x15d)+_0x1caba3+_0x45f752(0x14d)+_0x4c30d8[_0x45f752(0x144)]+_0x45f752(0x15d)+_0x68600a);}else console[_0x45f752(0x129)]('‚ùå\x20Payment\x20link\x20'+_0x1eca5f['paymentLinkId']+_0x45f752(0x131));});}catch(_0x144639){console[_0xe32706(0x115)](_0xe32706(0x169),_0x144639);}}await database_1[_0xe32706(0x150)][_0xe32706(0x119)][_0xe32706(0x138)]({'data':{'paymentId':_0x1eca5f['id'],'shopId':_0x1eca5f['shopId'],'event':_0xe32706(0x14b)+_0x3bb4a4[_0xe32706(0x144)][_0xe32706(0x16b)](),'statusCode':0xc8,'responseBody':JSON[_0xe32706(0x140)]({'oldStatus':'PENDING','newStatus':_0x3bb4a4[_0xe32706(0x144)],'transactionId':_0x3bb4a4[_0xe32706(0x158)],'failureReason':_0x3bb4a4[_0xe32706(0x168)],'processedAt':new Date()['toISOString']()})}}),await this[_0xe32706(0x139)](_0x1eca5f,_0x3bb4a4[_0xe32706(0x144)],_0x3bb4a4[_0xe32706(0x158)],_0x3bb4a4[_0xe32706(0x168)]),await this['sendPaymentStatusNotification'](_0x1eca5f,_0x3bb4a4[_0xe32706(0x144)]),console[_0xe32706(0x129)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x142171+'\x20processed:\x20'+_0x3bb4a4[_0xe32706(0x144)]),_0x3bb4a4['status']===_0xe32706(0x166)?_0x261afe[_0xe32706(0x180)]({'success':!![],'message':_0xe32706(0x12d),'result':{'status':_0xe32706(0x166),'transactionId':_0x3bb4a4[_0xe32706(0x158)],'redirectUrl':_0x1eca5f[_0xe32706(0x17c)]}}):_0x261afe[_0xe32706(0x144)](0x190)[_0xe32706(0x180)]({'success':![],'message':_0xe32706(0x16d),'result':{'status':_0xe32706(0x159),'failureReason':_0x3bb4a4['failureReason'],'redirectUrl':_0x1eca5f[_0xe32706(0x126)]}});}catch(_0x5504eb){_0x190904(_0x5504eb);}},this[_0x1bdc31(0x181)]=new testGatewayService_1[(_0x1bdc31(0x173))](),this[_0x1bdc31(0x182)]=new webhookService_1[(_0x1bdc31(0x12b))]();}async[a13_0x1f20e1(0x139)](_0x3f18b4,_0x46608a,_0x304c36,_0x43acce){const _0x118971=a13_0x1f20e1,_0x1fe28f=Date[_0x118971(0x147)]();try{const _0x2aa5ae=_0x3f18b4[_0x118971(0x122)],_0x379dd2=_0x2aa5ae[_0x118971(0x135)];if(!_0x379dd2?.[_0x118971(0x167)]){console[_0x118971(0x129)](_0x118971(0x16f)+_0x2aa5ae['id']);return;}const _0x5afe50=_0x46608a===_0x118971(0x166)?_0x118971(0x183):_0x118971(0x177);let _0x5db320=[];if(_0x379dd2[_0x118971(0x151)])try{_0x5db320=Array[_0x118971(0x134)](_0x379dd2['webhookEvents'])?_0x379dd2[_0x118971(0x151)]:JSON[_0x118971(0x132)](_0x379dd2['webhookEvents']);}catch(_0x57bce1){console[_0x118971(0x115)]('Error\x20parsing\x20webhook\x20events:',_0x57bce1),_0x5db320=[];}if(!_0x5db320[_0x118971(0x14f)](_0x5afe50)){console[_0x118971(0x129)]('Webhook\x20event\x20'+_0x5afe50+_0x118971(0x13b)+_0x2aa5ae['id']);return;}const _0x434bbc={'event':_0x5afe50,'payment':{'id':_0x3f18b4['id'],'order_id':_0x3f18b4[_0x118971(0x11d)],'gateway_order_id':_0x3f18b4['gatewayOrderId'],'gateway':'0000','amount':_0x3f18b4['amount'],'currency':_0x3f18b4[_0x118971(0x13c)],'status':_0x46608a[_0x118971(0x16b)](),'customer_email':_0x3f18b4[_0x118971(0x15c)],'customer_name':_0x3f18b4['customerName'],'transaction_id':_0x304c36,'failure_message':_0x43acce,'created_at':_0x3f18b4[_0x118971(0x15b)],'updated_at':new Date()}},_0x2de6c3=await fetch(_0x379dd2[_0x118971(0x167)],{'method':'POST','headers':{'Content-Type':_0x118971(0x149),'User-Agent':_0x118971(0x163)},'body':JSON['stringify'](_0x434bbc)}),_0x9fee22=Date[_0x118971(0x147)]()-_0x1fe28f;console['log'](_0x118971(0x160)+_0x379dd2[_0x118971(0x167)]+_0x118971(0x189)+_0x2de6c3[_0x118971(0x144)]+'\x20('+_0x9fee22+_0x118971(0x186));}catch(_0x214680){console[_0x118971(0x115)](_0x118971(0x12f),_0x214680);}}async[a13_0x1f20e1(0x12e)](_0x2ecc1a,_0x469350){const _0x26ddb5=a13_0x1f20e1;try{const {telegramBotService:_0x435999}=await Promise[_0x26ddb5(0x11e)]()['then'](()=>__importStar(require(_0x26ddb5(0x156)))),_0x315efb={'PAID':'paid','FAILED':_0x26ddb5(0x17d)},_0x41aedc=_0x315efb[_0x469350];if(!_0x41aedc)return;await _0x435999[_0x26ddb5(0x179)](_0x2ecc1a[_0x26ddb5(0x178)],_0x2ecc1a,_0x41aedc);}catch(_0x22375d){console[_0x26ddb5(0x115)](_0x26ddb5(0x136),_0x22375d);}}}exports[a13_0x1f20e1(0x123)]=TestGatewayController;