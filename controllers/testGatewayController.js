'use strict';const a14_0x534f7d=a14_0x49cf;(function(_0x493972,_0x201264){const _0xf4c13d=a14_0x49cf,_0x1c4de1=_0x493972();while(!![]){try{const _0x4eb5ae=-parseInt(_0xf4c13d(0x141))/0x1+-parseInt(_0xf4c13d(0x125))/0x2*(-parseInt(_0xf4c13d(0x101))/0x3)+-parseInt(_0xf4c13d(0x153))/0x4+parseInt(_0xf4c13d(0x111))/0x5*(-parseInt(_0xf4c13d(0x121))/0x6)+-parseInt(_0xf4c13d(0x143))/0x7*(-parseInt(_0xf4c13d(0xf9))/0x8)+-parseInt(_0xf4c13d(0x10a))/0x9+-parseInt(_0xf4c13d(0x16f))/0xa*(-parseInt(_0xf4c13d(0x128))/0xb);if(_0x4eb5ae===_0x201264)break;else _0x1c4de1['push'](_0x1c4de1['shift']());}catch(_0x5b2dbb){_0x1c4de1['push'](_0x1c4de1['shift']());}}}(a14_0x36e0,0x6085c));function a14_0x49cf(_0x3c4bbf,_0x5e80a5){const _0x36e02c=a14_0x36e0();return a14_0x49cf=function(_0x49cf9b,_0x976561){_0x49cf9b=_0x49cf9b-0xf6;let _0xa030ae=_0x36e02c[_0x49cf9b];return _0xa030ae;},a14_0x49cf(_0x3c4bbf,_0x5e80a5);}var __createBinding=this&&this[a14_0x534f7d(0xfb)]||(Object[a14_0x534f7d(0x165)]?function(_0x144794,_0x2e9e19,_0x210174,_0x31875a){const _0xc31333=a14_0x534f7d;if(_0x31875a===undefined)_0x31875a=_0x210174;var _0x2c54a6=Object[_0xc31333(0x16d)](_0x2e9e19,_0x210174);(!_0x2c54a6||(_0xc31333(0x158)in _0x2c54a6?!_0x2e9e19[_0xc31333(0x146)]:_0x2c54a6[_0xc31333(0x135)]||_0x2c54a6['configurable']))&&(_0x2c54a6={'enumerable':!![],'get':function(){return _0x2e9e19[_0x210174];}}),Object[_0xc31333(0x11e)](_0x144794,_0x31875a,_0x2c54a6);}:function(_0x3a94da,_0x55fd7f,_0x3fb34d,_0x55a5c1){if(_0x55a5c1===undefined)_0x55a5c1=_0x3fb34d;_0x3a94da[_0x55a5c1]=_0x55fd7f[_0x3fb34d];}),__setModuleDefault=this&&this[a14_0x534f7d(0x154)]||(Object[a14_0x534f7d(0x165)]?function(_0x4186c0,_0x14a185){Object['defineProperty'](_0x4186c0,'default',{'enumerable':!![],'value':_0x14a185});}:function(_0x5c4fb6,_0x2b1c75){const _0x1b86c9=a14_0x534f7d;_0x5c4fb6[_0x1b86c9(0x170)]=_0x2b1c75;}),__importStar=this&&this[a14_0x534f7d(0x13c)]||(function(){var _0x35b80c=function(_0x70646b){const _0x2d7dac=a14_0x49cf;return _0x35b80c=Object[_0x2d7dac(0x164)]||function(_0x5a484e){const _0x52d3ad=_0x2d7dac;var _0x13310a=[];for(var _0x3c3cfa in _0x5a484e)if(Object['prototype'][_0x52d3ad(0x10b)][_0x52d3ad(0x15e)](_0x5a484e,_0x3c3cfa))_0x13310a[_0x13310a[_0x52d3ad(0x130)]]=_0x3c3cfa;return _0x13310a;},_0x35b80c(_0x70646b);};return function(_0x6b4e02){const _0xdb70b7=a14_0x49cf;if(_0x6b4e02&&_0x6b4e02[_0xdb70b7(0x146)])return _0x6b4e02;var _0x4984b0={};if(_0x6b4e02!=null){for(var _0x1c91e5=_0x35b80c(_0x6b4e02),_0x40539f=0x0;_0x40539f<_0x1c91e5['length'];_0x40539f++)if(_0x1c91e5[_0x40539f]!==_0xdb70b7(0x170))__createBinding(_0x4984b0,_0x6b4e02,_0x1c91e5[_0x40539f]);}return __setModuleDefault(_0x4984b0,_0x6b4e02),_0x4984b0;};}()),__importDefault=this&&this[a14_0x534f7d(0x104)]||function(_0x4f19c6){const _0x5bff22=a14_0x534f7d;return _0x4f19c6&&_0x4f19c6[_0x5bff22(0x146)]?_0x4f19c6:{'default':_0x4f19c6};};function a14_0x36e0(){const _0x164c3e=['✅\x20Payment\x20link\x20','FAILED','Payment\x20failed','24oXGgvx','Any\x20other\x20card\x20number','webhookEvents','__importDefault','test_gateway_','currency','cardNumber','amount','stringify','2240073SNZlaA','hasOwnProperty','payment','🧪\x20Test\x20Gateway\x20result:','📈\x20Found\x20payment\x20link\x20','SINGLE','\x20->\x20','6345UQruqQ','TestGatewayController','Payment\x20not\x20found','$transaction','successUrl','4242\x204242\x204242\x204242','status','paymentLinkId','transactionId','Payment\x20status\x20is\x20','\x20not\x20found','sendShopWebhook','getPaymentForm','defineProperty','findUnique','shopId','3018BScxaL','customerName','includes','PENDING','188114FBkAgp','webhookService','test_card','44pDGlWp','shop','failed','processCard','settings',',\x20cannot\x20process','params','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','length','error','failureMessage','cardLast4','customerEmail','writable','test_gateway','Any\x20future\x20date\x20(MM/YY)','✅\x20Test\x20Gateway\x20payment\x20','isArray','../services/telegramBotService','gateway','__importStar','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','then','payment.success','Error\x20parsing\x20webhook\x20events:','434052kpyyhM','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','553aohtEn','slice','TestGatewayService','__esModule','body','payment.failed','Payment\x20to\x20','gatewayPaymentId','testGatewayService','Test\x20Gateway\x20webhook\x20sent\x20to\x20','now','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20with\x20status\x20','Any\x203-4\x20digits','Payment\x20is\x20not\x20for\x20test\x20gateway','📈\x20Test\x20Gateway:\x20Payment\x20','2802348YMLrNe','__setModuleDefault','orderId','../services/webhookService','type','get','failUrl','processCardPayment','paymentMethod',',\x20currentPayments=','gatewayOrderId','call','WebhookService','log','failureReason','paymentLink','replace','getOwnPropertyNames','create','webhookUrl','\x20not\x20enabled\x20for\x20shop\x20','PAID','Payment\x20processed\x20successfully','paidAt','name','createdAt','getOwnPropertyDescriptor',':\x20type=','3065930hCOTCa','default','update','json','toLowerCase','toISOString','../services/gateways/testGatewayService',',\x20status=','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','currentPayments','../config/database','44392tBGbfU','sendPaymentStatusNotification','__createBinding','Any\x20name','COMPLETED'];a14_0x36e0=function(){return _0x164c3e;};return a14_0x36e0();}Object[a14_0x534f7d(0x11e)](exports,a14_0x534f7d(0x146),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a14_0x534f7d(0x175)),webhookService_1=require(a14_0x534f7d(0x156)),database_1=__importDefault(require(a14_0x534f7d(0xf8)));class TestGatewayController{constructor(){const _0x416037=a14_0x534f7d;this[_0x416037(0x11d)]=async(_0x460fd5,_0x3017d8,_0x54e841)=>{const _0x1a1e7b=_0x416037;try{const {paymentId:_0x18877e}=_0x460fd5[_0x1a1e7b(0x12e)];console[_0x1a1e7b(0x160)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x18877e);const _0x2678a6=await database_1[_0x1a1e7b(0x170)][_0x1a1e7b(0x10c)][_0x1a1e7b(0x11f)]({'where':{'id':_0x18877e},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2678a6)return _0x3017d8[_0x1a1e7b(0x117)](0x194)[_0x1a1e7b(0x172)]({'success':![],'message':_0x1a1e7b(0x113)});if(_0x2678a6[_0x1a1e7b(0x13b)]!==_0x1a1e7b(0x136))return _0x3017d8[_0x1a1e7b(0x117)](0x190)[_0x1a1e7b(0x172)]({'success':![],'message':_0x1a1e7b(0x151)});if(_0x2678a6[_0x1a1e7b(0x117)]!=='PENDING')return _0x3017d8['status'](0x190)[_0x1a1e7b(0x172)]({'success':![],'message':_0x1a1e7b(0x11a)+_0x2678a6[_0x1a1e7b(0x117)]+_0x1a1e7b(0x12d)});_0x3017d8[_0x1a1e7b(0x172)]({'success':!![],'result':{'paymentId':_0x2678a6['id'],'orderId':_0x2678a6[_0x1a1e7b(0x15d)],'amount':_0x2678a6[_0x1a1e7b(0x108)],'currency':_0x2678a6['currency'],'merchantName':_0x2678a6[_0x1a1e7b(0x129)][_0x1a1e7b(0x16b)],'description':_0x1a1e7b(0x149)+_0x2678a6[_0x1a1e7b(0x129)]['name'],'testInstructions':{'successCard':_0x1a1e7b(0x116),'failureCard':_0x1a1e7b(0x102),'expiryDate':_0x1a1e7b(0x137),'cvc':_0x1a1e7b(0x150),'holderName':_0x1a1e7b(0xfc)}}});}catch(_0x3531b2){_0x54e841(_0x3531b2);}},this[_0x416037(0x12b)]=async(_0x452ad7,_0x253875,_0x4db628)=>{const _0x4a6c6b=_0x416037;try{const {paymentId:_0x1e2778}=_0x452ad7[_0x4a6c6b(0x12e)],_0x2be533=_0x452ad7[_0x4a6c6b(0x147)];console[_0x4a6c6b(0x160)]('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x1e2778);const _0x1edda2=await database_1[_0x4a6c6b(0x170)][_0x4a6c6b(0x10c)]['findUnique']({'where':{'id':_0x1e2778},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1edda2)return _0x253875[_0x4a6c6b(0x117)](0x194)[_0x4a6c6b(0x172)]({'success':![],'message':_0x4a6c6b(0x113)});if(_0x1edda2[_0x4a6c6b(0x13b)]!==_0x4a6c6b(0x136))return _0x253875[_0x4a6c6b(0x117)](0x190)[_0x4a6c6b(0x172)]({'success':![],'message':_0x4a6c6b(0x151)});if(_0x1edda2[_0x4a6c6b(0x117)]!=='PENDING')return _0x253875['status'](0x190)[_0x4a6c6b(0x172)]({'success':![],'message':_0x4a6c6b(0x11a)+_0x1edda2['status']+_0x4a6c6b(0x12d)});const _0x134544=await this['testGatewayService'][_0x4a6c6b(0x15a)]({'paymentId':_0x1edda2['id'],'orderId':_0x1edda2['gatewayOrderId']||_0x1edda2['id'],'amount':_0x1edda2['amount'],'currency':_0x1edda2['currency'],'cardData':_0x2be533});console[_0x4a6c6b(0x160)](_0x4a6c6b(0x10d),_0x134544);const _0x203e07={'status':_0x134544[_0x4a6c6b(0x117)],'updatedAt':new Date()};if(_0x134544[_0x4a6c6b(0x117)]===_0x4a6c6b(0x168))_0x203e07[_0x4a6c6b(0x16a)]=new Date(),_0x203e07[_0x4a6c6b(0x14a)]=_0x134544['transactionId'];else _0x134544[_0x4a6c6b(0x117)]===_0x4a6c6b(0xff)&&(_0x203e07[_0x4a6c6b(0x132)]=_0x134544[_0x4a6c6b(0x161)]);const _0x5ab1e3=_0x2be533[_0x4a6c6b(0x107)][_0x4a6c6b(0x163)](/[\s-]/g,'');_0x203e07[_0x4a6c6b(0x133)]=_0x5ab1e3[_0x4a6c6b(0x144)](-0x4),_0x203e07[_0x4a6c6b(0x15b)]=_0x4a6c6b(0x127),await database_1[_0x4a6c6b(0x170)][_0x4a6c6b(0x10c)][_0x4a6c6b(0x171)]({'where':{'id':_0x1edda2['id']},'data':_0x203e07});if(_0x134544[_0x4a6c6b(0x117)]===_0x4a6c6b(0x168)&&_0x1edda2[_0x4a6c6b(0x118)]){console['log'](_0x4a6c6b(0x152)+_0x1edda2['id']+_0x4a6c6b(0xf6));try{await database_1[_0x4a6c6b(0x170)][_0x4a6c6b(0x114)](async _0x31a293=>{const _0x17c766=_0x4a6c6b,_0x5c5c33=await _0x31a293[_0x17c766(0x162)][_0x17c766(0x11f)]({'where':{'id':_0x1edda2[_0x17c766(0x118)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x5c5c33){console[_0x17c766(0x160)](_0x17c766(0x10e)+_0x5c5c33['id']+_0x17c766(0x16e)+_0x5c5c33[_0x17c766(0x157)]+_0x17c766(0x15c)+_0x5c5c33[_0x17c766(0xf7)]+_0x17c766(0x176)+_0x5c5c33['status']);const _0x489582=_0x5c5c33[_0x17c766(0xf7)]+0x1,_0x852686=_0x5c5c33['type']===_0x17c766(0x10f)?_0x17c766(0xfd):_0x5c5c33[_0x17c766(0x117)];await _0x31a293['paymentLink'][_0x17c766(0x171)]({'where':{'id':_0x1edda2[_0x17c766(0x118)]},'data':{'currentPayments':_0x489582,'status':_0x852686,'updatedAt':new Date()}}),console[_0x17c766(0x160)](_0x17c766(0xfe)+_0x5c5c33['id']+'\x20updated:\x20currentPayments='+_0x5c5c33[_0x17c766(0xf7)]+_0x17c766(0x110)+_0x489582+_0x17c766(0x176)+_0x5c5c33[_0x17c766(0x117)]+_0x17c766(0x110)+_0x852686);}else console[_0x17c766(0x160)]('❌\x20Payment\x20link\x20'+_0x1edda2[_0x17c766(0x118)]+_0x17c766(0x11b));});}catch(_0x404bfd){console['error'](_0x4a6c6b(0x142),_0x404bfd);}}await database_1[_0x4a6c6b(0x170)]['webhookLog'][_0x4a6c6b(0x165)]({'data':{'paymentId':_0x1edda2['id'],'shopId':_0x1edda2[_0x4a6c6b(0x120)],'event':_0x4a6c6b(0x105)+_0x134544['status'][_0x4a6c6b(0x173)](),'statusCode':0xc8,'responseBody':JSON[_0x4a6c6b(0x109)]({'oldStatus':_0x4a6c6b(0x124),'newStatus':_0x134544[_0x4a6c6b(0x117)],'transactionId':_0x134544[_0x4a6c6b(0x119)],'failureReason':_0x134544[_0x4a6c6b(0x161)],'processedAt':new Date()[_0x4a6c6b(0x174)]()})}}),await this[_0x4a6c6b(0x11c)](_0x1edda2,_0x134544['status'],_0x134544[_0x4a6c6b(0x119)],_0x134544[_0x4a6c6b(0x161)]),await this[_0x4a6c6b(0xfa)](_0x1edda2,_0x134544[_0x4a6c6b(0x117)]),console[_0x4a6c6b(0x160)](_0x4a6c6b(0x138)+_0x1e2778+'\x20processed:\x20'+_0x134544['status']),_0x134544[_0x4a6c6b(0x117)]===_0x4a6c6b(0x168)?_0x253875[_0x4a6c6b(0x172)]({'success':!![],'message':_0x4a6c6b(0x169),'result':{'status':_0x4a6c6b(0x168),'transactionId':_0x134544[_0x4a6c6b(0x119)],'redirectUrl':_0x1edda2[_0x4a6c6b(0x115)]}}):_0x253875[_0x4a6c6b(0x117)](0x190)[_0x4a6c6b(0x172)]({'success':![],'message':_0x4a6c6b(0x100),'result':{'status':'FAILED','failureReason':_0x134544[_0x4a6c6b(0x161)],'redirectUrl':_0x1edda2[_0x4a6c6b(0x159)]}});}catch(_0x95c230){_0x4db628(_0x95c230);}},this[_0x416037(0x14b)]=new testGatewayService_1[(_0x416037(0x145))](),this[_0x416037(0x126)]=new webhookService_1[(_0x416037(0x15f))]();}async[a14_0x534f7d(0x11c)](_0x15ab38,_0x215654,_0x4f08ec,_0x46477c){const _0x16deef=a14_0x534f7d,_0x12c910=Date[_0x16deef(0x14d)]();try{const _0x2cacb8=_0x15ab38[_0x16deef(0x129)],_0x40a24b=_0x2cacb8[_0x16deef(0x12c)];if(!_0x40a24b?.[_0x16deef(0x166)]){console['log'](_0x16deef(0x14e)+_0x2cacb8['id']);return;}const _0x1280bf=_0x215654===_0x16deef(0x168)?_0x16deef(0x13f):_0x16deef(0x148);let _0x28f87d=[];if(_0x40a24b[_0x16deef(0x103)])try{_0x28f87d=Array[_0x16deef(0x139)](_0x40a24b[_0x16deef(0x103)])?_0x40a24b[_0x16deef(0x103)]:JSON['parse'](_0x40a24b['webhookEvents']);}catch(_0x1160a7){console[_0x16deef(0x131)](_0x16deef(0x140),_0x1160a7),_0x28f87d=[];}if(!_0x28f87d[_0x16deef(0x123)](_0x1280bf)){console[_0x16deef(0x160)]('Webhook\x20event\x20'+_0x1280bf+_0x16deef(0x167)+_0x2cacb8['id']);return;}const _0x531326={'event':_0x1280bf,'payment':{'id':_0x15ab38['id'],'order_id':_0x15ab38[_0x16deef(0x155)],'gateway_order_id':_0x15ab38[_0x16deef(0x15d)],'gateway':'0000','amount':_0x15ab38[_0x16deef(0x108)],'currency':_0x15ab38[_0x16deef(0x106)],'status':_0x215654[_0x16deef(0x173)](),'customer_email':_0x15ab38[_0x16deef(0x134)],'customer_name':_0x15ab38[_0x16deef(0x122)],'transaction_id':_0x4f08ec,'failure_message':_0x46477c,'created_at':_0x15ab38[_0x16deef(0x16c)],'updated_at':new Date()}},_0x17a503=await fetch(_0x40a24b['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x16deef(0x13d)},'body':JSON[_0x16deef(0x109)](_0x531326)}),_0x52c85e=Date[_0x16deef(0x14d)]()-_0x12c910;console[_0x16deef(0x160)](_0x16deef(0x14c)+_0x40a24b[_0x16deef(0x166)]+_0x16deef(0x14f)+_0x17a503['status']+'\x20('+_0x52c85e+'ms)');}catch(_0x4e8457){console[_0x16deef(0x131)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x4e8457);}}async[a14_0x534f7d(0xfa)](_0xd77413,_0x2f647d){const _0x1bd8fe=a14_0x534f7d;try{const {telegramBotService:_0x5bc6b2}=await Promise['resolve']()[_0x1bd8fe(0x13e)](()=>__importStar(require(_0x1bd8fe(0x13a)))),_0xfd92d1={'PAID':'paid','FAILED':_0x1bd8fe(0x12a)},_0x3325cc=_0xfd92d1[_0x2f647d];if(!_0x3325cc)return;await _0x5bc6b2['sendPaymentNotification'](_0xd77413[_0x1bd8fe(0x120)],_0xd77413,_0x3325cc);}catch(_0x42dc27){console[_0x1bd8fe(0x131)](_0x1bd8fe(0x12f),_0x42dc27);}}}exports[a14_0x534f7d(0x112)]=TestGatewayController;