'use strict';const a13_0x3c3d63=a13_0x1dbb;function a13_0x1dbb(_0x4783cb,_0x5a3a3e){const _0xf6e3d4=a13_0xf6e3();return a13_0x1dbb=function(_0x1dbb28,_0x1ddd18){_0x1dbb28=_0x1dbb28-0xc9;let _0x4006b0=_0xf6e3d4[_0x1dbb28];return _0x4006b0;},a13_0x1dbb(_0x4783cb,_0x5a3a3e);}(function(_0x5366f3,_0x42e7db){const _0xbd4975=a13_0x1dbb,_0x21e4ef=_0x5366f3();while(!![]){try{const _0x3b582c=parseInt(_0xbd4975(0x119))/0x1*(parseInt(_0xbd4975(0xf3))/0x2)+parseInt(_0xbd4975(0xfb))/0x3+parseInt(_0xbd4975(0x125))/0x4*(-parseInt(_0xbd4975(0x11a))/0x5)+parseInt(_0xbd4975(0x10a))/0x6+-parseInt(_0xbd4975(0xde))/0x7*(parseInt(_0xbd4975(0x11f))/0x8)+parseInt(_0xbd4975(0xdb))/0x9*(parseInt(_0xbd4975(0x114))/0xa)+-parseInt(_0xbd4975(0x129))/0xb;if(_0x3b582c===_0x42e7db)break;else _0x21e4ef['push'](_0x21e4ef['shift']());}catch(_0xd410a5){_0x21e4ef['push'](_0x21e4ef['shift']());}}}(a13_0xf6e3,0xa3d38));function a13_0xf6e3(){const _0xab61b4=['5705598nLGXQv','hasOwnProperty','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','replace','__esModule','Payment\x20not\x20found','isArray','get','transactionId','sendPaymentNotification','90EVzgnV','ms)','json','failed','toLowerCase','122627PVLxNF','10VWvDup','processCard','FAILED','shop','getOwnPropertyNames','56cGsVlV','body','Payment\x20failed','amount','POST','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1028168IkjJMs','stringify','PAID','failureMessage','10888284maBczL','create','__importStar','Payment\x20is\x20not\x20for\x20test\x20gateway','call','Payment\x20status\x20is\x20','now','sendShopWebhook','customerName','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','length','params','Any\x203-4\x20digits','gatewayOrderId','test_gateway','webhookEvents','__setModuleDefault','webhookService','../services/gateways/testGatewayService','\x20processed:\x20','resolve','cardLast4','686277pOQOaY','../services/webhookService','\x20not\x20enabled\x20for\x20shop\x20','25963DTtjqp','Test\x20Gateway\x20webhook\x20sent\x20to\x20','WebhookService','toISOString','../config/database','shopId',',\x20cannot\x20process','findUnique','default','cardNumber','defineProperty','TestGatewayController','name','sendPaymentStatusNotification','slice','webhookLog','gateway','status','createdAt','orderId','paidAt','4ntkVep','test_card','error','âœ…\x20Test\x20Gateway\x20payment\x20','webhookUrl','PENDING','Any\x20name','testGatewayService','955377qObnaG','payment.failed','log','getPaymentForm','includes','currency','0000','application/json','failureReason','then','payment','__createBinding','Any\x20other\x20card\x20number','Any\x20future\x20date\x20(MM/YY)','payment.success'];a13_0xf6e3=function(){return _0xab61b4;};return a13_0xf6e3();}var __createBinding=this&&this[a13_0x3c3d63(0x106)]||(Object[a13_0x3c3d63(0x12a)]?function(_0x447bef,_0x53047d,_0x37fbcf,_0x2400c3){const _0x900ab7=a13_0x3c3d63;if(_0x2400c3===undefined)_0x2400c3=_0x37fbcf;var _0x244510=Object['getOwnPropertyDescriptor'](_0x53047d,_0x37fbcf);(!_0x244510||(_0x900ab7(0x111)in _0x244510?!_0x53047d[_0x900ab7(0x10e)]:_0x244510['writable']||_0x244510['configurable']))&&(_0x244510={'enumerable':!![],'get':function(){return _0x53047d[_0x37fbcf];}}),Object[_0x900ab7(0xe8)](_0x447bef,_0x2400c3,_0x244510);}:function(_0x3032c8,_0x326be4,_0x2c802f,_0x51f99c){if(_0x51f99c===undefined)_0x51f99c=_0x2c802f;_0x3032c8[_0x51f99c]=_0x326be4[_0x2c802f];}),__setModuleDefault=this&&this[a13_0x3c3d63(0xd5)]||(Object['create']?function(_0x82b7a9,_0x139233){const _0x27dd90=a13_0x3c3d63;Object['defineProperty'](_0x82b7a9,_0x27dd90(0xe6),{'enumerable':!![],'value':_0x139233});}:function(_0xcba3aa,_0x2b39e3){const _0x5a6583=a13_0x3c3d63;_0xcba3aa[_0x5a6583(0xe6)]=_0x2b39e3;}),__importStar=this&&this[a13_0x3c3d63(0x12b)]||(function(){var _0x2894b2=function(_0x429486){const _0x3490b9=a13_0x1dbb;return _0x2894b2=Object[_0x3490b9(0x11e)]||function(_0x45b484){const _0x2e8ff0=_0x3490b9;var _0x56ad8b=[];for(var _0x5aff98 in _0x45b484)if(Object['prototype'][_0x2e8ff0(0x10b)][_0x2e8ff0(0xc9)](_0x45b484,_0x5aff98))_0x56ad8b[_0x56ad8b[_0x2e8ff0(0xcf)]]=_0x5aff98;return _0x56ad8b;},_0x2894b2(_0x429486);};return function(_0x11f788){const _0x3362da=a13_0x1dbb;if(_0x11f788&&_0x11f788[_0x3362da(0x10e)])return _0x11f788;var _0x13443f={};if(_0x11f788!=null){for(var _0x53df44=_0x2894b2(_0x11f788),_0x5f59c2=0x0;_0x5f59c2<_0x53df44['length'];_0x5f59c2++)if(_0x53df44[_0x5f59c2]!==_0x3362da(0xe6))__createBinding(_0x13443f,_0x11f788,_0x53df44[_0x5f59c2]);}return __setModuleDefault(_0x13443f,_0x11f788),_0x13443f;};}()),__importDefault=this&&this['__importDefault']||function(_0x5b58a9){const _0x5d1b80=a13_0x3c3d63;return _0x5b58a9&&_0x5b58a9[_0x5d1b80(0x10e)]?_0x5b58a9:{'default':_0x5b58a9};};Object[a13_0x3c3d63(0xe8)](exports,'__esModule',{'value':!![]}),exports[a13_0x3c3d63(0xe9)]=void 0x0;const testGatewayService_1=require(a13_0x3c3d63(0xd7)),webhookService_1=require(a13_0x3c3d63(0xdc)),database_1=__importDefault(require(a13_0x3c3d63(0xe2)));class TestGatewayController{constructor(){const _0xbf2313=a13_0x3c3d63;this[_0xbf2313(0xfe)]=async(_0x34c068,_0x5931d8,_0x2cc661)=>{const _0x30bddf=_0xbf2313;try{const {paymentId:_0x3a1786}=_0x34c068['params'];console['log'](_0x30bddf(0x10c)+_0x3a1786);const _0x5e9446=await database_1['default'][_0x30bddf(0x105)][_0x30bddf(0xe5)]({'where':{'id':_0x3a1786},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x5e9446)return _0x5931d8[_0x30bddf(0xef)](0x194)[_0x30bddf(0x116)]({'success':![],'message':_0x30bddf(0x10f)});if(_0x5e9446[_0x30bddf(0xee)]!=='test_gateway')return _0x5931d8[_0x30bddf(0xef)](0x190)[_0x30bddf(0x116)]({'success':![],'message':_0x30bddf(0x12c)});if(_0x5e9446['status']!=='PENDING')return _0x5931d8['status'](0x190)[_0x30bddf(0x116)]({'success':![],'message':_0x30bddf(0xca)+_0x5e9446[_0x30bddf(0xef)]+_0x30bddf(0xe4)});_0x5931d8[_0x30bddf(0x116)]({'success':!![],'result':{'paymentId':_0x5e9446['id'],'orderId':_0x5e9446[_0x30bddf(0xd2)],'amount':_0x5e9446[_0x30bddf(0x122)],'currency':_0x5e9446['currency'],'merchantName':_0x5e9446['shop'][_0x30bddf(0xea)],'description':'Payment\x20to\x20'+_0x5e9446[_0x30bddf(0x11d)]['name'],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x30bddf(0x107),'expiryDate':_0x30bddf(0x108),'cvc':_0x30bddf(0xd1),'holderName':_0x30bddf(0xf9)}}});}catch(_0x4a8950){_0x2cc661(_0x4a8950);}},this[_0xbf2313(0x11b)]=async(_0x133e51,_0x439b3e,_0x53d084)=>{const _0x38ed10=_0xbf2313;try{const {paymentId:_0x426890}=_0x133e51[_0x38ed10(0xd0)],_0x36ed87=_0x133e51[_0x38ed10(0x120)];console[_0x38ed10(0xfd)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x426890);const _0x1efc61=await database_1[_0x38ed10(0xe6)][_0x38ed10(0x105)]['findUnique']({'where':{'id':_0x426890},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1efc61)return _0x439b3e[_0x38ed10(0xef)](0x194)['json']({'success':![],'message':_0x38ed10(0x10f)});if(_0x1efc61['gateway']!==_0x38ed10(0xd3))return _0x439b3e[_0x38ed10(0xef)](0x190)[_0x38ed10(0x116)]({'success':![],'message':_0x38ed10(0x12c)});if(_0x1efc61[_0x38ed10(0xef)]!==_0x38ed10(0xf8))return _0x439b3e['status'](0x190)[_0x38ed10(0x116)]({'success':![],'message':_0x38ed10(0xca)+_0x1efc61['status']+_0x38ed10(0xe4)});const _0x5aab6e=await this[_0x38ed10(0xfa)]['processCardPayment']({'paymentId':_0x1efc61['id'],'orderId':_0x1efc61[_0x38ed10(0xd2)]||_0x1efc61['id'],'amount':_0x1efc61[_0x38ed10(0x122)],'currency':_0x1efc61['currency'],'cardData':_0x36ed87});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x5aab6e);const _0x20e303={'status':_0x5aab6e[_0x38ed10(0xef)],'updatedAt':new Date()};if(_0x5aab6e['status']===_0x38ed10(0x127))_0x20e303[_0x38ed10(0xf2)]=new Date(),_0x20e303['gatewayPaymentId']=_0x5aab6e['transactionId'];else _0x5aab6e[_0x38ed10(0xef)]===_0x38ed10(0x11c)&&(_0x20e303[_0x38ed10(0x128)]=_0x5aab6e[_0x38ed10(0x103)]);const _0x5b4948=_0x36ed87[_0x38ed10(0xe7)][_0x38ed10(0x10d)](/[\s-]/g,'');_0x20e303[_0x38ed10(0xda)]=_0x5b4948[_0x38ed10(0xec)](-0x4),_0x20e303['paymentMethod']=_0x38ed10(0xf4),await database_1[_0x38ed10(0xe6)]['payment']['update']({'where':{'id':_0x1efc61['id']},'data':_0x20e303}),await database_1[_0x38ed10(0xe6)][_0x38ed10(0xed)]['create']({'data':{'paymentId':_0x1efc61['id'],'shopId':_0x1efc61[_0x38ed10(0xe3)],'event':'test_gateway_'+_0x5aab6e['status']['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x38ed10(0x126)]({'oldStatus':'PENDING','newStatus':_0x5aab6e['status'],'transactionId':_0x5aab6e[_0x38ed10(0x112)],'failureReason':_0x5aab6e['failureReason'],'processedAt':new Date()[_0x38ed10(0xe1)]()})}}),await this[_0x38ed10(0xcc)](_0x1efc61,_0x5aab6e['status'],_0x5aab6e[_0x38ed10(0x112)],_0x5aab6e[_0x38ed10(0x103)]),await this[_0x38ed10(0xeb)](_0x1efc61,_0x5aab6e[_0x38ed10(0xef)]),console[_0x38ed10(0xfd)](_0x38ed10(0xf6)+_0x426890+_0x38ed10(0xd8)+_0x5aab6e[_0x38ed10(0xef)]),_0x5aab6e['status']===_0x38ed10(0x127)?_0x439b3e[_0x38ed10(0x116)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','transactionId':_0x5aab6e[_0x38ed10(0x112)],'redirectUrl':_0x1efc61['successUrl']}}):_0x439b3e[_0x38ed10(0xef)](0x190)[_0x38ed10(0x116)]({'success':![],'message':_0x38ed10(0x121),'result':{'status':'FAILED','failureReason':_0x5aab6e[_0x38ed10(0x103)],'redirectUrl':_0x1efc61['failUrl']}});}catch(_0x2452a3){_0x53d084(_0x2452a3);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0xbf2313(0xd6)]=new webhookService_1[(_0xbf2313(0xe0))]();}async[a13_0x3c3d63(0xcc)](_0x5a4ce5,_0x4c0607,_0x32c7af,_0x504b7d){const _0xec7560=a13_0x3c3d63,_0x34782d=Date[_0xec7560(0xcb)]();try{const _0x26c3bf=_0x5a4ce5[_0xec7560(0x11d)],_0x4e76e2=_0x26c3bf['settings'];if(!_0x4e76e2?.[_0xec7560(0xf7)]){console[_0xec7560(0xfd)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x26c3bf['id']);return;}const _0x503960=_0x4c0607===_0xec7560(0x127)?_0xec7560(0x109):_0xec7560(0xfc);let _0x51fa05=[];if(_0x4e76e2[_0xec7560(0xd4)])try{_0x51fa05=Array[_0xec7560(0x110)](_0x4e76e2[_0xec7560(0xd4)])?_0x4e76e2[_0xec7560(0xd4)]:JSON['parse'](_0x4e76e2['webhookEvents']);}catch(_0xcacbe5){console[_0xec7560(0xf5)]('Error\x20parsing\x20webhook\x20events:',_0xcacbe5),_0x51fa05=[];}if(!_0x51fa05[_0xec7560(0xff)](_0x503960)){console[_0xec7560(0xfd)]('Webhook\x20event\x20'+_0x503960+_0xec7560(0xdd)+_0x26c3bf['id']);return;}const _0x420c20={'event':_0x503960,'payment':{'id':_0x5a4ce5['id'],'order_id':_0x5a4ce5[_0xec7560(0xf1)],'gateway_order_id':_0x5a4ce5[_0xec7560(0xd2)],'gateway':_0xec7560(0x101),'amount':_0x5a4ce5[_0xec7560(0x122)],'currency':_0x5a4ce5[_0xec7560(0x100)],'status':_0x4c0607[_0xec7560(0x118)](),'customer_email':_0x5a4ce5['customerEmail'],'customer_name':_0x5a4ce5[_0xec7560(0xcd)],'transaction_id':_0x32c7af,'failure_message':_0x504b7d,'created_at':_0x5a4ce5[_0xec7560(0xf0)],'updated_at':new Date()}},_0x2268a1=await fetch(_0x4e76e2[_0xec7560(0xf7)],{'method':_0xec7560(0x123),'headers':{'Content-Type':_0xec7560(0x102),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x420c20)}),_0x1d0c3a=Date[_0xec7560(0xcb)]()-_0x34782d;console[_0xec7560(0xfd)](_0xec7560(0xdf)+_0x4e76e2[_0xec7560(0xf7)]+'\x20with\x20status\x20'+_0x2268a1[_0xec7560(0xef)]+'\x20('+_0x1d0c3a+_0xec7560(0x115));}catch(_0xaede6f){console['error'](_0xec7560(0xce),_0xaede6f);}}async[a13_0x3c3d63(0xeb)](_0x5196c1,_0x2b7188){const _0x1b1c38=a13_0x3c3d63;try{const {telegramBotService:_0x174bdd}=await Promise[_0x1b1c38(0xd9)]()[_0x1b1c38(0x104)](()=>__importStar(require('../services/telegramBotService'))),_0x58a747={'PAID':'paid','FAILED':_0x1b1c38(0x117)},_0x51478d=_0x58a747[_0x2b7188];if(!_0x51478d)return;await _0x174bdd[_0x1b1c38(0x113)](_0x5196c1[_0x1b1c38(0xe3)],_0x5196c1,_0x51478d);}catch(_0x28eb0d){console['error'](_0x1b1c38(0x124),_0x28eb0d);}}}exports[a13_0x3c3d63(0xe9)]=TestGatewayController;