'use strict';function a14_0x34bc(){const _0x42fede=['\x20not\x20found','test_card','shopId','56tvkLwF','toISOString','shop','failureReason','default','0000','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','get','8zeqNPS','processCard','cardNumber','üß™\x20Test\x20Gateway\x20result:','sendPaymentNotification','payment.success','amount','PAID','51dntobA','testGatewayService','webhookUrl','paymentMethod','Payment\x20is\x20not\x20for\x20test\x20gateway','configurable','__importStar','TestGatewayController','isArray','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','üìà\x20Found\x20payment\x20link\x20','__esModule','includes','Payment\x20failed','‚úÖ\x20Payment\x20link\x20','failed',',\x20status=','518690ESBhJu','replace','\x20with\x20status\x20','type','7556808rJbXiQ','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','$transaction','FAILED','then','769575tJuIRB','now','../services/gateways/testGatewayService','update','getOwnPropertyNames','__createBinding','__importDefault','\x20->\x20','\x20updated:\x20currentPayments=','2863690wCnjLZ','264yqULbd','webhookEvents','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currency','POST','sendPaymentStatusNotification','getPaymentForm','Any\x20other\x20card\x20number','orderId','error','params','transactionId','11010YIKzjP','gatewayPaymentId','findUnique','hasOwnProperty','customerName','Payment\x20to\x20','../config/database','../services/telegramBotService','sendShopWebhook','Any\x20future\x20date\x20(MM/YY)','cardLast4','Error\x20parsing\x20webhook\x20events:','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','test_gateway_',',\x20currentPayments=','4242\x204242\x204242\x204242','SINGLE','COMPLETED','Test\x20Gateway\x20webhook\x20sent\x20to\x20','paymentLink','PENDING','resolve','name','7sZETsj','Payment\x20status\x20is\x20','create','toLowerCase','currentPayments','defineProperty','\x20processed:\x20','payment','test_gateway','gatewayOrderId','json','status','1236096DXiebr','slice','722241iLQQuX','gateway','body','paymentLinkId','stringify','settings','createdAt','length','log','payment.failed'];a14_0x34bc=function(){return _0x42fede;};return a14_0x34bc();}const a14_0x2f041a=a14_0x1b05;(function(_0x4ff397,_0x4057fe){const _0x1de671=a14_0x1b05,_0x4494df=_0x4ff397();while(!![]){try{const _0x21db56=-parseInt(_0x1de671(0x1cd))/0x1*(-parseInt(_0x1de671(0x1fd))/0x2)+-parseInt(_0x1de671(0x1e7))/0x3+parseInt(_0x1de671(0x1c5))/0x4*(parseInt(_0x1de671(0x1f0))/0x5)+parseInt(_0x1de671(0x1e2))/0x6*(parseInt(_0x1de671(0x214))/0x7)+-parseInt(_0x1de671(0x1bd))/0x8*(parseInt(_0x1de671(0x1b0))/0x9)+-parseInt(_0x1de671(0x1de))/0xa*(parseInt(_0x1de671(0x1f1))/0xb)+parseInt(_0x1de671(0x1ae))/0xc;if(_0x21db56===_0x4057fe)break;else _0x4494df['push'](_0x4494df['shift']());}catch(_0x361f69){_0x4494df['push'](_0x4494df['shift']());}}}(a14_0x34bc,0xb124f));var __createBinding=this&&this[a14_0x2f041a(0x1ec)]||(Object[a14_0x2f041a(0x1a4)]?function(_0x353f36,_0x200d8c,_0x5b2a27,_0x1b630d){const _0x4f148e=a14_0x2f041a;if(_0x1b630d===undefined)_0x1b630d=_0x5b2a27;var _0x5b0d99=Object['getOwnPropertyDescriptor'](_0x200d8c,_0x5b2a27);(!_0x5b0d99||(_0x4f148e(0x1c4)in _0x5b0d99?!_0x200d8c[_0x4f148e(0x1d8)]:_0x5b0d99['writable']||_0x5b0d99[_0x4f148e(0x1d2)]))&&(_0x5b0d99={'enumerable':!![],'get':function(){return _0x200d8c[_0x5b2a27];}}),Object[_0x4f148e(0x1a7)](_0x353f36,_0x1b630d,_0x5b0d99);}:function(_0x44143b,_0x2eff4e,_0x37ed21,_0x384970){if(_0x384970===undefined)_0x384970=_0x37ed21;_0x44143b[_0x384970]=_0x2eff4e[_0x37ed21];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a14_0x2f041a(0x1a4)]?function(_0x5c2ada,_0x2891dc){const _0x3c823f=a14_0x2f041a;Object[_0x3c823f(0x1a7)](_0x5c2ada,'default',{'enumerable':!![],'value':_0x2891dc});}:function(_0x455335,_0x99fabb){const _0x3728c9=a14_0x2f041a;_0x455335[_0x3728c9(0x1c1)]=_0x99fabb;}),__importStar=this&&this[a14_0x2f041a(0x1d3)]||(function(){var _0x16e874=function(_0x77ab69){const _0x2eb21e=a14_0x1b05;return _0x16e874=Object[_0x2eb21e(0x1eb)]||function(_0x46ee61){const _0x26d122=_0x2eb21e;var _0x5a5641=[];for(var _0x23186f in _0x46ee61)if(Object['prototype'][_0x26d122(0x200)]['call'](_0x46ee61,_0x23186f))_0x5a5641[_0x5a5641[_0x26d122(0x1b7)]]=_0x23186f;return _0x5a5641;},_0x16e874(_0x77ab69);};return function(_0x50a071){const _0x1bb129=a14_0x1b05;if(_0x50a071&&_0x50a071[_0x1bb129(0x1d8)])return _0x50a071;var _0x47e20e={};if(_0x50a071!=null){for(var _0x11cd2d=_0x16e874(_0x50a071),_0x17528d=0x0;_0x17528d<_0x11cd2d[_0x1bb129(0x1b7)];_0x17528d++)if(_0x11cd2d[_0x17528d]!==_0x1bb129(0x1c1))__createBinding(_0x47e20e,_0x50a071,_0x11cd2d[_0x17528d]);}return __setModuleDefault(_0x47e20e,_0x50a071),_0x47e20e;};}()),__importDefault=this&&this[a14_0x2f041a(0x1ed)]||function(_0x373532){const _0xa1e7c=a14_0x2f041a;return _0x373532&&_0x373532[_0xa1e7c(0x1d8)]?_0x373532:{'default':_0x373532};};function a14_0x1b05(_0x188148,_0x334f01){const _0x34bc91=a14_0x34bc();return a14_0x1b05=function(_0x1b05b6,_0x4b5540){_0x1b05b6=_0x1b05b6-0x1a4;let _0x31f68d=_0x34bc91[_0x1b05b6];return _0x31f68d;},a14_0x1b05(_0x188148,_0x334f01);}Object[a14_0x2f041a(0x1a7)](exports,'__esModule',{'value':!![]}),exports[a14_0x2f041a(0x1d4)]=void 0x0;const testGatewayService_1=require(a14_0x2f041a(0x1e9)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a14_0x2f041a(0x203)));class TestGatewayController{constructor(){const _0x415064=a14_0x2f041a;this[_0x415064(0x1f7)]=async(_0xa7cee0,_0x34f43b,_0x5d8d64)=>{const _0x253209=_0x415064;try{const {paymentId:_0x22efe}=_0xa7cee0[_0x253209(0x1fb)];console[_0x253209(0x1b8)](_0x253209(0x1d6)+_0x22efe);const _0x3b9f30=await database_1[_0x253209(0x1c1)][_0x253209(0x1a9)][_0x253209(0x1ff)]({'where':{'id':_0x22efe},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x3b9f30)return _0x34f43b[_0x253209(0x1ad)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x3b9f30[_0x253209(0x1b1)]!=='test_gateway')return _0x34f43b[_0x253209(0x1ad)](0x190)[_0x253209(0x1ac)]({'success':![],'message':_0x253209(0x1d1)});if(_0x3b9f30[_0x253209(0x1ad)]!=='PENDING')return _0x34f43b['status'](0x190)[_0x253209(0x1ac)]({'success':![],'message':_0x253209(0x215)+_0x3b9f30[_0x253209(0x1ad)]+',\x20cannot\x20process'});_0x34f43b[_0x253209(0x1ac)]({'success':!![],'result':{'paymentId':_0x3b9f30['id'],'orderId':_0x3b9f30['gatewayOrderId'],'amount':_0x3b9f30[_0x253209(0x1cb)],'currency':_0x3b9f30[_0x253209(0x1f4)],'merchantName':_0x3b9f30[_0x253209(0x1bf)][_0x253209(0x213)],'description':_0x253209(0x202)+_0x3b9f30[_0x253209(0x1bf)][_0x253209(0x213)],'testInstructions':{'successCard':_0x253209(0x20c),'failureCard':_0x253209(0x1f8),'expiryDate':_0x253209(0x206),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x58ffc3){_0x5d8d64(_0x58ffc3);}},this[_0x415064(0x1c6)]=async(_0x2f2197,_0x219267,_0x35c818)=>{const _0xa8fe9a=_0x415064;try{const {paymentId:_0x227083}=_0x2f2197[_0xa8fe9a(0x1fb)],_0x575eb0=_0x2f2197[_0xa8fe9a(0x1b2)];console[_0xa8fe9a(0x1b8)](_0xa8fe9a(0x209)+_0x227083);const _0x5c9b76=await database_1['default'][_0xa8fe9a(0x1a9)][_0xa8fe9a(0x1ff)]({'where':{'id':_0x227083},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c9b76)return _0x219267[_0xa8fe9a(0x1ad)](0x194)[_0xa8fe9a(0x1ac)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x5c9b76[_0xa8fe9a(0x1b1)]!==_0xa8fe9a(0x1aa))return _0x219267[_0xa8fe9a(0x1ad)](0x190)[_0xa8fe9a(0x1ac)]({'success':![],'message':_0xa8fe9a(0x1d1)});if(_0x5c9b76[_0xa8fe9a(0x1ad)]!==_0xa8fe9a(0x211))return _0x219267[_0xa8fe9a(0x1ad)](0x190)['json']({'success':![],'message':_0xa8fe9a(0x215)+_0x5c9b76[_0xa8fe9a(0x1ad)]+',\x20cannot\x20process'});const _0x23fe80=await this['testGatewayService']['processCardPayment']({'paymentId':_0x5c9b76['id'],'orderId':_0x5c9b76['gatewayOrderId']||_0x5c9b76['id'],'amount':_0x5c9b76[_0xa8fe9a(0x1cb)],'currency':_0x5c9b76['currency'],'cardData':_0x575eb0});console['log'](_0xa8fe9a(0x1c8),_0x23fe80);const _0x33df20={'status':_0x23fe80[_0xa8fe9a(0x1ad)],'updatedAt':new Date()};if(_0x23fe80[_0xa8fe9a(0x1ad)]==='PAID')_0x33df20['paidAt']=new Date(),_0x33df20[_0xa8fe9a(0x1fe)]=_0x23fe80[_0xa8fe9a(0x1fc)];else _0x23fe80[_0xa8fe9a(0x1ad)]===_0xa8fe9a(0x1e5)&&(_0x33df20['failureMessage']=_0x23fe80[_0xa8fe9a(0x1c0)]);const _0x30a536=_0x575eb0[_0xa8fe9a(0x1c7)][_0xa8fe9a(0x1df)](/[\s-]/g,'');_0x33df20[_0xa8fe9a(0x207)]=_0x30a536[_0xa8fe9a(0x1af)](-0x4),_0x33df20[_0xa8fe9a(0x1d0)]=_0xa8fe9a(0x1bb),await database_1[_0xa8fe9a(0x1c1)][_0xa8fe9a(0x1a9)][_0xa8fe9a(0x1ea)]({'where':{'id':_0x5c9b76['id']},'data':_0x33df20});if(_0x23fe80['status']===_0xa8fe9a(0x1cc)&&_0x5c9b76[_0xa8fe9a(0x1b3)]){console['log']('üìà\x20Test\x20Gateway:\x20Payment\x20'+_0x5c9b76['id']+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{await database_1['default'][_0xa8fe9a(0x1e4)](async _0x33ebda=>{const _0x2d9aff=_0xa8fe9a,_0x1e6868=await _0x33ebda[_0x2d9aff(0x210)][_0x2d9aff(0x1ff)]({'where':{'id':_0x5c9b76['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x1e6868){console[_0x2d9aff(0x1b8)](_0x2d9aff(0x1d7)+_0x1e6868['id']+':\x20type='+_0x1e6868[_0x2d9aff(0x1e1)]+_0x2d9aff(0x20b)+_0x1e6868[_0x2d9aff(0x1a6)]+_0x2d9aff(0x1dd)+_0x1e6868['status']);const _0x45c813=_0x1e6868[_0x2d9aff(0x1a6)]+0x1,_0x2962c6=_0x1e6868[_0x2d9aff(0x1e1)]===_0x2d9aff(0x20d)?_0x2d9aff(0x20e):_0x1e6868[_0x2d9aff(0x1ad)];await _0x33ebda[_0x2d9aff(0x210)][_0x2d9aff(0x1ea)]({'where':{'id':_0x5c9b76[_0x2d9aff(0x1b3)]},'data':{'currentPayments':_0x45c813,'status':_0x2962c6,'updatedAt':new Date()}}),console[_0x2d9aff(0x1b8)](_0x2d9aff(0x1db)+_0x1e6868['id']+_0x2d9aff(0x1ef)+_0x1e6868['currentPayments']+'\x20->\x20'+_0x45c813+_0x2d9aff(0x1dd)+_0x1e6868['status']+_0x2d9aff(0x1ee)+_0x2962c6);}else console[_0x2d9aff(0x1b8)]('‚ùå\x20Payment\x20link\x20'+_0x5c9b76[_0x2d9aff(0x1b3)]+_0x2d9aff(0x1ba));});}catch(_0x1b2fc3){console[_0xa8fe9a(0x1fa)]('‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:',_0x1b2fc3);}}await database_1[_0xa8fe9a(0x1c1)]['webhookLog'][_0xa8fe9a(0x1a4)]({'data':{'paymentId':_0x5c9b76['id'],'shopId':_0x5c9b76[_0xa8fe9a(0x1bc)],'event':_0xa8fe9a(0x20a)+_0x23fe80[_0xa8fe9a(0x1ad)][_0xa8fe9a(0x1a5)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xa8fe9a(0x211),'newStatus':_0x23fe80[_0xa8fe9a(0x1ad)],'transactionId':_0x23fe80[_0xa8fe9a(0x1fc)],'failureReason':_0x23fe80[_0xa8fe9a(0x1c0)],'processedAt':new Date()[_0xa8fe9a(0x1be)]()})}}),await this[_0xa8fe9a(0x205)](_0x5c9b76,_0x23fe80[_0xa8fe9a(0x1ad)],_0x23fe80[_0xa8fe9a(0x1fc)],_0x23fe80[_0xa8fe9a(0x1c0)]),await this['sendPaymentStatusNotification'](_0x5c9b76,_0x23fe80[_0xa8fe9a(0x1ad)]),console[_0xa8fe9a(0x1b8)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x227083+_0xa8fe9a(0x1a8)+_0x23fe80[_0xa8fe9a(0x1ad)]),_0x23fe80[_0xa8fe9a(0x1ad)]===_0xa8fe9a(0x1cc)?_0x219267[_0xa8fe9a(0x1ac)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0xa8fe9a(0x1cc),'transactionId':_0x23fe80[_0xa8fe9a(0x1fc)],'redirectUrl':_0x5c9b76['successUrl']}}):_0x219267[_0xa8fe9a(0x1ad)](0x190)[_0xa8fe9a(0x1ac)]({'success':![],'message':_0xa8fe9a(0x1da),'result':{'status':_0xa8fe9a(0x1e5),'failureReason':_0x23fe80[_0xa8fe9a(0x1c0)],'redirectUrl':_0x5c9b76['failUrl']}});}catch(_0x25db78){_0x35c818(_0x25db78);}},this[_0x415064(0x1ce)]=new testGatewayService_1['TestGatewayService'](),this['webhookService']=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x5497dc,_0x15a0a3,_0x3140fa,_0x3e5fbc){const _0x3a97cb=a14_0x2f041a,_0x5a0558=Date[_0x3a97cb(0x1e8)]();try{const _0x19cac8=_0x5497dc[_0x3a97cb(0x1bf)],_0xc88780=_0x19cac8[_0x3a97cb(0x1b5)];if(!_0xc88780?.[_0x3a97cb(0x1cf)]){console['log'](_0x3a97cb(0x1e3)+_0x19cac8['id']);return;}const _0x7096e5=_0x15a0a3===_0x3a97cb(0x1cc)?_0x3a97cb(0x1ca):_0x3a97cb(0x1b9);let _0x2a0d5c=[];if(_0xc88780[_0x3a97cb(0x1f2)])try{_0x2a0d5c=Array[_0x3a97cb(0x1d5)](_0xc88780[_0x3a97cb(0x1f2)])?_0xc88780['webhookEvents']:JSON['parse'](_0xc88780[_0x3a97cb(0x1f2)]);}catch(_0x4169a4){console[_0x3a97cb(0x1fa)](_0x3a97cb(0x208),_0x4169a4),_0x2a0d5c=[];}if(!_0x2a0d5c[_0x3a97cb(0x1d9)](_0x7096e5)){console['log']('Webhook\x20event\x20'+_0x7096e5+'\x20not\x20enabled\x20for\x20shop\x20'+_0x19cac8['id']);return;}const _0x305336={'event':_0x7096e5,'payment':{'id':_0x5497dc['id'],'order_id':_0x5497dc[_0x3a97cb(0x1f9)],'gateway_order_id':_0x5497dc[_0x3a97cb(0x1ab)],'gateway':_0x3a97cb(0x1c2),'amount':_0x5497dc[_0x3a97cb(0x1cb)],'currency':_0x5497dc[_0x3a97cb(0x1f4)],'status':_0x15a0a3[_0x3a97cb(0x1a5)](),'customer_email':_0x5497dc['customerEmail'],'customer_name':_0x5497dc[_0x3a97cb(0x201)],'transaction_id':_0x3140fa,'failure_message':_0x3e5fbc,'created_at':_0x5497dc[_0x3a97cb(0x1b6)],'updated_at':new Date()}},_0x5a8ade=await fetch(_0xc88780[_0x3a97cb(0x1cf)],{'method':_0x3a97cb(0x1f5),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x3a97cb(0x1b4)](_0x305336)}),_0x47ebad=Date[_0x3a97cb(0x1e8)]()-_0x5a0558;console[_0x3a97cb(0x1b8)](_0x3a97cb(0x20f)+_0xc88780[_0x3a97cb(0x1cf)]+_0x3a97cb(0x1e0)+_0x5a8ade[_0x3a97cb(0x1ad)]+'\x20('+_0x47ebad+'ms)');}catch(_0xfebe57){console[_0x3a97cb(0x1fa)](_0x3a97cb(0x1c3),_0xfebe57);}}async[a14_0x2f041a(0x1f6)](_0x1e47ef,_0x4e4dcd){const _0x1960e2=a14_0x2f041a;try{const {telegramBotService:_0x4d8cef}=await Promise[_0x1960e2(0x212)]()[_0x1960e2(0x1e6)](()=>__importStar(require(_0x1960e2(0x204)))),_0x241777={'PAID':'paid','FAILED':_0x1960e2(0x1dc)},_0xcaa1f9=_0x241777[_0x4e4dcd];if(!_0xcaa1f9)return;await _0x4d8cef[_0x1960e2(0x1c9)](_0x1e47ef['shopId'],_0x1e47ef,_0xcaa1f9);}catch(_0x5d22c1){console[_0x1960e2(0x1fa)](_0x1960e2(0x1f3),_0x5d22c1);}}}exports[a14_0x2f041a(0x1d4)]=TestGatewayController;