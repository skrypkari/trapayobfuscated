'use strict';const a13_0x5d4adf=a13_0xde33;(function(_0x4047b2,_0xce7341){const _0x1200c9=a13_0xde33,_0x5e37bd=_0x4047b2();while(!![]){try{const _0x160089=-parseInt(_0x1200c9(0x230))/0x1+parseInt(_0x1200c9(0x21f))/0x2+-parseInt(_0x1200c9(0x22e))/0x3+-parseInt(_0x1200c9(0x203))/0x4+-parseInt(_0x1200c9(0x218))/0x5*(parseInt(_0x1200c9(0x207))/0x6)+-parseInt(_0x1200c9(0x1ed))/0x7+parseInt(_0x1200c9(0x20a))/0x8;if(_0x160089===_0xce7341)break;else _0x5e37bd['push'](_0x5e37bd['shift']());}catch(_0x300b92){_0x5e37bd['push'](_0x5e37bd['shift']());}}}(a13_0xc881,0x6dcb7));var __createBinding=this&&this[a13_0x5d4adf(0x225)]||(Object[a13_0x5d4adf(0x222)]?function(_0x1242ec,_0x29b7d8,_0x2c1a44,_0x2bfe9b){const _0x33c6a4=a13_0x5d4adf;if(_0x2bfe9b===undefined)_0x2bfe9b=_0x2c1a44;var _0x1a2d80=Object[_0x33c6a4(0x23b)](_0x29b7d8,_0x2c1a44);(!_0x1a2d80||(_0x33c6a4(0x232)in _0x1a2d80?!_0x29b7d8[_0x33c6a4(0x20e)]:_0x1a2d80['writable']||_0x1a2d80[_0x33c6a4(0x226)]))&&(_0x1a2d80={'enumerable':!![],'get':function(){return _0x29b7d8[_0x2c1a44];}}),Object['defineProperty'](_0x1242ec,_0x2bfe9b,_0x1a2d80);}:function(_0x4c6251,_0x5829c9,_0x2a19bf,_0x1b2d50){if(_0x1b2d50===undefined)_0x1b2d50=_0x2a19bf;_0x4c6251[_0x1b2d50]=_0x5829c9[_0x2a19bf];}),__setModuleDefault=this&&this[a13_0x5d4adf(0x227)]||(Object['create']?function(_0x3e87ec,_0x597b5e){const _0x4b596c=a13_0x5d4adf;Object[_0x4b596c(0x239)](_0x3e87ec,_0x4b596c(0x245),{'enumerable':!![],'value':_0x597b5e});}:function(_0x59459b,_0x28c7b6){_0x59459b['default']=_0x28c7b6;}),__importStar=this&&this[a13_0x5d4adf(0x221)]||(function(){var _0xf39d5d=function(_0xb9a1dc){return _0xf39d5d=Object['getOwnPropertyNames']||function(_0x59e58d){const _0x2ebe8e=a13_0xde33;var _0x2d6de4=[];for(var _0x32e80c in _0x59e58d)if(Object[_0x2ebe8e(0x219)][_0x2ebe8e(0x205)]['call'](_0x59e58d,_0x32e80c))_0x2d6de4[_0x2d6de4[_0x2ebe8e(0x228)]]=_0x32e80c;return _0x2d6de4;},_0xf39d5d(_0xb9a1dc);};return function(_0x32c4d0){const _0x582747=a13_0xde33;if(_0x32c4d0&&_0x32c4d0['__esModule'])return _0x32c4d0;var _0x1878e9={};if(_0x32c4d0!=null){for(var _0x4f340b=_0xf39d5d(_0x32c4d0),_0x9ec61f=0x0;_0x9ec61f<_0x4f340b[_0x582747(0x228)];_0x9ec61f++)if(_0x4f340b[_0x9ec61f]!==_0x582747(0x245))__createBinding(_0x1878e9,_0x32c4d0,_0x4f340b[_0x9ec61f]);}return __setModuleDefault(_0x1878e9,_0x32c4d0),_0x1878e9;};}()),__importDefault=this&&this['__importDefault']||function(_0x8b6da7){const _0x49681d=a13_0x5d4adf;return _0x8b6da7&&_0x8b6da7[_0x49681d(0x20e)]?_0x8b6da7:{'default':_0x8b6da7};};function a13_0xde33(_0x32372a,_0x4ae378){const _0xc8816b=a13_0xc881();return a13_0xde33=function(_0xde33b9,_0x510c4d){_0xde33b9=_0xde33b9-0x1ea;let _0x4ef82d=_0xc8816b[_0xde33b9];return _0x4ef82d;},a13_0xde33(_0x32372a,_0x4ae378);}function a13_0xc881(){const _0x1a3cb6=['sendPaymentStatusNotification','failureReason','112786ESntSZ','webhookUrl','__importStar','create','sendShopWebhook','Error\x20parsing\x20webhook\x20events:','__createBinding','configurable','__setModuleDefault','length','webhookEvents','processCard','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','sendPaymentNotification','ms)','2061099vzPEMb','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','665986ImOGOS','\x20not\x20enabled\x20for\x20shop\x20','get','gatewayOrderId','failureMessage','Payment\x20is\x20not\x20for\x20test\x20gateway','amount','gateway','json','defineProperty','paid','getOwnPropertyDescriptor','Payment\x20not\x20found','failed','settings','Webhook\x20event\x20','currency','testGatewayService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PAID','WebhookService','default','webhookService','shopId','test_gateway','findUnique','body','test_gateway_','log','shop','slice','resolve','1824032HibXGO','Test\x20Gateway\x20webhook\x20sent\x20to\x20','test_card','name','Payment\x20failed','Payment\x20to\x20','includes','Any\x203-4\x20digits','transactionId','error','gatewayPaymentId','processCardPayment','TestGatewayController','FAILED','../config/database',',\x20cannot\x20process','payment.success','4242\x204242\x204242\x204242','isArray','../services/gateways/testGatewayService','../services/telegramBotService','cardNumber','912680keaenl','orderId','hasOwnProperty','Any\x20future\x20date\x20(MM/YY)','8466JLfFzn','successUrl','payment','21188112ZOYcEJ','now','cardLast4','ðŸ§ª\x20Test\x20Gateway\x20result:','__esModule','../services/webhookService','POST','paymentMethod','toLowerCase','stringify','0000','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','params','\x20processed:\x20','1465eNcFQc','prototype','Payment\x20status\x20is\x20','status','webhookLog'];a13_0xc881=function(){return _0x1a3cb6;};return a13_0xc881();}Object[a13_0x5d4adf(0x239)](exports,a13_0x5d4adf(0x20e),{'value':!![]}),exports[a13_0x5d4adf(0x1f9)]=void 0x0;const testGatewayService_1=require(a13_0x5d4adf(0x200)),webhookService_1=require(a13_0x5d4adf(0x20f)),database_1=__importDefault(require(a13_0x5d4adf(0x1fb)));class TestGatewayController{constructor(){const _0x95eab8=a13_0x5d4adf;this['getPaymentForm']=async(_0x168646,_0x1e6a68,_0x12baca)=>{const _0xfbf757=a13_0xde33;try{const {paymentId:_0x4d06af}=_0x168646[_0xfbf757(0x216)];console['log'](_0xfbf757(0x22f)+_0x4d06af);const _0x293d55=await database_1['default']['payment'][_0xfbf757(0x249)]({'where':{'id':_0x4d06af},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x293d55)return _0x1e6a68[_0xfbf757(0x21b)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x293d55[_0xfbf757(0x237)]!==_0xfbf757(0x248))return _0x1e6a68[_0xfbf757(0x21b)](0x190)[_0xfbf757(0x238)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x293d55[_0xfbf757(0x21b)]!=='PENDING')return _0x1e6a68[_0xfbf757(0x21b)](0x190)['json']({'success':![],'message':_0xfbf757(0x21a)+_0x293d55['status']+_0xfbf757(0x1fc)});_0x1e6a68[_0xfbf757(0x238)]({'success':!![],'result':{'paymentId':_0x293d55['id'],'orderId':_0x293d55[_0xfbf757(0x233)],'amount':_0x293d55['amount'],'currency':_0x293d55['currency'],'merchantName':_0x293d55[_0xfbf757(0x1ea)]['name'],'description':_0xfbf757(0x1f2)+_0x293d55[_0xfbf757(0x1ea)][_0xfbf757(0x1f0)],'testInstructions':{'successCard':_0xfbf757(0x1fe),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0xfbf757(0x206),'cvc':_0xfbf757(0x1f4),'holderName':'Any\x20name'}}});}catch(_0x5b3a9e){_0x12baca(_0x5b3a9e);}},this[_0x95eab8(0x22a)]=async(_0x3bd77b,_0x26df34,_0x2c1a2d)=>{const _0x290e47=_0x95eab8;try{const {paymentId:_0x31d478}=_0x3bd77b[_0x290e47(0x216)],_0x1f5cf5=_0x3bd77b[_0x290e47(0x24a)];console[_0x290e47(0x24c)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x31d478);const _0x25fc40=await database_1['default']['payment'][_0x290e47(0x249)]({'where':{'id':_0x31d478},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25fc40)return _0x26df34[_0x290e47(0x21b)](0x194)[_0x290e47(0x238)]({'success':![],'message':_0x290e47(0x23c)});if(_0x25fc40[_0x290e47(0x237)]!=='test_gateway')return _0x26df34[_0x290e47(0x21b)](0x190)[_0x290e47(0x238)]({'success':![],'message':_0x290e47(0x235)});if(_0x25fc40[_0x290e47(0x21b)]!=='PENDING')return _0x26df34[_0x290e47(0x21b)](0x190)['json']({'success':![],'message':_0x290e47(0x21a)+_0x25fc40[_0x290e47(0x21b)]+_0x290e47(0x1fc)});const _0xeda5db=await this[_0x290e47(0x241)][_0x290e47(0x1f8)]({'paymentId':_0x25fc40['id'],'orderId':_0x25fc40[_0x290e47(0x233)]||_0x25fc40['id'],'amount':_0x25fc40['amount'],'currency':_0x25fc40[_0x290e47(0x240)],'cardData':_0x1f5cf5});console[_0x290e47(0x24c)](_0x290e47(0x20d),_0xeda5db);const _0x21833e={'status':_0xeda5db[_0x290e47(0x21b)],'updatedAt':new Date()};if(_0xeda5db[_0x290e47(0x21b)]===_0x290e47(0x243))_0x21833e['paidAt']=new Date(),_0x21833e[_0x290e47(0x1f7)]=_0xeda5db[_0x290e47(0x1f5)];else _0xeda5db[_0x290e47(0x21b)]===_0x290e47(0x1fa)&&(_0x21833e[_0x290e47(0x234)]=_0xeda5db['failureReason']);const _0x1094c4=_0x1f5cf5[_0x290e47(0x202)]['replace'](/[\s-]/g,'');_0x21833e[_0x290e47(0x20c)]=_0x1094c4[_0x290e47(0x1eb)](-0x4),_0x21833e[_0x290e47(0x211)]=_0x290e47(0x1ef),await database_1[_0x290e47(0x245)][_0x290e47(0x209)]['update']({'where':{'id':_0x25fc40['id']},'data':_0x21833e}),await database_1['default'][_0x290e47(0x21c)][_0x290e47(0x222)]({'data':{'paymentId':_0x25fc40['id'],'shopId':_0x25fc40[_0x290e47(0x247)],'event':_0x290e47(0x24b)+_0xeda5db[_0x290e47(0x21b)][_0x290e47(0x212)](),'statusCode':0xc8,'responseBody':JSON[_0x290e47(0x213)]({'oldStatus':'PENDING','newStatus':_0xeda5db[_0x290e47(0x21b)],'transactionId':_0xeda5db[_0x290e47(0x1f5)],'failureReason':_0xeda5db[_0x290e47(0x21e)],'processedAt':new Date()['toISOString']()})}}),await this[_0x290e47(0x223)](_0x25fc40,_0xeda5db[_0x290e47(0x21b)],_0xeda5db[_0x290e47(0x1f5)],_0xeda5db['failureReason']),await this[_0x290e47(0x21d)](_0x25fc40,_0xeda5db[_0x290e47(0x21b)]),console['log']('âœ…\x20Test\x20Gateway\x20payment\x20'+_0x31d478+_0x290e47(0x217)+_0xeda5db[_0x290e47(0x21b)]),_0xeda5db[_0x290e47(0x21b)]==='PAID'?_0x26df34[_0x290e47(0x238)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x290e47(0x243),'transactionId':_0xeda5db[_0x290e47(0x1f5)],'redirectUrl':_0x25fc40[_0x290e47(0x208)]}}):_0x26df34[_0x290e47(0x21b)](0x190)[_0x290e47(0x238)]({'success':![],'message':_0x290e47(0x1f1),'result':{'status':_0x290e47(0x1fa),'failureReason':_0xeda5db[_0x290e47(0x21e)],'redirectUrl':_0x25fc40['failUrl']}});}catch(_0x30b842){_0x2c1a2d(_0x30b842);}},this[_0x95eab8(0x241)]=new testGatewayService_1['TestGatewayService'](),this[_0x95eab8(0x246)]=new webhookService_1[(_0x95eab8(0x244))]();}async['sendShopWebhook'](_0xec974e,_0x58a3da,_0x2ea965,_0x23f240){const _0x921032=a13_0x5d4adf,_0x414499=Date[_0x921032(0x20b)]();try{const _0x422363=_0xec974e['shop'],_0x25ae56=_0x422363[_0x921032(0x23e)];if(!_0x25ae56?.[_0x921032(0x220)]){console[_0x921032(0x24c)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x422363['id']);return;}const _0x3c84e2=_0x58a3da===_0x921032(0x243)?_0x921032(0x1fd):'payment.failed';let _0x4f800b=[];if(_0x25ae56[_0x921032(0x229)])try{_0x4f800b=Array[_0x921032(0x1ff)](_0x25ae56[_0x921032(0x229)])?_0x25ae56[_0x921032(0x229)]:JSON['parse'](_0x25ae56[_0x921032(0x229)]);}catch(_0x5e254e){console[_0x921032(0x1f6)](_0x921032(0x224),_0x5e254e),_0x4f800b=[];}if(!_0x4f800b[_0x921032(0x1f3)](_0x3c84e2)){console[_0x921032(0x24c)](_0x921032(0x23f)+_0x3c84e2+_0x921032(0x231)+_0x422363['id']);return;}const _0x4e1ba7={'event':_0x3c84e2,'payment':{'id':_0xec974e['id'],'order_id':_0xec974e[_0x921032(0x204)],'gateway_order_id':_0xec974e[_0x921032(0x233)],'gateway':_0x921032(0x214),'amount':_0xec974e[_0x921032(0x236)],'currency':_0xec974e[_0x921032(0x240)],'status':_0x58a3da[_0x921032(0x212)](),'customer_email':_0xec974e['customerEmail'],'customer_name':_0xec974e['customerName'],'transaction_id':_0x2ea965,'failure_message':_0x23f240,'created_at':_0xec974e['createdAt'],'updated_at':new Date()}},_0x363c38=await fetch(_0x25ae56['webhookUrl'],{'method':_0x921032(0x210),'headers':{'Content-Type':'application/json','User-Agent':_0x921032(0x22b)},'body':JSON[_0x921032(0x213)](_0x4e1ba7)}),_0xea3bb6=Date[_0x921032(0x20b)]()-_0x414499;console[_0x921032(0x24c)](_0x921032(0x1ee)+_0x25ae56[_0x921032(0x220)]+'\x20with\x20status\x20'+_0x363c38[_0x921032(0x21b)]+'\x20('+_0xea3bb6+_0x921032(0x22d));}catch(_0x963ad9){console[_0x921032(0x1f6)](_0x921032(0x215),_0x963ad9);}}async['sendPaymentStatusNotification'](_0x1d458a,_0x44f252){const _0x41e16d=a13_0x5d4adf;try{const {telegramBotService:_0x169ab0}=await Promise[_0x41e16d(0x1ec)]()['then'](()=>__importStar(require(_0x41e16d(0x201)))),_0x16a265={'PAID':_0x41e16d(0x23a),'FAILED':_0x41e16d(0x23d)},_0x265cd0=_0x16a265[_0x44f252];if(!_0x265cd0)return;await _0x169ab0[_0x41e16d(0x22c)](_0x1d458a[_0x41e16d(0x247)],_0x1d458a,_0x265cd0);}catch(_0xf61142){console[_0x41e16d(0x1f6)](_0x41e16d(0x242),_0xf61142);}}}exports[a13_0x5d4adf(0x1f9)]=TestGatewayController;