'use strict';const a13_0x59a3c1=a13_0x5b7a;(function(_0x2586cb,_0x7c985a){const _0x2500f8=a13_0x5b7a,_0x33e593=_0x2586cb();while(!![]){try{const _0x22d182=parseInt(_0x2500f8(0x19f))/0x1*(-parseInt(_0x2500f8(0x1c9))/0x2)+-parseInt(_0x2500f8(0x1e5))/0x3*(-parseInt(_0x2500f8(0x1d1))/0x4)+parseInt(_0x2500f8(0x1cf))/0x5*(parseInt(_0x2500f8(0x1f8))/0x6)+parseInt(_0x2500f8(0x1db))/0x7+-parseInt(_0x2500f8(0x192))/0x8+parseInt(_0x2500f8(0x1a0))/0x9*(-parseInt(_0x2500f8(0x1a8))/0xa)+-parseInt(_0x2500f8(0x1b0))/0xb*(parseInt(_0x2500f8(0x1f5))/0xc);if(_0x22d182===_0x7c985a)break;else _0x33e593['push'](_0x33e593['shift']());}catch(_0x4ad61a){_0x33e593['push'](_0x33e593['shift']());}}}(a13_0x5591,0xe097c));function a13_0x5591(){const _0x2c27ad=['Any\x20name','getOwnPropertyDescriptor','customerName','update','successUrl','json','692142gmmxCN','PENDING','Payment\x20status\x20is\x20','Payment\x20failed','default','TestGatewayController','testGatewayService','getOwnPropertyNames','gatewayOrderId','Any\x203-4\x20digits','\x20with\x20status\x20','__createBinding','0000','transactionId','\x20processed:\x20','processCard','300LpSXzN','toISOString','paidAt','938202Sswwhe','stringify','error','6427672SQQmMc','orderId','payment','slice','failureReason','findUnique','sendShopWebhook','toLowerCase',',\x20cannot\x20process','Payment\x20is\x20not\x20for\x20test\x20gateway','replace','Any\x20other\x20card\x20number','webhookLog','15913SyowXu','1183311yJOqcZ','../services/telegramBotService','now','paid','amount','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentStatusNotification','then','30kNxVfJ','TestGatewayService','test_gateway','../services/gateways/testGatewayService','__importStar','__setModuleDefault','../config/database','params','145827VmVnnb','\x20not\x20enabled\x20for\x20shop\x20','status','configurable','createdAt','shopId','Error\x20parsing\x20webhook\x20events:','settings','parse','prototype','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','payment.failed','__importDefault','shop','webhookService','Payment\x20processed\x20successfully','gateway','Payment\x20to\x20','__esModule','PAID','payment.success','failUrl','isArray','ms)','name','34becvNC','Payment\x20not\x20found','log','../services/webhookService','currency','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','45EcCzQd','test_gateway_','8CIFHUe','webhookEvents','create','defineProperty','includes','writable','sendPaymentNotification','FAILED','webhookUrl','paymentMethod','5957301caswjt','body','POST','âœ…\x20Test\x20Gateway\x20payment\x20'];a13_0x5591=function(){return _0x2c27ad;};return a13_0x5591();}var __createBinding=this&&this[a13_0x59a3c1(0x1f0)]||(Object[a13_0x59a3c1(0x1d3)]?function(_0x1ac8e0,_0x732b6f,_0xa211b3,_0x5701db){const _0x2844e8=a13_0x59a3c1;if(_0x5701db===undefined)_0x5701db=_0xa211b3;var _0x5972c5=Object[_0x2844e8(0x1e0)](_0x732b6f,_0xa211b3);(!_0x5972c5||('get'in _0x5972c5?!_0x732b6f[_0x2844e8(0x1c2)]:_0x5972c5[_0x2844e8(0x1d6)]||_0x5972c5[_0x2844e8(0x1b3)]))&&(_0x5972c5={'enumerable':!![],'get':function(){return _0x732b6f[_0xa211b3];}}),Object[_0x2844e8(0x1d4)](_0x1ac8e0,_0x5701db,_0x5972c5);}:function(_0x3f8188,_0x3e9d6e,_0x1c6101,_0x355018){if(_0x355018===undefined)_0x355018=_0x1c6101;_0x3f8188[_0x355018]=_0x3e9d6e[_0x1c6101];}),__setModuleDefault=this&&this[a13_0x59a3c1(0x1ad)]||(Object[a13_0x59a3c1(0x1d3)]?function(_0x4c815d,_0x1f19c8){const _0x2bb703=a13_0x59a3c1;Object[_0x2bb703(0x1d4)](_0x4c815d,'default',{'enumerable':!![],'value':_0x1f19c8});}:function(_0x1e118b,_0x4dd8cf){const _0x437480=a13_0x59a3c1;_0x1e118b[_0x437480(0x1e9)]=_0x4dd8cf;}),__importStar=this&&this[a13_0x59a3c1(0x1ac)]||(function(){var _0x4b095c=function(_0x57e819){const _0x5782b8=a13_0x5b7a;return _0x4b095c=Object[_0x5782b8(0x1ec)]||function(_0x3d0d20){const _0x43dd55=_0x5782b8;var _0x2f6d68=[];for(var _0x32ad90 in _0x3d0d20)if(Object[_0x43dd55(0x1b9)]['hasOwnProperty']['call'](_0x3d0d20,_0x32ad90))_0x2f6d68[_0x2f6d68['length']]=_0x32ad90;return _0x2f6d68;},_0x4b095c(_0x57e819);};return function(_0x5641f7){if(_0x5641f7&&_0x5641f7['__esModule'])return _0x5641f7;var _0x5a548d={};if(_0x5641f7!=null){for(var _0x51a8ab=_0x4b095c(_0x5641f7),_0x1919de=0x0;_0x1919de<_0x51a8ab['length'];_0x1919de++)if(_0x51a8ab[_0x1919de]!=='default')__createBinding(_0x5a548d,_0x5641f7,_0x51a8ab[_0x1919de]);}return __setModuleDefault(_0x5a548d,_0x5641f7),_0x5a548d;};}()),__importDefault=this&&this[a13_0x59a3c1(0x1bc)]||function(_0x1a882a){const _0x149d70=a13_0x59a3c1;return _0x1a882a&&_0x1a882a[_0x149d70(0x1c2)]?_0x1a882a:{'default':_0x1a882a};};Object[a13_0x59a3c1(0x1d4)](exports,a13_0x59a3c1(0x1c2),{'value':!![]}),exports[a13_0x59a3c1(0x1ea)]=void 0x0;function a13_0x5b7a(_0x5bab50,_0x7b53d2){const _0x559107=a13_0x5591();return a13_0x5b7a=function(_0x5b7aff,_0x36704c){_0x5b7aff=_0x5b7aff-0x192;let _0x225458=_0x559107[_0x5b7aff];return _0x225458;},a13_0x5b7a(_0x5bab50,_0x7b53d2);}const testGatewayService_1=require(a13_0x59a3c1(0x1ab)),webhookService_1=require(a13_0x59a3c1(0x1cc)),database_1=__importDefault(require(a13_0x59a3c1(0x1ae)));class TestGatewayController{constructor(){const _0x15de78=a13_0x59a3c1;this['getPaymentForm']=async(_0x5163bf,_0xe9e47f,_0x5cfdcb)=>{const _0x4bf00a=a13_0x5b7a;try{const {paymentId:_0x432991}=_0x5163bf[_0x4bf00a(0x1af)];console[_0x4bf00a(0x1cb)]('ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x432991);const _0x46676f=await database_1[_0x4bf00a(0x1e9)][_0x4bf00a(0x194)][_0x4bf00a(0x197)]({'where':{'id':_0x432991},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x46676f)return _0xe9e47f[_0x4bf00a(0x1b2)](0x194)[_0x4bf00a(0x1e4)]({'success':![],'message':_0x4bf00a(0x1ca)});if(_0x46676f[_0x4bf00a(0x1c0)]!==_0x4bf00a(0x1aa))return _0xe9e47f[_0x4bf00a(0x1b2)](0x190)['json']({'success':![],'message':_0x4bf00a(0x19b)});if(_0x46676f[_0x4bf00a(0x1b2)]!==_0x4bf00a(0x1e6))return _0xe9e47f['status'](0x190)[_0x4bf00a(0x1e4)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x46676f[_0x4bf00a(0x1b2)]+_0x4bf00a(0x19a)});_0xe9e47f[_0x4bf00a(0x1e4)]({'success':!![],'result':{'paymentId':_0x46676f['id'],'orderId':_0x46676f['gatewayOrderId'],'amount':_0x46676f[_0x4bf00a(0x1a4)],'currency':_0x46676f['currency'],'merchantName':_0x46676f['shop'][_0x4bf00a(0x1c8)],'description':_0x4bf00a(0x1c1)+_0x46676f[_0x4bf00a(0x1bd)][_0x4bf00a(0x1c8)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x4bf00a(0x19d),'expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x4bf00a(0x1ee),'holderName':_0x4bf00a(0x1df)}}});}catch(_0x4bda0a){_0x5cfdcb(_0x4bda0a);}},this[_0x15de78(0x1f4)]=async(_0x39faba,_0xe63b50,_0x47cd6c)=>{const _0x5afaed=_0x15de78;try{const {paymentId:_0x2753e9}=_0x39faba[_0x5afaed(0x1af)],_0x2fc0e9=_0x39faba[_0x5afaed(0x1dc)];console['log']('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x2753e9);const _0x2baab1=await database_1['default'][_0x5afaed(0x194)][_0x5afaed(0x197)]({'where':{'id':_0x2753e9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2baab1)return _0xe63b50[_0x5afaed(0x1b2)](0x194)[_0x5afaed(0x1e4)]({'success':![],'message':_0x5afaed(0x1ca)});if(_0x2baab1[_0x5afaed(0x1c0)]!=='test_gateway')return _0xe63b50[_0x5afaed(0x1b2)](0x190)[_0x5afaed(0x1e4)]({'success':![],'message':_0x5afaed(0x19b)});if(_0x2baab1['status']!=='PENDING')return _0xe63b50['status'](0x190)[_0x5afaed(0x1e4)]({'success':![],'message':_0x5afaed(0x1e7)+_0x2baab1[_0x5afaed(0x1b2)]+_0x5afaed(0x19a)});const _0x1bf330=await this[_0x5afaed(0x1eb)]['processCardPayment']({'paymentId':_0x2baab1['id'],'orderId':_0x2baab1[_0x5afaed(0x1ed)]||_0x2baab1['id'],'amount':_0x2baab1[_0x5afaed(0x1a4)],'currency':_0x2baab1[_0x5afaed(0x1cd)],'cardData':_0x2fc0e9});console['log']('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x1bf330);const _0x3fedaf={'status':_0x1bf330[_0x5afaed(0x1b2)],'updatedAt':new Date()};if(_0x1bf330[_0x5afaed(0x1b2)]===_0x5afaed(0x1c3))_0x3fedaf[_0x5afaed(0x1f7)]=new Date(),_0x3fedaf['gatewayPaymentId']=_0x1bf330['transactionId'];else _0x1bf330['status']==='FAILED'&&(_0x3fedaf['failureMessage']=_0x1bf330[_0x5afaed(0x196)]);const _0x20bf06=_0x2fc0e9['cardNumber'][_0x5afaed(0x19c)](/[\s-]/g,'');_0x3fedaf['cardLast4']=_0x20bf06[_0x5afaed(0x195)](-0x4),_0x3fedaf[_0x5afaed(0x1da)]='test_card',await database_1[_0x5afaed(0x1e9)][_0x5afaed(0x194)][_0x5afaed(0x1e2)]({'where':{'id':_0x2baab1['id']},'data':_0x3fedaf}),await database_1[_0x5afaed(0x1e9)][_0x5afaed(0x19e)][_0x5afaed(0x1d3)]({'data':{'paymentId':_0x2baab1['id'],'shopId':_0x2baab1[_0x5afaed(0x1b5)],'event':_0x5afaed(0x1d0)+_0x1bf330[_0x5afaed(0x1b2)][_0x5afaed(0x199)](),'statusCode':0xc8,'responseBody':JSON[_0x5afaed(0x1f9)]({'oldStatus':_0x5afaed(0x1e6),'newStatus':_0x1bf330[_0x5afaed(0x1b2)],'transactionId':_0x1bf330[_0x5afaed(0x1f2)],'failureReason':_0x1bf330[_0x5afaed(0x196)],'processedAt':new Date()[_0x5afaed(0x1f6)]()})}}),await this[_0x5afaed(0x198)](_0x2baab1,_0x1bf330[_0x5afaed(0x1b2)],_0x1bf330['transactionId'],_0x1bf330[_0x5afaed(0x196)]),await this[_0x5afaed(0x1a6)](_0x2baab1,_0x1bf330['status']),console[_0x5afaed(0x1cb)](_0x5afaed(0x1de)+_0x2753e9+_0x5afaed(0x1f3)+_0x1bf330['status']),_0x1bf330[_0x5afaed(0x1b2)]==='PAID'?_0xe63b50[_0x5afaed(0x1e4)]({'success':!![],'message':_0x5afaed(0x1bf),'result':{'status':'PAID','transactionId':_0x1bf330[_0x5afaed(0x1f2)],'redirectUrl':_0x2baab1[_0x5afaed(0x1e3)]}}):_0xe63b50['status'](0x190)['json']({'success':![],'message':_0x5afaed(0x1e8),'result':{'status':_0x5afaed(0x1d8),'failureReason':_0x1bf330[_0x5afaed(0x196)],'redirectUrl':_0x2baab1[_0x5afaed(0x1c5)]}});}catch(_0xfc981e){_0x47cd6c(_0xfc981e);}},this['testGatewayService']=new testGatewayService_1[(_0x15de78(0x1a9))](),this[_0x15de78(0x1be)]=new webhookService_1['WebhookService']();}async[a13_0x59a3c1(0x198)](_0x45bc63,_0x361b70,_0x199094,_0x209576){const _0x2c84c2=a13_0x59a3c1,_0x5b568f=Date[_0x2c84c2(0x1a2)]();try{const _0x5dc90c=_0x45bc63[_0x2c84c2(0x1bd)],_0x6b6ca2=_0x5dc90c[_0x2c84c2(0x1b7)];if(!_0x6b6ca2?.[_0x2c84c2(0x1d9)]){console[_0x2c84c2(0x1cb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5dc90c['id']);return;}const _0xaec7f2=_0x361b70===_0x2c84c2(0x1c3)?_0x2c84c2(0x1c4):_0x2c84c2(0x1bb);let _0xe13f83=[];if(_0x6b6ca2[_0x2c84c2(0x1d2)])try{_0xe13f83=Array[_0x2c84c2(0x1c6)](_0x6b6ca2[_0x2c84c2(0x1d2)])?_0x6b6ca2[_0x2c84c2(0x1d2)]:JSON[_0x2c84c2(0x1b8)](_0x6b6ca2['webhookEvents']);}catch(_0x30c0a6){console[_0x2c84c2(0x1fa)](_0x2c84c2(0x1b6),_0x30c0a6),_0xe13f83=[];}if(!_0xe13f83[_0x2c84c2(0x1d5)](_0xaec7f2)){console[_0x2c84c2(0x1cb)]('Webhook\x20event\x20'+_0xaec7f2+_0x2c84c2(0x1b1)+_0x5dc90c['id']);return;}const _0x79fec5={'event':_0xaec7f2,'payment':{'id':_0x45bc63['id'],'order_id':_0x45bc63[_0x2c84c2(0x193)],'gateway_order_id':_0x45bc63[_0x2c84c2(0x1ed)],'gateway':_0x2c84c2(0x1f1),'amount':_0x45bc63[_0x2c84c2(0x1a4)],'currency':_0x45bc63[_0x2c84c2(0x1cd)],'status':_0x361b70['toLowerCase'](),'customer_email':_0x45bc63['customerEmail'],'customer_name':_0x45bc63[_0x2c84c2(0x1e1)],'transaction_id':_0x199094,'failure_message':_0x209576,'created_at':_0x45bc63[_0x2c84c2(0x1b4)],'updated_at':new Date()}},_0x20de46=await fetch(_0x6b6ca2[_0x2c84c2(0x1d9)],{'method':_0x2c84c2(0x1dd),'headers':{'Content-Type':'application/json','User-Agent':_0x2c84c2(0x1ba)},'body':JSON['stringify'](_0x79fec5)}),_0x28a3c8=Date['now']()-_0x5b568f;console[_0x2c84c2(0x1cb)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x6b6ca2[_0x2c84c2(0x1d9)]+_0x2c84c2(0x1ef)+_0x20de46[_0x2c84c2(0x1b2)]+'\x20('+_0x28a3c8+_0x2c84c2(0x1c7));}catch(_0x2c5aba){console[_0x2c84c2(0x1fa)](_0x2c84c2(0x1ce),_0x2c5aba);}}async[a13_0x59a3c1(0x1a6)](_0x3820c1,_0x2bdbf2){const _0x223e47=a13_0x59a3c1;try{const {telegramBotService:_0x35b59f}=await Promise['resolve']()[_0x223e47(0x1a7)](()=>__importStar(require(_0x223e47(0x1a1)))),_0x1f14b4={'PAID':_0x223e47(0x1a3),'FAILED':'failed'},_0xb931b5=_0x1f14b4[_0x2bdbf2];if(!_0xb931b5)return;await _0x35b59f[_0x223e47(0x1d7)](_0x3820c1[_0x223e47(0x1b5)],_0x3820c1,_0xb931b5);}catch(_0x4bf1f3){console[_0x223e47(0x1fa)](_0x223e47(0x1a5),_0x4bf1f3);}}}exports[a13_0x59a3c1(0x1ea)]=TestGatewayController;