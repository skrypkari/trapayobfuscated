'use strict';const a13_0x5b0b32=a13_0x13db;function a13_0x13db(_0x3cebba,_0x284cce){const _0x562703=a13_0x5627();return a13_0x13db=function(_0x13dbe8,_0x318d51){_0x13dbe8=_0x13dbe8-0x1ad;let _0x4c3b34=_0x562703[_0x13dbe8];return _0x4c3b34;},a13_0x13db(_0x3cebba,_0x284cce);}(function(_0x427078,_0x4b90dd){const _0x37f910=a13_0x13db,_0x1ef0bc=_0x427078();while(!![]){try{const _0x4a4c9e=parseInt(_0x37f910(0x1c0))/0x1+-parseInt(_0x37f910(0x1c7))/0x2+-parseInt(_0x37f910(0x1f1))/0x3*(-parseInt(_0x37f910(0x1ba))/0x4)+-parseInt(_0x37f910(0x1fc))/0x5*(parseInt(_0x37f910(0x1bf))/0x6)+-parseInt(_0x37f910(0x210))/0x7*(parseInt(_0x37f910(0x1e4))/0x8)+parseInt(_0x37f910(0x1c4))/0x9+-parseInt(_0x37f910(0x1ae))/0xa;if(_0x4a4c9e===_0x4b90dd)break;else _0x1ef0bc['push'](_0x1ef0bc['shift']());}catch(_0x46555f){_0x1ef0bc['push'](_0x1ef0bc['shift']());}}}(a13_0x5627,0x3f330));var __createBinding=this&&this[a13_0x5b0b32(0x1da)]||(Object[a13_0x5b0b32(0x1bb)]?function(_0x3dcbe1,_0x2d3c9c,_0xe99151,_0x2615f0){const _0x375d44=a13_0x5b0b32;if(_0x2615f0===undefined)_0x2615f0=_0xe99151;var _0x5d0f32=Object['getOwnPropertyDescriptor'](_0x2d3c9c,_0xe99151);(!_0x5d0f32||(_0x375d44(0x1b0)in _0x5d0f32?!_0x2d3c9c[_0x375d44(0x20a)]:_0x5d0f32[_0x375d44(0x1db)]||_0x5d0f32[_0x375d44(0x1de)]))&&(_0x5d0f32={'enumerable':!![],'get':function(){return _0x2d3c9c[_0xe99151];}}),Object['defineProperty'](_0x3dcbe1,_0x2615f0,_0x5d0f32);}:function(_0x44624f,_0x939dd1,_0xe2d730,_0x4c30c0){if(_0x4c30c0===undefined)_0x4c30c0=_0xe2d730;_0x44624f[_0x4c30c0]=_0x939dd1[_0xe2d730];}),__setModuleDefault=this&&this[a13_0x5b0b32(0x207)]||(Object[a13_0x5b0b32(0x1bb)]?function(_0x3c9793,_0x506e43){const _0x2890b2=a13_0x5b0b32;Object['defineProperty'](_0x3c9793,_0x2890b2(0x1ed),{'enumerable':!![],'value':_0x506e43});}:function(_0x505737,_0x3ca7d7){const _0x77f271=a13_0x5b0b32;_0x505737[_0x77f271(0x1ed)]=_0x3ca7d7;}),__importStar=this&&this[a13_0x5b0b32(0x211)]||(function(){var _0x56848b=function(_0x5bb36d){const _0x43d5dc=a13_0x13db;return _0x56848b=Object[_0x43d5dc(0x1e6)]||function(_0x555de2){const _0x10aef0=_0x43d5dc;var _0x313be2=[];for(var _0x177939 in _0x555de2)if(Object['prototype']['hasOwnProperty'][_0x10aef0(0x1e8)](_0x555de2,_0x177939))_0x313be2[_0x313be2[_0x10aef0(0x20e)]]=_0x177939;return _0x313be2;},_0x56848b(_0x5bb36d);};return function(_0x34a66e){const _0x2e1e79=a13_0x13db;if(_0x34a66e&&_0x34a66e[_0x2e1e79(0x20a)])return _0x34a66e;var _0x3502a8={};if(_0x34a66e!=null){for(var _0x330b58=_0x56848b(_0x34a66e),_0x8e753=0x0;_0x8e753<_0x330b58[_0x2e1e79(0x20e)];_0x8e753++)if(_0x330b58[_0x8e753]!==_0x2e1e79(0x1ed))__createBinding(_0x3502a8,_0x34a66e,_0x330b58[_0x8e753]);}return __setModuleDefault(_0x3502a8,_0x34a66e),_0x3502a8;};}()),__importDefault=this&&this[a13_0x5b0b32(0x1b3)]||function(_0x134943){return _0x134943&&_0x134943['__esModule']?_0x134943:{'default':_0x134943};};Object[a13_0x5b0b32(0x1d5)](exports,a13_0x5b0b32(0x20a),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x5056e1=a13_0x5b0b32;this[_0x5056e1(0x209)]=async(_0x586cc3,_0x2046b9,_0x136951)=>{const _0x469719=_0x5056e1;try{const {paymentId:_0x27d24f}=_0x586cc3['params'];console['log'](_0x469719(0x1eb)+_0x27d24f);const _0x402f60=await database_1['default'][_0x469719(0x1e1)][_0x469719(0x1d9)]({'where':{'id':_0x27d24f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x402f60)return _0x2046b9[_0x469719(0x1f5)](0x194)[_0x469719(0x1ce)]({'success':![],'message':_0x469719(0x1e5)});if(_0x402f60[_0x469719(0x1f6)]!=='test_gateway')return _0x2046b9[_0x469719(0x1f5)](0x190)['json']({'success':![],'message':_0x469719(0x203)});if(_0x402f60['status']!==_0x469719(0x1d6))return _0x2046b9[_0x469719(0x1f5)](0x190)[_0x469719(0x1ce)]({'success':![],'message':_0x469719(0x1c3)+_0x402f60[_0x469719(0x1f5)]+_0x469719(0x204)});_0x2046b9[_0x469719(0x1ce)]({'success':!![],'result':{'paymentId':_0x402f60['id'],'orderId':_0x402f60[_0x469719(0x201)],'amount':_0x402f60[_0x469719(0x1ad)],'currency':_0x402f60['currency'],'merchantName':_0x402f60[_0x469719(0x1fa)][_0x469719(0x1b9)],'description':_0x469719(0x1ea)+_0x402f60[_0x469719(0x1fa)][_0x469719(0x1b9)],'testInstructions':{'successCard':_0x469719(0x1b1),'failureCard':_0x469719(0x1c8),'expiryDate':_0x469719(0x1f4),'cvc':_0x469719(0x1af),'holderName':_0x469719(0x1d0)}}});}catch(_0x2643ca){_0x136951(_0x2643ca);}},this[_0x5056e1(0x200)]=async(_0x50c461,_0x4a3bdb,_0x53e16a)=>{const _0x15adb5=_0x5056e1;try{const {paymentId:_0x3ef366}=_0x50c461[_0x15adb5(0x1c9)],_0x32c993=_0x50c461[_0x15adb5(0x208)];console[_0x15adb5(0x1b7)]('ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x3ef366);const _0x2cff66=await database_1[_0x15adb5(0x1ed)][_0x15adb5(0x1e1)][_0x15adb5(0x1d9)]({'where':{'id':_0x3ef366},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2cff66)return _0x4a3bdb[_0x15adb5(0x1f5)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x2cff66[_0x15adb5(0x1f6)]!==_0x15adb5(0x1f0))return _0x4a3bdb[_0x15adb5(0x1f5)](0x190)['json']({'success':![],'message':_0x15adb5(0x203)});if(_0x2cff66[_0x15adb5(0x1f5)]!==_0x15adb5(0x1d6))return _0x4a3bdb[_0x15adb5(0x1f5)](0x190)[_0x15adb5(0x1ce)]({'success':![],'message':_0x15adb5(0x1c3)+_0x2cff66[_0x15adb5(0x1f5)]+',\x20cannot\x20process'});const _0x1d1cc5=await this[_0x15adb5(0x1dc)][_0x15adb5(0x1c1)]({'paymentId':_0x2cff66['id'],'orderId':_0x2cff66[_0x15adb5(0x201)]||_0x2cff66['id'],'amount':_0x2cff66[_0x15adb5(0x1ad)],'currency':_0x2cff66[_0x15adb5(0x20d)],'cardData':_0x32c993});console[_0x15adb5(0x1b7)](_0x15adb5(0x1b8),_0x1d1cc5);const _0x47cb8c={'status':_0x1d1cc5[_0x15adb5(0x1f5)],'updatedAt':new Date()};if(_0x1d1cc5[_0x15adb5(0x1f5)]===_0x15adb5(0x20b))_0x47cb8c[_0x15adb5(0x20c)]=new Date(),_0x47cb8c['gatewayPaymentId']=_0x1d1cc5[_0x15adb5(0x1cf)];else _0x1d1cc5[_0x15adb5(0x1f5)]==='FAILED'&&(_0x47cb8c[_0x15adb5(0x1ca)]=_0x1d1cc5['failureReason']);const _0x105901=_0x32c993[_0x15adb5(0x215)][_0x15adb5(0x1f7)](/[\s-]/g,'');_0x47cb8c[_0x15adb5(0x214)]=_0x105901['slice'](-0x4),_0x47cb8c[_0x15adb5(0x1ef)]=_0x15adb5(0x1fe),await database_1[_0x15adb5(0x1ed)][_0x15adb5(0x1e1)][_0x15adb5(0x1ee)]({'where':{'id':_0x2cff66['id']},'data':_0x47cb8c}),await database_1[_0x15adb5(0x1ed)]['webhookLog'][_0x15adb5(0x1bb)]({'data':{'paymentId':_0x2cff66['id'],'shopId':_0x2cff66[_0x15adb5(0x1e0)],'event':_0x15adb5(0x1f8)+_0x1d1cc5[_0x15adb5(0x1f5)][_0x15adb5(0x1f9)](),'statusCode':0xc8,'responseBody':JSON[_0x15adb5(0x206)]({'oldStatus':_0x15adb5(0x1d6),'newStatus':_0x1d1cc5[_0x15adb5(0x1f5)],'transactionId':_0x1d1cc5[_0x15adb5(0x1cf)],'failureReason':_0x1d1cc5['failureReason'],'processedAt':new Date()[_0x15adb5(0x212)]()})}}),await this['sendShopWebhook'](_0x2cff66,_0x1d1cc5[_0x15adb5(0x1f5)],_0x1d1cc5[_0x15adb5(0x1cf)],_0x1d1cc5[_0x15adb5(0x1b5)]),await this[_0x15adb5(0x1fb)](_0x2cff66,_0x1d1cc5['status']),console[_0x15adb5(0x1b7)](_0x15adb5(0x1c5)+_0x3ef366+_0x15adb5(0x1d3)+_0x1d1cc5[_0x15adb5(0x1f5)]),_0x1d1cc5[_0x15adb5(0x1f5)]===_0x15adb5(0x20b)?_0x4a3bdb[_0x15adb5(0x1ce)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x15adb5(0x20b),'transactionId':_0x1d1cc5[_0x15adb5(0x1cf)],'redirectUrl':_0x2cff66[_0x15adb5(0x1e7)]}}):_0x4a3bdb['status'](0x190)[_0x15adb5(0x1ce)]({'success':![],'message':_0x15adb5(0x1bc),'result':{'status':_0x15adb5(0x1f3),'failureReason':_0x1d1cc5[_0x15adb5(0x1b5)],'redirectUrl':_0x2cff66[_0x15adb5(0x1f2)]}});}catch(_0xc9edd7){_0x53e16a(_0xc9edd7);}},this['testGatewayService']=new testGatewayService_1[(_0x5056e1(0x1df))](),this[_0x5056e1(0x1b6)]=new webhookService_1[(_0x5056e1(0x1d8))]();}async['sendShopWebhook'](_0x379a80,_0x73f989,_0x539315,_0x2afa60){const _0x676896=a13_0x5b0b32,_0x56ad81=Date[_0x676896(0x213)]();try{const _0x1398a1=_0x379a80[_0x676896(0x1fa)],_0x281966=_0x1398a1[_0x676896(0x1d1)];if(!_0x281966?.[_0x676896(0x1cc)]){console[_0x676896(0x1b7)](_0x676896(0x1cd)+_0x1398a1['id']);return;}const _0x3db0d1=_0x73f989==='PAID'?'payment.success':'payment.failed';let _0x51512e=[];if(_0x281966['webhookEvents'])try{_0x51512e=Array[_0x676896(0x202)](_0x281966[_0x676896(0x1b4)])?_0x281966[_0x676896(0x1b4)]:JSON['parse'](_0x281966[_0x676896(0x1b4)]);}catch(_0x5ed43f){console['error'](_0x676896(0x205),_0x5ed43f),_0x51512e=[];}if(!_0x51512e[_0x676896(0x1be)](_0x3db0d1)){console['log'](_0x676896(0x1c6)+_0x3db0d1+_0x676896(0x1dd)+_0x1398a1['id']);return;}const _0x83f8de={'event':_0x3db0d1,'payment':{'id':_0x379a80['id'],'order_id':_0x379a80['orderId'],'gateway_order_id':_0x379a80[_0x676896(0x201)],'gateway':'0000','amount':_0x379a80['amount'],'currency':_0x379a80['currency'],'status':_0x73f989[_0x676896(0x1f9)](),'customer_email':_0x379a80[_0x676896(0x1d4)],'customer_name':_0x379a80[_0x676896(0x1e2)],'transaction_id':_0x539315,'failure_message':_0x2afa60,'created_at':_0x379a80[_0x676896(0x1bd)],'updated_at':new Date()}},_0x8772d6=await fetch(_0x281966['webhookUrl'],{'method':_0x676896(0x1d7),'headers':{'Content-Type':'application/json','User-Agent':_0x676896(0x1e9)},'body':JSON[_0x676896(0x206)](_0x83f8de)}),_0x225c0f=Date[_0x676896(0x213)]()-_0x56ad81;console[_0x676896(0x1b7)](_0x676896(0x1c2)+_0x281966['webhookUrl']+_0x676896(0x1fd)+_0x8772d6['status']+'\x20('+_0x225c0f+'ms)');}catch(_0x2a4d4d){console[_0x676896(0x1d2)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x2a4d4d);}}async[a13_0x5b0b32(0x1fb)](_0x4ddb81,_0x44164d){const _0xd8ddc=a13_0x5b0b32;try{const {telegramBotService:_0x3ea088}=await Promise['resolve']()['then'](()=>__importStar(require(_0xd8ddc(0x20f)))),_0x3bfcde={'PAID':_0xd8ddc(0x1e3),'FAILED':_0xd8ddc(0x1ec)},_0x26d4ad=_0x3bfcde[_0x44164d];if(!_0x26d4ad)return;await _0x3ea088[_0xd8ddc(0x1cb)](_0x4ddb81[_0xd8ddc(0x1e0)],_0x4ddb81,_0x26d4ad);}catch(_0x8a5cd8){console[_0xd8ddc(0x1d2)](_0xd8ddc(0x1ff),_0x8a5cd8);}}}exports[a13_0x5b0b32(0x1b2)]=TestGatewayController;function a13_0x5627(){const _0x2c2bd8=['createdAt','includes','6gGQLus','281419HyRoSU','processCardPayment','Test\x20Gateway\x20webhook\x20sent\x20to\x20','Payment\x20status\x20is\x20','3974148CLWfXz','âœ…\x20Test\x20Gateway\x20payment\x20','Webhook\x20event\x20','73878Joagad','Any\x20other\x20card\x20number','params','failureMessage','sendPaymentNotification','webhookUrl','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','json','transactionId','Any\x20name','settings','error','\x20processed:\x20','customerEmail','defineProperty','PENDING','POST','WebhookService','findUnique','__createBinding','writable','testGatewayService','\x20not\x20enabled\x20for\x20shop\x20','configurable','TestGatewayService','shopId','payment','customerName','paid','80xshuMv','Payment\x20not\x20found','getOwnPropertyNames','successUrl','call','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','Payment\x20to\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failed','default','update','paymentMethod','test_gateway','1497339wKYPRK','failUrl','FAILED','Any\x20future\x20date\x20(MM/YY)','status','gateway','replace','test_gateway_','toLowerCase','shop','sendPaymentStatusNotification','1074485OXeNqW','\x20with\x20status\x20','test_card','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processCard','gatewayOrderId','isArray','Payment\x20is\x20not\x20for\x20test\x20gateway',',\x20cannot\x20process','Error\x20parsing\x20webhook\x20events:','stringify','__setModuleDefault','body','getPaymentForm','__esModule','PAID','paidAt','currency','length','../services/telegramBotService','42819IyIZiE','__importStar','toISOString','now','cardLast4','cardNumber','amount','6502340ACEpYV','Any\x203-4\x20digits','get','4242\x204242\x204242\x204242','TestGatewayController','__importDefault','webhookEvents','failureReason','webhookService','log','ðŸ§ª\x20Test\x20Gateway\x20result:','name','4xSGEEn','create','Payment\x20failed'];a13_0x5627=function(){return _0x2c2bd8;};return a13_0x5627();}