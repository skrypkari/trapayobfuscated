'use strict';function a13_0x5834(){const _0x2609a0=['name','sendShopWebhook','\x20with\x20status\x20','hasOwnProperty','replace','parse','stringify','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','transactionId','cardNumber','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Any\x20name','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','FAILED','failed','54TjHuyK','5KcdluZ','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','status','Payment\x20failed','\x20processed:\x20','failureReason','1WKnMBb','PAID','successUrl','paymentMethod','gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','8AlqmSY','PENDING','../services/telegramBotService','Any\x203-4\x20digits','TestGatewayService','create','\x20not\x20enabled\x20for\x20shop\x20','test_gateway_','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','80481OuzJJA','Payment\x20not\x20found','length','orderId','173593Kkffvx','Payment\x20processed\x20successfully','webhookUrl','__importStar','call','findUnique','âœ…\x20Test\x20Gateway\x20payment\x20','customerEmail','writable','shop','resolve','default','getPaymentForm','payment.failed','sendPaymentNotification','../services/gateways/testGatewayService','error','getOwnPropertyNames','json','getOwnPropertyDescriptor','978534DErepj','defineProperty','473993XvNmje','amount','sendPaymentStatusNotification','slice','WebhookService','ms)','Any\x20future\x20date\x20(MM/YY)','isArray','test_gateway','__esModule','shopId','createdAt','failureMessage','__setModuleDefault','gatewayOrderId','TestGatewayController','35740lTeQyh','then','includes','params','11vCdUtc','toLowerCase','Test\x20Gateway\x20webhook\x20sent\x20to\x20','update','customerName','now','get','Error\x20parsing\x20webhook\x20events:','ðŸ§ª\x20Test\x20Gateway\x20result:','2666364kUqchO','110712mVISTt','64MFmYBo','../services/webhookService','settings','webhookEvents','gatewayPaymentId','Payment\x20to\x20','Any\x20other\x20card\x20number','Payment\x20status\x20is\x20','prototype','toISOString','body','webhookService','log','paid','payment.success','failUrl','currency','testGatewayService',',\x20cannot\x20process'];a13_0x5834=function(){return _0x2609a0;};return a13_0x5834();}function a13_0x2301(_0x25b2f6,_0x34a08a){const _0x58342a=a13_0x5834();return a13_0x2301=function(_0x230156,_0x4699b5){_0x230156=_0x230156-0x194;let _0x38ce6a=_0x58342a[_0x230156];return _0x38ce6a;},a13_0x2301(_0x25b2f6,_0x34a08a);}const a13_0x3e5007=a13_0x2301;(function(_0x16724f,_0x51d774){const _0x1c12c5=a13_0x2301,_0x1231bf=_0x16724f();while(!![]){try{const _0x8e0e22=parseInt(_0x1c12c5(0x1ea))/0x1*(parseInt(_0x1c12c5(0x1c0))/0x2)+parseInt(_0x1c12c5(0x1f9))/0x3*(-parseInt(_0x1c12c5(0x1f0))/0x4)+-parseInt(_0x1c12c5(0x1e4))/0x5*(-parseInt(_0x1c12c5(0x1a0))/0x6)+-parseInt(_0x1c12c5(0x1fd))/0x7*(parseInt(_0x1c12c5(0x1c1))/0x8)+-parseInt(_0x1c12c5(0x1e3))/0x9*(parseInt(_0x1c12c5(0x1b2))/0xa)+-parseInt(_0x1c12c5(0x1b6))/0xb*(-parseInt(_0x1c12c5(0x1bf))/0xc)+-parseInt(_0x1c12c5(0x1a2))/0xd;if(_0x8e0e22===_0x51d774)break;else _0x1231bf['push'](_0x1231bf['shift']());}catch(_0x12efc6){_0x1231bf['push'](_0x1231bf['shift']());}}}(a13_0x5834,0x1fe83));var __createBinding=this&&this['__createBinding']||(Object[a13_0x3e5007(0x1f5)]?function(_0x269cf3,_0x48ad32,_0x8cb161,_0x49ca5f){const _0x16a19d=a13_0x3e5007;if(_0x49ca5f===undefined)_0x49ca5f=_0x8cb161;var _0x139e06=Object[_0x16a19d(0x19f)](_0x48ad32,_0x8cb161);(!_0x139e06||(_0x16a19d(0x1bc)in _0x139e06?!_0x48ad32['__esModule']:_0x139e06[_0x16a19d(0x194)]||_0x139e06['configurable']))&&(_0x139e06={'enumerable':!![],'get':function(){return _0x48ad32[_0x8cb161];}}),Object[_0x16a19d(0x1a1)](_0x269cf3,_0x49ca5f,_0x139e06);}:function(_0x13e2ed,_0x4f6535,_0x4e1665,_0x1a010b){if(_0x1a010b===undefined)_0x1a010b=_0x4e1665;_0x13e2ed[_0x1a010b]=_0x4f6535[_0x4e1665];}),__setModuleDefault=this&&this[a13_0x3e5007(0x1af)]||(Object[a13_0x3e5007(0x1f5)]?function(_0x3a2268,_0x556684){const _0x378360=a13_0x3e5007;Object[_0x378360(0x1a1)](_0x3a2268,_0x378360(0x197),{'enumerable':!![],'value':_0x556684});}:function(_0x85f595,_0x708632){const _0x468204=a13_0x3e5007;_0x85f595[_0x468204(0x197)]=_0x708632;}),__importStar=this&&this[a13_0x3e5007(0x200)]||(function(){var _0x3b420e=function(_0x1476c8){const _0x3c3bda=a13_0x2301;return _0x3b420e=Object[_0x3c3bda(0x19d)]||function(_0x36f331){const _0x5a6f93=_0x3c3bda;var _0x1f317a=[];for(var _0x1b3a42 in _0x36f331)if(Object[_0x5a6f93(0x1c9)][_0x5a6f93(0x1d7)][_0x5a6f93(0x201)](_0x36f331,_0x1b3a42))_0x1f317a[_0x1f317a[_0x5a6f93(0x1fb)]]=_0x1b3a42;return _0x1f317a;},_0x3b420e(_0x1476c8);};return function(_0x189e08){const _0x41ba51=a13_0x2301;if(_0x189e08&&_0x189e08[_0x41ba51(0x1ab)])return _0x189e08;var _0x4a74f8={};if(_0x189e08!=null){for(var _0x248979=_0x3b420e(_0x189e08),_0x981684=0x0;_0x981684<_0x248979[_0x41ba51(0x1fb)];_0x981684++)if(_0x248979[_0x981684]!==_0x41ba51(0x197))__createBinding(_0x4a74f8,_0x189e08,_0x248979[_0x981684]);}return __setModuleDefault(_0x4a74f8,_0x189e08),_0x4a74f8;};}()),__importDefault=this&&this['__importDefault']||function(_0x70ebc2){const _0x222139=a13_0x3e5007;return _0x70ebc2&&_0x70ebc2[_0x222139(0x1ab)]?_0x70ebc2:{'default':_0x70ebc2};};Object['defineProperty'](exports,a13_0x3e5007(0x1ab),{'value':!![]}),exports[a13_0x3e5007(0x1b1)]=void 0x0;const testGatewayService_1=require(a13_0x3e5007(0x19b)),webhookService_1=require(a13_0x3e5007(0x1c2)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x50877c=a13_0x3e5007;this[_0x50877c(0x198)]=async(_0x3a65ee,_0x4bfd7a,_0xff1ccb)=>{const _0x1f8115=_0x50877c;try{const {paymentId:_0x295c38}=_0x3a65ee[_0x1f8115(0x1b5)];console[_0x1f8115(0x1cd)](_0x1f8115(0x1e5)+_0x295c38);const _0x492311=await database_1['default']['payment'][_0x1f8115(0x202)]({'where':{'id':_0x295c38},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x492311)return _0x4bfd7a[_0x1f8115(0x1e6)](0x194)[_0x1f8115(0x19e)]({'success':![],'message':_0x1f8115(0x1fa)});if(_0x492311[_0x1f8115(0x1ee)]!==_0x1f8115(0x1aa))return _0x4bfd7a[_0x1f8115(0x1e6)](0x190)[_0x1f8115(0x19e)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x492311[_0x1f8115(0x1e6)]!==_0x1f8115(0x1f1))return _0x4bfd7a[_0x1f8115(0x1e6)](0x190)[_0x1f8115(0x19e)]({'success':![],'message':_0x1f8115(0x1c8)+_0x492311[_0x1f8115(0x1e6)]+',\x20cannot\x20process'});_0x4bfd7a[_0x1f8115(0x19e)]({'success':!![],'result':{'paymentId':_0x492311['id'],'orderId':_0x492311[_0x1f8115(0x1b0)],'amount':_0x492311[_0x1f8115(0x1a3)],'currency':_0x492311[_0x1f8115(0x1d1)],'merchantName':_0x492311['shop'][_0x1f8115(0x1d4)],'description':_0x1f8115(0x1c6)+_0x492311['shop'][_0x1f8115(0x1d4)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x1f8115(0x1c7),'expiryDate':_0x1f8115(0x1a8),'cvc':_0x1f8115(0x1f3),'holderName':_0x1f8115(0x1df)}}});}catch(_0x1736f3){_0xff1ccb(_0x1736f3);}},this['processCard']=async(_0x5a23db,_0x3d25e5,_0x7515be)=>{const _0x54740a=_0x50877c;try{const {paymentId:_0x4a8844}=_0x5a23db[_0x54740a(0x1b5)],_0x38bedc=_0x5a23db[_0x54740a(0x1cb)];console['log'](_0x54740a(0x1e0)+_0x4a8844);const _0xe207=await database_1[_0x54740a(0x197)]['payment'][_0x54740a(0x202)]({'where':{'id':_0x4a8844},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe207)return _0x3d25e5[_0x54740a(0x1e6)](0x194)['json']({'success':![],'message':_0x54740a(0x1fa)});if(_0xe207[_0x54740a(0x1ee)]!==_0x54740a(0x1aa))return _0x3d25e5[_0x54740a(0x1e6)](0x190)[_0x54740a(0x19e)]({'success':![],'message':_0x54740a(0x1ef)});if(_0xe207['status']!==_0x54740a(0x1f1))return _0x3d25e5['status'](0x190)['json']({'success':![],'message':_0x54740a(0x1c8)+_0xe207['status']+_0x54740a(0x1d3)});const _0x48ab02=await this[_0x54740a(0x1d2)]['processCardPayment']({'paymentId':_0xe207['id'],'orderId':_0xe207[_0x54740a(0x1b0)]||_0xe207['id'],'amount':_0xe207[_0x54740a(0x1a3)],'currency':_0xe207[_0x54740a(0x1d1)],'cardData':_0x38bedc});console[_0x54740a(0x1cd)](_0x54740a(0x1be),_0x48ab02);const _0x308093={'status':_0x48ab02[_0x54740a(0x1e6)],'updatedAt':new Date()};if(_0x48ab02[_0x54740a(0x1e6)]==='PAID')_0x308093['paidAt']=new Date(),_0x308093[_0x54740a(0x1c5)]=_0x48ab02[_0x54740a(0x1dc)];else _0x48ab02['status']===_0x54740a(0x1e1)&&(_0x308093[_0x54740a(0x1ae)]=_0x48ab02['failureReason']);const _0x23dd2c=_0x38bedc[_0x54740a(0x1dd)][_0x54740a(0x1d8)](/[\s-]/g,'');_0x308093['cardLast4']=_0x23dd2c[_0x54740a(0x1a5)](-0x4),_0x308093[_0x54740a(0x1ed)]='test_card',await database_1['default']['payment'][_0x54740a(0x1b9)]({'where':{'id':_0xe207['id']},'data':_0x308093}),await database_1[_0x54740a(0x197)]['webhookLog'][_0x54740a(0x1f5)]({'data':{'paymentId':_0xe207['id'],'shopId':_0xe207[_0x54740a(0x1ac)],'event':_0x54740a(0x1f7)+_0x48ab02[_0x54740a(0x1e6)][_0x54740a(0x1b7)](),'statusCode':0xc8,'responseBody':JSON[_0x54740a(0x1da)]({'oldStatus':_0x54740a(0x1f1),'newStatus':_0x48ab02[_0x54740a(0x1e6)],'transactionId':_0x48ab02['transactionId'],'failureReason':_0x48ab02[_0x54740a(0x1e9)],'processedAt':new Date()[_0x54740a(0x1ca)]()})}}),await this[_0x54740a(0x1d5)](_0xe207,_0x48ab02['status'],_0x48ab02[_0x54740a(0x1dc)],_0x48ab02[_0x54740a(0x1e9)]),await this['sendPaymentStatusNotification'](_0xe207,_0x48ab02[_0x54740a(0x1e6)]),console[_0x54740a(0x1cd)](_0x54740a(0x203)+_0x4a8844+_0x54740a(0x1e8)+_0x48ab02[_0x54740a(0x1e6)]),_0x48ab02['status']===_0x54740a(0x1eb)?_0x3d25e5[_0x54740a(0x19e)]({'success':!![],'message':_0x54740a(0x1fe),'result':{'status':_0x54740a(0x1eb),'transactionId':_0x48ab02[_0x54740a(0x1dc)],'redirectUrl':_0xe207[_0x54740a(0x1ec)]}}):_0x3d25e5[_0x54740a(0x1e6)](0x190)[_0x54740a(0x19e)]({'success':![],'message':_0x54740a(0x1e7),'result':{'status':_0x54740a(0x1e1),'failureReason':_0x48ab02['failureReason'],'redirectUrl':_0xe207[_0x54740a(0x1d0)]}});}catch(_0x4b1016){_0x7515be(_0x4b1016);}},this[_0x50877c(0x1d2)]=new testGatewayService_1[(_0x50877c(0x1f4))](),this[_0x50877c(0x1cc)]=new webhookService_1[(_0x50877c(0x1a6))]();}async[a13_0x3e5007(0x1d5)](_0x64eb8f,_0x3b5196,_0x26847a,_0x3a1fc0){const _0x203f37=a13_0x3e5007,_0x478660=Date[_0x203f37(0x1bb)]();try{const _0x4c3a43=_0x64eb8f[_0x203f37(0x195)],_0x18b338=_0x4c3a43[_0x203f37(0x1c3)];if(!_0x18b338?.[_0x203f37(0x1ff)]){console['log'](_0x203f37(0x1de)+_0x4c3a43['id']);return;}const _0x4d04c3=_0x3b5196===_0x203f37(0x1eb)?_0x203f37(0x1cf):_0x203f37(0x199);let _0x42c290=[];if(_0x18b338[_0x203f37(0x1c4)])try{_0x42c290=Array[_0x203f37(0x1a9)](_0x18b338['webhookEvents'])?_0x18b338[_0x203f37(0x1c4)]:JSON[_0x203f37(0x1d9)](_0x18b338[_0x203f37(0x1c4)]);}catch(_0x29859d){console[_0x203f37(0x19c)](_0x203f37(0x1bd),_0x29859d),_0x42c290=[];}if(!_0x42c290[_0x203f37(0x1b4)](_0x4d04c3)){console[_0x203f37(0x1cd)]('Webhook\x20event\x20'+_0x4d04c3+_0x203f37(0x1f6)+_0x4c3a43['id']);return;}const _0x5e9a35={'event':_0x4d04c3,'payment':{'id':_0x64eb8f['id'],'order_id':_0x64eb8f[_0x203f37(0x1fc)],'gateway_order_id':_0x64eb8f[_0x203f37(0x1b0)],'gateway':'0000','amount':_0x64eb8f['amount'],'currency':_0x64eb8f[_0x203f37(0x1d1)],'status':_0x3b5196[_0x203f37(0x1b7)](),'customer_email':_0x64eb8f[_0x203f37(0x204)],'customer_name':_0x64eb8f[_0x203f37(0x1ba)],'transaction_id':_0x26847a,'failure_message':_0x3a1fc0,'created_at':_0x64eb8f[_0x203f37(0x1ad)],'updated_at':new Date()}},_0x3ad683=await fetch(_0x18b338[_0x203f37(0x1ff)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON[_0x203f37(0x1da)](_0x5e9a35)}),_0x337f5a=Date[_0x203f37(0x1bb)]()-_0x478660;console[_0x203f37(0x1cd)](_0x203f37(0x1b8)+_0x18b338[_0x203f37(0x1ff)]+_0x203f37(0x1d6)+_0x3ad683['status']+'\x20('+_0x337f5a+_0x203f37(0x1a7));}catch(_0x4cc480){console[_0x203f37(0x19c)](_0x203f37(0x1f8),_0x4cc480);}}async[a13_0x3e5007(0x1a4)](_0x4287e1,_0x2958b1){const _0x1981ff=a13_0x3e5007;try{const {telegramBotService:_0x75c525}=await Promise[_0x1981ff(0x196)]()[_0x1981ff(0x1b3)](()=>__importStar(require(_0x1981ff(0x1f2)))),_0x12a804={'PAID':_0x1981ff(0x1ce),'FAILED':_0x1981ff(0x1e2)},_0x4e4d33=_0x12a804[_0x2958b1];if(!_0x4e4d33)return;await _0x75c525[_0x1981ff(0x19a)](_0x4287e1[_0x1981ff(0x1ac)],_0x4287e1,_0x4e4d33);}catch(_0x4b306a){console[_0x1981ff(0x19c)](_0x1981ff(0x1db),_0x4b306a);}}}exports[a13_0x3e5007(0x1b1)]=TestGatewayController;