'use strict';const a19_0x5360ec=a19_0x2959;(function(_0x331f2c,_0x4ee6fc){const _0x28af98=a19_0x2959,_0x1f8ee3=_0x331f2c();while(!![]){try{const _0x18e4e4=parseInt(_0x28af98(0x17c))/0x1*(parseInt(_0x28af98(0x196))/0x2)+-parseInt(_0x28af98(0x136))/0x3*(parseInt(_0x28af98(0x1a3))/0x4)+parseInt(_0x28af98(0x191))/0x5*(parseInt(_0x28af98(0x15f))/0x6)+parseInt(_0x28af98(0x12b))/0x7*(parseInt(_0x28af98(0x193))/0x8)+-parseInt(_0x28af98(0x156))/0x9+parseInt(_0x28af98(0x195))/0xa+parseInt(_0x28af98(0x12a))/0xb*(-parseInt(_0x28af98(0x18f))/0xc);if(_0x18e4e4===_0x4ee6fc)break;else _0x1f8ee3['push'](_0x1f8ee3['shift']());}catch(_0xd9e07e){_0x1f8ee3['push'](_0x1f8ee3['shift']());}}}(a19_0x19a6,0x2e106));function a19_0x2959(_0x16253d,_0x366d2d){_0x16253d=_0x16253d-0x12a;const _0x19a67f=a19_0x19a6();let _0x2959c3=_0x19a67f[_0x16253d];return _0x2959c3;}var __createBinding=this&&this[a19_0x5360ec(0x144)]||(Object[a19_0x5360ec(0x179)]?function(_0xdae97,_0x153684,_0x3f96bb,_0x45565a){const _0x9df21b=a19_0x5360ec;if(_0x45565a===undefined)_0x45565a=_0x3f96bb;var _0x80c8cd=Object[_0x9df21b(0x160)](_0x153684,_0x3f96bb);(!_0x80c8cd||('get'in _0x80c8cd?!_0x153684[_0x9df21b(0x15d)]:_0x80c8cd['writable']||_0x80c8cd[_0x9df21b(0x197)]))&&(_0x80c8cd={'enumerable':!![],'get':function(){return _0x153684[_0x3f96bb];}}),Object[_0x9df21b(0x162)](_0xdae97,_0x45565a,_0x80c8cd);}:function(_0x5700aa,_0x49b1bf,_0x4cdabd,_0x37b1ec){if(_0x37b1ec===undefined)_0x37b1ec=_0x4cdabd;_0x5700aa[_0x37b1ec]=_0x49b1bf[_0x4cdabd];}),__setModuleDefault=this&&this[a19_0x5360ec(0x14b)]||(Object[a19_0x5360ec(0x179)]?function(_0x4a8e90,_0x2ca4fd){const _0x364bf2=a19_0x5360ec;Object['defineProperty'](_0x4a8e90,_0x364bf2(0x15b),{'enumerable':!![],'value':_0x2ca4fd});}:function(_0xd31fd3,_0x8e15a3){const _0x5f50ef=a19_0x5360ec;_0xd31fd3[_0x5f50ef(0x15b)]=_0x8e15a3;}),__importStar=this&&this[a19_0x5360ec(0x178)]||(function(){var _0x275b06=function(_0x55675d){const _0x4989dc=a19_0x2959;return _0x275b06=Object[_0x4989dc(0x148)]||function(_0x203f33){const _0x24b998=_0x4989dc;var _0x269a15=[];for(var _0x25f8b5 in _0x203f33)if(Object[_0x24b998(0x188)]['hasOwnProperty'][_0x24b998(0x15e)](_0x203f33,_0x25f8b5))_0x269a15[_0x269a15['length']]=_0x25f8b5;return _0x269a15;},_0x275b06(_0x55675d);};return function(_0x121745){const _0x2265f6=a19_0x2959;if(_0x121745&&_0x121745[_0x2265f6(0x15d)])return _0x121745;var _0x3be35e={};if(_0x121745!=null){for(var _0x4d5df5=_0x275b06(_0x121745),_0x5dc884=0x0;_0x5dc884<_0x4d5df5[_0x2265f6(0x163)];_0x5dc884++)if(_0x4d5df5[_0x5dc884]!=='default')__createBinding(_0x3be35e,_0x121745,_0x4d5df5[_0x5dc884]);}return __setModuleDefault(_0x3be35e,_0x121745),_0x3be35e;};}()),__importDefault=this&&this['__importDefault']||function(_0x5ea301){return _0x5ea301&&_0x5ea301['__esModule']?_0x5ea301:{'default':_0x5ea301};};Object[a19_0x5360ec(0x162)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a19_0x5360ec(0x133)),webhookService_1=require(a19_0x5360ec(0x149)),database_1=__importDefault(require('../config/database'));class TestGatewayController{constructor(){const _0x2ca324=a19_0x5360ec;this[_0x2ca324(0x137)]=async(_0x183823,_0x28fc50,_0x2bc56e)=>{const _0xecda0f=_0x2ca324;try{const {paymentId:_0x5ddc58}=_0x183823['params'];console[_0xecda0f(0x19c)](_0xecda0f(0x140)+_0x5ddc58);const _0x177f75=await database_1['default']['payment'][_0xecda0f(0x157)]({'where':{'id':_0x5ddc58},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x177f75)return _0x28fc50[_0xecda0f(0x145)](0x194)[_0xecda0f(0x165)]({'success':![],'message':_0xecda0f(0x172)});if(_0x177f75['gateway']!=='test_gateway')return _0x28fc50['status'](0x190)[_0xecda0f(0x165)]({'success':![],'message':_0xecda0f(0x13d)});if(_0x177f75[_0xecda0f(0x145)]!==_0xecda0f(0x185))return _0x28fc50[_0xecda0f(0x145)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x177f75['status']+_0xecda0f(0x16d)});_0x28fc50['json']({'success':!![],'result':{'paymentId':_0x177f75['id'],'orderId':_0x177f75['gatewayOrderId'],'amount':_0x177f75[_0xecda0f(0x14a)],'currency':_0x177f75['currency'],'merchantName':_0x177f75[_0xecda0f(0x1a2)]['name'],'description':'Payment\x20to\x20'+_0x177f75[_0xecda0f(0x1a2)][_0xecda0f(0x14e)],'testInstructions':{'successCard':_0xecda0f(0x14f),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0xecda0f(0x176),'holderName':_0xecda0f(0x1a1)}}});}catch(_0x41f3cc){_0x2bc56e(_0x41f3cc);}},this[_0x2ca324(0x18e)]=async(_0x469b89,_0x2929cf,_0x135dd3)=>{const _0x2cd751=_0x2ca324;try{const {paymentId:_0x575130}=_0x469b89[_0x2cd751(0x19b)],_0x40e923=_0x469b89[_0x2cd751(0x146)];console[_0x2cd751(0x19c)](_0x2cd751(0x18c)+_0x575130);const _0x2a6d9e=await database_1[_0x2cd751(0x15b)][_0x2cd751(0x143)][_0x2cd751(0x157)]({'where':{'id':_0x575130},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2a6d9e)return _0x2929cf[_0x2cd751(0x145)](0x194)[_0x2cd751(0x165)]({'success':![],'message':_0x2cd751(0x172)});if(_0x2a6d9e[_0x2cd751(0x174)]!=='test_gateway')return _0x2929cf[_0x2cd751(0x145)](0x190)[_0x2cd751(0x165)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x2a6d9e[_0x2cd751(0x145)]!==_0x2cd751(0x185))return _0x2929cf[_0x2cd751(0x145)](0x190)[_0x2cd751(0x165)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2a6d9e['status']+_0x2cd751(0x16d)});const _0x2dd246=await this[_0x2cd751(0x138)][_0x2cd751(0x186)]({'paymentId':_0x2a6d9e['id'],'orderId':_0x2a6d9e[_0x2cd751(0x17a)]||_0x2a6d9e['id'],'amount':_0x2a6d9e[_0x2cd751(0x14a)],'currency':_0x2a6d9e[_0x2cd751(0x13e)],'cardData':_0x40e923});console[_0x2cd751(0x19c)](_0x2cd751(0x154),_0x2dd246);const _0x1c0bf2={'status':_0x2dd246[_0x2cd751(0x145)],'updatedAt':new Date()};if(_0x2dd246[_0x2cd751(0x145)]==='PAID')_0x1c0bf2[_0x2cd751(0x1a6)]=new Date(),_0x1c0bf2[_0x2cd751(0x19e)]=_0x2dd246['transactionId'];else _0x2dd246[_0x2cd751(0x145)]===_0x2cd751(0x12c)&&(_0x1c0bf2[_0x2cd751(0x161)]=_0x2dd246[_0x2cd751(0x171)]);const _0x93c39=_0x40e923['cardNumber'][_0x2cd751(0x16c)](/[\s-]/g,'');_0x1c0bf2['cardLast4']=_0x93c39[_0x2cd751(0x153)](-0x4),_0x1c0bf2[_0x2cd751(0x147)]=_0x2cd751(0x180),await database_1[_0x2cd751(0x15b)][_0x2cd751(0x143)][_0x2cd751(0x16e)]({'where':{'id':_0x2a6d9e['id']},'data':_0x1c0bf2});if(_0x2dd246[_0x2cd751(0x145)]===_0x2cd751(0x166)&&_0x2a6d9e[_0x2cd751(0x130)]){console[_0x2cd751(0x19c)](_0x2cd751(0x141)+_0x2a6d9e['id']+_0x2cd751(0x15a));try{await database_1[_0x2cd751(0x15b)][_0x2cd751(0x1a7)](async _0x24240f=>{const _0x5a0485=_0x2cd751,_0x4dc675=await _0x24240f[_0x5a0485(0x150)][_0x5a0485(0x157)]({'where':{'id':_0x2a6d9e[_0x5a0485(0x130)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x4dc675){console[_0x5a0485(0x19c)](_0x5a0485(0x139)+_0x4dc675['id']+_0x5a0485(0x184)+_0x4dc675['type']+_0x5a0485(0x173)+_0x4dc675[_0x5a0485(0x14d)]+',\x20status='+_0x4dc675['status']);const _0x539534=_0x4dc675[_0x5a0485(0x14d)]+0x1,_0x5669fb=_0x4dc675[_0x5a0485(0x19a)]===_0x5a0485(0x1a5)?'COMPLETED':_0x4dc675[_0x5a0485(0x145)];await _0x24240f[_0x5a0485(0x150)]['update']({'where':{'id':_0x2a6d9e[_0x5a0485(0x130)]},'data':{'currentPayments':_0x539534,'status':_0x5669fb,'updatedAt':new Date()}}),console[_0x5a0485(0x19c)](_0x5a0485(0x18b)+_0x4dc675['id']+_0x5a0485(0x198)+_0x4dc675[_0x5a0485(0x14d)]+_0x5a0485(0x190)+_0x539534+_0x5a0485(0x16b)+_0x4dc675['status']+'\x20->\x20'+_0x5669fb);}else console[_0x5a0485(0x19c)](_0x5a0485(0x13f)+_0x2a6d9e[_0x5a0485(0x130)]+_0x5a0485(0x194));});}catch(_0x43841c){console[_0x2cd751(0x170)](_0x2cd751(0x155),_0x43841c);}}await database_1[_0x2cd751(0x15b)][_0x2cd751(0x164)][_0x2cd751(0x179)]({'data':{'paymentId':_0x2a6d9e['id'],'shopId':_0x2a6d9e['shopId'],'event':_0x2cd751(0x12f)+_0x2dd246[_0x2cd751(0x145)][_0x2cd751(0x135)](),'statusCode':0xc8,'responseBody':JSON[_0x2cd751(0x13b)]({'oldStatus':'PENDING','newStatus':_0x2dd246[_0x2cd751(0x145)],'transactionId':_0x2dd246['transactionId'],'failureReason':_0x2dd246['failureReason'],'processedAt':new Date()[_0x2cd751(0x199)]()})}}),await this[_0x2cd751(0x18d)](_0x2a6d9e,_0x2dd246[_0x2cd751(0x145)],_0x2dd246[_0x2cd751(0x134)],_0x2dd246[_0x2cd751(0x171)]),await this['sendPaymentStatusNotification'](_0x2a6d9e,_0x2dd246[_0x2cd751(0x145)]),console[_0x2cd751(0x19c)](_0x2cd751(0x17f)+_0x575130+_0x2cd751(0x151)+_0x2dd246[_0x2cd751(0x145)]),_0x2dd246[_0x2cd751(0x145)]==='PAID'?_0x2929cf[_0x2cd751(0x165)]({'success':!![],'message':_0x2cd751(0x175),'result':{'status':_0x2cd751(0x166),'transactionId':_0x2dd246[_0x2cd751(0x134)],'redirectUrl':_0x2a6d9e['successUrl']}}):_0x2929cf[_0x2cd751(0x145)](0x190)['json']({'success':![],'message':_0x2cd751(0x1a0),'result':{'status':_0x2cd751(0x12c),'failureReason':_0x2dd246['failureReason'],'redirectUrl':_0x2a6d9e[_0x2cd751(0x132)]}});}catch(_0x49ad73){_0x135dd3(_0x49ad73);}},this['testGatewayService']=new testGatewayService_1['TestGatewayService'](),this[_0x2ca324(0x13a)]=new webhookService_1['WebhookService']();}async[a19_0x5360ec(0x18d)](_0x3ee61b,_0x4cb495,_0x52a511,_0x4b265c){const _0x1fab60=a19_0x5360ec,_0x3e0c71=Date['now']();try{const _0x435cff=_0x3ee61b[_0x1fab60(0x1a2)],_0x376edc=_0x435cff[_0x1fab60(0x19f)];if(!_0x376edc?.[_0x1fab60(0x181)]){console[_0x1fab60(0x19c)](_0x1fab60(0x192)+_0x435cff['id']);return;}const _0x3e5192=_0x4cb495==='PAID'?_0x1fab60(0x12d):'payment.failed';let _0x427229=[];if(_0x376edc[_0x1fab60(0x19d)])try{_0x427229=Array[_0x1fab60(0x189)](_0x376edc[_0x1fab60(0x19d)])?_0x376edc['webhookEvents']:JSON['parse'](_0x376edc['webhookEvents']);}catch(_0x4b43ca){console['error'](_0x1fab60(0x167),_0x4b43ca),_0x427229=[];}if(!_0x427229['includes'](_0x3e5192)){console[_0x1fab60(0x19c)]('Webhook\x20event\x20'+_0x3e5192+_0x1fab60(0x18a)+_0x435cff['id']);return;}const _0x2549fc={'event':_0x3e5192,'payment':{'id':_0x3ee61b['id'],'order_id':_0x3ee61b[_0x1fab60(0x17b)],'gateway_order_id':_0x3ee61b[_0x1fab60(0x17a)],'gateway':_0x1fab60(0x131),'amount':_0x3ee61b['amount'],'currency':_0x3ee61b[_0x1fab60(0x13e)],'status':_0x4cb495['toLowerCase'](),'customer_email':_0x3ee61b[_0x1fab60(0x168)],'customer_name':_0x3ee61b[_0x1fab60(0x15c)],'transaction_id':_0x52a511,'failure_message':_0x4b265c,'created_at':_0x3ee61b[_0x1fab60(0x142)],'updated_at':new Date()}},_0x330c27=await fetch(_0x376edc[_0x1fab60(0x181)],{'method':_0x1fab60(0x14c),'headers':{'Content-Type':_0x1fab60(0x158),'User-Agent':_0x1fab60(0x17d)},'body':JSON['stringify'](_0x2549fc)}),_0x3c9288=Date['now']()-_0x3e0c71;console[_0x1fab60(0x19c)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x376edc[_0x1fab60(0x181)]+_0x1fab60(0x1a4)+_0x330c27[_0x1fab60(0x145)]+'\x20('+_0x3c9288+_0x1fab60(0x12e));}catch(_0xa0fa21){console[_0x1fab60(0x170)](_0x1fab60(0x152),_0xa0fa21);}}async[a19_0x5360ec(0x17e)](_0x536da3,_0x17de07){const _0x26e272=a19_0x5360ec;try{const {telegramBotService:_0x4933b1}=await Promise[_0x26e272(0x169)]()[_0x26e272(0x16f)](()=>__importStar(require(_0x26e272(0x182)))),_0x315a71={'PAID':_0x26e272(0x16a),'FAILED':_0x26e272(0x159)},_0x5eb76d=_0x315a71[_0x17de07];if(!_0x5eb76d)return;await _0x4933b1[_0x26e272(0x13c)](_0x536da3[_0x26e272(0x177)],_0x536da3,_0x5eb76d);}catch(_0x31db1e){console[_0x26e272(0x170)](_0x26e272(0x183),_0x31db1e);}}}function a19_0x19a6(){const _0x2ff46c=['toISOString','type','params','log','webhookEvents','gatewayPaymentId','settings','Payment\x20failed','Any\x20name','shop','4xHbePh','\x20with\x20status\x20','SINGLE','paidAt','$transaction','350713TwRAQW','938BRpKCK','FAILED','payment.success','ms)','test_gateway_','paymentLinkId','0000','failUrl','../services/gateways/testGatewayService','transactionId','toLowerCase','399525VNNYJi','getPaymentForm','testGatewayService','ðŸ“ˆ\x20Found\x20payment\x20link\x20','webhookService','stringify','sendPaymentNotification','Payment\x20is\x20not\x20for\x20test\x20gateway','currency','âŒ\x20Payment\x20link\x20','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','createdAt','payment','__createBinding','status','body','paymentMethod','getOwnPropertyNames','../services/webhookService','amount','__setModuleDefault','POST','currentPayments','name','4242\x204242\x204242\x204242','paymentLink','\x20processed:\x20','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','slice','ðŸ§ª\x20Test\x20Gateway\x20result:','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','2221290VBseit','findUnique','application/json','failed','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','default','customerName','__esModule','call','1410nGYmUj','getOwnPropertyDescriptor','failureMessage','defineProperty','length','webhookLog','json','PAID','Error\x20parsing\x20webhook\x20events:','customerEmail','resolve','paid',',\x20status=','replace',',\x20cannot\x20process','update','then','error','failureReason','Payment\x20not\x20found',',\x20currentPayments=','gateway','Payment\x20processed\x20successfully','Any\x203-4\x20digits','shopId','__importStar','create','gatewayOrderId','orderId','221BJnStH','Payment\x20System/1.0\x20(Test\x20Gateway)','sendPaymentStatusNotification','âœ…\x20Test\x20Gateway\x20payment\x20','test_card','webhookUrl','../services/telegramBotService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',':\x20type=','PENDING','processCardPayment','TestGatewayController','prototype','isArray','\x20not\x20enabled\x20for\x20shop\x20','âœ…\x20Payment\x20link\x20','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','sendShopWebhook','processCard','156KofkFX','\x20->\x20','7745sCcMGm','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','16904BATpMP','\x20not\x20found','3001830sjaRwa','324MtLHRF','configurable','\x20updated:\x20currentPayments='];a19_0x19a6=function(){return _0x2ff46c;};return a19_0x19a6();}exports[a19_0x5360ec(0x187)]=TestGatewayController;