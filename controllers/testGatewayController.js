'use strict';function a15_0x2495(_0xd738a9,_0x428f67){const _0x3aec4e=a15_0x3aec();return a15_0x2495=function(_0x2495d3,_0x1aa957){_0x2495d3=_0x2495d3-0x10e;let _0x368560=_0x3aec4e[_0x2495d3];return _0x368560;},a15_0x2495(_0xd738a9,_0x428f67);}function a15_0x3aec(){const _0x2f0ecb=['📈\x20Found\x20payment\x20link\x20','customerName','2fbhnkf','webhookEvents','failureReason','replace','❌\x20Payment\x20link\x20','payment.success','failed','Payment\x20status\x20is\x20','📈\x20Test\x20Gateway:\x20Payment\x20','shop','cardLast4','settings','Payment\x20not\x20found','params','get','\x20processed:\x20','Error\x20parsing\x20webhook\x20events:','stringify','toLowerCase','paid','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20failed','gatewayOrderId','Payment\x20to\x20','then','payment.failed','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','\x20not\x20found','paymentMethod','SINGLE','568380IjpJJm','FAILED',':\x20type=','TestGatewayController','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','webhookUrl','webhookLog','isArray','POST','shopId','test_gateway','Payment\x20is\x20not\x20for\x20test\x20gateway','__createBinding','json','Webhook\x20event\x20','create','paymentLinkId','COMPLETED','getPaymentForm','369607zZvGtC','16794eRzTZS','payment','sendPaymentStatusNotification','amount','\x20not\x20enabled\x20for\x20shop\x20','toISOString','Payment\x20processed\x20successfully','test_gateway_','sendShopWebhook','processCard','__setModuleDefault','parse','4242\x204242\x204242\x204242','__esModule','error','sendPaymentNotification','currentPayments','472hwLshk','PAID','length','gateway','now','createdAt','testGatewayService','24988zRjwBP','🧪\x20Test\x20Gateway\x20result:',',\x20currentPayments=','../config/database','transactionId','paymentLink','Any\x20name',',\x20cannot\x20process','getOwnPropertyNames','15173670cHNcvF','configurable','1434790xPGobs',',\x20status=','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/gateways/testGatewayService','resolve','processCardPayment','0000','gatewayPaymentId','WebhookService','Any\x20other\x20card\x20number','PENDING','status','Any\x20future\x20date\x20(MM/YY)','4075578OVwbmf','orderId','Test\x20Gateway\x20webhook\x20sent\x20to\x20','✅\x20Payment\x20link\x20','__importStar','$transaction','\x20->\x20','update','default','body','name','Any\x203-4\x20digits','test_card','type','includes','TestGatewayService','696atDhsy','currency','getOwnPropertyDescriptor','findUnique','log','defineProperty'];a15_0x3aec=function(){return _0x2f0ecb;};return a15_0x3aec();}const a15_0x1db2fc=a15_0x2495;(function(_0x13c9da,_0x19411e){const _0x4b6889=a15_0x2495,_0x44add0=_0x13c9da();while(!![]){try{const _0x153778=-parseInt(_0x4b6889(0x178))/0x1*(-parseInt(_0x4b6889(0x153))/0x2)+-parseInt(_0x4b6889(0x170))/0x3*(-parseInt(_0x4b6889(0x148))/0x4)+parseInt(_0x4b6889(0x11b))/0x5+-parseInt(_0x4b6889(0x160))/0x6+parseInt(_0x4b6889(0x12f))/0x7+parseInt(_0x4b6889(0x141))/0x8*(-parseInt(_0x4b6889(0x130))/0x9)+-parseInt(_0x4b6889(0x151))/0xa;if(_0x153778===_0x19411e)break;else _0x44add0['push'](_0x44add0['shift']());}catch(_0x2297ad){_0x44add0['push'](_0x44add0['shift']());}}}(a15_0x3aec,0xb59a7));var __createBinding=this&&this[a15_0x1db2fc(0x128)]||(Object[a15_0x1db2fc(0x12b)]?function(_0x3714e9,_0x3edd1a,_0x309ab1,_0x1866b6){const _0xf0fffc=a15_0x1db2fc;if(_0x1866b6===undefined)_0x1866b6=_0x309ab1;var _0x394657=Object[_0xf0fffc(0x172)](_0x3edd1a,_0x309ab1);(!_0x394657||(_0xf0fffc(0x186)in _0x394657?!_0x3edd1a[_0xf0fffc(0x13d)]:_0x394657['writable']||_0x394657[_0xf0fffc(0x152)]))&&(_0x394657={'enumerable':!![],'get':function(){return _0x3edd1a[_0x309ab1];}}),Object[_0xf0fffc(0x175)](_0x3714e9,_0x1866b6,_0x394657);}:function(_0xcbfabe,_0x183138,_0x132f7f,_0x14ea98){if(_0x14ea98===undefined)_0x14ea98=_0x132f7f;_0xcbfabe[_0x14ea98]=_0x183138[_0x132f7f];}),__setModuleDefault=this&&this[a15_0x1db2fc(0x13a)]||(Object['create']?function(_0x595a45,_0x4d3e47){const _0x53d0a4=a15_0x1db2fc;Object[_0x53d0a4(0x175)](_0x595a45,'default',{'enumerable':!![],'value':_0x4d3e47});}:function(_0x43bd9c,_0x1e6593){const _0x41f64a=a15_0x1db2fc;_0x43bd9c[_0x41f64a(0x168)]=_0x1e6593;}),__importStar=this&&this[a15_0x1db2fc(0x164)]||(function(){var _0x3dbad6=function(_0x4e3032){const _0x37bf01=a15_0x2495;return _0x3dbad6=Object[_0x37bf01(0x150)]||function(_0x5c0315){const _0x3fc543=_0x37bf01;var _0x175d1a=[];for(var _0x434c1e in _0x5c0315)if(Object['prototype']['hasOwnProperty']['call'](_0x5c0315,_0x434c1e))_0x175d1a[_0x175d1a[_0x3fc543(0x143)]]=_0x434c1e;return _0x175d1a;},_0x3dbad6(_0x4e3032);};return function(_0x31c911){const _0x1222c5=a15_0x2495;if(_0x31c911&&_0x31c911[_0x1222c5(0x13d)])return _0x31c911;var _0x525f08={};if(_0x31c911!=null){for(var _0x5ec41f=_0x3dbad6(_0x31c911),_0x5f7431=0x0;_0x5f7431<_0x5ec41f['length'];_0x5f7431++)if(_0x5ec41f[_0x5f7431]!==_0x1222c5(0x168))__createBinding(_0x525f08,_0x31c911,_0x5ec41f[_0x5f7431]);}return __setModuleDefault(_0x525f08,_0x31c911),_0x525f08;};}()),__importDefault=this&&this['__importDefault']||function(_0x1fcec0){const _0x21642b=a15_0x1db2fc;return _0x1fcec0&&_0x1fcec0[_0x21642b(0x13d)]?_0x1fcec0:{'default':_0x1fcec0};};Object[a15_0x1db2fc(0x175)](exports,'__esModule',{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a15_0x1db2fc(0x156)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a15_0x1db2fc(0x14b)));class TestGatewayController{constructor(){const _0x362dd3=a15_0x1db2fc;this[_0x362dd3(0x12e)]=async(_0x5956ff,_0x14c8bf,_0x4936c9)=>{const _0x506d00=_0x362dd3;try{const {paymentId:_0x56bd1f}=_0x5956ff['params'];console[_0x506d00(0x174)]('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x56bd1f);const _0x2e25f9=await database_1['default'][_0x506d00(0x131)]['findUnique']({'where':{'id':_0x56bd1f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2e25f9)return _0x14c8bf[_0x506d00(0x15e)](0x194)[_0x506d00(0x129)]({'success':![],'message':_0x506d00(0x184)});if(_0x2e25f9[_0x506d00(0x144)]!==_0x506d00(0x126))return _0x14c8bf[_0x506d00(0x15e)](0x190)['json']({'success':![],'message':_0x506d00(0x127)});if(_0x2e25f9[_0x506d00(0x15e)]!=='PENDING')return _0x14c8bf['status'](0x190)['json']({'success':![],'message':_0x506d00(0x17f)+_0x2e25f9[_0x506d00(0x15e)]+_0x506d00(0x14f)});_0x14c8bf['json']({'success':!![],'result':{'paymentId':_0x2e25f9['id'],'orderId':_0x2e25f9['gatewayOrderId'],'amount':_0x2e25f9[_0x506d00(0x133)],'currency':_0x2e25f9[_0x506d00(0x171)],'merchantName':_0x2e25f9[_0x506d00(0x181)][_0x506d00(0x16a)],'description':_0x506d00(0x114)+_0x2e25f9[_0x506d00(0x181)][_0x506d00(0x16a)],'testInstructions':{'successCard':_0x506d00(0x13c),'failureCard':_0x506d00(0x15c),'expiryDate':_0x506d00(0x15f),'cvc':_0x506d00(0x16b),'holderName':_0x506d00(0x14e)}}});}catch(_0x3d11e6){_0x4936c9(_0x3d11e6);}},this[_0x362dd3(0x139)]=async(_0x872656,_0x11e74d,_0x243fee)=>{const _0x5f0432=_0x362dd3;try{const {paymentId:_0x52d1a7}=_0x872656[_0x5f0432(0x185)],_0x4a9d67=_0x872656[_0x5f0432(0x169)];console['log']('🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20'+_0x52d1a7);const _0xd57470=await database_1[_0x5f0432(0x168)][_0x5f0432(0x131)][_0x5f0432(0x173)]({'where':{'id':_0x52d1a7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xd57470)return _0x11e74d[_0x5f0432(0x15e)](0x194)['json']({'success':![],'message':_0x5f0432(0x184)});if(_0xd57470[_0x5f0432(0x144)]!==_0x5f0432(0x126))return _0x11e74d[_0x5f0432(0x15e)](0x190)[_0x5f0432(0x129)]({'success':![],'message':_0x5f0432(0x127)});if(_0xd57470[_0x5f0432(0x15e)]!==_0x5f0432(0x15d))return _0x11e74d[_0x5f0432(0x15e)](0x190)[_0x5f0432(0x129)]({'success':![],'message':_0x5f0432(0x17f)+_0xd57470[_0x5f0432(0x15e)]+_0x5f0432(0x14f)});const _0x4cecbb=await this[_0x5f0432(0x147)][_0x5f0432(0x158)]({'paymentId':_0xd57470['id'],'orderId':_0xd57470[_0x5f0432(0x113)]||_0xd57470['id'],'amount':_0xd57470[_0x5f0432(0x133)],'currency':_0xd57470[_0x5f0432(0x171)],'cardData':_0x4a9d67});console['log'](_0x5f0432(0x149),_0x4cecbb);const _0x4038a9={'status':_0x4cecbb['status'],'updatedAt':new Date()};if(_0x4cecbb[_0x5f0432(0x15e)]===_0x5f0432(0x142))_0x4038a9['paidAt']=new Date(),_0x4038a9[_0x5f0432(0x15a)]=_0x4cecbb[_0x5f0432(0x14c)];else _0x4cecbb[_0x5f0432(0x15e)]==='FAILED'&&(_0x4038a9['failureMessage']=_0x4cecbb['failureReason']);const _0x1c118d=_0x4a9d67['cardNumber'][_0x5f0432(0x17b)](/[\s-]/g,'');_0x4038a9[_0x5f0432(0x182)]=_0x1c118d['slice'](-0x4),_0x4038a9[_0x5f0432(0x119)]=_0x5f0432(0x16c),await database_1[_0x5f0432(0x168)][_0x5f0432(0x131)][_0x5f0432(0x167)]({'where':{'id':_0xd57470['id']},'data':_0x4038a9});if(_0x4cecbb[_0x5f0432(0x15e)]==='PAID'&&_0xd57470[_0x5f0432(0x12c)]){console[_0x5f0432(0x174)](_0x5f0432(0x180)+_0xd57470['id']+_0x5f0432(0x120));try{await database_1[_0x5f0432(0x168)][_0x5f0432(0x165)](async _0x222560=>{const _0x2f62b5=_0x5f0432,_0x3a3d1b=await _0x222560[_0x2f62b5(0x14d)]['findUnique']({'where':{'id':_0xd57470['paymentLinkId']},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3a3d1b){console[_0x2f62b5(0x174)](_0x2f62b5(0x176)+_0x3a3d1b['id']+_0x2f62b5(0x11d)+_0x3a3d1b[_0x2f62b5(0x16d)]+_0x2f62b5(0x14a)+_0x3a3d1b[_0x2f62b5(0x140)]+_0x2f62b5(0x154)+_0x3a3d1b['status']);const _0x2b1375=_0x3a3d1b[_0x2f62b5(0x140)]+0x1,_0x390d42=_0x3a3d1b['type']===_0x2f62b5(0x11a)?_0x2f62b5(0x12d):_0x3a3d1b['status'];await _0x222560[_0x2f62b5(0x14d)]['update']({'where':{'id':_0xd57470[_0x2f62b5(0x12c)]},'data':{'currentPayments':_0x2b1375,'status':_0x390d42,'updatedAt':new Date()}}),console[_0x2f62b5(0x174)](_0x2f62b5(0x163)+_0x3a3d1b['id']+'\x20updated:\x20currentPayments='+_0x3a3d1b['currentPayments']+_0x2f62b5(0x166)+_0x2b1375+',\x20status='+_0x3a3d1b[_0x2f62b5(0x15e)]+'\x20->\x20'+_0x390d42);}else console[_0x2f62b5(0x174)](_0x2f62b5(0x17c)+_0xd57470['paymentLinkId']+_0x2f62b5(0x118));});}catch(_0x256726){console[_0x5f0432(0x13e)](_0x5f0432(0x11f),_0x256726);}}await database_1['default'][_0x5f0432(0x122)]['create']({'data':{'paymentId':_0xd57470['id'],'shopId':_0xd57470[_0x5f0432(0x125)],'event':_0x5f0432(0x137)+_0x4cecbb[_0x5f0432(0x15e)][_0x5f0432(0x10f)](),'statusCode':0xc8,'responseBody':JSON[_0x5f0432(0x10e)]({'oldStatus':'PENDING','newStatus':_0x4cecbb['status'],'transactionId':_0x4cecbb[_0x5f0432(0x14c)],'failureReason':_0x4cecbb[_0x5f0432(0x17a)],'processedAt':new Date()[_0x5f0432(0x135)]()})}}),await this['sendShopWebhook'](_0xd57470,_0x4cecbb[_0x5f0432(0x15e)],_0x4cecbb['transactionId'],_0x4cecbb[_0x5f0432(0x17a)]),await this[_0x5f0432(0x132)](_0xd57470,_0x4cecbb[_0x5f0432(0x15e)]),console[_0x5f0432(0x174)]('✅\x20Test\x20Gateway\x20payment\x20'+_0x52d1a7+_0x5f0432(0x187)+_0x4cecbb[_0x5f0432(0x15e)]),_0x4cecbb[_0x5f0432(0x15e)]===_0x5f0432(0x142)?_0x11e74d[_0x5f0432(0x129)]({'success':!![],'message':_0x5f0432(0x136),'result':{'status':_0x5f0432(0x142),'transactionId':_0x4cecbb[_0x5f0432(0x14c)],'redirectUrl':_0xd57470['successUrl']}}):_0x11e74d['status'](0x190)[_0x5f0432(0x129)]({'success':![],'message':_0x5f0432(0x112),'result':{'status':_0x5f0432(0x11c),'failureReason':_0x4cecbb[_0x5f0432(0x17a)],'redirectUrl':_0xd57470['failUrl']}});}catch(_0x28ae5b){_0x243fee(_0x28ae5b);}},this[_0x362dd3(0x147)]=new testGatewayService_1[(_0x362dd3(0x16f))](),this['webhookService']=new webhookService_1[(_0x362dd3(0x15b))]();}async[a15_0x1db2fc(0x138)](_0x40a157,_0x2a1223,_0x2c6adc,_0x412b63){const _0x9b1733=a15_0x1db2fc,_0xaf2f9c=Date[_0x9b1733(0x145)]();try{const _0x29b5b8=_0x40a157['shop'],_0xe5adc4=_0x29b5b8[_0x9b1733(0x183)];if(!_0xe5adc4?.['webhookUrl']){console['log'](_0x9b1733(0x111)+_0x29b5b8['id']);return;}const _0x112bf5=_0x2a1223===_0x9b1733(0x142)?_0x9b1733(0x17d):_0x9b1733(0x116);let _0x4469c5=[];if(_0xe5adc4[_0x9b1733(0x179)])try{_0x4469c5=Array[_0x9b1733(0x123)](_0xe5adc4[_0x9b1733(0x179)])?_0xe5adc4[_0x9b1733(0x179)]:JSON[_0x9b1733(0x13b)](_0xe5adc4[_0x9b1733(0x179)]);}catch(_0x22571f){console['error'](_0x9b1733(0x188),_0x22571f),_0x4469c5=[];}if(!_0x4469c5[_0x9b1733(0x16e)](_0x112bf5)){console[_0x9b1733(0x174)](_0x9b1733(0x12a)+_0x112bf5+_0x9b1733(0x134)+_0x29b5b8['id']);return;}const _0x5d81c3={'event':_0x112bf5,'payment':{'id':_0x40a157['id'],'order_id':_0x40a157[_0x9b1733(0x161)],'gateway_order_id':_0x40a157['gatewayOrderId'],'gateway':_0x9b1733(0x159),'amount':_0x40a157['amount'],'currency':_0x40a157[_0x9b1733(0x171)],'status':_0x2a1223[_0x9b1733(0x10f)](),'customer_email':_0x40a157['customerEmail'],'customer_name':_0x40a157[_0x9b1733(0x177)],'transaction_id':_0x2c6adc,'failure_message':_0x412b63,'created_at':_0x40a157[_0x9b1733(0x146)],'updated_at':new Date()}},_0x459a71=await fetch(_0xe5adc4['webhookUrl'],{'method':_0x9b1733(0x124),'headers':{'Content-Type':'application/json','User-Agent':'Payment\x20System/1.0\x20(Test\x20Gateway)'},'body':JSON['stringify'](_0x5d81c3)}),_0x4764b1=Date[_0x9b1733(0x145)]()-_0xaf2f9c;console[_0x9b1733(0x174)](_0x9b1733(0x162)+_0xe5adc4[_0x9b1733(0x121)]+'\x20with\x20status\x20'+_0x459a71[_0x9b1733(0x15e)]+'\x20('+_0x4764b1+'ms)');}catch(_0x26ad78){console['error'](_0x9b1733(0x117),_0x26ad78);}}async[a15_0x1db2fc(0x132)](_0x345b2d,_0xa4c910){const _0x2b3c27=a15_0x1db2fc;try{const {telegramBotService:_0x15a3dd}=await Promise[_0x2b3c27(0x157)]()[_0x2b3c27(0x115)](()=>__importStar(require('../services/telegramBotService'))),_0x3ede21={'PAID':_0x2b3c27(0x110),'FAILED':_0x2b3c27(0x17e)},_0x4660b2=_0x3ede21[_0xa4c910];if(!_0x4660b2)return;await _0x15a3dd[_0x2b3c27(0x13f)](_0x345b2d[_0x2b3c27(0x125)],_0x345b2d,_0x4660b2);}catch(_0x2b1781){console[_0x2b3c27(0x13e)](_0x2b3c27(0x155),_0x2b1781);}}}exports[a15_0x1db2fc(0x11e)]=TestGatewayController;