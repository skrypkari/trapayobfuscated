'use strict';const a19_0x8806b=a19_0x4881;(function(_0x2768ad,_0xabc72){const _0x31352f=a19_0x4881,_0x3ab072=_0x2768ad();while(!![]){try{const _0x2ca217=parseInt(_0x31352f(0x190))/0x1*(parseInt(_0x31352f(0x162))/0x2)+parseInt(_0x31352f(0x154))/0x3*(parseInt(_0x31352f(0x172))/0x4)+parseInt(_0x31352f(0x16d))/0x5+-parseInt(_0x31352f(0x17f))/0x6+parseInt(_0x31352f(0x130))/0x7+-parseInt(_0x31352f(0x16e))/0x8*(parseInt(_0x31352f(0x166))/0x9)+parseInt(_0x31352f(0x173))/0xa*(-parseInt(_0x31352f(0x157))/0xb);if(_0x2ca217===_0xabc72)break;else _0x3ab072['push'](_0x3ab072['shift']());}catch(_0x2e72d4){_0x3ab072['push'](_0x3ab072['shift']());}}}(a19_0x2703,0xae188));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x475b71,_0x5196ba,_0x469ed1,_0x4b7a12){const _0x3c8e6a=a19_0x4881;if(_0x4b7a12===undefined)_0x4b7a12=_0x469ed1;var _0x496682=Object['getOwnPropertyDescriptor'](_0x5196ba,_0x469ed1);(!_0x496682||('get'in _0x496682?!_0x5196ba[_0x3c8e6a(0x138)]:_0x496682[_0x3c8e6a(0x184)]||_0x496682['configurable']))&&(_0x496682={'enumerable':!![],'get':function(){return _0x5196ba[_0x469ed1];}}),Object[_0x3c8e6a(0x175)](_0x475b71,_0x4b7a12,_0x496682);}:function(_0x1f86db,_0x3dc73b,_0x58e149,_0x5d39dc){if(_0x5d39dc===undefined)_0x5d39dc=_0x58e149;_0x1f86db[_0x5d39dc]=_0x3dc73b[_0x58e149];}),__setModuleDefault=this&&this[a19_0x8806b(0x177)]||(Object[a19_0x8806b(0x146)]?function(_0x5855d1,_0x15649b){const _0x22d7c1=a19_0x8806b;Object[_0x22d7c1(0x175)](_0x5855d1,_0x22d7c1(0x186),{'enumerable':!![],'value':_0x15649b});}:function(_0x47849c,_0x3265ab){const _0x21ce76=a19_0x8806b;_0x47849c[_0x21ce76(0x186)]=_0x3265ab;}),__importStar=this&&this['__importStar']||(function(){var _0x21fcc7=function(_0x367f86){const _0x248954=a19_0x4881;return _0x21fcc7=Object[_0x248954(0x17a)]||function(_0x469538){const _0x450933=_0x248954;var _0xbd44b1=[];for(var _0x92cbe9 in _0x469538)if(Object[_0x450933(0x176)][_0x450933(0x178)][_0x450933(0x151)](_0x469538,_0x92cbe9))_0xbd44b1[_0xbd44b1[_0x450933(0x12e)]]=_0x92cbe9;return _0xbd44b1;},_0x21fcc7(_0x367f86);};return function(_0x34b715){const _0x586276=a19_0x4881;if(_0x34b715&&_0x34b715[_0x586276(0x138)])return _0x34b715;var _0x57db48={};if(_0x34b715!=null){for(var _0x47bb81=_0x21fcc7(_0x34b715),_0x574de6=0x0;_0x574de6<_0x47bb81[_0x586276(0x12e)];_0x574de6++)if(_0x47bb81[_0x574de6]!=='default')__createBinding(_0x57db48,_0x34b715,_0x47bb81[_0x574de6]);}return __setModuleDefault(_0x57db48,_0x34b715),_0x57db48;};}()),__importDefault=this&&this[a19_0x8806b(0x18a)]||function(_0x5ca05a){const _0x46c65c=a19_0x8806b;return _0x5ca05a&&_0x5ca05a[_0x46c65c(0x138)]?_0x5ca05a:{'default':_0x5ca05a};};Object[a19_0x8806b(0x175)](exports,'__esModule',{'value':!![]}),exports[a19_0x8806b(0x148)]=void 0x0;const testGatewayService_1=require(a19_0x8806b(0x155)),webhookService_1=require(a19_0x8806b(0x16f)),database_1=__importDefault(require(a19_0x8806b(0x161)));class TestGatewayController{constructor(){const _0x215055=a19_0x8806b;this[_0x215055(0x134)]=async(_0x1e9b70,_0x53e223,_0x260559)=>{const _0x712bc4=_0x215055;try{const {paymentId:_0xe455bc}=_0x1e9b70[_0x712bc4(0x183)];console[_0x712bc4(0x132)](_0x712bc4(0x17d)+_0xe455bc);const _0x288a31=await database_1[_0x712bc4(0x186)]['payment'][_0x712bc4(0x18f)]({'where':{'id':_0xe455bc},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x288a31)return _0x53e223[_0x712bc4(0x197)](0x194)[_0x712bc4(0x195)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x288a31[_0x712bc4(0x147)]!==_0x712bc4(0x16c))return _0x53e223[_0x712bc4(0x197)](0x190)[_0x712bc4(0x195)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x288a31[_0x712bc4(0x197)]!==_0x712bc4(0x149))return _0x53e223[_0x712bc4(0x197)](0x190)[_0x712bc4(0x195)]({'success':![],'message':_0x712bc4(0x188)+_0x288a31['status']+_0x712bc4(0x143)});_0x53e223[_0x712bc4(0x195)]({'success':!![],'result':{'paymentId':_0x288a31['id'],'orderId':_0x288a31[_0x712bc4(0x189)],'amount':_0x288a31[_0x712bc4(0x13f)],'currency':_0x288a31['currency'],'merchantName':_0x288a31[_0x712bc4(0x142)]['name'],'description':_0x712bc4(0x198)+_0x288a31[_0x712bc4(0x142)][_0x712bc4(0x12f)],'testInstructions':{'successCard':_0x712bc4(0x12c),'failureCard':'Any\x20other\x20card\x20number','expiryDate':_0x712bc4(0x15b),'cvc':'Any\x203-4\x20digits','holderName':_0x712bc4(0x13d)}}});}catch(_0x34636e){_0x260559(_0x34636e);}},this[_0x215055(0x14e)]=async(_0x4882f0,_0x297f62,_0xa405da)=>{const _0x3e452c=_0x215055;try{const {paymentId:_0x600a53}=_0x4882f0[_0x3e452c(0x183)],_0x575a58=_0x4882f0['body'];console[_0x3e452c(0x132)](_0x3e452c(0x165)+_0x600a53);const _0x3c49d0=await database_1[_0x3e452c(0x186)][_0x3e452c(0x12d)][_0x3e452c(0x18f)]({'where':{'id':_0x600a53},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3c49d0)return _0x297f62[_0x3e452c(0x197)](0x194)['json']({'success':![],'message':_0x3e452c(0x150)});if(_0x3c49d0[_0x3e452c(0x147)]!=='test_gateway')return _0x297f62[_0x3e452c(0x197)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20test\x20gateway'});if(_0x3c49d0[_0x3e452c(0x197)]!==_0x3e452c(0x149))return _0x297f62['status'](0x190)[_0x3e452c(0x195)]({'success':![],'message':_0x3e452c(0x188)+_0x3c49d0[_0x3e452c(0x197)]+_0x3e452c(0x143)});const _0x4e34fd=await this[_0x3e452c(0x171)][_0x3e452c(0x153)]({'paymentId':_0x3c49d0['id'],'orderId':_0x3c49d0[_0x3e452c(0x189)]||_0x3c49d0['id'],'amount':_0x3c49d0[_0x3e452c(0x13f)],'currency':_0x3c49d0['currency'],'cardData':_0x575a58});console[_0x3e452c(0x132)]('ðŸ§ª\x20Test\x20Gateway\x20result:',_0x4e34fd);const _0x4393e5={'status':_0x4e34fd[_0x3e452c(0x197)],'updatedAt':new Date()};if(_0x4e34fd['status']===_0x3e452c(0x199))_0x4393e5[_0x3e452c(0x14b)]=new Date(),_0x4393e5[_0x3e452c(0x19a)]=_0x4e34fd['transactionId'];else _0x4e34fd[_0x3e452c(0x197)]==='FAILED'&&(_0x4393e5[_0x3e452c(0x19e)]=_0x4e34fd[_0x3e452c(0x160)]);const _0x41a630=_0x575a58[_0x3e452c(0x182)][_0x3e452c(0x163)](/[\s-]/g,'');_0x4393e5['cardLast4']=_0x41a630[_0x3e452c(0x156)](-0x4),_0x4393e5[_0x3e452c(0x140)]='test_card',await database_1[_0x3e452c(0x186)][_0x3e452c(0x12d)][_0x3e452c(0x14d)]({'where':{'id':_0x3c49d0['id']},'data':_0x4393e5});if(_0x4e34fd[_0x3e452c(0x197)]===_0x3e452c(0x199)&&_0x3c49d0[_0x3e452c(0x170)]){console[_0x3e452c(0x132)](_0x3e452c(0x15c)+_0x3c49d0['id']+_0x3e452c(0x19d));try{await database_1[_0x3e452c(0x186)]['$transaction'](async _0x11f1ac=>{const _0x589629=_0x3e452c,_0xc6e401=await _0x11f1ac[_0x589629(0x167)]['findUnique']({'where':{'id':_0x3c49d0[_0x589629(0x170)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0xc6e401){console[_0x589629(0x132)]('ðŸ“ˆ\x20Found\x20payment\x20link\x20'+_0xc6e401['id']+_0x589629(0x191)+_0xc6e401[_0x589629(0x13e)]+',\x20currentPayments='+_0xc6e401[_0x589629(0x18d)]+_0x589629(0x185)+_0xc6e401[_0x589629(0x197)]);const _0x1b7c76=_0xc6e401['currentPayments']+0x1,_0xebaa5c=_0xc6e401[_0x589629(0x13e)]===_0x589629(0x17c)?_0x589629(0x180):_0xc6e401[_0x589629(0x197)];await _0x11f1ac['paymentLink']['update']({'where':{'id':_0x3c49d0[_0x589629(0x170)]},'data':{'currentPayments':_0x1b7c76,'status':_0xebaa5c,'updatedAt':new Date()}}),console[_0x589629(0x132)](_0x589629(0x19b)+_0xc6e401['id']+_0x589629(0x181)+_0xc6e401[_0x589629(0x18d)]+_0x589629(0x168)+_0x1b7c76+_0x589629(0x185)+_0xc6e401['status']+_0x589629(0x168)+_0xebaa5c);}else console[_0x589629(0x132)](_0x589629(0x193)+_0x3c49d0[_0x589629(0x170)]+_0x589629(0x158));});}catch(_0x2f2843){console[_0x3e452c(0x187)](_0x3e452c(0x137),_0x2f2843);}}await database_1[_0x3e452c(0x186)]['webhookLog'][_0x3e452c(0x146)]({'data':{'paymentId':_0x3c49d0['id'],'shopId':_0x3c49d0[_0x3e452c(0x14a)],'event':_0x3e452c(0x15e)+_0x4e34fd[_0x3e452c(0x197)][_0x3e452c(0x135)](),'statusCode':0xc8,'responseBody':JSON[_0x3e452c(0x152)]({'oldStatus':_0x3e452c(0x149),'newStatus':_0x4e34fd[_0x3e452c(0x197)],'transactionId':_0x4e34fd[_0x3e452c(0x159)],'failureReason':_0x4e34fd[_0x3e452c(0x160)],'processedAt':new Date()[_0x3e452c(0x192)]()})}}),await this[_0x3e452c(0x17e)](_0x3c49d0,_0x4e34fd[_0x3e452c(0x197)],_0x4e34fd[_0x3e452c(0x159)],_0x4e34fd[_0x3e452c(0x160)]),await this['sendPaymentStatusNotification'](_0x3c49d0,_0x4e34fd['status']),console['log'](_0x3e452c(0x13b)+_0x600a53+_0x3e452c(0x18b)+_0x4e34fd[_0x3e452c(0x197)]),_0x4e34fd['status']===_0x3e452c(0x199)?_0x297f62[_0x3e452c(0x195)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3e452c(0x199),'transactionId':_0x4e34fd['transactionId'],'redirectUrl':_0x3c49d0[_0x3e452c(0x14f)]}}):_0x297f62['status'](0x190)[_0x3e452c(0x195)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x3e452c(0x174),'failureReason':_0x4e34fd[_0x3e452c(0x160)],'redirectUrl':_0x3c49d0[_0x3e452c(0x16b)]}});}catch(_0x355197){_0xa405da(_0x355197);}},this[_0x215055(0x171)]=new testGatewayService_1['TestGatewayService'](),this[_0x215055(0x141)]=new webhookService_1['WebhookService']();}async[a19_0x8806b(0x17e)](_0x4ee4cf,_0x3f987e,_0x4b2b27,_0x5484e5){const _0x21936e=a19_0x8806b,_0xc2cd36=Date[_0x21936e(0x145)]();try{const _0x2acb35=_0x4ee4cf[_0x21936e(0x142)],_0x5bebc0=_0x2acb35['settings'];if(!_0x5bebc0?.[_0x21936e(0x139)]){console[_0x21936e(0x132)](_0x21936e(0x16a)+_0x2acb35['id']);return;}const _0x521236=_0x3f987e==='PAID'?_0x21936e(0x15d):'payment.failed';let _0x1fab63=[];if(_0x5bebc0[_0x21936e(0x194)])try{_0x1fab63=Array['isArray'](_0x5bebc0[_0x21936e(0x194)])?_0x5bebc0[_0x21936e(0x194)]:JSON[_0x21936e(0x136)](_0x5bebc0[_0x21936e(0x194)]);}catch(_0x1298b7){console[_0x21936e(0x187)]('Error\x20parsing\x20webhook\x20events:',_0x1298b7),_0x1fab63=[];}if(!_0x1fab63[_0x21936e(0x179)](_0x521236)){console[_0x21936e(0x132)]('Webhook\x20event\x20'+_0x521236+_0x21936e(0x169)+_0x2acb35['id']);return;}const _0x1cfce0={'event':_0x521236,'payment':{'id':_0x4ee4cf['id'],'order_id':_0x4ee4cf[_0x21936e(0x17b)],'gateway_order_id':_0x4ee4cf[_0x21936e(0x189)],'gateway':_0x21936e(0x131),'amount':_0x4ee4cf[_0x21936e(0x13f)],'currency':_0x4ee4cf['currency'],'status':_0x3f987e[_0x21936e(0x135)](),'customer_email':_0x4ee4cf[_0x21936e(0x13c)],'customer_name':_0x4ee4cf['customerName'],'transaction_id':_0x4b2b27,'failure_message':_0x5484e5,'created_at':_0x4ee4cf['createdAt'],'updated_at':new Date()}},_0x140318=await fetch(_0x5bebc0[_0x21936e(0x139)],{'method':_0x21936e(0x196),'headers':{'Content-Type':'application/json','User-Agent':_0x21936e(0x15f)},'body':JSON['stringify'](_0x1cfce0)}),_0x3116f8=Date['now']()-_0xc2cd36;console['log'](_0x21936e(0x19c)+_0x5bebc0[_0x21936e(0x139)]+_0x21936e(0x164)+_0x140318[_0x21936e(0x197)]+'\x20('+_0x3116f8+_0x21936e(0x133));}catch(_0x4a7345){console['error']('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x4a7345);}}async[a19_0x8806b(0x14c)](_0xfd5783,_0x5de166){const _0x4cd428=a19_0x8806b;try{const {telegramBotService:_0x56ce14}=await Promise[_0x4cd428(0x15a)]()[_0x4cd428(0x13a)](()=>__importStar(require('../services/telegramBotService'))),_0x36aadf={'PAID':_0x4cd428(0x18e),'FAILED':'failed'},_0x21a46d=_0x36aadf[_0x5de166];if(!_0x21a46d)return;await _0x56ce14[_0x4cd428(0x144)](_0xfd5783[_0x4cd428(0x14a)],_0xfd5783,_0x21a46d);}catch(_0x285e7a){console[_0x4cd428(0x187)](_0x4cd428(0x18c),_0x285e7a);}}}function a19_0x4881(_0x32c410,_0x30031d){_0x32c410=_0x32c410-0x12c;const _0x270314=a19_0x2703();let _0x488130=_0x270314[_0x32c410];return _0x488130;}exports['TestGatewayController']=TestGatewayController;function a19_0x2703(){const _0x4da385=['\x20processed:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','currentPayments','paid','findUnique','587kzJkzs',':\x20type=','toISOString','âŒ\x20Payment\x20link\x20','webhookEvents','json','POST','status','Payment\x20to\x20','PAID','gatewayPaymentId','âœ…\x20Payment\x20link\x20','Test\x20Gateway\x20webhook\x20sent\x20to\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','failureMessage','4242\x204242\x204242\x204242','payment','length','name','4101300zHhsoa','0000','log','ms)','getPaymentForm','toLowerCase','parse','âŒ\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','__esModule','webhookUrl','then','âœ…\x20Test\x20Gateway\x20payment\x20','customerEmail','Any\x20name','type','amount','paymentMethod','webhookService','shop',',\x20cannot\x20process','sendPaymentNotification','now','create','gateway','TestGatewayController','PENDING','shopId','paidAt','sendPaymentStatusNotification','update','processCard','successUrl','Payment\x20not\x20found','call','stringify','processCardPayment','462QmJpMv','../services/gateways/testGatewayService','slice','758208sDwmjL','\x20not\x20found','transactionId','resolve','Any\x20future\x20date\x20(MM/YY)','ðŸ“ˆ\x20Test\x20Gateway:\x20Payment\x20','payment.success','test_gateway_','Payment\x20System/1.0\x20(Test\x20Gateway)','failureReason','../config/database','4102LJasDA','replace','\x20with\x20status\x20','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','63PSzbmd','paymentLink','\x20->\x20','\x20not\x20enabled\x20for\x20shop\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failUrl','test_gateway','141485JacgjB','156904OciOVA','../services/webhookService','paymentLinkId','testGatewayService','33480oZKDyW','210lrQrlb','FAILED','defineProperty','prototype','__setModuleDefault','hasOwnProperty','includes','getOwnPropertyNames','orderId','SINGLE','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','sendShopWebhook','4855434nThmBM','COMPLETED','\x20updated:\x20currentPayments=','cardNumber','params','writable',',\x20status=','default','error','Payment\x20status\x20is\x20','gatewayOrderId','__importDefault'];a19_0x2703=function(){return _0x4da385;};return a19_0x2703();}