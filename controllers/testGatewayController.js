'use strict';function a13_0x20fd(_0xc151ee,_0x160edc){const _0x323ece=a13_0x323e();return a13_0x20fd=function(_0x20fdbf,_0x61c790){_0x20fdbf=_0x20fdbf-0xa4;let _0x3ba1cd=_0x323ece[_0x20fdbf];return _0x3ba1cd;},a13_0x20fd(_0xc151ee,_0x160edc);}const a13_0xa2d4ca=a13_0x20fd;(function(_0x1c298f,_0x5cdb08){const _0x5b313e=a13_0x20fd,_0x47477a=_0x1c298f();while(!![]){try{const _0x1cb7eb=parseInt(_0x5b313e(0x10a))/0x1*(-parseInt(_0x5b313e(0xb8))/0x2)+parseInt(_0x5b313e(0xc3))/0x3+parseInt(_0x5b313e(0x104))/0x4*(parseInt(_0x5b313e(0xfc))/0x5)+-parseInt(_0x5b313e(0xf3))/0x6*(parseInt(_0x5b313e(0xb7))/0x7)+-parseInt(_0x5b313e(0xb9))/0x8*(-parseInt(_0x5b313e(0x10d))/0x9)+parseInt(_0x5b313e(0xd3))/0xa*(-parseInt(_0x5b313e(0xe0))/0xb)+-parseInt(_0x5b313e(0xc1))/0xc;if(_0x1cb7eb===_0x5cdb08)break;else _0x47477a['push'](_0x47477a['shift']());}catch(_0x3557b3){_0x47477a['push'](_0x47477a['shift']());}}}(a13_0x323e,0x1c246));var __createBinding=this&&this[a13_0xa2d4ca(0xe4)]||(Object[a13_0xa2d4ca(0xdf)]?function(_0x57bcd2,_0x50e009,_0x36f046,_0x2411f6){const _0x42b99d=a13_0xa2d4ca;if(_0x2411f6===undefined)_0x2411f6=_0x36f046;var _0x4e97cf=Object[_0x42b99d(0xa9)](_0x50e009,_0x36f046);(!_0x4e97cf||(_0x42b99d(0xcd)in _0x4e97cf?!_0x50e009['__esModule']:_0x4e97cf[_0x42b99d(0xb0)]||_0x4e97cf[_0x42b99d(0xf4)]))&&(_0x4e97cf={'enumerable':!![],'get':function(){return _0x50e009[_0x36f046];}}),Object['defineProperty'](_0x57bcd2,_0x2411f6,_0x4e97cf);}:function(_0x4ab6ef,_0x28b960,_0x5b4c05,_0x8e1b1b){if(_0x8e1b1b===undefined)_0x8e1b1b=_0x5b4c05;_0x4ab6ef[_0x8e1b1b]=_0x28b960[_0x5b4c05];}),__setModuleDefault=this&&this[a13_0xa2d4ca(0xb4)]||(Object[a13_0xa2d4ca(0xdf)]?function(_0x5afcb7,_0x5c3d48){const _0x4eaa87=a13_0xa2d4ca;Object[_0x4eaa87(0xe5)](_0x5afcb7,_0x4eaa87(0xfd),{'enumerable':!![],'value':_0x5c3d48});}:function(_0x3feeb3,_0x3ead19){_0x3feeb3['default']=_0x3ead19;}),__importStar=this&&this[a13_0xa2d4ca(0x10f)]||(function(){var _0x3bba06=function(_0x1533a0){return _0x3bba06=Object['getOwnPropertyNames']||function(_0x2cbc66){const _0x2cbea6=a13_0x20fd;var _0x2571c5=[];for(var _0x194493 in _0x2cbc66)if(Object[_0x2cbea6(0xcc)]['hasOwnProperty']['call'](_0x2cbc66,_0x194493))_0x2571c5[_0x2571c5[_0x2cbea6(0xb3)]]=_0x194493;return _0x2571c5;},_0x3bba06(_0x1533a0);};return function(_0x5d4fcd){const _0x1cc246=a13_0x20fd;if(_0x5d4fcd&&_0x5d4fcd[_0x1cc246(0xd5)])return _0x5d4fcd;var _0x501c63={};if(_0x5d4fcd!=null){for(var _0x31b985=_0x3bba06(_0x5d4fcd),_0x29cced=0x0;_0x29cced<_0x31b985[_0x1cc246(0xb3)];_0x29cced++)if(_0x31b985[_0x29cced]!==_0x1cc246(0xfd))__createBinding(_0x501c63,_0x5d4fcd,_0x31b985[_0x29cced]);}return __setModuleDefault(_0x501c63,_0x5d4fcd),_0x501c63;};}()),__importDefault=this&&this[a13_0xa2d4ca(0xfb)]||function(_0x3e5f80){const _0x47f69a=a13_0xa2d4ca;return _0x3e5f80&&_0x3e5f80[_0x47f69a(0xd5)]?_0x3e5f80:{'default':_0x3e5f80};};Object[a13_0xa2d4ca(0xe5)](exports,a13_0xa2d4ca(0xd5),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require('../services/gateways/testGatewayService'),webhookService_1=require(a13_0xa2d4ca(0xed)),database_1=__importDefault(require('../config/database'));function a13_0x323e(){const _0x2ee0a8=['application/json','writable','now','ðŸ§ª\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','length','__setModuleDefault','PAID','update','14pOgnJu','836pUsqbg','40yAHsgf','gatewayOrderId','findUnique','../services/telegramBotService','failureMessage','Any\x20future\x20date\x20(MM/YY)','webhookLog','webhookEvents','15300WVzcaj','sendPaymentStatusNotification','526587rkxaLs','âœ…\x20Test\x20Gateway\x20payment\x20','processCard','Payment\x20to\x20','Any\x203-4\x20digits','\x20not\x20enabled\x20for\x20shop\x20','failUrl','includes','amount','prototype','get','paid','processCardPayment','toISOString','Payment\x20is\x20not\x20for\x20test\x20gateway','shop','325480nQLuyR','isArray','__esModule','shopId','cardLast4','replace','error','Payment\x20status\x20is\x20','TestGatewayService','0000','getPaymentForm','json','create','33WbjocZ','webhookService','WebhookService','paidAt','__createBinding','defineProperty','\x20processed:\x20','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ§ª\x20Test\x20Gateway\x20result:','gateway','parse','paymentMethod','../services/webhookService','testGatewayService','\x20with\x20status\x20','test_gateway','log','createdAt','379410TQgBgw','configurable','test_card','PENDING',',\x20cannot\x20process','Any\x20name','FAILED','successUrl','__importDefault','2740wzDcsX','default','status','slice','Error\x20parsing\x20webhook\x20events:','transactionId','cardNumber','4242\x204242\x204242\x204242','604uRQVJR','failureReason','Payment\x20not\x20found','Test\x20Gateway\x20webhook\x20sent\x20to\x20','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','toLowerCase','186oiPCYo','body','payment','288234OeHyCV','name','__importStar','customerName','ðŸ§ª\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','customerEmail','currency','payment.failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.success','TestGatewayController','getOwnPropertyDescriptor','stringify','Any\x20other\x20card\x20number','resolve','params','sendShopWebhook'];a13_0x323e=function(){return _0x2ee0a8;};return a13_0x323e();}class TestGatewayController{constructor(){const _0x483af3=a13_0xa2d4ca;this[_0x483af3(0xdd)]=async(_0x3e762c,_0x10f092,_0x271f14)=>{const _0x19e476=_0x483af3;try{const {paymentId:_0x57d77f}=_0x3e762c[_0x19e476(0xad)];console[_0x19e476(0xf1)](_0x19e476(0xb2)+_0x57d77f);const _0x15e56f=await database_1[_0x19e476(0xfd)][_0x19e476(0x10c)][_0x19e476(0xbb)]({'where':{'id':_0x57d77f},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x15e56f)return _0x10f092[_0x19e476(0xfe)](0x194)[_0x19e476(0xde)]({'success':![],'message':_0x19e476(0x106)});if(_0x15e56f[_0x19e476(0xea)]!==_0x19e476(0xf0))return _0x10f092['status'](0x190)['json']({'success':![],'message':_0x19e476(0xd1)});if(_0x15e56f[_0x19e476(0xfe)]!==_0x19e476(0xf6))return _0x10f092[_0x19e476(0xfe)](0x190)['json']({'success':![],'message':_0x19e476(0xda)+_0x15e56f[_0x19e476(0xfe)]+_0x19e476(0xf7)});_0x10f092[_0x19e476(0xde)]({'success':!![],'result':{'paymentId':_0x15e56f['id'],'orderId':_0x15e56f[_0x19e476(0xba)],'amount':_0x15e56f[_0x19e476(0xcb)],'currency':_0x15e56f[_0x19e476(0xa4)],'merchantName':_0x15e56f[_0x19e476(0xd2)][_0x19e476(0x10e)],'description':_0x19e476(0xc6)+_0x15e56f['shop'][_0x19e476(0x10e)],'testInstructions':{'successCard':_0x19e476(0x103),'failureCard':_0x19e476(0xab),'expiryDate':_0x19e476(0xbe),'cvc':_0x19e476(0xc7),'holderName':_0x19e476(0xf8)}}});}catch(_0x4438c0){_0x271f14(_0x4438c0);}},this[_0x483af3(0xc5)]=async(_0x520b4b,_0x5442a5,_0x46c05d)=>{const _0x1a6580=_0x483af3;try{const {paymentId:_0x1a255d}=_0x520b4b[_0x1a6580(0xad)],_0x5d3f3e=_0x520b4b[_0x1a6580(0x10b)];console[_0x1a6580(0xf1)](_0x1a6580(0x111)+_0x1a255d);const _0x48304b=await database_1[_0x1a6580(0xfd)][_0x1a6580(0x10c)][_0x1a6580(0xbb)]({'where':{'id':_0x1a255d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x48304b)return _0x5442a5['status'](0x194)[_0x1a6580(0xde)]({'success':![],'message':_0x1a6580(0x106)});if(_0x48304b[_0x1a6580(0xea)]!==_0x1a6580(0xf0))return _0x5442a5[_0x1a6580(0xfe)](0x190)[_0x1a6580(0xde)]({'success':![],'message':_0x1a6580(0xd1)});if(_0x48304b[_0x1a6580(0xfe)]!==_0x1a6580(0xf6))return _0x5442a5['status'](0x190)[_0x1a6580(0xde)]({'success':![],'message':_0x1a6580(0xda)+_0x48304b[_0x1a6580(0xfe)]+_0x1a6580(0xf7)});const _0x3f843f=await this[_0x1a6580(0xee)][_0x1a6580(0xcf)]({'paymentId':_0x48304b['id'],'orderId':_0x48304b[_0x1a6580(0xba)]||_0x48304b['id'],'amount':_0x48304b[_0x1a6580(0xcb)],'currency':_0x48304b[_0x1a6580(0xa4)],'cardData':_0x5d3f3e});console['log'](_0x1a6580(0xe9),_0x3f843f);const _0x31e6ad={'status':_0x3f843f['status'],'updatedAt':new Date()};if(_0x3f843f[_0x1a6580(0xfe)]===_0x1a6580(0xb5))_0x31e6ad[_0x1a6580(0xe3)]=new Date(),_0x31e6ad['gatewayPaymentId']=_0x3f843f['transactionId'];else _0x3f843f['status']===_0x1a6580(0xf9)&&(_0x31e6ad[_0x1a6580(0xbd)]=_0x3f843f['failureReason']);const _0x3031ec=_0x5d3f3e[_0x1a6580(0x102)][_0x1a6580(0xd8)](/[\s-]/g,'');_0x31e6ad[_0x1a6580(0xd7)]=_0x3031ec[_0x1a6580(0xff)](-0x4),_0x31e6ad[_0x1a6580(0xec)]=_0x1a6580(0xf5),await database_1[_0x1a6580(0xfd)][_0x1a6580(0x10c)][_0x1a6580(0xb6)]({'where':{'id':_0x48304b['id']},'data':_0x31e6ad}),await database_1[_0x1a6580(0xfd)][_0x1a6580(0xbf)][_0x1a6580(0xdf)]({'data':{'paymentId':_0x48304b['id'],'shopId':_0x48304b['shopId'],'event':'test_gateway_'+_0x3f843f['status'][_0x1a6580(0x109)](),'statusCode':0xc8,'responseBody':JSON[_0x1a6580(0xaa)]({'oldStatus':'PENDING','newStatus':_0x3f843f[_0x1a6580(0xfe)],'transactionId':_0x3f843f['transactionId'],'failureReason':_0x3f843f[_0x1a6580(0x105)],'processedAt':new Date()[_0x1a6580(0xd0)]()})}}),await this[_0x1a6580(0xae)](_0x48304b,_0x3f843f[_0x1a6580(0xfe)],_0x3f843f[_0x1a6580(0x101)],_0x3f843f['failureReason']),await this[_0x1a6580(0xc2)](_0x48304b,_0x3f843f['status']),console[_0x1a6580(0xf1)](_0x1a6580(0xc4)+_0x1a255d+_0x1a6580(0xe6)+_0x3f843f[_0x1a6580(0xfe)]),_0x3f843f[_0x1a6580(0xfe)]===_0x1a6580(0xb5)?_0x5442a5['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1a6580(0xb5),'transactionId':_0x3f843f[_0x1a6580(0x101)],'redirectUrl':_0x48304b[_0x1a6580(0xfa)]}}):_0x5442a5[_0x1a6580(0xfe)](0x190)[_0x1a6580(0xde)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x1a6580(0xf9),'failureReason':_0x3f843f['failureReason'],'redirectUrl':_0x48304b[_0x1a6580(0xc9)]}});}catch(_0x7e38e2){_0x46c05d(_0x7e38e2);}},this['testGatewayService']=new testGatewayService_1[(_0x483af3(0xdb))](),this[_0x483af3(0xe1)]=new webhookService_1[(_0x483af3(0xe2))]();}async[a13_0xa2d4ca(0xae)](_0x4f8847,_0x3ef48c,_0x4f3959,_0x167f87){const _0x8bd067=a13_0xa2d4ca,_0xe991c8=Date[_0x8bd067(0xb1)]();try{const _0x5cccc=_0x4f8847[_0x8bd067(0xd2)],_0x3bcfda=_0x5cccc['settings'];if(!_0x3bcfda?.[_0x8bd067(0xe7)]){console[_0x8bd067(0xf1)](_0x8bd067(0xa6)+_0x5cccc['id']);return;}const _0x4a30d0=_0x3ef48c===_0x8bd067(0xb5)?_0x8bd067(0xa7):_0x8bd067(0xa5);let _0xad8e59=[];if(_0x3bcfda[_0x8bd067(0xc0)])try{_0xad8e59=Array[_0x8bd067(0xd4)](_0x3bcfda[_0x8bd067(0xc0)])?_0x3bcfda[_0x8bd067(0xc0)]:JSON[_0x8bd067(0xeb)](_0x3bcfda[_0x8bd067(0xc0)]);}catch(_0xd652b9){console[_0x8bd067(0xd9)](_0x8bd067(0x100),_0xd652b9),_0xad8e59=[];}if(!_0xad8e59[_0x8bd067(0xca)](_0x4a30d0)){console['log']('Webhook\x20event\x20'+_0x4a30d0+_0x8bd067(0xc8)+_0x5cccc['id']);return;}const _0x144318={'event':_0x4a30d0,'payment':{'id':_0x4f8847['id'],'order_id':_0x4f8847['orderId'],'gateway_order_id':_0x4f8847[_0x8bd067(0xba)],'gateway':_0x8bd067(0xdc),'amount':_0x4f8847[_0x8bd067(0xcb)],'currency':_0x4f8847[_0x8bd067(0xa4)],'status':_0x3ef48c[_0x8bd067(0x109)](),'customer_email':_0x4f8847[_0x8bd067(0x112)],'customer_name':_0x4f8847[_0x8bd067(0x110)],'transaction_id':_0x4f3959,'failure_message':_0x167f87,'created_at':_0x4f8847[_0x8bd067(0xf2)],'updated_at':new Date()}},_0x2aa392=await fetch(_0x3bcfda['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x8bd067(0xaf),'User-Agent':_0x8bd067(0x108)},'body':JSON[_0x8bd067(0xaa)](_0x144318)}),_0x21df60=Date['now']()-_0xe991c8;console[_0x8bd067(0xf1)](_0x8bd067(0x107)+_0x3bcfda[_0x8bd067(0xe7)]+_0x8bd067(0xef)+_0x2aa392['status']+'\x20('+_0x21df60+'ms)');}catch(_0x44febf){console[_0x8bd067(0xd9)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x44febf);}}async[a13_0xa2d4ca(0xc2)](_0x220d99,_0x3e1874){const _0x406f3b=a13_0xa2d4ca;try{const {telegramBotService:_0x19e45d}=await Promise[_0x406f3b(0xac)]()['then'](()=>__importStar(require(_0x406f3b(0xbc)))),_0x1cb1ae={'PAID':_0x406f3b(0xce),'FAILED':'failed'},_0x3ffbc5=_0x1cb1ae[_0x3e1874];if(!_0x3ffbc5)return;await _0x19e45d['sendPaymentNotification'](_0x220d99[_0x406f3b(0xd6)],_0x220d99,_0x3ffbc5);}catch(_0x14c125){console[_0x406f3b(0xd9)](_0x406f3b(0xe8),_0x14c125);}}}exports[a13_0xa2d4ca(0xa8)]=TestGatewayController;