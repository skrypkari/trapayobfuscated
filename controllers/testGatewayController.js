'use strict';const a13_0x53d5f7=a13_0x1228;(function(_0x25ce8a,_0x3ac545){const _0x256b30=a13_0x1228,_0x2f2818=_0x25ce8a();while(!![]){try{const _0x1678df=parseInt(_0x256b30(0x1d9))/0x1+parseInt(_0x256b30(0x184))/0x2*(-parseInt(_0x256b30(0x1f9))/0x3)+parseInt(_0x256b30(0x1c8))/0x4*(-parseInt(_0x256b30(0x18f))/0x5)+parseInt(_0x256b30(0x191))/0x6*(-parseInt(_0x256b30(0x1a4))/0x7)+parseInt(_0x256b30(0x1ab))/0x8*(-parseInt(_0x256b30(0x1a7))/0x9)+parseInt(_0x256b30(0x1cf))/0xa+parseInt(_0x256b30(0x1ce))/0xb;if(_0x1678df===_0x3ac545)break;else _0x2f2818['push'](_0x2f2818['shift']());}catch(_0x2d9c5a){_0x2f2818['push'](_0x2f2818['shift']());}}}(a13_0x7894,0x4b49a));function a13_0x1228(_0x502893,_0x204813){const _0x78948e=a13_0x7894();return a13_0x1228=function(_0x122820,_0x24b427){_0x122820=_0x122820-0x183;let _0x2043b2=_0x78948e[_0x122820];return _0x2043b2;},a13_0x1228(_0x502893,_0x204813);}var __createBinding=this&&this[a13_0x53d5f7(0x199)]||(Object[a13_0x53d5f7(0x1bf)]?function(_0x482719,_0x4836ea,_0x17a67,_0xc2b120){const _0x5d4aa6=a13_0x53d5f7;if(_0xc2b120===undefined)_0xc2b120=_0x17a67;var _0x5c0c18=Object[_0x5d4aa6(0x19c)](_0x4836ea,_0x17a67);(!_0x5c0c18||(_0x5d4aa6(0x1a5)in _0x5c0c18?!_0x4836ea[_0x5d4aa6(0x1b2)]:_0x5c0c18[_0x5d4aa6(0x1f4)]||_0x5c0c18[_0x5d4aa6(0x1e3)]))&&(_0x5c0c18={'enumerable':!![],'get':function(){return _0x4836ea[_0x17a67];}}),Object[_0x5d4aa6(0x1b3)](_0x482719,_0xc2b120,_0x5c0c18);}:function(_0x52f6c7,_0x16636e,_0x3a38a8,_0x43c047){if(_0x43c047===undefined)_0x43c047=_0x3a38a8;_0x52f6c7[_0x43c047]=_0x16636e[_0x3a38a8];}),__setModuleDefault=this&&this[a13_0x53d5f7(0x1d3)]||(Object[a13_0x53d5f7(0x1bf)]?function(_0x1bed60,_0x582df6){const _0x540c0f=a13_0x53d5f7;Object[_0x540c0f(0x1b3)](_0x1bed60,_0x540c0f(0x1c9),{'enumerable':!![],'value':_0x582df6});}:function(_0xf8c0da,_0x1a21b6){const _0x2d4cde=a13_0x53d5f7;_0xf8c0da[_0x2d4cde(0x1c9)]=_0x1a21b6;}),__importStar=this&&this[a13_0x53d5f7(0x1b4)]||(function(){var _0x516d17=function(_0x2fc255){const _0xeed8e2=a13_0x1228;return _0x516d17=Object[_0xeed8e2(0x1d5)]||function(_0x3ca0f1){const _0x45703c=_0xeed8e2;var _0x95fdb7=[];for(var _0x59b428 in _0x3ca0f1)if(Object[_0x45703c(0x1d2)][_0x45703c(0x1dc)][_0x45703c(0x1cb)](_0x3ca0f1,_0x59b428))_0x95fdb7[_0x95fdb7[_0x45703c(0x1f8)]]=_0x59b428;return _0x95fdb7;},_0x516d17(_0x2fc255);};return function(_0x29f435){const _0x5b8935=a13_0x1228;if(_0x29f435&&_0x29f435[_0x5b8935(0x1b2)])return _0x29f435;var _0x1660c9={};if(_0x29f435!=null){for(var _0x2fd894=_0x516d17(_0x29f435),_0x33fc22=0x0;_0x33fc22<_0x2fd894[_0x5b8935(0x1f8)];_0x33fc22++)if(_0x2fd894[_0x33fc22]!==_0x5b8935(0x1c9))__createBinding(_0x1660c9,_0x29f435,_0x2fd894[_0x33fc22]);}return __setModuleDefault(_0x1660c9,_0x29f435),_0x1660c9;};}()),__importDefault=this&&this['__importDefault']||function(_0x414372){const _0x335a88=a13_0x53d5f7;return _0x414372&&_0x414372[_0x335a88(0x1b2)]?_0x414372:{'default':_0x414372};};function a13_0x7894(){const _0x47357a=['slice','6122402bIXFYl','3874250DJeFoj','json','findUnique','prototype','__setModuleDefault','paymentLinkId','getOwnPropertyNames','getPaymentForm','failureMessage','$transaction','63252YVrpTx','currency','../services/telegramBotService','hasOwnProperty','4242\x204242\x204242\x204242','test_card','🧪\x20Test\x20Gateway\x20result:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','\x20processed:\x20','configurable','parse','../config/database','processCard','payment','settings','application/json','POST','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Any\x203-4\x20digits','gatewayPaymentId','../services/gateways/testGatewayService','successUrl','shop','failureReason','log','update','writable','webhookLog','name','includes','length','687RfxVhG','PENDING','80gWjBOK','Payment\x20is\x20not\x20for\x20test\x20gateway','createdAt','Payment\x20processed\x20successfully','payment.failed','FAILED','Payment\x20not\x20found','stringify','COMPLETED','✅\x20Test\x20Gateway\x20payment\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','5VbcRtw','PAID','18gURbSb','payment.success','0000','webhookEvents','gateway',',\x20status=','✅\x20Payment\x20link\x20','paid','__createBinding','gatewayOrderId','❌\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','getOwnPropertyDescriptor','test_gateway','type','WebhookService','Error\x20parsing\x20webhook\x20events:','resolve','paymentMethod','\x20not\x20found','87199sxVUEj','get','Payment\x20failed','4322907UDzjaj','\x20updated:\x20currentPayments=','params','toLowerCase','8hHFTJI','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','\x20with\x20status\x20','error','\x20->\x20','testGatewayService','sendPaymentStatusNotification','__esModule','defineProperty','__importStar','cardNumber','🧪\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','orderId','transactionId','failed','shopId','webhookService','paymentLink',':\x20type=','test_gateway_','create',',\x20cannot\x20process','amount','❌\x20Payment\x20link\x20','status','../services/webhookService','Payment\x20to\x20','currentPayments','📈\x20Found\x20payment\x20link\x20','688108DrjxIj','default','Payment\x20status\x20is\x20','call','cardLast4'];a13_0x7894=function(){return _0x47357a;};return a13_0x7894();}Object[a13_0x53d5f7(0x1b3)](exports,a13_0x53d5f7(0x1b2),{'value':!![]}),exports['TestGatewayController']=void 0x0;const testGatewayService_1=require(a13_0x53d5f7(0x1ee)),webhookService_1=require(a13_0x53d5f7(0x1c4)),database_1=__importDefault(require(a13_0x53d5f7(0x1e5)));class TestGatewayController{constructor(){const _0x33172f=a13_0x53d5f7;this[_0x33172f(0x1d6)]=async(_0x571536,_0x4fa827,_0x2cdb45)=>{const _0x5080d7=_0x33172f;try{const {paymentId:_0x2e2009}=_0x571536['params'];console['log']('🧪\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20'+_0x2e2009);const _0x51b648=await database_1['default']['payment'][_0x5080d7(0x1d1)]({'where':{'id':_0x2e2009},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x51b648)return _0x4fa827[_0x5080d7(0x1c3)](0x194)[_0x5080d7(0x1d0)]({'success':![],'message':_0x5080d7(0x18a)});if(_0x51b648[_0x5080d7(0x195)]!==_0x5080d7(0x19d))return _0x4fa827['status'](0x190)[_0x5080d7(0x1d0)]({'success':![],'message':_0x5080d7(0x185)});if(_0x51b648[_0x5080d7(0x1c3)]!==_0x5080d7(0x183))return _0x4fa827['status'](0x190)['json']({'success':![],'message':_0x5080d7(0x1ca)+_0x51b648[_0x5080d7(0x1c3)]+',\x20cannot\x20process'});_0x4fa827[_0x5080d7(0x1d0)]({'success':!![],'result':{'paymentId':_0x51b648['id'],'orderId':_0x51b648['gatewayOrderId'],'amount':_0x51b648[_0x5080d7(0x1c1)],'currency':_0x51b648[_0x5080d7(0x1da)],'merchantName':_0x51b648[_0x5080d7(0x1f0)]['name'],'description':_0x5080d7(0x1c5)+_0x51b648[_0x5080d7(0x1f0)][_0x5080d7(0x1f6)],'testInstructions':{'successCard':_0x5080d7(0x1dd),'failureCard':'Any\x20other\x20card\x20number','expiryDate':'Any\x20future\x20date\x20(MM/YY)','cvc':_0x5080d7(0x1ec),'holderName':'Any\x20name'}}});}catch(_0x12e6b9){_0x2cdb45(_0x12e6b9);}},this[_0x33172f(0x1e6)]=async(_0x327f33,_0x4a1fb2,_0x4a36b7)=>{const _0x38e925=_0x33172f;try{const {paymentId:_0x191d4a}=_0x327f33[_0x38e925(0x1a9)],_0x2e6f0e=_0x327f33['body'];console[_0x38e925(0x1f2)](_0x38e925(0x1b6)+_0x191d4a);const _0x365814=await database_1[_0x38e925(0x1c9)][_0x38e925(0x1e7)]['findUnique']({'where':{'id':_0x191d4a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x365814)return _0x4a1fb2[_0x38e925(0x1c3)](0x194)[_0x38e925(0x1d0)]({'success':![],'message':_0x38e925(0x18a)});if(_0x365814[_0x38e925(0x195)]!==_0x38e925(0x19d))return _0x4a1fb2[_0x38e925(0x1c3)](0x190)['json']({'success':![],'message':_0x38e925(0x185)});if(_0x365814[_0x38e925(0x1c3)]!=='PENDING')return _0x4a1fb2[_0x38e925(0x1c3)](0x190)[_0x38e925(0x1d0)]({'success':![],'message':_0x38e925(0x1ca)+_0x365814[_0x38e925(0x1c3)]+_0x38e925(0x1c0)});const _0x8a0fb6=await this['testGatewayService']['processCardPayment']({'paymentId':_0x365814['id'],'orderId':_0x365814[_0x38e925(0x19a)]||_0x365814['id'],'amount':_0x365814['amount'],'currency':_0x365814[_0x38e925(0x1da)],'cardData':_0x2e6f0e});console[_0x38e925(0x1f2)](_0x38e925(0x1df),_0x8a0fb6);const _0x3325fd={'status':_0x8a0fb6[_0x38e925(0x1c3)],'updatedAt':new Date()};if(_0x8a0fb6[_0x38e925(0x1c3)]===_0x38e925(0x190))_0x3325fd['paidAt']=new Date(),_0x3325fd[_0x38e925(0x1ed)]=_0x8a0fb6[_0x38e925(0x1b8)];else _0x8a0fb6[_0x38e925(0x1c3)]===_0x38e925(0x189)&&(_0x3325fd[_0x38e925(0x1d7)]=_0x8a0fb6[_0x38e925(0x1f1)]);const _0x362183=_0x2e6f0e[_0x38e925(0x1b5)]['replace'](/[\s-]/g,'');_0x3325fd[_0x38e925(0x1cc)]=_0x362183[_0x38e925(0x1cd)](-0x4),_0x3325fd[_0x38e925(0x1a2)]=_0x38e925(0x1de),await database_1[_0x38e925(0x1c9)]['payment'][_0x38e925(0x1f3)]({'where':{'id':_0x365814['id']},'data':_0x3325fd});if(_0x8a0fb6[_0x38e925(0x1c3)]===_0x38e925(0x190)&&_0x365814['paymentLinkId']){console[_0x38e925(0x1f2)]('📈\x20Test\x20Gateway:\x20Payment\x20'+_0x365814['id']+_0x38e925(0x18e));try{await database_1[_0x38e925(0x1c9)][_0x38e925(0x1d8)](async _0x44c67f=>{const _0x2163b0=_0x38e925,_0x3757f0=await _0x44c67f[_0x2163b0(0x1bc)][_0x2163b0(0x1d1)]({'where':{'id':_0x365814[_0x2163b0(0x1d4)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x3757f0){console[_0x2163b0(0x1f2)](_0x2163b0(0x1c7)+_0x3757f0['id']+_0x2163b0(0x1bd)+_0x3757f0[_0x2163b0(0x19e)]+',\x20currentPayments='+_0x3757f0['currentPayments']+',\x20status='+_0x3757f0[_0x2163b0(0x1c3)]);const _0x50fe89=_0x3757f0[_0x2163b0(0x1c6)]+0x1,_0x27eeb2=_0x3757f0['type']==='SINGLE'?_0x2163b0(0x18c):_0x3757f0['status'];await _0x44c67f['paymentLink'][_0x2163b0(0x1f3)]({'where':{'id':_0x365814['paymentLinkId']},'data':{'currentPayments':_0x50fe89,'status':_0x27eeb2,'updatedAt':new Date()}}),console[_0x2163b0(0x1f2)](_0x2163b0(0x197)+_0x3757f0['id']+_0x2163b0(0x1a8)+_0x3757f0[_0x2163b0(0x1c6)]+_0x2163b0(0x1af)+_0x50fe89+_0x2163b0(0x196)+_0x3757f0[_0x2163b0(0x1c3)]+_0x2163b0(0x1af)+_0x27eeb2);}else console['log'](_0x2163b0(0x1c2)+_0x365814[_0x2163b0(0x1d4)]+_0x2163b0(0x1a3));});}catch(_0x4ea7fe){console[_0x38e925(0x1ae)](_0x38e925(0x19b),_0x4ea7fe);}}await database_1[_0x38e925(0x1c9)][_0x38e925(0x1f5)][_0x38e925(0x1bf)]({'data':{'paymentId':_0x365814['id'],'shopId':_0x365814[_0x38e925(0x1ba)],'event':_0x38e925(0x1be)+_0x8a0fb6[_0x38e925(0x1c3)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x38e925(0x18b)]({'oldStatus':_0x38e925(0x183),'newStatus':_0x8a0fb6[_0x38e925(0x1c3)],'transactionId':_0x8a0fb6['transactionId'],'failureReason':_0x8a0fb6[_0x38e925(0x1f1)],'processedAt':new Date()['toISOString']()})}}),await this['sendShopWebhook'](_0x365814,_0x8a0fb6['status'],_0x8a0fb6[_0x38e925(0x1b8)],_0x8a0fb6[_0x38e925(0x1f1)]),await this[_0x38e925(0x1b1)](_0x365814,_0x8a0fb6['status']),console['log'](_0x38e925(0x18d)+_0x191d4a+_0x38e925(0x1e2)+_0x8a0fb6[_0x38e925(0x1c3)]),_0x8a0fb6[_0x38e925(0x1c3)]===_0x38e925(0x190)?_0x4a1fb2[_0x38e925(0x1d0)]({'success':!![],'message':_0x38e925(0x187),'result':{'status':_0x38e925(0x190),'transactionId':_0x8a0fb6[_0x38e925(0x1b8)],'redirectUrl':_0x365814[_0x38e925(0x1ef)]}}):_0x4a1fb2[_0x38e925(0x1c3)](0x190)[_0x38e925(0x1d0)]({'success':![],'message':_0x38e925(0x1a6),'result':{'status':_0x38e925(0x189),'failureReason':_0x8a0fb6['failureReason'],'redirectUrl':_0x365814['failUrl']}});}catch(_0x285e66){_0x4a36b7(_0x285e66);}},this[_0x33172f(0x1b0)]=new testGatewayService_1['TestGatewayService'](),this[_0x33172f(0x1bb)]=new webhookService_1[(_0x33172f(0x19f))]();}async['sendShopWebhook'](_0x9bb41e,_0x54eb59,_0x236e87,_0x493554){const _0x22aec0=a13_0x53d5f7,_0x20cce4=Date['now']();try{const _0x3775e8=_0x9bb41e[_0x22aec0(0x1f0)],_0x53b65d=_0x3775e8[_0x22aec0(0x1e8)];if(!_0x53b65d?.[_0x22aec0(0x1e1)]){console[_0x22aec0(0x1f2)](_0x22aec0(0x1e0)+_0x3775e8['id']);return;}const _0x554849=_0x54eb59===_0x22aec0(0x190)?_0x22aec0(0x192):_0x22aec0(0x188);let _0x392950=[];if(_0x53b65d[_0x22aec0(0x194)])try{_0x392950=Array['isArray'](_0x53b65d[_0x22aec0(0x194)])?_0x53b65d[_0x22aec0(0x194)]:JSON[_0x22aec0(0x1e4)](_0x53b65d[_0x22aec0(0x194)]);}catch(_0x4bbe1a){console[_0x22aec0(0x1ae)](_0x22aec0(0x1a0),_0x4bbe1a),_0x392950=[];}if(!_0x392950[_0x22aec0(0x1f7)](_0x554849)){console[_0x22aec0(0x1f2)]('Webhook\x20event\x20'+_0x554849+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3775e8['id']);return;}const _0x11cca6={'event':_0x554849,'payment':{'id':_0x9bb41e['id'],'order_id':_0x9bb41e[_0x22aec0(0x1b7)],'gateway_order_id':_0x9bb41e['gatewayOrderId'],'gateway':_0x22aec0(0x193),'amount':_0x9bb41e[_0x22aec0(0x1c1)],'currency':_0x9bb41e[_0x22aec0(0x1da)],'status':_0x54eb59[_0x22aec0(0x1aa)](),'customer_email':_0x9bb41e['customerEmail'],'customer_name':_0x9bb41e['customerName'],'transaction_id':_0x236e87,'failure_message':_0x493554,'created_at':_0x9bb41e[_0x22aec0(0x186)],'updated_at':new Date()}},_0x29d1ef=await fetch(_0x53b65d[_0x22aec0(0x1e1)],{'method':_0x22aec0(0x1ea),'headers':{'Content-Type':_0x22aec0(0x1e9),'User-Agent':_0x22aec0(0x1ac)},'body':JSON[_0x22aec0(0x18b)](_0x11cca6)}),_0x16b79d=Date['now']()-_0x20cce4;console[_0x22aec0(0x1f2)]('Test\x20Gateway\x20webhook\x20sent\x20to\x20'+_0x53b65d['webhookUrl']+_0x22aec0(0x1ad)+_0x29d1ef[_0x22aec0(0x1c3)]+'\x20('+_0x16b79d+'ms)');}catch(_0x1402c4){console[_0x22aec0(0x1ae)]('Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:',_0x1402c4);}}async[a13_0x53d5f7(0x1b1)](_0x11441b,_0x20bc77){const _0x11203d=a13_0x53d5f7;try{const {telegramBotService:_0x367ea1}=await Promise[_0x11203d(0x1a1)]()['then'](()=>__importStar(require(_0x11203d(0x1db)))),_0x60c230={'PAID':_0x11203d(0x198),'FAILED':_0x11203d(0x1b9)},_0x93719e=_0x60c230[_0x20bc77];if(!_0x93719e)return;await _0x367ea1['sendPaymentNotification'](_0x11441b[_0x11203d(0x1ba)],_0x11441b,_0x93719e);}catch(_0x394b87){console['error'](_0x11203d(0x1eb),_0x394b87);}}}exports['TestGatewayController']=TestGatewayController;