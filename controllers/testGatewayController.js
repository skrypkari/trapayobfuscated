'use strict';function a13_0x386d(){const _0x564fbd=['log','Payment\x20not\x20found','customerEmail','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','6624jxOvRw','transactionId','writable','successUrl','COMPLETED','../services/gateways/testGatewayService','settings','toLowerCase','$transaction','failureReason','sendShopWebhook','TestGatewayController','FAILED','Any\x20other\x20card\x20number','109244laoxmb',',\x20status=','application/json','11URwCBb','\x20->\x20','gatewayPaymentId','currentPayments','paymentLinkId','isArray','Failed\x20to\x20send\x20Test\x20Gateway\x20webhook:','cardNumber','Payment\x20processed\x20successfully','713872rUrDnh','üß™\x20Test\x20Gateway\x20result:','findUnique','status','cardLast4','call','resolve','paymentLink','getOwnPropertyDescriptor','Payment\x20to\x20','prototype','shop','amount','sendPaymentNotification','üìà\x20Found\x20payment\x20link\x20','Payment\x20status\x20is\x20','params','__importDefault','PAID','payment.success','../services/telegramBotService','__esModule','webhookEvents','replace','testGatewayService','test_gateway','defineProperty','configurable','\x20updated:\x20currentPayments=','205PmFOxZ','‚ùå\x20Payment\x20link\x20','Any\x20future\x20date\x20(MM/YY)','sendPaymentStatusNotification','orderId','__importStar','488XGHOpk','name','917757RhknPs','type','TesSoft\x20Payment\x20System/1.0\x20(Test\x20Gateway)','webhookService','createdAt',',\x20currentPayments=','paymentMethod','length','default','Test\x20Gateway\x20webhook\x20sent\x20to\x20','getPaymentForm','SINGLE','getOwnPropertyNames','processCardPayment','\x20not\x20enabled\x20for\x20shop\x20','stringify','paidAt','90181EBnfTT','TestGatewayService','üß™\x20Test\x20Gateway:\x20Getting\x20payment\x20form\x20for\x20','failureMessage','WebhookService',',\x20cannot\x20process','../config/database','shopId','1764220CVnNiB','includes','‚úÖ\x20Payment\x20link\x20','webhookLog','update','10160154CSxVdf','gatewayOrderId','currency','../services/webhookService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','gateway','test_card','paid','‚ùå\x20Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20test\x20gateway:','json','parse','üìà\x20Test\x20Gateway:\x20Payment\x20','__createBinding','get','error','payment','0000','payment.failed','customerName','PENDING','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','hasOwnProperty','now','webhookUrl','__setModuleDefault','Error\x20parsing\x20webhook\x20events:','4CGKZyo','\x20with\x20status\x20','create','üß™\x20Test\x20Gateway:\x20Processing\x20card\x20for\x20payment\x20','Payment\x20is\x20not\x20for\x20test\x20gateway'];a13_0x386d=function(){return _0x564fbd;};return a13_0x386d();}const a13_0xd8dfe0=a13_0x1c23;(function(_0x5c5e28,_0x198b41){const _0x510008=a13_0x1c23,_0x280a3a=_0x5c5e28();while(!![]){try{const _0x37839f=parseInt(_0x510008(0x1bf))/0x1+-parseInt(_0x510008(0x1b3))/0x2+-parseInt(_0x510008(0x1e4))/0x3*(parseInt(_0x510008(0x19c))/0x4)+parseInt(_0x510008(0x1dc))/0x5*(parseInt(_0x510008(0x1a5))/0x6)+parseInt(_0x510008(0x1f5))/0x7*(-parseInt(_0x510008(0x1e2))/0x8)+parseInt(_0x510008(0x182))/0x9+parseInt(_0x510008(0x17d))/0xa*(parseInt(_0x510008(0x1b6))/0xb);if(_0x37839f===_0x198b41)break;else _0x280a3a['push'](_0x280a3a['shift']());}catch(_0x15001f){_0x280a3a['push'](_0x280a3a['shift']());}}}(a13_0x386d,0xe022c));function a13_0x1c23(_0x13c766,_0x180c95){const _0x386d91=a13_0x386d();return a13_0x1c23=function(_0x1c232,_0x5b0a20){_0x1c232=_0x1c232-0x179;let _0x4d1230=_0x386d91[_0x1c232];return _0x4d1230;},a13_0x1c23(_0x13c766,_0x180c95);}var __createBinding=this&&this[a13_0xd8dfe0(0x18e)]||(Object['create']?function(_0x634a31,_0x2262dc,_0x397854,_0x291f9f){const _0xb4a5c4=a13_0xd8dfe0;if(_0x291f9f===undefined)_0x291f9f=_0x397854;var _0x3de20c=Object[_0xb4a5c4(0x1c7)](_0x2262dc,_0x397854);(!_0x3de20c||(_0xb4a5c4(0x18f)in _0x3de20c?!_0x2262dc['__esModule']:_0x3de20c[_0xb4a5c4(0x1a7)]||_0x3de20c[_0xb4a5c4(0x1da)]))&&(_0x3de20c={'enumerable':!![],'get':function(){return _0x2262dc[_0x397854];}}),Object['defineProperty'](_0x634a31,_0x291f9f,_0x3de20c);}:function(_0x4cedd5,_0x52d062,_0x168a6f,_0x4aa402){if(_0x4aa402===undefined)_0x4aa402=_0x168a6f;_0x4cedd5[_0x4aa402]=_0x52d062[_0x168a6f];}),__setModuleDefault=this&&this[a13_0xd8dfe0(0x19a)]||(Object[a13_0xd8dfe0(0x19e)]?function(_0x4481ba,_0x3050cc){Object['defineProperty'](_0x4481ba,'default',{'enumerable':!![],'value':_0x3050cc});}:function(_0x34eeb3,_0x361004){const _0x45de8f=a13_0xd8dfe0;_0x34eeb3[_0x45de8f(0x1ec)]=_0x361004;}),__importStar=this&&this[a13_0xd8dfe0(0x1e1)]||(function(){var _0x50aaeb=function(_0x50f066){const _0x47ba92=a13_0x1c23;return _0x50aaeb=Object[_0x47ba92(0x1f0)]||function(_0x3a2812){const _0xbd1a1e=_0x47ba92;var _0x4229f8=[];for(var _0x31e770 in _0x3a2812)if(Object[_0xbd1a1e(0x1c9)][_0xbd1a1e(0x197)][_0xbd1a1e(0x1c4)](_0x3a2812,_0x31e770))_0x4229f8[_0x4229f8[_0xbd1a1e(0x1eb)]]=_0x31e770;return _0x4229f8;},_0x50aaeb(_0x50f066);};return function(_0x11161b){const _0x1d0730=a13_0x1c23;if(_0x11161b&&_0x11161b[_0x1d0730(0x1d4)])return _0x11161b;var _0x142096={};if(_0x11161b!=null){for(var _0x89f1c=_0x50aaeb(_0x11161b),_0x1ab40b=0x0;_0x1ab40b<_0x89f1c[_0x1d0730(0x1eb)];_0x1ab40b++)if(_0x89f1c[_0x1ab40b]!=='default')__createBinding(_0x142096,_0x11161b,_0x89f1c[_0x1ab40b]);}return __setModuleDefault(_0x142096,_0x11161b),_0x142096;};}()),__importDefault=this&&this[a13_0xd8dfe0(0x1d0)]||function(_0x132b54){const _0x1c8889=a13_0xd8dfe0;return _0x132b54&&_0x132b54[_0x1c8889(0x1d4)]?_0x132b54:{'default':_0x132b54};};Object[a13_0xd8dfe0(0x1d9)](exports,a13_0xd8dfe0(0x1d4),{'value':!![]}),exports[a13_0xd8dfe0(0x1b0)]=void 0x0;const testGatewayService_1=require(a13_0xd8dfe0(0x1aa)),webhookService_1=require(a13_0xd8dfe0(0x185)),database_1=__importDefault(require(a13_0xd8dfe0(0x17b)));class TestGatewayController{constructor(){const _0x2af90e=a13_0xd8dfe0;this[_0x2af90e(0x1ee)]=async(_0x5872d1,_0x564f2f,_0x55f153)=>{const _0x5c9799=_0x2af90e;try{const {paymentId:_0x222195}=_0x5872d1[_0x5c9799(0x1cf)];console[_0x5c9799(0x1a1)](_0x5c9799(0x1f7)+_0x222195);const _0x2804e8=await database_1[_0x5c9799(0x1ec)][_0x5c9799(0x191)][_0x5c9799(0x1c1)]({'where':{'id':_0x222195},'include':{'shop':{'select':{'name':!![],'username':!![]}}}});if(!_0x2804e8)return _0x564f2f[_0x5c9799(0x1c2)](0x194)[_0x5c9799(0x18b)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2804e8[_0x5c9799(0x187)]!==_0x5c9799(0x1d8))return _0x564f2f[_0x5c9799(0x1c2)](0x190)[_0x5c9799(0x18b)]({'success':![],'message':_0x5c9799(0x1a0)});if(_0x2804e8[_0x5c9799(0x1c2)]!==_0x5c9799(0x195))return _0x564f2f['status'](0x190)[_0x5c9799(0x18b)]({'success':![],'message':_0x5c9799(0x1ce)+_0x2804e8[_0x5c9799(0x1c2)]+_0x5c9799(0x17a)});_0x564f2f[_0x5c9799(0x18b)]({'success':!![],'result':{'paymentId':_0x2804e8['id'],'orderId':_0x2804e8[_0x5c9799(0x183)],'amount':_0x2804e8[_0x5c9799(0x1cb)],'currency':_0x2804e8[_0x5c9799(0x184)],'merchantName':_0x2804e8['shop'][_0x5c9799(0x1e3)],'description':_0x5c9799(0x1c8)+_0x2804e8['shop'][_0x5c9799(0x1e3)],'testInstructions':{'successCard':'4242\x204242\x204242\x204242','failureCard':_0x5c9799(0x1b2),'expiryDate':_0x5c9799(0x1de),'cvc':'Any\x203-4\x20digits','holderName':'Any\x20name'}}});}catch(_0x5918df){_0x55f153(_0x5918df);}},this['processCard']=async(_0x58a605,_0x19efba,_0x52faca)=>{const _0x30b04a=_0x2af90e;try{const {paymentId:_0x31e0ba}=_0x58a605[_0x30b04a(0x1cf)],_0x582235=_0x58a605['body'];console[_0x30b04a(0x1a1)](_0x30b04a(0x19f)+_0x31e0ba);const _0x410bbd=await database_1[_0x30b04a(0x1ec)][_0x30b04a(0x191)][_0x30b04a(0x1c1)]({'where':{'id':_0x31e0ba},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x410bbd)return _0x19efba[_0x30b04a(0x1c2)](0x194)['json']({'success':![],'message':_0x30b04a(0x1a2)});if(_0x410bbd['gateway']!==_0x30b04a(0x1d8))return _0x19efba['status'](0x190)['json']({'success':![],'message':_0x30b04a(0x1a0)});if(_0x410bbd[_0x30b04a(0x1c2)]!=='PENDING')return _0x19efba[_0x30b04a(0x1c2)](0x190)[_0x30b04a(0x18b)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x410bbd[_0x30b04a(0x1c2)]+_0x30b04a(0x17a)});const _0x3a62a3=await this[_0x30b04a(0x1d7)][_0x30b04a(0x1f1)]({'paymentId':_0x410bbd['id'],'orderId':_0x410bbd[_0x30b04a(0x183)]||_0x410bbd['id'],'amount':_0x410bbd[_0x30b04a(0x1cb)],'currency':_0x410bbd[_0x30b04a(0x184)],'cardData':_0x582235});console['log'](_0x30b04a(0x1c0),_0x3a62a3);const _0x502cab={'status':_0x3a62a3['status'],'updatedAt':new Date()};if(_0x3a62a3[_0x30b04a(0x1c2)]===_0x30b04a(0x1d1))_0x502cab[_0x30b04a(0x1f4)]=new Date(),_0x502cab[_0x30b04a(0x1b8)]=_0x3a62a3[_0x30b04a(0x1a6)];else _0x3a62a3[_0x30b04a(0x1c2)]==='FAILED'&&(_0x502cab[_0x30b04a(0x1f8)]=_0x3a62a3[_0x30b04a(0x1ae)]);const _0x58124a=_0x582235[_0x30b04a(0x1bd)][_0x30b04a(0x1d6)](/[\s-]/g,'');_0x502cab[_0x30b04a(0x1c3)]=_0x58124a['slice'](-0x4),_0x502cab[_0x30b04a(0x1ea)]=_0x30b04a(0x188),await database_1[_0x30b04a(0x1ec)][_0x30b04a(0x191)][_0x30b04a(0x181)]({'where':{'id':_0x410bbd['id']},'data':_0x502cab});if(_0x3a62a3[_0x30b04a(0x1c2)]===_0x30b04a(0x1d1)&&_0x410bbd[_0x30b04a(0x1ba)]){console[_0x30b04a(0x1a1)](_0x30b04a(0x18d)+_0x410bbd['id']+_0x30b04a(0x196));try{await database_1[_0x30b04a(0x1ec)][_0x30b04a(0x1ad)](async _0x289e69=>{const _0x156d33=_0x30b04a,_0x562475=await _0x289e69['paymentLink']['findUnique']({'where':{'id':_0x410bbd[_0x156d33(0x1ba)]},'select':{'id':!![],'type':!![],'currentPayments':!![],'status':!![]}});if(_0x562475){console['log'](_0x156d33(0x1cd)+_0x562475['id']+':\x20type='+_0x562475['type']+_0x156d33(0x1e9)+_0x562475[_0x156d33(0x1b9)]+',\x20status='+_0x562475[_0x156d33(0x1c2)]);const _0x5f211e=_0x562475['currentPayments']+0x1,_0x30d179=_0x562475[_0x156d33(0x1e5)]===_0x156d33(0x1ef)?_0x156d33(0x1a9):_0x562475[_0x156d33(0x1c2)];await _0x289e69[_0x156d33(0x1c6)]['update']({'where':{'id':_0x410bbd[_0x156d33(0x1ba)]},'data':{'currentPayments':_0x5f211e,'status':_0x30d179,'updatedAt':new Date()}}),console[_0x156d33(0x1a1)](_0x156d33(0x17f)+_0x562475['id']+_0x156d33(0x1db)+_0x562475[_0x156d33(0x1b9)]+_0x156d33(0x1b7)+_0x5f211e+_0x156d33(0x1b4)+_0x562475['status']+_0x156d33(0x1b7)+_0x30d179);}else console[_0x156d33(0x1a1)](_0x156d33(0x1dd)+_0x410bbd[_0x156d33(0x1ba)]+'\x20not\x20found');});}catch(_0x53ad33){console[_0x30b04a(0x190)](_0x30b04a(0x18a),_0x53ad33);}}await database_1[_0x30b04a(0x1ec)][_0x30b04a(0x180)]['create']({'data':{'paymentId':_0x410bbd['id'],'shopId':_0x410bbd[_0x30b04a(0x17c)],'event':'test_gateway_'+_0x3a62a3[_0x30b04a(0x1c2)]['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x30b04a(0x1f3)]({'oldStatus':_0x30b04a(0x195),'newStatus':_0x3a62a3[_0x30b04a(0x1c2)],'transactionId':_0x3a62a3[_0x30b04a(0x1a6)],'failureReason':_0x3a62a3['failureReason'],'processedAt':new Date()['toISOString']()})}}),await this[_0x30b04a(0x1af)](_0x410bbd,_0x3a62a3['status'],_0x3a62a3[_0x30b04a(0x1a6)],_0x3a62a3[_0x30b04a(0x1ae)]),await this[_0x30b04a(0x1df)](_0x410bbd,_0x3a62a3[_0x30b04a(0x1c2)]),console[_0x30b04a(0x1a1)]('‚úÖ\x20Test\x20Gateway\x20payment\x20'+_0x31e0ba+'\x20processed:\x20'+_0x3a62a3[_0x30b04a(0x1c2)]),_0x3a62a3[_0x30b04a(0x1c2)]==='PAID'?_0x19efba[_0x30b04a(0x18b)]({'success':!![],'message':_0x30b04a(0x1be),'result':{'status':_0x30b04a(0x1d1),'transactionId':_0x3a62a3['transactionId'],'redirectUrl':_0x410bbd[_0x30b04a(0x1a8)]}}):_0x19efba[_0x30b04a(0x1c2)](0x190)[_0x30b04a(0x18b)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x30b04a(0x1b1),'failureReason':_0x3a62a3[_0x30b04a(0x1ae)],'redirectUrl':_0x410bbd['failUrl']}});}catch(_0x59617f){_0x52faca(_0x59617f);}},this[_0x2af90e(0x1d7)]=new testGatewayService_1[(_0x2af90e(0x1f6))](),this[_0x2af90e(0x1e7)]=new webhookService_1[(_0x2af90e(0x179))]();}async['sendShopWebhook'](_0x38efcf,_0x417c85,_0x29be02,_0x34d138){const _0xf5763b=a13_0xd8dfe0,_0x30be84=Date[_0xf5763b(0x198)]();try{const _0x1a38ce=_0x38efcf[_0xf5763b(0x1ca)],_0x105efc=_0x1a38ce[_0xf5763b(0x1ab)];if(!_0x105efc?.[_0xf5763b(0x199)]){console[_0xf5763b(0x1a1)](_0xf5763b(0x186)+_0x1a38ce['id']);return;}const _0x40e80a=_0x417c85==='PAID'?_0xf5763b(0x1d2):_0xf5763b(0x193);let _0x51da5b=[];if(_0x105efc['webhookEvents'])try{_0x51da5b=Array[_0xf5763b(0x1bb)](_0x105efc[_0xf5763b(0x1d5)])?_0x105efc[_0xf5763b(0x1d5)]:JSON[_0xf5763b(0x18c)](_0x105efc[_0xf5763b(0x1d5)]);}catch(_0x1f2195){console[_0xf5763b(0x190)](_0xf5763b(0x19b),_0x1f2195),_0x51da5b=[];}if(!_0x51da5b[_0xf5763b(0x17e)](_0x40e80a)){console[_0xf5763b(0x1a1)]('Webhook\x20event\x20'+_0x40e80a+_0xf5763b(0x1f2)+_0x1a38ce['id']);return;}const _0x4982ed={'event':_0x40e80a,'payment':{'id':_0x38efcf['id'],'order_id':_0x38efcf[_0xf5763b(0x1e0)],'gateway_order_id':_0x38efcf[_0xf5763b(0x183)],'gateway':_0xf5763b(0x192),'amount':_0x38efcf[_0xf5763b(0x1cb)],'currency':_0x38efcf[_0xf5763b(0x184)],'status':_0x417c85[_0xf5763b(0x1ac)](),'customer_email':_0x38efcf[_0xf5763b(0x1a3)],'customer_name':_0x38efcf[_0xf5763b(0x194)],'transaction_id':_0x29be02,'failure_message':_0x34d138,'created_at':_0x38efcf[_0xf5763b(0x1e8)],'updated_at':new Date()}},_0x536da2=await fetch(_0x105efc[_0xf5763b(0x199)],{'method':'POST','headers':{'Content-Type':_0xf5763b(0x1b5),'User-Agent':_0xf5763b(0x1e6)},'body':JSON[_0xf5763b(0x1f3)](_0x4982ed)}),_0x2f3527=Date['now']()-_0x30be84;console['log'](_0xf5763b(0x1ed)+_0x105efc['webhookUrl']+_0xf5763b(0x19d)+_0x536da2[_0xf5763b(0x1c2)]+'\x20('+_0x2f3527+'ms)');}catch(_0x3c9f7e){console[_0xf5763b(0x190)](_0xf5763b(0x1bc),_0x3c9f7e);}}async[a13_0xd8dfe0(0x1df)](_0x4ed76d,_0x35851b){const _0x2ef52d=a13_0xd8dfe0;try{const {telegramBotService:_0x2a9fb7}=await Promise[_0x2ef52d(0x1c5)]()['then'](()=>__importStar(require(_0x2ef52d(0x1d3)))),_0x50366f={'PAID':_0x2ef52d(0x189),'FAILED':'failed'},_0x2f86f3=_0x50366f[_0x35851b];if(!_0x2f86f3)return;await _0x2a9fb7[_0x2ef52d(0x1cc)](_0x4ed76d[_0x2ef52d(0x17c)],_0x4ed76d,_0x2f86f3);}catch(_0x485a18){console['error'](_0x2ef52d(0x1a4),_0x485a18);}}}exports[a13_0xd8dfe0(0x1b0)]=TestGatewayController;