'use strict';function a8_0x5a6c(_0x3b84c2,_0x5dc928){const _0x4f65da=a8_0x4f65();return a8_0x5a6c=function(_0x5a6ca2,_0xbe040f){_0x5a6ca2=_0x5a6ca2-0x1eb;let _0x46eb50=_0x4f65da[_0x5a6ca2];return _0x46eb50;},a8_0x5a6c(_0x3b84c2,_0x5dc928);}const a8_0x93ae1f=a8_0x5a6c;(function(_0x17b8cf,_0x2583c7){const _0x29db39=a8_0x5a6c,_0x439913=_0x17b8cf();while(!![]){try{const _0x5e402c=parseInt(_0x29db39(0x215))/0x1*(parseInt(_0x29db39(0x239))/0x2)+parseInt(_0x29db39(0x24b))/0x3+-parseInt(_0x29db39(0x234))/0x4+parseInt(_0x29db39(0x214))/0x5*(parseInt(_0x29db39(0x256))/0x6)+parseInt(_0x29db39(0x21b))/0x7+-parseInt(_0x29db39(0x1f3))/0x8*(parseInt(_0x29db39(0x24d))/0x9)+parseInt(_0x29db39(0x1fe))/0xa*(parseInt(_0x29db39(0x251))/0xb);if(_0x5e402c===_0x2583c7)break;else _0x439913['push'](_0x439913['shift']());}catch(_0x2d4f16){_0x439913['push'](_0x439913['shift']());}}}(a8_0x4f65,0x7313c));function a8_0x4f65(){const _0x187ac6=['successUrl','__importDefault','payment.success','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','payment.failed','PaymentController','__createBinding','mastercard','failureMessage','179345AuFWyV','4Dyqahx','application/json','ðŸ’³\x20MasterCard\x20URLs:','../config/database','Failed\x20to\x20send\x20MasterCard\x20webhook:','params','2039002QnfBSY','masterCardService','defineProperty','configurable','ms)','requires_3ds','https://api.trapay.uk/api/webhooks/gateway/mastercard','then','sendShopWebhook','getPaymentById','../services/paymentService','toLowerCase','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','gatewayPaymentId','default','\x20\x20\x20Return\x20URL:\x20','PENDING','Payment\x20not\x20found','currency','includes','writable','shop','orderId','customerName','resolve','3146232dnGCPZ','createPublicPayment','__setModuleDefault','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','error','39344sNGKDR','status','paymentMethod','shopId','paymentService','payment','MasterCardService','substring',',\x20cannot\x20process','gatewayOrderId','findUnique','length','webhookUrl','create','call','sendPaymentNotification','toISOString','3DS\x20verification\x20required','743643mblowX','failUrl','1163637mcwphU','../services/webhookService','webhookService','MasterCard\x20webhook\x20sent\x20to\x20','11gZVwVX','processMasterCardPayment','update','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','Error\x20parsing\x20webhook\x20events:','150olrDkM','__importStar','getOwnPropertyDescriptor','json','updateCustomerData','sendPaymentStatusNotification','Customer\x20data\x20updated\x20successfully','paid','POST','threeds_url','log','Payment\x20status\x20is\x20','prototype','1111','__esModule','getPaymentStatus','webhookLog','hasOwnProperty','stringify','24nOaClL','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20failed','getOwnPropertyNames','Webhook\x20event\x20','\x20processed:\x20','body','amount','paidAt','Card\x20payment\x20failed','Payment\x20created\x20successfully','1312130rafEtz','webhookEvents','get','failed','\x20with\x20status\x20','PaymentService','FAILED','final','gateway_payment_id','settings','PAID','not\x20provided','now'];a8_0x4f65=function(){return _0x187ac6;};return a8_0x4f65();}var __createBinding=this&&this[a8_0x93ae1f(0x211)]||(Object[a8_0x93ae1f(0x246)]?function(_0x48ee0b,_0xa4c4a,_0x16e98a,_0xaed9a9){const _0x45c0d4=a8_0x93ae1f;if(_0xaed9a9===undefined)_0xaed9a9=_0x16e98a;var _0x5268e0=Object[_0x45c0d4(0x258)](_0xa4c4a,_0x16e98a);(!_0x5268e0||(_0x45c0d4(0x200)in _0x5268e0?!_0xa4c4a['__esModule']:_0x5268e0[_0x45c0d4(0x22f)]||_0x5268e0[_0x45c0d4(0x21e)]))&&(_0x5268e0={'enumerable':!![],'get':function(){return _0xa4c4a[_0x16e98a];}}),Object[_0x45c0d4(0x21d)](_0x48ee0b,_0xaed9a9,_0x5268e0);}:function(_0x46b07f,_0x4d7905,_0x1e852e,_0x48e212){if(_0x48e212===undefined)_0x48e212=_0x1e852e;_0x46b07f[_0x48e212]=_0x4d7905[_0x1e852e];}),__setModuleDefault=this&&this[a8_0x93ae1f(0x236)]||(Object[a8_0x93ae1f(0x246)]?function(_0xb5f32b,_0x97377b){const _0x3eb9e6=a8_0x93ae1f;Object['defineProperty'](_0xb5f32b,_0x3eb9e6(0x229),{'enumerable':!![],'value':_0x97377b});}:function(_0xd8c510,_0x27cfe7){const _0xc417dc=a8_0x93ae1f;_0xd8c510[_0xc417dc(0x229)]=_0x27cfe7;}),__importStar=this&&this[a8_0x93ae1f(0x257)]||(function(){var _0x14c350=function(_0x97bb4f){const _0x438a23=a8_0x5a6c;return _0x14c350=Object[_0x438a23(0x1f6)]||function(_0x516e93){const _0x34401e=_0x438a23;var _0x3bad5a=[];for(var _0x556ad4 in _0x516e93)if(Object[_0x34401e(0x1ec)][_0x34401e(0x1f1)][_0x34401e(0x247)](_0x516e93,_0x556ad4))_0x3bad5a[_0x3bad5a[_0x34401e(0x244)]]=_0x556ad4;return _0x3bad5a;},_0x14c350(_0x97bb4f);};return function(_0x505bf6){const _0x236f29=a8_0x5a6c;if(_0x505bf6&&_0x505bf6['__esModule'])return _0x505bf6;var _0x847a57={};if(_0x505bf6!=null){for(var _0x5ac6b3=_0x14c350(_0x505bf6),_0x52ccaf=0x0;_0x52ccaf<_0x5ac6b3[_0x236f29(0x244)];_0x52ccaf++)if(_0x5ac6b3[_0x52ccaf]!==_0x236f29(0x229))__createBinding(_0x847a57,_0x505bf6,_0x5ac6b3[_0x52ccaf]);}return __setModuleDefault(_0x847a57,_0x505bf6),_0x847a57;};}()),__importDefault=this&&this[a8_0x93ae1f(0x20c)]||function(_0x19ed6d){const _0x5ecb71=a8_0x93ae1f;return _0x19ed6d&&_0x19ed6d[_0x5ecb71(0x1ee)]?_0x19ed6d:{'default':_0x19ed6d};};Object['defineProperty'](exports,a8_0x93ae1f(0x1ee),{'value':!![]}),exports[a8_0x93ae1f(0x210)]=void 0x0;const paymentService_1=require(a8_0x93ae1f(0x225)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x93ae1f(0x24e)),database_1=__importDefault(require(a8_0x93ae1f(0x218)));class PaymentController{constructor(){const _0x4f17b5=a8_0x93ae1f;this[_0x4f17b5(0x235)]=async(_0x16cc83,_0x2bbc0d,_0x47738b)=>{const _0x49914c=_0x4f17b5;try{const _0x1b056e=_0x16cc83['body'],_0x555772=await this['paymentService'][_0x49914c(0x235)](_0x1b056e);_0x2bbc0d[_0x49914c(0x23a)](0xc9)[_0x49914c(0x259)]({'success':!![],'message':_0x49914c(0x1fd),'result':_0x555772});}catch(_0x5aae1d){_0x47738b(_0x5aae1d);}},this[_0x4f17b5(0x1ef)]=async(_0x585299,_0x22fc98,_0x3e6168)=>{const _0x3f1177=_0x4f17b5;try{const {id:_0x58c860}=_0x585299[_0x3f1177(0x21a)],_0x370264=await this[_0x3f1177(0x23d)][_0x3f1177(0x1ef)](_0x58c860);if(!_0x370264)return _0x22fc98['status'](0x194)[_0x3f1177(0x259)]({'success':![],'message':_0x3f1177(0x22c)});_0x22fc98[_0x3f1177(0x259)]({'success':!![],'result':_0x370264});}catch(_0x531e46){_0x3e6168(_0x531e46);}},this[_0x4f17b5(0x224)]=async(_0x27187a,_0x18f5c8,_0x4279b8)=>{const _0x3acd45=_0x4f17b5;try{const {id:_0x4610cb}=_0x27187a[_0x3acd45(0x21a)],_0x5ba159=await this[_0x3acd45(0x23d)]['getPaymentById'](_0x4610cb);if(!_0x5ba159)return _0x18f5c8[_0x3acd45(0x23a)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x18f5c8[_0x3acd45(0x259)]({'success':!![],'result':_0x5ba159});}catch(_0x410cdf){_0x4279b8(_0x410cdf);}},this[_0x4f17b5(0x252)]=async(_0x70f33,_0x301065,_0x4dfd85)=>{const _0x5d8bf0=_0x4f17b5;try{const {id:_0x4776de}=_0x70f33[_0x5d8bf0(0x21a)],{cardData:_0x41a971,cardHolder:_0xed018d,browser:_0x34889e}=_0x70f33['body'];console[_0x5d8bf0(0x260)](_0x5d8bf0(0x254)+_0x4776de);const _0x26d585=await database_1[_0x5d8bf0(0x229)]['payment']['findUnique']({'where':{'id':_0x4776de},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x26d585)return _0x301065[_0x5d8bf0(0x23a)](0x194)[_0x5d8bf0(0x259)]({'success':![],'message':_0x5d8bf0(0x22c)});if(_0x26d585['gateway']!==_0x5d8bf0(0x212))return _0x301065[_0x5d8bf0(0x23a)](0x190)[_0x5d8bf0(0x259)]({'success':![],'message':_0x5d8bf0(0x20e)});if(_0x26d585[_0x5d8bf0(0x23a)]!==_0x5d8bf0(0x22b))return _0x301065[_0x5d8bf0(0x23a)](0x190)[_0x5d8bf0(0x259)]({'success':![],'message':_0x5d8bf0(0x1eb)+_0x26d585[_0x5d8bf0(0x23a)]+_0x5d8bf0(0x241)});const _0x26d493=_0x5d8bf0(0x221),_0x240e95=_0x26d585[_0x5d8bf0(0x20b)];console[_0x5d8bf0(0x260)](_0x5d8bf0(0x217)),console[_0x5d8bf0(0x260)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x26d493),console[_0x5d8bf0(0x260)](_0x5d8bf0(0x22a)+_0x240e95);const _0x1a2d3d=await this[_0x5d8bf0(0x21c)]['processCardPayment']({'paymentId':_0x26d585['id'],'orderId':_0x26d585['gatewayOrderId']||_0x26d585['id'],'amount':_0x26d585['amount'],'currency':_0x26d585[_0x5d8bf0(0x22d)],'cardData':_0x41a971,'resultUrl':_0x26d493,'returnUrl':_0x240e95,'cardHolder':_0xed018d,'browser':_0x34889e});console['log']('ðŸ’³\x20MasterCard\x20result:',_0x1a2d3d);const _0x18d6c1={'status':_0x1a2d3d[_0x5d8bf0(0x23a)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x1a2d3d[_0x5d8bf0(0x23a)]===_0x5d8bf0(0x208))_0x18d6c1[_0x5d8bf0(0x1fb)]=new Date(),_0x18d6c1[_0x5d8bf0(0x228)]=_0x1a2d3d[_0x5d8bf0(0x206)];else _0x1a2d3d[_0x5d8bf0(0x23a)]===_0x5d8bf0(0x204)&&(_0x18d6c1[_0x5d8bf0(0x213)]=_0x5d8bf0(0x1fc));_0x18d6c1[_0x5d8bf0(0x23b)]=_0x5d8bf0(0x212),await database_1[_0x5d8bf0(0x229)][_0x5d8bf0(0x23e)][_0x5d8bf0(0x253)]({'where':{'id':_0x26d585['id']},'data':_0x18d6c1}),await database_1[_0x5d8bf0(0x229)][_0x5d8bf0(0x1f0)]['create']({'data':{'paymentId':_0x26d585['id'],'shopId':_0x26d585[_0x5d8bf0(0x23c)],'event':'mastercard_'+_0x1a2d3d[_0x5d8bf0(0x23a)]?.[_0x5d8bf0(0x226)](),'statusCode':0xc8,'responseBody':JSON[_0x5d8bf0(0x1f2)]({'oldStatus':_0x5d8bf0(0x22b),'newStatus':_0x1a2d3d[_0x5d8bf0(0x23a)],'gatewayPaymentId':_0x1a2d3d[_0x5d8bf0(0x206)],'requires3ds':_0x1a2d3d[_0x5d8bf0(0x220)],'processedAt':new Date()[_0x5d8bf0(0x249)]()})}});_0x1a2d3d[_0x5d8bf0(0x205)]&&(await this[_0x5d8bf0(0x223)](_0x26d585,_0x1a2d3d[_0x5d8bf0(0x23a)],_0x1a2d3d[_0x5d8bf0(0x206)]),await this[_0x5d8bf0(0x25b)](_0x26d585,_0x1a2d3d[_0x5d8bf0(0x23a)]));console[_0x5d8bf0(0x260)]('âœ…\x20MasterCard\x20payment\x20'+_0x4776de+_0x5d8bf0(0x1f8)+_0x1a2d3d[_0x5d8bf0(0x23a)]);if(_0x1a2d3d['status']===_0x5d8bf0(0x208))_0x301065[_0x5d8bf0(0x259)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x5d8bf0(0x208),'gatewayPaymentId':_0x1a2d3d['gateway_payment_id'],'redirectUrl':_0x240e95,'final':!![]}});else _0x1a2d3d[_0x5d8bf0(0x220)]&&_0x1a2d3d[_0x5d8bf0(0x25f)]?_0x301065[_0x5d8bf0(0x259)]({'success':!![],'message':_0x5d8bf0(0x24a),'result':{'status':_0x5d8bf0(0x22b),'gatewayPaymentId':_0x1a2d3d['gateway_payment_id'],'redirectUrl':_0x1a2d3d[_0x5d8bf0(0x25f)],'requires3ds':!![],'final':![]}}):_0x301065[_0x5d8bf0(0x23a)](0x190)[_0x5d8bf0(0x259)]({'success':![],'message':_0x5d8bf0(0x1f5),'result':{'status':_0x5d8bf0(0x204),'gatewayPaymentId':_0x1a2d3d[_0x5d8bf0(0x206)],'redirectUrl':_0x26d585[_0x5d8bf0(0x24c)],'final':!![]}});}catch(_0x1afee5){_0x4dfd85(_0x1afee5);}},this[_0x4f17b5(0x25a)]=async(_0x39671c,_0x11c3db,_0x19d8aa)=>{const _0x4f817c=_0x4f17b5;try{const {id:_0x5d46f2}=_0x39671c[_0x4f817c(0x21a)],{customerIp:_0x306396,customerUa:_0x224329,customerCountry:_0x593d1a}=_0x39671c[_0x4f817c(0x1f9)],_0x3c3637=await database_1[_0x4f817c(0x229)][_0x4f817c(0x23e)][_0x4f817c(0x243)]({'where':{'id':_0x5d46f2},'select':{'id':!![],'status':!![]}});if(!_0x3c3637)return _0x11c3db[_0x4f817c(0x23a)](0x194)[_0x4f817c(0x259)]({'success':![],'message':_0x4f817c(0x22c)});const _0x3482f2=await database_1[_0x4f817c(0x229)][_0x4f817c(0x23e)][_0x4f817c(0x253)]({'where':{'id':_0x5d46f2},'data':{'customerIp':_0x306396||undefined,'customerUa':_0x224329||undefined,'customerCountry':_0x593d1a||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x4f817c(0x260)](_0x4f817c(0x227)+_0x5d46f2+':',{'customerIp':_0x306396||_0x4f817c(0x209),'customerUa':_0x224329?_0x224329[_0x4f817c(0x240)](0x0,0x32)+'...':_0x4f817c(0x209),'customerCountry':_0x593d1a||_0x4f817c(0x209)}),_0x11c3db[_0x4f817c(0x259)]({'success':!![],'message':_0x4f817c(0x25c),'result':_0x3482f2});}catch(_0x837a7f){_0x19d8aa(_0x837a7f);}},this[_0x4f17b5(0x23d)]=new paymentService_1[(_0x4f17b5(0x203))](),this[_0x4f17b5(0x21c)]=new mastercardService_1[(_0x4f17b5(0x23f))](),this[_0x4f17b5(0x24f)]=new webhookService_1['WebhookService']();}async[a8_0x93ae1f(0x223)](_0x231aaf,_0xb6b943,_0x13c28a){const _0x3ed548=a8_0x93ae1f,_0x453e52=Date[_0x3ed548(0x20a)]();try{const _0x154655=_0x231aaf[_0x3ed548(0x230)],_0x6e310b=_0x154655[_0x3ed548(0x207)];if(!_0x6e310b?.[_0x3ed548(0x245)]){console['log'](_0x3ed548(0x237)+_0x154655['id']);return;}const _0xeb672b=_0xb6b943==='PAID'?_0x3ed548(0x20d):_0x3ed548(0x20f);let _0x16cf90=[];if(_0x6e310b[_0x3ed548(0x1ff)])try{_0x16cf90=Array['isArray'](_0x6e310b[_0x3ed548(0x1ff)])?_0x6e310b[_0x3ed548(0x1ff)]:JSON['parse'](_0x6e310b[_0x3ed548(0x1ff)]);}catch(_0x2d3355){console[_0x3ed548(0x238)](_0x3ed548(0x255),_0x2d3355),_0x16cf90=[];}if(!_0x16cf90[_0x3ed548(0x22e)](_0xeb672b)){console[_0x3ed548(0x260)](_0x3ed548(0x1f7)+_0xeb672b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x154655['id']);return;}const _0x300beb={'event':_0xeb672b,'payment':{'id':_0x231aaf['id'],'order_id':_0x231aaf[_0x3ed548(0x231)],'gateway_order_id':_0x231aaf[_0x3ed548(0x242)],'gateway':_0x3ed548(0x1ed),'amount':_0x231aaf[_0x3ed548(0x1fa)],'currency':_0x231aaf[_0x3ed548(0x22d)],'status':_0xb6b943[_0x3ed548(0x226)](),'customer_email':_0x231aaf['customerEmail'],'customer_name':_0x231aaf[_0x3ed548(0x232)],'gateway_payment_id':_0x13c28a,'created_at':_0x231aaf['createdAt'],'updated_at':new Date()}},_0x586daa=await fetch(_0x6e310b[_0x3ed548(0x245)],{'method':_0x3ed548(0x25e),'headers':{'Content-Type':_0x3ed548(0x216),'User-Agent':_0x3ed548(0x1f4)},'body':JSON[_0x3ed548(0x1f2)](_0x300beb)}),_0x5db9d6=Date[_0x3ed548(0x20a)]()-_0x453e52;console[_0x3ed548(0x260)](_0x3ed548(0x250)+_0x6e310b[_0x3ed548(0x245)]+_0x3ed548(0x202)+_0x586daa['status']+'\x20('+_0x5db9d6+_0x3ed548(0x21f));}catch(_0x4d02ec){console['error'](_0x3ed548(0x219),_0x4d02ec);}}async[a8_0x93ae1f(0x25b)](_0x578a9e,_0x4f345e){const _0x222997=a8_0x93ae1f;try{const {telegramBotService:_0x1a8dfc}=await Promise[_0x222997(0x233)]()[_0x222997(0x222)](()=>__importStar(require('../services/telegramBotService'))),_0x30f8ce={'PAID':_0x222997(0x25d),'FAILED':_0x222997(0x201)},_0x3259ac=_0x30f8ce[_0x4f345e];if(!_0x3259ac)return;await _0x1a8dfc[_0x222997(0x248)](_0x578a9e[_0x222997(0x23c)],_0x578a9e,_0x3259ac);}catch(_0x40a3e5){console[_0x222997(0x238)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x40a3e5);}}}exports[a8_0x93ae1f(0x210)]=PaymentController;