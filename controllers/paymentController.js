'use strict';function a13_0x51c1(_0x2264bb,_0x161cfb){_0x2264bb=_0x2264bb-0x115;const _0x2cfc86=a13_0x2cfc();let _0x51c13d=_0x2cfc86[_0x2264bb];return _0x51c13d;}const a13_0x3ef0a8=a13_0x51c1;(function(_0x8f01f2,_0x4aae21){const _0x249a63=a13_0x51c1,_0x11f4bc=_0x8f01f2();while(!![]){try{const _0x516084=parseInt(_0x249a63(0x13c))/0x1+-parseInt(_0x249a63(0x141))/0x2+-parseInt(_0x249a63(0x186))/0x3*(-parseInt(_0x249a63(0x1c0))/0x4)+-parseInt(_0x249a63(0x14b))/0x5*(parseInt(_0x249a63(0x1a5))/0x6)+parseInt(_0x249a63(0x1d8))/0x7*(-parseInt(_0x249a63(0x1c9))/0x8)+parseInt(_0x249a63(0x1b4))/0x9+-parseInt(_0x249a63(0x142))/0xa*(-parseInt(_0x249a63(0x13a))/0xb);if(_0x516084===_0x4aae21)break;else _0x11f4bc['push'](_0x11f4bc['shift']());}catch(_0x56eb3d){_0x11f4bc['push'](_0x11f4bc['shift']());}}}(a13_0x2cfc,0x36a5f));var __createBinding=this&&this[a13_0x3ef0a8(0x13b)]||(Object[a13_0x3ef0a8(0x19b)]?function(_0x190e9b,_0x4264ea,_0x5a4bcb,_0x57f7a2){const _0x37afde=a13_0x3ef0a8;if(_0x57f7a2===undefined)_0x57f7a2=_0x5a4bcb;var _0x3b2ea5=Object[_0x37afde(0x157)](_0x4264ea,_0x5a4bcb);(!_0x3b2ea5||(_0x37afde(0x11e)in _0x3b2ea5?!_0x4264ea[_0x37afde(0x199)]:_0x3b2ea5[_0x37afde(0x14a)]||_0x3b2ea5[_0x37afde(0x1a9)]))&&(_0x3b2ea5={'enumerable':!![],'get':function(){return _0x4264ea[_0x5a4bcb];}}),Object['defineProperty'](_0x190e9b,_0x57f7a2,_0x3b2ea5);}:function(_0x5f3361,_0xe626dd,_0x5d2854,_0x3540e3){if(_0x3540e3===undefined)_0x3540e3=_0x5d2854;_0x5f3361[_0x3540e3]=_0xe626dd[_0x5d2854];}),__setModuleDefault=this&&this[a13_0x3ef0a8(0x133)]||(Object['create']?function(_0x29cfb3,_0x6a4685){const _0x8c0f09=a13_0x3ef0a8;Object[_0x8c0f09(0x156)](_0x29cfb3,_0x8c0f09(0x1c6),{'enumerable':!![],'value':_0x6a4685});}:function(_0x41e05f,_0x1df168){const _0x3a23e9=a13_0x3ef0a8;_0x41e05f[_0x3a23e9(0x1c6)]=_0x1df168;}),__importStar=this&&this[a13_0x3ef0a8(0x1af)]||(function(){var _0x2908f3=function(_0x4ed659){const _0x1caf02=a13_0x51c1;return _0x2908f3=Object[_0x1caf02(0x180)]||function(_0x723b33){const _0x2623ea=_0x1caf02;var _0x268948=[];for(var _0x3def06 in _0x723b33)if(Object[_0x2623ea(0x16e)][_0x2623ea(0x151)][_0x2623ea(0x16d)](_0x723b33,_0x3def06))_0x268948[_0x268948['length']]=_0x3def06;return _0x268948;},_0x2908f3(_0x4ed659);};return function(_0x57e688){const _0x39f344=a13_0x51c1;if(_0x57e688&&_0x57e688[_0x39f344(0x199)])return _0x57e688;var _0x77f385={};if(_0x57e688!=null){for(var _0x515f3a=_0x2908f3(_0x57e688),_0x4fc324=0x0;_0x4fc324<_0x515f3a[_0x39f344(0x17d)];_0x4fc324++)if(_0x515f3a[_0x4fc324]!==_0x39f344(0x1c6))__createBinding(_0x77f385,_0x57e688,_0x515f3a[_0x4fc324]);}return __setModuleDefault(_0x77f385,_0x57e688),_0x77f385;};}()),__importDefault=this&&this[a13_0x3ef0a8(0x183)]||function(_0x16ab12){return _0x16ab12&&_0x16ab12['__esModule']?_0x16ab12:{'default':_0x16ab12};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a13_0x3ef0a8(0x123)]=void 0x0;const crypto_1=__importDefault(require(a13_0x3ef0a8(0x15c))),paymentService_1=require(a13_0x3ef0a8(0x189)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a13_0x3ef0a8(0x179)),currencyService_1=require(a13_0x3ef0a8(0x167)),binLookupService_1=require(a13_0x3ef0a8(0x159)),database_1=__importDefault(require(a13_0x3ef0a8(0x122)));function a13_0x2cfc(){const _0x321cac=['webhookEvents','22cNaaOP','__createBinding','220887rBApAp','paymentService','first_name','PaymentService','ðŸ”\x20Looking\x20up\x20BIN\x20for\x20card:','623428PqIWMW','486530EkEGEC','VISA/MasterCard','ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20','âœ…\x20Payment\x20link\x20counter\x20updated\x20for\x20','PAID','cardCategory','POST','\x20->\x20','writable','65aoRXAS','Payment\x20status\x20is\x20','updatePaymentStatus','mastercard','https://api.trapay.uk/api/webhooks/gateway/','PENDING','hasOwnProperty','last_name','payment.failed','&payment_id=','shop','defineProperty','getOwnPropertyDescriptor','ðŸ§¹\x20Customer\x20names\x20cleaned:','../services/binLookupService','status','Payment\x20created\x20successfully','crypto','currencyService','gatewayOrderId','\x20\x20Original:\x20\x22','updatePaymentCustomerDataPublic','webhookUrl','Card\x20payment\x20failed','string','getPaymentById','toUpperCase','failUrl','../services/currencyService','amountAfterGatewayCommissionUSDT','params','ms)','failureMessage','payment','call','prototype','ðŸ’°\x20Converting\x20','threeds_url','Customer\x20data\x20updated\x20successfully','number','ðŸ’³\x20Saving\x20card\x20last\x204\x20digits:\x20****','trim','gatewayCommissionRate','cardBrand','gateway_payment_id','settings','../services/webhookService','currency','visaMasterCardService','cardBinStatus','length','handleSuccessfulPayment','ðŸ’°\x20Updated\x20merchant\x20balance\x20for\x20payment\x20','getOwnPropertyNames','Payment\x20not\x20found','visa/mastercard','__importDefault','customerUa','paid','1734KCGweC','ðŸ“ˆ\x20','filter','../services/paymentService','gateway','startsWith','createPublicPayment','Bank\x20Card','system','gatewayPaymentId','processMasterCardPayment','hex','\x20with\x20status\x20','ðŸ’³\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','amountUSDT','body','json','join','VisaMasterCardService','__esModule','toISOString','create','\x20with\x20requestId\x20','errorMessage','application/json','parse',',\x20cannot\x20process','createHmac','sendPaymentNotification','sha256','billingCity','85950mzeVuw','processCardPayment','ðŸ’³\x20Card\x20holder:\x20','sendPaymentStatusNotification','configurable','cardIssuer','cardLast4','log','shopId','\x20USDT','__importStar','Payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','state','âœ…\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info','1840941pYxCfL','visa','toLowerCase','ðŸ“\x20Billing\x20address\x20(string):','update','\x20webhook\x20sent\x20to\x20','ðŸ’³\x20Saving\x20card\x20brand:\x20','lookupBin','../services/telegramBotService','1111','secretKey','billingAddress','2632GsVQUL','sendShopWebhook','UNKNOWN','customerIp','updatedAt','ðŸ’³\x20','default','../services/paymentLinkService','paymentMethod','23392XPurla','customerCountry','toFixed','final','then','findUnique','\x22\x20|\x20\x22','stringify','address_line_1','\x20\x20\x20Return\x20URL:\x20','getPaymentStatus','\x20not\x20enabled\x20for\x20shop\x20','error','email','convertToUSDT','434zFCaEs','\x20payment\x20','includes','address_line_2','ðŸ“Š\x20BIN\x20lookup\x20result:','query','Failed\x20to\x20send\x20','FAILED','getPaymentFingerprint','ðŸ’³\x20MasterCard\x20result:','get','\x20payment:','webhookLog','******','../config/database','PaymentController','WebhookService','ðŸ’°\x20Gateway\x20','https://app.trapay.uk/payment/pending?id=','ðŸ”„\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','Payment\x20processed\x20successfully','Webhook\x20event\x20','replace','resolve','orderId','substring','failed','binLookupService','webhookService','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','__setModuleDefault','\x20webhook:','digest','post_code','postcode','amount'];a13_0x2cfc=function(){return _0x321cac;};return a13_0x2cfc();}class PaymentController{constructor(){const _0x505fcb=a13_0x3ef0a8;this['createPublicPayment']=async(_0x4483b4,_0xfdd2f4,_0x3e8099)=>{const _0x1edf83=a13_0x51c1;try{const _0xf89e54=_0x4483b4[_0x1edf83(0x195)],_0x43dbf2=await this['paymentService'][_0x1edf83(0x18c)](_0xf89e54);_0xfdd2f4[_0x1edf83(0x15a)](0xc9)[_0x1edf83(0x196)]({'success':!![],'message':_0x1edf83(0x15b),'result':_0x43dbf2});}catch(_0x46f136){_0x3e8099(_0x46f136);}},this[_0x505fcb(0x1d3)]=async(_0x514122,_0x1118bc,_0x5aaef4)=>{const _0x507a45=_0x505fcb;try{const {id:_0x51df6d}=_0x514122[_0x507a45(0x169)],_0x325a6c=await this[_0x507a45(0x13d)]['getPaymentStatus'](_0x51df6d);if(!_0x325a6c)return _0x1118bc[_0x507a45(0x15a)](0x194)[_0x507a45(0x196)]({'success':![],'message':_0x507a45(0x181)});_0x1118bc[_0x507a45(0x196)]({'success':!![],'result':_0x325a6c});}catch(_0x11479c){_0x5aaef4(_0x11479c);}},this['getPaymentFingerprint']=async(_0x3f00d8,_0x189287,_0x20ebef)=>{const _0x4deb57=_0x505fcb;try{const {id:_0x52c2a9}=_0x3f00d8[_0x4deb57(0x169)],{requestId:_0x5217ea}=_0x3f00d8[_0x4deb57(0x119)];if(typeof _0x5217ea!==_0x4deb57(0x163))return _0x189287['status'](0x190)['json']({'success':![],'message':'requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string'});console['log']('ðŸ”\x20Received\x20fingerprint\x20request\x20for\x20payment\x20'+_0x52c2a9+_0x4deb57(0x19c)+_0x5217ea);const _0x180b2c=await this[_0x4deb57(0x13d)][_0x4deb57(0x11c)](_0x52c2a9,_0x5217ea);if(!_0x180b2c)return _0x189287[_0x4deb57(0x15a)](0x194)[_0x4deb57(0x196)]({'success':![],'message':'Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available'});console[_0x4deb57(0x1ac)]('âœ…\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20'+_0x52c2a9+':',_0x180b2c),_0x189287[_0x4deb57(0x196)]({'success':!![],'result':_0x180b2c});}catch(_0x1f902c){_0x20ebef(_0x1f902c);}},this[_0x505fcb(0x164)]=async(_0x5f7e56,_0x5ae9c0,_0x4d56a6)=>{const _0x1af8df=_0x505fcb;try{const {id:_0x48fceb}=_0x5f7e56[_0x1af8df(0x169)],_0x133023=await this[_0x1af8df(0x13d)][_0x1af8df(0x164)](_0x48fceb);if(!_0x133023)return _0x5ae9c0[_0x1af8df(0x15a)](0x194)['json']({'success':![],'message':_0x1af8df(0x181)});_0x5ae9c0[_0x1af8df(0x196)]({'success':!![],'result':_0x133023});}catch(_0x26f6d9){_0x4d56a6(_0x26f6d9);}},this['updatePaymentCustomer']=async(_0x19df4f,_0x482369,_0x294a86)=>{const _0x2cde32=_0x505fcb;try{const {id:_0x4a0100}=_0x19df4f['params'],_0x205b77=_0x19df4f[_0x2cde32(0x195)];console[_0x2cde32(0x1ac)](_0x2cde32(0x127)+_0x4a0100),console[_0x2cde32(0x1ac)]('ðŸ“\x20Customer\x20data:',_0x205b77);const _0x5760f7=await this['paymentService'][_0x2cde32(0x160)](_0x4a0100,_0x205b77);if(!_0x5760f7)return _0x482369[_0x2cde32(0x15a)](0x194)['json']({'success':![],'message':_0x2cde32(0x181)});_0x482369[_0x2cde32(0x196)]({'success':!![],'message':_0x2cde32(0x171),'result':{'paymentId':_0x5760f7['id'],'customerIp':_0x5760f7[_0x2cde32(0x1c3)],'customerUa':_0x5760f7[_0x2cde32(0x184)],'customerCountry':_0x5760f7[_0x2cde32(0x1ca)],'updatedAt':_0x5760f7[_0x2cde32(0x1c4)]}});}catch(_0x3e0294){_0x294a86(_0x3e0294);}},this[_0x505fcb(0x190)]=async(_0x3e3316,_0x5513c9,_0x1d64a3)=>{const _0x3ed21a=_0x505fcb;try{const {id:_0x572c0d}=_0x3e3316[_0x3ed21a(0x169)],{cardData:_0xa2d370,cardHolder:_0x415cb7,browser:_0x3e9226}=_0x3e3316[_0x3ed21a(0x195)];console[_0x3ed21a(0x1ac)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x572c0d),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1a7)+_0x415cb7[_0x3ed21a(0x13e)]+'\x20'+_0x415cb7[_0x3ed21a(0x152)]+'\x20('+_0x415cb7[_0x3ed21a(0x1d6)]+')'),console[_0x3ed21a(0x1ac)]('ðŸ’³\x20Browser\x20IP:\x20'+_0x3e9226['ip']);const _0x343811=_0x415cb7[_0x3ed21a(0x13e)]?.[_0x3ed21a(0x12b)](/[\t\n\r\f\v]/g,'\x20')[_0x3ed21a(0x174)]()||'',_0x12cb80=_0x415cb7['last_name']?.[_0x3ed21a(0x12b)](/[\t\n\r\f\v]/g,'\x20')[_0x3ed21a(0x174)]()||'';console[_0x3ed21a(0x1ac)](_0x3ed21a(0x158)),console['log'](_0x3ed21a(0x15f)+_0x415cb7[_0x3ed21a(0x13e)]+_0x3ed21a(0x1cf)+_0x415cb7[_0x3ed21a(0x152)]+'\x22'),console[_0x3ed21a(0x1ac)]('\x20\x20Cleaned:\x20\x20\x22'+_0x343811+_0x3ed21a(0x1cf)+_0x12cb80+'\x22');const _0x27d63c={'customerName':_0x343811+'\x20'+_0x12cb80,'customerEmail':_0x415cb7[_0x3ed21a(0x1d6)],'customerPhone':_0x415cb7['phone']||null,'customerIp':_0x3e9226['ip'],'customerUa':_0x3e9226['user_agent']},_0x16e879=[_0x415cb7[_0x3ed21a(0x1d1)],_0x415cb7[_0x3ed21a(0x117)]][_0x3ed21a(0x188)](Boolean);_0x27d63c[_0x3ed21a(0x1bf)]=_0x16e879[_0x3ed21a(0x197)](',\x20')||null,_0x27d63c[_0x3ed21a(0x1a4)]=_0x415cb7['city']||null,_0x27d63c['billingState']=_0x415cb7[_0x3ed21a(0x1b2)]||null,_0x27d63c['billingZip']=_0x415cb7[_0x3ed21a(0x136)]||_0x415cb7[_0x3ed21a(0x137)]||null,console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1b7),_0x27d63c['billingAddress']),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x140),_0xa2d370[_0x3ed21a(0x172)][_0x3ed21a(0x12e)](0x0,0x6)+_0x3ed21a(0x121));const _0x5748a0=await binLookupService_1[_0x3ed21a(0x130)][_0x3ed21a(0x1bb)](_0xa2d370[_0x3ed21a(0x172)]);console[_0x3ed21a(0x1ac)](_0x3ed21a(0x118),_0x5748a0);const _0x207f0d=_0xa2d370['number'][_0x3ed21a(0x12e)](0x0,0x8),_0x30ce49=await database_1[_0x3ed21a(0x1c6)]['payment'][_0x3ed21a(0x1ce)]({'where':{'id':_0x572c0d},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x30ce49)return _0x5513c9['status'](0x194)['json']({'success':![],'message':_0x3ed21a(0x181)});if(_0x30ce49[_0x3ed21a(0x18a)]!==_0x3ed21a(0x182))return console[_0x3ed21a(0x1ac)]('âŒ\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27'+_0x30ce49[_0x3ed21a(0x18a)]+'\x27'),_0x5513c9[_0x3ed21a(0x15a)](0x190)['json']({'success':![],'message':_0x3ed21a(0x132)});if(_0x30ce49[_0x3ed21a(0x15a)]!==_0x3ed21a(0x150))return _0x5513c9[_0x3ed21a(0x15a)](0x190)[_0x3ed21a(0x196)]({'success':![],'message':_0x3ed21a(0x14c)+_0x30ce49[_0x3ed21a(0x15a)]+_0x3ed21a(0x1a0)});await database_1['default'][_0x3ed21a(0x16c)][_0x3ed21a(0x1b8)]({'where':{'id':_0x572c0d},'data':{..._0x27d63c,'cardBin':_0x207f0d,'cardBinStatus':_0x5748a0[_0x3ed21a(0x17c)],'cardType':_0x5748a0['cardType'],'cardCategory':_0x5748a0[_0x3ed21a(0x147)],'cardCountry':_0x5748a0['cardCountry'],'cardIssuer':_0x5748a0[_0x3ed21a(0x1aa)],'updatedAt':new Date()}}),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1b3));const _0x4e62c2=_0xa2d370['number'][_0x3ed21a(0x12b)](/[\s-]/g,''),_0x48dadd=_0x4e62c2[_0x3ed21a(0x18b)]('4')?_0x3ed21a(0x1b5):_0x3ed21a(0x14e),_0x71f14b=_0x4e62c2[_0x3ed21a(0x18b)]('4')?'VISA':'MASTERCARD',_0x5c8cbb=_0x3ed21a(0x14f)+_0x48dadd,_0x42c13f=_0x3ed21a(0x126)+_0x30ce49['id']+_0x3ed21a(0x154)+_0x30ce49[_0x3ed21a(0x15e)];console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1c5)+_0x48dadd[_0x3ed21a(0x165)]()+'\x20URLs:'),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1b1)+_0x5c8cbb),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1d2)+_0x42c13f);const _0x48ea1b={'first_name':_0x415cb7[_0x3ed21a(0x13e)],'last_name':_0x415cb7[_0x3ed21a(0x152)],'email':_0x415cb7[_0x3ed21a(0x1d6)]},_0x2c472e=await this[_0x3ed21a(0x17b)][_0x3ed21a(0x1a6)]({'paymentId':_0x30ce49['id'],'orderId':_0x30ce49[_0x3ed21a(0x15e)]||_0x30ce49['id'],'amount':_0x30ce49[_0x3ed21a(0x138)],'currency':_0x30ce49[_0x3ed21a(0x17a)],'cardData':_0xa2d370,'resultUrl':_0x5c8cbb,'returnUrl':_0x42c13f,'cardHolder':_0x48ea1b,'browser':_0x3e9226});console[_0x3ed21a(0x1ac)](_0x3ed21a(0x11d),_0x2c472e);const _0x38abe3={'status':_0x2c472e[_0x3ed21a(0x15a)],'updatedAt':new Date(),'statusChangedBy':_0x3ed21a(0x18e),'statusChangedAt':new Date()};_0x2c472e[_0x3ed21a(0x177)]&&(_0x38abe3[_0x3ed21a(0x18f)]=_0x2c472e[_0x3ed21a(0x177)],console[_0x3ed21a(0x1ac)](_0x3ed21a(0x193)+_0x2c472e[_0x3ed21a(0x177)]));if(_0x2c472e[_0x3ed21a(0x15a)]===_0x3ed21a(0x146)){_0x38abe3['paidAt']=new Date();const _0x348a26=await this[_0x3ed21a(0x15d)][_0x3ed21a(0x1d7)](_0x30ce49[_0x3ed21a(0x138)],_0x30ce49[_0x3ed21a(0x17a)]),_0x369242=await this[_0x3ed21a(0x131)]['getGatewayCommission'](_0x30ce49[_0x3ed21a(0x1ad)],_0x30ce49[_0x3ed21a(0x18a)]),_0x401252=_0x348a26*(0x1-_0x369242/0x64);_0x38abe3[_0x3ed21a(0x194)]=_0x348a26,_0x38abe3[_0x3ed21a(0x168)]=_0x401252,_0x38abe3[_0x3ed21a(0x175)]=_0x369242,console[_0x3ed21a(0x1ac)](_0x3ed21a(0x16f)+_0x30ce49[_0x3ed21a(0x138)]+'\x20'+_0x30ce49[_0x3ed21a(0x17a)]+_0x3ed21a(0x149)+_0x348a26[_0x3ed21a(0x1cb)](0x6)+'\x20USDT'),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x125)+_0x30ce49[_0x3ed21a(0x18a)]+'\x20commission:\x20'+_0x369242+'%'),console['log'](_0x3ed21a(0x144)+_0x401252['toFixed'](0x6)+_0x3ed21a(0x1ae));}else _0x2c472e[_0x3ed21a(0x15a)]===_0x3ed21a(0x11b)&&(_0x38abe3[_0x3ed21a(0x16b)]=_0x2c472e[_0x3ed21a(0x19d)]||_0x3ed21a(0x162),console[_0x3ed21a(0x1ac)]('âŒ\x20Payment\x20failed\x20with\x20message:\x20'+_0x38abe3['failureMessage']));_0x38abe3[_0x3ed21a(0x1c8)]=_0x3ed21a(0x18d);if(_0xa2d370[_0x3ed21a(0x172)]){const _0x3cec2b=_0xa2d370['number']['replace'](/[\s-]/g,'');_0x38abe3[_0x3ed21a(0x1ab)]=_0x3cec2b['slice'](-0x4),_0x38abe3[_0x3ed21a(0x176)]=_0x71f14b,console[_0x3ed21a(0x1ac)](_0x3ed21a(0x173)+_0x38abe3['cardLast4']),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x1ba)+_0x71f14b);}await database_1['default'][_0x3ed21a(0x16c)]['update']({'where':{'id':_0x30ce49['id']},'data':_0x38abe3});_0x2c472e[_0x3ed21a(0x15a)]===_0x3ed21a(0x146)&&(await this['webhookService'][_0x3ed21a(0x14d)](_0x30ce49['id'],_0x3ed21a(0x146)),console['log'](_0x3ed21a(0x17f)+_0x30ce49['id']));await database_1[_0x3ed21a(0x1c6)][_0x3ed21a(0x120)][_0x3ed21a(0x19b)]({'data':{'paymentId':_0x30ce49['id'],'shopId':_0x30ce49[_0x3ed21a(0x1ad)],'event':_0x48dadd+'_'+_0x2c472e[_0x3ed21a(0x15a)]?.[_0x3ed21a(0x1b6)](),'statusCode':0xc8,'responseBody':JSON[_0x3ed21a(0x1d0)]({'oldStatus':_0x3ed21a(0x150),'newStatus':_0x2c472e[_0x3ed21a(0x15a)],'gatewayPaymentId':_0x2c472e['gateway_payment_id'],'requires3ds':_0x2c472e['requires_3ds'],'cardType':_0x48dadd[_0x3ed21a(0x165)](),'processedAt':new Date()[_0x3ed21a(0x19a)]()})}});if(_0x2c472e[_0x3ed21a(0x1cc)]){await this[_0x3ed21a(0x1c1)](_0x30ce49,_0x2c472e[_0x3ed21a(0x15a)],_0x2c472e[_0x3ed21a(0x177)],_0x48dadd),await this[_0x3ed21a(0x1a8)](_0x30ce49,_0x2c472e[_0x3ed21a(0x15a)]);if(_0x2c472e[_0x3ed21a(0x15a)]==='PAID'){console['log'](_0x3ed21a(0x187)+_0x48dadd[_0x3ed21a(0x165)]()+_0x3ed21a(0x115)+_0x572c0d+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x51745d}=await Promise[_0x3ed21a(0x12c)]()[_0x3ed21a(0x1cd)](()=>__importStar(require(_0x3ed21a(0x1c7)))),_0x20e676=new _0x51745d();await _0x20e676[_0x3ed21a(0x17e)](_0x572c0d),console[_0x3ed21a(0x1ac)](_0x3ed21a(0x145)+_0x48dadd[_0x3ed21a(0x165)]()+_0x3ed21a(0x115)+_0x572c0d);}catch(_0x2ababa){console['error'](_0x3ed21a(0x128)+_0x48dadd[_0x3ed21a(0x165)]()+_0x3ed21a(0x11f),_0x2ababa);}}}console[_0x3ed21a(0x1ac)]('âœ…\x20'+_0x48dadd[_0x3ed21a(0x165)]()+_0x3ed21a(0x115)+_0x572c0d+'\x20processed:\x20'+_0x2c472e[_0x3ed21a(0x15a)]);if(_0x2c472e[_0x3ed21a(0x15a)]===_0x3ed21a(0x146))_0x5513c9[_0x3ed21a(0x196)]({'success':!![],'message':_0x3ed21a(0x129),'result':{'status':_0x3ed21a(0x146),'gatewayPaymentId':_0x2c472e[_0x3ed21a(0x177)],'redirectUrl':_0x42c13f,'final':!![]}});else _0x2c472e['requires_3ds']&&_0x2c472e[_0x3ed21a(0x170)]?_0x5513c9[_0x3ed21a(0x196)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x2c472e[_0x3ed21a(0x177)],'redirectUrl':_0x2c472e[_0x3ed21a(0x170)],'requires3ds':!![],'final':![]}}):_0x5513c9[_0x3ed21a(0x15a)](0x190)[_0x3ed21a(0x196)]({'success':![],'message':_0x3ed21a(0x1b0),'result':{'status':_0x3ed21a(0x11b),'gatewayPaymentId':_0x2c472e[_0x3ed21a(0x177)],'redirectUrl':_0x30ce49[_0x3ed21a(0x166)],'final':!![]}});}catch(_0x4c7fb4){_0x1d64a3(_0x4c7fb4);}},this[_0x505fcb(0x13d)]=new paymentService_1[(_0x505fcb(0x13f))](),this[_0x505fcb(0x17b)]=new mastercardService_1[(_0x505fcb(0x198))](),this[_0x505fcb(0x131)]=new webhookService_1[(_0x505fcb(0x124))](),this[_0x505fcb(0x15d)]=new currencyService_1['CurrencyService']();}async[a13_0x3ef0a8(0x1c1)](_0x49d993,_0x4a0fb2,_0x35b45b,_0x26c5dd){const _0x85f3d4=a13_0x3ef0a8,_0x235254=Date['now']();try{const _0x3e6058=_0x49d993[_0x85f3d4(0x155)],_0x2fddc9=_0x3e6058[_0x85f3d4(0x178)];if(!_0x2fddc9?.[_0x85f3d4(0x161)]){console[_0x85f3d4(0x1ac)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3e6058['id']);return;}const _0x386cd4=_0x4a0fb2===_0x85f3d4(0x146)?'payment.success':_0x85f3d4(0x153);let _0x4ec9dd=[];if(_0x2fddc9['webhookEvents'])try{_0x4ec9dd=Array['isArray'](_0x2fddc9[_0x85f3d4(0x139)])?_0x2fddc9[_0x85f3d4(0x139)]:JSON[_0x85f3d4(0x19f)](_0x2fddc9[_0x85f3d4(0x139)]);}catch(_0x25e961){console[_0x85f3d4(0x1d5)]('Error\x20parsing\x20webhook\x20events:',_0x25e961),_0x4ec9dd=[];}if(!_0x4ec9dd[_0x85f3d4(0x116)](_0x386cd4)){console[_0x85f3d4(0x1ac)](_0x85f3d4(0x12a)+_0x386cd4+_0x85f3d4(0x1d4)+_0x3e6058['id']);return;}const _0x30b8e4={'event':_0x386cd4,'payment':{'id':_0x49d993['id'],'order_id':_0x49d993[_0x85f3d4(0x12d)],'gateway_order_id':_0x49d993['gatewayOrderId'],'gateway':_0x85f3d4(0x1bd),'card_type':_0x26c5dd?.[_0x85f3d4(0x165)]()||_0x85f3d4(0x1c2),'amount':_0x49d993[_0x85f3d4(0x138)],'currency':_0x49d993[_0x85f3d4(0x17a)],'status':_0x4a0fb2[_0x85f3d4(0x1b6)](),'customer_email':_0x49d993['customerEmail'],'customer_name':_0x49d993['customerName'],'gateway_payment_id':_0x35b45b,'created_at':_0x49d993['createdAt'],'updated_at':new Date()}},_0x29e2ef=JSON[_0x85f3d4(0x1d0)](_0x30b8e4),_0x5183bd=crypto_1[_0x85f3d4(0x1c6)][_0x85f3d4(0x1a1)](_0x85f3d4(0x1a3),_0x3e6058[_0x85f3d4(0x1be)])[_0x85f3d4(0x1b8)](_0x29e2ef)[_0x85f3d4(0x135)](_0x85f3d4(0x191)),_0x23c6fa=await fetch(_0x2fddc9[_0x85f3d4(0x161)],{'method':_0x85f3d4(0x148),'headers':{'Content-Type':_0x85f3d4(0x19e),'User-Agent':'Payment\x20System/1.0\x20('+(_0x26c5dd?.['toUpperCase']()||_0x85f3d4(0x143))+')','X-Webhook-Signature':_0x5183bd},'body':_0x29e2ef}),_0x41e4bf=Date['now']()-_0x235254;console['log']((_0x26c5dd?.[_0x85f3d4(0x165)]()||'VISA/MasterCard')+_0x85f3d4(0x1b9)+_0x2fddc9[_0x85f3d4(0x161)]+_0x85f3d4(0x192)+_0x23c6fa[_0x85f3d4(0x15a)]+'\x20('+_0x41e4bf+_0x85f3d4(0x16a));}catch(_0x287c54){console['error'](_0x85f3d4(0x11a)+(_0x26c5dd?.[_0x85f3d4(0x165)]()||_0x85f3d4(0x143))+_0x85f3d4(0x134),_0x287c54);}}async[a13_0x3ef0a8(0x1a8)](_0x3c9ae7,_0x426ec4){const _0x5f322d=a13_0x3ef0a8;try{const {telegramBotService:_0x3a6994}=await Promise['resolve']()[_0x5f322d(0x1cd)](()=>__importStar(require(_0x5f322d(0x1bc)))),_0x381a60={'PAID':_0x5f322d(0x185),'FAILED':_0x5f322d(0x12f)},_0x5e458a=_0x381a60[_0x426ec4];if(!_0x5e458a)return;await _0x3a6994[_0x5f322d(0x1a2)](_0x3c9ae7[_0x5f322d(0x1ad)],_0x3c9ae7,_0x5e458a);}catch(_0x8ef73f){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x8ef73f);}}}exports[a13_0x3ef0a8(0x123)]=PaymentController;