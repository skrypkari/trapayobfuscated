'use strict';const a8_0xe0692d=a8_0x8661;(function(_0x52570f,_0x9990d8){const _0x4e5be0=a8_0x8661,_0x4632d0=_0x52570f();while(!![]){try{const _0x3a675d=-parseInt(_0x4e5be0(0x12a))/0x1*(parseInt(_0x4e5be0(0x14c))/0x2)+parseInt(_0x4e5be0(0xf0))/0x3*(-parseInt(_0x4e5be0(0x100))/0x4)+-parseInt(_0x4e5be0(0x165))/0x5*(-parseInt(_0x4e5be0(0x128))/0x6)+-parseInt(_0x4e5be0(0x13e))/0x7+-parseInt(_0x4e5be0(0xed))/0x8+parseInt(_0x4e5be0(0xef))/0x9*(-parseInt(_0x4e5be0(0x110))/0xa)+parseInt(_0x4e5be0(0x136))/0xb;if(_0x3a675d===_0x9990d8)break;else _0x4632d0['push'](_0x4632d0['shift']());}catch(_0x3f69a4){_0x4632d0['push'](_0x4632d0['shift']());}}}(a8_0xd8d2,0xb9319));function a8_0xd8d2(){const _0x55f597=['last_name','Payment\x20status\x20is\x20','3DS\x20verification\x20required','mastercard','processMasterCardPayment','💳\x20MasterCard\x20result:','184vcRUQs','cardLast4','PaymentService','../services/webhookService','../services/paymentService','failureMessage','WebhookService','customerEmail','ms)','payment.success','toISOString','includes','__esModule','gatewayPaymentId','Webhook\x20event\x20','final','11590legGnE','getPaymentStatus','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Payment\x20created\x20successfully','updatePaymentCustomerDataPublic','number','../config/database','../services/gateways/mastercardService','writable','\x20not\x20enabled\x20for\x20shop\x20','customerName','toLowerCase','Error\x20parsing\x20webhook\x20events:','country','Payment\x20processed\x20successfully','threeds_url','failed','gatewayOrderId','call','masterCardService','../services/paymentLinkService','PENDING','sendShopWebhook','update','4086aFbwdq','__importDefault','149kDzjVD','create','../services/telegramBotService','💳\x20Card\x20holder:\x20','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','FAILED','💳\x20Browser\x20IP:\x20','Card\x20payment\x20failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getPaymentById','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','Payment\x20not\x20found','46821500iIChGf','error','failUrl','customerCountry','resolve',',\x20cannot\x20process','sendPaymentStatusNotification','MasterCardService','9227050aLXdAo','email','Failed\x20to\x20send\x20MasterCard\x20webhook:','length','📈\x20MasterCard\x20payment\x20','body','json','amount','\x20\x20\x20Return\x20URL:\x20','__importStar','replace','hasOwnProperty','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','params','9574GHZmLo','configurable','now','__createBinding','\x20\x20\x20Result\x20URL\x20(webhook):\x20','stringify','createPublicPayment','then','customerIp','isArray','paymentMethod','\x20with\x20status\x20','default','slice','💳\x20MasterCard\x20URLs:','requires_3ds','currency','https://api.trapay.uk/api/webhooks/gateway/mastercard','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','getOwnPropertyDescriptor','log','status','payment','handleSuccessfulPayment','first_name','5765WlXUsL','updatePaymentCustomer','successUrl','Customer\x20data\x20updated\x20successfully','webhookEvents','gateway_payment_id','shop','gateway','shopId','parse','getOwnPropertyNames','findUnique','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','webhookLog','customerUa','💳\x20Processing\x20MasterCard\x20payment:\x20','get','orderId','PAID','7565064kuFvSa','\x20processed:\x20','8388qRcvaJ','14733ZUchEP','application/json','processCardPayment','paymentService','PaymentController','mastercard_','paidAt','user_agent','webhookUrl','defineProperty'];a8_0xd8d2=function(){return _0x55f597;};return a8_0xd8d2();}function a8_0x8661(_0x488eeb,_0x3bf159){const _0xd8d25f=a8_0xd8d2();return a8_0x8661=function(_0x86614,_0x30e0c5){_0x86614=_0x86614-0xe5;let _0x26cf8c=_0xd8d25f[_0x86614];return _0x26cf8c;},a8_0x8661(_0x488eeb,_0x3bf159);}var __createBinding=this&&this[a8_0xe0692d(0x14f)]||(Object['create']?function(_0x1e5ba2,_0x220f25,_0x3c1a6f,_0x5eb053){const _0x4573dd=a8_0xe0692d;if(_0x5eb053===undefined)_0x5eb053=_0x3c1a6f;var _0x3068c0=Object[_0x4573dd(0x15f)](_0x220f25,_0x3c1a6f);(!_0x3068c0||(_0x4573dd(0xea)in _0x3068c0?!_0x220f25[_0x4573dd(0x10c)]:_0x3068c0[_0x4573dd(0x118)]||_0x3068c0[_0x4573dd(0x14d)]))&&(_0x3068c0={'enumerable':!![],'get':function(){return _0x220f25[_0x3c1a6f];}}),Object[_0x4573dd(0xf9)](_0x1e5ba2,_0x5eb053,_0x3068c0);}:function(_0x2670ec,_0x394995,_0x5b2a85,_0x33dff1){if(_0x33dff1===undefined)_0x33dff1=_0x5b2a85;_0x2670ec[_0x33dff1]=_0x394995[_0x5b2a85];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0xe0692d(0x12b)]?function(_0x556d3c,_0x4f8cba){const _0x17f03b=a8_0xe0692d;Object[_0x17f03b(0xf9)](_0x556d3c,_0x17f03b(0x158),{'enumerable':!![],'value':_0x4f8cba});}:function(_0x13c4d6,_0x2754a1){const _0x23b626=a8_0xe0692d;_0x13c4d6[_0x23b626(0x158)]=_0x2754a1;}),__importStar=this&&this[a8_0xe0692d(0x147)]||(function(){var _0x3947ea=function(_0x5ec57a){const _0xd856ab=a8_0x8661;return _0x3947ea=Object[_0xd856ab(0x16f)]||function(_0x3b0fd){const _0x2cb8ce=_0xd856ab;var _0x54861c=[];for(var _0x27b753 in _0x3b0fd)if(Object['prototype'][_0x2cb8ce(0x149)][_0x2cb8ce(0x122)](_0x3b0fd,_0x27b753))_0x54861c[_0x54861c[_0x2cb8ce(0x141)]]=_0x27b753;return _0x54861c;},_0x3947ea(_0x5ec57a);};return function(_0x3a5c2f){const _0x5333a3=a8_0x8661;if(_0x3a5c2f&&_0x3a5c2f[_0x5333a3(0x10c)])return _0x3a5c2f;var _0x2e349e={};if(_0x3a5c2f!=null){for(var _0x29ef1f=_0x3947ea(_0x3a5c2f),_0x29a589=0x0;_0x29a589<_0x29ef1f[_0x5333a3(0x141)];_0x29a589++)if(_0x29ef1f[_0x29a589]!==_0x5333a3(0x158))__createBinding(_0x2e349e,_0x3a5c2f,_0x29ef1f[_0x29a589]);}return __setModuleDefault(_0x2e349e,_0x3a5c2f),_0x2e349e;};}()),__importDefault=this&&this[a8_0xe0692d(0x129)]||function(_0xe47507){const _0x1102e8=a8_0xe0692d;return _0xe47507&&_0xe47507[_0x1102e8(0x10c)]?_0xe47507:{'default':_0xe47507};};Object[a8_0xe0692d(0xf9)](exports,'__esModule',{'value':!![]}),exports[a8_0xe0692d(0xf4)]=void 0x0;const paymentService_1=require(a8_0xe0692d(0x104)),mastercardService_1=require(a8_0xe0692d(0x117)),webhookService_1=require(a8_0xe0692d(0x103)),database_1=__importDefault(require(a8_0xe0692d(0x116)));class PaymentController{constructor(){const _0xb9c6c=a8_0xe0692d;this[_0xb9c6c(0x152)]=async(_0x4f4fef,_0x17df68,_0x4b212f)=>{const _0x39ff76=_0xb9c6c;try{const _0x26dcc9=_0x4f4fef[_0x39ff76(0x143)],_0x52ba34=await this[_0x39ff76(0xf3)][_0x39ff76(0x152)](_0x26dcc9);_0x17df68['status'](0xc9)[_0x39ff76(0x144)]({'success':!![],'message':_0x39ff76(0x113),'result':_0x52ba34});}catch(_0x11f780){_0x4b212f(_0x11f780);}},this['getPaymentStatus']=async(_0x166bcb,_0x3bead5,_0x9f7ea2)=>{const _0x2508f4=_0xb9c6c;try{const {id:_0x409625}=_0x166bcb[_0x2508f4(0x14b)],_0x581af4=await this[_0x2508f4(0xf3)][_0x2508f4(0x111)](_0x409625);if(!_0x581af4)return _0x3bead5['status'](0x194)[_0x2508f4(0x144)]({'success':![],'message':_0x2508f4(0x135)});_0x3bead5[_0x2508f4(0x144)]({'success':!![],'result':_0x581af4});}catch(_0x29c309){_0x9f7ea2(_0x29c309);}},this[_0xb9c6c(0x133)]=async(_0x172d5b,_0x307293,_0x2703b9)=>{const _0x3e0973=_0xb9c6c;try{const {id:_0x17f6df}=_0x172d5b['params'],_0x1ac6e9=await this[_0x3e0973(0xf3)]['getPaymentById'](_0x17f6df);if(!_0x1ac6e9)return _0x307293['status'](0x194)[_0x3e0973(0x144)]({'success':![],'message':_0x3e0973(0x135)});_0x307293['json']({'success':!![],'result':_0x1ac6e9});}catch(_0xb36593){_0x2703b9(_0xb36593);}},this[_0xb9c6c(0x166)]=async(_0x26df8b,_0x7e278e,_0x16d329)=>{const _0x1eb015=_0xb9c6c;try{const {id:_0x4a29fe}=_0x26df8b['params'],_0xfc3f85=_0x26df8b[_0x1eb015(0x143)];console[_0x1eb015(0x160)](_0x1eb015(0x112)+_0x4a29fe),console['log']('📝\x20Customer\x20data:',_0xfc3f85);const _0x55a24d=await this[_0x1eb015(0xf3)][_0x1eb015(0x114)](_0x4a29fe,_0xfc3f85);if(!_0x55a24d)return _0x7e278e['status'](0x194)[_0x1eb015(0x144)]({'success':![],'message':'Payment\x20not\x20found'});_0x7e278e[_0x1eb015(0x144)]({'success':!![],'message':_0x1eb015(0x168),'result':{'paymentId':_0x55a24d['id'],'customerIp':_0x55a24d[_0x1eb015(0x154)],'customerUa':_0x55a24d[_0x1eb015(0xe8)],'customerCountry':_0x55a24d[_0x1eb015(0x139)],'updatedAt':_0x55a24d['updatedAt']}});}catch(_0x329696){_0x16d329(_0x329696);}},this[_0xb9c6c(0xfe)]=async(_0x4fd1c0,_0x4699c0,_0x12f42c)=>{const _0x4c9edc=_0xb9c6c;try{const {id:_0x130b2c}=_0x4fd1c0[_0x4c9edc(0x14b)],{cardData:_0x20dd84,cardHolder:_0x291ae2,browser:_0x2704a2}=_0x4fd1c0[_0x4c9edc(0x143)];console['log'](_0x4c9edc(0xe9)+_0x130b2c),console[_0x4c9edc(0x160)](_0x4c9edc(0x12d)+_0x291ae2[_0x4c9edc(0x164)]+'\x20'+_0x291ae2[_0x4c9edc(0xfa)]+'\x20('+_0x291ae2[_0x4c9edc(0x13f)]+')'),console[_0x4c9edc(0x160)](_0x4c9edc(0x130)+_0x2704a2['ip']);const _0x4a598f={'customerName':_0x291ae2[_0x4c9edc(0x164)]+'\x20'+_0x291ae2[_0x4c9edc(0xfa)],'customerEmail':_0x291ae2['email'],'customerIp':_0x2704a2['ip'],'customerUa':_0x2704a2[_0x4c9edc(0xf7)],'customerCountry':_0x291ae2[_0x4c9edc(0x11d)]||null},_0x5caa7d=await database_1[_0x4c9edc(0x158)]['payment'][_0x4c9edc(0xe5)]({'where':{'id':_0x130b2c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5caa7d)return _0x4699c0[_0x4c9edc(0x161)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x5caa7d[_0x4c9edc(0x16c)]!==_0x4c9edc(0xfd))return _0x4699c0[_0x4c9edc(0x161)](0x190)['json']({'success':![],'message':_0x4c9edc(0x12e)});if(_0x5caa7d['status']!==_0x4c9edc(0x125))return _0x4699c0[_0x4c9edc(0x161)](0x190)[_0x4c9edc(0x144)]({'success':![],'message':_0x4c9edc(0xfb)+_0x5caa7d[_0x4c9edc(0x161)]+_0x4c9edc(0x13b)});await database_1[_0x4c9edc(0x158)][_0x4c9edc(0x162)]['update']({'where':{'id':_0x130b2c},'data':{..._0x4a598f,'updatedAt':new Date()}});const _0x2e709e=_0x4c9edc(0x15d),_0x2fba7f=_0x5caa7d[_0x4c9edc(0x167)];console[_0x4c9edc(0x160)](_0x4c9edc(0x15a)),console[_0x4c9edc(0x160)](_0x4c9edc(0x150)+_0x2e709e),console[_0x4c9edc(0x160)](_0x4c9edc(0x146)+_0x2fba7f);const _0x42222f={'first_name':_0x291ae2[_0x4c9edc(0x164)],'last_name':_0x291ae2[_0x4c9edc(0xfa)],'email':_0x291ae2[_0x4c9edc(0x13f)]},_0x169342=await this[_0x4c9edc(0x123)][_0x4c9edc(0xf2)]({'paymentId':_0x5caa7d['id'],'orderId':_0x5caa7d[_0x4c9edc(0x121)]||_0x5caa7d['id'],'amount':_0x5caa7d[_0x4c9edc(0x145)],'currency':_0x5caa7d[_0x4c9edc(0x15c)],'cardData':_0x20dd84,'resultUrl':_0x2e709e,'returnUrl':_0x2fba7f,'cardHolder':_0x42222f,'browser':_0x2704a2});console[_0x4c9edc(0x160)](_0x4c9edc(0xff),_0x169342);const _0x4c1796={'status':_0x169342[_0x4c9edc(0x161)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x169342[_0x4c9edc(0x161)]==='PAID')_0x4c1796[_0x4c9edc(0xf6)]=new Date(),_0x4c1796[_0x4c9edc(0x10d)]=_0x169342['gateway_payment_id'];else _0x169342[_0x4c9edc(0x161)]===_0x4c9edc(0x12f)&&(_0x4c1796[_0x4c9edc(0x105)]=_0x4c9edc(0x131));_0x4c1796[_0x4c9edc(0x156)]='mastercard';if(_0x20dd84['number']){const _0x4ddc9d=_0x20dd84[_0x4c9edc(0x115)][_0x4c9edc(0x148)](/[\s-]/g,'');_0x4c1796['cardLast4']=_0x4ddc9d[_0x4c9edc(0x159)](-0x4),console[_0x4c9edc(0x160)](_0x4c9edc(0x15e)+_0x4c1796[_0x4c9edc(0x101)]);}await database_1[_0x4c9edc(0x158)][_0x4c9edc(0x162)][_0x4c9edc(0x127)]({'where':{'id':_0x5caa7d['id']},'data':_0x4c1796}),await database_1[_0x4c9edc(0x158)][_0x4c9edc(0xe7)][_0x4c9edc(0x12b)]({'data':{'paymentId':_0x5caa7d['id'],'shopId':_0x5caa7d['shopId'],'event':_0x4c9edc(0xf5)+_0x169342['status']?.[_0x4c9edc(0x11b)](),'statusCode':0xc8,'responseBody':JSON[_0x4c9edc(0x151)]({'oldStatus':_0x4c9edc(0x125),'newStatus':_0x169342['status'],'gatewayPaymentId':_0x169342['gateway_payment_id'],'requires3ds':_0x169342['requires_3ds'],'processedAt':new Date()[_0x4c9edc(0x10a)]()})}});if(_0x169342[_0x4c9edc(0x10f)]){await this['sendShopWebhook'](_0x5caa7d,_0x169342['status'],_0x169342['gateway_payment_id']),await this[_0x4c9edc(0x13c)](_0x5caa7d,_0x169342[_0x4c9edc(0x161)]);if(_0x169342[_0x4c9edc(0x161)]===_0x4c9edc(0xec)){console[_0x4c9edc(0x160)](_0x4c9edc(0x142)+_0x130b2c+_0x4c9edc(0xe6));try{const {PaymentLinkService:_0xe5814c}=await Promise[_0x4c9edc(0x13a)]()[_0x4c9edc(0x153)](()=>__importStar(require(_0x4c9edc(0x124)))),_0x298a21=new _0xe5814c();await _0x298a21[_0x4c9edc(0x163)](_0x130b2c),console[_0x4c9edc(0x160)](_0x4c9edc(0x14a)+_0x130b2c);}catch(_0x25965e){console[_0x4c9edc(0x137)](_0x4c9edc(0x134),_0x25965e);}}}console[_0x4c9edc(0x160)]('✅\x20MasterCard\x20payment\x20'+_0x130b2c+_0x4c9edc(0xee)+_0x169342['status']);if(_0x169342[_0x4c9edc(0x161)]===_0x4c9edc(0xec))_0x4699c0[_0x4c9edc(0x144)]({'success':!![],'message':_0x4c9edc(0x11e),'result':{'status':_0x4c9edc(0xec),'gatewayPaymentId':_0x169342[_0x4c9edc(0x16a)],'redirectUrl':_0x2fba7f,'final':!![]}});else _0x169342[_0x4c9edc(0x15b)]&&_0x169342[_0x4c9edc(0x11f)]?_0x4699c0['json']({'success':!![],'message':_0x4c9edc(0xfc),'result':{'status':'PENDING','gatewayPaymentId':_0x169342['gateway_payment_id'],'redirectUrl':_0x169342[_0x4c9edc(0x11f)],'requires3ds':!![],'final':![]}}):_0x4699c0[_0x4c9edc(0x161)](0x190)[_0x4c9edc(0x144)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x169342[_0x4c9edc(0x16a)],'redirectUrl':_0x5caa7d[_0x4c9edc(0x138)],'final':!![]}});}catch(_0x23712f){_0x12f42c(_0x23712f);}},this[_0xb9c6c(0xf3)]=new paymentService_1[(_0xb9c6c(0x102))](),this[_0xb9c6c(0x123)]=new mastercardService_1[(_0xb9c6c(0x13d))](),this['webhookService']=new webhookService_1[(_0xb9c6c(0x106))]();}async[a8_0xe0692d(0x126)](_0x16bf15,_0x5ef0ef,_0xb7848c){const _0x205aa5=a8_0xe0692d,_0x590792=Date[_0x205aa5(0x14e)]();try{const _0x28c741=_0x16bf15[_0x205aa5(0x16b)],_0x5df601=_0x28c741['settings'];if(!_0x5df601?.[_0x205aa5(0xf8)]){console[_0x205aa5(0x160)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x28c741['id']);return;}const _0x233736=_0x5ef0ef==='PAID'?_0x205aa5(0x109):'payment.failed';let _0x4ff86d=[];if(_0x5df601[_0x205aa5(0x169)])try{_0x4ff86d=Array[_0x205aa5(0x155)](_0x5df601[_0x205aa5(0x169)])?_0x5df601['webhookEvents']:JSON[_0x205aa5(0x16e)](_0x5df601[_0x205aa5(0x169)]);}catch(_0x3316e8){console['error'](_0x205aa5(0x11c),_0x3316e8),_0x4ff86d=[];}if(!_0x4ff86d[_0x205aa5(0x10b)](_0x233736)){console[_0x205aa5(0x160)](_0x205aa5(0x10e)+_0x233736+_0x205aa5(0x119)+_0x28c741['id']);return;}const _0x28c251={'event':_0x233736,'payment':{'id':_0x16bf15['id'],'order_id':_0x16bf15[_0x205aa5(0xeb)],'gateway_order_id':_0x16bf15[_0x205aa5(0x121)],'gateway':'1111','amount':_0x16bf15[_0x205aa5(0x145)],'currency':_0x16bf15[_0x205aa5(0x15c)],'status':_0x5ef0ef[_0x205aa5(0x11b)](),'customer_email':_0x16bf15[_0x205aa5(0x107)],'customer_name':_0x16bf15[_0x205aa5(0x11a)],'gateway_payment_id':_0xb7848c,'created_at':_0x16bf15['createdAt'],'updated_at':new Date()}},_0x4ac658=await fetch(_0x5df601[_0x205aa5(0xf8)],{'method':'POST','headers':{'Content-Type':_0x205aa5(0xf1),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x205aa5(0x151)](_0x28c251)}),_0x3fe33a=Date[_0x205aa5(0x14e)]()-_0x590792;console[_0x205aa5(0x160)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5df601['webhookUrl']+_0x205aa5(0x157)+_0x4ac658['status']+'\x20('+_0x3fe33a+_0x205aa5(0x108));}catch(_0x24647d){console['error'](_0x205aa5(0x140),_0x24647d);}}async[a8_0xe0692d(0x13c)](_0x475653,_0x22666c){const _0x466cde=a8_0xe0692d;try{const {telegramBotService:_0x4bf6f8}=await Promise['resolve']()['then'](()=>__importStar(require(_0x466cde(0x12c)))),_0x2c4e24={'PAID':'paid','FAILED':_0x466cde(0x120)},_0x2337f7=_0x2c4e24[_0x22666c];if(!_0x2337f7)return;await _0x4bf6f8['sendPaymentNotification'](_0x475653[_0x466cde(0x16d)],_0x475653,_0x2337f7);}catch(_0xf7f161){console[_0x466cde(0x137)](_0x466cde(0x132),_0xf7f161);}}}exports[a8_0xe0692d(0xf4)]=PaymentController;