'use strict';const a8_0x243609=a8_0x56e7;(function(_0x48c941,_0x190d8f){const _0x4a7d79=a8_0x56e7,_0x3b43bd=_0x48c941();while(!![]){try{const _0x591991=parseInt(_0x4a7d79(0x1f8))/0x1+parseInt(_0x4a7d79(0x194))/0x2*(parseInt(_0x4a7d79(0x1f5))/0x3)+parseInt(_0x4a7d79(0x1b3))/0x4+-parseInt(_0x4a7d79(0x1da))/0x5*(-parseInt(_0x4a7d79(0x1ed))/0x6)+-parseInt(_0x4a7d79(0x1c6))/0x7*(-parseInt(_0x4a7d79(0x1de))/0x8)+-parseInt(_0x4a7d79(0x1b2))/0x9+-parseInt(_0x4a7d79(0x1f1))/0xa*(parseInt(_0x4a7d79(0x1f2))/0xb);if(_0x591991===_0x190d8f)break;else _0x3b43bd['push'](_0x3b43bd['shift']());}catch(_0x56f3c3){_0x3b43bd['push'](_0x3b43bd['shift']());}}}(a8_0x1ae3,0xd901b));var __createBinding=this&&this['__createBinding']||(Object[a8_0x243609(0x1ac)]?function(_0x25e589,_0x45b83d,_0x5d9a3d,_0x443d3e){const _0x1fa226=a8_0x243609;if(_0x443d3e===undefined)_0x443d3e=_0x5d9a3d;var _0x515ff4=Object[_0x1fa226(0x1df)](_0x45b83d,_0x5d9a3d);(!_0x515ff4||(_0x1fa226(0x1f0)in _0x515ff4?!_0x45b83d['__esModule']:_0x515ff4[_0x1fa226(0x1ab)]||_0x515ff4[_0x1fa226(0x1ba)]))&&(_0x515ff4={'enumerable':!![],'get':function(){return _0x45b83d[_0x5d9a3d];}}),Object['defineProperty'](_0x25e589,_0x443d3e,_0x515ff4);}:function(_0x6802b6,_0xec37ee,_0x11888f,_0x95ade3){if(_0x95ade3===undefined)_0x95ade3=_0x11888f;_0x6802b6[_0x95ade3]=_0xec37ee[_0x11888f];}),__setModuleDefault=this&&this[a8_0x243609(0x1a5)]||(Object['create']?function(_0x5dc041,_0x444aa6){const _0x1bfd13=a8_0x243609;Object[_0x1bfd13(0x1d2)](_0x5dc041,'default',{'enumerable':!![],'value':_0x444aa6});}:function(_0x53a25b,_0x13fa9d){const _0x3fd498=a8_0x243609;_0x53a25b[_0x3fd498(0x1d6)]=_0x13fa9d;}),__importStar=this&&this[a8_0x243609(0x1b4)]||(function(){var _0x5146ef=function(_0x4c467d){const _0x23a3e0=a8_0x56e7;return _0x5146ef=Object[_0x23a3e0(0x198)]||function(_0x403c40){const _0x2961c7=_0x23a3e0;var _0x35544c=[];for(var _0x304b28 in _0x403c40)if(Object[_0x2961c7(0x1ee)][_0x2961c7(0x1bf)]['call'](_0x403c40,_0x304b28))_0x35544c[_0x35544c[_0x2961c7(0x1c3)]]=_0x304b28;return _0x35544c;},_0x5146ef(_0x4c467d);};return function(_0x4e1aca){const _0x570389=a8_0x56e7;if(_0x4e1aca&&_0x4e1aca[_0x570389(0x1eb)])return _0x4e1aca;var _0xfae41d={};if(_0x4e1aca!=null){for(var _0x160cec=_0x5146ef(_0x4e1aca),_0x16788a=0x0;_0x16788a<_0x160cec[_0x570389(0x1c3)];_0x16788a++)if(_0x160cec[_0x16788a]!==_0x570389(0x1d6))__createBinding(_0xfae41d,_0x4e1aca,_0x160cec[_0x16788a]);}return __setModuleDefault(_0xfae41d,_0x4e1aca),_0xfae41d;};}()),__importDefault=this&&this[a8_0x243609(0x1c0)]||function(_0x261d1e){const _0x34cde7=a8_0x243609;return _0x261d1e&&_0x261d1e[_0x34cde7(0x1eb)]?_0x261d1e:{'default':_0x261d1e};};function a8_0x1ae3(){const _0x5d7841=['settings','46857LICPYI','error','update','413085YhHSPO','status','../services/paymentService','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','paymentMethod','gateway_payment_id','updatePaymentCustomer','💳\x20MasterCard\x20result:','\x20\x20\x20Return\x20URL:\x20','webhookUrl','mastercard','sendShopWebhook','6HhBeDw','stringify','Payment\x20failed','✅\x20MasterCard\x20payment\x20','getOwnPropertyNames','customerCountry','createPublicPayment','sendPaymentNotification','PaymentController','https://api.trapay.uk/api/webhooks/gateway/mastercard','WebhookService','body','log','json','params','system','now','__setModuleDefault','customerName','webhookLog','Payment\x20created\x20successfully','webhookService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','writable','create','Customer\x20data\x20updated\x20successfully','\x20with\x20status\x20','ms)','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentService','3932964aUHCmr','5555872qnTtwI','__importStar','gatewayOrderId','paid','shopId','📝\x20Customer\x20data:','Error\x20parsing\x20webhook\x20events:','configurable','payment','sendPaymentStatusNotification','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','shop','hasOwnProperty','__importDefault','\x20not\x20enabled\x20for\x20shop\x20','mastercard_','length','isArray','MasterCardService','5755127vsuaHe','currency','then','Payment\x20processed\x20successfully','paidAt','💳\x20MasterCard\x20URLs:','Payment\x20not\x20found','resolve','PENDING','threeds_url','MasterCard\x20webhook\x20sent\x20to\x20','failUrl','defineProperty','payment.failed','processCardPayment','payment.success','default','../services/telegramBotService','failed','PAID','3422450taDnzr','processMasterCardPayment','Card\x20payment\x20failed','Payment\x20status\x20is\x20','8ARXfix','getOwnPropertyDescriptor','webhookEvents','FAILED','parse','getPaymentStatus','requires_3ds','includes','gatewayPaymentId','updatePaymentCustomerDataPublic','POST','amount','../services/webhookService','__esModule','\x20\x20\x20Result\x20URL\x20(webhook):\x20','12DMyfPC','prototype','masterCardService','get','40laQJco','7464039qXBjUO','Failed\x20to\x20send\x20MasterCard\x20webhook:'];a8_0x1ae3=function(){return _0x5d7841;};return a8_0x1ae3();}function a8_0x56e7(_0x28fb63,_0x3ca53d){const _0x1ae395=a8_0x1ae3();return a8_0x56e7=function(_0x56e743,_0x1f36b7){_0x56e743=_0x56e743-0x194;let _0x2b3475=_0x1ae395[_0x56e743];return _0x2b3475;},a8_0x56e7(_0x28fb63,_0x3ca53d);}Object['defineProperty'](exports,a8_0x243609(0x1eb),{'value':!![]}),exports[a8_0x243609(0x19c)]=void 0x0;const paymentService_1=require(a8_0x243609(0x1fa)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x243609(0x1ea)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x4ab769=a8_0x243609;this[_0x4ab769(0x19a)]=async(_0x2e13a6,_0x2e02ce,_0x4d7500)=>{const _0x47706b=_0x4ab769;try{const _0x35ff87=_0x2e13a6[_0x47706b(0x19f)],_0x389ea9=await this[_0x47706b(0x1b1)]['createPublicPayment'](_0x35ff87);_0x2e02ce[_0x47706b(0x1f9)](0xc9)[_0x47706b(0x1a1)]({'success':!![],'message':_0x47706b(0x1a8),'result':_0x389ea9});}catch(_0x1e119d){_0x4d7500(_0x1e119d);}},this[_0x4ab769(0x1e3)]=async(_0x35fe7c,_0x1927f8,_0x5356d6)=>{const _0x166117=_0x4ab769;try{const {id:_0xec42f1}=_0x35fe7c[_0x166117(0x1a2)],_0x183f53=await this['paymentService'][_0x166117(0x1e3)](_0xec42f1);if(!_0x183f53)return _0x1927f8[_0x166117(0x1f9)](0x194)[_0x166117(0x1a1)]({'success':![],'message':_0x166117(0x1cc)});_0x1927f8[_0x166117(0x1a1)]({'success':!![],'result':_0x183f53});}catch(_0x546f22){_0x5356d6(_0x546f22);}},this['getPaymentById']=async(_0x48d388,_0x155ad5,_0x1e3003)=>{const _0x27eccf=_0x4ab769;try{const {id:_0x5cba16}=_0x48d388[_0x27eccf(0x1a2)],_0x5e98a7=await this['paymentService']['getPaymentById'](_0x5cba16);if(!_0x5e98a7)return _0x155ad5[_0x27eccf(0x1f9)](0x194)[_0x27eccf(0x1a1)]({'success':![],'message':_0x27eccf(0x1cc)});_0x155ad5[_0x27eccf(0x1a1)]({'success':!![],'result':_0x5e98a7});}catch(_0x448e89){_0x1e3003(_0x448e89);}},this[_0x4ab769(0x1fe)]=async(_0x1f6ba7,_0x2e0ede,_0x1f2922)=>{const _0x41f0ce=_0x4ab769;try{const {id:_0x2b7364}=_0x1f6ba7[_0x41f0ce(0x1a2)],_0x5da9cb=_0x1f6ba7[_0x41f0ce(0x19f)];console[_0x41f0ce(0x1a0)](_0x41f0ce(0x1fb)+_0x2b7364),console['log'](_0x41f0ce(0x1b8),_0x5da9cb);const _0xc3eae8=await this[_0x41f0ce(0x1b1)][_0x41f0ce(0x1e7)](_0x2b7364,_0x5da9cb);if(!_0xc3eae8)return _0x2e0ede[_0x41f0ce(0x1f9)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x2e0ede['json']({'success':!![],'message':_0x41f0ce(0x1ad),'result':{'paymentId':_0xc3eae8['id'],'customerIp':_0xc3eae8['customerIp'],'customerUa':_0xc3eae8['customerUa'],'customerCountry':_0xc3eae8[_0x41f0ce(0x199)],'updatedAt':_0xc3eae8['updatedAt']}});}catch(_0x1d0006){_0x1f2922(_0x1d0006);}},this[_0x4ab769(0x1db)]=async(_0x1a147d,_0x2ca901,_0x5e74b2)=>{const _0x350e76=_0x4ab769;try{const {id:_0x5cc220}=_0x1a147d[_0x350e76(0x1a2)],{cardData:_0xc49a71,cardHolder:_0x507405,browser:_0x44e747}=_0x1a147d[_0x350e76(0x19f)];console[_0x350e76(0x1a0)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x5cc220);const _0x82291d=await database_1[_0x350e76(0x1d6)][_0x350e76(0x1bb)]['findUnique']({'where':{'id':_0x5cc220},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x82291d)return _0x2ca901[_0x350e76(0x1f9)](0x194)[_0x350e76(0x1a1)]({'success':![],'message':_0x350e76(0x1cc)});if(_0x82291d['gateway']!=='mastercard')return _0x2ca901[_0x350e76(0x1f9)](0x190)[_0x350e76(0x1a1)]({'success':![],'message':_0x350e76(0x1aa)});if(_0x82291d[_0x350e76(0x1f9)]!=='PENDING')return _0x2ca901[_0x350e76(0x1f9)](0x190)[_0x350e76(0x1a1)]({'success':![],'message':_0x350e76(0x1dd)+_0x82291d[_0x350e76(0x1f9)]+',\x20cannot\x20process'});const _0x33fde0=_0x350e76(0x19d),_0x48d769=_0x82291d['successUrl'];console[_0x350e76(0x1a0)](_0x350e76(0x1cb)),console[_0x350e76(0x1a0)](_0x350e76(0x1ec)+_0x33fde0),console[_0x350e76(0x1a0)](_0x350e76(0x200)+_0x48d769);const _0x55b5f1=await this['masterCardService'][_0x350e76(0x1d4)]({'paymentId':_0x82291d['id'],'orderId':_0x82291d[_0x350e76(0x1b5)]||_0x82291d['id'],'amount':_0x82291d[_0x350e76(0x1e9)],'currency':_0x82291d[_0x350e76(0x1c7)],'cardData':_0xc49a71,'resultUrl':_0x33fde0,'returnUrl':_0x48d769,'cardHolder':_0x507405,'browser':_0x44e747});console['log'](_0x350e76(0x1ff),_0x55b5f1);const _0x582dcb={'status':_0x55b5f1['status'],'updatedAt':new Date(),'statusChangedBy':_0x350e76(0x1a3),'statusChangedAt':new Date()};if(_0x55b5f1['status']==='PAID')_0x582dcb[_0x350e76(0x1ca)]=new Date(),_0x582dcb[_0x350e76(0x1e6)]=_0x55b5f1[_0x350e76(0x1fd)];else _0x55b5f1[_0x350e76(0x1f9)]===_0x350e76(0x1e1)&&(_0x582dcb['failureMessage']=_0x350e76(0x1dc));_0x582dcb[_0x350e76(0x1fc)]=_0x350e76(0x202),await database_1['default'][_0x350e76(0x1bb)][_0x350e76(0x1f7)]({'where':{'id':_0x82291d['id']},'data':_0x582dcb}),await database_1[_0x350e76(0x1d6)][_0x350e76(0x1a7)]['create']({'data':{'paymentId':_0x82291d['id'],'shopId':_0x82291d[_0x350e76(0x1b7)],'event':_0x350e76(0x1c2)+_0x55b5f1[_0x350e76(0x1f9)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x350e76(0x195)]({'oldStatus':_0x350e76(0x1ce),'newStatus':_0x55b5f1[_0x350e76(0x1f9)],'gatewayPaymentId':_0x55b5f1[_0x350e76(0x1fd)],'requires3ds':_0x55b5f1['requires_3ds'],'processedAt':new Date()['toISOString']()})}});_0x55b5f1['final']&&(await this[_0x350e76(0x203)](_0x82291d,_0x55b5f1[_0x350e76(0x1f9)],_0x55b5f1[_0x350e76(0x1fd)]),await this[_0x350e76(0x1bc)](_0x82291d,_0x55b5f1[_0x350e76(0x1f9)]));console[_0x350e76(0x1a0)](_0x350e76(0x197)+_0x5cc220+'\x20processed:\x20'+_0x55b5f1[_0x350e76(0x1f9)]);if(_0x55b5f1[_0x350e76(0x1f9)]==='PAID')_0x2ca901[_0x350e76(0x1a1)]({'success':!![],'message':_0x350e76(0x1c9),'result':{'status':'PAID','gatewayPaymentId':_0x55b5f1[_0x350e76(0x1fd)],'redirectUrl':_0x48d769,'final':!![]}});else _0x55b5f1[_0x350e76(0x1e4)]&&_0x55b5f1['threeds_url']?_0x2ca901[_0x350e76(0x1a1)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x350e76(0x1ce),'gatewayPaymentId':_0x55b5f1['gateway_payment_id'],'redirectUrl':_0x55b5f1[_0x350e76(0x1cf)],'requires3ds':!![],'final':![]}}):_0x2ca901[_0x350e76(0x1f9)](0x190)[_0x350e76(0x1a1)]({'success':![],'message':_0x350e76(0x196),'result':{'status':_0x350e76(0x1e1),'gatewayPaymentId':_0x55b5f1[_0x350e76(0x1fd)],'redirectUrl':_0x82291d[_0x350e76(0x1d1)],'final':!![]}});}catch(_0x457afc){_0x5e74b2(_0x457afc);}},this[_0x4ab769(0x1b1)]=new paymentService_1['PaymentService'](),this[_0x4ab769(0x1ef)]=new mastercardService_1[(_0x4ab769(0x1c5))](),this[_0x4ab769(0x1a9)]=new webhookService_1[(_0x4ab769(0x19e))]();}async[a8_0x243609(0x203)](_0x1912d2,_0x44285a,_0xfaa61a){const _0x4be543=a8_0x243609,_0x576b42=Date[_0x4be543(0x1a4)]();try{const _0x197e75=_0x1912d2[_0x4be543(0x1be)],_0x35e510=_0x197e75[_0x4be543(0x1f4)];if(!_0x35e510?.[_0x4be543(0x201)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x197e75['id']);return;}const _0x564d3f=_0x44285a===_0x4be543(0x1d9)?_0x4be543(0x1d5):_0x4be543(0x1d3);let _0x36f71c=[];if(_0x35e510[_0x4be543(0x1e0)])try{_0x36f71c=Array[_0x4be543(0x1c4)](_0x35e510[_0x4be543(0x1e0)])?_0x35e510[_0x4be543(0x1e0)]:JSON[_0x4be543(0x1e2)](_0x35e510['webhookEvents']);}catch(_0x511631){console[_0x4be543(0x1f6)](_0x4be543(0x1b9),_0x511631),_0x36f71c=[];}if(!_0x36f71c[_0x4be543(0x1e5)](_0x564d3f)){console[_0x4be543(0x1a0)]('Webhook\x20event\x20'+_0x564d3f+_0x4be543(0x1c1)+_0x197e75['id']);return;}const _0x443cd6={'event':_0x564d3f,'payment':{'id':_0x1912d2['id'],'order_id':_0x1912d2['orderId'],'gateway_order_id':_0x1912d2[_0x4be543(0x1b5)],'gateway':'1111','amount':_0x1912d2[_0x4be543(0x1e9)],'currency':_0x1912d2['currency'],'status':_0x44285a['toLowerCase'](),'customer_email':_0x1912d2['customerEmail'],'customer_name':_0x1912d2[_0x4be543(0x1a6)],'gateway_payment_id':_0xfaa61a,'created_at':_0x1912d2['createdAt'],'updated_at':new Date()}},_0x4069aa=await fetch(_0x35e510['webhookUrl'],{'method':_0x4be543(0x1e8),'headers':{'Content-Type':'application/json','User-Agent':_0x4be543(0x1bd)},'body':JSON[_0x4be543(0x195)](_0x443cd6)}),_0x46d713=Date[_0x4be543(0x1a4)]()-_0x576b42;console[_0x4be543(0x1a0)](_0x4be543(0x1d0)+_0x35e510[_0x4be543(0x201)]+_0x4be543(0x1ae)+_0x4069aa[_0x4be543(0x1f9)]+'\x20('+_0x46d713+_0x4be543(0x1af));}catch(_0x5195ab){console[_0x4be543(0x1f6)](_0x4be543(0x1f3),_0x5195ab);}}async[a8_0x243609(0x1bc)](_0x52e3de,_0x328a66){const _0x5e3cf2=a8_0x243609;try{const {telegramBotService:_0x378dea}=await Promise[_0x5e3cf2(0x1cd)]()[_0x5e3cf2(0x1c8)](()=>__importStar(require(_0x5e3cf2(0x1d7)))),_0x2aa936={'PAID':_0x5e3cf2(0x1b6),'FAILED':_0x5e3cf2(0x1d8)},_0x2aaf99=_0x2aa936[_0x328a66];if(!_0x2aaf99)return;await _0x378dea[_0x5e3cf2(0x19b)](_0x52e3de['shopId'],_0x52e3de,_0x2aaf99);}catch(_0x396dde){console[_0x5e3cf2(0x1f6)](_0x5e3cf2(0x1b0),_0x396dde);}}}exports[a8_0x243609(0x19c)]=PaymentController;