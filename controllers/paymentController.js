'use strict';const a8_0x4f2b99=a8_0x4e29;(function(_0x5f0156,_0x2c8471){const _0x50a015=a8_0x4e29,_0x181d11=_0x5f0156();while(!![]){try{const _0x451e12=-parseInt(_0x50a015(0x123))/0x1+-parseInt(_0x50a015(0xf7))/0x2*(-parseInt(_0x50a015(0x13b))/0x3)+parseInt(_0x50a015(0x10d))/0x4*(-parseInt(_0x50a015(0xec))/0x5)+parseInt(_0x50a015(0xfb))/0x6+-parseInt(_0x50a015(0x127))/0x7+-parseInt(_0x50a015(0x109))/0x8*(parseInt(_0x50a015(0xf4))/0x9)+parseInt(_0x50a015(0x10b))/0xa;if(_0x451e12===_0x2c8471)break;else _0x181d11['push'](_0x181d11['shift']());}catch(_0x20c3e6){_0x181d11['push'](_0x181d11['shift']());}}}(a8_0x1167,0xf06f1));var __createBinding=this&&this['__createBinding']||(Object[a8_0x4f2b99(0x11e)]?function(_0x3f23b6,_0x5b263c,_0x26708f,_0x24314b){const _0x375d1b=a8_0x4f2b99;if(_0x24314b===undefined)_0x24314b=_0x26708f;var _0x21656e=Object[_0x375d1b(0x10e)](_0x5b263c,_0x26708f);(!_0x21656e||(_0x375d1b(0x10f)in _0x21656e?!_0x5b263c['__esModule']:_0x21656e[_0x375d1b(0x145)]||_0x21656e[_0x375d1b(0xdf)]))&&(_0x21656e={'enumerable':!![],'get':function(){return _0x5b263c[_0x26708f];}}),Object['defineProperty'](_0x3f23b6,_0x24314b,_0x21656e);}:function(_0x13b936,_0x17cbf6,_0x4f5184,_0x54b4da){if(_0x54b4da===undefined)_0x54b4da=_0x4f5184;_0x13b936[_0x54b4da]=_0x17cbf6[_0x4f5184];}),__setModuleDefault=this&&this[a8_0x4f2b99(0x139)]||(Object['create']?function(_0x4bec0c,_0x195672){const _0x4d05bb=a8_0x4f2b99;Object[_0x4d05bb(0x135)](_0x4bec0c,_0x4d05bb(0x131),{'enumerable':!![],'value':_0x195672});}:function(_0x4c3673,_0x43fb41){const _0x10cc69=a8_0x4f2b99;_0x4c3673[_0x10cc69(0x131)]=_0x43fb41;}),__importStar=this&&this['__importStar']||(function(){var _0xdfe0f0=function(_0x402722){const _0x2b1c7d=a8_0x4e29;return _0xdfe0f0=Object[_0x2b1c7d(0x128)]||function(_0x117cee){const _0x54d4fb=_0x2b1c7d;var _0x428b10=[];for(var _0x442594 in _0x117cee)if(Object[_0x54d4fb(0x106)][_0x54d4fb(0xfd)][_0x54d4fb(0xe0)](_0x117cee,_0x442594))_0x428b10[_0x428b10[_0x54d4fb(0xf1)]]=_0x442594;return _0x428b10;},_0xdfe0f0(_0x402722);};return function(_0x1518a3){const _0x2c21e3=a8_0x4e29;if(_0x1518a3&&_0x1518a3[_0x2c21e3(0x153)])return _0x1518a3;var _0x4a9b2e={};if(_0x1518a3!=null){for(var _0x20d192=_0xdfe0f0(_0x1518a3),_0x26fcdf=0x0;_0x26fcdf<_0x20d192[_0x2c21e3(0xf1)];_0x26fcdf++)if(_0x20d192[_0x26fcdf]!=='default')__createBinding(_0x4a9b2e,_0x1518a3,_0x20d192[_0x26fcdf]);}return __setModuleDefault(_0x4a9b2e,_0x1518a3),_0x4a9b2e;};}()),__importDefault=this&&this[a8_0x4f2b99(0x124)]||function(_0x584709){return _0x584709&&_0x584709['__esModule']?_0x584709:{'default':_0x584709};};function a8_0x1167(){const _0x26f53b=['2668610PclTcA','getOwnPropertyNames','Customer\x20data\x20updated\x20successfully','orderId','handleSuccessfulPayment','&payment_id=','payment','toUpperCase','paymentService','../config/database','default','VisaMasterCardService','resolve','gatewayOrderId','defineProperty','1111','3DS\x20verification\x20required','then','__setModuleDefault','amount','772602nIQCBI','failUrl','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','https://api.trapay.uk/api/webhooks/gateway/','customerCountry','üìù\x20Customer\x20data:','visa/mastercard','Payment\x20not\x20found','paymentMethod','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','writable','processMasterCardPayment','../services/gateways/mastercardService','sendShopWebhook','getPaymentById','requires_3ds','PENDING','settings','last_name','toLowerCase','https://app.trapay.uk/payment/pending?id=','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','\x20payment:','FAILED','__esModule','webhookUrl','now','Error\x20parsing\x20webhook\x20events:','customerName','sendPaymentStatusNotification','shop','slice','stringify','status','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','gateway_payment_id','parse','isArray','first_name','getPaymentStatus','Payment\x20created\x20successfully','\x20not\x20enabled\x20for\x20shop\x20','customerIp','POST','\x20\x20\x20Result\x20URL\x20(webhook):\x20','configurable','call','ms)','updatePaymentCustomer','includes','sendPaymentNotification','\x20URLs:','startsWith','gateway','currency','final','webhookLog','error','30ixPgdB','webhookService','../services/telegramBotService','findUnique','üí≥\x20Processing\x20MasterCard\x20payment:\x20','length','createPublicPayment','VISA/MasterCard','11547sEJgaU','params','user_agent','8rgWNRp','failed','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','webhookEvents','6199842ecyexj','cardLast4','hasOwnProperty','gatewayPaymentId','email','update','json','number','body','mastercard','\x20payment\x20','prototype','shopId','visa','8584VAaaAb','customerUa','24847090TVKodq','\x20with\x20status\x20','304004xxYIgU','getOwnPropertyDescriptor','get','visaMasterCardService','PaymentService','Card\x20payment\x20failed','application/json','TesSoft\x20Payment\x20System/1.0\x20(','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','log','PAID','../services/paymentLinkService','üí≥\x20Card\x20holder:\x20','../services/webhookService','PaymentController','\x20webhook\x20sent\x20to\x20','customerEmail','create','üìà\x20','updatedAt',',\x20cannot\x20process','Payment\x20processed\x20successfully','1349440UyHNAV','__importDefault','replace','threeds_url'];a8_0x1167=function(){return _0x26f53b;};return a8_0x1167();}function a8_0x4e29(_0x55968b,_0xf46841){const _0x116704=a8_0x1167();return a8_0x4e29=function(_0x4e297c,_0x366973){_0x4e297c=_0x4e297c-0xd0;let _0x18ca5e=_0x116704[_0x4e297c];return _0x18ca5e;},a8_0x4e29(_0x55968b,_0xf46841);}Object[a8_0x4f2b99(0x135)](exports,a8_0x4f2b99(0x153),{'value':!![]}),exports[a8_0x4f2b99(0x11b)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x4f2b99(0x147)),webhookService_1=require(a8_0x4f2b99(0x11a)),database_1=__importDefault(require(a8_0x4f2b99(0x130)));class PaymentController{constructor(){const _0x3a5c4a=a8_0x4f2b99;this[_0x3a5c4a(0xf2)]=async(_0x239a8a,_0x4e95e1,_0x2b219e)=>{const _0xceefbd=_0x3a5c4a;try{const _0x4f369f=_0x239a8a['body'],_0xee84e2=await this[_0xceefbd(0x12f)][_0xceefbd(0xf2)](_0x4f369f);_0x4e95e1[_0xceefbd(0xd3)](0xc9)[_0xceefbd(0x101)]({'success':!![],'message':_0xceefbd(0xda),'result':_0xee84e2});}catch(_0x2ca1a5){_0x2b219e(_0x2ca1a5);}},this[_0x3a5c4a(0xd9)]=async(_0x3de3cb,_0x1a3c01,_0x262b54)=>{const _0x11ba1f=_0x3a5c4a;try{const {id:_0x2c5d31}=_0x3de3cb[_0x11ba1f(0xf5)],_0x4895ee=await this[_0x11ba1f(0x12f)][_0x11ba1f(0xd9)](_0x2c5d31);if(!_0x4895ee)return _0x1a3c01[_0x11ba1f(0xd3)](0x194)[_0x11ba1f(0x101)]({'success':![],'message':_0x11ba1f(0x142)});_0x1a3c01['json']({'success':!![],'result':_0x4895ee});}catch(_0x4979a6){_0x262b54(_0x4979a6);}},this[_0x3a5c4a(0x149)]=async(_0x5ed287,_0x4f90c7,_0x382c20)=>{const _0x11063a=_0x3a5c4a;try{const {id:_0x590d18}=_0x5ed287['params'],_0x50c558=await this['paymentService']['getPaymentById'](_0x590d18);if(!_0x50c558)return _0x4f90c7[_0x11063a(0xd3)](0x194)[_0x11063a(0x101)]({'success':![],'message':'Payment\x20not\x20found'});_0x4f90c7[_0x11063a(0x101)]({'success':!![],'result':_0x50c558});}catch(_0x3b879a){_0x382c20(_0x3b879a);}},this[_0x3a5c4a(0xe2)]=async(_0x2f48cc,_0x49b901,_0x3acc90)=>{const _0x349395=_0x3a5c4a;try{const {id:_0x4aa36b}=_0x2f48cc[_0x349395(0xf5)],_0x4681db=_0x2f48cc[_0x349395(0x103)];console['log']('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x4aa36b),console['log'](_0x349395(0x140),_0x4681db);const _0x105666=await this[_0x349395(0x12f)]['updatePaymentCustomerDataPublic'](_0x4aa36b,_0x4681db);if(!_0x105666)return _0x49b901[_0x349395(0xd3)](0x194)[_0x349395(0x101)]({'success':![],'message':_0x349395(0x142)});_0x49b901[_0x349395(0x101)]({'success':!![],'message':_0x349395(0x129),'result':{'paymentId':_0x105666['id'],'customerIp':_0x105666[_0x349395(0xdc)],'customerUa':_0x105666[_0x349395(0x10a)],'customerCountry':_0x105666[_0x349395(0x13f)],'updatedAt':_0x105666[_0x349395(0x120)]}});}catch(_0x2e094a){_0x3acc90(_0x2e094a);}},this[_0x3a5c4a(0x146)]=async(_0x349fdb,_0x1951c3,_0x40b845)=>{const _0x384410=_0x3a5c4a;try{const {id:_0x34ea2c}=_0x349fdb[_0x384410(0xf5)],{cardData:_0x518569,cardHolder:_0x431ac1,browser:_0x3828b5}=_0x349fdb[_0x384410(0x103)];console[_0x384410(0x116)](_0x384410(0xf0)+_0x34ea2c),console['log'](_0x384410(0x119)+_0x431ac1[_0x384410(0xd8)]+'\x20'+_0x431ac1[_0x384410(0x14d)]+'\x20('+_0x431ac1['email']+')'),console[_0x384410(0x116)]('üí≥\x20Browser\x20IP:\x20'+_0x3828b5['ip']);const _0xb8fb15={'customerName':_0x431ac1['first_name']+'\x20'+_0x431ac1[_0x384410(0x14d)],'customerEmail':_0x431ac1[_0x384410(0xff)],'customerIp':_0x3828b5['ip'],'customerUa':_0x3828b5[_0x384410(0xf6)]},_0x56217e=await database_1[_0x384410(0x131)][_0x384410(0x12d)][_0x384410(0xef)]({'where':{'id':_0x34ea2c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x56217e)return _0x1951c3[_0x384410(0xd3)](0x194)[_0x384410(0x101)]({'success':![],'message':_0x384410(0x142)});if(_0x56217e[_0x384410(0xe7)]!==_0x384410(0x141))return console[_0x384410(0x116)]('‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27'+_0x56217e[_0x384410(0xe7)]+'\x27'),_0x1951c3[_0x384410(0xd3)](0x190)[_0x384410(0x101)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway'});if(_0x56217e[_0x384410(0xd3)]!=='PENDING')return _0x1951c3[_0x384410(0xd3)](0x190)[_0x384410(0x101)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x56217e[_0x384410(0xd3)]+_0x384410(0x121)});await database_1['default']['payment'][_0x384410(0x100)]({'where':{'id':_0x34ea2c},'data':{..._0xb8fb15,'updatedAt':new Date()}});const _0x11ffae=_0x518569[_0x384410(0x102)]['replace'](/[\s-]/g,''),_0x5a0c51=_0x11ffae[_0x384410(0xe6)]('4')?_0x384410(0x108):_0x384410(0x104),_0x4ac71f=_0x384410(0x13e)+_0x5a0c51,_0xd0c5f0=_0x384410(0x14f)+_0x56217e['id']+_0x384410(0x12c)+_0x56217e[_0x384410(0x134)];console[_0x384410(0x116)]('üí≥\x20'+_0x5a0c51['toUpperCase']()+_0x384410(0xe5)),console['log'](_0x384410(0xde)+_0x4ac71f),console[_0x384410(0x116)]('\x20\x20\x20Return\x20URL:\x20'+_0xd0c5f0);const _0x11bafb={'first_name':_0x431ac1[_0x384410(0xd8)],'last_name':_0x431ac1[_0x384410(0x14d)],'email':_0x431ac1[_0x384410(0xff)]},_0x4c2471=await this['visaMasterCardService']['processCardPayment']({'paymentId':_0x56217e['id'],'orderId':_0x56217e[_0x384410(0x134)]||_0x56217e['id'],'amount':_0x56217e[_0x384410(0x13a)],'currency':_0x56217e['currency'],'cardData':_0x518569,'resultUrl':_0x4ac71f,'returnUrl':_0xd0c5f0,'cardHolder':_0x11bafb,'browser':_0x3828b5});console[_0x384410(0x116)]('üí≥\x20MasterCard\x20result:',_0x4c2471);const _0xb57446={'status':_0x4c2471[_0x384410(0xd3)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4c2471[_0x384410(0xd5)]&&(_0xb57446[_0x384410(0xfe)]=_0x4c2471[_0x384410(0xd5)],console[_0x384410(0x116)](_0x384410(0xf9)+_0x4c2471[_0x384410(0xd5)]));if(_0x4c2471[_0x384410(0xd3)]===_0x384410(0x117))_0xb57446['paidAt']=new Date();else _0x4c2471[_0x384410(0xd3)]===_0x384410(0x152)&&(_0xb57446['failureMessage']=_0x384410(0x112));_0xb57446[_0x384410(0x143)]=_0x384410(0x104);if(_0x518569[_0x384410(0x102)]){const _0xb4d33b=_0x518569[_0x384410(0x102)][_0x384410(0x125)](/[\s-]/g,'');_0xb57446[_0x384410(0xfc)]=_0xb4d33b[_0x384410(0xd1)](-0x4),console[_0x384410(0x116)](_0x384410(0x150)+_0xb57446['cardLast4']);}await database_1['default'][_0x384410(0x12d)][_0x384410(0x100)]({'where':{'id':_0x56217e['id']},'data':_0xb57446}),await database_1[_0x384410(0x131)][_0x384410(0xea)]['create']({'data':{'paymentId':_0x56217e['id'],'shopId':_0x56217e['shopId'],'event':_0x5a0c51+'_'+_0x4c2471['status']?.[_0x384410(0x14e)](),'statusCode':0xc8,'responseBody':JSON[_0x384410(0xd2)]({'oldStatus':_0x384410(0x14b),'newStatus':_0x4c2471[_0x384410(0xd3)],'gatewayPaymentId':_0x4c2471['gateway_payment_id'],'requires3ds':_0x4c2471[_0x384410(0x14a)],'cardType':_0x5a0c51[_0x384410(0x12e)](),'processedAt':new Date()['toISOString']()})}});if(_0x4c2471[_0x384410(0xe9)]){await this[_0x384410(0x148)](_0x56217e,_0x4c2471[_0x384410(0xd3)],_0x4c2471[_0x384410(0xd5)],_0x5a0c51),await this[_0x384410(0x158)](_0x56217e,_0x4c2471[_0x384410(0xd3)]);if(_0x4c2471['status']===_0x384410(0x117)){console['log'](_0x384410(0x11f)+_0x5a0c51[_0x384410(0x12e)]()+_0x384410(0x105)+_0x34ea2c+_0x384410(0x13d));try{const {PaymentLinkService:_0x43c20e}=await Promise[_0x384410(0x133)]()[_0x384410(0x138)](()=>__importStar(require(_0x384410(0x118)))),_0x3adfe2=new _0x43c20e();await _0x3adfe2[_0x384410(0x12b)](_0x34ea2c),console[_0x384410(0x116)](_0x384410(0x115)+_0x5a0c51[_0x384410(0x12e)]()+_0x384410(0x105)+_0x34ea2c);}catch(_0x59bb9e){console[_0x384410(0xeb)](_0x384410(0xd4)+_0x5a0c51[_0x384410(0x12e)]()+_0x384410(0x151),_0x59bb9e);}}}console['log']('‚úÖ\x20'+_0x5a0c51['toUpperCase']()+_0x384410(0x105)+_0x34ea2c+'\x20processed:\x20'+_0x4c2471['status']);if(_0x4c2471['status']===_0x384410(0x117))_0x1951c3['json']({'success':!![],'message':_0x384410(0x122),'result':{'status':'PAID','gatewayPaymentId':_0x4c2471[_0x384410(0xd5)],'redirectUrl':_0xd0c5f0,'final':!![]}});else _0x4c2471[_0x384410(0x14a)]&&_0x4c2471[_0x384410(0x126)]?_0x1951c3[_0x384410(0x101)]({'success':!![],'message':_0x384410(0x137),'result':{'status':'PENDING','gatewayPaymentId':_0x4c2471[_0x384410(0xd5)],'redirectUrl':_0x4c2471['threeds_url'],'requires3ds':!![],'final':![]}}):_0x1951c3[_0x384410(0xd3)](0x190)[_0x384410(0x101)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x384410(0x152),'gatewayPaymentId':_0x4c2471[_0x384410(0xd5)],'redirectUrl':_0x56217e[_0x384410(0x13c)],'final':!![]}});}catch(_0x4a2f8f){_0x40b845(_0x4a2f8f);}},this['paymentService']=new paymentService_1[(_0x3a5c4a(0x111))](),this[_0x3a5c4a(0x110)]=new mastercardService_1[(_0x3a5c4a(0x132))](),this[_0x3a5c4a(0xed)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x2d9414,_0x10224b,_0x3e752a,_0x549e3e){const _0x17a7ff=a8_0x4f2b99,_0xbbc524=Date[_0x17a7ff(0x155)]();try{const _0xd7dc39=_0x2d9414[_0x17a7ff(0xd0)],_0x3536ae=_0xd7dc39[_0x17a7ff(0x14c)];if(!_0x3536ae?.[_0x17a7ff(0x154)]){console[_0x17a7ff(0x116)](_0x17a7ff(0x144)+_0xd7dc39['id']);return;}const _0x2ecd55=_0x10224b===_0x17a7ff(0x117)?'payment.success':'payment.failed';let _0x235c1=[];if(_0x3536ae[_0x17a7ff(0xfa)])try{_0x235c1=Array[_0x17a7ff(0xd7)](_0x3536ae[_0x17a7ff(0xfa)])?_0x3536ae[_0x17a7ff(0xfa)]:JSON[_0x17a7ff(0xd6)](_0x3536ae[_0x17a7ff(0xfa)]);}catch(_0x395e9b){console[_0x17a7ff(0xeb)](_0x17a7ff(0x156),_0x395e9b),_0x235c1=[];}if(!_0x235c1[_0x17a7ff(0xe3)](_0x2ecd55)){console['log']('Webhook\x20event\x20'+_0x2ecd55+_0x17a7ff(0xdb)+_0xd7dc39['id']);return;}const _0x5b4bf8={'event':_0x2ecd55,'payment':{'id':_0x2d9414['id'],'order_id':_0x2d9414[_0x17a7ff(0x12a)],'gateway_order_id':_0x2d9414[_0x17a7ff(0x134)],'gateway':_0x17a7ff(0x136),'card_type':_0x549e3e?.[_0x17a7ff(0x12e)]()||'UNKNOWN','amount':_0x2d9414[_0x17a7ff(0x13a)],'currency':_0x2d9414[_0x17a7ff(0xe8)],'status':_0x10224b['toLowerCase'](),'customer_email':_0x2d9414[_0x17a7ff(0x11d)],'customer_name':_0x2d9414[_0x17a7ff(0x157)],'gateway_payment_id':_0x3e752a,'created_at':_0x2d9414['createdAt'],'updated_at':new Date()}},_0xdaed6c=await fetch(_0x3536ae['webhookUrl'],{'method':_0x17a7ff(0xdd),'headers':{'Content-Type':_0x17a7ff(0x113),'User-Agent':_0x17a7ff(0x114)+(_0x549e3e?.[_0x17a7ff(0x12e)]()||'VISA/MasterCard')+')'},'body':JSON['stringify'](_0x5b4bf8)}),_0x56128c=Date[_0x17a7ff(0x155)]()-_0xbbc524;console[_0x17a7ff(0x116)]((_0x549e3e?.[_0x17a7ff(0x12e)]()||_0x17a7ff(0xf3))+_0x17a7ff(0x11c)+_0x3536ae[_0x17a7ff(0x154)]+_0x17a7ff(0x10c)+_0xdaed6c[_0x17a7ff(0xd3)]+'\x20('+_0x56128c+_0x17a7ff(0xe1));}catch(_0x158988){console[_0x17a7ff(0xeb)]('Failed\x20to\x20send\x20'+(_0x549e3e?.[_0x17a7ff(0x12e)]()||'VISA/MasterCard')+'\x20webhook:',_0x158988);}}async[a8_0x4f2b99(0x158)](_0x423811,_0x2b4267){const _0x34a0c6=a8_0x4f2b99;try{const {telegramBotService:_0x1f5b2a}=await Promise[_0x34a0c6(0x133)]()['then'](()=>__importStar(require(_0x34a0c6(0xee)))),_0x5cad96={'PAID':'paid','FAILED':_0x34a0c6(0xf8)},_0x3b62d0=_0x5cad96[_0x2b4267];if(!_0x3b62d0)return;await _0x1f5b2a[_0x34a0c6(0xe4)](_0x423811[_0x34a0c6(0x107)],_0x423811,_0x3b62d0);}catch(_0x39c36f){console[_0x34a0c6(0xeb)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x39c36f);}}}exports[a8_0x4f2b99(0x11b)]=PaymentController;