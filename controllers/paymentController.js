'use strict';const a8_0x324015=a8_0x43b5;function a8_0x260b(){const _0x1dd367=['webhookService','üí≥\x20MasterCard\x20result:','mastercard_','payment.success','updatePaymentCustomer','gatewayOrderId','webhookUrl','create','status','paymentService','PaymentService','FAILED','includes','\x20with\x20status\x20','üí≥\x20MasterCard\x20URLs:','Error\x20parsing\x20webhook\x20events:','successUrl','masterCardService','PENDING','Customer\x20data\x20updated\x20successfully','threeds_url','now','findUnique','paymentMethod','payment.failed','getOwnPropertyNames','writable','‚úÖ\x20MasterCard\x20payment\x20','amount','failed','Card\x20payment\x20failed','get','hasOwnProperty','../config/database','prototype','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','608839DuiMug','PaymentController','üìù\x20Customer\x20data:','üí≥\x20Processing\x20MasterCard\x20payment:\x20','updatedAt','customerIp','orderId','application/json','customerEmail','1111','Payment\x20not\x20found','mastercard','createPublicPayment','POST','requires_3ds','toISOString','update','551020IZOHig','params','WebhookService','../services/gateways/mastercardService','customerUa','Failed\x20to\x20send\x20MasterCard\x20webhook:','8944CtPLPO','Payment\x20processed\x20successfully','resolve','../services/paymentService','then','8076ivWeBJ','defineProperty','createdAt','Webhook\x20event\x20','log',',\x20cannot\x20process','11ftyzTl','__esModule','2351340VVPUOn','Payment\x20created\x20successfully','getPaymentById','__createBinding','payment','3177VvoJlr','6356740xqJbLw','26Srtxxe','\x20not\x20enabled\x20for\x20shop\x20','__importStar','system','toLowerCase','sendShopWebhook','gateway_payment_id','settings','paid','gateway','../services/webhookService','customerCountry','json','shopId','configurable','updatePaymentCustomerDataPublic','webhookEvents','228hUQnxn','error','27104fAmnjZ','PAID','default','https://api.trapay.uk/api/webhooks/gateway/mastercard','MasterCardService','stringify','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','currency','__setModuleDefault'];a8_0x260b=function(){return _0x1dd367;};return a8_0x260b();}(function(_0x3f0ae3,_0x131c8b){const _0x310c47=a8_0x43b5,_0x134681=_0x3f0ae3();while(!![]){try{const _0x4202cd=parseInt(_0x310c47(0xad))/0x1*(parseInt(_0x310c47(0x9a))/0x2)+parseInt(_0x310c47(0xab))/0x3*(-parseInt(_0x310c47(0xf7))/0x4)+parseInt(_0x310c47(0xec))/0x5+parseInt(_0x310c47(0x93))/0x6+-parseInt(_0x310c47(0xdb))/0x7+parseInt(_0x310c47(0xf2))/0x8*(parseInt(_0x310c47(0x98))/0x9)+parseInt(_0x310c47(0x99))/0xa*(-parseInt(_0x310c47(0x91))/0xb);if(_0x4202cd===_0x131c8b)break;else _0x134681['push'](_0x134681['shift']());}catch(_0x4ba23a){_0x134681['push'](_0x134681['shift']());}}}(a8_0x260b,0x5b10d));var __createBinding=this&&this[a8_0x324015(0x96)]||(Object[a8_0x324015(0xbd)]?function(_0xd53720,_0x4b4b2c,_0x1be12c,_0x2f14c5){const _0x2399de=a8_0x324015;if(_0x2f14c5===undefined)_0x2f14c5=_0x1be12c;var _0x16f26e=Object['getOwnPropertyDescriptor'](_0x4b4b2c,_0x1be12c);(!_0x16f26e||(_0x2399de(0xd5)in _0x16f26e?!_0x4b4b2c[_0x2399de(0x92)]:_0x16f26e[_0x2399de(0xd0)]||_0x16f26e[_0x2399de(0xa8)]))&&(_0x16f26e={'enumerable':!![],'get':function(){return _0x4b4b2c[_0x1be12c];}}),Object['defineProperty'](_0xd53720,_0x2f14c5,_0x16f26e);}:function(_0x52d113,_0x5324d7,_0x3d04c0,_0xa994bc){if(_0xa994bc===undefined)_0xa994bc=_0x3d04c0;_0x52d113[_0xa994bc]=_0x5324d7[_0x3d04c0];}),__setModuleDefault=this&&this[a8_0x324015(0xb5)]||(Object[a8_0x324015(0xbd)]?function(_0x39b636,_0xd71e9f){const _0x801ae5=a8_0x324015;Object[_0x801ae5(0x8c)](_0x39b636,_0x801ae5(0xaf),{'enumerable':!![],'value':_0xd71e9f});}:function(_0x4fbfec,_0x500367){_0x4fbfec['default']=_0x500367;}),__importStar=this&&this[a8_0x324015(0x9c)]||(function(){var _0xa5b0ff=function(_0xd5031e){const _0x4baaba=a8_0x43b5;return _0xa5b0ff=Object[_0x4baaba(0xcf)]||function(_0x2bec65){const _0x508e8a=_0x4baaba;var _0x294569=[];for(var _0x2a46d5 in _0x2bec65)if(Object[_0x508e8a(0xd8)][_0x508e8a(0xd6)]['call'](_0x2bec65,_0x2a46d5))_0x294569[_0x294569['length']]=_0x2a46d5;return _0x294569;},_0xa5b0ff(_0xd5031e);};return function(_0x12b527){const _0x248090=a8_0x43b5;if(_0x12b527&&_0x12b527[_0x248090(0x92)])return _0x12b527;var _0x24ea52={};if(_0x12b527!=null){for(var _0x2eb9a7=_0xa5b0ff(_0x12b527),_0x285254=0x0;_0x285254<_0x2eb9a7['length'];_0x285254++)if(_0x2eb9a7[_0x285254]!==_0x248090(0xaf))__createBinding(_0x24ea52,_0x12b527,_0x2eb9a7[_0x285254]);}return __setModuleDefault(_0x24ea52,_0x12b527),_0x24ea52;};}()),__importDefault=this&&this['__importDefault']||function(_0x422ca5){const _0x1a822c=a8_0x324015;return _0x422ca5&&_0x422ca5[_0x1a822c(0x92)]?_0x422ca5:{'default':_0x422ca5};};Object[a8_0x324015(0x8c)](exports,a8_0x324015(0x92),{'value':!![]}),exports[a8_0x324015(0xdc)]=void 0x0;const paymentService_1=require(a8_0x324015(0xf5)),mastercardService_1=require(a8_0x324015(0xef)),webhookService_1=require(a8_0x324015(0xa4)),database_1=__importDefault(require(a8_0x324015(0xd7)));class PaymentController{constructor(){const _0x162dee=a8_0x324015;this[_0x162dee(0xe7)]=async(_0x294b3c,_0x495ad4,_0x333751)=>{const _0x35bad7=_0x162dee;try{const _0x4da40e=_0x294b3c['body'],_0x104d46=await this['paymentService']['createPublicPayment'](_0x4da40e);_0x495ad4[_0x35bad7(0xbe)](0xc9)[_0x35bad7(0xa6)]({'success':!![],'message':_0x35bad7(0x94),'result':_0x104d46});}catch(_0x106979){_0x333751(_0x106979);}},this['getPaymentStatus']=async(_0x2bf117,_0x2b64e4,_0x4a7714)=>{const _0x3ebd21=_0x162dee;try{const {id:_0x23c6d7}=_0x2bf117['params'],_0x2b8d84=await this[_0x3ebd21(0xbf)]['getPaymentStatus'](_0x23c6d7);if(!_0x2b8d84)return _0x2b64e4[_0x3ebd21(0xbe)](0x194)[_0x3ebd21(0xa6)]({'success':![],'message':'Payment\x20not\x20found'});_0x2b64e4[_0x3ebd21(0xa6)]({'success':!![],'result':_0x2b8d84});}catch(_0x460dca){_0x4a7714(_0x460dca);}},this[_0x162dee(0x95)]=async(_0x4834de,_0x1197db,_0x48cebf)=>{const _0x434785=_0x162dee;try{const {id:_0x2e8290}=_0x4834de[_0x434785(0xed)],_0x9c2c39=await this['paymentService']['getPaymentById'](_0x2e8290);if(!_0x9c2c39)return _0x1197db[_0x434785(0xbe)](0x194)['json']({'success':![],'message':_0x434785(0xe5)});_0x1197db[_0x434785(0xa6)]({'success':!![],'result':_0x9c2c39});}catch(_0x1ce5fe){_0x48cebf(_0x1ce5fe);}},this[_0x162dee(0xba)]=async(_0x4a6986,_0x5643ab,_0x41b70b)=>{const _0x35c929=_0x162dee;try{const {id:_0x9252f8}=_0x4a6986[_0x35c929(0xed)],_0x122cb3=_0x4a6986['body'];console[_0x35c929(0x8f)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x9252f8),console['log'](_0x35c929(0xdd),_0x122cb3);const _0x19cdfd=await this[_0x35c929(0xbf)][_0x35c929(0xa9)](_0x9252f8,_0x122cb3);if(!_0x19cdfd)return _0x5643ab[_0x35c929(0xbe)](0x194)['json']({'success':![],'message':_0x35c929(0xe5)});_0x5643ab[_0x35c929(0xa6)]({'success':!![],'message':_0x35c929(0xc9),'result':{'paymentId':_0x19cdfd['id'],'customerIp':_0x19cdfd[_0x35c929(0xe0)],'customerUa':_0x19cdfd[_0x35c929(0xf0)],'customerCountry':_0x19cdfd[_0x35c929(0xa5)],'updatedAt':_0x19cdfd[_0x35c929(0xdf)]}});}catch(_0x301c75){_0x41b70b(_0x301c75);}},this['processMasterCardPayment']=async(_0xf3d147,_0x1c97f0,_0x23ec27)=>{const _0x5eb59a=_0x162dee;try{const {id:_0x3b15b2}=_0xf3d147['params'],{cardData:_0x3b0942,cardHolder:_0x47c0d8,browser:_0x5a2d81}=_0xf3d147['body'];console[_0x5eb59a(0x8f)](_0x5eb59a(0xde)+_0x3b15b2);const _0x264c03=await database_1[_0x5eb59a(0xaf)]['payment'][_0x5eb59a(0xcc)]({'where':{'id':_0x3b15b2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x264c03)return _0x1c97f0[_0x5eb59a(0xbe)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x264c03[_0x5eb59a(0xa3)]!==_0x5eb59a(0xe6))return _0x1c97f0[_0x5eb59a(0xbe)](0x190)[_0x5eb59a(0xa6)]({'success':![],'message':_0x5eb59a(0xb3)});if(_0x264c03[_0x5eb59a(0xbe)]!==_0x5eb59a(0xc8))return _0x1c97f0[_0x5eb59a(0xbe)](0x190)[_0x5eb59a(0xa6)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x264c03[_0x5eb59a(0xbe)]+_0x5eb59a(0x90)});const _0x25d389=_0x5eb59a(0xb0),_0x2abd6c=_0x264c03[_0x5eb59a(0xc6)];console[_0x5eb59a(0x8f)](_0x5eb59a(0xc4)),console[_0x5eb59a(0x8f)](_0x5eb59a(0xda)+_0x25d389),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x2abd6c);const _0x31396e=await this['masterCardService']['processCardPayment']({'paymentId':_0x264c03['id'],'orderId':_0x264c03[_0x5eb59a(0xbb)]||_0x264c03['id'],'amount':_0x264c03[_0x5eb59a(0xd2)],'currency':_0x264c03['currency'],'cardData':_0x3b0942,'resultUrl':_0x25d389,'returnUrl':_0x2abd6c,'cardHolder':_0x47c0d8,'browser':_0x5a2d81});console[_0x5eb59a(0x8f)](_0x5eb59a(0xb7),_0x31396e);const _0xe0d71f={'status':_0x31396e['status'],'updatedAt':new Date(),'statusChangedBy':_0x5eb59a(0x9d),'statusChangedAt':new Date()};if(_0x31396e['status']==='PAID')_0xe0d71f['paidAt']=new Date(),_0xe0d71f['gatewayPaymentId']=_0x31396e[_0x5eb59a(0xa0)];else _0x31396e['status']===_0x5eb59a(0xc1)&&(_0xe0d71f['failureMessage']=_0x5eb59a(0xd4));_0xe0d71f[_0x5eb59a(0xcd)]='mastercard',await database_1['default'][_0x5eb59a(0x97)][_0x5eb59a(0xeb)]({'where':{'id':_0x264c03['id']},'data':_0xe0d71f}),await database_1[_0x5eb59a(0xaf)]['webhookLog'][_0x5eb59a(0xbd)]({'data':{'paymentId':_0x264c03['id'],'shopId':_0x264c03['shopId'],'event':_0x5eb59a(0xb8)+_0x31396e['status']?.[_0x5eb59a(0x9e)](),'statusCode':0xc8,'responseBody':JSON[_0x5eb59a(0xb2)]({'oldStatus':_0x5eb59a(0xc8),'newStatus':_0x31396e[_0x5eb59a(0xbe)],'gatewayPaymentId':_0x31396e[_0x5eb59a(0xa0)],'requires3ds':_0x31396e[_0x5eb59a(0xe9)],'processedAt':new Date()[_0x5eb59a(0xea)]()})}});_0x31396e['final']&&(await this[_0x5eb59a(0x9f)](_0x264c03,_0x31396e[_0x5eb59a(0xbe)],_0x31396e[_0x5eb59a(0xa0)]),await this['sendPaymentStatusNotification'](_0x264c03,_0x31396e[_0x5eb59a(0xbe)]));console[_0x5eb59a(0x8f)](_0x5eb59a(0xd1)+_0x3b15b2+'\x20processed:\x20'+_0x31396e[_0x5eb59a(0xbe)]);if(_0x31396e[_0x5eb59a(0xbe)]==='PAID')_0x1c97f0[_0x5eb59a(0xa6)]({'success':!![],'message':_0x5eb59a(0xf3),'result':{'status':_0x5eb59a(0xae),'gatewayPaymentId':_0x31396e['gateway_payment_id'],'redirectUrl':_0x2abd6c,'final':!![]}});else _0x31396e[_0x5eb59a(0xe9)]&&_0x31396e[_0x5eb59a(0xca)]?_0x1c97f0[_0x5eb59a(0xa6)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x5eb59a(0xc8),'gatewayPaymentId':_0x31396e['gateway_payment_id'],'redirectUrl':_0x31396e['threeds_url'],'requires3ds':!![],'final':![]}}):_0x1c97f0[_0x5eb59a(0xbe)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x31396e[_0x5eb59a(0xa0)],'redirectUrl':_0x264c03['failUrl'],'final':!![]}});}catch(_0x3a8193){_0x23ec27(_0x3a8193);}},this[_0x162dee(0xbf)]=new paymentService_1[(_0x162dee(0xc0))](),this[_0x162dee(0xc7)]=new mastercardService_1[(_0x162dee(0xb1))](),this[_0x162dee(0xb6)]=new webhookService_1[(_0x162dee(0xee))]();}async[a8_0x324015(0x9f)](_0x44f653,_0xed41a0,_0x3e49ed){const _0x5ac722=a8_0x324015,_0x1a3ef2=Date['now']();try{const _0x409352=_0x44f653['shop'],_0x1dccae=_0x409352[_0x5ac722(0xa1)];if(!_0x1dccae?.[_0x5ac722(0xbc)]){console[_0x5ac722(0x8f)](_0x5ac722(0xd9)+_0x409352['id']);return;}const _0x17317c=_0xed41a0===_0x5ac722(0xae)?_0x5ac722(0xb9):_0x5ac722(0xce);let _0x48e36b=[];if(_0x1dccae[_0x5ac722(0xaa)])try{_0x48e36b=Array['isArray'](_0x1dccae[_0x5ac722(0xaa)])?_0x1dccae['webhookEvents']:JSON['parse'](_0x1dccae[_0x5ac722(0xaa)]);}catch(_0x111b83){console[_0x5ac722(0xac)](_0x5ac722(0xc5),_0x111b83),_0x48e36b=[];}if(!_0x48e36b[_0x5ac722(0xc2)](_0x17317c)){console[_0x5ac722(0x8f)](_0x5ac722(0x8e)+_0x17317c+_0x5ac722(0x9b)+_0x409352['id']);return;}const _0x5d1abd={'event':_0x17317c,'payment':{'id':_0x44f653['id'],'order_id':_0x44f653[_0x5ac722(0xe1)],'gateway_order_id':_0x44f653[_0x5ac722(0xbb)],'gateway':_0x5ac722(0xe4),'amount':_0x44f653[_0x5ac722(0xd2)],'currency':_0x44f653[_0x5ac722(0xb4)],'status':_0xed41a0[_0x5ac722(0x9e)](),'customer_email':_0x44f653[_0x5ac722(0xe3)],'customer_name':_0x44f653['customerName'],'gateway_payment_id':_0x3e49ed,'created_at':_0x44f653[_0x5ac722(0x8d)],'updated_at':new Date()}},_0x44ad08=await fetch(_0x1dccae[_0x5ac722(0xbc)],{'method':_0x5ac722(0xe8),'headers':{'Content-Type':_0x5ac722(0xe2),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x5ac722(0xb2)](_0x5d1abd)}),_0x2229b9=Date[_0x5ac722(0xcb)]()-_0x1a3ef2;console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x1dccae[_0x5ac722(0xbc)]+_0x5ac722(0xc3)+_0x44ad08['status']+'\x20('+_0x2229b9+'ms)');}catch(_0x2d8463){console['error'](_0x5ac722(0xf1),_0x2d8463);}}async['sendPaymentStatusNotification'](_0x201bf5,_0x101c79){const _0x52708a=a8_0x324015;try{const {telegramBotService:_0x5e47c7}=await Promise[_0x52708a(0xf4)]()[_0x52708a(0xf6)](()=>__importStar(require('../services/telegramBotService'))),_0x1d0094={'PAID':_0x52708a(0xa2),'FAILED':_0x52708a(0xd3)},_0x951759=_0x1d0094[_0x101c79];if(!_0x951759)return;await _0x5e47c7['sendPaymentNotification'](_0x201bf5[_0x52708a(0xa7)],_0x201bf5,_0x951759);}catch(_0x512148){console[_0x52708a(0xac)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x512148);}}}function a8_0x43b5(_0x407cfc,_0x4ac44a){const _0x260bf3=a8_0x260b();return a8_0x43b5=function(_0x43b5ff,_0x52142b){_0x43b5ff=_0x43b5ff-0x8c;let _0x30bcd5=_0x260bf3[_0x43b5ff];return _0x30bcd5;},a8_0x43b5(_0x407cfc,_0x4ac44a);}exports['PaymentController']=PaymentController;