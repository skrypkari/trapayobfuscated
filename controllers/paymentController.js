'use strict';const a8_0x9d4489=a8_0x440c;function a8_0x5807(){const _0xd63bf=['updatedAt','log','Card\x20payment\x20failed','POST','length','last_name','number','params','default','toLowerCase','Payment\x20processed\x20successfully','mastercard_','../services/webhookService','MasterCardService','customerEmail','PENDING','\x20not\x20enabled\x20for\x20shop\x20','webhookService','create','settings','user_agent','stringify','currency','../services/gateways/mastercardService','üí≥\x20Browser\x20IP:\x20','3DS\x20verification\x20required','\x20\x20\x20Return\x20URL:\x20','\x20processed:\x20','gateway_payment_id','call','webhookUrl','gateway','prototype','Error\x20parsing\x20webhook\x20events:','üí≥\x20Processing\x20MasterCard\x20payment:\x20','WebhookService','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','resolve','https://api.trapay.uk/api/webhooks/gateway/mastercard','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','getOwnPropertyDescriptor','Payment\x20status\x20is\x20','writable','failureMessage','paymentMethod','threeds_url','getPaymentById','FAILED','7774085eOHxoX','üí≥\x20MasterCard\x20result:','../services/paymentService','parse','Payment\x20not\x20found','includes','sendPaymentNotification','configurable','system','__esModule','createdAt','ms)','failed','paid','getOwnPropertyNames','paymentService','processMasterCardPayment','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','payment','get','updatePaymentCustomerDataPublic','1286820oXERMj','gatewayOrderId','payment.success','now','customerCountry','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','email','__createBinding','1661892BQuhru','payment.failed','PAID','toISOString','__setModuleDefault','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','PaymentService','first_name','body','üí≥\x20MasterCard\x20URLs:','Failed\x20to\x20send\x20MasterCard\x20webhook:','üìù\x20Customer\x20data:','orderId','masterCardService','18863635SKJrOz',',\x20cannot\x20process','amount','‚úÖ\x20MasterCard\x20payment\x20','error','../services/telegramBotService','hasOwnProperty','getPaymentStatus','webhookLog','1472122fevNyz','then','cardLast4','\x20with\x20status\x20','requires_3ds','slice','../config/database','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','update','application/json','shop','successUrl','json','\x20\x20\x20Result\x20URL\x20(webhook):\x20','defineProperty','status','webhookEvents','mastercard','MasterCard\x20webhook\x20sent\x20to\x20','replace','processCardPayment','367138ycuSdk','sendPaymentStatusNotification','PaymentController','shopId','456927uwZiUz'];a8_0x5807=function(){return _0xd63bf;};return a8_0x5807();}(function(_0x421cb9,_0x2d0676){const _0x219237=a8_0x440c,_0x36e7d2=_0x421cb9();while(!![]){try{const _0x521ea0=-parseInt(_0x219237(0x269))/0x1+-parseInt(_0x219237(0x254))/0x2+parseInt(_0x219237(0x1ee))/0x3+parseInt(_0x219237(0x23d))/0x4+-parseInt(_0x219237(0x220))/0x5+parseInt(_0x219237(0x235))/0x6+parseInt(_0x219237(0x24b))/0x7;if(_0x521ea0===_0x2d0676)break;else _0x36e7d2['push'](_0x36e7d2['shift']());}catch(_0x2e0fee){_0x36e7d2['push'](_0x36e7d2['shift']());}}}(a8_0x5807,0xc7f61));var __createBinding=this&&this[a8_0x9d4489(0x23c)]||(Object['create']?function(_0x52618b,_0x4d9d27,_0x47f89f,_0xb8391c){const _0x43005d=a8_0x9d4489;if(_0xb8391c===undefined)_0xb8391c=_0x47f89f;var _0x40f155=Object[_0x43005d(0x218)](_0x4d9d27,_0x47f89f);(!_0x40f155||(_0x43005d(0x233)in _0x40f155?!_0x4d9d27[_0x43005d(0x229)]:_0x40f155[_0x43005d(0x21a)]||_0x40f155[_0x43005d(0x227)]))&&(_0x40f155={'enumerable':!![],'get':function(){return _0x4d9d27[_0x47f89f];}}),Object[_0x43005d(0x262)](_0x52618b,_0xb8391c,_0x40f155);}:function(_0x3095c7,_0x11e8ae,_0x2e09a6,_0x148d94){if(_0x148d94===undefined)_0x148d94=_0x2e09a6;_0x3095c7[_0x148d94]=_0x11e8ae[_0x2e09a6];}),__setModuleDefault=this&&this[a8_0x9d4489(0x241)]||(Object[a8_0x9d4489(0x201)]?function(_0x12aaf5,_0x3112e9){const _0x1efc00=a8_0x9d4489;Object[_0x1efc00(0x262)](_0x12aaf5,_0x1efc00(0x1f7),{'enumerable':!![],'value':_0x3112e9});}:function(_0x362683,_0x39ff7b){_0x362683['default']=_0x39ff7b;}),__importStar=this&&this['__importStar']||(function(){var _0x1da7b3=function(_0x1a4479){const _0x4f9485=a8_0x440c;return _0x1da7b3=Object[_0x4f9485(0x22e)]||function(_0x53158f){const _0x24b63b=_0x4f9485;var _0x391540=[];for(var _0x1cac0b in _0x53158f)if(Object[_0x24b63b(0x20f)][_0x24b63b(0x251)][_0x24b63b(0x20c)](_0x53158f,_0x1cac0b))_0x391540[_0x391540[_0x24b63b(0x1f3)]]=_0x1cac0b;return _0x391540;},_0x1da7b3(_0x1a4479);};return function(_0x2819ff){const _0x17d269=a8_0x440c;if(_0x2819ff&&_0x2819ff[_0x17d269(0x229)])return _0x2819ff;var _0x33620a={};if(_0x2819ff!=null){for(var _0xa0a028=_0x1da7b3(_0x2819ff),_0x36474d=0x0;_0x36474d<_0xa0a028[_0x17d269(0x1f3)];_0x36474d++)if(_0xa0a028[_0x36474d]!==_0x17d269(0x1f7))__createBinding(_0x33620a,_0x2819ff,_0xa0a028[_0x36474d]);}return __setModuleDefault(_0x33620a,_0x2819ff),_0x33620a;};}()),__importDefault=this&&this['__importDefault']||function(_0x2d63c7){const _0x34cdc7=a8_0x9d4489;return _0x2d63c7&&_0x2d63c7[_0x34cdc7(0x229)]?_0x2d63c7:{'default':_0x2d63c7};};Object[a8_0x9d4489(0x262)](exports,a8_0x9d4489(0x229),{'value':!![]}),exports[a8_0x9d4489(0x26b)]=void 0x0;const paymentService_1=require(a8_0x9d4489(0x222)),mastercardService_1=require(a8_0x9d4489(0x206)),webhookService_1=require(a8_0x9d4489(0x1fb)),database_1=__importDefault(require(a8_0x9d4489(0x25a)));function a8_0x440c(_0x4b29ab,_0x57d385){const _0x5807f9=a8_0x5807();return a8_0x440c=function(_0x440ceb,_0x1a0cad){_0x440ceb=_0x440ceb-0x1ed;let _0xe1d5b9=_0x5807f9[_0x440ceb];return _0xe1d5b9;},a8_0x440c(_0x4b29ab,_0x57d385);}class PaymentController{constructor(){const _0x19b8f9=a8_0x9d4489;this['createPublicPayment']=async(_0x41a638,_0x265aea,_0x2ce127)=>{const _0x4763a7=a8_0x440c;try{const _0xf96be2=_0x41a638[_0x4763a7(0x245)],_0x16c855=await this[_0x4763a7(0x22f)]['createPublicPayment'](_0xf96be2);_0x265aea[_0x4763a7(0x263)](0xc9)['json']({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x16c855});}catch(_0x46388a){_0x2ce127(_0x46388a);}},this[_0x19b8f9(0x252)]=async(_0x3b8582,_0x370385,_0x4ddc14)=>{const _0x3d8713=_0x19b8f9;try{const {id:_0x147197}=_0x3b8582['params'],_0x3845b2=await this[_0x3d8713(0x22f)]['getPaymentStatus'](_0x147197);if(!_0x3845b2)return _0x370385[_0x3d8713(0x263)](0x194)[_0x3d8713(0x260)]({'success':![],'message':_0x3d8713(0x224)});_0x370385['json']({'success':!![],'result':_0x3845b2});}catch(_0x17dafc){_0x4ddc14(_0x17dafc);}},this['getPaymentById']=async(_0x4de14b,_0x4c4fce,_0x18bcb1)=>{const _0x2bfdfa=_0x19b8f9;try{const {id:_0x945e63}=_0x4de14b[_0x2bfdfa(0x1f6)],_0x58fbf5=await this['paymentService'][_0x2bfdfa(0x21e)](_0x945e63);if(!_0x58fbf5)return _0x4c4fce[_0x2bfdfa(0x263)](0x194)[_0x2bfdfa(0x260)]({'success':![],'message':_0x2bfdfa(0x224)});_0x4c4fce[_0x2bfdfa(0x260)]({'success':!![],'result':_0x58fbf5});}catch(_0x4aec1c){_0x18bcb1(_0x4aec1c);}},this['updatePaymentCustomer']=async(_0x8184eb,_0x11f459,_0x42e95a)=>{const _0x2a37c8=_0x19b8f9;try{const {id:_0x3d8a02}=_0x8184eb[_0x2a37c8(0x1f6)],_0x2872dd=_0x8184eb[_0x2a37c8(0x245)];console[_0x2a37c8(0x1f0)](_0x2a37c8(0x23a)+_0x3d8a02),console[_0x2a37c8(0x1f0)](_0x2a37c8(0x248),_0x2872dd);const _0x565179=await this[_0x2a37c8(0x22f)][_0x2a37c8(0x234)](_0x3d8a02,_0x2872dd);if(!_0x565179)return _0x11f459[_0x2a37c8(0x263)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x11f459[_0x2a37c8(0x260)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x565179['id'],'customerIp':_0x565179['customerIp'],'customerUa':_0x565179['customerUa'],'customerCountry':_0x565179[_0x2a37c8(0x239)],'updatedAt':_0x565179[_0x2a37c8(0x1ef)]}});}catch(_0x5ad4dc){_0x42e95a(_0x5ad4dc);}},this[_0x19b8f9(0x230)]=async(_0x441c9f,_0x20fae7,_0x39b130)=>{const _0x364b75=_0x19b8f9;try{const {id:_0x332706}=_0x441c9f[_0x364b75(0x1f6)],{cardData:_0x1a5e69,cardHolder:_0x3fb0ad,browser:_0x1c60ca}=_0x441c9f[_0x364b75(0x245)];console['log'](_0x364b75(0x211)+_0x332706),console[_0x364b75(0x1f0)]('üí≥\x20Card\x20holder:\x20'+_0x3fb0ad['first_name']+'\x20'+_0x3fb0ad[_0x364b75(0x1f4)]+'\x20('+_0x3fb0ad['email']+')'),console[_0x364b75(0x1f0)](_0x364b75(0x207)+_0x1c60ca['ip']);const _0x275b34={'customerName':_0x3fb0ad['first_name']+'\x20'+_0x3fb0ad['last_name'],'customerEmail':_0x3fb0ad['email'],'customerIp':_0x1c60ca['ip'],'customerUa':_0x1c60ca[_0x364b75(0x203)]},_0xf53a81=await database_1['default'][_0x364b75(0x232)]['findUnique']({'where':{'id':_0x332706},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xf53a81)return _0x20fae7['status'](0x194)[_0x364b75(0x260)]({'success':![],'message':_0x364b75(0x224)});if(_0xf53a81[_0x364b75(0x20e)]!==_0x364b75(0x265))return _0x20fae7[_0x364b75(0x263)](0x190)[_0x364b75(0x260)]({'success':![],'message':_0x364b75(0x214)});if(_0xf53a81['status']!==_0x364b75(0x1fe))return _0x20fae7[_0x364b75(0x263)](0x190)['json']({'success':![],'message':_0x364b75(0x219)+_0xf53a81[_0x364b75(0x263)]+_0x364b75(0x24c)});await database_1[_0x364b75(0x1f7)][_0x364b75(0x232)][_0x364b75(0x25c)]({'where':{'id':_0x332706},'data':{..._0x275b34,'updatedAt':new Date()}});const _0x286ea8=_0x364b75(0x216),_0x40d092=_0xf53a81[_0x364b75(0x25f)];console[_0x364b75(0x1f0)](_0x364b75(0x246)),console[_0x364b75(0x1f0)](_0x364b75(0x261)+_0x286ea8),console[_0x364b75(0x1f0)](_0x364b75(0x209)+_0x40d092);const _0x1dd493={'first_name':_0x3fb0ad[_0x364b75(0x244)],'last_name':_0x3fb0ad['last_name'],'email':_0x3fb0ad[_0x364b75(0x23b)]},_0x42ce78=await this[_0x364b75(0x24a)][_0x364b75(0x268)]({'paymentId':_0xf53a81['id'],'orderId':_0xf53a81[_0x364b75(0x236)]||_0xf53a81['id'],'amount':_0xf53a81[_0x364b75(0x24d)],'currency':_0xf53a81['currency'],'cardData':_0x1a5e69,'resultUrl':_0x286ea8,'returnUrl':_0x40d092,'cardHolder':_0x1dd493,'browser':_0x1c60ca});console['log'](_0x364b75(0x221),_0x42ce78);const _0x491f6d={'status':_0x42ce78[_0x364b75(0x263)],'updatedAt':new Date(),'statusChangedBy':_0x364b75(0x228),'statusChangedAt':new Date()};_0x42ce78[_0x364b75(0x20b)]&&(_0x491f6d['gatewayPaymentId']=_0x42ce78[_0x364b75(0x20b)],console[_0x364b75(0x1f0)](_0x364b75(0x25b)+_0x42ce78['gateway_payment_id']));if(_0x42ce78[_0x364b75(0x263)]===_0x364b75(0x23f))_0x491f6d['paidAt']=new Date();else _0x42ce78[_0x364b75(0x263)]==='FAILED'&&(_0x491f6d[_0x364b75(0x21b)]=_0x364b75(0x1f1));_0x491f6d[_0x364b75(0x21c)]='mastercard';if(_0x1a5e69['number']){const _0x29d1a2=_0x1a5e69[_0x364b75(0x1f5)][_0x364b75(0x267)](/[\s-]/g,'');_0x491f6d['cardLast4']=_0x29d1a2[_0x364b75(0x259)](-0x4),console['log'](_0x364b75(0x213)+_0x491f6d[_0x364b75(0x256)]);}await database_1[_0x364b75(0x1f7)][_0x364b75(0x232)][_0x364b75(0x25c)]({'where':{'id':_0xf53a81['id']},'data':_0x491f6d}),await database_1[_0x364b75(0x1f7)][_0x364b75(0x253)][_0x364b75(0x201)]({'data':{'paymentId':_0xf53a81['id'],'shopId':_0xf53a81[_0x364b75(0x1ed)],'event':_0x364b75(0x1fa)+_0x42ce78['status']?.[_0x364b75(0x1f8)](),'statusCode':0xc8,'responseBody':JSON[_0x364b75(0x204)]({'oldStatus':'PENDING','newStatus':_0x42ce78['status'],'gatewayPaymentId':_0x42ce78['gateway_payment_id'],'requires3ds':_0x42ce78[_0x364b75(0x258)],'processedAt':new Date()[_0x364b75(0x240)]()})}});if(_0x42ce78['final']){await this['sendShopWebhook'](_0xf53a81,_0x42ce78[_0x364b75(0x263)],_0x42ce78[_0x364b75(0x20b)]),await this[_0x364b75(0x26a)](_0xf53a81,_0x42ce78[_0x364b75(0x263)]);if(_0x42ce78[_0x364b75(0x263)]===_0x364b75(0x23f)){console[_0x364b75(0x1f0)]('üìà\x20MasterCard\x20payment\x20'+_0x332706+_0x364b75(0x242));try{const {PaymentLinkService:_0x1eb69a}=await Promise[_0x364b75(0x215)]()[_0x364b75(0x255)](()=>__importStar(require('../services/paymentLinkService'))),_0x1863bb=new _0x1eb69a();await _0x1863bb['handleSuccessfulPayment'](_0x332706),console[_0x364b75(0x1f0)](_0x364b75(0x231)+_0x332706);}catch(_0x5f0940){console[_0x364b75(0x24f)](_0x364b75(0x217),_0x5f0940);}}}console[_0x364b75(0x1f0)](_0x364b75(0x24e)+_0x332706+_0x364b75(0x20a)+_0x42ce78[_0x364b75(0x263)]);if(_0x42ce78['status']===_0x364b75(0x23f))_0x20fae7[_0x364b75(0x260)]({'success':!![],'message':_0x364b75(0x1f9),'result':{'status':_0x364b75(0x23f),'gatewayPaymentId':_0x42ce78[_0x364b75(0x20b)],'redirectUrl':_0x40d092,'final':!![]}});else _0x42ce78[_0x364b75(0x258)]&&_0x42ce78[_0x364b75(0x21d)]?_0x20fae7[_0x364b75(0x260)]({'success':!![],'message':_0x364b75(0x208),'result':{'status':'PENDING','gatewayPaymentId':_0x42ce78[_0x364b75(0x20b)],'redirectUrl':_0x42ce78[_0x364b75(0x21d)],'requires3ds':!![],'final':![]}}):_0x20fae7[_0x364b75(0x263)](0x190)[_0x364b75(0x260)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x364b75(0x21f),'gatewayPaymentId':_0x42ce78[_0x364b75(0x20b)],'redirectUrl':_0xf53a81['failUrl'],'final':!![]}});}catch(_0x1c074b){_0x39b130(_0x1c074b);}},this[_0x19b8f9(0x22f)]=new paymentService_1[(_0x19b8f9(0x243))](),this[_0x19b8f9(0x24a)]=new mastercardService_1[(_0x19b8f9(0x1fc))](),this[_0x19b8f9(0x200)]=new webhookService_1[(_0x19b8f9(0x212))]();}async['sendShopWebhook'](_0x3c2fb,_0xe1bbe0,_0x80d426){const _0x239792=a8_0x9d4489,_0x244c94=Date[_0x239792(0x238)]();try{const _0x268d82=_0x3c2fb[_0x239792(0x25e)],_0x481074=_0x268d82[_0x239792(0x202)];if(!_0x481074?.['webhookUrl']){console[_0x239792(0x1f0)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x268d82['id']);return;}const _0x379cf2=_0xe1bbe0===_0x239792(0x23f)?_0x239792(0x237):_0x239792(0x23e);let _0x5e683f=[];if(_0x481074['webhookEvents'])try{_0x5e683f=Array['isArray'](_0x481074[_0x239792(0x264)])?_0x481074['webhookEvents']:JSON[_0x239792(0x223)](_0x481074[_0x239792(0x264)]);}catch(_0x2183f1){console[_0x239792(0x24f)](_0x239792(0x210),_0x2183f1),_0x5e683f=[];}if(!_0x5e683f[_0x239792(0x225)](_0x379cf2)){console[_0x239792(0x1f0)]('Webhook\x20event\x20'+_0x379cf2+_0x239792(0x1ff)+_0x268d82['id']);return;}const _0x25a9bb={'event':_0x379cf2,'payment':{'id':_0x3c2fb['id'],'order_id':_0x3c2fb[_0x239792(0x249)],'gateway_order_id':_0x3c2fb['gatewayOrderId'],'gateway':'1111','amount':_0x3c2fb[_0x239792(0x24d)],'currency':_0x3c2fb[_0x239792(0x205)],'status':_0xe1bbe0[_0x239792(0x1f8)](),'customer_email':_0x3c2fb[_0x239792(0x1fd)],'customer_name':_0x3c2fb['customerName'],'gateway_payment_id':_0x80d426,'created_at':_0x3c2fb[_0x239792(0x22a)],'updated_at':new Date()}},_0x4824d8=await fetch(_0x481074[_0x239792(0x20d)],{'method':_0x239792(0x1f2),'headers':{'Content-Type':_0x239792(0x25d),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x239792(0x204)](_0x25a9bb)}),_0x277205=Date['now']()-_0x244c94;console['log'](_0x239792(0x266)+_0x481074['webhookUrl']+_0x239792(0x257)+_0x4824d8[_0x239792(0x263)]+'\x20('+_0x277205+_0x239792(0x22b));}catch(_0x4b1f34){console[_0x239792(0x24f)](_0x239792(0x247),_0x4b1f34);}}async['sendPaymentStatusNotification'](_0x32cb7a,_0x472693){const _0x5b9aa1=a8_0x9d4489;try{const {telegramBotService:_0x2bce3e}=await Promise[_0x5b9aa1(0x215)]()[_0x5b9aa1(0x255)](()=>__importStar(require(_0x5b9aa1(0x250)))),_0x341a8b={'PAID':_0x5b9aa1(0x22d),'FAILED':_0x5b9aa1(0x22c)},_0x40e713=_0x341a8b[_0x472693];if(!_0x40e713)return;await _0x2bce3e[_0x5b9aa1(0x226)](_0x32cb7a[_0x5b9aa1(0x1ed)],_0x32cb7a,_0x40e713);}catch(_0x44ec0b){console[_0x5b9aa1(0x24f)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x44ec0b);}}}exports[a8_0x9d4489(0x26b)]=PaymentController;