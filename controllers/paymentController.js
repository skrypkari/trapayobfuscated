'use strict';const a8_0xd7e6bb=a8_0x1335;(function(_0x88e426,_0x2616be){const _0x376d63=a8_0x1335,_0x9b9b3c=_0x88e426();while(!![]){try{const _0x1f0c40=parseInt(_0x376d63(0x1e5))/0x1+-parseInt(_0x376d63(0x1be))/0x2+parseInt(_0x376d63(0x162))/0x3*(parseInt(_0x376d63(0x15c))/0x4)+parseInt(_0x376d63(0x15d))/0x5*(-parseInt(_0x376d63(0x1ba))/0x6)+-parseInt(_0x376d63(0x1dd))/0x7*(parseInt(_0x376d63(0x1ab))/0x8)+parseInt(_0x376d63(0x1db))/0x9*(parseInt(_0x376d63(0x197))/0xa)+-parseInt(_0x376d63(0x1ad))/0xb*(parseInt(_0x376d63(0x173))/0xc);if(_0x1f0c40===_0x2616be)break;else _0x9b9b3c['push'](_0x9b9b3c['shift']());}catch(_0x3b6549){_0x9b9b3c['push'](_0x9b9b3c['shift']());}}}(a8_0xd6fa,0x5ea30));function a8_0xd6fa(){const _0x15613a=['PaymentController','create','cardLast4','üìù\x20Customer\x20data:','payment','Failed\x20to\x20send\x20MasterCard\x20webhook:','\x20\x20\x20Return\x20URL:\x20','1111','10NSZafA','last_name','üìà\x20MasterCard\x20payment\x20','replace','log','error','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','default','paidAt','üí≥\x20Browser\x20IP:\x20','customerUa','country','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','getPaymentStatus','MasterCard\x20webhook\x20sent\x20to\x20','failureMessage','paid','requires_3ds','threeds_url','PENDING','978680mYCagy','final','2130469Zwyhjy','sendShopWebhook','__createBinding','createPublicPayment','__esModule','mastercard_','configurable','processMasterCardPayment','\x20processed:\x20','sendPaymentNotification','üí≥\x20MasterCard\x20result:','successUrl','handleSuccessfulPayment','1664694yKIUyV','getOwnPropertyNames','Payment\x20created\x20successfully','includes','895110PuZPTW','ms)','parse','gatewayOrderId','shopId','gateway','paymentService','Customer\x20data\x20updated\x20successfully','findUnique','webhookService','3DS\x20verification\x20required','application/json','prototype','\x20not\x20enabled\x20for\x20shop\x20','mastercard','status','stringify','json','defineProperty','getOwnPropertyDescriptor','createdAt','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','payment.success','MasterCardService','updatedAt','settings','PAID','now','updatePaymentCustomer','5949477fMWplG','resolve','21HLWbVi','webhookLog','toISOString','üí≥\x20Card\x20holder:\x20','PaymentService','user_agent','Payment\x20failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','768759EwRHAS','Error\x20parsing\x20webhook\x20events:','../services/telegramBotService','isArray','487016Wetocj','5oLBcou','FAILED','failUrl','customerIp','currency','6knItqT','Payment\x20status\x20is\x20','number','__setModuleDefault','WebhookService','writable','../services/webhookService','üí≥\x20Processing\x20MasterCard\x20payment:\x20','customerEmail','params','üí≥\x20MasterCard\x20URLs:','length','first_name','gateway_payment_id','shop','amount','orderId','12lWQjrM','sendPaymentStatusNotification','customerName','Webhook\x20event\x20','webhookEvents','then','update','Payment\x20not\x20found','call','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','webhookUrl','../services/paymentLinkService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','get','‚úÖ\x20MasterCard\x20payment\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','masterCardService','getPaymentById','\x20\x20\x20Result\x20URL\x20(webhook):\x20','\x20with\x20status\x20','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','__importDefault','email','updatePaymentCustomerDataPublic','paymentMethod','POST','https://api.trapay.uk/api/webhooks/gateway/mastercard','body'];a8_0xd6fa=function(){return _0x15613a;};return a8_0xd6fa();}var __createBinding=this&&this[a8_0xd7e6bb(0x1af)]||(Object['create']?function(_0x26c096,_0x181c4d,_0x1db3b3,_0x3beafe){const _0x3aa195=a8_0xd7e6bb;if(_0x3beafe===undefined)_0x3beafe=_0x1db3b3;var _0x319fd1=Object[_0x3aa195(0x1d1)](_0x181c4d,_0x1db3b3);(!_0x319fd1||(_0x3aa195(0x180)in _0x319fd1?!_0x181c4d[_0x3aa195(0x1b1)]:_0x319fd1[_0x3aa195(0x167)]||_0x319fd1[_0x3aa195(0x1b3)]))&&(_0x319fd1={'enumerable':!![],'get':function(){return _0x181c4d[_0x1db3b3];}}),Object[_0x3aa195(0x1d0)](_0x26c096,_0x3beafe,_0x319fd1);}:function(_0x5a1ced,_0x21f70c,_0x539bbd,_0x5adacd){if(_0x5adacd===undefined)_0x5adacd=_0x539bbd;_0x5a1ced[_0x5adacd]=_0x21f70c[_0x539bbd];}),__setModuleDefault=this&&this[a8_0xd7e6bb(0x165)]||(Object[a8_0xd7e6bb(0x190)]?function(_0x18a43c,_0xe1d503){const _0xd4f425=a8_0xd7e6bb;Object[_0xd4f425(0x1d0)](_0x18a43c,_0xd4f425(0x19e),{'enumerable':!![],'value':_0xe1d503});}:function(_0x9c37e9,_0x587cd9){const _0x4fbb17=a8_0xd7e6bb;_0x9c37e9[_0x4fbb17(0x19e)]=_0x587cd9;}),__importStar=this&&this['__importStar']||(function(){var _0xd67e1b=function(_0x2d32d6){const _0x156a12=a8_0x1335;return _0xd67e1b=Object[_0x156a12(0x1bb)]||function(_0x5a538c){const _0x5811ba=_0x156a12;var _0x409f25=[];for(var _0x33e179 in _0x5a538c)if(Object[_0x5811ba(0x1ca)]['hasOwnProperty'][_0x5811ba(0x17b)](_0x5a538c,_0x33e179))_0x409f25[_0x409f25[_0x5811ba(0x16d)]]=_0x33e179;return _0x409f25;},_0xd67e1b(_0x2d32d6);};return function(_0x161259){const _0x3eace7=a8_0x1335;if(_0x161259&&_0x161259[_0x3eace7(0x1b1)])return _0x161259;var _0x5f419a={};if(_0x161259!=null){for(var _0x4ec5f9=_0xd67e1b(_0x161259),_0x1bc44d=0x0;_0x1bc44d<_0x4ec5f9['length'];_0x1bc44d++)if(_0x4ec5f9[_0x1bc44d]!==_0x3eace7(0x19e))__createBinding(_0x5f419a,_0x161259,_0x4ec5f9[_0x1bc44d]);}return __setModuleDefault(_0x5f419a,_0x161259),_0x5f419a;};}()),__importDefault=this&&this[a8_0xd7e6bb(0x188)]||function(_0x3d9669){return _0x3d9669&&_0x3d9669['__esModule']?_0x3d9669:{'default':_0x3d9669};};Object[a8_0xd7e6bb(0x1d0)](exports,'__esModule',{'value':!![]}),exports[a8_0xd7e6bb(0x18f)]=void 0x0;function a8_0x1335(_0x5246a8,_0x205302){const _0xd6fa7c=a8_0xd6fa();return a8_0x1335=function(_0x1335d1,_0x3e384d){_0x1335d1=_0x1335d1-0x15c;let _0x41e668=_0xd6fa7c[_0x1335d1];return _0x41e668;},a8_0x1335(_0x5246a8,_0x205302);}const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0xd7e6bb(0x168)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x204b37=a8_0xd7e6bb;this[_0x204b37(0x1b0)]=async(_0x57cb51,_0x185efc,_0x4be5ce)=>{const _0x4c63bc=_0x204b37;try{const _0xa188bc=_0x57cb51[_0x4c63bc(0x18e)],_0x316fc0=await this[_0x4c63bc(0x1c4)]['createPublicPayment'](_0xa188bc);_0x185efc[_0x4c63bc(0x1cd)](0xc9)[_0x4c63bc(0x1cf)]({'success':!![],'message':_0x4c63bc(0x1bc),'result':_0x316fc0});}catch(_0x244729){_0x4be5ce(_0x244729);}},this[_0x204b37(0x1a4)]=async(_0x4e282a,_0x53dfe3,_0x1f7c10)=>{const _0x4a5f70=_0x204b37;try{const {id:_0x34afc8}=_0x4e282a['params'],_0x1013bd=await this['paymentService'][_0x4a5f70(0x1a4)](_0x34afc8);if(!_0x1013bd)return _0x53dfe3[_0x4a5f70(0x1cd)](0x194)[_0x4a5f70(0x1cf)]({'success':![],'message':_0x4a5f70(0x17a)});_0x53dfe3[_0x4a5f70(0x1cf)]({'success':!![],'result':_0x1013bd});}catch(_0x58d767){_0x1f7c10(_0x58d767);}},this[_0x204b37(0x184)]=async(_0x55b502,_0x41d21c,_0x5ad73e)=>{const _0x2fc534=_0x204b37;try{const {id:_0x533a8f}=_0x55b502[_0x2fc534(0x16b)],_0x175a98=await this[_0x2fc534(0x1c4)][_0x2fc534(0x184)](_0x533a8f);if(!_0x175a98)return _0x41d21c[_0x2fc534(0x1cd)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x41d21c[_0x2fc534(0x1cf)]({'success':!![],'result':_0x175a98});}catch(_0x462fd5){_0x5ad73e(_0x462fd5);}},this[_0x204b37(0x1da)]=async(_0x1a9744,_0x2bf7c4,_0x4c12b4)=>{const _0x3a6436=_0x204b37;try{const {id:_0x28c8b3}=_0x1a9744[_0x3a6436(0x16b)],_0x271037=_0x1a9744[_0x3a6436(0x18e)];console[_0x3a6436(0x19b)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x28c8b3),console[_0x3a6436(0x19b)](_0x3a6436(0x192),_0x271037);const _0x3760bc=await this[_0x3a6436(0x1c4)][_0x3a6436(0x18a)](_0x28c8b3,_0x271037);if(!_0x3760bc)return _0x2bf7c4[_0x3a6436(0x1cd)](0x194)[_0x3a6436(0x1cf)]({'success':![],'message':_0x3a6436(0x17a)});_0x2bf7c4['json']({'success':!![],'message':_0x3a6436(0x1c5),'result':{'paymentId':_0x3760bc['id'],'customerIp':_0x3760bc[_0x3a6436(0x160)],'customerUa':_0x3760bc[_0x3a6436(0x1a1)],'customerCountry':_0x3760bc['customerCountry'],'updatedAt':_0x3760bc[_0x3a6436(0x1d6)]}});}catch(_0x42b322){_0x4c12b4(_0x42b322);}},this[_0x204b37(0x1b4)]=async(_0x383ee5,_0x19c293,_0x5e5169)=>{const _0x1faf59=_0x204b37;try{const {id:_0x9ff60b}=_0x383ee5[_0x1faf59(0x16b)],{cardData:_0x2bc9ec,cardHolder:_0x5d35a4,browser:_0x19039a}=_0x383ee5[_0x1faf59(0x18e)];console['log'](_0x1faf59(0x169)+_0x9ff60b),console[_0x1faf59(0x19b)](_0x1faf59(0x1e0)+_0x5d35a4[_0x1faf59(0x16e)]+'\x20'+_0x5d35a4[_0x1faf59(0x198)]+'\x20('+_0x5d35a4['email']+')'),console[_0x1faf59(0x19b)](_0x1faf59(0x1a0)+_0x19039a['ip']);const _0x5ba74b={'customerName':_0x5d35a4['first_name']+'\x20'+_0x5d35a4[_0x1faf59(0x198)],'customerEmail':_0x5d35a4[_0x1faf59(0x189)],'customerIp':_0x19039a['ip'],'customerUa':_0x19039a[_0x1faf59(0x1e2)],'customerCountry':_0x5d35a4[_0x1faf59(0x1a2)]||null},_0x44e670=await database_1[_0x1faf59(0x19e)][_0x1faf59(0x193)][_0x1faf59(0x1c6)]({'where':{'id':_0x9ff60b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x44e670)return _0x19c293[_0x1faf59(0x1cd)](0x194)[_0x1faf59(0x1cf)]({'success':![],'message':_0x1faf59(0x17a)});if(_0x44e670[_0x1faf59(0x1c3)]!==_0x1faf59(0x1cc))return _0x19c293[_0x1faf59(0x1cd)](0x190)[_0x1faf59(0x1cf)]({'success':![],'message':_0x1faf59(0x17c)});if(_0x44e670[_0x1faf59(0x1cd)]!=='PENDING')return _0x19c293[_0x1faf59(0x1cd)](0x190)[_0x1faf59(0x1cf)]({'success':![],'message':_0x1faf59(0x163)+_0x44e670['status']+',\x20cannot\x20process'});await database_1['default'][_0x1faf59(0x193)][_0x1faf59(0x179)]({'where':{'id':_0x9ff60b},'data':{..._0x5ba74b,'updatedAt':new Date()}});const _0x2241f1=_0x1faf59(0x18d),_0x2ceb97=_0x44e670[_0x1faf59(0x1b8)];console[_0x1faf59(0x19b)](_0x1faf59(0x16c)),console[_0x1faf59(0x19b)](_0x1faf59(0x185)+_0x2241f1),console[_0x1faf59(0x19b)](_0x1faf59(0x195)+_0x2ceb97);const _0x31e25a={'first_name':_0x5d35a4[_0x1faf59(0x16e)],'last_name':_0x5d35a4[_0x1faf59(0x198)],'email':_0x5d35a4[_0x1faf59(0x189)]},_0x1d75ef=await this[_0x1faf59(0x183)]['processCardPayment']({'paymentId':_0x44e670['id'],'orderId':_0x44e670[_0x1faf59(0x1c1)]||_0x44e670['id'],'amount':_0x44e670[_0x1faf59(0x171)],'currency':_0x44e670['currency'],'cardData':_0x2bc9ec,'resultUrl':_0x2241f1,'returnUrl':_0x2ceb97,'cardHolder':_0x31e25a,'browser':_0x19039a});console['log'](_0x1faf59(0x1b7),_0x1d75ef);const _0x43f200={'status':_0x1d75ef[_0x1faf59(0x1cd)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x1d75ef[_0x1faf59(0x1cd)]==='PAID')_0x43f200[_0x1faf59(0x19f)]=new Date(),_0x43f200['gatewayPaymentId']=_0x1d75ef[_0x1faf59(0x16f)];else _0x1d75ef[_0x1faf59(0x1cd)]===_0x1faf59(0x15e)&&(_0x43f200[_0x1faf59(0x1a6)]='Card\x20payment\x20failed');_0x43f200[_0x1faf59(0x18b)]=_0x1faf59(0x1cc);if(_0x2bc9ec[_0x1faf59(0x164)]){const _0x512f02=_0x2bc9ec[_0x1faf59(0x164)][_0x1faf59(0x19a)](/[\s-]/g,'');_0x43f200[_0x1faf59(0x191)]=_0x512f02['slice'](-0x4),console[_0x1faf59(0x19b)](_0x1faf59(0x19d)+_0x43f200[_0x1faf59(0x191)]);}await database_1[_0x1faf59(0x19e)][_0x1faf59(0x193)][_0x1faf59(0x179)]({'where':{'id':_0x44e670['id']},'data':_0x43f200}),await database_1['default'][_0x1faf59(0x1de)]['create']({'data':{'paymentId':_0x44e670['id'],'shopId':_0x44e670[_0x1faf59(0x1c2)],'event':_0x1faf59(0x1b2)+_0x1d75ef[_0x1faf59(0x1cd)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1faf59(0x1ce)]({'oldStatus':_0x1faf59(0x1aa),'newStatus':_0x1d75ef['status'],'gatewayPaymentId':_0x1d75ef[_0x1faf59(0x16f)],'requires3ds':_0x1d75ef[_0x1faf59(0x1a8)],'processedAt':new Date()[_0x1faf59(0x1df)]()})}});if(_0x1d75ef[_0x1faf59(0x1ac)]){await this[_0x1faf59(0x1ae)](_0x44e670,_0x1d75ef['status'],_0x1d75ef[_0x1faf59(0x16f)]),await this[_0x1faf59(0x174)](_0x44e670,_0x1d75ef[_0x1faf59(0x1cd)]);if(_0x1d75ef[_0x1faf59(0x1cd)]===_0x1faf59(0x1d8)){console['log'](_0x1faf59(0x199)+_0x9ff60b+_0x1faf59(0x182));try{const {PaymentLinkService:_0x4b7abe}=await Promise[_0x1faf59(0x1dc)]()[_0x1faf59(0x178)](()=>__importStar(require(_0x1faf59(0x17e)))),_0x165cdf=new _0x4b7abe();await _0x165cdf[_0x1faf59(0x1b9)](_0x9ff60b),console['log'](_0x1faf59(0x187)+_0x9ff60b);}catch(_0x398bcc){console[_0x1faf59(0x19c)](_0x1faf59(0x1d3),_0x398bcc);}}}console[_0x1faf59(0x19b)](_0x1faf59(0x181)+_0x9ff60b+_0x1faf59(0x1b5)+_0x1d75ef[_0x1faf59(0x1cd)]);if(_0x1d75ef[_0x1faf59(0x1cd)]===_0x1faf59(0x1d8))_0x19c293[_0x1faf59(0x1cf)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1faf59(0x1d8),'gatewayPaymentId':_0x1d75ef[_0x1faf59(0x16f)],'redirectUrl':_0x2ceb97,'final':!![]}});else _0x1d75ef['requires_3ds']&&_0x1d75ef[_0x1faf59(0x1a9)]?_0x19c293[_0x1faf59(0x1cf)]({'success':!![],'message':_0x1faf59(0x1c8),'result':{'status':'PENDING','gatewayPaymentId':_0x1d75ef[_0x1faf59(0x16f)],'redirectUrl':_0x1d75ef[_0x1faf59(0x1a9)],'requires3ds':!![],'final':![]}}):_0x19c293[_0x1faf59(0x1cd)](0x190)['json']({'success':![],'message':_0x1faf59(0x1e3),'result':{'status':_0x1faf59(0x15e),'gatewayPaymentId':_0x1d75ef[_0x1faf59(0x16f)],'redirectUrl':_0x44e670[_0x1faf59(0x15f)],'final':!![]}});}catch(_0xa37ab6){_0x5e5169(_0xa37ab6);}},this[_0x204b37(0x1c4)]=new paymentService_1[(_0x204b37(0x1e1))](),this[_0x204b37(0x183)]=new mastercardService_1[(_0x204b37(0x1d5))](),this[_0x204b37(0x1c7)]=new webhookService_1[(_0x204b37(0x166))]();}async['sendShopWebhook'](_0x403f43,_0x3e028b,_0x593c1e){const _0x45dc58=a8_0xd7e6bb,_0x53840e=Date[_0x45dc58(0x1d9)]();try{const _0xae4a35=_0x403f43[_0x45dc58(0x170)],_0x1da421=_0xae4a35[_0x45dc58(0x1d7)];if(!_0x1da421?.[_0x45dc58(0x17d)]){console['log'](_0x45dc58(0x1a3)+_0xae4a35['id']);return;}const _0x2af55c=_0x3e028b===_0x45dc58(0x1d8)?_0x45dc58(0x1d4):'payment.failed';let _0x318ab4=[];if(_0x1da421['webhookEvents'])try{_0x318ab4=Array[_0x45dc58(0x1e8)](_0x1da421['webhookEvents'])?_0x1da421[_0x45dc58(0x177)]:JSON[_0x45dc58(0x1c0)](_0x1da421[_0x45dc58(0x177)]);}catch(_0x505406){console[_0x45dc58(0x19c)](_0x45dc58(0x1e6),_0x505406),_0x318ab4=[];}if(!_0x318ab4[_0x45dc58(0x1bd)](_0x2af55c)){console[_0x45dc58(0x19b)](_0x45dc58(0x176)+_0x2af55c+_0x45dc58(0x1cb)+_0xae4a35['id']);return;}const _0x26e920={'event':_0x2af55c,'payment':{'id':_0x403f43['id'],'order_id':_0x403f43[_0x45dc58(0x172)],'gateway_order_id':_0x403f43[_0x45dc58(0x1c1)],'gateway':_0x45dc58(0x196),'amount':_0x403f43['amount'],'currency':_0x403f43[_0x45dc58(0x161)],'status':_0x3e028b['toLowerCase'](),'customer_email':_0x403f43[_0x45dc58(0x16a)],'customer_name':_0x403f43[_0x45dc58(0x175)],'gateway_payment_id':_0x593c1e,'created_at':_0x403f43[_0x45dc58(0x1d2)],'updated_at':new Date()}},_0x3b221c=await fetch(_0x1da421[_0x45dc58(0x17d)],{'method':_0x45dc58(0x18c),'headers':{'Content-Type':_0x45dc58(0x1c9),'User-Agent':_0x45dc58(0x17f)},'body':JSON[_0x45dc58(0x1ce)](_0x26e920)}),_0x1ee25e=Date['now']()-_0x53840e;console[_0x45dc58(0x19b)](_0x45dc58(0x1a5)+_0x1da421[_0x45dc58(0x17d)]+_0x45dc58(0x186)+_0x3b221c[_0x45dc58(0x1cd)]+'\x20('+_0x1ee25e+_0x45dc58(0x1bf));}catch(_0x97e13d){console[_0x45dc58(0x19c)](_0x45dc58(0x194),_0x97e13d);}}async[a8_0xd7e6bb(0x174)](_0x550adf,_0x13a5d3){const _0x5c8a55=a8_0xd7e6bb;try{const {telegramBotService:_0x384318}=await Promise[_0x5c8a55(0x1dc)]()[_0x5c8a55(0x178)](()=>__importStar(require(_0x5c8a55(0x1e7)))),_0x5724f3={'PAID':_0x5c8a55(0x1a7),'FAILED':'failed'},_0x2b66f6=_0x5724f3[_0x13a5d3];if(!_0x2b66f6)return;await _0x384318[_0x5c8a55(0x1b6)](_0x550adf[_0x5c8a55(0x1c2)],_0x550adf,_0x2b66f6);}catch(_0x5f45d7){console[_0x5c8a55(0x19c)](_0x5c8a55(0x1e4),_0x5f45d7);}}}exports['PaymentController']=PaymentController;