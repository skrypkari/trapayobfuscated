'use strict';function a8_0x4ad3(_0x3453bc,_0x192193){const _0x33fda=a8_0x33fd();return a8_0x4ad3=function(_0x4ad3a6,_0x22f0f6){_0x4ad3a6=_0x4ad3a6-0x1e2;let _0x2602bc=_0x33fda[_0x4ad3a6];return _0x2602bc;},a8_0x4ad3(_0x3453bc,_0x192193);}const a8_0x4e5307=a8_0x4ad3;(function(_0xb01ac7,_0x2e6de0){const _0x36fc20=a8_0x4ad3,_0x2e6d0a=_0xb01ac7();while(!![]){try{const _0x563e63=-parseInt(_0x36fc20(0x20a))/0x1*(parseInt(_0x36fc20(0x214))/0x2)+parseInt(_0x36fc20(0x1f0))/0x3*(-parseInt(_0x36fc20(0x1e4))/0x4)+-parseInt(_0x36fc20(0x21b))/0x5+-parseInt(_0x36fc20(0x23f))/0x6+parseInt(_0x36fc20(0x235))/0x7+parseInt(_0x36fc20(0x21e))/0x8*(-parseInt(_0x36fc20(0x1f8))/0x9)+parseInt(_0x36fc20(0x1fd))/0xa;if(_0x563e63===_0x2e6de0)break;else _0x2e6d0a['push'](_0x2e6d0a['shift']());}catch(_0x5bc8b5){_0x2e6d0a['push'](_0x2e6d0a['shift']());}}}(a8_0x33fd,0x35543));function a8_0x33fd(){const _0x21e9e0=['gatewayPaymentId','json','customerName','Payment\x20processed\x20successfully','Payment\x20not\x20found','Webhook\x20event\x20','createPublicPayment','766332UPmrbr','💳\x20MasterCard\x20URLs:','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Payment\x20status\x20is\x20','PENDING','gateway_payment_id','customerCountry','paidAt','__setModuleDefault','call','576252QMiKaK','now','get','sendShopWebhook','\x20\x20\x20Return\x20URL:\x20','status','toLowerCase','paid','POST','create','Payment\x20failed','findUnique','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','getPaymentStatus','\x20processed:\x20','customerEmail','https://api.trapay.uk/api/webhooks/gateway/mastercard','prototype','MasterCardService','updatePaymentCustomerData','resolve','length','getPaymentById','1111','toISOString','__esModule','__importStar','4CpIBbK','failureMessage','../config/database','Card\x20payment\x20failed','../services/gateways/mastercardService','settings','PaymentService','paymentService','amount','sendPaymentStatusNotification','failed','log','912621RXxqty','\x20not\x20enabled\x20for\x20shop\x20','body','processCardPayment','FAILED','update','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Error\x20parsing\x20webhook\x20events:','270pLZINQ','webhookLog','\x20with\x20status\x20','PaymentController','params','13125090VVZnAn','orderId',',\x20cannot\x20process','configurable','shopId','processMasterCardPayment','defineProperty','Failed\x20to\x20send\x20MasterCard\x20webhook:','hasOwnProperty','mastercard','💳\x20Processing\x20MasterCard\x20payment:\x20','currency','paymentMethod','416KUkhGM','writable','masterCardService','customerUa','webhookUrl','💳\x20MasterCard\x20result:','getOwnPropertyDescriptor','failUrl','payment.failed','PAID','2040BFyjwh','default','../services/webhookService','error','WebhookService','MasterCard\x20webhook\x20sent\x20to\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','352755vLTBvr','getOwnPropertyNames','application/json','82248uXbyvL','Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop','includes',',\x20shop:\x20','webhookService','successUrl','system','threeds_url','webhookEvents','gatewayOrderId','stringify','updatePaymentCustomer','isArray','payment','customerIp','final'];a8_0x33fd=function(){return _0x21e9e0;};return a8_0x33fd();}var __createBinding=this&&this['__createBinding']||(Object[a8_0x4e5307(0x248)]?function(_0x201d1e,_0x3e6331,_0x2eb063,_0x389143){const _0x3c17f1=a8_0x4e5307;if(_0x389143===undefined)_0x389143=_0x2eb063;var _0x48ff15=Object[_0x3c17f1(0x210)](_0x3e6331,_0x2eb063);(!_0x48ff15||(_0x3c17f1(0x241)in _0x48ff15?!_0x3e6331['__esModule']:_0x48ff15[_0x3c17f1(0x20b)]||_0x48ff15[_0x3c17f1(0x200)]))&&(_0x48ff15={'enumerable':!![],'get':function(){return _0x3e6331[_0x2eb063];}}),Object['defineProperty'](_0x201d1e,_0x389143,_0x48ff15);}:function(_0x408f71,_0x18d38a,_0x5d2716,_0x5ebed9){if(_0x5ebed9===undefined)_0x5ebed9=_0x5d2716;_0x408f71[_0x5ebed9]=_0x18d38a[_0x5d2716];}),__setModuleDefault=this&&this[a8_0x4e5307(0x23d)]||(Object['create']?function(_0x3da68b,_0x25be71){const _0x33157d=a8_0x4e5307;Object[_0x33157d(0x203)](_0x3da68b,_0x33157d(0x215),{'enumerable':!![],'value':_0x25be71});}:function(_0x5401e7,_0x21b8f7){const _0x2c9ad8=a8_0x4e5307;_0x5401e7[_0x2c9ad8(0x215)]=_0x21b8f7;}),__importStar=this&&this[a8_0x4e5307(0x1e3)]||(function(){var _0x23a825=function(_0x304ae7){const _0x5c0849=a8_0x4ad3;return _0x23a825=Object[_0x5c0849(0x21c)]||function(_0x1c8fe9){const _0x3716e4=_0x5c0849;var _0x48056=[];for(var _0x448f3d in _0x1c8fe9)if(Object[_0x3716e4(0x250)][_0x3716e4(0x205)][_0x3716e4(0x23e)](_0x1c8fe9,_0x448f3d))_0x48056[_0x48056[_0x3716e4(0x254)]]=_0x448f3d;return _0x48056;},_0x23a825(_0x304ae7);};return function(_0x4562e3){const _0x224c12=a8_0x4ad3;if(_0x4562e3&&_0x4562e3[_0x224c12(0x1e2)])return _0x4562e3;var _0x1083ff={};if(_0x4562e3!=null){for(var _0x23cca7=_0x23a825(_0x4562e3),_0x2cc011=0x0;_0x2cc011<_0x23cca7[_0x224c12(0x254)];_0x2cc011++)if(_0x23cca7[_0x2cc011]!==_0x224c12(0x215))__createBinding(_0x1083ff,_0x4562e3,_0x23cca7[_0x2cc011]);}return __setModuleDefault(_0x1083ff,_0x4562e3),_0x1083ff;};}()),__importDefault=this&&this['__importDefault']||function(_0x4a3f0d){const _0x46e1a1=a8_0x4e5307;return _0x4a3f0d&&_0x4a3f0d[_0x46e1a1(0x1e2)]?_0x4a3f0d:{'default':_0x4a3f0d};};Object[a8_0x4e5307(0x203)](exports,a8_0x4e5307(0x1e2),{'value':!![]}),exports[a8_0x4e5307(0x1fb)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x4e5307(0x1e8)),webhookService_1=require(a8_0x4e5307(0x216)),database_1=__importDefault(require(a8_0x4e5307(0x1e6)));class PaymentController{constructor(){const _0x5c4151=a8_0x4e5307;this[_0x5c4151(0x234)]=async(_0x98c803,_0x35f78a,_0xb85cb3)=>{const _0x4bf838=_0x5c4151;try{const _0x5ee17a=_0x98c803[_0x4bf838(0x1f2)],_0x28529e=await this[_0x4bf838(0x1eb)][_0x4bf838(0x234)](_0x5ee17a);_0x35f78a[_0x4bf838(0x244)](0xc9)[_0x4bf838(0x22f)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x28529e});}catch(_0x5b45d1){_0xb85cb3(_0x5b45d1);}},this[_0x5c4151(0x24c)]=async(_0x272d53,_0x5f16af,_0x1a8599)=>{const _0x1b4b65=_0x5c4151;try{const {id:_0x21bde6}=_0x272d53[_0x1b4b65(0x1fc)],_0x5cd39d=await this['paymentService'][_0x1b4b65(0x24c)](_0x21bde6);if(!_0x5cd39d)return _0x5f16af['status'](0x194)['json']({'success':![],'message':_0x1b4b65(0x232)});_0x5f16af[_0x1b4b65(0x22f)]({'success':!![],'result':_0x5cd39d});}catch(_0xb37ef4){_0x1a8599(_0xb37ef4);}},this[_0x5c4151(0x255)]=async(_0x170894,_0x25626a,_0x1df81c)=>{const _0x4556fd=_0x5c4151;try{const {id:_0x303f9c}=_0x170894[_0x4556fd(0x1fc)],_0xd02272=await this[_0x4556fd(0x1eb)][_0x4556fd(0x255)](_0x303f9c);if(!_0xd02272)return _0x25626a[_0x4556fd(0x244)](0x194)[_0x4556fd(0x22f)]({'success':![],'message':_0x4556fd(0x232)});_0x25626a[_0x4556fd(0x22f)]({'success':!![],'result':_0xd02272});}catch(_0x3e4f79){_0x1df81c(_0x3e4f79);}},this[_0x5c4151(0x229)]=async(_0x39e76f,_0x45844b,_0x5dd55e)=>{const _0xdaaf3f=_0x5c4151;try{const {id:_0x38ebdc}=_0x39e76f[_0xdaaf3f(0x1fc)],_0x7fd4f1=_0x39e76f['user']?.['id'],_0x53eee7=_0x39e76f[_0xdaaf3f(0x1f2)];if(!_0x7fd4f1)return _0x45844b[_0xdaaf3f(0x244)](0x191)[_0xdaaf3f(0x22f)]({'success':![],'message':'Unauthorized'});console[_0xdaaf3f(0x1ef)](_0xdaaf3f(0x1f6)+_0x38ebdc+_0xdaaf3f(0x221)+_0x7fd4f1),console['log']('📝\x20Customer\x20data:',_0x53eee7);const _0xba488a=await this[_0xdaaf3f(0x1eb)][_0xdaaf3f(0x252)](_0x7fd4f1,_0x38ebdc,_0x53eee7);if(!_0xba488a)return _0x45844b[_0xdaaf3f(0x244)](0x194)['json']({'success':![],'message':_0xdaaf3f(0x21f)});_0x45844b[_0xdaaf3f(0x22f)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0xba488a['id'],'customerIp':_0xba488a[_0xdaaf3f(0x22c)],'customerUa':_0xba488a[_0xdaaf3f(0x20d)],'customerCountry':_0xba488a[_0xdaaf3f(0x23b)],'updatedAt':_0xba488a['updatedAt']}});}catch(_0x5bfe53){_0x5dd55e(_0x5bfe53);}},this[_0x5c4151(0x202)]=async(_0x5e4ded,_0x540a81,_0xc4d57e)=>{const _0x59345d=_0x5c4151;try{const {id:_0x2f22ca}=_0x5e4ded['params'],{cardData:_0x14b493,cardHolder:_0x2a3026,browser:_0x3737b8}=_0x5e4ded[_0x59345d(0x1f2)];console[_0x59345d(0x1ef)](_0x59345d(0x207)+_0x2f22ca);const _0x1ac5db=await database_1[_0x59345d(0x215)][_0x59345d(0x22b)][_0x59345d(0x24a)]({'where':{'id':_0x2f22ca},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ac5db)return _0x540a81['status'](0x194)[_0x59345d(0x22f)]({'success':![],'message':_0x59345d(0x232)});if(_0x1ac5db['gateway']!==_0x59345d(0x206))return _0x540a81[_0x59345d(0x244)](0x190)[_0x59345d(0x22f)]({'success':![],'message':_0x59345d(0x237)});if(_0x1ac5db[_0x59345d(0x244)]!==_0x59345d(0x239))return _0x540a81[_0x59345d(0x244)](0x190)['json']({'success':![],'message':_0x59345d(0x238)+_0x1ac5db[_0x59345d(0x244)]+_0x59345d(0x1ff)});const _0x658aff=_0x59345d(0x24f),_0x36703e=_0x1ac5db[_0x59345d(0x223)];console[_0x59345d(0x1ef)](_0x59345d(0x236)),console[_0x59345d(0x1ef)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x658aff),console[_0x59345d(0x1ef)](_0x59345d(0x243)+_0x36703e);const _0x4f1f7=await this[_0x59345d(0x20c)][_0x59345d(0x1f3)]({'paymentId':_0x1ac5db['id'],'orderId':_0x1ac5db[_0x59345d(0x227)]||_0x1ac5db['id'],'amount':_0x1ac5db[_0x59345d(0x1ec)],'currency':_0x1ac5db[_0x59345d(0x208)],'cardData':_0x14b493,'resultUrl':_0x658aff,'returnUrl':_0x36703e,'cardHolder':_0x2a3026,'browser':_0x3737b8});console[_0x59345d(0x1ef)](_0x59345d(0x20f),_0x4f1f7);const _0x422752={'status':_0x4f1f7[_0x59345d(0x244)],'updatedAt':new Date(),'statusChangedBy':_0x59345d(0x224),'statusChangedAt':new Date()};if(_0x4f1f7[_0x59345d(0x244)]===_0x59345d(0x213))_0x422752[_0x59345d(0x23c)]=new Date(),_0x422752[_0x59345d(0x22e)]=_0x4f1f7[_0x59345d(0x23a)];else _0x4f1f7[_0x59345d(0x244)]==='FAILED'&&(_0x422752[_0x59345d(0x1e5)]=_0x59345d(0x1e7));_0x422752[_0x59345d(0x209)]=_0x59345d(0x206),await database_1[_0x59345d(0x215)][_0x59345d(0x22b)][_0x59345d(0x1f5)]({'where':{'id':_0x1ac5db['id']},'data':_0x422752}),await database_1[_0x59345d(0x215)][_0x59345d(0x1f9)][_0x59345d(0x248)]({'data':{'paymentId':_0x1ac5db['id'],'shopId':_0x1ac5db[_0x59345d(0x201)],'event':'mastercard_'+_0x4f1f7[_0x59345d(0x244)]?.[_0x59345d(0x245)](),'statusCode':0xc8,'responseBody':JSON[_0x59345d(0x228)]({'oldStatus':'PENDING','newStatus':_0x4f1f7[_0x59345d(0x244)],'gatewayPaymentId':_0x4f1f7['gateway_payment_id'],'requires3ds':_0x4f1f7['requires_3ds'],'processedAt':new Date()[_0x59345d(0x257)]()})}});_0x4f1f7[_0x59345d(0x22d)]&&(await this[_0x59345d(0x242)](_0x1ac5db,_0x4f1f7['status'],_0x4f1f7[_0x59345d(0x23a)]),await this[_0x59345d(0x1ed)](_0x1ac5db,_0x4f1f7[_0x59345d(0x244)]));console[_0x59345d(0x1ef)]('✅\x20MasterCard\x20payment\x20'+_0x2f22ca+_0x59345d(0x24d)+_0x4f1f7[_0x59345d(0x244)]);if(_0x4f1f7['status']==='PAID')_0x540a81[_0x59345d(0x22f)]({'success':!![],'message':_0x59345d(0x231),'result':{'status':_0x59345d(0x213),'gatewayPaymentId':_0x4f1f7[_0x59345d(0x23a)],'redirectUrl':_0x36703e,'final':!![]}});else _0x4f1f7['requires_3ds']&&_0x4f1f7[_0x59345d(0x225)]?_0x540a81[_0x59345d(0x22f)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x4f1f7['gateway_payment_id'],'redirectUrl':_0x4f1f7[_0x59345d(0x225)],'requires3ds':!![],'final':![]}}):_0x540a81[_0x59345d(0x244)](0x190)[_0x59345d(0x22f)]({'success':![],'message':_0x59345d(0x249),'result':{'status':_0x59345d(0x1f4),'gatewayPaymentId':_0x4f1f7[_0x59345d(0x23a)],'redirectUrl':_0x1ac5db[_0x59345d(0x211)],'final':!![]}});}catch(_0x18fd15){_0xc4d57e(_0x18fd15);}},this['paymentService']=new paymentService_1[(_0x5c4151(0x1ea))](),this[_0x5c4151(0x20c)]=new mastercardService_1[(_0x5c4151(0x251))](),this[_0x5c4151(0x222)]=new webhookService_1[(_0x5c4151(0x218))]();}async[a8_0x4e5307(0x242)](_0x178f7e,_0x3c64b7,_0x8b9a02){const _0x4febe7=a8_0x4e5307,_0x39deb0=Date['now']();try{const _0x5379c6=_0x178f7e['shop'],_0x37e262=_0x5379c6[_0x4febe7(0x1e9)];if(!_0x37e262?.[_0x4febe7(0x20e)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5379c6['id']);return;}const _0x2ab4f7=_0x3c64b7===_0x4febe7(0x213)?'payment.success':_0x4febe7(0x212);let _0xa8812f=[];if(_0x37e262[_0x4febe7(0x226)])try{_0xa8812f=Array[_0x4febe7(0x22a)](_0x37e262[_0x4febe7(0x226)])?_0x37e262[_0x4febe7(0x226)]:JSON['parse'](_0x37e262[_0x4febe7(0x226)]);}catch(_0x333c48){console[_0x4febe7(0x217)](_0x4febe7(0x1f7),_0x333c48),_0xa8812f=[];}if(!_0xa8812f[_0x4febe7(0x220)](_0x2ab4f7)){console[_0x4febe7(0x1ef)](_0x4febe7(0x233)+_0x2ab4f7+_0x4febe7(0x1f1)+_0x5379c6['id']);return;}const _0x339073={'event':_0x2ab4f7,'payment':{'id':_0x178f7e['id'],'order_id':_0x178f7e[_0x4febe7(0x1fe)],'gateway_order_id':_0x178f7e[_0x4febe7(0x227)],'gateway':_0x4febe7(0x256),'amount':_0x178f7e[_0x4febe7(0x1ec)],'currency':_0x178f7e[_0x4febe7(0x208)],'status':_0x3c64b7[_0x4febe7(0x245)](),'customer_email':_0x178f7e[_0x4febe7(0x24e)],'customer_name':_0x178f7e[_0x4febe7(0x230)],'gateway_payment_id':_0x8b9a02,'created_at':_0x178f7e['createdAt'],'updated_at':new Date()}},_0x3a9bab=await fetch(_0x37e262[_0x4febe7(0x20e)],{'method':_0x4febe7(0x247),'headers':{'Content-Type':_0x4febe7(0x21d),'User-Agent':_0x4febe7(0x24b)},'body':JSON[_0x4febe7(0x228)](_0x339073)}),_0x563d8a=Date[_0x4febe7(0x240)]()-_0x39deb0;console[_0x4febe7(0x1ef)](_0x4febe7(0x219)+_0x37e262[_0x4febe7(0x20e)]+_0x4febe7(0x1fa)+_0x3a9bab[_0x4febe7(0x244)]+'\x20('+_0x563d8a+'ms)');}catch(_0x1d2c0b){console[_0x4febe7(0x217)](_0x4febe7(0x204),_0x1d2c0b);}}async[a8_0x4e5307(0x1ed)](_0x4e5c5e,_0x14a205){const _0x53880f=a8_0x4e5307;try{const {telegramBotService:_0x56b645}=await Promise[_0x53880f(0x253)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x417dd0={'PAID':_0x53880f(0x246),'FAILED':_0x53880f(0x1ee)},_0x244db7=_0x417dd0[_0x14a205];if(!_0x244db7)return;await _0x56b645['sendPaymentNotification'](_0x4e5c5e[_0x53880f(0x201)],_0x4e5c5e,_0x244db7);}catch(_0x4e7b39){console[_0x53880f(0x217)](_0x53880f(0x21a),_0x4e7b39);}}}exports[a8_0x4e5307(0x1fb)]=PaymentController;