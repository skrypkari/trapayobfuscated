'use strict';const a14_0x21b52a=a14_0xbaa8;(function(_0x42ccf6,_0x2cb63e){const _0x201b02=a14_0xbaa8,_0xd1ee5d=_0x42ccf6();while(!![]){try{const _0x7c2f7f=parseInt(_0x201b02(0x20b))/0x1*(parseInt(_0x201b02(0x274))/0x2)+parseInt(_0x201b02(0x1f1))/0x3+parseInt(_0x201b02(0x28d))/0x4+-parseInt(_0x201b02(0x29f))/0x5+-parseInt(_0x201b02(0x1e9))/0x6+-parseInt(_0x201b02(0x292))/0x7*(-parseInt(_0x201b02(0x291))/0x8)+-parseInt(_0x201b02(0x272))/0x9*(parseInt(_0x201b02(0x25b))/0xa);if(_0x7c2f7f===_0x2cb63e)break;else _0xd1ee5d['push'](_0xd1ee5d['shift']());}catch(_0x4c0f24){_0xd1ee5d['push'](_0xd1ee5d['shift']());}}}(a14_0x5496,0xa1b8d));function a14_0xbaa8(_0x40ebd8,_0x41c94e){_0x40ebd8=_0x40ebd8-0x1e6;const _0x549621=a14_0x5496();let _0xbaa8fe=_0x549621[_0x40ebd8];return _0xbaa8fe;}function a14_0x5496(){const _0x3b8184=['isValid','errorMessage','paymentMethod','58MvRTMj','getPaymentById','\x20\x20Original:\x20\x22','cardCountry','paidAt','currencyService','üí≥\x20Saving\x20card\x20brand:\x20','billingAddress','customerEmail','requires_3ds','gatewayCommissionRate','\x20URLs:','query','\x20webhook\x20sent\x20to\x20','json','üí≥\x20Processing\x20MasterCard\x20payment:\x20','Error\x20parsing\x20webhook\x20events:','VISA/MasterCard','üßπ\x20Customer\x20names\x20cleaned:','sendShopWebhook','currency','ms)','log','state','first_name','\x20with\x20requestId\x20','update','toUpperCase','writable','../services/paymentLinkService','default','cardLast4','error','customerName','handleSuccessfulPayment','paid','webhookUrl','gateway_payment_id','__importStar','last_name','toFixed','üí∞\x20Gateway\x20','gatewayOrderId',',\x20cannot\x20process','system','webhookEvents','Payment\x20created\x20successfully','mastercard','substring','hasOwnProperty','create','crypto','Webhook\x20event\x20','üìä\x20BIN\x20lookup\x20result:','then','Failed\x20to\x20send\x20','gatewayPaymentId','__createBinding','paymentService','email','orderId','cardIssuer','updatedAt','join','hex','3DS\x20verification\x20required','resolve','isArray','\x20USDT','\x20payment\x20','getOwnPropertyNames','customerIp','Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available','body','amountAfterGatewayCommissionUSDT','Card\x20payment\x20failed','\x20with\x20status\x20','amountUSDT','call','phone','220cUvoiG','parse','now','params','failUrl','string','visa/mastercard','\x20\x20\x20Result\x20URL\x20(webhook):\x20','startsWith','address_line_2','address_line_1','settings','getPaymentStatus','VisaMasterCardService','lineStatus','binLookupService','shopId','toISOString','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','payment.failed','createPublicPayment','cardBinStatus','webhookService','324252GfewQd','Customer\x20data\x20updated\x20successfully','37220tzExTH','failureMessage','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','billingState','Payment\x20status\x20is\x20','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','../services/gateways/mastercardService','replace','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','webhookLog','PaymentController','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','\x20processed:\x20','Payment\x20failed','digest','üí≥\x20Card\x20holder:\x20','post_code','billingZip','__setModuleDefault','__esModule','../services/currencyService','PAID','üîç\x20Received\x20fingerprint\x20request\x20for\x20payment\x20','__importDefault','2706420CBtGoP','Payment\x20not\x20found','üí≥\x20MasterCard\x20result:','../services/webhookService','1540696ITUcJg','7jtEAwe','\x20payment:','filter','defineProperty','üìà\x20','visa','\x20\x20\x20Return\x20URL:\x20','toLowerCase','visaMasterCardService','FAILED','\x20->\x20','updatePaymentCustomer','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','4342130hXCGux','getPaymentFingerprint','CurrencyService','sha256','814632xoJWgj','PENDING','getOwnPropertyDescriptor','length','üîç\x20Looking\x20up\x20BIN\x20for\x20card:','amount','stringify','‚úÖ\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','1531965Rguthk','Bank\x20Card','final','üí∞\x20Updated\x20merchant\x20balance\x20for\x20payment\x20','../config/database','Payment\x20System/1.0\x20(','status','shop','payment','WebhookService','includes','cardType','processCardPayment','requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string','../services/telegramBotService','üí≥\x20','payment.success','createdAt','riskLevel','\x22\x20|\x20\x22','cardBrand','gateway','number'];a14_0x5496=function(){return _0x3b8184;};return a14_0x5496();}var __createBinding=this&&this[a14_0x21b52a(0x244)]||(Object['create']?function(_0x49db13,_0x5f5bf5,_0x4aaa50,_0x47a690){const _0xa29b40=a14_0x21b52a;if(_0x47a690===undefined)_0x47a690=_0x4aaa50;var _0x4c4cfb=Object[_0xa29b40(0x1eb)](_0x5f5bf5,_0x4aaa50);(!_0x4c4cfb||('get'in _0x4c4cfb?!_0x5f5bf5[_0xa29b40(0x288)]:_0x4c4cfb[_0xa29b40(0x227)]||_0x4c4cfb['configurable']))&&(_0x4c4cfb={'enumerable':!![],'get':function(){return _0x5f5bf5[_0x4aaa50];}}),Object['defineProperty'](_0x49db13,_0x47a690,_0x4c4cfb);}:function(_0x4e89eb,_0x21403c,_0x1075fe,_0x5218ae){if(_0x5218ae===undefined)_0x5218ae=_0x1075fe;_0x4e89eb[_0x5218ae]=_0x21403c[_0x1075fe];}),__setModuleDefault=this&&this[a14_0x21b52a(0x287)]||(Object[a14_0x21b52a(0x23d)]?function(_0x5be9bc,_0x43394b){const _0x9502db=a14_0x21b52a;Object[_0x9502db(0x295)](_0x5be9bc,_0x9502db(0x229),{'enumerable':!![],'value':_0x43394b});}:function(_0x17b375,_0x30f7b0){const _0x4f6538=a14_0x21b52a;_0x17b375[_0x4f6538(0x229)]=_0x30f7b0;}),__importStar=this&&this[a14_0x21b52a(0x231)]||(function(){var _0x2d4490=function(_0xc970c0){const _0x338efc=a14_0xbaa8;return _0x2d4490=Object[_0x338efc(0x251)]||function(_0x2499e9){const _0x41b548=_0x338efc;var _0x17859f=[];for(var _0x3b9c84 in _0x2499e9)if(Object['prototype'][_0x41b548(0x23c)][_0x41b548(0x259)](_0x2499e9,_0x3b9c84))_0x17859f[_0x17859f['length']]=_0x3b9c84;return _0x17859f;},_0x2d4490(_0xc970c0);};return function(_0x3fcd9b){const _0x5a5407=a14_0xbaa8;if(_0x3fcd9b&&_0x3fcd9b[_0x5a5407(0x288)])return _0x3fcd9b;var _0x30d928={};if(_0x3fcd9b!=null){for(var _0x4da7e1=_0x2d4490(_0x3fcd9b),_0xcc0b2f=0x0;_0xcc0b2f<_0x4da7e1[_0x5a5407(0x1ec)];_0xcc0b2f++)if(_0x4da7e1[_0xcc0b2f]!==_0x5a5407(0x229))__createBinding(_0x30d928,_0x3fcd9b,_0x4da7e1[_0xcc0b2f]);}return __setModuleDefault(_0x30d928,_0x3fcd9b),_0x30d928;};}()),__importDefault=this&&this[a14_0x21b52a(0x28c)]||function(_0x16b8d6){const _0x2029b0=a14_0x21b52a;return _0x16b8d6&&_0x16b8d6[_0x2029b0(0x288)]?_0x16b8d6:{'default':_0x16b8d6};};Object[a14_0x21b52a(0x295)](exports,a14_0x21b52a(0x288),{'value':!![]}),exports[a14_0x21b52a(0x27f)]=void 0x0;const crypto_1=__importDefault(require(a14_0x21b52a(0x23e))),paymentService_1=require('../services/paymentService'),mastercardService_1=require(a14_0x21b52a(0x27a)),webhookService_1=require(a14_0x21b52a(0x290)),currencyService_1=require(a14_0x21b52a(0x289)),binLookupService_1=require('../services/binLookupService'),database_1=__importDefault(require(a14_0x21b52a(0x1f5)));class PaymentController{constructor(){const _0x470347=a14_0x21b52a;this[_0x470347(0x26f)]=async(_0x295881,_0x13d5a8,_0xbcc7a4)=>{const _0x865b7f=_0x470347;try{const _0x491d98=_0x295881['body'],_0x21a5a1=await this[_0x865b7f(0x245)][_0x865b7f(0x26f)](_0x491d98);_0x13d5a8['status'](0xc9)[_0x865b7f(0x219)]({'success':!![],'message':_0x865b7f(0x239),'result':_0x21a5a1});}catch(_0x9bc190){_0xbcc7a4(_0x9bc190);}},this[_0x470347(0x267)]=async(_0x560e3d,_0x5d3716,_0x14ed0b)=>{const _0x1fe975=_0x470347;try{const {id:_0x52d3dd}=_0x560e3d['params'],_0x5f2787=await this[_0x1fe975(0x245)][_0x1fe975(0x267)](_0x52d3dd);if(!_0x5f2787)return _0x5d3716[_0x1fe975(0x1f7)](0x194)[_0x1fe975(0x219)]({'success':![],'message':'Payment\x20not\x20found'});_0x5d3716[_0x1fe975(0x219)]({'success':!![],'result':_0x5f2787});}catch(_0x69a4a6){_0x14ed0b(_0x69a4a6);}},this[_0x470347(0x1e6)]=async(_0x12ede8,_0x6b9782,_0x3a5662)=>{const _0x311add=_0x470347;try{const {id:_0x29e05a}=_0x12ede8['params'],{requestId:_0x706ae8}=_0x12ede8[_0x311add(0x217)];if(typeof _0x706ae8!==_0x311add(0x260))return _0x6b9782[_0x311add(0x1f7)](0x190)[_0x311add(0x219)]({'success':![],'message':_0x311add(0x1fe)});console['log'](_0x311add(0x28b)+_0x29e05a+_0x311add(0x224)+_0x706ae8);const _0xd865ba=await this[_0x311add(0x245)]['getPaymentFingerprint'](_0x29e05a,_0x706ae8);if(!_0xd865ba)return _0x6b9782[_0x311add(0x1f7)](0x194)['json']({'success':![],'message':_0x311add(0x253)});console[_0x311add(0x221)](_0x311add(0x1f0)+_0x29e05a+':',_0xd865ba),_0x6b9782[_0x311add(0x219)]({'success':!![],'result':_0xd865ba});}catch(_0x37bd13){_0x3a5662(_0x37bd13);}},this['getPaymentById']=async(_0x6d4a2a,_0x383a1a,_0x43a436)=>{const _0x4d7658=_0x470347;try{const {id:_0x406f3d}=_0x6d4a2a['params'],_0x4694e6=await this[_0x4d7658(0x245)][_0x4d7658(0x20c)](_0x406f3d);if(!_0x4694e6)return _0x383a1a['status'](0x194)['json']({'success':![],'message':_0x4d7658(0x28e)});_0x383a1a['json']({'success':!![],'result':_0x4694e6});}catch(_0x4e9c55){_0x43a436(_0x4e9c55);}},this[_0x470347(0x29d)]=async(_0x2247b6,_0xe1090c,_0x5d62f4)=>{const _0x482c31=_0x470347;try{const {id:_0x36b8ce}=_0x2247b6[_0x482c31(0x25e)],_0x2e23be=_0x2247b6['body'];console[_0x482c31(0x221)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x36b8ce),console[_0x482c31(0x221)]('üìù\x20Customer\x20data:',_0x2e23be);const _0x10e7e5=await this['paymentService']['updatePaymentCustomerDataPublic'](_0x36b8ce,_0x2e23be);if(!_0x10e7e5)return _0xe1090c[_0x482c31(0x1f7)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0xe1090c['json']({'success':!![],'message':_0x482c31(0x273),'result':{'paymentId':_0x10e7e5['id'],'customerIp':_0x10e7e5[_0x482c31(0x252)],'customerUa':_0x10e7e5['customerUa'],'customerCountry':_0x10e7e5['customerCountry'],'updatedAt':_0x10e7e5[_0x482c31(0x249)]}});}catch(_0x3a4ea3){_0x5d62f4(_0x3a4ea3);}},this['processMasterCardPayment']=async(_0x60359d,_0xab95f4,_0x495604)=>{const _0x7cfc40=_0x470347;try{const {id:_0x5d9cde}=_0x60359d[_0x7cfc40(0x25e)],{cardData:_0x5e4f9c,cardHolder:_0x5d581e,browser:_0x1a2db0,phoneValidation:_0x52e745}=_0x60359d[_0x7cfc40(0x254)];console['log'](_0x7cfc40(0x21a)+_0x5d9cde),console['log'](_0x7cfc40(0x284)+_0x5d581e[_0x7cfc40(0x223)]+'\x20'+_0x5d581e['last_name']+'\x20('+_0x5d581e[_0x7cfc40(0x246)]+')'),console[_0x7cfc40(0x221)]('üí≥\x20Browser\x20IP:\x20'+_0x1a2db0['ip']);const _0x3d7e91=_0x5d581e[_0x7cfc40(0x223)]?.[_0x7cfc40(0x27b)](/[\t\n\r\f\v]/g,'\x20')['trim']()||'',_0x55b6a5=_0x5d581e[_0x7cfc40(0x232)]?.['replace'](/[\t\n\r\f\v]/g,'\x20')['trim']()||'';console['log'](_0x7cfc40(0x21d)),console[_0x7cfc40(0x221)](_0x7cfc40(0x20d)+_0x5d581e['first_name']+_0x7cfc40(0x204)+_0x5d581e[_0x7cfc40(0x232)]+'\x22'),console[_0x7cfc40(0x221)]('\x20\x20Cleaned:\x20\x20\x22'+_0x3d7e91+'\x22\x20|\x20\x22'+_0x55b6a5+'\x22');const _0x5b18dc={'customerName':_0x3d7e91+'\x20'+_0x55b6a5,'customerEmail':_0x5d581e['email'],'customerPhone':_0x5d581e[_0x7cfc40(0x25a)]||null,'customerIp':_0x1a2db0['ip'],'customerUa':_0x1a2db0['user_agent']},_0x33c627=[_0x5d581e[_0x7cfc40(0x265)],_0x5d581e[_0x7cfc40(0x264)]][_0x7cfc40(0x294)](Boolean);_0x5b18dc[_0x7cfc40(0x212)]=_0x33c627[_0x7cfc40(0x24a)](',\x20')||null,_0x5b18dc['billingCity']=_0x5d581e['city']||null,_0x5b18dc[_0x7cfc40(0x277)]=_0x5d581e[_0x7cfc40(0x222)]||null,_0x5b18dc[_0x7cfc40(0x286)]=_0x5d581e[_0x7cfc40(0x285)]||_0x5d581e['postcode']||null,console[_0x7cfc40(0x221)]('üìç\x20Billing\x20address\x20(string):',_0x5b18dc[_0x7cfc40(0x212)]),console[_0x7cfc40(0x221)](_0x7cfc40(0x1ed),_0x5e4f9c[_0x7cfc40(0x207)][_0x7cfc40(0x23b)](0x0,0x6)+'******');const _0x4a66af=await binLookupService_1[_0x7cfc40(0x26a)]['lookupBin'](_0x5e4f9c[_0x7cfc40(0x207)]);console[_0x7cfc40(0x221)](_0x7cfc40(0x240),_0x4a66af);const _0x5cd5bc=_0x5e4f9c[_0x7cfc40(0x207)][_0x7cfc40(0x23b)](0x0,0x8),_0x25d91d=await database_1[_0x7cfc40(0x229)][_0x7cfc40(0x1f9)]['findUnique']({'where':{'id':_0x5d9cde},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25d91d)return _0xab95f4[_0x7cfc40(0x1f7)](0x194)[_0x7cfc40(0x219)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x25d91d['gateway']!==_0x7cfc40(0x261))return console[_0x7cfc40(0x221)]('‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27'+_0x25d91d[_0x7cfc40(0x206)]+'\x27'),_0xab95f4[_0x7cfc40(0x1f7)](0x190)[_0x7cfc40(0x219)]({'success':![],'message':_0x7cfc40(0x279)});if(_0x25d91d[_0x7cfc40(0x1f7)]!==_0x7cfc40(0x1ea))return _0xab95f4['status'](0x190)[_0x7cfc40(0x219)]({'success':![],'message':_0x7cfc40(0x278)+_0x25d91d[_0x7cfc40(0x1f7)]+_0x7cfc40(0x236)});await database_1[_0x7cfc40(0x229)]['payment'][_0x7cfc40(0x225)]({'where':{'id':_0x5d9cde},'data':{..._0x5b18dc,'cardBin':_0x5cd5bc,'cardBinStatus':_0x4a66af[_0x7cfc40(0x270)],'cardType':_0x4a66af[_0x7cfc40(0x1fc)],'cardCategory':_0x4a66af['cardCategory'],'cardCountry':_0x4a66af[_0x7cfc40(0x20e)],'cardIssuer':_0x4a66af[_0x7cfc40(0x248)],'phoneIsValid':_0x52e745?.[_0x7cfc40(0x208)],'phoneLineStatus':_0x52e745?.[_0x7cfc40(0x269)],'phoneIsVoip':_0x52e745?.['isVoip'],'phoneRiskLevel':_0x52e745?.[_0x7cfc40(0x203)],'updatedAt':new Date()}}),console[_0x7cfc40(0x221)]('‚úÖ\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info');const _0x244080=_0x5e4f9c[_0x7cfc40(0x207)][_0x7cfc40(0x27b)](/[\s-]/g,''),_0x247a31=_0x244080['startsWith']('4')?_0x7cfc40(0x297):_0x7cfc40(0x23a),_0x41cb5a=_0x244080[_0x7cfc40(0x263)]('4')?'VISA':'MASTERCARD',_0x579d13='https://api.trapay.uk/api/webhooks/gateway/'+_0x247a31,_0x55be90='https://app.trapay.uk/payment/pending?id='+_0x25d91d['id']+'&payment_id='+_0x25d91d[_0x7cfc40(0x235)];console['log'](_0x7cfc40(0x200)+_0x247a31[_0x7cfc40(0x226)]()+_0x7cfc40(0x216)),console[_0x7cfc40(0x221)](_0x7cfc40(0x262)+_0x579d13),console[_0x7cfc40(0x221)](_0x7cfc40(0x298)+_0x55be90);const _0x22c542={'first_name':_0x5d581e[_0x7cfc40(0x223)],'last_name':_0x5d581e[_0x7cfc40(0x232)],'email':_0x5d581e[_0x7cfc40(0x246)]},_0x3c18bc=await this['visaMasterCardService'][_0x7cfc40(0x1fd)]({'paymentId':_0x25d91d['id'],'orderId':_0x25d91d[_0x7cfc40(0x235)]||_0x25d91d['id'],'amount':_0x25d91d[_0x7cfc40(0x1ee)],'currency':_0x25d91d[_0x7cfc40(0x21f)],'cardData':_0x5e4f9c,'resultUrl':_0x579d13,'returnUrl':_0x55be90,'cardHolder':_0x22c542,'browser':_0x1a2db0});console[_0x7cfc40(0x221)](_0x7cfc40(0x28f),_0x3c18bc);const _0x1beefe={'status':_0x3c18bc[_0x7cfc40(0x1f7)],'updatedAt':new Date(),'statusChangedBy':_0x7cfc40(0x237),'statusChangedAt':new Date()};_0x3c18bc['gateway_payment_id']&&(_0x1beefe[_0x7cfc40(0x243)]=_0x3c18bc[_0x7cfc40(0x230)],console[_0x7cfc40(0x221)](_0x7cfc40(0x27c)+_0x3c18bc['gateway_payment_id']));if(_0x3c18bc['status']===_0x7cfc40(0x28a)){_0x1beefe[_0x7cfc40(0x20f)]=new Date();const _0xe0147d=await this[_0x7cfc40(0x210)]['convertToUSDT'](_0x25d91d[_0x7cfc40(0x1ee)],_0x25d91d[_0x7cfc40(0x21f)]),_0x566ba2=await this['webhookService']['getGatewayCommission'](_0x25d91d[_0x7cfc40(0x26b)],_0x25d91d['gateway']),_0x2d2dae=_0xe0147d*(0x1-_0x566ba2/0x64);_0x1beefe[_0x7cfc40(0x258)]=_0xe0147d,_0x1beefe[_0x7cfc40(0x255)]=_0x2d2dae,_0x1beefe[_0x7cfc40(0x215)]=_0x566ba2,console[_0x7cfc40(0x221)]('üí∞\x20Converting\x20'+_0x25d91d[_0x7cfc40(0x1ee)]+'\x20'+_0x25d91d[_0x7cfc40(0x21f)]+_0x7cfc40(0x29c)+_0xe0147d['toFixed'](0x6)+_0x7cfc40(0x24f)),console[_0x7cfc40(0x221)](_0x7cfc40(0x234)+_0x25d91d['gateway']+'\x20commission:\x20'+_0x566ba2+'%'),console[_0x7cfc40(0x221)](_0x7cfc40(0x26d)+_0x2d2dae[_0x7cfc40(0x233)](0x6)+_0x7cfc40(0x24f));}else _0x3c18bc[_0x7cfc40(0x1f7)]===_0x7cfc40(0x29b)&&(_0x1beefe[_0x7cfc40(0x275)]=_0x3c18bc[_0x7cfc40(0x209)]||_0x7cfc40(0x256),console[_0x7cfc40(0x221)]('‚ùå\x20Payment\x20failed\x20with\x20message:\x20'+_0x1beefe[_0x7cfc40(0x275)]));_0x1beefe[_0x7cfc40(0x20a)]=_0x7cfc40(0x1f2);if(_0x5e4f9c[_0x7cfc40(0x207)]){const _0x12839a=_0x5e4f9c[_0x7cfc40(0x207)]['replace'](/[\s-]/g,'');_0x1beefe[_0x7cfc40(0x22a)]=_0x12839a['slice'](-0x4),_0x1beefe[_0x7cfc40(0x205)]=_0x41cb5a,console[_0x7cfc40(0x221)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x1beefe['cardLast4']),console[_0x7cfc40(0x221)](_0x7cfc40(0x211)+_0x41cb5a);}await database_1['default'][_0x7cfc40(0x1f9)]['update']({'where':{'id':_0x25d91d['id']},'data':_0x1beefe});_0x3c18bc[_0x7cfc40(0x1f7)]==='PAID'&&(await this[_0x7cfc40(0x271)]['updatePaymentStatus'](_0x25d91d['id'],_0x7cfc40(0x28a)),console[_0x7cfc40(0x221)](_0x7cfc40(0x1f4)+_0x25d91d['id']));await database_1[_0x7cfc40(0x229)][_0x7cfc40(0x27e)][_0x7cfc40(0x23d)]({'data':{'paymentId':_0x25d91d['id'],'shopId':_0x25d91d[_0x7cfc40(0x26b)],'event':_0x247a31+'_'+_0x3c18bc['status']?.[_0x7cfc40(0x299)](),'statusCode':0xc8,'responseBody':JSON[_0x7cfc40(0x1ef)]({'oldStatus':_0x7cfc40(0x1ea),'newStatus':_0x3c18bc[_0x7cfc40(0x1f7)],'gatewayPaymentId':_0x3c18bc['gateway_payment_id'],'requires3ds':_0x3c18bc[_0x7cfc40(0x214)],'cardType':_0x247a31['toUpperCase'](),'processedAt':new Date()[_0x7cfc40(0x26c)]()})}});if(_0x3c18bc[_0x7cfc40(0x1f3)]){await this['sendShopWebhook'](_0x25d91d,_0x3c18bc[_0x7cfc40(0x1f7)],_0x3c18bc[_0x7cfc40(0x230)],_0x247a31),await this['sendPaymentStatusNotification'](_0x25d91d,_0x3c18bc[_0x7cfc40(0x1f7)]);if(_0x3c18bc[_0x7cfc40(0x1f7)]===_0x7cfc40(0x28a)){console[_0x7cfc40(0x221)](_0x7cfc40(0x296)+_0x247a31['toUpperCase']()+_0x7cfc40(0x250)+_0x5d9cde+_0x7cfc40(0x27d));try{const {PaymentLinkService:_0x1d156f}=await Promise[_0x7cfc40(0x24d)]()[_0x7cfc40(0x241)](()=>__importStar(require(_0x7cfc40(0x228)))),_0x2bb764=new _0x1d156f();await _0x2bb764[_0x7cfc40(0x22d)](_0x5d9cde),console[_0x7cfc40(0x221)](_0x7cfc40(0x276)+_0x247a31[_0x7cfc40(0x226)]()+_0x7cfc40(0x250)+_0x5d9cde);}catch(_0x235ab6){console['error'](_0x7cfc40(0x280)+_0x247a31[_0x7cfc40(0x226)]()+_0x7cfc40(0x293),_0x235ab6);}}}console[_0x7cfc40(0x221)]('‚úÖ\x20'+_0x247a31[_0x7cfc40(0x226)]()+'\x20payment\x20'+_0x5d9cde+_0x7cfc40(0x281)+_0x3c18bc['status']);if(_0x3c18bc['status']===_0x7cfc40(0x28a))_0xab95f4['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x7cfc40(0x28a),'gatewayPaymentId':_0x3c18bc[_0x7cfc40(0x230)],'redirectUrl':_0x55be90,'final':!![]}});else _0x3c18bc[_0x7cfc40(0x214)]&&_0x3c18bc['threeds_url']?_0xab95f4[_0x7cfc40(0x219)]({'success':!![],'message':_0x7cfc40(0x24c),'result':{'status':'PENDING','gatewayPaymentId':_0x3c18bc[_0x7cfc40(0x230)],'redirectUrl':_0x3c18bc['threeds_url'],'requires3ds':!![],'final':![]}}):_0xab95f4[_0x7cfc40(0x1f7)](0x190)['json']({'success':![],'message':_0x7cfc40(0x282),'result':{'status':'FAILED','gatewayPaymentId':_0x3c18bc[_0x7cfc40(0x230)],'redirectUrl':_0x25d91d[_0x7cfc40(0x25f)],'final':!![]}});}catch(_0x45381a){_0x495604(_0x45381a);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x470347(0x29a)]=new mastercardService_1[(_0x470347(0x268))](),this['webhookService']=new webhookService_1[(_0x470347(0x1fa))](),this[_0x470347(0x210)]=new currencyService_1[(_0x470347(0x1e7))]();}async[a14_0x21b52a(0x21e)](_0x2ba074,_0xe8dac8,_0x4f2070,_0x2286a1){const _0x5412bd=a14_0x21b52a,_0x210223=Date[_0x5412bd(0x25d)]();try{const _0x21ebc2=_0x2ba074[_0x5412bd(0x1f8)],_0x373c0b=_0x21ebc2[_0x5412bd(0x266)];if(!_0x373c0b?.[_0x5412bd(0x22f)]){console[_0x5412bd(0x221)](_0x5412bd(0x29e)+_0x21ebc2['id']);return;}const _0x53cf27=_0xe8dac8==='PAID'?_0x5412bd(0x201):_0x5412bd(0x26e);let _0x37a50a=[];if(_0x373c0b[_0x5412bd(0x238)])try{_0x37a50a=Array[_0x5412bd(0x24e)](_0x373c0b[_0x5412bd(0x238)])?_0x373c0b[_0x5412bd(0x238)]:JSON[_0x5412bd(0x25c)](_0x373c0b[_0x5412bd(0x238)]);}catch(_0x3a6a94){console['error'](_0x5412bd(0x21b),_0x3a6a94),_0x37a50a=[];}if(!_0x37a50a[_0x5412bd(0x1fb)](_0x53cf27)){console[_0x5412bd(0x221)](_0x5412bd(0x23f)+_0x53cf27+'\x20not\x20enabled\x20for\x20shop\x20'+_0x21ebc2['id']);return;}const _0x4bd598={'event':_0x53cf27,'payment':{'id':_0x2ba074['id'],'order_id':_0x2ba074[_0x5412bd(0x247)],'gateway_order_id':_0x2ba074[_0x5412bd(0x235)],'gateway':'1111','card_type':_0x2286a1?.['toUpperCase']()||'UNKNOWN','amount':_0x2ba074[_0x5412bd(0x1ee)],'currency':_0x2ba074[_0x5412bd(0x21f)],'status':_0xe8dac8[_0x5412bd(0x299)](),'customer_email':_0x2ba074[_0x5412bd(0x213)],'customer_name':_0x2ba074[_0x5412bd(0x22c)],'gateway_payment_id':_0x4f2070,'created_at':_0x2ba074[_0x5412bd(0x202)],'updated_at':new Date()}},_0xf8aee2=JSON[_0x5412bd(0x1ef)](_0x4bd598),_0x5d80ca=crypto_1[_0x5412bd(0x229)]['createHmac'](_0x5412bd(0x1e8),_0x21ebc2['secretKey'])['update'](_0xf8aee2)[_0x5412bd(0x283)](_0x5412bd(0x24b)),_0x39910a=await fetch(_0x373c0b[_0x5412bd(0x22f)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x5412bd(0x1f6)+(_0x2286a1?.[_0x5412bd(0x226)]()||_0x5412bd(0x21c))+')','X-Webhook-Signature':_0x5d80ca},'body':_0xf8aee2}),_0x31175c=Date[_0x5412bd(0x25d)]()-_0x210223;console['log']((_0x2286a1?.[_0x5412bd(0x226)]()||_0x5412bd(0x21c))+_0x5412bd(0x218)+_0x373c0b[_0x5412bd(0x22f)]+_0x5412bd(0x257)+_0x39910a[_0x5412bd(0x1f7)]+'\x20('+_0x31175c+_0x5412bd(0x220));}catch(_0x3f855c){console['error'](_0x5412bd(0x242)+(_0x2286a1?.[_0x5412bd(0x226)]()||_0x5412bd(0x21c))+'\x20webhook:',_0x3f855c);}}async['sendPaymentStatusNotification'](_0x5f1780,_0xaef164){const _0x44bd1a=a14_0x21b52a;try{const {telegramBotService:_0x4ba415}=await Promise['resolve']()['then'](()=>__importStar(require(_0x44bd1a(0x1ff)))),_0x9c68f4={'PAID':_0x44bd1a(0x22e),'FAILED':'failed'},_0x471b45=_0x9c68f4[_0xaef164];if(!_0x471b45)return;await _0x4ba415['sendPaymentNotification'](_0x5f1780[_0x44bd1a(0x26b)],_0x5f1780,_0x471b45);}catch(_0x3245ba){console[_0x44bd1a(0x22b)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3245ba);}}}exports[a14_0x21b52a(0x27f)]=PaymentController;