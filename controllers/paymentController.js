'use strict';const a8_0x2c6537=a8_0x379f;(function(_0x254cda,_0x51823c){const _0x50628a=a8_0x379f,_0x27cf7e=_0x254cda();while(!![]){try{const _0x359926=parseInt(_0x50628a(0x18a))/0x1+-parseInt(_0x50628a(0x11c))/0x2+parseInt(_0x50628a(0x16a))/0x3+parseInt(_0x50628a(0x176))/0x4*(parseInt(_0x50628a(0x12b))/0x5)+-parseInt(_0x50628a(0x17c))/0x6*(parseInt(_0x50628a(0x161))/0x7)+parseInt(_0x50628a(0x113))/0x8*(-parseInt(_0x50628a(0x120))/0x9)+parseInt(_0x50628a(0x169))/0xa*(-parseInt(_0x50628a(0x137))/0xb);if(_0x359926===_0x51823c)break;else _0x27cf7e['push'](_0x27cf7e['shift']());}catch(_0x1d287c){_0x27cf7e['push'](_0x27cf7e['shift']());}}}(a8_0x4fbc,0x94e8b));var __createBinding=this&&this[a8_0x2c6537(0x153)]||(Object[a8_0x2c6537(0x135)]?function(_0x291d90,_0x49e017,_0x3e583e,_0x2181ca){const _0x2f925f=a8_0x2c6537;if(_0x2181ca===undefined)_0x2181ca=_0x3e583e;var _0x294d7e=Object[_0x2f925f(0x175)](_0x49e017,_0x3e583e);(!_0x294d7e||(_0x2f925f(0x11d)in _0x294d7e?!_0x49e017['__esModule']:_0x294d7e[_0x2f925f(0x126)]||_0x294d7e['configurable']))&&(_0x294d7e={'enumerable':!![],'get':function(){return _0x49e017[_0x3e583e];}}),Object[_0x2f925f(0x14b)](_0x291d90,_0x2181ca,_0x294d7e);}:function(_0x9c262e,_0x2d7ed7,_0x3b6a29,_0x596b6f){if(_0x596b6f===undefined)_0x596b6f=_0x3b6a29;_0x9c262e[_0x596b6f]=_0x2d7ed7[_0x3b6a29];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x2c6537(0x135)]?function(_0x3298d3,_0xecc2b3){const _0x3c93d7=a8_0x2c6537;Object['defineProperty'](_0x3298d3,_0x3c93d7(0x148),{'enumerable':!![],'value':_0xecc2b3});}:function(_0x284705,_0x52e521){_0x284705['default']=_0x52e521;}),__importStar=this&&this[a8_0x2c6537(0x17d)]||(function(){var _0x139030=function(_0x595a50){const _0x496f96=a8_0x379f;return _0x139030=Object[_0x496f96(0x10c)]||function(_0x4b30c8){const _0x4eabb3=_0x496f96;var _0x469918=[];for(var _0x3e7b60 in _0x4b30c8)if(Object[_0x4eabb3(0x14c)]['hasOwnProperty'][_0x4eabb3(0x160)](_0x4b30c8,_0x3e7b60))_0x469918[_0x469918[_0x4eabb3(0x15a)]]=_0x3e7b60;return _0x469918;},_0x139030(_0x595a50);};return function(_0x59dfbb){const _0x47e1cd=a8_0x379f;if(_0x59dfbb&&_0x59dfbb['__esModule'])return _0x59dfbb;var _0x21d2ad={};if(_0x59dfbb!=null){for(var _0x4b4c1c=_0x139030(_0x59dfbb),_0x378445=0x0;_0x378445<_0x4b4c1c[_0x47e1cd(0x15a)];_0x378445++)if(_0x4b4c1c[_0x378445]!==_0x47e1cd(0x148))__createBinding(_0x21d2ad,_0x59dfbb,_0x4b4c1c[_0x378445]);}return __setModuleDefault(_0x21d2ad,_0x59dfbb),_0x21d2ad;};}()),__importDefault=this&&this[a8_0x2c6537(0x13e)]||function(_0x2ab179){const _0x3ea724=a8_0x2c6537;return _0x2ab179&&_0x2ab179[_0x3ea724(0x156)]?_0x2ab179:{'default':_0x2ab179};};Object[a8_0x2c6537(0x14b)](exports,a8_0x2c6537(0x156),{'value':!![]}),exports[a8_0x2c6537(0x121)]=void 0x0;function a8_0x379f(_0x5d21e5,_0x1d8b9a){const _0x4fbc74=a8_0x4fbc();return a8_0x379f=function(_0x379f2e,_0x54334a){_0x379f2e=_0x379f2e-0x10a;let _0xca6025=_0x4fbc74[_0x379f2e];return _0xca6025;},a8_0x379f(_0x5d21e5,_0x1d8b9a);}function a8_0x4fbc(){const _0x4dfdd5=['__createBinding','../services/telegramBotService','\x20processed:\x20','__esModule','../services/webhookService','findUnique','Card\x20payment\x20failed','length','handleSuccessfulPayment','resolve','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','💳\x20Browser\x20IP:\x20','log','call','292061wnzetO','paymentService','email','📈\x20MasterCard\x20payment\x20','customerUa','gatewayPaymentId','PENDING','https://api.trapay.uk/api/webhooks/gateway/mastercard','441430tPswTF','2868918ugSMTX','💳\x20Processing\x20MasterCard\x20payment:\x20','failureMessage','orderId','currency','paymentMethod','toLowerCase','../config/database','json','Webhook\x20event\x20','customerCountry','getOwnPropertyDescriptor','20ELxbTx','createPublicPayment','MasterCardService','📝\x20Customer\x20data:','PAID','Customer\x20data\x20updated\x20successfully','162rYWEBB','__importStar','Payment\x20not\x20found','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20status\x20is\x20','updatePaymentCustomer','then','Error\x20parsing\x20webhook\x20events:','💳\x20MasterCard\x20URLs:','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','processCardPayment','replace','sendPaymentNotification','sendPaymentStatusNotification','953795UoGnUE','stringify','../services/gateways/mastercardService','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20',',\x20cannot\x20process','successUrl','getOwnPropertyNames','final','isArray','../services/paymentLinkService','WebhookService','shopId','parse','72056fwXRqk','now','params','FAILED','Payment\x20created\x20successfully','gateway_payment_id','first_name','Failed\x20to\x20send\x20MasterCard\x20webhook:','masterCardService','350596xZCaqr','get','../services/paymentService','threeds_url','297gIECeO','PaymentController','mastercard_','error','user_agent','shop','writable','updatedAt','💳\x20Card\x20holder:\x20','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','customerName','519595TCvHBL','\x20with\x20status\x20','paid','amount','update','body','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','payment','payment.success','Payment\x20failed','create','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','55RmDCaA','POST','processMasterCardPayment','gateway','✅\x20MasterCard\x20payment\x20','webhookUrl','gatewayOrderId','__importDefault','webhookEvents','customerEmail','ms)','webhookService','sendShopWebhook','\x20\x20\x20Result\x20URL\x20(webhook):\x20','updatePaymentCustomerDataPublic','cardLast4','1111','default','last_name','status','defineProperty','prototype','number','getPaymentStatus','slice','mastercard','application/json','getPaymentById'];a8_0x4fbc=function(){return _0x4dfdd5;};return a8_0x4fbc();}const paymentService_1=require(a8_0x2c6537(0x11e)),mastercardService_1=require(a8_0x2c6537(0x18c)),webhookService_1=require(a8_0x2c6537(0x157)),database_1=__importDefault(require(a8_0x2c6537(0x171)));class PaymentController{constructor(){const _0x1f4793=a8_0x2c6537;this[_0x1f4793(0x177)]=async(_0x41a7e6,_0x553eca,_0x4b3da2)=>{const _0x2d3c02=_0x1f4793;try{const _0x579fc0=_0x41a7e6['body'],_0x36c75d=await this[_0x2d3c02(0x162)][_0x2d3c02(0x177)](_0x579fc0);_0x553eca[_0x2d3c02(0x14a)](0xc9)[_0x2d3c02(0x172)]({'success':!![],'message':_0x2d3c02(0x117),'result':_0x36c75d});}catch(_0x15f667){_0x4b3da2(_0x15f667);}},this['getPaymentStatus']=async(_0x7455c4,_0x3b8d8b,_0x34dffa)=>{const _0x42e99f=_0x1f4793;try{const {id:_0x5002bd}=_0x7455c4[_0x42e99f(0x115)],_0x2f20ea=await this[_0x42e99f(0x162)][_0x42e99f(0x14e)](_0x5002bd);if(!_0x2f20ea)return _0x3b8d8b['status'](0x194)[_0x42e99f(0x172)]({'success':![],'message':_0x42e99f(0x17e)});_0x3b8d8b[_0x42e99f(0x172)]({'success':!![],'result':_0x2f20ea});}catch(_0x2e5744){_0x34dffa(_0x2e5744);}},this[_0x1f4793(0x152)]=async(_0x4ad683,_0x465631,_0x3ae26c)=>{const _0x39c53c=_0x1f4793;try{const {id:_0x364dc7}=_0x4ad683[_0x39c53c(0x115)],_0x4ff163=await this['paymentService']['getPaymentById'](_0x364dc7);if(!_0x4ff163)return _0x465631[_0x39c53c(0x14a)](0x194)[_0x39c53c(0x172)]({'success':![],'message':_0x39c53c(0x17e)});_0x465631[_0x39c53c(0x172)]({'success':!![],'result':_0x4ff163});}catch(_0x8b4725){_0x3ae26c(_0x8b4725);}},this[_0x1f4793(0x181)]=async(_0x3aa9d4,_0x7c1bf,_0x28eccb)=>{const _0x194c51=_0x1f4793;try{const {id:_0x5a4157}=_0x3aa9d4['params'],_0x59202f=_0x3aa9d4[_0x194c51(0x130)];console['log'](_0x194c51(0x185)+_0x5a4157),console['log'](_0x194c51(0x179),_0x59202f);const _0x527c7c=await this[_0x194c51(0x162)][_0x194c51(0x145)](_0x5a4157,_0x59202f);if(!_0x527c7c)return _0x7c1bf['status'](0x194)[_0x194c51(0x172)]({'success':![],'message':_0x194c51(0x17e)});_0x7c1bf[_0x194c51(0x172)]({'success':!![],'message':_0x194c51(0x17b),'result':{'paymentId':_0x527c7c['id'],'customerIp':_0x527c7c['customerIp'],'customerUa':_0x527c7c[_0x194c51(0x165)],'customerCountry':_0x527c7c[_0x194c51(0x174)],'updatedAt':_0x527c7c[_0x194c51(0x127)]}});}catch(_0x1b05c7){_0x28eccb(_0x1b05c7);}},this[_0x1f4793(0x139)]=async(_0x30002c,_0x38f323,_0x751f0b)=>{const _0x519db3=_0x1f4793;try{const {id:_0x5b387b}=_0x30002c[_0x519db3(0x115)],{cardData:_0x2e227c,cardHolder:_0x43d07c,browser:_0xaca099}=_0x30002c[_0x519db3(0x130)];console[_0x519db3(0x15f)](_0x519db3(0x16b)+_0x5b387b),console[_0x519db3(0x15f)](_0x519db3(0x128)+_0x43d07c[_0x519db3(0x119)]+'\x20'+_0x43d07c[_0x519db3(0x149)]+'\x20('+_0x43d07c['email']+')'),console[_0x519db3(0x15f)](_0x519db3(0x15e)+_0xaca099['ip']);const _0x264e5e={'customerName':_0x43d07c[_0x519db3(0x119)]+'\x20'+_0x43d07c[_0x519db3(0x149)],'customerEmail':_0x43d07c['email'],'customerIp':_0xaca099['ip'],'customerUa':_0xaca099[_0x519db3(0x124)]},_0x509593=await database_1[_0x519db3(0x148)][_0x519db3(0x132)][_0x519db3(0x158)]({'where':{'id':_0x5b387b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x509593)return _0x38f323['status'](0x194)[_0x519db3(0x172)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x509593[_0x519db3(0x13a)]!==_0x519db3(0x150))return _0x38f323[_0x519db3(0x14a)](0x190)[_0x519db3(0x172)]({'success':![],'message':_0x519db3(0x129)});if(_0x509593['status']!==_0x519db3(0x167))return _0x38f323[_0x519db3(0x14a)](0x190)[_0x519db3(0x172)]({'success':![],'message':_0x519db3(0x180)+_0x509593['status']+_0x519db3(0x10a)});await database_1[_0x519db3(0x148)]['payment'][_0x519db3(0x12f)]({'where':{'id':_0x5b387b},'data':{..._0x264e5e,'updatedAt':new Date()}});const _0x42ab67=_0x519db3(0x168),_0x51b123=_0x509593[_0x519db3(0x10b)];console[_0x519db3(0x15f)](_0x519db3(0x184)),console[_0x519db3(0x15f)](_0x519db3(0x144)+_0x42ab67),console[_0x519db3(0x15f)]('\x20\x20\x20Return\x20URL:\x20'+_0x51b123);const _0x1f86c3={'first_name':_0x43d07c[_0x519db3(0x119)],'last_name':_0x43d07c[_0x519db3(0x149)],'email':_0x43d07c[_0x519db3(0x163)]},_0x4f225d=await this[_0x519db3(0x11b)][_0x519db3(0x186)]({'paymentId':_0x509593['id'],'orderId':_0x509593[_0x519db3(0x13d)]||_0x509593['id'],'amount':_0x509593[_0x519db3(0x12e)],'currency':_0x509593[_0x519db3(0x16e)],'cardData':_0x2e227c,'resultUrl':_0x42ab67,'returnUrl':_0x51b123,'cardHolder':_0x1f86c3,'browser':_0xaca099});console[_0x519db3(0x15f)]('💳\x20MasterCard\x20result:',_0x4f225d);const _0x433dfc={'status':_0x4f225d['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4f225d[_0x519db3(0x118)]&&(_0x433dfc[_0x519db3(0x166)]=_0x4f225d[_0x519db3(0x118)],console[_0x519db3(0x15f)](_0x519db3(0x18d)+_0x4f225d['gateway_payment_id']));if(_0x4f225d[_0x519db3(0x14a)]===_0x519db3(0x17a))_0x433dfc['paidAt']=new Date();else _0x4f225d['status']===_0x519db3(0x116)&&(_0x433dfc[_0x519db3(0x16c)]=_0x519db3(0x159));_0x433dfc[_0x519db3(0x16f)]=_0x519db3(0x150);if(_0x2e227c[_0x519db3(0x14d)]){const _0x5be6bf=_0x2e227c[_0x519db3(0x14d)][_0x519db3(0x187)](/[\s-]/g,'');_0x433dfc[_0x519db3(0x146)]=_0x5be6bf[_0x519db3(0x14f)](-0x4),console[_0x519db3(0x15f)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x433dfc[_0x519db3(0x146)]);}await database_1[_0x519db3(0x148)]['payment'][_0x519db3(0x12f)]({'where':{'id':_0x509593['id']},'data':_0x433dfc}),await database_1[_0x519db3(0x148)]['webhookLog'][_0x519db3(0x135)]({'data':{'paymentId':_0x509593['id'],'shopId':_0x509593[_0x519db3(0x111)],'event':_0x519db3(0x122)+_0x4f225d['status']?.[_0x519db3(0x170)](),'statusCode':0xc8,'responseBody':JSON[_0x519db3(0x18b)]({'oldStatus':'PENDING','newStatus':_0x4f225d['status'],'gatewayPaymentId':_0x4f225d['gateway_payment_id'],'requires3ds':_0x4f225d['requires_3ds'],'processedAt':new Date()['toISOString']()})}});if(_0x4f225d[_0x519db3(0x10d)]){await this[_0x519db3(0x143)](_0x509593,_0x4f225d['status'],_0x4f225d[_0x519db3(0x118)]),await this[_0x519db3(0x189)](_0x509593,_0x4f225d[_0x519db3(0x14a)]);if(_0x4f225d[_0x519db3(0x14a)]==='PAID'){console[_0x519db3(0x15f)](_0x519db3(0x164)+_0x5b387b+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x179229}=await Promise[_0x519db3(0x15c)]()[_0x519db3(0x182)](()=>__importStar(require(_0x519db3(0x10f)))),_0xc88e83=new _0x179229();await _0xc88e83[_0x519db3(0x15b)](_0x5b387b),console[_0x519db3(0x15f)](_0x519db3(0x131)+_0x5b387b);}catch(_0x5aa7fa){console[_0x519db3(0x123)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x5aa7fa);}}}console[_0x519db3(0x15f)](_0x519db3(0x13b)+_0x5b387b+_0x519db3(0x155)+_0x4f225d[_0x519db3(0x14a)]);if(_0x4f225d[_0x519db3(0x14a)]===_0x519db3(0x17a))_0x38f323[_0x519db3(0x172)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x519db3(0x17a),'gatewayPaymentId':_0x4f225d['gateway_payment_id'],'redirectUrl':_0x51b123,'final':!![]}});else _0x4f225d['requires_3ds']&&_0x4f225d['threeds_url']?_0x38f323[_0x519db3(0x172)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x4f225d[_0x519db3(0x118)],'redirectUrl':_0x4f225d[_0x519db3(0x11f)],'requires3ds':!![],'final':![]}}):_0x38f323[_0x519db3(0x14a)](0x190)[_0x519db3(0x172)]({'success':![],'message':_0x519db3(0x134),'result':{'status':_0x519db3(0x116),'gatewayPaymentId':_0x4f225d['gateway_payment_id'],'redirectUrl':_0x509593['failUrl'],'final':!![]}});}catch(_0x32d9be){_0x751f0b(_0x32d9be);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x1f4793(0x11b)]=new mastercardService_1[(_0x1f4793(0x178))](),this[_0x1f4793(0x142)]=new webhookService_1[(_0x1f4793(0x110))]();}async[a8_0x2c6537(0x143)](_0x581616,_0x306d4c,_0xf686be){const _0x1885e0=a8_0x2c6537,_0x3a18a5=Date[_0x1885e0(0x114)]();try{const _0x1ea7a8=_0x581616[_0x1885e0(0x125)],_0x5997b8=_0x1ea7a8['settings'];if(!_0x5997b8?.[_0x1885e0(0x13c)]){console['log'](_0x1885e0(0x136)+_0x1ea7a8['id']);return;}const _0x3bb44b=_0x306d4c===_0x1885e0(0x17a)?_0x1885e0(0x133):'payment.failed';let _0x21cec5=[];if(_0x5997b8['webhookEvents'])try{_0x21cec5=Array[_0x1885e0(0x10e)](_0x5997b8[_0x1885e0(0x13f)])?_0x5997b8[_0x1885e0(0x13f)]:JSON[_0x1885e0(0x112)](_0x5997b8['webhookEvents']);}catch(_0x503ebf){console[_0x1885e0(0x123)](_0x1885e0(0x183),_0x503ebf),_0x21cec5=[];}if(!_0x21cec5['includes'](_0x3bb44b)){console[_0x1885e0(0x15f)](_0x1885e0(0x173)+_0x3bb44b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x1ea7a8['id']);return;}const _0x2db973={'event':_0x3bb44b,'payment':{'id':_0x581616['id'],'order_id':_0x581616[_0x1885e0(0x16d)],'gateway_order_id':_0x581616[_0x1885e0(0x13d)],'gateway':_0x1885e0(0x147),'amount':_0x581616[_0x1885e0(0x12e)],'currency':_0x581616[_0x1885e0(0x16e)],'status':_0x306d4c[_0x1885e0(0x170)](),'customer_email':_0x581616[_0x1885e0(0x140)],'customer_name':_0x581616[_0x1885e0(0x12a)],'gateway_payment_id':_0xf686be,'created_at':_0x581616['createdAt'],'updated_at':new Date()}},_0x4de815=await fetch(_0x5997b8[_0x1885e0(0x13c)],{'method':_0x1885e0(0x138),'headers':{'Content-Type':_0x1885e0(0x151),'User-Agent':_0x1885e0(0x15d)},'body':JSON[_0x1885e0(0x18b)](_0x2db973)}),_0x1e2431=Date[_0x1885e0(0x114)]()-_0x3a18a5;console[_0x1885e0(0x15f)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5997b8[_0x1885e0(0x13c)]+_0x1885e0(0x12c)+_0x4de815[_0x1885e0(0x14a)]+'\x20('+_0x1e2431+_0x1885e0(0x141));}catch(_0x3c5530){console[_0x1885e0(0x123)](_0x1885e0(0x11a),_0x3c5530);}}async[a8_0x2c6537(0x189)](_0x277eb4,_0x28ffb6){const _0x18cb6c=a8_0x2c6537;try{const {telegramBotService:_0x4070bf}=await Promise[_0x18cb6c(0x15c)]()[_0x18cb6c(0x182)](()=>__importStar(require(_0x18cb6c(0x154)))),_0x54c996={'PAID':_0x18cb6c(0x12d),'FAILED':'failed'},_0x4c4aad=_0x54c996[_0x28ffb6];if(!_0x4c4aad)return;await _0x4070bf[_0x18cb6c(0x188)](_0x277eb4['shopId'],_0x277eb4,_0x4c4aad);}catch(_0x79a4fa){console[_0x18cb6c(0x123)](_0x18cb6c(0x17f),_0x79a4fa);}}}exports[a8_0x2c6537(0x121)]=PaymentController;