'use strict';const a14_0x4cadb8=a14_0x3c3f;(function(_0x11eb0b,_0x8327ab){const _0x28d5a8=a14_0x3c3f,_0x22660d=_0x11eb0b();while(!![]){try{const _0x984fc4=-parseInt(_0x28d5a8(0x23d))/0x1*(-parseInt(_0x28d5a8(0x1a2))/0x2)+-parseInt(_0x28d5a8(0x1d9))/0x3+parseInt(_0x28d5a8(0x219))/0x4+-parseInt(_0x28d5a8(0x1e8))/0x5*(parseInt(_0x28d5a8(0x1fc))/0x6)+-parseInt(_0x28d5a8(0x21b))/0x7+-parseInt(_0x28d5a8(0x206))/0x8+parseInt(_0x28d5a8(0x1c8))/0x9;if(_0x984fc4===_0x8327ab)break;else _0x22660d['push'](_0x22660d['shift']());}catch(_0x1368a3){_0x22660d['push'](_0x22660d['shift']());}}}(a14_0x3e7c,0x5d451));var __createBinding=this&&this[a14_0x4cadb8(0x1c5)]||(Object[a14_0x4cadb8(0x1ff)]?function(_0x23892b,_0x194b7c,_0x480cb7,_0x1f60c6){const _0x1d892e=a14_0x4cadb8;if(_0x1f60c6===undefined)_0x1f60c6=_0x480cb7;var _0x10f0c9=Object[_0x1d892e(0x220)](_0x194b7c,_0x480cb7);(!_0x10f0c9||(_0x1d892e(0x1dc)in _0x10f0c9?!_0x194b7c[_0x1d892e(0x1a9)]:_0x10f0c9[_0x1d892e(0x1f9)]||_0x10f0c9[_0x1d892e(0x1b1)]))&&(_0x10f0c9={'enumerable':!![],'get':function(){return _0x194b7c[_0x480cb7];}}),Object[_0x1d892e(0x1ca)](_0x23892b,_0x1f60c6,_0x10f0c9);}:function(_0x5ad94c,_0x1e799b,_0x54c993,_0x150d46){if(_0x150d46===undefined)_0x150d46=_0x54c993;_0x5ad94c[_0x150d46]=_0x1e799b[_0x54c993];}),__setModuleDefault=this&&this[a14_0x4cadb8(0x1f1)]||(Object[a14_0x4cadb8(0x1ff)]?function(_0x1bcecc,_0x2eba64){const _0x2f2e4f=a14_0x4cadb8;Object['defineProperty'](_0x1bcecc,_0x2f2e4f(0x1ab),{'enumerable':!![],'value':_0x2eba64});}:function(_0x41b611,_0x26c2e3){_0x41b611['default']=_0x26c2e3;}),__importStar=this&&this[a14_0x4cadb8(0x258)]||(function(){var _0xf2eac3=function(_0x13dff0){const _0x6d61ee=a14_0x3c3f;return _0xf2eac3=Object[_0x6d61ee(0x1c6)]||function(_0x49a2c3){const _0x147c30=_0x6d61ee;var _0x3cf1fb=[];for(var _0x5ca409 in _0x49a2c3)if(Object[_0x147c30(0x1fd)][_0x147c30(0x203)]['call'](_0x49a2c3,_0x5ca409))_0x3cf1fb[_0x3cf1fb[_0x147c30(0x1aa)]]=_0x5ca409;return _0x3cf1fb;},_0xf2eac3(_0x13dff0);};return function(_0x29f283){const _0x6ff178=a14_0x3c3f;if(_0x29f283&&_0x29f283[_0x6ff178(0x1a9)])return _0x29f283;var _0x104525={};if(_0x29f283!=null){for(var _0x34c206=_0xf2eac3(_0x29f283),_0x4965d9=0x0;_0x4965d9<_0x34c206[_0x6ff178(0x1aa)];_0x4965d9++)if(_0x34c206[_0x4965d9]!==_0x6ff178(0x1ab))__createBinding(_0x104525,_0x29f283,_0x34c206[_0x4965d9]);}return __setModuleDefault(_0x104525,_0x29f283),_0x104525;};}()),__importDefault=this&&this[a14_0x4cadb8(0x1b9)]||function(_0x17af16){const _0x347f05=a14_0x4cadb8;return _0x17af16&&_0x17af16[_0x347f05(0x1a9)]?_0x17af16:{'default':_0x17af16};};function a14_0x3c3f(_0x3f4fcc,_0xf265c9){_0x3f4fcc=_0x3f4fcc-0x19e;const _0x3e7c79=a14_0x3e7c();let _0x3c3f68=_0x3e7c79[_0x3f4fcc];return _0x3c3f68;}Object[a14_0x4cadb8(0x1ca)](exports,a14_0x4cadb8(0x1a9),{'value':!![]}),exports[a14_0x4cadb8(0x1b2)]=void 0x0;const crypto_1=__importDefault(require(a14_0x4cadb8(0x20c))),paymentService_1=require(a14_0x4cadb8(0x1e5)),mastercardService_1=require(a14_0x4cadb8(0x21f)),webhookService_1=require(a14_0x4cadb8(0x205)),currencyService_1=require(a14_0x4cadb8(0x1fe)),binLookupService_1=require(a14_0x4cadb8(0x1f0)),database_1=__importDefault(require(a14_0x4cadb8(0x20e)));class PaymentController{constructor(){const _0x35a2bb=a14_0x4cadb8;this[_0x35a2bb(0x1cb)]=async(_0x155d81,_0x9755b3,_0x265451)=>{const _0x3649fc=_0x35a2bb;try{const _0x7f19f3=_0x155d81[_0x3649fc(0x1d4)],_0x107812=await this['paymentService']['createPublicPayment'](_0x7f19f3);_0x9755b3['status'](0xc9)[_0x3649fc(0x24f)]({'success':!![],'message':_0x3649fc(0x1da),'result':_0x107812});}catch(_0xde9ad4){_0x265451(_0xde9ad4);}},this['getPaymentStatus']=async(_0x278c6c,_0x5b2eca,_0x1a8aa1)=>{const _0x121356=_0x35a2bb;try{const {id:_0x58afa9}=_0x278c6c[_0x121356(0x229)],_0x5edab4=await this[_0x121356(0x24a)]['getPaymentStatus'](_0x58afa9);if(!_0x5edab4)return _0x5b2eca[_0x121356(0x232)](0x194)[_0x121356(0x24f)]({'success':![],'message':_0x121356(0x22f)});_0x5b2eca[_0x121356(0x24f)]({'success':!![],'result':_0x5edab4});}catch(_0x5dc98c){_0x1a8aa1(_0x5dc98c);}},this['getPaymentFingerprint']=async(_0x5407cf,_0xfb8486,_0x38533f)=>{const _0x34b202=_0x35a2bb;try{const {id:_0x1bb644}=_0x5407cf[_0x34b202(0x229)],{requestId:_0x26a9c6}=_0x5407cf[_0x34b202(0x222)];if(typeof _0x26a9c6!==_0x34b202(0x25b))return _0xfb8486['status'](0x190)['json']({'success':![],'message':_0x34b202(0x1cf)});console[_0x34b202(0x200)](_0x34b202(0x1e6)+_0x1bb644+_0x34b202(0x257)+_0x26a9c6);const _0x5b72ed=await this[_0x34b202(0x24a)][_0x34b202(0x21c)](_0x1bb644,_0x26a9c6);if(!_0x5b72ed)return _0xfb8486[_0x34b202(0x232)](0x194)['json']({'success':![],'message':_0x34b202(0x20f)});console[_0x34b202(0x200)](_0x34b202(0x246)+_0x1bb644+':',_0x5b72ed),_0xfb8486[_0x34b202(0x24f)]({'success':!![],'result':_0x5b72ed});}catch(_0x502ee6){_0x38533f(_0x502ee6);}},this[_0x35a2bb(0x1dd)]=async(_0x177367,_0x17b72d,_0xc3476f)=>{const _0x48c23c=_0x35a2bb;try{const {id:_0x1c01b1}=_0x177367[_0x48c23c(0x229)],_0x18d97a=await this[_0x48c23c(0x24a)][_0x48c23c(0x1dd)](_0x1c01b1);if(!_0x18d97a)return _0x17b72d[_0x48c23c(0x232)](0x194)[_0x48c23c(0x24f)]({'success':![],'message':_0x48c23c(0x22f)});_0x17b72d[_0x48c23c(0x24f)]({'success':!![],'result':_0x18d97a});}catch(_0x3a065e){_0xc3476f(_0x3a065e);}},this[_0x35a2bb(0x1f2)]=async(_0x482eeb,_0x1782ff,_0x4bfc14)=>{const _0x330fda=_0x35a2bb;try{const {id:_0x3ca52d}=_0x482eeb['params'],_0x1205d8=_0x482eeb[_0x330fda(0x1d4)];console[_0x330fda(0x200)](_0x330fda(0x1a6)+_0x3ca52d),console['log'](_0x330fda(0x24d),_0x1205d8);const _0x470bec=await this[_0x330fda(0x24a)]['updatePaymentCustomerDataPublic'](_0x3ca52d,_0x1205d8);if(!_0x470bec)return _0x1782ff['status'](0x194)[_0x330fda(0x24f)]({'success':![],'message':'Payment\x20not\x20found'});_0x1782ff['json']({'success':!![],'message':_0x330fda(0x202),'result':{'paymentId':_0x470bec['id'],'customerIp':_0x470bec[_0x330fda(0x234)],'customerUa':_0x470bec['customerUa'],'customerCountry':_0x470bec['customerCountry'],'updatedAt':_0x470bec['updatedAt']}});}catch(_0x1c2265){_0x4bfc14(_0x1c2265);}},this[_0x35a2bb(0x1d5)]=async(_0x499c5b,_0xb3ad35,_0x3097ee)=>{const _0x417944=_0x35a2bb;try{const {id:_0x563f0e}=_0x499c5b[_0x417944(0x229)],{cardData:_0x5d3af5,cardHolder:_0x59e848,browser:_0x3b6030,phoneValidation:_0x3bc3e2}=_0x499c5b[_0x417944(0x1d4)];console['log'](_0x417944(0x1ec)+_0x563f0e),console[_0x417944(0x200)](_0x417944(0x1b8)+_0x59e848['first_name']+'\x20'+_0x59e848[_0x417944(0x25e)]+'\x20('+_0x59e848[_0x417944(0x1fa)]+')'),console['log']('üí≥\x20Browser\x20IP:\x20'+_0x3b6030['ip']);const _0x4964aa=_0x59e848[_0x417944(0x1bf)]?.['replace'](/[\t\n\r\f\v]/g,'\x20')[_0x417944(0x1ee)]()||'',_0x5078be=_0x59e848[_0x417944(0x25e)]?.['replace'](/[\t\n\r\f\v]/g,'\x20')[_0x417944(0x1ee)]()||'';console['log'](_0x417944(0x249)),console['log'](_0x417944(0x1d2)+_0x59e848['first_name']+_0x417944(0x213)+_0x59e848[_0x417944(0x25e)]+'\x22'),console['log']('\x20\x20Cleaned:\x20\x20\x22'+_0x4964aa+'\x22\x20|\x20\x22'+_0x5078be+'\x22');const _0x4c990a={'customerName':_0x4964aa+'\x20'+_0x5078be,'customerEmail':_0x59e848[_0x417944(0x1fa)],'customerPhone':_0x59e848[_0x417944(0x216)]||null,'customerIp':_0x3b6030['ip'],'customerUa':_0x3b6030['user_agent']},_0x48e163=[_0x59e848[_0x417944(0x252)],_0x59e848[_0x417944(0x1ea)]][_0x417944(0x1d0)](Boolean);_0x4c990a[_0x417944(0x22b)]=_0x48e163[_0x417944(0x1a0)](',\x20')||null,_0x4c990a[_0x417944(0x248)]=_0x59e848[_0x417944(0x1f4)]||null,_0x4c990a['billingState']=_0x59e848['state']||null,_0x4c990a[_0x417944(0x1e1)]=_0x59e848['post_code']||_0x59e848['postcode']||null,console[_0x417944(0x200)]('üìç\x20Billing\x20address\x20(string):',_0x4c990a['billingAddress']),console['log'](_0x417944(0x221),_0x5d3af5['number'][_0x417944(0x1de)](0x0,0x6)+'******');const _0x67017d=await binLookupService_1['binLookupService'][_0x417944(0x23b)](_0x5d3af5['number']);console[_0x417944(0x200)]('üìä\x20BIN\x20lookup\x20result:',_0x67017d);const _0x5c5b92=_0x5d3af5[_0x417944(0x223)][_0x417944(0x1de)](0x0,0x8),_0x15bd1c=await database_1['default']['payment'][_0x417944(0x1e3)]({'where':{'id':_0x563f0e},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15bd1c)return _0xb3ad35[_0x417944(0x232)](0x194)[_0x417944(0x24f)]({'success':![],'message':_0x417944(0x22f)});if(_0x15bd1c['gateway']!==_0x417944(0x1d8))return console[_0x417944(0x200)](_0x417944(0x1ed)+_0x15bd1c[_0x417944(0x243)]+'\x27'),_0xb3ad35['status'](0x190)[_0x417944(0x24f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway'});if(_0x15bd1c[_0x417944(0x232)]!==_0x417944(0x1af))return _0xb3ad35[_0x417944(0x232)](0x190)[_0x417944(0x24f)]({'success':![],'message':_0x417944(0x1ce)+_0x15bd1c['status']+_0x417944(0x201)});await database_1[_0x417944(0x1ab)][_0x417944(0x211)][_0x417944(0x210)]({'where':{'id':_0x563f0e},'data':{..._0x4c990a,'cardBin':_0x5c5b92,'cardBinStatus':_0x67017d[_0x417944(0x21a)],'cardType':_0x67017d[_0x417944(0x1a4)],'cardCategory':_0x67017d[_0x417944(0x1bd)],'cardCountry':_0x67017d[_0x417944(0x1f3)],'cardIssuer':_0x67017d[_0x417944(0x1e2)],'phoneIsValid':_0x3bc3e2?.['isValid'],'phoneLineStatus':_0x3bc3e2?.[_0x417944(0x230)],'phoneIsVoip':_0x3bc3e2?.['isVoip'],'phoneRiskLevel':_0x3bc3e2?.[_0x417944(0x231)],'updatedAt':new Date()}}),console['log'](_0x417944(0x238));const _0x29a15c=_0x5d3af5[_0x417944(0x223)][_0x417944(0x1c2)](/[\s-]/g,''),_0x2e7799=_0x29a15c[_0x417944(0x21e)]('4')?_0x417944(0x23e):_0x417944(0x1bb),_0xb5a8df=_0x29a15c['startsWith']('4')?_0x417944(0x1a3):_0x417944(0x1f5),_0x3fe3db=_0x417944(0x228)+_0x2e7799,_0x5ca55f='https://app.trapay.uk/payment/pending?id='+_0x15bd1c['id']+_0x417944(0x1b0)+_0x15bd1c[_0x417944(0x1a8)];console[_0x417944(0x200)]('üí≥\x20'+_0x2e7799[_0x417944(0x1c1)]()+'\x20URLs:'),console[_0x417944(0x200)](_0x417944(0x226)+_0x3fe3db),console['log'](_0x417944(0x1ef)+_0x5ca55f);const _0x12b161={'first_name':_0x59e848[_0x417944(0x1bf)],'last_name':_0x59e848[_0x417944(0x25e)],'email':_0x59e848['email']},_0x4d3f68=await this[_0x417944(0x251)]['processCardPayment']({'paymentId':_0x15bd1c['id'],'orderId':_0x15bd1c[_0x417944(0x1a8)]||_0x15bd1c['id'],'amount':_0x15bd1c[_0x417944(0x212)],'currency':_0x15bd1c['currency'],'cardData':_0x5d3af5,'resultUrl':_0x3fe3db,'returnUrl':_0x5ca55f,'cardHolder':_0x12b161,'browser':_0x3b6030});console[_0x417944(0x200)](_0x417944(0x218),_0x4d3f68);const _0x3b4736={'status':_0x4d3f68[_0x417944(0x232)],'updatedAt':new Date(),'statusChangedBy':_0x417944(0x23f),'statusChangedAt':new Date()};_0x4d3f68[_0x417944(0x22d)]&&(_0x3b4736[_0x417944(0x1a5)]=_0x4d3f68[_0x417944(0x22d)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x4d3f68[_0x417944(0x22d)]));if(_0x4d3f68[_0x417944(0x232)]===_0x417944(0x1e7)){_0x3b4736[_0x417944(0x23a)]=new Date();const _0x478f4b=await this['currencyService'][_0x417944(0x1d3)](_0x15bd1c['amount'],_0x15bd1c[_0x417944(0x1ba)]),_0x344875=await this[_0x417944(0x1e0)][_0x417944(0x1d7)](_0x15bd1c['shopId'],_0x15bd1c[_0x417944(0x243)]),_0x435362=_0x478f4b*(0x1-_0x344875/0x64);_0x3b4736[_0x417944(0x235)]=_0x478f4b,_0x3b4736[_0x417944(0x20b)]=_0x435362,_0x3b4736[_0x417944(0x224)]=_0x344875,console[_0x417944(0x200)](_0x417944(0x236)+_0x15bd1c[_0x417944(0x212)]+'\x20'+_0x15bd1c[_0x417944(0x1ba)]+_0x417944(0x25d)+_0x478f4b[_0x417944(0x1fb)](0x6)+'\x20USDT'),console[_0x417944(0x200)](_0x417944(0x227)+_0x15bd1c[_0x417944(0x243)]+'\x20commission:\x20'+_0x344875+'%'),console['log']('üí∞\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x435362['toFixed'](0x6)+_0x417944(0x23c));}else _0x4d3f68[_0x417944(0x232)]===_0x417944(0x1cd)&&(_0x3b4736[_0x417944(0x237)]=_0x4d3f68['errorMessage']||_0x417944(0x1a7),console['log'](_0x417944(0x1c4)+_0x3b4736[_0x417944(0x237)]));_0x3b4736[_0x417944(0x1db)]='Bank\x20Card';if(_0x5d3af5['number']){const _0x2dd562=_0x5d3af5[_0x417944(0x223)][_0x417944(0x1c2)](/[\s-]/g,'');_0x3b4736[_0x417944(0x1c0)]=_0x2dd562[_0x417944(0x24e)](-0x4),_0x3b4736[_0x417944(0x1b4)]=_0xb5a8df,console[_0x417944(0x200)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x3b4736['cardLast4']),console[_0x417944(0x200)](_0x417944(0x1f6)+_0xb5a8df);}await database_1[_0x417944(0x1ab)][_0x417944(0x211)][_0x417944(0x210)]({'where':{'id':_0x15bd1c['id']},'data':_0x3b4736});_0x4d3f68['status']===_0x417944(0x1e7)&&(await this[_0x417944(0x1e0)]['updatePaymentStatus'](_0x15bd1c['id'],_0x417944(0x1e7)),console[_0x417944(0x200)](_0x417944(0x209)+_0x15bd1c['id']));await database_1[_0x417944(0x1ab)]['webhookLog'][_0x417944(0x1ff)]({'data':{'paymentId':_0x15bd1c['id'],'shopId':_0x15bd1c[_0x417944(0x1ac)],'event':_0x2e7799+'_'+_0x4d3f68['status']?.[_0x417944(0x254)](),'statusCode':0xc8,'responseBody':JSON[_0x417944(0x24c)]({'oldStatus':_0x417944(0x1af),'newStatus':_0x4d3f68[_0x417944(0x232)],'gatewayPaymentId':_0x4d3f68[_0x417944(0x22d)],'requires3ds':_0x4d3f68[_0x417944(0x245)],'cardType':_0x2e7799[_0x417944(0x1c1)](),'processedAt':new Date()[_0x417944(0x25c)]()})}});if(_0x4d3f68[_0x417944(0x21d)]){await this[_0x417944(0x244)](_0x15bd1c,_0x4d3f68[_0x417944(0x232)],_0x4d3f68[_0x417944(0x22d)],_0x2e7799),await this[_0x417944(0x247)](_0x15bd1c,_0x4d3f68[_0x417944(0x232)]);if(_0x4d3f68[_0x417944(0x232)]===_0x417944(0x1e7)){console[_0x417944(0x200)]('üìà\x20'+_0x2e7799[_0x417944(0x1c1)]()+_0x417944(0x1d1)+_0x563f0e+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x12ca32}=await Promise[_0x417944(0x240)]()[_0x417944(0x253)](()=>__importStar(require(_0x417944(0x204)))),_0x26c74e=new _0x12ca32();await _0x26c74e[_0x417944(0x242)](_0x563f0e),console[_0x417944(0x200)](_0x417944(0x1c7)+_0x2e7799[_0x417944(0x1c1)]()+_0x417944(0x1d1)+_0x563f0e);}catch(_0x409ebc){console['error'](_0x417944(0x19f)+_0x2e7799[_0x417944(0x1c1)]()+'\x20payment:',_0x409ebc);}}}console['log']('‚úÖ\x20'+_0x2e7799[_0x417944(0x1c1)]()+_0x417944(0x1d1)+_0x563f0e+_0x417944(0x233)+_0x4d3f68[_0x417944(0x232)]);if(_0x4d3f68['status']===_0x417944(0x1e7))_0xb3ad35[_0x417944(0x24f)]({'success':!![],'message':_0x417944(0x214),'result':{'status':'PAID','gatewayPaymentId':_0x4d3f68['gateway_payment_id'],'redirectUrl':_0x5ca55f,'final':!![]}});else _0x4d3f68[_0x417944(0x245)]&&_0x4d3f68['threeds_url']?_0xb3ad35[_0x417944(0x24f)]({'success':!![],'message':_0x417944(0x1b3),'result':{'status':_0x417944(0x1af),'gatewayPaymentId':_0x4d3f68['gateway_payment_id'],'redirectUrl':_0x4d3f68[_0x417944(0x1be)],'requires3ds':!![],'final':![]}}):_0xb3ad35[_0x417944(0x232)](0x190)[_0x417944(0x24f)]({'success':![],'message':_0x417944(0x1df),'result':{'status':_0x417944(0x1cd),'gatewayPaymentId':_0x4d3f68[_0x417944(0x22d)],'redirectUrl':_0x15bd1c[_0x417944(0x215)],'final':!![]}});}catch(_0xee747d){_0x3097ee(_0xee747d);}},this['paymentService']=new paymentService_1[(_0x35a2bb(0x22c))](),this['visaMasterCardService']=new mastercardService_1['VisaMasterCardService'](),this[_0x35a2bb(0x1e0)]=new webhookService_1[(_0x35a2bb(0x1ae))](),this[_0x35a2bb(0x1d6)]=new currencyService_1[(_0x35a2bb(0x25a))]();}async['sendShopWebhook'](_0x961b8f,_0x52245d,_0x1af1ef,_0x4f34db){const _0x3b3860=a14_0x4cadb8,_0x411652=Date[_0x3b3860(0x1b6)]();try{const _0x3f9f34=_0x961b8f[_0x3b3860(0x1e9)],_0x28f48c=_0x3f9f34['settings'];if(!_0x28f48c?.[_0x3b3860(0x1b7)]){console[_0x3b3860(0x200)](_0x3b3860(0x250)+_0x3f9f34['id']);return;}const _0x11f9db=_0x52245d===_0x3b3860(0x1e7)?_0x3b3860(0x25f):'payment.failed';let _0x2b9a02=[];if(_0x28f48c[_0x3b3860(0x22a)])try{_0x2b9a02=Array[_0x3b3860(0x239)](_0x28f48c['webhookEvents'])?_0x28f48c[_0x3b3860(0x22a)]:JSON[_0x3b3860(0x22e)](_0x28f48c[_0x3b3860(0x22a)]);}catch(_0x54b32e){console[_0x3b3860(0x1a1)](_0x3b3860(0x20a),_0x54b32e),_0x2b9a02=[];}if(!_0x2b9a02[_0x3b3860(0x217)](_0x11f9db)){console[_0x3b3860(0x200)](_0x3b3860(0x1f7)+_0x11f9db+_0x3b3860(0x1c9)+_0x3f9f34['id']);return;}const _0x1d9995={'event':_0x11f9db,'payment':{'id':_0x961b8f['id'],'order_id':_0x961b8f[_0x3b3860(0x1f8)],'gateway_order_id':_0x961b8f['gatewayOrderId'],'gateway':_0x3b3860(0x259),'card_type':_0x4f34db?.['toUpperCase']()||_0x3b3860(0x1eb),'amount':_0x961b8f[_0x3b3860(0x212)],'currency':_0x961b8f[_0x3b3860(0x1ba)],'status':_0x52245d[_0x3b3860(0x254)](),'customer_email':_0x961b8f[_0x3b3860(0x225)],'customer_name':_0x961b8f[_0x3b3860(0x241)],'gateway_payment_id':_0x1af1ef,'created_at':_0x961b8f[_0x3b3860(0x1cc)],'updated_at':new Date()}},_0x418d30=JSON[_0x3b3860(0x24c)](_0x1d9995),_0xbe8f3b=crypto_1['default']['createHmac']('sha256',_0x3f9f34[_0x3b3860(0x207)])[_0x3b3860(0x210)](_0x418d30)[_0x3b3860(0x19e)](_0x3b3860(0x1ad)),_0x2b5aba=await fetch(_0x28f48c[_0x3b3860(0x1b7)],{'method':_0x3b3860(0x1c3),'headers':{'Content-Type':_0x3b3860(0x1bc),'User-Agent':_0x3b3860(0x255)+(_0x4f34db?.[_0x3b3860(0x1c1)]()||'VISA/MasterCard')+')','X-Webhook-Signature':_0xbe8f3b},'body':_0x418d30}),_0x133f9e=Date[_0x3b3860(0x1b6)]()-_0x411652;console['log']((_0x4f34db?.[_0x3b3860(0x1c1)]()||_0x3b3860(0x256))+'\x20webhook\x20sent\x20to\x20'+_0x28f48c['webhookUrl']+'\x20with\x20status\x20'+_0x2b5aba[_0x3b3860(0x232)]+'\x20('+_0x133f9e+_0x3b3860(0x1e4));}catch(_0x5cc609){console[_0x3b3860(0x1a1)](_0x3b3860(0x1b5)+(_0x4f34db?.[_0x3b3860(0x1c1)]()||_0x3b3860(0x256))+_0x3b3860(0x24b),_0x5cc609);}}async['sendPaymentStatusNotification'](_0x2ecf95,_0x5c0e8f){const _0x53799a=a14_0x4cadb8;try{const {telegramBotService:_0x1f01d9}=await Promise[_0x53799a(0x240)]()['then'](()=>__importStar(require(_0x53799a(0x208)))),_0x2869ef={'PAID':'paid','FAILED':'failed'},_0x5739f9=_0x2869ef[_0x5c0e8f];if(!_0x5739f9)return;await _0x1f01d9['sendPaymentNotification'](_0x2ecf95[_0x53799a(0x1ac)],_0x2ecf95,_0x5739f9);}catch(_0x22d83e){console[_0x53799a(0x1a1)](_0x53799a(0x20d),_0x22d83e);}}}exports[a14_0x4cadb8(0x1b2)]=PaymentController;function a14_0x3e7c(){const _0x593110=['üí∞\x20Updated\x20merchant\x20balance\x20for\x20payment\x20','Error\x20parsing\x20webhook\x20events:','amountAfterGatewayCommissionUSDT','crypto','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../config/database','Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available','update','payment','amount','\x22\x20|\x20\x22','Payment\x20processed\x20successfully','failUrl','phone','includes','üí≥\x20MasterCard\x20result:','86344pcxOOV','cardBinStatus','5150621vlECnU','getPaymentFingerprint','final','startsWith','../services/gateways/mastercardService','getOwnPropertyDescriptor','üîç\x20Looking\x20up\x20BIN\x20for\x20card:','query','number','gatewayCommissionRate','customerEmail','\x20\x20\x20Result\x20URL\x20(webhook):\x20','üí∞\x20Gateway\x20','https://api.trapay.uk/api/webhooks/gateway/','params','webhookEvents','billingAddress','PaymentService','gateway_payment_id','parse','Payment\x20not\x20found','lineStatus','riskLevel','status','\x20processed:\x20','customerIp','amountUSDT','üí∞\x20Converting\x20','failureMessage','‚úÖ\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info','isArray','paidAt','lookupBin','\x20USDT','372634fEehvK','visa','system','resolve','customerName','handleSuccessfulPayment','gateway','sendShopWebhook','requires_3ds','‚úÖ\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','sendPaymentStatusNotification','billingCity','üßπ\x20Customer\x20names\x20cleaned:','paymentService','\x20webhook:','stringify','üìù\x20Customer\x20data:','slice','json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','visaMasterCardService','address_line_1','then','toLowerCase','Payment\x20System/1.0\x20(','VISA/MasterCard','\x20with\x20requestId\x20','__importStar','1111','CurrencyService','string','toISOString','\x20->\x20','last_name','payment.success','digest','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','join','error','2caIFSZ','VISA','cardType','gatewayPaymentId','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Card\x20payment\x20failed','gatewayOrderId','__esModule','length','default','shopId','hex','WebhookService','PENDING','&payment_id=','configurable','PaymentController','3DS\x20verification\x20required','cardBrand','Failed\x20to\x20send\x20','now','webhookUrl','üí≥\x20Card\x20holder:\x20','__importDefault','currency','mastercard','application/json','cardCategory','threeds_url','first_name','cardLast4','toUpperCase','replace','POST','‚ùå\x20Payment\x20failed\x20with\x20message:\x20','__createBinding','getOwnPropertyNames','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','14026545zUKTcb','\x20not\x20enabled\x20for\x20shop\x20','defineProperty','createPublicPayment','createdAt','FAILED','Payment\x20status\x20is\x20','requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string','filter','\x20payment\x20','\x20\x20Original:\x20\x22','convertToUSDT','body','processMasterCardPayment','currencyService','getGatewayCommission','visa/mastercard','1712688LHyDXd','Payment\x20created\x20successfully','paymentMethod','get','getPaymentById','substring','Payment\x20failed','webhookService','billingZip','cardIssuer','findUnique','ms)','../services/paymentService','üîç\x20Received\x20fingerprint\x20request\x20for\x20payment\x20','PAID','5AnxZRF','shop','address_line_2','UNKNOWN','üí≥\x20Processing\x20MasterCard\x20payment:\x20','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','trim','\x20\x20\x20Return\x20URL:\x20','../services/binLookupService','__setModuleDefault','updatePaymentCustomer','cardCountry','city','MASTERCARD','üí≥\x20Saving\x20card\x20brand:\x20','Webhook\x20event\x20','orderId','writable','email','toFixed','60414fKnUWo','prototype','../services/currencyService','create','log',',\x20cannot\x20process','Customer\x20data\x20updated\x20successfully','hasOwnProperty','../services/paymentLinkService','../services/webhookService','2031392UTKlwl','secretKey','../services/telegramBotService'];a14_0x3e7c=function(){return _0x593110;};return a14_0x3e7c();}