'use strict';const a8_0x183bea=a8_0x31eb;(function(_0x14f697,_0x4980f2){const _0x9f28d4=a8_0x31eb,_0x7d3803=_0x14f697();while(!![]){try{const _0x2830ff=parseInt(_0x9f28d4(0x227))/0x1*(-parseInt(_0x9f28d4(0x1da))/0x2)+parseInt(_0x9f28d4(0x1c9))/0x3*(parseInt(_0x9f28d4(0x1ee))/0x4)+parseInt(_0x9f28d4(0x1ff))/0x5*(parseInt(_0x9f28d4(0x219))/0x6)+parseInt(_0x9f28d4(0x1f1))/0x7+parseInt(_0x9f28d4(0x1e4))/0x8*(parseInt(_0x9f28d4(0x1d1))/0x9)+-parseInt(_0x9f28d4(0x220))/0xa+-parseInt(_0x9f28d4(0x209))/0xb;if(_0x2830ff===_0x4980f2)break;else _0x7d3803['push'](_0x7d3803['shift']());}catch(_0x54c581){_0x7d3803['push'](_0x7d3803['shift']());}}}(a8_0x4cf0,0xd7be6));function a8_0x31eb(_0x4bc533,_0x1df3de){const _0x4cf009=a8_0x4cf0();return a8_0x31eb=function(_0x31ebfb,_0x3dc25c){_0x31ebfb=_0x31ebfb-0x1bd;let _0x4c6cf6=_0x4cf009[_0x31ebfb];return _0x4c6cf6;},a8_0x31eb(_0x4bc533,_0x1df3de);}var __createBinding=this&&this[a8_0x183bea(0x215)]||(Object[a8_0x183bea(0x205)]?function(_0x2affdd,_0x1bb557,_0x49ed52,_0x44b0a2){const _0x2f81b2=a8_0x183bea;if(_0x44b0a2===undefined)_0x44b0a2=_0x49ed52;var _0x2a07f7=Object[_0x2f81b2(0x213)](_0x1bb557,_0x49ed52);(!_0x2a07f7||(_0x2f81b2(0x1e6)in _0x2a07f7?!_0x1bb557['__esModule']:_0x2a07f7[_0x2f81b2(0x1d9)]||_0x2a07f7[_0x2f81b2(0x22a)]))&&(_0x2a07f7={'enumerable':!![],'get':function(){return _0x1bb557[_0x49ed52];}}),Object[_0x2f81b2(0x1f6)](_0x2affdd,_0x44b0a2,_0x2a07f7);}:function(_0x499090,_0x27d3e2,_0x556dc1,_0x184384){if(_0x184384===undefined)_0x184384=_0x556dc1;_0x499090[_0x184384]=_0x27d3e2[_0x556dc1];}),__setModuleDefault=this&&this[a8_0x183bea(0x1d5)]||(Object[a8_0x183bea(0x205)]?function(_0x1f94f8,_0x1b42d2){Object['defineProperty'](_0x1f94f8,'default',{'enumerable':!![],'value':_0x1b42d2});}:function(_0x498b8c,_0x5538ba){_0x498b8c['default']=_0x5538ba;}),__importStar=this&&this[a8_0x183bea(0x1cd)]||(function(){var _0x1ca58e=function(_0x37a48f){const _0x180845=a8_0x31eb;return _0x1ca58e=Object[_0x180845(0x201)]||function(_0x31c6af){const _0x55c4f7=_0x180845;var _0x4ed128=[];for(var _0x13df65 in _0x31c6af)if(Object[_0x55c4f7(0x1f5)]['hasOwnProperty'][_0x55c4f7(0x21f)](_0x31c6af,_0x13df65))_0x4ed128[_0x4ed128[_0x55c4f7(0x222)]]=_0x13df65;return _0x4ed128;},_0x1ca58e(_0x37a48f);};return function(_0x33fe6f){const _0xfdb621=a8_0x31eb;if(_0x33fe6f&&_0x33fe6f[_0xfdb621(0x1c3)])return _0x33fe6f;var _0x466805={};if(_0x33fe6f!=null){for(var _0x4acb06=_0x1ca58e(_0x33fe6f),_0x243f1c=0x0;_0x243f1c<_0x4acb06[_0xfdb621(0x222)];_0x243f1c++)if(_0x4acb06[_0x243f1c]!==_0xfdb621(0x206))__createBinding(_0x466805,_0x33fe6f,_0x4acb06[_0x243f1c]);}return __setModuleDefault(_0x466805,_0x33fe6f),_0x466805;};}()),__importDefault=this&&this[a8_0x183bea(0x1c1)]||function(_0x58bc76){const _0x5481a3=a8_0x183bea;return _0x58bc76&&_0x58bc76[_0x5481a3(0x1c3)]?_0x58bc76:{'default':_0x58bc76};};Object[a8_0x183bea(0x1f6)](exports,a8_0x183bea(0x1c3),{'value':!![]}),exports[a8_0x183bea(0x233)]=void 0x0;function a8_0x4cf0(){const _0x163cb1=['paymentService','toLowerCase','Payment\x20not\x20found','create','default','mastercard_','gateway','7584049ITkRfb','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PAID','PENDING','💳\x20MasterCard\x20result:','payment','../services/paymentService','body','application/json','Customer\x20data\x20updated\x20successfully','getOwnPropertyDescriptor','\x20not\x20enabled\x20for\x20shop\x20','__createBinding','shopId','system','gateway_payment_id','357978TTiica','../config/database','status','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','now','parse','call','4049790YYCXLc','PaymentService','length','💳\x20Processing\x20MasterCard\x20payment:\x20','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','processCardPayment','Webhook\x20event\x20','440183RZqxGl','threeds_url','sendShopWebhook','configurable','successUrl','params','WebhookService','gatewayOrderId','resolve','stringify','customerIp','3DS\x20verification\x20required','PaymentController','findUnique','isArray','Payment\x20status\x20is\x20','log','__importDefault','error','__esModule','requires_3ds','../services/webhookService','MasterCardService','customerUa','Card\x20payment\x20failed','21PZGDgE','💳\x20MasterCard\x20URLs:','gatewayPaymentId','amount','__importStar','../services/telegramBotService','settings','Payment\x20processed\x20successfully','27792TYMatM','masterCardService','getPaymentStatus','createPublicPayment','__setModuleDefault','../services/gateways/mastercardService','paymentMethod','mastercard','writable','2UxQEkG','webhookEvents','toISOString','📝\x20Customer\x20data:','ms)','POST','Payment\x20failed','webhookUrl','json','processMasterCardPayment','152fDWmur','webhookLog','get','createdAt','payment.failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerCountry','https://api.trapay.uk/api/webhooks/gateway/mastercard','FAILED','\x20\x20\x20Return\x20URL:\x20','319300tvDMwa','paid','payment.success','1747354nwkTMi','getPaymentById','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','sendPaymentNotification','prototype','defineProperty','Failed\x20to\x20send\x20MasterCard\x20webhook:','Payment\x20created\x20successfully','sendPaymentStatusNotification','updatePaymentCustomer','updatePaymentCustomerDataPublic','paidAt','currency','shop','130rlAOIo','\x20\x20\x20Result\x20URL\x20(webhook):\x20','getOwnPropertyNames'];a8_0x4cf0=function(){return _0x163cb1;};return a8_0x4cf0();}const paymentService_1=require(a8_0x183bea(0x20f)),mastercardService_1=require(a8_0x183bea(0x1d6)),webhookService_1=require(a8_0x183bea(0x1c5)),database_1=__importDefault(require(a8_0x183bea(0x21a)));class PaymentController{constructor(){const _0xa2a8ab=a8_0x183bea;this[_0xa2a8ab(0x1d4)]=async(_0x153406,_0x3b8ccd,_0x263194)=>{const _0x2ad067=_0xa2a8ab;try{const _0x561e4a=_0x153406['body'],_0x331d31=await this[_0x2ad067(0x202)]['createPublicPayment'](_0x561e4a);_0x3b8ccd[_0x2ad067(0x21b)](0xc9)[_0x2ad067(0x1e2)]({'success':!![],'message':_0x2ad067(0x1f8),'result':_0x331d31});}catch(_0x357d7a){_0x263194(_0x357d7a);}},this[_0xa2a8ab(0x1d3)]=async(_0x50e4f4,_0x54629b,_0x3ceb31)=>{const _0x123e57=_0xa2a8ab;try{const {id:_0x2200d3}=_0x50e4f4[_0x123e57(0x22c)],_0x12f97e=await this['paymentService'][_0x123e57(0x1d3)](_0x2200d3);if(!_0x12f97e)return _0x54629b['status'](0x194)[_0x123e57(0x1e2)]({'success':![],'message':_0x123e57(0x204)});_0x54629b[_0x123e57(0x1e2)]({'success':!![],'result':_0x12f97e});}catch(_0x28f5f9){_0x3ceb31(_0x28f5f9);}},this[_0xa2a8ab(0x1f2)]=async(_0x3e8f02,_0x4adaa8,_0x3f4e87)=>{const _0x5cfb5e=_0xa2a8ab;try{const {id:_0xe478c9}=_0x3e8f02[_0x5cfb5e(0x22c)],_0x3442c3=await this[_0x5cfb5e(0x202)]['getPaymentById'](_0xe478c9);if(!_0x3442c3)return _0x4adaa8['status'](0x194)[_0x5cfb5e(0x1e2)]({'success':![],'message':'Payment\x20not\x20found'});_0x4adaa8[_0x5cfb5e(0x1e2)]({'success':!![],'result':_0x3442c3});}catch(_0x61bc2f){_0x3f4e87(_0x61bc2f);}},this[_0xa2a8ab(0x1fa)]=async(_0x428bc5,_0x56631c,_0x47dc67)=>{const _0x5cd108=_0xa2a8ab;try{const {id:_0x85d637}=_0x428bc5[_0x5cd108(0x22c)],_0x2f909d=_0x428bc5[_0x5cd108(0x210)];console[_0x5cd108(0x1c0)](_0x5cd108(0x21c)+_0x85d637),console[_0x5cd108(0x1c0)](_0x5cd108(0x1dd),_0x2f909d);const _0x4ac1fa=await this[_0x5cd108(0x202)][_0x5cd108(0x1fb)](_0x85d637,_0x2f909d);if(!_0x4ac1fa)return _0x56631c['status'](0x194)[_0x5cd108(0x1e2)]({'success':![],'message':_0x5cd108(0x204)});_0x56631c[_0x5cd108(0x1e2)]({'success':!![],'message':_0x5cd108(0x212),'result':{'paymentId':_0x4ac1fa['id'],'customerIp':_0x4ac1fa[_0x5cd108(0x231)],'customerUa':_0x4ac1fa[_0x5cd108(0x1c7)],'customerCountry':_0x4ac1fa[_0x5cd108(0x1ea)],'updatedAt':_0x4ac1fa['updatedAt']}});}catch(_0x231d52){_0x47dc67(_0x231d52);}},this[_0xa2a8ab(0x1e3)]=async(_0x403413,_0x4bb08e,_0x4a0c40)=>{const _0x542568=_0xa2a8ab;try{const {id:_0xddb56b}=_0x403413[_0x542568(0x22c)],{cardData:_0x3dc233,cardHolder:_0xf0fbaa,browser:_0xb12372}=_0x403413[_0x542568(0x210)];console['log'](_0x542568(0x223)+_0xddb56b);const _0x27fd11=await database_1['default'][_0x542568(0x20e)][_0x542568(0x1bd)]({'where':{'id':_0xddb56b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x27fd11)return _0x4bb08e[_0x542568(0x21b)](0x194)[_0x542568(0x1e2)]({'success':![],'message':_0x542568(0x204)});if(_0x27fd11[_0x542568(0x208)]!==_0x542568(0x1d8))return _0x4bb08e[_0x542568(0x21b)](0x190)[_0x542568(0x1e2)]({'success':![],'message':_0x542568(0x1f3)});if(_0x27fd11[_0x542568(0x21b)]!=='PENDING')return _0x4bb08e[_0x542568(0x21b)](0x190)[_0x542568(0x1e2)]({'success':![],'message':_0x542568(0x1bf)+_0x27fd11[_0x542568(0x21b)]+',\x20cannot\x20process'});const _0x249340=_0x542568(0x1eb),_0x5472e5=_0x27fd11[_0x542568(0x22b)];console['log'](_0x542568(0x1ca)),console[_0x542568(0x1c0)](_0x542568(0x200)+_0x249340),console[_0x542568(0x1c0)](_0x542568(0x1ed)+_0x5472e5);const _0x983f6b=await this[_0x542568(0x1d2)][_0x542568(0x225)]({'paymentId':_0x27fd11['id'],'orderId':_0x27fd11[_0x542568(0x22e)]||_0x27fd11['id'],'amount':_0x27fd11[_0x542568(0x1cc)],'currency':_0x27fd11[_0x542568(0x1fd)],'cardData':_0x3dc233,'resultUrl':_0x249340,'returnUrl':_0x5472e5,'cardHolder':_0xf0fbaa,'browser':_0xb12372});console['log'](_0x542568(0x20d),_0x983f6b);const _0x49aa44={'status':_0x983f6b[_0x542568(0x21b)],'updatedAt':new Date(),'statusChangedBy':_0x542568(0x217),'statusChangedAt':new Date()};if(_0x983f6b[_0x542568(0x21b)]==='PAID')_0x49aa44[_0x542568(0x1fc)]=new Date(),_0x49aa44[_0x542568(0x1cb)]=_0x983f6b[_0x542568(0x218)];else _0x983f6b[_0x542568(0x21b)]==='FAILED'&&(_0x49aa44['failureMessage']=_0x542568(0x1c8));_0x49aa44[_0x542568(0x1d7)]=_0x542568(0x1d8),await database_1[_0x542568(0x206)][_0x542568(0x20e)]['update']({'where':{'id':_0x27fd11['id']},'data':_0x49aa44}),await database_1[_0x542568(0x206)][_0x542568(0x1e5)]['create']({'data':{'paymentId':_0x27fd11['id'],'shopId':_0x27fd11[_0x542568(0x216)],'event':_0x542568(0x207)+_0x983f6b[_0x542568(0x21b)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x542568(0x230)]({'oldStatus':_0x542568(0x20c),'newStatus':_0x983f6b[_0x542568(0x21b)],'gatewayPaymentId':_0x983f6b['gateway_payment_id'],'requires3ds':_0x983f6b['requires_3ds'],'processedAt':new Date()[_0x542568(0x1dc)]()})}});_0x983f6b['final']&&(await this['sendShopWebhook'](_0x27fd11,_0x983f6b[_0x542568(0x21b)],_0x983f6b[_0x542568(0x218)]),await this[_0x542568(0x1f9)](_0x27fd11,_0x983f6b[_0x542568(0x21b)]));console[_0x542568(0x1c0)]('✅\x20MasterCard\x20payment\x20'+_0xddb56b+'\x20processed:\x20'+_0x983f6b[_0x542568(0x21b)]);if(_0x983f6b[_0x542568(0x21b)]===_0x542568(0x20b))_0x4bb08e[_0x542568(0x1e2)]({'success':!![],'message':_0x542568(0x1d0),'result':{'status':'PAID','gatewayPaymentId':_0x983f6b[_0x542568(0x218)],'redirectUrl':_0x5472e5,'final':!![]}});else _0x983f6b[_0x542568(0x1c4)]&&_0x983f6b[_0x542568(0x228)]?_0x4bb08e[_0x542568(0x1e2)]({'success':!![],'message':_0x542568(0x232),'result':{'status':_0x542568(0x20c),'gatewayPaymentId':_0x983f6b[_0x542568(0x218)],'redirectUrl':_0x983f6b[_0x542568(0x228)],'requires3ds':!![],'final':![]}}):_0x4bb08e[_0x542568(0x21b)](0x190)[_0x542568(0x1e2)]({'success':![],'message':_0x542568(0x1e0),'result':{'status':_0x542568(0x1ec),'gatewayPaymentId':_0x983f6b[_0x542568(0x218)],'redirectUrl':_0x27fd11['failUrl'],'final':!![]}});}catch(_0x4021a0){_0x4a0c40(_0x4021a0);}},this[_0xa2a8ab(0x202)]=new paymentService_1[(_0xa2a8ab(0x221))](),this['masterCardService']=new mastercardService_1[(_0xa2a8ab(0x1c6))](),this['webhookService']=new webhookService_1[(_0xa2a8ab(0x22d))]();}async[a8_0x183bea(0x229)](_0x144e8a,_0x34e7c1,_0x389409){const _0x2d4dc5=a8_0x183bea,_0x17fd2b=Date['now']();try{const _0x5bde8c=_0x144e8a[_0x2d4dc5(0x1fe)],_0x32ada0=_0x5bde8c[_0x2d4dc5(0x1cf)];if(!_0x32ada0?.[_0x2d4dc5(0x1e1)]){console[_0x2d4dc5(0x1c0)](_0x2d4dc5(0x1e9)+_0x5bde8c['id']);return;}const _0x36302b=_0x34e7c1===_0x2d4dc5(0x20b)?_0x2d4dc5(0x1f0):_0x2d4dc5(0x1e8);let _0x1690a0=[];if(_0x32ada0[_0x2d4dc5(0x1db)])try{_0x1690a0=Array[_0x2d4dc5(0x1be)](_0x32ada0[_0x2d4dc5(0x1db)])?_0x32ada0[_0x2d4dc5(0x1db)]:JSON[_0x2d4dc5(0x21e)](_0x32ada0[_0x2d4dc5(0x1db)]);}catch(_0x183d04){console['error']('Error\x20parsing\x20webhook\x20events:',_0x183d04),_0x1690a0=[];}if(!_0x1690a0['includes'](_0x36302b)){console['log'](_0x2d4dc5(0x226)+_0x36302b+_0x2d4dc5(0x214)+_0x5bde8c['id']);return;}const _0x252892={'event':_0x36302b,'payment':{'id':_0x144e8a['id'],'order_id':_0x144e8a['orderId'],'gateway_order_id':_0x144e8a[_0x2d4dc5(0x22e)],'gateway':'1111','amount':_0x144e8a['amount'],'currency':_0x144e8a[_0x2d4dc5(0x1fd)],'status':_0x34e7c1[_0x2d4dc5(0x203)](),'customer_email':_0x144e8a['customerEmail'],'customer_name':_0x144e8a['customerName'],'gateway_payment_id':_0x389409,'created_at':_0x144e8a[_0x2d4dc5(0x1e7)],'updated_at':new Date()}},_0x22e46b=await fetch(_0x32ada0['webhookUrl'],{'method':_0x2d4dc5(0x1df),'headers':{'Content-Type':_0x2d4dc5(0x211),'User-Agent':_0x2d4dc5(0x224)},'body':JSON[_0x2d4dc5(0x230)](_0x252892)}),_0x2c7398=Date[_0x2d4dc5(0x21d)]()-_0x17fd2b;console[_0x2d4dc5(0x1c0)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x32ada0[_0x2d4dc5(0x1e1)]+'\x20with\x20status\x20'+_0x22e46b[_0x2d4dc5(0x21b)]+'\x20('+_0x2c7398+_0x2d4dc5(0x1de));}catch(_0x37ca6f){console[_0x2d4dc5(0x1c2)](_0x2d4dc5(0x1f7),_0x37ca6f);}}async['sendPaymentStatusNotification'](_0x153b89,_0x31e278){const _0x192c41=a8_0x183bea;try{const {telegramBotService:_0x1e038f}=await Promise[_0x192c41(0x22f)]()['then'](()=>__importStar(require(_0x192c41(0x1ce)))),_0x1440a5={'PAID':_0x192c41(0x1ef),'FAILED':'failed'},_0x1fff70=_0x1440a5[_0x31e278];if(!_0x1fff70)return;await _0x1e038f[_0x192c41(0x1f4)](_0x153b89[_0x192c41(0x216)],_0x153b89,_0x1fff70);}catch(_0x46fbc8){console[_0x192c41(0x1c2)](_0x192c41(0x20a),_0x46fbc8);}}}exports[a8_0x183bea(0x233)]=PaymentController;