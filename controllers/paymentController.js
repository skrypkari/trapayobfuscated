'use strict';const a8_0x298c02=a8_0x33b7;(function(_0x197659,_0x337dfa){const _0x2e414a=a8_0x33b7,_0x4f7639=_0x197659();while(!![]){try{const _0x4fe90c=-parseInt(_0x2e414a(0x105))/0x1+-parseInt(_0x2e414a(0x164))/0x2*(parseInt(_0x2e414a(0x157))/0x3)+parseInt(_0x2e414a(0x13c))/0x4*(parseInt(_0x2e414a(0x166))/0x5)+-parseInt(_0x2e414a(0x136))/0x6*(parseInt(_0x2e414a(0x167))/0x7)+-parseInt(_0x2e414a(0x100))/0x8+parseInt(_0x2e414a(0x129))/0x9*(parseInt(_0x2e414a(0x14e))/0xa)+parseInt(_0x2e414a(0x138))/0xb*(parseInt(_0x2e414a(0x15d))/0xc);if(_0x4fe90c===_0x337dfa)break;else _0x4f7639['push'](_0x4f7639['shift']());}catch(_0x12bbd6){_0x4f7639['push'](_0x4f7639['shift']());}}}(a8_0x4a25,0xf2db0));function a8_0x33b7(_0x53a442,_0x4b2ca0){const _0x4a2587=a8_0x4a25();return a8_0x33b7=function(_0x33b779,_0x351232){_0x33b779=_0x33b779-0xf4;let _0x44448c=_0x4a2587[_0x33b779];return _0x44448c;},a8_0x33b7(_0x53a442,_0x4b2ca0);}var __createBinding=this&&this[a8_0x298c02(0x111)]||(Object[a8_0x298c02(0x116)]?function(_0x3508a1,_0x2f8525,_0x558b41,_0x5eae55){const _0x3ae7d1=a8_0x298c02;if(_0x5eae55===undefined)_0x5eae55=_0x558b41;var _0x3594b2=Object[_0x3ae7d1(0x142)](_0x2f8525,_0x558b41);(!_0x3594b2||(_0x3ae7d1(0x11c)in _0x3594b2?!_0x2f8525['__esModule']:_0x3594b2[_0x3ae7d1(0x13e)]||_0x3594b2[_0x3ae7d1(0x110)]))&&(_0x3594b2={'enumerable':!![],'get':function(){return _0x2f8525[_0x558b41];}}),Object[_0x3ae7d1(0x173)](_0x3508a1,_0x5eae55,_0x3594b2);}:function(_0x3930bd,_0x7c7fc7,_0x166323,_0x599145){if(_0x599145===undefined)_0x599145=_0x166323;_0x3930bd[_0x599145]=_0x7c7fc7[_0x166323];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x298c02(0x116)]?function(_0x17d50c,_0x4715e6){const _0x24ff43=a8_0x298c02;Object[_0x24ff43(0x173)](_0x17d50c,_0x24ff43(0x15e),{'enumerable':!![],'value':_0x4715e6});}:function(_0x177028,_0x1cdc65){const _0x25778e=a8_0x298c02;_0x177028[_0x25778e(0x15e)]=_0x1cdc65;}),__importStar=this&&this[a8_0x298c02(0x15b)]||(function(){var _0x42c66a=function(_0x2455ad){const _0x256946=a8_0x33b7;return _0x42c66a=Object[_0x256946(0x10a)]||function(_0x1a41bc){const _0x36fe81=_0x256946;var _0x5eed32=[];for(var _0x3786ff in _0x1a41bc)if(Object[_0x36fe81(0x150)]['hasOwnProperty']['call'](_0x1a41bc,_0x3786ff))_0x5eed32[_0x5eed32[_0x36fe81(0x139)]]=_0x3786ff;return _0x5eed32;},_0x42c66a(_0x2455ad);};return function(_0x544a03){const _0x5b6b3e=a8_0x33b7;if(_0x544a03&&_0x544a03['__esModule'])return _0x544a03;var _0x38d2b8={};if(_0x544a03!=null){for(var _0x531cc9=_0x42c66a(_0x544a03),_0x38215d=0x0;_0x38215d<_0x531cc9['length'];_0x38215d++)if(_0x531cc9[_0x38215d]!==_0x5b6b3e(0x15e))__createBinding(_0x38d2b8,_0x544a03,_0x531cc9[_0x38215d]);}return __setModuleDefault(_0x38d2b8,_0x544a03),_0x38d2b8;};}()),__importDefault=this&&this['__importDefault']||function(_0x3b61d8){const _0x514a57=a8_0x298c02;return _0x3b61d8&&_0x3b61d8[_0x514a57(0x16f)]?_0x3b61d8:{'default':_0x3b61d8};};Object[a8_0x298c02(0x173)](exports,a8_0x298c02(0x16f),{'value':!![]}),exports[a8_0x298c02(0x101)]=void 0x0;function a8_0x4a25(){const _0x12eeaf=['26UvFNhU','sendPaymentStatusNotification','5LrGvbA','42fCFtKy','successUrl','mastercard_','shop','\x20with\x20status\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','application/json','currency','__esModule','body','Payment\x20failed','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','defineProperty','resolve','💳\x20Processing\x20MasterCard\x20payment:\x20','cardLast4','webhookEvents','shopId','replace','masterCardService','MasterCard\x20webhook\x20sent\x20to\x20','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','customerName','../services/gateways/mastercardService','createPublicPayment','9075992xMTGlx','PaymentController','log','Payment\x20created\x20successfully','✅\x20MasterCard\x20payment\x20','1578918qYnrMS','params','PENDING','failed','https://api.trapay.uk/api/webhooks/gateway/mastercard','getOwnPropertyNames','payment.success','createdAt','payment.failed','last_name','Payment\x20not\x20found','configurable','__createBinding','error','gatewayOrderId','paymentMethod','\x20\x20\x20Result\x20URL\x20(webhook):\x20','create','Payment\x20status\x20is\x20','FAILED','💳\x20MasterCard\x20URLs:','sendPaymentNotification','\x20not\x20enabled\x20for\x20shop\x20','get','getPaymentById','user_agent','parse','threeds_url','gatewayPaymentId','Payment\x20processed\x20successfully','💳\x20MasterCard\x20result:','findUnique','../services/paymentLinkService','📈\x20MasterCard\x20payment\x20','MasterCardService','then','3979818LPfSgT','email','../config/database','sendShopWebhook','webhookLog','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','processCardPayment','\x20processed:\x20','payment','failUrl','3DS\x20verification\x20required','Failed\x20to\x20send\x20MasterCard\x20webhook:','number','1568274KFANtr','handleSuccessfulPayment','9416143GIlwGx','length','orderId','status','3630052JbtyjR','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','writable','WebhookService','PAID','settings','getOwnPropertyDescriptor','isArray','updatePaymentCustomerDataPublic','mastercard','ms)','includes','toLowerCase','gateway_payment_id','first_name','slice','paidAt','now','10CeiDNJ','webhookUrl','prototype','../services/telegramBotService','customerCountry','gateway','update','failureMessage','system','81543ThTFRI','json','stringify','requires_3ds','__importStar','processMasterCardPayment','60fRfxCk','default','getPaymentStatus','\x20\x20\x20Return\x20URL:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentService','paid'];a8_0x4a25=function(){return _0x12eeaf;};return a8_0x4a25();}const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x298c02(0xfe)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x298c02(0x12b)));class PaymentController{constructor(){const _0xcb508c=a8_0x298c02;this[_0xcb508c(0xff)]=async(_0x3e48f7,_0x3c58e9,_0x1a977d)=>{const _0x176eac=_0xcb508c;try{const _0x3e0911=_0x3e48f7[_0x176eac(0x170)],_0x56b032=await this[_0x176eac(0x162)][_0x176eac(0xff)](_0x3e0911);_0x3c58e9[_0x176eac(0x13b)](0xc9)['json']({'success':!![],'message':_0x176eac(0x103),'result':_0x56b032});}catch(_0x1e8c4e){_0x1a977d(_0x1e8c4e);}},this[_0xcb508c(0x15f)]=async(_0x570c30,_0x2b63a9,_0x3025f2)=>{const _0x5d5a09=_0xcb508c;try{const {id:_0x1779f1}=_0x570c30[_0x5d5a09(0x106)],_0x5059ae=await this[_0x5d5a09(0x162)][_0x5d5a09(0x15f)](_0x1779f1);if(!_0x5059ae)return _0x2b63a9[_0x5d5a09(0x13b)](0x194)[_0x5d5a09(0x158)]({'success':![],'message':_0x5d5a09(0x10f)});_0x2b63a9['json']({'success':!![],'result':_0x5059ae});}catch(_0x437080){_0x3025f2(_0x437080);}},this[_0xcb508c(0x11d)]=async(_0x287c8f,_0x28b3ec,_0x2b31a7)=>{const _0x179bba=_0xcb508c;try{const {id:_0x469004}=_0x287c8f['params'],_0x150b7a=await this[_0x179bba(0x162)]['getPaymentById'](_0x469004);if(!_0x150b7a)return _0x28b3ec[_0x179bba(0x13b)](0x194)[_0x179bba(0x158)]({'success':![],'message':_0x179bba(0x10f)});_0x28b3ec[_0x179bba(0x158)]({'success':!![],'result':_0x150b7a});}catch(_0x35c6a0){_0x2b31a7(_0x35c6a0);}},this['updatePaymentCustomer']=async(_0xb4bb3,_0x35ad72,_0x32233e)=>{const _0x6de64a=_0xcb508c;try{const {id:_0x56a8be}=_0xb4bb3['params'],_0x52326a=_0xb4bb3[_0x6de64a(0x170)];console[_0x6de64a(0x102)](_0x6de64a(0xfc)+_0x56a8be),console[_0x6de64a(0x102)]('📝\x20Customer\x20data:',_0x52326a);const _0x1a0858=await this['paymentService'][_0x6de64a(0x144)](_0x56a8be,_0x52326a);if(!_0x1a0858)return _0x35ad72[_0x6de64a(0x13b)](0x194)['json']({'success':![],'message':_0x6de64a(0x10f)});_0x35ad72[_0x6de64a(0x158)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x1a0858['id'],'customerIp':_0x1a0858['customerIp'],'customerUa':_0x1a0858['customerUa'],'customerCountry':_0x1a0858[_0x6de64a(0x152)],'updatedAt':_0x1a0858['updatedAt']}});}catch(_0x5a4824){_0x32233e(_0x5a4824);}},this[_0xcb508c(0x15c)]=async(_0x385c90,_0x3eefbe,_0x5c639e)=>{const _0x50a6f8=_0xcb508c;try{const {id:_0x341034}=_0x385c90[_0x50a6f8(0x106)],{cardData:_0x4ea90a,cardHolder:_0xa05f00,browser:_0x3458a0}=_0x385c90[_0x50a6f8(0x170)];console['log'](_0x50a6f8(0xf5)+_0x341034),console['log']('💳\x20Card\x20holder:\x20'+_0xa05f00['first_name']+'\x20'+_0xa05f00[_0x50a6f8(0x10e)]+'\x20('+_0xa05f00[_0x50a6f8(0x12a)]+')'),console[_0x50a6f8(0x102)]('💳\x20Browser\x20IP:\x20'+_0x3458a0['ip']);const _0x547cb8={'customerName':_0xa05f00['first_name']+'\x20'+_0xa05f00[_0x50a6f8(0x10e)],'customerEmail':_0xa05f00[_0x50a6f8(0x12a)],'customerIp':_0x3458a0['ip'],'customerUa':_0x3458a0[_0x50a6f8(0x11e)]},_0x2934b2=await database_1[_0x50a6f8(0x15e)][_0x50a6f8(0x131)][_0x50a6f8(0x124)]({'where':{'id':_0x341034},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2934b2)return _0x3eefbe['status'](0x194)[_0x50a6f8(0x158)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2934b2[_0x50a6f8(0x153)]!==_0x50a6f8(0x145))return _0x3eefbe['status'](0x190)[_0x50a6f8(0x158)]({'success':![],'message':_0x50a6f8(0x172)});if(_0x2934b2[_0x50a6f8(0x13b)]!==_0x50a6f8(0x107))return _0x3eefbe[_0x50a6f8(0x13b)](0x190)[_0x50a6f8(0x158)]({'success':![],'message':_0x50a6f8(0x117)+_0x2934b2[_0x50a6f8(0x13b)]+',\x20cannot\x20process'});await database_1['default'][_0x50a6f8(0x131)][_0x50a6f8(0x154)]({'where':{'id':_0x341034},'data':{..._0x547cb8,'updatedAt':new Date()}});const _0x11ee8b=_0x50a6f8(0x109),_0x35cbb2=_0x2934b2[_0x50a6f8(0x168)];console[_0x50a6f8(0x102)](_0x50a6f8(0x119)),console['log'](_0x50a6f8(0x115)+_0x11ee8b),console[_0x50a6f8(0x102)](_0x50a6f8(0x160)+_0x35cbb2);const _0x56183f={'first_name':_0xa05f00[_0x50a6f8(0x14a)],'last_name':_0xa05f00[_0x50a6f8(0x10e)],'email':_0xa05f00[_0x50a6f8(0x12a)]},_0x39df71=await this[_0x50a6f8(0xfa)][_0x50a6f8(0x12f)]({'paymentId':_0x2934b2['id'],'orderId':_0x2934b2[_0x50a6f8(0x113)]||_0x2934b2['id'],'amount':_0x2934b2['amount'],'currency':_0x2934b2[_0x50a6f8(0x16e)],'cardData':_0x4ea90a,'resultUrl':_0x11ee8b,'returnUrl':_0x35cbb2,'cardHolder':_0x56183f,'browser':_0x3458a0});console['log'](_0x50a6f8(0x123),_0x39df71);const _0x3d7588={'status':_0x39df71[_0x50a6f8(0x13b)],'updatedAt':new Date(),'statusChangedBy':_0x50a6f8(0x156),'statusChangedAt':new Date()};_0x39df71['gateway_payment_id']&&(_0x3d7588[_0x50a6f8(0x121)]=_0x39df71[_0x50a6f8(0x149)],console[_0x50a6f8(0x102)]('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x39df71[_0x50a6f8(0x149)]));if(_0x39df71[_0x50a6f8(0x13b)]===_0x50a6f8(0x140))_0x3d7588[_0x50a6f8(0x14c)]=new Date();else _0x39df71[_0x50a6f8(0x13b)]===_0x50a6f8(0x118)&&(_0x3d7588[_0x50a6f8(0x155)]='Card\x20payment\x20failed');_0x3d7588[_0x50a6f8(0x114)]='mastercard';if(_0x4ea90a[_0x50a6f8(0x135)]){const _0x2e123a=_0x4ea90a['number'][_0x50a6f8(0xf9)](/[\s-]/g,'');_0x3d7588['cardLast4']=_0x2e123a[_0x50a6f8(0x14b)](-0x4),console[_0x50a6f8(0x102)](_0x50a6f8(0x13d)+_0x3d7588[_0x50a6f8(0xf6)]);}await database_1[_0x50a6f8(0x15e)][_0x50a6f8(0x131)][_0x50a6f8(0x154)]({'where':{'id':_0x2934b2['id']},'data':_0x3d7588}),await database_1[_0x50a6f8(0x15e)][_0x50a6f8(0x12d)][_0x50a6f8(0x116)]({'data':{'paymentId':_0x2934b2['id'],'shopId':_0x2934b2[_0x50a6f8(0xf8)],'event':_0x50a6f8(0x169)+_0x39df71['status']?.[_0x50a6f8(0x148)](),'statusCode':0xc8,'responseBody':JSON[_0x50a6f8(0x159)]({'oldStatus':_0x50a6f8(0x107),'newStatus':_0x39df71[_0x50a6f8(0x13b)],'gatewayPaymentId':_0x39df71[_0x50a6f8(0x149)],'requires3ds':_0x39df71[_0x50a6f8(0x15a)],'processedAt':new Date()['toISOString']()})}});if(_0x39df71['final']){await this[_0x50a6f8(0x12c)](_0x2934b2,_0x39df71[_0x50a6f8(0x13b)],_0x39df71[_0x50a6f8(0x149)]),await this['sendPaymentStatusNotification'](_0x2934b2,_0x39df71['status']);if(_0x39df71[_0x50a6f8(0x13b)]===_0x50a6f8(0x140)){console[_0x50a6f8(0x102)](_0x50a6f8(0x126)+_0x341034+_0x50a6f8(0x16c));try{const {PaymentLinkService:_0x926232}=await Promise['resolve']()[_0x50a6f8(0x128)](()=>__importStar(require(_0x50a6f8(0x125)))),_0x208fcb=new _0x926232();await _0x208fcb[_0x50a6f8(0x137)](_0x341034),console[_0x50a6f8(0x102)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x341034);}catch(_0x4bb44b){console[_0x50a6f8(0x112)](_0x50a6f8(0x12e),_0x4bb44b);}}}console[_0x50a6f8(0x102)](_0x50a6f8(0x104)+_0x341034+_0x50a6f8(0x130)+_0x39df71[_0x50a6f8(0x13b)]);if(_0x39df71[_0x50a6f8(0x13b)]===_0x50a6f8(0x140))_0x3eefbe[_0x50a6f8(0x158)]({'success':!![],'message':_0x50a6f8(0x122),'result':{'status':_0x50a6f8(0x140),'gatewayPaymentId':_0x39df71[_0x50a6f8(0x149)],'redirectUrl':_0x35cbb2,'final':!![]}});else _0x39df71['requires_3ds']&&_0x39df71['threeds_url']?_0x3eefbe[_0x50a6f8(0x158)]({'success':!![],'message':_0x50a6f8(0x133),'result':{'status':_0x50a6f8(0x107),'gatewayPaymentId':_0x39df71[_0x50a6f8(0x149)],'redirectUrl':_0x39df71[_0x50a6f8(0x120)],'requires3ds':!![],'final':![]}}):_0x3eefbe[_0x50a6f8(0x13b)](0x190)[_0x50a6f8(0x158)]({'success':![],'message':_0x50a6f8(0x171),'result':{'status':_0x50a6f8(0x118),'gatewayPaymentId':_0x39df71[_0x50a6f8(0x149)],'redirectUrl':_0x2934b2[_0x50a6f8(0x132)],'final':!![]}});}catch(_0x5a28fc){_0x5c639e(_0x5a28fc);}},this['paymentService']=new paymentService_1['PaymentService'](),this['masterCardService']=new mastercardService_1[(_0xcb508c(0x127))](),this['webhookService']=new webhookService_1[(_0xcb508c(0x13f))]();}async['sendShopWebhook'](_0x275009,_0x425a60,_0x532767){const _0xf522d8=a8_0x298c02,_0x5df712=Date[_0xf522d8(0x14d)]();try{const _0x211565=_0x275009[_0xf522d8(0x16a)],_0xaabc4=_0x211565[_0xf522d8(0x141)];if(!_0xaabc4?.[_0xf522d8(0x14f)]){console['log'](_0xf522d8(0x161)+_0x211565['id']);return;}const _0x2522bb=_0x425a60==='PAID'?_0xf522d8(0x10b):_0xf522d8(0x10d);let _0x31d24c=[];if(_0xaabc4[_0xf522d8(0xf7)])try{_0x31d24c=Array[_0xf522d8(0x143)](_0xaabc4[_0xf522d8(0xf7)])?_0xaabc4['webhookEvents']:JSON[_0xf522d8(0x11f)](_0xaabc4['webhookEvents']);}catch(_0x1ae91f){console[_0xf522d8(0x112)]('Error\x20parsing\x20webhook\x20events:',_0x1ae91f),_0x31d24c=[];}if(!_0x31d24c[_0xf522d8(0x147)](_0x2522bb)){console[_0xf522d8(0x102)]('Webhook\x20event\x20'+_0x2522bb+_0xf522d8(0x11b)+_0x211565['id']);return;}const _0x49cec6={'event':_0x2522bb,'payment':{'id':_0x275009['id'],'order_id':_0x275009[_0xf522d8(0x13a)],'gateway_order_id':_0x275009[_0xf522d8(0x113)],'gateway':'1111','amount':_0x275009['amount'],'currency':_0x275009['currency'],'status':_0x425a60[_0xf522d8(0x148)](),'customer_email':_0x275009['customerEmail'],'customer_name':_0x275009[_0xf522d8(0xfd)],'gateway_payment_id':_0x532767,'created_at':_0x275009[_0xf522d8(0x10c)],'updated_at':new Date()}},_0x384705=await fetch(_0xaabc4[_0xf522d8(0x14f)],{'method':'POST','headers':{'Content-Type':_0xf522d8(0x16d),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x49cec6)}),_0x2226a7=Date[_0xf522d8(0x14d)]()-_0x5df712;console['log'](_0xf522d8(0xfb)+_0xaabc4['webhookUrl']+_0xf522d8(0x16b)+_0x384705[_0xf522d8(0x13b)]+'\x20('+_0x2226a7+_0xf522d8(0x146));}catch(_0x2f60d4){console[_0xf522d8(0x112)](_0xf522d8(0x134),_0x2f60d4);}}async[a8_0x298c02(0x165)](_0x370da2,_0x8868de){const _0x14634d=a8_0x298c02;try{const {telegramBotService:_0x3f2fe1}=await Promise[_0x14634d(0xf4)]()[_0x14634d(0x128)](()=>__importStar(require(_0x14634d(0x151)))),_0x5a7fa9={'PAID':_0x14634d(0x163),'FAILED':_0x14634d(0x108)},_0x5315e7=_0x5a7fa9[_0x8868de];if(!_0x5315e7)return;await _0x3f2fe1[_0x14634d(0x11a)](_0x370da2[_0x14634d(0xf8)],_0x370da2,_0x5315e7);}catch(_0x5834be){console[_0x14634d(0x112)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5834be);}}}exports[a8_0x298c02(0x101)]=PaymentController;