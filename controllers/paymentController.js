'use strict';const a8_0x2c2280=a8_0x55ba;function a8_0x55ba(_0x15ff0a,_0x4d7328){const _0x2c06b0=a8_0x2c06();return a8_0x55ba=function(_0x55ba93,_0x1ce89a){_0x55ba93=_0x55ba93-0x155;let _0x387d7f=_0x2c06b0[_0x55ba93];return _0x387d7f;},a8_0x55ba(_0x15ff0a,_0x4d7328);}(function(_0x3f46a0,_0x3c4627){const _0x14d57a=a8_0x55ba,_0x21ce75=_0x3f46a0();while(!![]){try{const _0x2730ae=-parseInt(_0x14d57a(0x169))/0x1*(parseInt(_0x14d57a(0x182))/0x2)+-parseInt(_0x14d57a(0x1ca))/0x3*(parseInt(_0x14d57a(0x199))/0x4)+-parseInt(_0x14d57a(0x1d7))/0x5*(parseInt(_0x14d57a(0x174))/0x6)+parseInt(_0x14d57a(0x18d))/0x7+-parseInt(_0x14d57a(0x1b9))/0x8*(parseInt(_0x14d57a(0x189))/0x9)+-parseInt(_0x14d57a(0x1d0))/0xa*(-parseInt(_0x14d57a(0x198))/0xb)+parseInt(_0x14d57a(0x1bb))/0xc*(parseInt(_0x14d57a(0x159))/0xd);if(_0x2730ae===_0x3c4627)break;else _0x21ce75['push'](_0x21ce75['shift']());}catch(_0x192c03){_0x21ce75['push'](_0x21ce75['shift']());}}}(a8_0x2c06,0xafa33));function a8_0x2c06(){const _0x540c0c=['writable','PAID','updatePaymentCustomer','gatewayOrderId','../config/database','../services/paymentLinkService','replace','52MNcVDJ','failed','✅\x20MasterCard\x20payment\x20','ms)','error','toLowerCase','getPaymentStatus','633384nARiRY','successUrl','default','PENDING','1847279YLjltU','PaymentService','https://api.trapay.uk/api/webhooks/gateway/mastercard','params','__createBinding','Customer\x20data\x20updated\x20successfully','log','settings','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Webhook\x20event\x20','__esModule','407VXIUjz','262348utHglw','sendPaymentStatusNotification','__importDefault','processCardPayment','resolve','📈\x20MasterCard\x20payment\x20','user_agent','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','POST','email','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','\x20\x20\x20Return\x20URL:\x20','Card\x20payment\x20failed','then','body','orderId','1111','requires_3ds','parse','call','MasterCard\x20webhook\x20sent\x20to\x20',',\x20cannot\x20process','includes','defineProperty','\x20with\x20status\x20','processMasterCardPayment','paymentService','../services/webhookService','updatedAt','customerCountry','failUrl','getPaymentById','48cEMQLH','gatewayPaymentId','74748gucDyC','Payment\x20created\x20successfully','stringify','sendShopWebhook','Payment\x20not\x20found','gateway_payment_id','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','webhookEvents','paymentMethod','slice','../services/paymentService','hasOwnProperty','length','payment','../services/gateways/mastercardService','33OADwtw','../services/telegramBotService','configurable','PaymentController','final','mastercard','96130RukefZ','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','webhookLog','create','json','status','FAILED','3116770kNwKZc','Failed\x20to\x20send\x20MasterCard\x20webhook:','now','amount','💳\x20MasterCard\x20result:','masterCardService','💳\x20MasterCard\x20URLs:','6058dssvpt','number','createPublicPayment','\x20processed:\x20','__setModuleDefault','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','cardLast4','customerName','Payment\x20failed','application/json','WebhookService','Payment\x20processed\x20successfully','webhookUrl','3DS\x20verification\x20required','💳\x20Card\x20holder:\x20','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','39839excVVB','currency','threeds_url','payment.success','first_name','Error\x20parsing\x20webhook\x20events:','\x20not\x20enabled\x20for\x20shop\x20','shop','sendPaymentNotification','last_name','shopId','6GzrVKe','updatePaymentCustomerDataPublic','system','💳\x20Browser\x20IP:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','get','handleSuccessfulPayment'];a8_0x2c06=function(){return _0x540c0c;};return a8_0x2c06();}var __createBinding=this&&this[a8_0x2c2280(0x191)]||(Object[a8_0x2c2280(0x1d3)]?function(_0x23f444,_0x1679c6,_0x297031,_0x3c02c6){const _0x4b7e79=a8_0x2c2280;if(_0x3c02c6===undefined)_0x3c02c6=_0x297031;var _0xfafeb2=Object['getOwnPropertyDescriptor'](_0x1679c6,_0x297031);(!_0xfafeb2||(_0x4b7e79(0x179)in _0xfafeb2?!_0x1679c6[_0x4b7e79(0x197)]:_0xfafeb2[_0x4b7e79(0x17b)]||_0xfafeb2[_0x4b7e79(0x1cc)]))&&(_0xfafeb2={'enumerable':!![],'get':function(){return _0x1679c6[_0x297031];}}),Object[_0x4b7e79(0x1b0)](_0x23f444,_0x3c02c6,_0xfafeb2);}:function(_0x1edcca,_0x10761a,_0x3cfe3e,_0x321126){if(_0x321126===undefined)_0x321126=_0x3cfe3e;_0x1edcca[_0x321126]=_0x10761a[_0x3cfe3e];}),__setModuleDefault=this&&this[a8_0x2c2280(0x15d)]||(Object[a8_0x2c2280(0x1d3)]?function(_0x459ace,_0x3399aa){const _0x4b519a=a8_0x2c2280;Object['defineProperty'](_0x459ace,_0x4b519a(0x18b),{'enumerable':!![],'value':_0x3399aa});}:function(_0x4c0325,_0x202d0e){_0x4c0325['default']=_0x202d0e;}),__importStar=this&&this['__importStar']||(function(){var _0x5346ad=function(_0x5b9a0c){return _0x5346ad=Object['getOwnPropertyNames']||function(_0x19afa){const _0x52e208=a8_0x55ba;var _0x320636=[];for(var _0x2e0db4 in _0x19afa)if(Object['prototype'][_0x52e208(0x1c6)][_0x52e208(0x1ac)](_0x19afa,_0x2e0db4))_0x320636[_0x320636[_0x52e208(0x1c7)]]=_0x2e0db4;return _0x320636;},_0x5346ad(_0x5b9a0c);};return function(_0x551167){const _0x5e0517=a8_0x55ba;if(_0x551167&&_0x551167[_0x5e0517(0x197)])return _0x551167;var _0x2b6fef={};if(_0x551167!=null){for(var _0x2c5e2d=_0x5346ad(_0x551167),_0xa87a5b=0x0;_0xa87a5b<_0x2c5e2d['length'];_0xa87a5b++)if(_0x2c5e2d[_0xa87a5b]!==_0x5e0517(0x18b))__createBinding(_0x2b6fef,_0x551167,_0x2c5e2d[_0xa87a5b]);}return __setModuleDefault(_0x2b6fef,_0x551167),_0x2b6fef;};}()),__importDefault=this&&this[a8_0x2c2280(0x19b)]||function(_0x4cd41c){const _0x47461c=a8_0x2c2280;return _0x4cd41c&&_0x4cd41c[_0x47461c(0x197)]?_0x4cd41c:{'default':_0x4cd41c};};Object['defineProperty'](exports,a8_0x2c2280(0x197),{'value':!![]}),exports[a8_0x2c2280(0x1cd)]=void 0x0;const paymentService_1=require(a8_0x2c2280(0x1c5)),mastercardService_1=require(a8_0x2c2280(0x1c9)),webhookService_1=require(a8_0x2c2280(0x1b4)),database_1=__importDefault(require(a8_0x2c2280(0x17f)));class PaymentController{constructor(){const _0x785e1e=a8_0x2c2280;this[_0x785e1e(0x15b)]=async(_0xab03b1,_0x5dd626,_0x1f7c28)=>{const _0xea8ae3=_0x785e1e;try{const _0x250b8a=_0xab03b1[_0xea8ae3(0x1a7)],_0x35622f=await this[_0xea8ae3(0x1b3)][_0xea8ae3(0x15b)](_0x250b8a);_0x5dd626[_0xea8ae3(0x1d5)](0xc9)[_0xea8ae3(0x1d4)]({'success':!![],'message':_0xea8ae3(0x1bc),'result':_0x35622f});}catch(_0x42d70f){_0x1f7c28(_0x42d70f);}},this[_0x785e1e(0x188)]=async(_0x1ed286,_0x330bc2,_0x1aa7b1)=>{const _0xfeb56=_0x785e1e;try{const {id:_0x4e2ad2}=_0x1ed286[_0xfeb56(0x190)],_0x200a6b=await this[_0xfeb56(0x1b3)][_0xfeb56(0x188)](_0x4e2ad2);if(!_0x200a6b)return _0x330bc2[_0xfeb56(0x1d5)](0x194)[_0xfeb56(0x1d4)]({'success':![],'message':_0xfeb56(0x1bf)});_0x330bc2['json']({'success':!![],'result':_0x200a6b});}catch(_0x3f8ef8){_0x1aa7b1(_0x3f8ef8);}},this[_0x785e1e(0x1b8)]=async(_0x405ca4,_0x161ce5,_0x392821)=>{const _0x203e61=_0x785e1e;try{const {id:_0x3dd3d3}=_0x405ca4[_0x203e61(0x190)],_0xd24cff=await this[_0x203e61(0x1b3)]['getPaymentById'](_0x3dd3d3);if(!_0xd24cff)return _0x161ce5['status'](0x194)[_0x203e61(0x1d4)]({'success':![],'message':_0x203e61(0x1bf)});_0x161ce5[_0x203e61(0x1d4)]({'success':!![],'result':_0xd24cff});}catch(_0x565b26){_0x392821(_0x565b26);}},this[_0x785e1e(0x17d)]=async(_0x30fc94,_0x5f3a3a,_0x2cf260)=>{const _0x4f2ccb=_0x785e1e;try{const {id:_0x31b5b9}=_0x30fc94['params'],_0x7f3596=_0x30fc94['body'];console[_0x4f2ccb(0x193)](_0x4f2ccb(0x1c1)+_0x31b5b9),console[_0x4f2ccb(0x193)]('📝\x20Customer\x20data:',_0x7f3596);const _0x154a60=await this[_0x4f2ccb(0x1b3)][_0x4f2ccb(0x175)](_0x31b5b9,_0x7f3596);if(!_0x154a60)return _0x5f3a3a[_0x4f2ccb(0x1d5)](0x194)[_0x4f2ccb(0x1d4)]({'success':![],'message':_0x4f2ccb(0x1bf)});_0x5f3a3a[_0x4f2ccb(0x1d4)]({'success':!![],'message':_0x4f2ccb(0x192),'result':{'paymentId':_0x154a60['id'],'customerIp':_0x154a60['customerIp'],'customerUa':_0x154a60['customerUa'],'customerCountry':_0x154a60[_0x4f2ccb(0x1b6)],'updatedAt':_0x154a60[_0x4f2ccb(0x1b5)]}});}catch(_0x2937c3){_0x2cf260(_0x2937c3);}},this[_0x785e1e(0x1b2)]=async(_0xcadcaf,_0x441bd5,_0xc1679b)=>{const _0x37414f=_0x785e1e;try{const {id:_0x5bcda8}=_0xcadcaf[_0x37414f(0x190)],{cardData:_0x3c905c,cardHolder:_0x1a86b7,browser:_0x244398}=_0xcadcaf['body'];console[_0x37414f(0x193)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x5bcda8),console[_0x37414f(0x193)](_0x37414f(0x167)+_0x1a86b7[_0x37414f(0x16d)]+'\x20'+_0x1a86b7[_0x37414f(0x172)]+'\x20('+_0x1a86b7[_0x37414f(0x1a2)]+')'),console['log'](_0x37414f(0x177)+_0x244398['ip']);const _0x53eeeb={'customerName':_0x1a86b7[_0x37414f(0x16d)]+'\x20'+_0x1a86b7[_0x37414f(0x172)],'customerEmail':_0x1a86b7[_0x37414f(0x1a2)],'customerIp':_0x244398['ip'],'customerUa':_0x244398[_0x37414f(0x19f)]},_0x5aa396=await database_1[_0x37414f(0x18b)][_0x37414f(0x1c8)]['findUnique']({'where':{'id':_0x5bcda8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5aa396)return _0x441bd5[_0x37414f(0x1d5)](0x194)[_0x37414f(0x1d4)]({'success':![],'message':_0x37414f(0x1bf)});if(_0x5aa396['gateway']!=='mastercard')return _0x441bd5[_0x37414f(0x1d5)](0x190)[_0x37414f(0x1d4)]({'success':![],'message':_0x37414f(0x15e)});if(_0x5aa396[_0x37414f(0x1d5)]!==_0x37414f(0x18c))return _0x441bd5[_0x37414f(0x1d5)](0x190)[_0x37414f(0x1d4)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5aa396[_0x37414f(0x1d5)]+_0x37414f(0x1ae)});await database_1['default'][_0x37414f(0x1c8)]['update']({'where':{'id':_0x5bcda8},'data':{..._0x53eeeb,'updatedAt':new Date()}});const _0x342cf5=_0x37414f(0x18f),_0x116342=_0x5aa396[_0x37414f(0x18a)];console[_0x37414f(0x193)](_0x37414f(0x158)),console[_0x37414f(0x193)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x342cf5),console[_0x37414f(0x193)](_0x37414f(0x1a4)+_0x116342);const _0x1b845c={'first_name':_0x1a86b7['first_name'],'last_name':_0x1a86b7[_0x37414f(0x172)],'email':_0x1a86b7['email']},_0x2dc0ac=await this[_0x37414f(0x157)][_0x37414f(0x19c)]({'paymentId':_0x5aa396['id'],'orderId':_0x5aa396[_0x37414f(0x17e)]||_0x5aa396['id'],'amount':_0x5aa396[_0x37414f(0x155)],'currency':_0x5aa396['currency'],'cardData':_0x3c905c,'resultUrl':_0x342cf5,'returnUrl':_0x116342,'cardHolder':_0x1b845c,'browser':_0x244398});console[_0x37414f(0x193)](_0x37414f(0x156),_0x2dc0ac);const _0x2aa605={'status':_0x2dc0ac[_0x37414f(0x1d5)],'updatedAt':new Date(),'statusChangedBy':_0x37414f(0x176),'statusChangedAt':new Date()};_0x2dc0ac[_0x37414f(0x1c0)]&&(_0x2aa605[_0x37414f(0x1ba)]=_0x2dc0ac['gateway_payment_id'],console[_0x37414f(0x193)](_0x37414f(0x1a3)+_0x2dc0ac[_0x37414f(0x1c0)]));if(_0x2dc0ac['status']==='PAID')_0x2aa605['paidAt']=new Date();else _0x2dc0ac[_0x37414f(0x1d5)]===_0x37414f(0x1d6)&&(_0x2aa605['failureMessage']=_0x37414f(0x1a5));_0x2aa605[_0x37414f(0x1c3)]=_0x37414f(0x1cf);if(_0x3c905c['number']){const _0x3b9a99=_0x3c905c[_0x37414f(0x15a)][_0x37414f(0x181)](/[\s-]/g,'');_0x2aa605['cardLast4']=_0x3b9a99[_0x37414f(0x1c4)](-0x4),console[_0x37414f(0x193)](_0x37414f(0x1a0)+_0x2aa605[_0x37414f(0x15f)]);}await database_1[_0x37414f(0x18b)]['payment']['update']({'where':{'id':_0x5aa396['id']},'data':_0x2aa605}),await database_1['default'][_0x37414f(0x1d2)][_0x37414f(0x1d3)]({'data':{'paymentId':_0x5aa396['id'],'shopId':_0x5aa396[_0x37414f(0x173)],'event':'mastercard_'+_0x2dc0ac[_0x37414f(0x1d5)]?.[_0x37414f(0x187)](),'statusCode':0xc8,'responseBody':JSON[_0x37414f(0x1bd)]({'oldStatus':_0x37414f(0x18c),'newStatus':_0x2dc0ac[_0x37414f(0x1d5)],'gatewayPaymentId':_0x2dc0ac['gateway_payment_id'],'requires3ds':_0x2dc0ac[_0x37414f(0x1aa)],'processedAt':new Date()['toISOString']()})}});if(_0x2dc0ac[_0x37414f(0x1ce)]){await this[_0x37414f(0x1be)](_0x5aa396,_0x2dc0ac[_0x37414f(0x1d5)],_0x2dc0ac[_0x37414f(0x1c0)]),await this[_0x37414f(0x19a)](_0x5aa396,_0x2dc0ac['status']);if(_0x2dc0ac['status']==='PAID'){console['log'](_0x37414f(0x19e)+_0x5bcda8+_0x37414f(0x195));try{const {PaymentLinkService:_0x235725}=await Promise[_0x37414f(0x19d)]()[_0x37414f(0x1a6)](()=>__importStar(require(_0x37414f(0x180)))),_0x1bc4f3=new _0x235725();await _0x1bc4f3[_0x37414f(0x17a)](_0x5bcda8),console[_0x37414f(0x193)](_0x37414f(0x168)+_0x5bcda8);}catch(_0x55aeb4){console['error'](_0x37414f(0x1d1),_0x55aeb4);}}}console['log'](_0x37414f(0x184)+_0x5bcda8+_0x37414f(0x15c)+_0x2dc0ac[_0x37414f(0x1d5)]);if(_0x2dc0ac['status']==='PAID')_0x441bd5[_0x37414f(0x1d4)]({'success':!![],'message':_0x37414f(0x164),'result':{'status':_0x37414f(0x17c),'gatewayPaymentId':_0x2dc0ac[_0x37414f(0x1c0)],'redirectUrl':_0x116342,'final':!![]}});else _0x2dc0ac['requires_3ds']&&_0x2dc0ac[_0x37414f(0x16b)]?_0x441bd5[_0x37414f(0x1d4)]({'success':!![],'message':_0x37414f(0x166),'result':{'status':_0x37414f(0x18c),'gatewayPaymentId':_0x2dc0ac[_0x37414f(0x1c0)],'redirectUrl':_0x2dc0ac[_0x37414f(0x16b)],'requires3ds':!![],'final':![]}}):_0x441bd5[_0x37414f(0x1d5)](0x190)[_0x37414f(0x1d4)]({'success':![],'message':_0x37414f(0x161),'result':{'status':_0x37414f(0x1d6),'gatewayPaymentId':_0x2dc0ac[_0x37414f(0x1c0)],'redirectUrl':_0x5aa396[_0x37414f(0x1b7)],'final':!![]}});}catch(_0x5bda2d){_0xc1679b(_0x5bda2d);}},this[_0x785e1e(0x1b3)]=new paymentService_1[(_0x785e1e(0x18e))](),this[_0x785e1e(0x157)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0x785e1e(0x163))]();}async[a8_0x2c2280(0x1be)](_0x59ea94,_0x3c0a7c,_0x265131){const _0x4337d8=a8_0x2c2280,_0x1c2e3a=Date['now']();try{const _0x533152=_0x59ea94[_0x4337d8(0x170)],_0x2c6796=_0x533152[_0x4337d8(0x194)];if(!_0x2c6796?.[_0x4337d8(0x165)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x533152['id']);return;}const _0xafb0cb=_0x3c0a7c===_0x4337d8(0x17c)?_0x4337d8(0x16c):'payment.failed';let _0x4344bf=[];if(_0x2c6796[_0x4337d8(0x1c2)])try{_0x4344bf=Array['isArray'](_0x2c6796[_0x4337d8(0x1c2)])?_0x2c6796['webhookEvents']:JSON[_0x4337d8(0x1ab)](_0x2c6796[_0x4337d8(0x1c2)]);}catch(_0x4a3f3c){console[_0x4337d8(0x186)](_0x4337d8(0x16e),_0x4a3f3c),_0x4344bf=[];}if(!_0x4344bf[_0x4337d8(0x1af)](_0xafb0cb)){console[_0x4337d8(0x193)](_0x4337d8(0x196)+_0xafb0cb+_0x4337d8(0x16f)+_0x533152['id']);return;}const _0x21737d={'event':_0xafb0cb,'payment':{'id':_0x59ea94['id'],'order_id':_0x59ea94[_0x4337d8(0x1a8)],'gateway_order_id':_0x59ea94[_0x4337d8(0x17e)],'gateway':_0x4337d8(0x1a9),'amount':_0x59ea94[_0x4337d8(0x155)],'currency':_0x59ea94[_0x4337d8(0x16a)],'status':_0x3c0a7c['toLowerCase'](),'customer_email':_0x59ea94['customerEmail'],'customer_name':_0x59ea94[_0x4337d8(0x160)],'gateway_payment_id':_0x265131,'created_at':_0x59ea94['createdAt'],'updated_at':new Date()}},_0x2cc447=await fetch(_0x2c6796[_0x4337d8(0x165)],{'method':_0x4337d8(0x1a1),'headers':{'Content-Type':_0x4337d8(0x162),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x4337d8(0x1bd)](_0x21737d)}),_0xe06bf6=Date[_0x4337d8(0x1d9)]()-_0x1c2e3a;console[_0x4337d8(0x193)](_0x4337d8(0x1ad)+_0x2c6796[_0x4337d8(0x165)]+_0x4337d8(0x1b1)+_0x2cc447[_0x4337d8(0x1d5)]+'\x20('+_0xe06bf6+_0x4337d8(0x185));}catch(_0x209cf0){console['error'](_0x4337d8(0x1d8),_0x209cf0);}}async[a8_0x2c2280(0x19a)](_0x3d8237,_0x3bdc77){const _0x8088c2=a8_0x2c2280;try{const {telegramBotService:_0x466720}=await Promise[_0x8088c2(0x19d)]()['then'](()=>__importStar(require(_0x8088c2(0x1cb)))),_0x39dc15={'PAID':'paid','FAILED':_0x8088c2(0x183)},_0x4ed85a=_0x39dc15[_0x3bdc77];if(!_0x4ed85a)return;await _0x466720[_0x8088c2(0x171)](_0x3d8237['shopId'],_0x3d8237,_0x4ed85a);}catch(_0x338134){console['error'](_0x8088c2(0x178),_0x338134);}}}exports[a8_0x2c2280(0x1cd)]=PaymentController;