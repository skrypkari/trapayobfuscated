'use strict';const a8_0x565965=a8_0x2d42;function a8_0x2d42(_0x256bb2,_0xa641e5){const _0x3dd311=a8_0x3dd3();return a8_0x2d42=function(_0x2d428c,_0x56b05f){_0x2d428c=_0x2d428c-0x19d;let _0x20bdd0=_0x3dd311[_0x2d428c];return _0x20bdd0;},a8_0x2d42(_0x256bb2,_0xa641e5);}(function(_0x472b39,_0x5d98fa){const _0x1f74cd=a8_0x2d42,_0x112d99=_0x472b39();while(!![]){try{const _0x4b1644=parseInt(_0x1f74cd(0x1b1))/0x1*(-parseInt(_0x1f74cd(0x1cb))/0x2)+-parseInt(_0x1f74cd(0x1ab))/0x3+-parseInt(_0x1f74cd(0x1f0))/0x4+-parseInt(_0x1f74cd(0x1da))/0x5*(parseInt(_0x1f74cd(0x1c4))/0x6)+parseInt(_0x1f74cd(0x1f3))/0x7*(-parseInt(_0x1f74cd(0x1f6))/0x8)+parseInt(_0x1f74cd(0x19e))/0x9+parseInt(_0x1f74cd(0x215))/0xa*(parseInt(_0x1f74cd(0x1d0))/0xb);if(_0x4b1644===_0x5d98fa)break;else _0x112d99['push'](_0x112d99['shift']());}catch(_0x1b5549){_0x112d99['push'](_0x112d99['shift']());}}}(a8_0x3dd3,0x5010c));var __createBinding=this&&this[a8_0x565965(0x1b6)]||(Object[a8_0x565965(0x1e6)]?function(_0x2cf392,_0x1c4cbe,_0x5657d0,_0x27be04){const _0x3aea12=a8_0x565965;if(_0x27be04===undefined)_0x27be04=_0x5657d0;var _0x26bda6=Object['getOwnPropertyDescriptor'](_0x1c4cbe,_0x5657d0);(!_0x26bda6||(_0x3aea12(0x1e3)in _0x26bda6?!_0x1c4cbe[_0x3aea12(0x1a6)]:_0x26bda6[_0x3aea12(0x1b7)]||_0x26bda6[_0x3aea12(0x1eb)]))&&(_0x26bda6={'enumerable':!![],'get':function(){return _0x1c4cbe[_0x5657d0];}}),Object[_0x3aea12(0x1fa)](_0x2cf392,_0x27be04,_0x26bda6);}:function(_0x5be502,_0x155722,_0x19d258,_0x1db932){if(_0x1db932===undefined)_0x1db932=_0x19d258;_0x5be502[_0x1db932]=_0x155722[_0x19d258];}),__setModuleDefault=this&&this[a8_0x565965(0x210)]||(Object[a8_0x565965(0x1e6)]?function(_0xba9040,_0x5ce53d){const _0x5be0ff=a8_0x565965;Object[_0x5be0ff(0x1fa)](_0xba9040,_0x5be0ff(0x211),{'enumerable':!![],'value':_0x5ce53d});}:function(_0x558ebd,_0x3e1673){const _0x562cae=a8_0x565965;_0x558ebd[_0x562cae(0x211)]=_0x3e1673;}),__importStar=this&&this[a8_0x565965(0x1e1)]||(function(){var _0x691569=function(_0x487fec){const _0x3bcb8c=a8_0x2d42;return _0x691569=Object[_0x3bcb8c(0x1f1)]||function(_0xa16bd8){const _0x4edb8a=_0x3bcb8c;var _0x4b52a8=[];for(var _0x996c3d in _0xa16bd8)if(Object[_0x4edb8a(0x1ae)]['hasOwnProperty'][_0x4edb8a(0x1cd)](_0xa16bd8,_0x996c3d))_0x4b52a8[_0x4b52a8['length']]=_0x996c3d;return _0x4b52a8;},_0x691569(_0x487fec);};return function(_0x5715c6){const _0x33806d=a8_0x2d42;if(_0x5715c6&&_0x5715c6[_0x33806d(0x1a6)])return _0x5715c6;var _0x1ec4fd={};if(_0x5715c6!=null){for(var _0xe2aec0=_0x691569(_0x5715c6),_0xaa73d5=0x0;_0xaa73d5<_0xe2aec0[_0x33806d(0x1d7)];_0xaa73d5++)if(_0xe2aec0[_0xaa73d5]!==_0x33806d(0x211))__createBinding(_0x1ec4fd,_0x5715c6,_0xe2aec0[_0xaa73d5]);}return __setModuleDefault(_0x1ec4fd,_0x5715c6),_0x1ec4fd;};}()),__importDefault=this&&this[a8_0x565965(0x216)]||function(_0x31c89c){const _0xb1c66a=a8_0x565965;return _0x31c89c&&_0x31c89c[_0xb1c66a(0x1a6)]?_0x31c89c:{'default':_0x31c89c};};Object[a8_0x565965(0x1fa)](exports,a8_0x565965(0x1a6),{'value':!![]}),exports[a8_0x565965(0x1ac)]=void 0x0;const paymentService_1=require(a8_0x565965(0x1f5)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x565965(0x1c9)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x4b0c15=a8_0x565965;this[_0x4b0c15(0x1d1)]=async(_0x1cddc1,_0x2f75a7,_0x1556fd)=>{const _0x29b22f=_0x4b0c15;try{const _0x152417=_0x1cddc1['body'],_0x1038ab=await this[_0x29b22f(0x1c7)][_0x29b22f(0x1d1)](_0x152417);_0x2f75a7[_0x29b22f(0x1f9)](0xc9)[_0x29b22f(0x1bd)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x1038ab});}catch(_0xb2cf21){_0x1556fd(_0xb2cf21);}},this[_0x4b0c15(0x1d3)]=async(_0xa41286,_0x51f636,_0x227f84)=>{const _0x30a4d3=_0x4b0c15;try{const {id:_0x1d1c3e}=_0xa41286[_0x30a4d3(0x1bb)],_0x1ebf6d=await this[_0x30a4d3(0x1c7)][_0x30a4d3(0x1d3)](_0x1d1c3e);if(!_0x1ebf6d)return _0x51f636['status'](0x194)['json']({'success':![],'message':_0x30a4d3(0x1c6)});_0x51f636[_0x30a4d3(0x1bd)]({'success':!![],'result':_0x1ebf6d});}catch(_0x5baf70){_0x227f84(_0x5baf70);}},this['getPaymentById']=async(_0x15857c,_0x28ea2b,_0x539f16)=>{const _0x15dc78=_0x4b0c15;try{const {id:_0x16b9f2}=_0x15857c[_0x15dc78(0x1bb)],_0x13fb76=await this[_0x15dc78(0x1c7)][_0x15dc78(0x1fc)](_0x16b9f2);if(!_0x13fb76)return _0x28ea2b[_0x15dc78(0x1f9)](0x194)[_0x15dc78(0x1bd)]({'success':![],'message':_0x15dc78(0x1c6)});_0x28ea2b[_0x15dc78(0x1bd)]({'success':!![],'result':_0x13fb76});}catch(_0x252edf){_0x539f16(_0x252edf);}},this[_0x4b0c15(0x1d5)]=async(_0x59982b,_0x457b35,_0x109664)=>{const _0x102b9a=_0x4b0c15;try{const {id:_0x445e6c}=_0x59982b[_0x102b9a(0x1bb)],_0x37fd16=_0x59982b[_0x102b9a(0x1be)];console[_0x102b9a(0x1cc)](_0x102b9a(0x1d8)+_0x445e6c),console[_0x102b9a(0x1cc)]('📝\x20Customer\x20data:',_0x37fd16);const _0x1de46e=await this['paymentService'][_0x102b9a(0x1a9)](_0x445e6c,_0x37fd16);if(!_0x1de46e)return _0x457b35['status'](0x194)[_0x102b9a(0x1bd)]({'success':![],'message':_0x102b9a(0x1c6)});_0x457b35[_0x102b9a(0x1bd)]({'success':!![],'message':_0x102b9a(0x1b9),'result':{'paymentId':_0x1de46e['id'],'customerIp':_0x1de46e[_0x102b9a(0x1ed)],'customerUa':_0x1de46e['customerUa'],'customerCountry':_0x1de46e['customerCountry'],'updatedAt':_0x1de46e['updatedAt']}});}catch(_0x507f87){_0x109664(_0x507f87);}},this[_0x4b0c15(0x1db)]=async(_0x403f7b,_0x30fa57,_0x5e6270)=>{const _0x3622a3=_0x4b0c15;try{const {id:_0x3ae803}=_0x403f7b[_0x3622a3(0x1bb)],{cardData:_0x3b9b96,cardHolder:_0x4c8ebd,browser:_0x45e8ce}=_0x403f7b['body'];console['log'](_0x3622a3(0x207)+_0x3ae803),console['log']('💳\x20Card\x20holder:\x20'+_0x4c8ebd[_0x3622a3(0x1d9)]+'\x20'+_0x4c8ebd[_0x3622a3(0x205)]+'\x20('+_0x4c8ebd[_0x3622a3(0x1a5)]+')'),console[_0x3622a3(0x1cc)]('💳\x20Browser\x20IP:\x20'+_0x45e8ce['ip']);const _0x59db11={'customerName':_0x4c8ebd[_0x3622a3(0x1d9)]+'\x20'+_0x4c8ebd[_0x3622a3(0x205)],'customerEmail':_0x4c8ebd[_0x3622a3(0x1a5)],'customerIp':_0x45e8ce['ip'],'customerUa':_0x45e8ce[_0x3622a3(0x1e8)],'customerCountry':_0x4c8ebd[_0x3622a3(0x1e4)]||null},_0x2b4adc=await database_1[_0x3622a3(0x211)][_0x3622a3(0x1aa)]['findUnique']({'where':{'id':_0x3ae803},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2b4adc)return _0x30fa57[_0x3622a3(0x1f9)](0x194)[_0x3622a3(0x1bd)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2b4adc[_0x3622a3(0x1fe)]!==_0x3622a3(0x1fd))return _0x30fa57[_0x3622a3(0x1f9)](0x190)['json']({'success':![],'message':_0x3622a3(0x20d)});if(_0x2b4adc['status']!==_0x3622a3(0x200))return _0x30fa57['status'](0x190)[_0x3622a3(0x1bd)]({'success':![],'message':_0x3622a3(0x1df)+_0x2b4adc['status']+_0x3622a3(0x201)});await database_1['default'][_0x3622a3(0x1aa)][_0x3622a3(0x1b3)]({'where':{'id':_0x3ae803},'data':{..._0x59db11,'updatedAt':new Date()}});const _0x5d920e='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x3a5f32=_0x2b4adc[_0x3622a3(0x1e0)];console[_0x3622a3(0x1cc)](_0x3622a3(0x1bf)),console[_0x3622a3(0x1cc)](_0x3622a3(0x206)+_0x5d920e),console[_0x3622a3(0x1cc)]('\x20\x20\x20Return\x20URL:\x20'+_0x3a5f32);const _0x5a0cd9={'first_name':_0x4c8ebd[_0x3622a3(0x1d9)],'last_name':_0x4c8ebd[_0x3622a3(0x205)],'email':_0x4c8ebd[_0x3622a3(0x1a5)]},_0x382dba=await this[_0x3622a3(0x1ca)]['processCardPayment']({'paymentId':_0x2b4adc['id'],'orderId':_0x2b4adc[_0x3622a3(0x1c0)]||_0x2b4adc['id'],'amount':_0x2b4adc[_0x3622a3(0x1ba)],'currency':_0x2b4adc[_0x3622a3(0x1a0)],'cardData':_0x3b9b96,'resultUrl':_0x5d920e,'returnUrl':_0x3a5f32,'cardHolder':_0x5a0cd9,'browser':_0x45e8ce});console['log'](_0x3622a3(0x1ea),_0x382dba);const _0x52b542={'status':_0x382dba[_0x3622a3(0x1f9)],'updatedAt':new Date(),'statusChangedBy':_0x3622a3(0x1a4),'statusChangedAt':new Date()};_0x382dba[_0x3622a3(0x1b0)]&&(_0x52b542[_0x3622a3(0x214)]=_0x382dba['gateway_payment_id'],console[_0x3622a3(0x1cc)](_0x3622a3(0x1b5)+_0x382dba[_0x3622a3(0x1b0)]));if(_0x382dba['status']===_0x3622a3(0x1ee))_0x52b542['paidAt']=new Date();else _0x382dba[_0x3622a3(0x1f9)]===_0x3622a3(0x1c8)&&(_0x52b542['failureMessage']=_0x3622a3(0x19f));_0x52b542[_0x3622a3(0x1e2)]=_0x3622a3(0x1fd);if(_0x3b9b96['number']){const _0x547f20=_0x3b9b96['number'][_0x3622a3(0x1ef)](/[\s-]/g,'');_0x52b542[_0x3622a3(0x1ce)]=_0x547f20[_0x3622a3(0x1b4)](-0x4),console[_0x3622a3(0x1cc)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x52b542[_0x3622a3(0x1ce)]);}await database_1[_0x3622a3(0x211)][_0x3622a3(0x1aa)]['update']({'where':{'id':_0x2b4adc['id']},'data':_0x52b542}),await database_1[_0x3622a3(0x211)][_0x3622a3(0x1ec)][_0x3622a3(0x1e6)]({'data':{'paymentId':_0x2b4adc['id'],'shopId':_0x2b4adc[_0x3622a3(0x1c1)],'event':_0x3622a3(0x1ad)+_0x382dba['status']?.[_0x3622a3(0x1d6)](),'statusCode':0xc8,'responseBody':JSON[_0x3622a3(0x1a8)]({'oldStatus':_0x3622a3(0x200),'newStatus':_0x382dba[_0x3622a3(0x1f9)],'gatewayPaymentId':_0x382dba[_0x3622a3(0x1b0)],'requires3ds':_0x382dba[_0x3622a3(0x1c3)],'processedAt':new Date()[_0x3622a3(0x20a)]()})}});if(_0x382dba[_0x3622a3(0x1d2)]){await this['sendShopWebhook'](_0x2b4adc,_0x382dba[_0x3622a3(0x1f9)],_0x382dba[_0x3622a3(0x1b0)]),await this['sendPaymentStatusNotification'](_0x2b4adc,_0x382dba[_0x3622a3(0x1f9)]);if(_0x382dba['status']===_0x3622a3(0x1ee)){console[_0x3622a3(0x1cc)]('📈\x20MasterCard\x20payment\x20'+_0x3ae803+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x46e73c}=await Promise[_0x3622a3(0x1e7)]()['then'](()=>__importStar(require(_0x3622a3(0x1ff)))),_0x59b550=new _0x46e73c();await _0x59b550[_0x3622a3(0x1c5)](_0x3ae803),console[_0x3622a3(0x1cc)](_0x3622a3(0x1dc)+_0x3ae803);}catch(_0x4e5e41){console['error'](_0x3622a3(0x203),_0x4e5e41);}}}console[_0x3622a3(0x1cc)](_0x3622a3(0x1c2)+_0x3ae803+_0x3622a3(0x1e5)+_0x382dba[_0x3622a3(0x1f9)]);if(_0x382dba['status']==='PAID')_0x30fa57[_0x3622a3(0x1bd)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3622a3(0x1ee),'gatewayPaymentId':_0x382dba['gateway_payment_id'],'redirectUrl':_0x3a5f32,'final':!![]}});else _0x382dba['requires_3ds']&&_0x382dba[_0x3622a3(0x1a3)]?_0x30fa57[_0x3622a3(0x1bd)]({'success':!![],'message':_0x3622a3(0x202),'result':{'status':_0x3622a3(0x200),'gatewayPaymentId':_0x382dba['gateway_payment_id'],'redirectUrl':_0x382dba[_0x3622a3(0x1a3)],'requires3ds':!![],'final':![]}}):_0x30fa57[_0x3622a3(0x1f9)](0x190)[_0x3622a3(0x1bd)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x382dba['gateway_payment_id'],'redirectUrl':_0x2b4adc[_0x3622a3(0x204)],'final':!![]}});}catch(_0x5b2b96){_0x5e6270(_0x5b2b96);}},this[_0x4b0c15(0x1c7)]=new paymentService_1['PaymentService'](),this[_0x4b0c15(0x1ca)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0x4b0c15(0x1f8))]();}async['sendShopWebhook'](_0x4053e8,_0x1bfe2c,_0x1f6cb7){const _0x11f0d2=a8_0x565965,_0x104677=Date[_0x11f0d2(0x1cf)]();try{const _0x4c0cf0=_0x4053e8['shop'],_0x7e1e4a=_0x4c0cf0[_0x11f0d2(0x1e9)];if(!_0x7e1e4a?.[_0x11f0d2(0x1d4)]){console['log'](_0x11f0d2(0x208)+_0x4c0cf0['id']);return;}const _0x4e4d64=_0x1bfe2c===_0x11f0d2(0x1ee)?_0x11f0d2(0x1af):_0x11f0d2(0x1b2);let _0x4d7567=[];if(_0x7e1e4a[_0x11f0d2(0x19d)])try{_0x4d7567=Array[_0x11f0d2(0x20f)](_0x7e1e4a['webhookEvents'])?_0x7e1e4a['webhookEvents']:JSON['parse'](_0x7e1e4a[_0x11f0d2(0x19d)]);}catch(_0x29a6b8){console[_0x11f0d2(0x20b)]('Error\x20parsing\x20webhook\x20events:',_0x29a6b8),_0x4d7567=[];}if(!_0x4d7567[_0x11f0d2(0x1b8)](_0x4e4d64)){console[_0x11f0d2(0x1cc)](_0x11f0d2(0x209)+_0x4e4d64+_0x11f0d2(0x212)+_0x4c0cf0['id']);return;}const _0x3ea235={'event':_0x4e4d64,'payment':{'id':_0x4053e8['id'],'order_id':_0x4053e8[_0x11f0d2(0x1f4)],'gateway_order_id':_0x4053e8[_0x11f0d2(0x1c0)],'gateway':'1111','amount':_0x4053e8[_0x11f0d2(0x1ba)],'currency':_0x4053e8[_0x11f0d2(0x1a0)],'status':_0x1bfe2c[_0x11f0d2(0x1d6)](),'customer_email':_0x4053e8['customerEmail'],'customer_name':_0x4053e8['customerName'],'gateway_payment_id':_0x1f6cb7,'created_at':_0x4053e8[_0x11f0d2(0x1f2)],'updated_at':new Date()}},_0x47aeaf=await fetch(_0x7e1e4a[_0x11f0d2(0x1d4)],{'method':_0x11f0d2(0x1f7),'headers':{'Content-Type':_0x11f0d2(0x20e),'User-Agent':_0x11f0d2(0x1a1)},'body':JSON[_0x11f0d2(0x1a8)](_0x3ea235)}),_0x1be837=Date['now']()-_0x104677;console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x7e1e4a[_0x11f0d2(0x1d4)]+_0x11f0d2(0x1bc)+_0x47aeaf[_0x11f0d2(0x1f9)]+'\x20('+_0x1be837+'ms)');}catch(_0x27837b){console[_0x11f0d2(0x20b)](_0x11f0d2(0x1a2),_0x27837b);}}async[a8_0x565965(0x1a7)](_0x2a1d97,_0x3d7021){const _0x5cb7a7=a8_0x565965;try{const {telegramBotService:_0x1487fa}=await Promise[_0x5cb7a7(0x1e7)]()[_0x5cb7a7(0x1fb)](()=>__importStar(require(_0x5cb7a7(0x1dd)))),_0x1b919c={'PAID':_0x5cb7a7(0x213),'FAILED':_0x5cb7a7(0x20c)},_0x441285=_0x1b919c[_0x3d7021];if(!_0x441285)return;await _0x1487fa[_0x5cb7a7(0x217)](_0x2a1d97[_0x5cb7a7(0x1c1)],_0x2a1d97,_0x441285);}catch(_0x283272){console[_0x5cb7a7(0x20b)](_0x5cb7a7(0x1de),_0x283272);}}}exports['PaymentController']=PaymentController;function a8_0x3dd3(){const _0x54ab4f=['application/json','isArray','__setModuleDefault','default','\x20not\x20enabled\x20for\x20shop\x20','paid','gatewayPaymentId','50wUWmFq','__importDefault','sendPaymentNotification','webhookEvents','2473416yfyzff','Card\x20payment\x20failed','currency','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Failed\x20to\x20send\x20MasterCard\x20webhook:','threeds_url','system','email','__esModule','sendPaymentStatusNotification','stringify','updatePaymentCustomerDataPublic','payment','1788075AzMFeq','PaymentController','mastercard_','prototype','payment.success','gateway_payment_id','1652zUWXZv','payment.failed','update','slice','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','__createBinding','writable','includes','Customer\x20data\x20updated\x20successfully','amount','params','\x20with\x20status\x20','json','body','💳\x20MasterCard\x20URLs:','gatewayOrderId','shopId','✅\x20MasterCard\x20payment\x20','requires_3ds','31464bFHjRK','handleSuccessfulPayment','Payment\x20not\x20found','paymentService','FAILED','../services/webhookService','masterCardService','480VhmwIh','log','call','cardLast4','now','4345429ameZBm','createPublicPayment','final','getPaymentStatus','webhookUrl','updatePaymentCustomer','toLowerCase','length','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','first_name','380xqdgiA','processMasterCardPayment','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','../services/telegramBotService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20status\x20is\x20','successUrl','__importStar','paymentMethod','get','country','\x20processed:\x20','create','resolve','user_agent','settings','💳\x20MasterCard\x20result:','configurable','webhookLog','customerIp','PAID','replace','145320egFvWL','getOwnPropertyNames','createdAt','865711btzxay','orderId','../services/paymentService','32aWUtxX','POST','WebhookService','status','defineProperty','then','getPaymentById','mastercard','gateway','../services/paymentLinkService','PENDING',',\x20cannot\x20process','3DS\x20verification\x20required','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','failUrl','last_name','\x20\x20\x20Result\x20URL\x20(webhook):\x20','💳\x20Processing\x20MasterCard\x20payment:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Webhook\x20event\x20','toISOString','error','failed','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'];a8_0x3dd3=function(){return _0x54ab4f;};return a8_0x3dd3();}