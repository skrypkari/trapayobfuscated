'use strict';function a8_0x11dd(){const _0x40fcc2=['12KIiTPc',',\x20cannot\x20process','isArray','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','__importStar','replace','https://app.trapay.uk/payment/pending?id=','customerUa','gateway_payment_id','2624148lfmdUL','settings','FAILED','PaymentController','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','params','then','../services/paymentService','user_agent','VISA/MasterCard','Error\x20parsing\x20webhook\x20events:','10170sVpImk','first_name','PENDING','__esModule','Payment\x20status\x20is\x20','status','number','5550282oOBhys','call','update','email','currency','https://api.trapay.uk/api/webhooks/gateway/','UNKNOWN','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','amount','üìù\x20Customer\x20data:','Webhook\x20event\x20','1547190iPUNkO','2936gLRdEn','1111','parse','üí≥\x20MasterCard\x20result:','paid','üí≥\x20Card\x20holder:\x20','gatewayPaymentId','log','final','mastercard','ms)','toLowerCase','getPaymentStatus','slice','failureMessage','findUnique','threeds_url','hasOwnProperty','processMasterCardPayment','length','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','default','shop','../services/telegramBotService','Payment\x20created\x20successfully','1hlhytX','system','1892850mBiWYB','toISOString','defineProperty','requires_3ds','paymentService','resolve','webhookEvents','visa','toUpperCase','Payment\x20failed','payment','visa/mastercard','prototype','sendShopWebhook','now','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/webhookService','\x20\x20\x20Return\x20URL:\x20','error','gateway','application/json','updatePaymentCustomerDataPublic','webhookLog','../config/database','__setModuleDefault','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','cardLast4','\x20webhook:','customerIp','PaymentService','configurable','includes','customerName','__createBinding','gatewayOrderId','PAID','1410486kupONU','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20not\x20enabled\x20for\x20shop\x20','customerEmail','handleSuccessfulPayment','TesSoft\x20Payment\x20System/1.0\x20(','__importDefault','body','get','webhookUrl','paidAt','Payment\x20processed\x20successfully','createPublicPayment','startsWith','failed','create','Card\x20payment\x20failed','failUrl','\x20payment:','updatedAt','writable','Payment\x20not\x20found','json','WebhookService','orderId','Failed\x20to\x20send\x20','üìà\x20','stringify','\x20payment\x20','payment.failed','getPaymentById','createdAt','last_name','processCardPayment','üí≥\x20Browser\x20IP:\x20','visaMasterCardService','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','12022070prcUfu'];a8_0x11dd=function(){return _0x40fcc2;};return a8_0x11dd();}const a8_0x421e77=a8_0xfa8d;(function(_0x2a9f47,_0x2d9c6e){const _0x215684=a8_0xfa8d,_0x5a210a=_0x2a9f47();while(!![]){try{const _0x21b414=-parseInt(_0x215684(0x195))/0x1*(parseInt(_0x215684(0x15e))/0x2)+parseInt(_0x215684(0x197))/0x3+-parseInt(_0x215684(0x155))/0x4*(parseInt(_0x215684(0x17b))/0x5)+parseInt(_0x215684(0x170))/0x6+-parseInt(_0x215684(0x1bc))/0x7+parseInt(_0x215684(0x17c))/0x8*(parseInt(_0x215684(0x169))/0x9)+parseInt(_0x215684(0x154))/0xa;if(_0x21b414===_0x2d9c6e)break;else _0x5a210a['push'](_0x5a210a['shift']());}catch(_0x1e08e3){_0x5a210a['push'](_0x5a210a['shift']());}}}(a8_0x11dd,0xb2794));var __createBinding=this&&this[a8_0x421e77(0x1b9)]||(Object['create']?function(_0x5b8c12,_0x2ee87a,_0x3114c5,_0xfdbcae){const _0x345649=a8_0x421e77;if(_0xfdbcae===undefined)_0xfdbcae=_0x3114c5;var _0x29b53b=Object['getOwnPropertyDescriptor'](_0x2ee87a,_0x3114c5);(!_0x29b53b||(_0x345649(0x1c4)in _0x29b53b?!_0x2ee87a[_0x345649(0x16c)]:_0x29b53b[_0x345649(0x1d0)]||_0x29b53b[_0x345649(0x1b6)]))&&(_0x29b53b={'enumerable':!![],'get':function(){return _0x2ee87a[_0x3114c5];}}),Object[_0x345649(0x199)](_0x5b8c12,_0xfdbcae,_0x29b53b);}:function(_0x1ca6db,_0xd795e,_0x4791c7,_0x3cba4b){if(_0x3cba4b===undefined)_0x3cba4b=_0x4791c7;_0x1ca6db[_0x3cba4b]=_0xd795e[_0x4791c7];}),__setModuleDefault=this&&this[a8_0x421e77(0x1b0)]||(Object['create']?function(_0x3cedae,_0x15e08a){const _0xeb7487=a8_0x421e77;Object[_0xeb7487(0x199)](_0x3cedae,_0xeb7487(0x191),{'enumerable':!![],'value':_0x15e08a});}:function(_0xd951a5,_0x5927a9){const _0xfdc7c5=a8_0x421e77;_0xd951a5[_0xfdc7c5(0x191)]=_0x5927a9;}),__importStar=this&&this[a8_0x421e77(0x159)]||(function(){var _0x27192f=function(_0x106bf0){return _0x27192f=Object['getOwnPropertyNames']||function(_0x2fd03d){const _0x5c151e=a8_0xfa8d;var _0x5b106b=[];for(var _0x8c7f7a in _0x2fd03d)if(Object[_0x5c151e(0x1a3)][_0x5c151e(0x18d)][_0x5c151e(0x171)](_0x2fd03d,_0x8c7f7a))_0x5b106b[_0x5b106b['length']]=_0x8c7f7a;return _0x5b106b;},_0x27192f(_0x106bf0);};return function(_0x3757db){const _0x44a6e0=a8_0xfa8d;if(_0x3757db&&_0x3757db[_0x44a6e0(0x16c)])return _0x3757db;var _0xe22430={};if(_0x3757db!=null){for(var _0x505c12=_0x27192f(_0x3757db),_0x2876fd=0x0;_0x2876fd<_0x505c12[_0x44a6e0(0x18f)];_0x2876fd++)if(_0x505c12[_0x2876fd]!==_0x44a6e0(0x191))__createBinding(_0xe22430,_0x3757db,_0x505c12[_0x2876fd]);}return __setModuleDefault(_0xe22430,_0x3757db),_0xe22430;};}()),__importDefault=this&&this[a8_0x421e77(0x1c2)]||function(_0x4622bd){const _0x450d02=a8_0x421e77;return _0x4622bd&&_0x4622bd[_0x450d02(0x16c)]?_0x4622bd:{'default':_0x4622bd};};Object[a8_0x421e77(0x199)](exports,'__esModule',{'value':!![]}),exports[a8_0x421e77(0x161)]=void 0x0;const paymentService_1=require(a8_0x421e77(0x165)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x421e77(0x1a8)),database_1=__importDefault(require(a8_0x421e77(0x1af)));function a8_0xfa8d(_0x27f8d8,_0x4f7cc4){const _0x11dd7b=a8_0x11dd();return a8_0xfa8d=function(_0xfa8dab,_0x2d3d87){_0xfa8dab=_0xfa8dab-0x14a;let _0x3d97e0=_0x11dd7b[_0xfa8dab];return _0x3d97e0;},a8_0xfa8d(_0x27f8d8,_0x4f7cc4);}class PaymentController{constructor(){const _0xa79ef4=a8_0x421e77;this[_0xa79ef4(0x1c8)]=async(_0x5397f8,_0x51d1ec,_0xd250a)=>{const _0x29e65b=_0xa79ef4;try{const _0x3ac7f7=_0x5397f8[_0x29e65b(0x1c3)],_0x16e15b=await this[_0x29e65b(0x19b)][_0x29e65b(0x1c8)](_0x3ac7f7);_0x51d1ec[_0x29e65b(0x16e)](0xc9)[_0x29e65b(0x1d2)]({'success':!![],'message':_0x29e65b(0x194),'result':_0x16e15b});}catch(_0x9595ee){_0xd250a(_0x9595ee);}},this[_0xa79ef4(0x188)]=async(_0x1c0dcb,_0x48c627,_0x5f1f1f)=>{const _0x52e34a=_0xa79ef4;try{const {id:_0x45e30a}=_0x1c0dcb[_0x52e34a(0x163)],_0x34ece3=await this[_0x52e34a(0x19b)][_0x52e34a(0x188)](_0x45e30a);if(!_0x34ece3)return _0x48c627[_0x52e34a(0x16e)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x48c627[_0x52e34a(0x1d2)]({'success':!![],'result':_0x34ece3});}catch(_0x2f9f53){_0x5f1f1f(_0x2f9f53);}},this[_0xa79ef4(0x14d)]=async(_0xc0f44f,_0x4fc126,_0x942a68)=>{const _0x48317a=_0xa79ef4;try{const {id:_0x1a604f}=_0xc0f44f[_0x48317a(0x163)],_0x5e3fc0=await this['paymentService'][_0x48317a(0x14d)](_0x1a604f);if(!_0x5e3fc0)return _0x4fc126['status'](0x194)[_0x48317a(0x1d2)]({'success':![],'message':'Payment\x20not\x20found'});_0x4fc126[_0x48317a(0x1d2)]({'success':!![],'result':_0x5e3fc0});}catch(_0x22b040){_0x942a68(_0x22b040);}},this['updatePaymentCustomer']=async(_0x41431b,_0x49a4d9,_0x228901)=>{const _0x4b72ec=_0xa79ef4;try{const {id:_0x5543a7}=_0x41431b[_0x4b72ec(0x163)],_0x5b9629=_0x41431b[_0x4b72ec(0x1c3)];console[_0x4b72ec(0x183)](_0x4b72ec(0x158)+_0x5543a7),console[_0x4b72ec(0x183)](_0x4b72ec(0x179),_0x5b9629);const _0xcd16f1=await this[_0x4b72ec(0x19b)][_0x4b72ec(0x1ad)](_0x5543a7,_0x5b9629);if(!_0xcd16f1)return _0x49a4d9[_0x4b72ec(0x16e)](0x194)[_0x4b72ec(0x1d2)]({'success':![],'message':_0x4b72ec(0x1d1)});_0x49a4d9[_0x4b72ec(0x1d2)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0xcd16f1['id'],'customerIp':_0xcd16f1[_0x4b72ec(0x1b4)],'customerUa':_0xcd16f1[_0x4b72ec(0x15c)],'customerCountry':_0xcd16f1['customerCountry'],'updatedAt':_0xcd16f1[_0x4b72ec(0x1cf)]}});}catch(_0x5ee0f2){_0x228901(_0x5ee0f2);}},this[_0xa79ef4(0x18e)]=async(_0x5557f2,_0x4744a9,_0x11c93d)=>{const _0x58186d=_0xa79ef4;try{const {id:_0x3c6a6f}=_0x5557f2[_0x58186d(0x163)],{cardData:_0x475e47,cardHolder:_0x3946b4,browser:_0x3c1b63}=_0x5557f2[_0x58186d(0x1c3)];console[_0x58186d(0x183)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x3c6a6f),console[_0x58186d(0x183)](_0x58186d(0x181)+_0x3946b4[_0x58186d(0x16a)]+'\x20'+_0x3946b4[_0x58186d(0x14f)]+'\x20('+_0x3946b4[_0x58186d(0x173)]+')'),console[_0x58186d(0x183)](_0x58186d(0x151)+_0x3c1b63['ip']);const _0x32e663={'customerName':_0x3946b4['first_name']+'\x20'+_0x3946b4[_0x58186d(0x14f)],'customerEmail':_0x3946b4[_0x58186d(0x173)],'customerIp':_0x3c1b63['ip'],'customerUa':_0x3c1b63[_0x58186d(0x166)]},_0x475fef=await database_1['default'][_0x58186d(0x1a1)][_0x58186d(0x18b)]({'where':{'id':_0x3c6a6f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x475fef)return _0x4744a9[_0x58186d(0x16e)](0x194)[_0x58186d(0x1d2)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x475fef[_0x58186d(0x1ab)]!==_0x58186d(0x1a2))return console[_0x58186d(0x183)](_0x58186d(0x153)+_0x475fef[_0x58186d(0x1ab)]+'\x27'),_0x4744a9[_0x58186d(0x16e)](0x190)[_0x58186d(0x1d2)]({'success':![],'message':_0x58186d(0x1b1)});if(_0x475fef[_0x58186d(0x16e)]!=='PENDING')return _0x4744a9[_0x58186d(0x16e)](0x190)[_0x58186d(0x1d2)]({'success':![],'message':_0x58186d(0x16d)+_0x475fef['status']+_0x58186d(0x156)});await database_1[_0x58186d(0x191)][_0x58186d(0x1a1)][_0x58186d(0x172)]({'where':{'id':_0x3c6a6f},'data':{..._0x32e663,'updatedAt':new Date()}});const _0x2d3778=_0x475e47['number']['replace'](/[\s-]/g,''),_0x5c6538=_0x2d3778[_0x58186d(0x1c9)]('4')?_0x58186d(0x19e):_0x58186d(0x185),_0x2f0e57=_0x58186d(0x175)+_0x5c6538,_0x33719d=_0x58186d(0x15b)+_0x475fef['id']+'&payment_id='+_0x475fef[_0x58186d(0x1ba)];console['log']('üí≥\x20'+_0x5c6538['toUpperCase']()+'\x20URLs:'),console[_0x58186d(0x183)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x2f0e57),console['log'](_0x58186d(0x1a9)+_0x33719d);const _0x21bb15={'first_name':_0x3946b4[_0x58186d(0x16a)],'last_name':_0x3946b4['last_name'],'email':_0x3946b4[_0x58186d(0x173)]},_0x1b41a9=await this[_0x58186d(0x152)][_0x58186d(0x150)]({'paymentId':_0x475fef['id'],'orderId':_0x475fef[_0x58186d(0x1ba)]||_0x475fef['id'],'amount':_0x475fef['amount'],'currency':_0x475fef['currency'],'cardData':_0x475e47,'resultUrl':_0x2f0e57,'returnUrl':_0x33719d,'cardHolder':_0x21bb15,'browser':_0x3c1b63});console[_0x58186d(0x183)](_0x58186d(0x17f),_0x1b41a9);const _0x2b86d4={'status':_0x1b41a9[_0x58186d(0x16e)],'updatedAt':new Date(),'statusChangedBy':_0x58186d(0x196),'statusChangedAt':new Date()};_0x1b41a9['gateway_payment_id']&&(_0x2b86d4[_0x58186d(0x182)]=_0x1b41a9[_0x58186d(0x15d)],console[_0x58186d(0x183)](_0x58186d(0x1a6)+_0x1b41a9[_0x58186d(0x15d)]));if(_0x1b41a9['status']===_0x58186d(0x1bb))_0x2b86d4[_0x58186d(0x1c6)]=new Date();else _0x1b41a9[_0x58186d(0x16e)]===_0x58186d(0x160)&&(_0x2b86d4[_0x58186d(0x18a)]=_0x58186d(0x1cc));_0x2b86d4['paymentMethod']=_0x58186d(0x185);if(_0x475e47[_0x58186d(0x16f)]){const _0x1eed0a=_0x475e47['number'][_0x58186d(0x15a)](/[\s-]/g,'');_0x2b86d4[_0x58186d(0x1b2)]=_0x1eed0a[_0x58186d(0x189)](-0x4),console[_0x58186d(0x183)](_0x58186d(0x162)+_0x2b86d4['cardLast4']);}await database_1['default'][_0x58186d(0x1a1)][_0x58186d(0x172)]({'where':{'id':_0x475fef['id']},'data':_0x2b86d4}),await database_1[_0x58186d(0x191)][_0x58186d(0x1ae)][_0x58186d(0x1cb)]({'data':{'paymentId':_0x475fef['id'],'shopId':_0x475fef['shopId'],'event':_0x5c6538+'_'+_0x1b41a9[_0x58186d(0x16e)]?.[_0x58186d(0x187)](),'statusCode':0xc8,'responseBody':JSON[_0x58186d(0x14a)]({'oldStatus':'PENDING','newStatus':_0x1b41a9['status'],'gatewayPaymentId':_0x1b41a9[_0x58186d(0x15d)],'requires3ds':_0x1b41a9[_0x58186d(0x19a)],'cardType':_0x5c6538[_0x58186d(0x19f)](),'processedAt':new Date()[_0x58186d(0x198)]()})}});if(_0x1b41a9[_0x58186d(0x184)]){await this[_0x58186d(0x1a4)](_0x475fef,_0x1b41a9['status'],_0x1b41a9[_0x58186d(0x15d)],_0x5c6538),await this['sendPaymentStatusNotification'](_0x475fef,_0x1b41a9['status']);if(_0x1b41a9['status']===_0x58186d(0x1bb)){console['log'](_0x58186d(0x1d6)+_0x5c6538[_0x58186d(0x19f)]()+_0x58186d(0x14b)+_0x3c6a6f+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x35567e}=await Promise[_0x58186d(0x19c)]()[_0x58186d(0x164)](()=>__importStar(require('../services/paymentLinkService'))),_0x4e54b8=new _0x35567e();await _0x4e54b8[_0x58186d(0x1c0)](_0x3c6a6f),console[_0x58186d(0x183)](_0x58186d(0x190)+_0x5c6538[_0x58186d(0x19f)]()+_0x58186d(0x14b)+_0x3c6a6f);}catch(_0x549d80){console[_0x58186d(0x1aa)](_0x58186d(0x177)+_0x5c6538['toUpperCase']()+_0x58186d(0x1ce),_0x549d80);}}}console[_0x58186d(0x183)]('‚úÖ\x20'+_0x5c6538[_0x58186d(0x19f)]()+_0x58186d(0x14b)+_0x3c6a6f+'\x20processed:\x20'+_0x1b41a9[_0x58186d(0x16e)]);if(_0x1b41a9['status']===_0x58186d(0x1bb))_0x4744a9[_0x58186d(0x1d2)]({'success':!![],'message':_0x58186d(0x1c7),'result':{'status':_0x58186d(0x1bb),'gatewayPaymentId':_0x1b41a9[_0x58186d(0x15d)],'redirectUrl':_0x33719d,'final':!![]}});else _0x1b41a9[_0x58186d(0x19a)]&&_0x1b41a9[_0x58186d(0x18c)]?_0x4744a9[_0x58186d(0x1d2)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x58186d(0x16b),'gatewayPaymentId':_0x1b41a9['gateway_payment_id'],'redirectUrl':_0x1b41a9['threeds_url'],'requires3ds':!![],'final':![]}}):_0x4744a9[_0x58186d(0x16e)](0x190)[_0x58186d(0x1d2)]({'success':![],'message':_0x58186d(0x1a0),'result':{'status':_0x58186d(0x160),'gatewayPaymentId':_0x1b41a9['gateway_payment_id'],'redirectUrl':_0x475fef[_0x58186d(0x1cd)],'final':!![]}});}catch(_0x166d19){_0x11c93d(_0x166d19);}},this[_0xa79ef4(0x19b)]=new paymentService_1[(_0xa79ef4(0x1b5))](),this[_0xa79ef4(0x152)]=new mastercardService_1['VisaMasterCardService'](),this['webhookService']=new webhookService_1[(_0xa79ef4(0x1d3))]();}async[a8_0x421e77(0x1a4)](_0x789d34,_0xaadb17,_0x2af03d,_0x106383){const _0x271f85=a8_0x421e77,_0x4d4cc0=Date[_0x271f85(0x1a5)]();try{const _0x383b9a=_0x789d34[_0x271f85(0x192)],_0x101f63=_0x383b9a[_0x271f85(0x15f)];if(!_0x101f63?.[_0x271f85(0x1c5)]){console[_0x271f85(0x183)](_0x271f85(0x1bd)+_0x383b9a['id']);return;}const _0x1f3c9b=_0xaadb17===_0x271f85(0x1bb)?'payment.success':_0x271f85(0x14c);let _0x3a71e0=[];if(_0x101f63[_0x271f85(0x19d)])try{_0x3a71e0=Array[_0x271f85(0x157)](_0x101f63[_0x271f85(0x19d)])?_0x101f63[_0x271f85(0x19d)]:JSON[_0x271f85(0x17e)](_0x101f63[_0x271f85(0x19d)]);}catch(_0x211025){console['error'](_0x271f85(0x168),_0x211025),_0x3a71e0=[];}if(!_0x3a71e0[_0x271f85(0x1b7)](_0x1f3c9b)){console[_0x271f85(0x183)](_0x271f85(0x17a)+_0x1f3c9b+_0x271f85(0x1be)+_0x383b9a['id']);return;}const _0x36e50f={'event':_0x1f3c9b,'payment':{'id':_0x789d34['id'],'order_id':_0x789d34[_0x271f85(0x1d4)],'gateway_order_id':_0x789d34[_0x271f85(0x1ba)],'gateway':_0x271f85(0x17d),'card_type':_0x106383?.[_0x271f85(0x19f)]()||_0x271f85(0x176),'amount':_0x789d34[_0x271f85(0x178)],'currency':_0x789d34[_0x271f85(0x174)],'status':_0xaadb17[_0x271f85(0x187)](),'customer_email':_0x789d34[_0x271f85(0x1bf)],'customer_name':_0x789d34[_0x271f85(0x1b8)],'gateway_payment_id':_0x2af03d,'created_at':_0x789d34[_0x271f85(0x14e)],'updated_at':new Date()}},_0x2a9e45=await fetch(_0x101f63[_0x271f85(0x1c5)],{'method':'POST','headers':{'Content-Type':_0x271f85(0x1ac),'User-Agent':_0x271f85(0x1c1)+(_0x106383?.['toUpperCase']()||_0x271f85(0x167))+')'},'body':JSON[_0x271f85(0x14a)](_0x36e50f)}),_0x533106=Date[_0x271f85(0x1a5)]()-_0x4d4cc0;console['log']((_0x106383?.['toUpperCase']()||_0x271f85(0x167))+'\x20webhook\x20sent\x20to\x20'+_0x101f63['webhookUrl']+'\x20with\x20status\x20'+_0x2a9e45[_0x271f85(0x16e)]+'\x20('+_0x533106+_0x271f85(0x186));}catch(_0x2a3fdd){console[_0x271f85(0x1aa)](_0x271f85(0x1d5)+(_0x106383?.[_0x271f85(0x19f)]()||'VISA/MasterCard')+_0x271f85(0x1b3),_0x2a3fdd);}}async['sendPaymentStatusNotification'](_0x2d28bc,_0x3d389a){const _0x11c065=a8_0x421e77;try{const {telegramBotService:_0x3bf027}=await Promise[_0x11c065(0x19c)]()[_0x11c065(0x164)](()=>__importStar(require(_0x11c065(0x193)))),_0x359894={'PAID':_0x11c065(0x180),'FAILED':_0x11c065(0x1ca)},_0x11f0c1=_0x359894[_0x3d389a];if(!_0x11f0c1)return;await _0x3bf027['sendPaymentNotification'](_0x2d28bc['shopId'],_0x2d28bc,_0x11f0c1);}catch(_0x4d5796){console['error'](_0x11c065(0x1a7),_0x4d5796);}}}exports[a8_0x421e77(0x161)]=PaymentController;