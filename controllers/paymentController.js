'use strict';const a8_0x584c0e=a8_0x585a;(function(_0x392b51,_0x3135e){const _0x46626a=a8_0x585a,_0x1e21f4=_0x392b51();while(!![]){try{const _0x43ecb2=parseInt(_0x46626a(0xdf))/0x1+-parseInt(_0x46626a(0xbf))/0x2*(parseInt(_0x46626a(0xbe))/0x3)+parseInt(_0x46626a(0xa9))/0x4*(-parseInt(_0x46626a(0xec))/0x5)+-parseInt(_0x46626a(0xd6))/0x6*(-parseInt(_0x46626a(0xf4))/0x7)+parseInt(_0x46626a(0x104))/0x8*(parseInt(_0x46626a(0xd0))/0x9)+-parseInt(_0x46626a(0xee))/0xa*(-parseInt(_0x46626a(0xa6))/0xb)+-parseInt(_0x46626a(0xf1))/0xc;if(_0x43ecb2===_0x3135e)break;else _0x1e21f4['push'](_0x1e21f4['shift']());}catch(_0x1b9c34){_0x1e21f4['push'](_0x1e21f4['shift']());}}}(a8_0x45b1,0xadf5b));var __createBinding=this&&this['__createBinding']||(Object[a8_0x584c0e(0xc2)]?function(_0x234ace,_0x5492bb,_0x4a3810,_0x383ac9){const _0x125aa1=a8_0x584c0e;if(_0x383ac9===undefined)_0x383ac9=_0x4a3810;var _0x5f4c81=Object[_0x125aa1(0xb0)](_0x5492bb,_0x4a3810);(!_0x5f4c81||(_0x125aa1(0x105)in _0x5f4c81?!_0x5492bb[_0x125aa1(0x101)]:_0x5f4c81['writable']||_0x5f4c81[_0x125aa1(0xc8)]))&&(_0x5f4c81={'enumerable':!![],'get':function(){return _0x5492bb[_0x4a3810];}}),Object[_0x125aa1(0xb4)](_0x234ace,_0x383ac9,_0x5f4c81);}:function(_0x20e44e,_0x4d66d8,_0x2c35e2,_0x76dce){if(_0x76dce===undefined)_0x76dce=_0x2c35e2;_0x20e44e[_0x76dce]=_0x4d66d8[_0x2c35e2];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x584c0e(0xc2)]?function(_0x5d43d2,_0x52a22d){const _0x552612=a8_0x584c0e;Object[_0x552612(0xb4)](_0x5d43d2,_0x552612(0xcb),{'enumerable':!![],'value':_0x52a22d});}:function(_0x46312e,_0x10f3c7){const _0x1e56ec=a8_0x584c0e;_0x46312e[_0x1e56ec(0xcb)]=_0x10f3c7;}),__importStar=this&&this[a8_0x584c0e(0xeb)]||(function(){var _0x1e0041=function(_0x4b5e2d){const _0x4cd9fc=a8_0x585a;return _0x1e0041=Object[_0x4cd9fc(0xd8)]||function(_0x4ec342){const _0x3d8c21=_0x4cd9fc;var _0x194d7b=[];for(var _0x225edf in _0x4ec342)if(Object[_0x3d8c21(0xc3)]['hasOwnProperty'][_0x3d8c21(0xb9)](_0x4ec342,_0x225edf))_0x194d7b[_0x194d7b[_0x3d8c21(0xe8)]]=_0x225edf;return _0x194d7b;},_0x1e0041(_0x4b5e2d);};return function(_0x20089d){const _0x401a15=a8_0x585a;if(_0x20089d&&_0x20089d['__esModule'])return _0x20089d;var _0x17929e={};if(_0x20089d!=null){for(var _0x952ce0=_0x1e0041(_0x20089d),_0x3c5f07=0x0;_0x3c5f07<_0x952ce0[_0x401a15(0xe8)];_0x3c5f07++)if(_0x952ce0[_0x3c5f07]!==_0x401a15(0xcb))__createBinding(_0x17929e,_0x20089d,_0x952ce0[_0x3c5f07]);}return __setModuleDefault(_0x17929e,_0x20089d),_0x17929e;};}()),__importDefault=this&&this[a8_0x584c0e(0xfc)]||function(_0x2103d3){const _0x173604=a8_0x584c0e;return _0x2103d3&&_0x2103d3[_0x173604(0x101)]?_0x2103d3:{'default':_0x2103d3};};function a8_0x45b1(){const _0x5d4013=['../services/paymentLinkService','shop','https://api.trapay.uk/api/webhooks/gateway/mastercard','createPublicPayment','json','PAID','paid','9361uYrnGT','Webhook\x20event\x20','PENDING','2745700HMNinu','payment.success','country','webhookEvents','failureMessage','status','customerIp','getOwnPropertyDescriptor','number','gateway','user_agent','defineProperty','now','params','gatewayOrderId','updatePaymentCustomerDataPublic','call','customerCountry','sendPaymentNotification','📈\x20MasterCard\x20payment\x20','stringify','1965JqrfHw','1126nFYOkz','toISOString','Payment\x20processed\x20successfully','create','prototype','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','../services/webhookService','MasterCard\x20webhook\x20sent\x20to\x20','1111','configurable','requires_3ds','masterCardService','default','amount','WebhookService','Payment\x20status\x20is\x20','slice','846mtoYbd','customerName','mastercard','\x20processed:\x20','Error\x20parsing\x20webhook\x20events:','\x20not\x20enabled\x20for\x20shop\x20','6inMbWn','includes','getOwnPropertyNames','threeds_url','application/json','toLowerCase','PaymentController',',\x20cannot\x20process','FAILED','629528BIqnrZ','paidAt','paymentService','log','currency','💳\x20MasterCard\x20URLs:','getPaymentStatus','shopId','gateway_payment_id','length','payment.failed','sendPaymentStatusNotification','__importStar','5uGwLjd','webhookService','10470LfNiSB','last_name','handleSuccessfulPayment','21241884Pqdvoz','email','settings','6746005FOIucC','customerUa','failUrl','update','getPaymentById','cardLast4','💳\x20Browser\x20IP:\x20','first_name','__importDefault','sendShopWebhook','updatePaymentCustomer','../services/telegramBotService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','__esModule','findUnique','PaymentService','89672LFpHNB','get','3DS\x20verification\x20required','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','../services/paymentService','../services/gateways/mastercardService','webhookUrl','payment','processMasterCardPayment','📝\x20Customer\x20data:','Payment\x20failed','error','💳\x20Card\x20holder:\x20','then','\x20\x20\x20Return\x20URL:\x20','gatewayPaymentId','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerEmail','✅\x20MasterCard\x20payment\x20','successUrl','Payment\x20not\x20found','system'];a8_0x45b1=function(){return _0x5d4013;};return a8_0x45b1();}Object[a8_0x584c0e(0xb4)](exports,a8_0x584c0e(0x101),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x584c0e(0x108)),mastercardService_1=require(a8_0x584c0e(0x109)),webhookService_1=require(a8_0x584c0e(0xc5)),database_1=__importDefault(require('../config/database'));function a8_0x585a(_0x7d0dca,_0x2a64b0){const _0x45b155=a8_0x45b1();return a8_0x585a=function(_0x585a5e,_0x113796){_0x585a5e=_0x585a5e-0x98;let _0x17e75f=_0x45b155[_0x585a5e];return _0x17e75f;},a8_0x585a(_0x7d0dca,_0x2a64b0);}class PaymentController{constructor(){const _0x9ea485=a8_0x584c0e;this['createPublicPayment']=async(_0x519833,_0xd28a33,_0x200219)=>{const _0x4c731c=a8_0x585a;try{const _0x399cec=_0x519833['body'],_0x16e55e=await this[_0x4c731c(0xe1)][_0x4c731c(0xa2)](_0x399cec);_0xd28a33[_0x4c731c(0xae)](0xc9)[_0x4c731c(0xa3)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x16e55e});}catch(_0x40c492){_0x200219(_0x40c492);}},this['getPaymentStatus']=async(_0x42f85f,_0x57b049,_0x5bbbbb)=>{const _0x17f789=a8_0x585a;try{const {id:_0x3b0d76}=_0x42f85f[_0x17f789(0xb6)],_0x42fd4b=await this[_0x17f789(0xe1)][_0x17f789(0xe5)](_0x3b0d76);if(!_0x42fd4b)return _0x57b049[_0x17f789(0xae)](0x194)[_0x17f789(0xa3)]({'success':![],'message':_0x17f789(0x9d)});_0x57b049[_0x17f789(0xa3)]({'success':!![],'result':_0x42fd4b});}catch(_0x18dc16){_0x5bbbbb(_0x18dc16);}},this[_0x9ea485(0xf8)]=async(_0x8e1d10,_0x47ea08,_0x4e45da)=>{const _0x3ec324=_0x9ea485;try{const {id:_0x18fb1d}=_0x8e1d10['params'],_0x1faac3=await this[_0x3ec324(0xe1)][_0x3ec324(0xf8)](_0x18fb1d);if(!_0x1faac3)return _0x47ea08[_0x3ec324(0xae)](0x194)[_0x3ec324(0xa3)]({'success':![],'message':_0x3ec324(0x9d)});_0x47ea08[_0x3ec324(0xa3)]({'success':!![],'result':_0x1faac3});}catch(_0x3b092b){_0x4e45da(_0x3b092b);}},this[_0x9ea485(0xfe)]=async(_0x168ce7,_0x2e4aca,_0x5e45b5)=>{const _0x260c11=_0x9ea485;try{const {id:_0x515be9}=_0x168ce7[_0x260c11(0xb6)],_0x23b1eb=_0x168ce7['body'];console[_0x260c11(0xe2)](_0x260c11(0x98)+_0x515be9),console[_0x260c11(0xe2)](_0x260c11(0x10d),_0x23b1eb);const _0x5c8631=await this[_0x260c11(0xe1)][_0x260c11(0xb8)](_0x515be9,_0x23b1eb);if(!_0x5c8631)return _0x2e4aca[_0x260c11(0xae)](0x194)[_0x260c11(0xa3)]({'success':![],'message':_0x260c11(0x9d)});_0x2e4aca[_0x260c11(0xa3)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x5c8631['id'],'customerIp':_0x5c8631[_0x260c11(0xaf)],'customerUa':_0x5c8631[_0x260c11(0xf5)],'customerCountry':_0x5c8631[_0x260c11(0xba)],'updatedAt':_0x5c8631['updatedAt']}});}catch(_0x5a30cd){_0x5e45b5(_0x5a30cd);}},this[_0x9ea485(0x10c)]=async(_0x315281,_0x126987,_0x446481)=>{const _0x5937ba=_0x9ea485;try{const {id:_0xf77a37}=_0x315281[_0x5937ba(0xb6)],{cardData:_0x52445f,cardHolder:_0x56e691,browser:_0x2eb3ca}=_0x315281['body'];console[_0x5937ba(0xe2)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0xf77a37),console[_0x5937ba(0xe2)](_0x5937ba(0x110)+_0x56e691[_0x5937ba(0xfb)]+'\x20'+_0x56e691[_0x5937ba(0xef)]+'\x20('+_0x56e691[_0x5937ba(0xf2)]+')'),console[_0x5937ba(0xe2)](_0x5937ba(0xfa)+_0x2eb3ca['ip']);const _0x2370d2={'customerName':_0x56e691[_0x5937ba(0xfb)]+'\x20'+_0x56e691[_0x5937ba(0xef)],'customerEmail':_0x56e691[_0x5937ba(0xf2)],'customerIp':_0x2eb3ca['ip'],'customerUa':_0x2eb3ca[_0x5937ba(0xb3)],'customerCountry':_0x56e691[_0x5937ba(0xab)]||null},_0xe145fc=await database_1[_0x5937ba(0xcb)][_0x5937ba(0x10b)][_0x5937ba(0x102)]({'where':{'id':_0xf77a37},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xe145fc)return _0x126987[_0x5937ba(0xae)](0x194)[_0x5937ba(0xa3)]({'success':![],'message':_0x5937ba(0x9d)});if(_0xe145fc[_0x5937ba(0xb2)]!==_0x5937ba(0xd2))return _0x126987['status'](0x190)[_0x5937ba(0xa3)]({'success':![],'message':_0x5937ba(0x100)});if(_0xe145fc[_0x5937ba(0xae)]!==_0x5937ba(0xa8))return _0x126987[_0x5937ba(0xae)](0x190)['json']({'success':![],'message':_0x5937ba(0xce)+_0xe145fc[_0x5937ba(0xae)]+_0x5937ba(0xdd)});await database_1[_0x5937ba(0xcb)]['payment'][_0x5937ba(0xf7)]({'where':{'id':_0xf77a37},'data':{..._0x2370d2,'updatedAt':new Date()}});const _0x533f71=_0x5937ba(0xa1),_0xd8da9e=_0xe145fc[_0x5937ba(0x9c)];console[_0x5937ba(0xe2)](_0x5937ba(0xe4)),console[_0x5937ba(0xe2)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x533f71),console[_0x5937ba(0xe2)](_0x5937ba(0x112)+_0xd8da9e);const _0x4e2622={'first_name':_0x56e691['first_name'],'last_name':_0x56e691['last_name'],'email':_0x56e691['email']},_0x2c55bd=await this[_0x5937ba(0xca)]['processCardPayment']({'paymentId':_0xe145fc['id'],'orderId':_0xe145fc[_0x5937ba(0xb7)]||_0xe145fc['id'],'amount':_0xe145fc[_0x5937ba(0xcc)],'currency':_0xe145fc[_0x5937ba(0xe3)],'cardData':_0x52445f,'resultUrl':_0x533f71,'returnUrl':_0xd8da9e,'cardHolder':_0x4e2622,'browser':_0x2eb3ca});console[_0x5937ba(0xe2)]('💳\x20MasterCard\x20result:',_0x2c55bd);const _0x663f1e={'status':_0x2c55bd[_0x5937ba(0xae)],'updatedAt':new Date(),'statusChangedBy':_0x5937ba(0x9e),'statusChangedAt':new Date()};if(_0x2c55bd[_0x5937ba(0xae)]===_0x5937ba(0xa4))_0x663f1e[_0x5937ba(0xe0)]=new Date(),_0x663f1e[_0x5937ba(0x113)]=_0x2c55bd[_0x5937ba(0xe7)];else _0x2c55bd[_0x5937ba(0xae)]==='FAILED'&&(_0x663f1e[_0x5937ba(0xad)]='Card\x20payment\x20failed');_0x663f1e['paymentMethod']=_0x5937ba(0xd2);if(_0x52445f['number']){const _0x1bf0a7=_0x52445f[_0x5937ba(0xb1)]['replace'](/[\s-]/g,'');_0x663f1e[_0x5937ba(0xf9)]=_0x1bf0a7[_0x5937ba(0xcf)](-0x4),console[_0x5937ba(0xe2)](_0x5937ba(0x107)+_0x663f1e['cardLast4']);}await database_1[_0x5937ba(0xcb)]['payment']['update']({'where':{'id':_0xe145fc['id']},'data':_0x663f1e}),await database_1[_0x5937ba(0xcb)]['webhookLog'][_0x5937ba(0xc2)]({'data':{'paymentId':_0xe145fc['id'],'shopId':_0xe145fc[_0x5937ba(0xe6)],'event':'mastercard_'+_0x2c55bd[_0x5937ba(0xae)]?.[_0x5937ba(0xdb)](),'statusCode':0xc8,'responseBody':JSON[_0x5937ba(0xbd)]({'oldStatus':_0x5937ba(0xa8),'newStatus':_0x2c55bd[_0x5937ba(0xae)],'gatewayPaymentId':_0x2c55bd[_0x5937ba(0xe7)],'requires3ds':_0x2c55bd['requires_3ds'],'processedAt':new Date()[_0x5937ba(0xc0)]()})}});if(_0x2c55bd['final']){await this[_0x5937ba(0xfd)](_0xe145fc,_0x2c55bd[_0x5937ba(0xae)],_0x2c55bd[_0x5937ba(0xe7)]),await this[_0x5937ba(0xea)](_0xe145fc,_0x2c55bd[_0x5937ba(0xae)]);if(_0x2c55bd['status']===_0x5937ba(0xa4)){console['log'](_0x5937ba(0xbc)+_0xf77a37+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x5c298f}=await Promise['resolve']()[_0x5937ba(0x111)](()=>__importStar(require(_0x5937ba(0x9f)))),_0x17bd76=new _0x5c298f();await _0x17bd76[_0x5937ba(0xf0)](_0xf77a37),console[_0x5937ba(0xe2)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0xf77a37);}catch(_0x407408){console[_0x5937ba(0x10f)](_0x5937ba(0xc4),_0x407408);}}}console[_0x5937ba(0xe2)](_0x5937ba(0x9b)+_0xf77a37+_0x5937ba(0xd3)+_0x2c55bd[_0x5937ba(0xae)]);if(_0x2c55bd[_0x5937ba(0xae)]===_0x5937ba(0xa4))_0x126987[_0x5937ba(0xa3)]({'success':!![],'message':_0x5937ba(0xc1),'result':{'status':'PAID','gatewayPaymentId':_0x2c55bd[_0x5937ba(0xe7)],'redirectUrl':_0xd8da9e,'final':!![]}});else _0x2c55bd[_0x5937ba(0xc9)]&&_0x2c55bd['threeds_url']?_0x126987[_0x5937ba(0xa3)]({'success':!![],'message':_0x5937ba(0x106),'result':{'status':'PENDING','gatewayPaymentId':_0x2c55bd[_0x5937ba(0xe7)],'redirectUrl':_0x2c55bd[_0x5937ba(0xd9)],'requires3ds':!![],'final':![]}}):_0x126987[_0x5937ba(0xae)](0x190)[_0x5937ba(0xa3)]({'success':![],'message':_0x5937ba(0x10e),'result':{'status':_0x5937ba(0xde),'gatewayPaymentId':_0x2c55bd[_0x5937ba(0xe7)],'redirectUrl':_0xe145fc[_0x5937ba(0xf6)],'final':!![]}});}catch(_0x41d1ac){_0x446481(_0x41d1ac);}},this[_0x9ea485(0xe1)]=new paymentService_1[(_0x9ea485(0x103))](),this[_0x9ea485(0xca)]=new mastercardService_1['MasterCardService'](),this[_0x9ea485(0xed)]=new webhookService_1[(_0x9ea485(0xcd))]();}async[a8_0x584c0e(0xfd)](_0x3d73dc,_0x2f09a0,_0x2653ab){const _0x4ea314=a8_0x584c0e,_0x16b236=Date[_0x4ea314(0xb5)]();try{const _0x18e978=_0x3d73dc[_0x4ea314(0xa0)],_0x42910b=_0x18e978[_0x4ea314(0xf3)];if(!_0x42910b?.[_0x4ea314(0x10a)]){console[_0x4ea314(0xe2)](_0x4ea314(0x99)+_0x18e978['id']);return;}const _0x5cc95c=_0x2f09a0==='PAID'?_0x4ea314(0xaa):_0x4ea314(0xe9);let _0x2bfc45=[];if(_0x42910b['webhookEvents'])try{_0x2bfc45=Array['isArray'](_0x42910b['webhookEvents'])?_0x42910b[_0x4ea314(0xac)]:JSON['parse'](_0x42910b[_0x4ea314(0xac)]);}catch(_0x349804){console['error'](_0x4ea314(0xd4),_0x349804),_0x2bfc45=[];}if(!_0x2bfc45[_0x4ea314(0xd7)](_0x5cc95c)){console[_0x4ea314(0xe2)](_0x4ea314(0xa7)+_0x5cc95c+_0x4ea314(0xd5)+_0x18e978['id']);return;}const _0x2582e8={'event':_0x5cc95c,'payment':{'id':_0x3d73dc['id'],'order_id':_0x3d73dc['orderId'],'gateway_order_id':_0x3d73dc[_0x4ea314(0xb7)],'gateway':_0x4ea314(0xc7),'amount':_0x3d73dc['amount'],'currency':_0x3d73dc[_0x4ea314(0xe3)],'status':_0x2f09a0['toLowerCase'](),'customer_email':_0x3d73dc[_0x4ea314(0x9a)],'customer_name':_0x3d73dc[_0x4ea314(0xd1)],'gateway_payment_id':_0x2653ab,'created_at':_0x3d73dc['createdAt'],'updated_at':new Date()}},_0x24c731=await fetch(_0x42910b[_0x4ea314(0x10a)],{'method':'POST','headers':{'Content-Type':_0x4ea314(0xda),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x4ea314(0xbd)](_0x2582e8)}),_0x196518=Date[_0x4ea314(0xb5)]()-_0x16b236;console[_0x4ea314(0xe2)](_0x4ea314(0xc6)+_0x42910b[_0x4ea314(0x10a)]+'\x20with\x20status\x20'+_0x24c731[_0x4ea314(0xae)]+'\x20('+_0x196518+'ms)');}catch(_0x33c889){console[_0x4ea314(0x10f)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x33c889);}}async[a8_0x584c0e(0xea)](_0x31ae2c,_0x5c09df){const _0x3669d6=a8_0x584c0e;try{const {telegramBotService:_0x586f23}=await Promise['resolve']()[_0x3669d6(0x111)](()=>__importStar(require(_0x3669d6(0xff)))),_0x5c35d2={'PAID':_0x3669d6(0xa5),'FAILED':'failed'},_0x84e233=_0x5c35d2[_0x5c09df];if(!_0x84e233)return;await _0x586f23[_0x3669d6(0xbb)](_0x31ae2c[_0x3669d6(0xe6)],_0x31ae2c,_0x84e233);}catch(_0x341621){console[_0x3669d6(0x10f)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x341621);}}}exports[a8_0x584c0e(0xdc)]=PaymentController;