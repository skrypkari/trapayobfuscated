'use strict';const a8_0x57dc1e=a8_0x18ad;(function(_0x51d58c,_0x1e2d2b){const _0x559421=a8_0x18ad,_0x1c9b98=_0x51d58c();while(!![]){try{const _0x224f94=parseInt(_0x559421(0x22c))/0x1+-parseInt(_0x559421(0x1ed))/0x2+-parseInt(_0x559421(0x214))/0x3+-parseInt(_0x559421(0x1e5))/0x4+parseInt(_0x559421(0x234))/0x5*(parseInt(_0x559421(0x206))/0x6)+-parseInt(_0x559421(0x232))/0x7+-parseInt(_0x559421(0x1e2))/0x8*(-parseInt(_0x559421(0x230))/0x9);if(_0x224f94===_0x1e2d2b)break;else _0x1c9b98['push'](_0x1c9b98['shift']());}catch(_0x1c5160){_0x1c9b98['push'](_0x1c9b98['shift']());}}}(a8_0x3cc8,0x23a2c));var __createBinding=this&&this[a8_0x57dc1e(0x219)]||(Object[a8_0x57dc1e(0x1f9)]?function(_0x3b3298,_0x103487,_0x3a2ece,_0x3dc864){const _0x5a5a52=a8_0x57dc1e;if(_0x3dc864===undefined)_0x3dc864=_0x3a2ece;var _0x5bb1e3=Object['getOwnPropertyDescriptor'](_0x103487,_0x3a2ece);(!_0x5bb1e3||(_0x5a5a52(0x236)in _0x5bb1e3?!_0x103487[_0x5a5a52(0x202)]:_0x5bb1e3['writable']||_0x5bb1e3[_0x5a5a52(0x227)]))&&(_0x5bb1e3={'enumerable':!![],'get':function(){return _0x103487[_0x3a2ece];}}),Object[_0x5a5a52(0x218)](_0x3b3298,_0x3dc864,_0x5bb1e3);}:function(_0x40f886,_0x4865ba,_0x21bbee,_0x3cad68){if(_0x3cad68===undefined)_0x3cad68=_0x21bbee;_0x40f886[_0x3cad68]=_0x4865ba[_0x21bbee];}),__setModuleDefault=this&&this[a8_0x57dc1e(0x1fb)]||(Object[a8_0x57dc1e(0x1f9)]?function(_0x4a8831,_0x51ad7d){const _0x13ebe1=a8_0x57dc1e;Object[_0x13ebe1(0x218)](_0x4a8831,_0x13ebe1(0x200),{'enumerable':!![],'value':_0x51ad7d});}:function(_0x51601b,_0x49e2bd){const _0x127bc7=a8_0x57dc1e;_0x51601b[_0x127bc7(0x200)]=_0x49e2bd;}),__importStar=this&&this[a8_0x57dc1e(0x1f2)]||(function(){var _0x5ca51c=function(_0x13ff54){const _0x45793b=a8_0x18ad;return _0x5ca51c=Object[_0x45793b(0x240)]||function(_0x3cfbce){const _0x4f2b57=_0x45793b;var _0x1890e7=[];for(var _0x1279bd in _0x3cfbce)if(Object[_0x4f2b57(0x229)][_0x4f2b57(0x1f7)][_0x4f2b57(0x235)](_0x3cfbce,_0x1279bd))_0x1890e7[_0x1890e7[_0x4f2b57(0x1d5)]]=_0x1279bd;return _0x1890e7;},_0x5ca51c(_0x13ff54);};return function(_0x352634){const _0x49e9d8=a8_0x18ad;if(_0x352634&&_0x352634[_0x49e9d8(0x202)])return _0x352634;var _0x282444={};if(_0x352634!=null){for(var _0x2d87f8=_0x5ca51c(_0x352634),_0xb65822=0x0;_0xb65822<_0x2d87f8['length'];_0xb65822++)if(_0x2d87f8[_0xb65822]!==_0x49e9d8(0x200))__createBinding(_0x282444,_0x352634,_0x2d87f8[_0xb65822]);}return __setModuleDefault(_0x282444,_0x352634),_0x282444;};}()),__importDefault=this&&this[a8_0x57dc1e(0x1f4)]||function(_0x2a9918){return _0x2a9918&&_0x2a9918['__esModule']?_0x2a9918:{'default':_0x2a9918};};Object['defineProperty'](exports,a8_0x57dc1e(0x202),{'value':!![]}),exports[a8_0x57dc1e(0x23b)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x57dc1e(0x221)),webhookService_1=require(a8_0x57dc1e(0x233)),database_1=__importDefault(require(a8_0x57dc1e(0x1db)));class PaymentController{constructor(){const _0x1fba37=a8_0x57dc1e;this[_0x1fba37(0x217)]=async(_0xa30363,_0xfc2edd,_0x5dff79)=>{const _0x557288=_0x1fba37;try{const _0x3940fe=_0xa30363[_0x557288(0x23f)],_0x32e7a8=await this[_0x557288(0x1e4)][_0x557288(0x217)](_0x3940fe);_0xfc2edd['status'](0xc9)[_0x557288(0x226)]({'success':!![],'message':_0x557288(0x248),'result':_0x32e7a8});}catch(_0x201975){_0x5dff79(_0x201975);}},this[_0x1fba37(0x222)]=async(_0x2cc064,_0x30cee8,_0xdca6f8)=>{const _0x137610=_0x1fba37;try{const {id:_0x323c78}=_0x2cc064[_0x137610(0x1d9)],_0x22d8b7=await this['paymentService'][_0x137610(0x222)](_0x323c78);if(!_0x22d8b7)return _0x30cee8['status'](0x194)[_0x137610(0x226)]({'success':![],'message':_0x137610(0x1df)});_0x30cee8[_0x137610(0x226)]({'success':!![],'result':_0x22d8b7});}catch(_0x25f19d){_0xdca6f8(_0x25f19d);}},this[_0x1fba37(0x207)]=async(_0x46f34a,_0x4fad82,_0x40b743)=>{const _0x388c1e=_0x1fba37;try{const {id:_0x5bf120}=_0x46f34a[_0x388c1e(0x1d9)],_0x25f141=await this[_0x388c1e(0x1e4)][_0x388c1e(0x207)](_0x5bf120);if(!_0x25f141)return _0x4fad82['status'](0x194)[_0x388c1e(0x226)]({'success':![],'message':_0x388c1e(0x1df)});_0x4fad82['json']({'success':!![],'result':_0x25f141});}catch(_0x4b029a){_0x40b743(_0x4b029a);}},this['processMasterCardPayment']=async(_0x2273e3,_0x57e3db,_0x453350)=>{const _0x5470d1=_0x1fba37;try{const {id:_0x46f710}=_0x2273e3[_0x5470d1(0x1d9)],{cardData:_0x14c2cc,cardHolder:_0x356636,browser:_0x297fea}=_0x2273e3['body'];console[_0x5470d1(0x23c)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x46f710);const _0xf3afd4=await database_1['default'][_0x5470d1(0x210)][_0x5470d1(0x220)]({'where':{'id':_0x46f710},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xf3afd4)return _0x57e3db[_0x5470d1(0x209)](0x194)[_0x5470d1(0x226)]({'success':![],'message':_0x5470d1(0x1df)});if(_0xf3afd4[_0x5470d1(0x1dc)]!==_0x5470d1(0x1e8))return _0x57e3db[_0x5470d1(0x209)](0x190)[_0x5470d1(0x226)]({'success':![],'message':_0x5470d1(0x1ff)});if(_0xf3afd4[_0x5470d1(0x209)]!==_0x5470d1(0x1fe))return _0x57e3db['status'](0x190)[_0x5470d1(0x226)]({'success':![],'message':_0x5470d1(0x21b)+_0xf3afd4['status']+_0x5470d1(0x1d7)});const _0x2d7dd6=_0x5470d1(0x1ef),_0x1b164f=_0xf3afd4[_0x5470d1(0x1e9)];console[_0x5470d1(0x23c)](_0x5470d1(0x22e)),console['log'](_0x5470d1(0x22f)+_0x2d7dd6),console[_0x5470d1(0x23c)](_0x5470d1(0x201)+_0x1b164f);const _0x233d8d=await this['masterCardService'][_0x5470d1(0x237)]({'paymentId':_0xf3afd4['id'],'orderId':_0xf3afd4[_0x5470d1(0x1e7)]||_0xf3afd4['id'],'amount':_0xf3afd4[_0x5470d1(0x23a)],'currency':_0xf3afd4[_0x5470d1(0x20c)],'cardData':_0x14c2cc,'resultUrl':_0x2d7dd6,'returnUrl':_0x1b164f,'cardHolder':_0x356636,'browser':_0x297fea});console[_0x5470d1(0x23c)](_0x5470d1(0x223),_0x233d8d);const _0x20cb09={'status':_0x233d8d[_0x5470d1(0x209)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x233d8d[_0x5470d1(0x209)]===_0x5470d1(0x213))_0x20cb09[_0x5470d1(0x22b)]=new Date(),_0x20cb09[_0x5470d1(0x1e0)]=_0x233d8d[_0x5470d1(0x1d6)];else _0x233d8d[_0x5470d1(0x209)]===_0x5470d1(0x1d8)&&(_0x20cb09[_0x5470d1(0x249)]=_0x5470d1(0x20d));_0x20cb09[_0x5470d1(0x243)]=_0x5470d1(0x1e8),await database_1[_0x5470d1(0x200)][_0x5470d1(0x210)][_0x5470d1(0x21e)]({'where':{'id':_0xf3afd4['id']},'data':_0x20cb09}),await database_1['default'][_0x5470d1(0x239)][_0x5470d1(0x1f9)]({'data':{'paymentId':_0xf3afd4['id'],'shopId':_0xf3afd4[_0x5470d1(0x1f8)],'event':_0x5470d1(0x1f1)+_0x233d8d[_0x5470d1(0x209)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x233d8d['status'],'gatewayPaymentId':_0x233d8d[_0x5470d1(0x1d6)],'requires3ds':_0x233d8d[_0x5470d1(0x211)],'processedAt':new Date()[_0x5470d1(0x216)]()})}});_0x233d8d[_0x5470d1(0x246)]&&(await this[_0x5470d1(0x21f)](_0xf3afd4,_0x233d8d[_0x5470d1(0x209)],_0x233d8d[_0x5470d1(0x1d6)]),await this[_0x5470d1(0x1f3)](_0xf3afd4,_0x233d8d['status']));console[_0x5470d1(0x23c)](_0x5470d1(0x1da)+_0x46f710+'\x20processed:\x20'+_0x233d8d[_0x5470d1(0x209)]);if(_0x233d8d['status']===_0x5470d1(0x213))_0x57e3db['json']({'success':!![],'message':_0x5470d1(0x1e3),'result':{'status':'PAID','gatewayPaymentId':_0x233d8d[_0x5470d1(0x1d6)],'redirectUrl':_0x1b164f,'final':!![]}});else _0x233d8d[_0x5470d1(0x211)]&&_0x233d8d['threeds_url']?_0x57e3db[_0x5470d1(0x226)]({'success':!![],'message':_0x5470d1(0x1ee),'result':{'status':_0x5470d1(0x1fe),'gatewayPaymentId':_0x233d8d[_0x5470d1(0x1d6)],'redirectUrl':_0x233d8d[_0x5470d1(0x1de)],'requires3ds':!![],'final':![]}}):_0x57e3db[_0x5470d1(0x209)](0x190)['json']({'success':![],'message':_0x5470d1(0x247),'result':{'status':'FAILED','gatewayPaymentId':_0x233d8d[_0x5470d1(0x1d6)],'redirectUrl':_0xf3afd4['failUrl'],'final':!![]}});}catch(_0x35578c){_0x453350(_0x35578c);}},this[_0x1fba37(0x21d)]=async(_0x5a6f9c,_0x15bf4a,_0x4824c8)=>{const _0x4d7885=_0x1fba37;try{const {id:_0x4a2355}=_0x5a6f9c[_0x4d7885(0x1d9)],{customerIp:_0x45e9cc,customerUa:_0x30a442,customerCountry:_0x42f323}=_0x5a6f9c['body'],_0x57bf69=await database_1['default']['payment'][_0x4d7885(0x220)]({'where':{'id':_0x4a2355},'select':{'id':!![],'status':!![]}});if(!_0x57bf69)return _0x15bf4a['status'](0x194)[_0x4d7885(0x226)]({'success':![],'message':_0x4d7885(0x1df)});const _0x3a3c57=await database_1[_0x4d7885(0x200)][_0x4d7885(0x210)][_0x4d7885(0x21e)]({'where':{'id':_0x4a2355},'data':{'customerIp':_0x45e9cc||undefined,'customerUa':_0x30a442||undefined,'customerCountry':_0x42f323||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x4d7885(0x23c)](_0x4d7885(0x245)+_0x4a2355+':',{'customerIp':_0x45e9cc||_0x4d7885(0x242),'customerUa':_0x30a442?_0x30a442[_0x4d7885(0x1ea)](0x0,0x32)+_0x4d7885(0x1fd):_0x4d7885(0x242),'customerCountry':_0x42f323||'not\x20provided'}),_0x15bf4a['json']({'success':!![],'message':_0x4d7885(0x215),'result':_0x3a3c57});}catch(_0x46dd10){_0x4824c8(_0x46dd10);}},this[_0x1fba37(0x1e4)]=new paymentService_1[(_0x1fba37(0x205))](),this['masterCardService']=new mastercardService_1[(_0x1fba37(0x1dd))](),this[_0x1fba37(0x203)]=new webhookService_1[(_0x1fba37(0x1fc))]();}async[a8_0x57dc1e(0x21f)](_0x5a5140,_0x47fa5f,_0x57cf14){const _0x55d988=a8_0x57dc1e,_0xf2c283=Date['now']();try{const _0x227a69=_0x5a5140['shop'],_0xf656bc=_0x227a69['settings'];if(!_0xf656bc?.[_0x55d988(0x244)]){console[_0x55d988(0x23c)](_0x55d988(0x212)+_0x227a69['id']);return;}const _0x25fcce=_0x47fa5f===_0x55d988(0x213)?_0x55d988(0x1ec):_0x55d988(0x204);let _0x410c5b=[];if(_0xf656bc['webhookEvents'])try{_0x410c5b=Array['isArray'](_0xf656bc['webhookEvents'])?_0xf656bc[_0x55d988(0x1fa)]:JSON[_0x55d988(0x21a)](_0xf656bc['webhookEvents']);}catch(_0x25fb8b){console[_0x55d988(0x1e1)](_0x55d988(0x1f0),_0x25fb8b),_0x410c5b=[];}if(!_0x410c5b[_0x55d988(0x20f)](_0x25fcce)){console[_0x55d988(0x23c)](_0x55d988(0x1eb)+_0x25fcce+_0x55d988(0x228)+_0x227a69['id']);return;}const _0x3bc6a0={'event':_0x25fcce,'payment':{'id':_0x5a5140['id'],'order_id':_0x5a5140[_0x55d988(0x224)],'gateway_order_id':_0x5a5140[_0x55d988(0x1e7)],'gateway':_0x55d988(0x1f5),'amount':_0x5a5140[_0x55d988(0x23a)],'currency':_0x5a5140[_0x55d988(0x20c)],'status':_0x47fa5f[_0x55d988(0x20b)](),'customer_email':_0x5a5140['customerEmail'],'customer_name':_0x5a5140[_0x55d988(0x208)],'gateway_payment_id':_0x57cf14,'created_at':_0x5a5140[_0x55d988(0x231)],'updated_at':new Date()}},_0x20d06f=await fetch(_0xf656bc['webhookUrl'],{'method':_0x55d988(0x20e),'headers':{'Content-Type':_0x55d988(0x23e),'User-Agent':_0x55d988(0x1e6)},'body':JSON[_0x55d988(0x21c)](_0x3bc6a0)}),_0x174f93=Date['now']()-_0xf2c283;console[_0x55d988(0x23c)](_0x55d988(0x1f6)+_0xf656bc[_0x55d988(0x244)]+'\x20with\x20status\x20'+_0x20d06f[_0x55d988(0x209)]+'\x20('+_0x174f93+_0x55d988(0x23d));}catch(_0x5f56d8){console[_0x55d988(0x1e1)](_0x55d988(0x241),_0x5f56d8);}}async[a8_0x57dc1e(0x1f3)](_0x595b5b,_0xbe3e4b){const _0x3c62ae=a8_0x57dc1e;try{const {telegramBotService:_0x1a91ed}=await Promise[_0x3c62ae(0x225)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x56b3c7={'PAID':_0x3c62ae(0x238),'FAILED':_0x3c62ae(0x22d)},_0x51c3b1=_0x56b3c7[_0xbe3e4b];if(!_0x51c3b1)return;await _0x1a91ed[_0x3c62ae(0x22a)](_0x595b5b[_0x3c62ae(0x1f8)],_0x595b5b,_0x51c3b1);}catch(_0x166a43){console[_0x3c62ae(0x1e1)](_0x3c62ae(0x20a),_0x166a43);}}}exports[a8_0x57dc1e(0x23b)]=PaymentController;function a8_0x18ad(_0x4f49be,_0x57b500){const _0x3cc853=a8_0x3cc8();return a8_0x18ad=function(_0x18add3,_0xaafcc5){_0x18add3=_0x18add3-0x1d5;let _0xbd12f=_0x3cc853[_0x18add3];return _0xbd12f;},a8_0x18ad(_0x4f49be,_0x57b500);}function a8_0x3cc8(){const _0x13900d=['PENDING','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','default','\x20\x20\x20Return\x20URL:\x20','__esModule','webhookService','payment.failed','PaymentService','305130kgfuwQ','getPaymentById','customerName','status','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','toLowerCase','currency','Card\x20payment\x20failed','POST','includes','payment','requires_3ds','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PAID','30141CTfhBm','Customer\x20data\x20updated\x20successfully','toISOString','createPublicPayment','defineProperty','__createBinding','parse','Payment\x20status\x20is\x20','stringify','updateCustomerData','update','sendShopWebhook','findUnique','../services/gateways/mastercardService','getPaymentStatus','ðŸ’³\x20MasterCard\x20result:','orderId','resolve','json','configurable','\x20not\x20enabled\x20for\x20shop\x20','prototype','sendPaymentNotification','paidAt','125311mFhDxt','failed','ðŸ’³\x20MasterCard\x20URLs:','\x20\x20\x20Result\x20URL\x20(webhook):\x20','396GwEXog','createdAt','72884wwmYzX','../services/webhookService','15ZvCbFL','call','get','processCardPayment','paid','webhookLog','amount','PaymentController','log','ms)','application/json','body','getOwnPropertyNames','Failed\x20to\x20send\x20MasterCard\x20webhook:','not\x20provided','paymentMethod','webhookUrl','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','final','Payment\x20failed','Payment\x20created\x20successfully','failureMessage','length','gateway_payment_id',',\x20cannot\x20process','FAILED','params','âœ…\x20MasterCard\x20payment\x20','../config/database','gateway','MasterCardService','threeds_url','Payment\x20not\x20found','gatewayPaymentId','error','41568fpNMFq','Payment\x20processed\x20successfully','paymentService','1012196RDLyhP','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','gatewayOrderId','mastercard','successUrl','substring','Webhook\x20event\x20','payment.success','174056RiOMVS','3DS\x20verification\x20required','https://api.trapay.uk/api/webhooks/gateway/mastercard','Error\x20parsing\x20webhook\x20events:','mastercard_','__importStar','sendPaymentStatusNotification','__importDefault','1111','MasterCard\x20webhook\x20sent\x20to\x20','hasOwnProperty','shopId','create','webhookEvents','__setModuleDefault','WebhookService','...'];a8_0x3cc8=function(){return _0x13900d;};return a8_0x3cc8();}