'use strict';const a8_0x2955cd=a8_0x55af;(function(_0x451fc9,_0x3694f7){const _0x12e982=a8_0x55af,_0x4c07cd=_0x451fc9();while(!![]){try{const _0x54fd0b=parseInt(_0x12e982(0x213))/0x1*(-parseInt(_0x12e982(0x1ce))/0x2)+parseInt(_0x12e982(0x1c5))/0x3*(parseInt(_0x12e982(0x1ed))/0x4)+parseInt(_0x12e982(0x1e9))/0x5*(-parseInt(_0x12e982(0x216))/0x6)+-parseInt(_0x12e982(0x1f5))/0x7*(parseInt(_0x12e982(0x224))/0x8)+parseInt(_0x12e982(0x1df))/0x9+-parseInt(_0x12e982(0x20a))/0xa+parseInt(_0x12e982(0x228))/0xb;if(_0x54fd0b===_0x3694f7)break;else _0x4c07cd['push'](_0x4c07cd['shift']());}catch(_0x305c4a){_0x4c07cd['push'](_0x4c07cd['shift']());}}}(a8_0x3479,0x25493));function a8_0x55af(_0x4239bc,_0x548bf5){const _0x3479f5=a8_0x3479();return a8_0x55af=function(_0x55afca,_0x1591b6){_0x55afca=_0x55afca-0x1c1;let _0x587a0e=_0x3479f5[_0x55afca];return _0x587a0e;},a8_0x55af(_0x4239bc,_0x548bf5);}function a8_0x3479(){const _0x4b3ffb=['processMasterCardPayment','customerUa','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20status\x20is\x20','37218tJryml','getOwnPropertyDescriptor','📈\x20MasterCard\x20payment\x20','isArray','../services/gateways/mastercardService','MasterCardService','gatewayPaymentId','💳\x20MasterCard\x20URLs:','💳\x20MasterCard\x20result:','currency','first_name','failed','createPublicPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','../services/paymentService','Payment\x20processed\x20successfully','includes','203004kYCNeA','3DS\x20verification\x20required','log','getPaymentStatus','paymentService','customerIp','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','sendPaymentNotification','💳\x20Processing\x20MasterCard\x20payment:\x20','Webhook\x20event\x20','24565zyHnez','prototype','slice','Error\x20parsing\x20webhook\x20events:','1580sMoTYW','mastercard','default','error','replace','updatedAt','1111','customerEmail','14WkHCIX','update','settings','shopId','then','stringify','webhookService','mastercard_','Failed\x20to\x20send\x20MasterCard\x20webhook:','findUnique','PENDING','masterCardService','gatewayOrderId','create','gateway_payment_id','customerName','createdAt','PAID','webhookEvents','payment','sendShopWebhook','1318120foqVQG',',\x20cannot\x20process','application/json','Payment\x20created\x20successfully','json','successUrl','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','toISOString','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','1GFNHdY','length','orderId','222aMakIw','__createBinding','PaymentController','💳\x20Card\x20holder:\x20','webhookUrl','../services/paymentLinkService','body','cardLast4','toLowerCase','amount','hasOwnProperty','__importStar','shop','call','180448ZPTtnN','gateway','requires_3ds','threeds_url','4204926JaQHCU','failureMessage','paidAt','email','now','paid','handleSuccessfulPayment','💳\x20Browser\x20IP:\x20','Customer\x20data\x20updated\x20successfully','Payment\x20not\x20found','sendPaymentStatusNotification','defineProperty','\x20processed:\x20','get','paymentMethod','Card\x20payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','final','✅\x20MasterCard\x20payment\x20','parse','status','params','getPaymentById','Payment\x20failed','last_name','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','updatePaymentCustomerDataPublic','MasterCard\x20webhook\x20sent\x20to\x20','951XITOeq','PaymentService','__esModule','resolve','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'];a8_0x3479=function(){return _0x4b3ffb;};return a8_0x3479();}var __createBinding=this&&this[a8_0x2955cd(0x217)]||(Object[a8_0x2955cd(0x202)]?function(_0x1effde,_0x3110ae,_0x422f83,_0xd141d2){const _0x31803f=a8_0x2955cd;if(_0xd141d2===undefined)_0xd141d2=_0x422f83;var _0x4bdb7b=Object[_0x31803f(0x1cf)](_0x3110ae,_0x422f83);(!_0x4bdb7b||(_0x31803f(0x235)in _0x4bdb7b?!_0x3110ae['__esModule']:_0x4bdb7b['writable']||_0x4bdb7b['configurable']))&&(_0x4bdb7b={'enumerable':!![],'get':function(){return _0x3110ae[_0x422f83];}}),Object[_0x31803f(0x233)](_0x1effde,_0xd141d2,_0x4bdb7b);}:function(_0x2d6cff,_0x54916b,_0x441a48,_0x33f0e6){if(_0x33f0e6===undefined)_0x33f0e6=_0x441a48;_0x2d6cff[_0x33f0e6]=_0x54916b[_0x441a48];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x353af3,_0x534753){const _0x503cab=a8_0x2955cd;Object[_0x503cab(0x233)](_0x353af3,'default',{'enumerable':!![],'value':_0x534753});}:function(_0x21a694,_0x197268){const _0x3a37df=a8_0x2955cd;_0x21a694[_0x3a37df(0x1ef)]=_0x197268;}),__importStar=this&&this[a8_0x2955cd(0x221)]||(function(){var _0xdf837e=function(_0x552378){return _0xdf837e=Object['getOwnPropertyNames']||function(_0x14782f){const _0x399c4e=a8_0x55af;var _0x1befe4=[];for(var _0x487b5a in _0x14782f)if(Object[_0x399c4e(0x1ea)][_0x399c4e(0x220)][_0x399c4e(0x223)](_0x14782f,_0x487b5a))_0x1befe4[_0x1befe4[_0x399c4e(0x214)]]=_0x487b5a;return _0x1befe4;},_0xdf837e(_0x552378);};return function(_0x3930e2){const _0x3ea7c2=a8_0x55af;if(_0x3930e2&&_0x3930e2[_0x3ea7c2(0x1c7)])return _0x3930e2;var _0x42afe3={};if(_0x3930e2!=null){for(var _0x5bfc28=_0xdf837e(_0x3930e2),_0x29c79c=0x0;_0x29c79c<_0x5bfc28[_0x3ea7c2(0x214)];_0x29c79c++)if(_0x5bfc28[_0x29c79c]!==_0x3ea7c2(0x1ef))__createBinding(_0x42afe3,_0x3930e2,_0x5bfc28[_0x29c79c]);}return __setModuleDefault(_0x42afe3,_0x3930e2),_0x42afe3;};}()),__importDefault=this&&this['__importDefault']||function(_0x52860e){const _0x40e73c=a8_0x2955cd;return _0x52860e&&_0x52860e[_0x40e73c(0x1c7)]?_0x52860e:{'default':_0x52860e};};Object[a8_0x2955cd(0x233)](exports,a8_0x2955cd(0x1c7),{'value':!![]}),exports[a8_0x2955cd(0x218)]=void 0x0;const paymentService_1=require(a8_0x2955cd(0x1dc)),mastercardService_1=require(a8_0x2955cd(0x1d2)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x13ade8=a8_0x2955cd;this[_0x13ade8(0x1da)]=async(_0x10687d,_0x18ee2e,_0x8795f3)=>{const _0x3a5356=_0x13ade8;try{const _0x203e1e=_0x10687d[_0x3a5356(0x21c)],_0x4e8c6a=await this['paymentService'][_0x3a5356(0x1da)](_0x203e1e);_0x18ee2e[_0x3a5356(0x23c)](0xc9)[_0x3a5356(0x20e)]({'success':!![],'message':_0x3a5356(0x20d),'result':_0x4e8c6a});}catch(_0x5a5467){_0x8795f3(_0x5a5467);}},this[_0x13ade8(0x1e2)]=async(_0x5c3375,_0x301b9a,_0x509bac)=>{const _0x388652=_0x13ade8;try{const {id:_0x48afcc}=_0x5c3375[_0x388652(0x23d)],_0x388997=await this[_0x388652(0x1e3)]['getPaymentStatus'](_0x48afcc);if(!_0x388997)return _0x301b9a[_0x388652(0x23c)](0x194)[_0x388652(0x20e)]({'success':![],'message':_0x388652(0x231)});_0x301b9a[_0x388652(0x20e)]({'success':!![],'result':_0x388997});}catch(_0x58a3f4){_0x509bac(_0x58a3f4);}},this[_0x13ade8(0x23e)]=async(_0x13d89d,_0x86364,_0x2f2321)=>{const _0x196c86=_0x13ade8;try{const {id:_0x3fa9f2}=_0x13d89d['params'],_0x443916=await this[_0x196c86(0x1e3)][_0x196c86(0x23e)](_0x3fa9f2);if(!_0x443916)return _0x86364[_0x196c86(0x23c)](0x194)[_0x196c86(0x20e)]({'success':![],'message':_0x196c86(0x231)});_0x86364[_0x196c86(0x20e)]({'success':!![],'result':_0x443916});}catch(_0x1604ef){_0x2f2321(_0x1604ef);}},this['updatePaymentCustomer']=async(_0x319560,_0x47e1c5,_0xdad246)=>{const _0x4b4906=_0x13ade8;try{const {id:_0xbb4bc4}=_0x319560['params'],_0x38dfdc=_0x319560[_0x4b4906(0x21c)];console['log'](_0x4b4906(0x210)+_0xbb4bc4),console[_0x4b4906(0x1e1)]('📝\x20Customer\x20data:',_0x38dfdc);const _0x102d1a=await this[_0x4b4906(0x1e3)][_0x4b4906(0x1c3)](_0xbb4bc4,_0x38dfdc);if(!_0x102d1a)return _0x47e1c5[_0x4b4906(0x23c)](0x194)['json']({'success':![],'message':_0x4b4906(0x231)});_0x47e1c5[_0x4b4906(0x20e)]({'success':!![],'message':_0x4b4906(0x230),'result':{'paymentId':_0x102d1a['id'],'customerIp':_0x102d1a[_0x4b4906(0x1e4)],'customerUa':_0x102d1a[_0x4b4906(0x1cb)],'customerCountry':_0x102d1a['customerCountry'],'updatedAt':_0x102d1a[_0x4b4906(0x1f2)]}});}catch(_0x4f1e91){_0xdad246(_0x4f1e91);}},this[_0x13ade8(0x1ca)]=async(_0x569338,_0x65978f,_0x5e287f)=>{const _0x3a9db3=_0x13ade8;try{const {id:_0x40023a}=_0x569338[_0x3a9db3(0x23d)],{cardData:_0x17edaa,cardHolder:_0x5aaee8,browser:_0x1647d2}=_0x569338[_0x3a9db3(0x21c)];console[_0x3a9db3(0x1e1)](_0x3a9db3(0x1e7)+_0x40023a),console[_0x3a9db3(0x1e1)](_0x3a9db3(0x219)+_0x5aaee8[_0x3a9db3(0x1d8)]+'\x20'+_0x5aaee8[_0x3a9db3(0x1c1)]+'\x20('+_0x5aaee8['email']+')'),console['log'](_0x3a9db3(0x22f)+_0x1647d2['ip']);const _0x17f0a0={'customerName':_0x5aaee8[_0x3a9db3(0x1d8)]+'\x20'+_0x5aaee8[_0x3a9db3(0x1c1)],'customerEmail':_0x5aaee8[_0x3a9db3(0x22b)],'customerIp':_0x1647d2['ip'],'customerUa':_0x1647d2['user_agent']},_0x17734a=await database_1['default'][_0x3a9db3(0x208)][_0x3a9db3(0x1fe)]({'where':{'id':_0x40023a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x17734a)return _0x65978f[_0x3a9db3(0x23c)](0x194)[_0x3a9db3(0x20e)]({'success':![],'message':_0x3a9db3(0x231)});if(_0x17734a[_0x3a9db3(0x225)]!==_0x3a9db3(0x1ee))return _0x65978f['status'](0x190)[_0x3a9db3(0x20e)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x17734a[_0x3a9db3(0x23c)]!==_0x3a9db3(0x1ff))return _0x65978f[_0x3a9db3(0x23c)](0x190)['json']({'success':![],'message':_0x3a9db3(0x1cd)+_0x17734a[_0x3a9db3(0x23c)]+_0x3a9db3(0x20b)});await database_1[_0x3a9db3(0x1ef)][_0x3a9db3(0x208)][_0x3a9db3(0x1f6)]({'where':{'id':_0x40023a},'data':{..._0x17f0a0,'updatedAt':new Date()}});const _0x1f8d0f=_0x3a9db3(0x1db),_0x55d87b=_0x17734a[_0x3a9db3(0x20f)];console['log'](_0x3a9db3(0x1d5)),console['log'](_0x3a9db3(0x238)+_0x1f8d0f),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x55d87b);const _0x4d906d={'first_name':_0x5aaee8['first_name'],'last_name':_0x5aaee8[_0x3a9db3(0x1c1)],'email':_0x5aaee8[_0x3a9db3(0x22b)]},_0x273424=await this['masterCardService']['processCardPayment']({'paymentId':_0x17734a['id'],'orderId':_0x17734a[_0x3a9db3(0x201)]||_0x17734a['id'],'amount':_0x17734a['amount'],'currency':_0x17734a['currency'],'cardData':_0x17edaa,'resultUrl':_0x1f8d0f,'returnUrl':_0x55d87b,'cardHolder':_0x4d906d,'browser':_0x1647d2});console['log'](_0x3a9db3(0x1d6),_0x273424);const _0x4c480e={'status':_0x273424[_0x3a9db3(0x23c)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x273424[_0x3a9db3(0x203)]&&(_0x4c480e[_0x3a9db3(0x1d4)]=_0x273424[_0x3a9db3(0x203)],console['log'](_0x3a9db3(0x212)+_0x273424[_0x3a9db3(0x203)]));if(_0x273424[_0x3a9db3(0x23c)]===_0x3a9db3(0x206))_0x4c480e[_0x3a9db3(0x22a)]=new Date();else _0x273424[_0x3a9db3(0x23c)]==='FAILED'&&(_0x4c480e[_0x3a9db3(0x229)]=_0x3a9db3(0x237));_0x4c480e[_0x3a9db3(0x236)]=_0x3a9db3(0x1ee);if(_0x17edaa['number']){const _0x37c948=_0x17edaa['number'][_0x3a9db3(0x1f1)](/[\s-]/g,'');_0x4c480e[_0x3a9db3(0x21d)]=_0x37c948[_0x3a9db3(0x1eb)](-0x4),console[_0x3a9db3(0x1e1)](_0x3a9db3(0x1e5)+_0x4c480e[_0x3a9db3(0x21d)]);}await database_1[_0x3a9db3(0x1ef)][_0x3a9db3(0x208)]['update']({'where':{'id':_0x17734a['id']},'data':_0x4c480e}),await database_1[_0x3a9db3(0x1ef)]['webhookLog'][_0x3a9db3(0x202)]({'data':{'paymentId':_0x17734a['id'],'shopId':_0x17734a[_0x3a9db3(0x1f8)],'event':_0x3a9db3(0x1fc)+_0x273424[_0x3a9db3(0x23c)]?.[_0x3a9db3(0x21e)](),'statusCode':0xc8,'responseBody':JSON[_0x3a9db3(0x1fa)]({'oldStatus':_0x3a9db3(0x1ff),'newStatus':_0x273424[_0x3a9db3(0x23c)],'gatewayPaymentId':_0x273424[_0x3a9db3(0x203)],'requires3ds':_0x273424[_0x3a9db3(0x226)],'processedAt':new Date()[_0x3a9db3(0x211)]()})}});if(_0x273424[_0x3a9db3(0x239)]){await this[_0x3a9db3(0x209)](_0x17734a,_0x273424[_0x3a9db3(0x23c)],_0x273424['gateway_payment_id']),await this[_0x3a9db3(0x232)](_0x17734a,_0x273424[_0x3a9db3(0x23c)]);if(_0x273424['status']===_0x3a9db3(0x206)){console[_0x3a9db3(0x1e1)](_0x3a9db3(0x1d0)+_0x40023a+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x33ba99}=await Promise['resolve']()['then'](()=>__importStar(require(_0x3a9db3(0x21b)))),_0x53288f=new _0x33ba99();await _0x53288f[_0x3a9db3(0x22e)](_0x40023a),console[_0x3a9db3(0x1e1)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x40023a);}catch(_0x52e0c2){console[_0x3a9db3(0x1f0)](_0x3a9db3(0x1c2),_0x52e0c2);}}}console['log'](_0x3a9db3(0x23a)+_0x40023a+_0x3a9db3(0x234)+_0x273424[_0x3a9db3(0x23c)]);if(_0x273424['status']==='PAID')_0x65978f[_0x3a9db3(0x20e)]({'success':!![],'message':_0x3a9db3(0x1dd),'result':{'status':_0x3a9db3(0x206),'gatewayPaymentId':_0x273424['gateway_payment_id'],'redirectUrl':_0x55d87b,'final':!![]}});else _0x273424[_0x3a9db3(0x226)]&&_0x273424[_0x3a9db3(0x227)]?_0x65978f[_0x3a9db3(0x20e)]({'success':!![],'message':_0x3a9db3(0x1e0),'result':{'status':'PENDING','gatewayPaymentId':_0x273424[_0x3a9db3(0x203)],'redirectUrl':_0x273424[_0x3a9db3(0x227)],'requires3ds':!![],'final':![]}}):_0x65978f[_0x3a9db3(0x23c)](0x190)[_0x3a9db3(0x20e)]({'success':![],'message':_0x3a9db3(0x23f),'result':{'status':'FAILED','gatewayPaymentId':_0x273424[_0x3a9db3(0x203)],'redirectUrl':_0x17734a['failUrl'],'final':!![]}});}catch(_0x297bd3){_0x5e287f(_0x297bd3);}},this['paymentService']=new paymentService_1[(_0x13ade8(0x1c6))](),this[_0x13ade8(0x200)]=new mastercardService_1[(_0x13ade8(0x1d3))](),this[_0x13ade8(0x1fb)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x5634c7,_0x3e0f20,_0x56bc3b){const _0x18ba24=a8_0x2955cd,_0x41aea3=Date[_0x18ba24(0x22c)]();try{const _0x575ba2=_0x5634c7[_0x18ba24(0x222)],_0x1504c4=_0x575ba2[_0x18ba24(0x1f7)];if(!_0x1504c4?.[_0x18ba24(0x21a)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x575ba2['id']);return;}const _0xbe585a=_0x3e0f20===_0x18ba24(0x206)?'payment.success':'payment.failed';let _0x4e6f27=[];if(_0x1504c4[_0x18ba24(0x207)])try{_0x4e6f27=Array[_0x18ba24(0x1d1)](_0x1504c4[_0x18ba24(0x207)])?_0x1504c4[_0x18ba24(0x207)]:JSON[_0x18ba24(0x23b)](_0x1504c4[_0x18ba24(0x207)]);}catch(_0x366e52){console[_0x18ba24(0x1f0)](_0x18ba24(0x1ec),_0x366e52),_0x4e6f27=[];}if(!_0x4e6f27[_0x18ba24(0x1de)](_0xbe585a)){console['log'](_0x18ba24(0x1e8)+_0xbe585a+_0x18ba24(0x1cc)+_0x575ba2['id']);return;}const _0x1161cf={'event':_0xbe585a,'payment':{'id':_0x5634c7['id'],'order_id':_0x5634c7[_0x18ba24(0x215)],'gateway_order_id':_0x5634c7['gatewayOrderId'],'gateway':_0x18ba24(0x1f3),'amount':_0x5634c7[_0x18ba24(0x21f)],'currency':_0x5634c7[_0x18ba24(0x1d7)],'status':_0x3e0f20[_0x18ba24(0x21e)](),'customer_email':_0x5634c7[_0x18ba24(0x1f4)],'customer_name':_0x5634c7[_0x18ba24(0x204)],'gateway_payment_id':_0x56bc3b,'created_at':_0x5634c7[_0x18ba24(0x205)],'updated_at':new Date()}},_0x59e05a=await fetch(_0x1504c4['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x18ba24(0x20c),'User-Agent':_0x18ba24(0x1c9)},'body':JSON['stringify'](_0x1161cf)}),_0x43d9f4=Date[_0x18ba24(0x22c)]()-_0x41aea3;console[_0x18ba24(0x1e1)](_0x18ba24(0x1c4)+_0x1504c4[_0x18ba24(0x21a)]+'\x20with\x20status\x20'+_0x59e05a[_0x18ba24(0x23c)]+'\x20('+_0x43d9f4+'ms)');}catch(_0x55cb16){console['error'](_0x18ba24(0x1fd),_0x55cb16);}}async[a8_0x2955cd(0x232)](_0x6870a9,_0x43e29a){const _0x1483f7=a8_0x2955cd;try{const {telegramBotService:_0x4cdf6b}=await Promise[_0x1483f7(0x1c8)]()[_0x1483f7(0x1f9)](()=>__importStar(require('../services/telegramBotService'))),_0x5cb6ab={'PAID':_0x1483f7(0x22d),'FAILED':_0x1483f7(0x1d9)},_0x20977e=_0x5cb6ab[_0x43e29a];if(!_0x20977e)return;await _0x4cdf6b[_0x1483f7(0x1e6)](_0x6870a9['shopId'],_0x6870a9,_0x20977e);}catch(_0x79c5a1){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x79c5a1);}}}exports['PaymentController']=PaymentController;