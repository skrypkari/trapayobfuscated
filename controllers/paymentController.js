'use strict';const a8_0x2cb6db=a8_0x316f;function a8_0x316f(_0x8e3cc8,_0x2b4ef8){const _0x91810f=a8_0x9181();return a8_0x316f=function(_0x316f81,_0x59a622){_0x316f81=_0x316f81-0x167;let _0x11fd53=_0x91810f[_0x316f81];return _0x11fd53;},a8_0x316f(_0x8e3cc8,_0x2b4ef8);}(function(_0x298d76,_0x1f8081){const _0x46a93f=a8_0x316f,_0x236212=_0x298d76();while(!![]){try{const _0x4f73d3=-parseInt(_0x46a93f(0x1a0))/0x1*(-parseInt(_0x46a93f(0x1e3))/0x2)+-parseInt(_0x46a93f(0x1c9))/0x3*(parseInt(_0x46a93f(0x16a))/0x4)+-parseInt(_0x46a93f(0x18d))/0x5*(parseInt(_0x46a93f(0x1b6))/0x6)+-parseInt(_0x46a93f(0x1c4))/0x7+-parseInt(_0x46a93f(0x1da))/0x8*(-parseInt(_0x46a93f(0x169))/0x9)+-parseInt(_0x46a93f(0x1c2))/0xa*(-parseInt(_0x46a93f(0x16e))/0xb)+-parseInt(_0x46a93f(0x1db))/0xc*(-parseInt(_0x46a93f(0x179))/0xd);if(_0x4f73d3===_0x1f8081)break;else _0x236212['push'](_0x236212['shift']());}catch(_0x5b0938){_0x236212['push'](_0x236212['shift']());}}}(a8_0x9181,0xa02ea));function a8_0x9181(){const _0x31347f=['currency','5715031HFsqaD','__esModule','call','replace','createPublicPayment','3112593ESjLzR','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','updatePaymentCustomer','üí≥\x20MasterCard\x20URLs:','system','../services/paymentLinkService','../services/gateways/mastercardService','orderId','PAID','shopId','POST','successUrl','toLowerCase','customerCountry','processMasterCardPayment','log','first_name','1336Cesqnj','1532592qZbJro','webhookEvents','then','PENDING','number','failureMessage','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Error\x20parsing\x20webhook\x20events:','2QSUbnU','üìù\x20Customer\x20data:','webhookService','mastercard_','cardLast4','masterCardService','PaymentController','Customer\x20data\x20updated\x20successfully','1440HaeIwX','4vSgxrS','__importStar','now','last_name','22XktSUO','sendPaymentStatusNotification','updatePaymentCustomerDataPublic','\x20not\x20enabled\x20for\x20shop\x20','application/json','gateway_payment_id','../services/telegramBotService','\x20processed:\x20','processCardPayment','Webhook\x20event\x20','get','247xbOUBr','final','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20with\x20status\x20','__setModuleDefault','\x20\x20\x20Return\x20URL:\x20','../config/database','handleSuccessfulPayment','length','parse','Payment\x20failed','üí≥\x20Processing\x20MasterCard\x20payment:\x20','failUrl','resolve','error','findUnique','MasterCard\x20webhook\x20sent\x20to\x20','üí≥\x20MasterCard\x20result:','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','settings','35gYdYsf','MasterCardService','default','getPaymentById','failed','1111','isArray','WebhookService','üí≥\x20Card\x20holder:\x20','toISOString','update','payment.success','paymentService','payment','create','ms)','getPaymentStatus','paymentMethod','email','155793LZheyw','customerEmail','paidAt','json','country','getOwnPropertyNames','params','sendPaymentNotification','gatewayOrderId','gateway','https://api.trapay.uk/api/webhooks/gateway/mastercard','body','hasOwnProperty','Card\x20payment\x20failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerUa','Payment\x20not\x20found','webhookUrl','stringify','customerName','defineProperty','../services/webhookService','733794uHgXQD','FAILED','sendShopWebhook','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','writable','../services/paymentService','üìà\x20MasterCard\x20payment\x20','mastercard','status','requires_3ds','paid','gatewayPaymentId','3785230jyXsan'];a8_0x9181=function(){return _0x31347f;};return a8_0x9181();}var __createBinding=this&&this['__createBinding']||(Object[a8_0x2cb6db(0x19b)]?function(_0x53cec7,_0x232409,_0x16e0c3,_0x1c3c9d){const _0x737048=a8_0x2cb6db;if(_0x1c3c9d===undefined)_0x1c3c9d=_0x16e0c3;var _0x400315=Object['getOwnPropertyDescriptor'](_0x232409,_0x16e0c3);(!_0x400315||(_0x737048(0x178)in _0x400315?!_0x232409[_0x737048(0x1c5)]:_0x400315[_0x737048(0x1ba)]||_0x400315['configurable']))&&(_0x400315={'enumerable':!![],'get':function(){return _0x232409[_0x16e0c3];}}),Object['defineProperty'](_0x53cec7,_0x1c3c9d,_0x400315);}:function(_0x15a439,_0x30ba99,_0x212c74,_0x5f4d73){if(_0x5f4d73===undefined)_0x5f4d73=_0x212c74;_0x15a439[_0x5f4d73]=_0x30ba99[_0x212c74];}),__setModuleDefault=this&&this[a8_0x2cb6db(0x17d)]||(Object[a8_0x2cb6db(0x19b)]?function(_0x4a8cf2,_0x38c1bf){const _0xee2b56=a8_0x2cb6db;Object['defineProperty'](_0x4a8cf2,_0xee2b56(0x18f),{'enumerable':!![],'value':_0x38c1bf});}:function(_0x59333a,_0x31b242){const _0x1ae45e=a8_0x2cb6db;_0x59333a[_0x1ae45e(0x18f)]=_0x31b242;}),__importStar=this&&this[a8_0x2cb6db(0x16b)]||(function(){var _0x4a2b47=function(_0x3cddb9){const _0x246f61=a8_0x316f;return _0x4a2b47=Object[_0x246f61(0x1a5)]||function(_0x170372){const _0x14dc98=_0x246f61;var _0x1c08b7=[];for(var _0xce70d1 in _0x170372)if(Object['prototype'][_0x14dc98(0x1ac)][_0x14dc98(0x1c6)](_0x170372,_0xce70d1))_0x1c08b7[_0x1c08b7['length']]=_0xce70d1;return _0x1c08b7;},_0x4a2b47(_0x3cddb9);};return function(_0x4d5953){const _0x25ee0c=a8_0x316f;if(_0x4d5953&&_0x4d5953[_0x25ee0c(0x1c5)])return _0x4d5953;var _0x35f859={};if(_0x4d5953!=null){for(var _0x55e86e=_0x4a2b47(_0x4d5953),_0x3ba55f=0x0;_0x3ba55f<_0x55e86e[_0x25ee0c(0x181)];_0x3ba55f++)if(_0x55e86e[_0x3ba55f]!==_0x25ee0c(0x18f))__createBinding(_0x35f859,_0x4d5953,_0x55e86e[_0x3ba55f]);}return __setModuleDefault(_0x35f859,_0x4d5953),_0x35f859;};}()),__importDefault=this&&this['__importDefault']||function(_0xf0486){const _0x366c1a=a8_0x2cb6db;return _0xf0486&&_0xf0486[_0x366c1a(0x1c5)]?_0xf0486:{'default':_0xf0486};};Object[a8_0x2cb6db(0x1b4)](exports,'__esModule',{'value':!![]}),exports[a8_0x2cb6db(0x167)]=void 0x0;const paymentService_1=require(a8_0x2cb6db(0x1bb)),mastercardService_1=require(a8_0x2cb6db(0x1cf)),webhookService_1=require(a8_0x2cb6db(0x1b5)),database_1=__importDefault(require(a8_0x2cb6db(0x17f)));class PaymentController{constructor(){const _0x50a7c8=a8_0x2cb6db;this[_0x50a7c8(0x1c8)]=async(_0x4aa9d2,_0x3b8730,_0x24ec81)=>{const _0x4f8031=_0x50a7c8;try{const _0x5c421a=_0x4aa9d2[_0x4f8031(0x1ab)],_0x326ef4=await this[_0x4f8031(0x199)][_0x4f8031(0x1c8)](_0x5c421a);_0x3b8730[_0x4f8031(0x1be)](0xc9)[_0x4f8031(0x1a3)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x326ef4});}catch(_0x304461){_0x24ec81(_0x304461);}},this[_0x50a7c8(0x19d)]=async(_0x164e2e,_0x5ef7f7,_0x5ec614)=>{const _0x147187=_0x50a7c8;try{const {id:_0x10aac8}=_0x164e2e[_0x147187(0x1a6)],_0x1ac05d=await this['paymentService'][_0x147187(0x19d)](_0x10aac8);if(!_0x1ac05d)return _0x5ef7f7[_0x147187(0x1be)](0x194)[_0x147187(0x1a3)]({'success':![],'message':_0x147187(0x1b0)});_0x5ef7f7['json']({'success':!![],'result':_0x1ac05d});}catch(_0x2b0c64){_0x5ec614(_0x2b0c64);}},this[_0x50a7c8(0x190)]=async(_0x1ce242,_0x1ddcc2,_0x4a5981)=>{const _0x1ccd34=_0x50a7c8;try{const {id:_0x2ef670}=_0x1ce242[_0x1ccd34(0x1a6)],_0x4b6c53=await this[_0x1ccd34(0x199)][_0x1ccd34(0x190)](_0x2ef670);if(!_0x4b6c53)return _0x1ddcc2[_0x1ccd34(0x1be)](0x194)['json']({'success':![],'message':_0x1ccd34(0x1b0)});_0x1ddcc2[_0x1ccd34(0x1a3)]({'success':!![],'result':_0x4b6c53});}catch(_0x20ece8){_0x4a5981(_0x20ece8);}},this[_0x50a7c8(0x1cb)]=async(_0x31c50e,_0x104650,_0x4e4c89)=>{const _0x37bb53=_0x50a7c8;try{const {id:_0x4e55b4}=_0x31c50e[_0x37bb53(0x1a6)],_0xadf3c=_0x31c50e['body'];console[_0x37bb53(0x1d8)](_0x37bb53(0x1e1)+_0x4e55b4),console[_0x37bb53(0x1d8)](_0x37bb53(0x1e4),_0xadf3c);const _0x503fef=await this[_0x37bb53(0x199)][_0x37bb53(0x170)](_0x4e55b4,_0xadf3c);if(!_0x503fef)return _0x104650[_0x37bb53(0x1be)](0x194)[_0x37bb53(0x1a3)]({'success':![],'message':_0x37bb53(0x1b0)});_0x104650[_0x37bb53(0x1a3)]({'success':!![],'message':_0x37bb53(0x168),'result':{'paymentId':_0x503fef['id'],'customerIp':_0x503fef['customerIp'],'customerUa':_0x503fef[_0x37bb53(0x1af)],'customerCountry':_0x503fef[_0x37bb53(0x1d6)],'updatedAt':_0x503fef['updatedAt']}});}catch(_0x380c9d){_0x4e4c89(_0x380c9d);}},this[_0x50a7c8(0x1d7)]=async(_0x184948,_0x289c60,_0x449375)=>{const _0x192a71=_0x50a7c8;try{const {id:_0x388d1e}=_0x184948[_0x192a71(0x1a6)],{cardData:_0x269a8e,cardHolder:_0x10ac30,browser:_0x56f845}=_0x184948[_0x192a71(0x1ab)];console[_0x192a71(0x1d8)](_0x192a71(0x184)+_0x388d1e),console[_0x192a71(0x1d8)](_0x192a71(0x195)+_0x10ac30['first_name']+'\x20'+_0x10ac30['last_name']+'\x20('+_0x10ac30[_0x192a71(0x19f)]+')'),console[_0x192a71(0x1d8)]('üí≥\x20Browser\x20IP:\x20'+_0x56f845['ip']);const _0x15e233={'customerName':_0x10ac30[_0x192a71(0x1d9)]+'\x20'+_0x10ac30[_0x192a71(0x16d)],'customerEmail':_0x10ac30[_0x192a71(0x19f)],'customerIp':_0x56f845['ip'],'customerUa':_0x56f845['user_agent'],'customerCountry':_0x10ac30[_0x192a71(0x1a4)]||null},_0x175e6c=await database_1['default'][_0x192a71(0x19a)][_0x192a71(0x188)]({'where':{'id':_0x388d1e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x175e6c)return _0x289c60['status'](0x194)[_0x192a71(0x1a3)]({'success':![],'message':_0x192a71(0x1b0)});if(_0x175e6c[_0x192a71(0x1a9)]!==_0x192a71(0x1bd))return _0x289c60[_0x192a71(0x1be)](0x190)['json']({'success':![],'message':_0x192a71(0x1b9)});if(_0x175e6c[_0x192a71(0x1be)]!==_0x192a71(0x1de))return _0x289c60[_0x192a71(0x1be)](0x190)[_0x192a71(0x1a3)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x175e6c[_0x192a71(0x1be)]+',\x20cannot\x20process'});await database_1['default']['payment'][_0x192a71(0x197)]({'where':{'id':_0x388d1e},'data':{..._0x15e233,'updatedAt':new Date()}});const _0x43ce7f=_0x192a71(0x1aa),_0x1a1d7b=_0x175e6c[_0x192a71(0x1d4)];console[_0x192a71(0x1d8)](_0x192a71(0x1cc)),console['log']('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x43ce7f),console[_0x192a71(0x1d8)](_0x192a71(0x17e)+_0x1a1d7b);const _0x491f06={'first_name':_0x10ac30['first_name'],'last_name':_0x10ac30['last_name'],'email':_0x10ac30[_0x192a71(0x19f)]},_0x1bd115=await this['masterCardService'][_0x192a71(0x176)]({'paymentId':_0x175e6c['id'],'orderId':_0x175e6c[_0x192a71(0x1a8)]||_0x175e6c['id'],'amount':_0x175e6c['amount'],'currency':_0x175e6c['currency'],'cardData':_0x269a8e,'resultUrl':_0x43ce7f,'returnUrl':_0x1a1d7b,'cardHolder':_0x491f06,'browser':_0x56f845});console[_0x192a71(0x1d8)](_0x192a71(0x18a),_0x1bd115);const _0x5138e8={'status':_0x1bd115[_0x192a71(0x1be)],'updatedAt':new Date(),'statusChangedBy':_0x192a71(0x1cd),'statusChangedAt':new Date()};if(_0x1bd115[_0x192a71(0x1be)]==='PAID')_0x5138e8[_0x192a71(0x1a2)]=new Date(),_0x5138e8[_0x192a71(0x1c1)]=_0x1bd115[_0x192a71(0x173)];else _0x1bd115[_0x192a71(0x1be)]==='FAILED'&&(_0x5138e8[_0x192a71(0x1e0)]=_0x192a71(0x1ad));_0x5138e8[_0x192a71(0x19e)]='mastercard';if(_0x269a8e[_0x192a71(0x1df)]){const _0x989a40=_0x269a8e[_0x192a71(0x1df)][_0x192a71(0x1c7)](/[\s-]/g,'');_0x5138e8[_0x192a71(0x1e7)]=_0x989a40['slice'](-0x4),console[_0x192a71(0x1d8)](_0x192a71(0x18b)+_0x5138e8[_0x192a71(0x1e7)]);}await database_1[_0x192a71(0x18f)][_0x192a71(0x19a)]['update']({'where':{'id':_0x175e6c['id']},'data':_0x5138e8}),await database_1[_0x192a71(0x18f)]['webhookLog']['create']({'data':{'paymentId':_0x175e6c['id'],'shopId':_0x175e6c['shopId'],'event':_0x192a71(0x1e6)+_0x1bd115[_0x192a71(0x1be)]?.[_0x192a71(0x1d5)](),'statusCode':0xc8,'responseBody':JSON[_0x192a71(0x1b2)]({'oldStatus':_0x192a71(0x1de),'newStatus':_0x1bd115[_0x192a71(0x1be)],'gatewayPaymentId':_0x1bd115[_0x192a71(0x173)],'requires3ds':_0x1bd115[_0x192a71(0x1bf)],'processedAt':new Date()[_0x192a71(0x196)]()})}});if(_0x1bd115[_0x192a71(0x17a)]){await this[_0x192a71(0x1b8)](_0x175e6c,_0x1bd115[_0x192a71(0x1be)],_0x1bd115[_0x192a71(0x173)]),await this[_0x192a71(0x16f)](_0x175e6c,_0x1bd115[_0x192a71(0x1be)]);if(_0x1bd115[_0x192a71(0x1be)]===_0x192a71(0x1d1)){console[_0x192a71(0x1d8)](_0x192a71(0x1bc)+_0x388d1e+_0x192a71(0x17b));try{const {PaymentLinkService:_0x121665}=await Promise[_0x192a71(0x186)]()[_0x192a71(0x1dd)](()=>__importStar(require(_0x192a71(0x1ce)))),_0x2d4879=new _0x121665();await _0x2d4879[_0x192a71(0x180)](_0x388d1e),console[_0x192a71(0x1d8)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x388d1e);}catch(_0x43d1b3){console[_0x192a71(0x187)](_0x192a71(0x1ca),_0x43d1b3);}}}console[_0x192a71(0x1d8)]('‚úÖ\x20MasterCard\x20payment\x20'+_0x388d1e+_0x192a71(0x175)+_0x1bd115[_0x192a71(0x1be)]);if(_0x1bd115[_0x192a71(0x1be)]===_0x192a71(0x1d1))_0x289c60[_0x192a71(0x1a3)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x192a71(0x1d1),'gatewayPaymentId':_0x1bd115[_0x192a71(0x173)],'redirectUrl':_0x1a1d7b,'final':!![]}});else _0x1bd115[_0x192a71(0x1bf)]&&_0x1bd115['threeds_url']?_0x289c60[_0x192a71(0x1a3)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x192a71(0x1de),'gatewayPaymentId':_0x1bd115['gateway_payment_id'],'redirectUrl':_0x1bd115['threeds_url'],'requires3ds':!![],'final':![]}}):_0x289c60['status'](0x190)[_0x192a71(0x1a3)]({'success':![],'message':_0x192a71(0x183),'result':{'status':_0x192a71(0x1b7),'gatewayPaymentId':_0x1bd115['gateway_payment_id'],'redirectUrl':_0x175e6c[_0x192a71(0x185)],'final':!![]}});}catch(_0x5ec7c5){_0x449375(_0x5ec7c5);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x50a7c8(0x1e8)]=new mastercardService_1[(_0x50a7c8(0x18e))](),this[_0x50a7c8(0x1e5)]=new webhookService_1[(_0x50a7c8(0x194))]();}async[a8_0x2cb6db(0x1b8)](_0x4f8094,_0x3f5bb3,_0x24b459){const _0x4f129a=a8_0x2cb6db,_0x43b3df=Date[_0x4f129a(0x16c)]();try{const _0x4d6708=_0x4f8094['shop'],_0xfa72bf=_0x4d6708[_0x4f129a(0x18c)];if(!_0xfa72bf?.[_0x4f129a(0x1b1)]){console[_0x4f129a(0x1d8)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4d6708['id']);return;}const _0x105f60=_0x3f5bb3===_0x4f129a(0x1d1)?_0x4f129a(0x198):'payment.failed';let _0x509c70=[];if(_0xfa72bf[_0x4f129a(0x1dc)])try{_0x509c70=Array[_0x4f129a(0x193)](_0xfa72bf[_0x4f129a(0x1dc)])?_0xfa72bf[_0x4f129a(0x1dc)]:JSON[_0x4f129a(0x182)](_0xfa72bf['webhookEvents']);}catch(_0x206f88){console['error'](_0x4f129a(0x1e2),_0x206f88),_0x509c70=[];}if(!_0x509c70['includes'](_0x105f60)){console[_0x4f129a(0x1d8)](_0x4f129a(0x177)+_0x105f60+_0x4f129a(0x171)+_0x4d6708['id']);return;}const _0x1cc56e={'event':_0x105f60,'payment':{'id':_0x4f8094['id'],'order_id':_0x4f8094[_0x4f129a(0x1d0)],'gateway_order_id':_0x4f8094[_0x4f129a(0x1a8)],'gateway':_0x4f129a(0x192),'amount':_0x4f8094['amount'],'currency':_0x4f8094[_0x4f129a(0x1c3)],'status':_0x3f5bb3[_0x4f129a(0x1d5)](),'customer_email':_0x4f8094[_0x4f129a(0x1a1)],'customer_name':_0x4f8094[_0x4f129a(0x1b3)],'gateway_payment_id':_0x24b459,'created_at':_0x4f8094['createdAt'],'updated_at':new Date()}},_0x26c19f=await fetch(_0xfa72bf['webhookUrl'],{'method':_0x4f129a(0x1d3),'headers':{'Content-Type':_0x4f129a(0x172),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x4f129a(0x1b2)](_0x1cc56e)}),_0x21ec01=Date[_0x4f129a(0x16c)]()-_0x43b3df;console['log'](_0x4f129a(0x189)+_0xfa72bf[_0x4f129a(0x1b1)]+_0x4f129a(0x17c)+_0x26c19f[_0x4f129a(0x1be)]+'\x20('+_0x21ec01+_0x4f129a(0x19c));}catch(_0x54bda8){console[_0x4f129a(0x187)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x54bda8);}}async['sendPaymentStatusNotification'](_0x73afa8,_0x5836fb){const _0x54ef1f=a8_0x2cb6db;try{const {telegramBotService:_0x45f2eb}=await Promise[_0x54ef1f(0x186)]()[_0x54ef1f(0x1dd)](()=>__importStar(require(_0x54ef1f(0x174)))),_0x5341dc={'PAID':_0x54ef1f(0x1c0),'FAILED':_0x54ef1f(0x191)},_0x51c05f=_0x5341dc[_0x5836fb];if(!_0x51c05f)return;await _0x45f2eb[_0x54ef1f(0x1a7)](_0x73afa8[_0x54ef1f(0x1d2)],_0x73afa8,_0x51c05f);}catch(_0x4194e4){console[_0x54ef1f(0x187)](_0x54ef1f(0x1ae),_0x4194e4);}}}exports[a8_0x2cb6db(0x167)]=PaymentController;