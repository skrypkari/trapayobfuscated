'use strict';const a8_0x16f407=a8_0x4783;(function(_0x596e7e,_0x4ccf42){const _0x55e880=a8_0x4783,_0x3f830a=_0x596e7e();while(!![]){try{const _0x3a0912=-parseInt(_0x55e880(0x157))/0x1+parseInt(_0x55e880(0x17d))/0x2+parseInt(_0x55e880(0x155))/0x3*(-parseInt(_0x55e880(0x168))/0x4)+-parseInt(_0x55e880(0x16b))/0x5*(parseInt(_0x55e880(0x1ae))/0x6)+-parseInt(_0x55e880(0x1c6))/0x7*(parseInt(_0x55e880(0x199))/0x8)+parseInt(_0x55e880(0x175))/0x9+parseInt(_0x55e880(0x174))/0xa;if(_0x3a0912===_0x4ccf42)break;else _0x3f830a['push'](_0x3f830a['shift']());}catch(_0x31ec1c){_0x3f830a['push'](_0x3f830a['shift']());}}}(a8_0x1fa1,0xd53c8));var __createBinding=this&&this['__createBinding']||(Object[a8_0x16f407(0x1b0)]?function(_0x5be5ff,_0x3cf175,_0x171229,_0x254b42){const _0x1e0b0b=a8_0x16f407;if(_0x254b42===undefined)_0x254b42=_0x171229;var _0x548ed9=Object[_0x1e0b0b(0x16e)](_0x3cf175,_0x171229);(!_0x548ed9||(_0x1e0b0b(0x14f)in _0x548ed9?!_0x3cf175[_0x1e0b0b(0x15a)]:_0x548ed9[_0x1e0b0b(0x148)]||_0x548ed9[_0x1e0b0b(0x158)]))&&(_0x548ed9={'enumerable':!![],'get':function(){return _0x3cf175[_0x171229];}}),Object[_0x1e0b0b(0x19c)](_0x5be5ff,_0x254b42,_0x548ed9);}:function(_0x436f2f,_0x176141,_0x5cadcc,_0x20eb96){if(_0x20eb96===undefined)_0x20eb96=_0x5cadcc;_0x436f2f[_0x20eb96]=_0x176141[_0x5cadcc];}),__setModuleDefault=this&&this[a8_0x16f407(0x1c4)]||(Object[a8_0x16f407(0x1b0)]?function(_0x29677c,_0x363e14){Object['defineProperty'](_0x29677c,'default',{'enumerable':!![],'value':_0x363e14});}:function(_0x537fb8,_0x5082d9){const _0x1f851e=a8_0x16f407;_0x537fb8[_0x1f851e(0x170)]=_0x5082d9;}),__importStar=this&&this[a8_0x16f407(0x18b)]||(function(){var _0x581721=function(_0x21dcb8){const _0x2d84c7=a8_0x4783;return _0x581721=Object[_0x2d84c7(0x161)]||function(_0x1f5083){const _0x50cee6=_0x2d84c7;var _0x217646=[];for(var _0x856797 in _0x1f5083)if(Object[_0x50cee6(0x173)][_0x50cee6(0x1a4)]['call'](_0x1f5083,_0x856797))_0x217646[_0x217646['length']]=_0x856797;return _0x217646;},_0x581721(_0x21dcb8);};return function(_0x36faa7){const _0x4a0cb7=a8_0x4783;if(_0x36faa7&&_0x36faa7[_0x4a0cb7(0x15a)])return _0x36faa7;var _0x151699={};if(_0x36faa7!=null){for(var _0x29a513=_0x581721(_0x36faa7),_0x2969f4=0x0;_0x2969f4<_0x29a513['length'];_0x2969f4++)if(_0x29a513[_0x2969f4]!==_0x4a0cb7(0x170))__createBinding(_0x151699,_0x36faa7,_0x29a513[_0x2969f4]);}return __setModuleDefault(_0x151699,_0x36faa7),_0x151699;};}()),__importDefault=this&&this[a8_0x16f407(0x169)]||function(_0x1fbe09){const _0x3f224b=a8_0x16f407;return _0x1fbe09&&_0x1fbe09[_0x3f224b(0x15a)]?_0x1fbe09:{'default':_0x1fbe09};};function a8_0x1fa1(){const _0x3b9be2=['../config/database','final','getOwnPropertyNames','first_name','mastercard','processCardPayment','country','customerCountry','💳\x20Browser\x20IP:\x20','67960vgwVwR','__importDefault','settings','23995PDysxt','MasterCardService','../services/paymentLinkService','getOwnPropertyDescriptor','webhookEvents','default','PaymentController','number','prototype','37631270sDzCsB','528219qwJmik','error','Error\x20parsing\x20webhook\x20events:','params','stringify','update','failed','\x20not\x20enabled\x20for\x20shop\x20','2716526MepnUP','application/json','then','paid','💳\x20Processing\x20MasterCard\x20payment:\x20','../services/webhookService','updatePaymentCustomer','getPaymentById','replace','status','customerEmail','toLowerCase','customerUa','masterCardService','__importStar','updatePaymentCustomerDataPublic','processMasterCardPayment','last_name','threeds_url','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','failUrl','updatedAt','sendPaymentStatusNotification','Failed\x20to\x20send\x20MasterCard\x20webhook:','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','email','json','PAID','4112DTFqWw','1111','payment','defineProperty','paymentMethod','MasterCard\x20webhook\x20sent\x20to\x20','log','parse','gatewayOrderId','payment.success','sendShopWebhook','hasOwnProperty','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','currency','cardLast4','gateway_payment_id','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','webhookUrl',',\x20cannot\x20process','FAILED','PaymentService','1854fdCXHP','Customer\x20data\x20updated\x20successfully','create','\x20\x20\x20Return\x20URL:\x20','gateway','Payment\x20created\x20successfully','findUnique','slice','\x20with\x20status\x20','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','✅\x20MasterCard\x20payment\x20','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','includes','gatewayPaymentId','customerName','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','system','webhookLog','resolve','createPublicPayment','PENDING','3DS\x20verification\x20required','__setModuleDefault','💳\x20MasterCard\x20result:','7665KcQtgn','user_agent','Payment\x20status\x20is\x20','📈\x20MasterCard\x20payment\x20','createdAt','handleSuccessfulPayment','writable','\x20processed:\x20','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','webhookService','toISOString','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','amount','get','payment.failed','shopId','mastercard_','now','shop','285uvxkEt','sendPaymentNotification','646894Kggmcj','configurable','Payment\x20failed','__esModule','Payment\x20not\x20found','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','paymentService','body'];a8_0x1fa1=function(){return _0x3b9be2;};return a8_0x1fa1();}Object[a8_0x16f407(0x19c)](exports,a8_0x16f407(0x15a),{'value':!![]}),exports[a8_0x16f407(0x171)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x16f407(0x182)),database_1=__importDefault(require(a8_0x16f407(0x15f)));class PaymentController{constructor(){const _0x44a643=a8_0x16f407;this[_0x44a643(0x1c1)]=async(_0xe5907f,_0x21c6d6,_0x1b9c0c)=>{const _0x3cdc5a=_0x44a643;try{const _0x2bf1f6=_0xe5907f[_0x3cdc5a(0x15e)],_0x212299=await this['paymentService']['createPublicPayment'](_0x2bf1f6);_0x21c6d6['status'](0xc9)[_0x3cdc5a(0x197)]({'success':!![],'message':_0x3cdc5a(0x1b3),'result':_0x212299});}catch(_0x57feff){_0x1b9c0c(_0x57feff);}},this['getPaymentStatus']=async(_0x179571,_0x50fd0b,_0x13a2e8)=>{const _0x52640d=_0x44a643;try{const {id:_0x41182c}=_0x179571[_0x52640d(0x178)],_0x1bd023=await this['paymentService']['getPaymentStatus'](_0x41182c);if(!_0x1bd023)return _0x50fd0b['status'](0x194)['json']({'success':![],'message':_0x52640d(0x15b)});_0x50fd0b['json']({'success':!![],'result':_0x1bd023});}catch(_0x15ffad){_0x13a2e8(_0x15ffad);}},this[_0x44a643(0x184)]=async(_0x56e270,_0x2f45be,_0x350e58)=>{const _0x1eee0f=_0x44a643;try{const {id:_0x5de010}=_0x56e270[_0x1eee0f(0x178)],_0x114142=await this[_0x1eee0f(0x15d)][_0x1eee0f(0x184)](_0x5de010);if(!_0x114142)return _0x2f45be[_0x1eee0f(0x186)](0x194)['json']({'success':![],'message':_0x1eee0f(0x15b)});_0x2f45be[_0x1eee0f(0x197)]({'success':!![],'result':_0x114142});}catch(_0x53cb6d){_0x350e58(_0x53cb6d);}},this[_0x44a643(0x183)]=async(_0x2933e6,_0x2248f8,_0x1f085e)=>{const _0x55f5b7=_0x44a643;try{const {id:_0x8cfc2e}=_0x2933e6[_0x55f5b7(0x178)],_0x374aa9=_0x2933e6[_0x55f5b7(0x15e)];console[_0x55f5b7(0x19f)](_0x55f5b7(0x14a)+_0x8cfc2e),console[_0x55f5b7(0x19f)]('📝\x20Customer\x20data:',_0x374aa9);const _0xb4cdcd=await this['paymentService'][_0x55f5b7(0x18c)](_0x8cfc2e,_0x374aa9);if(!_0xb4cdcd)return _0x2248f8['status'](0x194)[_0x55f5b7(0x197)]({'success':![],'message':_0x55f5b7(0x15b)});_0x2248f8[_0x55f5b7(0x197)]({'success':!![],'message':_0x55f5b7(0x1af),'result':{'paymentId':_0xb4cdcd['id'],'customerIp':_0xb4cdcd['customerIp'],'customerUa':_0xb4cdcd[_0x55f5b7(0x189)],'customerCountry':_0xb4cdcd[_0x55f5b7(0x166)],'updatedAt':_0xb4cdcd[_0x55f5b7(0x192)]}});}catch(_0x36a34e){_0x1f085e(_0x36a34e);}},this[_0x44a643(0x18d)]=async(_0x508d6e,_0x4e52c7,_0x44bf7c)=>{const _0x18fa08=_0x44a643;try{const {id:_0x20d9f8}=_0x508d6e[_0x18fa08(0x178)],{cardData:_0x5eabf5,cardHolder:_0x3842c9,browser:_0x1ece34}=_0x508d6e['body'];console['log'](_0x18fa08(0x181)+_0x20d9f8),console[_0x18fa08(0x19f)]('💳\x20Card\x20holder:\x20'+_0x3842c9[_0x18fa08(0x162)]+'\x20'+_0x3842c9[_0x18fa08(0x18e)]+'\x20('+_0x3842c9[_0x18fa08(0x196)]+')'),console['log'](_0x18fa08(0x167)+_0x1ece34['ip']);const _0x2fd74c={'customerName':_0x3842c9[_0x18fa08(0x162)]+'\x20'+_0x3842c9['last_name'],'customerEmail':_0x3842c9[_0x18fa08(0x196)],'customerIp':_0x1ece34['ip'],'customerUa':_0x1ece34[_0x18fa08(0x1c7)],'customerCountry':_0x3842c9[_0x18fa08(0x165)]||null},_0x1df8f1=await database_1[_0x18fa08(0x170)]['payment'][_0x18fa08(0x1b4)]({'where':{'id':_0x20d9f8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1df8f1)return _0x4e52c7['status'](0x194)[_0x18fa08(0x197)]({'success':![],'message':_0x18fa08(0x15b)});if(_0x1df8f1[_0x18fa08(0x1b2)]!==_0x18fa08(0x163))return _0x4e52c7[_0x18fa08(0x186)](0x190)['json']({'success':![],'message':_0x18fa08(0x15c)});if(_0x1df8f1[_0x18fa08(0x186)]!==_0x18fa08(0x1c2))return _0x4e52c7[_0x18fa08(0x186)](0x190)[_0x18fa08(0x197)]({'success':![],'message':_0x18fa08(0x1c8)+_0x1df8f1[_0x18fa08(0x186)]+_0x18fa08(0x1ab)});await database_1['default'][_0x18fa08(0x19b)]['update']({'where':{'id':_0x20d9f8},'data':{..._0x2fd74c,'updatedAt':new Date()}});const _0x3ea005='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x507a54=_0x1df8f1['successUrl'];console[_0x18fa08(0x19f)]('💳\x20MasterCard\x20URLs:'),console[_0x18fa08(0x19f)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x3ea005),console[_0x18fa08(0x19f)](_0x18fa08(0x1b1)+_0x507a54);const _0x4178e6={'first_name':_0x3842c9['first_name'],'last_name':_0x3842c9[_0x18fa08(0x18e)],'email':_0x3842c9[_0x18fa08(0x196)]},_0x49abb9=await this[_0x18fa08(0x18a)][_0x18fa08(0x164)]({'paymentId':_0x1df8f1['id'],'orderId':_0x1df8f1['gatewayOrderId']||_0x1df8f1['id'],'amount':_0x1df8f1[_0x18fa08(0x14e)],'currency':_0x1df8f1[_0x18fa08(0x1a6)],'cardData':_0x5eabf5,'resultUrl':_0x3ea005,'returnUrl':_0x507a54,'cardHolder':_0x4178e6,'browser':_0x1ece34});console[_0x18fa08(0x19f)](_0x18fa08(0x1c5),_0x49abb9);const _0x1ef97a={'status':_0x49abb9[_0x18fa08(0x186)],'updatedAt':new Date(),'statusChangedBy':_0x18fa08(0x1be),'statusChangedAt':new Date()};_0x49abb9[_0x18fa08(0x1a8)]&&(_0x1ef97a[_0x18fa08(0x1bb)]=_0x49abb9[_0x18fa08(0x1a8)],console['log'](_0x18fa08(0x1b9)+_0x49abb9['gateway_payment_id']));if(_0x49abb9[_0x18fa08(0x186)]===_0x18fa08(0x198))_0x1ef97a['paidAt']=new Date();else _0x49abb9[_0x18fa08(0x186)]===_0x18fa08(0x1ac)&&(_0x1ef97a['failureMessage']='Card\x20payment\x20failed');_0x1ef97a[_0x18fa08(0x19d)]=_0x18fa08(0x163);if(_0x5eabf5[_0x18fa08(0x172)]){const _0x5cb19c=_0x5eabf5[_0x18fa08(0x172)][_0x18fa08(0x185)](/[\s-]/g,'');_0x1ef97a[_0x18fa08(0x1a7)]=_0x5cb19c[_0x18fa08(0x1b5)](-0x4),console[_0x18fa08(0x19f)](_0x18fa08(0x1bd)+_0x1ef97a[_0x18fa08(0x1a7)]);}await database_1[_0x18fa08(0x170)][_0x18fa08(0x19b)][_0x18fa08(0x17a)]({'where':{'id':_0x1df8f1['id']},'data':_0x1ef97a}),await database_1[_0x18fa08(0x170)][_0x18fa08(0x1bf)][_0x18fa08(0x1b0)]({'data':{'paymentId':_0x1df8f1['id'],'shopId':_0x1df8f1[_0x18fa08(0x151)],'event':_0x18fa08(0x152)+_0x49abb9['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x18fa08(0x179)]({'oldStatus':'PENDING','newStatus':_0x49abb9[_0x18fa08(0x186)],'gatewayPaymentId':_0x49abb9[_0x18fa08(0x1a8)],'requires3ds':_0x49abb9['requires_3ds'],'processedAt':new Date()[_0x18fa08(0x14c)]()})}});if(_0x49abb9[_0x18fa08(0x160)]){await this['sendShopWebhook'](_0x1df8f1,_0x49abb9[_0x18fa08(0x186)],_0x49abb9[_0x18fa08(0x1a8)]),await this[_0x18fa08(0x193)](_0x1df8f1,_0x49abb9['status']);if(_0x49abb9['status']==='PAID'){console[_0x18fa08(0x19f)](_0x18fa08(0x1c9)+_0x20d9f8+_0x18fa08(0x1a9));try{const {PaymentLinkService:_0x3c35e3}=await Promise[_0x18fa08(0x1c0)]()[_0x18fa08(0x17f)](()=>__importStar(require(_0x18fa08(0x16d)))),_0x52a948=new _0x3c35e3();await _0x52a948[_0x18fa08(0x147)](_0x20d9f8),console[_0x18fa08(0x19f)](_0x18fa08(0x1a5)+_0x20d9f8);}catch(_0xc3d2df){console[_0x18fa08(0x176)](_0x18fa08(0x195),_0xc3d2df);}}}console[_0x18fa08(0x19f)](_0x18fa08(0x1b8)+_0x20d9f8+_0x18fa08(0x149)+_0x49abb9[_0x18fa08(0x186)]);if(_0x49abb9['status']===_0x18fa08(0x198))_0x4e52c7[_0x18fa08(0x197)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x18fa08(0x198),'gatewayPaymentId':_0x49abb9[_0x18fa08(0x1a8)],'redirectUrl':_0x507a54,'final':!![]}});else _0x49abb9['requires_3ds']&&_0x49abb9[_0x18fa08(0x18f)]?_0x4e52c7[_0x18fa08(0x197)]({'success':!![],'message':_0x18fa08(0x1c3),'result':{'status':'PENDING','gatewayPaymentId':_0x49abb9['gateway_payment_id'],'redirectUrl':_0x49abb9[_0x18fa08(0x18f)],'requires3ds':!![],'final':![]}}):_0x4e52c7[_0x18fa08(0x186)](0x190)[_0x18fa08(0x197)]({'success':![],'message':_0x18fa08(0x159),'result':{'status':_0x18fa08(0x1ac),'gatewayPaymentId':_0x49abb9[_0x18fa08(0x1a8)],'redirectUrl':_0x1df8f1[_0x18fa08(0x191)],'final':!![]}});}catch(_0x1a6832){_0x44bf7c(_0x1a6832);}},this[_0x44a643(0x15d)]=new paymentService_1[(_0x44a643(0x1ad))](),this['masterCardService']=new mastercardService_1[(_0x44a643(0x16c))](),this[_0x44a643(0x14b)]=new webhookService_1['WebhookService']();}async[a8_0x16f407(0x1a3)](_0x1c06d5,_0x3a7a67,_0x5f4386){const _0x186c2e=a8_0x16f407,_0x1f8983=Date[_0x186c2e(0x153)]();try{const _0x26f4f5=_0x1c06d5[_0x186c2e(0x154)],_0x4dbaef=_0x26f4f5[_0x186c2e(0x16a)];if(!_0x4dbaef?.['webhookUrl']){console[_0x186c2e(0x19f)](_0x186c2e(0x14d)+_0x26f4f5['id']);return;}const _0x2fd512=_0x3a7a67===_0x186c2e(0x198)?_0x186c2e(0x1a2):_0x186c2e(0x150);let _0x9d0b61=[];if(_0x4dbaef[_0x186c2e(0x16f)])try{_0x9d0b61=Array['isArray'](_0x4dbaef['webhookEvents'])?_0x4dbaef[_0x186c2e(0x16f)]:JSON[_0x186c2e(0x1a0)](_0x4dbaef[_0x186c2e(0x16f)]);}catch(_0xb353e5){console['error'](_0x186c2e(0x177),_0xb353e5),_0x9d0b61=[];}if(!_0x9d0b61[_0x186c2e(0x1ba)](_0x2fd512)){console[_0x186c2e(0x19f)]('Webhook\x20event\x20'+_0x2fd512+_0x186c2e(0x17c)+_0x26f4f5['id']);return;}const _0x3c3f6c={'event':_0x2fd512,'payment':{'id':_0x1c06d5['id'],'order_id':_0x1c06d5['orderId'],'gateway_order_id':_0x1c06d5[_0x186c2e(0x1a1)],'gateway':_0x186c2e(0x19a),'amount':_0x1c06d5[_0x186c2e(0x14e)],'currency':_0x1c06d5[_0x186c2e(0x1a6)],'status':_0x3a7a67[_0x186c2e(0x188)](),'customer_email':_0x1c06d5[_0x186c2e(0x187)],'customer_name':_0x1c06d5[_0x186c2e(0x1bc)],'gateway_payment_id':_0x5f4386,'created_at':_0x1c06d5[_0x186c2e(0x1ca)],'updated_at':new Date()}},_0x3acc36=await fetch(_0x4dbaef[_0x186c2e(0x1aa)],{'method':'POST','headers':{'Content-Type':_0x186c2e(0x17e),'User-Agent':_0x186c2e(0x1b7)},'body':JSON[_0x186c2e(0x179)](_0x3c3f6c)}),_0x1046e1=Date[_0x186c2e(0x153)]()-_0x1f8983;console[_0x186c2e(0x19f)](_0x186c2e(0x19e)+_0x4dbaef[_0x186c2e(0x1aa)]+_0x186c2e(0x1b6)+_0x3acc36['status']+'\x20('+_0x1046e1+'ms)');}catch(_0x480be3){console['error'](_0x186c2e(0x194),_0x480be3);}}async['sendPaymentStatusNotification'](_0x4cce08,_0x1ca9e3){const _0x39ee8b=a8_0x16f407;try{const {telegramBotService:_0x314b50}=await Promise[_0x39ee8b(0x1c0)]()[_0x39ee8b(0x17f)](()=>__importStar(require('../services/telegramBotService'))),_0x5f3d80={'PAID':_0x39ee8b(0x180),'FAILED':_0x39ee8b(0x17b)},_0x4b330e=_0x5f3d80[_0x1ca9e3];if(!_0x4b330e)return;await _0x314b50[_0x39ee8b(0x156)](_0x4cce08[_0x39ee8b(0x151)],_0x4cce08,_0x4b330e);}catch(_0x4b47d9){console['error'](_0x39ee8b(0x190),_0x4b47d9);}}}function a8_0x4783(_0x4f4e5f,_0x4190a8){const _0x1fa192=a8_0x1fa1();return a8_0x4783=function(_0x478311,_0x4fe230){_0x478311=_0x478311-0x147;let _0x117dc8=_0x1fa192[_0x478311];return _0x117dc8;},a8_0x4783(_0x4f4e5f,_0x4190a8);}exports[a8_0x16f407(0x171)]=PaymentController;