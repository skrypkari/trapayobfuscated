'use strict';const a8_0x37e0e9=a8_0x1450;(function(_0x24d1b5,_0x5ad3ae){const _0x523c3e=a8_0x1450,_0x1d141c=_0x24d1b5();while(!![]){try{const _0x54ec61=-parseInt(_0x523c3e(0xc9))/0x1*(-parseInt(_0x523c3e(0xb9))/0x2)+parseInt(_0x523c3e(0x91))/0x3*(-parseInt(_0x523c3e(0xe9))/0x4)+-parseInt(_0x523c3e(0xc2))/0x5+parseInt(_0x523c3e(0xc8))/0x6*(parseInt(_0x523c3e(0x75))/0x7)+parseInt(_0x523c3e(0xc1))/0x8*(parseInt(_0x523c3e(0x92))/0x9)+-parseInt(_0x523c3e(0x9b))/0xa+-parseInt(_0x523c3e(0xc7))/0xb*(-parseInt(_0x523c3e(0xa1))/0xc);if(_0x54ec61===_0x5ad3ae)break;else _0x1d141c['push'](_0x1d141c['shift']());}catch(_0x3f8c48){_0x1d141c['push'](_0x1d141c['shift']());}}}(a8_0x5b80,0x665bf));var __createBinding=this&&this[a8_0x37e0e9(0x94)]||(Object[a8_0x37e0e9(0xd0)]?function(_0x5d173e,_0x3922cd,_0x461c4c,_0x13428d){const _0x55a48d=a8_0x37e0e9;if(_0x13428d===undefined)_0x13428d=_0x461c4c;var _0x293a23=Object[_0x55a48d(0xbf)](_0x3922cd,_0x461c4c);(!_0x293a23||(_0x55a48d(0xcd)in _0x293a23?!_0x3922cd[_0x55a48d(0xa4)]:_0x293a23[_0x55a48d(0xcf)]||_0x293a23[_0x55a48d(0x97)]))&&(_0x293a23={'enumerable':!![],'get':function(){return _0x3922cd[_0x461c4c];}}),Object[_0x55a48d(0x77)](_0x5d173e,_0x13428d,_0x293a23);}:function(_0x2f92bd,_0x5527bf,_0x36778c,_0x54d7cb){if(_0x54d7cb===undefined)_0x54d7cb=_0x36778c;_0x2f92bd[_0x54d7cb]=_0x5527bf[_0x36778c];}),__setModuleDefault=this&&this[a8_0x37e0e9(0xf2)]||(Object[a8_0x37e0e9(0xd0)]?function(_0x558d1c,_0x539dd6){const _0x22742b=a8_0x37e0e9;Object[_0x22742b(0x77)](_0x558d1c,_0x22742b(0xb4),{'enumerable':!![],'value':_0x539dd6});}:function(_0x289342,_0x59fa12){const _0x39303c=a8_0x37e0e9;_0x289342[_0x39303c(0xb4)]=_0x59fa12;}),__importStar=this&&this[a8_0x37e0e9(0xce)]||(function(){var _0x6889d2=function(_0xfaa0b){const _0xaf414d=a8_0x1450;return _0x6889d2=Object[_0xaf414d(0x7e)]||function(_0x5e1c39){const _0x23f499=_0xaf414d;var _0x4509c6=[];for(var _0x1d6b74 in _0x5e1c39)if(Object[_0x23f499(0xba)][_0x23f499(0x7d)]['call'](_0x5e1c39,_0x1d6b74))_0x4509c6[_0x4509c6[_0x23f499(0x8d)]]=_0x1d6b74;return _0x4509c6;},_0x6889d2(_0xfaa0b);};return function(_0x2cd24c){const _0x4b7c26=a8_0x1450;if(_0x2cd24c&&_0x2cd24c['__esModule'])return _0x2cd24c;var _0x19c25a={};if(_0x2cd24c!=null){for(var _0x1593d0=_0x6889d2(_0x2cd24c),_0x27f960=0x0;_0x27f960<_0x1593d0[_0x4b7c26(0x8d)];_0x27f960++)if(_0x1593d0[_0x27f960]!==_0x4b7c26(0xb4))__createBinding(_0x19c25a,_0x2cd24c,_0x1593d0[_0x27f960]);}return __setModuleDefault(_0x19c25a,_0x2cd24c),_0x19c25a;};}()),__importDefault=this&&this[a8_0x37e0e9(0x89)]||function(_0x27e77e){const _0x3d30b2=a8_0x37e0e9;return _0x27e77e&&_0x27e77e[_0x3d30b2(0xa4)]?_0x27e77e:{'default':_0x27e77e};};Object['defineProperty'](exports,a8_0x37e0e9(0xa4),{'value':!![]}),exports[a8_0x37e0e9(0xeb)]=void 0x0;function a8_0x5b80(){const _0x454ebb=['paymentService','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','getPaymentStatus','cardLast4','1469360UHlXGV','Card\x20payment\x20failed','PaymentController','currency','gateway','customerEmail','resolve','shopId','status','__setModuleDefault','WebhookService','Webhook\x20event\x20','webhookUrl','system','processCardPayment','customerCountry','failed','14NFZujO','Failed\x20to\x20send\x20MasterCard\x20webhook:','defineProperty','3DS\x20verification\x20required','parse','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','user_agent','PENDING','hasOwnProperty','getOwnPropertyNames','findUnique','slice','💳\x20Browser\x20IP:\x20','payment.success','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','💳\x20Processing\x20MasterCard\x20payment:\x20','Payment\x20not\x20found','MasterCard\x20webhook\x20sent\x20to\x20','PaymentService','\x20with\x20status\x20','__importDefault','masterCardService','sendShopWebhook','paidAt','length','POST','amount','\x20\x20\x20Result\x20URL\x20(webhook):\x20','6UwDpvf','81rEndug','sendPaymentStatusNotification','__createBinding','number','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','configurable','createPublicPayment','gatewayOrderId','https://api.trapay.uk/api/webhooks/gateway/mastercard','5522290kosuAT','final','params','threeds_url','Payment\x20processed\x20successfully','now','204iDIsjb','customerUa','replace','__esModule','then','webhookEvents','paid','log','handleSuccessfulPayment','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendPaymentNotification','PAID','../services/webhookService','updatePaymentCustomer','Payment\x20status\x20is\x20','../services/gateways/mastercardService','mastercard_','processMasterCardPayment','default','email','stringify','1111','gateway_payment_id','3586TMzxSJ','prototype','error','Error\x20parsing\x20webhook\x20events:','includes','💳\x20MasterCard\x20result:','getOwnPropertyDescriptor','settings','492136BeKLhD','1003365gsyZwq','mastercard','paymentMethod','successUrl','customerName','232793opGvYU','2286372VaCIpH','129PRWxjH','FAILED','updatedAt','requires_3ds','get','__importStar','writable','create','failUrl','updatePaymentCustomerDataPublic','📝\x20Customer\x20data:','json','webhookService','toISOString','isArray','body','createdAt','first_name','\x20processed:\x20','../config/database','last_name','webhookLog','update','getPaymentById','\x20not\x20enabled\x20for\x20shop\x20','../services/paymentService','../services/paymentLinkService','application/json'];a8_0x5b80=function(){return _0x454ebb;};return a8_0x5b80();}const paymentService_1=require(a8_0x37e0e9(0xe2)),mastercardService_1=require(a8_0x37e0e9(0xb1)),webhookService_1=require(a8_0x37e0e9(0xae)),database_1=__importDefault(require(a8_0x37e0e9(0xdc)));class PaymentController{constructor(){const _0x1fe536=a8_0x37e0e9;this[_0x1fe536(0x98)]=async(_0x408494,_0x1c0e1f,_0x53af90)=>{const _0x4ff672=_0x1fe536;try{const _0x253a01=_0x408494[_0x4ff672(0xd8)],_0x354acc=await this[_0x4ff672(0xe5)]['createPublicPayment'](_0x253a01);_0x1c0e1f['status'](0xc9)[_0x4ff672(0xd4)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x354acc});}catch(_0x525eea){_0x53af90(_0x525eea);}},this[_0x1fe536(0xe7)]=async(_0x1e5c39,_0x11fee4,_0x17d2bc)=>{const _0x1214e6=_0x1fe536;try{const {id:_0x2c17ba}=_0x1e5c39[_0x1214e6(0x9d)],_0x2134e2=await this[_0x1214e6(0xe5)][_0x1214e6(0xe7)](_0x2c17ba);if(!_0x2134e2)return _0x11fee4[_0x1214e6(0xf1)](0x194)[_0x1214e6(0xd4)]({'success':![],'message':_0x1214e6(0x85)});_0x11fee4['json']({'success':!![],'result':_0x2134e2});}catch(_0x29014f){_0x17d2bc(_0x29014f);}},this['getPaymentById']=async(_0x3f0c10,_0x5d9251,_0x4188f7)=>{const _0xc336b6=_0x1fe536;try{const {id:_0x2e7509}=_0x3f0c10['params'],_0x12e60b=await this['paymentService'][_0xc336b6(0xe0)](_0x2e7509);if(!_0x12e60b)return _0x5d9251[_0xc336b6(0xf1)](0x194)[_0xc336b6(0xd4)]({'success':![],'message':_0xc336b6(0x85)});_0x5d9251['json']({'success':!![],'result':_0x12e60b});}catch(_0x410340){_0x4188f7(_0x410340);}},this[_0x1fe536(0xaf)]=async(_0x199e60,_0xdd8831,_0x118207)=>{const _0x239897=_0x1fe536;try{const {id:_0x41e0ea}=_0x199e60['params'],_0x154603=_0x199e60['body'];console[_0x239897(0xa8)](_0x239897(0x96)+_0x41e0ea),console[_0x239897(0xa8)](_0x239897(0xd3),_0x154603);const _0x19883d=await this[_0x239897(0xe5)][_0x239897(0xd2)](_0x41e0ea,_0x154603);if(!_0x19883d)return _0xdd8831[_0x239897(0xf1)](0x194)['json']({'success':![],'message':_0x239897(0x85)});_0xdd8831[_0x239897(0xd4)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x19883d['id'],'customerIp':_0x19883d['customerIp'],'customerUa':_0x19883d[_0x239897(0xa2)],'customerCountry':_0x19883d[_0x239897(0x73)],'updatedAt':_0x19883d[_0x239897(0xcb)]}});}catch(_0x79f5c2){_0x118207(_0x79f5c2);}},this[_0x1fe536(0xb3)]=async(_0xc06d9d,_0x11f6a6,_0x5f4513)=>{const _0x10bfbc=_0x1fe536;try{const {id:_0x4a8847}=_0xc06d9d[_0x10bfbc(0x9d)],{cardData:_0x17cd16,cardHolder:_0x13b992,browser:_0x27e8f1}=_0xc06d9d[_0x10bfbc(0xd8)];console[_0x10bfbc(0xa8)](_0x10bfbc(0x84)+_0x4a8847),console[_0x10bfbc(0xa8)]('💳\x20Card\x20holder:\x20'+_0x13b992[_0x10bfbc(0xda)]+'\x20'+_0x13b992['last_name']+'\x20('+_0x13b992['email']+')'),console[_0x10bfbc(0xa8)](_0x10bfbc(0x81)+_0x27e8f1['ip']);const _0x2ac5cb={'customerName':_0x13b992[_0x10bfbc(0xda)]+'\x20'+_0x13b992[_0x10bfbc(0xdd)],'customerEmail':_0x13b992[_0x10bfbc(0xb5)],'customerIp':_0x27e8f1['ip'],'customerUa':_0x27e8f1[_0x10bfbc(0x7b)]},_0x4bb5c7=await database_1[_0x10bfbc(0xb4)]['payment'][_0x10bfbc(0x7f)]({'where':{'id':_0x4a8847},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4bb5c7)return _0x11f6a6['status'](0x194)[_0x10bfbc(0xd4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x4bb5c7[_0x10bfbc(0xed)]!=='mastercard')return _0x11f6a6[_0x10bfbc(0xf1)](0x190)[_0x10bfbc(0xd4)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x4bb5c7['status']!==_0x10bfbc(0x7c))return _0x11f6a6['status'](0x190)[_0x10bfbc(0xd4)]({'success':![],'message':_0x10bfbc(0xb0)+_0x4bb5c7[_0x10bfbc(0xf1)]+',\x20cannot\x20process'});await database_1[_0x10bfbc(0xb4)]['payment'][_0x10bfbc(0xdf)]({'where':{'id':_0x4a8847},'data':{..._0x2ac5cb,'updatedAt':new Date()}});const _0x29dc52=_0x10bfbc(0x9a),_0x10ef10=_0x4bb5c7[_0x10bfbc(0xc5)];console[_0x10bfbc(0xa8)]('💳\x20MasterCard\x20URLs:'),console[_0x10bfbc(0xa8)](_0x10bfbc(0x90)+_0x29dc52),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x10ef10);const _0x232ae0={'first_name':_0x13b992[_0x10bfbc(0xda)],'last_name':_0x13b992['last_name'],'email':_0x13b992['email']},_0x2d663f=await this[_0x10bfbc(0x8a)][_0x10bfbc(0xf7)]({'paymentId':_0x4bb5c7['id'],'orderId':_0x4bb5c7['gatewayOrderId']||_0x4bb5c7['id'],'amount':_0x4bb5c7[_0x10bfbc(0x8f)],'currency':_0x4bb5c7[_0x10bfbc(0xec)],'cardData':_0x17cd16,'resultUrl':_0x29dc52,'returnUrl':_0x10ef10,'cardHolder':_0x232ae0,'browser':_0x27e8f1});console[_0x10bfbc(0xa8)](_0x10bfbc(0xbe),_0x2d663f);const _0x2adb9b={'status':_0x2d663f[_0x10bfbc(0xf1)],'updatedAt':new Date(),'statusChangedBy':_0x10bfbc(0xf6),'statusChangedAt':new Date()};_0x2d663f[_0x10bfbc(0xb8)]&&(_0x2adb9b['gatewayPaymentId']=_0x2d663f[_0x10bfbc(0xb8)],console[_0x10bfbc(0xa8)]('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x2d663f[_0x10bfbc(0xb8)]));if(_0x2d663f[_0x10bfbc(0xf1)]===_0x10bfbc(0xad))_0x2adb9b[_0x10bfbc(0x8c)]=new Date();else _0x2d663f[_0x10bfbc(0xf1)]===_0x10bfbc(0xca)&&(_0x2adb9b['failureMessage']=_0x10bfbc(0xea));_0x2adb9b[_0x10bfbc(0xc4)]=_0x10bfbc(0xc3);if(_0x17cd16['number']){const _0x299735=_0x17cd16[_0x10bfbc(0x95)][_0x10bfbc(0xa3)](/[\s-]/g,'');_0x2adb9b['cardLast4']=_0x299735[_0x10bfbc(0x80)](-0x4),console[_0x10bfbc(0xa8)](_0x10bfbc(0x83)+_0x2adb9b[_0x10bfbc(0xe8)]);}await database_1[_0x10bfbc(0xb4)]['payment']['update']({'where':{'id':_0x4bb5c7['id']},'data':_0x2adb9b}),await database_1[_0x10bfbc(0xb4)][_0x10bfbc(0xde)][_0x10bfbc(0xd0)]({'data':{'paymentId':_0x4bb5c7['id'],'shopId':_0x4bb5c7[_0x10bfbc(0xf0)],'event':_0x10bfbc(0xb2)+_0x2d663f[_0x10bfbc(0xf1)]?.[_0x10bfbc(0xaa)](),'statusCode':0xc8,'responseBody':JSON[_0x10bfbc(0xb6)]({'oldStatus':_0x10bfbc(0x7c),'newStatus':_0x2d663f[_0x10bfbc(0xf1)],'gatewayPaymentId':_0x2d663f[_0x10bfbc(0xb8)],'requires3ds':_0x2d663f['requires_3ds'],'processedAt':new Date()[_0x10bfbc(0xd6)]()})}});if(_0x2d663f[_0x10bfbc(0x9c)]){await this[_0x10bfbc(0x8b)](_0x4bb5c7,_0x2d663f[_0x10bfbc(0xf1)],_0x2d663f[_0x10bfbc(0xb8)]),await this[_0x10bfbc(0x93)](_0x4bb5c7,_0x2d663f[_0x10bfbc(0xf1)]);if(_0x2d663f[_0x10bfbc(0xf1)]===_0x10bfbc(0xad)){console['log']('📈\x20MasterCard\x20payment\x20'+_0x4a8847+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x199787}=await Promise[_0x10bfbc(0xef)]()[_0x10bfbc(0xa5)](()=>__importStar(require(_0x10bfbc(0xe3)))),_0x303f70=new _0x199787();await _0x303f70[_0x10bfbc(0xa9)](_0x4a8847),console[_0x10bfbc(0xa8)](_0x10bfbc(0xe6)+_0x4a8847);}catch(_0x3ab41b){console['error'](_0x10bfbc(0x7a),_0x3ab41b);}}}console[_0x10bfbc(0xa8)]('✅\x20MasterCard\x20payment\x20'+_0x4a8847+_0x10bfbc(0xdb)+_0x2d663f['status']);if(_0x2d663f['status']===_0x10bfbc(0xad))_0x11f6a6[_0x10bfbc(0xd4)]({'success':!![],'message':_0x10bfbc(0x9f),'result':{'status':'PAID','gatewayPaymentId':_0x2d663f[_0x10bfbc(0xb8)],'redirectUrl':_0x10ef10,'final':!![]}});else _0x2d663f[_0x10bfbc(0xcc)]&&_0x2d663f[_0x10bfbc(0x9e)]?_0x11f6a6[_0x10bfbc(0xd4)]({'success':!![],'message':_0x10bfbc(0x78),'result':{'status':'PENDING','gatewayPaymentId':_0x2d663f['gateway_payment_id'],'redirectUrl':_0x2d663f[_0x10bfbc(0x9e)],'requires3ds':!![],'final':![]}}):_0x11f6a6[_0x10bfbc(0xf1)](0x190)[_0x10bfbc(0xd4)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x10bfbc(0xca),'gatewayPaymentId':_0x2d663f['gateway_payment_id'],'redirectUrl':_0x4bb5c7[_0x10bfbc(0xd1)],'final':!![]}});}catch(_0x55bec8){_0x5f4513(_0x55bec8);}},this[_0x1fe536(0xe5)]=new paymentService_1[(_0x1fe536(0x87))](),this['masterCardService']=new mastercardService_1['MasterCardService'](),this[_0x1fe536(0xd5)]=new webhookService_1[(_0x1fe536(0xf3))]();}async['sendShopWebhook'](_0x3885df,_0x1374ba,_0x3e44e8){const _0xcf39eb=a8_0x37e0e9,_0x31d7ac=Date[_0xcf39eb(0xa0)]();try{const _0x1d74f4=_0x3885df['shop'],_0xdd234d=_0x1d74f4[_0xcf39eb(0xc0)];if(!_0xdd234d?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1d74f4['id']);return;}const _0x113dfc=_0x1374ba===_0xcf39eb(0xad)?_0xcf39eb(0x82):'payment.failed';let _0xafca42=[];if(_0xdd234d['webhookEvents'])try{_0xafca42=Array[_0xcf39eb(0xd7)](_0xdd234d[_0xcf39eb(0xa6)])?_0xdd234d[_0xcf39eb(0xa6)]:JSON[_0xcf39eb(0x79)](_0xdd234d['webhookEvents']);}catch(_0x374b73){console[_0xcf39eb(0xbb)](_0xcf39eb(0xbc),_0x374b73),_0xafca42=[];}if(!_0xafca42[_0xcf39eb(0xbd)](_0x113dfc)){console['log'](_0xcf39eb(0xf4)+_0x113dfc+_0xcf39eb(0xe1)+_0x1d74f4['id']);return;}const _0x1eb99b={'event':_0x113dfc,'payment':{'id':_0x3885df['id'],'order_id':_0x3885df['orderId'],'gateway_order_id':_0x3885df[_0xcf39eb(0x99)],'gateway':_0xcf39eb(0xb7),'amount':_0x3885df[_0xcf39eb(0x8f)],'currency':_0x3885df[_0xcf39eb(0xec)],'status':_0x1374ba[_0xcf39eb(0xaa)](),'customer_email':_0x3885df[_0xcf39eb(0xee)],'customer_name':_0x3885df[_0xcf39eb(0xc6)],'gateway_payment_id':_0x3e44e8,'created_at':_0x3885df[_0xcf39eb(0xd9)],'updated_at':new Date()}},_0x43ca9d=await fetch(_0xdd234d['webhookUrl'],{'method':_0xcf39eb(0x8e),'headers':{'Content-Type':_0xcf39eb(0xe4),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x1eb99b)}),_0x57956d=Date['now']()-_0x31d7ac;console[_0xcf39eb(0xa8)](_0xcf39eb(0x86)+_0xdd234d[_0xcf39eb(0xf5)]+_0xcf39eb(0x88)+_0x43ca9d['status']+'\x20('+_0x57956d+'ms)');}catch(_0x44a4f9){console['error'](_0xcf39eb(0x76),_0x44a4f9);}}async[a8_0x37e0e9(0x93)](_0x4b05c9,_0x3e9553){const _0x3c489e=a8_0x37e0e9;try{const {telegramBotService:_0x995e33}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x428df6={'PAID':_0x3c489e(0xa7),'FAILED':_0x3c489e(0x74)},_0x337e3f=_0x428df6[_0x3e9553];if(!_0x337e3f)return;await _0x995e33[_0x3c489e(0xac)](_0x4b05c9[_0x3c489e(0xf0)],_0x4b05c9,_0x337e3f);}catch(_0xd04d0e){console[_0x3c489e(0xbb)](_0x3c489e(0xab),_0xd04d0e);}}}function a8_0x1450(_0x3fbde6,_0x3a883d){const _0x5b80f8=a8_0x5b80();return a8_0x1450=function(_0x1450bf,_0x5a238d){_0x1450bf=_0x1450bf-0x73;let _0x3bac24=_0x5b80f8[_0x1450bf];return _0x3bac24;},a8_0x1450(_0x3fbde6,_0x3a883d);}exports['PaymentController']=PaymentController;