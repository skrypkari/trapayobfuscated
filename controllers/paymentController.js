'use strict';const a14_0x5421ed=a14_0x3718;(function(_0x36d15b,_0x5adfa3){const _0x34b3b7=a14_0x3718,_0xdae6dd=_0x36d15b();while(!![]){try{const _0x394dfc=parseInt(_0x34b3b7(0x1c1))/0x1+-parseInt(_0x34b3b7(0x148))/0x2*(-parseInt(_0x34b3b7(0x1da))/0x3)+parseInt(_0x34b3b7(0x185))/0x4*(-parseInt(_0x34b3b7(0x19f))/0x5)+parseInt(_0x34b3b7(0x1a5))/0x6*(-parseInt(_0x34b3b7(0x205))/0x7)+parseInt(_0x34b3b7(0x18b))/0x8*(parseInt(_0x34b3b7(0x1a8))/0x9)+parseInt(_0x34b3b7(0x1ab))/0xa*(parseInt(_0x34b3b7(0x16b))/0xb)+-parseInt(_0x34b3b7(0x1ed))/0xc;if(_0x394dfc===_0x5adfa3)break;else _0xdae6dd['push'](_0xdae6dd['shift']());}catch(_0x1c8f7e){_0xdae6dd['push'](_0xdae6dd['shift']());}}}(a14_0x1521,0x4be6e));function a14_0x3718(_0xfbed6d,_0x3339a0){_0xfbed6d=_0xfbed6d-0x146;const _0x1521f7=a14_0x1521();let _0x371800=_0x1521f7[_0xfbed6d];return _0x371800;}var __createBinding=this&&this['__createBinding']||(Object[a14_0x5421ed(0x17d)]?function(_0x4d3879,_0x3ec68c,_0xe91044,_0x5a2ef0){const _0x1ea4c0=a14_0x5421ed;if(_0x5a2ef0===undefined)_0x5a2ef0=_0xe91044;var _0x1fd2f9=Object['getOwnPropertyDescriptor'](_0x3ec68c,_0xe91044);(!_0x1fd2f9||(_0x1ea4c0(0x190)in _0x1fd2f9?!_0x3ec68c[_0x1ea4c0(0x1d5)]:_0x1fd2f9[_0x1ea4c0(0x175)]||_0x1fd2f9[_0x1ea4c0(0x1ba)]))&&(_0x1fd2f9={'enumerable':!![],'get':function(){return _0x3ec68c[_0xe91044];}}),Object[_0x1ea4c0(0x1ac)](_0x4d3879,_0x5a2ef0,_0x1fd2f9);}:function(_0x326c36,_0x17d84d,_0x3758bc,_0x29dc2f){if(_0x29dc2f===undefined)_0x29dc2f=_0x3758bc;_0x326c36[_0x29dc2f]=_0x17d84d[_0x3758bc];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a14_0x5421ed(0x17d)]?function(_0x36c2b3,_0x5a3dfc){const _0x5cd16b=a14_0x5421ed;Object[_0x5cd16b(0x1ac)](_0x36c2b3,_0x5cd16b(0x15d),{'enumerable':!![],'value':_0x5a3dfc});}:function(_0x4a7509,_0xeebe91){const _0x10e3b1=a14_0x5421ed;_0x4a7509[_0x10e3b1(0x15d)]=_0xeebe91;}),__importStar=this&&this[a14_0x5421ed(0x1fa)]||(function(){var _0x5adc07=function(_0x4cff7e){const _0x5df11e=a14_0x3718;return _0x5adc07=Object[_0x5df11e(0x17b)]||function(_0x40adb1){const _0x7c18d8=_0x5df11e;var _0x1b3e90=[];for(var _0xc2d80e in _0x40adb1)if(Object[_0x7c18d8(0x1a1)]['hasOwnProperty'][_0x7c18d8(0x18c)](_0x40adb1,_0xc2d80e))_0x1b3e90[_0x1b3e90[_0x7c18d8(0x159)]]=_0xc2d80e;return _0x1b3e90;},_0x5adc07(_0x4cff7e);};return function(_0xdbd533){const _0x583993=a14_0x3718;if(_0xdbd533&&_0xdbd533[_0x583993(0x1d5)])return _0xdbd533;var _0x5e37a8={};if(_0xdbd533!=null){for(var _0x12f85b=_0x5adc07(_0xdbd533),_0x40ef6b=0x0;_0x40ef6b<_0x12f85b[_0x583993(0x159)];_0x40ef6b++)if(_0x12f85b[_0x40ef6b]!=='default')__createBinding(_0x5e37a8,_0xdbd533,_0x12f85b[_0x40ef6b]);}return __setModuleDefault(_0x5e37a8,_0xdbd533),_0x5e37a8;};}()),__importDefault=this&&this[a14_0x5421ed(0x174)]||function(_0x508f8c){const _0x472691=a14_0x5421ed;return _0x508f8c&&_0x508f8c[_0x472691(0x1d5)]?_0x508f8c:{'default':_0x508f8c};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a14_0x5421ed(0x1b6)]=void 0x0;const crypto_1=__importDefault(require('crypto')),paymentService_1=require(a14_0x5421ed(0x200)),mastercardService_1=require(a14_0x5421ed(0x1cd)),webhookService_1=require(a14_0x5421ed(0x1c0)),currencyService_1=require('../services/currencyService'),binLookupService_1=require(a14_0x5421ed(0x1cc)),database_1=__importDefault(require(a14_0x5421ed(0x18f)));class PaymentController{constructor(){const _0x348ee7=a14_0x5421ed;this[_0x348ee7(0x147)]=async(_0x47a0d7,_0x2972d3,_0x113629)=>{const _0x2344de=_0x348ee7;try{const _0x431766=_0x47a0d7[_0x2344de(0x1ee)],_0x520bcc=await this['paymentService'][_0x2344de(0x147)](_0x431766);_0x2972d3[_0x2344de(0x1d4)](0xc9)[_0x2344de(0x14d)]({'success':!![],'message':_0x2344de(0x1d0),'result':_0x520bcc});}catch(_0x9daa61){_0x113629(_0x9daa61);}},this[_0x348ee7(0x206)]=async(_0x3ee45b,_0x2a3d29,_0x4f6927)=>{const _0x12849f=_0x348ee7;try{const {id:_0x5a82bd}=_0x3ee45b['params'],_0x307eb7=await this[_0x12849f(0x1bf)][_0x12849f(0x206)](_0x5a82bd);if(!_0x307eb7)return _0x2a3d29[_0x12849f(0x1d4)](0x194)[_0x12849f(0x14d)]({'success':![],'message':'Payment\x20not\x20found'});_0x2a3d29[_0x12849f(0x14d)]({'success':!![],'result':_0x307eb7});}catch(_0x357d6e){_0x4f6927(_0x357d6e);}},this['getPaymentFingerprint']=async(_0x23fa1e,_0x2dd4db,_0x13711a)=>{const _0x5eba07=_0x348ee7;try{const {id:_0xc88fe2}=_0x23fa1e[_0x5eba07(0x1be)],{requestId:_0x4e2be0}=_0x23fa1e['query'];if(typeof _0x4e2be0!==_0x5eba07(0x15f))return _0x2dd4db[_0x5eba07(0x1d4)](0x190)[_0x5eba07(0x14d)]({'success':![],'message':_0x5eba07(0x16d)});console['log']('üîç\x20Received\x20fingerprint\x20request\x20for\x20payment\x20'+_0xc88fe2+_0x5eba07(0x1dc)+_0x4e2be0);const _0xa102c3=await this[_0x5eba07(0x1bf)][_0x5eba07(0x1d3)](_0xc88fe2,_0x4e2be0);if(!_0xa102c3)return _0x2dd4db[_0x5eba07(0x1d4)](0x194)[_0x5eba07(0x14d)]({'success':![],'message':_0x5eba07(0x154)});console[_0x5eba07(0x1f4)](_0x5eba07(0x16a)+_0xc88fe2+':',_0xa102c3),_0x2dd4db[_0x5eba07(0x14d)]({'success':!![],'result':_0xa102c3});}catch(_0x2e61ec){_0x13711a(_0x2e61ec);}},this[_0x348ee7(0x193)]=async(_0x5742ab,_0x64639,_0x195daa)=>{const _0x237068=_0x348ee7;try{const {id:_0x221718}=_0x5742ab[_0x237068(0x1be)],_0x5b3705=await this[_0x237068(0x1bf)]['getPaymentById'](_0x221718);if(!_0x5b3705)return _0x64639[_0x237068(0x1d4)](0x194)[_0x237068(0x14d)]({'success':![],'message':_0x237068(0x170)});_0x64639[_0x237068(0x14d)]({'success':!![],'result':_0x5b3705});}catch(_0x9d2c1b){_0x195daa(_0x9d2c1b);}},this['updatePaymentCustomer']=async(_0x333e7c,_0x5528f1,_0x33166f)=>{const _0x3ba4a6=_0x348ee7;try{const {id:_0x132e5c}=_0x333e7c[_0x3ba4a6(0x1be)],_0x463b3b=_0x333e7c[_0x3ba4a6(0x1ee)];console[_0x3ba4a6(0x1f4)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x132e5c),console[_0x3ba4a6(0x1f4)](_0x3ba4a6(0x1df),_0x463b3b);const _0x13c407=await this[_0x3ba4a6(0x1bf)][_0x3ba4a6(0x1ea)](_0x132e5c,_0x463b3b);if(!_0x13c407)return _0x5528f1['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x5528f1['json']({'success':!![],'message':_0x3ba4a6(0x15e),'result':{'paymentId':_0x13c407['id'],'customerIp':_0x13c407['customerIp'],'customerUa':_0x13c407[_0x3ba4a6(0x1a6)],'customerCountry':_0x13c407[_0x3ba4a6(0x201)],'updatedAt':_0x13c407[_0x3ba4a6(0x1b5)]}});}catch(_0x1cfb23){_0x33166f(_0x1cfb23);}},this[_0x348ee7(0x168)]=async(_0x304049,_0x44bc13,_0x2b1f52)=>{const _0x4a2302=_0x348ee7;try{const {id:_0x3fec95}=_0x304049[_0x4a2302(0x1be)],{cardData:_0x332319,cardHolder:_0x32b374,browser:_0x1e839f,phoneValidation:_0x566cd6}=_0x304049[_0x4a2302(0x1ee)];console['log'](_0x4a2302(0x14e)+_0x3fec95),console['log'](_0x4a2302(0x16e)+_0x32b374[_0x4a2302(0x1a2)]+'\x20'+_0x32b374[_0x4a2302(0x1b4)]+'\x20('+_0x32b374['email']+')'),console[_0x4a2302(0x1f4)](_0x4a2302(0x1f1)+_0x1e839f['ip']);const _0x1e89e2=_0x32b374[_0x4a2302(0x1a2)]?.[_0x4a2302(0x1f0)](/[\t\n\r\f\v]/g,'\x20')['trim']()||'',_0x59e6f8=_0x32b374['last_name']?.['replace'](/[\t\n\r\f\v]/g,'\x20')[_0x4a2302(0x176)]()||'';console[_0x4a2302(0x1f4)](_0x4a2302(0x166)),console['log'](_0x4a2302(0x1d7)+_0x32b374['first_name']+_0x4a2302(0x203)+_0x32b374['last_name']+'\x22'),console[_0x4a2302(0x1f4)]('\x20\x20Cleaned:\x20\x20\x22'+_0x1e89e2+_0x4a2302(0x203)+_0x59e6f8+'\x22');const _0x329963={'customerName':_0x1e89e2+'\x20'+_0x59e6f8,'customerEmail':_0x32b374[_0x4a2302(0x1e0)],'customerPhone':_0x32b374['phone']||null,'customerIp':_0x1e839f['ip'],'customerUa':_0x1e839f[_0x4a2302(0x1c9)]},_0x560921=[_0x32b374['address_line_1'],_0x32b374[_0x4a2302(0x199)]]['filter'](Boolean);_0x329963[_0x4a2302(0x197)]=_0x560921[_0x4a2302(0x165)](',\x20')||null,_0x329963[_0x4a2302(0x172)]=_0x32b374['city']||null,_0x329963['billingState']=_0x32b374[_0x4a2302(0x173)]||null,_0x329963[_0x4a2302(0x160)]=_0x32b374[_0x4a2302(0x1af)]||_0x32b374[_0x4a2302(0x167)]||null,console['log'](_0x4a2302(0x1d2),_0x329963[_0x4a2302(0x197)]),console['log']('üîç\x20Looking\x20up\x20BIN\x20for\x20card:',_0x332319[_0x4a2302(0x158)][_0x4a2302(0x1c5)](0x0,0x6)+_0x4a2302(0x1b1));const _0x41d83c=await binLookupService_1[_0x4a2302(0x1d8)][_0x4a2302(0x19d)](_0x332319['number']);console[_0x4a2302(0x1f4)]('üìä\x20BIN\x20lookup\x20result:',_0x41d83c);const _0x35cf8f=_0x332319['number'][_0x4a2302(0x1c5)](0x0,0x8),_0xab64a4=await database_1[_0x4a2302(0x15d)][_0x4a2302(0x1b8)]['findUnique']({'where':{'id':_0x3fec95},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xab64a4)return _0x44bc13[_0x4a2302(0x1d4)](0x194)[_0x4a2302(0x14d)]({'success':![],'message':_0x4a2302(0x170)});if(_0xab64a4[_0x4a2302(0x1ae)]!==_0x4a2302(0x178))return console[_0x4a2302(0x1f4)](_0x4a2302(0x16c)+_0xab64a4[_0x4a2302(0x1ae)]+'\x27'),_0x44bc13[_0x4a2302(0x1d4)](0x190)[_0x4a2302(0x14d)]({'success':![],'message':_0x4a2302(0x1e7)});if(_0xab64a4[_0x4a2302(0x1d4)]!==_0x4a2302(0x195))return _0x44bc13[_0x4a2302(0x1d4)](0x190)[_0x4a2302(0x14d)]({'success':![],'message':_0x4a2302(0x1eb)+_0xab64a4[_0x4a2302(0x1d4)]+',\x20cannot\x20process'});await database_1[_0x4a2302(0x15d)][_0x4a2302(0x1b8)][_0x4a2302(0x163)]({'where':{'id':_0x3fec95},'data':{..._0x329963,'cardBin':_0x35cf8f,'cardBinStatus':_0x41d83c[_0x4a2302(0x164)],'cardType':_0x41d83c[_0x4a2302(0x14b)],'cardCategory':_0x41d83c[_0x4a2302(0x194)],'cardCountry':_0x41d83c[_0x4a2302(0x1b3)],'cardIssuer':_0x41d83c['cardIssuer'],'phoneIsValid':_0x566cd6?.[_0x4a2302(0x1f5)],'phoneLineStatus':_0x566cd6?.[_0x4a2302(0x14f)],'phoneIsVoip':_0x566cd6?.['isVoip'],'phoneRiskLevel':_0x566cd6?.[_0x4a2302(0x1e3)],'updatedAt':new Date()}}),console['log'](_0x4a2302(0x1c6));const _0x5b7805=_0x332319[_0x4a2302(0x158)][_0x4a2302(0x1f0)](/[\s-]/g,''),_0x281562=_0x5b7805[_0x4a2302(0x1ff)]('4')?_0x4a2302(0x1d9):'mastercard',_0x5f6900=_0x5b7805[_0x4a2302(0x1ff)]('4')?_0x4a2302(0x1c8):_0x4a2302(0x17e),_0x5e6ce7=_0x4a2302(0x183)+_0x281562,_0x1333d2='https://app.trapay.uk/payment/pending?id='+_0xab64a4['id']+'&payment_id='+_0xab64a4['gatewayOrderId'];console[_0x4a2302(0x1f4)](_0x4a2302(0x1e9)+_0x281562[_0x4a2302(0x1bc)]()+_0x4a2302(0x19b)),console[_0x4a2302(0x1f4)](_0x4a2302(0x1ad)+_0x5e6ce7),console[_0x4a2302(0x1f4)](_0x4a2302(0x1c2)+_0x1333d2);const _0x1d02e9={'first_name':_0x32b374[_0x4a2302(0x1a2)],'last_name':_0x32b374[_0x4a2302(0x1b4)],'email':_0x32b374[_0x4a2302(0x1e0)]},_0x4306bd=await this[_0x4a2302(0x187)]['processCardPayment']({'paymentId':_0xab64a4['id'],'orderId':_0xab64a4['gatewayOrderId']||_0xab64a4['id'],'amount':_0xab64a4[_0x4a2302(0x1cf)],'currency':_0xab64a4[_0x4a2302(0x196)],'cardData':_0x332319,'resultUrl':_0x5e6ce7,'returnUrl':_0x1333d2,'cardHolder':_0x1d02e9,'browser':_0x1e839f});console[_0x4a2302(0x1f4)]('üí≥\x20MasterCard\x20result:',_0x4306bd);const _0x5263b9={'status':_0x4306bd[_0x4a2302(0x1d4)],'updatedAt':new Date(),'statusChangedBy':_0x4a2302(0x180),'statusChangedAt':new Date()};_0x4306bd[_0x4a2302(0x162)]&&(_0x5263b9[_0x4a2302(0x18d)]=_0x4306bd[_0x4a2302(0x162)],console['log'](_0x4a2302(0x1bd)+_0x4306bd[_0x4a2302(0x162)]));if(_0x4306bd[_0x4a2302(0x1d4)]===_0x4a2302(0x20b)){_0x5263b9[_0x4a2302(0x14a)]=new Date();const _0x1f5c7f=await this[_0x4a2302(0x188)][_0x4a2302(0x186)](_0xab64a4[_0x4a2302(0x1cf)],_0xab64a4[_0x4a2302(0x196)]),_0x5ee553=await this['webhookService'][_0x4a2302(0x1f9)](_0xab64a4['shopId'],_0xab64a4[_0x4a2302(0x1ae)]),_0x289a36=_0x1f5c7f*(0x1-_0x5ee553/0x64);_0x5263b9[_0x4a2302(0x1d6)]=_0x1f5c7f,_0x5263b9[_0x4a2302(0x169)]=_0x289a36,_0x5263b9['gatewayCommissionRate']=_0x5ee553,console[_0x4a2302(0x1f4)](_0x4a2302(0x209)+_0xab64a4[_0x4a2302(0x1cf)]+'\x20'+_0xab64a4['currency']+'\x20->\x20'+_0x1f5c7f[_0x4a2302(0x1aa)](0x6)+_0x4a2302(0x1fd)),console[_0x4a2302(0x1f4)](_0x4a2302(0x1e1)+_0xab64a4[_0x4a2302(0x1ae)]+_0x4a2302(0x153)+_0x5ee553+'%'),console[_0x4a2302(0x1f4)](_0x4a2302(0x150)+_0x289a36[_0x4a2302(0x1aa)](0x6)+'\x20USDT');}else _0x4306bd['status']==='FAILED'&&(_0x5263b9[_0x4a2302(0x1c7)]=_0x4306bd[_0x4a2302(0x1de)]||_0x4a2302(0x14c),console[_0x4a2302(0x1f4)](_0x4a2302(0x1b2)+_0x5263b9['failureMessage']));_0x5263b9['paymentMethod']=_0x4a2302(0x1a0);if(_0x332319[_0x4a2302(0x158)]){const _0x154d7f=_0x332319[_0x4a2302(0x158)][_0x4a2302(0x1f0)](/[\s-]/g,'');_0x5263b9[_0x4a2302(0x1fb)]=_0x154d7f['slice'](-0x4),_0x5263b9[_0x4a2302(0x171)]=_0x5f6900,console[_0x4a2302(0x1f4)](_0x4a2302(0x1f3)+_0x5263b9['cardLast4']),console[_0x4a2302(0x1f4)](_0x4a2302(0x1ef)+_0x5f6900);}await database_1['default'][_0x4a2302(0x1b8)][_0x4a2302(0x163)]({'where':{'id':_0xab64a4['id']},'data':_0x5263b9});_0x4306bd[_0x4a2302(0x1d4)]==='PAID'&&(await this['webhookService'][_0x4a2302(0x146)](_0xab64a4['id'],_0x4a2302(0x20b)),console[_0x4a2302(0x1f4)]('üí∞\x20Updated\x20merchant\x20balance\x20for\x20payment\x20'+_0xab64a4['id']));await database_1['default'][_0x4a2302(0x155)][_0x4a2302(0x17d)]({'data':{'paymentId':_0xab64a4['id'],'shopId':_0xab64a4['shopId'],'event':_0x281562+'_'+_0x4306bd[_0x4a2302(0x1d4)]?.[_0x4a2302(0x1ce)](),'statusCode':0xc8,'responseBody':JSON[_0x4a2302(0x15a)]({'oldStatus':_0x4a2302(0x195),'newStatus':_0x4306bd[_0x4a2302(0x1d4)],'gatewayPaymentId':_0x4306bd[_0x4a2302(0x162)],'requires3ds':_0x4306bd[_0x4a2302(0x189)],'cardType':_0x281562['toUpperCase'](),'processedAt':new Date()[_0x4a2302(0x184)]()})}});if(_0x4306bd['final']){await this['sendShopWebhook'](_0xab64a4,_0x4306bd[_0x4a2302(0x1d4)],_0x4306bd[_0x4a2302(0x162)],_0x281562),await this[_0x4a2302(0x1b9)](_0xab64a4,_0x4306bd[_0x4a2302(0x1d4)]);if(_0x4306bd[_0x4a2302(0x1d4)]==='PAID'){console['log'](_0x4a2302(0x1fc)+_0x281562[_0x4a2302(0x1bc)]()+_0x4a2302(0x1e5)+_0x3fec95+_0x4a2302(0x204));try{const {PaymentLinkService:_0x613c20}=await Promise[_0x4a2302(0x191)]()[_0x4a2302(0x1a9)](()=>__importStar(require('../services/paymentLinkService'))),_0x6fbcbe=new _0x613c20();await _0x6fbcbe[_0x4a2302(0x15c)](_0x3fec95),console[_0x4a2302(0x1f4)](_0x4a2302(0x161)+_0x281562[_0x4a2302(0x1bc)]()+_0x4a2302(0x1e5)+_0x3fec95);}catch(_0x5dc002){console[_0x4a2302(0x1e2)](_0x4a2302(0x1e4)+_0x281562[_0x4a2302(0x1bc)]()+_0x4a2302(0x19a),_0x5dc002);}}}console[_0x4a2302(0x1f4)]('‚úÖ\x20'+_0x281562[_0x4a2302(0x1bc)]()+'\x20payment\x20'+_0x3fec95+_0x4a2302(0x198)+_0x4306bd[_0x4a2302(0x1d4)]);if(_0x4306bd[_0x4a2302(0x1d4)]===_0x4a2302(0x20b))_0x44bc13[_0x4a2302(0x14d)]({'success':!![],'message':_0x4a2302(0x1f2),'result':{'status':_0x4a2302(0x20b),'gatewayPaymentId':_0x4306bd[_0x4a2302(0x162)],'redirectUrl':_0x1333d2,'final':!![]}});else _0x4306bd[_0x4a2302(0x189)]&&_0x4306bd[_0x4a2302(0x181)]?_0x44bc13['json']({'success':!![],'message':_0x4a2302(0x15b),'result':{'status':'PENDING','gatewayPaymentId':_0x4306bd['gateway_payment_id'],'redirectUrl':_0x4306bd[_0x4a2302(0x181)],'requires3ds':!![],'final':![]}}):_0x44bc13['status'](0x190)[_0x4a2302(0x14d)]({'success':![],'message':_0x4a2302(0x1db),'result':{'status':_0x4a2302(0x19e),'gatewayPaymentId':_0x4306bd[_0x4a2302(0x162)],'redirectUrl':_0xab64a4[_0x4a2302(0x17f)],'final':!![]}});}catch(_0x4b7360){_0x2b1f52(_0x4b7360);}},this[_0x348ee7(0x1bf)]=new paymentService_1[(_0x348ee7(0x1bb))](),this[_0x348ee7(0x187)]=new mastercardService_1[(_0x348ee7(0x207))](),this[_0x348ee7(0x19c)]=new webhookService_1[(_0x348ee7(0x182))](),this[_0x348ee7(0x188)]=new currencyService_1[(_0x348ee7(0x149))]();}async[a14_0x5421ed(0x1f6)](_0x32b425,_0x65aa3a,_0x51d270,_0x42c43e){const _0x2fc708=a14_0x5421ed,_0x40228a=Date[_0x2fc708(0x1ca)]();try{const _0x44051f=_0x32b425[_0x2fc708(0x156)],_0x22ba88=_0x44051f[_0x2fc708(0x1b0)];if(!_0x22ba88?.['webhookUrl']){console[_0x2fc708(0x1f4)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x44051f['id']);return;}const _0x54999b=_0x65aa3a==='PAID'?_0x2fc708(0x1a4):_0x2fc708(0x1cb);let _0x3dc3b1=[];if(_0x22ba88[_0x2fc708(0x192)])try{_0x3dc3b1=Array[_0x2fc708(0x152)](_0x22ba88['webhookEvents'])?_0x22ba88[_0x2fc708(0x192)]:JSON['parse'](_0x22ba88[_0x2fc708(0x192)]);}catch(_0x5c44a8){console[_0x2fc708(0x1e2)](_0x2fc708(0x1a7),_0x5c44a8),_0x3dc3b1=[];}if(!_0x3dc3b1[_0x2fc708(0x1c4)](_0x54999b)){console[_0x2fc708(0x1f4)](_0x2fc708(0x151)+_0x54999b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x44051f['id']);return;}const _0x253bb8={'event':_0x54999b,'payment':{'id':_0x32b425['id'],'order_id':_0x32b425[_0x2fc708(0x1b7)],'gateway_order_id':_0x32b425[_0x2fc708(0x1a3)],'gateway':_0x2fc708(0x1fe),'card_type':_0x42c43e?.[_0x2fc708(0x1bc)]()||_0x2fc708(0x1f8),'amount':_0x32b425[_0x2fc708(0x1cf)],'currency':_0x32b425[_0x2fc708(0x196)],'status':_0x65aa3a['toLowerCase'](),'customer_email':_0x32b425[_0x2fc708(0x1f7)],'customer_name':_0x32b425[_0x2fc708(0x202)],'gateway_payment_id':_0x51d270,'created_at':_0x32b425[_0x2fc708(0x17a)],'updated_at':new Date()}},_0x4276c7=JSON[_0x2fc708(0x15a)](_0x253bb8),_0x16edae=crypto_1[_0x2fc708(0x15d)][_0x2fc708(0x18a)](_0x2fc708(0x179),_0x44051f[_0x2fc708(0x17c)])['update'](_0x4276c7)['digest'](_0x2fc708(0x1e8)),_0x400f14=await fetch(_0x22ba88[_0x2fc708(0x18e)],{'method':_0x2fc708(0x1d1),'headers':{'Content-Type':'application/json','User-Agent':_0x2fc708(0x208)+(_0x42c43e?.[_0x2fc708(0x1bc)]()||_0x2fc708(0x16f))+')','X-Webhook-Signature':_0x16edae},'body':_0x4276c7}),_0x584e2c=Date[_0x2fc708(0x1ca)]()-_0x40228a;console['log']((_0x42c43e?.[_0x2fc708(0x1bc)]()||'VISA/MasterCard')+_0x2fc708(0x20a)+_0x22ba88[_0x2fc708(0x18e)]+_0x2fc708(0x177)+_0x400f14[_0x2fc708(0x1d4)]+'\x20('+_0x584e2c+_0x2fc708(0x1e6));}catch(_0x1e880c){console[_0x2fc708(0x1e2)](_0x2fc708(0x157)+(_0x42c43e?.[_0x2fc708(0x1bc)]()||_0x2fc708(0x16f))+'\x20webhook:',_0x1e880c);}}async[a14_0x5421ed(0x1b9)](_0x1ad27d,_0x9f5b31){const _0x413ac6=a14_0x5421ed;try{const {telegramBotService:_0x13fec5}=await Promise[_0x413ac6(0x191)]()[_0x413ac6(0x1a9)](()=>__importStar(require('../services/telegramBotService'))),_0x418bee={'PAID':_0x413ac6(0x1dd),'FAILED':'failed'},_0x427f00=_0x418bee[_0x9f5b31];if(!_0x427f00)return;await _0x13fec5[_0x413ac6(0x1ec)](_0x1ad27d['shopId'],_0x1ad27d,_0x427f00);}catch(_0x47ae10){console[_0x413ac6(0x1e2)](_0x413ac6(0x1c3),_0x47ae10);}}}function a14_0x1521(){const _0x31c4ce=['trim','\x20with\x20status\x20','visa/mastercard','sha256','createdAt','getOwnPropertyNames','secretKey','create','MASTERCARD','failUrl','system','threeds_url','WebhookService','https://api.trapay.uk/api/webhooks/gateway/','toISOString','184kLONcV','convertToUSDT','visaMasterCardService','currencyService','requires_3ds','createHmac','4850192kkHfqG','call','gatewayPaymentId','webhookUrl','../config/database','get','resolve','webhookEvents','getPaymentById','cardCategory','PENDING','currency','billingAddress','\x20processed:\x20','address_line_2','\x20payment:','\x20URLs:','webhookService','lookupBin','FAILED','67495guMaDD','Bank\x20Card','prototype','first_name','gatewayOrderId','payment.success','150yFgQBL','customerUa','Error\x20parsing\x20webhook\x20events:','9fXQSjR','then','toFixed','2804860YLCCAF','defineProperty','\x20\x20\x20Result\x20URL\x20(webhook):\x20','gateway','post_code','settings','******','‚ùå\x20Payment\x20failed\x20with\x20message:\x20','cardCountry','last_name','updatedAt','PaymentController','orderId','payment','sendPaymentStatusNotification','configurable','PaymentService','toUpperCase','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','params','paymentService','../services/webhookService','419806elwUrp','\x20\x20\x20Return\x20URL:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','includes','substring','‚úÖ\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info','failureMessage','VISA','user_agent','now','payment.failed','../services/binLookupService','../services/gateways/mastercardService','toLowerCase','amount','Payment\x20created\x20successfully','POST','üìç\x20Billing\x20address\x20(string):','getPaymentFingerprint','status','__esModule','amountUSDT','\x20\x20Original:\x20\x22','binLookupService','visa','45078dLucbl','Payment\x20failed','\x20with\x20requestId\x20','paid','errorMessage','üìù\x20Customer\x20data:','email','üí∞\x20Gateway\x20','error','riskLevel','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','\x20payment\x20','ms)','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','hex','üí≥\x20','updatePaymentCustomerDataPublic','Payment\x20status\x20is\x20','sendPaymentNotification','6109272Wftgud','body','üí≥\x20Saving\x20card\x20brand:\x20','replace','üí≥\x20Browser\x20IP:\x20','Payment\x20processed\x20successfully','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','log','isValid','sendShopWebhook','customerEmail','UNKNOWN','getGatewayCommission','__importStar','cardLast4','üìà\x20','\x20USDT','1111','startsWith','../services/paymentService','customerCountry','customerName','\x22\x20|\x20\x22','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','49322AJszrr','getPaymentStatus','VisaMasterCardService','Payment\x20System/1.0\x20(','üí∞\x20Converting\x20','\x20webhook\x20sent\x20to\x20','PAID','updatePaymentStatus','createPublicPayment','4SEGKrg','CurrencyService','paidAt','cardType','Card\x20payment\x20failed','json','üí≥\x20Processing\x20MasterCard\x20payment:\x20','lineStatus','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','Webhook\x20event\x20','isArray','\x20commission:\x20','Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available','webhookLog','shop','Failed\x20to\x20send\x20','number','length','stringify','3DS\x20verification\x20required','handleSuccessfulPayment','default','Customer\x20data\x20updated\x20successfully','string','billingZip','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','gateway_payment_id','update','cardBinStatus','join','üßπ\x20Customer\x20names\x20cleaned:','postcode','processMasterCardPayment','amountAfterGatewayCommissionUSDT','‚úÖ\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','22ESsskD','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string','üí≥\x20Card\x20holder:\x20','VISA/MasterCard','Payment\x20not\x20found','cardBrand','billingCity','state','__importDefault','writable'];a14_0x1521=function(){return _0x31c4ce;};return a14_0x1521();}exports[a14_0x5421ed(0x1b6)]=PaymentController;