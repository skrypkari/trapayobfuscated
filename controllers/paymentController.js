'use strict';const a8_0x285520=a8_0x10ef;(function(_0x10a98e,_0x142caa){const _0x428508=a8_0x10ef,_0x342e96=_0x10a98e();while(!![]){try{const _0x16d723=-parseInt(_0x428508(0xa2))/0x1*(parseInt(_0x428508(0xc4))/0x2)+parseInt(_0x428508(0xa8))/0x3*(parseInt(_0x428508(0xd3))/0x4)+-parseInt(_0x428508(0x9e))/0x5+-parseInt(_0x428508(0xb6))/0x6+-parseInt(_0x428508(0x97))/0x7*(parseInt(_0x428508(0x71))/0x8)+-parseInt(_0x428508(0xc7))/0x9*(-parseInt(_0x428508(0x8f))/0xa)+-parseInt(_0x428508(0x6e))/0xb*(-parseInt(_0x428508(0xc8))/0xc);if(_0x16d723===_0x142caa)break;else _0x342e96['push'](_0x342e96['shift']());}catch(_0x3560e9){_0x342e96['push'](_0x342e96['shift']());}}}(a8_0x256c,0x49b52));function a8_0x10ef(_0x342ba7,_0x4ec964){const _0x256c83=a8_0x256c();return a8_0x10ef=function(_0x10efb7,_0x1dc684){_0x10efb7=_0x10efb7-0x6e;let _0x18e86a=_0x256c83[_0x10efb7];return _0x18e86a;},a8_0x10ef(_0x342ba7,_0x4ec964);}function a8_0x256c(){const _0xe332a2=['No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','__importStar','934868kxPBfC','status','toLowerCase','856344lnynIK','Payment\x20processed\x20successfully','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','paymentService','failed','body','amount','application/json','sendPaymentNotification','now','__esModule','paymentMethod','masterCardService','../services/gateways/mastercardService','params','webhookLog','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerName',',\x20cannot\x20process','orderId','threeds_url','getPaymentStatus','payment','getPaymentById','mastercard','requires_3ds','error','1111','sendShopWebhook','ðŸ’³\x20MasterCard\x20URLs:','10GkXrgV','PAID','createPublicPayment','includes','payment.failed','webhookUrl','json','isArray','35LIzXkW','create','__createBinding','paid','update','PaymentController','Payment\x20status\x20is\x20','588875ZzDPBt','Payment\x20created\x20successfully','findUnique','prototype','107FttdWO','call','sendPaymentStatusNotification','processCardPayment','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','currency','72xNHURM','3DS\x20verification\x20required','PENDING','gatewayPaymentId','gatewayOrderId','shop','stringify','PaymentService','\x20processed:\x20','FAILED','webhookService','ms)','__importDefault','processMasterCardPayment','2121240UEjeXq','configurable','payment.success','Payment\x20not\x20found','WebhookService','webhookEvents','length','writable','createdAt','POST','../config/database','hasOwnProperty','log','\x20\x20\x20Result\x20URL\x20(webhook):\x20','3254cYORkI','mastercard_','MasterCardService','1646289qZLknN','156rnapNT','../services/telegramBotService','resolve','default','defineProperty','gateway','../services/webhookService','getOwnPropertyDescriptor','gateway_payment_id','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Error\x20parsing\x20webhook\x20events:','32460cmFqaV','shopId','\x20not\x20enabled\x20for\x20shop\x20','final'];a8_0x256c=function(){return _0xe332a2;};return a8_0x256c();}var __createBinding=this&&this[a8_0x285520(0x99)]||(Object[a8_0x285520(0x98)]?function(_0x46500b,_0x4b517e,_0x5ca92e,_0x4bae24){const _0x5b1be3=a8_0x285520;if(_0x4bae24===undefined)_0x4bae24=_0x5ca92e;var _0x340154=Object[_0x5b1be3(0xcf)](_0x4b517e,_0x5ca92e);(!_0x340154||('get'in _0x340154?!_0x4b517e[_0x5b1be3(0x7b)]:_0x340154[_0x5b1be3(0xbd)]||_0x340154[_0x5b1be3(0xb7)]))&&(_0x340154={'enumerable':!![],'get':function(){return _0x4b517e[_0x5ca92e];}}),Object[_0x5b1be3(0xcc)](_0x46500b,_0x4bae24,_0x340154);}:function(_0x246169,_0x4999d9,_0x52b24a,_0x5d9ce4){if(_0x5d9ce4===undefined)_0x5d9ce4=_0x52b24a;_0x246169[_0x5d9ce4]=_0x4999d9[_0x52b24a];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x51bbf9,_0x4fdd3f){const _0x2408c7=a8_0x285520;Object[_0x2408c7(0xcc)](_0x51bbf9,'default',{'enumerable':!![],'value':_0x4fdd3f});}:function(_0x211c72,_0x99c356){const _0x519bfc=a8_0x285520;_0x211c72[_0x519bfc(0xcb)]=_0x99c356;}),__importStar=this&&this[a8_0x285520(0xd8)]||(function(){var _0x3394ec=function(_0x375f94){return _0x3394ec=Object['getOwnPropertyNames']||function(_0x33eda4){const _0x29bb9f=a8_0x10ef;var _0x1d36d1=[];for(var _0xbd45fe in _0x33eda4)if(Object[_0x29bb9f(0xa1)][_0x29bb9f(0xc1)][_0x29bb9f(0xa3)](_0x33eda4,_0xbd45fe))_0x1d36d1[_0x1d36d1[_0x29bb9f(0xbc)]]=_0xbd45fe;return _0x1d36d1;},_0x3394ec(_0x375f94);};return function(_0x59161d){if(_0x59161d&&_0x59161d['__esModule'])return _0x59161d;var _0x169658={};if(_0x59161d!=null){for(var _0x133a4c=_0x3394ec(_0x59161d),_0x509936=0x0;_0x509936<_0x133a4c['length'];_0x509936++)if(_0x133a4c[_0x509936]!=='default')__createBinding(_0x169658,_0x59161d,_0x133a4c[_0x509936]);}return __setModuleDefault(_0x169658,_0x59161d),_0x169658;};}()),__importDefault=this&&this[a8_0x285520(0xb4)]||function(_0x5b6d5b){const _0x4e9c46=a8_0x285520;return _0x5b6d5b&&_0x5b6d5b[_0x4e9c46(0x7b)]?_0x5b6d5b:{'default':_0x5b6d5b};};Object['defineProperty'](exports,a8_0x285520(0x7b),{'value':!![]}),exports[a8_0x285520(0x9c)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x285520(0x7e)),webhookService_1=require(a8_0x285520(0xce)),database_1=__importDefault(require(a8_0x285520(0xc0)));class PaymentController{constructor(){const _0x41cd7c=a8_0x285520;this[_0x41cd7c(0x91)]=async(_0x393b93,_0x1ff265,_0x30c08b)=>{const _0x3f51f5=_0x41cd7c;try{const _0x336ae9=_0x393b93[_0x3f51f5(0x76)],_0x4c92d0=await this['paymentService']['createPublicPayment'](_0x336ae9);_0x1ff265['status'](0xc9)[_0x3f51f5(0x95)]({'success':!![],'message':_0x3f51f5(0x9f),'result':_0x4c92d0});}catch(_0x291174){_0x30c08b(_0x291174);}},this[_0x41cd7c(0x86)]=async(_0x62d8b8,_0x205bad,_0x457c5b)=>{const _0x3cd92a=_0x41cd7c;try{const {id:_0x50dcb6}=_0x62d8b8[_0x3cd92a(0x7f)],_0x284ed1=await this[_0x3cd92a(0x74)]['getPaymentStatus'](_0x50dcb6);if(!_0x284ed1)return _0x205bad[_0x3cd92a(0x6f)](0x194)[_0x3cd92a(0x95)]({'success':![],'message':_0x3cd92a(0xb9)});_0x205bad['json']({'success':!![],'result':_0x284ed1});}catch(_0x29ade5){_0x457c5b(_0x29ade5);}},this[_0x41cd7c(0x88)]=async(_0x2d51e3,_0x21a037,_0x1571e2)=>{const _0x42bf32=_0x41cd7c;try{const {id:_0xdef48d}=_0x2d51e3['params'],_0x5475a9=await this[_0x42bf32(0x74)][_0x42bf32(0x88)](_0xdef48d);if(!_0x5475a9)return _0x21a037[_0x42bf32(0x6f)](0x194)[_0x42bf32(0x95)]({'success':![],'message':_0x42bf32(0xb9)});_0x21a037[_0x42bf32(0x95)]({'success':!![],'result':_0x5475a9});}catch(_0x3c1fe){_0x1571e2(_0x3c1fe);}},this[_0x41cd7c(0xb5)]=async(_0x512fef,_0x33e6de,_0x3a3139)=>{const _0x47fe93=_0x41cd7c;try{const {id:_0x498eb3}=_0x512fef[_0x47fe93(0x7f)],{cardData:_0x2c3b27,cardHolder:_0x203389,browser:_0x383409}=_0x512fef[_0x47fe93(0x76)];console[_0x47fe93(0xc2)](_0x47fe93(0xa6)+_0x498eb3);const _0x25c961=await database_1['default'][_0x47fe93(0x87)][_0x47fe93(0xa0)]({'where':{'id':_0x498eb3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25c961)return _0x33e6de[_0x47fe93(0x6f)](0x194)[_0x47fe93(0x95)]({'success':![],'message':_0x47fe93(0xb9)});if(_0x25c961[_0x47fe93(0xcd)]!=='mastercard')return _0x33e6de[_0x47fe93(0x6f)](0x190)[_0x47fe93(0x95)]({'success':![],'message':_0x47fe93(0xd1)});if(_0x25c961['status']!==_0x47fe93(0xaa))return _0x33e6de['status'](0x190)[_0x47fe93(0x95)]({'success':![],'message':_0x47fe93(0x9d)+_0x25c961[_0x47fe93(0x6f)]+_0x47fe93(0x83)});const _0x1893bf=_0x47fe93(0x73),_0x56cb94=_0x25c961['successUrl'];console[_0x47fe93(0xc2)](_0x47fe93(0x8e)),console[_0x47fe93(0xc2)](_0x47fe93(0xc3)+_0x1893bf),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x56cb94);const _0x41fb7d=await this[_0x47fe93(0x7d)][_0x47fe93(0xa5)]({'paymentId':_0x25c961['id'],'orderId':_0x25c961[_0x47fe93(0xac)]||_0x25c961['id'],'amount':_0x25c961[_0x47fe93(0x77)],'currency':_0x25c961[_0x47fe93(0xa7)],'cardData':_0x2c3b27,'resultUrl':_0x1893bf,'returnUrl':_0x56cb94,'cardHolder':_0x203389,'browser':_0x383409});console['log']('ðŸ’³\x20MasterCard\x20result:',_0x41fb7d);const _0x31a7c5={'status':_0x41fb7d['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x41fb7d[_0x47fe93(0x6f)]===_0x47fe93(0x90))_0x31a7c5['paidAt']=new Date(),_0x31a7c5[_0x47fe93(0xab)]=_0x41fb7d[_0x47fe93(0xd0)];else _0x41fb7d[_0x47fe93(0x6f)]===_0x47fe93(0xb1)&&(_0x31a7c5['failureMessage']='Card\x20payment\x20failed');_0x31a7c5[_0x47fe93(0x7c)]=_0x47fe93(0x89),await database_1[_0x47fe93(0xcb)][_0x47fe93(0x87)][_0x47fe93(0x9b)]({'where':{'id':_0x25c961['id']},'data':_0x31a7c5}),await database_1[_0x47fe93(0xcb)][_0x47fe93(0x80)]['create']({'data':{'paymentId':_0x25c961['id'],'shopId':_0x25c961[_0x47fe93(0xd4)],'event':_0x47fe93(0xc5)+_0x41fb7d[_0x47fe93(0x6f)]?.[_0x47fe93(0x70)](),'statusCode':0xc8,'responseBody':JSON[_0x47fe93(0xae)]({'oldStatus':_0x47fe93(0xaa),'newStatus':_0x41fb7d[_0x47fe93(0x6f)],'gatewayPaymentId':_0x41fb7d[_0x47fe93(0xd0)],'requires3ds':_0x41fb7d[_0x47fe93(0x8a)],'processedAt':new Date()['toISOString']()})}});_0x41fb7d[_0x47fe93(0xd6)]&&(await this[_0x47fe93(0x8d)](_0x25c961,_0x41fb7d[_0x47fe93(0x6f)],_0x41fb7d[_0x47fe93(0xd0)]),await this['sendPaymentStatusNotification'](_0x25c961,_0x41fb7d[_0x47fe93(0x6f)]));console['log']('âœ…\x20MasterCard\x20payment\x20'+_0x498eb3+_0x47fe93(0xb0)+_0x41fb7d[_0x47fe93(0x6f)]);if(_0x41fb7d['status']===_0x47fe93(0x90))_0x33e6de[_0x47fe93(0x95)]({'success':!![],'message':_0x47fe93(0x72),'result':{'status':_0x47fe93(0x90),'gatewayPaymentId':_0x41fb7d[_0x47fe93(0xd0)],'redirectUrl':_0x56cb94,'final':!![]}});else _0x41fb7d[_0x47fe93(0x8a)]&&_0x41fb7d[_0x47fe93(0x85)]?_0x33e6de[_0x47fe93(0x95)]({'success':!![],'message':_0x47fe93(0xa9),'result':{'status':_0x47fe93(0xaa),'gatewayPaymentId':_0x41fb7d[_0x47fe93(0xd0)],'redirectUrl':_0x41fb7d[_0x47fe93(0x85)],'requires3ds':!![],'final':![]}}):_0x33e6de['status'](0x190)[_0x47fe93(0x95)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x47fe93(0xb1),'gatewayPaymentId':_0x41fb7d['gateway_payment_id'],'redirectUrl':_0x25c961['failUrl'],'final':!![]}});}catch(_0x2f8450){_0x3a3139(_0x2f8450);}},this[_0x41cd7c(0x74)]=new paymentService_1[(_0x41cd7c(0xaf))](),this[_0x41cd7c(0x7d)]=new mastercardService_1[(_0x41cd7c(0xc6))](),this[_0x41cd7c(0xb2)]=new webhookService_1[(_0x41cd7c(0xba))]();}async[a8_0x285520(0x8d)](_0x45d067,_0x1097c0,_0x145956){const _0x20e6e1=a8_0x285520,_0x51540b=Date[_0x20e6e1(0x7a)]();try{const _0x40cf06=_0x45d067[_0x20e6e1(0xad)],_0x1ae836=_0x40cf06['settings'];if(!_0x1ae836?.['webhookUrl']){console[_0x20e6e1(0xc2)](_0x20e6e1(0xd7)+_0x40cf06['id']);return;}const _0x19f960=_0x1097c0===_0x20e6e1(0x90)?_0x20e6e1(0xb8):_0x20e6e1(0x93);let _0x247193=[];if(_0x1ae836[_0x20e6e1(0xbb)])try{_0x247193=Array[_0x20e6e1(0x96)](_0x1ae836[_0x20e6e1(0xbb)])?_0x1ae836[_0x20e6e1(0xbb)]:JSON['parse'](_0x1ae836[_0x20e6e1(0xbb)]);}catch(_0x2878b9){console[_0x20e6e1(0x8b)](_0x20e6e1(0xd2),_0x2878b9),_0x247193=[];}if(!_0x247193[_0x20e6e1(0x92)](_0x19f960)){console[_0x20e6e1(0xc2)]('Webhook\x20event\x20'+_0x19f960+_0x20e6e1(0xd5)+_0x40cf06['id']);return;}const _0x5cff2f={'event':_0x19f960,'payment':{'id':_0x45d067['id'],'order_id':_0x45d067[_0x20e6e1(0x84)],'gateway_order_id':_0x45d067['gatewayOrderId'],'gateway':_0x20e6e1(0x8c),'amount':_0x45d067[_0x20e6e1(0x77)],'currency':_0x45d067[_0x20e6e1(0xa7)],'status':_0x1097c0[_0x20e6e1(0x70)](),'customer_email':_0x45d067['customerEmail'],'customer_name':_0x45d067[_0x20e6e1(0x82)],'gateway_payment_id':_0x145956,'created_at':_0x45d067[_0x20e6e1(0xbe)],'updated_at':new Date()}},_0x8105a2=await fetch(_0x1ae836[_0x20e6e1(0x94)],{'method':_0x20e6e1(0xbf),'headers':{'Content-Type':_0x20e6e1(0x78),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x20e6e1(0xae)](_0x5cff2f)}),_0x1f37ee=Date[_0x20e6e1(0x7a)]()-_0x51540b;console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x1ae836['webhookUrl']+'\x20with\x20status\x20'+_0x8105a2[_0x20e6e1(0x6f)]+'\x20('+_0x1f37ee+_0x20e6e1(0xb3));}catch(_0x3d8392){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x3d8392);}}async[a8_0x285520(0xa4)](_0x3e12f4,_0x36f0a9){const _0x45d06a=a8_0x285520;try{const {telegramBotService:_0x2aa5a1}=await Promise[_0x45d06a(0xca)]()['then'](()=>__importStar(require(_0x45d06a(0xc9)))),_0x279967={'PAID':_0x45d06a(0x9a),'FAILED':_0x45d06a(0x75)},_0x144bf2=_0x279967[_0x36f0a9];if(!_0x144bf2)return;await _0x2aa5a1[_0x45d06a(0x79)](_0x3e12f4[_0x45d06a(0xd4)],_0x3e12f4,_0x144bf2);}catch(_0x44d3b2){console[_0x45d06a(0x8b)](_0x45d06a(0x81),_0x44d3b2);}}}exports[a8_0x285520(0x9c)]=PaymentController;