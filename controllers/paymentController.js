'use strict';const a8_0x18f394=a8_0x4d27;(function(_0x113d57,_0x5f3f62){const _0x2d3cf0=a8_0x4d27,_0x153278=_0x113d57();while(!![]){try{const _0x5f082b=-parseInt(_0x2d3cf0(0x1c8))/0x1+-parseInt(_0x2d3cf0(0x1de))/0x2+parseInt(_0x2d3cf0(0x1e9))/0x3*(-parseInt(_0x2d3cf0(0x1f2))/0x4)+-parseInt(_0x2d3cf0(0x1a9))/0x5*(parseInt(_0x2d3cf0(0x1c1))/0x6)+-parseInt(_0x2d3cf0(0x1a7))/0x7*(-parseInt(_0x2d3cf0(0x1e3))/0x8)+-parseInt(_0x2d3cf0(0x207))/0x9*(-parseInt(_0x2d3cf0(0x1cc))/0xa)+parseInt(_0x2d3cf0(0x1f6))/0xb*(parseInt(_0x2d3cf0(0x1bf))/0xc);if(_0x5f082b===_0x5f3f62)break;else _0x153278['push'](_0x153278['shift']());}catch(_0x23958f){_0x153278['push'](_0x153278['shift']());}}}(a8_0x56cf,0xd18c3));function a8_0x4d27(_0x20d46f,_0x180d85){const _0x56cf3c=a8_0x56cf();return a8_0x4d27=function(_0x4d27ce,_0x1295fe){_0x4d27ce=_0x4d27ce-0x1a0;let _0x3a820c=_0x56cf3c[_0x4d27ce];return _0x3a820c;},a8_0x4d27(_0x20d46f,_0x180d85);}var __createBinding=this&&this[a8_0x18f394(0x1ac)]||(Object[a8_0x18f394(0x1b4)]?function(_0x264676,_0x1c0f42,_0x3adc80,_0x36b684){const _0x46a0ec=a8_0x18f394;if(_0x36b684===undefined)_0x36b684=_0x3adc80;var _0x39518c=Object['getOwnPropertyDescriptor'](_0x1c0f42,_0x3adc80);(!_0x39518c||('get'in _0x39518c?!_0x1c0f42[_0x46a0ec(0x211)]:_0x39518c['writable']||_0x39518c['configurable']))&&(_0x39518c={'enumerable':!![],'get':function(){return _0x1c0f42[_0x3adc80];}}),Object[_0x46a0ec(0x1d8)](_0x264676,_0x36b684,_0x39518c);}:function(_0xd60e58,_0x67c78f,_0x10dc64,_0xfe4dd1){if(_0xfe4dd1===undefined)_0xfe4dd1=_0x10dc64;_0xd60e58[_0xfe4dd1]=_0x67c78f[_0x10dc64];}),__setModuleDefault=this&&this[a8_0x18f394(0x1f8)]||(Object[a8_0x18f394(0x1b4)]?function(_0x175d09,_0x588451){const _0x2c855d=a8_0x18f394;Object[_0x2c855d(0x1d8)](_0x175d09,'default',{'enumerable':!![],'value':_0x588451});}:function(_0x51013e,_0x16fa0e){const _0x4e1ccd=a8_0x18f394;_0x51013e[_0x4e1ccd(0x1d2)]=_0x16fa0e;}),__importStar=this&&this[a8_0x18f394(0x1ee)]||(function(){var _0x3a870d=function(_0x26c41b){return _0x3a870d=Object['getOwnPropertyNames']||function(_0x3155ca){const _0x2858ad=a8_0x4d27;var _0xc74534=[];for(var _0x4fc841 in _0x3155ca)if(Object[_0x2858ad(0x1e4)][_0x2858ad(0x1e5)][_0x2858ad(0x1e6)](_0x3155ca,_0x4fc841))_0xc74534[_0xc74534[_0x2858ad(0x1c5)]]=_0x4fc841;return _0xc74534;},_0x3a870d(_0x26c41b);};return function(_0x4fb933){const _0x305b04=a8_0x4d27;if(_0x4fb933&&_0x4fb933[_0x305b04(0x211)])return _0x4fb933;var _0x4e0228={};if(_0x4fb933!=null){for(var _0x552a7e=_0x3a870d(_0x4fb933),_0x2bdb0a=0x0;_0x2bdb0a<_0x552a7e[_0x305b04(0x1c5)];_0x2bdb0a++)if(_0x552a7e[_0x2bdb0a]!==_0x305b04(0x1d2))__createBinding(_0x4e0228,_0x4fb933,_0x552a7e[_0x2bdb0a]);}return __setModuleDefault(_0x4e0228,_0x4fb933),_0x4e0228;};}()),__importDefault=this&&this[a8_0x18f394(0x217)]||function(_0x2bf9bb){const _0x138515=a8_0x18f394;return _0x2bf9bb&&_0x2bf9bb[_0x138515(0x211)]?_0x2bf9bb:{'default':_0x2bf9bb};};Object[a8_0x18f394(0x1d8)](exports,a8_0x18f394(0x211),{'value':!![]}),exports[a8_0x18f394(0x1e0)]=void 0x0;function a8_0x56cf(){const _0xe5a82=['updatePaymentCustomer','processMasterCardPayment','create','sendPaymentNotification','threeds_url','amount','../config/database','error','body','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','📈\x20MasterCard\x20payment\x20','sendPaymentStatusNotification','Payment\x20created\x20successfully','6348VaevWL','💳\x20Card\x20holder:\x20','2028rZITBR','status','Webhook\x20event\x20','final','length','Card\x20payment\x20failed','customerUa','902383RuMaxw','settings','webhookUrl','toLowerCase','10Ikqxeh','gateway_payment_id','currency','webhookService','gatewayPaymentId','updatePaymentCustomerDataPublic','default','customerEmail','Failed\x20to\x20send\x20MasterCard\x20webhook:','customerIp','params','../services/webhookService','defineProperty','\x20\x20\x20Result\x20URL\x20(webhook):\x20','💳\x20MasterCard\x20URLs:','Payment\x20processed\x20successfully','Payment\x20not\x20found','update','2574810dUPEZn','Payment\x20failed','PaymentController','MasterCard\x20webhook\x20sent\x20to\x20','resolve','117424jzuUFi','prototype','hasOwnProperty','call','system','mastercard_','15pkHEuv','replace','FAILED','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','findUnique','__importStar','💳\x20Browser\x20IP:\x20','payment','https://api.trapay.uk/api/webhooks/gateway/mastercard','385444jONyVe','MasterCardService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','createdAt','66550JqAUfJ','orderId','__setModuleDefault','PaymentService','isArray','webhookLog','3DS\x20verification\x20required','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','getPaymentStatus','../services/paymentLinkService','📝\x20Customer\x20data:','webhookEvents','\x20\x20\x20Return\x20URL:\x20','updatedAt','masterCardService','shopId','2587644oojyxP','then','stringify','gateway','PAID','PENDING','../services/paymentService','application/json','paidAt','sendShopWebhook','__esModule','processCardPayment','\x20not\x20enabled\x20for\x20shop\x20','requires_3ds','first_name','includes','__importDefault','cardLast4','getPaymentById','last_name','paymentService','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','gatewayOrderId','\x20processed:\x20','number','log','shop','💳\x20MasterCard\x20result:','now','mastercard','609StnBUL','parse','18270nnpGrP','✅\x20MasterCard\x20payment\x20','POST','__createBinding','Customer\x20data\x20updated\x20successfully','email','user_agent','toISOString','json'];a8_0x56cf=function(){return _0xe5a82;};return a8_0x56cf();}const paymentService_1=require(a8_0x18f394(0x20d)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x18f394(0x1d7)),database_1=__importDefault(require(a8_0x18f394(0x1b8)));class PaymentController{constructor(){const _0x3d9bdc=a8_0x18f394;this['createPublicPayment']=async(_0x41b5bb,_0x17463b,_0x26e80b)=>{const _0x2cffd7=a8_0x4d27;try{const _0x12201a=_0x41b5bb[_0x2cffd7(0x1ba)],_0x110fff=await this['paymentService']['createPublicPayment'](_0x12201a);_0x17463b[_0x2cffd7(0x1c2)](0xc9)['json']({'success':!![],'message':_0x2cffd7(0x1be),'result':_0x110fff});}catch(_0x3fd1fd){_0x26e80b(_0x3fd1fd);}},this[_0x3d9bdc(0x1ff)]=async(_0x470fa9,_0x159e32,_0xbc9089)=>{const _0xf78427=_0x3d9bdc;try{const {id:_0x307ecd}=_0x470fa9[_0xf78427(0x1d6)],_0x53b090=await this['paymentService'][_0xf78427(0x1ff)](_0x307ecd);if(!_0x53b090)return _0x159e32[_0xf78427(0x1c2)](0x194)[_0xf78427(0x1b1)]({'success':![],'message':_0xf78427(0x1dc)});_0x159e32[_0xf78427(0x1b1)]({'success':!![],'result':_0x53b090});}catch(_0x3eafaf){_0xbc9089(_0x3eafaf);}},this['getPaymentById']=async(_0x11f269,_0x226d78,_0xacdd6d)=>{const _0x205121=_0x3d9bdc;try{const {id:_0x48c6bb}=_0x11f269['params'],_0x31c686=await this[_0x205121(0x21b)][_0x205121(0x219)](_0x48c6bb);if(!_0x31c686)return _0x226d78[_0x205121(0x1c2)](0x194)['json']({'success':![],'message':_0x205121(0x1dc)});_0x226d78[_0x205121(0x1b1)]({'success':!![],'result':_0x31c686});}catch(_0x561b6a){_0xacdd6d(_0x561b6a);}},this[_0x3d9bdc(0x1b2)]=async(_0x3f94c3,_0x48c2a6,_0xe69eb5)=>{const _0x5ccf93=_0x3d9bdc;try{const {id:_0x2ff04f}=_0x3f94c3[_0x5ccf93(0x1d6)],_0x566f9e=_0x3f94c3[_0x5ccf93(0x1ba)];console['log']('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x2ff04f),console[_0x5ccf93(0x1a2)](_0x5ccf93(0x201),_0x566f9e);const _0x5bf9d8=await this[_0x5ccf93(0x21b)][_0x5ccf93(0x1d1)](_0x2ff04f,_0x566f9e);if(!_0x5bf9d8)return _0x48c2a6['status'](0x194)[_0x5ccf93(0x1b1)]({'success':![],'message':'Payment\x20not\x20found'});_0x48c2a6[_0x5ccf93(0x1b1)]({'success':!![],'message':_0x5ccf93(0x1ad),'result':{'paymentId':_0x5bf9d8['id'],'customerIp':_0x5bf9d8[_0x5ccf93(0x1d5)],'customerUa':_0x5bf9d8[_0x5ccf93(0x1c7)],'customerCountry':_0x5bf9d8['customerCountry'],'updatedAt':_0x5bf9d8[_0x5ccf93(0x204)]}});}catch(_0x289e46){_0xe69eb5(_0x289e46);}},this[_0x3d9bdc(0x1b3)]=async(_0x181dba,_0x5e6110,_0x4fb7fb)=>{const _0x481e5c=_0x3d9bdc;try{const {id:_0x2a3dfb}=_0x181dba[_0x481e5c(0x1d6)],{cardData:_0x1f404d,cardHolder:_0x59681f,browser:_0x20483d}=_0x181dba[_0x481e5c(0x1ba)];console[_0x481e5c(0x1a2)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x2a3dfb),console[_0x481e5c(0x1a2)](_0x481e5c(0x1c0)+_0x59681f[_0x481e5c(0x215)]+'\x20'+_0x59681f['last_name']+'\x20('+_0x59681f[_0x481e5c(0x1ae)]+')'),console['log'](_0x481e5c(0x1ef)+_0x20483d['ip']);const _0x391116={'customerName':_0x59681f[_0x481e5c(0x215)]+'\x20'+_0x59681f[_0x481e5c(0x21a)],'customerEmail':_0x59681f[_0x481e5c(0x1ae)],'customerIp':_0x20483d['ip'],'customerUa':_0x20483d[_0x481e5c(0x1af)]},_0x3a6005=await database_1[_0x481e5c(0x1d2)][_0x481e5c(0x1f0)][_0x481e5c(0x1ed)]({'where':{'id':_0x2a3dfb},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3a6005)return _0x5e6110[_0x481e5c(0x1c2)](0x194)['json']({'success':![],'message':_0x481e5c(0x1dc)});if(_0x3a6005[_0x481e5c(0x20a)]!==_0x481e5c(0x1a6))return _0x5e6110[_0x481e5c(0x1c2)](0x190)['json']({'success':![],'message':_0x481e5c(0x1f4)});if(_0x3a6005['status']!=='PENDING')return _0x5e6110[_0x481e5c(0x1c2)](0x190)[_0x481e5c(0x1b1)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3a6005['status']+',\x20cannot\x20process'});await database_1[_0x481e5c(0x1d2)][_0x481e5c(0x1f0)][_0x481e5c(0x1dd)]({'where':{'id':_0x2a3dfb},'data':{..._0x391116,'updatedAt':new Date()}});const _0x481c6d=_0x481e5c(0x1f1),_0xfaed7c=_0x3a6005['successUrl'];console['log'](_0x481e5c(0x1da)),console['log'](_0x481e5c(0x1d9)+_0x481c6d),console['log'](_0x481e5c(0x203)+_0xfaed7c);const _0x14232a={'first_name':_0x59681f[_0x481e5c(0x215)],'last_name':_0x59681f['last_name'],'email':_0x59681f[_0x481e5c(0x1ae)]},_0x40662e=await this[_0x481e5c(0x205)][_0x481e5c(0x212)]({'paymentId':_0x3a6005['id'],'orderId':_0x3a6005[_0x481e5c(0x21d)]||_0x3a6005['id'],'amount':_0x3a6005[_0x481e5c(0x1b7)],'currency':_0x3a6005[_0x481e5c(0x1ce)],'cardData':_0x1f404d,'resultUrl':_0x481c6d,'returnUrl':_0xfaed7c,'cardHolder':_0x14232a,'browser':_0x20483d});console[_0x481e5c(0x1a2)](_0x481e5c(0x1a4),_0x40662e);const _0x1210a0={'status':_0x40662e['status'],'updatedAt':new Date(),'statusChangedBy':_0x481e5c(0x1e7),'statusChangedAt':new Date()};_0x40662e[_0x481e5c(0x1cd)]&&(_0x1210a0[_0x481e5c(0x1d0)]=_0x40662e['gateway_payment_id'],console['log'](_0x481e5c(0x1ec)+_0x40662e[_0x481e5c(0x1cd)]));if(_0x40662e['status']===_0x481e5c(0x20b))_0x1210a0[_0x481e5c(0x20f)]=new Date();else _0x40662e[_0x481e5c(0x1c2)]===_0x481e5c(0x1eb)&&(_0x1210a0['failureMessage']=_0x481e5c(0x1c6));_0x1210a0['paymentMethod']=_0x481e5c(0x1a6);if(_0x1f404d[_0x481e5c(0x1a1)]){const _0x55b5d8=_0x1f404d[_0x481e5c(0x1a1)][_0x481e5c(0x1ea)](/[\s-]/g,'');_0x1210a0[_0x481e5c(0x218)]=_0x55b5d8['slice'](-0x4),console[_0x481e5c(0x1a2)](_0x481e5c(0x1fd)+_0x1210a0['cardLast4']);}await database_1['default'][_0x481e5c(0x1f0)]['update']({'where':{'id':_0x3a6005['id']},'data':_0x1210a0}),await database_1['default'][_0x481e5c(0x1fb)][_0x481e5c(0x1b4)]({'data':{'paymentId':_0x3a6005['id'],'shopId':_0x3a6005[_0x481e5c(0x206)],'event':_0x481e5c(0x1e8)+_0x40662e[_0x481e5c(0x1c2)]?.[_0x481e5c(0x1cb)](),'statusCode':0xc8,'responseBody':JSON[_0x481e5c(0x209)]({'oldStatus':_0x481e5c(0x20c),'newStatus':_0x40662e['status'],'gatewayPaymentId':_0x40662e['gateway_payment_id'],'requires3ds':_0x40662e[_0x481e5c(0x214)],'processedAt':new Date()[_0x481e5c(0x1b0)]()})}});if(_0x40662e[_0x481e5c(0x1c4)]){await this[_0x481e5c(0x210)](_0x3a6005,_0x40662e[_0x481e5c(0x1c2)],_0x40662e[_0x481e5c(0x1cd)]),await this[_0x481e5c(0x1bd)](_0x3a6005,_0x40662e[_0x481e5c(0x1c2)]);if(_0x40662e[_0x481e5c(0x1c2)]===_0x481e5c(0x20b)){console['log'](_0x481e5c(0x1bc)+_0x2a3dfb+_0x481e5c(0x1fe));try{const {PaymentLinkService:_0x4079d9}=await Promise[_0x481e5c(0x1e2)]()[_0x481e5c(0x208)](()=>__importStar(require(_0x481e5c(0x200)))),_0x48f4a8=new _0x4079d9();await _0x48f4a8['handleSuccessfulPayment'](_0x2a3dfb),console[_0x481e5c(0x1a2)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x2a3dfb);}catch(_0x5e13dd){console[_0x481e5c(0x1b9)](_0x481e5c(0x21c),_0x5e13dd);}}}console[_0x481e5c(0x1a2)](_0x481e5c(0x1aa)+_0x2a3dfb+_0x481e5c(0x1a0)+_0x40662e['status']);if(_0x40662e['status']===_0x481e5c(0x20b))_0x5e6110[_0x481e5c(0x1b1)]({'success':!![],'message':_0x481e5c(0x1db),'result':{'status':'PAID','gatewayPaymentId':_0x40662e[_0x481e5c(0x1cd)],'redirectUrl':_0xfaed7c,'final':!![]}});else _0x40662e['requires_3ds']&&_0x40662e[_0x481e5c(0x1b6)]?_0x5e6110[_0x481e5c(0x1b1)]({'success':!![],'message':_0x481e5c(0x1fc),'result':{'status':'PENDING','gatewayPaymentId':_0x40662e['gateway_payment_id'],'redirectUrl':_0x40662e['threeds_url'],'requires3ds':!![],'final':![]}}):_0x5e6110[_0x481e5c(0x1c2)](0x190)['json']({'success':![],'message':_0x481e5c(0x1df),'result':{'status':_0x481e5c(0x1eb),'gatewayPaymentId':_0x40662e[_0x481e5c(0x1cd)],'redirectUrl':_0x3a6005['failUrl'],'final':!![]}});}catch(_0x920709){_0x4fb7fb(_0x920709);}},this[_0x3d9bdc(0x21b)]=new paymentService_1[(_0x3d9bdc(0x1f9))](),this[_0x3d9bdc(0x205)]=new mastercardService_1[(_0x3d9bdc(0x1f3))](),this[_0x3d9bdc(0x1cf)]=new webhookService_1['WebhookService']();}async[a8_0x18f394(0x210)](_0x308649,_0x1fb820,_0x269e1a){const _0x54aac6=a8_0x18f394,_0x20941a=Date[_0x54aac6(0x1a5)]();try{const _0x5c39b9=_0x308649[_0x54aac6(0x1a3)],_0x13dc56=_0x5c39b9[_0x54aac6(0x1c9)];if(!_0x13dc56?.[_0x54aac6(0x1ca)]){console[_0x54aac6(0x1a2)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x5c39b9['id']);return;}const _0x1672e5=_0x1fb820===_0x54aac6(0x20b)?'payment.success':'payment.failed';let _0x115645=[];if(_0x13dc56['webhookEvents'])try{_0x115645=Array[_0x54aac6(0x1fa)](_0x13dc56['webhookEvents'])?_0x13dc56[_0x54aac6(0x202)]:JSON[_0x54aac6(0x1a8)](_0x13dc56[_0x54aac6(0x202)]);}catch(_0x5d1c27){console['error']('Error\x20parsing\x20webhook\x20events:',_0x5d1c27),_0x115645=[];}if(!_0x115645[_0x54aac6(0x216)](_0x1672e5)){console[_0x54aac6(0x1a2)](_0x54aac6(0x1c3)+_0x1672e5+_0x54aac6(0x213)+_0x5c39b9['id']);return;}const _0x2edb0f={'event':_0x1672e5,'payment':{'id':_0x308649['id'],'order_id':_0x308649[_0x54aac6(0x1f7)],'gateway_order_id':_0x308649[_0x54aac6(0x21d)],'gateway':'1111','amount':_0x308649['amount'],'currency':_0x308649[_0x54aac6(0x1ce)],'status':_0x1fb820[_0x54aac6(0x1cb)](),'customer_email':_0x308649[_0x54aac6(0x1d3)],'customer_name':_0x308649['customerName'],'gateway_payment_id':_0x269e1a,'created_at':_0x308649[_0x54aac6(0x1f5)],'updated_at':new Date()}},_0x1196b2=await fetch(_0x13dc56['webhookUrl'],{'method':_0x54aac6(0x1ab),'headers':{'Content-Type':_0x54aac6(0x20e),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x54aac6(0x209)](_0x2edb0f)}),_0x153ed4=Date[_0x54aac6(0x1a5)]()-_0x20941a;console[_0x54aac6(0x1a2)](_0x54aac6(0x1e1)+_0x13dc56[_0x54aac6(0x1ca)]+'\x20with\x20status\x20'+_0x1196b2['status']+'\x20('+_0x153ed4+'ms)');}catch(_0x31a180){console[_0x54aac6(0x1b9)](_0x54aac6(0x1d4),_0x31a180);}}async['sendPaymentStatusNotification'](_0x3654c7,_0x497056){const _0x4a717e=a8_0x18f394;try{const {telegramBotService:_0x36d97d}=await Promise[_0x4a717e(0x1e2)]()[_0x4a717e(0x208)](()=>__importStar(require('../services/telegramBotService'))),_0x30fe8b={'PAID':'paid','FAILED':'failed'},_0x388470=_0x30fe8b[_0x497056];if(!_0x388470)return;await _0x36d97d[_0x4a717e(0x1b5)](_0x3654c7[_0x4a717e(0x206)],_0x3654c7,_0x388470);}catch(_0x552812){console[_0x4a717e(0x1b9)](_0x4a717e(0x1bb),_0x552812);}}}exports[a8_0x18f394(0x1e0)]=PaymentController;