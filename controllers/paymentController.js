'use strict';const a8_0x2b43ab=a8_0x28b9;function a8_0x1909(){const _0x123ba5=['updatePaymentCustomerDataPublic','settings','\x20\x20\x20Result\x20URL\x20(webhook):\x20','mastercard_','POST','paidAt','__esModule','üí≥\x20Browser\x20IP:\x20','params','üí≥\x20Card\x20holder:\x20','includes','Payment\x20not\x20found','customerCountry','webhookEvents','createPublicPayment','getPaymentById','paymentService','hasOwnProperty','FAILED','toLowerCase','PENDING','final','../config/database','Failed\x20to\x20send\x20MasterCard\x20webhook:','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','updatedAt','\x20\x20\x20Return\x20URL:\x20','number','requires_3ds','cardLast4','json','threeds_url','https://api.trapay.uk/api/webhooks/gateway/mastercard','../services/gateways/mastercardService','length','Customer\x20data\x20updated\x20successfully','amount','webhookLog','resolve','108ahbrnd','currency','configurable','Card\x20payment\x20failed','PaymentService','shopId','PaymentController','toISOString','customerIp','getOwnPropertyDescriptor','31106470ArVTQz','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','error','createdAt','isArray','slice','sendPaymentStatusNotification','failureMessage','then','customerEmail','‚úÖ\x20MasterCard\x20payment\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','processMasterCardPayment','findUnique','gateway_payment_id','1111','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****',',\x20cannot\x20process','3798263TabyVC','29780fIdics','622091nKJiyA','failUrl','9735786GHOOYX','update','now','6716490hxVTrV','status','default','user_agent','webhookUrl','MasterCard\x20webhook\x20sent\x20to\x20','11pAXfyf','../services/paymentLinkService','last_name','__createBinding','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','364oJRuKL','get','Payment\x20processed\x20successfully','replace','orderId','mastercard','email','payment','Webhook\x20event\x20','handleSuccessfulPayment','first_name','üìù\x20Customer\x20data:','system','PAID','masterCardService','8VTciEf','WebhookService','../services/telegramBotService','üìà\x20MasterCard\x20payment\x20','defineProperty','sendShopWebhook','ms)','shop','webhookService','failed','successUrl','Payment\x20status\x20is\x20','sendPaymentNotification','stringify','log','payment.failed','body','create','\x20processed:\x20','\x20not\x20enabled\x20for\x20shop\x20','customerName','Payment\x20created\x20successfully','Error\x20parsing\x20webhook\x20events:','40325JFadiH'];a8_0x1909=function(){return _0x123ba5;};return a8_0x1909();}(function(_0x42c1e1,_0x3f639f){const _0x557d65=a8_0x28b9,_0x3a18cc=_0x42c1e1();while(!![]){try{const _0x30fe3e=-parseInt(_0x557d65(0x1d7))/0x1+parseInt(_0x557d65(0x1d6))/0x2*(-parseInt(_0x557d65(0x1b8))/0x3)+parseInt(_0x557d65(0x1e7))/0x4*(-parseInt(_0x557d65(0x20d))/0x5)+-parseInt(_0x557d65(0x1dc))/0x6+-parseInt(_0x557d65(0x1d5))/0x7*(parseInt(_0x557d65(0x1f6))/0x8)+parseInt(_0x557d65(0x1d9))/0x9+-parseInt(_0x557d65(0x1c2))/0xa*(-parseInt(_0x557d65(0x1e2))/0xb);if(_0x30fe3e===_0x3f639f)break;else _0x3a18cc['push'](_0x3a18cc['shift']());}catch(_0x26f43c){_0x3a18cc['push'](_0x3a18cc['shift']());}}}(a8_0x1909,0x9bd7b));var __createBinding=this&&this[a8_0x2b43ab(0x1e5)]||(Object['create']?function(_0x4b821b,_0x32af4d,_0x1612b3,_0x123084){const _0x2e2c0a=a8_0x2b43ab;if(_0x123084===undefined)_0x123084=_0x1612b3;var _0x3c3642=Object[_0x2e2c0a(0x1c1)](_0x32af4d,_0x1612b3);(!_0x3c3642||(_0x2e2c0a(0x1e8)in _0x3c3642?!_0x32af4d[_0x2e2c0a(0x214)]:_0x3c3642['writable']||_0x3c3642[_0x2e2c0a(0x1ba)]))&&(_0x3c3642={'enumerable':!![],'get':function(){return _0x32af4d[_0x1612b3];}}),Object['defineProperty'](_0x4b821b,_0x123084,_0x3c3642);}:function(_0x4ed7f6,_0x286538,_0x461803,_0x7d67cf){if(_0x7d67cf===undefined)_0x7d67cf=_0x461803;_0x4ed7f6[_0x7d67cf]=_0x286538[_0x461803];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x2b43ab(0x207)]?function(_0x120b93,_0x6af593){const _0x4eaed7=a8_0x2b43ab;Object[_0x4eaed7(0x1fa)](_0x120b93,_0x4eaed7(0x1de),{'enumerable':!![],'value':_0x6af593});}:function(_0x29adb8,_0x2877da){const _0x81344=a8_0x2b43ab;_0x29adb8[_0x81344(0x1de)]=_0x2877da;}),__importStar=this&&this['__importStar']||(function(){var _0x5a0c0f=function(_0xe32fa3){return _0x5a0c0f=Object['getOwnPropertyNames']||function(_0x3e4ff1){const _0x338b18=a8_0x28b9;var _0x250a89=[];for(var _0x334225 in _0x3e4ff1)if(Object['prototype'][_0x338b18(0x21f)]['call'](_0x3e4ff1,_0x334225))_0x250a89[_0x250a89[_0x338b18(0x1b3)]]=_0x334225;return _0x250a89;},_0x5a0c0f(_0xe32fa3);};return function(_0x55b40a){const _0x244e9e=a8_0x28b9;if(_0x55b40a&&_0x55b40a['__esModule'])return _0x55b40a;var _0x589bb9={};if(_0x55b40a!=null){for(var _0x533ae0=_0x5a0c0f(_0x55b40a),_0x3cf01c=0x0;_0x3cf01c<_0x533ae0[_0x244e9e(0x1b3)];_0x3cf01c++)if(_0x533ae0[_0x3cf01c]!==_0x244e9e(0x1de))__createBinding(_0x589bb9,_0x55b40a,_0x533ae0[_0x3cf01c]);}return __setModuleDefault(_0x589bb9,_0x55b40a),_0x589bb9;};}()),__importDefault=this&&this['__importDefault']||function(_0x71c0a9){const _0x1f034c=a8_0x2b43ab;return _0x71c0a9&&_0x71c0a9[_0x1f034c(0x214)]?_0x71c0a9:{'default':_0x71c0a9};};Object[a8_0x2b43ab(0x1fa)](exports,a8_0x2b43ab(0x214),{'value':!![]}),exports[a8_0x2b43ab(0x1be)]=void 0x0;function a8_0x28b9(_0x397882,_0x12ceb2){const _0x1909b5=a8_0x1909();return a8_0x28b9=function(_0x28b9f0,_0x2b9b6c){_0x28b9f0=_0x28b9f0-0x1a9;let _0x51ca3b=_0x1909b5[_0x28b9f0];return _0x51ca3b;},a8_0x28b9(_0x397882,_0x12ceb2);}const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x2b43ab(0x1b2)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x2b43ab(0x224)));class PaymentController{constructor(){const _0x3f211c=a8_0x2b43ab;this[_0x3f211c(0x21c)]=async(_0x2e1ba1,_0x5f3700,_0x558b95)=>{const _0x438a39=_0x3f211c;try{const _0x422bfc=_0x2e1ba1[_0x438a39(0x206)],_0x520cf3=await this[_0x438a39(0x21e)][_0x438a39(0x21c)](_0x422bfc);_0x5f3700[_0x438a39(0x1dd)](0xc9)[_0x438a39(0x1af)]({'success':!![],'message':_0x438a39(0x20b),'result':_0x520cf3});}catch(_0x3c0602){_0x558b95(_0x3c0602);}},this['getPaymentStatus']=async(_0x15f6ba,_0x57fed6,_0x48d9ca)=>{const _0x1b6547=_0x3f211c;try{const {id:_0x11c6f8}=_0x15f6ba[_0x1b6547(0x216)],_0x70f392=await this[_0x1b6547(0x21e)]['getPaymentStatus'](_0x11c6f8);if(!_0x70f392)return _0x57fed6['status'](0x194)[_0x1b6547(0x1af)]({'success':![],'message':_0x1b6547(0x219)});_0x57fed6[_0x1b6547(0x1af)]({'success':!![],'result':_0x70f392});}catch(_0x1a3de0){_0x48d9ca(_0x1a3de0);}},this[_0x3f211c(0x21d)]=async(_0x4c9282,_0x6c4584,_0x17dabf)=>{const _0x47efa4=_0x3f211c;try{const {id:_0x22651a}=_0x4c9282[_0x47efa4(0x216)],_0x33c6e5=await this['paymentService'][_0x47efa4(0x21d)](_0x22651a);if(!_0x33c6e5)return _0x6c4584['status'](0x194)[_0x47efa4(0x1af)]({'success':![],'message':_0x47efa4(0x219)});_0x6c4584[_0x47efa4(0x1af)]({'success':!![],'result':_0x33c6e5});}catch(_0x1b7082){_0x17dabf(_0x1b7082);}},this['updatePaymentCustomer']=async(_0x532348,_0x46c5e7,_0x497f06)=>{const _0x2a0079=_0x3f211c;try{const {id:_0x4ebf7a}=_0x532348[_0x2a0079(0x216)],_0x2a1f51=_0x532348['body'];console[_0x2a0079(0x204)](_0x2a0079(0x1a9)+_0x4ebf7a),console['log'](_0x2a0079(0x1f2),_0x2a1f51);const _0x1976e3=await this[_0x2a0079(0x21e)][_0x2a0079(0x20e)](_0x4ebf7a,_0x2a1f51);if(!_0x1976e3)return _0x46c5e7[_0x2a0079(0x1dd)](0x194)[_0x2a0079(0x1af)]({'success':![],'message':_0x2a0079(0x219)});_0x46c5e7[_0x2a0079(0x1af)]({'success':!![],'message':_0x2a0079(0x1b4),'result':{'paymentId':_0x1976e3['id'],'customerIp':_0x1976e3[_0x2a0079(0x1c0)],'customerUa':_0x1976e3['customerUa'],'customerCountry':_0x1976e3[_0x2a0079(0x21a)],'updatedAt':_0x1976e3[_0x2a0079(0x1aa)]}});}catch(_0x1b2294){_0x497f06(_0x1b2294);}},this[_0x3f211c(0x1ce)]=async(_0x3a2221,_0x1a0344,_0x4361ca)=>{const _0x20e531=_0x3f211c;try{const {id:_0x1d4792}=_0x3a2221[_0x20e531(0x216)],{cardData:_0x432dba,cardHolder:_0xde4de2,browser:_0x3217b5}=_0x3a2221[_0x20e531(0x206)];console['log']('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x1d4792),console[_0x20e531(0x204)](_0x20e531(0x217)+_0xde4de2[_0x20e531(0x1f1)]+'\x20'+_0xde4de2[_0x20e531(0x1e4)]+'\x20('+_0xde4de2[_0x20e531(0x1ed)]+')'),console['log'](_0x20e531(0x215)+_0x3217b5['ip']);const _0x162c03={'customerName':_0xde4de2['first_name']+'\x20'+_0xde4de2['last_name'],'customerEmail':_0xde4de2['email'],'customerIp':_0x3217b5['ip'],'customerUa':_0x3217b5[_0x20e531(0x1df)]},_0x4f242a=await database_1[_0x20e531(0x1de)][_0x20e531(0x1ee)][_0x20e531(0x1cf)]({'where':{'id':_0x1d4792},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4f242a)return _0x1a0344['status'](0x194)['json']({'success':![],'message':_0x20e531(0x219)});if(_0x4f242a['gateway']!==_0x20e531(0x1ec))return _0x1a0344['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x4f242a[_0x20e531(0x1dd)]!=='PENDING')return _0x1a0344[_0x20e531(0x1dd)](0x190)[_0x20e531(0x1af)]({'success':![],'message':_0x20e531(0x201)+_0x4f242a[_0x20e531(0x1dd)]+_0x20e531(0x1d4)});await database_1[_0x20e531(0x1de)][_0x20e531(0x1ee)][_0x20e531(0x1da)]({'where':{'id':_0x1d4792},'data':{..._0x162c03,'updatedAt':new Date()}});const _0x1d7fba=_0x20e531(0x1b1),_0x25b432=_0x4f242a[_0x20e531(0x200)];console['log']('üí≥\x20MasterCard\x20URLs:'),console[_0x20e531(0x204)](_0x20e531(0x210)+_0x1d7fba),console[_0x20e531(0x204)](_0x20e531(0x1ab)+_0x25b432);const _0xecc928={'first_name':_0xde4de2[_0x20e531(0x1f1)],'last_name':_0xde4de2[_0x20e531(0x1e4)],'email':_0xde4de2[_0x20e531(0x1ed)]},_0x38714b=await this[_0x20e531(0x1f5)]['processCardPayment']({'paymentId':_0x4f242a['id'],'orderId':_0x4f242a['gatewayOrderId']||_0x4f242a['id'],'amount':_0x4f242a[_0x20e531(0x1b5)],'currency':_0x4f242a[_0x20e531(0x1b9)],'cardData':_0x432dba,'resultUrl':_0x1d7fba,'returnUrl':_0x25b432,'cardHolder':_0xecc928,'browser':_0x3217b5});console[_0x20e531(0x204)]('üí≥\x20MasterCard\x20result:',_0x38714b);const _0x1de87d={'status':_0x38714b[_0x20e531(0x1dd)],'updatedAt':new Date(),'statusChangedBy':_0x20e531(0x1f3),'statusChangedAt':new Date()};_0x38714b['gateway_payment_id']&&(_0x1de87d['gatewayPaymentId']=_0x38714b[_0x20e531(0x1d0)],console[_0x20e531(0x204)]('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x38714b[_0x20e531(0x1d0)]));if(_0x38714b[_0x20e531(0x1dd)]==='PAID')_0x1de87d[_0x20e531(0x213)]=new Date();else _0x38714b[_0x20e531(0x1dd)]===_0x20e531(0x220)&&(_0x1de87d[_0x20e531(0x1c9)]=_0x20e531(0x1bb));_0x1de87d['paymentMethod']=_0x20e531(0x1ec);if(_0x432dba[_0x20e531(0x1ac)]){const _0x381428=_0x432dba[_0x20e531(0x1ac)][_0x20e531(0x1ea)](/[\s-]/g,'');_0x1de87d[_0x20e531(0x1ae)]=_0x381428[_0x20e531(0x1c7)](-0x4),console['log'](_0x20e531(0x1d3)+_0x1de87d['cardLast4']);}await database_1[_0x20e531(0x1de)][_0x20e531(0x1ee)][_0x20e531(0x1da)]({'where':{'id':_0x4f242a['id']},'data':_0x1de87d}),await database_1[_0x20e531(0x1de)][_0x20e531(0x1b6)][_0x20e531(0x207)]({'data':{'paymentId':_0x4f242a['id'],'shopId':_0x4f242a[_0x20e531(0x1bd)],'event':_0x20e531(0x211)+_0x38714b['status']?.[_0x20e531(0x221)](),'statusCode':0xc8,'responseBody':JSON[_0x20e531(0x203)]({'oldStatus':_0x20e531(0x222),'newStatus':_0x38714b[_0x20e531(0x1dd)],'gatewayPaymentId':_0x38714b['gateway_payment_id'],'requires3ds':_0x38714b['requires_3ds'],'processedAt':new Date()[_0x20e531(0x1bf)]()})}});if(_0x38714b[_0x20e531(0x223)]){await this[_0x20e531(0x1fb)](_0x4f242a,_0x38714b['status'],_0x38714b[_0x20e531(0x1d0)]),await this[_0x20e531(0x1c8)](_0x4f242a,_0x38714b[_0x20e531(0x1dd)]);if(_0x38714b[_0x20e531(0x1dd)]===_0x20e531(0x1f4)){console[_0x20e531(0x204)](_0x20e531(0x1f9)+_0x1d4792+_0x20e531(0x1cd));try{const {PaymentLinkService:_0x283f98}=await Promise['resolve']()[_0x20e531(0x1ca)](()=>__importStar(require(_0x20e531(0x1e3)))),_0x9442d5=new _0x283f98();await _0x9442d5[_0x20e531(0x1f0)](_0x1d4792),console[_0x20e531(0x204)](_0x20e531(0x1c3)+_0x1d4792);}catch(_0x2e7f3a){console['error']('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x2e7f3a);}}}console[_0x20e531(0x204)](_0x20e531(0x1cc)+_0x1d4792+_0x20e531(0x208)+_0x38714b[_0x20e531(0x1dd)]);if(_0x38714b[_0x20e531(0x1dd)]==='PAID')_0x1a0344[_0x20e531(0x1af)]({'success':!![],'message':_0x20e531(0x1e9),'result':{'status':'PAID','gatewayPaymentId':_0x38714b['gateway_payment_id'],'redirectUrl':_0x25b432,'final':!![]}});else _0x38714b[_0x20e531(0x1ad)]&&_0x38714b[_0x20e531(0x1b0)]?_0x1a0344['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x38714b[_0x20e531(0x1d0)],'redirectUrl':_0x38714b[_0x20e531(0x1b0)],'requires3ds':!![],'final':![]}}):_0x1a0344[_0x20e531(0x1dd)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x20e531(0x220),'gatewayPaymentId':_0x38714b[_0x20e531(0x1d0)],'redirectUrl':_0x4f242a[_0x20e531(0x1d8)],'final':!![]}});}catch(_0x40ef27){_0x4361ca(_0x40ef27);}},this[_0x3f211c(0x21e)]=new paymentService_1[(_0x3f211c(0x1bc))](),this[_0x3f211c(0x1f5)]=new mastercardService_1['MasterCardService'](),this[_0x3f211c(0x1fe)]=new webhookService_1[(_0x3f211c(0x1f7))]();}async[a8_0x2b43ab(0x1fb)](_0x4a6ad7,_0x202a02,_0x13a73f){const _0xb203f0=a8_0x2b43ab,_0x5e8990=Date[_0xb203f0(0x1db)]();try{const _0x22bb00=_0x4a6ad7[_0xb203f0(0x1fd)],_0x1ded98=_0x22bb00[_0xb203f0(0x20f)];if(!_0x1ded98?.[_0xb203f0(0x1e0)]){console[_0xb203f0(0x204)](_0xb203f0(0x1d2)+_0x22bb00['id']);return;}const _0x487496=_0x202a02===_0xb203f0(0x1f4)?'payment.success':_0xb203f0(0x205);let _0x5d73d1=[];if(_0x1ded98[_0xb203f0(0x21b)])try{_0x5d73d1=Array[_0xb203f0(0x1c6)](_0x1ded98[_0xb203f0(0x21b)])?_0x1ded98[_0xb203f0(0x21b)]:JSON['parse'](_0x1ded98[_0xb203f0(0x21b)]);}catch(_0x5b341f){console[_0xb203f0(0x1c4)](_0xb203f0(0x20c),_0x5b341f),_0x5d73d1=[];}if(!_0x5d73d1[_0xb203f0(0x218)](_0x487496)){console[_0xb203f0(0x204)](_0xb203f0(0x1ef)+_0x487496+_0xb203f0(0x209)+_0x22bb00['id']);return;}const _0x1eeeca={'event':_0x487496,'payment':{'id':_0x4a6ad7['id'],'order_id':_0x4a6ad7[_0xb203f0(0x1eb)],'gateway_order_id':_0x4a6ad7['gatewayOrderId'],'gateway':_0xb203f0(0x1d1),'amount':_0x4a6ad7[_0xb203f0(0x1b5)],'currency':_0x4a6ad7[_0xb203f0(0x1b9)],'status':_0x202a02[_0xb203f0(0x221)](),'customer_email':_0x4a6ad7[_0xb203f0(0x1cb)],'customer_name':_0x4a6ad7[_0xb203f0(0x20a)],'gateway_payment_id':_0x13a73f,'created_at':_0x4a6ad7[_0xb203f0(0x1c5)],'updated_at':new Date()}},_0x37495a=await fetch(_0x1ded98[_0xb203f0(0x1e0)],{'method':_0xb203f0(0x212),'headers':{'Content-Type':'application/json','User-Agent':_0xb203f0(0x1e6)},'body':JSON['stringify'](_0x1eeeca)}),_0x30c8a2=Date['now']()-_0x5e8990;console['log'](_0xb203f0(0x1e1)+_0x1ded98[_0xb203f0(0x1e0)]+'\x20with\x20status\x20'+_0x37495a['status']+'\x20('+_0x30c8a2+_0xb203f0(0x1fc));}catch(_0x49cce8){console[_0xb203f0(0x1c4)](_0xb203f0(0x225),_0x49cce8);}}async[a8_0x2b43ab(0x1c8)](_0x110a98,_0x2d6e9a){const _0x4b1c47=a8_0x2b43ab;try{const {telegramBotService:_0x53707a}=await Promise[_0x4b1c47(0x1b7)]()[_0x4b1c47(0x1ca)](()=>__importStar(require(_0x4b1c47(0x1f8)))),_0x3da64d={'PAID':'paid','FAILED':_0x4b1c47(0x1ff)},_0x1dd52d=_0x3da64d[_0x2d6e9a];if(!_0x1dd52d)return;await _0x53707a[_0x4b1c47(0x202)](_0x110a98[_0x4b1c47(0x1bd)],_0x110a98,_0x1dd52d);}catch(_0x97c676){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x97c676);}}}exports[a8_0x2b43ab(0x1be)]=PaymentController;