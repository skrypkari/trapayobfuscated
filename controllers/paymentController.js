'use strict';const a8_0x4ee733=a8_0x1aae;(function(_0x1f7888,_0x23dc89){const _0x5a1ac0=a8_0x1aae,_0x2250fd=_0x1f7888();while(!![]){try{const _0x482109=parseInt(_0x5a1ac0(0x13e))/0x1*(-parseInt(_0x5a1ac0(0x172))/0x2)+parseInt(_0x5a1ac0(0x18a))/0x3*(-parseInt(_0x5a1ac0(0x1ad))/0x4)+-parseInt(_0x5a1ac0(0x1a3))/0x5+parseInt(_0x5a1ac0(0x191))/0x6*(parseInt(_0x5a1ac0(0x1a0))/0x7)+-parseInt(_0x5a1ac0(0x17b))/0x8+parseInt(_0x5a1ac0(0x141))/0x9*(parseInt(_0x5a1ac0(0x14a))/0xa)+-parseInt(_0x5a1ac0(0x19f))/0xb*(-parseInt(_0x5a1ac0(0x1a9))/0xc);if(_0x482109===_0x23dc89)break;else _0x2250fd['push'](_0x2250fd['shift']());}catch(_0x15a131){_0x2250fd['push'](_0x2250fd['shift']());}}}(a8_0x29e2,0x76bb0));var __createBinding=this&&this[a8_0x4ee733(0x1a2)]||(Object[a8_0x4ee733(0x16a)]?function(_0x30fae9,_0x49c4d3,_0x3d45bd,_0x2d4a9a){const _0x54bd35=a8_0x4ee733;if(_0x2d4a9a===undefined)_0x2d4a9a=_0x3d45bd;var _0x2b58a3=Object[_0x54bd35(0x180)](_0x49c4d3,_0x3d45bd);(!_0x2b58a3||(_0x54bd35(0x19b)in _0x2b58a3?!_0x49c4d3['__esModule']:_0x2b58a3[_0x54bd35(0x143)]||_0x2b58a3['configurable']))&&(_0x2b58a3={'enumerable':!![],'get':function(){return _0x49c4d3[_0x3d45bd];}}),Object[_0x54bd35(0x19a)](_0x30fae9,_0x2d4a9a,_0x2b58a3);}:function(_0xa87ba3,_0x4cb739,_0x2832c2,_0x49d83a){if(_0x49d83a===undefined)_0x49d83a=_0x2832c2;_0xa87ba3[_0x49d83a]=_0x4cb739[_0x2832c2];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x4ee733(0x16a)]?function(_0x152f57,_0x207c21){const _0xc06d23=a8_0x4ee733;Object[_0xc06d23(0x19a)](_0x152f57,_0xc06d23(0x146),{'enumerable':!![],'value':_0x207c21});}:function(_0x2b1f5b,_0x77cf64){const _0x14b6c5=a8_0x4ee733;_0x2b1f5b[_0x14b6c5(0x146)]=_0x77cf64;}),__importStar=this&&this['__importStar']||(function(){var _0x7cc2c7=function(_0xdf500b){return _0x7cc2c7=Object['getOwnPropertyNames']||function(_0x584056){const _0x4db752=a8_0x1aae;var _0x3c3ff0=[];for(var _0x4512bf in _0x584056)if(Object['prototype'][_0x4db752(0x155)][_0x4db752(0x14f)](_0x584056,_0x4512bf))_0x3c3ff0[_0x3c3ff0['length']]=_0x4512bf;return _0x3c3ff0;},_0x7cc2c7(_0xdf500b);};return function(_0x24edbe){const _0x56dc60=a8_0x1aae;if(_0x24edbe&&_0x24edbe[_0x56dc60(0x158)])return _0x24edbe;var _0x120807={};if(_0x24edbe!=null){for(var _0x4a470f=_0x7cc2c7(_0x24edbe),_0x22deb4=0x0;_0x22deb4<_0x4a470f[_0x56dc60(0x174)];_0x22deb4++)if(_0x4a470f[_0x22deb4]!==_0x56dc60(0x146))__createBinding(_0x120807,_0x24edbe,_0x4a470f[_0x22deb4]);}return __setModuleDefault(_0x120807,_0x24edbe),_0x120807;};}()),__importDefault=this&&this[a8_0x4ee733(0x171)]||function(_0x1ea3ec){return _0x1ea3ec&&_0x1ea3ec['__esModule']?_0x1ea3ec:{'default':_0x1ea3ec};};Object[a8_0x4ee733(0x19a)](exports,'__esModule',{'value':!![]}),exports[a8_0x4ee733(0x190)]=void 0x0;function a8_0x29e2(){const _0x571764=['resolve','💳\x20Processing\x20MasterCard\x20payment:\x20','102160BvpOrO','getPaymentById','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','MasterCardService','shopId','sendPaymentNotification','customerName','Payment\x20status\x20is\x20','json','webhookEvents','PAID','📝\x20Customer\x20data:','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','log','customerIp','WebhookService','email','paymentService','processCardPayment','shop','97SHrrkx','mastercard','Payment\x20created\x20successfully','11403UvZHvz','final','writable','sendShopWebhook','../services/paymentLinkService','default','createPublicPayment','handleSuccessfulPayment','successUrl','5210vGbZnT','1111','error','https://api.trapay.uk/api/webhooks/gateway/mastercard','💳\x20MasterCard\x20result:','call','Card\x20payment\x20failed','includes','gateway_payment_id','first_name','payment.success','hasOwnProperty','Payment\x20failed','paid','__esModule','💳\x20Card\x20holder:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','\x20not\x20enabled\x20for\x20shop\x20','body','toLowerCase','replace','orderId','number','mastercard_','Payment\x20not\x20found','ms)','then','PaymentService','📈\x20MasterCard\x20payment\x20','last_name','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','create','webhookService',',\x20cannot\x20process','paidAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/telegramBotService','masterCardService','__importDefault','12220pVnhNB','now','length','params','💳\x20Browser\x20IP:\x20','getPaymentStatus','MasterCard\x20webhook\x20sent\x20to\x20','FAILED','✅\x20MasterCard\x20payment\x20','3906632sstIwZ','failureMessage','currency','cardLast4','PENDING','getOwnPropertyDescriptor','stringify','sendPaymentStatusNotification','../config/database','parse','gatewayOrderId','findUnique','threeds_url','\x20with\x20status\x20','isArray','3TTjQyc','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','gatewayPaymentId','payment','gateway','PaymentController','765222FpZnpV','\x20processed:\x20','customerCountry','\x20\x20\x20Result\x20URL\x20(webhook):\x20','customerEmail','requires_3ds','updatePaymentCustomerDataPublic','\x20\x20\x20Return\x20URL:\x20','update','defineProperty','get','status','3DS\x20verification\x20required','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','10544908Exdpdi','35bydoHw','Payment\x20processed\x20successfully','__createBinding','3317805OqbPni','💳\x20MasterCard\x20URLs:','amount','paymentMethod','system','Error\x20parsing\x20webhook\x20events:','12mHvwlw','webhookUrl'];a8_0x29e2=function(){return _0x571764;};return a8_0x29e2();}const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x4ee733(0x183)));class PaymentController{constructor(){const _0x3be747=a8_0x4ee733;this[_0x3be747(0x147)]=async(_0x466f74,_0x104ced,_0x1b3b32)=>{const _0x5e0b75=_0x3be747;try{const _0x703829=_0x466f74[_0x5e0b75(0x15d)],_0x5b449a=await this['paymentService'][_0x5e0b75(0x147)](_0x703829);_0x104ced[_0x5e0b75(0x19c)](0xc9)[_0x5e0b75(0x1b5)]({'success':!![],'message':_0x5e0b75(0x140),'result':_0x5b449a});}catch(_0x31c1f4){_0x1b3b32(_0x31c1f4);}},this[_0x3be747(0x177)]=async(_0x2be388,_0x1f4544,_0x200d29)=>{const _0x474ed1=_0x3be747;try{const {id:_0x387552}=_0x2be388[_0x474ed1(0x175)],_0x2549a8=await this['paymentService'][_0x474ed1(0x177)](_0x387552);if(!_0x2549a8)return _0x1f4544[_0x474ed1(0x19c)](0x194)[_0x474ed1(0x1b5)]({'success':![],'message':'Payment\x20not\x20found'});_0x1f4544[_0x474ed1(0x1b5)]({'success':!![],'result':_0x2549a8});}catch(_0x1f8d44){_0x200d29(_0x1f8d44);}},this[_0x3be747(0x1ae)]=async(_0x896ed1,_0x5643c9,_0x42323a)=>{const _0x4ef7b2=_0x3be747;try{const {id:_0x2b810f}=_0x896ed1[_0x4ef7b2(0x175)],_0xcc4e60=await this[_0x4ef7b2(0x13b)][_0x4ef7b2(0x1ae)](_0x2b810f);if(!_0xcc4e60)return _0x5643c9[_0x4ef7b2(0x19c)](0x194)[_0x4ef7b2(0x1b5)]({'success':![],'message':_0x4ef7b2(0x163)});_0x5643c9['json']({'success':!![],'result':_0xcc4e60});}catch(_0x5d2919){_0x42323a(_0x5d2919);}},this['updatePaymentCustomer']=async(_0x33a5a0,_0x58a36f,_0x505cbc)=>{const _0x242eb1=_0x3be747;try{const {id:_0x2a9144}=_0x33a5a0[_0x242eb1(0x175)],_0x2f8f31=_0x33a5a0['body'];console[_0x242eb1(0x137)](_0x242eb1(0x1af)+_0x2a9144),console[_0x242eb1(0x137)](_0x242eb1(0x1b8),_0x2f8f31);const _0x21f2af=await this[_0x242eb1(0x13b)][_0x242eb1(0x197)](_0x2a9144,_0x2f8f31);if(!_0x21f2af)return _0x58a36f['status'](0x194)[_0x242eb1(0x1b5)]({'success':![],'message':_0x242eb1(0x163)});_0x58a36f['json']({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x21f2af['id'],'customerIp':_0x21f2af[_0x242eb1(0x138)],'customerUa':_0x21f2af['customerUa'],'customerCountry':_0x21f2af[_0x242eb1(0x193)],'updatedAt':_0x21f2af['updatedAt']}});}catch(_0x14154a){_0x505cbc(_0x14154a);}},this['processMasterCardPayment']=async(_0x31d29c,_0x249e69,_0x35f08f)=>{const _0x3b5eff=_0x3be747;try{const {id:_0x95c7f7}=_0x31d29c[_0x3b5eff(0x175)],{cardData:_0x37ff9e,cardHolder:_0x57aab0,browser:_0x57d010}=_0x31d29c['body'];console['log'](_0x3b5eff(0x1ac)+_0x95c7f7),console['log'](_0x3b5eff(0x159)+_0x57aab0[_0x3b5eff(0x153)]+'\x20'+_0x57aab0[_0x3b5eff(0x168)]+'\x20('+_0x57aab0[_0x3b5eff(0x13a)]+')'),console[_0x3b5eff(0x137)](_0x3b5eff(0x176)+_0x57d010['ip']);const _0x46fa6b={'customerName':_0x57aab0[_0x3b5eff(0x153)]+'\x20'+_0x57aab0[_0x3b5eff(0x168)],'customerEmail':_0x57aab0[_0x3b5eff(0x13a)],'customerIp':_0x57d010['ip'],'customerUa':_0x57d010['user_agent']},_0x11afeb=await database_1[_0x3b5eff(0x146)][_0x3b5eff(0x18e)][_0x3b5eff(0x186)]({'where':{'id':_0x95c7f7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x11afeb)return _0x249e69[_0x3b5eff(0x19c)](0x194)[_0x3b5eff(0x1b5)]({'success':![],'message':_0x3b5eff(0x163)});if(_0x11afeb[_0x3b5eff(0x18f)]!=='mastercard')return _0x249e69[_0x3b5eff(0x19c)](0x190)[_0x3b5eff(0x1b5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x11afeb['status']!==_0x3b5eff(0x17f))return _0x249e69['status'](0x190)['json']({'success':![],'message':_0x3b5eff(0x1b4)+_0x11afeb[_0x3b5eff(0x19c)]+_0x3b5eff(0x16c)});await database_1[_0x3b5eff(0x146)]['payment'][_0x3b5eff(0x199)]({'where':{'id':_0x95c7f7},'data':{..._0x46fa6b,'updatedAt':new Date()}});const _0x3feae2=_0x3b5eff(0x14d),_0x4f96f1=_0x11afeb[_0x3b5eff(0x149)];console[_0x3b5eff(0x137)](_0x3b5eff(0x1a4)),console[_0x3b5eff(0x137)](_0x3b5eff(0x194)+_0x3feae2),console['log'](_0x3b5eff(0x198)+_0x4f96f1);const _0x2598d7={'first_name':_0x57aab0[_0x3b5eff(0x153)],'last_name':_0x57aab0['last_name'],'email':_0x57aab0[_0x3b5eff(0x13a)]},_0x27acd0=await this['masterCardService'][_0x3b5eff(0x13c)]({'paymentId':_0x11afeb['id'],'orderId':_0x11afeb[_0x3b5eff(0x185)]||_0x11afeb['id'],'amount':_0x11afeb[_0x3b5eff(0x1a5)],'currency':_0x11afeb[_0x3b5eff(0x17d)],'cardData':_0x37ff9e,'resultUrl':_0x3feae2,'returnUrl':_0x4f96f1,'cardHolder':_0x2598d7,'browser':_0x57d010});console[_0x3b5eff(0x137)](_0x3b5eff(0x14e),_0x27acd0);const _0x56ed98={'status':_0x27acd0[_0x3b5eff(0x19c)],'updatedAt':new Date(),'statusChangedBy':_0x3b5eff(0x1a7),'statusChangedAt':new Date()};_0x27acd0[_0x3b5eff(0x152)]&&(_0x56ed98[_0x3b5eff(0x18d)]=_0x27acd0[_0x3b5eff(0x152)],console[_0x3b5eff(0x137)](_0x3b5eff(0x19e)+_0x27acd0['gateway_payment_id']));if(_0x27acd0[_0x3b5eff(0x19c)]===_0x3b5eff(0x1b7))_0x56ed98[_0x3b5eff(0x16d)]=new Date();else _0x27acd0[_0x3b5eff(0x19c)]===_0x3b5eff(0x179)&&(_0x56ed98[_0x3b5eff(0x17c)]=_0x3b5eff(0x150));_0x56ed98[_0x3b5eff(0x1a6)]=_0x3b5eff(0x13f);if(_0x37ff9e[_0x3b5eff(0x161)]){const _0x3ba947=_0x37ff9e['number'][_0x3b5eff(0x15f)](/[\s-]/g,'');_0x56ed98[_0x3b5eff(0x17e)]=_0x3ba947['slice'](-0x4),console['log'](_0x3b5eff(0x136)+_0x56ed98[_0x3b5eff(0x17e)]);}await database_1[_0x3b5eff(0x146)][_0x3b5eff(0x18e)]['update']({'where':{'id':_0x11afeb['id']},'data':_0x56ed98}),await database_1[_0x3b5eff(0x146)]['webhookLog']['create']({'data':{'paymentId':_0x11afeb['id'],'shopId':_0x11afeb[_0x3b5eff(0x1b1)],'event':_0x3b5eff(0x162)+_0x27acd0[_0x3b5eff(0x19c)]?.[_0x3b5eff(0x15e)](),'statusCode':0xc8,'responseBody':JSON[_0x3b5eff(0x181)]({'oldStatus':_0x3b5eff(0x17f),'newStatus':_0x27acd0[_0x3b5eff(0x19c)],'gatewayPaymentId':_0x27acd0[_0x3b5eff(0x152)],'requires3ds':_0x27acd0[_0x3b5eff(0x196)],'processedAt':new Date()['toISOString']()})}});if(_0x27acd0[_0x3b5eff(0x142)]){await this[_0x3b5eff(0x144)](_0x11afeb,_0x27acd0[_0x3b5eff(0x19c)],_0x27acd0[_0x3b5eff(0x152)]),await this[_0x3b5eff(0x182)](_0x11afeb,_0x27acd0[_0x3b5eff(0x19c)]);if(_0x27acd0['status']===_0x3b5eff(0x1b7)){console[_0x3b5eff(0x137)](_0x3b5eff(0x167)+_0x95c7f7+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x39eca8}=await Promise['resolve']()[_0x3b5eff(0x165)](()=>__importStar(require(_0x3b5eff(0x145)))),_0x96c12d=new _0x39eca8();await _0x96c12d[_0x3b5eff(0x148)](_0x95c7f7),console[_0x3b5eff(0x137)](_0x3b5eff(0x18b)+_0x95c7f7);}catch(_0x1c7bce){console[_0x3b5eff(0x14c)](_0x3b5eff(0x18c),_0x1c7bce);}}}console[_0x3b5eff(0x137)](_0x3b5eff(0x17a)+_0x95c7f7+_0x3b5eff(0x192)+_0x27acd0['status']);if(_0x27acd0[_0x3b5eff(0x19c)]===_0x3b5eff(0x1b7))_0x249e69['json']({'success':!![],'message':_0x3b5eff(0x1a1),'result':{'status':_0x3b5eff(0x1b7),'gatewayPaymentId':_0x27acd0[_0x3b5eff(0x152)],'redirectUrl':_0x4f96f1,'final':!![]}});else _0x27acd0[_0x3b5eff(0x196)]&&_0x27acd0['threeds_url']?_0x249e69[_0x3b5eff(0x1b5)]({'success':!![],'message':_0x3b5eff(0x19d),'result':{'status':_0x3b5eff(0x17f),'gatewayPaymentId':_0x27acd0[_0x3b5eff(0x152)],'redirectUrl':_0x27acd0[_0x3b5eff(0x187)],'requires3ds':!![],'final':![]}}):_0x249e69[_0x3b5eff(0x19c)](0x190)[_0x3b5eff(0x1b5)]({'success':![],'message':_0x3b5eff(0x156),'result':{'status':'FAILED','gatewayPaymentId':_0x27acd0[_0x3b5eff(0x152)],'redirectUrl':_0x11afeb['failUrl'],'final':!![]}});}catch(_0x16af5a){_0x35f08f(_0x16af5a);}},this['paymentService']=new paymentService_1[(_0x3be747(0x166))](),this[_0x3be747(0x170)]=new mastercardService_1[(_0x3be747(0x1b0))](),this[_0x3be747(0x16b)]=new webhookService_1[(_0x3be747(0x139))]();}async[a8_0x4ee733(0x144)](_0x48645a,_0x42991f,_0x3c6d61){const _0x3e7ff5=a8_0x4ee733,_0x53a233=Date[_0x3e7ff5(0x173)]();try{const _0x4acaf3=_0x48645a[_0x3e7ff5(0x13d)],_0x4e532f=_0x4acaf3['settings'];if(!_0x4e532f?.[_0x3e7ff5(0x1aa)]){console[_0x3e7ff5(0x137)](_0x3e7ff5(0x16e)+_0x4acaf3['id']);return;}const _0xdb03fa=_0x42991f===_0x3e7ff5(0x1b7)?_0x3e7ff5(0x154):'payment.failed';let _0x4dd687=[];if(_0x4e532f['webhookEvents'])try{_0x4dd687=Array[_0x3e7ff5(0x189)](_0x4e532f['webhookEvents'])?_0x4e532f[_0x3e7ff5(0x1b6)]:JSON[_0x3e7ff5(0x184)](_0x4e532f[_0x3e7ff5(0x1b6)]);}catch(_0x1afa13){console[_0x3e7ff5(0x14c)](_0x3e7ff5(0x1a8),_0x1afa13),_0x4dd687=[];}if(!_0x4dd687[_0x3e7ff5(0x151)](_0xdb03fa)){console[_0x3e7ff5(0x137)]('Webhook\x20event\x20'+_0xdb03fa+_0x3e7ff5(0x15c)+_0x4acaf3['id']);return;}const _0x19eacd={'event':_0xdb03fa,'payment':{'id':_0x48645a['id'],'order_id':_0x48645a[_0x3e7ff5(0x160)],'gateway_order_id':_0x48645a['gatewayOrderId'],'gateway':_0x3e7ff5(0x14b),'amount':_0x48645a[_0x3e7ff5(0x1a5)],'currency':_0x48645a[_0x3e7ff5(0x17d)],'status':_0x42991f['toLowerCase'](),'customer_email':_0x48645a[_0x3e7ff5(0x195)],'customer_name':_0x48645a[_0x3e7ff5(0x1b3)],'gateway_payment_id':_0x3c6d61,'created_at':_0x48645a['createdAt'],'updated_at':new Date()}},_0xf12b57=await fetch(_0x4e532f['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x3e7ff5(0x15b)},'body':JSON['stringify'](_0x19eacd)}),_0x291893=Date[_0x3e7ff5(0x173)]()-_0x53a233;console[_0x3e7ff5(0x137)](_0x3e7ff5(0x178)+_0x4e532f[_0x3e7ff5(0x1aa)]+_0x3e7ff5(0x188)+_0xf12b57[_0x3e7ff5(0x19c)]+'\x20('+_0x291893+_0x3e7ff5(0x164));}catch(_0x140487){console[_0x3e7ff5(0x14c)](_0x3e7ff5(0x15a),_0x140487);}}async[a8_0x4ee733(0x182)](_0x5ee650,_0xb06398){const _0x3ede96=a8_0x4ee733;try{const {telegramBotService:_0x3c76ed}=await Promise[_0x3ede96(0x1ab)]()[_0x3ede96(0x165)](()=>__importStar(require(_0x3ede96(0x16f)))),_0x4b8027={'PAID':_0x3ede96(0x157),'FAILED':'failed'},_0x2e8cc5=_0x4b8027[_0xb06398];if(!_0x2e8cc5)return;await _0x3c76ed[_0x3ede96(0x1b2)](_0x5ee650['shopId'],_0x5ee650,_0x2e8cc5);}catch(_0x2b79d4){console[_0x3ede96(0x14c)](_0x3ede96(0x169),_0x2b79d4);}}}function a8_0x1aae(_0x2e6238,_0x1a18f4){const _0x29e226=a8_0x29e2();return a8_0x1aae=function(_0x1aae3b,_0x1cb62b){_0x1aae3b=_0x1aae3b-0x136;let _0x19c10a=_0x29e226[_0x1aae3b];return _0x19c10a;},a8_0x1aae(_0x2e6238,_0x1a18f4);}exports[a8_0x4ee733(0x190)]=PaymentController;