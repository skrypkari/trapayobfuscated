'use strict';const a8_0x45cb4d=a8_0x29fc;(function(_0x491922,_0x31df8d){const _0x4877b5=a8_0x29fc,_0x238e7d=_0x491922();while(!![]){try{const _0xba7d0e=-parseInt(_0x4877b5(0xb0))/0x1*(parseInt(_0x4877b5(0xe6))/0x2)+-parseInt(_0x4877b5(0xa6))/0x3*(parseInt(_0x4877b5(0xaf))/0x4)+-parseInt(_0x4877b5(0xf8))/0x5*(-parseInt(_0x4877b5(0xcd))/0x6)+parseInt(_0x4877b5(0x110))/0x7*(-parseInt(_0x4877b5(0xc1))/0x8)+parseInt(_0x4877b5(0xe2))/0x9+-parseInt(_0x4877b5(0xc3))/0xa+parseInt(_0x4877b5(0xee))/0xb;if(_0xba7d0e===_0x31df8d)break;else _0x238e7d['push'](_0x238e7d['shift']());}catch(_0x3fe5c9){_0x238e7d['push'](_0x238e7d['shift']());}}}(a8_0x428f,0xe01fb));function a8_0x428f(){const _0x584b34=['8237306xXdvhN','Payment\x20not\x20found','Webhook\x20event\x20','customerIp','updatedAt','paid','getPaymentStatus','PENDING','payment','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','510UIPEhq','findUnique','settings','PaymentController','getPaymentById','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','POST','createPublicPayment','gatewayOrderId','length','configurable','updatePaymentCustomerDataPublic','amount','create','toLowerCase','defineProperty','sendPaymentNotification','WebhookService','Payment\x20created\x20successfully','update','__setModuleDefault','stringify','includes','customerUa','6849542OimgwY','💳\x20MasterCard\x20URLs:','sendPaymentStatusNotification','application/json','error','paymentMethod','requires_3ds','Customer\x20data\x20updated\x20successfully','1111','paidAt','18tQfJTG','json','status','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','then','ms)','Payment\x20status\x20is\x20','failureMessage','129296gRqGXl','5813MFMyww','../services/gateways/mastercardService','MasterCardService','gatewayPaymentId','shop','Payment\x20failed','mastercard','__importStar','../services/telegramBotService','mastercard_',',\x20cannot\x20process','PaymentService','params','orderId','gateway_payment_id','\x20processed:\x20','get','8hxVdDm','threeds_url','7254330HIWzOJ','PAID','processMasterCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','MasterCard\x20webhook\x20sent\x20to\x20','final','masterCardService','webhookUrl','customerCountry','✅\x20MasterCard\x20payment\x20','83196fhGJvS','getOwnPropertyDescriptor','Failed\x20to\x20send\x20MasterCard\x20webhook:','paymentService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','💳\x20Processing\x20MasterCard\x20payment:\x20','log','default','failed','updatePaymentCustomer','processCardPayment','customerName','resolve','FAILED','\x20with\x20status\x20','gateway','shopId','currency','__importDefault','webhookService','payment.success','15029919pHAqcj','sendShopWebhook','prototype','webhookEvents','350qJsEUG','__esModule','now','isArray','webhookLog','getOwnPropertyNames','3DS\x20verification\x20required','body'];a8_0x428f=function(){return _0x584b34;};return a8_0x428f();}function a8_0x29fc(_0x49081a,_0x1c0d16){const _0x428f51=a8_0x428f();return a8_0x29fc=function(_0x29fc86,_0x539dcc){_0x29fc86=_0x29fc86-0x9f;let _0x3df2c4=_0x428f51[_0x29fc86];return _0x3df2c4;},a8_0x29fc(_0x49081a,_0x1c0d16);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x482729,_0x3edda1,_0x22c609,_0x5c36a2){const _0x812487=a8_0x29fc;if(_0x5c36a2===undefined)_0x5c36a2=_0x22c609;var _0x5c7146=Object[_0x812487(0xce)](_0x3edda1,_0x22c609);(!_0x5c7146||(_0x812487(0xc0)in _0x5c7146?!_0x3edda1['__esModule']:_0x5c7146['writable']||_0x5c7146[_0x812487(0x102)]))&&(_0x5c7146={'enumerable':!![],'get':function(){return _0x3edda1[_0x22c609];}}),Object[_0x812487(0x107)](_0x482729,_0x5c36a2,_0x5c7146);}:function(_0x47d308,_0x250aba,_0x1198e0,_0x52a1eb){if(_0x52a1eb===undefined)_0x52a1eb=_0x1198e0;_0x47d308[_0x52a1eb]=_0x250aba[_0x1198e0];}),__setModuleDefault=this&&this[a8_0x45cb4d(0x10c)]||(Object['create']?function(_0x295206,_0x191376){const _0xd0d477=a8_0x45cb4d;Object[_0xd0d477(0x107)](_0x295206,_0xd0d477(0xd4),{'enumerable':!![],'value':_0x191376});}:function(_0x971306,_0x2bedb8){const _0x1c1944=a8_0x45cb4d;_0x971306[_0x1c1944(0xd4)]=_0x2bedb8;}),__importStar=this&&this[a8_0x45cb4d(0xb7)]||(function(){var _0x5a16b7=function(_0x2490b2){const _0x126043=a8_0x29fc;return _0x5a16b7=Object[_0x126043(0xeb)]||function(_0x478cf0){const _0x46be68=_0x126043;var _0x2a71db=[];for(var _0x59f8d5 in _0x478cf0)if(Object[_0x46be68(0xe4)]['hasOwnProperty']['call'](_0x478cf0,_0x59f8d5))_0x2a71db[_0x2a71db[_0x46be68(0x101)]]=_0x59f8d5;return _0x2a71db;},_0x5a16b7(_0x2490b2);};return function(_0x1ecc73){const _0x16425d=a8_0x29fc;if(_0x1ecc73&&_0x1ecc73[_0x16425d(0xe7)])return _0x1ecc73;var _0xa6e4b9={};if(_0x1ecc73!=null){for(var _0x2eafd5=_0x5a16b7(_0x1ecc73),_0x2355c2=0x0;_0x2355c2<_0x2eafd5[_0x16425d(0x101)];_0x2355c2++)if(_0x2eafd5[_0x2355c2]!==_0x16425d(0xd4))__createBinding(_0xa6e4b9,_0x1ecc73,_0x2eafd5[_0x2355c2]);}return __setModuleDefault(_0xa6e4b9,_0x1ecc73),_0xa6e4b9;};}()),__importDefault=this&&this[a8_0x45cb4d(0xdf)]||function(_0x5e3123){const _0x34592c=a8_0x45cb4d;return _0x5e3123&&_0x5e3123[_0x34592c(0xe7)]?_0x5e3123:{'default':_0x5e3123};};Object[a8_0x45cb4d(0x107)](exports,a8_0x45cb4d(0xe7),{'value':!![]}),exports[a8_0x45cb4d(0xfb)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x45cb4d(0xb1)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0xf5ef83=a8_0x45cb4d;this[_0xf5ef83(0xff)]=async(_0x422a22,_0x15dd6b,_0x4a3ae6)=>{const _0x5dede8=_0xf5ef83;try{const _0x4d98e8=_0x422a22['body'],_0x393263=await this[_0x5dede8(0xd0)][_0x5dede8(0xff)](_0x4d98e8);_0x15dd6b[_0x5dede8(0xa8)](0xc9)[_0x5dede8(0xa7)]({'success':!![],'message':_0x5dede8(0x10a),'result':_0x393263});}catch(_0x410d34){_0x4a3ae6(_0x410d34);}},this[_0xf5ef83(0xf4)]=async(_0x3b9d36,_0x6096d2,_0x27216d)=>{const _0x5480da=_0xf5ef83;try{const {id:_0x18bab5}=_0x3b9d36[_0x5480da(0xbc)],_0x2b0c9b=await this[_0x5480da(0xd0)][_0x5480da(0xf4)](_0x18bab5);if(!_0x2b0c9b)return _0x6096d2['status'](0x194)[_0x5480da(0xa7)]({'success':![],'message':_0x5480da(0xef)});_0x6096d2[_0x5480da(0xa7)]({'success':!![],'result':_0x2b0c9b});}catch(_0x96b451){_0x27216d(_0x96b451);}},this[_0xf5ef83(0xfc)]=async(_0x31cf9f,_0x205f37,_0x2a7454)=>{const _0xd6a685=_0xf5ef83;try{const {id:_0x7ebf8b}=_0x31cf9f[_0xd6a685(0xbc)],_0x546791=await this['paymentService']['getPaymentById'](_0x7ebf8b);if(!_0x546791)return _0x205f37[_0xd6a685(0xa8)](0x194)['json']({'success':![],'message':_0xd6a685(0xef)});_0x205f37[_0xd6a685(0xa7)]({'success':!![],'result':_0x546791});}catch(_0x368690){_0x2a7454(_0x368690);}},this[_0xf5ef83(0xd6)]=async(_0x3dae0b,_0x38ab22,_0x599fd1)=>{const _0x2016f5=_0xf5ef83;try{const {id:_0x40ad56}=_0x3dae0b[_0x2016f5(0xbc)],_0xc400bd=_0x3dae0b[_0x2016f5(0xed)];console[_0x2016f5(0xd3)](_0x2016f5(0xa9)+_0x40ad56),console[_0x2016f5(0xd3)]('📝\x20Customer\x20data:',_0xc400bd);const _0x119e80=await this['paymentService'][_0x2016f5(0x103)](_0x40ad56,_0xc400bd);if(!_0x119e80)return _0x38ab22['status'](0x194)[_0x2016f5(0xa7)]({'success':![],'message':_0x2016f5(0xef)});_0x38ab22[_0x2016f5(0xa7)]({'success':!![],'message':_0x2016f5(0xa3),'result':{'paymentId':_0x119e80['id'],'customerIp':_0x119e80[_0x2016f5(0xf1)],'customerUa':_0x119e80[_0x2016f5(0x10f)],'customerCountry':_0x119e80[_0x2016f5(0xcb)],'updatedAt':_0x119e80[_0x2016f5(0xf2)]}});}catch(_0x5c5a66){_0x599fd1(_0x5c5a66);}},this[_0xf5ef83(0xc5)]=async(_0x88e559,_0x382fde,_0x1a9942)=>{const _0x2daf9b=_0xf5ef83;try{const {id:_0x5943e9}=_0x88e559[_0x2daf9b(0xbc)],{cardData:_0x5d0c02,cardHolder:_0x54426f,browser:_0x1060d2}=_0x88e559[_0x2daf9b(0xed)];console['log'](_0x2daf9b(0xd2)+_0x5943e9);const _0x522d63=await database_1['default'][_0x2daf9b(0xf6)][_0x2daf9b(0xf9)]({'where':{'id':_0x5943e9},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x522d63)return _0x382fde[_0x2daf9b(0xa8)](0x194)[_0x2daf9b(0xa7)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x522d63[_0x2daf9b(0xdc)]!==_0x2daf9b(0xb6))return _0x382fde[_0x2daf9b(0xa8)](0x190)[_0x2daf9b(0xa7)]({'success':![],'message':_0x2daf9b(0xf7)});if(_0x522d63[_0x2daf9b(0xa8)]!==_0x2daf9b(0xf5))return _0x382fde[_0x2daf9b(0xa8)](0x190)['json']({'success':![],'message':_0x2daf9b(0xad)+_0x522d63[_0x2daf9b(0xa8)]+_0x2daf9b(0xba)});const _0x15d634=_0x2daf9b(0xc6),_0xdab56a=_0x522d63['successUrl'];console[_0x2daf9b(0xd3)](_0x2daf9b(0x111)),console[_0x2daf9b(0xd3)](_0x2daf9b(0xaa)+_0x15d634),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0xdab56a);const _0x58a41f=await this[_0x2daf9b(0xc9)][_0x2daf9b(0xd7)]({'paymentId':_0x522d63['id'],'orderId':_0x522d63['gatewayOrderId']||_0x522d63['id'],'amount':_0x522d63[_0x2daf9b(0x104)],'currency':_0x522d63['currency'],'cardData':_0x5d0c02,'resultUrl':_0x15d634,'returnUrl':_0xdab56a,'cardHolder':_0x54426f,'browser':_0x1060d2});console[_0x2daf9b(0xd3)]('💳\x20MasterCard\x20result:',_0x58a41f);const _0x5c3bd4={'status':_0x58a41f[_0x2daf9b(0xa8)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x58a41f['status']===_0x2daf9b(0xc4))_0x5c3bd4[_0x2daf9b(0xa5)]=new Date(),_0x5c3bd4[_0x2daf9b(0xb3)]=_0x58a41f[_0x2daf9b(0xbe)];else _0x58a41f[_0x2daf9b(0xa8)]===_0x2daf9b(0xda)&&(_0x5c3bd4[_0x2daf9b(0xae)]='Card\x20payment\x20failed');_0x5c3bd4[_0x2daf9b(0xa1)]=_0x2daf9b(0xb6),await database_1[_0x2daf9b(0xd4)]['payment'][_0x2daf9b(0x10b)]({'where':{'id':_0x522d63['id']},'data':_0x5c3bd4}),await database_1[_0x2daf9b(0xd4)][_0x2daf9b(0xea)][_0x2daf9b(0x105)]({'data':{'paymentId':_0x522d63['id'],'shopId':_0x522d63[_0x2daf9b(0xdd)],'event':_0x2daf9b(0xb9)+_0x58a41f['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2daf9b(0xf5),'newStatus':_0x58a41f[_0x2daf9b(0xa8)],'gatewayPaymentId':_0x58a41f[_0x2daf9b(0xbe)],'requires3ds':_0x58a41f[_0x2daf9b(0xa2)],'processedAt':new Date()['toISOString']()})}});_0x58a41f[_0x2daf9b(0xc8)]&&(await this['sendShopWebhook'](_0x522d63,_0x58a41f[_0x2daf9b(0xa8)],_0x58a41f[_0x2daf9b(0xbe)]),await this[_0x2daf9b(0x112)](_0x522d63,_0x58a41f[_0x2daf9b(0xa8)]));console['log'](_0x2daf9b(0xcc)+_0x5943e9+_0x2daf9b(0xbf)+_0x58a41f[_0x2daf9b(0xa8)]);if(_0x58a41f[_0x2daf9b(0xa8)]===_0x2daf9b(0xc4))_0x382fde[_0x2daf9b(0xa7)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2daf9b(0xc4),'gatewayPaymentId':_0x58a41f[_0x2daf9b(0xbe)],'redirectUrl':_0xdab56a,'final':!![]}});else _0x58a41f[_0x2daf9b(0xa2)]&&_0x58a41f[_0x2daf9b(0xc2)]?_0x382fde[_0x2daf9b(0xa7)]({'success':!![],'message':_0x2daf9b(0xec),'result':{'status':_0x2daf9b(0xf5),'gatewayPaymentId':_0x58a41f[_0x2daf9b(0xbe)],'redirectUrl':_0x58a41f['threeds_url'],'requires3ds':!![],'final':![]}}):_0x382fde[_0x2daf9b(0xa8)](0x190)[_0x2daf9b(0xa7)]({'success':![],'message':_0x2daf9b(0xb5),'result':{'status':_0x2daf9b(0xda),'gatewayPaymentId':_0x58a41f[_0x2daf9b(0xbe)],'redirectUrl':_0x522d63['failUrl'],'final':!![]}});}catch(_0x4907b2){_0x1a9942(_0x4907b2);}},this[_0xf5ef83(0xd0)]=new paymentService_1[(_0xf5ef83(0xbb))](),this[_0xf5ef83(0xc9)]=new mastercardService_1[(_0xf5ef83(0xb2))](),this[_0xf5ef83(0xe0)]=new webhookService_1[(_0xf5ef83(0x109))]();}async[a8_0x45cb4d(0xe3)](_0x586a2d,_0x39ee3d,_0x575068){const _0x5be864=a8_0x45cb4d,_0x36b467=Date[_0x5be864(0xe8)]();try{const _0x2e67b7=_0x586a2d[_0x5be864(0xb4)],_0x43fc9b=_0x2e67b7[_0x5be864(0xfa)];if(!_0x43fc9b?.[_0x5be864(0xca)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2e67b7['id']);return;}const _0x2ccc40=_0x39ee3d===_0x5be864(0xc4)?_0x5be864(0xe1):'payment.failed';let _0x3bc539=[];if(_0x43fc9b[_0x5be864(0xe5)])try{_0x3bc539=Array[_0x5be864(0xe9)](_0x43fc9b[_0x5be864(0xe5)])?_0x43fc9b['webhookEvents']:JSON['parse'](_0x43fc9b[_0x5be864(0xe5)]);}catch(_0x367972){console['error']('Error\x20parsing\x20webhook\x20events:',_0x367972),_0x3bc539=[];}if(!_0x3bc539[_0x5be864(0x10e)](_0x2ccc40)){console[_0x5be864(0xd3)](_0x5be864(0xf0)+_0x2ccc40+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2e67b7['id']);return;}const _0x4bd6d1={'event':_0x2ccc40,'payment':{'id':_0x586a2d['id'],'order_id':_0x586a2d[_0x5be864(0xbd)],'gateway_order_id':_0x586a2d[_0x5be864(0x100)],'gateway':_0x5be864(0xa4),'amount':_0x586a2d[_0x5be864(0x104)],'currency':_0x586a2d[_0x5be864(0xde)],'status':_0x39ee3d[_0x5be864(0x106)](),'customer_email':_0x586a2d['customerEmail'],'customer_name':_0x586a2d[_0x5be864(0xd8)],'gateway_payment_id':_0x575068,'created_at':_0x586a2d['createdAt'],'updated_at':new Date()}},_0x4b4e79=await fetch(_0x43fc9b[_0x5be864(0xca)],{'method':_0x5be864(0xfe),'headers':{'Content-Type':_0x5be864(0x9f),'User-Agent':_0x5be864(0xfd)},'body':JSON[_0x5be864(0x10d)](_0x4bd6d1)}),_0x1b609d=Date[_0x5be864(0xe8)]()-_0x36b467;console['log'](_0x5be864(0xc7)+_0x43fc9b[_0x5be864(0xca)]+_0x5be864(0xdb)+_0x4b4e79[_0x5be864(0xa8)]+'\x20('+_0x1b609d+_0x5be864(0xac));}catch(_0x1dd2ea){console[_0x5be864(0xa0)](_0x5be864(0xcf),_0x1dd2ea);}}async[a8_0x45cb4d(0x112)](_0x2ca801,_0x23c21b){const _0x390b0b=a8_0x45cb4d;try{const {telegramBotService:_0x22a192}=await Promise[_0x390b0b(0xd9)]()[_0x390b0b(0xab)](()=>__importStar(require(_0x390b0b(0xb8)))),_0x5d93d9={'PAID':_0x390b0b(0xf3),'FAILED':_0x390b0b(0xd5)},_0x5d0b9b=_0x5d93d9[_0x23c21b];if(!_0x5d0b9b)return;await _0x22a192[_0x390b0b(0x108)](_0x2ca801[_0x390b0b(0xdd)],_0x2ca801,_0x5d0b9b);}catch(_0x95b057){console[_0x390b0b(0xa0)](_0x390b0b(0xd1),_0x95b057);}}}exports[a8_0x45cb4d(0xfb)]=PaymentController;