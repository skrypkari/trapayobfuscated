'use strict';const a8_0x1a3eca=a8_0x51c8;(function(_0x232ebe,_0xd674b3){const _0x42c782=a8_0x51c8,_0x5155e9=_0x232ebe();while(!![]){try{const _0x3df694=parseInt(_0x42c782(0x149))/0x1+-parseInt(_0x42c782(0x109))/0x2*(-parseInt(_0x42c782(0x156))/0x3)+parseInt(_0x42c782(0x152))/0x4+-parseInt(_0x42c782(0x179))/0x5*(parseInt(_0x42c782(0x13a))/0x6)+parseInt(_0x42c782(0x158))/0x7+parseInt(_0x42c782(0x178))/0x8+-parseInt(_0x42c782(0x137))/0x9;if(_0x3df694===_0xd674b3)break;else _0x5155e9['push'](_0x5155e9['shift']());}catch(_0x3f1280){_0x5155e9['push'](_0x5155e9['shift']());}}}(a8_0x34df,0xaec85));function a8_0x51c8(_0x285414,_0x42ab83){const _0x34dfa6=a8_0x34df();return a8_0x51c8=function(_0x51c8cc,_0x24ba68){_0x51c8cc=_0x51c8cc-0x106;let _0x4e1ef3=_0x34dfa6[_0x51c8cc];return _0x4e1ef3;},a8_0x51c8(_0x285414,_0x42ab83);}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x16632f,_0x40b4b6,_0x228d45,_0x5a118e){const _0x3544e5=a8_0x51c8;if(_0x5a118e===undefined)_0x5a118e=_0x228d45;var _0x5f315d=Object['getOwnPropertyDescriptor'](_0x40b4b6,_0x228d45);(!_0x5f315d||(_0x3544e5(0x160)in _0x5f315d?!_0x40b4b6[_0x3544e5(0x147)]:_0x5f315d[_0x3544e5(0x131)]||_0x5f315d[_0x3544e5(0x123)]))&&(_0x5f315d={'enumerable':!![],'get':function(){return _0x40b4b6[_0x228d45];}}),Object[_0x3544e5(0x114)](_0x16632f,_0x5a118e,_0x5f315d);}:function(_0x4a458e,_0x311b46,_0x6be3b,_0x5e8d13){if(_0x5e8d13===undefined)_0x5e8d13=_0x6be3b;_0x4a458e[_0x5e8d13]=_0x311b46[_0x6be3b];}),__setModuleDefault=this&&this[a8_0x1a3eca(0x153)]||(Object[a8_0x1a3eca(0x127)]?function(_0x23806c,_0x157d09){const _0x1f04d9=a8_0x1a3eca;Object[_0x1f04d9(0x114)](_0x23806c,_0x1f04d9(0x15c),{'enumerable':!![],'value':_0x157d09});}:function(_0x3f799d,_0x332a76){const _0x18f5ac=a8_0x1a3eca;_0x3f799d[_0x18f5ac(0x15c)]=_0x332a76;}),__importStar=this&&this[a8_0x1a3eca(0x150)]||(function(){var _0x321418=function(_0x20062b){return _0x321418=Object['getOwnPropertyNames']||function(_0x5e98ed){const _0x400ce4=a8_0x51c8;var _0x426070=[];for(var _0x4d412f in _0x5e98ed)if(Object[_0x400ce4(0x10a)][_0x400ce4(0x184)]['call'](_0x5e98ed,_0x4d412f))_0x426070[_0x426070[_0x400ce4(0x106)]]=_0x4d412f;return _0x426070;},_0x321418(_0x20062b);};return function(_0x172ff3){const _0xaec050=a8_0x51c8;if(_0x172ff3&&_0x172ff3[_0xaec050(0x147)])return _0x172ff3;var _0x5f1d09={};if(_0x172ff3!=null){for(var _0x58708c=_0x321418(_0x172ff3),_0xb8192c=0x0;_0xb8192c<_0x58708c[_0xaec050(0x106)];_0xb8192c++)if(_0x58708c[_0xb8192c]!==_0xaec050(0x15c))__createBinding(_0x5f1d09,_0x172ff3,_0x58708c[_0xb8192c]);}return __setModuleDefault(_0x5f1d09,_0x172ff3),_0x5f1d09;};}()),__importDefault=this&&this['__importDefault']||function(_0x8434da){const _0x26a774=a8_0x1a3eca;return _0x8434da&&_0x8434da[_0x26a774(0x147)]?_0x8434da:{'default':_0x8434da};};Object[a8_0x1a3eca(0x114)](exports,a8_0x1a3eca(0x147),{'value':!![]}),exports[a8_0x1a3eca(0x16b)]=void 0x0;const paymentService_1=require(a8_0x1a3eca(0x14e)),mastercardService_1=require(a8_0x1a3eca(0x146)),webhookService_1=require(a8_0x1a3eca(0x13e)),database_1=__importDefault(require('../config/database'));function a8_0x34df(){const _0x9b1ea9=['phone','Card\x20payment\x20failed','\x20not\x20enabled\x20for\x20shop\x20','💳\x20MasterCard\x20URLs:','22914234ultSuS','customerIp','update','1325004lPiABx','paymentMethod','shopId','WebhookService','../services/webhookService','💳\x20Browser\x20IP:\x20','customerCountry','webhookUrl','getPaymentStatus','MasterCard\x20webhook\x20sent\x20to\x20','1\x20Main\x20Street','Error\x20parsing\x20webhook\x20events:','../services/gateways/mastercardService','__esModule','Customer\x20data\x20updated\x20successfully','311446XhSXko','threeds_url','sendPaymentNotification','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','PAID','../services/paymentService','toLowerCase','__importStar','📝\x20Customer\x20data:','3732772osCRaT','__setModuleDefault','webhookService','body','42VkUmoI','requires_3ds','1445353iBztKU','payment','PENDING','webhookLog','default','masterCardService','isArray','Failed\x20to\x20send\x20MasterCard\x20webhook:','get','FAILED','💳\x20Card\x20holder:\x20','gateway_payment_id','3DS\x20verification\x20required','01000','toISOString','parse','Payment\x20failed','✅\x20MasterCard\x20payment\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PaymentController','paidAt','stringify','json','mastercard','successUrl','system','now','findUnique','webhookEvents','post_code','shop','PaymentService','11162024SkPdII','5FZWGwH','country','customerUa','first_name','+380123456789','customerName','status','💳\x20Processing\x20MasterCard\x20payment:\x20','amount','last_name','updatePaymentCustomer','hasOwnProperty','length','../services/telegramBotService','includes','90914QpEZQw','prototype','updatedAt','POST','Payment\x20status\x20is\x20','sendShopWebhook',',\x20cannot\x20process','failureMessage','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','currency','💳\x20MasterCard\x20result:','defineProperty','\x20\x20\x20Result\x20URL\x20(webhook):\x20','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','paymentService','failed','then','Kyiv','Payment\x20not\x20found','getPaymentById','gatewayOrderId','ms)','\x20\x20\x20Return\x20URL:\x20','error','log','\x20with\x20status\x20','configurable','https://api.trapay.uk/api/webhooks/gateway/mastercard','createdAt','processCardPayment','create','resolve','processMasterCardPayment','customerEmail','application/json','address_line_1','payment.success','email','Payment\x20processed\x20successfully','sendPaymentStatusNotification','writable','params'];a8_0x34df=function(){return _0x9b1ea9;};return a8_0x34df();}class PaymentController{constructor(){const _0x491083=a8_0x1a3eca;this['createPublicPayment']=async(_0x546fbf,_0x1ce344,_0x470929)=>{const _0x4d1e38=a8_0x51c8;try{const _0xa07840=_0x546fbf[_0x4d1e38(0x155)],_0x5664e9=await this[_0x4d1e38(0x117)]['createPublicPayment'](_0xa07840);_0x1ce344[_0x4d1e38(0x17f)](0xc9)[_0x4d1e38(0x16e)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x5664e9});}catch(_0x2fddfd){_0x470929(_0x2fddfd);}},this[_0x491083(0x142)]=async(_0x15d65d,_0x465fd6,_0x132703)=>{const _0x4add43=_0x491083;try{const {id:_0x54a0a4}=_0x15d65d[_0x4add43(0x132)],_0x1bcf6f=await this[_0x4add43(0x117)][_0x4add43(0x142)](_0x54a0a4);if(!_0x1bcf6f)return _0x465fd6[_0x4add43(0x17f)](0x194)[_0x4add43(0x16e)]({'success':![],'message':_0x4add43(0x11b)});_0x465fd6[_0x4add43(0x16e)]({'success':!![],'result':_0x1bcf6f});}catch(_0xb056d5){_0x132703(_0xb056d5);}},this[_0x491083(0x11c)]=async(_0x4847b9,_0x1d312e,_0x16ca18)=>{const _0x5d0fc9=_0x491083;try{const {id:_0x6c6efc}=_0x4847b9['params'],_0x5f5109=await this[_0x5d0fc9(0x117)][_0x5d0fc9(0x11c)](_0x6c6efc);if(!_0x5f5109)return _0x1d312e[_0x5d0fc9(0x17f)](0x194)[_0x5d0fc9(0x16e)]({'success':![],'message':_0x5d0fc9(0x11b)});_0x1d312e[_0x5d0fc9(0x16e)]({'success':!![],'result':_0x5f5109});}catch(_0x219456){_0x16ca18(_0x219456);}},this[_0x491083(0x183)]=async(_0xa3ea11,_0x1b6aa9,_0x45ab36)=>{const _0x19f6a6=_0x491083;try{const {id:_0x2a31a6}=_0xa3ea11[_0x19f6a6(0x132)],_0x5378a6=_0xa3ea11[_0x19f6a6(0x155)];console['log'](_0x19f6a6(0x116)+_0x2a31a6),console['log'](_0x19f6a6(0x151),_0x5378a6);const _0x549167=await this[_0x19f6a6(0x117)]['updatePaymentCustomerDataPublic'](_0x2a31a6,_0x5378a6);if(!_0x549167)return _0x1b6aa9[_0x19f6a6(0x17f)](0x194)[_0x19f6a6(0x16e)]({'success':![],'message':_0x19f6a6(0x11b)});_0x1b6aa9[_0x19f6a6(0x16e)]({'success':!![],'message':_0x19f6a6(0x148),'result':{'paymentId':_0x549167['id'],'customerIp':_0x549167[_0x19f6a6(0x138)],'customerUa':_0x549167[_0x19f6a6(0x17b)],'customerCountry':_0x549167[_0x19f6a6(0x140)],'updatedAt':_0x549167[_0x19f6a6(0x10b)]}});}catch(_0x2cb265){_0x45ab36(_0x2cb265);}},this[_0x491083(0x129)]=async(_0x43c4c7,_0x104da6,_0x12b564)=>{const _0x478beb=_0x491083;try{const {id:_0x3cc438}=_0x43c4c7[_0x478beb(0x132)],{cardData:_0x2a15f6,cardHolder:_0x4b7d2e,browser:_0x31266a}=_0x43c4c7[_0x478beb(0x155)];console['log'](_0x478beb(0x180)+_0x3cc438),console[_0x478beb(0x121)](_0x478beb(0x162)+_0x4b7d2e['first_name']+'\x20'+_0x4b7d2e[_0x478beb(0x182)]+'\x20('+_0x4b7d2e[_0x478beb(0x12e)]+')'),console[_0x478beb(0x121)](_0x478beb(0x13f)+_0x31266a['ip']);const _0x51f25f={'customerName':_0x4b7d2e[_0x478beb(0x17c)]+'\x20'+_0x4b7d2e[_0x478beb(0x182)],'customerEmail':_0x4b7d2e['email'],'customerIp':_0x31266a['ip'],'customerUa':_0x31266a['user_agent'],'customerCountry':_0x4b7d2e[_0x478beb(0x17a)]||null},_0x555557=await database_1['default'][_0x478beb(0x159)][_0x478beb(0x173)]({'where':{'id':_0x3cc438},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x555557)return _0x104da6['status'](0x194)['json']({'success':![],'message':_0x478beb(0x11b)});if(_0x555557['gateway']!==_0x478beb(0x16f))return _0x104da6[_0x478beb(0x17f)](0x190)['json']({'success':![],'message':_0x478beb(0x14c)});if(_0x555557['status']!==_0x478beb(0x15a))return _0x104da6[_0x478beb(0x17f)](0x190)[_0x478beb(0x16e)]({'success':![],'message':_0x478beb(0x10d)+_0x555557[_0x478beb(0x17f)]+_0x478beb(0x10f)});await database_1[_0x478beb(0x15c)][_0x478beb(0x159)][_0x478beb(0x139)]({'where':{'id':_0x3cc438},'data':{..._0x51f25f,'updatedAt':new Date()}});const _0x2e30be=_0x478beb(0x124),_0x28a2b6=_0x555557[_0x478beb(0x170)];console[_0x478beb(0x121)](_0x478beb(0x136)),console[_0x478beb(0x121)](_0x478beb(0x115)+_0x2e30be),console[_0x478beb(0x121)](_0x478beb(0x11f)+_0x28a2b6);const _0x5274a2={'first_name':_0x4b7d2e['first_name'],'last_name':_0x4b7d2e[_0x478beb(0x182)],'email':_0x4b7d2e[_0x478beb(0x12e)],'country':_0x4b7d2e[_0x478beb(0x17a)]||'UA','post_code':_0x4b7d2e[_0x478beb(0x175)]||_0x478beb(0x165),'city':_0x4b7d2e['city']||_0x478beb(0x11a),'address_line_1':_0x4b7d2e[_0x478beb(0x12c)]||_0x478beb(0x144),'phone':_0x4b7d2e[_0x478beb(0x133)]||_0x478beb(0x17d)},_0x4ae61a=await this['masterCardService'][_0x478beb(0x126)]({'paymentId':_0x555557['id'],'orderId':_0x555557[_0x478beb(0x11d)]||_0x555557['id'],'amount':_0x555557[_0x478beb(0x181)],'currency':_0x555557[_0x478beb(0x112)],'cardData':_0x2a15f6,'resultUrl':_0x2e30be,'returnUrl':_0x28a2b6,'cardHolder':_0x5274a2,'browser':_0x31266a});console[_0x478beb(0x121)](_0x478beb(0x113),_0x4ae61a);const _0x5b43c0={'status':_0x4ae61a[_0x478beb(0x17f)],'updatedAt':new Date(),'statusChangedBy':_0x478beb(0x171),'statusChangedAt':new Date()};if(_0x4ae61a['status']===_0x478beb(0x14d))_0x5b43c0[_0x478beb(0x16c)]=new Date(),_0x5b43c0['gatewayPaymentId']=_0x4ae61a[_0x478beb(0x163)];else _0x4ae61a[_0x478beb(0x17f)]===_0x478beb(0x161)&&(_0x5b43c0[_0x478beb(0x110)]=_0x478beb(0x134));_0x5b43c0[_0x478beb(0x13b)]=_0x478beb(0x16f),await database_1[_0x478beb(0x15c)][_0x478beb(0x159)]['update']({'where':{'id':_0x555557['id']},'data':_0x5b43c0}),await database_1[_0x478beb(0x15c)][_0x478beb(0x15b)][_0x478beb(0x127)]({'data':{'paymentId':_0x555557['id'],'shopId':_0x555557['shopId'],'event':'mastercard_'+_0x4ae61a[_0x478beb(0x17f)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x478beb(0x16d)]({'oldStatus':_0x478beb(0x15a),'newStatus':_0x4ae61a['status'],'gatewayPaymentId':_0x4ae61a[_0x478beb(0x163)],'requires3ds':_0x4ae61a[_0x478beb(0x157)],'processedAt':new Date()[_0x478beb(0x166)]()})}});_0x4ae61a['final']&&(await this[_0x478beb(0x10e)](_0x555557,_0x4ae61a[_0x478beb(0x17f)],_0x4ae61a['gateway_payment_id']),await this[_0x478beb(0x130)](_0x555557,_0x4ae61a['status']));console['log'](_0x478beb(0x169)+_0x3cc438+'\x20processed:\x20'+_0x4ae61a[_0x478beb(0x17f)]);if(_0x4ae61a[_0x478beb(0x17f)]==='PAID')_0x104da6[_0x478beb(0x16e)]({'success':!![],'message':_0x478beb(0x12f),'result':{'status':_0x478beb(0x14d),'gatewayPaymentId':_0x4ae61a[_0x478beb(0x163)],'redirectUrl':_0x28a2b6,'final':!![]}});else _0x4ae61a[_0x478beb(0x157)]&&_0x4ae61a[_0x478beb(0x14a)]?_0x104da6[_0x478beb(0x16e)]({'success':!![],'message':_0x478beb(0x164),'result':{'status':_0x478beb(0x15a),'gatewayPaymentId':_0x4ae61a['gateway_payment_id'],'redirectUrl':_0x4ae61a['threeds_url'],'requires3ds':!![],'final':![]}}):_0x104da6[_0x478beb(0x17f)](0x190)['json']({'success':![],'message':_0x478beb(0x168),'result':{'status':'FAILED','gatewayPaymentId':_0x4ae61a[_0x478beb(0x163)],'redirectUrl':_0x555557['failUrl'],'final':!![]}});}catch(_0x139487){_0x12b564(_0x139487);}},this[_0x491083(0x117)]=new paymentService_1[(_0x491083(0x177))](),this[_0x491083(0x15d)]=new mastercardService_1['MasterCardService'](),this[_0x491083(0x154)]=new webhookService_1[(_0x491083(0x13d))]();}async['sendShopWebhook'](_0x727aa1,_0x23f93c,_0x5b1f60){const _0x3aa3d9=a8_0x1a3eca,_0x192b78=Date[_0x3aa3d9(0x172)]();try{const _0x44b170=_0x727aa1[_0x3aa3d9(0x176)],_0x5a30c1=_0x44b170['settings'];if(!_0x5a30c1?.['webhookUrl']){console[_0x3aa3d9(0x121)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x44b170['id']);return;}const _0x279802=_0x23f93c==='PAID'?_0x3aa3d9(0x12d):'payment.failed';let _0x4f6aee=[];if(_0x5a30c1['webhookEvents'])try{_0x4f6aee=Array[_0x3aa3d9(0x15e)](_0x5a30c1['webhookEvents'])?_0x5a30c1[_0x3aa3d9(0x174)]:JSON[_0x3aa3d9(0x167)](_0x5a30c1[_0x3aa3d9(0x174)]);}catch(_0x10ee23){console[_0x3aa3d9(0x120)](_0x3aa3d9(0x145),_0x10ee23),_0x4f6aee=[];}if(!_0x4f6aee[_0x3aa3d9(0x108)](_0x279802)){console[_0x3aa3d9(0x121)]('Webhook\x20event\x20'+_0x279802+_0x3aa3d9(0x135)+_0x44b170['id']);return;}const _0x3b7f38={'event':_0x279802,'payment':{'id':_0x727aa1['id'],'order_id':_0x727aa1['orderId'],'gateway_order_id':_0x727aa1[_0x3aa3d9(0x11d)],'gateway':'1111','amount':_0x727aa1[_0x3aa3d9(0x181)],'currency':_0x727aa1['currency'],'status':_0x23f93c[_0x3aa3d9(0x14f)](),'customer_email':_0x727aa1[_0x3aa3d9(0x12a)],'customer_name':_0x727aa1[_0x3aa3d9(0x17e)],'gateway_payment_id':_0x5b1f60,'created_at':_0x727aa1[_0x3aa3d9(0x125)],'updated_at':new Date()}},_0x3094de=await fetch(_0x5a30c1[_0x3aa3d9(0x141)],{'method':_0x3aa3d9(0x10c),'headers':{'Content-Type':_0x3aa3d9(0x12b),'User-Agent':_0x3aa3d9(0x111)},'body':JSON['stringify'](_0x3b7f38)}),_0x38888f=Date['now']()-_0x192b78;console[_0x3aa3d9(0x121)](_0x3aa3d9(0x143)+_0x5a30c1[_0x3aa3d9(0x141)]+_0x3aa3d9(0x122)+_0x3094de['status']+'\x20('+_0x38888f+_0x3aa3d9(0x11e));}catch(_0xd6caac){console[_0x3aa3d9(0x120)](_0x3aa3d9(0x15f),_0xd6caac);}}async[a8_0x1a3eca(0x130)](_0x3dcc70,_0x5088c5){const _0x4e81e5=a8_0x1a3eca;try{const {telegramBotService:_0x927c88}=await Promise[_0x4e81e5(0x128)]()[_0x4e81e5(0x119)](()=>__importStar(require(_0x4e81e5(0x107)))),_0xf501db={'PAID':'paid','FAILED':_0x4e81e5(0x118)},_0x20ab47=_0xf501db[_0x5088c5];if(!_0x20ab47)return;await _0x927c88[_0x4e81e5(0x14b)](_0x3dcc70[_0x4e81e5(0x13c)],_0x3dcc70,_0x20ab47);}catch(_0x58221f){console['error'](_0x4e81e5(0x16a),_0x58221f);}}}exports['PaymentController']=PaymentController;