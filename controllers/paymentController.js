'use strict';const a8_0x8b22fa=a8_0xe9e7;(function(_0x8348c8,_0x27a3e7){const _0x35f8d6=a8_0xe9e7,_0x3f9daf=_0x8348c8();while(!![]){try{const _0x543295=-parseInt(_0x35f8d6(0x14d))/0x1+-parseInt(_0x35f8d6(0x165))/0x2*(-parseInt(_0x35f8d6(0x119))/0x3)+-parseInt(_0x35f8d6(0x152))/0x4+parseInt(_0x35f8d6(0x139))/0x5*(parseInt(_0x35f8d6(0x102))/0x6)+parseInt(_0x35f8d6(0x15b))/0x7*(-parseInt(_0x35f8d6(0x148))/0x8)+parseInt(_0x35f8d6(0x13c))/0x9+parseInt(_0x35f8d6(0x11a))/0xa;if(_0x543295===_0x27a3e7)break;else _0x3f9daf['push'](_0x3f9daf['shift']());}catch(_0x4c6e2e){_0x3f9daf['push'](_0x3f9daf['shift']());}}}(a8_0x2b4a,0x1c403));var __createBinding=this&&this[a8_0x8b22fa(0x12f)]||(Object[a8_0x8b22fa(0x150)]?function(_0x8e5d5b,_0x1ad314,_0xe5ffe9,_0x316b09){const _0x1d8e08=a8_0x8b22fa;if(_0x316b09===undefined)_0x316b09=_0xe5ffe9;var _0x568c58=Object[_0x1d8e08(0x100)](_0x1ad314,_0xe5ffe9);(!_0x568c58||(_0x1d8e08(0x120)in _0x568c58?!_0x1ad314[_0x1d8e08(0x15e)]:_0x568c58[_0x1d8e08(0x143)]||_0x568c58[_0x1d8e08(0x12a)]))&&(_0x568c58={'enumerable':!![],'get':function(){return _0x1ad314[_0xe5ffe9];}}),Object['defineProperty'](_0x8e5d5b,_0x316b09,_0x568c58);}:function(_0x4e2369,_0x506746,_0x292cac,_0x433792){if(_0x433792===undefined)_0x433792=_0x292cac;_0x4e2369[_0x433792]=_0x506746[_0x292cac];}),__setModuleDefault=this&&this[a8_0x8b22fa(0x169)]||(Object['create']?function(_0x3c431a,_0x14cc21){const _0x4a5ebb=a8_0x8b22fa;Object[_0x4a5ebb(0x16a)](_0x3c431a,_0x4a5ebb(0x14b),{'enumerable':!![],'value':_0x14cc21});}:function(_0x1cda35,_0x440a10){const _0x29418d=a8_0x8b22fa;_0x1cda35[_0x29418d(0x14b)]=_0x440a10;}),__importStar=this&&this[a8_0x8b22fa(0x11e)]||(function(){var _0x28eb74=function(_0x3a583b){const _0x189a3b=a8_0xe9e7;return _0x28eb74=Object[_0x189a3b(0x110)]||function(_0x476b9f){const _0x255580=_0x189a3b;var _0x169f54=[];for(var _0x4fbedd in _0x476b9f)if(Object['prototype'][_0x255580(0x168)][_0x255580(0x10c)](_0x476b9f,_0x4fbedd))_0x169f54[_0x169f54['length']]=_0x4fbedd;return _0x169f54;},_0x28eb74(_0x3a583b);};return function(_0x1392bb){const _0x39910f=a8_0xe9e7;if(_0x1392bb&&_0x1392bb['__esModule'])return _0x1392bb;var _0x3c0f86={};if(_0x1392bb!=null){for(var _0x4df2f1=_0x28eb74(_0x1392bb),_0x408877=0x0;_0x408877<_0x4df2f1[_0x39910f(0x13a)];_0x408877++)if(_0x4df2f1[_0x408877]!==_0x39910f(0x14b))__createBinding(_0x3c0f86,_0x1392bb,_0x4df2f1[_0x408877]);}return __setModuleDefault(_0x3c0f86,_0x1392bb),_0x3c0f86;};}()),__importDefault=this&&this[a8_0x8b22fa(0x104)]||function(_0x335561){return _0x335561&&_0x335561['__esModule']?_0x335561:{'default':_0x335561};};function a8_0x2b4a(){const _0x2bf97a=['paymentService','customerName','mastercard','62fHKPZz','PAID','payment.success','hasOwnProperty','__setModuleDefault','defineProperty','\x20\x20\x20Return\x20URL:\x20','toISOString','PENDING','toLowerCase','https://api.trapay.uk/api/webhooks/gateway/mastercard','ms)','getOwnPropertyDescriptor','💳\x20MasterCard\x20URLs:','6HYFgpO','createdAt','__importDefault','updatedAt','masterCardService','webhookLog','threeds_url','now','processMasterCardPayment','Payment\x20failed','call','MasterCardService','payment','../services/gateways/mastercardService','getOwnPropertyNames','sendShopWebhook','POST','Payment\x20created\x20successfully','settings','getPaymentById','mastercard_','Error\x20parsing\x20webhook\x20events:','MasterCard\x20webhook\x20sent\x20to\x20','12435KZnMRE','824160owcTHT','failureMessage','\x20with\x20status\x20','resolve','__importStar','customerUa','get','sendPaymentStatusNotification','sendPaymentNotification','status','processCardPayment','paidAt','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1111','customerIp','💳\x20Processing\x20MasterCard\x20payment:\x20','configurable','getPaymentStatus','body','PaymentController','params','__createBinding','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','isArray','Payment\x20not\x20found','paid','failUrl','Card\x20payment\x20failed','customerEmail','Webhook\x20event\x20','107980bJFlLP','length','failed','2081439qygfdB','currency','json','system','webhookService','gatewayOrderId','📝\x20Customer\x20data:','writable','Payment\x20processed\x20successfully','webhookEvents','WebhookService','../services/telegramBotService','252592jlGyfu','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','\x20processed:\x20','default','stringify','147552BKwLyf','FAILED','amount','create','createPublicPayment','423156eJjrNx','webhookUrl',',\x20cannot\x20process','gateway_payment_id','requires_3ds','../services/paymentService','log','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','../config/database','21prqJlW','shopId','PaymentService','__esModule','findUnique','update','error'];a8_0x2b4a=function(){return _0x2bf97a;};return a8_0x2b4a();}Object[a8_0x8b22fa(0x16a)](exports,'__esModule',{'value':!![]}),exports[a8_0x8b22fa(0x12d)]=void 0x0;const paymentService_1=require(a8_0x8b22fa(0x157)),mastercardService_1=require(a8_0x8b22fa(0x10f)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x8b22fa(0x15a)));function a8_0xe9e7(_0x79e80c,_0x177faa){const _0x2b4a76=a8_0x2b4a();return a8_0xe9e7=function(_0xe9e7d8,_0x3664ac){_0xe9e7d8=_0xe9e7d8-0xfe;let _0x4f3f77=_0x2b4a76[_0xe9e7d8];return _0x4f3f77;},a8_0xe9e7(_0x79e80c,_0x177faa);}class PaymentController{constructor(){const _0x4bb128=a8_0x8b22fa;this[_0x4bb128(0x151)]=async(_0x2839bd,_0x3d69b3,_0xbca1ed)=>{const _0x184d8d=_0x4bb128;try{const _0x2b6ed9=_0x2839bd['body'],_0x3abe89=await this['paymentService']['createPublicPayment'](_0x2b6ed9);_0x3d69b3[_0x184d8d(0x123)](0xc9)[_0x184d8d(0x13e)]({'success':!![],'message':_0x184d8d(0x113),'result':_0x3abe89});}catch(_0x2a59ec){_0xbca1ed(_0x2a59ec);}},this[_0x4bb128(0x12b)]=async(_0x50f1fa,_0x270a00,_0xb84363)=>{const _0x4272df=_0x4bb128;try{const {id:_0x522ec4}=_0x50f1fa[_0x4272df(0x12e)],_0x51c090=await this[_0x4272df(0x162)][_0x4272df(0x12b)](_0x522ec4);if(!_0x51c090)return _0x270a00[_0x4272df(0x123)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x270a00[_0x4272df(0x13e)]({'success':!![],'result':_0x51c090});}catch(_0x281a8f){_0xb84363(_0x281a8f);}},this[_0x4bb128(0x115)]=async(_0x9de7a,_0x3676fd,_0xfc9f3)=>{const _0xf3383c=_0x4bb128;try{const {id:_0x1e77fc}=_0x9de7a['params'],_0x357944=await this[_0xf3383c(0x162)][_0xf3383c(0x115)](_0x1e77fc);if(!_0x357944)return _0x3676fd[_0xf3383c(0x123)](0x194)['json']({'success':![],'message':_0xf3383c(0x133)});_0x3676fd['json']({'success':!![],'result':_0x357944});}catch(_0x181be0){_0xfc9f3(_0x181be0);}},this['updatePaymentCustomer']=async(_0x5a00fc,_0x5db43b,_0x3384b1)=>{const _0x308ea1=_0x4bb128;try{const {id:_0x54cab8}=_0x5a00fc[_0x308ea1(0x12e)],_0x418a77=_0x5a00fc[_0x308ea1(0x12c)];console[_0x308ea1(0x158)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x54cab8),console[_0x308ea1(0x158)](_0x308ea1(0x142),_0x418a77);const _0x17d050=await this[_0x308ea1(0x162)]['updatePaymentCustomerDataPublic'](_0x54cab8,_0x418a77);if(!_0x17d050)return _0x5db43b[_0x308ea1(0x123)](0x194)['json']({'success':![],'message':_0x308ea1(0x133)});_0x5db43b[_0x308ea1(0x13e)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x17d050['id'],'customerIp':_0x17d050[_0x308ea1(0x128)],'customerUa':_0x17d050[_0x308ea1(0x11f)],'customerCountry':_0x17d050['customerCountry'],'updatedAt':_0x17d050[_0x308ea1(0x105)]}});}catch(_0x2a6d32){_0x3384b1(_0x2a6d32);}},this[_0x4bb128(0x10a)]=async(_0x431cc7,_0x22eff9,_0x4348c5)=>{const _0x16a266=_0x4bb128;try{const {id:_0x111c1d}=_0x431cc7[_0x16a266(0x12e)],{cardData:_0x349255,cardHolder:_0x5d2516,browser:_0x277705}=_0x431cc7[_0x16a266(0x12c)];console[_0x16a266(0x158)](_0x16a266(0x129)+_0x111c1d);const _0x35adff=await database_1[_0x16a266(0x14b)][_0x16a266(0x10e)][_0x16a266(0x15f)]({'where':{'id':_0x111c1d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x35adff)return _0x22eff9['status'](0x194)[_0x16a266(0x13e)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x35adff['gateway']!==_0x16a266(0x164))return _0x22eff9[_0x16a266(0x123)](0x190)[_0x16a266(0x13e)]({'success':![],'message':_0x16a266(0x149)});if(_0x35adff[_0x16a266(0x123)]!==_0x16a266(0x16d))return _0x22eff9[_0x16a266(0x123)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x35adff[_0x16a266(0x123)]+_0x16a266(0x154)});const _0x333537=_0x16a266(0xfe),_0x577183=_0x35adff['successUrl'];console[_0x16a266(0x158)](_0x16a266(0x101)),console[_0x16a266(0x158)](_0x16a266(0x130)+_0x333537),console[_0x16a266(0x158)](_0x16a266(0x16b)+_0x577183);const _0x485377=await this[_0x16a266(0x106)][_0x16a266(0x124)]({'paymentId':_0x35adff['id'],'orderId':_0x35adff[_0x16a266(0x141)]||_0x35adff['id'],'amount':_0x35adff['amount'],'currency':_0x35adff[_0x16a266(0x13d)],'cardData':_0x349255,'resultUrl':_0x333537,'returnUrl':_0x577183,'cardHolder':_0x5d2516,'browser':_0x277705});console[_0x16a266(0x158)]('💳\x20MasterCard\x20result:',_0x485377);const _0x5be569={'status':_0x485377[_0x16a266(0x123)],'updatedAt':new Date(),'statusChangedBy':_0x16a266(0x13f),'statusChangedAt':new Date()};if(_0x485377[_0x16a266(0x123)]==='PAID')_0x5be569[_0x16a266(0x125)]=new Date(),_0x5be569['gatewayPaymentId']=_0x485377[_0x16a266(0x155)];else _0x485377[_0x16a266(0x123)]===_0x16a266(0x14e)&&(_0x5be569[_0x16a266(0x11b)]=_0x16a266(0x136));_0x5be569['paymentMethod']=_0x16a266(0x164),await database_1['default'][_0x16a266(0x10e)][_0x16a266(0x160)]({'where':{'id':_0x35adff['id']},'data':_0x5be569}),await database_1[_0x16a266(0x14b)][_0x16a266(0x107)][_0x16a266(0x150)]({'data':{'paymentId':_0x35adff['id'],'shopId':_0x35adff['shopId'],'event':_0x16a266(0x116)+_0x485377[_0x16a266(0x123)]?.[_0x16a266(0x16e)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x16a266(0x16d),'newStatus':_0x485377['status'],'gatewayPaymentId':_0x485377[_0x16a266(0x155)],'requires3ds':_0x485377[_0x16a266(0x156)],'processedAt':new Date()[_0x16a266(0x16c)]()})}});_0x485377['final']&&(await this['sendShopWebhook'](_0x35adff,_0x485377[_0x16a266(0x123)],_0x485377['gateway_payment_id']),await this[_0x16a266(0x121)](_0x35adff,_0x485377[_0x16a266(0x123)]));console[_0x16a266(0x158)]('✅\x20MasterCard\x20payment\x20'+_0x111c1d+_0x16a266(0x14a)+_0x485377[_0x16a266(0x123)]);if(_0x485377[_0x16a266(0x123)]===_0x16a266(0x166))_0x22eff9[_0x16a266(0x13e)]({'success':!![],'message':_0x16a266(0x144),'result':{'status':'PAID','gatewayPaymentId':_0x485377['gateway_payment_id'],'redirectUrl':_0x577183,'final':!![]}});else _0x485377[_0x16a266(0x156)]&&_0x485377[_0x16a266(0x108)]?_0x22eff9[_0x16a266(0x13e)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x16a266(0x16d),'gatewayPaymentId':_0x485377[_0x16a266(0x155)],'redirectUrl':_0x485377['threeds_url'],'requires3ds':!![],'final':![]}}):_0x22eff9[_0x16a266(0x123)](0x190)[_0x16a266(0x13e)]({'success':![],'message':_0x16a266(0x10b),'result':{'status':_0x16a266(0x14e),'gatewayPaymentId':_0x485377['gateway_payment_id'],'redirectUrl':_0x35adff[_0x16a266(0x135)],'final':!![]}});}catch(_0x33c21a){_0x4348c5(_0x33c21a);}},this[_0x4bb128(0x162)]=new paymentService_1[(_0x4bb128(0x15d))](),this[_0x4bb128(0x106)]=new mastercardService_1[(_0x4bb128(0x10d))](),this[_0x4bb128(0x140)]=new webhookService_1[(_0x4bb128(0x146))]();}async[a8_0x8b22fa(0x111)](_0x5d20f8,_0x2804a1,_0x578713){const _0x4b5210=a8_0x8b22fa,_0x2f4d26=Date[_0x4b5210(0x109)]();try{const _0x2d2fe5=_0x5d20f8['shop'],_0x1c0c2f=_0x2d2fe5[_0x4b5210(0x114)];if(!_0x1c0c2f?.[_0x4b5210(0x153)]){console[_0x4b5210(0x158)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2d2fe5['id']);return;}const _0x39acf=_0x2804a1===_0x4b5210(0x166)?_0x4b5210(0x167):'payment.failed';let _0x56a500=[];if(_0x1c0c2f[_0x4b5210(0x145)])try{_0x56a500=Array[_0x4b5210(0x132)](_0x1c0c2f[_0x4b5210(0x145)])?_0x1c0c2f[_0x4b5210(0x145)]:JSON['parse'](_0x1c0c2f[_0x4b5210(0x145)]);}catch(_0x2c6574){console[_0x4b5210(0x161)](_0x4b5210(0x117),_0x2c6574),_0x56a500=[];}if(!_0x56a500['includes'](_0x39acf)){console[_0x4b5210(0x158)](_0x4b5210(0x138)+_0x39acf+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2d2fe5['id']);return;}const _0x1ef851={'event':_0x39acf,'payment':{'id':_0x5d20f8['id'],'order_id':_0x5d20f8['orderId'],'gateway_order_id':_0x5d20f8['gatewayOrderId'],'gateway':_0x4b5210(0x127),'amount':_0x5d20f8[_0x4b5210(0x14f)],'currency':_0x5d20f8['currency'],'status':_0x2804a1[_0x4b5210(0x16e)](),'customer_email':_0x5d20f8[_0x4b5210(0x137)],'customer_name':_0x5d20f8[_0x4b5210(0x163)],'gateway_payment_id':_0x578713,'created_at':_0x5d20f8[_0x4b5210(0x103)],'updated_at':new Date()}},_0x3c20a3=await fetch(_0x1c0c2f[_0x4b5210(0x153)],{'method':_0x4b5210(0x112),'headers':{'Content-Type':'application/json','User-Agent':_0x4b5210(0x159)},'body':JSON[_0x4b5210(0x14c)](_0x1ef851)}),_0x105988=Date[_0x4b5210(0x109)]()-_0x2f4d26;console[_0x4b5210(0x158)](_0x4b5210(0x118)+_0x1c0c2f[_0x4b5210(0x153)]+_0x4b5210(0x11c)+_0x3c20a3[_0x4b5210(0x123)]+'\x20('+_0x105988+_0x4b5210(0xff));}catch(_0x41999f){console[_0x4b5210(0x161)](_0x4b5210(0x131),_0x41999f);}}async[a8_0x8b22fa(0x121)](_0x19f710,_0x11b868){const _0x334122=a8_0x8b22fa;try{const {telegramBotService:_0xd705da}=await Promise[_0x334122(0x11d)]()['then'](()=>__importStar(require(_0x334122(0x147)))),_0x5055e8={'PAID':_0x334122(0x134),'FAILED':_0x334122(0x13b)},_0x28238e=_0x5055e8[_0x11b868];if(!_0x28238e)return;await _0xd705da[_0x334122(0x122)](_0x19f710[_0x334122(0x15c)],_0x19f710,_0x28238e);}catch(_0x1fb1d2){console[_0x334122(0x161)](_0x334122(0x126),_0x1fb1d2);}}}exports['PaymentController']=PaymentController;