'use strict';const a8_0x56100b=a8_0xd085;function a8_0xd085(_0x59966b,_0xe25997){const _0x4d4184=a8_0x4d41();return a8_0xd085=function(_0xd0855e,_0x461061){_0xd0855e=_0xd0855e-0xb6;let _0x3201bc=_0x4d4184[_0xd0855e];return _0x3201bc;},a8_0xd085(_0x59966b,_0xe25997);}function a8_0x4d41(){const _0x2c735a=['toLowerCase','PAID','parse','hasOwnProperty','shopId','processCardPayment','writable','successUrl','\x20\x20\x20Result\x20URL\x20(webhook):\x20','configurable','155406bpONRy','87215TfYwNQ','sendPaymentStatusNotification','MasterCard\x20webhook\x20sent\x20to\x20','call','Card\x20payment\x20failed','paymentMethod','ms)','payment','getPaymentStatus','https://api.trapay.uk/api/webhooks/gateway/mastercard','../services/webhookService','orderId','56uUGcqc','__createBinding','getPaymentById','Failed\x20to\x20send\x20MasterCard\x20webhook:','mastercard','update','findUnique','webhookEvents','system','__importStar','\x20not\x20enabled\x20for\x20shop\x20','stringify','Payment\x20failed','currency','Payment\x20not\x20found','log','failureMessage','POST','paid','params','default','3DS\x20verification\x20required','createdAt','PaymentController','Payment\x20processed\x20successfully','now','body','gateway','Webhook\x20event\x20','3085500wnmpci','isArray','json','96817RVOvoW','getOwnPropertyNames','webhookUrl','../services/telegramBotService','threeds_url','amount','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','üí≥\x20MasterCard\x20result:','Error\x20parsing\x20webhook\x20events:','payment.failed','defineProperty','customerIp','PaymentService','customerName','82mpAgNZ','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','masterCardService','gatewayPaymentId','paymentService','prototype','PENDING','updatePaymentCustomer','payment.success','üìù\x20Customer\x20data:','create','gatewayOrderId','üí≥\x20Processing\x20MasterCard\x20payment:\x20','432070thjsdw','failed','__importDefault','webhookService','requires_3ds','WebhookService','sendPaymentNotification','application/json','gateway_payment_id','length','status','1082VlMvzK','9XyRkaB','FAILED','../config/database','‚úÖ\x20MasterCard\x20payment\x20','374048KNKvNT','toISOString','42BkBVXE','webhookLog','1111','updatePaymentCustomerDataPublic','paidAt','includes','Customer\x20data\x20updated\x20successfully','error','get','sendShopWebhook','mastercard_','__esModule','customerUa','üí≥\x20MasterCard\x20URLs:','createPublicPayment','\x20\x20\x20Return\x20URL:\x20','getOwnPropertyDescriptor'];a8_0x4d41=function(){return _0x2c735a;};return a8_0x4d41();}(function(_0x82352c,_0xa33064){const _0xbb5531=a8_0xd085,_0x1888ae=_0x82352c();while(!![]){try{const _0x1a8ac4=-parseInt(_0xbb5531(0xfa))/0x1*(parseInt(_0xbb5531(0xe2))/0x2)+-parseInt(_0xbb5531(0x11c))/0x3+-parseInt(_0xbb5531(0xff))/0x4+parseInt(_0xbb5531(0x11d))/0x5*(-parseInt(_0xbb5531(0x101))/0x6)+-parseInt(_0xbb5531(0xd4))/0x7*(-parseInt(_0xbb5531(0x129))/0x8)+parseInt(_0xbb5531(0xfb))/0x9*(parseInt(_0xbb5531(0xef))/0xa)+parseInt(_0xbb5531(0xd1))/0xb;if(_0x1a8ac4===_0xa33064)break;else _0x1888ae['push'](_0x1888ae['shift']());}catch(_0xef9643){_0x1888ae['push'](_0x1888ae['shift']());}}}(a8_0x4d41,0x1a8cb));var __createBinding=this&&this[a8_0x56100b(0x12a)]||(Object[a8_0x56100b(0xec)]?function(_0x3707be,_0x1ac5fc,_0x4941df,_0x136a71){const _0x58d9ae=a8_0x56100b;if(_0x136a71===undefined)_0x136a71=_0x4941df;var _0x2c2f9e=Object[_0x58d9ae(0x111)](_0x1ac5fc,_0x4941df);(!_0x2c2f9e||(_0x58d9ae(0x109)in _0x2c2f9e?!_0x1ac5fc[_0x58d9ae(0x10c)]:_0x2c2f9e[_0x58d9ae(0x118)]||_0x2c2f9e[_0x58d9ae(0x11b)]))&&(_0x2c2f9e={'enumerable':!![],'get':function(){return _0x1ac5fc[_0x4941df];}}),Object[_0x58d9ae(0xde)](_0x3707be,_0x136a71,_0x2c2f9e);}:function(_0x4db8b9,_0x3b9bcb,_0x4cb393,_0x4c6ad8){if(_0x4c6ad8===undefined)_0x4c6ad8=_0x4cb393;_0x4db8b9[_0x4c6ad8]=_0x3b9bcb[_0x4cb393];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x56100b(0xec)]?function(_0x4c6f6e,_0x53e025){const _0x27a9fc=a8_0x56100b;Object[_0x27a9fc(0xde)](_0x4c6f6e,_0x27a9fc(0xc8),{'enumerable':!![],'value':_0x53e025});}:function(_0x1f84f0,_0x4c1418){const _0x38e5de=a8_0x56100b;_0x1f84f0[_0x38e5de(0xc8)]=_0x4c1418;}),__importStar=this&&this[a8_0x56100b(0xbd)]||(function(){var _0x467af1=function(_0x43fc2d){const _0x477242=a8_0xd085;return _0x467af1=Object[_0x477242(0xd5)]||function(_0x5d9508){const _0x2bf101=_0x477242;var _0x17a576=[];for(var _0x225947 in _0x5d9508)if(Object[_0x2bf101(0xe7)][_0x2bf101(0x115)][_0x2bf101(0x120)](_0x5d9508,_0x225947))_0x17a576[_0x17a576[_0x2bf101(0xf8)]]=_0x225947;return _0x17a576;},_0x467af1(_0x43fc2d);};return function(_0x267517){const _0x2b2a4e=a8_0xd085;if(_0x267517&&_0x267517[_0x2b2a4e(0x10c)])return _0x267517;var _0x3944b5={};if(_0x267517!=null){for(var _0x19ac43=_0x467af1(_0x267517),_0x55c71d=0x0;_0x55c71d<_0x19ac43[_0x2b2a4e(0xf8)];_0x55c71d++)if(_0x19ac43[_0x55c71d]!=='default')__createBinding(_0x3944b5,_0x267517,_0x19ac43[_0x55c71d]);}return __setModuleDefault(_0x3944b5,_0x267517),_0x3944b5;};}()),__importDefault=this&&this[a8_0x56100b(0xf1)]||function(_0x44f2a3){return _0x44f2a3&&_0x44f2a3['__esModule']?_0x44f2a3:{'default':_0x44f2a3};};Object[a8_0x56100b(0xde)](exports,a8_0x56100b(0x10c),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x56100b(0x127)),database_1=__importDefault(require(a8_0x56100b(0xfd)));class PaymentController{constructor(){const _0x38d958=a8_0x56100b;this[_0x38d958(0x10f)]=async(_0x21dc73,_0x2b0f0b,_0x46e5c2)=>{const _0x3f26db=_0x38d958;try{const _0x3a03a0=_0x21dc73['body'],_0x3ada18=await this[_0x3f26db(0xe6)][_0x3f26db(0x10f)](_0x3a03a0);_0x2b0f0b[_0x3f26db(0xf9)](0xc9)[_0x3f26db(0xd3)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x3ada18});}catch(_0x4cd667){_0x46e5c2(_0x4cd667);}},this[_0x38d958(0x125)]=async(_0x38d000,_0x3ad24e,_0x20b70f)=>{const _0x462759=_0x38d958;try{const {id:_0xc78749}=_0x38d000[_0x462759(0xc7)],_0x3506f6=await this['paymentService'][_0x462759(0x125)](_0xc78749);if(!_0x3506f6)return _0x3ad24e[_0x462759(0xf9)](0x194)['json']({'success':![],'message':_0x462759(0xc2)});_0x3ad24e[_0x462759(0xd3)]({'success':!![],'result':_0x3506f6});}catch(_0x3330f3){_0x20b70f(_0x3330f3);}},this[_0x38d958(0xb6)]=async(_0x293a60,_0x4d9ff2,_0x38ee3a)=>{const _0x4577f6=_0x38d958;try{const {id:_0x5ac281}=_0x293a60[_0x4577f6(0xc7)],_0x85d258=await this[_0x4577f6(0xe6)][_0x4577f6(0xb6)](_0x5ac281);if(!_0x85d258)return _0x4d9ff2['status'](0x194)['json']({'success':![],'message':_0x4577f6(0xc2)});_0x4d9ff2['json']({'success':!![],'result':_0x85d258});}catch(_0x10bf97){_0x38ee3a(_0x10bf97);}},this[_0x38d958(0xe9)]=async(_0xa3a3c4,_0x3c89a4,_0x935504)=>{const _0xca2ace=_0x38d958;try{const {id:_0x52d487}=_0xa3a3c4['params'],_0x10cf89=_0xa3a3c4[_0xca2ace(0xce)];console[_0xca2ace(0xc3)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x52d487),console[_0xca2ace(0xc3)](_0xca2ace(0xeb),_0x10cf89);const _0x2bdd27=await this[_0xca2ace(0xe6)][_0xca2ace(0x104)](_0x52d487,_0x10cf89);if(!_0x2bdd27)return _0x3c89a4[_0xca2ace(0xf9)](0x194)[_0xca2ace(0xd3)]({'success':![],'message':_0xca2ace(0xc2)});_0x3c89a4['json']({'success':!![],'message':_0xca2ace(0x107),'result':{'paymentId':_0x2bdd27['id'],'customerIp':_0x2bdd27[_0xca2ace(0xdf)],'customerUa':_0x2bdd27[_0xca2ace(0x10d)],'customerCountry':_0x2bdd27['customerCountry'],'updatedAt':_0x2bdd27['updatedAt']}});}catch(_0x380eb){_0x935504(_0x380eb);}},this['processMasterCardPayment']=async(_0x50ddee,_0x32c3ed,_0x2be46b)=>{const _0x3d8594=_0x38d958;try{const {id:_0x1dd003}=_0x50ddee['params'],{cardData:_0x4ebc2d,cardHolder:_0x4de7ec,browser:_0x30f369}=_0x50ddee[_0x3d8594(0xce)];console[_0x3d8594(0xc3)](_0x3d8594(0xee)+_0x1dd003);const _0x3013ef=await database_1[_0x3d8594(0xc8)][_0x3d8594(0x124)][_0x3d8594(0xba)]({'where':{'id':_0x1dd003},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3013ef)return _0x32c3ed[_0x3d8594(0xf9)](0x194)[_0x3d8594(0xd3)]({'success':![],'message':_0x3d8594(0xc2)});if(_0x3013ef[_0x3d8594(0xcf)]!==_0x3d8594(0xb8))return _0x32c3ed['status'](0x190)[_0x3d8594(0xd3)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x3013ef[_0x3d8594(0xf9)]!==_0x3d8594(0xe8))return _0x32c3ed[_0x3d8594(0xf9)](0x190)[_0x3d8594(0xd3)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3013ef[_0x3d8594(0xf9)]+',\x20cannot\x20process'});const _0xf80aab=_0x3d8594(0x126),_0x3ddd15=_0x3013ef[_0x3d8594(0x119)];console[_0x3d8594(0xc3)](_0x3d8594(0x10e)),console[_0x3d8594(0xc3)](_0x3d8594(0x11a)+_0xf80aab),console[_0x3d8594(0xc3)](_0x3d8594(0x110)+_0x3ddd15);const _0x5c3a2d=await this['masterCardService'][_0x3d8594(0x117)]({'paymentId':_0x3013ef['id'],'orderId':_0x3013ef[_0x3d8594(0xed)]||_0x3013ef['id'],'amount':_0x3013ef['amount'],'currency':_0x3013ef[_0x3d8594(0xc1)],'cardData':_0x4ebc2d,'resultUrl':_0xf80aab,'returnUrl':_0x3ddd15,'cardHolder':_0x4de7ec,'browser':_0x30f369});console[_0x3d8594(0xc3)](_0x3d8594(0xdb),_0x5c3a2d);const _0x2cb1c5={'status':_0x5c3a2d[_0x3d8594(0xf9)],'updatedAt':new Date(),'statusChangedBy':_0x3d8594(0xbc),'statusChangedAt':new Date()};if(_0x5c3a2d[_0x3d8594(0xf9)]===_0x3d8594(0x113))_0x2cb1c5[_0x3d8594(0x105)]=new Date(),_0x2cb1c5[_0x3d8594(0xe5)]=_0x5c3a2d['gateway_payment_id'];else _0x5c3a2d[_0x3d8594(0xf9)]===_0x3d8594(0xfc)&&(_0x2cb1c5[_0x3d8594(0xc4)]=_0x3d8594(0x121));_0x2cb1c5[_0x3d8594(0x122)]='mastercard',await database_1[_0x3d8594(0xc8)][_0x3d8594(0x124)][_0x3d8594(0xb9)]({'where':{'id':_0x3013ef['id']},'data':_0x2cb1c5}),await database_1[_0x3d8594(0xc8)][_0x3d8594(0x102)]['create']({'data':{'paymentId':_0x3013ef['id'],'shopId':_0x3013ef['shopId'],'event':_0x3d8594(0x10b)+_0x5c3a2d[_0x3d8594(0xf9)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3d8594(0xbf)]({'oldStatus':'PENDING','newStatus':_0x5c3a2d[_0x3d8594(0xf9)],'gatewayPaymentId':_0x5c3a2d[_0x3d8594(0xf7)],'requires3ds':_0x5c3a2d['requires_3ds'],'processedAt':new Date()[_0x3d8594(0x100)]()})}});_0x5c3a2d['final']&&(await this[_0x3d8594(0x10a)](_0x3013ef,_0x5c3a2d[_0x3d8594(0xf9)],_0x5c3a2d[_0x3d8594(0xf7)]),await this[_0x3d8594(0x11e)](_0x3013ef,_0x5c3a2d[_0x3d8594(0xf9)]));console[_0x3d8594(0xc3)](_0x3d8594(0xfe)+_0x1dd003+'\x20processed:\x20'+_0x5c3a2d[_0x3d8594(0xf9)]);if(_0x5c3a2d['status']===_0x3d8594(0x113))_0x32c3ed[_0x3d8594(0xd3)]({'success':!![],'message':_0x3d8594(0xcc),'result':{'status':_0x3d8594(0x113),'gatewayPaymentId':_0x5c3a2d['gateway_payment_id'],'redirectUrl':_0x3ddd15,'final':!![]}});else _0x5c3a2d[_0x3d8594(0xf3)]&&_0x5c3a2d['threeds_url']?_0x32c3ed[_0x3d8594(0xd3)]({'success':!![],'message':_0x3d8594(0xc9),'result':{'status':_0x3d8594(0xe8),'gatewayPaymentId':_0x5c3a2d['gateway_payment_id'],'redirectUrl':_0x5c3a2d[_0x3d8594(0xd8)],'requires3ds':!![],'final':![]}}):_0x32c3ed['status'](0x190)[_0x3d8594(0xd3)]({'success':![],'message':_0x3d8594(0xc0),'result':{'status':_0x3d8594(0xfc),'gatewayPaymentId':_0x5c3a2d[_0x3d8594(0xf7)],'redirectUrl':_0x3013ef['failUrl'],'final':!![]}});}catch(_0x1b268b){_0x2be46b(_0x1b268b);}},this['paymentService']=new paymentService_1[(_0x38d958(0xe0))](),this[_0x38d958(0xe4)]=new mastercardService_1['MasterCardService'](),this[_0x38d958(0xf2)]=new webhookService_1[(_0x38d958(0xf4))]();}async[a8_0x56100b(0x10a)](_0xb8c5ad,_0x58d3fc,_0x33cb69){const _0x47b97f=a8_0x56100b,_0x3a0560=Date[_0x47b97f(0xcd)]();try{const _0x31315c=_0xb8c5ad['shop'],_0x4adb48=_0x31315c['settings'];if(!_0x4adb48?.[_0x47b97f(0xd6)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x31315c['id']);return;}const _0x3224b4=_0x58d3fc===_0x47b97f(0x113)?_0x47b97f(0xea):_0x47b97f(0xdd);let _0x583936=[];if(_0x4adb48['webhookEvents'])try{_0x583936=Array[_0x47b97f(0xd2)](_0x4adb48[_0x47b97f(0xbb)])?_0x4adb48[_0x47b97f(0xbb)]:JSON[_0x47b97f(0x114)](_0x4adb48['webhookEvents']);}catch(_0x4ed80f){console[_0x47b97f(0x108)](_0x47b97f(0xdc),_0x4ed80f),_0x583936=[];}if(!_0x583936[_0x47b97f(0x106)](_0x3224b4)){console[_0x47b97f(0xc3)](_0x47b97f(0xd0)+_0x3224b4+_0x47b97f(0xbe)+_0x31315c['id']);return;}const _0xc6bf74={'event':_0x3224b4,'payment':{'id':_0xb8c5ad['id'],'order_id':_0xb8c5ad[_0x47b97f(0x128)],'gateway_order_id':_0xb8c5ad[_0x47b97f(0xed)],'gateway':_0x47b97f(0x103),'amount':_0xb8c5ad[_0x47b97f(0xd9)],'currency':_0xb8c5ad[_0x47b97f(0xc1)],'status':_0x58d3fc[_0x47b97f(0x112)](),'customer_email':_0xb8c5ad['customerEmail'],'customer_name':_0xb8c5ad[_0x47b97f(0xe1)],'gateway_payment_id':_0x33cb69,'created_at':_0xb8c5ad[_0x47b97f(0xca)],'updated_at':new Date()}},_0x4b1298=await fetch(_0x4adb48['webhookUrl'],{'method':_0x47b97f(0xc5),'headers':{'Content-Type':_0x47b97f(0xf6),'User-Agent':_0x47b97f(0xda)},'body':JSON['stringify'](_0xc6bf74)}),_0x4c3f5d=Date[_0x47b97f(0xcd)]()-_0x3a0560;console[_0x47b97f(0xc3)](_0x47b97f(0x11f)+_0x4adb48[_0x47b97f(0xd6)]+'\x20with\x20status\x20'+_0x4b1298[_0x47b97f(0xf9)]+'\x20('+_0x4c3f5d+_0x47b97f(0x123));}catch(_0x2acbc8){console[_0x47b97f(0x108)](_0x47b97f(0xb7),_0x2acbc8);}}async[a8_0x56100b(0x11e)](_0x5be052,_0x537ca6){const _0x18ea0c=a8_0x56100b;try{const {telegramBotService:_0xdf1984}=await Promise['resolve']()['then'](()=>__importStar(require(_0x18ea0c(0xd7)))),_0x4a0ec3={'PAID':_0x18ea0c(0xc6),'FAILED':_0x18ea0c(0xf0)},_0x1402fb=_0x4a0ec3[_0x537ca6];if(!_0x1402fb)return;await _0xdf1984[_0x18ea0c(0xf5)](_0x5be052[_0x18ea0c(0x116)],_0x5be052,_0x1402fb);}catch(_0x2e61c3){console[_0x18ea0c(0x108)](_0x18ea0c(0xe3),_0x2e61c3);}}}exports[a8_0x56100b(0xcb)]=PaymentController;