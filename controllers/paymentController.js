'use strict';const a8_0x5569e0=a8_0x1669;function a8_0xbb26(){const _0x1d7f44=['payment.success','defineProperty','now','createdAt','1808373OUsqcD','getPaymentStatus','../services/gateways/mastercardService','application/json',',\x20cannot\x20process','7182VCxINc','../services/paymentLinkService','../config/database','323130bzxBmi','currency','handleSuccessfulPayment','createPublicPayment','\x20with\x20status\x20','üí≥\x20Card\x20holder:\x20','3DS\x20verification\x20required','error','üí≥\x20Browser\x20IP:\x20','parse','Error\x20parsing\x20webhook\x20events:','hasOwnProperty','MasterCard\x20webhook\x20sent\x20to\x20','getOwnPropertyNames','customerCountry','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','145700cSrAmN','processCardPayment','gateway_payment_id','cardLast4','toISOString','üí≥\x20MasterCard\x20result:','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','WebhookService','‚úÖ\x20MasterCard\x20payment\x20','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','PENDING','payment.failed','system','replace','Payment\x20status\x20is\x20','753XdMxBQ','__createBinding','updatePaymentCustomer','Customer\x20data\x20updated\x20successfully','failed','log','payment','email','webhookUrl','Payment\x20not\x20found','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','gateway','last_name','POST','length','__esModule','first_name','paidAt','PaymentController','customerUa','../services/telegramBotService','configurable','FAILED','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','getPaymentById','webhookEvents','status','shopId','../services/webhookService','MasterCardService','üí≥\x20Processing\x20MasterCard\x20payment:\x20','1111','shop','isArray','174XPbqsx','params','47367Acjuoj','Card\x20payment\x20failed','failureMessage','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','Payment\x20failed','masterCardService','json','webhookLog','customerName','updatedAt','2085salDNx','sendShopWebhook','mastercard','584WEODqv','../services/paymentService','PaymentService','then','settings','get','PAID','create','requires_3ds','call','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','threeds_url','Payment\x20created\x20successfully','resolve','body','Failed\x20to\x20send\x20MasterCard\x20webhook:','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerEmail','webhookService','stringify','gatewayPaymentId','ms)','Webhook\x20event\x20','paymentMethod','user_agent','sendPaymentNotification','129043gzxioQ','successUrl','üìù\x20Customer\x20data:','paymentService','default','update','https://api.trapay.uk/api/webhooks/gateway/mastercard','number','includes'];a8_0xbb26=function(){return _0x1d7f44;};return a8_0xbb26();}(function(_0x6b05f,_0x231f1b){const _0x4cf026=a8_0x1669,_0x389b12=_0x6b05f();while(!![]){try{const _0x1ee230=parseInt(_0x4cf026(0x14a))/0x1+parseInt(_0x4cf026(0x121))/0x2*(-parseInt(_0x4cf026(0xff))/0x3)+parseInt(_0x4cf026(0xf0))/0x4+parseInt(_0x4cf026(0x12d))/0x5*(-parseInt(_0x4cf026(0xdd))/0x6)+parseInt(_0x4cf026(0xd8))/0x7+-parseInt(_0x4cf026(0x130))/0x8*(-parseInt(_0x4cf026(0x123))/0x9)+-parseInt(_0x4cf026(0xe0))/0xa;if(_0x1ee230===_0x231f1b)break;else _0x389b12['push'](_0x389b12['shift']());}catch(_0x40b51b){_0x389b12['push'](_0x389b12['shift']());}}}(a8_0xbb26,0x3e2f3));var __createBinding=this&&this[a8_0x5569e0(0x100)]||(Object[a8_0x5569e0(0x137)]?function(_0x5b3d57,_0x9d623e,_0x4273a1,_0x1557fb){const _0x23def3=a8_0x5569e0;if(_0x1557fb===undefined)_0x1557fb=_0x4273a1;var _0x226f64=Object['getOwnPropertyDescriptor'](_0x9d623e,_0x4273a1);(!_0x226f64||(_0x23def3(0x135)in _0x226f64?!_0x9d623e[_0x23def3(0x10e)]:_0x226f64['writable']||_0x226f64[_0x23def3(0x114)]))&&(_0x226f64={'enumerable':!![],'get':function(){return _0x9d623e[_0x4273a1];}}),Object[_0x23def3(0xd5)](_0x5b3d57,_0x1557fb,_0x226f64);}:function(_0x411d8f,_0x4ee980,_0x2b32da,_0x3eb46e){if(_0x3eb46e===undefined)_0x3eb46e=_0x2b32da;_0x411d8f[_0x3eb46e]=_0x4ee980[_0x2b32da];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x5569e0(0x137)]?function(_0x2c1784,_0x43bd28){const _0x33c914=a8_0x5569e0;Object['defineProperty'](_0x2c1784,_0x33c914(0xcf),{'enumerable':!![],'value':_0x43bd28});}:function(_0x2d4f8d,_0x26a6d4){_0x2d4f8d['default']=_0x26a6d4;}),__importStar=this&&this['__importStar']||(function(){var _0x32aa97=function(_0xcaa08f){const _0x2d7217=a8_0x1669;return _0x32aa97=Object[_0x2d7217(0xed)]||function(_0x3b163e){const _0x255b0a=_0x2d7217;var _0x279a1c=[];for(var _0xe3b94b in _0x3b163e)if(Object['prototype'][_0x255b0a(0xeb)][_0x255b0a(0x139)](_0x3b163e,_0xe3b94b))_0x279a1c[_0x279a1c[_0x255b0a(0x10d)]]=_0xe3b94b;return _0x279a1c;},_0x32aa97(_0xcaa08f);};return function(_0x45fa46){const _0x599070=a8_0x1669;if(_0x45fa46&&_0x45fa46[_0x599070(0x10e)])return _0x45fa46;var _0x514b72={};if(_0x45fa46!=null){for(var _0x5ba261=_0x32aa97(_0x45fa46),_0x5011a8=0x0;_0x5011a8<_0x5ba261[_0x599070(0x10d)];_0x5011a8++)if(_0x5ba261[_0x5011a8]!==_0x599070(0xcf))__createBinding(_0x514b72,_0x45fa46,_0x5ba261[_0x5011a8]);}return __setModuleDefault(_0x514b72,_0x45fa46),_0x514b72;};}()),__importDefault=this&&this['__importDefault']||function(_0x36cc12){const _0x5ac090=a8_0x5569e0;return _0x36cc12&&_0x36cc12[_0x5ac090(0x10e)]?_0x36cc12:{'default':_0x36cc12};};function a8_0x1669(_0x1e2cc9,_0x446e33){const _0xbb26d=a8_0xbb26();return a8_0x1669=function(_0x166953,_0x43ca04){_0x166953=_0x166953-0xcd;let _0x2fa8dc=_0xbb26d[_0x166953];return _0x2fa8dc;},a8_0x1669(_0x1e2cc9,_0x446e33);}Object['defineProperty'](exports,a8_0x5569e0(0x10e),{'value':!![]}),exports[a8_0x5569e0(0x111)]=void 0x0;const paymentService_1=require(a8_0x5569e0(0x131)),mastercardService_1=require(a8_0x5569e0(0xda)),webhookService_1=require(a8_0x5569e0(0x11b)),database_1=__importDefault(require(a8_0x5569e0(0xdf)));class PaymentController{constructor(){const _0x260e7c=a8_0x5569e0;this[_0x260e7c(0xe3)]=async(_0x34a71a,_0x28edd2,_0x1ba67d)=>{const _0x4dd931=_0x260e7c;try{const _0x2c0648=_0x34a71a[_0x4dd931(0x13e)],_0x2d5d46=await this[_0x4dd931(0xce)][_0x4dd931(0xe3)](_0x2c0648);_0x28edd2[_0x4dd931(0x119)](0xc9)[_0x4dd931(0x129)]({'success':!![],'message':_0x4dd931(0x13c),'result':_0x2d5d46});}catch(_0x220cd1){_0x1ba67d(_0x220cd1);}},this[_0x260e7c(0xd9)]=async(_0x46b8da,_0x52578c,_0x388851)=>{const _0x3aba8b=_0x260e7c;try{const {id:_0x16ffc3}=_0x46b8da[_0x3aba8b(0x122)],_0x52e16e=await this[_0x3aba8b(0xce)]['getPaymentStatus'](_0x16ffc3);if(!_0x52e16e)return _0x52578c['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x52578c['json']({'success':!![],'result':_0x52e16e});}catch(_0x287ce8){_0x388851(_0x287ce8);}},this[_0x260e7c(0x117)]=async(_0x4d356d,_0x13edf4,_0x55331a)=>{const _0x31e7f6=_0x260e7c;try{const {id:_0x23f111}=_0x4d356d[_0x31e7f6(0x122)],_0x5f5b01=await this['paymentService'][_0x31e7f6(0x117)](_0x23f111);if(!_0x5f5b01)return _0x13edf4[_0x31e7f6(0x119)](0x194)[_0x31e7f6(0x129)]({'success':![],'message':_0x31e7f6(0x108)});_0x13edf4['json']({'success':!![],'result':_0x5f5b01});}catch(_0x356388){_0x55331a(_0x356388);}},this[_0x260e7c(0x101)]=async(_0x3d37b3,_0x196de6,_0x78944f)=>{const _0x5c3580=_0x260e7c;try{const {id:_0x4eb353}=_0x3d37b3[_0x5c3580(0x122)],_0x556355=_0x3d37b3[_0x5c3580(0x13e)];console['log'](_0x5c3580(0xf6)+_0x4eb353),console[_0x5c3580(0x104)](_0x5c3580(0xcd),_0x556355);const _0xdedb00=await this[_0x5c3580(0xce)]['updatePaymentCustomerDataPublic'](_0x4eb353,_0x556355);if(!_0xdedb00)return _0x196de6['status'](0x194)['json']({'success':![],'message':_0x5c3580(0x108)});_0x196de6[_0x5c3580(0x129)]({'success':!![],'message':_0x5c3580(0x102),'result':{'paymentId':_0xdedb00['id'],'customerIp':_0xdedb00['customerIp'],'customerUa':_0xdedb00[_0x5c3580(0x112)],'customerCountry':_0xdedb00[_0x5c3580(0xee)],'updatedAt':_0xdedb00[_0x5c3580(0x12c)]}});}catch(_0x222c84){_0x78944f(_0x222c84);}},this['processMasterCardPayment']=async(_0x151195,_0xb4dbd8,_0x32f09f)=>{const _0x1c9ab7=_0x260e7c;try{const {id:_0x1bcf03}=_0x151195[_0x1c9ab7(0x122)],{cardData:_0x4578c4,cardHolder:_0x49d161,browser:_0x42fee9}=_0x151195[_0x1c9ab7(0x13e)];console['log'](_0x1c9ab7(0x11d)+_0x1bcf03),console[_0x1c9ab7(0x104)](_0x1c9ab7(0xe5)+_0x49d161['first_name']+'\x20'+_0x49d161[_0x1c9ab7(0x10b)]+'\x20('+_0x49d161[_0x1c9ab7(0x106)]+')'),console['log'](_0x1c9ab7(0xe8)+_0x42fee9['ip']);const _0x4a41c2={'customerName':_0x49d161[_0x1c9ab7(0x10f)]+'\x20'+_0x49d161[_0x1c9ab7(0x10b)],'customerEmail':_0x49d161[_0x1c9ab7(0x106)],'customerIp':_0x42fee9['ip'],'customerUa':_0x42fee9[_0x1c9ab7(0x148)]},_0x313de7=await database_1['default']['payment']['findUnique']({'where':{'id':_0x1bcf03},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x313de7)return _0xb4dbd8[_0x1c9ab7(0x119)](0x194)[_0x1c9ab7(0x129)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x313de7[_0x1c9ab7(0x10a)]!==_0x1c9ab7(0x12f))return _0xb4dbd8[_0x1c9ab7(0x119)](0x190)[_0x1c9ab7(0x129)]({'success':![],'message':_0x1c9ab7(0x116)});if(_0x313de7[_0x1c9ab7(0x119)]!==_0x1c9ab7(0xfa))return _0xb4dbd8[_0x1c9ab7(0x119)](0x190)[_0x1c9ab7(0x129)]({'success':![],'message':_0x1c9ab7(0xfe)+_0x313de7[_0x1c9ab7(0x119)]+_0x1c9ab7(0xdc)});await database_1[_0x1c9ab7(0xcf)][_0x1c9ab7(0x105)][_0x1c9ab7(0xd0)]({'where':{'id':_0x1bcf03},'data':{..._0x4a41c2,'updatedAt':new Date()}});const _0x591b44=_0x1c9ab7(0xd1),_0x52931e=_0x313de7[_0x1c9ab7(0x14b)];console[_0x1c9ab7(0x104)]('üí≥\x20MasterCard\x20URLs:'),console['log']('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x591b44),console[_0x1c9ab7(0x104)]('\x20\x20\x20Return\x20URL:\x20'+_0x52931e);const _0x2693bd={'first_name':_0x49d161['first_name'],'last_name':_0x49d161[_0x1c9ab7(0x10b)],'email':_0x49d161[_0x1c9ab7(0x106)]},_0x417736=await this[_0x1c9ab7(0x128)][_0x1c9ab7(0xf1)]({'paymentId':_0x313de7['id'],'orderId':_0x313de7['gatewayOrderId']||_0x313de7['id'],'amount':_0x313de7['amount'],'currency':_0x313de7[_0x1c9ab7(0xe1)],'cardData':_0x4578c4,'resultUrl':_0x591b44,'returnUrl':_0x52931e,'cardHolder':_0x2693bd,'browser':_0x42fee9});console['log'](_0x1c9ab7(0xf5),_0x417736);const _0x55033a={'status':_0x417736[_0x1c9ab7(0x119)],'updatedAt':new Date(),'statusChangedBy':_0x1c9ab7(0xfc),'statusChangedAt':new Date()};_0x417736[_0x1c9ab7(0xf2)]&&(_0x55033a[_0x1c9ab7(0x144)]=_0x417736['gateway_payment_id'],console[_0x1c9ab7(0x104)](_0x1c9ab7(0x126)+_0x417736['gateway_payment_id']));if(_0x417736[_0x1c9ab7(0x119)]==='PAID')_0x55033a[_0x1c9ab7(0x110)]=new Date();else _0x417736[_0x1c9ab7(0x119)]===_0x1c9ab7(0x115)&&(_0x55033a[_0x1c9ab7(0x125)]=_0x1c9ab7(0x124));_0x55033a[_0x1c9ab7(0x147)]=_0x1c9ab7(0x12f);if(_0x4578c4[_0x1c9ab7(0xd2)]){const _0x1cf750=_0x4578c4[_0x1c9ab7(0xd2)][_0x1c9ab7(0xfd)](/[\s-]/g,'');_0x55033a[_0x1c9ab7(0xf3)]=_0x1cf750['slice'](-0x4),console['log'](_0x1c9ab7(0x13a)+_0x55033a[_0x1c9ab7(0xf3)]);}await database_1['default'][_0x1c9ab7(0x105)][_0x1c9ab7(0xd0)]({'where':{'id':_0x313de7['id']},'data':_0x55033a}),await database_1['default'][_0x1c9ab7(0x12a)][_0x1c9ab7(0x137)]({'data':{'paymentId':_0x313de7['id'],'shopId':_0x313de7['shopId'],'event':'mastercard_'+_0x417736[_0x1c9ab7(0x119)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1c9ab7(0xfa),'newStatus':_0x417736['status'],'gatewayPaymentId':_0x417736[_0x1c9ab7(0xf2)],'requires3ds':_0x417736[_0x1c9ab7(0x138)],'processedAt':new Date()[_0x1c9ab7(0xf4)]()})}});if(_0x417736['final']){await this[_0x1c9ab7(0x12e)](_0x313de7,_0x417736[_0x1c9ab7(0x119)],_0x417736['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x313de7,_0x417736['status']);if(_0x417736['status']===_0x1c9ab7(0x136)){console['log']('üìà\x20MasterCard\x20payment\x20'+_0x1bcf03+_0x1c9ab7(0x109));try{const {PaymentLinkService:_0x10e7da}=await Promise['resolve']()[_0x1c9ab7(0x133)](()=>__importStar(require(_0x1c9ab7(0xde)))),_0x29eeb9=new _0x10e7da();await _0x29eeb9[_0x1c9ab7(0xe2)](_0x1bcf03),console['log'](_0x1c9ab7(0xef)+_0x1bcf03);}catch(_0x5b76e9){console[_0x1c9ab7(0xe7)](_0x1c9ab7(0xf9),_0x5b76e9);}}}console[_0x1c9ab7(0x104)](_0x1c9ab7(0xf8)+_0x1bcf03+'\x20processed:\x20'+_0x417736[_0x1c9ab7(0x119)]);if(_0x417736[_0x1c9ab7(0x119)]===_0x1c9ab7(0x136))_0xb4dbd8[_0x1c9ab7(0x129)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1c9ab7(0x136),'gatewayPaymentId':_0x417736['gateway_payment_id'],'redirectUrl':_0x52931e,'final':!![]}});else _0x417736[_0x1c9ab7(0x138)]&&_0x417736[_0x1c9ab7(0x13b)]?_0xb4dbd8['json']({'success':!![],'message':_0x1c9ab7(0xe6),'result':{'status':_0x1c9ab7(0xfa),'gatewayPaymentId':_0x417736['gateway_payment_id'],'redirectUrl':_0x417736[_0x1c9ab7(0x13b)],'requires3ds':!![],'final':![]}}):_0xb4dbd8[_0x1c9ab7(0x119)](0x190)[_0x1c9ab7(0x129)]({'success':![],'message':_0x1c9ab7(0x127),'result':{'status':_0x1c9ab7(0x115),'gatewayPaymentId':_0x417736[_0x1c9ab7(0xf2)],'redirectUrl':_0x313de7['failUrl'],'final':!![]}});}catch(_0x4239eb){_0x32f09f(_0x4239eb);}},this[_0x260e7c(0xce)]=new paymentService_1[(_0x260e7c(0x132))](),this['masterCardService']=new mastercardService_1[(_0x260e7c(0x11c))](),this[_0x260e7c(0x142)]=new webhookService_1[(_0x260e7c(0xf7))]();}async['sendShopWebhook'](_0x38bbcc,_0x2b6539,_0x2cbb6c){const _0x547ac1=a8_0x5569e0,_0x253d09=Date[_0x547ac1(0xd6)]();try{const _0x3ef1ad=_0x38bbcc[_0x547ac1(0x11f)],_0x5a21d1=_0x3ef1ad[_0x547ac1(0x134)];if(!_0x5a21d1?.[_0x547ac1(0x107)]){console[_0x547ac1(0x104)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3ef1ad['id']);return;}const _0x16450a=_0x2b6539===_0x547ac1(0x136)?_0x547ac1(0xd4):_0x547ac1(0xfb);let _0x433235=[];if(_0x5a21d1[_0x547ac1(0x118)])try{_0x433235=Array[_0x547ac1(0x120)](_0x5a21d1[_0x547ac1(0x118)])?_0x5a21d1[_0x547ac1(0x118)]:JSON[_0x547ac1(0xe9)](_0x5a21d1['webhookEvents']);}catch(_0xadc79b){console[_0x547ac1(0xe7)](_0x547ac1(0xea),_0xadc79b),_0x433235=[];}if(!_0x433235[_0x547ac1(0xd3)](_0x16450a)){console[_0x547ac1(0x104)](_0x547ac1(0x146)+_0x16450a+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3ef1ad['id']);return;}const _0x4cf673={'event':_0x16450a,'payment':{'id':_0x38bbcc['id'],'order_id':_0x38bbcc['orderId'],'gateway_order_id':_0x38bbcc['gatewayOrderId'],'gateway':_0x547ac1(0x11e),'amount':_0x38bbcc['amount'],'currency':_0x38bbcc[_0x547ac1(0xe1)],'status':_0x2b6539['toLowerCase'](),'customer_email':_0x38bbcc[_0x547ac1(0x141)],'customer_name':_0x38bbcc[_0x547ac1(0x12b)],'gateway_payment_id':_0x2cbb6c,'created_at':_0x38bbcc[_0x547ac1(0xd7)],'updated_at':new Date()}},_0x215e95=await fetch(_0x5a21d1[_0x547ac1(0x107)],{'method':_0x547ac1(0x10c),'headers':{'Content-Type':_0x547ac1(0xdb),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x547ac1(0x143)](_0x4cf673)}),_0x55eeb8=Date['now']()-_0x253d09;console['log'](_0x547ac1(0xec)+_0x5a21d1[_0x547ac1(0x107)]+_0x547ac1(0xe4)+_0x215e95['status']+'\x20('+_0x55eeb8+_0x547ac1(0x145));}catch(_0x4340ae){console[_0x547ac1(0xe7)](_0x547ac1(0x13f),_0x4340ae);}}async['sendPaymentStatusNotification'](_0x213751,_0x1509c8){const _0x49f1ee=a8_0x5569e0;try{const {telegramBotService:_0x31a24f}=await Promise[_0x49f1ee(0x13d)]()[_0x49f1ee(0x133)](()=>__importStar(require(_0x49f1ee(0x113)))),_0x3bd31a={'PAID':'paid','FAILED':_0x49f1ee(0x103)},_0x309af4=_0x3bd31a[_0x1509c8];if(!_0x309af4)return;await _0x31a24f[_0x49f1ee(0x149)](_0x213751[_0x49f1ee(0x11a)],_0x213751,_0x309af4);}catch(_0x7d9d64){console[_0x49f1ee(0xe7)](_0x49f1ee(0x140),_0x7d9d64);}}}exports[a8_0x5569e0(0x111)]=PaymentController;