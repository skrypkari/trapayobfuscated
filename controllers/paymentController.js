'use strict';function a8_0x8733(){const _0xf07424=['paidAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Error\x20parsing\x20webhook\x20events:','../config/database','Payment\x20status\x20is\x20','json','currency','WebhookService','\x20processed:\x20','shop','1434792TEWoyL','createdAt','Webhook\x20event\x20','error','MasterCard\x20webhook\x20sent\x20to\x20','gatewayPaymentId','application/json','sendPaymentNotification','14tiRdgc','__importDefault','__importStar','MasterCardService','defineProperty','orderId','isArray','getOwnPropertyDescriptor','log','webhookLog','3813225odHQOu','shopId','writable','hasOwnProperty','5402unMuOU','status','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','successUrl','payment.failed','failUrl','__createBinding','1111','673788MFFfks','\x20not\x20enabled\x20for\x20shop\x20','webhookService','PaymentController','webhookUrl','FAILED','PaymentService','masterCardService','ðŸ’³\x20MasterCard\x20result:','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Card\x20payment\x20failed','getPaymentStatus','requires_3ds','../services/paymentService','customerEmail','webhookEvents','toLowerCase','Payment\x20not\x20found','__esModule','\x20\x20\x20Return\x20URL:\x20','processMasterCardPayment','getOwnPropertyNames','get','POST','parse','Payment\x20created\x20successfully','params','5263890ddYNTd','Payment\x20failed','default','customerName','sendPaymentStatusNotification','failed','../services/gateways/mastercardService','processCardPayment','mastercard','ðŸ’³\x20MasterCard\x20URLs:','now','toISOString','includes','createPublicPayment','prototype','length','sendShopWebhook','3159642joNcEo','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','1232142Ckvhkw','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','PENDING','388CyPpux','gatewayOrderId','PAID','stringify','resolve','__setModuleDefault','body','gateway_payment_id','242gLUUqY','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','paid','\x20with\x20status\x20','9KcNdNs','getPaymentById','failureMessage','payment','12oHUspK','paymentService','create',',\x20cannot\x20process','threeds_url'];a8_0x8733=function(){return _0xf07424;};return a8_0x8733();}function a8_0x2fb7(_0x12d86a,_0x12a549){const _0x8733de=a8_0x8733();return a8_0x2fb7=function(_0x2fb7f4,_0x18193c){_0x2fb7f4=_0x2fb7f4-0x177;let _0x518f66=_0x8733de[_0x2fb7f4];return _0x518f66;},a8_0x2fb7(_0x12d86a,_0x12a549);}const a8_0x15a775=a8_0x2fb7;(function(_0x328e06,_0xb5ae4e){const _0x1cf5cd=a8_0x2fb7,_0x2ded9c=_0x328e06();while(!![]){try{const _0x568599=parseInt(_0x1cf5cd(0x1c0))/0x1*(-parseInt(_0x1cf5cd(0x187))/0x2)+parseInt(_0x1cf5cd(0x1bd))/0x3*(parseInt(_0x1cf5cd(0x1d0))/0x4)+parseInt(_0x1cf5cd(0x183))/0x5+parseInt(_0x1cf5cd(0x1bb))/0x6*(-parseInt(_0x1cf5cd(0x179))/0x7)+parseInt(_0x1cf5cd(0x1df))/0x8+parseInt(_0x1cf5cd(0x1cc))/0x9*(-parseInt(_0x1cf5cd(0x1aa))/0xa)+parseInt(_0x1cf5cd(0x1c8))/0xb*(parseInt(_0x1cf5cd(0x18f))/0xc);if(_0x568599===_0xb5ae4e)break;else _0x2ded9c['push'](_0x2ded9c['shift']());}catch(_0x21a64c){_0x2ded9c['push'](_0x2ded9c['shift']());}}}(a8_0x8733,0xbedff));var __createBinding=this&&this[a8_0x15a775(0x18d)]||(Object[a8_0x15a775(0x1d2)]?function(_0x15d85e,_0x35df27,_0x55de34,_0x2e2efc){const _0x2ce52f=a8_0x15a775;if(_0x2e2efc===undefined)_0x2e2efc=_0x55de34;var _0xccc939=Object[_0x2ce52f(0x180)](_0x35df27,_0x55de34);(!_0xccc939||(_0x2ce52f(0x1a5)in _0xccc939?!_0x35df27[_0x2ce52f(0x1a1)]:_0xccc939[_0x2ce52f(0x185)]||_0xccc939['configurable']))&&(_0xccc939={'enumerable':!![],'get':function(){return _0x35df27[_0x55de34];}}),Object['defineProperty'](_0x15d85e,_0x2e2efc,_0xccc939);}:function(_0x3cc0bb,_0x2d4935,_0x1c1c5e,_0x1852a){if(_0x1852a===undefined)_0x1852a=_0x1c1c5e;_0x3cc0bb[_0x1852a]=_0x2d4935[_0x1c1c5e];}),__setModuleDefault=this&&this[a8_0x15a775(0x1c5)]||(Object[a8_0x15a775(0x1d2)]?function(_0x8d50a8,_0xdce879){const _0x1632ff=a8_0x15a775;Object[_0x1632ff(0x17d)](_0x8d50a8,_0x1632ff(0x1ac),{'enumerable':!![],'value':_0xdce879});}:function(_0x5c6bd9,_0x4f7301){const _0x122c40=a8_0x15a775;_0x5c6bd9[_0x122c40(0x1ac)]=_0x4f7301;}),__importStar=this&&this[a8_0x15a775(0x17b)]||(function(){var _0x3d8c96=function(_0x3c697f){const _0x274f70=a8_0x2fb7;return _0x3d8c96=Object[_0x274f70(0x1a4)]||function(_0x8b0bef){const _0x301d86=_0x274f70;var _0x197ed8=[];for(var _0x1e874b in _0x8b0bef)if(Object[_0x301d86(0x1b8)][_0x301d86(0x186)]['call'](_0x8b0bef,_0x1e874b))_0x197ed8[_0x197ed8[_0x301d86(0x1b9)]]=_0x1e874b;return _0x197ed8;},_0x3d8c96(_0x3c697f);};return function(_0x3ac398){if(_0x3ac398&&_0x3ac398['__esModule'])return _0x3ac398;var _0x1e9a2a={};if(_0x3ac398!=null){for(var _0x559f12=_0x3d8c96(_0x3ac398),_0x5afe6c=0x0;_0x5afe6c<_0x559f12['length'];_0x5afe6c++)if(_0x559f12[_0x5afe6c]!=='default')__createBinding(_0x1e9a2a,_0x3ac398,_0x559f12[_0x5afe6c]);}return __setModuleDefault(_0x1e9a2a,_0x3ac398),_0x1e9a2a;};}()),__importDefault=this&&this[a8_0x15a775(0x17a)]||function(_0x45a2dd){const _0x351206=a8_0x15a775;return _0x45a2dd&&_0x45a2dd[_0x351206(0x1a1)]?_0x45a2dd:{'default':_0x45a2dd};};Object[a8_0x15a775(0x17d)](exports,a8_0x15a775(0x1a1),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x15a775(0x19c)),mastercardService_1=require(a8_0x15a775(0x1b0)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x15a775(0x1d8)));class PaymentController{constructor(){const _0x294a70=a8_0x15a775;this[_0x294a70(0x1b7)]=async(_0xaf42b5,_0x455ade,_0x15ac55)=>{const _0x2e9b7c=_0x294a70;try{const _0x19f19c=_0xaf42b5[_0x2e9b7c(0x1c6)],_0x268997=await this[_0x2e9b7c(0x1d1)][_0x2e9b7c(0x1b7)](_0x19f19c);_0x455ade[_0x2e9b7c(0x188)](0xc9)[_0x2e9b7c(0x1da)]({'success':!![],'message':_0x2e9b7c(0x1a8),'result':_0x268997});}catch(_0x14dce7){_0x15ac55(_0x14dce7);}},this[_0x294a70(0x19a)]=async(_0x2eae50,_0x34d24d,_0x53fe0e)=>{const _0x2fc34c=_0x294a70;try{const {id:_0x2a8402}=_0x2eae50[_0x2fc34c(0x1a9)],_0x4cbb73=await this[_0x2fc34c(0x1d1)][_0x2fc34c(0x19a)](_0x2a8402);if(!_0x4cbb73)return _0x34d24d['status'](0x194)['json']({'success':![],'message':_0x2fc34c(0x1a0)});_0x34d24d['json']({'success':!![],'result':_0x4cbb73});}catch(_0x20b7ab){_0x53fe0e(_0x20b7ab);}},this[_0x294a70(0x1cd)]=async(_0xe584e5,_0x2c5f97,_0x1877b9)=>{const _0xc33c51=_0x294a70;try{const {id:_0x3d12fa}=_0xe584e5[_0xc33c51(0x1a9)],_0x5154ba=await this[_0xc33c51(0x1d1)][_0xc33c51(0x1cd)](_0x3d12fa);if(!_0x5154ba)return _0x2c5f97['status'](0x194)['json']({'success':![],'message':_0xc33c51(0x1a0)});_0x2c5f97[_0xc33c51(0x1da)]({'success':!![],'result':_0x5154ba});}catch(_0x304b9a){_0x1877b9(_0x304b9a);}},this[_0x294a70(0x1a3)]=async(_0x185db7,_0x1be562,_0x5043a1)=>{const _0x23bef8=_0x294a70;try{const {id:_0x5f55d0}=_0x185db7['params'],{cardData:_0x251987,cardHolder:_0x558200,browser:_0x25c007}=_0x185db7['body'];console[_0x23bef8(0x181)](_0x23bef8(0x1c9)+_0x5f55d0);const _0x57a18d=await database_1[_0x23bef8(0x1ac)][_0x23bef8(0x1cf)]['findUnique']({'where':{'id':_0x5f55d0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x57a18d)return _0x1be562[_0x23bef8(0x188)](0x194)[_0x23bef8(0x1da)]({'success':![],'message':_0x23bef8(0x1a0)});if(_0x57a18d['gateway']!==_0x23bef8(0x1b2))return _0x1be562['status'](0x190)[_0x23bef8(0x1da)]({'success':![],'message':_0x23bef8(0x189)});if(_0x57a18d['status']!==_0x23bef8(0x1bf))return _0x1be562[_0x23bef8(0x188)](0x190)[_0x23bef8(0x1da)]({'success':![],'message':_0x23bef8(0x1d9)+_0x57a18d[_0x23bef8(0x188)]+_0x23bef8(0x1d3)});const _0x98b7ff=_0x23bef8(0x1bc),_0x16b76f=_0x57a18d[_0x23bef8(0x18a)];console[_0x23bef8(0x181)](_0x23bef8(0x1b3)),console[_0x23bef8(0x181)](_0x23bef8(0x198)+_0x98b7ff),console[_0x23bef8(0x181)](_0x23bef8(0x1a2)+_0x16b76f);const _0x48d52e=await this[_0x23bef8(0x196)][_0x23bef8(0x1b1)]({'paymentId':_0x57a18d['id'],'orderId':_0x57a18d[_0x23bef8(0x1c1)]||_0x57a18d['id'],'amount':_0x57a18d['amount'],'currency':_0x57a18d['currency'],'cardData':_0x251987,'resultUrl':_0x98b7ff,'returnUrl':_0x16b76f,'cardHolder':_0x558200,'browser':_0x25c007});console['log'](_0x23bef8(0x197),_0x48d52e);const _0x1e2085={'status':_0x48d52e[_0x23bef8(0x188)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x48d52e['status']===_0x23bef8(0x1c2))_0x1e2085[_0x23bef8(0x1d5)]=new Date(),_0x1e2085[_0x23bef8(0x1e4)]=_0x48d52e['gateway_payment_id'];else _0x48d52e[_0x23bef8(0x188)]===_0x23bef8(0x194)&&(_0x1e2085[_0x23bef8(0x1ce)]=_0x23bef8(0x199));_0x1e2085['paymentMethod']=_0x23bef8(0x1b2),await database_1[_0x23bef8(0x1ac)]['payment']['update']({'where':{'id':_0x57a18d['id']},'data':_0x1e2085}),await database_1[_0x23bef8(0x1ac)][_0x23bef8(0x182)][_0x23bef8(0x1d2)]({'data':{'paymentId':_0x57a18d['id'],'shopId':_0x57a18d[_0x23bef8(0x184)],'event':'mastercard_'+_0x48d52e[_0x23bef8(0x188)]?.[_0x23bef8(0x19f)](),'statusCode':0xc8,'responseBody':JSON[_0x23bef8(0x1c3)]({'oldStatus':_0x23bef8(0x1bf),'newStatus':_0x48d52e[_0x23bef8(0x188)],'gatewayPaymentId':_0x48d52e[_0x23bef8(0x1c7)],'requires3ds':_0x48d52e['requires_3ds'],'processedAt':new Date()[_0x23bef8(0x1b5)]()})}});_0x48d52e['final']&&(await this[_0x23bef8(0x1ba)](_0x57a18d,_0x48d52e[_0x23bef8(0x188)],_0x48d52e[_0x23bef8(0x1c7)]),await this[_0x23bef8(0x1ae)](_0x57a18d,_0x48d52e[_0x23bef8(0x188)]));console[_0x23bef8(0x181)]('âœ…\x20MasterCard\x20payment\x20'+_0x5f55d0+_0x23bef8(0x1dd)+_0x48d52e['status']);if(_0x48d52e[_0x23bef8(0x188)]===_0x23bef8(0x1c2))_0x1be562[_0x23bef8(0x1da)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x23bef8(0x1c2),'gatewayPaymentId':_0x48d52e['gateway_payment_id'],'redirectUrl':_0x16b76f,'final':!![]}});else _0x48d52e[_0x23bef8(0x19b)]&&_0x48d52e[_0x23bef8(0x1d4)]?_0x1be562[_0x23bef8(0x1da)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x23bef8(0x1bf),'gatewayPaymentId':_0x48d52e['gateway_payment_id'],'redirectUrl':_0x48d52e[_0x23bef8(0x1d4)],'requires3ds':!![],'final':![]}}):_0x1be562[_0x23bef8(0x188)](0x190)[_0x23bef8(0x1da)]({'success':![],'message':_0x23bef8(0x1ab),'result':{'status':_0x23bef8(0x194),'gatewayPaymentId':_0x48d52e[_0x23bef8(0x1c7)],'redirectUrl':_0x57a18d[_0x23bef8(0x18c)],'final':!![]}});}catch(_0x2ad6fa){_0x5043a1(_0x2ad6fa);}},this[_0x294a70(0x1d1)]=new paymentService_1[(_0x294a70(0x195))](),this[_0x294a70(0x196)]=new mastercardService_1[(_0x294a70(0x17c))](),this[_0x294a70(0x191)]=new webhookService_1[(_0x294a70(0x1dc))]();}async['sendShopWebhook'](_0x3c4c27,_0x47fe62,_0x22771c){const _0x7e85b9=a8_0x15a775,_0xafaeba=Date[_0x7e85b9(0x1b4)]();try{const _0x3e7d0b=_0x3c4c27[_0x7e85b9(0x1de)],_0x1db170=_0x3e7d0b['settings'];if(!_0x1db170?.[_0x7e85b9(0x193)]){console[_0x7e85b9(0x181)](_0x7e85b9(0x1d6)+_0x3e7d0b['id']);return;}const _0x1d3f23=_0x47fe62===_0x7e85b9(0x1c2)?'payment.success':_0x7e85b9(0x18b);let _0x384919=[];if(_0x1db170[_0x7e85b9(0x19e)])try{_0x384919=Array[_0x7e85b9(0x17f)](_0x1db170[_0x7e85b9(0x19e)])?_0x1db170['webhookEvents']:JSON[_0x7e85b9(0x1a7)](_0x1db170[_0x7e85b9(0x19e)]);}catch(_0x1844e3){console[_0x7e85b9(0x1e2)](_0x7e85b9(0x1d7),_0x1844e3),_0x384919=[];}if(!_0x384919[_0x7e85b9(0x1b6)](_0x1d3f23)){console['log'](_0x7e85b9(0x1e1)+_0x1d3f23+_0x7e85b9(0x190)+_0x3e7d0b['id']);return;}const _0x2ca7c5={'event':_0x1d3f23,'payment':{'id':_0x3c4c27['id'],'order_id':_0x3c4c27[_0x7e85b9(0x17e)],'gateway_order_id':_0x3c4c27[_0x7e85b9(0x1c1)],'gateway':_0x7e85b9(0x18e),'amount':_0x3c4c27['amount'],'currency':_0x3c4c27[_0x7e85b9(0x1db)],'status':_0x47fe62[_0x7e85b9(0x19f)](),'customer_email':_0x3c4c27[_0x7e85b9(0x19d)],'customer_name':_0x3c4c27[_0x7e85b9(0x1ad)],'gateway_payment_id':_0x22771c,'created_at':_0x3c4c27[_0x7e85b9(0x1e0)],'updated_at':new Date()}},_0x44a487=await fetch(_0x1db170[_0x7e85b9(0x193)],{'method':_0x7e85b9(0x1a6),'headers':{'Content-Type':_0x7e85b9(0x177),'User-Agent':_0x7e85b9(0x1be)},'body':JSON[_0x7e85b9(0x1c3)](_0x2ca7c5)}),_0x18e577=Date[_0x7e85b9(0x1b4)]()-_0xafaeba;console[_0x7e85b9(0x181)](_0x7e85b9(0x1e3)+_0x1db170['webhookUrl']+_0x7e85b9(0x1cb)+_0x44a487[_0x7e85b9(0x188)]+'\x20('+_0x18e577+'ms)');}catch(_0x5e2e61){console[_0x7e85b9(0x1e2)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x5e2e61);}}async[a8_0x15a775(0x1ae)](_0x425944,_0x48f9a3){const _0x3aca10=a8_0x15a775;try{const {telegramBotService:_0x40d85a}=await Promise[_0x3aca10(0x1c4)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x290c69={'PAID':_0x3aca10(0x1ca),'FAILED':_0x3aca10(0x1af)},_0x117028=_0x290c69[_0x48f9a3];if(!_0x117028)return;await _0x40d85a[_0x3aca10(0x178)](_0x425944['shopId'],_0x425944,_0x117028);}catch(_0x123346){console[_0x3aca10(0x1e2)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x123346);}}}exports[a8_0x15a775(0x192)]=PaymentController;