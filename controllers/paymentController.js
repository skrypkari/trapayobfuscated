'use strict';const a8_0x53ba5e=a8_0x25dc;function a8_0x25dc(_0x585cfa,_0x288f7c){const _0x3654fb=a8_0x3654();return a8_0x25dc=function(_0x25dc9a,_0x54ad90){_0x25dc9a=_0x25dc9a-0x159;let _0x528fe1=_0x3654fb[_0x25dc9a];return _0x528fe1;},a8_0x25dc(_0x585cfa,_0x288f7c);}(function(_0x583b13,_0x35003c){const _0x461c88=a8_0x25dc,_0x1f25ba=_0x583b13();while(!![]){try{const _0x529e83=-parseInt(_0x461c88(0x16b))/0x1+parseInt(_0x461c88(0x1a9))/0x2+-parseInt(_0x461c88(0x16e))/0x3*(parseInt(_0x461c88(0x180))/0x4)+parseInt(_0x461c88(0x162))/0x5+parseInt(_0x461c88(0x16a))/0x6+-parseInt(_0x461c88(0x1c4))/0x7*(parseInt(_0x461c88(0x166))/0x8)+parseInt(_0x461c88(0x17e))/0x9;if(_0x529e83===_0x35003c)break;else _0x1f25ba['push'](_0x1f25ba['shift']());}catch(_0x1598b8){_0x1f25ba['push'](_0x1f25ba['shift']());}}}(a8_0x3654,0xa450d));var __createBinding=this&&this[a8_0x53ba5e(0x181)]||(Object['create']?function(_0x2e843b,_0x447025,_0x5bddca,_0x171dc1){const _0x53d283=a8_0x53ba5e;if(_0x171dc1===undefined)_0x171dc1=_0x5bddca;var _0x10c7ab=Object[_0x53d283(0x17c)](_0x447025,_0x5bddca);(!_0x10c7ab||('get'in _0x10c7ab?!_0x447025['__esModule']:_0x10c7ab[_0x53d283(0x191)]||_0x10c7ab[_0x53d283(0x173)]))&&(_0x10c7ab={'enumerable':!![],'get':function(){return _0x447025[_0x5bddca];}}),Object[_0x53d283(0x1a0)](_0x2e843b,_0x171dc1,_0x10c7ab);}:function(_0x520ea2,_0x52e373,_0x2e5534,_0x5ea18b){if(_0x5ea18b===undefined)_0x5ea18b=_0x2e5534;_0x520ea2[_0x5ea18b]=_0x52e373[_0x2e5534];}),__setModuleDefault=this&&this[a8_0x53ba5e(0x1c0)]||(Object[a8_0x53ba5e(0x1b8)]?function(_0x1ea904,_0x47f5ff){const _0x597ee5=a8_0x53ba5e;Object[_0x597ee5(0x1a0)](_0x1ea904,_0x597ee5(0x15b),{'enumerable':!![],'value':_0x47f5ff});}:function(_0x395d98,_0x11a19b){const _0xa0d573=a8_0x53ba5e;_0x395d98[_0xa0d573(0x15b)]=_0x11a19b;}),__importStar=this&&this[a8_0x53ba5e(0x17b)]||(function(){var _0x1096df=function(_0xda6b34){const _0x5d5310=a8_0x25dc;return _0x1096df=Object[_0x5d5310(0x186)]||function(_0x1774e3){const _0x48bff6=_0x5d5310;var _0x4e322a=[];for(var _0x4d3ccd in _0x1774e3)if(Object['prototype'][_0x48bff6(0x17d)][_0x48bff6(0x1ac)](_0x1774e3,_0x4d3ccd))_0x4e322a[_0x4e322a[_0x48bff6(0x15d)]]=_0x4d3ccd;return _0x4e322a;},_0x1096df(_0xda6b34);};return function(_0x2210d9){const _0x105162=a8_0x25dc;if(_0x2210d9&&_0x2210d9[_0x105162(0x1bf)])return _0x2210d9;var _0x20c983={};if(_0x2210d9!=null){for(var _0x99e48=_0x1096df(_0x2210d9),_0x335c69=0x0;_0x335c69<_0x99e48[_0x105162(0x15d)];_0x335c69++)if(_0x99e48[_0x335c69]!==_0x105162(0x15b))__createBinding(_0x20c983,_0x2210d9,_0x99e48[_0x335c69]);}return __setModuleDefault(_0x20c983,_0x2210d9),_0x20c983;};}()),__importDefault=this&&this[a8_0x53ba5e(0x19e)]||function(_0x471bde){const _0x1346bf=a8_0x53ba5e;return _0x471bde&&_0x471bde[_0x1346bf(0x1bf)]?_0x471bde:{'default':_0x471bde};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x53ba5e(0x169)),mastercardService_1=require(a8_0x53ba5e(0x18b)),webhookService_1=require(a8_0x53ba5e(0x1aa)),database_1=__importDefault(require(a8_0x53ba5e(0x1a1)));class PaymentController{constructor(){const _0x3321cb=a8_0x53ba5e;this['createPublicPayment']=async(_0x3cc851,_0x405804,_0x1208d1)=>{const _0x2ebe16=a8_0x25dc;try{const _0xead5fc=_0x3cc851['body'],_0x122404=await this[_0x2ebe16(0x19a)]['createPublicPayment'](_0xead5fc);_0x405804[_0x2ebe16(0x17a)](0xc9)['json']({'success':!![],'message':_0x2ebe16(0x198),'result':_0x122404});}catch(_0x240ab6){_0x1208d1(_0x240ab6);}},this['getPaymentStatus']=async(_0x5d5ce9,_0x1d9b93,_0x57d239)=>{const _0x361dd2=a8_0x25dc;try{const {id:_0x1438da}=_0x5d5ce9[_0x361dd2(0x16c)],_0x2f6ff4=await this[_0x361dd2(0x19a)][_0x361dd2(0x18d)](_0x1438da);if(!_0x2f6ff4)return _0x1d9b93[_0x361dd2(0x17a)](0x194)[_0x361dd2(0x1b5)]({'success':![],'message':_0x361dd2(0x1a8)});_0x1d9b93['json']({'success':!![],'result':_0x2f6ff4});}catch(_0x3d9eed){_0x57d239(_0x3d9eed);}},this[_0x3321cb(0x1c2)]=async(_0x36920e,_0x40a2a7,_0x1e8eaa)=>{const _0x2f7a47=_0x3321cb;try{const {id:_0x20b691}=_0x36920e[_0x2f7a47(0x16c)],_0x28be8e=await this[_0x2f7a47(0x19a)]['getPaymentById'](_0x20b691);if(!_0x28be8e)return _0x40a2a7[_0x2f7a47(0x17a)](0x194)[_0x2f7a47(0x1b5)]({'success':![],'message':_0x2f7a47(0x1a8)});_0x40a2a7[_0x2f7a47(0x1b5)]({'success':!![],'result':_0x28be8e});}catch(_0x5a758a){_0x1e8eaa(_0x5a758a);}},this[_0x3321cb(0x1b4)]=async(_0x4d1326,_0x1ed2f8,_0x105eb2)=>{const _0xce9480=_0x3321cb;try{const {id:_0x255b29}=_0x4d1326[_0xce9480(0x16c)],_0x331889=_0x4d1326['body'];console[_0xce9480(0x1bb)](_0xce9480(0x1ba)+_0x255b29),console[_0xce9480(0x1bb)](_0xce9480(0x194),_0x331889);const _0x3fad23=await this[_0xce9480(0x19a)][_0xce9480(0x1bd)](_0x255b29,_0x331889);if(!_0x3fad23)return _0x1ed2f8[_0xce9480(0x17a)](0x194)[_0xce9480(0x1b5)]({'success':![],'message':_0xce9480(0x1a8)});_0x1ed2f8[_0xce9480(0x1b5)]({'success':!![],'message':_0xce9480(0x161),'result':{'paymentId':_0x3fad23['id'],'customerIp':_0x3fad23[_0xce9480(0x1be)],'customerUa':_0x3fad23['customerUa'],'customerCountry':_0x3fad23[_0xce9480(0x1ab)],'updatedAt':_0x3fad23['updatedAt']}});}catch(_0x1ef28b){_0x105eb2(_0x1ef28b);}},this[_0x3321cb(0x163)]=async(_0x6c1a95,_0x2248d9,_0x497ba3)=>{const _0x45c52c=_0x3321cb;try{const {id:_0x2df7ee}=_0x6c1a95['params'],{cardData:_0x62738,cardHolder:_0x2527a0,browser:_0x36ec67}=_0x6c1a95[_0x45c52c(0x18f)];console[_0x45c52c(0x1bb)](_0x45c52c(0x1b1)+_0x2df7ee);const _0x9ff6f5=await database_1[_0x45c52c(0x15b)]['payment']['findUnique']({'where':{'id':_0x2df7ee},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x9ff6f5)return _0x2248d9[_0x45c52c(0x17a)](0x194)[_0x45c52c(0x1b5)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x9ff6f5[_0x45c52c(0x19f)]!=='mastercard')return _0x2248d9[_0x45c52c(0x17a)](0x190)[_0x45c52c(0x1b5)]({'success':![],'message':_0x45c52c(0x15c)});if(_0x9ff6f5['status']!==_0x45c52c(0x1ae))return _0x2248d9[_0x45c52c(0x17a)](0x190)[_0x45c52c(0x1b5)]({'success':![],'message':_0x45c52c(0x172)+_0x9ff6f5[_0x45c52c(0x17a)]+',\x20cannot\x20process'});const _0x27aaa2=_0x45c52c(0x175),_0x2f1c37=_0x9ff6f5[_0x45c52c(0x176)];console[_0x45c52c(0x1bb)](_0x45c52c(0x177)),console[_0x45c52c(0x1bb)](_0x45c52c(0x1b2)+_0x27aaa2),console[_0x45c52c(0x1bb)](_0x45c52c(0x16f)+_0x2f1c37);const _0x536622=await this['masterCardService'][_0x45c52c(0x1b6)]({'paymentId':_0x9ff6f5['id'],'orderId':_0x9ff6f5[_0x45c52c(0x19c)]||_0x9ff6f5['id'],'amount':_0x9ff6f5[_0x45c52c(0x1af)],'currency':_0x9ff6f5[_0x45c52c(0x15f)],'cardData':_0x62738,'resultUrl':_0x27aaa2,'returnUrl':_0x2f1c37,'cardHolder':_0x2527a0,'browser':_0x36ec67});console[_0x45c52c(0x1bb)](_0x45c52c(0x183),_0x536622);const _0x58d9d4={'status':_0x536622[_0x45c52c(0x17a)],'updatedAt':new Date(),'statusChangedBy':_0x45c52c(0x1a4),'statusChangedAt':new Date()};if(_0x536622['status']==='PAID')_0x58d9d4[_0x45c52c(0x174)]=new Date(),_0x58d9d4['gatewayPaymentId']=_0x536622[_0x45c52c(0x15a)];else _0x536622[_0x45c52c(0x17a)]===_0x45c52c(0x16d)&&(_0x58d9d4[_0x45c52c(0x1c5)]='Card\x20payment\x20failed');_0x58d9d4['paymentMethod']=_0x45c52c(0x1a7),await database_1[_0x45c52c(0x15b)][_0x45c52c(0x168)][_0x45c52c(0x1bc)]({'where':{'id':_0x9ff6f5['id']},'data':_0x58d9d4}),await database_1[_0x45c52c(0x15b)]['webhookLog'][_0x45c52c(0x1b8)]({'data':{'paymentId':_0x9ff6f5['id'],'shopId':_0x9ff6f5[_0x45c52c(0x164)],'event':_0x45c52c(0x178)+_0x536622[_0x45c52c(0x17a)]?.[_0x45c52c(0x189)](),'statusCode':0xc8,'responseBody':JSON[_0x45c52c(0x190)]({'oldStatus':_0x45c52c(0x1ae),'newStatus':_0x536622[_0x45c52c(0x17a)],'gatewayPaymentId':_0x536622[_0x45c52c(0x15a)],'requires3ds':_0x536622[_0x45c52c(0x165)],'processedAt':new Date()[_0x45c52c(0x1a3)]()})}});_0x536622['final']&&(await this[_0x45c52c(0x1a2)](_0x9ff6f5,_0x536622['status'],_0x536622[_0x45c52c(0x15a)]),await this[_0x45c52c(0x170)](_0x9ff6f5,_0x536622[_0x45c52c(0x17a)]));console['log'](_0x45c52c(0x192)+_0x2df7ee+_0x45c52c(0x15e)+_0x536622[_0x45c52c(0x17a)]);if(_0x536622[_0x45c52c(0x17a)]===_0x45c52c(0x17f))_0x2248d9[_0x45c52c(0x1b5)]({'success':!![],'message':_0x45c52c(0x18a),'result':{'status':_0x45c52c(0x17f),'gatewayPaymentId':_0x536622['gateway_payment_id'],'redirectUrl':_0x2f1c37,'final':!![]}});else _0x536622[_0x45c52c(0x165)]&&_0x536622['threeds_url']?_0x2248d9['json']({'success':!![],'message':_0x45c52c(0x197),'result':{'status':_0x45c52c(0x1ae),'gatewayPaymentId':_0x536622[_0x45c52c(0x15a)],'redirectUrl':_0x536622['threeds_url'],'requires3ds':!![],'final':![]}}):_0x2248d9[_0x45c52c(0x17a)](0x190)[_0x45c52c(0x1b5)]({'success':![],'message':_0x45c52c(0x182),'result':{'status':_0x45c52c(0x16d),'gatewayPaymentId':_0x536622[_0x45c52c(0x15a)],'redirectUrl':_0x9ff6f5['failUrl'],'final':!![]}});}catch(_0xbf3c55){_0x497ba3(_0xbf3c55);}},this[_0x3321cb(0x19a)]=new paymentService_1[(_0x3321cb(0x184))](),this[_0x3321cb(0x18e)]=new mastercardService_1['MasterCardService'](),this[_0x3321cb(0x193)]=new webhookService_1[(_0x3321cb(0x185))]();}async['sendShopWebhook'](_0x5a43ff,_0x535512,_0x546a25){const _0x1e511c=a8_0x53ba5e,_0x39b733=Date['now']();try{const _0x11cb76=_0x5a43ff[_0x1e511c(0x19b)],_0x11ceeb=_0x11cb76[_0x1e511c(0x196)];if(!_0x11ceeb?.[_0x1e511c(0x1ad)]){console[_0x1e511c(0x1bb)](_0x1e511c(0x188)+_0x11cb76['id']);return;}const _0xa0b69a=_0x535512==='PAID'?'payment.success':_0x1e511c(0x187);let _0x2fc68a=[];if(_0x11ceeb[_0x1e511c(0x1c1)])try{_0x2fc68a=Array[_0x1e511c(0x199)](_0x11ceeb[_0x1e511c(0x1c1)])?_0x11ceeb['webhookEvents']:JSON['parse'](_0x11ceeb[_0x1e511c(0x1c1)]);}catch(_0x44b836){console[_0x1e511c(0x1b0)](_0x1e511c(0x1b7),_0x44b836),_0x2fc68a=[];}if(!_0x2fc68a['includes'](_0xa0b69a)){console[_0x1e511c(0x1bb)](_0x1e511c(0x167)+_0xa0b69a+_0x1e511c(0x160)+_0x11cb76['id']);return;}const _0x25e6de={'event':_0xa0b69a,'payment':{'id':_0x5a43ff['id'],'order_id':_0x5a43ff[_0x1e511c(0x1b3)],'gateway_order_id':_0x5a43ff[_0x1e511c(0x19c)],'gateway':_0x1e511c(0x1c6),'amount':_0x5a43ff[_0x1e511c(0x1af)],'currency':_0x5a43ff['currency'],'status':_0x535512['toLowerCase'](),'customer_email':_0x5a43ff['customerEmail'],'customer_name':_0x5a43ff[_0x1e511c(0x171)],'gateway_payment_id':_0x546a25,'created_at':_0x5a43ff['createdAt'],'updated_at':new Date()}},_0x17c050=await fetch(_0x11ceeb['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1e511c(0x18c),'User-Agent':_0x1e511c(0x19d)},'body':JSON['stringify'](_0x25e6de)}),_0x235d3b=Date[_0x1e511c(0x195)]()-_0x39b733;console[_0x1e511c(0x1bb)](_0x1e511c(0x159)+_0x11ceeb[_0x1e511c(0x1ad)]+'\x20with\x20status\x20'+_0x17c050[_0x1e511c(0x17a)]+'\x20('+_0x235d3b+_0x1e511c(0x1b9));}catch(_0x1dabb4){console[_0x1e511c(0x1b0)](_0x1e511c(0x179),_0x1dabb4);}}async[a8_0x53ba5e(0x170)](_0x5f370d,_0x62917d){const _0x5af775=a8_0x53ba5e;try{const {telegramBotService:_0x585b8a}=await Promise[_0x5af775(0x1a5)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x591d73={'PAID':'paid','FAILED':_0x5af775(0x1c3)},_0x3842a0=_0x591d73[_0x62917d];if(!_0x3842a0)return;await _0x585b8a[_0x5af775(0x1c7)](_0x5f370d['shopId'],_0x5f370d,_0x3842a0);}catch(_0xf0dff6){console[_0x5af775(0x1b0)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xf0dff6);}}}exports[a8_0x53ba5e(0x1a6)]=PaymentController;function a8_0x3654(){const _0x595551=['default','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','length','\x20processed:\x20','currency','\x20not\x20enabled\x20for\x20shop\x20','Customer\x20data\x20updated\x20successfully','1681505WySNsE','processMasterCardPayment','shopId','requires_3ds','688rpgHTa','Webhook\x20event\x20','payment','../services/paymentService','3097692dWHUUC','1278481CrObEN','params','FAILED','3GEUEkD','\x20\x20\x20Return\x20URL:\x20','sendPaymentStatusNotification','customerName','Payment\x20status\x20is\x20','configurable','paidAt','https://api.trapay.uk/api/webhooks/gateway/mastercard','successUrl','💳\x20MasterCard\x20URLs:','mastercard_','Failed\x20to\x20send\x20MasterCard\x20webhook:','status','__importStar','getOwnPropertyDescriptor','hasOwnProperty','14710455LcJSMd','PAID','4244644qSIDbQ','__createBinding','Payment\x20failed','💳\x20MasterCard\x20result:','PaymentService','WebhookService','getOwnPropertyNames','payment.failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','Payment\x20processed\x20successfully','../services/gateways/mastercardService','application/json','getPaymentStatus','masterCardService','body','stringify','writable','✅\x20MasterCard\x20payment\x20','webhookService','📝\x20Customer\x20data:','now','settings','3DS\x20verification\x20required','Payment\x20created\x20successfully','isArray','paymentService','shop','gatewayOrderId','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','__importDefault','gateway','defineProperty','../config/database','sendShopWebhook','toISOString','system','resolve','PaymentController','mastercard','Payment\x20not\x20found','1478106tPdShL','../services/webhookService','customerCountry','call','webhookUrl','PENDING','amount','error','💳\x20Processing\x20MasterCard\x20payment:\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','orderId','updatePaymentCustomer','json','processCardPayment','Error\x20parsing\x20webhook\x20events:','create','ms)','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','log','update','updatePaymentCustomerDataPublic','customerIp','__esModule','__setModuleDefault','webhookEvents','getPaymentById','failed','17374FdBpxj','failureMessage','1111','sendPaymentNotification','MasterCard\x20webhook\x20sent\x20to\x20','gateway_payment_id'];a8_0x3654=function(){return _0x595551;};return a8_0x3654();}