'use strict';const a8_0x33870f=a8_0x5c5f;(function(_0x4f1360,_0x3fb83f){const _0x439a15=a8_0x5c5f,_0x35a747=_0x4f1360();while(!![]){try{const _0x4265d4=-parseInt(_0x439a15(0x1d5))/0x1+-parseInt(_0x439a15(0x16a))/0x2*(parseInt(_0x439a15(0x1d0))/0x3)+-parseInt(_0x439a15(0x1c7))/0x4*(parseInt(_0x439a15(0x185))/0x5)+-parseInt(_0x439a15(0x1a4))/0x6*(parseInt(_0x439a15(0x1bd))/0x7)+-parseInt(_0x439a15(0x18d))/0x8+-parseInt(_0x439a15(0x169))/0x9*(-parseInt(_0x439a15(0x1d2))/0xa)+parseInt(_0x439a15(0x1b7))/0xb*(parseInt(_0x439a15(0x1cd))/0xc);if(_0x4265d4===_0x3fb83f)break;else _0x35a747['push'](_0x35a747['shift']());}catch(_0x3a4b84){_0x35a747['push'](_0x35a747['shift']());}}}(a8_0x5e31,0xa5c7c));function a8_0x5c5f(_0xb0f91,_0x337d26){const _0x5e31ab=a8_0x5e31();return a8_0x5c5f=function(_0x5c5f41,_0x492ff4){_0x5c5f41=_0x5c5f41-0x169;let _0xb6aa69=_0x5e31ab[_0x5c5f41];return _0xb6aa69;},a8_0x5c5f(_0xb0f91,_0x337d26);}var __createBinding=this&&this['__createBinding']||(Object[a8_0x33870f(0x170)]?function(_0xd919a5,_0x2e1d59,_0x302310,_0x218cce){const _0x582530=a8_0x33870f;if(_0x218cce===undefined)_0x218cce=_0x302310;var _0x3d65e2=Object[_0x582530(0x1b0)](_0x2e1d59,_0x302310);(!_0x3d65e2||(_0x582530(0x1ab)in _0x3d65e2?!_0x2e1d59[_0x582530(0x17d)]:_0x3d65e2['writable']||_0x3d65e2['configurable']))&&(_0x3d65e2={'enumerable':!![],'get':function(){return _0x2e1d59[_0x302310];}}),Object[_0x582530(0x1d3)](_0xd919a5,_0x218cce,_0x3d65e2);}:function(_0x35bd77,_0x57ce04,_0x19dba4,_0x53cd1b){if(_0x53cd1b===undefined)_0x53cd1b=_0x19dba4;_0x35bd77[_0x53cd1b]=_0x57ce04[_0x19dba4];}),__setModuleDefault=this&&this[a8_0x33870f(0x1c2)]||(Object['create']?function(_0x177dbe,_0x2d9dc2){const _0x73865a=a8_0x33870f;Object[_0x73865a(0x1d3)](_0x177dbe,_0x73865a(0x192),{'enumerable':!![],'value':_0x2d9dc2});}:function(_0x54641f,_0x3cdd21){const _0x41f8e2=a8_0x33870f;_0x54641f[_0x41f8e2(0x192)]=_0x3cdd21;}),__importStar=this&&this[a8_0x33870f(0x188)]||(function(){var _0x4d7726=function(_0x3fbcaa){const _0x242573=a8_0x5c5f;return _0x4d7726=Object[_0x242573(0x1a3)]||function(_0x311306){const _0x191921=_0x242573;var _0x24c639=[];for(var _0x503f54 in _0x311306)if(Object[_0x191921(0x1a2)][_0x191921(0x1d8)]['call'](_0x311306,_0x503f54))_0x24c639[_0x24c639[_0x191921(0x1aa)]]=_0x503f54;return _0x24c639;},_0x4d7726(_0x3fbcaa);};return function(_0x883b02){const _0x5acb80=a8_0x5c5f;if(_0x883b02&&_0x883b02['__esModule'])return _0x883b02;var _0x47f23b={};if(_0x883b02!=null){for(var _0x12859f=_0x4d7726(_0x883b02),_0x57d89e=0x0;_0x57d89e<_0x12859f[_0x5acb80(0x1aa)];_0x57d89e++)if(_0x12859f[_0x57d89e]!==_0x5acb80(0x192))__createBinding(_0x47f23b,_0x883b02,_0x12859f[_0x57d89e]);}return __setModuleDefault(_0x47f23b,_0x883b02),_0x47f23b;};}()),__importDefault=this&&this[a8_0x33870f(0x1cc)]||function(_0x4dd88a){const _0xb191b3=a8_0x33870f;return _0x4dd88a&&_0x4dd88a[_0xb191b3(0x17d)]?_0x4dd88a:{'default':_0x4dd88a};};Object[a8_0x33870f(0x1d3)](exports,a8_0x33870f(0x17d),{'value':!![]}),exports[a8_0x33870f(0x19d)]=void 0x0;const paymentService_1=require(a8_0x33870f(0x193)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x32d63a=a8_0x33870f;this[_0x32d63a(0x1c5)]=async(_0x4bd47d,_0x8e15a3,_0x3a547e)=>{const _0x5787fe=_0x32d63a;try{const _0x2bbbad=_0x4bd47d[_0x5787fe(0x177)],_0x3a853e=await this['paymentService'][_0x5787fe(0x1c5)](_0x2bbbad);_0x8e15a3[_0x5787fe(0x16b)](0xc9)['json']({'success':!![],'message':_0x5787fe(0x1ce),'result':_0x3a853e});}catch(_0x9339a){_0x3a547e(_0x9339a);}},this[_0x32d63a(0x1ca)]=async(_0xff69ec,_0x3f0576,_0x2aac07)=>{const _0x36da4e=_0x32d63a;try{const {id:_0x5efd02}=_0xff69ec['params'],_0x3cc15c=await this['paymentService'][_0x36da4e(0x1ca)](_0x5efd02);if(!_0x3cc15c)return _0x3f0576[_0x36da4e(0x16b)](0x194)[_0x36da4e(0x1b8)]({'success':![],'message':_0x36da4e(0x17a)});_0x3f0576['json']({'success':!![],'result':_0x3cc15c});}catch(_0x55b0f4){_0x2aac07(_0x55b0f4);}},this[_0x32d63a(0x18f)]=async(_0x11d004,_0x399043,_0x167f31)=>{const _0x10acdc=_0x32d63a;try{const {id:_0x5c9843}=_0x11d004[_0x10acdc(0x197)],_0x5aa3e6=await this[_0x10acdc(0x182)][_0x10acdc(0x18f)](_0x5c9843);if(!_0x5aa3e6)return _0x399043[_0x10acdc(0x16b)](0x194)[_0x10acdc(0x1b8)]({'success':![],'message':_0x10acdc(0x17a)});_0x399043['json']({'success':!![],'result':_0x5aa3e6});}catch(_0x2592cd){_0x167f31(_0x2592cd);}},this[_0x32d63a(0x16e)]=async(_0x487b5f,_0x410f45,_0x5afd4e)=>{const _0x2e6b7a=_0x32d63a;try{const {id:_0x172495}=_0x487b5f['params'],{cardData:_0xb8c533,cardHolder:_0x1056de,browser:_0x2e0e2}=_0x487b5f[_0x2e6b7a(0x177)];console[_0x2e6b7a(0x190)](_0x2e6b7a(0x189)+_0x172495);const _0x3de913=await database_1['default'][_0x2e6b7a(0x19a)][_0x2e6b7a(0x187)]({'where':{'id':_0x172495},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3de913)return _0x410f45[_0x2e6b7a(0x16b)](0x194)[_0x2e6b7a(0x1b8)]({'success':![],'message':_0x2e6b7a(0x17a)});if(_0x3de913['gateway']!==_0x2e6b7a(0x17b))return _0x410f45[_0x2e6b7a(0x16b)](0x190)[_0x2e6b7a(0x1b8)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x3de913['status']!==_0x2e6b7a(0x186))return _0x410f45[_0x2e6b7a(0x16b)](0x190)[_0x2e6b7a(0x1b8)]({'success':![],'message':_0x2e6b7a(0x1af)+_0x3de913[_0x2e6b7a(0x16b)]+_0x2e6b7a(0x194)});const _0x353e58=_0x2e6b7a(0x1b9),_0x41420e=_0x3de913[_0x2e6b7a(0x1ae)];console[_0x2e6b7a(0x190)](_0x2e6b7a(0x1c3)),console['log'](_0x2e6b7a(0x19e)+_0x353e58),console[_0x2e6b7a(0x190)](_0x2e6b7a(0x16c)+_0x41420e);const _0x47871c=await this[_0x2e6b7a(0x19f)][_0x2e6b7a(0x175)]({'paymentId':_0x3de913['id'],'orderId':_0x3de913[_0x2e6b7a(0x181)]||_0x3de913['id'],'amount':_0x3de913[_0x2e6b7a(0x1c1)],'currency':_0x3de913[_0x2e6b7a(0x174)],'cardData':_0xb8c533,'resultUrl':_0x353e58,'returnUrl':_0x41420e,'cardHolder':_0x1056de,'browser':_0x2e0e2});console[_0x2e6b7a(0x190)](_0x2e6b7a(0x1c4),_0x47871c);const _0x81fc14={'status':_0x47871c[_0x2e6b7a(0x16b)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x47871c[_0x2e6b7a(0x16b)]===_0x2e6b7a(0x195))_0x81fc14[_0x2e6b7a(0x16d)]=new Date(),_0x81fc14[_0x2e6b7a(0x1d1)]=_0x47871c['gateway_payment_id'];else _0x47871c[_0x2e6b7a(0x16b)]===_0x2e6b7a(0x18a)&&(_0x81fc14[_0x2e6b7a(0x179)]=_0x2e6b7a(0x171));_0x81fc14['paymentMethod']=_0x2e6b7a(0x17b),await database_1['default']['payment'][_0x2e6b7a(0x178)]({'where':{'id':_0x3de913['id']},'data':_0x81fc14}),await database_1[_0x2e6b7a(0x192)][_0x2e6b7a(0x1d6)][_0x2e6b7a(0x170)]({'data':{'paymentId':_0x3de913['id'],'shopId':_0x3de913[_0x2e6b7a(0x1a1)],'event':_0x2e6b7a(0x1d7)+_0x47871c['status']?.[_0x2e6b7a(0x1c0)](),'statusCode':0xc8,'responseBody':JSON[_0x2e6b7a(0x184)]({'oldStatus':_0x2e6b7a(0x186),'newStatus':_0x47871c[_0x2e6b7a(0x16b)],'gatewayPaymentId':_0x47871c[_0x2e6b7a(0x1ac)],'requires3ds':_0x47871c[_0x2e6b7a(0x198)],'processedAt':new Date()[_0x2e6b7a(0x191)]()})}});_0x47871c[_0x2e6b7a(0x1b5)]&&(await this['sendShopWebhook'](_0x3de913,_0x47871c['status'],_0x47871c[_0x2e6b7a(0x1ac)]),await this[_0x2e6b7a(0x18c)](_0x3de913,_0x47871c[_0x2e6b7a(0x16b)]));console[_0x2e6b7a(0x190)](_0x2e6b7a(0x196)+_0x172495+_0x2e6b7a(0x16f)+_0x47871c['status']);if(_0x47871c[_0x2e6b7a(0x16b)]==='PAID')_0x410f45[_0x2e6b7a(0x1b8)]({'success':!![],'message':_0x2e6b7a(0x1ba),'result':{'status':_0x2e6b7a(0x195),'gatewayPaymentId':_0x47871c[_0x2e6b7a(0x1ac)],'redirectUrl':_0x41420e,'final':!![]}});else _0x47871c[_0x2e6b7a(0x198)]&&_0x47871c[_0x2e6b7a(0x18b)]?_0x410f45['json']({'success':!![],'message':_0x2e6b7a(0x19c),'result':{'status':_0x2e6b7a(0x186),'gatewayPaymentId':_0x47871c[_0x2e6b7a(0x1ac)],'redirectUrl':_0x47871c[_0x2e6b7a(0x18b)],'requires3ds':!![],'final':![]}}):_0x410f45[_0x2e6b7a(0x16b)](0x190)[_0x2e6b7a(0x1b8)]({'success':![],'message':_0x2e6b7a(0x1bb),'result':{'status':_0x2e6b7a(0x18a),'gatewayPaymentId':_0x47871c[_0x2e6b7a(0x1ac)],'redirectUrl':_0x3de913[_0x2e6b7a(0x1a5)],'final':!![]}});}catch(_0x2a1e85){_0x5afd4e(_0x2a1e85);}},this['paymentService']=new paymentService_1[(_0x32d63a(0x1ad))](),this['masterCardService']=new mastercardService_1[(_0x32d63a(0x19b))](),this[_0x32d63a(0x1d4)]=new webhookService_1[(_0x32d63a(0x1cf))]();}async['sendShopWebhook'](_0x4eb36d,_0x13e3e3,_0x4db8f3){const _0x512a55=a8_0x33870f,_0x395cdd=Date[_0x512a55(0x180)]();try{const _0x313164=_0x4eb36d[_0x512a55(0x1c8)],_0x5d0d30=_0x313164[_0x512a55(0x183)];if(!_0x5d0d30?.[_0x512a55(0x1a9)]){console[_0x512a55(0x190)](_0x512a55(0x1c6)+_0x313164['id']);return;}const _0x36ef3c=_0x13e3e3===_0x512a55(0x195)?'payment.success':'payment.failed';let _0x475e19=[];if(_0x5d0d30[_0x512a55(0x199)])try{_0x475e19=Array['isArray'](_0x5d0d30['webhookEvents'])?_0x5d0d30['webhookEvents']:JSON[_0x512a55(0x17c)](_0x5d0d30[_0x512a55(0x199)]);}catch(_0x2fb9b9){console[_0x512a55(0x1bc)](_0x512a55(0x1a0),_0x2fb9b9),_0x475e19=[];}if(!_0x475e19[_0x512a55(0x1b1)](_0x36ef3c)){console['log'](_0x512a55(0x1b2)+_0x36ef3c+_0x512a55(0x1a8)+_0x313164['id']);return;}const _0x5dddc8={'event':_0x36ef3c,'payment':{'id':_0x4eb36d['id'],'order_id':_0x4eb36d['orderId'],'gateway_order_id':_0x4eb36d[_0x512a55(0x181)],'gateway':_0x512a55(0x1bf),'amount':_0x4eb36d['amount'],'currency':_0x4eb36d[_0x512a55(0x174)],'status':_0x13e3e3[_0x512a55(0x1c0)](),'customer_email':_0x4eb36d[_0x512a55(0x1c9)],'customer_name':_0x4eb36d[_0x512a55(0x1be)],'gateway_payment_id':_0x4db8f3,'created_at':_0x4eb36d[_0x512a55(0x17e)],'updated_at':new Date()}},_0x4047c9=await fetch(_0x5d0d30[_0x512a55(0x1a9)],{'method':_0x512a55(0x1a7),'headers':{'Content-Type':_0x512a55(0x173),'User-Agent':_0x512a55(0x172)},'body':JSON[_0x512a55(0x184)](_0x5dddc8)}),_0xddbf3=Date[_0x512a55(0x180)]()-_0x395cdd;console[_0x512a55(0x190)](_0x512a55(0x1b4)+_0x5d0d30[_0x512a55(0x1a9)]+'\x20with\x20status\x20'+_0x4047c9['status']+'\x20('+_0xddbf3+'ms)');}catch(_0x94d538){console[_0x512a55(0x1bc)](_0x512a55(0x176),_0x94d538);}}async['sendPaymentStatusNotification'](_0x396cf1,_0x5591cc){const _0x59b0c5=a8_0x33870f;try{const {telegramBotService:_0x31e9bc}=await Promise[_0x59b0c5(0x18e)]()[_0x59b0c5(0x1b3)](()=>__importStar(require('../services/telegramBotService'))),_0x12e1e7={'PAID':_0x59b0c5(0x1cb),'FAILED':_0x59b0c5(0x1a6)},_0x4b8ee8=_0x12e1e7[_0x5591cc];if(!_0x4b8ee8)return;await _0x31e9bc[_0x59b0c5(0x17f)](_0x396cf1['shopId'],_0x396cf1,_0x4b8ee8);}catch(_0x52cd30){console[_0x59b0c5(0x1bc)](_0x59b0c5(0x1b6),_0x52cd30);}}}function a8_0x5e31(){const _0x1e279c=['status','\x20\x20\x20Return\x20URL:\x20','paidAt','processMasterCardPayment','\x20processed:\x20','create','Card\x20payment\x20failed','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','application/json','currency','processCardPayment','Failed\x20to\x20send\x20MasterCard\x20webhook:','body','update','failureMessage','Payment\x20not\x20found','mastercard','parse','__esModule','createdAt','sendPaymentNotification','now','gatewayOrderId','paymentService','settings','stringify','25qJyDWi','PENDING','findUnique','__importStar','💳\x20Processing\x20MasterCard\x20payment:\x20','FAILED','threeds_url','sendPaymentStatusNotification','5156816HKohDq','resolve','getPaymentById','log','toISOString','default','../services/paymentService',',\x20cannot\x20process','PAID','✅\x20MasterCard\x20payment\x20','params','requires_3ds','webhookEvents','payment','MasterCardService','3DS\x20verification\x20required','PaymentController','\x20\x20\x20Result\x20URL\x20(webhook):\x20','masterCardService','Error\x20parsing\x20webhook\x20events:','shopId','prototype','getOwnPropertyNames','14262XLmmzr','failUrl','failed','POST','\x20not\x20enabled\x20for\x20shop\x20','webhookUrl','length','get','gateway_payment_id','PaymentService','successUrl','Payment\x20status\x20is\x20','getOwnPropertyDescriptor','includes','Webhook\x20event\x20','then','MasterCard\x20webhook\x20sent\x20to\x20','final','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','30904786vRxYgr','json','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','Payment\x20processed\x20successfully','Payment\x20failed','error','2653PMIcFn','customerName','1111','toLowerCase','amount','__setModuleDefault','💳\x20MasterCard\x20URLs:','💳\x20MasterCard\x20result:','createPublicPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','45324zHxtlB','shop','customerEmail','getPaymentStatus','paid','__importDefault','12CiMVRn','Payment\x20created\x20successfully','WebhookService','185637mUIHDH','gatewayPaymentId','350CpGrQl','defineProperty','webhookService','789816AIkhhY','webhookLog','mastercard_','hasOwnProperty','321822kaqkOa','32kKdBiV'];a8_0x5e31=function(){return _0x1e279c;};return a8_0x5e31();}exports[a8_0x33870f(0x19d)]=PaymentController;