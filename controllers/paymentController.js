'use strict';function a8_0xaf1f(_0x302f3b,_0x548701){const _0x3f103d=a8_0x3f10();return a8_0xaf1f=function(_0xaf1f9a,_0x2613c6){_0xaf1f9a=_0xaf1f9a-0x15b;let _0x43c14d=_0x3f103d[_0xaf1f9a];return _0x43c14d;},a8_0xaf1f(_0x302f3b,_0x548701);}const a8_0x28eb16=a8_0xaf1f;(function(_0x2d7973,_0x137864){const _0x2920f3=a8_0xaf1f,_0x1c5d76=_0x2d7973();while(!![]){try{const _0x3a3230=parseInt(_0x2920f3(0x1a6))/0x1+parseInt(_0x2920f3(0x1aa))/0x2+parseInt(_0x2920f3(0x198))/0x3+parseInt(_0x2920f3(0x1c2))/0x4*(parseInt(_0x2920f3(0x197))/0x5)+-parseInt(_0x2920f3(0x166))/0x6*(parseInt(_0x2920f3(0x1cd))/0x7)+-parseInt(_0x2920f3(0x1d3))/0x8+-parseInt(_0x2920f3(0x193))/0x9*(parseInt(_0x2920f3(0x184))/0xa);if(_0x3a3230===_0x137864)break;else _0x1c5d76['push'](_0x1c5d76['shift']());}catch(_0x2e2ab4){_0x1c5d76['push'](_0x1c5d76['shift']());}}}(a8_0x3f10,0xe0ec2));var __createBinding=this&&this['__createBinding']||(Object[a8_0x28eb16(0x173)]?function(_0x323645,_0x28c4e8,_0x5b62e1,_0x5f257c){const _0x2dcf6b=a8_0x28eb16;if(_0x5f257c===undefined)_0x5f257c=_0x5b62e1;var _0x2e654a=Object[_0x2dcf6b(0x15d)](_0x28c4e8,_0x5b62e1);(!_0x2e654a||(_0x2dcf6b(0x188)in _0x2e654a?!_0x28c4e8['__esModule']:_0x2e654a[_0x2dcf6b(0x16b)]||_0x2e654a[_0x2dcf6b(0x1d0)]))&&(_0x2e654a={'enumerable':!![],'get':function(){return _0x28c4e8[_0x5b62e1];}}),Object[_0x2dcf6b(0x187)](_0x323645,_0x5f257c,_0x2e654a);}:function(_0x58cb56,_0x42eaaa,_0x30225f,_0x4eaca6){if(_0x4eaca6===undefined)_0x4eaca6=_0x30225f;_0x58cb56[_0x4eaca6]=_0x42eaaa[_0x30225f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x28eb16(0x173)]?function(_0xa9e315,_0x911e24){const _0x30df21=a8_0x28eb16;Object[_0x30df21(0x187)](_0xa9e315,_0x30df21(0x164),{'enumerable':!![],'value':_0x911e24});}:function(_0x41ec26,_0x448117){const _0xe278b4=a8_0x28eb16;_0x41ec26[_0xe278b4(0x164)]=_0x448117;}),__importStar=this&&this[a8_0x28eb16(0x1c1)]||(function(){var _0x2f90ad=function(_0x16ed6e){const _0x256ebe=a8_0xaf1f;return _0x2f90ad=Object[_0x256ebe(0x1b4)]||function(_0x34ec5f){const _0x1cf530=_0x256ebe;var _0x166d56=[];for(var _0x29c420 in _0x34ec5f)if(Object['prototype'][_0x1cf530(0x185)][_0x1cf530(0x15c)](_0x34ec5f,_0x29c420))_0x166d56[_0x166d56[_0x1cf530(0x1a3)]]=_0x29c420;return _0x166d56;},_0x2f90ad(_0x16ed6e);};return function(_0x1ef5a7){const _0x4dcf2b=a8_0xaf1f;if(_0x1ef5a7&&_0x1ef5a7[_0x4dcf2b(0x16f)])return _0x1ef5a7;var _0x4e621f={};if(_0x1ef5a7!=null){for(var _0x5ed941=_0x2f90ad(_0x1ef5a7),_0x316224=0x0;_0x316224<_0x5ed941[_0x4dcf2b(0x1a3)];_0x316224++)if(_0x5ed941[_0x316224]!==_0x4dcf2b(0x164))__createBinding(_0x4e621f,_0x1ef5a7,_0x5ed941[_0x316224]);}return __setModuleDefault(_0x4e621f,_0x1ef5a7),_0x4e621f;};}()),__importDefault=this&&this[a8_0x28eb16(0x179)]||function(_0x19cb58){const _0x4c4e4f=a8_0x28eb16;return _0x19cb58&&_0x19cb58[_0x4c4e4f(0x16f)]?_0x19cb58:{'default':_0x19cb58};};Object[a8_0x28eb16(0x187)](exports,a8_0x28eb16(0x16f),{'value':!![]}),exports[a8_0x28eb16(0x1d2)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x28eb16(0x1ae)),webhookService_1=require(a8_0x28eb16(0x1b3)),database_1=__importDefault(require(a8_0x28eb16(0x15f)));class PaymentController{constructor(){const _0x50e0e3=a8_0x28eb16;this[_0x50e0e3(0x1dd)]=async(_0x31f79d,_0x1321ac,_0x3285c6)=>{const _0xf7a8d1=_0x50e0e3;try{const _0x464eb5=_0x31f79d['body'],_0x356504=await this['paymentService']['createPublicPayment'](_0x464eb5);_0x1321ac['status'](0xc9)[_0xf7a8d1(0x161)]({'success':!![],'message':_0xf7a8d1(0x1c6),'result':_0x356504});}catch(_0x196d60){_0x3285c6(_0x196d60);}},this[_0x50e0e3(0x170)]=async(_0x780128,_0x4fe41b,_0x4d67cc)=>{const _0x436478=_0x50e0e3;try{const {id:_0x3e5bae}=_0x780128[_0x436478(0x1bb)],_0x286791=await this[_0x436478(0x191)][_0x436478(0x170)](_0x3e5bae);if(!_0x286791)return _0x4fe41b[_0x436478(0x17e)](0x194)['json']({'success':![],'message':_0x436478(0x17b)});_0x4fe41b[_0x436478(0x161)]({'success':!![],'result':_0x286791});}catch(_0x33c45d){_0x4d67cc(_0x33c45d);}},this[_0x50e0e3(0x18b)]=async(_0x176191,_0x540135,_0x2885e2)=>{const _0x5228c0=_0x50e0e3;try{const {id:_0x7220ad}=_0x176191['params'],_0x4fc423=await this[_0x5228c0(0x191)][_0x5228c0(0x18b)](_0x7220ad);if(!_0x4fc423)return _0x540135[_0x5228c0(0x17e)](0x194)[_0x5228c0(0x161)]({'success':![],'message':_0x5228c0(0x17b)});_0x540135[_0x5228c0(0x161)]({'success':!![],'result':_0x4fc423});}catch(_0x3128a6){_0x2885e2(_0x3128a6);}},this[_0x50e0e3(0x162)]=async(_0x279864,_0x4c5f79,_0x38ac03)=>{const _0x3b0d38=_0x50e0e3;try{const {id:_0xbd2c1c}=_0x279864[_0x3b0d38(0x1bb)],_0x1fa935=_0x279864[_0x3b0d38(0x1db)];console[_0x3b0d38(0x19a)](_0x3b0d38(0x1a8)+_0xbd2c1c),console[_0x3b0d38(0x19a)](_0x3b0d38(0x1b1),_0x1fa935);const _0xfc27e2=await this[_0x3b0d38(0x191)][_0x3b0d38(0x178)](_0xbd2c1c,_0x1fa935);if(!_0xfc27e2)return _0x4c5f79[_0x3b0d38(0x17e)](0x194)['json']({'success':![],'message':_0x3b0d38(0x17b)});_0x4c5f79[_0x3b0d38(0x161)]({'success':!![],'message':_0x3b0d38(0x1ca),'result':{'paymentId':_0xfc27e2['id'],'customerIp':_0xfc27e2[_0x3b0d38(0x165)],'customerUa':_0xfc27e2[_0x3b0d38(0x1ab)],'customerCountry':_0xfc27e2[_0x3b0d38(0x1ba)],'updatedAt':_0xfc27e2['updatedAt']}});}catch(_0x53d2b0){_0x38ac03(_0x53d2b0);}},this[_0x50e0e3(0x160)]=async(_0x5410c8,_0x66a709,_0x3f45cc)=>{const _0x2d8174=_0x50e0e3;try{const {id:_0x474966}=_0x5410c8[_0x2d8174(0x1bb)],{cardData:_0x35b026,cardHolder:_0xa60518,browser:_0x19b740}=_0x5410c8[_0x2d8174(0x1db)];console['log'](_0x2d8174(0x180)+_0x474966),console[_0x2d8174(0x19a)](_0x2d8174(0x17c)+_0xa60518[_0x2d8174(0x16e)]+'\x20'+_0xa60518[_0x2d8174(0x18c)]+'\x20('+_0xa60518[_0x2d8174(0x1a4)]+')'),console['log']('💳\x20Browser\x20IP:\x20'+_0x19b740['ip']);const _0x1d88a1={'customerName':_0xa60518[_0x2d8174(0x16e)]+'\x20'+_0xa60518[_0x2d8174(0x18c)],'customerEmail':_0xa60518['email'],'customerIp':_0x19b740['ip'],'customerUa':_0x19b740[_0x2d8174(0x1dc)]},_0x2af301=await database_1['default'][_0x2d8174(0x1da)][_0x2d8174(0x1ce)]({'where':{'id':_0x474966},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2af301)return _0x66a709[_0x2d8174(0x17e)](0x194)[_0x2d8174(0x161)]({'success':![],'message':_0x2d8174(0x17b)});if(_0x2af301['gateway']!=='mastercard')return _0x66a709[_0x2d8174(0x17e)](0x190)[_0x2d8174(0x161)]({'success':![],'message':_0x2d8174(0x181)});if(_0x2af301[_0x2d8174(0x17e)]!=='PENDING')return _0x66a709[_0x2d8174(0x17e)](0x190)[_0x2d8174(0x161)]({'success':![],'message':_0x2d8174(0x1c8)+_0x2af301['status']+_0x2d8174(0x15b)});await database_1['default'][_0x2d8174(0x1da)][_0x2d8174(0x1b2)]({'where':{'id':_0x474966},'data':{..._0x1d88a1,'updatedAt':new Date()}});const _0x21d266=_0x2d8174(0x169),_0xc9064e=_0x2af301[_0x2d8174(0x194)];console[_0x2d8174(0x19a)](_0x2d8174(0x192)),console[_0x2d8174(0x19a)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x21d266),console[_0x2d8174(0x19a)](_0x2d8174(0x1cf)+_0xc9064e);const _0x376659={'first_name':_0xa60518[_0x2d8174(0x16e)],'last_name':_0xa60518[_0x2d8174(0x18c)],'email':_0xa60518[_0x2d8174(0x1a4)]},_0x38ecdf=await this[_0x2d8174(0x174)][_0x2d8174(0x18d)]({'paymentId':_0x2af301['id'],'orderId':_0x2af301[_0x2d8174(0x1ac)]||_0x2af301['id'],'amount':_0x2af301['amount'],'currency':_0x2af301[_0x2d8174(0x17d)],'cardData':_0x35b026,'resultUrl':_0x21d266,'returnUrl':_0xc9064e,'cardHolder':_0x376659,'browser':_0x19b740});console[_0x2d8174(0x19a)]('💳\x20MasterCard\x20result:',_0x38ecdf);const _0x5ebddb={'status':_0x38ecdf[_0x2d8174(0x17e)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x38ecdf[_0x2d8174(0x195)]&&(_0x5ebddb[_0x2d8174(0x175)]=_0x38ecdf[_0x2d8174(0x195)],console[_0x2d8174(0x19a)]('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x38ecdf['gateway_payment_id']));if(_0x38ecdf[_0x2d8174(0x17e)]==='PAID')_0x5ebddb[_0x2d8174(0x1bd)]=new Date();else _0x38ecdf[_0x2d8174(0x17e)]===_0x2d8174(0x1d1)&&(_0x5ebddb[_0x2d8174(0x15e)]=_0x2d8174(0x168));_0x5ebddb[_0x2d8174(0x1a0)]=_0x2d8174(0x1a9);if(_0x35b026[_0x2d8174(0x1b8)]){const _0x145233=_0x35b026['number']['replace'](/[\s-]/g,'');_0x5ebddb[_0x2d8174(0x1cc)]=_0x145233['slice'](-0x4),console[_0x2d8174(0x19a)](_0x2d8174(0x19b)+_0x5ebddb[_0x2d8174(0x1cc)]);}await database_1[_0x2d8174(0x164)][_0x2d8174(0x1da)][_0x2d8174(0x1b2)]({'where':{'id':_0x2af301['id']},'data':_0x5ebddb}),await database_1['default'][_0x2d8174(0x196)][_0x2d8174(0x173)]({'data':{'paymentId':_0x2af301['id'],'shopId':_0x2af301['shopId'],'event':_0x2d8174(0x1ad)+_0x38ecdf[_0x2d8174(0x17e)]?.[_0x2d8174(0x17a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x38ecdf[_0x2d8174(0x17e)],'gatewayPaymentId':_0x38ecdf[_0x2d8174(0x195)],'requires3ds':_0x38ecdf[_0x2d8174(0x17f)],'processedAt':new Date()[_0x2d8174(0x199)]()})}});if(_0x38ecdf[_0x2d8174(0x1c0)]){await this['sendShopWebhook'](_0x2af301,_0x38ecdf[_0x2d8174(0x17e)],_0x38ecdf[_0x2d8174(0x195)]),await this['sendPaymentStatusNotification'](_0x2af301,_0x38ecdf[_0x2d8174(0x17e)]);if(_0x38ecdf[_0x2d8174(0x17e)]===_0x2d8174(0x19d)){console[_0x2d8174(0x19a)]('📈\x20MasterCard\x20payment\x20'+_0x474966+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x365459}=await Promise[_0x2d8174(0x1b5)]()[_0x2d8174(0x16a)](()=>__importStar(require(_0x2d8174(0x19c)))),_0x3ea170=new _0x365459();await _0x3ea170['handleSuccessfulPayment'](_0x474966),console[_0x2d8174(0x19a)](_0x2d8174(0x189)+_0x474966);}catch(_0x4a48c4){console['error'](_0x2d8174(0x1d4),_0x4a48c4);}}}console[_0x2d8174(0x19a)]('✅\x20MasterCard\x20payment\x20'+_0x474966+_0x2d8174(0x1c5)+_0x38ecdf[_0x2d8174(0x17e)]);if(_0x38ecdf['status']===_0x2d8174(0x19d))_0x66a709[_0x2d8174(0x161)]({'success':!![],'message':_0x2d8174(0x18a),'result':{'status':'PAID','gatewayPaymentId':_0x38ecdf['gateway_payment_id'],'redirectUrl':_0xc9064e,'final':!![]}});else _0x38ecdf[_0x2d8174(0x17f)]&&_0x38ecdf[_0x2d8174(0x1af)]?_0x66a709[_0x2d8174(0x161)]({'success':!![],'message':_0x2d8174(0x1b6),'result':{'status':_0x2d8174(0x163),'gatewayPaymentId':_0x38ecdf['gateway_payment_id'],'redirectUrl':_0x38ecdf[_0x2d8174(0x1af)],'requires3ds':!![],'final':![]}}):_0x66a709[_0x2d8174(0x17e)](0x190)[_0x2d8174(0x161)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x2d8174(0x1d1),'gatewayPaymentId':_0x38ecdf[_0x2d8174(0x195)],'redirectUrl':_0x2af301[_0x2d8174(0x182)],'final':!![]}});}catch(_0x5b8498){_0x3f45cc(_0x5b8498);}},this[_0x50e0e3(0x191)]=new paymentService_1['PaymentService'](),this[_0x50e0e3(0x174)]=new mastercardService_1['MasterCardService'](),this[_0x50e0e3(0x1b7)]=new webhookService_1[(_0x50e0e3(0x1cb))]();}async[a8_0x28eb16(0x176)](_0x4934a2,_0x5574e8,_0x122a47){const _0x1ec2ff=a8_0x28eb16,_0x4f337e=Date[_0x1ec2ff(0x183)]();try{const _0x1907cd=_0x4934a2['shop'],_0x76954d=_0x1907cd[_0x1ec2ff(0x1c4)];if(!_0x76954d?.['webhookUrl']){console[_0x1ec2ff(0x19a)](_0x1ec2ff(0x1d5)+_0x1907cd['id']);return;}const _0x15f026=_0x5574e8===_0x1ec2ff(0x19d)?_0x1ec2ff(0x18f):_0x1ec2ff(0x1c3);let _0xecc470=[];if(_0x76954d[_0x1ec2ff(0x1bf)])try{_0xecc470=Array[_0x1ec2ff(0x1d9)](_0x76954d['webhookEvents'])?_0x76954d['webhookEvents']:JSON[_0x1ec2ff(0x186)](_0x76954d[_0x1ec2ff(0x1bf)]);}catch(_0x53a858){console['error']('Error\x20parsing\x20webhook\x20events:',_0x53a858),_0xecc470=[];}if(!_0xecc470[_0x1ec2ff(0x1bc)](_0x15f026)){console[_0x1ec2ff(0x19a)](_0x1ec2ff(0x1c7)+_0x15f026+_0x1ec2ff(0x1d8)+_0x1907cd['id']);return;}const _0x30ac7a={'event':_0x15f026,'payment':{'id':_0x4934a2['id'],'order_id':_0x4934a2['orderId'],'gateway_order_id':_0x4934a2['gatewayOrderId'],'gateway':_0x1ec2ff(0x19f),'amount':_0x4934a2[_0x1ec2ff(0x1b0)],'currency':_0x4934a2[_0x1ec2ff(0x17d)],'status':_0x5574e8['toLowerCase'](),'customer_email':_0x4934a2[_0x1ec2ff(0x16d)],'customer_name':_0x4934a2[_0x1ec2ff(0x167)],'gateway_payment_id':_0x122a47,'created_at':_0x4934a2[_0x1ec2ff(0x18e)],'updated_at':new Date()}},_0x15b08e=await fetch(_0x76954d[_0x1ec2ff(0x1c9)],{'method':_0x1ec2ff(0x16c),'headers':{'Content-Type':_0x1ec2ff(0x1be),'User-Agent':_0x1ec2ff(0x1a7)},'body':JSON[_0x1ec2ff(0x1d7)](_0x30ac7a)}),_0x406a1a=Date[_0x1ec2ff(0x183)]()-_0x4f337e;console[_0x1ec2ff(0x19a)](_0x1ec2ff(0x1b9)+_0x76954d[_0x1ec2ff(0x1c9)]+'\x20with\x20status\x20'+_0x15b08e[_0x1ec2ff(0x17e)]+'\x20('+_0x406a1a+_0x1ec2ff(0x171));}catch(_0x6ded2c){console[_0x1ec2ff(0x19e)](_0x1ec2ff(0x1a5),_0x6ded2c);}}async[a8_0x28eb16(0x1d6)](_0xf52288,_0x25a613){const _0x32a036=a8_0x28eb16;try{const {telegramBotService:_0x2517df}=await Promise[_0x32a036(0x1b5)]()[_0x32a036(0x16a)](()=>__importStar(require(_0x32a036(0x177)))),_0xb9b305={'PAID':_0x32a036(0x172),'FAILED':_0x32a036(0x1a1)},_0x194a99=_0xb9b305[_0x25a613];if(!_0x194a99)return;await _0x2517df[_0x32a036(0x190)](_0xf52288[_0x32a036(0x1a2)],_0xf52288,_0x194a99);}catch(_0x3909e6){console[_0x32a036(0x19e)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3909e6);}}}function a8_0x3f10(){const _0x5eaec1=['writable','POST','customerEmail','first_name','__esModule','getPaymentStatus','ms)','paid','create','masterCardService','gatewayPaymentId','sendShopWebhook','../services/telegramBotService','updatePaymentCustomerDataPublic','__importDefault','toLowerCase','Payment\x20not\x20found','💳\x20Card\x20holder:\x20','currency','status','requires_3ds','💳\x20Processing\x20MasterCard\x20payment:\x20','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','failUrl','now','10vttqdN','hasOwnProperty','parse','defineProperty','get','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','Payment\x20processed\x20successfully','getPaymentById','last_name','processCardPayment','createdAt','payment.success','sendPaymentNotification','paymentService','💳\x20MasterCard\x20URLs:','1278801GIBuhp','successUrl','gateway_payment_id','webhookLog','5941435TBBqAC','995712spIhEf','toISOString','log','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','../services/paymentLinkService','PAID','error','1111','paymentMethod','failed','shopId','length','email','Failed\x20to\x20send\x20MasterCard\x20webhook:','661509VaXIBg','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','mastercard','1907064HKkMKT','customerUa','gatewayOrderId','mastercard_','../services/gateways/mastercardService','threeds_url','amount','📝\x20Customer\x20data:','update','../services/webhookService','getOwnPropertyNames','resolve','3DS\x20verification\x20required','webhookService','number','MasterCard\x20webhook\x20sent\x20to\x20','customerCountry','params','includes','paidAt','application/json','webhookEvents','final','__importStar','4PLWfdr','payment.failed','settings','\x20processed:\x20','Payment\x20created\x20successfully','Webhook\x20event\x20','Payment\x20status\x20is\x20','webhookUrl','Customer\x20data\x20updated\x20successfully','WebhookService','cardLast4','6115361LMuNgK','findUnique','\x20\x20\x20Return\x20URL:\x20','configurable','FAILED','PaymentController','9585904PWWeCS','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','sendPaymentStatusNotification','stringify','\x20not\x20enabled\x20for\x20shop\x20','isArray','payment','body','user_agent','createPublicPayment',',\x20cannot\x20process','call','getOwnPropertyDescriptor','failureMessage','../config/database','processMasterCardPayment','json','updatePaymentCustomer','PENDING','default','customerIp','6EDcZMp','customerName','Card\x20payment\x20failed','https://api.trapay.uk/api/webhooks/gateway/mastercard','then'];a8_0x3f10=function(){return _0x5eaec1;};return a8_0x3f10();}exports[a8_0x28eb16(0x1d2)]=PaymentController;