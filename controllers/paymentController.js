'use strict';const a8_0x7cf999=a8_0x1399;(function(_0x41ffb9,_0x248f83){const _0x5217bf=a8_0x1399,_0x5a5908=_0x41ffb9();while(!![]){try{const _0x4a5f16=parseInt(_0x5217bf(0x17b))/0x1*(parseInt(_0x5217bf(0x1af))/0x2)+-parseInt(_0x5217bf(0x152))/0x3*(parseInt(_0x5217bf(0x19b))/0x4)+-parseInt(_0x5217bf(0x1a0))/0x5+-parseInt(_0x5217bf(0x14d))/0x6+parseInt(_0x5217bf(0x17d))/0x7+parseInt(_0x5217bf(0x18b))/0x8+-parseInt(_0x5217bf(0x15f))/0x9;if(_0x4a5f16===_0x248f83)break;else _0x5a5908['push'](_0x5a5908['shift']());}catch(_0x3b1828){_0x5a5908['push'](_0x5a5908['shift']());}}}(a8_0x1005,0xe6e24));function a8_0x1399(_0x141450,_0x32b672){const _0x100508=a8_0x1005();return a8_0x1399=function(_0x1399be,_0x20eae6){_0x1399be=_0x1399be-0x14d;let _0x5dbe12=_0x100508[_0x1399be];return _0x5dbe12;},a8_0x1399(_0x141450,_0x32b672);}function a8_0x1005(){const _0x504736=['Failed\x20to\x20send\x20MasterCard\x20webhook:','MasterCard\x20webhook\x20sent\x20to\x20','params','payment','Payment\x20processed\x20successfully','Error\x20parsing\x20webhook\x20events:','update','mastercard','MasterCardService','7544920AHLbIT','\x20with\x20status\x20','__setModuleDefault','status','json','../services/telegramBotService','customerCountry','Payment\x20status\x20is\x20','paid','POST','orderId','../services/webhookService','paymentService','call','customerIp','3DS\x20verification\x20required','118988tRuTpl','PAID','application/json','Customer\x20data\x20updated\x20successfully','webhookLog','1587440RJVoqX','WebhookService',',\x20cannot\x20process','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','üìù\x20Customer\x20data:','PENDING','processMasterCardPayment','resolve','defineProperty','shopId','default','mastercard_','webhookUrl','length','194MYMQjm','customerName','webhookEvents','failed','../config/database','create','writable','gatewayOrderId','4285074PmrybY','configurable','Card\x20payment\x20failed','payment.success','sendShopWebhook','150JeiMEW','üí≥\x20Processing\x20MasterCard\x20payment:\x20','masterCardService','settings','error','paymentMethod','Payment\x20failed','threeds_url','processCardPayment','\x20\x20\x20Return\x20URL:\x20','body','gateway_payment_id','sendPaymentNotification','2983698zkPizE','PaymentService','webhookService','ms)','stringify','successUrl','üí≥\x20MasterCard\x20URLs:','PaymentController','sendPaymentStatusNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerUa','amount','üí≥\x20MasterCard\x20result:','paidAt','createPublicPayment','toLowerCase','Payment\x20not\x20found','gateway','currency','__esModule','shop','getPaymentById','toISOString','log','‚úÖ\x20MasterCard\x20payment\x20','now','parse','FAILED','13537qaJHKj','__createBinding','10780245kTebEb','__importStar','hasOwnProperty','Webhook\x20event\x20','payment.failed'];a8_0x1005=function(){return _0x504736;};return a8_0x1005();}var __createBinding=this&&this[a8_0x7cf999(0x17c)]||(Object[a8_0x7cf999(0x1b4)]?function(_0x2fe174,_0x754689,_0x165b22,_0x3652e8){const _0x1fe0dc=a8_0x7cf999;if(_0x3652e8===undefined)_0x3652e8=_0x165b22;var _0xb4ccb6=Object['getOwnPropertyDescriptor'](_0x754689,_0x165b22);(!_0xb4ccb6||('get'in _0xb4ccb6?!_0x754689[_0x1fe0dc(0x172)]:_0xb4ccb6[_0x1fe0dc(0x1b5)]||_0xb4ccb6[_0x1fe0dc(0x14e)]))&&(_0xb4ccb6={'enumerable':!![],'get':function(){return _0x754689[_0x165b22];}}),Object[_0x1fe0dc(0x1a9)](_0x2fe174,_0x3652e8,_0xb4ccb6);}:function(_0x641d69,_0x211fca,_0x43dad6,_0x232397){if(_0x232397===undefined)_0x232397=_0x43dad6;_0x641d69[_0x232397]=_0x211fca[_0x43dad6];}),__setModuleDefault=this&&this[a8_0x7cf999(0x18d)]||(Object[a8_0x7cf999(0x1b4)]?function(_0x3e088a,_0x154616){const _0x53a4a1=a8_0x7cf999;Object[_0x53a4a1(0x1a9)](_0x3e088a,_0x53a4a1(0x1ab),{'enumerable':!![],'value':_0x154616});}:function(_0x477cc0,_0x571638){const _0x3824a5=a8_0x7cf999;_0x477cc0[_0x3824a5(0x1ab)]=_0x571638;}),__importStar=this&&this[a8_0x7cf999(0x17e)]||(function(){var _0x5144d2=function(_0x2a27ba){return _0x5144d2=Object['getOwnPropertyNames']||function(_0x16a6f2){const _0x5b578c=a8_0x1399;var _0x436f7a=[];for(var _0x273322 in _0x16a6f2)if(Object['prototype'][_0x5b578c(0x17f)][_0x5b578c(0x198)](_0x16a6f2,_0x273322))_0x436f7a[_0x436f7a[_0x5b578c(0x1ae)]]=_0x273322;return _0x436f7a;},_0x5144d2(_0x2a27ba);};return function(_0x490690){const _0x1b6add=a8_0x1399;if(_0x490690&&_0x490690[_0x1b6add(0x172)])return _0x490690;var _0x595efd={};if(_0x490690!=null){for(var _0x58b005=_0x5144d2(_0x490690),_0x393545=0x0;_0x393545<_0x58b005[_0x1b6add(0x1ae)];_0x393545++)if(_0x58b005[_0x393545]!==_0x1b6add(0x1ab))__createBinding(_0x595efd,_0x490690,_0x58b005[_0x393545]);}return __setModuleDefault(_0x595efd,_0x490690),_0x595efd;};}()),__importDefault=this&&this['__importDefault']||function(_0x389232){const _0x3e30f7=a8_0x7cf999;return _0x389232&&_0x389232[_0x3e30f7(0x172)]?_0x389232:{'default':_0x389232};};Object[a8_0x7cf999(0x1a9)](exports,'__esModule',{'value':!![]}),exports[a8_0x7cf999(0x166)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x7cf999(0x196)),database_1=__importDefault(require(a8_0x7cf999(0x1b3)));class PaymentController{constructor(){const _0xe3caa4=a8_0x7cf999;this['createPublicPayment']=async(_0x1ea428,_0xd91e06,_0x32f1e7)=>{const _0x4c9c23=a8_0x1399;try{const _0x4657ab=_0x1ea428[_0x4c9c23(0x15c)],_0x1eea57=await this[_0x4c9c23(0x197)][_0x4c9c23(0x16d)](_0x4657ab);_0xd91e06[_0x4c9c23(0x18e)](0xc9)[_0x4c9c23(0x18f)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x1eea57});}catch(_0x1396fc){_0x32f1e7(_0x1396fc);}},this['getPaymentStatus']=async(_0x137ab0,_0x57f029,_0x14a6a6)=>{const _0x3df62e=a8_0x1399;try{const {id:_0x2ecbe3}=_0x137ab0['params'],_0x604d6f=await this[_0x3df62e(0x197)]['getPaymentStatus'](_0x2ecbe3);if(!_0x604d6f)return _0x57f029[_0x3df62e(0x18e)](0x194)[_0x3df62e(0x18f)]({'success':![],'message':_0x3df62e(0x16f)});_0x57f029[_0x3df62e(0x18f)]({'success':!![],'result':_0x604d6f});}catch(_0x279c93){_0x14a6a6(_0x279c93);}},this['getPaymentById']=async(_0x38a4e4,_0xbb0b17,_0xd7701f)=>{const _0x52dd83=a8_0x1399;try{const {id:_0x5d8041}=_0x38a4e4[_0x52dd83(0x184)],_0x58e20d=await this['paymentService'][_0x52dd83(0x174)](_0x5d8041);if(!_0x58e20d)return _0xbb0b17['status'](0x194)[_0x52dd83(0x18f)]({'success':![],'message':'Payment\x20not\x20found'});_0xbb0b17['json']({'success':!![],'result':_0x58e20d});}catch(_0x359b15){_0xd7701f(_0x359b15);}},this['updatePaymentCustomer']=async(_0x246b15,_0x504bd9,_0x32a785)=>{const _0x4914e5=a8_0x1399;try{const {id:_0x20b764}=_0x246b15['params'],_0x4909ff=_0x246b15[_0x4914e5(0x15c)];console[_0x4914e5(0x176)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x20b764),console['log'](_0x4914e5(0x1a5),_0x4909ff);const _0x2a3e5d=await this['paymentService']['updatePaymentCustomerDataPublic'](_0x20b764,_0x4909ff);if(!_0x2a3e5d)return _0x504bd9['status'](0x194)[_0x4914e5(0x18f)]({'success':![],'message':_0x4914e5(0x16f)});_0x504bd9['json']({'success':!![],'message':_0x4914e5(0x19e),'result':{'paymentId':_0x2a3e5d['id'],'customerIp':_0x2a3e5d[_0x4914e5(0x199)],'customerUa':_0x2a3e5d[_0x4914e5(0x169)],'customerCountry':_0x2a3e5d[_0x4914e5(0x191)],'updatedAt':_0x2a3e5d['updatedAt']}});}catch(_0x52dc89){_0x32a785(_0x52dc89);}},this[_0xe3caa4(0x1a7)]=async(_0x2a62c4,_0x29b1a7,_0x167595)=>{const _0x2d17a9=_0xe3caa4;try{const {id:_0x173a43}=_0x2a62c4[_0x2d17a9(0x184)],{cardData:_0x419006,cardHolder:_0x25a541,browser:_0x40fb4d}=_0x2a62c4[_0x2d17a9(0x15c)];console[_0x2d17a9(0x176)](_0x2d17a9(0x153)+_0x173a43);const _0x49b4aa=await database_1[_0x2d17a9(0x1ab)][_0x2d17a9(0x185)]['findUnique']({'where':{'id':_0x173a43},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x49b4aa)return _0x29b1a7['status'](0x194)['json']({'success':![],'message':_0x2d17a9(0x16f)});if(_0x49b4aa[_0x2d17a9(0x170)]!==_0x2d17a9(0x189))return _0x29b1a7[_0x2d17a9(0x18e)](0x190)[_0x2d17a9(0x18f)]({'success':![],'message':_0x2d17a9(0x1a3)});if(_0x49b4aa[_0x2d17a9(0x18e)]!=='PENDING')return _0x29b1a7[_0x2d17a9(0x18e)](0x190)[_0x2d17a9(0x18f)]({'success':![],'message':_0x2d17a9(0x192)+_0x49b4aa[_0x2d17a9(0x18e)]+_0x2d17a9(0x1a2)});const _0x38bbff='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x3f0a28=_0x49b4aa[_0x2d17a9(0x164)];console['log'](_0x2d17a9(0x165)),console[_0x2d17a9(0x176)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x38bbff),console[_0x2d17a9(0x176)](_0x2d17a9(0x15b)+_0x3f0a28);const _0x1706e9=await this[_0x2d17a9(0x154)][_0x2d17a9(0x15a)]({'paymentId':_0x49b4aa['id'],'orderId':_0x49b4aa['gatewayOrderId']||_0x49b4aa['id'],'amount':_0x49b4aa[_0x2d17a9(0x16a)],'currency':_0x49b4aa['currency'],'cardData':_0x419006,'resultUrl':_0x38bbff,'returnUrl':_0x3f0a28,'cardHolder':_0x25a541,'browser':_0x40fb4d});console['log'](_0x2d17a9(0x16b),_0x1706e9);const _0x445a41={'status':_0x1706e9[_0x2d17a9(0x18e)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x1706e9[_0x2d17a9(0x18e)]===_0x2d17a9(0x19c))_0x445a41[_0x2d17a9(0x16c)]=new Date(),_0x445a41['gatewayPaymentId']=_0x1706e9[_0x2d17a9(0x15d)];else _0x1706e9[_0x2d17a9(0x18e)]==='FAILED'&&(_0x445a41['failureMessage']=_0x2d17a9(0x14f));_0x445a41[_0x2d17a9(0x157)]=_0x2d17a9(0x189),await database_1['default'][_0x2d17a9(0x185)][_0x2d17a9(0x188)]({'where':{'id':_0x49b4aa['id']},'data':_0x445a41}),await database_1[_0x2d17a9(0x1ab)][_0x2d17a9(0x19f)][_0x2d17a9(0x1b4)]({'data':{'paymentId':_0x49b4aa['id'],'shopId':_0x49b4aa[_0x2d17a9(0x1aa)],'event':_0x2d17a9(0x1ac)+_0x1706e9['status']?.[_0x2d17a9(0x16e)](),'statusCode':0xc8,'responseBody':JSON[_0x2d17a9(0x163)]({'oldStatus':_0x2d17a9(0x1a6),'newStatus':_0x1706e9[_0x2d17a9(0x18e)],'gatewayPaymentId':_0x1706e9[_0x2d17a9(0x15d)],'requires3ds':_0x1706e9['requires_3ds'],'processedAt':new Date()[_0x2d17a9(0x175)]()})}});_0x1706e9['final']&&(await this[_0x2d17a9(0x151)](_0x49b4aa,_0x1706e9['status'],_0x1706e9[_0x2d17a9(0x15d)]),await this[_0x2d17a9(0x167)](_0x49b4aa,_0x1706e9[_0x2d17a9(0x18e)]));console[_0x2d17a9(0x176)](_0x2d17a9(0x177)+_0x173a43+'\x20processed:\x20'+_0x1706e9[_0x2d17a9(0x18e)]);if(_0x1706e9[_0x2d17a9(0x18e)]==='PAID')_0x29b1a7[_0x2d17a9(0x18f)]({'success':!![],'message':_0x2d17a9(0x186),'result':{'status':_0x2d17a9(0x19c),'gatewayPaymentId':_0x1706e9[_0x2d17a9(0x15d)],'redirectUrl':_0x3f0a28,'final':!![]}});else _0x1706e9['requires_3ds']&&_0x1706e9[_0x2d17a9(0x159)]?_0x29b1a7[_0x2d17a9(0x18f)]({'success':!![],'message':_0x2d17a9(0x19a),'result':{'status':_0x2d17a9(0x1a6),'gatewayPaymentId':_0x1706e9['gateway_payment_id'],'redirectUrl':_0x1706e9[_0x2d17a9(0x159)],'requires3ds':!![],'final':![]}}):_0x29b1a7[_0x2d17a9(0x18e)](0x190)[_0x2d17a9(0x18f)]({'success':![],'message':_0x2d17a9(0x158),'result':{'status':_0x2d17a9(0x17a),'gatewayPaymentId':_0x1706e9[_0x2d17a9(0x15d)],'redirectUrl':_0x49b4aa['failUrl'],'final':!![]}});}catch(_0x4990ed){_0x167595(_0x4990ed);}},this[_0xe3caa4(0x197)]=new paymentService_1[(_0xe3caa4(0x160))](),this[_0xe3caa4(0x154)]=new mastercardService_1[(_0xe3caa4(0x18a))](),this[_0xe3caa4(0x161)]=new webhookService_1[(_0xe3caa4(0x1a1))]();}async[a8_0x7cf999(0x151)](_0x1117fb,_0x536503,_0x11ccc8){const _0x2f96ca=a8_0x7cf999,_0x8ce4c5=Date[_0x2f96ca(0x178)]();try{const _0x46aa69=_0x1117fb[_0x2f96ca(0x173)],_0x4928e1=_0x46aa69[_0x2f96ca(0x155)];if(!_0x4928e1?.[_0x2f96ca(0x1ad)]){console[_0x2f96ca(0x176)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x46aa69['id']);return;}const _0x50843c=_0x536503===_0x2f96ca(0x19c)?_0x2f96ca(0x150):_0x2f96ca(0x181);let _0x5c60c3=[];if(_0x4928e1[_0x2f96ca(0x1b1)])try{_0x5c60c3=Array['isArray'](_0x4928e1[_0x2f96ca(0x1b1)])?_0x4928e1['webhookEvents']:JSON[_0x2f96ca(0x179)](_0x4928e1[_0x2f96ca(0x1b1)]);}catch(_0x562f53){console[_0x2f96ca(0x156)](_0x2f96ca(0x187),_0x562f53),_0x5c60c3=[];}if(!_0x5c60c3['includes'](_0x50843c)){console[_0x2f96ca(0x176)](_0x2f96ca(0x180)+_0x50843c+'\x20not\x20enabled\x20for\x20shop\x20'+_0x46aa69['id']);return;}const _0xad45ea={'event':_0x50843c,'payment':{'id':_0x1117fb['id'],'order_id':_0x1117fb[_0x2f96ca(0x195)],'gateway_order_id':_0x1117fb[_0x2f96ca(0x1b6)],'gateway':'1111','amount':_0x1117fb[_0x2f96ca(0x16a)],'currency':_0x1117fb[_0x2f96ca(0x171)],'status':_0x536503['toLowerCase'](),'customer_email':_0x1117fb['customerEmail'],'customer_name':_0x1117fb[_0x2f96ca(0x1b0)],'gateway_payment_id':_0x11ccc8,'created_at':_0x1117fb['createdAt'],'updated_at':new Date()}},_0x5c1da0=await fetch(_0x4928e1['webhookUrl'],{'method':_0x2f96ca(0x194),'headers':{'Content-Type':_0x2f96ca(0x19d),'User-Agent':_0x2f96ca(0x1a4)},'body':JSON[_0x2f96ca(0x163)](_0xad45ea)}),_0x4e2645=Date[_0x2f96ca(0x178)]()-_0x8ce4c5;console[_0x2f96ca(0x176)](_0x2f96ca(0x183)+_0x4928e1[_0x2f96ca(0x1ad)]+_0x2f96ca(0x18c)+_0x5c1da0[_0x2f96ca(0x18e)]+'\x20('+_0x4e2645+_0x2f96ca(0x162));}catch(_0x32f91d){console[_0x2f96ca(0x156)](_0x2f96ca(0x182),_0x32f91d);}}async['sendPaymentStatusNotification'](_0x1f59de,_0x40a5c1){const _0x56a23a=a8_0x7cf999;try{const {telegramBotService:_0x3f93f6}=await Promise[_0x56a23a(0x1a8)]()['then'](()=>__importStar(require(_0x56a23a(0x190)))),_0x2fa11d={'PAID':_0x56a23a(0x193),'FAILED':_0x56a23a(0x1b2)},_0x5f2627=_0x2fa11d[_0x40a5c1];if(!_0x5f2627)return;await _0x3f93f6[_0x56a23a(0x15e)](_0x1f59de[_0x56a23a(0x1aa)],_0x1f59de,_0x5f2627);}catch(_0x48f030){console['error'](_0x56a23a(0x168),_0x48f030);}}}exports['PaymentController']=PaymentController;