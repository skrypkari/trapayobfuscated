'use strict';const a8_0x18e60f=a8_0x189c;function a8_0x189c(_0x392fc0,_0x301e6a){const _0x2623d5=a8_0x2623();return a8_0x189c=function(_0x189c8c,_0x17b3d1){_0x189c8c=_0x189c8c-0x195;let _0x52cee6=_0x2623d5[_0x189c8c];return _0x52cee6;},a8_0x189c(_0x392fc0,_0x301e6a);}(function(_0x48cbe5,_0x425336){const _0x5068da=a8_0x189c,_0x3b0c93=_0x48cbe5();while(!![]){try{const _0xf576a8=parseInt(_0x5068da(0x1ed))/0x1+-parseInt(_0x5068da(0x1bd))/0x2*(parseInt(_0x5068da(0x20f))/0x3)+parseInt(_0x5068da(0x1d6))/0x4+parseInt(_0x5068da(0x214))/0x5*(parseInt(_0x5068da(0x19c))/0x6)+-parseInt(_0x5068da(0x216))/0x7+parseInt(_0x5068da(0x1e5))/0x8*(-parseInt(_0x5068da(0x1ab))/0x9)+-parseInt(_0x5068da(0x1f4))/0xa;if(_0xf576a8===_0x425336)break;else _0x3b0c93['push'](_0x3b0c93['shift']());}catch(_0x38c817){_0x3b0c93['push'](_0x3b0c93['shift']());}}}(a8_0x2623,0xe796d));var __createBinding=this&&this[a8_0x18e60f(0x1d2)]||(Object[a8_0x18e60f(0x19b)]?function(_0x26f72b,_0x8bd87a,_0x14c050,_0x5a15dd){const _0x1e69aa=a8_0x18e60f;if(_0x5a15dd===undefined)_0x5a15dd=_0x14c050;var _0x2623f2=Object['getOwnPropertyDescriptor'](_0x8bd87a,_0x14c050);(!_0x2623f2||(_0x1e69aa(0x205)in _0x2623f2?!_0x8bd87a[_0x1e69aa(0x1e3)]:_0x2623f2['writable']||_0x2623f2[_0x1e69aa(0x1e6)]))&&(_0x2623f2={'enumerable':!![],'get':function(){return _0x8bd87a[_0x14c050];}}),Object[_0x1e69aa(0x19e)](_0x26f72b,_0x5a15dd,_0x2623f2);}:function(_0x301a14,_0x4cd522,_0xd940d4,_0x115f34){if(_0x115f34===undefined)_0x115f34=_0xd940d4;_0x301a14[_0x115f34]=_0x4cd522[_0xd940d4];}),__setModuleDefault=this&&this[a8_0x18e60f(0x1ea)]||(Object[a8_0x18e60f(0x19b)]?function(_0x1c861,_0x3f4e14){const _0x5a0924=a8_0x18e60f;Object['defineProperty'](_0x1c861,_0x5a0924(0x196),{'enumerable':!![],'value':_0x3f4e14});}:function(_0x535def,_0x227965){const _0x4e9392=a8_0x18e60f;_0x535def[_0x4e9392(0x196)]=_0x227965;}),__importStar=this&&this[a8_0x18e60f(0x1a8)]||(function(){var _0x2ac6dc=function(_0x338f0a){const _0x28e439=a8_0x189c;return _0x2ac6dc=Object[_0x28e439(0x1ee)]||function(_0x1897f5){const _0x38d34c=_0x28e439;var _0x10b806=[];for(var _0x1e0048 in _0x1897f5)if(Object['prototype'][_0x38d34c(0x20d)][_0x38d34c(0x1c3)](_0x1897f5,_0x1e0048))_0x10b806[_0x10b806[_0x38d34c(0x1d7)]]=_0x1e0048;return _0x10b806;},_0x2ac6dc(_0x338f0a);};return function(_0x2f2e7b){const _0x343be6=a8_0x189c;if(_0x2f2e7b&&_0x2f2e7b[_0x343be6(0x1e3)])return _0x2f2e7b;var _0x3ca98d={};if(_0x2f2e7b!=null){for(var _0x15be80=_0x2ac6dc(_0x2f2e7b),_0x22111f=0x0;_0x22111f<_0x15be80[_0x343be6(0x1d7)];_0x22111f++)if(_0x15be80[_0x22111f]!=='default')__createBinding(_0x3ca98d,_0x2f2e7b,_0x15be80[_0x22111f]);}return __setModuleDefault(_0x3ca98d,_0x2f2e7b),_0x3ca98d;};}()),__importDefault=this&&this[a8_0x18e60f(0x1c7)]||function(_0x253b71){const _0x111689=a8_0x18e60f;return _0x253b71&&_0x253b71[_0x111689(0x1e3)]?_0x253b71:{'default':_0x253b71};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a8_0x18e60f(0x19a)]=void 0x0;function a8_0x2623(){const _0x49ce7c=['paid','424gFNEiN','configurable','Payment\x20failed','💳\x20MasterCard\x20result:','PaymentService','__setModuleDefault','Payment\x20status\x20is\x20','processCardPayment','1329726SfnyBt','getOwnPropertyNames','email','mastercard_','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20not\x20found','payment.failed','9532840QYsNoL','toLowerCase','params','error','../services/telegramBotService','customerIp','orderId','final','FAILED','updatePaymentCustomer','\x20processed:\x20','system','shopId','application/json','gateway_payment_id','createdAt','body','get','toISOString','https://api.trapay.uk/api/webhooks/gateway/mastercard','status','update','amount','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','resolve','hasOwnProperty','Payment\x20created\x20successfully','193257CIZGbs','handleSuccessfulPayment','first_name','log','slice','2857505axZXFu','📈\x20MasterCard\x20payment\x20','4199636fjFHnd','now','last_name','sendPaymentNotification','📝\x20Customer\x20data:','default','stringify','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','\x20with\x20status\x20','PaymentController','create','12nLAuPV','getPaymentStatus','defineProperty','payment','user_agent','cardLast4','paymentMethod',',\x20cannot\x20process','../services/paymentService','payment.success','settings','PENDING','__importStar','requires_3ds','Failed\x20to\x20send\x20MasterCard\x20webhook:','61551JYsyWD','sendShopWebhook','✅\x20MasterCard\x20payment\x20','webhookEvents','gatewayPaymentId','\x20not\x20enabled\x20for\x20shop\x20','PAID','shop','\x20\x20\x20Return\x20URL:\x20','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','💳\x20Card\x20holder:\x20','paymentService','threeds_url','paidAt','gateway','customerCountry','Customer\x20data\x20updated\x20successfully','\x20\x20\x20Result\x20URL\x20(webhook):\x20','24lHBfgk','POST','mastercard','ms)','failUrl','masterCardService','call','getPaymentById','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','gatewayOrderId','__importDefault','Webhook\x20event\x20','createPublicPayment','WebhookService','../services/webhookService','webhookUrl','webhookService','processMasterCardPayment','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','1111','number','__createBinding','currency','json','sendPaymentStatusNotification','4658352gDNOtl','length','Error\x20parsing\x20webhook\x20events:','isArray','failureMessage','then','MasterCard\x20webhook\x20sent\x20to\x20','../services/paymentLinkService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerName','replace','💳\x20Processing\x20MasterCard\x20payment:\x20','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','__esModule'];a8_0x2623=function(){return _0x49ce7c;};return a8_0x2623();}const paymentService_1=require(a8_0x18e60f(0x1a4)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x18e60f(0x1cb)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x2b6628=a8_0x18e60f;this[_0x2b6628(0x1c9)]=async(_0x4902c2,_0x4cd1ad,_0x57bd05)=>{const _0x174d91=_0x2b6628;try{const _0xd3228=_0x4902c2[_0x174d91(0x204)],_0xd60351=await this[_0x174d91(0x1b6)][_0x174d91(0x1c9)](_0xd3228);_0x4cd1ad['status'](0xc9)['json']({'success':!![],'message':_0x174d91(0x20e),'result':_0xd60351});}catch(_0xf732c7){_0x57bd05(_0xf732c7);}},this[_0x2b6628(0x19d)]=async(_0x490cac,_0x415251,_0x1200e6)=>{const _0x2357d8=_0x2b6628;try{const {id:_0x480487}=_0x490cac[_0x2357d8(0x1f6)],_0x394028=await this['paymentService'][_0x2357d8(0x19d)](_0x480487);if(!_0x394028)return _0x415251[_0x2357d8(0x208)](0x194)[_0x2357d8(0x1d4)]({'success':![],'message':_0x2357d8(0x1f2)});_0x415251[_0x2357d8(0x1d4)]({'success':!![],'result':_0x394028});}catch(_0x28df3e){_0x1200e6(_0x28df3e);}},this[_0x2b6628(0x1c4)]=async(_0x224f34,_0x26bf57,_0x4d117d)=>{const _0x252aab=_0x2b6628;try{const {id:_0x1a49a8}=_0x224f34[_0x252aab(0x1f6)],_0x11170c=await this[_0x252aab(0x1b6)]['getPaymentById'](_0x1a49a8);if(!_0x11170c)return _0x26bf57[_0x252aab(0x208)](0x194)[_0x252aab(0x1d4)]({'success':![],'message':_0x252aab(0x1f2)});_0x26bf57[_0x252aab(0x1d4)]({'success':!![],'result':_0x11170c});}catch(_0x72925d){_0x4d117d(_0x72925d);}},this[_0x2b6628(0x1fd)]=async(_0x2ace0b,_0x49622c,_0x4c6d97)=>{const _0x3598aa=_0x2b6628;try{const {id:_0x43193a}=_0x2ace0b['params'],_0x34226b=_0x2ace0b['body'];console['log']('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x43193a),console[_0x3598aa(0x212)](_0x3598aa(0x195),_0x34226b);const _0x2dfc91=await this['paymentService']['updatePaymentCustomerDataPublic'](_0x43193a,_0x34226b);if(!_0x2dfc91)return _0x49622c['status'](0x194)[_0x3598aa(0x1d4)]({'success':![],'message':_0x3598aa(0x1f2)});_0x49622c[_0x3598aa(0x1d4)]({'success':!![],'message':_0x3598aa(0x1bb),'result':{'paymentId':_0x2dfc91['id'],'customerIp':_0x2dfc91[_0x3598aa(0x1f9)],'customerUa':_0x2dfc91['customerUa'],'customerCountry':_0x2dfc91[_0x3598aa(0x1ba)],'updatedAt':_0x2dfc91['updatedAt']}});}catch(_0x5647c7){_0x4c6d97(_0x5647c7);}},this[_0x2b6628(0x1ce)]=async(_0x46a356,_0x8fb8dd,_0x3c26b1)=>{const _0x410546=_0x2b6628;try{const {id:_0x42c238}=_0x46a356[_0x410546(0x1f6)],{cardData:_0x4a385c,cardHolder:_0x357a3e,browser:_0x8985cd}=_0x46a356['body'];console[_0x410546(0x212)](_0x410546(0x1e1)+_0x42c238),console[_0x410546(0x212)](_0x410546(0x1b5)+_0x357a3e[_0x410546(0x211)]+'\x20'+_0x357a3e[_0x410546(0x218)]+'\x20('+_0x357a3e['email']+')'),console[_0x410546(0x212)]('💳\x20Browser\x20IP:\x20'+_0x8985cd['ip']);const _0x2642e8={'customerName':_0x357a3e[_0x410546(0x211)]+'\x20'+_0x357a3e[_0x410546(0x218)],'customerEmail':_0x357a3e[_0x410546(0x1ef)],'customerIp':_0x8985cd['ip'],'customerUa':_0x8985cd[_0x410546(0x1a0)]},_0x1b6c89=await database_1[_0x410546(0x196)][_0x410546(0x19f)]['findUnique']({'where':{'id':_0x42c238},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1b6c89)return _0x8fb8dd[_0x410546(0x208)](0x194)[_0x410546(0x1d4)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1b6c89[_0x410546(0x1b9)]!==_0x410546(0x1bf))return _0x8fb8dd[_0x410546(0x208)](0x190)[_0x410546(0x1d4)]({'success':![],'message':_0x410546(0x20b)});if(_0x1b6c89['status']!==_0x410546(0x1a7))return _0x8fb8dd[_0x410546(0x208)](0x190)['json']({'success':![],'message':_0x410546(0x1eb)+_0x1b6c89[_0x410546(0x208)]+_0x410546(0x1a3)});await database_1[_0x410546(0x196)][_0x410546(0x19f)][_0x410546(0x209)]({'where':{'id':_0x42c238},'data':{..._0x2642e8,'updatedAt':new Date()}});const _0x58ee95=_0x410546(0x207),_0x4cb861=_0x1b6c89['successUrl'];console[_0x410546(0x212)]('💳\x20MasterCard\x20URLs:'),console[_0x410546(0x212)](_0x410546(0x1bc)+_0x58ee95),console['log'](_0x410546(0x1b3)+_0x4cb861);const _0x2527a5={'first_name':_0x357a3e[_0x410546(0x211)],'last_name':_0x357a3e['last_name'],'email':_0x357a3e[_0x410546(0x1ef)]},_0x1c405a=await this[_0x410546(0x1c2)][_0x410546(0x1ec)]({'paymentId':_0x1b6c89['id'],'orderId':_0x1b6c89[_0x410546(0x1c6)]||_0x1b6c89['id'],'amount':_0x1b6c89['amount'],'currency':_0x1b6c89[_0x410546(0x1d3)],'cardData':_0x4a385c,'resultUrl':_0x58ee95,'returnUrl':_0x4cb861,'cardHolder':_0x2527a5,'browser':_0x8985cd});console['log'](_0x410546(0x1e8),_0x1c405a);const _0x3e01ca={'status':_0x1c405a[_0x410546(0x208)],'updatedAt':new Date(),'statusChangedBy':_0x410546(0x1ff),'statusChangedAt':new Date()};_0x1c405a[_0x410546(0x202)]&&(_0x3e01ca[_0x410546(0x1af)]=_0x1c405a[_0x410546(0x202)],console[_0x410546(0x212)]('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x1c405a[_0x410546(0x202)]));if(_0x1c405a[_0x410546(0x208)]==='PAID')_0x3e01ca[_0x410546(0x1b8)]=new Date();else _0x1c405a[_0x410546(0x208)]===_0x410546(0x1fc)&&(_0x3e01ca[_0x410546(0x1da)]='Card\x20payment\x20failed');_0x3e01ca[_0x410546(0x1a2)]=_0x410546(0x1bf);if(_0x4a385c[_0x410546(0x1d1)]){const _0x4da951=_0x4a385c[_0x410546(0x1d1)][_0x410546(0x1e0)](/[\s-]/g,'');_0x3e01ca[_0x410546(0x1a1)]=_0x4da951[_0x410546(0x213)](-0x4),console[_0x410546(0x212)](_0x410546(0x1b4)+_0x3e01ca[_0x410546(0x1a1)]);}await database_1['default'][_0x410546(0x19f)][_0x410546(0x209)]({'where':{'id':_0x1b6c89['id']},'data':_0x3e01ca}),await database_1[_0x410546(0x196)]['webhookLog']['create']({'data':{'paymentId':_0x1b6c89['id'],'shopId':_0x1b6c89[_0x410546(0x200)],'event':_0x410546(0x1f0)+_0x1c405a[_0x410546(0x208)]?.[_0x410546(0x1f5)](),'statusCode':0xc8,'responseBody':JSON[_0x410546(0x197)]({'oldStatus':_0x410546(0x1a7),'newStatus':_0x1c405a[_0x410546(0x208)],'gatewayPaymentId':_0x1c405a[_0x410546(0x202)],'requires3ds':_0x1c405a[_0x410546(0x1a9)],'processedAt':new Date()[_0x410546(0x206)]()})}});if(_0x1c405a[_0x410546(0x1fb)]){await this[_0x410546(0x1ac)](_0x1b6c89,_0x1c405a['status'],_0x1c405a[_0x410546(0x202)]),await this[_0x410546(0x1d5)](_0x1b6c89,_0x1c405a[_0x410546(0x208)]);if(_0x1c405a[_0x410546(0x208)]===_0x410546(0x1b1)){console[_0x410546(0x212)](_0x410546(0x215)+_0x42c238+_0x410546(0x1cf));try{const {PaymentLinkService:_0x5d7f01}=await Promise[_0x410546(0x20c)]()[_0x410546(0x1db)](()=>__importStar(require(_0x410546(0x1dd)))),_0x338bd4=new _0x5d7f01();await _0x338bd4[_0x410546(0x210)](_0x42c238),console[_0x410546(0x212)](_0x410546(0x1c5)+_0x42c238);}catch(_0x4f615c){console[_0x410546(0x1f7)](_0x410546(0x198),_0x4f615c);}}}console[_0x410546(0x212)](_0x410546(0x1ad)+_0x42c238+_0x410546(0x1fe)+_0x1c405a[_0x410546(0x208)]);if(_0x1c405a['status']==='PAID')_0x8fb8dd[_0x410546(0x1d4)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x410546(0x1b1),'gatewayPaymentId':_0x1c405a[_0x410546(0x202)],'redirectUrl':_0x4cb861,'final':!![]}});else _0x1c405a[_0x410546(0x1a9)]&&_0x1c405a[_0x410546(0x1b7)]?_0x8fb8dd[_0x410546(0x1d4)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x410546(0x1a7),'gatewayPaymentId':_0x1c405a['gateway_payment_id'],'redirectUrl':_0x1c405a[_0x410546(0x1b7)],'requires3ds':!![],'final':![]}}):_0x8fb8dd[_0x410546(0x208)](0x190)[_0x410546(0x1d4)]({'success':![],'message':_0x410546(0x1e7),'result':{'status':_0x410546(0x1fc),'gatewayPaymentId':_0x1c405a[_0x410546(0x202)],'redirectUrl':_0x1b6c89[_0x410546(0x1c1)],'final':!![]}});}catch(_0x466086){_0x3c26b1(_0x466086);}},this[_0x2b6628(0x1b6)]=new paymentService_1[(_0x2b6628(0x1e9))](),this[_0x2b6628(0x1c2)]=new mastercardService_1['MasterCardService'](),this[_0x2b6628(0x1cd)]=new webhookService_1[(_0x2b6628(0x1ca))]();}async[a8_0x18e60f(0x1ac)](_0xef51f9,_0x23e5fa,_0x34cb04){const _0xe2f717=a8_0x18e60f,_0x4b39c7=Date[_0xe2f717(0x217)]();try{const _0xcd3a16=_0xef51f9[_0xe2f717(0x1b2)],_0x3aa99b=_0xcd3a16[_0xe2f717(0x1a6)];if(!_0x3aa99b?.[_0xe2f717(0x1cc)]){console[_0xe2f717(0x212)](_0xe2f717(0x1de)+_0xcd3a16['id']);return;}const _0x3410d3=_0x23e5fa===_0xe2f717(0x1b1)?_0xe2f717(0x1a5):_0xe2f717(0x1f3);let _0x3e2e71=[];if(_0x3aa99b[_0xe2f717(0x1ae)])try{_0x3e2e71=Array[_0xe2f717(0x1d9)](_0x3aa99b['webhookEvents'])?_0x3aa99b['webhookEvents']:JSON['parse'](_0x3aa99b['webhookEvents']);}catch(_0x2fed21){console[_0xe2f717(0x1f7)](_0xe2f717(0x1d8),_0x2fed21),_0x3e2e71=[];}if(!_0x3e2e71['includes'](_0x3410d3)){console[_0xe2f717(0x212)](_0xe2f717(0x1c8)+_0x3410d3+_0xe2f717(0x1b0)+_0xcd3a16['id']);return;}const _0x2f9099={'event':_0x3410d3,'payment':{'id':_0xef51f9['id'],'order_id':_0xef51f9[_0xe2f717(0x1fa)],'gateway_order_id':_0xef51f9['gatewayOrderId'],'gateway':_0xe2f717(0x1d0),'amount':_0xef51f9[_0xe2f717(0x20a)],'currency':_0xef51f9['currency'],'status':_0x23e5fa['toLowerCase'](),'customer_email':_0xef51f9['customerEmail'],'customer_name':_0xef51f9[_0xe2f717(0x1df)],'gateway_payment_id':_0x34cb04,'created_at':_0xef51f9[_0xe2f717(0x203)],'updated_at':new Date()}},_0x21b1f2=await fetch(_0x3aa99b['webhookUrl'],{'method':_0xe2f717(0x1be),'headers':{'Content-Type':_0xe2f717(0x201),'User-Agent':_0xe2f717(0x1e2)},'body':JSON['stringify'](_0x2f9099)}),_0x18594c=Date[_0xe2f717(0x217)]()-_0x4b39c7;console[_0xe2f717(0x212)](_0xe2f717(0x1dc)+_0x3aa99b['webhookUrl']+_0xe2f717(0x199)+_0x21b1f2[_0xe2f717(0x208)]+'\x20('+_0x18594c+_0xe2f717(0x1c0));}catch(_0x5c8682){console[_0xe2f717(0x1f7)](_0xe2f717(0x1aa),_0x5c8682);}}async[a8_0x18e60f(0x1d5)](_0x15686f,_0x4d0e63){const _0x407a78=a8_0x18e60f;try{const {telegramBotService:_0x512f7f}=await Promise[_0x407a78(0x20c)]()[_0x407a78(0x1db)](()=>__importStar(require(_0x407a78(0x1f8)))),_0x348f6f={'PAID':_0x407a78(0x1e4),'FAILED':'failed'},_0x6643b2=_0x348f6f[_0x4d0e63];if(!_0x6643b2)return;await _0x512f7f[_0x407a78(0x219)](_0x15686f['shopId'],_0x15686f,_0x6643b2);}catch(_0x2ebb02){console[_0x407a78(0x1f7)](_0x407a78(0x1f1),_0x2ebb02);}}}exports['PaymentController']=PaymentController;