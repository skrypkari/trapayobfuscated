'use strict';const a8_0x486a1f=a8_0x3cd4;(function(_0x4fe5e2,_0x42d3a3){const _0x24756e=a8_0x3cd4,_0x128ac3=_0x4fe5e2();while(!![]){try{const _0x22a9cf=parseInt(_0x24756e(0x171))/0x1+parseInt(_0x24756e(0x176))/0x2+-parseInt(_0x24756e(0x161))/0x3+-parseInt(_0x24756e(0x16c))/0x4+parseInt(_0x24756e(0x17d))/0x5+-parseInt(_0x24756e(0x1af))/0x6*(-parseInt(_0x24756e(0x1a6))/0x7)+-parseInt(_0x24756e(0x18d))/0x8;if(_0x22a9cf===_0x42d3a3)break;else _0x128ac3['push'](_0x128ac3['shift']());}catch(_0x235ed1){_0x128ac3['push'](_0x128ac3['shift']());}}}(a8_0x4fef,0x9a9f3));var __createBinding=this&&this['__createBinding']||(Object[a8_0x486a1f(0x1a7)]?function(_0x82bb75,_0x252950,_0x1649f2,_0x21a0ca){const _0xbead0=a8_0x486a1f;if(_0x21a0ca===undefined)_0x21a0ca=_0x1649f2;var _0x43a070=Object[_0xbead0(0x1b9)](_0x252950,_0x1649f2);(!_0x43a070||('get'in _0x43a070?!_0x252950[_0xbead0(0x165)]:_0x43a070[_0xbead0(0x191)]||_0x43a070['configurable']))&&(_0x43a070={'enumerable':!![],'get':function(){return _0x252950[_0x1649f2];}}),Object[_0xbead0(0x197)](_0x82bb75,_0x21a0ca,_0x43a070);}:function(_0x5cdffe,_0x554cb4,_0x5e1b47,_0x40eabd){if(_0x40eabd===undefined)_0x40eabd=_0x5e1b47;_0x5cdffe[_0x40eabd]=_0x554cb4[_0x5e1b47];}),__setModuleDefault=this&&this[a8_0x486a1f(0x1b5)]||(Object[a8_0x486a1f(0x1a7)]?function(_0x38477f,_0x2eb59d){const _0x13f433=a8_0x486a1f;Object[_0x13f433(0x197)](_0x38477f,_0x13f433(0x160),{'enumerable':!![],'value':_0x2eb59d});}:function(_0x426a16,_0x2e6187){const _0x3e837f=a8_0x486a1f;_0x426a16[_0x3e837f(0x160)]=_0x2e6187;}),__importStar=this&&this[a8_0x486a1f(0x17f)]||(function(){var _0x34ddaf=function(_0x823eae){const _0x3adc9e=a8_0x3cd4;return _0x34ddaf=Object[_0x3adc9e(0x184)]||function(_0x438d6e){const _0x3d9c86=_0x3adc9e;var _0x56c206=[];for(var _0x2d7389 in _0x438d6e)if(Object['prototype'][_0x3d9c86(0x1b6)]['call'](_0x438d6e,_0x2d7389))_0x56c206[_0x56c206[_0x3d9c86(0x173)]]=_0x2d7389;return _0x56c206;},_0x34ddaf(_0x823eae);};return function(_0x17e2ec){const _0x51a941=a8_0x3cd4;if(_0x17e2ec&&_0x17e2ec[_0x51a941(0x165)])return _0x17e2ec;var _0x5a0d3b={};if(_0x17e2ec!=null){for(var _0x3b6245=_0x34ddaf(_0x17e2ec),_0x14fe79=0x0;_0x14fe79<_0x3b6245[_0x51a941(0x173)];_0x14fe79++)if(_0x3b6245[_0x14fe79]!==_0x51a941(0x160))__createBinding(_0x5a0d3b,_0x17e2ec,_0x3b6245[_0x14fe79]);}return __setModuleDefault(_0x5a0d3b,_0x17e2ec),_0x5a0d3b;};}()),__importDefault=this&&this['__importDefault']||function(_0x10b0b1){return _0x10b0b1&&_0x10b0b1['__esModule']?_0x10b0b1:{'default':_0x10b0b1};};function a8_0x3cd4(_0x508c61,_0x506c21){const _0x4fef68=a8_0x4fef();return a8_0x3cd4=function(_0x3cd420,_0x43f42c){_0x3cd420=_0x3cd420-0x158;let _0x145b91=_0x4fef68[_0x3cd420];return _0x145b91;},a8_0x3cd4(_0x508c61,_0x506c21);}Object[a8_0x486a1f(0x197)](exports,a8_0x486a1f(0x165),{'value':!![]}),exports[a8_0x486a1f(0x15f)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x486a1f(0x199)),webhookService_1=require(a8_0x486a1f(0x17e)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x5c94ae=a8_0x486a1f;this[_0x5c94ae(0x174)]=async(_0x559d4a,_0x3bc42d,_0x5721de)=>{const _0x4ef1d3=_0x5c94ae;try{const _0x538e01=_0x559d4a['body'],_0x160ead=await this[_0x4ef1d3(0x1a8)][_0x4ef1d3(0x174)](_0x538e01);_0x3bc42d[_0x4ef1d3(0x19c)](0xc9)[_0x4ef1d3(0x19a)]({'success':!![],'message':_0x4ef1d3(0x18b),'result':_0x160ead});}catch(_0x35ee66){_0x5721de(_0x35ee66);}},this['getPaymentStatus']=async(_0x49ab47,_0x157543,_0xf1f426)=>{const _0x256c14=_0x5c94ae;try{const {id:_0x306537}=_0x49ab47[_0x256c14(0x189)],_0x440490=await this[_0x256c14(0x1a8)]['getPaymentStatus'](_0x306537);if(!_0x440490)return _0x157543[_0x256c14(0x19c)](0x194)[_0x256c14(0x19a)]({'success':![],'message':'Payment\x20not\x20found'});_0x157543['json']({'success':!![],'result':_0x440490});}catch(_0x2ec361){_0xf1f426(_0x2ec361);}},this['getPaymentById']=async(_0x2aa9b8,_0x4cc339,_0x12f628)=>{const _0x531940=_0x5c94ae;try{const {id:_0x4ff7e5}=_0x2aa9b8[_0x531940(0x189)],_0x4d4efa=await this['paymentService']['getPaymentById'](_0x4ff7e5);if(!_0x4d4efa)return _0x4cc339[_0x531940(0x19c)](0x194)[_0x531940(0x19a)]({'success':![],'message':'Payment\x20not\x20found'});_0x4cc339[_0x531940(0x19a)]({'success':!![],'result':_0x4d4efa});}catch(_0x44f9cd){_0x12f628(_0x44f9cd);}},this[_0x5c94ae(0x186)]=async(_0x51daff,_0x4013d7,_0x3ca433)=>{const _0x1b4681=_0x5c94ae;try{const {id:_0x3b79c6}=_0x51daff['params'],{cardData:_0x36b0b1,cardHolder:_0x171359,browser:_0x55e340}=_0x51daff[_0x1b4681(0x1b4)];console[_0x1b4681(0x19f)](_0x1b4681(0x15d)+_0x3b79c6);const _0x593ab8=await database_1[_0x1b4681(0x160)][_0x1b4681(0x185)][_0x1b4681(0x1bd)]({'where':{'id':_0x3b79c6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x593ab8)return _0x4013d7[_0x1b4681(0x19c)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x593ab8[_0x1b4681(0x183)]!==_0x1b4681(0x19d))return _0x4013d7['status'](0x190)[_0x1b4681(0x19a)]({'success':![],'message':_0x1b4681(0x16f)});if(_0x593ab8[_0x1b4681(0x19c)]!==_0x1b4681(0x180))return _0x4013d7[_0x1b4681(0x19c)](0x190)[_0x1b4681(0x19a)]({'success':![],'message':_0x1b4681(0x1ae)+_0x593ab8[_0x1b4681(0x19c)]+_0x1b4681(0x187)});const _0x26b494=_0x1b4681(0x15c),_0xe771a1=_0x593ab8[_0x1b4681(0x175)];console[_0x1b4681(0x19f)](_0x1b4681(0x170)),console['log'](_0x1b4681(0x1a2)+_0x26b494),console['log'](_0x1b4681(0x16a)+_0xe771a1);const _0x2bc1f5=await this[_0x1b4681(0x1b8)][_0x1b4681(0x1a3)]({'paymentId':_0x593ab8['id'],'orderId':_0x593ab8[_0x1b4681(0x158)]||_0x593ab8['id'],'amount':_0x593ab8[_0x1b4681(0x16e)],'currency':_0x593ab8[_0x1b4681(0x18e)],'cardData':_0x36b0b1,'resultUrl':_0x26b494,'returnUrl':_0xe771a1,'cardHolder':_0x171359,'browser':_0x55e340});console[_0x1b4681(0x19f)](_0x1b4681(0x17b),_0x2bc1f5);const _0x38db34={'status':_0x2bc1f5[_0x1b4681(0x19c)],'updatedAt':new Date(),'statusChangedBy':_0x1b4681(0x17a),'statusChangedAt':new Date()};if(_0x2bc1f5[_0x1b4681(0x19c)]===_0x1b4681(0x163))_0x38db34[_0x1b4681(0x167)]=new Date(),_0x38db34[_0x1b4681(0x1a1)]=_0x2bc1f5[_0x1b4681(0x181)];else _0x2bc1f5[_0x1b4681(0x19c)]==='FAILED'&&(_0x38db34[_0x1b4681(0x198)]=_0x1b4681(0x19e));_0x38db34[_0x1b4681(0x1a9)]=_0x1b4681(0x19d),await database_1['default'][_0x1b4681(0x185)][_0x1b4681(0x195)]({'where':{'id':_0x593ab8['id']},'data':_0x38db34}),await database_1[_0x1b4681(0x160)]['webhookLog'][_0x1b4681(0x1a7)]({'data':{'paymentId':_0x593ab8['id'],'shopId':_0x593ab8[_0x1b4681(0x16d)],'event':_0x1b4681(0x159)+_0x2bc1f5['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1b4681(0x1a4)]({'oldStatus':_0x1b4681(0x180),'newStatus':_0x2bc1f5[_0x1b4681(0x19c)],'gatewayPaymentId':_0x2bc1f5[_0x1b4681(0x181)],'requires3ds':_0x2bc1f5[_0x1b4681(0x17c)],'processedAt':new Date()[_0x1b4681(0x194)]()})}});_0x2bc1f5[_0x1b4681(0x1ba)]&&(await this[_0x1b4681(0x1aa)](_0x593ab8,_0x2bc1f5['status'],_0x2bc1f5[_0x1b4681(0x181)]),await this[_0x1b4681(0x169)](_0x593ab8,_0x2bc1f5[_0x1b4681(0x19c)]));console['log'](_0x1b4681(0x15e)+_0x3b79c6+_0x1b4681(0x1b0)+_0x2bc1f5[_0x1b4681(0x19c)]);if(_0x2bc1f5['status']===_0x1b4681(0x163))_0x4013d7['json']({'success':!![],'message':_0x1b4681(0x179),'result':{'status':_0x1b4681(0x163),'gatewayPaymentId':_0x2bc1f5[_0x1b4681(0x181)],'redirectUrl':_0xe771a1,'final':!![]}});else _0x2bc1f5[_0x1b4681(0x17c)]&&_0x2bc1f5['threeds_url']?_0x4013d7[_0x1b4681(0x19a)]({'success':!![],'message':_0x1b4681(0x1ab),'result':{'status':_0x1b4681(0x180),'gatewayPaymentId':_0x2bc1f5[_0x1b4681(0x181)],'redirectUrl':_0x2bc1f5[_0x1b4681(0x1b7)],'requires3ds':!![],'final':![]}}):_0x4013d7['status'](0x190)[_0x1b4681(0x19a)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x1b4681(0x18c),'gatewayPaymentId':_0x2bc1f5[_0x1b4681(0x181)],'redirectUrl':_0x593ab8[_0x1b4681(0x178)],'final':!![]}});}catch(_0x22046a){_0x3ca433(_0x22046a);}},this[_0x5c94ae(0x1a8)]=new paymentService_1[(_0x5c94ae(0x164))](),this[_0x5c94ae(0x1b8)]=new mastercardService_1[(_0x5c94ae(0x1a5))](),this['webhookService']=new webhookService_1[(_0x5c94ae(0x1ac))]();}async[a8_0x486a1f(0x1aa)](_0x22d0dd,_0x529eb4,_0x436ec1){const _0x4ad79e=a8_0x486a1f,_0x4f4fe2=Date[_0x4ad79e(0x1b3)]();try{const _0x30a2d9=_0x22d0dd['shop'],_0x5b2dfe=_0x30a2d9['settings'];if(!_0x5b2dfe?.[_0x4ad79e(0x16b)]){console[_0x4ad79e(0x19f)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x30a2d9['id']);return;}const _0x1c3623=_0x529eb4==='PAID'?_0x4ad79e(0x190):_0x4ad79e(0x1bb);let _0x44d039=[];if(_0x5b2dfe[_0x4ad79e(0x1b1)])try{_0x44d039=Array[_0x4ad79e(0x1be)](_0x5b2dfe[_0x4ad79e(0x1b1)])?_0x5b2dfe['webhookEvents']:JSON['parse'](_0x5b2dfe['webhookEvents']);}catch(_0x5c9d55){console[_0x4ad79e(0x18f)](_0x4ad79e(0x192),_0x5c9d55),_0x44d039=[];}if(!_0x44d039[_0x4ad79e(0x196)](_0x1c3623)){console['log']('Webhook\x20event\x20'+_0x1c3623+_0x4ad79e(0x177)+_0x30a2d9['id']);return;}const _0x5e79e2={'event':_0x1c3623,'payment':{'id':_0x22d0dd['id'],'order_id':_0x22d0dd[_0x4ad79e(0x172)],'gateway_order_id':_0x22d0dd[_0x4ad79e(0x158)],'gateway':_0x4ad79e(0x168),'amount':_0x22d0dd[_0x4ad79e(0x16e)],'currency':_0x22d0dd[_0x4ad79e(0x18e)],'status':_0x529eb4[_0x4ad79e(0x193)](),'customer_email':_0x22d0dd['customerEmail'],'customer_name':_0x22d0dd[_0x4ad79e(0x1ad)],'gateway_payment_id':_0x436ec1,'created_at':_0x22d0dd[_0x4ad79e(0x1bf)],'updated_at':new Date()}},_0x1c4575=await fetch(_0x5b2dfe[_0x4ad79e(0x16b)],{'method':_0x4ad79e(0x162),'headers':{'Content-Type':_0x4ad79e(0x18a),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x4ad79e(0x1a4)](_0x5e79e2)}),_0x555855=Date[_0x4ad79e(0x1b3)]()-_0x4f4fe2;console[_0x4ad79e(0x19f)](_0x4ad79e(0x182)+_0x5b2dfe['webhookUrl']+_0x4ad79e(0x15b)+_0x1c4575[_0x4ad79e(0x19c)]+'\x20('+_0x555855+_0x4ad79e(0x188));}catch(_0x1ac773){console[_0x4ad79e(0x18f)](_0x4ad79e(0x1a0),_0x1ac773);}}async[a8_0x486a1f(0x169)](_0xf56d04,_0x38e350){const _0x265026=a8_0x486a1f;try{const {telegramBotService:_0xd49f14}=await Promise['resolve']()[_0x265026(0x1bc)](()=>__importStar(require(_0x265026(0x15a)))),_0xf6750b={'PAID':'paid','FAILED':_0x265026(0x19b)},_0x1d2000=_0xf6750b[_0x38e350];if(!_0x1d2000)return;await _0xd49f14[_0x265026(0x166)](_0xf56d04[_0x265026(0x16d)],_0xf56d04,_0x1d2000);}catch(_0x7fb056){console[_0x265026(0x18f)](_0x265026(0x1b2),_0x7fb056);}}}function a8_0x4fef(){const _0x19b609=['error','payment.success','writable','Error\x20parsing\x20webhook\x20events:','toLowerCase','toISOString','update','includes','defineProperty','failureMessage','../services/gateways/mastercardService','json','failed','status','mastercard','Card\x20payment\x20failed','log','Failed\x20to\x20send\x20MasterCard\x20webhook:','gatewayPaymentId','\x20\x20\x20Result\x20URL\x20(webhook):\x20','processCardPayment','stringify','MasterCardService','2776277JaGkxb','create','paymentService','paymentMethod','sendShopWebhook','3DS\x20verification\x20required','WebhookService','customerName','Payment\x20status\x20is\x20','18ImqTfi','\x20processed:\x20','webhookEvents','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','now','body','__setModuleDefault','hasOwnProperty','threeds_url','masterCardService','getOwnPropertyDescriptor','final','payment.failed','then','findUnique','isArray','createdAt','gatewayOrderId','mastercard_','../services/telegramBotService','\x20with\x20status\x20','https://api.trapay.uk/api/webhooks/gateway/mastercard','💳\x20Processing\x20MasterCard\x20payment:\x20','✅\x20MasterCard\x20payment\x20','PaymentController','default','2136459lmYaxl','POST','PAID','PaymentService','__esModule','sendPaymentNotification','paidAt','1111','sendPaymentStatusNotification','\x20\x20\x20Return\x20URL:\x20','webhookUrl','3386316yoLTjt','shopId','amount','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','💳\x20MasterCard\x20URLs:','255839KeKyOR','orderId','length','createPublicPayment','successUrl','1972118YksNLo','\x20not\x20enabled\x20for\x20shop\x20','failUrl','Payment\x20processed\x20successfully','system','💳\x20MasterCard\x20result:','requires_3ds','5208340deNijy','../services/webhookService','__importStar','PENDING','gateway_payment_id','MasterCard\x20webhook\x20sent\x20to\x20','gateway','getOwnPropertyNames','payment','processMasterCardPayment',',\x20cannot\x20process','ms)','params','application/json','Payment\x20created\x20successfully','FAILED','10250688QQdsLj','currency'];a8_0x4fef=function(){return _0x19b609;};return a8_0x4fef();}exports[a8_0x486a1f(0x15f)]=PaymentController;