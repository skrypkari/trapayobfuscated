'use strict';const a8_0x48dbc7=a8_0x397a;function a8_0x397a(_0x44869c,_0x208923){const _0x5e2914=a8_0x5e29();return a8_0x397a=function(_0x397a88,_0x312ec8){_0x397a88=_0x397a88-0x92;let _0x4f1099=_0x5e2914[_0x397a88];return _0x4f1099;},a8_0x397a(_0x44869c,_0x208923);}(function(_0x12a360,_0x146f5b){const _0x442194=a8_0x397a,_0x51365d=_0x12a360();while(!![]){try{const _0xddb7b7=parseInt(_0x442194(0xef))/0x1+parseInt(_0x442194(0xce))/0x2*(parseInt(_0x442194(0xde))/0x3)+parseInt(_0x442194(0xc5))/0x4*(parseInt(_0x442194(0xaf))/0x5)+parseInt(_0x442194(0xcc))/0x6+parseInt(_0x442194(0xd3))/0x7+parseInt(_0x442194(0xda))/0x8*(parseInt(_0x442194(0xf6))/0x9)+-parseInt(_0x442194(0xae))/0xa;if(_0xddb7b7===_0x146f5b)break;else _0x51365d['push'](_0x51365d['shift']());}catch(_0x256b2d){_0x51365d['push'](_0x51365d['shift']());}}}(a8_0x5e29,0x758f3));var __createBinding=this&&this[a8_0x48dbc7(0xcf)]||(Object['create']?function(_0x5f3675,_0x20baf0,_0x4f6c59,_0x463271){const _0x40735a=a8_0x48dbc7;if(_0x463271===undefined)_0x463271=_0x4f6c59;var _0x29d30d=Object[_0x40735a(0xb9)](_0x20baf0,_0x4f6c59);(!_0x29d30d||(_0x40735a(0xc2)in _0x29d30d?!_0x20baf0[_0x40735a(0xa4)]:_0x29d30d[_0x40735a(0xc6)]||_0x29d30d['configurable']))&&(_0x29d30d={'enumerable':!![],'get':function(){return _0x20baf0[_0x4f6c59];}}),Object[_0x40735a(0xa1)](_0x5f3675,_0x463271,_0x29d30d);}:function(_0x282bf3,_0x234f98,_0x45e74a,_0x189f99){if(_0x189f99===undefined)_0x189f99=_0x45e74a;_0x282bf3[_0x189f99]=_0x234f98[_0x45e74a];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x48dbc7(0xf2)]?function(_0x1f1a52,_0x42bacd){const _0x1520e8=a8_0x48dbc7;Object['defineProperty'](_0x1f1a52,_0x1520e8(0xc3),{'enumerable':!![],'value':_0x42bacd});}:function(_0x20d5cb,_0x27c1a0){_0x20d5cb['default']=_0x27c1a0;}),__importStar=this&&this[a8_0x48dbc7(0xdb)]||(function(){var _0x5ee739=function(_0x4fc967){const _0x15ab55=a8_0x397a;return _0x5ee739=Object[_0x15ab55(0xb7)]||function(_0x3cbf61){const _0x2ca27d=_0x15ab55;var _0x1384a6=[];for(var _0xb1b561 in _0x3cbf61)if(Object[_0x2ca27d(0xbb)][_0x2ca27d(0x96)][_0x2ca27d(0xd4)](_0x3cbf61,_0xb1b561))_0x1384a6[_0x1384a6['length']]=_0xb1b561;return _0x1384a6;},_0x5ee739(_0x4fc967);};return function(_0x314d64){const _0x49fb86=a8_0x397a;if(_0x314d64&&_0x314d64[_0x49fb86(0xa4)])return _0x314d64;var _0x55fa1c={};if(_0x314d64!=null){for(var _0x1f1425=_0x5ee739(_0x314d64),_0x21978d=0x0;_0x21978d<_0x1f1425[_0x49fb86(0x98)];_0x21978d++)if(_0x1f1425[_0x21978d]!==_0x49fb86(0xc3))__createBinding(_0x55fa1c,_0x314d64,_0x1f1425[_0x21978d]);}return __setModuleDefault(_0x55fa1c,_0x314d64),_0x55fa1c;};}()),__importDefault=this&&this['__importDefault']||function(_0x7f7f2){const _0x2c5ae8=a8_0x48dbc7;return _0x7f7f2&&_0x7f7f2[_0x2c5ae8(0xa4)]?_0x7f7f2:{'default':_0x7f7f2};};Object['defineProperty'](exports,a8_0x48dbc7(0xa4),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x48dbc7(0xd1)),mastercardService_1=require(a8_0x48dbc7(0xd6)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x48dbc7(0xaa)));function a8_0x5e29(){const _0x541b51=['error','length','orderId','parse','application/json','3DS\x20verification\x20required','webhookLog','log','Payment\x20status\x20is\x20','sendShopWebhook','defineProperty','Payment\x20failed','failed','__esModule','resolve','PENDING','sendPaymentStatusNotification','\x20\x20\x20Return\x20URL:\x20','createdAt','../config/database','ms)','1111','\x20not\x20enabled\x20for\x20shop\x20','32793300MheKkN','3476485kosHBS','MasterCard\x20webhook\x20sent\x20to\x20','PaymentController','createPublicPayment','Failed\x20to\x20send\x20MasterCard\x20webhook:',',\x20cannot\x20process','FAILED','system','getOwnPropertyNames','Payment\x20not\x20found','getOwnPropertyDescriptor','status','prototype','payment','webhookEvents','mastercard','PAID','processCardPayment','sendPaymentNotification','get','default','gateway_payment_id','4GUrZeT','writable','threeds_url','currency','gateway','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','\x20processed:\x20','4121862pTHLrh','Payment\x20processed\x20successfully','20QuejKD','__createBinding','isArray','../services/paymentService','requires_3ds','5599888MprXBV','call','body','../services/gateways/mastercardService','Card\x20payment\x20failed','json','settings','416EzFtgS','__importStar','paymentMethod','then','71460fULVCc','update','ðŸ’³\x20MasterCard\x20URLs:','includes','customerName','amount','Webhook\x20event\x20','ðŸ’³\x20MasterCard\x20result:','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','WebhookService','final','webhookUrl','toLowerCase','params','processMasterCardPayment','successUrl','masterCardService','416199zpsPnh','paymentService','now','create','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','stringify','159957TvaWFu','shop','gatewayOrderId','âœ…\x20MasterCard\x20payment\x20','payment.failed','hasOwnProperty'];a8_0x5e29=function(){return _0x541b51;};return a8_0x5e29();}class PaymentController{constructor(){const _0x1a61b6=a8_0x48dbc7;this[_0x1a61b6(0xb2)]=async(_0x4a6fca,_0x5cd97e,_0x4749e6)=>{const _0x33ccb8=_0x1a61b6;try{const _0x2ccf9c=_0x4a6fca['body'],_0x2b2371=await this[_0x33ccb8(0xf0)][_0x33ccb8(0xb2)](_0x2ccf9c);_0x5cd97e[_0x33ccb8(0xba)](0xc9)['json']({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x2b2371});}catch(_0x1d26d6){_0x4749e6(_0x1d26d6);}},this['getPaymentStatus']=async(_0x1bf033,_0x368ff1,_0x44c4c0)=>{const _0x145c56=_0x1a61b6;try{const {id:_0x4cead6}=_0x1bf033[_0x145c56(0xeb)],_0x321f10=await this[_0x145c56(0xf0)]['getPaymentStatus'](_0x4cead6);if(!_0x321f10)return _0x368ff1['status'](0x194)[_0x145c56(0xd8)]({'success':![],'message':_0x145c56(0xb8)});_0x368ff1['json']({'success':!![],'result':_0x321f10});}catch(_0x145ffb){_0x44c4c0(_0x145ffb);}},this['getPaymentById']=async(_0x1b02b1,_0x216d97,_0x49e9)=>{const _0x3efcae=_0x1a61b6;try{const {id:_0x4f6b95}=_0x1b02b1[_0x3efcae(0xeb)],_0x2cb16c=await this[_0x3efcae(0xf0)]['getPaymentById'](_0x4f6b95);if(!_0x2cb16c)return _0x216d97[_0x3efcae(0xba)](0x194)[_0x3efcae(0xd8)]({'success':![],'message':_0x3efcae(0xb8)});_0x216d97[_0x3efcae(0xd8)]({'success':!![],'result':_0x2cb16c});}catch(_0x114ea6){_0x49e9(_0x114ea6);}},this[_0x1a61b6(0xec)]=async(_0xb67c01,_0x2f8546,_0x11304e)=>{const _0x42e738=_0x1a61b6;try{const {id:_0x1066e1}=_0xb67c01[_0x42e738(0xeb)],{cardData:_0x3f5552,cardHolder:_0x44a23c,browser:_0x187551}=_0xb67c01[_0x42e738(0xd5)];console['log']('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x1066e1);const _0x139d19=await database_1[_0x42e738(0xc3)][_0x42e738(0xbc)]['findUnique']({'where':{'id':_0x1066e1},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x139d19)return _0x2f8546[_0x42e738(0xba)](0x194)['json']({'success':![],'message':_0x42e738(0xb8)});if(_0x139d19[_0x42e738(0xc9)]!=='mastercard')return _0x2f8546[_0x42e738(0xba)](0x190)[_0x42e738(0xd8)]({'success':![],'message':_0x42e738(0xe6)});if(_0x139d19[_0x42e738(0xba)]!==_0x42e738(0xa6))return _0x2f8546['status'](0x190)[_0x42e738(0xd8)]({'success':![],'message':_0x42e738(0x9f)+_0x139d19[_0x42e738(0xba)]+_0x42e738(0xb4)});const _0x499e05='https://apitest.trapay.uk/api/webhooks/gateway/mastercard',_0x1ed4d6=_0x139d19[_0x42e738(0xed)];console[_0x42e738(0x9e)](_0x42e738(0xe0)),console['log'](_0x42e738(0xf3)+_0x499e05),console[_0x42e738(0x9e)](_0x42e738(0xa8)+_0x1ed4d6);const _0x81a444=await this[_0x42e738(0xee)][_0x42e738(0xc0)]({'paymentId':_0x139d19['id'],'orderId':_0x139d19[_0x42e738(0x93)]||_0x139d19['id'],'amount':_0x139d19['amount'],'currency':_0x139d19[_0x42e738(0xc8)],'cardData':_0x3f5552,'resultUrl':_0x499e05,'returnUrl':_0x1ed4d6,'cardHolder':_0x44a23c,'browser':_0x187551});console[_0x42e738(0x9e)](_0x42e738(0xe5),_0x81a444);const _0x276ca8={'status':_0x81a444[_0x42e738(0xba)],'updatedAt':new Date(),'statusChangedBy':_0x42e738(0xb6),'statusChangedAt':new Date()};if(_0x81a444[_0x42e738(0xba)]==='PAID')_0x276ca8['paidAt']=new Date(),_0x276ca8['gatewayPaymentId']=_0x81a444[_0x42e738(0xc4)];else _0x81a444[_0x42e738(0xba)]==='FAILED'&&(_0x276ca8['failureMessage']=_0x42e738(0xd7));_0x276ca8[_0x42e738(0xdc)]=_0x42e738(0xbe),await database_1[_0x42e738(0xc3)][_0x42e738(0xbc)][_0x42e738(0xdf)]({'where':{'id':_0x139d19['id']},'data':_0x276ca8}),await database_1['default'][_0x42e738(0x9d)][_0x42e738(0xf2)]({'data':{'paymentId':_0x139d19['id'],'shopId':_0x139d19['shopId'],'event':'mastercard_'+_0x81a444['status']?.[_0x42e738(0xea)](),'statusCode':0xc8,'responseBody':JSON[_0x42e738(0xf5)]({'oldStatus':_0x42e738(0xa6),'newStatus':_0x81a444[_0x42e738(0xba)],'gatewayPaymentId':_0x81a444['gateway_payment_id'],'requires3ds':_0x81a444[_0x42e738(0xd2)],'processedAt':new Date()['toISOString']()})}});_0x81a444[_0x42e738(0xe8)]&&(await this['sendShopWebhook'](_0x139d19,_0x81a444[_0x42e738(0xba)],_0x81a444[_0x42e738(0xc4)]),await this[_0x42e738(0xa7)](_0x139d19,_0x81a444[_0x42e738(0xba)]));console[_0x42e738(0x9e)](_0x42e738(0x94)+_0x1066e1+_0x42e738(0xcb)+_0x81a444['status']);if(_0x81a444[_0x42e738(0xba)]==='PAID')_0x2f8546[_0x42e738(0xd8)]({'success':!![],'message':_0x42e738(0xcd),'result':{'status':'PAID','gatewayPaymentId':_0x81a444[_0x42e738(0xc4)],'redirectUrl':_0x1ed4d6,'final':!![]}});else _0x81a444['requires_3ds']&&_0x81a444[_0x42e738(0xc7)]?_0x2f8546[_0x42e738(0xd8)]({'success':!![],'message':_0x42e738(0x9c),'result':{'status':_0x42e738(0xa6),'gatewayPaymentId':_0x81a444[_0x42e738(0xc4)],'redirectUrl':_0x81a444[_0x42e738(0xc7)],'requires3ds':!![],'final':![]}}):_0x2f8546[_0x42e738(0xba)](0x190)['json']({'success':![],'message':_0x42e738(0xa2),'result':{'status':_0x42e738(0xb5),'gatewayPaymentId':_0x81a444[_0x42e738(0xc4)],'redirectUrl':_0x139d19['failUrl'],'final':!![]}});}catch(_0x4c3111){_0x11304e(_0x4c3111);}},this[_0x1a61b6(0xf0)]=new paymentService_1['PaymentService'](),this['masterCardService']=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0x1a61b6(0xe7))]();}async[a8_0x48dbc7(0xa0)](_0x26e424,_0x463c04,_0x3592b2){const _0x1f0f3a=a8_0x48dbc7,_0x37108c=Date[_0x1f0f3a(0xf1)]();try{const _0x3af040=_0x26e424[_0x1f0f3a(0x92)],_0x51655b=_0x3af040[_0x1f0f3a(0xd9)];if(!_0x51655b?.[_0x1f0f3a(0xe9)]){console[_0x1f0f3a(0x9e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3af040['id']);return;}const _0x10f457=_0x463c04===_0x1f0f3a(0xbf)?'payment.success':_0x1f0f3a(0x95);let _0xefbb3a=[];if(_0x51655b[_0x1f0f3a(0xbd)])try{_0xefbb3a=Array[_0x1f0f3a(0xd0)](_0x51655b[_0x1f0f3a(0xbd)])?_0x51655b[_0x1f0f3a(0xbd)]:JSON[_0x1f0f3a(0x9a)](_0x51655b[_0x1f0f3a(0xbd)]);}catch(_0x2d706b){console[_0x1f0f3a(0x97)]('Error\x20parsing\x20webhook\x20events:',_0x2d706b),_0xefbb3a=[];}if(!_0xefbb3a[_0x1f0f3a(0xe1)](_0x10f457)){console['log'](_0x1f0f3a(0xe4)+_0x10f457+_0x1f0f3a(0xad)+_0x3af040['id']);return;}const _0x1892e3={'event':_0x10f457,'payment':{'id':_0x26e424['id'],'order_id':_0x26e424[_0x1f0f3a(0x99)],'gateway_order_id':_0x26e424[_0x1f0f3a(0x93)],'gateway':_0x1f0f3a(0xac),'amount':_0x26e424[_0x1f0f3a(0xe3)],'currency':_0x26e424[_0x1f0f3a(0xc8)],'status':_0x463c04['toLowerCase'](),'customer_email':_0x26e424['customerEmail'],'customer_name':_0x26e424[_0x1f0f3a(0xe2)],'gateway_payment_id':_0x3592b2,'created_at':_0x26e424[_0x1f0f3a(0xa9)],'updated_at':new Date()}},_0xfdbf5=await fetch(_0x51655b['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1f0f3a(0x9b),'User-Agent':_0x1f0f3a(0xca)},'body':JSON[_0x1f0f3a(0xf5)](_0x1892e3)}),_0x117e1f=Date[_0x1f0f3a(0xf1)]()-_0x37108c;console['log'](_0x1f0f3a(0xb0)+_0x51655b[_0x1f0f3a(0xe9)]+'\x20with\x20status\x20'+_0xfdbf5[_0x1f0f3a(0xba)]+'\x20('+_0x117e1f+_0x1f0f3a(0xab));}catch(_0x32cb19){console[_0x1f0f3a(0x97)](_0x1f0f3a(0xb3),_0x32cb19);}}async[a8_0x48dbc7(0xa7)](_0x2b3a11,_0x5bee33){const _0x19f521=a8_0x48dbc7;try{const {telegramBotService:_0x79fa62}=await Promise[_0x19f521(0xa5)]()[_0x19f521(0xdd)](()=>__importStar(require('../services/telegramBotService'))),_0x50f984={'PAID':'paid','FAILED':_0x19f521(0xa3)},_0x2c2457=_0x50f984[_0x5bee33];if(!_0x2c2457)return;await _0x79fa62[_0x19f521(0xc1)](_0x2b3a11['shopId'],_0x2b3a11,_0x2c2457);}catch(_0x156c3b){console[_0x19f521(0x97)](_0x19f521(0xf4),_0x156c3b);}}}exports[a8_0x48dbc7(0xb1)]=PaymentController;