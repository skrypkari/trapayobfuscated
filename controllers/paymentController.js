'use strict';const a8_0x3a7248=a8_0x4102;(function(_0x488050,_0x1342f3){const _0x14d469=a8_0x4102,_0x2b73e9=_0x488050();while(!![]){try{const _0xfd1cd4=parseInt(_0x14d469(0x11f))/0x1+-parseInt(_0x14d469(0x10f))/0x2+-parseInt(_0x14d469(0x109))/0x3*(-parseInt(_0x14d469(0x122))/0x4)+-parseInt(_0x14d469(0x116))/0x5*(parseInt(_0x14d469(0xcb))/0x6)+-parseInt(_0x14d469(0xc7))/0x7+parseInt(_0x14d469(0xbc))/0x8*(parseInt(_0x14d469(0x104))/0x9)+parseInt(_0x14d469(0xb8))/0xa*(-parseInt(_0x14d469(0x118))/0xb);if(_0xfd1cd4===_0x1342f3)break;else _0x2b73e9['push'](_0x2b73e9['shift']());}catch(_0xea95fd){_0x2b73e9['push'](_0x2b73e9['shift']());}}}(a8_0x4477,0xadfca));var __createBinding=this&&this['__createBinding']||(Object[a8_0x3a7248(0x11d)]?function(_0x2e109a,_0x502d06,_0x45fdce,_0x3a9942){const _0x47e511=a8_0x3a7248;if(_0x3a9942===undefined)_0x3a9942=_0x45fdce;var _0x81e9fd=Object[_0x47e511(0xf3)](_0x502d06,_0x45fdce);(!_0x81e9fd||(_0x47e511(0xfb)in _0x81e9fd?!_0x502d06['__esModule']:_0x81e9fd[_0x47e511(0xe6)]||_0x81e9fd[_0x47e511(0xc1)]))&&(_0x81e9fd={'enumerable':!![],'get':function(){return _0x502d06[_0x45fdce];}}),Object[_0x47e511(0x113)](_0x2e109a,_0x3a9942,_0x81e9fd);}:function(_0x20d454,_0x20006b,_0x121eeb,_0x543968){if(_0x543968===undefined)_0x543968=_0x121eeb;_0x20d454[_0x543968]=_0x20006b[_0x121eeb];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x3a7248(0x11d)]?function(_0x4d8db0,_0xfeaf25){const _0xb4b019=a8_0x3a7248;Object[_0xb4b019(0x113)](_0x4d8db0,_0xb4b019(0x124),{'enumerable':!![],'value':_0xfeaf25});}:function(_0x4a79cf,_0x3eba4e){_0x4a79cf['default']=_0x3eba4e;}),__importStar=this&&this['__importStar']||(function(){var _0x21340c=function(_0x5b41bc){const _0xdc77c3=a8_0x4102;return _0x21340c=Object[_0xdc77c3(0xdf)]||function(_0x465a7e){const _0x26732d=_0xdc77c3;var _0x180305=[];for(var _0x3e398b in _0x465a7e)if(Object[_0x26732d(0xd4)][_0x26732d(0xe0)][_0x26732d(0xb9)](_0x465a7e,_0x3e398b))_0x180305[_0x180305['length']]=_0x3e398b;return _0x180305;},_0x21340c(_0x5b41bc);};return function(_0x15da11){const _0x9026be=a8_0x4102;if(_0x15da11&&_0x15da11['__esModule'])return _0x15da11;var _0x4780c5={};if(_0x15da11!=null){for(var _0x4dd6fa=_0x21340c(_0x15da11),_0x3eb70f=0x0;_0x3eb70f<_0x4dd6fa[_0x9026be(0xe8)];_0x3eb70f++)if(_0x4dd6fa[_0x3eb70f]!=='default')__createBinding(_0x4780c5,_0x15da11,_0x4dd6fa[_0x3eb70f]);}return __setModuleDefault(_0x4780c5,_0x15da11),_0x4780c5;};}()),__importDefault=this&&this[a8_0x3a7248(0x10d)]||function(_0x15ff59){return _0x15ff59&&_0x15ff59['__esModule']?_0x15ff59:{'default':_0x15ff59};};function a8_0x4102(_0x3074f8,_0x4c71ba){const _0x44771c=a8_0x4477();return a8_0x4102=function(_0x41020b,_0x1db4ef){_0x41020b=_0x41020b-0xa3;let _0x55f316=_0x44771c[_0x41020b];return _0x55f316;},a8_0x4102(_0x3074f8,_0x4c71ba);}Object[a8_0x3a7248(0x113)](exports,a8_0x3a7248(0xae),{'value':!![]}),exports[a8_0x3a7248(0xfe)]=void 0x0;const paymentService_1=require(a8_0x3a7248(0xd9)),mastercardService_1=require(a8_0x3a7248(0x100)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x3a7248(0xd2)));function a8_0x4477(){const _0xd73dd6=['hasOwnProperty','📈\x20MasterCard\x20payment\x20','MasterCard\x20webhook\x20sent\x20to\x20','masterCardService','final','error','writable','webhookLog','length','cardLast4','failed','first_name','Webhook\x20event\x20','settings','paymentMethod','threeds_url','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','💳\x20Browser\x20IP:\x20','updatedAt','getOwnPropertyDescriptor','failUrl','ms)','✅\x20MasterCard\x20payment\x20','replace','webhookUrl','Failed\x20to\x20send\x20MasterCard\x20webhook:','mastercard','get','💳\x20Card\x20holder:\x20','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','PaymentController','gateway','../services/gateways/mastercardService','\x20not\x20enabled\x20for\x20shop\x20','FAILED','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','9TvYfpu','💳\x20Processing\x20MasterCard\x20payment:\x20','paid','shop','stringify','17907SDLamJ','customerIp','toISOString','updatePaymentCustomerDataPublic','__importDefault','then','542776OBovbN','customerCountry','Payment\x20status\x20is\x20','webhookEvents','defineProperty','POST','toLowerCase','55dwfMRb','Payment\x20failed','33jRbuOV','mastercard_','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','3DS\x20verification\x20required','gatewayOrderId','create','currency','1113867JHRPVl','resolve','sendPaymentNotification','172RNCqCz','\x20with\x20status\x20','default','user_agent','PAID','now','PENDING','includes','gatewayPaymentId','system','last_name','params','body','failureMessage','__esModule','../services/telegramBotService','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Error\x20parsing\x20webhook\x20events:','WebhookService','PaymentService','requires_3ds','paymentService','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','json','2377040zqCmAJ','call','sendPaymentStatusNotification','email','10867416XcAFjI','💳\x20MasterCard\x20result:','MasterCardService','Customer\x20data\x20updated\x20successfully','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','configurable','parse','customerEmail',',\x20cannot\x20process','Payment\x20created\x20successfully','getPaymentStatus','89012SRTxnO','amount','isArray','https://api.trapay.uk/api/webhooks/gateway/mastercard','555870IFxfsy','number','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','log','getPaymentById','payment.success','\x20processed:\x20','../config/database','status','prototype','Payment\x20not\x20found','Payment\x20processed\x20successfully','customerName','sendShopWebhook','../services/paymentService','../services/paymentLinkService','createPublicPayment','updatePaymentCustomer','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','gateway_payment_id','getOwnPropertyNames'];a8_0x4477=function(){return _0xd73dd6;};return a8_0x4477();}class PaymentController{constructor(){const _0x174738=a8_0x3a7248;this[_0x174738(0xdb)]=async(_0x2774fc,_0x220037,_0x4933fa)=>{const _0x30258d=_0x174738;try{const _0x461602=_0x2774fc[_0x30258d(0xac)],_0x11f9ab=await this['paymentService'][_0x30258d(0xdb)](_0x461602);_0x220037['status'](0xc9)[_0x30258d(0xb7)]({'success':!![],'message':_0x30258d(0xc5),'result':_0x11f9ab});}catch(_0x2c5456){_0x4933fa(_0x2c5456);}},this[_0x174738(0xc6)]=async(_0x1b7507,_0x2dbd5c,_0x272e2f)=>{const _0x43e7da=_0x174738;try{const {id:_0x4dd95a}=_0x1b7507[_0x43e7da(0xab)],_0x11ed1e=await this[_0x43e7da(0xb5)][_0x43e7da(0xc6)](_0x4dd95a);if(!_0x11ed1e)return _0x2dbd5c[_0x43e7da(0xd3)](0x194)[_0x43e7da(0xb7)]({'success':![],'message':_0x43e7da(0xd5)});_0x2dbd5c[_0x43e7da(0xb7)]({'success':!![],'result':_0x11ed1e});}catch(_0x5e4c93){_0x272e2f(_0x5e4c93);}},this[_0x174738(0xcf)]=async(_0x44ba86,_0x9fb656,_0x3f9891)=>{const _0x3a85b6=_0x174738;try{const {id:_0x4190be}=_0x44ba86['params'],_0x4d9d81=await this[_0x3a85b6(0xb5)][_0x3a85b6(0xcf)](_0x4190be);if(!_0x4d9d81)return _0x9fb656['status'](0x194)['json']({'success':![],'message':_0x3a85b6(0xd5)});_0x9fb656[_0x3a85b6(0xb7)]({'success':!![],'result':_0x4d9d81});}catch(_0x1d13e2){_0x3f9891(_0x1d13e2);}},this[_0x174738(0xdc)]=async(_0xeecf0,_0x527cd6,_0x1e85ac)=>{const _0x1b0f50=_0x174738;try{const {id:_0x1d5354}=_0xeecf0[_0x1b0f50(0xab)],_0x805083=_0xeecf0[_0x1b0f50(0xac)];console['log'](_0x1b0f50(0xcd)+_0x1d5354),console['log']('📝\x20Customer\x20data:',_0x805083);const _0x21c78c=await this[_0x1b0f50(0xb5)][_0x1b0f50(0x10c)](_0x1d5354,_0x805083);if(!_0x21c78c)return _0x527cd6['status'](0x194)['json']({'success':![],'message':_0x1b0f50(0xd5)});_0x527cd6[_0x1b0f50(0xb7)]({'success':!![],'message':_0x1b0f50(0xbf),'result':{'paymentId':_0x21c78c['id'],'customerIp':_0x21c78c[_0x1b0f50(0x10a)],'customerUa':_0x21c78c['customerUa'],'customerCountry':_0x21c78c[_0x1b0f50(0x110)],'updatedAt':_0x21c78c[_0x1b0f50(0xf2)]}});}catch(_0x570633){_0x1e85ac(_0x570633);}},this['processMasterCardPayment']=async(_0x3a6419,_0x3d4f51,_0x4e483e)=>{const _0x23ea66=_0x174738;try{const {id:_0x4e012e}=_0x3a6419[_0x23ea66(0xab)],{cardData:_0x42e474,cardHolder:_0xf72733,browser:_0xc1b10c}=_0x3a6419[_0x23ea66(0xac)];console[_0x23ea66(0xce)](_0x23ea66(0x105)+_0x4e012e),console['log'](_0x23ea66(0xfc)+_0xf72733['first_name']+'\x20'+_0xf72733[_0x23ea66(0xaa)]+'\x20('+_0xf72733['email']+')'),console[_0x23ea66(0xce)](_0x23ea66(0xf1)+_0xc1b10c['ip']);const _0x1b1de2={'customerName':_0xf72733['first_name']+'\x20'+_0xf72733[_0x23ea66(0xaa)],'customerEmail':_0xf72733[_0x23ea66(0xbb)],'customerIp':_0xc1b10c['ip'],'customerUa':_0xc1b10c[_0x23ea66(0xa3)]},_0x5e699a=await database_1[_0x23ea66(0x124)]['payment']['findUnique']({'where':{'id':_0x4e012e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5e699a)return _0x3d4f51[_0x23ea66(0xd3)](0x194)[_0x23ea66(0xb7)]({'success':![],'message':_0x23ea66(0xd5)});if(_0x5e699a[_0x23ea66(0xff)]!==_0x23ea66(0xfa))return _0x3d4f51[_0x23ea66(0xd3)](0x190)[_0x23ea66(0xb7)]({'success':![],'message':_0x23ea66(0xdd)});if(_0x5e699a[_0x23ea66(0xd3)]!==_0x23ea66(0xa6))return _0x3d4f51[_0x23ea66(0xd3)](0x190)['json']({'success':![],'message':_0x23ea66(0x111)+_0x5e699a[_0x23ea66(0xd3)]+_0x23ea66(0xc4)});await database_1['default']['payment']['update']({'where':{'id':_0x4e012e},'data':{..._0x1b1de2,'updatedAt':new Date()}});const _0x99f6b9=_0x23ea66(0xca),_0x193f30=_0x5e699a['successUrl'];console[_0x23ea66(0xce)]('💳\x20MasterCard\x20URLs:'),console['log'](_0x23ea66(0xb0)+_0x99f6b9),console[_0x23ea66(0xce)]('\x20\x20\x20Return\x20URL:\x20'+_0x193f30);const _0x26836d={'first_name':_0xf72733[_0x23ea66(0xeb)],'last_name':_0xf72733[_0x23ea66(0xaa)],'email':_0xf72733[_0x23ea66(0xbb)]},_0x5427e2=await this['masterCardService']['processCardPayment']({'paymentId':_0x5e699a['id'],'orderId':_0x5e699a[_0x23ea66(0x11c)]||_0x5e699a['id'],'amount':_0x5e699a['amount'],'currency':_0x5e699a[_0x23ea66(0x11e)],'cardData':_0x42e474,'resultUrl':_0x99f6b9,'returnUrl':_0x193f30,'cardHolder':_0x26836d,'browser':_0xc1b10c});console['log'](_0x23ea66(0xbd),_0x5427e2);const _0x4c7491={'status':_0x5427e2[_0x23ea66(0xd3)],'updatedAt':new Date(),'statusChangedBy':_0x23ea66(0xa9),'statusChangedAt':new Date()};_0x5427e2[_0x23ea66(0xde)]&&(_0x4c7491[_0x23ea66(0xa8)]=_0x5427e2[_0x23ea66(0xde)],console['log'](_0x23ea66(0x11a)+_0x5427e2[_0x23ea66(0xde)]));if(_0x5427e2['status']===_0x23ea66(0xa4))_0x4c7491['paidAt']=new Date();else _0x5427e2[_0x23ea66(0xd3)]===_0x23ea66(0x102)&&(_0x4c7491[_0x23ea66(0xad)]='Card\x20payment\x20failed');_0x4c7491[_0x23ea66(0xee)]=_0x23ea66(0xfa);if(_0x42e474['number']){const _0x18b410=_0x42e474[_0x23ea66(0xcc)][_0x23ea66(0xf7)](/[\s-]/g,'');_0x4c7491[_0x23ea66(0xe9)]=_0x18b410['slice'](-0x4),console['log'](_0x23ea66(0xfd)+_0x4c7491[_0x23ea66(0xe9)]);}await database_1[_0x23ea66(0x124)]['payment']['update']({'where':{'id':_0x5e699a['id']},'data':_0x4c7491}),await database_1['default'][_0x23ea66(0xe7)][_0x23ea66(0x11d)]({'data':{'paymentId':_0x5e699a['id'],'shopId':_0x5e699a['shopId'],'event':_0x23ea66(0x119)+_0x5427e2[_0x23ea66(0xd3)]?.[_0x23ea66(0x115)](),'statusCode':0xc8,'responseBody':JSON[_0x23ea66(0x108)]({'oldStatus':_0x23ea66(0xa6),'newStatus':_0x5427e2[_0x23ea66(0xd3)],'gatewayPaymentId':_0x5427e2[_0x23ea66(0xde)],'requires3ds':_0x5427e2[_0x23ea66(0xb4)],'processedAt':new Date()[_0x23ea66(0x10b)]()})}});if(_0x5427e2[_0x23ea66(0xe4)]){await this[_0x23ea66(0xd8)](_0x5e699a,_0x5427e2[_0x23ea66(0xd3)],_0x5427e2[_0x23ea66(0xde)]),await this['sendPaymentStatusNotification'](_0x5e699a,_0x5427e2[_0x23ea66(0xd3)]);if(_0x5427e2[_0x23ea66(0xd3)]==='PAID'){console[_0x23ea66(0xce)](_0x23ea66(0xe1)+_0x4e012e+_0x23ea66(0xc0));try{const {PaymentLinkService:_0xd99a53}=await Promise[_0x23ea66(0x120)]()[_0x23ea66(0x10e)](()=>__importStar(require(_0x23ea66(0xda)))),_0x2cb5e8=new _0xd99a53();await _0x2cb5e8['handleSuccessfulPayment'](_0x4e012e),console[_0x23ea66(0xce)](_0x23ea66(0xb6)+_0x4e012e);}catch(_0x16e154){console['error'](_0x23ea66(0xf0),_0x16e154);}}}console[_0x23ea66(0xce)](_0x23ea66(0xf6)+_0x4e012e+_0x23ea66(0xd1)+_0x5427e2[_0x23ea66(0xd3)]);if(_0x5427e2['status']===_0x23ea66(0xa4))_0x3d4f51[_0x23ea66(0xb7)]({'success':!![],'message':_0x23ea66(0xd6),'result':{'status':_0x23ea66(0xa4),'gatewayPaymentId':_0x5427e2[_0x23ea66(0xde)],'redirectUrl':_0x193f30,'final':!![]}});else _0x5427e2['requires_3ds']&&_0x5427e2[_0x23ea66(0xef)]?_0x3d4f51[_0x23ea66(0xb7)]({'success':!![],'message':_0x23ea66(0x11b),'result':{'status':'PENDING','gatewayPaymentId':_0x5427e2['gateway_payment_id'],'redirectUrl':_0x5427e2['threeds_url'],'requires3ds':!![],'final':![]}}):_0x3d4f51['status'](0x190)[_0x23ea66(0xb7)]({'success':![],'message':_0x23ea66(0x117),'result':{'status':_0x23ea66(0x102),'gatewayPaymentId':_0x5427e2[_0x23ea66(0xde)],'redirectUrl':_0x5e699a[_0x23ea66(0xf4)],'final':!![]}});}catch(_0x3d3201){_0x4e483e(_0x3d3201);}},this[_0x174738(0xb5)]=new paymentService_1[(_0x174738(0xb3))](),this[_0x174738(0xe3)]=new mastercardService_1[(_0x174738(0xbe))](),this['webhookService']=new webhookService_1[(_0x174738(0xb2))]();}async[a8_0x3a7248(0xd8)](_0x1269ea,_0x5a1521,_0x15e4b3){const _0x452357=a8_0x3a7248,_0xd06db4=Date[_0x452357(0xa5)]();try{const _0x5065b7=_0x1269ea[_0x452357(0x107)],_0x221b86=_0x5065b7[_0x452357(0xed)];if(!_0x221b86?.[_0x452357(0xf8)]){console[_0x452357(0xce)](_0x452357(0x103)+_0x5065b7['id']);return;}const _0x1bfbc1=_0x5a1521===_0x452357(0xa4)?_0x452357(0xd0):'payment.failed';let _0x8b3237=[];if(_0x221b86[_0x452357(0x112)])try{_0x8b3237=Array[_0x452357(0xc9)](_0x221b86['webhookEvents'])?_0x221b86['webhookEvents']:JSON[_0x452357(0xc2)](_0x221b86[_0x452357(0x112)]);}catch(_0x54a55c){console[_0x452357(0xe5)](_0x452357(0xb1),_0x54a55c),_0x8b3237=[];}if(!_0x8b3237[_0x452357(0xa7)](_0x1bfbc1)){console[_0x452357(0xce)](_0x452357(0xec)+_0x1bfbc1+_0x452357(0x101)+_0x5065b7['id']);return;}const _0x3cd418={'event':_0x1bfbc1,'payment':{'id':_0x1269ea['id'],'order_id':_0x1269ea['orderId'],'gateway_order_id':_0x1269ea[_0x452357(0x11c)],'gateway':'1111','amount':_0x1269ea[_0x452357(0xc8)],'currency':_0x1269ea[_0x452357(0x11e)],'status':_0x5a1521[_0x452357(0x115)](),'customer_email':_0x1269ea[_0x452357(0xc3)],'customer_name':_0x1269ea[_0x452357(0xd7)],'gateway_payment_id':_0x15e4b3,'created_at':_0x1269ea['createdAt'],'updated_at':new Date()}},_0x8c0ad3=await fetch(_0x221b86[_0x452357(0xf8)],{'method':_0x452357(0x114),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x3cd418)}),_0x34827e=Date[_0x452357(0xa5)]()-_0xd06db4;console['log'](_0x452357(0xe2)+_0x221b86[_0x452357(0xf8)]+_0x452357(0x123)+_0x8c0ad3[_0x452357(0xd3)]+'\x20('+_0x34827e+_0x452357(0xf5));}catch(_0x3d6af2){console['error'](_0x452357(0xf9),_0x3d6af2);}}async[a8_0x3a7248(0xba)](_0xffcfbb,_0x478d91){const _0x46f9b5=a8_0x3a7248;try{const {telegramBotService:_0x398580}=await Promise[_0x46f9b5(0x120)]()['then'](()=>__importStar(require(_0x46f9b5(0xaf)))),_0x1e1f19={'PAID':_0x46f9b5(0x106),'FAILED':_0x46f9b5(0xea)},_0x5bbbe9=_0x1e1f19[_0x478d91];if(!_0x5bbbe9)return;await _0x398580[_0x46f9b5(0x121)](_0xffcfbb['shopId'],_0xffcfbb,_0x5bbbe9);}catch(_0x5dbc29){console[_0x46f9b5(0xe5)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5dbc29);}}}exports[a8_0x3a7248(0xfe)]=PaymentController;