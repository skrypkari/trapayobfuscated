'use strict';const a8_0x11cacd=a8_0x563a;(function(_0x47433f,_0x1d6f39){const _0x4855d2=a8_0x563a,_0x558a67=_0x47433f();while(!![]){try{const _0x48038f=parseInt(_0x4855d2(0xed))/0x1*(parseInt(_0x4855d2(0x141))/0x2)+-parseInt(_0x4855d2(0x13b))/0x3+-parseInt(_0x4855d2(0x12f))/0x4+-parseInt(_0x4855d2(0x124))/0x5+parseInt(_0x4855d2(0x121))/0x6+-parseInt(_0x4855d2(0xee))/0x7*(-parseInt(_0x4855d2(0x126))/0x8)+-parseInt(_0x4855d2(0x139))/0x9*(-parseInt(_0x4855d2(0x12c))/0xa);if(_0x48038f===_0x1d6f39)break;else _0x558a67['push'](_0x558a67['shift']());}catch(_0x4613ae){_0x558a67['push'](_0x558a67['shift']());}}}(a8_0xeba8,0x598c0));function a8_0xeba8(){const _0x5e865b=['hasOwnProperty','Error\x20parsing\x20webhook\x20events:','webhookUrl','Payment\x20processed\x20successfully','json','get','customerEmail','payment.failed','successUrl','PaymentService','failUrl','PaymentController','Payment\x20created\x20successfully','ðŸ’³\x20MasterCard\x20result:','prototype','length','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','mastercard_','paymentMethod','Failed\x20to\x20send\x20MasterCard\x20webhook:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','resolve','\x20not\x20enabled\x20for\x20shop\x20','create','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','PAID','../config/database','getPaymentById','error','body','payment','now','Payment\x20not\x20found','paid','gatewayOrderId','findUnique','gateway_payment_id','getOwnPropertyNames','paymentService','isArray','Card\x20payment\x20failed','\x20\x20\x20Return\x20URL:\x20','failed','processCardPayment','createdAt','gateway','ms)','log','Payment\x20status\x20is\x20','326520ymKeZt','status','MasterCard\x20webhook\x20sent\x20to\x20','286275ICNLIt','3DS\x20verification\x20required','344vUXlUu','1111','default','processMasterCardPayment','PENDING','application/json','13250IYegnM','stringify','\x20\x20\x20Result\x20URL\x20(webhook):\x20','1268600yUWjII','webhookLog','toLowerCase','orderId','then','shopId',',\x20cannot\x20process','__createBinding','masterCardService','params','2979dVDRtB','sendPaymentStatusNotification','1048152OMPQNG','MasterCardService','mastercard','shop','__esModule','failureMessage','6PkcMid','getOwnPropertyDescriptor','âœ…\x20MasterCard\x20payment\x20','gatewayPaymentId','getPaymentStatus','includes','sendShopWebhook','webhookEvents','customerName','\x20with\x20status\x20','defineProperty','Webhook\x20event\x20','toISOString','Payment\x20failed','writable','final','currency','../services/telegramBotService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','threeds_url','requires_3ds','../services/paymentService','sendPaymentNotification','184587natKjU','7133HUlQSV','call'];a8_0xeba8=function(){return _0x5e865b;};return a8_0xeba8();}function a8_0x563a(_0xd5f92c,_0x5592b2){const _0xeba81=a8_0xeba8();return a8_0x563a=function(_0x563ab6,_0x6c1cdb){_0x563ab6=_0x563ab6-0xe9;let _0xba7236=_0xeba81[_0x563ab6];return _0xba7236;},a8_0x563a(_0xd5f92c,_0x5592b2);}var __createBinding=this&&this[a8_0x11cacd(0x136)]||(Object[a8_0x11cacd(0x107)]?function(_0x27d608,_0x4291c0,_0x3125da,_0x270b85){const _0x59bc2f=a8_0x11cacd;if(_0x270b85===undefined)_0x270b85=_0x3125da;var _0x1a05c6=Object[_0x59bc2f(0x142)](_0x4291c0,_0x3125da);(!_0x1a05c6||(_0x59bc2f(0xf5)in _0x1a05c6?!_0x4291c0[_0x59bc2f(0x13f)]:_0x1a05c6[_0x59bc2f(0x14f)]||_0x1a05c6['configurable']))&&(_0x1a05c6={'enumerable':!![],'get':function(){return _0x4291c0[_0x3125da];}}),Object['defineProperty'](_0x27d608,_0x270b85,_0x1a05c6);}:function(_0x5d7b77,_0x3f5e33,_0x4176fb,_0x2bbe0c){if(_0x2bbe0c===undefined)_0x2bbe0c=_0x4176fb;_0x5d7b77[_0x2bbe0c]=_0x3f5e33[_0x4176fb];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5282f1,_0x22b141){const _0x581024=a8_0x11cacd;Object[_0x581024(0x14b)](_0x5282f1,_0x581024(0x128),{'enumerable':!![],'value':_0x22b141});}:function(_0x4792b5,_0x544001){const _0x1e2126=a8_0x11cacd;_0x4792b5[_0x1e2126(0x128)]=_0x544001;}),__importStar=this&&this['__importStar']||(function(){var _0x3decf9=function(_0x136689){const _0x585e6c=a8_0x563a;return _0x3decf9=Object[_0x585e6c(0x115)]||function(_0x123523){const _0x4ed493=_0x585e6c;var _0xef08c0=[];for(var _0x1b2bdf in _0x123523)if(Object[_0x4ed493(0xfe)][_0x4ed493(0xf0)][_0x4ed493(0xef)](_0x123523,_0x1b2bdf))_0xef08c0[_0xef08c0[_0x4ed493(0xff)]]=_0x1b2bdf;return _0xef08c0;},_0x3decf9(_0x136689);};return function(_0x721b1b){const _0x31f409=a8_0x563a;if(_0x721b1b&&_0x721b1b[_0x31f409(0x13f)])return _0x721b1b;var _0x2e2332={};if(_0x721b1b!=null){for(var _0x34b0b9=_0x3decf9(_0x721b1b),_0x2a7596=0x0;_0x2a7596<_0x34b0b9[_0x31f409(0xff)];_0x2a7596++)if(_0x34b0b9[_0x2a7596]!==_0x31f409(0x128))__createBinding(_0x2e2332,_0x721b1b,_0x34b0b9[_0x2a7596]);}return __setModuleDefault(_0x2e2332,_0x721b1b),_0x2e2332;};}()),__importDefault=this&&this['__importDefault']||function(_0x4c612d){const _0x559693=a8_0x11cacd;return _0x4c612d&&_0x4c612d[_0x559693(0x13f)]?_0x4c612d:{'default':_0x4c612d};};Object[a8_0x11cacd(0x14b)](exports,a8_0x11cacd(0x13f),{'value':!![]}),exports[a8_0x11cacd(0xfb)]=void 0x0;const paymentService_1=require(a8_0x11cacd(0xeb)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x11cacd(0x10a)));class PaymentController{constructor(){const _0x5d6b63=a8_0x11cacd;this['createPublicPayment']=async(_0x88f99,_0x593d86,_0x1259ed)=>{const _0x3847e1=a8_0x563a;try{const _0x26bf1a=_0x88f99[_0x3847e1(0x10d)],_0x1e1fcc=await this[_0x3847e1(0x116)]['createPublicPayment'](_0x26bf1a);_0x593d86['status'](0xc9)[_0x3847e1(0xf4)]({'success':!![],'message':_0x3847e1(0xfc),'result':_0x1e1fcc});}catch(_0x1610b6){_0x1259ed(_0x1610b6);}},this[_0x5d6b63(0x145)]=async(_0x2d7901,_0x4ca7af,_0x47ce04)=>{const _0x2b1bb3=_0x5d6b63;try{const {id:_0x5d2066}=_0x2d7901[_0x2b1bb3(0x138)],_0x497b9e=await this[_0x2b1bb3(0x116)]['getPaymentStatus'](_0x5d2066);if(!_0x497b9e)return _0x4ca7af[_0x2b1bb3(0x122)](0x194)[_0x2b1bb3(0xf4)]({'success':![],'message':_0x2b1bb3(0x110)});_0x4ca7af[_0x2b1bb3(0xf4)]({'success':!![],'result':_0x497b9e});}catch(_0x338116){_0x47ce04(_0x338116);}},this[_0x5d6b63(0x10b)]=async(_0x2b1a44,_0x2ca6dc,_0x59ee3f)=>{const _0x2f7faa=_0x5d6b63;try{const {id:_0x6c009a}=_0x2b1a44[_0x2f7faa(0x138)],_0x6f5dd3=await this[_0x2f7faa(0x116)][_0x2f7faa(0x10b)](_0x6c009a);if(!_0x6f5dd3)return _0x2ca6dc[_0x2f7faa(0x122)](0x194)[_0x2f7faa(0xf4)]({'success':![],'message':'Payment\x20not\x20found'});_0x2ca6dc[_0x2f7faa(0xf4)]({'success':!![],'result':_0x6f5dd3});}catch(_0x175515){_0x59ee3f(_0x175515);}},this[_0x5d6b63(0x129)]=async(_0x129884,_0x1e4797,_0xaf225f)=>{const _0x3912c9=_0x5d6b63;try{const {id:_0x22e0a8}=_0x129884[_0x3912c9(0x138)],{cardData:_0x729f72,cardHolder:_0xfd82ef,browser:_0x2ac825}=_0x129884['body'];console[_0x3912c9(0x11f)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x22e0a8);const _0x3dec29=await database_1[_0x3912c9(0x128)][_0x3912c9(0x10e)][_0x3912c9(0x113)]({'where':{'id':_0x22e0a8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3dec29)return _0x1e4797[_0x3912c9(0x122)](0x194)[_0x3912c9(0xf4)]({'success':![],'message':_0x3912c9(0x110)});if(_0x3dec29[_0x3912c9(0x11d)]!==_0x3912c9(0x13d))return _0x1e4797[_0x3912c9(0x122)](0x190)['json']({'success':![],'message':_0x3912c9(0x153)});if(_0x3dec29[_0x3912c9(0x122)]!==_0x3912c9(0x12a))return _0x1e4797[_0x3912c9(0x122)](0x190)[_0x3912c9(0xf4)]({'success':![],'message':_0x3912c9(0x120)+_0x3dec29[_0x3912c9(0x122)]+_0x3912c9(0x135)});const _0x4fc7a8=_0x3912c9(0x108),_0x4c97de=_0x3dec29[_0x3912c9(0xf8)];console[_0x3912c9(0x11f)]('ðŸ’³\x20MasterCard\x20URLs:'),console[_0x3912c9(0x11f)](_0x3912c9(0x12e)+_0x4fc7a8),console[_0x3912c9(0x11f)](_0x3912c9(0x119)+_0x4c97de);const _0x169909=await this['masterCardService'][_0x3912c9(0x11b)]({'paymentId':_0x3dec29['id'],'orderId':_0x3dec29['gatewayOrderId']||_0x3dec29['id'],'amount':_0x3dec29['amount'],'currency':_0x3dec29[_0x3912c9(0x151)],'cardData':_0x729f72,'resultUrl':_0x4fc7a8,'returnUrl':_0x4c97de,'cardHolder':_0xfd82ef,'browser':_0x2ac825});console['log'](_0x3912c9(0xfd),_0x169909);const _0x53f461={'status':_0x169909['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x169909[_0x3912c9(0x122)]===_0x3912c9(0x109))_0x53f461['paidAt']=new Date(),_0x53f461[_0x3912c9(0x144)]=_0x169909[_0x3912c9(0x114)];else _0x169909[_0x3912c9(0x122)]==='FAILED'&&(_0x53f461[_0x3912c9(0x140)]=_0x3912c9(0x118));_0x53f461[_0x3912c9(0x102)]=_0x3912c9(0x13d),await database_1[_0x3912c9(0x128)][_0x3912c9(0x10e)]['update']({'where':{'id':_0x3dec29['id']},'data':_0x53f461}),await database_1[_0x3912c9(0x128)][_0x3912c9(0x130)]['create']({'data':{'paymentId':_0x3dec29['id'],'shopId':_0x3dec29[_0x3912c9(0x134)],'event':_0x3912c9(0x101)+_0x169909[_0x3912c9(0x122)]?.[_0x3912c9(0x131)](),'statusCode':0xc8,'responseBody':JSON[_0x3912c9(0x12d)]({'oldStatus':'PENDING','newStatus':_0x169909['status'],'gatewayPaymentId':_0x169909[_0x3912c9(0x114)],'requires3ds':_0x169909[_0x3912c9(0xea)],'processedAt':new Date()[_0x3912c9(0x14d)]()})}});_0x169909[_0x3912c9(0x150)]&&(await this[_0x3912c9(0x147)](_0x3dec29,_0x169909[_0x3912c9(0x122)],_0x169909[_0x3912c9(0x114)]),await this[_0x3912c9(0x13a)](_0x3dec29,_0x169909['status']));console[_0x3912c9(0x11f)](_0x3912c9(0x143)+_0x22e0a8+'\x20processed:\x20'+_0x169909[_0x3912c9(0x122)]);if(_0x169909['status']==='PAID')_0x1e4797['json']({'success':!![],'message':_0x3912c9(0xf3),'result':{'status':'PAID','gatewayPaymentId':_0x169909['gateway_payment_id'],'redirectUrl':_0x4c97de,'final':!![]}});else _0x169909[_0x3912c9(0xea)]&&_0x169909[_0x3912c9(0xe9)]?_0x1e4797[_0x3912c9(0xf4)]({'success':!![],'message':_0x3912c9(0x125),'result':{'status':_0x3912c9(0x12a),'gatewayPaymentId':_0x169909[_0x3912c9(0x114)],'redirectUrl':_0x169909[_0x3912c9(0xe9)],'requires3ds':!![],'final':![]}}):_0x1e4797[_0x3912c9(0x122)](0x190)[_0x3912c9(0xf4)]({'success':![],'message':_0x3912c9(0x14e),'result':{'status':'FAILED','gatewayPaymentId':_0x169909[_0x3912c9(0x114)],'redirectUrl':_0x3dec29[_0x3912c9(0xfa)],'final':!![]}});}catch(_0x164a3e){_0xaf225f(_0x164a3e);}},this[_0x5d6b63(0x116)]=new paymentService_1[(_0x5d6b63(0xf9))](),this[_0x5d6b63(0x137)]=new mastercardService_1[(_0x5d6b63(0x13c))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x11cacd(0x147)](_0xd2b2b6,_0x428c71,_0x5aa11c){const _0x32888f=a8_0x11cacd,_0x1d7cb5=Date[_0x32888f(0x10f)]();try{const _0x19d33b=_0xd2b2b6[_0x32888f(0x13e)],_0x1319fc=_0x19d33b['settings'];if(!_0x1319fc?.['webhookUrl']){console['log'](_0x32888f(0x104)+_0x19d33b['id']);return;}const _0x1781be=_0x428c71===_0x32888f(0x109)?'payment.success':_0x32888f(0xf7);let _0x3b5902=[];if(_0x1319fc['webhookEvents'])try{_0x3b5902=Array[_0x32888f(0x117)](_0x1319fc[_0x32888f(0x148)])?_0x1319fc[_0x32888f(0x148)]:JSON['parse'](_0x1319fc['webhookEvents']);}catch(_0x5f3ad5){console[_0x32888f(0x10c)](_0x32888f(0xf1),_0x5f3ad5),_0x3b5902=[];}if(!_0x3b5902[_0x32888f(0x146)](_0x1781be)){console[_0x32888f(0x11f)](_0x32888f(0x14c)+_0x1781be+_0x32888f(0x106)+_0x19d33b['id']);return;}const _0x283c72={'event':_0x1781be,'payment':{'id':_0xd2b2b6['id'],'order_id':_0xd2b2b6[_0x32888f(0x132)],'gateway_order_id':_0xd2b2b6[_0x32888f(0x112)],'gateway':_0x32888f(0x127),'amount':_0xd2b2b6['amount'],'currency':_0xd2b2b6[_0x32888f(0x151)],'status':_0x428c71['toLowerCase'](),'customer_email':_0xd2b2b6[_0x32888f(0xf6)],'customer_name':_0xd2b2b6[_0x32888f(0x149)],'gateway_payment_id':_0x5aa11c,'created_at':_0xd2b2b6[_0x32888f(0x11c)],'updated_at':new Date()}},_0x32fab8=await fetch(_0x1319fc[_0x32888f(0xf2)],{'method':'POST','headers':{'Content-Type':_0x32888f(0x12b),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x32888f(0x12d)](_0x283c72)}),_0x1170d3=Date[_0x32888f(0x10f)]()-_0x1d7cb5;console[_0x32888f(0x11f)](_0x32888f(0x123)+_0x1319fc[_0x32888f(0xf2)]+_0x32888f(0x14a)+_0x32fab8[_0x32888f(0x122)]+'\x20('+_0x1170d3+_0x32888f(0x11e));}catch(_0x346331){console[_0x32888f(0x10c)](_0x32888f(0x103),_0x346331);}}async[a8_0x11cacd(0x13a)](_0x3412ee,_0x15003c){const _0x3a3e47=a8_0x11cacd;try{const {telegramBotService:_0x5baf6a}=await Promise[_0x3a3e47(0x105)]()[_0x3a3e47(0x133)](()=>__importStar(require(_0x3a3e47(0x152)))),_0x1e0c15={'PAID':_0x3a3e47(0x111),'FAILED':_0x3a3e47(0x11a)},_0x13e24c=_0x1e0c15[_0x15003c];if(!_0x13e24c)return;await _0x5baf6a[_0x3a3e47(0xec)](_0x3412ee[_0x3a3e47(0x134)],_0x3412ee,_0x13e24c);}catch(_0x330ae5){console[_0x3a3e47(0x10c)](_0x3a3e47(0x100),_0x330ae5);}}}exports[a8_0x11cacd(0xfb)]=PaymentController;