'use strict';const a8_0x35fcb6=a8_0x2479;(function(_0x195589,_0x36a805){const _0x5e71b5=a8_0x2479,_0x10a276=_0x195589();while(!![]){try{const _0x8c82e6=-parseInt(_0x5e71b5(0x146))/0x1+parseInt(_0x5e71b5(0x18a))/0x2*(parseInt(_0x5e71b5(0x172))/0x3)+parseInt(_0x5e71b5(0x1bf))/0x4*(-parseInt(_0x5e71b5(0x19a))/0x5)+parseInt(_0x5e71b5(0x149))/0x6*(parseInt(_0x5e71b5(0x177))/0x7)+parseInt(_0x5e71b5(0x174))/0x8*(parseInt(_0x5e71b5(0x158))/0x9)+parseInt(_0x5e71b5(0x1bd))/0xa+parseInt(_0x5e71b5(0x14f))/0xb;if(_0x8c82e6===_0x36a805)break;else _0x10a276['push'](_0x10a276['shift']());}catch(_0x2287ec){_0x10a276['push'](_0x10a276['shift']());}}}(a8_0x19f0,0x5a04a));function a8_0x19f0(){const _0x3e38a8=['createdAt','489666DWAiPl','shopId','üìà\x20MasterCard\x20payment\x20','78zDqhJn','isArray','PaymentService','../services/paymentService','webhookLog','gateway','59884meQSrC','getOwnPropertyDescriptor','Failed\x20to\x20send\x20MasterCard\x20webhook:','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','system','MasterCardService','\x20\x20\x20Return\x20URL:\x20','error','paymentService','73611LMuYLF','get','includes','getPaymentById','\x20processed:\x20','üí≥\x20Browser\x20IP:\x20','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','__esModule','orderId','gateway_payment_id','defineProperty','sendPaymentStatusNotification','customerName','currency','PaymentController','last_name','https://api.trapay.uk/api/webhooks/gateway/mastercard','üí≥\x20Card\x20holder:\x20','stringify','../services/gateways/mastercardService','Webhook\x20event\x20','payment','FAILED','customerCountry','now','replace','14622DLTuZt','paymentMethod','712OwRHnw','log','parse','165319mxYbIL','PAID','getPaymentStatus','paid','slice','PENDING','threeds_url','../services/telegramBotService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','updatePaymentCustomerDataPublic','Card\x20payment\x20failed','../services/paymentLinkService','json','üìù\x20Customer\x20data:','handleSuccessfulPayment','üí≥\x20Processing\x20MasterCard\x20payment:\x20','processMasterCardPayment','1111','MasterCard\x20webhook\x20sent\x20to\x20','10epRjWZ','Payment\x20processed\x20successfully','\x20with\x20status\x20','toLowerCase','body','__createBinding','webhookEvents','customerEmail','Error\x20parsing\x20webhook\x20events:','email','default','application/json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerUa','payment.failed','gatewayPaymentId','1612900rLacKs','getOwnPropertyNames','country','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','ms)','then','mastercard','webhookUrl','requires_3ds','POST','number','customerIp','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','hasOwnProperty','final','failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','mastercard_','updatedAt','cardLast4','createPublicPayment','settings','Payment\x20failed','__setModuleDefault','\x20not\x20enabled\x20for\x20shop\x20','resolve','writable','Payment\x20not\x20found','length','create','masterCardService',',\x20cannot\x20process','sendShopWebhook','prototype','WebhookService','1161940aYexQh','params','4zokUdl','Payment\x20created\x20successfully','__importDefault','status','updatePaymentCustomer','toISOString','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','first_name','webhookService'];a8_0x19f0=function(){return _0x3e38a8;};return a8_0x19f0();}var __createBinding=this&&this[a8_0x35fcb6(0x18f)]||(Object[a8_0x35fcb6(0x1b7)]?function(_0x1d71b8,_0x553d62,_0xa8dafa,_0x32ccfe){const _0x58bf6a=a8_0x35fcb6;if(_0x32ccfe===undefined)_0x32ccfe=_0xa8dafa;var _0x2f3ccb=Object[_0x58bf6a(0x150)](_0x553d62,_0xa8dafa);(!_0x2f3ccb||(_0x58bf6a(0x159)in _0x2f3ccb?!_0x553d62['__esModule']:_0x2f3ccb[_0x58bf6a(0x1b4)]||_0x2f3ccb['configurable']))&&(_0x2f3ccb={'enumerable':!![],'get':function(){return _0x553d62[_0xa8dafa];}}),Object[_0x58bf6a(0x162)](_0x1d71b8,_0x32ccfe,_0x2f3ccb);}:function(_0x5eebd5,_0x42cac3,_0x197342,_0x1784b7){if(_0x1784b7===undefined)_0x1784b7=_0x197342;_0x5eebd5[_0x1784b7]=_0x42cac3[_0x197342];}),__setModuleDefault=this&&this[a8_0x35fcb6(0x1b1)]||(Object[a8_0x35fcb6(0x1b7)]?function(_0x550672,_0x438b8b){const _0x15abc1=a8_0x35fcb6;Object['defineProperty'](_0x550672,_0x15abc1(0x194),{'enumerable':!![],'value':_0x438b8b});}:function(_0x317eba,_0x431280){const _0x5017e7=a8_0x35fcb6;_0x317eba[_0x5017e7(0x194)]=_0x431280;}),__importStar=this&&this['__importStar']||(function(){var _0x1a1bba=function(_0x1303f6){const _0x28adb4=a8_0x2479;return _0x1a1bba=Object[_0x28adb4(0x19b)]||function(_0x58e5ed){const _0x5440e3=_0x28adb4;var _0x364843=[];for(var _0x438d63 in _0x58e5ed)if(Object[_0x5440e3(0x1bb)][_0x5440e3(0x1a7)]['call'](_0x58e5ed,_0x438d63))_0x364843[_0x364843['length']]=_0x438d63;return _0x364843;},_0x1a1bba(_0x1303f6);};return function(_0x6d6250){const _0x4f3c32=a8_0x2479;if(_0x6d6250&&_0x6d6250['__esModule'])return _0x6d6250;var _0x495873={};if(_0x6d6250!=null){for(var _0x28933d=_0x1a1bba(_0x6d6250),_0x5a54dd=0x0;_0x5a54dd<_0x28933d[_0x4f3c32(0x1b6)];_0x5a54dd++)if(_0x28933d[_0x5a54dd]!==_0x4f3c32(0x194))__createBinding(_0x495873,_0x6d6250,_0x28933d[_0x5a54dd]);}return __setModuleDefault(_0x495873,_0x6d6250),_0x495873;};}()),__importDefault=this&&this[a8_0x35fcb6(0x1c1)]||function(_0x3592b0){const _0x17d00a=a8_0x35fcb6;return _0x3592b0&&_0x3592b0[_0x17d00a(0x15f)]?_0x3592b0:{'default':_0x3592b0};};function a8_0x2479(_0x43ff46,_0x3a8631){const _0x19f097=a8_0x19f0();return a8_0x2479=function(_0x24798c,_0x15e61e){_0x24798c=_0x24798c-0x140;let _0xa3f1dc=_0x19f097[_0x24798c];return _0xa3f1dc;},a8_0x2479(_0x43ff46,_0x3a8631);}Object['defineProperty'](exports,a8_0x35fcb6(0x15f),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x35fcb6(0x14c)),mastercardService_1=require(a8_0x35fcb6(0x16b)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x175ba4=a8_0x35fcb6;this[_0x175ba4(0x1ae)]=async(_0x13f159,_0x46b2fe,_0x4b5421)=>{const _0x4b22a3=_0x175ba4;try{const _0x5cc3ee=_0x13f159[_0x4b22a3(0x18e)],_0x2cbfe7=await this[_0x4b22a3(0x157)][_0x4b22a3(0x1ae)](_0x5cc3ee);_0x46b2fe[_0x4b22a3(0x1c2)](0xc9)['json']({'success':!![],'message':_0x4b22a3(0x1c0),'result':_0x2cbfe7});}catch(_0x3d56a2){_0x4b5421(_0x3d56a2);}},this[_0x175ba4(0x179)]=async(_0x57088c,_0x633d8b,_0x4ed774)=>{const _0x55c879=_0x175ba4;try{const {id:_0x5244a9}=_0x57088c[_0x55c879(0x1be)],_0x571729=await this[_0x55c879(0x157)]['getPaymentStatus'](_0x5244a9);if(!_0x571729)return _0x633d8b[_0x55c879(0x1c2)](0x194)[_0x55c879(0x183)]({'success':![],'message':'Payment\x20not\x20found'});_0x633d8b[_0x55c879(0x183)]({'success':!![],'result':_0x571729});}catch(_0x1f05b4){_0x4ed774(_0x1f05b4);}},this['getPaymentById']=async(_0x3bfc95,_0x278e64,_0x1c7980)=>{const _0x267405=_0x175ba4;try{const {id:_0x154141}=_0x3bfc95[_0x267405(0x1be)],_0xfe7dba=await this[_0x267405(0x157)][_0x267405(0x15b)](_0x154141);if(!_0xfe7dba)return _0x278e64['status'](0x194)[_0x267405(0x183)]({'success':![],'message':_0x267405(0x1b5)});_0x278e64[_0x267405(0x183)]({'success':!![],'result':_0xfe7dba});}catch(_0x2601e3){_0x1c7980(_0x2601e3);}},this[_0x175ba4(0x140)]=async(_0x5dfb4d,_0x48911d,_0x271ce5)=>{const _0x4c4ee1=_0x175ba4;try{const {id:_0x343696}=_0x5dfb4d[_0x4c4ee1(0x1be)],_0x327d25=_0x5dfb4d[_0x4c4ee1(0x18e)];console[_0x4c4ee1(0x175)](_0x4c4ee1(0x152)+_0x343696),console[_0x4c4ee1(0x175)](_0x4c4ee1(0x184),_0x327d25);const _0x5cb074=await this[_0x4c4ee1(0x157)][_0x4c4ee1(0x180)](_0x343696,_0x327d25);if(!_0x5cb074)return _0x48911d['status'](0x194)[_0x4c4ee1(0x183)]({'success':![],'message':_0x4c4ee1(0x1b5)});_0x48911d['json']({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x5cb074['id'],'customerIp':_0x5cb074[_0x4c4ee1(0x1a5)],'customerUa':_0x5cb074[_0x4c4ee1(0x197)],'customerCountry':_0x5cb074[_0x4c4ee1(0x16f)],'updatedAt':_0x5cb074[_0x4c4ee1(0x1ac)]}});}catch(_0x1550b0){_0x271ce5(_0x1550b0);}},this[_0x175ba4(0x187)]=async(_0x5c20b9,_0x2ec3b6,_0x43b48f)=>{const _0x56b067=_0x175ba4;try{const {id:_0x5ea51e}=_0x5c20b9['params'],{cardData:_0x5474e2,cardHolder:_0x35327d,browser:_0x1d112c}=_0x5c20b9[_0x56b067(0x18e)];console['log'](_0x56b067(0x186)+_0x5ea51e),console[_0x56b067(0x175)](_0x56b067(0x169)+_0x35327d[_0x56b067(0x143)]+'\x20'+_0x35327d[_0x56b067(0x167)]+'\x20('+_0x35327d[_0x56b067(0x193)]+')'),console['log'](_0x56b067(0x15d)+_0x1d112c['ip']);const _0x3f62c8={'customerName':_0x35327d['first_name']+'\x20'+_0x35327d[_0x56b067(0x167)],'customerEmail':_0x35327d[_0x56b067(0x193)],'customerIp':_0x1d112c['ip'],'customerUa':_0x1d112c['user_agent'],'customerCountry':_0x35327d[_0x56b067(0x19c)]||null},_0x2734aa=await database_1[_0x56b067(0x194)][_0x56b067(0x16d)]['findUnique']({'where':{'id':_0x5ea51e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2734aa)return _0x2ec3b6['status'](0x194)['json']({'success':![],'message':_0x56b067(0x1b5)});if(_0x2734aa[_0x56b067(0x14e)]!=='mastercard')return _0x2ec3b6[_0x56b067(0x1c2)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x2734aa[_0x56b067(0x1c2)]!==_0x56b067(0x17c))return _0x2ec3b6['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2734aa[_0x56b067(0x1c2)]+_0x56b067(0x1b9)});await database_1['default'][_0x56b067(0x16d)]['update']({'where':{'id':_0x5ea51e},'data':{..._0x3f62c8,'updatedAt':new Date()}});const _0x1f0b26=_0x56b067(0x168),_0x4c76c4=_0x2734aa['successUrl'];console['log']('üí≥\x20MasterCard\x20URLs:'),console[_0x56b067(0x175)](_0x56b067(0x1aa)+_0x1f0b26),console[_0x56b067(0x175)](_0x56b067(0x155)+_0x4c76c4);const _0x426c42={'first_name':_0x35327d['first_name'],'last_name':_0x35327d[_0x56b067(0x167)],'email':_0x35327d[_0x56b067(0x193)]},_0x131227=await this[_0x56b067(0x1b8)]['processCardPayment']({'paymentId':_0x2734aa['id'],'orderId':_0x2734aa['gatewayOrderId']||_0x2734aa['id'],'amount':_0x2734aa['amount'],'currency':_0x2734aa[_0x56b067(0x165)],'cardData':_0x5474e2,'resultUrl':_0x1f0b26,'returnUrl':_0x4c76c4,'cardHolder':_0x426c42,'browser':_0x1d112c});console[_0x56b067(0x175)]('üí≥\x20MasterCard\x20result:',_0x131227);const _0x1cd80c={'status':_0x131227[_0x56b067(0x1c2)],'updatedAt':new Date(),'statusChangedBy':_0x56b067(0x153),'statusChangedAt':new Date()};if(_0x131227[_0x56b067(0x1c2)]===_0x56b067(0x178))_0x1cd80c['paidAt']=new Date(),_0x1cd80c[_0x56b067(0x199)]=_0x131227[_0x56b067(0x161)];else _0x131227[_0x56b067(0x1c2)]===_0x56b067(0x16e)&&(_0x1cd80c['failureMessage']=_0x56b067(0x181));_0x1cd80c[_0x56b067(0x173)]=_0x56b067(0x1a0);if(_0x5474e2[_0x56b067(0x1a4)]){const _0xcef2cd=_0x5474e2[_0x56b067(0x1a4)][_0x56b067(0x171)](/[\s-]/g,'');_0x1cd80c['cardLast4']=_0xcef2cd[_0x56b067(0x17b)](-0x4),console['log'](_0x56b067(0x15e)+_0x1cd80c[_0x56b067(0x1ad)]);}await database_1[_0x56b067(0x194)]['payment']['update']({'where':{'id':_0x2734aa['id']},'data':_0x1cd80c}),await database_1['default'][_0x56b067(0x14d)]['create']({'data':{'paymentId':_0x2734aa['id'],'shopId':_0x2734aa[_0x56b067(0x147)],'event':_0x56b067(0x1ab)+_0x131227[_0x56b067(0x1c2)]?.[_0x56b067(0x18d)](),'statusCode':0xc8,'responseBody':JSON[_0x56b067(0x16a)]({'oldStatus':'PENDING','newStatus':_0x131227['status'],'gatewayPaymentId':_0x131227['gateway_payment_id'],'requires3ds':_0x131227[_0x56b067(0x1a2)],'processedAt':new Date()[_0x56b067(0x141)]()})}});if(_0x131227[_0x56b067(0x1a8)]){await this[_0x56b067(0x1ba)](_0x2734aa,_0x131227[_0x56b067(0x1c2)],_0x131227[_0x56b067(0x161)]),await this[_0x56b067(0x163)](_0x2734aa,_0x131227[_0x56b067(0x1c2)]);if(_0x131227[_0x56b067(0x1c2)]==='PAID'){console[_0x56b067(0x175)](_0x56b067(0x148)+_0x5ea51e+_0x56b067(0x142));try{const {PaymentLinkService:_0x310c02}=await Promise[_0x56b067(0x1b3)]()['then'](()=>__importStar(require(_0x56b067(0x182)))),_0x430ca8=new _0x310c02();await _0x430ca8[_0x56b067(0x185)](_0x5ea51e),console[_0x56b067(0x175)](_0x56b067(0x19d)+_0x5ea51e);}catch(_0x297659){console[_0x56b067(0x156)](_0x56b067(0x1a6),_0x297659);}}}console['log']('‚úÖ\x20MasterCard\x20payment\x20'+_0x5ea51e+_0x56b067(0x15c)+_0x131227[_0x56b067(0x1c2)]);if(_0x131227[_0x56b067(0x1c2)]===_0x56b067(0x178))_0x2ec3b6[_0x56b067(0x183)]({'success':!![],'message':_0x56b067(0x18b),'result':{'status':_0x56b067(0x178),'gatewayPaymentId':_0x131227[_0x56b067(0x161)],'redirectUrl':_0x4c76c4,'final':!![]}});else _0x131227[_0x56b067(0x1a2)]&&_0x131227[_0x56b067(0x17d)]?_0x2ec3b6['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x56b067(0x17c),'gatewayPaymentId':_0x131227[_0x56b067(0x161)],'redirectUrl':_0x131227[_0x56b067(0x17d)],'requires3ds':!![],'final':![]}}):_0x2ec3b6[_0x56b067(0x1c2)](0x190)[_0x56b067(0x183)]({'success':![],'message':_0x56b067(0x1b0),'result':{'status':_0x56b067(0x16e),'gatewayPaymentId':_0x131227[_0x56b067(0x161)],'redirectUrl':_0x2734aa['failUrl'],'final':!![]}});}catch(_0xf887e2){_0x43b48f(_0xf887e2);}},this[_0x175ba4(0x157)]=new paymentService_1[(_0x175ba4(0x14b))](),this[_0x175ba4(0x1b8)]=new mastercardService_1[(_0x175ba4(0x154))](),this[_0x175ba4(0x144)]=new webhookService_1[(_0x175ba4(0x1bc))]();}async[a8_0x35fcb6(0x1ba)](_0x336f6c,_0x11f118,_0x1d957d){const _0x434941=a8_0x35fcb6,_0x2edb0f=Date[_0x434941(0x170)]();try{const _0x2b088b=_0x336f6c['shop'],_0x24988f=_0x2b088b[_0x434941(0x1af)];if(!_0x24988f?.[_0x434941(0x1a1)]){console[_0x434941(0x175)](_0x434941(0x196)+_0x2b088b['id']);return;}const _0x541651=_0x11f118===_0x434941(0x178)?'payment.success':_0x434941(0x198);let _0x1f195f=[];if(_0x24988f['webhookEvents'])try{_0x1f195f=Array[_0x434941(0x14a)](_0x24988f[_0x434941(0x190)])?_0x24988f[_0x434941(0x190)]:JSON[_0x434941(0x176)](_0x24988f[_0x434941(0x190)]);}catch(_0x1f4311){console[_0x434941(0x156)](_0x434941(0x192),_0x1f4311),_0x1f195f=[];}if(!_0x1f195f[_0x434941(0x15a)](_0x541651)){console[_0x434941(0x175)](_0x434941(0x16c)+_0x541651+_0x434941(0x1b2)+_0x2b088b['id']);return;}const _0x13d1af={'event':_0x541651,'payment':{'id':_0x336f6c['id'],'order_id':_0x336f6c[_0x434941(0x160)],'gateway_order_id':_0x336f6c['gatewayOrderId'],'gateway':_0x434941(0x188),'amount':_0x336f6c['amount'],'currency':_0x336f6c[_0x434941(0x165)],'status':_0x11f118[_0x434941(0x18d)](),'customer_email':_0x336f6c[_0x434941(0x191)],'customer_name':_0x336f6c[_0x434941(0x164)],'gateway_payment_id':_0x1d957d,'created_at':_0x336f6c[_0x434941(0x145)],'updated_at':new Date()}},_0xf7c875=await fetch(_0x24988f['webhookUrl'],{'method':_0x434941(0x1a3),'headers':{'Content-Type':_0x434941(0x195),'User-Agent':_0x434941(0x17f)},'body':JSON[_0x434941(0x16a)](_0x13d1af)}),_0x5da0ed=Date[_0x434941(0x170)]()-_0x2edb0f;console['log'](_0x434941(0x189)+_0x24988f['webhookUrl']+_0x434941(0x18c)+_0xf7c875[_0x434941(0x1c2)]+'\x20('+_0x5da0ed+_0x434941(0x19e));}catch(_0x3e49c6){console[_0x434941(0x156)](_0x434941(0x151),_0x3e49c6);}}async[a8_0x35fcb6(0x163)](_0x433f95,_0x4eb379){const _0x3141e9=a8_0x35fcb6;try{const {telegramBotService:_0x40b58b}=await Promise['resolve']()[_0x3141e9(0x19f)](()=>__importStar(require(_0x3141e9(0x17e)))),_0x4ca1a1={'PAID':_0x3141e9(0x17a),'FAILED':_0x3141e9(0x1a9)},_0x1a4837=_0x4ca1a1[_0x4eb379];if(!_0x1a4837)return;await _0x40b58b['sendPaymentNotification'](_0x433f95[_0x3141e9(0x147)],_0x433f95,_0x1a4837);}catch(_0x197306){console[_0x3141e9(0x156)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x197306);}}}exports[a8_0x35fcb6(0x166)]=PaymentController;