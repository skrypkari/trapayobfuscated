'use strict';const a8_0x1ed580=a8_0x37fc;function a8_0x37fc(_0x5230b7,_0x3cfbe5){const _0x1b0fa3=a8_0x1b0f();return a8_0x37fc=function(_0x37fce8,_0xfc48b0){_0x37fce8=_0x37fce8-0xcf;let _0x3c4510=_0x1b0fa3[_0x37fce8];return _0x3c4510;},a8_0x37fc(_0x5230b7,_0x3cfbe5);}(function(_0x567b17,_0x212147){const _0x4597f2=a8_0x37fc,_0x4c693e=_0x567b17();while(!![]){try{const _0x12efc3=-parseInt(_0x4597f2(0xe5))/0x1+parseInt(_0x4597f2(0x12b))/0x2*(-parseInt(_0x4597f2(0xd6))/0x3)+parseInt(_0x4597f2(0x11e))/0x4+parseInt(_0x4597f2(0x14e))/0x5+-parseInt(_0x4597f2(0xe0))/0x6+parseInt(_0x4597f2(0x106))/0x7*(parseInt(_0x4597f2(0xfc))/0x8)+parseInt(_0x4597f2(0xec))/0x9*(parseInt(_0x4597f2(0xdb))/0xa);if(_0x12efc3===_0x212147)break;else _0x4c693e['push'](_0x4c693e['shift']());}catch(_0x2f4384){_0x4c693e['push'](_0x4c693e['shift']());}}}(a8_0x1b0f,0x32959));var __createBinding=this&&this[a8_0x1ed580(0x137)]||(Object[a8_0x1ed580(0xfe)]?function(_0x239dcc,_0x30e4e3,_0x112672,_0x288cba){const _0xa8bf15=a8_0x1ed580;if(_0x288cba===undefined)_0x288cba=_0x112672;var _0x3a7809=Object[_0xa8bf15(0xd1)](_0x30e4e3,_0x112672);(!_0x3a7809||(_0xa8bf15(0xe3)in _0x3a7809?!_0x30e4e3[_0xa8bf15(0xf3)]:_0x3a7809[_0xa8bf15(0x123)]||_0x3a7809['configurable']))&&(_0x3a7809={'enumerable':!![],'get':function(){return _0x30e4e3[_0x112672];}}),Object[_0xa8bf15(0x133)](_0x239dcc,_0x288cba,_0x3a7809);}:function(_0x57e8c4,_0x5449ea,_0x2a9f96,_0x2a89d1){if(_0x2a89d1===undefined)_0x2a89d1=_0x2a9f96;_0x57e8c4[_0x2a89d1]=_0x5449ea[_0x2a9f96];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x1ed580(0xfe)]?function(_0x110bcd,_0x2ffc6a){const _0x381e83=a8_0x1ed580;Object[_0x381e83(0x133)](_0x110bcd,_0x381e83(0x12e),{'enumerable':!![],'value':_0x2ffc6a});}:function(_0x2b4ec2,_0x3f2adf){_0x2b4ec2['default']=_0x3f2adf;}),__importStar=this&&this[a8_0x1ed580(0x119)]||(function(){var _0x4a79b7=function(_0x77ab53){const _0x267000=a8_0x37fc;return _0x4a79b7=Object[_0x267000(0x145)]||function(_0x334597){const _0x58ff53=_0x267000;var _0x4c29eb=[];for(var _0x22d61c in _0x334597)if(Object[_0x58ff53(0x103)][_0x58ff53(0x13c)][_0x58ff53(0x142)](_0x334597,_0x22d61c))_0x4c29eb[_0x4c29eb['length']]=_0x22d61c;return _0x4c29eb;},_0x4a79b7(_0x77ab53);};return function(_0x284d00){const _0x305517=a8_0x37fc;if(_0x284d00&&_0x284d00[_0x305517(0xf3)])return _0x284d00;var _0x33369f={};if(_0x284d00!=null){for(var _0x490e6b=_0x4a79b7(_0x284d00),_0x538ff7=0x0;_0x538ff7<_0x490e6b[_0x305517(0x11b)];_0x538ff7++)if(_0x490e6b[_0x538ff7]!==_0x305517(0x12e))__createBinding(_0x33369f,_0x284d00,_0x490e6b[_0x538ff7]);}return __setModuleDefault(_0x33369f,_0x284d00),_0x33369f;};}()),__importDefault=this&&this[a8_0x1ed580(0xdc)]||function(_0x576ca6){const _0x5868e5=a8_0x1ed580;return _0x576ca6&&_0x576ca6[_0x5868e5(0xf3)]?_0x576ca6:{'default':_0x576ca6};};Object[a8_0x1ed580(0x133)](exports,a8_0x1ed580(0xf3),{'value':!![]}),exports[a8_0x1ed580(0x140)]=void 0x0;const paymentService_1=require(a8_0x1ed580(0xe2)),mastercardService_1=require(a8_0x1ed580(0xff)),webhookService_1=require(a8_0x1ed580(0xee)),database_1=__importDefault(require(a8_0x1ed580(0xd4)));class PaymentController{constructor(){const _0x4da5d8=a8_0x1ed580;this[_0x4da5d8(0x116)]=async(_0x38d342,_0x341d8e,_0x29b842)=>{const _0x2661a9=_0x4da5d8;try{const _0xdc002e=_0x38d342[_0x2661a9(0xf0)],_0x2ff330=await this[_0x2661a9(0x148)][_0x2661a9(0x116)](_0xdc002e);_0x341d8e[_0x2661a9(0x109)](0xc9)[_0x2661a9(0xf6)]({'success':!![],'message':_0x2661a9(0x13f),'result':_0x2ff330});}catch(_0x2e43c7){_0x29b842(_0x2e43c7);}},this[_0x4da5d8(0x14d)]=async(_0x4642d7,_0x3e8a17,_0x51cfc3)=>{const _0x33ad84=_0x4da5d8;try{const {id:_0x2c387d}=_0x4642d7[_0x33ad84(0x118)],_0x297804=await this[_0x33ad84(0x148)]['getPaymentStatus'](_0x2c387d);if(!_0x297804)return _0x3e8a17['status'](0x194)[_0x33ad84(0xf6)]({'success':![],'message':'Payment\x20not\x20found'});_0x3e8a17[_0x33ad84(0xf6)]({'success':!![],'result':_0x297804});}catch(_0x2ed380){_0x51cfc3(_0x2ed380);}},this[_0x4da5d8(0x126)]=async(_0x8dbf2d,_0x2554fd,_0x80ef0c)=>{const _0x2351b2=_0x4da5d8;try{const {id:_0x5849}=_0x8dbf2d['params'],_0x1f63f4=await this[_0x2351b2(0x148)][_0x2351b2(0x126)](_0x5849);if(!_0x1f63f4)return _0x2554fd[_0x2351b2(0x109)](0x194)['json']({'success':![],'message':_0x2351b2(0xcf)});_0x2554fd[_0x2351b2(0xf6)]({'success':!![],'result':_0x1f63f4});}catch(_0x381542){_0x80ef0c(_0x381542);}},this[_0x4da5d8(0xd5)]=async(_0x10f513,_0x440193,_0x330cae)=>{const _0x638cde=_0x4da5d8;try{const {id:_0x3a9954}=_0x10f513[_0x638cde(0x118)],_0x1d802c=_0x10f513[_0x638cde(0xf0)];console[_0x638cde(0x104)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x3a9954),console['log']('📝\x20Customer\x20data:',_0x1d802c);const _0x4bd561=await this[_0x638cde(0x148)][_0x638cde(0x124)](_0x3a9954,_0x1d802c);if(!_0x4bd561)return _0x440193['status'](0x194)[_0x638cde(0xf6)]({'success':![],'message':_0x638cde(0xcf)});_0x440193['json']({'success':!![],'message':_0x638cde(0x10b),'result':{'paymentId':_0x4bd561['id'],'customerIp':_0x4bd561['customerIp'],'customerUa':_0x4bd561[_0x638cde(0x11c)],'customerCountry':_0x4bd561[_0x638cde(0xf7)],'updatedAt':_0x4bd561[_0x638cde(0x12d)]}});}catch(_0x16dc26){_0x330cae(_0x16dc26);}},this[_0x4da5d8(0x147)]=async(_0x5ad654,_0x5932ac,_0x416e27)=>{const _0x10b137=_0x4da5d8;try{const {id:_0x3ed1aa}=_0x5ad654[_0x10b137(0x118)],{cardData:_0x41c686,cardHolder:_0x28be0d,browser:_0x119c30}=_0x5ad654[_0x10b137(0xf0)];console[_0x10b137(0x104)](_0x10b137(0x111)+_0x3ed1aa),console[_0x10b137(0x104)](_0x10b137(0x112)+_0x28be0d[_0x10b137(0x127)]+'\x20'+_0x28be0d[_0x10b137(0xf5)]+'\x20('+_0x28be0d['email']+')'),console[_0x10b137(0x104)](_0x10b137(0xd0)+_0x119c30['ip']);const _0x35cf64={'customerName':_0x28be0d['first_name']+'\x20'+_0x28be0d[_0x10b137(0xf5)],'customerEmail':_0x28be0d[_0x10b137(0x141)],'customerIp':_0x119c30['ip'],'customerUa':_0x119c30[_0x10b137(0xfb)]},_0xef498c=await database_1[_0x10b137(0x12e)][_0x10b137(0x10c)][_0x10b137(0x139)]({'where':{'id':_0x3ed1aa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xef498c)return _0x5932ac[_0x10b137(0x109)](0x194)[_0x10b137(0xf6)]({'success':![],'message':_0x10b137(0xcf)});if(_0xef498c[_0x10b137(0x130)]!==_0x10b137(0xef))return _0x5932ac[_0x10b137(0x109)](0x190)['json']({'success':![],'message':_0x10b137(0x10a)});if(_0xef498c[_0x10b137(0x109)]!==_0x10b137(0xeb))return _0x5932ac[_0x10b137(0x109)](0x190)[_0x10b137(0xf6)]({'success':![],'message':_0x10b137(0x13a)+_0xef498c[_0x10b137(0x109)]+_0x10b137(0x13b)});await database_1[_0x10b137(0x12e)]['payment'][_0x10b137(0xf8)]({'where':{'id':_0x3ed1aa},'data':{..._0x35cf64,'updatedAt':new Date()}});const _0x6bfc85='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x3baec0=_0xef498c['successUrl'];console['log']('💳\x20MasterCard\x20URLs:'),console[_0x10b137(0x104)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x6bfc85),console[_0x10b137(0x104)](_0x10b137(0x146)+_0x3baec0);const _0x4e8d08={'first_name':_0x28be0d['first_name'],'last_name':_0x28be0d[_0x10b137(0xf5)],'email':_0x28be0d[_0x10b137(0x141)]},_0x54f8b5=await this['masterCardService']['processCardPayment']({'paymentId':_0xef498c['id'],'orderId':_0xef498c[_0x10b137(0x143)]||_0xef498c['id'],'amount':_0xef498c['amount'],'currency':_0xef498c[_0x10b137(0xf2)],'cardData':_0x41c686,'resultUrl':_0x6bfc85,'returnUrl':_0x3baec0,'cardHolder':_0x4e8d08,'browser':_0x119c30});console[_0x10b137(0x104)]('💳\x20MasterCard\x20result:',_0x54f8b5);const _0x4a3ca0={'status':_0x54f8b5[_0x10b137(0x109)],'updatedAt':new Date(),'statusChangedBy':_0x10b137(0x125),'statusChangedAt':new Date()};_0x54f8b5['gateway_payment_id']&&(_0x4a3ca0[_0x10b137(0x132)]=_0x54f8b5[_0x10b137(0x144)],console['log'](_0x10b137(0xe4)+_0x54f8b5[_0x10b137(0x144)]));if(_0x54f8b5[_0x10b137(0x109)]===_0x10b137(0xe7))_0x4a3ca0[_0x10b137(0x102)]=new Date();else _0x54f8b5['status']==='FAILED'&&(_0x4a3ca0['failureMessage']=_0x10b137(0x120));_0x4a3ca0[_0x10b137(0xde)]=_0x10b137(0xef);if(_0x41c686[_0x10b137(0xf1)]){const _0x422f0c=_0x41c686[_0x10b137(0xf1)]['replace'](/[\s-]/g,'');_0x4a3ca0[_0x10b137(0x115)]=_0x422f0c[_0x10b137(0xd7)](-0x4),console['log'](_0x10b137(0x107)+_0x4a3ca0[_0x10b137(0x115)]);}await database_1[_0x10b137(0x12e)][_0x10b137(0x10c)][_0x10b137(0xf8)]({'where':{'id':_0xef498c['id']},'data':_0x4a3ca0}),await database_1['default'][_0x10b137(0x11d)][_0x10b137(0xfe)]({'data':{'paymentId':_0xef498c['id'],'shopId':_0xef498c[_0x10b137(0x10d)],'event':_0x10b137(0x10e)+_0x54f8b5[_0x10b137(0x109)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x10b137(0x129)]({'oldStatus':_0x10b137(0xeb),'newStatus':_0x54f8b5[_0x10b137(0x109)],'gatewayPaymentId':_0x54f8b5[_0x10b137(0x144)],'requires3ds':_0x54f8b5[_0x10b137(0xe9)],'processedAt':new Date()['toISOString']()})}});if(_0x54f8b5[_0x10b137(0x117)]){await this[_0x10b137(0xdd)](_0xef498c,_0x54f8b5[_0x10b137(0x109)],_0x54f8b5['gateway_payment_id']),await this[_0x10b137(0x135)](_0xef498c,_0x54f8b5[_0x10b137(0x109)]);if(_0x54f8b5[_0x10b137(0x109)]===_0x10b137(0xe7)){console[_0x10b137(0x104)](_0x10b137(0xe1)+_0x3ed1aa+_0x10b137(0x131));try{const {PaymentLinkService:_0x591f14}=await Promise[_0x10b137(0x12c)]()[_0x10b137(0xfd)](()=>__importStar(require('../services/paymentLinkService'))),_0x52c8fa=new _0x591f14();await _0x52c8fa[_0x10b137(0x101)](_0x3ed1aa),console[_0x10b137(0x104)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x3ed1aa);}catch(_0x2bde28){console['error'](_0x10b137(0x11f),_0x2bde28);}}}console[_0x10b137(0x104)](_0x10b137(0xd9)+_0x3ed1aa+_0x10b137(0x12f)+_0x54f8b5[_0x10b137(0x109)]);if(_0x54f8b5[_0x10b137(0x109)]===_0x10b137(0xe7))_0x5932ac[_0x10b137(0xf6)]({'success':!![],'message':_0x10b137(0x10f),'result':{'status':_0x10b137(0xe7),'gatewayPaymentId':_0x54f8b5[_0x10b137(0x144)],'redirectUrl':_0x3baec0,'final':!![]}});else _0x54f8b5[_0x10b137(0xe9)]&&_0x54f8b5['threeds_url']?_0x5932ac[_0x10b137(0xf6)]({'success':!![],'message':_0x10b137(0x100),'result':{'status':_0x10b137(0xeb),'gatewayPaymentId':_0x54f8b5[_0x10b137(0x144)],'redirectUrl':_0x54f8b5['threeds_url'],'requires3ds':!![],'final':![]}}):_0x5932ac[_0x10b137(0x109)](0x190)[_0x10b137(0xf6)]({'success':![],'message':_0x10b137(0xed),'result':{'status':'FAILED','gatewayPaymentId':_0x54f8b5[_0x10b137(0x144)],'redirectUrl':_0xef498c['failUrl'],'final':!![]}});}catch(_0x37fa27){_0x416e27(_0x37fa27);}},this['paymentService']=new paymentService_1[(_0x4da5d8(0xf4))](),this[_0x4da5d8(0x122)]=new mastercardService_1['MasterCardService'](),this[_0x4da5d8(0x121)]=new webhookService_1[(_0x4da5d8(0x13d))]();}async['sendShopWebhook'](_0x3f14ba,_0x431d5b,_0x5c5aa8){const _0x3d49df=a8_0x1ed580,_0x13c306=Date['now']();try{const _0xe3fffa=_0x3f14ba[_0x3d49df(0x114)],_0x5921c7=_0xe3fffa['settings'];if(!_0x5921c7?.[_0x3d49df(0x138)]){console[_0x3d49df(0x104)](_0x3d49df(0x149)+_0xe3fffa['id']);return;}const _0x7be31f=_0x431d5b==='PAID'?_0x3d49df(0xf9):_0x3d49df(0xd8);let _0x4d9178=[];if(_0x5921c7[_0x3d49df(0xd2)])try{_0x4d9178=Array[_0x3d49df(0x134)](_0x5921c7['webhookEvents'])?_0x5921c7[_0x3d49df(0xd2)]:JSON[_0x3d49df(0x11a)](_0x5921c7[_0x3d49df(0xd2)]);}catch(_0x348568){console[_0x3d49df(0x12a)](_0x3d49df(0x14b),_0x348568),_0x4d9178=[];}if(!_0x4d9178['includes'](_0x7be31f)){console[_0x3d49df(0x104)]('Webhook\x20event\x20'+_0x7be31f+_0x3d49df(0x14c)+_0xe3fffa['id']);return;}const _0x16cc2b={'event':_0x7be31f,'payment':{'id':_0x3f14ba['id'],'order_id':_0x3f14ba[_0x3d49df(0x13e)],'gateway_order_id':_0x3f14ba[_0x3d49df(0x143)],'gateway':'1111','amount':_0x3f14ba[_0x3d49df(0xea)],'currency':_0x3f14ba[_0x3d49df(0xf2)],'status':_0x431d5b[_0x3d49df(0xe8)](),'customer_email':_0x3f14ba[_0x3d49df(0x110)],'customer_name':_0x3f14ba['customerName'],'gateway_payment_id':_0x5c5aa8,'created_at':_0x3f14ba[_0x3d49df(0xdf)],'updated_at':new Date()}},_0xbd0545=await fetch(_0x5921c7[_0x3d49df(0x138)],{'method':_0x3d49df(0x128),'headers':{'Content-Type':_0x3d49df(0xfa),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x16cc2b)}),_0xc62bab=Date[_0x3d49df(0x136)]()-_0x13c306;console['log'](_0x3d49df(0xd3)+_0x5921c7[_0x3d49df(0x138)]+_0x3d49df(0x14f)+_0xbd0545[_0x3d49df(0x109)]+'\x20('+_0xc62bab+_0x3d49df(0x113));}catch(_0x1a0e4b){console[_0x3d49df(0x12a)](_0x3d49df(0x108),_0x1a0e4b);}}async['sendPaymentStatusNotification'](_0x3c5efc,_0x5a2676){const _0x3a4c5a=a8_0x1ed580;try{const {telegramBotService:_0x1abf89}=await Promise[_0x3a4c5a(0x12c)]()[_0x3a4c5a(0xfd)](()=>__importStar(require(_0x3a4c5a(0x14a)))),_0x1ff5f9={'PAID':_0x3a4c5a(0xe6),'FAILED':_0x3a4c5a(0xda)},_0x53c7ae=_0x1ff5f9[_0x5a2676];if(!_0x53c7ae)return;await _0x1abf89['sendPaymentNotification'](_0x3c5efc['shopId'],_0x3c5efc,_0x53c7ae);}catch(_0xa64ff5){console[_0x3a4c5a(0x12a)](_0x3a4c5a(0x105),_0xa64ff5);}}}exports['PaymentController']=PaymentController;function a8_0x1b0f(){const _0x469f1b=['💳\x20Browser\x20IP:\x20','getOwnPropertyDescriptor','webhookEvents','MasterCard\x20webhook\x20sent\x20to\x20','../config/database','updatePaymentCustomer','3uMZsSF','slice','payment.failed','✅\x20MasterCard\x20payment\x20','failed','480880BvOPgf','__importDefault','sendShopWebhook','paymentMethod','createdAt','1350372KOTgJJ','📈\x20MasterCard\x20payment\x20','../services/paymentService','get','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','156700pepBak','paid','PAID','toLowerCase','requires_3ds','amount','PENDING','45pVBYLF','Payment\x20failed','../services/webhookService','mastercard','body','number','currency','__esModule','PaymentService','last_name','json','customerCountry','update','payment.success','application/json','user_agent','3272qxBYRP','then','create','../services/gateways/mastercardService','3DS\x20verification\x20required','handleSuccessfulPayment','paidAt','prototype','log','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','3794RlMydh','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','Failed\x20to\x20send\x20MasterCard\x20webhook:','status','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Customer\x20data\x20updated\x20successfully','payment','shopId','mastercard_','Payment\x20processed\x20successfully','customerEmail','💳\x20Processing\x20MasterCard\x20payment:\x20','💳\x20Card\x20holder:\x20','ms)','shop','cardLast4','createPublicPayment','final','params','__importStar','parse','length','customerUa','webhookLog','616496hbKpbY','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','Card\x20payment\x20failed','webhookService','masterCardService','writable','updatePaymentCustomerDataPublic','system','getPaymentById','first_name','POST','stringify','error','425994ytWOEO','resolve','updatedAt','default','\x20processed:\x20','gateway','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','gatewayPaymentId','defineProperty','isArray','sendPaymentStatusNotification','now','__createBinding','webhookUrl','findUnique','Payment\x20status\x20is\x20',',\x20cannot\x20process','hasOwnProperty','WebhookService','orderId','Payment\x20created\x20successfully','PaymentController','email','call','gatewayOrderId','gateway_payment_id','getOwnPropertyNames','\x20\x20\x20Return\x20URL:\x20','processMasterCardPayment','paymentService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/telegramBotService','Error\x20parsing\x20webhook\x20events:','\x20not\x20enabled\x20for\x20shop\x20','getPaymentStatus','928550PbjWNh','\x20with\x20status\x20','Payment\x20not\x20found'];a8_0x1b0f=function(){return _0x469f1b;};return a8_0x1b0f();}