'use strict';function a8_0x1846(_0x2058a1,_0x24d5ae){const _0x1af318=a8_0x1af3();return a8_0x1846=function(_0x184630,_0x6790ce){_0x184630=_0x184630-0xf3;let _0x25e935=_0x1af318[_0x184630];return _0x25e935;},a8_0x1846(_0x2058a1,_0x24d5ae);}const a8_0x317549=a8_0x1846;(function(_0x3a75ee,_0x4b614e){const _0x496d1d=a8_0x1846,_0x1c5bba=_0x3a75ee();while(!![]){try{const _0x4f4b8c=-parseInt(_0x496d1d(0xff))/0x1*(parseInt(_0x496d1d(0x123))/0x2)+-parseInt(_0x496d1d(0x148))/0x3+-parseInt(_0x496d1d(0x158))/0x4*(-parseInt(_0x496d1d(0x111))/0x5)+-parseInt(_0x496d1d(0x125))/0x6*(parseInt(_0x496d1d(0xf5))/0x7)+-parseInt(_0x496d1d(0x108))/0x8+parseInt(_0x496d1d(0x140))/0x9*(parseInt(_0x496d1d(0xf3))/0xa)+-parseInt(_0x496d1d(0xfc))/0xb*(-parseInt(_0x496d1d(0x11d))/0xc);if(_0x4f4b8c===_0x4b614e)break;else _0x1c5bba['push'](_0x1c5bba['shift']());}catch(_0x60a959){_0x1c5bba['push'](_0x1c5bba['shift']());}}}(a8_0x1af3,0x2d830));var __createBinding=this&&this[a8_0x317549(0x155)]||(Object['create']?function(_0x27af13,_0x229973,_0x157dce,_0x4d3621){const _0x2bc412=a8_0x317549;if(_0x4d3621===undefined)_0x4d3621=_0x157dce;var _0x444882=Object[_0x2bc412(0x129)](_0x229973,_0x157dce);(!_0x444882||(_0x2bc412(0x142)in _0x444882?!_0x229973[_0x2bc412(0xfb)]:_0x444882[_0x2bc412(0x105)]||_0x444882[_0x2bc412(0x10b)]))&&(_0x444882={'enumerable':!![],'get':function(){return _0x229973[_0x157dce];}}),Object[_0x2bc412(0xf6)](_0x27af13,_0x4d3621,_0x444882);}:function(_0x167b24,_0x4deafa,_0xfa05d0,_0x5ce3a1){if(_0x5ce3a1===undefined)_0x5ce3a1=_0xfa05d0;_0x167b24[_0x5ce3a1]=_0x4deafa[_0xfa05d0];}),__setModuleDefault=this&&this[a8_0x317549(0x11b)]||(Object['create']?function(_0x364a3e,_0x5a2483){const _0x4ee8c0=a8_0x317549;Object[_0x4ee8c0(0xf6)](_0x364a3e,_0x4ee8c0(0x131),{'enumerable':!![],'value':_0x5a2483});}:function(_0x3f2e51,_0x518cb3){const _0x5f1962=a8_0x317549;_0x3f2e51[_0x5f1962(0x131)]=_0x518cb3;}),__importStar=this&&this[a8_0x317549(0x126)]||(function(){var _0x2f861a=function(_0x30ced9){const _0x48b487=a8_0x1846;return _0x2f861a=Object[_0x48b487(0x134)]||function(_0x3705e5){const _0x276372=_0x48b487;var _0x782ea8=[];for(var _0x515310 in _0x3705e5)if(Object[_0x276372(0x13f)]['hasOwnProperty'][_0x276372(0x15c)](_0x3705e5,_0x515310))_0x782ea8[_0x782ea8['length']]=_0x515310;return _0x782ea8;},_0x2f861a(_0x30ced9);};return function(_0x4c91e7){const _0x1ababd=a8_0x1846;if(_0x4c91e7&&_0x4c91e7[_0x1ababd(0xfb)])return _0x4c91e7;var _0x5f06ca={};if(_0x4c91e7!=null){for(var _0x261553=_0x2f861a(_0x4c91e7),_0x547235=0x0;_0x547235<_0x261553[_0x1ababd(0x149)];_0x547235++)if(_0x261553[_0x547235]!==_0x1ababd(0x131))__createBinding(_0x5f06ca,_0x4c91e7,_0x261553[_0x547235]);}return __setModuleDefault(_0x5f06ca,_0x4c91e7),_0x5f06ca;};}()),__importDefault=this&&this[a8_0x317549(0x144)]||function(_0x135176){return _0x135176&&_0x135176['__esModule']?_0x135176:{'default':_0x135176};};Object['defineProperty'](exports,a8_0x317549(0xfb),{'value':!![]}),exports[a8_0x317549(0x137)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x317549(0x128)),webhookService_1=require(a8_0x317549(0x119)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x4420bb=a8_0x317549;this['createPublicPayment']=async(_0x4f4ce6,_0x5b51e7,_0x5235f3)=>{const _0x190a1d=a8_0x1846;try{const _0x57d721=_0x4f4ce6[_0x190a1d(0x141)],_0x4ac6e5=await this[_0x190a1d(0x103)][_0x190a1d(0x12a)](_0x57d721);_0x5b51e7[_0x190a1d(0x138)](0xc9)['json']({'success':!![],'message':_0x190a1d(0x13d),'result':_0x4ac6e5});}catch(_0x1da29b){_0x5235f3(_0x1da29b);}},this['getPaymentStatus']=async(_0x355089,_0x4daed4,_0x35ff65)=>{const _0x1ff941=a8_0x1846;try{const {id:_0x3f4d4e}=_0x355089[_0x1ff941(0x154)],_0x4fa41d=await this[_0x1ff941(0x103)][_0x1ff941(0x110)](_0x3f4d4e);if(!_0x4fa41d)return _0x4daed4['status'](0x194)[_0x1ff941(0x118)]({'success':![],'message':'Payment\x20not\x20found'});_0x4daed4[_0x1ff941(0x118)]({'success':!![],'result':_0x4fa41d});}catch(_0x3aad9c){_0x35ff65(_0x3aad9c);}},this['getPaymentById']=async(_0x40e481,_0x256c56,_0x1eb1c6)=>{const _0x3f1a5d=a8_0x1846;try{const {id:_0x298cd5}=_0x40e481[_0x3f1a5d(0x154)],_0x2c458a=await this[_0x3f1a5d(0x103)][_0x3f1a5d(0x104)](_0x298cd5);if(!_0x2c458a)return _0x256c56[_0x3f1a5d(0x138)](0x194)[_0x3f1a5d(0x118)]({'success':![],'message':_0x3f1a5d(0x14b)});_0x256c56[_0x3f1a5d(0x118)]({'success':!![],'result':_0x2c458a});}catch(_0x240c05){_0x1eb1c6(_0x240c05);}},this['processMasterCardPayment']=async(_0x12958d,_0x5b4d1c,_0x56f15e)=>{const _0x402ad3=a8_0x1846;try{const {id:_0x49590f}=_0x12958d[_0x402ad3(0x154)],{cardData:_0x5ddfb4,cardHolder:_0x10c8b2,browser:_0x2868e9}=_0x12958d[_0x402ad3(0x141)];console[_0x402ad3(0x10c)](_0x402ad3(0x10a)+_0x49590f);const _0x334059=await database_1['default'][_0x402ad3(0x130)][_0x402ad3(0x132)]({'where':{'id':_0x49590f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x334059)return _0x5b4d1c[_0x402ad3(0x138)](0x194)['json']({'success':![],'message':_0x402ad3(0x14b)});if(_0x334059[_0x402ad3(0x145)]!==_0x402ad3(0x12d))return _0x5b4d1c[_0x402ad3(0x138)](0x190)[_0x402ad3(0x118)]({'success':![],'message':_0x402ad3(0x15f)});if(_0x334059[_0x402ad3(0x138)]!==_0x402ad3(0x13e))return _0x5b4d1c['status'](0x190)[_0x402ad3(0x118)]({'success':![],'message':_0x402ad3(0x14e)+_0x334059[_0x402ad3(0x138)]+_0x402ad3(0x13b)});const _0x38db83=_0x402ad3(0x122),_0x70c00c=_0x334059[_0x402ad3(0x143)];console['log'](_0x402ad3(0xf7)),console[_0x402ad3(0x10c)](_0x402ad3(0x152)+_0x38db83),console[_0x402ad3(0x10c)](_0x402ad3(0x10e)+_0x70c00c);const _0x358070=await this[_0x402ad3(0x12e)][_0x402ad3(0x112)]({'paymentId':_0x334059['id'],'orderId':_0x334059['gatewayOrderId']||_0x334059['id'],'amount':_0x334059['amount'],'currency':_0x334059[_0x402ad3(0x151)],'cardData':_0x5ddfb4,'resultUrl':_0x38db83,'returnUrl':_0x70c00c,'cardHolder':_0x10c8b2,'browser':_0x2868e9});console[_0x402ad3(0x10c)]('ðŸ’³\x20MasterCard\x20result:',_0x358070);const _0x32f302={'status':_0x358070[_0x402ad3(0x138)],'updatedAt':new Date(),'statusChangedBy':_0x402ad3(0x121),'statusChangedAt':new Date()};if(_0x358070[_0x402ad3(0x138)]===_0x402ad3(0x156))_0x32f302[_0x402ad3(0x11f)]=new Date(),_0x32f302[_0x402ad3(0xfd)]=_0x358070[_0x402ad3(0x100)];else _0x358070[_0x402ad3(0x138)]===_0x402ad3(0x14a)&&(_0x32f302['failureMessage']=_0x402ad3(0x15e));_0x32f302[_0x402ad3(0x160)]=_0x402ad3(0x12d),await database_1[_0x402ad3(0x131)][_0x402ad3(0x130)][_0x402ad3(0x109)]({'where':{'id':_0x334059['id']},'data':_0x32f302}),await database_1['default'][_0x402ad3(0x114)][_0x402ad3(0x13a)]({'data':{'paymentId':_0x334059['id'],'shopId':_0x334059[_0x402ad3(0x12c)],'event':'mastercard_'+_0x358070[_0x402ad3(0x138)]?.[_0x402ad3(0x116)](),'statusCode':0xc8,'responseBody':JSON[_0x402ad3(0x135)]({'oldStatus':_0x402ad3(0x13e),'newStatus':_0x358070['status'],'gatewayPaymentId':_0x358070[_0x402ad3(0x100)],'requires3ds':_0x358070[_0x402ad3(0x15a)],'processedAt':new Date()[_0x402ad3(0x14c)]()})}});_0x358070[_0x402ad3(0x10d)]&&(await this['sendShopWebhook'](_0x334059,_0x358070[_0x402ad3(0x138)],_0x358070[_0x402ad3(0x100)]),await this[_0x402ad3(0x11a)](_0x334059,_0x358070[_0x402ad3(0x138)]));console[_0x402ad3(0x10c)](_0x402ad3(0xf8)+_0x49590f+_0x402ad3(0x117)+_0x358070[_0x402ad3(0x138)]);if(_0x358070['status']===_0x402ad3(0x156))_0x5b4d1c[_0x402ad3(0x118)]({'success':!![],'message':_0x402ad3(0x15b),'result':{'status':_0x402ad3(0x156),'gatewayPaymentId':_0x358070['gateway_payment_id'],'redirectUrl':_0x70c00c,'final':!![]}});else _0x358070[_0x402ad3(0x15a)]&&_0x358070[_0x402ad3(0xfe)]?_0x5b4d1c[_0x402ad3(0x118)]({'success':!![],'message':_0x402ad3(0x12f),'result':{'status':_0x402ad3(0x13e),'gatewayPaymentId':_0x358070[_0x402ad3(0x100)],'redirectUrl':_0x358070[_0x402ad3(0xfe)],'requires3ds':!![],'final':![]}}):_0x5b4d1c[_0x402ad3(0x138)](0x190)[_0x402ad3(0x118)]({'success':![],'message':_0x402ad3(0x136),'result':{'status':'FAILED','gatewayPaymentId':_0x358070[_0x402ad3(0x100)],'redirectUrl':_0x334059['failUrl'],'final':!![]}});}catch(_0x19ed3b){_0x56f15e(_0x19ed3b);}},this['updateCustomerData']=async(_0x116014,_0x9e24cc,_0x19a421)=>{const _0x56f846=a8_0x1846;try{const {id:_0x1b7379}=_0x116014[_0x56f846(0x154)],{customerIp:_0xd214e8,customerUa:_0x5cc621,customerCountry:_0x2e9390}=_0x116014[_0x56f846(0x141)],_0x45dce3=await database_1[_0x56f846(0x131)][_0x56f846(0x130)]['findUnique']({'where':{'id':_0x1b7379},'select':{'id':!![],'status':!![]}});if(!_0x45dce3)return _0x9e24cc['status'](0x194)[_0x56f846(0x118)]({'success':![],'message':_0x56f846(0x14b)});const _0x1004ef=await database_1[_0x56f846(0x131)]['payment'][_0x56f846(0x109)]({'where':{'id':_0x1b7379},'data':{'customerIp':_0xd214e8||undefined,'customerUa':_0x5cc621||undefined,'customerCountry':_0x2e9390||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x56f846(0x10c)]('ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20'+_0x1b7379+':',{'customerIp':_0xd214e8||_0x56f846(0x12b),'customerUa':_0x5cc621?_0x5cc621['substring'](0x0,0x32)+_0x56f846(0x159):_0x56f846(0x12b),'customerCountry':_0x2e9390||_0x56f846(0x12b)}),_0x9e24cc['json']({'success':!![],'message':_0x56f846(0x14d),'result':_0x1004ef});}catch(_0x5016e9){_0x19a421(_0x5016e9);}},this[_0x4420bb(0x103)]=new paymentService_1['PaymentService'](),this[_0x4420bb(0x12e)]=new mastercardService_1[(_0x4420bb(0x14f))](),this['webhookService']=new webhookService_1[(_0x4420bb(0x113))]();}async[a8_0x317549(0xfa)](_0x41e039,_0x44c258,_0x439eef){const _0x584028=a8_0x317549,_0x1acd43=Date[_0x584028(0x133)]();try{const _0x14f10d=_0x41e039[_0x584028(0x11e)],_0x4384e1=_0x14f10d['settings'];if(!_0x4384e1?.[_0x584028(0x127)]){console[_0x584028(0x10c)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x14f10d['id']);return;}const _0x23bdc8=_0x44c258===_0x584028(0x156)?_0x584028(0x153):_0x584028(0x101);let _0x2eba04=[];if(_0x4384e1[_0x584028(0xf9)])try{_0x2eba04=Array[_0x584028(0x13c)](_0x4384e1['webhookEvents'])?_0x4384e1[_0x584028(0xf9)]:JSON[_0x584028(0x124)](_0x4384e1[_0x584028(0xf9)]);}catch(_0x3a0f5c){console[_0x584028(0x146)]('Error\x20parsing\x20webhook\x20events:',_0x3a0f5c),_0x2eba04=[];}if(!_0x2eba04[_0x584028(0x139)](_0x23bdc8)){console[_0x584028(0x10c)](_0x584028(0x157)+_0x23bdc8+'\x20not\x20enabled\x20for\x20shop\x20'+_0x14f10d['id']);return;}const _0x4d7051={'event':_0x23bdc8,'payment':{'id':_0x41e039['id'],'order_id':_0x41e039['orderId'],'gateway_order_id':_0x41e039[_0x584028(0xf4)],'gateway':_0x584028(0x107),'amount':_0x41e039['amount'],'currency':_0x41e039['currency'],'status':_0x44c258[_0x584028(0x116)](),'customer_email':_0x41e039[_0x584028(0x120)],'customer_name':_0x41e039['customerName'],'gateway_payment_id':_0x439eef,'created_at':_0x41e039[_0x584028(0x102)],'updated_at':new Date()}},_0x36956c=await fetch(_0x4384e1[_0x584028(0x127)],{'method':_0x584028(0x11c),'headers':{'Content-Type':_0x584028(0x106),'User-Agent':_0x584028(0x147)},'body':JSON[_0x584028(0x135)](_0x4d7051)}),_0x258dc8=Date['now']()-_0x1acd43;console[_0x584028(0x10c)](_0x584028(0x15d)+_0x4384e1['webhookUrl']+'\x20with\x20status\x20'+_0x36956c[_0x584028(0x138)]+'\x20('+_0x258dc8+_0x584028(0x10f));}catch(_0x2c34db){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x2c34db);}}async[a8_0x317549(0x11a)](_0x18fcb6,_0x162403){const _0x3f4b8a=a8_0x317549;try{const {telegramBotService:_0x2ecb05}=await Promise[_0x3f4b8a(0x161)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x2b54e4={'PAID':_0x3f4b8a(0x150),'FAILED':'failed'},_0xa1f252=_0x2b54e4[_0x162403];if(!_0xa1f252)return;await _0x2ecb05[_0x3f4b8a(0x115)](_0x18fcb6[_0x3f4b8a(0x12c)],_0x18fcb6,_0xa1f252);}catch(_0x4a1254){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4a1254);}}}function a8_0x1af3(){const _0x19111a=['âœ…\x20MasterCard\x20payment\x20','webhookEvents','sendShopWebhook','__esModule','468798IXMqbC','gatewayPaymentId','threeds_url','31vSVxBi','gateway_payment_id','payment.failed','createdAt','paymentService','getPaymentById','writable','application/json','1111','835992ZCFSjQ','update','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','configurable','log','final','\x20\x20\x20Return\x20URL:\x20','ms)','getPaymentStatus','1427665urASdR','processCardPayment','WebhookService','webhookLog','sendPaymentNotification','toLowerCase','\x20processed:\x20','json','../services/webhookService','sendPaymentStatusNotification','__setModuleDefault','POST','156KtuULx','shop','paidAt','customerEmail','system','https://api.trapay.uk/api/webhooks/gateway/mastercard','11326EOmpOx','parse','30018RYyYLx','__importStar','webhookUrl','../services/gateways/mastercardService','getOwnPropertyDescriptor','createPublicPayment','not\x20provided','shopId','mastercard','masterCardService','3DS\x20verification\x20required','payment','default','findUnique','now','getOwnPropertyNames','stringify','Payment\x20failed','PaymentController','status','includes','create',',\x20cannot\x20process','isArray','Payment\x20created\x20successfully','PENDING','prototype','9sLoyxJ','body','get','successUrl','__importDefault','gateway','error','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','343737jiXqPj','length','FAILED','Payment\x20not\x20found','toISOString','Customer\x20data\x20updated\x20successfully','Payment\x20status\x20is\x20','MasterCardService','paid','currency','\x20\x20\x20Result\x20URL\x20(webhook):\x20','payment.success','params','__createBinding','PAID','Webhook\x20event\x20','4uhMgKC','...','requires_3ds','Payment\x20processed\x20successfully','call','MasterCard\x20webhook\x20sent\x20to\x20','Card\x20payment\x20failed','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','paymentMethod','resolve','466630vUnLge','gatewayOrderId','427XVgMWl','defineProperty','ðŸ’³\x20MasterCard\x20URLs:'];a8_0x1af3=function(){return _0x19111a;};return a8_0x1af3();}exports['PaymentController']=PaymentController;