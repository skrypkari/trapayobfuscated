'use strict';const a8_0x34b50b=a8_0x23ed;function a8_0x23ed(_0x212652,_0xcd279f){const _0x56db89=a8_0x56db();return a8_0x23ed=function(_0x23ed05,_0x56184c){_0x23ed05=_0x23ed05-0x165;let _0x1736c9=_0x56db89[_0x23ed05];return _0x1736c9;},a8_0x23ed(_0x212652,_0xcd279f);}function a8_0x56db(){const _0x2225c6=['TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','üí≥\x20MasterCard\x20result:','call','params','masterCardService','MasterCard\x20webhook\x20sent\x20to\x20','webhookLog','2aqKGuS','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','paymentMethod','2519nGPZjB','WebhookService','defineProperty','573230iMlFKe','error',',\x20cannot\x20process','‚úÖ\x20MasterCard\x20payment\x20','cardLast4','threeds_url','final','user_agent','payment.success','create','configurable','last_name','createdAt','paymentService','22960McFiZB','../config/database','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','handleSuccessfulPayment','__setModuleDefault','body','PENDING','Payment\x20created\x20successfully','status','customerName','amount','9HTHCdp','2442170TxvzIy','1574545NvdlvZ','mastercard','Payment\x20processed\x20successfully','processCardPayment','log','now','paidAt','https://api.trapay.uk/api/webhooks/gateway/mastercard','gateway_payment_id','shopId','sendShopWebhook','__importDefault','customerCountry','paid','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Payment\x20not\x20found','ms)','successUrl','system','payment','number','gateway','writable','currency','json','getPaymentById','__esModule','customerEmail','resolve','MasterCardService','country','slice','getOwnPropertyNames','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','customerUa','isArray','updatedAt','gatewayOrderId','length','getOwnPropertyDescriptor','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','üí≥\x20Processing\x20MasterCard\x20payment:\x20','stringify','PaymentController','first_name','FAILED','sendPaymentStatusNotification','Error\x20parsing\x20webhook\x20events:','includes','settings','üí≥\x20Browser\x20IP:\x20','102WRyllc','then','PaymentService','sendPaymentNotification','replace','customerIp','2356592aLrRab','773733aofRNh','hasOwnProperty','webhookUrl','Payment\x20status\x20is\x20','PAID','gatewayPaymentId','üí≥\x20Card\x20holder:\x20','webhookEvents','processMasterCardPayment','13799480LRsnEy','\x20processed:\x20','default','getPaymentStatus','failUrl','__importStar','üìù\x20Customer\x20data:','requires_3ds','orderId','1111','../services/paymentService','email'];a8_0x56db=function(){return _0x2225c6;};return a8_0x56db();}(function(_0x32c125,_0x175314){const _0x27ac7d=a8_0x23ed,_0x42ea4d=_0x32c125();while(!![]){try{const _0x2b01d1=parseInt(_0x27ac7d(0x17b))/0x1+-parseInt(_0x27ac7d(0x1d1))/0x2*(-parseInt(_0x27ac7d(0x1b5))/0x3)+-parseInt(_0x27ac7d(0x1b4))/0x4+-parseInt(_0x27ac7d(0x17a))/0x5+parseInt(_0x27ac7d(0x1ae))/0x6*(parseInt(_0x27ac7d(0x1d9))/0x7)+parseInt(_0x27ac7d(0x1be))/0x8*(-parseInt(_0x27ac7d(0x179))/0x9)+-parseInt(_0x27ac7d(0x16e))/0xa*(-parseInt(_0x27ac7d(0x1d6))/0xb);if(_0x2b01d1===_0x175314)break;else _0x42ea4d['push'](_0x42ea4d['shift']());}catch(_0x49777d){_0x42ea4d['push'](_0x42ea4d['shift']());}}}(a8_0x56db,0xe768d));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x568da0,_0x43abe1,_0x267792,_0x4ca949){const _0x5c0cac=a8_0x23ed;if(_0x4ca949===undefined)_0x4ca949=_0x267792;var _0x5652b1=Object[_0x5c0cac(0x1a2)](_0x43abe1,_0x267792);(!_0x5652b1||('get'in _0x5652b1?!_0x43abe1['__esModule']:_0x5652b1[_0x5c0cac(0x191)]||_0x5652b1[_0x5c0cac(0x16a)]))&&(_0x5652b1={'enumerable':!![],'get':function(){return _0x43abe1[_0x267792];}}),Object[_0x5c0cac(0x1d8)](_0x568da0,_0x4ca949,_0x5652b1);}:function(_0x39f5a0,_0x3fb790,_0x4fec24,_0x1a1476){if(_0x1a1476===undefined)_0x1a1476=_0x4fec24;_0x39f5a0[_0x1a1476]=_0x3fb790[_0x4fec24];}),__setModuleDefault=this&&this[a8_0x34b50b(0x172)]||(Object[a8_0x34b50b(0x169)]?function(_0xd5e3f0,_0x24d25e){const _0x174c4c=a8_0x34b50b;Object[_0x174c4c(0x1d8)](_0xd5e3f0,_0x174c4c(0x1c0),{'enumerable':!![],'value':_0x24d25e});}:function(_0x5797ca,_0xdc7023){const _0x5d49f3=a8_0x34b50b;_0x5797ca[_0x5d49f3(0x1c0)]=_0xdc7023;}),__importStar=this&&this[a8_0x34b50b(0x1c3)]||(function(){var _0x5bab3e=function(_0x272a79){const _0x25eba0=a8_0x23ed;return _0x5bab3e=Object[_0x25eba0(0x19b)]||function(_0x154ab5){const _0x3aa6f9=_0x25eba0;var _0x42e3e9=[];for(var _0x23150c in _0x154ab5)if(Object['prototype'][_0x3aa6f9(0x1b6)][_0x3aa6f9(0x1cc)](_0x154ab5,_0x23150c))_0x42e3e9[_0x42e3e9[_0x3aa6f9(0x1a1)]]=_0x23150c;return _0x42e3e9;},_0x5bab3e(_0x272a79);};return function(_0x54eee9){const _0x55e964=a8_0x23ed;if(_0x54eee9&&_0x54eee9['__esModule'])return _0x54eee9;var _0x120df5={};if(_0x54eee9!=null){for(var _0x479876=_0x5bab3e(_0x54eee9),_0x9b17b0=0x0;_0x9b17b0<_0x479876[_0x55e964(0x1a1)];_0x9b17b0++)if(_0x479876[_0x9b17b0]!=='default')__createBinding(_0x120df5,_0x54eee9,_0x479876[_0x9b17b0]);}return __setModuleDefault(_0x120df5,_0x54eee9),_0x120df5;};}()),__importDefault=this&&this[a8_0x34b50b(0x186)]||function(_0xcc8838){const _0x2dc617=a8_0x34b50b;return _0xcc8838&&_0xcc8838[_0x2dc617(0x195)]?_0xcc8838:{'default':_0xcc8838};};Object[a8_0x34b50b(0x1d8)](exports,a8_0x34b50b(0x195),{'value':!![]}),exports[a8_0x34b50b(0x1a6)]=void 0x0;const paymentService_1=require(a8_0x34b50b(0x1c8)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x34b50b(0x16f)));class PaymentController{constructor(){const _0x5ab3f5=a8_0x34b50b;this['createPublicPayment']=async(_0x53b6ba,_0x1921b7,_0x3618eb)=>{const _0x979f5a=a8_0x23ed;try{const _0x1cb81a=_0x53b6ba[_0x979f5a(0x173)],_0x45f3e2=await this[_0x979f5a(0x16d)]['createPublicPayment'](_0x1cb81a);_0x1921b7[_0x979f5a(0x176)](0xc9)[_0x979f5a(0x193)]({'success':!![],'message':_0x979f5a(0x175),'result':_0x45f3e2});}catch(_0x309ab8){_0x3618eb(_0x309ab8);}},this[_0x5ab3f5(0x1c1)]=async(_0x3ccf73,_0x249320,_0x4da07d)=>{const _0xe4d5c9=_0x5ab3f5;try{const {id:_0x2fabd0}=_0x3ccf73[_0xe4d5c9(0x1cd)],_0x24d791=await this[_0xe4d5c9(0x16d)][_0xe4d5c9(0x1c1)](_0x2fabd0);if(!_0x24d791)return _0x249320[_0xe4d5c9(0x176)](0x194)[_0xe4d5c9(0x193)]({'success':![],'message':_0xe4d5c9(0x18a)});_0x249320[_0xe4d5c9(0x193)]({'success':!![],'result':_0x24d791});}catch(_0x2b08e1){_0x4da07d(_0x2b08e1);}},this[_0x5ab3f5(0x194)]=async(_0x48288f,_0x35efd6,_0x5bc2db)=>{const _0x2fa646=_0x5ab3f5;try{const {id:_0x7396f6}=_0x48288f[_0x2fa646(0x1cd)],_0x475899=await this[_0x2fa646(0x16d)][_0x2fa646(0x194)](_0x7396f6);if(!_0x475899)return _0x35efd6[_0x2fa646(0x176)](0x194)[_0x2fa646(0x193)]({'success':![],'message':_0x2fa646(0x18a)});_0x35efd6['json']({'success':!![],'result':_0x475899});}catch(_0x268527){_0x5bc2db(_0x268527);}},this['updatePaymentCustomer']=async(_0x3155f3,_0x1c4df9,_0x648df5)=>{const _0x1a9dea=_0x5ab3f5;try{const {id:_0x3a49cd}=_0x3155f3[_0x1a9dea(0x1cd)],_0x1386a0=_0x3155f3[_0x1a9dea(0x173)];console[_0x1a9dea(0x17f)](_0x1a9dea(0x19c)+_0x3a49cd),console['log'](_0x1a9dea(0x1c4),_0x1386a0);const _0x5b4a9d=await this[_0x1a9dea(0x16d)]['updatePaymentCustomerDataPublic'](_0x3a49cd,_0x1386a0);if(!_0x5b4a9d)return _0x1c4df9[_0x1a9dea(0x176)](0x194)[_0x1a9dea(0x193)]({'success':![],'message':_0x1a9dea(0x18a)});_0x1c4df9[_0x1a9dea(0x193)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x5b4a9d['id'],'customerIp':_0x5b4a9d[_0x1a9dea(0x1b3)],'customerUa':_0x5b4a9d[_0x1a9dea(0x19d)],'customerCountry':_0x5b4a9d[_0x1a9dea(0x187)],'updatedAt':_0x5b4a9d[_0x1a9dea(0x19f)]}});}catch(_0x2cffb3){_0x648df5(_0x2cffb3);}},this[_0x5ab3f5(0x1bd)]=async(_0x2889f3,_0x56138c,_0x45425f)=>{const _0x5f3212=_0x5ab3f5;try{const {id:_0x31b688}=_0x2889f3['params'],{cardData:_0x35e51d,cardHolder:_0x3fafff,browser:_0x1e8beb}=_0x2889f3['body'];console[_0x5f3212(0x17f)](_0x5f3212(0x1a4)+_0x31b688),console[_0x5f3212(0x17f)](_0x5f3212(0x1bb)+_0x3fafff[_0x5f3212(0x1a7)]+'\x20'+_0x3fafff[_0x5f3212(0x16b)]+'\x20('+_0x3fafff[_0x5f3212(0x1c9)]+')'),console[_0x5f3212(0x17f)](_0x5f3212(0x1ad)+_0x1e8beb['ip']);const _0x56bcf2={'customerName':_0x3fafff[_0x5f3212(0x1a7)]+'\x20'+_0x3fafff[_0x5f3212(0x16b)],'customerEmail':_0x3fafff['email'],'customerIp':_0x1e8beb['ip'],'customerUa':_0x1e8beb[_0x5f3212(0x167)],'customerCountry':_0x3fafff[_0x5f3212(0x199)]||null},_0x34a5c4=await database_1[_0x5f3212(0x1c0)]['payment']['findUnique']({'where':{'id':_0x31b688},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34a5c4)return _0x56138c[_0x5f3212(0x176)](0x194)[_0x5f3212(0x193)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x34a5c4[_0x5f3212(0x190)]!==_0x5f3212(0x17c))return _0x56138c[_0x5f3212(0x176)](0x190)[_0x5f3212(0x193)]({'success':![],'message':_0x5f3212(0x189)});if(_0x34a5c4[_0x5f3212(0x176)]!=='PENDING')return _0x56138c[_0x5f3212(0x176)](0x190)['json']({'success':![],'message':_0x5f3212(0x1b8)+_0x34a5c4[_0x5f3212(0x176)]+_0x5f3212(0x1db)});await database_1[_0x5f3212(0x1c0)][_0x5f3212(0x18e)]['update']({'where':{'id':_0x31b688},'data':{..._0x56bcf2,'updatedAt':new Date()}});const _0x1b5130=_0x5f3212(0x182),_0x248855=_0x34a5c4[_0x5f3212(0x18c)];console[_0x5f3212(0x17f)]('üí≥\x20MasterCard\x20URLs:'),console['log']('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x1b5130),console[_0x5f3212(0x17f)]('\x20\x20\x20Return\x20URL:\x20'+_0x248855);const _0x45c135={'first_name':_0x3fafff['first_name'],'last_name':_0x3fafff[_0x5f3212(0x16b)],'email':_0x3fafff[_0x5f3212(0x1c9)]},_0x58bfd1=await this[_0x5f3212(0x1ce)][_0x5f3212(0x17e)]({'paymentId':_0x34a5c4['id'],'orderId':_0x34a5c4[_0x5f3212(0x1a0)]||_0x34a5c4['id'],'amount':_0x34a5c4[_0x5f3212(0x178)],'currency':_0x34a5c4[_0x5f3212(0x192)],'cardData':_0x35e51d,'resultUrl':_0x1b5130,'returnUrl':_0x248855,'cardHolder':_0x45c135,'browser':_0x1e8beb});console[_0x5f3212(0x17f)](_0x5f3212(0x1cb),_0x58bfd1);const _0x5700d9={'status':_0x58bfd1[_0x5f3212(0x176)],'updatedAt':new Date(),'statusChangedBy':_0x5f3212(0x18d),'statusChangedAt':new Date()};if(_0x58bfd1[_0x5f3212(0x176)]==='PAID')_0x5700d9[_0x5f3212(0x181)]=new Date(),_0x5700d9[_0x5f3212(0x1ba)]=_0x58bfd1[_0x5f3212(0x183)];else _0x58bfd1['status']==='FAILED'&&(_0x5700d9['failureMessage']='Card\x20payment\x20failed');_0x5700d9[_0x5f3212(0x1d5)]=_0x5f3212(0x17c);if(_0x35e51d[_0x5f3212(0x18f)]){const _0x1871d6=_0x35e51d[_0x5f3212(0x18f)][_0x5f3212(0x1b2)](/[\s-]/g,'');_0x5700d9[_0x5f3212(0x1dd)]=_0x1871d6[_0x5f3212(0x19a)](-0x4),console['log'](_0x5f3212(0x1a3)+_0x5700d9[_0x5f3212(0x1dd)]);}await database_1['default'][_0x5f3212(0x18e)]['update']({'where':{'id':_0x34a5c4['id']},'data':_0x5700d9}),await database_1[_0x5f3212(0x1c0)][_0x5f3212(0x1d0)][_0x5f3212(0x169)]({'data':{'paymentId':_0x34a5c4['id'],'shopId':_0x34a5c4[_0x5f3212(0x184)],'event':'mastercard_'+_0x58bfd1[_0x5f3212(0x176)]?.[_0x5f3212(0x1d4)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x5f3212(0x174),'newStatus':_0x58bfd1[_0x5f3212(0x176)],'gatewayPaymentId':_0x58bfd1[_0x5f3212(0x183)],'requires3ds':_0x58bfd1[_0x5f3212(0x1c5)],'processedAt':new Date()['toISOString']()})}});if(_0x58bfd1[_0x5f3212(0x166)]){await this[_0x5f3212(0x185)](_0x34a5c4,_0x58bfd1['status'],_0x58bfd1[_0x5f3212(0x183)]),await this[_0x5f3212(0x1a9)](_0x34a5c4,_0x58bfd1['status']);if(_0x58bfd1['status']===_0x5f3212(0x1b9)){console[_0x5f3212(0x17f)]('üìà\x20MasterCard\x20payment\x20'+_0x31b688+_0x5f3212(0x1d2));try{const {PaymentLinkService:_0xaa5fd9}=await Promise[_0x5f3212(0x197)]()[_0x5f3212(0x1af)](()=>__importStar(require('../services/paymentLinkService'))),_0x4bb007=new _0xaa5fd9();await _0x4bb007[_0x5f3212(0x171)](_0x31b688),console[_0x5f3212(0x17f)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x31b688);}catch(_0x839c1b){console['error'](_0x5f3212(0x170),_0x839c1b);}}}console[_0x5f3212(0x17f)](_0x5f3212(0x1dc)+_0x31b688+_0x5f3212(0x1bf)+_0x58bfd1[_0x5f3212(0x176)]);if(_0x58bfd1[_0x5f3212(0x176)]==='PAID')_0x56138c['json']({'success':!![],'message':_0x5f3212(0x17d),'result':{'status':_0x5f3212(0x1b9),'gatewayPaymentId':_0x58bfd1[_0x5f3212(0x183)],'redirectUrl':_0x248855,'final':!![]}});else _0x58bfd1['requires_3ds']&&_0x58bfd1[_0x5f3212(0x165)]?_0x56138c[_0x5f3212(0x193)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x5f3212(0x174),'gatewayPaymentId':_0x58bfd1[_0x5f3212(0x183)],'redirectUrl':_0x58bfd1['threeds_url'],'requires3ds':!![],'final':![]}}):_0x56138c['status'](0x190)[_0x5f3212(0x193)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x5f3212(0x1a8),'gatewayPaymentId':_0x58bfd1[_0x5f3212(0x183)],'redirectUrl':_0x34a5c4[_0x5f3212(0x1c2)],'final':!![]}});}catch(_0x5a7e26){_0x45425f(_0x5a7e26);}},this[_0x5ab3f5(0x16d)]=new paymentService_1[(_0x5ab3f5(0x1b0))](),this[_0x5ab3f5(0x1ce)]=new mastercardService_1[(_0x5ab3f5(0x198))](),this['webhookService']=new webhookService_1[(_0x5ab3f5(0x1d7))]();}async[a8_0x34b50b(0x185)](_0x15c695,_0x1092ba,_0x57818d){const _0x5141cb=a8_0x34b50b,_0x546273=Date[_0x5141cb(0x180)]();try{const _0x29df6f=_0x15c695['shop'],_0x160464=_0x29df6f[_0x5141cb(0x1ac)];if(!_0x160464?.[_0x5141cb(0x1b7)]){console['log'](_0x5141cb(0x1d3)+_0x29df6f['id']);return;}const _0x41c3e=_0x1092ba==='PAID'?_0x5141cb(0x168):'payment.failed';let _0x26285b=[];if(_0x160464['webhookEvents'])try{_0x26285b=Array[_0x5141cb(0x19e)](_0x160464[_0x5141cb(0x1bc)])?_0x160464[_0x5141cb(0x1bc)]:JSON['parse'](_0x160464['webhookEvents']);}catch(_0x3d417d){console['error'](_0x5141cb(0x1aa),_0x3d417d),_0x26285b=[];}if(!_0x26285b[_0x5141cb(0x1ab)](_0x41c3e)){console['log']('Webhook\x20event\x20'+_0x41c3e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x29df6f['id']);return;}const _0x425a93={'event':_0x41c3e,'payment':{'id':_0x15c695['id'],'order_id':_0x15c695[_0x5141cb(0x1c6)],'gateway_order_id':_0x15c695[_0x5141cb(0x1a0)],'gateway':_0x5141cb(0x1c7),'amount':_0x15c695[_0x5141cb(0x178)],'currency':_0x15c695['currency'],'status':_0x1092ba[_0x5141cb(0x1d4)](),'customer_email':_0x15c695[_0x5141cb(0x196)],'customer_name':_0x15c695[_0x5141cb(0x177)],'gateway_payment_id':_0x57818d,'created_at':_0x15c695[_0x5141cb(0x16c)],'updated_at':new Date()}},_0x596757=await fetch(_0x160464[_0x5141cb(0x1b7)],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':_0x5141cb(0x1ca)},'body':JSON[_0x5141cb(0x1a5)](_0x425a93)}),_0x245d52=Date[_0x5141cb(0x180)]()-_0x546273;console['log'](_0x5141cb(0x1cf)+_0x160464['webhookUrl']+'\x20with\x20status\x20'+_0x596757[_0x5141cb(0x176)]+'\x20('+_0x245d52+_0x5141cb(0x18b));}catch(_0x33e380){console[_0x5141cb(0x1da)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x33e380);}}async[a8_0x34b50b(0x1a9)](_0x3c419d,_0x57b0e6){const _0x1c624f=a8_0x34b50b;try{const {telegramBotService:_0x2732df}=await Promise[_0x1c624f(0x197)]()[_0x1c624f(0x1af)](()=>__importStar(require('../services/telegramBotService'))),_0xa971d8={'PAID':_0x1c624f(0x188),'FAILED':'failed'},_0x3883ce=_0xa971d8[_0x57b0e6];if(!_0x3883ce)return;await _0x2732df[_0x1c624f(0x1b1)](_0x3c419d[_0x1c624f(0x184)],_0x3c419d,_0x3883ce);}catch(_0x224b53){console[_0x1c624f(0x1da)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x224b53);}}}exports[a8_0x34b50b(0x1a6)]=PaymentController;