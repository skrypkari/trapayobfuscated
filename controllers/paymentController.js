'use strict';const a8_0x460c7f=a8_0x9223;(function(_0x767c48,_0x5883f8){const _0x2cf31c=a8_0x9223,_0x4bc3a0=_0x767c48();while(!![]){try{const _0x5f3349=-parseInt(_0x2cf31c(0x13c))/0x1+-parseInt(_0x2cf31c(0xfc))/0x2+-parseInt(_0x2cf31c(0x13e))/0x3+-parseInt(_0x2cf31c(0x12f))/0x4+parseInt(_0x2cf31c(0x143))/0x5*(parseInt(_0x2cf31c(0x148))/0x6)+parseInt(_0x2cf31c(0xfa))/0x7+parseInt(_0x2cf31c(0x146))/0x8;if(_0x5f3349===_0x5883f8)break;else _0x4bc3a0['push'](_0x4bc3a0['shift']());}catch(_0x1a8740){_0x4bc3a0['push'](_0x4bc3a0['shift']());}}}(a8_0x5254,0xc71f4));var __createBinding=this&&this[a8_0x460c7f(0xda)]||(Object['create']?function(_0x18aeff,_0x51ce3a,_0x189575,_0x42ac08){const _0x342d58=a8_0x460c7f;if(_0x42ac08===undefined)_0x42ac08=_0x189575;var _0x31bd20=Object[_0x342d58(0xd5)](_0x51ce3a,_0x189575);(!_0x31bd20||(_0x342d58(0x10b)in _0x31bd20?!_0x51ce3a['__esModule']:_0x31bd20[_0x342d58(0xea)]||_0x31bd20['configurable']))&&(_0x31bd20={'enumerable':!![],'get':function(){return _0x51ce3a[_0x189575];}}),Object[_0x342d58(0xde)](_0x18aeff,_0x42ac08,_0x31bd20);}:function(_0x572d60,_0x1075f1,_0x42a076,_0x582783){if(_0x582783===undefined)_0x582783=_0x42a076;_0x572d60[_0x582783]=_0x1075f1[_0x42a076];}),__setModuleDefault=this&&this[a8_0x460c7f(0xe5)]||(Object[a8_0x460c7f(0xf2)]?function(_0x334560,_0x4d8ddb){const _0x39f9fe=a8_0x460c7f;Object['defineProperty'](_0x334560,_0x39f9fe(0x13f),{'enumerable':!![],'value':_0x4d8ddb});}:function(_0x261072,_0x7eadfd){const _0x44981f=a8_0x460c7f;_0x261072[_0x44981f(0x13f)]=_0x7eadfd;}),__importStar=this&&this[a8_0x460c7f(0x136)]||(function(){var _0x2193de=function(_0x83c1fc){const _0x7eb7dd=a8_0x9223;return _0x2193de=Object[_0x7eb7dd(0x103)]||function(_0x421cd4){const _0x162170=_0x7eb7dd;var _0x5582d6=[];for(var _0x31e923 in _0x421cd4)if(Object[_0x162170(0x12d)][_0x162170(0x122)][_0x162170(0x147)](_0x421cd4,_0x31e923))_0x5582d6[_0x5582d6['length']]=_0x31e923;return _0x5582d6;},_0x2193de(_0x83c1fc);};return function(_0x27a48c){const _0x5139e2=a8_0x9223;if(_0x27a48c&&_0x27a48c[_0x5139e2(0x111)])return _0x27a48c;var _0x2b8a32={};if(_0x27a48c!=null){for(var _0x3e1a52=_0x2193de(_0x27a48c),_0x2eeff3=0x0;_0x2eeff3<_0x3e1a52['length'];_0x2eeff3++)if(_0x3e1a52[_0x2eeff3]!=='default')__createBinding(_0x2b8a32,_0x27a48c,_0x3e1a52[_0x2eeff3]);}return __setModuleDefault(_0x2b8a32,_0x27a48c),_0x2b8a32;};}()),__importDefault=this&&this['__importDefault']||function(_0x39ea0d){const _0x356893=a8_0x460c7f;return _0x39ea0d&&_0x39ea0d[_0x356893(0x111)]?_0x39ea0d:{'default':_0x39ea0d};};Object[a8_0x460c7f(0xde)](exports,a8_0x460c7f(0x111),{'value':!![]}),exports[a8_0x460c7f(0x12c)]=void 0x0;const paymentService_1=require(a8_0x460c7f(0xe8)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x460c7f(0x127)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x350c99=a8_0x460c7f;this[_0x350c99(0xf9)]=async(_0x4882e9,_0x35849c,_0x315bc2)=>{const _0x56940b=_0x350c99;try{const _0x2bc2a3=_0x4882e9[_0x56940b(0x113)],_0xdbc22b=await this[_0x56940b(0xee)]['createPublicPayment'](_0x2bc2a3);_0x35849c[_0x56940b(0x107)](0xc9)[_0x56940b(0x131)]({'success':!![],'message':_0x56940b(0xdb),'result':_0xdbc22b});}catch(_0x1418b8){_0x315bc2(_0x1418b8);}},this[_0x350c99(0x12e)]=async(_0x5b2ab1,_0x3c0530,_0x1ecab0)=>{const _0x5d0644=_0x350c99;try{const {id:_0x2af145}=_0x5b2ab1[_0x5d0644(0xe4)],_0x4d83fb=await this['paymentService'][_0x5d0644(0x12e)](_0x2af145);if(!_0x4d83fb)return _0x3c0530[_0x5d0644(0x107)](0x194)[_0x5d0644(0x131)]({'success':![],'message':_0x5d0644(0x140)});_0x3c0530[_0x5d0644(0x131)]({'success':!![],'result':_0x4d83fb});}catch(_0x3c992f){_0x1ecab0(_0x3c992f);}},this[_0x350c99(0x133)]=async(_0x181dfa,_0x5d8e8c,_0x183ac6)=>{const _0x3579f7=_0x350c99;try{const {id:_0x324ded}=_0x181dfa[_0x3579f7(0xe4)],_0x296525=await this['paymentService'][_0x3579f7(0x133)](_0x324ded);if(!_0x296525)return _0x5d8e8c['status'](0x194)[_0x3579f7(0x131)]({'success':![],'message':'Payment\x20not\x20found'});_0x5d8e8c[_0x3579f7(0x131)]({'success':!![],'result':_0x296525});}catch(_0xc6df1d){_0x183ac6(_0xc6df1d);}},this[_0x350c99(0xd8)]=async(_0x575f08,_0x498c15,_0x59adf7)=>{const _0x50e09d=_0x350c99;try{const {id:_0x2a9b62}=_0x575f08[_0x50e09d(0xe4)],_0x23d1b2=_0x575f08[_0x50e09d(0x120)]?.['id'],_0x22283e=_0x575f08['body'];if(!_0x23d1b2)return _0x498c15[_0x50e09d(0x107)](0x191)[_0x50e09d(0x131)]({'success':![],'message':_0x50e09d(0xe6)});console[_0x50e09d(0x123)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x2a9b62+_0x50e09d(0x145)+_0x23d1b2),console['log']('📝\x20Customer\x20data:',_0x22283e);const _0x1680c7=await this[_0x50e09d(0xee)]['updatePaymentCustomerData'](_0x23d1b2,_0x2a9b62,_0x22283e);if(!_0x1680c7)return _0x498c15['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop'});_0x498c15[_0x50e09d(0x131)]({'success':!![],'message':_0x50e09d(0xfb),'result':{'paymentId':_0x1680c7['id'],'customerIp':_0x1680c7[_0x50e09d(0xf0)],'customerUa':_0x1680c7['customerUa'],'customerCountry':_0x1680c7[_0x50e09d(0x117)],'updatedAt':_0x1680c7[_0x50e09d(0x138)]}});}catch(_0x3513cb){_0x59adf7(_0x3513cb);}},this[_0x350c99(0xec)]=async(_0x48500d,_0x46b042,_0x5a243f)=>{const _0x11ffac=_0x350c99;try{const {id:_0x174c2a}=_0x48500d[_0x11ffac(0xe4)],{cardData:_0x251757,cardHolder:_0x3f61d6,browser:_0x3aad88}=_0x48500d[_0x11ffac(0x113)];console[_0x11ffac(0x123)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x174c2a);const _0x2ec8de=await database_1[_0x11ffac(0x13f)][_0x11ffac(0x124)]['findUnique']({'where':{'id':_0x174c2a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2ec8de)return _0x46b042['status'](0x194)[_0x11ffac(0x131)]({'success':![],'message':_0x11ffac(0x140)});if(_0x2ec8de[_0x11ffac(0x108)]!==_0x11ffac(0xfd))return _0x46b042[_0x11ffac(0x107)](0x190)[_0x11ffac(0x131)]({'success':![],'message':_0x11ffac(0xdd)});if(_0x2ec8de['status']!==_0x11ffac(0xf8))return _0x46b042['status'](0x190)[_0x11ffac(0x131)]({'success':![],'message':_0x11ffac(0xf7)+_0x2ec8de['status']+_0x11ffac(0x112)});const _0x40f6af='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x228831=_0x2ec8de[_0x11ffac(0x11f)];console[_0x11ffac(0x123)]('💳\x20MasterCard\x20URLs:'),console[_0x11ffac(0x123)](_0x11ffac(0xf6)+_0x40f6af),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x228831);const _0x239727=await this[_0x11ffac(0x105)][_0x11ffac(0x125)]({'paymentId':_0x2ec8de['id'],'orderId':_0x2ec8de[_0x11ffac(0xe0)]||_0x2ec8de['id'],'amount':_0x2ec8de[_0x11ffac(0xeb)],'currency':_0x2ec8de[_0x11ffac(0x10f)],'cardData':_0x251757,'resultUrl':_0x40f6af,'returnUrl':_0x228831,'cardHolder':_0x3f61d6,'browser':_0x3aad88});console[_0x11ffac(0x123)](_0x11ffac(0xef),_0x239727);const _0x3190cd={'status':_0x239727['status'],'updatedAt':new Date(),'statusChangedBy':_0x11ffac(0xd6),'statusChangedAt':new Date()};if(_0x239727['status']===_0x11ffac(0xff))_0x3190cd['paidAt']=new Date(),_0x3190cd[_0x11ffac(0x101)]=_0x239727['gateway_payment_id'];else _0x239727['status']===_0x11ffac(0x100)&&(_0x3190cd[_0x11ffac(0x144)]=_0x11ffac(0xf3));_0x3190cd[_0x11ffac(0x12b)]='mastercard',await database_1['default'][_0x11ffac(0x124)][_0x11ffac(0x12a)]({'where':{'id':_0x2ec8de['id']},'data':_0x3190cd}),await database_1[_0x11ffac(0x13f)][_0x11ffac(0x141)][_0x11ffac(0xf2)]({'data':{'paymentId':_0x2ec8de['id'],'shopId':_0x2ec8de['shopId'],'event':_0x11ffac(0x13b)+_0x239727[_0x11ffac(0x107)]?.[_0x11ffac(0x134)](),'statusCode':0xc8,'responseBody':JSON[_0x11ffac(0x118)]({'oldStatus':_0x11ffac(0xf8),'newStatus':_0x239727['status'],'gatewayPaymentId':_0x239727[_0x11ffac(0xe3)],'requires3ds':_0x239727[_0x11ffac(0x106)],'processedAt':new Date()[_0x11ffac(0xe1)]()})}});_0x239727[_0x11ffac(0x135)]&&(await this[_0x11ffac(0x110)](_0x2ec8de,_0x239727[_0x11ffac(0x107)],_0x239727['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x2ec8de,_0x239727[_0x11ffac(0x107)]));console['log'](_0x11ffac(0xf4)+_0x174c2a+_0x11ffac(0xd7)+_0x239727[_0x11ffac(0x107)]);if(_0x239727[_0x11ffac(0x107)]===_0x11ffac(0xff))_0x46b042[_0x11ffac(0x131)]({'success':!![],'message':_0x11ffac(0x126),'result':{'status':'PAID','gatewayPaymentId':_0x239727[_0x11ffac(0xe3)],'redirectUrl':_0x228831,'final':!![]}});else _0x239727[_0x11ffac(0x106)]&&_0x239727['threeds_url']?_0x46b042[_0x11ffac(0x131)]({'success':!![],'message':_0x11ffac(0x119),'result':{'status':_0x11ffac(0xf8),'gatewayPaymentId':_0x239727['gateway_payment_id'],'redirectUrl':_0x239727[_0x11ffac(0xe7)],'requires3ds':!![],'final':![]}}):_0x46b042[_0x11ffac(0x107)](0x190)['json']({'success':![],'message':_0x11ffac(0x115),'result':{'status':_0x11ffac(0x100),'gatewayPaymentId':_0x239727[_0x11ffac(0xe3)],'redirectUrl':_0x2ec8de[_0x11ffac(0x13d)],'final':!![]}});}catch(_0x52ee6b){_0x5a243f(_0x52ee6b);}},this[_0x350c99(0xee)]=new paymentService_1[(_0x350c99(0x132))](),this[_0x350c99(0x105)]=new mastercardService_1[(_0x350c99(0x130))](),this[_0x350c99(0xe2)]=new webhookService_1[(_0x350c99(0xdf))]();}async['sendShopWebhook'](_0x260565,_0x173ac1,_0x21ee20){const _0x4b63f5=a8_0x460c7f,_0x4c1aef=Date['now']();try{const _0x29057e=_0x260565['shop'],_0x58e909=_0x29057e[_0x4b63f5(0x11c)];if(!_0x58e909?.[_0x4b63f5(0x137)]){console[_0x4b63f5(0x123)](_0x4b63f5(0x139)+_0x29057e['id']);return;}const _0x1b7a52=_0x173ac1===_0x4b63f5(0xff)?'payment.success':'payment.failed';let _0x12f9c7=[];if(_0x58e909['webhookEvents'])try{_0x12f9c7=Array[_0x4b63f5(0x142)](_0x58e909['webhookEvents'])?_0x58e909[_0x4b63f5(0x128)]:JSON[_0x4b63f5(0xfe)](_0x58e909[_0x4b63f5(0x128)]);}catch(_0x2264b6){console[_0x4b63f5(0x104)](_0x4b63f5(0x109),_0x2264b6),_0x12f9c7=[];}if(!_0x12f9c7[_0x4b63f5(0x10c)](_0x1b7a52)){console[_0x4b63f5(0x123)](_0x4b63f5(0xf5)+_0x1b7a52+'\x20not\x20enabled\x20for\x20shop\x20'+_0x29057e['id']);return;}const _0x26e412={'event':_0x1b7a52,'payment':{'id':_0x260565['id'],'order_id':_0x260565[_0x4b63f5(0xdc)],'gateway_order_id':_0x260565[_0x4b63f5(0xe0)],'gateway':_0x4b63f5(0x10a),'amount':_0x260565['amount'],'currency':_0x260565[_0x4b63f5(0x10f)],'status':_0x173ac1[_0x4b63f5(0x134)](),'customer_email':_0x260565[_0x4b63f5(0xd9)],'customer_name':_0x260565['customerName'],'gateway_payment_id':_0x21ee20,'created_at':_0x260565[_0x4b63f5(0xe9)],'updated_at':new Date()}},_0x19304c=await fetch(_0x58e909[_0x4b63f5(0x137)],{'method':_0x4b63f5(0x102),'headers':{'Content-Type':_0x4b63f5(0x11d),'User-Agent':_0x4b63f5(0x114)},'body':JSON[_0x4b63f5(0x118)](_0x26e412)}),_0x5879cd=Date[_0x4b63f5(0xed)]()-_0x4c1aef;console[_0x4b63f5(0x123)](_0x4b63f5(0x121)+_0x58e909[_0x4b63f5(0x137)]+_0x4b63f5(0x11b)+_0x19304c[_0x4b63f5(0x107)]+'\x20('+_0x5879cd+_0x4b63f5(0x11a));}catch(_0x62f407){console[_0x4b63f5(0x104)](_0x4b63f5(0x129),_0x62f407);}}async[a8_0x460c7f(0xf1)](_0x446d48,_0x3c7e31){const _0x5ee4fb=a8_0x460c7f;try{const {telegramBotService:_0x49ba75}=await Promise[_0x5ee4fb(0x11e)]()[_0x5ee4fb(0x10d)](()=>__importStar(require(_0x5ee4fb(0x13a)))),_0x45e377={'PAID':'paid','FAILED':'failed'},_0x381213=_0x45e377[_0x3c7e31];if(!_0x381213)return;await _0x49ba75[_0x5ee4fb(0x116)](_0x446d48[_0x5ee4fb(0x10e)],_0x446d48,_0x381213);}catch(_0x5dd0fb){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x5dd0fb);}}}function a8_0x5254(){const _0x1163fc=['ms)','\x20with\x20status\x20','settings','application/json','resolve','successUrl','user','MasterCard\x20webhook\x20sent\x20to\x20','hasOwnProperty','log','payment','processCardPayment','Payment\x20processed\x20successfully','../services/webhookService','webhookEvents','Failed\x20to\x20send\x20MasterCard\x20webhook:','update','paymentMethod','PaymentController','prototype','getPaymentStatus','5984284nhUdGd','MasterCardService','json','PaymentService','getPaymentById','toLowerCase','final','__importStar','webhookUrl','updatedAt','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/telegramBotService','mastercard_','698053YrMurm','failUrl','3828882MOWZqZ','default','Payment\x20not\x20found','webhookLog','isArray','165LtZWrG','failureMessage',',\x20shop:\x20','28602912OIMcFa','call','154572QLMupP','getOwnPropertyDescriptor','system','\x20processed:\x20','updatePaymentCustomer','customerEmail','__createBinding','Payment\x20created\x20successfully','orderId','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','defineProperty','WebhookService','gatewayOrderId','toISOString','webhookService','gateway_payment_id','params','__setModuleDefault','Unauthorized','threeds_url','../services/paymentService','createdAt','writable','amount','processMasterCardPayment','now','paymentService','💳\x20MasterCard\x20result:','customerIp','sendPaymentStatusNotification','create','Card\x20payment\x20failed','✅\x20MasterCard\x20payment\x20','Webhook\x20event\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Payment\x20status\x20is\x20','PENDING','createPublicPayment','1320949SKjDQu','Customer\x20data\x20updated\x20successfully','656390UbKWiK','mastercard','parse','PAID','FAILED','gatewayPaymentId','POST','getOwnPropertyNames','error','masterCardService','requires_3ds','status','gateway','Error\x20parsing\x20webhook\x20events:','1111','get','includes','then','shopId','currency','sendShopWebhook','__esModule',',\x20cannot\x20process','body','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20failed','sendPaymentNotification','customerCountry','stringify','3DS\x20verification\x20required'];a8_0x5254=function(){return _0x1163fc;};return a8_0x5254();}function a8_0x9223(_0x1cf5a6,_0x4fa6f8){const _0x525401=a8_0x5254();return a8_0x9223=function(_0x92233f,_0x1bd681){_0x92233f=_0x92233f-0xd5;let _0x288f1f=_0x525401[_0x92233f];return _0x288f1f;},a8_0x9223(_0x1cf5a6,_0x4fa6f8);}exports['PaymentController']=PaymentController;