'use strict';const a8_0x2376c0=a8_0x4809;(function(_0x23d956,_0x4106a9){const _0xce1db0=a8_0x4809,_0x139637=_0x23d956();while(!![]){try{const _0x40698b=-parseInt(_0xce1db0(0x1c9))/0x1*(parseInt(_0xce1db0(0x1ad))/0x2)+-parseInt(_0xce1db0(0x1b3))/0x3+parseInt(_0xce1db0(0x1b7))/0x4+parseInt(_0xce1db0(0x198))/0x5+-parseInt(_0xce1db0(0x185))/0x6*(-parseInt(_0xce1db0(0x174))/0x7)+-parseInt(_0xce1db0(0x191))/0x8*(parseInt(_0xce1db0(0x1bd))/0x9)+parseInt(_0xce1db0(0x1cc))/0xa;if(_0x40698b===_0x4106a9)break;else _0x139637['push'](_0x139637['shift']());}catch(_0x5d88f6){_0x139637['push'](_0x139637['shift']());}}}(a8_0x4686,0xebc9f));var __createBinding=this&&this[a8_0x2376c0(0x1a2)]||(Object[a8_0x2376c0(0x18b)]?function(_0x492f26,_0x3b2945,_0x576ed1,_0x3d7181){const _0x367d3b=a8_0x2376c0;if(_0x3d7181===undefined)_0x3d7181=_0x576ed1;var _0x3d0d31=Object['getOwnPropertyDescriptor'](_0x3b2945,_0x576ed1);(!_0x3d0d31||(_0x367d3b(0x1a8)in _0x3d0d31?!_0x3b2945[_0x367d3b(0x18f)]:_0x3d0d31[_0x367d3b(0x199)]||_0x3d0d31[_0x367d3b(0x177)]))&&(_0x3d0d31={'enumerable':!![],'get':function(){return _0x3b2945[_0x576ed1];}}),Object[_0x367d3b(0x1b2)](_0x492f26,_0x3d7181,_0x3d0d31);}:function(_0x1528f7,_0x54a312,_0x4fb818,_0x556b01){if(_0x556b01===undefined)_0x556b01=_0x4fb818;_0x1528f7[_0x556b01]=_0x54a312[_0x4fb818];}),__setModuleDefault=this&&this[a8_0x2376c0(0x1bf)]||(Object[a8_0x2376c0(0x18b)]?function(_0x1e8d43,_0xa55d0d){const _0x34ea05=a8_0x2376c0;Object[_0x34ea05(0x1b2)](_0x1e8d43,_0x34ea05(0x16f),{'enumerable':!![],'value':_0xa55d0d});}:function(_0x32ec20,_0x325e80){const _0x2954d8=a8_0x2376c0;_0x32ec20[_0x2954d8(0x16f)]=_0x325e80;}),__importStar=this&&this['__importStar']||(function(){var _0x4ce1e9=function(_0x297eec){return _0x4ce1e9=Object['getOwnPropertyNames']||function(_0x54c23a){const _0x5d0ff5=a8_0x4809;var _0x370e11=[];for(var _0x360c17 in _0x54c23a)if(Object[_0x5d0ff5(0x183)][_0x5d0ff5(0x1c2)]['call'](_0x54c23a,_0x360c17))_0x370e11[_0x370e11['length']]=_0x360c17;return _0x370e11;},_0x4ce1e9(_0x297eec);};return function(_0x5e0699){const _0x54e3a7=a8_0x4809;if(_0x5e0699&&_0x5e0699['__esModule'])return _0x5e0699;var _0x13bb3a={};if(_0x5e0699!=null){for(var _0x47083d=_0x4ce1e9(_0x5e0699),_0x1c1515=0x0;_0x1c1515<_0x47083d[_0x54e3a7(0x18a)];_0x1c1515++)if(_0x47083d[_0x1c1515]!==_0x54e3a7(0x16f))__createBinding(_0x13bb3a,_0x5e0699,_0x47083d[_0x1c1515]);}return __setModuleDefault(_0x13bb3a,_0x5e0699),_0x13bb3a;};}()),__importDefault=this&&this[a8_0x2376c0(0x16a)]||function(_0x300681){const _0x24ea68=a8_0x2376c0;return _0x300681&&_0x300681[_0x24ea68(0x18f)]?_0x300681:{'default':_0x300681};};Object[a8_0x2376c0(0x1b2)](exports,a8_0x2376c0(0x18f),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x2376c0(0x19d)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x2376c0(0x1ba)),database_1=__importDefault(require(a8_0x2376c0(0x1b6)));function a8_0x4809(_0x3f9f9a,_0x40afc3){const _0x468667=a8_0x4686();return a8_0x4809=function(_0x48095f,_0x56747d){_0x48095f=_0x48095f-0x169;let _0x2bce07=_0x468667[_0x48095f];return _0x2bce07;},a8_0x4809(_0x3f9f9a,_0x40afc3);}class PaymentController{constructor(){const _0x587c10=a8_0x2376c0;this[_0x587c10(0x1d3)]=async(_0x41620b,_0x4895ed,_0x14937c)=>{const _0x30b7ba=_0x587c10;try{const _0x599be0=_0x41620b[_0x30b7ba(0x1d6)],_0x2c06a6=await this[_0x30b7ba(0x1a6)][_0x30b7ba(0x1d3)](_0x599be0);_0x4895ed[_0x30b7ba(0x1d8)](0xc9)[_0x30b7ba(0x16e)]({'success':!![],'message':_0x30b7ba(0x1c6),'result':_0x2c06a6});}catch(_0x29d74d){_0x14937c(_0x29d74d);}},this[_0x587c10(0x1b5)]=async(_0x103791,_0x1c657b,_0x31b55f)=>{const _0x5517f1=_0x587c10;try{const {id:_0xde09d2}=_0x103791[_0x5517f1(0x1aa)],_0x30c5e9=await this['paymentService'][_0x5517f1(0x1b5)](_0xde09d2);if(!_0x30c5e9)return _0x1c657b[_0x5517f1(0x1d8)](0x194)[_0x5517f1(0x16e)]({'success':![],'message':_0x5517f1(0x188)});_0x1c657b[_0x5517f1(0x16e)]({'success':!![],'result':_0x30c5e9});}catch(_0x4289ba){_0x31b55f(_0x4289ba);}},this[_0x587c10(0x1c1)]=async(_0x439d30,_0x5e21ca,_0x3e951b)=>{const _0x57ced0=_0x587c10;try{const {id:_0x41c07c}=_0x439d30[_0x57ced0(0x1aa)],_0x2c8b3d=await this[_0x57ced0(0x1a6)][_0x57ced0(0x1c1)](_0x41c07c);if(!_0x2c8b3d)return _0x5e21ca['status'](0x194)[_0x57ced0(0x16e)]({'success':![],'message':_0x57ced0(0x188)});_0x5e21ca[_0x57ced0(0x16e)]({'success':!![],'result':_0x2c8b3d});}catch(_0x5ce798){_0x3e951b(_0x5ce798);}},this[_0x587c10(0x195)]=async(_0x10257a,_0x5c3978,_0x3e62f8)=>{const _0x44277e=_0x587c10;try{const {id:_0xfc4357}=_0x10257a[_0x44277e(0x1aa)],{cardData:_0x199035,cardHolder:_0x320223,browser:_0x54422b}=_0x10257a[_0x44277e(0x1d6)];console[_0x44277e(0x1d5)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0xfc4357);const _0x8a8f93=await database_1[_0x44277e(0x16f)]['payment'][_0x44277e(0x1ca)]({'where':{'id':_0xfc4357},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x8a8f93)return _0x5c3978[_0x44277e(0x1d8)](0x194)['json']({'success':![],'message':_0x44277e(0x188)});if(_0x8a8f93[_0x44277e(0x1a1)]!==_0x44277e(0x19f))return _0x5c3978[_0x44277e(0x1d8)](0x190)[_0x44277e(0x16e)]({'success':![],'message':_0x44277e(0x16d)});if(_0x8a8f93[_0x44277e(0x1d8)]!=='PENDING')return _0x5c3978[_0x44277e(0x1d8)](0x190)[_0x44277e(0x16e)]({'success':![],'message':_0x44277e(0x1ac)+_0x8a8f93[_0x44277e(0x1d8)]+',\x20cannot\x20process'});const _0x2a8777=_0x44277e(0x16c),_0x523f6f=_0x8a8f93['successUrl'];console[_0x44277e(0x1d5)](_0x44277e(0x1d4)),console[_0x44277e(0x1d5)](_0x44277e(0x187)+_0x2a8777),console[_0x44277e(0x1d5)](_0x44277e(0x196)+_0x523f6f);const _0x570ab2=await this[_0x44277e(0x1c3)][_0x44277e(0x169)]({'paymentId':_0x8a8f93['id'],'orderId':_0x8a8f93[_0x44277e(0x171)]||_0x8a8f93['id'],'amount':_0x8a8f93[_0x44277e(0x17f)],'currency':_0x8a8f93[_0x44277e(0x17e)],'cardData':_0x199035,'resultUrl':_0x2a8777,'returnUrl':_0x523f6f,'cardHolder':_0x320223,'browser':_0x54422b});console['log']('ðŸ’³\x20MasterCard\x20result:',_0x570ab2);const _0x41a582={'status':_0x570ab2['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x570ab2['status']==='PAID')_0x41a582['paidAt']=new Date(),_0x41a582[_0x44277e(0x1b9)]=_0x570ab2[_0x44277e(0x176)];else _0x570ab2[_0x44277e(0x1d8)]===_0x44277e(0x19e)&&(_0x41a582[_0x44277e(0x1ce)]=_0x44277e(0x175));_0x41a582['paymentMethod']=_0x44277e(0x19f),await database_1['default']['payment'][_0x44277e(0x1a4)]({'where':{'id':_0x8a8f93['id']},'data':_0x41a582}),await database_1['default'][_0x44277e(0x180)][_0x44277e(0x18b)]({'data':{'paymentId':_0x8a8f93['id'],'shopId':_0x8a8f93[_0x44277e(0x173)],'event':'mastercard_'+_0x570ab2[_0x44277e(0x1d8)]?.[_0x44277e(0x186)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x44277e(0x1bb),'newStatus':_0x570ab2[_0x44277e(0x1d8)],'gatewayPaymentId':_0x570ab2[_0x44277e(0x176)],'requires3ds':_0x570ab2['requires_3ds'],'processedAt':new Date()[_0x44277e(0x1af)]()})}});_0x570ab2[_0x44277e(0x17c)]&&(await this[_0x44277e(0x189)](_0x8a8f93,_0x570ab2['status'],_0x570ab2[_0x44277e(0x176)]),await this['sendPaymentStatusNotification'](_0x8a8f93,_0x570ab2[_0x44277e(0x1d8)]));console[_0x44277e(0x1d5)](_0x44277e(0x197)+_0xfc4357+_0x44277e(0x178)+_0x570ab2[_0x44277e(0x1d8)]);if(_0x570ab2[_0x44277e(0x1d8)]===_0x44277e(0x1da))_0x5c3978[_0x44277e(0x16e)]({'success':!![],'message':_0x44277e(0x18e),'result':{'status':'PAID','gatewayPaymentId':_0x570ab2[_0x44277e(0x176)],'redirectUrl':_0x523f6f,'final':!![]}});else _0x570ab2[_0x44277e(0x18c)]&&_0x570ab2[_0x44277e(0x181)]?_0x5c3978[_0x44277e(0x16e)]({'success':!![],'message':_0x44277e(0x1c0),'result':{'status':_0x44277e(0x1bb),'gatewayPaymentId':_0x570ab2[_0x44277e(0x176)],'redirectUrl':_0x570ab2[_0x44277e(0x181)],'requires3ds':!![],'final':![]}}):_0x5c3978['status'](0x190)[_0x44277e(0x16e)]({'success':![],'message':_0x44277e(0x1a7),'result':{'status':_0x44277e(0x19e),'gatewayPaymentId':_0x570ab2['gateway_payment_id'],'redirectUrl':_0x8a8f93[_0x44277e(0x1ab)],'final':!![]}});}catch(_0x294419){_0x3e62f8(_0x294419);}},this[_0x587c10(0x19b)]=async(_0x25a3f9,_0x5c32b6,_0x3bc80e)=>{const _0x165aa2=_0x587c10;try{const {id:_0x291c23}=_0x25a3f9[_0x165aa2(0x1aa)],{customerIp:_0x57629e,customerUa:_0x42d438,customerCountry:_0x558097}=_0x25a3f9['body'],_0x4acd5b=await database_1[_0x165aa2(0x16f)][_0x165aa2(0x1dd)][_0x165aa2(0x1ca)]({'where':{'id':_0x291c23},'select':{'id':!![],'status':!![]}});if(!_0x4acd5b)return _0x5c32b6[_0x165aa2(0x1d8)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});const _0x41b6fa=await database_1[_0x165aa2(0x16f)][_0x165aa2(0x1dd)][_0x165aa2(0x1a4)]({'where':{'id':_0x291c23},'data':{'customerIp':_0x57629e||undefined,'customerUa':_0x42d438||undefined,'customerCountry':_0x558097||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x165aa2(0x1d5)](_0x165aa2(0x1d9)+_0x291c23+':',{'customerIp':_0x57629e||'not\x20provided','customerUa':_0x42d438?_0x42d438[_0x165aa2(0x1c7)](0x0,0x32)+'...':_0x165aa2(0x1d1),'customerCountry':_0x558097||_0x165aa2(0x1d1)}),_0x5c32b6[_0x165aa2(0x16e)]({'success':!![],'message':_0x165aa2(0x17a),'result':_0x41b6fa});}catch(_0x53dd53){_0x3bc80e(_0x53dd53);}},this[_0x587c10(0x1a6)]=new paymentService_1[(_0x587c10(0x1c5))](),this[_0x587c10(0x1c3)]=new mastercardService_1[(_0x587c10(0x17d))](),this[_0x587c10(0x18d)]=new webhookService_1['WebhookService']();}async[a8_0x2376c0(0x189)](_0x324567,_0x5b8fdc,_0xf07b1d){const _0x1be541=a8_0x2376c0,_0xaec388=Date[_0x1be541(0x1d2)]();try{const _0x105ab0=_0x324567['shop'],_0x1ec01b=_0x105ab0[_0x1be541(0x1db)];if(!_0x1ec01b?.['webhookUrl']){console[_0x1be541(0x1d5)](_0x1be541(0x179)+_0x105ab0['id']);return;}const _0x2c3db4=_0x5b8fdc===_0x1be541(0x1da)?_0x1be541(0x16b):_0x1be541(0x1cd);let _0x8fd556=[];if(_0x1ec01b[_0x1be541(0x190)])try{_0x8fd556=Array[_0x1be541(0x194)](_0x1ec01b[_0x1be541(0x190)])?_0x1ec01b[_0x1be541(0x190)]:JSON[_0x1be541(0x1b1)](_0x1ec01b['webhookEvents']);}catch(_0x1b5610){console[_0x1be541(0x193)](_0x1be541(0x1d0),_0x1b5610),_0x8fd556=[];}if(!_0x8fd556[_0x1be541(0x1c4)](_0x2c3db4)){console['log'](_0x1be541(0x182)+_0x2c3db4+_0x1be541(0x1dc)+_0x105ab0['id']);return;}const _0x313ce7={'event':_0x2c3db4,'payment':{'id':_0x324567['id'],'order_id':_0x324567[_0x1be541(0x1b0)],'gateway_order_id':_0x324567[_0x1be541(0x171)],'gateway':_0x1be541(0x170),'amount':_0x324567['amount'],'currency':_0x324567[_0x1be541(0x17e)],'status':_0x5b8fdc['toLowerCase'](),'customer_email':_0x324567[_0x1be541(0x1cb)],'customer_name':_0x324567[_0x1be541(0x1c8)],'gateway_payment_id':_0xf07b1d,'created_at':_0x324567[_0x1be541(0x184)],'updated_at':new Date()}},_0x5a8cbc=await fetch(_0x1ec01b[_0x1be541(0x1b4)],{'method':_0x1be541(0x1a5),'headers':{'Content-Type':_0x1be541(0x172),'User-Agent':_0x1be541(0x1cf)},'body':JSON[_0x1be541(0x1a3)](_0x313ce7)}),_0x429716=Date[_0x1be541(0x1d2)]()-_0xaec388;console[_0x1be541(0x1d5)](_0x1be541(0x1ae)+_0x1ec01b[_0x1be541(0x1b4)]+_0x1be541(0x1d7)+_0x5a8cbc['status']+'\x20('+_0x429716+_0x1be541(0x19a));}catch(_0x352e4a){console[_0x1be541(0x193)](_0x1be541(0x19c),_0x352e4a);}}async[a8_0x2376c0(0x1b8)](_0x4818a8,_0x88327c){const _0x4b3a3e=a8_0x2376c0;try{const {telegramBotService:_0x4b07c7}=await Promise[_0x4b3a3e(0x1a0)]()[_0x4b3a3e(0x1bc)](()=>__importStar(require(_0x4b3a3e(0x17b)))),_0x3ee637={'PAID':_0x4b3a3e(0x192),'FAILED':_0x4b3a3e(0x1de)},_0x5c60c4=_0x3ee637[_0x88327c];if(!_0x5c60c4)return;await _0x4b07c7[_0x4b3a3e(0x1be)](_0x4818a8[_0x4b3a3e(0x173)],_0x4818a8,_0x5c60c4);}catch(_0x8ca187){console[_0x4b3a3e(0x193)](_0x4b3a3e(0x1a9),_0x8ca187);}}}exports['PaymentController']=PaymentController;function a8_0x4686(){const _0x2c4477=['now','createPublicPayment','ðŸ’³\x20MasterCard\x20URLs:','log','body','\x20with\x20status\x20','status','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','PAID','settings','\x20not\x20enabled\x20for\x20shop\x20','payment','failed','processCardPayment','__importDefault','payment.success','https://api.trapay.uk/api/webhooks/gateway/mastercard','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','json','default','1111','gatewayOrderId','application/json','shopId','3815qObXvs','Card\x20payment\x20failed','gateway_payment_id','configurable','\x20processed:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Customer\x20data\x20updated\x20successfully','../services/telegramBotService','final','MasterCardService','currency','amount','webhookLog','threeds_url','Webhook\x20event\x20','prototype','createdAt','3102qRHwRG','toLowerCase','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Payment\x20not\x20found','sendShopWebhook','length','create','requires_3ds','webhookService','Payment\x20processed\x20successfully','__esModule','webhookEvents','184iIFACr','paid','error','isArray','processMasterCardPayment','\x20\x20\x20Return\x20URL:\x20','âœ…\x20MasterCard\x20payment\x20','3684160VYNbOv','writable','ms)','updateCustomerData','Failed\x20to\x20send\x20MasterCard\x20webhook:','../services/paymentService','FAILED','mastercard','resolve','gateway','__createBinding','stringify','update','POST','paymentService','Payment\x20failed','get','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','params','failUrl','Payment\x20status\x20is\x20','2lNQlSl','MasterCard\x20webhook\x20sent\x20to\x20','toISOString','orderId','parse','defineProperty','3139758lRbPXg','webhookUrl','getPaymentStatus','../config/database','5847524vUgbux','sendPaymentStatusNotification','gatewayPaymentId','../services/webhookService','PENDING','then','316053uJkLOw','sendPaymentNotification','__setModuleDefault','3DS\x20verification\x20required','getPaymentById','hasOwnProperty','masterCardService','includes','PaymentService','Payment\x20created\x20successfully','substring','customerName','1147579WqqPkG','findUnique','customerEmail','14871690WOYzKv','payment.failed','failureMessage','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Error\x20parsing\x20webhook\x20events:','not\x20provided'];a8_0x4686=function(){return _0x2c4477;};return a8_0x4686();}