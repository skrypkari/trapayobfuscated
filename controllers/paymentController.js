'use strict';const a8_0xd065ce=a8_0x536f;function a8_0x536f(_0x109861,_0x5235e5){const _0x55199f=a8_0x5519();return a8_0x536f=function(_0x536f0b,_0x482ce5){_0x536f0b=_0x536f0b-0x1d7;let _0x454211=_0x55199f[_0x536f0b];return _0x454211;},a8_0x536f(_0x109861,_0x5235e5);}(function(_0x382ca2,_0xa00135){const _0x2078ef=a8_0x536f,_0x190f15=_0x382ca2();while(!![]){try{const _0x5b9c27=-parseInt(_0x2078ef(0x242))/0x1+parseInt(_0x2078ef(0x247))/0x2+-parseInt(_0x2078ef(0x1fb))/0x3+-parseInt(_0x2078ef(0x202))/0x4*(parseInt(_0x2078ef(0x227))/0x5)+parseInt(_0x2078ef(0x211))/0x6+parseInt(_0x2078ef(0x233))/0x7*(parseInt(_0x2078ef(0x228))/0x8)+parseInt(_0x2078ef(0x209))/0x9*(-parseInt(_0x2078ef(0x229))/0xa);if(_0x5b9c27===_0xa00135)break;else _0x190f15['push'](_0x190f15['shift']());}catch(_0x540b4c){_0x190f15['push'](_0x190f15['shift']());}}}(a8_0x5519,0x2f3e3));function a8_0x5519(){const _0x33a425=['Webhook\x20event\x20','configurable','failureMessage','updatePaymentCustomerDataPublic','status','default','body','failed','462065RrRJtE','16YhJliz','10WEVltu','üí≥\x20Processing\x20MasterCard\x20payment:\x20','Card\x20payment\x20failed','MasterCard\x20webhook\x20sent\x20to\x20','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','paymentService','Payment\x20created\x20successfully','writable','Payment\x20failed','paidAt','894047UiUQfa','üìù\x20Customer\x20data:','../services/gateways/mastercardService','MasterCardService','__createBinding','sendPaymentStatusNotification','PaymentController','now','findUnique','gatewayOrderId','updatedAt','../services/telegramBotService','requires_3ds','webhookEvents','createPublicPayment','185062PFmGZS','PAID','masterCardService','update','webhookUrl','333446CewKaW','Payment\x20not\x20found','ms)','customerIp','customerName','includes','\x20\x20\x20Return\x20URL:\x20','successUrl','parse','webhookService','payment.failed','log','PENDING','sendPaymentNotification','error','WebhookService','sendShopWebhook','customerUa','create','customerEmail','payment.success','\x20processed:\x20','mastercard','application/json','\x20not\x20enabled\x20for\x20shop\x20','gatewayPaymentId','üí≥\x20MasterCard\x20URLs:','length','PaymentService','../services/paymentService','customerCountry','getPaymentStatus','üí≥\x20MasterCard\x20result:','hasOwnProperty','\x20with\x20status\x20','json','__setModuleDefault','shopId','28179vljgYy','FAILED','defineProperty','then','paymentMethod','createdAt','__importDefault','12FFLJVo','params','shop','system','getOwnPropertyNames','stringify','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','270153FuOOfX','processCardPayment','Customer\x20data\x20updated\x20successfully','threeds_url','\x20\x20\x20Result\x20URL\x20(webhook):\x20','gateway_payment_id','failUrl','../config/database','1638318YMPJCQ','prototype','mastercard_','orderId','amount','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','toISOString',',\x20cannot\x20process','currency','__esModule','final','../services/webhookService','toLowerCase'];a8_0x5519=function(){return _0x33a425;};return a8_0x5519();}var __createBinding=this&&this[a8_0xd065ce(0x237)]||(Object[a8_0xd065ce(0x1e7)]?function(_0x4d5b0f,_0x3d0ba5,_0x3cbe51,_0x58cc9b){const _0x14f547=a8_0xd065ce;if(_0x58cc9b===undefined)_0x58cc9b=_0x3cbe51;var _0x54953d=Object['getOwnPropertyDescriptor'](_0x3d0ba5,_0x3cbe51);(!_0x54953d||('get'in _0x54953d?!_0x3d0ba5[_0x14f547(0x21b)]:_0x54953d[_0x14f547(0x230)]||_0x54953d[_0x14f547(0x220)]))&&(_0x54953d={'enumerable':!![],'get':function(){return _0x3d0ba5[_0x3cbe51];}}),Object[_0x14f547(0x1fd)](_0x4d5b0f,_0x58cc9b,_0x54953d);}:function(_0x4ce5db,_0x524c34,_0x3ac732,_0x283ac8){if(_0x283ac8===undefined)_0x283ac8=_0x3ac732;_0x4ce5db[_0x283ac8]=_0x524c34[_0x3ac732];}),__setModuleDefault=this&&this[a8_0xd065ce(0x1f9)]||(Object['create']?function(_0x5b3e1f,_0x2b0f91){const _0x13b806=a8_0xd065ce;Object[_0x13b806(0x1fd)](_0x5b3e1f,_0x13b806(0x224),{'enumerable':!![],'value':_0x2b0f91});}:function(_0x542ca3,_0x5d3c0f){_0x542ca3['default']=_0x5d3c0f;}),__importStar=this&&this['__importStar']||(function(){var _0xc6361c=function(_0x4530de){const _0x30d2e1=a8_0x536f;return _0xc6361c=Object[_0x30d2e1(0x206)]||function(_0x392ebb){const _0x4165ff=_0x30d2e1;var _0x191752=[];for(var _0x142f40 in _0x392ebb)if(Object[_0x4165ff(0x212)][_0x4165ff(0x1f6)]['call'](_0x392ebb,_0x142f40))_0x191752[_0x191752[_0x4165ff(0x1f0)]]=_0x142f40;return _0x191752;},_0xc6361c(_0x4530de);};return function(_0x443885){const _0x38c498=a8_0x536f;if(_0x443885&&_0x443885['__esModule'])return _0x443885;var _0x1baf3b={};if(_0x443885!=null){for(var _0x3bd959=_0xc6361c(_0x443885),_0x4bb36b=0x0;_0x4bb36b<_0x3bd959[_0x38c498(0x1f0)];_0x4bb36b++)if(_0x3bd959[_0x4bb36b]!==_0x38c498(0x224))__createBinding(_0x1baf3b,_0x443885,_0x3bd959[_0x4bb36b]);}return __setModuleDefault(_0x1baf3b,_0x443885),_0x1baf3b;};}()),__importDefault=this&&this[a8_0xd065ce(0x201)]||function(_0x458cdf){const _0x4f92eb=a8_0xd065ce;return _0x458cdf&&_0x458cdf[_0x4f92eb(0x21b)]?_0x458cdf:{'default':_0x458cdf};};Object[a8_0xd065ce(0x1fd)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0xd065ce(0x1f2)),mastercardService_1=require(a8_0xd065ce(0x235)),webhookService_1=require(a8_0xd065ce(0x21d)),database_1=__importDefault(require(a8_0xd065ce(0x210)));class PaymentController{constructor(){const _0x2c8d12=a8_0xd065ce;this[_0x2c8d12(0x241)]=async(_0x379082,_0x3e319a,_0x299717)=>{const _0x48ed03=_0x2c8d12;try{const _0x245ecd=_0x379082['body'],_0x31882b=await this[_0x48ed03(0x22e)]['createPublicPayment'](_0x245ecd);_0x3e319a[_0x48ed03(0x223)](0xc9)['json']({'success':!![],'message':_0x48ed03(0x22f),'result':_0x31882b});}catch(_0x12de2d){_0x299717(_0x12de2d);}},this[_0x2c8d12(0x1f4)]=async(_0x1e6668,_0x4de56a,_0x1f7205)=>{const _0x17efd4=_0x2c8d12;try{const {id:_0x2ed742}=_0x1e6668[_0x17efd4(0x203)],_0x5de4ee=await this[_0x17efd4(0x22e)][_0x17efd4(0x1f4)](_0x2ed742);if(!_0x5de4ee)return _0x4de56a['status'](0x194)[_0x17efd4(0x1f8)]({'success':![],'message':_0x17efd4(0x248)});_0x4de56a[_0x17efd4(0x1f8)]({'success':!![],'result':_0x5de4ee});}catch(_0x45e494){_0x1f7205(_0x45e494);}},this['getPaymentById']=async(_0x2d2ca3,_0x3d1d2f,_0x20b679)=>{const _0x677a3a=_0x2c8d12;try{const {id:_0x3a4154}=_0x2d2ca3[_0x677a3a(0x203)],_0xb83522=await this[_0x677a3a(0x22e)]['getPaymentById'](_0x3a4154);if(!_0xb83522)return _0x3d1d2f[_0x677a3a(0x223)](0x194)[_0x677a3a(0x1f8)]({'success':![],'message':_0x677a3a(0x248)});_0x3d1d2f['json']({'success':!![],'result':_0xb83522});}catch(_0x10ae96){_0x20b679(_0x10ae96);}},this['updatePaymentCustomer']=async(_0x3c6738,_0x101ed3,_0x31ef0d)=>{const _0xa7e6d9=_0x2c8d12;try{const {id:_0x46ebd0}=_0x3c6738[_0xa7e6d9(0x203)],_0x1fac20=_0x3c6738[_0xa7e6d9(0x225)];console['log'](_0xa7e6d9(0x22d)+_0x46ebd0),console[_0xa7e6d9(0x1e0)](_0xa7e6d9(0x234),_0x1fac20);const _0x466e8e=await this[_0xa7e6d9(0x22e)][_0xa7e6d9(0x222)](_0x46ebd0,_0x1fac20);if(!_0x466e8e)return _0x101ed3['status'](0x194)['json']({'success':![],'message':_0xa7e6d9(0x248)});_0x101ed3['json']({'success':!![],'message':_0xa7e6d9(0x20b),'result':{'paymentId':_0x466e8e['id'],'customerIp':_0x466e8e[_0xa7e6d9(0x1d8)],'customerUa':_0x466e8e[_0xa7e6d9(0x1e6)],'customerCountry':_0x466e8e[_0xa7e6d9(0x1f3)],'updatedAt':_0x466e8e[_0xa7e6d9(0x23d)]}});}catch(_0x41788e){_0x31ef0d(_0x41788e);}},this['processMasterCardPayment']=async(_0x4e1e92,_0x1248b8,_0x314a51)=>{const _0x43da91=_0x2c8d12;try{const {id:_0xcf560f}=_0x4e1e92[_0x43da91(0x203)],{cardData:_0x6da037,cardHolder:_0x2f888f,browser:_0x2936f8}=_0x4e1e92['body'];console[_0x43da91(0x1e0)](_0x43da91(0x22a)+_0xcf560f);const _0x191faa=await database_1['default']['payment'][_0x43da91(0x23b)]({'where':{'id':_0xcf560f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x191faa)return _0x1248b8['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x191faa['gateway']!=='mastercard')return _0x1248b8[_0x43da91(0x223)](0x190)['json']({'success':![],'message':_0x43da91(0x216)});if(_0x191faa[_0x43da91(0x223)]!==_0x43da91(0x1e1))return _0x1248b8[_0x43da91(0x223)](0x190)[_0x43da91(0x1f8)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x191faa[_0x43da91(0x223)]+_0x43da91(0x219)});const _0x3ba7c9='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x11bdbb=_0x191faa[_0x43da91(0x1dc)];console[_0x43da91(0x1e0)](_0x43da91(0x1ef)),console[_0x43da91(0x1e0)](_0x43da91(0x20d)+_0x3ba7c9),console[_0x43da91(0x1e0)](_0x43da91(0x1db)+_0x11bdbb);const _0x4eced2=await this[_0x43da91(0x244)][_0x43da91(0x20a)]({'paymentId':_0x191faa['id'],'orderId':_0x191faa[_0x43da91(0x23c)]||_0x191faa['id'],'amount':_0x191faa['amount'],'currency':_0x191faa[_0x43da91(0x21a)],'cardData':_0x6da037,'resultUrl':_0x3ba7c9,'returnUrl':_0x11bdbb,'cardHolder':_0x2f888f,'browser':_0x2936f8});console[_0x43da91(0x1e0)](_0x43da91(0x1f5),_0x4eced2);const _0x112d7d={'status':_0x4eced2[_0x43da91(0x223)],'updatedAt':new Date(),'statusChangedBy':_0x43da91(0x205),'statusChangedAt':new Date()};if(_0x4eced2[_0x43da91(0x223)]===_0x43da91(0x243))_0x112d7d[_0x43da91(0x232)]=new Date(),_0x112d7d[_0x43da91(0x1ee)]=_0x4eced2[_0x43da91(0x20e)];else _0x4eced2[_0x43da91(0x223)]==='FAILED'&&(_0x112d7d[_0x43da91(0x221)]=_0x43da91(0x22b));_0x112d7d[_0x43da91(0x1ff)]=_0x43da91(0x1eb),await database_1['default']['payment'][_0x43da91(0x245)]({'where':{'id':_0x191faa['id']},'data':_0x112d7d}),await database_1[_0x43da91(0x224)]['webhookLog'][_0x43da91(0x1e7)]({'data':{'paymentId':_0x191faa['id'],'shopId':_0x191faa[_0x43da91(0x1fa)],'event':_0x43da91(0x213)+_0x4eced2[_0x43da91(0x223)]?.[_0x43da91(0x21e)](),'statusCode':0xc8,'responseBody':JSON[_0x43da91(0x207)]({'oldStatus':_0x43da91(0x1e1),'newStatus':_0x4eced2[_0x43da91(0x223)],'gatewayPaymentId':_0x4eced2['gateway_payment_id'],'requires3ds':_0x4eced2[_0x43da91(0x23f)],'processedAt':new Date()[_0x43da91(0x218)]()})}});_0x4eced2[_0x43da91(0x21c)]&&(await this[_0x43da91(0x1e5)](_0x191faa,_0x4eced2[_0x43da91(0x223)],_0x4eced2[_0x43da91(0x20e)]),await this[_0x43da91(0x238)](_0x191faa,_0x4eced2[_0x43da91(0x223)]));console['log']('‚úÖ\x20MasterCard\x20payment\x20'+_0xcf560f+_0x43da91(0x1ea)+_0x4eced2[_0x43da91(0x223)]);if(_0x4eced2['status']===_0x43da91(0x243))_0x1248b8['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x43da91(0x243),'gatewayPaymentId':_0x4eced2[_0x43da91(0x20e)],'redirectUrl':_0x11bdbb,'final':!![]}});else _0x4eced2['requires_3ds']&&_0x4eced2[_0x43da91(0x20c)]?_0x1248b8[_0x43da91(0x1f8)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x43da91(0x1e1),'gatewayPaymentId':_0x4eced2[_0x43da91(0x20e)],'redirectUrl':_0x4eced2[_0x43da91(0x20c)],'requires3ds':!![],'final':![]}}):_0x1248b8[_0x43da91(0x223)](0x190)[_0x43da91(0x1f8)]({'success':![],'message':_0x43da91(0x231),'result':{'status':_0x43da91(0x1fc),'gatewayPaymentId':_0x4eced2[_0x43da91(0x20e)],'redirectUrl':_0x191faa[_0x43da91(0x20f)],'final':!![]}});}catch(_0x4fb4a8){_0x314a51(_0x4fb4a8);}},this[_0x2c8d12(0x22e)]=new paymentService_1[(_0x2c8d12(0x1f1))](),this[_0x2c8d12(0x244)]=new mastercardService_1[(_0x2c8d12(0x236))](),this[_0x2c8d12(0x1de)]=new webhookService_1[(_0x2c8d12(0x1e4))]();}async[a8_0xd065ce(0x1e5)](_0x2b2e2e,_0x5b134f,_0x492e42){const _0x372b6b=a8_0xd065ce,_0x3c92e3=Date[_0x372b6b(0x23a)]();try{const _0x498ba8=_0x2b2e2e[_0x372b6b(0x204)],_0x20345f=_0x498ba8['settings'];if(!_0x20345f?.[_0x372b6b(0x246)]){console['log'](_0x372b6b(0x208)+_0x498ba8['id']);return;}const _0x8a47a3=_0x5b134f===_0x372b6b(0x243)?_0x372b6b(0x1e9):_0x372b6b(0x1df);let _0x39fe18=[];if(_0x20345f['webhookEvents'])try{_0x39fe18=Array['isArray'](_0x20345f['webhookEvents'])?_0x20345f[_0x372b6b(0x240)]:JSON[_0x372b6b(0x1dd)](_0x20345f[_0x372b6b(0x240)]);}catch(_0x328c0c){console[_0x372b6b(0x1e3)]('Error\x20parsing\x20webhook\x20events:',_0x328c0c),_0x39fe18=[];}if(!_0x39fe18[_0x372b6b(0x1da)](_0x8a47a3)){console[_0x372b6b(0x1e0)](_0x372b6b(0x21f)+_0x8a47a3+_0x372b6b(0x1ed)+_0x498ba8['id']);return;}const _0x70e363={'event':_0x8a47a3,'payment':{'id':_0x2b2e2e['id'],'order_id':_0x2b2e2e[_0x372b6b(0x214)],'gateway_order_id':_0x2b2e2e[_0x372b6b(0x23c)],'gateway':'1111','amount':_0x2b2e2e[_0x372b6b(0x215)],'currency':_0x2b2e2e[_0x372b6b(0x21a)],'status':_0x5b134f[_0x372b6b(0x21e)](),'customer_email':_0x2b2e2e[_0x372b6b(0x1e8)],'customer_name':_0x2b2e2e[_0x372b6b(0x1d9)],'gateway_payment_id':_0x492e42,'created_at':_0x2b2e2e[_0x372b6b(0x200)],'updated_at':new Date()}},_0xa3ca66=await fetch(_0x20345f['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x372b6b(0x1ec),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x372b6b(0x207)](_0x70e363)}),_0x32925d=Date[_0x372b6b(0x23a)]()-_0x3c92e3;console[_0x372b6b(0x1e0)](_0x372b6b(0x22c)+_0x20345f['webhookUrl']+_0x372b6b(0x1f7)+_0xa3ca66[_0x372b6b(0x223)]+'\x20('+_0x32925d+_0x372b6b(0x1d7));}catch(_0x5a48b4){console[_0x372b6b(0x1e3)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x5a48b4);}}async[a8_0xd065ce(0x238)](_0x2daadc,_0x18cc0d){const _0x4c9926=a8_0xd065ce;try{const {telegramBotService:_0x1fe342}=await Promise['resolve']()[_0x4c9926(0x1fe)](()=>__importStar(require(_0x4c9926(0x23e)))),_0x751a6a={'PAID':'paid','FAILED':_0x4c9926(0x226)},_0x47936c=_0x751a6a[_0x18cc0d];if(!_0x47936c)return;await _0x1fe342[_0x4c9926(0x1e2)](_0x2daadc[_0x4c9926(0x1fa)],_0x2daadc,_0x47936c);}catch(_0x3a0b74){console['error'](_0x4c9926(0x217),_0x3a0b74);}}}exports[a8_0xd065ce(0x239)]=PaymentController;