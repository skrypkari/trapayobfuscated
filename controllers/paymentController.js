'use strict';const a8_0x275843=a8_0x4360;(function(_0x241677,_0x3f0cf7){const _0x54e6a3=a8_0x4360,_0x4012d5=_0x241677();while(!![]){try{const _0x293b01=-parseInt(_0x54e6a3(0x176))/0x1+-parseInt(_0x54e6a3(0x162))/0x2*(-parseInt(_0x54e6a3(0x13a))/0x3)+-parseInt(_0x54e6a3(0x102))/0x4*(-parseInt(_0x54e6a3(0x14b))/0x5)+-parseInt(_0x54e6a3(0x12f))/0x6+-parseInt(_0x54e6a3(0x12e))/0x7+-parseInt(_0x54e6a3(0x158))/0x8+parseInt(_0x54e6a3(0x137))/0x9;if(_0x293b01===_0x3f0cf7)break;else _0x4012d5['push'](_0x4012d5['shift']());}catch(_0x297076){_0x4012d5['push'](_0x4012d5['shift']());}}}(a8_0x1c28,0x60e97));var __createBinding=this&&this[a8_0x275843(0xf9)]||(Object[a8_0x275843(0x105)]?function(_0x45ec7a,_0x3f3f50,_0x16a59c,_0x3a610b){const _0x2c1830=a8_0x275843;if(_0x3a610b===undefined)_0x3a610b=_0x16a59c;var _0x3da4ad=Object['getOwnPropertyDescriptor'](_0x3f3f50,_0x16a59c);(!_0x3da4ad||(_0x2c1830(0x101)in _0x3da4ad?!_0x3f3f50[_0x2c1830(0x13e)]:_0x3da4ad[_0x2c1830(0x145)]||_0x3da4ad[_0x2c1830(0x11d)]))&&(_0x3da4ad={'enumerable':!![],'get':function(){return _0x3f3f50[_0x16a59c];}}),Object[_0x2c1830(0xff)](_0x45ec7a,_0x3a610b,_0x3da4ad);}:function(_0x2f2099,_0x82a32a,_0x43e815,_0xa3c149){if(_0xa3c149===undefined)_0xa3c149=_0x43e815;_0x2f2099[_0xa3c149]=_0x82a32a[_0x43e815];}),__setModuleDefault=this&&this[a8_0x275843(0x10c)]||(Object['create']?function(_0x6c6ee5,_0x36d3b5){const _0xe18cc9=a8_0x275843;Object[_0xe18cc9(0xff)](_0x6c6ee5,'default',{'enumerable':!![],'value':_0x36d3b5});}:function(_0x50357a,_0x45859b){const _0x1801ed=a8_0x275843;_0x50357a[_0x1801ed(0x150)]=_0x45859b;}),__importStar=this&&this[a8_0x275843(0x160)]||(function(){var _0x43051a=function(_0x5cb1df){return _0x43051a=Object['getOwnPropertyNames']||function(_0x5b31dc){const _0x548d54=a8_0x4360;var _0x4da817=[];for(var _0x48f64f in _0x5b31dc)if(Object[_0x548d54(0x149)][_0x548d54(0xfe)][_0x548d54(0x124)](_0x5b31dc,_0x48f64f))_0x4da817[_0x4da817[_0x548d54(0x16d)]]=_0x48f64f;return _0x4da817;},_0x43051a(_0x5cb1df);};return function(_0x26b2cc){const _0x3c2a28=a8_0x4360;if(_0x26b2cc&&_0x26b2cc[_0x3c2a28(0x13e)])return _0x26b2cc;var _0x389d07={};if(_0x26b2cc!=null){for(var _0x802634=_0x43051a(_0x26b2cc),_0x12ff91=0x0;_0x12ff91<_0x802634[_0x3c2a28(0x16d)];_0x12ff91++)if(_0x802634[_0x12ff91]!==_0x3c2a28(0x150))__createBinding(_0x389d07,_0x26b2cc,_0x802634[_0x12ff91]);}return __setModuleDefault(_0x389d07,_0x26b2cc),_0x389d07;};}()),__importDefault=this&&this[a8_0x275843(0x14d)]||function(_0x2ebe42){const _0x13e094=a8_0x275843;return _0x2ebe42&&_0x2ebe42[_0x13e094(0x13e)]?_0x2ebe42:{'default':_0x2ebe42};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a8_0x275843(0x13c)]=void 0x0;const paymentService_1=require(a8_0x275843(0x107)),mastercardService_1=require(a8_0x275843(0x131)),webhookService_1=require(a8_0x275843(0x13b)),database_1=__importDefault(require(a8_0x275843(0x144)));function a8_0x4360(_0x5121d4,_0x274c54){const _0x1c289f=a8_0x1c28();return a8_0x4360=function(_0x43609e,_0x3a5577){_0x43609e=_0x43609e-0xf6;let _0x168ad6=_0x1c289f[_0x43609e];return _0x168ad6;},a8_0x4360(_0x5121d4,_0x274c54);}function a8_0x1c28(){const _0xa708fe=['../services/telegramBotService','get','40412CyVTIy','shop','webhookLog','create','createPublicPayment','../services/paymentService','processCardPayment','masterCardService','json','getPaymentStatus','__setModuleDefault','paymentMethod','gatewayPaymentId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','orderId','💳\x20Browser\x20IP:\x20','paid','getPaymentById','💳\x20MasterCard\x20URLs:','Payment\x20failed','Webhook\x20event\x20',',\x20cannot\x20process','FAILED','gateway','requires_3ds','\x20not\x20enabled\x20for\x20shop\x20','country','configurable','💳\x20MasterCard\x20result:','gatewayOrderId','customerName','toLowerCase','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20not\x20found','call','threeds_url','customerUa','amount','email','status','now','webhookUrl','user_agent','webhookEvents','4200056IHgeFQ','2656638XTnzpt','✅\x20MasterCard\x20payment\x20','../services/gateways/mastercardService','updatedAt','Payment\x20processed\x20successfully','Customer\x20data\x20updated\x20successfully','includes','processMasterCardPayment','18000810DPpGyf','paymentService','MasterCardService','757305XQiIhG','../services/webhookService','PaymentController','\x20\x20\x20Result\x20URL\x20(webhook):\x20','__esModule','error','body','\x20with\x20status\x20','updatePaymentCustomer','Error\x20parsing\x20webhook\x20events:','../config/database','writable','WebhookService','stringify','updatePaymentCustomerDataPublic','prototype','parse','25dEtXJY','MasterCard\x20webhook\x20sent\x20to\x20','__importDefault','PENDING','findUnique','default','customerIp','Card\x20payment\x20failed','Payment\x20created\x20successfully','1111','first_name','\x20processed:\x20','payment','3646528MqsdOD','last_name','Failed\x20to\x20send\x20MasterCard\x20webhook:','💳\x20Card\x20holder:\x20','Payment\x20status\x20is\x20','POST','failed','failureMessage','__importStar','successUrl','2amqKxd','💳\x20Processing\x20MasterCard\x20payment:\x20','application/json','payment.failed','toISOString','update','ms)','mastercard_','shopId','system','PaymentService','length','isArray','final','sendPaymentStatusNotification','currency','then','3DS\x20verification\x20required','📝\x20Customer\x20data:','gateway_payment_id','407492jQlUff','params','customerCountry','PAID','__createBinding','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendShopWebhook','paidAt','log','hasOwnProperty','defineProperty'];a8_0x1c28=function(){return _0xa708fe;};return a8_0x1c28();}class PaymentController{constructor(){const _0x144665=a8_0x275843;this[_0x144665(0x106)]=async(_0x20513e,_0x3beff2,_0x1860fb)=>{const _0x3d4be1=_0x144665;try{const _0x4c4a3e=_0x20513e[_0x3d4be1(0x140)],_0x4a913f=await this[_0x3d4be1(0x138)]['createPublicPayment'](_0x4c4a3e);_0x3beff2[_0x3d4be1(0x129)](0xc9)['json']({'success':!![],'message':_0x3d4be1(0x153),'result':_0x4a913f});}catch(_0x564d76){_0x1860fb(_0x564d76);}},this[_0x144665(0x10b)]=async(_0x1a3fdd,_0x29207e,_0x120fad)=>{const _0x573e9a=_0x144665;try{const {id:_0x404beb}=_0x1a3fdd['params'],_0x43977d=await this[_0x573e9a(0x138)][_0x573e9a(0x10b)](_0x404beb);if(!_0x43977d)return _0x29207e[_0x573e9a(0x129)](0x194)[_0x573e9a(0x10a)]({'success':![],'message':_0x573e9a(0x123)});_0x29207e[_0x573e9a(0x10a)]({'success':!![],'result':_0x43977d});}catch(_0x586890){_0x120fad(_0x586890);}},this[_0x144665(0x113)]=async(_0x4c2c3a,_0x382298,_0x187412)=>{const _0x2b0f23=_0x144665;try{const {id:_0x5a8b3a}=_0x4c2c3a[_0x2b0f23(0xf6)],_0x4a4499=await this[_0x2b0f23(0x138)][_0x2b0f23(0x113)](_0x5a8b3a);if(!_0x4a4499)return _0x382298[_0x2b0f23(0x129)](0x194)[_0x2b0f23(0x10a)]({'success':![],'message':_0x2b0f23(0x123)});_0x382298[_0x2b0f23(0x10a)]({'success':!![],'result':_0x4a4499});}catch(_0x5e8ab5){_0x187412(_0x5e8ab5);}},this[_0x144665(0x142)]=async(_0x346dc7,_0x437ab8,_0x1f93be)=>{const _0x265c53=_0x144665;try{const {id:_0x4930e4}=_0x346dc7[_0x265c53(0xf6)],_0x616181=_0x346dc7[_0x265c53(0x140)];console[_0x265c53(0xfd)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x4930e4),console[_0x265c53(0xfd)](_0x265c53(0x174),_0x616181);const _0xcb5d17=await this['paymentService'][_0x265c53(0x148)](_0x4930e4,_0x616181);if(!_0xcb5d17)return _0x437ab8['status'](0x194)[_0x265c53(0x10a)]({'success':![],'message':'Payment\x20not\x20found'});_0x437ab8[_0x265c53(0x10a)]({'success':!![],'message':_0x265c53(0x134),'result':{'paymentId':_0xcb5d17['id'],'customerIp':_0xcb5d17[_0x265c53(0x151)],'customerUa':_0xcb5d17[_0x265c53(0x126)],'customerCountry':_0xcb5d17[_0x265c53(0xf7)],'updatedAt':_0xcb5d17[_0x265c53(0x132)]}});}catch(_0x598e2a){_0x1f93be(_0x598e2a);}},this[_0x144665(0x136)]=async(_0x59f690,_0x1540d0,_0x431e83)=>{const _0x19ddca=_0x144665;try{const {id:_0x453a56}=_0x59f690[_0x19ddca(0xf6)],{cardData:_0x1ad59d,cardHolder:_0xaf222d,browser:_0x265b89}=_0x59f690['body'];console[_0x19ddca(0xfd)](_0x19ddca(0x163)+_0x453a56),console[_0x19ddca(0xfd)](_0x19ddca(0x15b)+_0xaf222d[_0x19ddca(0x155)]+'\x20'+_0xaf222d['last_name']+'\x20('+_0xaf222d[_0x19ddca(0x128)]+')'),console[_0x19ddca(0xfd)](_0x19ddca(0x111)+_0x265b89['ip']);const _0x1370a5={'customerName':_0xaf222d[_0x19ddca(0x155)]+'\x20'+_0xaf222d[_0x19ddca(0x159)],'customerEmail':_0xaf222d[_0x19ddca(0x128)],'customerIp':_0x265b89['ip'],'customerUa':_0x265b89[_0x19ddca(0x12c)],'customerCountry':_0xaf222d[_0x19ddca(0x11c)]||null},_0x24c0e0=await database_1['default'][_0x19ddca(0x157)][_0x19ddca(0x14f)]({'where':{'id':_0x453a56},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x24c0e0)return _0x1540d0['status'](0x194)[_0x19ddca(0x10a)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x24c0e0[_0x19ddca(0x119)]!=='mastercard')return _0x1540d0['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x24c0e0['status']!=='PENDING')return _0x1540d0[_0x19ddca(0x129)](0x190)[_0x19ddca(0x10a)]({'success':![],'message':_0x19ddca(0x15c)+_0x24c0e0[_0x19ddca(0x129)]+_0x19ddca(0x117)});await database_1['default'][_0x19ddca(0x157)][_0x19ddca(0x167)]({'where':{'id':_0x453a56},'data':{..._0x1370a5,'updatedAt':new Date()}});const _0x2a9e1c='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x245823=_0x24c0e0[_0x19ddca(0x161)];console['log'](_0x19ddca(0x114)),console[_0x19ddca(0xfd)](_0x19ddca(0x13d)+_0x2a9e1c),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x245823);const _0x108d20={'first_name':_0xaf222d[_0x19ddca(0x155)],'last_name':_0xaf222d[_0x19ddca(0x159)],'email':_0xaf222d[_0x19ddca(0x128)]},_0x4f3bb3=await this[_0x19ddca(0x109)][_0x19ddca(0x108)]({'paymentId':_0x24c0e0['id'],'orderId':_0x24c0e0[_0x19ddca(0x11f)]||_0x24c0e0['id'],'amount':_0x24c0e0[_0x19ddca(0x127)],'currency':_0x24c0e0['currency'],'cardData':_0x1ad59d,'resultUrl':_0x2a9e1c,'returnUrl':_0x245823,'cardHolder':_0x108d20,'browser':_0x265b89});console[_0x19ddca(0xfd)](_0x19ddca(0x11e),_0x4f3bb3);const _0x5a0b0d={'status':_0x4f3bb3[_0x19ddca(0x129)],'updatedAt':new Date(),'statusChangedBy':_0x19ddca(0x16b),'statusChangedAt':new Date()};if(_0x4f3bb3[_0x19ddca(0x129)]===_0x19ddca(0xf8))_0x5a0b0d[_0x19ddca(0xfc)]=new Date(),_0x5a0b0d[_0x19ddca(0x10e)]=_0x4f3bb3['gateway_payment_id'];else _0x4f3bb3[_0x19ddca(0x129)]===_0x19ddca(0x118)&&(_0x5a0b0d[_0x19ddca(0x15f)]=_0x19ddca(0x152));_0x5a0b0d[_0x19ddca(0x10d)]='mastercard',await database_1[_0x19ddca(0x150)][_0x19ddca(0x157)][_0x19ddca(0x167)]({'where':{'id':_0x24c0e0['id']},'data':_0x5a0b0d}),await database_1[_0x19ddca(0x150)][_0x19ddca(0x104)]['create']({'data':{'paymentId':_0x24c0e0['id'],'shopId':_0x24c0e0[_0x19ddca(0x16a)],'event':_0x19ddca(0x169)+_0x4f3bb3[_0x19ddca(0x129)]?.[_0x19ddca(0x121)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x19ddca(0x14e),'newStatus':_0x4f3bb3['status'],'gatewayPaymentId':_0x4f3bb3['gateway_payment_id'],'requires3ds':_0x4f3bb3['requires_3ds'],'processedAt':new Date()[_0x19ddca(0x166)]()})}});_0x4f3bb3[_0x19ddca(0x16f)]&&(await this['sendShopWebhook'](_0x24c0e0,_0x4f3bb3[_0x19ddca(0x129)],_0x4f3bb3['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x24c0e0,_0x4f3bb3['status']));console[_0x19ddca(0xfd)](_0x19ddca(0x130)+_0x453a56+_0x19ddca(0x156)+_0x4f3bb3[_0x19ddca(0x129)]);if(_0x4f3bb3[_0x19ddca(0x129)]===_0x19ddca(0xf8))_0x1540d0[_0x19ddca(0x10a)]({'success':!![],'message':_0x19ddca(0x133),'result':{'status':_0x19ddca(0xf8),'gatewayPaymentId':_0x4f3bb3['gateway_payment_id'],'redirectUrl':_0x245823,'final':!![]}});else _0x4f3bb3[_0x19ddca(0x11a)]&&_0x4f3bb3[_0x19ddca(0x125)]?_0x1540d0[_0x19ddca(0x10a)]({'success':!![],'message':_0x19ddca(0x173),'result':{'status':'PENDING','gatewayPaymentId':_0x4f3bb3[_0x19ddca(0x175)],'redirectUrl':_0x4f3bb3[_0x19ddca(0x125)],'requires3ds':!![],'final':![]}}):_0x1540d0['status'](0x190)['json']({'success':![],'message':_0x19ddca(0x115),'result':{'status':'FAILED','gatewayPaymentId':_0x4f3bb3[_0x19ddca(0x175)],'redirectUrl':_0x24c0e0['failUrl'],'final':!![]}});}catch(_0x2cf09b){_0x431e83(_0x2cf09b);}},this['paymentService']=new paymentService_1[(_0x144665(0x16c))](),this[_0x144665(0x109)]=new mastercardService_1[(_0x144665(0x139))](),this['webhookService']=new webhookService_1[(_0x144665(0x146))]();}async[a8_0x275843(0xfb)](_0x11f78d,_0x9a3942,_0x982901){const _0xa12730=a8_0x275843,_0x3d80ce=Date['now']();try{const _0xe34343=_0x11f78d[_0xa12730(0x103)],_0x38fd0a=_0xe34343['settings'];if(!_0x38fd0a?.['webhookUrl']){console['log'](_0xa12730(0x10f)+_0xe34343['id']);return;}const _0x3db16a=_0x9a3942===_0xa12730(0xf8)?'payment.success':_0xa12730(0x165);let _0x321319=[];if(_0x38fd0a[_0xa12730(0x12d)])try{_0x321319=Array[_0xa12730(0x16e)](_0x38fd0a[_0xa12730(0x12d)])?_0x38fd0a['webhookEvents']:JSON[_0xa12730(0x14a)](_0x38fd0a[_0xa12730(0x12d)]);}catch(_0x1004fe){console[_0xa12730(0x13f)](_0xa12730(0x143),_0x1004fe),_0x321319=[];}if(!_0x321319[_0xa12730(0x135)](_0x3db16a)){console[_0xa12730(0xfd)](_0xa12730(0x116)+_0x3db16a+_0xa12730(0x11b)+_0xe34343['id']);return;}const _0x109901={'event':_0x3db16a,'payment':{'id':_0x11f78d['id'],'order_id':_0x11f78d[_0xa12730(0x110)],'gateway_order_id':_0x11f78d['gatewayOrderId'],'gateway':_0xa12730(0x154),'amount':_0x11f78d[_0xa12730(0x127)],'currency':_0x11f78d[_0xa12730(0x171)],'status':_0x9a3942[_0xa12730(0x121)](),'customer_email':_0x11f78d['customerEmail'],'customer_name':_0x11f78d[_0xa12730(0x120)],'gateway_payment_id':_0x982901,'created_at':_0x11f78d['createdAt'],'updated_at':new Date()}},_0x2298d8=await fetch(_0x38fd0a['webhookUrl'],{'method':_0xa12730(0x15d),'headers':{'Content-Type':_0xa12730(0x164),'User-Agent':_0xa12730(0x122)},'body':JSON[_0xa12730(0x147)](_0x109901)}),_0x1506e5=Date[_0xa12730(0x12a)]()-_0x3d80ce;console[_0xa12730(0xfd)](_0xa12730(0x14c)+_0x38fd0a[_0xa12730(0x12b)]+_0xa12730(0x141)+_0x2298d8[_0xa12730(0x129)]+'\x20('+_0x1506e5+_0xa12730(0x168));}catch(_0x112f83){console[_0xa12730(0x13f)](_0xa12730(0x15a),_0x112f83);}}async[a8_0x275843(0x170)](_0x335a8b,_0x3bf54c){const _0x5b10b4=a8_0x275843;try{const {telegramBotService:_0xa8216a}=await Promise['resolve']()[_0x5b10b4(0x172)](()=>__importStar(require(_0x5b10b4(0x100)))),_0xce55ac={'PAID':_0x5b10b4(0x112),'FAILED':_0x5b10b4(0x15e)},_0x5e8d98=_0xce55ac[_0x3bf54c];if(!_0x5e8d98)return;await _0xa8216a['sendPaymentNotification'](_0x335a8b[_0x5b10b4(0x16a)],_0x335a8b,_0x5e8d98);}catch(_0x4d0d4f){console[_0x5b10b4(0x13f)](_0x5b10b4(0xfa),_0x4d0d4f);}}}exports[a8_0x275843(0x13c)]=PaymentController;