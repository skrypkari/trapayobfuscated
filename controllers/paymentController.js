'use strict';const a8_0x41489f=a8_0x5c11;(function(_0x2b7645,_0x27980b){const _0x1d4a10=a8_0x5c11,_0x32d57a=_0x2b7645();while(!![]){try{const _0x25d8b9=parseInt(_0x1d4a10(0x1a8))/0x1*(parseInt(_0x1d4a10(0x128))/0x2)+parseInt(_0x1d4a10(0x14a))/0x3+parseInt(_0x1d4a10(0x1a6))/0x4*(-parseInt(_0x1d4a10(0x1ad))/0x5)+parseInt(_0x1d4a10(0x12e))/0x6+-parseInt(_0x1d4a10(0x154))/0x7+-parseInt(_0x1d4a10(0x1a7))/0x8*(-parseInt(_0x1d4a10(0x198))/0x9)+-parseInt(_0x1d4a10(0x172))/0xa;if(_0x25d8b9===_0x27980b)break;else _0x32d57a['push'](_0x32d57a['shift']());}catch(_0x2d7e34){_0x32d57a['push'](_0x32d57a['shift']());}}}(a8_0x2e19,0xcdc17));var __createBinding=this&&this[a8_0x41489f(0x131)]||(Object[a8_0x41489f(0x188)]?function(_0x5a9492,_0x53c13f,_0x2a3604,_0x1e7fc3){const _0x49e7e7=a8_0x41489f;if(_0x1e7fc3===undefined)_0x1e7fc3=_0x2a3604;var _0xba99f8=Object[_0x49e7e7(0x194)](_0x53c13f,_0x2a3604);(!_0xba99f8||(_0x49e7e7(0x14e)in _0xba99f8?!_0x53c13f['__esModule']:_0xba99f8[_0x49e7e7(0x14d)]||_0xba99f8[_0x49e7e7(0x1a0)]))&&(_0xba99f8={'enumerable':!![],'get':function(){return _0x53c13f[_0x2a3604];}}),Object[_0x49e7e7(0x1ac)](_0x5a9492,_0x1e7fc3,_0xba99f8);}:function(_0x56fa21,_0x4d00a5,_0x151b1c,_0x517e51){if(_0x517e51===undefined)_0x517e51=_0x151b1c;_0x56fa21[_0x517e51]=_0x4d00a5[_0x151b1c];}),__setModuleDefault=this&&this[a8_0x41489f(0x1aa)]||(Object[a8_0x41489f(0x188)]?function(_0x432f3d,_0x1be51d){const _0xc95443=a8_0x41489f;Object[_0xc95443(0x1ac)](_0x432f3d,'default',{'enumerable':!![],'value':_0x1be51d});}:function(_0x5a04dd,_0x5143c7){const _0x47e5c9=a8_0x41489f;_0x5a04dd[_0x47e5c9(0x15d)]=_0x5143c7;}),__importStar=this&&this[a8_0x41489f(0x175)]||(function(){var _0x445d92=function(_0x11b9c7){const _0x4e6ecc=a8_0x5c11;return _0x445d92=Object[_0x4e6ecc(0x136)]||function(_0x3eaac5){const _0x7ba38b=_0x4e6ecc;var _0x55bf31=[];for(var _0x28be56 in _0x3eaac5)if(Object[_0x7ba38b(0x149)][_0x7ba38b(0x162)][_0x7ba38b(0x19e)](_0x3eaac5,_0x28be56))_0x55bf31[_0x55bf31[_0x7ba38b(0x158)]]=_0x28be56;return _0x55bf31;},_0x445d92(_0x11b9c7);};return function(_0x4b94d3){const _0xffa7bb=a8_0x5c11;if(_0x4b94d3&&_0x4b94d3[_0xffa7bb(0x171)])return _0x4b94d3;var _0x320f0d={};if(_0x4b94d3!=null){for(var _0x481488=_0x445d92(_0x4b94d3),_0x2f3455=0x0;_0x2f3455<_0x481488['length'];_0x2f3455++)if(_0x481488[_0x2f3455]!=='default')__createBinding(_0x320f0d,_0x4b94d3,_0x481488[_0x2f3455]);}return __setModuleDefault(_0x320f0d,_0x4b94d3),_0x320f0d;};}()),__importDefault=this&&this[a8_0x41489f(0x18f)]||function(_0x32fee7){const _0x80c23b=a8_0x41489f;return _0x32fee7&&_0x32fee7[_0x80c23b(0x171)]?_0x32fee7:{'default':_0x32fee7};};Object[a8_0x41489f(0x1ac)](exports,a8_0x41489f(0x171),{'value':!![]}),exports[a8_0x41489f(0x1a1)]=void 0x0;const paymentService_1=require(a8_0x41489f(0x18a)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x41489f(0x12d)));function a8_0x2e19(){const _0x5e87f1=['Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','💳\x20Card\x20holder:\x20','__esModule','25546510UXZepG','email','mastercard','__importStar','\x20not\x20enabled\x20for\x20shop\x20','amount','customerUa','gateway','first_name','WebhookService','ms)','\x20\x20\x20Result\x20URL\x20(webhook):\x20','processCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','\x20\x20\x20Return\x20URL:\x20','now','Card\x20payment\x20failed','💳\x20Browser\x20IP:\x20','getPaymentById','processMasterCardPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','create','1111','../services/paymentService','stringify','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','customerCountry','successUrl','__importDefault','createdAt','Customer\x20data\x20updated\x20successfully','payment','webhookLog','getOwnPropertyDescriptor','body','../services/paymentLinkService','customerIp','275481dyqfnX','number','application/json','failureMessage','paymentMethod','orderId','call','sendPaymentNotification','configurable','PaymentController','createPublicPayment','error','gatewayPaymentId','params','368dtiGUr','304SjKcFG','4478NCfJrL','PENDING','__setModuleDefault','gatewayOrderId','defineProperty','27745SEHmNV','system','598cQoqoq','\x20processed:\x20','settings',',\x20cannot\x20process','slice','../config/database','5502054bBAtGB','MasterCard\x20webhook\x20sent\x20to\x20','requires_3ds','__createBinding','cardLast4','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','../services/telegramBotService','toLowerCase','getOwnPropertyNames','customerEmail','updatedAt','📈\x20MasterCard\x20payment\x20','💳\x20MasterCard\x20result:','sendShopWebhook','payment.success','shopId','updatePaymentCustomer','payment.failed','parse','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','webhookUrl','Error\x20parsing\x20webhook\x20events:','paid','masterCardService','gateway_payment_id','update','then','prototype','3461694tHpjVY','log','webhookEvents','writable','get','status','Payment\x20status\x20is\x20','toISOString','💳\x20Processing\x20MasterCard\x20payment:\x20','includes','4655259UiNubL','country','PaymentService','threeds_url','length','json','POST','findUnique','\x20with\x20status\x20','default','resolve','FAILED','mastercard_','last_name','hasOwnProperty','PAID','paymentService','3DS\x20verification\x20required','Payment\x20failed','getPaymentStatus','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','final','Payment\x20not\x20found','webhookService','Payment\x20created\x20successfully','sendPaymentStatusNotification'];a8_0x2e19=function(){return _0x5e87f1;};return a8_0x2e19();}class PaymentController{constructor(){const _0x23381e=a8_0x41489f;this[_0x23381e(0x1a2)]=async(_0x3b8b8a,_0x3d4996,_0x5a10e2)=>{const _0x2c0b0c=_0x23381e;try{const _0x423b3e=_0x3b8b8a[_0x2c0b0c(0x195)],_0x1d1255=await this[_0x2c0b0c(0x164)]['createPublicPayment'](_0x423b3e);_0x3d4996[_0x2c0b0c(0x14f)](0xc9)[_0x2c0b0c(0x159)]({'success':!![],'message':_0x2c0b0c(0x16d),'result':_0x1d1255});}catch(_0xd1036e){_0x5a10e2(_0xd1036e);}},this[_0x23381e(0x167)]=async(_0x3f0c98,_0x6e3d0b,_0x2f0358)=>{const _0x1a33c0=_0x23381e;try{const {id:_0x5a1dcc}=_0x3f0c98[_0x1a33c0(0x1a5)],_0x1fc2ab=await this[_0x1a33c0(0x164)][_0x1a33c0(0x167)](_0x5a1dcc);if(!_0x1fc2ab)return _0x6e3d0b[_0x1a33c0(0x14f)](0x194)[_0x1a33c0(0x159)]({'success':![],'message':'Payment\x20not\x20found'});_0x6e3d0b['json']({'success':!![],'result':_0x1fc2ab});}catch(_0x169bde){_0x2f0358(_0x169bde);}},this[_0x23381e(0x185)]=async(_0x564b4e,_0x55dac6,_0x39556b)=>{const _0x38ea67=_0x23381e;try{const {id:_0x385bce}=_0x564b4e[_0x38ea67(0x1a5)],_0x337d1c=await this[_0x38ea67(0x164)][_0x38ea67(0x185)](_0x385bce);if(!_0x337d1c)return _0x55dac6[_0x38ea67(0x14f)](0x194)[_0x38ea67(0x159)]({'success':![],'message':'Payment\x20not\x20found'});_0x55dac6[_0x38ea67(0x159)]({'success':!![],'result':_0x337d1c});}catch(_0x1dd825){_0x39556b(_0x1dd825);}},this[_0x23381e(0x13e)]=async(_0x3bbea7,_0x24d8b7,_0xad1b46)=>{const _0x3d9dba=_0x23381e;try{const {id:_0x49d526}=_0x3bbea7[_0x3d9dba(0x1a5)],_0x16f934=_0x3bbea7['body'];console[_0x3d9dba(0x14b)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x49d526),console[_0x3d9dba(0x14b)]('📝\x20Customer\x20data:',_0x16f934);const _0x43519b=await this[_0x3d9dba(0x164)]['updatePaymentCustomerDataPublic'](_0x49d526,_0x16f934);if(!_0x43519b)return _0x24d8b7[_0x3d9dba(0x14f)](0x194)[_0x3d9dba(0x159)]({'success':![],'message':_0x3d9dba(0x16b)});_0x24d8b7[_0x3d9dba(0x159)]({'success':!![],'message':_0x3d9dba(0x191),'result':{'paymentId':_0x43519b['id'],'customerIp':_0x43519b[_0x3d9dba(0x197)],'customerUa':_0x43519b[_0x3d9dba(0x178)],'customerCountry':_0x43519b[_0x3d9dba(0x18d)],'updatedAt':_0x43519b[_0x3d9dba(0x138)]}});}catch(_0x50939e){_0xad1b46(_0x50939e);}},this[_0x23381e(0x186)]=async(_0x12d8df,_0x1ce08f,_0x8a7b)=>{const _0x294333=_0x23381e;try{const {id:_0x33806b}=_0x12d8df[_0x294333(0x1a5)],{cardData:_0x4b31eb,cardHolder:_0x46b6cb,browser:_0x399cf2}=_0x12d8df['body'];console[_0x294333(0x14b)](_0x294333(0x152)+_0x33806b),console[_0x294333(0x14b)](_0x294333(0x170)+_0x46b6cb[_0x294333(0x17a)]+'\x20'+_0x46b6cb[_0x294333(0x161)]+'\x20('+_0x46b6cb[_0x294333(0x173)]+')'),console[_0x294333(0x14b)](_0x294333(0x184)+_0x399cf2['ip']);const _0x313efc={'customerName':_0x46b6cb[_0x294333(0x17a)]+'\x20'+_0x46b6cb[_0x294333(0x161)],'customerEmail':_0x46b6cb[_0x294333(0x173)],'customerIp':_0x399cf2['ip'],'customerUa':_0x399cf2['user_agent'],'customerCountry':_0x46b6cb[_0x294333(0x155)]||null},_0x4664cf=await database_1['default']['payment'][_0x294333(0x15b)]({'where':{'id':_0x33806b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4664cf)return _0x1ce08f[_0x294333(0x14f)](0x194)[_0x294333(0x159)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x4664cf[_0x294333(0x179)]!==_0x294333(0x174))return _0x1ce08f[_0x294333(0x14f)](0x190)[_0x294333(0x159)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x4664cf[_0x294333(0x14f)]!=='PENDING')return _0x1ce08f[_0x294333(0x14f)](0x190)['json']({'success':![],'message':_0x294333(0x150)+_0x4664cf['status']+_0x294333(0x12b)});await database_1[_0x294333(0x15d)][_0x294333(0x192)][_0x294333(0x147)]({'where':{'id':_0x33806b},'data':{..._0x313efc,'updatedAt':new Date()}});const _0x3fc646=_0x294333(0x17f),_0x43c3c3=_0x4664cf[_0x294333(0x18e)];console[_0x294333(0x14b)]('💳\x20MasterCard\x20URLs:'),console[_0x294333(0x14b)](_0x294333(0x17d)+_0x3fc646),console['log'](_0x294333(0x181)+_0x43c3c3);const _0x814004={'first_name':_0x46b6cb['first_name'],'last_name':_0x46b6cb[_0x294333(0x161)],'email':_0x46b6cb[_0x294333(0x173)]},_0x220b61=await this[_0x294333(0x145)][_0x294333(0x17e)]({'paymentId':_0x4664cf['id'],'orderId':_0x4664cf[_0x294333(0x1ab)]||_0x4664cf['id'],'amount':_0x4664cf[_0x294333(0x177)],'currency':_0x4664cf['currency'],'cardData':_0x4b31eb,'resultUrl':_0x3fc646,'returnUrl':_0x43c3c3,'cardHolder':_0x814004,'browser':_0x399cf2});console[_0x294333(0x14b)](_0x294333(0x13a),_0x220b61);const _0x628bcf={'status':_0x220b61[_0x294333(0x14f)],'updatedAt':new Date(),'statusChangedBy':_0x294333(0x127),'statusChangedAt':new Date()};_0x220b61[_0x294333(0x146)]&&(_0x628bcf[_0x294333(0x1a4)]=_0x220b61[_0x294333(0x146)],console['log'](_0x294333(0x168)+_0x220b61[_0x294333(0x146)]));if(_0x220b61['status']==='PAID')_0x628bcf['paidAt']=new Date();else _0x220b61[_0x294333(0x14f)]===_0x294333(0x15f)&&(_0x628bcf[_0x294333(0x19b)]=_0x294333(0x183));_0x628bcf[_0x294333(0x19c)]=_0x294333(0x174);if(_0x4b31eb['number']){const _0x292609=_0x4b31eb[_0x294333(0x199)]['replace'](/[\s-]/g,'');_0x628bcf[_0x294333(0x132)]=_0x292609[_0x294333(0x12c)](-0x4),console[_0x294333(0x14b)](_0x294333(0x180)+_0x628bcf[_0x294333(0x132)]);}await database_1[_0x294333(0x15d)][_0x294333(0x192)][_0x294333(0x147)]({'where':{'id':_0x4664cf['id']},'data':_0x628bcf}),await database_1[_0x294333(0x15d)][_0x294333(0x193)]['create']({'data':{'paymentId':_0x4664cf['id'],'shopId':_0x4664cf[_0x294333(0x13d)],'event':_0x294333(0x160)+_0x220b61[_0x294333(0x14f)]?.[_0x294333(0x135)](),'statusCode':0xc8,'responseBody':JSON[_0x294333(0x18b)]({'oldStatus':_0x294333(0x1a9),'newStatus':_0x220b61[_0x294333(0x14f)],'gatewayPaymentId':_0x220b61['gateway_payment_id'],'requires3ds':_0x220b61[_0x294333(0x130)],'processedAt':new Date()[_0x294333(0x151)]()})}});if(_0x220b61[_0x294333(0x16a)]){await this[_0x294333(0x13b)](_0x4664cf,_0x220b61[_0x294333(0x14f)],_0x220b61[_0x294333(0x146)]),await this['sendPaymentStatusNotification'](_0x4664cf,_0x220b61['status']);if(_0x220b61['status']===_0x294333(0x163)){console[_0x294333(0x14b)](_0x294333(0x139)+_0x33806b+_0x294333(0x133));try{const {PaymentLinkService:_0x130739}=await Promise[_0x294333(0x15e)]()['then'](()=>__importStar(require(_0x294333(0x196)))),_0x472139=new _0x130739();await _0x472139['handleSuccessfulPayment'](_0x33806b),console[_0x294333(0x14b)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x33806b);}catch(_0x494a5e){console[_0x294333(0x1a3)](_0x294333(0x16f),_0x494a5e);}}}console[_0x294333(0x14b)]('✅\x20MasterCard\x20payment\x20'+_0x33806b+_0x294333(0x129)+_0x220b61[_0x294333(0x14f)]);if(_0x220b61[_0x294333(0x14f)]===_0x294333(0x163))_0x1ce08f[_0x294333(0x159)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x294333(0x163),'gatewayPaymentId':_0x220b61[_0x294333(0x146)],'redirectUrl':_0x43c3c3,'final':!![]}});else _0x220b61[_0x294333(0x130)]&&_0x220b61[_0x294333(0x157)]?_0x1ce08f['json']({'success':!![],'message':_0x294333(0x165),'result':{'status':_0x294333(0x1a9),'gatewayPaymentId':_0x220b61['gateway_payment_id'],'redirectUrl':_0x220b61[_0x294333(0x157)],'requires3ds':!![],'final':![]}}):_0x1ce08f[_0x294333(0x14f)](0x190)[_0x294333(0x159)]({'success':![],'message':_0x294333(0x166),'result':{'status':'FAILED','gatewayPaymentId':_0x220b61[_0x294333(0x146)],'redirectUrl':_0x4664cf['failUrl'],'final':!![]}});}catch(_0x17e05d){_0x8a7b(_0x17e05d);}},this[_0x23381e(0x164)]=new paymentService_1[(_0x23381e(0x156))](),this[_0x23381e(0x145)]=new mastercardService_1['MasterCardService'](),this[_0x23381e(0x16c)]=new webhookService_1[(_0x23381e(0x17b))]();}async[a8_0x41489f(0x13b)](_0x11f69a,_0x2ef3b0,_0x3ac213){const _0x39bb09=a8_0x41489f,_0x38b3d0=Date[_0x39bb09(0x182)]();try{const _0xf8985d=_0x11f69a['shop'],_0x482669=_0xf8985d[_0x39bb09(0x12a)];if(!_0x482669?.[_0x39bb09(0x142)]){console[_0x39bb09(0x14b)](_0x39bb09(0x187)+_0xf8985d['id']);return;}const _0x4f3c2c=_0x2ef3b0===_0x39bb09(0x163)?_0x39bb09(0x13c):_0x39bb09(0x13f);let _0x292d6a=[];if(_0x482669[_0x39bb09(0x14c)])try{_0x292d6a=Array['isArray'](_0x482669['webhookEvents'])?_0x482669[_0x39bb09(0x14c)]:JSON[_0x39bb09(0x140)](_0x482669[_0x39bb09(0x14c)]);}catch(_0x1fc923){console[_0x39bb09(0x1a3)](_0x39bb09(0x143),_0x1fc923),_0x292d6a=[];}if(!_0x292d6a[_0x39bb09(0x153)](_0x4f3c2c)){console['log']('Webhook\x20event\x20'+_0x4f3c2c+_0x39bb09(0x176)+_0xf8985d['id']);return;}const _0x469d96={'event':_0x4f3c2c,'payment':{'id':_0x11f69a['id'],'order_id':_0x11f69a[_0x39bb09(0x19d)],'gateway_order_id':_0x11f69a['gatewayOrderId'],'gateway':_0x39bb09(0x189),'amount':_0x11f69a['amount'],'currency':_0x11f69a['currency'],'status':_0x2ef3b0[_0x39bb09(0x135)](),'customer_email':_0x11f69a[_0x39bb09(0x137)],'customer_name':_0x11f69a['customerName'],'gateway_payment_id':_0x3ac213,'created_at':_0x11f69a[_0x39bb09(0x190)],'updated_at':new Date()}},_0x66c37f=await fetch(_0x482669[_0x39bb09(0x142)],{'method':_0x39bb09(0x15a),'headers':{'Content-Type':_0x39bb09(0x19a),'User-Agent':_0x39bb09(0x18c)},'body':JSON[_0x39bb09(0x18b)](_0x469d96)}),_0x255667=Date[_0x39bb09(0x182)]()-_0x38b3d0;console['log'](_0x39bb09(0x12f)+_0x482669[_0x39bb09(0x142)]+_0x39bb09(0x15c)+_0x66c37f[_0x39bb09(0x14f)]+'\x20('+_0x255667+_0x39bb09(0x17c));}catch(_0x195950){console['error'](_0x39bb09(0x169),_0x195950);}}async[a8_0x41489f(0x16e)](_0x4bef00,_0x308143){const _0xe29c02=a8_0x41489f;try{const {telegramBotService:_0x3de4d8}=await Promise[_0xe29c02(0x15e)]()[_0xe29c02(0x148)](()=>__importStar(require(_0xe29c02(0x134)))),_0x8f3aa5={'PAID':_0xe29c02(0x144),'FAILED':'failed'},_0x5f02d8=_0x8f3aa5[_0x308143];if(!_0x5f02d8)return;await _0x3de4d8[_0xe29c02(0x19f)](_0x4bef00[_0xe29c02(0x13d)],_0x4bef00,_0x5f02d8);}catch(_0x257af9){console['error'](_0xe29c02(0x141),_0x257af9);}}}function a8_0x5c11(_0x3ebf45,_0x3dfbd5){const _0x2e19dc=a8_0x2e19();return a8_0x5c11=function(_0x5c1155,_0x4edd04){_0x5c1155=_0x5c1155-0x127;let _0xece398=_0x2e19dc[_0x5c1155];return _0xece398;},a8_0x5c11(_0x3ebf45,_0x3dfbd5);}exports[a8_0x41489f(0x1a1)]=PaymentController;