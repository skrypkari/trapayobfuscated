'use strict';function a8_0x58e6(_0x3c2882,_0x519c0f){const _0x207d01=a8_0x207d();return a8_0x58e6=function(_0x58e6f5,_0x2ad179){_0x58e6f5=_0x58e6f5-0x6b;let _0x27129e=_0x207d01[_0x58e6f5];return _0x27129e;},a8_0x58e6(_0x3c2882,_0x519c0f);}const a8_0x678738=a8_0x58e6;function a8_0x207d(){const _0xa2cc3e=['customerIp','90060waNQyF','üí≥\x20Processing\x20MasterCard\x20payment:\x20','sendPaymentNotification',',\x20cannot\x20process','üìù\x20Customer\x20data:','call','cardLast4','hasOwnProperty','first_name','configurable','number','../config/database','default','createdAt','paymentMethod','createPublicPayment','20572pWmVdv','updatePaymentCustomer','__setModuleDefault','resolve','3DS\x20verification\x20required','sendPaymentStatusNotification','1111','updatedAt','json','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','findUnique','updatePaymentCustomerDataPublic','paymentService','threeds_url','üí≥\x20MasterCard\x20result:','customerUa','failUrl','105rXOFWj','body','now','writable','Payment\x20failed','shopId','final','customerCountry','2218700TCrZmj','üí≥\x20Browser\x20IP:\x20','payment','length','create','../services/webhookService','last_name','slice','get','https://api.trapay.uk/api/webhooks/gateway/mastercard','PENDING','mastercard_','masterCardService','../services/paymentLinkService','üí≥\x20MasterCard\x20URLs:','currency','payment.failed','gatewayOrderId','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','prototype','__esModule','processMasterCardPayment','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','MasterCardService','handleSuccessfulPayment','paidAt','user_agent','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','getPaymentById','shop','6vrZLFy','__importStar','gatewayPaymentId','9430110dfevGO','‚úÖ\x20MasterCard\x20payment\x20','webhookUrl','failureMessage','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','payment.success','isArray','../services/paymentService','\x20processed:\x20','gateway','262646rwqSeI','webhookLog','Payment\x20not\x20found','application/json','error','country','status','Customer\x20data\x20updated\x20successfully','sendShopWebhook','webhookEvents','webhookService','getPaymentStatus','email','531426AyRcDz','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','parse','PaymentController','update','mastercard','PAID','stringify','POST','ms)','../services/gateways/mastercardService','Webhook\x20event\x20','amount','customerEmail','getOwnPropertyDescriptor','requires_3ds','üí≥\x20Card\x20holder:\x20','getOwnPropertyNames','customerName','FAILED','defineProperty','\x20not\x20enabled\x20for\x20shop\x20','params','then','WebhookService','failed','1815272eCouQn','settings','log','replace','paid','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gateway_payment_id','Error\x20parsing\x20webhook\x20events:'];a8_0x207d=function(){return _0xa2cc3e;};return a8_0x207d();}(function(_0x186514,_0x57d7d4){const _0x45e3d9=a8_0x58e6,_0x4e4384=_0x186514();while(!![]){try{const _0x269b0c=parseInt(_0x45e3d9(0xb3))/0x1+-parseInt(_0x45e3d9(0xe4))/0x2+parseInt(_0x45e3d9(0x80))/0x3*(-parseInt(_0x45e3d9(0x6f))/0x4)+-parseInt(_0x45e3d9(0x88))/0x5+parseInt(_0x45e3d9(0xa6))/0x6*(-parseInt(_0x45e3d9(0xc0))/0x7)+-parseInt(_0x45e3d9(0xda))/0x8+parseInt(_0x45e3d9(0xa9))/0x9;if(_0x269b0c===_0x57d7d4)break;else _0x4e4384['push'](_0x4e4384['shift']());}catch(_0x713fd3){_0x4e4384['push'](_0x4e4384['shift']());}}}(a8_0x207d,0x52b92));var __createBinding=this&&this['__createBinding']||(Object[a8_0x678738(0x8c)]?function(_0x2119aa,_0x319a52,_0x4aee7d,_0x4f2412){const _0x315245=a8_0x678738;if(_0x4f2412===undefined)_0x4f2412=_0x4aee7d;var _0x3469c2=Object[_0x315245(0xce)](_0x319a52,_0x4aee7d);(!_0x3469c2||(_0x315245(0x90)in _0x3469c2?!_0x319a52['__esModule']:_0x3469c2[_0x315245(0x83)]||_0x3469c2[_0x315245(0xed)]))&&(_0x3469c2={'enumerable':!![],'get':function(){return _0x319a52[_0x4aee7d];}}),Object[_0x315245(0xd4)](_0x2119aa,_0x4f2412,_0x3469c2);}:function(_0x5d1c3d,_0x50d305,_0x1c323e,_0x150975){if(_0x150975===undefined)_0x150975=_0x1c323e;_0x5d1c3d[_0x150975]=_0x50d305[_0x1c323e];}),__setModuleDefault=this&&this[a8_0x678738(0x71)]||(Object['create']?function(_0x3aea30,_0xa9f1d0){const _0x437f8a=a8_0x678738;Object[_0x437f8a(0xd4)](_0x3aea30,_0x437f8a(0x6b),{'enumerable':!![],'value':_0xa9f1d0});}:function(_0x10c02b,_0x859352){const _0x554fcb=a8_0x678738;_0x10c02b[_0x554fcb(0x6b)]=_0x859352;}),__importStar=this&&this[a8_0x678738(0xa7)]||(function(){var _0x15e963=function(_0x532974){const _0x5a546f=a8_0x58e6;return _0x15e963=Object[_0x5a546f(0xd1)]||function(_0xa1936b){const _0x2fb10c=_0x5a546f;var _0x148722=[];for(var _0x1aa50c in _0xa1936b)if(Object[_0x2fb10c(0x9b)][_0x2fb10c(0xeb)][_0x2fb10c(0xe9)](_0xa1936b,_0x1aa50c))_0x148722[_0x148722[_0x2fb10c(0x8b)]]=_0x1aa50c;return _0x148722;},_0x15e963(_0x532974);};return function(_0x4bf3ea){const _0xfb3e4d=a8_0x58e6;if(_0x4bf3ea&&_0x4bf3ea[_0xfb3e4d(0x9c)])return _0x4bf3ea;var _0x4bd826={};if(_0x4bf3ea!=null){for(var _0x3de9ca=_0x15e963(_0x4bf3ea),_0x4e989e=0x0;_0x4e989e<_0x3de9ca['length'];_0x4e989e++)if(_0x3de9ca[_0x4e989e]!==_0xfb3e4d(0x6b))__createBinding(_0x4bd826,_0x4bf3ea,_0x3de9ca[_0x4e989e]);}return __setModuleDefault(_0x4bd826,_0x4bf3ea),_0x4bd826;};}()),__importDefault=this&&this['__importDefault']||function(_0x5f3d06){const _0xee171=a8_0x678738;return _0x5f3d06&&_0x5f3d06[_0xee171(0x9c)]?_0x5f3d06:{'default':_0x5f3d06};};Object[a8_0x678738(0xd4)](exports,'__esModule',{'value':!![]}),exports[a8_0x678738(0xc3)]=void 0x0;const paymentService_1=require(a8_0x678738(0xb0)),mastercardService_1=require(a8_0x678738(0xca)),webhookService_1=require(a8_0x678738(0x8d)),database_1=__importDefault(require(a8_0x678738(0xef)));class PaymentController{constructor(){const _0x354b45=a8_0x678738;this['createPublicPayment']=async(_0x278b99,_0x5d5c3c,_0x5ad12c)=>{const _0x6a03bd=a8_0x58e6;try{const _0x35b99e=_0x278b99[_0x6a03bd(0x81)],_0x5b9aa7=await this[_0x6a03bd(0x7b)][_0x6a03bd(0x6e)](_0x35b99e);_0x5d5c3c[_0x6a03bd(0xb9)](0xc9)['json']({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x5b9aa7});}catch(_0x54a1a6){_0x5ad12c(_0x54a1a6);}},this[_0x354b45(0xbe)]=async(_0x4cc415,_0x3e3a44,_0x536eee)=>{const _0x58caa3=_0x354b45;try{const {id:_0x575194}=_0x4cc415[_0x58caa3(0xd6)],_0x340b58=await this[_0x58caa3(0x7b)][_0x58caa3(0xbe)](_0x575194);if(!_0x340b58)return _0x3e3a44['status'](0x194)[_0x58caa3(0x77)]({'success':![],'message':'Payment\x20not\x20found'});_0x3e3a44[_0x58caa3(0x77)]({'success':!![],'result':_0x340b58});}catch(_0x5abc61){_0x536eee(_0x5abc61);}},this[_0x354b45(0xa4)]=async(_0x2e4a6e,_0x59120e,_0x4e665f)=>{const _0x5c521f=_0x354b45;try{const {id:_0x1d7cb6}=_0x2e4a6e['params'],_0x89d6db=await this[_0x5c521f(0x7b)][_0x5c521f(0xa4)](_0x1d7cb6);if(!_0x89d6db)return _0x59120e[_0x5c521f(0xb9)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x59120e[_0x5c521f(0x77)]({'success':!![],'result':_0x89d6db});}catch(_0x2906c3){_0x4e665f(_0x2906c3);}},this[_0x354b45(0x70)]=async(_0x2aa9bc,_0x19b3fa,_0x555b1f)=>{const _0x7e1d1=_0x354b45;try{const {id:_0x52da21}=_0x2aa9bc[_0x7e1d1(0xd6)],_0x20fc5c=_0x2aa9bc['body'];console[_0x7e1d1(0xdc)](_0x7e1d1(0x9e)+_0x52da21),console[_0x7e1d1(0xdc)](_0x7e1d1(0xe8),_0x20fc5c);const _0x4a7eef=await this[_0x7e1d1(0x7b)][_0x7e1d1(0x7a)](_0x52da21,_0x20fc5c);if(!_0x4a7eef)return _0x19b3fa[_0x7e1d1(0xb9)](0x194)[_0x7e1d1(0x77)]({'success':![],'message':_0x7e1d1(0xb5)});_0x19b3fa[_0x7e1d1(0x77)]({'success':!![],'message':_0x7e1d1(0xba),'result':{'paymentId':_0x4a7eef['id'],'customerIp':_0x4a7eef[_0x7e1d1(0xe3)],'customerUa':_0x4a7eef[_0x7e1d1(0x7e)],'customerCountry':_0x4a7eef[_0x7e1d1(0x87)],'updatedAt':_0x4a7eef[_0x7e1d1(0x76)]}});}catch(_0x5825cb){_0x555b1f(_0x5825cb);}},this[_0x354b45(0x9d)]=async(_0x3418d5,_0x1f1957,_0x21eadd)=>{const _0x2a5256=_0x354b45;try{const {id:_0x945585}=_0x3418d5[_0x2a5256(0xd6)],{cardData:_0x28dc0c,cardHolder:_0x2fb4b6,browser:_0x21373f}=_0x3418d5[_0x2a5256(0x81)];console[_0x2a5256(0xdc)](_0x2a5256(0xe5)+_0x945585),console[_0x2a5256(0xdc)](_0x2a5256(0xd0)+_0x2fb4b6[_0x2a5256(0xec)]+'\x20'+_0x2fb4b6[_0x2a5256(0x8e)]+'\x20('+_0x2fb4b6['email']+')'),console[_0x2a5256(0xdc)](_0x2a5256(0x89)+_0x21373f['ip']);const _0x34b60f={'customerName':_0x2fb4b6[_0x2a5256(0xec)]+'\x20'+_0x2fb4b6[_0x2a5256(0x8e)],'customerEmail':_0x2fb4b6['email'],'customerIp':_0x21373f['ip'],'customerUa':_0x21373f[_0x2a5256(0xa2)],'customerCountry':_0x2fb4b6[_0x2a5256(0xb8)]||null},_0x3ce51a=await database_1[_0x2a5256(0x6b)][_0x2a5256(0x8a)][_0x2a5256(0x79)]({'where':{'id':_0x945585},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ce51a)return _0x1f1957[_0x2a5256(0xb9)](0x194)['json']({'success':![],'message':_0x2a5256(0xb5)});if(_0x3ce51a[_0x2a5256(0xb2)]!==_0x2a5256(0xc5))return _0x1f1957[_0x2a5256(0xb9)](0x190)[_0x2a5256(0x77)]({'success':![],'message':_0x2a5256(0xa3)});if(_0x3ce51a['status']!==_0x2a5256(0x92))return _0x1f1957[_0x2a5256(0xb9)](0x190)[_0x2a5256(0x77)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x3ce51a[_0x2a5256(0xb9)]+_0x2a5256(0xe7)});await database_1['default'][_0x2a5256(0x8a)][_0x2a5256(0xc4)]({'where':{'id':_0x945585},'data':{..._0x34b60f,'updatedAt':new Date()}});const _0x48f139=_0x2a5256(0x91),_0xa5e699=_0x3ce51a['successUrl'];console['log'](_0x2a5256(0x96)),console[_0x2a5256(0xdc)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x48f139),console[_0x2a5256(0xdc)]('\x20\x20\x20Return\x20URL:\x20'+_0xa5e699);const _0x4815b4={'first_name':_0x2fb4b6[_0x2a5256(0xec)],'last_name':_0x2fb4b6[_0x2a5256(0x8e)],'email':_0x2fb4b6[_0x2a5256(0xbf)]},_0x18811c=await this['masterCardService']['processCardPayment']({'paymentId':_0x3ce51a['id'],'orderId':_0x3ce51a[_0x2a5256(0x99)]||_0x3ce51a['id'],'amount':_0x3ce51a[_0x2a5256(0xcc)],'currency':_0x3ce51a['currency'],'cardData':_0x28dc0c,'resultUrl':_0x48f139,'returnUrl':_0xa5e699,'cardHolder':_0x4815b4,'browser':_0x21373f});console[_0x2a5256(0xdc)](_0x2a5256(0x7d),_0x18811c);const _0x30ad90={'status':_0x18811c[_0x2a5256(0xb9)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x18811c[_0x2a5256(0xb9)]===_0x2a5256(0xc6))_0x30ad90[_0x2a5256(0xa1)]=new Date(),_0x30ad90[_0x2a5256(0xa8)]=_0x18811c[_0x2a5256(0xe1)];else _0x18811c[_0x2a5256(0xb9)]==='FAILED'&&(_0x30ad90[_0x2a5256(0xac)]='Card\x20payment\x20failed');_0x30ad90[_0x2a5256(0x6d)]='mastercard';if(_0x28dc0c[_0x2a5256(0xee)]){const _0x1992f5=_0x28dc0c[_0x2a5256(0xee)][_0x2a5256(0xdd)](/[\s-]/g,'');_0x30ad90['cardLast4']=_0x1992f5[_0x2a5256(0x8f)](-0x4),console['log']('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x30ad90[_0x2a5256(0xea)]);}await database_1[_0x2a5256(0x6b)]['payment'][_0x2a5256(0xc4)]({'where':{'id':_0x3ce51a['id']},'data':_0x30ad90}),await database_1[_0x2a5256(0x6b)][_0x2a5256(0xb4)]['create']({'data':{'paymentId':_0x3ce51a['id'],'shopId':_0x3ce51a['shopId'],'event':_0x2a5256(0x93)+_0x18811c[_0x2a5256(0xb9)]?.[_0x2a5256(0xdf)](),'statusCode':0xc8,'responseBody':JSON[_0x2a5256(0xc7)]({'oldStatus':_0x2a5256(0x92),'newStatus':_0x18811c[_0x2a5256(0xb9)],'gatewayPaymentId':_0x18811c[_0x2a5256(0xe1)],'requires3ds':_0x18811c[_0x2a5256(0xcf)],'processedAt':new Date()['toISOString']()})}});if(_0x18811c[_0x2a5256(0x86)]){await this['sendShopWebhook'](_0x3ce51a,_0x18811c[_0x2a5256(0xb9)],_0x18811c[_0x2a5256(0xe1)]),await this[_0x2a5256(0x74)](_0x3ce51a,_0x18811c[_0x2a5256(0xb9)]);if(_0x18811c[_0x2a5256(0xb9)]==='PAID'){console['log']('üìà\x20MasterCard\x20payment\x20'+_0x945585+_0x2a5256(0xad));try{const {PaymentLinkService:_0x49d166}=await Promise[_0x2a5256(0x72)]()[_0x2a5256(0xd7)](()=>__importStar(require(_0x2a5256(0x95)))),_0x2b3c1f=new _0x49d166();await _0x2b3c1f[_0x2a5256(0xa0)](_0x945585),console[_0x2a5256(0xdc)](_0x2a5256(0x78)+_0x945585);}catch(_0xaf004c){console['error'](_0x2a5256(0x9a),_0xaf004c);}}}console[_0x2a5256(0xdc)](_0x2a5256(0xaa)+_0x945585+_0x2a5256(0xb1)+_0x18811c[_0x2a5256(0xb9)]);if(_0x18811c['status']===_0x2a5256(0xc6))_0x1f1957[_0x2a5256(0x77)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2a5256(0xc6),'gatewayPaymentId':_0x18811c[_0x2a5256(0xe1)],'redirectUrl':_0xa5e699,'final':!![]}});else _0x18811c[_0x2a5256(0xcf)]&&_0x18811c['threeds_url']?_0x1f1957[_0x2a5256(0x77)]({'success':!![],'message':_0x2a5256(0x73),'result':{'status':_0x2a5256(0x92),'gatewayPaymentId':_0x18811c['gateway_payment_id'],'redirectUrl':_0x18811c[_0x2a5256(0x7c)],'requires3ds':!![],'final':![]}}):_0x1f1957[_0x2a5256(0xb9)](0x190)[_0x2a5256(0x77)]({'success':![],'message':_0x2a5256(0x84),'result':{'status':_0x2a5256(0xd3),'gatewayPaymentId':_0x18811c[_0x2a5256(0xe1)],'redirectUrl':_0x3ce51a[_0x2a5256(0x7f)],'final':!![]}});}catch(_0x4218a8){_0x21eadd(_0x4218a8);}},this[_0x354b45(0x7b)]=new paymentService_1['PaymentService'](),this[_0x354b45(0x94)]=new mastercardService_1[(_0x354b45(0x9f))](),this[_0x354b45(0xbd)]=new webhookService_1[(_0x354b45(0xd8))]();}async[a8_0x678738(0xbb)](_0x4d45e2,_0x2f3215,_0x3f646f){const _0x2d8c9a=a8_0x678738,_0x36fd56=Date['now']();try{const _0x162979=_0x4d45e2[_0x2d8c9a(0xa5)],_0x3bc815=_0x162979[_0x2d8c9a(0xdb)];if(!_0x3bc815?.[_0x2d8c9a(0xab)]){console[_0x2d8c9a(0xdc)](_0x2d8c9a(0xc1)+_0x162979['id']);return;}const _0x425ab1=_0x2f3215===_0x2d8c9a(0xc6)?_0x2d8c9a(0xae):_0x2d8c9a(0x98);let _0x1ca2bd=[];if(_0x3bc815[_0x2d8c9a(0xbc)])try{_0x1ca2bd=Array[_0x2d8c9a(0xaf)](_0x3bc815['webhookEvents'])?_0x3bc815['webhookEvents']:JSON[_0x2d8c9a(0xc2)](_0x3bc815[_0x2d8c9a(0xbc)]);}catch(_0x46bb07){console['error'](_0x2d8c9a(0xe2),_0x46bb07),_0x1ca2bd=[];}if(!_0x1ca2bd['includes'](_0x425ab1)){console[_0x2d8c9a(0xdc)](_0x2d8c9a(0xcb)+_0x425ab1+_0x2d8c9a(0xd5)+_0x162979['id']);return;}const _0x57f197={'event':_0x425ab1,'payment':{'id':_0x4d45e2['id'],'order_id':_0x4d45e2['orderId'],'gateway_order_id':_0x4d45e2[_0x2d8c9a(0x99)],'gateway':_0x2d8c9a(0x75),'amount':_0x4d45e2['amount'],'currency':_0x4d45e2[_0x2d8c9a(0x97)],'status':_0x2f3215[_0x2d8c9a(0xdf)](),'customer_email':_0x4d45e2[_0x2d8c9a(0xcd)],'customer_name':_0x4d45e2[_0x2d8c9a(0xd2)],'gateway_payment_id':_0x3f646f,'created_at':_0x4d45e2[_0x2d8c9a(0x6c)],'updated_at':new Date()}},_0x3e3e62=await fetch(_0x3bc815[_0x2d8c9a(0xab)],{'method':_0x2d8c9a(0xc8),'headers':{'Content-Type':_0x2d8c9a(0xb6),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x2d8c9a(0xc7)](_0x57f197)}),_0x1ff4ed=Date[_0x2d8c9a(0x82)]()-_0x36fd56;console[_0x2d8c9a(0xdc)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x3bc815[_0x2d8c9a(0xab)]+'\x20with\x20status\x20'+_0x3e3e62[_0x2d8c9a(0xb9)]+'\x20('+_0x1ff4ed+_0x2d8c9a(0xc9));}catch(_0x1cd732){console[_0x2d8c9a(0xb7)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x1cd732);}}async[a8_0x678738(0x74)](_0x9b1c72,_0x3a5959){const _0x2d50dd=a8_0x678738;try{const {telegramBotService:_0x3135d4}=await Promise[_0x2d50dd(0x72)]()[_0x2d50dd(0xd7)](()=>__importStar(require('../services/telegramBotService'))),_0x130370={'PAID':_0x2d50dd(0xde),'FAILED':_0x2d50dd(0xd9)},_0x2188b2=_0x130370[_0x3a5959];if(!_0x2188b2)return;await _0x3135d4[_0x2d50dd(0xe6)](_0x9b1c72[_0x2d50dd(0x85)],_0x9b1c72,_0x2188b2);}catch(_0x2cb1ff){console[_0x2d50dd(0xb7)](_0x2d50dd(0xe0),_0x2cb1ff);}}}exports[a8_0x678738(0xc3)]=PaymentController;