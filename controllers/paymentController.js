'use strict';const a8_0xf618d3=a8_0x24b9;(function(_0x548280,_0x28efce){const _0x4dbf07=a8_0x24b9,_0xb1d523=_0x548280();while(!![]){try{const _0x57c631=parseInt(_0x4dbf07(0x13d))/0x1+-parseInt(_0x4dbf07(0x140))/0x2+-parseInt(_0x4dbf07(0x100))/0x3+-parseInt(_0x4dbf07(0x134))/0x4*(parseInt(_0x4dbf07(0xd7))/0x5)+parseInt(_0x4dbf07(0x120))/0x6*(parseInt(_0x4dbf07(0x113))/0x7)+-parseInt(_0x4dbf07(0x11d))/0x8+parseInt(_0x4dbf07(0xfa))/0x9*(parseInt(_0x4dbf07(0x13e))/0xa);if(_0x57c631===_0x28efce)break;else _0xb1d523['push'](_0xb1d523['shift']());}catch(_0x551049){_0xb1d523['push'](_0xb1d523['shift']());}}}(a8_0x4ad7,0x5aa90));function a8_0x24b9(_0x37c514,_0x4938f6){const _0x4ad78d=a8_0x4ad7();return a8_0x24b9=function(_0x24b9ae,_0x1ccb8c){_0x24b9ae=_0x24b9ae-0xc3;let _0x4a7502=_0x4ad78d[_0x24b9ae];return _0x4a7502;},a8_0x24b9(_0x37c514,_0x4938f6);}function a8_0x4ad7(){const _0xeb1bf=['getOwnPropertyDescriptor','customerName','payment.failed','slice','status','paymentMethod','getPaymentStatus','üí≥\x20MasterCard\x20URLs:','masterCardService','payment','Payment\x20processed\x20successfully','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','then','params','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','1205073ZOjzBj','error','toLowerCase','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','final','paid','2112129nHEGnj','PENDING','now','hasOwnProperty','gatewayOrderId','customerIp','successUrl','shopId','mastercard','replace','__esModule','failUrl','createPublicPayment','sendPaymentStatusNotification','prototype','orderId','length','MasterCard\x20webhook\x20sent\x20to\x20','user_agent','7jiAaJV','isArray','findUnique','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','gateway','paymentService','üìù\x20Customer\x20data:','customerEmail','\x20\x20\x20Return\x20URL:\x20','__importStar','3060520SqYHhW','gateway_payment_id','stringify','2056818nnXviq','PaymentService','createdAt','webhookUrl','updatePaymentCustomerDataPublic','writable','WebhookService','failureMessage','üí≥\x20Processing\x20MasterCard\x20payment:\x20','__setModuleDefault','amount','Card\x20payment\x20failed','../services/webhookService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','\x20with\x20status\x20','payment.success','PaymentController','\x20not\x20enabled\x20for\x20shop\x20','updatePaymentCustomer','failed','2356MxnPpt','settings','defineProperty','MasterCardService','3DS\x20verification\x20required','threeds_url','Failed\x20to\x20send\x20MasterCard\x20webhook:','sendShopWebhook','\x20processed:\x20','535497eiodfj','70ZWDzQk','‚úÖ\x20MasterCard\x20payment\x20','20234YkaIzm','gatewayPaymentId','system','paidAt','FAILED','mastercard_','customerCountry','body','Payment\x20not\x20found','currency','update','toISOString','__importDefault','getPaymentById','üí≥\x20Card\x20holder:\x20','last_name','number','../services/paymentLinkService','Payment\x20created\x20successfully','get','../config/database','first_name','resolve','2950jixGeT','json','default','../services/telegramBotService','log','../services/gateways/mastercardService','Error\x20parsing\x20webhook\x20events:','Customer\x20data\x20updated\x20successfully','ms)','webhookEvents','webhookService','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','create','email',',\x20cannot\x20process','üìà\x20MasterCard\x20payment\x20','Webhook\x20event\x20','PAID','call','customerUa'];a8_0x4ad7=function(){return _0xeb1bf;};return a8_0x4ad7();}var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x13c3c4,_0x405043,_0x4834d2,_0x3680fc){const _0x1af2dd=a8_0x24b9;if(_0x3680fc===undefined)_0x3680fc=_0x4834d2;var _0xa125=Object[_0x1af2dd(0xeb)](_0x405043,_0x4834d2);(!_0xa125||(_0x1af2dd(0xd3)in _0xa125?!_0x405043[_0x1af2dd(0x10a)]:_0xa125[_0x1af2dd(0x125)]||_0xa125['configurable']))&&(_0xa125={'enumerable':!![],'get':function(){return _0x405043[_0x4834d2];}}),Object[_0x1af2dd(0x136)](_0x13c3c4,_0x3680fc,_0xa125);}:function(_0x463739,_0x24ed9f,_0x544380,_0x431207){if(_0x431207===undefined)_0x431207=_0x544380;_0x463739[_0x431207]=_0x24ed9f[_0x544380];}),__setModuleDefault=this&&this[a8_0xf618d3(0x129)]||(Object[a8_0xf618d3(0xe3)]?function(_0x7ff244,_0x1fed2f){const _0x418d65=a8_0xf618d3;Object['defineProperty'](_0x7ff244,_0x418d65(0xd9),{'enumerable':!![],'value':_0x1fed2f});}:function(_0x48e244,_0x389339){const _0x533760=a8_0xf618d3;_0x48e244[_0x533760(0xd9)]=_0x389339;}),__importStar=this&&this[a8_0xf618d3(0x11c)]||(function(){var _0x79ca76=function(_0x59e8c5){return _0x79ca76=Object['getOwnPropertyNames']||function(_0x16d5c0){const _0x5d8c59=a8_0x24b9;var _0x25540b=[];for(var _0x3abf1d in _0x16d5c0)if(Object[_0x5d8c59(0x10e)][_0x5d8c59(0x103)][_0x5d8c59(0xe9)](_0x16d5c0,_0x3abf1d))_0x25540b[_0x25540b['length']]=_0x3abf1d;return _0x25540b;},_0x79ca76(_0x59e8c5);};return function(_0x19e51d){const _0x6519ee=a8_0x24b9;if(_0x19e51d&&_0x19e51d[_0x6519ee(0x10a)])return _0x19e51d;var _0x2e003e={};if(_0x19e51d!=null){for(var _0x1b69fa=_0x79ca76(_0x19e51d),_0x845407=0x0;_0x845407<_0x1b69fa[_0x6519ee(0x110)];_0x845407++)if(_0x1b69fa[_0x845407]!=='default')__createBinding(_0x2e003e,_0x19e51d,_0x1b69fa[_0x845407]);}return __setModuleDefault(_0x2e003e,_0x19e51d),_0x2e003e;};}()),__importDefault=this&&this[a8_0xf618d3(0xcc)]||function(_0x41c131){const _0x1ea3b6=a8_0xf618d3;return _0x41c131&&_0x41c131[_0x1ea3b6(0x10a)]?_0x41c131:{'default':_0x41c131};};Object[a8_0xf618d3(0x136)](exports,'__esModule',{'value':!![]}),exports[a8_0xf618d3(0x130)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0xf618d3(0xdc)),webhookService_1=require(a8_0xf618d3(0x12c)),database_1=__importDefault(require(a8_0xf618d3(0xd4)));class PaymentController{constructor(){const _0x1816ac=a8_0xf618d3;this[_0x1816ac(0x10c)]=async(_0x5d7107,_0x3ebabe,_0x2a76d5)=>{const _0x133a08=_0x1816ac;try{const _0xae5e7a=_0x5d7107[_0x133a08(0xc7)],_0x59a5cb=await this['paymentService'][_0x133a08(0x10c)](_0xae5e7a);_0x3ebabe['status'](0xc9)[_0x133a08(0xd8)]({'success':!![],'message':_0x133a08(0xd2),'result':_0x59a5cb});}catch(_0x3b0d34){_0x2a76d5(_0x3b0d34);}},this[_0x1816ac(0xf1)]=async(_0x3c7e5d,_0x42eaae,_0x4d2ffb)=>{const _0x27ddb9=_0x1816ac;try{const {id:_0x509608}=_0x3c7e5d[_0x27ddb9(0xf8)],_0x192f06=await this[_0x27ddb9(0x118)][_0x27ddb9(0xf1)](_0x509608);if(!_0x192f06)return _0x42eaae[_0x27ddb9(0xef)](0x194)[_0x27ddb9(0xd8)]({'success':![],'message':_0x27ddb9(0xc8)});_0x42eaae[_0x27ddb9(0xd8)]({'success':!![],'result':_0x192f06});}catch(_0x397971){_0x4d2ffb(_0x397971);}},this['getPaymentById']=async(_0x5d802a,_0x32e9cc,_0x3569ae)=>{const _0x232b80=_0x1816ac;try{const {id:_0x3fe77a}=_0x5d802a[_0x232b80(0xf8)],_0x355d86=await this['paymentService'][_0x232b80(0xcd)](_0x3fe77a);if(!_0x355d86)return _0x32e9cc[_0x232b80(0xef)](0x194)[_0x232b80(0xd8)]({'success':![],'message':_0x232b80(0xc8)});_0x32e9cc[_0x232b80(0xd8)]({'success':!![],'result':_0x355d86});}catch(_0x3c444f){_0x3569ae(_0x3c444f);}},this[_0x1816ac(0x132)]=async(_0x4026d7,_0x553a19,_0x3a02ed)=>{const _0x52630e=_0x1816ac;try{const {id:_0x3ae0c2}=_0x4026d7[_0x52630e(0xf8)],_0x3c3d42=_0x4026d7[_0x52630e(0xc7)];console[_0x52630e(0xdb)](_0x52630e(0xe2)+_0x3ae0c2),console['log'](_0x52630e(0x119),_0x3c3d42);const _0x15338c=await this[_0x52630e(0x118)][_0x52630e(0x124)](_0x3ae0c2,_0x3c3d42);if(!_0x15338c)return _0x553a19[_0x52630e(0xef)](0x194)[_0x52630e(0xd8)]({'success':![],'message':_0x52630e(0xc8)});_0x553a19[_0x52630e(0xd8)]({'success':!![],'message':_0x52630e(0xde),'result':{'paymentId':_0x15338c['id'],'customerIp':_0x15338c[_0x52630e(0x105)],'customerUa':_0x15338c[_0x52630e(0xea)],'customerCountry':_0x15338c[_0x52630e(0xc6)],'updatedAt':_0x15338c['updatedAt']}});}catch(_0x55492f){_0x3a02ed(_0x55492f);}},this['processMasterCardPayment']=async(_0x53fd93,_0x104c6b,_0x518890)=>{const _0x5e722e=_0x1816ac;try{const {id:_0x2902ab}=_0x53fd93[_0x5e722e(0xf8)],{cardData:_0x268f2e,cardHolder:_0xfeedd2,browser:_0x217a2c}=_0x53fd93[_0x5e722e(0xc7)];console[_0x5e722e(0xdb)](_0x5e722e(0x128)+_0x2902ab),console[_0x5e722e(0xdb)](_0x5e722e(0xce)+_0xfeedd2[_0x5e722e(0xd5)]+'\x20'+_0xfeedd2[_0x5e722e(0xcf)]+'\x20('+_0xfeedd2['email']+')'),console[_0x5e722e(0xdb)]('üí≥\x20Browser\x20IP:\x20'+_0x217a2c['ip']);const _0x34f03c={'customerName':_0xfeedd2[_0x5e722e(0xd5)]+'\x20'+_0xfeedd2[_0x5e722e(0xcf)],'customerEmail':_0xfeedd2[_0x5e722e(0xe4)],'customerIp':_0x217a2c['ip'],'customerUa':_0x217a2c[_0x5e722e(0x112)]},_0x1b112e=await database_1[_0x5e722e(0xd9)][_0x5e722e(0xf4)][_0x5e722e(0x115)]({'where':{'id':_0x2902ab},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1b112e)return _0x104c6b[_0x5e722e(0xef)](0x194)['json']({'success':![],'message':_0x5e722e(0xc8)});if(_0x1b112e[_0x5e722e(0x117)]!==_0x5e722e(0x108))return _0x104c6b[_0x5e722e(0xef)](0x190)[_0x5e722e(0xd8)]({'success':![],'message':_0x5e722e(0x12d)});if(_0x1b112e['status']!==_0x5e722e(0x101))return _0x104c6b['status'](0x190)[_0x5e722e(0xd8)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x1b112e[_0x5e722e(0xef)]+_0x5e722e(0xe5)});await database_1[_0x5e722e(0xd9)][_0x5e722e(0xf4)]['update']({'where':{'id':_0x2902ab},'data':{..._0x34f03c,'updatedAt':new Date()}});const _0x243b9a='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0xe1b9f0=_0x1b112e[_0x5e722e(0x106)];console['log'](_0x5e722e(0xf2)),console[_0x5e722e(0xdb)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x243b9a),console[_0x5e722e(0xdb)](_0x5e722e(0x11b)+_0xe1b9f0);const _0x3f0e60={'first_name':_0xfeedd2[_0x5e722e(0xd5)],'last_name':_0xfeedd2['last_name'],'email':_0xfeedd2['email']},_0xff3dc6=await this[_0x5e722e(0xf3)]['processCardPayment']({'paymentId':_0x1b112e['id'],'orderId':_0x1b112e[_0x5e722e(0x104)]||_0x1b112e['id'],'amount':_0x1b112e['amount'],'currency':_0x1b112e[_0x5e722e(0xc9)],'cardData':_0x268f2e,'resultUrl':_0x243b9a,'returnUrl':_0xe1b9f0,'cardHolder':_0x3f0e60,'browser':_0x217a2c});console[_0x5e722e(0xdb)]('üí≥\x20MasterCard\x20result:',_0xff3dc6);const _0x3f6a64={'status':_0xff3dc6[_0x5e722e(0xef)],'updatedAt':new Date(),'statusChangedBy':_0x5e722e(0x142),'statusChangedAt':new Date()};_0xff3dc6[_0x5e722e(0x11e)]&&(_0x3f6a64[_0x5e722e(0x141)]=_0xff3dc6[_0x5e722e(0x11e)],console[_0x5e722e(0xdb)]('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0xff3dc6[_0x5e722e(0x11e)]));if(_0xff3dc6[_0x5e722e(0xef)]===_0x5e722e(0xe8))_0x3f6a64[_0x5e722e(0xc3)]=new Date();else _0xff3dc6[_0x5e722e(0xef)]===_0x5e722e(0xc4)&&(_0x3f6a64[_0x5e722e(0x127)]=_0x5e722e(0x12b));_0x3f6a64[_0x5e722e(0xf0)]=_0x5e722e(0x108);if(_0x268f2e[_0x5e722e(0xd0)]){const _0x79d056=_0x268f2e['number'][_0x5e722e(0x109)](/[\s-]/g,'');_0x3f6a64['cardLast4']=_0x79d056[_0x5e722e(0xee)](-0x4),console[_0x5e722e(0xdb)](_0x5e722e(0xf9)+_0x3f6a64['cardLast4']);}await database_1[_0x5e722e(0xd9)]['payment'][_0x5e722e(0xca)]({'where':{'id':_0x1b112e['id']},'data':_0x3f6a64}),await database_1[_0x5e722e(0xd9)]['webhookLog'][_0x5e722e(0xe3)]({'data':{'paymentId':_0x1b112e['id'],'shopId':_0x1b112e[_0x5e722e(0x107)],'event':_0x5e722e(0xc5)+_0xff3dc6[_0x5e722e(0xef)]?.[_0x5e722e(0xfc)](),'statusCode':0xc8,'responseBody':JSON[_0x5e722e(0x11f)]({'oldStatus':'PENDING','newStatus':_0xff3dc6[_0x5e722e(0xef)],'gatewayPaymentId':_0xff3dc6[_0x5e722e(0x11e)],'requires3ds':_0xff3dc6['requires_3ds'],'processedAt':new Date()[_0x5e722e(0xcb)]()})}});if(_0xff3dc6[_0x5e722e(0xfe)]){await this[_0x5e722e(0x13b)](_0x1b112e,_0xff3dc6[_0x5e722e(0xef)],_0xff3dc6['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x1b112e,_0xff3dc6['status']);if(_0xff3dc6['status']===_0x5e722e(0xe8)){console[_0x5e722e(0xdb)](_0x5e722e(0xe6)+_0x2902ab+_0x5e722e(0xf6));try{const {PaymentLinkService:_0x49f3f9}=await Promise[_0x5e722e(0xd6)]()[_0x5e722e(0xf7)](()=>__importStar(require(_0x5e722e(0xd1)))),_0x5c0663=new _0x49f3f9();await _0x5c0663['handleSuccessfulPayment'](_0x2902ab),console[_0x5e722e(0xdb)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x2902ab);}catch(_0x3507b6){console[_0x5e722e(0xfb)](_0x5e722e(0x116),_0x3507b6);}}}console['log'](_0x5e722e(0x13f)+_0x2902ab+_0x5e722e(0x13c)+_0xff3dc6[_0x5e722e(0xef)]);if(_0xff3dc6[_0x5e722e(0xef)]==='PAID')_0x104c6b[_0x5e722e(0xd8)]({'success':!![],'message':_0x5e722e(0xf5),'result':{'status':'PAID','gatewayPaymentId':_0xff3dc6[_0x5e722e(0x11e)],'redirectUrl':_0xe1b9f0,'final':!![]}});else _0xff3dc6['requires_3ds']&&_0xff3dc6['threeds_url']?_0x104c6b['json']({'success':!![],'message':_0x5e722e(0x138),'result':{'status':_0x5e722e(0x101),'gatewayPaymentId':_0xff3dc6['gateway_payment_id'],'redirectUrl':_0xff3dc6[_0x5e722e(0x139)],'requires3ds':!![],'final':![]}}):_0x104c6b['status'](0x190)[_0x5e722e(0xd8)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x5e722e(0xc4),'gatewayPaymentId':_0xff3dc6[_0x5e722e(0x11e)],'redirectUrl':_0x1b112e[_0x5e722e(0x10b)],'final':!![]}});}catch(_0x3cc183){_0x518890(_0x3cc183);}},this[_0x1816ac(0x118)]=new paymentService_1[(_0x1816ac(0x121))](),this[_0x1816ac(0xf3)]=new mastercardService_1[(_0x1816ac(0x137))](),this[_0x1816ac(0xe1)]=new webhookService_1[(_0x1816ac(0x126))]();}async[a8_0xf618d3(0x13b)](_0x161463,_0x48b815,_0x3b592a){const _0x3419e4=a8_0xf618d3,_0xb86759=Date[_0x3419e4(0x102)]();try{const _0x3c47bd=_0x161463['shop'],_0x3644c9=_0x3c47bd[_0x3419e4(0x135)];if(!_0x3644c9?.[_0x3419e4(0x123)]){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3c47bd['id']);return;}const _0x12ffcf=_0x48b815==='PAID'?_0x3419e4(0x12f):_0x3419e4(0xed);let _0x5ec5c3=[];if(_0x3644c9[_0x3419e4(0xe0)])try{_0x5ec5c3=Array[_0x3419e4(0x114)](_0x3644c9[_0x3419e4(0xe0)])?_0x3644c9['webhookEvents']:JSON['parse'](_0x3644c9[_0x3419e4(0xe0)]);}catch(_0x2584f4){console[_0x3419e4(0xfb)](_0x3419e4(0xdd),_0x2584f4),_0x5ec5c3=[];}if(!_0x5ec5c3['includes'](_0x12ffcf)){console[_0x3419e4(0xdb)](_0x3419e4(0xe7)+_0x12ffcf+_0x3419e4(0x131)+_0x3c47bd['id']);return;}const _0x3ac7d3={'event':_0x12ffcf,'payment':{'id':_0x161463['id'],'order_id':_0x161463[_0x3419e4(0x10f)],'gateway_order_id':_0x161463[_0x3419e4(0x104)],'gateway':'1111','amount':_0x161463[_0x3419e4(0x12a)],'currency':_0x161463[_0x3419e4(0xc9)],'status':_0x48b815[_0x3419e4(0xfc)](),'customer_email':_0x161463[_0x3419e4(0x11a)],'customer_name':_0x161463[_0x3419e4(0xec)],'gateway_payment_id':_0x3b592a,'created_at':_0x161463[_0x3419e4(0x122)],'updated_at':new Date()}},_0x1a19b7=await fetch(_0x3644c9['webhookUrl'],{'method':'POST','headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x3419e4(0x11f)](_0x3ac7d3)}),_0x4e70ef=Date[_0x3419e4(0x102)]()-_0xb86759;console['log'](_0x3419e4(0x111)+_0x3644c9[_0x3419e4(0x123)]+_0x3419e4(0x12e)+_0x1a19b7[_0x3419e4(0xef)]+'\x20('+_0x4e70ef+_0x3419e4(0xdf));}catch(_0x316ecd){console[_0x3419e4(0xfb)](_0x3419e4(0x13a),_0x316ecd);}}async[a8_0xf618d3(0x10d)](_0x4dfb05,_0x12ea9d){const _0xae0a12=a8_0xf618d3;try{const {telegramBotService:_0x2687c5}=await Promise[_0xae0a12(0xd6)]()[_0xae0a12(0xf7)](()=>__importStar(require(_0xae0a12(0xda)))),_0x11802f={'PAID':_0xae0a12(0xff),'FAILED':_0xae0a12(0x133)},_0x524fd7=_0x11802f[_0x12ea9d];if(!_0x524fd7)return;await _0x2687c5['sendPaymentNotification'](_0x4dfb05[_0xae0a12(0x107)],_0x4dfb05,_0x524fd7);}catch(_0x1dbd80){console[_0xae0a12(0xfb)](_0xae0a12(0xfd),_0x1dbd80);}}}exports['PaymentController']=PaymentController;