'use strict';const a8_0x14c484=a8_0x56f8;function a8_0x56f8(_0x2a85d2,_0x411a42){const _0xf681a7=a8_0xf681();return a8_0x56f8=function(_0x56f8f9,_0x2473f8){_0x56f8f9=_0x56f8f9-0x10c;let _0x3a8f6e=_0xf681a7[_0x56f8f9];return _0x3a8f6e;},a8_0x56f8(_0x2a85d2,_0x411a42);}(function(_0x58a75e,_0x4dd0b1){const _0x25efbc=a8_0x56f8,_0x4af742=_0x58a75e();while(!![]){try{const _0x2fdf6a=-parseInt(_0x25efbc(0x13a))/0x1+-parseInt(_0x25efbc(0x164))/0x2*(parseInt(_0x25efbc(0x11f))/0x3)+parseInt(_0x25efbc(0x171))/0x4+-parseInt(_0x25efbc(0x130))/0x5+parseInt(_0x25efbc(0x14a))/0x6+parseInt(_0x25efbc(0x118))/0x7*(-parseInt(_0x25efbc(0x119))/0x8)+-parseInt(_0x25efbc(0x141))/0x9*(-parseInt(_0x25efbc(0x137))/0xa);if(_0x2fdf6a===_0x4dd0b1)break;else _0x4af742['push'](_0x4af742['shift']());}catch(_0x36249e){_0x4af742['push'](_0x4af742['shift']());}}}(a8_0xf681,0xc6237));var __createBinding=this&&this[a8_0x14c484(0x172)]||(Object[a8_0x14c484(0x13e)]?function(_0x4a6be1,_0xc82769,_0x2a3770,_0x569dfb){const _0x40be8c=a8_0x14c484;if(_0x569dfb===undefined)_0x569dfb=_0x2a3770;var _0x182c7a=Object[_0x40be8c(0x142)](_0xc82769,_0x2a3770);(!_0x182c7a||(_0x40be8c(0x170)in _0x182c7a?!_0xc82769[_0x40be8c(0x114)]:_0x182c7a[_0x40be8c(0x177)]||_0x182c7a[_0x40be8c(0x12f)]))&&(_0x182c7a={'enumerable':!![],'get':function(){return _0xc82769[_0x2a3770];}}),Object[_0x40be8c(0x16a)](_0x4a6be1,_0x569dfb,_0x182c7a);}:function(_0x3e3039,_0x44504f,_0x43d14c,_0x2baa10){if(_0x2baa10===undefined)_0x2baa10=_0x43d14c;_0x3e3039[_0x2baa10]=_0x44504f[_0x43d14c];}),__setModuleDefault=this&&this[a8_0x14c484(0x111)]||(Object[a8_0x14c484(0x13e)]?function(_0x2e782b,_0x5e43bb){const _0x4dbe=a8_0x14c484;Object[_0x4dbe(0x16a)](_0x2e782b,_0x4dbe(0x128),{'enumerable':!![],'value':_0x5e43bb});}:function(_0x4bae79,_0x5e1bdd){const _0x486f74=a8_0x14c484;_0x4bae79[_0x486f74(0x128)]=_0x5e1bdd;}),__importStar=this&&this[a8_0x14c484(0x129)]||(function(){var _0x64b438=function(_0x211099){const _0x5dc27a=a8_0x56f8;return _0x64b438=Object[_0x5dc27a(0x116)]||function(_0x578e75){const _0x244b6d=_0x5dc27a;var _0x3410a4=[];for(var _0x2bcb90 in _0x578e75)if(Object[_0x244b6d(0x163)][_0x244b6d(0x11c)][_0x244b6d(0x143)](_0x578e75,_0x2bcb90))_0x3410a4[_0x3410a4[_0x244b6d(0x10f)]]=_0x2bcb90;return _0x3410a4;},_0x64b438(_0x211099);};return function(_0x277ba3){const _0x1421fe=a8_0x56f8;if(_0x277ba3&&_0x277ba3['__esModule'])return _0x277ba3;var _0x1383f3={};if(_0x277ba3!=null){for(var _0x4ad7e0=_0x64b438(_0x277ba3),_0x4dc8df=0x0;_0x4dc8df<_0x4ad7e0[_0x1421fe(0x10f)];_0x4dc8df++)if(_0x4ad7e0[_0x4dc8df]!==_0x1421fe(0x128))__createBinding(_0x1383f3,_0x277ba3,_0x4ad7e0[_0x4dc8df]);}return __setModuleDefault(_0x1383f3,_0x277ba3),_0x1383f3;};}()),__importDefault=this&&this[a8_0x14c484(0x166)]||function(_0x197386){const _0x21b74c=a8_0x14c484;return _0x197386&&_0x197386[_0x21b74c(0x114)]?_0x197386:{'default':_0x197386};};function a8_0xf681(){const _0x5e50ed=['body','webhookUrl','customerName','failureMessage','PaymentController','Payment\x20failed','Webhook\x20event\x20','gatewayPaymentId','prototype','3077896PCUCpb','1111','__importDefault','https://api.trapay.uk/api/webhooks/gateway/mastercard','json',',\x20cannot\x20process','defineProperty','../services/webhookService','WebhookService','PaymentService','Payment\x20processed\x20successfully','Payment\x20created\x20successfully','get','98588WnvpqM','__createBinding','now','ðŸ’³\x20MasterCard\x20URLs:','ðŸ’³\x20MasterCard\x20result:','webhookLog','writable','failed','mastercard','paid','paidAt','payment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ms)','mastercard_','getPaymentById','length','../services/telegramBotService','__setModuleDefault','\x20not\x20enabled\x20for\x20shop\x20','createPublicPayment','__esModule','gateway_payment_id','getOwnPropertyNames','failUrl','35zsnTGj','92656KHljwC','requires_3ds','status','hasOwnProperty','getPaymentStatus','webhookEvents','3PQSIuT','findUnique','MasterCard\x20webhook\x20sent\x20to\x20','FAILED','processMasterCardPayment','settings','MasterCardService','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','payment.success','default','__importStar','shopId','sendPaymentStatusNotification','isArray','toLowerCase','masterCardService','configurable','1899855wGqxkM','threeds_url','amount','currency','payment.failed','Payment\x20not\x20found','\x20\x20\x20Return\x20URL:\x20','23070BZAXej','application/json','error','38181RJUYFJ','gateway','params','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','create','gatewayOrderId','3DS\x20verification\x20required','6543AYouOG','getOwnPropertyDescriptor','call','Failed\x20to\x20send\x20MasterCard\x20webhook:','resolve','Error\x20parsing\x20webhook\x20events:','toISOString','../services/paymentService','PAID','6748494CCoSOA','POST','system','stringify','PENDING','orderId','\x20with\x20status\x20','log','paymentService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20status\x20is\x20','customerEmail','parse','final','sendShopWebhook','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','includes'];a8_0xf681=function(){return _0x5e50ed;};return a8_0xf681();}Object['defineProperty'](exports,a8_0x14c484(0x114),{'value':!![]}),exports[a8_0x14c484(0x15f)]=void 0x0;const paymentService_1=require(a8_0x14c484(0x148)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x14c484(0x16b)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x5e8bd5=a8_0x14c484;this[_0x5e8bd5(0x113)]=async(_0x5ba33e,_0x6bd4d8,_0x180757)=>{const _0xa16c96=_0x5e8bd5;try{const _0x4651d7=_0x5ba33e[_0xa16c96(0x15b)],_0x58f1f1=await this['paymentService'][_0xa16c96(0x113)](_0x4651d7);_0x6bd4d8[_0xa16c96(0x11b)](0xc9)[_0xa16c96(0x168)]({'success':!![],'message':_0xa16c96(0x16f),'result':_0x58f1f1});}catch(_0x947532){_0x180757(_0x947532);}},this[_0x5e8bd5(0x11d)]=async(_0x3e8f2d,_0x120b00,_0xc52ee3)=>{const _0x5aa03b=_0x5e8bd5;try{const {id:_0x4a71dc}=_0x3e8f2d[_0x5aa03b(0x13c)],_0x441441=await this[_0x5aa03b(0x152)]['getPaymentStatus'](_0x4a71dc);if(!_0x441441)return _0x120b00[_0x5aa03b(0x11b)](0x194)[_0x5aa03b(0x168)]({'success':![],'message':'Payment\x20not\x20found'});_0x120b00['json']({'success':!![],'result':_0x441441});}catch(_0x560f1f){_0xc52ee3(_0x560f1f);}},this[_0x5e8bd5(0x10e)]=async(_0x51f39e,_0x2b3e88,_0x3a37e7)=>{const _0x118f71=_0x5e8bd5;try{const {id:_0x3a0878}=_0x51f39e[_0x118f71(0x13c)],_0x3403fe=await this[_0x118f71(0x152)][_0x118f71(0x10e)](_0x3a0878);if(!_0x3403fe)return _0x2b3e88[_0x118f71(0x11b)](0x194)[_0x118f71(0x168)]({'success':![],'message':'Payment\x20not\x20found'});_0x2b3e88[_0x118f71(0x168)]({'success':!![],'result':_0x3403fe});}catch(_0x4aba05){_0x3a37e7(_0x4aba05);}},this[_0x5e8bd5(0x123)]=async(_0x3626c1,_0x4f8222,_0x40783e)=>{const _0x3ebaca=_0x5e8bd5;try{const {id:_0xe484cd}=_0x3626c1[_0x3ebaca(0x13c)],{cardData:_0x1e1ca6,cardHolder:_0x468363,browser:_0x1850dd}=_0x3626c1[_0x3ebaca(0x15b)];console['log'](_0x3ebaca(0x126)+_0xe484cd);const _0x16872d=await database_1['default'][_0x3ebaca(0x17c)][_0x3ebaca(0x120)]({'where':{'id':_0xe484cd},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x16872d)return _0x4f8222[_0x3ebaca(0x11b)](0x194)[_0x3ebaca(0x168)]({'success':![],'message':_0x3ebaca(0x135)});if(_0x16872d[_0x3ebaca(0x13b)]!==_0x3ebaca(0x179))return _0x4f8222[_0x3ebaca(0x11b)](0x190)['json']({'success':![],'message':_0x3ebaca(0x159)});if(_0x16872d[_0x3ebaca(0x11b)]!==_0x3ebaca(0x14e))return _0x4f8222[_0x3ebaca(0x11b)](0x190)[_0x3ebaca(0x168)]({'success':![],'message':_0x3ebaca(0x154)+_0x16872d[_0x3ebaca(0x11b)]+_0x3ebaca(0x169)});const _0x519c19=_0x3ebaca(0x167),_0x5a396e=_0x16872d['successUrl'];console[_0x3ebaca(0x151)](_0x3ebaca(0x174)),console[_0x3ebaca(0x151)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x519c19),console[_0x3ebaca(0x151)](_0x3ebaca(0x136)+_0x5a396e);const _0x15ec7e=await this[_0x3ebaca(0x12e)]['processCardPayment']({'paymentId':_0x16872d['id'],'orderId':_0x16872d[_0x3ebaca(0x13f)]||_0x16872d['id'],'amount':_0x16872d[_0x3ebaca(0x132)],'currency':_0x16872d['currency'],'cardData':_0x1e1ca6,'resultUrl':_0x519c19,'returnUrl':_0x5a396e,'cardHolder':_0x468363,'browser':_0x1850dd});console['log'](_0x3ebaca(0x175),_0x15ec7e);const _0xa4527f={'status':_0x15ec7e[_0x3ebaca(0x11b)],'updatedAt':new Date(),'statusChangedBy':_0x3ebaca(0x14c),'statusChangedAt':new Date()};if(_0x15ec7e[_0x3ebaca(0x11b)]===_0x3ebaca(0x149))_0xa4527f[_0x3ebaca(0x17b)]=new Date(),_0xa4527f[_0x3ebaca(0x162)]=_0x15ec7e[_0x3ebaca(0x115)];else _0x15ec7e[_0x3ebaca(0x11b)]===_0x3ebaca(0x122)&&(_0xa4527f[_0x3ebaca(0x15e)]='Card\x20payment\x20failed');_0xa4527f['paymentMethod']='mastercard',await database_1[_0x3ebaca(0x128)][_0x3ebaca(0x17c)]['update']({'where':{'id':_0x16872d['id']},'data':_0xa4527f}),await database_1[_0x3ebaca(0x128)][_0x3ebaca(0x176)][_0x3ebaca(0x13e)]({'data':{'paymentId':_0x16872d['id'],'shopId':_0x16872d[_0x3ebaca(0x12a)],'event':_0x3ebaca(0x10d)+_0x15ec7e[_0x3ebaca(0x11b)]?.[_0x3ebaca(0x12d)](),'statusCode':0xc8,'responseBody':JSON[_0x3ebaca(0x14d)]({'oldStatus':'PENDING','newStatus':_0x15ec7e[_0x3ebaca(0x11b)],'gatewayPaymentId':_0x15ec7e[_0x3ebaca(0x115)],'requires3ds':_0x15ec7e[_0x3ebaca(0x11a)],'processedAt':new Date()[_0x3ebaca(0x147)]()})}});_0x15ec7e[_0x3ebaca(0x157)]&&(await this['sendShopWebhook'](_0x16872d,_0x15ec7e['status'],_0x15ec7e['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x16872d,_0x15ec7e['status']));console[_0x3ebaca(0x151)]('âœ…\x20MasterCard\x20payment\x20'+_0xe484cd+'\x20processed:\x20'+_0x15ec7e[_0x3ebaca(0x11b)]);if(_0x15ec7e[_0x3ebaca(0x11b)]===_0x3ebaca(0x149))_0x4f8222[_0x3ebaca(0x168)]({'success':!![],'message':_0x3ebaca(0x16e),'result':{'status':_0x3ebaca(0x149),'gatewayPaymentId':_0x15ec7e[_0x3ebaca(0x115)],'redirectUrl':_0x5a396e,'final':!![]}});else _0x15ec7e[_0x3ebaca(0x11a)]&&_0x15ec7e[_0x3ebaca(0x131)]?_0x4f8222[_0x3ebaca(0x168)]({'success':!![],'message':_0x3ebaca(0x140),'result':{'status':_0x3ebaca(0x14e),'gatewayPaymentId':_0x15ec7e[_0x3ebaca(0x115)],'redirectUrl':_0x15ec7e[_0x3ebaca(0x131)],'requires3ds':!![],'final':![]}}):_0x4f8222['status'](0x190)[_0x3ebaca(0x168)]({'success':![],'message':_0x3ebaca(0x160),'result':{'status':_0x3ebaca(0x122),'gatewayPaymentId':_0x15ec7e[_0x3ebaca(0x115)],'redirectUrl':_0x16872d[_0x3ebaca(0x117)],'final':!![]}});}catch(_0x5682ed){_0x40783e(_0x5682ed);}},this[_0x5e8bd5(0x152)]=new paymentService_1[(_0x5e8bd5(0x16d))](),this[_0x5e8bd5(0x12e)]=new mastercardService_1[(_0x5e8bd5(0x125))](),this['webhookService']=new webhookService_1[(_0x5e8bd5(0x16c))]();}async[a8_0x14c484(0x158)](_0x57866a,_0x57b18e,_0x539edf){const _0x4f38ae=a8_0x14c484,_0x42ebe1=Date[_0x4f38ae(0x173)]();try{const _0x3da22a=_0x57866a['shop'],_0x410d3e=_0x3da22a[_0x4f38ae(0x124)];if(!_0x410d3e?.[_0x4f38ae(0x15c)]){console[_0x4f38ae(0x151)](_0x4f38ae(0x17d)+_0x3da22a['id']);return;}const _0x4cf9a1=_0x57b18e==='PAID'?_0x4f38ae(0x127):_0x4f38ae(0x134);let _0xcd157f=[];if(_0x410d3e['webhookEvents'])try{_0xcd157f=Array[_0x4f38ae(0x12c)](_0x410d3e[_0x4f38ae(0x11e)])?_0x410d3e['webhookEvents']:JSON[_0x4f38ae(0x156)](_0x410d3e[_0x4f38ae(0x11e)]);}catch(_0x473d2e){console[_0x4f38ae(0x139)](_0x4f38ae(0x146),_0x473d2e),_0xcd157f=[];}if(!_0xcd157f[_0x4f38ae(0x15a)](_0x4cf9a1)){console['log'](_0x4f38ae(0x161)+_0x4cf9a1+_0x4f38ae(0x112)+_0x3da22a['id']);return;}const _0x354f2e={'event':_0x4cf9a1,'payment':{'id':_0x57866a['id'],'order_id':_0x57866a[_0x4f38ae(0x14f)],'gateway_order_id':_0x57866a[_0x4f38ae(0x13f)],'gateway':_0x4f38ae(0x165),'amount':_0x57866a[_0x4f38ae(0x132)],'currency':_0x57866a[_0x4f38ae(0x133)],'status':_0x57b18e['toLowerCase'](),'customer_email':_0x57866a[_0x4f38ae(0x155)],'customer_name':_0x57866a[_0x4f38ae(0x15d)],'gateway_payment_id':_0x539edf,'created_at':_0x57866a['createdAt'],'updated_at':new Date()}},_0x28a721=await fetch(_0x410d3e[_0x4f38ae(0x15c)],{'method':_0x4f38ae(0x14b),'headers':{'Content-Type':_0x4f38ae(0x138),'User-Agent':_0x4f38ae(0x153)},'body':JSON[_0x4f38ae(0x14d)](_0x354f2e)}),_0x1fd51b=Date['now']()-_0x42ebe1;console[_0x4f38ae(0x151)](_0x4f38ae(0x121)+_0x410d3e[_0x4f38ae(0x15c)]+_0x4f38ae(0x150)+_0x28a721[_0x4f38ae(0x11b)]+'\x20('+_0x1fd51b+_0x4f38ae(0x10c));}catch(_0x1aed84){console[_0x4f38ae(0x139)](_0x4f38ae(0x144),_0x1aed84);}}async[a8_0x14c484(0x12b)](_0xc31850,_0x59aeec){const _0x429a36=a8_0x14c484;try{const {telegramBotService:_0xb43566}=await Promise[_0x429a36(0x145)]()['then'](()=>__importStar(require(_0x429a36(0x110)))),_0x5828cd={'PAID':_0x429a36(0x17a),'FAILED':_0x429a36(0x178)},_0x1dfe34=_0x5828cd[_0x59aeec];if(!_0x1dfe34)return;await _0xb43566['sendPaymentNotification'](_0xc31850[_0x429a36(0x12a)],_0xc31850,_0x1dfe34);}catch(_0x3ea9cb){console[_0x429a36(0x139)](_0x429a36(0x13d),_0x3ea9cb);}}}exports[a8_0x14c484(0x15f)]=PaymentController;