'use strict';const a8_0xae3de=a8_0x3d53;(function(_0x23ddf6,_0x41e850){const _0x4ca381=a8_0x3d53,_0x1ecf9e=_0x23ddf6();while(!![]){try{const _0x5e4827=parseInt(_0x4ca381(0x1d1))/0x1*(-parseInt(_0x4ca381(0x1bf))/0x2)+parseInt(_0x4ca381(0x219))/0x3*(-parseInt(_0x4ca381(0x208))/0x4)+-parseInt(_0x4ca381(0x216))/0x5*(parseInt(_0x4ca381(0x21c))/0x6)+parseInt(_0x4ca381(0x1f8))/0x7+parseInt(_0x4ca381(0x1b7))/0x8+-parseInt(_0x4ca381(0x1e3))/0x9+parseInt(_0x4ca381(0x1d0))/0xa;if(_0x5e4827===_0x41e850)break;else _0x1ecf9e['push'](_0x1ecf9e['shift']());}catch(_0x5dffbd){_0x1ecf9e['push'](_0x1ecf9e['shift']());}}}(a8_0x2c0e,0xeeee8));function a8_0x2c0e(){const _0x2696ac=['PaymentController','get','resolve','processCardPayment','üí≥\x20MasterCard\x20result:','application/json','POST','paidAt','gateway','8679501LUBmfT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','threeds_url','shopId','prototype','paid','getOwnPropertyNames','orderId','paymentService','mastercard_','payment.failed','3DS\x20verification\x20required','customerName','payment.success','currency','Webhook\x20event\x20','default','PAID','webhookService','https://api.trapay.uk/api/webhooks/gateway/mastercard','params','3399592jRXDhl','create','shop','\x20\x20\x20Return\x20URL:\x20','isArray','Payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','MasterCard\x20webhook\x20sent\x20to\x20','gateway_payment_id','webhookUrl','json','getPaymentStatus','body','masterCardService','includes','__importDefault','808qkspIX','webhookLog','customerUa','error','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20with\x20status\x20','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','sendShopWebhook','MasterCardService','payment','hasOwnProperty','../services/webhookService','üìù\x20Customer\x20data:','paymentMethod','4167225fQFjIR','createPublicPayment','Payment\x20not\x20found','13269HOBBzf','Card\x20payment\x20failed','system','12jjsaYV','../config/database','toLowerCase','status','1111','getOwnPropertyDescriptor',',\x20cannot\x20process','writable','üí≥\x20Processing\x20MasterCard\x20payment:\x20','PENDING','../services/gateways/mastercardService','getPaymentById','Customer\x20data\x20updated\x20successfully','webhookEvents','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','8174448hBKDjO','__importStar','customerCountry','__createBinding','settings','now','length','then','16mZchpK','toISOString','updatePaymentCustomerDataPublic','\x20processed:\x20','FAILED','stringify','ms)','updatePaymentCustomer','failUrl','../services/telegramBotService','findUnique','amount','log','update','__esModule','mastercard','successUrl','48778230stVbeS','235237uIuCIu','failed','__setModuleDefault','sendPaymentStatusNotification','failureMessage','üí≥\x20MasterCard\x20URLs:','Payment\x20processed\x20successfully','customerIp','defineProperty'];a8_0x2c0e=function(){return _0x2696ac;};return a8_0x2c0e();}var __createBinding=this&&this[a8_0xae3de(0x1ba)]||(Object[a8_0xae3de(0x1f9)]?function(_0x2c1e89,_0x30db9f,_0x5ba1ff,_0x571832){const _0x44c69d=a8_0xae3de;if(_0x571832===undefined)_0x571832=_0x5ba1ff;var _0x52c50c=Object[_0x44c69d(0x221)](_0x30db9f,_0x5ba1ff);(!_0x52c50c||(_0x44c69d(0x1db)in _0x52c50c?!_0x30db9f['__esModule']:_0x52c50c[_0x44c69d(0x223)]||_0x52c50c['configurable']))&&(_0x52c50c={'enumerable':!![],'get':function(){return _0x30db9f[_0x5ba1ff];}}),Object['defineProperty'](_0x2c1e89,_0x571832,_0x52c50c);}:function(_0x4a3311,_0x530792,_0x2cc399,_0x5991be){if(_0x5991be===undefined)_0x5991be=_0x2cc399;_0x4a3311[_0x5991be]=_0x530792[_0x2cc399];}),__setModuleDefault=this&&this[a8_0xae3de(0x1d3)]||(Object[a8_0xae3de(0x1f9)]?function(_0x23e709,_0x1cc2eb){const _0x25892f=a8_0xae3de;Object[_0x25892f(0x1d9)](_0x23e709,_0x25892f(0x1f3),{'enumerable':!![],'value':_0x1cc2eb});}:function(_0x50aad3,_0x1179d3){const _0x579258=a8_0xae3de;_0x50aad3[_0x579258(0x1f3)]=_0x1179d3;}),__importStar=this&&this[a8_0xae3de(0x1b8)]||(function(){var _0x5e5a76=function(_0x1a91ac){const _0x2fa1a7=a8_0x3d53;return _0x5e5a76=Object[_0x2fa1a7(0x1e9)]||function(_0x314f47){const _0x3a109d=_0x2fa1a7;var _0x480328=[];for(var _0x5e4cc0 in _0x314f47)if(Object[_0x3a109d(0x1e7)][_0x3a109d(0x212)]['call'](_0x314f47,_0x5e4cc0))_0x480328[_0x480328[_0x3a109d(0x1bd)]]=_0x5e4cc0;return _0x480328;},_0x5e5a76(_0x1a91ac);};return function(_0x2d32a2){const _0xe41642=a8_0x3d53;if(_0x2d32a2&&_0x2d32a2['__esModule'])return _0x2d32a2;var _0x35941b={};if(_0x2d32a2!=null){for(var _0xabc7f2=_0x5e5a76(_0x2d32a2),_0x38ac96=0x0;_0x38ac96<_0xabc7f2[_0xe41642(0x1bd)];_0x38ac96++)if(_0xabc7f2[_0x38ac96]!==_0xe41642(0x1f3))__createBinding(_0x35941b,_0x2d32a2,_0xabc7f2[_0x38ac96]);}return __setModuleDefault(_0x35941b,_0x2d32a2),_0x35941b;};}()),__importDefault=this&&this[a8_0xae3de(0x207)]||function(_0x148f24){const _0x857f63=a8_0xae3de;return _0x148f24&&_0x148f24[_0x857f63(0x1cd)]?_0x148f24:{'default':_0x148f24};};function a8_0x3d53(_0x5dc6f0,_0x4e269b){const _0x2c0e21=a8_0x2c0e();return a8_0x3d53=function(_0x3d5306,_0x5b065a){_0x3d5306=_0x3d5306-0x1b6;let _0x15bf1e=_0x2c0e21[_0x3d5306];return _0x15bf1e;},a8_0x3d53(_0x5dc6f0,_0x4e269b);}Object[a8_0xae3de(0x1d9)](exports,a8_0xae3de(0x1cd),{'value':!![]}),exports[a8_0xae3de(0x1da)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0xae3de(0x226)),webhookService_1=require(a8_0xae3de(0x213)),database_1=__importDefault(require(a8_0xae3de(0x21d)));class PaymentController{constructor(){const _0x54db7f=a8_0xae3de;this[_0x54db7f(0x217)]=async(_0x13558c,_0x3ecd64,_0x13434c)=>{const _0x366984=_0x54db7f;try{const _0x2a05f3=_0x13558c[_0x366984(0x204)],_0x641cf6=await this['paymentService'][_0x366984(0x217)](_0x2a05f3);_0x3ecd64[_0x366984(0x21f)](0xc9)[_0x366984(0x202)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x641cf6});}catch(_0x1009c8){_0x13434c(_0x1009c8);}},this[_0x54db7f(0x203)]=async(_0x4fe540,_0xc17753,_0x33da03)=>{const _0x24277a=_0x54db7f;try{const {id:_0x10ee0c}=_0x4fe540['params'],_0x1750bd=await this[_0x24277a(0x1eb)][_0x24277a(0x203)](_0x10ee0c);if(!_0x1750bd)return _0xc17753[_0x24277a(0x21f)](0x194)[_0x24277a(0x202)]({'success':![],'message':_0x24277a(0x218)});_0xc17753[_0x24277a(0x202)]({'success':!![],'result':_0x1750bd});}catch(_0x3feb34){_0x33da03(_0x3feb34);}},this[_0x54db7f(0x227)]=async(_0x53ea88,_0x3dc745,_0x142969)=>{const _0x436732=_0x54db7f;try{const {id:_0xd81db3}=_0x53ea88[_0x436732(0x1f7)],_0x435234=await this[_0x436732(0x1eb)][_0x436732(0x227)](_0xd81db3);if(!_0x435234)return _0x3dc745[_0x436732(0x21f)](0x194)[_0x436732(0x202)]({'success':![],'message':_0x436732(0x218)});_0x3dc745[_0x436732(0x202)]({'success':!![],'result':_0x435234});}catch(_0x20af75){_0x142969(_0x20af75);}},this[_0x54db7f(0x1c6)]=async(_0x486fd7,_0x4692cf,_0x36cc9f)=>{const _0x3841f6=_0x54db7f;try{const {id:_0x3a25bc}=_0x486fd7[_0x3841f6(0x1f7)],_0x1429f3=_0x486fd7[_0x3841f6(0x204)];console[_0x3841f6(0x1cb)](_0x3841f6(0x20e)+_0x3a25bc),console['log'](_0x3841f6(0x214),_0x1429f3);const _0x4e9e0b=await this[_0x3841f6(0x1eb)][_0x3841f6(0x1c1)](_0x3a25bc,_0x1429f3);if(!_0x4e9e0b)return _0x4692cf['status'](0x194)[_0x3841f6(0x202)]({'success':![],'message':'Payment\x20not\x20found'});_0x4692cf[_0x3841f6(0x202)]({'success':!![],'message':_0x3841f6(0x228),'result':{'paymentId':_0x4e9e0b['id'],'customerIp':_0x4e9e0b[_0x3841f6(0x1d8)],'customerUa':_0x4e9e0b[_0x3841f6(0x20a)],'customerCountry':_0x4e9e0b[_0x3841f6(0x1b9)],'updatedAt':_0x4e9e0b['updatedAt']}});}catch(_0x1d2e3b){_0x36cc9f(_0x1d2e3b);}},this['processMasterCardPayment']=async(_0x5be920,_0x240ebe,_0x2a3f24)=>{const _0x189a24=_0x54db7f;try{const {id:_0x153db2}=_0x5be920[_0x189a24(0x1f7)],{cardData:_0x2d4d55,cardHolder:_0x3f9382,browser:_0x1e79ae}=_0x5be920[_0x189a24(0x204)];console['log'](_0x189a24(0x224)+_0x153db2);const _0x5b7e39=await database_1[_0x189a24(0x1f3)]['payment'][_0x189a24(0x1c9)]({'where':{'id':_0x153db2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5b7e39)return _0x240ebe[_0x189a24(0x21f)](0x194)[_0x189a24(0x202)]({'success':![],'message':_0x189a24(0x218)});if(_0x5b7e39[_0x189a24(0x1e2)]!==_0x189a24(0x1ce))return _0x240ebe['status'](0x190)[_0x189a24(0x202)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x5b7e39['status']!=='PENDING')return _0x240ebe[_0x189a24(0x21f)](0x190)[_0x189a24(0x202)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5b7e39[_0x189a24(0x21f)]+_0x189a24(0x222)});const _0x2f0fa2=_0x189a24(0x1f6),_0xfc8ff7=_0x5b7e39[_0x189a24(0x1cf)];console[_0x189a24(0x1cb)](_0x189a24(0x1d6)),console[_0x189a24(0x1cb)](_0x189a24(0x1fe)+_0x2f0fa2),console[_0x189a24(0x1cb)](_0x189a24(0x1fb)+_0xfc8ff7);const _0xf2835=await this['masterCardService'][_0x189a24(0x1dd)]({'paymentId':_0x5b7e39['id'],'orderId':_0x5b7e39['gatewayOrderId']||_0x5b7e39['id'],'amount':_0x5b7e39['amount'],'currency':_0x5b7e39[_0x189a24(0x1f1)],'cardData':_0x2d4d55,'resultUrl':_0x2f0fa2,'returnUrl':_0xfc8ff7,'cardHolder':_0x3f9382,'browser':_0x1e79ae});console[_0x189a24(0x1cb)](_0x189a24(0x1de),_0xf2835);const _0x3f1d66={'status':_0xf2835['status'],'updatedAt':new Date(),'statusChangedBy':_0x189a24(0x21b),'statusChangedAt':new Date()};if(_0xf2835[_0x189a24(0x21f)]===_0x189a24(0x1f4))_0x3f1d66[_0x189a24(0x1e1)]=new Date(),_0x3f1d66['gatewayPaymentId']=_0xf2835[_0x189a24(0x200)];else _0xf2835[_0x189a24(0x21f)]==='FAILED'&&(_0x3f1d66[_0x189a24(0x1d5)]=_0x189a24(0x21a));_0x3f1d66[_0x189a24(0x215)]=_0x189a24(0x1ce),await database_1['default'][_0x189a24(0x211)][_0x189a24(0x1cc)]({'where':{'id':_0x5b7e39['id']},'data':_0x3f1d66}),await database_1['default'][_0x189a24(0x209)][_0x189a24(0x1f9)]({'data':{'paymentId':_0x5b7e39['id'],'shopId':_0x5b7e39[_0x189a24(0x1e6)],'event':_0x189a24(0x1ec)+_0xf2835[_0x189a24(0x21f)]?.[_0x189a24(0x21e)](),'statusCode':0xc8,'responseBody':JSON[_0x189a24(0x1c4)]({'oldStatus':_0x189a24(0x225),'newStatus':_0xf2835[_0x189a24(0x21f)],'gatewayPaymentId':_0xf2835[_0x189a24(0x200)],'requires3ds':_0xf2835['requires_3ds'],'processedAt':new Date()[_0x189a24(0x1c0)]()})}});_0xf2835['final']&&(await this[_0x189a24(0x20f)](_0x5b7e39,_0xf2835[_0x189a24(0x21f)],_0xf2835['gateway_payment_id']),await this[_0x189a24(0x1d4)](_0x5b7e39,_0xf2835[_0x189a24(0x21f)]));console['log']('‚úÖ\x20MasterCard\x20payment\x20'+_0x153db2+_0x189a24(0x1c2)+_0xf2835['status']);if(_0xf2835[_0x189a24(0x21f)]==='PAID')_0x240ebe[_0x189a24(0x202)]({'success':!![],'message':_0x189a24(0x1d7),'result':{'status':_0x189a24(0x1f4),'gatewayPaymentId':_0xf2835[_0x189a24(0x200)],'redirectUrl':_0xfc8ff7,'final':!![]}});else _0xf2835['requires_3ds']&&_0xf2835['threeds_url']?_0x240ebe[_0x189a24(0x202)]({'success':!![],'message':_0x189a24(0x1ee),'result':{'status':_0x189a24(0x225),'gatewayPaymentId':_0xf2835['gateway_payment_id'],'redirectUrl':_0xf2835[_0x189a24(0x1e5)],'requires3ds':!![],'final':![]}}):_0x240ebe[_0x189a24(0x21f)](0x190)[_0x189a24(0x202)]({'success':![],'message':_0x189a24(0x1fd),'result':{'status':_0x189a24(0x1c3),'gatewayPaymentId':_0xf2835[_0x189a24(0x200)],'redirectUrl':_0x5b7e39[_0x189a24(0x1c7)],'final':!![]}});}catch(_0x124a46){_0x2a3f24(_0x124a46);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x54db7f(0x205)]=new mastercardService_1[(_0x54db7f(0x210))](),this[_0x54db7f(0x1f5)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x24d10e,_0x3656b3,_0x1f1516){const _0x4ae67a=a8_0xae3de,_0x43a05f=Date[_0x4ae67a(0x1bc)]();try{const _0x53c70c=_0x24d10e[_0x4ae67a(0x1fa)],_0x2fbe46=_0x53c70c[_0x4ae67a(0x1bb)];if(!_0x2fbe46?.[_0x4ae67a(0x201)]){console[_0x4ae67a(0x1cb)](_0x4ae67a(0x20c)+_0x53c70c['id']);return;}const _0x4cd22e=_0x3656b3==='PAID'?_0x4ae67a(0x1f0):_0x4ae67a(0x1ed);let _0x5814de=[];if(_0x2fbe46[_0x4ae67a(0x229)])try{_0x5814de=Array[_0x4ae67a(0x1fc)](_0x2fbe46[_0x4ae67a(0x229)])?_0x2fbe46[_0x4ae67a(0x229)]:JSON['parse'](_0x2fbe46[_0x4ae67a(0x229)]);}catch(_0x3fc2b3){console[_0x4ae67a(0x20b)]('Error\x20parsing\x20webhook\x20events:',_0x3fc2b3),_0x5814de=[];}if(!_0x5814de[_0x4ae67a(0x206)](_0x4cd22e)){console[_0x4ae67a(0x1cb)](_0x4ae67a(0x1f2)+_0x4cd22e+'\x20not\x20enabled\x20for\x20shop\x20'+_0x53c70c['id']);return;}const _0xfac8e1={'event':_0x4cd22e,'payment':{'id':_0x24d10e['id'],'order_id':_0x24d10e[_0x4ae67a(0x1ea)],'gateway_order_id':_0x24d10e['gatewayOrderId'],'gateway':_0x4ae67a(0x220),'amount':_0x24d10e[_0x4ae67a(0x1ca)],'currency':_0x24d10e[_0x4ae67a(0x1f1)],'status':_0x3656b3[_0x4ae67a(0x21e)](),'customer_email':_0x24d10e['customerEmail'],'customer_name':_0x24d10e[_0x4ae67a(0x1ef)],'gateway_payment_id':_0x1f1516,'created_at':_0x24d10e['createdAt'],'updated_at':new Date()}},_0x556518=await fetch(_0x2fbe46['webhookUrl'],{'method':_0x4ae67a(0x1e0),'headers':{'Content-Type':_0x4ae67a(0x1df),'User-Agent':_0x4ae67a(0x1b6)},'body':JSON[_0x4ae67a(0x1c4)](_0xfac8e1)}),_0x561a04=Date[_0x4ae67a(0x1bc)]()-_0x43a05f;console[_0x4ae67a(0x1cb)](_0x4ae67a(0x1ff)+_0x2fbe46['webhookUrl']+_0x4ae67a(0x20d)+_0x556518[_0x4ae67a(0x21f)]+'\x20('+_0x561a04+_0x4ae67a(0x1c5));}catch(_0x465a6f){console[_0x4ae67a(0x20b)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x465a6f);}}async[a8_0xae3de(0x1d4)](_0x2272af,_0x3acee3){const _0x11b389=a8_0xae3de;try{const {telegramBotService:_0x5ddd73}=await Promise[_0x11b389(0x1dc)]()[_0x11b389(0x1be)](()=>__importStar(require(_0x11b389(0x1c8)))),_0x1c8b5b={'PAID':_0x11b389(0x1e8),'FAILED':_0x11b389(0x1d2)},_0x3b995a=_0x1c8b5b[_0x3acee3];if(!_0x3b995a)return;await _0x5ddd73['sendPaymentNotification'](_0x2272af[_0x11b389(0x1e6)],_0x2272af,_0x3b995a);}catch(_0x67f443){console[_0x11b389(0x20b)](_0x11b389(0x1e4),_0x67f443);}}}exports[a8_0xae3de(0x1da)]=PaymentController;