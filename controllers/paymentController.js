'use strict';const a8_0x1b70c4=a8_0x356c;(function(_0x24c971,_0x3ae8df){const _0x2c93f2=a8_0x356c,_0x2ae3f8=_0x24c971();while(!![]){try{const _0x4f252d=parseInt(_0x2c93f2(0x1bb))/0x1+-parseInt(_0x2c93f2(0x197))/0x2+-parseInt(_0x2c93f2(0x193))/0x3*(-parseInt(_0x2c93f2(0x19f))/0x4)+parseInt(_0x2c93f2(0x1ac))/0x5+parseInt(_0x2c93f2(0x1ba))/0x6*(-parseInt(_0x2c93f2(0x187))/0x7)+parseInt(_0x2c93f2(0x1cb))/0x8+-parseInt(_0x2c93f2(0x1c5))/0x9;if(_0x4f252d===_0x3ae8df)break;else _0x2ae3f8['push'](_0x2ae3f8['shift']());}catch(_0x5eccdc){_0x2ae3f8['push'](_0x2ae3f8['shift']());}}}(a8_0x362c,0x8fc20));function a8_0x362c(){const _0x27820c=['Error\x20parsing\x20webhook\x20events:','handleSuccessfulPayment','ms)','create','__importDefault','9746028dZILNb','gatewayPaymentId','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','../services/webhookService','then','6158664isVixy','1111','WebhookService','gateway','log','Payment\x20not\x20found','MasterCard\x20webhook\x20sent\x20to\x20','configurable','gatewayOrderId','last_name','📈\x20MasterCard\x20payment\x20','masterCardService','number','paid','successUrl','payment.failed','updatePaymentCustomer','sendPaymentNotification','call','threeds_url','PaymentController','failUrl','sendShopWebhook','findUnique','💳\x20MasterCard\x20URLs:','defineProperty','default','PaymentService','failed','PAID','Payment\x20created\x20successfully','\x20\x20\x20Result\x20URL\x20(webhook):\x20','updatedAt','user_agent','paymentMethod','amount','email','length','getPaymentById','first_name','customerEmail','3DS\x20verification\x20required','body','includes','customerName','../services/telegramBotService','writable','parse','__importStar','final','getPaymentStatus','now','gateway_payment_id','sendPaymentStatusNotification','json','payment','cardLast4','💳\x20MasterCard\x20result:','currency','POST','orderId','toLowerCase','customerCountry','301tgqRBQ','processMasterCardPayment','replace','💳\x20Processing\x20MasterCard\x20payment:\x20','__setModuleDefault','error',',\x20cannot\x20process','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','../services/gateways/mastercardService','\x20\x20\x20Return\x20URL:\x20','requires_3ds','__esModule','3DekeEH','params','shopId','hasOwnProperty','830420RIGTll','webhookEvents','getOwnPropertyDescriptor','paymentService','mastercard','💳\x20Browser\x20IP:\x20','status','shop','3847484kehUJe','customerUa','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','Card\x20payment\x20failed','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','mastercard_','getOwnPropertyNames','toISOString','createPublicPayment','FAILED','Webhook\x20event\x20','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Customer\x20data\x20updated\x20successfully','1630135MlKNzc','__createBinding','\x20not\x20enabled\x20for\x20shop\x20','settings','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','https://api.trapay.uk/api/webhooks/gateway/mastercard','Payment\x20processed\x20successfully','customerIp','stringify','\x20with\x20status\x20','resolve','PENDING','application/json','system','91902gdnbbw','687834prlByi','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','✅\x20MasterCard\x20payment\x20','prototype','../services/paymentLinkService'];a8_0x362c=function(){return _0x27820c;};return a8_0x362c();}var __createBinding=this&&this[a8_0x1b70c4(0x1ad)]||(Object[a8_0x1b70c4(0x1c3)]?function(_0x349533,_0x282973,_0x1b57a4,_0x9c99e8){const _0x2f2f35=a8_0x1b70c4;if(_0x9c99e8===undefined)_0x9c99e8=_0x1b57a4;var _0x28e871=Object[_0x2f2f35(0x199)](_0x282973,_0x1b57a4);(!_0x28e871||('get'in _0x28e871?!_0x282973[_0x2f2f35(0x192)]:_0x28e871[_0x2f2f35(0x176)]||_0x28e871[_0x2f2f35(0x1d2)]))&&(_0x28e871={'enumerable':!![],'get':function(){return _0x282973[_0x1b57a4];}}),Object[_0x2f2f35(0x1e4)](_0x349533,_0x9c99e8,_0x28e871);}:function(_0xdcaa90,_0x21fe41,_0x533ba0,_0x1ae317){if(_0x1ae317===undefined)_0x1ae317=_0x533ba0;_0xdcaa90[_0x1ae317]=_0x21fe41[_0x533ba0];}),__setModuleDefault=this&&this[a8_0x1b70c4(0x18b)]||(Object['create']?function(_0x2c09f4,_0x56b8a7){const _0x5c4496=a8_0x1b70c4;Object['defineProperty'](_0x2c09f4,_0x5c4496(0x1e5),{'enumerable':!![],'value':_0x56b8a7});}:function(_0x5d4dd7,_0x46d91c){const _0x4868a4=a8_0x1b70c4;_0x5d4dd7[_0x4868a4(0x1e5)]=_0x46d91c;}),__importStar=this&&this[a8_0x1b70c4(0x178)]||(function(){var _0x1db747=function(_0x12088d){const _0x47770f=a8_0x356c;return _0x1db747=Object[_0x47770f(0x1a5)]||function(_0x56a4f9){const _0x13dac2=_0x47770f;var _0x2ad541=[];for(var _0x3f719b in _0x56a4f9)if(Object[_0x13dac2(0x1be)][_0x13dac2(0x196)][_0x13dac2(0x1dd)](_0x56a4f9,_0x3f719b))_0x2ad541[_0x2ad541[_0x13dac2(0x16d)]]=_0x3f719b;return _0x2ad541;},_0x1db747(_0x12088d);};return function(_0x50e49c){const _0xf0a471=a8_0x356c;if(_0x50e49c&&_0x50e49c[_0xf0a471(0x192)])return _0x50e49c;var _0x5f129f={};if(_0x50e49c!=null){for(var _0xf3eeb6=_0x1db747(_0x50e49c),_0x27c212=0x0;_0x27c212<_0xf3eeb6['length'];_0x27c212++)if(_0xf3eeb6[_0x27c212]!==_0xf0a471(0x1e5))__createBinding(_0x5f129f,_0x50e49c,_0xf3eeb6[_0x27c212]);}return __setModuleDefault(_0x5f129f,_0x50e49c),_0x5f129f;};}()),__importDefault=this&&this[a8_0x1b70c4(0x1c4)]||function(_0x584e55){const _0x59ac14=a8_0x1b70c4;return _0x584e55&&_0x584e55[_0x59ac14(0x192)]?_0x584e55:{'default':_0x584e55};};Object[a8_0x1b70c4(0x1e4)](exports,a8_0x1b70c4(0x192),{'value':!![]}),exports['PaymentController']=void 0x0;function a8_0x356c(_0x299690,_0x1481d5){const _0x362c84=a8_0x362c();return a8_0x356c=function(_0x356c35,_0x46af4c){_0x356c35=_0x356c35-0x16d;let _0x44d00f=_0x362c84[_0x356c35];return _0x44d00f;},a8_0x356c(_0x299690,_0x1481d5);}const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x1b70c4(0x18f)),webhookService_1=require(a8_0x1b70c4(0x1c9)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0xc7b3f3=a8_0x1b70c4;this['createPublicPayment']=async(_0x437015,_0x35330c,_0x275718)=>{const _0x203f58=a8_0x356c;try{const _0x32fcc8=_0x437015[_0x203f58(0x172)],_0x5da046=await this['paymentService'][_0x203f58(0x1a7)](_0x32fcc8);_0x35330c['status'](0xc9)[_0x203f58(0x17e)]({'success':!![],'message':_0x203f58(0x1e9),'result':_0x5da046});}catch(_0x184036){_0x275718(_0x184036);}},this[_0xc7b3f3(0x17a)]=async(_0x2079e6,_0x527617,_0x3a9f6c)=>{const _0x48557e=_0xc7b3f3;try{const {id:_0x2d0c96}=_0x2079e6[_0x48557e(0x194)],_0x7ed69b=await this[_0x48557e(0x19a)][_0x48557e(0x17a)](_0x2d0c96);if(!_0x7ed69b)return _0x527617[_0x48557e(0x19d)](0x194)[_0x48557e(0x17e)]({'success':![],'message':_0x48557e(0x1d0)});_0x527617[_0x48557e(0x17e)]({'success':!![],'result':_0x7ed69b});}catch(_0x4e2e54){_0x3a9f6c(_0x4e2e54);}},this['getPaymentById']=async(_0x145830,_0xb2750e,_0x305fb8)=>{const _0x1d37e4=_0xc7b3f3;try{const {id:_0x21805a}=_0x145830[_0x1d37e4(0x194)],_0x209e8a=await this[_0x1d37e4(0x19a)][_0x1d37e4(0x16e)](_0x21805a);if(!_0x209e8a)return _0xb2750e['status'](0x194)[_0x1d37e4(0x17e)]({'success':![],'message':_0x1d37e4(0x1d0)});_0xb2750e['json']({'success':!![],'result':_0x209e8a});}catch(_0x1d7542){_0x305fb8(_0x1d7542);}},this[_0xc7b3f3(0x1db)]=async(_0x5ac96d,_0x3f2258,_0x39c67)=>{const _0x3d5522=_0xc7b3f3;try{const {id:_0x8c6196}=_0x5ac96d[_0x3d5522(0x194)],_0x18dab6=_0x5ac96d['body'];console[_0x3d5522(0x1cf)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x8c6196),console[_0x3d5522(0x1cf)]('📝\x20Customer\x20data:',_0x18dab6);const _0x3603f2=await this['paymentService']['updatePaymentCustomerDataPublic'](_0x8c6196,_0x18dab6);if(!_0x3603f2)return _0x3f2258[_0x3d5522(0x19d)](0x194)['json']({'success':![],'message':_0x3d5522(0x1d0)});_0x3f2258['json']({'success':!![],'message':_0x3d5522(0x1ab),'result':{'paymentId':_0x3603f2['id'],'customerIp':_0x3603f2[_0x3d5522(0x1b3)],'customerUa':_0x3603f2[_0x3d5522(0x1a0)],'customerCountry':_0x3603f2[_0x3d5522(0x186)],'updatedAt':_0x3603f2[_0x3d5522(0x1eb)]}});}catch(_0x3d6f32){_0x39c67(_0x3d6f32);}},this[_0xc7b3f3(0x188)]=async(_0x650ca8,_0x3509b3,_0x13b659)=>{const _0x55bfe9=_0xc7b3f3;try{const {id:_0x29fc7d}=_0x650ca8[_0x55bfe9(0x194)],{cardData:_0x3b11c9,cardHolder:_0xbb947c,browser:_0x6112d0}=_0x650ca8[_0x55bfe9(0x172)];console[_0x55bfe9(0x1cf)](_0x55bfe9(0x18a)+_0x29fc7d),console[_0x55bfe9(0x1cf)]('💳\x20Card\x20holder:\x20'+_0xbb947c['first_name']+'\x20'+_0xbb947c['last_name']+'\x20('+_0xbb947c[_0x55bfe9(0x1ef)]+')'),console[_0x55bfe9(0x1cf)](_0x55bfe9(0x19c)+_0x6112d0['ip']);const _0x424347={'customerName':_0xbb947c[_0x55bfe9(0x16f)]+'\x20'+_0xbb947c[_0x55bfe9(0x1d4)],'customerEmail':_0xbb947c[_0x55bfe9(0x1ef)],'customerIp':_0x6112d0['ip'],'customerUa':_0x6112d0[_0x55bfe9(0x1ec)]},_0x18f282=await database_1[_0x55bfe9(0x1e5)][_0x55bfe9(0x17f)][_0x55bfe9(0x1e2)]({'where':{'id':_0x29fc7d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x18f282)return _0x3509b3[_0x55bfe9(0x19d)](0x194)[_0x55bfe9(0x17e)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x18f282[_0x55bfe9(0x1ce)]!==_0x55bfe9(0x19b))return _0x3509b3[_0x55bfe9(0x19d)](0x190)[_0x55bfe9(0x17e)]({'success':![],'message':_0x55bfe9(0x1a3)});if(_0x18f282['status']!=='PENDING')return _0x3509b3[_0x55bfe9(0x19d)](0x190)[_0x55bfe9(0x17e)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x18f282[_0x55bfe9(0x19d)]+_0x55bfe9(0x18d)});await database_1[_0x55bfe9(0x1e5)][_0x55bfe9(0x17f)]['update']({'where':{'id':_0x29fc7d},'data':{..._0x424347,'updatedAt':new Date()}});const _0x4d5a15=_0x55bfe9(0x1b1),_0x43054c=_0x18f282[_0x55bfe9(0x1d9)];console[_0x55bfe9(0x1cf)](_0x55bfe9(0x1e3)),console[_0x55bfe9(0x1cf)](_0x55bfe9(0x1ea)+_0x4d5a15),console['log'](_0x55bfe9(0x190)+_0x43054c);const _0x323f86={'first_name':_0xbb947c[_0x55bfe9(0x16f)],'last_name':_0xbb947c['last_name'],'email':_0xbb947c['email']},_0x340e8c=await this['masterCardService']['processCardPayment']({'paymentId':_0x18f282['id'],'orderId':_0x18f282[_0x55bfe9(0x1d3)]||_0x18f282['id'],'amount':_0x18f282[_0x55bfe9(0x1ee)],'currency':_0x18f282[_0x55bfe9(0x182)],'cardData':_0x3b11c9,'resultUrl':_0x4d5a15,'returnUrl':_0x43054c,'cardHolder':_0x323f86,'browser':_0x6112d0});console[_0x55bfe9(0x1cf)](_0x55bfe9(0x181),_0x340e8c);const _0x159b35={'status':_0x340e8c['status'],'updatedAt':new Date(),'statusChangedBy':_0x55bfe9(0x1b9),'statusChangedAt':new Date()};_0x340e8c[_0x55bfe9(0x17c)]&&(_0x159b35[_0x55bfe9(0x1c6)]=_0x340e8c['gateway_payment_id'],console[_0x55bfe9(0x1cf)](_0x55bfe9(0x1bc)+_0x340e8c[_0x55bfe9(0x17c)]));if(_0x340e8c['status']===_0x55bfe9(0x1e8))_0x159b35['paidAt']=new Date();else _0x340e8c[_0x55bfe9(0x19d)]==='FAILED'&&(_0x159b35['failureMessage']=_0x55bfe9(0x1a2));_0x159b35[_0x55bfe9(0x1ed)]=_0x55bfe9(0x19b);if(_0x3b11c9['number']){const _0x199dd4=_0x3b11c9[_0x55bfe9(0x1d7)][_0x55bfe9(0x189)](/[\s-]/g,'');_0x159b35[_0x55bfe9(0x180)]=_0x199dd4['slice'](-0x4),console[_0x55bfe9(0x1cf)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x159b35['cardLast4']);}await database_1[_0x55bfe9(0x1e5)]['payment']['update']({'where':{'id':_0x18f282['id']},'data':_0x159b35}),await database_1[_0x55bfe9(0x1e5)]['webhookLog'][_0x55bfe9(0x1c3)]({'data':{'paymentId':_0x18f282['id'],'shopId':_0x18f282['shopId'],'event':_0x55bfe9(0x1a4)+_0x340e8c[_0x55bfe9(0x19d)]?.[_0x55bfe9(0x185)](),'statusCode':0xc8,'responseBody':JSON[_0x55bfe9(0x1b4)]({'oldStatus':'PENDING','newStatus':_0x340e8c['status'],'gatewayPaymentId':_0x340e8c[_0x55bfe9(0x17c)],'requires3ds':_0x340e8c['requires_3ds'],'processedAt':new Date()[_0x55bfe9(0x1a6)]()})}});if(_0x340e8c[_0x55bfe9(0x179)]){await this[_0x55bfe9(0x1e1)](_0x18f282,_0x340e8c['status'],_0x340e8c[_0x55bfe9(0x17c)]),await this[_0x55bfe9(0x17d)](_0x18f282,_0x340e8c['status']);if(_0x340e8c[_0x55bfe9(0x19d)]===_0x55bfe9(0x1e8)){console['log'](_0x55bfe9(0x1d5)+_0x29fc7d+_0x55bfe9(0x1a1));try{const {PaymentLinkService:_0x1dc470}=await Promise[_0x55bfe9(0x1b6)]()['then'](()=>__importStar(require(_0x55bfe9(0x1bf)))),_0x10d2ce=new _0x1dc470();await _0x10d2ce[_0x55bfe9(0x1c1)](_0x29fc7d),console[_0x55bfe9(0x1cf)](_0x55bfe9(0x18e)+_0x29fc7d);}catch(_0x4bf14c){console[_0x55bfe9(0x18c)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x4bf14c);}}}console[_0x55bfe9(0x1cf)](_0x55bfe9(0x1bd)+_0x29fc7d+'\x20processed:\x20'+_0x340e8c[_0x55bfe9(0x19d)]);if(_0x340e8c[_0x55bfe9(0x19d)]==='PAID')_0x3509b3[_0x55bfe9(0x17e)]({'success':!![],'message':_0x55bfe9(0x1b2),'result':{'status':_0x55bfe9(0x1e8),'gatewayPaymentId':_0x340e8c[_0x55bfe9(0x17c)],'redirectUrl':_0x43054c,'final':!![]}});else _0x340e8c[_0x55bfe9(0x191)]&&_0x340e8c['threeds_url']?_0x3509b3['json']({'success':!![],'message':_0x55bfe9(0x171),'result':{'status':_0x55bfe9(0x1b7),'gatewayPaymentId':_0x340e8c[_0x55bfe9(0x17c)],'redirectUrl':_0x340e8c[_0x55bfe9(0x1de)],'requires3ds':!![],'final':![]}}):_0x3509b3[_0x55bfe9(0x19d)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x55bfe9(0x1a8),'gatewayPaymentId':_0x340e8c['gateway_payment_id'],'redirectUrl':_0x18f282[_0x55bfe9(0x1e0)],'final':!![]}});}catch(_0x45cb88){_0x13b659(_0x45cb88);}},this[_0xc7b3f3(0x19a)]=new paymentService_1[(_0xc7b3f3(0x1e6))](),this[_0xc7b3f3(0x1d6)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0xc7b3f3(0x1cd))]();}async[a8_0x1b70c4(0x1e1)](_0x545968,_0x3ac9bd,_0x4c2719){const _0x5d710e=a8_0x1b70c4,_0x167bb8=Date[_0x5d710e(0x17b)]();try{const _0x240a91=_0x545968[_0x5d710e(0x19e)],_0x5a0d55=_0x240a91[_0x5d710e(0x1af)];if(!_0x5a0d55?.[_0x5d710e(0x1c8)]){console[_0x5d710e(0x1cf)](_0x5d710e(0x1c7)+_0x240a91['id']);return;}const _0x5d9a26=_0x3ac9bd===_0x5d710e(0x1e8)?'payment.success':_0x5d710e(0x1da);let _0x544dcb=[];if(_0x5a0d55[_0x5d710e(0x198)])try{_0x544dcb=Array['isArray'](_0x5a0d55[_0x5d710e(0x198)])?_0x5a0d55[_0x5d710e(0x198)]:JSON[_0x5d710e(0x177)](_0x5a0d55['webhookEvents']);}catch(_0x15f1cc){console[_0x5d710e(0x18c)](_0x5d710e(0x1c0),_0x15f1cc),_0x544dcb=[];}if(!_0x544dcb[_0x5d710e(0x173)](_0x5d9a26)){console[_0x5d710e(0x1cf)](_0x5d710e(0x1a9)+_0x5d9a26+_0x5d710e(0x1ae)+_0x240a91['id']);return;}const _0x568923={'event':_0x5d9a26,'payment':{'id':_0x545968['id'],'order_id':_0x545968[_0x5d710e(0x184)],'gateway_order_id':_0x545968['gatewayOrderId'],'gateway':_0x5d710e(0x1cc),'amount':_0x545968['amount'],'currency':_0x545968[_0x5d710e(0x182)],'status':_0x3ac9bd['toLowerCase'](),'customer_email':_0x545968[_0x5d710e(0x170)],'customer_name':_0x545968[_0x5d710e(0x174)],'gateway_payment_id':_0x4c2719,'created_at':_0x545968['createdAt'],'updated_at':new Date()}},_0x4cba5a=await fetch(_0x5a0d55['webhookUrl'],{'method':_0x5d710e(0x183),'headers':{'Content-Type':_0x5d710e(0x1b8),'User-Agent':_0x5d710e(0x1aa)},'body':JSON[_0x5d710e(0x1b4)](_0x568923)}),_0x2756e6=Date[_0x5d710e(0x17b)]()-_0x167bb8;console[_0x5d710e(0x1cf)](_0x5d710e(0x1d1)+_0x5a0d55[_0x5d710e(0x1c8)]+_0x5d710e(0x1b5)+_0x4cba5a[_0x5d710e(0x19d)]+'\x20('+_0x2756e6+_0x5d710e(0x1c2));}catch(_0x147d18){console[_0x5d710e(0x18c)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x147d18);}}async[a8_0x1b70c4(0x17d)](_0x29a27e,_0x59ac82){const _0xe6bf24=a8_0x1b70c4;try{const {telegramBotService:_0x2f6260}=await Promise[_0xe6bf24(0x1b6)]()[_0xe6bf24(0x1ca)](()=>__importStar(require(_0xe6bf24(0x175)))),_0x432053={'PAID':_0xe6bf24(0x1d8),'FAILED':_0xe6bf24(0x1e7)},_0x3c1c61=_0x432053[_0x59ac82];if(!_0x3c1c61)return;await _0x2f6260[_0xe6bf24(0x1dc)](_0x29a27e[_0xe6bf24(0x195)],_0x29a27e,_0x3c1c61);}catch(_0x5617f9){console[_0xe6bf24(0x18c)](_0xe6bf24(0x1b0),_0x5617f9);}}}exports[a8_0x1b70c4(0x1df)]=PaymentController;