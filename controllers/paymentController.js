'use strict';function a8_0x13d5(_0x35cb97,_0x299c5a){const _0x17298c=a8_0x1729();return a8_0x13d5=function(_0x13d51f,_0x5dca18){_0x13d51f=_0x13d51f-0xba;let _0x1055e1=_0x17298c[_0x13d51f];return _0x1055e1;},a8_0x13d5(_0x35cb97,_0x299c5a);}const a8_0x50bec9=a8_0x13d5;(function(_0xdf0cfe,_0x37ed63){const _0x2e61ad=a8_0x13d5,_0x2cc758=_0xdf0cfe();while(!![]){try{const _0x31f415=parseInt(_0x2e61ad(0x11d))/0x1+parseInt(_0x2e61ad(0xfa))/0x2*(parseInt(_0x2e61ad(0x11e))/0x3)+parseInt(_0x2e61ad(0xe0))/0x4+-parseInt(_0x2e61ad(0x10c))/0x5*(-parseInt(_0x2e61ad(0xca))/0x6)+-parseInt(_0x2e61ad(0xdc))/0x7+-parseInt(_0x2e61ad(0x100))/0x8+parseInt(_0x2e61ad(0x101))/0x9*(-parseInt(_0x2e61ad(0x11f))/0xa);if(_0x31f415===_0x37ed63)break;else _0x2cc758['push'](_0x2cc758['shift']());}catch(_0x569ed6){_0x2cc758['push'](_0x2cc758['shift']());}}}(a8_0x1729,0x28519));function a8_0x1729(){const _0x4f63d6=['ms)','failureMessage','mastercard_','orderId','180023FEIVss','3369aMqbbI','22430IBVrgm','customerName','PENDING','masterCardService','gatewayPaymentId','json','defineProperty','Card\x20payment\x20failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookService','Payment\x20not\x20found','toLowerCase','body','sendPaymentNotification','toISOString','mastercard','length','threeds_url','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','6OfTxTL','getPaymentStatus','FAILED','prototype','processCardPayment','gatewayOrderId','sendShopWebhook','gateway','hasOwnProperty','then','__importStar','../services/telegramBotService','now','amount','PaymentController','\x20\x20\x20Return\x20URL:\x20','stringify','customerEmail','1943781wuFMZS','https://api.trapay.uk/api/webhooks/gateway/mastercard','parse','ðŸ’³\x20MasterCard\x20URLs:','769480QbrTEF','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','paymentMethod','log','payment.success','status','params','../services/gateways/mastercardService','Payment\x20processed\x20successfully','webhookUrl','../config/database','../services/webhookService','paymentService','Failed\x20to\x20send\x20MasterCard\x20webhook:','create','paid','settings','configurable','application/json','createdAt','__esModule','3DS\x20verification\x20required','getOwnPropertyNames','../services/paymentService','gateway_payment_id','shop','138nsXrXj','ðŸ’³\x20MasterCard\x20result:','webhookEvents','getOwnPropertyDescriptor','payment.failed','\x20processed:\x20','905952GNCGjp','423wQsBcR','createPublicPayment','PAID','MasterCardService','sendPaymentStatusNotification','shopId','findUnique','paidAt','error','Payment\x20created\x20successfully','system','1058065rEzWAg','default','currency','__setModuleDefault','Payment\x20failed','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','successUrl','POST','__createBinding','requires_3ds','getPaymentById','MasterCard\x20webhook\x20sent\x20to\x20','call'];a8_0x1729=function(){return _0x4f63d6;};return a8_0x1729();}var __createBinding=this&&this[a8_0x50bec9(0x114)]||(Object[a8_0x50bec9(0xee)]?function(_0x5938af,_0xdbbf93,_0x497a23,_0x485088){const _0x35c975=a8_0x50bec9;if(_0x485088===undefined)_0x485088=_0x497a23;var _0x5e24df=Object[_0x35c975(0xfd)](_0xdbbf93,_0x497a23);(!_0x5e24df||('get'in _0x5e24df?!_0xdbbf93[_0x35c975(0xf4)]:_0x5e24df['writable']||_0x5e24df[_0x35c975(0xf1)]))&&(_0x5e24df={'enumerable':!![],'get':function(){return _0xdbbf93[_0x497a23];}}),Object[_0x35c975(0xbd)](_0x5938af,_0x485088,_0x5e24df);}:function(_0x565821,_0x2a1638,_0x23dae1,_0x283450){if(_0x283450===undefined)_0x283450=_0x23dae1;_0x565821[_0x283450]=_0x2a1638[_0x23dae1];}),__setModuleDefault=this&&this[a8_0x50bec9(0x10f)]||(Object[a8_0x50bec9(0xee)]?function(_0xe16dcd,_0xd4d930){const _0x3bb540=a8_0x50bec9;Object[_0x3bb540(0xbd)](_0xe16dcd,'default',{'enumerable':!![],'value':_0xd4d930});}:function(_0x325091,_0x32fe39){_0x325091['default']=_0x32fe39;}),__importStar=this&&this[a8_0x50bec9(0xd4)]||(function(){var _0x265db4=function(_0x5b57c8){const _0x130eee=a8_0x13d5;return _0x265db4=Object[_0x130eee(0xf6)]||function(_0x25d5c0){const _0x388c87=_0x130eee;var _0x39d9ca=[];for(var _0x826bda in _0x25d5c0)if(Object[_0x388c87(0xcd)][_0x388c87(0xd2)][_0x388c87(0x118)](_0x25d5c0,_0x826bda))_0x39d9ca[_0x39d9ca['length']]=_0x826bda;return _0x39d9ca;},_0x265db4(_0x5b57c8);};return function(_0x5bc3b8){const _0x5a94e0=a8_0x13d5;if(_0x5bc3b8&&_0x5bc3b8['__esModule'])return _0x5bc3b8;var _0x150030={};if(_0x5bc3b8!=null){for(var _0x39d5cc=_0x265db4(_0x5bc3b8),_0x4f02a3=0x0;_0x4f02a3<_0x39d5cc[_0x5a94e0(0xc7)];_0x4f02a3++)if(_0x39d5cc[_0x4f02a3]!==_0x5a94e0(0x10d))__createBinding(_0x150030,_0x5bc3b8,_0x39d5cc[_0x4f02a3]);}return __setModuleDefault(_0x150030,_0x5bc3b8),_0x150030;};}()),__importDefault=this&&this['__importDefault']||function(_0x2943c2){const _0x20d4b0=a8_0x50bec9;return _0x2943c2&&_0x2943c2[_0x20d4b0(0xf4)]?_0x2943c2:{'default':_0x2943c2};};Object[a8_0x50bec9(0xbd)](exports,a8_0x50bec9(0xf4),{'value':!![]}),exports[a8_0x50bec9(0xd8)]=void 0x0;const paymentService_1=require(a8_0x50bec9(0xf7)),mastercardService_1=require(a8_0x50bec9(0xe7)),webhookService_1=require(a8_0x50bec9(0xeb)),database_1=__importDefault(require(a8_0x50bec9(0xea)));class PaymentController{constructor(){const _0x923f26=a8_0x50bec9;this[_0x923f26(0x102)]=async(_0x21f057,_0xa60ee8,_0x506bde)=>{const _0x3de5e2=_0x923f26;try{const _0x4ed60b=_0x21f057[_0x3de5e2(0xc3)],_0x26f90e=await this[_0x3de5e2(0xec)][_0x3de5e2(0x102)](_0x4ed60b);_0xa60ee8['status'](0xc9)[_0x3de5e2(0xbc)]({'success':!![],'message':_0x3de5e2(0x10a),'result':_0x26f90e});}catch(_0x15703c){_0x506bde(_0x15703c);}},this[_0x923f26(0xcb)]=async(_0x2ac135,_0x4c22fc,_0x108d98)=>{const _0x47fbcd=_0x923f26;try{const {id:_0x3a5755}=_0x2ac135['params'],_0x475ab5=await this['paymentService'][_0x47fbcd(0xcb)](_0x3a5755);if(!_0x475ab5)return _0x4c22fc[_0x47fbcd(0xe5)](0x194)[_0x47fbcd(0xbc)]({'success':![],'message':_0x47fbcd(0xc1)});_0x4c22fc[_0x47fbcd(0xbc)]({'success':!![],'result':_0x475ab5});}catch(_0x598dba){_0x108d98(_0x598dba);}},this[_0x923f26(0x116)]=async(_0x3ab907,_0x33dc15,_0x596ac0)=>{const _0x4a2204=_0x923f26;try{const {id:_0x5aa2ad}=_0x3ab907['params'],_0x48d142=await this[_0x4a2204(0xec)][_0x4a2204(0x116)](_0x5aa2ad);if(!_0x48d142)return _0x33dc15[_0x4a2204(0xe5)](0x194)[_0x4a2204(0xbc)]({'success':![],'message':_0x4a2204(0xc1)});_0x33dc15['json']({'success':!![],'result':_0x48d142});}catch(_0x2e0759){_0x596ac0(_0x2e0759);}},this['processMasterCardPayment']=async(_0x2a7047,_0x4cccdd,_0x3aafc1)=>{const _0x6a67fa=_0x923f26;try{const {id:_0x4bcb48}=_0x2a7047[_0x6a67fa(0xe6)],{cardData:_0x1e09bd,cardHolder:_0x367aef,browser:_0x21715c}=_0x2a7047[_0x6a67fa(0xc3)];console[_0x6a67fa(0xe3)](_0x6a67fa(0x111)+_0x4bcb48);const _0x34bc81=await database_1[_0x6a67fa(0x10d)]['payment'][_0x6a67fa(0x107)]({'where':{'id':_0x4bcb48},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x34bc81)return _0x4cccdd[_0x6a67fa(0xe5)](0x194)[_0x6a67fa(0xbc)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x34bc81[_0x6a67fa(0xd1)]!==_0x6a67fa(0xc6))return _0x4cccdd[_0x6a67fa(0xe5)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x34bc81[_0x6a67fa(0xe5)]!==_0x6a67fa(0x121))return _0x4cccdd[_0x6a67fa(0xe5)](0x190)[_0x6a67fa(0xbc)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x34bc81[_0x6a67fa(0xe5)]+',\x20cannot\x20process'});const _0x1a6afc=_0x6a67fa(0xdd),_0x1d9bec=_0x34bc81[_0x6a67fa(0x112)];console['log'](_0x6a67fa(0xdf)),console['log']('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x1a6afc),console[_0x6a67fa(0xe3)](_0x6a67fa(0xd9)+_0x1d9bec);const _0x460c61=await this[_0x6a67fa(0xba)][_0x6a67fa(0xce)]({'paymentId':_0x34bc81['id'],'orderId':_0x34bc81['gatewayOrderId']||_0x34bc81['id'],'amount':_0x34bc81[_0x6a67fa(0xd7)],'currency':_0x34bc81[_0x6a67fa(0x10e)],'cardData':_0x1e09bd,'resultUrl':_0x1a6afc,'returnUrl':_0x1d9bec,'cardHolder':_0x367aef,'browser':_0x21715c});console[_0x6a67fa(0xe3)](_0x6a67fa(0xfb),_0x460c61);const _0x3774a4={'status':_0x460c61[_0x6a67fa(0xe5)],'updatedAt':new Date(),'statusChangedBy':_0x6a67fa(0x10b),'statusChangedAt':new Date()};if(_0x460c61['status']===_0x6a67fa(0x103))_0x3774a4[_0x6a67fa(0x108)]=new Date(),_0x3774a4[_0x6a67fa(0xbb)]=_0x460c61[_0x6a67fa(0xf8)];else _0x460c61[_0x6a67fa(0xe5)]===_0x6a67fa(0xcc)&&(_0x3774a4[_0x6a67fa(0x11a)]=_0x6a67fa(0xbe));_0x3774a4[_0x6a67fa(0xe2)]=_0x6a67fa(0xc6),await database_1[_0x6a67fa(0x10d)]['payment']['update']({'where':{'id':_0x34bc81['id']},'data':_0x3774a4}),await database_1[_0x6a67fa(0x10d)]['webhookLog']['create']({'data':{'paymentId':_0x34bc81['id'],'shopId':_0x34bc81[_0x6a67fa(0x106)],'event':_0x6a67fa(0x11b)+_0x460c61['status']?.[_0x6a67fa(0xc2)](),'statusCode':0xc8,'responseBody':JSON[_0x6a67fa(0xda)]({'oldStatus':'PENDING','newStatus':_0x460c61['status'],'gatewayPaymentId':_0x460c61[_0x6a67fa(0xf8)],'requires3ds':_0x460c61['requires_3ds'],'processedAt':new Date()[_0x6a67fa(0xc5)]()})}});_0x460c61['final']&&(await this[_0x6a67fa(0xd0)](_0x34bc81,_0x460c61[_0x6a67fa(0xe5)],_0x460c61[_0x6a67fa(0xf8)]),await this[_0x6a67fa(0x105)](_0x34bc81,_0x460c61['status']));console[_0x6a67fa(0xe3)]('âœ…\x20MasterCard\x20payment\x20'+_0x4bcb48+_0x6a67fa(0xff)+_0x460c61[_0x6a67fa(0xe5)]);if(_0x460c61[_0x6a67fa(0xe5)]===_0x6a67fa(0x103))_0x4cccdd[_0x6a67fa(0xbc)]({'success':!![],'message':_0x6a67fa(0xe8),'result':{'status':'PAID','gatewayPaymentId':_0x460c61[_0x6a67fa(0xf8)],'redirectUrl':_0x1d9bec,'final':!![]}});else _0x460c61[_0x6a67fa(0x115)]&&_0x460c61[_0x6a67fa(0xc8)]?_0x4cccdd[_0x6a67fa(0xbc)]({'success':!![],'message':_0x6a67fa(0xf5),'result':{'status':'PENDING','gatewayPaymentId':_0x460c61[_0x6a67fa(0xf8)],'redirectUrl':_0x460c61[_0x6a67fa(0xc8)],'requires3ds':!![],'final':![]}}):_0x4cccdd['status'](0x190)[_0x6a67fa(0xbc)]({'success':![],'message':_0x6a67fa(0x110),'result':{'status':_0x6a67fa(0xcc),'gatewayPaymentId':_0x460c61[_0x6a67fa(0xf8)],'redirectUrl':_0x34bc81['failUrl'],'final':!![]}});}catch(_0x4b84e8){_0x3aafc1(_0x4b84e8);}},this['paymentService']=new paymentService_1['PaymentService'](),this['masterCardService']=new mastercardService_1[(_0x923f26(0x104))](),this[_0x923f26(0xc0)]=new webhookService_1['WebhookService']();}async[a8_0x50bec9(0xd0)](_0x50fbc0,_0x4b82b2,_0x5046b6){const _0x1a1da1=a8_0x50bec9,_0x5ca29d=Date[_0x1a1da1(0xd6)]();try{const _0x343e90=_0x50fbc0[_0x1a1da1(0xf9)],_0x2c46ea=_0x343e90[_0x1a1da1(0xf0)];if(!_0x2c46ea?.['webhookUrl']){console[_0x1a1da1(0xe3)](_0x1a1da1(0xbf)+_0x343e90['id']);return;}const _0x13d9eb=_0x4b82b2===_0x1a1da1(0x103)?_0x1a1da1(0xe4):_0x1a1da1(0xfe);let _0x2a53ed=[];if(_0x2c46ea[_0x1a1da1(0xfc)])try{_0x2a53ed=Array['isArray'](_0x2c46ea[_0x1a1da1(0xfc)])?_0x2c46ea[_0x1a1da1(0xfc)]:JSON[_0x1a1da1(0xde)](_0x2c46ea['webhookEvents']);}catch(_0x2e2fb9){console[_0x1a1da1(0x109)]('Error\x20parsing\x20webhook\x20events:',_0x2e2fb9),_0x2a53ed=[];}if(!_0x2a53ed['includes'](_0x13d9eb)){console[_0x1a1da1(0xe3)]('Webhook\x20event\x20'+_0x13d9eb+'\x20not\x20enabled\x20for\x20shop\x20'+_0x343e90['id']);return;}const _0x50b15b={'event':_0x13d9eb,'payment':{'id':_0x50fbc0['id'],'order_id':_0x50fbc0[_0x1a1da1(0x11c)],'gateway_order_id':_0x50fbc0[_0x1a1da1(0xcf)],'gateway':'1111','amount':_0x50fbc0[_0x1a1da1(0xd7)],'currency':_0x50fbc0['currency'],'status':_0x4b82b2['toLowerCase'](),'customer_email':_0x50fbc0[_0x1a1da1(0xdb)],'customer_name':_0x50fbc0[_0x1a1da1(0x120)],'gateway_payment_id':_0x5046b6,'created_at':_0x50fbc0[_0x1a1da1(0xf3)],'updated_at':new Date()}},_0x11859f=await fetch(_0x2c46ea[_0x1a1da1(0xe9)],{'method':_0x1a1da1(0x113),'headers':{'Content-Type':_0x1a1da1(0xf2),'User-Agent':_0x1a1da1(0xc9)},'body':JSON['stringify'](_0x50b15b)}),_0x368b76=Date['now']()-_0x5ca29d;console[_0x1a1da1(0xe3)](_0x1a1da1(0x117)+_0x2c46ea[_0x1a1da1(0xe9)]+'\x20with\x20status\x20'+_0x11859f[_0x1a1da1(0xe5)]+'\x20('+_0x368b76+_0x1a1da1(0x119));}catch(_0x30ea29){console[_0x1a1da1(0x109)](_0x1a1da1(0xed),_0x30ea29);}}async[a8_0x50bec9(0x105)](_0xf4dc3,_0x3ebba8){const _0x2f413b=a8_0x50bec9;try{const {telegramBotService:_0xf32746}=await Promise['resolve']()[_0x2f413b(0xd3)](()=>__importStar(require(_0x2f413b(0xd5)))),_0x565aab={'PAID':_0x2f413b(0xef),'FAILED':'failed'},_0x474e3d=_0x565aab[_0x3ebba8];if(!_0x474e3d)return;await _0xf32746[_0x2f413b(0xc4)](_0xf4dc3[_0x2f413b(0x106)],_0xf4dc3,_0x474e3d);}catch(_0x9d523f){console[_0x2f413b(0x109)](_0x2f413b(0xe1),_0x9d523f);}}}exports[a8_0x50bec9(0xd8)]=PaymentController;