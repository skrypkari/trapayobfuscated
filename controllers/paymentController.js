'use strict';const a8_0xc099=a8_0x302d;(function(_0xda7da4,_0x52763b){const _0x495f7a=a8_0x302d,_0xf7de76=_0xda7da4();while(!![]){try{const _0x5b6027=parseInt(_0x495f7a(0x112))/0x1*(parseInt(_0x495f7a(0xfb))/0x2)+parseInt(_0x495f7a(0x17d))/0x3+-parseInt(_0x495f7a(0x131))/0x4+parseInt(_0x495f7a(0x154))/0x5*(-parseInt(_0x495f7a(0x136))/0x6)+parseInt(_0x495f7a(0x160))/0x7*(parseInt(_0x495f7a(0x176))/0x8)+-parseInt(_0x495f7a(0xfd))/0x9*(-parseInt(_0x495f7a(0x162))/0xa)+parseInt(_0x495f7a(0x173))/0xb*(-parseInt(_0x495f7a(0x127))/0xc);if(_0x5b6027===_0x52763b)break;else _0xf7de76['push'](_0xf7de76['shift']());}catch(_0x19d193){_0xf7de76['push'](_0xf7de76['shift']());}}}(a8_0x3b73,0x6387e));var __createBinding=this&&this[a8_0xc099(0x128)]||(Object[a8_0xc099(0x177)]?function(_0x199fc6,_0x5f2e25,_0x353a04,_0x1aec38){const _0x492933=a8_0xc099;if(_0x1aec38===undefined)_0x1aec38=_0x353a04;var _0x160ff9=Object[_0x492933(0xf6)](_0x5f2e25,_0x353a04);(!_0x160ff9||(_0x492933(0x10f)in _0x160ff9?!_0x5f2e25[_0x492933(0x13d)]:_0x160ff9[_0x492933(0x111)]||_0x160ff9[_0x492933(0x16b)]))&&(_0x160ff9={'enumerable':!![],'get':function(){return _0x5f2e25[_0x353a04];}}),Object['defineProperty'](_0x199fc6,_0x1aec38,_0x160ff9);}:function(_0x139ff7,_0x199f49,_0x2b938b,_0x46c2f0){if(_0x46c2f0===undefined)_0x46c2f0=_0x2b938b;_0x139ff7[_0x46c2f0]=_0x199f49[_0x2b938b];}),__setModuleDefault=this&&this[a8_0xc099(0xff)]||(Object[a8_0xc099(0x177)]?function(_0x181f2d,_0x3b806d){const _0x243743=a8_0xc099;Object[_0x243743(0x166)](_0x181f2d,'default',{'enumerable':!![],'value':_0x3b806d});}:function(_0x3a09fd,_0x527b88){const _0x51c072=a8_0xc099;_0x3a09fd[_0x51c072(0x133)]=_0x527b88;}),__importStar=this&&this[a8_0xc099(0x10d)]||(function(){var _0x262cad=function(_0x112b2d){const _0x532788=a8_0x302d;return _0x262cad=Object[_0x532788(0x129)]||function(_0x5a3903){const _0x379e8e=_0x532788;var _0xcb9547=[];for(var _0x42a8df in _0x5a3903)if(Object['prototype'][_0x379e8e(0x126)][_0x379e8e(0xfc)](_0x5a3903,_0x42a8df))_0xcb9547[_0xcb9547['length']]=_0x42a8df;return _0xcb9547;},_0x262cad(_0x112b2d);};return function(_0x10b204){const _0x3c20e4=a8_0x302d;if(_0x10b204&&_0x10b204['__esModule'])return _0x10b204;var _0x2c8cbd={};if(_0x10b204!=null){for(var _0x4699fb=_0x262cad(_0x10b204),_0x39d337=0x0;_0x39d337<_0x4699fb['length'];_0x39d337++)if(_0x4699fb[_0x39d337]!==_0x3c20e4(0x133))__createBinding(_0x2c8cbd,_0x10b204,_0x4699fb[_0x39d337]);}return __setModuleDefault(_0x2c8cbd,_0x10b204),_0x2c8cbd;};}()),__importDefault=this&&this[a8_0xc099(0x144)]||function(_0xe49839){return _0xe49839&&_0xe49839['__esModule']?_0xe49839:{'default':_0xe49839};};Object[a8_0xc099(0x166)](exports,a8_0xc099(0x13d),{'value':!![]}),exports[a8_0xc099(0x132)]=void 0x0;function a8_0x302d(_0x3012d1,_0xd68c1){const _0x3b737f=a8_0x3b73();return a8_0x302d=function(_0x302d86,_0x5d5a25){_0x302d86=_0x302d86-0xf6;let _0x3466d5=_0x3b737f[_0x302d86];return _0x3466d5;},a8_0x302d(_0x3012d1,_0xd68c1);}function a8_0x3b73(){const _0x154597=['mastercard','💳\x20Card\x20holder:\x20','\x20not\x20enabled\x20for\x20shop\x20','PAID','updatedAt','now','__importDefault','requires_3ds','customerIp','slice','shopId','../services/paymentService','createdAt','payment.success','toISOString','isArray','getPaymentStatus','MasterCard\x20webhook\x20sent\x20to\x20','💳\x20Browser\x20IP:\x20','log','../services/paymentLinkService','ms)','10xGnIXC','status','Error\x20parsing\x20webhook\x20events:','system','createPublicPayment','paidAt','params','paymentService','Payment\x20status\x20is\x20','getPaymentById','shop','successUrl','7UkLFNt','customerUa','44590AHzqWA','WebhookService','number','threeds_url','defineProperty','Failed\x20to\x20send\x20MasterCard\x20webhook:','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','final','failUrl','configurable','cardLast4','Payment\x20not\x20found','processMasterCardPayment','3DS\x20verification\x20required','amount','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','📈\x20MasterCard\x20payment\x20','33lsGLLo','sendPaymentStatusNotification','updatePaymentCustomer','3558872ERvkhO','create','../config/database','handleSuccessfulPayment','includes','webhookUrl','MasterCardService','1449969pKILiT','getOwnPropertyDescriptor','gatewayPaymentId','1111','json','Card\x20payment\x20failed','2PdeaxM','call','180FuybnK','findUnique','__setModuleDefault','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','💳\x20Processing\x20MasterCard\x20payment:\x20','failed','resolve','📝\x20Customer\x20data:','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','body','stringify','webhookEvents','gateway_payment_id','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)',',\x20cannot\x20process','then','__importStar','error','get','user_agent','writable','707874IuEtgI','email','masterCardService','paid','orderId','POST','https://api.trapay.uk/api/webhooks/gateway/mastercard','first_name','gatewayOrderId','gateway','\x20\x20\x20Result\x20URL\x20(webhook):\x20','payment','PENDING','webhookService','settings','failureMessage','\x20processed:\x20','replace','paymentMethod','Payment\x20created\x20successfully','hasOwnProperty','492444iXOSDz','__createBinding','getOwnPropertyNames','../services/webhookService','customerEmail','last_name','updatePaymentCustomerDataPublic','Payment\x20failed','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','✅\x20MasterCard\x20payment\x20','2772524JURguA','PaymentController','default','webhookLog','toLowerCase','1503948PBibEw','customerCountry','Payment\x20processed\x20successfully','FAILED','currency','\x20with\x20status\x20','PaymentService','__esModule'];a8_0x3b73=function(){return _0x154597;};return a8_0x3b73();}const paymentService_1=require(a8_0xc099(0x149)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0xc099(0x12a)),database_1=__importDefault(require(a8_0xc099(0x178)));class PaymentController{constructor(){const _0x917323=a8_0xc099;this[_0x917323(0x158)]=async(_0x5cfb6a,_0x5b0c6f,_0x517d04)=>{const _0x34250e=_0x917323;try{const _0x4df0ea=_0x5cfb6a[_0x34250e(0x106)],_0x7f1084=await this['paymentService'][_0x34250e(0x158)](_0x4df0ea);_0x5b0c6f[_0x34250e(0x155)](0xc9)[_0x34250e(0xf9)]({'success':!![],'message':_0x34250e(0x125),'result':_0x7f1084});}catch(_0x2f1eff){_0x517d04(_0x2f1eff);}},this['getPaymentStatus']=async(_0x5df02b,_0x14e873,_0x3e6a92)=>{const _0x3c7cf9=_0x917323;try{const {id:_0x57c838}=_0x5df02b[_0x3c7cf9(0x15a)],_0x150420=await this['paymentService'][_0x3c7cf9(0x14e)](_0x57c838);if(!_0x150420)return _0x14e873['status'](0x194)[_0x3c7cf9(0xf9)]({'success':![],'message':'Payment\x20not\x20found'});_0x14e873[_0x3c7cf9(0xf9)]({'success':!![],'result':_0x150420});}catch(_0x1a5df4){_0x3e6a92(_0x1a5df4);}},this[_0x917323(0x15d)]=async(_0x3fd633,_0x5ef702,_0x536cc9)=>{const _0x4dc67c=_0x917323;try{const {id:_0x804157}=_0x3fd633[_0x4dc67c(0x15a)],_0x2cc97b=await this[_0x4dc67c(0x15b)]['getPaymentById'](_0x804157);if(!_0x2cc97b)return _0x5ef702['status'](0x194)[_0x4dc67c(0xf9)]({'success':![],'message':_0x4dc67c(0x16d)});_0x5ef702['json']({'success':!![],'result':_0x2cc97b});}catch(_0x225a37){_0x536cc9(_0x225a37);}},this[_0x917323(0x175)]=async(_0x598918,_0x5c38fb,_0x3af57f)=>{const _0x25f1c1=_0x917323;try{const {id:_0x4ac0b5}=_0x598918['params'],_0x308f8d=_0x598918[_0x25f1c1(0x106)];console[_0x25f1c1(0x151)](_0x25f1c1(0x105)+_0x4ac0b5),console[_0x25f1c1(0x151)](_0x25f1c1(0x104),_0x308f8d);const _0x124671=await this[_0x25f1c1(0x15b)][_0x25f1c1(0x12d)](_0x4ac0b5,_0x308f8d);if(!_0x124671)return _0x5c38fb[_0x25f1c1(0x155)](0x194)[_0x25f1c1(0xf9)]({'success':![],'message':_0x25f1c1(0x16d)});_0x5c38fb[_0x25f1c1(0xf9)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x124671['id'],'customerIp':_0x124671[_0x25f1c1(0x146)],'customerUa':_0x124671[_0x25f1c1(0x161)],'customerCountry':_0x124671[_0x25f1c1(0x137)],'updatedAt':_0x124671[_0x25f1c1(0x142)]}});}catch(_0x5c1a2e){_0x3af57f(_0x5c1a2e);}},this[_0x917323(0x16e)]=async(_0x321691,_0x45d11a,_0x2c9009)=>{const _0x539a05=_0x917323;try{const {id:_0xafb7f3}=_0x321691[_0x539a05(0x15a)],{cardData:_0x2d2cc8,cardHolder:_0x3160a3,browser:_0x472043}=_0x321691[_0x539a05(0x106)];console['log'](_0x539a05(0x101)+_0xafb7f3),console[_0x539a05(0x151)](_0x539a05(0x13f)+_0x3160a3[_0x539a05(0x119)]+'\x20'+_0x3160a3['last_name']+'\x20('+_0x3160a3[_0x539a05(0x113)]+')'),console['log'](_0x539a05(0x150)+_0x472043['ip']);const _0x34e671={'customerName':_0x3160a3['first_name']+'\x20'+_0x3160a3['last_name'],'customerEmail':_0x3160a3[_0x539a05(0x113)],'customerIp':_0x472043['ip'],'customerUa':_0x472043[_0x539a05(0x110)]},_0x2dc7b4=await database_1[_0x539a05(0x133)]['payment'][_0x539a05(0xfe)]({'where':{'id':_0xafb7f3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2dc7b4)return _0x45d11a['status'](0x194)[_0x539a05(0xf9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x2dc7b4[_0x539a05(0x11b)]!=='mastercard')return _0x45d11a['status'](0x190)[_0x539a05(0xf9)]({'success':![],'message':_0x539a05(0x168)});if(_0x2dc7b4[_0x539a05(0x155)]!==_0x539a05(0x11e))return _0x45d11a[_0x539a05(0x155)](0x190)[_0x539a05(0xf9)]({'success':![],'message':_0x539a05(0x15c)+_0x2dc7b4[_0x539a05(0x155)]+_0x539a05(0x10b)});await database_1['default'][_0x539a05(0x11d)]['update']({'where':{'id':_0xafb7f3},'data':{..._0x34e671,'updatedAt':new Date()}});const _0x1cb6ba=_0x539a05(0x118),_0x126395=_0x2dc7b4[_0x539a05(0x15f)];console[_0x539a05(0x151)]('💳\x20MasterCard\x20URLs:'),console['log'](_0x539a05(0x11c)+_0x1cb6ba),console[_0x539a05(0x151)]('\x20\x20\x20Return\x20URL:\x20'+_0x126395);const _0x21aab0={'first_name':_0x3160a3[_0x539a05(0x119)],'last_name':_0x3160a3[_0x539a05(0x12c)],'email':_0x3160a3[_0x539a05(0x113)]},_0x1e9d06=await this[_0x539a05(0x114)]['processCardPayment']({'paymentId':_0x2dc7b4['id'],'orderId':_0x2dc7b4[_0x539a05(0x11a)]||_0x2dc7b4['id'],'amount':_0x2dc7b4[_0x539a05(0x170)],'currency':_0x2dc7b4[_0x539a05(0x13a)],'cardData':_0x2d2cc8,'resultUrl':_0x1cb6ba,'returnUrl':_0x126395,'cardHolder':_0x21aab0,'browser':_0x472043});console[_0x539a05(0x151)]('💳\x20MasterCard\x20result:',_0x1e9d06);const _0x17121f={'status':_0x1e9d06[_0x539a05(0x155)],'updatedAt':new Date(),'statusChangedBy':_0x539a05(0x157),'statusChangedAt':new Date()};_0x1e9d06[_0x539a05(0x109)]&&(_0x17121f[_0x539a05(0xf7)]=_0x1e9d06[_0x539a05(0x109)],console[_0x539a05(0x151)](_0x539a05(0x12f)+_0x1e9d06[_0x539a05(0x109)]));if(_0x1e9d06[_0x539a05(0x155)]==='PAID')_0x17121f[_0x539a05(0x159)]=new Date();else _0x1e9d06[_0x539a05(0x155)]===_0x539a05(0x139)&&(_0x17121f[_0x539a05(0x121)]=_0x539a05(0xfa));_0x17121f[_0x539a05(0x124)]=_0x539a05(0x13e);if(_0x2d2cc8[_0x539a05(0x164)]){const _0x1f7567=_0x2d2cc8['number'][_0x539a05(0x123)](/[\s-]/g,'');_0x17121f[_0x539a05(0x16c)]=_0x1f7567[_0x539a05(0x147)](-0x4),console[_0x539a05(0x151)](_0x539a05(0x171)+_0x17121f[_0x539a05(0x16c)]);}await database_1['default'][_0x539a05(0x11d)]['update']({'where':{'id':_0x2dc7b4['id']},'data':_0x17121f}),await database_1[_0x539a05(0x133)][_0x539a05(0x134)][_0x539a05(0x177)]({'data':{'paymentId':_0x2dc7b4['id'],'shopId':_0x2dc7b4[_0x539a05(0x148)],'event':'mastercard_'+_0x1e9d06[_0x539a05(0x155)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x539a05(0x107)]({'oldStatus':_0x539a05(0x11e),'newStatus':_0x1e9d06[_0x539a05(0x155)],'gatewayPaymentId':_0x1e9d06[_0x539a05(0x109)],'requires3ds':_0x1e9d06[_0x539a05(0x145)],'processedAt':new Date()[_0x539a05(0x14c)]()})}});if(_0x1e9d06[_0x539a05(0x169)]){await this['sendShopWebhook'](_0x2dc7b4,_0x1e9d06['status'],_0x1e9d06[_0x539a05(0x109)]),await this[_0x539a05(0x174)](_0x2dc7b4,_0x1e9d06['status']);if(_0x1e9d06[_0x539a05(0x155)]===_0x539a05(0x141)){console[_0x539a05(0x151)](_0x539a05(0x172)+_0xafb7f3+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x4c8fa1}=await Promise[_0x539a05(0x103)]()['then'](()=>__importStar(require(_0x539a05(0x152)))),_0x4de78f=new _0x4c8fa1();await _0x4de78f[_0x539a05(0x179)](_0xafb7f3),console['log']('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0xafb7f3);}catch(_0x5a10c8){console[_0x539a05(0x10e)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x5a10c8);}}}console[_0x539a05(0x151)](_0x539a05(0x130)+_0xafb7f3+_0x539a05(0x122)+_0x1e9d06[_0x539a05(0x155)]);if(_0x1e9d06['status']==='PAID')_0x45d11a[_0x539a05(0xf9)]({'success':!![],'message':_0x539a05(0x138),'result':{'status':_0x539a05(0x141),'gatewayPaymentId':_0x1e9d06['gateway_payment_id'],'redirectUrl':_0x126395,'final':!![]}});else _0x1e9d06[_0x539a05(0x145)]&&_0x1e9d06[_0x539a05(0x165)]?_0x45d11a['json']({'success':!![],'message':_0x539a05(0x16f),'result':{'status':_0x539a05(0x11e),'gatewayPaymentId':_0x1e9d06[_0x539a05(0x109)],'redirectUrl':_0x1e9d06[_0x539a05(0x165)],'requires3ds':!![],'final':![]}}):_0x45d11a['status'](0x190)[_0x539a05(0xf9)]({'success':![],'message':_0x539a05(0x12e),'result':{'status':_0x539a05(0x139),'gatewayPaymentId':_0x1e9d06[_0x539a05(0x109)],'redirectUrl':_0x2dc7b4[_0x539a05(0x16a)],'final':!![]}});}catch(_0x296180){_0x2c9009(_0x296180);}},this['paymentService']=new paymentService_1[(_0x917323(0x13c))](),this[_0x917323(0x114)]=new mastercardService_1[(_0x917323(0x17c))](),this[_0x917323(0x11f)]=new webhookService_1[(_0x917323(0x163))]();}async['sendShopWebhook'](_0xc7aed6,_0x4f61c5,_0x56f9fe){const _0x157ae6=a8_0xc099,_0x28771a=Date[_0x157ae6(0x143)]();try{const _0x4dba9b=_0xc7aed6[_0x157ae6(0x15e)],_0x1cb92b=_0x4dba9b[_0x157ae6(0x120)];if(!_0x1cb92b?.[_0x157ae6(0x17b)]){console['log'](_0x157ae6(0x100)+_0x4dba9b['id']);return;}const _0x3799a7=_0x4f61c5===_0x157ae6(0x141)?_0x157ae6(0x14b):'payment.failed';let _0x1267c1=[];if(_0x1cb92b[_0x157ae6(0x108)])try{_0x1267c1=Array[_0x157ae6(0x14d)](_0x1cb92b[_0x157ae6(0x108)])?_0x1cb92b[_0x157ae6(0x108)]:JSON['parse'](_0x1cb92b[_0x157ae6(0x108)]);}catch(_0x40ca0b){console['error'](_0x157ae6(0x156),_0x40ca0b),_0x1267c1=[];}if(!_0x1267c1[_0x157ae6(0x17a)](_0x3799a7)){console['log']('Webhook\x20event\x20'+_0x3799a7+_0x157ae6(0x140)+_0x4dba9b['id']);return;}const _0x1f7a55={'event':_0x3799a7,'payment':{'id':_0xc7aed6['id'],'order_id':_0xc7aed6[_0x157ae6(0x116)],'gateway_order_id':_0xc7aed6[_0x157ae6(0x11a)],'gateway':_0x157ae6(0xf8),'amount':_0xc7aed6[_0x157ae6(0x170)],'currency':_0xc7aed6[_0x157ae6(0x13a)],'status':_0x4f61c5[_0x157ae6(0x135)](),'customer_email':_0xc7aed6[_0x157ae6(0x12b)],'customer_name':_0xc7aed6['customerName'],'gateway_payment_id':_0x56f9fe,'created_at':_0xc7aed6[_0x157ae6(0x14a)],'updated_at':new Date()}},_0x327928=await fetch(_0x1cb92b[_0x157ae6(0x17b)],{'method':_0x157ae6(0x117),'headers':{'Content-Type':'application/json','User-Agent':_0x157ae6(0x10a)},'body':JSON[_0x157ae6(0x107)](_0x1f7a55)}),_0x5d34f2=Date[_0x157ae6(0x143)]()-_0x28771a;console[_0x157ae6(0x151)](_0x157ae6(0x14f)+_0x1cb92b[_0x157ae6(0x17b)]+_0x157ae6(0x13b)+_0x327928[_0x157ae6(0x155)]+'\x20('+_0x5d34f2+_0x157ae6(0x153));}catch(_0x45490d){console['error'](_0x157ae6(0x167),_0x45490d);}}async[a8_0xc099(0x174)](_0x3249a9,_0x1104e6){const _0x1716e8=a8_0xc099;try{const {telegramBotService:_0x4e8f89}=await Promise['resolve']()[_0x1716e8(0x10c)](()=>__importStar(require('../services/telegramBotService'))),_0x5d9768={'PAID':_0x1716e8(0x115),'FAILED':_0x1716e8(0x102)},_0x337213=_0x5d9768[_0x1104e6];if(!_0x337213)return;await _0x4e8f89['sendPaymentNotification'](_0x3249a9['shopId'],_0x3249a9,_0x337213);}catch(_0x327f9e){console[_0x1716e8(0x10e)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x327f9e);}}}exports[a8_0xc099(0x132)]=PaymentController;