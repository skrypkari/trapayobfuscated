'use strict';function a8_0x118d(_0x42b7dd,_0x1e9b4c){const _0x149d49=a8_0x149d();return a8_0x118d=function(_0x118d51,_0x327079){_0x118d51=_0x118d51-0xcb;let _0x19fc15=_0x149d49[_0x118d51];return _0x19fc15;},a8_0x118d(_0x42b7dd,_0x1e9b4c);}function a8_0x149d(){const _0x263cdc=['successUrl','üí≥\x20MasterCard\x20URLs:','POST','__createBinding','body','469258MhPrNl','mastercard','Payment\x20processed\x20successfully','replace','2277963BPdJLz','4swHfAQ','getOwnPropertyDescriptor','number','üìà\x20MasterCard\x20payment\x20','sendPaymentNotification','hasOwnProperty','https://api.trapay.uk/api/webhooks/gateway/mastercard','createdAt','requires_3ds','email','length','system','isArray','MasterCardService','currency','payment.failed','update','final','updatePaymentCustomer','log','user_agent','1464126HfFlMX','failUrl','PAID','Failed\x20to\x20send\x20MasterCard\x20webhook:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','mastercard_','then','toLowerCase','WebhookService','handleSuccessfulPayment','Payment\x20status\x20is\x20','sendPaymentStatusNotification','status','masterCardService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','8fLGulm','get','writable','orderId','3DS\x20verification\x20required','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','Error\x20parsing\x20webhook\x20events:','üí≥\x20Processing\x20MasterCard\x20payment:\x20','webhookEvents','../services/paymentLinkService','\x20processed:\x20','shopId','Payment\x20not\x20found','\x20\x20\x20Result\x20URL\x20(webhook):\x20','params','\x20not\x20enabled\x20for\x20shop\x20','\x20\x20\x20Return\x20URL:\x20','gateway_payment_id','Webhook\x20event\x20','4166078VOgHdE','gatewayPaymentId','updatedAt','defineProperty','gatewayOrderId','application/json','__esModule','amount','last_name','toISOString','customerName','customerEmail','getPaymentById','default','webhookLog','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','paidAt','üìù\x20Customer\x20data:','../services/webhookService','PENDING','payment','json','üí≥\x20Browser\x20IP:\x20','5827260UxDhwU','failed','16411142KXXywR','call','resolve','\x20with\x20status\x20','updatePaymentCustomerDataPublic','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','34072PjlGIN','paymentService','Payment\x20created\x20successfully','‚úÖ\x20MasterCard\x20payment\x20','PaymentController','configurable','webhookService','threeds_url','gateway','now','205JqZeYa','sendShopWebhook','PaymentService','MasterCard\x20webhook\x20sent\x20to\x20','error','../services/telegramBotService','prototype','create','10GaMOnk','first_name','üí≥\x20Card\x20holder:\x20','webhookUrl','1111','cardLast4','__importDefault','failureMessage','Customer\x20data\x20updated\x20successfully','FAILED','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','ms)'];a8_0x149d=function(){return _0x263cdc;};return a8_0x149d();}const a8_0x1edc00=a8_0x118d;(function(_0x116723,_0x5a3af6){const _0x477816=a8_0x118d,_0x1154ff=_0x116723();while(!![]){try{const _0x3d6d68=-parseInt(_0x477816(0x105))/0x1+-parseInt(_0x477816(0x10a))/0x2*(parseInt(_0x477816(0x11f))/0x3)+parseInt(_0x477816(0xe2))/0x4*(parseInt(_0x477816(0xec))/0x5)+parseInt(_0x477816(0xda))/0x6+-parseInt(_0x477816(0x141))/0x7*(parseInt(_0x477816(0x12e))/0x8)+-parseInt(_0x477816(0x109))/0x9*(parseInt(_0x477816(0xf4))/0xa)+parseInt(_0x477816(0xdc))/0xb;if(_0x3d6d68===_0x5a3af6)break;else _0x1154ff['push'](_0x1154ff['shift']());}catch(_0x1bfb5b){_0x1154ff['push'](_0x1154ff['shift']());}}}(a8_0x149d,0x7ea6f));var __createBinding=this&&this[a8_0x1edc00(0x103)]||(Object[a8_0x1edc00(0xf3)]?function(_0x5d5360,_0x2286e7,_0x30c27a,_0x68db12){const _0x3c84dd=a8_0x1edc00;if(_0x68db12===undefined)_0x68db12=_0x30c27a;var _0x5db2e1=Object[_0x3c84dd(0x10b)](_0x2286e7,_0x30c27a);(!_0x5db2e1||(_0x3c84dd(0x12f)in _0x5db2e1?!_0x2286e7[_0x3c84dd(0x147)]:_0x5db2e1[_0x3c84dd(0x130)]||_0x5db2e1[_0x3c84dd(0xe7)]))&&(_0x5db2e1={'enumerable':!![],'get':function(){return _0x2286e7[_0x30c27a];}}),Object[_0x3c84dd(0x144)](_0x5d5360,_0x68db12,_0x5db2e1);}:function(_0x38f524,_0x2d4a65,_0x3306e7,_0x3c6ae5){if(_0x3c6ae5===undefined)_0x3c6ae5=_0x3306e7;_0x38f524[_0x3c6ae5]=_0x2d4a65[_0x3306e7];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x1edc00(0xf3)]?function(_0x41f507,_0x10fab8){Object['defineProperty'](_0x41f507,'default',{'enumerable':!![],'value':_0x10fab8});}:function(_0x1f99ca,_0x1fad2d){const _0xf9f6d1=a8_0x1edc00;_0x1f99ca[_0xf9f6d1(0xd0)]=_0x1fad2d;}),__importStar=this&&this['__importStar']||(function(){var _0x307bdd=function(_0x1db631){return _0x307bdd=Object['getOwnPropertyNames']||function(_0x36cb07){const _0x390617=a8_0x118d;var _0x1307eb=[];for(var _0x114387 in _0x36cb07)if(Object[_0x390617(0xf2)][_0x390617(0x10f)][_0x390617(0xdd)](_0x36cb07,_0x114387))_0x1307eb[_0x1307eb['length']]=_0x114387;return _0x1307eb;},_0x307bdd(_0x1db631);};return function(_0x48b7ad){const _0x30eabe=a8_0x118d;if(_0x48b7ad&&_0x48b7ad[_0x30eabe(0x147)])return _0x48b7ad;var _0x2b2b73={};if(_0x48b7ad!=null){for(var _0xd784a2=_0x307bdd(_0x48b7ad),_0x5baf8b=0x0;_0x5baf8b<_0xd784a2[_0x30eabe(0x114)];_0x5baf8b++)if(_0xd784a2[_0x5baf8b]!=='default')__createBinding(_0x2b2b73,_0x48b7ad,_0xd784a2[_0x5baf8b]);}return __setModuleDefault(_0x2b2b73,_0x48b7ad),_0x2b2b73;};}()),__importDefault=this&&this[a8_0x1edc00(0xfa)]||function(_0x534f78){return _0x534f78&&_0x534f78['__esModule']?_0x534f78:{'default':_0x534f78};};Object[a8_0x1edc00(0x144)](exports,a8_0x1edc00(0x147),{'value':!![]}),exports[a8_0x1edc00(0xe6)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x1edc00(0xd5)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x41a5cd=a8_0x1edc00;this['createPublicPayment']=async(_0x4fcfa3,_0x4d6836,_0x1b37b4)=>{const _0x16f677=a8_0x118d;try{const _0x5b648b=_0x4fcfa3[_0x16f677(0x104)],_0x416cbb=await this[_0x16f677(0xe3)]['createPublicPayment'](_0x5b648b);_0x4d6836[_0x16f677(0x12b)](0xc9)[_0x16f677(0xd8)]({'success':!![],'message':_0x16f677(0xe4),'result':_0x416cbb});}catch(_0x244d1c){_0x1b37b4(_0x244d1c);}},this['getPaymentStatus']=async(_0x50738d,_0x2b1b5d,_0x49e4e2)=>{const _0x568ce6=a8_0x118d;try{const {id:_0x41d3e8}=_0x50738d[_0x568ce6(0x13c)],_0x503862=await this[_0x568ce6(0xe3)]['getPaymentStatus'](_0x41d3e8);if(!_0x503862)return _0x2b1b5d[_0x568ce6(0x12b)](0x194)[_0x568ce6(0xd8)]({'success':![],'message':_0x568ce6(0x13a)});_0x2b1b5d['json']({'success':!![],'result':_0x503862});}catch(_0x44304f){_0x49e4e2(_0x44304f);}},this[_0x41a5cd(0xcf)]=async(_0x1c8839,_0x4bbcbb,_0xb1fb81)=>{const _0x2d3996=_0x41a5cd;try{const {id:_0x458783}=_0x1c8839['params'],_0x5732fb=await this[_0x2d3996(0xe3)][_0x2d3996(0xcf)](_0x458783);if(!_0x5732fb)return _0x4bbcbb[_0x2d3996(0x12b)](0x194)[_0x2d3996(0xd8)]({'success':![],'message':'Payment\x20not\x20found'});_0x4bbcbb[_0x2d3996(0xd8)]({'success':!![],'result':_0x5732fb});}catch(_0x331d96){_0xb1fb81(_0x331d96);}},this[_0x41a5cd(0x11c)]=async(_0x29b4db,_0x844fe9,_0x434f1f)=>{const _0x2ed105=_0x41a5cd;try{const {id:_0x3f2483}=_0x29b4db[_0x2ed105(0x13c)],_0x2341d6=_0x29b4db[_0x2ed105(0x104)];console[_0x2ed105(0x11d)](_0x2ed105(0xfe)+_0x3f2483),console['log'](_0x2ed105(0xd4),_0x2341d6);const _0x3f5686=await this[_0x2ed105(0xe3)][_0x2ed105(0xe0)](_0x3f2483,_0x2341d6);if(!_0x3f5686)return _0x844fe9['status'](0x194)[_0x2ed105(0xd8)]({'success':![],'message':'Payment\x20not\x20found'});_0x844fe9['json']({'success':!![],'message':_0x2ed105(0xfc),'result':{'paymentId':_0x3f5686['id'],'customerIp':_0x3f5686['customerIp'],'customerUa':_0x3f5686['customerUa'],'customerCountry':_0x3f5686['customerCountry'],'updatedAt':_0x3f5686[_0x2ed105(0x143)]}});}catch(_0x4b4c2f){_0x434f1f(_0x4b4c2f);}},this['processMasterCardPayment']=async(_0x59ad35,_0x56faa1,_0xc3f4ec)=>{const _0x2df1e2=_0x41a5cd;try{const {id:_0x1822ea}=_0x59ad35['params'],{cardData:_0x1dbf42,cardHolder:_0x358afe,browser:_0x17dbbb}=_0x59ad35[_0x2df1e2(0x104)];console['log'](_0x2df1e2(0x135)+_0x1822ea),console[_0x2df1e2(0x11d)](_0x2df1e2(0xf6)+_0x358afe[_0x2df1e2(0xf5)]+'\x20'+_0x358afe[_0x2df1e2(0xcb)]+'\x20('+_0x358afe[_0x2df1e2(0x113)]+')'),console['log'](_0x2df1e2(0xd9)+_0x17dbbb['ip']);const _0x4f2b8b={'customerName':_0x358afe[_0x2df1e2(0xf5)]+'\x20'+_0x358afe[_0x2df1e2(0xcb)],'customerEmail':_0x358afe[_0x2df1e2(0x113)],'customerIp':_0x17dbbb['ip'],'customerUa':_0x17dbbb[_0x2df1e2(0x11e)]},_0x17d383=await database_1['default']['payment']['findUnique']({'where':{'id':_0x1822ea},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x17d383)return _0x56faa1[_0x2df1e2(0x12b)](0x194)['json']({'success':![],'message':_0x2df1e2(0x13a)});if(_0x17d383[_0x2df1e2(0xea)]!==_0x2df1e2(0x106))return _0x56faa1['status'](0x190)[_0x2df1e2(0xd8)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x17d383[_0x2df1e2(0x12b)]!==_0x2df1e2(0xd6))return _0x56faa1[_0x2df1e2(0x12b)](0x190)['json']({'success':![],'message':_0x2df1e2(0x129)+_0x17d383[_0x2df1e2(0x12b)]+',\x20cannot\x20process'});await database_1[_0x2df1e2(0xd0)][_0x2df1e2(0xd7)][_0x2df1e2(0x11a)]({'where':{'id':_0x1822ea},'data':{..._0x4f2b8b,'updatedAt':new Date()}});const _0x46cd2c=_0x2df1e2(0x110),_0x57bec1=_0x17d383[_0x2df1e2(0x100)];console[_0x2df1e2(0x11d)](_0x2df1e2(0x101)),console[_0x2df1e2(0x11d)](_0x2df1e2(0x13b)+_0x46cd2c),console[_0x2df1e2(0x11d)](_0x2df1e2(0x13e)+_0x57bec1);const _0x41e0db={'first_name':_0x358afe[_0x2df1e2(0xf5)],'last_name':_0x358afe['last_name'],'email':_0x358afe['email']},_0x2dd6e9=await this[_0x2df1e2(0x12c)]['processCardPayment']({'paymentId':_0x17d383['id'],'orderId':_0x17d383[_0x2df1e2(0x145)]||_0x17d383['id'],'amount':_0x17d383[_0x2df1e2(0x148)],'currency':_0x17d383[_0x2df1e2(0x118)],'cardData':_0x1dbf42,'resultUrl':_0x46cd2c,'returnUrl':_0x57bec1,'cardHolder':_0x41e0db,'browser':_0x17dbbb});console['log']('üí≥\x20MasterCard\x20result:',_0x2dd6e9);const _0x496a6c={'status':_0x2dd6e9[_0x2df1e2(0x12b)],'updatedAt':new Date(),'statusChangedBy':_0x2df1e2(0x115),'statusChangedAt':new Date()};_0x2dd6e9['gateway_payment_id']&&(_0x496a6c[_0x2df1e2(0x142)]=_0x2dd6e9[_0x2df1e2(0x13f)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x2dd6e9[_0x2df1e2(0x13f)]));if(_0x2dd6e9[_0x2df1e2(0x12b)]===_0x2df1e2(0x121))_0x496a6c[_0x2df1e2(0xd3)]=new Date();else _0x2dd6e9[_0x2df1e2(0x12b)]===_0x2df1e2(0xfd)&&(_0x496a6c[_0x2df1e2(0xfb)]='Card\x20payment\x20failed');_0x496a6c['paymentMethod']=_0x2df1e2(0x106);if(_0x1dbf42['number']){const _0x276dd9=_0x1dbf42[_0x2df1e2(0x10c)][_0x2df1e2(0x108)](/[\s-]/g,'');_0x496a6c[_0x2df1e2(0xf9)]=_0x276dd9['slice'](-0x4),console[_0x2df1e2(0x11d)](_0x2df1e2(0x133)+_0x496a6c[_0x2df1e2(0xf9)]);}await database_1['default']['payment'][_0x2df1e2(0x11a)]({'where':{'id':_0x17d383['id']},'data':_0x496a6c}),await database_1[_0x2df1e2(0xd0)][_0x2df1e2(0xd1)]['create']({'data':{'paymentId':_0x17d383['id'],'shopId':_0x17d383[_0x2df1e2(0x139)],'event':_0x2df1e2(0x124)+_0x2dd6e9['status']?.[_0x2df1e2(0x126)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x2dd6e9['status'],'gatewayPaymentId':_0x2dd6e9[_0x2df1e2(0x13f)],'requires3ds':_0x2dd6e9[_0x2df1e2(0x112)],'processedAt':new Date()[_0x2df1e2(0xcc)]()})}});if(_0x2dd6e9[_0x2df1e2(0x11b)]){await this[_0x2df1e2(0xed)](_0x17d383,_0x2dd6e9[_0x2df1e2(0x12b)],_0x2dd6e9[_0x2df1e2(0x13f)]),await this[_0x2df1e2(0x12a)](_0x17d383,_0x2dd6e9['status']);if(_0x2dd6e9[_0x2df1e2(0x12b)]===_0x2df1e2(0x121)){console[_0x2df1e2(0x11d)](_0x2df1e2(0x10d)+_0x1822ea+_0x2df1e2(0xd2));try{const {PaymentLinkService:_0x30327c}=await Promise[_0x2df1e2(0xde)]()[_0x2df1e2(0x125)](()=>__importStar(require(_0x2df1e2(0x137)))),_0x641849=new _0x30327c();await _0x641849[_0x2df1e2(0x128)](_0x1822ea),console[_0x2df1e2(0x11d)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x1822ea);}catch(_0x33c187){console[_0x2df1e2(0xf0)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x33c187);}}}console[_0x2df1e2(0x11d)](_0x2df1e2(0xe5)+_0x1822ea+_0x2df1e2(0x138)+_0x2dd6e9['status']);if(_0x2dd6e9[_0x2df1e2(0x12b)]===_0x2df1e2(0x121))_0x56faa1[_0x2df1e2(0xd8)]({'success':!![],'message':_0x2df1e2(0x107),'result':{'status':_0x2df1e2(0x121),'gatewayPaymentId':_0x2dd6e9[_0x2df1e2(0x13f)],'redirectUrl':_0x57bec1,'final':!![]}});else _0x2dd6e9[_0x2df1e2(0x112)]&&_0x2dd6e9[_0x2df1e2(0xe9)]?_0x56faa1[_0x2df1e2(0xd8)]({'success':!![],'message':_0x2df1e2(0x132),'result':{'status':'PENDING','gatewayPaymentId':_0x2dd6e9[_0x2df1e2(0x13f)],'redirectUrl':_0x2dd6e9['threeds_url'],'requires3ds':!![],'final':![]}}):_0x56faa1['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x2dd6e9[_0x2df1e2(0x13f)],'redirectUrl':_0x17d383[_0x2df1e2(0x120)],'final':!![]}});}catch(_0x2dfce3){_0xc3f4ec(_0x2dfce3);}},this[_0x41a5cd(0xe3)]=new paymentService_1[(_0x41a5cd(0xee))](),this[_0x41a5cd(0x12c)]=new mastercardService_1[(_0x41a5cd(0x117))](),this[_0x41a5cd(0xe8)]=new webhookService_1[(_0x41a5cd(0x127))]();}async[a8_0x1edc00(0xed)](_0x3d4b69,_0x3474f3,_0x276290){const _0x22025f=a8_0x1edc00,_0x3c2c08=Date[_0x22025f(0xeb)]();try{const _0x34781c=_0x3d4b69['shop'],_0x496dad=_0x34781c['settings'];if(!_0x496dad?.[_0x22025f(0xf7)]){console[_0x22025f(0x11d)](_0x22025f(0x12d)+_0x34781c['id']);return;}const _0x5665da=_0x3474f3===_0x22025f(0x121)?'payment.success':_0x22025f(0x119);let _0x35fd21=[];if(_0x496dad[_0x22025f(0x136)])try{_0x35fd21=Array[_0x22025f(0x116)](_0x496dad[_0x22025f(0x136)])?_0x496dad['webhookEvents']:JSON['parse'](_0x496dad[_0x22025f(0x136)]);}catch(_0x534278){console[_0x22025f(0xf0)](_0x22025f(0x134),_0x534278),_0x35fd21=[];}if(!_0x35fd21['includes'](_0x5665da)){console[_0x22025f(0x11d)](_0x22025f(0x140)+_0x5665da+_0x22025f(0x13d)+_0x34781c['id']);return;}const _0x2f180e={'event':_0x5665da,'payment':{'id':_0x3d4b69['id'],'order_id':_0x3d4b69[_0x22025f(0x131)],'gateway_order_id':_0x3d4b69['gatewayOrderId'],'gateway':_0x22025f(0xf8),'amount':_0x3d4b69[_0x22025f(0x148)],'currency':_0x3d4b69[_0x22025f(0x118)],'status':_0x3474f3[_0x22025f(0x126)](),'customer_email':_0x3d4b69[_0x22025f(0xce)],'customer_name':_0x3d4b69[_0x22025f(0xcd)],'gateway_payment_id':_0x276290,'created_at':_0x3d4b69[_0x22025f(0x111)],'updated_at':new Date()}},_0x4abb73=await fetch(_0x496dad[_0x22025f(0xf7)],{'method':_0x22025f(0x102),'headers':{'Content-Type':_0x22025f(0x146),'User-Agent':_0x22025f(0x123)},'body':JSON['stringify'](_0x2f180e)}),_0x4cb970=Date[_0x22025f(0xeb)]()-_0x3c2c08;console[_0x22025f(0x11d)](_0x22025f(0xef)+_0x496dad[_0x22025f(0xf7)]+_0x22025f(0xdf)+_0x4abb73[_0x22025f(0x12b)]+'\x20('+_0x4cb970+_0x22025f(0xff));}catch(_0x3506c0){console['error'](_0x22025f(0x122),_0x3506c0);}}async[a8_0x1edc00(0x12a)](_0x3c1837,_0x5ab87c){const _0x479589=a8_0x1edc00;try{const {telegramBotService:_0x2de7f3}=await Promise[_0x479589(0xde)]()['then'](()=>__importStar(require(_0x479589(0xf1)))),_0x1cbdae={'PAID':'paid','FAILED':_0x479589(0xdb)},_0xead660=_0x1cbdae[_0x5ab87c];if(!_0xead660)return;await _0x2de7f3[_0x479589(0x10e)](_0x3c1837['shopId'],_0x3c1837,_0xead660);}catch(_0x26ee9d){console[_0x479589(0xf0)](_0x479589(0xe1),_0x26ee9d);}}}exports[a8_0x1edc00(0xe6)]=PaymentController;