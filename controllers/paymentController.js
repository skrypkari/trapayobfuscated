'use strict';const a8_0x527325=a8_0x56a9;(function(_0x34b9a1,_0x39d401){const _0x4047db=a8_0x56a9,_0x3784f6=_0x34b9a1();while(!![]){try{const _0x21c1c4=parseInt(_0x4047db(0x15a))/0x1+parseInt(_0x4047db(0x137))/0x2*(parseInt(_0x4047db(0x110))/0x3)+parseInt(_0x4047db(0x123))/0x4*(parseInt(_0x4047db(0x140))/0x5)+-parseInt(_0x4047db(0x153))/0x6*(-parseInt(_0x4047db(0x122))/0x7)+-parseInt(_0x4047db(0x148))/0x8+-parseInt(_0x4047db(0x10e))/0x9*(parseInt(_0x4047db(0x170))/0xa)+parseInt(_0x4047db(0x156))/0xb;if(_0x21c1c4===_0x39d401)break;else _0x3784f6['push'](_0x3784f6['shift']());}catch(_0x2504a0){_0x3784f6['push'](_0x3784f6['shift']());}}}(a8_0x30fd,0x71282));var __createBinding=this&&this[a8_0x527325(0x15d)]||(Object[a8_0x527325(0x12b)]?function(_0x3025ae,_0x12e552,_0x2d6660,_0x238e9f){const _0x146da0=a8_0x527325;if(_0x238e9f===undefined)_0x238e9f=_0x2d6660;var _0x50c4da=Object['getOwnPropertyDescriptor'](_0x12e552,_0x2d6660);(!_0x50c4da||(_0x146da0(0x142)in _0x50c4da?!_0x12e552[_0x146da0(0x143)]:_0x50c4da[_0x146da0(0x111)]||_0x50c4da[_0x146da0(0x16b)]))&&(_0x50c4da={'enumerable':!![],'get':function(){return _0x12e552[_0x2d6660];}}),Object[_0x146da0(0x125)](_0x3025ae,_0x238e9f,_0x50c4da);}:function(_0xed31fe,_0x4cec7e,_0x4efc87,_0x603056){if(_0x603056===undefined)_0x603056=_0x4efc87;_0xed31fe[_0x603056]=_0x4cec7e[_0x4efc87];}),__setModuleDefault=this&&this[a8_0x527325(0x10d)]||(Object[a8_0x527325(0x12b)]?function(_0x11b135,_0x3abc0f){const _0x1e09a0=a8_0x527325;Object['defineProperty'](_0x11b135,_0x1e09a0(0x174),{'enumerable':!![],'value':_0x3abc0f});}:function(_0x363349,_0x30be1d){_0x363349['default']=_0x30be1d;}),__importStar=this&&this[a8_0x527325(0x145)]||(function(){var _0x56323a=function(_0x1e9ca8){const _0x24bd78=a8_0x56a9;return _0x56323a=Object[_0x24bd78(0x124)]||function(_0x45259f){const _0x392f55=_0x24bd78;var _0x293059=[];for(var _0x31d859 in _0x45259f)if(Object['prototype']['hasOwnProperty'][_0x392f55(0x15e)](_0x45259f,_0x31d859))_0x293059[_0x293059[_0x392f55(0x11e)]]=_0x31d859;return _0x293059;},_0x56323a(_0x1e9ca8);};return function(_0x2e6bf3){const _0x39a6ce=a8_0x56a9;if(_0x2e6bf3&&_0x2e6bf3[_0x39a6ce(0x143)])return _0x2e6bf3;var _0x313b53={};if(_0x2e6bf3!=null){for(var _0x3d6400=_0x56323a(_0x2e6bf3),_0x24ea3d=0x0;_0x24ea3d<_0x3d6400[_0x39a6ce(0x11e)];_0x24ea3d++)if(_0x3d6400[_0x24ea3d]!==_0x39a6ce(0x174))__createBinding(_0x313b53,_0x2e6bf3,_0x3d6400[_0x24ea3d]);}return __setModuleDefault(_0x313b53,_0x2e6bf3),_0x313b53;};}()),__importDefault=this&&this[a8_0x527325(0x134)]||function(_0x1006eb){const _0x219be5=a8_0x527325;return _0x1006eb&&_0x1006eb[_0x219be5(0x143)]?_0x1006eb:{'default':_0x1006eb};};Object['defineProperty'](exports,a8_0x527325(0x143),{'value':!![]}),exports[a8_0x527325(0x13e)]=void 0x0;const paymentService_1=require(a8_0x527325(0x114)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x527325(0x12e)),database_1=__importDefault(require(a8_0x527325(0x151)));class PaymentController{constructor(){const _0x473c7a=a8_0x527325;this[_0x473c7a(0x120)]=async(_0x479359,_0x58bb3c,_0x888bf7)=>{const _0x11f7d4=_0x473c7a;try{const _0x5cc08b=_0x479359['body'],_0x4972ca=await this[_0x11f7d4(0x10f)][_0x11f7d4(0x120)](_0x5cc08b);_0x58bb3c[_0x11f7d4(0x16e)](0xc9)['json']({'success':!![],'message':_0x11f7d4(0x131),'result':_0x4972ca});}catch(_0x29f06){_0x888bf7(_0x29f06);}},this[_0x473c7a(0x132)]=async(_0x468572,_0x3d4592,_0x18d96c)=>{const _0x216f47=_0x473c7a;try{const {id:_0x46c2e3}=_0x468572[_0x216f47(0x11f)],_0x4cb993=await this['paymentService'][_0x216f47(0x132)](_0x46c2e3);if(!_0x4cb993)return _0x3d4592[_0x216f47(0x16e)](0x194)[_0x216f47(0x14d)]({'success':![],'message':_0x216f47(0x164)});_0x3d4592['json']({'success':!![],'result':_0x4cb993});}catch(_0x3682bf){_0x18d96c(_0x3682bf);}},this[_0x473c7a(0x167)]=async(_0x3ffcfc,_0x1069b8,_0x171341)=>{const _0xc6dfed=_0x473c7a;try{const {id:_0x233dea}=_0x3ffcfc[_0xc6dfed(0x11f)],_0x35bdef=await this[_0xc6dfed(0x10f)]['getPaymentById'](_0x233dea);if(!_0x35bdef)return _0x1069b8[_0xc6dfed(0x16e)](0x194)[_0xc6dfed(0x14d)]({'success':![],'message':_0xc6dfed(0x164)});_0x1069b8['json']({'success':!![],'result':_0x35bdef});}catch(_0x3f7054){_0x171341(_0x3f7054);}},this[_0x473c7a(0x10c)]=async(_0xf8178c,_0x58db5e,_0x28adf1)=>{const _0x1af3ba=_0x473c7a;try{const {id:_0x1737fa}=_0xf8178c[_0x1af3ba(0x11f)],{cardData:_0x3652ae,cardHolder:_0x2a323b,browser:_0x58f775}=_0xf8178c[_0x1af3ba(0x13f)];console[_0x1af3ba(0x136)](_0x1af3ba(0x155)+_0x1737fa);const _0x48f5d2=await database_1[_0x1af3ba(0x174)][_0x1af3ba(0x13d)][_0x1af3ba(0x147)]({'where':{'id':_0x1737fa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x48f5d2)return _0x58db5e[_0x1af3ba(0x16e)](0x194)[_0x1af3ba(0x14d)]({'success':![],'message':_0x1af3ba(0x164)});if(_0x48f5d2[_0x1af3ba(0x11a)]!==_0x1af3ba(0x115))return _0x58db5e[_0x1af3ba(0x16e)](0x190)['json']({'success':![],'message':_0x1af3ba(0x15f)});if(_0x48f5d2[_0x1af3ba(0x16e)]!==_0x1af3ba(0x10a))return _0x58db5e['status'](0x190)['json']({'success':![],'message':_0x1af3ba(0x158)+_0x48f5d2['status']+_0x1af3ba(0x135)});const _0x13ea93=_0x1af3ba(0x166),_0x3c20e2=_0x48f5d2[_0x1af3ba(0x11b)];console[_0x1af3ba(0x136)](_0x1af3ba(0x119)),console[_0x1af3ba(0x136)](_0x1af3ba(0x15b)+_0x13ea93),console[_0x1af3ba(0x136)](_0x1af3ba(0x168)+_0x3c20e2);const _0x33500e=await this[_0x1af3ba(0x13a)][_0x1af3ba(0x160)]({'paymentId':_0x48f5d2['id'],'orderId':_0x48f5d2[_0x1af3ba(0x165)]||_0x48f5d2['id'],'amount':_0x48f5d2[_0x1af3ba(0x11c)],'currency':_0x48f5d2['currency'],'cardData':_0x3652ae,'resultUrl':_0x13ea93,'returnUrl':_0x3c20e2,'cardHolder':_0x2a323b,'browser':_0x58f775});console[_0x1af3ba(0x136)](_0x1af3ba(0x175),_0x33500e);const _0x2c3518={'status':_0x33500e['status'],'updatedAt':new Date(),'statusChangedBy':_0x1af3ba(0x15c),'statusChangedAt':new Date()};if(_0x33500e[_0x1af3ba(0x16e)]==='PAID')_0x2c3518[_0x1af3ba(0x172)]=new Date(),_0x2c3518[_0x1af3ba(0x13c)]=_0x33500e[_0x1af3ba(0x16f)];else _0x33500e[_0x1af3ba(0x16e)]===_0x1af3ba(0x138)&&(_0x2c3518[_0x1af3ba(0x118)]='Card\x20payment\x20failed');_0x2c3518[_0x1af3ba(0x176)]=_0x1af3ba(0x115),await database_1[_0x1af3ba(0x174)][_0x1af3ba(0x13d)][_0x1af3ba(0x10b)]({'where':{'id':_0x48f5d2['id']},'data':_0x2c3518}),await database_1[_0x1af3ba(0x174)][_0x1af3ba(0x12d)]['create']({'data':{'paymentId':_0x48f5d2['id'],'shopId':_0x48f5d2['shopId'],'event':_0x1af3ba(0x14e)+_0x33500e['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1af3ba(0x10a),'newStatus':_0x33500e['status'],'gatewayPaymentId':_0x33500e[_0x1af3ba(0x16f)],'requires3ds':_0x33500e['requires_3ds'],'processedAt':new Date()['toISOString']()})}});_0x33500e[_0x1af3ba(0x163)]&&(await this[_0x1af3ba(0x152)](_0x48f5d2,_0x33500e[_0x1af3ba(0x16e)],_0x33500e[_0x1af3ba(0x16f)]),await this[_0x1af3ba(0x113)](_0x48f5d2,_0x33500e[_0x1af3ba(0x16e)]));console['log'](_0x1af3ba(0x108)+_0x1737fa+_0x1af3ba(0x107)+_0x33500e[_0x1af3ba(0x16e)]);if(_0x33500e[_0x1af3ba(0x16e)]===_0x1af3ba(0x139))_0x58db5e[_0x1af3ba(0x14d)]({'success':!![],'message':_0x1af3ba(0x130),'result':{'status':_0x1af3ba(0x139),'gatewayPaymentId':_0x33500e[_0x1af3ba(0x16f)],'redirectUrl':_0x3c20e2,'final':!![]}});else _0x33500e['requires_3ds']&&_0x33500e[_0x1af3ba(0x161)]?_0x58db5e['json']({'success':!![],'message':_0x1af3ba(0x14c),'result':{'status':_0x1af3ba(0x10a),'gatewayPaymentId':_0x33500e[_0x1af3ba(0x16f)],'redirectUrl':_0x33500e[_0x1af3ba(0x161)],'requires3ds':!![],'final':![]}}):_0x58db5e[_0x1af3ba(0x16e)](0x190)[_0x1af3ba(0x14d)]({'success':![],'message':_0x1af3ba(0x169),'result':{'status':'FAILED','gatewayPaymentId':_0x33500e[_0x1af3ba(0x16f)],'redirectUrl':_0x48f5d2[_0x1af3ba(0x171)],'final':!![]}});}catch(_0x4aee45){_0x28adf1(_0x4aee45);}},this[_0x473c7a(0x10f)]=new paymentService_1[(_0x473c7a(0x128))](),this[_0x473c7a(0x13a)]=new mastercardService_1[(_0x473c7a(0x106))](),this[_0x473c7a(0x162)]=new webhookService_1[(_0x473c7a(0x173))]();}async[a8_0x527325(0x152)](_0x2d7fce,_0x582960,_0x420dd1){const _0x310e0e=a8_0x527325,_0x37ac75=Date[_0x310e0e(0x109)]();try{const _0x24044a=_0x2d7fce[_0x310e0e(0x133)],_0x26d573=_0x24044a[_0x310e0e(0x105)];if(!_0x26d573?.[_0x310e0e(0x104)]){console['log'](_0x310e0e(0x14f)+_0x24044a['id']);return;}const _0x45c756=_0x582960===_0x310e0e(0x139)?_0x310e0e(0x150):_0x310e0e(0x159);let _0xc042a8=[];if(_0x26d573[_0x310e0e(0x16d)])try{_0xc042a8=Array[_0x310e0e(0x16c)](_0x26d573[_0x310e0e(0x16d)])?_0x26d573['webhookEvents']:JSON[_0x310e0e(0x117)](_0x26d573[_0x310e0e(0x16d)]);}catch(_0x4f70fa){console[_0x310e0e(0x121)]('Error\x20parsing\x20webhook\x20events:',_0x4f70fa),_0xc042a8=[];}if(!_0xc042a8[_0x310e0e(0x14b)](_0x45c756)){console[_0x310e0e(0x136)](_0x310e0e(0x12a)+_0x45c756+'\x20not\x20enabled\x20for\x20shop\x20'+_0x24044a['id']);return;}const _0x32397e={'event':_0x45c756,'payment':{'id':_0x2d7fce['id'],'order_id':_0x2d7fce[_0x310e0e(0x12c)],'gateway_order_id':_0x2d7fce['gatewayOrderId'],'gateway':'1111','amount':_0x2d7fce[_0x310e0e(0x11c)],'currency':_0x2d7fce[_0x310e0e(0x112)],'status':_0x582960[_0x310e0e(0x127)](),'customer_email':_0x2d7fce[_0x310e0e(0x11d)],'customer_name':_0x2d7fce['customerName'],'gateway_payment_id':_0x420dd1,'created_at':_0x2d7fce[_0x310e0e(0x177)],'updated_at':new Date()}},_0x260637=await fetch(_0x26d573[_0x310e0e(0x104)],{'method':_0x310e0e(0x129),'headers':{'Content-Type':_0x310e0e(0x126),'User-Agent':_0x310e0e(0x144)},'body':JSON[_0x310e0e(0x141)](_0x32397e)}),_0x104977=Date[_0x310e0e(0x109)]()-_0x37ac75;console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x26d573[_0x310e0e(0x104)]+_0x310e0e(0x13b)+_0x260637[_0x310e0e(0x16e)]+'\x20('+_0x104977+'ms)');}catch(_0x377f45){console[_0x310e0e(0x121)](_0x310e0e(0x16a),_0x377f45);}}async[a8_0x527325(0x113)](_0x95dfc8,_0x4f66b9){const _0x178d89=a8_0x527325;try{const {telegramBotService:_0x4fab21}=await Promise[_0x178d89(0x116)]()[_0x178d89(0x149)](()=>__importStar(require(_0x178d89(0x12f)))),_0x25f2f0={'PAID':_0x178d89(0x14a),'FAILED':'failed'},_0x342dc9=_0x25f2f0[_0x4f66b9];if(!_0x342dc9)return;await _0x4fab21[_0x178d89(0x146)](_0x95dfc8[_0x178d89(0x154)],_0x95dfc8,_0x342dc9);}catch(_0x1a1c5a){console[_0x178d89(0x121)](_0x178d89(0x157),_0x1a1c5a);}}}function a8_0x56a9(_0x1e03c8,_0xdb8ad4){const _0x30fde5=a8_0x30fd();return a8_0x56a9=function(_0x56a90b,_0x3c0547){_0x56a90b=_0x56a90b-0x104;let _0x388115=_0x30fde5[_0x56a90b];return _0x388115;},a8_0x56a9(_0x1e03c8,_0xdb8ad4);}function a8_0x30fd(){const _0x80a172=['MasterCardService','\x20processed:\x20','✅\x20MasterCard\x20payment\x20','now','PENDING','update','processMasterCardPayment','__setModuleDefault','798804gDGuHH','paymentService','2163tcvpCC','writable','currency','sendPaymentStatusNotification','../services/paymentService','mastercard','resolve','parse','failureMessage','💳\x20MasterCard\x20URLs:','gateway','successUrl','amount','customerEmail','length','params','createPublicPayment','error','257411nNLeef','2264RFYFMM','getOwnPropertyNames','defineProperty','application/json','toLowerCase','PaymentService','POST','Webhook\x20event\x20','create','orderId','webhookLog','../services/webhookService','../services/telegramBotService','Payment\x20processed\x20successfully','Payment\x20created\x20successfully','getPaymentStatus','shop','__importDefault',',\x20cannot\x20process','log','716IwfHsl','FAILED','PAID','masterCardService','\x20with\x20status\x20','gatewayPaymentId','payment','PaymentController','body','7135MMYoPx','stringify','get','__esModule','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','__importStar','sendPaymentNotification','findUnique','7125120XtlOUr','then','paid','includes','3DS\x20verification\x20required','json','mastercard_','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','payment.success','../config/database','sendShopWebhook','30EBtUYs','shopId','💳\x20Processing\x20MasterCard\x20payment:\x20','5173476NzLfkI','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20status\x20is\x20','payment.failed','77929PRfWGR','\x20\x20\x20Result\x20URL\x20(webhook):\x20','system','__createBinding','call','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','processCardPayment','threeds_url','webhookService','final','Payment\x20not\x20found','gatewayOrderId','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','getPaymentById','\x20\x20\x20Return\x20URL:\x20','Payment\x20failed','Failed\x20to\x20send\x20MasterCard\x20webhook:','configurable','isArray','webhookEvents','status','gateway_payment_id','50EweVqI','failUrl','paidAt','WebhookService','default','💳\x20MasterCard\x20result:','paymentMethod','createdAt','webhookUrl','settings'];a8_0x30fd=function(){return _0x80a172;};return a8_0x30fd();}exports[a8_0x527325(0x13e)]=PaymentController;