'use strict';function a8_0xc713(){const _0x3ca956=['sendPaymentNotification','getOwnPropertyNames','gatewayOrderId','Payment\x20not\x20found','webhookLog','Failed\x20to\x20send\x20MasterCard\x20webhook:','../config/database','222DNVjNu','customerUa','successUrl','then','processCardPayment','body','stringify','7342jeCjPW','default','sendPaymentStatusNotification','../services/paymentService','paidAt','\x20with\x20status\x20','application/json','üí≥\x20MasterCard\x20URLs:','21834dqFzbF','amount','\x20not\x20enabled\x20for\x20shop\x20','requires_3ds','createdAt','customerCountry','__createBinding','shop','findUnique','number','updatePaymentCustomerDataPublic','params','104406KlwMuk','update',',\x20cannot\x20process','ms)','failureMessage','updatedAt','__esModule','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','4820512CphyWq','paid','last_name','PaymentService','now','prototype','paymentService','105NJhWRl','create','hasOwnProperty','shopId','1739148wNzLkJ','../services/gateways/mastercardService','system','length','Webhook\x20event\x20','\x20\x20\x20Return\x20URL:\x20','9664218obYNBA','call','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','gateway','customerIp','742550ytbxmB','payment.success','mastercard','get','1111','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','processMasterCardPayment','log','Payment\x20processed\x20successfully','configurable','webhookUrl','payment.failed','Payment\x20created\x20successfully','\x20processed:\x20','üìà\x20MasterCard\x20payment\x20','parse','defineProperty','üìù\x20Customer\x20data:','toLowerCase','cardLast4','üí≥\x20MasterCard\x20result:','first_name','final','FAILED','payment','Error\x20parsing\x20webhook\x20events:','üí≥\x20Browser\x20IP:\x20','üí≥\x20Card\x20holder:\x20','getPaymentById','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PENDING','__importStar','Payment\x20failed','customerEmail','paymentMethod','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','handleSuccessfulPayment','PAID','Card\x20payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','status','masterCardService','gatewayPaymentId','‚úÖ\x20MasterCard\x20payment\x20','mastercard_','includes','error','resolve','threeds_url','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','../services/webhookService','currency','json','gateway_payment_id','__setModuleDefault','email','webhookEvents','https://api.trapay.uk/api/webhooks/gateway/mastercard','Customer\x20data\x20updated\x20successfully','webhookService','getPaymentStatus'];a8_0xc713=function(){return _0x3ca956;};return a8_0xc713();}const a8_0x348cb0=a8_0x4cd5;function a8_0x4cd5(_0x20aa1f,_0x18d5cd){const _0xc71325=a8_0xc713();return a8_0x4cd5=function(_0x4cd532,_0x573bd4){_0x4cd532=_0x4cd532-0xd5;let _0x5ca26a=_0xc71325[_0x4cd532];return _0x5ca26a;},a8_0x4cd5(_0x20aa1f,_0x18d5cd);}(function(_0x596326,_0x43b9c5){const _0x2b14a9=a8_0x4cd5,_0x74fe3b=_0x596326();while(!![]){try{const _0x25dd2a=-parseInt(_0x2b14a9(0xdb))/0x1+-parseInt(_0x2b14a9(0x150))/0x2*(-parseInt(_0x2b14a9(0x149))/0x3)+-parseInt(_0x2b14a9(0xfa))/0x4+-parseInt(_0x2b14a9(0x105))/0x5+parseInt(_0x2b14a9(0xe7))/0x6*(parseInt(_0x2b14a9(0xf6))/0x7)+-parseInt(_0x2b14a9(0xef))/0x8+parseInt(_0x2b14a9(0x100))/0x9;if(_0x25dd2a===_0x43b9c5)break;else _0x74fe3b['push'](_0x74fe3b['shift']());}catch(_0x395faf){_0x74fe3b['push'](_0x74fe3b['shift']());}}}(a8_0xc713,0x615b8));var __createBinding=this&&this[a8_0x348cb0(0xe1)]||(Object[a8_0x348cb0(0xf7)]?function(_0x2044bd,_0x2bb1d5,_0x26c8f8,_0x1a1396){const _0x269337=a8_0x348cb0;if(_0x1a1396===undefined)_0x1a1396=_0x26c8f8;var _0x500a36=Object['getOwnPropertyDescriptor'](_0x2bb1d5,_0x26c8f8);(!_0x500a36||(_0x269337(0x108)in _0x500a36?!_0x2bb1d5[_0x269337(0xed)]:_0x500a36['writable']||_0x500a36[_0x269337(0x10e)]))&&(_0x500a36={'enumerable':!![],'get':function(){return _0x2bb1d5[_0x26c8f8];}}),Object[_0x269337(0x115)](_0x2044bd,_0x1a1396,_0x500a36);}:function(_0x367c52,_0x316c9d,_0x19b8f7,_0x260178){if(_0x260178===undefined)_0x260178=_0x19b8f7;_0x367c52[_0x260178]=_0x316c9d[_0x19b8f7];}),__setModuleDefault=this&&this[a8_0x348cb0(0x13b)]||(Object[a8_0x348cb0(0xf7)]?function(_0x2c6ce3,_0x306ba2){Object['defineProperty'](_0x2c6ce3,'default',{'enumerable':!![],'value':_0x306ba2});}:function(_0x1582e6,_0x145850){const _0x283778=a8_0x348cb0;_0x1582e6[_0x283778(0x151)]=_0x145850;}),__importStar=this&&this[a8_0x348cb0(0x124)]||(function(){var _0x4b159b=function(_0x246e0f){const _0x37f8b1=a8_0x4cd5;return _0x4b159b=Object[_0x37f8b1(0x143)]||function(_0x2ee4ee){const _0x219cba=_0x37f8b1;var _0x4b52e9=[];for(var _0x9c4350 in _0x2ee4ee)if(Object[_0x219cba(0xf4)][_0x219cba(0xf8)][_0x219cba(0x101)](_0x2ee4ee,_0x9c4350))_0x4b52e9[_0x4b52e9[_0x219cba(0xfd)]]=_0x9c4350;return _0x4b52e9;},_0x4b159b(_0x246e0f);};return function(_0x1d2e35){const _0x2910cd=a8_0x4cd5;if(_0x1d2e35&&_0x1d2e35[_0x2910cd(0xed)])return _0x1d2e35;var _0x585f34={};if(_0x1d2e35!=null){for(var _0x537d52=_0x4b159b(_0x1d2e35),_0x5d174a=0x0;_0x5d174a<_0x537d52[_0x2910cd(0xfd)];_0x5d174a++)if(_0x537d52[_0x5d174a]!==_0x2910cd(0x151))__createBinding(_0x585f34,_0x1d2e35,_0x537d52[_0x5d174a]);}return __setModuleDefault(_0x585f34,_0x1d2e35),_0x585f34;};}()),__importDefault=this&&this['__importDefault']||function(_0x530135){const _0x40d4f5=a8_0x348cb0;return _0x530135&&_0x530135[_0x40d4f5(0xed)]?_0x530135:{'default':_0x530135};};Object['defineProperty'](exports,a8_0x348cb0(0xed),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x348cb0(0xd6)),mastercardService_1=require(a8_0x348cb0(0xfb)),webhookService_1=require(a8_0x348cb0(0x137)),database_1=__importDefault(require(a8_0x348cb0(0x148)));class PaymentController{constructor(){const _0x2835d9=a8_0x348cb0;this['createPublicPayment']=async(_0x17a8e6,_0x2290e2,_0x5b608b)=>{const _0x34b55c=a8_0x4cd5;try{const _0xfc8220=_0x17a8e6['body'],_0x3129f2=await this['paymentService']['createPublicPayment'](_0xfc8220);_0x2290e2[_0x34b55c(0x12d)](0xc9)[_0x34b55c(0x139)]({'success':!![],'message':_0x34b55c(0x111),'result':_0x3129f2});}catch(_0x314b1e){_0x5b608b(_0x314b1e);}},this[_0x2835d9(0x141)]=async(_0x137866,_0x2e3379,_0x33e630)=>{const _0x34347d=_0x2835d9;try{const {id:_0x550055}=_0x137866['params'],_0x1955f5=await this[_0x34347d(0xf5)][_0x34347d(0x141)](_0x550055);if(!_0x1955f5)return _0x2e3379['status'](0x194)[_0x34347d(0x139)]({'success':![],'message':'Payment\x20not\x20found'});_0x2e3379[_0x34347d(0x139)]({'success':!![],'result':_0x1955f5});}catch(_0x2f3ff0){_0x33e630(_0x2f3ff0);}},this[_0x2835d9(0x121)]=async(_0x193fb0,_0x303d0e,_0x241b64)=>{const _0x4879e2=_0x2835d9;try{const {id:_0xa88e6b}=_0x193fb0[_0x4879e2(0xe6)],_0x1b012a=await this[_0x4879e2(0xf5)][_0x4879e2(0x121)](_0xa88e6b);if(!_0x1b012a)return _0x303d0e['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x303d0e['json']({'success':!![],'result':_0x1b012a});}catch(_0x4d337c){_0x241b64(_0x4d337c);}},this['updatePaymentCustomer']=async(_0x47c145,_0x2dcc54,_0x134d83)=>{const _0x4f0664=_0x2835d9;try{const {id:_0x4e3c4a}=_0x47c145[_0x4f0664(0xe6)],_0x5755dd=_0x47c145[_0x4f0664(0x14e)];console[_0x4f0664(0x10c)](_0x4f0664(0xee)+_0x4e3c4a),console[_0x4f0664(0x10c)](_0x4f0664(0x116),_0x5755dd);const _0x1c8cf7=await this[_0x4f0664(0xf5)][_0x4f0664(0xe5)](_0x4e3c4a,_0x5755dd);if(!_0x1c8cf7)return _0x2dcc54['status'](0x194)[_0x4f0664(0x139)]({'success':![],'message':_0x4f0664(0x145)});_0x2dcc54[_0x4f0664(0x139)]({'success':!![],'message':_0x4f0664(0x13f),'result':{'paymentId':_0x1c8cf7['id'],'customerIp':_0x1c8cf7[_0x4f0664(0x104)],'customerUa':_0x1c8cf7[_0x4f0664(0x14a)],'customerCountry':_0x1c8cf7[_0x4f0664(0xe0)],'updatedAt':_0x1c8cf7[_0x4f0664(0xec)]}});}catch(_0x2c50aa){_0x134d83(_0x2c50aa);}},this[_0x2835d9(0x10b)]=async(_0x4e019d,_0x5b4602,_0xa4886c)=>{const _0x3e12fa=_0x2835d9;try{const {id:_0x407cc6}=_0x4e019d['params'],{cardData:_0x548c8c,cardHolder:_0x3be96f,browser:_0xd33e7c}=_0x4e019d['body'];console[_0x3e12fa(0x10c)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x407cc6),console[_0x3e12fa(0x10c)](_0x3e12fa(0x120)+_0x3be96f[_0x3e12fa(0x11a)]+'\x20'+_0x3be96f[_0x3e12fa(0xf1)]+'\x20('+_0x3be96f[_0x3e12fa(0x13c)]+')'),console[_0x3e12fa(0x10c)](_0x3e12fa(0x11f)+_0xd33e7c['ip']);const _0x1f9368={'customerName':_0x3be96f[_0x3e12fa(0x11a)]+'\x20'+_0x3be96f[_0x3e12fa(0xf1)],'customerEmail':_0x3be96f[_0x3e12fa(0x13c)],'customerIp':_0xd33e7c['ip'],'customerUa':_0xd33e7c['user_agent']},_0x502999=await database_1['default'][_0x3e12fa(0x11d)][_0x3e12fa(0xe3)]({'where':{'id':_0x407cc6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x502999)return _0x5b4602[_0x3e12fa(0x12d)](0x194)[_0x3e12fa(0x139)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x502999[_0x3e12fa(0x103)]!=='mastercard')return _0x5b4602['status'](0x190)[_0x3e12fa(0x139)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x502999[_0x3e12fa(0x12d)]!==_0x3e12fa(0x123))return _0x5b4602['status'](0x190)[_0x3e12fa(0x139)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x502999['status']+_0x3e12fa(0xe9)});await database_1[_0x3e12fa(0x151)]['payment'][_0x3e12fa(0xe8)]({'where':{'id':_0x407cc6},'data':{..._0x1f9368,'updatedAt':new Date()}});const _0x569d87=_0x3e12fa(0x13e),_0x4b1f0b=_0x502999[_0x3e12fa(0x14b)];console[_0x3e12fa(0x10c)](_0x3e12fa(0xda)),console[_0x3e12fa(0x10c)](_0x3e12fa(0x12c)+_0x569d87),console[_0x3e12fa(0x10c)](_0x3e12fa(0xff)+_0x4b1f0b);const _0x50453f={'first_name':_0x3be96f[_0x3e12fa(0x11a)],'last_name':_0x3be96f[_0x3e12fa(0xf1)],'email':_0x3be96f[_0x3e12fa(0x13c)]},_0x5d46e2=await this['masterCardService'][_0x3e12fa(0x14d)]({'paymentId':_0x502999['id'],'orderId':_0x502999[_0x3e12fa(0x144)]||_0x502999['id'],'amount':_0x502999[_0x3e12fa(0xdc)],'currency':_0x502999[_0x3e12fa(0x138)],'cardData':_0x548c8c,'resultUrl':_0x569d87,'returnUrl':_0x4b1f0b,'cardHolder':_0x50453f,'browser':_0xd33e7c});console[_0x3e12fa(0x10c)](_0x3e12fa(0x119),_0x5d46e2);const _0x4e5f92={'status':_0x5d46e2[_0x3e12fa(0x12d)],'updatedAt':new Date(),'statusChangedBy':_0x3e12fa(0xfc),'statusChangedAt':new Date()};_0x5d46e2[_0x3e12fa(0x13a)]&&(_0x4e5f92[_0x3e12fa(0x12f)]=_0x5d46e2['gateway_payment_id'],console[_0x3e12fa(0x10c)](_0x3e12fa(0x10a)+_0x5d46e2['gateway_payment_id']));if(_0x5d46e2[_0x3e12fa(0x12d)]==='PAID')_0x4e5f92[_0x3e12fa(0xd7)]=new Date();else _0x5d46e2['status']===_0x3e12fa(0x11c)&&(_0x4e5f92[_0x3e12fa(0xeb)]=_0x3e12fa(0x12b));_0x4e5f92[_0x3e12fa(0x127)]=_0x3e12fa(0x107);if(_0x548c8c[_0x3e12fa(0xe4)]){const _0x3bc6b8=_0x548c8c[_0x3e12fa(0xe4)]['replace'](/[\s-]/g,'');_0x4e5f92[_0x3e12fa(0x118)]=_0x3bc6b8['slice'](-0x4),console[_0x3e12fa(0x10c)](_0x3e12fa(0x136)+_0x4e5f92[_0x3e12fa(0x118)]);}await database_1['default'][_0x3e12fa(0x11d)][_0x3e12fa(0xe8)]({'where':{'id':_0x502999['id']},'data':_0x4e5f92}),await database_1[_0x3e12fa(0x151)][_0x3e12fa(0x146)][_0x3e12fa(0xf7)]({'data':{'paymentId':_0x502999['id'],'shopId':_0x502999[_0x3e12fa(0xf9)],'event':_0x3e12fa(0x131)+_0x5d46e2[_0x3e12fa(0x12d)]?.[_0x3e12fa(0x117)](),'statusCode':0xc8,'responseBody':JSON[_0x3e12fa(0x14f)]({'oldStatus':'PENDING','newStatus':_0x5d46e2[_0x3e12fa(0x12d)],'gatewayPaymentId':_0x5d46e2[_0x3e12fa(0x13a)],'requires3ds':_0x5d46e2[_0x3e12fa(0xde)],'processedAt':new Date()['toISOString']()})}});if(_0x5d46e2[_0x3e12fa(0x11b)]){await this['sendShopWebhook'](_0x502999,_0x5d46e2[_0x3e12fa(0x12d)],_0x5d46e2[_0x3e12fa(0x13a)]),await this[_0x3e12fa(0xd5)](_0x502999,_0x5d46e2[_0x3e12fa(0x12d)]);if(_0x5d46e2['status']===_0x3e12fa(0x12a)){console['log'](_0x3e12fa(0x113)+_0x407cc6+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x56bc66}=await Promise[_0x3e12fa(0x134)]()[_0x3e12fa(0x14c)](()=>__importStar(require('../services/paymentLinkService'))),_0x2e6593=new _0x56bc66();await _0x2e6593[_0x3e12fa(0x129)](_0x407cc6),console[_0x3e12fa(0x10c)](_0x3e12fa(0x102)+_0x407cc6);}catch(_0x2e88d7){console[_0x3e12fa(0x133)](_0x3e12fa(0x128),_0x2e88d7);}}}console[_0x3e12fa(0x10c)](_0x3e12fa(0x130)+_0x407cc6+_0x3e12fa(0x112)+_0x5d46e2[_0x3e12fa(0x12d)]);if(_0x5d46e2['status']===_0x3e12fa(0x12a))_0x5b4602['json']({'success':!![],'message':_0x3e12fa(0x10d),'result':{'status':_0x3e12fa(0x12a),'gatewayPaymentId':_0x5d46e2[_0x3e12fa(0x13a)],'redirectUrl':_0x4b1f0b,'final':!![]}});else _0x5d46e2[_0x3e12fa(0xde)]&&_0x5d46e2[_0x3e12fa(0x135)]?_0x5b4602[_0x3e12fa(0x139)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x5d46e2[_0x3e12fa(0x13a)],'redirectUrl':_0x5d46e2[_0x3e12fa(0x135)],'requires3ds':!![],'final':![]}}):_0x5b4602[_0x3e12fa(0x12d)](0x190)[_0x3e12fa(0x139)]({'success':![],'message':_0x3e12fa(0x125),'result':{'status':_0x3e12fa(0x11c),'gatewayPaymentId':_0x5d46e2['gateway_payment_id'],'redirectUrl':_0x502999['failUrl'],'final':!![]}});}catch(_0x5c3464){_0xa4886c(_0x5c3464);}},this[_0x2835d9(0xf5)]=new paymentService_1[(_0x2835d9(0xf2))](),this[_0x2835d9(0x12e)]=new mastercardService_1['MasterCardService'](),this[_0x2835d9(0x140)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x16068f,_0x3f9a0f,_0x3729ea){const _0x585a4d=a8_0x348cb0,_0x1064fa=Date['now']();try{const _0x340717=_0x16068f[_0x585a4d(0xe2)],_0x58cab2=_0x340717['settings'];if(!_0x58cab2?.[_0x585a4d(0x10f)]){console['log'](_0x585a4d(0x122)+_0x340717['id']);return;}const _0x12c092=_0x3f9a0f==='PAID'?_0x585a4d(0x106):_0x585a4d(0x110);let _0x10fe2c=[];if(_0x58cab2[_0x585a4d(0x13d)])try{_0x10fe2c=Array['isArray'](_0x58cab2[_0x585a4d(0x13d)])?_0x58cab2[_0x585a4d(0x13d)]:JSON[_0x585a4d(0x114)](_0x58cab2['webhookEvents']);}catch(_0x36d48a){console[_0x585a4d(0x133)](_0x585a4d(0x11e),_0x36d48a),_0x10fe2c=[];}if(!_0x10fe2c[_0x585a4d(0x132)](_0x12c092)){console['log'](_0x585a4d(0xfe)+_0x12c092+_0x585a4d(0xdd)+_0x340717['id']);return;}const _0x55321f={'event':_0x12c092,'payment':{'id':_0x16068f['id'],'order_id':_0x16068f['orderId'],'gateway_order_id':_0x16068f[_0x585a4d(0x144)],'gateway':_0x585a4d(0x109),'amount':_0x16068f[_0x585a4d(0xdc)],'currency':_0x16068f[_0x585a4d(0x138)],'status':_0x3f9a0f['toLowerCase'](),'customer_email':_0x16068f[_0x585a4d(0x126)],'customer_name':_0x16068f['customerName'],'gateway_payment_id':_0x3729ea,'created_at':_0x16068f[_0x585a4d(0xdf)],'updated_at':new Date()}},_0x90ad71=await fetch(_0x58cab2[_0x585a4d(0x10f)],{'method':'POST','headers':{'Content-Type':_0x585a4d(0xd9),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x585a4d(0x14f)](_0x55321f)}),_0x2c073a=Date[_0x585a4d(0xf3)]()-_0x1064fa;console[_0x585a4d(0x10c)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x58cab2[_0x585a4d(0x10f)]+_0x585a4d(0xd8)+_0x90ad71[_0x585a4d(0x12d)]+'\x20('+_0x2c073a+_0x585a4d(0xea));}catch(_0x1b9ae0){console[_0x585a4d(0x133)](_0x585a4d(0x147),_0x1b9ae0);}}async['sendPaymentStatusNotification'](_0x36d1bf,_0xd14a83){const _0x1dde51=a8_0x348cb0;try{const {telegramBotService:_0x217f25}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x25e4f0={'PAID':_0x1dde51(0xf0),'FAILED':'failed'},_0x2d223e=_0x25e4f0[_0xd14a83];if(!_0x2d223e)return;await _0x217f25[_0x1dde51(0x142)](_0x36d1bf[_0x1dde51(0xf9)],_0x36d1bf,_0x2d223e);}catch(_0x2f454b){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x2f454b);}}}exports['PaymentController']=PaymentController;