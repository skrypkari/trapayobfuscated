'use strict';const a8_0x1763e5=a8_0x40d4;(function(_0x463378,_0x117220){const _0x201b3a=a8_0x40d4,_0x12f2d2=_0x463378();while(!![]){try{const _0x27cc82=-parseInt(_0x201b3a(0x1da))/0x1*(-parseInt(_0x201b3a(0x1c8))/0x2)+parseInt(_0x201b3a(0x1db))/0x3*(parseInt(_0x201b3a(0x1bb))/0x4)+-parseInt(_0x201b3a(0x1c4))/0x5+-parseInt(_0x201b3a(0x1bc))/0x6+-parseInt(_0x201b3a(0x1e6))/0x7+parseInt(_0x201b3a(0x198))/0x8*(-parseInt(_0x201b3a(0x1e4))/0x9)+parseInt(_0x201b3a(0x188))/0xa*(parseInt(_0x201b3a(0x1dd))/0xb);if(_0x27cc82===_0x117220)break;else _0x12f2d2['push'](_0x12f2d2['shift']());}catch(_0x112135){_0x12f2d2['push'](_0x12f2d2['shift']());}}}(a8_0x1ea4,0x6fef2));function a8_0x1ea4(){const _0x489a94=['parse','\x20not\x20enabled\x20for\x20shop\x20','4270vcFuOU','failureMessage','get','updatePaymentCustomer','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','1111','webhookService','toLowerCase','Customer\x20data\x20updated\x20successfully','gatewayPaymentId','paid','findUnique',',\x20cannot\x20process','MasterCardService','mastercard_','4344GAHlIB','getPaymentById','MasterCard\x20webhook\x20sent\x20to\x20','getPaymentStatus','üí≥\x20Card\x20holder:\x20','../services/gateways/mastercardService','__createBinding','getOwnPropertyNames','defineProperty','../services/webhookService','payment','gatewayOrderId','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','\x20processed:\x20','customerUa','__esModule','Payment\x20created\x20successfully','../services/telegramBotService','createPublicPayment','params','handleSuccessfulPayment','system','Payment\x20failed','stringify','paymentService','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','webhookUrl','user_agent','masterCardService','sendPaymentStatusNotification','mastercard','__setModuleDefault','PaymentController','paymentMethod','shopId','4NrUikm','73866sTYXxy','default','create','webhookLog','update','Error\x20parsing\x20webhook\x20events:','../services/paymentLinkService','PAID','2386485lmouAL','POST','üìù\x20Customer\x20data:','cardLast4','1291274olWFWO','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','log','now','üí≥\x20Browser\x20IP:\x20','payment.failed','isArray','resolve','first_name','application/json','includes','email','processCardPayment','createdAt','paidAt','body','Payment\x20processed\x20successfully','\x20\x20\x20Result\x20URL\x20(webhook):\x20','1WOuBQS','1782822AINZJR','Payment\x20not\x20found','28105UKSuUc','customerIp','then','../services/paymentService','../config/database','__importStar','length','13338lkjEnu','writable','4046560bMbpCI','Payment\x20status\x20is\x20','updatedAt','shop','webhookEvents','3DS\x20verification\x20required','number','final','amount','üìà\x20MasterCard\x20payment\x20','payment.success','toISOString','processMasterCardPayment','sendShopWebhook','FAILED','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','currency','üí≥\x20Processing\x20MasterCard\x20payment:\x20','__importDefault','PENDING','threeds_url','json','status','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','failUrl','last_name','error','Card\x20payment\x20failed','gateway_payment_id','call','customerCountry','Failed\x20to\x20send\x20MasterCard\x20webhook:','failed'];a8_0x1ea4=function(){return _0x489a94;};return a8_0x1ea4();}function a8_0x40d4(_0x4d1572,_0x2ee5e6){const _0x1ea437=a8_0x1ea4();return a8_0x40d4=function(_0x40d4ff,_0x494983){_0x40d4ff=_0x40d4ff-0x16b;let _0x5f08fc=_0x1ea437[_0x40d4ff];return _0x5f08fc;},a8_0x40d4(_0x4d1572,_0x2ee5e6);}var __createBinding=this&&this[a8_0x1763e5(0x19e)]||(Object[a8_0x1763e5(0x1be)]?function(_0x24a08a,_0x22fd66,_0x3788a2,_0xb5b1b3){const _0x42b4ce=a8_0x1763e5;if(_0xb5b1b3===undefined)_0xb5b1b3=_0x3788a2;var _0x1d44b7=Object['getOwnPropertyDescriptor'](_0x22fd66,_0x3788a2);(!_0x1d44b7||(_0x42b4ce(0x18a)in _0x1d44b7?!_0x22fd66[_0x42b4ce(0x1a7)]:_0x1d44b7[_0x42b4ce(0x1e5)]||_0x1d44b7['configurable']))&&(_0x1d44b7={'enumerable':!![],'get':function(){return _0x22fd66[_0x3788a2];}}),Object[_0x42b4ce(0x1a0)](_0x24a08a,_0xb5b1b3,_0x1d44b7);}:function(_0x3491a6,_0x244cb0,_0x2c3d94,_0x48b525){if(_0x48b525===undefined)_0x48b525=_0x2c3d94;_0x3491a6[_0x48b525]=_0x244cb0[_0x2c3d94];}),__setModuleDefault=this&&this[a8_0x1763e5(0x1b7)]||(Object[a8_0x1763e5(0x1be)]?function(_0x5685c7,_0x38fb78){const _0x5a4ca3=a8_0x1763e5;Object[_0x5a4ca3(0x1a0)](_0x5685c7,_0x5a4ca3(0x1bd),{'enumerable':!![],'value':_0x38fb78});}:function(_0x43fe43,_0x5ac653){const _0x49cbb4=a8_0x1763e5;_0x43fe43[_0x49cbb4(0x1bd)]=_0x5ac653;}),__importStar=this&&this[a8_0x1763e5(0x1e2)]||(function(){var _0x2e3a05=function(_0x113027){const _0x53bc08=a8_0x40d4;return _0x2e3a05=Object[_0x53bc08(0x19f)]||function(_0x1a52fd){const _0x2edf98=_0x53bc08;var _0xd8a587=[];for(var _0x5a47ea in _0x1a52fd)if(Object['prototype']['hasOwnProperty'][_0x2edf98(0x182)](_0x1a52fd,_0x5a47ea))_0xd8a587[_0xd8a587[_0x2edf98(0x1e3)]]=_0x5a47ea;return _0xd8a587;},_0x2e3a05(_0x113027);};return function(_0x2f488e){const _0x2d300f=a8_0x40d4;if(_0x2f488e&&_0x2f488e['__esModule'])return _0x2f488e;var _0xb77be0={};if(_0x2f488e!=null){for(var _0x5c4d93=_0x2e3a05(_0x2f488e),_0x553720=0x0;_0x553720<_0x5c4d93[_0x2d300f(0x1e3)];_0x553720++)if(_0x5c4d93[_0x553720]!==_0x2d300f(0x1bd))__createBinding(_0xb77be0,_0x2f488e,_0x5c4d93[_0x553720]);}return __setModuleDefault(_0xb77be0,_0x2f488e),_0xb77be0;};}()),__importDefault=this&&this[a8_0x1763e5(0x177)]||function(_0x156472){return _0x156472&&_0x156472['__esModule']?_0x156472:{'default':_0x156472};};Object[a8_0x1763e5(0x1a0)](exports,a8_0x1763e5(0x1a7),{'value':!![]}),exports[a8_0x1763e5(0x1b8)]=void 0x0;const paymentService_1=require(a8_0x1763e5(0x1e0)),mastercardService_1=require(a8_0x1763e5(0x19d)),webhookService_1=require(a8_0x1763e5(0x1a1)),database_1=__importDefault(require(a8_0x1763e5(0x1e1)));class PaymentController{constructor(){const _0x2d7e74=a8_0x1763e5;this[_0x2d7e74(0x1aa)]=async(_0x2963b2,_0x1c950c,_0x426426)=>{const _0x214230=_0x2d7e74;try{const _0xf575e4=_0x2963b2[_0x214230(0x1d7)],_0x5e6020=await this['paymentService']['createPublicPayment'](_0xf575e4);_0x1c950c[_0x214230(0x17b)](0xc9)['json']({'success':!![],'message':_0x214230(0x1a8),'result':_0x5e6020});}catch(_0x2c6f0b){_0x426426(_0x2c6f0b);}},this[_0x2d7e74(0x19b)]=async(_0x28fd10,_0x4ded69,_0x268d00)=>{const _0x2a1686=_0x2d7e74;try{const {id:_0x56cdfc}=_0x28fd10[_0x2a1686(0x1ab)],_0x260746=await this[_0x2a1686(0x1b0)]['getPaymentStatus'](_0x56cdfc);if(!_0x260746)return _0x4ded69[_0x2a1686(0x17b)](0x194)['json']({'success':![],'message':_0x2a1686(0x1dc)});_0x4ded69[_0x2a1686(0x17a)]({'success':!![],'result':_0x260746});}catch(_0x13cc03){_0x268d00(_0x13cc03);}},this['getPaymentById']=async(_0x1f6005,_0x29c373,_0x5a911f)=>{const _0x266041=_0x2d7e74;try{const {id:_0xe578e4}=_0x1f6005[_0x266041(0x1ab)],_0x2c1bc4=await this[_0x266041(0x1b0)][_0x266041(0x199)](_0xe578e4);if(!_0x2c1bc4)return _0x29c373[_0x266041(0x17b)](0x194)[_0x266041(0x17a)]({'success':![],'message':_0x266041(0x1dc)});_0x29c373[_0x266041(0x17a)]({'success':!![],'result':_0x2c1bc4});}catch(_0x1ce202){_0x5a911f(_0x1ce202);}},this[_0x2d7e74(0x18b)]=async(_0x48e3d6,_0x3fef4d,_0x31655c)=>{const _0x3668eb=_0x2d7e74;try{const {id:_0x4df873}=_0x48e3d6[_0x3668eb(0x1ab)],_0x155585=_0x48e3d6[_0x3668eb(0x1d7)];console[_0x3668eb(0x1ca)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x4df873),console[_0x3668eb(0x1ca)](_0x3668eb(0x1c6),_0x155585);const _0x3682a0=await this[_0x3668eb(0x1b0)]['updatePaymentCustomerDataPublic'](_0x4df873,_0x155585);if(!_0x3682a0)return _0x3fef4d[_0x3668eb(0x17b)](0x194)[_0x3668eb(0x17a)]({'success':![],'message':'Payment\x20not\x20found'});_0x3fef4d[_0x3668eb(0x17a)]({'success':!![],'message':_0x3668eb(0x191),'result':{'paymentId':_0x3682a0['id'],'customerIp':_0x3682a0[_0x3668eb(0x1de)],'customerUa':_0x3682a0[_0x3668eb(0x1a6)],'customerCountry':_0x3682a0[_0x3668eb(0x183)],'updatedAt':_0x3682a0[_0x3668eb(0x1e8)]}});}catch(_0x2299dc){_0x31655c(_0x2299dc);}},this[_0x2d7e74(0x171)]=async(_0x67f26b,_0x9e7ecb,_0x320570)=>{const _0x58c13a=_0x2d7e74;try{const {id:_0x3dda9f}=_0x67f26b['params'],{cardData:_0x2966d8,cardHolder:_0x303aae,browser:_0x1b8daf}=_0x67f26b['body'];console['log'](_0x58c13a(0x176)+_0x3dda9f),console[_0x58c13a(0x1ca)](_0x58c13a(0x19c)+_0x303aae[_0x58c13a(0x1d0)]+'\x20'+_0x303aae['last_name']+'\x20('+_0x303aae['email']+')'),console[_0x58c13a(0x1ca)](_0x58c13a(0x1cc)+_0x1b8daf['ip']);const _0x5b3e51={'customerName':_0x303aae['first_name']+'\x20'+_0x303aae[_0x58c13a(0x17e)],'customerEmail':_0x303aae[_0x58c13a(0x1d3)],'customerIp':_0x1b8daf['ip'],'customerUa':_0x1b8daf[_0x58c13a(0x1b3)]},_0x1ecbc8=await database_1['default'][_0x58c13a(0x1a2)][_0x58c13a(0x194)]({'where':{'id':_0x3dda9f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1ecbc8)return _0x9e7ecb[_0x58c13a(0x17b)](0x194)['json']({'success':![],'message':_0x58c13a(0x1dc)});if(_0x1ecbc8['gateway']!==_0x58c13a(0x1b6))return _0x9e7ecb[_0x58c13a(0x17b)](0x190)[_0x58c13a(0x17a)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x1ecbc8['status']!==_0x58c13a(0x178))return _0x9e7ecb[_0x58c13a(0x17b)](0x190)[_0x58c13a(0x17a)]({'success':![],'message':_0x58c13a(0x1e7)+_0x1ecbc8[_0x58c13a(0x17b)]+_0x58c13a(0x195)});await database_1[_0x58c13a(0x1bd)][_0x58c13a(0x1a2)]['update']({'where':{'id':_0x3dda9f},'data':{..._0x5b3e51,'updatedAt':new Date()}});const _0x1f2c9b='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x306f22=_0x1ecbc8['successUrl'];console['log']('üí≥\x20MasterCard\x20URLs:'),console[_0x58c13a(0x1ca)](_0x58c13a(0x1d9)+_0x1f2c9b),console[_0x58c13a(0x1ca)]('\x20\x20\x20Return\x20URL:\x20'+_0x306f22);const _0x42d046={'first_name':_0x303aae[_0x58c13a(0x1d0)],'last_name':_0x303aae[_0x58c13a(0x17e)],'email':_0x303aae['email']},_0x207584=await this[_0x58c13a(0x1b4)][_0x58c13a(0x1d4)]({'paymentId':_0x1ecbc8['id'],'orderId':_0x1ecbc8[_0x58c13a(0x1a3)]||_0x1ecbc8['id'],'amount':_0x1ecbc8[_0x58c13a(0x16d)],'currency':_0x1ecbc8['currency'],'cardData':_0x2966d8,'resultUrl':_0x1f2c9b,'returnUrl':_0x306f22,'cardHolder':_0x42d046,'browser':_0x1b8daf});console[_0x58c13a(0x1ca)]('üí≥\x20MasterCard\x20result:',_0x207584);const _0x438dd1={'status':_0x207584[_0x58c13a(0x17b)],'updatedAt':new Date(),'statusChangedBy':_0x58c13a(0x1ad),'statusChangedAt':new Date()};_0x207584['gateway_payment_id']&&(_0x438dd1[_0x58c13a(0x192)]=_0x207584[_0x58c13a(0x181)],console['log'](_0x58c13a(0x174)+_0x207584[_0x58c13a(0x181)]));if(_0x207584['status']===_0x58c13a(0x1c3))_0x438dd1[_0x58c13a(0x1d6)]=new Date();else _0x207584[_0x58c13a(0x17b)]===_0x58c13a(0x173)&&(_0x438dd1[_0x58c13a(0x189)]=_0x58c13a(0x180));_0x438dd1[_0x58c13a(0x1b9)]='mastercard';if(_0x2966d8[_0x58c13a(0x16b)]){const _0x151f3d=_0x2966d8['number']['replace'](/[\s-]/g,'');_0x438dd1[_0x58c13a(0x1c7)]=_0x151f3d['slice'](-0x4),console['log'](_0x58c13a(0x17c)+_0x438dd1['cardLast4']);}await database_1[_0x58c13a(0x1bd)][_0x58c13a(0x1a2)][_0x58c13a(0x1c0)]({'where':{'id':_0x1ecbc8['id']},'data':_0x438dd1}),await database_1['default'][_0x58c13a(0x1bf)]['create']({'data':{'paymentId':_0x1ecbc8['id'],'shopId':_0x1ecbc8[_0x58c13a(0x1ba)],'event':_0x58c13a(0x197)+_0x207584[_0x58c13a(0x17b)]?.[_0x58c13a(0x190)](),'statusCode':0xc8,'responseBody':JSON[_0x58c13a(0x1af)]({'oldStatus':'PENDING','newStatus':_0x207584[_0x58c13a(0x17b)],'gatewayPaymentId':_0x207584[_0x58c13a(0x181)],'requires3ds':_0x207584['requires_3ds'],'processedAt':new Date()[_0x58c13a(0x170)]()})}});if(_0x207584[_0x58c13a(0x16c)]){await this[_0x58c13a(0x172)](_0x1ecbc8,_0x207584[_0x58c13a(0x17b)],_0x207584[_0x58c13a(0x181)]),await this[_0x58c13a(0x1b5)](_0x1ecbc8,_0x207584[_0x58c13a(0x17b)]);if(_0x207584[_0x58c13a(0x17b)]===_0x58c13a(0x1c3)){console[_0x58c13a(0x1ca)](_0x58c13a(0x16e)+_0x3dda9f+_0x58c13a(0x1c9));try{const {PaymentLinkService:_0x5b7a14}=await Promise['resolve']()['then'](()=>__importStar(require(_0x58c13a(0x1c2)))),_0x260b73=new _0x5b7a14();await _0x260b73[_0x58c13a(0x1ac)](_0x3dda9f),console['log'](_0x58c13a(0x1b1)+_0x3dda9f);}catch(_0x3b8a59){console[_0x58c13a(0x17f)](_0x58c13a(0x1a4),_0x3b8a59);}}}console[_0x58c13a(0x1ca)]('‚úÖ\x20MasterCard\x20payment\x20'+_0x3dda9f+_0x58c13a(0x1a5)+_0x207584[_0x58c13a(0x17b)]);if(_0x207584['status']===_0x58c13a(0x1c3))_0x9e7ecb[_0x58c13a(0x17a)]({'success':!![],'message':_0x58c13a(0x1d8),'result':{'status':_0x58c13a(0x1c3),'gatewayPaymentId':_0x207584[_0x58c13a(0x181)],'redirectUrl':_0x306f22,'final':!![]}});else _0x207584['requires_3ds']&&_0x207584[_0x58c13a(0x179)]?_0x9e7ecb['json']({'success':!![],'message':_0x58c13a(0x1eb),'result':{'status':_0x58c13a(0x178),'gatewayPaymentId':_0x207584['gateway_payment_id'],'redirectUrl':_0x207584[_0x58c13a(0x179)],'requires3ds':!![],'final':![]}}):_0x9e7ecb[_0x58c13a(0x17b)](0x190)[_0x58c13a(0x17a)]({'success':![],'message':_0x58c13a(0x1ae),'result':{'status':_0x58c13a(0x173),'gatewayPaymentId':_0x207584['gateway_payment_id'],'redirectUrl':_0x1ecbc8[_0x58c13a(0x17d)],'final':!![]}});}catch(_0x18805e){_0x320570(_0x18805e);}},this[_0x2d7e74(0x1b0)]=new paymentService_1['PaymentService'](),this[_0x2d7e74(0x1b4)]=new mastercardService_1[(_0x2d7e74(0x196))](),this[_0x2d7e74(0x18f)]=new webhookService_1['WebhookService']();}async[a8_0x1763e5(0x172)](_0x2c3489,_0x23c29f,_0x54ddfc){const _0x1d429a=a8_0x1763e5,_0x314340=Date[_0x1d429a(0x1cb)]();try{const _0x1a5929=_0x2c3489[_0x1d429a(0x1e9)],_0x2d7c79=_0x1a5929['settings'];if(!_0x2d7c79?.['webhookUrl']){console[_0x1d429a(0x1ca)](_0x1d429a(0x18d)+_0x1a5929['id']);return;}const _0x511dec=_0x23c29f===_0x1d429a(0x1c3)?_0x1d429a(0x16f):_0x1d429a(0x1cd);let _0x1784c2=[];if(_0x2d7c79[_0x1d429a(0x1ea)])try{_0x1784c2=Array[_0x1d429a(0x1ce)](_0x2d7c79['webhookEvents'])?_0x2d7c79[_0x1d429a(0x1ea)]:JSON[_0x1d429a(0x186)](_0x2d7c79[_0x1d429a(0x1ea)]);}catch(_0x1d4e44){console[_0x1d429a(0x17f)](_0x1d429a(0x1c1),_0x1d4e44),_0x1784c2=[];}if(!_0x1784c2[_0x1d429a(0x1d2)](_0x511dec)){console[_0x1d429a(0x1ca)]('Webhook\x20event\x20'+_0x511dec+_0x1d429a(0x187)+_0x1a5929['id']);return;}const _0x533885={'event':_0x511dec,'payment':{'id':_0x2c3489['id'],'order_id':_0x2c3489['orderId'],'gateway_order_id':_0x2c3489[_0x1d429a(0x1a3)],'gateway':_0x1d429a(0x18e),'amount':_0x2c3489[_0x1d429a(0x16d)],'currency':_0x2c3489[_0x1d429a(0x175)],'status':_0x23c29f['toLowerCase'](),'customer_email':_0x2c3489['customerEmail'],'customer_name':_0x2c3489['customerName'],'gateway_payment_id':_0x54ddfc,'created_at':_0x2c3489[_0x1d429a(0x1d5)],'updated_at':new Date()}},_0x4ac235=await fetch(_0x2d7c79[_0x1d429a(0x1b2)],{'method':_0x1d429a(0x1c5),'headers':{'Content-Type':_0x1d429a(0x1d1),'User-Agent':_0x1d429a(0x18c)},'body':JSON['stringify'](_0x533885)}),_0x17aea8=Date[_0x1d429a(0x1cb)]()-_0x314340;console[_0x1d429a(0x1ca)](_0x1d429a(0x19a)+_0x2d7c79['webhookUrl']+'\x20with\x20status\x20'+_0x4ac235[_0x1d429a(0x17b)]+'\x20('+_0x17aea8+'ms)');}catch(_0xae7df1){console[_0x1d429a(0x17f)](_0x1d429a(0x184),_0xae7df1);}}async[a8_0x1763e5(0x1b5)](_0x3c3eac,_0x3c46af){const _0x6f34c2=a8_0x1763e5;try{const {telegramBotService:_0x1af260}=await Promise[_0x6f34c2(0x1cf)]()[_0x6f34c2(0x1df)](()=>__importStar(require(_0x6f34c2(0x1a9)))),_0x2a70dc={'PAID':_0x6f34c2(0x193),'FAILED':_0x6f34c2(0x185)},_0x3b8c60=_0x2a70dc[_0x3c46af];if(!_0x3b8c60)return;await _0x1af260['sendPaymentNotification'](_0x3c3eac[_0x6f34c2(0x1ba)],_0x3c3eac,_0x3b8c60);}catch(_0x4c98d0){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4c98d0);}}}exports[a8_0x1763e5(0x1b8)]=PaymentController;