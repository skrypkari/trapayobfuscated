'use strict';const a8_0x5471c4=a8_0x4164;function a8_0x5876(){const _0x49d53f=['masterCardService','defineProperty','requires_3ds','then','__createBinding','Payment\x20failed','payment','Payment\x20not\x20found','\x20not\x20enabled\x20for\x20shop\x20','10338629sPquiI','amount','Payment\x20status\x20is\x20','get','getOwnPropertyNames','mastercard','4aepymm','customerName','log','application/json','body','../services/paymentService','webhookUrl','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','payment.failed','status','3DS\x20verification\x20required','PaymentController','toLowerCase','toISOString','FAILED','gateway_payment_id','paidAt','6817992FzDQpP','900576OGpuxT','\x20\x20\x20Result\x20URL\x20(webhook):\x20','json','\x20\x20\x20Return\x20URL:\x20','successUrl','currency','sendShopWebhook','customerEmail','gatewayPaymentId','params','__importStar','webhookEvents','paymentMethod','../config/database','failed','\x20with\x20status\x20','payment.success','PAID','error','getPaymentStatus','shopId','length','âœ…\x20MasterCard\x20payment\x20','../services/gateways/mastercardService','ðŸ’³\x20MasterCard\x20URLs:','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','5309695jdaSxS','935521nQSAyC','Payment\x20processed\x20successfully','\x20processed:\x20','stringify','webhookService','PENDING','settings','gatewayOrderId','MasterCardService','processMasterCardPayment','../services/webhookService','215328hMaEKG','now','gateway','update','Payment\x20created\x20successfully','ðŸ’³\x20MasterCard\x20result:','writable',',\x20cannot\x20process','paid','orderId','webhookLog','getOwnPropertyDescriptor','processCardPayment','failureMessage','failUrl','mastercard_','500676kfQMfp','sendPaymentStatusNotification','create','Webhook\x20event\x20','default','configurable','shop','__esModule','createdAt','parse','Failed\x20to\x20send\x20MasterCard\x20webhook:','getPaymentById','threeds_url','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','paymentService','sendPaymentNotification','isArray'];a8_0x5876=function(){return _0x49d53f;};return a8_0x5876();}(function(_0x2baf65,_0x5da658){const _0x4291ed=a8_0x4164,_0x4fdc29=_0x2baf65();while(!![]){try{const _0x588194=-parseInt(_0x4291ed(0x118))/0x1+parseInt(_0x4291ed(0x123))/0x2+parseInt(_0x4291ed(0x133))/0x3*(parseInt(_0x4291ed(0xeb))/0x4)+parseInt(_0x4291ed(0x117))/0x5+-parseInt(_0x4291ed(0xfd))/0x6+parseInt(_0x4291ed(0xe5))/0x7+-parseInt(_0x4291ed(0xfc))/0x8;if(_0x588194===_0x5da658)break;else _0x4fdc29['push'](_0x4fdc29['shift']());}catch(_0x582ce9){_0x4fdc29['push'](_0x4fdc29['shift']());}}}(a8_0x5876,0xd5c38));var __createBinding=this&&this[a8_0x5471c4(0xe0)]||(Object[a8_0x5471c4(0xcd)]?function(_0x130869,_0x24f756,_0x58587c,_0x44f946){const _0x26b006=a8_0x5471c4;if(_0x44f946===undefined)_0x44f946=_0x58587c;var _0x56e053=Object[_0x26b006(0x12e)](_0x24f756,_0x58587c);(!_0x56e053||(_0x26b006(0xe8)in _0x56e053?!_0x24f756[_0x26b006(0xd2)]:_0x56e053[_0x26b006(0x129)]||_0x56e053[_0x26b006(0xd0)]))&&(_0x56e053={'enumerable':!![],'get':function(){return _0x24f756[_0x58587c];}}),Object[_0x26b006(0xdd)](_0x130869,_0x44f946,_0x56e053);}:function(_0x29a8c5,_0x147c2a,_0x30a6d8,_0x32751b){if(_0x32751b===undefined)_0x32751b=_0x30a6d8;_0x29a8c5[_0x32751b]=_0x147c2a[_0x30a6d8];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x5471c4(0xcd)]?function(_0x45b1d8,_0x2b04c3){const _0x2b6535=a8_0x5471c4;Object['defineProperty'](_0x45b1d8,_0x2b6535(0xcf),{'enumerable':!![],'value':_0x2b04c3});}:function(_0x33bcaa,_0x366fb3){const _0x28b176=a8_0x5471c4;_0x33bcaa[_0x28b176(0xcf)]=_0x366fb3;}),__importStar=this&&this[a8_0x5471c4(0x107)]||(function(){var _0x231d73=function(_0x4ccacf){const _0x1e0496=a8_0x4164;return _0x231d73=Object[_0x1e0496(0xe9)]||function(_0x493274){const _0x2265d4=_0x1e0496;var _0x276c71=[];for(var _0xb536a8 in _0x493274)if(Object['prototype']['hasOwnProperty']['call'](_0x493274,_0xb536a8))_0x276c71[_0x276c71[_0x2265d4(0x112)]]=_0xb536a8;return _0x276c71;},_0x231d73(_0x4ccacf);};return function(_0x173146){const _0x2a5f5f=a8_0x4164;if(_0x173146&&_0x173146[_0x2a5f5f(0xd2)])return _0x173146;var _0x5938ac={};if(_0x173146!=null){for(var _0x553c3b=_0x231d73(_0x173146),_0x56e60e=0x0;_0x56e60e<_0x553c3b[_0x2a5f5f(0x112)];_0x56e60e++)if(_0x553c3b[_0x56e60e]!==_0x2a5f5f(0xcf))__createBinding(_0x5938ac,_0x173146,_0x553c3b[_0x56e60e]);}return __setModuleDefault(_0x5938ac,_0x173146),_0x5938ac;};}()),__importDefault=this&&this['__importDefault']||function(_0x1f804f){const _0x3a36ae=a8_0x5471c4;return _0x1f804f&&_0x1f804f[_0x3a36ae(0xd2)]?_0x1f804f:{'default':_0x1f804f};};function a8_0x4164(_0x42e4c6,_0x2878f6){const _0x58762d=a8_0x5876();return a8_0x4164=function(_0x416413,_0xabd899){_0x416413=_0x416413-0xcc;let _0x596a7e=_0x58762d[_0x416413];return _0x596a7e;},a8_0x4164(_0x42e4c6,_0x2878f6);}Object[a8_0x5471c4(0xdd)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x5471c4(0xf0)),mastercardService_1=require(a8_0x5471c4(0x114)),webhookService_1=require(a8_0x5471c4(0x122)),database_1=__importDefault(require(a8_0x5471c4(0x10a)));class PaymentController{constructor(){const _0x4771fa=a8_0x5471c4;this['createPublicPayment']=async(_0x35c424,_0x37fafa,_0x41d847)=>{const _0x4616d0=a8_0x4164;try{const _0x480d01=_0x35c424[_0x4616d0(0xef)],_0x2caaec=await this[_0x4616d0(0xd9)]['createPublicPayment'](_0x480d01);_0x37fafa[_0x4616d0(0xf4)](0xc9)[_0x4616d0(0xff)]({'success':!![],'message':_0x4616d0(0x127),'result':_0x2caaec});}catch(_0x71ddaa){_0x41d847(_0x71ddaa);}},this[_0x4771fa(0x110)]=async(_0x27d5c1,_0x124fb3,_0x1504dd)=>{const _0x2010b9=_0x4771fa;try{const {id:_0x3f2d32}=_0x27d5c1[_0x2010b9(0x106)],_0x4ea9c1=await this[_0x2010b9(0xd9)][_0x2010b9(0x110)](_0x3f2d32);if(!_0x4ea9c1)return _0x124fb3[_0x2010b9(0xf4)](0x194)[_0x2010b9(0xff)]({'success':![],'message':_0x2010b9(0xe3)});_0x124fb3[_0x2010b9(0xff)]({'success':!![],'result':_0x4ea9c1});}catch(_0x3f4bb1){_0x1504dd(_0x3f4bb1);}},this['getPaymentById']=async(_0x250997,_0x3b5ea3,_0x318755)=>{const _0x15126f=_0x4771fa;try{const {id:_0x382e91}=_0x250997['params'],_0x473eec=await this[_0x15126f(0xd9)][_0x15126f(0xd6)](_0x382e91);if(!_0x473eec)return _0x3b5ea3[_0x15126f(0xf4)](0x194)[_0x15126f(0xff)]({'success':![],'message':_0x15126f(0xe3)});_0x3b5ea3[_0x15126f(0xff)]({'success':!![],'result':_0x473eec});}catch(_0x71cc74){_0x318755(_0x71cc74);}},this[_0x4771fa(0x121)]=async(_0x222ae2,_0x106d96,_0x13bc18)=>{const _0x53dd40=_0x4771fa;try{const {id:_0x36abd7}=_0x222ae2[_0x53dd40(0x106)],{cardData:_0x78aa7,cardHolder:_0x597b90,browser:_0x3e7097}=_0x222ae2[_0x53dd40(0xef)];console[_0x53dd40(0xed)](_0x53dd40(0xd8)+_0x36abd7);const _0x9b76a0=await database_1[_0x53dd40(0xcf)][_0x53dd40(0xe2)]['findUnique']({'where':{'id':_0x36abd7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x9b76a0)return _0x106d96['status'](0x194)[_0x53dd40(0xff)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x9b76a0[_0x53dd40(0x125)]!==_0x53dd40(0xea))return _0x106d96[_0x53dd40(0xf4)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x9b76a0[_0x53dd40(0xf4)]!=='PENDING')return _0x106d96[_0x53dd40(0xf4)](0x190)[_0x53dd40(0xff)]({'success':![],'message':_0x53dd40(0xe7)+_0x9b76a0[_0x53dd40(0xf4)]+_0x53dd40(0x12a)});const _0xdeaa91=_0x53dd40(0x116),_0x264ffc=_0x9b76a0[_0x53dd40(0x101)];console[_0x53dd40(0xed)](_0x53dd40(0x115)),console[_0x53dd40(0xed)](_0x53dd40(0xfe)+_0xdeaa91),console['log'](_0x53dd40(0x100)+_0x264ffc);const _0x3e0bd9=await this['masterCardService'][_0x53dd40(0x12f)]({'paymentId':_0x9b76a0['id'],'orderId':_0x9b76a0[_0x53dd40(0x11f)]||_0x9b76a0['id'],'amount':_0x9b76a0[_0x53dd40(0xe6)],'currency':_0x9b76a0[_0x53dd40(0x102)],'cardData':_0x78aa7,'resultUrl':_0xdeaa91,'returnUrl':_0x264ffc,'cardHolder':_0x597b90,'browser':_0x3e7097});console[_0x53dd40(0xed)](_0x53dd40(0x128),_0x3e0bd9);const _0x5c5e25={'status':_0x3e0bd9[_0x53dd40(0xf4)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x3e0bd9[_0x53dd40(0xf4)]===_0x53dd40(0x10e))_0x5c5e25[_0x53dd40(0xfb)]=new Date(),_0x5c5e25[_0x53dd40(0x105)]=_0x3e0bd9['gateway_payment_id'];else _0x3e0bd9['status']===_0x53dd40(0xf9)&&(_0x5c5e25[_0x53dd40(0x130)]='Card\x20payment\x20failed');_0x5c5e25[_0x53dd40(0x109)]='mastercard',await database_1['default'][_0x53dd40(0xe2)][_0x53dd40(0x126)]({'where':{'id':_0x9b76a0['id']},'data':_0x5c5e25}),await database_1[_0x53dd40(0xcf)][_0x53dd40(0x12d)][_0x53dd40(0xcd)]({'data':{'paymentId':_0x9b76a0['id'],'shopId':_0x9b76a0[_0x53dd40(0x111)],'event':_0x53dd40(0x132)+_0x3e0bd9[_0x53dd40(0xf4)]?.[_0x53dd40(0xf7)](),'statusCode':0xc8,'responseBody':JSON[_0x53dd40(0x11b)]({'oldStatus':_0x53dd40(0x11d),'newStatus':_0x3e0bd9[_0x53dd40(0xf4)],'gatewayPaymentId':_0x3e0bd9[_0x53dd40(0xfa)],'requires3ds':_0x3e0bd9[_0x53dd40(0xde)],'processedAt':new Date()[_0x53dd40(0xf8)]()})}});_0x3e0bd9['final']&&(await this[_0x53dd40(0x103)](_0x9b76a0,_0x3e0bd9['status'],_0x3e0bd9['gateway_payment_id']),await this[_0x53dd40(0xcc)](_0x9b76a0,_0x3e0bd9[_0x53dd40(0xf4)]));console[_0x53dd40(0xed)](_0x53dd40(0x113)+_0x36abd7+_0x53dd40(0x11a)+_0x3e0bd9[_0x53dd40(0xf4)]);if(_0x3e0bd9['status']===_0x53dd40(0x10e))_0x106d96[_0x53dd40(0xff)]({'success':!![],'message':_0x53dd40(0x119),'result':{'status':_0x53dd40(0x10e),'gatewayPaymentId':_0x3e0bd9[_0x53dd40(0xfa)],'redirectUrl':_0x264ffc,'final':!![]}});else _0x3e0bd9[_0x53dd40(0xde)]&&_0x3e0bd9[_0x53dd40(0xd7)]?_0x106d96['json']({'success':!![],'message':_0x53dd40(0xf5),'result':{'status':_0x53dd40(0x11d),'gatewayPaymentId':_0x3e0bd9[_0x53dd40(0xfa)],'redirectUrl':_0x3e0bd9[_0x53dd40(0xd7)],'requires3ds':!![],'final':![]}}):_0x106d96['status'](0x190)['json']({'success':![],'message':_0x53dd40(0xe1),'result':{'status':_0x53dd40(0xf9),'gatewayPaymentId':_0x3e0bd9['gateway_payment_id'],'redirectUrl':_0x9b76a0[_0x53dd40(0x131)],'final':!![]}});}catch(_0x590a5c){_0x13bc18(_0x590a5c);}},this[_0x4771fa(0xd9)]=new paymentService_1['PaymentService'](),this[_0x4771fa(0xdc)]=new mastercardService_1[(_0x4771fa(0x120))](),this[_0x4771fa(0x11c)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x3b587c,_0x4d7e26,_0x2032b8){const _0x2e0411=a8_0x5471c4,_0x4ae74a=Date[_0x2e0411(0x124)]();try{const _0x1f2625=_0x3b587c[_0x2e0411(0xd1)],_0x5f2e50=_0x1f2625[_0x2e0411(0x11e)];if(!_0x5f2e50?.['webhookUrl']){console[_0x2e0411(0xed)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1f2625['id']);return;}const _0x529771=_0x4d7e26===_0x2e0411(0x10e)?_0x2e0411(0x10d):_0x2e0411(0xf3);let _0x414c20=[];if(_0x5f2e50[_0x2e0411(0x108)])try{_0x414c20=Array[_0x2e0411(0xdb)](_0x5f2e50[_0x2e0411(0x108)])?_0x5f2e50[_0x2e0411(0x108)]:JSON[_0x2e0411(0xd4)](_0x5f2e50['webhookEvents']);}catch(_0x375e7e){console[_0x2e0411(0x10f)]('Error\x20parsing\x20webhook\x20events:',_0x375e7e),_0x414c20=[];}if(!_0x414c20['includes'](_0x529771)){console[_0x2e0411(0xed)](_0x2e0411(0xce)+_0x529771+_0x2e0411(0xe4)+_0x1f2625['id']);return;}const _0x9832a1={'event':_0x529771,'payment':{'id':_0x3b587c['id'],'order_id':_0x3b587c[_0x2e0411(0x12c)],'gateway_order_id':_0x3b587c[_0x2e0411(0x11f)],'gateway':'1111','amount':_0x3b587c[_0x2e0411(0xe6)],'currency':_0x3b587c['currency'],'status':_0x4d7e26[_0x2e0411(0xf7)](),'customer_email':_0x3b587c[_0x2e0411(0x104)],'customer_name':_0x3b587c[_0x2e0411(0xec)],'gateway_payment_id':_0x2032b8,'created_at':_0x3b587c[_0x2e0411(0xd3)],'updated_at':new Date()}},_0x1c1698=await fetch(_0x5f2e50[_0x2e0411(0xf1)],{'method':'POST','headers':{'Content-Type':_0x2e0411(0xee),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x2e0411(0x11b)](_0x9832a1)}),_0x3824b3=Date['now']()-_0x4ae74a;console[_0x2e0411(0xed)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5f2e50[_0x2e0411(0xf1)]+_0x2e0411(0x10c)+_0x1c1698[_0x2e0411(0xf4)]+'\x20('+_0x3824b3+'ms)');}catch(_0x1ebf53){console[_0x2e0411(0x10f)](_0x2e0411(0xd5),_0x1ebf53);}}async[a8_0x5471c4(0xcc)](_0x2ac66f,_0x2a0b3c){const _0x35a567=a8_0x5471c4;try{const {telegramBotService:_0x4bbd09}=await Promise['resolve']()[_0x35a567(0xdf)](()=>__importStar(require('../services/telegramBotService'))),_0x535fd1={'PAID':_0x35a567(0x12b),'FAILED':_0x35a567(0x10b)},_0x470359=_0x535fd1[_0x2a0b3c];if(!_0x470359)return;await _0x4bbd09[_0x35a567(0xda)](_0x2ac66f['shopId'],_0x2ac66f,_0x470359);}catch(_0x5c601e){console[_0x35a567(0x10f)](_0x35a567(0xf2),_0x5c601e);}}}exports[a8_0x5471c4(0xf6)]=PaymentController;