'use strict';const a8_0x11780a=a8_0x3ab5;(function(_0x168216,_0x11765){const _0x336837=a8_0x3ab5,_0xec6c36=_0x168216();while(!![]){try{const _0x4d7960=parseInt(_0x336837(0x177))/0x1+-parseInt(_0x336837(0x161))/0x2*(-parseInt(_0x336837(0x13c))/0x3)+-parseInt(_0x336837(0x16e))/0x4*(parseInt(_0x336837(0x170))/0x5)+parseInt(_0x336837(0x189))/0x6+parseInt(_0x336837(0x19c))/0x7+parseInt(_0x336837(0x12f))/0x8+-parseInt(_0x336837(0x156))/0x9;if(_0x4d7960===_0x11765)break;else _0xec6c36['push'](_0xec6c36['shift']());}catch(_0x59f1b8){_0xec6c36['push'](_0xec6c36['shift']());}}}(a8_0x3ad5,0xe20c9));var __createBinding=this&&this[a8_0x11780a(0x199)]||(Object[a8_0x11780a(0x18a)]?function(_0x496e0b,_0x46e9b0,_0x44bdff,_0x2e4226){const _0x5c5e81=a8_0x11780a;if(_0x2e4226===undefined)_0x2e4226=_0x44bdff;var _0xbfceb4=Object[_0x5c5e81(0x17a)](_0x46e9b0,_0x44bdff);(!_0xbfceb4||(_0x5c5e81(0x13e)in _0xbfceb4?!_0x46e9b0['__esModule']:_0xbfceb4[_0x5c5e81(0x18b)]||_0xbfceb4[_0x5c5e81(0x198)]))&&(_0xbfceb4={'enumerable':!![],'get':function(){return _0x46e9b0[_0x44bdff];}}),Object['defineProperty'](_0x496e0b,_0x2e4226,_0xbfceb4);}:function(_0xfff60d,_0x1d6896,_0x362800,_0x54d846){if(_0x54d846===undefined)_0x54d846=_0x362800;_0xfff60d[_0x54d846]=_0x1d6896[_0x362800];}),__setModuleDefault=this&&this[a8_0x11780a(0x180)]||(Object[a8_0x11780a(0x18a)]?function(_0x47156f,_0x363c47){const _0x4f6fb2=a8_0x11780a;Object[_0x4f6fb2(0x18e)](_0x47156f,'default',{'enumerable':!![],'value':_0x363c47});}:function(_0x4ea03b,_0x49d702){const _0x4953b3=a8_0x11780a;_0x4ea03b[_0x4953b3(0x139)]=_0x49d702;}),__importStar=this&&this[a8_0x11780a(0x138)]||(function(){var _0x431914=function(_0x46751f){const _0x2c1a57=a8_0x3ab5;return _0x431914=Object[_0x2c1a57(0x147)]||function(_0x307f7f){const _0x407e51=_0x2c1a57;var _0x50e5c0=[];for(var _0x292b4a in _0x307f7f)if(Object['prototype'][_0x407e51(0x15a)][_0x407e51(0x1af)](_0x307f7f,_0x292b4a))_0x50e5c0[_0x50e5c0['length']]=_0x292b4a;return _0x50e5c0;},_0x431914(_0x46751f);};return function(_0x98ff90){const _0x3bc2c8=a8_0x3ab5;if(_0x98ff90&&_0x98ff90[_0x3bc2c8(0x149)])return _0x98ff90;var _0x1986d8={};if(_0x98ff90!=null){for(var _0x3fba40=_0x431914(_0x98ff90),_0x273cc3=0x0;_0x273cc3<_0x3fba40['length'];_0x273cc3++)if(_0x3fba40[_0x273cc3]!=='default')__createBinding(_0x1986d8,_0x98ff90,_0x3fba40[_0x273cc3]);}return __setModuleDefault(_0x1986d8,_0x98ff90),_0x1986d8;};}()),__importDefault=this&&this[a8_0x11780a(0x14d)]||function(_0x2e8cf1){const _0xd3abc7=a8_0x11780a;return _0x2e8cf1&&_0x2e8cf1[_0xd3abc7(0x149)]?_0x2e8cf1:{'default':_0x2e8cf1};};Object['defineProperty'](exports,a8_0x11780a(0x149),{'value':!![]}),exports[a8_0x11780a(0x174)]=void 0x0;function a8_0x3ad5(){const _0x351477=['createdAt','6369520rZUYWj','sendPaymentNotification','1111','updatePaymentCustomer','PaymentController','Card\x20payment\x20failed','sendShopWebhook','1651966FRIjbm','Webhook\x20event\x20','FAILED','getOwnPropertyDescriptor','POST',',\x20cannot\x20process','createPublicPayment','paymentMethod','💳\x20MasterCard\x20result:','__setModuleDefault','failUrl','ms)','error','mastercard','customerEmail','gateway','Failed\x20to\x20send\x20MasterCard\x20webhook:','parse','6436392CbNGKV','create','writable','Customer\x20data\x20updated\x20successfully','Payment\x20not\x20found','defineProperty','💳\x20Browser\x20IP:\x20','💳\x20Processing\x20MasterCard\x20payment:\x20','customerCountry','Payment\x20created\x20successfully','MasterCard\x20webhook\x20sent\x20to\x20','paymentService','📈\x20MasterCard\x20payment\x20','../services/gateways/mastercardService','processCardPayment','configurable','__createBinding','number','\x20\x20\x20Result\x20URL\x20(webhook):\x20','5697433kYiAWN','email','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','resolve','params','sendPaymentStatusNotification','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','system','application/json','\x20not\x20enabled\x20for\x20shop\x20','MasterCardService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','failed','shop','paid','\x20processed:\x20','final','requires_3ds','updatedAt','call','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','toISOString','../config/database','amount','payment.failed','customerIp','6450560QVtGNI','webhookEvents','Payment\x20status\x20is\x20','webhookService','\x20with\x20status\x20','PaymentService','masterCardService','../services/telegramBotService','updatePaymentCustomerDataPublic','__importStar','default','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','webhookUrl','6456YTsSCY','toLowerCase','get','getPaymentStatus','user_agent','processMasterCardPayment','last_name','then','../services/paymentService','mastercard_','includes','getOwnPropertyNames','isArray','__esModule','log','successUrl','stringify','__importDefault','PENDING','../services/webhookService','orderId','shopId','handleSuccessfulPayment','json','Error\x20parsing\x20webhook\x20events:','gatewayOrderId','20797560XxbxOu','Payment\x20failed','payment','body','hasOwnProperty','Payment\x20processed\x20successfully','paidAt','currency','update','threeds_url','✅\x20MasterCard\x20payment\x20','154afjhZg','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','gateway_payment_id','first_name','getPaymentById','payment.success','now','status','webhookLog','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','https://api.trapay.uk/api/webhooks/gateway/mastercard','PAID','gatewayPaymentId','4lHBMWQ'];a8_0x3ad5=function(){return _0x351477;};return a8_0x3ad5();}const paymentService_1=require(a8_0x11780a(0x144)),mastercardService_1=require(a8_0x11780a(0x196)),webhookService_1=require(a8_0x11780a(0x14f)),database_1=__importDefault(require(a8_0x11780a(0x1b2)));function a8_0x3ab5(_0x7fa0e1,_0x4e29db){const _0x3ad55f=a8_0x3ad5();return a8_0x3ab5=function(_0x3ab587,_0x2c3b4e){_0x3ab587=_0x3ab587-0x12f;let _0x5a6408=_0x3ad55f[_0x3ab587];return _0x5a6408;},a8_0x3ab5(_0x7fa0e1,_0x4e29db);}class PaymentController{constructor(){const _0x366757=a8_0x11780a;this['createPublicPayment']=async(_0x20e39e,_0x2e99be,_0x487587)=>{const _0xe8a4cc=a8_0x3ab5;try{const _0x1bfbd3=_0x20e39e[_0xe8a4cc(0x159)],_0xbab7c1=await this[_0xe8a4cc(0x194)][_0xe8a4cc(0x17d)](_0x1bfbd3);_0x2e99be[_0xe8a4cc(0x168)](0xc9)['json']({'success':!![],'message':_0xe8a4cc(0x192),'result':_0xbab7c1});}catch(_0x4bab61){_0x487587(_0x4bab61);}},this['getPaymentStatus']=async(_0x3dadb9,_0x2e7497,_0x19ac0f)=>{const _0x1c0a93=a8_0x3ab5;try{const {id:_0x458563}=_0x3dadb9['params'],_0x4c3253=await this[_0x1c0a93(0x194)][_0x1c0a93(0x13f)](_0x458563);if(!_0x4c3253)return _0x2e7497['status'](0x194)[_0x1c0a93(0x153)]({'success':![],'message':_0x1c0a93(0x18d)});_0x2e7497[_0x1c0a93(0x153)]({'success':!![],'result':_0x4c3253});}catch(_0x5b08de){_0x19ac0f(_0x5b08de);}},this['getPaymentById']=async(_0x1c58ca,_0x457442,_0x464c4a)=>{const _0xd48ec0=a8_0x3ab5;try{const {id:_0x375726}=_0x1c58ca['params'],_0x54b995=await this[_0xd48ec0(0x194)][_0xd48ec0(0x165)](_0x375726);if(!_0x54b995)return _0x457442[_0xd48ec0(0x168)](0x194)[_0xd48ec0(0x153)]({'success':![],'message':'Payment\x20not\x20found'});_0x457442[_0xd48ec0(0x153)]({'success':!![],'result':_0x54b995});}catch(_0x4d029a){_0x464c4a(_0x4d029a);}},this[_0x366757(0x173)]=async(_0x2b84cc,_0x6a5825,_0x904855)=>{const _0x2d323d=_0x366757;try{const {id:_0x27189f}=_0x2b84cc[_0x2d323d(0x1a0)],_0x1bf631=_0x2b84cc[_0x2d323d(0x159)];console[_0x2d323d(0x14a)](_0x2d323d(0x1b0)+_0x27189f),console[_0x2d323d(0x14a)]('📝\x20Customer\x20data:',_0x1bf631);const _0xf1eb9c=await this[_0x2d323d(0x194)][_0x2d323d(0x137)](_0x27189f,_0x1bf631);if(!_0xf1eb9c)return _0x6a5825[_0x2d323d(0x168)](0x194)['json']({'success':![],'message':_0x2d323d(0x18d)});_0x6a5825['json']({'success':!![],'message':_0x2d323d(0x18c),'result':{'paymentId':_0xf1eb9c['id'],'customerIp':_0xf1eb9c[_0x2d323d(0x1b5)],'customerUa':_0xf1eb9c['customerUa'],'customerCountry':_0xf1eb9c[_0x2d323d(0x191)],'updatedAt':_0xf1eb9c[_0x2d323d(0x1ae)]}});}catch(_0x1376f8){_0x904855(_0x1376f8);}},this[_0x366757(0x141)]=async(_0x215ed6,_0x2674f6,_0x394743)=>{const _0x356762=_0x366757;try{const {id:_0x56382a}=_0x215ed6['params'],{cardData:_0xd8593,cardHolder:_0x1b5719,browser:_0x3cc5d7}=_0x215ed6['body'];console['log'](_0x356762(0x190)+_0x56382a),console[_0x356762(0x14a)]('💳\x20Card\x20holder:\x20'+_0x1b5719['first_name']+'\x20'+_0x1b5719['last_name']+'\x20('+_0x1b5719[_0x356762(0x19d)]+')'),console[_0x356762(0x14a)](_0x356762(0x18f)+_0x3cc5d7['ip']);const _0x56ffeb={'customerName':_0x1b5719['first_name']+'\x20'+_0x1b5719[_0x356762(0x142)],'customerEmail':_0x1b5719[_0x356762(0x19d)],'customerIp':_0x3cc5d7['ip'],'customerUa':_0x3cc5d7[_0x356762(0x140)]},_0x8c3551=await database_1[_0x356762(0x139)]['payment']['findUnique']({'where':{'id':_0x56382a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x8c3551)return _0x2674f6['status'](0x194)[_0x356762(0x153)]({'success':![],'message':_0x356762(0x18d)});if(_0x8c3551[_0x356762(0x186)]!==_0x356762(0x184))return _0x2674f6[_0x356762(0x168)](0x190)[_0x356762(0x153)]({'success':![],'message':_0x356762(0x1a7)});if(_0x8c3551[_0x356762(0x168)]!==_0x356762(0x14e))return _0x2674f6[_0x356762(0x168)](0x190)[_0x356762(0x153)]({'success':![],'message':_0x356762(0x131)+_0x8c3551[_0x356762(0x168)]+_0x356762(0x17c)});await database_1['default'][_0x356762(0x158)][_0x356762(0x15e)]({'where':{'id':_0x56382a},'data':{..._0x56ffeb,'updatedAt':new Date()}});const _0x16cb2f=_0x356762(0x16b),_0x2d875e=_0x8c3551[_0x356762(0x14b)];console[_0x356762(0x14a)]('💳\x20MasterCard\x20URLs:'),console[_0x356762(0x14a)](_0x356762(0x19b)+_0x16cb2f),console[_0x356762(0x14a)]('\x20\x20\x20Return\x20URL:\x20'+_0x2d875e);const _0x145822={'first_name':_0x1b5719[_0x356762(0x164)],'last_name':_0x1b5719[_0x356762(0x142)],'email':_0x1b5719['email']},_0xd6f332=await this[_0x356762(0x135)][_0x356762(0x197)]({'paymentId':_0x8c3551['id'],'orderId':_0x8c3551[_0x356762(0x155)]||_0x8c3551['id'],'amount':_0x8c3551[_0x356762(0x1b3)],'currency':_0x8c3551[_0x356762(0x15d)],'cardData':_0xd8593,'resultUrl':_0x16cb2f,'returnUrl':_0x2d875e,'cardHolder':_0x145822,'browser':_0x3cc5d7});console[_0x356762(0x14a)](_0x356762(0x17f),_0xd6f332);const _0x4204bf={'status':_0xd6f332[_0x356762(0x168)],'updatedAt':new Date(),'statusChangedBy':_0x356762(0x1a3),'statusChangedAt':new Date()};_0xd6f332[_0x356762(0x163)]&&(_0x4204bf[_0x356762(0x16d)]=_0xd6f332['gateway_payment_id'],console[_0x356762(0x14a)](_0x356762(0x162)+_0xd6f332[_0x356762(0x163)]));if(_0xd6f332[_0x356762(0x168)]===_0x356762(0x16c))_0x4204bf[_0x356762(0x15c)]=new Date();else _0xd6f332[_0x356762(0x168)]===_0x356762(0x179)&&(_0x4204bf['failureMessage']=_0x356762(0x175));_0x4204bf[_0x356762(0x17e)]=_0x356762(0x184);if(_0xd8593[_0x356762(0x19a)]){const _0x472dcf=_0xd8593['number']['replace'](/[\s-]/g,'');_0x4204bf['cardLast4']=_0x472dcf['slice'](-0x4),console['log'](_0x356762(0x13a)+_0x4204bf['cardLast4']);}await database_1[_0x356762(0x139)][_0x356762(0x158)][_0x356762(0x15e)]({'where':{'id':_0x8c3551['id']},'data':_0x4204bf}),await database_1['default'][_0x356762(0x169)][_0x356762(0x18a)]({'data':{'paymentId':_0x8c3551['id'],'shopId':_0x8c3551[_0x356762(0x151)],'event':_0x356762(0x145)+_0xd6f332[_0x356762(0x168)]?.[_0x356762(0x13d)](),'statusCode':0xc8,'responseBody':JSON[_0x356762(0x14c)]({'oldStatus':_0x356762(0x14e),'newStatus':_0xd6f332[_0x356762(0x168)],'gatewayPaymentId':_0xd6f332[_0x356762(0x163)],'requires3ds':_0xd6f332[_0x356762(0x1ad)],'processedAt':new Date()[_0x356762(0x1b1)]()})}});if(_0xd6f332[_0x356762(0x1ac)]){await this['sendShopWebhook'](_0x8c3551,_0xd6f332[_0x356762(0x168)],_0xd6f332[_0x356762(0x163)]),await this['sendPaymentStatusNotification'](_0x8c3551,_0xd6f332['status']);if(_0xd6f332[_0x356762(0x168)]==='PAID'){console[_0x356762(0x14a)](_0x356762(0x195)+_0x56382a+_0x356762(0x19e));try{const {PaymentLinkService:_0x11b13e}=await Promise[_0x356762(0x19f)]()['then'](()=>__importStar(require('../services/paymentLinkService'))),_0x5a23dd=new _0x11b13e();await _0x5a23dd[_0x356762(0x152)](_0x56382a),console[_0x356762(0x14a)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x56382a);}catch(_0x442db6){console['error']('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x442db6);}}}console[_0x356762(0x14a)](_0x356762(0x160)+_0x56382a+_0x356762(0x1ab)+_0xd6f332[_0x356762(0x168)]);if(_0xd6f332[_0x356762(0x168)]===_0x356762(0x16c))_0x2674f6[_0x356762(0x153)]({'success':!![],'message':_0x356762(0x15b),'result':{'status':_0x356762(0x16c),'gatewayPaymentId':_0xd6f332[_0x356762(0x163)],'redirectUrl':_0x2d875e,'final':!![]}});else _0xd6f332['requires_3ds']&&_0xd6f332[_0x356762(0x15f)]?_0x2674f6['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x356762(0x14e),'gatewayPaymentId':_0xd6f332[_0x356762(0x163)],'redirectUrl':_0xd6f332[_0x356762(0x15f)],'requires3ds':!![],'final':![]}}):_0x2674f6[_0x356762(0x168)](0x190)['json']({'success':![],'message':_0x356762(0x157),'result':{'status':_0x356762(0x179),'gatewayPaymentId':_0xd6f332[_0x356762(0x163)],'redirectUrl':_0x8c3551[_0x356762(0x181)],'final':!![]}});}catch(_0x3d7d76){_0x394743(_0x3d7d76);}},this[_0x366757(0x194)]=new paymentService_1[(_0x366757(0x134))](),this[_0x366757(0x135)]=new mastercardService_1[(_0x366757(0x1a6))](),this[_0x366757(0x132)]=new webhookService_1['WebhookService']();}async[a8_0x11780a(0x176)](_0x317b70,_0x2e0fd9,_0x5eb713){const _0x4ce944=a8_0x11780a,_0x5bcee0=Date[_0x4ce944(0x167)]();try{const _0x1dc955=_0x317b70[_0x4ce944(0x1a9)],_0x3d820=_0x1dc955['settings'];if(!_0x3d820?.[_0x4ce944(0x13b)]){console[_0x4ce944(0x14a)](_0x4ce944(0x1a2)+_0x1dc955['id']);return;}const _0x1d59e0=_0x2e0fd9===_0x4ce944(0x16c)?_0x4ce944(0x166):_0x4ce944(0x1b4);let _0xca1c73=[];if(_0x3d820[_0x4ce944(0x130)])try{_0xca1c73=Array[_0x4ce944(0x148)](_0x3d820[_0x4ce944(0x130)])?_0x3d820[_0x4ce944(0x130)]:JSON[_0x4ce944(0x188)](_0x3d820['webhookEvents']);}catch(_0xced94c){console['error'](_0x4ce944(0x154),_0xced94c),_0xca1c73=[];}if(!_0xca1c73[_0x4ce944(0x146)](_0x1d59e0)){console['log'](_0x4ce944(0x178)+_0x1d59e0+_0x4ce944(0x1a5)+_0x1dc955['id']);return;}const _0x5ed13a={'event':_0x1d59e0,'payment':{'id':_0x317b70['id'],'order_id':_0x317b70[_0x4ce944(0x150)],'gateway_order_id':_0x317b70[_0x4ce944(0x155)],'gateway':_0x4ce944(0x172),'amount':_0x317b70[_0x4ce944(0x1b3)],'currency':_0x317b70[_0x4ce944(0x15d)],'status':_0x2e0fd9['toLowerCase'](),'customer_email':_0x317b70[_0x4ce944(0x185)],'customer_name':_0x317b70['customerName'],'gateway_payment_id':_0x5eb713,'created_at':_0x317b70[_0x4ce944(0x16f)],'updated_at':new Date()}},_0x46f494=await fetch(_0x3d820[_0x4ce944(0x13b)],{'method':_0x4ce944(0x17b),'headers':{'Content-Type':_0x4ce944(0x1a4),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x4ce944(0x14c)](_0x5ed13a)}),_0x390a33=Date[_0x4ce944(0x167)]()-_0x5bcee0;console[_0x4ce944(0x14a)](_0x4ce944(0x193)+_0x3d820[_0x4ce944(0x13b)]+_0x4ce944(0x133)+_0x46f494[_0x4ce944(0x168)]+'\x20('+_0x390a33+_0x4ce944(0x182));}catch(_0x3a8e44){console[_0x4ce944(0x183)](_0x4ce944(0x187),_0x3a8e44);}}async[a8_0x11780a(0x1a1)](_0x2276c3,_0x573117){const _0x5bcc70=a8_0x11780a;try{const {telegramBotService:_0x50de61}=await Promise[_0x5bcc70(0x19f)]()[_0x5bcc70(0x143)](()=>__importStar(require(_0x5bcc70(0x136)))),_0x26fcaf={'PAID':_0x5bcc70(0x1aa),'FAILED':_0x5bcc70(0x1a8)},_0x4a61e2=_0x26fcaf[_0x573117];if(!_0x4a61e2)return;await _0x50de61[_0x5bcc70(0x171)](_0x2276c3['shopId'],_0x2276c3,_0x4a61e2);}catch(_0x4e1f26){console[_0x5bcc70(0x183)](_0x5bcc70(0x16a),_0x4e1f26);}}}exports[a8_0x11780a(0x174)]=PaymentController;