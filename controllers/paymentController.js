'use strict';const a8_0x454bbc=a8_0x1fd0;(function(_0xa2289d,_0x5ad110){const _0x23ef3f=a8_0x1fd0,_0x2cb17c=_0xa2289d();while(!![]){try{const _0x428255=parseInt(_0x23ef3f(0xc2))/0x1+-parseInt(_0x23ef3f(0x7d))/0x2+parseInt(_0x23ef3f(0xd9))/0x3+-parseInt(_0x23ef3f(0x98))/0x4+-parseInt(_0x23ef3f(0xbf))/0x5+-parseInt(_0x23ef3f(0x9d))/0x6*(parseInt(_0x23ef3f(0x7a))/0x7)+parseInt(_0x23ef3f(0xc7))/0x8;if(_0x428255===_0x5ad110)break;else _0x2cb17c['push'](_0x2cb17c['shift']());}catch(_0x366f8d){_0x2cb17c['push'](_0x2cb17c['shift']());}}}(a8_0x59fb,0xaf9db));function a8_0x1fd0(_0x13c174,_0x563aed){const _0x59fb36=a8_0x59fb();return a8_0x1fd0=function(_0x1fd06b,_0xdfa822){_0x1fd06b=_0x1fd06b-0x75;let _0x1d3603=_0x59fb36[_0x1fd06b];return _0x1d3603;},a8_0x1fd0(_0x13c174,_0x563aed);}var __createBinding=this&&this[a8_0x454bbc(0x93)]||(Object[a8_0x454bbc(0xa8)]?function(_0x160d16,_0x2b240a,_0x40610a,_0x11aefd){const _0x412053=a8_0x454bbc;if(_0x11aefd===undefined)_0x11aefd=_0x40610a;var _0x4c5f45=Object[_0x412053(0x96)](_0x2b240a,_0x40610a);(!_0x4c5f45||(_0x412053(0x80)in _0x4c5f45?!_0x2b240a[_0x412053(0x76)]:_0x4c5f45[_0x412053(0xad)]||_0x4c5f45[_0x412053(0xdd)]))&&(_0x4c5f45={'enumerable':!![],'get':function(){return _0x2b240a[_0x40610a];}}),Object['defineProperty'](_0x160d16,_0x11aefd,_0x4c5f45);}:function(_0x5e76d9,_0x436684,_0x22e185,_0x1e495c){if(_0x1e495c===undefined)_0x1e495c=_0x22e185;_0x5e76d9[_0x1e495c]=_0x436684[_0x22e185];}),__setModuleDefault=this&&this[a8_0x454bbc(0xeb)]||(Object[a8_0x454bbc(0xa8)]?function(_0x3b2ddb,_0x3f2569){const _0x4cbde6=a8_0x454bbc;Object['defineProperty'](_0x3b2ddb,_0x4cbde6(0xb8),{'enumerable':!![],'value':_0x3f2569});}:function(_0x1f0f74,_0x2da145){const _0x32f42c=a8_0x454bbc;_0x1f0f74[_0x32f42c(0xb8)]=_0x2da145;}),__importStar=this&&this[a8_0x454bbc(0x99)]||(function(){var _0x3ef487=function(_0x3b293e){const _0x3c7429=a8_0x1fd0;return _0x3ef487=Object[_0x3c7429(0x95)]||function(_0x185de3){const _0xcc4566=_0x3c7429;var _0x263134=[];for(var _0x30e34d in _0x185de3)if(Object['prototype'][_0xcc4566(0xd5)][_0xcc4566(0x86)](_0x185de3,_0x30e34d))_0x263134[_0x263134[_0xcc4566(0xe2)]]=_0x30e34d;return _0x263134;},_0x3ef487(_0x3b293e);};return function(_0x51f2bc){const _0x1e1456=a8_0x1fd0;if(_0x51f2bc&&_0x51f2bc[_0x1e1456(0x76)])return _0x51f2bc;var _0x578e25={};if(_0x51f2bc!=null){for(var _0x362a9e=_0x3ef487(_0x51f2bc),_0x19edba=0x0;_0x19edba<_0x362a9e[_0x1e1456(0xe2)];_0x19edba++)if(_0x362a9e[_0x19edba]!==_0x1e1456(0xb8))__createBinding(_0x578e25,_0x51f2bc,_0x362a9e[_0x19edba]);}return __setModuleDefault(_0x578e25,_0x51f2bc),_0x578e25;};}()),__importDefault=this&&this['__importDefault']||function(_0xa4c35b){return _0xa4c35b&&_0xa4c35b['__esModule']?_0xa4c35b:{'default':_0xa4c35b};};function a8_0x59fb(){const _0x3d3bc1=['params','__setModuleDefault','💳\x20Processing\x20MasterCard\x20payment:\x20','createdAt','payment.failed','Webhook\x20event\x20','system','orderId','Payment\x20status\x20is\x20','MasterCardService','gateway','requires_3ds','last_name','__esModule','Error\x20parsing\x20webhook\x20events:','paymentMethod','number','7DdOvGv','customerName','now','1080262bTvXXA','threeds_url','paidAt','get','FAILED','currency','✅\x20MasterCard\x20payment\x20','log','error','call','Failed\x20to\x20send\x20MasterCard\x20webhook:','final','user_agent','updatePaymentCustomer','PAID','Payment\x20not\x20found','Payment\x20processed\x20successfully','defineProperty','email','../services/paymentService','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','📝\x20Customer\x20data:','__createBinding','💳\x20MasterCard\x20result:','getOwnPropertyNames','getOwnPropertyDescriptor','💳\x20Browser\x20IP:\x20','2164492OQUYdz','__importStar','📈\x20MasterCard\x20payment\x20','resolve','then','3495894WxnLgk','webhookLog','../services/gateways/mastercardService','gatewayOrderId','status','3DS\x20verification\x20required','Card\x20payment\x20failed','slice','stringify','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','handleSuccessfulPayment','create','cardLast4','💳\x20Card\x20holder:\x20','paid','sendShopWebhook','writable','includes','https://api.trapay.uk/api/webhooks/gateway/mastercard','\x20with\x20status\x20','json','gateway_payment_id','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','toLowerCase','mastercard_','customerIp','Payment\x20created\x20successfully','default','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shopId','payment','PaymentService','getPaymentStatus','successUrl','4577680emQkmv','\x20\x20\x20Result\x20URL\x20(webhook):\x20','parse','307304KLlGIr','paymentService','isArray','Payment\x20failed','💳\x20MasterCard\x20URLs:','22027944MkiYzY','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','replace','gatewayPaymentId','MasterCard\x20webhook\x20sent\x20to\x20','failed','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','update',',\x20cannot\x20process','PaymentController','body','POST','../config/database','masterCardService','hasOwnProperty','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','failureMessage','713895MrxLPs','first_name','PENDING','sendPaymentStatusNotification','configurable','webhookUrl','getPaymentById','customerEmail','updatePaymentCustomerDataPublic','length','processCardPayment','WebhookService','../services/webhookService','mastercard','createPublicPayment','webhookEvents','toISOString'];a8_0x59fb=function(){return _0x3d3bc1;};return a8_0x59fb();}Object[a8_0x454bbc(0x8e)](exports,'__esModule',{'value':!![]}),exports[a8_0x454bbc(0xd0)]=void 0x0;const paymentService_1=require(a8_0x454bbc(0x90)),mastercardService_1=require(a8_0x454bbc(0x9f)),webhookService_1=require(a8_0x454bbc(0xe5)),database_1=__importDefault(require(a8_0x454bbc(0xd3)));class PaymentController{constructor(){const _0x17954b=a8_0x454bbc;this[_0x17954b(0xe7)]=async(_0x55820d,_0x12bc82,_0x152add)=>{const _0x21d84d=_0x17954b;try{const _0x109981=_0x55820d[_0x21d84d(0xd1)],_0xaf76f3=await this[_0x21d84d(0xc3)]['createPublicPayment'](_0x109981);_0x12bc82[_0x21d84d(0xa1)](0xc9)[_0x21d84d(0xb1)]({'success':!![],'message':_0x21d84d(0xb7),'result':_0xaf76f3});}catch(_0x105356){_0x152add(_0x105356);}},this[_0x17954b(0xbd)]=async(_0x103ada,_0x19c60d,_0x2edee3)=>{const _0x31173b=_0x17954b;try{const {id:_0x246ef8}=_0x103ada['params'],_0x4e73c8=await this[_0x31173b(0xc3)][_0x31173b(0xbd)](_0x246ef8);if(!_0x4e73c8)return _0x19c60d[_0x31173b(0xa1)](0x194)[_0x31173b(0xb1)]({'success':![],'message':_0x31173b(0x8c)});_0x19c60d[_0x31173b(0xb1)]({'success':!![],'result':_0x4e73c8});}catch(_0x2ff8eb){_0x2edee3(_0x2ff8eb);}},this['getPaymentById']=async(_0x3acb04,_0x772740,_0xb89bda)=>{const _0x4ec761=_0x17954b;try{const {id:_0x4b322e}=_0x3acb04[_0x4ec761(0xea)],_0x82fc01=await this[_0x4ec761(0xc3)][_0x4ec761(0xdf)](_0x4b322e);if(!_0x82fc01)return _0x772740[_0x4ec761(0xa1)](0x194)[_0x4ec761(0xb1)]({'success':![],'message':_0x4ec761(0x8c)});_0x772740[_0x4ec761(0xb1)]({'success':!![],'result':_0x82fc01});}catch(_0xaa424b){_0xb89bda(_0xaa424b);}},this[_0x17954b(0x8a)]=async(_0x1e16d2,_0x47615a,_0x575ec4)=>{const _0x56a1cb=_0x17954b;try{const {id:_0x50a696}=_0x1e16d2[_0x56a1cb(0xea)],_0x1c1493=_0x1e16d2[_0x56a1cb(0xd1)];console[_0x56a1cb(0x84)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x50a696),console[_0x56a1cb(0x84)](_0x56a1cb(0x92),_0x1c1493);const _0x2a3f51=await this[_0x56a1cb(0xc3)][_0x56a1cb(0xe1)](_0x50a696,_0x1c1493);if(!_0x2a3f51)return _0x47615a[_0x56a1cb(0xa1)](0x194)['json']({'success':![],'message':_0x56a1cb(0x8c)});_0x47615a[_0x56a1cb(0xb1)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x2a3f51['id'],'customerIp':_0x2a3f51[_0x56a1cb(0xb6)],'customerUa':_0x2a3f51['customerUa'],'customerCountry':_0x2a3f51['customerCountry'],'updatedAt':_0x2a3f51['updatedAt']}});}catch(_0x5f19d1){_0x575ec4(_0x5f19d1);}},this['processMasterCardPayment']=async(_0x2e310f,_0x40a958,_0x1db55a)=>{const _0x54a908=_0x17954b;try{const {id:_0x40611a}=_0x2e310f[_0x54a908(0xea)],{cardData:_0x3d8365,cardHolder:_0x3cbdb4,browser:_0x170952}=_0x2e310f[_0x54a908(0xd1)];console[_0x54a908(0x84)](_0x54a908(0xec)+_0x40611a),console[_0x54a908(0x84)](_0x54a908(0xaa)+_0x3cbdb4[_0x54a908(0xda)]+'\x20'+_0x3cbdb4[_0x54a908(0x75)]+'\x20('+_0x3cbdb4[_0x54a908(0x8f)]+')'),console[_0x54a908(0x84)](_0x54a908(0x97)+_0x170952['ip']);const _0x42079e={'customerName':_0x3cbdb4[_0x54a908(0xda)]+'\x20'+_0x3cbdb4[_0x54a908(0x75)],'customerEmail':_0x3cbdb4['email'],'customerIp':_0x170952['ip'],'customerUa':_0x170952[_0x54a908(0x89)]},_0x4d2194=await database_1[_0x54a908(0xb8)][_0x54a908(0xbb)]['findUnique']({'where':{'id':_0x40611a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4d2194)return _0x40a958[_0x54a908(0xa1)](0x194)['json']({'success':![],'message':_0x54a908(0x8c)});if(_0x4d2194[_0x54a908(0xf4)]!==_0x54a908(0xe6))return _0x40a958['status'](0x190)[_0x54a908(0xb1)]({'success':![],'message':_0x54a908(0xd6)});if(_0x4d2194[_0x54a908(0xa1)]!==_0x54a908(0xdb))return _0x40a958[_0x54a908(0xa1)](0x190)[_0x54a908(0xb1)]({'success':![],'message':_0x54a908(0xf2)+_0x4d2194[_0x54a908(0xa1)]+_0x54a908(0xcf)});await database_1[_0x54a908(0xb8)][_0x54a908(0xbb)][_0x54a908(0xce)]({'where':{'id':_0x40611a},'data':{..._0x42079e,'updatedAt':new Date()}});const _0x8b7dd2=_0x54a908(0xaf),_0x175faa=_0x4d2194[_0x54a908(0xbe)];console[_0x54a908(0x84)](_0x54a908(0xc6)),console[_0x54a908(0x84)](_0x54a908(0xc0)+_0x8b7dd2),console[_0x54a908(0x84)]('\x20\x20\x20Return\x20URL:\x20'+_0x175faa);const _0x241e6e={'first_name':_0x3cbdb4[_0x54a908(0xda)],'last_name':_0x3cbdb4[_0x54a908(0x75)],'email':_0x3cbdb4['email']},_0x21f18e=await this[_0x54a908(0xd4)][_0x54a908(0xe3)]({'paymentId':_0x4d2194['id'],'orderId':_0x4d2194['gatewayOrderId']||_0x4d2194['id'],'amount':_0x4d2194['amount'],'currency':_0x4d2194[_0x54a908(0x82)],'cardData':_0x3d8365,'resultUrl':_0x8b7dd2,'returnUrl':_0x175faa,'cardHolder':_0x241e6e,'browser':_0x170952});console[_0x54a908(0x84)](_0x54a908(0x94),_0x21f18e);const _0x7b14a2={'status':_0x21f18e[_0x54a908(0xa1)],'updatedAt':new Date(),'statusChangedBy':_0x54a908(0xf0),'statusChangedAt':new Date()};_0x21f18e[_0x54a908(0xb2)]&&(_0x7b14a2[_0x54a908(0xca)]=_0x21f18e[_0x54a908(0xb2)],console[_0x54a908(0x84)](_0x54a908(0xc8)+_0x21f18e[_0x54a908(0xb2)]));if(_0x21f18e['status']===_0x54a908(0x8b))_0x7b14a2[_0x54a908(0x7f)]=new Date();else _0x21f18e[_0x54a908(0xa1)]===_0x54a908(0x81)&&(_0x7b14a2[_0x54a908(0xd8)]=_0x54a908(0xa3));_0x7b14a2[_0x54a908(0x78)]=_0x54a908(0xe6);if(_0x3d8365['number']){const _0x4eb34b=_0x3d8365[_0x54a908(0x79)][_0x54a908(0xc9)](/[\s-]/g,'');_0x7b14a2[_0x54a908(0xa9)]=_0x4eb34b[_0x54a908(0xa4)](-0x4),console[_0x54a908(0x84)](_0x54a908(0xb3)+_0x7b14a2[_0x54a908(0xa9)]);}await database_1[_0x54a908(0xb8)]['payment']['update']({'where':{'id':_0x4d2194['id']},'data':_0x7b14a2}),await database_1[_0x54a908(0xb8)][_0x54a908(0x9e)][_0x54a908(0xa8)]({'data':{'paymentId':_0x4d2194['id'],'shopId':_0x4d2194[_0x54a908(0xba)],'event':_0x54a908(0xb5)+_0x21f18e['status']?.[_0x54a908(0xb4)](),'statusCode':0xc8,'responseBody':JSON[_0x54a908(0xa5)]({'oldStatus':_0x54a908(0xdb),'newStatus':_0x21f18e[_0x54a908(0xa1)],'gatewayPaymentId':_0x21f18e[_0x54a908(0xb2)],'requires3ds':_0x21f18e[_0x54a908(0xf5)],'processedAt':new Date()[_0x54a908(0xe9)]()})}});if(_0x21f18e[_0x54a908(0x88)]){await this[_0x54a908(0xac)](_0x4d2194,_0x21f18e[_0x54a908(0xa1)],_0x21f18e[_0x54a908(0xb2)]),await this['sendPaymentStatusNotification'](_0x4d2194,_0x21f18e[_0x54a908(0xa1)]);if(_0x21f18e[_0x54a908(0xa1)]==='PAID'){console['log'](_0x54a908(0x9a)+_0x40611a+_0x54a908(0xcd));try{const {PaymentLinkService:_0x5570ce}=await Promise['resolve']()[_0x54a908(0x9c)](()=>__importStar(require('../services/paymentLinkService'))),_0x199367=new _0x5570ce();await _0x199367[_0x54a908(0xa7)](_0x40611a),console['log'](_0x54a908(0x91)+_0x40611a);}catch(_0x62553f){console[_0x54a908(0x85)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x62553f);}}}console[_0x54a908(0x84)](_0x54a908(0x83)+_0x40611a+'\x20processed:\x20'+_0x21f18e['status']);if(_0x21f18e['status']===_0x54a908(0x8b))_0x40a958[_0x54a908(0xb1)]({'success':!![],'message':_0x54a908(0x8d),'result':{'status':_0x54a908(0x8b),'gatewayPaymentId':_0x21f18e[_0x54a908(0xb2)],'redirectUrl':_0x175faa,'final':!![]}});else _0x21f18e[_0x54a908(0xf5)]&&_0x21f18e['threeds_url']?_0x40a958[_0x54a908(0xb1)]({'success':!![],'message':_0x54a908(0xa2),'result':{'status':_0x54a908(0xdb),'gatewayPaymentId':_0x21f18e[_0x54a908(0xb2)],'redirectUrl':_0x21f18e[_0x54a908(0x7e)],'requires3ds':!![],'final':![]}}):_0x40a958[_0x54a908(0xa1)](0x190)[_0x54a908(0xb1)]({'success':![],'message':_0x54a908(0xc5),'result':{'status':_0x54a908(0x81),'gatewayPaymentId':_0x21f18e[_0x54a908(0xb2)],'redirectUrl':_0x4d2194['failUrl'],'final':!![]}});}catch(_0xf7965){_0x1db55a(_0xf7965);}},this[_0x17954b(0xc3)]=new paymentService_1[(_0x17954b(0xbc))](),this['masterCardService']=new mastercardService_1[(_0x17954b(0xf3))](),this['webhookService']=new webhookService_1[(_0x17954b(0xe4))]();}async[a8_0x454bbc(0xac)](_0x108ba2,_0x31e88d,_0x3b19c6){const _0x5ce588=a8_0x454bbc,_0x3de04e=Date[_0x5ce588(0x7c)]();try{const _0x3708d2=_0x108ba2['shop'],_0x4219fe=_0x3708d2['settings'];if(!_0x4219fe?.[_0x5ce588(0xde)]){console['log'](_0x5ce588(0xa6)+_0x3708d2['id']);return;}const _0x3daa5d=_0x31e88d==='PAID'?'payment.success':_0x5ce588(0xee);let _0x5dfb0d=[];if(_0x4219fe[_0x5ce588(0xe8)])try{_0x5dfb0d=Array[_0x5ce588(0xc4)](_0x4219fe[_0x5ce588(0xe8)])?_0x4219fe['webhookEvents']:JSON[_0x5ce588(0xc1)](_0x4219fe[_0x5ce588(0xe8)]);}catch(_0x3ce55d){console[_0x5ce588(0x85)](_0x5ce588(0x77),_0x3ce55d),_0x5dfb0d=[];}if(!_0x5dfb0d[_0x5ce588(0xae)](_0x3daa5d)){console[_0x5ce588(0x84)](_0x5ce588(0xef)+_0x3daa5d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3708d2['id']);return;}const _0x4e3e86={'event':_0x3daa5d,'payment':{'id':_0x108ba2['id'],'order_id':_0x108ba2[_0x5ce588(0xf1)],'gateway_order_id':_0x108ba2[_0x5ce588(0xa0)],'gateway':'1111','amount':_0x108ba2['amount'],'currency':_0x108ba2['currency'],'status':_0x31e88d[_0x5ce588(0xb4)](),'customer_email':_0x108ba2[_0x5ce588(0xe0)],'customer_name':_0x108ba2[_0x5ce588(0x7b)],'gateway_payment_id':_0x3b19c6,'created_at':_0x108ba2[_0x5ce588(0xed)],'updated_at':new Date()}},_0x1a10a0=await fetch(_0x4219fe[_0x5ce588(0xde)],{'method':_0x5ce588(0xd2),'headers':{'Content-Type':'application/json','User-Agent':_0x5ce588(0xd7)},'body':JSON[_0x5ce588(0xa5)](_0x4e3e86)}),_0x188972=Date[_0x5ce588(0x7c)]()-_0x3de04e;console[_0x5ce588(0x84)](_0x5ce588(0xcb)+_0x4219fe[_0x5ce588(0xde)]+_0x5ce588(0xb0)+_0x1a10a0[_0x5ce588(0xa1)]+'\x20('+_0x188972+'ms)');}catch(_0x525eab){console['error'](_0x5ce588(0x87),_0x525eab);}}async[a8_0x454bbc(0xdc)](_0x2e4b1e,_0x321d88){const _0x32e0f5=a8_0x454bbc;try{const {telegramBotService:_0x45c152}=await Promise[_0x32e0f5(0x9b)]()[_0x32e0f5(0x9c)](()=>__importStar(require('../services/telegramBotService'))),_0x4fcc51={'PAID':_0x32e0f5(0xab),'FAILED':_0x32e0f5(0xcc)},_0x526186=_0x4fcc51[_0x321d88];if(!_0x526186)return;await _0x45c152['sendPaymentNotification'](_0x2e4b1e[_0x32e0f5(0xba)],_0x2e4b1e,_0x526186);}catch(_0x4b174b){console['error'](_0x32e0f5(0xb9),_0x4b174b);}}}exports[a8_0x454bbc(0xd0)]=PaymentController;