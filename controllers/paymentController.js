'use strict';const a8_0x5967c5=a8_0x3ff3;(function(_0x583a3f,_0x5140b6){const _0x58687c=a8_0x3ff3,_0x232843=_0x583a3f();while(!![]){try{const _0xc09a34=parseInt(_0x58687c(0x13d))/0x1+-parseInt(_0x58687c(0x170))/0x2*(-parseInt(_0x58687c(0x120))/0x3)+-parseInt(_0x58687c(0x135))/0x4*(-parseInt(_0x58687c(0x160))/0x5)+-parseInt(_0x58687c(0x186))/0x6+-parseInt(_0x58687c(0x179))/0x7*(parseInt(_0x58687c(0x112))/0x8)+parseInt(_0x58687c(0x140))/0x9+-parseInt(_0x58687c(0x16e))/0xa*(-parseInt(_0x58687c(0x17e))/0xb);if(_0xc09a34===_0x5140b6)break;else _0x232843['push'](_0x232843['shift']());}catch(_0x47679c){_0x232843['push'](_0x232843['shift']());}}}(a8_0x5965,0x1dcc2));function a8_0x5965(){const _0x2d59e7=['__importStar','PENDING','threeds_url','shopId','Payment\x20failed','1111','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','MasterCard\x20webhook\x20sent\x20to\x20','gatewayOrderId','parse','paymentService','application/json','hasOwnProperty','MasterCardService','üí≥\x20Processing\x20MasterCard\x20payment:\x20','toISOString','status','paymentMethod','resolve','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20\x20\x20Return\x20URL:\x20','customerEmail','PAID','updatePaymentCustomer','final','13935mbxodD','sendPaymentStatusNotification','toLowerCase','üìù\x20Customer\x20data:','user_agent','sendPaymentNotification','masterCardService','3DS\x20verification\x20required','body','üìà\x20MasterCard\x20payment\x20','Customer\x20data\x20updated\x20successfully','error','webhookEvents','https://api.trapay.uk/api/webhooks/gateway/mastercard','12280GIvNhN','../services/paymentService','574lLuAGG','Failed\x20to\x20send\x20MasterCard\x20webhook:','../services/paymentLinkService','updatedAt','length','\x20not\x20enabled\x20for\x20shop\x20','payment.success','gateway_payment_id','WebhookService','14VYLXCq','slice','__createBinding',',\x20cannot\x20process','currency','1716OuzMqC','now','handleSuccessfulPayment','last_name','defineProperty','gateway','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','get','1281066kMKgZv','json','payment','customerUa','sendShopWebhook','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','includes','ms)','Card\x20payment\x20failed','processMasterCardPayment','customerCountry','__importDefault','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getOwnPropertyDescriptor','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','Payment\x20status\x20is\x20','update','../services/gateways/mastercardService','871232ixyynP','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','stringify','customerName','paid','‚úÖ\x20MasterCard\x20payment\x20','FAILED','mastercard_','default','writable','payment.failed','amount','getPaymentStatus','Error\x20parsing\x20webhook\x20events:','831KjNTpg','email','orderId','POST','getPaymentById','Payment\x20not\x20found','successUrl','params','Payment\x20created\x20successfully','log','then','üí≥\x20Card\x20holder:\x20','webhookUrl','first_name','failureMessage','isArray','create','failUrl','PaymentController','processCardPayment','üí≥\x20Browser\x20IP:\x20','16ApjSab','system','../services/webhookService','createdAt','number','PaymentService','\x20processed:\x20','Payment\x20processed\x20successfully','93409vSVTAg','\x20with\x20status\x20','mastercard','1599705gOXLKU','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','getOwnPropertyNames','createPublicPayment','failed','__esModule','cardLast4'];a8_0x5965=function(){return _0x2d59e7;};return a8_0x5965();}var __createBinding=this&&this[a8_0x5967c5(0x17b)]||(Object[a8_0x5967c5(0x130)]?function(_0x3e050f,_0x24a053,_0x480843,_0x3e2047){const _0xee5b56=a8_0x5967c5;if(_0x3e2047===undefined)_0x3e2047=_0x480843;var _0x3f7cf0=Object[_0xee5b56(0x10d)](_0x24a053,_0x480843);(!_0x3f7cf0||(_0xee5b56(0x185)in _0x3f7cf0?!_0x24a053[_0xee5b56(0x145)]:_0x3f7cf0[_0xee5b56(0x11b)]||_0x3f7cf0['configurable']))&&(_0x3f7cf0={'enumerable':!![],'get':function(){return _0x24a053[_0x480843];}}),Object[_0xee5b56(0x182)](_0x3e050f,_0x3e2047,_0x3f7cf0);}:function(_0x1ba272,_0x3a8b86,_0x1dc22d,_0x1e7936){if(_0x1e7936===undefined)_0x1e7936=_0x1dc22d;_0x1ba272[_0x1e7936]=_0x3a8b86[_0x1dc22d];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x4f287f,_0x23e836){Object['defineProperty'](_0x4f287f,'default',{'enumerable':!![],'value':_0x23e836});}:function(_0x4e9b04,_0x3ba595){_0x4e9b04['default']=_0x3ba595;}),__importStar=this&&this[a8_0x5967c5(0x147)]||(function(){var _0x4736aa=function(_0x273b5d){const _0x3e7e99=a8_0x3ff3;return _0x4736aa=Object[_0x3e7e99(0x142)]||function(_0x2130a2){const _0x19f71c=_0x3e7e99;var _0x2de189=[];for(var _0x2d1cc8 in _0x2130a2)if(Object['prototype'][_0x19f71c(0x153)]['call'](_0x2130a2,_0x2d1cc8))_0x2de189[_0x2de189[_0x19f71c(0x174)]]=_0x2d1cc8;return _0x2de189;},_0x4736aa(_0x273b5d);};return function(_0x8ebb39){const _0x448949=a8_0x3ff3;if(_0x8ebb39&&_0x8ebb39[_0x448949(0x145)])return _0x8ebb39;var _0x34e1ea={};if(_0x8ebb39!=null){for(var _0x39d438=_0x4736aa(_0x8ebb39),_0x7a5cab=0x0;_0x7a5cab<_0x39d438[_0x448949(0x174)];_0x7a5cab++)if(_0x39d438[_0x7a5cab]!==_0x448949(0x11a))__createBinding(_0x34e1ea,_0x8ebb39,_0x39d438[_0x7a5cab]);}return __setModuleDefault(_0x34e1ea,_0x8ebb39),_0x34e1ea;};}()),__importDefault=this&&this[a8_0x5967c5(0x10b)]||function(_0x4d425d){const _0x5a08bf=a8_0x5967c5;return _0x4d425d&&_0x4d425d[_0x5a08bf(0x145)]?_0x4d425d:{'default':_0x4d425d};};Object[a8_0x5967c5(0x182)](exports,'__esModule',{'value':!![]}),exports[a8_0x5967c5(0x132)]=void 0x0;const paymentService_1=require(a8_0x5967c5(0x16f)),mastercardService_1=require(a8_0x5967c5(0x111)),webhookService_1=require(a8_0x5967c5(0x137)),database_1=__importDefault(require('../config/database'));function a8_0x3ff3(_0x4ef3b7,_0x2afd82){const _0x596537=a8_0x5965();return a8_0x3ff3=function(_0x3ff3d1,_0x55aa82){_0x3ff3d1=_0x3ff3d1-0x107;let _0x10ae33=_0x596537[_0x3ff3d1];return _0x10ae33;},a8_0x3ff3(_0x4ef3b7,_0x2afd82);}class PaymentController{constructor(){const _0x27b7f1=a8_0x5967c5;this[_0x27b7f1(0x143)]=async(_0xae87e8,_0xe8cd95,_0x4b48ca)=>{const _0x4e0f3c=_0x27b7f1;try{const _0x58a7e2=_0xae87e8[_0x4e0f3c(0x168)],_0x1cc1fa=await this[_0x4e0f3c(0x151)][_0x4e0f3c(0x143)](_0x58a7e2);_0xe8cd95['status'](0xc9)[_0x4e0f3c(0x187)]({'success':!![],'message':_0x4e0f3c(0x128),'result':_0x1cc1fa});}catch(_0x3aedd3){_0x4b48ca(_0x3aedd3);}},this['getPaymentStatus']=async(_0x4b8526,_0x16e720,_0xe73aa2)=>{const _0x4650d1=_0x27b7f1;try{const {id:_0x2efe0f}=_0x4b8526['params'],_0x11ecee=await this[_0x4650d1(0x151)][_0x4650d1(0x11e)](_0x2efe0f);if(!_0x11ecee)return _0x16e720[_0x4650d1(0x157)](0x194)[_0x4650d1(0x187)]({'success':![],'message':_0x4650d1(0x125)});_0x16e720[_0x4650d1(0x187)]({'success':!![],'result':_0x11ecee});}catch(_0x22041c){_0xe73aa2(_0x22041c);}},this[_0x27b7f1(0x124)]=async(_0x5dc4bb,_0x2d854c,_0x33bf34)=>{const _0x191ee7=_0x27b7f1;try{const {id:_0x2a3909}=_0x5dc4bb[_0x191ee7(0x127)],_0x19feb6=await this['paymentService'][_0x191ee7(0x124)](_0x2a3909);if(!_0x19feb6)return _0x2d854c[_0x191ee7(0x157)](0x194)[_0x191ee7(0x187)]({'success':![],'message':_0x191ee7(0x125)});_0x2d854c[_0x191ee7(0x187)]({'success':!![],'result':_0x19feb6});}catch(_0x3090c0){_0x33bf34(_0x3090c0);}},this[_0x27b7f1(0x15e)]=async(_0x2e3205,_0x30093d,_0x13e8fb)=>{const _0x78bac8=_0x27b7f1;try{const {id:_0x4120da}=_0x2e3205[_0x78bac8(0x127)],_0xac6da1=_0x2e3205[_0x78bac8(0x168)];console[_0x78bac8(0x129)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x4120da),console[_0x78bac8(0x129)](_0x78bac8(0x163),_0xac6da1);const _0x227ddf=await this[_0x78bac8(0x151)]['updatePaymentCustomerDataPublic'](_0x4120da,_0xac6da1);if(!_0x227ddf)return _0x30093d[_0x78bac8(0x157)](0x194)['json']({'success':![],'message':_0x78bac8(0x125)});_0x30093d[_0x78bac8(0x187)]({'success':!![],'message':_0x78bac8(0x16a),'result':{'paymentId':_0x227ddf['id'],'customerIp':_0x227ddf['customerIp'],'customerUa':_0x227ddf[_0x78bac8(0x189)],'customerCountry':_0x227ddf[_0x78bac8(0x10a)],'updatedAt':_0x227ddf[_0x78bac8(0x173)]}});}catch(_0x48c3c6){_0x13e8fb(_0x48c3c6);}},this[_0x27b7f1(0x109)]=async(_0x4b4e4e,_0x2be480,_0x180f30)=>{const _0x2407bd=_0x27b7f1;try{const {id:_0x3112cd}=_0x4b4e4e[_0x2407bd(0x127)],{cardData:_0x42b943,cardHolder:_0x23a59d,browser:_0x3ec664}=_0x4b4e4e[_0x2407bd(0x168)];console[_0x2407bd(0x129)](_0x2407bd(0x155)+_0x3112cd),console[_0x2407bd(0x129)](_0x2407bd(0x12b)+_0x23a59d[_0x2407bd(0x12d)]+'\x20'+_0x23a59d[_0x2407bd(0x181)]+'\x20('+_0x23a59d['email']+')'),console[_0x2407bd(0x129)](_0x2407bd(0x134)+_0x3ec664['ip']);const _0x135fe8={'customerName':_0x23a59d[_0x2407bd(0x12d)]+'\x20'+_0x23a59d[_0x2407bd(0x181)],'customerEmail':_0x23a59d[_0x2407bd(0x121)],'customerIp':_0x3ec664['ip'],'customerUa':_0x3ec664[_0x2407bd(0x164)]},_0x25c53e=await database_1[_0x2407bd(0x11a)][_0x2407bd(0x188)]['findUnique']({'where':{'id':_0x3112cd},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x25c53e)return _0x2be480[_0x2407bd(0x157)](0x194)['json']({'success':![],'message':_0x2407bd(0x125)});if(_0x25c53e[_0x2407bd(0x183)]!==_0x2407bd(0x13f))return _0x2be480[_0x2407bd(0x157)](0x190)['json']({'success':![],'message':_0x2407bd(0x18b)});if(_0x25c53e['status']!==_0x2407bd(0x148))return _0x2be480[_0x2407bd(0x157)](0x190)[_0x2407bd(0x187)]({'success':![],'message':_0x2407bd(0x10f)+_0x25c53e[_0x2407bd(0x157)]+_0x2407bd(0x17c)});await database_1[_0x2407bd(0x11a)]['payment'][_0x2407bd(0x110)]({'where':{'id':_0x3112cd},'data':{..._0x135fe8,'updatedAt':new Date()}});const _0x3a2215=_0x2407bd(0x16d),_0x3ca02f=_0x25c53e[_0x2407bd(0x126)];console['log']('üí≥\x20MasterCard\x20URLs:'),console[_0x2407bd(0x129)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x3a2215),console[_0x2407bd(0x129)](_0x2407bd(0x15b)+_0x3ca02f);const _0x25dd36={'first_name':_0x23a59d[_0x2407bd(0x12d)],'last_name':_0x23a59d[_0x2407bd(0x181)],'email':_0x23a59d[_0x2407bd(0x121)]},_0x22bfb5=await this[_0x2407bd(0x166)][_0x2407bd(0x133)]({'paymentId':_0x25c53e['id'],'orderId':_0x25c53e[_0x2407bd(0x14f)]||_0x25c53e['id'],'amount':_0x25c53e[_0x2407bd(0x11d)],'currency':_0x25c53e['currency'],'cardData':_0x42b943,'resultUrl':_0x3a2215,'returnUrl':_0x3ca02f,'cardHolder':_0x25dd36,'browser':_0x3ec664});console['log']('üí≥\x20MasterCard\x20result:',_0x22bfb5);const _0x36255f={'status':_0x22bfb5[_0x2407bd(0x157)],'updatedAt':new Date(),'statusChangedBy':_0x2407bd(0x136),'statusChangedAt':new Date()};_0x22bfb5['gateway_payment_id']&&(_0x36255f['gatewayPaymentId']=_0x22bfb5[_0x2407bd(0x177)],console[_0x2407bd(0x129)](_0x2407bd(0x113)+_0x22bfb5[_0x2407bd(0x177)]));if(_0x22bfb5[_0x2407bd(0x157)]===_0x2407bd(0x15d))_0x36255f['paidAt']=new Date();else _0x22bfb5[_0x2407bd(0x157)]===_0x2407bd(0x118)&&(_0x36255f[_0x2407bd(0x12e)]=_0x2407bd(0x108));_0x36255f[_0x2407bd(0x158)]='mastercard';if(_0x42b943[_0x2407bd(0x139)]){const _0x4ee1b6=_0x42b943[_0x2407bd(0x139)]['replace'](/[\s-]/g,'');_0x36255f['cardLast4']=_0x4ee1b6[_0x2407bd(0x17a)](-0x4),console['log'](_0x2407bd(0x10e)+_0x36255f[_0x2407bd(0x146)]);}await database_1['default']['payment'][_0x2407bd(0x110)]({'where':{'id':_0x25c53e['id']},'data':_0x36255f}),await database_1[_0x2407bd(0x11a)]['webhookLog'][_0x2407bd(0x130)]({'data':{'paymentId':_0x25c53e['id'],'shopId':_0x25c53e[_0x2407bd(0x14a)],'event':_0x2407bd(0x119)+_0x22bfb5[_0x2407bd(0x157)]?.[_0x2407bd(0x162)](),'statusCode':0xc8,'responseBody':JSON[_0x2407bd(0x114)]({'oldStatus':_0x2407bd(0x148),'newStatus':_0x22bfb5[_0x2407bd(0x157)],'gatewayPaymentId':_0x22bfb5['gateway_payment_id'],'requires3ds':_0x22bfb5['requires_3ds'],'processedAt':new Date()[_0x2407bd(0x156)]()})}});if(_0x22bfb5[_0x2407bd(0x15f)]){await this[_0x2407bd(0x18a)](_0x25c53e,_0x22bfb5[_0x2407bd(0x157)],_0x22bfb5[_0x2407bd(0x177)]),await this['sendPaymentStatusNotification'](_0x25c53e,_0x22bfb5[_0x2407bd(0x157)]);if(_0x22bfb5['status']==='PAID'){console[_0x2407bd(0x129)](_0x2407bd(0x169)+_0x3112cd+_0x2407bd(0x15a));try{const {PaymentLinkService:_0x58cca2}=await Promise['resolve']()[_0x2407bd(0x12a)](()=>__importStar(require(_0x2407bd(0x172)))),_0x536df9=new _0x58cca2();await _0x536df9[_0x2407bd(0x180)](_0x3112cd),console['log'](_0x2407bd(0x141)+_0x3112cd);}catch(_0x383114){console[_0x2407bd(0x16b)](_0x2407bd(0x14d),_0x383114);}}}console[_0x2407bd(0x129)](_0x2407bd(0x117)+_0x3112cd+_0x2407bd(0x13b)+_0x22bfb5[_0x2407bd(0x157)]);if(_0x22bfb5['status']===_0x2407bd(0x15d))_0x2be480[_0x2407bd(0x187)]({'success':!![],'message':_0x2407bd(0x13c),'result':{'status':_0x2407bd(0x15d),'gatewayPaymentId':_0x22bfb5[_0x2407bd(0x177)],'redirectUrl':_0x3ca02f,'final':!![]}});else _0x22bfb5['requires_3ds']&&_0x22bfb5[_0x2407bd(0x149)]?_0x2be480[_0x2407bd(0x187)]({'success':!![],'message':_0x2407bd(0x167),'result':{'status':_0x2407bd(0x148),'gatewayPaymentId':_0x22bfb5[_0x2407bd(0x177)],'redirectUrl':_0x22bfb5[_0x2407bd(0x149)],'requires3ds':!![],'final':![]}}):_0x2be480[_0x2407bd(0x157)](0x190)[_0x2407bd(0x187)]({'success':![],'message':_0x2407bd(0x14b),'result':{'status':_0x2407bd(0x118),'gatewayPaymentId':_0x22bfb5[_0x2407bd(0x177)],'redirectUrl':_0x25c53e[_0x2407bd(0x131)],'final':!![]}});}catch(_0x5c2daf){_0x180f30(_0x5c2daf);}},this[_0x27b7f1(0x151)]=new paymentService_1[(_0x27b7f1(0x13a))](),this[_0x27b7f1(0x166)]=new mastercardService_1[(_0x27b7f1(0x154))](),this['webhookService']=new webhookService_1[(_0x27b7f1(0x178))]();}async[a8_0x5967c5(0x18a)](_0x1d69df,_0xd224b6,_0x455049){const _0x22a15b=a8_0x5967c5,_0xb7905c=Date['now']();try{const _0x409013=_0x1d69df['shop'],_0x411a30=_0x409013['settings'];if(!_0x411a30?.['webhookUrl']){console['log'](_0x22a15b(0x184)+_0x409013['id']);return;}const _0x452fbe=_0xd224b6===_0x22a15b(0x15d)?_0x22a15b(0x176):_0x22a15b(0x11c);let _0x39ce4a=[];if(_0x411a30['webhookEvents'])try{_0x39ce4a=Array[_0x22a15b(0x12f)](_0x411a30[_0x22a15b(0x16c)])?_0x411a30[_0x22a15b(0x16c)]:JSON[_0x22a15b(0x150)](_0x411a30['webhookEvents']);}catch(_0x58d174){console[_0x22a15b(0x16b)](_0x22a15b(0x11f),_0x58d174),_0x39ce4a=[];}if(!_0x39ce4a[_0x22a15b(0x18c)](_0x452fbe)){console[_0x22a15b(0x129)]('Webhook\x20event\x20'+_0x452fbe+_0x22a15b(0x175)+_0x409013['id']);return;}const _0x1fb893={'event':_0x452fbe,'payment':{'id':_0x1d69df['id'],'order_id':_0x1d69df[_0x22a15b(0x122)],'gateway_order_id':_0x1d69df['gatewayOrderId'],'gateway':_0x22a15b(0x14c),'amount':_0x1d69df[_0x22a15b(0x11d)],'currency':_0x1d69df[_0x22a15b(0x17d)],'status':_0xd224b6[_0x22a15b(0x162)](),'customer_email':_0x1d69df[_0x22a15b(0x15c)],'customer_name':_0x1d69df[_0x22a15b(0x115)],'gateway_payment_id':_0x455049,'created_at':_0x1d69df[_0x22a15b(0x138)],'updated_at':new Date()}},_0x8eba43=await fetch(_0x411a30[_0x22a15b(0x12c)],{'method':_0x22a15b(0x123),'headers':{'Content-Type':_0x22a15b(0x152),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x22a15b(0x114)](_0x1fb893)}),_0x4863d2=Date[_0x22a15b(0x17f)]()-_0xb7905c;console[_0x22a15b(0x129)](_0x22a15b(0x14e)+_0x411a30[_0x22a15b(0x12c)]+_0x22a15b(0x13e)+_0x8eba43[_0x22a15b(0x157)]+'\x20('+_0x4863d2+_0x22a15b(0x107));}catch(_0x28abbc){console[_0x22a15b(0x16b)](_0x22a15b(0x171),_0x28abbc);}}async[a8_0x5967c5(0x161)](_0xb48351,_0x410b1b){const _0x35d86e=a8_0x5967c5;try{const {telegramBotService:_0x486c40}=await Promise[_0x35d86e(0x159)]()[_0x35d86e(0x12a)](()=>__importStar(require('../services/telegramBotService'))),_0x437b1={'PAID':_0x35d86e(0x116),'FAILED':_0x35d86e(0x144)},_0x3ee5c6=_0x437b1[_0x410b1b];if(!_0x3ee5c6)return;await _0x486c40[_0x35d86e(0x165)](_0xb48351[_0x35d86e(0x14a)],_0xb48351,_0x3ee5c6);}catch(_0x243a01){console[_0x35d86e(0x16b)](_0x35d86e(0x10c),_0x243a01);}}}exports['PaymentController']=PaymentController;