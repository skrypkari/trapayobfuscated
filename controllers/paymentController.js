'use strict';const a8_0x16d0fd=a8_0x2ac6;(function(_0x594270,_0x501fd5){const _0x301d83=a8_0x2ac6,_0x51ce2e=_0x594270();while(!![]){try{const _0x32aef9=-parseInt(_0x301d83(0x1c3))/0x1+-parseInt(_0x301d83(0x20b))/0x2+parseInt(_0x301d83(0x1d7))/0x3*(parseInt(_0x301d83(0x1c0))/0x4)+parseInt(_0x301d83(0x1ea))/0x5*(parseInt(_0x301d83(0x210))/0x6)+parseInt(_0x301d83(0x21e))/0x7*(-parseInt(_0x301d83(0x219))/0x8)+-parseInt(_0x301d83(0x1fe))/0x9*(-parseInt(_0x301d83(0x21a))/0xa)+parseInt(_0x301d83(0x1bf))/0xb*(parseInt(_0x301d83(0x1c8))/0xc);if(_0x32aef9===_0x501fd5)break;else _0x51ce2e['push'](_0x51ce2e['shift']());}catch(_0x4f06f1){_0x51ce2e['push'](_0x51ce2e['shift']());}}}(a8_0x22f7,0xbb3f4));var __createBinding=this&&this[a8_0x16d0fd(0x205)]||(Object[a8_0x16d0fd(0x1ee)]?function(_0x2dd489,_0x13f6b0,_0x1083d1,_0x22be19){const _0x1a3ede=a8_0x16d0fd;if(_0x22be19===undefined)_0x22be19=_0x1083d1;var _0xfbc57=Object[_0x1a3ede(0x1e3)](_0x13f6b0,_0x1083d1);(!_0xfbc57||(_0x1a3ede(0x1dd)in _0xfbc57?!_0x13f6b0[_0x1a3ede(0x220)]:_0xfbc57['writable']||_0xfbc57[_0x1a3ede(0x1ad)]))&&(_0xfbc57={'enumerable':!![],'get':function(){return _0x13f6b0[_0x1083d1];}}),Object[_0x1a3ede(0x20c)](_0x2dd489,_0x22be19,_0xfbc57);}:function(_0x443e31,_0x403e37,_0x321c64,_0x16e470){if(_0x16e470===undefined)_0x16e470=_0x321c64;_0x443e31[_0x16e470]=_0x403e37[_0x321c64];}),__setModuleDefault=this&&this[a8_0x16d0fd(0x1fc)]||(Object[a8_0x16d0fd(0x1ee)]?function(_0x495caa,_0x461417){const _0x4c7afe=a8_0x16d0fd;Object['defineProperty'](_0x495caa,_0x4c7afe(0x204),{'enumerable':!![],'value':_0x461417});}:function(_0x13f6fa,_0x564a93){const _0x460e5c=a8_0x16d0fd;_0x13f6fa[_0x460e5c(0x204)]=_0x564a93;}),__importStar=this&&this['__importStar']||(function(){var _0x589581=function(_0x596905){const _0x1a1328=a8_0x2ac6;return _0x589581=Object[_0x1a1328(0x1fb)]||function(_0x4d2644){const _0x42736c=_0x1a1328;var _0x5c9f98=[];for(var _0x201ce7 in _0x4d2644)if(Object[_0x42736c(0x1d5)][_0x42736c(0x1ef)]['call'](_0x4d2644,_0x201ce7))_0x5c9f98[_0x5c9f98[_0x42736c(0x1f6)]]=_0x201ce7;return _0x5c9f98;},_0x589581(_0x596905);};return function(_0x40bf04){const _0x452887=a8_0x2ac6;if(_0x40bf04&&_0x40bf04['__esModule'])return _0x40bf04;var _0x302dbb={};if(_0x40bf04!=null){for(var _0x11331d=_0x589581(_0x40bf04),_0x3e05b3=0x0;_0x3e05b3<_0x11331d['length'];_0x3e05b3++)if(_0x11331d[_0x3e05b3]!==_0x452887(0x204))__createBinding(_0x302dbb,_0x40bf04,_0x11331d[_0x3e05b3]);}return __setModuleDefault(_0x302dbb,_0x40bf04),_0x302dbb;};}()),__importDefault=this&&this['__importDefault']||function(_0x57c9ad){const _0xd955e5=a8_0x16d0fd;return _0x57c9ad&&_0x57c9ad[_0xd955e5(0x220)]?_0x57c9ad:{'default':_0x57c9ad};};function a8_0x2ac6(_0x38f040,_0xc4be9e){const _0x22f72c=a8_0x22f7();return a8_0x2ac6=function(_0x2ac66a,_0xe60d0c){_0x2ac66a=_0x2ac66a-0x1ac;let _0x2bfb80=_0x22f72c[_0x2ac66a];return _0x2bfb80;},a8_0x2ac6(_0x38f040,_0xc4be9e);}Object[a8_0x16d0fd(0x20c)](exports,a8_0x16d0fd(0x220),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x16d0fd(0x213)),mastercardService_1=require(a8_0x16d0fd(0x1d0)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x16d0fd(0x21f)));class PaymentController{constructor(){const _0x2434e1=a8_0x16d0fd;this[_0x2434e1(0x1e7)]=async(_0x479cfc,_0x5ed579,_0x28e37b)=>{const _0x242dbf=_0x2434e1;try{const _0x2b8cd9=_0x479cfc[_0x242dbf(0x1c7)],_0x4a3a04=await this[_0x242dbf(0x1b4)][_0x242dbf(0x1e7)](_0x2b8cd9);_0x5ed579[_0x242dbf(0x1cb)](0xc9)[_0x242dbf(0x1be)]({'success':!![],'message':_0x242dbf(0x211),'result':_0x4a3a04});}catch(_0x327868){_0x28e37b(_0x327868);}},this[_0x2434e1(0x20f)]=async(_0x15672a,_0x5a117e,_0x4513a1)=>{const _0x3d08f4=_0x2434e1;try{const {id:_0x4584d5}=_0x15672a[_0x3d08f4(0x1bd)],_0x126f6c=await this[_0x3d08f4(0x1b4)][_0x3d08f4(0x20f)](_0x4584d5);if(!_0x126f6c)return _0x5a117e['status'](0x194)[_0x3d08f4(0x1be)]({'success':![],'message':'Payment\x20not\x20found'});_0x5a117e[_0x3d08f4(0x1be)]({'success':!![],'result':_0x126f6c});}catch(_0x3d640e){_0x4513a1(_0x3d640e);}},this[_0x2434e1(0x1d4)]=async(_0x43a2e9,_0xb13d75,_0x57aece)=>{const _0x372d40=_0x2434e1;try{const {id:_0x347c00}=_0x43a2e9[_0x372d40(0x1bd)],_0x12db5a=await this[_0x372d40(0x1b4)]['getPaymentById'](_0x347c00);if(!_0x12db5a)return _0xb13d75[_0x372d40(0x1cb)](0x194)['json']({'success':![],'message':_0x372d40(0x1da)});_0xb13d75['json']({'success':!![],'result':_0x12db5a});}catch(_0x478f14){_0x57aece(_0x478f14);}},this[_0x2434e1(0x1fa)]=async(_0x31a412,_0x516471,_0x13409b)=>{const _0x303401=_0x2434e1;try{const {id:_0x23f974}=_0x31a412[_0x303401(0x1bd)],{cardData:_0x178d36,cardHolder:_0x442f4d,browser:_0x526140}=_0x31a412['body'];console[_0x303401(0x1ff)](_0x303401(0x1ca)+_0x23f974);const _0x6ea5c4=await database_1[_0x303401(0x204)]['payment']['findUnique']({'where':{'id':_0x23f974},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x6ea5c4)return _0x516471[_0x303401(0x1cb)](0x194)[_0x303401(0x1be)]({'success':![],'message':_0x303401(0x1da)});if(_0x6ea5c4[_0x303401(0x218)]!=='mastercard')return _0x516471['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x6ea5c4[_0x303401(0x1cb)]!==_0x303401(0x1ba))return _0x516471[_0x303401(0x1cb)](0x190)['json']({'success':![],'message':_0x303401(0x1f7)+_0x6ea5c4[_0x303401(0x1cb)]+_0x303401(0x1b0)});const _0x36554a='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0xaade26=_0x6ea5c4[_0x303401(0x215)];console[_0x303401(0x1ff)](_0x303401(0x1e6)),console[_0x303401(0x1ff)](_0x303401(0x1cd)+_0x36554a),console[_0x303401(0x1ff)]('\x20\x20\x20Return\x20URL:\x20'+_0xaade26);const _0x48c7d3=await this[_0x303401(0x1ec)][_0x303401(0x1e8)]({'paymentId':_0x6ea5c4['id'],'orderId':_0x6ea5c4['gatewayOrderId']||_0x6ea5c4['id'],'amount':_0x6ea5c4[_0x303401(0x201)],'currency':_0x6ea5c4['currency'],'cardData':_0x178d36,'resultUrl':_0x36554a,'returnUrl':_0xaade26,'cardHolder':_0x442f4d,'browser':_0x526140});console[_0x303401(0x1ff)]('ðŸ’³\x20MasterCard\x20result:',_0x48c7d3);const _0x4940de={'status':_0x48c7d3['status'],'updatedAt':new Date(),'statusChangedBy':_0x303401(0x1ae),'statusChangedAt':new Date()};if(_0x48c7d3[_0x303401(0x1cb)]==='PAID')_0x4940de[_0x303401(0x206)]=new Date(),_0x4940de[_0x303401(0x1b1)]=_0x48c7d3[_0x303401(0x1bc)];else _0x48c7d3[_0x303401(0x1cb)]===_0x303401(0x214)&&(_0x4940de[_0x303401(0x1de)]='Card\x20payment\x20failed');_0x4940de[_0x303401(0x1c2)]=_0x303401(0x1e4),await database_1['default'][_0x303401(0x1fd)][_0x303401(0x203)]({'where':{'id':_0x6ea5c4['id']},'data':_0x4940de}),await database_1[_0x303401(0x204)][_0x303401(0x1d1)][_0x303401(0x1ee)]({'data':{'paymentId':_0x6ea5c4['id'],'shopId':_0x6ea5c4['shopId'],'event':_0x303401(0x1bb)+_0x48c7d3['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x303401(0x1f5)]({'oldStatus':_0x303401(0x1ba),'newStatus':_0x48c7d3[_0x303401(0x1cb)],'gatewayPaymentId':_0x48c7d3['gateway_payment_id'],'requires3ds':_0x48c7d3[_0x303401(0x1d6)],'processedAt':new Date()[_0x303401(0x1ce)]()})}});_0x48c7d3[_0x303401(0x1d9)]&&(await this[_0x303401(0x1cf)](_0x6ea5c4,_0x48c7d3['status'],_0x48c7d3[_0x303401(0x1bc)]),await this[_0x303401(0x217)](_0x6ea5c4,_0x48c7d3[_0x303401(0x1cb)]));console['log'](_0x303401(0x207)+_0x23f974+_0x303401(0x1d3)+_0x48c7d3[_0x303401(0x1cb)]);if(_0x48c7d3['status']==='PAID')_0x516471[_0x303401(0x1be)]({'success':!![],'message':_0x303401(0x1b7),'result':{'status':'PAID','gatewayPaymentId':_0x48c7d3[_0x303401(0x1bc)],'redirectUrl':_0xaade26,'final':!![]}});else _0x48c7d3['requires_3ds']&&_0x48c7d3[_0x303401(0x1ed)]?_0x516471[_0x303401(0x1be)]({'success':!![],'message':_0x303401(0x200),'result':{'status':_0x303401(0x1ba),'gatewayPaymentId':_0x48c7d3[_0x303401(0x1bc)],'redirectUrl':_0x48c7d3['threeds_url'],'requires3ds':!![],'final':![]}}):_0x516471[_0x303401(0x1cb)](0x190)['json']({'success':![],'message':_0x303401(0x1cc),'result':{'status':'FAILED','gatewayPaymentId':_0x48c7d3[_0x303401(0x1bc)],'redirectUrl':_0x6ea5c4[_0x303401(0x1ac)],'final':!![]}});}catch(_0x351def){_0x13409b(_0x351def);}},this[_0x2434e1(0x21c)]=async(_0x159156,_0x28cc10,_0x15344b)=>{const _0x4e2dcd=_0x2434e1;try{const {id:_0xa225d6}=_0x159156['params'],{customerIp:_0x2a0226,customerUa:_0x296c46,customerCountry:_0x479634}=_0x159156[_0x4e2dcd(0x1c7)],_0xacd407=await database_1[_0x4e2dcd(0x204)][_0x4e2dcd(0x1fd)][_0x4e2dcd(0x1b9)]({'where':{'id':_0xa225d6},'select':{'id':!![],'status':!![]}});if(!_0xacd407)return _0x28cc10['status'](0x194)[_0x4e2dcd(0x1be)]({'success':![],'message':'Payment\x20not\x20found'});const _0x358c66=await database_1[_0x4e2dcd(0x204)][_0x4e2dcd(0x1fd)]['update']({'where':{'id':_0xa225d6},'data':{'customerIp':_0x2a0226||undefined,'customerUa':_0x296c46||undefined,'customerCountry':_0x479634||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x4e2dcd(0x1ff)](_0x4e2dcd(0x1c5)+_0xa225d6+':',{'customerIp':_0x2a0226||'not\x20provided','customerUa':_0x296c46?_0x296c46[_0x4e2dcd(0x1dc)](0x0,0x32)+_0x4e2dcd(0x1b8):_0x4e2dcd(0x1f9),'customerCountry':_0x479634||_0x4e2dcd(0x1f9)}),_0x28cc10[_0x4e2dcd(0x1be)]({'success':!![],'message':_0x4e2dcd(0x1f4),'result':_0x358c66});}catch(_0x2f2a57){_0x15344b(_0x2f2a57);}},this[_0x2434e1(0x1b4)]=new paymentService_1[(_0x2434e1(0x20d))](),this[_0x2434e1(0x1ec)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0x2434e1(0x20a))]();}async[a8_0x16d0fd(0x1cf)](_0x420bb9,_0x5bb430,_0xf89cad){const _0x27d7eb=a8_0x16d0fd,_0x5b9244=Date[_0x27d7eb(0x1e2)]();try{const _0x14a07c=_0x420bb9[_0x27d7eb(0x1db)],_0x57c291=_0x14a07c['settings'];if(!_0x57c291?.['webhookUrl']){console[_0x27d7eb(0x1ff)](_0x27d7eb(0x21d)+_0x14a07c['id']);return;}const _0x3ccffc=_0x5bb430===_0x27d7eb(0x1b3)?_0x27d7eb(0x1f1):_0x27d7eb(0x208);let _0x4a6d17=[];if(_0x57c291[_0x27d7eb(0x1f2)])try{_0x4a6d17=Array[_0x27d7eb(0x1d8)](_0x57c291[_0x27d7eb(0x1f2)])?_0x57c291['webhookEvents']:JSON[_0x27d7eb(0x1c4)](_0x57c291[_0x27d7eb(0x1f2)]);}catch(_0x1e17f9){console[_0x27d7eb(0x1c1)](_0x27d7eb(0x1b6),_0x1e17f9),_0x4a6d17=[];}if(!_0x4a6d17[_0x27d7eb(0x1e9)](_0x3ccffc)){console[_0x27d7eb(0x1ff)]('Webhook\x20event\x20'+_0x3ccffc+_0x27d7eb(0x216)+_0x14a07c['id']);return;}const _0x47ba1f={'event':_0x3ccffc,'payment':{'id':_0x420bb9['id'],'order_id':_0x420bb9['orderId'],'gateway_order_id':_0x420bb9[_0x27d7eb(0x1f3)],'gateway':_0x27d7eb(0x1e0),'amount':_0x420bb9[_0x27d7eb(0x201)],'currency':_0x420bb9[_0x27d7eb(0x202)],'status':_0x5bb430[_0x27d7eb(0x212)](),'customer_email':_0x420bb9[_0x27d7eb(0x1b2)],'customer_name':_0x420bb9[_0x27d7eb(0x1f8)],'gateway_payment_id':_0xf89cad,'created_at':_0x420bb9[_0x27d7eb(0x1eb)],'updated_at':new Date()}},_0x439853=await fetch(_0x57c291['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x27d7eb(0x1f0),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x27d7eb(0x1f5)](_0x47ba1f)}),_0x37b82d=Date[_0x27d7eb(0x1e2)]()-_0x5b9244;console[_0x27d7eb(0x1ff)](_0x27d7eb(0x1c9)+_0x57c291['webhookUrl']+_0x27d7eb(0x1af)+_0x439853[_0x27d7eb(0x1cb)]+'\x20('+_0x37b82d+'ms)');}catch(_0x27f56a){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x27f56a);}}async[a8_0x16d0fd(0x217)](_0x2fc978,_0x422078){const _0x2c43c6=a8_0x16d0fd;try{const {telegramBotService:_0x158433}=await Promise[_0x2c43c6(0x1e1)]()[_0x2c43c6(0x1d2)](()=>__importStar(require(_0x2c43c6(0x20e)))),_0x4d1bc3={'PAID':_0x2c43c6(0x209),'FAILED':_0x2c43c6(0x1c6)},_0x4f9071=_0x4d1bc3[_0x422078];if(!_0x4f9071)return;await _0x158433[_0x2c43c6(0x1b5)](_0x2fc978[_0x2c43c6(0x21b)],_0x2fc978,_0x4f9071);}catch(_0x56cab1){console[_0x2c43c6(0x1c1)](_0x2c43c6(0x1df),_0x56cab1);}}}function a8_0x22f7(){const _0x20ddcb=['Payment\x20created\x20successfully','toLowerCase','../services/paymentService','FAILED','successUrl','\x20not\x20enabled\x20for\x20shop\x20','sendPaymentStatusNotification','gateway','8fmhCMH','82910pJpvOk','shopId','updateCustomerData','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','9687013gcoTYP','../config/database','__esModule','failUrl','configurable','system','\x20with\x20status\x20',',\x20cannot\x20process','gatewayPaymentId','customerEmail','PAID','paymentService','sendPaymentNotification','Error\x20parsing\x20webhook\x20events:','Payment\x20processed\x20successfully','...','findUnique','PENDING','mastercard_','gateway_payment_id','params','json','77mAyFrv','308OLyPFQ','error','paymentMethod','62979FwZjhT','parse','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','failed','body','3626268gNjPmJ','MasterCard\x20webhook\x20sent\x20to\x20','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','status','Payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','toISOString','sendShopWebhook','../services/gateways/mastercardService','webhookLog','then','\x20processed:\x20','getPaymentById','prototype','requires_3ds','9147gcFchz','isArray','final','Payment\x20not\x20found','shop','substring','get','failureMessage','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1111','resolve','now','getOwnPropertyDescriptor','mastercard','PaymentController','ðŸ’³\x20MasterCard\x20URLs:','createPublicPayment','processCardPayment','includes','5926535hrFaKg','createdAt','masterCardService','threeds_url','create','hasOwnProperty','application/json','payment.success','webhookEvents','gatewayOrderId','Customer\x20data\x20updated\x20successfully','stringify','length','Payment\x20status\x20is\x20','customerName','not\x20provided','processMasterCardPayment','getOwnPropertyNames','__setModuleDefault','payment','9tiLPFz','log','3DS\x20verification\x20required','amount','currency','update','default','__createBinding','paidAt','âœ…\x20MasterCard\x20payment\x20','payment.failed','paid','WebhookService','2659784tLAHZF','defineProperty','PaymentService','../services/telegramBotService','getPaymentStatus','6hSkKlr'];a8_0x22f7=function(){return _0x20ddcb;};return a8_0x22f7();}exports[a8_0x16d0fd(0x1e5)]=PaymentController;