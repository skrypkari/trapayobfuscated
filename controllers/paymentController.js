'use strict';const a8_0x4bfa2c=a8_0x1b60;(function(_0x5f0e99,_0x2f51a0){const _0x72b5b0=a8_0x1b60,_0x2f288f=_0x5f0e99();while(!![]){try{const _0x1ee67c=parseInt(_0x72b5b0(0x218))/0x1*(-parseInt(_0x72b5b0(0x204))/0x2)+parseInt(_0x72b5b0(0x1f0))/0x3+-parseInt(_0x72b5b0(0x1e3))/0x4*(-parseInt(_0x72b5b0(0x1bb))/0x5)+-parseInt(_0x72b5b0(0x207))/0x6*(parseInt(_0x72b5b0(0x22d))/0x7)+parseInt(_0x72b5b0(0x1b4))/0x8*(-parseInt(_0x72b5b0(0x220))/0x9)+-parseInt(_0x72b5b0(0x210))/0xa+parseInt(_0x72b5b0(0x1e8))/0xb;if(_0x1ee67c===_0x2f51a0)break;else _0x2f288f['push'](_0x2f288f['shift']());}catch(_0x549699){_0x2f288f['push'](_0x2f288f['shift']());}}}(a8_0x2b85,0xe6a64));var __createBinding=this&&this[a8_0x4bfa2c(0x214)]||(Object['create']?function(_0x433d98,_0x4b5512,_0x3c26c9,_0x4f73b4){const _0x325cd1=a8_0x4bfa2c;if(_0x4f73b4===undefined)_0x4f73b4=_0x3c26c9;var _0x5aa850=Object[_0x325cd1(0x1e6)](_0x4b5512,_0x3c26c9);(!_0x5aa850||(_0x325cd1(0x1e5)in _0x5aa850?!_0x4b5512['__esModule']:_0x5aa850[_0x325cd1(0x217)]||_0x5aa850[_0x325cd1(0x1e9)]))&&(_0x5aa850={'enumerable':!![],'get':function(){return _0x4b5512[_0x3c26c9];}}),Object['defineProperty'](_0x433d98,_0x4f73b4,_0x5aa850);}:function(_0x12df2e,_0x27bd4b,_0x1b0f2a,_0x550609){if(_0x550609===undefined)_0x550609=_0x1b0f2a;_0x12df2e[_0x550609]=_0x27bd4b[_0x1b0f2a];}),__setModuleDefault=this&&this[a8_0x4bfa2c(0x229)]||(Object[a8_0x4bfa2c(0x225)]?function(_0x4f48c7,_0x2e641e){const _0x1811cc=a8_0x4bfa2c;Object[_0x1811cc(0x206)](_0x4f48c7,'default',{'enumerable':!![],'value':_0x2e641e});}:function(_0xff316b,_0x50242e){_0xff316b['default']=_0x50242e;}),__importStar=this&&this[a8_0x4bfa2c(0x1c6)]||(function(){var _0x1410d3=function(_0x53c463){return _0x1410d3=Object['getOwnPropertyNames']||function(_0x5a8d6e){const _0x492bb5=a8_0x1b60;var _0x3a7164=[];for(var _0x56d0f0 in _0x5a8d6e)if(Object[_0x492bb5(0x21e)][_0x492bb5(0x1c1)][_0x492bb5(0x1d9)](_0x5a8d6e,_0x56d0f0))_0x3a7164[_0x3a7164[_0x492bb5(0x208)]]=_0x56d0f0;return _0x3a7164;},_0x1410d3(_0x53c463);};return function(_0x3d2307){const _0xda7823=a8_0x1b60;if(_0x3d2307&&_0x3d2307[_0xda7823(0x226)])return _0x3d2307;var _0x37024d={};if(_0x3d2307!=null){for(var _0x5444fb=_0x1410d3(_0x3d2307),_0x432b1c=0x0;_0x432b1c<_0x5444fb[_0xda7823(0x208)];_0x432b1c++)if(_0x5444fb[_0x432b1c]!==_0xda7823(0x1d8))__createBinding(_0x37024d,_0x3d2307,_0x5444fb[_0x432b1c]);}return __setModuleDefault(_0x37024d,_0x3d2307),_0x37024d;};}()),__importDefault=this&&this[a8_0x4bfa2c(0x1f2)]||function(_0x6c1f1d){return _0x6c1f1d&&_0x6c1f1d['__esModule']?_0x6c1f1d:{'default':_0x6c1f1d};};Object[a8_0x4bfa2c(0x206)](exports,a8_0x4bfa2c(0x226),{'value':!![]}),exports[a8_0x4bfa2c(0x1ba)]=void 0x0;function a8_0x2b85(){const _0x4695a0=['failed','amount','getPaymentById','__createBinding','last_name','body','writable','1wQqKul','handleSuccessfulPayment','customerCountry','settings','💳\x20Processing\x20MasterCard\x20payment:\x20','isArray','prototype','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','6613029ouviOq','threeds_url','updatedAt','../services/gateways/mastercardService','currency','create','__esModule','slice','application/json','__setModuleDefault','json','stringify','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','17808RtILPF','update','number','sendShopWebhook','8kLVSRD','PAID','masterCardService','Card\x20payment\x20failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','Payment\x20created\x20successfully','PaymentController','13945tNMVMF','\x20with\x20status\x20','log','payment.success','webhookUrl','✅\x20MasterCard\x20payment\x20','hasOwnProperty','requires_3ds','customerUa','paymentService','params','__importStar','email','../services/paymentLinkService','first_name','💳\x20Browser\x20IP:\x20','webhookEvents','updatePaymentCustomer','createdAt','gatewayPaymentId','../config/database','MasterCard\x20webhook\x20sent\x20to\x20','Customer\x20data\x20updated\x20successfully','status','💳\x20MasterCard\x20URLs:','shopId','sendPaymentStatusNotification','findUnique','\x20\x20\x20Result\x20URL\x20(webhook):\x20','default','call','💳\x20MasterCard\x20result:','../services/paymentService','MasterCardService','parse','ms)','payment.failed','error','mastercard_','successUrl','44QPxgmd','getPaymentStatus','get','getOwnPropertyDescriptor','\x20\x20\x20Return\x20URL:\x20','41965396hlbJyW','configurable','gateway','failUrl','now','toLowerCase','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','paid','4394451gPOWIS','createPublicPayment','__importDefault','replace','Error\x20parsing\x20webhook\x20events:','\x20processed:\x20','then','📈\x20MasterCard\x20payment\x20','POST','includes','📝\x20Customer\x20data:','PaymentService','customerName','paymentMethod','Payment\x20not\x20found','1111','PENDING','3DS\x20verification\x20required','gateway_payment_id','mastercard','867262ZpYaxY','customerEmail','defineProperty','3426qeUhzV','length','https://api.trapay.uk/api/webhooks/gateway/mastercard','updatePaymentCustomerDataPublic','paidAt','resolve','payment','gatewayOrderId','FAILED','17447560NdxEqz'];a8_0x2b85=function(){return _0x4695a0;};return a8_0x2b85();}const paymentService_1=require(a8_0x4bfa2c(0x1db)),mastercardService_1=require(a8_0x4bfa2c(0x223)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x4bfa2c(0x1cf)));class PaymentController{constructor(){const _0x548298=a8_0x4bfa2c;this[_0x548298(0x1f1)]=async(_0x5a40bf,_0x3dbba2,_0x245cfe)=>{const _0x52c2a9=_0x548298;try{const _0x5680eb=_0x5a40bf[_0x52c2a9(0x216)],_0x3a4068=await this['paymentService'][_0x52c2a9(0x1f1)](_0x5680eb);_0x3dbba2['status'](0xc9)[_0x52c2a9(0x22a)]({'success':!![],'message':_0x52c2a9(0x1b9),'result':_0x3a4068});}catch(_0x1c5c81){_0x245cfe(_0x1c5c81);}},this[_0x548298(0x1e4)]=async(_0x5360a5,_0x1965ce,_0x42c940)=>{const _0x4c2513=_0x548298;try{const {id:_0x15cabe}=_0x5360a5['params'],_0x3fabae=await this[_0x4c2513(0x1c4)][_0x4c2513(0x1e4)](_0x15cabe);if(!_0x3fabae)return _0x1965ce[_0x4c2513(0x1d2)](0x194)['json']({'success':![],'message':_0x4c2513(0x1fe)});_0x1965ce[_0x4c2513(0x22a)]({'success':!![],'result':_0x3fabae});}catch(_0x3dbfb8){_0x42c940(_0x3dbfb8);}},this[_0x548298(0x213)]=async(_0x563e5f,_0x176bff,_0x101490)=>{const _0x4d45f1=_0x548298;try{const {id:_0x245558}=_0x563e5f['params'],_0x430f98=await this[_0x4d45f1(0x1c4)][_0x4d45f1(0x213)](_0x245558);if(!_0x430f98)return _0x176bff[_0x4d45f1(0x1d2)](0x194)[_0x4d45f1(0x22a)]({'success':![],'message':_0x4d45f1(0x1fe)});_0x176bff[_0x4d45f1(0x22a)]({'success':!![],'result':_0x430f98});}catch(_0xf9815b){_0x101490(_0xf9815b);}},this[_0x548298(0x1cc)]=async(_0x2d86c3,_0x58c9e2,_0x2eeaf2)=>{const _0x474544=_0x548298;try{const {id:_0x22dcc5}=_0x2d86c3[_0x474544(0x1c5)],_0x146459=_0x2d86c3[_0x474544(0x216)];console[_0x474544(0x1bd)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x22dcc5),console[_0x474544(0x1bd)](_0x474544(0x1fa),_0x146459);const _0x1a6806=await this[_0x474544(0x1c4)][_0x474544(0x20a)](_0x22dcc5,_0x146459);if(!_0x1a6806)return _0x58c9e2[_0x474544(0x1d2)](0x194)[_0x474544(0x22a)]({'success':![],'message':_0x474544(0x1fe)});_0x58c9e2[_0x474544(0x22a)]({'success':!![],'message':_0x474544(0x1d1),'result':{'paymentId':_0x1a6806['id'],'customerIp':_0x1a6806['customerIp'],'customerUa':_0x1a6806[_0x474544(0x1c3)],'customerCountry':_0x1a6806[_0x474544(0x21a)],'updatedAt':_0x1a6806[_0x474544(0x222)]}});}catch(_0x311596){_0x2eeaf2(_0x311596);}},this['processMasterCardPayment']=async(_0xb6b39c,_0x4250fc,_0x1356d8)=>{const _0x46a360=_0x548298;try{const {id:_0x5f084a}=_0xb6b39c[_0x46a360(0x1c5)],{cardData:_0x3965bb,cardHolder:_0x1127f6,browser:_0x330cea}=_0xb6b39c[_0x46a360(0x216)];console[_0x46a360(0x1bd)](_0x46a360(0x21c)+_0x5f084a),console[_0x46a360(0x1bd)]('💳\x20Card\x20holder:\x20'+_0x1127f6[_0x46a360(0x1c9)]+'\x20'+_0x1127f6['last_name']+'\x20('+_0x1127f6[_0x46a360(0x1c7)]+')'),console[_0x46a360(0x1bd)](_0x46a360(0x1ca)+_0x330cea['ip']);const _0xac54b7={'customerName':_0x1127f6['first_name']+'\x20'+_0x1127f6[_0x46a360(0x215)],'customerEmail':_0x1127f6['email'],'customerIp':_0x330cea['ip'],'customerUa':_0x330cea['user_agent'],'customerCountry':_0x1127f6['country']||null},_0x4abd3c=await database_1[_0x46a360(0x1d8)][_0x46a360(0x20d)][_0x46a360(0x1d6)]({'where':{'id':_0x5f084a},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4abd3c)return _0x4250fc[_0x46a360(0x1d2)](0x194)[_0x46a360(0x22a)]({'success':![],'message':_0x46a360(0x1fe)});if(_0x4abd3c[_0x46a360(0x1ea)]!==_0x46a360(0x203))return _0x4250fc['status'](0x190)[_0x46a360(0x22a)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x4abd3c[_0x46a360(0x1d2)]!=='PENDING')return _0x4250fc[_0x46a360(0x1d2)](0x190)[_0x46a360(0x22a)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x4abd3c['status']+',\x20cannot\x20process'});await database_1['default'][_0x46a360(0x20d)][_0x46a360(0x22e)]({'where':{'id':_0x5f084a},'data':{..._0xac54b7,'updatedAt':new Date()}});const _0x33263b=_0x46a360(0x209),_0x256333=_0x4abd3c[_0x46a360(0x1e2)];console[_0x46a360(0x1bd)](_0x46a360(0x1d3)),console[_0x46a360(0x1bd)](_0x46a360(0x1d7)+_0x33263b),console['log'](_0x46a360(0x1e7)+_0x256333);const _0x42a807={'first_name':_0x1127f6[_0x46a360(0x1c9)],'last_name':_0x1127f6['last_name'],'email':_0x1127f6['email']},_0x45eca3=await this['masterCardService']['processCardPayment']({'paymentId':_0x4abd3c['id'],'orderId':_0x4abd3c[_0x46a360(0x20e)]||_0x4abd3c['id'],'amount':_0x4abd3c['amount'],'currency':_0x4abd3c[_0x46a360(0x224)],'cardData':_0x3965bb,'resultUrl':_0x33263b,'returnUrl':_0x256333,'cardHolder':_0x42a807,'browser':_0x330cea});console['log'](_0x46a360(0x1da),_0x45eca3);const _0x19522a={'status':_0x45eca3['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x45eca3['status']===_0x46a360(0x1b5))_0x19522a[_0x46a360(0x20b)]=new Date(),_0x19522a[_0x46a360(0x1ce)]=_0x45eca3[_0x46a360(0x202)];else _0x45eca3['status']===_0x46a360(0x20f)&&(_0x19522a['failureMessage']=_0x46a360(0x1b7));_0x19522a[_0x46a360(0x1fd)]=_0x46a360(0x203);if(_0x3965bb[_0x46a360(0x22f)]){const _0x244fff=_0x3965bb[_0x46a360(0x22f)][_0x46a360(0x1f3)](/[\s-]/g,'');_0x19522a['cardLast4']=_0x244fff[_0x46a360(0x227)](-0x4),console[_0x46a360(0x1bd)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x19522a['cardLast4']);}await database_1['default'][_0x46a360(0x20d)]['update']({'where':{'id':_0x4abd3c['id']},'data':_0x19522a}),await database_1[_0x46a360(0x1d8)]['webhookLog']['create']({'data':{'paymentId':_0x4abd3c['id'],'shopId':_0x4abd3c['shopId'],'event':_0x46a360(0x1e1)+_0x45eca3[_0x46a360(0x1d2)]?.[_0x46a360(0x1ed)](),'statusCode':0xc8,'responseBody':JSON[_0x46a360(0x22b)]({'oldStatus':'PENDING','newStatus':_0x45eca3[_0x46a360(0x1d2)],'gatewayPaymentId':_0x45eca3['gateway_payment_id'],'requires3ds':_0x45eca3[_0x46a360(0x1c2)],'processedAt':new Date()['toISOString']()})}});if(_0x45eca3['final']){await this[_0x46a360(0x230)](_0x4abd3c,_0x45eca3[_0x46a360(0x1d2)],_0x45eca3['gateway_payment_id']),await this[_0x46a360(0x1d5)](_0x4abd3c,_0x45eca3['status']);if(_0x45eca3[_0x46a360(0x1d2)]===_0x46a360(0x1b5)){console[_0x46a360(0x1bd)](_0x46a360(0x1f7)+_0x5f084a+_0x46a360(0x21f));try{const {PaymentLinkService:_0x5cb628}=await Promise['resolve']()[_0x46a360(0x1f6)](()=>__importStar(require(_0x46a360(0x1c8)))),_0x2bf20f=new _0x5cb628();await _0x2bf20f[_0x46a360(0x219)](_0x5f084a),console[_0x46a360(0x1bd)](_0x46a360(0x22c)+_0x5f084a);}catch(_0x16659d){console[_0x46a360(0x1e0)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x16659d);}}}console['log'](_0x46a360(0x1c0)+_0x5f084a+_0x46a360(0x1f5)+_0x45eca3['status']);if(_0x45eca3[_0x46a360(0x1d2)]===_0x46a360(0x1b5))_0x4250fc[_0x46a360(0x22a)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x46a360(0x1b5),'gatewayPaymentId':_0x45eca3[_0x46a360(0x202)],'redirectUrl':_0x256333,'final':!![]}});else _0x45eca3[_0x46a360(0x1c2)]&&_0x45eca3[_0x46a360(0x221)]?_0x4250fc['json']({'success':!![],'message':_0x46a360(0x201),'result':{'status':_0x46a360(0x200),'gatewayPaymentId':_0x45eca3[_0x46a360(0x202)],'redirectUrl':_0x45eca3[_0x46a360(0x221)],'requires3ds':!![],'final':![]}}):_0x4250fc[_0x46a360(0x1d2)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x46a360(0x20f),'gatewayPaymentId':_0x45eca3['gateway_payment_id'],'redirectUrl':_0x4abd3c[_0x46a360(0x1eb)],'final':!![]}});}catch(_0x7be7bc){_0x1356d8(_0x7be7bc);}},this[_0x548298(0x1c4)]=new paymentService_1[(_0x548298(0x1fb))](),this[_0x548298(0x1b6)]=new mastercardService_1[(_0x548298(0x1dc))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x4bfa2c(0x230)](_0x5188fe,_0x18f0e1,_0x5d3981){const _0x315179=a8_0x4bfa2c,_0x2150ed=Date[_0x315179(0x1ec)]();try{const _0x2904a9=_0x5188fe['shop'],_0x2c68d4=_0x2904a9[_0x315179(0x21b)];if(!_0x2c68d4?.[_0x315179(0x1bf)]){console[_0x315179(0x1bd)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2904a9['id']);return;}const _0x1cac30=_0x18f0e1===_0x315179(0x1b5)?_0x315179(0x1be):_0x315179(0x1df);let _0x1cc5c2=[];if(_0x2c68d4[_0x315179(0x1cb)])try{_0x1cc5c2=Array[_0x315179(0x21d)](_0x2c68d4['webhookEvents'])?_0x2c68d4[_0x315179(0x1cb)]:JSON[_0x315179(0x1dd)](_0x2c68d4[_0x315179(0x1cb)]);}catch(_0x4744a4){console[_0x315179(0x1e0)](_0x315179(0x1f4),_0x4744a4),_0x1cc5c2=[];}if(!_0x1cc5c2[_0x315179(0x1f9)](_0x1cac30)){console[_0x315179(0x1bd)]('Webhook\x20event\x20'+_0x1cac30+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2904a9['id']);return;}const _0x19c329={'event':_0x1cac30,'payment':{'id':_0x5188fe['id'],'order_id':_0x5188fe['orderId'],'gateway_order_id':_0x5188fe['gatewayOrderId'],'gateway':_0x315179(0x1ff),'amount':_0x5188fe[_0x315179(0x212)],'currency':_0x5188fe[_0x315179(0x224)],'status':_0x18f0e1[_0x315179(0x1ed)](),'customer_email':_0x5188fe[_0x315179(0x205)],'customer_name':_0x5188fe[_0x315179(0x1fc)],'gateway_payment_id':_0x5d3981,'created_at':_0x5188fe[_0x315179(0x1cd)],'updated_at':new Date()}},_0x18a675=await fetch(_0x2c68d4['webhookUrl'],{'method':_0x315179(0x1f8),'headers':{'Content-Type':_0x315179(0x228),'User-Agent':_0x315179(0x1ee)},'body':JSON['stringify'](_0x19c329)}),_0x3e277c=Date[_0x315179(0x1ec)]()-_0x2150ed;console[_0x315179(0x1bd)](_0x315179(0x1d0)+_0x2c68d4[_0x315179(0x1bf)]+_0x315179(0x1bc)+_0x18a675['status']+'\x20('+_0x3e277c+_0x315179(0x1de));}catch(_0x370c84){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x370c84);}}async[a8_0x4bfa2c(0x1d5)](_0x56c981,_0xbeeced){const _0x52efeb=a8_0x4bfa2c;try{const {telegramBotService:_0xfb8dfe}=await Promise[_0x52efeb(0x20c)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x18304a={'PAID':_0x52efeb(0x1ef),'FAILED':_0x52efeb(0x211)},_0x2e90eb=_0x18304a[_0xbeeced];if(!_0x2e90eb)return;await _0xfb8dfe['sendPaymentNotification'](_0x56c981[_0x52efeb(0x1d4)],_0x56c981,_0x2e90eb);}catch(_0xea5078){console[_0x52efeb(0x1e0)](_0x52efeb(0x1b8),_0xea5078);}}}function a8_0x1b60(_0x28f3ab,_0x3f7fd5){const _0x2b858f=a8_0x2b85();return a8_0x1b60=function(_0x1b6054,_0x4b76d3){_0x1b6054=_0x1b6054-0x1b4;let _0x1cb81e=_0x2b858f[_0x1b6054];return _0x1cb81e;},a8_0x1b60(_0x28f3ab,_0x3f7fd5);}exports[a8_0x4bfa2c(0x1ba)]=PaymentController;