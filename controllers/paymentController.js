'use strict';const a8_0x159c92=a8_0x3414;(function(_0xf3fc91,_0x462bb1){const _0x2ad628=a8_0x3414,_0x3c90b5=_0xf3fc91();while(!![]){try{const _0x14e6fc=parseInt(_0x2ad628(0x1d1))/0x1*(-parseInt(_0x2ad628(0x1e2))/0x2)+-parseInt(_0x2ad628(0x206))/0x3*(parseInt(_0x2ad628(0x21e))/0x4)+parseInt(_0x2ad628(0x1b3))/0x5+parseInt(_0x2ad628(0x222))/0x6+parseInt(_0x2ad628(0x1d4))/0x7+-parseInt(_0x2ad628(0x1d2))/0x8+-parseInt(_0x2ad628(0x1f5))/0x9;if(_0x14e6fc===_0x462bb1)break;else _0x3c90b5['push'](_0x3c90b5['shift']());}catch(_0x1fe803){_0x3c90b5['push'](_0x3c90b5['shift']());}}}(a8_0x40de,0x8d3c6));var __createBinding=this&&this['__createBinding']||(Object[a8_0x159c92(0x1eb)]?function(_0x551b90,_0x2e3107,_0x449bc3,_0x866bf6){const _0x3303ef=a8_0x159c92;if(_0x866bf6===undefined)_0x866bf6=_0x449bc3;var _0x3a8b0f=Object[_0x3303ef(0x1ac)](_0x2e3107,_0x449bc3);(!_0x3a8b0f||(_0x3303ef(0x20d)in _0x3a8b0f?!_0x2e3107[_0x3303ef(0x1d6)]:_0x3a8b0f['writable']||_0x3a8b0f['configurable']))&&(_0x3a8b0f={'enumerable':!![],'get':function(){return _0x2e3107[_0x449bc3];}}),Object[_0x3303ef(0x211)](_0x551b90,_0x866bf6,_0x3a8b0f);}:function(_0x1d14a8,_0x2e4f3a,_0x9dd770,_0x23b422){if(_0x23b422===undefined)_0x23b422=_0x9dd770;_0x1d14a8[_0x23b422]=_0x2e4f3a[_0x9dd770];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x159c92(0x1eb)]?function(_0x4f0347,_0x5c599e){Object['defineProperty'](_0x4f0347,'default',{'enumerable':!![],'value':_0x5c599e});}:function(_0x9e3259,_0x3607a0){const _0x4b4aa0=a8_0x159c92;_0x9e3259[_0x4b4aa0(0x208)]=_0x3607a0;}),__importStar=this&&this[a8_0x159c92(0x1b4)]||(function(){var _0x2d5f06=function(_0x3df29e){const _0x3ff280=a8_0x3414;return _0x2d5f06=Object[_0x3ff280(0x1fd)]||function(_0x1cfa52){const _0x317b3f=_0x3ff280;var _0x221a61=[];for(var _0x5f5ad in _0x1cfa52)if(Object['prototype']['hasOwnProperty'][_0x317b3f(0x1ef)](_0x1cfa52,_0x5f5ad))_0x221a61[_0x221a61['length']]=_0x5f5ad;return _0x221a61;},_0x2d5f06(_0x3df29e);};return function(_0x3ecf17){const _0x556add=a8_0x3414;if(_0x3ecf17&&_0x3ecf17[_0x556add(0x1d6)])return _0x3ecf17;var _0x30090f={};if(_0x3ecf17!=null){for(var _0x4754e9=_0x2d5f06(_0x3ecf17),_0x19c23c=0x0;_0x19c23c<_0x4754e9[_0x556add(0x224)];_0x19c23c++)if(_0x4754e9[_0x19c23c]!==_0x556add(0x208))__createBinding(_0x30090f,_0x3ecf17,_0x4754e9[_0x19c23c]);}return __setModuleDefault(_0x30090f,_0x3ecf17),_0x30090f;};}()),__importDefault=this&&this[a8_0x159c92(0x1d0)]||function(_0xb70727){const _0x4b6055=a8_0x159c92;return _0xb70727&&_0xb70727[_0x4b6055(0x1d6)]?_0xb70727:{'default':_0xb70727};};Object[a8_0x159c92(0x211)](exports,a8_0x159c92(0x1d6),{'value':!![]}),exports[a8_0x159c92(0x205)]=void 0x0;function a8_0x40de(){const _0x754a6d=['webhookEvents','\x20processed:\x20','threeds_url','update','failureMessage','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','application/json','create','../services/paymentService','Customer\x20data\x20updated\x20successfully','email','call','failUrl','💳\x20Browser\x20IP:\x20','📝\x20Customer\x20data:','📈\x20MasterCard\x20payment\x20','💳\x20Card\x20holder:\x20','3567753yaKuLV','masterCardService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','successUrl','updatePaymentCustomer','mastercard','error','orderId','getOwnPropertyNames','Error\x20parsing\x20webhook\x20events:','../services/paymentLinkService','now','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','createdAt','customerEmail','body','PaymentController','3RXBPNO','last_name','default','paid','💳\x20Processing\x20MasterCard\x20payment:\x20','settings','json','get','payment','requires_3ds','amount','defineProperty','sendPaymentNotification','handleSuccessfulPayment','then','PaymentService','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','💳\x20MasterCard\x20result:','findUnique','💳\x20MasterCard\x20URLs:','gateway','log','3DS\x20verification\x20required','PENDING','1514216IytSgI','customerName','Payment\x20status\x20is\x20','payment.failed','6451578LxGpim','currency','length','Failed\x20to\x20send\x20MasterCard\x20webhook:','WebhookService',',\x20cannot\x20process','sendPaymentStatusNotification','sendShopWebhook','status','cardLast4','customerCountry','Webhook\x20event\x20','webhookUrl','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','number','webhookLog','failed','getOwnPropertyDescriptor','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','shopId','MasterCardService','getPaymentStatus','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','replace','4409750lWPkCS','__importStar','stringify','parse','includes','\x20\x20\x20Return\x20URL:\x20','toLowerCase','Payment\x20not\x20found','../services/telegramBotService','final','FAILED','../config/database','resolve','slice','gateway_payment_id','\x20with\x20status\x20','paymentMethod','updatePaymentCustomerDataPublic','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','Payment\x20created\x20successfully','PAID','mastercard_','paymentService','createPublicPayment','MasterCard\x20webhook\x20sent\x20to\x20','params','getPaymentById','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','../services/webhookService','__importDefault','1LWyIie','5154504EsekeL','\x20\x20\x20Result\x20URL\x20(webhook):\x20','2157764npRUyF','toISOString','__esModule','processMasterCardPayment','system','gatewayOrderId','paidAt','../services/gateways/mastercardService','https://api.trapay.uk/api/webhooks/gateway/mastercard','1111','processCardPayment','Card\x20payment\x20failed','first_name','\x20not\x20enabled\x20for\x20shop\x20','535358cWjWuM','shop'];a8_0x40de=function(){return _0x754a6d;};return a8_0x40de();}const paymentService_1=require(a8_0x159c92(0x1ec)),mastercardService_1=require(a8_0x159c92(0x1db)),webhookService_1=require(a8_0x159c92(0x1cf)),database_1=__importDefault(require(a8_0x159c92(0x1be)));function a8_0x3414(_0x4775cd,_0x52a188){const _0x40de44=a8_0x40de();return a8_0x3414=function(_0x3414f3,_0x44569f){_0x3414f3=_0x3414f3-0x1a4;let _0x52abe1=_0x40de44[_0x3414f3];return _0x52abe1;},a8_0x3414(_0x4775cd,_0x52a188);}class PaymentController{constructor(){const _0x238f36=a8_0x159c92;this['createPublicPayment']=async(_0x4810f6,_0x30b961,_0x56baf6)=>{const _0x4eef82=a8_0x3414;try{const _0x209bea=_0x4810f6[_0x4eef82(0x204)],_0x18d6cd=await this['paymentService'][_0x4eef82(0x1ca)](_0x209bea);_0x30b961[_0x4eef82(0x22a)](0xc9)[_0x4eef82(0x20c)]({'success':!![],'message':_0x4eef82(0x1c6),'result':_0x18d6cd});}catch(_0x3c40e7){_0x56baf6(_0x3c40e7);}},this[_0x238f36(0x1b0)]=async(_0x28f2a7,_0x4fab24,_0x304a52)=>{const _0x14624d=_0x238f36;try{const {id:_0x1a16b2}=_0x28f2a7[_0x14624d(0x1cc)],_0x256f80=await this['paymentService'][_0x14624d(0x1b0)](_0x1a16b2);if(!_0x256f80)return _0x4fab24[_0x14624d(0x22a)](0x194)[_0x14624d(0x20c)]({'success':![],'message':_0x14624d(0x1ba)});_0x4fab24['json']({'success':!![],'result':_0x256f80});}catch(_0x5c8e7a){_0x304a52(_0x5c8e7a);}},this[_0x238f36(0x1cd)]=async(_0x35d485,_0x2907bb,_0x3bb764)=>{const _0x23fbb9=_0x238f36;try{const {id:_0x30ca5c}=_0x35d485[_0x23fbb9(0x1cc)],_0x3cea63=await this[_0x23fbb9(0x1c9)]['getPaymentById'](_0x30ca5c);if(!_0x3cea63)return _0x2907bb[_0x23fbb9(0x22a)](0x194)[_0x23fbb9(0x20c)]({'success':![],'message':'Payment\x20not\x20found'});_0x2907bb[_0x23fbb9(0x20c)]({'success':!![],'result':_0x3cea63});}catch(_0x4baa9d){_0x3bb764(_0x4baa9d);}},this[_0x238f36(0x1f9)]=async(_0x185784,_0x5c1bb2,_0x155874)=>{const _0x4ffd39=_0x238f36;try{const {id:_0x1ffd7e}=_0x185784[_0x4ffd39(0x1cc)],_0x1b8cac=_0x185784[_0x4ffd39(0x204)];console[_0x4ffd39(0x21b)](_0x4ffd39(0x216)+_0x1ffd7e),console[_0x4ffd39(0x21b)](_0x4ffd39(0x1f2),_0x1b8cac);const _0x13080c=await this[_0x4ffd39(0x1c9)][_0x4ffd39(0x1c4)](_0x1ffd7e,_0x1b8cac);if(!_0x13080c)return _0x5c1bb2['status'](0x194)[_0x4ffd39(0x20c)]({'success':![],'message':_0x4ffd39(0x1ba)});_0x5c1bb2['json']({'success':!![],'message':_0x4ffd39(0x1ed),'result':{'paymentId':_0x13080c['id'],'customerIp':_0x13080c['customerIp'],'customerUa':_0x13080c['customerUa'],'customerCountry':_0x13080c[_0x4ffd39(0x1a5)],'updatedAt':_0x13080c['updatedAt']}});}catch(_0x2f360b){_0x155874(_0x2f360b);}},this[_0x238f36(0x1d7)]=async(_0x432b28,_0xfe5d56,_0xef3ffc)=>{const _0x194d69=_0x238f36;try{const {id:_0x595b3c}=_0x432b28[_0x194d69(0x1cc)],{cardData:_0x52fa9e,cardHolder:_0x333acc,browser:_0x14479e}=_0x432b28['body'];console['log'](_0x194d69(0x20a)+_0x595b3c),console[_0x194d69(0x21b)](_0x194d69(0x1f4)+_0x333acc['first_name']+'\x20'+_0x333acc[_0x194d69(0x207)]+'\x20('+_0x333acc[_0x194d69(0x1ee)]+')'),console[_0x194d69(0x21b)](_0x194d69(0x1f1)+_0x14479e['ip']);const _0xb61c90={'customerName':_0x333acc[_0x194d69(0x1e0)]+'\x20'+_0x333acc[_0x194d69(0x207)],'customerEmail':_0x333acc['email'],'customerIp':_0x14479e['ip'],'customerUa':_0x14479e['user_agent']},_0x344ffc=await database_1[_0x194d69(0x208)][_0x194d69(0x20e)][_0x194d69(0x218)]({'where':{'id':_0x595b3c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x344ffc)return _0xfe5d56[_0x194d69(0x22a)](0x194)[_0x194d69(0x20c)]({'success':![],'message':_0x194d69(0x1ba)});if(_0x344ffc[_0x194d69(0x21a)]!==_0x194d69(0x1fa))return _0xfe5d56[_0x194d69(0x22a)](0x190)['json']({'success':![],'message':_0x194d69(0x1e9)});if(_0x344ffc[_0x194d69(0x22a)]!==_0x194d69(0x21d))return _0xfe5d56['status'](0x190)[_0x194d69(0x20c)]({'success':![],'message':_0x194d69(0x220)+_0x344ffc[_0x194d69(0x22a)]+_0x194d69(0x227)});await database_1['default'][_0x194d69(0x20e)][_0x194d69(0x1e7)]({'where':{'id':_0x595b3c},'data':{..._0xb61c90,'updatedAt':new Date()}});const _0x2ae3e4=_0x194d69(0x1dc),_0x3de5e0=_0x344ffc[_0x194d69(0x1f8)];console['log'](_0x194d69(0x219)),console[_0x194d69(0x21b)](_0x194d69(0x1d3)+_0x2ae3e4),console[_0x194d69(0x21b)](_0x194d69(0x1b8)+_0x3de5e0);const _0x1301c0={'first_name':_0x333acc[_0x194d69(0x1e0)],'last_name':_0x333acc[_0x194d69(0x207)],'email':_0x333acc[_0x194d69(0x1ee)]},_0x3e919c=await this[_0x194d69(0x1f6)][_0x194d69(0x1de)]({'paymentId':_0x344ffc['id'],'orderId':_0x344ffc[_0x194d69(0x1d9)]||_0x344ffc['id'],'amount':_0x344ffc[_0x194d69(0x210)],'currency':_0x344ffc['currency'],'cardData':_0x52fa9e,'resultUrl':_0x2ae3e4,'returnUrl':_0x3de5e0,'cardHolder':_0x1301c0,'browser':_0x14479e});console[_0x194d69(0x21b)](_0x194d69(0x217),_0x3e919c);const _0x27416c={'status':_0x3e919c[_0x194d69(0x22a)],'updatedAt':new Date(),'statusChangedBy':_0x194d69(0x1d8),'statusChangedAt':new Date()};_0x3e919c[_0x194d69(0x1c1)]&&(_0x27416c['gatewayPaymentId']=_0x3e919c[_0x194d69(0x1c1)],console[_0x194d69(0x21b)](_0x194d69(0x1c5)+_0x3e919c[_0x194d69(0x1c1)]));if(_0x3e919c[_0x194d69(0x22a)]===_0x194d69(0x1c7))_0x27416c[_0x194d69(0x1da)]=new Date();else _0x3e919c['status']===_0x194d69(0x1bd)&&(_0x27416c[_0x194d69(0x1e8)]=_0x194d69(0x1df));_0x27416c[_0x194d69(0x1c3)]='mastercard';if(_0x52fa9e[_0x194d69(0x1a9)]){const _0x5e18ca=_0x52fa9e[_0x194d69(0x1a9)][_0x194d69(0x1b2)](/[\s-]/g,'');_0x27416c[_0x194d69(0x1a4)]=_0x5e18ca[_0x194d69(0x1c0)](-0x4),console[_0x194d69(0x21b)](_0x194d69(0x1ce)+_0x27416c[_0x194d69(0x1a4)]);}await database_1[_0x194d69(0x208)][_0x194d69(0x20e)][_0x194d69(0x1e7)]({'where':{'id':_0x344ffc['id']},'data':_0x27416c}),await database_1[_0x194d69(0x208)][_0x194d69(0x1aa)][_0x194d69(0x1eb)]({'data':{'paymentId':_0x344ffc['id'],'shopId':_0x344ffc['shopId'],'event':_0x194d69(0x1c8)+_0x3e919c[_0x194d69(0x22a)]?.[_0x194d69(0x1b9)](),'statusCode':0xc8,'responseBody':JSON[_0x194d69(0x1b5)]({'oldStatus':_0x194d69(0x21d),'newStatus':_0x3e919c[_0x194d69(0x22a)],'gatewayPaymentId':_0x3e919c[_0x194d69(0x1c1)],'requires3ds':_0x3e919c[_0x194d69(0x20f)],'processedAt':new Date()[_0x194d69(0x1d5)]()})}});if(_0x3e919c[_0x194d69(0x1bc)]){await this[_0x194d69(0x229)](_0x344ffc,_0x3e919c[_0x194d69(0x22a)],_0x3e919c[_0x194d69(0x1c1)]),await this[_0x194d69(0x228)](_0x344ffc,_0x3e919c['status']);if(_0x3e919c['status']===_0x194d69(0x1c7)){console[_0x194d69(0x21b)](_0x194d69(0x1f3)+_0x595b3c+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x1066fc}=await Promise[_0x194d69(0x1bf)]()[_0x194d69(0x214)](()=>__importStar(require(_0x194d69(0x1ff)))),_0x257203=new _0x1066fc();await _0x257203[_0x194d69(0x213)](_0x595b3c),console[_0x194d69(0x21b)](_0x194d69(0x201)+_0x595b3c);}catch(_0x5c10c9){console['error'](_0x194d69(0x1a8),_0x5c10c9);}}}console[_0x194d69(0x21b)]('✅\x20MasterCard\x20payment\x20'+_0x595b3c+_0x194d69(0x1e5)+_0x3e919c[_0x194d69(0x22a)]);if(_0x3e919c[_0x194d69(0x22a)]===_0x194d69(0x1c7))_0xfe5d56[_0x194d69(0x20c)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x194d69(0x1c7),'gatewayPaymentId':_0x3e919c['gateway_payment_id'],'redirectUrl':_0x3de5e0,'final':!![]}});else _0x3e919c[_0x194d69(0x20f)]&&_0x3e919c[_0x194d69(0x1e6)]?_0xfe5d56[_0x194d69(0x20c)]({'success':!![],'message':_0x194d69(0x21c),'result':{'status':_0x194d69(0x21d),'gatewayPaymentId':_0x3e919c[_0x194d69(0x1c1)],'redirectUrl':_0x3e919c[_0x194d69(0x1e6)],'requires3ds':!![],'final':![]}}):_0xfe5d56[_0x194d69(0x22a)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x3e919c['gateway_payment_id'],'redirectUrl':_0x344ffc[_0x194d69(0x1f0)],'final':!![]}});}catch(_0x3b05c8){_0xef3ffc(_0x3b05c8);}},this[_0x238f36(0x1c9)]=new paymentService_1[(_0x238f36(0x215))](),this[_0x238f36(0x1f6)]=new mastercardService_1[(_0x238f36(0x1af))](),this['webhookService']=new webhookService_1[(_0x238f36(0x226))]();}async[a8_0x159c92(0x229)](_0x5b0fb6,_0x2c250d,_0x38f4fa){const _0x2ef0d5=a8_0x159c92,_0x1b2df3=Date['now']();try{const _0x353ff3=_0x5b0fb6[_0x2ef0d5(0x1e3)],_0x10b4bc=_0x353ff3[_0x2ef0d5(0x20b)];if(!_0x10b4bc?.['webhookUrl']){console[_0x2ef0d5(0x21b)](_0x2ef0d5(0x1f7)+_0x353ff3['id']);return;}const _0x366f9a=_0x2c250d===_0x2ef0d5(0x1c7)?'payment.success':_0x2ef0d5(0x221);let _0x1c2514=[];if(_0x10b4bc[_0x2ef0d5(0x1e4)])try{_0x1c2514=Array['isArray'](_0x10b4bc['webhookEvents'])?_0x10b4bc[_0x2ef0d5(0x1e4)]:JSON[_0x2ef0d5(0x1b6)](_0x10b4bc[_0x2ef0d5(0x1e4)]);}catch(_0x4230e9){console[_0x2ef0d5(0x1fb)](_0x2ef0d5(0x1fe),_0x4230e9),_0x1c2514=[];}if(!_0x1c2514[_0x2ef0d5(0x1b7)](_0x366f9a)){console[_0x2ef0d5(0x21b)](_0x2ef0d5(0x1a6)+_0x366f9a+_0x2ef0d5(0x1e1)+_0x353ff3['id']);return;}const _0x1991aa={'event':_0x366f9a,'payment':{'id':_0x5b0fb6['id'],'order_id':_0x5b0fb6[_0x2ef0d5(0x1fc)],'gateway_order_id':_0x5b0fb6[_0x2ef0d5(0x1d9)],'gateway':_0x2ef0d5(0x1dd),'amount':_0x5b0fb6[_0x2ef0d5(0x210)],'currency':_0x5b0fb6[_0x2ef0d5(0x223)],'status':_0x2c250d['toLowerCase'](),'customer_email':_0x5b0fb6[_0x2ef0d5(0x203)],'customer_name':_0x5b0fb6[_0x2ef0d5(0x21f)],'gateway_payment_id':_0x38f4fa,'created_at':_0x5b0fb6[_0x2ef0d5(0x202)],'updated_at':new Date()}},_0x4a6c06=await fetch(_0x10b4bc[_0x2ef0d5(0x1a7)],{'method':'POST','headers':{'Content-Type':_0x2ef0d5(0x1ea),'User-Agent':_0x2ef0d5(0x1b1)},'body':JSON[_0x2ef0d5(0x1b5)](_0x1991aa)}),_0x334be0=Date[_0x2ef0d5(0x200)]()-_0x1b2df3;console[_0x2ef0d5(0x21b)](_0x2ef0d5(0x1cb)+_0x10b4bc[_0x2ef0d5(0x1a7)]+_0x2ef0d5(0x1c2)+_0x4a6c06['status']+'\x20('+_0x334be0+'ms)');}catch(_0x2ee050){console['error'](_0x2ef0d5(0x225),_0x2ee050);}}async[a8_0x159c92(0x228)](_0x484cdf,_0x3c3dd0){const _0x4e58de=a8_0x159c92;try{const {telegramBotService:_0x340d0f}=await Promise['resolve']()[_0x4e58de(0x214)](()=>__importStar(require(_0x4e58de(0x1bb)))),_0x1ee9de={'PAID':_0x4e58de(0x209),'FAILED':_0x4e58de(0x1ab)},_0x42eaa9=_0x1ee9de[_0x3c3dd0];if(!_0x42eaa9)return;await _0x340d0f[_0x4e58de(0x212)](_0x484cdf[_0x4e58de(0x1ae)],_0x484cdf,_0x42eaa9);}catch(_0x1371f9){console[_0x4e58de(0x1fb)](_0x4e58de(0x1ad),_0x1371f9);}}}exports['PaymentController']=PaymentController;