'use strict';const a8_0x82dd46=a8_0x3cad;(function(_0x13e81f,_0x270ada){const _0x3221e7=a8_0x3cad,_0x27ecff=_0x13e81f();while(!![]){try{const _0x42ad73=-parseInt(_0x3221e7(0xc5))/0x1*(-parseInt(_0x3221e7(0xfb))/0x2)+parseInt(_0x3221e7(0xdf))/0x3*(-parseInt(_0x3221e7(0x109))/0x4)+-parseInt(_0x3221e7(0xbb))/0x5+-parseInt(_0x3221e7(0xe1))/0x6+parseInt(_0x3221e7(0xf1))/0x7+-parseInt(_0x3221e7(0xb0))/0x8+parseInt(_0x3221e7(0xb5))/0x9;if(_0x42ad73===_0x270ada)break;else _0x27ecff['push'](_0x27ecff['shift']());}catch(_0x36582b){_0x27ecff['push'](_0x27ecff['shift']());}}}(a8_0xbcf6,0x96c37));var __createBinding=this&&this[a8_0x82dd46(0xdb)]||(Object[a8_0x82dd46(0x108)]?function(_0x555b73,_0x5ddad0,_0x54bc30,_0x231066){const _0x4fde39=a8_0x82dd46;if(_0x231066===undefined)_0x231066=_0x54bc30;var _0x255a43=Object['getOwnPropertyDescriptor'](_0x5ddad0,_0x54bc30);(!_0x255a43||(_0x4fde39(0xe6)in _0x255a43?!_0x5ddad0[_0x4fde39(0xfc)]:_0x255a43[_0x4fde39(0xde)]||_0x255a43['configurable']))&&(_0x255a43={'enumerable':!![],'get':function(){return _0x5ddad0[_0x54bc30];}}),Object[_0x4fde39(0xd6)](_0x555b73,_0x231066,_0x255a43);}:function(_0x1a230c,_0x2cc255,_0x1d1ecf,_0x33963d){if(_0x33963d===undefined)_0x33963d=_0x1d1ecf;_0x1a230c[_0x33963d]=_0x2cc255[_0x1d1ecf];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x44f82f,_0x277fda){const _0x3ba55c=a8_0x82dd46;Object[_0x3ba55c(0xd6)](_0x44f82f,_0x3ba55c(0xe9),{'enumerable':!![],'value':_0x277fda});}:function(_0x40f2f7,_0xecc567){_0x40f2f7['default']=_0xecc567;}),__importStar=this&&this['__importStar']||(function(){var _0x3973e5=function(_0x1e1166){const _0x142a21=a8_0x3cad;return _0x3973e5=Object[_0x142a21(0xb9)]||function(_0x353c5e){const _0x21ffda=_0x142a21;var _0x40cf42=[];for(var _0x27b80b in _0x353c5e)if(Object[_0x21ffda(0xe2)]['hasOwnProperty']['call'](_0x353c5e,_0x27b80b))_0x40cf42[_0x40cf42[_0x21ffda(0xdc)]]=_0x27b80b;return _0x40cf42;},_0x3973e5(_0x1e1166);};return function(_0x489133){const _0x442f15=a8_0x3cad;if(_0x489133&&_0x489133['__esModule'])return _0x489133;var _0x2f16f3={};if(_0x489133!=null){for(var _0x54f54f=_0x3973e5(_0x489133),_0x352ad1=0x0;_0x352ad1<_0x54f54f[_0x442f15(0xdc)];_0x352ad1++)if(_0x54f54f[_0x352ad1]!==_0x442f15(0xe9))__createBinding(_0x2f16f3,_0x489133,_0x54f54f[_0x352ad1]);}return __setModuleDefault(_0x2f16f3,_0x489133),_0x2f16f3;};}()),__importDefault=this&&this[a8_0x82dd46(0xf8)]||function(_0x31ef50){const _0x53a0fe=a8_0x82dd46;return _0x31ef50&&_0x31ef50[_0x53a0fe(0xfc)]?_0x31ef50:{'default':_0x31ef50};};function a8_0xbcf6(){const _0x4755b5=['isArray','customerName','params','__createBinding','length','getPaymentById','writable','48wldSXH','log','5759616XGgLtt','prototype','paidAt','payment','threeds_url','get','paymentService','PENDING','default','\x20\x20\x20Return\x20URL:\x20','MasterCard\x20webhook\x20sent\x20to\x20','shopId','Card\x20payment\x20failed','payment.failed','3DS\x20verification\x20required','webhookEvents','6900033oNfcEC','\x20not\x20enabled\x20for\x20shop\x20','../services/gateways/mastercardService','sendPaymentNotification','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','final','masterCardService','__importDefault','payment.success',',\x20cannot\x20process','16MYnHrG','__esModule','successUrl','status','requires_3ds','webhookUrl','WebhookService','sendShopWebhook','ms)','Payment\x20created\x20successfully','now','1111','gateway_payment_id','create','113296mpYnXe','stringify','currency','FAILED','toISOString','sendPaymentStatusNotification','createPublicPayment','error','body','mastercard_','3024240uZUcnc','system','PaymentService','PAID','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','14180499VRIBep','webhookService','shop','includes','getOwnPropertyNames','mastercard','5302105kjsBDL','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gateway','Payment\x20processed\x20successfully','gatewayPaymentId','../services/webhookService','json','toLowerCase','processCardPayment','failed','113471OmGKvR','ðŸ’³\x20MasterCard\x20URLs:','processMasterCardPayment','createdAt','gatewayOrderId','orderId','PaymentController','\x20processed:\x20','application/json','Webhook\x20event\x20','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','findUnique','update','paid','webhookLog','Failed\x20to\x20send\x20MasterCard\x20webhook:','../config/database','defineProperty','Payment\x20not\x20found'];a8_0xbcf6=function(){return _0x4755b5;};return a8_0xbcf6();}Object[a8_0x82dd46(0xd6)](exports,a8_0x82dd46(0xfc),{'value':!![]}),exports[a8_0x82dd46(0xcb)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x82dd46(0xf3)),webhookService_1=require(a8_0x82dd46(0xc0)),database_1=__importDefault(require(a8_0x82dd46(0xd5)));function a8_0x3cad(_0x172db1,_0xedf604){const _0xbcf646=a8_0xbcf6();return a8_0x3cad=function(_0x3cad4f,_0x3efe93){_0x3cad4f=_0x3cad4f-0xb0;let _0x4127b8=_0xbcf646[_0x3cad4f];return _0x4127b8;},a8_0x3cad(_0x172db1,_0xedf604);}class PaymentController{constructor(){const _0x46b94d=a8_0x82dd46;this[_0x46b94d(0x10f)]=async(_0x2da8ce,_0x1e66b1,_0x1729cb)=>{const _0x117f6d=_0x46b94d;try{const _0xdc133b=_0x2da8ce[_0x117f6d(0x111)],_0x5f31a9=await this['paymentService'][_0x117f6d(0x10f)](_0xdc133b);_0x1e66b1[_0x117f6d(0xfe)](0xc9)['json']({'success':!![],'message':_0x117f6d(0x104),'result':_0x5f31a9});}catch(_0x384965){_0x1729cb(_0x384965);}},this['getPaymentStatus']=async(_0x512c43,_0x431576,_0x28e3a9)=>{const _0x2075b1=_0x46b94d;try{const {id:_0x1ad71f}=_0x512c43[_0x2075b1(0xda)],_0x4415c4=await this['paymentService']['getPaymentStatus'](_0x1ad71f);if(!_0x4415c4)return _0x431576[_0x2075b1(0xfe)](0x194)[_0x2075b1(0xc1)]({'success':![],'message':_0x2075b1(0xd7)});_0x431576[_0x2075b1(0xc1)]({'success':!![],'result':_0x4415c4});}catch(_0x2e411b){_0x28e3a9(_0x2e411b);}},this[_0x46b94d(0xdd)]=async(_0x5385bd,_0x2ab37d,_0x4c6d5e)=>{const _0x1287f7=_0x46b94d;try{const {id:_0x351b6a}=_0x5385bd['params'],_0x56a26c=await this[_0x1287f7(0xe7)][_0x1287f7(0xdd)](_0x351b6a);if(!_0x56a26c)return _0x2ab37d[_0x1287f7(0xfe)](0x194)['json']({'success':![],'message':_0x1287f7(0xd7)});_0x2ab37d[_0x1287f7(0xc1)]({'success':!![],'result':_0x56a26c});}catch(_0x5d7d77){_0x4c6d5e(_0x5d7d77);}},this[_0x46b94d(0xc7)]=async(_0x130d81,_0x2be246,_0xeec4a2)=>{const _0x29d5f7=_0x46b94d;try{const {id:_0x4ef49c}=_0x130d81[_0x29d5f7(0xda)],{cardData:_0x10be04,cardHolder:_0x31dec7,browser:_0x3267e0}=_0x130d81[_0x29d5f7(0x111)];console['log']('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x4ef49c);const _0x2e895d=await database_1[_0x29d5f7(0xe9)]['payment'][_0x29d5f7(0xd0)]({'where':{'id':_0x4ef49c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2e895d)return _0x2be246['status'](0x194)[_0x29d5f7(0xc1)]({'success':![],'message':_0x29d5f7(0xd7)});if(_0x2e895d[_0x29d5f7(0xbd)]!==_0x29d5f7(0xba))return _0x2be246[_0x29d5f7(0xfe)](0x190)[_0x29d5f7(0xc1)]({'success':![],'message':_0x29d5f7(0xcf)});if(_0x2e895d[_0x29d5f7(0xfe)]!=='PENDING')return _0x2be246['status'](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2e895d[_0x29d5f7(0xfe)]+_0x29d5f7(0xfa)});const _0x4e7557=_0x29d5f7(0xf5),_0x115c99=_0x2e895d[_0x29d5f7(0xfd)];console[_0x29d5f7(0xe0)](_0x29d5f7(0xc6)),console[_0x29d5f7(0xe0)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x4e7557),console['log'](_0x29d5f7(0xea)+_0x115c99);const _0x1e2d5f=await this[_0x29d5f7(0xf7)][_0x29d5f7(0xc3)]({'paymentId':_0x2e895d['id'],'orderId':_0x2e895d[_0x29d5f7(0xc9)]||_0x2e895d['id'],'amount':_0x2e895d['amount'],'currency':_0x2e895d[_0x29d5f7(0x10b)],'cardData':_0x10be04,'resultUrl':_0x4e7557,'returnUrl':_0x115c99,'cardHolder':_0x31dec7,'browser':_0x3267e0});console[_0x29d5f7(0xe0)]('ðŸ’³\x20MasterCard\x20result:',_0x1e2d5f);const _0x206598={'status':_0x1e2d5f['status'],'updatedAt':new Date(),'statusChangedBy':_0x29d5f7(0xb1),'statusChangedAt':new Date()};if(_0x1e2d5f[_0x29d5f7(0xfe)]===_0x29d5f7(0xb3))_0x206598[_0x29d5f7(0xe3)]=new Date(),_0x206598[_0x29d5f7(0xbf)]=_0x1e2d5f[_0x29d5f7(0x107)];else _0x1e2d5f[_0x29d5f7(0xfe)]===_0x29d5f7(0x10c)&&(_0x206598['failureMessage']=_0x29d5f7(0xed));_0x206598['paymentMethod']=_0x29d5f7(0xba),await database_1[_0x29d5f7(0xe9)][_0x29d5f7(0xe4)][_0x29d5f7(0xd1)]({'where':{'id':_0x2e895d['id']},'data':_0x206598}),await database_1[_0x29d5f7(0xe9)][_0x29d5f7(0xd3)][_0x29d5f7(0x108)]({'data':{'paymentId':_0x2e895d['id'],'shopId':_0x2e895d[_0x29d5f7(0xec)],'event':_0x29d5f7(0x112)+_0x1e2d5f[_0x29d5f7(0xfe)]?.[_0x29d5f7(0xc2)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x29d5f7(0xe8),'newStatus':_0x1e2d5f[_0x29d5f7(0xfe)],'gatewayPaymentId':_0x1e2d5f[_0x29d5f7(0x107)],'requires3ds':_0x1e2d5f[_0x29d5f7(0xff)],'processedAt':new Date()[_0x29d5f7(0x10d)]()})}});_0x1e2d5f[_0x29d5f7(0xf6)]&&(await this[_0x29d5f7(0x102)](_0x2e895d,_0x1e2d5f[_0x29d5f7(0xfe)],_0x1e2d5f['gateway_payment_id']),await this[_0x29d5f7(0x10e)](_0x2e895d,_0x1e2d5f[_0x29d5f7(0xfe)]));console['log']('âœ…\x20MasterCard\x20payment\x20'+_0x4ef49c+_0x29d5f7(0xcc)+_0x1e2d5f['status']);if(_0x1e2d5f[_0x29d5f7(0xfe)]==='PAID')_0x2be246[_0x29d5f7(0xc1)]({'success':!![],'message':_0x29d5f7(0xbe),'result':{'status':_0x29d5f7(0xb3),'gatewayPaymentId':_0x1e2d5f[_0x29d5f7(0x107)],'redirectUrl':_0x115c99,'final':!![]}});else _0x1e2d5f[_0x29d5f7(0xff)]&&_0x1e2d5f[_0x29d5f7(0xe5)]?_0x2be246[_0x29d5f7(0xc1)]({'success':!![],'message':_0x29d5f7(0xef),'result':{'status':_0x29d5f7(0xe8),'gatewayPaymentId':_0x1e2d5f[_0x29d5f7(0x107)],'redirectUrl':_0x1e2d5f[_0x29d5f7(0xe5)],'requires3ds':!![],'final':![]}}):_0x2be246[_0x29d5f7(0xfe)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x29d5f7(0x10c),'gatewayPaymentId':_0x1e2d5f['gateway_payment_id'],'redirectUrl':_0x2e895d['failUrl'],'final':!![]}});}catch(_0x187a82){_0xeec4a2(_0x187a82);}},this[_0x46b94d(0xe7)]=new paymentService_1[(_0x46b94d(0xb2))](),this['masterCardService']=new mastercardService_1['MasterCardService'](),this[_0x46b94d(0xb6)]=new webhookService_1[(_0x46b94d(0x101))]();}async['sendShopWebhook'](_0x50431f,_0x24dfc6,_0x260478){const _0xf29a3=a8_0x82dd46,_0x28f5d5=Date[_0xf29a3(0x105)]();try{const _0x4e3b25=_0x50431f[_0xf29a3(0xb7)],_0x30d5a0=_0x4e3b25['settings'];if(!_0x30d5a0?.[_0xf29a3(0x100)]){console[_0xf29a3(0xe0)](_0xf29a3(0xb4)+_0x4e3b25['id']);return;}const _0x5d5364=_0x24dfc6===_0xf29a3(0xb3)?_0xf29a3(0xf9):_0xf29a3(0xee);let _0x4acc81=[];if(_0x30d5a0['webhookEvents'])try{_0x4acc81=Array[_0xf29a3(0xd8)](_0x30d5a0[_0xf29a3(0xf0)])?_0x30d5a0[_0xf29a3(0xf0)]:JSON['parse'](_0x30d5a0[_0xf29a3(0xf0)]);}catch(_0x2451ee){console[_0xf29a3(0x110)]('Error\x20parsing\x20webhook\x20events:',_0x2451ee),_0x4acc81=[];}if(!_0x4acc81[_0xf29a3(0xb8)](_0x5d5364)){console[_0xf29a3(0xe0)](_0xf29a3(0xce)+_0x5d5364+_0xf29a3(0xf2)+_0x4e3b25['id']);return;}const _0x3eaf13={'event':_0x5d5364,'payment':{'id':_0x50431f['id'],'order_id':_0x50431f[_0xf29a3(0xca)],'gateway_order_id':_0x50431f[_0xf29a3(0xc9)],'gateway':_0xf29a3(0x106),'amount':_0x50431f['amount'],'currency':_0x50431f['currency'],'status':_0x24dfc6[_0xf29a3(0xc2)](),'customer_email':_0x50431f['customerEmail'],'customer_name':_0x50431f[_0xf29a3(0xd9)],'gateway_payment_id':_0x260478,'created_at':_0x50431f[_0xf29a3(0xc8)],'updated_at':new Date()}},_0x3e4131=await fetch(_0x30d5a0[_0xf29a3(0x100)],{'method':'POST','headers':{'Content-Type':_0xf29a3(0xcd),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0xf29a3(0x10a)](_0x3eaf13)}),_0x27e46c=Date[_0xf29a3(0x105)]()-_0x28f5d5;console[_0xf29a3(0xe0)](_0xf29a3(0xeb)+_0x30d5a0[_0xf29a3(0x100)]+'\x20with\x20status\x20'+_0x3e4131[_0xf29a3(0xfe)]+'\x20('+_0x27e46c+_0xf29a3(0x103));}catch(_0x5cd05d){console[_0xf29a3(0x110)](_0xf29a3(0xd4),_0x5cd05d);}}async[a8_0x82dd46(0x10e)](_0x3b1aae,_0x331ad7){const _0x4524ec=a8_0x82dd46;try{const {telegramBotService:_0x27280a}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x3c9bef={'PAID':_0x4524ec(0xd2),'FAILED':_0x4524ec(0xc4)},_0x4dbda5=_0x3c9bef[_0x331ad7];if(!_0x4dbda5)return;await _0x27280a[_0x4524ec(0xf4)](_0x3b1aae[_0x4524ec(0xec)],_0x3b1aae,_0x4dbda5);}catch(_0x4d943e){console['error'](_0x4524ec(0xbc),_0x4d943e);}}}exports[a8_0x82dd46(0xcb)]=PaymentController;