'use strict';const a8_0x5acd20=a8_0x1317;(function(_0x110b1c,_0xcacf7e){const _0x4de982=a8_0x1317,_0x5d18f2=_0x110b1c();while(!![]){try{const _0x5bca9a=-parseInt(_0x4de982(0x10b))/0x1*(-parseInt(_0x4de982(0xf6))/0x2)+parseInt(_0x4de982(0xd7))/0x3*(-parseInt(_0x4de982(0xd3))/0x4)+-parseInt(_0x4de982(0x125))/0x5+-parseInt(_0x4de982(0xe7))/0x6+parseInt(_0x4de982(0x102))/0x7+-parseInt(_0x4de982(0xf4))/0x8+parseInt(_0x4de982(0xf8))/0x9;if(_0x5bca9a===_0xcacf7e)break;else _0x5d18f2['push'](_0x5d18f2['shift']());}catch(_0x291619){_0x5d18f2['push'](_0x5d18f2['shift']());}}}(a8_0x5e4d,0xa19fb));var __createBinding=this&&this[a8_0x5acd20(0x11b)]||(Object[a8_0x5acd20(0xdb)]?function(_0x2eee42,_0x1a5e76,_0x545dd5,_0x4e9d71){const _0xf46166=a8_0x5acd20;if(_0x4e9d71===undefined)_0x4e9d71=_0x545dd5;var _0x915e75=Object['getOwnPropertyDescriptor'](_0x1a5e76,_0x545dd5);(!_0x915e75||('get'in _0x915e75?!_0x1a5e76['__esModule']:_0x915e75[_0xf46166(0x112)]||_0x915e75['configurable']))&&(_0x915e75={'enumerable':!![],'get':function(){return _0x1a5e76[_0x545dd5];}}),Object[_0xf46166(0xe3)](_0x2eee42,_0x4e9d71,_0x915e75);}:function(_0x21c5ed,_0x5f32f8,_0x141370,_0x1d8586){if(_0x1d8586===undefined)_0x1d8586=_0x141370;_0x21c5ed[_0x1d8586]=_0x5f32f8[_0x141370];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x5acd20(0xdb)]?function(_0x32135c,_0xa0924b){const _0x504f97=a8_0x5acd20;Object[_0x504f97(0xe3)](_0x32135c,_0x504f97(0x121),{'enumerable':!![],'value':_0xa0924b});}:function(_0x50c1d1,_0x56891a){const _0x204a2a=a8_0x5acd20;_0x50c1d1[_0x204a2a(0x121)]=_0x56891a;}),__importStar=this&&this[a8_0x5acd20(0xe2)]||(function(){var _0x3e0f2f=function(_0x295cd6){const _0x3cb482=a8_0x1317;return _0x3e0f2f=Object[_0x3cb482(0xd6)]||function(_0xb56368){const _0x3ce0b1=_0x3cb482;var _0x3b6a53=[];for(var _0x36b71a in _0xb56368)if(Object['prototype'][_0x3ce0b1(0x110)][_0x3ce0b1(0x127)](_0xb56368,_0x36b71a))_0x3b6a53[_0x3b6a53['length']]=_0x36b71a;return _0x3b6a53;},_0x3e0f2f(_0x295cd6);};return function(_0x55cc99){const _0x4a9d2b=a8_0x1317;if(_0x55cc99&&_0x55cc99[_0x4a9d2b(0xf7)])return _0x55cc99;var _0x47f203={};if(_0x55cc99!=null){for(var _0x1ab7dc=_0x3e0f2f(_0x55cc99),_0x4e54dd=0x0;_0x4e54dd<_0x1ab7dc[_0x4a9d2b(0xdf)];_0x4e54dd++)if(_0x1ab7dc[_0x4e54dd]!==_0x4a9d2b(0x121))__createBinding(_0x47f203,_0x55cc99,_0x1ab7dc[_0x4e54dd]);}return __setModuleDefault(_0x47f203,_0x55cc99),_0x47f203;};}()),__importDefault=this&&this[a8_0x5acd20(0xeb)]||function(_0x1cb6be){const _0x22ef47=a8_0x5acd20;return _0x1cb6be&&_0x1cb6be[_0x22ef47(0xf7)]?_0x1cb6be:{'default':_0x1cb6be};};function a8_0x5e4d(){const _0x413816=['writable','customerEmail','Error\x20parsing\x20webhook\x20events:','PAID','Payment\x20created\x20successfully','gateway_payment_id','webhookLog','toISOString','payment','__createBinding','json','params','update','customerName','PaymentController','default','toLowerCase','MasterCardService','Payment\x20status\x20is\x20','7605RwlnGZ','createPublicPayment','call','resolve','getPaymentStatus','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paid','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Failed\x20to\x20send\x20MasterCard\x20webhook:','findUnique','PaymentService','final',',\x20cannot\x20process','../services/gateways/mastercardService','log','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','3DS\x20verification\x20required','includes','\x20\x20\x20Result\x20URL\x20(webhook):\x20','paymentService','requires_3ds','16mxfFiN','processCardPayment','\x20with\x20status\x20','getOwnPropertyNames','747282xWCpgO','ðŸ’³\x20MasterCard\x20result:','../services/telegramBotService','shop','create','currency','gatewayOrderId','getPaymentById','length','Payment\x20not\x20found','orderId','__importStar','defineProperty','../services/paymentService','createdAt','sendPaymentNotification','3943728tRpkbP','POST','1111','status','__importDefault','error','amount','../services/webhookService','successUrl','sendPaymentStatusNotification','payment.failed','\x20\x20\x20Return\x20URL:\x20','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','4289488Fbxscj','masterCardService','2IjIPca','__esModule','4428270LBDzDQ','sendShopWebhook','https://api.trapay.uk/api/webhooks/gateway/mastercard','\x20not\x20enabled\x20for\x20shop\x20','mastercard','threeds_url','FAILED','paidAt','shopId','stringify','8972537lhrlVe','ðŸ’³\x20MasterCard\x20URLs:','gatewayPaymentId','application/json','now','../config/database','processMasterCardPayment','body','MasterCard\x20webhook\x20sent\x20to\x20','1079561ETFJNF','PENDING','âœ…\x20MasterCard\x20payment\x20','system','gateway','hasOwnProperty','webhookEvents'];a8_0x5e4d=function(){return _0x413816;};return a8_0x5e4d();}function a8_0x1317(_0x5567e9,_0x2b4940){const _0x5e4da2=a8_0x5e4d();return a8_0x1317=function(_0x13178f,_0x35baa2){_0x13178f=_0x13178f-0xc3;let _0x6e3b9d=_0x5e4da2[_0x13178f];return _0x6e3b9d;},a8_0x1317(_0x5567e9,_0x2b4940);}Object[a8_0x5acd20(0xe3)](exports,a8_0x5acd20(0xf7),{'value':!![]}),exports[a8_0x5acd20(0x120)]=void 0x0;const paymentService_1=require(a8_0x5acd20(0xe4)),mastercardService_1=require(a8_0x5acd20(0xcb)),webhookService_1=require(a8_0x5acd20(0xee)),database_1=__importDefault(require(a8_0x5acd20(0x107)));class PaymentController{constructor(){const _0x2c7b2e=a8_0x5acd20;this[_0x2c7b2e(0x126)]=async(_0xdacb25,_0x5e2db1,_0x39fb03)=>{const _0x272d82=_0x2c7b2e;try{const _0x4b25f6=_0xdacb25[_0x272d82(0x109)],_0x5b1c2=await this[_0x272d82(0xd1)]['createPublicPayment'](_0x4b25f6);_0x5e2db1[_0x272d82(0xea)](0xc9)[_0x272d82(0x11c)]({'success':!![],'message':_0x272d82(0x116),'result':_0x5b1c2});}catch(_0x48dfcd){_0x39fb03(_0x48dfcd);}},this[_0x2c7b2e(0x129)]=async(_0xf1a1b3,_0x3494d9,_0x550e67)=>{const _0x5e96c0=_0x2c7b2e;try{const {id:_0x3c6d93}=_0xf1a1b3[_0x5e96c0(0x11d)],_0x49dae9=await this['paymentService'][_0x5e96c0(0x129)](_0x3c6d93);if(!_0x49dae9)return _0x3494d9[_0x5e96c0(0xea)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x3494d9[_0x5e96c0(0x11c)]({'success':!![],'result':_0x49dae9});}catch(_0x1fa626){_0x550e67(_0x1fa626);}},this['getPaymentById']=async(_0x5be297,_0x2ac8e6,_0x429829)=>{const _0x8cdfc2=_0x2c7b2e;try{const {id:_0x13fa9e}=_0x5be297[_0x8cdfc2(0x11d)],_0x41bcb0=await this[_0x8cdfc2(0xd1)][_0x8cdfc2(0xde)](_0x13fa9e);if(!_0x41bcb0)return _0x2ac8e6[_0x8cdfc2(0xea)](0x194)[_0x8cdfc2(0x11c)]({'success':![],'message':_0x8cdfc2(0xe0)});_0x2ac8e6[_0x8cdfc2(0x11c)]({'success':!![],'result':_0x41bcb0});}catch(_0x1b1887){_0x429829(_0x1b1887);}},this[_0x2c7b2e(0x108)]=async(_0x4ebad3,_0x54a1ec,_0x1df9f6)=>{const _0x3556c0=_0x2c7b2e;try{const {id:_0x13a846}=_0x4ebad3[_0x3556c0(0x11d)],{cardData:_0x14d0b2,cardHolder:_0xa957f9,browser:_0xe41d54}=_0x4ebad3['body'];console['log'](_0x3556c0(0xf3)+_0x13a846);const _0x1b3596=await database_1[_0x3556c0(0x121)][_0x3556c0(0x11a)][_0x3556c0(0xc7)]({'where':{'id':_0x13a846},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1b3596)return _0x54a1ec[_0x3556c0(0xea)](0x194)[_0x3556c0(0x11c)]({'success':![],'message':_0x3556c0(0xe0)});if(_0x1b3596[_0x3556c0(0x10f)]!==_0x3556c0(0xfc))return _0x54a1ec[_0x3556c0(0xea)](0x190)[_0x3556c0(0x11c)]({'success':![],'message':_0x3556c0(0xc5)});if(_0x1b3596[_0x3556c0(0xea)]!=='PENDING')return _0x54a1ec[_0x3556c0(0xea)](0x190)[_0x3556c0(0x11c)]({'success':![],'message':_0x3556c0(0x124)+_0x1b3596[_0x3556c0(0xea)]+_0x3556c0(0xca)});const _0x5dfdd1=_0x3556c0(0xfa),_0x4584b5=_0x1b3596[_0x3556c0(0xef)];console[_0x3556c0(0xcc)](_0x3556c0(0x103)),console['log'](_0x3556c0(0xd0)+_0x5dfdd1),console[_0x3556c0(0xcc)](_0x3556c0(0xf2)+_0x4584b5);const _0x49d899=await this['masterCardService'][_0x3556c0(0xd4)]({'paymentId':_0x1b3596['id'],'orderId':_0x1b3596[_0x3556c0(0xdd)]||_0x1b3596['id'],'amount':_0x1b3596[_0x3556c0(0xed)],'currency':_0x1b3596[_0x3556c0(0xdc)],'cardData':_0x14d0b2,'resultUrl':_0x5dfdd1,'returnUrl':_0x4584b5,'cardHolder':_0xa957f9,'browser':_0xe41d54});console[_0x3556c0(0xcc)](_0x3556c0(0xd8),_0x49d899);const _0x459970={'status':_0x49d899[_0x3556c0(0xea)],'updatedAt':new Date(),'statusChangedBy':_0x3556c0(0x10e),'statusChangedAt':new Date()};if(_0x49d899[_0x3556c0(0xea)]==='PAID')_0x459970[_0x3556c0(0xff)]=new Date(),_0x459970[_0x3556c0(0x104)]=_0x49d899[_0x3556c0(0x117)];else _0x49d899[_0x3556c0(0xea)]===_0x3556c0(0xfe)&&(_0x459970['failureMessage']='Card\x20payment\x20failed');_0x459970['paymentMethod']='mastercard',await database_1[_0x3556c0(0x121)]['payment'][_0x3556c0(0x11e)]({'where':{'id':_0x1b3596['id']},'data':_0x459970}),await database_1[_0x3556c0(0x121)][_0x3556c0(0x118)]['create']({'data':{'paymentId':_0x1b3596['id'],'shopId':_0x1b3596[_0x3556c0(0x100)],'event':'mastercard_'+_0x49d899[_0x3556c0(0xea)]?.[_0x3556c0(0x122)](),'statusCode':0xc8,'responseBody':JSON[_0x3556c0(0x101)]({'oldStatus':_0x3556c0(0x10c),'newStatus':_0x49d899['status'],'gatewayPaymentId':_0x49d899['gateway_payment_id'],'requires3ds':_0x49d899[_0x3556c0(0xd2)],'processedAt':new Date()[_0x3556c0(0x119)]()})}});_0x49d899[_0x3556c0(0xc9)]&&(await this[_0x3556c0(0xf9)](_0x1b3596,_0x49d899[_0x3556c0(0xea)],_0x49d899[_0x3556c0(0x117)]),await this[_0x3556c0(0xf0)](_0x1b3596,_0x49d899[_0x3556c0(0xea)]));console['log'](_0x3556c0(0x10d)+_0x13a846+'\x20processed:\x20'+_0x49d899[_0x3556c0(0xea)]);if(_0x49d899[_0x3556c0(0xea)]==='PAID')_0x54a1ec[_0x3556c0(0x11c)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x3556c0(0x115),'gatewayPaymentId':_0x49d899[_0x3556c0(0x117)],'redirectUrl':_0x4584b5,'final':!![]}});else _0x49d899['requires_3ds']&&_0x49d899[_0x3556c0(0xfd)]?_0x54a1ec['json']({'success':!![],'message':_0x3556c0(0xce),'result':{'status':_0x3556c0(0x10c),'gatewayPaymentId':_0x49d899['gateway_payment_id'],'redirectUrl':_0x49d899[_0x3556c0(0xfd)],'requires3ds':!![],'final':![]}}):_0x54a1ec[_0x3556c0(0xea)](0x190)[_0x3556c0(0x11c)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x3556c0(0xfe),'gatewayPaymentId':_0x49d899[_0x3556c0(0x117)],'redirectUrl':_0x1b3596['failUrl'],'final':!![]}});}catch(_0x1d1c46){_0x1df9f6(_0x1d1c46);}},this[_0x2c7b2e(0xd1)]=new paymentService_1[(_0x2c7b2e(0xc8))](),this[_0x2c7b2e(0xf5)]=new mastercardService_1[(_0x2c7b2e(0x123))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x5acd20(0xf9)](_0xc8e2c0,_0x3bab38,_0x357efb){const _0x16d229=a8_0x5acd20,_0x5bbb6d=Date[_0x16d229(0x106)]();try{const _0x4a2475=_0xc8e2c0[_0x16d229(0xda)],_0x221037=_0x4a2475['settings'];if(!_0x221037?.['webhookUrl']){console['log'](_0x16d229(0xc3)+_0x4a2475['id']);return;}const _0x89daf1=_0x3bab38===_0x16d229(0x115)?'payment.success':_0x16d229(0xf1);let _0x366cdf=[];if(_0x221037[_0x16d229(0x111)])try{_0x366cdf=Array['isArray'](_0x221037[_0x16d229(0x111)])?_0x221037['webhookEvents']:JSON['parse'](_0x221037[_0x16d229(0x111)]);}catch(_0x861b8a){console[_0x16d229(0xec)](_0x16d229(0x114),_0x861b8a),_0x366cdf=[];}if(!_0x366cdf[_0x16d229(0xcf)](_0x89daf1)){console[_0x16d229(0xcc)]('Webhook\x20event\x20'+_0x89daf1+_0x16d229(0xfb)+_0x4a2475['id']);return;}const _0x32ed3b={'event':_0x89daf1,'payment':{'id':_0xc8e2c0['id'],'order_id':_0xc8e2c0[_0x16d229(0xe1)],'gateway_order_id':_0xc8e2c0[_0x16d229(0xdd)],'gateway':_0x16d229(0xe9),'amount':_0xc8e2c0[_0x16d229(0xed)],'currency':_0xc8e2c0['currency'],'status':_0x3bab38['toLowerCase'](),'customer_email':_0xc8e2c0[_0x16d229(0x113)],'customer_name':_0xc8e2c0[_0x16d229(0x11f)],'gateway_payment_id':_0x357efb,'created_at':_0xc8e2c0[_0x16d229(0xe5)],'updated_at':new Date()}},_0x20251d=await fetch(_0x221037['webhookUrl'],{'method':_0x16d229(0xe8),'headers':{'Content-Type':_0x16d229(0x105),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x32ed3b)}),_0x1d5d2f=Date[_0x16d229(0x106)]()-_0x5bbb6d;console['log'](_0x16d229(0x10a)+_0x221037['webhookUrl']+_0x16d229(0xd5)+_0x20251d[_0x16d229(0xea)]+'\x20('+_0x1d5d2f+'ms)');}catch(_0x42b4c1){console[_0x16d229(0xec)](_0x16d229(0xc6),_0x42b4c1);}}async['sendPaymentStatusNotification'](_0x32c0dc,_0x45cd3d){const _0xe27a73=a8_0x5acd20;try{const {telegramBotService:_0x40c8bd}=await Promise[_0xe27a73(0x128)]()['then'](()=>__importStar(require(_0xe27a73(0xd9)))),_0x356eab={'PAID':_0xe27a73(0xc4),'FAILED':'failed'},_0x4b7eaf=_0x356eab[_0x45cd3d];if(!_0x4b7eaf)return;await _0x40c8bd[_0xe27a73(0xe6)](_0x32c0dc[_0xe27a73(0x100)],_0x32c0dc,_0x4b7eaf);}catch(_0x30cfce){console['error'](_0xe27a73(0xcd),_0x30cfce);}}}exports[a8_0x5acd20(0x120)]=PaymentController;