'use strict';const a8_0x1274dc=a8_0x2d1a;function a8_0x2810(){const _0x195bcb=['toLowerCase','sendShopWebhook','__importDefault','processCardPayment','FAILED','üí≥\x20','amount','findUnique','../services/gateways/mastercardService','VisaMasterCardService','1111','../services/paymentLinkService','__createBinding','../config/database','paymentService','json','error','email','configurable','../services/paymentService','paidAt','\x20not\x20enabled\x20for\x20shop\x20','\x20webhook:','first_name','failUrl','\x20payment:','threeds_url','body','Error\x20parsing\x20webhook\x20events:','mastercard','WebhookService','https://app.trapay.uk/payment/pending?id=','webhookLog','https://api.trapay.uk/api/webhooks/gateway/','parse','now','17065MvWzRp','params','webhookUrl','get','Payment\x20not\x20found','VISA/MasterCard','status','Failed\x20to\x20send\x20','üìà\x20','sendPaymentStatusNotification','stringify','\x20\x20\x20Return\x20URL:\x20','\x20processed:\x20','last_name','slice','Payment\x20processed\x20successfully','11914600pUqkYM','PAID','system','final','create','prototype','processMasterCardPayment','../services/webhookService','Card\x20payment\x20failed','\x20payment\x20','1904466LXpvHd','gatewayOrderId','gateway_payment_id','payment.success','application/json','shopId','POST','toISOString','number','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','1503awVtIy','PENDING','üìù\x20Customer\x20data:','__setModuleDefault','visa/mastercard','\x20webhook\x20sent\x20to\x20','log','&payment_id=','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','\x20with\x20status\x20','1590yfrQYe','4901715zNJxgd','replace','webhookService','settings',',\x20cannot\x20process','toUpperCase','getPaymentById','shop','Payment\x20created\x20successfully','payment.failed','paymentMethod','length','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','__esModule','includes','requires_3ds','resolve','Customer\x20data\x20updated\x20successfully','PaymentController','1321732xVDKvH','ms)','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','customerName','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','../services/telegramBotService','createPublicPayment','gateway','üí≥\x20Browser\x20IP:\x20','visaMasterCardService','Webhook\x20event\x20','hasOwnProperty','updatePaymentCustomerDataPublic','customerIp','user_agent','Payment\x20status\x20is\x20','defineProperty','getPaymentStatus','then','\x20\x20\x20Result\x20URL\x20(webhook):\x20','currency','isArray','handleSuccessfulPayment','19220IzlviC','customerEmail','customerUa','payment','default','customerCountry','üí≥\x20MasterCard\x20result:','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookEvents'];a8_0x2810=function(){return _0x195bcb;};return a8_0x2810();}(function(_0x281e94,_0xcc70ef){const _0x3d9f7c=a8_0x2d1a,_0x45d5a5=_0x281e94();while(!![]){try{const _0x5579d7=-parseInt(_0x3d9f7c(0x134))/0x1+-parseInt(_0x3d9f7c(0x162))/0x2*(parseInt(_0x3d9f7c(0x158))/0x3)+-parseInt(_0x3d9f7c(0xf0))/0x4+-parseInt(_0x3d9f7c(0x107))/0x5+parseInt(_0x3d9f7c(0x14e))/0x6+-parseInt(_0x3d9f7c(0x163))/0x7+parseInt(_0x3d9f7c(0x144))/0x8;if(_0x5579d7===_0xcc70ef)break;else _0x45d5a5['push'](_0x45d5a5['shift']());}catch(_0x39a1b7){_0x45d5a5['push'](_0x45d5a5['shift']());}}}(a8_0x2810,0x571f6));var __createBinding=this&&this[a8_0x1274dc(0x11c)]||(Object['create']?function(_0x2bcf65,_0x26e710,_0x4c7925,_0x11d3c5){const _0xcacb57=a8_0x1274dc;if(_0x11d3c5===undefined)_0x11d3c5=_0x4c7925;var _0x2cb3c4=Object['getOwnPropertyDescriptor'](_0x26e710,_0x4c7925);(!_0x2cb3c4||(_0xcacb57(0x137)in _0x2cb3c4?!_0x26e710[_0xcacb57(0x170)]:_0x2cb3c4['writable']||_0x2cb3c4[_0xcacb57(0x122)]))&&(_0x2cb3c4={'enumerable':!![],'get':function(){return _0x26e710[_0x4c7925];}}),Object[_0xcacb57(0x100)](_0x2bcf65,_0x11d3c5,_0x2cb3c4);}:function(_0x21bb2c,_0x4f0e8e,_0x22f1bd,_0x558076){if(_0x558076===undefined)_0x558076=_0x22f1bd;_0x21bb2c[_0x558076]=_0x4f0e8e[_0x22f1bd];}),__setModuleDefault=this&&this[a8_0x1274dc(0x15b)]||(Object[a8_0x1274dc(0x148)]?function(_0x37a3b6,_0x1f193d){const _0x282fff=a8_0x1274dc;Object[_0x282fff(0x100)](_0x37a3b6,'default',{'enumerable':!![],'value':_0x1f193d});}:function(_0x55f8c6,_0x295171){const _0x46e905=a8_0x1274dc;_0x55f8c6[_0x46e905(0x10b)]=_0x295171;}),__importStar=this&&this['__importStar']||(function(){var _0x208e23=function(_0x388f88){return _0x208e23=Object['getOwnPropertyNames']||function(_0x376d00){const _0x338c61=a8_0x2d1a;var _0x3f5202=[];for(var _0x95bc9c in _0x376d00)if(Object[_0x338c61(0x149)][_0x338c61(0xfb)]['call'](_0x376d00,_0x95bc9c))_0x3f5202[_0x3f5202[_0x338c61(0x16e)]]=_0x95bc9c;return _0x3f5202;},_0x208e23(_0x388f88);};return function(_0x5241d0){const _0x395baf=a8_0x2d1a;if(_0x5241d0&&_0x5241d0[_0x395baf(0x170)])return _0x5241d0;var _0xc3477a={};if(_0x5241d0!=null){for(var _0x252ca5=_0x208e23(_0x5241d0),_0x2c2c06=0x0;_0x2c2c06<_0x252ca5[_0x395baf(0x16e)];_0x2c2c06++)if(_0x252ca5[_0x2c2c06]!==_0x395baf(0x10b))__createBinding(_0xc3477a,_0x5241d0,_0x252ca5[_0x2c2c06]);}return __setModuleDefault(_0xc3477a,_0x5241d0),_0xc3477a;};}()),__importDefault=this&&this[a8_0x1274dc(0x112)]||function(_0xc224e){const _0x4604c5=a8_0x1274dc;return _0xc224e&&_0xc224e[_0x4604c5(0x170)]?_0xc224e:{'default':_0xc224e};};Object[a8_0x1274dc(0x100)](exports,a8_0x1274dc(0x170),{'value':!![]}),exports[a8_0x1274dc(0x175)]=void 0x0;function a8_0x2d1a(_0x18705f,_0x53c87){const _0x2810ff=a8_0x2810();return a8_0x2d1a=function(_0x2d1a2b,_0x2882dc){_0x2d1a2b=_0x2d1a2b-0xf0;let _0x2dcb74=_0x2810ff[_0x2d1a2b];return _0x2dcb74;},a8_0x2d1a(_0x18705f,_0x53c87);}const paymentService_1=require(a8_0x1274dc(0x123)),mastercardService_1=require(a8_0x1274dc(0x118)),webhookService_1=require(a8_0x1274dc(0x14b)),database_1=__importDefault(require(a8_0x1274dc(0x11d)));class PaymentController{constructor(){const _0x21e57f=a8_0x1274dc;this[_0x21e57f(0xf6)]=async(_0x525906,_0x14189d,_0x3c798a)=>{const _0x31caeb=_0x21e57f;try{const _0x16fd1c=_0x525906[_0x31caeb(0x12b)],_0x3eecbf=await this['paymentService'][_0x31caeb(0xf6)](_0x16fd1c);_0x14189d['status'](0xc9)[_0x31caeb(0x11f)]({'success':!![],'message':_0x31caeb(0x16b),'result':_0x3eecbf});}catch(_0x33fd7e){_0x3c798a(_0x33fd7e);}},this['getPaymentStatus']=async(_0x3749bb,_0x2bac4f,_0x339c38)=>{const _0x3b41ff=_0x21e57f;try{const {id:_0x28660f}=_0x3749bb['params'],_0x4e7a04=await this['paymentService'][_0x3b41ff(0x101)](_0x28660f);if(!_0x4e7a04)return _0x2bac4f['status'](0x194)[_0x3b41ff(0x11f)]({'success':![],'message':_0x3b41ff(0x138)});_0x2bac4f[_0x3b41ff(0x11f)]({'success':!![],'result':_0x4e7a04});}catch(_0x59b742){_0x339c38(_0x59b742);}},this[_0x21e57f(0x169)]=async(_0x30fb0f,_0x3049e1,_0x2dc662)=>{const _0x1de673=_0x21e57f;try{const {id:_0x38b7ea}=_0x30fb0f[_0x1de673(0x135)],_0x4b850e=await this[_0x1de673(0x11e)]['getPaymentById'](_0x38b7ea);if(!_0x4b850e)return _0x3049e1[_0x1de673(0x13a)](0x194)[_0x1de673(0x11f)]({'success':![],'message':_0x1de673(0x138)});_0x3049e1[_0x1de673(0x11f)]({'success':!![],'result':_0x4b850e});}catch(_0x1760df){_0x2dc662(_0x1760df);}},this['updatePaymentCustomer']=async(_0x1fed1c,_0x567415,_0x13e4e9)=>{const _0x3f3b84=_0x21e57f;try{const {id:_0x3dcca2}=_0x1fed1c[_0x3f3b84(0x135)],_0x221ab8=_0x1fed1c[_0x3f3b84(0x12b)];console['log']('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x3dcca2),console[_0x3f3b84(0x15e)](_0x3f3b84(0x15a),_0x221ab8);const _0x11df8d=await this['paymentService'][_0x3f3b84(0xfc)](_0x3dcca2,_0x221ab8);if(!_0x11df8d)return _0x567415[_0x3f3b84(0x13a)](0x194)[_0x3f3b84(0x11f)]({'success':![],'message':_0x3f3b84(0x138)});_0x567415[_0x3f3b84(0x11f)]({'success':!![],'message':_0x3f3b84(0x174),'result':{'paymentId':_0x11df8d['id'],'customerIp':_0x11df8d[_0x3f3b84(0xfd)],'customerUa':_0x11df8d[_0x3f3b84(0x109)],'customerCountry':_0x11df8d[_0x3f3b84(0x10c)],'updatedAt':_0x11df8d['updatedAt']}});}catch(_0x348b38){_0x13e4e9(_0x348b38);}},this[_0x21e57f(0x14a)]=async(_0x2384bf,_0x4814f4,_0x24756b)=>{const _0x1c6495=_0x21e57f;try{const {id:_0x4bdda4}=_0x2384bf['params'],{cardData:_0x5673c0,cardHolder:_0x11f145,browser:_0x26361f}=_0x2384bf[_0x1c6495(0x12b)];console[_0x1c6495(0x15e)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x4bdda4),console[_0x1c6495(0x15e)]('üí≥\x20Card\x20holder:\x20'+_0x11f145[_0x1c6495(0x127)]+'\x20'+_0x11f145[_0x1c6495(0x141)]+'\x20('+_0x11f145[_0x1c6495(0x121)]+')'),console[_0x1c6495(0x15e)](_0x1c6495(0xf8)+_0x26361f['ip']);const _0x168462={'customerName':_0x11f145[_0x1c6495(0x127)]+'\x20'+_0x11f145[_0x1c6495(0x141)],'customerEmail':_0x11f145[_0x1c6495(0x121)],'customerIp':_0x26361f['ip'],'customerUa':_0x26361f[_0x1c6495(0xfe)]},_0x22b6b9=await database_1[_0x1c6495(0x10b)][_0x1c6495(0x10a)][_0x1c6495(0x117)]({'where':{'id':_0x4bdda4},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22b6b9)return _0x4814f4[_0x1c6495(0x13a)](0x194)[_0x1c6495(0x11f)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x22b6b9['gateway']!==_0x1c6495(0x15c))return console['log'](_0x1c6495(0x157)+_0x22b6b9[_0x1c6495(0xf7)]+'\x27'),_0x4814f4[_0x1c6495(0x13a)](0x190)[_0x1c6495(0x11f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway'});if(_0x22b6b9[_0x1c6495(0x13a)]!==_0x1c6495(0x159))return _0x4814f4[_0x1c6495(0x13a)](0x190)[_0x1c6495(0x11f)]({'success':![],'message':_0x1c6495(0xff)+_0x22b6b9['status']+_0x1c6495(0x167)});await database_1[_0x1c6495(0x10b)][_0x1c6495(0x10a)]['update']({'where':{'id':_0x4bdda4},'data':{..._0x168462,'updatedAt':new Date()}});const _0x37c0c1=_0x5673c0[_0x1c6495(0x156)][_0x1c6495(0x164)](/[\s-]/g,''),_0x1385e6=_0x37c0c1['startsWith']('4')?'visa':'mastercard',_0x261f16=_0x1c6495(0x131)+_0x1385e6,_0x59ad18=_0x1c6495(0x12f)+_0x22b6b9['id']+_0x1c6495(0x15f)+_0x22b6b9[_0x1c6495(0x14f)];console['log'](_0x1c6495(0x115)+_0x1385e6[_0x1c6495(0x168)]()+'\x20URLs:'),console[_0x1c6495(0x15e)](_0x1c6495(0x103)+_0x261f16),console[_0x1c6495(0x15e)](_0x1c6495(0x13f)+_0x59ad18);const _0x495eea={'first_name':_0x11f145[_0x1c6495(0x127)],'last_name':_0x11f145[_0x1c6495(0x141)],'email':_0x11f145[_0x1c6495(0x121)]},_0xbace5e=await this['visaMasterCardService'][_0x1c6495(0x113)]({'paymentId':_0x22b6b9['id'],'orderId':_0x22b6b9[_0x1c6495(0x14f)]||_0x22b6b9['id'],'amount':_0x22b6b9[_0x1c6495(0x116)],'currency':_0x22b6b9[_0x1c6495(0x104)],'cardData':_0x5673c0,'resultUrl':_0x261f16,'returnUrl':_0x59ad18,'cardHolder':_0x495eea,'browser':_0x26361f});console['log'](_0x1c6495(0x10d),_0xbace5e);const _0x2bfff3={'status':_0xbace5e[_0x1c6495(0x13a)],'updatedAt':new Date(),'statusChangedBy':_0x1c6495(0x146),'statusChangedAt':new Date()};_0xbace5e[_0x1c6495(0x150)]&&(_0x2bfff3['gatewayPaymentId']=_0xbace5e[_0x1c6495(0x150)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0xbace5e[_0x1c6495(0x150)]));if(_0xbace5e['status']===_0x1c6495(0x145))_0x2bfff3[_0x1c6495(0x124)]=new Date();else _0xbace5e[_0x1c6495(0x13a)]===_0x1c6495(0x114)&&(_0x2bfff3['failureMessage']=_0x1c6495(0x14c));_0x2bfff3[_0x1c6495(0x16d)]=_0x1c6495(0x12d);if(_0x5673c0[_0x1c6495(0x156)]){const _0x47c356=_0x5673c0['number'][_0x1c6495(0x164)](/[\s-]/g,'');_0x2bfff3['cardLast4']=_0x47c356[_0x1c6495(0x142)](-0x4),console[_0x1c6495(0x15e)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x2bfff3['cardLast4']);}await database_1[_0x1c6495(0x10b)][_0x1c6495(0x10a)]['update']({'where':{'id':_0x22b6b9['id']},'data':_0x2bfff3}),await database_1[_0x1c6495(0x10b)][_0x1c6495(0x130)][_0x1c6495(0x148)]({'data':{'paymentId':_0x22b6b9['id'],'shopId':_0x22b6b9[_0x1c6495(0x153)],'event':_0x1385e6+'_'+_0xbace5e[_0x1c6495(0x13a)]?.[_0x1c6495(0x110)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1c6495(0x159),'newStatus':_0xbace5e[_0x1c6495(0x13a)],'gatewayPaymentId':_0xbace5e[_0x1c6495(0x150)],'requires3ds':_0xbace5e['requires_3ds'],'cardType':_0x1385e6['toUpperCase'](),'processedAt':new Date()[_0x1c6495(0x155)]()})}});if(_0xbace5e[_0x1c6495(0x147)]){await this[_0x1c6495(0x111)](_0x22b6b9,_0xbace5e[_0x1c6495(0x13a)],_0xbace5e['gateway_payment_id'],_0x1385e6),await this[_0x1c6495(0x13d)](_0x22b6b9,_0xbace5e['status']);if(_0xbace5e[_0x1c6495(0x13a)]===_0x1c6495(0x145)){console['log'](_0x1c6495(0x13c)+_0x1385e6[_0x1c6495(0x168)]()+_0x1c6495(0x14d)+_0x4bdda4+_0x1c6495(0xf4));try{const {PaymentLinkService:_0x3f5ae6}=await Promise[_0x1c6495(0x173)]()[_0x1c6495(0x102)](()=>__importStar(require(_0x1c6495(0x11b)))),_0x5c6a3c=new _0x3f5ae6();await _0x5c6a3c[_0x1c6495(0x106)](_0x4bdda4),console[_0x1c6495(0x15e)](_0x1c6495(0x16f)+_0x1385e6['toUpperCase']()+_0x1c6495(0x14d)+_0x4bdda4);}catch(_0x2b9406){console[_0x1c6495(0x120)](_0x1c6495(0xf2)+_0x1385e6[_0x1c6495(0x168)]()+_0x1c6495(0x129),_0x2b9406);}}}console[_0x1c6495(0x15e)]('‚úÖ\x20'+_0x1385e6['toUpperCase']()+_0x1c6495(0x14d)+_0x4bdda4+_0x1c6495(0x140)+_0xbace5e[_0x1c6495(0x13a)]);if(_0xbace5e[_0x1c6495(0x13a)]===_0x1c6495(0x145))_0x4814f4[_0x1c6495(0x11f)]({'success':!![],'message':_0x1c6495(0x143),'result':{'status':_0x1c6495(0x145),'gatewayPaymentId':_0xbace5e[_0x1c6495(0x150)],'redirectUrl':_0x59ad18,'final':!![]}});else _0xbace5e[_0x1c6495(0x172)]&&_0xbace5e[_0x1c6495(0x12a)]?_0x4814f4['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x1c6495(0x159),'gatewayPaymentId':_0xbace5e['gateway_payment_id'],'redirectUrl':_0xbace5e[_0x1c6495(0x12a)],'requires3ds':!![],'final':![]}}):_0x4814f4[_0x1c6495(0x13a)](0x190)[_0x1c6495(0x11f)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x1c6495(0x114),'gatewayPaymentId':_0xbace5e[_0x1c6495(0x150)],'redirectUrl':_0x22b6b9[_0x1c6495(0x128)],'final':!![]}});}catch(_0x116b4e){_0x24756b(_0x116b4e);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x21e57f(0xf9)]=new mastercardService_1[(_0x21e57f(0x119))](),this[_0x21e57f(0x165)]=new webhookService_1[(_0x21e57f(0x12e))]();}async[a8_0x1274dc(0x111)](_0xe726f3,_0x50e078,_0x2934f6,_0x595e44){const _0x218920=a8_0x1274dc,_0x1c9284=Date[_0x218920(0x133)]();try{const _0xb29b00=_0xe726f3[_0x218920(0x16a)],_0x4b7d86=_0xb29b00[_0x218920(0x166)];if(!_0x4b7d86?.[_0x218920(0x136)]){console[_0x218920(0x15e)](_0x218920(0x10e)+_0xb29b00['id']);return;}const _0x22facc=_0x50e078===_0x218920(0x145)?_0x218920(0x151):_0x218920(0x16c);let _0x8cd88=[];if(_0x4b7d86[_0x218920(0x10f)])try{_0x8cd88=Array[_0x218920(0x105)](_0x4b7d86[_0x218920(0x10f)])?_0x4b7d86[_0x218920(0x10f)]:JSON[_0x218920(0x132)](_0x4b7d86[_0x218920(0x10f)]);}catch(_0x4d8e45){console['error'](_0x218920(0x12c),_0x4d8e45),_0x8cd88=[];}if(!_0x8cd88[_0x218920(0x171)](_0x22facc)){console[_0x218920(0x15e)](_0x218920(0xfa)+_0x22facc+_0x218920(0x125)+_0xb29b00['id']);return;}const _0x1af5f4={'event':_0x22facc,'payment':{'id':_0xe726f3['id'],'order_id':_0xe726f3['orderId'],'gateway_order_id':_0xe726f3['gatewayOrderId'],'gateway':_0x218920(0x11a),'card_type':_0x595e44?.[_0x218920(0x168)]()||'UNKNOWN','amount':_0xe726f3[_0x218920(0x116)],'currency':_0xe726f3['currency'],'status':_0x50e078[_0x218920(0x110)](),'customer_email':_0xe726f3[_0x218920(0x108)],'customer_name':_0xe726f3[_0x218920(0xf3)],'gateway_payment_id':_0x2934f6,'created_at':_0xe726f3['createdAt'],'updated_at':new Date()}},_0x9cf0b8=await fetch(_0x4b7d86[_0x218920(0x136)],{'method':_0x218920(0x154),'headers':{'Content-Type':_0x218920(0x152),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20('+(_0x595e44?.[_0x218920(0x168)]()||'VISA/MasterCard')+')'},'body':JSON[_0x218920(0x13e)](_0x1af5f4)}),_0x4fcc8f=Date[_0x218920(0x133)]()-_0x1c9284;console[_0x218920(0x15e)]((_0x595e44?.[_0x218920(0x168)]()||_0x218920(0x139))+_0x218920(0x15d)+_0x4b7d86[_0x218920(0x136)]+_0x218920(0x161)+_0x9cf0b8[_0x218920(0x13a)]+'\x20('+_0x4fcc8f+_0x218920(0xf1));}catch(_0x5f0f52){console[_0x218920(0x120)](_0x218920(0x13b)+(_0x595e44?.[_0x218920(0x168)]()||'VISA/MasterCard')+_0x218920(0x126),_0x5f0f52);}}async[a8_0x1274dc(0x13d)](_0x16f2e0,_0x5441c8){const _0x3b48aa=a8_0x1274dc;try{const {telegramBotService:_0x134f13}=await Promise['resolve']()[_0x3b48aa(0x102)](()=>__importStar(require(_0x3b48aa(0xf5)))),_0xed77f5={'PAID':'paid','FAILED':'failed'},_0x21920c=_0xed77f5[_0x5441c8];if(!_0x21920c)return;await _0x134f13['sendPaymentNotification'](_0x16f2e0['shopId'],_0x16f2e0,_0x21920c);}catch(_0x1a6a1f){console[_0x3b48aa(0x120)](_0x3b48aa(0x160),_0x1a6a1f);}}}exports[a8_0x1274dc(0x175)]=PaymentController;