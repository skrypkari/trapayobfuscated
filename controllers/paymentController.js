'use strict';const a8_0x34f7b1=a8_0x3be2;(function(_0x25c4d5,_0x82bd85){const _0x1d3bc6=a8_0x3be2,_0x3fd71e=_0x25c4d5();while(!![]){try{const _0x1a2399=parseInt(_0x1d3bc6(0xba))/0x1+parseInt(_0x1d3bc6(0x108))/0x2+-parseInt(_0x1d3bc6(0x9e))/0x3+-parseInt(_0x1d3bc6(0xcb))/0x4*(parseInt(_0x1d3bc6(0xc8))/0x5)+parseInt(_0x1d3bc6(0xc1))/0x6*(parseInt(_0x1d3bc6(0xd5))/0x7)+-parseInt(_0x1d3bc6(0xd8))/0x8*(-parseInt(_0x1d3bc6(0xa7))/0x9)+-parseInt(_0x1d3bc6(0xbb))/0xa*(parseInt(_0x1d3bc6(0x104))/0xb);if(_0x1a2399===_0x82bd85)break;else _0x3fd71e['push'](_0x3fd71e['shift']());}catch(_0x5b043a){_0x3fd71e['push'](_0x3fd71e['shift']());}}}(a8_0x52a2,0x8bd92));function a8_0x52a2(){const _0x5b7e4b=['FAILED','email','üí≥\x20MasterCard\x20result:','POST','currency','first_name','sendPaymentNotification','customerEmail','create','payment','\x20processed:\x20','1423893ozDRoN','number','threeds_url','error','get','hasOwnProperty','masterCardService','sendShopWebhook','mastercard_','4029327UnZqSc','toLowerCase','log','default','customerIp','../services/paymentLinkService','createPublicPayment',',\x20cannot\x20process','Failed\x20to\x20send\x20MasterCard\x20webhook:','parse','shopId','now','stringify','üí≥\x20Browser\x20IP:\x20','update','toISOString','Payment\x20failed','body','customerUa','611904kKTged','603650ccBiCV','\x20not\x20enabled\x20for\x20shop\x20','final','PaymentService','then','last_name','6ofXRVE','gateway','params','Card\x20payment\x20failed','getPaymentById','payment.failed','processCardPayment','5095slakNr','amount','configurable','432ckrdHY','failureMessage','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','includes','settings','gateway_payment_id','updatedAt','paidAt','Payment\x20created\x20successfully','PENDING','394961wWKAhg','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','8VKsBeR','failed','webhookUrl','replace','getOwnPropertyNames','user_agent','üí≥\x20Processing\x20MasterCard\x20payment:\x20','üìù\x20Customer\x20data:','MasterCard\x20webhook\x20sent\x20to\x20','\x20\x20\x20Return\x20URL:\x20','sendPaymentStatusNotification','isArray','__importDefault','‚úÖ\x20MasterCard\x20payment\x20','json','webhookLog','webhookEvents','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','Payment\x20processed\x20successfully','failUrl','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','defineProperty','getOwnPropertyDescriptor','gatewayOrderId','updatePaymentCustomerDataPublic','mastercard','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','__setModuleDefault','paymentService','status','prototype','getPaymentStatus','../config/database','gatewayPaymentId','Payment\x20not\x20found','findUnique','PAID','3DS\x20verification\x20required','__importStar','application/json','requires_3ds','__esModule','writable','updatePaymentCustomer','176FZorNL','length','call','customerCountry','2014622kAGSns','shop','PaymentController'];a8_0x52a2=function(){return _0x5b7e4b;};return a8_0x52a2();}var __createBinding=this&&this['__createBinding']||(Object[a8_0x34f7b1(0x9b)]?function(_0x4b47a7,_0x48e25d,_0x701099,_0x2b9519){const _0x1f3c9f=a8_0x34f7b1;if(_0x2b9519===undefined)_0x2b9519=_0x701099;var _0x443eef=Object[_0x1f3c9f(0xee)](_0x48e25d,_0x701099);(!_0x443eef||(_0x1f3c9f(0xa2)in _0x443eef?!_0x48e25d['__esModule']:_0x443eef[_0x1f3c9f(0x102)]||_0x443eef[_0x1f3c9f(0xca)]))&&(_0x443eef={'enumerable':!![],'get':function(){return _0x48e25d[_0x701099];}}),Object[_0x1f3c9f(0xed)](_0x4b47a7,_0x2b9519,_0x443eef);}:function(_0x36f0a6,_0x347623,_0x5ad345,_0x3bcfd9){if(_0x3bcfd9===undefined)_0x3bcfd9=_0x5ad345;_0x36f0a6[_0x3bcfd9]=_0x347623[_0x5ad345];}),__setModuleDefault=this&&this[a8_0x34f7b1(0xf3)]||(Object[a8_0x34f7b1(0x9b)]?function(_0x2edfdc,_0x2155be){const _0x2c7e7f=a8_0x34f7b1;Object['defineProperty'](_0x2edfdc,_0x2c7e7f(0xaa),{'enumerable':!![],'value':_0x2155be});}:function(_0x4b3549,_0x23b594){const _0x4b7f34=a8_0x34f7b1;_0x4b3549[_0x4b7f34(0xaa)]=_0x23b594;}),__importStar=this&&this[a8_0x34f7b1(0xfe)]||(function(){var _0x507faf=function(_0x4fcaf0){const _0x427ed8=a8_0x3be2;return _0x507faf=Object[_0x427ed8(0xdc)]||function(_0x5d0f67){const _0x188379=_0x427ed8;var _0x132e7d=[];for(var _0x462f7d in _0x5d0f67)if(Object[_0x188379(0xf6)][_0x188379(0xa3)][_0x188379(0x106)](_0x5d0f67,_0x462f7d))_0x132e7d[_0x132e7d[_0x188379(0x105)]]=_0x462f7d;return _0x132e7d;},_0x507faf(_0x4fcaf0);};return function(_0x1c763a){const _0x7514b4=a8_0x3be2;if(_0x1c763a&&_0x1c763a[_0x7514b4(0x101)])return _0x1c763a;var _0x491d06={};if(_0x1c763a!=null){for(var _0x1f7d39=_0x507faf(_0x1c763a),_0x2f80b7=0x0;_0x2f80b7<_0x1f7d39[_0x7514b4(0x105)];_0x2f80b7++)if(_0x1f7d39[_0x2f80b7]!==_0x7514b4(0xaa))__createBinding(_0x491d06,_0x1c763a,_0x1f7d39[_0x2f80b7]);}return __setModuleDefault(_0x491d06,_0x1c763a),_0x491d06;};}()),__importDefault=this&&this[a8_0x34f7b1(0xe4)]||function(_0x1c6215){const _0x5e8eba=a8_0x34f7b1;return _0x1c6215&&_0x1c6215[_0x5e8eba(0x101)]?_0x1c6215:{'default':_0x1c6215};};Object[a8_0x34f7b1(0xed)](exports,a8_0x34f7b1(0x101),{'value':!![]}),exports[a8_0x34f7b1(0x10a)]=void 0x0;function a8_0x3be2(_0x3535ff,_0x306ea9){const _0x52a2f7=a8_0x52a2();return a8_0x3be2=function(_0x3be282,_0x1ad535){_0x3be282=_0x3be282-0x99;let _0x580c81=_0x52a2f7[_0x3be282];return _0x580c81;},a8_0x3be2(_0x3535ff,_0x306ea9);}const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x34f7b1(0xf8)));class PaymentController{constructor(){const _0x2e016a=a8_0x34f7b1;this[_0x2e016a(0xad)]=async(_0xebb56,_0x2b2a9a,_0x8509aa)=>{const _0x19dead=_0x2e016a;try{const _0x5f56d1=_0xebb56[_0x19dead(0xb8)],_0x592346=await this[_0x19dead(0xf4)][_0x19dead(0xad)](_0x5f56d1);_0x2b2a9a[_0x19dead(0xf5)](0xc9)[_0x19dead(0xe6)]({'success':!![],'message':_0x19dead(0xd3),'result':_0x592346});}catch(_0x25262b){_0x8509aa(_0x25262b);}},this['getPaymentStatus']=async(_0x18100a,_0x4c0d14,_0x35f5e2)=>{const _0x40be1a=_0x2e016a;try{const {id:_0x282711}=_0x18100a['params'],_0x5d2883=await this['paymentService'][_0x40be1a(0xf7)](_0x282711);if(!_0x5d2883)return _0x4c0d14['status'](0x194)[_0x40be1a(0xe6)]({'success':![],'message':_0x40be1a(0xfa)});_0x4c0d14[_0x40be1a(0xe6)]({'success':!![],'result':_0x5d2883});}catch(_0x5aa93d){_0x35f5e2(_0x5aa93d);}},this[_0x2e016a(0xc5)]=async(_0x871c39,_0x2066af,_0x397252)=>{const _0xd05caf=_0x2e016a;try{const {id:_0x36ab77}=_0x871c39[_0xd05caf(0xc3)],_0x423594=await this['paymentService'][_0xd05caf(0xc5)](_0x36ab77);if(!_0x423594)return _0x2066af[_0xd05caf(0xf5)](0x194)[_0xd05caf(0xe6)]({'success':![],'message':_0xd05caf(0xfa)});_0x2066af['json']({'success':!![],'result':_0x423594});}catch(_0x16ddfe){_0x397252(_0x16ddfe);}},this[_0x2e016a(0x103)]=async(_0x419df4,_0x10fe61,_0x3430d8)=>{const _0x43681c=_0x2e016a;try{const {id:_0x215c2a}=_0x419df4['params'],_0x197495=_0x419df4[_0x43681c(0xb8)];console[_0x43681c(0xa9)](_0x43681c(0xec)+_0x215c2a),console[_0x43681c(0xa9)](_0x43681c(0xdf),_0x197495);const _0xa64402=await this[_0x43681c(0xf4)][_0x43681c(0xf0)](_0x215c2a,_0x197495);if(!_0xa64402)return _0x10fe61['status'](0x194)['json']({'success':![],'message':_0x43681c(0xfa)});_0x10fe61[_0x43681c(0xe6)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0xa64402['id'],'customerIp':_0xa64402[_0x43681c(0xab)],'customerUa':_0xa64402[_0x43681c(0xb9)],'customerCountry':_0xa64402[_0x43681c(0x107)],'updatedAt':_0xa64402[_0x43681c(0xd1)]}});}catch(_0x34f601){_0x3430d8(_0x34f601);}},this['processMasterCardPayment']=async(_0xe5fdb3,_0x53ecf2,_0x191eef)=>{const _0xc9b3fd=_0x2e016a;try{const {id:_0x2ef5f2}=_0xe5fdb3[_0xc9b3fd(0xc3)],{cardData:_0x2f4329,cardHolder:_0xb9df42,browser:_0x4d27fb}=_0xe5fdb3[_0xc9b3fd(0xb8)];console['log'](_0xc9b3fd(0xde)+_0x2ef5f2),console[_0xc9b3fd(0xa9)]('üí≥\x20Card\x20holder:\x20'+_0xb9df42['first_name']+'\x20'+_0xb9df42[_0xc9b3fd(0xc0)]+'\x20('+_0xb9df42[_0xc9b3fd(0x10c)]+')'),console[_0xc9b3fd(0xa9)](_0xc9b3fd(0xb4)+_0x4d27fb['ip']);const _0x482b07={'customerName':_0xb9df42[_0xc9b3fd(0x110)]+'\x20'+_0xb9df42[_0xc9b3fd(0xc0)],'customerEmail':_0xb9df42[_0xc9b3fd(0x10c)],'customerIp':_0x4d27fb['ip'],'customerUa':_0x4d27fb[_0xc9b3fd(0xdd)]},_0x5c2d4c=await database_1[_0xc9b3fd(0xaa)][_0xc9b3fd(0x9c)][_0xc9b3fd(0xfb)]({'where':{'id':_0x2ef5f2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c2d4c)return _0x53ecf2[_0xc9b3fd(0xf5)](0x194)['json']({'success':![],'message':_0xc9b3fd(0xfa)});if(_0x5c2d4c[_0xc9b3fd(0xc2)]!==_0xc9b3fd(0xf1))return _0x53ecf2['status'](0x190)[_0xc9b3fd(0xe6)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x5c2d4c[_0xc9b3fd(0xf5)]!==_0xc9b3fd(0xd4))return _0x53ecf2['status'](0x190)[_0xc9b3fd(0xe6)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x5c2d4c[_0xc9b3fd(0xf5)]+_0xc9b3fd(0xae)});await database_1[_0xc9b3fd(0xaa)]['payment'][_0xc9b3fd(0xb5)]({'where':{'id':_0x2ef5f2},'data':{..._0x482b07,'updatedAt':new Date()}});const _0x17f8e4='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x3fb4ea=_0x5c2d4c['successUrl'];console[_0xc9b3fd(0xa9)]('üí≥\x20MasterCard\x20URLs:'),console[_0xc9b3fd(0xa9)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x17f8e4),console[_0xc9b3fd(0xa9)](_0xc9b3fd(0xe1)+_0x3fb4ea);const _0x509191={'first_name':_0xb9df42[_0xc9b3fd(0x110)],'last_name':_0xb9df42[_0xc9b3fd(0xc0)],'email':_0xb9df42[_0xc9b3fd(0x10c)]},_0x1a7237=await this[_0xc9b3fd(0xa4)][_0xc9b3fd(0xc7)]({'paymentId':_0x5c2d4c['id'],'orderId':_0x5c2d4c[_0xc9b3fd(0xef)]||_0x5c2d4c['id'],'amount':_0x5c2d4c[_0xc9b3fd(0xc9)],'currency':_0x5c2d4c[_0xc9b3fd(0x10f)],'cardData':_0x2f4329,'resultUrl':_0x17f8e4,'returnUrl':_0x3fb4ea,'cardHolder':_0x509191,'browser':_0x4d27fb});console['log'](_0xc9b3fd(0x10d),_0x1a7237);const _0x2581d5={'status':_0x1a7237[_0xc9b3fd(0xf5)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x1a7237[_0xc9b3fd(0xd0)]&&(_0x2581d5[_0xc9b3fd(0xf9)]=_0x1a7237[_0xc9b3fd(0xd0)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x1a7237[_0xc9b3fd(0xd0)]));if(_0x1a7237[_0xc9b3fd(0xf5)]===_0xc9b3fd(0xfc))_0x2581d5[_0xc9b3fd(0xd2)]=new Date();else _0x1a7237[_0xc9b3fd(0xf5)]===_0xc9b3fd(0x10b)&&(_0x2581d5[_0xc9b3fd(0xcc)]=_0xc9b3fd(0xc4));_0x2581d5['paymentMethod']=_0xc9b3fd(0xf1);if(_0x2f4329[_0xc9b3fd(0x9f)]){const _0x363880=_0x2f4329[_0xc9b3fd(0x9f)][_0xc9b3fd(0xdb)](/[\s-]/g,'');_0x2581d5['cardLast4']=_0x363880['slice'](-0x4),console['log'](_0xc9b3fd(0xcd)+_0x2581d5['cardLast4']);}await database_1[_0xc9b3fd(0xaa)][_0xc9b3fd(0x9c)][_0xc9b3fd(0xb5)]({'where':{'id':_0x5c2d4c['id']},'data':_0x2581d5}),await database_1[_0xc9b3fd(0xaa)][_0xc9b3fd(0xe7)][_0xc9b3fd(0x9b)]({'data':{'paymentId':_0x5c2d4c['id'],'shopId':_0x5c2d4c['shopId'],'event':_0xc9b3fd(0xa6)+_0x1a7237[_0xc9b3fd(0xf5)]?.[_0xc9b3fd(0xa8)](),'statusCode':0xc8,'responseBody':JSON[_0xc9b3fd(0xb3)]({'oldStatus':'PENDING','newStatus':_0x1a7237[_0xc9b3fd(0xf5)],'gatewayPaymentId':_0x1a7237[_0xc9b3fd(0xd0)],'requires3ds':_0x1a7237[_0xc9b3fd(0x100)],'processedAt':new Date()[_0xc9b3fd(0xb6)]()})}});if(_0x1a7237[_0xc9b3fd(0xbd)]){await this[_0xc9b3fd(0xa5)](_0x5c2d4c,_0x1a7237[_0xc9b3fd(0xf5)],_0x1a7237[_0xc9b3fd(0xd0)]),await this[_0xc9b3fd(0xe2)](_0x5c2d4c,_0x1a7237['status']);if(_0x1a7237[_0xc9b3fd(0xf5)]===_0xc9b3fd(0xfc)){console[_0xc9b3fd(0xa9)]('üìà\x20MasterCard\x20payment\x20'+_0x2ef5f2+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x2b4cb7}=await Promise['resolve']()[_0xc9b3fd(0xbf)](()=>__importStar(require(_0xc9b3fd(0xac)))),_0x554027=new _0x2b4cb7();await _0x554027['handleSuccessfulPayment'](_0x2ef5f2),console[_0xc9b3fd(0xa9)](_0xc9b3fd(0xf2)+_0x2ef5f2);}catch(_0x34668f){console[_0xc9b3fd(0xa1)](_0xc9b3fd(0xe9),_0x34668f);}}}console[_0xc9b3fd(0xa9)](_0xc9b3fd(0xe5)+_0x2ef5f2+_0xc9b3fd(0x9d)+_0x1a7237[_0xc9b3fd(0xf5)]);if(_0x1a7237[_0xc9b3fd(0xf5)]===_0xc9b3fd(0xfc))_0x53ecf2[_0xc9b3fd(0xe6)]({'success':!![],'message':_0xc9b3fd(0xea),'result':{'status':_0xc9b3fd(0xfc),'gatewayPaymentId':_0x1a7237[_0xc9b3fd(0xd0)],'redirectUrl':_0x3fb4ea,'final':!![]}});else _0x1a7237[_0xc9b3fd(0x100)]&&_0x1a7237[_0xc9b3fd(0xa0)]?_0x53ecf2[_0xc9b3fd(0xe6)]({'success':!![],'message':_0xc9b3fd(0xfd),'result':{'status':_0xc9b3fd(0xd4),'gatewayPaymentId':_0x1a7237['gateway_payment_id'],'redirectUrl':_0x1a7237[_0xc9b3fd(0xa0)],'requires3ds':!![],'final':![]}}):_0x53ecf2['status'](0x190)[_0xc9b3fd(0xe6)]({'success':![],'message':_0xc9b3fd(0xb7),'result':{'status':'FAILED','gatewayPaymentId':_0x1a7237[_0xc9b3fd(0xd0)],'redirectUrl':_0x5c2d4c[_0xc9b3fd(0xeb)],'final':!![]}});}catch(_0x615929){_0x191eef(_0x615929);}},this[_0x2e016a(0xf4)]=new paymentService_1[(_0x2e016a(0xbe))](),this['masterCardService']=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x34f7b1(0xa5)](_0x2f2fbe,_0x196eac,_0x43a598){const _0x5f9785=a8_0x34f7b1,_0x265695=Date[_0x5f9785(0xb2)]();try{const _0x52f18a=_0x2f2fbe[_0x5f9785(0x109)],_0x145b07=_0x52f18a[_0x5f9785(0xcf)];if(!_0x145b07?.['webhookUrl']){console[_0x5f9785(0xa9)](_0x5f9785(0xd7)+_0x52f18a['id']);return;}const _0x14bdcf=_0x196eac==='PAID'?'payment.success':_0x5f9785(0xc6);let _0x259c26=[];if(_0x145b07[_0x5f9785(0xe8)])try{_0x259c26=Array[_0x5f9785(0xe3)](_0x145b07['webhookEvents'])?_0x145b07['webhookEvents']:JSON[_0x5f9785(0xb0)](_0x145b07[_0x5f9785(0xe8)]);}catch(_0x15f88e){console[_0x5f9785(0xa1)]('Error\x20parsing\x20webhook\x20events:',_0x15f88e),_0x259c26=[];}if(!_0x259c26[_0x5f9785(0xce)](_0x14bdcf)){console[_0x5f9785(0xa9)]('Webhook\x20event\x20'+_0x14bdcf+_0x5f9785(0xbc)+_0x52f18a['id']);return;}const _0x140db4={'event':_0x14bdcf,'payment':{'id':_0x2f2fbe['id'],'order_id':_0x2f2fbe['orderId'],'gateway_order_id':_0x2f2fbe[_0x5f9785(0xef)],'gateway':'1111','amount':_0x2f2fbe[_0x5f9785(0xc9)],'currency':_0x2f2fbe[_0x5f9785(0x10f)],'status':_0x196eac[_0x5f9785(0xa8)](),'customer_email':_0x2f2fbe[_0x5f9785(0x9a)],'customer_name':_0x2f2fbe['customerName'],'gateway_payment_id':_0x43a598,'created_at':_0x2f2fbe['createdAt'],'updated_at':new Date()}},_0x2dc887=await fetch(_0x145b07[_0x5f9785(0xda)],{'method':_0x5f9785(0x10e),'headers':{'Content-Type':_0x5f9785(0xff),'User-Agent':_0x5f9785(0xd6)},'body':JSON[_0x5f9785(0xb3)](_0x140db4)}),_0x1ea75e=Date[_0x5f9785(0xb2)]()-_0x265695;console[_0x5f9785(0xa9)](_0x5f9785(0xe0)+_0x145b07[_0x5f9785(0xda)]+'\x20with\x20status\x20'+_0x2dc887[_0x5f9785(0xf5)]+'\x20('+_0x1ea75e+'ms)');}catch(_0xd947cc){console[_0x5f9785(0xa1)](_0x5f9785(0xaf),_0xd947cc);}}async[a8_0x34f7b1(0xe2)](_0x1bc910,_0x22072b){const _0x54b903=a8_0x34f7b1;try{const {telegramBotService:_0x4ef181}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x244cd8={'PAID':'paid','FAILED':_0x54b903(0xd9)},_0x198b87=_0x244cd8[_0x22072b];if(!_0x198b87)return;await _0x4ef181[_0x54b903(0x99)](_0x1bc910[_0x54b903(0xb1)],_0x1bc910,_0x198b87);}catch(_0x4164a8){console[_0x54b903(0xa1)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4164a8);}}}exports['PaymentController']=PaymentController;