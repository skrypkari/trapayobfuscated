'use strict';const a8_0x26ac92=a8_0x51ed;function a8_0x51ed(_0x33e022,_0x379457){const _0x31965b=a8_0x3196();return a8_0x51ed=function(_0x51ed5d,_0x4281c0){_0x51ed5d=_0x51ed5d-0xe3;let _0x5af583=_0x31965b[_0x51ed5d];return _0x5af583;},a8_0x51ed(_0x33e022,_0x379457);}(function(_0x6977c4,_0x2e4395){const _0x1ad156=a8_0x51ed,_0x203786=_0x6977c4();while(!![]){try{const _0x38a728=parseInt(_0x1ad156(0x137))/0x1*(-parseInt(_0x1ad156(0xf9))/0x2)+-parseInt(_0x1ad156(0xec))/0x3*(-parseInt(_0x1ad156(0x129))/0x4)+parseInt(_0x1ad156(0x140))/0x5*(-parseInt(_0x1ad156(0x11c))/0x6)+parseInt(_0x1ad156(0xff))/0x7+-parseInt(_0x1ad156(0x14c))/0x8+-parseInt(_0x1ad156(0x13f))/0x9*(-parseInt(_0x1ad156(0xf4))/0xa)+-parseInt(_0x1ad156(0x13d))/0xb*(-parseInt(_0x1ad156(0x11d))/0xc);if(_0x38a728===_0x2e4395)break;else _0x203786['push'](_0x203786['shift']());}catch(_0x15432){_0x203786['push'](_0x203786['shift']());}}}(a8_0x3196,0x2eda7));function a8_0x3196(){const _0x2ac675=['__esModule','PAID','masterCardService','threeds_url','application/json','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','customerEmail','webhookService','Error\x20parsing\x20webhook\x20events:','create','3207kXHcbr','createdAt','stringify','findUnique','amount','parse','11LpnqHX','__setModuleDefault','450IMBNuC','32260pFgtPD','3DS\x20verification\x20required','update','../config/database','Customer\x20data\x20updated\x20successfully','error','paymentMethod','length','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','updatedAt','PENDING','resolve','1873288DOsucv','hasOwnProperty','__createBinding','__importStar','default','failUrl','system','PaymentController','get','now','getPaymentStatus','\x20\x20\x20Result\x20URL\x20(webhook):\x20','\x20\x20\x20Return\x20URL:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','176034kDiXTy','webhookEvents','payment','processMasterCardPayment','processCardPayment','../services/webhookService','final','customerIp','43440lUXcre','customerName','json','FAILED','status','102aHayAm','params','webhookLog','defineProperty','successUrl','\x20processed:\x20','1912463HMKcyt','MasterCard\x20webhook\x20sent\x20to\x20','log','1111','toLowerCase','mastercard','gateway_payment_id','getOwnPropertyDescriptor','shopId','failureMessage','webhookUrl','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','✅\x20MasterCard\x20payment\x20','currency','orderId','Payment\x20failed','__importDefault','failed','💳\x20Processing\x20MasterCard\x20payment:\x20','../services/paymentService','getPaymentById','body','Payment\x20created\x20successfully','getOwnPropertyNames','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerUa','configurable','💳\x20MasterCard\x20URLs:','Payment\x20not\x20found','204ooimeX','1710648jdPWAq','gateway','../services/telegramBotService','MasterCardService','POST','payment.success','call','settings','updatePaymentCustomerDataPublic','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','requires_3ds','Payment\x20processed\x20successfully','12IAVfiD',',\x20cannot\x20process','paymentService','includes'];a8_0x3196=function(){return _0x2ac675;};return a8_0x3196();}var __createBinding=this&&this[a8_0x26ac92(0x14e)]||(Object[a8_0x26ac92(0x136)]?function(_0x45a20c,_0x15edb5,_0x22cf4d,_0x292121){const _0x3755c6=a8_0x26ac92;if(_0x292121===undefined)_0x292121=_0x22cf4d;var _0x5038df=Object[_0x3755c6(0x106)](_0x15edb5,_0x22cf4d);(!_0x5038df||(_0x3755c6(0xe6)in _0x5038df?!_0x15edb5[_0x3755c6(0x12d)]:_0x5038df['writable']||_0x5038df[_0x3755c6(0x119)]))&&(_0x5038df={'enumerable':!![],'get':function(){return _0x15edb5[_0x22cf4d];}}),Object[_0x3755c6(0xfc)](_0x45a20c,_0x292121,_0x5038df);}:function(_0x2f913e,_0x1cd4e2,_0x5983f1,_0x4538eb){if(_0x4538eb===undefined)_0x4538eb=_0x5983f1;_0x2f913e[_0x4538eb]=_0x1cd4e2[_0x5983f1];}),__setModuleDefault=this&&this[a8_0x26ac92(0x13e)]||(Object['create']?function(_0xf02127,_0x20bb8d){const _0x499d2d=a8_0x26ac92;Object[_0x499d2d(0xfc)](_0xf02127,'default',{'enumerable':!![],'value':_0x20bb8d});}:function(_0xb4a845,_0x2c013b){_0xb4a845['default']=_0x2c013b;}),__importStar=this&&this[a8_0x26ac92(0x14f)]||(function(){var _0x2da36d=function(_0x3dd983){const _0x4be6b5=a8_0x51ed;return _0x2da36d=Object[_0x4be6b5(0x116)]||function(_0x1090cf){const _0x565d0c=_0x4be6b5;var _0x3e54f6=[];for(var _0x22ed0d in _0x1090cf)if(Object['prototype'][_0x565d0c(0x14d)][_0x565d0c(0x123)](_0x1090cf,_0x22ed0d))_0x3e54f6[_0x3e54f6[_0x565d0c(0x147)]]=_0x22ed0d;return _0x3e54f6;},_0x2da36d(_0x3dd983);};return function(_0x4a9312){const _0x4d3561=a8_0x51ed;if(_0x4a9312&&_0x4a9312[_0x4d3561(0x12d)])return _0x4a9312;var _0x5af42b={};if(_0x4a9312!=null){for(var _0x11dab3=_0x2da36d(_0x4a9312),_0x4fe04a=0x0;_0x4fe04a<_0x11dab3['length'];_0x4fe04a++)if(_0x11dab3[_0x4fe04a]!==_0x4d3561(0x150))__createBinding(_0x5af42b,_0x4a9312,_0x11dab3[_0x4fe04a]);}return __setModuleDefault(_0x5af42b,_0x4a9312),_0x5af42b;};}()),__importDefault=this&&this[a8_0x26ac92(0x10f)]||function(_0x5992cd){const _0x33774b=a8_0x26ac92;return _0x5992cd&&_0x5992cd[_0x33774b(0x12d)]?_0x5992cd:{'default':_0x5992cd};};Object[a8_0x26ac92(0xfc)](exports,'__esModule',{'value':!![]}),exports[a8_0x26ac92(0xe5)]=void 0x0;const paymentService_1=require(a8_0x26ac92(0x112)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x26ac92(0xf1)),database_1=__importDefault(require(a8_0x26ac92(0x143)));class PaymentController{constructor(){const _0x47f7fc=a8_0x26ac92;this['createPublicPayment']=async(_0x3a2b2d,_0x5040ee,_0x512023)=>{const _0x1ffe5d=a8_0x51ed;try{const _0x435754=_0x3a2b2d['body'],_0x1fc591=await this[_0x1ffe5d(0x12b)]['createPublicPayment'](_0x435754);_0x5040ee[_0x1ffe5d(0xf8)](0xc9)[_0x1ffe5d(0xf6)]({'success':!![],'message':_0x1ffe5d(0x115),'result':_0x1fc591});}catch(_0x5801f9){_0x512023(_0x5801f9);}},this[_0x47f7fc(0xe8)]=async(_0x5e3cec,_0x12cb12,_0x1fbe95)=>{const _0x48e4ca=_0x47f7fc;try{const {id:_0x40bdc8}=_0x5e3cec[_0x48e4ca(0xfa)],_0xba4d14=await this[_0x48e4ca(0x12b)][_0x48e4ca(0xe8)](_0x40bdc8);if(!_0xba4d14)return _0x12cb12[_0x48e4ca(0xf8)](0x194)[_0x48e4ca(0xf6)]({'success':![],'message':_0x48e4ca(0x11b)});_0x12cb12[_0x48e4ca(0xf6)]({'success':!![],'result':_0xba4d14});}catch(_0x287188){_0x1fbe95(_0x287188);}},this[_0x47f7fc(0x113)]=async(_0x1b5940,_0x2cd091,_0x184cdd)=>{const _0x5b4ebe=_0x47f7fc;try{const {id:_0x4e200d}=_0x1b5940['params'],_0x5b7174=await this['paymentService'][_0x5b4ebe(0x113)](_0x4e200d);if(!_0x5b7174)return _0x2cd091['status'](0x194)[_0x5b4ebe(0xf6)]({'success':![],'message':'Payment\x20not\x20found'});_0x2cd091['json']({'success':!![],'result':_0x5b7174});}catch(_0x20be48){_0x184cdd(_0x20be48);}},this['updatePaymentCustomer']=async(_0x577eda,_0x1e962b,_0x536db5)=>{const _0x5b857d=_0x47f7fc;try{const {id:_0x7997f0}=_0x577eda[_0x5b857d(0xfa)],_0x57fdae=_0x577eda[_0x5b857d(0x114)];console[_0x5b857d(0x101)](_0x5b857d(0x148)+_0x7997f0),console[_0x5b857d(0x101)]('📝\x20Customer\x20data:',_0x57fdae);const _0x277e52=await this[_0x5b857d(0x12b)][_0x5b857d(0x125)](_0x7997f0,_0x57fdae);if(!_0x277e52)return _0x1e962b[_0x5b857d(0xf8)](0x194)[_0x5b857d(0xf6)]({'success':![],'message':_0x5b857d(0x11b)});_0x1e962b[_0x5b857d(0xf6)]({'success':!![],'message':_0x5b857d(0x144),'result':{'paymentId':_0x277e52['id'],'customerIp':_0x277e52[_0x5b857d(0xf3)],'customerUa':_0x277e52[_0x5b857d(0x118)],'customerCountry':_0x277e52['customerCountry'],'updatedAt':_0x277e52[_0x5b857d(0x149)]}});}catch(_0x560bc3){_0x536db5(_0x560bc3);}},this[_0x47f7fc(0xef)]=async(_0x1048f2,_0x1482e5,_0x39e563)=>{const _0x3886f6=_0x47f7fc;try{const {id:_0x358c63}=_0x1048f2[_0x3886f6(0xfa)],{cardData:_0x39918d,cardHolder:_0x3a7caa,browser:_0x24adb8}=_0x1048f2[_0x3886f6(0x114)];console[_0x3886f6(0x101)](_0x3886f6(0x111)+_0x358c63);const _0x167649=await database_1[_0x3886f6(0x150)][_0x3886f6(0xee)][_0x3886f6(0x13a)]({'where':{'id':_0x358c63},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x167649)return _0x1482e5[_0x3886f6(0xf8)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x167649[_0x3886f6(0x11e)]!==_0x3886f6(0x104))return _0x1482e5[_0x3886f6(0xf8)](0x190)[_0x3886f6(0xf6)]({'success':![],'message':_0x3886f6(0x10a)});if(_0x167649[_0x3886f6(0xf8)]!==_0x3886f6(0x14a))return _0x1482e5[_0x3886f6(0xf8)](0x190)['json']({'success':![],'message':'Payment\x20status\x20is\x20'+_0x167649['status']+_0x3886f6(0x12a)});const _0x1d5861='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x18bd40=_0x167649[_0x3886f6(0xfd)];console[_0x3886f6(0x101)](_0x3886f6(0x11a)),console[_0x3886f6(0x101)](_0x3886f6(0xe9)+_0x1d5861),console['log'](_0x3886f6(0xea)+_0x18bd40);const _0x11d520=await this['masterCardService'][_0x3886f6(0xf0)]({'paymentId':_0x167649['id'],'orderId':_0x167649['gatewayOrderId']||_0x167649['id'],'amount':_0x167649['amount'],'currency':_0x167649['currency'],'cardData':_0x39918d,'resultUrl':_0x1d5861,'returnUrl':_0x18bd40,'cardHolder':_0x3a7caa,'browser':_0x24adb8});console[_0x3886f6(0x101)]('💳\x20MasterCard\x20result:',_0x11d520);const _0x344985={'status':_0x11d520['status'],'updatedAt':new Date(),'statusChangedBy':_0x3886f6(0xe4),'statusChangedAt':new Date()};if(_0x11d520['status']===_0x3886f6(0x12e))_0x344985['paidAt']=new Date(),_0x344985['gatewayPaymentId']=_0x11d520['gateway_payment_id'];else _0x11d520['status']===_0x3886f6(0xf7)&&(_0x344985[_0x3886f6(0x108)]='Card\x20payment\x20failed');_0x344985[_0x3886f6(0x146)]=_0x3886f6(0x104),await database_1[_0x3886f6(0x150)][_0x3886f6(0xee)][_0x3886f6(0x142)]({'where':{'id':_0x167649['id']},'data':_0x344985}),await database_1[_0x3886f6(0x150)][_0x3886f6(0xfb)][_0x3886f6(0x136)]({'data':{'paymentId':_0x167649['id'],'shopId':_0x167649[_0x3886f6(0x107)],'event':'mastercard_'+_0x11d520[_0x3886f6(0xf8)]?.[_0x3886f6(0x103)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x3886f6(0x14a),'newStatus':_0x11d520[_0x3886f6(0xf8)],'gatewayPaymentId':_0x11d520[_0x3886f6(0x105)],'requires3ds':_0x11d520[_0x3886f6(0x127)],'processedAt':new Date()['toISOString']()})}});_0x11d520[_0x3886f6(0xf2)]&&(await this['sendShopWebhook'](_0x167649,_0x11d520[_0x3886f6(0xf8)],_0x11d520[_0x3886f6(0x105)]),await this['sendPaymentStatusNotification'](_0x167649,_0x11d520[_0x3886f6(0xf8)]));console['log'](_0x3886f6(0x10b)+_0x358c63+_0x3886f6(0xfe)+_0x11d520[_0x3886f6(0xf8)]);if(_0x11d520['status']==='PAID')_0x1482e5[_0x3886f6(0xf6)]({'success':!![],'message':_0x3886f6(0x128),'result':{'status':_0x3886f6(0x12e),'gatewayPaymentId':_0x11d520[_0x3886f6(0x105)],'redirectUrl':_0x18bd40,'final':!![]}});else _0x11d520['requires_3ds']&&_0x11d520[_0x3886f6(0x130)]?_0x1482e5[_0x3886f6(0xf6)]({'success':!![],'message':_0x3886f6(0x141),'result':{'status':_0x3886f6(0x14a),'gatewayPaymentId':_0x11d520[_0x3886f6(0x105)],'redirectUrl':_0x11d520[_0x3886f6(0x130)],'requires3ds':!![],'final':![]}}):_0x1482e5[_0x3886f6(0xf8)](0x190)[_0x3886f6(0xf6)]({'success':![],'message':_0x3886f6(0x10e),'result':{'status':_0x3886f6(0xf7),'gatewayPaymentId':_0x11d520['gateway_payment_id'],'redirectUrl':_0x167649[_0x3886f6(0xe3)],'final':!![]}});}catch(_0x5b01bc){_0x39e563(_0x5b01bc);}},this[_0x47f7fc(0x12b)]=new paymentService_1['PaymentService'](),this[_0x47f7fc(0x12f)]=new mastercardService_1[(_0x47f7fc(0x120))](),this[_0x47f7fc(0x134)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x50111c,_0x164fba,_0x291856){const _0x308f85=a8_0x26ac92,_0x4b062a=Date['now']();try{const _0xfb7a64=_0x50111c['shop'],_0x49d8f0=_0xfb7a64[_0x308f85(0x124)];if(!_0x49d8f0?.[_0x308f85(0x109)]){console['log'](_0x308f85(0x132)+_0xfb7a64['id']);return;}const _0x517f44=_0x164fba==='PAID'?_0x308f85(0x122):'payment.failed';let _0x22a35a=[];if(_0x49d8f0[_0x308f85(0xed)])try{_0x22a35a=Array['isArray'](_0x49d8f0['webhookEvents'])?_0x49d8f0[_0x308f85(0xed)]:JSON[_0x308f85(0x13c)](_0x49d8f0['webhookEvents']);}catch(_0x5ddcb2){console['error'](_0x308f85(0x135),_0x5ddcb2),_0x22a35a=[];}if(!_0x22a35a[_0x308f85(0x12c)](_0x517f44)){console[_0x308f85(0x101)]('Webhook\x20event\x20'+_0x517f44+'\x20not\x20enabled\x20for\x20shop\x20'+_0xfb7a64['id']);return;}const _0x39fd61={'event':_0x517f44,'payment':{'id':_0x50111c['id'],'order_id':_0x50111c[_0x308f85(0x10d)],'gateway_order_id':_0x50111c['gatewayOrderId'],'gateway':_0x308f85(0x102),'amount':_0x50111c[_0x308f85(0x13b)],'currency':_0x50111c[_0x308f85(0x10c)],'status':_0x164fba[_0x308f85(0x103)](),'customer_email':_0x50111c[_0x308f85(0x133)],'customer_name':_0x50111c[_0x308f85(0xf5)],'gateway_payment_id':_0x291856,'created_at':_0x50111c[_0x308f85(0x138)],'updated_at':new Date()}},_0x56ddc2=await fetch(_0x49d8f0['webhookUrl'],{'method':_0x308f85(0x121),'headers':{'Content-Type':_0x308f85(0x131),'User-Agent':_0x308f85(0x126)},'body':JSON[_0x308f85(0x139)](_0x39fd61)}),_0x42b6a6=Date[_0x308f85(0xe7)]()-_0x4b062a;console[_0x308f85(0x101)](_0x308f85(0x100)+_0x49d8f0['webhookUrl']+'\x20with\x20status\x20'+_0x56ddc2['status']+'\x20('+_0x42b6a6+'ms)');}catch(_0xc25b29){console[_0x308f85(0x145)](_0x308f85(0xeb),_0xc25b29);}}async['sendPaymentStatusNotification'](_0x2eddf5,_0x5752ca){const _0x315401=a8_0x26ac92;try{const {telegramBotService:_0x2119ff}=await Promise[_0x315401(0x14b)]()['then'](()=>__importStar(require(_0x315401(0x11f)))),_0x351884={'PAID':'paid','FAILED':_0x315401(0x110)},_0x4a4163=_0x351884[_0x5752ca];if(!_0x4a4163)return;await _0x2119ff['sendPaymentNotification'](_0x2eddf5[_0x315401(0x107)],_0x2eddf5,_0x4a4163);}catch(_0x3b77e5){console[_0x315401(0x145)](_0x315401(0x117),_0x3b77e5);}}}exports[a8_0x26ac92(0xe5)]=PaymentController;