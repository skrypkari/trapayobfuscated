'use strict';const a8_0x1f40dd=a8_0x3145;function a8_0x3145(_0x2c4bc5,_0x15d83b){const _0x56bc40=a8_0x56bc();return a8_0x3145=function(_0x314556,_0x214139){_0x314556=_0x314556-0x194;let _0x3aca99=_0x56bc40[_0x314556];return _0x3aca99;},a8_0x3145(_0x2c4bc5,_0x15d83b);}(function(_0x15f694,_0x5bd35d){const _0x2d2f5a=a8_0x3145,_0x2a8674=_0x15f694();while(!![]){try{const _0x5b2a13=-parseInt(_0x2d2f5a(0x19b))/0x1*(-parseInt(_0x2d2f5a(0x1bd))/0x2)+parseInt(_0x2d2f5a(0x1ad))/0x3*(-parseInt(_0x2d2f5a(0x1ae))/0x4)+parseInt(_0x2d2f5a(0x1fc))/0x5+-parseInt(_0x2d2f5a(0x1d5))/0x6*(-parseInt(_0x2d2f5a(0x1f5))/0x7)+parseInt(_0x2d2f5a(0x1ba))/0x8+-parseInt(_0x2d2f5a(0x1f7))/0x9+parseInt(_0x2d2f5a(0x1b1))/0xa*(-parseInt(_0x2d2f5a(0x1f2))/0xb);if(_0x5b2a13===_0x5bd35d)break;else _0x2a8674['push'](_0x2a8674['shift']());}catch(_0x38d333){_0x2a8674['push'](_0x2a8674['shift']());}}}(a8_0x56bc,0x1f9e0));function a8_0x56bc(){const _0xdbacbe=['createdAt','shopId','getPaymentStatus','createPublicPayment','MasterCard\x20webhook\x20sent\x20to\x20','paid','../services/telegramBotService','processCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','../services/webhookService','amount','\x20\x20\x20Result\x20URL\x20(webhook):\x20','__setModuleDefault','__createBinding','paidAt','59xWSjcz','__esModule','gateway_payment_id','Payment\x20not\x20found','webhookEvents','\x20processed:\x20','‚úÖ\x20MasterCard\x20payment\x20','update','ms)','findUnique','body','prototype','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','application/json','customerEmail','../services/gateways/mastercardService','POST','mastercard','3imsAlp','565636qzCNDD','orderId','failUrl','2330CkIthC','currency','masterCardService','toLowerCase','FAILED','PENDING','webhookUrl','paymentService','length','43536yHBipE','\x20with\x20status\x20','customerName','7816leaRjm','üìù\x20Customer\x20data:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20failed','defineProperty','resolve','../services/paymentService','sendPaymentNotification','gatewayOrderId','payment.success','getPaymentById','json','Error\x20parsing\x20webhook\x20events:','üí≥\x20Processing\x20MasterCard\x20payment:\x20','Payment\x20status\x20is\x20','Card\x20payment\x20failed','\x20\x20\x20Return\x20URL:\x20','settings','Payment\x20processed\x20successfully','processMasterCardPayment','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','Failed\x20to\x20send\x20MasterCard\x20webhook:','__importDefault','6slVQOP','sendPaymentStatusNotification','system','getOwnPropertyDescriptor','PAID','../config/database','customerIp','customerUa','includes','now','paymentMethod','sendShopWebhook','final','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failed','error','payment.failed','payment','updatedAt','gateway','then','log','create','üí≥\x20MasterCard\x20URLs:','webhookLog','default','hasOwnProperty','3DS\x20verification\x20required','status','5302rKTfsZ','MasterCardService','stringify','618373ZqAWbG','failureMessage','359280ZkNLUc','mastercard_','threeds_url','__importStar','Payment\x20created\x20successfully','493930wLjfXR','getOwnPropertyNames','üí≥\x20MasterCard\x20result:','params','Webhook\x20event\x20','PaymentController','call','PaymentService','Customer\x20data\x20updated\x20successfully'];a8_0x56bc=function(){return _0xdbacbe;};return a8_0x56bc();}var __createBinding=this&&this[a8_0x1f40dd(0x199)]||(Object[a8_0x1f40dd(0x1eb)]?function(_0x1c4d7f,_0x43a467,_0x27c010,_0x521316){const _0x243018=a8_0x1f40dd;if(_0x521316===undefined)_0x521316=_0x27c010;var _0x5b1e43=Object[_0x243018(0x1d8)](_0x43a467,_0x27c010);(!_0x5b1e43||('get'in _0x5b1e43?!_0x43a467[_0x243018(0x19c)]:_0x5b1e43['writable']||_0x5b1e43['configurable']))&&(_0x5b1e43={'enumerable':!![],'get':function(){return _0x43a467[_0x27c010];}}),Object['defineProperty'](_0x1c4d7f,_0x521316,_0x5b1e43);}:function(_0x3db8c6,_0x31c2be,_0x518b13,_0x1d855e){if(_0x1d855e===undefined)_0x1d855e=_0x518b13;_0x3db8c6[_0x1d855e]=_0x31c2be[_0x518b13];}),__setModuleDefault=this&&this[a8_0x1f40dd(0x198)]||(Object['create']?function(_0x2c0db3,_0x5cd75d){const _0x43763a=a8_0x1f40dd;Object[_0x43763a(0x1c2)](_0x2c0db3,_0x43763a(0x1ee),{'enumerable':!![],'value':_0x5cd75d});}:function(_0x833068,_0x3cea48){const _0xf2cf48=a8_0x1f40dd;_0x833068[_0xf2cf48(0x1ee)]=_0x3cea48;}),__importStar=this&&this[a8_0x1f40dd(0x1fa)]||(function(){var _0x3ce351=function(_0x44a3dd){const _0x55eb5b=a8_0x3145;return _0x3ce351=Object[_0x55eb5b(0x1fd)]||function(_0x31bcb3){const _0x276939=_0x55eb5b;var _0x206254=[];for(var _0x3d995b in _0x31bcb3)if(Object[_0x276939(0x1a6)][_0x276939(0x1ef)][_0x276939(0x202)](_0x31bcb3,_0x3d995b))_0x206254[_0x206254[_0x276939(0x1b9)]]=_0x3d995b;return _0x206254;},_0x3ce351(_0x44a3dd);};return function(_0x52f746){const _0x4ba279=a8_0x3145;if(_0x52f746&&_0x52f746[_0x4ba279(0x19c)])return _0x52f746;var _0x557c00={};if(_0x52f746!=null){for(var _0x50d16e=_0x3ce351(_0x52f746),_0x58f964=0x0;_0x58f964<_0x50d16e[_0x4ba279(0x1b9)];_0x58f964++)if(_0x50d16e[_0x58f964]!==_0x4ba279(0x1ee))__createBinding(_0x557c00,_0x52f746,_0x50d16e[_0x58f964]);}return __setModuleDefault(_0x557c00,_0x52f746),_0x557c00;};}()),__importDefault=this&&this[a8_0x1f40dd(0x1d4)]||function(_0x5adb3f){const _0x1bcaaa=a8_0x1f40dd;return _0x5adb3f&&_0x5adb3f[_0x1bcaaa(0x19c)]?_0x5adb3f:{'default':_0x5adb3f};};Object[a8_0x1f40dd(0x1c2)](exports,'__esModule',{'value':!![]}),exports[a8_0x1f40dd(0x201)]=void 0x0;const paymentService_1=require(a8_0x1f40dd(0x1c4)),mastercardService_1=require(a8_0x1f40dd(0x1aa)),webhookService_1=require(a8_0x1f40dd(0x195)),database_1=__importDefault(require(a8_0x1f40dd(0x1da)));class PaymentController{constructor(){const _0x11e805=a8_0x1f40dd;this[_0x11e805(0x208)]=async(_0x17054c,_0x5a8bc0,_0x156f97)=>{const _0x361cef=_0x11e805;try{const _0x2c54f0=_0x17054c['body'],_0x14dfc5=await this[_0x361cef(0x1b8)][_0x361cef(0x208)](_0x2c54f0);_0x5a8bc0['status'](0xc9)['json']({'success':!![],'message':_0x361cef(0x1fb),'result':_0x14dfc5});}catch(_0x8f8713){_0x156f97(_0x8f8713);}},this[_0x11e805(0x207)]=async(_0x58281d,_0x51dce4,_0x5438d0)=>{const _0x25bd3d=_0x11e805;try{const {id:_0x20a12b}=_0x58281d['params'],_0x6eb139=await this[_0x25bd3d(0x1b8)][_0x25bd3d(0x207)](_0x20a12b);if(!_0x6eb139)return _0x51dce4[_0x25bd3d(0x1f1)](0x194)[_0x25bd3d(0x1c9)]({'success':![],'message':_0x25bd3d(0x19e)});_0x51dce4[_0x25bd3d(0x1c9)]({'success':!![],'result':_0x6eb139});}catch(_0xb35bfc){_0x5438d0(_0xb35bfc);}},this[_0x11e805(0x1c8)]=async(_0x392b02,_0x1942bf,_0x1d8b42)=>{const _0x25fd25=_0x11e805;try{const {id:_0x521de0}=_0x392b02[_0x25fd25(0x1ff)],_0x5b625d=await this[_0x25fd25(0x1b8)]['getPaymentById'](_0x521de0);if(!_0x5b625d)return _0x1942bf[_0x25fd25(0x1f1)](0x194)[_0x25fd25(0x1c9)]({'success':![],'message':_0x25fd25(0x19e)});_0x1942bf[_0x25fd25(0x1c9)]({'success':!![],'result':_0x5b625d});}catch(_0xafbf8f){_0x1d8b42(_0xafbf8f);}},this['updatePaymentCustomer']=async(_0x453b2d,_0x253fd0,_0x8f87ca)=>{const _0x455afd=_0x11e805;try{const {id:_0x3d4111}=_0x453b2d[_0x455afd(0x1ff)],_0x24185a=_0x453b2d[_0x455afd(0x1a5)];console['log']('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x3d4111),console[_0x455afd(0x1ea)](_0x455afd(0x1be),_0x24185a);const _0xc0b451=await this[_0x455afd(0x1b8)]['updatePaymentCustomerDataPublic'](_0x3d4111,_0x24185a);if(!_0xc0b451)return _0x253fd0[_0x455afd(0x1f1)](0x194)[_0x455afd(0x1c9)]({'success':![],'message':'Payment\x20not\x20found'});_0x253fd0[_0x455afd(0x1c9)]({'success':!![],'message':_0x455afd(0x204),'result':{'paymentId':_0xc0b451['id'],'customerIp':_0xc0b451[_0x455afd(0x1db)],'customerUa':_0xc0b451[_0x455afd(0x1dc)],'customerCountry':_0xc0b451['customerCountry'],'updatedAt':_0xc0b451[_0x455afd(0x1e7)]}});}catch(_0x59dd98){_0x8f87ca(_0x59dd98);}},this[_0x11e805(0x1d1)]=async(_0x359b72,_0x3893db,_0x5d14e3)=>{const _0x168598=_0x11e805;try{const {id:_0x1358ae}=_0x359b72[_0x168598(0x1ff)],{cardData:_0x570d62,cardHolder:_0x242b1c,browser:_0x1777f2}=_0x359b72[_0x168598(0x1a5)];console[_0x168598(0x1ea)](_0x168598(0x1cb)+_0x1358ae);const _0x22175f=await database_1[_0x168598(0x1ee)][_0x168598(0x1e6)][_0x168598(0x1a4)]({'where':{'id':_0x1358ae},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22175f)return _0x3893db[_0x168598(0x1f1)](0x194)[_0x168598(0x1c9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x22175f[_0x168598(0x1e8)]!==_0x168598(0x1ac))return _0x3893db[_0x168598(0x1f1)](0x190)[_0x168598(0x1c9)]({'success':![],'message':_0x168598(0x1d2)});if(_0x22175f[_0x168598(0x1f1)]!=='PENDING')return _0x3893db[_0x168598(0x1f1)](0x190)['json']({'success':![],'message':_0x168598(0x1cc)+_0x22175f[_0x168598(0x1f1)]+',\x20cannot\x20process'});const _0x53e637=_0x168598(0x194),_0x312b36=_0x22175f['successUrl'];console[_0x168598(0x1ea)](_0x168598(0x1ec)),console[_0x168598(0x1ea)](_0x168598(0x197)+_0x53e637),console[_0x168598(0x1ea)](_0x168598(0x1ce)+_0x312b36);const _0x10c0cd=await this[_0x168598(0x1b3)][_0x168598(0x20c)]({'paymentId':_0x22175f['id'],'orderId':_0x22175f[_0x168598(0x1c6)]||_0x22175f['id'],'amount':_0x22175f[_0x168598(0x196)],'currency':_0x22175f[_0x168598(0x1b2)],'cardData':_0x570d62,'resultUrl':_0x53e637,'returnUrl':_0x312b36,'cardHolder':_0x242b1c,'browser':_0x1777f2});console[_0x168598(0x1ea)](_0x168598(0x1fe),_0x10c0cd);const _0x169291={'status':_0x10c0cd[_0x168598(0x1f1)],'updatedAt':new Date(),'statusChangedBy':_0x168598(0x1d7),'statusChangedAt':new Date()};if(_0x10c0cd[_0x168598(0x1f1)]===_0x168598(0x1d9))_0x169291[_0x168598(0x19a)]=new Date(),_0x169291['gatewayPaymentId']=_0x10c0cd['gateway_payment_id'];else _0x10c0cd['status']===_0x168598(0x1b5)&&(_0x169291[_0x168598(0x1f6)]=_0x168598(0x1cd));_0x169291[_0x168598(0x1df)]=_0x168598(0x1ac),await database_1[_0x168598(0x1ee)][_0x168598(0x1e6)][_0x168598(0x1a2)]({'where':{'id':_0x22175f['id']},'data':_0x169291}),await database_1[_0x168598(0x1ee)][_0x168598(0x1ed)][_0x168598(0x1eb)]({'data':{'paymentId':_0x22175f['id'],'shopId':_0x22175f[_0x168598(0x206)],'event':_0x168598(0x1f8)+_0x10c0cd[_0x168598(0x1f1)]?.[_0x168598(0x1b4)](),'statusCode':0xc8,'responseBody':JSON[_0x168598(0x1f4)]({'oldStatus':_0x168598(0x1b6),'newStatus':_0x10c0cd[_0x168598(0x1f1)],'gatewayPaymentId':_0x10c0cd[_0x168598(0x19d)],'requires3ds':_0x10c0cd['requires_3ds'],'processedAt':new Date()['toISOString']()})}});_0x10c0cd[_0x168598(0x1e1)]&&(await this[_0x168598(0x1e0)](_0x22175f,_0x10c0cd[_0x168598(0x1f1)],_0x10c0cd[_0x168598(0x19d)]),await this[_0x168598(0x1d6)](_0x22175f,_0x10c0cd[_0x168598(0x1f1)]));console[_0x168598(0x1ea)](_0x168598(0x1a1)+_0x1358ae+_0x168598(0x1a0)+_0x10c0cd[_0x168598(0x1f1)]);if(_0x10c0cd[_0x168598(0x1f1)]===_0x168598(0x1d9))_0x3893db[_0x168598(0x1c9)]({'success':!![],'message':_0x168598(0x1d0),'result':{'status':_0x168598(0x1d9),'gatewayPaymentId':_0x10c0cd['gateway_payment_id'],'redirectUrl':_0x312b36,'final':!![]}});else _0x10c0cd['requires_3ds']&&_0x10c0cd['threeds_url']?_0x3893db[_0x168598(0x1c9)]({'success':!![],'message':_0x168598(0x1f0),'result':{'status':_0x168598(0x1b6),'gatewayPaymentId':_0x10c0cd['gateway_payment_id'],'redirectUrl':_0x10c0cd[_0x168598(0x1f9)],'requires3ds':!![],'final':![]}}):_0x3893db['status'](0x190)['json']({'success':![],'message':_0x168598(0x1c1),'result':{'status':_0x168598(0x1b5),'gatewayPaymentId':_0x10c0cd[_0x168598(0x19d)],'redirectUrl':_0x22175f[_0x168598(0x1b0)],'final':!![]}});}catch(_0x5e908b){_0x5d14e3(_0x5e908b);}},this[_0x11e805(0x1b8)]=new paymentService_1[(_0x11e805(0x203))](),this[_0x11e805(0x1b3)]=new mastercardService_1[(_0x11e805(0x1f3))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x1f40dd(0x1e0)](_0x2e8dde,_0xdca30d,_0x5e0318){const _0x3f1d0b=a8_0x1f40dd,_0x373061=Date[_0x3f1d0b(0x1de)]();try{const _0x4ec7c6=_0x2e8dde['shop'],_0x2f78fb=_0x4ec7c6[_0x3f1d0b(0x1cf)];if(!_0x2f78fb?.[_0x3f1d0b(0x1b7)]){console[_0x3f1d0b(0x1ea)](_0x3f1d0b(0x1e2)+_0x4ec7c6['id']);return;}const _0x3a569=_0xdca30d==='PAID'?_0x3f1d0b(0x1c7):_0x3f1d0b(0x1e5);let _0x1df041=[];if(_0x2f78fb[_0x3f1d0b(0x19f)])try{_0x1df041=Array['isArray'](_0x2f78fb[_0x3f1d0b(0x19f)])?_0x2f78fb['webhookEvents']:JSON['parse'](_0x2f78fb['webhookEvents']);}catch(_0x4e63e1){console[_0x3f1d0b(0x1e4)](_0x3f1d0b(0x1ca),_0x4e63e1),_0x1df041=[];}if(!_0x1df041[_0x3f1d0b(0x1dd)](_0x3a569)){console[_0x3f1d0b(0x1ea)](_0x3f1d0b(0x200)+_0x3a569+_0x3f1d0b(0x1c0)+_0x4ec7c6['id']);return;}const _0xc9e9ff={'event':_0x3a569,'payment':{'id':_0x2e8dde['id'],'order_id':_0x2e8dde[_0x3f1d0b(0x1af)],'gateway_order_id':_0x2e8dde[_0x3f1d0b(0x1c6)],'gateway':'1111','amount':_0x2e8dde[_0x3f1d0b(0x196)],'currency':_0x2e8dde['currency'],'status':_0xdca30d['toLowerCase'](),'customer_email':_0x2e8dde[_0x3f1d0b(0x1a9)],'customer_name':_0x2e8dde[_0x3f1d0b(0x1bc)],'gateway_payment_id':_0x5e0318,'created_at':_0x2e8dde[_0x3f1d0b(0x205)],'updated_at':new Date()}},_0x5b47fe=await fetch(_0x2f78fb[_0x3f1d0b(0x1b7)],{'method':_0x3f1d0b(0x1ab),'headers':{'Content-Type':_0x3f1d0b(0x1a8),'User-Agent':_0x3f1d0b(0x1bf)},'body':JSON[_0x3f1d0b(0x1f4)](_0xc9e9ff)}),_0x79205d=Date[_0x3f1d0b(0x1de)]()-_0x373061;console[_0x3f1d0b(0x1ea)](_0x3f1d0b(0x209)+_0x2f78fb[_0x3f1d0b(0x1b7)]+_0x3f1d0b(0x1bb)+_0x5b47fe[_0x3f1d0b(0x1f1)]+'\x20('+_0x79205d+_0x3f1d0b(0x1a3));}catch(_0xf554af){console[_0x3f1d0b(0x1e4)](_0x3f1d0b(0x1d3),_0xf554af);}}async[a8_0x1f40dd(0x1d6)](_0x220348,_0x3c34c1){const _0x55cc8e=a8_0x1f40dd;try{const {telegramBotService:_0x32327b}=await Promise[_0x55cc8e(0x1c3)]()[_0x55cc8e(0x1e9)](()=>__importStar(require(_0x55cc8e(0x20b)))),_0x52335d={'PAID':_0x55cc8e(0x20a),'FAILED':_0x55cc8e(0x1e3)},_0x44aad0=_0x52335d[_0x3c34c1];if(!_0x44aad0)return;await _0x32327b[_0x55cc8e(0x1c5)](_0x220348[_0x55cc8e(0x206)],_0x220348,_0x44aad0);}catch(_0x2957d4){console[_0x55cc8e(0x1e4)](_0x55cc8e(0x1a7),_0x2957d4);}}}exports[a8_0x1f40dd(0x201)]=PaymentController;