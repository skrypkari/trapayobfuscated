'use strict';const a8_0x49372c=a8_0x3a63;(function(_0x3edad7,_0x40c5e5){const _0x13c169=a8_0x3a63,_0x4da1f4=_0x3edad7();while(!![]){try{const _0x552df0=parseInt(_0x13c169(0x16f))/0x1+-parseInt(_0x13c169(0x145))/0x2*(-parseInt(_0x13c169(0x14c))/0x3)+-parseInt(_0x13c169(0x119))/0x4*(parseInt(_0x13c169(0x107))/0x5)+-parseInt(_0x13c169(0x133))/0x6*(-parseInt(_0x13c169(0x108))/0x7)+-parseInt(_0x13c169(0x10e))/0x8+parseInt(_0x13c169(0x13e))/0x9+parseInt(_0x13c169(0x154))/0xa;if(_0x552df0===_0x40c5e5)break;else _0x4da1f4['push'](_0x4da1f4['shift']());}catch(_0x34d867){_0x4da1f4['push'](_0x4da1f4['shift']());}}}(a8_0x23b0,0x31389));function a8_0x3a63(_0x2dc7ff,_0x37c054){const _0x23b086=a8_0x23b0();return a8_0x3a63=function(_0x3a6380,_0x30abfb){_0x3a6380=_0x3a6380-0x100;let _0x338291=_0x23b086[_0x3a6380];return _0x338291;},a8_0x3a63(_0x2dc7ff,_0x37c054);}var __createBinding=this&&this['__createBinding']||(Object[a8_0x49372c(0x104)]?function(_0x8c6349,_0x4268b4,_0x291d78,_0x5eb7dc){const _0x575855=a8_0x49372c;if(_0x5eb7dc===undefined)_0x5eb7dc=_0x291d78;var _0x45cd63=Object[_0x575855(0x12d)](_0x4268b4,_0x291d78);(!_0x45cd63||(_0x575855(0x139)in _0x45cd63?!_0x4268b4[_0x575855(0x140)]:_0x45cd63[_0x575855(0x10c)]||_0x45cd63[_0x575855(0x137)]))&&(_0x45cd63={'enumerable':!![],'get':function(){return _0x4268b4[_0x291d78];}}),Object[_0x575855(0x12c)](_0x8c6349,_0x5eb7dc,_0x45cd63);}:function(_0x4984ef,_0x962c2e,_0x2a568a,_0x248c4b){if(_0x248c4b===undefined)_0x248c4b=_0x2a568a;_0x4984ef[_0x248c4b]=_0x962c2e[_0x2a568a];}),__setModuleDefault=this&&this[a8_0x49372c(0x138)]||(Object[a8_0x49372c(0x104)]?function(_0x426ac8,_0x21abee){const _0x342486=a8_0x49372c;Object[_0x342486(0x12c)](_0x426ac8,_0x342486(0x136),{'enumerable':!![],'value':_0x21abee});}:function(_0x487537,_0x936441){const _0x5cf249=a8_0x49372c;_0x487537[_0x5cf249(0x136)]=_0x936441;}),__importStar=this&&this[a8_0x49372c(0x151)]||(function(){var _0x2349c1=function(_0xd6a15c){const _0x19b67f=a8_0x3a63;return _0x2349c1=Object[_0x19b67f(0x115)]||function(_0x45251d){const _0x4df5bf=_0x19b67f;var _0x268639=[];for(var _0x155ef6 in _0x45251d)if(Object[_0x4df5bf(0x11b)]['hasOwnProperty'][_0x4df5bf(0x142)](_0x45251d,_0x155ef6))_0x268639[_0x268639[_0x4df5bf(0x118)]]=_0x155ef6;return _0x268639;},_0x2349c1(_0xd6a15c);};return function(_0x865ab8){const _0x495b22=a8_0x3a63;if(_0x865ab8&&_0x865ab8[_0x495b22(0x140)])return _0x865ab8;var _0x3a1209={};if(_0x865ab8!=null){for(var _0x18301e=_0x2349c1(_0x865ab8),_0x7057be=0x0;_0x7057be<_0x18301e[_0x495b22(0x118)];_0x7057be++)if(_0x18301e[_0x7057be]!==_0x495b22(0x136))__createBinding(_0x3a1209,_0x865ab8,_0x18301e[_0x7057be]);}return __setModuleDefault(_0x3a1209,_0x865ab8),_0x3a1209;};}()),__importDefault=this&&this[a8_0x49372c(0x10d)]||function(_0x2223b9){return _0x2223b9&&_0x2223b9['__esModule']?_0x2223b9:{'default':_0x2223b9};};Object[a8_0x49372c(0x12c)](exports,'__esModule',{'value':!![]}),exports[a8_0x49372c(0x15a)]=void 0x0;const paymentService_1=require(a8_0x49372c(0x130)),mastercardService_1=require(a8_0x49372c(0x10b)),webhookService_1=require(a8_0x49372c(0x11a)),database_1=__importDefault(require('../config/database'));function a8_0x23b0(){const _0x2a5115=['findUnique','customerName','2660301WktrVs','json','__esModule','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','call','PAID','webhookService','119908VvBzrS','toLowerCase','../services/telegramBotService','log','Unauthorized','customerEmail','Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop','3CHiuRd','PENDING','system','sendPaymentNotification','requires_3ds','__importStar','Card\x20payment\x20failed','Webhook\x20event\x20','4042690RkmVSm','gatewayOrderId','updatePaymentCustomer','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','https://api.trapay.uk/api/webhooks/gateway/mastercard','Failed\x20to\x20send\x20MasterCard\x20webhook:','PaymentController','gatewayPaymentId','stringify','masterCardService','paymentMethod','webhookLog','includes','✅\x20MasterCard\x20payment\x20','getPaymentById','processCardPayment','Payment\x20status\x20is\x20','updatedAt','MasterCard\x20webhook\x20sent\x20to\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','FAILED','updatePaymentCustomerData','settings','1111','now','user','88612skAMkb','shopId','Customer\x20data\x20updated\x20successfully','parse','Payment\x20not\x20found','payment.success','paymentService','threeds_url','then','create','MasterCardService','POST','95DFstmk','427McVZlI','📝\x20Customer\x20data:','payment.failed','../services/gateways/mastercardService','writable','__importDefault','3079760qQaFAq','params','paid','webhookUrl','sendShopWebhook','amount','payment','getOwnPropertyNames','\x20\x20\x20Return\x20URL:\x20','customerCountry','length','80116xSCdRm','../services/webhookService','prototype','createPublicPayment','gateway','error','getPaymentStatus','body','💳\x20MasterCard\x20URLs:','processMasterCardPayment','WebhookService','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','\x20with\x20status\x20','Payment\x20processed\x20successfully','shop','Payment\x20failed','toISOString','mastercard','status','defineProperty','getOwnPropertyDescriptor','gateway_payment_id','customerIp','../services/paymentService','webhookEvents','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','11676qJMILF','failed','sendPaymentStatusNotification','default','configurable','__setModuleDefault','get','currency','createdAt'];a8_0x23b0=function(){return _0x2a5115;};return a8_0x23b0();}class PaymentController{constructor(){const _0x224774=a8_0x49372c;this[_0x224774(0x11c)]=async(_0x5b3fd0,_0x167309,_0x95c8a8)=>{const _0x449c1a=_0x224774;try{const _0x2f2071=_0x5b3fd0[_0x449c1a(0x120)],_0x2e9f6e=await this[_0x449c1a(0x101)][_0x449c1a(0x11c)](_0x2f2071);_0x167309[_0x449c1a(0x12b)](0xc9)['json']({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x2e9f6e});}catch(_0x3f7893){_0x95c8a8(_0x3f7893);}},this['getPaymentStatus']=async(_0x8a1e0b,_0x4d589c,_0x28f05c)=>{const _0x3d93b5=_0x224774;try{const {id:_0x13da29}=_0x8a1e0b[_0x3d93b5(0x10f)],_0x5363dc=await this[_0x3d93b5(0x101)][_0x3d93b5(0x11f)](_0x13da29);if(!_0x5363dc)return _0x4d589c[_0x3d93b5(0x12b)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x4d589c[_0x3d93b5(0x13f)]({'success':!![],'result':_0x5363dc});}catch(_0x5e180b){_0x28f05c(_0x5e180b);}},this['getPaymentById']=async(_0xc99a5,_0x3360a6,_0x492bad)=>{const _0x7dfac4=_0x224774;try{const {id:_0x219bc4}=_0xc99a5[_0x7dfac4(0x10f)],_0xc48d50=await this[_0x7dfac4(0x101)][_0x7dfac4(0x162)](_0x219bc4);if(!_0xc48d50)return _0x3360a6[_0x7dfac4(0x12b)](0x194)[_0x7dfac4(0x13f)]({'success':![],'message':'Payment\x20not\x20found'});_0x3360a6['json']({'success':!![],'result':_0xc48d50});}catch(_0x48de35){_0x492bad(_0x48de35);}},this[_0x224774(0x156)]=async(_0x588891,_0x34d586,_0x261129)=>{const _0xd3016e=_0x224774;try{const {id:_0xf9b9db}=_0x588891['params'],_0x437a5b=_0x588891[_0xd3016e(0x16e)]?.['id'],_0x1d1e1b=_0x588891[_0xd3016e(0x120)];if(!_0x437a5b)return _0x34d586[_0xd3016e(0x12b)](0x191)['json']({'success':![],'message':_0xd3016e(0x149)});console['log'](_0xd3016e(0x124)+_0xf9b9db+',\x20shop:\x20'+_0x437a5b),console[_0xd3016e(0x148)](_0xd3016e(0x109),_0x1d1e1b);const _0x238311=await this['paymentService'][_0xd3016e(0x16a)](_0x437a5b,_0xf9b9db,_0x1d1e1b);if(!_0x238311)return _0x34d586['status'](0x194)[_0xd3016e(0x13f)]({'success':![],'message':_0xd3016e(0x14b)});_0x34d586['json']({'success':!![],'message':_0xd3016e(0x171),'result':{'paymentId':_0x238311['id'],'customerIp':_0x238311[_0xd3016e(0x12f)],'customerUa':_0x238311['customerUa'],'customerCountry':_0x238311[_0xd3016e(0x117)],'updatedAt':_0x238311[_0xd3016e(0x165)]}});}catch(_0x4b46f3){_0x261129(_0x4b46f3);}},this[_0x224774(0x122)]=async(_0x1ac54a,_0x33c82a,_0x14ac4e)=>{const _0x2ce4f0=_0x224774;try{const {id:_0x4ea48b}=_0x1ac54a[_0x2ce4f0(0x10f)],{cardData:_0x2261d5,cardHolder:_0x231525,browser:_0x43038b}=_0x1ac54a[_0x2ce4f0(0x120)];console[_0x2ce4f0(0x148)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x4ea48b);const _0x33a16b=await database_1['default'][_0x2ce4f0(0x114)][_0x2ce4f0(0x13c)]({'where':{'id':_0x4ea48b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x33a16b)return _0x33c82a[_0x2ce4f0(0x12b)](0x194)[_0x2ce4f0(0x13f)]({'success':![],'message':_0x2ce4f0(0x173)});if(_0x33a16b[_0x2ce4f0(0x11d)]!==_0x2ce4f0(0x12a))return _0x33c82a[_0x2ce4f0(0x12b)](0x190)[_0x2ce4f0(0x13f)]({'success':![],'message':_0x2ce4f0(0x141)});if(_0x33a16b[_0x2ce4f0(0x12b)]!==_0x2ce4f0(0x14d))return _0x33c82a[_0x2ce4f0(0x12b)](0x190)[_0x2ce4f0(0x13f)]({'success':![],'message':_0x2ce4f0(0x164)+_0x33a16b['status']+',\x20cannot\x20process'});const _0x103f9a=_0x2ce4f0(0x158),_0x36c30c=_0x33a16b['successUrl'];console[_0x2ce4f0(0x148)](_0x2ce4f0(0x121)),console[_0x2ce4f0(0x148)](_0x2ce4f0(0x167)+_0x103f9a),console[_0x2ce4f0(0x148)](_0x2ce4f0(0x116)+_0x36c30c);const _0x2fc0f6=await this[_0x2ce4f0(0x15d)][_0x2ce4f0(0x163)]({'paymentId':_0x33a16b['id'],'orderId':_0x33a16b[_0x2ce4f0(0x155)]||_0x33a16b['id'],'amount':_0x33a16b[_0x2ce4f0(0x113)],'currency':_0x33a16b[_0x2ce4f0(0x13a)],'cardData':_0x2261d5,'resultUrl':_0x103f9a,'returnUrl':_0x36c30c,'cardHolder':_0x231525,'browser':_0x43038b});console[_0x2ce4f0(0x148)]('💳\x20MasterCard\x20result:',_0x2fc0f6);const _0x4f4393={'status':_0x2fc0f6[_0x2ce4f0(0x12b)],'updatedAt':new Date(),'statusChangedBy':_0x2ce4f0(0x14e),'statusChangedAt':new Date()};if(_0x2fc0f6['status']===_0x2ce4f0(0x143))_0x4f4393['paidAt']=new Date(),_0x4f4393[_0x2ce4f0(0x15b)]=_0x2fc0f6['gateway_payment_id'];else _0x2fc0f6[_0x2ce4f0(0x12b)]===_0x2ce4f0(0x169)&&(_0x4f4393['failureMessage']=_0x2ce4f0(0x152));_0x4f4393[_0x2ce4f0(0x15e)]=_0x2ce4f0(0x12a),await database_1[_0x2ce4f0(0x136)][_0x2ce4f0(0x114)]['update']({'where':{'id':_0x33a16b['id']},'data':_0x4f4393}),await database_1[_0x2ce4f0(0x136)][_0x2ce4f0(0x15f)]['create']({'data':{'paymentId':_0x33a16b['id'],'shopId':_0x33a16b[_0x2ce4f0(0x170)],'event':'mastercard_'+_0x2fc0f6[_0x2ce4f0(0x12b)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2ce4f0(0x15c)]({'oldStatus':'PENDING','newStatus':_0x2fc0f6[_0x2ce4f0(0x12b)],'gatewayPaymentId':_0x2fc0f6[_0x2ce4f0(0x12e)],'requires3ds':_0x2fc0f6[_0x2ce4f0(0x150)],'processedAt':new Date()[_0x2ce4f0(0x129)]()})}});_0x2fc0f6['final']&&(await this[_0x2ce4f0(0x112)](_0x33a16b,_0x2fc0f6[_0x2ce4f0(0x12b)],_0x2fc0f6[_0x2ce4f0(0x12e)]),await this[_0x2ce4f0(0x135)](_0x33a16b,_0x2fc0f6[_0x2ce4f0(0x12b)]));console['log'](_0x2ce4f0(0x161)+_0x4ea48b+'\x20processed:\x20'+_0x2fc0f6[_0x2ce4f0(0x12b)]);if(_0x2fc0f6[_0x2ce4f0(0x12b)]==='PAID')_0x33c82a[_0x2ce4f0(0x13f)]({'success':!![],'message':_0x2ce4f0(0x126),'result':{'status':'PAID','gatewayPaymentId':_0x2fc0f6[_0x2ce4f0(0x12e)],'redirectUrl':_0x36c30c,'final':!![]}});else _0x2fc0f6['requires_3ds']&&_0x2fc0f6[_0x2ce4f0(0x102)]?_0x33c82a[_0x2ce4f0(0x13f)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x2ce4f0(0x14d),'gatewayPaymentId':_0x2fc0f6[_0x2ce4f0(0x12e)],'redirectUrl':_0x2fc0f6['threeds_url'],'requires3ds':!![],'final':![]}}):_0x33c82a['status'](0x190)['json']({'success':![],'message':_0x2ce4f0(0x128),'result':{'status':_0x2ce4f0(0x169),'gatewayPaymentId':_0x2fc0f6['gateway_payment_id'],'redirectUrl':_0x33a16b['failUrl'],'final':!![]}});}catch(_0x16c351){_0x14ac4e(_0x16c351);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x224774(0x15d)]=new mastercardService_1[(_0x224774(0x105))](),this[_0x224774(0x144)]=new webhookService_1[(_0x224774(0x123))]();}async['sendShopWebhook'](_0x3b6aaf,_0xa78af7,_0x584b50){const _0x1ce660=a8_0x49372c,_0x40c20c=Date[_0x1ce660(0x16d)]();try{const _0x388a30=_0x3b6aaf[_0x1ce660(0x127)],_0x2e9979=_0x388a30[_0x1ce660(0x16b)];if(!_0x2e9979?.[_0x1ce660(0x111)]){console[_0x1ce660(0x148)](_0x1ce660(0x157)+_0x388a30['id']);return;}const _0x3f5060=_0xa78af7===_0x1ce660(0x143)?_0x1ce660(0x100):_0x1ce660(0x10a);let _0x3ef2bf=[];if(_0x2e9979['webhookEvents'])try{_0x3ef2bf=Array['isArray'](_0x2e9979[_0x1ce660(0x131)])?_0x2e9979[_0x1ce660(0x131)]:JSON[_0x1ce660(0x172)](_0x2e9979['webhookEvents']);}catch(_0x44e417){console[_0x1ce660(0x11e)]('Error\x20parsing\x20webhook\x20events:',_0x44e417),_0x3ef2bf=[];}if(!_0x3ef2bf[_0x1ce660(0x160)](_0x3f5060)){console[_0x1ce660(0x148)](_0x1ce660(0x153)+_0x3f5060+'\x20not\x20enabled\x20for\x20shop\x20'+_0x388a30['id']);return;}const _0x3bf4a5={'event':_0x3f5060,'payment':{'id':_0x3b6aaf['id'],'order_id':_0x3b6aaf['orderId'],'gateway_order_id':_0x3b6aaf['gatewayOrderId'],'gateway':_0x1ce660(0x16c),'amount':_0x3b6aaf[_0x1ce660(0x113)],'currency':_0x3b6aaf['currency'],'status':_0xa78af7[_0x1ce660(0x146)](),'customer_email':_0x3b6aaf[_0x1ce660(0x14a)],'customer_name':_0x3b6aaf[_0x1ce660(0x13d)],'gateway_payment_id':_0x584b50,'created_at':_0x3b6aaf[_0x1ce660(0x13b)],'updated_at':new Date()}},_0x3fdffe=await fetch(_0x2e9979[_0x1ce660(0x111)],{'method':_0x1ce660(0x106),'headers':{'Content-Type':'application/json','User-Agent':_0x1ce660(0x132)},'body':JSON[_0x1ce660(0x15c)](_0x3bf4a5)}),_0x370351=Date[_0x1ce660(0x16d)]()-_0x40c20c;console[_0x1ce660(0x148)](_0x1ce660(0x166)+_0x2e9979[_0x1ce660(0x111)]+_0x1ce660(0x125)+_0x3fdffe[_0x1ce660(0x12b)]+'\x20('+_0x370351+'ms)');}catch(_0x298871){console[_0x1ce660(0x11e)](_0x1ce660(0x159),_0x298871);}}async[a8_0x49372c(0x135)](_0x585579,_0x3b0de2){const _0x411940=a8_0x49372c;try{const {telegramBotService:_0xaff277}=await Promise['resolve']()[_0x411940(0x103)](()=>__importStar(require(_0x411940(0x147)))),_0x4641b0={'PAID':_0x411940(0x110),'FAILED':_0x411940(0x134)},_0x175f58=_0x4641b0[_0x3b0de2];if(!_0x175f58)return;await _0xaff277[_0x411940(0x14f)](_0x585579[_0x411940(0x170)],_0x585579,_0x175f58);}catch(_0x22d99f){console[_0x411940(0x11e)](_0x411940(0x168),_0x22d99f);}}}exports[a8_0x49372c(0x15a)]=PaymentController;