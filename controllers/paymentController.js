'use strict';const a8_0xe78126=a8_0x1db5;(function(_0x16d917,_0x2a440d){const _0x2c411e=a8_0x1db5,_0xb605ac=_0x16d917();while(!![]){try{const _0x6d01a8=-parseInt(_0x2c411e(0x164))/0x1*(-parseInt(_0x2c411e(0x1c1))/0x2)+-parseInt(_0x2c411e(0x167))/0x3+parseInt(_0x2c411e(0x1a5))/0x4+-parseInt(_0x2c411e(0x150))/0x5*(-parseInt(_0x2c411e(0x19a))/0x6)+-parseInt(_0x2c411e(0x192))/0x7+parseInt(_0x2c411e(0x14a))/0x8*(parseInt(_0x2c411e(0x172))/0x9)+-parseInt(_0x2c411e(0x14f))/0xa*(parseInt(_0x2c411e(0x152))/0xb);if(_0x6d01a8===_0x2a440d)break;else _0xb605ac['push'](_0xb605ac['shift']());}catch(_0x4d5fe9){_0xb605ac['push'](_0xb605ac['shift']());}}}(a8_0x17c9,0xade8b));var __createBinding=this&&this[a8_0xe78126(0x1b3)]||(Object['create']?function(_0x1fd6ca,_0x330265,_0x5b6323,_0xe1c64c){const _0x55131d=a8_0xe78126;if(_0xe1c64c===undefined)_0xe1c64c=_0x5b6323;var _0x5d9a8c=Object[_0x55131d(0x17b)](_0x330265,_0x5b6323);(!_0x5d9a8c||(_0x55131d(0x1a7)in _0x5d9a8c?!_0x330265[_0x55131d(0x1b9)]:_0x5d9a8c[_0x55131d(0x1be)]||_0x5d9a8c[_0x55131d(0x17c)]))&&(_0x5d9a8c={'enumerable':!![],'get':function(){return _0x330265[_0x5b6323];}}),Object[_0x55131d(0x16f)](_0x1fd6ca,_0xe1c64c,_0x5d9a8c);}:function(_0xc5f86d,_0x6e4dcb,_0x31f024,_0x157c9f){if(_0x157c9f===undefined)_0x157c9f=_0x31f024;_0xc5f86d[_0x157c9f]=_0x6e4dcb[_0x31f024];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0xe78126(0x1ad)]?function(_0x11020e,_0x322a1f){const _0x1878ed=a8_0xe78126;Object[_0x1878ed(0x16f)](_0x11020e,_0x1878ed(0x1a4),{'enumerable':!![],'value':_0x322a1f});}:function(_0x923325,_0x2f90d4){const _0x1a404f=a8_0xe78126;_0x923325[_0x1a404f(0x1a4)]=_0x2f90d4;}),__importStar=this&&this['__importStar']||(function(){var _0x553fc4=function(_0x48b7cf){const _0x339312=a8_0x1db5;return _0x553fc4=Object[_0x339312(0x173)]||function(_0x28df9b){const _0x28e6af=_0x339312;var _0x36177b=[];for(var _0x1d0694 in _0x28df9b)if(Object[_0x28e6af(0x159)][_0x28e6af(0x190)][_0x28e6af(0x181)](_0x28df9b,_0x1d0694))_0x36177b[_0x36177b[_0x28e6af(0x180)]]=_0x1d0694;return _0x36177b;},_0x553fc4(_0x48b7cf);};return function(_0x1a3c63){const _0x4d1679=a8_0x1db5;if(_0x1a3c63&&_0x1a3c63['__esModule'])return _0x1a3c63;var _0x19a64a={};if(_0x1a3c63!=null){for(var _0x3e4fae=_0x553fc4(_0x1a3c63),_0x58a487=0x0;_0x58a487<_0x3e4fae[_0x4d1679(0x180)];_0x58a487++)if(_0x3e4fae[_0x58a487]!==_0x4d1679(0x1a4))__createBinding(_0x19a64a,_0x1a3c63,_0x3e4fae[_0x58a487]);}return __setModuleDefault(_0x19a64a,_0x1a3c63),_0x19a64a;};}()),__importDefault=this&&this[a8_0xe78126(0x194)]||function(_0x3420a4){const _0x405d9e=a8_0xe78126;return _0x3420a4&&_0x3420a4[_0x405d9e(0x1b9)]?_0x3420a4:{'default':_0x3420a4};};Object[a8_0xe78126(0x16f)](exports,a8_0xe78126(0x1b9),{'value':!![]}),exports['PaymentController']=void 0x0;function a8_0x17c9(){const _0x4b24cc=['mastercard','gatewayPaymentId','ms)','defineProperty','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','params','9279CKvmbG','getOwnPropertyNames','last_name','FAILED','shop','failureMessage','payment.success','amount','createdAt','getOwnPropertyDescriptor','configurable','Webhook\x20event\x20','then','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','length','call','../services/webhookService','email','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','customerName','isArray','update',',\x20cannot\x20process','failed','mastercard_','resolve','now','💳\x20Card\x20holder:\x20','status','../services/telegramBotService','hasOwnProperty','parse','3203613munXLQ','country','__importDefault','gateway','../services/paymentService','✅\x20MasterCard\x20payment\x20','Payment\x20status\x20is\x20','threeds_url','815544JnePsJ','Card\x20payment\x20failed','PaymentController','cardLast4','slice','sendPaymentNotification','MasterCard\x20webhook\x20sent\x20to\x20','📈\x20MasterCard\x20payment\x20','updatedAt','1111','default','2060536OofEZr','PaymentService','get','getPaymentStatus','final','sendShopWebhook','PAID','stringify','create','PENDING','WebhookService','Payment\x20not\x20found','sendPaymentStatusNotification','webhookUrl','__createBinding','Payment\x20created\x20successfully','webhookEvents','successUrl','error','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','__esModule','customerUa','currency','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','json','writable','gateway_payment_id','payment.failed','1808reObOe','\x20processed:\x20','processMasterCardPayment','updatePaymentCustomerDataPublic','createPublicPayment','includes','replace','10336dqnhIa','orderId','payment','Payment\x20failed','settings','100RRhzud','50afNMPq','number','2888633hZLSWl','../services/gateways/mastercardService','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','toLowerCase','body','system','Error\x20parsing\x20webhook\x20events:','prototype','application/json','\x20\x20\x20Return\x20URL:\x20','gatewayOrderId','log','customerEmail','first_name','shopId','failUrl','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','getPaymentById','1159OYZNlf','masterCardService','customerIp','1374426EebOfc','POST','paymentService','paid','requires_3ds'];a8_0x17c9=function(){return _0x4b24cc;};return a8_0x17c9();}function a8_0x1db5(_0xed715c,_0x5d4309){const _0x17c996=a8_0x17c9();return a8_0x1db5=function(_0x1db548,_0x53a92b){_0x1db548=_0x1db548-0x14a;let _0xaae32d=_0x17c996[_0x1db548];return _0xaae32d;},a8_0x1db5(_0xed715c,_0x5d4309);}const paymentService_1=require(a8_0xe78126(0x196)),mastercardService_1=require(a8_0xe78126(0x153)),webhookService_1=require(a8_0xe78126(0x182)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x37bc16=a8_0xe78126;this['createPublicPayment']=async(_0x309b48,_0x3dfd45,_0x413e1a)=>{const _0x1d627b=a8_0x1db5;try{const _0xa11af8=_0x309b48[_0x1d627b(0x156)],_0xd09d80=await this[_0x1d627b(0x169)][_0x1d627b(0x1c5)](_0xa11af8);_0x3dfd45[_0x1d627b(0x18e)](0xc9)['json']({'success':!![],'message':_0x1d627b(0x1b4),'result':_0xd09d80});}catch(_0x4f2f9b){_0x413e1a(_0x4f2f9b);}},this[_0x37bc16(0x1a8)]=async(_0x452a3f,_0x57abfe,_0x474251)=>{const _0x3c2c72=_0x37bc16;try{const {id:_0x26829a}=_0x452a3f['params'],_0x230db0=await this[_0x3c2c72(0x169)]['getPaymentStatus'](_0x26829a);if(!_0x230db0)return _0x57abfe['status'](0x194)[_0x3c2c72(0x1bd)]({'success':![],'message':_0x3c2c72(0x1b0)});_0x57abfe[_0x3c2c72(0x1bd)]({'success':!![],'result':_0x230db0});}catch(_0x515f62){_0x474251(_0x515f62);}},this[_0x37bc16(0x163)]=async(_0x297fbd,_0x2585e5,_0x2496ba)=>{const _0x24245f=_0x37bc16;try{const {id:_0x59a41a}=_0x297fbd[_0x24245f(0x171)],_0x528dc1=await this[_0x24245f(0x169)][_0x24245f(0x163)](_0x59a41a);if(!_0x528dc1)return _0x2585e5[_0x24245f(0x18e)](0x194)['json']({'success':![],'message':_0x24245f(0x1b0)});_0x2585e5[_0x24245f(0x1bd)]({'success':!![],'result':_0x528dc1});}catch(_0x4f5427){_0x2496ba(_0x4f5427);}},this['updatePaymentCustomer']=async(_0xdc509b,_0x22e111,_0x263d6a)=>{const _0x391218=_0x37bc16;try{const {id:_0x292c53}=_0xdc509b['params'],_0x5bd20f=_0xdc509b[_0x391218(0x156)];console['log']('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x292c53),console['log']('📝\x20Customer\x20data:',_0x5bd20f);const _0xde56ca=await this[_0x391218(0x169)][_0x391218(0x1c4)](_0x292c53,_0x5bd20f);if(!_0xde56ca)return _0x22e111[_0x391218(0x18e)](0x194)[_0x391218(0x1bd)]({'success':![],'message':'Payment\x20not\x20found'});_0x22e111[_0x391218(0x1bd)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0xde56ca['id'],'customerIp':_0xde56ca[_0x391218(0x166)],'customerUa':_0xde56ca[_0x391218(0x1ba)],'customerCountry':_0xde56ca['customerCountry'],'updatedAt':_0xde56ca[_0x391218(0x1a2)]}});}catch(_0x519d9c){_0x263d6a(_0x519d9c);}},this[_0x37bc16(0x1c3)]=async(_0xf1b5f0,_0x435fad,_0x4c9591)=>{const _0x1d788a=_0x37bc16;try{const {id:_0x37cbd6}=_0xf1b5f0[_0x1d788a(0x171)],{cardData:_0x2f5df7,cardHolder:_0x3b59c5,browser:_0x5685ec}=_0xf1b5f0[_0x1d788a(0x156)];console['log']('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x37cbd6),console[_0x1d788a(0x15d)](_0x1d788a(0x18d)+_0x3b59c5[_0x1d788a(0x15f)]+'\x20'+_0x3b59c5[_0x1d788a(0x174)]+'\x20('+_0x3b59c5[_0x1d788a(0x183)]+')'),console['log']('💳\x20Browser\x20IP:\x20'+_0x5685ec['ip']);const _0x308659={'customerName':_0x3b59c5['first_name']+'\x20'+_0x3b59c5[_0x1d788a(0x174)],'customerEmail':_0x3b59c5[_0x1d788a(0x183)],'customerIp':_0x5685ec['ip'],'customerUa':_0x5685ec['user_agent'],'customerCountry':_0x3b59c5[_0x1d788a(0x193)]||null},_0x50b0c7=await database_1[_0x1d788a(0x1a4)][_0x1d788a(0x14c)]['findUnique']({'where':{'id':_0x37cbd6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x50b0c7)return _0x435fad['status'](0x194)[_0x1d788a(0x1bd)]({'success':![],'message':_0x1d788a(0x1b0)});if(_0x50b0c7[_0x1d788a(0x195)]!==_0x1d788a(0x16c))return _0x435fad[_0x1d788a(0x18e)](0x190)[_0x1d788a(0x1bd)]({'success':![],'message':_0x1d788a(0x162)});if(_0x50b0c7[_0x1d788a(0x18e)]!=='PENDING')return _0x435fad[_0x1d788a(0x18e)](0x190)[_0x1d788a(0x1bd)]({'success':![],'message':_0x1d788a(0x198)+_0x50b0c7[_0x1d788a(0x18e)]+_0x1d788a(0x188)});await database_1[_0x1d788a(0x1a4)]['payment'][_0x1d788a(0x187)]({'where':{'id':_0x37cbd6},'data':{..._0x308659,'updatedAt':new Date()}});const _0x3bdc61='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x376d16=_0x50b0c7[_0x1d788a(0x1b6)];console['log']('💳\x20MasterCard\x20URLs:'),console[_0x1d788a(0x15d)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x3bdc61),console[_0x1d788a(0x15d)](_0x1d788a(0x15b)+_0x376d16);const _0x2ab3b7={'first_name':_0x3b59c5[_0x1d788a(0x15f)],'last_name':_0x3b59c5[_0x1d788a(0x174)],'email':_0x3b59c5[_0x1d788a(0x183)]},_0x44ef36=await this[_0x1d788a(0x165)]['processCardPayment']({'paymentId':_0x50b0c7['id'],'orderId':_0x50b0c7[_0x1d788a(0x15c)]||_0x50b0c7['id'],'amount':_0x50b0c7[_0x1d788a(0x179)],'currency':_0x50b0c7['currency'],'cardData':_0x2f5df7,'resultUrl':_0x3bdc61,'returnUrl':_0x376d16,'cardHolder':_0x2ab3b7,'browser':_0x5685ec});console[_0x1d788a(0x15d)]('💳\x20MasterCard\x20result:',_0x44ef36);const _0x417769={'status':_0x44ef36['status'],'updatedAt':new Date(),'statusChangedBy':_0x1d788a(0x157),'statusChangedAt':new Date()};_0x44ef36['gateway_payment_id']&&(_0x417769[_0x1d788a(0x16d)]=_0x44ef36[_0x1d788a(0x1bf)],console['log'](_0x1d788a(0x1b8)+_0x44ef36['gateway_payment_id']));if(_0x44ef36[_0x1d788a(0x18e)]===_0x1d788a(0x1ab))_0x417769['paidAt']=new Date();else _0x44ef36[_0x1d788a(0x18e)]===_0x1d788a(0x175)&&(_0x417769[_0x1d788a(0x177)]=_0x1d788a(0x19b));_0x417769['paymentMethod']='mastercard';if(_0x2f5df7['number']){const _0x454005=_0x2f5df7[_0x1d788a(0x151)][_0x1d788a(0x1c7)](/[\s-]/g,'');_0x417769[_0x1d788a(0x19d)]=_0x454005[_0x1d788a(0x19e)](-0x4),console[_0x1d788a(0x15d)](_0x1d788a(0x170)+_0x417769['cardLast4']);}await database_1[_0x1d788a(0x1a4)][_0x1d788a(0x14c)][_0x1d788a(0x187)]({'where':{'id':_0x50b0c7['id']},'data':_0x417769}),await database_1[_0x1d788a(0x1a4)]['webhookLog']['create']({'data':{'paymentId':_0x50b0c7['id'],'shopId':_0x50b0c7[_0x1d788a(0x160)],'event':_0x1d788a(0x18a)+_0x44ef36[_0x1d788a(0x18e)]?.[_0x1d788a(0x155)](),'statusCode':0xc8,'responseBody':JSON[_0x1d788a(0x1ac)]({'oldStatus':_0x1d788a(0x1ae),'newStatus':_0x44ef36[_0x1d788a(0x18e)],'gatewayPaymentId':_0x44ef36['gateway_payment_id'],'requires3ds':_0x44ef36[_0x1d788a(0x16b)],'processedAt':new Date()['toISOString']()})}});if(_0x44ef36[_0x1d788a(0x1a9)]){await this[_0x1d788a(0x1aa)](_0x50b0c7,_0x44ef36['status'],_0x44ef36[_0x1d788a(0x1bf)]),await this[_0x1d788a(0x1b1)](_0x50b0c7,_0x44ef36['status']);if(_0x44ef36['status']===_0x1d788a(0x1ab)){console[_0x1d788a(0x15d)](_0x1d788a(0x1a1)+_0x37cbd6+_0x1d788a(0x154));try{const {PaymentLinkService:_0x214825}=await Promise[_0x1d788a(0x18b)]()[_0x1d788a(0x17e)](()=>__importStar(require('../services/paymentLinkService'))),_0x5ed194=new _0x214825();await _0x5ed194['handleSuccessfulPayment'](_0x37cbd6),console[_0x1d788a(0x15d)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x37cbd6);}catch(_0x37e312){console[_0x1d788a(0x1b7)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x37e312);}}}console[_0x1d788a(0x15d)](_0x1d788a(0x197)+_0x37cbd6+_0x1d788a(0x1c2)+_0x44ef36[_0x1d788a(0x18e)]);if(_0x44ef36[_0x1d788a(0x18e)]===_0x1d788a(0x1ab))_0x435fad[_0x1d788a(0x1bd)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1d788a(0x1ab),'gatewayPaymentId':_0x44ef36[_0x1d788a(0x1bf)],'redirectUrl':_0x376d16,'final':!![]}});else _0x44ef36[_0x1d788a(0x16b)]&&_0x44ef36['threeds_url']?_0x435fad[_0x1d788a(0x1bd)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x44ef36[_0x1d788a(0x1bf)],'redirectUrl':_0x44ef36[_0x1d788a(0x199)],'requires3ds':!![],'final':![]}}):_0x435fad[_0x1d788a(0x18e)](0x190)['json']({'success':![],'message':_0x1d788a(0x14d),'result':{'status':_0x1d788a(0x175),'gatewayPaymentId':_0x44ef36[_0x1d788a(0x1bf)],'redirectUrl':_0x50b0c7[_0x1d788a(0x161)],'final':!![]}});}catch(_0x2173bf){_0x4c9591(_0x2173bf);}},this[_0x37bc16(0x169)]=new paymentService_1[(_0x37bc16(0x1a6))](),this[_0x37bc16(0x165)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1[(_0x37bc16(0x1af))]();}async[a8_0xe78126(0x1aa)](_0x7bb5a8,_0x87c067,_0x216f9c){const _0x4a6b1f=a8_0xe78126,_0x5579cf=Date[_0x4a6b1f(0x18c)]();try{const _0x288bce=_0x7bb5a8[_0x4a6b1f(0x176)],_0x39c76e=_0x288bce[_0x4a6b1f(0x14e)];if(!_0x39c76e?.['webhookUrl']){console['log'](_0x4a6b1f(0x1bc)+_0x288bce['id']);return;}const _0xb356bd=_0x87c067===_0x4a6b1f(0x1ab)?_0x4a6b1f(0x178):_0x4a6b1f(0x1c0);let _0x2c9517=[];if(_0x39c76e[_0x4a6b1f(0x1b5)])try{_0x2c9517=Array[_0x4a6b1f(0x186)](_0x39c76e[_0x4a6b1f(0x1b5)])?_0x39c76e[_0x4a6b1f(0x1b5)]:JSON[_0x4a6b1f(0x191)](_0x39c76e[_0x4a6b1f(0x1b5)]);}catch(_0x48ebcc){console[_0x4a6b1f(0x1b7)](_0x4a6b1f(0x158),_0x48ebcc),_0x2c9517=[];}if(!_0x2c9517[_0x4a6b1f(0x1c6)](_0xb356bd)){console[_0x4a6b1f(0x15d)](_0x4a6b1f(0x17d)+_0xb356bd+'\x20not\x20enabled\x20for\x20shop\x20'+_0x288bce['id']);return;}const _0x4c53cc={'event':_0xb356bd,'payment':{'id':_0x7bb5a8['id'],'order_id':_0x7bb5a8[_0x4a6b1f(0x14b)],'gateway_order_id':_0x7bb5a8[_0x4a6b1f(0x15c)],'gateway':_0x4a6b1f(0x1a3),'amount':_0x7bb5a8[_0x4a6b1f(0x179)],'currency':_0x7bb5a8[_0x4a6b1f(0x1bb)],'status':_0x87c067[_0x4a6b1f(0x155)](),'customer_email':_0x7bb5a8[_0x4a6b1f(0x15e)],'customer_name':_0x7bb5a8[_0x4a6b1f(0x185)],'gateway_payment_id':_0x216f9c,'created_at':_0x7bb5a8[_0x4a6b1f(0x17a)],'updated_at':new Date()}},_0x4903ca=await fetch(_0x39c76e[_0x4a6b1f(0x1b2)],{'method':_0x4a6b1f(0x168),'headers':{'Content-Type':_0x4a6b1f(0x15a),'User-Agent':_0x4a6b1f(0x17f)},'body':JSON[_0x4a6b1f(0x1ac)](_0x4c53cc)}),_0x4c6879=Date['now']()-_0x5579cf;console[_0x4a6b1f(0x15d)](_0x4a6b1f(0x1a0)+_0x39c76e[_0x4a6b1f(0x1b2)]+'\x20with\x20status\x20'+_0x4903ca[_0x4a6b1f(0x18e)]+'\x20('+_0x4c6879+_0x4a6b1f(0x16e));}catch(_0x5c633e){console[_0x4a6b1f(0x1b7)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x5c633e);}}async[a8_0xe78126(0x1b1)](_0x5c9078,_0x45b41d){const _0x5b6db7=a8_0xe78126;try{const {telegramBotService:_0x6fb6c8}=await Promise['resolve']()[_0x5b6db7(0x17e)](()=>__importStar(require(_0x5b6db7(0x18f)))),_0x35be5a={'PAID':_0x5b6db7(0x16a),'FAILED':_0x5b6db7(0x189)},_0x4235c3=_0x35be5a[_0x45b41d];if(!_0x4235c3)return;await _0x6fb6c8[_0x5b6db7(0x19f)](_0x5c9078[_0x5b6db7(0x160)],_0x5c9078,_0x4235c3);}catch(_0x53f90d){console[_0x5b6db7(0x1b7)](_0x5b6db7(0x184),_0x53f90d);}}}exports[a8_0xe78126(0x19c)]=PaymentController;