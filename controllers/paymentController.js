'use strict';const a8_0xa94ce7=a8_0x6792;(function(_0x5aeb4a,_0x221017){const _0x985c91=a8_0x6792,_0x52b536=_0x5aeb4a();while(!![]){try{const _0x599039=parseInt(_0x985c91(0x151))/0x1+-parseInt(_0x985c91(0x1af))/0x2+-parseInt(_0x985c91(0x170))/0x3*(parseInt(_0x985c91(0x1ac))/0x4)+parseInt(_0x985c91(0x1b1))/0x5*(parseInt(_0x985c91(0x145))/0x6)+parseInt(_0x985c91(0x177))/0x7+parseInt(_0x985c91(0x1be))/0x8*(parseInt(_0x985c91(0x16c))/0x9)+-parseInt(_0x985c91(0x199))/0xa;if(_0x599039===_0x221017)break;else _0x52b536['push'](_0x52b536['shift']());}catch(_0x5af04e){_0x52b536['push'](_0x52b536['shift']());}}}(a8_0x36e7,0xb645c));var __createBinding=this&&this[a8_0xa94ce7(0x1b9)]||(Object[a8_0xa94ce7(0x1a9)]?function(_0x452011,_0x3f1324,_0x54b32b,_0x5889e9){const _0x687fd4=a8_0xa94ce7;if(_0x5889e9===undefined)_0x5889e9=_0x54b32b;var _0x145110=Object['getOwnPropertyDescriptor'](_0x3f1324,_0x54b32b);(!_0x145110||('get'in _0x145110?!_0x3f1324['__esModule']:_0x145110[_0x687fd4(0x153)]||_0x145110['configurable']))&&(_0x145110={'enumerable':!![],'get':function(){return _0x3f1324[_0x54b32b];}}),Object[_0x687fd4(0x16a)](_0x452011,_0x5889e9,_0x145110);}:function(_0x3fbcf9,_0x40be05,_0x13fe04,_0x960940){if(_0x960940===undefined)_0x960940=_0x13fe04;_0x3fbcf9[_0x960940]=_0x40be05[_0x13fe04];}),__setModuleDefault=this&&this[a8_0xa94ce7(0x168)]||(Object[a8_0xa94ce7(0x1a9)]?function(_0x482c05,_0x4ed3db){const _0xfc6c3b=a8_0xa94ce7;Object[_0xfc6c3b(0x16a)](_0x482c05,_0xfc6c3b(0x18f),{'enumerable':!![],'value':_0x4ed3db});}:function(_0x5eb589,_0x5a67b6){const _0x5aca44=a8_0xa94ce7;_0x5eb589[_0x5aca44(0x18f)]=_0x5a67b6;}),__importStar=this&&this['__importStar']||(function(){var _0x2f9158=function(_0x1fa2fa){const _0x4188fd=a8_0x6792;return _0x2f9158=Object[_0x4188fd(0x16d)]||function(_0x16b2e5){const _0x3ffce7=_0x4188fd;var _0x4a801f=[];for(var _0x40f2b6 in _0x16b2e5)if(Object[_0x3ffce7(0x14e)][_0x3ffce7(0x1ae)][_0x3ffce7(0x159)](_0x16b2e5,_0x40f2b6))_0x4a801f[_0x4a801f['length']]=_0x40f2b6;return _0x4a801f;},_0x2f9158(_0x1fa2fa);};return function(_0x1c78d4){const _0x50bd97=a8_0x6792;if(_0x1c78d4&&_0x1c78d4[_0x50bd97(0x14c)])return _0x1c78d4;var _0x35ef93={};if(_0x1c78d4!=null){for(var _0x161407=_0x2f9158(_0x1c78d4),_0x568e0b=0x0;_0x568e0b<_0x161407['length'];_0x568e0b++)if(_0x161407[_0x568e0b]!==_0x50bd97(0x18f))__createBinding(_0x35ef93,_0x1c78d4,_0x161407[_0x568e0b]);}return __setModuleDefault(_0x35ef93,_0x1c78d4),_0x35ef93;};}()),__importDefault=this&&this[a8_0xa94ce7(0x14f)]||function(_0x129c81){return _0x129c81&&_0x129c81['__esModule']?_0x129c81:{'default':_0x129c81};};function a8_0x6792(_0x4f8e8a,_0x2af9df){const _0x36e761=a8_0x36e7();return a8_0x6792=function(_0x6792bf,_0x3fd085){_0x6792bf=_0x6792bf-0x145;let _0x46d692=_0x36e761[_0x6792bf];return _0x46d692;},a8_0x6792(_0x4f8e8a,_0x2af9df);}Object[a8_0xa94ce7(0x16a)](exports,a8_0xa94ce7(0x14c),{'value':!![]}),exports[a8_0xa94ce7(0x185)]=void 0x0;const paymentService_1=require(a8_0xa94ce7(0x1ab)),mastercardService_1=require(a8_0xa94ce7(0x16b)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0xa94ce7(0x194)));class PaymentController{constructor(){const _0x1addfd=a8_0xa94ce7;this[_0x1addfd(0x19a)]=async(_0x59e86d,_0x656ba0,_0x2023be)=>{const _0x118014=_0x1addfd;try{const _0x5e3d0e=_0x59e86d[_0x118014(0x1a1)],_0x257790=await this[_0x118014(0x189)][_0x118014(0x19a)](_0x5e3d0e);_0x656ba0[_0x118014(0x1a2)](0xc9)[_0x118014(0x17d)]({'success':!![],'message':_0x118014(0x15b),'result':_0x257790});}catch(_0x1a5d82){_0x2023be(_0x1a5d82);}},this['getPaymentStatus']=async(_0x4db32e,_0x5b5e55,_0x356c54)=>{const _0x1a9c0d=_0x1addfd;try{const {id:_0x39570b}=_0x4db32e['params'],_0x54fa74=await this['paymentService'][_0x1a9c0d(0x180)](_0x39570b);if(!_0x54fa74)return _0x5b5e55[_0x1a9c0d(0x1a2)](0x194)['json']({'success':![],'message':_0x1a9c0d(0x178)});_0x5b5e55[_0x1a9c0d(0x17d)]({'success':!![],'result':_0x54fa74});}catch(_0x5d2a31){_0x356c54(_0x5d2a31);}},this['getPaymentById']=async(_0x433248,_0x31487f,_0x43723d)=>{const _0x1bb406=_0x1addfd;try{const {id:_0x11bd44}=_0x433248['params'],_0x44a2db=await this['paymentService'][_0x1bb406(0x1a5)](_0x11bd44);if(!_0x44a2db)return _0x31487f[_0x1bb406(0x1a2)](0x194)['json']({'success':![],'message':_0x1bb406(0x178)});_0x31487f['json']({'success':!![],'result':_0x44a2db});}catch(_0x23dfd5){_0x43723d(_0x23dfd5);}},this[_0x1addfd(0x181)]=async(_0x4d97ee,_0x43641c,_0x4f8b3c)=>{const _0x5478bf=_0x1addfd;try{const {id:_0x2a43f1}=_0x4d97ee[_0x5478bf(0x146)],_0x204b6e=_0x4d97ee[_0x5478bf(0x1a1)];console[_0x5478bf(0x162)](_0x5478bf(0x182)+_0x2a43f1),console[_0x5478bf(0x162)]('📝\x20Customer\x20data:',_0x204b6e);const _0x58e75f=await this[_0x5478bf(0x189)][_0x5478bf(0x164)](_0x2a43f1,_0x204b6e);if(!_0x58e75f)return _0x43641c[_0x5478bf(0x1a2)](0x194)[_0x5478bf(0x17d)]({'success':![],'message':_0x5478bf(0x178)});_0x43641c[_0x5478bf(0x17d)]({'success':!![],'message':_0x5478bf(0x14d),'result':{'paymentId':_0x58e75f['id'],'customerIp':_0x58e75f[_0x5478bf(0x17a)],'customerUa':_0x58e75f[_0x5478bf(0x147)],'customerCountry':_0x58e75f[_0x5478bf(0x192)],'updatedAt':_0x58e75f[_0x5478bf(0x1b2)]}});}catch(_0xe0b097){_0x4f8b3c(_0xe0b097);}},this[_0x1addfd(0x188)]=async(_0x2aafab,_0x4a951f,_0x50aec0)=>{const _0x59e3df=_0x1addfd;try{const {id:_0x34b10d}=_0x2aafab[_0x59e3df(0x146)],{cardData:_0x86330a,cardHolder:_0x2a1c0e,browser:_0x4ff3a1}=_0x2aafab[_0x59e3df(0x1a1)];console[_0x59e3df(0x162)](_0x59e3df(0x1b7)+_0x34b10d),console[_0x59e3df(0x162)]('💳\x20Card\x20holder:\x20'+_0x2a1c0e[_0x59e3df(0x152)]+'\x20'+_0x2a1c0e[_0x59e3df(0x18a)]+'\x20('+_0x2a1c0e[_0x59e3df(0x15e)]+')'),console[_0x59e3df(0x162)]('💳\x20Browser\x20IP:\x20'+_0x4ff3a1['ip']);const _0x43855e={'customerName':_0x2a1c0e[_0x59e3df(0x152)]+'\x20'+_0x2a1c0e[_0x59e3df(0x18a)],'customerEmail':_0x2a1c0e[_0x59e3df(0x15e)],'customerIp':_0x4ff3a1['ip'],'customerUa':_0x4ff3a1['user_agent'],'customerCountry':_0x2a1c0e[_0x59e3df(0x176)]||null},_0xa16800=await database_1['default']['payment'][_0x59e3df(0x16f)]({'where':{'id':_0x34b10d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xa16800)return _0x4a951f[_0x59e3df(0x1a2)](0x194)[_0x59e3df(0x17d)]({'success':![],'message':_0x59e3df(0x178)});if(_0xa16800[_0x59e3df(0x1ba)]!=='mastercard')return _0x4a951f[_0x59e3df(0x1a2)](0x190)['json']({'success':![],'message':_0x59e3df(0x163)});if(_0xa16800['status']!=='PENDING')return _0x4a951f[_0x59e3df(0x1a2)](0x190)[_0x59e3df(0x17d)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0xa16800[_0x59e3df(0x1a2)]+_0x59e3df(0x1c1)});await database_1[_0x59e3df(0x18f)][_0x59e3df(0x1b5)][_0x59e3df(0x175)]({'where':{'id':_0x34b10d},'data':{..._0x43855e,'updatedAt':new Date()}});const _0x16a866=_0x59e3df(0x1a8),_0x5041a4=_0xa16800[_0x59e3df(0x193)];console[_0x59e3df(0x162)](_0x59e3df(0x1b6)),console[_0x59e3df(0x162)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x16a866),console[_0x59e3df(0x162)](_0x59e3df(0x173)+_0x5041a4);const _0x6a83e={'first_name':_0x2a1c0e[_0x59e3df(0x152)],'last_name':_0x2a1c0e[_0x59e3df(0x18a)],'email':_0x2a1c0e['email']},_0x210ee7=await this[_0x59e3df(0x18d)][_0x59e3df(0x154)]({'paymentId':_0xa16800['id'],'orderId':_0xa16800[_0x59e3df(0x184)]||_0xa16800['id'],'amount':_0xa16800[_0x59e3df(0x1a4)],'currency':_0xa16800['currency'],'cardData':_0x86330a,'resultUrl':_0x16a866,'returnUrl':_0x5041a4,'cardHolder':_0x6a83e,'browser':_0x4ff3a1});console[_0x59e3df(0x162)](_0x59e3df(0x1bc),_0x210ee7);const _0x2d7a3d={'status':_0x210ee7['status'],'updatedAt':new Date(),'statusChangedBy':_0x59e3df(0x18e),'statusChangedAt':new Date()};if(_0x210ee7[_0x59e3df(0x1a2)]===_0x59e3df(0x171))_0x2d7a3d[_0x59e3df(0x17c)]=new Date(),_0x2d7a3d[_0x59e3df(0x158)]=_0x210ee7[_0x59e3df(0x19f)];else _0x210ee7[_0x59e3df(0x1a2)]===_0x59e3df(0x1b8)&&(_0x2d7a3d[_0x59e3df(0x186)]=_0x59e3df(0x19b));_0x2d7a3d[_0x59e3df(0x15d)]=_0x59e3df(0x157);if(_0x86330a[_0x59e3df(0x1b0)]){const _0x33b0f0=_0x86330a[_0x59e3df(0x1b0)]['replace'](/[\s-]/g,'');_0x2d7a3d[_0x59e3df(0x1c0)]=_0x33b0f0['slice'](-0x4),console[_0x59e3df(0x162)](_0x59e3df(0x196)+_0x2d7a3d['cardLast4']);}await database_1[_0x59e3df(0x18f)][_0x59e3df(0x1b5)]['update']({'where':{'id':_0xa16800['id']},'data':_0x2d7a3d}),await database_1[_0x59e3df(0x18f)][_0x59e3df(0x160)][_0x59e3df(0x1a9)]({'data':{'paymentId':_0xa16800['id'],'shopId':_0xa16800[_0x59e3df(0x1b4)],'event':_0x59e3df(0x167)+_0x210ee7[_0x59e3df(0x1a2)]?.[_0x59e3df(0x149)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x210ee7['status'],'gatewayPaymentId':_0x210ee7[_0x59e3df(0x19f)],'requires3ds':_0x210ee7[_0x59e3df(0x19d)],'processedAt':new Date()['toISOString']()})}});if(_0x210ee7[_0x59e3df(0x1aa)]){await this['sendShopWebhook'](_0xa16800,_0x210ee7[_0x59e3df(0x1a2)],_0x210ee7[_0x59e3df(0x19f)]),await this['sendPaymentStatusNotification'](_0xa16800,_0x210ee7['status']);if(_0x210ee7[_0x59e3df(0x1a2)]===_0x59e3df(0x171)){console['log'](_0x59e3df(0x174)+_0x34b10d+_0x59e3df(0x1ad));try{const {PaymentLinkService:_0x1ceef8}=await Promise[_0x59e3df(0x19e)]()['then'](()=>__importStar(require(_0x59e3df(0x1bb)))),_0x297cff=new _0x1ceef8();await _0x297cff[_0x59e3df(0x17f)](_0x34b10d),console[_0x59e3df(0x162)](_0x59e3df(0x1bd)+_0x34b10d);}catch(_0x33b1c3){console[_0x59e3df(0x1a3)](_0x59e3df(0x16e),_0x33b1c3);}}}console['log'](_0x59e3df(0x165)+_0x34b10d+'\x20processed:\x20'+_0x210ee7[_0x59e3df(0x1a2)]);if(_0x210ee7['status']===_0x59e3df(0x171))_0x4a951f[_0x59e3df(0x17d)]({'success':!![],'message':_0x59e3df(0x169),'result':{'status':_0x59e3df(0x171),'gatewayPaymentId':_0x210ee7[_0x59e3df(0x19f)],'redirectUrl':_0x5041a4,'final':!![]}});else _0x210ee7[_0x59e3df(0x19d)]&&_0x210ee7[_0x59e3df(0x198)]?_0x4a951f[_0x59e3df(0x17d)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x59e3df(0x17b),'gatewayPaymentId':_0x210ee7[_0x59e3df(0x19f)],'redirectUrl':_0x210ee7[_0x59e3df(0x198)],'requires3ds':!![],'final':![]}}):_0x4a951f[_0x59e3df(0x1a2)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x210ee7[_0x59e3df(0x19f)],'redirectUrl':_0xa16800['failUrl'],'final':!![]}});}catch(_0x154de4){_0x50aec0(_0x154de4);}},this[_0x1addfd(0x189)]=new paymentService_1[(_0x1addfd(0x14b))](),this['masterCardService']=new mastercardService_1[(_0x1addfd(0x191))](),this[_0x1addfd(0x15f)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x2eae2d,_0x36d459,_0x41bfa3){const _0x24e51b=a8_0xa94ce7,_0x3adf51=Date[_0x24e51b(0x148)]();try{const _0x58be69=_0x2eae2d[_0x24e51b(0x156)],_0x2c4265=_0x58be69[_0x24e51b(0x18b)];if(!_0x2c4265?.['webhookUrl']){console[_0x24e51b(0x162)](_0x24e51b(0x155)+_0x58be69['id']);return;}const _0x5166cb=_0x36d459===_0x24e51b(0x171)?_0x24e51b(0x190):_0x24e51b(0x18c);let _0x1c9b9b=[];if(_0x2c4265[_0x24e51b(0x172)])try{_0x1c9b9b=Array[_0x24e51b(0x1c2)](_0x2c4265[_0x24e51b(0x172)])?_0x2c4265[_0x24e51b(0x172)]:JSON[_0x24e51b(0x150)](_0x2c4265['webhookEvents']);}catch(_0x16bb0c){console['error'](_0x24e51b(0x183),_0x16bb0c),_0x1c9b9b=[];}if(!_0x1c9b9b[_0x24e51b(0x19c)](_0x5166cb)){console['log'](_0x24e51b(0x197)+_0x5166cb+_0x24e51b(0x14a)+_0x58be69['id']);return;}const _0x2dd29b={'event':_0x5166cb,'payment':{'id':_0x2eae2d['id'],'order_id':_0x2eae2d[_0x24e51b(0x1a6)],'gateway_order_id':_0x2eae2d[_0x24e51b(0x184)],'gateway':'1111','amount':_0x2eae2d[_0x24e51b(0x1a4)],'currency':_0x2eae2d[_0x24e51b(0x179)],'status':_0x36d459['toLowerCase'](),'customer_email':_0x2eae2d[_0x24e51b(0x187)],'customer_name':_0x2eae2d['customerName'],'gateway_payment_id':_0x41bfa3,'created_at':_0x2eae2d[_0x24e51b(0x17e)],'updated_at':new Date()}},_0x39a1c3=await fetch(_0x2c4265[_0x24e51b(0x166)],{'method':'POST','headers':{'Content-Type':_0x24e51b(0x1b3),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x24e51b(0x195)](_0x2dd29b)}),_0x3ccddd=Date[_0x24e51b(0x148)]()-_0x3adf51;console['log'](_0x24e51b(0x15a)+_0x2c4265[_0x24e51b(0x166)]+'\x20with\x20status\x20'+_0x39a1c3[_0x24e51b(0x1a2)]+'\x20('+_0x3ccddd+'ms)');}catch(_0x4848ae){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x4848ae);}}async[a8_0xa94ce7(0x1a0)](_0x28dda5,_0x5dafef){const _0x539577=a8_0xa94ce7;try{const {telegramBotService:_0x1e8b5b}=await Promise['resolve']()[_0x539577(0x161)](()=>__importStar(require('../services/telegramBotService'))),_0x1180d7={'PAID':_0x539577(0x15c),'FAILED':_0x539577(0x1a7)},_0x9b3207=_0x1180d7[_0x5dafef];if(!_0x9b3207)return;await _0x1e8b5b[_0x539577(0x1bf)](_0x28dda5[_0x539577(0x1b4)],_0x28dda5,_0x9b3207);}catch(_0x4c6f48){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4c6f48);}}}exports[a8_0xa94ce7(0x185)]=PaymentController;function a8_0x36e7(){const _0x574dca=['parse','356386twuoIz','first_name','writable','processCardPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','shop','mastercard','gatewayPaymentId','call','MasterCard\x20webhook\x20sent\x20to\x20','Payment\x20created\x20successfully','paid','paymentMethod','email','webhookService','webhookLog','then','log','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','updatePaymentCustomerDataPublic','✅\x20MasterCard\x20payment\x20','webhookUrl','mastercard_','__setModuleDefault','Payment\x20processed\x20successfully','defineProperty','../services/gateways/mastercardService','133173nRGhdI','getOwnPropertyNames','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','findUnique','1641ysacEc','PAID','webhookEvents','\x20\x20\x20Return\x20URL:\x20','📈\x20MasterCard\x20payment\x20','update','country','7933905bhAWwA','Payment\x20not\x20found','currency','customerIp','PENDING','paidAt','json','createdAt','handleSuccessfulPayment','getPaymentStatus','updatePaymentCustomer','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Error\x20parsing\x20webhook\x20events:','gatewayOrderId','PaymentController','failureMessage','customerEmail','processMasterCardPayment','paymentService','last_name','settings','payment.failed','masterCardService','system','default','payment.success','MasterCardService','customerCountry','successUrl','../config/database','stringify','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','Webhook\x20event\x20','threeds_url','15194760MRkIIZ','createPublicPayment','Card\x20payment\x20failed','includes','requires_3ds','resolve','gateway_payment_id','sendPaymentStatusNotification','body','status','error','amount','getPaymentById','orderId','failed','https://api.trapay.uk/api/webhooks/gateway/mastercard','create','final','../services/paymentService','4268TiKZfL','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','hasOwnProperty','1609498CgCDeR','number','10dSLUuo','updatedAt','application/json','shopId','payment','💳\x20MasterCard\x20URLs:','💳\x20Processing\x20MasterCard\x20payment:\x20','FAILED','__createBinding','gateway','../services/paymentLinkService','💳\x20MasterCard\x20result:','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','776RZkLNg','sendPaymentNotification','cardLast4',',\x20cannot\x20process','isArray','2188056GjaRdR','params','customerUa','now','toLowerCase','\x20not\x20enabled\x20for\x20shop\x20','PaymentService','__esModule','Customer\x20data\x20updated\x20successfully','prototype','__importDefault'];a8_0x36e7=function(){return _0x574dca;};return a8_0x36e7();}