'use strict';function a8_0x11a7(_0x4b9ff6,_0xad4803){const _0xd2ba09=a8_0xd2ba();return a8_0x11a7=function(_0x11a75f,_0xc28e6d){_0x11a75f=_0x11a75f-0x189;let _0x39094f=_0xd2ba09[_0x11a75f];return _0x39094f;},a8_0x11a7(_0x4b9ff6,_0xad4803);}const a8_0x4506e4=a8_0x11a7;(function(_0x550dea,_0x280362){const _0x586bb8=a8_0x11a7,_0xe69f88=_0x550dea();while(!![]){try{const _0x3414ef=parseInt(_0x586bb8(0x1f5))/0x1*(-parseInt(_0x586bb8(0x1f0))/0x2)+-parseInt(_0x586bb8(0x1c5))/0x3*(parseInt(_0x586bb8(0x1bb))/0x4)+-parseInt(_0x586bb8(0x1c4))/0x5*(parseInt(_0x586bb8(0x1e1))/0x6)+-parseInt(_0x586bb8(0x197))/0x7+parseInt(_0x586bb8(0x1af))/0x8*(parseInt(_0x586bb8(0x1c8))/0x9)+parseInt(_0x586bb8(0x1b3))/0xa*(parseInt(_0x586bb8(0x1a0))/0xb)+parseInt(_0x586bb8(0x1ec))/0xc*(parseInt(_0x586bb8(0x18e))/0xd);if(_0x3414ef===_0x280362)break;else _0xe69f88['push'](_0xe69f88['shift']());}catch(_0x758bb1){_0xe69f88['push'](_0xe69f88['shift']());}}}(a8_0xd2ba,0x8b641));var __createBinding=this&&this[a8_0x4506e4(0x1de)]||(Object['create']?function(_0xe93477,_0x4ef2e3,_0x2115ab,_0x308601){const _0x14e641=a8_0x4506e4;if(_0x308601===undefined)_0x308601=_0x2115ab;var _0x59efb9=Object[_0x14e641(0x1d5)](_0x4ef2e3,_0x2115ab);(!_0x59efb9||(_0x14e641(0x1d1)in _0x59efb9?!_0x4ef2e3[_0x14e641(0x1d2)]:_0x59efb9[_0x14e641(0x1bc)]||_0x59efb9[_0x14e641(0x19f)]))&&(_0x59efb9={'enumerable':!![],'get':function(){return _0x4ef2e3[_0x2115ab];}}),Object[_0x14e641(0x1c2)](_0xe93477,_0x308601,_0x59efb9);}:function(_0x63b2df,_0x432cd1,_0x3c8c5a,_0x2e0c44){if(_0x2e0c44===undefined)_0x2e0c44=_0x3c8c5a;_0x63b2df[_0x2e0c44]=_0x432cd1[_0x3c8c5a];}),__setModuleDefault=this&&this[a8_0x4506e4(0x1b5)]||(Object['create']?function(_0x175ace,_0x3a6f12){const _0x181630=a8_0x4506e4;Object[_0x181630(0x1c2)](_0x175ace,'default',{'enumerable':!![],'value':_0x3a6f12});}:function(_0x5d0ea2,_0x4f16ec){const _0x4395c5=a8_0x4506e4;_0x5d0ea2[_0x4395c5(0x1d7)]=_0x4f16ec;}),__importStar=this&&this['__importStar']||(function(){var _0xc46ab=function(_0x45f777){const _0x5851e2=a8_0x11a7;return _0xc46ab=Object[_0x5851e2(0x1ea)]||function(_0x33232a){const _0x404ee7=_0x5851e2;var _0x5b67e7=[];for(var _0x9afa1a in _0x33232a)if(Object[_0x404ee7(0x1a8)][_0x404ee7(0x1c7)]['call'](_0x33232a,_0x9afa1a))_0x5b67e7[_0x5b67e7[_0x404ee7(0x18c)]]=_0x9afa1a;return _0x5b67e7;},_0xc46ab(_0x45f777);};return function(_0x3447f7){const _0xc0f84f=a8_0x11a7;if(_0x3447f7&&_0x3447f7['__esModule'])return _0x3447f7;var _0x21b96b={};if(_0x3447f7!=null){for(var _0x1abad3=_0xc46ab(_0x3447f7),_0x4a387a=0x0;_0x4a387a<_0x1abad3[_0xc0f84f(0x18c)];_0x4a387a++)if(_0x1abad3[_0x4a387a]!=='default')__createBinding(_0x21b96b,_0x3447f7,_0x1abad3[_0x4a387a]);}return __setModuleDefault(_0x21b96b,_0x3447f7),_0x21b96b;};}()),__importDefault=this&&this['__importDefault']||function(_0x4878e0){const _0x2e7fa0=a8_0x4506e4;return _0x4878e0&&_0x4878e0[_0x2e7fa0(0x1d2)]?_0x4878e0:{'default':_0x4878e0};};Object[a8_0x4506e4(0x1c2)](exports,a8_0x4506e4(0x1d2),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x4506e4(0x1bf)),mastercardService_1=require(a8_0x4506e4(0x1b0)),webhookService_1=require(a8_0x4506e4(0x18d)),database_1=__importDefault(require('../config/database'));function a8_0xd2ba(){const _0x3f7c0b=['No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','resolve','customerName','Payment\x20failed','303144KTKNRT','writable','mastercard_','params','../services/paymentService','WebhookService','status','defineProperty','gateway_payment_id','3445ZVZVOP','15aZaOuK','gatewayPaymentId','hasOwnProperty','3054096FOKHYF','../services/telegramBotService','sendPaymentNotification','ðŸ’³\x20MasterCard\x20result:','Webhook\x20event\x20','requires_3ds','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20processed\x20successfully','payment','get','__esModule','stringify','update','getOwnPropertyDescriptor','Payment\x20not\x20found','default','webhookEvents','PAID','toISOString','Payment\x20created\x20successfully','orderId','paymentService','__createBinding','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Card\x20payment\x20failed','3006UKfrec','1111','failureMessage','currency','paidAt','failUrl','webhookUrl','log','payment.failed','getOwnPropertyNames','mastercard','28331268ZKzSES','toLowerCase','error','application/json','2LSgIsL','createdAt','processCardPayment','create','shopId','504649oTjyBF','sendShopWebhook','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','MasterCardService','PENDING','length','../services/webhookService','13DZgDdK','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ’³\x20MasterCard\x20URLs:','then','FAILED','\x20with\x20status\x20','json','processMasterCardPayment','sendPaymentStatusNotification','6430585DBBiDT','threeds_url','getPaymentById','payment.success','getPaymentStatus','3DS\x20verification\x20required','POST','masterCardService','configurable','198935qHjcrt','ms)','\x20\x20\x20Return\x20URL:\x20',',\x20cannot\x20process','now','amount','Payment\x20status\x20is\x20','paymentMethod','prototype','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','paid','customerEmail','webhookService','createPublicPayment','system','8FQDWGl','../services/gateways/mastercardService','includes','PaymentService','10ykJNgO','Error\x20parsing\x20webhook\x20events:','__setModuleDefault','webhookLog'];a8_0xd2ba=function(){return _0x3f7c0b;};return a8_0xd2ba();}class PaymentController{constructor(){const _0x4a0606=a8_0x4506e4;this['createPublicPayment']=async(_0x444347,_0x4443ed,_0x41ade2)=>{const _0x2cc0ee=a8_0x11a7;try{const _0x20d78a=_0x444347['body'],_0x17822d=await this['paymentService'][_0x2cc0ee(0x1ad)](_0x20d78a);_0x4443ed[_0x2cc0ee(0x1c1)](0xc9)[_0x2cc0ee(0x194)]({'success':!![],'message':_0x2cc0ee(0x1db),'result':_0x17822d});}catch(_0x5c61c1){_0x41ade2(_0x5c61c1);}},this[_0x4a0606(0x19b)]=async(_0x63c9ba,_0x421421,_0x5eab41)=>{const _0x1edb21=_0x4a0606;try{const {id:_0x52c46a}=_0x63c9ba[_0x1edb21(0x1be)],_0x3adcf2=await this[_0x1edb21(0x1dd)][_0x1edb21(0x19b)](_0x52c46a);if(!_0x3adcf2)return _0x421421[_0x1edb21(0x1c1)](0x194)[_0x1edb21(0x194)]({'success':![],'message':_0x1edb21(0x1d6)});_0x421421['json']({'success':!![],'result':_0x3adcf2});}catch(_0x3d518f){_0x5eab41(_0x3d518f);}},this['getPaymentById']=async(_0x2fa501,_0x1ec6af,_0xb5df17)=>{const _0x5e0805=_0x4a0606;try{const {id:_0x38bc63}=_0x2fa501[_0x5e0805(0x1be)],_0x17917b=await this['paymentService'][_0x5e0805(0x199)](_0x38bc63);if(!_0x17917b)return _0x1ec6af[_0x5e0805(0x1c1)](0x194)[_0x5e0805(0x194)]({'success':![],'message':_0x5e0805(0x1d6)});_0x1ec6af['json']({'success':!![],'result':_0x17917b});}catch(_0x3e1aed){_0xb5df17(_0x3e1aed);}},this[_0x4a0606(0x195)]=async(_0x543812,_0x57ff0a,_0x479272)=>{const _0x1d5dd7=_0x4a0606;try{const {id:_0x434176}=_0x543812['params'],{cardData:_0x52fe5d,cardHolder:_0x475b75,browser:_0x43bc1c}=_0x543812['body'];console['log'](_0x1d5dd7(0x189)+_0x434176);const _0x5c96ed=await database_1[_0x1d5dd7(0x1d7)]['payment']['findUnique']({'where':{'id':_0x434176},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c96ed)return _0x57ff0a['status'](0x194)[_0x1d5dd7(0x194)]({'success':![],'message':_0x1d5dd7(0x1d6)});if(_0x5c96ed['gateway']!==_0x1d5dd7(0x1eb))return _0x57ff0a[_0x1d5dd7(0x1c1)](0x190)[_0x1d5dd7(0x194)]({'success':![],'message':_0x1d5dd7(0x1a9)});if(_0x5c96ed[_0x1d5dd7(0x1c1)]!==_0x1d5dd7(0x18b))return _0x57ff0a[_0x1d5dd7(0x1c1)](0x190)[_0x1d5dd7(0x194)]({'success':![],'message':_0x1d5dd7(0x1a6)+_0x5c96ed['status']+_0x1d5dd7(0x1a3)});const _0x10f379='https://apitest.trapay.uk/api/webhooks/gateway/mastercard',_0x1210d5=_0x5c96ed['successUrl'];console[_0x1d5dd7(0x1e8)](_0x1d5dd7(0x190)),console[_0x1d5dd7(0x1e8)](_0x1d5dd7(0x1df)+_0x10f379),console[_0x1d5dd7(0x1e8)](_0x1d5dd7(0x1a2)+_0x1210d5);const _0x4dcbd3=await this[_0x1d5dd7(0x19e)][_0x1d5dd7(0x1f2)]({'paymentId':_0x5c96ed['id'],'orderId':_0x5c96ed['gatewayOrderId']||_0x5c96ed['id'],'amount':_0x5c96ed['amount'],'currency':_0x5c96ed['currency'],'cardData':_0x52fe5d,'resultUrl':_0x10f379,'returnUrl':_0x1210d5,'cardHolder':_0x475b75,'browser':_0x43bc1c});console[_0x1d5dd7(0x1e8)](_0x1d5dd7(0x1cb),_0x4dcbd3);const _0x396326={'status':_0x4dcbd3[_0x1d5dd7(0x1c1)],'updatedAt':new Date(),'statusChangedBy':_0x1d5dd7(0x1ae),'statusChangedAt':new Date()};if(_0x4dcbd3['status']===_0x1d5dd7(0x1d9))_0x396326[_0x1d5dd7(0x1e5)]=new Date(),_0x396326[_0x1d5dd7(0x1c6)]=_0x4dcbd3[_0x1d5dd7(0x1c3)];else _0x4dcbd3[_0x1d5dd7(0x1c1)]===_0x1d5dd7(0x192)&&(_0x396326[_0x1d5dd7(0x1e3)]=_0x1d5dd7(0x1e0));_0x396326[_0x1d5dd7(0x1a7)]=_0x1d5dd7(0x1eb),await database_1[_0x1d5dd7(0x1d7)][_0x1d5dd7(0x1d0)][_0x1d5dd7(0x1d4)]({'where':{'id':_0x5c96ed['id']},'data':_0x396326}),await database_1[_0x1d5dd7(0x1d7)][_0x1d5dd7(0x1b6)][_0x1d5dd7(0x1f3)]({'data':{'paymentId':_0x5c96ed['id'],'shopId':_0x5c96ed[_0x1d5dd7(0x1f4)],'event':_0x1d5dd7(0x1bd)+_0x4dcbd3[_0x1d5dd7(0x1c1)]?.[_0x1d5dd7(0x1ed)](),'statusCode':0xc8,'responseBody':JSON[_0x1d5dd7(0x1d3)]({'oldStatus':_0x1d5dd7(0x18b),'newStatus':_0x4dcbd3[_0x1d5dd7(0x1c1)],'gatewayPaymentId':_0x4dcbd3[_0x1d5dd7(0x1c3)],'requires3ds':_0x4dcbd3[_0x1d5dd7(0x1cd)],'processedAt':new Date()[_0x1d5dd7(0x1da)]()})}});_0x4dcbd3['final']&&(await this[_0x1d5dd7(0x1f6)](_0x5c96ed,_0x4dcbd3['status'],_0x4dcbd3[_0x1d5dd7(0x1c3)]),await this[_0x1d5dd7(0x196)](_0x5c96ed,_0x4dcbd3[_0x1d5dd7(0x1c1)]));console[_0x1d5dd7(0x1e8)]('âœ…\x20MasterCard\x20payment\x20'+_0x434176+'\x20processed:\x20'+_0x4dcbd3[_0x1d5dd7(0x1c1)]);if(_0x4dcbd3[_0x1d5dd7(0x1c1)]===_0x1d5dd7(0x1d9))_0x57ff0a[_0x1d5dd7(0x194)]({'success':!![],'message':_0x1d5dd7(0x1cf),'result':{'status':_0x1d5dd7(0x1d9),'gatewayPaymentId':_0x4dcbd3['gateway_payment_id'],'redirectUrl':_0x1210d5,'final':!![]}});else _0x4dcbd3[_0x1d5dd7(0x1cd)]&&_0x4dcbd3[_0x1d5dd7(0x198)]?_0x57ff0a[_0x1d5dd7(0x194)]({'success':!![],'message':_0x1d5dd7(0x19c),'result':{'status':_0x1d5dd7(0x18b),'gatewayPaymentId':_0x4dcbd3[_0x1d5dd7(0x1c3)],'redirectUrl':_0x4dcbd3[_0x1d5dd7(0x198)],'requires3ds':!![],'final':![]}}):_0x57ff0a['status'](0x190)[_0x1d5dd7(0x194)]({'success':![],'message':_0x1d5dd7(0x1ba),'result':{'status':'FAILED','gatewayPaymentId':_0x4dcbd3[_0x1d5dd7(0x1c3)],'redirectUrl':_0x5c96ed[_0x1d5dd7(0x1e6)],'final':!![]}});}catch(_0x50b810){_0x479272(_0x50b810);}},this[_0x4a0606(0x1dd)]=new paymentService_1[(_0x4a0606(0x1b2))](),this[_0x4a0606(0x19e)]=new mastercardService_1[(_0x4a0606(0x18a))](),this[_0x4a0606(0x1ac)]=new webhookService_1[(_0x4a0606(0x1c0))]();}async[a8_0x4506e4(0x1f6)](_0x39e6e0,_0x3cb64a,_0x3afe28){const _0x2f3652=a8_0x4506e4,_0x483558=Date[_0x2f3652(0x1a4)]();try{const _0x4d69e4=_0x39e6e0['shop'],_0x4e10cf=_0x4d69e4['settings'];if(!_0x4e10cf?.[_0x2f3652(0x1e7)]){console[_0x2f3652(0x1e8)](_0x2f3652(0x1b7)+_0x4d69e4['id']);return;}const _0x44fdc3=_0x3cb64a===_0x2f3652(0x1d9)?_0x2f3652(0x19a):_0x2f3652(0x1e9);let _0x15fdea=[];if(_0x4e10cf[_0x2f3652(0x1d8)])try{_0x15fdea=Array['isArray'](_0x4e10cf[_0x2f3652(0x1d8)])?_0x4e10cf['webhookEvents']:JSON['parse'](_0x4e10cf[_0x2f3652(0x1d8)]);}catch(_0x440441){console[_0x2f3652(0x1ee)](_0x2f3652(0x1b4),_0x440441),_0x15fdea=[];}if(!_0x15fdea[_0x2f3652(0x1b1)](_0x44fdc3)){console[_0x2f3652(0x1e8)](_0x2f3652(0x1cc)+_0x44fdc3+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4d69e4['id']);return;}const _0x33314d={'event':_0x44fdc3,'payment':{'id':_0x39e6e0['id'],'order_id':_0x39e6e0[_0x2f3652(0x1dc)],'gateway_order_id':_0x39e6e0['gatewayOrderId'],'gateway':_0x2f3652(0x1e2),'amount':_0x39e6e0[_0x2f3652(0x1a5)],'currency':_0x39e6e0[_0x2f3652(0x1e4)],'status':_0x3cb64a['toLowerCase'](),'customer_email':_0x39e6e0[_0x2f3652(0x1ab)],'customer_name':_0x39e6e0[_0x2f3652(0x1b9)],'gateway_payment_id':_0x3afe28,'created_at':_0x39e6e0[_0x2f3652(0x1f1)],'updated_at':new Date()}},_0x9deea3=await fetch(_0x4e10cf[_0x2f3652(0x1e7)],{'method':_0x2f3652(0x19d),'headers':{'Content-Type':_0x2f3652(0x1ef),'User-Agent':_0x2f3652(0x1ce)},'body':JSON[_0x2f3652(0x1d3)](_0x33314d)}),_0x1c38da=Date['now']()-_0x483558;console[_0x2f3652(0x1e8)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x4e10cf[_0x2f3652(0x1e7)]+_0x2f3652(0x193)+_0x9deea3['status']+'\x20('+_0x1c38da+_0x2f3652(0x1a1));}catch(_0x3f64e8){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x3f64e8);}}async[a8_0x4506e4(0x196)](_0x58c3fe,_0x3260e1){const _0x187a39=a8_0x4506e4;try{const {telegramBotService:_0x5bb9f7}=await Promise[_0x187a39(0x1b8)]()[_0x187a39(0x191)](()=>__importStar(require(_0x187a39(0x1c9)))),_0x2e2980={'PAID':_0x187a39(0x1aa),'FAILED':'failed'},_0x5299fa=_0x2e2980[_0x3260e1];if(!_0x5299fa)return;await _0x5bb9f7[_0x187a39(0x1ca)](_0x58c3fe['shopId'],_0x58c3fe,_0x5299fa);}catch(_0x9492f3){console[_0x187a39(0x1ee)](_0x187a39(0x18f),_0x9492f3);}}}exports['PaymentController']=PaymentController;