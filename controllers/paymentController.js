'use strict';function a8_0x2f5d(_0x2e0cba,_0x4fbe87){const _0x213686=a8_0x2136();return a8_0x2f5d=function(_0x2f5deb,_0x1172be){_0x2f5deb=_0x2f5deb-0xb2;let _0x1ce10a=_0x213686[_0x2f5deb];return _0x1ce10a;},a8_0x2f5d(_0x2e0cba,_0x4fbe87);}const a8_0x47fe66=a8_0x2f5d;(function(_0x4cebdc,_0x2d6e81){const _0x12393d=a8_0x2f5d,_0x22c48e=_0x4cebdc();while(!![]){try{const _0x4c9be9=parseInt(_0x12393d(0x120))/0x1*(parseInt(_0x12393d(0x127))/0x2)+-parseInt(_0x12393d(0x10f))/0x3*(parseInt(_0x12393d(0x107))/0x4)+-parseInt(_0x12393d(0xd0))/0x5*(-parseInt(_0x12393d(0x108))/0x6)+-parseInt(_0x12393d(0xbb))/0x7*(-parseInt(_0x12393d(0xd1))/0x8)+-parseInt(_0x12393d(0xc1))/0x9+-parseInt(_0x12393d(0xd8))/0xa+parseInt(_0x12393d(0xec))/0xb*(parseInt(_0x12393d(0x11a))/0xc);if(_0x4c9be9===_0x2d6e81)break;else _0x22c48e['push'](_0x22c48e['shift']());}catch(_0x4e9997){_0x22c48e['push'](_0x22c48e['shift']());}}}(a8_0x2136,0x27571));var __createBinding=this&&this[a8_0x47fe66(0xd9)]||(Object['create']?function(_0xb2767b,_0x207ae5,_0xbc260a,_0x11c37d){const _0x400e76=a8_0x47fe66;if(_0x11c37d===undefined)_0x11c37d=_0xbc260a;var _0x1dc97a=Object['getOwnPropertyDescriptor'](_0x207ae5,_0xbc260a);(!_0x1dc97a||('get'in _0x1dc97a?!_0x207ae5['__esModule']:_0x1dc97a[_0x400e76(0xef)]||_0x1dc97a[_0x400e76(0x10e)]))&&(_0x1dc97a={'enumerable':!![],'get':function(){return _0x207ae5[_0xbc260a];}}),Object[_0x400e76(0x11e)](_0xb2767b,_0x11c37d,_0x1dc97a);}:function(_0x555caa,_0x2db0d7,_0x173ff3,_0x49f1a6){if(_0x49f1a6===undefined)_0x49f1a6=_0x173ff3;_0x555caa[_0x49f1a6]=_0x2db0d7[_0x173ff3];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x47fe66(0xe9)]?function(_0x4d6a2d,_0x534ff9){const _0x2abc09=a8_0x47fe66;Object[_0x2abc09(0x11e)](_0x4d6a2d,_0x2abc09(0xb3),{'enumerable':!![],'value':_0x534ff9});}:function(_0x165084,_0x117a0b){_0x165084['default']=_0x117a0b;}),__importStar=this&&this[a8_0x47fe66(0xe0)]||(function(){var _0x4e1779=function(_0x4540ca){const _0x40d048=a8_0x2f5d;return _0x4e1779=Object[_0x40d048(0xd2)]||function(_0x1d9a38){const _0x2d402=_0x40d048;var _0x268139=[];for(var _0x550237 in _0x1d9a38)if(Object[_0x2d402(0xbe)]['hasOwnProperty'][_0x2d402(0x10d)](_0x1d9a38,_0x550237))_0x268139[_0x268139['length']]=_0x550237;return _0x268139;},_0x4e1779(_0x4540ca);};return function(_0x3add30){const _0x5a14ec=a8_0x2f5d;if(_0x3add30&&_0x3add30['__esModule'])return _0x3add30;var _0x3f6eeb={};if(_0x3add30!=null){for(var _0x4f88f5=_0x4e1779(_0x3add30),_0x1e776e=0x0;_0x1e776e<_0x4f88f5[_0x5a14ec(0x113)];_0x1e776e++)if(_0x4f88f5[_0x1e776e]!==_0x5a14ec(0xb3))__createBinding(_0x3f6eeb,_0x3add30,_0x4f88f5[_0x1e776e]);}return __setModuleDefault(_0x3f6eeb,_0x3add30),_0x3f6eeb;};}()),__importDefault=this&&this[a8_0x47fe66(0x12d)]||function(_0x1e819){const _0x52a802=a8_0x47fe66;return _0x1e819&&_0x1e819[_0x52a802(0xc2)]?_0x1e819:{'default':_0x1e819};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a8_0x47fe66(0xe8)]=void 0x0;function a8_0x2136(){const _0x3e219c=['last_name','settings','resolve','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','744480rZbpyc','PAID','toISOString','getPaymentStatus','defineProperty','status','1MyELVO','\x20\x20\x20Result\x20URL\x20(webhook):\x20','MasterCardService','paid','Payment\x20processed\x20successfully','application/json','gatewayPaymentId','593706EqSOkU','../config/database','now','createPublicPayment','../services/telegramBotService','3DS\x20verification\x20required','__importDefault','💳\x20MasterCard\x20URLs:','default','getPaymentById','Error\x20parsing\x20webhook\x20events:','📝\x20Customer\x20data:','orderId','sendPaymentStatusNotification','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','final','217077WlsGkc','createdAt','slice','prototype','updatedAt','../services/paymentLinkService','1409319nusiPf','__esModule','updatePaymentCustomer','sendPaymentNotification','stringify','body','threeds_url','PENDING','params','PaymentService',',\x20cannot\x20process','💳\x20Card\x20holder:\x20','WebhookService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20not\x20found','23765igqEPt','72fDMusC','getOwnPropertyNames','webhookUrl','failUrl','then','shop','Payment\x20created\x20successfully','1767030cXNpML','__createBinding','../services/webhookService','gateway_payment_id','first_name','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','failed','includes','__importStar','POST','requires_3ds','../services/gateways/mastercardService','currency','payment','gatewayOrderId','toLowerCase','PaymentController','create','gateway','log','22hGBpRr','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','MasterCard\x20webhook\x20sent\x20to\x20','writable','💳\x20MasterCard\x20result:','customerEmail','replace','paymentMethod','Customer\x20data\x20updated\x20successfully','json','successUrl','customerIp','ms)','paidAt','Payment\x20status\x20is\x20','error','paymentService','payment.success','mastercard','webhookEvents','payment.failed','isArray','masterCardService','updatePaymentCustomerDataPublic','shopId','customerCountry','email','7732URZldL','126mbBABp','sendShopWebhook','findUnique','📈\x20MasterCard\x20payment\x20','../services/paymentService','call','configurable','474uFmAtS','amount','cardLast4','💳\x20Browser\x20IP:\x20','length','FAILED','Failed\x20to\x20send\x20MasterCard\x20webhook:'];a8_0x2136=function(){return _0x3e219c;};return a8_0x2136();}const paymentService_1=require(a8_0x47fe66(0x10c)),mastercardService_1=require(a8_0x47fe66(0xe3)),webhookService_1=require(a8_0x47fe66(0xda)),database_1=__importDefault(require(a8_0x47fe66(0x128)));class PaymentController{constructor(){const _0x4be52f=a8_0x47fe66;this[_0x4be52f(0x12a)]=async(_0x1f9d1d,_0x1ad34a,_0x2b11c2)=>{const _0x4a4198=_0x4be52f;try{const _0xb8a696=_0x1f9d1d['body'],_0x27f432=await this['paymentService'][_0x4a4198(0x12a)](_0xb8a696);_0x1ad34a[_0x4a4198(0x11f)](0xc9)[_0x4a4198(0xf5)]({'success':!![],'message':_0x4a4198(0xd7),'result':_0x27f432});}catch(_0x2076a2){_0x2b11c2(_0x2076a2);}},this['getPaymentStatus']=async(_0x3d6e85,_0x4e1a8f,_0x291f40)=>{const _0x14fd1c=_0x4be52f;try{const {id:_0x5039b3}=_0x3d6e85[_0x14fd1c(0xc9)],_0x527c01=await this[_0x14fd1c(0xfc)][_0x14fd1c(0x11d)](_0x5039b3);if(!_0x527c01)return _0x4e1a8f[_0x14fd1c(0x11f)](0x194)['json']({'success':![],'message':_0x14fd1c(0xcf)});_0x4e1a8f[_0x14fd1c(0xf5)]({'success':!![],'result':_0x527c01});}catch(_0x3f38c9){_0x291f40(_0x3f38c9);}},this['getPaymentById']=async(_0x1f4124,_0x4cc925,_0x584127)=>{const _0x14a984=_0x4be52f;try{const {id:_0x2c93d0}=_0x1f4124[_0x14a984(0xc9)],_0x49c10c=await this['paymentService'][_0x14a984(0xb4)](_0x2c93d0);if(!_0x49c10c)return _0x4cc925[_0x14a984(0x11f)](0x194)['json']({'success':![],'message':_0x14a984(0xcf)});_0x4cc925[_0x14a984(0xf5)]({'success':!![],'result':_0x49c10c});}catch(_0x362739){_0x584127(_0x362739);}},this[_0x4be52f(0xc3)]=async(_0x84539b,_0x5abfa8,_0x42074d)=>{const _0x490a32=_0x4be52f;try{const {id:_0x519697}=_0x84539b[_0x490a32(0xc9)],_0x4e2ad9=_0x84539b[_0x490a32(0xc6)];console[_0x490a32(0xeb)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x519697),console['log'](_0x490a32(0xb6),_0x4e2ad9);const _0x2a6c51=await this[_0x490a32(0xfc)][_0x490a32(0x103)](_0x519697,_0x4e2ad9);if(!_0x2a6c51)return _0x5abfa8[_0x490a32(0x11f)](0x194)[_0x490a32(0xf5)]({'success':![],'message':_0x490a32(0xcf)});_0x5abfa8[_0x490a32(0xf5)]({'success':!![],'message':_0x490a32(0xf4),'result':{'paymentId':_0x2a6c51['id'],'customerIp':_0x2a6c51[_0x490a32(0xf7)],'customerUa':_0x2a6c51['customerUa'],'customerCountry':_0x2a6c51[_0x490a32(0x105)],'updatedAt':_0x2a6c51[_0x490a32(0xbf)]}});}catch(_0x4e89c4){_0x42074d(_0x4e89c4);}},this['processMasterCardPayment']=async(_0x37aeb1,_0x2e7028,_0x4ca385)=>{const _0x5e56bd=_0x4be52f;try{const {id:_0x411749}=_0x37aeb1[_0x5e56bd(0xc9)],{cardData:_0x180537,cardHolder:_0x12c878,browser:_0x185b4b}=_0x37aeb1[_0x5e56bd(0xc6)];console[_0x5e56bd(0xeb)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x411749),console[_0x5e56bd(0xeb)](_0x5e56bd(0xcc)+_0x12c878[_0x5e56bd(0xdc)]+'\x20'+_0x12c878[_0x5e56bd(0x116)]+'\x20('+_0x12c878[_0x5e56bd(0x106)]+')'),console['log'](_0x5e56bd(0x112)+_0x185b4b['ip']);const _0x317b3e={'customerName':_0x12c878[_0x5e56bd(0xdc)]+'\x20'+_0x12c878['last_name'],'customerEmail':_0x12c878[_0x5e56bd(0x106)],'customerIp':_0x185b4b['ip'],'customerUa':_0x185b4b['user_agent']},_0x49231b=await database_1[_0x5e56bd(0xb3)][_0x5e56bd(0xe5)][_0x5e56bd(0x10a)]({'where':{'id':_0x411749},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x49231b)return _0x2e7028[_0x5e56bd(0x11f)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x49231b[_0x5e56bd(0xea)]!==_0x5e56bd(0xfe))return _0x2e7028[_0x5e56bd(0x11f)](0x190)[_0x5e56bd(0xf5)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x49231b['status']!==_0x5e56bd(0xc8))return _0x2e7028[_0x5e56bd(0x11f)](0x190)[_0x5e56bd(0xf5)]({'success':![],'message':_0x5e56bd(0xfa)+_0x49231b['status']+_0x5e56bd(0xcb)});await database_1[_0x5e56bd(0xb3)][_0x5e56bd(0xe5)]['update']({'where':{'id':_0x411749},'data':{..._0x317b3e,'updatedAt':new Date()}});const _0x9a6421='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x590e63=_0x49231b[_0x5e56bd(0xf6)];console[_0x5e56bd(0xeb)](_0x5e56bd(0xb2)),console[_0x5e56bd(0xeb)](_0x5e56bd(0x121)+_0x9a6421),console[_0x5e56bd(0xeb)]('\x20\x20\x20Return\x20URL:\x20'+_0x590e63);const _0x37fae7={'first_name':_0x12c878[_0x5e56bd(0xdc)],'last_name':_0x12c878['last_name'],'email':_0x12c878[_0x5e56bd(0x106)]},_0x2842e4=await this[_0x5e56bd(0x102)]['processCardPayment']({'paymentId':_0x49231b['id'],'orderId':_0x49231b['gatewayOrderId']||_0x49231b['id'],'amount':_0x49231b['amount'],'currency':_0x49231b[_0x5e56bd(0xe4)],'cardData':_0x180537,'resultUrl':_0x9a6421,'returnUrl':_0x590e63,'cardHolder':_0x37fae7,'browser':_0x185b4b});console['log'](_0x5e56bd(0xf0),_0x2842e4);const _0x123105={'status':_0x2842e4['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x2842e4[_0x5e56bd(0xdb)]&&(_0x123105[_0x5e56bd(0x126)]=_0x2842e4[_0x5e56bd(0xdb)],console['log']('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x2842e4['gateway_payment_id']));if(_0x2842e4['status']==='PAID')_0x123105[_0x5e56bd(0xf9)]=new Date();else _0x2842e4['status']===_0x5e56bd(0x114)&&(_0x123105['failureMessage']='Card\x20payment\x20failed');_0x123105[_0x5e56bd(0xf3)]=_0x5e56bd(0xfe);if(_0x180537['number']){const _0xc1bba=_0x180537['number'][_0x5e56bd(0xf2)](/[\s-]/g,'');_0x123105[_0x5e56bd(0x111)]=_0xc1bba[_0x5e56bd(0xbd)](-0x4),console[_0x5e56bd(0xeb)](_0x5e56bd(0xed)+_0x123105[_0x5e56bd(0x111)]);}await database_1['default'][_0x5e56bd(0xe5)]['update']({'where':{'id':_0x49231b['id']},'data':_0x123105}),await database_1[_0x5e56bd(0xb3)]['webhookLog'][_0x5e56bd(0xe9)]({'data':{'paymentId':_0x49231b['id'],'shopId':_0x49231b[_0x5e56bd(0x104)],'event':'mastercard_'+_0x2842e4['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5e56bd(0xc5)]({'oldStatus':_0x5e56bd(0xc8),'newStatus':_0x2842e4[_0x5e56bd(0x11f)],'gatewayPaymentId':_0x2842e4['gateway_payment_id'],'requires3ds':_0x2842e4[_0x5e56bd(0xe2)],'processedAt':new Date()[_0x5e56bd(0x11c)]()})}});if(_0x2842e4[_0x5e56bd(0xba)]){await this[_0x5e56bd(0x109)](_0x49231b,_0x2842e4['status'],_0x2842e4[_0x5e56bd(0xdb)]),await this['sendPaymentStatusNotification'](_0x49231b,_0x2842e4[_0x5e56bd(0x11f)]);if(_0x2842e4[_0x5e56bd(0x11f)]===_0x5e56bd(0x11b)){console[_0x5e56bd(0xeb)](_0x5e56bd(0x10b)+_0x411749+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x2208ee}=await Promise[_0x5e56bd(0x118)]()[_0x5e56bd(0xd5)](()=>__importStar(require(_0x5e56bd(0xc0)))),_0x5418a9=new _0x2208ee();await _0x5418a9['handleSuccessfulPayment'](_0x411749),console[_0x5e56bd(0xeb)](_0x5e56bd(0xb9)+_0x411749);}catch(_0x347d01){console['error'](_0x5e56bd(0x119),_0x347d01);}}}console[_0x5e56bd(0xeb)]('✅\x20MasterCard\x20payment\x20'+_0x411749+'\x20processed:\x20'+_0x2842e4['status']);if(_0x2842e4[_0x5e56bd(0x11f)]===_0x5e56bd(0x11b))_0x2e7028[_0x5e56bd(0xf5)]({'success':!![],'message':_0x5e56bd(0x124),'result':{'status':_0x5e56bd(0x11b),'gatewayPaymentId':_0x2842e4[_0x5e56bd(0xdb)],'redirectUrl':_0x590e63,'final':!![]}});else _0x2842e4[_0x5e56bd(0xe2)]&&_0x2842e4[_0x5e56bd(0xc7)]?_0x2e7028[_0x5e56bd(0xf5)]({'success':!![],'message':_0x5e56bd(0x12c),'result':{'status':_0x5e56bd(0xc8),'gatewayPaymentId':_0x2842e4[_0x5e56bd(0xdb)],'redirectUrl':_0x2842e4[_0x5e56bd(0xc7)],'requires3ds':!![],'final':![]}}):_0x2e7028['status'](0x190)[_0x5e56bd(0xf5)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x5e56bd(0x114),'gatewayPaymentId':_0x2842e4[_0x5e56bd(0xdb)],'redirectUrl':_0x49231b[_0x5e56bd(0xd4)],'final':!![]}});}catch(_0x480b43){_0x4ca385(_0x480b43);}},this[_0x4be52f(0xfc)]=new paymentService_1[(_0x4be52f(0xca))](),this[_0x4be52f(0x102)]=new mastercardService_1[(_0x4be52f(0x122))](),this['webhookService']=new webhookService_1[(_0x4be52f(0xcd))]();}async[a8_0x47fe66(0x109)](_0x291a19,_0x32f4aa,_0x44a0d7){const _0x64fb5a=a8_0x47fe66,_0x6386ef=Date[_0x64fb5a(0x129)]();try{const _0x3f138d=_0x291a19[_0x64fb5a(0xd6)],_0x2f02bc=_0x3f138d[_0x64fb5a(0x117)];if(!_0x2f02bc?.['webhookUrl']){console[_0x64fb5a(0xeb)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3f138d['id']);return;}const _0x6e844d=_0x32f4aa===_0x64fb5a(0x11b)?_0x64fb5a(0xfd):_0x64fb5a(0x100);let _0x36194a=[];if(_0x2f02bc[_0x64fb5a(0xff)])try{_0x36194a=Array[_0x64fb5a(0x101)](_0x2f02bc[_0x64fb5a(0xff)])?_0x2f02bc[_0x64fb5a(0xff)]:JSON['parse'](_0x2f02bc[_0x64fb5a(0xff)]);}catch(_0x4248f6){console[_0x64fb5a(0xfb)](_0x64fb5a(0xb5),_0x4248f6),_0x36194a=[];}if(!_0x36194a[_0x64fb5a(0xdf)](_0x6e844d)){console[_0x64fb5a(0xeb)]('Webhook\x20event\x20'+_0x6e844d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3f138d['id']);return;}const _0x1143b5={'event':_0x6e844d,'payment':{'id':_0x291a19['id'],'order_id':_0x291a19[_0x64fb5a(0xb7)],'gateway_order_id':_0x291a19[_0x64fb5a(0xe6)],'gateway':'1111','amount':_0x291a19[_0x64fb5a(0x110)],'currency':_0x291a19[_0x64fb5a(0xe4)],'status':_0x32f4aa[_0x64fb5a(0xe7)](),'customer_email':_0x291a19[_0x64fb5a(0xf1)],'customer_name':_0x291a19['customerName'],'gateway_payment_id':_0x44a0d7,'created_at':_0x291a19[_0x64fb5a(0xbc)],'updated_at':new Date()}},_0x5b4d46=await fetch(_0x2f02bc[_0x64fb5a(0xd3)],{'method':_0x64fb5a(0xe1),'headers':{'Content-Type':_0x64fb5a(0x125),'User-Agent':_0x64fb5a(0xce)},'body':JSON[_0x64fb5a(0xc5)](_0x1143b5)}),_0x45e8a6=Date[_0x64fb5a(0x129)]()-_0x6386ef;console[_0x64fb5a(0xeb)](_0x64fb5a(0xee)+_0x2f02bc[_0x64fb5a(0xd3)]+'\x20with\x20status\x20'+_0x5b4d46[_0x64fb5a(0x11f)]+'\x20('+_0x45e8a6+_0x64fb5a(0xf8));}catch(_0x1bf301){console['error'](_0x64fb5a(0x115),_0x1bf301);}}async[a8_0x47fe66(0xb8)](_0x2c2aba,_0x355663){const _0x2de5b2=a8_0x47fe66;try{const {telegramBotService:_0x11672e}=await Promise[_0x2de5b2(0x118)]()[_0x2de5b2(0xd5)](()=>__importStar(require(_0x2de5b2(0x12b)))),_0x2c065d={'PAID':_0x2de5b2(0x123),'FAILED':_0x2de5b2(0xde)},_0x18b140=_0x2c065d[_0x355663];if(!_0x18b140)return;await _0x11672e[_0x2de5b2(0xc4)](_0x2c2aba[_0x2de5b2(0x104)],_0x2c2aba,_0x18b140);}catch(_0x54499d){console[_0x2de5b2(0xfb)](_0x2de5b2(0xdd),_0x54499d);}}}exports[a8_0x47fe66(0xe8)]=PaymentController;