'use strict';const a8_0x5a9f15=a8_0x73f4;(function(_0x138237,_0x31323f){const _0x3a7a36=a8_0x73f4,_0xe5dd2f=_0x138237();while(!![]){try{const _0x223562=-parseInt(_0x3a7a36(0x10e))/0x1+-parseInt(_0x3a7a36(0x103))/0x2+-parseInt(_0x3a7a36(0xb2))/0x3*(parseInt(_0x3a7a36(0x106))/0x4)+-parseInt(_0x3a7a36(0xcd))/0x5+-parseInt(_0x3a7a36(0xfb))/0x6*(-parseInt(_0x3a7a36(0x108))/0x7)+parseInt(_0x3a7a36(0xd8))/0x8*(-parseInt(_0x3a7a36(0xd5))/0x9)+parseInt(_0x3a7a36(0x117))/0xa;if(_0x223562===_0x31323f)break;else _0xe5dd2f['push'](_0xe5dd2f['shift']());}catch(_0x52a860){_0xe5dd2f['push'](_0xe5dd2f['shift']());}}}(a8_0x4f7f,0x1af35));var __createBinding=this&&this[a8_0x5a9f15(0xfe)]||(Object[a8_0x5a9f15(0xcf)]?function(_0x51afc7,_0x993c1a,_0x292418,_0x40619a){const _0x20e076=a8_0x5a9f15;if(_0x40619a===undefined)_0x40619a=_0x292418;var _0x59dec5=Object[_0x20e076(0xac)](_0x993c1a,_0x292418);(!_0x59dec5||(_0x20e076(0xb0)in _0x59dec5?!_0x993c1a[_0x20e076(0x116)]:_0x59dec5[_0x20e076(0xb4)]||_0x59dec5['configurable']))&&(_0x59dec5={'enumerable':!![],'get':function(){return _0x993c1a[_0x292418];}}),Object[_0x20e076(0xbc)](_0x51afc7,_0x40619a,_0x59dec5);}:function(_0xec7e05,_0x3e7f92,_0x44852a,_0x4af37e){if(_0x4af37e===undefined)_0x4af37e=_0x44852a;_0xec7e05[_0x4af37e]=_0x3e7f92[_0x44852a];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x5a9f15(0xcf)]?function(_0xa7b971,_0x18ed0f){const _0x5e5b11=a8_0x5a9f15;Object[_0x5e5b11(0xbc)](_0xa7b971,'default',{'enumerable':!![],'value':_0x18ed0f});}:function(_0x5c05b3,_0x48a093){const _0x541e2e=a8_0x5a9f15;_0x5c05b3[_0x541e2e(0x118)]=_0x48a093;}),__importStar=this&&this[a8_0x5a9f15(0xc6)]||(function(){var _0x4e6f10=function(_0x5ee39a){return _0x4e6f10=Object['getOwnPropertyNames']||function(_0x49e6c8){const _0x143209=a8_0x73f4;var _0x558a3e=[];for(var _0x4e3752 in _0x49e6c8)if(Object['prototype'][_0x143209(0xe3)]['call'](_0x49e6c8,_0x4e3752))_0x558a3e[_0x558a3e[_0x143209(0x119)]]=_0x4e3752;return _0x558a3e;},_0x4e6f10(_0x5ee39a);};return function(_0x36c312){const _0x3a6f6e=a8_0x73f4;if(_0x36c312&&_0x36c312['__esModule'])return _0x36c312;var _0x57d4a8={};if(_0x36c312!=null){for(var _0x4c84ca=_0x4e6f10(_0x36c312),_0x26bed4=0x0;_0x26bed4<_0x4c84ca[_0x3a6f6e(0x119)];_0x26bed4++)if(_0x4c84ca[_0x26bed4]!==_0x3a6f6e(0x118))__createBinding(_0x57d4a8,_0x36c312,_0x4c84ca[_0x26bed4]);}return __setModuleDefault(_0x57d4a8,_0x36c312),_0x57d4a8;};}()),__importDefault=this&&this[a8_0x5a9f15(0xef)]||function(_0x55d04b){return _0x55d04b&&_0x55d04b['__esModule']?_0x55d04b:{'default':_0x55d04b};};Object[a8_0x5a9f15(0xbc)](exports,a8_0x5a9f15(0x116),{'value':!![]}),exports[a8_0x5a9f15(0xdd)]=void 0x0;function a8_0x4f7f(){const _0x295864=['settings','../config/database','Payment\x20processed\x20successfully','parse','application/json','...','__esModule','6024330mKjzPa','default','length','substring','sendPaymentNotification','includes','toISOString','failureMessage','WebhookService','getOwnPropertyDescriptor','failed','Failed\x20to\x20send\x20MasterCard\x20webhook:','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','get','final','17574SCPaCR','masterCardService','writable','processMasterCardPayment','json','toLowerCase','gatewayOrderId','Payment\x20failed','now','../services/paymentService','defineProperty','ms)','gatewayPaymentId','âœ…\x20MasterCard\x20payment\x20','getPaymentById','Customer\x20data\x20updated\x20successfully','body','findUnique','failUrl','MasterCard\x20webhook\x20sent\x20to\x20','__importStar','shop','sendPaymentStatusNotification','webhookEvents','isArray','PAID','customerEmail','302935xazYkK','Webhook\x20event\x20','create','payment.success','status','system','webhookUrl','FAILED','1434051ahzfwR','createPublicPayment','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','8OFtemO','Payment\x20status\x20is\x20','../services/webhookService','ðŸ’³\x20MasterCard\x20URLs:','createdAt','PaymentController','orderId','requires_3ds','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','amount','webhookLog','hasOwnProperty','MasterCardService','resolve','https://api.trapay.uk/api/webhooks/gateway/mastercard','payment.failed','params','then','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','threeds_url','\x20with\x20status\x20','gateway','not\x20provided','__importDefault','processCardPayment','payment','shopId','../services/telegramBotService','stringify','paidAt','paymentService','Payment\x20created\x20successfully','currency','update','\x20not\x20enabled\x20for\x20shop\x20','378ywDCJc','Payment\x20not\x20found','error','__createBinding','../services/gateways/mastercardService','1111','gateway_payment_id','sendShopWebhook','203222cKUbnX','log','Card\x20payment\x20failed','100oLcOEY','updateCustomerData','3388JVddPu','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway',',\x20cannot\x20process','mastercard','webhookService','getPaymentStatus','54549ZjslUe','\x20\x20\x20Return\x20URL:\x20'];a8_0x4f7f=function(){return _0x295864;};return a8_0x4f7f();}const paymentService_1=require(a8_0x5a9f15(0xbb)),mastercardService_1=require(a8_0x5a9f15(0xff)),webhookService_1=require(a8_0x5a9f15(0xda)),database_1=__importDefault(require(a8_0x5a9f15(0x111)));class PaymentController{constructor(){const _0x297794=a8_0x5a9f15;this[_0x297794(0xd6)]=async(_0x491fba,_0x5dcee5,_0x5f3a0a)=>{const _0x4d9b78=_0x297794;try{const _0x40064f=_0x491fba[_0x4d9b78(0xc2)],_0x3f6151=await this[_0x4d9b78(0xf6)][_0x4d9b78(0xd6)](_0x40064f);_0x5dcee5[_0x4d9b78(0xd1)](0xc9)['json']({'success':!![],'message':_0x4d9b78(0xf7),'result':_0x3f6151});}catch(_0x3412c5){_0x5f3a0a(_0x3412c5);}},this[_0x297794(0x10d)]=async(_0x49b337,_0x2c73cf,_0x3650e8)=>{const _0x4c3d6f=_0x297794;try{const {id:_0x5fbab2}=_0x49b337['params'],_0x4c322a=await this[_0x4c3d6f(0xf6)][_0x4c3d6f(0x10d)](_0x5fbab2);if(!_0x4c322a)return _0x2c73cf['status'](0x194)['json']({'success':![],'message':_0x4c3d6f(0xfc)});_0x2c73cf[_0x4c3d6f(0xb6)]({'success':!![],'result':_0x4c322a});}catch(_0x57cd0e){_0x3650e8(_0x57cd0e);}},this[_0x297794(0xc0)]=async(_0x24325a,_0x300619,_0x2c1290)=>{const _0x5d14f6=_0x297794;try{const {id:_0x12f04a}=_0x24325a['params'],_0x2af1af=await this[_0x5d14f6(0xf6)][_0x5d14f6(0xc0)](_0x12f04a);if(!_0x2af1af)return _0x300619[_0x5d14f6(0xd1)](0x194)[_0x5d14f6(0xb6)]({'success':![],'message':_0x5d14f6(0xfc)});_0x300619['json']({'success':!![],'result':_0x2af1af});}catch(_0xb9eb08){_0x2c1290(_0xb9eb08);}},this[_0x297794(0xb5)]=async(_0x519041,_0x3ef22,_0x4afadb)=>{const _0x3be663=_0x297794;try{const {id:_0x4da90e}=_0x519041[_0x3be663(0xe8)],{cardData:_0x193121,cardHolder:_0x4ad18c,browser:_0x21ee86}=_0x519041[_0x3be663(0xc2)];console[_0x3be663(0x104)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x4da90e);const _0x3ef7d2=await database_1['default'][_0x3be663(0xf1)][_0x3be663(0xc3)]({'where':{'id':_0x4da90e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3ef7d2)return _0x3ef22['status'](0x194)['json']({'success':![],'message':_0x3be663(0xfc)});if(_0x3ef7d2[_0x3be663(0xed)]!=='mastercard')return _0x3ef22['status'](0x190)[_0x3be663(0xb6)]({'success':![],'message':_0x3be663(0x109)});if(_0x3ef7d2['status']!=='PENDING')return _0x3ef22[_0x3be663(0xd1)](0x190)[_0x3be663(0xb6)]({'success':![],'message':_0x3be663(0xd9)+_0x3ef7d2[_0x3be663(0xd1)]+_0x3be663(0x10a)});const _0x149404=_0x3be663(0xe6),_0x20cabd=_0x3ef7d2['successUrl'];console[_0x3be663(0x104)](_0x3be663(0xdb)),console[_0x3be663(0x104)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x149404),console[_0x3be663(0x104)](_0x3be663(0x10f)+_0x20cabd);const _0x49c8fa=await this[_0x3be663(0xb3)][_0x3be663(0xf0)]({'paymentId':_0x3ef7d2['id'],'orderId':_0x3ef7d2[_0x3be663(0xb8)]||_0x3ef7d2['id'],'amount':_0x3ef7d2['amount'],'currency':_0x3ef7d2[_0x3be663(0xf8)],'cardData':_0x193121,'resultUrl':_0x149404,'returnUrl':_0x20cabd,'cardHolder':_0x4ad18c,'browser':_0x21ee86});console[_0x3be663(0x104)]('ðŸ’³\x20MasterCard\x20result:',_0x49c8fa);const _0x4d91f7={'status':_0x49c8fa[_0x3be663(0xd1)],'updatedAt':new Date(),'statusChangedBy':_0x3be663(0xd2),'statusChangedAt':new Date()};if(_0x49c8fa[_0x3be663(0xd1)]===_0x3be663(0xcb))_0x4d91f7[_0x3be663(0xf5)]=new Date(),_0x4d91f7[_0x3be663(0xbe)]=_0x49c8fa[_0x3be663(0x101)];else _0x49c8fa[_0x3be663(0xd1)]===_0x3be663(0xd4)&&(_0x4d91f7[_0x3be663(0xaa)]=_0x3be663(0x105));_0x4d91f7['paymentMethod']=_0x3be663(0x10b),await database_1[_0x3be663(0x118)][_0x3be663(0xf1)][_0x3be663(0xf9)]({'where':{'id':_0x3ef7d2['id']},'data':_0x4d91f7}),await database_1[_0x3be663(0x118)][_0x3be663(0xe2)][_0x3be663(0xcf)]({'data':{'paymentId':_0x3ef7d2['id'],'shopId':_0x3ef7d2[_0x3be663(0xf2)],'event':'mastercard_'+_0x49c8fa[_0x3be663(0xd1)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x3be663(0xf4)]({'oldStatus':'PENDING','newStatus':_0x49c8fa[_0x3be663(0xd1)],'gatewayPaymentId':_0x49c8fa[_0x3be663(0x101)],'requires3ds':_0x49c8fa[_0x3be663(0xdf)],'processedAt':new Date()[_0x3be663(0xa9)]()})}});_0x49c8fa[_0x3be663(0xb1)]&&(await this[_0x3be663(0x102)](_0x3ef7d2,_0x49c8fa[_0x3be663(0xd1)],_0x49c8fa[_0x3be663(0x101)]),await this[_0x3be663(0xc8)](_0x3ef7d2,_0x49c8fa[_0x3be663(0xd1)]));console['log'](_0x3be663(0xbf)+_0x4da90e+'\x20processed:\x20'+_0x49c8fa[_0x3be663(0xd1)]);if(_0x49c8fa[_0x3be663(0xd1)]===_0x3be663(0xcb))_0x3ef22[_0x3be663(0xb6)]({'success':!![],'message':_0x3be663(0x112),'result':{'status':_0x3be663(0xcb),'gatewayPaymentId':_0x49c8fa[_0x3be663(0x101)],'redirectUrl':_0x20cabd,'final':!![]}});else _0x49c8fa[_0x3be663(0xdf)]&&_0x49c8fa[_0x3be663(0xeb)]?_0x3ef22['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x49c8fa[_0x3be663(0x101)],'redirectUrl':_0x49c8fa[_0x3be663(0xeb)],'requires3ds':!![],'final':![]}}):_0x3ef22[_0x3be663(0xd1)](0x190)[_0x3be663(0xb6)]({'success':![],'message':_0x3be663(0xb9),'result':{'status':_0x3be663(0xd4),'gatewayPaymentId':_0x49c8fa[_0x3be663(0x101)],'redirectUrl':_0x3ef7d2[_0x3be663(0xc4)],'final':!![]}});}catch(_0x1a944f){_0x4afadb(_0x1a944f);}},this[_0x297794(0x107)]=async(_0x15463e,_0x42c8f6,_0x558be8)=>{const _0x4873d3=_0x297794;try{const {id:_0x40956b}=_0x15463e['params'],{customerIp:_0x3af52c,customerUa:_0x27d9c2,customerCountry:_0x2e7136}=_0x15463e[_0x4873d3(0xc2)],_0x2cbfe2=await database_1[_0x4873d3(0x118)][_0x4873d3(0xf1)][_0x4873d3(0xc3)]({'where':{'id':_0x40956b},'select':{'id':!![],'status':!![]}});if(!_0x2cbfe2)return _0x42c8f6['status'](0x194)[_0x4873d3(0xb6)]({'success':![],'message':_0x4873d3(0xfc)});const _0x4567c3=await database_1[_0x4873d3(0x118)][_0x4873d3(0xf1)][_0x4873d3(0xf9)]({'where':{'id':_0x40956b},'data':{'customerIp':_0x3af52c||undefined,'customerUa':_0x27d9c2||undefined,'customerCountry':_0x2e7136||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x4873d3(0x104)](_0x4873d3(0xe0)+_0x40956b+':',{'customerIp':_0x3af52c||_0x4873d3(0xee),'customerUa':_0x27d9c2?_0x27d9c2[_0x4873d3(0x11a)](0x0,0x32)+_0x4873d3(0x115):_0x4873d3(0xee),'customerCountry':_0x2e7136||_0x4873d3(0xee)}),_0x42c8f6['json']({'success':!![],'message':_0x4873d3(0xc1),'result':_0x4567c3});}catch(_0x35bace){_0x558be8(_0x35bace);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x297794(0xb3)]=new mastercardService_1[(_0x297794(0xe4))](),this[_0x297794(0x10c)]=new webhookService_1[(_0x297794(0xab))]();}async[a8_0x5a9f15(0x102)](_0x549469,_0xef50f,_0x4fe361){const _0x33fcfa=a8_0x5a9f15,_0x36a664=Date[_0x33fcfa(0xba)]();try{const _0x872f63=_0x549469[_0x33fcfa(0xc7)],_0x5ee31b=_0x872f63[_0x33fcfa(0x110)];if(!_0x5ee31b?.[_0x33fcfa(0xd3)]){console[_0x33fcfa(0x104)](_0x33fcfa(0xd7)+_0x872f63['id']);return;}const _0x226cfe=_0xef50f==='PAID'?_0x33fcfa(0xd0):_0x33fcfa(0xe7);let _0x272fa0=[];if(_0x5ee31b[_0x33fcfa(0xc9)])try{_0x272fa0=Array[_0x33fcfa(0xca)](_0x5ee31b['webhookEvents'])?_0x5ee31b[_0x33fcfa(0xc9)]:JSON[_0x33fcfa(0x113)](_0x5ee31b['webhookEvents']);}catch(_0xb61ce8){console[_0x33fcfa(0xfd)]('Error\x20parsing\x20webhook\x20events:',_0xb61ce8),_0x272fa0=[];}if(!_0x272fa0[_0x33fcfa(0xa8)](_0x226cfe)){console[_0x33fcfa(0x104)](_0x33fcfa(0xce)+_0x226cfe+_0x33fcfa(0xfa)+_0x872f63['id']);return;}const _0x2cae09={'event':_0x226cfe,'payment':{'id':_0x549469['id'],'order_id':_0x549469[_0x33fcfa(0xde)],'gateway_order_id':_0x549469[_0x33fcfa(0xb8)],'gateway':_0x33fcfa(0x100),'amount':_0x549469[_0x33fcfa(0xe1)],'currency':_0x549469['currency'],'status':_0xef50f[_0x33fcfa(0xb7)](),'customer_email':_0x549469[_0x33fcfa(0xcc)],'customer_name':_0x549469['customerName'],'gateway_payment_id':_0x4fe361,'created_at':_0x549469[_0x33fcfa(0xdc)],'updated_at':new Date()}},_0x4e340f=await fetch(_0x5ee31b[_0x33fcfa(0xd3)],{'method':'POST','headers':{'Content-Type':_0x33fcfa(0x114),'User-Agent':_0x33fcfa(0xaf)},'body':JSON[_0x33fcfa(0xf4)](_0x2cae09)}),_0x4595bf=Date['now']()-_0x36a664;console[_0x33fcfa(0x104)](_0x33fcfa(0xc5)+_0x5ee31b[_0x33fcfa(0xd3)]+_0x33fcfa(0xec)+_0x4e340f[_0x33fcfa(0xd1)]+'\x20('+_0x4595bf+_0x33fcfa(0xbd));}catch(_0x379672){console[_0x33fcfa(0xfd)](_0x33fcfa(0xae),_0x379672);}}async['sendPaymentStatusNotification'](_0x340140,_0x514ff1){const _0x2c1c42=a8_0x5a9f15;try{const {telegramBotService:_0x248aaf}=await Promise[_0x2c1c42(0xe5)]()[_0x2c1c42(0xe9)](()=>__importStar(require(_0x2c1c42(0xf3)))),_0x191f66={'PAID':'paid','FAILED':_0x2c1c42(0xad)},_0x2c3b5b=_0x191f66[_0x514ff1];if(!_0x2c3b5b)return;await _0x248aaf[_0x2c1c42(0x11b)](_0x340140['shopId'],_0x340140,_0x2c3b5b);}catch(_0x1828e9){console[_0x2c1c42(0xfd)](_0x2c1c42(0xea),_0x1828e9);}}}function a8_0x73f4(_0x38d931,_0x49307f){const _0x4f7fb7=a8_0x4f7f();return a8_0x73f4=function(_0x73f415,_0x82f08){_0x73f415=_0x73f415-0xa8;let _0x1234fe=_0x4f7fb7[_0x73f415];return _0x1234fe;},a8_0x73f4(_0x38d931,_0x49307f);}exports['PaymentController']=PaymentController;