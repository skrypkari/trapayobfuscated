'use strict';function a8_0x4ff6(){const _0xc888d9=['3751139gDKQGH','mastercard_','2552445ygeqLj','__importStar','sendPaymentNotification','webhookEvents','316924rvhJnv','Card\x20payment\x20failed','\x20\x20\x20Result\x20URL\x20(webhook):\x20','ms)','../services/paymentService','defineProperty','failUrl','final','updatedAt','create','PENDING','now','settings','gateway_payment_id','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','POST','log','1111','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PaymentController','amount','webhookService','4941zBQkWI','parse','1eEqsWw','4966776itXhJi','configurable','\x20processed:\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','Payment\x20failed','webhookUrl','toISOString','status','sendShopWebhook','failed','gateway','‚úÖ\x20MasterCard\x20payment\x20','https://api.trapay.uk/api/webhooks/gateway/mastercard','includes','payment.failed','../services/webhookService','shopId','FAILED','currency','gatewayOrderId','payment','3DS\x20verification\x20required','writable','default','__esModule','masterCardService','json','Payment\x20created\x20successfully','orderId','isArray','../services/gateways/mastercardService','sendPaymentStatusNotification','createdAt','update','customerName','toLowerCase','get','Webhook\x20event\x20','params','application/json','1471400fiZAin','paymentService','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','getPaymentById','11288tgaYAC','WebhookService','length','\x20with\x20status\x20','Customer\x20data\x20updated\x20successfully','customerUa','Payment\x20processed\x20successfully','getPaymentStatus','Failed\x20to\x20send\x20MasterCard\x20webhook:','Payment\x20status\x20is\x20','threeds_url','prototype','Payment\x20not\x20found','failureMessage','body','findUnique','gatewayPaymentId','requires_3ds','customerIp','successUrl','customerCountry','updatePaymentCustomerDataPublic','üí≥\x20MasterCard\x20URLs:','updatePaymentCustomer','MasterCardService','paymentMethod','getOwnPropertyDescriptor','stringify','error','createPublicPayment','üìù\x20Customer\x20data:','\x20not\x20enabled\x20for\x20shop\x20','PAID','3036474DekRcU','mastercard','processMasterCardPayment','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'];a8_0x4ff6=function(){return _0xc888d9;};return a8_0x4ff6();}function a8_0x5719(_0x4c344a,_0x992cc6){const _0x4ff6f7=a8_0x4ff6();return a8_0x5719=function(_0x571989,_0x1a8796){_0x571989=_0x571989-0x1d8;let _0x5c1d70=_0x4ff6f7[_0x571989];return _0x5c1d70;},a8_0x5719(_0x4c344a,_0x992cc6);}const a8_0x424486=a8_0x5719;(function(_0x515f0c,_0x5aa99e){const _0x331394=a8_0x5719,_0x4759ac=_0x515f0c();while(!![]){try{const _0x54cd66=-parseInt(_0x331394(0x1f0))/0x1*(-parseInt(_0x331394(0x1d8))/0x2)+parseInt(_0x331394(0x23e))/0x3+-parseInt(_0x331394(0x219))/0x4+parseInt(_0x331394(0x244))/0x5+parseInt(_0x331394(0x1f1))/0x6+-parseInt(_0x331394(0x242))/0x7+parseInt(_0x331394(0x21d))/0x8*(-parseInt(_0x331394(0x1ee))/0x9);if(_0x54cd66===_0x5aa99e)break;else _0x4759ac['push'](_0x4759ac['shift']());}catch(_0x8dc271){_0x4759ac['push'](_0x4759ac['shift']());}}}(a8_0x4ff6,0xcac4b));var __createBinding=this&&this['__createBinding']||(Object[a8_0x424486(0x1e1)]?function(_0x565477,_0x6e0c1f,_0x11071e,_0x580fb2){const _0xa96de6=a8_0x424486;if(_0x580fb2===undefined)_0x580fb2=_0x11071e;var _0x54863a=Object[_0xa96de6(0x237)](_0x6e0c1f,_0x11071e);(!_0x54863a||(_0xa96de6(0x215)in _0x54863a?!_0x6e0c1f['__esModule']:_0x54863a[_0xa96de6(0x207)]||_0x54863a[_0xa96de6(0x1f2)]))&&(_0x54863a={'enumerable':!![],'get':function(){return _0x6e0c1f[_0x11071e];}}),Object[_0xa96de6(0x1dd)](_0x565477,_0x580fb2,_0x54863a);}:function(_0x24e195,_0x531648,_0x2b1424,_0xfc6c56){if(_0xfc6c56===undefined)_0xfc6c56=_0x2b1424;_0x24e195[_0xfc6c56]=_0x531648[_0x2b1424];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x424486(0x1e1)]?function(_0x12d227,_0x46cfce){const _0x279c8e=a8_0x424486;Object[_0x279c8e(0x1dd)](_0x12d227,_0x279c8e(0x208),{'enumerable':!![],'value':_0x46cfce});}:function(_0x598320,_0x54d9e0){_0x598320['default']=_0x54d9e0;}),__importStar=this&&this[a8_0x424486(0x245)]||(function(){var _0x15c65a=function(_0x4249e2){return _0x15c65a=Object['getOwnPropertyNames']||function(_0x10165c){const _0x21e706=a8_0x5719;var _0x44074d=[];for(var _0x1bae1c in _0x10165c)if(Object[_0x21e706(0x228)]['hasOwnProperty']['call'](_0x10165c,_0x1bae1c))_0x44074d[_0x44074d['length']]=_0x1bae1c;return _0x44074d;},_0x15c65a(_0x4249e2);};return function(_0x1c6cc6){const _0xa1531f=a8_0x5719;if(_0x1c6cc6&&_0x1c6cc6[_0xa1531f(0x209)])return _0x1c6cc6;var _0x682b24={};if(_0x1c6cc6!=null){for(var _0x5b18c3=_0x15c65a(_0x1c6cc6),_0x43cf40=0x0;_0x43cf40<_0x5b18c3[_0xa1531f(0x21f)];_0x43cf40++)if(_0x5b18c3[_0x43cf40]!==_0xa1531f(0x208))__createBinding(_0x682b24,_0x1c6cc6,_0x5b18c3[_0x43cf40]);}return __setModuleDefault(_0x682b24,_0x1c6cc6),_0x682b24;};}()),__importDefault=this&&this['__importDefault']||function(_0x5633ff){const _0xd791b9=a8_0x424486;return _0x5633ff&&_0x5633ff[_0xd791b9(0x209)]?_0x5633ff:{'default':_0x5633ff};};Object[a8_0x424486(0x1dd)](exports,a8_0x424486(0x209),{'value':!![]}),exports[a8_0x424486(0x1eb)]=void 0x0;const paymentService_1=require(a8_0x424486(0x1dc)),mastercardService_1=require(a8_0x424486(0x20f)),webhookService_1=require(a8_0x424486(0x200)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x4bf0a5=a8_0x424486;this[_0x4bf0a5(0x23a)]=async(_0x47ed8c,_0x368fc0,_0x1da3eb)=>{const _0x3b3d3f=_0x4bf0a5;try{const _0x194fc5=_0x47ed8c[_0x3b3d3f(0x22b)],_0x11194e=await this[_0x3b3d3f(0x21a)]['createPublicPayment'](_0x194fc5);_0x368fc0['status'](0xc9)[_0x3b3d3f(0x20b)]({'success':!![],'message':_0x3b3d3f(0x20c),'result':_0x11194e});}catch(_0xd0a66){_0x1da3eb(_0xd0a66);}},this[_0x4bf0a5(0x224)]=async(_0x28c175,_0x4384c2,_0xa847cf)=>{const _0x31bcce=_0x4bf0a5;try{const {id:_0x2457a1}=_0x28c175[_0x31bcce(0x217)],_0x45e313=await this['paymentService']['getPaymentStatus'](_0x2457a1);if(!_0x45e313)return _0x4384c2[_0x31bcce(0x1f8)](0x194)[_0x31bcce(0x20b)]({'success':![],'message':_0x31bcce(0x229)});_0x4384c2['json']({'success':!![],'result':_0x45e313});}catch(_0x169a92){_0xa847cf(_0x169a92);}},this[_0x4bf0a5(0x21c)]=async(_0x3617c3,_0x16e26e,_0x31f50e)=>{const _0x12c505=_0x4bf0a5;try{const {id:_0x472f93}=_0x3617c3['params'],_0x174471=await this['paymentService']['getPaymentById'](_0x472f93);if(!_0x174471)return _0x16e26e[_0x12c505(0x1f8)](0x194)[_0x12c505(0x20b)]({'success':![],'message':_0x12c505(0x229)});_0x16e26e[_0x12c505(0x20b)]({'success':!![],'result':_0x174471});}catch(_0x4b998e){_0x31f50e(_0x4b998e);}},this[_0x4bf0a5(0x234)]=async(_0x3d473a,_0x5b70ad,_0x1ccf1f)=>{const _0x2b4bb3=_0x4bf0a5;try{const {id:_0x1ba8d5}=_0x3d473a[_0x2b4bb3(0x217)],_0xd6af8a=_0x3d473a[_0x2b4bb3(0x22b)];console[_0x2b4bb3(0x1e8)](_0x2b4bb3(0x21b)+_0x1ba8d5),console[_0x2b4bb3(0x1e8)](_0x2b4bb3(0x23b),_0xd6af8a);const _0x228451=await this['paymentService'][_0x2b4bb3(0x232)](_0x1ba8d5,_0xd6af8a);if(!_0x228451)return _0x5b70ad['status'](0x194)[_0x2b4bb3(0x20b)]({'success':![],'message':_0x2b4bb3(0x229)});_0x5b70ad[_0x2b4bb3(0x20b)]({'success':!![],'message':_0x2b4bb3(0x221),'result':{'paymentId':_0x228451['id'],'customerIp':_0x228451[_0x2b4bb3(0x22f)],'customerUa':_0x228451[_0x2b4bb3(0x222)],'customerCountry':_0x228451[_0x2b4bb3(0x231)],'updatedAt':_0x228451[_0x2b4bb3(0x1e0)]}});}catch(_0x26a796){_0x1ccf1f(_0x26a796);}},this[_0x4bf0a5(0x240)]=async(_0x6c890b,_0x183849,_0x2ef64a)=>{const _0x2d137f=_0x4bf0a5;try{const {id:_0x3e51a6}=_0x6c890b[_0x2d137f(0x217)],{cardData:_0x20f21d,cardHolder:_0x44589c,browser:_0xad337a}=_0x6c890b[_0x2d137f(0x22b)];console['log']('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x3e51a6);const _0x5eb6ec=await database_1[_0x2d137f(0x208)]['payment'][_0x2d137f(0x22c)]({'where':{'id':_0x3e51a6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5eb6ec)return _0x183849[_0x2d137f(0x1f8)](0x194)[_0x2d137f(0x20b)]({'success':![],'message':_0x2d137f(0x229)});if(_0x5eb6ec[_0x2d137f(0x1fb)]!==_0x2d137f(0x23f))return _0x183849[_0x2d137f(0x1f8)](0x190)[_0x2d137f(0x20b)]({'success':![],'message':_0x2d137f(0x1e6)});if(_0x5eb6ec[_0x2d137f(0x1f8)]!==_0x2d137f(0x1e2))return _0x183849['status'](0x190)[_0x2d137f(0x20b)]({'success':![],'message':_0x2d137f(0x226)+_0x5eb6ec[_0x2d137f(0x1f8)]+',\x20cannot\x20process'});const _0x246003=_0x2d137f(0x1fd),_0x58f960=_0x5eb6ec[_0x2d137f(0x230)];console['log'](_0x2d137f(0x233)),console[_0x2d137f(0x1e8)](_0x2d137f(0x1da)+_0x246003),console[_0x2d137f(0x1e8)]('\x20\x20\x20Return\x20URL:\x20'+_0x58f960);const _0x216123=await this[_0x2d137f(0x20a)]['processCardPayment']({'paymentId':_0x5eb6ec['id'],'orderId':_0x5eb6ec[_0x2d137f(0x204)]||_0x5eb6ec['id'],'amount':_0x5eb6ec[_0x2d137f(0x1ec)],'currency':_0x5eb6ec[_0x2d137f(0x203)],'cardData':_0x20f21d,'resultUrl':_0x246003,'returnUrl':_0x58f960,'cardHolder':_0x44589c,'browser':_0xad337a});console[_0x2d137f(0x1e8)]('üí≥\x20MasterCard\x20result:',_0x216123);const _0x2eef95={'status':_0x216123[_0x2d137f(0x1f8)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x216123[_0x2d137f(0x1f8)]===_0x2d137f(0x23d))_0x2eef95['paidAt']=new Date(),_0x2eef95[_0x2d137f(0x22d)]=_0x216123[_0x2d137f(0x1e5)];else _0x216123['status']===_0x2d137f(0x202)&&(_0x2eef95[_0x2d137f(0x22a)]=_0x2d137f(0x1d9));_0x2eef95[_0x2d137f(0x236)]=_0x2d137f(0x23f),await database_1[_0x2d137f(0x208)][_0x2d137f(0x205)][_0x2d137f(0x212)]({'where':{'id':_0x5eb6ec['id']},'data':_0x2eef95}),await database_1['default']['webhookLog'][_0x2d137f(0x1e1)]({'data':{'paymentId':_0x5eb6ec['id'],'shopId':_0x5eb6ec[_0x2d137f(0x201)],'event':_0x2d137f(0x243)+_0x216123[_0x2d137f(0x1f8)]?.[_0x2d137f(0x214)](),'statusCode':0xc8,'responseBody':JSON[_0x2d137f(0x238)]({'oldStatus':'PENDING','newStatus':_0x216123[_0x2d137f(0x1f8)],'gatewayPaymentId':_0x216123[_0x2d137f(0x1e5)],'requires3ds':_0x216123[_0x2d137f(0x22e)],'processedAt':new Date()[_0x2d137f(0x1f7)]()})}});_0x216123[_0x2d137f(0x1df)]&&(await this['sendShopWebhook'](_0x5eb6ec,_0x216123[_0x2d137f(0x1f8)],_0x216123['gateway_payment_id']),await this[_0x2d137f(0x210)](_0x5eb6ec,_0x216123[_0x2d137f(0x1f8)]));console[_0x2d137f(0x1e8)](_0x2d137f(0x1fc)+_0x3e51a6+_0x2d137f(0x1f3)+_0x216123[_0x2d137f(0x1f8)]);if(_0x216123[_0x2d137f(0x1f8)]===_0x2d137f(0x23d))_0x183849['json']({'success':!![],'message':_0x2d137f(0x223),'result':{'status':_0x2d137f(0x23d),'gatewayPaymentId':_0x216123[_0x2d137f(0x1e5)],'redirectUrl':_0x58f960,'final':!![]}});else _0x216123['requires_3ds']&&_0x216123[_0x2d137f(0x227)]?_0x183849[_0x2d137f(0x20b)]({'success':!![],'message':_0x2d137f(0x206),'result':{'status':_0x2d137f(0x1e2),'gatewayPaymentId':_0x216123[_0x2d137f(0x1e5)],'redirectUrl':_0x216123[_0x2d137f(0x227)],'requires3ds':!![],'final':![]}}):_0x183849['status'](0x190)[_0x2d137f(0x20b)]({'success':![],'message':_0x2d137f(0x1f5),'result':{'status':_0x2d137f(0x202),'gatewayPaymentId':_0x216123[_0x2d137f(0x1e5)],'redirectUrl':_0x5eb6ec[_0x2d137f(0x1de)],'final':!![]}});}catch(_0x5e9b62){_0x2ef64a(_0x5e9b62);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x4bf0a5(0x20a)]=new mastercardService_1[(_0x4bf0a5(0x235))](),this[_0x4bf0a5(0x1ed)]=new webhookService_1[(_0x4bf0a5(0x21e))]();}async[a8_0x424486(0x1f9)](_0x22903c,_0x50a241,_0x5413f8){const _0x4c690b=a8_0x424486,_0x21d474=Date[_0x4c690b(0x1e3)]();try{const _0x233802=_0x22903c['shop'],_0x4d909b=_0x233802[_0x4c690b(0x1e4)];if(!_0x4d909b?.[_0x4c690b(0x1f6)]){console[_0x4c690b(0x1e8)](_0x4c690b(0x1f4)+_0x233802['id']);return;}const _0x288359=_0x50a241===_0x4c690b(0x23d)?'payment.success':_0x4c690b(0x1ff);let _0x142d5a=[];if(_0x4d909b[_0x4c690b(0x247)])try{_0x142d5a=Array[_0x4c690b(0x20e)](_0x4d909b[_0x4c690b(0x247)])?_0x4d909b['webhookEvents']:JSON[_0x4c690b(0x1ef)](_0x4d909b[_0x4c690b(0x247)]);}catch(_0x415a4e){console['error']('Error\x20parsing\x20webhook\x20events:',_0x415a4e),_0x142d5a=[];}if(!_0x142d5a[_0x4c690b(0x1fe)](_0x288359)){console[_0x4c690b(0x1e8)](_0x4c690b(0x216)+_0x288359+_0x4c690b(0x23c)+_0x233802['id']);return;}const _0x4d7ef4={'event':_0x288359,'payment':{'id':_0x22903c['id'],'order_id':_0x22903c[_0x4c690b(0x20d)],'gateway_order_id':_0x22903c[_0x4c690b(0x204)],'gateway':_0x4c690b(0x1e9),'amount':_0x22903c[_0x4c690b(0x1ec)],'currency':_0x22903c[_0x4c690b(0x203)],'status':_0x50a241[_0x4c690b(0x214)](),'customer_email':_0x22903c['customerEmail'],'customer_name':_0x22903c[_0x4c690b(0x213)],'gateway_payment_id':_0x5413f8,'created_at':_0x22903c[_0x4c690b(0x211)],'updated_at':new Date()}},_0x4d581e=await fetch(_0x4d909b[_0x4c690b(0x1f6)],{'method':_0x4c690b(0x1e7),'headers':{'Content-Type':_0x4c690b(0x218),'User-Agent':_0x4c690b(0x241)},'body':JSON[_0x4c690b(0x238)](_0x4d7ef4)}),_0x142444=Date[_0x4c690b(0x1e3)]()-_0x21d474;console['log']('MasterCard\x20webhook\x20sent\x20to\x20'+_0x4d909b[_0x4c690b(0x1f6)]+_0x4c690b(0x220)+_0x4d581e[_0x4c690b(0x1f8)]+'\x20('+_0x142444+_0x4c690b(0x1db));}catch(_0x3fd3d0){console[_0x4c690b(0x239)](_0x4c690b(0x225),_0x3fd3d0);}}async[a8_0x424486(0x210)](_0x29f40c,_0x33d228){const _0x57aded=a8_0x424486;try{const {telegramBotService:_0x4f22f7}=await Promise['resolve']()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x3a1dd7={'PAID':'paid','FAILED':_0x57aded(0x1fa)},_0x3a3bd5=_0x3a1dd7[_0x33d228];if(!_0x3a3bd5)return;await _0x4f22f7[_0x57aded(0x246)](_0x29f40c[_0x57aded(0x201)],_0x29f40c,_0x3a3bd5);}catch(_0x5f450a){console[_0x57aded(0x239)](_0x57aded(0x1ea),_0x5f450a);}}}exports[a8_0x424486(0x1eb)]=PaymentController;