'use strict';const a8_0x492e47=a8_0x94f3;(function(_0x2bebde,_0x518df1){const _0x2d00b7=a8_0x94f3,_0x45f046=_0x2bebde();while(!![]){try{const _0x1946b2=parseInt(_0x2d00b7(0x206))/0x1+-parseInt(_0x2d00b7(0x1ff))/0x2*(-parseInt(_0x2d00b7(0x1d4))/0x3)+parseInt(_0x2d00b7(0x1d7))/0x4+parseInt(_0x2d00b7(0x1a9))/0x5*(-parseInt(_0x2d00b7(0x1d6))/0x6)+parseInt(_0x2d00b7(0x1e7))/0x7*(-parseInt(_0x2d00b7(0x207))/0x8)+parseInt(_0x2d00b7(0x1fa))/0x9+-parseInt(_0x2d00b7(0x1fe))/0xa*(-parseInt(_0x2d00b7(0x1c7))/0xb);if(_0x1946b2===_0x518df1)break;else _0x45f046['push'](_0x45f046['shift']());}catch(_0x12885b){_0x45f046['push'](_0x45f046['shift']());}}}(a8_0x554c,0x44980));function a8_0x94f3(_0x34bb5e,_0x31c4a4){const _0x554ccb=a8_0x554c();return a8_0x94f3=function(_0x94f35,_0x3fd5c8){_0x94f35=_0x94f35-0x1a6;let _0x14889c=_0x554ccb[_0x94f35];return _0x14889c;},a8_0x94f3(_0x34bb5e,_0x31c4a4);}var __createBinding=this&&this[a8_0x492e47(0x211)]||(Object[a8_0x492e47(0x1ae)]?function(_0x48d06f,_0x2c9cb0,_0x5235cf,_0xc4b867){const _0x5bac53=a8_0x492e47;if(_0xc4b867===undefined)_0xc4b867=_0x5235cf;var _0x1219a1=Object[_0x5bac53(0x1d3)](_0x2c9cb0,_0x5235cf);(!_0x1219a1||('get'in _0x1219a1?!_0x2c9cb0[_0x5bac53(0x1b4)]:_0x1219a1[_0x5bac53(0x20d)]||_0x1219a1[_0x5bac53(0x1eb)]))&&(_0x1219a1={'enumerable':!![],'get':function(){return _0x2c9cb0[_0x5235cf];}}),Object[_0x5bac53(0x1bc)](_0x48d06f,_0xc4b867,_0x1219a1);}:function(_0x576476,_0x2b0eb8,_0x1cae9e,_0x4e17d6){if(_0x4e17d6===undefined)_0x4e17d6=_0x1cae9e;_0x576476[_0x4e17d6]=_0x2b0eb8[_0x1cae9e];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x492e47(0x1ae)]?function(_0x540df2,_0x52cbb3){Object['defineProperty'](_0x540df2,'default',{'enumerable':!![],'value':_0x52cbb3});}:function(_0x56af27,_0x2d730d){const _0x5d03ce=a8_0x492e47;_0x56af27[_0x5d03ce(0x1bb)]=_0x2d730d;}),__importStar=this&&this[a8_0x492e47(0x1ad)]||(function(){var _0x49f01e=function(_0x5135ac){return _0x49f01e=Object['getOwnPropertyNames']||function(_0x39095){const _0x57cc39=a8_0x94f3;var _0x1526df=[];for(var _0x1f827f in _0x39095)if(Object[_0x57cc39(0x1e3)][_0x57cc39(0x1c0)][_0x57cc39(0x1a8)](_0x39095,_0x1f827f))_0x1526df[_0x1526df['length']]=_0x1f827f;return _0x1526df;},_0x49f01e(_0x5135ac);};return function(_0x40778f){const _0x37fb1d=a8_0x94f3;if(_0x40778f&&_0x40778f[_0x37fb1d(0x1b4)])return _0x40778f;var _0x244d16={};if(_0x40778f!=null){for(var _0x3319ad=_0x49f01e(_0x40778f),_0x54c7e9=0x0;_0x54c7e9<_0x3319ad['length'];_0x54c7e9++)if(_0x3319ad[_0x54c7e9]!==_0x37fb1d(0x1bb))__createBinding(_0x244d16,_0x40778f,_0x3319ad[_0x54c7e9]);}return __setModuleDefault(_0x244d16,_0x40778f),_0x244d16;};}()),__importDefault=this&&this[a8_0x492e47(0x1e2)]||function(_0x310da8){return _0x310da8&&_0x310da8['__esModule']?_0x310da8:{'default':_0x310da8};};Object[a8_0x492e47(0x1bc)](exports,a8_0x492e47(0x1b4),{'value':!![]}),exports[a8_0x492e47(0x1d8)]=void 0x0;function a8_0x554c(){const _0x1d6d36=['now','168970MfkAEH','1976clMcDo','threeds_url','successUrl','WebhookService','Payment\x20not\x20found','processMasterCardPayment','writable','params','../config/database','mastercard_','__createBinding','amount','gateway','call','554105nWfZYV','MasterCardService','includes','Failed\x20to\x20send\x20MasterCard\x20webhook:','__importStar','create','shopId','log','masterCardService','parse','orderId','__esModule','shop','PAID','getPaymentStatus','../services/webhookService','getPaymentById','Customer\x20data\x20updated\x20successfully','default','defineProperty','Payment\x20failed','gatewayPaymentId','\x20processed:\x20','hasOwnProperty','gateway_payment_id','paidAt','gatewayOrderId','body','isArray','status','1232tzqRfi','https://api.trapay.uk/api/webhooks/gateway/mastercard','json','paymentService','createPublicPayment','../services/paymentService','failUrl','Payment\x20status\x20is\x20','failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','ðŸ’³\x20MasterCard\x20URLs:','\x20not\x20enabled\x20for\x20shop\x20','getOwnPropertyDescriptor','2685TYVvSx','Card\x20payment\x20failed','30jBPdAc','940660KrXwAW','PaymentController','webhookService','sendShopWebhook','\x20\x20\x20Result\x20URL\x20(webhook):\x20','not\x20provided','processCardPayment','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','sendPaymentStatusNotification','customerName','system','__importDefault','prototype','1111','FAILED','application/json','6188zhYHLK','webhookUrl','Webhook\x20event\x20','findUnique','configurable','payment','paid','mastercard','customerEmail','../services/gateways/mastercardService','payment.success','sendPaymentNotification','createdAt','final','webhookEvents','resolve','stringify','toISOString','POST','4820391tnSvKR',',\x20cannot\x20process','toLowerCase','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','1120fLaEtE','226vJykBZ','âœ…\x20MasterCard\x20payment\x20','currency','PENDING','error','MasterCard\x20webhook\x20sent\x20to\x20'];a8_0x554c=function(){return _0x1d6d36;};return a8_0x554c();}const paymentService_1=require(a8_0x492e47(0x1cc)),mastercardService_1=require(a8_0x492e47(0x1f0)),webhookService_1=require(a8_0x492e47(0x1b8)),database_1=__importDefault(require(a8_0x492e47(0x20f)));class PaymentController{constructor(){const _0x45f315=a8_0x492e47;this[_0x45f315(0x1cb)]=async(_0x262290,_0x52c07e,_0xd98fee)=>{const _0x5ac74=_0x45f315;try{const _0x3cd72a=_0x262290[_0x5ac74(0x1c4)],_0x313212=await this[_0x5ac74(0x1ca)][_0x5ac74(0x1cb)](_0x3cd72a);_0x52c07e[_0x5ac74(0x1c6)](0xc9)['json']({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x313212});}catch(_0x2edb9a){_0xd98fee(_0x2edb9a);}},this[_0x45f315(0x1b7)]=async(_0x4cc6b3,_0x621835,_0x268617)=>{const _0x1237be=_0x45f315;try{const {id:_0x40ac2a}=_0x4cc6b3[_0x1237be(0x20e)],_0x27a3bd=await this[_0x1237be(0x1ca)]['getPaymentStatus'](_0x40ac2a);if(!_0x27a3bd)return _0x621835[_0x1237be(0x1c6)](0x194)[_0x1237be(0x1c9)]({'success':![],'message':_0x1237be(0x20b)});_0x621835[_0x1237be(0x1c9)]({'success':!![],'result':_0x27a3bd});}catch(_0x557568){_0x268617(_0x557568);}},this[_0x45f315(0x1b9)]=async(_0x31c48e,_0x17a5a7,_0x579229)=>{const _0x4066f5=_0x45f315;try{const {id:_0x128e11}=_0x31c48e[_0x4066f5(0x20e)],_0x5b01ae=await this[_0x4066f5(0x1ca)][_0x4066f5(0x1b9)](_0x128e11);if(!_0x5b01ae)return _0x17a5a7[_0x4066f5(0x1c6)](0x194)['json']({'success':![],'message':_0x4066f5(0x20b)});_0x17a5a7['json']({'success':!![],'result':_0x5b01ae});}catch(_0x402d56){_0x579229(_0x402d56);}},this[_0x45f315(0x20c)]=async(_0x2866bd,_0x313630,_0x7f7e2a)=>{const _0x122261=_0x45f315;try{const {id:_0x36f724}=_0x2866bd[_0x122261(0x20e)],{cardData:_0x28cd6e,cardHolder:_0x29d5f5,browser:_0x227360}=_0x2866bd[_0x122261(0x1c4)];console[_0x122261(0x1b0)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x36f724);const _0x16f9ac=await database_1['default'][_0x122261(0x1ec)][_0x122261(0x1ea)]({'where':{'id':_0x36f724},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x16f9ac)return _0x313630['status'](0x194)[_0x122261(0x1c9)]({'success':![],'message':_0x122261(0x20b)});if(_0x16f9ac[_0x122261(0x1a7)]!==_0x122261(0x1ee))return _0x313630[_0x122261(0x1c6)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x16f9ac['status']!==_0x122261(0x202))return _0x313630['status'](0x190)[_0x122261(0x1c9)]({'success':![],'message':_0x122261(0x1ce)+_0x16f9ac[_0x122261(0x1c6)]+_0x122261(0x1fb)});const _0x510cff=_0x122261(0x1c8),_0x219231=_0x16f9ac[_0x122261(0x209)];console[_0x122261(0x1b0)](_0x122261(0x1d1)),console[_0x122261(0x1b0)](_0x122261(0x1db)+_0x510cff),console[_0x122261(0x1b0)]('\x20\x20\x20Return\x20URL:\x20'+_0x219231);const _0x2d5574=await this[_0x122261(0x1b1)][_0x122261(0x1dd)]({'paymentId':_0x16f9ac['id'],'orderId':_0x16f9ac['gatewayOrderId']||_0x16f9ac['id'],'amount':_0x16f9ac[_0x122261(0x1a6)],'currency':_0x16f9ac[_0x122261(0x201)],'cardData':_0x28cd6e,'resultUrl':_0x510cff,'returnUrl':_0x219231,'cardHolder':_0x29d5f5,'browser':_0x227360});console[_0x122261(0x1b0)]('ðŸ’³\x20MasterCard\x20result:',_0x2d5574);const _0x468e5d={'status':_0x2d5574[_0x122261(0x1c6)],'updatedAt':new Date(),'statusChangedBy':_0x122261(0x1e1),'statusChangedAt':new Date()};if(_0x2d5574[_0x122261(0x1c6)]===_0x122261(0x1b6))_0x468e5d[_0x122261(0x1c2)]=new Date(),_0x468e5d[_0x122261(0x1be)]=_0x2d5574[_0x122261(0x1c1)];else _0x2d5574[_0x122261(0x1c6)]===_0x122261(0x1e5)&&(_0x468e5d['failureMessage']=_0x122261(0x1d5));_0x468e5d['paymentMethod']='mastercard',await database_1[_0x122261(0x1bb)]['payment']['update']({'where':{'id':_0x16f9ac['id']},'data':_0x468e5d}),await database_1[_0x122261(0x1bb)]['webhookLog'][_0x122261(0x1ae)]({'data':{'paymentId':_0x16f9ac['id'],'shopId':_0x16f9ac[_0x122261(0x1af)],'event':_0x122261(0x210)+_0x2d5574[_0x122261(0x1c6)]?.[_0x122261(0x1fc)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x122261(0x202),'newStatus':_0x2d5574[_0x122261(0x1c6)],'gatewayPaymentId':_0x2d5574['gateway_payment_id'],'requires3ds':_0x2d5574['requires_3ds'],'processedAt':new Date()[_0x122261(0x1f8)]()})}});_0x2d5574[_0x122261(0x1f4)]&&(await this[_0x122261(0x1da)](_0x16f9ac,_0x2d5574[_0x122261(0x1c6)],_0x2d5574['gateway_payment_id']),await this[_0x122261(0x1df)](_0x16f9ac,_0x2d5574[_0x122261(0x1c6)]));console[_0x122261(0x1b0)](_0x122261(0x200)+_0x36f724+_0x122261(0x1bf)+_0x2d5574[_0x122261(0x1c6)]);if(_0x2d5574[_0x122261(0x1c6)]===_0x122261(0x1b6))_0x313630[_0x122261(0x1c9)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','gatewayPaymentId':_0x2d5574[_0x122261(0x1c1)],'redirectUrl':_0x219231,'final':!![]}});else _0x2d5574['requires_3ds']&&_0x2d5574[_0x122261(0x208)]?_0x313630[_0x122261(0x1c9)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x122261(0x202),'gatewayPaymentId':_0x2d5574[_0x122261(0x1c1)],'redirectUrl':_0x2d5574[_0x122261(0x208)],'requires3ds':!![],'final':![]}}):_0x313630[_0x122261(0x1c6)](0x190)[_0x122261(0x1c9)]({'success':![],'message':_0x122261(0x1bd),'result':{'status':_0x122261(0x1e5),'gatewayPaymentId':_0x2d5574[_0x122261(0x1c1)],'redirectUrl':_0x16f9ac[_0x122261(0x1cd)],'final':!![]}});}catch(_0x119bcf){_0x7f7e2a(_0x119bcf);}},this['updateCustomerData']=async(_0x2081c5,_0xbfa377,_0x108545)=>{const _0x1d5bc8=_0x45f315;try{const {id:_0x4d8b1a}=_0x2081c5['params'],{customerIp:_0x4c63fd,customerUa:_0x204b8c,customerCountry:_0x5661ef}=_0x2081c5[_0x1d5bc8(0x1c4)],_0x574b58=await database_1[_0x1d5bc8(0x1bb)]['payment'][_0x1d5bc8(0x1ea)]({'where':{'id':_0x4d8b1a},'select':{'id':!![],'status':!![]}});if(!_0x574b58)return _0xbfa377[_0x1d5bc8(0x1c6)](0x194)[_0x1d5bc8(0x1c9)]({'success':![],'message':_0x1d5bc8(0x20b)});const _0x1b737b=await database_1[_0x1d5bc8(0x1bb)][_0x1d5bc8(0x1ec)]['update']({'where':{'id':_0x4d8b1a},'data':{'customerIp':_0x4c63fd||undefined,'customerUa':_0x204b8c||undefined,'customerCountry':_0x5661ef||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x1d5bc8(0x1b0)](_0x1d5bc8(0x1de)+_0x4d8b1a+':',{'customerIp':_0x4c63fd||_0x1d5bc8(0x1dc),'customerUa':_0x204b8c?_0x204b8c['substring'](0x0,0x32)+'...':_0x1d5bc8(0x1dc),'customerCountry':_0x5661ef||'not\x20provided'}),_0xbfa377['json']({'success':!![],'message':_0x1d5bc8(0x1ba),'result':_0x1b737b});}catch(_0x24d4f5){_0x108545(_0x24d4f5);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x45f315(0x1b1)]=new mastercardService_1[(_0x45f315(0x1aa))](),this[_0x45f315(0x1d9)]=new webhookService_1[(_0x45f315(0x20a))]();}async[a8_0x492e47(0x1da)](_0x100df6,_0x1becd6,_0x43f505){const _0x17db66=a8_0x492e47,_0x5036a6=Date[_0x17db66(0x205)]();try{const _0x492d36=_0x100df6[_0x17db66(0x1b5)],_0x5b757b=_0x492d36['settings'];if(!_0x5b757b?.[_0x17db66(0x1e8)]){console[_0x17db66(0x1b0)](_0x17db66(0x1fd)+_0x492d36['id']);return;}const _0x3c758c=_0x1becd6===_0x17db66(0x1b6)?_0x17db66(0x1f1):'payment.failed';let _0x351e7f=[];if(_0x5b757b['webhookEvents'])try{_0x351e7f=Array[_0x17db66(0x1c5)](_0x5b757b['webhookEvents'])?_0x5b757b['webhookEvents']:JSON[_0x17db66(0x1b2)](_0x5b757b[_0x17db66(0x1f5)]);}catch(_0xe26a9c){console['error']('Error\x20parsing\x20webhook\x20events:',_0xe26a9c),_0x351e7f=[];}if(!_0x351e7f[_0x17db66(0x1ab)](_0x3c758c)){console['log'](_0x17db66(0x1e9)+_0x3c758c+_0x17db66(0x1d2)+_0x492d36['id']);return;}const _0x4bd60e={'event':_0x3c758c,'payment':{'id':_0x100df6['id'],'order_id':_0x100df6[_0x17db66(0x1b3)],'gateway_order_id':_0x100df6[_0x17db66(0x1c3)],'gateway':_0x17db66(0x1e4),'amount':_0x100df6['amount'],'currency':_0x100df6[_0x17db66(0x201)],'status':_0x1becd6[_0x17db66(0x1fc)](),'customer_email':_0x100df6[_0x17db66(0x1ef)],'customer_name':_0x100df6[_0x17db66(0x1e0)],'gateway_payment_id':_0x43f505,'created_at':_0x100df6[_0x17db66(0x1f3)],'updated_at':new Date()}},_0x1aad99=await fetch(_0x5b757b[_0x17db66(0x1e8)],{'method':_0x17db66(0x1f9),'headers':{'Content-Type':_0x17db66(0x1e6),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x17db66(0x1f7)](_0x4bd60e)}),_0x295b07=Date[_0x17db66(0x205)]()-_0x5036a6;console[_0x17db66(0x1b0)](_0x17db66(0x204)+_0x5b757b[_0x17db66(0x1e8)]+'\x20with\x20status\x20'+_0x1aad99['status']+'\x20('+_0x295b07+'ms)');}catch(_0x1c0c65){console['error'](_0x17db66(0x1ac),_0x1c0c65);}}async[a8_0x492e47(0x1df)](_0x45b6c6,_0x19d9d6){const _0x11a7d3=a8_0x492e47;try{const {telegramBotService:_0xba21fd}=await Promise[_0x11a7d3(0x1f6)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x148fae={'PAID':_0x11a7d3(0x1ed),'FAILED':_0x11a7d3(0x1cf)},_0x24fcfb=_0x148fae[_0x19d9d6];if(!_0x24fcfb)return;await _0xba21fd[_0x11a7d3(0x1f2)](_0x45b6c6[_0x11a7d3(0x1af)],_0x45b6c6,_0x24fcfb);}catch(_0x5d0861){console[_0x11a7d3(0x203)](_0x11a7d3(0x1d0),_0x5d0861);}}}exports['PaymentController']=PaymentController;