'use strict';function a8_0x31ef(_0x25ff67,_0x565cd9){const _0x191adc=a8_0x191a();return a8_0x31ef=function(_0x31ef47,_0xe595f7){_0x31ef47=_0x31ef47-0xec;let _0x2bab3e=_0x191adc[_0x31ef47];return _0x2bab3e;},a8_0x31ef(_0x25ff67,_0x565cd9);}const a8_0x4f1e12=a8_0x31ef;(function(_0x5dec15,_0x195792){const _0x25f565=a8_0x31ef,_0x4ae976=_0x5dec15();while(!![]){try{const _0x445b2c=-parseInt(_0x25f565(0x14e))/0x1*(parseInt(_0x25f565(0x158))/0x2)+parseInt(_0x25f565(0x119))/0x3*(-parseInt(_0x25f565(0x14f))/0x4)+parseInt(_0x25f565(0x15d))/0x5+-parseInt(_0x25f565(0x10d))/0x6*(parseInt(_0x25f565(0x150))/0x7)+-parseInt(_0x25f565(0x128))/0x8*(-parseInt(_0x25f565(0x151))/0x9)+parseInt(_0x25f565(0x156))/0xa*(-parseInt(_0x25f565(0x11e))/0xb)+parseInt(_0x25f565(0x11f))/0xc;if(_0x445b2c===_0x195792)break;else _0x4ae976['push'](_0x4ae976['shift']());}catch(_0x73548c){_0x4ae976['push'](_0x4ae976['shift']());}}}(a8_0x191a,0xb79ab));function a8_0x191a(){const _0x9036d3=['PAID','Payment\x20processed\x20successfully','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','params','toLowerCase','PaymentService','40LCgufQ','hasOwnProperty','updatePaymentCustomer','successUrl','sendPaymentNotification','üí≥\x20MasterCard\x20URLs:','getOwnPropertyDescriptor','Payment\x20not\x20found','call','json','then','WebhookService','1111','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','orderId','../services/gateways/mastercardService','includes','payment.success','user_agent','__esModule','mastercard','gateway_payment_id','üí≥\x20MasterCard\x20result:','last_name','getOwnPropertyNames','sendShopWebhook','üìù\x20Customer\x20data:','customerUa','status','POST','PaymentController','3DS\x20verification\x20required','customerEmail','failUrl','customerName','failureMessage','../services/paymentService','toISOString','1fkafZO','4200748VVsYWi','109319OyChyy','660303EirHnt','webhookUrl','default','create','getPaymentById','25770jbWtsE','__setModuleDefault','1211730ypwzXa','amount','log','PENDING','stringify','3334985xwlcrc','get','now','body','createPublicPayment','Payment\x20failed','Webhook\x20event\x20','resolve','shopId','currency','gatewayPaymentId','threeds_url','processMasterCardPayment','createdAt','MasterCardService','webhookEvents','‚úÖ\x20MasterCard\x20payment\x20','application/json','masterCardService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','gatewayOrderId','__createBinding','Failed\x20to\x20send\x20MasterCard\x20webhook:','system','ms)','__importDefault','customerIp','üí≥\x20Processing\x20MasterCard\x20payment:\x20','__importStar','\x20processed:\x20','requires_3ds','processCardPayment','country','shop','../services/telegramBotService','customerCountry','Card\x20payment\x20failed','üí≥\x20Browser\x20IP:\x20','228TxldHd','\x20with\x20status\x20','defineProperty','mastercard_','paid','paidAt','paymentService','\x20not\x20enabled\x20for\x20shop\x20','../config/database','error','update','payment','3iBNgyi','prototype','first_name','failed','isArray','935HBBikq','26241048OzRquI','email','../services/webhookService'];a8_0x191a=function(){return _0x9036d3;};return a8_0x191a();}var __createBinding=this&&this[a8_0x4f1e12(0xfc)]||(Object['create']?function(_0x2aa726,_0x7cdf99,_0x5f471e,_0x563e37){const _0x34445e=a8_0x4f1e12;if(_0x563e37===undefined)_0x563e37=_0x5f471e;var _0x555821=Object[_0x34445e(0x12e)](_0x7cdf99,_0x5f471e);(!_0x555821||(_0x34445e(0x15e)in _0x555821?!_0x7cdf99[_0x34445e(0x13b)]:_0x555821['writable']||_0x555821['configurable']))&&(_0x555821={'enumerable':!![],'get':function(){return _0x7cdf99[_0x5f471e];}}),Object[_0x34445e(0x10f)](_0x2aa726,_0x563e37,_0x555821);}:function(_0x3cf020,_0x487862,_0x27c3a2,_0x236788){if(_0x236788===undefined)_0x236788=_0x27c3a2;_0x3cf020[_0x236788]=_0x487862[_0x27c3a2];}),__setModuleDefault=this&&this[a8_0x4f1e12(0x157)]||(Object['create']?function(_0x58b414,_0x346422){const _0x526109=a8_0x4f1e12;Object[_0x526109(0x10f)](_0x58b414,_0x526109(0x153),{'enumerable':!![],'value':_0x346422});}:function(_0x418536,_0x512937){const _0x115f4f=a8_0x4f1e12;_0x418536[_0x115f4f(0x153)]=_0x512937;}),__importStar=this&&this[a8_0x4f1e12(0x103)]||(function(){var _0x29cffd=function(_0x4fd53d){const _0x351e78=a8_0x31ef;return _0x29cffd=Object[_0x351e78(0x140)]||function(_0x843727){const _0x20c916=_0x351e78;var _0x44121c=[];for(var _0x6a08e6 in _0x843727)if(Object[_0x20c916(0x11a)][_0x20c916(0x129)][_0x20c916(0x130)](_0x843727,_0x6a08e6))_0x44121c[_0x44121c['length']]=_0x6a08e6;return _0x44121c;},_0x29cffd(_0x4fd53d);};return function(_0x134fc7){const _0x223218=a8_0x31ef;if(_0x134fc7&&_0x134fc7[_0x223218(0x13b)])return _0x134fc7;var _0x171e7e={};if(_0x134fc7!=null){for(var _0x425743=_0x29cffd(_0x134fc7),_0x52d781=0x0;_0x52d781<_0x425743['length'];_0x52d781++)if(_0x425743[_0x52d781]!==_0x223218(0x153))__createBinding(_0x171e7e,_0x134fc7,_0x425743[_0x52d781]);}return __setModuleDefault(_0x171e7e,_0x134fc7),_0x171e7e;};}()),__importDefault=this&&this[a8_0x4f1e12(0x100)]||function(_0xdb6401){const _0x4910d8=a8_0x4f1e12;return _0xdb6401&&_0xdb6401[_0x4910d8(0x13b)]?_0xdb6401:{'default':_0xdb6401};};Object[a8_0x4f1e12(0x10f)](exports,a8_0x4f1e12(0x13b),{'value':!![]}),exports[a8_0x4f1e12(0x146)]=void 0x0;const paymentService_1=require(a8_0x4f1e12(0x14c)),mastercardService_1=require(a8_0x4f1e12(0x137)),webhookService_1=require(a8_0x4f1e12(0x121)),database_1=__importDefault(require(a8_0x4f1e12(0x115)));class PaymentController{constructor(){const _0x14769f=a8_0x4f1e12;this[_0x14769f(0x161)]=async(_0x4c26fd,_0x4b5216,_0x27de56)=>{const _0x2806a5=_0x14769f;try{const _0x460495=_0x4c26fd[_0x2806a5(0x160)],_0x325711=await this[_0x2806a5(0x113)][_0x2806a5(0x161)](_0x460495);_0x4b5216[_0x2806a5(0x144)](0xc9)[_0x2806a5(0x131)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x325711});}catch(_0x374d72){_0x27de56(_0x374d72);}},this['getPaymentStatus']=async(_0x4bb013,_0x57610a,_0x1da8db)=>{const _0x559d97=_0x14769f;try{const {id:_0x24f732}=_0x4bb013[_0x559d97(0x125)],_0x53295d=await this['paymentService']['getPaymentStatus'](_0x24f732);if(!_0x53295d)return _0x57610a[_0x559d97(0x144)](0x194)['json']({'success':![],'message':_0x559d97(0x12f)});_0x57610a[_0x559d97(0x131)]({'success':!![],'result':_0x53295d});}catch(_0xdf5073){_0x1da8db(_0xdf5073);}},this[_0x14769f(0x155)]=async(_0x43d56c,_0x1d9584,_0x1bc9f9)=>{const _0x10193f=_0x14769f;try{const {id:_0x26e17c}=_0x43d56c['params'],_0xfa32af=await this[_0x10193f(0x113)]['getPaymentById'](_0x26e17c);if(!_0xfa32af)return _0x1d9584[_0x10193f(0x144)](0x194)[_0x10193f(0x131)]({'success':![],'message':_0x10193f(0x12f)});_0x1d9584[_0x10193f(0x131)]({'success':!![],'result':_0xfa32af});}catch(_0xb19f83){_0x1bc9f9(_0xb19f83);}},this[_0x14769f(0x12a)]=async(_0x3763af,_0x3889c8,_0x2f24a8)=>{const _0x1f647b=_0x14769f;try{const {id:_0x2f6518}=_0x3763af[_0x1f647b(0x125)],_0x939c32=_0x3763af['body'];console[_0x1f647b(0x15a)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x2f6518),console['log'](_0x1f647b(0x142),_0x939c32);const _0x3fe11d=await this[_0x1f647b(0x113)]['updatePaymentCustomerDataPublic'](_0x2f6518,_0x939c32);if(!_0x3fe11d)return _0x3889c8[_0x1f647b(0x144)](0x194)['json']({'success':![],'message':_0x1f647b(0x12f)});_0x3889c8[_0x1f647b(0x131)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x3fe11d['id'],'customerIp':_0x3fe11d[_0x1f647b(0x101)],'customerUa':_0x3fe11d[_0x1f647b(0x143)],'customerCountry':_0x3fe11d[_0x1f647b(0x10a)],'updatedAt':_0x3fe11d['updatedAt']}});}catch(_0x18728e){_0x2f24a8(_0x18728e);}},this[_0x14769f(0xf3)]=async(_0x595540,_0x3beda5,_0x1d52b8)=>{const _0x4814b3=_0x14769f;try{const {id:_0x45e9ed}=_0x595540[_0x4814b3(0x125)],{cardData:_0xf0d41b,cardHolder:_0x42c307,browser:_0x39a783}=_0x595540[_0x4814b3(0x160)];console[_0x4814b3(0x15a)](_0x4814b3(0x102)+_0x45e9ed),console[_0x4814b3(0x15a)]('üí≥\x20Card\x20holder:\x20'+_0x42c307[_0x4814b3(0x11b)]+'\x20'+_0x42c307['last_name']+'\x20('+_0x42c307[_0x4814b3(0x120)]+')'),console[_0x4814b3(0x15a)](_0x4814b3(0x10c)+_0x39a783['ip']);const _0x2ffe6a={'customerName':_0x42c307[_0x4814b3(0x11b)]+'\x20'+_0x42c307[_0x4814b3(0x13f)],'customerEmail':_0x42c307[_0x4814b3(0x120)],'customerIp':_0x39a783['ip'],'customerUa':_0x39a783[_0x4814b3(0x13a)],'customerCountry':_0x42c307[_0x4814b3(0x107)]||null},_0x2e4c78=await database_1[_0x4814b3(0x153)]['payment']['findUnique']({'where':{'id':_0x45e9ed},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2e4c78)return _0x3beda5['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x2e4c78['gateway']!=='mastercard')return _0x3beda5[_0x4814b3(0x144)](0x190)[_0x4814b3(0x131)]({'success':![],'message':_0x4814b3(0x135)});if(_0x2e4c78[_0x4814b3(0x144)]!=='PENDING')return _0x3beda5[_0x4814b3(0x144)](0x190)[_0x4814b3(0x131)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x2e4c78[_0x4814b3(0x144)]+',\x20cannot\x20process'});await database_1['default'][_0x4814b3(0x118)][_0x4814b3(0x117)]({'where':{'id':_0x45e9ed},'data':{..._0x2ffe6a,'updatedAt':new Date()}});const _0x22be00='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x4d6f9c=_0x2e4c78[_0x4814b3(0x12b)];console[_0x4814b3(0x15a)](_0x4814b3(0x12d)),console[_0x4814b3(0x15a)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x22be00),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x4d6f9c);const _0x4e5aea={'first_name':_0x42c307['first_name'],'last_name':_0x42c307[_0x4814b3(0x13f)],'email':_0x42c307['email']},_0x41e4eb=await this['masterCardService'][_0x4814b3(0x106)]({'paymentId':_0x2e4c78['id'],'orderId':_0x2e4c78[_0x4814b3(0xfb)]||_0x2e4c78['id'],'amount':_0x2e4c78[_0x4814b3(0x159)],'currency':_0x2e4c78[_0x4814b3(0xf0)],'cardData':_0xf0d41b,'resultUrl':_0x22be00,'returnUrl':_0x4d6f9c,'cardHolder':_0x4e5aea,'browser':_0x39a783});console[_0x4814b3(0x15a)](_0x4814b3(0x13e),_0x41e4eb);const _0x3ab6f6={'status':_0x41e4eb[_0x4814b3(0x144)],'updatedAt':new Date(),'statusChangedBy':_0x4814b3(0xfe),'statusChangedAt':new Date()};if(_0x41e4eb[_0x4814b3(0x144)]==='PAID')_0x3ab6f6[_0x4814b3(0x112)]=new Date(),_0x3ab6f6[_0x4814b3(0xf1)]=_0x41e4eb['gateway_payment_id'];else _0x41e4eb['status']==='FAILED'&&(_0x3ab6f6[_0x4814b3(0x14b)]=_0x4814b3(0x10b));_0x3ab6f6['paymentMethod']=_0x4814b3(0x13c),await database_1[_0x4814b3(0x153)][_0x4814b3(0x118)][_0x4814b3(0x117)]({'where':{'id':_0x2e4c78['id']},'data':_0x3ab6f6}),await database_1[_0x4814b3(0x153)]['webhookLog'][_0x4814b3(0x154)]({'data':{'paymentId':_0x2e4c78['id'],'shopId':_0x2e4c78[_0x4814b3(0xef)],'event':_0x4814b3(0x110)+_0x41e4eb['status']?.[_0x4814b3(0x126)](),'statusCode':0xc8,'responseBody':JSON[_0x4814b3(0x15c)]({'oldStatus':_0x4814b3(0x15b),'newStatus':_0x41e4eb[_0x4814b3(0x144)],'gatewayPaymentId':_0x41e4eb[_0x4814b3(0x13d)],'requires3ds':_0x41e4eb[_0x4814b3(0x105)],'processedAt':new Date()[_0x4814b3(0x14d)]()})}});_0x41e4eb['final']&&(await this[_0x4814b3(0x141)](_0x2e4c78,_0x41e4eb[_0x4814b3(0x144)],_0x41e4eb[_0x4814b3(0x13d)]),await this['sendPaymentStatusNotification'](_0x2e4c78,_0x41e4eb[_0x4814b3(0x144)]));console[_0x4814b3(0x15a)](_0x4814b3(0xf7)+_0x45e9ed+_0x4814b3(0x104)+_0x41e4eb[_0x4814b3(0x144)]);if(_0x41e4eb[_0x4814b3(0x144)]==='PAID')_0x3beda5['json']({'success':!![],'message':_0x4814b3(0x123),'result':{'status':_0x4814b3(0x122),'gatewayPaymentId':_0x41e4eb[_0x4814b3(0x13d)],'redirectUrl':_0x4d6f9c,'final':!![]}});else _0x41e4eb['requires_3ds']&&_0x41e4eb[_0x4814b3(0xf2)]?_0x3beda5['json']({'success':!![],'message':_0x4814b3(0x147),'result':{'status':'PENDING','gatewayPaymentId':_0x41e4eb[_0x4814b3(0x13d)],'redirectUrl':_0x41e4eb[_0x4814b3(0xf2)],'requires3ds':!![],'final':![]}}):_0x3beda5[_0x4814b3(0x144)](0x190)[_0x4814b3(0x131)]({'success':![],'message':_0x4814b3(0xec),'result':{'status':'FAILED','gatewayPaymentId':_0x41e4eb[_0x4814b3(0x13d)],'redirectUrl':_0x2e4c78[_0x4814b3(0x149)],'final':!![]}});}catch(_0x176ae0){_0x1d52b8(_0x176ae0);}},this[_0x14769f(0x113)]=new paymentService_1[(_0x14769f(0x127))](),this[_0x14769f(0xf9)]=new mastercardService_1[(_0x14769f(0xf5))](),this['webhookService']=new webhookService_1[(_0x14769f(0x133))]();}async[a8_0x4f1e12(0x141)](_0x201bb4,_0x1a088c,_0x47afa1){const _0x15e2b1=a8_0x4f1e12,_0x10c969=Date[_0x15e2b1(0x15f)]();try{const _0x3b62a3=_0x201bb4[_0x15e2b1(0x108)],_0xfec42f=_0x3b62a3['settings'];if(!_0xfec42f?.[_0x15e2b1(0x152)]){console[_0x15e2b1(0x15a)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x3b62a3['id']);return;}const _0x5d7906=_0x1a088c==='PAID'?_0x15e2b1(0x139):'payment.failed';let _0x509f5b=[];if(_0xfec42f['webhookEvents'])try{_0x509f5b=Array[_0x15e2b1(0x11d)](_0xfec42f[_0x15e2b1(0xf6)])?_0xfec42f[_0x15e2b1(0xf6)]:JSON['parse'](_0xfec42f[_0x15e2b1(0xf6)]);}catch(_0x1b1d64){console[_0x15e2b1(0x116)]('Error\x20parsing\x20webhook\x20events:',_0x1b1d64),_0x509f5b=[];}if(!_0x509f5b[_0x15e2b1(0x138)](_0x5d7906)){console[_0x15e2b1(0x15a)](_0x15e2b1(0xed)+_0x5d7906+_0x15e2b1(0x114)+_0x3b62a3['id']);return;}const _0x4acc51={'event':_0x5d7906,'payment':{'id':_0x201bb4['id'],'order_id':_0x201bb4[_0x15e2b1(0x136)],'gateway_order_id':_0x201bb4[_0x15e2b1(0xfb)],'gateway':_0x15e2b1(0x134),'amount':_0x201bb4['amount'],'currency':_0x201bb4['currency'],'status':_0x1a088c[_0x15e2b1(0x126)](),'customer_email':_0x201bb4[_0x15e2b1(0x148)],'customer_name':_0x201bb4[_0x15e2b1(0x14a)],'gateway_payment_id':_0x47afa1,'created_at':_0x201bb4[_0x15e2b1(0xf4)],'updated_at':new Date()}},_0x1e4e8c=await fetch(_0xfec42f[_0x15e2b1(0x152)],{'method':_0x15e2b1(0x145),'headers':{'Content-Type':_0x15e2b1(0xf8),'User-Agent':_0x15e2b1(0xfa)},'body':JSON['stringify'](_0x4acc51)}),_0x25e6e4=Date[_0x15e2b1(0x15f)]()-_0x10c969;console[_0x15e2b1(0x15a)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0xfec42f[_0x15e2b1(0x152)]+_0x15e2b1(0x10e)+_0x1e4e8c['status']+'\x20('+_0x25e6e4+_0x15e2b1(0xff));}catch(_0x554170){console['error'](_0x15e2b1(0xfd),_0x554170);}}async['sendPaymentStatusNotification'](_0x40c88f,_0x50a507){const _0xeabd98=a8_0x4f1e12;try{const {telegramBotService:_0xa0d7b2}=await Promise[_0xeabd98(0xee)]()[_0xeabd98(0x132)](()=>__importStar(require(_0xeabd98(0x109)))),_0x45c2a2={'PAID':_0xeabd98(0x111),'FAILED':_0xeabd98(0x11c)},_0x5eb476=_0x45c2a2[_0x50a507];if(!_0x5eb476)return;await _0xa0d7b2[_0xeabd98(0x12c)](_0x40c88f[_0xeabd98(0xef)],_0x40c88f,_0x5eb476);}catch(_0x55b568){console[_0xeabd98(0x116)](_0xeabd98(0x124),_0x55b568);}}}exports[a8_0x4f1e12(0x146)]=PaymentController;