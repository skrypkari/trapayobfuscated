'use strict';const a8_0x4f2f6d=a8_0x3c16;(function(_0x57a424,_0x595448){const _0x1fecc1=a8_0x3c16,_0x29bc55=_0x57a424();while(!![]){try{const _0x55fa05=parseInt(_0x1fecc1(0x14a))/0x1+parseInt(_0x1fecc1(0x176))/0x2*(parseInt(_0x1fecc1(0x167))/0x3)+-parseInt(_0x1fecc1(0x149))/0x4*(parseInt(_0x1fecc1(0x160))/0x5)+-parseInt(_0x1fecc1(0x14d))/0x6+-parseInt(_0x1fecc1(0x152))/0x7*(parseInt(_0x1fecc1(0x15a))/0x8)+parseInt(_0x1fecc1(0x19b))/0x9+parseInt(_0x1fecc1(0x150))/0xa;if(_0x55fa05===_0x595448)break;else _0x29bc55['push'](_0x29bc55['shift']());}catch(_0x5a48db){_0x29bc55['push'](_0x29bc55['shift']());}}}(a8_0x54d0,0x9c3f4));var __createBinding=this&&this['__createBinding']||(Object[a8_0x4f2f6d(0x188)]?function(_0x4ddb6f,_0x23b299,_0x521db3,_0x4ec8e4){const _0x2d8904=a8_0x4f2f6d;if(_0x4ec8e4===undefined)_0x4ec8e4=_0x521db3;var _0x3ff795=Object['getOwnPropertyDescriptor'](_0x23b299,_0x521db3);(!_0x3ff795||('get'in _0x3ff795?!_0x23b299['__esModule']:_0x3ff795['writable']||_0x3ff795[_0x2d8904(0x173)]))&&(_0x3ff795={'enumerable':!![],'get':function(){return _0x23b299[_0x521db3];}}),Object[_0x2d8904(0x186)](_0x4ddb6f,_0x4ec8e4,_0x3ff795);}:function(_0x586714,_0x462d72,_0x323370,_0x12af6a){if(_0x12af6a===undefined)_0x12af6a=_0x323370;_0x586714[_0x12af6a]=_0x462d72[_0x323370];}),__setModuleDefault=this&&this[a8_0x4f2f6d(0x155)]||(Object['create']?function(_0x1b8f2a,_0x305998){const _0x541a41=a8_0x4f2f6d;Object[_0x541a41(0x186)](_0x1b8f2a,'default',{'enumerable':!![],'value':_0x305998});}:function(_0x5a666f,_0x23c325){const _0x24e13e=a8_0x4f2f6d;_0x5a666f[_0x24e13e(0x19f)]=_0x23c325;}),__importStar=this&&this[a8_0x4f2f6d(0x162)]||(function(){var _0x590b11=function(_0x162fcc){return _0x590b11=Object['getOwnPropertyNames']||function(_0x34e0ba){const _0x16ec80=a8_0x3c16;var _0x15afc3=[];for(var _0x515c48 in _0x34e0ba)if(Object['prototype'][_0x16ec80(0x17c)][_0x16ec80(0x179)](_0x34e0ba,_0x515c48))_0x15afc3[_0x15afc3[_0x16ec80(0x1a8)]]=_0x515c48;return _0x15afc3;},_0x590b11(_0x162fcc);};return function(_0x2d6607){const _0x320ce1=a8_0x3c16;if(_0x2d6607&&_0x2d6607[_0x320ce1(0x159)])return _0x2d6607;var _0x410a2e={};if(_0x2d6607!=null){for(var _0x38895d=_0x590b11(_0x2d6607),_0x2915c5=0x0;_0x2915c5<_0x38895d[_0x320ce1(0x1a8)];_0x2915c5++)if(_0x38895d[_0x2915c5]!==_0x320ce1(0x19f))__createBinding(_0x410a2e,_0x2d6607,_0x38895d[_0x2915c5]);}return __setModuleDefault(_0x410a2e,_0x2d6607),_0x410a2e;};}()),__importDefault=this&&this['__importDefault']||function(_0x2df3cd){const _0x5b5c7a=a8_0x4f2f6d;return _0x2df3cd&&_0x2df3cd[_0x5b5c7a(0x159)]?_0x2df3cd:{'default':_0x2df3cd};};Object[a8_0x4f2f6d(0x186)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;function a8_0x54d0(){const _0x5068af=['customerName','1910016dDzScs','shop','MasterCardService','Failed\x20to\x20send\x20MasterCard\x20webhook:','default','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','stringify','shopId','sendPaymentNotification','then','PENDING','WebhookService','payment.failed','length','getPaymentById','application/json','webhookEvents','webhookService','json','webhookUrl','../services/webhookService','MasterCard\x20webhook\x20sent\x20to\x20','2284ZFLQGX','719739grhXNk','Error\x20parsing\x20webhook\x20events:','getPaymentStatus','5822988TsKSLY','1111','update','13616070JlAOCa','ðŸ’³\x20MasterCard\x20URLs:','9681RbidwM','\x20\x20\x20Return\x20URL:\x20','gateway_payment_id','__setModuleDefault','paidAt','PAID','threeds_url','__esModule','2104omeoRm','isArray','Payment\x20created\x20successfully','\x20with\x20status\x20','currency','body','9100kABUrD','amount','__importStar','ðŸ’³\x20MasterCard\x20result:','\x20\x20\x20Result\x20URL\x20(webhook):\x20','ms)','paymentService','9sqPFoc','log','createdAt',',\x20cannot\x20process','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','masterCardService','final','status','requires_3ds','Payment\x20status\x20is\x20','params','findUnique','configurable','gatewayPaymentId','toISOString','479910TMGlgj','payment','system','call','Payment\x20not\x20found','POST','hasOwnProperty','processCardPayment','now','âœ…\x20MasterCard\x20payment\x20','../services/paymentService','../services/gateways/mastercardService','PaymentService','toLowerCase','gatewayOrderId','orderId','defineProperty','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','create','settings','\x20processed:\x20','includes','paymentMethod','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/telegramBotService','sendShopWebhook','resolve','../config/database','mastercard_','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','FAILED','error','failed','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','payment.success','Card\x20payment\x20failed'];a8_0x54d0=function(){return _0x5068af;};return a8_0x54d0();}function a8_0x3c16(_0x5350c3,_0x541c08){const _0x54d013=a8_0x54d0();return a8_0x3c16=function(_0x3c164a,_0x4e7851){_0x3c164a=_0x3c164a-0x144;let _0x750e10=_0x54d013[_0x3c164a];return _0x750e10;},a8_0x3c16(_0x5350c3,_0x541c08);}const paymentService_1=require(a8_0x4f2f6d(0x180)),mastercardService_1=require(a8_0x4f2f6d(0x181)),webhookService_1=require(a8_0x4f2f6d(0x147)),database_1=__importDefault(require(a8_0x4f2f6d(0x191)));class PaymentController{constructor(){const _0x23388b=a8_0x4f2f6d;this['createPublicPayment']=async(_0x148dec,_0x14a66d,_0x307c96)=>{const _0x19b2f3=a8_0x3c16;try{const _0x35b589=_0x148dec[_0x19b2f3(0x15f)],_0x4b0366=await this[_0x19b2f3(0x166)]['createPublicPayment'](_0x35b589);_0x14a66d[_0x19b2f3(0x16e)](0xc9)[_0x19b2f3(0x145)]({'success':!![],'message':_0x19b2f3(0x15c),'result':_0x4b0366});}catch(_0x54f141){_0x307c96(_0x54f141);}},this[_0x23388b(0x14c)]=async(_0x33a52b,_0x332c2d,_0x55b005)=>{const _0x21fbda=_0x23388b;try{const {id:_0x2fab73}=_0x33a52b[_0x21fbda(0x171)],_0xa5a8a9=await this[_0x21fbda(0x166)][_0x21fbda(0x14c)](_0x2fab73);if(!_0xa5a8a9)return _0x332c2d[_0x21fbda(0x16e)](0x194)[_0x21fbda(0x145)]({'success':![],'message':_0x21fbda(0x17a)});_0x332c2d['json']({'success':!![],'result':_0xa5a8a9});}catch(_0x2af834){_0x55b005(_0x2af834);}},this[_0x23388b(0x1a9)]=async(_0x4d27c5,_0x1fc195,_0x3e719e)=>{const _0x537337=_0x23388b;try{const {id:_0x4078df}=_0x4d27c5[_0x537337(0x171)],_0x51adaa=await this[_0x537337(0x166)]['getPaymentById'](_0x4078df);if(!_0x51adaa)return _0x1fc195['status'](0x194)[_0x537337(0x145)]({'success':![],'message':_0x537337(0x17a)});_0x1fc195['json']({'success':!![],'result':_0x51adaa});}catch(_0x499c52){_0x3e719e(_0x499c52);}},this['processMasterCardPayment']=async(_0x2b84c1,_0x15a36e,_0x330490)=>{const _0x572428=_0x23388b;try{const {id:_0x140079}=_0x2b84c1[_0x572428(0x171)],{cardData:_0x18554d,cardHolder:_0x13dff5,browser:_0x2c519a}=_0x2b84c1[_0x572428(0x15f)];console[_0x572428(0x168)](_0x572428(0x193)+_0x140079);const _0x151925=await database_1['default'][_0x572428(0x177)][_0x572428(0x172)]({'where':{'id':_0x140079},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x151925)return _0x15a36e[_0x572428(0x16e)](0x194)[_0x572428(0x145)]({'success':![],'message':_0x572428(0x17a)});if(_0x151925['gateway']!=='mastercard')return _0x15a36e['status'](0x190)['json']({'success':![],'message':_0x572428(0x1a0)});if(_0x151925[_0x572428(0x16e)]!==_0x572428(0x1a5))return _0x15a36e[_0x572428(0x16e)](0x190)[_0x572428(0x145)]({'success':![],'message':_0x572428(0x170)+_0x151925[_0x572428(0x16e)]+_0x572428(0x16a)});const _0x593097=_0x572428(0x197),_0x26398f=_0x151925['successUrl'];console['log'](_0x572428(0x151)),console[_0x572428(0x168)](_0x572428(0x164)+_0x593097),console['log'](_0x572428(0x153)+_0x26398f);const _0xbc4a0d=await this[_0x572428(0x16c)][_0x572428(0x17d)]({'paymentId':_0x151925['id'],'orderId':_0x151925[_0x572428(0x184)]||_0x151925['id'],'amount':_0x151925[_0x572428(0x161)],'currency':_0x151925[_0x572428(0x15e)],'cardData':_0x18554d,'resultUrl':_0x593097,'returnUrl':_0x26398f,'cardHolder':_0x13dff5,'browser':_0x2c519a});console['log'](_0x572428(0x163),_0xbc4a0d);const _0x50b044={'status':_0xbc4a0d[_0x572428(0x16e)],'updatedAt':new Date(),'statusChangedBy':_0x572428(0x178),'statusChangedAt':new Date()};if(_0xbc4a0d['status']===_0x572428(0x157))_0x50b044[_0x572428(0x156)]=new Date(),_0x50b044[_0x572428(0x174)]=_0xbc4a0d[_0x572428(0x154)];else _0xbc4a0d[_0x572428(0x16e)]===_0x572428(0x194)&&(_0x50b044['failureMessage']=_0x572428(0x199));_0x50b044[_0x572428(0x18c)]='mastercard',await database_1[_0x572428(0x19f)][_0x572428(0x177)][_0x572428(0x14f)]({'where':{'id':_0x151925['id']},'data':_0x50b044}),await database_1[_0x572428(0x19f)]['webhookLog']['create']({'data':{'paymentId':_0x151925['id'],'shopId':_0x151925['shopId'],'event':_0x572428(0x192)+_0xbc4a0d[_0x572428(0x16e)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x572428(0x1a1)]({'oldStatus':_0x572428(0x1a5),'newStatus':_0xbc4a0d[_0x572428(0x16e)],'gatewayPaymentId':_0xbc4a0d['gateway_payment_id'],'requires3ds':_0xbc4a0d[_0x572428(0x16f)],'processedAt':new Date()[_0x572428(0x175)]()})}});_0xbc4a0d[_0x572428(0x16d)]&&(await this['sendShopWebhook'](_0x151925,_0xbc4a0d[_0x572428(0x16e)],_0xbc4a0d[_0x572428(0x154)]),await this['sendPaymentStatusNotification'](_0x151925,_0xbc4a0d[_0x572428(0x16e)]));console[_0x572428(0x168)](_0x572428(0x17f)+_0x140079+_0x572428(0x18a)+_0xbc4a0d[_0x572428(0x16e)]);if(_0xbc4a0d[_0x572428(0x16e)]===_0x572428(0x157))_0x15a36e[_0x572428(0x145)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','gatewayPaymentId':_0xbc4a0d[_0x572428(0x154)],'redirectUrl':_0x26398f,'final':!![]}});else _0xbc4a0d['requires_3ds']&&_0xbc4a0d[_0x572428(0x158)]?_0x15a36e[_0x572428(0x145)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x572428(0x1a5),'gatewayPaymentId':_0xbc4a0d['gateway_payment_id'],'redirectUrl':_0xbc4a0d[_0x572428(0x158)],'requires3ds':!![],'final':![]}}):_0x15a36e[_0x572428(0x16e)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0xbc4a0d['gateway_payment_id'],'redirectUrl':_0x151925['failUrl'],'final':!![]}});}catch(_0x409b05){_0x330490(_0x409b05);}},this[_0x23388b(0x166)]=new paymentService_1[(_0x23388b(0x182))](),this['masterCardService']=new mastercardService_1[(_0x23388b(0x19d))](),this[_0x23388b(0x144)]=new webhookService_1[(_0x23388b(0x1a6))]();}async[a8_0x4f2f6d(0x18f)](_0x58f11b,_0x355fda,_0xe981cb){const _0x499193=a8_0x4f2f6d,_0x3021a8=Date[_0x499193(0x17e)]();try{const _0x2cf4c7=_0x58f11b[_0x499193(0x19c)],_0x1de894=_0x2cf4c7[_0x499193(0x189)];if(!_0x1de894?.[_0x499193(0x146)]){console[_0x499193(0x168)](_0x499193(0x16b)+_0x2cf4c7['id']);return;}const _0x250b5b=_0x355fda===_0x499193(0x157)?_0x499193(0x198):_0x499193(0x1a7);let _0x6e2a3=[];if(_0x1de894[_0x499193(0x1ab)])try{_0x6e2a3=Array[_0x499193(0x15b)](_0x1de894[_0x499193(0x1ab)])?_0x1de894[_0x499193(0x1ab)]:JSON['parse'](_0x1de894[_0x499193(0x1ab)]);}catch(_0x557240){console['error'](_0x499193(0x14b),_0x557240),_0x6e2a3=[];}if(!_0x6e2a3[_0x499193(0x18b)](_0x250b5b)){console[_0x499193(0x168)]('Webhook\x20event\x20'+_0x250b5b+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2cf4c7['id']);return;}const _0x15458c={'event':_0x250b5b,'payment':{'id':_0x58f11b['id'],'order_id':_0x58f11b[_0x499193(0x185)],'gateway_order_id':_0x58f11b['gatewayOrderId'],'gateway':_0x499193(0x14e),'amount':_0x58f11b['amount'],'currency':_0x58f11b[_0x499193(0x15e)],'status':_0x355fda[_0x499193(0x183)](),'customer_email':_0x58f11b['customerEmail'],'customer_name':_0x58f11b[_0x499193(0x19a)],'gateway_payment_id':_0xe981cb,'created_at':_0x58f11b[_0x499193(0x169)],'updated_at':new Date()}},_0x4e9ea7=await fetch(_0x1de894['webhookUrl'],{'method':_0x499193(0x17b),'headers':{'Content-Type':_0x499193(0x1aa),'User-Agent':_0x499193(0x187)},'body':JSON['stringify'](_0x15458c)}),_0x19489d=Date[_0x499193(0x17e)]()-_0x3021a8;console[_0x499193(0x168)](_0x499193(0x148)+_0x1de894[_0x499193(0x146)]+_0x499193(0x15d)+_0x4e9ea7[_0x499193(0x16e)]+'\x20('+_0x19489d+_0x499193(0x165));}catch(_0xaed6e2){console[_0x499193(0x195)](_0x499193(0x19e),_0xaed6e2);}}async['sendPaymentStatusNotification'](_0x3860d3,_0x1e721c){const _0xdace31=a8_0x4f2f6d;try{const {telegramBotService:_0xe27765}=await Promise[_0xdace31(0x190)]()[_0xdace31(0x1a4)](()=>__importStar(require(_0xdace31(0x18e)))),_0x1d5e11={'PAID':'paid','FAILED':_0xdace31(0x196)},_0x54e66e=_0x1d5e11[_0x1e721c];if(!_0x54e66e)return;await _0xe27765[_0xdace31(0x1a3)](_0x3860d3[_0xdace31(0x1a2)],_0x3860d3,_0x54e66e);}catch(_0x165b44){console[_0xdace31(0x195)](_0xdace31(0x18d),_0x165b44);}}}exports['PaymentController']=PaymentController;