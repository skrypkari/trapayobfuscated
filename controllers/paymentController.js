'use strict';function a8_0x4019(){const _0x3c5327=['mastercard','846972YgEOBW','Payment\x20status\x20is\x20','shopId','paymentMethod','paidAt','https://api.trapay.uk/api/webhooks/gateway/mastercard','110wuVgyb','üí≥\x20Card\x20holder:\x20','amount','Payment\x20created\x20successfully','11LEYAFV','createPublicPayment','\x20not\x20enabled\x20for\x20shop\x20','__importDefault','üí≥\x20MasterCard\x20URLs:','üí≥\x20MasterCard\x20result:','getOwnPropertyDescriptor','webhookService','isArray','customerEmail','../services/webhookService','requires_3ds','getPaymentStatus','includes','\x20processed:\x20','number','24gkEdJy','paymentService','getPaymentById','prototype','stringify','orderId','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','MasterCardService','length','currency','customerName','cardLast4',',\x20cannot\x20process','gatewayPaymentId','failureMessage','first_name','Payment\x20not\x20found','final','failed','Payment\x20processed\x20successfully','3DS\x20verification\x20required','sendPaymentStatusNotification','user_agent','resolve','Webhook\x20event\x20','webhookEvents','PaymentController','Customer\x20data\x20updated\x20successfully','gatewayOrderId','payment.failed','customerUa','error','Failed\x20to\x20send\x20MasterCard\x20webhook:','create','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','../services/paymentService','\x20\x20\x20Result\x20URL\x20(webhook):\x20','58021nwzvNN','failUrl','üí≥\x20Processing\x20MasterCard\x20payment:\x20','payment','üìù\x20Customer\x20data:','call','settings','email','json','32ntfyss','PAID','findUnique','PaymentService','status','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','application/json','hasOwnProperty','successUrl','7254230DIrkUp','paid','now','updatePaymentCustomer','get','gateway_payment_id','defineProperty','handleSuccessfulPayment','update','__esModule','configurable','default','log','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','then','133512kaXzoM','replace','../config/database','1374526nkSkgr','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','createdAt','body','1043336mohiZk','sendShopWebhook','customerCountry','‚úÖ\x20MasterCard\x20payment\x20','gateway','toLowerCase','params','payment.success','masterCardService','threeds_url','last_name','PENDING','updatedAt','parse','sendPaymentNotification','144783CPptnf','webhookUrl','ms)','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','FAILED','\x20\x20\x20Return\x20URL:\x20','__importStar','MasterCard\x20webhook\x20sent\x20to\x20','../services/paymentLinkService','__createBinding','updatePaymentCustomerDataPublic'];a8_0x4019=function(){return _0x3c5327;};return a8_0x4019();}const a8_0x2d0ccc=a8_0x2333;(function(_0x175e16,_0x5088df){const _0x1cc37a=a8_0x2333,_0x32e44c=_0x175e16();while(!![]){try{const _0x5b11af=parseInt(_0x1cc37a(0x1a9))/0x1+-parseInt(_0x1cc37a(0x1cd))/0x2+-parseInt(_0x1cc37a(0x1e0))/0x3*(-parseInt(_0x1cc37a(0x184))/0x4)+-parseInt(_0x1cc37a(0x1f2))/0x5*(parseInt(_0x1cc37a(0x1ca))/0x6)+parseInt(_0x1cc37a(0x1d1))/0x7*(parseInt(_0x1cc37a(0x1b2))/0x8)+-parseInt(_0x1cc37a(0x1ec))/0x9+parseInt(_0x1cc37a(0x1bb))/0xa*(parseInt(_0x1cc37a(0x1f6))/0xb);if(_0x5b11af===_0x5088df)break;else _0x32e44c['push'](_0x32e44c['shift']());}catch(_0x4635cd){_0x32e44c['push'](_0x32e44c['shift']());}}}(a8_0x4019,0x613cf));var __createBinding=this&&this[a8_0x2d0ccc(0x1e9)]||(Object[a8_0x2d0ccc(0x1a5)]?function(_0x2f03b7,_0x3fad19,_0x2de49d,_0x3c9755){const _0x30e998=a8_0x2d0ccc;if(_0x3c9755===undefined)_0x3c9755=_0x2de49d;var _0x2d3378=Object[_0x30e998(0x1fc)](_0x3fad19,_0x2de49d);(!_0x2d3378||(_0x30e998(0x1bf)in _0x2d3378?!_0x3fad19[_0x30e998(0x1c4)]:_0x2d3378['writable']||_0x2d3378[_0x30e998(0x1c5)]))&&(_0x2d3378={'enumerable':!![],'get':function(){return _0x3fad19[_0x2de49d];}}),Object[_0x30e998(0x1c1)](_0x2f03b7,_0x3c9755,_0x2d3378);}:function(_0x53ef50,_0x38846f,_0x288f1a,_0x15a7e2){if(_0x15a7e2===undefined)_0x15a7e2=_0x288f1a;_0x53ef50[_0x15a7e2]=_0x38846f[_0x288f1a];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x2d0ccc(0x1a5)]?function(_0x5dc642,_0x5d9c62){const _0x21ff12=a8_0x2d0ccc;Object[_0x21ff12(0x1c1)](_0x5dc642,_0x21ff12(0x1c6),{'enumerable':!![],'value':_0x5d9c62});}:function(_0x114739,_0x56db1e){const _0x1c8d3a=a8_0x2d0ccc;_0x114739[_0x1c8d3a(0x1c6)]=_0x56db1e;}),__importStar=this&&this[a8_0x2d0ccc(0x1e6)]||(function(){var _0x51bca9=function(_0x3ceca0){return _0x51bca9=Object['getOwnPropertyNames']||function(_0x2e2e37){const _0x5f228a=a8_0x2333;var _0x117575=[];for(var _0x387ab7 in _0x2e2e37)if(Object[_0x5f228a(0x187)][_0x5f228a(0x1b9)][_0x5f228a(0x1ae)](_0x2e2e37,_0x387ab7))_0x117575[_0x117575['length']]=_0x387ab7;return _0x117575;},_0x51bca9(_0x3ceca0);};return function(_0x1c7699){const _0x2951e6=a8_0x2333;if(_0x1c7699&&_0x1c7699[_0x2951e6(0x1c4)])return _0x1c7699;var _0x15d71a={};if(_0x1c7699!=null){for(var _0x386791=_0x51bca9(_0x1c7699),_0x453754=0x0;_0x453754<_0x386791[_0x2951e6(0x18c)];_0x453754++)if(_0x386791[_0x453754]!==_0x2951e6(0x1c6))__createBinding(_0x15d71a,_0x1c7699,_0x386791[_0x453754]);}return __setModuleDefault(_0x15d71a,_0x1c7699),_0x15d71a;};}()),__importDefault=this&&this[a8_0x2d0ccc(0x1f9)]||function(_0x4842df){const _0x1c85a3=a8_0x2d0ccc;return _0x4842df&&_0x4842df[_0x1c85a3(0x1c4)]?_0x4842df:{'default':_0x4842df};};Object['defineProperty'](exports,a8_0x2d0ccc(0x1c4),{'value':!![]}),exports[a8_0x2d0ccc(0x19e)]=void 0x0;const paymentService_1=require(a8_0x2d0ccc(0x1a7)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x2d0ccc(0x200)),database_1=__importDefault(require(a8_0x2d0ccc(0x1cc)));class PaymentController{constructor(){const _0xbe4356=a8_0x2d0ccc;this['createPublicPayment']=async(_0x41a0df,_0x2003fb,_0x13cbd1)=>{const _0x27b9d3=a8_0x2333;try{const _0x296daa=_0x41a0df[_0x27b9d3(0x1d0)],_0x4bd28e=await this[_0x27b9d3(0x185)][_0x27b9d3(0x1f7)](_0x296daa);_0x2003fb[_0x27b9d3(0x1b6)](0xc9)[_0x27b9d3(0x1b1)]({'success':!![],'message':_0x27b9d3(0x1f5),'result':_0x4bd28e});}catch(_0x1ba2ec){_0x13cbd1(_0x1ba2ec);}},this[_0xbe4356(0x180)]=async(_0xcdbe43,_0x41d162,_0x4b455d)=>{const _0x5945f2=_0xbe4356;try{const {id:_0x2ad23f}=_0xcdbe43[_0x5945f2(0x1d7)],_0x287d61=await this['paymentService'][_0x5945f2(0x180)](_0x2ad23f);if(!_0x287d61)return _0x41d162[_0x5945f2(0x1b6)](0x194)['json']({'success':![],'message':_0x5945f2(0x194)});_0x41d162['json']({'success':!![],'result':_0x287d61});}catch(_0x2e3025){_0x4b455d(_0x2e3025);}},this[_0xbe4356(0x186)]=async(_0x4b2607,_0x200694,_0x55e688)=>{const _0x558cb5=_0xbe4356;try{const {id:_0x1964ef}=_0x4b2607[_0x558cb5(0x1d7)],_0x1e8401=await this['paymentService']['getPaymentById'](_0x1964ef);if(!_0x1e8401)return _0x200694[_0x558cb5(0x1b6)](0x194)[_0x558cb5(0x1b1)]({'success':![],'message':'Payment\x20not\x20found'});_0x200694[_0x558cb5(0x1b1)]({'success':!![],'result':_0x1e8401});}catch(_0x111f96){_0x55e688(_0x111f96);}},this[_0xbe4356(0x1be)]=async(_0x2a230a,_0x20455b,_0x483688)=>{const _0x369dcb=_0xbe4356;try{const {id:_0x39429f}=_0x2a230a[_0x369dcb(0x1d7)],_0xd1f055=_0x2a230a[_0x369dcb(0x1d0)];console[_0x369dcb(0x1c7)](_0x369dcb(0x1e3)+_0x39429f),console['log'](_0x369dcb(0x1ad),_0xd1f055);const _0x145626=await this['paymentService'][_0x369dcb(0x1ea)](_0x39429f,_0xd1f055);if(!_0x145626)return _0x20455b[_0x369dcb(0x1b6)](0x194)[_0x369dcb(0x1b1)]({'success':![],'message':_0x369dcb(0x194)});_0x20455b['json']({'success':!![],'message':_0x369dcb(0x19f),'result':{'paymentId':_0x145626['id'],'customerIp':_0x145626['customerIp'],'customerUa':_0x145626[_0x369dcb(0x1a2)],'customerCountry':_0x145626[_0x369dcb(0x1d3)],'updatedAt':_0x145626[_0x369dcb(0x1dd)]}});}catch(_0xa55b5a){_0x483688(_0xa55b5a);}},this['processMasterCardPayment']=async(_0x503e37,_0x195fc9,_0x1730ad)=>{const _0x48e497=_0xbe4356;try{const {id:_0x585057}=_0x503e37[_0x48e497(0x1d7)],{cardData:_0x7766c7,cardHolder:_0x5e3d3f,browser:_0x46a8ff}=_0x503e37[_0x48e497(0x1d0)];console[_0x48e497(0x1c7)](_0x48e497(0x1ab)+_0x585057),console[_0x48e497(0x1c7)](_0x48e497(0x1f3)+_0x5e3d3f[_0x48e497(0x193)]+'\x20'+_0x5e3d3f[_0x48e497(0x1db)]+'\x20('+_0x5e3d3f[_0x48e497(0x1b0)]+')'),console[_0x48e497(0x1c7)]('üí≥\x20Browser\x20IP:\x20'+_0x46a8ff['ip']);const _0x1abcd4={'customerName':_0x5e3d3f[_0x48e497(0x193)]+'\x20'+_0x5e3d3f[_0x48e497(0x1db)],'customerEmail':_0x5e3d3f[_0x48e497(0x1b0)],'customerIp':_0x46a8ff['ip'],'customerUa':_0x46a8ff[_0x48e497(0x19a)]},_0x3917f7=await database_1['default'][_0x48e497(0x1ac)][_0x48e497(0x1b4)]({'where':{'id':_0x585057},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3917f7)return _0x195fc9[_0x48e497(0x1b6)](0x194)[_0x48e497(0x1b1)]({'success':![],'message':_0x48e497(0x194)});if(_0x3917f7[_0x48e497(0x1d5)]!==_0x48e497(0x1eb))return _0x195fc9[_0x48e497(0x1b6)](0x190)[_0x48e497(0x1b1)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x3917f7[_0x48e497(0x1b6)]!==_0x48e497(0x1dc))return _0x195fc9['status'](0x190)['json']({'success':![],'message':_0x48e497(0x1ed)+_0x3917f7['status']+_0x48e497(0x190)});await database_1['default'][_0x48e497(0x1ac)][_0x48e497(0x1c3)]({'where':{'id':_0x585057},'data':{..._0x1abcd4,'updatedAt':new Date()}});const _0x430c0f=_0x48e497(0x1f1),_0x55a810=_0x3917f7[_0x48e497(0x1ba)];console[_0x48e497(0x1c7)](_0x48e497(0x1fa)),console[_0x48e497(0x1c7)](_0x48e497(0x1a8)+_0x430c0f),console[_0x48e497(0x1c7)](_0x48e497(0x1e5)+_0x55a810);const _0x302138={'first_name':_0x5e3d3f[_0x48e497(0x193)],'last_name':_0x5e3d3f[_0x48e497(0x1db)],'email':_0x5e3d3f[_0x48e497(0x1b0)]},_0x4c8df6=await this[_0x48e497(0x1d9)]['processCardPayment']({'paymentId':_0x3917f7['id'],'orderId':_0x3917f7[_0x48e497(0x1a0)]||_0x3917f7['id'],'amount':_0x3917f7[_0x48e497(0x1f4)],'currency':_0x3917f7[_0x48e497(0x18d)],'cardData':_0x7766c7,'resultUrl':_0x430c0f,'returnUrl':_0x55a810,'cardHolder':_0x302138,'browser':_0x46a8ff});console[_0x48e497(0x1c7)](_0x48e497(0x1fb),_0x4c8df6);const _0x28111f={'status':_0x4c8df6[_0x48e497(0x1b6)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x4c8df6['gateway_payment_id']&&(_0x28111f[_0x48e497(0x191)]=_0x4c8df6[_0x48e497(0x1c0)],console[_0x48e497(0x1c7)]('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x4c8df6['gateway_payment_id']));if(_0x4c8df6['status']===_0x48e497(0x1b3))_0x28111f[_0x48e497(0x1f0)]=new Date();else _0x4c8df6[_0x48e497(0x1b6)]===_0x48e497(0x1e4)&&(_0x28111f[_0x48e497(0x192)]='Card\x20payment\x20failed');_0x28111f[_0x48e497(0x1ef)]='mastercard';if(_0x7766c7['number']){const _0x54abbb=_0x7766c7[_0x48e497(0x183)][_0x48e497(0x1cb)](/[\s-]/g,'');_0x28111f[_0x48e497(0x18f)]=_0x54abbb['slice'](-0x4),console[_0x48e497(0x1c7)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x28111f[_0x48e497(0x18f)]);}await database_1[_0x48e497(0x1c6)][_0x48e497(0x1ac)][_0x48e497(0x1c3)]({'where':{'id':_0x3917f7['id']},'data':_0x28111f}),await database_1[_0x48e497(0x1c6)]['webhookLog'][_0x48e497(0x1a5)]({'data':{'paymentId':_0x3917f7['id'],'shopId':_0x3917f7[_0x48e497(0x1ee)],'event':'mastercard_'+_0x4c8df6[_0x48e497(0x1b6)]?.[_0x48e497(0x1d6)](),'statusCode':0xc8,'responseBody':JSON[_0x48e497(0x188)]({'oldStatus':_0x48e497(0x1dc),'newStatus':_0x4c8df6[_0x48e497(0x1b6)],'gatewayPaymentId':_0x4c8df6[_0x48e497(0x1c0)],'requires3ds':_0x4c8df6[_0x48e497(0x201)],'processedAt':new Date()['toISOString']()})}});if(_0x4c8df6[_0x48e497(0x195)]){await this[_0x48e497(0x1d2)](_0x3917f7,_0x4c8df6[_0x48e497(0x1b6)],_0x4c8df6[_0x48e497(0x1c0)]),await this[_0x48e497(0x199)](_0x3917f7,_0x4c8df6[_0x48e497(0x1b6)]);if(_0x4c8df6[_0x48e497(0x1b6)]==='PAID'){console[_0x48e497(0x1c7)]('üìà\x20MasterCard\x20payment\x20'+_0x585057+_0x48e497(0x1c8));try{const {PaymentLinkService:_0x2d10ce}=await Promise['resolve']()['then'](()=>__importStar(require(_0x48e497(0x1e8)))),_0x1aff14=new _0x2d10ce();await _0x1aff14[_0x48e497(0x1c2)](_0x585057),console[_0x48e497(0x1c7)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x585057);}catch(_0x54d025){console[_0x48e497(0x1a3)](_0x48e497(0x1ce),_0x54d025);}}}console['log'](_0x48e497(0x1d4)+_0x585057+_0x48e497(0x182)+_0x4c8df6[_0x48e497(0x1b6)]);if(_0x4c8df6[_0x48e497(0x1b6)]===_0x48e497(0x1b3))_0x195fc9[_0x48e497(0x1b1)]({'success':!![],'message':_0x48e497(0x197),'result':{'status':'PAID','gatewayPaymentId':_0x4c8df6['gateway_payment_id'],'redirectUrl':_0x55a810,'final':!![]}});else _0x4c8df6[_0x48e497(0x201)]&&_0x4c8df6[_0x48e497(0x1da)]?_0x195fc9[_0x48e497(0x1b1)]({'success':!![],'message':_0x48e497(0x198),'result':{'status':'PENDING','gatewayPaymentId':_0x4c8df6['gateway_payment_id'],'redirectUrl':_0x4c8df6[_0x48e497(0x1da)],'requires3ds':!![],'final':![]}}):_0x195fc9[_0x48e497(0x1b6)](0x190)[_0x48e497(0x1b1)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x48e497(0x1e4),'gatewayPaymentId':_0x4c8df6['gateway_payment_id'],'redirectUrl':_0x3917f7[_0x48e497(0x1aa)],'final':!![]}});}catch(_0x40b403){_0x1730ad(_0x40b403);}},this[_0xbe4356(0x185)]=new paymentService_1[(_0xbe4356(0x1b5))](),this[_0xbe4356(0x1d9)]=new mastercardService_1[(_0xbe4356(0x18b))](),this[_0xbe4356(0x1fd)]=new webhookService_1['WebhookService']();}async[a8_0x2d0ccc(0x1d2)](_0x2aab9d,_0x1811ea,_0x5d244e){const _0x455bed=a8_0x2d0ccc,_0x36d6a7=Date[_0x455bed(0x1bd)]();try{const _0x31130f=_0x2aab9d['shop'],_0x32b9bc=_0x31130f[_0x455bed(0x1af)];if(!_0x32b9bc?.[_0x455bed(0x1e1)]){console[_0x455bed(0x1c7)](_0x455bed(0x1b7)+_0x31130f['id']);return;}const _0x3d6115=_0x1811ea===_0x455bed(0x1b3)?_0x455bed(0x1d8):_0x455bed(0x1a1);let _0x36a606=[];if(_0x32b9bc[_0x455bed(0x19d)])try{_0x36a606=Array[_0x455bed(0x1fe)](_0x32b9bc[_0x455bed(0x19d)])?_0x32b9bc[_0x455bed(0x19d)]:JSON[_0x455bed(0x1de)](_0x32b9bc[_0x455bed(0x19d)]);}catch(_0x2c835c){console[_0x455bed(0x1a3)]('Error\x20parsing\x20webhook\x20events:',_0x2c835c),_0x36a606=[];}if(!_0x36a606[_0x455bed(0x181)](_0x3d6115)){console[_0x455bed(0x1c7)](_0x455bed(0x19c)+_0x3d6115+_0x455bed(0x1f8)+_0x31130f['id']);return;}const _0x5b0c3f={'event':_0x3d6115,'payment':{'id':_0x2aab9d['id'],'order_id':_0x2aab9d[_0x455bed(0x189)],'gateway_order_id':_0x2aab9d[_0x455bed(0x1a0)],'gateway':'1111','amount':_0x2aab9d['amount'],'currency':_0x2aab9d['currency'],'status':_0x1811ea[_0x455bed(0x1d6)](),'customer_email':_0x2aab9d[_0x455bed(0x1ff)],'customer_name':_0x2aab9d[_0x455bed(0x18e)],'gateway_payment_id':_0x5d244e,'created_at':_0x2aab9d[_0x455bed(0x1cf)],'updated_at':new Date()}},_0x795cf7=await fetch(_0x32b9bc[_0x455bed(0x1e1)],{'method':'POST','headers':{'Content-Type':_0x455bed(0x1b8),'User-Agent':_0x455bed(0x18a)},'body':JSON[_0x455bed(0x188)](_0x5b0c3f)}),_0x1b7194=Date['now']()-_0x36d6a7;console[_0x455bed(0x1c7)](_0x455bed(0x1e7)+_0x32b9bc[_0x455bed(0x1e1)]+'\x20with\x20status\x20'+_0x795cf7[_0x455bed(0x1b6)]+'\x20('+_0x1b7194+_0x455bed(0x1e2));}catch(_0x387d78){console[_0x455bed(0x1a3)](_0x455bed(0x1a4),_0x387d78);}}async[a8_0x2d0ccc(0x199)](_0xc6ebff,_0x597c43){const _0x31289a=a8_0x2d0ccc;try{const {telegramBotService:_0x167373}=await Promise[_0x31289a(0x19b)]()[_0x31289a(0x1c9)](()=>__importStar(require('../services/telegramBotService'))),_0x5081d7={'PAID':_0x31289a(0x1bc),'FAILED':_0x31289a(0x196)},_0x226fc1=_0x5081d7[_0x597c43];if(!_0x226fc1)return;await _0x167373[_0x31289a(0x1df)](_0xc6ebff[_0x31289a(0x1ee)],_0xc6ebff,_0x226fc1);}catch(_0x31ea80){console[_0x31289a(0x1a3)](_0x31289a(0x1a6),_0x31ea80);}}}function a8_0x2333(_0x592a9e,_0x16abc1){const _0x4019a2=a8_0x4019();return a8_0x2333=function(_0x2333bd,_0x208bf4){_0x2333bd=_0x2333bd-0x180;let _0x1608b4=_0x4019a2[_0x2333bd];return _0x1608b4;},a8_0x2333(_0x592a9e,_0x16abc1);}exports['PaymentController']=PaymentController;