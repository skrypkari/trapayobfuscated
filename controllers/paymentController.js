'use strict';const a8_0x2966f1=a8_0x199b;(function(_0x274f6f,_0x2e516c){const _0x2732f1=a8_0x199b,_0x17e01f=_0x274f6f();while(!![]){try{const _0x76a547=parseInt(_0x2732f1(0xde))/0x1+-parseInt(_0x2732f1(0xe6))/0x2+parseInt(_0x2732f1(0x12e))/0x3*(-parseInt(_0x2732f1(0x138))/0x4)+-parseInt(_0x2732f1(0xd8))/0x5+-parseInt(_0x2732f1(0x13a))/0x6+parseInt(_0x2732f1(0x117))/0x7*(parseInt(_0x2732f1(0x103))/0x8)+parseInt(_0x2732f1(0x13d))/0x9*(parseInt(_0x2732f1(0xe0))/0xa);if(_0x76a547===_0x2e516c)break;else _0x17e01f['push'](_0x17e01f['shift']());}catch(_0x1700e0){_0x17e01f['push'](_0x17e01f['shift']());}}}(a8_0x54b4,0xf0723));function a8_0x54b4(){const _0x2bc1b0=['PAID','45TPEUFD','getOwnPropertyNames','params','prototype','status','PENDING','2736475ZaISWU','getOwnPropertyDescriptor','toLowerCase','webhookLog','WebhookService','application/json','268861zZWdPf','failureMessage','7510270oHacKQ','mastercard','paidAt','masterCardService','body','customerEmail','1056722XFimNZ','Failed\x20to\x20send\x20MasterCard\x20webhook:','paymentService','../services/paymentService','createPublicPayment','createdAt','includes','payment','successUrl','../services/telegramBotService','Payment\x20created\x20successfully','../services/webhookService','system','isArray','Payment\x20status\x20is\x20','create','1111','sendShopWebhook','POST','threeds_url','__importDefault','failed','getPaymentById','ðŸ’³\x20MasterCard\x20URLs:','webhookEvents','MasterCard\x20webhook\x20sent\x20to\x20','sendPaymentStatusNotification','ðŸ’³\x20MasterCard\x20result:','\x20processed:\x20','1428320eOTPZK','default','gatewayOrderId','json',',\x20cannot\x20process','webhookUrl','resolve','update','payment.failed','PaymentService','shop','customerName','PaymentController','MasterCardService','orderId','__createBinding','toISOString','__importStar','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','findUnique','49pDtERF','__esModule','Payment\x20not\x20found','https://api.trapay.uk/api/webhooks/gateway/mastercard','gatewayPaymentId','getPaymentStatus','__setModuleDefault','then','log','gateway','paid','stringify','gateway_payment_id','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','FAILED','settings','processMasterCardPayment','Card\x20payment\x20failed','final','call','amount','mastercard_','error','5038386GqRnMa','paymentMethod','length','parse','defineProperty','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Payment\x20processed\x20successfully','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','requires_3ds','ms)','4pOAMFk','currency','9202746VcHgUN','configurable'];a8_0x54b4=function(){return _0x2bc1b0;};return a8_0x54b4();}var __createBinding=this&&this[a8_0x2966f1(0x112)]||(Object['create']?function(_0x252d4f,_0x56a8de,_0x1289fa,_0x169e1f){const _0x528b14=a8_0x2966f1;if(_0x169e1f===undefined)_0x169e1f=_0x1289fa;var _0x5e77d3=Object[_0x528b14(0xd9)](_0x56a8de,_0x1289fa);(!_0x5e77d3||('get'in _0x5e77d3?!_0x56a8de[_0x528b14(0x118)]:_0x5e77d3['writable']||_0x5e77d3[_0x528b14(0x13b)]))&&(_0x5e77d3={'enumerable':!![],'get':function(){return _0x56a8de[_0x1289fa];}}),Object[_0x528b14(0x132)](_0x252d4f,_0x169e1f,_0x5e77d3);}:function(_0x237f19,_0x44e6ec,_0x1187f3,_0x487d38){if(_0x487d38===undefined)_0x487d38=_0x1187f3;_0x237f19[_0x487d38]=_0x44e6ec[_0x1187f3];}),__setModuleDefault=this&&this[a8_0x2966f1(0x11d)]||(Object[a8_0x2966f1(0xf5)]?function(_0x2c2284,_0x430e08){const _0x31abfd=a8_0x2966f1;Object[_0x31abfd(0x132)](_0x2c2284,_0x31abfd(0x104),{'enumerable':!![],'value':_0x430e08});}:function(_0x39cb5e,_0x4f0454){const _0x5387ba=a8_0x2966f1;_0x39cb5e[_0x5387ba(0x104)]=_0x4f0454;}),__importStar=this&&this[a8_0x2966f1(0x114)]||(function(){var _0x463c99=function(_0x28705b){const _0x87d8b4=a8_0x199b;return _0x463c99=Object[_0x87d8b4(0x13e)]||function(_0x272ef6){const _0x81cdde=_0x87d8b4;var _0x6bc2a0=[];for(var _0x27e876 in _0x272ef6)if(Object[_0x81cdde(0xd5)]['hasOwnProperty'][_0x81cdde(0x12a)](_0x272ef6,_0x27e876))_0x6bc2a0[_0x6bc2a0[_0x81cdde(0x130)]]=_0x27e876;return _0x6bc2a0;},_0x463c99(_0x28705b);};return function(_0x340d0f){const _0x3b007c=a8_0x199b;if(_0x340d0f&&_0x340d0f['__esModule'])return _0x340d0f;var _0xce1b67={};if(_0x340d0f!=null){for(var _0x961a9b=_0x463c99(_0x340d0f),_0x1af352=0x0;_0x1af352<_0x961a9b['length'];_0x1af352++)if(_0x961a9b[_0x1af352]!==_0x3b007c(0x104))__createBinding(_0xce1b67,_0x340d0f,_0x961a9b[_0x1af352]);}return __setModuleDefault(_0xce1b67,_0x340d0f),_0xce1b67;};}()),__importDefault=this&&this[a8_0x2966f1(0xfa)]||function(_0x449e14){return _0x449e14&&_0x449e14['__esModule']?_0x449e14:{'default':_0x449e14};};Object[a8_0x2966f1(0x132)](exports,'__esModule',{'value':!![]}),exports[a8_0x2966f1(0x10f)]=void 0x0;const paymentService_1=require(a8_0x2966f1(0xe9)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x2966f1(0xf1)),database_1=__importDefault(require('../config/database'));function a8_0x199b(_0x43f7f7,_0x582636){const _0x54b461=a8_0x54b4();return a8_0x199b=function(_0x199b06,_0x216fa2){_0x199b06=_0x199b06-0xd4;let _0x17d4d7=_0x54b461[_0x199b06];return _0x17d4d7;},a8_0x199b(_0x43f7f7,_0x582636);}class PaymentController{constructor(){const _0x1cd635=a8_0x2966f1;this[_0x1cd635(0xea)]=async(_0xa6b64c,_0x195641,_0x314eb7)=>{const _0x57da7e=_0x1cd635;try{const _0x209eab=_0xa6b64c[_0x57da7e(0xe4)],_0x1430a4=await this['paymentService'][_0x57da7e(0xea)](_0x209eab);_0x195641['status'](0xc9)[_0x57da7e(0x106)]({'success':!![],'message':_0x57da7e(0xf0),'result':_0x1430a4});}catch(_0x5da188){_0x314eb7(_0x5da188);}},this[_0x1cd635(0x11c)]=async(_0x1689ad,_0x54ca04,_0x2bbc00)=>{const _0x3f326e=_0x1cd635;try{const {id:_0x45ca14}=_0x1689ad[_0x3f326e(0xd4)],_0x54ea16=await this[_0x3f326e(0xe8)][_0x3f326e(0x11c)](_0x45ca14);if(!_0x54ea16)return _0x54ca04['status'](0x194)[_0x3f326e(0x106)]({'success':![],'message':_0x3f326e(0x119)});_0x54ca04[_0x3f326e(0x106)]({'success':!![],'result':_0x54ea16});}catch(_0x37f450){_0x2bbc00(_0x37f450);}},this['getPaymentById']=async(_0x50b02c,_0x2b4cfd,_0x5be484)=>{const _0x321dbb=_0x1cd635;try{const {id:_0x110358}=_0x50b02c['params'],_0x508c37=await this[_0x321dbb(0xe8)][_0x321dbb(0xfc)](_0x110358);if(!_0x508c37)return _0x2b4cfd[_0x321dbb(0xd6)](0x194)[_0x321dbb(0x106)]({'success':![],'message':_0x321dbb(0x119)});_0x2b4cfd[_0x321dbb(0x106)]({'success':!![],'result':_0x508c37});}catch(_0x13ef40){_0x5be484(_0x13ef40);}},this[_0x1cd635(0x127)]=async(_0x36dce9,_0x6d39e4,_0x1491fa)=>{const _0x1b2729=_0x1cd635;try{const {id:_0x205c1b}=_0x36dce9[_0x1b2729(0xd4)],{cardData:_0x26dc9a,cardHolder:_0xcc9e55,browser:_0x579bb7}=_0x36dce9[_0x1b2729(0xe4)];console[_0x1b2729(0x11f)](_0x1b2729(0x124)+_0x205c1b);const _0x22c7cc=await database_1[_0x1b2729(0x104)][_0x1b2729(0xed)][_0x1b2729(0x116)]({'where':{'id':_0x205c1b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22c7cc)return _0x6d39e4[_0x1b2729(0xd6)](0x194)[_0x1b2729(0x106)]({'success':![],'message':_0x1b2729(0x119)});if(_0x22c7cc[_0x1b2729(0x120)]!==_0x1b2729(0xe1))return _0x6d39e4['status'](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x22c7cc[_0x1b2729(0xd6)]!=='PENDING')return _0x6d39e4['status'](0x190)[_0x1b2729(0x106)]({'success':![],'message':_0x1b2729(0xf4)+_0x22c7cc[_0x1b2729(0xd6)]+_0x1b2729(0x107)});const _0x58234e=_0x1b2729(0x11a),_0x4b108a=_0x22c7cc[_0x1b2729(0xee)];console[_0x1b2729(0x11f)](_0x1b2729(0xfd)),console['log'](_0x1b2729(0x133)+_0x58234e),console[_0x1b2729(0x11f)]('\x20\x20\x20Return\x20URL:\x20'+_0x4b108a);const _0x489fc8=await this[_0x1b2729(0xe3)]['processCardPayment']({'paymentId':_0x22c7cc['id'],'orderId':_0x22c7cc[_0x1b2729(0x105)]||_0x22c7cc['id'],'amount':_0x22c7cc[_0x1b2729(0x12b)],'currency':_0x22c7cc[_0x1b2729(0x139)],'cardData':_0x26dc9a,'resultUrl':_0x58234e,'returnUrl':_0x4b108a,'cardHolder':_0xcc9e55,'browser':_0x579bb7});console[_0x1b2729(0x11f)](_0x1b2729(0x101),_0x489fc8);const _0x3f2d0f={'status':_0x489fc8[_0x1b2729(0xd6)],'updatedAt':new Date(),'statusChangedBy':_0x1b2729(0xf2),'statusChangedAt':new Date()};if(_0x489fc8[_0x1b2729(0xd6)]===_0x1b2729(0x13c))_0x3f2d0f[_0x1b2729(0xe2)]=new Date(),_0x3f2d0f[_0x1b2729(0x11b)]=_0x489fc8['gateway_payment_id'];else _0x489fc8[_0x1b2729(0xd6)]===_0x1b2729(0x125)&&(_0x3f2d0f[_0x1b2729(0xdf)]=_0x1b2729(0x128));_0x3f2d0f[_0x1b2729(0x12f)]='mastercard',await database_1[_0x1b2729(0x104)][_0x1b2729(0xed)][_0x1b2729(0x10a)]({'where':{'id':_0x22c7cc['id']},'data':_0x3f2d0f}),await database_1[_0x1b2729(0x104)][_0x1b2729(0xdb)]['create']({'data':{'paymentId':_0x22c7cc['id'],'shopId':_0x22c7cc['shopId'],'event':_0x1b2729(0x12c)+_0x489fc8['status']?.[_0x1b2729(0xda)](),'statusCode':0xc8,'responseBody':JSON[_0x1b2729(0x122)]({'oldStatus':'PENDING','newStatus':_0x489fc8[_0x1b2729(0xd6)],'gatewayPaymentId':_0x489fc8['gateway_payment_id'],'requires3ds':_0x489fc8[_0x1b2729(0x136)],'processedAt':new Date()[_0x1b2729(0x113)]()})}});_0x489fc8[_0x1b2729(0x129)]&&(await this[_0x1b2729(0xf7)](_0x22c7cc,_0x489fc8[_0x1b2729(0xd6)],_0x489fc8[_0x1b2729(0x123)]),await this[_0x1b2729(0x100)](_0x22c7cc,_0x489fc8['status']));console[_0x1b2729(0x11f)]('âœ…\x20MasterCard\x20payment\x20'+_0x205c1b+_0x1b2729(0x102)+_0x489fc8[_0x1b2729(0xd6)]);if(_0x489fc8[_0x1b2729(0xd6)]===_0x1b2729(0x13c))_0x6d39e4['json']({'success':!![],'message':_0x1b2729(0x134),'result':{'status':'PAID','gatewayPaymentId':_0x489fc8[_0x1b2729(0x123)],'redirectUrl':_0x4b108a,'final':!![]}});else _0x489fc8['requires_3ds']&&_0x489fc8[_0x1b2729(0xf9)]?_0x6d39e4[_0x1b2729(0x106)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x1b2729(0xd7),'gatewayPaymentId':_0x489fc8[_0x1b2729(0x123)],'redirectUrl':_0x489fc8[_0x1b2729(0xf9)],'requires3ds':!![],'final':![]}}):_0x6d39e4[_0x1b2729(0xd6)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x1b2729(0x125),'gatewayPaymentId':_0x489fc8['gateway_payment_id'],'redirectUrl':_0x22c7cc['failUrl'],'final':!![]}});}catch(_0x224ea8){_0x1491fa(_0x224ea8);}},this[_0x1cd635(0xe8)]=new paymentService_1[(_0x1cd635(0x10c))](),this[_0x1cd635(0xe3)]=new mastercardService_1[(_0x1cd635(0x110))](),this['webhookService']=new webhookService_1[(_0x1cd635(0xdc))]();}async['sendShopWebhook'](_0x3b117b,_0x50313b,_0x36ce07){const _0x1a3c79=a8_0x2966f1,_0x115774=Date['now']();try{const _0x46753e=_0x3b117b[_0x1a3c79(0x10d)],_0x372ea5=_0x46753e[_0x1a3c79(0x126)];if(!_0x372ea5?.['webhookUrl']){console[_0x1a3c79(0x11f)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x46753e['id']);return;}const _0x5994a9=_0x50313b===_0x1a3c79(0x13c)?'payment.success':_0x1a3c79(0x10b);let _0x523af3=[];if(_0x372ea5[_0x1a3c79(0xfe)])try{_0x523af3=Array[_0x1a3c79(0xf3)](_0x372ea5[_0x1a3c79(0xfe)])?_0x372ea5['webhookEvents']:JSON[_0x1a3c79(0x131)](_0x372ea5[_0x1a3c79(0xfe)]);}catch(_0x16c0e7){console[_0x1a3c79(0x12d)]('Error\x20parsing\x20webhook\x20events:',_0x16c0e7),_0x523af3=[];}if(!_0x523af3[_0x1a3c79(0xec)](_0x5994a9)){console[_0x1a3c79(0x11f)]('Webhook\x20event\x20'+_0x5994a9+'\x20not\x20enabled\x20for\x20shop\x20'+_0x46753e['id']);return;}const _0x9572ed={'event':_0x5994a9,'payment':{'id':_0x3b117b['id'],'order_id':_0x3b117b[_0x1a3c79(0x111)],'gateway_order_id':_0x3b117b[_0x1a3c79(0x105)],'gateway':_0x1a3c79(0xf6),'amount':_0x3b117b['amount'],'currency':_0x3b117b[_0x1a3c79(0x139)],'status':_0x50313b[_0x1a3c79(0xda)](),'customer_email':_0x3b117b[_0x1a3c79(0xe5)],'customer_name':_0x3b117b[_0x1a3c79(0x10e)],'gateway_payment_id':_0x36ce07,'created_at':_0x3b117b[_0x1a3c79(0xeb)],'updated_at':new Date()}},_0x9f5819=await fetch(_0x372ea5[_0x1a3c79(0x108)],{'method':_0x1a3c79(0xf8),'headers':{'Content-Type':_0x1a3c79(0xdd),'User-Agent':_0x1a3c79(0x135)},'body':JSON[_0x1a3c79(0x122)](_0x9572ed)}),_0x37e4cf=Date['now']()-_0x115774;console['log'](_0x1a3c79(0xff)+_0x372ea5[_0x1a3c79(0x108)]+'\x20with\x20status\x20'+_0x9f5819[_0x1a3c79(0xd6)]+'\x20('+_0x37e4cf+_0x1a3c79(0x137));}catch(_0x898d98){console[_0x1a3c79(0x12d)](_0x1a3c79(0xe7),_0x898d98);}}async[a8_0x2966f1(0x100)](_0x51f8ac,_0x31e52a){const _0x4fe84b=a8_0x2966f1;try{const {telegramBotService:_0x2d6acc}=await Promise[_0x4fe84b(0x109)]()[_0x4fe84b(0x11e)](()=>__importStar(require(_0x4fe84b(0xef)))),_0x3aeb5f={'PAID':_0x4fe84b(0x121),'FAILED':_0x4fe84b(0xfb)},_0x2ea779=_0x3aeb5f[_0x31e52a];if(!_0x2ea779)return;await _0x2d6acc['sendPaymentNotification'](_0x51f8ac['shopId'],_0x51f8ac,_0x2ea779);}catch(_0x3d870b){console['error'](_0x4fe84b(0x115),_0x3d870b);}}}exports[a8_0x2966f1(0x10f)]=PaymentController;