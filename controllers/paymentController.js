'use strict';const a8_0x3bed07=a8_0x42b1;(function(_0x28c7ef,_0x2399d5){const _0x2e28ad=a8_0x42b1,_0x6b009a=_0x28c7ef();while(!![]){try{const _0x50d329=parseInt(_0x2e28ad(0x169))/0x1*(parseInt(_0x2e28ad(0x17d))/0x2)+parseInt(_0x2e28ad(0x126))/0x3+parseInt(_0x2e28ad(0x13f))/0x4+-parseInt(_0x2e28ad(0x154))/0x5*(-parseInt(_0x2e28ad(0x176))/0x6)+-parseInt(_0x2e28ad(0x13e))/0x7+parseInt(_0x2e28ad(0x142))/0x8+-parseInt(_0x2e28ad(0x11d))/0x9*(parseInt(_0x2e28ad(0x12e))/0xa);if(_0x50d329===_0x2399d5)break;else _0x6b009a['push'](_0x6b009a['shift']());}catch(_0x1e154b){_0x6b009a['push'](_0x6b009a['shift']());}}}(a8_0x22db,0xea854));var __createBinding=this&&this['__createBinding']||(Object[a8_0x3bed07(0x161)]?function(_0x3a451d,_0x5b92f9,_0x539429,_0x424923){const _0x58fc92=a8_0x3bed07;if(_0x424923===undefined)_0x424923=_0x539429;var _0x331e4b=Object[_0x58fc92(0x156)](_0x5b92f9,_0x539429);(!_0x331e4b||(_0x58fc92(0x13d)in _0x331e4b?!_0x5b92f9[_0x58fc92(0x181)]:_0x331e4b[_0x58fc92(0x11e)]||_0x331e4b[_0x58fc92(0x14a)]))&&(_0x331e4b={'enumerable':!![],'get':function(){return _0x5b92f9[_0x539429];}}),Object['defineProperty'](_0x3a451d,_0x424923,_0x331e4b);}:function(_0x2ceec8,_0xd544be,_0x22b37b,_0x142b3e){if(_0x142b3e===undefined)_0x142b3e=_0x22b37b;_0x2ceec8[_0x142b3e]=_0xd544be[_0x22b37b];}),__setModuleDefault=this&&this[a8_0x3bed07(0x178)]||(Object[a8_0x3bed07(0x161)]?function(_0x5036f8,_0x8f7ab){const _0x181055=a8_0x3bed07;Object[_0x181055(0x151)](_0x5036f8,'default',{'enumerable':!![],'value':_0x8f7ab});}:function(_0x18daba,_0x4b10ff){const _0x3f7009=a8_0x3bed07;_0x18daba[_0x3f7009(0x147)]=_0x4b10ff;}),__importStar=this&&this[a8_0x3bed07(0x137)]||(function(){var _0x1b9e5d=function(_0x5bb770){const _0x59fbdf=a8_0x42b1;return _0x1b9e5d=Object[_0x59fbdf(0x131)]||function(_0x38163b){const _0x244309=_0x59fbdf;var _0x352dfd=[];for(var _0x1472ff in _0x38163b)if(Object[_0x244309(0x13c)]['hasOwnProperty'][_0x244309(0x11c)](_0x38163b,_0x1472ff))_0x352dfd[_0x352dfd[_0x244309(0x175)]]=_0x1472ff;return _0x352dfd;},_0x1b9e5d(_0x5bb770);};return function(_0x7b83d9){const _0x2fe8b4=a8_0x42b1;if(_0x7b83d9&&_0x7b83d9[_0x2fe8b4(0x181)])return _0x7b83d9;var _0x562010={};if(_0x7b83d9!=null){for(var _0x1f8790=_0x1b9e5d(_0x7b83d9),_0x29b642=0x0;_0x29b642<_0x1f8790['length'];_0x29b642++)if(_0x1f8790[_0x29b642]!==_0x2fe8b4(0x147))__createBinding(_0x562010,_0x7b83d9,_0x1f8790[_0x29b642]);}return __setModuleDefault(_0x562010,_0x7b83d9),_0x562010;};}()),__importDefault=this&&this['__importDefault']||function(_0xe73d40){return _0xe73d40&&_0xe73d40['__esModule']?_0xe73d40:{'default':_0xe73d40};};function a8_0x42b1(_0x9bb322,_0x543315){const _0x22dbff=a8_0x22db();return a8_0x42b1=function(_0x42b171,_0x14c004){_0x42b171=_0x42b171-0x119;let _0x11c137=_0x22dbff[_0x42b171];return _0x11c137;},a8_0x42b1(_0x9bb322,_0x543315);}Object[a8_0x3bed07(0x151)](exports,a8_0x3bed07(0x181),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x3bed07(0x166)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x3ced01=a8_0x3bed07;this[_0x3ced01(0x174)]=async(_0x55258f,_0x43d579,_0x56b94c)=>{const _0x374d13=_0x3ced01;try{const _0x25bc1e=_0x55258f[_0x374d13(0x12d)],_0x1773c8=await this[_0x374d13(0x157)][_0x374d13(0x174)](_0x25bc1e);_0x43d579[_0x374d13(0x162)](0xc9)[_0x374d13(0x180)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x1773c8});}catch(_0x16f8dc){_0x56b94c(_0x16f8dc);}},this[_0x3ced01(0x127)]=async(_0x1678c2,_0x1928ab,_0x120809)=>{const _0x26e6c5=_0x3ced01;try{const {id:_0x9e6e11}=_0x1678c2['params'],_0x195a2b=await this['paymentService'][_0x26e6c5(0x127)](_0x9e6e11);if(!_0x195a2b)return _0x1928ab[_0x26e6c5(0x162)](0x194)[_0x26e6c5(0x180)]({'success':![],'message':_0x26e6c5(0x150)});_0x1928ab[_0x26e6c5(0x180)]({'success':!![],'result':_0x195a2b});}catch(_0x4eaf1a){_0x120809(_0x4eaf1a);}},this[_0x3ced01(0x140)]=async(_0x4e39ab,_0x1ced93,_0x409bf6)=>{const _0x15cd06=_0x3ced01;try{const {id:_0x54767c}=_0x4e39ab[_0x15cd06(0x149)],_0x192ce7=await this[_0x15cd06(0x157)][_0x15cd06(0x140)](_0x54767c);if(!_0x192ce7)return _0x1ced93[_0x15cd06(0x162)](0x194)[_0x15cd06(0x180)]({'success':![],'message':_0x15cd06(0x150)});_0x1ced93[_0x15cd06(0x180)]({'success':!![],'result':_0x192ce7});}catch(_0x3b666e){_0x409bf6(_0x3b666e);}},this[_0x3ced01(0x160)]=async(_0x5cc1aa,_0x1ead8c,_0x26bb9b)=>{const _0x522d0e=_0x3ced01;try{const {id:_0x7c423e}=_0x5cc1aa['params'],{cardData:_0x5d4a15,cardHolder:_0x2ab6dd,browser:_0x49ab3e}=_0x5cc1aa['body'];console[_0x522d0e(0x124)](_0x522d0e(0x15f)+_0x7c423e);const _0x2816c8=await database_1[_0x522d0e(0x147)][_0x522d0e(0x167)][_0x522d0e(0x168)]({'where':{'id':_0x7c423e},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2816c8)return _0x1ead8c['status'](0x194)[_0x522d0e(0x180)]({'success':![],'message':_0x522d0e(0x150)});if(_0x2816c8['gateway']!==_0x522d0e(0x141))return _0x1ead8c[_0x522d0e(0x162)](0x190)[_0x522d0e(0x180)]({'success':![],'message':_0x522d0e(0x17c)});if(_0x2816c8['status']!==_0x522d0e(0x136))return _0x1ead8c[_0x522d0e(0x162)](0x190)[_0x522d0e(0x180)]({'success':![],'message':_0x522d0e(0x123)+_0x2816c8[_0x522d0e(0x162)]+_0x522d0e(0x17b)});const _0x1fe161=_0x522d0e(0x125),_0x1aacd1=_0x2816c8['successUrl'];console['log']('ðŸ’³\x20MasterCard\x20URLs:'),console[_0x522d0e(0x124)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x1fe161),console[_0x522d0e(0x124)]('\x20\x20\x20Return\x20URL:\x20'+_0x1aacd1);const _0x3c97c8=await this['masterCardService'][_0x522d0e(0x132)]({'paymentId':_0x2816c8['id'],'orderId':_0x2816c8[_0x522d0e(0x159)]||_0x2816c8['id'],'amount':_0x2816c8[_0x522d0e(0x158)],'currency':_0x2816c8[_0x522d0e(0x17a)],'cardData':_0x5d4a15,'resultUrl':_0x1fe161,'returnUrl':_0x1aacd1,'cardHolder':_0x2ab6dd,'browser':_0x49ab3e});console[_0x522d0e(0x124)](_0x522d0e(0x11f),_0x3c97c8);const _0x4409c5={'status':_0x3c97c8[_0x522d0e(0x162)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x3c97c8[_0x522d0e(0x162)]===_0x522d0e(0x179))_0x4409c5['paidAt']=new Date(),_0x4409c5[_0x522d0e(0x16e)]=_0x3c97c8[_0x522d0e(0x135)];else _0x3c97c8[_0x522d0e(0x162)]===_0x522d0e(0x13b)&&(_0x4409c5[_0x522d0e(0x130)]=_0x522d0e(0x14c));_0x4409c5['paymentMethod']=_0x522d0e(0x141),await database_1[_0x522d0e(0x147)]['payment'][_0x522d0e(0x14e)]({'where':{'id':_0x2816c8['id']},'data':_0x4409c5}),await database_1[_0x522d0e(0x147)]['webhookLog'][_0x522d0e(0x161)]({'data':{'paymentId':_0x2816c8['id'],'shopId':_0x2816c8['shopId'],'event':_0x522d0e(0x145)+_0x3c97c8[_0x522d0e(0x162)]?.[_0x522d0e(0x173)](),'statusCode':0xc8,'responseBody':JSON[_0x522d0e(0x12f)]({'oldStatus':_0x522d0e(0x136),'newStatus':_0x3c97c8[_0x522d0e(0x162)],'gatewayPaymentId':_0x3c97c8[_0x522d0e(0x135)],'requires3ds':_0x3c97c8[_0x522d0e(0x122)],'processedAt':new Date()['toISOString']()})}});_0x3c97c8[_0x522d0e(0x16b)]&&(await this[_0x522d0e(0x133)](_0x2816c8,_0x3c97c8['status'],_0x3c97c8[_0x522d0e(0x135)]),await this[_0x522d0e(0x15b)](_0x2816c8,_0x3c97c8['status']));console['log']('âœ…\x20MasterCard\x20payment\x20'+_0x7c423e+_0x522d0e(0x139)+_0x3c97c8[_0x522d0e(0x162)]);if(_0x3c97c8['status']===_0x522d0e(0x179))_0x1ead8c[_0x522d0e(0x180)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x522d0e(0x179),'gatewayPaymentId':_0x3c97c8[_0x522d0e(0x135)],'redirectUrl':_0x1aacd1,'final':!![]}});else _0x3c97c8[_0x522d0e(0x122)]&&_0x3c97c8[_0x522d0e(0x16d)]?_0x1ead8c[_0x522d0e(0x180)]({'success':!![],'message':_0x522d0e(0x14b),'result':{'status':_0x522d0e(0x136),'gatewayPaymentId':_0x3c97c8['gateway_payment_id'],'redirectUrl':_0x3c97c8[_0x522d0e(0x16d)],'requires3ds':!![],'final':![]}}):_0x1ead8c['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x522d0e(0x13b),'gatewayPaymentId':_0x3c97c8['gateway_payment_id'],'redirectUrl':_0x2816c8['failUrl'],'final':!![]}});}catch(_0x3b663f){_0x26bb9b(_0x3b663f);}},this['updateCustomerData']=async(_0x325a35,_0x594dce,_0x41db3e)=>{const _0x18f4ea=_0x3ced01;try{const {id:_0x5ce7fe}=_0x325a35[_0x18f4ea(0x149)],{customerIp:_0x1505b3,customerUa:_0x33e2da,customerCountry:_0x5baae4}=_0x325a35[_0x18f4ea(0x12d)],_0x3abd2b=await database_1[_0x18f4ea(0x147)][_0x18f4ea(0x167)][_0x18f4ea(0x168)]({'where':{'id':_0x5ce7fe},'select':{'id':!![],'status':!![]}});if(!_0x3abd2b)return _0x594dce[_0x18f4ea(0x162)](0x194)[_0x18f4ea(0x180)]({'success':![],'message':_0x18f4ea(0x150)});const _0x2ba372=await database_1[_0x18f4ea(0x147)]['payment'][_0x18f4ea(0x14e)]({'where':{'id':_0x5ce7fe},'data':{'customerIp':_0x1505b3||undefined,'customerUa':_0x33e2da||undefined,'customerCountry':_0x5baae4||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console['log'](_0x18f4ea(0x170)+_0x5ce7fe+':',{'customerIp':_0x1505b3||_0x18f4ea(0x153),'customerUa':_0x33e2da?_0x33e2da[_0x18f4ea(0x177)](0x0,0x32)+_0x18f4ea(0x138):'not\x20provided','customerCountry':_0x5baae4||_0x18f4ea(0x153)}),_0x594dce[_0x18f4ea(0x180)]({'success':!![],'message':_0x18f4ea(0x17e),'result':_0x2ba372});}catch(_0xbdef6f){_0x41db3e(_0xbdef6f);}},this['paymentService']=new paymentService_1[(_0x3ced01(0x15c))](),this[_0x3ced01(0x121)]=new mastercardService_1[(_0x3ced01(0x129))](),this[_0x3ced01(0x15a)]=new webhookService_1[(_0x3ced01(0x13a))]();}async['sendShopWebhook'](_0x231e82,_0x3fd1f2,_0x5a204e){const _0x206310=a8_0x3bed07,_0x2bf963=Date[_0x206310(0x171)]();try{const _0x436436=_0x231e82[_0x206310(0x144)],_0x5ee02c=_0x436436[_0x206310(0x12c)];if(!_0x5ee02c?.[_0x206310(0x143)]){console[_0x206310(0x124)](_0x206310(0x14d)+_0x436436['id']);return;}const _0x371f60=_0x3fd1f2===_0x206310(0x179)?_0x206310(0x12b):_0x206310(0x152);let _0x31ef96=[];if(_0x5ee02c[_0x206310(0x14f)])try{_0x31ef96=Array[_0x206310(0x148)](_0x5ee02c[_0x206310(0x14f)])?_0x5ee02c[_0x206310(0x14f)]:JSON['parse'](_0x5ee02c[_0x206310(0x14f)]);}catch(_0x48fbeb){console[_0x206310(0x17f)](_0x206310(0x119),_0x48fbeb),_0x31ef96=[];}if(!_0x31ef96[_0x206310(0x120)](_0x371f60)){console['log']('Webhook\x20event\x20'+_0x371f60+_0x206310(0x15e)+_0x436436['id']);return;}const _0x50d19c={'event':_0x371f60,'payment':{'id':_0x231e82['id'],'order_id':_0x231e82[_0x206310(0x163)],'gateway_order_id':_0x231e82['gatewayOrderId'],'gateway':_0x206310(0x16c),'amount':_0x231e82[_0x206310(0x158)],'currency':_0x231e82[_0x206310(0x17a)],'status':_0x3fd1f2['toLowerCase'](),'customer_email':_0x231e82['customerEmail'],'customer_name':_0x231e82['customerName'],'gateway_payment_id':_0x5a204e,'created_at':_0x231e82['createdAt'],'updated_at':new Date()}},_0x230697=await fetch(_0x5ee02c[_0x206310(0x143)],{'method':_0x206310(0x146),'headers':{'Content-Type':_0x206310(0x165),'User-Agent':_0x206310(0x16f)},'body':JSON[_0x206310(0x12f)](_0x50d19c)}),_0x48efff=Date[_0x206310(0x171)]()-_0x2bf963;console[_0x206310(0x124)](_0x206310(0x16a)+_0x5ee02c[_0x206310(0x143)]+_0x206310(0x134)+_0x230697['status']+'\x20('+_0x48efff+_0x206310(0x11b));}catch(_0xde2b70){console[_0x206310(0x17f)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0xde2b70);}}async['sendPaymentStatusNotification'](_0x2459da,_0x4d3af0){const _0x319b79=a8_0x3bed07;try{const {telegramBotService:_0x128ff8}=await Promise[_0x319b79(0x15d)]()[_0x319b79(0x128)](()=>__importStar(require(_0x319b79(0x12a)))),_0xd05c3f={'PAID':_0x319b79(0x155),'FAILED':'failed'},_0x363da4=_0xd05c3f[_0x4d3af0];if(!_0x363da4)return;await _0x128ff8[_0x319b79(0x172)](_0x2459da['shopId'],_0x2459da,_0x363da4);}catch(_0x1067c2){console['error'](_0x319b79(0x164),_0x1067c2);}}}function a8_0x22db(){const _0x287b5c=['https://api.trapay.uk/api/webhooks/gateway/mastercard','3189840SzVvRf','getPaymentStatus','then','MasterCardService','../services/telegramBotService','payment.success','settings','body','1730yHYJcE','stringify','failureMessage','getOwnPropertyNames','processCardPayment','sendShopWebhook','\x20with\x20status\x20','gateway_payment_id','PENDING','__importStar','...','\x20processed:\x20','WebhookService','FAILED','prototype','get','1196720mZkwAM','7059524Gwrfyt','getPaymentById','mastercard','11927336rFfngi','webhookUrl','shop','mastercard_','POST','default','isArray','params','configurable','3DS\x20verification\x20required','Card\x20payment\x20failed','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','update','webhookEvents','Payment\x20not\x20found','defineProperty','payment.failed','not\x20provided','5356745ThbfCt','paid','getOwnPropertyDescriptor','paymentService','amount','gatewayOrderId','webhookService','sendPaymentStatusNotification','PaymentService','resolve','\x20not\x20enabled\x20for\x20shop\x20','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','processMasterCardPayment','create','status','orderId','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','application/json','../services/gateways/mastercardService','payment','findUnique','7165KWFYIu','MasterCard\x20webhook\x20sent\x20to\x20','final','1111','threeds_url','gatewayPaymentId','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','now','sendPaymentNotification','toLowerCase','createPublicPayment','length','6yQHKxI','substring','__setModuleDefault','PAID','currency',',\x20cannot\x20process','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','352YDBWBc','Customer\x20data\x20updated\x20successfully','error','json','__esModule','Error\x20parsing\x20webhook\x20events:','PaymentController','ms)','call','287163NZwWuy','writable','ðŸ’³\x20MasterCard\x20result:','includes','masterCardService','requires_3ds','Payment\x20status\x20is\x20','log'];a8_0x22db=function(){return _0x287b5c;};return a8_0x22db();}exports[a8_0x3bed07(0x11a)]=PaymentController;