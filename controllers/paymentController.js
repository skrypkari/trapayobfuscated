'use strict';const a8_0x4059ec=a8_0xcb8d;(function(_0x4c305e,_0x59eaf3){const _0x815a80=a8_0xcb8d,_0x310d4b=_0x4c305e();while(!![]){try{const _0x10ca4e=-parseInt(_0x815a80(0x1f3))/0x1+-parseInt(_0x815a80(0x1c1))/0x2+parseInt(_0x815a80(0x195))/0x3*(-parseInt(_0x815a80(0x1a6))/0x4)+parseInt(_0x815a80(0x1b6))/0x5+-parseInt(_0x815a80(0x1be))/0x6*(-parseInt(_0x815a80(0x1dd))/0x7)+-parseInt(_0x815a80(0x1d7))/0x8*(-parseInt(_0x815a80(0x196))/0x9)+parseInt(_0x815a80(0x188))/0xa;if(_0x10ca4e===_0x59eaf3)break;else _0x310d4b['push'](_0x310d4b['shift']());}catch(_0xdb6c2e){_0x310d4b['push'](_0x310d4b['shift']());}}}(a8_0x382f,0x26195));var __createBinding=this&&this[a8_0x4059ec(0x1a5)]||(Object['create']?function(_0x28be6f,_0xe8e68d,_0x402141,_0x54424e){const _0x48600d=a8_0x4059ec;if(_0x54424e===undefined)_0x54424e=_0x402141;var _0x3cea14=Object[_0x48600d(0x1d2)](_0xe8e68d,_0x402141);(!_0x3cea14||(_0x48600d(0x17b)in _0x3cea14?!_0xe8e68d[_0x48600d(0x1a0)]:_0x3cea14[_0x48600d(0x191)]||_0x3cea14[_0x48600d(0x179)]))&&(_0x3cea14={'enumerable':!![],'get':function(){return _0xe8e68d[_0x402141];}}),Object[_0x48600d(0x18d)](_0x28be6f,_0x54424e,_0x3cea14);}:function(_0x27e3ca,_0x5d3eb6,_0x56b2e2,_0x140be5){if(_0x140be5===undefined)_0x140be5=_0x56b2e2;_0x27e3ca[_0x140be5]=_0x5d3eb6[_0x56b2e2];}),__setModuleDefault=this&&this[a8_0x4059ec(0x1ab)]||(Object[a8_0x4059ec(0x1a3)]?function(_0xa6aab,_0x17c380){Object['defineProperty'](_0xa6aab,'default',{'enumerable':!![],'value':_0x17c380});}:function(_0x399615,_0x89ef49){_0x399615['default']=_0x89ef49;}),__importStar=this&&this['__importStar']||(function(){var _0x62b375=function(_0x5be051){return _0x62b375=Object['getOwnPropertyNames']||function(_0x5dba52){const _0x5b4876=a8_0xcb8d;var _0x41d9fc=[];for(var _0x168f3b in _0x5dba52)if(Object[_0x5b4876(0x1d5)]['hasOwnProperty']['call'](_0x5dba52,_0x168f3b))_0x41d9fc[_0x41d9fc[_0x5b4876(0x1b4)]]=_0x168f3b;return _0x41d9fc;},_0x62b375(_0x5be051);};return function(_0x3b28b0){const _0x5cf330=a8_0xcb8d;if(_0x3b28b0&&_0x3b28b0[_0x5cf330(0x1a0)])return _0x3b28b0;var _0x5f0a13={};if(_0x3b28b0!=null){for(var _0x3f292f=_0x62b375(_0x3b28b0),_0x30d265=0x0;_0x30d265<_0x3f292f['length'];_0x30d265++)if(_0x3f292f[_0x30d265]!==_0x5cf330(0x1c7))__createBinding(_0x5f0a13,_0x3b28b0,_0x3f292f[_0x30d265]);}return __setModuleDefault(_0x5f0a13,_0x3b28b0),_0x5f0a13;};}()),__importDefault=this&&this[a8_0x4059ec(0x192)]||function(_0x4a57fb){return _0x4a57fb&&_0x4a57fb['__esModule']?_0x4a57fb:{'default':_0x4a57fb};};Object[a8_0x4059ec(0x18d)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x4059ec(0x1ae)),database_1=__importDefault(require(a8_0x4059ec(0x1ec)));function a8_0xcb8d(_0x2833b0,_0x13f232){const _0x382f1f=a8_0x382f();return a8_0xcb8d=function(_0xcb8d3b,_0x31bb7e){_0xcb8d3b=_0xcb8d3b-0x179;let _0x5703b=_0x382f1f[_0xcb8d3b];return _0x5703b;},a8_0xcb8d(_0x2833b0,_0x13f232);}class PaymentController{constructor(){const _0x1816ba=a8_0x4059ec;this[_0x1816ba(0x1bb)]=async(_0x22688f,_0x38dad1,_0x4b6c2c)=>{const _0x4cb913=_0x1816ba;try{const _0x56faf2=_0x22688f[_0x4cb913(0x1b3)],_0xea9b3b=await this['paymentService'][_0x4cb913(0x1bb)](_0x56faf2);_0x38dad1['status'](0xc9)[_0x4cb913(0x1a1)]({'success':!![],'message':_0x4cb913(0x1d6),'result':_0xea9b3b});}catch(_0x50f98f){_0x4b6c2c(_0x50f98f);}},this['getPaymentStatus']=async(_0x46de13,_0x28872f,_0x2a73bb)=>{const _0x405ba6=_0x1816ba;try{const {id:_0x162cb6}=_0x46de13[_0x405ba6(0x1f1)],_0x212788=await this[_0x405ba6(0x17a)]['getPaymentStatus'](_0x162cb6);if(!_0x212788)return _0x28872f['status'](0x194)['json']({'success':![],'message':_0x405ba6(0x1e6)});_0x28872f['json']({'success':!![],'result':_0x212788});}catch(_0x17280e){_0x2a73bb(_0x17280e);}},this[_0x1816ba(0x1db)]=async(_0x1484c4,_0x3402ea,_0x358ece)=>{const _0x2bfb32=_0x1816ba;try{const {id:_0x5b1002}=_0x1484c4['params'],_0x562435=await this[_0x2bfb32(0x17a)][_0x2bfb32(0x1db)](_0x5b1002);if(!_0x562435)return _0x3402ea[_0x2bfb32(0x182)](0x194)[_0x2bfb32(0x1a1)]({'success':![],'message':_0x2bfb32(0x1e6)});_0x3402ea[_0x2bfb32(0x1a1)]({'success':!![],'result':_0x562435});}catch(_0x4b0f87){_0x358ece(_0x4b0f87);}},this[_0x1816ba(0x1e2)]=async(_0x17d974,_0x579d32,_0x59c03d)=>{const _0x3cf5ac=_0x1816ba;try{const {id:_0x32bf1f}=_0x17d974[_0x3cf5ac(0x1f1)],_0xe5089c=_0x17d974[_0x3cf5ac(0x1b3)];console['log'](_0x3cf5ac(0x1b0)+_0x32bf1f),console[_0x3cf5ac(0x1bd)](_0x3cf5ac(0x1bc),_0xe5089c);const _0x5d4a61=await this[_0x3cf5ac(0x17a)][_0x3cf5ac(0x1ef)](_0x32bf1f,_0xe5089c);if(!_0x5d4a61)return _0x579d32['status'](0x194)[_0x3cf5ac(0x1a1)]({'success':![],'message':'Payment\x20not\x20found'});_0x579d32['json']({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x5d4a61['id'],'customerIp':_0x5d4a61[_0x3cf5ac(0x198)],'customerUa':_0x5d4a61[_0x3cf5ac(0x1c3)],'customerCountry':_0x5d4a61[_0x3cf5ac(0x19a)],'updatedAt':_0x5d4a61[_0x3cf5ac(0x18f)]}});}catch(_0x405fb3){_0x59c03d(_0x405fb3);}},this[_0x1816ba(0x185)]=async(_0x418449,_0x109351,_0xe38a4f)=>{const _0x2f52e5=_0x1816ba;try{const {id:_0x3307fa}=_0x418449[_0x2f52e5(0x1f1)],{cardData:_0x37d822,cardHolder:_0x38fd7d,browser:_0xedcc1a}=_0x418449[_0x2f52e5(0x1b3)];console[_0x2f52e5(0x1bd)](_0x2f52e5(0x1a2)+_0x3307fa),console[_0x2f52e5(0x1bd)](_0x2f52e5(0x1d0)+_0x38fd7d[_0x2f52e5(0x1a4)]+'\x20'+_0x38fd7d[_0x2f52e5(0x189)]+'\x20('+_0x38fd7d[_0x2f52e5(0x184)]+')'),console[_0x2f52e5(0x1bd)](_0x2f52e5(0x1b9)+_0xedcc1a['ip']);const _0x2d7268={'customerName':_0x38fd7d[_0x2f52e5(0x1a4)]+'\x20'+_0x38fd7d[_0x2f52e5(0x189)],'customerEmail':_0x38fd7d['email'],'customerIp':_0xedcc1a['ip'],'customerUa':_0xedcc1a['user_agent']},_0x369909=await database_1[_0x2f52e5(0x1c7)][_0x2f52e5(0x19d)][_0x2f52e5(0x18c)]({'where':{'id':_0x3307fa},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x369909)return _0x109351[_0x2f52e5(0x182)](0x194)[_0x2f52e5(0x1a1)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x369909[_0x2f52e5(0x1c0)]!==_0x2f52e5(0x1cf))return _0x109351['status'](0x190)['json']({'success':![],'message':_0x2f52e5(0x1d8)});if(_0x369909[_0x2f52e5(0x182)]!==_0x2f52e5(0x1d4))return _0x109351[_0x2f52e5(0x182)](0x190)['json']({'success':![],'message':_0x2f52e5(0x17d)+_0x369909[_0x2f52e5(0x182)]+_0x2f52e5(0x1ea)});await database_1[_0x2f52e5(0x1c7)][_0x2f52e5(0x19d)][_0x2f52e5(0x183)]({'where':{'id':_0x3307fa},'data':{..._0x2d7268,'updatedAt':new Date()}});const _0x2c8ca9='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x184f03=_0x369909['successUrl'];console[_0x2f52e5(0x1bd)](_0x2f52e5(0x181)),console[_0x2f52e5(0x1bd)](_0x2f52e5(0x1e8)+_0x2c8ca9),console['log'](_0x2f52e5(0x1b5)+_0x184f03);const _0x37edab={'first_name':_0x38fd7d[_0x2f52e5(0x1a4)],'last_name':_0x38fd7d[_0x2f52e5(0x189)],'email':_0x38fd7d[_0x2f52e5(0x184)]},_0x511b6c=await this[_0x2f52e5(0x1b2)][_0x2f52e5(0x1f4)]({'paymentId':_0x369909['id'],'orderId':_0x369909[_0x2f52e5(0x1ca)]||_0x369909['id'],'amount':_0x369909[_0x2f52e5(0x197)],'currency':_0x369909[_0x2f52e5(0x1cc)],'cardData':_0x37d822,'resultUrl':_0x2c8ca9,'returnUrl':_0x184f03,'cardHolder':_0x37edab,'browser':_0xedcc1a});console['log'](_0x2f52e5(0x19f),_0x511b6c);const _0x2b1f05={'status':_0x511b6c['status'],'updatedAt':new Date(),'statusChangedBy':_0x2f52e5(0x1f7),'statusChangedAt':new Date()};_0x511b6c['gateway_payment_id']&&(_0x2b1f05[_0x2f52e5(0x1d3)]=_0x511b6c['gateway_payment_id'],console[_0x2f52e5(0x1bd)](_0x2f52e5(0x1c9)+_0x511b6c[_0x2f52e5(0x19b)]));if(_0x511b6c['status']===_0x2f52e5(0x1e1))_0x2b1f05[_0x2f52e5(0x1af)]=new Date();else _0x511b6c[_0x2f52e5(0x182)]===_0x2f52e5(0x1df)&&(_0x2b1f05[_0x2f52e5(0x1ce)]='Card\x20payment\x20failed');_0x2b1f05[_0x2f52e5(0x17c)]=_0x2f52e5(0x1cf);if(_0x37d822[_0x2f52e5(0x1ad)]){const _0x22f8ab=_0x37d822[_0x2f52e5(0x1ad)][_0x2f52e5(0x1f6)](/[\s-]/g,'');_0x2b1f05[_0x2f52e5(0x194)]=_0x22f8ab['slice'](-0x4),console[_0x2f52e5(0x1bd)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x2b1f05[_0x2f52e5(0x194)]);}await database_1[_0x2f52e5(0x1c7)][_0x2f52e5(0x19d)][_0x2f52e5(0x183)]({'where':{'id':_0x369909['id']},'data':_0x2b1f05}),await database_1['default']['webhookLog'][_0x2f52e5(0x1a3)]({'data':{'paymentId':_0x369909['id'],'shopId':_0x369909['shopId'],'event':_0x2f52e5(0x1b7)+_0x511b6c['status']?.[_0x2f52e5(0x1ed)](),'statusCode':0xc8,'responseBody':JSON[_0x2f52e5(0x1f2)]({'oldStatus':'PENDING','newStatus':_0x511b6c[_0x2f52e5(0x182)],'gatewayPaymentId':_0x511b6c[_0x2f52e5(0x19b)],'requires3ds':_0x511b6c[_0x2f52e5(0x1c4)],'processedAt':new Date()[_0x2f52e5(0x1a8)]()})}});if(_0x511b6c[_0x2f52e5(0x1de)]){await this[_0x2f52e5(0x18e)](_0x369909,_0x511b6c[_0x2f52e5(0x182)],_0x511b6c[_0x2f52e5(0x19b)]),await this[_0x2f52e5(0x1ac)](_0x369909,_0x511b6c[_0x2f52e5(0x182)]);if(_0x511b6c[_0x2f52e5(0x182)]===_0x2f52e5(0x1e1)){console[_0x2f52e5(0x1bd)](_0x2f52e5(0x18a)+_0x3307fa+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x14636e}=await Promise[_0x2f52e5(0x1a9)]()[_0x2f52e5(0x1e9)](()=>__importStar(require(_0x2f52e5(0x17e)))),_0x16b4c2=new _0x14636e();await _0x16b4c2['handleSuccessfulPayment'](_0x3307fa),console[_0x2f52e5(0x1bd)](_0x2f52e5(0x199)+_0x3307fa);}catch(_0xcc4302){console[_0x2f52e5(0x187)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0xcc4302);}}}console['log']('✅\x20MasterCard\x20payment\x20'+_0x3307fa+_0x2f52e5(0x1cd)+_0x511b6c[_0x2f52e5(0x182)]);if(_0x511b6c['status']===_0x2f52e5(0x1e1))_0x109351[_0x2f52e5(0x1a1)]({'success':!![],'message':_0x2f52e5(0x1b1),'result':{'status':_0x2f52e5(0x1e1),'gatewayPaymentId':_0x511b6c['gateway_payment_id'],'redirectUrl':_0x184f03,'final':!![]}});else _0x511b6c['requires_3ds']&&_0x511b6c['threeds_url']?_0x109351[_0x2f52e5(0x1a1)]({'success':!![],'message':_0x2f52e5(0x1da),'result':{'status':'PENDING','gatewayPaymentId':_0x511b6c[_0x2f52e5(0x19b)],'redirectUrl':_0x511b6c[_0x2f52e5(0x1c2)],'requires3ds':!![],'final':![]}}):_0x109351[_0x2f52e5(0x182)](0x190)[_0x2f52e5(0x1a1)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x2f52e5(0x1df),'gatewayPaymentId':_0x511b6c[_0x2f52e5(0x19b)],'redirectUrl':_0x369909[_0x2f52e5(0x1c8)],'final':!![]}});}catch(_0x29dbe9){_0xe38a4f(_0x29dbe9);}},this[_0x1816ba(0x17a)]=new paymentService_1[(_0x1816ba(0x1a7))](),this[_0x1816ba(0x1b2)]=new mastercardService_1[(_0x1816ba(0x1e3))](),this[_0x1816ba(0x193)]=new webhookService_1['WebhookService']();}async[a8_0x4059ec(0x18e)](_0x110e71,_0x177c3f,_0x5b48dd){const _0x40d79d=a8_0x4059ec,_0x22eea9=Date[_0x40d79d(0x1cb)]();try{const _0x3d5033=_0x110e71[_0x40d79d(0x1e4)],_0x519c49=_0x3d5033[_0x40d79d(0x1b8)];if(!_0x519c49?.[_0x40d79d(0x1ba)]){console['log'](_0x40d79d(0x17f)+_0x3d5033['id']);return;}const _0x3b5825=_0x177c3f===_0x40d79d(0x1e1)?_0x40d79d(0x1c6):'payment.failed';let _0x31968a=[];if(_0x519c49[_0x40d79d(0x19e)])try{_0x31968a=Array['isArray'](_0x519c49['webhookEvents'])?_0x519c49[_0x40d79d(0x19e)]:JSON[_0x40d79d(0x1eb)](_0x519c49['webhookEvents']);}catch(_0x169fef){console['error'](_0x40d79d(0x186),_0x169fef),_0x31968a=[];}if(!_0x31968a[_0x40d79d(0x190)](_0x3b5825)){console[_0x40d79d(0x1bd)](_0x40d79d(0x1e5)+_0x3b5825+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3d5033['id']);return;}const _0x55434b={'event':_0x3b5825,'payment':{'id':_0x110e71['id'],'order_id':_0x110e71['orderId'],'gateway_order_id':_0x110e71[_0x40d79d(0x1ca)],'gateway':_0x40d79d(0x1e0),'amount':_0x110e71[_0x40d79d(0x197)],'currency':_0x110e71[_0x40d79d(0x1cc)],'status':_0x177c3f[_0x40d79d(0x1ed)](),'customer_email':_0x110e71[_0x40d79d(0x18b)],'customer_name':_0x110e71[_0x40d79d(0x1ee)],'gateway_payment_id':_0x5b48dd,'created_at':_0x110e71[_0x40d79d(0x1dc)],'updated_at':new Date()}},_0x2cada0=await fetch(_0x519c49[_0x40d79d(0x1ba)],{'method':_0x40d79d(0x1c5),'headers':{'Content-Type':_0x40d79d(0x19c),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x40d79d(0x1f2)](_0x55434b)}),_0x4f1e53=Date[_0x40d79d(0x1cb)]()-_0x22eea9;console[_0x40d79d(0x1bd)](_0x40d79d(0x180)+_0x519c49[_0x40d79d(0x1ba)]+_0x40d79d(0x1f5)+_0x2cada0[_0x40d79d(0x182)]+'\x20('+_0x4f1e53+_0x40d79d(0x1e7));}catch(_0xdf03fe){console[_0x40d79d(0x187)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0xdf03fe);}}async[a8_0x4059ec(0x1ac)](_0x488d68,_0x3de26f){const _0x5c8763=a8_0x4059ec;try{const {telegramBotService:_0x263046}=await Promise[_0x5c8763(0x1a9)]()[_0x5c8763(0x1e9)](()=>__importStar(require(_0x5c8763(0x1f0)))),_0x364923={'PAID':_0x5c8763(0x1aa),'FAILED':_0x5c8763(0x1d9)},_0x103fb0=_0x364923[_0x3de26f];if(!_0x103fb0)return;await _0x263046['sendPaymentNotification'](_0x488d68[_0x5c8763(0x1bf)],_0x488d68,_0x103fb0);}catch(_0x83d438){console[_0x5c8763(0x187)](_0x5c8763(0x1d1),_0x83d438);}}}exports[a8_0x4059ec(0x1f8)]=PaymentController;function a8_0x382f(){const _0x1514d2=['paymentService','get','paymentMethod','Payment\x20status\x20is\x20','../services/paymentLinkService','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','MasterCard\x20webhook\x20sent\x20to\x20','💳\x20MasterCard\x20URLs:','status','update','email','processMasterCardPayment','Error\x20parsing\x20webhook\x20events:','error','4989390WxewSU','last_name','📈\x20MasterCard\x20payment\x20','customerEmail','findUnique','defineProperty','sendShopWebhook','updatedAt','includes','writable','__importDefault','webhookService','cardLast4','84486aPrDUV','1341TTwaus','amount','customerIp','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','customerCountry','gateway_payment_id','application/json','payment','webhookEvents','💳\x20MasterCard\x20result:','__esModule','json','💳\x20Processing\x20MasterCard\x20payment:\x20','create','first_name','__createBinding','20tQBFMC','PaymentService','toISOString','resolve','paid','__setModuleDefault','sendPaymentStatusNotification','number','../services/webhookService','paidAt','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','Payment\x20processed\x20successfully','masterCardService','body','length','\x20\x20\x20Return\x20URL:\x20','494855qSUEFL','mastercard_','settings','💳\x20Browser\x20IP:\x20','webhookUrl','createPublicPayment','📝\x20Customer\x20data:','log','14574pfmaFQ','shopId','gateway','401126TFYMmt','threeds_url','customerUa','requires_3ds','POST','payment.success','default','failUrl','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','gatewayOrderId','now','currency','\x20processed:\x20','failureMessage','mastercard','💳\x20Card\x20holder:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','getOwnPropertyDescriptor','gatewayPaymentId','PENDING','prototype','Payment\x20created\x20successfully','544OHFDtj','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','failed','3DS\x20verification\x20required','getPaymentById','createdAt','322qIpyyH','final','FAILED','1111','PAID','updatePaymentCustomer','MasterCardService','shop','Webhook\x20event\x20','Payment\x20not\x20found','ms)','\x20\x20\x20Result\x20URL\x20(webhook):\x20','then',',\x20cannot\x20process','parse','../config/database','toLowerCase','customerName','updatePaymentCustomerDataPublic','../services/telegramBotService','params','stringify','222350cdSBvJ','processCardPayment','\x20with\x20status\x20','replace','system','PaymentController','configurable'];a8_0x382f=function(){return _0x1514d2;};return a8_0x382f();}