'use strict';const a8_0x46bdfa=a8_0x1fa1;(function(_0x18c46c,_0x4062f4){const _0x5b4f01=a8_0x1fa1,_0x9ea845=_0x18c46c();while(!![]){try{const _0xbb5914=-parseInt(_0x5b4f01(0x152))/0x1+-parseInt(_0x5b4f01(0x19b))/0x2*(parseInt(_0x5b4f01(0x1bd))/0x3)+-parseInt(_0x5b4f01(0x17c))/0x4*(-parseInt(_0x5b4f01(0x186))/0x5)+-parseInt(_0x5b4f01(0x149))/0x6+-parseInt(_0x5b4f01(0x1aa))/0x7+-parseInt(_0x5b4f01(0x141))/0x8*(parseInt(_0x5b4f01(0x1b0))/0x9)+parseInt(_0x5b4f01(0x155))/0xa*(parseInt(_0x5b4f01(0x198))/0xb);if(_0xbb5914===_0x4062f4)break;else _0x9ea845['push'](_0x9ea845['shift']());}catch(_0x35c39d){_0x9ea845['push'](_0x9ea845['shift']());}}}(a8_0x5ced,0x486af));var __createBinding=this&&this[a8_0x46bdfa(0x16b)]||(Object[a8_0x46bdfa(0x184)]?function(_0x388bd5,_0x3ee128,_0x2bc763,_0x13cf6b){const _0x4a8197=a8_0x46bdfa;if(_0x13cf6b===undefined)_0x13cf6b=_0x2bc763;var _0x4bbcc5=Object[_0x4a8197(0x19e)](_0x3ee128,_0x2bc763);(!_0x4bbcc5||(_0x4a8197(0x1af)in _0x4bbcc5?!_0x3ee128[_0x4a8197(0x157)]:_0x4bbcc5['writable']||_0x4bbcc5[_0x4a8197(0x153)]))&&(_0x4bbcc5={'enumerable':!![],'get':function(){return _0x3ee128[_0x2bc763];}}),Object[_0x4a8197(0x1b3)](_0x388bd5,_0x13cf6b,_0x4bbcc5);}:function(_0x5db358,_0x3f06cd,_0x1239c4,_0x3a9192){if(_0x3a9192===undefined)_0x3a9192=_0x1239c4;_0x5db358[_0x3a9192]=_0x3f06cd[_0x1239c4];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x46bdfa(0x184)]?function(_0x25a92c,_0x57fb54){const _0x20cc84=a8_0x46bdfa;Object[_0x20cc84(0x1b3)](_0x25a92c,_0x20cc84(0x1be),{'enumerable':!![],'value':_0x57fb54});}:function(_0x2afd2a,_0x3137c3){const _0xf46f54=a8_0x46bdfa;_0x2afd2a[_0xf46f54(0x1be)]=_0x3137c3;}),__importStar=this&&this[a8_0x46bdfa(0x172)]||(function(){var _0x4cb10f=function(_0x56e170){return _0x4cb10f=Object['getOwnPropertyNames']||function(_0x43c905){const _0x4eab8a=a8_0x1fa1;var _0x3281d=[];for(var _0x512d1f in _0x43c905)if(Object[_0x4eab8a(0x19c)][_0x4eab8a(0x1ab)][_0x4eab8a(0x162)](_0x43c905,_0x512d1f))_0x3281d[_0x3281d[_0x4eab8a(0x15d)]]=_0x512d1f;return _0x3281d;},_0x4cb10f(_0x56e170);};return function(_0x46dab5){const _0x34a661=a8_0x1fa1;if(_0x46dab5&&_0x46dab5[_0x34a661(0x157)])return _0x46dab5;var _0x1d7c10={};if(_0x46dab5!=null){for(var _0x35d5ae=_0x4cb10f(_0x46dab5),_0x46f750=0x0;_0x46f750<_0x35d5ae[_0x34a661(0x15d)];_0x46f750++)if(_0x35d5ae[_0x46f750]!==_0x34a661(0x1be))__createBinding(_0x1d7c10,_0x46dab5,_0x35d5ae[_0x46f750]);}return __setModuleDefault(_0x1d7c10,_0x46dab5),_0x1d7c10;};}()),__importDefault=this&&this['__importDefault']||function(_0x196837){const _0x3fcd93=a8_0x46bdfa;return _0x196837&&_0x196837[_0x3fcd93(0x157)]?_0x196837:{'default':_0x196837};};Object[a8_0x46bdfa(0x1b3)](exports,'__esModule',{'value':!![]}),exports[a8_0x46bdfa(0x1ba)]=void 0x0;const paymentService_1=require(a8_0x46bdfa(0x156)),mastercardService_1=require(a8_0x46bdfa(0x179)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x46bdfa(0x14d)));function a8_0x5ced(){const _0x942b1f=['defineProperty','number','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','webhookEvents','toLowerCase','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','\x20not\x20enabled\x20for\x20shop\x20','PaymentController','error','email','3ynyQUE','default','settings','mastercard_','json','shopId','8AxSlow','💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','../services/paymentLinkService','\x20with\x20status\x20','body','sendPaymentStatusNotification','createPublicPayment','sendPaymentNotification','61866AxECfc','Webhook\x20event\x20','amount','replace','../config/database','update','../services/telegramBotService','final','system','47721kMUvWE','configurable','gateway_payment_id','9712030KOFeSV','../services/paymentService','__esModule','Card\x20payment\x20failed','handleSuccessfulPayment','Error\x20parsing\x20webhook\x20events:','📈\x20MasterCard\x20payment\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','length','getPaymentById','orderId','✅\x20MasterCard\x20payment\x20','log','call','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','user_agent','gatewayOrderId','parse','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','failed','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','💳\x20Card\x20holder:\x20','__createBinding','processMasterCardPayment','requires_3ds','resolve',',\x20cannot\x20process','slice','sendShopWebhook','__importStar','PAID','Customer\x20data\x20updated\x20successfully','successUrl','status','webhookService','first_name','../services/gateways/mastercardService','webhookUrl','Payment\x20failed','60012Vqrfgu','MasterCardService','POST','stringify','toISOString','Payment\x20processed\x20successfully','currency','💳\x20MasterCard\x20URLs:','create','updatePaymentCustomer','5aYbBYD','WebhookService','📝\x20Customer\x20data:','then','💳\x20MasterCard\x20result:','mastercard','findUnique','customerIp','PENDING','last_name','webhookLog','customerUa','isArray','Payment\x20created\x20successfully','threeds_url','ms)','PaymentService','failUrl','11JhJfNj','gatewayPaymentId','1111','615610sKLLeq','prototype','masterCardService','getOwnPropertyDescriptor','getPaymentStatus','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','FAILED','💳\x20Processing\x20MasterCard\x20payment:\x20','payment','params','cardLast4','Payment\x20not\x20found','customerEmail','updatedAt','\x20processed:\x20','1918728prOTUS','hasOwnProperty','paymentService','gateway','Payment\x20status\x20is\x20','get','446778uBPExW','\x20\x20\x20Return\x20URL:\x20','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'];a8_0x5ced=function(){return _0x942b1f;};return a8_0x5ced();}class PaymentController{constructor(){const _0x1fc987=a8_0x46bdfa;this['createPublicPayment']=async(_0x5a14a1,_0x540ea0,_0x11b4c0)=>{const _0x3ff8dc=a8_0x1fa1;try{const _0x4ec18d=_0x5a14a1[_0x3ff8dc(0x145)],_0x1e1add=await this['paymentService'][_0x3ff8dc(0x147)](_0x4ec18d);_0x540ea0['status'](0xc9)[_0x3ff8dc(0x13f)]({'success':!![],'message':_0x3ff8dc(0x193),'result':_0x1e1add});}catch(_0x42763e){_0x11b4c0(_0x42763e);}},this[_0x1fc987(0x19f)]=async(_0x1695d5,_0x413b5c,_0x3c6e36)=>{const _0x78a9b3=_0x1fc987;try{const {id:_0x1b6cf5}=_0x1695d5[_0x78a9b3(0x1a4)],_0x626739=await this['paymentService'][_0x78a9b3(0x19f)](_0x1b6cf5);if(!_0x626739)return _0x413b5c['status'](0x194)[_0x78a9b3(0x13f)]({'success':![],'message':_0x78a9b3(0x1a6)});_0x413b5c[_0x78a9b3(0x13f)]({'success':!![],'result':_0x626739});}catch(_0xa2b0c4){_0x3c6e36(_0xa2b0c4);}},this[_0x1fc987(0x15e)]=async(_0x506c33,_0x347bec,_0x5f0174)=>{const _0x5317d3=_0x1fc987;try{const {id:_0xd6e4a1}=_0x506c33[_0x5317d3(0x1a4)],_0x12e421=await this[_0x5317d3(0x1ac)][_0x5317d3(0x15e)](_0xd6e4a1);if(!_0x12e421)return _0x347bec[_0x5317d3(0x176)](0x194)[_0x5317d3(0x13f)]({'success':![],'message':_0x5317d3(0x1a6)});_0x347bec[_0x5317d3(0x13f)]({'success':!![],'result':_0x12e421});}catch(_0x313a54){_0x5f0174(_0x313a54);}},this[_0x1fc987(0x185)]=async(_0x25ed97,_0x3d1d9c,_0x286bb9)=>{const _0xd668ca=_0x1fc987;try{const {id:_0x2f3a41}=_0x25ed97[_0xd668ca(0x1a4)],_0x5df49b=_0x25ed97['body'];console[_0xd668ca(0x161)](_0xd668ca(0x1b5)+_0x2f3a41),console['log'](_0xd668ca(0x188),_0x5df49b);const _0x24c144=await this[_0xd668ca(0x1ac)]['updatePaymentCustomerDataPublic'](_0x2f3a41,_0x5df49b);if(!_0x24c144)return _0x3d1d9c['status'](0x194)[_0xd668ca(0x13f)]({'success':![],'message':_0xd668ca(0x1a6)});_0x3d1d9c['json']({'success':!![],'message':_0xd668ca(0x174),'result':{'paymentId':_0x24c144['id'],'customerIp':_0x24c144[_0xd668ca(0x18d)],'customerUa':_0x24c144[_0xd668ca(0x191)],'customerCountry':_0x24c144['customerCountry'],'updatedAt':_0x24c144[_0xd668ca(0x1a8)]}});}catch(_0x92b04d){_0x286bb9(_0x92b04d);}},this[_0x1fc987(0x16c)]=async(_0x8d6c3,_0x568aad,_0x554506)=>{const _0x1dbbdf=_0x1fc987;try{const {id:_0x5406db}=_0x8d6c3[_0x1dbbdf(0x1a4)],{cardData:_0xa7e8e9,cardHolder:_0x5bb3b2,browser:_0x14cd64}=_0x8d6c3[_0x1dbbdf(0x145)];console['log'](_0x1dbbdf(0x1a2)+_0x5406db),console[_0x1dbbdf(0x161)](_0x1dbbdf(0x16a)+_0x5bb3b2[_0x1dbbdf(0x178)]+'\x20'+_0x5bb3b2[_0x1dbbdf(0x18f)]+'\x20('+_0x5bb3b2[_0x1dbbdf(0x1bc)]+')'),console['log']('💳\x20Browser\x20IP:\x20'+_0x14cd64['ip']);const _0x4a4c4c={'customerName':_0x5bb3b2[_0x1dbbdf(0x178)]+'\x20'+_0x5bb3b2[_0x1dbbdf(0x18f)],'customerEmail':_0x5bb3b2[_0x1dbbdf(0x1bc)],'customerIp':_0x14cd64['ip'],'customerUa':_0x14cd64[_0x1dbbdf(0x164)]},_0x42916d=await database_1[_0x1dbbdf(0x1be)][_0x1dbbdf(0x1a3)][_0x1dbbdf(0x18c)]({'where':{'id':_0x5406db},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x42916d)return _0x568aad[_0x1dbbdf(0x176)](0x194)[_0x1dbbdf(0x13f)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x42916d[_0x1dbbdf(0x1ad)]!==_0x1dbbdf(0x18b))return _0x568aad['status'](0x190)[_0x1dbbdf(0x13f)]({'success':![],'message':_0x1dbbdf(0x1b8)});if(_0x42916d[_0x1dbbdf(0x176)]!==_0x1dbbdf(0x18e))return _0x568aad[_0x1dbbdf(0x176)](0x190)[_0x1dbbdf(0x13f)]({'success':![],'message':_0x1dbbdf(0x1ae)+_0x42916d[_0x1dbbdf(0x176)]+_0x1dbbdf(0x16f)});await database_1[_0x1dbbdf(0x1be)][_0x1dbbdf(0x1a3)][_0x1dbbdf(0x14e)]({'where':{'id':_0x5406db},'data':{..._0x4a4c4c,'updatedAt':new Date()}});const _0x566f25='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x296935=_0x42916d[_0x1dbbdf(0x175)];console[_0x1dbbdf(0x161)](_0x1dbbdf(0x183)),console[_0x1dbbdf(0x161)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x566f25),console[_0x1dbbdf(0x161)](_0x1dbbdf(0x1b1)+_0x296935);const _0x47fb8f={'first_name':_0x5bb3b2[_0x1dbbdf(0x178)],'last_name':_0x5bb3b2[_0x1dbbdf(0x18f)],'email':_0x5bb3b2[_0x1dbbdf(0x1bc)]},_0x4d6d15=await this[_0x1dbbdf(0x19d)]['processCardPayment']({'paymentId':_0x42916d['id'],'orderId':_0x42916d['gatewayOrderId']||_0x42916d['id'],'amount':_0x42916d[_0x1dbbdf(0x14b)],'currency':_0x42916d[_0x1dbbdf(0x182)],'cardData':_0xa7e8e9,'resultUrl':_0x566f25,'returnUrl':_0x296935,'cardHolder':_0x47fb8f,'browser':_0x14cd64});console['log'](_0x1dbbdf(0x18a),_0x4d6d15);const _0x51c37b={'status':_0x4d6d15[_0x1dbbdf(0x176)],'updatedAt':new Date(),'statusChangedBy':_0x1dbbdf(0x151),'statusChangedAt':new Date()};_0x4d6d15[_0x1dbbdf(0x154)]&&(_0x51c37b[_0x1dbbdf(0x199)]=_0x4d6d15[_0x1dbbdf(0x154)],console[_0x1dbbdf(0x161)](_0x1dbbdf(0x142)+_0x4d6d15['gateway_payment_id']));if(_0x4d6d15[_0x1dbbdf(0x176)]==='PAID')_0x51c37b['paidAt']=new Date();else _0x4d6d15[_0x1dbbdf(0x176)]===_0x1dbbdf(0x1a1)&&(_0x51c37b['failureMessage']=_0x1dbbdf(0x158));_0x51c37b['paymentMethod']=_0x1dbbdf(0x18b);if(_0xa7e8e9['number']){const _0x2450c2=_0xa7e8e9[_0x1dbbdf(0x1b4)][_0x1dbbdf(0x14c)](/[\s-]/g,'');_0x51c37b[_0x1dbbdf(0x1a5)]=_0x2450c2[_0x1dbbdf(0x170)](-0x4),console[_0x1dbbdf(0x161)](_0x1dbbdf(0x1b2)+_0x51c37b[_0x1dbbdf(0x1a5)]);}await database_1['default'][_0x1dbbdf(0x1a3)][_0x1dbbdf(0x14e)]({'where':{'id':_0x42916d['id']},'data':_0x51c37b}),await database_1[_0x1dbbdf(0x1be)][_0x1dbbdf(0x190)]['create']({'data':{'paymentId':_0x42916d['id'],'shopId':_0x42916d[_0x1dbbdf(0x140)],'event':_0x1dbbdf(0x13e)+_0x4d6d15[_0x1dbbdf(0x176)]?.[_0x1dbbdf(0x1b7)](),'statusCode':0xc8,'responseBody':JSON[_0x1dbbdf(0x17f)]({'oldStatus':_0x1dbbdf(0x18e),'newStatus':_0x4d6d15['status'],'gatewayPaymentId':_0x4d6d15[_0x1dbbdf(0x154)],'requires3ds':_0x4d6d15[_0x1dbbdf(0x16d)],'processedAt':new Date()[_0x1dbbdf(0x180)]()})}});if(_0x4d6d15[_0x1dbbdf(0x150)]){await this[_0x1dbbdf(0x171)](_0x42916d,_0x4d6d15['status'],_0x4d6d15[_0x1dbbdf(0x154)]),await this[_0x1dbbdf(0x146)](_0x42916d,_0x4d6d15[_0x1dbbdf(0x176)]);if(_0x4d6d15['status']===_0x1dbbdf(0x173)){console['log'](_0x1dbbdf(0x15b)+_0x5406db+_0x1dbbdf(0x1a0));try{const {PaymentLinkService:_0x25d060}=await Promise[_0x1dbbdf(0x16e)]()[_0x1dbbdf(0x189)](()=>__importStar(require(_0x1dbbdf(0x143)))),_0x14a660=new _0x25d060();await _0x14a660[_0x1dbbdf(0x159)](_0x5406db),console[_0x1dbbdf(0x161)]('✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20'+_0x5406db);}catch(_0x214ade){console[_0x1dbbdf(0x1bb)](_0x1dbbdf(0x163),_0x214ade);}}}console[_0x1dbbdf(0x161)](_0x1dbbdf(0x160)+_0x5406db+_0x1dbbdf(0x1a9)+_0x4d6d15[_0x1dbbdf(0x176)]);if(_0x4d6d15[_0x1dbbdf(0x176)]===_0x1dbbdf(0x173))_0x568aad[_0x1dbbdf(0x13f)]({'success':!![],'message':_0x1dbbdf(0x181),'result':{'status':'PAID','gatewayPaymentId':_0x4d6d15[_0x1dbbdf(0x154)],'redirectUrl':_0x296935,'final':!![]}});else _0x4d6d15['requires_3ds']&&_0x4d6d15[_0x1dbbdf(0x194)]?_0x568aad['json']({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x1dbbdf(0x18e),'gatewayPaymentId':_0x4d6d15[_0x1dbbdf(0x154)],'redirectUrl':_0x4d6d15[_0x1dbbdf(0x194)],'requires3ds':!![],'final':![]}}):_0x568aad[_0x1dbbdf(0x176)](0x190)[_0x1dbbdf(0x13f)]({'success':![],'message':_0x1dbbdf(0x17b),'result':{'status':_0x1dbbdf(0x1a1),'gatewayPaymentId':_0x4d6d15[_0x1dbbdf(0x154)],'redirectUrl':_0x42916d[_0x1dbbdf(0x197)],'final':!![]}});}catch(_0x4a0f83){_0x554506(_0x4a0f83);}},this['paymentService']=new paymentService_1[(_0x1fc987(0x196))](),this[_0x1fc987(0x19d)]=new mastercardService_1[(_0x1fc987(0x17d))](),this[_0x1fc987(0x177)]=new webhookService_1[(_0x1fc987(0x187))]();}async[a8_0x46bdfa(0x171)](_0x464495,_0x535aac,_0x9ed38f){const _0x2b660d=a8_0x46bdfa,_0x259d8a=Date['now']();try{const _0x1bf096=_0x464495['shop'],_0x2a5fa3=_0x1bf096[_0x2b660d(0x13d)];if(!_0x2a5fa3?.[_0x2b660d(0x17a)]){console[_0x2b660d(0x161)](_0x2b660d(0x167)+_0x1bf096['id']);return;}const _0x103e03=_0x535aac===_0x2b660d(0x173)?'payment.success':'payment.failed';let _0x2711f0=[];if(_0x2a5fa3[_0x2b660d(0x1b6)])try{_0x2711f0=Array[_0x2b660d(0x192)](_0x2a5fa3[_0x2b660d(0x1b6)])?_0x2a5fa3[_0x2b660d(0x1b6)]:JSON[_0x2b660d(0x166)](_0x2a5fa3[_0x2b660d(0x1b6)]);}catch(_0x3d08d2){console['error'](_0x2b660d(0x15a),_0x3d08d2),_0x2711f0=[];}if(!_0x2711f0['includes'](_0x103e03)){console[_0x2b660d(0x161)](_0x2b660d(0x14a)+_0x103e03+_0x2b660d(0x1b9)+_0x1bf096['id']);return;}const _0x17cd87={'event':_0x103e03,'payment':{'id':_0x464495['id'],'order_id':_0x464495[_0x2b660d(0x15f)],'gateway_order_id':_0x464495[_0x2b660d(0x165)],'gateway':_0x2b660d(0x19a),'amount':_0x464495[_0x2b660d(0x14b)],'currency':_0x464495['currency'],'status':_0x535aac[_0x2b660d(0x1b7)](),'customer_email':_0x464495[_0x2b660d(0x1a7)],'customer_name':_0x464495['customerName'],'gateway_payment_id':_0x9ed38f,'created_at':_0x464495['createdAt'],'updated_at':new Date()}},_0x46db50=await fetch(_0x2a5fa3[_0x2b660d(0x17a)],{'method':_0x2b660d(0x17e),'headers':{'Content-Type':'application/json','User-Agent':_0x2b660d(0x169)},'body':JSON[_0x2b660d(0x17f)](_0x17cd87)}),_0x1d2c62=Date['now']()-_0x259d8a;console[_0x2b660d(0x161)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x2a5fa3[_0x2b660d(0x17a)]+_0x2b660d(0x144)+_0x46db50[_0x2b660d(0x176)]+'\x20('+_0x1d2c62+_0x2b660d(0x195));}catch(_0x46ee43){console['error'](_0x2b660d(0x15c),_0x46ee43);}}async[a8_0x46bdfa(0x146)](_0x240cf5,_0xd2587f){const _0x621bbd=a8_0x46bdfa;try{const {telegramBotService:_0x46744a}=await Promise[_0x621bbd(0x16e)]()[_0x621bbd(0x189)](()=>__importStar(require(_0x621bbd(0x14f)))),_0x3e8351={'PAID':'paid','FAILED':_0x621bbd(0x168)},_0x1eccbe=_0x3e8351[_0xd2587f];if(!_0x1eccbe)return;await _0x46744a[_0x621bbd(0x148)](_0x240cf5[_0x621bbd(0x140)],_0x240cf5,_0x1eccbe);}catch(_0xe4ac38){console[_0x621bbd(0x1bb)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xe4ac38);}}}function a8_0x1fa1(_0x5d96c1,_0x3d6255){const _0x5ced5f=a8_0x5ced();return a8_0x1fa1=function(_0x1fa164,_0x5bfd1b){_0x1fa164=_0x1fa164-0x13d;let _0x36c3a6=_0x5ced5f[_0x1fa164];return _0x36c3a6;},a8_0x1fa1(_0x5d96c1,_0x3d6255);}exports['PaymentController']=PaymentController;