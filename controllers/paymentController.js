'use strict';function a8_0x5ea8(){const _0xbb7224=['shopId','currency','toLowerCase','paidAt','email','paymentService','body','params','MasterCard\x20webhook\x20sent\x20to\x20','üìù\x20Customer\x20data:','üí≥\x20MasterCard\x20URLs:','parse','Payment\x20processed\x20successfully','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','webhookLog','sendPaymentNotification','104FPbRAS','handleSuccessfulPayment','\x20not\x20enabled\x20for\x20shop\x20','getPaymentById','stringify','PAID','findUnique','../services/gateways/mastercardService','gateway','updatePaymentCustomer','../services/telegramBotService','üí≥\x20Card\x20holder:\x20','customerIp','json','../config/database','__esModule','__importDefault','\x20processed:\x20','gatewayPaymentId','number','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','‚úÖ\x20MasterCard\x20payment\x20','MasterCardService','üìà\x20MasterCard\x20payment\x20','webhookEvents','2511600axisVk','POST','Payment\x20created\x20successfully','FAILED','then','resolve','customerUa','orderId','get','default','toISOString','Customer\x20data\x20updated\x20successfully','requires_3ds','update','Card\x20payment\x20failed','üí≥\x20Processing\x20MasterCard\x20payment:\x20','97181TdKXqY','now','\x20\x20\x20Return\x20URL:\x20','final','webhookService','masterCardService','Failed\x20to\x20send\x20MasterCard\x20webhook:','getOwnPropertyNames','updatePaymentCustomerDataPublic','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','paymentMethod','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','first_name','status','paid','604868QaUUQJ','log','https://api.trapay.uk/api/webhooks/gateway/mastercard','mastercard','3DS\x20verification\x20required','sendShopWebhook','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','includes','2743674MEWxRe','last_name','gateway_payment_id','configurable','Webhook\x20event\x20','customerCountry','replace','PENDING','4846164SOaaOB','Payment\x20not\x20found','../services/webhookService','updatedAt','amount','5AxEriK','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','webhookUrl','user_agent','slice',',\x20cannot\x20process','Error\x20parsing\x20webhook\x20events:','payment','Payment\x20status\x20is\x20','processMasterCardPayment','application/json','failed','Payment\x20failed','failureMessage','length','\x20\x20\x20Result\x20URL\x20(webhook):\x20','shop','gatewayOrderId','16681230mPVAKw','customerName','getPaymentStatus','error','defineProperty','cardLast4','6979GEHfed','__importStar','createPublicPayment','threeds_url','create','PaymentController','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','system'];a8_0x5ea8=function(){return _0xbb7224;};return a8_0x5ea8();}const a8_0x39e508=a8_0x301d;(function(_0xab53bd,_0x6345b3){const _0x454c10=a8_0x301d,_0x53abd9=_0xab53bd();while(!![]){try{const _0x58d37e=-parseInt(_0x454c10(0x150))/0x1+-parseInt(_0x454c10(0x15f))/0x2+parseInt(_0x454c10(0x140))/0x3+parseInt(_0x454c10(0x16f))/0x4*(-parseInt(_0x454c10(0x174))/0x5)+-parseInt(_0x454c10(0x167))/0x6+parseInt(_0x454c10(0x10f))/0x7*(parseInt(_0x454c10(0x127))/0x8)+parseInt(_0x454c10(0x186))/0x9;if(_0x58d37e===_0x6345b3)break;else _0x53abd9['push'](_0x53abd9['shift']());}catch(_0x35ce68){_0x53abd9['push'](_0x53abd9['shift']());}}}(a8_0x5ea8,0x9b13c));function a8_0x301d(_0xdcb356,_0x300552){const _0x5ea8ff=a8_0x5ea8();return a8_0x301d=function(_0x301d16,_0x337bfc){_0x301d16=_0x301d16-0x10e;let _0x15f3ce=_0x5ea8ff[_0x301d16];return _0x15f3ce;},a8_0x301d(_0xdcb356,_0x300552);}var __createBinding=this&&this['__createBinding']||(Object[a8_0x39e508(0x113)]?function(_0x1572eb,_0x43338b,_0x5bfe47,_0x42cb00){const _0x3a200e=a8_0x39e508;if(_0x42cb00===undefined)_0x42cb00=_0x5bfe47;var _0x1ad7ef=Object['getOwnPropertyDescriptor'](_0x43338b,_0x5bfe47);(!_0x1ad7ef||(_0x3a200e(0x148)in _0x1ad7ef?!_0x43338b['__esModule']:_0x1ad7ef['writable']||_0x1ad7ef[_0x3a200e(0x16a)]))&&(_0x1ad7ef={'enumerable':!![],'get':function(){return _0x43338b[_0x5bfe47];}}),Object['defineProperty'](_0x1572eb,_0x42cb00,_0x1ad7ef);}:function(_0x25be78,_0x27890f,_0x1a411c,_0x383778){if(_0x383778===undefined)_0x383778=_0x1a411c;_0x25be78[_0x383778]=_0x27890f[_0x1a411c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x39e508(0x113)]?function(_0x5a1e29,_0x1c9b51){const _0x352ac9=a8_0x39e508;Object[_0x352ac9(0x18a)](_0x5a1e29,_0x352ac9(0x149),{'enumerable':!![],'value':_0x1c9b51});}:function(_0x20c6e1,_0xac7df4){const _0x4e1938=a8_0x39e508;_0x20c6e1[_0x4e1938(0x149)]=_0xac7df4;}),__importStar=this&&this[a8_0x39e508(0x110)]||(function(){var _0x2c8be7=function(_0x5a3ee0){const _0x409650=a8_0x301d;return _0x2c8be7=Object[_0x409650(0x157)]||function(_0x2c4aff){var _0xe75df8=[];for(var _0x4711a7 in _0x2c4aff)if(Object['prototype']['hasOwnProperty']['call'](_0x2c4aff,_0x4711a7))_0xe75df8[_0xe75df8['length']]=_0x4711a7;return _0xe75df8;},_0x2c8be7(_0x5a3ee0);};return function(_0x1d7829){const _0x7a1ff3=a8_0x301d;if(_0x1d7829&&_0x1d7829[_0x7a1ff3(0x136)])return _0x1d7829;var _0x235acc={};if(_0x1d7829!=null){for(var _0x587275=_0x2c8be7(_0x1d7829),_0x2b5dd7=0x0;_0x2b5dd7<_0x587275[_0x7a1ff3(0x182)];_0x2b5dd7++)if(_0x587275[_0x2b5dd7]!==_0x7a1ff3(0x149))__createBinding(_0x235acc,_0x1d7829,_0x587275[_0x2b5dd7]);}return __setModuleDefault(_0x235acc,_0x1d7829),_0x235acc;};}()),__importDefault=this&&this[a8_0x39e508(0x137)]||function(_0x45e5d2){const _0x5dcae8=a8_0x39e508;return _0x45e5d2&&_0x45e5d2[_0x5dcae8(0x136)]?_0x45e5d2:{'default':_0x45e5d2};};Object[a8_0x39e508(0x18a)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x39e508(0x12e)),webhookService_1=require(a8_0x39e508(0x171)),database_1=__importDefault(require(a8_0x39e508(0x135)));class PaymentController{constructor(){const _0x57f9ac=a8_0x39e508;this[_0x57f9ac(0x111)]=async(_0x582ce8,_0x36175,_0x1f0739)=>{const _0x4b1def=_0x57f9ac;try{const _0x3e7a42=_0x582ce8[_0x4b1def(0x11d)],_0x75bf72=await this[_0x4b1def(0x11c)][_0x4b1def(0x111)](_0x3e7a42);_0x36175[_0x4b1def(0x15d)](0xc9)[_0x4b1def(0x134)]({'success':!![],'message':_0x4b1def(0x142),'result':_0x75bf72});}catch(_0x1e8485){_0x1f0739(_0x1e8485);}},this['getPaymentStatus']=async(_0x497c86,_0x39eb14,_0x133907)=>{const _0x492cf2=_0x57f9ac;try{const {id:_0x3b4fe2}=_0x497c86[_0x492cf2(0x11e)],_0x4b5999=await this[_0x492cf2(0x11c)][_0x492cf2(0x188)](_0x3b4fe2);if(!_0x4b5999)return _0x39eb14[_0x492cf2(0x15d)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x39eb14[_0x492cf2(0x134)]({'success':!![],'result':_0x4b5999});}catch(_0x5116cc){_0x133907(_0x5116cc);}},this[_0x57f9ac(0x12a)]=async(_0x52f750,_0x52d9c8,_0x27356b)=>{const _0xa5a75f=_0x57f9ac;try{const {id:_0x42a906}=_0x52f750[_0xa5a75f(0x11e)],_0x260522=await this[_0xa5a75f(0x11c)][_0xa5a75f(0x12a)](_0x42a906);if(!_0x260522)return _0x52d9c8['status'](0x194)['json']({'success':![],'message':_0xa5a75f(0x170)});_0x52d9c8[_0xa5a75f(0x134)]({'success':!![],'result':_0x260522});}catch(_0x4fb0cb){_0x27356b(_0x4fb0cb);}},this[_0x57f9ac(0x130)]=async(_0xc4c482,_0x2a2eb7,_0x5934ac)=>{const _0x33c49c=_0x57f9ac;try{const {id:_0x5ef3c9}=_0xc4c482[_0x33c49c(0x11e)],_0x3db766=_0xc4c482[_0x33c49c(0x11d)];console[_0x33c49c(0x160)](_0x33c49c(0x175)+_0x5ef3c9),console[_0x33c49c(0x160)](_0x33c49c(0x120),_0x3db766);const _0x521a8c=await this[_0x33c49c(0x11c)][_0x33c49c(0x158)](_0x5ef3c9,_0x3db766);if(!_0x521a8c)return _0x2a2eb7[_0x33c49c(0x15d)](0x194)['json']({'success':![],'message':_0x33c49c(0x170)});_0x2a2eb7['json']({'success':!![],'message':_0x33c49c(0x14b),'result':{'paymentId':_0x521a8c['id'],'customerIp':_0x521a8c[_0x33c49c(0x133)],'customerUa':_0x521a8c[_0x33c49c(0x146)],'customerCountry':_0x521a8c[_0x33c49c(0x16c)],'updatedAt':_0x521a8c[_0x33c49c(0x172)]}});}catch(_0x5e53d8){_0x5934ac(_0x5e53d8);}},this[_0x57f9ac(0x17d)]=async(_0x4dd5ca,_0x343e9f,_0x178ef9)=>{const _0x42fc40=_0x57f9ac;try{const {id:_0x29a47f}=_0x4dd5ca[_0x42fc40(0x11e)],{cardData:_0x3fe7ad,cardHolder:_0x49ad74,browser:_0x20fe7f}=_0x4dd5ca[_0x42fc40(0x11d)];console[_0x42fc40(0x160)](_0x42fc40(0x14f)+_0x29a47f),console[_0x42fc40(0x160)](_0x42fc40(0x132)+_0x49ad74['first_name']+'\x20'+_0x49ad74[_0x42fc40(0x168)]+'\x20('+_0x49ad74['email']+')'),console[_0x42fc40(0x160)]('üí≥\x20Browser\x20IP:\x20'+_0x20fe7f['ip']);const _0x375e34={'customerName':_0x49ad74['first_name']+'\x20'+_0x49ad74[_0x42fc40(0x168)],'customerEmail':_0x49ad74[_0x42fc40(0x11b)],'customerIp':_0x20fe7f['ip'],'customerUa':_0x20fe7f[_0x42fc40(0x177)]},_0x3df393=await database_1[_0x42fc40(0x149)][_0x42fc40(0x17b)][_0x42fc40(0x12d)]({'where':{'id':_0x29a47f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3df393)return _0x343e9f[_0x42fc40(0x15d)](0x194)['json']({'success':![],'message':_0x42fc40(0x170)});if(_0x3df393[_0x42fc40(0x12f)]!==_0x42fc40(0x162))return _0x343e9f[_0x42fc40(0x15d)](0x190)[_0x42fc40(0x134)]({'success':![],'message':_0x42fc40(0x124)});if(_0x3df393[_0x42fc40(0x15d)]!==_0x42fc40(0x16e))return _0x343e9f[_0x42fc40(0x15d)](0x190)[_0x42fc40(0x134)]({'success':![],'message':_0x42fc40(0x17c)+_0x3df393[_0x42fc40(0x15d)]+_0x42fc40(0x179)});await database_1['default'][_0x42fc40(0x17b)]['update']({'where':{'id':_0x29a47f},'data':{..._0x375e34,'updatedAt':new Date()}});const _0x349b62=_0x42fc40(0x161),_0x12870b=_0x3df393['successUrl'];console[_0x42fc40(0x160)](_0x42fc40(0x121)),console[_0x42fc40(0x160)](_0x42fc40(0x183)+_0x349b62),console[_0x42fc40(0x160)](_0x42fc40(0x152)+_0x12870b);const _0x99b549={'first_name':_0x49ad74[_0x42fc40(0x15c)],'last_name':_0x49ad74[_0x42fc40(0x168)],'email':_0x49ad74[_0x42fc40(0x11b)]},_0xcfcf54=await this[_0x42fc40(0x155)]['processCardPayment']({'paymentId':_0x3df393['id'],'orderId':_0x3df393[_0x42fc40(0x185)]||_0x3df393['id'],'amount':_0x3df393[_0x42fc40(0x173)],'currency':_0x3df393['currency'],'cardData':_0x3fe7ad,'resultUrl':_0x349b62,'returnUrl':_0x12870b,'cardHolder':_0x99b549,'browser':_0x20fe7f});console[_0x42fc40(0x160)]('üí≥\x20MasterCard\x20result:',_0xcfcf54);const _0x2d2bb5={'status':_0xcfcf54['status'],'updatedAt':new Date(),'statusChangedBy':_0x42fc40(0x116),'statusChangedAt':new Date()};_0xcfcf54[_0x42fc40(0x169)]&&(_0x2d2bb5[_0x42fc40(0x139)]=_0xcfcf54[_0x42fc40(0x169)],console[_0x42fc40(0x160)]('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0xcfcf54[_0x42fc40(0x169)]));if(_0xcfcf54[_0x42fc40(0x15d)]===_0x42fc40(0x12c))_0x2d2bb5[_0x42fc40(0x11a)]=new Date();else _0xcfcf54[_0x42fc40(0x15d)]===_0x42fc40(0x143)&&(_0x2d2bb5[_0x42fc40(0x181)]=_0x42fc40(0x14e));_0x2d2bb5[_0x42fc40(0x15a)]='mastercard';if(_0x3fe7ad[_0x42fc40(0x13a)]){const _0x50ebb2=_0x3fe7ad[_0x42fc40(0x13a)][_0x42fc40(0x16d)](/[\s-]/g,'');_0x2d2bb5[_0x42fc40(0x10e)]=_0x50ebb2[_0x42fc40(0x178)](-0x4),console['log'](_0x42fc40(0x159)+_0x2d2bb5[_0x42fc40(0x10e)]);}await database_1[_0x42fc40(0x149)]['payment'][_0x42fc40(0x14d)]({'where':{'id':_0x3df393['id']},'data':_0x2d2bb5}),await database_1[_0x42fc40(0x149)][_0x42fc40(0x125)][_0x42fc40(0x113)]({'data':{'paymentId':_0x3df393['id'],'shopId':_0x3df393[_0x42fc40(0x117)],'event':'mastercard_'+_0xcfcf54['status']?.[_0x42fc40(0x119)](),'statusCode':0xc8,'responseBody':JSON[_0x42fc40(0x12b)]({'oldStatus':_0x42fc40(0x16e),'newStatus':_0xcfcf54[_0x42fc40(0x15d)],'gatewayPaymentId':_0xcfcf54[_0x42fc40(0x169)],'requires3ds':_0xcfcf54[_0x42fc40(0x14c)],'processedAt':new Date()[_0x42fc40(0x14a)]()})}});if(_0xcfcf54[_0x42fc40(0x153)]){await this[_0x42fc40(0x164)](_0x3df393,_0xcfcf54['status'],_0xcfcf54[_0x42fc40(0x169)]),await this['sendPaymentStatusNotification'](_0x3df393,_0xcfcf54['status']);if(_0xcfcf54[_0x42fc40(0x15d)]===_0x42fc40(0x12c)){console[_0x42fc40(0x160)](_0x42fc40(0x13e)+_0x29a47f+_0x42fc40(0x13b));try{const {PaymentLinkService:_0x5d8ead}=await Promise['resolve']()[_0x42fc40(0x144)](()=>__importStar(require('../services/paymentLinkService'))),_0x4bb6b3=new _0x5d8ead();await _0x4bb6b3[_0x42fc40(0x128)](_0x29a47f),console[_0x42fc40(0x160)](_0x42fc40(0x165)+_0x29a47f);}catch(_0x53eb12){console[_0x42fc40(0x189)](_0x42fc40(0x15b),_0x53eb12);}}}console['log'](_0x42fc40(0x13c)+_0x29a47f+_0x42fc40(0x138)+_0xcfcf54['status']);if(_0xcfcf54[_0x42fc40(0x15d)]===_0x42fc40(0x12c))_0x343e9f[_0x42fc40(0x134)]({'success':!![],'message':_0x42fc40(0x123),'result':{'status':_0x42fc40(0x12c),'gatewayPaymentId':_0xcfcf54[_0x42fc40(0x169)],'redirectUrl':_0x12870b,'final':!![]}});else _0xcfcf54[_0x42fc40(0x14c)]&&_0xcfcf54[_0x42fc40(0x112)]?_0x343e9f[_0x42fc40(0x134)]({'success':!![],'message':_0x42fc40(0x163),'result':{'status':'PENDING','gatewayPaymentId':_0xcfcf54['gateway_payment_id'],'redirectUrl':_0xcfcf54['threeds_url'],'requires3ds':!![],'final':![]}}):_0x343e9f[_0x42fc40(0x15d)](0x190)[_0x42fc40(0x134)]({'success':![],'message':_0x42fc40(0x180),'result':{'status':_0x42fc40(0x143),'gatewayPaymentId':_0xcfcf54[_0x42fc40(0x169)],'redirectUrl':_0x3df393['failUrl'],'final':!![]}});}catch(_0x543c5){_0x178ef9(_0x543c5);}},this['paymentService']=new paymentService_1['PaymentService'](),this[_0x57f9ac(0x155)]=new mastercardService_1[(_0x57f9ac(0x13d))](),this[_0x57f9ac(0x154)]=new webhookService_1['WebhookService']();}async[a8_0x39e508(0x164)](_0x41fb3f,_0x22118f,_0x3a5242){const _0x1cf0af=a8_0x39e508,_0x2cb91b=Date[_0x1cf0af(0x151)]();try{const _0x50faef=_0x41fb3f[_0x1cf0af(0x184)],_0x16d035=_0x50faef['settings'];if(!_0x16d035?.[_0x1cf0af(0x176)]){console['log'](_0x1cf0af(0x115)+_0x50faef['id']);return;}const _0x24425d=_0x22118f===_0x1cf0af(0x12c)?'payment.success':'payment.failed';let _0x177ae7=[];if(_0x16d035[_0x1cf0af(0x13f)])try{_0x177ae7=Array['isArray'](_0x16d035[_0x1cf0af(0x13f)])?_0x16d035[_0x1cf0af(0x13f)]:JSON[_0x1cf0af(0x122)](_0x16d035[_0x1cf0af(0x13f)]);}catch(_0x3235de){console[_0x1cf0af(0x189)](_0x1cf0af(0x17a),_0x3235de),_0x177ae7=[];}if(!_0x177ae7[_0x1cf0af(0x166)](_0x24425d)){console[_0x1cf0af(0x160)](_0x1cf0af(0x16b)+_0x24425d+_0x1cf0af(0x129)+_0x50faef['id']);return;}const _0x1fd0a2={'event':_0x24425d,'payment':{'id':_0x41fb3f['id'],'order_id':_0x41fb3f[_0x1cf0af(0x147)],'gateway_order_id':_0x41fb3f[_0x1cf0af(0x185)],'gateway':'1111','amount':_0x41fb3f[_0x1cf0af(0x173)],'currency':_0x41fb3f[_0x1cf0af(0x118)],'status':_0x22118f[_0x1cf0af(0x119)](),'customer_email':_0x41fb3f['customerEmail'],'customer_name':_0x41fb3f[_0x1cf0af(0x187)],'gateway_payment_id':_0x3a5242,'created_at':_0x41fb3f['createdAt'],'updated_at':new Date()}},_0xc8439d=await fetch(_0x16d035['webhookUrl'],{'method':_0x1cf0af(0x141),'headers':{'Content-Type':_0x1cf0af(0x17e),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x1cf0af(0x12b)](_0x1fd0a2)}),_0x160904=Date[_0x1cf0af(0x151)]()-_0x2cb91b;console[_0x1cf0af(0x160)](_0x1cf0af(0x11f)+_0x16d035[_0x1cf0af(0x176)]+'\x20with\x20status\x20'+_0xc8439d[_0x1cf0af(0x15d)]+'\x20('+_0x160904+'ms)');}catch(_0x631871){console[_0x1cf0af(0x189)](_0x1cf0af(0x156),_0x631871);}}async['sendPaymentStatusNotification'](_0x5dbf8d,_0x41a38c){const _0x27263a=a8_0x39e508;try{const {telegramBotService:_0x38538c}=await Promise[_0x27263a(0x145)]()[_0x27263a(0x144)](()=>__importStar(require(_0x27263a(0x131)))),_0x51d6f6={'PAID':_0x27263a(0x15e),'FAILED':_0x27263a(0x17f)},_0x10ef24=_0x51d6f6[_0x41a38c];if(!_0x10ef24)return;await _0x38538c[_0x27263a(0x126)](_0x5dbf8d[_0x27263a(0x117)],_0x5dbf8d,_0x10ef24);}catch(_0x58f694){console[_0x27263a(0x189)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x58f694);}}}exports[a8_0x39e508(0x114)]=PaymentController;