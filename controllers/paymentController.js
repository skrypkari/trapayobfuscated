'use strict';const a8_0x96c6b0=a8_0x1598;(function(_0x1072d8,_0x53ae01){const _0x5841f2=a8_0x1598,_0x2987d7=_0x1072d8();while(!![]){try{const _0x14e0a2=parseInt(_0x5841f2(0x18f))/0x1+-parseInt(_0x5841f2(0x1be))/0x2+parseInt(_0x5841f2(0x1ac))/0x3*(-parseInt(_0x5841f2(0x17a))/0x4)+parseInt(_0x5841f2(0x178))/0x5*(-parseInt(_0x5841f2(0x1ba))/0x6)+parseInt(_0x5841f2(0x191))/0x7*(-parseInt(_0x5841f2(0x18d))/0x8)+-parseInt(_0x5841f2(0x166))/0x9+parseInt(_0x5841f2(0x19e))/0xa;if(_0x14e0a2===_0x53ae01)break;else _0x2987d7['push'](_0x2987d7['shift']());}catch(_0x142c36){_0x2987d7['push'](_0x2987d7['shift']());}}}(a8_0x1b56,0x8a32f));var __createBinding=this&&this[a8_0x96c6b0(0x186)]||(Object[a8_0x96c6b0(0x1aa)]?function(_0x4555fb,_0x20dc13,_0x1cc2ad,_0x485fc8){const _0x4caaae=a8_0x96c6b0;if(_0x485fc8===undefined)_0x485fc8=_0x1cc2ad;var _0x175cf3=Object[_0x4caaae(0x1a9)](_0x20dc13,_0x1cc2ad);(!_0x175cf3||(_0x4caaae(0x16a)in _0x175cf3?!_0x20dc13[_0x4caaae(0x19f)]:_0x175cf3[_0x4caaae(0x1bc)]||_0x175cf3[_0x4caaae(0x199)]))&&(_0x175cf3={'enumerable':!![],'get':function(){return _0x20dc13[_0x1cc2ad];}}),Object[_0x4caaae(0x185)](_0x4555fb,_0x485fc8,_0x175cf3);}:function(_0x1b869e,_0x52d63f,_0x5404ee,_0x2f9155){if(_0x2f9155===undefined)_0x2f9155=_0x5404ee;_0x1b869e[_0x2f9155]=_0x52d63f[_0x5404ee];}),__setModuleDefault=this&&this[a8_0x96c6b0(0x189)]||(Object['create']?function(_0x158d32,_0x492276){const _0x421744=a8_0x96c6b0;Object[_0x421744(0x185)](_0x158d32,_0x421744(0x164),{'enumerable':!![],'value':_0x492276});}:function(_0x302aee,_0x1624a1){_0x302aee['default']=_0x1624a1;}),__importStar=this&&this[a8_0x96c6b0(0x160)]||(function(){var _0x5c0d4d=function(_0x363edf){return _0x5c0d4d=Object['getOwnPropertyNames']||function(_0x1f3aa5){const _0x30c966=a8_0x1598;var _0x1a02c0=[];for(var _0x5dd5b9 in _0x1f3aa5)if(Object['prototype'][_0x30c966(0x1c7)][_0x30c966(0x17d)](_0x1f3aa5,_0x5dd5b9))_0x1a02c0[_0x1a02c0[_0x30c966(0x198)]]=_0x5dd5b9;return _0x1a02c0;},_0x5c0d4d(_0x363edf);};return function(_0x174087){const _0x3c9266=a8_0x1598;if(_0x174087&&_0x174087[_0x3c9266(0x19f)])return _0x174087;var _0x14fbb0={};if(_0x174087!=null){for(var _0x406815=_0x5c0d4d(_0x174087),_0x3810c5=0x0;_0x3810c5<_0x406815[_0x3c9266(0x198)];_0x3810c5++)if(_0x406815[_0x3810c5]!==_0x3c9266(0x164))__createBinding(_0x14fbb0,_0x174087,_0x406815[_0x3810c5]);}return __setModuleDefault(_0x14fbb0,_0x174087),_0x14fbb0;};}()),__importDefault=this&&this['__importDefault']||function(_0x166926){const _0x1ccadc=a8_0x96c6b0;return _0x166926&&_0x166926[_0x1ccadc(0x19f)]?_0x166926:{'default':_0x166926};};function a8_0x1b56(){const _0x8348c=['requires_3ds','body','toLowerCase','Payment\x20created\x20successfully','webhookUrl','1569965bsFoEH','webhookEvents','2163352IzJikH','WebhookService','stringify','call','https://apitest.trapay.uk/api/webhooks/gateway/mastercard','payment','mastercard','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','payment.failed','MasterCardService','../services/webhookService','defineProperty','__createBinding','Webhook\x20event\x20','PaymentService','__setModuleDefault','processCardPayment','webhookService','paymentService','3139976KRdfMc','shopId','509736qyCOxg','Failed\x20to\x20send\x20MasterCard\x20webhook:','14MDuebV','PAID','createPublicPayment','amount','paid','failureMessage','Payment\x20processed\x20successfully','length','configurable','PaymentController','currency',',\x20cannot\x20process','Payment\x20not\x20found','43077210bSUduY','__esModule','sendShopWebhook','gateway_payment_id','getPaymentById','ms)','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','json','webhookLog','params','createdAt','getOwnPropertyDescriptor','create','error','3cKfnMG','ðŸ’³\x20MasterCard\x20URLs:','1111','threeds_url','toISOString','resolve','gatewayOrderId','\x20\x20\x20Result\x20URL\x20(webhook):\x20','getPaymentStatus','sendPaymentNotification','PENDING','then','paymentMethod','customerName','18IRBnLz','gatewayPaymentId','writable','\x20\x20\x20Return\x20URL:\x20','2058926WItREl','failUrl','3DS\x20verification\x20required','ðŸ’³\x20MasterCard\x20result:','sendPaymentStatusNotification','../services/paymentService','mastercard_','POST','log','hasOwnProperty','now','Card\x20payment\x20failed','update','application/json','Payment\x20status\x20is\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','masterCardService','__importStar','âœ…\x20MasterCard\x20payment\x20','isArray','findUnique','default','paidAt','8587080SeItFo','parse','\x20processed:\x20','failed','get','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','\x20with\x20status\x20','Error\x20parsing\x20webhook\x20events:','FAILED','../services/telegramBotService','shop','status','orderId'];a8_0x1b56=function(){return _0x8348c;};return a8_0x1b56();}Object['defineProperty'](exports,a8_0x96c6b0(0x19f),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x96c6b0(0x1c3)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x96c6b0(0x184)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x2ee192=a8_0x96c6b0;this['createPublicPayment']=async(_0x4423c5,_0x1948dc,_0x39ab2b)=>{const _0x3419ae=a8_0x1598;try{const _0x25ef8a=_0x4423c5[_0x3419ae(0x174)],_0x1471cf=await this[_0x3419ae(0x18c)][_0x3419ae(0x193)](_0x25ef8a);_0x1948dc['status'](0xc9)[_0x3419ae(0x1a5)]({'success':!![],'message':_0x3419ae(0x176),'result':_0x1471cf});}catch(_0x52ece3){_0x39ab2b(_0x52ece3);}},this[_0x2ee192(0x1b4)]=async(_0x5555b4,_0x2a4ee1,_0x3d1575)=>{const _0x4ef801=_0x2ee192;try{const {id:_0x435a5b}=_0x5555b4[_0x4ef801(0x1a7)],_0x49ef4c=await this[_0x4ef801(0x18c)][_0x4ef801(0x1b4)](_0x435a5b);if(!_0x49ef4c)return _0x2a4ee1[_0x4ef801(0x171)](0x194)[_0x4ef801(0x1a5)]({'success':![],'message':_0x4ef801(0x19d)});_0x2a4ee1[_0x4ef801(0x1a5)]({'success':!![],'result':_0x49ef4c});}catch(_0x252d91){_0x3d1575(_0x252d91);}},this[_0x2ee192(0x1a2)]=async(_0x42401e,_0x3bcbe5,_0xb68543)=>{const _0xb02335=_0x2ee192;try{const {id:_0x5141d4}=_0x42401e[_0xb02335(0x1a7)],_0x1a7044=await this[_0xb02335(0x18c)][_0xb02335(0x1a2)](_0x5141d4);if(!_0x1a7044)return _0x3bcbe5[_0xb02335(0x171)](0x194)[_0xb02335(0x1a5)]({'success':![],'message':_0xb02335(0x19d)});_0x3bcbe5[_0xb02335(0x1a5)]({'success':!![],'result':_0x1a7044});}catch(_0x59cfa6){_0xb68543(_0x59cfa6);}},this['processMasterCardPayment']=async(_0xd5c46,_0xf9a769,_0x24554c)=>{const _0x1b8b77=_0x2ee192;try{const {id:_0x459aa2}=_0xd5c46['params'],{cardData:_0x4a743c,cardHolder:_0x56429f,browser:_0x444f2a}=_0xd5c46[_0x1b8b77(0x174)];console[_0x1b8b77(0x1c6)]('ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20'+_0x459aa2);const _0x3527fa=await database_1['default']['payment'][_0x1b8b77(0x163)]({'where':{'id':_0x459aa2},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3527fa)return _0xf9a769[_0x1b8b77(0x171)](0x194)[_0x1b8b77(0x1a5)]({'success':![],'message':_0x1b8b77(0x19d)});if(_0x3527fa['gateway']!=='mastercard')return _0xf9a769[_0x1b8b77(0x171)](0x190)['json']({'success':![],'message':_0x1b8b77(0x181)});if(_0x3527fa[_0x1b8b77(0x171)]!=='PENDING')return _0xf9a769['status'](0x190)[_0x1b8b77(0x1a5)]({'success':![],'message':_0x1b8b77(0x1cc)+_0x3527fa[_0x1b8b77(0x171)]+_0x1b8b77(0x19c)});const _0x2e3698=_0x1b8b77(0x17e),_0x1cf96b=_0x3527fa['successUrl'];console['log'](_0x1b8b77(0x1ad)),console[_0x1b8b77(0x1c6)](_0x1b8b77(0x1b3)+_0x2e3698),console[_0x1b8b77(0x1c6)](_0x1b8b77(0x1bd)+_0x1cf96b);const _0x2ea70a=await this[_0x1b8b77(0x15f)][_0x1b8b77(0x18a)]({'paymentId':_0x3527fa['id'],'orderId':_0x3527fa[_0x1b8b77(0x1b2)]||_0x3527fa['id'],'amount':_0x3527fa['amount'],'currency':_0x3527fa[_0x1b8b77(0x19b)],'cardData':_0x4a743c,'resultUrl':_0x2e3698,'returnUrl':_0x1cf96b,'cardHolder':_0x56429f,'browser':_0x444f2a});console['log'](_0x1b8b77(0x1c1),_0x2ea70a);const _0xf915b={'status':_0x2ea70a[_0x1b8b77(0x171)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x2ea70a[_0x1b8b77(0x171)]===_0x1b8b77(0x192))_0xf915b[_0x1b8b77(0x165)]=new Date(),_0xf915b[_0x1b8b77(0x1bb)]=_0x2ea70a['gateway_payment_id'];else _0x2ea70a['status']===_0x1b8b77(0x16e)&&(_0xf915b[_0x1b8b77(0x196)]=_0x1b8b77(0x1c9));_0xf915b[_0x1b8b77(0x1b8)]=_0x1b8b77(0x180),await database_1['default'][_0x1b8b77(0x17f)][_0x1b8b77(0x1ca)]({'where':{'id':_0x3527fa['id']},'data':_0xf915b}),await database_1[_0x1b8b77(0x164)][_0x1b8b77(0x1a6)][_0x1b8b77(0x1aa)]({'data':{'paymentId':_0x3527fa['id'],'shopId':_0x3527fa[_0x1b8b77(0x18e)],'event':_0x1b8b77(0x1c4)+_0x2ea70a['status']?.[_0x1b8b77(0x175)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1b8b77(0x1b6),'newStatus':_0x2ea70a[_0x1b8b77(0x171)],'gatewayPaymentId':_0x2ea70a['gateway_payment_id'],'requires3ds':_0x2ea70a[_0x1b8b77(0x173)],'processedAt':new Date()[_0x1b8b77(0x1b0)]()})}});_0x2ea70a['final']&&(await this[_0x1b8b77(0x1a0)](_0x3527fa,_0x2ea70a[_0x1b8b77(0x171)],_0x2ea70a['gateway_payment_id']),await this[_0x1b8b77(0x1c2)](_0x3527fa,_0x2ea70a[_0x1b8b77(0x171)]));console[_0x1b8b77(0x1c6)](_0x1b8b77(0x161)+_0x459aa2+_0x1b8b77(0x168)+_0x2ea70a[_0x1b8b77(0x171)]);if(_0x2ea70a[_0x1b8b77(0x171)]===_0x1b8b77(0x192))_0xf9a769[_0x1b8b77(0x1a5)]({'success':!![],'message':_0x1b8b77(0x197),'result':{'status':_0x1b8b77(0x192),'gatewayPaymentId':_0x2ea70a[_0x1b8b77(0x1a1)],'redirectUrl':_0x1cf96b,'final':!![]}});else _0x2ea70a[_0x1b8b77(0x173)]&&_0x2ea70a['threeds_url']?_0xf9a769[_0x1b8b77(0x1a5)]({'success':!![],'message':_0x1b8b77(0x1c0),'result':{'status':_0x1b8b77(0x1b6),'gatewayPaymentId':_0x2ea70a[_0x1b8b77(0x1a1)],'redirectUrl':_0x2ea70a[_0x1b8b77(0x1af)],'requires3ds':!![],'final':![]}}):_0xf9a769[_0x1b8b77(0x171)](0x190)[_0x1b8b77(0x1a5)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0x2ea70a['gateway_payment_id'],'redirectUrl':_0x3527fa[_0x1b8b77(0x1bf)],'final':!![]}});}catch(_0x4e07e1){_0x24554c(_0x4e07e1);}},this[_0x2ee192(0x18c)]=new paymentService_1[(_0x2ee192(0x188))](),this[_0x2ee192(0x15f)]=new mastercardService_1[(_0x2ee192(0x183))](),this[_0x2ee192(0x18b)]=new webhookService_1[(_0x2ee192(0x17b))]();}async['sendShopWebhook'](_0x568edf,_0x31747f,_0x3b1d90){const _0x1bc3fe=a8_0x96c6b0,_0x1a63c0=Date[_0x1bc3fe(0x1c8)]();try{const _0x58ce8f=_0x568edf[_0x1bc3fe(0x170)],_0x4b9735=_0x58ce8f['settings'];if(!_0x4b9735?.[_0x1bc3fe(0x177)]){console[_0x1bc3fe(0x1c6)](_0x1bc3fe(0x1cd)+_0x58ce8f['id']);return;}const _0x5e41fc=_0x31747f==='PAID'?'payment.success':_0x1bc3fe(0x182);let _0x4503bd=[];if(_0x4b9735[_0x1bc3fe(0x179)])try{_0x4503bd=Array[_0x1bc3fe(0x162)](_0x4b9735[_0x1bc3fe(0x179)])?_0x4b9735[_0x1bc3fe(0x179)]:JSON[_0x1bc3fe(0x167)](_0x4b9735[_0x1bc3fe(0x179)]);}catch(_0x3f6597){console[_0x1bc3fe(0x1ab)](_0x1bc3fe(0x16d),_0x3f6597),_0x4503bd=[];}if(!_0x4503bd['includes'](_0x5e41fc)){console[_0x1bc3fe(0x1c6)](_0x1bc3fe(0x187)+_0x5e41fc+'\x20not\x20enabled\x20for\x20shop\x20'+_0x58ce8f['id']);return;}const _0x1fcf4b={'event':_0x5e41fc,'payment':{'id':_0x568edf['id'],'order_id':_0x568edf[_0x1bc3fe(0x172)],'gateway_order_id':_0x568edf[_0x1bc3fe(0x1b2)],'gateway':_0x1bc3fe(0x1ae),'amount':_0x568edf[_0x1bc3fe(0x194)],'currency':_0x568edf['currency'],'status':_0x31747f[_0x1bc3fe(0x175)](),'customer_email':_0x568edf['customerEmail'],'customer_name':_0x568edf[_0x1bc3fe(0x1b9)],'gateway_payment_id':_0x3b1d90,'created_at':_0x568edf[_0x1bc3fe(0x1a8)],'updated_at':new Date()}},_0x56b986=await fetch(_0x4b9735[_0x1bc3fe(0x177)],{'method':_0x1bc3fe(0x1c5),'headers':{'Content-Type':_0x1bc3fe(0x1cb),'User-Agent':_0x1bc3fe(0x16b)},'body':JSON[_0x1bc3fe(0x17c)](_0x1fcf4b)}),_0x22da6d=Date[_0x1bc3fe(0x1c8)]()-_0x1a63c0;console[_0x1bc3fe(0x1c6)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x4b9735[_0x1bc3fe(0x177)]+_0x1bc3fe(0x16c)+_0x56b986[_0x1bc3fe(0x171)]+'\x20('+_0x22da6d+_0x1bc3fe(0x1a3));}catch(_0x185bf4){console[_0x1bc3fe(0x1ab)](_0x1bc3fe(0x190),_0x185bf4);}}async[a8_0x96c6b0(0x1c2)](_0x2755ab,_0x3ab8d0){const _0x3592cf=a8_0x96c6b0;try{const {telegramBotService:_0x475c34}=await Promise[_0x3592cf(0x1b1)]()[_0x3592cf(0x1b7)](()=>__importStar(require(_0x3592cf(0x16f)))),_0x362c24={'PAID':_0x3592cf(0x195),'FAILED':_0x3592cf(0x169)},_0x43a290=_0x362c24[_0x3ab8d0];if(!_0x43a290)return;await _0x475c34[_0x3592cf(0x1b5)](_0x2755ab[_0x3592cf(0x18e)],_0x2755ab,_0x43a290);}catch(_0x315397){console[_0x3592cf(0x1ab)](_0x3592cf(0x1a4),_0x315397);}}}function a8_0x1598(_0x1e38bd,_0xecf792){const _0x1b5603=a8_0x1b56();return a8_0x1598=function(_0x1598f6,_0x29a79e){_0x1598f6=_0x1598f6-0x15f;let _0x4f080b=_0x1b5603[_0x1598f6];return _0x4f080b;},a8_0x1598(_0x1e38bd,_0xecf792);}exports[a8_0x96c6b0(0x19a)]=PaymentController;