'use strict';const a8_0x5d4255=a8_0x16b9;function a8_0x16b9(_0x1c8b37,_0x3c8f5e){const _0x44c050=a8_0x44c0();return a8_0x16b9=function(_0x16b9d1,_0x1cce22){_0x16b9d1=_0x16b9d1-0x114;let _0x158c64=_0x44c050[_0x16b9d1];return _0x158c64;},a8_0x16b9(_0x1c8b37,_0x3c8f5e);}(function(_0x27ec8c,_0x45a7b3){const _0xf0e641=a8_0x16b9,_0x4e178e=_0x27ec8c();while(!![]){try{const _0x5c4403=-parseInt(_0xf0e641(0x14b))/0x1*(-parseInt(_0xf0e641(0x19b))/0x2)+parseInt(_0xf0e641(0x143))/0x3*(parseInt(_0xf0e641(0x14a))/0x4)+parseInt(_0xf0e641(0x17e))/0x5+-parseInt(_0xf0e641(0x15f))/0x6+-parseInt(_0xf0e641(0x120))/0x7*(parseInt(_0xf0e641(0x13d))/0x8)+parseInt(_0xf0e641(0x155))/0x9+-parseInt(_0xf0e641(0x124))/0xa*(-parseInt(_0xf0e641(0x178))/0xb);if(_0x5c4403===_0x45a7b3)break;else _0x4e178e['push'](_0x4e178e['shift']());}catch(_0x15799c){_0x4e178e['push'](_0x4e178e['shift']());}}}(a8_0x44c0,0xc6487));function a8_0x44c0(){const _0x5553f7=['paymentService','status','__createBinding','28QLSMKO','settings','startsWith','üìù\x20Customer\x20data:','23020ugwCYA','sendPaymentStatusNotification','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','processMasterCardPayment','gatewayPaymentId','updatePaymentCustomerDataPublic','json','PaymentService','\x20not\x20enabled\x20for\x20shop\x20','webhookService',',\x20cannot\x20process','log','failureMessage','Webhook\x20event\x20','parse','FAILED','updatedAt','PENDING','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','default','payment.success','VISA/MasterCard','error','update','&payment_id=','1517640ZgSrlL','email','requires_3ds','\x20payment\x20','gateway','../services/gateways/mastercardService','3cxpCYS','../services/telegramBotService','Payment\x20processed\x20successfully','system','user_agent','paid','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','52748XMDNPw','1cBfEbv','__esModule','failUrl','findUnique','Card\x20payment\x20failed','create','\x20\x20\x20Result\x20URL\x20(webhook):\x20','TesSoft\x20Payment\x20System/1.0\x20(','customerName','\x20\x20\x20Return\x20URL:\x20','2531070AOqecy','üìà\x20','customerCountry','configurable','body','__importStar','webhookEvents','\x20processed:\x20','isArray','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','7063812zMlBem','webhookUrl','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','handleSuccessfulPayment','sendShopWebhook','Customer\x20data\x20updated\x20successfully','shopId','createdAt','WebhookService','../services/paymentService','üí≥\x20Processing\x20MasterCard\x20payment:\x20','gatewayOrderId','includes','üí≥\x20MasterCard\x20result:','stringify','gateway_payment_id','\x20URLs:','first_name','__importDefault','toLowerCase','now','getOwnPropertyNames','../services/paymentLinkService','currency','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','3069twZpob','ms)','application/json','https://api.trapay.uk/api/webhooks/gateway/','\x20payment:','\x20with\x20status\x20','5716465OrehzL','then','replace','threeds_url','paidAt','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','mastercard','Payment\x20not\x20found','PaymentController','Failed\x20to\x20send\x20','prototype','resolve','customerUa','amount','getPaymentById','3DS\x20verification\x20required','üí≥\x20Browser\x20IP:\x20','payment','visa','hasOwnProperty','defineProperty','paymentMethod','number','writable','last_name','orderId','length','getOwnPropertyDescriptor','getPaymentStatus','1336642FeCELA','UNKNOWN','\x20webhook\x20sent\x20to\x20','PAID','params','createPublicPayment','https://app.trapay.uk/payment/pending?id=','customerIp','Payment\x20status\x20is\x20','cardLast4','toUpperCase','../config/database','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20webhook:','visa/mastercard'];a8_0x44c0=function(){return _0x5553f7;};return a8_0x44c0();}var __createBinding=this&&this[a8_0x5d4255(0x11f)]||(Object[a8_0x5d4255(0x150)]?function(_0x134943,_0x1f5f65,_0x4f8b45,_0x3dd405){const _0x2e560e=a8_0x5d4255;if(_0x3dd405===undefined)_0x3dd405=_0x4f8b45;var _0x562cae=Object[_0x2e560e(0x199)](_0x1f5f65,_0x4f8b45);(!_0x562cae||('get'in _0x562cae?!_0x1f5f65[_0x2e560e(0x14c)]:_0x562cae[_0x2e560e(0x195)]||_0x562cae[_0x2e560e(0x158)]))&&(_0x562cae={'enumerable':!![],'get':function(){return _0x1f5f65[_0x4f8b45];}}),Object[_0x2e560e(0x192)](_0x134943,_0x3dd405,_0x562cae);}:function(_0xaf61e6,_0x2026da,_0x5dcaa1,_0x23177e){if(_0x23177e===undefined)_0x23177e=_0x5dcaa1;_0xaf61e6[_0x23177e]=_0x2026da[_0x5dcaa1];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x5d4255(0x150)]?function(_0x349e9f,_0x38630a){const _0x173fce=a8_0x5d4255;Object[_0x173fce(0x192)](_0x349e9f,_0x173fce(0x137),{'enumerable':!![],'value':_0x38630a});}:function(_0x369400,_0x358223){_0x369400['default']=_0x358223;}),__importStar=this&&this[a8_0x5d4255(0x15a)]||(function(){var _0x243bd4=function(_0x52fa4c){const _0x138ab0=a8_0x16b9;return _0x243bd4=Object[_0x138ab0(0x174)]||function(_0x4cdc60){const _0xbf9663=_0x138ab0;var _0x3bd9a3=[];for(var _0x311fa5 in _0x4cdc60)if(Object[_0xbf9663(0x188)][_0xbf9663(0x191)]['call'](_0x4cdc60,_0x311fa5))_0x3bd9a3[_0x3bd9a3[_0xbf9663(0x198)]]=_0x311fa5;return _0x3bd9a3;},_0x243bd4(_0x52fa4c);};return function(_0x4abb23){const _0x25d96e=a8_0x16b9;if(_0x4abb23&&_0x4abb23[_0x25d96e(0x14c)])return _0x4abb23;var _0x55d471={};if(_0x4abb23!=null){for(var _0x570316=_0x243bd4(_0x4abb23),_0x240eea=0x0;_0x240eea<_0x570316['length'];_0x240eea++)if(_0x570316[_0x240eea]!==_0x25d96e(0x137))__createBinding(_0x55d471,_0x4abb23,_0x570316[_0x240eea]);}return __setModuleDefault(_0x55d471,_0x4abb23),_0x55d471;};}()),__importDefault=this&&this[a8_0x5d4255(0x171)]||function(_0x27ca1b){const _0x4eb0bd=a8_0x5d4255;return _0x27ca1b&&_0x27ca1b[_0x4eb0bd(0x14c)]?_0x27ca1b:{'default':_0x27ca1b};};Object[a8_0x5d4255(0x192)](exports,a8_0x5d4255(0x14c),{'value':!![]}),exports[a8_0x5d4255(0x186)]=void 0x0;const paymentService_1=require(a8_0x5d4255(0x168)),mastercardService_1=require(a8_0x5d4255(0x142)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x5d4255(0x119)));class PaymentController{constructor(){const _0xd2823b=a8_0x5d4255;this['createPublicPayment']=async(_0xadc5bb,_0x3c9482,_0x2c8ce2)=>{const _0x203d99=a8_0x16b9;try{const _0x4f2958=_0xadc5bb[_0x203d99(0x159)],_0x4f549d=await this[_0x203d99(0x11d)][_0x203d99(0x1a0)](_0x4f2958);_0x3c9482[_0x203d99(0x11e)](0xc9)[_0x203d99(0x12a)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x4f549d});}catch(_0x346ec0){_0x2c8ce2(_0x346ec0);}},this[_0xd2823b(0x19a)]=async(_0xf5a3c8,_0x5167f1,_0x4e4aa5)=>{const _0x1daccf=_0xd2823b;try{const {id:_0x2902e7}=_0xf5a3c8[_0x1daccf(0x19f)],_0x29a854=await this['paymentService'][_0x1daccf(0x19a)](_0x2902e7);if(!_0x29a854)return _0x5167f1[_0x1daccf(0x11e)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x5167f1[_0x1daccf(0x12a)]({'success':!![],'result':_0x29a854});}catch(_0x27b4f1){_0x4e4aa5(_0x27b4f1);}},this['getPaymentById']=async(_0x1a47d1,_0x43709e,_0x5692d4)=>{const _0x586ae4=_0xd2823b;try{const {id:_0x5df984}=_0x1a47d1[_0x586ae4(0x19f)],_0x2c49a7=await this[_0x586ae4(0x11d)][_0x586ae4(0x18c)](_0x5df984);if(!_0x2c49a7)return _0x43709e['status'](0x194)[_0x586ae4(0x12a)]({'success':![],'message':_0x586ae4(0x185)});_0x43709e[_0x586ae4(0x12a)]({'success':!![],'result':_0x2c49a7});}catch(_0x3ea21f){_0x5692d4(_0x3ea21f);}},this['updatePaymentCustomer']=async(_0xc7a38e,_0x26dc9f,_0x182f8c)=>{const _0x2f983e=_0xd2823b;try{const {id:_0x57bbb8}=_0xc7a38e[_0x2f983e(0x19f)],_0x42568e=_0xc7a38e[_0x2f983e(0x159)];console['log'](_0x2f983e(0x149)+_0x57bbb8),console['log'](_0x2f983e(0x123),_0x42568e);const _0x2e7ed1=await this[_0x2f983e(0x11d)][_0x2f983e(0x129)](_0x57bbb8,_0x42568e);if(!_0x2e7ed1)return _0x26dc9f[_0x2f983e(0x11e)](0x194)[_0x2f983e(0x12a)]({'success':![],'message':'Payment\x20not\x20found'});_0x26dc9f[_0x2f983e(0x12a)]({'success':!![],'message':_0x2f983e(0x164),'result':{'paymentId':_0x2e7ed1['id'],'customerIp':_0x2e7ed1[_0x2f983e(0x115)],'customerUa':_0x2e7ed1[_0x2f983e(0x18a)],'customerCountry':_0x2e7ed1[_0x2f983e(0x157)],'updatedAt':_0x2e7ed1[_0x2f983e(0x134)]}});}catch(_0x4354df){_0x182f8c(_0x4354df);}},this[_0xd2823b(0x127)]=async(_0x2ed461,_0xb8899b,_0x1ab6f1)=>{const _0x514eb4=_0xd2823b;try{const {id:_0x2924d3}=_0x2ed461[_0x514eb4(0x19f)],{cardData:_0x834b64,cardHolder:_0x15e66f,browser:_0x522997}=_0x2ed461['body'];console['log'](_0x514eb4(0x169)+_0x2924d3),console[_0x514eb4(0x12f)]('üí≥\x20Card\x20holder:\x20'+_0x15e66f[_0x514eb4(0x170)]+'\x20'+_0x15e66f[_0x514eb4(0x196)]+'\x20('+_0x15e66f[_0x514eb4(0x13e)]+')'),console['log'](_0x514eb4(0x18e)+_0x522997['ip']);const _0x50c53a={'customerName':_0x15e66f['first_name']+'\x20'+_0x15e66f['last_name'],'customerEmail':_0x15e66f[_0x514eb4(0x13e)],'customerIp':_0x522997['ip'],'customerUa':_0x522997[_0x514eb4(0x147)]},_0x1cbf87=await database_1[_0x514eb4(0x137)][_0x514eb4(0x18f)][_0x514eb4(0x14e)]({'where':{'id':_0x2924d3},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1cbf87)return _0xb8899b['status'](0x194)[_0x514eb4(0x12a)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x1cbf87[_0x514eb4(0x141)]!==_0x514eb4(0x11c))return console['log'](_0x514eb4(0x183)+_0x1cbf87['gateway']+'\x27'),_0xb8899b[_0x514eb4(0x11e)](0x190)[_0x514eb4(0x12a)]({'success':![],'message':_0x514eb4(0x161)});if(_0x1cbf87[_0x514eb4(0x11e)]!==_0x514eb4(0x135))return _0xb8899b['status'](0x190)[_0x514eb4(0x12a)]({'success':![],'message':_0x514eb4(0x116)+_0x1cbf87[_0x514eb4(0x11e)]+_0x514eb4(0x12e)});await database_1[_0x514eb4(0x137)]['payment'][_0x514eb4(0x13b)]({'where':{'id':_0x2924d3},'data':{..._0x50c53a,'updatedAt':new Date()}});const _0x57b6f5=_0x834b64[_0x514eb4(0x194)][_0x514eb4(0x180)](/[\s-]/g,''),_0xf6aa32=_0x57b6f5[_0x514eb4(0x122)]('4')?_0x514eb4(0x190):_0x514eb4(0x184),_0x199dc6=_0x514eb4(0x17b)+_0xf6aa32,_0x59255d=_0x514eb4(0x114)+_0x1cbf87['id']+_0x514eb4(0x13c)+_0x1cbf87[_0x514eb4(0x16a)];console[_0x514eb4(0x12f)]('üí≥\x20'+_0xf6aa32[_0x514eb4(0x118)]()+_0x514eb4(0x16f)),console[_0x514eb4(0x12f)](_0x514eb4(0x151)+_0x199dc6),console[_0x514eb4(0x12f)](_0x514eb4(0x154)+_0x59255d);const _0x5f9d02={'first_name':_0x15e66f[_0x514eb4(0x170)],'last_name':_0x15e66f[_0x514eb4(0x196)],'email':_0x15e66f['email']},_0xbe44c5=await this['visaMasterCardService']['processCardPayment']({'paymentId':_0x1cbf87['id'],'orderId':_0x1cbf87['gatewayOrderId']||_0x1cbf87['id'],'amount':_0x1cbf87[_0x514eb4(0x18b)],'currency':_0x1cbf87['currency'],'cardData':_0x834b64,'resultUrl':_0x199dc6,'returnUrl':_0x59255d,'cardHolder':_0x5f9d02,'browser':_0x522997});console[_0x514eb4(0x12f)](_0x514eb4(0x16c),_0xbe44c5);const _0x539734={'status':_0xbe44c5[_0x514eb4(0x11e)],'updatedAt':new Date(),'statusChangedBy':_0x514eb4(0x146),'statusChangedAt':new Date()};_0xbe44c5[_0x514eb4(0x16e)]&&(_0x539734[_0x514eb4(0x128)]=_0xbe44c5[_0x514eb4(0x16e)],console['log'](_0x514eb4(0x136)+_0xbe44c5[_0x514eb4(0x16e)]));if(_0xbe44c5[_0x514eb4(0x11e)]===_0x514eb4(0x19e))_0x539734[_0x514eb4(0x182)]=new Date();else _0xbe44c5[_0x514eb4(0x11e)]===_0x514eb4(0x133)&&(_0x539734[_0x514eb4(0x130)]=_0x514eb4(0x14f));_0x539734[_0x514eb4(0x193)]=_0x514eb4(0x184);if(_0x834b64['number']){const _0x30a34e=_0x834b64['number'][_0x514eb4(0x180)](/[\s-]/g,'');_0x539734[_0x514eb4(0x117)]=_0x30a34e['slice'](-0x4),console[_0x514eb4(0x12f)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x539734[_0x514eb4(0x117)]);}await database_1[_0x514eb4(0x137)][_0x514eb4(0x18f)]['update']({'where':{'id':_0x1cbf87['id']},'data':_0x539734}),await database_1['default']['webhookLog'][_0x514eb4(0x150)]({'data':{'paymentId':_0x1cbf87['id'],'shopId':_0x1cbf87[_0x514eb4(0x165)],'event':_0xf6aa32+'_'+_0xbe44c5['status']?.[_0x514eb4(0x172)](),'statusCode':0xc8,'responseBody':JSON[_0x514eb4(0x16d)]({'oldStatus':'PENDING','newStatus':_0xbe44c5['status'],'gatewayPaymentId':_0xbe44c5['gateway_payment_id'],'requires3ds':_0xbe44c5[_0x514eb4(0x13f)],'cardType':_0xf6aa32['toUpperCase'](),'processedAt':new Date()['toISOString']()})}});if(_0xbe44c5['final']){await this[_0x514eb4(0x163)](_0x1cbf87,_0xbe44c5[_0x514eb4(0x11e)],_0xbe44c5['gateway_payment_id'],_0xf6aa32),await this[_0x514eb4(0x125)](_0x1cbf87,_0xbe44c5[_0x514eb4(0x11e)]);if(_0xbe44c5[_0x514eb4(0x11e)]==='PAID'){console['log'](_0x514eb4(0x156)+_0xf6aa32[_0x514eb4(0x118)]()+_0x514eb4(0x140)+_0x2924d3+_0x514eb4(0x11a));try{const {PaymentLinkService:_0x11c93e}=await Promise['resolve']()[_0x514eb4(0x17f)](()=>__importStar(require(_0x514eb4(0x175)))),_0x12db59=new _0x11c93e();await _0x12db59[_0x514eb4(0x162)](_0x2924d3),console['log'](_0x514eb4(0x15e)+_0xf6aa32['toUpperCase']()+_0x514eb4(0x140)+_0x2924d3);}catch(_0x479dc6){console['error']('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20'+_0xf6aa32[_0x514eb4(0x118)]()+_0x514eb4(0x17c),_0x479dc6);}}}console[_0x514eb4(0x12f)]('‚úÖ\x20'+_0xf6aa32[_0x514eb4(0x118)]()+_0x514eb4(0x140)+_0x2924d3+_0x514eb4(0x15c)+_0xbe44c5['status']);if(_0xbe44c5['status']===_0x514eb4(0x19e))_0xb8899b['json']({'success':!![],'message':_0x514eb4(0x145),'result':{'status':'PAID','gatewayPaymentId':_0xbe44c5[_0x514eb4(0x16e)],'redirectUrl':_0x59255d,'final':!![]}});else _0xbe44c5[_0x514eb4(0x13f)]&&_0xbe44c5[_0x514eb4(0x181)]?_0xb8899b['json']({'success':!![],'message':_0x514eb4(0x18d),'result':{'status':_0x514eb4(0x135),'gatewayPaymentId':_0xbe44c5[_0x514eb4(0x16e)],'redirectUrl':_0xbe44c5[_0x514eb4(0x181)],'requires3ds':!![],'final':![]}}):_0xb8899b[_0x514eb4(0x11e)](0x190)[_0x514eb4(0x12a)]({'success':![],'message':'Payment\x20failed','result':{'status':'FAILED','gatewayPaymentId':_0xbe44c5[_0x514eb4(0x16e)],'redirectUrl':_0x1cbf87[_0x514eb4(0x14d)],'final':!![]}});}catch(_0x5e704a){_0x1ab6f1(_0x5e704a);}},this[_0xd2823b(0x11d)]=new paymentService_1[(_0xd2823b(0x12b))](),this['visaMasterCardService']=new mastercardService_1['VisaMasterCardService'](),this[_0xd2823b(0x12d)]=new webhookService_1[(_0xd2823b(0x167))]();}async[a8_0x5d4255(0x163)](_0x3413e4,_0x4da127,_0x38bd9c,_0x178364){const _0xd03f5e=a8_0x5d4255,_0x534c1c=Date[_0xd03f5e(0x173)]();try{const _0x8bec1d=_0x3413e4['shop'],_0x8f587=_0x8bec1d[_0xd03f5e(0x121)];if(!_0x8f587?.[_0xd03f5e(0x160)]){console[_0xd03f5e(0x12f)](_0xd03f5e(0x177)+_0x8bec1d['id']);return;}const _0x523644=_0x4da127===_0xd03f5e(0x19e)?_0xd03f5e(0x138):'payment.failed';let _0x5df1c6=[];if(_0x8f587[_0xd03f5e(0x15b)])try{_0x5df1c6=Array[_0xd03f5e(0x15d)](_0x8f587[_0xd03f5e(0x15b)])?_0x8f587['webhookEvents']:JSON[_0xd03f5e(0x132)](_0x8f587['webhookEvents']);}catch(_0x19f622){console[_0xd03f5e(0x13a)]('Error\x20parsing\x20webhook\x20events:',_0x19f622),_0x5df1c6=[];}if(!_0x5df1c6[_0xd03f5e(0x16b)](_0x523644)){console[_0xd03f5e(0x12f)](_0xd03f5e(0x131)+_0x523644+_0xd03f5e(0x12c)+_0x8bec1d['id']);return;}const _0x9d974f={'event':_0x523644,'payment':{'id':_0x3413e4['id'],'order_id':_0x3413e4[_0xd03f5e(0x197)],'gateway_order_id':_0x3413e4[_0xd03f5e(0x16a)],'gateway':'1111','card_type':_0x178364?.[_0xd03f5e(0x118)]()||_0xd03f5e(0x19c),'amount':_0x3413e4['amount'],'currency':_0x3413e4[_0xd03f5e(0x176)],'status':_0x4da127['toLowerCase'](),'customer_email':_0x3413e4['customerEmail'],'customer_name':_0x3413e4[_0xd03f5e(0x153)],'gateway_payment_id':_0x38bd9c,'created_at':_0x3413e4[_0xd03f5e(0x166)],'updated_at':new Date()}},_0x5e068f=await fetch(_0x8f587[_0xd03f5e(0x160)],{'method':'POST','headers':{'Content-Type':_0xd03f5e(0x17a),'User-Agent':_0xd03f5e(0x152)+(_0x178364?.[_0xd03f5e(0x118)]()||_0xd03f5e(0x139))+')'},'body':JSON['stringify'](_0x9d974f)}),_0x583c86=Date[_0xd03f5e(0x173)]()-_0x534c1c;console[_0xd03f5e(0x12f)]((_0x178364?.[_0xd03f5e(0x118)]()||_0xd03f5e(0x139))+_0xd03f5e(0x19d)+_0x8f587[_0xd03f5e(0x160)]+_0xd03f5e(0x17d)+_0x5e068f[_0xd03f5e(0x11e)]+'\x20('+_0x583c86+_0xd03f5e(0x179));}catch(_0x51e01d){console[_0xd03f5e(0x13a)](_0xd03f5e(0x187)+(_0x178364?.[_0xd03f5e(0x118)]()||_0xd03f5e(0x139))+_0xd03f5e(0x11b),_0x51e01d);}}async['sendPaymentStatusNotification'](_0x25b813,_0x485e8e){const _0x44b3a0=a8_0x5d4255;try{const {telegramBotService:_0x4a1527}=await Promise[_0x44b3a0(0x189)]()[_0x44b3a0(0x17f)](()=>__importStar(require(_0x44b3a0(0x144)))),_0x4096a1={'PAID':_0x44b3a0(0x148),'FAILED':'failed'},_0x5d2920=_0x4096a1[_0x485e8e];if(!_0x5d2920)return;await _0x4a1527['sendPaymentNotification'](_0x25b813[_0x44b3a0(0x165)],_0x25b813,_0x5d2920);}catch(_0x1f5f7b){console[_0x44b3a0(0x13a)](_0x44b3a0(0x126),_0x1f5f7b);}}}exports[a8_0x5d4255(0x186)]=PaymentController;