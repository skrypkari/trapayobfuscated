'use strict';const a8_0x34fec1=a8_0x157f;(function(_0x27eb07,_0x433fc1){const _0x3483b8=a8_0x157f,_0x215c4=_0x27eb07();while(!![]){try{const _0x1f8a08=parseInt(_0x3483b8(0x1a1))/0x1*(parseInt(_0x3483b8(0x1b0))/0x2)+parseInt(_0x3483b8(0x1d1))/0x3+-parseInt(_0x3483b8(0x18f))/0x4*(parseInt(_0x3483b8(0x1d9))/0x5)+-parseInt(_0x3483b8(0x191))/0x6*(parseInt(_0x3483b8(0x194))/0x7)+-parseInt(_0x3483b8(0x1a2))/0x8+-parseInt(_0x3483b8(0x1c3))/0x9+parseInt(_0x3483b8(0x17c))/0xa;if(_0x1f8a08===_0x433fc1)break;else _0x215c4['push'](_0x215c4['shift']());}catch(_0x27e522){_0x215c4['push'](_0x215c4['shift']());}}}(a8_0x21fc,0x49e5f));function a8_0x157f(_0x1bf9b5,_0x2906f6){const _0x21fc97=a8_0x21fc();return a8_0x157f=function(_0x157fd2,_0x13211e){_0x157fd2=_0x157fd2-0x173;let _0x125c79=_0x21fc97[_0x157fd2];return _0x125c79;},a8_0x157f(_0x1bf9b5,_0x2906f6);}var __createBinding=this&&this[a8_0x34fec1(0x1de)]||(Object['create']?function(_0x27f983,_0x5c8b3c,_0x1bc7e6,_0x337152){const _0x300027=a8_0x34fec1;if(_0x337152===undefined)_0x337152=_0x1bc7e6;var _0x47ab93=Object[_0x300027(0x1c6)](_0x5c8b3c,_0x1bc7e6);(!_0x47ab93||(_0x300027(0x1d6)in _0x47ab93?!_0x5c8b3c[_0x300027(0x1a4)]:_0x47ab93[_0x300027(0x1a9)]||_0x47ab93['configurable']))&&(_0x47ab93={'enumerable':!![],'get':function(){return _0x5c8b3c[_0x1bc7e6];}}),Object[_0x300027(0x192)](_0x27f983,_0x337152,_0x47ab93);}:function(_0x59dd95,_0x21d197,_0x22f651,_0x56efcf){if(_0x56efcf===undefined)_0x56efcf=_0x22f651;_0x59dd95[_0x56efcf]=_0x21d197[_0x22f651];}),__setModuleDefault=this&&this[a8_0x34fec1(0x1bd)]||(Object['create']?function(_0x1f0ee8,_0x1b944c){const _0xc0791f=a8_0x34fec1;Object[_0xc0791f(0x192)](_0x1f0ee8,'default',{'enumerable':!![],'value':_0x1b944c});}:function(_0x5cf973,_0x2f6e8b){const _0x2b2b63=a8_0x34fec1;_0x5cf973[_0x2b2b63(0x1d5)]=_0x2f6e8b;}),__importStar=this&&this['__importStar']||(function(){var _0x22a626=function(_0x79660){const _0x36630b=a8_0x157f;return _0x22a626=Object[_0x36630b(0x1c9)]||function(_0x2cf4aa){const _0x5eae01=_0x36630b;var _0x517c5f=[];for(var _0x36a18f in _0x2cf4aa)if(Object[_0x5eae01(0x1dd)][_0x5eae01(0x18e)][_0x5eae01(0x186)](_0x2cf4aa,_0x36a18f))_0x517c5f[_0x517c5f[_0x5eae01(0x1a5)]]=_0x36a18f;return _0x517c5f;},_0x22a626(_0x79660);};return function(_0x234038){const _0x155497=a8_0x157f;if(_0x234038&&_0x234038['__esModule'])return _0x234038;var _0x18754d={};if(_0x234038!=null){for(var _0x55976d=_0x22a626(_0x234038),_0x159b6a=0x0;_0x159b6a<_0x55976d[_0x155497(0x1a5)];_0x159b6a++)if(_0x55976d[_0x159b6a]!==_0x155497(0x1d5))__createBinding(_0x18754d,_0x234038,_0x55976d[_0x159b6a]);}return __setModuleDefault(_0x18754d,_0x234038),_0x18754d;};}()),__importDefault=this&&this[a8_0x34fec1(0x19a)]||function(_0x4358fe){const _0x14beb1=a8_0x34fec1;return _0x4358fe&&_0x4358fe[_0x14beb1(0x1a4)]?_0x4358fe:{'default':_0x4358fe};};Object[a8_0x34fec1(0x192)](exports,'__esModule',{'value':!![]}),exports[a8_0x34fec1(0x177)]=void 0x0;function a8_0x21fc(){const _0x49b2a5=['paymentMethod','requires_3ds','writable','gateway','PaymentService','toISOString','../services/webhookService','webhookUrl','paid','865154XCGqUU','ðŸ’³\x20MasterCard\x20result:','\x20\x20\x20Return\x20URL:\x20','paymentService','stringify','threeds_url','mastercard','Card\x20payment\x20failed','Payment\x20created\x20successfully','PAID','MasterCardService','successUrl','\x20with\x20status\x20','__setModuleDefault','application/json','final','create','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','\x20not\x20enabled\x20for\x20shop\x20','1838682qimCqw','PENDING','gateway_payment_id','getOwnPropertyDescriptor','\x20processed:\x20','gatewayPaymentId','getOwnPropertyNames','shopId','../services/telegramBotService','now','WebhookService','body','system','createdAt','1161624oNVopI','sendPaymentStatusNotification','../services/paymentService','getPaymentStatus','default','get','status','failureMessage','258205wjOwrl','1111','FAILED','Payment\x20failed','prototype','__createBinding','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','currency','mastercard_','findUnique','isArray','../config/database','PaymentController','masterCardService','payment.failed','params','Payment\x20not\x20found','1628310wSWWEe','Failed\x20to\x20send\x20MasterCard\x20webhook:','payment','webhookLog','webhookEvents','customerName','getPaymentById','âœ…\x20MasterCard\x20payment\x20','log','../services/gateways/mastercardService','call','processMasterCardPayment','toLowerCase','parse','gatewayOrderId','3DS\x20verification\x20required','customerEmail','update','hasOwnProperty','4cyKysB','\x20\x20\x20Result\x20URL\x20(webhook):\x20','413286gZkUrU','defineProperty','shop','7rPaArJ','Payment\x20processed\x20successfully','json','POST','then','sendPaymentNotification','__importDefault','webhookService','processCardPayment','ðŸ’³\x20MasterCard\x20URLs:','createPublicPayment','MasterCard\x20webhook\x20sent\x20to\x20','error','1BAeKKY','2840872kXWDWe','Payment\x20status\x20is\x20','__esModule','length','payment.success'];a8_0x21fc=function(){return _0x49b2a5;};return a8_0x21fc();}const paymentService_1=require(a8_0x34fec1(0x1d3)),mastercardService_1=require(a8_0x34fec1(0x185)),webhookService_1=require(a8_0x34fec1(0x1ad)),database_1=__importDefault(require(a8_0x34fec1(0x176)));class PaymentController{constructor(){const _0x6a243f=a8_0x34fec1;this[_0x6a243f(0x19e)]=async(_0x2b196a,_0x3f834b,_0xa9264a)=>{const _0x5702b7=_0x6a243f;try{const _0x194b62=_0x2b196a[_0x5702b7(0x1ce)],_0x2acb87=await this[_0x5702b7(0x1b3)]['createPublicPayment'](_0x194b62);_0x3f834b[_0x5702b7(0x1d7)](0xc9)[_0x5702b7(0x196)]({'success':!![],'message':_0x5702b7(0x1b8),'result':_0x2acb87});}catch(_0xbb8a9){_0xa9264a(_0xbb8a9);}},this[_0x6a243f(0x1d4)]=async(_0x400099,_0x3632e2,_0x389970)=>{const _0xdf8432=_0x6a243f;try{const {id:_0x550866}=_0x400099[_0xdf8432(0x17a)],_0x43aebc=await this[_0xdf8432(0x1b3)][_0xdf8432(0x1d4)](_0x550866);if(!_0x43aebc)return _0x3632e2[_0xdf8432(0x1d7)](0x194)['json']({'success':![],'message':_0xdf8432(0x17b)});_0x3632e2['json']({'success':!![],'result':_0x43aebc});}catch(_0x378bf3){_0x389970(_0x378bf3);}},this[_0x6a243f(0x182)]=async(_0x1b4b9b,_0x48510b,_0x25e075)=>{const _0x1376e9=_0x6a243f;try{const {id:_0x41ce00}=_0x1b4b9b[_0x1376e9(0x17a)],_0x129004=await this[_0x1376e9(0x1b3)]['getPaymentById'](_0x41ce00);if(!_0x129004)return _0x48510b[_0x1376e9(0x1d7)](0x194)[_0x1376e9(0x196)]({'success':![],'message':_0x1376e9(0x17b)});_0x48510b['json']({'success':!![],'result':_0x129004});}catch(_0x913bc3){_0x25e075(_0x913bc3);}},this[_0x6a243f(0x187)]=async(_0x3a6285,_0x18c2fa,_0x3bc8e0)=>{const _0x58c371=_0x6a243f;try{const {id:_0x1a4a7c}=_0x3a6285[_0x58c371(0x17a)],{cardData:_0x270b1a,cardHolder:_0x256ebe,browser:_0x4f39a4}=_0x3a6285[_0x58c371(0x1ce)];console[_0x58c371(0x184)](_0x58c371(0x1df)+_0x1a4a7c);const _0x15258a=await database_1[_0x58c371(0x1d5)][_0x58c371(0x17e)][_0x58c371(0x174)]({'where':{'id':_0x1a4a7c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15258a)return _0x18c2fa[_0x58c371(0x1d7)](0x194)['json']({'success':![],'message':_0x58c371(0x17b)});if(_0x15258a[_0x58c371(0x1aa)]!==_0x58c371(0x1b6))return _0x18c2fa[_0x58c371(0x1d7)](0x190)[_0x58c371(0x196)]({'success':![],'message':_0x58c371(0x1c1)});if(_0x15258a['status']!==_0x58c371(0x1c4))return _0x18c2fa[_0x58c371(0x1d7)](0x190)[_0x58c371(0x196)]({'success':![],'message':_0x58c371(0x1a3)+_0x15258a[_0x58c371(0x1d7)]+',\x20cannot\x20process'});const _0x145c22='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x422c46=_0x15258a[_0x58c371(0x1bb)];console['log'](_0x58c371(0x19d)),console[_0x58c371(0x184)](_0x58c371(0x190)+_0x145c22),console['log'](_0x58c371(0x1b2)+_0x422c46);const _0x4f7d1d=await this['masterCardService'][_0x58c371(0x19c)]({'paymentId':_0x15258a['id'],'orderId':_0x15258a[_0x58c371(0x18a)]||_0x15258a['id'],'amount':_0x15258a['amount'],'currency':_0x15258a[_0x58c371(0x1e0)],'cardData':_0x270b1a,'resultUrl':_0x145c22,'returnUrl':_0x422c46,'cardHolder':_0x256ebe,'browser':_0x4f39a4});console['log'](_0x58c371(0x1b1),_0x4f7d1d);const _0x4fe3cd={'status':_0x4f7d1d[_0x58c371(0x1d7)],'updatedAt':new Date(),'statusChangedBy':_0x58c371(0x1cf),'statusChangedAt':new Date()};if(_0x4f7d1d[_0x58c371(0x1d7)]===_0x58c371(0x1b9))_0x4fe3cd['paidAt']=new Date(),_0x4fe3cd[_0x58c371(0x1c8)]=_0x4f7d1d['gateway_payment_id'];else _0x4f7d1d[_0x58c371(0x1d7)]===_0x58c371(0x1db)&&(_0x4fe3cd[_0x58c371(0x1d8)]=_0x58c371(0x1b7));_0x4fe3cd[_0x58c371(0x1a7)]='mastercard',await database_1[_0x58c371(0x1d5)]['payment'][_0x58c371(0x18d)]({'where':{'id':_0x15258a['id']},'data':_0x4fe3cd}),await database_1['default'][_0x58c371(0x17f)][_0x58c371(0x1c0)]({'data':{'paymentId':_0x15258a['id'],'shopId':_0x15258a[_0x58c371(0x1ca)],'event':_0x58c371(0x173)+_0x4f7d1d[_0x58c371(0x1d7)]?.[_0x58c371(0x188)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x58c371(0x1c4),'newStatus':_0x4f7d1d[_0x58c371(0x1d7)],'gatewayPaymentId':_0x4f7d1d[_0x58c371(0x1c5)],'requires3ds':_0x4f7d1d[_0x58c371(0x1a8)],'processedAt':new Date()[_0x58c371(0x1ac)]()})}});_0x4f7d1d[_0x58c371(0x1bf)]&&(await this['sendShopWebhook'](_0x15258a,_0x4f7d1d['status'],_0x4f7d1d[_0x58c371(0x1c5)]),await this['sendPaymentStatusNotification'](_0x15258a,_0x4f7d1d[_0x58c371(0x1d7)]));console[_0x58c371(0x184)](_0x58c371(0x183)+_0x1a4a7c+_0x58c371(0x1c7)+_0x4f7d1d['status']);if(_0x4f7d1d[_0x58c371(0x1d7)]===_0x58c371(0x1b9))_0x18c2fa[_0x58c371(0x196)]({'success':!![],'message':_0x58c371(0x195),'result':{'status':_0x58c371(0x1b9),'gatewayPaymentId':_0x4f7d1d['gateway_payment_id'],'redirectUrl':_0x422c46,'final':!![]}});else _0x4f7d1d['requires_3ds']&&_0x4f7d1d[_0x58c371(0x1b5)]?_0x18c2fa[_0x58c371(0x196)]({'success':!![],'message':_0x58c371(0x18b),'result':{'status':_0x58c371(0x1c4),'gatewayPaymentId':_0x4f7d1d[_0x58c371(0x1c5)],'redirectUrl':_0x4f7d1d[_0x58c371(0x1b5)],'requires3ds':!![],'final':![]}}):_0x18c2fa[_0x58c371(0x1d7)](0x190)[_0x58c371(0x196)]({'success':![],'message':_0x58c371(0x1dc),'result':{'status':_0x58c371(0x1db),'gatewayPaymentId':_0x4f7d1d['gateway_payment_id'],'redirectUrl':_0x15258a['failUrl'],'final':!![]}});}catch(_0x5dcf9b){_0x3bc8e0(_0x5dcf9b);}},this[_0x6a243f(0x1b3)]=new paymentService_1[(_0x6a243f(0x1ab))](),this[_0x6a243f(0x178)]=new mastercardService_1[(_0x6a243f(0x1ba))](),this[_0x6a243f(0x19b)]=new webhookService_1[(_0x6a243f(0x1cd))]();}async['sendShopWebhook'](_0x361461,_0x57681c,_0x2acd2d){const _0x2ddc52=a8_0x34fec1,_0x1f59f8=Date['now']();try{const _0x4f659b=_0x361461[_0x2ddc52(0x193)],_0x43f11b=_0x4f659b['settings'];if(!_0x43f11b?.[_0x2ddc52(0x1ae)]){console[_0x2ddc52(0x184)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x4f659b['id']);return;}const _0x519e6d=_0x57681c==='PAID'?_0x2ddc52(0x1a6):_0x2ddc52(0x179);let _0x52641d=[];if(_0x43f11b[_0x2ddc52(0x180)])try{_0x52641d=Array[_0x2ddc52(0x175)](_0x43f11b['webhookEvents'])?_0x43f11b['webhookEvents']:JSON[_0x2ddc52(0x189)](_0x43f11b[_0x2ddc52(0x180)]);}catch(_0x54b8aa){console[_0x2ddc52(0x1a0)]('Error\x20parsing\x20webhook\x20events:',_0x54b8aa),_0x52641d=[];}if(!_0x52641d['includes'](_0x519e6d)){console[_0x2ddc52(0x184)]('Webhook\x20event\x20'+_0x519e6d+_0x2ddc52(0x1c2)+_0x4f659b['id']);return;}const _0x6f3166={'event':_0x519e6d,'payment':{'id':_0x361461['id'],'order_id':_0x361461['orderId'],'gateway_order_id':_0x361461[_0x2ddc52(0x18a)],'gateway':_0x2ddc52(0x1da),'amount':_0x361461['amount'],'currency':_0x361461[_0x2ddc52(0x1e0)],'status':_0x57681c[_0x2ddc52(0x188)](),'customer_email':_0x361461[_0x2ddc52(0x18c)],'customer_name':_0x361461[_0x2ddc52(0x181)],'gateway_payment_id':_0x2acd2d,'created_at':_0x361461[_0x2ddc52(0x1d0)],'updated_at':new Date()}},_0x3de91e=await fetch(_0x43f11b[_0x2ddc52(0x1ae)],{'method':_0x2ddc52(0x197),'headers':{'Content-Type':_0x2ddc52(0x1be),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x2ddc52(0x1b4)](_0x6f3166)}),_0x24ae9e=Date[_0x2ddc52(0x1cc)]()-_0x1f59f8;console['log'](_0x2ddc52(0x19f)+_0x43f11b[_0x2ddc52(0x1ae)]+_0x2ddc52(0x1bc)+_0x3de91e[_0x2ddc52(0x1d7)]+'\x20('+_0x24ae9e+'ms)');}catch(_0x49456b){console['error'](_0x2ddc52(0x17d),_0x49456b);}}async[a8_0x34fec1(0x1d2)](_0x40ad88,_0x4e3b3f){const _0x4e9c55=a8_0x34fec1;try{const {telegramBotService:_0x2459c5}=await Promise['resolve']()[_0x4e9c55(0x198)](()=>__importStar(require(_0x4e9c55(0x1cb)))),_0x26ed43={'PAID':_0x4e9c55(0x1af),'FAILED':'failed'},_0x52ae6b=_0x26ed43[_0x4e3b3f];if(!_0x52ae6b)return;await _0x2459c5[_0x4e9c55(0x199)](_0x40ad88[_0x4e9c55(0x1ca)],_0x40ad88,_0x52ae6b);}catch(_0x51270e){console[_0x4e9c55(0x1a0)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x51270e);}}}exports['PaymentController']=PaymentController;