'use strict';const a8_0x29092a=a8_0x2204;(function(_0x5346b8,_0x7c6982){const _0x279d2e=a8_0x2204,_0x23897a=_0x5346b8();while(!![]){try{const _0x5ae779=parseInt(_0x279d2e(0x171))/0x1+-parseInt(_0x279d2e(0x161))/0x2+parseInt(_0x279d2e(0x179))/0x3+-parseInt(_0x279d2e(0x175))/0x4+-parseInt(_0x279d2e(0x14a))/0x5+parseInt(_0x279d2e(0x194))/0x6*(-parseInt(_0x279d2e(0x172))/0x7)+parseInt(_0x279d2e(0x15a))/0x8;if(_0x5ae779===_0x7c6982)break;else _0x23897a['push'](_0x23897a['shift']());}catch(_0xa54f8f){_0x23897a['push'](_0x23897a['shift']());}}}(a8_0x27c3,0x29a33));function a8_0x2204(_0x59c3d6,_0x43326b){const _0x27c38e=a8_0x27c3();return a8_0x2204=function(_0x22041b,_0x34ed12){_0x22041b=_0x22041b-0x12c;let _0x539024=_0x27c38e[_0x22041b];return _0x539024;},a8_0x2204(_0x59c3d6,_0x43326b);}var __createBinding=this&&this[a8_0x29092a(0x169)]||(Object[a8_0x29092a(0x14d)]?function(_0x284167,_0x1d27c2,_0xfff43f,_0xfb81b){const _0x1f1a9b=a8_0x29092a;if(_0xfb81b===undefined)_0xfb81b=_0xfff43f;var _0x3a3878=Object[_0x1f1a9b(0x193)](_0x1d27c2,_0xfff43f);(!_0x3a3878||(_0x1f1a9b(0x12c)in _0x3a3878?!_0x1d27c2['__esModule']:_0x3a3878[_0x1f1a9b(0x16d)]||_0x3a3878[_0x1f1a9b(0x153)]))&&(_0x3a3878={'enumerable':!![],'get':function(){return _0x1d27c2[_0xfff43f];}}),Object[_0x1f1a9b(0x15f)](_0x284167,_0xfb81b,_0x3a3878);}:function(_0xb9c26e,_0x182b59,_0x2100a6,_0x51cd71){if(_0x51cd71===undefined)_0x51cd71=_0x2100a6;_0xb9c26e[_0x51cd71]=_0x182b59[_0x2100a6];}),__setModuleDefault=this&&this[a8_0x29092a(0x15e)]||(Object[a8_0x29092a(0x14d)]?function(_0x44447e,_0x43290e){const _0x283a0d=a8_0x29092a;Object[_0x283a0d(0x15f)](_0x44447e,'default',{'enumerable':!![],'value':_0x43290e});}:function(_0x4d799f,_0x534d55){_0x4d799f['default']=_0x534d55;}),__importStar=this&&this['__importStar']||(function(){var _0x37ab0b=function(_0x1d8e91){return _0x37ab0b=Object['getOwnPropertyNames']||function(_0x40af3b){const _0x775d20=a8_0x2204;var _0x3db285=[];for(var _0x249b66 in _0x40af3b)if(Object['prototype'][_0x775d20(0x18c)]['call'](_0x40af3b,_0x249b66))_0x3db285[_0x3db285[_0x775d20(0x155)]]=_0x249b66;return _0x3db285;},_0x37ab0b(_0x1d8e91);};return function(_0x77e2d0){const _0x5775e8=a8_0x2204;if(_0x77e2d0&&_0x77e2d0[_0x5775e8(0x190)])return _0x77e2d0;var _0x1c01d5={};if(_0x77e2d0!=null){for(var _0x54d027=_0x37ab0b(_0x77e2d0),_0x33c3b7=0x0;_0x33c3b7<_0x54d027['length'];_0x33c3b7++)if(_0x54d027[_0x33c3b7]!==_0x5775e8(0x145))__createBinding(_0x1c01d5,_0x77e2d0,_0x54d027[_0x33c3b7]);}return __setModuleDefault(_0x1c01d5,_0x77e2d0),_0x1c01d5;};}()),__importDefault=this&&this[a8_0x29092a(0x15b)]||function(_0xf00167){const _0x228690=a8_0x29092a;return _0xf00167&&_0xf00167[_0x228690(0x190)]?_0xf00167:{'default':_0xf00167};};Object['defineProperty'](exports,a8_0x29092a(0x190),{'value':!![]}),exports[a8_0x29092a(0x14b)]=void 0x0;function a8_0x27c3(){const _0x45354b=['payment.success','get','stringify','requires_3ds','Payment\x20not\x20found','failureMessage','findUnique','sendShopWebhook','json','sendPaymentNotification','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookLog','payment','📝\x20Customer\x20data:','3DS\x20verification\x20required','💳\x20MasterCard\x20URLs:','params','../services/gateways/mastercardService','failUrl','Payment\x20created\x20successfully','../services/telegramBotService','Payment\x20status\x20is\x20','customerUa','updatedAt','default','customerName','then','parse','resolve','530650VrXHYP','PaymentController','sendPaymentStatusNotification','create','webhookUrl','user','💳\x20MasterCard\x20result:','webhookEvents','isArray','configurable','body','length','successUrl','update','\x20with\x20status\x20','Card\x20payment\x20failed','3638952eHuYxv','__importDefault','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PaymentService','__setModuleDefault','defineProperty','now','277126xbKKfh','shop','gateway_payment_id','paymentService','currency','paymentMethod','mastercard','getPaymentById','__createBinding','status','Payment\x20failed','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','writable','💳\x20Processing\x20MasterCard\x20payment:\x20','amount','customerEmail','24683ezxZuc','34636mUoJsN','ms)','gateway','793024mEIXSE','toLowerCase','threeds_url','log','461208LqTxsd','system','Customer\x20data\x20updated\x20successfully','Error\x20parsing\x20webhook\x20events:','webhookService','MasterCard\x20webhook\x20sent\x20to\x20','gatewayPaymentId','paidAt','customerIp','error','Webhook\x20event\x20','processMasterCardPayment','POST','customerCountry','../services/paymentService','paid','updatePaymentCustomerData','createdAt','payment.failed','hasOwnProperty','../config/database','createPublicPayment','PAID','__esModule','Unauthorized','gatewayOrderId','getOwnPropertyDescriptor','24djEyaz','FAILED','WebhookService','Failed\x20to\x20send\x20MasterCard\x20webhook:','orderId','\x20processed:\x20','getPaymentStatus','shopId','includes',',\x20cannot\x20process'];a8_0x27c3=function(){return _0x45354b;};return a8_0x27c3();}const paymentService_1=require(a8_0x29092a(0x187)),mastercardService_1=require(a8_0x29092a(0x13e)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x29092a(0x18d)));class PaymentController{constructor(){const _0x552df1=a8_0x29092a;this[_0x552df1(0x18e)]=async(_0x112be6,_0x2cec4f,_0xca797c)=>{const _0x41eaac=_0x552df1;try{const _0x4d40de=_0x112be6['body'],_0x88724=await this[_0x41eaac(0x164)][_0x41eaac(0x18e)](_0x4d40de);_0x2cec4f[_0x41eaac(0x16a)](0xc9)[_0x41eaac(0x133)]({'success':!![],'message':_0x41eaac(0x140),'result':_0x88724});}catch(_0x3aff37){_0xca797c(_0x3aff37);}},this['getPaymentStatus']=async(_0x3bd474,_0x50adef,_0x38f1f9)=>{const _0x5b8886=_0x552df1;try{const {id:_0x281a3d}=_0x3bd474[_0x5b8886(0x13d)],_0x11fbdf=await this['paymentService'][_0x5b8886(0x19a)](_0x281a3d);if(!_0x11fbdf)return _0x50adef[_0x5b8886(0x16a)](0x194)['json']({'success':![],'message':_0x5b8886(0x12f)});_0x50adef[_0x5b8886(0x133)]({'success':!![],'result':_0x11fbdf});}catch(_0x11e82c){_0x38f1f9(_0x11e82c);}},this[_0x552df1(0x168)]=async(_0x48749d,_0x8080d7,_0x3f0427)=>{const _0x48b2d6=_0x552df1;try{const {id:_0x2ce79f}=_0x48749d[_0x48b2d6(0x13d)],_0x5c12ed=await this[_0x48b2d6(0x164)][_0x48b2d6(0x168)](_0x2ce79f);if(!_0x5c12ed)return _0x8080d7['status'](0x194)[_0x48b2d6(0x133)]({'success':![],'message':_0x48b2d6(0x12f)});_0x8080d7[_0x48b2d6(0x133)]({'success':!![],'result':_0x5c12ed});}catch(_0x3f091b){_0x3f0427(_0x3f091b);}},this['updatePaymentCustomer']=async(_0x391497,_0x186416,_0x2e0628)=>{const _0x1a6c0c=_0x552df1;try{const {id:_0x47f9ec}=_0x391497[_0x1a6c0c(0x13d)],_0x318a61=_0x391497[_0x1a6c0c(0x14f)]?.['id'],_0x9fc7c9=_0x391497[_0x1a6c0c(0x154)];if(!_0x318a61)return _0x186416[_0x1a6c0c(0x16a)](0x191)['json']({'success':![],'message':_0x1a6c0c(0x191)});console[_0x1a6c0c(0x178)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x47f9ec+',\x20shop:\x20'+_0x318a61),console[_0x1a6c0c(0x178)](_0x1a6c0c(0x13a),_0x9fc7c9);const _0x2279ff=await this[_0x1a6c0c(0x164)][_0x1a6c0c(0x189)](_0x318a61,_0x47f9ec,_0x9fc7c9);if(!_0x2279ff)return _0x186416[_0x1a6c0c(0x16a)](0x194)[_0x1a6c0c(0x133)]({'success':![],'message':_0x1a6c0c(0x136)});_0x186416[_0x1a6c0c(0x133)]({'success':!![],'message':_0x1a6c0c(0x17b),'result':{'paymentId':_0x2279ff['id'],'customerIp':_0x2279ff[_0x1a6c0c(0x181)],'customerUa':_0x2279ff[_0x1a6c0c(0x143)],'customerCountry':_0x2279ff[_0x1a6c0c(0x186)],'updatedAt':_0x2279ff[_0x1a6c0c(0x144)]}});}catch(_0x943024){_0x2e0628(_0x943024);}},this[_0x552df1(0x184)]=async(_0x5702aa,_0x450419,_0x212f96)=>{const _0x26213a=_0x552df1;try{const {id:_0x28911b}=_0x5702aa[_0x26213a(0x13d)],{cardData:_0x4704c2,cardHolder:_0x1fe6fe,browser:_0x10e87f}=_0x5702aa[_0x26213a(0x154)];console['log'](_0x26213a(0x16e)+_0x28911b);const _0x42bd40=await database_1[_0x26213a(0x145)][_0x26213a(0x139)][_0x26213a(0x131)]({'where':{'id':_0x28911b},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x42bd40)return _0x450419[_0x26213a(0x16a)](0x194)[_0x26213a(0x133)]({'success':![],'message':_0x26213a(0x12f)});if(_0x42bd40[_0x26213a(0x174)]!=='mastercard')return _0x450419[_0x26213a(0x16a)](0x190)[_0x26213a(0x133)]({'success':![],'message':_0x26213a(0x16c)});if(_0x42bd40['status']!=='PENDING')return _0x450419[_0x26213a(0x16a)](0x190)[_0x26213a(0x133)]({'success':![],'message':_0x26213a(0x142)+_0x42bd40[_0x26213a(0x16a)]+_0x26213a(0x19d)});const _0x49fb0f='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x13a486=_0x42bd40[_0x26213a(0x156)];console['log'](_0x26213a(0x13c)),console[_0x26213a(0x178)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x49fb0f),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x13a486);const _0x348334=await this['masterCardService']['processCardPayment']({'paymentId':_0x42bd40['id'],'orderId':_0x42bd40[_0x26213a(0x192)]||_0x42bd40['id'],'amount':_0x42bd40['amount'],'currency':_0x42bd40[_0x26213a(0x165)],'cardData':_0x4704c2,'resultUrl':_0x49fb0f,'returnUrl':_0x13a486,'cardHolder':_0x1fe6fe,'browser':_0x10e87f});console[_0x26213a(0x178)](_0x26213a(0x150),_0x348334);const _0x1c658c={'status':_0x348334['status'],'updatedAt':new Date(),'statusChangedBy':_0x26213a(0x17a),'statusChangedAt':new Date()};if(_0x348334[_0x26213a(0x16a)]==='PAID')_0x1c658c[_0x26213a(0x180)]=new Date(),_0x1c658c[_0x26213a(0x17f)]=_0x348334[_0x26213a(0x163)];else _0x348334[_0x26213a(0x16a)]==='FAILED'&&(_0x1c658c[_0x26213a(0x130)]=_0x26213a(0x159));_0x1c658c[_0x26213a(0x166)]=_0x26213a(0x167),await database_1[_0x26213a(0x145)][_0x26213a(0x139)][_0x26213a(0x157)]({'where':{'id':_0x42bd40['id']},'data':_0x1c658c}),await database_1['default'][_0x26213a(0x138)][_0x26213a(0x14d)]({'data':{'paymentId':_0x42bd40['id'],'shopId':_0x42bd40[_0x26213a(0x19b)],'event':'mastercard_'+_0x348334[_0x26213a(0x16a)]?.[_0x26213a(0x176)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x348334[_0x26213a(0x16a)],'gatewayPaymentId':_0x348334[_0x26213a(0x163)],'requires3ds':_0x348334[_0x26213a(0x12e)],'processedAt':new Date()['toISOString']()})}});_0x348334['final']&&(await this[_0x26213a(0x132)](_0x42bd40,_0x348334[_0x26213a(0x16a)],_0x348334[_0x26213a(0x163)]),await this[_0x26213a(0x14c)](_0x42bd40,_0x348334['status']));console['log']('✅\x20MasterCard\x20payment\x20'+_0x28911b+_0x26213a(0x199)+_0x348334[_0x26213a(0x16a)]);if(_0x348334[_0x26213a(0x16a)]===_0x26213a(0x18f))_0x450419[_0x26213a(0x133)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','gatewayPaymentId':_0x348334[_0x26213a(0x163)],'redirectUrl':_0x13a486,'final':!![]}});else _0x348334['requires_3ds']&&_0x348334[_0x26213a(0x177)]?_0x450419[_0x26213a(0x133)]({'success':!![],'message':_0x26213a(0x13b),'result':{'status':'PENDING','gatewayPaymentId':_0x348334[_0x26213a(0x163)],'redirectUrl':_0x348334[_0x26213a(0x177)],'requires3ds':!![],'final':![]}}):_0x450419[_0x26213a(0x16a)](0x190)[_0x26213a(0x133)]({'success':![],'message':_0x26213a(0x16b),'result':{'status':_0x26213a(0x195),'gatewayPaymentId':_0x348334[_0x26213a(0x163)],'redirectUrl':_0x42bd40[_0x26213a(0x13f)],'final':!![]}});}catch(_0x47a04a){_0x212f96(_0x47a04a);}},this[_0x552df1(0x164)]=new paymentService_1[(_0x552df1(0x15d))](),this['masterCardService']=new mastercardService_1['MasterCardService'](),this[_0x552df1(0x17d)]=new webhookService_1[(_0x552df1(0x196))]();}async[a8_0x29092a(0x132)](_0x2445fa,_0x3d3805,_0x550f3a){const _0x1ed032=a8_0x29092a,_0x1a6483=Date[_0x1ed032(0x160)]();try{const _0x47106c=_0x2445fa[_0x1ed032(0x162)],_0x194d0d=_0x47106c['settings'];if(!_0x194d0d?.[_0x1ed032(0x14e)]){console[_0x1ed032(0x178)](_0x1ed032(0x137)+_0x47106c['id']);return;}const _0x1e93a5=_0x3d3805==='PAID'?_0x1ed032(0x19e):_0x1ed032(0x18b);let _0x7fc98a=[];if(_0x194d0d[_0x1ed032(0x151)])try{_0x7fc98a=Array[_0x1ed032(0x152)](_0x194d0d[_0x1ed032(0x151)])?_0x194d0d['webhookEvents']:JSON[_0x1ed032(0x148)](_0x194d0d['webhookEvents']);}catch(_0x12c37e){console[_0x1ed032(0x182)](_0x1ed032(0x17c),_0x12c37e),_0x7fc98a=[];}if(!_0x7fc98a[_0x1ed032(0x19c)](_0x1e93a5)){console[_0x1ed032(0x178)](_0x1ed032(0x183)+_0x1e93a5+'\x20not\x20enabled\x20for\x20shop\x20'+_0x47106c['id']);return;}const _0x149f11={'event':_0x1e93a5,'payment':{'id':_0x2445fa['id'],'order_id':_0x2445fa[_0x1ed032(0x198)],'gateway_order_id':_0x2445fa['gatewayOrderId'],'gateway':'1111','amount':_0x2445fa[_0x1ed032(0x16f)],'currency':_0x2445fa[_0x1ed032(0x165)],'status':_0x3d3805[_0x1ed032(0x176)](),'customer_email':_0x2445fa[_0x1ed032(0x170)],'customer_name':_0x2445fa[_0x1ed032(0x146)],'gateway_payment_id':_0x550f3a,'created_at':_0x2445fa[_0x1ed032(0x18a)],'updated_at':new Date()}},_0x1ae372=await fetch(_0x194d0d['webhookUrl'],{'method':_0x1ed032(0x185),'headers':{'Content-Type':'application/json','User-Agent':_0x1ed032(0x135)},'body':JSON[_0x1ed032(0x12d)](_0x149f11)}),_0x3ba929=Date[_0x1ed032(0x160)]()-_0x1a6483;console[_0x1ed032(0x178)](_0x1ed032(0x17e)+_0x194d0d['webhookUrl']+_0x1ed032(0x158)+_0x1ae372[_0x1ed032(0x16a)]+'\x20('+_0x3ba929+_0x1ed032(0x173));}catch(_0x44065e){console['error'](_0x1ed032(0x197),_0x44065e);}}async['sendPaymentStatusNotification'](_0x5a22ba,_0x1e4133){const _0x3e0f41=a8_0x29092a;try{const {telegramBotService:_0x3298fd}=await Promise[_0x3e0f41(0x149)]()[_0x3e0f41(0x147)](()=>__importStar(require(_0x3e0f41(0x141)))),_0x1580fa={'PAID':_0x3e0f41(0x188),'FAILED':'failed'},_0x4db51e=_0x1580fa[_0x1e4133];if(!_0x4db51e)return;await _0x3298fd[_0x3e0f41(0x134)](_0x5a22ba[_0x3e0f41(0x19b)],_0x5a22ba,_0x4db51e);}catch(_0x538a95){console[_0x3e0f41(0x182)](_0x3e0f41(0x15c),_0x538a95);}}}exports[a8_0x29092a(0x14b)]=PaymentController;