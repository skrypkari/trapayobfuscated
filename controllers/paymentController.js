'use strict';function a8_0x1541(){const _0x344685=['638733OImRMq','webhookUrl','json','PENDING','PAID','Payment\x20created\x20successfully','paymentService','updatePaymentCustomer','MasterCardService','üìù\x20Customer\x20data:','Card\x20payment\x20failed','3712491FOBEkE','masterCardService','shop','../services/paymentService','createdAt','WebhookService','failed','sendShopWebhook','customerName','gateway_payment_id','configurable','1850650gPFySC','Error\x20parsing\x20webhook\x20events:','getOwnPropertyNames',',\x20cannot\x20process','gatewayPaymentId','prototype','create','status','\x20\x20\x20Return\x20URL:\x20','customerIp','resolve','updatePaymentCustomerData','includes','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','1348728cFwBCB','successUrl','185tAtLdv','webhookEvents','paid','processMasterCardPayment','final','48qoLVOv','system','../services/telegramBotService','requires_3ds','webhookService','payment','FAILED','9824ROJDHZ','MasterCard\x20webhook\x20sent\x20to\x20','416332XdJCHl','93XvIsur','amount','Customer\x20data\x20updated\x20successfully','body','8fSotpB','https://api.trapay.uk/api/webhooks/gateway/mastercard','shopId','1111','Payment\x20status\x20is\x20','sendPaymentStatusNotification','customerUa','getPaymentById','paymentMethod','Webhook\x20event\x20','currency','../services/webhookService','isArray','default','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','4244UktCzC','error','stringify','3DS\x20verification\x20required','Payment\x20failed','__esModule','\x20\x20\x20Result\x20URL\x20(webhook):\x20','\x20processed:\x20','customerCountry','update','threeds_url','updatedAt','sendPaymentNotification','POST','length','now','gateway','__createBinding','\x20with\x20status\x20','createPublicPayment','44EQjAGP','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','call','log','PaymentController','hasOwnProperty','findUnique','gatewayOrderId','üí≥\x20MasterCard\x20URLs:','failureMessage','orderId','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','üí≥\x20MasterCard\x20result:',',\x20shop:\x20','__setModuleDefault','params','toLowerCase','üí≥\x20Processing\x20MasterCard\x20payment:\x20','payment.success','webhookLog','__importDefault','getPaymentStatus'];a8_0x1541=function(){return _0x344685;};return a8_0x1541();}const a8_0x53465d=a8_0xb72f;(function(_0xf4f1b6,_0x1dee26){const _0x478ec7=a8_0xb72f,_0x4e0633=_0xf4f1b6();while(!![]){try{const _0x14c311=parseInt(_0x478ec7(0x13c))/0x1+parseInt(_0x478ec7(0x112))/0x2*(-parseInt(_0x478ec7(0xff))/0x3)+-parseInt(_0x478ec7(0xfc))/0x4*(-parseInt(_0x478ec7(0x162))/0x5)+parseInt(_0x478ec7(0xf5))/0x6*(-parseInt(_0x478ec7(0xfe))/0x7)+-parseInt(_0x478ec7(0x103))/0x8*(-parseInt(_0x478ec7(0x147))/0x9)+parseInt(_0x478ec7(0x152))/0xa+parseInt(_0x478ec7(0x126))/0xb*(-parseInt(_0x478ec7(0x160))/0xc);if(_0x14c311===_0x1dee26)break;else _0x4e0633['push'](_0x4e0633['shift']());}catch(_0x137af5){_0x4e0633['push'](_0x4e0633['shift']());}}}(a8_0x1541,0x52083));function a8_0xb72f(_0x4ac9bb,_0x4741a3){const _0x1541bc=a8_0x1541();return a8_0xb72f=function(_0xb72f28,_0x3654f8){_0xb72f28=_0xb72f28-0xf4;let _0x37e5cf=_0x1541bc[_0xb72f28];return _0x37e5cf;},a8_0xb72f(_0x4ac9bb,_0x4741a3);}var __createBinding=this&&this[a8_0x53465d(0x123)]||(Object[a8_0x53465d(0x158)]?function(_0x30e23a,_0x1db95e,_0x301605,_0x2db42a){const _0x35d7ef=a8_0x53465d;if(_0x2db42a===undefined)_0x2db42a=_0x301605;var _0x2041fc=Object['getOwnPropertyDescriptor'](_0x1db95e,_0x301605);(!_0x2041fc||('get'in _0x2041fc?!_0x1db95e[_0x35d7ef(0x117)]:_0x2041fc['writable']||_0x2041fc[_0x35d7ef(0x151)]))&&(_0x2041fc={'enumerable':!![],'get':function(){return _0x1db95e[_0x301605];}}),Object['defineProperty'](_0x30e23a,_0x2db42a,_0x2041fc);}:function(_0x205f58,_0x1ba2c0,_0x4069e1,_0x306738){if(_0x306738===undefined)_0x306738=_0x4069e1;_0x205f58[_0x306738]=_0x1ba2c0[_0x4069e1];}),__setModuleDefault=this&&this[a8_0x53465d(0x134)]||(Object[a8_0x53465d(0x158)]?function(_0x31265f,_0x27829a){const _0x3f08cb=a8_0x53465d;Object['defineProperty'](_0x31265f,_0x3f08cb(0x110),{'enumerable':!![],'value':_0x27829a});}:function(_0x4c1190,_0x20a051){const _0x49641a=a8_0x53465d;_0x4c1190[_0x49641a(0x110)]=_0x20a051;}),__importStar=this&&this['__importStar']||(function(){var _0x290491=function(_0x2b5c9a){const _0x4d0543=a8_0xb72f;return _0x290491=Object[_0x4d0543(0x154)]||function(_0x1950cb){const _0x58c837=_0x4d0543;var _0xa97a2c=[];for(var _0x3aea2c in _0x1950cb)if(Object[_0x58c837(0x157)][_0x58c837(0x12b)][_0x58c837(0x128)](_0x1950cb,_0x3aea2c))_0xa97a2c[_0xa97a2c[_0x58c837(0x120)]]=_0x3aea2c;return _0xa97a2c;},_0x290491(_0x2b5c9a);};return function(_0x2ef005){const _0x456246=a8_0xb72f;if(_0x2ef005&&_0x2ef005['__esModule'])return _0x2ef005;var _0x6afb0a={};if(_0x2ef005!=null){for(var _0x5cbb0d=_0x290491(_0x2ef005),_0x452d29=0x0;_0x452d29<_0x5cbb0d['length'];_0x452d29++)if(_0x5cbb0d[_0x452d29]!==_0x456246(0x110))__createBinding(_0x6afb0a,_0x2ef005,_0x5cbb0d[_0x452d29]);}return __setModuleDefault(_0x6afb0a,_0x2ef005),_0x6afb0a;};}()),__importDefault=this&&this[a8_0x53465d(0x13a)]||function(_0x3b7b01){const _0x482377=a8_0x53465d;return _0x3b7b01&&_0x3b7b01[_0x482377(0x117)]?_0x3b7b01:{'default':_0x3b7b01};};Object['defineProperty'](exports,a8_0x53465d(0x117),{'value':!![]}),exports[a8_0x53465d(0x12a)]=void 0x0;const paymentService_1=require(a8_0x53465d(0x14a)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x53465d(0x10e)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x3b0b1f=a8_0x53465d;this[_0x3b0b1f(0x125)]=async(_0x70643c,_0x4ebd97,_0x102c5b)=>{const _0x483e21=_0x3b0b1f;try{const _0x27bdaf=_0x70643c[_0x483e21(0x102)],_0x18d074=await this[_0x483e21(0x142)][_0x483e21(0x125)](_0x27bdaf);_0x4ebd97[_0x483e21(0x159)](0xc9)['json']({'success':!![],'message':_0x483e21(0x141),'result':_0x18d074});}catch(_0x1a4617){_0x102c5b(_0x1a4617);}},this[_0x3b0b1f(0x13b)]=async(_0x99408b,_0x5444a5,_0x2c4f1a)=>{const _0x3d9a5e=_0x3b0b1f;try{const {id:_0x48cadc}=_0x99408b['params'],_0x50d0c3=await this[_0x3d9a5e(0x142)][_0x3d9a5e(0x13b)](_0x48cadc);if(!_0x50d0c3)return _0x5444a5[_0x3d9a5e(0x159)](0x194)[_0x3d9a5e(0x13e)]({'success':![],'message':'Payment\x20not\x20found'});_0x5444a5[_0x3d9a5e(0x13e)]({'success':!![],'result':_0x50d0c3});}catch(_0x3aa96b){_0x2c4f1a(_0x3aa96b);}},this[_0x3b0b1f(0x10a)]=async(_0x51496b,_0x1c4515,_0x48f109)=>{const _0x10a966=_0x3b0b1f;try{const {id:_0x41643e}=_0x51496b['params'],_0x53aaa2=await this[_0x10a966(0x142)][_0x10a966(0x10a)](_0x41643e);if(!_0x53aaa2)return _0x1c4515[_0x10a966(0x159)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x1c4515[_0x10a966(0x13e)]({'success':!![],'result':_0x53aaa2});}catch(_0x5933db){_0x48f109(_0x5933db);}},this[_0x3b0b1f(0x143)]=async(_0x230971,_0xa40bbc,_0x405762)=>{const _0xf5b3d9=_0x3b0b1f;try{const {id:_0x499ca9}=_0x230971[_0xf5b3d9(0x135)],_0x523ba1=_0x230971['user']?.['id'],_0x4be850=_0x230971[_0xf5b3d9(0x102)];if(!_0x523ba1)return _0xa40bbc[_0xf5b3d9(0x159)](0x191)[_0xf5b3d9(0x13e)]({'success':![],'message':'Unauthorized'});console[_0xf5b3d9(0x129)](_0xf5b3d9(0x15f)+_0x499ca9+_0xf5b3d9(0x133)+_0x523ba1),console[_0xf5b3d9(0x129)](_0xf5b3d9(0x145),_0x4be850);const _0x48e6ed=await this[_0xf5b3d9(0x142)][_0xf5b3d9(0x15d)](_0x523ba1,_0x499ca9,_0x4be850);if(!_0x48e6ed)return _0xa40bbc['status'](0x194)[_0xf5b3d9(0x13e)]({'success':![],'message':'Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop'});_0xa40bbc['json']({'success':!![],'message':_0xf5b3d9(0x101),'result':{'paymentId':_0x48e6ed['id'],'customerIp':_0x48e6ed[_0xf5b3d9(0x15b)],'customerUa':_0x48e6ed[_0xf5b3d9(0x109)],'customerCountry':_0x48e6ed[_0xf5b3d9(0x11a)],'updatedAt':_0x48e6ed[_0xf5b3d9(0x11d)]}});}catch(_0x273111){_0x405762(_0x273111);}},this[_0x3b0b1f(0x165)]=async(_0x2039fc,_0x12cea6,_0x57df10)=>{const _0x927f2b=_0x3b0b1f;try{const {id:_0x426bf6}=_0x2039fc[_0x927f2b(0x135)],{cardData:_0x889225,cardHolder:_0x5dc3a8,browser:_0x230ee7}=_0x2039fc['body'];console[_0x927f2b(0x129)](_0x927f2b(0x137)+_0x426bf6);const _0x5ebb3e=await database_1[_0x927f2b(0x110)][_0x927f2b(0xfa)][_0x927f2b(0x12c)]({'where':{'id':_0x426bf6},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5ebb3e)return _0x12cea6['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x5ebb3e[_0x927f2b(0x122)]!=='mastercard')return _0x12cea6[_0x927f2b(0x159)](0x190)[_0x927f2b(0x13e)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x5ebb3e['status']!==_0x927f2b(0x13f))return _0x12cea6[_0x927f2b(0x159)](0x190)['json']({'success':![],'message':_0x927f2b(0x107)+_0x5ebb3e[_0x927f2b(0x159)]+_0x927f2b(0x155)});const _0x539778=_0x927f2b(0x104),_0x284296=_0x5ebb3e[_0x927f2b(0x161)];console[_0x927f2b(0x129)](_0x927f2b(0x12e)),console[_0x927f2b(0x129)](_0x927f2b(0x118)+_0x539778),console['log'](_0x927f2b(0x15a)+_0x284296);const _0x5d6d79=await this[_0x927f2b(0x148)]['processCardPayment']({'paymentId':_0x5ebb3e['id'],'orderId':_0x5ebb3e[_0x927f2b(0x12d)]||_0x5ebb3e['id'],'amount':_0x5ebb3e[_0x927f2b(0x100)],'currency':_0x5ebb3e[_0x927f2b(0x10d)],'cardData':_0x889225,'resultUrl':_0x539778,'returnUrl':_0x284296,'cardHolder':_0x5dc3a8,'browser':_0x230ee7});console[_0x927f2b(0x129)](_0x927f2b(0x132),_0x5d6d79);const _0x2e447e={'status':_0x5d6d79[_0x927f2b(0x159)],'updatedAt':new Date(),'statusChangedBy':_0x927f2b(0xf6),'statusChangedAt':new Date()};if(_0x5d6d79['status']===_0x927f2b(0x140))_0x2e447e['paidAt']=new Date(),_0x2e447e[_0x927f2b(0x156)]=_0x5d6d79['gateway_payment_id'];else _0x5d6d79[_0x927f2b(0x159)]==='FAILED'&&(_0x2e447e[_0x927f2b(0x12f)]=_0x927f2b(0x146));_0x2e447e[_0x927f2b(0x10b)]='mastercard',await database_1['default'][_0x927f2b(0xfa)][_0x927f2b(0x11b)]({'where':{'id':_0x5ebb3e['id']},'data':_0x2e447e}),await database_1['default'][_0x927f2b(0x139)][_0x927f2b(0x158)]({'data':{'paymentId':_0x5ebb3e['id'],'shopId':_0x5ebb3e['shopId'],'event':'mastercard_'+_0x5d6d79['status']?.[_0x927f2b(0x136)](),'statusCode':0xc8,'responseBody':JSON[_0x927f2b(0x114)]({'oldStatus':'PENDING','newStatus':_0x5d6d79['status'],'gatewayPaymentId':_0x5d6d79[_0x927f2b(0x150)],'requires3ds':_0x5d6d79[_0x927f2b(0xf8)],'processedAt':new Date()['toISOString']()})}});_0x5d6d79[_0x927f2b(0xf4)]&&(await this['sendShopWebhook'](_0x5ebb3e,_0x5d6d79[_0x927f2b(0x159)],_0x5d6d79[_0x927f2b(0x150)]),await this['sendPaymentStatusNotification'](_0x5ebb3e,_0x5d6d79[_0x927f2b(0x159)]));console[_0x927f2b(0x129)]('‚úÖ\x20MasterCard\x20payment\x20'+_0x426bf6+_0x927f2b(0x119)+_0x5d6d79['status']);if(_0x5d6d79[_0x927f2b(0x159)]===_0x927f2b(0x140))_0x12cea6[_0x927f2b(0x13e)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x927f2b(0x140),'gatewayPaymentId':_0x5d6d79[_0x927f2b(0x150)],'redirectUrl':_0x284296,'final':!![]}});else _0x5d6d79[_0x927f2b(0xf8)]&&_0x5d6d79[_0x927f2b(0x11c)]?_0x12cea6[_0x927f2b(0x13e)]({'success':!![],'message':_0x927f2b(0x115),'result':{'status':_0x927f2b(0x13f),'gatewayPaymentId':_0x5d6d79[_0x927f2b(0x150)],'redirectUrl':_0x5d6d79[_0x927f2b(0x11c)],'requires3ds':!![],'final':![]}}):_0x12cea6[_0x927f2b(0x159)](0x190)['json']({'success':![],'message':_0x927f2b(0x116),'result':{'status':_0x927f2b(0xfb),'gatewayPaymentId':_0x5d6d79[_0x927f2b(0x150)],'redirectUrl':_0x5ebb3e['failUrl'],'final':!![]}});}catch(_0x2954a0){_0x57df10(_0x2954a0);}},this[_0x3b0b1f(0x142)]=new paymentService_1['PaymentService'](),this['masterCardService']=new mastercardService_1[(_0x3b0b1f(0x144))](),this[_0x3b0b1f(0xf9)]=new webhookService_1[(_0x3b0b1f(0x14c))]();}async[a8_0x53465d(0x14e)](_0x2025ac,_0x53e6bf,_0xd14971){const _0x46a36c=a8_0x53465d,_0x3a04bc=Date[_0x46a36c(0x121)]();try{const _0x56b71c=_0x2025ac[_0x46a36c(0x149)],_0x21f578=_0x56b71c['settings'];if(!_0x21f578?.[_0x46a36c(0x13d)]){console[_0x46a36c(0x129)](_0x46a36c(0x127)+_0x56b71c['id']);return;}const _0x35849d=_0x53e6bf===_0x46a36c(0x140)?_0x46a36c(0x138):'payment.failed';let _0x1375a4=[];if(_0x21f578[_0x46a36c(0x163)])try{_0x1375a4=Array[_0x46a36c(0x10f)](_0x21f578['webhookEvents'])?_0x21f578[_0x46a36c(0x163)]:JSON['parse'](_0x21f578[_0x46a36c(0x163)]);}catch(_0x2c5fe7){console[_0x46a36c(0x113)](_0x46a36c(0x153),_0x2c5fe7),_0x1375a4=[];}if(!_0x1375a4[_0x46a36c(0x15e)](_0x35849d)){console['log'](_0x46a36c(0x10c)+_0x35849d+'\x20not\x20enabled\x20for\x20shop\x20'+_0x56b71c['id']);return;}const _0x278707={'event':_0x35849d,'payment':{'id':_0x2025ac['id'],'order_id':_0x2025ac[_0x46a36c(0x130)],'gateway_order_id':_0x2025ac[_0x46a36c(0x12d)],'gateway':_0x46a36c(0x106),'amount':_0x2025ac[_0x46a36c(0x100)],'currency':_0x2025ac['currency'],'status':_0x53e6bf['toLowerCase'](),'customer_email':_0x2025ac['customerEmail'],'customer_name':_0x2025ac[_0x46a36c(0x14f)],'gateway_payment_id':_0xd14971,'created_at':_0x2025ac[_0x46a36c(0x14b)],'updated_at':new Date()}},_0x3b3ee6=await fetch(_0x21f578[_0x46a36c(0x13d)],{'method':_0x46a36c(0x11f),'headers':{'Content-Type':'application/json','User-Agent':_0x46a36c(0x131)},'body':JSON['stringify'](_0x278707)}),_0x4f9a47=Date[_0x46a36c(0x121)]()-_0x3a04bc;console[_0x46a36c(0x129)](_0x46a36c(0xfd)+_0x21f578[_0x46a36c(0x13d)]+_0x46a36c(0x124)+_0x3b3ee6[_0x46a36c(0x159)]+'\x20('+_0x4f9a47+'ms)');}catch(_0xa1e7ff){console[_0x46a36c(0x113)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0xa1e7ff);}}async[a8_0x53465d(0x108)](_0x24e282,_0x5daa20){const _0x227eb0=a8_0x53465d;try{const {telegramBotService:_0xb14690}=await Promise[_0x227eb0(0x15c)]()['then'](()=>__importStar(require(_0x227eb0(0xf7)))),_0x52a28b={'PAID':_0x227eb0(0x164),'FAILED':_0x227eb0(0x14d)},_0x33d320=_0x52a28b[_0x5daa20];if(!_0x33d320)return;await _0xb14690[_0x227eb0(0x11e)](_0x24e282[_0x227eb0(0x105)],_0x24e282,_0x33d320);}catch(_0x41ae21){console[_0x227eb0(0x113)](_0x227eb0(0x111),_0x41ae21);}}}exports['PaymentController']=PaymentController;