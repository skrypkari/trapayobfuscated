'use strict';const a8_0x136a09=a8_0x18d9;(function(_0x51533e,_0x42867a){const _0x267213=a8_0x18d9,_0x401c7b=_0x51533e();while(!![]){try{const _0x553c40=parseInt(_0x267213(0x130))/0x1*(parseInt(_0x267213(0x114))/0x2)+parseInt(_0x267213(0x13d))/0x3*(-parseInt(_0x267213(0x171))/0x4)+parseInt(_0x267213(0x120))/0x5+-parseInt(_0x267213(0x136))/0x6+-parseInt(_0x267213(0x165))/0x7*(parseInt(_0x267213(0x16e))/0x8)+-parseInt(_0x267213(0x12c))/0x9*(parseInt(_0x267213(0x162))/0xa)+-parseInt(_0x267213(0x16c))/0xb*(-parseInt(_0x267213(0x118))/0xc);if(_0x553c40===_0x42867a)break;else _0x401c7b['push'](_0x401c7b['shift']());}catch(_0x1b5f8d){_0x401c7b['push'](_0x401c7b['shift']());}}}(a8_0x4245,0x95388));var __createBinding=this&&this[a8_0x136a09(0x13f)]||(Object['create']?function(_0x2b1d4d,_0x2935f3,_0x3fad17,_0x14ac2e){const _0x5ef587=a8_0x136a09;if(_0x14ac2e===undefined)_0x14ac2e=_0x3fad17;var _0x27d36a=Object[_0x5ef587(0x177)](_0x2935f3,_0x3fad17);(!_0x27d36a||('get'in _0x27d36a?!_0x2935f3[_0x5ef587(0x167)]:_0x27d36a[_0x5ef587(0x150)]||_0x27d36a[_0x5ef587(0x16f)]))&&(_0x27d36a={'enumerable':!![],'get':function(){return _0x2935f3[_0x3fad17];}}),Object['defineProperty'](_0x2b1d4d,_0x14ac2e,_0x27d36a);}:function(_0x4da071,_0x71a78d,_0x4180ce,_0x1dbc7e){if(_0x1dbc7e===undefined)_0x1dbc7e=_0x4180ce;_0x4da071[_0x1dbc7e]=_0x71a78d[_0x4180ce];}),__setModuleDefault=this&&this[a8_0x136a09(0x134)]||(Object[a8_0x136a09(0x169)]?function(_0x336faa,_0x190b31){Object['defineProperty'](_0x336faa,'default',{'enumerable':!![],'value':_0x190b31});}:function(_0x4bba64,_0x48e9d6){const _0x4b28f2=a8_0x136a09;_0x4bba64[_0x4b28f2(0x15f)]=_0x48e9d6;}),__importStar=this&&this[a8_0x136a09(0x15e)]||(function(){var _0x5d43da=function(_0x56dba5){const _0x21615e=a8_0x18d9;return _0x5d43da=Object[_0x21615e(0x14c)]||function(_0x4cad76){const _0xbd027e=_0x21615e;var _0x475a45=[];for(var _0x180909 in _0x4cad76)if(Object['prototype']['hasOwnProperty'][_0xbd027e(0x148)](_0x4cad76,_0x180909))_0x475a45[_0x475a45[_0xbd027e(0x13a)]]=_0x180909;return _0x475a45;},_0x5d43da(_0x56dba5);};return function(_0x1f8b16){const _0x1aa6bf=a8_0x18d9;if(_0x1f8b16&&_0x1f8b16[_0x1aa6bf(0x167)])return _0x1f8b16;var _0x360ac4={};if(_0x1f8b16!=null){for(var _0x4083e1=_0x5d43da(_0x1f8b16),_0x5b92a2=0x0;_0x5b92a2<_0x4083e1['length'];_0x5b92a2++)if(_0x4083e1[_0x5b92a2]!==_0x1aa6bf(0x15f))__createBinding(_0x360ac4,_0x1f8b16,_0x4083e1[_0x5b92a2]);}return __setModuleDefault(_0x360ac4,_0x1f8b16),_0x360ac4;};}()),__importDefault=this&&this['__importDefault']||function(_0x2e4d1b){const _0x562dbc=a8_0x136a09;return _0x2e4d1b&&_0x2e4d1b[_0x562dbc(0x167)]?_0x2e4d1b:{'default':_0x2e4d1b};};Object[a8_0x136a09(0x132)](exports,a8_0x136a09(0x167),{'value':!![]}),exports[a8_0x136a09(0x17c)]=void 0x0;function a8_0x4245(){const _0x577fe3=['requires_3ds','âœ…\x20MasterCard\x20payment\x20','198vReHaO','webhookEvents','8BomuRQ','configurable','threeds_url','3376Taowfi','paymentService','currency','FAILED','settings','ðŸ’³\x20MasterCard\x20URLs:','getOwnPropertyDescriptor','../services/telegramBotService','stringify','MasterCard\x20webhook\x20sent\x20to\x20','json','PaymentController','Payment\x20failed','now','final','sendShopWebhook','successUrl','214bwVYrH','../config/database','webhookService','createPublicPayment','1294476JPWKWC','getPaymentById','processCardPayment','\x20not\x20enabled\x20for\x20shop\x20','ms)','masterCardService','\x20\x20\x20Return\x20URL:\x20','body','3957375XdKkPQ','webhookLog','PAID','payment.success','includes','paymentMethod','paidAt','Webhook\x20event\x20','PENDING','parse','payment.failed','status','5863842UNeOEB','ðŸ’³\x20MasterCard\x20result:','application/json','gateway_payment_id','4490YPfiOE','resolve','defineProperty','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','__setModuleDefault','customerName','1509390XitQmC','findUnique','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','gatewayPaymentId','length','system','toLowerCase','3342heIezU','params','__createBinding','mastercard_','WebhookService','getPaymentStatus','gatewayOrderId','\x20processed:\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Error\x20parsing\x20webhook\x20events:','webhookUrl','call','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','\x20with\x20status\x20','error','getOwnPropertyNames','failUrl','MasterCardService','failureMessage','writable','log','1111','../services/gateways/mastercardService','PaymentService','https://api.trapay.uk/api/webhooks/gateway/mastercard','sendPaymentNotification','Payment\x20not\x20found','then','createdAt','../services/webhookService','isArray','processMasterCardPayment','payment','__importStar','default','../services/paymentService','shopId','10jnwPcj','Payment\x20status\x20is\x20','mastercard','5313644cbWnsf','3DS\x20verification\x20required','__esModule','sendPaymentStatusNotification','create'];a8_0x4245=function(){return _0x577fe3;};return a8_0x4245();}function a8_0x18d9(_0x43e2c0,_0x2016d3){const _0x4245ea=a8_0x4245();return a8_0x18d9=function(_0x18d9ff,_0x26f421){_0x18d9ff=_0x18d9ff-0x10f;let _0x1ea31a=_0x4245ea[_0x18d9ff];return _0x1ea31a;},a8_0x18d9(_0x43e2c0,_0x2016d3);}const paymentService_1=require(a8_0x136a09(0x160)),mastercardService_1=require(a8_0x136a09(0x153)),webhookService_1=require(a8_0x136a09(0x15a)),database_1=__importDefault(require(a8_0x136a09(0x115)));class PaymentController{constructor(){const _0x43c580=a8_0x136a09;this[_0x43c580(0x117)]=async(_0x20a8b0,_0x369612,_0x3bbca5)=>{const _0x783a68=_0x43c580;try{const _0x329afc=_0x20a8b0[_0x783a68(0x11f)],_0x26981a=await this[_0x783a68(0x172)]['createPublicPayment'](_0x329afc);_0x369612['status'](0xc9)[_0x783a68(0x17b)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x26981a});}catch(_0x4afa81){_0x3bbca5(_0x4afa81);}},this[_0x43c580(0x142)]=async(_0xa42189,_0x1bc61b,_0x44c457)=>{const _0x26376b=_0x43c580;try{const {id:_0x24878c}=_0xa42189['params'],_0x559d77=await this[_0x26376b(0x172)][_0x26376b(0x142)](_0x24878c);if(!_0x559d77)return _0x1bc61b[_0x26376b(0x12b)](0x194)[_0x26376b(0x17b)]({'success':![],'message':_0x26376b(0x157)});_0x1bc61b[_0x26376b(0x17b)]({'success':!![],'result':_0x559d77});}catch(_0x509232){_0x44c457(_0x509232);}},this[_0x43c580(0x119)]=async(_0xa66926,_0x58c37f,_0x8071ea)=>{const _0x247bae=_0x43c580;try{const {id:_0x5be04e}=_0xa66926[_0x247bae(0x13e)],_0x244f7d=await this[_0x247bae(0x172)][_0x247bae(0x119)](_0x5be04e);if(!_0x244f7d)return _0x58c37f[_0x247bae(0x12b)](0x194)[_0x247bae(0x17b)]({'success':![],'message':_0x247bae(0x157)});_0x58c37f[_0x247bae(0x17b)]({'success':!![],'result':_0x244f7d});}catch(_0x45015f){_0x8071ea(_0x45015f);}},this[_0x43c580(0x15c)]=async(_0xcb6b3f,_0x419c26,_0x49aee5)=>{const _0x78c2ce=_0x43c580;try{const {id:_0x1d5b1d}=_0xcb6b3f[_0x78c2ce(0x13e)],{cardData:_0x251564,cardHolder:_0x3075bc,browser:_0x568fb3}=_0xcb6b3f[_0x78c2ce(0x11f)];console[_0x78c2ce(0x151)](_0x78c2ce(0x133)+_0x1d5b1d);const _0x2d1bd6=await database_1['default'][_0x78c2ce(0x15d)][_0x78c2ce(0x137)]({'where':{'id':_0x1d5b1d},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x2d1bd6)return _0x419c26[_0x78c2ce(0x12b)](0x194)[_0x78c2ce(0x17b)]({'success':![],'message':_0x78c2ce(0x157)});if(_0x2d1bd6['gateway']!=='mastercard')return _0x419c26[_0x78c2ce(0x12b)](0x190)['json']({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x2d1bd6['status']!==_0x78c2ce(0x128))return _0x419c26[_0x78c2ce(0x12b)](0x190)[_0x78c2ce(0x17b)]({'success':![],'message':_0x78c2ce(0x163)+_0x2d1bd6['status']+',\x20cannot\x20process'});const _0x411f44=_0x78c2ce(0x155),_0xf7b6bb=_0x2d1bd6[_0x78c2ce(0x113)];console[_0x78c2ce(0x151)](_0x78c2ce(0x176)),console['log'](_0x78c2ce(0x145)+_0x411f44),console[_0x78c2ce(0x151)](_0x78c2ce(0x11e)+_0xf7b6bb);const _0x42acd8=await this[_0x78c2ce(0x11d)][_0x78c2ce(0x11a)]({'paymentId':_0x2d1bd6['id'],'orderId':_0x2d1bd6[_0x78c2ce(0x143)]||_0x2d1bd6['id'],'amount':_0x2d1bd6['amount'],'currency':_0x2d1bd6[_0x78c2ce(0x173)],'cardData':_0x251564,'resultUrl':_0x411f44,'returnUrl':_0xf7b6bb,'cardHolder':_0x3075bc,'browser':_0x568fb3});console['log'](_0x78c2ce(0x12d),_0x42acd8);const _0x5c1c2b={'status':_0x42acd8[_0x78c2ce(0x12b)],'updatedAt':new Date(),'statusChangedBy':_0x78c2ce(0x13b),'statusChangedAt':new Date()};if(_0x42acd8[_0x78c2ce(0x12b)]===_0x78c2ce(0x122))_0x5c1c2b[_0x78c2ce(0x126)]=new Date(),_0x5c1c2b[_0x78c2ce(0x139)]=_0x42acd8[_0x78c2ce(0x12f)];else _0x42acd8[_0x78c2ce(0x12b)]===_0x78c2ce(0x174)&&(_0x5c1c2b[_0x78c2ce(0x14f)]='Card\x20payment\x20failed');_0x5c1c2b[_0x78c2ce(0x125)]=_0x78c2ce(0x164),await database_1['default'][_0x78c2ce(0x15d)]['update']({'where':{'id':_0x2d1bd6['id']},'data':_0x5c1c2b}),await database_1[_0x78c2ce(0x15f)][_0x78c2ce(0x121)][_0x78c2ce(0x169)]({'data':{'paymentId':_0x2d1bd6['id'],'shopId':_0x2d1bd6[_0x78c2ce(0x161)],'event':_0x78c2ce(0x140)+_0x42acd8[_0x78c2ce(0x12b)]?.[_0x78c2ce(0x13c)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x78c2ce(0x128),'newStatus':_0x42acd8[_0x78c2ce(0x12b)],'gatewayPaymentId':_0x42acd8['gateway_payment_id'],'requires3ds':_0x42acd8[_0x78c2ce(0x16a)],'processedAt':new Date()['toISOString']()})}});_0x42acd8[_0x78c2ce(0x111)]&&(await this[_0x78c2ce(0x112)](_0x2d1bd6,_0x42acd8[_0x78c2ce(0x12b)],_0x42acd8[_0x78c2ce(0x12f)]),await this[_0x78c2ce(0x168)](_0x2d1bd6,_0x42acd8[_0x78c2ce(0x12b)]));console['log'](_0x78c2ce(0x16b)+_0x1d5b1d+_0x78c2ce(0x144)+_0x42acd8['status']);if(_0x42acd8[_0x78c2ce(0x12b)]===_0x78c2ce(0x122))_0x419c26['json']({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','gatewayPaymentId':_0x42acd8['gateway_payment_id'],'redirectUrl':_0xf7b6bb,'final':!![]}});else _0x42acd8['requires_3ds']&&_0x42acd8[_0x78c2ce(0x170)]?_0x419c26['json']({'success':!![],'message':_0x78c2ce(0x166),'result':{'status':'PENDING','gatewayPaymentId':_0x42acd8[_0x78c2ce(0x12f)],'redirectUrl':_0x42acd8[_0x78c2ce(0x170)],'requires3ds':!![],'final':![]}}):_0x419c26['status'](0x190)['json']({'success':![],'message':_0x78c2ce(0x10f),'result':{'status':_0x78c2ce(0x174),'gatewayPaymentId':_0x42acd8[_0x78c2ce(0x12f)],'redirectUrl':_0x2d1bd6[_0x78c2ce(0x14d)],'final':!![]}});}catch(_0x1fb6c1){_0x49aee5(_0x1fb6c1);}},this[_0x43c580(0x172)]=new paymentService_1[(_0x43c580(0x154))](),this[_0x43c580(0x11d)]=new mastercardService_1[(_0x43c580(0x14e))](),this[_0x43c580(0x116)]=new webhookService_1[(_0x43c580(0x141))]();}async[a8_0x136a09(0x112)](_0x3d8b3c,_0x56719d,_0x5a7ca7){const _0x44d6a6=a8_0x136a09,_0x4f924e=Date[_0x44d6a6(0x110)]();try{const _0x2b9d17=_0x3d8b3c['shop'],_0x1fa129=_0x2b9d17[_0x44d6a6(0x175)];if(!_0x1fa129?.[_0x44d6a6(0x147)]){console[_0x44d6a6(0x151)](_0x44d6a6(0x149)+_0x2b9d17['id']);return;}const _0x1a1982=_0x56719d==='PAID'?_0x44d6a6(0x123):_0x44d6a6(0x12a);let _0x5c84c2=[];if(_0x1fa129[_0x44d6a6(0x16d)])try{_0x5c84c2=Array[_0x44d6a6(0x15b)](_0x1fa129[_0x44d6a6(0x16d)])?_0x1fa129[_0x44d6a6(0x16d)]:JSON[_0x44d6a6(0x129)](_0x1fa129['webhookEvents']);}catch(_0x102d60){console[_0x44d6a6(0x14b)](_0x44d6a6(0x146),_0x102d60),_0x5c84c2=[];}if(!_0x5c84c2[_0x44d6a6(0x124)](_0x1a1982)){console[_0x44d6a6(0x151)](_0x44d6a6(0x127)+_0x1a1982+_0x44d6a6(0x11b)+_0x2b9d17['id']);return;}const _0x448e9f={'event':_0x1a1982,'payment':{'id':_0x3d8b3c['id'],'order_id':_0x3d8b3c['orderId'],'gateway_order_id':_0x3d8b3c[_0x44d6a6(0x143)],'gateway':_0x44d6a6(0x152),'amount':_0x3d8b3c['amount'],'currency':_0x3d8b3c[_0x44d6a6(0x173)],'status':_0x56719d[_0x44d6a6(0x13c)](),'customer_email':_0x3d8b3c['customerEmail'],'customer_name':_0x3d8b3c[_0x44d6a6(0x135)],'gateway_payment_id':_0x5a7ca7,'created_at':_0x3d8b3c[_0x44d6a6(0x159)],'updated_at':new Date()}},_0x1e2508=await fetch(_0x1fa129[_0x44d6a6(0x147)],{'method':'POST','headers':{'Content-Type':_0x44d6a6(0x12e),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x44d6a6(0x179)](_0x448e9f)}),_0x55525d=Date[_0x44d6a6(0x110)]()-_0x4f924e;console['log'](_0x44d6a6(0x17a)+_0x1fa129[_0x44d6a6(0x147)]+_0x44d6a6(0x14a)+_0x1e2508[_0x44d6a6(0x12b)]+'\x20('+_0x55525d+_0x44d6a6(0x11c));}catch(_0x31838e){console[_0x44d6a6(0x14b)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x31838e);}}async[a8_0x136a09(0x168)](_0x18d877,_0x48ad92){const _0x15415b=a8_0x136a09;try{const {telegramBotService:_0xf1721}=await Promise[_0x15415b(0x131)]()[_0x15415b(0x158)](()=>__importStar(require(_0x15415b(0x178)))),_0x510ee3={'PAID':'paid','FAILED':'failed'},_0xe312c8=_0x510ee3[_0x48ad92];if(!_0xe312c8)return;await _0xf1721[_0x15415b(0x156)](_0x18d877[_0x15415b(0x161)],_0x18d877,_0xe312c8);}catch(_0x16246b){console['error'](_0x15415b(0x138),_0x16246b);}}}exports[a8_0x136a09(0x17c)]=PaymentController;