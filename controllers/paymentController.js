'use strict';function a8_0xd82f(_0x780c02,_0x5eaf2f){const _0x4a23bf=a8_0x4a23();return a8_0xd82f=function(_0xd82f43,_0x46ba15){_0xd82f43=_0xd82f43-0x13b;let _0x1b0450=_0x4a23bf[_0xd82f43];return _0x1b0450;},a8_0xd82f(_0x780c02,_0x5eaf2f);}const a8_0x127cd5=a8_0xd82f;(function(_0x4723e9,_0x10bf61){const _0x458c5c=a8_0xd82f,_0x1ae33a=_0x4723e9();while(!![]){try{const _0x445583=parseInt(_0x458c5c(0x161))/0x1*(parseInt(_0x458c5c(0x196))/0x2)+-parseInt(_0x458c5c(0x151))/0x3+parseInt(_0x458c5c(0x15b))/0x4*(-parseInt(_0x458c5c(0x176))/0x5)+-parseInt(_0x458c5c(0x146))/0x6*(parseInt(_0x458c5c(0x142))/0x7)+-parseInt(_0x458c5c(0x1b6))/0x8+parseInt(_0x458c5c(0x18b))/0x9+parseInt(_0x458c5c(0x16f))/0xa;if(_0x445583===_0x10bf61)break;else _0x1ae33a['push'](_0x1ae33a['shift']());}catch(_0x37481d){_0x1ae33a['push'](_0x1ae33a['shift']());}}}(a8_0x4a23,0x4243d));function a8_0x4a23(){const _0xaf9bd9=['system','customerUa','configurable','log','MasterCard\x20webhook\x20sent\x20to\x20','PaymentController','create','Payment\x20failed','paymentService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','PAID','14NPqBOy','cardLast4','user_agent','__esModule','1242726bVdmKU','\x20\x20\x20Result\x20URL\x20(webhook):\x20','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','slice','toLowerCase','updatePaymentCustomerDataPublic','‚úÖ\x20MasterCard\x20payment\x20','Payment\x20status\x20is\x20','orderId','country','settings','1030968sDtzgv','paymentMethod','threeds_url',',\x20cannot\x20process','PaymentService','MasterCardService','getPaymentStatus','__importDefault','\x20\x20\x20Return\x20URL:\x20','webhookUrl','11708UXgpGE','sendPaymentNotification','getPaymentById','masterCardService','payment','shopId','1WZFWfj','../config/database','first_name','üìù\x20Customer\x20data:','üí≥\x20Browser\x20IP:\x20','sendShopWebhook','https://api.trapay.uk/api/webhooks/gateway/mastercard','params','webhookService','failed','failUrl','Payment\x20processed\x20successfully','defineProperty','1111','12606150AfFRrl','number','length','createPublicPayment','writable','final','call','515NdlCpO','FAILED','customerName','now','shop','createdAt','hasOwnProperty','__createBinding','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','__importStar','failureMessage','../services/gateways/mastercardService','webhookLog','replace','üí≥\x20MasterCard\x20result:','3DS\x20verification\x20required','last_name','email','gatewayPaymentId','Payment\x20not\x20found','updatedAt','1620126NSFRVb','prototype','payment.success','then','getOwnPropertyNames','requires_3ds','paidAt','resolve','üí≥\x20Card\x20holder:\x20','mastercard','processMasterCardPayment','517934EqnxxP','webhookEvents','amount','default','Error\x20parsing\x20webhook\x20events:','json','\x20processed:\x20','paid','toISOString','handleSuccessfulPayment','stringify','mastercard_','Webhook\x20event\x20','parse','body','gateway_payment_id','../services/telegramBotService','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','../services/webhookService','error','../services/paymentLinkService','Payment\x20created\x20successfully','updatePaymentCustomer','getOwnPropertyDescriptor','update','gatewayOrderId','customerIp','../services/paymentService','application/json','\x20not\x20enabled\x20for\x20shop\x20','PENDING','currency','2950368OnhMtU','status','sendPaymentStatusNotification','customerEmail'];a8_0x4a23=function(){return _0xaf9bd9;};return a8_0x4a23();}var __createBinding=this&&this[a8_0x127cd5(0x17d)]||(Object[a8_0x127cd5(0x13c)]?function(_0x3947a4,_0x1b7acc,_0x3ebbca,_0x2c9ad6){const _0x51dc87=a8_0x127cd5;if(_0x2c9ad6===undefined)_0x2c9ad6=_0x3ebbca;var _0x3046f6=Object[_0x51dc87(0x1ad)](_0x1b7acc,_0x3ebbca);(!_0x3046f6||('get'in _0x3046f6?!_0x1b7acc[_0x51dc87(0x145)]:_0x3046f6[_0x51dc87(0x173)]||_0x3046f6[_0x51dc87(0x1bc)]))&&(_0x3046f6={'enumerable':!![],'get':function(){return _0x1b7acc[_0x3ebbca];}}),Object[_0x51dc87(0x16d)](_0x3947a4,_0x2c9ad6,_0x3046f6);}:function(_0xc38cb9,_0x1f22a6,_0x1d6eea,_0x3fe6e4){if(_0x3fe6e4===undefined)_0x3fe6e4=_0x1d6eea;_0xc38cb9[_0x3fe6e4]=_0x1f22a6[_0x1d6eea];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x127cd5(0x13c)]?function(_0x83d469,_0x39febb){const _0x40f4e3=a8_0x127cd5;Object['defineProperty'](_0x83d469,_0x40f4e3(0x199),{'enumerable':!![],'value':_0x39febb});}:function(_0x235fee,_0x4a6808){_0x235fee['default']=_0x4a6808;}),__importStar=this&&this[a8_0x127cd5(0x17f)]||(function(){var _0x299f6b=function(_0x3db320){const _0x24a9a8=a8_0xd82f;return _0x299f6b=Object[_0x24a9a8(0x18f)]||function(_0x59b497){const _0x447e9f=_0x24a9a8;var _0x35fcd4=[];for(var _0x4e258a in _0x59b497)if(Object[_0x447e9f(0x18c)][_0x447e9f(0x17c)][_0x447e9f(0x175)](_0x59b497,_0x4e258a))_0x35fcd4[_0x35fcd4['length']]=_0x4e258a;return _0x35fcd4;},_0x299f6b(_0x3db320);};return function(_0x2da166){const _0x362b00=a8_0xd82f;if(_0x2da166&&_0x2da166[_0x362b00(0x145)])return _0x2da166;var _0x41344f={};if(_0x2da166!=null){for(var _0x2b987b=_0x299f6b(_0x2da166),_0x1c6b6e=0x0;_0x1c6b6e<_0x2b987b[_0x362b00(0x171)];_0x1c6b6e++)if(_0x2b987b[_0x1c6b6e]!=='default')__createBinding(_0x41344f,_0x2da166,_0x2b987b[_0x1c6b6e]);}return __setModuleDefault(_0x41344f,_0x2da166),_0x41344f;};}()),__importDefault=this&&this[a8_0x127cd5(0x158)]||function(_0x1980e6){return _0x1980e6&&_0x1980e6['__esModule']?_0x1980e6:{'default':_0x1980e6};};Object[a8_0x127cd5(0x16d)](exports,a8_0x127cd5(0x145),{'value':!![]}),exports[a8_0x127cd5(0x13b)]=void 0x0;const paymentService_1=require(a8_0x127cd5(0x1b1)),mastercardService_1=require(a8_0x127cd5(0x181)),webhookService_1=require(a8_0x127cd5(0x1a8)),database_1=__importDefault(require(a8_0x127cd5(0x162)));class PaymentController{constructor(){const _0x2e9486=a8_0x127cd5;this[_0x2e9486(0x172)]=async(_0x539b07,_0x66585d,_0x58b62f)=>{const _0x19a458=_0x2e9486;try{const _0x3bdf3d=_0x539b07[_0x19a458(0x1a4)],_0x1ff18b=await this[_0x19a458(0x13e)][_0x19a458(0x172)](_0x3bdf3d);_0x66585d[_0x19a458(0x1b7)](0xc9)['json']({'success':!![],'message':_0x19a458(0x1ab),'result':_0x1ff18b});}catch(_0x46f557){_0x58b62f(_0x46f557);}},this[_0x2e9486(0x157)]=async(_0x4c3d8a,_0x123298,_0x1a5c21)=>{const _0x2324e1=_0x2e9486;try{const {id:_0x16e84b}=_0x4c3d8a[_0x2324e1(0x168)],_0x5e3227=await this[_0x2324e1(0x13e)][_0x2324e1(0x157)](_0x16e84b);if(!_0x5e3227)return _0x123298[_0x2324e1(0x1b7)](0x194)[_0x2324e1(0x19b)]({'success':![],'message':'Payment\x20not\x20found'});_0x123298[_0x2324e1(0x19b)]({'success':!![],'result':_0x5e3227});}catch(_0x2221ee){_0x1a5c21(_0x2221ee);}},this[_0x2e9486(0x15d)]=async(_0x1a7f1b,_0x15fec4,_0x51da09)=>{const _0x3e4864=_0x2e9486;try{const {id:_0x56592f}=_0x1a7f1b['params'],_0x45dcc4=await this[_0x3e4864(0x13e)][_0x3e4864(0x15d)](_0x56592f);if(!_0x45dcc4)return _0x15fec4[_0x3e4864(0x1b7)](0x194)[_0x3e4864(0x19b)]({'success':![],'message':_0x3e4864(0x189)});_0x15fec4[_0x3e4864(0x19b)]({'success':!![],'result':_0x45dcc4});}catch(_0x3e5e28){_0x51da09(_0x3e5e28);}},this[_0x2e9486(0x1ac)]=async(_0x4ea057,_0x22bc15,_0x4c08ae)=>{const _0x3d29e7=_0x2e9486;try{const {id:_0x5cd16b}=_0x4ea057[_0x3d29e7(0x168)],_0x178ac2=_0x4ea057[_0x3d29e7(0x1a4)];console[_0x3d29e7(0x1bd)]('üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x5cd16b),console[_0x3d29e7(0x1bd)](_0x3d29e7(0x164),_0x178ac2);const _0x2bd6cb=await this[_0x3d29e7(0x13e)][_0x3d29e7(0x14b)](_0x5cd16b,_0x178ac2);if(!_0x2bd6cb)return _0x22bc15[_0x3d29e7(0x1b7)](0x194)['json']({'success':![],'message':_0x3d29e7(0x189)});_0x22bc15[_0x3d29e7(0x19b)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x2bd6cb['id'],'customerIp':_0x2bd6cb[_0x3d29e7(0x1b0)],'customerUa':_0x2bd6cb[_0x3d29e7(0x1bb)],'customerCountry':_0x2bd6cb['customerCountry'],'updatedAt':_0x2bd6cb[_0x3d29e7(0x18a)]}});}catch(_0x46e403){_0x4c08ae(_0x46e403);}},this[_0x2e9486(0x195)]=async(_0x42787d,_0x3566d8,_0x13d09a)=>{const _0x2dc4b6=_0x2e9486;try{const {id:_0x1853e8}=_0x42787d[_0x2dc4b6(0x168)],{cardData:_0x2cbf62,cardHolder:_0x5d06ee,browser:_0x4de53f}=_0x42787d[_0x2dc4b6(0x1a4)];console[_0x2dc4b6(0x1bd)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x1853e8),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x193)+_0x5d06ee[_0x2dc4b6(0x163)]+'\x20'+_0x5d06ee['last_name']+'\x20('+_0x5d06ee[_0x2dc4b6(0x187)]+')'),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x165)+_0x4de53f['ip']);const _0xe94d76={'customerName':_0x5d06ee[_0x2dc4b6(0x163)]+'\x20'+_0x5d06ee['last_name'],'customerEmail':_0x5d06ee[_0x2dc4b6(0x187)],'customerIp':_0x4de53f['ip'],'customerUa':_0x4de53f[_0x2dc4b6(0x144)],'customerCountry':_0x5d06ee[_0x2dc4b6(0x14f)]||null},_0x15e266=await database_1[_0x2dc4b6(0x199)][_0x2dc4b6(0x15f)]['findUnique']({'where':{'id':_0x1853e8},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15e266)return _0x3566d8[_0x2dc4b6(0x1b7)](0x194)[_0x2dc4b6(0x19b)]({'success':![],'message':_0x2dc4b6(0x189)});if(_0x15e266['gateway']!=='mastercard')return _0x3566d8['status'](0x190)[_0x2dc4b6(0x19b)]({'success':![],'message':_0x2dc4b6(0x17e)});if(_0x15e266[_0x2dc4b6(0x1b7)]!==_0x2dc4b6(0x1b4))return _0x3566d8['status'](0x190)[_0x2dc4b6(0x19b)]({'success':![],'message':_0x2dc4b6(0x14d)+_0x15e266[_0x2dc4b6(0x1b7)]+_0x2dc4b6(0x154)});await database_1[_0x2dc4b6(0x199)][_0x2dc4b6(0x15f)][_0x2dc4b6(0x1ae)]({'where':{'id':_0x1853e8},'data':{..._0xe94d76,'updatedAt':new Date()}});const _0x34c558=_0x2dc4b6(0x167),_0x23c269=_0x15e266['successUrl'];console[_0x2dc4b6(0x1bd)]('üí≥\x20MasterCard\x20URLs:'),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x147)+_0x34c558),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x159)+_0x23c269);const _0x8b86cc={'first_name':_0x5d06ee['first_name'],'last_name':_0x5d06ee[_0x2dc4b6(0x186)],'email':_0x5d06ee[_0x2dc4b6(0x187)]},_0x10cd90=await this[_0x2dc4b6(0x15e)]['processCardPayment']({'paymentId':_0x15e266['id'],'orderId':_0x15e266[_0x2dc4b6(0x1af)]||_0x15e266['id'],'amount':_0x15e266['amount'],'currency':_0x15e266['currency'],'cardData':_0x2cbf62,'resultUrl':_0x34c558,'returnUrl':_0x23c269,'cardHolder':_0x8b86cc,'browser':_0x4de53f});console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x184),_0x10cd90);const _0x42dae9={'status':_0x10cd90['status'],'updatedAt':new Date(),'statusChangedBy':_0x2dc4b6(0x1ba),'statusChangedAt':new Date()};if(_0x10cd90['status']===_0x2dc4b6(0x141))_0x42dae9[_0x2dc4b6(0x191)]=new Date(),_0x42dae9[_0x2dc4b6(0x188)]=_0x10cd90[_0x2dc4b6(0x1a5)];else _0x10cd90[_0x2dc4b6(0x1b7)]===_0x2dc4b6(0x177)&&(_0x42dae9[_0x2dc4b6(0x180)]='Card\x20payment\x20failed');_0x42dae9[_0x2dc4b6(0x152)]=_0x2dc4b6(0x194);if(_0x2cbf62[_0x2dc4b6(0x170)]){const _0x28c191=_0x2cbf62[_0x2dc4b6(0x170)][_0x2dc4b6(0x183)](/[\s-]/g,'');_0x42dae9[_0x2dc4b6(0x143)]=_0x28c191[_0x2dc4b6(0x149)](-0x4),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x1a7)+_0x42dae9[_0x2dc4b6(0x143)]);}await database_1['default'][_0x2dc4b6(0x15f)][_0x2dc4b6(0x1ae)]({'where':{'id':_0x15e266['id']},'data':_0x42dae9}),await database_1['default'][_0x2dc4b6(0x182)]['create']({'data':{'paymentId':_0x15e266['id'],'shopId':_0x15e266[_0x2dc4b6(0x160)],'event':_0x2dc4b6(0x1a1)+_0x10cd90[_0x2dc4b6(0x1b7)]?.[_0x2dc4b6(0x14a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x2dc4b6(0x1b4),'newStatus':_0x10cd90[_0x2dc4b6(0x1b7)],'gatewayPaymentId':_0x10cd90[_0x2dc4b6(0x1a5)],'requires3ds':_0x10cd90[_0x2dc4b6(0x190)],'processedAt':new Date()[_0x2dc4b6(0x19e)]()})}});if(_0x10cd90[_0x2dc4b6(0x174)]){await this['sendShopWebhook'](_0x15e266,_0x10cd90[_0x2dc4b6(0x1b7)],_0x10cd90[_0x2dc4b6(0x1a5)]),await this[_0x2dc4b6(0x1b8)](_0x15e266,_0x10cd90[_0x2dc4b6(0x1b7)]);if(_0x10cd90[_0x2dc4b6(0x1b7)]===_0x2dc4b6(0x141)){console[_0x2dc4b6(0x1bd)]('üìà\x20MasterCard\x20payment\x20'+_0x1853e8+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x50a76f}=await Promise[_0x2dc4b6(0x192)]()['then'](()=>__importStar(require(_0x2dc4b6(0x1aa)))),_0x46276e=new _0x50a76f();await _0x46276e[_0x2dc4b6(0x19f)](_0x1853e8),console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x148)+_0x1853e8);}catch(_0x4ffacb){console[_0x2dc4b6(0x1a9)](_0x2dc4b6(0x140),_0x4ffacb);}}}console[_0x2dc4b6(0x1bd)](_0x2dc4b6(0x14c)+_0x1853e8+_0x2dc4b6(0x19c)+_0x10cd90[_0x2dc4b6(0x1b7)]);if(_0x10cd90[_0x2dc4b6(0x1b7)]==='PAID')_0x3566d8['json']({'success':!![],'message':_0x2dc4b6(0x16c),'result':{'status':_0x2dc4b6(0x141),'gatewayPaymentId':_0x10cd90[_0x2dc4b6(0x1a5)],'redirectUrl':_0x23c269,'final':!![]}});else _0x10cd90[_0x2dc4b6(0x190)]&&_0x10cd90[_0x2dc4b6(0x153)]?_0x3566d8[_0x2dc4b6(0x19b)]({'success':!![],'message':_0x2dc4b6(0x185),'result':{'status':_0x2dc4b6(0x1b4),'gatewayPaymentId':_0x10cd90[_0x2dc4b6(0x1a5)],'redirectUrl':_0x10cd90[_0x2dc4b6(0x153)],'requires3ds':!![],'final':![]}}):_0x3566d8[_0x2dc4b6(0x1b7)](0x190)[_0x2dc4b6(0x19b)]({'success':![],'message':_0x2dc4b6(0x13d),'result':{'status':_0x2dc4b6(0x177),'gatewayPaymentId':_0x10cd90['gateway_payment_id'],'redirectUrl':_0x15e266[_0x2dc4b6(0x16b)],'final':!![]}});}catch(_0x4f6a89){_0x13d09a(_0x4f6a89);}},this[_0x2e9486(0x13e)]=new paymentService_1[(_0x2e9486(0x155))](),this['masterCardService']=new mastercardService_1[(_0x2e9486(0x156))](),this[_0x2e9486(0x169)]=new webhookService_1['WebhookService']();}async[a8_0x127cd5(0x166)](_0x1f758e,_0x1a4baa,_0x298d83){const _0x1d8ec0=a8_0x127cd5,_0x25ef81=Date[_0x1d8ec0(0x179)]();try{const _0x1f56a7=_0x1f758e[_0x1d8ec0(0x17a)],_0x3ceb15=_0x1f56a7[_0x1d8ec0(0x150)];if(!_0x3ceb15?.[_0x1d8ec0(0x15a)]){console[_0x1d8ec0(0x1bd)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1f56a7['id']);return;}const _0x20b429=_0x1a4baa==='PAID'?_0x1d8ec0(0x18d):'payment.failed';let _0x209bab=[];if(_0x3ceb15[_0x1d8ec0(0x197)])try{_0x209bab=Array['isArray'](_0x3ceb15[_0x1d8ec0(0x197)])?_0x3ceb15[_0x1d8ec0(0x197)]:JSON[_0x1d8ec0(0x1a3)](_0x3ceb15[_0x1d8ec0(0x197)]);}catch(_0x2f0712){console[_0x1d8ec0(0x1a9)](_0x1d8ec0(0x19a),_0x2f0712),_0x209bab=[];}if(!_0x209bab['includes'](_0x20b429)){console['log'](_0x1d8ec0(0x1a2)+_0x20b429+_0x1d8ec0(0x1b3)+_0x1f56a7['id']);return;}const _0x3e8d7c={'event':_0x20b429,'payment':{'id':_0x1f758e['id'],'order_id':_0x1f758e[_0x1d8ec0(0x14e)],'gateway_order_id':_0x1f758e[_0x1d8ec0(0x1af)],'gateway':_0x1d8ec0(0x16e),'amount':_0x1f758e[_0x1d8ec0(0x198)],'currency':_0x1f758e[_0x1d8ec0(0x1b5)],'status':_0x1a4baa['toLowerCase'](),'customer_email':_0x1f758e[_0x1d8ec0(0x1b9)],'customer_name':_0x1f758e[_0x1d8ec0(0x178)],'gateway_payment_id':_0x298d83,'created_at':_0x1f758e[_0x1d8ec0(0x17b)],'updated_at':new Date()}},_0x19a4fe=await fetch(_0x3ceb15['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1d8ec0(0x1b2),'User-Agent':_0x1d8ec0(0x13f)},'body':JSON[_0x1d8ec0(0x1a0)](_0x3e8d7c)}),_0x312889=Date['now']()-_0x25ef81;console[_0x1d8ec0(0x1bd)](_0x1d8ec0(0x1be)+_0x3ceb15[_0x1d8ec0(0x15a)]+'\x20with\x20status\x20'+_0x19a4fe[_0x1d8ec0(0x1b7)]+'\x20('+_0x312889+'ms)');}catch(_0x180c46){console[_0x1d8ec0(0x1a9)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x180c46);}}async[a8_0x127cd5(0x1b8)](_0x9a37af,_0x3ae255){const _0x2f4ce8=a8_0x127cd5;try{const {telegramBotService:_0x3477ca}=await Promise[_0x2f4ce8(0x192)]()[_0x2f4ce8(0x18e)](()=>__importStar(require(_0x2f4ce8(0x1a6)))),_0xd645b0={'PAID':_0x2f4ce8(0x19d),'FAILED':_0x2f4ce8(0x16a)},_0x54f9e2=_0xd645b0[_0x3ae255];if(!_0x54f9e2)return;await _0x3477ca[_0x2f4ce8(0x15c)](_0x9a37af[_0x2f4ce8(0x160)],_0x9a37af,_0x54f9e2);}catch(_0x345a2f){console[_0x2f4ce8(0x1a9)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x345a2f);}}}exports['PaymentController']=PaymentController;