'use strict';function a14_0x5d4e(_0x5d6a9d,_0x53fd1a){_0x5d6a9d=_0x5d6a9d-0x191;const _0x41ae64=a14_0x41ae();let _0x5d4e57=_0x41ae64[_0x5d6a9d];return _0x5d4e57;}function a14_0x41ae(){const _0x3ec73c=['üí≥\x20MasterCard\x20result:','phone','******','üìç\x20Billing\x20address\x20(string):','settings','VisaMasterCardService','getPaymentById','convertToUSDT','Error\x20parsing\x20webhook\x20events:','parse','POST','params','payment.failed','MASTERCARD','paymentMethod','failUrl','gatewayCommissionRate','paidAt','__setModuleDefault','currency','__importStar','customerEmail','updatePaymentStatus','getPaymentFingerprint','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','final','\x20not\x20enabled\x20for\x20shop\x20','amount','call','amountAfterGatewayCommissionUSDT','\x20\x20\x20Return\x20URL:\x20','payment','üìù\x20Customer\x20data:','paid','\x20webhook\x20sent\x20to\x20','replace','system','\x20payment\x20','billingCity','crypto','createdAt','‚úÖ\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','Customer\x20data\x20updated\x20successfully','gatewayPaymentId','findUnique','address_line_1','gatewayOrderId','paymentService','sendShopWebhook','\x20with\x20status\x20','webhookService','Payment\x20processed\x20successfully','createPublicPayment','trim','../services/binLookupService','slice','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','https://app.trapay.uk/payment/pending?id=','default','json','getPaymentStatus','üîç\x20Received\x20fingerprint\x20request\x20for\x20payment\x20','__esModule','hasOwnProperty','üí≥\x20Card\x20holder:\x20','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','\x20with\x20requestId\x20','CurrencyService','cardBinStatus','resolve','isArray','2WCPfbU','../services/gateways/mastercardService','10697666EGMFFp','üìä\x20BIN\x20lookup\x20result:','defineProperty','Failed\x20to\x20send\x20','startsWith','Payment\x20status\x20is\x20','failed','email','substring','getOwnPropertyNames','body','3DS\x20verification\x20required','\x22\x20|\x20\x22','\x20processed:\x20','first_name','üîç\x20Looking\x20up\x20BIN\x20for\x20card:','hex','join','visaMasterCardService','27HGBdDj','üí∞\x20Gateway\x20','user_agent','secretKey','VISA/MasterCard','358908wmXpAa','cardCountry','update','WebhookService','2749239URdsGO','UNKNOWN','requires_3ds','toISOString','prototype','log','toUpperCase','\x20\x20Original:\x20\x22','billingAddress','threeds_url','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','Payment\x20failed','9599630mdXtfe','üí≥\x20','cardLast4','Payment\x20not\x20found','gateway_payment_id','\x20USDT','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','PENDING','sendPaymentNotification','query','string','status','customerIp','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','üìà\x20','\x20\x20Cleaned:\x20\x20\x22','create','getOwnPropertyDescriptor','toFixed','üí∞\x20Converting\x20','lineStatus','\x20URLs:','includes','stringify','filter','sha256','handleSuccessfulPayment','1111','webhookLog','webhookUrl','state','FAILED','length','error','application/json','PAID','PaymentController','errorMessage','customerName','isValid','number','Bank\x20Card','shopId','failureMessage','amountUSDT','configurable','post_code','183192QEyFAz','../services/paymentService','../config/database','Payment\x20created\x20successfully','last_name','gateway','now','getGatewayCommission','cardCategory','cardIssuer','&payment_id=','üßπ\x20Customer\x20names\x20cleaned:','shop','cardBrand','cardType','currencyService','../services/webhookService','orderId','üí≥\x20Processing\x20MasterCard\x20payment:\x20','160aZZNha','1232191KZakdA','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','toLowerCase','customerCountry','binLookupService','\x20payment:','digest','Payment\x20System/1.0\x20(','Card\x20payment\x20failed','VISA','mastercard','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','../services/currencyService','webhookEvents','791144CPuLeg','postcode','ms)','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway'];a14_0x41ae=function(){return _0x3ec73c;};return a14_0x41ae();}const a14_0x158d99=a14_0x5d4e;(function(_0x3ed415,_0x1877c8){const _0x78f6ba=a14_0x5d4e,_0x5eb9c1=_0x3ed415();while(!![]){try{const _0x326220=parseInt(_0x78f6ba(0x1af))/0x1*(parseInt(_0x78f6ba(0x208))/0x2)+parseInt(_0x78f6ba(0x226))/0x3+parseInt(_0x78f6ba(0x19b))/0x4*(parseInt(_0x78f6ba(0x1ae))/0x5)+parseInt(_0x78f6ba(0x222))/0x6+-parseInt(_0x78f6ba(0x20a))/0x7+-parseInt(_0x78f6ba(0x1bd))/0x8*(parseInt(_0x78f6ba(0x21d))/0x9)+-parseInt(_0x78f6ba(0x232))/0xa;if(_0x326220===_0x1877c8)break;else _0x5eb9c1['push'](_0x5eb9c1['shift']());}catch(_0x4d1a4f){_0x5eb9c1['push'](_0x5eb9c1['shift']());}}}(a14_0x41ae,0xd90f6));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x34207a,_0xa945f5,_0x525d75,_0xda60b6){const _0x5be158=a14_0x5d4e;if(_0xda60b6===undefined)_0xda60b6=_0x525d75;var _0x57e5a3=Object[_0x5be158(0x243)](_0xa945f5,_0x525d75);(!_0x57e5a3||('get'in _0x57e5a3?!_0xa945f5[_0x5be158(0x1ff)]:_0x57e5a3['writable']||_0x57e5a3[_0x5be158(0x199)]))&&(_0x57e5a3={'enumerable':!![],'get':function(){return _0xa945f5[_0x525d75];}}),Object[_0x5be158(0x20c)](_0x34207a,_0xda60b6,_0x57e5a3);}:function(_0x200938,_0x267594,_0x596d60,_0x3b316e){if(_0x3b316e===undefined)_0x3b316e=_0x596d60;_0x200938[_0x3b316e]=_0x267594[_0x596d60];}),__setModuleDefault=this&&this[a14_0x158d99(0x1d3)]||(Object[a14_0x158d99(0x242)]?function(_0x351674,_0x1eae71){const _0xd64b4a=a14_0x158d99;Object[_0xd64b4a(0x20c)](_0x351674,_0xd64b4a(0x1fb),{'enumerable':!![],'value':_0x1eae71});}:function(_0xaae336,_0x275369){const _0x147f7d=a14_0x158d99;_0xaae336[_0x147f7d(0x1fb)]=_0x275369;}),__importStar=this&&this[a14_0x158d99(0x1d5)]||(function(){var _0x30a514=function(_0x5bd932){const _0x4ff784=a14_0x5d4e;return _0x30a514=Object[_0x4ff784(0x213)]||function(_0x539080){const _0x168e63=_0x4ff784;var _0x1a8a1b=[];for(var _0x1a65f3 in _0x539080)if(Object[_0x168e63(0x22a)][_0x168e63(0x200)][_0x168e63(0x1dd)](_0x539080,_0x1a65f3))_0x1a8a1b[_0x1a8a1b[_0x168e63(0x252)]]=_0x1a65f3;return _0x1a8a1b;},_0x30a514(_0x5bd932);};return function(_0x4777f2){const _0x36f06d=a14_0x5d4e;if(_0x4777f2&&_0x4777f2[_0x36f06d(0x1ff)])return _0x4777f2;var _0x445185={};if(_0x4777f2!=null){for(var _0x5cc8ea=_0x30a514(_0x4777f2),_0x332844=0x0;_0x332844<_0x5cc8ea[_0x36f06d(0x252)];_0x332844++)if(_0x5cc8ea[_0x332844]!==_0x36f06d(0x1fb))__createBinding(_0x445185,_0x4777f2,_0x5cc8ea[_0x332844]);}return __setModuleDefault(_0x445185,_0x4777f2),_0x445185;};}()),__importDefault=this&&this['__importDefault']||function(_0x21b5f0){return _0x21b5f0&&_0x21b5f0['__esModule']?_0x21b5f0:{'default':_0x21b5f0};};Object[a14_0x158d99(0x20c)](exports,a14_0x158d99(0x1ff),{'value':!![]}),exports[a14_0x158d99(0x256)]=void 0x0;const crypto_1=__importDefault(require(a14_0x158d99(0x1e8))),paymentService_1=require(a14_0x158d99(0x19c)),mastercardService_1=require(a14_0x158d99(0x209)),webhookService_1=require(a14_0x158d99(0x1ab)),currencyService_1=require(a14_0x158d99(0x1bb)),binLookupService_1=require(a14_0x158d99(0x1f7)),database_1=__importDefault(require(a14_0x158d99(0x19d)));class PaymentController{constructor(){const _0x27ac42=a14_0x158d99;this['createPublicPayment']=async(_0x1aa84e,_0x57fe2a,_0x341b53)=>{const _0x4e1db4=a14_0x5d4e;try{const _0xd6a236=_0x1aa84e[_0x4e1db4(0x214)],_0xd5a4e5=await this[_0x4e1db4(0x1f0)][_0x4e1db4(0x1f5)](_0xd6a236);_0x57fe2a[_0x4e1db4(0x23d)](0xc9)[_0x4e1db4(0x1fc)]({'success':!![],'message':_0x4e1db4(0x19e),'result':_0xd5a4e5});}catch(_0x26537c){_0x341b53(_0x26537c);}},this[_0x27ac42(0x1fd)]=async(_0x4ef523,_0x1a78e6,_0x11407c)=>{const _0x451f85=_0x27ac42;try{const {id:_0x162437}=_0x4ef523[_0x451f85(0x1cc)],_0x24f913=await this[_0x451f85(0x1f0)][_0x451f85(0x1fd)](_0x162437);if(!_0x24f913)return _0x1a78e6[_0x451f85(0x23d)](0x194)[_0x451f85(0x1fc)]({'success':![],'message':_0x451f85(0x235)});_0x1a78e6[_0x451f85(0x1fc)]({'success':!![],'result':_0x24f913});}catch(_0x2bb040){_0x11407c(_0x2bb040);}},this[_0x27ac42(0x1d8)]=async(_0x48faf2,_0x595c2d,_0x15b7c9)=>{const _0x110815=_0x27ac42;try{const {id:_0x47ccb6}=_0x48faf2[_0x110815(0x1cc)],{requestId:_0x3294b7}=_0x48faf2[_0x110815(0x23b)];if(typeof _0x3294b7!==_0x110815(0x23c))return _0x595c2d[_0x110815(0x23d)](0x190)[_0x110815(0x1fc)]({'success':![],'message':'requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string'});console[_0x110815(0x22b)](_0x110815(0x1fe)+_0x47ccb6+_0x110815(0x203)+_0x3294b7);const _0xe54303=await this[_0x110815(0x1f0)][_0x110815(0x1d8)](_0x47ccb6,_0x3294b7);if(!_0xe54303)return _0x595c2d[_0x110815(0x23d)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available'});console[_0x110815(0x22b)](_0x110815(0x1ea)+_0x47ccb6+':',_0xe54303),_0x595c2d[_0x110815(0x1fc)]({'success':!![],'result':_0xe54303});}catch(_0x396805){_0x15b7c9(_0x396805);}},this['getPaymentById']=async(_0x41950d,_0x1ee263,_0x27f120)=>{const _0x2477db=_0x27ac42;try{const {id:_0x1f0af2}=_0x41950d['params'],_0x55468a=await this[_0x2477db(0x1f0)][_0x2477db(0x1c7)](_0x1f0af2);if(!_0x55468a)return _0x1ee263[_0x2477db(0x23d)](0x194)[_0x2477db(0x1fc)]({'success':![],'message':_0x2477db(0x235)});_0x1ee263[_0x2477db(0x1fc)]({'success':!![],'result':_0x55468a});}catch(_0xc39524){_0x27f120(_0xc39524);}},this['updatePaymentCustomer']=async(_0x205a54,_0x4b9e84,_0x12c24f)=>{const _0x49fd59=_0x27ac42;try{const {id:_0x4858ff}=_0x205a54[_0x49fd59(0x1cc)],_0x4f02ab=_0x205a54['body'];console[_0x49fd59(0x22b)](_0x49fd59(0x202)+_0x4858ff),console[_0x49fd59(0x22b)](_0x49fd59(0x1e1),_0x4f02ab);const _0x4935f5=await this[_0x49fd59(0x1f0)]['updatePaymentCustomerDataPublic'](_0x4858ff,_0x4f02ab);if(!_0x4935f5)return _0x4b9e84[_0x49fd59(0x23d)](0x194)[_0x49fd59(0x1fc)]({'success':![],'message':_0x49fd59(0x235)});_0x4b9e84['json']({'success':!![],'message':_0x49fd59(0x1eb),'result':{'paymentId':_0x4935f5['id'],'customerIp':_0x4935f5[_0x49fd59(0x23e)],'customerUa':_0x4935f5['customerUa'],'customerCountry':_0x4935f5[_0x49fd59(0x1b2)],'updatedAt':_0x4935f5['updatedAt']}});}catch(_0x231599){_0x12c24f(_0x231599);}},this['processMasterCardPayment']=async(_0x1f2d8c,_0x22342b,_0x54d224)=>{const _0x24dcac=_0x27ac42;try{const {id:_0x551daa}=_0x1f2d8c[_0x24dcac(0x1cc)],{cardData:_0x423f47,cardHolder:_0x34e5de,browser:_0x1adaab,phoneValidation:_0x29505a}=_0x1f2d8c['body'];console['log'](_0x24dcac(0x1ad)+_0x551daa),console['log'](_0x24dcac(0x201)+_0x34e5de[_0x24dcac(0x218)]+'\x20'+_0x34e5de[_0x24dcac(0x19f)]+'\x20('+_0x34e5de[_0x24dcac(0x211)]+')'),console['log']('üí≥\x20Browser\x20IP:\x20'+_0x1adaab['ip']);const _0xddd664=_0x34e5de['first_name']?.[_0x24dcac(0x1e4)](/[\t\n\r\f\v]/g,'\x20')[_0x24dcac(0x1f6)]()||'',_0x2105cc=_0x34e5de['last_name']?.['replace'](/[\t\n\r\f\v]/g,'\x20')[_0x24dcac(0x1f6)]()||'';console[_0x24dcac(0x22b)](_0x24dcac(0x1a6)),console[_0x24dcac(0x22b)](_0x24dcac(0x22d)+_0x34e5de[_0x24dcac(0x218)]+_0x24dcac(0x216)+_0x34e5de[_0x24dcac(0x19f)]+'\x22'),console['log'](_0x24dcac(0x241)+_0xddd664+_0x24dcac(0x216)+_0x2105cc+'\x22');const _0x3a9cc1={'customerName':_0xddd664+'\x20'+_0x2105cc,'customerEmail':_0x34e5de[_0x24dcac(0x211)],'customerPhone':_0x34e5de[_0x24dcac(0x1c2)]||null,'customerIp':_0x1adaab['ip'],'customerUa':_0x1adaab[_0x24dcac(0x21f)]},_0xa03688=[_0x34e5de[_0x24dcac(0x1ee)],_0x34e5de['address_line_2']][_0x24dcac(0x24a)](Boolean);_0x3a9cc1[_0x24dcac(0x22e)]=_0xa03688[_0x24dcac(0x21b)](',\x20')||null,_0x3a9cc1[_0x24dcac(0x1e7)]=_0x34e5de['city']||null,_0x3a9cc1['billingState']=_0x34e5de[_0x24dcac(0x250)]||null,_0x3a9cc1['billingZip']=_0x34e5de[_0x24dcac(0x19a)]||_0x34e5de[_0x24dcac(0x1be)]||null,console['log'](_0x24dcac(0x1c4),_0x3a9cc1[_0x24dcac(0x22e)]),console['log'](_0x24dcac(0x219),_0x423f47[_0x24dcac(0x194)][_0x24dcac(0x212)](0x0,0x6)+_0x24dcac(0x1c3));const _0x3cf7fc=await binLookupService_1[_0x24dcac(0x1b3)]['lookupBin'](_0x423f47[_0x24dcac(0x194)]);console['log'](_0x24dcac(0x20b),_0x3cf7fc);const _0x11da29=_0x423f47[_0x24dcac(0x194)][_0x24dcac(0x212)](0x0,0x8),_0x4005fc=await database_1[_0x24dcac(0x1fb)][_0x24dcac(0x1e0)][_0x24dcac(0x1ed)]({'where':{'id':_0x551daa},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4005fc)return _0x22342b[_0x24dcac(0x23d)](0x194)[_0x24dcac(0x1fc)]({'success':![],'message':_0x24dcac(0x235)});if(_0x4005fc[_0x24dcac(0x1a0)]!=='visa/mastercard')return console[_0x24dcac(0x22b)](_0x24dcac(0x230)+_0x4005fc['gateway']+'\x27'),_0x22342b['status'](0x190)['json']({'success':![],'message':_0x24dcac(0x1c0)});if(_0x4005fc[_0x24dcac(0x23d)]!==_0x24dcac(0x239))return _0x22342b['status'](0x190)[_0x24dcac(0x1fc)]({'success':![],'message':_0x24dcac(0x20f)+_0x4005fc[_0x24dcac(0x23d)]+',\x20cannot\x20process'});await database_1[_0x24dcac(0x1fb)][_0x24dcac(0x1e0)][_0x24dcac(0x224)]({'where':{'id':_0x551daa},'data':{..._0x3a9cc1,'cardBin':_0x11da29,'cardBinStatus':_0x3cf7fc[_0x24dcac(0x205)],'cardType':_0x3cf7fc[_0x24dcac(0x1a9)],'cardCategory':_0x3cf7fc[_0x24dcac(0x1a3)],'cardCountry':_0x3cf7fc[_0x24dcac(0x223)],'cardIssuer':_0x3cf7fc[_0x24dcac(0x1a4)],'phoneIsValid':_0x29505a?.[_0x24dcac(0x193)],'phoneLineStatus':_0x29505a?.[_0x24dcac(0x246)],'phoneIsVoip':_0x29505a?.['isVoip'],'phoneRiskLevel':_0x29505a?.['riskLevel'],'updatedAt':new Date()}}),console[_0x24dcac(0x22b)]('‚úÖ\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info');const _0x575fb1=_0x423f47['number'][_0x24dcac(0x1e4)](/[\s-]/g,''),_0xd47b3b=_0x575fb1['startsWith']('4')?'visa':_0x24dcac(0x1b9),_0x350455=_0x575fb1[_0x24dcac(0x20e)]('4')?_0x24dcac(0x1b8):_0x24dcac(0x1ce),_0x33028d='https://api.trapay.uk/api/webhooks/gateway/'+_0xd47b3b,_0x5bc8e3=_0x24dcac(0x1fa)+_0x4005fc['id']+_0x24dcac(0x1a5)+_0x4005fc[_0x24dcac(0x1ef)];console[_0x24dcac(0x22b)](_0x24dcac(0x233)+_0xd47b3b['toUpperCase']()+_0x24dcac(0x247)),console[_0x24dcac(0x22b)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x33028d),console[_0x24dcac(0x22b)](_0x24dcac(0x1df)+_0x5bc8e3);const _0x15c752={'first_name':_0x34e5de[_0x24dcac(0x218)],'last_name':_0x34e5de[_0x24dcac(0x19f)],'email':_0x34e5de[_0x24dcac(0x211)]},_0x10eab4=await this[_0x24dcac(0x21c)]['processCardPayment']({'paymentId':_0x4005fc['id'],'orderId':_0x4005fc[_0x24dcac(0x1ef)]||_0x4005fc['id'],'amount':_0x4005fc[_0x24dcac(0x1dc)],'currency':_0x4005fc[_0x24dcac(0x1d4)],'cardData':_0x423f47,'resultUrl':_0x33028d,'returnUrl':_0x5bc8e3,'cardHolder':_0x15c752,'browser':_0x1adaab});console[_0x24dcac(0x22b)](_0x24dcac(0x1c1),_0x10eab4);const _0x33a1ed={'status':_0x10eab4[_0x24dcac(0x23d)],'updatedAt':new Date(),'statusChangedBy':_0x24dcac(0x1e5),'statusChangedAt':new Date()};_0x10eab4[_0x24dcac(0x236)]&&(_0x33a1ed[_0x24dcac(0x1ec)]=_0x10eab4['gateway_payment_id'],console['log'](_0x24dcac(0x1b0)+_0x10eab4[_0x24dcac(0x236)]));if(_0x10eab4['status']===_0x24dcac(0x255)){_0x33a1ed[_0x24dcac(0x1d2)]=new Date();const _0x479f6e=await this[_0x24dcac(0x1aa)][_0x24dcac(0x1c8)](_0x4005fc['amount'],_0x4005fc[_0x24dcac(0x1d4)]),_0x42fbc3=await this['webhookService'][_0x24dcac(0x1a2)](_0x4005fc['shopId'],_0x4005fc[_0x24dcac(0x1a0)]),_0x4b5f3b=_0x479f6e*(0x1-_0x42fbc3/0x64);_0x33a1ed[_0x24dcac(0x198)]=_0x479f6e,_0x33a1ed[_0x24dcac(0x1de)]=_0x4b5f3b,_0x33a1ed[_0x24dcac(0x1d1)]=_0x42fbc3,console[_0x24dcac(0x22b)](_0x24dcac(0x245)+_0x4005fc[_0x24dcac(0x1dc)]+'\x20'+_0x4005fc[_0x24dcac(0x1d4)]+'\x20->\x20'+_0x479f6e['toFixed'](0x6)+_0x24dcac(0x237)),console[_0x24dcac(0x22b)](_0x24dcac(0x21e)+_0x4005fc[_0x24dcac(0x1a0)]+'\x20commission:\x20'+_0x42fbc3+'%'),console['log'](_0x24dcac(0x1f9)+_0x4b5f3b[_0x24dcac(0x244)](0x6)+'\x20USDT');}else _0x10eab4['status']===_0x24dcac(0x251)&&(_0x33a1ed['failureMessage']=_0x10eab4[_0x24dcac(0x191)]||_0x24dcac(0x1b7),console[_0x24dcac(0x22b)]('‚ùå\x20Payment\x20failed\x20with\x20message:\x20'+_0x33a1ed[_0x24dcac(0x197)]));_0x33a1ed[_0x24dcac(0x1cf)]=_0x24dcac(0x195);if(_0x423f47[_0x24dcac(0x194)]){const _0x17c578=_0x423f47[_0x24dcac(0x194)][_0x24dcac(0x1e4)](/[\s-]/g,'');_0x33a1ed[_0x24dcac(0x234)]=_0x17c578[_0x24dcac(0x1f8)](-0x4),_0x33a1ed[_0x24dcac(0x1a8)]=_0x350455,console['log'](_0x24dcac(0x23f)+_0x33a1ed['cardLast4']),console[_0x24dcac(0x22b)]('üí≥\x20Saving\x20card\x20brand:\x20'+_0x350455);}await database_1[_0x24dcac(0x1fb)]['payment'][_0x24dcac(0x224)]({'where':{'id':_0x4005fc['id']},'data':_0x33a1ed});_0x10eab4[_0x24dcac(0x23d)]===_0x24dcac(0x255)&&(await this[_0x24dcac(0x1f3)][_0x24dcac(0x1d7)](_0x4005fc['id'],_0x24dcac(0x255)),console['log']('üí∞\x20Updated\x20merchant\x20balance\x20for\x20payment\x20'+_0x4005fc['id']));await database_1[_0x24dcac(0x1fb)][_0x24dcac(0x24e)][_0x24dcac(0x242)]({'data':{'paymentId':_0x4005fc['id'],'shopId':_0x4005fc[_0x24dcac(0x196)],'event':_0xd47b3b+'_'+_0x10eab4['status']?.[_0x24dcac(0x1b1)](),'statusCode':0xc8,'responseBody':JSON[_0x24dcac(0x249)]({'oldStatus':_0x24dcac(0x239),'newStatus':_0x10eab4[_0x24dcac(0x23d)],'gatewayPaymentId':_0x10eab4[_0x24dcac(0x236)],'requires3ds':_0x10eab4['requires_3ds'],'cardType':_0xd47b3b[_0x24dcac(0x22c)](),'processedAt':new Date()[_0x24dcac(0x229)]()})}});if(_0x10eab4[_0x24dcac(0x1da)]){await this[_0x24dcac(0x1f1)](_0x4005fc,_0x10eab4['status'],_0x10eab4[_0x24dcac(0x236)],_0xd47b3b),await this['sendPaymentStatusNotification'](_0x4005fc,_0x10eab4[_0x24dcac(0x23d)]);if(_0x10eab4[_0x24dcac(0x23d)]===_0x24dcac(0x255)){console['log'](_0x24dcac(0x240)+_0xd47b3b[_0x24dcac(0x22c)]()+_0x24dcac(0x1e6)+_0x551daa+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x2b2441}=await Promise[_0x24dcac(0x206)]()['then'](()=>__importStar(require('../services/paymentLinkService'))),_0x29f52b=new _0x2b2441();await _0x29f52b[_0x24dcac(0x24c)](_0x551daa),console[_0x24dcac(0x22b)]('‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20'+_0xd47b3b[_0x24dcac(0x22c)]()+_0x24dcac(0x1e6)+_0x551daa);}catch(_0x127901){console[_0x24dcac(0x253)](_0x24dcac(0x1d9)+_0xd47b3b['toUpperCase']()+_0x24dcac(0x1b4),_0x127901);}}}console[_0x24dcac(0x22b)]('‚úÖ\x20'+_0xd47b3b[_0x24dcac(0x22c)]()+_0x24dcac(0x1e6)+_0x551daa+_0x24dcac(0x217)+_0x10eab4[_0x24dcac(0x23d)]);if(_0x10eab4[_0x24dcac(0x23d)]===_0x24dcac(0x255))_0x22342b[_0x24dcac(0x1fc)]({'success':!![],'message':_0x24dcac(0x1f4),'result':{'status':_0x24dcac(0x255),'gatewayPaymentId':_0x10eab4[_0x24dcac(0x236)],'redirectUrl':_0x5bc8e3,'final':!![]}});else _0x10eab4[_0x24dcac(0x228)]&&_0x10eab4[_0x24dcac(0x22f)]?_0x22342b[_0x24dcac(0x1fc)]({'success':!![],'message':_0x24dcac(0x215),'result':{'status':'PENDING','gatewayPaymentId':_0x10eab4[_0x24dcac(0x236)],'redirectUrl':_0x10eab4[_0x24dcac(0x22f)],'requires3ds':!![],'final':![]}}):_0x22342b[_0x24dcac(0x23d)](0x190)['json']({'success':![],'message':_0x24dcac(0x231),'result':{'status':'FAILED','gatewayPaymentId':_0x10eab4[_0x24dcac(0x236)],'redirectUrl':_0x4005fc[_0x24dcac(0x1d0)],'final':!![]}});}catch(_0x319aeb){_0x54d224(_0x319aeb);}},this[_0x27ac42(0x1f0)]=new paymentService_1['PaymentService'](),this[_0x27ac42(0x21c)]=new mastercardService_1[(_0x27ac42(0x1c6))](),this['webhookService']=new webhookService_1[(_0x27ac42(0x225))](),this[_0x27ac42(0x1aa)]=new currencyService_1[(_0x27ac42(0x204))]();}async[a14_0x158d99(0x1f1)](_0x58b7a4,_0x18e9a7,_0x5a63f5,_0x26fa29){const _0xd3444e=a14_0x158d99,_0x1a6a1a=Date[_0xd3444e(0x1a1)]();try{const _0x5138ae=_0x58b7a4[_0xd3444e(0x1a7)],_0xf36d3f=_0x5138ae[_0xd3444e(0x1c5)];if(!_0xf36d3f?.[_0xd3444e(0x24f)]){console[_0xd3444e(0x22b)](_0xd3444e(0x1ba)+_0x5138ae['id']);return;}const _0x360f4d=_0x18e9a7===_0xd3444e(0x255)?'payment.success':_0xd3444e(0x1cd);let _0x340aeb=[];if(_0xf36d3f[_0xd3444e(0x1bc)])try{_0x340aeb=Array[_0xd3444e(0x207)](_0xf36d3f[_0xd3444e(0x1bc)])?_0xf36d3f['webhookEvents']:JSON[_0xd3444e(0x1ca)](_0xf36d3f[_0xd3444e(0x1bc)]);}catch(_0x4fe207){console[_0xd3444e(0x253)](_0xd3444e(0x1c9),_0x4fe207),_0x340aeb=[];}if(!_0x340aeb[_0xd3444e(0x248)](_0x360f4d)){console[_0xd3444e(0x22b)]('Webhook\x20event\x20'+_0x360f4d+_0xd3444e(0x1db)+_0x5138ae['id']);return;}const _0x220fb5={'event':_0x360f4d,'payment':{'id':_0x58b7a4['id'],'order_id':_0x58b7a4[_0xd3444e(0x1ac)],'gateway_order_id':_0x58b7a4[_0xd3444e(0x1ef)],'gateway':_0xd3444e(0x24d),'card_type':_0x26fa29?.[_0xd3444e(0x22c)]()||_0xd3444e(0x227),'amount':_0x58b7a4['amount'],'currency':_0x58b7a4[_0xd3444e(0x1d4)],'status':_0x18e9a7[_0xd3444e(0x1b1)](),'customer_email':_0x58b7a4[_0xd3444e(0x1d6)],'customer_name':_0x58b7a4[_0xd3444e(0x192)],'gateway_payment_id':_0x5a63f5,'created_at':_0x58b7a4[_0xd3444e(0x1e9)],'updated_at':new Date()}},_0x213db4=JSON[_0xd3444e(0x249)](_0x220fb5),_0x140127=crypto_1['default']['createHmac'](_0xd3444e(0x24b),_0x5138ae[_0xd3444e(0x220)])['update'](_0x213db4)[_0xd3444e(0x1b5)](_0xd3444e(0x21a)),_0x33bbe4=await fetch(_0xf36d3f[_0xd3444e(0x24f)],{'method':_0xd3444e(0x1cb),'headers':{'Content-Type':_0xd3444e(0x254),'User-Agent':_0xd3444e(0x1b6)+(_0x26fa29?.[_0xd3444e(0x22c)]()||_0xd3444e(0x221))+')','X-Webhook-Signature':_0x140127},'body':_0x213db4}),_0x13a865=Date[_0xd3444e(0x1a1)]()-_0x1a6a1a;console['log']((_0x26fa29?.[_0xd3444e(0x22c)]()||_0xd3444e(0x221))+_0xd3444e(0x1e3)+_0xf36d3f['webhookUrl']+_0xd3444e(0x1f2)+_0x33bbe4[_0xd3444e(0x23d)]+'\x20('+_0x13a865+_0xd3444e(0x1bf));}catch(_0x5529a3){console[_0xd3444e(0x253)](_0xd3444e(0x20d)+(_0x26fa29?.['toUpperCase']()||'VISA/MasterCard')+'\x20webhook:',_0x5529a3);}}async['sendPaymentStatusNotification'](_0x32b7bb,_0x3f7b1d){const _0x5f2bdf=a14_0x158d99;try{const {telegramBotService:_0x9bf999}=await Promise[_0x5f2bdf(0x206)]()['then'](()=>__importStar(require('../services/telegramBotService'))),_0x4d6997={'PAID':_0x5f2bdf(0x1e2),'FAILED':_0x5f2bdf(0x210)},_0x1bfec=_0x4d6997[_0x3f7b1d];if(!_0x1bfec)return;await _0x9bf999[_0x5f2bdf(0x23a)](_0x32b7bb[_0x5f2bdf(0x196)],_0x32b7bb,_0x1bfec);}catch(_0x54b716){console[_0x5f2bdf(0x253)](_0x5f2bdf(0x238),_0x54b716);}}}exports[a14_0x158d99(0x256)]=PaymentController;