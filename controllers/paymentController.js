'use strict';const a8_0x53b963=a8_0x3115;(function(_0x4fafad,_0x1ac35c){const _0x3c1ca6=a8_0x3115,_0x548db7=_0x4fafad();while(!![]){try{const _0x2611f2=parseInt(_0x3c1ca6(0x10e))/0x1*(-parseInt(_0x3c1ca6(0x104))/0x2)+parseInt(_0x3c1ca6(0xd3))/0x3+parseInt(_0x3c1ca6(0xe6))/0x4*(-parseInt(_0x3c1ca6(0xc9))/0x5)+parseInt(_0x3c1ca6(0x125))/0x6+-parseInt(_0x3c1ca6(0x105))/0x7*(parseInt(_0x3c1ca6(0xdd))/0x8)+-parseInt(_0x3c1ca6(0xe3))/0x9*(-parseInt(_0x3c1ca6(0x115))/0xa)+parseInt(_0x3c1ca6(0xd5))/0xb*(parseInt(_0x3c1ca6(0xfa))/0xc);if(_0x2611f2===_0x1ac35c)break;else _0x548db7['push'](_0x548db7['shift']());}catch(_0x468f35){_0x548db7['push'](_0x548db7['shift']());}}}(a8_0x4e6a,0x768cd));var __createBinding=this&&this[a8_0x53b963(0xed)]||(Object[a8_0x53b963(0x103)]?function(_0x55a4e2,_0x10c1c3,_0x12217c,_0x558b9f){const _0x185350=a8_0x53b963;if(_0x558b9f===undefined)_0x558b9f=_0x12217c;var _0x36bcbc=Object[_0x185350(0x113)](_0x10c1c3,_0x12217c);(!_0x36bcbc||(_0x185350(0xdc)in _0x36bcbc?!_0x10c1c3[_0x185350(0xca)]:_0x36bcbc[_0x185350(0x11d)]||_0x36bcbc['configurable']))&&(_0x36bcbc={'enumerable':!![],'get':function(){return _0x10c1c3[_0x12217c];}}),Object[_0x185350(0x138)](_0x55a4e2,_0x558b9f,_0x36bcbc);}:function(_0x3a1f59,_0xb9ace4,_0x26355c,_0x46ff1f){if(_0x46ff1f===undefined)_0x46ff1f=_0x26355c;_0x3a1f59[_0x46ff1f]=_0xb9ace4[_0x26355c];}),__setModuleDefault=this&&this[a8_0x53b963(0xec)]||(Object[a8_0x53b963(0x103)]?function(_0x5a02e3,_0x55b384){const _0x116728=a8_0x53b963;Object[_0x116728(0x138)](_0x5a02e3,'default',{'enumerable':!![],'value':_0x55b384});}:function(_0x1df266,_0x13902){const _0x24889c=a8_0x53b963;_0x1df266[_0x24889c(0x121)]=_0x13902;}),__importStar=this&&this[a8_0x53b963(0xce)]||(function(){var _0x42afed=function(_0xfa81c0){const _0x15927b=a8_0x3115;return _0x42afed=Object[_0x15927b(0xcf)]||function(_0x449f80){const _0x52658d=_0x15927b;var _0x10ba89=[];for(var _0x267632 in _0x449f80)if(Object['prototype'][_0x52658d(0xf4)][_0x52658d(0xfb)](_0x449f80,_0x267632))_0x10ba89[_0x10ba89['length']]=_0x267632;return _0x10ba89;},_0x42afed(_0xfa81c0);};return function(_0x3a48a5){const _0x5a51a8=a8_0x3115;if(_0x3a48a5&&_0x3a48a5[_0x5a51a8(0xca)])return _0x3a48a5;var _0x4641f4={};if(_0x3a48a5!=null){for(var _0xb87f3b=_0x42afed(_0x3a48a5),_0x31e9e2=0x0;_0x31e9e2<_0xb87f3b['length'];_0x31e9e2++)if(_0xb87f3b[_0x31e9e2]!==_0x5a51a8(0x121))__createBinding(_0x4641f4,_0x3a48a5,_0xb87f3b[_0x31e9e2]);}return __setModuleDefault(_0x4641f4,_0x3a48a5),_0x4641f4;};}()),__importDefault=this&&this[a8_0x53b963(0xdb)]||function(_0x59bbe8){return _0x59bbe8&&_0x59bbe8['__esModule']?_0x59bbe8:{'default':_0x59bbe8};};Object[a8_0x53b963(0x138)](exports,a8_0x53b963(0xca),{'value':!![]}),exports[a8_0x53b963(0xf6)]=void 0x0;const paymentService_1=require(a8_0x53b963(0x11c)),mastercardService_1=require(a8_0x53b963(0xcd)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x53b963(0x123)));class PaymentController{constructor(){const _0x4a0913=a8_0x53b963;this[_0x4a0913(0xf0)]=async(_0x524607,_0x5544df,_0x3c3011)=>{const _0x2977ff=_0x4a0913;try{const _0x354948=_0x524607[_0x2977ff(0x127)],_0x2eb3d0=await this[_0x2977ff(0xc7)][_0x2977ff(0xf0)](_0x354948);_0x5544df[_0x2977ff(0x12d)](0xc9)[_0x2977ff(0x137)]({'success':!![],'message':_0x2977ff(0xe7),'result':_0x2eb3d0});}catch(_0x4755c8){_0x3c3011(_0x4755c8);}},this[_0x4a0913(0xf1)]=async(_0x2d60f1,_0x10511b,_0x5ec925)=>{const _0x1bf69f=_0x4a0913;try{const {id:_0xf43fb2}=_0x2d60f1['params'],_0x2135d=await this[_0x1bf69f(0xc7)][_0x1bf69f(0xf1)](_0xf43fb2);if(!_0x2135d)return _0x10511b[_0x1bf69f(0x12d)](0x194)[_0x1bf69f(0x137)]({'success':![],'message':_0x1bf69f(0xeb)});_0x10511b[_0x1bf69f(0x137)]({'success':!![],'result':_0x2135d});}catch(_0x56bd23){_0x5ec925(_0x56bd23);}},this[_0x4a0913(0x116)]=async(_0x341bb9,_0x2f1109,_0x367a46)=>{const _0x33648c=_0x4a0913;try{const {id:_0x316057}=_0x341bb9['params'],_0x4a9ce7=await this[_0x33648c(0xc7)][_0x33648c(0x116)](_0x316057);if(!_0x4a9ce7)return _0x2f1109[_0x33648c(0x12d)](0x194)[_0x33648c(0x137)]({'success':![],'message':_0x33648c(0xeb)});_0x2f1109[_0x33648c(0x137)]({'success':!![],'result':_0x4a9ce7});}catch(_0x5f5630){_0x367a46(_0x5f5630);}},this[_0x4a0913(0xe2)]=async(_0x2c584b,_0x32459d,_0x39449c)=>{const _0x5224f7=_0x4a0913;try{const {id:_0x23fa66}=_0x2c584b['params'],_0x348f29=_0x2c584b[_0x5224f7(0x127)];console['log'](_0x5224f7(0xd9)+_0x23fa66),console[_0x5224f7(0xf2)]('📝\x20Customer\x20data:',_0x348f29);const _0x55f92b=await this['paymentService']['updatePaymentCustomerDataPublic'](_0x23fa66,_0x348f29);if(!_0x55f92b)return _0x32459d[_0x5224f7(0x12d)](0x194)[_0x5224f7(0x137)]({'success':![],'message':_0x5224f7(0xeb)});_0x32459d[_0x5224f7(0x137)]({'success':!![],'message':_0x5224f7(0xff),'result':{'paymentId':_0x55f92b['id'],'customerIp':_0x55f92b[_0x5224f7(0xe1)],'customerUa':_0x55f92b['customerUa'],'customerCountry':_0x55f92b['customerCountry'],'updatedAt':_0x55f92b[_0x5224f7(0x10d)]}});}catch(_0x4e114d){_0x39449c(_0x4e114d);}},this[_0x4a0913(0x128)]=async(_0x39cddd,_0x3f830f,_0x369994)=>{const _0xbf9a7a=_0x4a0913;try{const {id:_0x108c86}=_0x39cddd[_0xbf9a7a(0x10a)],{cardData:_0x1a65ea,cardHolder:_0x53f03,browser:_0x405840}=_0x39cddd[_0xbf9a7a(0x127)];console[_0xbf9a7a(0xf2)](_0xbf9a7a(0x131)+_0x108c86);const _0x4355f=await database_1[_0xbf9a7a(0x121)][_0xbf9a7a(0xda)][_0xbf9a7a(0x119)]({'where':{'id':_0x108c86},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4355f)return _0x3f830f[_0xbf9a7a(0x12d)](0x194)['json']({'success':![],'message':_0xbf9a7a(0xeb)});if(_0x4355f[_0xbf9a7a(0x117)]!==_0xbf9a7a(0x12b))return _0x3f830f[_0xbf9a7a(0x12d)](0x190)[_0xbf9a7a(0x137)]({'success':![],'message':_0xbf9a7a(0x139)});if(_0x4355f[_0xbf9a7a(0x12d)]!==_0xbf9a7a(0x100))return _0x3f830f[_0xbf9a7a(0x12d)](0x190)[_0xbf9a7a(0x137)]({'success':![],'message':_0xbf9a7a(0xd4)+_0x4355f[_0xbf9a7a(0x12d)]+_0xbf9a7a(0xfc)});const _0xdd7dc7=_0xbf9a7a(0xf3),_0x15eb59=_0x4355f['successUrl'];console[_0xbf9a7a(0xf2)](_0xbf9a7a(0xd7)),console['log'](_0xbf9a7a(0xcb)+_0xdd7dc7),console[_0xbf9a7a(0xf2)](_0xbf9a7a(0x10c)+_0x15eb59);const _0x30c42d=await this[_0xbf9a7a(0xc6)][_0xbf9a7a(0x120)]({'paymentId':_0x4355f['id'],'orderId':_0x4355f['gatewayOrderId']||_0x4355f['id'],'amount':_0x4355f[_0xbf9a7a(0xe4)],'currency':_0x4355f['currency'],'cardData':_0x1a65ea,'resultUrl':_0xdd7dc7,'returnUrl':_0x15eb59,'cardHolder':_0x53f03,'browser':_0x405840});console['log'](_0xbf9a7a(0x130),_0x30c42d);const _0x3fff82={'status':_0x30c42d[_0xbf9a7a(0x12d)],'updatedAt':new Date(),'statusChangedBy':_0xbf9a7a(0x129),'statusChangedAt':new Date()};if(_0x30c42d['status']===_0xbf9a7a(0x11f))_0x3fff82['paidAt']=new Date(),_0x3fff82[_0xbf9a7a(0x106)]=_0x30c42d['gateway_payment_id'];else _0x30c42d[_0xbf9a7a(0x12d)]===_0xbf9a7a(0x12e)&&(_0x3fff82[_0xbf9a7a(0xd2)]='Card\x20payment\x20failed');_0x3fff82[_0xbf9a7a(0xe0)]=_0xbf9a7a(0x12b),await database_1['default']['payment']['update']({'where':{'id':_0x4355f['id']},'data':_0x3fff82}),await database_1[_0xbf9a7a(0x121)]['webhookLog'][_0xbf9a7a(0x103)]({'data':{'paymentId':_0x4355f['id'],'shopId':_0x4355f['shopId'],'event':_0xbf9a7a(0x124)+_0x30c42d[_0xbf9a7a(0x12d)]?.[_0xbf9a7a(0x13a)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xbf9a7a(0x100),'newStatus':_0x30c42d[_0xbf9a7a(0x12d)],'gatewayPaymentId':_0x30c42d['gateway_payment_id'],'requires3ds':_0x30c42d[_0xbf9a7a(0x11b)],'processedAt':new Date()[_0xbf9a7a(0x102)]()})}});_0x30c42d['final']&&(await this[_0xbf9a7a(0xe8)](_0x4355f,_0x30c42d[_0xbf9a7a(0x12d)],_0x30c42d[_0xbf9a7a(0x10f)]),await this[_0xbf9a7a(0xfd)](_0x4355f,_0x30c42d['status']));console[_0xbf9a7a(0xf2)](_0xbf9a7a(0x135)+_0x108c86+_0xbf9a7a(0xf8)+_0x30c42d['status']);if(_0x30c42d['status']==='PAID')_0x3f830f[_0xbf9a7a(0x137)]({'success':!![],'message':_0xbf9a7a(0x108),'result':{'status':_0xbf9a7a(0x11f),'gatewayPaymentId':_0x30c42d[_0xbf9a7a(0x10f)],'redirectUrl':_0x15eb59,'final':!![]}});else _0x30c42d[_0xbf9a7a(0x11b)]&&_0x30c42d[_0xbf9a7a(0xdf)]?_0x3f830f['json']({'success':!![],'message':_0xbf9a7a(0xc8),'result':{'status':_0xbf9a7a(0x100),'gatewayPaymentId':_0x30c42d[_0xbf9a7a(0x10f)],'redirectUrl':_0x30c42d['threeds_url'],'requires3ds':!![],'final':![]}}):_0x3f830f[_0xbf9a7a(0x12d)](0x190)[_0xbf9a7a(0x137)]({'success':![],'message':_0xbf9a7a(0xf7),'result':{'status':_0xbf9a7a(0x12e),'gatewayPaymentId':_0x30c42d['gateway_payment_id'],'redirectUrl':_0x4355f[_0xbf9a7a(0x101)],'final':!![]}});}catch(_0x24afe4){_0x369994(_0x24afe4);}},this[_0x4a0913(0xc7)]=new paymentService_1['PaymentService'](),this[_0x4a0913(0xc6)]=new mastercardService_1[(_0x4a0913(0xe5))](),this['webhookService']=new webhookService_1['WebhookService']();}async[a8_0x53b963(0xe8)](_0x3dfb66,_0x2e3808,_0x8f9697){const _0x2db23d=a8_0x53b963,_0x45dede=Date[_0x2db23d(0xef)]();try{const _0x2c2413=_0x3dfb66[_0x2db23d(0xcc)],_0x1c3efe=_0x2c2413[_0x2db23d(0xfe)];if(!_0x1c3efe?.[_0x2db23d(0xd8)]){console['log'](_0x2db23d(0x11a)+_0x2c2413['id']);return;}const _0x19f005=_0x2e3808===_0x2db23d(0x11f)?'payment.success':_0x2db23d(0xd1);let _0x376ea2=[];if(_0x1c3efe[_0x2db23d(0x12c)])try{_0x376ea2=Array['isArray'](_0x1c3efe[_0x2db23d(0x12c)])?_0x1c3efe['webhookEvents']:JSON[_0x2db23d(0xd6)](_0x1c3efe[_0x2db23d(0x12c)]);}catch(_0x2b6265){console[_0x2db23d(0xf5)](_0x2db23d(0x12a),_0x2b6265),_0x376ea2=[];}if(!_0x376ea2[_0x2db23d(0x12f)](_0x19f005)){console[_0x2db23d(0xf2)](_0x2db23d(0x136)+_0x19f005+_0x2db23d(0x10b)+_0x2c2413['id']);return;}const _0x1c5c00={'event':_0x19f005,'payment':{'id':_0x3dfb66['id'],'order_id':_0x3dfb66['orderId'],'gateway_order_id':_0x3dfb66[_0x2db23d(0x11e)],'gateway':_0x2db23d(0x133),'amount':_0x3dfb66['amount'],'currency':_0x3dfb66[_0x2db23d(0xe9)],'status':_0x2e3808[_0x2db23d(0x13a)](),'customer_email':_0x3dfb66[_0x2db23d(0x134)],'customer_name':_0x3dfb66[_0x2db23d(0x132)],'gateway_payment_id':_0x8f9697,'created_at':_0x3dfb66['createdAt'],'updated_at':new Date()}},_0x5c4bc5=await fetch(_0x1c3efe[_0x2db23d(0xd8)],{'method':_0x2db23d(0x126),'headers':{'Content-Type':'application/json','User-Agent':_0x2db23d(0xde)},'body':JSON['stringify'](_0x1c5c00)}),_0x46ecd2=Date[_0x2db23d(0xef)]()-_0x45dede;console[_0x2db23d(0xf2)](_0x2db23d(0x118)+_0x1c3efe[_0x2db23d(0xd8)]+_0x2db23d(0x110)+_0x5c4bc5[_0x2db23d(0x12d)]+'\x20('+_0x46ecd2+_0x2db23d(0xd0));}catch(_0x189c7f){console[_0x2db23d(0xf5)](_0x2db23d(0x112),_0x189c7f);}}async[a8_0x53b963(0xfd)](_0x6aca38,_0x29cf32){const _0x567b4f=a8_0x53b963;try{const {telegramBotService:_0x4b9c65}=await Promise[_0x567b4f(0x109)]()[_0x567b4f(0x111)](()=>__importStar(require(_0x567b4f(0x114)))),_0x200e39={'PAID':_0x567b4f(0x122),'FAILED':_0x567b4f(0xea)},_0x53dca9=_0x200e39[_0x29cf32];if(!_0x53dca9)return;await _0x4b9c65[_0x567b4f(0x107)](_0x6aca38[_0x567b4f(0xee)],_0x6aca38,_0x53dca9);}catch(_0x5590bd){console[_0x567b4f(0xf5)](_0x567b4f(0xf9),_0x5590bd);}}}function a8_0x3115(_0x32ff12,_0x46ebe8){const _0x4e6a73=a8_0x4e6a();return a8_0x3115=function(_0x31155f,_0x1db808){_0x31155f=_0x31155f-0xc6;let _0x344304=_0x4e6a73[_0x31155f];return _0x344304;},a8_0x3115(_0x32ff12,_0x46ebe8);}function a8_0x4e6a(){const _0xe3b143=['TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','threeds_url','paymentMethod','customerIp','updatePaymentCustomer','3487473tbsznM','amount','MasterCardService','665548dJUlTZ','Payment\x20created\x20successfully','sendShopWebhook','currency','failed','Payment\x20not\x20found','__setModuleDefault','__createBinding','shopId','now','createPublicPayment','getPaymentStatus','log','https://api.trapay.uk/api/webhooks/gateway/mastercard','hasOwnProperty','error','PaymentController','Payment\x20failed','\x20processed:\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','1976244WFwhSe','call',',\x20cannot\x20process','sendPaymentStatusNotification','settings','Customer\x20data\x20updated\x20successfully','PENDING','failUrl','toISOString','create','1011638mXIlvh','576814bLtTTN','gatewayPaymentId','sendPaymentNotification','Payment\x20processed\x20successfully','resolve','params','\x20not\x20enabled\x20for\x20shop\x20','\x20\x20\x20Return\x20URL:\x20','updatedAt','1JnYZEe','gateway_payment_id','\x20with\x20status\x20','then','Failed\x20to\x20send\x20MasterCard\x20webhook:','getOwnPropertyDescriptor','../services/telegramBotService','10HwcXkY','getPaymentById','gateway','MasterCard\x20webhook\x20sent\x20to\x20','findUnique','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','requires_3ds','../services/paymentService','writable','gatewayOrderId','PAID','processCardPayment','default','paid','../config/database','mastercard_','1345446sfmzyk','POST','body','processMasterCardPayment','system','Error\x20parsing\x20webhook\x20events:','mastercard','webhookEvents','status','FAILED','includes','💳\x20MasterCard\x20result:','💳\x20Processing\x20MasterCard\x20payment:\x20','customerName','1111','customerEmail','✅\x20MasterCard\x20payment\x20','Webhook\x20event\x20','json','defineProperty','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','toLowerCase','masterCardService','paymentService','3DS\x20verification\x20required','15UoMrvb','__esModule','\x20\x20\x20Result\x20URL\x20(webhook):\x20','shop','../services/gateways/mastercardService','__importStar','getOwnPropertyNames','ms)','payment.failed','failureMessage','2389965fGejBE','Payment\x20status\x20is\x20','22PWgIFA','parse','💳\x20MasterCard\x20URLs:','webhookUrl','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','payment','__importDefault','get','24ZBguEW'];a8_0x4e6a=function(){return _0xe3b143;};return a8_0x4e6a();}exports['PaymentController']=PaymentController;