'use strict';const a8_0x8d4a43=a8_0x7ae2;function a8_0x88f0(){const _0x422699=['createPublicPayment','payment','masterCardService','Webhook\x20event\x20','../config/database','Payment\x20created\x20successfully','paid','webhookService','\x20\x20\x20Return\x20URL:\x20','\x20with\x20status\x20','gateway_payment_id','error','__esModule','customerCountry','70GMicpu','updatedAt','payment.success','failUrl','MasterCardService','5701485fmtmlF','Failed\x20to\x20send\x20MasterCard\x20webhook:','gatewayOrderId','PaymentService','includes','updatePaymentCustomerDataPublic','üìù\x20Customer\x20data:','length','status','‚úÖ\x20MasterCard\x20payment\x20','__setModuleDefault','get','customerName','sendPaymentNotification','mastercard_','__createBinding','create','../services/paymentService','system','üí≥\x20Processing\x20MasterCard\x20payment:\x20','mastercard','\x20\x20\x20Result\x20URL\x20(webhook):\x20','730rthTRC','../services/webhookService','final','defineProperty','FAILED','147KBktss','update','webhookUrl','Payment\x20not\x20found','isArray','44ZYKUJA','log','hasOwnProperty','settings','processCardPayment','sendShopWebhook','failureMessage','parse','toISOString','Card\x20payment\x20failed','customerUa','then','toLowerCase','6PkwKLE','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','109352Vyiqtz','7uUPywJ','failed','application/json','now','threeds_url','paymentService','Payment\x20status\x20is\x20','12569iSfEDz','payment.failed','__importStar','ms)','amount','getOwnPropertyDescriptor','shop','stringify','shopId','POST','gatewayPaymentId','prototype','51255wqpCzm','../services/gateways/mastercardService','Customer\x20data\x20updated\x20successfully','customerEmail','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','2734656TTGeYi','3744910TKQLpI','getOwnPropertyNames','WebhookService','üí≥\x20MasterCard\x20URLs:','paidAt','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','default','configurable','createdAt','currency','gateway','PAID','params','json','body','customerIp','getPaymentById','paymentMethod','\x20processed:\x20','requires_3ds','processMasterCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','2787424WSZHku','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','updatePaymentCustomer','sendPaymentStatusNotification','webhookEvents','PaymentController'];a8_0x88f0=function(){return _0x422699;};return a8_0x88f0();}function a8_0x7ae2(_0x944067,_0x53511f){const _0x88f089=a8_0x88f0();return a8_0x7ae2=function(_0x7ae2e1,_0x369e52){_0x7ae2e1=_0x7ae2e1-0x1c8;let _0x97fabc=_0x88f089[_0x7ae2e1];return _0x97fabc;},a8_0x7ae2(_0x944067,_0x53511f);}(function(_0x38e6d8,_0x13cc7a){const _0x363085=a8_0x7ae2,_0x319604=_0x38e6d8();while(!![]){try{const _0x14ad48=parseInt(_0x363085(0x1ca))/0x1*(parseInt(_0x363085(0x206))/0x2)+parseInt(_0x363085(0x226))/0x3*(-parseInt(_0x363085(0x23a))/0x4)+parseInt(_0x363085(0x20b))/0x5*(parseInt(_0x363085(0x238))/0x6)+parseInt(_0x363085(0x23b))/0x7*(-parseInt(_0x363085(0x1f2))/0x8)+-parseInt(_0x363085(0x1d6))/0x9*(parseInt(_0x363085(0x221))/0xa)+-parseInt(_0x363085(0x22b))/0xb*(-parseInt(_0x363085(0x1db))/0xc)+parseInt(_0x363085(0x1dc))/0xd;if(_0x14ad48===_0x13cc7a)break;else _0x319604['push'](_0x319604['shift']());}catch(_0x145e5b){_0x319604['push'](_0x319604['shift']());}}}(a8_0x88f0,0xa510d));var __createBinding=this&&this[a8_0x8d4a43(0x21a)]||(Object['create']?function(_0x2ddbab,_0xf3f4ad,_0x34fd84,_0x4efc89){const _0x42a5d0=a8_0x8d4a43;if(_0x4efc89===undefined)_0x4efc89=_0x34fd84;var _0x442878=Object[_0x42a5d0(0x1cf)](_0xf3f4ad,_0x34fd84);(!_0x442878||(_0x42a5d0(0x216)in _0x442878?!_0xf3f4ad['__esModule']:_0x442878['writable']||_0x442878[_0x42a5d0(0x1e3)]))&&(_0x442878={'enumerable':!![],'get':function(){return _0xf3f4ad[_0x34fd84];}}),Object['defineProperty'](_0x2ddbab,_0x4efc89,_0x442878);}:function(_0x23956c,_0x7c3610,_0x24af75,_0x5ea74a){if(_0x5ea74a===undefined)_0x5ea74a=_0x24af75;_0x23956c[_0x5ea74a]=_0x7c3610[_0x24af75];}),__setModuleDefault=this&&this[a8_0x8d4a43(0x215)]||(Object[a8_0x8d4a43(0x21b)]?function(_0x9d2788,_0x3d21dc){const _0x5a0ca7=a8_0x8d4a43;Object['defineProperty'](_0x9d2788,_0x5a0ca7(0x1e2),{'enumerable':!![],'value':_0x3d21dc});}:function(_0x271ee9,_0x246c17){const _0x1d5882=a8_0x8d4a43;_0x271ee9[_0x1d5882(0x1e2)]=_0x246c17;}),__importStar=this&&this[a8_0x8d4a43(0x1cc)]||(function(){var _0x20481d=function(_0x44e2f4){const _0x194c8b=a8_0x7ae2;return _0x20481d=Object[_0x194c8b(0x1dd)]||function(_0x18858d){const _0x89c3ac=_0x194c8b;var _0x1e098a=[];for(var _0x8518a8 in _0x18858d)if(Object[_0x89c3ac(0x1d5)][_0x89c3ac(0x22d)]['call'](_0x18858d,_0x8518a8))_0x1e098a[_0x1e098a[_0x89c3ac(0x212)]]=_0x8518a8;return _0x1e098a;},_0x20481d(_0x44e2f4);};return function(_0x5ef42c){const _0x454dbe=a8_0x7ae2;if(_0x5ef42c&&_0x5ef42c[_0x454dbe(0x204)])return _0x5ef42c;var _0xefeb01={};if(_0x5ef42c!=null){for(var _0x548632=_0x20481d(_0x5ef42c),_0x4fccd4=0x0;_0x4fccd4<_0x548632[_0x454dbe(0x212)];_0x4fccd4++)if(_0x548632[_0x4fccd4]!==_0x454dbe(0x1e2))__createBinding(_0xefeb01,_0x5ef42c,_0x548632[_0x4fccd4]);}return __setModuleDefault(_0xefeb01,_0x5ef42c),_0xefeb01;};}()),__importDefault=this&&this['__importDefault']||function(_0x16db35){const _0x363722=a8_0x8d4a43;return _0x16db35&&_0x16db35[_0x363722(0x204)]?_0x16db35:{'default':_0x16db35};};Object[a8_0x8d4a43(0x224)](exports,a8_0x8d4a43(0x204),{'value':!![]}),exports[a8_0x8d4a43(0x1f7)]=void 0x0;const paymentService_1=require(a8_0x8d4a43(0x21c)),mastercardService_1=require(a8_0x8d4a43(0x1d7)),webhookService_1=require(a8_0x8d4a43(0x222)),database_1=__importDefault(require(a8_0x8d4a43(0x1fc)));class PaymentController{constructor(){const _0x7be7f8=a8_0x8d4a43;this[_0x7be7f8(0x1f8)]=async(_0x40f225,_0x1a4307,_0x3e450c)=>{const _0x2d9ee2=_0x7be7f8;try{const _0x3499c9=_0x40f225[_0x2d9ee2(0x1ea)],_0x5dcf7d=await this['paymentService']['createPublicPayment'](_0x3499c9);_0x1a4307['status'](0xc9)['json']({'success':!![],'message':_0x2d9ee2(0x1fd),'result':_0x5dcf7d});}catch(_0x18234b){_0x3e450c(_0x18234b);}},this['getPaymentStatus']=async(_0x58e974,_0x4dd5a4,_0xfa5909)=>{const _0xe61ebf=_0x7be7f8;try{const {id:_0x10da5b}=_0x58e974[_0xe61ebf(0x1e8)],_0x43330c=await this[_0xe61ebf(0x1c8)]['getPaymentStatus'](_0x10da5b);if(!_0x43330c)return _0x4dd5a4[_0xe61ebf(0x213)](0x194)[_0xe61ebf(0x1e9)]({'success':![],'message':_0xe61ebf(0x229)});_0x4dd5a4[_0xe61ebf(0x1e9)]({'success':!![],'result':_0x43330c});}catch(_0x127b41){_0xfa5909(_0x127b41);}},this[_0x7be7f8(0x1ec)]=async(_0x2e76ca,_0x2e863a,_0x1b1104)=>{const _0x3f55d7=_0x7be7f8;try{const {id:_0x1123b8}=_0x2e76ca[_0x3f55d7(0x1e8)],_0x51d2f7=await this[_0x3f55d7(0x1c8)][_0x3f55d7(0x1ec)](_0x1123b8);if(!_0x51d2f7)return _0x2e863a[_0x3f55d7(0x213)](0x194)[_0x3f55d7(0x1e9)]({'success':![],'message':_0x3f55d7(0x229)});_0x2e863a[_0x3f55d7(0x1e9)]({'success':!![],'result':_0x51d2f7});}catch(_0x14479b){_0x1b1104(_0x14479b);}},this[_0x7be7f8(0x1f4)]=async(_0x4b1269,_0x2e946f,_0x283616)=>{const _0x581e42=_0x7be7f8;try{const {id:_0x1c5672}=_0x4b1269[_0x581e42(0x1e8)],_0x4c850d=_0x4b1269[_0x581e42(0x1ea)];console[_0x581e42(0x22c)](_0x581e42(0x1e1)+_0x1c5672),console['log'](_0x581e42(0x211),_0x4c850d);const _0x383154=await this[_0x581e42(0x1c8)][_0x581e42(0x210)](_0x1c5672,_0x4c850d);if(!_0x383154)return _0x2e946f[_0x581e42(0x213)](0x194)['json']({'success':![],'message':_0x581e42(0x229)});_0x2e946f[_0x581e42(0x1e9)]({'success':!![],'message':_0x581e42(0x1d8),'result':{'paymentId':_0x383154['id'],'customerIp':_0x383154[_0x581e42(0x1eb)],'customerUa':_0x383154[_0x581e42(0x235)],'customerCountry':_0x383154[_0x581e42(0x205)],'updatedAt':_0x383154[_0x581e42(0x207)]}});}catch(_0x3686ef){_0x283616(_0x3686ef);}},this[_0x7be7f8(0x1f0)]=async(_0x371a8f,_0x54ee1a,_0xbb074a)=>{const _0x1f41f5=_0x7be7f8;try{const {id:_0xb8c3fc}=_0x371a8f[_0x1f41f5(0x1e8)],{cardData:_0x50a8fc,cardHolder:_0x447c3c,browser:_0x184257}=_0x371a8f[_0x1f41f5(0x1ea)];console['log'](_0x1f41f5(0x21e)+_0xb8c3fc);const _0xbfab1d=await database_1[_0x1f41f5(0x1e2)][_0x1f41f5(0x1f9)]['findUnique']({'where':{'id':_0xb8c3fc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xbfab1d)return _0x54ee1a['status'](0x194)[_0x1f41f5(0x1e9)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xbfab1d[_0x1f41f5(0x1e6)]!==_0x1f41f5(0x21f))return _0x54ee1a[_0x1f41f5(0x213)](0x190)['json']({'success':![],'message':_0x1f41f5(0x1da)});if(_0xbfab1d['status']!=='PENDING')return _0x54ee1a[_0x1f41f5(0x213)](0x190)[_0x1f41f5(0x1e9)]({'success':![],'message':_0x1f41f5(0x1c9)+_0xbfab1d['status']+',\x20cannot\x20process'});const _0x2418d2=_0x1f41f5(0x1f1),_0x40351e=_0xbfab1d['successUrl'];console[_0x1f41f5(0x22c)](_0x1f41f5(0x1df)),console[_0x1f41f5(0x22c)](_0x1f41f5(0x220)+_0x2418d2),console['log'](_0x1f41f5(0x200)+_0x40351e);const _0x5812e3=await this[_0x1f41f5(0x1fa)][_0x1f41f5(0x22f)]({'paymentId':_0xbfab1d['id'],'orderId':_0xbfab1d[_0x1f41f5(0x20d)]||_0xbfab1d['id'],'amount':_0xbfab1d[_0x1f41f5(0x1ce)],'currency':_0xbfab1d[_0x1f41f5(0x1e5)],'cardData':_0x50a8fc,'resultUrl':_0x2418d2,'returnUrl':_0x40351e,'cardHolder':_0x447c3c,'browser':_0x184257});console[_0x1f41f5(0x22c)]('üí≥\x20MasterCard\x20result:',_0x5812e3);const _0x45cc6a={'status':_0x5812e3['status'],'updatedAt':new Date(),'statusChangedBy':_0x1f41f5(0x21d),'statusChangedAt':new Date()};if(_0x5812e3[_0x1f41f5(0x213)]===_0x1f41f5(0x1e7))_0x45cc6a[_0x1f41f5(0x1e0)]=new Date(),_0x45cc6a[_0x1f41f5(0x1d4)]=_0x5812e3[_0x1f41f5(0x202)];else _0x5812e3[_0x1f41f5(0x213)]===_0x1f41f5(0x225)&&(_0x45cc6a[_0x1f41f5(0x231)]=_0x1f41f5(0x234));_0x45cc6a[_0x1f41f5(0x1ed)]=_0x1f41f5(0x21f),await database_1[_0x1f41f5(0x1e2)][_0x1f41f5(0x1f9)][_0x1f41f5(0x227)]({'where':{'id':_0xbfab1d['id']},'data':_0x45cc6a}),await database_1['default']['webhookLog'][_0x1f41f5(0x21b)]({'data':{'paymentId':_0xbfab1d['id'],'shopId':_0xbfab1d[_0x1f41f5(0x1d2)],'event':_0x1f41f5(0x219)+_0x5812e3[_0x1f41f5(0x213)]?.[_0x1f41f5(0x237)](),'statusCode':0xc8,'responseBody':JSON[_0x1f41f5(0x1d1)]({'oldStatus':'PENDING','newStatus':_0x5812e3[_0x1f41f5(0x213)],'gatewayPaymentId':_0x5812e3['gateway_payment_id'],'requires3ds':_0x5812e3[_0x1f41f5(0x1ef)],'processedAt':new Date()[_0x1f41f5(0x233)]()})}});_0x5812e3[_0x1f41f5(0x223)]&&(await this[_0x1f41f5(0x230)](_0xbfab1d,_0x5812e3[_0x1f41f5(0x213)],_0x5812e3[_0x1f41f5(0x202)]),await this[_0x1f41f5(0x1f5)](_0xbfab1d,_0x5812e3['status']));console[_0x1f41f5(0x22c)](_0x1f41f5(0x214)+_0xb8c3fc+_0x1f41f5(0x1ee)+_0x5812e3['status']);if(_0x5812e3[_0x1f41f5(0x213)]===_0x1f41f5(0x1e7))_0x54ee1a[_0x1f41f5(0x1e9)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x1f41f5(0x1e7),'gatewayPaymentId':_0x5812e3[_0x1f41f5(0x202)],'redirectUrl':_0x40351e,'final':!![]}});else _0x5812e3[_0x1f41f5(0x1ef)]&&_0x5812e3[_0x1f41f5(0x23f)]?_0x54ee1a[_0x1f41f5(0x1e9)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':'PENDING','gatewayPaymentId':_0x5812e3['gateway_payment_id'],'redirectUrl':_0x5812e3[_0x1f41f5(0x23f)],'requires3ds':!![],'final':![]}}):_0x54ee1a[_0x1f41f5(0x213)](0x190)[_0x1f41f5(0x1e9)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x1f41f5(0x225),'gatewayPaymentId':_0x5812e3[_0x1f41f5(0x202)],'redirectUrl':_0xbfab1d[_0x1f41f5(0x209)],'final':!![]}});}catch(_0x6bf63c){_0xbb074a(_0x6bf63c);}},this[_0x7be7f8(0x1c8)]=new paymentService_1[(_0x7be7f8(0x20e))](),this[_0x7be7f8(0x1fa)]=new mastercardService_1[(_0x7be7f8(0x20a))](),this[_0x7be7f8(0x1ff)]=new webhookService_1[(_0x7be7f8(0x1de))]();}async['sendShopWebhook'](_0x748b65,_0x279120,_0x3c59f8){const _0x11e602=a8_0x8d4a43,_0x20247b=Date['now']();try{const _0x5687de=_0x748b65[_0x11e602(0x1d0)],_0x439d10=_0x5687de[_0x11e602(0x22e)];if(!_0x439d10?.[_0x11e602(0x228)]){console[_0x11e602(0x22c)](_0x11e602(0x1f3)+_0x5687de['id']);return;}const _0x566575=_0x279120===_0x11e602(0x1e7)?_0x11e602(0x208):_0x11e602(0x1cb);let _0x7aa5b=[];if(_0x439d10[_0x11e602(0x1f6)])try{_0x7aa5b=Array[_0x11e602(0x22a)](_0x439d10[_0x11e602(0x1f6)])?_0x439d10[_0x11e602(0x1f6)]:JSON[_0x11e602(0x232)](_0x439d10[_0x11e602(0x1f6)]);}catch(_0x57961e){console[_0x11e602(0x203)]('Error\x20parsing\x20webhook\x20events:',_0x57961e),_0x7aa5b=[];}if(!_0x7aa5b[_0x11e602(0x20f)](_0x566575)){console[_0x11e602(0x22c)](_0x11e602(0x1fb)+_0x566575+'\x20not\x20enabled\x20for\x20shop\x20'+_0x5687de['id']);return;}const _0x5907cb={'event':_0x566575,'payment':{'id':_0x748b65['id'],'order_id':_0x748b65['orderId'],'gateway_order_id':_0x748b65[_0x11e602(0x20d)],'gateway':'1111','amount':_0x748b65[_0x11e602(0x1ce)],'currency':_0x748b65[_0x11e602(0x1e5)],'status':_0x279120[_0x11e602(0x237)](),'customer_email':_0x748b65[_0x11e602(0x1d9)],'customer_name':_0x748b65[_0x11e602(0x217)],'gateway_payment_id':_0x3c59f8,'created_at':_0x748b65[_0x11e602(0x1e4)],'updated_at':new Date()}},_0x2bdfbb=await fetch(_0x439d10['webhookUrl'],{'method':_0x11e602(0x1d3),'headers':{'Content-Type':_0x11e602(0x23d),'User-Agent':_0x11e602(0x239)},'body':JSON['stringify'](_0x5907cb)}),_0x18ba8b=Date[_0x11e602(0x23e)]()-_0x20247b;console[_0x11e602(0x22c)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x439d10[_0x11e602(0x228)]+_0x11e602(0x201)+_0x2bdfbb[_0x11e602(0x213)]+'\x20('+_0x18ba8b+_0x11e602(0x1cd));}catch(_0x2c1314){console[_0x11e602(0x203)](_0x11e602(0x20c),_0x2c1314);}}async['sendPaymentStatusNotification'](_0x1836ef,_0x13a59f){const _0x13d4c1=a8_0x8d4a43;try{const {telegramBotService:_0x46f485}=await Promise['resolve']()[_0x13d4c1(0x236)](()=>__importStar(require('../services/telegramBotService'))),_0x4953f6={'PAID':_0x13d4c1(0x1fe),'FAILED':_0x13d4c1(0x23c)},_0x520a05=_0x4953f6[_0x13a59f];if(!_0x520a05)return;await _0x46f485[_0x13d4c1(0x218)](_0x1836ef[_0x13d4c1(0x1d2)],_0x1836ef,_0x520a05);}catch(_0x1afe6f){console[_0x13d4c1(0x203)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1afe6f);}}}exports[a8_0x8d4a43(0x1f7)]=PaymentController;