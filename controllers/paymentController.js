'use strict';function a8_0x1187(){const _0x216b04=['sendShopWebhook','payment.success','41260ZMLQwb','PaymentService','2225936ZlyNhR','81zdthYQ','gatewayOrderId','getOwnPropertyNames','updateCustomerData','processCardPayment','webhookService','WebhookService','ðŸ’³\x20MasterCard\x20URLs:','amount','__createBinding','webhookLog','gateway_payment_id','PAID','__esModule','../services/gateways/mastercardService','paidAt','536055OtRfZC','getPaymentStatus','status','PENDING','2079710dsCbgj','application/json','gatewayPaymentId','mastercard_','Payment\x20not\x20found','MasterCard\x20webhook\x20sent\x20to\x20','customerName','then','failUrl','settings','webhookEvents','668723GwFvQs','error','requires_3ds','body','failureMessage','isArray','params','defineProperty','../services/telegramBotService','Payment\x20created\x20successfully','âœ…\x20MasterCard\x20payment\x20','writable','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','POST','webhookUrl','includes','FAILED','mastercard','Payment\x20status\x20is\x20','default','json','Payment\x20processed\x20successfully','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','masterCardService','final',',\x20cannot\x20process','log','__importDefault','get','processMasterCardPayment','create','\x20\x20\x20Return\x20URL:\x20','payment','sendPaymentNotification','../config/database','update','Card\x20payment\x20failed','gateway','successUrl','length','PaymentController','...','paymentService','ðŸ’³\x20MasterCard\x20result:','MasterCardService','toLowerCase','paid','now','not\x20provided','Payment\x20failed','paymentMethod','1680791GRvMuQ','system','https://api.trapay.uk/api/webhooks/gateway/mastercard','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','toISOString','findUnique','hasOwnProperty','createPublicPayment','\x20not\x20enabled\x20for\x20shop\x20','../services/paymentService','4996612IzqJGF','150TCUFLO','createdAt','getOwnPropertyDescriptor','sendPaymentStatusNotification','1111','shop','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','ms)','stringify','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','prototype','Webhook\x20event\x20','orderId'];a8_0x1187=function(){return _0x216b04;};return a8_0x1187();}const a8_0x1e2a82=a8_0x3ccd;(function(_0x2b984c,_0x47d7a0){const _0xd96785=a8_0x3ccd,_0x2f17aa=_0x2b984c();while(!![]){try{const _0x3588c3=parseInt(_0xd96785(0x131))/0x1+parseInt(_0xd96785(0x126))/0x2+-parseInt(_0xd96785(0x122))/0x3+parseInt(_0xd96785(0x16e))/0x4+-parseInt(_0xd96785(0x17e))/0x5*(-parseInt(_0xd96785(0x16f))/0x6)+parseInt(_0xd96785(0x164))/0x7+parseInt(_0xd96785(0x180))/0x8*(-parseInt(_0xd96785(0x181))/0x9);if(_0x3588c3===_0x47d7a0)break;else _0x2f17aa['push'](_0x2f17aa['shift']());}catch(_0xc0957f){_0x2f17aa['push'](_0x2f17aa['shift']());}}}(a8_0x1187,0xb0181));function a8_0x3ccd(_0x36fc7c,_0x54c753){const _0x118709=a8_0x1187();return a8_0x3ccd=function(_0x3ccdaf,_0x1ad0e7){_0x3ccdaf=_0x3ccdaf-0x113;let _0x306d74=_0x118709[_0x3ccdaf];return _0x306d74;},a8_0x3ccd(_0x36fc7c,_0x54c753);}var __createBinding=this&&this[a8_0x1e2a82(0x11b)]||(Object[a8_0x1e2a82(0x14f)]?function(_0x2870b5,_0x3da289,_0x20b4ac,_0x394411){const _0x2a96d9=a8_0x1e2a82;if(_0x394411===undefined)_0x394411=_0x20b4ac;var _0x3f4f90=Object[_0x2a96d9(0x171)](_0x3da289,_0x20b4ac);(!_0x3f4f90||(_0x2a96d9(0x14d)in _0x3f4f90?!_0x3da289[_0x2a96d9(0x11f)]:_0x3f4f90[_0x2a96d9(0x13c)]||_0x3f4f90['configurable']))&&(_0x3f4f90={'enumerable':!![],'get':function(){return _0x3da289[_0x20b4ac];}}),Object[_0x2a96d9(0x138)](_0x2870b5,_0x394411,_0x3f4f90);}:function(_0x293db2,_0x3bb68b,_0x2eac0f,_0x3fcf7b){if(_0x3fcf7b===undefined)_0x3fcf7b=_0x2eac0f;_0x293db2[_0x3fcf7b]=_0x3bb68b[_0x2eac0f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x1e2a82(0x14f)]?function(_0x1d7d4b,_0x28553f){const _0x2b28d4=a8_0x1e2a82;Object[_0x2b28d4(0x138)](_0x1d7d4b,_0x2b28d4(0x144),{'enumerable':!![],'value':_0x28553f});}:function(_0x525b7e,_0x53a0c4){const _0x54baf3=a8_0x1e2a82;_0x525b7e[_0x54baf3(0x144)]=_0x53a0c4;}),__importStar=this&&this['__importStar']||(function(){var _0x444c32=function(_0x3a54a6){const _0x4696b1=a8_0x3ccd;return _0x444c32=Object[_0x4696b1(0x114)]||function(_0x2978cd){const _0x484875=_0x4696b1;var _0x5741b8=[];for(var _0x423748 in _0x2978cd)if(Object[_0x484875(0x179)][_0x484875(0x16a)]['call'](_0x2978cd,_0x423748))_0x5741b8[_0x5741b8[_0x484875(0x158)]]=_0x423748;return _0x5741b8;},_0x444c32(_0x3a54a6);};return function(_0x16f462){const _0x1fbf8b=a8_0x3ccd;if(_0x16f462&&_0x16f462['__esModule'])return _0x16f462;var _0x18f7e8={};if(_0x16f462!=null){for(var _0xd2c1cb=_0x444c32(_0x16f462),_0x372c4a=0x0;_0x372c4a<_0xd2c1cb[_0x1fbf8b(0x158)];_0x372c4a++)if(_0xd2c1cb[_0x372c4a]!=='default')__createBinding(_0x18f7e8,_0x16f462,_0xd2c1cb[_0x372c4a]);}return __setModuleDefault(_0x18f7e8,_0x16f462),_0x18f7e8;};}()),__importDefault=this&&this[a8_0x1e2a82(0x14c)]||function(_0x5b85c6){return _0x5b85c6&&_0x5b85c6['__esModule']?_0x5b85c6:{'default':_0x5b85c6};};Object[a8_0x1e2a82(0x138)](exports,a8_0x1e2a82(0x11f),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x1e2a82(0x16d)),mastercardService_1=require(a8_0x1e2a82(0x120)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x1e2a82(0x153)));class PaymentController{constructor(){const _0x43b9e8=a8_0x1e2a82;this[_0x43b9e8(0x16b)]=async(_0x1c3ce0,_0x3abe13,_0x4a2989)=>{const _0x32397a=_0x43b9e8;try{const _0x384135=_0x1c3ce0[_0x32397a(0x134)],_0x4316a1=await this[_0x32397a(0x15b)]['createPublicPayment'](_0x384135);_0x3abe13[_0x32397a(0x124)](0xc9)['json']({'success':!![],'message':_0x32397a(0x13a),'result':_0x4316a1});}catch(_0x216a77){_0x4a2989(_0x216a77);}},this['getPaymentStatus']=async(_0x474b4d,_0x3ec151,_0x3b68b5)=>{const _0xc344fc=_0x43b9e8;try{const {id:_0x4ddd41}=_0x474b4d[_0xc344fc(0x137)],_0x381ad5=await this['paymentService'][_0xc344fc(0x123)](_0x4ddd41);if(!_0x381ad5)return _0x3ec151[_0xc344fc(0x124)](0x194)[_0xc344fc(0x145)]({'success':![],'message':_0xc344fc(0x12a)});_0x3ec151['json']({'success':!![],'result':_0x381ad5});}catch(_0x55a594){_0x3b68b5(_0x55a594);}},this['getPaymentById']=async(_0x2cad8a,_0x4a3b0c,_0xd9dfbb)=>{const _0x2ca325=_0x43b9e8;try{const {id:_0x26500b}=_0x2cad8a[_0x2ca325(0x137)],_0x464de3=await this[_0x2ca325(0x15b)]['getPaymentById'](_0x26500b);if(!_0x464de3)return _0x4a3b0c[_0x2ca325(0x124)](0x194)[_0x2ca325(0x145)]({'success':![],'message':_0x2ca325(0x12a)});_0x4a3b0c[_0x2ca325(0x145)]({'success':!![],'result':_0x464de3});}catch(_0x4d53ff){_0xd9dfbb(_0x4d53ff);}},this[_0x43b9e8(0x14e)]=async(_0x109438,_0x5bba96,_0x5bb420)=>{const _0xf2ca4f=_0x43b9e8;try{const {id:_0x1fa1da}=_0x109438[_0xf2ca4f(0x137)],{cardData:_0x3efc8e,cardHolder:_0x329cbd,browser:_0xe1401}=_0x109438[_0xf2ca4f(0x134)];console['log'](_0xf2ca4f(0x167)+_0x1fa1da);const _0x548360=await database_1[_0xf2ca4f(0x144)]['payment'][_0xf2ca4f(0x169)]({'where':{'id':_0x1fa1da},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x548360)return _0x5bba96[_0xf2ca4f(0x124)](0x194)[_0xf2ca4f(0x145)]({'success':![],'message':_0xf2ca4f(0x12a)});if(_0x548360[_0xf2ca4f(0x156)]!==_0xf2ca4f(0x142))return _0x5bba96[_0xf2ca4f(0x124)](0x190)[_0xf2ca4f(0x145)]({'success':![],'message':_0xf2ca4f(0x175)});if(_0x548360[_0xf2ca4f(0x124)]!==_0xf2ca4f(0x125))return _0x5bba96[_0xf2ca4f(0x124)](0x190)[_0xf2ca4f(0x145)]({'success':![],'message':_0xf2ca4f(0x143)+_0x548360['status']+_0xf2ca4f(0x14a)});const _0x217b88=_0xf2ca4f(0x166),_0x45f2f5=_0x548360[_0xf2ca4f(0x157)];console[_0xf2ca4f(0x14b)](_0xf2ca4f(0x119)),console[_0xf2ca4f(0x14b)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x217b88),console['log'](_0xf2ca4f(0x150)+_0x45f2f5);const _0x51344b=await this[_0xf2ca4f(0x148)][_0xf2ca4f(0x116)]({'paymentId':_0x548360['id'],'orderId':_0x548360[_0xf2ca4f(0x113)]||_0x548360['id'],'amount':_0x548360[_0xf2ca4f(0x11a)],'currency':_0x548360['currency'],'cardData':_0x3efc8e,'resultUrl':_0x217b88,'returnUrl':_0x45f2f5,'cardHolder':_0x329cbd,'browser':_0xe1401});console[_0xf2ca4f(0x14b)](_0xf2ca4f(0x15c),_0x51344b);const _0x523c88={'status':_0x51344b[_0xf2ca4f(0x124)],'updatedAt':new Date(),'statusChangedBy':_0xf2ca4f(0x165),'statusChangedAt':new Date()};if(_0x51344b[_0xf2ca4f(0x124)]===_0xf2ca4f(0x11e))_0x523c88[_0xf2ca4f(0x121)]=new Date(),_0x523c88[_0xf2ca4f(0x128)]=_0x51344b['gateway_payment_id'];else _0x51344b[_0xf2ca4f(0x124)]===_0xf2ca4f(0x141)&&(_0x523c88[_0xf2ca4f(0x135)]=_0xf2ca4f(0x155));_0x523c88[_0xf2ca4f(0x163)]=_0xf2ca4f(0x142),await database_1[_0xf2ca4f(0x144)]['payment'][_0xf2ca4f(0x154)]({'where':{'id':_0x548360['id']},'data':_0x523c88}),await database_1[_0xf2ca4f(0x144)][_0xf2ca4f(0x11c)][_0xf2ca4f(0x14f)]({'data':{'paymentId':_0x548360['id'],'shopId':_0x548360['shopId'],'event':_0xf2ca4f(0x129)+_0x51344b['status']?.[_0xf2ca4f(0x15e)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0xf2ca4f(0x125),'newStatus':_0x51344b[_0xf2ca4f(0x124)],'gatewayPaymentId':_0x51344b[_0xf2ca4f(0x11d)],'requires3ds':_0x51344b[_0xf2ca4f(0x133)],'processedAt':new Date()[_0xf2ca4f(0x168)]()})}});_0x51344b[_0xf2ca4f(0x149)]&&(await this[_0xf2ca4f(0x17c)](_0x548360,_0x51344b['status'],_0x51344b[_0xf2ca4f(0x11d)]),await this[_0xf2ca4f(0x172)](_0x548360,_0x51344b[_0xf2ca4f(0x124)]));console[_0xf2ca4f(0x14b)](_0xf2ca4f(0x13b)+_0x1fa1da+'\x20processed:\x20'+_0x51344b[_0xf2ca4f(0x124)]);if(_0x51344b[_0xf2ca4f(0x124)]==='PAID')_0x5bba96[_0xf2ca4f(0x145)]({'success':!![],'message':_0xf2ca4f(0x146),'result':{'status':_0xf2ca4f(0x11e),'gatewayPaymentId':_0x51344b['gateway_payment_id'],'redirectUrl':_0x45f2f5,'final':!![]}});else _0x51344b['requires_3ds']&&_0x51344b['threeds_url']?_0x5bba96[_0xf2ca4f(0x145)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0xf2ca4f(0x125),'gatewayPaymentId':_0x51344b[_0xf2ca4f(0x11d)],'redirectUrl':_0x51344b['threeds_url'],'requires3ds':!![],'final':![]}}):_0x5bba96[_0xf2ca4f(0x124)](0x190)[_0xf2ca4f(0x145)]({'success':![],'message':_0xf2ca4f(0x162),'result':{'status':_0xf2ca4f(0x141),'gatewayPaymentId':_0x51344b['gateway_payment_id'],'redirectUrl':_0x548360[_0xf2ca4f(0x12e)],'final':!![]}});}catch(_0x16c799){_0x5bb420(_0x16c799);}},this[_0x43b9e8(0x115)]=async(_0x5876bc,_0x4f4259,_0x159090)=>{const _0x43aa12=_0x43b9e8;try{const {id:_0x492dc2}=_0x5876bc[_0x43aa12(0x137)],{customerIp:_0x263926,customerUa:_0x5a3aef,customerCountry:_0x444bb0}=_0x5876bc[_0x43aa12(0x134)],_0x1e0572=await database_1[_0x43aa12(0x144)][_0x43aa12(0x151)][_0x43aa12(0x169)]({'where':{'id':_0x492dc2},'select':{'id':!![],'status':!![]}});if(!_0x1e0572)return _0x4f4259[_0x43aa12(0x124)](0x194)[_0x43aa12(0x145)]({'success':![],'message':'Payment\x20not\x20found'});const _0x1d6739=await database_1[_0x43aa12(0x144)][_0x43aa12(0x151)]['update']({'where':{'id':_0x492dc2},'data':{'customerIp':_0x263926||undefined,'customerUa':_0x5a3aef||undefined,'customerCountry':_0x444bb0||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x43aa12(0x14b)](_0x43aa12(0x13d)+_0x492dc2+':',{'customerIp':_0x263926||'not\x20provided','customerUa':_0x5a3aef?_0x5a3aef['substring'](0x0,0x32)+_0x43aa12(0x15a):_0x43aa12(0x161),'customerCountry':_0x444bb0||_0x43aa12(0x161)}),_0x4f4259['json']({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':_0x1d6739});}catch(_0x149f80){_0x159090(_0x149f80);}},this[_0x43b9e8(0x15b)]=new paymentService_1[(_0x43b9e8(0x17f))](),this[_0x43b9e8(0x148)]=new mastercardService_1[(_0x43b9e8(0x15d))](),this[_0x43b9e8(0x117)]=new webhookService_1[(_0x43b9e8(0x118))]();}async[a8_0x1e2a82(0x17c)](_0x3d0d41,_0x338ce5,_0x283f05){const _0x2a5f4b=a8_0x1e2a82,_0x1301e4=Date[_0x2a5f4b(0x160)]();try{const _0x3bd9ef=_0x3d0d41[_0x2a5f4b(0x174)],_0x4e831a=_0x3bd9ef[_0x2a5f4b(0x12f)];if(!_0x4e831a?.[_0x2a5f4b(0x13f)]){console[_0x2a5f4b(0x14b)](_0x2a5f4b(0x147)+_0x3bd9ef['id']);return;}const _0x46e8b0=_0x338ce5===_0x2a5f4b(0x11e)?_0x2a5f4b(0x17d):'payment.failed';let _0x802bf5=[];if(_0x4e831a[_0x2a5f4b(0x130)])try{_0x802bf5=Array[_0x2a5f4b(0x136)](_0x4e831a['webhookEvents'])?_0x4e831a[_0x2a5f4b(0x130)]:JSON['parse'](_0x4e831a[_0x2a5f4b(0x130)]);}catch(_0x182b57){console[_0x2a5f4b(0x132)]('Error\x20parsing\x20webhook\x20events:',_0x182b57),_0x802bf5=[];}if(!_0x802bf5[_0x2a5f4b(0x140)](_0x46e8b0)){console[_0x2a5f4b(0x14b)](_0x2a5f4b(0x17a)+_0x46e8b0+_0x2a5f4b(0x16c)+_0x3bd9ef['id']);return;}const _0x45f979={'event':_0x46e8b0,'payment':{'id':_0x3d0d41['id'],'order_id':_0x3d0d41[_0x2a5f4b(0x17b)],'gateway_order_id':_0x3d0d41[_0x2a5f4b(0x113)],'gateway':_0x2a5f4b(0x173),'amount':_0x3d0d41[_0x2a5f4b(0x11a)],'currency':_0x3d0d41['currency'],'status':_0x338ce5['toLowerCase'](),'customer_email':_0x3d0d41['customerEmail'],'customer_name':_0x3d0d41[_0x2a5f4b(0x12c)],'gateway_payment_id':_0x283f05,'created_at':_0x3d0d41[_0x2a5f4b(0x170)],'updated_at':new Date()}},_0x7d5dc2=await fetch(_0x4e831a[_0x2a5f4b(0x13f)],{'method':_0x2a5f4b(0x13e),'headers':{'Content-Type':_0x2a5f4b(0x127),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x2a5f4b(0x177)](_0x45f979)}),_0x10ad46=Date[_0x2a5f4b(0x160)]()-_0x1301e4;console['log'](_0x2a5f4b(0x12b)+_0x4e831a[_0x2a5f4b(0x13f)]+'\x20with\x20status\x20'+_0x7d5dc2[_0x2a5f4b(0x124)]+'\x20('+_0x10ad46+_0x2a5f4b(0x176));}catch(_0x3bfb62){console[_0x2a5f4b(0x132)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x3bfb62);}}async[a8_0x1e2a82(0x172)](_0x43a911,_0x499261){const _0x1430f0=a8_0x1e2a82;try{const {telegramBotService:_0x512cd0}=await Promise['resolve']()[_0x1430f0(0x12d)](()=>__importStar(require(_0x1430f0(0x139)))),_0x56df3d={'PAID':_0x1430f0(0x15f),'FAILED':'failed'},_0x2ea7a3=_0x56df3d[_0x499261];if(!_0x2ea7a3)return;await _0x512cd0[_0x1430f0(0x152)](_0x43a911['shopId'],_0x43a911,_0x2ea7a3);}catch(_0x32349d){console[_0x1430f0(0x132)](_0x1430f0(0x178),_0x32349d);}}}exports[a8_0x1e2a82(0x159)]=PaymentController;