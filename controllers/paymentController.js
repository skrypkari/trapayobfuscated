'use strict';const a8_0x5744b9=a8_0x5662;function a8_0x13ff(){const _0x571990=['POST','customerCountry','stringify','mastercard','system','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','payment.success','Payment\x20processed\x20successfully','now','3755880bhjmry','3776240RCakBo','requires_3ds','shopId','resolve','includes','toLowerCase','üí≥\x20Browser\x20IP:\x20','Error\x20parsing\x20webhook\x20events:','gateway_payment_id','body','5XYRPJa','../services/paymentLinkService','üìù\x20Customer\x20data:','1552xezZZK','PENDING','gatewayPaymentId','Card\x20payment\x20failed','default','params','update','createdAt','first_name','sendPaymentNotification','createPublicPayment','threeds_url','3DS\x20verification\x20required','isArray','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','slice','../services/gateways/mastercardService','üí≥\x20Card\x20holder:\x20','Payment\x20created\x20successfully','üí≥\x20MasterCard\x20result:','webhookLog','Payment\x20status\x20is\x20','8dsFjIV','webhookUrl','2314302ANuqWx','payment','prototype','\x20\x20\x20Return\x20URL:\x20','configurable','https://api.trapay.uk/api/webhooks/gateway/mastercard','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','log','last_name','üí≥\x20Processing\x20MasterCard\x20payment:\x20','email','customerEmail','number','application/json','paymentService','gateway','failureMessage','üí≥\x20MasterCard\x20URLs:','handleSuccessfulPayment','getOwnPropertyDescriptor','customerIp','FAILED','gatewayOrderId','\x20with\x20status\x20','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','Customer\x20data\x20updated\x20successfully','writable','__setModuleDefault','sendPaymentStatusNotification','PAID','getPaymentStatus','final','findUnique','json','cardLast4','webhookEvents','updatedAt','__esModule','payment.failed','defineProperty','5606912dRDwWa','failed','updatePaymentCustomerDataPublic','parse','error','processMasterCardPayment','masterCardService','WebhookService','getOwnPropertyNames','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paymentMethod','create','sendShopWebhook','77vhJCQJ','failUrl','customerName','getPaymentById','currency','status','8822590pMkHyp','hasOwnProperty','toISOString','\x20processed:\x20','PaymentService','get','processCardPayment','then','MasterCardService','__createBinding','paidAt','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','../services/telegramBotService','Payment\x20not\x20found','\x20not\x20enabled\x20for\x20shop\x20','customerUa','paid','PaymentController','updatePaymentCustomer','1693158uZxzpZ','__importStar','‚úÖ\x20MasterCard\x20payment\x20','1046SxRCqK','length','shop'];a8_0x13ff=function(){return _0x571990;};return a8_0x13ff();}(function(_0x48f694,_0x2ea5ba){const _0x4406f7=a8_0x5662,_0x4a5151=_0x48f694();while(!![]){try{const _0x3f5db9=-parseInt(_0x4406f7(0xd2))/0x1*(-parseInt(_0x4406f7(0xb8))/0x2)+-parseInt(_0x4406f7(0xec))/0x3+parseInt(_0x4406f7(0x8f))/0x4+-parseInt(_0x4406f7(0xcf))/0x5*(-parseInt(_0x4406f7(0xb5))/0x6)+parseInt(_0x4406f7(0xa2))/0x7*(parseInt(_0x4406f7(0xea))/0x8)+parseInt(_0x4406f7(0xc4))/0x9+parseInt(_0x4406f7(0xc5))/0xa*(-parseInt(_0x4406f7(0x9c))/0xb);if(_0x3f5db9===_0x2ea5ba)break;else _0x4a5151['push'](_0x4a5151['shift']());}catch(_0x4106ee){_0x4a5151['push'](_0x4a5151['shift']());}}}(a8_0x13ff,0xb92e9));var __createBinding=this&&this[a8_0x5744b9(0xab)]||(Object[a8_0x5744b9(0x9a)]?function(_0x20a5cd,_0x2be063,_0x272087,_0x54094d){const _0x5aef58=a8_0x5744b9;if(_0x54094d===undefined)_0x54094d=_0x272087;var _0x7a3774=Object[_0x5aef58(0xff)](_0x2be063,_0x272087);(!_0x7a3774||(_0x5aef58(0xa7)in _0x7a3774?!_0x2be063['__esModule']:_0x7a3774[_0x5aef58(0x106)]||_0x7a3774[_0x5aef58(0xf0)]))&&(_0x7a3774={'enumerable':!![],'get':function(){return _0x2be063[_0x272087];}}),Object[_0x5aef58(0x8e)](_0x20a5cd,_0x54094d,_0x7a3774);}:function(_0x52cc07,_0xe6cf74,_0x24ee7f,_0x497eeb){if(_0x497eeb===undefined)_0x497eeb=_0x24ee7f;_0x52cc07[_0x497eeb]=_0xe6cf74[_0x24ee7f];}),__setModuleDefault=this&&this[a8_0x5744b9(0x107)]||(Object[a8_0x5744b9(0x9a)]?function(_0x4c25c6,_0x24c55a){const _0x1dcb1f=a8_0x5744b9;Object[_0x1dcb1f(0x8e)](_0x4c25c6,_0x1dcb1f(0xd6),{'enumerable':!![],'value':_0x24c55a});}:function(_0x4b17c9,_0x2c48df){_0x4b17c9['default']=_0x2c48df;}),__importStar=this&&this[a8_0x5744b9(0xb6)]||(function(){var _0x1efdf9=function(_0x17f771){const _0x21df30=a8_0x5662;return _0x1efdf9=Object[_0x21df30(0x97)]||function(_0x411597){const _0x1f7e07=_0x21df30;var _0x3a26d2=[];for(var _0x409c24 in _0x411597)if(Object[_0x1f7e07(0xee)][_0x1f7e07(0xa3)]['call'](_0x411597,_0x409c24))_0x3a26d2[_0x3a26d2[_0x1f7e07(0xb9)]]=_0x409c24;return _0x3a26d2;},_0x1efdf9(_0x17f771);};return function(_0x4627d0){const _0x365c0b=a8_0x5662;if(_0x4627d0&&_0x4627d0[_0x365c0b(0x8c)])return _0x4627d0;var _0x433b10={};if(_0x4627d0!=null){for(var _0x5b0afd=_0x1efdf9(_0x4627d0),_0x3ab55b=0x0;_0x3ab55b<_0x5b0afd['length'];_0x3ab55b++)if(_0x5b0afd[_0x3ab55b]!==_0x365c0b(0xd6))__createBinding(_0x433b10,_0x4627d0,_0x5b0afd[_0x3ab55b]);}return __setModuleDefault(_0x433b10,_0x4627d0),_0x433b10;};}()),__importDefault=this&&this['__importDefault']||function(_0xe5b71f){return _0xe5b71f&&_0xe5b71f['__esModule']?_0xe5b71f:{'default':_0xe5b71f};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a8_0x5744b9(0xb3)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x5744b9(0xe4)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0xa95888=a8_0x5744b9;this[_0xa95888(0xdc)]=async(_0x54a786,_0x28c31b,_0x4de302)=>{const _0x4db244=_0xa95888;try{const _0x758589=_0x54a786['body'],_0x35136b=await this[_0x4db244(0xfa)]['createPublicPayment'](_0x758589);_0x28c31b['status'](0xc9)[_0x4db244(0x88)]({'success':!![],'message':_0x4db244(0xe6),'result':_0x35136b});}catch(_0x491add){_0x4de302(_0x491add);}},this['getPaymentStatus']=async(_0x11b03e,_0x5e1b65,_0x2bf744)=>{const _0xfda8f0=_0xa95888;try{const {id:_0x4a842e}=_0x11b03e['params'],_0x4fc3af=await this[_0xfda8f0(0xfa)][_0xfda8f0(0x10a)](_0x4a842e);if(!_0x4fc3af)return _0x5e1b65['status'](0x194)[_0xfda8f0(0x88)]({'success':![],'message':'Payment\x20not\x20found'});_0x5e1b65[_0xfda8f0(0x88)]({'success':!![],'result':_0x4fc3af});}catch(_0x2711b2){_0x2bf744(_0x2711b2);}},this[_0xa95888(0x9f)]=async(_0x2cd944,_0x1b2ea7,_0x58a2cb)=>{const _0x3308b7=_0xa95888;try{const {id:_0x5458a9}=_0x2cd944[_0x3308b7(0xd7)],_0x19dd07=await this['paymentService'][_0x3308b7(0x9f)](_0x5458a9);if(!_0x19dd07)return _0x1b2ea7[_0x3308b7(0xa1)](0x194)[_0x3308b7(0x88)]({'success':![],'message':_0x3308b7(0xaf)});_0x1b2ea7['json']({'success':!![],'result':_0x19dd07});}catch(_0x494ec4){_0x58a2cb(_0x494ec4);}},this[_0xa95888(0xb4)]=async(_0xbd20b9,_0x8ae9f7,_0x46c061)=>{const _0x1a4cfa=_0xa95888;try{const {id:_0x252d44}=_0xbd20b9[_0x1a4cfa(0xd7)],_0xc2e297=_0xbd20b9[_0x1a4cfa(0xce)];console[_0x1a4cfa(0xf3)](_0x1a4cfa(0xf2)+_0x252d44),console[_0x1a4cfa(0xf3)](_0x1a4cfa(0xd1),_0xc2e297);const _0x51d40d=await this['paymentService'][_0x1a4cfa(0x91)](_0x252d44,_0xc2e297);if(!_0x51d40d)return _0x8ae9f7[_0x1a4cfa(0xa1)](0x194)[_0x1a4cfa(0x88)]({'success':![],'message':_0x1a4cfa(0xaf)});_0x8ae9f7[_0x1a4cfa(0x88)]({'success':!![],'message':_0x1a4cfa(0x105),'result':{'paymentId':_0x51d40d['id'],'customerIp':_0x51d40d[_0x1a4cfa(0x100)],'customerUa':_0x51d40d[_0x1a4cfa(0xb1)],'customerCountry':_0x51d40d[_0x1a4cfa(0xbc)],'updatedAt':_0x51d40d[_0x1a4cfa(0x8b)]}});}catch(_0x39f3fa){_0x46c061(_0x39f3fa);}},this[_0xa95888(0x94)]=async(_0x4fdf2b,_0x47c3c2,_0x253eb0)=>{const _0x293917=_0xa95888;try{const {id:_0x2f5f53}=_0x4fdf2b[_0x293917(0xd7)],{cardData:_0x11b10f,cardHolder:_0x4f963d,browser:_0x19284d}=_0x4fdf2b[_0x293917(0xce)];console[_0x293917(0xf3)](_0x293917(0xf5)+_0x2f5f53),console[_0x293917(0xf3)](_0x293917(0xe5)+_0x4f963d[_0x293917(0xda)]+'\x20'+_0x4f963d[_0x293917(0xf4)]+'\x20('+_0x4f963d[_0x293917(0xf6)]+')'),console[_0x293917(0xf3)](_0x293917(0xcb)+_0x19284d['ip']);const _0x22f11d={'customerName':_0x4f963d[_0x293917(0xda)]+'\x20'+_0x4f963d[_0x293917(0xf4)],'customerEmail':_0x4f963d[_0x293917(0xf6)],'customerIp':_0x19284d['ip'],'customerUa':_0x19284d['user_agent']},_0xa80d8c=await database_1['default'][_0x293917(0xed)][_0x293917(0x87)]({'where':{'id':_0x2f5f53},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xa80d8c)return _0x47c3c2[_0x293917(0xa1)](0x194)[_0x293917(0x88)]({'success':![],'message':_0x293917(0xaf)});if(_0xa80d8c[_0x293917(0xfb)]!==_0x293917(0xbe))return _0x47c3c2[_0x293917(0xa1)](0x190)[_0x293917(0x88)]({'success':![],'message':_0x293917(0xad)});if(_0xa80d8c[_0x293917(0xa1)]!==_0x293917(0xd3))return _0x47c3c2['status'](0x190)[_0x293917(0x88)]({'success':![],'message':_0x293917(0xe9)+_0xa80d8c[_0x293917(0xa1)]+',\x20cannot\x20process'});await database_1[_0x293917(0xd6)]['payment'][_0x293917(0xd8)]({'where':{'id':_0x2f5f53},'data':{..._0x22f11d,'updatedAt':new Date()}});const _0x29ee8=_0x293917(0xf1),_0x2ebc34=_0xa80d8c['successUrl'];console[_0x293917(0xf3)](_0x293917(0xfd)),console[_0x293917(0xf3)](_0x293917(0xe0)+_0x29ee8),console[_0x293917(0xf3)](_0x293917(0xef)+_0x2ebc34);const _0x18f692={'first_name':_0x4f963d[_0x293917(0xda)],'last_name':_0x4f963d['last_name'],'email':_0x4f963d[_0x293917(0xf6)]},_0x5f50de=await this[_0x293917(0x95)][_0x293917(0xa8)]({'paymentId':_0xa80d8c['id'],'orderId':_0xa80d8c[_0x293917(0x102)]||_0xa80d8c['id'],'amount':_0xa80d8c['amount'],'currency':_0xa80d8c[_0x293917(0xa0)],'cardData':_0x11b10f,'resultUrl':_0x29ee8,'returnUrl':_0x2ebc34,'cardHolder':_0x18f692,'browser':_0x19284d});console[_0x293917(0xf3)](_0x293917(0xe7),_0x5f50de);const _0x1b653a={'status':_0x5f50de['status'],'updatedAt':new Date(),'statusChangedBy':_0x293917(0xbf),'statusChangedAt':new Date()};_0x5f50de['gateway_payment_id']&&(_0x1b653a[_0x293917(0xd4)]=_0x5f50de[_0x293917(0xcd)],console[_0x293917(0xf3)](_0x293917(0xe2)+_0x5f50de[_0x293917(0xcd)]));if(_0x5f50de[_0x293917(0xa1)]==='PAID')_0x1b653a[_0x293917(0xac)]=new Date();else _0x5f50de['status']===_0x293917(0x101)&&(_0x1b653a[_0x293917(0xfc)]=_0x293917(0xd5));_0x1b653a[_0x293917(0x99)]=_0x293917(0xbe);if(_0x11b10f['number']){const _0x2301b0=_0x11b10f[_0x293917(0xf8)]['replace'](/[\s-]/g,'');_0x1b653a[_0x293917(0x89)]=_0x2301b0[_0x293917(0xe3)](-0x4),console[_0x293917(0xf3)]('üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x1b653a[_0x293917(0x89)]);}await database_1[_0x293917(0xd6)]['payment']['update']({'where':{'id':_0xa80d8c['id']},'data':_0x1b653a}),await database_1[_0x293917(0xd6)][_0x293917(0xe8)]['create']({'data':{'paymentId':_0xa80d8c['id'],'shopId':_0xa80d8c[_0x293917(0xc7)],'event':'mastercard_'+_0x5f50de[_0x293917(0xa1)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x293917(0xbd)]({'oldStatus':'PENDING','newStatus':_0x5f50de[_0x293917(0xa1)],'gatewayPaymentId':_0x5f50de['gateway_payment_id'],'requires3ds':_0x5f50de[_0x293917(0xc6)],'processedAt':new Date()[_0x293917(0xa4)]()})}});if(_0x5f50de[_0x293917(0x86)]){await this[_0x293917(0x9b)](_0xa80d8c,_0x5f50de[_0x293917(0xa1)],_0x5f50de[_0x293917(0xcd)]),await this['sendPaymentStatusNotification'](_0xa80d8c,_0x5f50de['status']);if(_0x5f50de[_0x293917(0xa1)]===_0x293917(0x109)){console['log']('üìà\x20MasterCard\x20payment\x20'+_0x2f5f53+'\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter');try{const {PaymentLinkService:_0x4cabc7}=await Promise[_0x293917(0xc8)]()[_0x293917(0xa9)](()=>__importStar(require(_0x293917(0xd0)))),_0x337e3f=new _0x4cabc7();await _0x337e3f[_0x293917(0xfe)](_0x2f5f53),console['log'](_0x293917(0x104)+_0x2f5f53);}catch(_0x21be73){console[_0x293917(0x93)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x21be73);}}}console[_0x293917(0xf3)](_0x293917(0xb7)+_0x2f5f53+_0x293917(0xa5)+_0x5f50de[_0x293917(0xa1)]);if(_0x5f50de[_0x293917(0xa1)]===_0x293917(0x109))_0x47c3c2[_0x293917(0x88)]({'success':!![],'message':_0x293917(0xc2),'result':{'status':_0x293917(0x109),'gatewayPaymentId':_0x5f50de[_0x293917(0xcd)],'redirectUrl':_0x2ebc34,'final':!![]}});else _0x5f50de['requires_3ds']&&_0x5f50de[_0x293917(0xdd)]?_0x47c3c2[_0x293917(0x88)]({'success':!![],'message':_0x293917(0xde),'result':{'status':_0x293917(0xd3),'gatewayPaymentId':_0x5f50de[_0x293917(0xcd)],'redirectUrl':_0x5f50de[_0x293917(0xdd)],'requires3ds':!![],'final':![]}}):_0x47c3c2[_0x293917(0xa1)](0x190)[_0x293917(0x88)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x293917(0x101),'gatewayPaymentId':_0x5f50de[_0x293917(0xcd)],'redirectUrl':_0xa80d8c[_0x293917(0x9d)],'final':!![]}});}catch(_0x5babf0){_0x253eb0(_0x5babf0);}},this[_0xa95888(0xfa)]=new paymentService_1[(_0xa95888(0xa6))](),this[_0xa95888(0x95)]=new mastercardService_1[(_0xa95888(0xaa))](),this['webhookService']=new webhookService_1[(_0xa95888(0x96))]();}async[a8_0x5744b9(0x9b)](_0x4cf364,_0x6368ef,_0x3166b6){const _0x202458=a8_0x5744b9,_0x570f39=Date[_0x202458(0xc3)]();try{const _0x209220=_0x4cf364[_0x202458(0xba)],_0x5f2018=_0x209220['settings'];if(!_0x5f2018?.[_0x202458(0xeb)]){console[_0x202458(0xf3)](_0x202458(0x98)+_0x209220['id']);return;}const _0x322d70=_0x6368ef===_0x202458(0x109)?_0x202458(0xc1):_0x202458(0x8d);let _0x583a79=[];if(_0x5f2018[_0x202458(0x8a)])try{_0x583a79=Array[_0x202458(0xdf)](_0x5f2018['webhookEvents'])?_0x5f2018['webhookEvents']:JSON[_0x202458(0x92)](_0x5f2018[_0x202458(0x8a)]);}catch(_0x1d5e2b){console[_0x202458(0x93)](_0x202458(0xcc),_0x1d5e2b),_0x583a79=[];}if(!_0x583a79[_0x202458(0xc9)](_0x322d70)){console[_0x202458(0xf3)]('Webhook\x20event\x20'+_0x322d70+_0x202458(0xb0)+_0x209220['id']);return;}const _0x310bd3={'event':_0x322d70,'payment':{'id':_0x4cf364['id'],'order_id':_0x4cf364['orderId'],'gateway_order_id':_0x4cf364[_0x202458(0x102)],'gateway':'1111','amount':_0x4cf364['amount'],'currency':_0x4cf364['currency'],'status':_0x6368ef[_0x202458(0xca)](),'customer_email':_0x4cf364[_0x202458(0xf7)],'customer_name':_0x4cf364[_0x202458(0x9e)],'gateway_payment_id':_0x3166b6,'created_at':_0x4cf364[_0x202458(0xd9)],'updated_at':new Date()}},_0x1c362d=await fetch(_0x5f2018[_0x202458(0xeb)],{'method':_0x202458(0xbb),'headers':{'Content-Type':_0x202458(0xf9),'User-Agent':_0x202458(0xc0)},'body':JSON[_0x202458(0xbd)](_0x310bd3)}),_0x5eb5e1=Date[_0x202458(0xc3)]()-_0x570f39;console[_0x202458(0xf3)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x5f2018[_0x202458(0xeb)]+_0x202458(0x103)+_0x1c362d['status']+'\x20('+_0x5eb5e1+'ms)');}catch(_0x451e08){console[_0x202458(0x93)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x451e08);}}async[a8_0x5744b9(0x108)](_0x726f4a,_0x4edaeb){const _0xcd1ccc=a8_0x5744b9;try{const {telegramBotService:_0x4e4bd3}=await Promise['resolve']()[_0xcd1ccc(0xa9)](()=>__importStar(require(_0xcd1ccc(0xae)))),_0xc0eb59={'PAID':_0xcd1ccc(0xb2),'FAILED':_0xcd1ccc(0x90)},_0xa0e144=_0xc0eb59[_0x4edaeb];if(!_0xa0e144)return;await _0x4e4bd3[_0xcd1ccc(0xdb)](_0x726f4a['shopId'],_0x726f4a,_0xa0e144);}catch(_0x505ce6){console[_0xcd1ccc(0x93)](_0xcd1ccc(0xe1),_0x505ce6);}}}function a8_0x5662(_0x56c8be,_0x405257){const _0x13fffd=a8_0x13ff();return a8_0x5662=function(_0x56629d,_0x379b91){_0x56629d=_0x56629d-0x86;let _0x3e1988=_0x13fffd[_0x56629d];return _0x3e1988;},a8_0x5662(_0x56c8be,_0x405257);}exports[a8_0x5744b9(0xb3)]=PaymentController;