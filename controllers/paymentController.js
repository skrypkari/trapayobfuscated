'use strict';const a8_0x117750=a8_0x4918;(function(_0x2e6bb0,_0x231405){const _0x5a88d6=a8_0x4918,_0x3ce030=_0x2e6bb0();while(!![]){try{const _0x57c5be=-parseInt(_0x5a88d6(0x1f9))/0x1+parseInt(_0x5a88d6(0x21d))/0x2*(-parseInt(_0x5a88d6(0x1f2))/0x3)+-parseInt(_0x5a88d6(0x1e7))/0x4+parseInt(_0x5a88d6(0x1fa))/0x5*(-parseInt(_0x5a88d6(0x203))/0x6)+-parseInt(_0x5a88d6(0x204))/0x7*(parseInt(_0x5a88d6(0x1de))/0x8)+-parseInt(_0x5a88d6(0x1d7))/0x9+-parseInt(_0x5a88d6(0x1d4))/0xa*(-parseInt(_0x5a88d6(0x1cd))/0xb);if(_0x57c5be===_0x231405)break;else _0x3ce030['push'](_0x3ce030['shift']());}catch(_0x174098){_0x3ce030['push'](_0x3ce030['shift']());}}}(a8_0x193b,0xe5dc4));var __createBinding=this&&this[a8_0x117750(0x221)]||(Object['create']?function(_0x77aae2,_0x2dec65,_0x274a55,_0x425853){const _0x491a32=a8_0x117750;if(_0x425853===undefined)_0x425853=_0x274a55;var _0x12d38f=Object[_0x491a32(0x22b)](_0x2dec65,_0x274a55);(!_0x12d38f||(_0x491a32(0x1e8)in _0x12d38f?!_0x2dec65['__esModule']:_0x12d38f[_0x491a32(0x206)]||_0x12d38f[_0x491a32(0x1f0)]))&&(_0x12d38f={'enumerable':!![],'get':function(){return _0x2dec65[_0x274a55];}}),Object['defineProperty'](_0x77aae2,_0x425853,_0x12d38f);}:function(_0x12e04b,_0x21306e,_0x232ae2,_0x36075b){if(_0x36075b===undefined)_0x36075b=_0x232ae2;_0x12e04b[_0x36075b]=_0x21306e[_0x232ae2];}),__setModuleDefault=this&&this[a8_0x117750(0x22f)]||(Object[a8_0x117750(0x200)]?function(_0x282635,_0x4461b9){const _0x375365=a8_0x117750;Object['defineProperty'](_0x282635,_0x375365(0x209),{'enumerable':!![],'value':_0x4461b9});}:function(_0x320cc0,_0x3ebc23){const _0x486e78=a8_0x117750;_0x320cc0[_0x486e78(0x209)]=_0x3ebc23;}),__importStar=this&&this[a8_0x117750(0x1fc)]||(function(){var _0x2f122f=function(_0x32c831){const _0x508a6d=a8_0x4918;return _0x2f122f=Object[_0x508a6d(0x1d5)]||function(_0x28f2d8){const _0x4dfe09=_0x508a6d;var _0x176e1f=[];for(var _0x1bca23 in _0x28f2d8)if(Object['prototype'][_0x4dfe09(0x1e9)][_0x4dfe09(0x210)](_0x28f2d8,_0x1bca23))_0x176e1f[_0x176e1f[_0x4dfe09(0x1f7)]]=_0x1bca23;return _0x176e1f;},_0x2f122f(_0x32c831);};return function(_0x7bb194){const _0x29e81f=a8_0x4918;if(_0x7bb194&&_0x7bb194[_0x29e81f(0x1c0)])return _0x7bb194;var _0x4781d7={};if(_0x7bb194!=null){for(var _0x285bbe=_0x2f122f(_0x7bb194),_0x14f260=0x0;_0x14f260<_0x285bbe[_0x29e81f(0x1f7)];_0x14f260++)if(_0x285bbe[_0x14f260]!==_0x29e81f(0x209))__createBinding(_0x4781d7,_0x7bb194,_0x285bbe[_0x14f260]);}return __setModuleDefault(_0x4781d7,_0x7bb194),_0x4781d7;};}()),__importDefault=this&&this[a8_0x117750(0x22c)]||function(_0x49798d){return _0x49798d&&_0x49798d['__esModule']?_0x49798d:{'default':_0x49798d};};Object[a8_0x117750(0x1fd)](exports,'__esModule',{'value':!![]}),exports[a8_0x117750(0x1dd)]=void 0x0;const paymentService_1=require(a8_0x117750(0x202)),mastercardService_1=require(a8_0x117750(0x211)),webhookService_1=require(a8_0x117750(0x1c9)),database_1=__importDefault(require(a8_0x117750(0x21f)));class PaymentController{constructor(){const _0x2bebe7=a8_0x117750;this[_0x2bebe7(0x229)]=async(_0x4372af,_0x41d403,_0x36cc0a)=>{const _0x11e22e=_0x2bebe7;try{const _0x4230fa=_0x4372af[_0x11e22e(0x1df)],_0x27ea3e=await this[_0x11e22e(0x1fe)]['createPublicPayment'](_0x4230fa);_0x41d403[_0x11e22e(0x1c6)](0xc9)[_0x11e22e(0x230)]({'success':!![],'message':_0x11e22e(0x224),'result':_0x27ea3e});}catch(_0x3db5c8){_0x36cc0a(_0x3db5c8);}},this[_0x2bebe7(0x1ee)]=async(_0x1ffd1b,_0x520ff2,_0x41a739)=>{const _0x4ce7ff=_0x2bebe7;try{const {id:_0x3bfad2}=_0x1ffd1b[_0x4ce7ff(0x1ef)],_0x13246b=await this[_0x4ce7ff(0x1fe)][_0x4ce7ff(0x1ee)](_0x3bfad2);if(!_0x13246b)return _0x520ff2['status'](0x194)[_0x4ce7ff(0x230)]({'success':![],'message':_0x4ce7ff(0x1c5)});_0x520ff2[_0x4ce7ff(0x230)]({'success':!![],'result':_0x13246b});}catch(_0x5240fa){_0x41a739(_0x5240fa);}},this[_0x2bebe7(0x219)]=async(_0x3ff89b,_0x38f013,_0x5a6997)=>{const _0x229cfa=_0x2bebe7;try{const {id:_0x36fbf6}=_0x3ff89b[_0x229cfa(0x1ef)],_0x306a61=await this[_0x229cfa(0x1fe)]['getPaymentById'](_0x36fbf6);if(!_0x306a61)return _0x38f013[_0x229cfa(0x1c6)](0x194)[_0x229cfa(0x230)]({'success':![],'message':_0x229cfa(0x1c5)});_0x38f013[_0x229cfa(0x230)]({'success':!![],'result':_0x306a61});}catch(_0x32ec52){_0x5a6997(_0x32ec52);}},this[_0x2bebe7(0x21a)]=async(_0x242242,_0x5b8e4d,_0x31bbc3)=>{const _0x3ef01d=_0x2bebe7;try{const {id:_0x20a62a}=_0x242242[_0x3ef01d(0x1ef)],_0x50280d=_0x242242[_0x3ef01d(0x1df)];console[_0x3ef01d(0x1f6)](_0x3ef01d(0x21e)+_0x20a62a),console[_0x3ef01d(0x1f6)]('📝\x20Customer\x20data:',_0x50280d);const _0x17bba6=await this[_0x3ef01d(0x1fe)]['updatePaymentCustomerDataPublic'](_0x20a62a,_0x50280d);if(!_0x17bba6)return _0x5b8e4d[_0x3ef01d(0x1c6)](0x194)[_0x3ef01d(0x230)]({'success':![],'message':_0x3ef01d(0x1c5)});_0x5b8e4d[_0x3ef01d(0x230)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x17bba6['id'],'customerIp':_0x17bba6[_0x3ef01d(0x201)],'customerUa':_0x17bba6[_0x3ef01d(0x1e0)],'customerCountry':_0x17bba6['customerCountry'],'updatedAt':_0x17bba6[_0x3ef01d(0x1e4)]}});}catch(_0x37b73f){_0x31bbc3(_0x37b73f);}},this[_0x2bebe7(0x1cc)]=async(_0xd699ba,_0x4945b1,_0x859bc1)=>{const _0x1f2039=_0x2bebe7;try{const {id:_0x4962bc}=_0xd699ba[_0x1f2039(0x1ef)],{cardData:_0x14b6cf,cardHolder:_0x4fcdfa,browser:_0x268bef}=_0xd699ba[_0x1f2039(0x1df)];console['log'](_0x1f2039(0x1c1)+_0x4962bc);const _0x52d705=await database_1[_0x1f2039(0x209)][_0x1f2039(0x208)][_0x1f2039(0x1d8)]({'where':{'id':_0x4962bc},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x52d705)return _0x4945b1[_0x1f2039(0x1c6)](0x194)['json']({'success':![],'message':_0x1f2039(0x1c5)});if(_0x52d705['gateway']!==_0x1f2039(0x1c8))return _0x4945b1['status'](0x190)[_0x1f2039(0x230)]({'success':![],'message':_0x1f2039(0x1dc)});if(_0x52d705[_0x1f2039(0x1c6)]!=='PENDING')return _0x4945b1['status'](0x190)[_0x1f2039(0x230)]({'success':![],'message':_0x1f2039(0x1cf)+_0x52d705['status']+',\x20cannot\x20process'});const _0x34bd8e='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x1d03fd=_0x52d705[_0x1f2039(0x1e3)];console[_0x1f2039(0x1f6)](_0x1f2039(0x1f4)),console[_0x1f2039(0x1f6)](_0x1f2039(0x1ce)+_0x34bd8e),console[_0x1f2039(0x1f6)](_0x1f2039(0x1c3)+_0x1d03fd);const _0x470d27=await this[_0x1f2039(0x20d)][_0x1f2039(0x1d1)]({'paymentId':_0x52d705['id'],'orderId':_0x52d705[_0x1f2039(0x216)]||_0x52d705['id'],'amount':_0x52d705[_0x1f2039(0x218)],'currency':_0x52d705[_0x1f2039(0x21c)],'cardData':_0x14b6cf,'resultUrl':_0x34bd8e,'returnUrl':_0x1d03fd,'cardHolder':_0x4fcdfa,'browser':_0x268bef});console[_0x1f2039(0x1f6)](_0x1f2039(0x1d3),_0x470d27);const _0x16b2f1={'status':_0x470d27[_0x1f2039(0x1c6)],'updatedAt':new Date(),'statusChangedBy':_0x1f2039(0x1f8),'statusChangedAt':new Date()};if(_0x470d27[_0x1f2039(0x1c6)]==='PAID')_0x16b2f1[_0x1f2039(0x1e6)]=new Date(),_0x16b2f1[_0x1f2039(0x1c2)]=_0x470d27[_0x1f2039(0x1db)];else _0x470d27[_0x1f2039(0x1c6)]===_0x1f2039(0x223)&&(_0x16b2f1['failureMessage']='Card\x20payment\x20failed');_0x16b2f1[_0x1f2039(0x1ff)]='mastercard',await database_1[_0x1f2039(0x209)][_0x1f2039(0x208)]['update']({'where':{'id':_0x52d705['id']},'data':_0x16b2f1}),await database_1[_0x1f2039(0x209)]['webhookLog'][_0x1f2039(0x200)]({'data':{'paymentId':_0x52d705['id'],'shopId':_0x52d705[_0x1f2039(0x225)],'event':_0x1f2039(0x21b)+_0x470d27['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x470d27[_0x1f2039(0x1c6)],'gatewayPaymentId':_0x470d27[_0x1f2039(0x1db)],'requires3ds':_0x470d27[_0x1f2039(0x214)],'processedAt':new Date()[_0x1f2039(0x1ea)]()})}});_0x470d27[_0x1f2039(0x1e5)]&&(await this[_0x1f2039(0x1e1)](_0x52d705,_0x470d27[_0x1f2039(0x1c6)],_0x470d27[_0x1f2039(0x1db)]),await this[_0x1f2039(0x1f1)](_0x52d705,_0x470d27[_0x1f2039(0x1c6)]));console[_0x1f2039(0x1f6)](_0x1f2039(0x22d)+_0x4962bc+_0x1f2039(0x212)+_0x470d27[_0x1f2039(0x1c6)]);if(_0x470d27[_0x1f2039(0x1c6)]===_0x1f2039(0x1d2))_0x4945b1[_0x1f2039(0x230)]({'success':!![],'message':_0x1f2039(0x1cb),'result':{'status':'PAID','gatewayPaymentId':_0x470d27[_0x1f2039(0x1db)],'redirectUrl':_0x1d03fd,'final':!![]}});else _0x470d27[_0x1f2039(0x214)]&&_0x470d27[_0x1f2039(0x227)]?_0x4945b1[_0x1f2039(0x230)]({'success':!![],'message':_0x1f2039(0x1ec),'result':{'status':_0x1f2039(0x1fb),'gatewayPaymentId':_0x470d27['gateway_payment_id'],'redirectUrl':_0x470d27['threeds_url'],'requires3ds':!![],'final':![]}}):_0x4945b1['status'](0x190)[_0x1f2039(0x230)]({'success':![],'message':_0x1f2039(0x22a),'result':{'status':'FAILED','gatewayPaymentId':_0x470d27[_0x1f2039(0x1db)],'redirectUrl':_0x52d705[_0x1f2039(0x228)],'final':!![]}});}catch(_0xe89ae6){_0x859bc1(_0xe89ae6);}},this[_0x2bebe7(0x1fe)]=new paymentService_1['PaymentService'](),this[_0x2bebe7(0x20d)]=new mastercardService_1[(_0x2bebe7(0x207))](),this[_0x2bebe7(0x215)]=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x4b7d2f,_0x5eebf4,_0x19287f){const _0x22561a=a8_0x117750,_0x5a979b=Date[_0x22561a(0x1d9)]();try{const _0x2ef919=_0x4b7d2f['shop'],_0x4e6b26=_0x2ef919[_0x22561a(0x1c4)];if(!_0x4e6b26?.['webhookUrl']){console['log']('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x2ef919['id']);return;}const _0x5db5e4=_0x5eebf4===_0x22561a(0x1d2)?'payment.success':'payment.failed';let _0x46acea=[];if(_0x4e6b26[_0x22561a(0x1f3)])try{_0x46acea=Array[_0x22561a(0x22e)](_0x4e6b26[_0x22561a(0x1f3)])?_0x4e6b26['webhookEvents']:JSON[_0x22561a(0x1c7)](_0x4e6b26['webhookEvents']);}catch(_0x5dfec2){console[_0x22561a(0x1ed)]('Error\x20parsing\x20webhook\x20events:',_0x5dfec2),_0x46acea=[];}if(!_0x46acea[_0x22561a(0x1e2)](_0x5db5e4)){console['log'](_0x22561a(0x226)+_0x5db5e4+'\x20not\x20enabled\x20for\x20shop\x20'+_0x2ef919['id']);return;}const _0x1217a9={'event':_0x5db5e4,'payment':{'id':_0x4b7d2f['id'],'order_id':_0x4b7d2f[_0x22561a(0x20c)],'gateway_order_id':_0x4b7d2f['gatewayOrderId'],'gateway':_0x22561a(0x220),'amount':_0x4b7d2f['amount'],'currency':_0x4b7d2f['currency'],'status':_0x5eebf4[_0x22561a(0x20b)](),'customer_email':_0x4b7d2f[_0x22561a(0x1d0)],'customer_name':_0x4b7d2f['customerName'],'gateway_payment_id':_0x19287f,'created_at':_0x4b7d2f[_0x22561a(0x1f5)],'updated_at':new Date()}},_0x275912=await fetch(_0x4e6b26['webhookUrl'],{'method':_0x22561a(0x1d6),'headers':{'Content-Type':'application/json','User-Agent':_0x22561a(0x20a)},'body':JSON[_0x22561a(0x213)](_0x1217a9)}),_0x3c7753=Date[_0x22561a(0x1d9)]()-_0x5a979b;console['log'](_0x22561a(0x217)+_0x4e6b26['webhookUrl']+_0x22561a(0x205)+_0x275912[_0x22561a(0x1c6)]+'\x20('+_0x3c7753+_0x22561a(0x20e));}catch(_0x4491eb){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x4491eb);}}async[a8_0x117750(0x1f1)](_0x17d657,_0x2958ba){const _0x15beed=a8_0x117750;try{const {telegramBotService:_0x122c85}=await Promise[_0x15beed(0x1eb)]()['then'](()=>__importStar(require(_0x15beed(0x1da)))),_0x3e4a43={'PAID':'paid','FAILED':_0x15beed(0x20f)},_0x58bb93=_0x3e4a43[_0x2958ba];if(!_0x58bb93)return;await _0x122c85[_0x15beed(0x1ca)](_0x17d657[_0x15beed(0x225)],_0x17d657,_0x58bb93);}catch(_0x5e7d9a){console[_0x15beed(0x1ed)](_0x15beed(0x222),_0x5e7d9a);}}}function a8_0x4918(_0xedfa83,_0x324b61){const _0x193bd9=a8_0x193b();return a8_0x4918=function(_0x491816,_0x3222d2){_0x491816=_0x491816-0x1c0;let _0x327600=_0x193bd9[_0x491816];return _0x327600;},a8_0x4918(_0xedfa83,_0x324b61);}exports[a8_0x117750(0x1dd)]=PaymentController;function a8_0x193b(){const _0x15df2b=['hasOwnProperty','toISOString','resolve','3DS\x20verification\x20required','error','getPaymentStatus','params','configurable','sendPaymentStatusNotification','6ZiKAbD','webhookEvents','💳\x20MasterCard\x20URLs:','createdAt','log','length','system','857847YSqMJt','5604630QxHoxx','PENDING','__importStar','defineProperty','paymentService','paymentMethod','create','customerIp','../services/paymentService','6tkgsYU','560vHWPdk','\x20with\x20status\x20','writable','MasterCardService','payment','default','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','toLowerCase','orderId','masterCardService','ms)','failed','call','../services/gateways/mastercardService','\x20processed:\x20','stringify','requires_3ds','webhookService','gatewayOrderId','MasterCard\x20webhook\x20sent\x20to\x20','amount','getPaymentById','updatePaymentCustomer','mastercard_','currency','1364534gFJObE','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','../config/database','1111','__createBinding','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','FAILED','Payment\x20created\x20successfully','shopId','Webhook\x20event\x20','threeds_url','failUrl','createPublicPayment','Payment\x20failed','getOwnPropertyDescriptor','__importDefault','✅\x20MasterCard\x20payment\x20','isArray','__setModuleDefault','json','__esModule','💳\x20Processing\x20MasterCard\x20payment:\x20','gatewayPaymentId','\x20\x20\x20Return\x20URL:\x20','settings','Payment\x20not\x20found','status','parse','mastercard','../services/webhookService','sendPaymentNotification','Payment\x20processed\x20successfully','processMasterCardPayment','48037FsldiU','\x20\x20\x20Result\x20URL\x20(webhook):\x20','Payment\x20status\x20is\x20','customerEmail','processCardPayment','PAID','💳\x20MasterCard\x20result:','13290QhAVxg','getOwnPropertyNames','POST','825921eaYPjq','findUnique','now','../services/telegramBotService','gateway_payment_id','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','PaymentController','32640GVLTJH','body','customerUa','sendShopWebhook','includes','successUrl','updatedAt','final','paidAt','4403036NiYauW','get'];a8_0x193b=function(){return _0x15df2b;};return a8_0x193b();}