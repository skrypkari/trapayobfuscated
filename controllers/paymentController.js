'use strict';const a8_0x19bd08=a8_0x5ee2;(function(_0x567968,_0x4a85b9){const _0x3dd2c3=a8_0x5ee2,_0x931aca=_0x567968();while(!![]){try{const _0x32f029=parseInt(_0x3dd2c3(0x1f2))/0x1*(-parseInt(_0x3dd2c3(0x1a8))/0x2)+parseInt(_0x3dd2c3(0x1c5))/0x3+parseInt(_0x3dd2c3(0x1d7))/0x4*(-parseInt(_0x3dd2c3(0x193))/0x5)+parseInt(_0x3dd2c3(0x1c8))/0x6*(parseInt(_0x3dd2c3(0x1ad))/0x7)+parseInt(_0x3dd2c3(0x188))/0x8*(parseInt(_0x3dd2c3(0x1f3))/0x9)+-parseInt(_0x3dd2c3(0x1af))/0xa+parseInt(_0x3dd2c3(0x184))/0xb*(parseInt(_0x3dd2c3(0x1a1))/0xc);if(_0x32f029===_0x4a85b9)break;else _0x931aca['push'](_0x931aca['shift']());}catch(_0x3ea383){_0x931aca['push'](_0x931aca['shift']());}}}(a8_0x13bc,0x2a6dc));function a8_0x13bc(){const _0x1e8ac6=['successUrl','prototype','amount','number','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','includes','updatedAt','‚úÖ\x20MasterCard\x20payment\x20','then','PENDING','customerName','stringify','üí≥\x20MasterCard\x20result:','55bdJQQA','getOwnPropertyNames','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','updatePaymentCustomerDataPublic','2476952hWfEFF','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','../services/paymentService','WebhookService','system','createPublicPayment','webhookUrl','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','FAILED','shopId','getPaymentById','445ykppfW','parse','country','Payment\x20status\x20is\x20','length','webhookLog','user_agent','\x20not\x20enabled\x20for\x20shop\x20','üìù\x20Customer\x20data:','slice','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','defineProperty','gateway','toISOString','588948LZehCG','MasterCardService','paid','masterCardService','toLowerCase','PAID','update','54370vAZgLa','currency',',\x20cannot\x20process','failed','\x20processed:\x20','7vGOkoC','paymentMethod','2300450APKCbg','gateway_payment_id','paymentService','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','üí≥\x20Card\x20holder:\x20','resolve','\x20\x20\x20Return\x20URL:\x20','application/json','settings','__esModule','paidAt','üí≥\x20MasterCard\x20URLs:','email','json','failUrl','MasterCard\x20webhook\x20sent\x20to\x20','error','now','mastercard_','webhookEvents','processMasterCardPayment','../services/telegramBotService','633315VDwpaw','writable','default','474066bVOtki','customerUa','updatePaymentCustomer','../services/webhookService','Customer\x20data\x20updated\x20successfully','get','PaymentController','replace','Card\x20payment\x20failed','findUnique','create','first_name','../config/database','params','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','5172CcpsQg','payment','getPaymentStatus','\x20\x20\x20Result\x20URL\x20(webhook):\x20','body','requires_3ds','__setModuleDefault','sendShopWebhook','isArray','PaymentService','customerCountry','Payment\x20not\x20found','hasOwnProperty','Payment\x20failed','last_name','mastercard','processCardPayment','configurable','failureMessage','__createBinding','log','customerEmail','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','status','webhookService','orderId','Payment\x20created\x20successfully','12whfbLo','9wpQgTy','üí≥\x20Browser\x20IP:\x20','ms)','\x20with\x20status\x20','sendPaymentStatusNotification','Error\x20parsing\x20webhook\x20events:','cardLast4','__importDefault','gatewayOrderId'];a8_0x13bc=function(){return _0x1e8ac6;};return a8_0x13bc();}var __createBinding=this&&this[a8_0x19bd08(0x1ea)]||(Object[a8_0x19bd08(0x1d2)]?function(_0x4ffbcf,_0x1b49ae,_0x2ee113,_0x511a72){const _0x1acb72=a8_0x19bd08;if(_0x511a72===undefined)_0x511a72=_0x2ee113;var _0x115d54=Object['getOwnPropertyDescriptor'](_0x1b49ae,_0x2ee113);(!_0x115d54||(_0x1acb72(0x1cd)in _0x115d54?!_0x1b49ae[_0x1acb72(0x1b8)]:_0x115d54[_0x1acb72(0x1c6)]||_0x115d54[_0x1acb72(0x1e8)]))&&(_0x115d54={'enumerable':!![],'get':function(){return _0x1b49ae[_0x2ee113];}}),Object[_0x1acb72(0x19e)](_0x4ffbcf,_0x511a72,_0x115d54);}:function(_0x3e8eb4,_0x2ed1e4,_0x5483e5,_0x5cbcdf){if(_0x5cbcdf===undefined)_0x5cbcdf=_0x5483e5;_0x3e8eb4[_0x5cbcdf]=_0x2ed1e4[_0x5483e5];}),__setModuleDefault=this&&this[a8_0x19bd08(0x1dd)]||(Object['create']?function(_0x161116,_0x3f2093){const _0x486c5c=a8_0x19bd08;Object[_0x486c5c(0x19e)](_0x161116,_0x486c5c(0x1c7),{'enumerable':!![],'value':_0x3f2093});}:function(_0x1ee040,_0x45a66f){const _0x1408af=a8_0x19bd08;_0x1ee040[_0x1408af(0x1c7)]=_0x45a66f;}),__importStar=this&&this['__importStar']||(function(){var _0x11408e=function(_0x524cea){const _0x2a4d50=a8_0x5ee2;return _0x11408e=Object[_0x2a4d50(0x185)]||function(_0x4f6b55){const _0x1f6197=_0x2a4d50;var _0x482e76=[];for(var _0x4bcb2e in _0x4f6b55)if(Object[_0x1f6197(0x1fd)][_0x1f6197(0x1e3)]['call'](_0x4f6b55,_0x4bcb2e))_0x482e76[_0x482e76[_0x1f6197(0x197)]]=_0x4bcb2e;return _0x482e76;},_0x11408e(_0x524cea);};return function(_0x20df63){const _0x3c229e=a8_0x5ee2;if(_0x20df63&&_0x20df63[_0x3c229e(0x1b8)])return _0x20df63;var _0x8aa552={};if(_0x20df63!=null){for(var _0x24ee0d=_0x11408e(_0x20df63),_0x24552f=0x0;_0x24552f<_0x24ee0d[_0x3c229e(0x197)];_0x24552f++)if(_0x24ee0d[_0x24552f]!==_0x3c229e(0x1c7))__createBinding(_0x8aa552,_0x20df63,_0x24ee0d[_0x24552f]);}return __setModuleDefault(_0x8aa552,_0x20df63),_0x8aa552;};}()),__importDefault=this&&this[a8_0x19bd08(0x1fa)]||function(_0x1c5da0){return _0x1c5da0&&_0x1c5da0['__esModule']?_0x1c5da0:{'default':_0x1c5da0};};Object[a8_0x19bd08(0x19e)](exports,a8_0x19bd08(0x1b8),{'value':!![]}),exports[a8_0x19bd08(0x1ce)]=void 0x0;const paymentService_1=require(a8_0x19bd08(0x18a)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x19bd08(0x1cb)),database_1=__importDefault(require(a8_0x19bd08(0x1d4)));function a8_0x5ee2(_0x573bd1,_0xea2dcb){const _0x13bcbf=a8_0x13bc();return a8_0x5ee2=function(_0x5ee2ae,_0x3db712){_0x5ee2ae=_0x5ee2ae-0x180;let _0x160b14=_0x13bcbf[_0x5ee2ae];return _0x160b14;},a8_0x5ee2(_0x573bd1,_0xea2dcb);}class PaymentController{constructor(){const _0x3f1bbd=a8_0x19bd08;this[_0x3f1bbd(0x18d)]=async(_0x523eca,_0x45a41c,_0x4038f6)=>{const _0x485c15=_0x3f1bbd;try{const _0xc7d946=_0x523eca[_0x485c15(0x1db)],_0x1b75d7=await this[_0x485c15(0x1b1)]['createPublicPayment'](_0xc7d946);_0x45a41c[_0x485c15(0x1ee)](0xc9)['json']({'success':!![],'message':_0x485c15(0x1f1),'result':_0x1b75d7});}catch(_0x32f238){_0x4038f6(_0x32f238);}},this[_0x3f1bbd(0x1d9)]=async(_0x2fb3c4,_0x362a60,_0x348e35)=>{const _0x31ce4a=_0x3f1bbd;try{const {id:_0x6001a4}=_0x2fb3c4[_0x31ce4a(0x1d5)],_0x5b8692=await this[_0x31ce4a(0x1b1)][_0x31ce4a(0x1d9)](_0x6001a4);if(!_0x5b8692)return _0x362a60[_0x31ce4a(0x1ee)](0x194)[_0x31ce4a(0x1bc)]({'success':![],'message':_0x31ce4a(0x1e2)});_0x362a60['json']({'success':!![],'result':_0x5b8692});}catch(_0x14dbc9){_0x348e35(_0x14dbc9);}},this[_0x3f1bbd(0x192)]=async(_0x1e597a,_0x263351,_0x1617da)=>{const _0x5df6cf=_0x3f1bbd;try{const {id:_0x3253cb}=_0x1e597a['params'],_0x2aeb24=await this['paymentService'][_0x5df6cf(0x192)](_0x3253cb);if(!_0x2aeb24)return _0x263351[_0x5df6cf(0x1ee)](0x194)[_0x5df6cf(0x1bc)]({'success':![],'message':_0x5df6cf(0x1e2)});_0x263351[_0x5df6cf(0x1bc)]({'success':!![],'result':_0x2aeb24});}catch(_0x371a74){_0x1617da(_0x371a74);}},this[_0x3f1bbd(0x1ca)]=async(_0x2557aa,_0x321678,_0x3eca04)=>{const _0x134b87=_0x3f1bbd;try{const {id:_0x5483f8}=_0x2557aa['params'],_0x288d85=_0x2557aa[_0x134b87(0x1db)];console[_0x134b87(0x1eb)](_0x134b87(0x189)+_0x5483f8),console['log'](_0x134b87(0x19b),_0x288d85);const _0x5125ca=await this[_0x134b87(0x1b1)][_0x134b87(0x187)](_0x5483f8,_0x288d85);if(!_0x5125ca)return _0x321678['status'](0x194)[_0x134b87(0x1bc)]({'success':![],'message':'Payment\x20not\x20found'});_0x321678[_0x134b87(0x1bc)]({'success':!![],'message':_0x134b87(0x1cc),'result':{'paymentId':_0x5125ca['id'],'customerIp':_0x5125ca['customerIp'],'customerUa':_0x5125ca[_0x134b87(0x1c9)],'customerCountry':_0x5125ca[_0x134b87(0x1e1)],'updatedAt':_0x5125ca[_0x134b87(0x202)]}});}catch(_0x42dac9){_0x3eca04(_0x42dac9);}},this[_0x3f1bbd(0x1c3)]=async(_0x441e20,_0x55fa36,_0x413d25)=>{const _0x5c6c2b=_0x3f1bbd;try{const {id:_0x461454}=_0x441e20[_0x5c6c2b(0x1d5)],{cardData:_0x160a0c,cardHolder:_0x390e04,browser:_0x35672d}=_0x441e20[_0x5c6c2b(0x1db)];console[_0x5c6c2b(0x1eb)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x461454),console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x1b3)+_0x390e04[_0x5c6c2b(0x1d3)]+'\x20'+_0x390e04[_0x5c6c2b(0x1e5)]+'\x20('+_0x390e04[_0x5c6c2b(0x1bb)]+')'),console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x1f4)+_0x35672d['ip']);const _0x25ce96={'customerName':_0x390e04[_0x5c6c2b(0x1d3)]+'\x20'+_0x390e04['last_name'],'customerEmail':_0x390e04[_0x5c6c2b(0x1bb)],'customerIp':_0x35672d['ip'],'customerUa':_0x35672d[_0x5c6c2b(0x199)],'customerCountry':_0x390e04[_0x5c6c2b(0x195)]||null},_0x159a89=await database_1[_0x5c6c2b(0x1c7)][_0x5c6c2b(0x1d8)][_0x5c6c2b(0x1d1)]({'where':{'id':_0x461454},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x159a89)return _0x55fa36[_0x5c6c2b(0x1ee)](0x194)[_0x5c6c2b(0x1bc)]({'success':![],'message':_0x5c6c2b(0x1e2)});if(_0x159a89[_0x5c6c2b(0x19f)]!==_0x5c6c2b(0x1e6))return _0x55fa36['status'](0x190)[_0x5c6c2b(0x1bc)]({'success':![],'message':_0x5c6c2b(0x186)});if(_0x159a89[_0x5c6c2b(0x1ee)]!==_0x5c6c2b(0x180))return _0x55fa36[_0x5c6c2b(0x1ee)](0x190)[_0x5c6c2b(0x1bc)]({'success':![],'message':_0x5c6c2b(0x196)+_0x159a89[_0x5c6c2b(0x1ee)]+_0x5c6c2b(0x1aa)});await database_1['default']['payment'][_0x5c6c2b(0x1a7)]({'where':{'id':_0x461454},'data':{..._0x25ce96,'updatedAt':new Date()}});const _0x18778d='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x1cc2b7=_0x159a89[_0x5c6c2b(0x1fc)];console['log'](_0x5c6c2b(0x1ba)),console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x1da)+_0x18778d),console['log'](_0x5c6c2b(0x1b5)+_0x1cc2b7);const _0x43d4c9={'first_name':_0x390e04['first_name'],'last_name':_0x390e04['last_name'],'email':_0x390e04[_0x5c6c2b(0x1bb)]},_0x5ceaa9=await this[_0x5c6c2b(0x1a4)][_0x5c6c2b(0x1e7)]({'paymentId':_0x159a89['id'],'orderId':_0x159a89[_0x5c6c2b(0x1fb)]||_0x159a89['id'],'amount':_0x159a89[_0x5c6c2b(0x1fe)],'currency':_0x159a89[_0x5c6c2b(0x1a9)],'cardData':_0x160a0c,'resultUrl':_0x18778d,'returnUrl':_0x1cc2b7,'cardHolder':_0x43d4c9,'browser':_0x35672d});console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x183),_0x5ceaa9);const _0x5afef5={'status':_0x5ceaa9[_0x5c6c2b(0x1ee)],'updatedAt':new Date(),'statusChangedBy':_0x5c6c2b(0x18c),'statusChangedAt':new Date()};_0x5ceaa9[_0x5c6c2b(0x1b0)]&&(_0x5afef5['gatewayPaymentId']=_0x5ceaa9[_0x5c6c2b(0x1b0)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x5ceaa9[_0x5c6c2b(0x1b0)]));if(_0x5ceaa9[_0x5c6c2b(0x1ee)]===_0x5c6c2b(0x1a6))_0x5afef5[_0x5c6c2b(0x1b9)]=new Date();else _0x5ceaa9[_0x5c6c2b(0x1ee)]==='FAILED'&&(_0x5afef5[_0x5c6c2b(0x1e9)]=_0x5c6c2b(0x1d0));_0x5afef5[_0x5c6c2b(0x1ae)]=_0x5c6c2b(0x1e6);if(_0x160a0c[_0x5c6c2b(0x1ff)]){const _0x3a3ea1=_0x160a0c[_0x5c6c2b(0x1ff)][_0x5c6c2b(0x1cf)](/[\s-]/g,'');_0x5afef5['cardLast4']=_0x3a3ea1[_0x5c6c2b(0x19c)](-0x4),console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x1b2)+_0x5afef5[_0x5c6c2b(0x1f9)]);}await database_1[_0x5c6c2b(0x1c7)]['payment'][_0x5c6c2b(0x1a7)]({'where':{'id':_0x159a89['id']},'data':_0x5afef5}),await database_1[_0x5c6c2b(0x1c7)][_0x5c6c2b(0x198)][_0x5c6c2b(0x1d2)]({'data':{'paymentId':_0x159a89['id'],'shopId':_0x159a89['shopId'],'event':_0x5c6c2b(0x1c1)+_0x5ceaa9[_0x5c6c2b(0x1ee)]?.[_0x5c6c2b(0x1a5)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':'PENDING','newStatus':_0x5ceaa9[_0x5c6c2b(0x1ee)],'gatewayPaymentId':_0x5ceaa9['gateway_payment_id'],'requires3ds':_0x5ceaa9[_0x5c6c2b(0x1dc)],'processedAt':new Date()[_0x5c6c2b(0x1a0)]()})}});if(_0x5ceaa9['final']){await this[_0x5c6c2b(0x1de)](_0x159a89,_0x5ceaa9['status'],_0x5ceaa9['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x159a89,_0x5ceaa9[_0x5c6c2b(0x1ee)]);if(_0x5ceaa9[_0x5c6c2b(0x1ee)]===_0x5c6c2b(0x1a6)){console[_0x5c6c2b(0x1eb)]('üìà\x20MasterCard\x20payment\x20'+_0x461454+_0x5c6c2b(0x18f));try{const {PaymentLinkService:_0x550a9f}=await Promise['resolve']()[_0x5c6c2b(0x204)](()=>__importStar(require('../services/paymentLinkService'))),_0x570b42=new _0x550a9f();await _0x570b42['handleSuccessfulPayment'](_0x461454),console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x1d6)+_0x461454);}catch(_0x4b3d96){console[_0x5c6c2b(0x1bf)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x4b3d96);}}}console[_0x5c6c2b(0x1eb)](_0x5c6c2b(0x203)+_0x461454+_0x5c6c2b(0x1ac)+_0x5ceaa9[_0x5c6c2b(0x1ee)]);if(_0x5ceaa9[_0x5c6c2b(0x1ee)]==='PAID')_0x55fa36[_0x5c6c2b(0x1bc)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x5c6c2b(0x1a6),'gatewayPaymentId':_0x5ceaa9['gateway_payment_id'],'redirectUrl':_0x1cc2b7,'final':!![]}});else _0x5ceaa9['requires_3ds']&&_0x5ceaa9['threeds_url']?_0x55fa36[_0x5c6c2b(0x1bc)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x5c6c2b(0x180),'gatewayPaymentId':_0x5ceaa9['gateway_payment_id'],'redirectUrl':_0x5ceaa9['threeds_url'],'requires3ds':!![],'final':![]}}):_0x55fa36[_0x5c6c2b(0x1ee)](0x190)[_0x5c6c2b(0x1bc)]({'success':![],'message':_0x5c6c2b(0x1e4),'result':{'status':_0x5c6c2b(0x190),'gatewayPaymentId':_0x5ceaa9['gateway_payment_id'],'redirectUrl':_0x159a89[_0x5c6c2b(0x1bd)],'final':!![]}});}catch(_0x16108e){_0x413d25(_0x16108e);}},this['paymentService']=new paymentService_1[(_0x3f1bbd(0x1e0))](),this[_0x3f1bbd(0x1a4)]=new mastercardService_1[(_0x3f1bbd(0x1a2))](),this[_0x3f1bbd(0x1ef)]=new webhookService_1[(_0x3f1bbd(0x18b))]();}async[a8_0x19bd08(0x1de)](_0x7dddb4,_0x188877,_0x119596){const _0x186e77=a8_0x19bd08,_0x36bf74=Date[_0x186e77(0x1c0)]();try{const _0x352c30=_0x7dddb4['shop'],_0x382b82=_0x352c30[_0x186e77(0x1b7)];if(!_0x382b82?.[_0x186e77(0x18e)]){console[_0x186e77(0x1eb)](_0x186e77(0x1ed)+_0x352c30['id']);return;}const _0x34fe42=_0x188877===_0x186e77(0x1a6)?'payment.success':'payment.failed';let _0x3cd70b=[];if(_0x382b82['webhookEvents'])try{_0x3cd70b=Array[_0x186e77(0x1df)](_0x382b82['webhookEvents'])?_0x382b82[_0x186e77(0x1c2)]:JSON[_0x186e77(0x194)](_0x382b82['webhookEvents']);}catch(_0x2105be){console['error'](_0x186e77(0x1f8),_0x2105be),_0x3cd70b=[];}if(!_0x3cd70b[_0x186e77(0x201)](_0x34fe42)){console['log']('Webhook\x20event\x20'+_0x34fe42+_0x186e77(0x19a)+_0x352c30['id']);return;}const _0x537d2c={'event':_0x34fe42,'payment':{'id':_0x7dddb4['id'],'order_id':_0x7dddb4[_0x186e77(0x1f0)],'gateway_order_id':_0x7dddb4[_0x186e77(0x1fb)],'gateway':'1111','amount':_0x7dddb4[_0x186e77(0x1fe)],'currency':_0x7dddb4[_0x186e77(0x1a9)],'status':_0x188877['toLowerCase'](),'customer_email':_0x7dddb4[_0x186e77(0x1ec)],'customer_name':_0x7dddb4[_0x186e77(0x181)],'gateway_payment_id':_0x119596,'created_at':_0x7dddb4['createdAt'],'updated_at':new Date()}},_0xe3922=await fetch(_0x382b82['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x186e77(0x1b6),'User-Agent':_0x186e77(0x19d)},'body':JSON[_0x186e77(0x182)](_0x537d2c)}),_0x569cb3=Date[_0x186e77(0x1c0)]()-_0x36bf74;console[_0x186e77(0x1eb)](_0x186e77(0x1be)+_0x382b82[_0x186e77(0x18e)]+_0x186e77(0x1f6)+_0xe3922['status']+'\x20('+_0x569cb3+_0x186e77(0x1f5));}catch(_0x5e28c4){console[_0x186e77(0x1bf)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x5e28c4);}}async[a8_0x19bd08(0x1f7)](_0x4d84c4,_0x438567){const _0x8fe0b7=a8_0x19bd08;try{const {telegramBotService:_0x257c9c}=await Promise[_0x8fe0b7(0x1b4)]()['then'](()=>__importStar(require(_0x8fe0b7(0x1c4)))),_0x4a2a2c={'PAID':_0x8fe0b7(0x1a3),'FAILED':_0x8fe0b7(0x1ab)},_0x1cb7ac=_0x4a2a2c[_0x438567];if(!_0x1cb7ac)return;await _0x257c9c['sendPaymentNotification'](_0x4d84c4[_0x8fe0b7(0x191)],_0x4d84c4,_0x1cb7ac);}catch(_0x163828){console[_0x8fe0b7(0x1bf)](_0x8fe0b7(0x200),_0x163828);}}}exports[a8_0x19bd08(0x1ce)]=PaymentController;