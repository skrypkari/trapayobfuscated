'use strict';const a8_0x14a8f7=a8_0x368c;(function(_0x29523f,_0x4371bf){const _0x11a2b7=a8_0x368c,_0x361291=_0x29523f();while(!![]){try{const _0x2ef656=-parseInt(_0x11a2b7(0x14a))/0x1*(parseInt(_0x11a2b7(0x173))/0x2)+parseInt(_0x11a2b7(0x154))/0x3+-parseInt(_0x11a2b7(0x187))/0x4*(parseInt(_0x11a2b7(0x120))/0x5)+-parseInt(_0x11a2b7(0x15a))/0x6*(parseInt(_0x11a2b7(0x150))/0x7)+parseInt(_0x11a2b7(0x145))/0x8*(-parseInt(_0x11a2b7(0x186))/0x9)+parseInt(_0x11a2b7(0x160))/0xa+parseInt(_0x11a2b7(0x16b))/0xb;if(_0x2ef656===_0x4371bf)break;else _0x361291['push'](_0x361291['shift']());}catch(_0x51115e){_0x361291['push'](_0x361291['shift']());}}}(a8_0x55bb,0xc3fff));var __createBinding=this&&this[a8_0x14a8f7(0x128)]||(Object[a8_0x14a8f7(0x15c)]?function(_0x48407c,_0x1a273e,_0x17a4d3,_0x36f988){const _0x516af8=a8_0x14a8f7;if(_0x36f988===undefined)_0x36f988=_0x17a4d3;var _0x41b51e=Object['getOwnPropertyDescriptor'](_0x1a273e,_0x17a4d3);(!_0x41b51e||(_0x516af8(0x147)in _0x41b51e?!_0x1a273e[_0x516af8(0x130)]:_0x41b51e['writable']||_0x41b51e[_0x516af8(0x185)]))&&(_0x41b51e={'enumerable':!![],'get':function(){return _0x1a273e[_0x17a4d3];}}),Object[_0x516af8(0x172)](_0x48407c,_0x36f988,_0x41b51e);}:function(_0x4f28aa,_0x96fb5,_0x8514ef,_0x2cf676){if(_0x2cf676===undefined)_0x2cf676=_0x8514ef;_0x4f28aa[_0x2cf676]=_0x96fb5[_0x8514ef];}),__setModuleDefault=this&&this[a8_0x14a8f7(0x17a)]||(Object['create']?function(_0x1e571f,_0x2bcb14){const _0x56bd56=a8_0x14a8f7;Object[_0x56bd56(0x172)](_0x1e571f,_0x56bd56(0x166),{'enumerable':!![],'value':_0x2bcb14});}:function(_0x37c9f1,_0x5d26e8){_0x37c9f1['default']=_0x5d26e8;}),__importStar=this&&this[a8_0x14a8f7(0x148)]||(function(){var _0x5e8060=function(_0x3e36fb){const _0x19f3e2=a8_0x368c;return _0x5e8060=Object[_0x19f3e2(0x115)]||function(_0x4816a5){const _0x1b2b93=_0x19f3e2;var _0x230951=[];for(var _0x98975f in _0x4816a5)if(Object[_0x1b2b93(0x140)][_0x1b2b93(0x183)][_0x1b2b93(0x144)](_0x4816a5,_0x98975f))_0x230951[_0x230951['length']]=_0x98975f;return _0x230951;},_0x5e8060(_0x3e36fb);};return function(_0x320e75){const _0x4a9216=a8_0x368c;if(_0x320e75&&_0x320e75[_0x4a9216(0x130)])return _0x320e75;var _0x935b2b={};if(_0x320e75!=null){for(var _0x5c7e75=_0x5e8060(_0x320e75),_0x3d56bc=0x0;_0x3d56bc<_0x5c7e75['length'];_0x3d56bc++)if(_0x5c7e75[_0x3d56bc]!==_0x4a9216(0x166))__createBinding(_0x935b2b,_0x320e75,_0x5c7e75[_0x3d56bc]);}return __setModuleDefault(_0x935b2b,_0x320e75),_0x935b2b;};}()),__importDefault=this&&this['__importDefault']||function(_0xa75286){const _0x3526c1=a8_0x14a8f7;return _0xa75286&&_0xa75286[_0x3526c1(0x130)]?_0xa75286:{'default':_0xa75286};};Object[a8_0x14a8f7(0x172)](exports,a8_0x14a8f7(0x130),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x14a8f7(0x184)),mastercardService_1=require(a8_0x14a8f7(0x11b)),webhookService_1=require(a8_0x14a8f7(0x14c)),database_1=__importDefault(require(a8_0x14a8f7(0x15e)));function a8_0x368c(_0x51c96d,_0x3d7b6c){const _0x55bbef=a8_0x55bb();return a8_0x368c=function(_0x368ceb,_0x5c8c52){_0x368ceb=_0x368ceb-0x115;let _0x119394=_0x55bbef[_0x368ceb];return _0x119394;},a8_0x368c(_0x51c96d,_0x3d7b6c);}class PaymentController{constructor(){const _0x4620e7=a8_0x14a8f7;this[_0x4620e7(0x11c)]=async(_0x392ba0,_0x42f712,_0x2b081d)=>{const _0x32aa6f=_0x4620e7;try{const _0x3e7cd8=_0x392ba0[_0x32aa6f(0x16e)],_0x1ecf15=await this[_0x32aa6f(0x175)]['createPublicPayment'](_0x3e7cd8);_0x42f712[_0x32aa6f(0x137)](0xc9)[_0x32aa6f(0x143)]({'success':!![],'message':_0x32aa6f(0x118),'result':_0x1ecf15});}catch(_0x137ddf){_0x2b081d(_0x137ddf);}},this[_0x4620e7(0x11f)]=async(_0x54d6b2,_0x237782,_0x25ad9c)=>{const _0x26a848=_0x4620e7;try{const {id:_0x49f25c}=_0x54d6b2['params'],_0x3053b8=await this[_0x26a848(0x175)][_0x26a848(0x11f)](_0x49f25c);if(!_0x3053b8)return _0x237782[_0x26a848(0x137)](0x194)[_0x26a848(0x143)]({'success':![],'message':'Payment\x20not\x20found'});_0x237782['json']({'success':!![],'result':_0x3053b8});}catch(_0x1e5db2){_0x25ad9c(_0x1e5db2);}},this['getPaymentById']=async(_0x30c113,_0x239c13,_0x1c7f7b)=>{const _0x3275aa=_0x4620e7;try{const {id:_0x3555f8}=_0x30c113[_0x3275aa(0x139)],_0x430785=await this[_0x3275aa(0x175)]['getPaymentById'](_0x3555f8);if(!_0x430785)return _0x239c13[_0x3275aa(0x137)](0x194)[_0x3275aa(0x143)]({'success':![],'message':_0x3275aa(0x14e)});_0x239c13[_0x3275aa(0x143)]({'success':!![],'result':_0x430785});}catch(_0x2d0eb3){_0x1c7f7b(_0x2d0eb3);}},this['processMasterCardPayment']=async(_0x3076f0,_0x31ee6a,_0x12e247)=>{const _0x1ed975=_0x4620e7;try{const {id:_0x2ae85c}=_0x3076f0[_0x1ed975(0x139)],{cardData:_0x3eb788,cardHolder:_0x342d6a,browser:_0xcfefad}=_0x3076f0[_0x1ed975(0x16e)];console[_0x1ed975(0x177)](_0x1ed975(0x124)+_0x2ae85c);const _0x67b84f=await database_1[_0x1ed975(0x166)][_0x1ed975(0x16d)]['findUnique']({'where':{'id':_0x2ae85c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x67b84f)return _0x31ee6a[_0x1ed975(0x137)](0x194)[_0x1ed975(0x143)]({'success':![],'message':_0x1ed975(0x14e)});if(_0x67b84f[_0x1ed975(0x127)]!=='mastercard')return _0x31ee6a[_0x1ed975(0x137)](0x190)[_0x1ed975(0x143)]({'success':![],'message':_0x1ed975(0x167)});if(_0x67b84f['status']!=='PENDING')return _0x31ee6a[_0x1ed975(0x137)](0x190)[_0x1ed975(0x143)]({'success':![],'message':_0x1ed975(0x181)+_0x67b84f[_0x1ed975(0x137)]+_0x1ed975(0x11d)});const _0x5e88f7=_0x1ed975(0x174),_0x1cbfbc=_0x67b84f[_0x1ed975(0x152)];console[_0x1ed975(0x177)](_0x1ed975(0x161)),console[_0x1ed975(0x177)](_0x1ed975(0x11a)+_0x5e88f7),console[_0x1ed975(0x177)](_0x1ed975(0x122)+_0x1cbfbc);const _0x4cbfa6=await this[_0x1ed975(0x136)]['processCardPayment']({'paymentId':_0x67b84f['id'],'orderId':_0x67b84f[_0x1ed975(0x157)]||_0x67b84f['id'],'amount':_0x67b84f['amount'],'currency':_0x67b84f[_0x1ed975(0x162)],'cardData':_0x3eb788,'resultUrl':_0x5e88f7,'returnUrl':_0x1cbfbc,'cardHolder':_0x342d6a,'browser':_0xcfefad});console[_0x1ed975(0x177)]('ðŸ’³\x20MasterCard\x20result:',_0x4cbfa6);const _0x409fc9={'status':_0x4cbfa6[_0x1ed975(0x137)],'updatedAt':new Date(),'statusChangedBy':_0x1ed975(0x12f),'statusChangedAt':new Date()};if(_0x4cbfa6[_0x1ed975(0x137)]==='PAID')_0x409fc9[_0x1ed975(0x13f)]=new Date(),_0x409fc9[_0x1ed975(0x17c)]=_0x4cbfa6['gateway_payment_id'];else _0x4cbfa6[_0x1ed975(0x137)]==='FAILED'&&(_0x409fc9[_0x1ed975(0x151)]='Card\x20payment\x20failed');_0x409fc9[_0x1ed975(0x116)]=_0x1ed975(0x123),await database_1[_0x1ed975(0x166)][_0x1ed975(0x16d)][_0x1ed975(0x17d)]({'where':{'id':_0x67b84f['id']},'data':_0x409fc9}),await database_1['default']['webhookLog']['create']({'data':{'paymentId':_0x67b84f['id'],'shopId':_0x67b84f[_0x1ed975(0x16c)],'event':_0x1ed975(0x17b)+_0x4cbfa6[_0x1ed975(0x137)]?.[_0x1ed975(0x12c)](),'statusCode':0xc8,'responseBody':JSON[_0x1ed975(0x129)]({'oldStatus':_0x1ed975(0x169),'newStatus':_0x4cbfa6[_0x1ed975(0x137)],'gatewayPaymentId':_0x4cbfa6[_0x1ed975(0x165)],'requires3ds':_0x4cbfa6[_0x1ed975(0x15f)],'processedAt':new Date()[_0x1ed975(0x13a)]()})}});_0x4cbfa6['final']&&(await this[_0x1ed975(0x142)](_0x67b84f,_0x4cbfa6['status'],_0x4cbfa6[_0x1ed975(0x165)]),await this[_0x1ed975(0x13e)](_0x67b84f,_0x4cbfa6['status']));console[_0x1ed975(0x177)](_0x1ed975(0x133)+_0x2ae85c+_0x1ed975(0x13b)+_0x4cbfa6[_0x1ed975(0x137)]);if(_0x4cbfa6[_0x1ed975(0x137)]==='PAID')_0x31ee6a[_0x1ed975(0x143)]({'success':!![],'message':_0x1ed975(0x155),'result':{'status':_0x1ed975(0x170),'gatewayPaymentId':_0x4cbfa6[_0x1ed975(0x165)],'redirectUrl':_0x1cbfbc,'final':!![]}});else _0x4cbfa6[_0x1ed975(0x15f)]&&_0x4cbfa6['threeds_url']?_0x31ee6a[_0x1ed975(0x143)]({'success':!![],'message':_0x1ed975(0x158),'result':{'status':_0x1ed975(0x169),'gatewayPaymentId':_0x4cbfa6[_0x1ed975(0x165)],'redirectUrl':_0x4cbfa6['threeds_url'],'requires3ds':!![],'final':![]}}):_0x31ee6a[_0x1ed975(0x137)](0x190)[_0x1ed975(0x143)]({'success':![],'message':_0x1ed975(0x16a),'result':{'status':_0x1ed975(0x13c),'gatewayPaymentId':_0x4cbfa6['gateway_payment_id'],'redirectUrl':_0x67b84f[_0x1ed975(0x117)],'final':!![]}});}catch(_0x1b1ac8){_0x12e247(_0x1b1ac8);}},this[_0x4620e7(0x15d)]=async(_0x1e20a5,_0x2df6f1,_0x17c49b)=>{const _0x223b87=_0x4620e7;try{const {id:_0x5a9fde}=_0x1e20a5[_0x223b87(0x139)],{customerIp:_0x22268d,customerUa:_0x53923b,customerCountry:_0x4c47fe}=_0x1e20a5[_0x223b87(0x16e)],_0x272b27=await database_1[_0x223b87(0x166)]['payment'][_0x223b87(0x182)]({'where':{'id':_0x5a9fde},'select':{'id':!![],'status':!![]}});if(!_0x272b27)return _0x2df6f1['status'](0x194)['json']({'success':![],'message':_0x223b87(0x14e)});const _0x27c3bd=await database_1['default'][_0x223b87(0x16d)][_0x223b87(0x17d)]({'where':{'id':_0x5a9fde},'data':{'customerIp':_0x22268d||undefined,'customerUa':_0x53923b||undefined,'customerCountry':_0x4c47fe||undefined,'updatedAt':new Date()},'select':{'id':!![],'customerIp':!![],'customerUa':!![],'customerCountry':!![],'updatedAt':!![]}});console[_0x223b87(0x177)](_0x223b87(0x179)+_0x5a9fde+':',{'customerIp':_0x22268d||'not\x20provided','customerUa':_0x53923b?_0x53923b[_0x223b87(0x141)](0x0,0x32)+_0x223b87(0x14f):_0x223b87(0x12e),'customerCountry':_0x4c47fe||_0x223b87(0x12e)}),_0x2df6f1[_0x223b87(0x143)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':_0x27c3bd});}catch(_0x2b1667){_0x17c49b(_0x2b1667);}},this['paymentService']=new paymentService_1[(_0x4620e7(0x138))](),this[_0x4620e7(0x136)]=new mastercardService_1[(_0x4620e7(0x12a))](),this[_0x4620e7(0x17f)]=new webhookService_1[(_0x4620e7(0x15b))]();}async[a8_0x14a8f7(0x142)](_0x50b927,_0x523cf3,_0x348362){const _0x4f10a9=a8_0x14a8f7,_0x1d8031=Date[_0x4f10a9(0x13d)]();try{const _0x5c696a=_0x50b927['shop'],_0x7918e5=_0x5c696a[_0x4f10a9(0x17e)];if(!_0x7918e5?.['webhookUrl']){console[_0x4f10a9(0x177)](_0x4f10a9(0x178)+_0x5c696a['id']);return;}const _0x24067d=_0x523cf3===_0x4f10a9(0x170)?_0x4f10a9(0x146):_0x4f10a9(0x12d);let _0x44a0e1=[];if(_0x7918e5['webhookEvents'])try{_0x44a0e1=Array[_0x4f10a9(0x153)](_0x7918e5[_0x4f10a9(0x134)])?_0x7918e5[_0x4f10a9(0x134)]:JSON[_0x4f10a9(0x156)](_0x7918e5['webhookEvents']);}catch(_0x246d51){console[_0x4f10a9(0x168)]('Error\x20parsing\x20webhook\x20events:',_0x246d51),_0x44a0e1=[];}if(!_0x44a0e1[_0x4f10a9(0x159)](_0x24067d)){console[_0x4f10a9(0x177)]('Webhook\x20event\x20'+_0x24067d+_0x4f10a9(0x14d)+_0x5c696a['id']);return;}const _0xcfa2a4={'event':_0x24067d,'payment':{'id':_0x50b927['id'],'order_id':_0x50b927[_0x4f10a9(0x164)],'gateway_order_id':_0x50b927[_0x4f10a9(0x157)],'gateway':_0x4f10a9(0x125),'amount':_0x50b927[_0x4f10a9(0x131)],'currency':_0x50b927[_0x4f10a9(0x162)],'status':_0x523cf3[_0x4f10a9(0x12c)](),'customer_email':_0x50b927[_0x4f10a9(0x14b)],'customer_name':_0x50b927[_0x4f10a9(0x121)],'gateway_payment_id':_0x348362,'created_at':_0x50b927[_0x4f10a9(0x132)],'updated_at':new Date()}},_0x44a913=await fetch(_0x7918e5[_0x4f10a9(0x176)],{'method':_0x4f10a9(0x12b),'headers':{'Content-Type':_0x4f10a9(0x171),'User-Agent':_0x4f10a9(0x135)},'body':JSON[_0x4f10a9(0x129)](_0xcfa2a4)}),_0x401cce=Date['now']()-_0x1d8031;console['log'](_0x4f10a9(0x16f)+_0x7918e5[_0x4f10a9(0x176)]+'\x20with\x20status\x20'+_0x44a913[_0x4f10a9(0x137)]+'\x20('+_0x401cce+_0x4f10a9(0x119));}catch(_0x34ac22){console[_0x4f10a9(0x168)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x34ac22);}}async['sendPaymentStatusNotification'](_0xce2bc,_0x4d9e40){const _0xa4382f=a8_0x14a8f7;try{const {telegramBotService:_0x25c4d5}=await Promise['resolve']()['then'](()=>__importStar(require(_0xa4382f(0x149)))),_0x634d5c={'PAID':_0xa4382f(0x180),'FAILED':_0xa4382f(0x11e)},_0x28b7bc=_0x634d5c[_0x4d9e40];if(!_0x28b7bc)return;await _0x25c4d5['sendPaymentNotification'](_0xce2bc[_0xa4382f(0x16c)],_0xce2bc,_0x28b7bc);}catch(_0x3189af){console['error'](_0xa4382f(0x163),_0x3189af);}}}exports[a8_0x14a8f7(0x126)]=PaymentController;function a8_0x55bb(){const _0x38358c=['masterCardService','status','PaymentService','params','toISOString','\x20processed:\x20','FAILED','now','sendPaymentStatusNotification','paidAt','prototype','substring','sendShopWebhook','json','call','13272OkUtCi','payment.success','get','__importStar','../services/telegramBotService','1auXPYS','customerEmail','../services/webhookService','\x20not\x20enabled\x20for\x20shop\x20','Payment\x20not\x20found','...','28shskzW','failureMessage','successUrl','isArray','2833917CsblcP','Payment\x20processed\x20successfully','parse','gatewayOrderId','3DS\x20verification\x20required','includes','531186ifweeP','WebhookService','create','updateCustomerData','../config/database','requires_3ds','2502560GxHLNB','ðŸ’³\x20MasterCard\x20URLs:','currency','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','orderId','gateway_payment_id','default','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','error','PENDING','Payment\x20failed','28691718aTpTPU','shopId','payment','body','MasterCard\x20webhook\x20sent\x20to\x20','PAID','application/json','defineProperty','1381838OmNzqT','https://api.trapay.uk/api/webhooks/gateway/mastercard','paymentService','webhookUrl','log','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','ðŸ’»\x20Customer\x20data\x20updated\x20for\x20payment\x20','__setModuleDefault','mastercard_','gatewayPaymentId','update','settings','webhookService','paid','Payment\x20status\x20is\x20','findUnique','hasOwnProperty','../services/paymentService','configurable','3339fryCkv','2679772TtofrL','getOwnPropertyNames','paymentMethod','failUrl','Payment\x20created\x20successfully','ms)','\x20\x20\x20Result\x20URL\x20(webhook):\x20','../services/gateways/mastercardService','createPublicPayment',',\x20cannot\x20process','failed','getPaymentStatus','10WFfWDU','customerName','\x20\x20\x20Return\x20URL:\x20','mastercard','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','1111','PaymentController','gateway','__createBinding','stringify','MasterCardService','POST','toLowerCase','payment.failed','not\x20provided','system','__esModule','amount','createdAt','âœ…\x20MasterCard\x20payment\x20','webhookEvents','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'];a8_0x55bb=function(){return _0x38358c;};return a8_0x55bb();}