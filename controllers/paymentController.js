'use strict';const a14_0x72c4=a14_0x44b0;(function(_0x189b36,_0x5e2192){const _0x18d753=a14_0x44b0,_0x8321b5=_0x189b36();while(!![]){try{const _0x3783b8=-parseInt(_0x18d753(0x11a))/0x1*(parseInt(_0x18d753(0x164))/0x2)+-parseInt(_0x18d753(0x18a))/0x3+parseInt(_0x18d753(0x1af))/0x4+parseInt(_0x18d753(0x176))/0x5*(parseInt(_0x18d753(0x188))/0x6)+parseInt(_0x18d753(0x180))/0x7+parseInt(_0x18d753(0x149))/0x8*(-parseInt(_0x18d753(0x106))/0x9)+parseInt(_0x18d753(0xf5))/0xa*(parseInt(_0x18d753(0x12d))/0xb);if(_0x3783b8===_0x5e2192)break;else _0x8321b5['push'](_0x8321b5['shift']());}catch(_0x1c55db){_0x8321b5['push'](_0x8321b5['shift']());}}}(a14_0x2220,0x88fef));var __createBinding=this&&this[a14_0x72c4(0x105)]||(Object[a14_0x72c4(0x1a7)]?function(_0xefa6a,_0x5bb405,_0x433171,_0x5c7245){const _0x1f0394=a14_0x72c4;if(_0x5c7245===undefined)_0x5c7245=_0x433171;var _0x518210=Object[_0x1f0394(0x14a)](_0x5bb405,_0x433171);(!_0x518210||(_0x1f0394(0x1a1)in _0x518210?!_0x5bb405[_0x1f0394(0x191)]:_0x518210[_0x1f0394(0x16c)]||_0x518210[_0x1f0394(0x14b)]))&&(_0x518210={'enumerable':!![],'get':function(){return _0x5bb405[_0x433171];}}),Object[_0x1f0394(0x17e)](_0xefa6a,_0x5c7245,_0x518210);}:function(_0x23deb9,_0x1f9a0e,_0x539252,_0x5016e5){if(_0x5016e5===undefined)_0x5016e5=_0x539252;_0x23deb9[_0x5016e5]=_0x1f9a0e[_0x539252];}),__setModuleDefault=this&&this[a14_0x72c4(0x137)]||(Object['create']?function(_0x46ba83,_0x29d22c){const _0x5aa69e=a14_0x72c4;Object['defineProperty'](_0x46ba83,_0x5aa69e(0x14e),{'enumerable':!![],'value':_0x29d22c});}:function(_0x1c5b35,_0x2f3968){_0x1c5b35['default']=_0x2f3968;}),__importStar=this&&this[a14_0x72c4(0x1a2)]||(function(){var _0x6db0a6=function(_0x317a83){const _0x13c0aa=a14_0x44b0;return _0x6db0a6=Object[_0x13c0aa(0x130)]||function(_0x1cc3ac){const _0x2988ad=_0x13c0aa;var _0x17cf55=[];for(var _0x27c0ba in _0x1cc3ac)if(Object[_0x2988ad(0x192)][_0x2988ad(0x1b2)][_0x2988ad(0x16b)](_0x1cc3ac,_0x27c0ba))_0x17cf55[_0x17cf55[_0x2988ad(0x158)]]=_0x27c0ba;return _0x17cf55;},_0x6db0a6(_0x317a83);};return function(_0x4b1b1f){const _0x58c4c8=a14_0x44b0;if(_0x4b1b1f&&_0x4b1b1f['__esModule'])return _0x4b1b1f;var _0xea7755={};if(_0x4b1b1f!=null){for(var _0x5ece62=_0x6db0a6(_0x4b1b1f),_0x199d5c=0x0;_0x199d5c<_0x5ece62['length'];_0x199d5c++)if(_0x5ece62[_0x199d5c]!==_0x58c4c8(0x14e))__createBinding(_0xea7755,_0x4b1b1f,_0x5ece62[_0x199d5c]);}return __setModuleDefault(_0xea7755,_0x4b1b1f),_0xea7755;};}()),__importDefault=this&&this['__importDefault']||function(_0x4ba58e){return _0x4ba58e&&_0x4ba58e['__esModule']?_0x4ba58e:{'default':_0x4ba58e};};Object[a14_0x72c4(0x17e)](exports,'__esModule',{'value':!![]}),exports[a14_0x72c4(0x14c)]=void 0x0;const crypto_1=__importDefault(require(a14_0x72c4(0x14f))),paymentService_1=require(a14_0x72c4(0x13c)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService'),binLookupService_1=require(a14_0x72c4(0x13e)),database_1=__importDefault(require(a14_0x72c4(0xfe)));class PaymentController{constructor(){const _0xef44f4=a14_0x72c4;this[_0xef44f4(0x10e)]=async(_0x3ac5e4,_0x59afc8,_0x2663ad)=>{const _0xf4760d=_0xef44f4;try{const _0x4a4e25=_0x3ac5e4[_0xf4760d(0x12b)],_0x18b3f8=await this['paymentService'][_0xf4760d(0x10e)](_0x4a4e25);_0x59afc8['status'](0xc9)['json']({'success':!![],'message':_0xf4760d(0x17a),'result':_0x18b3f8});}catch(_0xbabb35){_0x2663ad(_0xbabb35);}},this['getPaymentStatus']=async(_0x3ffe47,_0x256aa2,_0x386c42)=>{const _0x64753e=_0xef44f4;try{const {id:_0x2e2c89}=_0x3ffe47[_0x64753e(0x144)],_0x295e15=await this['paymentService'][_0x64753e(0xf3)](_0x2e2c89);if(!_0x295e15)return _0x256aa2[_0x64753e(0x138)](0x194)[_0x64753e(0x163)]({'success':![],'message':_0x64753e(0x113)});_0x256aa2[_0x64753e(0x163)]({'success':!![],'result':_0x295e15});}catch(_0x3484f4){_0x386c42(_0x3484f4);}},this[_0xef44f4(0x17c)]=async(_0x4acb85,_0x24d33a,_0x3ba0ba)=>{const _0x973d8f=_0xef44f4;try{const {id:_0x3a547f}=_0x4acb85[_0x973d8f(0x144)],{requestId:_0x518a5b}=_0x4acb85[_0x973d8f(0x12f)];if(typeof _0x518a5b!==_0x973d8f(0x11c))return _0x24d33a[_0x973d8f(0x138)](0x190)[_0x973d8f(0x163)]({'success':![],'message':_0x973d8f(0xf6)});console[_0x973d8f(0x175)](_0x973d8f(0x162)+_0x3a547f+_0x973d8f(0x11b)+_0x518a5b);const _0x277930=await this[_0x973d8f(0x10d)][_0x973d8f(0x17c)](_0x3a547f,_0x518a5b);if(!_0x277930)return _0x24d33a[_0x973d8f(0x138)](0x194)[_0x973d8f(0x163)]({'success':![],'message':'Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available'});console[_0x973d8f(0x175)](_0x973d8f(0x168)+_0x3a547f+':',_0x277930),_0x24d33a[_0x973d8f(0x163)]({'success':!![],'result':_0x277930});}catch(_0x50d95b){_0x3ba0ba(_0x50d95b);}},this[_0xef44f4(0x131)]=async(_0x335c07,_0x27bb6b,_0x451dfc)=>{const _0x317b76=_0xef44f4;try{const {id:_0x106630}=_0x335c07[_0x317b76(0x144)],_0x45dfbe=await this[_0x317b76(0x10d)][_0x317b76(0x131)](_0x106630);if(!_0x45dfbe)return _0x27bb6b['status'](0x194)[_0x317b76(0x163)]({'success':![],'message':_0x317b76(0x113)});_0x27bb6b[_0x317b76(0x163)]({'success':!![],'result':_0x45dfbe});}catch(_0xbebabb){_0x451dfc(_0xbebabb);}},this[_0xef44f4(0x153)]=async(_0x39588b,_0x3ed793,_0x30671d)=>{const _0x2ae33a=_0xef44f4;try{const {id:_0x130719}=_0x39588b[_0x2ae33a(0x144)],_0x233da1=_0x39588b[_0x2ae33a(0x12b)];console[_0x2ae33a(0x175)](_0x2ae33a(0x161)+_0x130719),console[_0x2ae33a(0x175)](_0x2ae33a(0xfa),_0x233da1);const _0xa87241=await this[_0x2ae33a(0x10d)][_0x2ae33a(0x19f)](_0x130719,_0x233da1);if(!_0xa87241)return _0x3ed793[_0x2ae33a(0x138)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x3ed793[_0x2ae33a(0x163)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0xa87241['id'],'customerIp':_0xa87241[_0x2ae33a(0x142)],'customerUa':_0xa87241[_0x2ae33a(0x1ac)],'customerCountry':_0xa87241[_0x2ae33a(0x10a)],'updatedAt':_0xa87241[_0x2ae33a(0x12c)]}});}catch(_0x3c88c0){_0x30671d(_0x3c88c0);}},this[_0xef44f4(0x182)]=async(_0x1cf236,_0x5e81d7,_0x599ae5)=>{const _0x1b6806=_0xef44f4;try{const {id:_0x306c13}=_0x1cf236[_0x1b6806(0x144)],{cardData:_0x47b991,cardHolder:_0x4253a1,browser:_0x5422e4,phoneValidation:_0x42a1c6}=_0x1cf236[_0x1b6806(0x12b)];console[_0x1b6806(0x175)](_0x1b6806(0x11d)+_0x306c13),console[_0x1b6806(0x175)]('ðŸ’³\x20Card\x20holder:\x20'+_0x4253a1[_0x1b6806(0x18e)]+'\x20'+_0x4253a1[_0x1b6806(0x1ab)]+'\x20('+_0x4253a1[_0x1b6806(0x1b5)]+')'),console[_0x1b6806(0x175)]('ðŸ’³\x20Browser\x20IP:\x20'+_0x5422e4['ip']);const _0x14019a=_0x4253a1[_0x1b6806(0x18e)]?.[_0x1b6806(0xf8)](/[\t\n\r\f\v]/g,'\x20')[_0x1b6806(0x178)]()||'',_0x1eedb4=_0x4253a1[_0x1b6806(0x1ab)]?.[_0x1b6806(0xf8)](/[\t\n\r\f\v]/g,'\x20')[_0x1b6806(0x178)]()||'';console[_0x1b6806(0x175)](_0x1b6806(0x111)),console['log'](_0x1b6806(0xfb)+_0x4253a1[_0x1b6806(0x18e)]+_0x1b6806(0x194)+_0x4253a1[_0x1b6806(0x1ab)]+'\x22'),console[_0x1b6806(0x175)](_0x1b6806(0x197)+_0x14019a+'\x22\x20|\x20\x22'+_0x1eedb4+'\x22');const _0xa05493={'customerName':_0x14019a+'\x20'+_0x1eedb4,'customerEmail':_0x4253a1['email'],'customerPhone':_0x4253a1['phone']||null,'customerIp':_0x5422e4['ip'],'customerUa':_0x5422e4['user_agent']},_0x1e568f=[_0x4253a1[_0x1b6806(0x11e)],_0x4253a1[_0x1b6806(0xf2)]][_0x1b6806(0x1ad)](Boolean);_0xa05493[_0x1b6806(0x128)]=_0x1e568f[_0x1b6806(0x187)](',\x20')||null,_0xa05493[_0x1b6806(0x181)]=_0x4253a1[_0x1b6806(0x16d)]||null,_0xa05493['billingState']=_0x4253a1[_0x1b6806(0x124)]||null,_0xa05493[_0x1b6806(0x157)]=_0x4253a1[_0x1b6806(0x123)]||_0x4253a1[_0x1b6806(0x1a5)]||null,console[_0x1b6806(0x175)](_0x1b6806(0x1a9),_0xa05493[_0x1b6806(0x128)]),console[_0x1b6806(0x175)](_0x1b6806(0x133),_0x47b991[_0x1b6806(0x112)][_0x1b6806(0x1b3)](0x0,0x6)+_0x1b6806(0x136));const _0x27eae1=await binLookupService_1['binLookupService'][_0x1b6806(0x1b7)](_0x47b991[_0x1b6806(0x112)]);console['log']('ðŸ“Š\x20BIN\x20lookup\x20result:',_0x27eae1);const _0x3af927=_0x47b991[_0x1b6806(0x112)][_0x1b6806(0x1b3)](0x0,0x8),_0x4a01ef=await database_1[_0x1b6806(0x14e)]['payment'][_0x1b6806(0x16f)]({'where':{'id':_0x306c13},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x4a01ef)return _0x5e81d7['status'](0x194)[_0x1b6806(0x163)]({'success':![],'message':_0x1b6806(0x113)});if(_0x4a01ef[_0x1b6806(0x1b1)]!==_0x1b6806(0x160))return console[_0x1b6806(0x175)]('âŒ\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27'+_0x4a01ef[_0x1b6806(0x1b1)]+'\x27'),_0x5e81d7[_0x1b6806(0x138)](0x190)['json']({'success':![],'message':_0x1b6806(0x17d)});if(_0x4a01ef[_0x1b6806(0x138)]!==_0x1b6806(0x12a))return _0x5e81d7[_0x1b6806(0x138)](0x190)[_0x1b6806(0x163)]({'success':![],'message':_0x1b6806(0x152)+_0x4a01ef[_0x1b6806(0x138)]+_0x1b6806(0x198)});await database_1[_0x1b6806(0x14e)][_0x1b6806(0x179)]['update']({'where':{'id':_0x306c13},'data':{..._0xa05493,'cardBin':_0x3af927,'cardBinStatus':_0x27eae1['cardBinStatus'],'cardType':_0x27eae1[_0x1b6806(0x189)],'cardCategory':_0x27eae1['cardCategory'],'cardCountry':_0x27eae1[_0x1b6806(0x159)],'cardIssuer':_0x27eae1['cardIssuer'],'phoneIsValid':_0x42a1c6?.[_0x1b6806(0x183)],'phoneLineStatus':_0x42a1c6?.[_0x1b6806(0x108)],'phoneIsVoip':_0x42a1c6?.[_0x1b6806(0x151)],'phoneRiskLevel':_0x42a1c6?.['riskLevel'],'updatedAt':new Date()}}),console[_0x1b6806(0x175)](_0x1b6806(0x117));const _0x590cb7=_0x47b991['number'][_0x1b6806(0xf8)](/[\s-]/g,''),_0x1f0f67=_0x590cb7[_0x1b6806(0x18d)]('4')?_0x1b6806(0x12e):_0x1b6806(0x104),_0x578291=_0x590cb7[_0x1b6806(0x18d)]('4')?'VISA':_0x1b6806(0x150),_0x4a7aec='https://api.trapay.uk/api/webhooks/gateway/'+_0x1f0f67,_0x44ef95='https://app.trapay.uk/payment/pending?id='+_0x4a01ef['id']+'&payment_id='+_0x4a01ef[_0x1b6806(0x173)];console['log']('ðŸ’³\x20'+_0x1f0f67['toUpperCase']()+_0x1b6806(0x114)),console[_0x1b6806(0x175)](_0x1b6806(0x141)+_0x4a7aec),console[_0x1b6806(0x175)](_0x1b6806(0x19b)+_0x44ef95);const _0x23408b={'first_name':_0x4253a1[_0x1b6806(0x18e)],'last_name':_0x4253a1[_0x1b6806(0x1ab)],'email':_0x4253a1[_0x1b6806(0x1b5)]},_0x287c17=await this[_0x1b6806(0x13b)]['processCardPayment']({'paymentId':_0x4a01ef['id'],'orderId':_0x4a01ef['gatewayOrderId']||_0x4a01ef['id'],'amount':_0x4a01ef['amount'],'currency':_0x4a01ef[_0x1b6806(0x110)],'cardData':_0x47b991,'resultUrl':_0x4a7aec,'returnUrl':_0x44ef95,'cardHolder':_0x23408b,'browser':_0x5422e4});console[_0x1b6806(0x175)]('ðŸ’³\x20MasterCard\x20result:',_0x287c17);const _0x1a2a7f={'status':_0x287c17[_0x1b6806(0x138)],'updatedAt':new Date(),'statusChangedBy':_0x1b6806(0xf4),'statusChangedAt':new Date()};_0x287c17[_0x1b6806(0x14d)]&&(_0x1a2a7f[_0x1b6806(0x143)]=_0x287c17[_0x1b6806(0x14d)],console[_0x1b6806(0x175)](_0x1b6806(0x155)+_0x287c17[_0x1b6806(0x14d)]));if(_0x287c17['status']==='PAID'){_0x1a2a7f['paidAt']=new Date();const _0x358776=await this['currencyService'][_0x1b6806(0x16a)](_0x4a01ef[_0x1b6806(0x156)],_0x4a01ef[_0x1b6806(0x110)]),_0x526828=await this[_0x1b6806(0x169)][_0x1b6806(0x11f)](_0x4a01ef[_0x1b6806(0x18c)],_0x4a01ef[_0x1b6806(0x1b1)]),_0x2d6797=_0x358776*(0x1-_0x526828/0x64);_0x1a2a7f[_0x1b6806(0xf7)]=_0x358776,_0x1a2a7f[_0x1b6806(0x199)]=_0x2d6797,_0x1a2a7f[_0x1b6806(0x193)]=_0x526828,console[_0x1b6806(0x175)](_0x1b6806(0x1b6)+_0x4a01ef['amount']+'\x20'+_0x4a01ef[_0x1b6806(0x110)]+_0x1b6806(0x102)+_0x358776[_0x1b6806(0x17b)](0x6)+_0x1b6806(0x17f)),console[_0x1b6806(0x175)](_0x1b6806(0x148)+_0x4a01ef[_0x1b6806(0x1b1)]+_0x1b6806(0x186)+_0x526828+'%'),console[_0x1b6806(0x175)]('ðŸ’°\x20Amount\x20after\x20gateway\x20commission:\x20'+_0x2d6797[_0x1b6806(0x17b)](0x6)+_0x1b6806(0x17f));}else _0x287c17[_0x1b6806(0x138)]===_0x1b6806(0x122)&&(_0x1a2a7f[_0x1b6806(0x135)]=_0x287c17[_0x1b6806(0xfc)]||_0x1b6806(0x1b0),console[_0x1b6806(0x175)](_0x1b6806(0x18f)+_0x1a2a7f[_0x1b6806(0x135)]));_0x1a2a7f[_0x1b6806(0x13a)]=_0x1b6806(0x166);if(_0x47b991[_0x1b6806(0x112)]){const _0x4e5d41=_0x47b991[_0x1b6806(0x112)]['replace'](/[\s-]/g,'');_0x1a2a7f[_0x1b6806(0x145)]=_0x4e5d41[_0x1b6806(0xfd)](-0x4),_0x1a2a7f[_0x1b6806(0x120)]=_0x578291,console[_0x1b6806(0x175)](_0x1b6806(0x134)+_0x1a2a7f['cardLast4']),console[_0x1b6806(0x175)](_0x1b6806(0x139)+_0x578291);}await database_1[_0x1b6806(0x14e)]['payment'][_0x1b6806(0x15b)]({'where':{'id':_0x4a01ef['id']},'data':_0x1a2a7f});_0x287c17[_0x1b6806(0x138)]===_0x1b6806(0x118)&&(await this[_0x1b6806(0x169)][_0x1b6806(0x116)](_0x4a01ef['id'],_0x1b6806(0x118)),console[_0x1b6806(0x175)]('ðŸ’°\x20Updated\x20merchant\x20balance\x20for\x20payment\x20'+_0x4a01ef['id']));await database_1[_0x1b6806(0x14e)]['webhookLog'][_0x1b6806(0x1a7)]({'data':{'paymentId':_0x4a01ef['id'],'shopId':_0x4a01ef[_0x1b6806(0x18c)],'event':_0x1f0f67+'_'+_0x287c17[_0x1b6806(0x138)]?.[_0x1b6806(0x10f)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x1b6806(0x12a),'newStatus':_0x287c17[_0x1b6806(0x138)],'gatewayPaymentId':_0x287c17[_0x1b6806(0x14d)],'requires3ds':_0x287c17[_0x1b6806(0x1a0)],'cardType':_0x1f0f67[_0x1b6806(0x154)](),'processedAt':new Date()[_0x1b6806(0x15a)]()})}});if(_0x287c17[_0x1b6806(0x101)]){await this[_0x1b6806(0x1b4)](_0x4a01ef,_0x287c17[_0x1b6806(0x138)],_0x287c17[_0x1b6806(0x14d)],_0x1f0f67),await this[_0x1b6806(0x10b)](_0x4a01ef,_0x287c17[_0x1b6806(0x138)]);if(_0x287c17['status']==='PAID'){console[_0x1b6806(0x175)](_0x1b6806(0x100)+_0x1f0f67[_0x1b6806(0x154)]()+_0x1b6806(0x1aa)+_0x306c13+_0x1b6806(0x132));try{const {PaymentLinkService:_0x159251}=await Promise['resolve']()[_0x1b6806(0x19d)](()=>__importStar(require('../services/paymentLinkService'))),_0x3ab971=new _0x159251();await _0x3ab971[_0x1b6806(0x167)](_0x306c13),console[_0x1b6806(0x175)](_0x1b6806(0x13d)+_0x1f0f67[_0x1b6806(0x154)]()+_0x1b6806(0x1aa)+_0x306c13);}catch(_0x1efab8){console[_0x1b6806(0x125)](_0x1b6806(0x1b9)+_0x1f0f67['toUpperCase']()+_0x1b6806(0x121),_0x1efab8);}}}console[_0x1b6806(0x175)]('âœ…\x20'+_0x1f0f67[_0x1b6806(0x154)]()+_0x1b6806(0x1aa)+_0x306c13+_0x1b6806(0x174)+_0x287c17[_0x1b6806(0x138)]);if(_0x287c17[_0x1b6806(0x138)]==='PAID')_0x5e81d7[_0x1b6806(0x163)]({'success':!![],'message':_0x1b6806(0x18b),'result':{'status':'PAID','gatewayPaymentId':_0x287c17[_0x1b6806(0x14d)],'redirectUrl':_0x44ef95,'final':!![]}});else _0x287c17[_0x1b6806(0x1a0)]&&_0x287c17[_0x1b6806(0x107)]?_0x5e81d7['json']({'success':!![],'message':_0x1b6806(0xf9),'result':{'status':_0x1b6806(0x12a),'gatewayPaymentId':_0x287c17[_0x1b6806(0x14d)],'redirectUrl':_0x287c17[_0x1b6806(0x107)],'requires3ds':!![],'final':![]}}):_0x5e81d7['status'](0x190)[_0x1b6806(0x163)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x1b6806(0x122),'gatewayPaymentId':_0x287c17[_0x1b6806(0x14d)],'redirectUrl':_0x4a01ef['failUrl'],'final':!![]}});}catch(_0x7d2f02){_0x599ae5(_0x7d2f02);}},this['paymentService']=new paymentService_1[(_0xef44f4(0x195))](),this['visaMasterCardService']=new mastercardService_1[(_0xef44f4(0xff))](),this[_0xef44f4(0x169)]=new webhookService_1[(_0xef44f4(0x103))](),this[_0xef44f4(0x10c)]=new currencyService_1['CurrencyService']();}async[a14_0x72c4(0x1b4)](_0x590c68,_0x17fd44,_0x33c354,_0xad24d1){const _0x4cf22b=a14_0x72c4,_0x3fc74b=Date[_0x4cf22b(0x109)]();try{const _0x143ef5=_0x590c68['shop'],_0x2df7a0=_0x143ef5[_0x4cf22b(0xf1)];if(!_0x2df7a0?.['webhookUrl']){console[_0x4cf22b(0x175)](_0x4cf22b(0x170)+_0x143ef5['id']);return;}const _0x435ca7=_0x17fd44===_0x4cf22b(0x118)?_0x4cf22b(0x115):_0x4cf22b(0x147);let _0x602ba3=[];if(_0x2df7a0[_0x4cf22b(0x1a8)])try{_0x602ba3=Array[_0x4cf22b(0x19c)](_0x2df7a0[_0x4cf22b(0x1a8)])?_0x2df7a0['webhookEvents']:JSON[_0x4cf22b(0x140)](_0x2df7a0[_0x4cf22b(0x1a8)]);}catch(_0x4e4d9f){console[_0x4cf22b(0x125)](_0x4cf22b(0x177),_0x4e4d9f),_0x602ba3=[];}if(!_0x602ba3[_0x4cf22b(0x15d)](_0x435ca7)){console['log'](_0x4cf22b(0x146)+_0x435ca7+_0x4cf22b(0x165)+_0x143ef5['id']);return;}const _0x14fa82={'event':_0x435ca7,'payment':{'id':_0x590c68['id'],'order_id':_0x590c68['orderId'],'gateway_order_id':_0x590c68[_0x4cf22b(0x173)],'gateway':_0x4cf22b(0x127),'card_type':_0xad24d1?.['toUpperCase']()||_0x4cf22b(0x15e),'amount':_0x590c68[_0x4cf22b(0x156)],'currency':_0x590c68[_0x4cf22b(0x110)],'status':_0x17fd44[_0x4cf22b(0x10f)](),'customer_email':_0x590c68[_0x4cf22b(0x185)],'customer_name':_0x590c68[_0x4cf22b(0x1ae)],'gateway_payment_id':_0x33c354,'created_at':_0x590c68[_0x4cf22b(0x15c)],'updated_at':new Date()}},_0x43d8a1=JSON['stringify'](_0x14fa82),_0x5e0bd2=crypto_1[_0x4cf22b(0x14e)]['createHmac'](_0x4cf22b(0x1b8),_0x143ef5[_0x4cf22b(0x119)])[_0x4cf22b(0x15b)](_0x43d8a1)[_0x4cf22b(0x171)](_0x4cf22b(0x126)),_0x9a1874=await fetch(_0x2df7a0[_0x4cf22b(0x172)],{'method':_0x4cf22b(0x1a6),'headers':{'Content-Type':_0x4cf22b(0x16e),'User-Agent':_0x4cf22b(0x13f)+(_0xad24d1?.[_0x4cf22b(0x154)]()||'VISA/MasterCard')+')','X-Webhook-Signature':_0x5e0bd2},'body':_0x43d8a1}),_0x242fd2=Date[_0x4cf22b(0x109)]()-_0x3fc74b;console[_0x4cf22b(0x175)]((_0xad24d1?.['toUpperCase']()||'VISA/MasterCard')+_0x4cf22b(0x19e)+_0x2df7a0[_0x4cf22b(0x172)]+'\x20with\x20status\x20'+_0x9a1874[_0x4cf22b(0x138)]+'\x20('+_0x242fd2+_0x4cf22b(0x19a));}catch(_0x1ad04b){console[_0x4cf22b(0x125)](_0x4cf22b(0x190)+(_0xad24d1?.[_0x4cf22b(0x154)]()||_0x4cf22b(0x1a4))+_0x4cf22b(0x129),_0x1ad04b);}}async[a14_0x72c4(0x10b)](_0x528e01,_0x23bb87){const _0x43d064=a14_0x72c4;try{const {telegramBotService:_0x1812e4}=await Promise['resolve']()[_0x43d064(0x19d)](()=>__importStar(require(_0x43d064(0x196)))),_0x1623b1={'PAID':_0x43d064(0x184),'FAILED':_0x43d064(0x1a3)},_0x44cb91=_0x1623b1[_0x23bb87];if(!_0x44cb91)return;await _0x1812e4[_0x43d064(0x15f)](_0x528e01[_0x43d064(0x18c)],_0x528e01,_0x44cb91);}catch(_0x1dc48e){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x1dc48e);}}}function a14_0x44b0(_0x363724,_0x4f801e){_0x363724=_0x363724-0xf1;const _0x2220a8=a14_0x2220();let _0x44b07d=_0x2220a8[_0x363724];return _0x44b07d;}exports[a14_0x72c4(0x14c)]=PaymentController;function a14_0x2220(){const _0x3c4201=['payment.success','updatePaymentStatus','âœ…\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info','PAID','secretKey','5863FaZsZQ','\x20with\x20requestId\x20','string','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','address_line_1','getGatewayCommission','cardBrand','\x20payment:','FAILED','post_code','state','error','hex','1111','billingAddress','\x20webhook:','PENDING','body','updatedAt','22oHyhsu','visa','query','getOwnPropertyNames','getPaymentById','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','ðŸ”\x20Looking\x20up\x20BIN\x20for\x20card:','ðŸ’³\x20Saving\x20card\x20last\x204\x20digits:\x20****','failureMessage','******','__setModuleDefault','status','ðŸ’³\x20Saving\x20card\x20brand:\x20','paymentMethod','visaMasterCardService','../services/paymentService','âœ…\x20Payment\x20link\x20counter\x20updated\x20for\x20','../services/binLookupService','Payment\x20System/1.0\x20(','parse','\x20\x20\x20Result\x20URL\x20(webhook):\x20','customerIp','gatewayPaymentId','params','cardLast4','Webhook\x20event\x20','payment.failed','ðŸ’°\x20Gateway\x20','509408NkGEKH','getOwnPropertyDescriptor','configurable','PaymentController','gateway_payment_id','default','crypto','MASTERCARD','isVoip','Payment\x20status\x20is\x20','updatePaymentCustomer','toUpperCase','ðŸ’³\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','amount','billingZip','length','cardCountry','toISOString','update','createdAt','includes','UNKNOWN','sendPaymentNotification','visa/mastercard','ðŸ”„\x20Updating\x20customer\x20data\x20for\x20payment:\x20','ðŸ”\x20Received\x20fingerprint\x20request\x20for\x20payment\x20','json','204Lnmtlh','\x20not\x20enabled\x20for\x20shop\x20','Bank\x20Card','handleSuccessfulPayment','âœ…\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','webhookService','convertToUSDT','call','writable','city','application/json','findUnique','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','digest','webhookUrl','gatewayOrderId','\x20processed:\x20','log','5xRkVOB','Error\x20parsing\x20webhook\x20events:','trim','payment','Payment\x20created\x20successfully','toFixed','getPaymentFingerprint','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','defineProperty','\x20USDT','1568497qeXxrS','billingCity','processMasterCardPayment','isValid','paid','customerEmail','\x20commission:\x20','join','888966gAKLdA','cardType','994053cyYcSr','Payment\x20processed\x20successfully','shopId','startsWith','first_name','âŒ\x20Payment\x20failed\x20with\x20message:\x20','Failed\x20to\x20send\x20','__esModule','prototype','gatewayCommissionRate','\x22\x20|\x20\x22','PaymentService','../services/telegramBotService','\x20\x20Cleaned:\x20\x20\x22',',\x20cannot\x20process','amountAfterGatewayCommissionUSDT','ms)','\x20\x20\x20Return\x20URL:\x20','isArray','then','\x20webhook\x20sent\x20to\x20','updatePaymentCustomerDataPublic','requires_3ds','get','__importStar','failed','VISA/MasterCard','postcode','POST','create','webhookEvents','ðŸ“\x20Billing\x20address\x20(string):','\x20payment\x20','last_name','customerUa','filter','customerName','2845016OcgApn','Card\x20payment\x20failed','gateway','hasOwnProperty','substring','sendShopWebhook','email','ðŸ’°\x20Converting\x20','lookupBin','sha256','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','settings','address_line_2','getPaymentStatus','system','4900550hSkITV','requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string','amountUSDT','replace','3DS\x20verification\x20required','ðŸ“\x20Customer\x20data:','\x20\x20Original:\x20\x22','errorMessage','slice','../config/database','VisaMasterCardService','ðŸ“ˆ\x20','final','\x20->\x20','WebhookService','mastercard','__createBinding','81arpFZA','threeds_url','lineStatus','now','customerCountry','sendPaymentStatusNotification','currencyService','paymentService','createPublicPayment','toLowerCase','currency','ðŸ§¹\x20Customer\x20names\x20cleaned:','number','Payment\x20not\x20found','\x20URLs:'];a14_0x2220=function(){return _0x3c4201;};return a14_0x2220();}