'use strict';function a8_0x21cf(_0x28a921,_0x37f372){const _0x4bd4fc=a8_0x4bd4();return a8_0x21cf=function(_0x21cfd,_0x20077a){_0x21cfd=_0x21cfd-0x178;let _0x226291=_0x4bd4fc[_0x21cfd];return _0x226291;},a8_0x21cf(_0x28a921,_0x37f372);}const a8_0x25f7e9=a8_0x21cf;(function(_0x5d93f7,_0x22935b){const _0x4e2679=a8_0x21cf,_0x2ac590=_0x5d93f7();while(!![]){try{const _0x24a589=-parseInt(_0x4e2679(0x1d5))/0x1+-parseInt(_0x4e2679(0x1ba))/0x2+-parseInt(_0x4e2679(0x1ab))/0x3*(parseInt(_0x4e2679(0x1e4))/0x4)+parseInt(_0x4e2679(0x1c6))/0x5+parseInt(_0x4e2679(0x1be))/0x6+-parseInt(_0x4e2679(0x181))/0x7+parseInt(_0x4e2679(0x1e2))/0x8;if(_0x24a589===_0x22935b)break;else _0x2ac590['push'](_0x2ac590['shift']());}catch(_0x412302){_0x2ac590['push'](_0x2ac590['shift']());}}}(a8_0x4bd4,0xdec8f));var __createBinding=this&&this[a8_0x25f7e9(0x1df)]||(Object['create']?function(_0x491865,_0x1dcff3,_0x57b9e2,_0x488272){const _0x53436e=a8_0x25f7e9;if(_0x488272===undefined)_0x488272=_0x57b9e2;var _0x245f72=Object[_0x53436e(0x184)](_0x1dcff3,_0x57b9e2);(!_0x245f72||(_0x53436e(0x192)in _0x245f72?!_0x1dcff3[_0x53436e(0x1a3)]:_0x245f72[_0x53436e(0x1e3)]||_0x245f72[_0x53436e(0x1bd)]))&&(_0x245f72={'enumerable':!![],'get':function(){return _0x1dcff3[_0x57b9e2];}}),Object[_0x53436e(0x1dd)](_0x491865,_0x488272,_0x245f72);}:function(_0x1b64c2,_0x413ef6,_0xc948b7,_0x3d5378){if(_0x3d5378===undefined)_0x3d5378=_0xc948b7;_0x1b64c2[_0x3d5378]=_0x413ef6[_0xc948b7];}),__setModuleDefault=this&&this[a8_0x25f7e9(0x1a9)]||(Object[a8_0x25f7e9(0x1e1)]?function(_0x41755f,_0x393a98){const _0x26ca0a=a8_0x25f7e9;Object[_0x26ca0a(0x1dd)](_0x41755f,'default',{'enumerable':!![],'value':_0x393a98});}:function(_0x539e56,_0x11b83a){const _0x4f4368=a8_0x25f7e9;_0x539e56[_0x4f4368(0x185)]=_0x11b83a;}),__importStar=this&&this[a8_0x25f7e9(0x191)]||(function(){var _0x1dd2a4=function(_0x2e9390){const _0x4255b2=a8_0x21cf;return _0x1dd2a4=Object[_0x4255b2(0x194)]||function(_0x15c4b1){const _0x4d92b3=_0x4255b2;var _0x3553e7=[];for(var _0x32841f in _0x15c4b1)if(Object[_0x4d92b3(0x196)][_0x4d92b3(0x1aa)][_0x4d92b3(0x1e5)](_0x15c4b1,_0x32841f))_0x3553e7[_0x3553e7[_0x4d92b3(0x1a5)]]=_0x32841f;return _0x3553e7;},_0x1dd2a4(_0x2e9390);};return function(_0x4e32a7){const _0x432658=a8_0x21cf;if(_0x4e32a7&&_0x4e32a7[_0x432658(0x1a3)])return _0x4e32a7;var _0xc48172={};if(_0x4e32a7!=null){for(var _0x281d58=_0x1dd2a4(_0x4e32a7),_0x156cc3=0x0;_0x156cc3<_0x281d58[_0x432658(0x1a5)];_0x156cc3++)if(_0x281d58[_0x156cc3]!==_0x432658(0x185))__createBinding(_0xc48172,_0x4e32a7,_0x281d58[_0x156cc3]);}return __setModuleDefault(_0xc48172,_0x4e32a7),_0xc48172;};}()),__importDefault=this&&this['__importDefault']||function(_0x29edaf){const _0x28dde5=a8_0x25f7e9;return _0x29edaf&&_0x29edaf[_0x28dde5(0x1a3)]?_0x29edaf:{'default':_0x29edaf};};Object['defineProperty'](exports,a8_0x25f7e9(0x1a3),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x25f7e9(0x1d8)),mastercardService_1=require(a8_0x25f7e9(0x19e)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x2c5c83=a8_0x25f7e9;this['createPublicPayment']=async(_0x1c3c1c,_0x142e0f,_0x29da40)=>{const _0x3beff7=a8_0x21cf;try{const _0x5e47df=_0x1c3c1c[_0x3beff7(0x193)],_0x1a45dd=await this[_0x3beff7(0x186)][_0x3beff7(0x1dc)](_0x5e47df);_0x142e0f[_0x3beff7(0x1db)](0xc9)[_0x3beff7(0x17c)]({'success':!![],'message':_0x3beff7(0x1e7),'result':_0x1a45dd});}catch(_0x5c4199){_0x29da40(_0x5c4199);}},this[_0x2c5c83(0x1e0)]=async(_0x34e465,_0x3765a9,_0x3af198)=>{const _0x3b202d=_0x2c5c83;try{const {id:_0x3c0b09}=_0x34e465[_0x3b202d(0x19f)],_0x5e935d=await this['paymentService'][_0x3b202d(0x1e0)](_0x3c0b09);if(!_0x5e935d)return _0x3765a9['status'](0x194)['json']({'success':![],'message':_0x3b202d(0x1cf)});_0x3765a9[_0x3b202d(0x17c)]({'success':!![],'result':_0x5e935d});}catch(_0x1f9c53){_0x3af198(_0x1f9c53);}},this[_0x2c5c83(0x1c8)]=async(_0x4e515d,_0x106065,_0x268372)=>{const _0x5c187e=_0x2c5c83;try{const {id:_0x1055a9}=_0x4e515d[_0x5c187e(0x19f)],_0x49968a=await this[_0x5c187e(0x186)]['getPaymentById'](_0x1055a9);if(!_0x49968a)return _0x106065[_0x5c187e(0x1db)](0x194)[_0x5c187e(0x17c)]({'success':![],'message':_0x5c187e(0x1cf)});_0x106065[_0x5c187e(0x17c)]({'success':!![],'result':_0x49968a});}catch(_0x41acf6){_0x268372(_0x41acf6);}},this['updatePaymentCustomer']=async(_0x4bcccc,_0x20556b,_0x4cdf6f)=>{const _0x40669a=_0x2c5c83;try{const {id:_0x1dcc8f}=_0x4bcccc[_0x40669a(0x19f)],_0x41a71b=_0x4bcccc['body'];console[_0x40669a(0x1d0)](_0x40669a(0x1b5)+_0x1dcc8f),console[_0x40669a(0x1d0)]('📝\x20Customer\x20data:',_0x41a71b);const _0x296e04=await this[_0x40669a(0x186)]['updatePaymentCustomerDataPublic'](_0x1dcc8f,_0x41a71b);if(!_0x296e04)return _0x20556b['status'](0x194)[_0x40669a(0x17c)]({'success':![],'message':'Payment\x20not\x20found'});_0x20556b[_0x40669a(0x17c)]({'success':!![],'message':_0x40669a(0x188),'result':{'paymentId':_0x296e04['id'],'customerIp':_0x296e04[_0x40669a(0x1c4)],'customerUa':_0x296e04[_0x40669a(0x1bb)],'customerCountry':_0x296e04[_0x40669a(0x1d4)],'updatedAt':_0x296e04[_0x40669a(0x1a0)]}});}catch(_0x2fab42){_0x4cdf6f(_0x2fab42);}},this[_0x2c5c83(0x18d)]=async(_0x47f3d6,_0x233e12,_0x11f974)=>{const _0x4af17b=_0x2c5c83;try{const {id:_0x1a1aed}=_0x47f3d6['params'],{cardData:_0x2ae7a1,cardHolder:_0x1c7781,browser:_0x1adcf7}=_0x47f3d6['body'];console['log']('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x1a1aed);const _0x15650c=await database_1['default'][_0x4af17b(0x17d)][_0x4af17b(0x1cc)]({'where':{'id':_0x1a1aed},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x15650c)return _0x233e12[_0x4af17b(0x1db)](0x194)[_0x4af17b(0x17c)]({'success':![],'message':_0x4af17b(0x1cf)});if(_0x15650c[_0x4af17b(0x1c5)]!==_0x4af17b(0x17e))return _0x233e12[_0x4af17b(0x1db)](0x190)[_0x4af17b(0x17c)]({'success':![],'message':_0x4af17b(0x18b)});if(_0x15650c[_0x4af17b(0x1db)]!==_0x4af17b(0x1bc))return _0x233e12[_0x4af17b(0x1db)](0x190)[_0x4af17b(0x17c)]({'success':![],'message':'Payment\x20status\x20is\x20'+_0x15650c[_0x4af17b(0x1db)]+_0x4af17b(0x1da)});const _0x2d2266=_0x4af17b(0x1c3),_0x4f8b50=_0x15650c[_0x4af17b(0x19d)];console['log']('💳\x20MasterCard\x20URLs:'),console[_0x4af17b(0x1d0)](_0x4af17b(0x1d6)+_0x2d2266),console['log'](_0x4af17b(0x1c7)+_0x4f8b50);const _0x4252fe=await this['masterCardService'][_0x4af17b(0x1b6)]({'paymentId':_0x15650c['id'],'orderId':_0x15650c['gatewayOrderId']||_0x15650c['id'],'amount':_0x15650c[_0x4af17b(0x1b7)],'currency':_0x15650c['currency'],'cardData':_0x2ae7a1,'resultUrl':_0x2d2266,'returnUrl':_0x4f8b50,'cardHolder':_0x1c7781,'browser':_0x1adcf7});console['log'](_0x4af17b(0x1b1),_0x4252fe);const _0x3b7215={'status':_0x4252fe[_0x4af17b(0x1db)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x4252fe[_0x4af17b(0x1db)]===_0x4af17b(0x1d1))_0x3b7215[_0x4af17b(0x179)]=new Date(),_0x3b7215[_0x4af17b(0x1a6)]=_0x4252fe[_0x4af17b(0x1b8)];else _0x4252fe[_0x4af17b(0x1db)]===_0x4af17b(0x183)&&(_0x3b7215[_0x4af17b(0x1af)]=_0x4af17b(0x17f));_0x3b7215['paymentMethod']=_0x4af17b(0x17e),await database_1[_0x4af17b(0x185)][_0x4af17b(0x17d)]['update']({'where':{'id':_0x15650c['id']},'data':_0x3b7215}),await database_1[_0x4af17b(0x185)]['webhookLog'][_0x4af17b(0x1e1)]({'data':{'paymentId':_0x15650c['id'],'shopId':_0x15650c[_0x4af17b(0x1a4)],'event':_0x4af17b(0x198)+_0x4252fe[_0x4af17b(0x1db)]?.[_0x4af17b(0x1d3)](),'statusCode':0xc8,'responseBody':JSON[_0x4af17b(0x1cb)]({'oldStatus':_0x4af17b(0x1bc),'newStatus':_0x4252fe['status'],'gatewayPaymentId':_0x4252fe[_0x4af17b(0x1b8)],'requires3ds':_0x4252fe['requires_3ds'],'processedAt':new Date()[_0x4af17b(0x1ad)]()})}});_0x4252fe[_0x4af17b(0x1de)]&&(await this[_0x4af17b(0x1ce)](_0x15650c,_0x4252fe[_0x4af17b(0x1db)],_0x4252fe[_0x4af17b(0x1b8)]),await this['sendPaymentStatusNotification'](_0x15650c,_0x4252fe['status']));console[_0x4af17b(0x1d0)](_0x4af17b(0x189)+_0x1a1aed+_0x4af17b(0x195)+_0x4252fe[_0x4af17b(0x1db)]);if(_0x4252fe[_0x4af17b(0x1db)]==='PAID')_0x233e12[_0x4af17b(0x17c)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x4af17b(0x1d1),'gatewayPaymentId':_0x4252fe['gateway_payment_id'],'redirectUrl':_0x4f8b50,'final':!![]}});else _0x4252fe[_0x4af17b(0x1b0)]&&_0x4252fe[_0x4af17b(0x1bf)]?_0x233e12[_0x4af17b(0x17c)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x4af17b(0x1bc),'gatewayPaymentId':_0x4252fe[_0x4af17b(0x1b8)],'redirectUrl':_0x4252fe[_0x4af17b(0x1bf)],'requires3ds':!![],'final':![]}}):_0x233e12[_0x4af17b(0x1db)](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x4af17b(0x183),'gatewayPaymentId':_0x4252fe['gateway_payment_id'],'redirectUrl':_0x15650c[_0x4af17b(0x1ac)],'final':!![]}});}catch(_0x43ed72){_0x11f974(_0x43ed72);}},this[_0x2c5c83(0x186)]=new paymentService_1['PaymentService'](),this[_0x2c5c83(0x190)]=new mastercardService_1[(_0x2c5c83(0x19b))](),this[_0x2c5c83(0x19a)]=new webhookService_1[(_0x2c5c83(0x1b3))]();}async[a8_0x25f7e9(0x1ce)](_0x2b1ee3,_0xcc7253,_0x33d30d){const _0x2192cc=a8_0x25f7e9,_0x3b9a11=Date[_0x2192cc(0x1c1)]();try{const _0x40d016=_0x2b1ee3[_0x2192cc(0x1e8)],_0xabb2cc=_0x40d016['settings'];if(!_0xabb2cc?.[_0x2192cc(0x1b2)]){console[_0x2192cc(0x1d0)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x40d016['id']);return;}const _0x57222e=_0xcc7253==='PAID'?_0x2192cc(0x178):_0x2192cc(0x1d7);let _0x51f223=[];if(_0xabb2cc[_0x2192cc(0x18e)])try{_0x51f223=Array['isArray'](_0xabb2cc['webhookEvents'])?_0xabb2cc['webhookEvents']:JSON[_0x2192cc(0x19c)](_0xabb2cc[_0x2192cc(0x18e)]);}catch(_0x296e55){console['error'](_0x2192cc(0x1c0),_0x296e55),_0x51f223=[];}if(!_0x51f223[_0x2192cc(0x1a7)](_0x57222e)){console[_0x2192cc(0x1d0)](_0x2192cc(0x18f)+_0x57222e+_0x2192cc(0x17a)+_0x40d016['id']);return;}const _0x18ee11={'event':_0x57222e,'payment':{'id':_0x2b1ee3['id'],'order_id':_0x2b1ee3[_0x2192cc(0x1d2)],'gateway_order_id':_0x2b1ee3[_0x2192cc(0x197)],'gateway':_0x2192cc(0x1d9),'amount':_0x2b1ee3['amount'],'currency':_0x2b1ee3[_0x2192cc(0x1a1)],'status':_0xcc7253[_0x2192cc(0x1d3)](),'customer_email':_0x2b1ee3[_0x2192cc(0x182)],'customer_name':_0x2b1ee3[_0x2192cc(0x199)],'gateway_payment_id':_0x33d30d,'created_at':_0x2b1ee3[_0x2192cc(0x1ae)],'updated_at':new Date()}},_0x318575=await fetch(_0xabb2cc[_0x2192cc(0x1b2)],{'method':_0x2192cc(0x1b9),'headers':{'Content-Type':'application/json','User-Agent':_0x2192cc(0x1c2)},'body':JSON[_0x2192cc(0x1cb)](_0x18ee11)}),_0x1a594f=Date[_0x2192cc(0x1c1)]()-_0x3b9a11;console['log'](_0x2192cc(0x1e6)+_0xabb2cc[_0x2192cc(0x1b2)]+_0x2192cc(0x1b4)+_0x318575[_0x2192cc(0x1db)]+'\x20('+_0x1a594f+_0x2192cc(0x1ca));}catch(_0x498db1){console['error'](_0x2192cc(0x1a8),_0x498db1);}}async[a8_0x25f7e9(0x18c)](_0x5ceec7,_0x461e03){const _0x55e8f3=a8_0x25f7e9;try{const {telegramBotService:_0x1e69fb}=await Promise[_0x55e8f3(0x180)]()[_0x55e8f3(0x1cd)](()=>__importStar(require(_0x55e8f3(0x187)))),_0x34b44f={'PAID':'paid','FAILED':_0x55e8f3(0x17b)},_0x2fc878=_0x34b44f[_0x461e03];if(!_0x2fc878)return;await _0x1e69fb[_0x55e8f3(0x1c9)](_0x5ceec7[_0x55e8f3(0x1a4)],_0x5ceec7,_0x2fc878);}catch(_0x4805e5){console['error'](_0x55e8f3(0x1a2),_0x4805e5);}}}function a8_0x4bd4(){const _0xacb6e4=['create','48929608MitTsR','writable','216wFonlA','call','MasterCard\x20webhook\x20sent\x20to\x20','Payment\x20created\x20successfully','shop','payment.success','paidAt','\x20not\x20enabled\x20for\x20shop\x20','failed','json','payment','mastercard','Card\x20payment\x20failed','resolve','12631815YzIDPN','customerEmail','FAILED','getOwnPropertyDescriptor','default','paymentService','../services/telegramBotService','Customer\x20data\x20updated\x20successfully','✅\x20MasterCard\x20payment\x20','PaymentController','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','sendPaymentStatusNotification','processMasterCardPayment','webhookEvents','Webhook\x20event\x20','masterCardService','__importStar','get','body','getOwnPropertyNames','\x20processed:\x20','prototype','gatewayOrderId','mastercard_','customerName','webhookService','MasterCardService','parse','successUrl','../services/gateways/mastercardService','params','updatedAt','currency','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','__esModule','shopId','length','gatewayPaymentId','includes','Failed\x20to\x20send\x20MasterCard\x20webhook:','__setModuleDefault','hasOwnProperty','67845iGpnek','failUrl','toISOString','createdAt','failureMessage','requires_3ds','💳\x20MasterCard\x20result:','webhookUrl','WebhookService','\x20with\x20status\x20','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','processCardPayment','amount','gateway_payment_id','POST','2486362lZKlxC','customerUa','PENDING','configurable','1368546cZnhmy','threeds_url','Error\x20parsing\x20webhook\x20events:','now','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','https://api.trapay.uk/api/webhooks/gateway/mastercard','customerIp','gateway','3290790cVpejB','\x20\x20\x20Return\x20URL:\x20','getPaymentById','sendPaymentNotification','ms)','stringify','findUnique','then','sendShopWebhook','Payment\x20not\x20found','log','PAID','orderId','toLowerCase','customerCountry','1820987VwHLqr','\x20\x20\x20Result\x20URL\x20(webhook):\x20','payment.failed','../services/paymentService','1111',',\x20cannot\x20process','status','createPublicPayment','defineProperty','final','__createBinding','getPaymentStatus'];a8_0x4bd4=function(){return _0xacb6e4;};return a8_0x4bd4();}exports[a8_0x25f7e9(0x18a)]=PaymentController;