'use strict';const a8_0xe5583f=a8_0x32f3;(function(_0x6e5900,_0x30eea3){const _0xcf5c20=a8_0x32f3,_0x221259=_0x6e5900();while(!![]){try{const _0x37230d=parseInt(_0xcf5c20(0x191))/0x1+-parseInt(_0xcf5c20(0x1a7))/0x2*(-parseInt(_0xcf5c20(0x174))/0x3)+-parseInt(_0xcf5c20(0x15f))/0x4+parseInt(_0xcf5c20(0x190))/0x5*(-parseInt(_0xcf5c20(0x158))/0x6)+parseInt(_0xcf5c20(0x176))/0x7*(parseInt(_0xcf5c20(0x15a))/0x8)+parseInt(_0xcf5c20(0x132))/0x9+-parseInt(_0xcf5c20(0x139))/0xa*(parseInt(_0xcf5c20(0x164))/0xb);if(_0x37230d===_0x30eea3)break;else _0x221259['push'](_0x221259['shift']());}catch(_0x2c0116){_0x221259['push'](_0x221259['shift']());}}}(a8_0x5678,0xec7bc));function a8_0x5678(){const _0x492765=['updatedAt','shop','failUrl','customerName','final','customerEmail','Payment\x20status\x20is\x20',',\x20shop:\x20','customerIp','../services/telegramBotService','gatewayPaymentId','Payment\x20not\x20found\x20or\x20not\x20owned\x20by\x20this\x20shop','ms)','../config/database','gateway_payment_id','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','updatePaymentCustomer','getOwnPropertyNames','webhookUrl','error','78cDrPQt','paymentService','409040zfMoJU','processMasterCardPayment','findUnique','amount','üìù\x20Customer\x20data:','915364qjRIco','\x20with\x20status\x20','‚úÖ\x20MasterCard\x20payment\x20','create','PAID','13667170voIaZJ','paidAt','WebhookService','webhookLog','shopId','Payment\x20failed','payment','mastercard_','threeds_url','PaymentController','currency','processCardPayment','parse','customerCountry','body','settings','1157694mBDsDk','PENDING','42iQCJdN','gatewayOrderId','__createBinding','params','successUrl','failureMessage','status','Card\x20payment\x20failed','getPaymentStatus','isArray','\x20\x20\x20Return\x20URL:\x20','\x20\x20\x20Result\x20URL\x20(webhook):\x20','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','toLowerCase','call','üí≥\x20MasterCard\x20URLs:','updatePaymentCustomerData','stringify','sendPaymentNotification','orderId','application/json','log','createPublicPayment','prototype','writable','MasterCard\x20webhook\x20sent\x20to\x20','110015RtyioJ','1366984BTifkG','now','payment.failed','Failed\x20to\x20send\x20MasterCard\x20webhook:','system','__importStar','length','Payment\x20not\x20found','FAILED','configurable','Webhook\x20event\x20','hasOwnProperty','__esModule','Payment\x20created\x20successfully','1111','masterCardService','includes','../services/paymentService','webhookService','defineProperty','gateway','../services/gateways/mastercardService','4YFiOZM','webhookEvents','get','sendPaymentStatusNotification','2523834VDNlvs','sendShopWebhook','getOwnPropertyDescriptor','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','getPaymentById','Customer\x20data\x20updated\x20successfully','Unauthorized','10Enuwud','mastercard','requires_3ds','https://api.trapay.uk/api/webhooks/gateway/mastercard','\x20processed:\x20','../services/webhookService','json','customerUa','default','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','üí≥\x20MasterCard\x20result:'];a8_0x5678=function(){return _0x492765;};return a8_0x5678();}var __createBinding=this&&this[a8_0xe5583f(0x178)]||(Object[a8_0xe5583f(0x162)]?function(_0x3fe6b0,_0x5c1d17,_0xa39893,_0x566649){const _0xcf1c0=a8_0xe5583f;if(_0x566649===undefined)_0x566649=_0xa39893;var _0x32c50e=Object[_0xcf1c0(0x134)](_0x5c1d17,_0xa39893);(!_0x32c50e||(_0xcf1c0(0x1a9)in _0x32c50e?!_0x5c1d17[_0xcf1c0(0x19d)]:_0x32c50e[_0xcf1c0(0x18e)]||_0x32c50e[_0xcf1c0(0x19a)]))&&(_0x32c50e={'enumerable':!![],'get':function(){return _0x5c1d17[_0xa39893];}}),Object['defineProperty'](_0x3fe6b0,_0x566649,_0x32c50e);}:function(_0x47dd1c,_0x123cc,_0x13ee40,_0x139c64){if(_0x139c64===undefined)_0x139c64=_0x13ee40;_0x47dd1c[_0x139c64]=_0x123cc[_0x13ee40];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x46697c,_0x3f5eae){const _0x234c7f=a8_0xe5583f;Object['defineProperty'](_0x46697c,_0x234c7f(0x141),{'enumerable':!![],'value':_0x3f5eae});}:function(_0x20ea62,_0x3af47f){const _0x2a2bb4=a8_0xe5583f;_0x20ea62[_0x2a2bb4(0x141)]=_0x3af47f;}),__importStar=this&&this[a8_0xe5583f(0x196)]||(function(){var _0x40d673=function(_0xe407b9){const _0x48a9d3=a8_0x32f3;return _0x40d673=Object[_0x48a9d3(0x155)]||function(_0x1e075c){const _0x12efd8=_0x48a9d3;var _0x52e966=[];for(var _0x55dff7 in _0x1e075c)if(Object[_0x12efd8(0x18d)][_0x12efd8(0x19c)][_0x12efd8(0x184)](_0x1e075c,_0x55dff7))_0x52e966[_0x52e966['length']]=_0x55dff7;return _0x52e966;},_0x40d673(_0xe407b9);};return function(_0x27aae3){const _0x14b4fa=a8_0x32f3;if(_0x27aae3&&_0x27aae3['__esModule'])return _0x27aae3;var _0x12f44a={};if(_0x27aae3!=null){for(var _0x1f4889=_0x40d673(_0x27aae3),_0x4df931=0x0;_0x4df931<_0x1f4889[_0x14b4fa(0x197)];_0x4df931++)if(_0x1f4889[_0x4df931]!==_0x14b4fa(0x141))__createBinding(_0x12f44a,_0x27aae3,_0x1f4889[_0x4df931]);}return __setModuleDefault(_0x12f44a,_0x27aae3),_0x12f44a;};}()),__importDefault=this&&this['__importDefault']||function(_0xba41e){return _0xba41e&&_0xba41e['__esModule']?_0xba41e:{'default':_0xba41e};};Object[a8_0xe5583f(0x1a4)](exports,'__esModule',{'value':!![]}),exports[a8_0xe5583f(0x16d)]=void 0x0;const paymentService_1=require(a8_0xe5583f(0x1a2)),mastercardService_1=require(a8_0xe5583f(0x1a6)),webhookService_1=require(a8_0xe5583f(0x13e)),database_1=__importDefault(require(a8_0xe5583f(0x151)));class PaymentController{constructor(){const _0x3f3b68=a8_0xe5583f;this[_0x3f3b68(0x18c)]=async(_0x37272d,_0x469459,_0x52c404)=>{const _0x2e311d=_0x3f3b68;try{const _0x4a8cb7=_0x37272d[_0x2e311d(0x172)],_0x402b59=await this[_0x2e311d(0x159)][_0x2e311d(0x18c)](_0x4a8cb7);_0x469459[_0x2e311d(0x17c)](0xc9)['json']({'success':!![],'message':_0x2e311d(0x19e),'result':_0x402b59});}catch(_0x9029f8){_0x52c404(_0x9029f8);}},this['getPaymentStatus']=async(_0x49e160,_0x303d63,_0x553dbe)=>{const _0x2db1f7=_0x3f3b68;try{const {id:_0x2678a0}=_0x49e160[_0x2db1f7(0x179)],_0x260e19=await this['paymentService'][_0x2db1f7(0x17e)](_0x2678a0);if(!_0x260e19)return _0x303d63[_0x2db1f7(0x17c)](0x194)[_0x2db1f7(0x13f)]({'success':![],'message':_0x2db1f7(0x198)});_0x303d63[_0x2db1f7(0x13f)]({'success':!![],'result':_0x260e19});}catch(_0x54d67c){_0x553dbe(_0x54d67c);}},this[_0x3f3b68(0x136)]=async(_0x373c4a,_0x2207ec,_0x1fe525)=>{const _0xdc87a5=_0x3f3b68;try{const {id:_0x17b54c}=_0x373c4a['params'],_0x42dc6c=await this[_0xdc87a5(0x159)][_0xdc87a5(0x136)](_0x17b54c);if(!_0x42dc6c)return _0x2207ec[_0xdc87a5(0x17c)](0x194)['json']({'success':![],'message':_0xdc87a5(0x198)});_0x2207ec['json']({'success':!![],'result':_0x42dc6c});}catch(_0x501c7d){_0x1fe525(_0x501c7d);}},this[_0x3f3b68(0x154)]=async(_0x42d693,_0xa2a909,_0x4cb1e4)=>{const _0x35e4f1=_0x3f3b68;try{const {id:_0x271cf1}=_0x42d693['params'],_0x235b4c=_0x42d693['user']?.['id'],_0x352cd1=_0x42d693[_0x35e4f1(0x172)];if(!_0x235b4c)return _0xa2a909[_0x35e4f1(0x17c)](0x191)['json']({'success':![],'message':_0x35e4f1(0x138)});console[_0x35e4f1(0x18b)](_0x35e4f1(0x153)+_0x271cf1+_0x35e4f1(0x14b)+_0x235b4c),console[_0x35e4f1(0x18b)](_0x35e4f1(0x15e),_0x352cd1);const _0x5bbcc0=await this[_0x35e4f1(0x159)][_0x35e4f1(0x186)](_0x235b4c,_0x271cf1,_0x352cd1);if(!_0x5bbcc0)return _0xa2a909[_0x35e4f1(0x17c)](0x194)[_0x35e4f1(0x13f)]({'success':![],'message':_0x35e4f1(0x14f)});_0xa2a909[_0x35e4f1(0x13f)]({'success':!![],'message':_0x35e4f1(0x137),'result':{'paymentId':_0x5bbcc0['id'],'customerIp':_0x5bbcc0[_0x35e4f1(0x14c)],'customerUa':_0x5bbcc0[_0x35e4f1(0x140)],'customerCountry':_0x5bbcc0[_0x35e4f1(0x171)],'updatedAt':_0x5bbcc0[_0x35e4f1(0x144)]}});}catch(_0x27ef1d){_0x4cb1e4(_0x27ef1d);}},this[_0x3f3b68(0x15b)]=async(_0x1308fc,_0xabfb69,_0x2dc249)=>{const _0x496baa=_0x3f3b68;try{const {id:_0x195298}=_0x1308fc[_0x496baa(0x179)],{cardData:_0x47773e,cardHolder:_0x33360b,browser:_0x116a9a}=_0x1308fc[_0x496baa(0x172)];console[_0x496baa(0x18b)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x195298);const _0x22534e=await database_1['default'][_0x496baa(0x16a)][_0x496baa(0x15c)]({'where':{'id':_0x195298},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x22534e)return _0xabfb69['status'](0x194)[_0x496baa(0x13f)]({'success':![],'message':_0x496baa(0x198)});if(_0x22534e[_0x496baa(0x1a5)]!==_0x496baa(0x13a))return _0xabfb69[_0x496baa(0x17c)](0x190)['json']({'success':![],'message':_0x496baa(0x135)});if(_0x22534e[_0x496baa(0x17c)]!=='PENDING')return _0xabfb69[_0x496baa(0x17c)](0x190)[_0x496baa(0x13f)]({'success':![],'message':_0x496baa(0x14a)+_0x22534e['status']+',\x20cannot\x20process'});const _0x20664d=_0x496baa(0x13c),_0x46cb6c=_0x22534e[_0x496baa(0x17a)];console[_0x496baa(0x18b)](_0x496baa(0x185)),console[_0x496baa(0x18b)](_0x496baa(0x181)+_0x20664d),console[_0x496baa(0x18b)](_0x496baa(0x180)+_0x46cb6c);const _0x241b11=await this[_0x496baa(0x1a0)][_0x496baa(0x16f)]({'paymentId':_0x22534e['id'],'orderId':_0x22534e[_0x496baa(0x177)]||_0x22534e['id'],'amount':_0x22534e['amount'],'currency':_0x22534e['currency'],'cardData':_0x47773e,'resultUrl':_0x20664d,'returnUrl':_0x46cb6c,'cardHolder':_0x33360b,'browser':_0x116a9a});console[_0x496baa(0x18b)](_0x496baa(0x143),_0x241b11);const _0x4b8d84={'status':_0x241b11['status'],'updatedAt':new Date(),'statusChangedBy':_0x496baa(0x195),'statusChangedAt':new Date()};if(_0x241b11[_0x496baa(0x17c)]===_0x496baa(0x163))_0x4b8d84[_0x496baa(0x165)]=new Date(),_0x4b8d84[_0x496baa(0x14e)]=_0x241b11[_0x496baa(0x152)];else _0x241b11[_0x496baa(0x17c)]===_0x496baa(0x199)&&(_0x4b8d84[_0x496baa(0x17b)]=_0x496baa(0x17d));_0x4b8d84['paymentMethod']=_0x496baa(0x13a),await database_1[_0x496baa(0x141)]['payment']['update']({'where':{'id':_0x22534e['id']},'data':_0x4b8d84}),await database_1[_0x496baa(0x141)][_0x496baa(0x167)][_0x496baa(0x162)]({'data':{'paymentId':_0x22534e['id'],'shopId':_0x22534e[_0x496baa(0x168)],'event':_0x496baa(0x16b)+_0x241b11['status']?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x496baa(0x187)]({'oldStatus':'PENDING','newStatus':_0x241b11[_0x496baa(0x17c)],'gatewayPaymentId':_0x241b11[_0x496baa(0x152)],'requires3ds':_0x241b11['requires_3ds'],'processedAt':new Date()['toISOString']()})}});_0x241b11[_0x496baa(0x148)]&&(await this[_0x496baa(0x133)](_0x22534e,_0x241b11[_0x496baa(0x17c)],_0x241b11[_0x496baa(0x152)]),await this[_0x496baa(0x1aa)](_0x22534e,_0x241b11['status']));console['log'](_0x496baa(0x161)+_0x195298+_0x496baa(0x13d)+_0x241b11[_0x496baa(0x17c)]);if(_0x241b11[_0x496baa(0x17c)]===_0x496baa(0x163))_0xabfb69[_0x496baa(0x13f)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x496baa(0x163),'gatewayPaymentId':_0x241b11[_0x496baa(0x152)],'redirectUrl':_0x46cb6c,'final':!![]}});else _0x241b11[_0x496baa(0x13b)]&&_0x241b11['threeds_url']?_0xabfb69[_0x496baa(0x13f)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x496baa(0x175),'gatewayPaymentId':_0x241b11[_0x496baa(0x152)],'redirectUrl':_0x241b11[_0x496baa(0x16c)],'requires3ds':!![],'final':![]}}):_0xabfb69['status'](0x190)['json']({'success':![],'message':_0x496baa(0x169),'result':{'status':_0x496baa(0x199),'gatewayPaymentId':_0x241b11[_0x496baa(0x152)],'redirectUrl':_0x22534e[_0x496baa(0x146)],'final':!![]}});}catch(_0x4047e7){_0x2dc249(_0x4047e7);}},this[_0x3f3b68(0x159)]=new paymentService_1['PaymentService'](),this[_0x3f3b68(0x1a0)]=new mastercardService_1['MasterCardService'](),this[_0x3f3b68(0x1a3)]=new webhookService_1[(_0x3f3b68(0x166))]();}async[a8_0xe5583f(0x133)](_0xe7882a,_0x14141c,_0x58fea8){const _0x1d9ffb=a8_0xe5583f,_0x41e960=Date[_0x1d9ffb(0x192)]();try{const _0x51f48d=_0xe7882a[_0x1d9ffb(0x145)],_0x30949c=_0x51f48d[_0x1d9ffb(0x173)];if(!_0x30949c?.[_0x1d9ffb(0x156)]){console['log'](_0x1d9ffb(0x182)+_0x51f48d['id']);return;}const _0x520e68=_0x14141c===_0x1d9ffb(0x163)?'payment.success':_0x1d9ffb(0x193);let _0x322d79=[];if(_0x30949c[_0x1d9ffb(0x1a8)])try{_0x322d79=Array[_0x1d9ffb(0x17f)](_0x30949c['webhookEvents'])?_0x30949c['webhookEvents']:JSON[_0x1d9ffb(0x170)](_0x30949c[_0x1d9ffb(0x1a8)]);}catch(_0x57c6a6){console[_0x1d9ffb(0x157)]('Error\x20parsing\x20webhook\x20events:',_0x57c6a6),_0x322d79=[];}if(!_0x322d79[_0x1d9ffb(0x1a1)](_0x520e68)){console[_0x1d9ffb(0x18b)](_0x1d9ffb(0x19b)+_0x520e68+'\x20not\x20enabled\x20for\x20shop\x20'+_0x51f48d['id']);return;}const _0x5dfe49={'event':_0x520e68,'payment':{'id':_0xe7882a['id'],'order_id':_0xe7882a[_0x1d9ffb(0x189)],'gateway_order_id':_0xe7882a[_0x1d9ffb(0x177)],'gateway':_0x1d9ffb(0x19f),'amount':_0xe7882a[_0x1d9ffb(0x15d)],'currency':_0xe7882a[_0x1d9ffb(0x16e)],'status':_0x14141c[_0x1d9ffb(0x183)](),'customer_email':_0xe7882a[_0x1d9ffb(0x149)],'customer_name':_0xe7882a[_0x1d9ffb(0x147)],'gateway_payment_id':_0x58fea8,'created_at':_0xe7882a['createdAt'],'updated_at':new Date()}},_0x17fd56=await fetch(_0x30949c['webhookUrl'],{'method':'POST','headers':{'Content-Type':_0x1d9ffb(0x18a),'User-Agent':_0x1d9ffb(0x142)},'body':JSON[_0x1d9ffb(0x187)](_0x5dfe49)}),_0x29ba27=Date[_0x1d9ffb(0x192)]()-_0x41e960;console[_0x1d9ffb(0x18b)](_0x1d9ffb(0x18f)+_0x30949c['webhookUrl']+_0x1d9ffb(0x160)+_0x17fd56['status']+'\x20('+_0x29ba27+_0x1d9ffb(0x150));}catch(_0x4b854d){console[_0x1d9ffb(0x157)](_0x1d9ffb(0x194),_0x4b854d);}}async['sendPaymentStatusNotification'](_0x53b12f,_0x35fe6b){const _0x447230=a8_0xe5583f;try{const {telegramBotService:_0x1c328a}=await Promise['resolve']()['then'](()=>__importStar(require(_0x447230(0x14d)))),_0x2e55f7={'PAID':'paid','FAILED':'failed'},_0x4dd15c=_0x2e55f7[_0x35fe6b];if(!_0x4dd15c)return;await _0x1c328a[_0x447230(0x188)](_0x53b12f[_0x447230(0x168)],_0x53b12f,_0x4dd15c);}catch(_0x4a6f9d){console[_0x447230(0x157)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x4a6f9d);}}}function a8_0x32f3(_0x2f0f30,_0x3dd99f){const _0x5678ad=a8_0x5678();return a8_0x32f3=function(_0x32f341,_0x5d7e6e){_0x32f341=_0x32f341-0x132;let _0x1f2e4d=_0x5678ad[_0x32f341];return _0x1f2e4d;},a8_0x32f3(_0x2f0f30,_0x3dd99f);}exports[a8_0xe5583f(0x16d)]=PaymentController;