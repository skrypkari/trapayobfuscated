'use strict';const a8_0x42e8af=a8_0x20a3;function a8_0x20a3(_0x3a711f,_0x3d2756){const _0x2ba883=a8_0x2ba8();return a8_0x20a3=function(_0x20a388,_0x4db90f){_0x20a388=_0x20a388-0x18c;let _0x207f64=_0x2ba883[_0x20a388];return _0x207f64;},a8_0x20a3(_0x3a711f,_0x3d2756);}(function(_0x4cda8e,_0x45d9dc){const _0xaf282f=a8_0x20a3,_0x5428db=_0x4cda8e();while(!![]){try{const _0x21df60=parseInt(_0xaf282f(0x1bd))/0x1*(-parseInt(_0xaf282f(0x1f1))/0x2)+parseInt(_0xaf282f(0x1d4))/0x3*(-parseInt(_0xaf282f(0x1e3))/0x4)+parseInt(_0xaf282f(0x1c7))/0x5*(parseInt(_0xaf282f(0x1e7))/0x6)+parseInt(_0xaf282f(0x1eb))/0x7*(parseInt(_0xaf282f(0x1d2))/0x8)+-parseInt(_0xaf282f(0x199))/0x9*(parseInt(_0xaf282f(0x1da))/0xa)+parseInt(_0xaf282f(0x1ad))/0xb*(parseInt(_0xaf282f(0x1e4))/0xc)+parseInt(_0xaf282f(0x1a7))/0xd;if(_0x21df60===_0x45d9dc)break;else _0x5428db['push'](_0x5428db['shift']());}catch(_0x477117){_0x5428db['push'](_0x5428db['shift']());}}}(a8_0x2ba8,0xf27f4));var __createBinding=this&&this[a8_0x42e8af(0x1ca)]||(Object[a8_0x42e8af(0x1aa)]?function(_0xe6b731,_0x23ed91,_0x11e7dd,_0x3e9a7a){const _0x2b0d72=a8_0x42e8af;if(_0x3e9a7a===undefined)_0x3e9a7a=_0x11e7dd;var _0x5a7de3=Object[_0x2b0d72(0x1c2)](_0x23ed91,_0x11e7dd);(!_0x5a7de3||(_0x2b0d72(0x1bc)in _0x5a7de3?!_0x23ed91[_0x2b0d72(0x1d0)]:_0x5a7de3[_0x2b0d72(0x1c8)]||_0x5a7de3[_0x2b0d72(0x1ec)]))&&(_0x5a7de3={'enumerable':!![],'get':function(){return _0x23ed91[_0x11e7dd];}}),Object[_0x2b0d72(0x1b9)](_0xe6b731,_0x3e9a7a,_0x5a7de3);}:function(_0x3719e6,_0x5bec7c,_0x6c3e23,_0x1ad63c){if(_0x1ad63c===undefined)_0x1ad63c=_0x6c3e23;_0x3719e6[_0x1ad63c]=_0x5bec7c[_0x6c3e23];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x42e8af(0x1aa)]?function(_0x3bfb6d,_0x2ef612){const _0x44bdf1=a8_0x42e8af;Object[_0x44bdf1(0x1b9)](_0x3bfb6d,_0x44bdf1(0x1f3),{'enumerable':!![],'value':_0x2ef612});}:function(_0x2c728b,_0x26a9b4){_0x2c728b['default']=_0x26a9b4;}),__importStar=this&&this['__importStar']||(function(){var _0x33806f=function(_0x58ee38){const _0x39e441=a8_0x20a3;return _0x33806f=Object[_0x39e441(0x1ab)]||function(_0x10249b){const _0x396454=_0x39e441;var _0x5f1de9=[];for(var _0xdd3612 in _0x10249b)if(Object[_0x396454(0x1de)][_0x396454(0x1e8)][_0x396454(0x192)](_0x10249b,_0xdd3612))_0x5f1de9[_0x5f1de9[_0x396454(0x18c)]]=_0xdd3612;return _0x5f1de9;},_0x33806f(_0x58ee38);};return function(_0x4a1a27){const _0x3d64e1=a8_0x20a3;if(_0x4a1a27&&_0x4a1a27[_0x3d64e1(0x1d0)])return _0x4a1a27;var _0x300daa={};if(_0x4a1a27!=null){for(var _0x36cdfc=_0x33806f(_0x4a1a27),_0x31c22f=0x0;_0x31c22f<_0x36cdfc['length'];_0x31c22f++)if(_0x36cdfc[_0x31c22f]!==_0x3d64e1(0x1f3))__createBinding(_0x300daa,_0x4a1a27,_0x36cdfc[_0x31c22f]);}return __setModuleDefault(_0x300daa,_0x4a1a27),_0x300daa;};}()),__importDefault=this&&this[a8_0x42e8af(0x1ba)]||function(_0x487998){const _0x4f73dd=a8_0x42e8af;return _0x487998&&_0x487998[_0x4f73dd(0x1d0)]?_0x487998:{'default':_0x487998};};Object[a8_0x42e8af(0x1b9)](exports,a8_0x42e8af(0x1d0),{'value':!![]}),exports[a8_0x42e8af(0x19c)]=void 0x0;const paymentService_1=require(a8_0x42e8af(0x1f0)),mastercardService_1=require(a8_0x42e8af(0x1a9)),webhookService_1=require(a8_0x42e8af(0x1ea)),database_1=__importDefault(require(a8_0x42e8af(0x1cb)));function a8_0x2ba8(){const _0x1ef482=['getOwnPropertyNames','body','4320591rwVgbN','MasterCardService','error','processMasterCardPayment','Payment\x20failed',',\x20cannot\x20process','MasterCard\x20webhook\x20sent\x20to\x20','\x20with\x20status\x20','then','POST','sendShopWebhook','webhookService','defineProperty','__importDefault','amount','get','4157GcdUPy','system','getPaymentStatus','sendPaymentStatusNotification','PENDING','getOwnPropertyDescriptor','\x20\x20\x20Return\x20URL:\x20','update','orderId','customerName','100MTUaBb','writable','gatewayOrderId','__createBinding','../config/database','Webhook\x20event\x20','\x20processed:\x20','settings','now','__esModule','paid','42760FntBot','webhookEvents','3vJfjmA','mastercard','requires_3ds','âœ…\x20MasterCard\x20payment\x20','ms)','paymentService','9020QygmUs','Payment\x20not\x20found','ðŸ’³\x20MasterCard\x20result:','sendPaymentNotification','prototype','paidAt','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','log','params','5426512JnZQjn','24TkUyoG','Payment\x20status\x20is\x20','createdAt','591348cuDapJ','hasOwnProperty','currency','../services/webhookService','1400SRuErM','configurable','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','isArray','final','../services/paymentService','366YHxCFf','masterCardService','default','gateway_payment_id','gatewayPaymentId','length','stringify','FAILED','threeds_url','payment.failed','Card\x20payment\x20failed','call','paymentMethod','webhookUrl','json','WebhookService','toISOString','toLowerCase','10053tmFZTE','getPaymentById','3DS\x20verification\x20required','PaymentController','resolve','failureMessage','Payment\x20processed\x20successfully','\x20\x20\x20Result\x20URL\x20(webhook):\x20','failUrl','PAID','1111','shopId','status','createPublicPayment','3801707ihBzhk','PaymentService','../services/gateways/mastercardService','create'];a8_0x2ba8=function(){return _0x1ef482;};return a8_0x2ba8();}class PaymentController{constructor(){const _0x31ba93=a8_0x42e8af;this[_0x31ba93(0x1a6)]=async(_0x72ec6c,_0xa46991,_0xaac596)=>{const _0x509aed=_0x31ba93;try{const _0x4e1793=_0x72ec6c[_0x509aed(0x1ac)],_0x39b45c=await this['paymentService'][_0x509aed(0x1a6)](_0x4e1793);_0xa46991['status'](0xc9)[_0x509aed(0x195)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x39b45c});}catch(_0x32bf1a){_0xaac596(_0x32bf1a);}},this[_0x31ba93(0x1bf)]=async(_0x352a4a,_0x5c670e,_0xf96947)=>{const _0x27d80c=_0x31ba93;try{const {id:_0x27b39d}=_0x352a4a[_0x27d80c(0x1e2)],_0x283f24=await this[_0x27d80c(0x1d9)][_0x27d80c(0x1bf)](_0x27b39d);if(!_0x283f24)return _0x5c670e[_0x27d80c(0x1a5)](0x194)['json']({'success':![],'message':_0x27d80c(0x1db)});_0x5c670e[_0x27d80c(0x195)]({'success':!![],'result':_0x283f24});}catch(_0x159471){_0xf96947(_0x159471);}},this['getPaymentById']=async(_0x2f7160,_0x43ed2c,_0x40cf45)=>{const _0x4f6597=_0x31ba93;try{const {id:_0x34bb5d}=_0x2f7160[_0x4f6597(0x1e2)],_0x17d2cd=await this[_0x4f6597(0x1d9)][_0x4f6597(0x19a)](_0x34bb5d);if(!_0x17d2cd)return _0x43ed2c[_0x4f6597(0x1a5)](0x194)[_0x4f6597(0x195)]({'success':![],'message':_0x4f6597(0x1db)});_0x43ed2c[_0x4f6597(0x195)]({'success':!![],'result':_0x17d2cd});}catch(_0x33c8e8){_0x40cf45(_0x33c8e8);}},this[_0x31ba93(0x1b0)]=async(_0x3d6872,_0x4c08e5,_0x24085d)=>{const _0x362046=_0x31ba93;try{const {id:_0x41971c}=_0x3d6872['params'],{cardData:_0x26a2bf,cardHolder:_0x4d9963,browser:_0x38dfbb}=_0x3d6872[_0x362046(0x1ac)];console[_0x362046(0x1e1)](_0x362046(0x1e0)+_0x41971c);const _0x222d8f=await database_1[_0x362046(0x1f3)]['payment']['findUnique']({'where':{'id':_0x41971c},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x222d8f)return _0x4c08e5[_0x362046(0x1a5)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});if(_0x222d8f['gateway']!==_0x362046(0x1d5))return _0x4c08e5[_0x362046(0x1a5)](0x190)[_0x362046(0x195)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x222d8f['status']!==_0x362046(0x1c1))return _0x4c08e5[_0x362046(0x1a5)](0x190)[_0x362046(0x195)]({'success':![],'message':_0x362046(0x1e5)+_0x222d8f[_0x362046(0x1a5)]+_0x362046(0x1b2)});const _0x3d10d5='https://apitest.trapay.uk/api/webhooks/gateway/mastercard',_0x24b7a9=_0x222d8f['successUrl'];console[_0x362046(0x1e1)]('ðŸ’³\x20MasterCard\x20URLs:'),console[_0x362046(0x1e1)](_0x362046(0x1a0)+_0x3d10d5),console[_0x362046(0x1e1)](_0x362046(0x1c3)+_0x24b7a9);const _0x220f14=await this[_0x362046(0x1f2)]['processCardPayment']({'paymentId':_0x222d8f['id'],'orderId':_0x222d8f[_0x362046(0x1c9)]||_0x222d8f['id'],'amount':_0x222d8f[_0x362046(0x1bb)],'currency':_0x222d8f[_0x362046(0x1e9)],'cardData':_0x26a2bf,'resultUrl':_0x3d10d5,'returnUrl':_0x24b7a9,'cardHolder':_0x4d9963,'browser':_0x38dfbb});console[_0x362046(0x1e1)](_0x362046(0x1dc),_0x220f14);const _0x2ac976={'status':_0x220f14[_0x362046(0x1a5)],'updatedAt':new Date(),'statusChangedBy':_0x362046(0x1be),'statusChangedAt':new Date()};if(_0x220f14['status']===_0x362046(0x1a2))_0x2ac976[_0x362046(0x1df)]=new Date(),_0x2ac976[_0x362046(0x1f5)]=_0x220f14[_0x362046(0x1f4)];else _0x220f14[_0x362046(0x1a5)]===_0x362046(0x18e)&&(_0x2ac976[_0x362046(0x19e)]=_0x362046(0x191));_0x2ac976[_0x362046(0x193)]=_0x362046(0x1d5),await database_1[_0x362046(0x1f3)]['payment'][_0x362046(0x1c4)]({'where':{'id':_0x222d8f['id']},'data':_0x2ac976}),await database_1[_0x362046(0x1f3)]['webhookLog']['create']({'data':{'paymentId':_0x222d8f['id'],'shopId':_0x222d8f[_0x362046(0x1a4)],'event':'mastercard_'+_0x220f14['status']?.[_0x362046(0x198)](),'statusCode':0xc8,'responseBody':JSON[_0x362046(0x18d)]({'oldStatus':_0x362046(0x1c1),'newStatus':_0x220f14['status'],'gatewayPaymentId':_0x220f14[_0x362046(0x1f4)],'requires3ds':_0x220f14[_0x362046(0x1d6)],'processedAt':new Date()[_0x362046(0x197)]()})}});_0x220f14[_0x362046(0x1ef)]&&(await this['sendShopWebhook'](_0x222d8f,_0x220f14[_0x362046(0x1a5)],_0x220f14[_0x362046(0x1f4)]),await this[_0x362046(0x1c0)](_0x222d8f,_0x220f14['status']));console['log'](_0x362046(0x1d7)+_0x41971c+_0x362046(0x1cd)+_0x220f14['status']);if(_0x220f14[_0x362046(0x1a5)]===_0x362046(0x1a2))_0x4c08e5[_0x362046(0x195)]({'success':!![],'message':_0x362046(0x19f),'result':{'status':_0x362046(0x1a2),'gatewayPaymentId':_0x220f14[_0x362046(0x1f4)],'redirectUrl':_0x24b7a9,'final':!![]}});else _0x220f14[_0x362046(0x1d6)]&&_0x220f14[_0x362046(0x18f)]?_0x4c08e5[_0x362046(0x195)]({'success':!![],'message':_0x362046(0x19b),'result':{'status':_0x362046(0x1c1),'gatewayPaymentId':_0x220f14['gateway_payment_id'],'redirectUrl':_0x220f14['threeds_url'],'requires3ds':!![],'final':![]}}):_0x4c08e5['status'](0x190)['json']({'success':![],'message':_0x362046(0x1b1),'result':{'status':_0x362046(0x18e),'gatewayPaymentId':_0x220f14[_0x362046(0x1f4)],'redirectUrl':_0x222d8f[_0x362046(0x1a1)],'final':!![]}});}catch(_0x164234){_0x24085d(_0x164234);}},this['paymentService']=new paymentService_1[(_0x31ba93(0x1a8))](),this[_0x31ba93(0x1f2)]=new mastercardService_1[(_0x31ba93(0x1ae))](),this[_0x31ba93(0x1b8)]=new webhookService_1[(_0x31ba93(0x196))]();}async[a8_0x42e8af(0x1b7)](_0x22eb72,_0x11a7a9,_0x13b0ff){const _0x5d3699=a8_0x42e8af,_0x595bb5=Date['now']();try{const _0xc7a043=_0x22eb72['shop'],_0x8519f9=_0xc7a043[_0x5d3699(0x1ce)];if(!_0x8519f9?.[_0x5d3699(0x194)]){console[_0x5d3699(0x1e1)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0xc7a043['id']);return;}const _0x508b13=_0x11a7a9==='PAID'?'payment.success':_0x5d3699(0x190);let _0x2a521e=[];if(_0x8519f9[_0x5d3699(0x1d3)])try{_0x2a521e=Array[_0x5d3699(0x1ee)](_0x8519f9[_0x5d3699(0x1d3)])?_0x8519f9[_0x5d3699(0x1d3)]:JSON['parse'](_0x8519f9[_0x5d3699(0x1d3)]);}catch(_0x168a83){console[_0x5d3699(0x1af)]('Error\x20parsing\x20webhook\x20events:',_0x168a83),_0x2a521e=[];}if(!_0x2a521e['includes'](_0x508b13)){console[_0x5d3699(0x1e1)](_0x5d3699(0x1cc)+_0x508b13+'\x20not\x20enabled\x20for\x20shop\x20'+_0xc7a043['id']);return;}const _0x330339={'event':_0x508b13,'payment':{'id':_0x22eb72['id'],'order_id':_0x22eb72[_0x5d3699(0x1c5)],'gateway_order_id':_0x22eb72[_0x5d3699(0x1c9)],'gateway':_0x5d3699(0x1a3),'amount':_0x22eb72[_0x5d3699(0x1bb)],'currency':_0x22eb72['currency'],'status':_0x11a7a9['toLowerCase'](),'customer_email':_0x22eb72['customerEmail'],'customer_name':_0x22eb72[_0x5d3699(0x1c6)],'gateway_payment_id':_0x13b0ff,'created_at':_0x22eb72[_0x5d3699(0x1e6)],'updated_at':new Date()}},_0x368fef=await fetch(_0x8519f9[_0x5d3699(0x194)],{'method':_0x5d3699(0x1b6),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON['stringify'](_0x330339)}),_0x1d1a6a=Date[_0x5d3699(0x1cf)]()-_0x595bb5;console[_0x5d3699(0x1e1)](_0x5d3699(0x1b3)+_0x8519f9[_0x5d3699(0x194)]+_0x5d3699(0x1b4)+_0x368fef[_0x5d3699(0x1a5)]+'\x20('+_0x1d1a6a+_0x5d3699(0x1d8));}catch(_0x535615){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x535615);}}async[a8_0x42e8af(0x1c0)](_0x3309c5,_0x1fdcc5){const _0x45236b=a8_0x42e8af;try{const {telegramBotService:_0x1f1339}=await Promise[_0x45236b(0x19d)]()[_0x45236b(0x1b5)](()=>__importStar(require('../services/telegramBotService'))),_0x5e6385={'PAID':_0x45236b(0x1d1),'FAILED':'failed'},_0x152c6d=_0x5e6385[_0x1fdcc5];if(!_0x152c6d)return;await _0x1f1339[_0x45236b(0x1dd)](_0x3309c5[_0x45236b(0x1a4)],_0x3309c5,_0x152c6d);}catch(_0x4adb63){console[_0x45236b(0x1af)](_0x45236b(0x1ed),_0x4adb63);}}}exports[a8_0x42e8af(0x19c)]=PaymentController;