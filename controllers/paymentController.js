'use strict';const a13_0x5c360b=a13_0x5842;(function(_0x23e01f,_0x468f86){const _0x5f490b=a13_0x5842,_0x3a53f5=_0x23e01f();while(!![]){try{const _0x3b3861=parseInt(_0x5f490b(0x218))/0x1*(-parseInt(_0x5f490b(0x204))/0x2)+-parseInt(_0x5f490b(0x22c))/0x3*(-parseInt(_0x5f490b(0x19c))/0x4)+parseInt(_0x5f490b(0x225))/0x5+parseInt(_0x5f490b(0x1d4))/0x6+parseInt(_0x5f490b(0x207))/0x7+-parseInt(_0x5f490b(0x1ae))/0x8*(parseInt(_0x5f490b(0x1dd))/0x9)+parseInt(_0x5f490b(0x17a))/0xa;if(_0x3b3861===_0x468f86)break;else _0x3a53f5['push'](_0x3a53f5['shift']());}catch(_0x40ce17){_0x3a53f5['push'](_0x3a53f5['shift']());}}}(a13_0x5445,0xc0bba));function a13_0x5842(_0x53c74b,_0x50e6ca){_0x53c74b=_0x53c74b-0x16b;const _0x544594=a13_0x5445();let _0x584219=_0x544594[_0x53c74b];return _0x584219;}var __createBinding=this&&this[a13_0x5c360b(0x1c1)]||(Object['create']?function(_0x168e2e,_0x57fa5d,_0x1983f0,_0x2bbddd){const _0x58c430=a13_0x5c360b;if(_0x2bbddd===undefined)_0x2bbddd=_0x1983f0;var _0x4cae42=Object[_0x58c430(0x19a)](_0x57fa5d,_0x1983f0);(!_0x4cae42||(_0x58c430(0x1e3)in _0x4cae42?!_0x57fa5d[_0x58c430(0x1d7)]:_0x4cae42['writable']||_0x4cae42[_0x58c430(0x1aa)]))&&(_0x4cae42={'enumerable':!![],'get':function(){return _0x57fa5d[_0x1983f0];}}),Object[_0x58c430(0x20e)](_0x168e2e,_0x2bbddd,_0x4cae42);}:function(_0x3ba702,_0xb0310a,_0x5424a3,_0x2ce8bb){if(_0x2ce8bb===undefined)_0x2ce8bb=_0x5424a3;_0x3ba702[_0x2ce8bb]=_0xb0310a[_0x5424a3];}),__setModuleDefault=this&&this[a13_0x5c360b(0x1a6)]||(Object['create']?function(_0x560700,_0x3d85c8){const _0x4953eb=a13_0x5c360b;Object[_0x4953eb(0x20e)](_0x560700,_0x4953eb(0x187),{'enumerable':!![],'value':_0x3d85c8});}:function(_0x429574,_0x392f7a){const _0x4bdc66=a13_0x5c360b;_0x429574[_0x4bdc66(0x187)]=_0x392f7a;}),__importStar=this&&this[a13_0x5c360b(0x1e0)]||(function(){var _0xdfb9d4=function(_0x28ca3c){const _0xe95887=a13_0x5842;return _0xdfb9d4=Object[_0xe95887(0x1f1)]||function(_0x5ebd0f){const _0x510d74=_0xe95887;var _0x2499d9=[];for(var _0x347b1f in _0x5ebd0f)if(Object[_0x510d74(0x208)][_0x510d74(0x22b)]['call'](_0x5ebd0f,_0x347b1f))_0x2499d9[_0x2499d9['length']]=_0x347b1f;return _0x2499d9;},_0xdfb9d4(_0x28ca3c);};return function(_0x13277b){const _0x40f84c=a13_0x5842;if(_0x13277b&&_0x13277b[_0x40f84c(0x1d7)])return _0x13277b;var _0xa58ff7={};if(_0x13277b!=null){for(var _0x4cec09=_0xdfb9d4(_0x13277b),_0x13575d=0x0;_0x13575d<_0x4cec09[_0x40f84c(0x1de)];_0x13575d++)if(_0x4cec09[_0x13575d]!=='default')__createBinding(_0xa58ff7,_0x13277b,_0x4cec09[_0x13575d]);}return __setModuleDefault(_0xa58ff7,_0x13277b),_0xa58ff7;};}()),__importDefault=this&&this['__importDefault']||function(_0x64492){const _0x4c758d=a13_0x5c360b;return _0x64492&&_0x64492[_0x4c758d(0x1d7)]?_0x64492:{'default':_0x64492};};Object[a13_0x5c360b(0x20e)](exports,a13_0x5c360b(0x1d7),{'value':!![]}),exports[a13_0x5c360b(0x205)]=void 0x0;const crypto_1=__importDefault(require('crypto')),paymentService_1=require('../services/paymentService'),mastercardService_1=require(a13_0x5c360b(0x1c0)),webhookService_1=require(a13_0x5c360b(0x21e)),currencyService_1=require('../services/currencyService'),binLookupService_1=require('../services/binLookupService'),database_1=__importDefault(require(a13_0x5c360b(0x182)));class PaymentController{constructor(){const _0xb4cf63=a13_0x5c360b;this[_0xb4cf63(0x1fa)]=async(_0x231e1e,_0x462be6,_0x21b588)=>{const _0x201139=_0xb4cf63;try{const _0x206680=_0x231e1e[_0x201139(0x183)],_0x562958=await this[_0x201139(0x222)][_0x201139(0x1fa)](_0x206680);_0x462be6[_0x201139(0x223)](0xc9)[_0x201139(0x1cd)]({'success':!![],'message':_0x201139(0x170),'result':_0x562958});}catch(_0x1d93b8){_0x21b588(_0x1d93b8);}},this[_0xb4cf63(0x219)]=async(_0x397635,_0x271544,_0x138110)=>{const _0x15130a=_0xb4cf63;try{const {id:_0x250158}=_0x397635['params'],_0x43e37e=await this[_0x15130a(0x222)]['getPaymentStatus'](_0x250158);if(!_0x43e37e)return _0x271544[_0x15130a(0x223)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x271544[_0x15130a(0x1cd)]({'success':!![],'result':_0x43e37e});}catch(_0x17a1f5){_0x138110(_0x17a1f5);}},this[_0xb4cf63(0x1ba)]=async(_0x499d7b,_0x3e450a,_0xc5f5f0)=>{const _0x4fb9d6=_0xb4cf63;try{const {id:_0xc81da5}=_0x499d7b['params'],{requestId:_0x3b9b9b}=_0x499d7b[_0x4fb9d6(0x1b8)];if(typeof _0x3b9b9b!==_0x4fb9d6(0x1b2))return _0x3e450a['status'](0x190)[_0x4fb9d6(0x1cd)]({'success':![],'message':_0x4fb9d6(0x1e6)});console['log'](_0x4fb9d6(0x185)+_0xc81da5+_0x4fb9d6(0x180)+_0x3b9b9b);const _0x4a6121=await this[_0x4fb9d6(0x222)][_0x4fb9d6(0x1ba)](_0xc81da5,_0x3b9b9b);if(!_0x4a6121)return _0x3e450a[_0x4fb9d6(0x223)](0x194)[_0x4fb9d6(0x1cd)]({'success':![],'message':_0x4fb9d6(0x1e8)});console['log'](_0x4fb9d6(0x176)+_0xc81da5+':',_0x4a6121),_0x3e450a[_0x4fb9d6(0x1cd)]({'success':!![],'result':_0x4a6121});}catch(_0x52f720){_0xc5f5f0(_0x52f720);}},this[_0xb4cf63(0x1fb)]=async(_0xae6802,_0x11970d,_0x22778e)=>{const _0xce7394=_0xb4cf63;try{const {id:_0x1c45a1}=_0xae6802[_0xce7394(0x1ad)],_0x1586e7=await this[_0xce7394(0x222)][_0xce7394(0x1fb)](_0x1c45a1);if(!_0x1586e7)return _0x11970d[_0xce7394(0x223)](0x194)[_0xce7394(0x1cd)]({'success':![],'message':'Payment\x20not\x20found'});_0x11970d[_0xce7394(0x1cd)]({'success':!![],'result':_0x1586e7});}catch(_0x49356f){_0x22778e(_0x49356f);}},this[_0xb4cf63(0x201)]=async(_0x4afbfc,_0xb51852,_0x34d2eb)=>{const _0x23bff1=_0xb4cf63;try{const {id:_0x44ac2f}=_0x4afbfc[_0x23bff1(0x1ad)],_0x2ce164=_0x4afbfc[_0x23bff1(0x183)];console['log'](_0x23bff1(0x1f2)+_0x44ac2f),console[_0x23bff1(0x1cb)]('üìù\x20Customer\x20data:',_0x2ce164);const _0x562169=await this['paymentService'][_0x23bff1(0x228)](_0x44ac2f,_0x2ce164);if(!_0x562169)return _0xb51852[_0x23bff1(0x223)](0x194)[_0x23bff1(0x1cd)]({'success':![],'message':_0x23bff1(0x206)});_0xb51852[_0x23bff1(0x1cd)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x562169['id'],'customerIp':_0x562169['customerIp'],'customerUa':_0x562169[_0x23bff1(0x1f6)],'customerCountry':_0x562169[_0x23bff1(0x22a)],'updatedAt':_0x562169['updatedAt']}});}catch(_0x4ab265){_0x34d2eb(_0x4ab265);}},this[_0xb4cf63(0x194)]=async(_0x327ad7,_0x35deac,_0x4936dc)=>{const _0x3614d0=_0xb4cf63;try{const {id:_0xc0956a}=_0x327ad7[_0x3614d0(0x1ad)],{cardData:_0x5a19b5,cardHolder:_0x1a57b5,browser:_0x253cb8}=_0x327ad7['body'];console[_0x3614d0(0x1cb)](_0x3614d0(0x215)+_0xc0956a),console[_0x3614d0(0x1cb)]('üí≥\x20Card\x20holder:\x20'+_0x1a57b5[_0x3614d0(0x1d1)]+'\x20'+_0x1a57b5[_0x3614d0(0x1ac)]+'\x20('+_0x1a57b5[_0x3614d0(0x179)]+')'),console[_0x3614d0(0x1cb)]('üí≥\x20Browser\x20IP:\x20'+_0x253cb8['ip']);const _0xe2f4ea=_0x1a57b5[_0x3614d0(0x1d1)]?.[_0x3614d0(0x199)](/[\t\n\r\f\v]/g,'\x20')[_0x3614d0(0x1a7)]()||'',_0x201d7f=_0x1a57b5['last_name']?.['replace'](/[\t\n\r\f\v]/g,'\x20')[_0x3614d0(0x1a7)]()||'';console[_0x3614d0(0x1cb)](_0x3614d0(0x1a9)),console[_0x3614d0(0x1cb)](_0x3614d0(0x175)+_0x1a57b5[_0x3614d0(0x1d1)]+_0x3614d0(0x1bc)+_0x1a57b5[_0x3614d0(0x1ac)]+'\x22'),console[_0x3614d0(0x1cb)](_0x3614d0(0x1b6)+_0xe2f4ea+_0x3614d0(0x1bc)+_0x201d7f+'\x22');const _0x54d6ef={'customerName':_0xe2f4ea+'\x20'+_0x201d7f,'customerEmail':_0x1a57b5[_0x3614d0(0x179)],'customerPhone':_0x1a57b5[_0x3614d0(0x16e)]||null,'customerIp':_0x253cb8['ip'],'customerUa':_0x253cb8['user_agent']},_0x288b16=[_0x1a57b5['address_line_1'],_0x1a57b5['address_line_2']][_0x3614d0(0x21b)](Boolean);_0x54d6ef[_0x3614d0(0x1ef)]=_0x288b16['join'](',\x20')||null,_0x54d6ef[_0x3614d0(0x1ff)]=_0x1a57b5[_0x3614d0(0x224)]||null,_0x54d6ef[_0x3614d0(0x1c7)]=_0x1a57b5[_0x3614d0(0x1d6)]||null,_0x54d6ef[_0x3614d0(0x16f)]=_0x1a57b5['post_code']||_0x1a57b5['postcode']||null,console[_0x3614d0(0x1cb)](_0x3614d0(0x200),_0x54d6ef['billingAddress']),console['log'](_0x3614d0(0x16c),_0x5a19b5[_0x3614d0(0x178)][_0x3614d0(0x1a3)](0x0,0x6)+_0x3614d0(0x1c8));const _0x219da5=await binLookupService_1[_0x3614d0(0x18b)]['lookupBin'](_0x5a19b5[_0x3614d0(0x178)]);console[_0x3614d0(0x1cb)](_0x3614d0(0x1e1),_0x219da5);const _0x53399c=_0x5a19b5[_0x3614d0(0x178)][_0x3614d0(0x1a3)](0x0,0x8),_0x5c1ed4=await database_1['default'][_0x3614d0(0x18a)]['findUnique']({'where':{'id':_0xc0956a},'include':{'shop':{'select':{'id':!![],'name':!![],'secretKey':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5c1ed4)return _0x35deac[_0x3614d0(0x223)](0x194)[_0x3614d0(0x1cd)]({'success':![],'message':_0x3614d0(0x206)});if(_0x5c1ed4[_0x3614d0(0x198)]!==_0x3614d0(0x17d))return console[_0x3614d0(0x1cb)](_0x3614d0(0x1d8)+_0x5c1ed4[_0x3614d0(0x198)]+'\x27'),_0x35deac[_0x3614d0(0x223)](0x190)['json']({'success':![],'message':_0x3614d0(0x1bd)});if(_0x5c1ed4['status']!=='PENDING')return _0x35deac[_0x3614d0(0x223)](0x190)[_0x3614d0(0x1cd)]({'success':![],'message':_0x3614d0(0x188)+_0x5c1ed4[_0x3614d0(0x223)]+_0x3614d0(0x1c3)});await database_1[_0x3614d0(0x187)][_0x3614d0(0x18a)][_0x3614d0(0x1e2)]({'where':{'id':_0xc0956a},'data':{..._0x54d6ef,'cardBin':_0x53399c,'cardBinStatus':_0x219da5[_0x3614d0(0x190)],'cardType':_0x219da5['cardType'],'cardCategory':_0x219da5['cardCategory'],'cardCountry':_0x219da5[_0x3614d0(0x1cf)],'cardIssuer':_0x219da5[_0x3614d0(0x1d9)],'updatedAt':new Date()}}),console[_0x3614d0(0x1cb)](_0x3614d0(0x1d3));const _0x5670cc=_0x5a19b5[_0x3614d0(0x178)][_0x3614d0(0x199)](/[\s-]/g,''),_0x517449=_0x5670cc[_0x3614d0(0x1e9)]('4')?_0x3614d0(0x213):_0x3614d0(0x1d5),_0x2bab31=_0x5670cc[_0x3614d0(0x1e9)]('4')?_0x3614d0(0x184):_0x3614d0(0x1b1),_0x2bee7b=_0x3614d0(0x1b7)+_0x517449,_0x591c2d='https://app.trapay.uk/payment/pending?id='+_0x5c1ed4['id']+'&payment_id='+_0x5c1ed4[_0x3614d0(0x1ec)];console[_0x3614d0(0x1cb)](_0x3614d0(0x20a)+_0x517449['toUpperCase']()+'\x20URLs:'),console[_0x3614d0(0x1cb)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x2bee7b),console[_0x3614d0(0x1cb)](_0x3614d0(0x212)+_0x591c2d);const _0x3e30ab={'first_name':_0x1a57b5[_0x3614d0(0x1d1)],'last_name':_0x1a57b5[_0x3614d0(0x1ac)],'email':_0x1a57b5[_0x3614d0(0x179)]},_0x44873f=await this[_0x3614d0(0x1bb)][_0x3614d0(0x18e)]({'paymentId':_0x5c1ed4['id'],'orderId':_0x5c1ed4[_0x3614d0(0x1ec)]||_0x5c1ed4['id'],'amount':_0x5c1ed4['amount'],'currency':_0x5c1ed4[_0x3614d0(0x210)],'cardData':_0x5a19b5,'resultUrl':_0x2bee7b,'returnUrl':_0x591c2d,'cardHolder':_0x3e30ab,'browser':_0x253cb8});console[_0x3614d0(0x1cb)](_0x3614d0(0x16d),_0x44873f);const _0x1e13b3={'status':_0x44873f['status'],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};_0x44873f[_0x3614d0(0x1ab)]&&(_0x1e13b3[_0x3614d0(0x217)]=_0x44873f[_0x3614d0(0x1ab)],console['log'](_0x3614d0(0x1f9)+_0x44873f[_0x3614d0(0x1ab)]));if(_0x44873f[_0x3614d0(0x223)]===_0x3614d0(0x18c)){_0x1e13b3[_0x3614d0(0x19f)]=new Date();const _0x4778f3=await this[_0x3614d0(0x1a1)][_0x3614d0(0x226)](_0x5c1ed4[_0x3614d0(0x1fe)],_0x5c1ed4[_0x3614d0(0x210)]),_0x501874=await this[_0x3614d0(0x21c)][_0x3614d0(0x20b)](_0x5c1ed4[_0x3614d0(0x1dc)],_0x5c1ed4[_0x3614d0(0x198)]),_0x52ffb0=_0x4778f3*(0x1-_0x501874/0x64);_0x1e13b3[_0x3614d0(0x229)]=_0x4778f3,_0x1e13b3[_0x3614d0(0x189)]=_0x52ffb0,_0x1e13b3[_0x3614d0(0x192)]=_0x501874,console[_0x3614d0(0x1cb)](_0x3614d0(0x18d)+_0x5c1ed4[_0x3614d0(0x1fe)]+'\x20'+_0x5c1ed4[_0x3614d0(0x210)]+'\x20->\x20'+_0x4778f3['toFixed'](0x6)+'\x20USDT'),console[_0x3614d0(0x1cb)](_0x3614d0(0x19b)+_0x5c1ed4[_0x3614d0(0x198)]+_0x3614d0(0x1be)+_0x501874+'%'),console['log'](_0x3614d0(0x1ed)+_0x52ffb0[_0x3614d0(0x1c5)](0x6)+_0x3614d0(0x1a8));}else _0x44873f['status']==='FAILED'&&(_0x1e13b3['failureMessage']=_0x44873f[_0x3614d0(0x20f)]||_0x3614d0(0x214),console[_0x3614d0(0x1cb)]('‚ùå\x20Payment\x20failed\x20with\x20message:\x20'+_0x1e13b3[_0x3614d0(0x1f3)]));_0x1e13b3[_0x3614d0(0x1f4)]=_0x3614d0(0x221);if(_0x5a19b5[_0x3614d0(0x178)]){const _0x57b42a=_0x5a19b5[_0x3614d0(0x178)]['replace'](/[\s-]/g,'');_0x1e13b3[_0x3614d0(0x17f)]=_0x57b42a[_0x3614d0(0x19e)](-0x4),_0x1e13b3['cardBrand']=_0x2bab31,console[_0x3614d0(0x1cb)](_0x3614d0(0x191)+_0x1e13b3[_0x3614d0(0x17f)]),console[_0x3614d0(0x1cb)](_0x3614d0(0x1b3)+_0x2bab31);}await database_1[_0x3614d0(0x187)]['payment'][_0x3614d0(0x1e2)]({'where':{'id':_0x5c1ed4['id']},'data':_0x1e13b3});_0x44873f[_0x3614d0(0x223)]===_0x3614d0(0x18c)&&(await this[_0x3614d0(0x21c)][_0x3614d0(0x1d0)](_0x5c1ed4['id'],_0x3614d0(0x18c)),console[_0x3614d0(0x1cb)](_0x3614d0(0x209)+_0x5c1ed4['id']));await database_1['default'][_0x3614d0(0x1f5)][_0x3614d0(0x216)]({'data':{'paymentId':_0x5c1ed4['id'],'shopId':_0x5c1ed4['shopId'],'event':_0x517449+'_'+_0x44873f['status']?.[_0x3614d0(0x1ea)](),'statusCode':0xc8,'responseBody':JSON[_0x3614d0(0x17c)]({'oldStatus':_0x3614d0(0x1c9),'newStatus':_0x44873f[_0x3614d0(0x223)],'gatewayPaymentId':_0x44873f['gateway_payment_id'],'requires3ds':_0x44873f[_0x3614d0(0x1fc)],'cardType':_0x517449[_0x3614d0(0x1ce)](),'processedAt':new Date()[_0x3614d0(0x1bf)]()})}});if(_0x44873f[_0x3614d0(0x21d)]){await this[_0x3614d0(0x1c6)](_0x5c1ed4,_0x44873f['status'],_0x44873f[_0x3614d0(0x1ab)],_0x517449),await this[_0x3614d0(0x1da)](_0x5c1ed4,_0x44873f['status']);if(_0x44873f[_0x3614d0(0x223)]===_0x3614d0(0x18c)){console[_0x3614d0(0x1cb)]('üìà\x20'+_0x517449[_0x3614d0(0x1ce)]()+_0x3614d0(0x181)+_0xc0956a+_0x3614d0(0x1fd));try{const {PaymentLinkService:_0x177bb1}=await Promise[_0x3614d0(0x19d)]()[_0x3614d0(0x1ca)](()=>__importStar(require('../services/paymentLinkService'))),_0x2ebafb=new _0x177bb1();await _0x2ebafb[_0x3614d0(0x1f0)](_0xc0956a),console[_0x3614d0(0x1cb)](_0x3614d0(0x197)+_0x517449[_0x3614d0(0x1ce)]()+_0x3614d0(0x181)+_0xc0956a);}catch(_0x46b849){console[_0x3614d0(0x203)](_0x3614d0(0x195)+_0x517449[_0x3614d0(0x1ce)]()+_0x3614d0(0x174),_0x46b849);}}}console['log']('‚úÖ\x20'+_0x517449[_0x3614d0(0x1ce)]()+_0x3614d0(0x181)+_0xc0956a+_0x3614d0(0x1a2)+_0x44873f[_0x3614d0(0x223)]);if(_0x44873f[_0x3614d0(0x223)]===_0x3614d0(0x18c))_0x35deac[_0x3614d0(0x1cd)]({'success':!![],'message':_0x3614d0(0x196),'result':{'status':_0x3614d0(0x18c),'gatewayPaymentId':_0x44873f[_0x3614d0(0x1ab)],'redirectUrl':_0x591c2d,'final':!![]}});else _0x44873f[_0x3614d0(0x1fc)]&&_0x44873f[_0x3614d0(0x1f7)]?_0x35deac[_0x3614d0(0x1cd)]({'success':!![],'message':_0x3614d0(0x177),'result':{'status':_0x3614d0(0x1c9),'gatewayPaymentId':_0x44873f[_0x3614d0(0x1ab)],'redirectUrl':_0x44873f[_0x3614d0(0x1f7)],'requires3ds':!![],'final':![]}}):_0x35deac[_0x3614d0(0x223)](0x190)[_0x3614d0(0x1cd)]({'success':![],'message':_0x3614d0(0x1db),'result':{'status':'FAILED','gatewayPaymentId':_0x44873f[_0x3614d0(0x1ab)],'redirectUrl':_0x5c1ed4[_0x3614d0(0x17e)],'final':!![]}});}catch(_0x485cec){_0x4936dc(_0x485cec);}},this['paymentService']=new paymentService_1[(_0xb4cf63(0x173))](),this[_0xb4cf63(0x1bb)]=new mastercardService_1[(_0xb4cf63(0x20d))](),this[_0xb4cf63(0x21c)]=new webhookService_1['WebhookService'](),this['currencyService']=new currencyService_1[(_0xb4cf63(0x21a))]();}async[a13_0x5c360b(0x1c6)](_0x165a8c,_0x21b7f3,_0x1b2331,_0x604393){const _0x473560=a13_0x5c360b,_0x52e517=Date[_0x473560(0x193)]();try{const _0x4df8ce=_0x165a8c[_0x473560(0x211)],_0x467dce=_0x4df8ce[_0x473560(0x17b)];if(!_0x467dce?.['webhookUrl']){console[_0x473560(0x1cb)](_0x473560(0x1af)+_0x4df8ce['id']);return;}const _0x30f881=_0x21b7f3===_0x473560(0x18c)?_0x473560(0x1cc):_0x473560(0x20c);let _0x3711cc=[];if(_0x467dce['webhookEvents'])try{_0x3711cc=Array['isArray'](_0x467dce[_0x473560(0x1c2)])?_0x467dce['webhookEvents']:JSON['parse'](_0x467dce['webhookEvents']);}catch(_0x49ddc4){console[_0x473560(0x203)](_0x473560(0x1e7),_0x49ddc4),_0x3711cc=[];}if(!_0x3711cc[_0x473560(0x21f)](_0x30f881)){console['log'](_0x473560(0x1f8)+_0x30f881+'\x20not\x20enabled\x20for\x20shop\x20'+_0x4df8ce['id']);return;}const _0x2a5a2d={'event':_0x30f881,'payment':{'id':_0x165a8c['id'],'order_id':_0x165a8c[_0x473560(0x220)],'gateway_order_id':_0x165a8c[_0x473560(0x1ec)],'gateway':_0x473560(0x1eb),'card_type':_0x604393?.[_0x473560(0x1ce)]()||_0x473560(0x1a0),'amount':_0x165a8c[_0x473560(0x1fe)],'currency':_0x165a8c[_0x473560(0x210)],'status':_0x21b7f3[_0x473560(0x1ea)](),'customer_email':_0x165a8c[_0x473560(0x227)],'customer_name':_0x165a8c['customerName'],'gateway_payment_id':_0x1b2331,'created_at':_0x165a8c[_0x473560(0x1e5)],'updated_at':new Date()}},_0x1a5333=JSON[_0x473560(0x17c)](_0x2a5a2d),_0x1d0cb1=crypto_1[_0x473560(0x187)][_0x473560(0x1e4)](_0x473560(0x18f),_0x4df8ce[_0x473560(0x1b5)])['update'](_0x1a5333)['digest'](_0x473560(0x1ee)),_0x14e2d6=await fetch(_0x467dce[_0x473560(0x1b9)],{'method':_0x473560(0x1b4),'headers':{'Content-Type':_0x473560(0x1a4),'User-Agent':'Payment\x20System/1.0\x20('+(_0x604393?.[_0x473560(0x1ce)]()||'VISA/MasterCard')+')','X-Webhook-Signature':_0x1d0cb1},'body':_0x1a5333}),_0x1110c7=Date['now']()-_0x52e517;console[_0x473560(0x1cb)]((_0x604393?.[_0x473560(0x1ce)]()||_0x473560(0x172))+_0x473560(0x186)+_0x467dce[_0x473560(0x1b9)]+_0x473560(0x202)+_0x14e2d6[_0x473560(0x223)]+'\x20('+_0x1110c7+'ms)');}catch(_0x2b6251){console['error'](_0x473560(0x1c4)+(_0x604393?.[_0x473560(0x1ce)]()||_0x473560(0x172))+_0x473560(0x16b),_0x2b6251);}}async[a13_0x5c360b(0x1da)](_0x4a6423,_0x4057a4){const _0x2b4589=a13_0x5c360b;try{const {telegramBotService:_0x2b2299}=await Promise[_0x2b4589(0x19d)]()[_0x2b4589(0x1ca)](()=>__importStar(require(_0x2b4589(0x1d2)))),_0x5e79d1={'PAID':_0x2b4589(0x1b0),'FAILED':_0x2b4589(0x1a5)},_0x503381=_0x5e79d1[_0x4057a4];if(!_0x503381)return;await _0x2b2299[_0x2b4589(0x171)](_0x4a6423[_0x2b4589(0x1dc)],_0x4a6423,_0x503381);}catch(_0x2a7b1a){console[_0x2b4589(0x203)](_0x2b4589(0x1df),_0x2a7b1a);}}}exports['PaymentController']=PaymentController;function a13_0x5445(){const _0x54fa85=['toISOString','../services/gateways/mastercardService','__createBinding','webhookEvents',',\x20cannot\x20process','Failed\x20to\x20send\x20','toFixed','sendShopWebhook','billingState','******','PENDING','then','log','payment.success','json','toUpperCase','cardCountry','updatePaymentStatus','first_name','../services/telegramBotService','‚úÖ\x20Payment\x20updated\x20with\x20customer\x20data\x20and\x20BIN\x20info','5691918HAzilL','mastercard','state','__esModule','‚ùå\x20Payment\x20gateway\x20mismatch:\x20expected\x20\x27visa/mastercard\x27,\x20got\x20\x27','cardIssuer','sendPaymentStatusNotification','Payment\x20failed','shopId','4883526wGlGAT','length','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','__importStar','üìä\x20BIN\x20lookup\x20result:','update','get','createHmac','createdAt','requestId\x20query\x20parameter\x20is\x20required\x20and\x20must\x20be\x20a\x20string','Error\x20parsing\x20webhook\x20events:','Payment\x20not\x20found\x20or\x20fingerprint\x20not\x20available','startsWith','toLowerCase','1111','gatewayOrderId','üí∞\x20Amount\x20after\x20gateway\x20commission:\x20','hex','billingAddress','handleSuccessfulPayment','getOwnPropertyNames','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','failureMessage','paymentMethod','webhookLog','customerUa','threeds_url','Webhook\x20event\x20','üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20','createPublicPayment','getPaymentById','requires_3ds','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','amount','billingCity','üìç\x20Billing\x20address\x20(string):','updatePaymentCustomer','\x20with\x20status\x20','error','74NchwIY','PaymentController','Payment\x20not\x20found','1014195HQNnYY','prototype','üí∞\x20Updated\x20merchant\x20balance\x20for\x20payment\x20','üí≥\x20','getGatewayCommission','payment.failed','VisaMasterCardService','defineProperty','errorMessage','currency','shop','\x20\x20\x20Return\x20URL:\x20','visa','Card\x20payment\x20failed','üí≥\x20Processing\x20MasterCard\x20payment:\x20','create','gatewayPaymentId','34327iQEJKS','getPaymentStatus','CurrencyService','filter','webhookService','final','../services/webhookService','includes','orderId','Bank\x20Card','paymentService','status','city','4966720LKYlUW','convertToUSDT','customerEmail','updatePaymentCustomerDataPublic','amountUSDT','customerCountry','hasOwnProperty','510guxQyp','\x20webhook:','üîç\x20Looking\x20up\x20BIN\x20for\x20card:','üí≥\x20MasterCard\x20result:','phone','billingZip','Payment\x20created\x20successfully','sendPaymentNotification','VISA/MasterCard','PaymentService','\x20payment:','\x20\x20Original:\x20\x22','‚úÖ\x20Fingerprint\x20data\x20retrieved\x20for\x20payment\x20','3DS\x20verification\x20required','number','email','5976890CpEFHR','settings','stringify','visa/mastercard','failUrl','cardLast4','\x20with\x20requestId\x20','\x20payment\x20','../config/database','body','VISA','üîç\x20Received\x20fingerprint\x20request\x20for\x20payment\x20','\x20webhook\x20sent\x20to\x20','default','Payment\x20status\x20is\x20','amountAfterGatewayCommissionUSDT','payment','binLookupService','PAID','üí∞\x20Converting\x20','processCardPayment','sha256','cardBinStatus','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','gatewayCommissionRate','now','processMasterCardPayment','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20','Payment\x20processed\x20successfully','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20','gateway','replace','getOwnPropertyDescriptor','üí∞\x20Gateway\x20','10828wofEsF','resolve','slice','paidAt','UNKNOWN','currencyService','\x20processed:\x20','substring','application/json','failed','__setModuleDefault','trim','\x20USDT','üßπ\x20Customer\x20names\x20cleaned:','configurable','gateway_payment_id','last_name','params','16DVFhTe','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','paid','MASTERCARD','string','üí≥\x20Saving\x20card\x20brand:\x20','POST','secretKey','\x20\x20Cleaned:\x20\x20\x22','https://api.trapay.uk/api/webhooks/gateway/','query','webhookUrl','getPaymentFingerprint','visaMasterCardService','\x22\x20|\x20\x22','Payment\x20is\x20not\x20for\x20VISA/MasterCard\x20gateway','\x20commission:\x20'];a13_0x5445=function(){return _0x54fa85;};return a13_0x5445();}