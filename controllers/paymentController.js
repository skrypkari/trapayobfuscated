'use strict';const a8_0x318294=a8_0x338e;(function(_0x2f23b9,_0x1943b3){const _0x303b26=a8_0x338e,_0x1971fe=_0x2f23b9();while(!![]){try{const _0x142010=-parseInt(_0x303b26(0x1d8))/0x1*(-parseInt(_0x303b26(0x178))/0x2)+parseInt(_0x303b26(0x1ae))/0x3+-parseInt(_0x303b26(0x1d7))/0x4+parseInt(_0x303b26(0x188))/0x5*(parseInt(_0x303b26(0x1a9))/0x6)+-parseInt(_0x303b26(0x191))/0x7*(-parseInt(_0x303b26(0x18e))/0x8)+parseInt(_0x303b26(0x1d4))/0x9+-parseInt(_0x303b26(0x1a1))/0xa*(-parseInt(_0x303b26(0x17f))/0xb);if(_0x142010===_0x1943b3)break;else _0x1971fe['push'](_0x1971fe['shift']());}catch(_0x2697d8){_0x1971fe['push'](_0x1971fe['shift']());}}}(a8_0x33e2,0xca54d));function a8_0x33e2(){const _0x4dcbac=['webhookUrl','isArray','updatePaymentCustomerDataPublic','updatedAt','now','PAID','💳\x20MasterCard\x20result:','PaymentService','Error\x20parsing\x20webhook\x20events:','threeds_url','Payment\x20processed\x20successfully','includes','Payment\x20not\x20found','POST','customerName','__importDefault','MasterCardService','Failed\x20to\x20send\x20MasterCard\x20webhook:','params','customerEmail','payment','getPaymentStatus','system','payment.failed','WebhookService','amount','customerCountry','Payment\x20status\x20is\x20','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','sendPaymentStatusNotification','defineProperty','2268594gvpfFI','shopId','failureMessage','3745600DbycZW','5qMjGcm','resolve','\x20\x20\x20Return\x20URL:\x20','processMasterCardPayment','failUrl','orderId','createPublicPayment','PaymentController','gateway','\x20with\x20status\x20','../services/paymentService','paidAt','settings','configurable','customerUa','getPaymentById','40742EZXDss','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','sendShopWebhook','processCardPayment','body','stringify','updatePaymentCustomer','10396661hTYJTd','gateway_payment_id','update','1111','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','parse','../services/telegramBotService','currency','default','5KNaYsq','__esModule','gatewayOrderId','customerIp','call','get','343072iGPCVl','payment.success','webhookLog','42akxSmS','create','json','\x20processed:\x20','log','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','createdAt','sendPaymentNotification','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','../services/gateways/mastercardService','webhookEvents','getOwnPropertyNames','mastercard','../config/database','MasterCard\x20webhook\x20sent\x20to\x20','FAILED','10XSPlIK','3DS\x20verification\x20required','application/json','prototype','__createBinding','failed','status','Webhook\x20event\x20','198294otbnfE','shop','✅\x20MasterCard\x20payment\x20','length','final','527172BgHjJF','then','PENDING','paid','ms)','paymentService','findUnique'];a8_0x33e2=function(){return _0x4dcbac;};return a8_0x33e2();}function a8_0x338e(_0xf2e3bb,_0x2e6a29){const _0x33e2d2=a8_0x33e2();return a8_0x338e=function(_0x338e8b,_0x4caf59){_0x338e8b=_0x338e8b-0x16d;let _0x1ce45d=_0x33e2d2[_0x338e8b];return _0x1ce45d;},a8_0x338e(_0xf2e3bb,_0x2e6a29);}var __createBinding=this&&this[a8_0x318294(0x1a5)]||(Object[a8_0x318294(0x192)]?function(_0x3c5703,_0x5cd8f8,_0x167527,_0x5ecc69){const _0x41ae3f=a8_0x318294;if(_0x5ecc69===undefined)_0x5ecc69=_0x167527;var _0x57fd62=Object['getOwnPropertyDescriptor'](_0x5cd8f8,_0x167527);(!_0x57fd62||(_0x41ae3f(0x18d)in _0x57fd62?!_0x5cd8f8[_0x41ae3f(0x189)]:_0x57fd62['writable']||_0x57fd62[_0x41ae3f(0x175)]))&&(_0x57fd62={'enumerable':!![],'get':function(){return _0x5cd8f8[_0x167527];}}),Object['defineProperty'](_0x3c5703,_0x5ecc69,_0x57fd62);}:function(_0xddda74,_0x4791a7,_0x16a99f,_0x99abe6){if(_0x99abe6===undefined)_0x99abe6=_0x16a99f;_0xddda74[_0x99abe6]=_0x4791a7[_0x16a99f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5b3297,_0x38d374){const _0x37a266=a8_0x318294;Object[_0x37a266(0x1d3)](_0x5b3297,_0x37a266(0x187),{'enumerable':!![],'value':_0x38d374});}:function(_0x533279,_0x5b662d){const _0x2b2e5a=a8_0x318294;_0x533279[_0x2b2e5a(0x187)]=_0x5b662d;}),__importStar=this&&this['__importStar']||(function(){var _0x3070da=function(_0x5f1074){const _0x3be6ad=a8_0x338e;return _0x3070da=Object[_0x3be6ad(0x19c)]||function(_0x1dbd43){const _0x2d8249=_0x3be6ad;var _0x1521e8=[];for(var _0x293ae0 in _0x1dbd43)if(Object[_0x2d8249(0x1a4)]['hasOwnProperty'][_0x2d8249(0x18c)](_0x1dbd43,_0x293ae0))_0x1521e8[_0x1521e8['length']]=_0x293ae0;return _0x1521e8;},_0x3070da(_0x5f1074);};return function(_0x4f9dd4){const _0x50126d=a8_0x338e;if(_0x4f9dd4&&_0x4f9dd4[_0x50126d(0x189)])return _0x4f9dd4;var _0x91177c={};if(_0x4f9dd4!=null){for(var _0x39e51d=_0x3070da(_0x4f9dd4),_0x55f59f=0x0;_0x55f59f<_0x39e51d[_0x50126d(0x1ac)];_0x55f59f++)if(_0x39e51d[_0x55f59f]!==_0x50126d(0x187))__createBinding(_0x91177c,_0x4f9dd4,_0x39e51d[_0x55f59f]);}return __setModuleDefault(_0x91177c,_0x4f9dd4),_0x91177c;};}()),__importDefault=this&&this[a8_0x318294(0x1c4)]||function(_0x5c30b8){return _0x5c30b8&&_0x5c30b8['__esModule']?_0x5c30b8:{'default':_0x5c30b8};};Object[a8_0x318294(0x1d3)](exports,'__esModule',{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0x318294(0x172)),mastercardService_1=require(a8_0x318294(0x19a)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x318294(0x19e)));class PaymentController{constructor(){const _0x25173f=a8_0x318294;this[_0x25173f(0x16e)]=async(_0x2e9233,_0x1f4263,_0x385eb8)=>{const _0x20aa15=_0x25173f;try{const _0x245391=_0x2e9233[_0x20aa15(0x17c)],_0x154a11=await this['paymentService']['createPublicPayment'](_0x245391);_0x1f4263['status'](0xc9)[_0x20aa15(0x193)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x154a11});}catch(_0x4eb151){_0x385eb8(_0x4eb151);}},this[_0x25173f(0x1ca)]=async(_0x5f2ab7,_0x5db492,_0x1479cd)=>{const _0x6dfba0=_0x25173f;try{const {id:_0x985402}=_0x5f2ab7[_0x6dfba0(0x1c7)],_0x3c0869=await this['paymentService']['getPaymentStatus'](_0x985402);if(!_0x3c0869)return _0x5db492[_0x6dfba0(0x1a7)](0x194)['json']({'success':![],'message':_0x6dfba0(0x1c1)});_0x5db492[_0x6dfba0(0x193)]({'success':!![],'result':_0x3c0869});}catch(_0x41b861){_0x1479cd(_0x41b861);}},this[_0x25173f(0x177)]=async(_0x58db95,_0x278898,_0xf6f16e)=>{const _0x22933f=_0x25173f;try{const {id:_0x2e528f}=_0x58db95[_0x22933f(0x1c7)],_0x3660ff=await this['paymentService'][_0x22933f(0x177)](_0x2e528f);if(!_0x3660ff)return _0x278898['status'](0x194)[_0x22933f(0x193)]({'success':![],'message':_0x22933f(0x1c1)});_0x278898[_0x22933f(0x193)]({'success':!![],'result':_0x3660ff});}catch(_0x2b5cc8){_0xf6f16e(_0x2b5cc8);}},this[_0x25173f(0x17e)]=async(_0x182317,_0x16c5b0,_0x583c2c)=>{const _0x537938=_0x25173f;try{const {id:_0x5b872e}=_0x182317[_0x537938(0x1c7)],_0x51ec60=_0x182317['body'];console[_0x537938(0x195)](_0x537938(0x183)+_0x5b872e),console[_0x537938(0x195)]('📝\x20Customer\x20data:',_0x51ec60);const _0x4d86ad=await this[_0x537938(0x1b3)][_0x537938(0x1b7)](_0x5b872e,_0x51ec60);if(!_0x4d86ad)return _0x16c5b0[_0x537938(0x1a7)](0x194)['json']({'success':![],'message':_0x537938(0x1c1)});_0x16c5b0['json']({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x4d86ad['id'],'customerIp':_0x4d86ad[_0x537938(0x18b)],'customerUa':_0x4d86ad[_0x537938(0x176)],'customerCountry':_0x4d86ad[_0x537938(0x1cf)],'updatedAt':_0x4d86ad[_0x537938(0x1b8)]}});}catch(_0x4b2a98){_0x583c2c(_0x4b2a98);}},this[_0x25173f(0x1db)]=async(_0x1eaf9b,_0x593340,_0x7dfa27)=>{const _0x2932f2=_0x25173f;try{const {id:_0x29f55f}=_0x1eaf9b[_0x2932f2(0x1c7)],{cardData:_0x17a5a4,cardHolder:_0x1f9daf,browser:_0x2eb069}=_0x1eaf9b[_0x2932f2(0x17c)];console[_0x2932f2(0x195)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x29f55f);const _0x569c4c=await database_1[_0x2932f2(0x187)][_0x2932f2(0x1c9)][_0x2932f2(0x1b4)]({'where':{'id':_0x29f55f},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x569c4c)return _0x593340[_0x2932f2(0x1a7)](0x194)[_0x2932f2(0x193)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x569c4c[_0x2932f2(0x170)]!==_0x2932f2(0x19d))return _0x593340['status'](0x190)[_0x2932f2(0x193)]({'success':![],'message':_0x2932f2(0x1d1)});if(_0x569c4c[_0x2932f2(0x1a7)]!==_0x2932f2(0x1b0))return _0x593340[_0x2932f2(0x1a7)](0x190)[_0x2932f2(0x193)]({'success':![],'message':_0x2932f2(0x1d0)+_0x569c4c[_0x2932f2(0x1a7)]+',\x20cannot\x20process'});const _0x2ca328='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0xbeaffd=_0x569c4c['successUrl'];console[_0x2932f2(0x195)]('💳\x20MasterCard\x20URLs:'),console[_0x2932f2(0x195)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x2ca328),console[_0x2932f2(0x195)](_0x2932f2(0x1da)+_0xbeaffd);const _0x1147a8=await this['masterCardService'][_0x2932f2(0x17b)]({'paymentId':_0x569c4c['id'],'orderId':_0x569c4c[_0x2932f2(0x18a)]||_0x569c4c['id'],'amount':_0x569c4c[_0x2932f2(0x1ce)],'currency':_0x569c4c[_0x2932f2(0x186)],'cardData':_0x17a5a4,'resultUrl':_0x2ca328,'returnUrl':_0xbeaffd,'cardHolder':_0x1f9daf,'browser':_0x2eb069});console[_0x2932f2(0x195)](_0x2932f2(0x1bb),_0x1147a8);const _0x161730={'status':_0x1147a8[_0x2932f2(0x1a7)],'updatedAt':new Date(),'statusChangedBy':_0x2932f2(0x1cb),'statusChangedAt':new Date()};if(_0x1147a8['status']===_0x2932f2(0x1ba))_0x161730[_0x2932f2(0x173)]=new Date(),_0x161730['gatewayPaymentId']=_0x1147a8['gateway_payment_id'];else _0x1147a8[_0x2932f2(0x1a7)]==='FAILED'&&(_0x161730[_0x2932f2(0x1d6)]='Card\x20payment\x20failed');_0x161730['paymentMethod']=_0x2932f2(0x19d),await database_1[_0x2932f2(0x187)][_0x2932f2(0x1c9)][_0x2932f2(0x181)]({'where':{'id':_0x569c4c['id']},'data':_0x161730}),await database_1[_0x2932f2(0x187)][_0x2932f2(0x190)][_0x2932f2(0x192)]({'data':{'paymentId':_0x569c4c['id'],'shopId':_0x569c4c[_0x2932f2(0x1d5)],'event':'mastercard_'+_0x1147a8[_0x2932f2(0x1a7)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x2932f2(0x17d)]({'oldStatus':_0x2932f2(0x1b0),'newStatus':_0x1147a8[_0x2932f2(0x1a7)],'gatewayPaymentId':_0x1147a8[_0x2932f2(0x180)],'requires3ds':_0x1147a8['requires_3ds'],'processedAt':new Date()['toISOString']()})}});_0x1147a8[_0x2932f2(0x1ad)]&&(await this[_0x2932f2(0x17a)](_0x569c4c,_0x1147a8[_0x2932f2(0x1a7)],_0x1147a8[_0x2932f2(0x180)]),await this[_0x2932f2(0x1d2)](_0x569c4c,_0x1147a8[_0x2932f2(0x1a7)]));console['log'](_0x2932f2(0x1ab)+_0x29f55f+_0x2932f2(0x194)+_0x1147a8[_0x2932f2(0x1a7)]);if(_0x1147a8[_0x2932f2(0x1a7)]===_0x2932f2(0x1ba))_0x593340[_0x2932f2(0x193)]({'success':!![],'message':_0x2932f2(0x1bf),'result':{'status':_0x2932f2(0x1ba),'gatewayPaymentId':_0x1147a8[_0x2932f2(0x180)],'redirectUrl':_0xbeaffd,'final':!![]}});else _0x1147a8['requires_3ds']&&_0x1147a8[_0x2932f2(0x1be)]?_0x593340['json']({'success':!![],'message':_0x2932f2(0x1a2),'result':{'status':_0x2932f2(0x1b0),'gatewayPaymentId':_0x1147a8['gateway_payment_id'],'redirectUrl':_0x1147a8[_0x2932f2(0x1be)],'requires3ds':!![],'final':![]}}):_0x593340['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x2932f2(0x1a0),'gatewayPaymentId':_0x1147a8['gateway_payment_id'],'redirectUrl':_0x569c4c[_0x2932f2(0x1dc)],'final':!![]}});}catch(_0x129c0e){_0x7dfa27(_0x129c0e);}},this['paymentService']=new paymentService_1[(_0x25173f(0x1bc))](),this['masterCardService']=new mastercardService_1[(_0x25173f(0x1c5))](),this['webhookService']=new webhookService_1[(_0x25173f(0x1cd))]();}async[a8_0x318294(0x17a)](_0x183d29,_0x37588d,_0x405e78){const _0x17a491=a8_0x318294,_0x324b3a=Date['now']();try{const _0x3fafc8=_0x183d29[_0x17a491(0x1aa)],_0x5652eb=_0x3fafc8[_0x17a491(0x174)];if(!_0x5652eb?.['webhookUrl']){console[_0x17a491(0x195)](_0x17a491(0x196)+_0x3fafc8['id']);return;}const _0x419277=_0x37588d===_0x17a491(0x1ba)?_0x17a491(0x18f):_0x17a491(0x1cc);let _0x4a6274=[];if(_0x5652eb['webhookEvents'])try{_0x4a6274=Array[_0x17a491(0x1b6)](_0x5652eb['webhookEvents'])?_0x5652eb[_0x17a491(0x19b)]:JSON[_0x17a491(0x184)](_0x5652eb[_0x17a491(0x19b)]);}catch(_0x41534f){console['error'](_0x17a491(0x1bd),_0x41534f),_0x4a6274=[];}if(!_0x4a6274[_0x17a491(0x1c0)](_0x419277)){console[_0x17a491(0x195)](_0x17a491(0x1a8)+_0x419277+'\x20not\x20enabled\x20for\x20shop\x20'+_0x3fafc8['id']);return;}const _0x3be4a1={'event':_0x419277,'payment':{'id':_0x183d29['id'],'order_id':_0x183d29[_0x17a491(0x16d)],'gateway_order_id':_0x183d29[_0x17a491(0x18a)],'gateway':_0x17a491(0x182),'amount':_0x183d29[_0x17a491(0x1ce)],'currency':_0x183d29['currency'],'status':_0x37588d['toLowerCase'](),'customer_email':_0x183d29[_0x17a491(0x1c8)],'customer_name':_0x183d29[_0x17a491(0x1c3)],'gateway_payment_id':_0x405e78,'created_at':_0x183d29[_0x17a491(0x197)],'updated_at':new Date()}},_0x5490d1=await fetch(_0x5652eb[_0x17a491(0x1b5)],{'method':_0x17a491(0x1c2),'headers':{'Content-Type':_0x17a491(0x1a3),'User-Agent':_0x17a491(0x199)},'body':JSON[_0x17a491(0x17d)](_0x3be4a1)}),_0x5f488f=Date[_0x17a491(0x1b9)]()-_0x324b3a;console[_0x17a491(0x195)](_0x17a491(0x19f)+_0x5652eb['webhookUrl']+_0x17a491(0x171)+_0x5490d1[_0x17a491(0x1a7)]+'\x20('+_0x5f488f+_0x17a491(0x1b2));}catch(_0x43cd93){console['error'](_0x17a491(0x1c6),_0x43cd93);}}async['sendPaymentStatusNotification'](_0x51a836,_0x1a5082){const _0x274b07=a8_0x318294;try{const {telegramBotService:_0x4696eb}=await Promise[_0x274b07(0x1d9)]()[_0x274b07(0x1af)](()=>__importStar(require(_0x274b07(0x185)))),_0x145c53={'PAID':_0x274b07(0x1b1),'FAILED':_0x274b07(0x1a6)},_0x149a60=_0x145c53[_0x1a5082];if(!_0x149a60)return;await _0x4696eb[_0x274b07(0x198)](_0x51a836[_0x274b07(0x1d5)],_0x51a836,_0x149a60);}catch(_0x39f144){console['error'](_0x274b07(0x179),_0x39f144);}}}exports[a8_0x318294(0x16f)]=PaymentController;