'use strict';const a8_0x2b850d=a8_0x54a2;(function(_0x51f71a,_0x9d9dbe){const _0x8399d8=a8_0x54a2,_0x4f7de4=_0x51f71a();while(!![]){try{const _0xcf78be=-parseInt(_0x8399d8(0x141))/0x1+parseInt(_0x8399d8(0x156))/0x2+-parseInt(_0x8399d8(0x145))/0x3*(-parseInt(_0x8399d8(0x149))/0x4)+parseInt(_0x8399d8(0x171))/0x5+-parseInt(_0x8399d8(0x153))/0x6*(parseInt(_0x8399d8(0x14b))/0x7)+parseInt(_0x8399d8(0x127))/0x8+-parseInt(_0x8399d8(0x15e))/0x9;if(_0xcf78be===_0x9d9dbe)break;else _0x4f7de4['push'](_0x4f7de4['shift']());}catch(_0x471017){_0x4f7de4['push'](_0x4f7de4['shift']());}}}(a8_0x1550,0x68aff));function a8_0x54a2(_0x42854b,_0x13c4d0){const _0x1550fd=a8_0x1550();return a8_0x54a2=function(_0x54a268,_0x44c3e3){_0x54a268=_0x54a268-0x112;let _0x42d817=_0x1550fd[_0x54a268];return _0x42d817;},a8_0x54a2(_0x42854b,_0x13c4d0);}var __createBinding=this&&this[a8_0x2b850d(0x17b)]||(Object[a8_0x2b850d(0x129)]?function(_0x5e1567,_0x30e52b,_0x4316e8,_0x16abcc){const _0x3686c0=a8_0x2b850d;if(_0x16abcc===undefined)_0x16abcc=_0x4316e8;var _0xe3fdb0=Object[_0x3686c0(0x11e)](_0x30e52b,_0x4316e8);(!_0xe3fdb0||(_0x3686c0(0x126)in _0xe3fdb0?!_0x30e52b[_0x3686c0(0x15a)]:_0xe3fdb0[_0x3686c0(0x12a)]||_0xe3fdb0[_0x3686c0(0x163)]))&&(_0xe3fdb0={'enumerable':!![],'get':function(){return _0x30e52b[_0x4316e8];}}),Object[_0x3686c0(0x11b)](_0x5e1567,_0x16abcc,_0xe3fdb0);}:function(_0x38b131,_0x1e7efb,_0x3e8d4c,_0x24b2fd){if(_0x24b2fd===undefined)_0x24b2fd=_0x3e8d4c;_0x38b131[_0x24b2fd]=_0x1e7efb[_0x3e8d4c];}),__setModuleDefault=this&&this[a8_0x2b850d(0x130)]||(Object[a8_0x2b850d(0x129)]?function(_0x309c36,_0x561a57){const _0x146d77=a8_0x2b850d;Object[_0x146d77(0x11b)](_0x309c36,_0x146d77(0x12c),{'enumerable':!![],'value':_0x561a57});}:function(_0xe6fe9e,_0x18ce0d){const _0x48e446=a8_0x2b850d;_0xe6fe9e[_0x48e446(0x12c)]=_0x18ce0d;}),__importStar=this&&this['__importStar']||(function(){var _0x576101=function(_0x50cdf0){return _0x576101=Object['getOwnPropertyNames']||function(_0x40e593){const _0x3efd67=a8_0x54a2;var _0x33e281=[];for(var _0xaded7a in _0x40e593)if(Object[_0x3efd67(0x172)]['hasOwnProperty'][_0x3efd67(0x140)](_0x40e593,_0xaded7a))_0x33e281[_0x33e281[_0x3efd67(0x16b)]]=_0xaded7a;return _0x33e281;},_0x576101(_0x50cdf0);};return function(_0x39d62e){const _0x244594=a8_0x54a2;if(_0x39d62e&&_0x39d62e[_0x244594(0x15a)])return _0x39d62e;var _0x568f60={};if(_0x39d62e!=null){for(var _0x293f93=_0x576101(_0x39d62e),_0x306e14=0x0;_0x306e14<_0x293f93[_0x244594(0x16b)];_0x306e14++)if(_0x293f93[_0x306e14]!==_0x244594(0x12c))__createBinding(_0x568f60,_0x39d62e,_0x293f93[_0x306e14]);}return __setModuleDefault(_0x568f60,_0x39d62e),_0x568f60;};}()),__importDefault=this&&this[a8_0x2b850d(0x128)]||function(_0x3b5971){const _0x4ad610=a8_0x2b850d;return _0x3b5971&&_0x3b5971[_0x4ad610(0x15a)]?_0x3b5971:{'default':_0x3b5971};};function a8_0x1550(){const _0x3eda09=['json','update','gatewayOrderId','sendShopWebhook','18ODodtF','params','createdAt','255012YWsZZv','failUrl','shop','POST','__esModule','sendPaymentStatusNotification','customerEmail','\x20with\x20status\x20','12565611tzqkkX','stringify','log','application/json','system','configurable','PENDING','final','requires_3ds','status','payment.failed','Payment\x20failed','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','length','../services/paymentService','ðŸ’³\x20MasterCard\x20URLs:','getPaymentById',',\x20cannot\x20process','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','4217555YlSuAo','prototype','processCardPayment','amount','webhookEvents','Payment\x20processed\x20successfully','3DS\x20verification\x20required','getPaymentStatus','PaymentController','../services/webhookService','__createBinding','parse','processMasterCardPayment','shopId','Card\x20payment\x20failed','then','MasterCard\x20webhook\x20sent\x20to\x20','PaymentService','Payment\x20created\x20successfully','createPublicPayment','paymentMethod','defineProperty','masterCardService','body','getOwnPropertyDescriptor','https://api.trapay.uk/api/webhooks/gateway/mastercard','gateway','payment','MasterCardService','ðŸ’³\x20MasterCard\x20result:','\x20not\x20enabled\x20for\x20shop\x20','currency','get','6650824DefboN','__importDefault','create','writable','settings','default','error','FAILED','sendPaymentNotification','__setModuleDefault','mastercard_','toLowerCase','now','paidAt','paid','threeds_url','Payment\x20not\x20found','mastercard','gateway_payment_id','toISOString','ðŸ’³\x20Processing\x20MasterCard\x20payment:\x20','paymentService','\x20\x20\x20Return\x20URL:\x20','webhookLog','webhookUrl','call','676720JpiiZO','../config/database','customerName','gatewayPaymentId','77493vsddMJ','1111','includes','Payment\x20status\x20is\x20','124gHiaRJ','failed','236677sZnkIP','webhookService','PAID','../services/gateways/mastercardService'];a8_0x1550=function(){return _0x3eda09;};return a8_0x1550();}Object[a8_0x2b850d(0x11b)](exports,a8_0x2b850d(0x15a),{'value':!![]}),exports[a8_0x2b850d(0x179)]=void 0x0;const paymentService_1=require(a8_0x2b850d(0x16c)),mastercardService_1=require(a8_0x2b850d(0x14e)),webhookService_1=require(a8_0x2b850d(0x17a)),database_1=__importDefault(require(a8_0x2b850d(0x142)));class PaymentController{constructor(){const _0x25d8ba=a8_0x2b850d;this['createPublicPayment']=async(_0x3d3168,_0x12d657,_0x5b9e40)=>{const _0x411beb=a8_0x54a2;try{const _0x195f3b=_0x3d3168[_0x411beb(0x11d)],_0x11f722=await this[_0x411beb(0x13c)][_0x411beb(0x119)](_0x195f3b);_0x12d657[_0x411beb(0x167)](0xc9)['json']({'success':!![],'message':_0x411beb(0x118),'result':_0x11f722});}catch(_0x46c1d0){_0x5b9e40(_0x46c1d0);}},this[_0x25d8ba(0x178)]=async(_0x25e2b9,_0x42686d,_0x1d84d0)=>{const _0x7ec324=_0x25d8ba;try{const {id:_0x3df5bf}=_0x25e2b9[_0x7ec324(0x154)],_0x373d13=await this['paymentService']['getPaymentStatus'](_0x3df5bf);if(!_0x373d13)return _0x42686d['status'](0x194)[_0x7ec324(0x14f)]({'success':![],'message':_0x7ec324(0x137)});_0x42686d[_0x7ec324(0x14f)]({'success':!![],'result':_0x373d13});}catch(_0x18f667){_0x1d84d0(_0x18f667);}},this[_0x25d8ba(0x16e)]=async(_0x53c053,_0x5cc90f,_0x19e922)=>{const _0x4f518b=_0x25d8ba;try{const {id:_0x3e2ee0}=_0x53c053[_0x4f518b(0x154)],_0x4fe704=await this[_0x4f518b(0x13c)][_0x4f518b(0x16e)](_0x3e2ee0);if(!_0x4fe704)return _0x5cc90f[_0x4f518b(0x167)](0x194)[_0x4f518b(0x14f)]({'success':![],'message':_0x4f518b(0x137)});_0x5cc90f['json']({'success':!![],'result':_0x4fe704});}catch(_0x11c84b){_0x19e922(_0x11c84b);}},this[_0x25d8ba(0x112)]=async(_0x71d619,_0x256c48,_0x2f8b1d)=>{const _0x22e995=_0x25d8ba;try{const {id:_0xe15da7}=_0x71d619[_0x22e995(0x154)],{cardData:_0x5c1837,cardHolder:_0x5e1290,browser:_0x33afff}=_0x71d619[_0x22e995(0x11d)];console[_0x22e995(0x160)](_0x22e995(0x13b)+_0xe15da7);const _0x3982c1=await database_1['default']['payment']['findUnique']({'where':{'id':_0xe15da7},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3982c1)return _0x256c48['status'](0x194)['json']({'success':![],'message':_0x22e995(0x137)});if(_0x3982c1[_0x22e995(0x120)]!==_0x22e995(0x138))return _0x256c48['status'](0x190)[_0x22e995(0x14f)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x3982c1[_0x22e995(0x167)]!==_0x22e995(0x164))return _0x256c48[_0x22e995(0x167)](0x190)[_0x22e995(0x14f)]({'success':![],'message':_0x22e995(0x148)+_0x3982c1[_0x22e995(0x167)]+_0x22e995(0x16f)});const _0x398043=_0x22e995(0x11f),_0x543c9b=_0x3982c1['successUrl'];console[_0x22e995(0x160)](_0x22e995(0x16d)),console[_0x22e995(0x160)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0x398043),console[_0x22e995(0x160)](_0x22e995(0x13d)+_0x543c9b);const _0x45d5be=await this['masterCardService'][_0x22e995(0x173)]({'paymentId':_0x3982c1['id'],'orderId':_0x3982c1[_0x22e995(0x151)]||_0x3982c1['id'],'amount':_0x3982c1[_0x22e995(0x174)],'currency':_0x3982c1[_0x22e995(0x125)],'cardData':_0x5c1837,'resultUrl':_0x398043,'returnUrl':_0x543c9b,'cardHolder':_0x5e1290,'browser':_0x33afff});console[_0x22e995(0x160)](_0x22e995(0x123),_0x45d5be);const _0x4e5a5f={'status':_0x45d5be[_0x22e995(0x167)],'updatedAt':new Date(),'statusChangedBy':_0x22e995(0x162),'statusChangedAt':new Date()};if(_0x45d5be['status']===_0x22e995(0x14d))_0x4e5a5f[_0x22e995(0x134)]=new Date(),_0x4e5a5f[_0x22e995(0x144)]=_0x45d5be[_0x22e995(0x139)];else _0x45d5be['status']===_0x22e995(0x12e)&&(_0x4e5a5f['failureMessage']=_0x22e995(0x114));_0x4e5a5f[_0x22e995(0x11a)]='mastercard',await database_1[_0x22e995(0x12c)][_0x22e995(0x121)][_0x22e995(0x150)]({'where':{'id':_0x3982c1['id']},'data':_0x4e5a5f}),await database_1[_0x22e995(0x12c)][_0x22e995(0x13e)][_0x22e995(0x129)]({'data':{'paymentId':_0x3982c1['id'],'shopId':_0x3982c1[_0x22e995(0x113)],'event':_0x22e995(0x131)+_0x45d5be[_0x22e995(0x167)]?.[_0x22e995(0x132)](),'statusCode':0xc8,'responseBody':JSON['stringify']({'oldStatus':_0x22e995(0x164),'newStatus':_0x45d5be[_0x22e995(0x167)],'gatewayPaymentId':_0x45d5be[_0x22e995(0x139)],'requires3ds':_0x45d5be[_0x22e995(0x166)],'processedAt':new Date()[_0x22e995(0x13a)]()})}});_0x45d5be[_0x22e995(0x165)]&&(await this[_0x22e995(0x152)](_0x3982c1,_0x45d5be['status'],_0x45d5be[_0x22e995(0x139)]),await this['sendPaymentStatusNotification'](_0x3982c1,_0x45d5be[_0x22e995(0x167)]));console[_0x22e995(0x160)]('âœ…\x20MasterCard\x20payment\x20'+_0xe15da7+'\x20processed:\x20'+_0x45d5be[_0x22e995(0x167)]);if(_0x45d5be[_0x22e995(0x167)]==='PAID')_0x256c48[_0x22e995(0x14f)]({'success':!![],'message':_0x22e995(0x176),'result':{'status':'PAID','gatewayPaymentId':_0x45d5be[_0x22e995(0x139)],'redirectUrl':_0x543c9b,'final':!![]}});else _0x45d5be[_0x22e995(0x166)]&&_0x45d5be[_0x22e995(0x136)]?_0x256c48[_0x22e995(0x14f)]({'success':!![],'message':_0x22e995(0x177),'result':{'status':_0x22e995(0x164),'gatewayPaymentId':_0x45d5be['gateway_payment_id'],'redirectUrl':_0x45d5be[_0x22e995(0x136)],'requires3ds':!![],'final':![]}}):_0x256c48[_0x22e995(0x167)](0x190)[_0x22e995(0x14f)]({'success':![],'message':_0x22e995(0x169),'result':{'status':_0x22e995(0x12e),'gatewayPaymentId':_0x45d5be[_0x22e995(0x139)],'redirectUrl':_0x3982c1[_0x22e995(0x157)],'final':!![]}});}catch(_0x5ab72f){_0x2f8b1d(_0x5ab72f);}},this[_0x25d8ba(0x13c)]=new paymentService_1[(_0x25d8ba(0x117))](),this[_0x25d8ba(0x11c)]=new mastercardService_1[(_0x25d8ba(0x122))](),this[_0x25d8ba(0x14c)]=new webhookService_1['WebhookService']();}async[a8_0x2b850d(0x152)](_0x1df5c2,_0x3ffda6,_0x1449c7){const _0x5d5b47=a8_0x2b850d,_0x2a5b09=Date['now']();try{const _0x563b50=_0x1df5c2[_0x5d5b47(0x158)],_0x2c6792=_0x563b50[_0x5d5b47(0x12b)];if(!_0x2c6792?.['webhookUrl']){console['log'](_0x5d5b47(0x170)+_0x563b50['id']);return;}const _0x973ff7=_0x3ffda6===_0x5d5b47(0x14d)?'payment.success':_0x5d5b47(0x168);let _0x55a4b0=[];if(_0x2c6792['webhookEvents'])try{_0x55a4b0=Array['isArray'](_0x2c6792[_0x5d5b47(0x175)])?_0x2c6792[_0x5d5b47(0x175)]:JSON[_0x5d5b47(0x17c)](_0x2c6792[_0x5d5b47(0x175)]);}catch(_0x496585){console[_0x5d5b47(0x12d)]('Error\x20parsing\x20webhook\x20events:',_0x496585),_0x55a4b0=[];}if(!_0x55a4b0[_0x5d5b47(0x147)](_0x973ff7)){console[_0x5d5b47(0x160)]('Webhook\x20event\x20'+_0x973ff7+_0x5d5b47(0x124)+_0x563b50['id']);return;}const _0x44ca8e={'event':_0x973ff7,'payment':{'id':_0x1df5c2['id'],'order_id':_0x1df5c2['orderId'],'gateway_order_id':_0x1df5c2['gatewayOrderId'],'gateway':_0x5d5b47(0x146),'amount':_0x1df5c2['amount'],'currency':_0x1df5c2[_0x5d5b47(0x125)],'status':_0x3ffda6[_0x5d5b47(0x132)](),'customer_email':_0x1df5c2[_0x5d5b47(0x15c)],'customer_name':_0x1df5c2[_0x5d5b47(0x143)],'gateway_payment_id':_0x1449c7,'created_at':_0x1df5c2[_0x5d5b47(0x155)],'updated_at':new Date()}},_0x535ff5=await fetch(_0x2c6792[_0x5d5b47(0x13f)],{'method':_0x5d5b47(0x159),'headers':{'Content-Type':_0x5d5b47(0x161),'User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x5d5b47(0x15f)](_0x44ca8e)}),_0x4e7148=Date[_0x5d5b47(0x133)]()-_0x2a5b09;console['log'](_0x5d5b47(0x116)+_0x2c6792[_0x5d5b47(0x13f)]+_0x5d5b47(0x15d)+_0x535ff5['status']+'\x20('+_0x4e7148+'ms)');}catch(_0x4e8237){console[_0x5d5b47(0x12d)]('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x4e8237);}}async[a8_0x2b850d(0x15b)](_0x3fd29f,_0x6e8509){const _0x54d731=a8_0x2b850d;try{const {telegramBotService:_0x1de068}=await Promise['resolve']()[_0x54d731(0x115)](()=>__importStar(require('../services/telegramBotService'))),_0x29e3fd={'PAID':_0x54d731(0x135),'FAILED':_0x54d731(0x14a)},_0x3d3fa1=_0x29e3fd[_0x6e8509];if(!_0x3d3fa1)return;await _0x1de068[_0x54d731(0x12f)](_0x3fd29f[_0x54d731(0x113)],_0x3fd29f,_0x3d3fa1);}catch(_0x36fd7d){console[_0x54d731(0x12d)](_0x54d731(0x16a),_0x36fd7d);}}}exports['PaymentController']=PaymentController;