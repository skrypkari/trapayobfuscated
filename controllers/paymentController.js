'use strict';const a8_0x182dec=a8_0x19df;(function(_0x52ec93,_0x4657bf){const _0x4498a8=a8_0x19df,_0x1c8dd2=_0x52ec93();while(!![]){try{const _0x5e952f=-parseInt(_0x4498a8(0xca))/0x1+-parseInt(_0x4498a8(0xe9))/0x2*(parseInt(_0x4498a8(0xae))/0x3)+-parseInt(_0x4498a8(0xb4))/0x4*(-parseInt(_0x4498a8(0xe2))/0x5)+parseInt(_0x4498a8(0xd6))/0x6*(parseInt(_0x4498a8(0xa6))/0x7)+parseInt(_0x4498a8(0xbb))/0x8+parseInt(_0x4498a8(0xbc))/0x9+parseInt(_0x4498a8(0x8e))/0xa*(-parseInt(_0x4498a8(0xce))/0xb);if(_0x5e952f===_0x4657bf)break;else _0x1c8dd2['push'](_0x1c8dd2['shift']());}catch(_0x5ae340){_0x1c8dd2['push'](_0x1c8dd2['shift']());}}}(a8_0x2522,0xac4f9));function a8_0x2522(){const _0x5bf34b=['‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','createdAt','sendPaymentNotification','webhookUrl','failed','handleSuccessfulPayment','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','getPaymentById','../services/paymentLinkService','system','resolve','masterCardService','../config/database','call','Payment\x20processed\x20successfully','üí≥\x20Processing\x20MasterCard\x20payment:\x20','‚úÖ\x20MasterCard\x20payment\x20','stringify','getOwnPropertyNames','7RosPxv','create','PaymentController','payment',',\x20cannot\x20process','__importStar','error','Error\x20parsing\x20webhook\x20events:','632724NHEVYB','Failed\x20to\x20send\x20MasterCard\x20webhook:','üìà\x20MasterCard\x20payment\x20','failUrl','POST','üìù\x20Customer\x20data:','670364dVfEVX','PENDING','default','gatewayOrderId','status','1111','params','10051024PTbTWW','4013181reusrJ','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','\x20\x20\x20Return\x20URL:\x20','MasterCard\x20webhook\x20sent\x20to\x20','Payment\x20created\x20successfully','../services/telegramBotService','sendPaymentStatusNotification','processCardPayment','paymentService','first_name','configurable','PAID','last_name','getPaymentStatus','1395733rdAkFe','settings','shopId','slice','190223ivAvix','__createBinding','body','üí≥\x20Card\x20holder:\x20','Customer\x20data\x20updated\x20successfully','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','../services/gateways/mastercardService','Payment\x20not\x20found','6727242uFwNrx','FAILED','3DS\x20verification\x20required','customerIp','updatePaymentCustomerDataPublic','webhookLog','defineProperty','writable','\x20processed:\x20','sendShopWebhook','cardLast4','includes','35LsUtXC','toISOString','customerName','processMasterCardPayment','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','https://api.trapay.uk/api/webhooks/gateway/mastercard','ms)','6gTQbYv','email','__setModuleDefault','threeds_url','üí≥\x20Browser\x20IP:\x20','update','log','\x20with\x20status\x20','then','üí≥\x20MasterCard\x20result:','gateway','failureMessage','amount','application/json','getOwnPropertyDescriptor','Card\x20payment\x20failed','updatePaymentCustomer','gateway_payment_id','webhookEvents','paymentMethod','customerUa','Payment\x20failed','updatedAt','paid','paidAt','webhookService','mastercard','customerEmail','parse','__esModule','currency','final','requires_3ds','createPublicPayment','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','length','isArray','json','730AqwSEb','payment.failed','now','Payment\x20status\x20is\x20'];a8_0x2522=function(){return _0x5bf34b;};return a8_0x2522();}function a8_0x19df(_0x3b629d,_0x34e4a1){const _0x2522fd=a8_0x2522();return a8_0x19df=function(_0x19dff6,_0x465a93){_0x19dff6=_0x19dff6-0x69;let _0x48ae9d=_0x2522fd[_0x19dff6];return _0x48ae9d;},a8_0x19df(_0x3b629d,_0x34e4a1);}var __createBinding=this&&this[a8_0x182dec(0xcf)]||(Object[a8_0x182dec(0xa7)]?function(_0x4f6ee7,_0x3822de,_0x4efe96,_0x175f76){const _0x5d9c24=a8_0x182dec;if(_0x175f76===undefined)_0x175f76=_0x4efe96;var _0x2d1445=Object[_0x5d9c24(0x76)](_0x3822de,_0x4efe96);(!_0x2d1445||('get'in _0x2d1445?!_0x3822de['__esModule']:_0x2d1445[_0x5d9c24(0xdd)]||_0x2d1445[_0x5d9c24(0xc6)]))&&(_0x2d1445={'enumerable':!![],'get':function(){return _0x3822de[_0x4efe96];}}),Object[_0x5d9c24(0xdc)](_0x4f6ee7,_0x175f76,_0x2d1445);}:function(_0x4947cc,_0x577ecf,_0xa9fec7,_0x54aa37){if(_0x54aa37===undefined)_0x54aa37=_0xa9fec7;_0x4947cc[_0x54aa37]=_0x577ecf[_0xa9fec7];}),__setModuleDefault=this&&this[a8_0x182dec(0x6a)]||(Object[a8_0x182dec(0xa7)]?function(_0x866b5,_0x1b828e){const _0x1b8a57=a8_0x182dec;Object['defineProperty'](_0x866b5,_0x1b8a57(0xb6),{'enumerable':!![],'value':_0x1b828e});}:function(_0x5ca72d,_0x2e7ef9){_0x5ca72d['default']=_0x2e7ef9;}),__importStar=this&&this[a8_0x182dec(0xab)]||(function(){var _0x479884=function(_0x4a47a2){const _0x44932a=a8_0x19df;return _0x479884=Object[_0x44932a(0xa5)]||function(_0xbb761c){const _0x364ad2=_0x44932a;var _0x2ca817=[];for(var _0x5c50b8 in _0xbb761c)if(Object['prototype']['hasOwnProperty'][_0x364ad2(0xa0)](_0xbb761c,_0x5c50b8))_0x2ca817[_0x2ca817[_0x364ad2(0x8b)]]=_0x5c50b8;return _0x2ca817;},_0x479884(_0x4a47a2);};return function(_0x5196fd){const _0x56bc80=a8_0x19df;if(_0x5196fd&&_0x5196fd[_0x56bc80(0x85)])return _0x5196fd;var _0x514ed0={};if(_0x5196fd!=null){for(var _0x313abe=_0x479884(_0x5196fd),_0x457bb7=0x0;_0x457bb7<_0x313abe['length'];_0x457bb7++)if(_0x313abe[_0x457bb7]!=='default')__createBinding(_0x514ed0,_0x5196fd,_0x313abe[_0x457bb7]);}return __setModuleDefault(_0x514ed0,_0x5196fd),_0x514ed0;};}()),__importDefault=this&&this['__importDefault']||function(_0x3cd4c1){const _0x15b11a=a8_0x182dec;return _0x3cd4c1&&_0x3cd4c1[_0x15b11a(0x85)]?_0x3cd4c1:{'default':_0x3cd4c1};};Object[a8_0x182dec(0xdc)](exports,a8_0x182dec(0x85),{'value':!![]}),exports[a8_0x182dec(0xa8)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x182dec(0xd4)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x182dec(0x9f)));class PaymentController{constructor(){const _0x54c90d=a8_0x182dec;this[_0x54c90d(0x89)]=async(_0x9f418,_0x39f240,_0x5ba176)=>{const _0x3c9c2c=_0x54c90d;try{const _0x5d4398=_0x9f418[_0x3c9c2c(0xd0)],_0x211b16=await this[_0x3c9c2c(0xc4)][_0x3c9c2c(0x89)](_0x5d4398);_0x39f240[_0x3c9c2c(0xb8)](0xc9)[_0x3c9c2c(0x8d)]({'success':!![],'message':_0x3c9c2c(0xc0),'result':_0x211b16});}catch(_0x7a3999){_0x5ba176(_0x7a3999);}},this[_0x54c90d(0xc9)]=async(_0x4c3af7,_0xa9b0,_0x4576a1)=>{const _0x1b7488=_0x54c90d;try{const {id:_0x3e811e}=_0x4c3af7[_0x1b7488(0xba)],_0xdb4651=await this[_0x1b7488(0xc4)][_0x1b7488(0xc9)](_0x3e811e);if(!_0xdb4651)return _0xa9b0[_0x1b7488(0xb8)](0x194)[_0x1b7488(0x8d)]({'success':![],'message':_0x1b7488(0xd5)});_0xa9b0[_0x1b7488(0x8d)]({'success':!![],'result':_0xdb4651});}catch(_0x517723){_0x4576a1(_0x517723);}},this[_0x54c90d(0x9a)]=async(_0x2288cc,_0x4a9c2,_0x13ea3b)=>{const _0x10718a=_0x54c90d;try{const {id:_0xb441a9}=_0x2288cc[_0x10718a(0xba)],_0x551110=await this['paymentService'][_0x10718a(0x9a)](_0xb441a9);if(!_0x551110)return _0x4a9c2[_0x10718a(0xb8)](0x194)[_0x10718a(0x8d)]({'success':![],'message':'Payment\x20not\x20found'});_0x4a9c2[_0x10718a(0x8d)]({'success':!![],'result':_0x551110});}catch(_0x20417e){_0x13ea3b(_0x20417e);}},this[_0x54c90d(0x78)]=async(_0x4b5381,_0x370dc4,_0x514a6d)=>{const _0x395483=_0x54c90d;try{const {id:_0x52d286}=_0x4b5381[_0x395483(0xba)],_0x4df52c=_0x4b5381[_0x395483(0xd0)];console['log'](_0x395483(0xd3)+_0x52d286),console['log'](_0x395483(0xb3),_0x4df52c);const _0x4dc181=await this[_0x395483(0xc4)][_0x395483(0xda)](_0x52d286,_0x4df52c);if(!_0x4dc181)return _0x370dc4['status'](0x194)[_0x395483(0x8d)]({'success':![],'message':_0x395483(0xd5)});_0x370dc4[_0x395483(0x8d)]({'success':!![],'message':_0x395483(0xd2),'result':{'paymentId':_0x4dc181['id'],'customerIp':_0x4dc181[_0x395483(0xd9)],'customerUa':_0x4dc181[_0x395483(0x7c)],'customerCountry':_0x4dc181['customerCountry'],'updatedAt':_0x4dc181[_0x395483(0x7e)]}});}catch(_0x59c706){_0x514a6d(_0x59c706);}},this[_0x54c90d(0xe5)]=async(_0x4e1cc,_0x2ab40b,_0x22381a)=>{const _0x214cef=_0x54c90d;try{const {id:_0x37a378}=_0x4e1cc[_0x214cef(0xba)],{cardData:_0x93182,cardHolder:_0x322560,browser:_0x339abe}=_0x4e1cc[_0x214cef(0xd0)];console[_0x214cef(0x6e)](_0x214cef(0xa2)+_0x37a378),console['log'](_0x214cef(0xd1)+_0x322560[_0x214cef(0xc5)]+'\x20'+_0x322560[_0x214cef(0xc8)]+'\x20('+_0x322560[_0x214cef(0x69)]+')'),console[_0x214cef(0x6e)](_0x214cef(0x6c)+_0x339abe['ip']);const _0x5de00c={'customerName':_0x322560[_0x214cef(0xc5)]+'\x20'+_0x322560[_0x214cef(0xc8)],'customerEmail':_0x322560['email'],'customerIp':_0x339abe['ip'],'customerUa':_0x339abe['user_agent']},_0x5ef350=await database_1['default'][_0x214cef(0xa9)]['findUnique']({'where':{'id':_0x37a378},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x5ef350)return _0x2ab40b['status'](0x194)[_0x214cef(0x8d)]({'success':![],'message':_0x214cef(0xd5)});if(_0x5ef350[_0x214cef(0x72)]!==_0x214cef(0x82))return _0x2ab40b[_0x214cef(0xb8)](0x190)[_0x214cef(0x8d)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x5ef350[_0x214cef(0xb8)]!==_0x214cef(0xb5))return _0x2ab40b['status'](0x190)[_0x214cef(0x8d)]({'success':![],'message':_0x214cef(0x91)+_0x5ef350['status']+_0x214cef(0xaa)});await database_1['default'][_0x214cef(0xa9)][_0x214cef(0x6d)]({'where':{'id':_0x37a378},'data':{..._0x5de00c,'updatedAt':new Date()}});const _0xf686c6=_0x214cef(0xe7),_0x118c9c=_0x5ef350['successUrl'];console[_0x214cef(0x6e)]('üí≥\x20MasterCard\x20URLs:'),console[_0x214cef(0x6e)]('\x20\x20\x20Result\x20URL\x20(webhook):\x20'+_0xf686c6),console[_0x214cef(0x6e)](_0x214cef(0xbe)+_0x118c9c);const _0x83a84={'first_name':_0x322560[_0x214cef(0xc5)],'last_name':_0x322560[_0x214cef(0xc8)],'email':_0x322560[_0x214cef(0x69)]},_0x4767ee=await this['masterCardService'][_0x214cef(0xc3)]({'paymentId':_0x5ef350['id'],'orderId':_0x5ef350['gatewayOrderId']||_0x5ef350['id'],'amount':_0x5ef350[_0x214cef(0x74)],'currency':_0x5ef350[_0x214cef(0x86)],'cardData':_0x93182,'resultUrl':_0xf686c6,'returnUrl':_0x118c9c,'cardHolder':_0x83a84,'browser':_0x339abe});console[_0x214cef(0x6e)](_0x214cef(0x71),_0x4767ee);const _0x4655ed={'status':_0x4767ee[_0x214cef(0xb8)],'updatedAt':new Date(),'statusChangedBy':_0x214cef(0x9c),'statusChangedAt':new Date()};_0x4767ee[_0x214cef(0x79)]&&(_0x4655ed['gatewayPaymentId']=_0x4767ee[_0x214cef(0x79)],console['log']('üí≥\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x4767ee[_0x214cef(0x79)]));if(_0x4767ee[_0x214cef(0xb8)]===_0x214cef(0xc7))_0x4655ed[_0x214cef(0x80)]=new Date();else _0x4767ee[_0x214cef(0xb8)]===_0x214cef(0xd7)&&(_0x4655ed[_0x214cef(0x73)]=_0x214cef(0x77));_0x4655ed[_0x214cef(0x7b)]=_0x214cef(0x82);if(_0x93182['number']){const _0x1cf9d0=_0x93182['number']['replace'](/[\s-]/g,'');_0x4655ed['cardLast4']=_0x1cf9d0[_0x214cef(0xcd)](-0x4),console[_0x214cef(0x6e)](_0x214cef(0xe6)+_0x4655ed[_0x214cef(0xe0)]);}await database_1['default'][_0x214cef(0xa9)][_0x214cef(0x6d)]({'where':{'id':_0x5ef350['id']},'data':_0x4655ed}),await database_1[_0x214cef(0xb6)][_0x214cef(0xdb)][_0x214cef(0xa7)]({'data':{'paymentId':_0x5ef350['id'],'shopId':_0x5ef350[_0x214cef(0xcc)],'event':'mastercard_'+_0x4767ee[_0x214cef(0xb8)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x214cef(0xa4)]({'oldStatus':_0x214cef(0xb5),'newStatus':_0x4767ee['status'],'gatewayPaymentId':_0x4767ee[_0x214cef(0x79)],'requires3ds':_0x4767ee[_0x214cef(0x88)],'processedAt':new Date()[_0x214cef(0xe3)]()})}});if(_0x4767ee[_0x214cef(0x87)]){await this[_0x214cef(0xdf)](_0x5ef350,_0x4767ee[_0x214cef(0xb8)],_0x4767ee[_0x214cef(0x79)]),await this['sendPaymentStatusNotification'](_0x5ef350,_0x4767ee[_0x214cef(0xb8)]);if(_0x4767ee[_0x214cef(0xb8)]===_0x214cef(0xc7)){console[_0x214cef(0x6e)](_0x214cef(0xb0)+_0x37a378+_0x214cef(0x8a));try{const {PaymentLinkService:_0x1f505a}=await Promise['resolve']()['then'](()=>__importStar(require(_0x214cef(0x9b)))),_0x5ed539=new _0x1f505a();await _0x5ed539[_0x214cef(0x98)](_0x37a378),console[_0x214cef(0x6e)](_0x214cef(0x92)+_0x37a378);}catch(_0x36091d){console[_0x214cef(0xac)](_0x214cef(0x99),_0x36091d);}}}console[_0x214cef(0x6e)](_0x214cef(0xa3)+_0x37a378+_0x214cef(0xde)+_0x4767ee[_0x214cef(0xb8)]);if(_0x4767ee[_0x214cef(0xb8)]==='PAID')_0x2ab40b[_0x214cef(0x8d)]({'success':!![],'message':_0x214cef(0xa1),'result':{'status':'PAID','gatewayPaymentId':_0x4767ee[_0x214cef(0x79)],'redirectUrl':_0x118c9c,'final':!![]}});else _0x4767ee[_0x214cef(0x88)]&&_0x4767ee[_0x214cef(0x6b)]?_0x2ab40b[_0x214cef(0x8d)]({'success':!![],'message':_0x214cef(0xd8),'result':{'status':_0x214cef(0xb5),'gatewayPaymentId':_0x4767ee[_0x214cef(0x79)],'redirectUrl':_0x4767ee[_0x214cef(0x6b)],'requires3ds':!![],'final':![]}}):_0x2ab40b[_0x214cef(0xb8)](0x190)[_0x214cef(0x8d)]({'success':![],'message':_0x214cef(0x7d),'result':{'status':'FAILED','gatewayPaymentId':_0x4767ee[_0x214cef(0x79)],'redirectUrl':_0x5ef350[_0x214cef(0xb1)],'final':!![]}});}catch(_0x2aba91){_0x22381a(_0x2aba91);}},this[_0x54c90d(0xc4)]=new paymentService_1['PaymentService'](),this[_0x54c90d(0x9e)]=new mastercardService_1['MasterCardService'](),this[_0x54c90d(0x81)]=new webhookService_1['WebhookService']();}async[a8_0x182dec(0xdf)](_0x582cac,_0x555ee2,_0x77b481){const _0x23ee58=a8_0x182dec,_0x1f78e5=Date[_0x23ee58(0x90)]();try{const _0x1e6d91=_0x582cac['shop'],_0x9170ce=_0x1e6d91[_0x23ee58(0xcb)];if(!_0x9170ce?.[_0x23ee58(0x96)]){console[_0x23ee58(0x6e)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x1e6d91['id']);return;}const _0x4d71a8=_0x555ee2===_0x23ee58(0xc7)?'payment.success':_0x23ee58(0x8f);let _0x481b0e=[];if(_0x9170ce['webhookEvents'])try{_0x481b0e=Array[_0x23ee58(0x8c)](_0x9170ce[_0x23ee58(0x7a)])?_0x9170ce[_0x23ee58(0x7a)]:JSON[_0x23ee58(0x84)](_0x9170ce[_0x23ee58(0x7a)]);}catch(_0x61a337){console[_0x23ee58(0xac)](_0x23ee58(0xad),_0x61a337),_0x481b0e=[];}if(!_0x481b0e[_0x23ee58(0xe1)](_0x4d71a8)){console['log']('Webhook\x20event\x20'+_0x4d71a8+_0x23ee58(0x93)+_0x1e6d91['id']);return;}const _0x27c5a7={'event':_0x4d71a8,'payment':{'id':_0x582cac['id'],'order_id':_0x582cac['orderId'],'gateway_order_id':_0x582cac[_0x23ee58(0xb7)],'gateway':_0x23ee58(0xb9),'amount':_0x582cac[_0x23ee58(0x74)],'currency':_0x582cac[_0x23ee58(0x86)],'status':_0x555ee2['toLowerCase'](),'customer_email':_0x582cac[_0x23ee58(0x83)],'customer_name':_0x582cac[_0x23ee58(0xe4)],'gateway_payment_id':_0x77b481,'created_at':_0x582cac[_0x23ee58(0x94)],'updated_at':new Date()}},_0x4960b9=await fetch(_0x9170ce[_0x23ee58(0x96)],{'method':_0x23ee58(0xb2),'headers':{'Content-Type':_0x23ee58(0x75),'User-Agent':_0x23ee58(0xbd)},'body':JSON[_0x23ee58(0xa4)](_0x27c5a7)}),_0x3c3f57=Date[_0x23ee58(0x90)]()-_0x1f78e5;console['log'](_0x23ee58(0xbf)+_0x9170ce['webhookUrl']+_0x23ee58(0x6f)+_0x4960b9[_0x23ee58(0xb8)]+'\x20('+_0x3c3f57+_0x23ee58(0xe8));}catch(_0xb48006){console[_0x23ee58(0xac)](_0x23ee58(0xaf),_0xb48006);}}async[a8_0x182dec(0xc2)](_0x3a5543,_0x13307c){const _0x15e740=a8_0x182dec;try{const {telegramBotService:_0x7bca0d}=await Promise[_0x15e740(0x9d)]()[_0x15e740(0x70)](()=>__importStar(require(_0x15e740(0xc1)))),_0x518546={'PAID':_0x15e740(0x7f),'FAILED':_0x15e740(0x97)},_0x234a97=_0x518546[_0x13307c];if(!_0x234a97)return;await _0x7bca0d[_0x15e740(0x95)](_0x3a5543[_0x15e740(0xcc)],_0x3a5543,_0x234a97);}catch(_0x217077){console['error']('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x217077);}}}exports['PaymentController']=PaymentController;