'use strict';const a8_0x1398ca=a8_0x3c32;(function(_0x57f781,_0xb30ad9){const _0x57fb49=a8_0x3c32,_0x26437c=_0x57f781();while(!![]){try{const _0x31d4f7=-parseInt(_0x57fb49(0xf8))/0x1*(-parseInt(_0x57fb49(0x10f))/0x2)+parseInt(_0x57fb49(0xef))/0x3*(-parseInt(_0x57fb49(0x10b))/0x4)+parseInt(_0x57fb49(0xcf))/0x5*(-parseInt(_0x57fb49(0x105))/0x6)+parseInt(_0x57fb49(0xaa))/0x7*(-parseInt(_0x57fb49(0xaf))/0x8)+parseInt(_0x57fb49(0x116))/0x9*(parseInt(_0x57fb49(0xe8))/0xa)+parseInt(_0x57fb49(0xe1))/0xb*(-parseInt(_0x57fb49(0x110))/0xc)+parseInt(_0x57fb49(0x112))/0xd;if(_0x31d4f7===_0xb30ad9)break;else _0x26437c['push'](_0x26437c['shift']());}catch(_0x5ab2bb){_0x26437c['push'](_0x26437c['shift']());}}}(a8_0x29a4,0x8ae2f));function a8_0x29a4(){const _0xb6c86=['failUrl','createPublicPayment','requires_3ds','shopId','üí≥\x20MasterCard\x20URLs:','updatePaymentCustomer','defineProperty','\x20\x20\x20Result\x20URL\x20(webhook):\x20','shop','createdAt','paymentMethod','body','440NpYksw','call','toISOString','user_agent','number','gateway_payment_id','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','../services/paymentService','orderId','POST','üí≥\x20Saving\x20card\x20last\x204\x20digits:\x20****','stringify','mastercard_','sendPaymentNotification','last_name','Payment\x20not\x20found','sendPaymentStatusNotification','failureMessage','10923DOmomU','gatewayPaymentId','masterCardService','isArray','üìù\x20Customer\x20data:','getPaymentById','customerName','372080TgVWae','threeds_url','includes','PENDING','getOwnPropertyDescriptor','slice','../services/paymentLinkService','156qCSkiC','__importStar','settings','country','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','json','sendShopWebhook','\x20not\x20enabled\x20for\x20shop\x20','paymentService','381489yIXeiR','then','customerCountry','error','paid','MasterCard\x20webhook\x20sent\x20to\x20','findUnique','log','updatedAt','payment.failed','failed','now','__esModule','12144HdIYZL','cardLast4','update','Payment\x20status\x20is\x20',',\x20cannot\x20process','Payment\x20processed\x20successfully','76796MtBsvn','amount','FAILED','get','4iVITgS','1692jYOEVA','Customer\x20data\x20updated\x20successfully','10125232WsiFFa','resolve','__createBinding','üí≥\x20Browser\x20IP:\x20','90oAbyvz','processMasterCardPayment','‚úÖ\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','ms)','email','PAID','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','webhookUrl','final','paidAt','__importDefault','gatewayOrderId','updatePaymentCustomerDataPublic','payment','toLowerCase','configurable','Error\x20parsing\x20webhook\x20events:','../services/webhookService','19999xIkKUh','customerUa','params','gateway','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','80MlhMQx','successUrl','getPaymentStatus','writable','handleSuccessfulPayment','3DS\x20verification\x20required','status','webhookEvents','first_name','customerIp','default','üí≥\x20Card\x20holder:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','Webhook\x20event\x20','Card\x20payment\x20failed','\x20processed:\x20','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','currency','create','getOwnPropertyNames'];a8_0x29a4=function(){return _0xb6c86;};return a8_0x29a4();}var __createBinding=this&&this[a8_0x1398ca(0x114)]||(Object[a8_0x1398ca(0xc1)]?function(_0x44d21b,_0x4468b0,_0x331c56,_0x1711db){const _0x3644b5=a8_0x1398ca;if(_0x1711db===undefined)_0x1711db=_0x331c56;var _0xdafdb=Object[_0x3644b5(0xec)](_0x4468b0,_0x331c56);(!_0xdafdb||(_0x3644b5(0x10e)in _0xdafdb?!_0x4468b0[_0x3644b5(0x104)]:_0xdafdb[_0x3644b5(0xb2)]||_0xdafdb[_0x3644b5(0xa7)]))&&(_0xdafdb={'enumerable':!![],'get':function(){return _0x4468b0[_0x331c56];}}),Object['defineProperty'](_0x44d21b,_0x1711db,_0xdafdb);}:function(_0xd17e68,_0x34fe61,_0x2d05f6,_0x2290c2){if(_0x2290c2===undefined)_0x2290c2=_0x2d05f6;_0xd17e68[_0x2290c2]=_0x34fe61[_0x2d05f6];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a8_0x1398ca(0xc1)]?function(_0x25214c,_0x4be52b){const _0xc2ef0=a8_0x1398ca;Object[_0xc2ef0(0xc9)](_0x25214c,_0xc2ef0(0xb9),{'enumerable':!![],'value':_0x4be52b});}:function(_0x23396f,_0x3703fc){_0x23396f['default']=_0x3703fc;}),__importStar=this&&this[a8_0x1398ca(0xf0)]||(function(){var _0x19ca03=function(_0xdbccbe){const _0x51a5d7=a8_0x3c32;return _0x19ca03=Object[_0x51a5d7(0xc2)]||function(_0xf4fad){const _0x101fd8=_0x51a5d7;var _0x4a8e5d=[];for(var _0x593238 in _0xf4fad)if(Object['prototype']['hasOwnProperty'][_0x101fd8(0xd0)](_0xf4fad,_0x593238))_0x4a8e5d[_0x4a8e5d['length']]=_0x593238;return _0x4a8e5d;},_0x19ca03(_0xdbccbe);};return function(_0x187b96){const _0x3aea6b=a8_0x3c32;if(_0x187b96&&_0x187b96[_0x3aea6b(0x104)])return _0x187b96;var _0x42e1bf={};if(_0x187b96!=null){for(var _0x305faa=_0x19ca03(_0x187b96),_0x2d29df=0x0;_0x2d29df<_0x305faa['length'];_0x2d29df++)if(_0x305faa[_0x2d29df]!==_0x3aea6b(0xb9))__createBinding(_0x42e1bf,_0x187b96,_0x305faa[_0x2d29df]);}return __setModuleDefault(_0x42e1bf,_0x187b96),_0x42e1bf;};}()),__importDefault=this&&this[a8_0x1398ca(0xa2)]||function(_0x4e5e8d){const _0x4e9c27=a8_0x1398ca;return _0x4e5e8d&&_0x4e5e8d[_0x4e9c27(0x104)]?_0x4e5e8d:{'default':_0x4e5e8d};};Object[a8_0x1398ca(0xc9)](exports,a8_0x1398ca(0x104),{'value':!![]}),exports['PaymentController']=void 0x0;function a8_0x3c32(_0x2a465e,_0x1963bc){const _0x29a4e7=a8_0x29a4();return a8_0x3c32=function(_0x3c32f7,_0x609ee9){_0x3c32f7=_0x3c32f7-0xa2;let _0x5d7839=_0x29a4e7[_0x3c32f7];return _0x5d7839;},a8_0x3c32(_0x2a465e,_0x1963bc);}const paymentService_1=require(a8_0x1398ca(0xd6)),mastercardService_1=require('../services/gateways/mastercardService'),webhookService_1=require(a8_0x1398ca(0xa9)),database_1=__importDefault(require('../config/database'));class PaymentController{constructor(){const _0x5a4cd6=a8_0x1398ca;this['createPublicPayment']=async(_0x256e8b,_0x38adcd,_0x1b2666)=>{const _0x17dd60=a8_0x3c32;try{const _0x17b118=_0x256e8b['body'],_0x37d93b=await this['paymentService'][_0x17dd60(0xc4)](_0x17b118);_0x38adcd['status'](0xc9)[_0x17dd60(0xf4)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x37d93b});}catch(_0x4a090b){_0x1b2666(_0x4a090b);}},this[_0x5a4cd6(0xb1)]=async(_0x8c9abc,_0x122cf7,_0xc5edee)=>{const _0x2df003=_0x5a4cd6;try{const {id:_0x53c920}=_0x8c9abc[_0x2df003(0xac)],_0x4a753b=await this[_0x2df003(0xf7)]['getPaymentStatus'](_0x53c920);if(!_0x4a753b)return _0x122cf7[_0x2df003(0xb5)](0x194)[_0x2df003(0xf4)]({'success':![],'message':_0x2df003(0xde)});_0x122cf7['json']({'success':!![],'result':_0x4a753b});}catch(_0xe209a3){_0xc5edee(_0xe209a3);}},this[_0x5a4cd6(0xe6)]=async(_0x2060d0,_0x563dbf,_0x285633)=>{const _0x38e61a=_0x5a4cd6;try{const {id:_0x25a77f}=_0x2060d0['params'],_0x391c58=await this[_0x38e61a(0xf7)][_0x38e61a(0xe6)](_0x25a77f);if(!_0x391c58)return _0x563dbf[_0x38e61a(0xb5)](0x194)[_0x38e61a(0xf4)]({'success':![],'message':_0x38e61a(0xde)});_0x563dbf[_0x38e61a(0xf4)]({'success':!![],'result':_0x391c58});}catch(_0x1bdeba){_0x285633(_0x1bdeba);}},this[_0x5a4cd6(0xc8)]=async(_0x3f5d4c,_0x1a4d94,_0x22b0a1)=>{const _0x4a3e54=_0x5a4cd6;try{const {id:_0x21fd7e}=_0x3f5d4c[_0x4a3e54(0xac)],_0x46af10=_0x3f5d4c[_0x4a3e54(0xce)];console['log'](_0x4a3e54(0xbf)+_0x21fd7e),console[_0x4a3e54(0xff)](_0x4a3e54(0xe5),_0x46af10);const _0x3a812b=await this[_0x4a3e54(0xf7)][_0x4a3e54(0xa4)](_0x21fd7e,_0x46af10);if(!_0x3a812b)return _0x1a4d94[_0x4a3e54(0xb5)](0x194)[_0x4a3e54(0xf4)]({'success':![],'message':_0x4a3e54(0xde)});_0x1a4d94[_0x4a3e54(0xf4)]({'success':!![],'message':_0x4a3e54(0x111),'result':{'paymentId':_0x3a812b['id'],'customerIp':_0x3a812b[_0x4a3e54(0xb8)],'customerUa':_0x3a812b[_0x4a3e54(0xab)],'customerCountry':_0x3a812b[_0x4a3e54(0xfa)],'updatedAt':_0x3a812b[_0x4a3e54(0x100)]}});}catch(_0xf87e76){_0x22b0a1(_0xf87e76);}},this[_0x5a4cd6(0x117)]=async(_0x49d774,_0x3503d0,_0x104434)=>{const _0x5f4f2c=_0x5a4cd6;try{const {id:_0xa1b347}=_0x49d774[_0x5f4f2c(0xac)],{cardData:_0x3f1875,cardHolder:_0x167cbb,browser:_0x29511d}=_0x49d774[_0x5f4f2c(0xce)];console[_0x5f4f2c(0xff)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0xa1b347),console[_0x5f4f2c(0xff)](_0x5f4f2c(0xba)+_0x167cbb[_0x5f4f2c(0xb7)]+'\x20'+_0x167cbb['last_name']+'\x20('+_0x167cbb[_0x5f4f2c(0x11a)]+')'),console[_0x5f4f2c(0xff)](_0x5f4f2c(0x115)+_0x29511d['ip']);const _0x2f1b06={'customerName':_0x167cbb['first_name']+'\x20'+_0x167cbb['last_name'],'customerEmail':_0x167cbb[_0x5f4f2c(0x11a)],'customerIp':_0x29511d['ip'],'customerUa':_0x29511d[_0x5f4f2c(0xd2)],'customerCountry':_0x167cbb[_0x5f4f2c(0xf2)]||null},_0x1533be=await database_1['default'][_0x5f4f2c(0xa5)][_0x5f4f2c(0xfe)]({'where':{'id':_0xa1b347},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x1533be)return _0x3503d0['status'](0x194)[_0x5f4f2c(0xf4)]({'success':![],'message':_0x5f4f2c(0xde)});if(_0x1533be[_0x5f4f2c(0xad)]!=='mastercard')return _0x3503d0['status'](0x190)[_0x5f4f2c(0xf4)]({'success':![],'message':_0x5f4f2c(0xae)});if(_0x1533be[_0x5f4f2c(0xb5)]!=='PENDING')return _0x3503d0['status'](0x190)[_0x5f4f2c(0xf4)]({'success':![],'message':_0x5f4f2c(0x108)+_0x1533be['status']+_0x5f4f2c(0x109)});await database_1[_0x5f4f2c(0xb9)][_0x5f4f2c(0xa5)][_0x5f4f2c(0x107)]({'where':{'id':_0xa1b347},'data':{..._0x2f1b06,'updatedAt':new Date()}});const _0x23d8b6='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x523ab6=_0x1533be[_0x5f4f2c(0xb0)];console[_0x5f4f2c(0xff)](_0x5f4f2c(0xc7)),console[_0x5f4f2c(0xff)](_0x5f4f2c(0xca)+_0x23d8b6),console[_0x5f4f2c(0xff)]('\x20\x20\x20Return\x20URL:\x20'+_0x523ab6);const _0x295614={'first_name':_0x167cbb[_0x5f4f2c(0xb7)],'last_name':_0x167cbb[_0x5f4f2c(0xdd)],'email':_0x167cbb[_0x5f4f2c(0x11a)]},_0x2e4139=await this['masterCardService']['processCardPayment']({'paymentId':_0x1533be['id'],'orderId':_0x1533be[_0x5f4f2c(0xa3)]||_0x1533be['id'],'amount':_0x1533be[_0x5f4f2c(0x10c)],'currency':_0x1533be['currency'],'cardData':_0x3f1875,'resultUrl':_0x23d8b6,'returnUrl':_0x523ab6,'cardHolder':_0x295614,'browser':_0x29511d});console['log']('üí≥\x20MasterCard\x20result:',_0x2e4139);const _0x55845d={'status':_0x2e4139[_0x5f4f2c(0xb5)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0x2e4139[_0x5f4f2c(0xb5)]==='PAID')_0x55845d[_0x5f4f2c(0x11f)]=new Date(),_0x55845d[_0x5f4f2c(0xe2)]=_0x2e4139['gateway_payment_id'];else _0x2e4139[_0x5f4f2c(0xb5)]==='FAILED'&&(_0x55845d[_0x5f4f2c(0xe0)]=_0x5f4f2c(0xbd));_0x55845d[_0x5f4f2c(0xcd)]='mastercard';if(_0x3f1875['number']){const _0x9693f3=_0x3f1875[_0x5f4f2c(0xd3)]['replace'](/[\s-]/g,'');_0x55845d['cardLast4']=_0x9693f3[_0x5f4f2c(0xed)](-0x4),console[_0x5f4f2c(0xff)](_0x5f4f2c(0xd9)+_0x55845d[_0x5f4f2c(0x106)]);}await database_1[_0x5f4f2c(0xb9)][_0x5f4f2c(0xa5)][_0x5f4f2c(0x107)]({'where':{'id':_0x1533be['id']},'data':_0x55845d}),await database_1['default']['webhookLog'][_0x5f4f2c(0xc1)]({'data':{'paymentId':_0x1533be['id'],'shopId':_0x1533be[_0x5f4f2c(0xc6)],'event':_0x5f4f2c(0xdb)+_0x2e4139[_0x5f4f2c(0xb5)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x5f4f2c(0xda)]({'oldStatus':_0x5f4f2c(0xeb),'newStatus':_0x2e4139[_0x5f4f2c(0xb5)],'gatewayPaymentId':_0x2e4139[_0x5f4f2c(0xd4)],'requires3ds':_0x2e4139[_0x5f4f2c(0xc5)],'processedAt':new Date()[_0x5f4f2c(0xd1)]()})}});if(_0x2e4139[_0x5f4f2c(0x11e)]){await this[_0x5f4f2c(0xf5)](_0x1533be,_0x2e4139[_0x5f4f2c(0xb5)],_0x2e4139[_0x5f4f2c(0xd4)]),await this[_0x5f4f2c(0xdf)](_0x1533be,_0x2e4139[_0x5f4f2c(0xb5)]);if(_0x2e4139['status']===_0x5f4f2c(0x11b)){console[_0x5f4f2c(0xff)]('üìà\x20MasterCard\x20payment\x20'+_0xa1b347+_0x5f4f2c(0xd5));try{const {PaymentLinkService:_0x4e781d}=await Promise['resolve']()['then'](()=>__importStar(require(_0x5f4f2c(0xee)))),_0x2fdc90=new _0x4e781d();await _0x2fdc90[_0x5f4f2c(0xb3)](_0xa1b347),console['log'](_0x5f4f2c(0x118)+_0xa1b347);}catch(_0x4a1d29){console[_0x5f4f2c(0xfb)]('Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:',_0x4a1d29);}}}console[_0x5f4f2c(0xff)]('‚úÖ\x20MasterCard\x20payment\x20'+_0xa1b347+_0x5f4f2c(0xbe)+_0x2e4139[_0x5f4f2c(0xb5)]);if(_0x2e4139[_0x5f4f2c(0xb5)]==='PAID')_0x3503d0[_0x5f4f2c(0xf4)]({'success':!![],'message':_0x5f4f2c(0x10a),'result':{'status':_0x5f4f2c(0x11b),'gatewayPaymentId':_0x2e4139[_0x5f4f2c(0xd4)],'redirectUrl':_0x523ab6,'final':!![]}});else _0x2e4139[_0x5f4f2c(0xc5)]&&_0x2e4139[_0x5f4f2c(0xe9)]?_0x3503d0[_0x5f4f2c(0xf4)]({'success':!![],'message':_0x5f4f2c(0xb4),'result':{'status':_0x5f4f2c(0xeb),'gatewayPaymentId':_0x2e4139[_0x5f4f2c(0xd4)],'redirectUrl':_0x2e4139[_0x5f4f2c(0xe9)],'requires3ds':!![],'final':![]}}):_0x3503d0['status'](0x190)[_0x5f4f2c(0xf4)]({'success':![],'message':'Payment\x20failed','result':{'status':_0x5f4f2c(0x10d),'gatewayPaymentId':_0x2e4139[_0x5f4f2c(0xd4)],'redirectUrl':_0x1533be[_0x5f4f2c(0xc3)],'final':!![]}});}catch(_0x2d923b){_0x104434(_0x2d923b);}},this[_0x5a4cd6(0xf7)]=new paymentService_1['PaymentService'](),this[_0x5a4cd6(0xe3)]=new mastercardService_1['MasterCardService'](),this['webhookService']=new webhookService_1['WebhookService']();}async['sendShopWebhook'](_0x48fdad,_0x58ad39,_0x46f514){const _0x5a9645=a8_0x1398ca,_0x4b250e=Date[_0x5a9645(0x103)]();try{const _0x2f1c80=_0x48fdad[_0x5a9645(0xcb)],_0x37bc26=_0x2f1c80[_0x5a9645(0xf1)];if(!_0x37bc26?.[_0x5a9645(0x11d)]){console[_0x5a9645(0xff)](_0x5a9645(0x11c)+_0x2f1c80['id']);return;}const _0x3d195c=_0x58ad39===_0x5a9645(0x11b)?'payment.success':_0x5a9645(0x101);let _0x5bc9b7=[];if(_0x37bc26['webhookEvents'])try{_0x5bc9b7=Array[_0x5a9645(0xe4)](_0x37bc26['webhookEvents'])?_0x37bc26[_0x5a9645(0xb6)]:JSON['parse'](_0x37bc26['webhookEvents']);}catch(_0x4056d5){console[_0x5a9645(0xfb)](_0x5a9645(0xa8),_0x4056d5),_0x5bc9b7=[];}if(!_0x5bc9b7[_0x5a9645(0xea)](_0x3d195c)){console['log'](_0x5a9645(0xbc)+_0x3d195c+_0x5a9645(0xf6)+_0x2f1c80['id']);return;}const _0x5c0d51={'event':_0x3d195c,'payment':{'id':_0x48fdad['id'],'order_id':_0x48fdad[_0x5a9645(0xd7)],'gateway_order_id':_0x48fdad[_0x5a9645(0xa3)],'gateway':'1111','amount':_0x48fdad[_0x5a9645(0x10c)],'currency':_0x48fdad[_0x5a9645(0xc0)],'status':_0x58ad39[_0x5a9645(0xa6)](),'customer_email':_0x48fdad['customerEmail'],'customer_name':_0x48fdad[_0x5a9645(0xe7)],'gateway_payment_id':_0x46f514,'created_at':_0x48fdad[_0x5a9645(0xcc)],'updated_at':new Date()}},_0x1b2431=await fetch(_0x37bc26[_0x5a9645(0x11d)],{'method':_0x5a9645(0xd8),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x5a9645(0xda)](_0x5c0d51)}),_0x317ef5=Date[_0x5a9645(0x103)]()-_0x4b250e;console[_0x5a9645(0xff)](_0x5a9645(0xfd)+_0x37bc26['webhookUrl']+'\x20with\x20status\x20'+_0x1b2431[_0x5a9645(0xb5)]+'\x20('+_0x317ef5+_0x5a9645(0x119));}catch(_0x48ca9f){console[_0x5a9645(0xfb)](_0x5a9645(0xbb),_0x48ca9f);}}async[a8_0x1398ca(0xdf)](_0x28301c,_0x46357b){const _0x5ca3ab=a8_0x1398ca;try{const {telegramBotService:_0x1bb738}=await Promise[_0x5ca3ab(0x113)]()[_0x5ca3ab(0xf9)](()=>__importStar(require('../services/telegramBotService'))),_0x4b8ef5={'PAID':_0x5ca3ab(0xfc),'FAILED':_0x5ca3ab(0x102)},_0x17a420=_0x4b8ef5[_0x46357b];if(!_0x17a420)return;await _0x1bb738[_0x5ca3ab(0xdc)](_0x28301c['shopId'],_0x28301c,_0x17a420);}catch(_0x3bc152){console[_0x5ca3ab(0xfb)](_0x5ca3ab(0xf3),_0x3bc152);}}}exports['PaymentController']=PaymentController;