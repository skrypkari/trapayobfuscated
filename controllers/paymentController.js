'use strict';const a8_0x340e4a=a8_0x1009;function a8_0x59e3(){const _0x226e4e=['__setModuleDefault','__createBinding','settings','getPaymentById','webhookLog','createdAt','isArray','__esModule','\x20\x20\x20Return\x20URL:\x20','default','‚úÖ\x20MasterCard\x20payment\x20','getPaymentStatus','Payment\x20processed\x20successfully','stringify','getOwnPropertyNames','__importStar','Card\x20payment\x20failed','40130EtqFWA','failed',',\x20cannot\x20process','sendPaymentStatusNotification','get','defineProperty','call','toLowerCase','üîÑ\x20Updating\x20customer\x20data\x20for\x20payment:\x20','\x20processed:\x20','290574NFDzic','PaymentService','masterCardService','PAID','failureMessage','Payment\x20status\x20is\x20','customerIp','\x20with\x20status\x20','192FdfoYq','log','length','sendPaymentNotification','webhookService','system','createPublicPayment','findUnique','gatewayOrderId','update','1234120IhjNtB','shopId','updatePaymentCustomerDataPublic','ms)','getOwnPropertyDescriptor','../services/telegramBotService','writable','gateway','create','\x20\x20\x20Result\x20URL\x20(webhook):\x20','customerName','customerUa','mastercard_','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','PENDING','Payment\x20not\x20found','final','payment.success','__importDefault','hasOwnProperty','\x20not\x20enabled\x20for\x20shop\x20','error','FAILED','body','successUrl','MasterCardService','sendShopWebhook','threeds_url','includes','now','payment.failed','../services/gateways/mastercardService','updatedAt','toISOString','MasterCard\x20webhook\x20sent\x20to\x20','customerEmail','webhookUrl','1777XkJJir','params','Webhook\x20event\x20','then','27414FxYMfo','paymentService','status','üí≥\x20MasterCard\x20URLs:','1063688jluBUE','json','processCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','amount','5754742fvHGrP','prototype','../config/database','üí≥\x20MasterCard\x20result:','resolve','requires_3ds','payment','üìù\x20Customer\x20data:','webhookEvents','gatewayPaymentId','parse','PaymentController','Failed\x20to\x20send\x20MasterCard\x20webhook:','452rRLDfi','mastercard','POST','584qTLIff','paidAt','gateway_payment_id','Payment\x20failed'];a8_0x59e3=function(){return _0x226e4e;};return a8_0x59e3();}function a8_0x1009(_0x5445cf,_0x505c2f){const _0x59e3fe=a8_0x59e3();return a8_0x1009=function(_0x1009b8,_0x2b96e8){_0x1009b8=_0x1009b8-0xc0;let _0x515e9f=_0x59e3fe[_0x1009b8];return _0x515e9f;},a8_0x1009(_0x5445cf,_0x505c2f);}(function(_0x2366f3,_0x7f1b29){const _0x45476c=a8_0x1009,_0x264678=_0x2366f3();while(!![]){try{const _0x1d8ebf=parseInt(_0x45476c(0x110))/0x1*(-parseInt(_0x45476c(0x12a))/0x2)+parseInt(_0x45476c(0xd9))/0x3+parseInt(_0x45476c(0x118))/0x4+parseInt(_0x45476c(0xcf))/0x5*(-parseInt(_0x45476c(0xe1))/0x6)+parseInt(_0x45476c(0x11d))/0x7+parseInt(_0x45476c(0x12d))/0x8*(-parseInt(_0x45476c(0x114))/0x9)+parseInt(_0x45476c(0xeb))/0xa;if(_0x1d8ebf===_0x7f1b29)break;else _0x264678['push'](_0x264678['shift']());}catch(_0x4f1523){_0x264678['push'](_0x264678['shift']());}}}(a8_0x59e3,0x685f2));var __createBinding=this&&this[a8_0x340e4a(0x132)]||(Object['create']?function(_0x55ac0d,_0x1e6430,_0x1a17dc,_0x3c12dd){const _0x22d8b2=a8_0x340e4a;if(_0x3c12dd===undefined)_0x3c12dd=_0x1a17dc;var _0x592c6f=Object[_0x22d8b2(0xef)](_0x1e6430,_0x1a17dc);(!_0x592c6f||(_0x22d8b2(0xd3)in _0x592c6f?!_0x1e6430['__esModule']:_0x592c6f[_0x22d8b2(0xf1)]||_0x592c6f['configurable']))&&(_0x592c6f={'enumerable':!![],'get':function(){return _0x1e6430[_0x1a17dc];}}),Object['defineProperty'](_0x55ac0d,_0x3c12dd,_0x592c6f);}:function(_0x40e790,_0x387880,_0x144ed4,_0x5b4ad9){if(_0x5b4ad9===undefined)_0x5b4ad9=_0x144ed4;_0x40e790[_0x5b4ad9]=_0x387880[_0x144ed4];}),__setModuleDefault=this&&this[a8_0x340e4a(0x131)]||(Object[a8_0x340e4a(0xf3)]?function(_0x599cea,_0x2aa64a){const _0x3653f8=a8_0x340e4a;Object[_0x3653f8(0xd4)](_0x599cea,_0x3653f8(0xc7),{'enumerable':!![],'value':_0x2aa64a});}:function(_0x3499b9,_0x4033b9){const _0x565d07=a8_0x340e4a;_0x3499b9[_0x565d07(0xc7)]=_0x4033b9;}),__importStar=this&&this[a8_0x340e4a(0xcd)]||(function(){var _0x2d321a=function(_0xfac374){const _0x1c1057=a8_0x1009;return _0x2d321a=Object[_0x1c1057(0xcc)]||function(_0x28ce54){const _0x56bb3f=_0x1c1057;var _0x3d827c=[];for(var _0x5112b4 in _0x28ce54)if(Object[_0x56bb3f(0x11e)][_0x56bb3f(0xfe)][_0x56bb3f(0xd5)](_0x28ce54,_0x5112b4))_0x3d827c[_0x3d827c[_0x56bb3f(0xe3)]]=_0x5112b4;return _0x3d827c;},_0x2d321a(_0xfac374);};return function(_0x3182b4){const _0x30e279=a8_0x1009;if(_0x3182b4&&_0x3182b4[_0x30e279(0xc5)])return _0x3182b4;var _0x408bd3={};if(_0x3182b4!=null){for(var _0x293090=_0x2d321a(_0x3182b4),_0x406f4b=0x0;_0x406f4b<_0x293090['length'];_0x406f4b++)if(_0x293090[_0x406f4b]!==_0x30e279(0xc7))__createBinding(_0x408bd3,_0x3182b4,_0x293090[_0x406f4b]);}return __setModuleDefault(_0x408bd3,_0x3182b4),_0x408bd3;};}()),__importDefault=this&&this[a8_0x340e4a(0xfd)]||function(_0x46fb01){const _0x44f4c5=a8_0x340e4a;return _0x46fb01&&_0x46fb01[_0x44f4c5(0xc5)]?_0x46fb01:{'default':_0x46fb01};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a8_0x340e4a(0x128)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x340e4a(0x10a)),webhookService_1=require('../services/webhookService'),database_1=__importDefault(require(a8_0x340e4a(0x11f)));class PaymentController{constructor(){const _0x56aa3b=a8_0x340e4a;this[_0x56aa3b(0xe7)]=async(_0x3ded3e,_0x4ca178,_0x407c9c)=>{const _0x3057ae=_0x56aa3b;try{const _0x456691=_0x3ded3e[_0x3057ae(0x102)],_0x1dcb01=await this[_0x3057ae(0x115)][_0x3057ae(0xe7)](_0x456691);_0x4ca178[_0x3057ae(0x116)](0xc9)[_0x3057ae(0x119)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x1dcb01});}catch(_0x3984e1){_0x407c9c(_0x3984e1);}},this[_0x56aa3b(0xc9)]=async(_0x7aa97,_0x4c21f6,_0x31347b)=>{const _0x150aaa=_0x56aa3b;try{const {id:_0x17a87d}=_0x7aa97['params'],_0x37353e=await this['paymentService'][_0x150aaa(0xc9)](_0x17a87d);if(!_0x37353e)return _0x4c21f6[_0x150aaa(0x116)](0x194)[_0x150aaa(0x119)]({'success':![],'message':_0x150aaa(0xfa)});_0x4c21f6[_0x150aaa(0x119)]({'success':!![],'result':_0x37353e});}catch(_0x3d1ce8){_0x31347b(_0x3d1ce8);}},this['getPaymentById']=async(_0xb53366,_0x461f3f,_0x3e1c3)=>{const _0x156a2c=_0x56aa3b;try{const {id:_0x3ed5e5}=_0xb53366[_0x156a2c(0x111)],_0x665d84=await this[_0x156a2c(0x115)][_0x156a2c(0xc1)](_0x3ed5e5);if(!_0x665d84)return _0x461f3f[_0x156a2c(0x116)](0x194)[_0x156a2c(0x119)]({'success':![],'message':_0x156a2c(0xfa)});_0x461f3f[_0x156a2c(0x119)]({'success':!![],'result':_0x665d84});}catch(_0x208a7a){_0x3e1c3(_0x208a7a);}},this['updatePaymentCustomer']=async(_0x3bcc10,_0x1d282b,_0x3a8650)=>{const _0x194fd0=_0x56aa3b;try{const {id:_0x1a95e6}=_0x3bcc10[_0x194fd0(0x111)],_0x4617ec=_0x3bcc10['body'];console[_0x194fd0(0xe2)](_0x194fd0(0xd7)+_0x1a95e6),console[_0x194fd0(0xe2)](_0x194fd0(0x124),_0x4617ec);const _0x9f237b=await this[_0x194fd0(0x115)][_0x194fd0(0xed)](_0x1a95e6,_0x4617ec);if(!_0x9f237b)return _0x1d282b[_0x194fd0(0x116)](0x194)[_0x194fd0(0x119)]({'success':![],'message':_0x194fd0(0xfa)});_0x1d282b[_0x194fd0(0x119)]({'success':!![],'message':'Customer\x20data\x20updated\x20successfully','result':{'paymentId':_0x9f237b['id'],'customerIp':_0x9f237b[_0x194fd0(0xdf)],'customerUa':_0x9f237b[_0x194fd0(0xf6)],'customerCountry':_0x9f237b['customerCountry'],'updatedAt':_0x9f237b[_0x194fd0(0x10b)]}});}catch(_0x5812d4){_0x3a8650(_0x5812d4);}},this['processMasterCardPayment']=async(_0x1689da,_0x2a8062,_0x1ebf2c)=>{const _0x54cda8=_0x56aa3b;try{const {id:_0x1c9a82}=_0x1689da[_0x54cda8(0x111)],{cardData:_0x1d8515,cardHolder:_0x4d8655,browser:_0x574e8a}=_0x1689da[_0x54cda8(0x102)];console[_0x54cda8(0xe2)]('üí≥\x20Processing\x20MasterCard\x20payment:\x20'+_0x1c9a82);const _0x762eee=await database_1['default']['payment'][_0x54cda8(0xe8)]({'where':{'id':_0x1c9a82},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x762eee)return _0x2a8062[_0x54cda8(0x116)](0x194)[_0x54cda8(0x119)]({'success':![],'message':'Payment\x20not\x20found'});if(_0x762eee[_0x54cda8(0xf2)]!=='mastercard')return _0x2a8062['status'](0x190)[_0x54cda8(0x119)]({'success':![],'message':'Payment\x20is\x20not\x20for\x20MasterCard\x20gateway'});if(_0x762eee[_0x54cda8(0x116)]!==_0x54cda8(0xf9))return _0x2a8062['status'](0x190)[_0x54cda8(0x119)]({'success':![],'message':_0x54cda8(0xde)+_0x762eee['status']+_0x54cda8(0xd1)});const _0x39553c=_0x54cda8(0x11b),_0x22cad7=_0x762eee[_0x54cda8(0x103)];console[_0x54cda8(0xe2)](_0x54cda8(0x117)),console['log'](_0x54cda8(0xf4)+_0x39553c),console[_0x54cda8(0xe2)](_0x54cda8(0xc6)+_0x22cad7);const _0x237ef4=await this[_0x54cda8(0xdb)][_0x54cda8(0x11a)]({'paymentId':_0x762eee['id'],'orderId':_0x762eee[_0x54cda8(0xe9)]||_0x762eee['id'],'amount':_0x762eee[_0x54cda8(0x11c)],'currency':_0x762eee['currency'],'cardData':_0x1d8515,'resultUrl':_0x39553c,'returnUrl':_0x22cad7,'cardHolder':_0x4d8655,'browser':_0x574e8a});console[_0x54cda8(0xe2)](_0x54cda8(0x120),_0x237ef4);const _0x46ea3b={'status':_0x237ef4[_0x54cda8(0x116)],'updatedAt':new Date(),'statusChangedBy':_0x54cda8(0xe6),'statusChangedAt':new Date()};if(_0x237ef4[_0x54cda8(0x116)]==='PAID')_0x46ea3b[_0x54cda8(0x12e)]=new Date(),_0x46ea3b[_0x54cda8(0x126)]=_0x237ef4[_0x54cda8(0x12f)];else _0x237ef4[_0x54cda8(0x116)]==='FAILED'&&(_0x46ea3b[_0x54cda8(0xdd)]=_0x54cda8(0xce));_0x46ea3b['paymentMethod']=_0x54cda8(0x12b),await database_1[_0x54cda8(0xc7)][_0x54cda8(0x123)][_0x54cda8(0xea)]({'where':{'id':_0x762eee['id']},'data':_0x46ea3b}),await database_1[_0x54cda8(0xc7)][_0x54cda8(0xc2)]['create']({'data':{'paymentId':_0x762eee['id'],'shopId':_0x762eee[_0x54cda8(0xec)],'event':_0x54cda8(0xf7)+_0x237ef4[_0x54cda8(0x116)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x54cda8(0xcb)]({'oldStatus':_0x54cda8(0xf9),'newStatus':_0x237ef4[_0x54cda8(0x116)],'gatewayPaymentId':_0x237ef4[_0x54cda8(0x12f)],'requires3ds':_0x237ef4[_0x54cda8(0x122)],'processedAt':new Date()[_0x54cda8(0x10c)]()})}});_0x237ef4[_0x54cda8(0xfb)]&&(await this[_0x54cda8(0x105)](_0x762eee,_0x237ef4[_0x54cda8(0x116)],_0x237ef4[_0x54cda8(0x12f)]),await this[_0x54cda8(0xd2)](_0x762eee,_0x237ef4['status']));console[_0x54cda8(0xe2)](_0x54cda8(0xc8)+_0x1c9a82+_0x54cda8(0xd8)+_0x237ef4[_0x54cda8(0x116)]);if(_0x237ef4[_0x54cda8(0x116)]===_0x54cda8(0xdc))_0x2a8062['json']({'success':!![],'message':_0x54cda8(0xca),'result':{'status':_0x54cda8(0xdc),'gatewayPaymentId':_0x237ef4[_0x54cda8(0x12f)],'redirectUrl':_0x22cad7,'final':!![]}});else _0x237ef4[_0x54cda8(0x122)]&&_0x237ef4[_0x54cda8(0x106)]?_0x2a8062[_0x54cda8(0x119)]({'success':!![],'message':'3DS\x20verification\x20required','result':{'status':_0x54cda8(0xf9),'gatewayPaymentId':_0x237ef4[_0x54cda8(0x12f)],'redirectUrl':_0x237ef4[_0x54cda8(0x106)],'requires3ds':!![],'final':![]}}):_0x2a8062[_0x54cda8(0x116)](0x190)['json']({'success':![],'message':_0x54cda8(0x130),'result':{'status':_0x54cda8(0x101),'gatewayPaymentId':_0x237ef4['gateway_payment_id'],'redirectUrl':_0x762eee['failUrl'],'final':!![]}});}catch(_0x5bcfe4){_0x1ebf2c(_0x5bcfe4);}},this[_0x56aa3b(0x115)]=new paymentService_1[(_0x56aa3b(0xda))](),this[_0x56aa3b(0xdb)]=new mastercardService_1[(_0x56aa3b(0x104))](),this[_0x56aa3b(0xe5)]=new webhookService_1['WebhookService']();}async[a8_0x340e4a(0x105)](_0x13488d,_0x1c2d74,_0x306d0){const _0x484f33=a8_0x340e4a,_0x1453a1=Date[_0x484f33(0x108)]();try{const _0x537751=_0x13488d['shop'],_0x41de28=_0x537751[_0x484f33(0xc0)];if(!_0x41de28?.[_0x484f33(0x10f)]){console[_0x484f33(0xe2)](_0x484f33(0xf8)+_0x537751['id']);return;}const _0x5bb389=_0x1c2d74===_0x484f33(0xdc)?_0x484f33(0xfc):_0x484f33(0x109);let _0x43d0a9=[];if(_0x41de28[_0x484f33(0x125)])try{_0x43d0a9=Array[_0x484f33(0xc4)](_0x41de28[_0x484f33(0x125)])?_0x41de28[_0x484f33(0x125)]:JSON[_0x484f33(0x127)](_0x41de28[_0x484f33(0x125)]);}catch(_0x3f9fef){console[_0x484f33(0x100)]('Error\x20parsing\x20webhook\x20events:',_0x3f9fef),_0x43d0a9=[];}if(!_0x43d0a9[_0x484f33(0x107)](_0x5bb389)){console[_0x484f33(0xe2)](_0x484f33(0x112)+_0x5bb389+_0x484f33(0xff)+_0x537751['id']);return;}const _0x1d0ca5={'event':_0x5bb389,'payment':{'id':_0x13488d['id'],'order_id':_0x13488d['orderId'],'gateway_order_id':_0x13488d[_0x484f33(0xe9)],'gateway':'1111','amount':_0x13488d[_0x484f33(0x11c)],'currency':_0x13488d['currency'],'status':_0x1c2d74[_0x484f33(0xd6)](),'customer_email':_0x13488d[_0x484f33(0x10e)],'customer_name':_0x13488d[_0x484f33(0xf5)],'gateway_payment_id':_0x306d0,'created_at':_0x13488d[_0x484f33(0xc3)],'updated_at':new Date()}},_0x18c003=await fetch(_0x41de28[_0x484f33(0x10f)],{'method':_0x484f33(0x12c),'headers':{'Content-Type':'application/json','User-Agent':'TesSoft\x20Payment\x20System/1.0\x20(MasterCard)'},'body':JSON[_0x484f33(0xcb)](_0x1d0ca5)}),_0x43b111=Date[_0x484f33(0x108)]()-_0x1453a1;console['log'](_0x484f33(0x10d)+_0x41de28[_0x484f33(0x10f)]+_0x484f33(0xe0)+_0x18c003[_0x484f33(0x116)]+'\x20('+_0x43b111+_0x484f33(0xee));}catch(_0x232590){console[_0x484f33(0x100)](_0x484f33(0x129),_0x232590);}}async[a8_0x340e4a(0xd2)](_0xc3b14b,_0x50e7ec){const _0x58dd9c=a8_0x340e4a;try{const {telegramBotService:_0x178c8b}=await Promise[_0x58dd9c(0x121)]()[_0x58dd9c(0x113)](()=>__importStar(require(_0x58dd9c(0xf0)))),_0x8a8e92={'PAID':'paid','FAILED':_0x58dd9c(0xd0)},_0x3d0859=_0x8a8e92[_0x50e7ec];if(!_0x3d0859)return;await _0x178c8b[_0x58dd9c(0xe4)](_0xc3b14b[_0x58dd9c(0xec)],_0xc3b14b,_0x3d0859);}catch(_0xd5b3da){console[_0x58dd9c(0x100)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0xd5b3da);}}}exports['PaymentController']=PaymentController;