'use strict';const a8_0xf889b0=a8_0x4aae;function a8_0x4aae(_0x526d29,_0xf1fbf4){const _0x7cde8a=a8_0x7cde();return a8_0x4aae=function(_0x4aae91,_0x495379){_0x4aae91=_0x4aae91-0xcf;let _0x1b7f5b=_0x7cde8a[_0x4aae91];return _0x1b7f5b;},a8_0x4aae(_0x526d29,_0xf1fbf4);}(function(_0x16e066,_0x50612c){const _0x25f4b7=a8_0x4aae,_0x4b67d9=_0x16e066();while(!![]){try{const _0x437213=parseInt(_0x25f4b7(0xe2))/0x1+parseInt(_0x25f4b7(0xf5))/0x2*(-parseInt(_0x25f4b7(0x12d))/0x3)+-parseInt(_0x25f4b7(0xf1))/0x4+-parseInt(_0x25f4b7(0x130))/0x5+parseInt(_0x25f4b7(0x107))/0x6*(-parseInt(_0x25f4b7(0x132))/0x7)+-parseInt(_0x25f4b7(0x12a))/0x8*(-parseInt(_0x25f4b7(0xf7))/0x9)+parseInt(_0x25f4b7(0x129))/0xa;if(_0x437213===_0x50612c)break;else _0x4b67d9['push'](_0x4b67d9['shift']());}catch(_0x5a8f53){_0x4b67d9['push'](_0x4b67d9['shift']());}}}(a8_0x7cde,0xdd754));var __createBinding=this&&this['__createBinding']||(Object[a8_0xf889b0(0x117)]?function(_0x3d9368,_0x5aaaf5,_0x530682,_0x558a51){const _0x22c709=a8_0xf889b0;if(_0x558a51===undefined)_0x558a51=_0x530682;var _0x27c089=Object[_0x22c709(0x124)](_0x5aaaf5,_0x530682);(!_0x27c089||(_0x22c709(0x13f)in _0x27c089?!_0x5aaaf5['__esModule']:_0x27c089[_0x22c709(0x13a)]||_0x27c089[_0x22c709(0x115)]))&&(_0x27c089={'enumerable':!![],'get':function(){return _0x5aaaf5[_0x530682];}}),Object[_0x22c709(0x12c)](_0x3d9368,_0x558a51,_0x27c089);}:function(_0x18f612,_0x1ffe3b,_0x1a2e16,_0x123c95){if(_0x123c95===undefined)_0x123c95=_0x1a2e16;_0x18f612[_0x123c95]=_0x1ffe3b[_0x1a2e16];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x1771fa,_0x2ae6a7){const _0x3c8038=a8_0xf889b0;Object[_0x3c8038(0x12c)](_0x1771fa,'default',{'enumerable':!![],'value':_0x2ae6a7});}:function(_0x12f38f,_0x526c7f){const _0x1acd55=a8_0xf889b0;_0x12f38f[_0x1acd55(0xf9)]=_0x526c7f;}),__importStar=this&&this['__importStar']||(function(){var _0x31307e=function(_0xab3e72){const _0x5ecc1d=a8_0x4aae;return _0x31307e=Object[_0x5ecc1d(0x109)]||function(_0xf42ca2){const _0x1aa543=_0x5ecc1d;var _0x47ab0b=[];for(var _0x1543e9 in _0xf42ca2)if(Object['prototype']['hasOwnProperty'][_0x1aa543(0x123)](_0xf42ca2,_0x1543e9))_0x47ab0b[_0x47ab0b[_0x1aa543(0x10f)]]=_0x1543e9;return _0x47ab0b;},_0x31307e(_0xab3e72);};return function(_0x25524e){const _0x1a7374=a8_0x4aae;if(_0x25524e&&_0x25524e[_0x1a7374(0x137)])return _0x25524e;var _0x8dcc7c={};if(_0x25524e!=null){for(var _0x9e941a=_0x31307e(_0x25524e),_0xde0a18=0x0;_0xde0a18<_0x9e941a[_0x1a7374(0x10f)];_0xde0a18++)if(_0x9e941a[_0xde0a18]!==_0x1a7374(0xf9))__createBinding(_0x8dcc7c,_0x25524e,_0x9e941a[_0xde0a18]);}return __setModuleDefault(_0x8dcc7c,_0x25524e),_0x8dcc7c;};}()),__importDefault=this&&this[a8_0xf889b0(0x138)]||function(_0x5cb379){const _0x3f7652=a8_0xf889b0;return _0x5cb379&&_0x5cb379[_0x3f7652(0x137)]?_0x5cb379:{'default':_0x5cb379};};Object[a8_0xf889b0(0x12c)](exports,a8_0xf889b0(0x137),{'value':!![]}),exports['PaymentController']=void 0x0;const paymentService_1=require(a8_0xf889b0(0x10c)),mastercardService_1=require(a8_0xf889b0(0xd7)),webhookService_1=require(a8_0xf889b0(0xe7)),database_1=__importDefault(require(a8_0xf889b0(0x128)));class PaymentController{constructor(){const _0x5cc467=a8_0xf889b0;this['createPublicPayment']=async(_0x52b840,_0x3b7b44,_0x1c2ba4)=>{const _0x3226ab=a8_0x4aae;try{const _0x2696c3=_0x52b840[_0x3226ab(0x134)],_0x3046fa=await this[_0x3226ab(0x127)][_0x3226ab(0xdb)](_0x2696c3);_0x3b7b44[_0x3226ab(0x101)](0xc9)[_0x3226ab(0x11b)]({'success':!![],'message':_0x3226ab(0xd1),'result':_0x3046fa});}catch(_0x4a4cb1){_0x1c2ba4(_0x4a4cb1);}},this[_0x5cc467(0x100)]=async(_0x3decb5,_0x28da1a,_0x40f11c)=>{const _0x1b1744=_0x5cc467;try{const {id:_0x262690}=_0x3decb5['params'],_0x4c28ce=await this[_0x1b1744(0x127)][_0x1b1744(0x100)](_0x262690);if(!_0x4c28ce)return _0x28da1a['status'](0x194)[_0x1b1744(0x11b)]({'success':![],'message':'Payment\x20not\x20found'});_0x28da1a[_0x1b1744(0x11b)]({'success':!![],'result':_0x4c28ce});}catch(_0x22e587){_0x40f11c(_0x22e587);}},this['getPaymentById']=async(_0x6aa33b,_0x1e5e50,_0x37abd4)=>{const _0x19b8d4=_0x5cc467;try{const {id:_0x554fca}=_0x6aa33b[_0x19b8d4(0xd4)],_0x7407a1=await this['paymentService'][_0x19b8d4(0xe0)](_0x554fca);if(!_0x7407a1)return _0x1e5e50[_0x19b8d4(0x101)](0x194)['json']({'success':![],'message':_0x19b8d4(0xf2)});_0x1e5e50[_0x19b8d4(0x11b)]({'success':!![],'result':_0x7407a1});}catch(_0x20fcd7){_0x37abd4(_0x20fcd7);}},this[_0x5cc467(0x102)]=async(_0x309315,_0xce252a,_0x31f7f7)=>{const _0x40fc90=_0x5cc467;try{const {id:_0x61c60b}=_0x309315['params'],_0x891343=_0x309315[_0x40fc90(0x134)];console[_0x40fc90(0xfa)](_0x40fc90(0xff)+_0x61c60b),console[_0x40fc90(0xfa)](_0x40fc90(0xe3),_0x891343);const _0x180a0a=await this[_0x40fc90(0x127)]['updatePaymentCustomerDataPublic'](_0x61c60b,_0x891343);if(!_0x180a0a)return _0xce252a[_0x40fc90(0x101)](0x194)['json']({'success':![],'message':_0x40fc90(0xf2)});_0xce252a[_0x40fc90(0x11b)]({'success':!![],'message':_0x40fc90(0xd3),'result':{'paymentId':_0x180a0a['id'],'customerIp':_0x180a0a[_0x40fc90(0xe4)],'customerUa':_0x180a0a[_0x40fc90(0xef)],'customerCountry':_0x180a0a[_0x40fc90(0x103)],'updatedAt':_0x180a0a[_0x40fc90(0x12f)]}});}catch(_0x106fcb){_0x31f7f7(_0x106fcb);}},this[_0x5cc467(0xd9)]=async(_0x218262,_0x4818de,_0x389118)=>{const _0x13150a=_0x5cc467;try{const {id:_0x849a88}=_0x218262[_0x13150a(0xd4)],{cardData:_0x766873,cardHolder:_0x11b411,browser:_0x2e9126}=_0x218262['body'];console[_0x13150a(0xfa)](_0x13150a(0x145)+_0x849a88);const _0x244b01=await database_1[_0x13150a(0xf9)]['payment'][_0x13150a(0xe5)]({'where':{'id':_0x849a88},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x244b01)return _0x4818de[_0x13150a(0x101)](0x194)[_0x13150a(0x11b)]({'success':![],'message':_0x13150a(0xf2)});if(_0x244b01[_0x13150a(0xeb)]!==_0x13150a(0x11e))return _0x4818de[_0x13150a(0x101)](0x190)['json']({'success':![],'message':_0x13150a(0x12e)});if(_0x244b01['status']!=='PENDING')return _0x4818de[_0x13150a(0x101)](0x190)['json']({'success':![],'message':_0x13150a(0x142)+_0x244b01[_0x13150a(0x101)]+',\x20cannot\x20process'});const _0x26dc62='https://api.trapay.uk/api/webhooks/gateway/mastercard',_0x44e9f1=_0x244b01[_0x13150a(0x120)];console[_0x13150a(0xfa)]('💳\x20MasterCard\x20URLs:'),console[_0x13150a(0xfa)](_0x13150a(0xee)+_0x26dc62),console['log'](_0x13150a(0xd2)+_0x44e9f1);const _0x8270af=await this[_0x13150a(0xdf)][_0x13150a(0xe6)]({'paymentId':_0x244b01['id'],'orderId':_0x244b01[_0x13150a(0xf3)]||_0x244b01['id'],'amount':_0x244b01['amount'],'currency':_0x244b01[_0x13150a(0x13c)],'cardData':_0x766873,'resultUrl':_0x26dc62,'returnUrl':_0x44e9f1,'cardHolder':_0x11b411,'browser':_0x2e9126});console[_0x13150a(0xfa)](_0x13150a(0x131),_0x8270af);const _0x536a45={'status':_0x8270af[_0x13150a(0x101)],'updatedAt':new Date(),'statusChangedBy':_0x13150a(0x110),'statusChangedAt':new Date()};if(_0x8270af['status']===_0x13150a(0xea))_0x536a45[_0x13150a(0xd0)]=new Date(),_0x536a45[_0x13150a(0x121)]=_0x8270af[_0x13150a(0x10d)];else _0x8270af['status']===_0x13150a(0xfc)&&(_0x536a45['failureMessage']='Card\x20payment\x20failed');_0x536a45[_0x13150a(0xcf)]='mastercard',await database_1[_0x13150a(0xf9)][_0x13150a(0xfd)][_0x13150a(0xfb)]({'where':{'id':_0x244b01['id']},'data':_0x536a45}),await database_1[_0x13150a(0xf9)][_0x13150a(0xd6)][_0x13150a(0x117)]({'data':{'paymentId':_0x244b01['id'],'shopId':_0x244b01['shopId'],'event':_0x13150a(0xf8)+_0x8270af[_0x13150a(0x101)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x13150a(0x104)]({'oldStatus':_0x13150a(0xe9),'newStatus':_0x8270af[_0x13150a(0x101)],'gatewayPaymentId':_0x8270af[_0x13150a(0x10d)],'requires3ds':_0x8270af['requires_3ds'],'processedAt':new Date()[_0x13150a(0x12b)]()})}});_0x8270af[_0x13150a(0xfe)]&&(await this[_0x13150a(0x13e)](_0x244b01,_0x8270af[_0x13150a(0x101)],_0x8270af[_0x13150a(0x10d)]),await this[_0x13150a(0x139)](_0x244b01,_0x8270af['status']));console[_0x13150a(0xfa)](_0x13150a(0xf0)+_0x849a88+_0x13150a(0xde)+_0x8270af[_0x13150a(0x101)]);if(_0x8270af[_0x13150a(0x101)]===_0x13150a(0xea))_0x4818de[_0x13150a(0x11b)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x13150a(0xea),'gatewayPaymentId':_0x8270af[_0x13150a(0x10d)],'redirectUrl':_0x44e9f1,'final':!![]}});else _0x8270af[_0x13150a(0x119)]&&_0x8270af[_0x13150a(0x118)]?_0x4818de[_0x13150a(0x11b)]({'success':!![],'message':_0x13150a(0xec),'result':{'status':_0x13150a(0xe9),'gatewayPaymentId':_0x8270af[_0x13150a(0x10d)],'redirectUrl':_0x8270af[_0x13150a(0x118)],'requires3ds':!![],'final':![]}}):_0x4818de['status'](0x190)['json']({'success':![],'message':'Payment\x20failed','result':{'status':_0x13150a(0xfc),'gatewayPaymentId':_0x8270af['gateway_payment_id'],'redirectUrl':_0x244b01[_0x13150a(0x11a)],'final':!![]}});}catch(_0x405db1){_0x389118(_0x405db1);}},this[_0x5cc467(0x127)]=new paymentService_1[(_0x5cc467(0x144))](),this[_0x5cc467(0xdf)]=new mastercardService_1[(_0x5cc467(0xdd))](),this['webhookService']=new webhookService_1[(_0x5cc467(0x10e))]();}async[a8_0xf889b0(0x13e)](_0x58a0d4,_0x36da64,_0x39bbce){const _0x7c8e97=a8_0xf889b0,_0x784ee4=Date['now']();try{const _0x3472db=_0x58a0d4[_0x7c8e97(0xdc)],_0x4fa22c=_0x3472db[_0x7c8e97(0x111)];if(!_0x4fa22c?.[_0x7c8e97(0x11f)]){console['log'](_0x7c8e97(0x125)+_0x3472db['id']);return;}const _0x174927=_0x36da64===_0x7c8e97(0xea)?_0x7c8e97(0x108):'payment.failed';let _0x394a17=[];if(_0x4fa22c['webhookEvents'])try{_0x394a17=Array[_0x7c8e97(0x135)](_0x4fa22c[_0x7c8e97(0x13b)])?_0x4fa22c[_0x7c8e97(0x13b)]:JSON[_0x7c8e97(0x133)](_0x4fa22c['webhookEvents']);}catch(_0x52d503){console[_0x7c8e97(0x105)](_0x7c8e97(0xe8),_0x52d503),_0x394a17=[];}if(!_0x394a17[_0x7c8e97(0x126)](_0x174927)){console[_0x7c8e97(0xfa)]('Webhook\x20event\x20'+_0x174927+_0x7c8e97(0x11d)+_0x3472db['id']);return;}const _0x1476ae={'event':_0x174927,'payment':{'id':_0x58a0d4['id'],'order_id':_0x58a0d4[_0x7c8e97(0x136)],'gateway_order_id':_0x58a0d4[_0x7c8e97(0xf3)],'gateway':_0x7c8e97(0xe1),'amount':_0x58a0d4[_0x7c8e97(0x106)],'currency':_0x58a0d4[_0x7c8e97(0x13c)],'status':_0x36da64[_0x7c8e97(0x10a)](),'customer_email':_0x58a0d4[_0x7c8e97(0xd8)],'customer_name':_0x58a0d4[_0x7c8e97(0xf6)],'gateway_payment_id':_0x39bbce,'created_at':_0x58a0d4[_0x7c8e97(0x140)],'updated_at':new Date()}},_0x51a2fd=await fetch(_0x4fa22c[_0x7c8e97(0x11f)],{'method':_0x7c8e97(0x11c),'headers':{'Content-Type':_0x7c8e97(0xda),'User-Agent':_0x7c8e97(0x114)},'body':JSON['stringify'](_0x1476ae)}),_0x2fb72f=Date[_0x7c8e97(0x113)]()-_0x784ee4;console[_0x7c8e97(0xfa)](_0x7c8e97(0x10b)+_0x4fa22c['webhookUrl']+_0x7c8e97(0x143)+_0x51a2fd[_0x7c8e97(0x101)]+'\x20('+_0x2fb72f+_0x7c8e97(0x112));}catch(_0x425db6){console['error'](_0x7c8e97(0x146),_0x425db6);}}async[a8_0xf889b0(0x139)](_0x232a22,_0x4b11bf){const _0x40e6c6=a8_0xf889b0;try{const {telegramBotService:_0x3c1241}=await Promise[_0x40e6c6(0x141)]()[_0x40e6c6(0xf4)](()=>__importStar(require('../services/telegramBotService'))),_0x2034f6={'PAID':_0x40e6c6(0x13d),'FAILED':_0x40e6c6(0xd5)},_0x3656c6=_0x2034f6[_0x4b11bf];if(!_0x3656c6)return;await _0x3c1241['sendPaymentNotification'](_0x232a22[_0x40e6c6(0x122)],_0x232a22,_0x3656c6);}catch(_0xcd2785){console[_0x40e6c6(0x105)](_0x40e6c6(0x116),_0xcd2785);}}}function a8_0x7cde(){const _0x35f38a=['processMasterCardPayment','application/json','createPublicPayment','shop','MasterCardService','\x20processed:\x20','masterCardService','getPaymentById','1111','1392303DjyEmi','📝\x20Customer\x20data:','customerIp','findUnique','processCardPayment','../services/webhookService','Error\x20parsing\x20webhook\x20events:','PENDING','PAID','gateway','3DS\x20verification\x20required','PaymentController','\x20\x20\x20Result\x20URL\x20(webhook):\x20','customerUa','✅\x20MasterCard\x20payment\x20','1795060nTWKGi','Payment\x20not\x20found','gatewayOrderId','then','10shmvzS','customerName','9hqMtuM','mastercard_','default','log','update','FAILED','payment','final','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','getPaymentStatus','status','updatePaymentCustomer','customerCountry','stringify','error','amount','7900188pMGPBX','payment.success','getOwnPropertyNames','toLowerCase','MasterCard\x20webhook\x20sent\x20to\x20','../services/paymentService','gateway_payment_id','WebhookService','length','system','settings','ms)','now','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','configurable','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','create','threeds_url','requires_3ds','failUrl','json','POST','\x20not\x20enabled\x20for\x20shop\x20','mastercard','webhookUrl','successUrl','gatewayPaymentId','shopId','call','getOwnPropertyDescriptor','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','includes','paymentService','../config/database','32352600wafZwg','5565752HCjIGk','toISOString','defineProperty','1054695ZqHalU','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','updatedAt','4464510HgQCvE','💳\x20MasterCard\x20result:','7sFhmwf','parse','body','isArray','orderId','__esModule','__importDefault','sendPaymentStatusNotification','writable','webhookEvents','currency','paid','sendShopWebhook','get','createdAt','resolve','Payment\x20status\x20is\x20','\x20with\x20status\x20','PaymentService','💳\x20Processing\x20MasterCard\x20payment:\x20','Failed\x20to\x20send\x20MasterCard\x20webhook:','paymentMethod','paidAt','Payment\x20created\x20successfully','\x20\x20\x20Return\x20URL:\x20','Customer\x20data\x20updated\x20successfully','params','failed','webhookLog','../services/gateways/mastercardService','customerEmail'];a8_0x7cde=function(){return _0x35f38a;};return a8_0x7cde();}exports[a8_0xf889b0(0xed)]=PaymentController;