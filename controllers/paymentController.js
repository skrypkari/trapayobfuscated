'use strict';const a8_0x41b90f=a8_0x25c4;(function(_0x46d296,_0x2e5b17){const _0x453359=a8_0x25c4,_0x5af47f=_0x46d296();while(!![]){try{const _0x51730c=parseInt(_0x453359(0x1d8))/0x1+-parseInt(_0x453359(0x1fe))/0x2*(-parseInt(_0x453359(0x236))/0x3)+-parseInt(_0x453359(0x1eb))/0x4+-parseInt(_0x453359(0x217))/0x5+-parseInt(_0x453359(0x23c))/0x6*(parseInt(_0x453359(0x1e1))/0x7)+-parseInt(_0x453359(0x242))/0x8+parseInt(_0x453359(0x1fd))/0x9;if(_0x51730c===_0x2e5b17)break;else _0x5af47f['push'](_0x5af47f['shift']());}catch(_0xa12575){_0x5af47f['push'](_0x5af47f['shift']());}}}(a8_0x4949,0x7eccf));function a8_0x25c4(_0x3180e4,_0x1b2753){const _0x494969=a8_0x4949();return a8_0x25c4=function(_0x25c45c,_0x44bce2){_0x25c45c=_0x25c45c-0x1cf;let _0x3171d8=_0x494969[_0x25c45c];return _0x3171d8;},a8_0x25c4(_0x3180e4,_0x1b2753);}var __createBinding=this&&this['__createBinding']||(Object[a8_0x41b90f(0x21f)]?function(_0x3d8a16,_0x5e6e62,_0x484fc8,_0x5b7478){const _0x1ab14c=a8_0x41b90f;if(_0x5b7478===undefined)_0x5b7478=_0x484fc8;var _0x4eb891=Object[_0x1ab14c(0x216)](_0x5e6e62,_0x484fc8);(!_0x4eb891||(_0x1ab14c(0x22e)in _0x4eb891?!_0x5e6e62[_0x1ab14c(0x244)]:_0x4eb891[_0x1ab14c(0x201)]||_0x4eb891[_0x1ab14c(0x22f)]))&&(_0x4eb891={'enumerable':!![],'get':function(){return _0x5e6e62[_0x484fc8];}}),Object[_0x1ab14c(0x204)](_0x3d8a16,_0x5b7478,_0x4eb891);}:function(_0x431a36,_0x5c3627,_0x41d60b,_0x257887){if(_0x257887===undefined)_0x257887=_0x41d60b;_0x431a36[_0x257887]=_0x5c3627[_0x41d60b];}),__setModuleDefault=this&&this[a8_0x41b90f(0x1ed)]||(Object['create']?function(_0xa0fae9,_0x3eb587){const _0xf89b41=a8_0x41b90f;Object[_0xf89b41(0x204)](_0xa0fae9,_0xf89b41(0x210),{'enumerable':!![],'value':_0x3eb587});}:function(_0x30f072,_0xa15ed4){_0x30f072['default']=_0xa15ed4;}),__importStar=this&&this[a8_0x41b90f(0x1fa)]||(function(){var _0x4dda4d=function(_0x179c03){const _0x2dfeca=a8_0x25c4;return _0x4dda4d=Object[_0x2dfeca(0x247)]||function(_0x4c8a89){const _0xd33975=_0x2dfeca;var _0x4cf969=[];for(var _0xb39f9d in _0x4c8a89)if(Object['prototype'][_0xd33975(0x205)][_0xd33975(0x24d)](_0x4c8a89,_0xb39f9d))_0x4cf969[_0x4cf969['length']]=_0xb39f9d;return _0x4cf969;},_0x4dda4d(_0x179c03);};return function(_0x5881e4){const _0x28b7e2=a8_0x25c4;if(_0x5881e4&&_0x5881e4['__esModule'])return _0x5881e4;var _0x59500b={};if(_0x5881e4!=null){for(var _0xb8b137=_0x4dda4d(_0x5881e4),_0xea170f=0x0;_0xea170f<_0xb8b137[_0x28b7e2(0x1f1)];_0xea170f++)if(_0xb8b137[_0xea170f]!==_0x28b7e2(0x210))__createBinding(_0x59500b,_0x5881e4,_0xb8b137[_0xea170f]);}return __setModuleDefault(_0x59500b,_0x5881e4),_0x59500b;};}()),__importDefault=this&&this[a8_0x41b90f(0x221)]||function(_0x4d0786){return _0x4d0786&&_0x4d0786['__esModule']?_0x4d0786:{'default':_0x4d0786};};Object['defineProperty'](exports,a8_0x41b90f(0x244),{'value':!![]}),exports[a8_0x41b90f(0x215)]=void 0x0;const paymentService_1=require(a8_0x41b90f(0x1d2)),mastercardService_1=require(a8_0x41b90f(0x23b)),webhookService_1=require(a8_0x41b90f(0x213)),database_1=__importDefault(require(a8_0x41b90f(0x208)));function a8_0x4949(){const _0x13753a=['sendShopWebhook','json','1111','getPaymentStatus','Webhook\x20event\x20','373968xGEZlc','gateway_payment_id','__setModuleDefault','https://api.trapay.uk/api/webhooks/gateway/mastercard','\x20\x20\x20Result\x20URL\x20(webhook):\x20','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','length','processCardPayment','replace','MasterCardService','\x20processed:\x20','mastercard','Customer\x20data\x20updated\x20successfully','error','toISOString','__importStar','\x20\x20\x20Return\x20URL:\x20','processMasterCardPayment','7673841JmYXhc','9368mRKRqV','system','log','writable','currency','threeds_url','defineProperty','hasOwnProperty','customerName','webhookEvents','../config/database','final','user_agent','../services/paymentLinkService','FAILED','slice','💳\x20Processing\x20MasterCard\x20payment:\x20','parse','default','status','paymentService','../services/webhookService','stringify','PaymentController','getOwnPropertyDescriptor','3317380Ojimzf','last_name','customerEmail','WebhookService','Error\x20parsing\x20webhook\x20events:','shopId','💳\x20MasterCard\x20URLs:','masterCardService','create','\x20not\x20enabled\x20for\x20shop\x20','__importDefault','webhookService','body','isArray','💳\x20MasterCard\x20result:','includes','payment','updatedAt','🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20','sendPaymentStatusNotification','failureMessage','updatePaymentCustomer','📈\x20MasterCard\x20payment\x20','get','configurable','Payment\x20status\x20is\x20','✅\x20MasterCard\x20payment\x20','cardLast4','toLowerCase','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','number','390qFcEvv','mastercard_','PENDING','then','amount','../services/gateways/mastercardService','4458bprMwL','PAID','ms)','customerUa','paidAt','Payment\x20failed','6806568aNYHMf','Payment\x20created\x20successfully','__esModule','webhookLog','3DS\x20verification\x20required','getOwnPropertyNames','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','paymentMethod','webhookUrl','resolve','failed','call','payment.success','\x20with\x20status\x20','now','📝\x20Customer\x20data:','💳\x20Card\x20holder:\x20','../services/paymentService','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','orderId','MasterCard\x20webhook\x20sent\x20to\x20','gatewayPaymentId','customerCountry','811966ndwTHF','update','country','Payment\x20not\x20found','paid','email','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','gatewayOrderId','params','1379wfeccj','payment.failed','shop','getPaymentById','POST'];a8_0x4949=function(){return _0x13753a;};return a8_0x4949();}class PaymentController{constructor(){const _0x393d45=a8_0x41b90f;this['createPublicPayment']=async(_0x4cbb37,_0x68eb21,_0x1d10b8)=>{const _0x3defbe=a8_0x25c4;try{const _0x2d7026=_0x4cbb37[_0x3defbe(0x223)],_0x4534d8=await this[_0x3defbe(0x212)]['createPublicPayment'](_0x2d7026);_0x68eb21['status'](0xc9)[_0x3defbe(0x1e7)]({'success':!![],'message':_0x3defbe(0x243),'result':_0x4534d8});}catch(_0x47a7ea){_0x1d10b8(_0x47a7ea);}},this[_0x393d45(0x1e9)]=async(_0x1ed68a,_0x28d080,_0x277bc5)=>{const _0x1212f8=_0x393d45;try{const {id:_0x441cb0}=_0x1ed68a[_0x1212f8(0x1e0)],_0x567ec0=await this[_0x1212f8(0x212)][_0x1212f8(0x1e9)](_0x441cb0);if(!_0x567ec0)return _0x28d080[_0x1212f8(0x211)](0x194)['json']({'success':![],'message':_0x1212f8(0x1db)});_0x28d080[_0x1212f8(0x1e7)]({'success':!![],'result':_0x567ec0});}catch(_0x5f3ea4){_0x277bc5(_0x5f3ea4);}},this[_0x393d45(0x1e4)]=async(_0xbbd89b,_0x3e6693,_0x2e362b)=>{const _0x56dd78=_0x393d45;try{const {id:_0x885f80}=_0xbbd89b['params'],_0x438292=await this[_0x56dd78(0x212)][_0x56dd78(0x1e4)](_0x885f80);if(!_0x438292)return _0x3e6693[_0x56dd78(0x211)](0x194)[_0x56dd78(0x1e7)]({'success':![],'message':'Payment\x20not\x20found'});_0x3e6693[_0x56dd78(0x1e7)]({'success':!![],'result':_0x438292});}catch(_0x46f718){_0x2e362b(_0x46f718);}},this[_0x393d45(0x22c)]=async(_0x531c7e,_0x464d87,_0x5c80a3)=>{const _0xdcec03=_0x393d45;try{const {id:_0x3f8d1b}=_0x531c7e[_0xdcec03(0x1e0)],_0x5dad4e=_0x531c7e[_0xdcec03(0x223)];console[_0xdcec03(0x200)](_0xdcec03(0x229)+_0x3f8d1b),console['log'](_0xdcec03(0x1d0),_0x5dad4e);const _0x2786f2=await this[_0xdcec03(0x212)]['updatePaymentCustomerDataPublic'](_0x3f8d1b,_0x5dad4e);if(!_0x2786f2)return _0x464d87[_0xdcec03(0x211)](0x194)[_0xdcec03(0x1e7)]({'success':![],'message':'Payment\x20not\x20found'});_0x464d87['json']({'success':!![],'message':_0xdcec03(0x1f7),'result':{'paymentId':_0x2786f2['id'],'customerIp':_0x2786f2['customerIp'],'customerUa':_0x2786f2[_0xdcec03(0x23f)],'customerCountry':_0x2786f2[_0xdcec03(0x1d7)],'updatedAt':_0x2786f2[_0xdcec03(0x228)]}});}catch(_0x1dfccf){_0x5c80a3(_0x1dfccf);}},this[_0x393d45(0x1fc)]=async(_0x1e8d90,_0x4234d6,_0x1daad9)=>{const _0x1dcf38=_0x393d45;try{const {id:_0x1195c0}=_0x1e8d90[_0x1dcf38(0x1e0)],{cardData:_0x4263de,cardHolder:_0x1af6b3,browser:_0x42e706}=_0x1e8d90[_0x1dcf38(0x223)];console[_0x1dcf38(0x200)](_0x1dcf38(0x20e)+_0x1195c0),console[_0x1dcf38(0x200)](_0x1dcf38(0x1d1)+_0x1af6b3['first_name']+'\x20'+_0x1af6b3[_0x1dcf38(0x218)]+'\x20('+_0x1af6b3[_0x1dcf38(0x1dd)]+')'),console[_0x1dcf38(0x200)]('💳\x20Browser\x20IP:\x20'+_0x42e706['ip']);const _0x3de839={'customerName':_0x1af6b3['first_name']+'\x20'+_0x1af6b3['last_name'],'customerEmail':_0x1af6b3[_0x1dcf38(0x1dd)],'customerIp':_0x42e706['ip'],'customerUa':_0x42e706[_0x1dcf38(0x20a)],'customerCountry':_0x1af6b3[_0x1dcf38(0x1da)]||null},_0x189c30=await database_1[_0x1dcf38(0x210)][_0x1dcf38(0x227)]['findUnique']({'where':{'id':_0x1195c0},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x189c30)return _0x4234d6[_0x1dcf38(0x211)](0x194)[_0x1dcf38(0x1e7)]({'success':![],'message':_0x1dcf38(0x1db)});if(_0x189c30['gateway']!==_0x1dcf38(0x1f6))return _0x4234d6['status'](0x190)['json']({'success':![],'message':_0x1dcf38(0x1d3)});if(_0x189c30[_0x1dcf38(0x211)]!==_0x1dcf38(0x238))return _0x4234d6[_0x1dcf38(0x211)](0x190)[_0x1dcf38(0x1e7)]({'success':![],'message':_0x1dcf38(0x230)+_0x189c30['status']+',\x20cannot\x20process'});await database_1[_0x1dcf38(0x210)]['payment'][_0x1dcf38(0x1d9)]({'where':{'id':_0x1195c0},'data':{..._0x3de839,'updatedAt':new Date()}});const _0x168d41=_0x1dcf38(0x1ee),_0x3c043c=_0x189c30['successUrl'];console['log'](_0x1dcf38(0x21d)),console['log'](_0x1dcf38(0x1ef)+_0x168d41),console[_0x1dcf38(0x200)](_0x1dcf38(0x1fb)+_0x3c043c);const _0x5dfb0b={'first_name':_0x1af6b3['first_name'],'last_name':_0x1af6b3[_0x1dcf38(0x218)],'email':_0x1af6b3['email']},_0x15e6cc=await this[_0x1dcf38(0x21e)][_0x1dcf38(0x1f2)]({'paymentId':_0x189c30['id'],'orderId':_0x189c30[_0x1dcf38(0x1df)]||_0x189c30['id'],'amount':_0x189c30[_0x1dcf38(0x23a)],'currency':_0x189c30[_0x1dcf38(0x202)],'cardData':_0x4263de,'resultUrl':_0x168d41,'returnUrl':_0x3c043c,'cardHolder':_0x5dfb0b,'browser':_0x42e706});console[_0x1dcf38(0x200)](_0x1dcf38(0x225),_0x15e6cc);const _0x9b4c83={'status':_0x15e6cc[_0x1dcf38(0x211)],'updatedAt':new Date(),'statusChangedBy':_0x1dcf38(0x1ff),'statusChangedAt':new Date()};if(_0x15e6cc[_0x1dcf38(0x211)]===_0x1dcf38(0x23d))_0x9b4c83[_0x1dcf38(0x240)]=new Date(),_0x9b4c83[_0x1dcf38(0x1d6)]=_0x15e6cc[_0x1dcf38(0x1ec)];else _0x15e6cc[_0x1dcf38(0x211)]==='FAILED'&&(_0x9b4c83[_0x1dcf38(0x22b)]='Card\x20payment\x20failed');_0x9b4c83[_0x1dcf38(0x249)]=_0x1dcf38(0x1f6);if(_0x4263de[_0x1dcf38(0x235)]){const _0x53fd16=_0x4263de[_0x1dcf38(0x235)][_0x1dcf38(0x1f3)](/[\s-]/g,'');_0x9b4c83['cardLast4']=_0x53fd16[_0x1dcf38(0x20d)](-0x4),console[_0x1dcf38(0x200)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x9b4c83[_0x1dcf38(0x232)]);}await database_1['default'][_0x1dcf38(0x227)][_0x1dcf38(0x1d9)]({'where':{'id':_0x189c30['id']},'data':_0x9b4c83}),await database_1[_0x1dcf38(0x210)][_0x1dcf38(0x245)][_0x1dcf38(0x21f)]({'data':{'paymentId':_0x189c30['id'],'shopId':_0x189c30[_0x1dcf38(0x21c)],'event':_0x1dcf38(0x237)+_0x15e6cc[_0x1dcf38(0x211)]?.['toLowerCase'](),'statusCode':0xc8,'responseBody':JSON[_0x1dcf38(0x214)]({'oldStatus':_0x1dcf38(0x238),'newStatus':_0x15e6cc[_0x1dcf38(0x211)],'gatewayPaymentId':_0x15e6cc[_0x1dcf38(0x1ec)],'requires3ds':_0x15e6cc['requires_3ds'],'processedAt':new Date()[_0x1dcf38(0x1f9)]()})}});if(_0x15e6cc[_0x1dcf38(0x209)]){await this[_0x1dcf38(0x1e6)](_0x189c30,_0x15e6cc[_0x1dcf38(0x211)],_0x15e6cc['gateway_payment_id']),await this['sendPaymentStatusNotification'](_0x189c30,_0x15e6cc['status']);if(_0x15e6cc[_0x1dcf38(0x211)]===_0x1dcf38(0x23d)){console['log'](_0x1dcf38(0x22d)+_0x1195c0+_0x1dcf38(0x1f0));try{const {PaymentLinkService:_0x1b8e49}=await Promise[_0x1dcf38(0x24b)]()[_0x1dcf38(0x239)](()=>__importStar(require(_0x1dcf38(0x20b)))),_0x4b7fb9=new _0x1b8e49();await _0x4b7fb9['handleSuccessfulPayment'](_0x1195c0),console[_0x1dcf38(0x200)](_0x1dcf38(0x234)+_0x1195c0);}catch(_0xabf262){console['error'](_0x1dcf38(0x1de),_0xabf262);}}}console[_0x1dcf38(0x200)](_0x1dcf38(0x231)+_0x1195c0+_0x1dcf38(0x1f5)+_0x15e6cc[_0x1dcf38(0x211)]);if(_0x15e6cc['status']===_0x1dcf38(0x23d))_0x4234d6[_0x1dcf38(0x1e7)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':'PAID','gatewayPaymentId':_0x15e6cc['gateway_payment_id'],'redirectUrl':_0x3c043c,'final':!![]}});else _0x15e6cc['requires_3ds']&&_0x15e6cc[_0x1dcf38(0x203)]?_0x4234d6['json']({'success':!![],'message':_0x1dcf38(0x246),'result':{'status':'PENDING','gatewayPaymentId':_0x15e6cc[_0x1dcf38(0x1ec)],'redirectUrl':_0x15e6cc['threeds_url'],'requires3ds':!![],'final':![]}}):_0x4234d6['status'](0x190)[_0x1dcf38(0x1e7)]({'success':![],'message':_0x1dcf38(0x241),'result':{'status':_0x1dcf38(0x20c),'gatewayPaymentId':_0x15e6cc[_0x1dcf38(0x1ec)],'redirectUrl':_0x189c30['failUrl'],'final':!![]}});}catch(_0xc40e17){_0x1daad9(_0xc40e17);}},this[_0x393d45(0x212)]=new paymentService_1['PaymentService'](),this['masterCardService']=new mastercardService_1[(_0x393d45(0x1f4))](),this[_0x393d45(0x222)]=new webhookService_1[(_0x393d45(0x21a))]();}async[a8_0x41b90f(0x1e6)](_0x225ca2,_0x80ab9f,_0x136e05){const _0x5ab75e=a8_0x41b90f,_0x1ae47c=Date['now']();try{const _0x527853=_0x225ca2[_0x5ab75e(0x1e3)],_0x5ccd4e=_0x527853['settings'];if(!_0x5ccd4e?.[_0x5ab75e(0x24a)]){console[_0x5ab75e(0x200)]('No\x20webhook\x20URL\x20configured\x20for\x20shop\x20'+_0x527853['id']);return;}const _0x7d7a75=_0x80ab9f===_0x5ab75e(0x23d)?_0x5ab75e(0x24e):_0x5ab75e(0x1e2);let _0x1acb77=[];if(_0x5ccd4e[_0x5ab75e(0x207)])try{_0x1acb77=Array[_0x5ab75e(0x224)](_0x5ccd4e['webhookEvents'])?_0x5ccd4e[_0x5ab75e(0x207)]:JSON[_0x5ab75e(0x20f)](_0x5ccd4e[_0x5ab75e(0x207)]);}catch(_0x2824ad){console[_0x5ab75e(0x1f8)](_0x5ab75e(0x21b),_0x2824ad),_0x1acb77=[];}if(!_0x1acb77[_0x5ab75e(0x226)](_0x7d7a75)){console[_0x5ab75e(0x200)](_0x5ab75e(0x1ea)+_0x7d7a75+_0x5ab75e(0x220)+_0x527853['id']);return;}const _0x54dcb5={'event':_0x7d7a75,'payment':{'id':_0x225ca2['id'],'order_id':_0x225ca2[_0x5ab75e(0x1d4)],'gateway_order_id':_0x225ca2[_0x5ab75e(0x1df)],'gateway':_0x5ab75e(0x1e8),'amount':_0x225ca2['amount'],'currency':_0x225ca2['currency'],'status':_0x80ab9f[_0x5ab75e(0x233)](),'customer_email':_0x225ca2[_0x5ab75e(0x219)],'customer_name':_0x225ca2[_0x5ab75e(0x206)],'gateway_payment_id':_0x136e05,'created_at':_0x225ca2['createdAt'],'updated_at':new Date()}},_0x2098f1=await fetch(_0x5ccd4e[_0x5ab75e(0x24a)],{'method':_0x5ab75e(0x1e5),'headers':{'Content-Type':'application/json','User-Agent':_0x5ab75e(0x248)},'body':JSON[_0x5ab75e(0x214)](_0x54dcb5)}),_0x598a42=Date[_0x5ab75e(0x1cf)]()-_0x1ae47c;console[_0x5ab75e(0x200)](_0x5ab75e(0x1d5)+_0x5ccd4e[_0x5ab75e(0x24a)]+_0x5ab75e(0x24f)+_0x2098f1[_0x5ab75e(0x211)]+'\x20('+_0x598a42+_0x5ab75e(0x23e));}catch(_0x43c69d){console['error']('Failed\x20to\x20send\x20MasterCard\x20webhook:',_0x43c69d);}}async[a8_0x41b90f(0x22a)](_0x5cb629,_0xb0f1af){const _0x3a0f85=a8_0x41b90f;try{const {telegramBotService:_0x2f287e}=await Promise[_0x3a0f85(0x24b)]()[_0x3a0f85(0x239)](()=>__importStar(require('../services/telegramBotService'))),_0x2b7aeb={'PAID':_0x3a0f85(0x1dc),'FAILED':_0x3a0f85(0x24c)},_0x40453d=_0x2b7aeb[_0xb0f1af];if(!_0x40453d)return;await _0x2f287e['sendPaymentNotification'](_0x5cb629[_0x3a0f85(0x21c)],_0x5cb629,_0x40453d);}catch(_0x3a88bc){console[_0x3a0f85(0x1f8)]('Failed\x20to\x20send\x20Telegram\x20payment\x20notification:',_0x3a88bc);}}}exports[a8_0x41b90f(0x215)]=PaymentController;