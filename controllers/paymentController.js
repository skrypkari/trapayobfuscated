'use strict';const a8_0x3378a3=a8_0xb9c1;(function(_0x60b736,_0x7af5fa){const _0x522ce5=a8_0xb9c1,_0xeea5eb=_0x60b736();while(!![]){try{const _0x547538=-parseInt(_0x522ce5(0x1ec))/0x1+-parseInt(_0x522ce5(0x1c8))/0x2+parseInt(_0x522ce5(0x1d5))/0x3+-parseInt(_0x522ce5(0x205))/0x4*(parseInt(_0x522ce5(0x1e3))/0x5)+-parseInt(_0x522ce5(0x1a5))/0x6*(parseInt(_0x522ce5(0x1b2))/0x7)+parseInt(_0x522ce5(0x204))/0x8*(parseInt(_0x522ce5(0x1df))/0x9)+parseInt(_0x522ce5(0x1c3))/0xa*(parseInt(_0x522ce5(0x1b4))/0xb);if(_0x547538===_0x7af5fa)break;else _0xeea5eb['push'](_0xeea5eb['shift']());}catch(_0x255186){_0xeea5eb['push'](_0xeea5eb['shift']());}}}(a8_0x29f1,0x86f6f));function a8_0xb9c1(_0x32a383,_0x3c6b6a){const _0x29f1bd=a8_0x29f1();return a8_0xb9c1=function(_0xb9c12c,_0x360ee3){_0xb9c12c=_0xb9c12c-0x19c;let _0x2e056d=_0x29f1bd[_0xb9c12c];return _0x2e056d;},a8_0xb9c1(_0x32a383,_0x3c6b6a);}var __createBinding=this&&this[a8_0x3378a3(0x21a)]||(Object[a8_0x3378a3(0x19e)]?function(_0x2f8d00,_0x18e9b1,_0x165c5c,_0x3b86a1){const _0x4331f1=a8_0x3378a3;if(_0x3b86a1===undefined)_0x3b86a1=_0x165c5c;var _0x3ba690=Object[_0x4331f1(0x1f4)](_0x18e9b1,_0x165c5c);(!_0x3ba690||(_0x4331f1(0x207)in _0x3ba690?!_0x18e9b1[_0x4331f1(0x1d1)]:_0x3ba690[_0x4331f1(0x1fb)]||_0x3ba690[_0x4331f1(0x1dd)]))&&(_0x3ba690={'enumerable':!![],'get':function(){return _0x18e9b1[_0x165c5c];}}),Object['defineProperty'](_0x2f8d00,_0x3b86a1,_0x3ba690);}:function(_0x3f9e1a,_0x9884d4,_0x3efa46,_0x28a9c2){if(_0x28a9c2===undefined)_0x28a9c2=_0x3efa46;_0x3f9e1a[_0x28a9c2]=_0x9884d4[_0x3efa46];}),__setModuleDefault=this&&this[a8_0x3378a3(0x218)]||(Object[a8_0x3378a3(0x19e)]?function(_0x4ff035,_0x26921f){const _0xe3e66e=a8_0x3378a3;Object[_0xe3e66e(0x21b)](_0x4ff035,_0xe3e66e(0x1e5),{'enumerable':!![],'value':_0x26921f});}:function(_0x27b425,_0x1b019b){_0x27b425['default']=_0x1b019b;}),__importStar=this&&this[a8_0x3378a3(0x1c1)]||(function(){var _0x465d6b=function(_0x5435f8){return _0x465d6b=Object['getOwnPropertyNames']||function(_0x2153dd){const _0x295e66=a8_0xb9c1;var _0x1685f0=[];for(var _0x139d5 in _0x2153dd)if(Object['prototype']['hasOwnProperty'][_0x295e66(0x1e8)](_0x2153dd,_0x139d5))_0x1685f0[_0x1685f0['length']]=_0x139d5;return _0x1685f0;},_0x465d6b(_0x5435f8);};return function(_0x2d0e40){const _0x4095bd=a8_0xb9c1;if(_0x2d0e40&&_0x2d0e40['__esModule'])return _0x2d0e40;var _0xcd24cc={};if(_0x2d0e40!=null){for(var _0x19e509=_0x465d6b(_0x2d0e40),_0x2af75e=0x0;_0x2af75e<_0x19e509[_0x4095bd(0x1da)];_0x2af75e++)if(_0x19e509[_0x2af75e]!==_0x4095bd(0x1e5))__createBinding(_0xcd24cc,_0x2d0e40,_0x19e509[_0x2af75e]);}return __setModuleDefault(_0xcd24cc,_0x2d0e40),_0xcd24cc;};}()),__importDefault=this&&this['__importDefault']||function(_0x340f6a){const _0x47a90c=a8_0x3378a3;return _0x340f6a&&_0x340f6a[_0x47a90c(0x1d1)]?_0x340f6a:{'default':_0x340f6a};};Object[a8_0x3378a3(0x21b)](exports,a8_0x3378a3(0x1d1),{'value':!![]}),exports[a8_0x3378a3(0x1e7)]=void 0x0;const paymentService_1=require('../services/paymentService'),mastercardService_1=require(a8_0x3378a3(0x1e1)),webhookService_1=require(a8_0x3378a3(0x1f9)),database_1=__importDefault(require(a8_0x3378a3(0x1ad)));class PaymentController{constructor(){const _0x1bfcc8=a8_0x3378a3;this['createPublicPayment']=async(_0x31c504,_0x2e9ef0,_0x4a970f)=>{const _0x1b7ff9=a8_0xb9c1;try{const _0x57041a=_0x31c504[_0x1b7ff9(0x1fd)],_0x2b7193=await this[_0x1b7ff9(0x1a9)][_0x1b7ff9(0x1a0)](_0x57041a);_0x2e9ef0[_0x1b7ff9(0x202)](0xc9)[_0x1b7ff9(0x1f6)]({'success':!![],'message':'Payment\x20created\x20successfully','result':_0x2b7193});}catch(_0x113a20){_0x4a970f(_0x113a20);}},this[_0x1bfcc8(0x1d0)]=async(_0xae3b3a,_0x9f02bd,_0x2bed2b)=>{const _0x5f2309=_0x1bfcc8;try{const {id:_0x98d60d}=_0xae3b3a[_0x5f2309(0x1c6)],_0x136fce=await this[_0x5f2309(0x1a9)][_0x5f2309(0x1d0)](_0x98d60d);if(!_0x136fce)return _0x9f02bd[_0x5f2309(0x202)](0x194)['json']({'success':![],'message':_0x5f2309(0x1ce)});_0x9f02bd['json']({'success':!![],'result':_0x136fce});}catch(_0x14af16){_0x2bed2b(_0x14af16);}},this[_0x1bfcc8(0x219)]=async(_0x16ac4f,_0x4b58af,_0x1ea80c)=>{const _0x29f4de=_0x1bfcc8;try{const {id:_0x14722a}=_0x16ac4f[_0x29f4de(0x1c6)],_0x484af7=await this[_0x29f4de(0x1a9)][_0x29f4de(0x219)](_0x14722a);if(!_0x484af7)return _0x4b58af[_0x29f4de(0x202)](0x194)[_0x29f4de(0x1f6)]({'success':![],'message':_0x29f4de(0x1ce)});_0x4b58af['json']({'success':!![],'result':_0x484af7});}catch(_0x4a8ab8){_0x1ea80c(_0x4a8ab8);}},this[_0x1bfcc8(0x1cc)]=async(_0x4aca43,_0x5af356,_0x6c3a3e)=>{const _0x260f1b=_0x1bfcc8;try{const {id:_0x45c6e7}=_0x4aca43[_0x260f1b(0x1c6)],_0x38446e=_0x4aca43['body'];console[_0x260f1b(0x1ee)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x45c6e7),console['log'](_0x260f1b(0x1eb),_0x38446e);const _0x5de894=await this[_0x260f1b(0x1a9)][_0x260f1b(0x1d4)](_0x45c6e7,_0x38446e);if(!_0x5de894)return _0x5af356[_0x260f1b(0x202)](0x194)['json']({'success':![],'message':_0x260f1b(0x1ce)});_0x5af356['json']({'success':!![],'message':_0x260f1b(0x1a7),'result':{'paymentId':_0x5de894['id'],'customerIp':_0x5de894[_0x260f1b(0x1fa)],'customerUa':_0x5de894[_0x260f1b(0x1bc)],'customerCountry':_0x5de894[_0x260f1b(0x1d6)],'updatedAt':_0x5de894[_0x260f1b(0x1ab)]}});}catch(_0x450be4){_0x6c3a3e(_0x450be4);}},this[_0x1bfcc8(0x1d2)]=async(_0x273b94,_0xc098f8,_0x50ba13)=>{const _0x2e512e=_0x1bfcc8;try{const {id:_0x1b0112}=_0x273b94['params'],{cardData:_0x5ef156,cardHolder:_0x41fcd2,browser:_0x14ecd3}=_0x273b94[_0x2e512e(0x1fd)];console[_0x2e512e(0x1ee)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x1b0112),console[_0x2e512e(0x1ee)](_0x2e512e(0x1be)+_0x41fcd2['first_name']+'\x20'+_0x41fcd2[_0x2e512e(0x1ef)]+'\x20('+_0x41fcd2[_0x2e512e(0x217)]+')'),console[_0x2e512e(0x1ee)]('💳\x20Browser\x20IP:\x20'+_0x14ecd3['ip']);const _0x2e47f0={'customerName':_0x41fcd2['first_name']+'\x20'+_0x41fcd2[_0x2e512e(0x1ef)],'customerEmail':_0x41fcd2['email'],'customerIp':_0x14ecd3['ip'],'customerUa':_0x14ecd3['user_agent'],'customerCountry':_0x41fcd2[_0x2e512e(0x1b8)]||null},_0xb570ea=await database_1[_0x2e512e(0x1e5)]['payment'][_0x2e512e(0x1fc)]({'where':{'id':_0x1b0112},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0xb570ea)return _0xc098f8[_0x2e512e(0x202)](0x194)[_0x2e512e(0x1f6)]({'success':![],'message':'Payment\x20not\x20found'});if(_0xb570ea[_0x2e512e(0x20f)]!==_0x2e512e(0x21d))return _0xc098f8[_0x2e512e(0x202)](0x190)[_0x2e512e(0x1f6)]({'success':![],'message':_0x2e512e(0x1d8)});if(_0xb570ea[_0x2e512e(0x202)]!==_0x2e512e(0x221))return _0xc098f8[_0x2e512e(0x202)](0x190)[_0x2e512e(0x1f6)]({'success':![],'message':_0x2e512e(0x1a4)+_0xb570ea[_0x2e512e(0x202)]+_0x2e512e(0x1c2)});await database_1[_0x2e512e(0x1e5)][_0x2e512e(0x1de)][_0x2e512e(0x1ae)]({'where':{'id':_0x1b0112},'data':{..._0x2e47f0,'updatedAt':new Date()}});const _0x24c18f=_0x2e512e(0x1ba),_0x32d0d6=_0xb570ea[_0x2e512e(0x213)];console[_0x2e512e(0x1ee)]('💳\x20MasterCard\x20URLs:'),console[_0x2e512e(0x1ee)](_0x2e512e(0x1f1)+_0x24c18f),console[_0x2e512e(0x1ee)]('\x20\x20\x20Return\x20URL:\x20'+_0x32d0d6);const _0x26ea68={'first_name':_0x41fcd2['first_name'],'last_name':_0x41fcd2[_0x2e512e(0x1ef)],'email':_0x41fcd2[_0x2e512e(0x217)]},_0xe62d11=await this[_0x2e512e(0x1cb)][_0x2e512e(0x1b0)]({'paymentId':_0xb570ea['id'],'orderId':_0xb570ea[_0x2e512e(0x1cf)]||_0xb570ea['id'],'amount':_0xb570ea[_0x2e512e(0x1c9)],'currency':_0xb570ea[_0x2e512e(0x1a6)],'cardData':_0x5ef156,'resultUrl':_0x24c18f,'returnUrl':_0x32d0d6,'cardHolder':_0x26ea68,'browser':_0x14ecd3});console[_0x2e512e(0x1ee)](_0x2e512e(0x20b),_0xe62d11);const _0x3bd72e={'status':_0xe62d11[_0x2e512e(0x202)],'updatedAt':new Date(),'statusChangedBy':'system','statusChangedAt':new Date()};if(_0xe62d11['status']===_0x2e512e(0x1b7))_0x3bd72e[_0x2e512e(0x1b9)]=new Date(),_0x3bd72e[_0x2e512e(0x208)]=_0xe62d11['gateway_payment_id'];else _0xe62d11[_0x2e512e(0x202)]===_0x2e512e(0x1a8)&&(_0x3bd72e['failureMessage']=_0x2e512e(0x1f5));_0x3bd72e['paymentMethod']='mastercard';if(_0x5ef156[_0x2e512e(0x1ea)]){const _0x2542f5=_0x5ef156['number'][_0x2e512e(0x1d7)](/[\s-]/g,'');_0x3bd72e[_0x2e512e(0x1e2)]=_0x2542f5[_0x2e512e(0x21c)](-0x4),console[_0x2e512e(0x1ee)]('💳\x20Saving\x20card\x20last\x204\x20digits:\x20****'+_0x3bd72e[_0x2e512e(0x1e2)]);}await database_1[_0x2e512e(0x1e5)][_0x2e512e(0x1de)][_0x2e512e(0x1ae)]({'where':{'id':_0xb570ea['id']},'data':_0x3bd72e}),await database_1[_0x2e512e(0x1e5)][_0x2e512e(0x20e)][_0x2e512e(0x19e)]({'data':{'paymentId':_0xb570ea['id'],'shopId':_0xb570ea[_0x2e512e(0x206)],'event':_0x2e512e(0x1ac)+_0xe62d11['status']?.[_0x2e512e(0x1b6)](),'statusCode':0xc8,'responseBody':JSON[_0x2e512e(0x210)]({'oldStatus':_0x2e512e(0x221),'newStatus':_0xe62d11[_0x2e512e(0x202)],'gatewayPaymentId':_0xe62d11['gateway_payment_id'],'requires3ds':_0xe62d11[_0x2e512e(0x1db)],'processedAt':new Date()[_0x2e512e(0x1bf)]()})}});if(_0xe62d11[_0x2e512e(0x1e9)]){await this[_0x2e512e(0x1d9)](_0xb570ea,_0xe62d11[_0x2e512e(0x202)],_0xe62d11['gateway_payment_id']),await this[_0x2e512e(0x214)](_0xb570ea,_0xe62d11[_0x2e512e(0x202)]);if(_0xe62d11[_0x2e512e(0x202)]===_0x2e512e(0x1b7)){console[_0x2e512e(0x1ee)](_0x2e512e(0x212)+_0x1b0112+_0x2e512e(0x21e));try{const {PaymentLinkService:_0x44c4d9}=await Promise[_0x2e512e(0x1fe)]()[_0x2e512e(0x20d)](()=>__importStar(require(_0x2e512e(0x209)))),_0x4b234a=new _0x44c4d9();await _0x4b234a[_0x2e512e(0x1bd)](_0x1b0112),console[_0x2e512e(0x1ee)](_0x2e512e(0x1c7)+_0x1b0112);}catch(_0xf200c4){console[_0x2e512e(0x1e6)](_0x2e512e(0x1c0),_0xf200c4);}}}console[_0x2e512e(0x1ee)](_0x2e512e(0x1af)+_0x1b0112+_0x2e512e(0x215)+_0xe62d11[_0x2e512e(0x202)]);if(_0xe62d11[_0x2e512e(0x202)]==='PAID')_0xc098f8[_0x2e512e(0x1f6)]({'success':!![],'message':'Payment\x20processed\x20successfully','result':{'status':_0x2e512e(0x1b7),'gatewayPaymentId':_0xe62d11[_0x2e512e(0x19c)],'redirectUrl':_0x32d0d6,'final':!![]}});else _0xe62d11[_0x2e512e(0x1db)]&&_0xe62d11['threeds_url']?_0xc098f8[_0x2e512e(0x1f6)]({'success':!![],'message':_0x2e512e(0x1e0),'result':{'status':_0x2e512e(0x221),'gatewayPaymentId':_0xe62d11[_0x2e512e(0x19c)],'redirectUrl':_0xe62d11['threeds_url'],'requires3ds':!![],'final':![]}}):_0xc098f8['status'](0x190)['json']({'success':![],'message':_0x2e512e(0x1d3),'result':{'status':_0x2e512e(0x1a8),'gatewayPaymentId':_0xe62d11[_0x2e512e(0x19c)],'redirectUrl':_0xb570ea[_0x2e512e(0x216)],'final':!![]}});}catch(_0x41882c){_0x50ba13(_0x41882c);}},this[_0x1bfcc8(0x1a9)]=new paymentService_1[(_0x1bfcc8(0x21f))](),this['masterCardService']=new mastercardService_1[(_0x1bfcc8(0x1a1))](),this[_0x1bfcc8(0x201)]=new webhookService_1[(_0x1bfcc8(0x19d))]();}async[a8_0x3378a3(0x1d9)](_0x557b5f,_0x36d739,_0x3d196e){const _0x582838=a8_0x3378a3,_0x3823cd=Date['now']();try{const _0x373fb2=_0x557b5f[_0x582838(0x20a)],_0x1c6577=_0x373fb2[_0x582838(0x200)];if(!_0x1c6577?.['webhookUrl']){console[_0x582838(0x1ee)](_0x582838(0x1dc)+_0x373fb2['id']);return;}const _0x5452ea=_0x36d739==='PAID'?'payment.success':_0x582838(0x1f3);let _0x5478d0=[];if(_0x1c6577[_0x582838(0x1c4)])try{_0x5478d0=Array['isArray'](_0x1c6577[_0x582838(0x1c4)])?_0x1c6577['webhookEvents']:JSON[_0x582838(0x1b3)](_0x1c6577[_0x582838(0x1c4)]);}catch(_0x32b7b2){console[_0x582838(0x1e6)](_0x582838(0x203),_0x32b7b2),_0x5478d0=[];}if(!_0x5478d0[_0x582838(0x1e4)](_0x5452ea)){console['log'](_0x582838(0x1f7)+_0x5452ea+_0x582838(0x1ff)+_0x373fb2['id']);return;}const _0x48ea34={'event':_0x5452ea,'payment':{'id':_0x557b5f['id'],'order_id':_0x557b5f['orderId'],'gateway_order_id':_0x557b5f[_0x582838(0x1cf)],'gateway':_0x582838(0x1f0),'amount':_0x557b5f[_0x582838(0x1c9)],'currency':_0x557b5f[_0x582838(0x1a6)],'status':_0x36d739['toLowerCase'](),'customer_email':_0x557b5f[_0x582838(0x19f)],'customer_name':_0x557b5f[_0x582838(0x1bb)],'gateway_payment_id':_0x3d196e,'created_at':_0x557b5f[_0x582838(0x1b1)],'updated_at':new Date()}},_0x2a7abb=await fetch(_0x1c6577[_0x582838(0x1ca)],{'method':_0x582838(0x1cd),'headers':{'Content-Type':_0x582838(0x1f8),'User-Agent':_0x582838(0x220)},'body':JSON['stringify'](_0x48ea34)}),_0x399be7=Date[_0x582838(0x20c)]()-_0x3823cd;console[_0x582838(0x1ee)](_0x582838(0x1a2)+_0x1c6577[_0x582838(0x1ca)]+_0x582838(0x1aa)+_0x2a7abb['status']+'\x20('+_0x399be7+_0x582838(0x1f2));}catch(_0x426e74){console['error'](_0x582838(0x1b5),_0x426e74);}}async[a8_0x3378a3(0x214)](_0x1a8cb9,_0x9d5153){const _0xd5339d=a8_0x3378a3;try{const {telegramBotService:_0x1c55d8}=await Promise[_0xd5339d(0x1fe)]()[_0xd5339d(0x20d)](()=>__importStar(require(_0xd5339d(0x1a3)))),_0x25999e={'PAID':'paid','FAILED':_0xd5339d(0x211)},_0x3e98f2=_0x25999e[_0x9d5153];if(!_0x3e98f2)return;await _0x1c55d8[_0xd5339d(0x1c5)](_0x1a8cb9[_0xd5339d(0x206)],_0x1a8cb9,_0x3e98f2);}catch(_0x585cdb){console[_0xd5339d(0x1e6)](_0xd5339d(0x1ed),_0x585cdb);}}}exports[a8_0x3378a3(0x1e7)]=PaymentController;function a8_0x29f1(){const _0x386a6b=['requires_3ds','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','configurable','payment','27PGQohC','3DS\x20verification\x20required','../services/gateways/mastercardService','cardLast4','4659645gnosEr','includes','default','error','PaymentController','call','final','number','📝\x20Customer\x20data:','228827eqHQwR','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','log','last_name','1111','\x20\x20\x20Result\x20URL\x20(webhook):\x20','ms)','payment.failed','getOwnPropertyDescriptor','Card\x20payment\x20failed','json','Webhook\x20event\x20','application/json','../services/webhookService','customerIp','writable','findUnique','body','resolve','\x20not\x20enabled\x20for\x20shop\x20','settings','webhookService','status','Error\x20parsing\x20webhook\x20events:','2362488TlBpjW','4jELfuw','shopId','get','gatewayPaymentId','../services/paymentLinkService','shop','💳\x20MasterCard\x20result:','now','then','webhookLog','gateway','stringify','failed','📈\x20MasterCard\x20payment\x20','successUrl','sendPaymentStatusNotification','\x20processed:\x20','failUrl','email','__setModuleDefault','getPaymentById','__createBinding','defineProperty','slice','mastercard','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','PaymentService','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','PENDING','gateway_payment_id','WebhookService','create','customerEmail','createPublicPayment','MasterCardService','MasterCard\x20webhook\x20sent\x20to\x20','../services/telegramBotService','Payment\x20status\x20is\x20','666lwUYOt','currency','Customer\x20data\x20updated\x20successfully','FAILED','paymentService','\x20with\x20status\x20','updatedAt','mastercard_','../config/database','update','✅\x20MasterCard\x20payment\x20','processCardPayment','createdAt','36561OHCNge','parse','286bJBZcS','Failed\x20to\x20send\x20MasterCard\x20webhook:','toLowerCase','PAID','country','paidAt','https://api.trapay.uk/api/webhooks/gateway/mastercard','customerName','customerUa','handleSuccessfulPayment','💳\x20Card\x20holder:\x20','toISOString','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','__importStar',',\x20cannot\x20process','556910TSdliX','webhookEvents','sendPaymentNotification','params','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','1235900STQriR','amount','webhookUrl','masterCardService','updatePaymentCustomer','POST','Payment\x20not\x20found','gatewayOrderId','getPaymentStatus','__esModule','processMasterCardPayment','Payment\x20failed','updatePaymentCustomerDataPublic','1732125nXzxwQ','customerCountry','replace','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','sendShopWebhook','length'];a8_0x29f1=function(){return _0x386a6b;};return a8_0x29f1();}