'use strict';const a8_0x565565=a8_0xfa85;(function(_0x3634ea,_0x27c6e9){const _0x474422=a8_0xfa85,_0x42ea5e=_0x3634ea();while(!![]){try{const _0x1bb512=-parseInt(_0x474422(0x24c))/0x1*(-parseInt(_0x474422(0x1f5))/0x2)+parseInt(_0x474422(0x224))/0x3+-parseInt(_0x474422(0x24d))/0x4*(-parseInt(_0x474422(0x22a))/0x5)+parseInt(_0x474422(0x24b))/0x6*(-parseInt(_0x474422(0x220))/0x7)+-parseInt(_0x474422(0x1e8))/0x8*(-parseInt(_0x474422(0x1ff))/0x9)+-parseInt(_0x474422(0x248))/0xa*(-parseInt(_0x474422(0x1de))/0xb)+parseInt(_0x474422(0x244))/0xc*(-parseInt(_0x474422(0x1ec))/0xd);if(_0x1bb512===_0x27c6e9)break;else _0x42ea5e['push'](_0x42ea5e['shift']());}catch(_0x26edaa){_0x42ea5e['push'](_0x42ea5e['shift']());}}}(a8_0x5d59,0x352ec));function a8_0xfa85(_0x4e9481,_0x15a10a){const _0x5d59d7=a8_0x5d59();return a8_0xfa85=function(_0xfa850e,_0x6bda06){_0xfa850e=_0xfa850e-0x1c5;let _0x324901=_0x5d59d7[_0xfa850e];return _0x324901;},a8_0xfa85(_0x4e9481,_0x15a10a);}var __createBinding=this&&this[a8_0x565565(0x210)]||(Object['create']?function(_0x5d7972,_0x3a53a5,_0x976c64,_0x59301f){const _0x5dc8d7=a8_0x565565;if(_0x59301f===undefined)_0x59301f=_0x976c64;var _0x2159b=Object[_0x5dc8d7(0x1ef)](_0x3a53a5,_0x976c64);(!_0x2159b||(_0x5dc8d7(0x1c8)in _0x2159b?!_0x3a53a5[_0x5dc8d7(0x1db)]:_0x2159b['writable']||_0x2159b[_0x5dc8d7(0x228)]))&&(_0x2159b={'enumerable':!![],'get':function(){return _0x3a53a5[_0x976c64];}}),Object['defineProperty'](_0x5d7972,_0x59301f,_0x2159b);}:function(_0x4e24f1,_0x2281cf,_0x2b6add,_0xa619da){if(_0xa619da===undefined)_0xa619da=_0x2b6add;_0x4e24f1[_0xa619da]=_0x2281cf[_0x2b6add];}),__setModuleDefault=this&&this[a8_0x565565(0x1d4)]||(Object[a8_0x565565(0x1f0)]?function(_0x46816d,_0x2e5e50){const _0x30d4de=a8_0x565565;Object[_0x30d4de(0x232)](_0x46816d,'default',{'enumerable':!![],'value':_0x2e5e50});}:function(_0x40c5e1,_0x240f20){const _0x1d0c5b=a8_0x565565;_0x40c5e1[_0x1d0c5b(0x22d)]=_0x240f20;}),__importStar=this&&this[a8_0x565565(0x21a)]||(function(){var _0x1d469f=function(_0x43ca80){return _0x1d469f=Object['getOwnPropertyNames']||function(_0x434073){const _0xe9f4a0=a8_0xfa85;var _0x40d61b=[];for(var _0x4a1cc9 in _0x434073)if(Object[_0xe9f4a0(0x211)][_0xe9f4a0(0x1d9)][_0xe9f4a0(0x1f9)](_0x434073,_0x4a1cc9))_0x40d61b[_0x40d61b[_0xe9f4a0(0x1cf)]]=_0x4a1cc9;return _0x40d61b;},_0x1d469f(_0x43ca80);};return function(_0x579c26){const _0x1ba3f3=a8_0xfa85;if(_0x579c26&&_0x579c26[_0x1ba3f3(0x1db)])return _0x579c26;var _0x260b60={};if(_0x579c26!=null){for(var _0x1f472b=_0x1d469f(_0x579c26),_0x3438df=0x0;_0x3438df<_0x1f472b[_0x1ba3f3(0x1cf)];_0x3438df++)if(_0x1f472b[_0x3438df]!==_0x1ba3f3(0x22d))__createBinding(_0x260b60,_0x579c26,_0x1f472b[_0x3438df]);}return __setModuleDefault(_0x260b60,_0x579c26),_0x260b60;};}()),__importDefault=this&&this[a8_0x565565(0x249)]||function(_0x546d73){const _0x3f2f96=a8_0x565565;return _0x546d73&&_0x546d73[_0x3f2f96(0x1db)]?_0x546d73:{'default':_0x546d73};};Object['defineProperty'](exports,a8_0x565565(0x1db),{'value':!![]}),exports[a8_0x565565(0x1eb)]=void 0x0;const paymentService_1=require(a8_0x565565(0x246)),mastercardService_1=require(a8_0x565565(0x22f)),webhookService_1=require(a8_0x565565(0x1e2)),database_1=__importDefault(require(a8_0x565565(0x1c5)));function a8_0x5d59(){const _0x2bedb9=['json','then','threeds_url','\x20became\x20PAID,\x20updating\x20payment\x20link\x20counter','\x20with\x20status\x20','1044333sCUCID','\x20\x20\x20Result\x20URL\x20(webhook):\x20','system','settings','gatewayOrderId','log','No\x20webhook\x20URL\x20configured\x20for\x20shop\x20','💳\x20MasterCard\x20URLs:','orderId','failed','isArray','user_agent','requires_3ds','PENDING','Failed\x20to\x20send\x20MasterCard\x20webhook:','Payment\x20is\x20not\x20for\x20MasterCard\x20gateway','body','__createBinding','prototype','shopId','Failed\x20to\x20update\x20payment\x20link\x20counter\x20for\x20MasterCard\x20payment:','number','Payment\x20not\x20found','amount','createdAt','Webhook\x20event\x20','parse','__importStar','payment.success','✅\x20MasterCard\x20payment\x20','toISOString','sendShopWebhook','customerCountry','98VSLDRr','💳\x20Saving\x20card\x20last\x204\x20digits:\x20****','payment.failed','Payment\x20failed','1286805KQYTWx','resolve','gatewayPaymentId','Payment\x20status\x20is\x20','configurable','webhookService','85SwgDpR','first_name','getPaymentById','default','Error\x20parsing\x20webhook\x20events:','../services/gateways/mastercardService','PaymentService','Failed\x20to\x20send\x20Telegram\x20payment\x20notification:','defineProperty','paymentService','webhookUrl','updatePaymentCustomer','paymentMethod','💳\x20Browser\x20IP:\x20',',\x20cannot\x20process','3DS\x20verification\x20required','webhookEvents','replace','successUrl','params','findUnique','failUrl','1111','now','Payment\x20processed\x20successfully','sendPaymentStatusNotification','7662012zormov','../services/paymentLinkService','../services/paymentService','POST','44180ixLNHq','__importDefault','📈\x20MasterCard\x20payment\x20','144582UqJdQv','1JBRalq','28372jtRdZr','../config/database','📝\x20Customer\x20data:','masterCardService','get','payment','slice','Customer\x20data\x20updated\x20successfully','PAID','✅\x20Payment\x20link\x20counter\x20updated\x20for\x20MasterCard\x20payment\x20','\x20not\x20enabled\x20for\x20shop\x20','length','error','WebhookService','update','webhookLog','__setModuleDefault','status','customerName','TesSoft\x20Payment\x20System/1.0\x20(MasterCard)','createPublicPayment','hasOwnProperty','MasterCardService','__esModule','💳\x20Card\x20holder:\x20','toLowerCase','33eZxMdz','processCardPayment','getPaymentStatus','email','../services/webhookService','application/json','Payment\x20created\x20successfully','ms)','handleSuccessfulPayment','gateway_payment_id','16UIkCwR','customerUa','last_name','PaymentController','13wFiPqc','stringify','mastercard','getOwnPropertyDescriptor','create','\x20processed:\x20','💳\x20MasterCard\x20result:','processMasterCardPayment','https://api.trapay.uk/api/webhooks/gateway/mastercard','797702qBkauC','updatedAt','../services/telegramBotService','cardLast4','call'];a8_0x5d59=function(){return _0x2bedb9;};return a8_0x5d59();}class PaymentController{constructor(){const _0x156c12=a8_0x565565;this[_0x156c12(0x1d8)]=async(_0x3483ce,_0x2ed3ca,_0x293b62)=>{const _0x4ff96c=_0x156c12;try{const _0x1653a3=_0x3483ce[_0x4ff96c(0x20f)],_0x1b9f11=await this[_0x4ff96c(0x233)]['createPublicPayment'](_0x1653a3);_0x2ed3ca[_0x4ff96c(0x1d5)](0xc9)[_0x4ff96c(0x1fa)]({'success':!![],'message':_0x4ff96c(0x1e4),'result':_0x1b9f11});}catch(_0x1d7650){_0x293b62(_0x1d7650);}},this['getPaymentStatus']=async(_0x328ea7,_0x1e7d70,_0xc7364c)=>{const _0x1dc0d4=_0x156c12;try{const {id:_0x11a1c1}=_0x328ea7[_0x1dc0d4(0x23d)],_0x5b05e7=await this[_0x1dc0d4(0x233)][_0x1dc0d4(0x1e0)](_0x11a1c1);if(!_0x5b05e7)return _0x1e7d70[_0x1dc0d4(0x1d5)](0x194)['json']({'success':![],'message':_0x1dc0d4(0x215)});_0x1e7d70[_0x1dc0d4(0x1fa)]({'success':!![],'result':_0x5b05e7});}catch(_0x30fccf){_0xc7364c(_0x30fccf);}},this[_0x156c12(0x22c)]=async(_0x285832,_0x167e57,_0x1a75a6)=>{const _0x5b696f=_0x156c12;try{const {id:_0x49d5a8}=_0x285832[_0x5b696f(0x23d)],_0x3b79f7=await this[_0x5b696f(0x233)][_0x5b696f(0x22c)](_0x49d5a8);if(!_0x3b79f7)return _0x167e57[_0x5b696f(0x1d5)](0x194)['json']({'success':![],'message':_0x5b696f(0x215)});_0x167e57['json']({'success':!![],'result':_0x3b79f7});}catch(_0x243b5b){_0x1a75a6(_0x243b5b);}},this[_0x156c12(0x235)]=async(_0x7ee6d,_0x1c6a7b,_0x22d72b)=>{const _0x284c92=_0x156c12;try{const {id:_0x21bd85}=_0x7ee6d[_0x284c92(0x23d)],_0x3e3611=_0x7ee6d[_0x284c92(0x20f)];console[_0x284c92(0x204)]('🔄\x20Updating\x20customer\x20data\x20for\x20payment:\x20'+_0x21bd85),console[_0x284c92(0x204)](_0x284c92(0x1c6),_0x3e3611);const _0x1363ee=await this[_0x284c92(0x233)]['updatePaymentCustomerDataPublic'](_0x21bd85,_0x3e3611);if(!_0x1363ee)return _0x1c6a7b['status'](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});_0x1c6a7b[_0x284c92(0x1fa)]({'success':!![],'message':_0x284c92(0x1cb),'result':{'paymentId':_0x1363ee['id'],'customerIp':_0x1363ee['customerIp'],'customerUa':_0x1363ee[_0x284c92(0x1e9)],'customerCountry':_0x1363ee[_0x284c92(0x21f)],'updatedAt':_0x1363ee[_0x284c92(0x1f6)]}});}catch(_0x201274){_0x22d72b(_0x201274);}},this[_0x156c12(0x1f3)]=async(_0x299a2c,_0x3012e3,_0x573394)=>{const _0x3765f0=_0x156c12;try{const {id:_0x181798}=_0x299a2c[_0x3765f0(0x23d)],{cardData:_0x140729,cardHolder:_0x287849,browser:_0x5126ab}=_0x299a2c[_0x3765f0(0x20f)];console[_0x3765f0(0x204)]('💳\x20Processing\x20MasterCard\x20payment:\x20'+_0x181798),console[_0x3765f0(0x204)](_0x3765f0(0x1dc)+_0x287849['first_name']+'\x20'+_0x287849[_0x3765f0(0x1ea)]+'\x20('+_0x287849[_0x3765f0(0x1e1)]+')'),console[_0x3765f0(0x204)](_0x3765f0(0x237)+_0x5126ab['ip']);const _0x2fb65c={'customerName':_0x287849[_0x3765f0(0x22b)]+'\x20'+_0x287849[_0x3765f0(0x1ea)],'customerEmail':_0x287849[_0x3765f0(0x1e1)],'customerIp':_0x5126ab['ip'],'customerUa':_0x5126ab[_0x3765f0(0x20a)]},_0x3fcc1a=await database_1[_0x3765f0(0x22d)][_0x3765f0(0x1c9)][_0x3765f0(0x23e)]({'where':{'id':_0x181798},'include':{'shop':{'select':{'id':!![],'name':!![],'settings':{'select':{'webhookUrl':!![],'webhookEvents':!![]}}}}}});if(!_0x3fcc1a)return _0x3012e3[_0x3765f0(0x1d5)](0x194)[_0x3765f0(0x1fa)]({'success':![],'message':_0x3765f0(0x215)});if(_0x3fcc1a['gateway']!==_0x3765f0(0x1ee))return _0x3012e3[_0x3765f0(0x1d5)](0x190)['json']({'success':![],'message':_0x3765f0(0x20e)});if(_0x3fcc1a[_0x3765f0(0x1d5)]!==_0x3765f0(0x20c))return _0x3012e3['status'](0x190)[_0x3765f0(0x1fa)]({'success':![],'message':_0x3765f0(0x227)+_0x3fcc1a[_0x3765f0(0x1d5)]+_0x3765f0(0x238)});await database_1[_0x3765f0(0x22d)]['payment'][_0x3765f0(0x1d2)]({'where':{'id':_0x181798},'data':{..._0x2fb65c,'updatedAt':new Date()}});const _0x4376c2=_0x3765f0(0x1f4),_0x4237e8=_0x3fcc1a[_0x3765f0(0x23c)];console['log'](_0x3765f0(0x206)),console['log'](_0x3765f0(0x200)+_0x4376c2),console['log']('\x20\x20\x20Return\x20URL:\x20'+_0x4237e8);const _0x24b4b2={'first_name':_0x287849['first_name'],'last_name':_0x287849['last_name'],'email':_0x287849[_0x3765f0(0x1e1)]},_0x28ea58=await this['masterCardService'][_0x3765f0(0x1df)]({'paymentId':_0x3fcc1a['id'],'orderId':_0x3fcc1a[_0x3765f0(0x203)]||_0x3fcc1a['id'],'amount':_0x3fcc1a[_0x3765f0(0x216)],'currency':_0x3fcc1a['currency'],'cardData':_0x140729,'resultUrl':_0x4376c2,'returnUrl':_0x4237e8,'cardHolder':_0x24b4b2,'browser':_0x5126ab});console[_0x3765f0(0x204)](_0x3765f0(0x1f2),_0x28ea58);const _0x11e565={'status':_0x28ea58[_0x3765f0(0x1d5)],'updatedAt':new Date(),'statusChangedBy':_0x3765f0(0x201),'statusChangedAt':new Date()};_0x28ea58[_0x3765f0(0x1e7)]&&(_0x11e565[_0x3765f0(0x226)]=_0x28ea58['gateway_payment_id'],console[_0x3765f0(0x204)]('💳\x20Saving\x20MasterCard\x20gateway\x20payment\x20ID:\x20'+_0x28ea58[_0x3765f0(0x1e7)]));if(_0x28ea58[_0x3765f0(0x1d5)]===_0x3765f0(0x1cc))_0x11e565['paidAt']=new Date();else _0x28ea58[_0x3765f0(0x1d5)]==='FAILED'&&(_0x11e565['failureMessage']='Card\x20payment\x20failed');_0x11e565[_0x3765f0(0x236)]=_0x3765f0(0x1ee);if(_0x140729[_0x3765f0(0x214)]){const _0x4423cd=_0x140729[_0x3765f0(0x214)][_0x3765f0(0x23b)](/[\s-]/g,'');_0x11e565[_0x3765f0(0x1f8)]=_0x4423cd[_0x3765f0(0x1ca)](-0x4),console[_0x3765f0(0x204)](_0x3765f0(0x221)+_0x11e565[_0x3765f0(0x1f8)]);}await database_1[_0x3765f0(0x22d)][_0x3765f0(0x1c9)][_0x3765f0(0x1d2)]({'where':{'id':_0x3fcc1a['id']},'data':_0x11e565}),await database_1[_0x3765f0(0x22d)][_0x3765f0(0x1d3)]['create']({'data':{'paymentId':_0x3fcc1a['id'],'shopId':_0x3fcc1a[_0x3765f0(0x212)],'event':'mastercard_'+_0x28ea58['status']?.[_0x3765f0(0x1dd)](),'statusCode':0xc8,'responseBody':JSON[_0x3765f0(0x1ed)]({'oldStatus':_0x3765f0(0x20c),'newStatus':_0x28ea58['status'],'gatewayPaymentId':_0x28ea58['gateway_payment_id'],'requires3ds':_0x28ea58[_0x3765f0(0x20b)],'processedAt':new Date()[_0x3765f0(0x21d)]()})}});if(_0x28ea58['final']){await this[_0x3765f0(0x21e)](_0x3fcc1a,_0x28ea58['status'],_0x28ea58[_0x3765f0(0x1e7)]),await this[_0x3765f0(0x243)](_0x3fcc1a,_0x28ea58[_0x3765f0(0x1d5)]);if(_0x28ea58[_0x3765f0(0x1d5)]===_0x3765f0(0x1cc)){console[_0x3765f0(0x204)](_0x3765f0(0x24a)+_0x181798+_0x3765f0(0x1fd));try{const {PaymentLinkService:_0x3fa0bd}=await Promise[_0x3765f0(0x225)]()[_0x3765f0(0x1fb)](()=>__importStar(require(_0x3765f0(0x245)))),_0x56c85f=new _0x3fa0bd();await _0x56c85f[_0x3765f0(0x1e6)](_0x181798),console[_0x3765f0(0x204)](_0x3765f0(0x1cd)+_0x181798);}catch(_0x5eec7d){console[_0x3765f0(0x1d0)](_0x3765f0(0x213),_0x5eec7d);}}}console[_0x3765f0(0x204)](_0x3765f0(0x21c)+_0x181798+_0x3765f0(0x1f1)+_0x28ea58[_0x3765f0(0x1d5)]);if(_0x28ea58['status']===_0x3765f0(0x1cc))_0x3012e3[_0x3765f0(0x1fa)]({'success':!![],'message':_0x3765f0(0x242),'result':{'status':_0x3765f0(0x1cc),'gatewayPaymentId':_0x28ea58[_0x3765f0(0x1e7)],'redirectUrl':_0x4237e8,'final':!![]}});else _0x28ea58[_0x3765f0(0x20b)]&&_0x28ea58[_0x3765f0(0x1fc)]?_0x3012e3[_0x3765f0(0x1fa)]({'success':!![],'message':_0x3765f0(0x239),'result':{'status':_0x3765f0(0x20c),'gatewayPaymentId':_0x28ea58[_0x3765f0(0x1e7)],'redirectUrl':_0x28ea58[_0x3765f0(0x1fc)],'requires3ds':!![],'final':![]}}):_0x3012e3['status'](0x190)[_0x3765f0(0x1fa)]({'success':![],'message':_0x3765f0(0x223),'result':{'status':'FAILED','gatewayPaymentId':_0x28ea58[_0x3765f0(0x1e7)],'redirectUrl':_0x3fcc1a[_0x3765f0(0x23f)],'final':!![]}});}catch(_0xfbbacd){_0x573394(_0xfbbacd);}},this[_0x156c12(0x233)]=new paymentService_1[(_0x156c12(0x230))](),this[_0x156c12(0x1c7)]=new mastercardService_1[(_0x156c12(0x1da))](),this[_0x156c12(0x229)]=new webhookService_1[(_0x156c12(0x1d1))]();}async[a8_0x565565(0x21e)](_0x28058e,_0x4deee6,_0x361337){const _0x29aa2e=a8_0x565565,_0x67970f=Date[_0x29aa2e(0x241)]();try{const _0x2be72e=_0x28058e['shop'],_0x18f131=_0x2be72e[_0x29aa2e(0x202)];if(!_0x18f131?.[_0x29aa2e(0x234)]){console[_0x29aa2e(0x204)](_0x29aa2e(0x205)+_0x2be72e['id']);return;}const _0x1138ba=_0x4deee6===_0x29aa2e(0x1cc)?_0x29aa2e(0x21b):_0x29aa2e(0x222);let _0x58a99c=[];if(_0x18f131[_0x29aa2e(0x23a)])try{_0x58a99c=Array[_0x29aa2e(0x209)](_0x18f131[_0x29aa2e(0x23a)])?_0x18f131['webhookEvents']:JSON[_0x29aa2e(0x219)](_0x18f131[_0x29aa2e(0x23a)]);}catch(_0x4d9f79){console[_0x29aa2e(0x1d0)](_0x29aa2e(0x22e),_0x4d9f79),_0x58a99c=[];}if(!_0x58a99c['includes'](_0x1138ba)){console[_0x29aa2e(0x204)](_0x29aa2e(0x218)+_0x1138ba+_0x29aa2e(0x1ce)+_0x2be72e['id']);return;}const _0x4828eb={'event':_0x1138ba,'payment':{'id':_0x28058e['id'],'order_id':_0x28058e[_0x29aa2e(0x207)],'gateway_order_id':_0x28058e[_0x29aa2e(0x203)],'gateway':_0x29aa2e(0x240),'amount':_0x28058e['amount'],'currency':_0x28058e['currency'],'status':_0x4deee6[_0x29aa2e(0x1dd)](),'customer_email':_0x28058e['customerEmail'],'customer_name':_0x28058e[_0x29aa2e(0x1d6)],'gateway_payment_id':_0x361337,'created_at':_0x28058e[_0x29aa2e(0x217)],'updated_at':new Date()}},_0x3c2b40=await fetch(_0x18f131[_0x29aa2e(0x234)],{'method':_0x29aa2e(0x247),'headers':{'Content-Type':_0x29aa2e(0x1e3),'User-Agent':_0x29aa2e(0x1d7)},'body':JSON[_0x29aa2e(0x1ed)](_0x4828eb)}),_0xe047d2=Date[_0x29aa2e(0x241)]()-_0x67970f;console[_0x29aa2e(0x204)]('MasterCard\x20webhook\x20sent\x20to\x20'+_0x18f131['webhookUrl']+_0x29aa2e(0x1fe)+_0x3c2b40[_0x29aa2e(0x1d5)]+'\x20('+_0xe047d2+_0x29aa2e(0x1e5));}catch(_0x3a595a){console[_0x29aa2e(0x1d0)](_0x29aa2e(0x20d),_0x3a595a);}}async[a8_0x565565(0x243)](_0x135eb5,_0xfd1e6){const _0x2aede5=a8_0x565565;try{const {telegramBotService:_0x3b1db9}=await Promise[_0x2aede5(0x225)]()[_0x2aede5(0x1fb)](()=>__importStar(require(_0x2aede5(0x1f7)))),_0x11de97={'PAID':'paid','FAILED':_0x2aede5(0x208)},_0xc3d15f=_0x11de97[_0xfd1e6];if(!_0xc3d15f)return;await _0x3b1db9['sendPaymentNotification'](_0x135eb5['shopId'],_0x135eb5,_0xc3d15f);}catch(_0x20417a){console[_0x2aede5(0x1d0)](_0x2aede5(0x231),_0x20417a);}}}exports[a8_0x565565(0x1eb)]=PaymentController;