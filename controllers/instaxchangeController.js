'use strict';function a7_0xec3d(_0x18f2eb,_0xa76f24){_0x18f2eb=_0x18f2eb-0xea;const _0x485043=a7_0x4850();let _0xec3d68=_0x485043[_0x18f2eb];return _0xec3d68;}const a7_0x762d5c=a7_0xec3d;(function(_0x51d4a6,_0x3937c5){const _0x3104e1=a7_0xec3d,_0x1fec16=_0x51d4a6();while(!![]){try{const _0x5e1e7b=parseInt(_0x3104e1(0x115))/0x1+-parseInt(_0x3104e1(0x109))/0x2*(-parseInt(_0x3104e1(0x101))/0x3)+parseInt(_0x3104e1(0x128))/0x4*(parseInt(_0x3104e1(0xed))/0x5)+-parseInt(_0x3104e1(0x11f))/0x6+parseInt(_0x3104e1(0x117))/0x7*(-parseInt(_0x3104e1(0x122))/0x8)+-parseInt(_0x3104e1(0x119))/0x9*(parseInt(_0x3104e1(0xf3))/0xa)+parseInt(_0x3104e1(0x112))/0xb;if(_0x5e1e7b===_0x3937c5)break;else _0x1fec16['push'](_0x1fec16['shift']());}catch(_0x2984a0){_0x1fec16['push'](_0x1fec16['shift']());}}}(a7_0x4850,0x448ba));var __importDefault=this&&this['__importDefault']||function(_0x450b70){const _0x405e14=a7_0xec3d;return _0x450b70&&_0x450b70[_0x405e14(0xf8)]?_0x450b70:{'default':_0x450b70};};Object[a7_0x762d5c(0xff)](exports,a7_0x762d5c(0xf8),{'value':!![]}),exports[a7_0x762d5c(0xef)]=void 0x0;function a7_0x4850(){const _0x88605d=['2052534hllGLx','update','convertToUSDT','493675hYHsOx','PAID','175btrBlZ','log','17028RoSuvp','Error\x20parsing\x20gateway\x20settings:','json','\x20\x20\x20Payment\x20ID:\x20','parse','findUnique','1362840ZootBy','amount','toFixed','48920fbIHAt','üê≥\x20InstaXChange\x20webhook\x20received:','\x20\x20\x20Commission:\x20','Payment\x20failed','default','webhookService','28DGPGbe','stringify','commission','statusReason','data','shop','üí∞\x20Shop\x20balance\x20updated:\x20+','165370vSqUAy','handleWebhook','InstaXChangeController','completed','amountAfterGatewayCommissionUSDT','\x20USDT','2940SLEVNa','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','currencyService','Webhook\x20processed\x20successfully','üì§\x20Webhook\x20notification\x20processed','__esModule','body','payment','failed','‚ùå\x20Failure\x20reason:\x20','Unknown\x20error','üí∞\x20Calculated\x20amounts:','defineProperty','üìä\x20Current\x20payment\x20status:\x20','457857MkkGBt','toLowerCase','error','failureMessage','currency','üîÑ\x20Updating\x20payment\x20status:\x20','amountUSDT','\x20‚Üí\x20','4CqwBjD','‚ùå\x20Payment\x20not\x20found:\x20','status','Status\x20not\x20actionable','entries','\x20\x20\x20Session\x20ID:\x20','WebhookService','FAILED','gatewayResponse'];a7_0x4850=function(){return _0x88605d;};return a7_0x4850();}const database_1=__importDefault(require('../config/database')),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0x299ed0=a7_0x762d5c;this[_0x299ed0(0xee)]=async(_0x7d8949,_0x3ca888)=>{const _0x271f9b=_0x299ed0;try{const {paymentId:_0x3728c7,status:_0x2c67ea,sessionId:_0x58ef30,webhookData:_0x47db73}=_0x7d8949[_0x271f9b(0xf9)];console['log'](_0x271f9b(0x123)),console[_0x271f9b(0x118)](_0x271f9b(0x11c)+_0x3728c7),console[_0x271f9b(0x118)]('\x20\x20\x20Status:\x20'+_0x2c67ea),console[_0x271f9b(0x118)](_0x271f9b(0x10e)+_0x58ef30);if(!_0x3728c7||!_0x2c67ea)return console[_0x271f9b(0x103)]('‚ùå\x20Missing\x20required\x20webhook\x20parameters'),_0x3ca888['status'](0x190)[_0x271f9b(0x11b)]({'success':![],'message':'Missing\x20required\x20parameters'});const _0x287c96=await database_1[_0x271f9b(0x126)][_0x271f9b(0xfa)][_0x271f9b(0x11e)]({'where':{'id':_0x3728c7},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x287c96)return console[_0x271f9b(0x103)](_0x271f9b(0x10a)+_0x3728c7),_0x3ca888[_0x271f9b(0x10b)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console['log'](_0x271f9b(0x100)+_0x287c96[_0x271f9b(0x10b)]);let _0x379e0f,_0x371f14=![];switch(_0x2c67ea[_0x271f9b(0x102)]()){case _0x271f9b(0xf0):_0x379e0f=_0x271f9b(0x116),_0x371f14=_0x287c96[_0x271f9b(0x10b)]!==_0x271f9b(0x116);break;case _0x271f9b(0xfb):_0x379e0f=_0x271f9b(0x110);break;default:console['log']('‚ö†Ô∏è\x20Unknown\x20status:\x20'+_0x2c67ea+',\x20ignoring\x20webhook');return _0x3ca888['status'](0xc8)[_0x271f9b(0x11b)]({'success':!![],'message':_0x271f9b(0x10c)});}console[_0x271f9b(0x118)](_0x271f9b(0x106)+_0x287c96[_0x271f9b(0x10b)]+_0x271f9b(0x108)+_0x379e0f);const _0x4af313={'status':_0x379e0f,'updatedAt':new Date()};if(_0x379e0f===_0x271f9b(0x116)){_0x4af313['paidAt']=new Date();if(!_0x287c96[_0x271f9b(0x107)]){const _0x41c34a=await currencyService_1[_0x271f9b(0xf5)][_0x271f9b(0x114)](_0x287c96[_0x271f9b(0x120)],_0x287c96[_0x271f9b(0x105)]);_0x4af313[_0x271f9b(0x107)]=_0x41c34a;let _0x5c6452=0xa;if(_0x287c96[_0x271f9b(0xeb)]['gatewaySettings'])try{const _0x55c81e=JSON[_0x271f9b(0x11d)](_0x287c96[_0x271f9b(0xeb)]['gatewaySettings']);for(const [_0x22e76b,_0x5a8ac7]of Object[_0x271f9b(0x10d)](_0x55c81e)){if(_0x22e76b['toLowerCase']()==='instaxchange'){_0x5c6452=_0x5a8ac7[_0x271f9b(0x12a)]||0xa;break;}}}catch(_0x236c0d){console['error'](_0x271f9b(0x11a),_0x236c0d);}const _0x4351a6=_0x41c34a*(0x1-_0x5c6452/0x64);_0x4af313[_0x271f9b(0xf1)]=_0x4351a6,_0x4af313['gatewayCommissionRate']=_0x5c6452,console[_0x271f9b(0x118)](_0x271f9b(0xfe)),console['log']('\x20\x20\x20Amount\x20USDT:\x20'+_0x41c34a['toFixed'](0x6)),console['log'](_0x271f9b(0x124)+_0x5c6452+'%'),console[_0x271f9b(0x118)]('\x20\x20\x20Merchant\x20Amount:\x20'+_0x4351a6[_0x271f9b(0x121)](0x6));}}else{if(_0x379e0f===_0x271f9b(0x110)){const _0x9ccc31=_0x47db73?.[_0x271f9b(0xea)]?.[_0x271f9b(0x12b)]||_0x271f9b(0x125);_0x4af313[_0x271f9b(0x104)]=_0x9ccc31,console['log'](_0x271f9b(0xfc)+_0x9ccc31);}}_0x47db73&&(_0x4af313[_0x271f9b(0x111)]=JSON[_0x271f9b(0x129)](_0x47db73));await database_1[_0x271f9b(0x126)][_0x271f9b(0xfa)][_0x271f9b(0x113)]({'where':{'id':_0x3728c7},'data':_0x4af313}),console[_0x271f9b(0x118)]('‚úÖ\x20Payment\x20updated\x20successfully');if(_0x371f14&&_0x379e0f==='PAID'){const _0x411042=_0x4af313[_0x271f9b(0xf1)];_0x411042&&(await database_1['default'][_0x271f9b(0xeb)][_0x271f9b(0x113)]({'where':{'id':_0x287c96['shopId']},'data':{'balance':{'increment':_0x411042}}}),console[_0x271f9b(0x118)](_0x271f9b(0xec)+_0x411042['toFixed'](0x6)+_0x271f9b(0xf2)));}try{await this[_0x271f9b(0x127)]['updatePaymentStatus'](_0x3728c7,_0x379e0f,{'failureMessage':_0x379e0f===_0x271f9b(0x110)?_0x47db73?.[_0x271f9b(0xea)]?.[_0x271f9b(0x12b)]||_0x271f9b(0x125):undefined}),console[_0x271f9b(0x118)](_0x271f9b(0xf7));}catch(_0x2a02de){console[_0x271f9b(0x103)]('‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:',_0x2a02de);}return _0x3ca888['status'](0xc8)[_0x271f9b(0x11b)]({'success':!![],'message':_0x271f9b(0xf6)});}catch(_0x2083bf){return console[_0x271f9b(0x103)](_0x271f9b(0xf4),_0x2083bf),_0x3ca888['status'](0x1f4)[_0x271f9b(0x11b)]({'success':![],'message':'Internal\x20server\x20error','error':_0x2083bf instanceof Error?_0x2083bf['message']:_0x271f9b(0xfd)});}},this[_0x299ed0(0x127)]=new webhookService_1[(_0x299ed0(0x10f))]();}}exports['InstaXChangeController']=InstaXChangeController;