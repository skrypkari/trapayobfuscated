'use strict';function a7_0x6dab(){const _0x3e29fd=['121941wQEXzQ',',\x20ignoring\x20webhook','update','Missing\x20required\x20parameters','Internal\x20server\x20error','toLowerCase','Payment\x20failed','üîÑ\x20Updating\x20payment\x20status:\x20','PAID','gatewaySettings','error','webhookService','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','5yPBaDG','Webhook\x20processed\x20successfully','üê≥\x20InstaXChange\x20webhook\x20received:','shopId','19242DUzKfc','log','amountAfterGatewayCommissionUSDT','../services/webhookService','__importDefault','\x20\x20\x20Commission:\x20','__esModule','entries','1137213yARXGW','FAILED','data','../config/database','defineProperty','gatewayCommissionRate','instaxchange','updatePaymentStatus','2343742wAkASn','2534MFYuSt','Unknown\x20error','message','1555780RHsHaf','convertToUSDT','‚ùå\x20Failure\x20reason:\x20','\x20‚Üí\x20','parse','json','\x20\x20\x20Amount\x20USDT:\x20','stringify','Payment\x20not\x20found','amount','findUnique','üìä\x20Current\x20payment\x20status:\x20','../services/currencyService','gatewayResponse','completed','179868YORySQ','‚ùå\x20Payment\x20not\x20found:\x20','‚úÖ\x20Payment\x20updated\x20successfully','failed','toFixed','status','commission','shop','\x20\x20\x20Session\x20ID:\x20','default','üí∞\x20Calculated\x20amounts:','currencyService','640YgUaHb','amountUSDT','‚ùå\x20Missing\x20required\x20webhook\x20parameters','payment','Error\x20parsing\x20gateway\x20settings:','464mHpARf','body','255827ZADgDp','currency','InstaXChangeController'];a7_0x6dab=function(){return _0x3e29fd;};return a7_0x6dab();}const a7_0x2b1a0c=a7_0x2735;(function(_0x467fae,_0x3e75f1){const _0x38d623=a7_0x2735,_0x545ed3=_0x467fae();while(!![]){try{const _0x33ea06=parseInt(_0x38d623(0x108))/0x1+-parseInt(_0x38d623(0x110))/0x2+-parseInt(_0x38d623(0x123))/0x3+-parseInt(_0x38d623(0x114))/0x4*(parseInt(_0x38d623(0xfc))/0x5)+parseInt(_0x38d623(0x100))/0x6*(-parseInt(_0x38d623(0x111))/0x7)+-parseInt(_0x38d623(0xea))/0x8*(-parseInt(_0x38d623(0xef))/0x9)+parseInt(_0x38d623(0xe5))/0xa*(parseInt(_0x38d623(0xec))/0xb);if(_0x33ea06===_0x3e75f1)break;else _0x545ed3['push'](_0x545ed3['shift']());}catch(_0x3128d6){_0x545ed3['push'](_0x545ed3['shift']());}}}(a7_0x6dab,0x99c25));var __importDefault=this&&this[a7_0x2b1a0c(0x104)]||function(_0xf706a6){const _0x3864c9=a7_0x2b1a0c;return _0xf706a6&&_0xf706a6[_0x3864c9(0x106)]?_0xf706a6:{'default':_0xf706a6};};Object[a7_0x2b1a0c(0x10c)](exports,a7_0x2b1a0c(0x106),{'value':!![]}),exports[a7_0x2b1a0c(0xee)]=void 0x0;const database_1=__importDefault(require(a7_0x2b1a0c(0x10b))),webhookService_1=require(a7_0x2b1a0c(0x103)),currencyService_1=require(a7_0x2b1a0c(0x120));function a7_0x2735(_0x4b7312,_0x3a25de){_0x4b7312=_0x4b7312-0xe0;const _0x6dab8=a7_0x6dab();let _0x273578=_0x6dab8[_0x4b7312];return _0x273578;}class InstaXChangeController{constructor(){const _0x1d56a0=a7_0x2b1a0c;this['handleWebhook']=async(_0x58118a,_0x1f3641)=>{const _0x45401c=a7_0x2735;try{const {paymentId:_0x5df7d4,status:_0x477967,sessionId:_0x1193f7,webhookData:_0x283728}=_0x58118a[_0x45401c(0xeb)];console[_0x45401c(0x101)](_0x45401c(0xfe)),console['log']('\x20\x20\x20Payment\x20ID:\x20'+_0x5df7d4),console[_0x45401c(0x101)]('\x20\x20\x20Status:\x20'+_0x477967),console[_0x45401c(0x101)](_0x45401c(0xe1)+_0x1193f7);if(!_0x5df7d4||!_0x477967)return console[_0x45401c(0xf9)](_0x45401c(0xe7)),_0x1f3641[_0x45401c(0x128)](0x190)['json']({'success':![],'message':_0x45401c(0xf2)});const _0x3f91f8=await database_1[_0x45401c(0xe2)][_0x45401c(0xe8)][_0x45401c(0x11e)]({'where':{'id':_0x5df7d4},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x3f91f8)return console[_0x45401c(0xf9)](_0x45401c(0x124)+_0x5df7d4),_0x1f3641[_0x45401c(0x128)](0x194)[_0x45401c(0x119)]({'success':![],'message':_0x45401c(0x11c)});console['log'](_0x45401c(0x11f)+_0x3f91f8[_0x45401c(0x128)]);let _0x27156a,_0x2ebfb1=![];switch(_0x477967[_0x45401c(0xf4)]()){case _0x45401c(0x122):_0x27156a=_0x45401c(0xf7),_0x2ebfb1=_0x3f91f8[_0x45401c(0x128)]!==_0x45401c(0xf7);break;case _0x45401c(0x126):_0x27156a=_0x45401c(0x109);break;default:console[_0x45401c(0x101)]('‚ö†Ô∏è\x20Unknown\x20status:\x20'+_0x477967+_0x45401c(0xf0));return _0x1f3641[_0x45401c(0x128)](0xc8)['json']({'success':!![],'message':'Status\x20not\x20actionable'});}console[_0x45401c(0x101)](_0x45401c(0xf6)+_0x3f91f8[_0x45401c(0x128)]+_0x45401c(0x117)+_0x27156a);const _0x2f68b7={'status':_0x27156a,'updatedAt':new Date()};if(_0x27156a===_0x45401c(0xf7)){_0x2f68b7['paidAt']=new Date();if(!_0x3f91f8[_0x45401c(0xe6)]){const _0x4677e5=await currencyService_1[_0x45401c(0xe4)][_0x45401c(0x115)](_0x3f91f8[_0x45401c(0x11d)],_0x3f91f8[_0x45401c(0xed)]);_0x2f68b7[_0x45401c(0xe6)]=_0x4677e5;let _0x3a0a2b=0xa;if(_0x3f91f8[_0x45401c(0xe0)][_0x45401c(0xf8)])try{const _0x3646c6=JSON[_0x45401c(0x118)](_0x3f91f8[_0x45401c(0xe0)][_0x45401c(0xf8)]);for(const [_0x3e4d27,_0x574092]of Object[_0x45401c(0x107)](_0x3646c6)){if(_0x3e4d27['toLowerCase']()===_0x45401c(0x10e)){_0x3a0a2b=_0x574092[_0x45401c(0x129)]||0xa;break;}}}catch(_0x12fe14){console[_0x45401c(0xf9)](_0x45401c(0xe9),_0x12fe14);}const _0x5ba056=_0x4677e5*(0x1-_0x3a0a2b/0x64);_0x2f68b7[_0x45401c(0x102)]=_0x5ba056,_0x2f68b7[_0x45401c(0x10d)]=_0x3a0a2b,console[_0x45401c(0x101)](_0x45401c(0xe3)),console['log'](_0x45401c(0x11a)+_0x4677e5['toFixed'](0x6)),console[_0x45401c(0x101)](_0x45401c(0x105)+_0x3a0a2b+'%'),console[_0x45401c(0x101)]('\x20\x20\x20Merchant\x20Amount:\x20'+_0x5ba056[_0x45401c(0x127)](0x6));}}else{if(_0x27156a==='FAILED'){const _0x3edb4c=_0x283728?.[_0x45401c(0x10a)]?.['statusReason']||'Payment\x20failed';_0x2f68b7['failureMessage']=_0x3edb4c,console[_0x45401c(0x101)](_0x45401c(0x116)+_0x3edb4c);}}_0x283728&&(_0x2f68b7[_0x45401c(0x121)]=JSON[_0x45401c(0x11b)](_0x283728));await database_1[_0x45401c(0xe2)]['payment'][_0x45401c(0xf1)]({'where':{'id':_0x5df7d4},'data':_0x2f68b7}),console[_0x45401c(0x101)](_0x45401c(0x125));if(_0x2ebfb1&&_0x27156a===_0x45401c(0xf7)){const _0xd2bcca=_0x2f68b7[_0x45401c(0x102)];_0xd2bcca&&(await database_1[_0x45401c(0xe2)]['shop']['update']({'where':{'id':_0x3f91f8[_0x45401c(0xff)]},'data':{'balance':{'increment':_0xd2bcca}}}),console[_0x45401c(0x101)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0xd2bcca[_0x45401c(0x127)](0x6)+'\x20USDT'));}try{await this[_0x45401c(0xfa)][_0x45401c(0x10f)](_0x5df7d4,_0x27156a,{'failureMessage':_0x27156a===_0x45401c(0x109)?_0x283728?.[_0x45401c(0x10a)]?.['statusReason']||_0x45401c(0xf5):undefined}),console[_0x45401c(0x101)]('üì§\x20Webhook\x20notification\x20processed');}catch(_0x2c3c7e){console[_0x45401c(0xf9)](_0x45401c(0xfb),_0x2c3c7e);}return _0x1f3641[_0x45401c(0x128)](0xc8)['json']({'success':!![],'message':_0x45401c(0xfd)});}catch(_0xdae726){return console[_0x45401c(0xf9)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0xdae726),_0x1f3641['status'](0x1f4)[_0x45401c(0x119)]({'success':![],'message':_0x45401c(0xf3),'error':_0xdae726 instanceof Error?_0xdae726[_0x45401c(0x113)]:_0x45401c(0x112)});}},this[_0x1d56a0(0xfa)]=new webhookService_1['WebhookService']();}}exports['InstaXChangeController']=InstaXChangeController;