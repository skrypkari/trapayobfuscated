'use strict';function a8_0x1195(){const _0x504413=['WebhookService','stringify','currency','amountAfterGatewayCommissionUSDT','Payment\x20not\x20found','28410jzIosg','parse','amountUSDT','\x20\x20\x20Session\x20ID:\x20','shop','__importDefault','\x20\x20\x20Commission:\x20','currencyService','gatewayCommissionRate','414295EVPzfo','gatewayResponse','statusReason','status','297114jSnIOI','‚ùå\x20Failure\x20reason:\x20','commission','__esModule','toFixed','data','üîÑ\x20Updating\x20payment\x20status:\x20','PAID','372541WBLlMo','23535KmDHbK','payment','completed','Error\x20parsing\x20gateway\x20settings:','41238QAfziT','../services/webhookService','206436mbcuvA','6cEUcjY','Internal\x20server\x20error','failed','üí∞\x20Shop\x20balance\x20updated:\x20+','message','Payment\x20failed','InstaXChangeController','üí∞\x20Calculated\x20amounts:','updatePaymentStatus','findUnique','\x20\x20\x20Merchant\x20Amount:\x20','\x20\x20\x20Status:\x20','update','1664cfIdUO','316fHgzni','FAILED','gatewaySettings','convertToUSDT','error','webhookService','handleWebhook','2920rEUPTh','json','Webhook\x20processed\x20successfully','body','Status\x20not\x20actionable','‚ùå\x20Payment\x20not\x20found:\x20','log','üìä\x20Current\x20payment\x20status:\x20','4499mtEwJj','84PbtUNm','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','‚ùå\x20Missing\x20required\x20webhook\x20parameters','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','\x20USDT','../config/database','default','üê≥\x20InstaXChange\x20webhook\x20received:','shopId','\x20‚Üí\x20','Missing\x20required\x20parameters','toLowerCase'];a8_0x1195=function(){return _0x504413;};return a8_0x1195();}function a8_0x16eb(_0x3157fa,_0x5b9be4){_0x3157fa=_0x3157fa-0x161;const _0x11956b=a8_0x1195();let _0x16eb91=_0x11956b[_0x3157fa];return _0x16eb91;}const a8_0x3a33e9=a8_0x16eb;(function(_0x371881,_0x1e615e){const _0xa29ef4=a8_0x16eb,_0x9073f1=_0x371881();while(!![]){try{const _0x4ea11d=parseInt(_0xa29ef4(0x183))/0x1*(-parseInt(_0xa29ef4(0x18b))/0x2)+parseInt(_0xa29ef4(0x188))/0x3*(-parseInt(_0xa29ef4(0x199))/0x4)+-parseInt(_0xa29ef4(0x177))/0x5+parseInt(_0xa29ef4(0x17b))/0x6*(parseInt(_0xa29ef4(0x1a9))/0x7)+-parseInt(_0xa29ef4(0x1a0))/0x8*(parseInt(_0xa29ef4(0x184))/0x9)+-parseInt(_0xa29ef4(0x16e))/0xa*(-parseInt(_0xa29ef4(0x1a8))/0xb)+-parseInt(_0xa29ef4(0x18a))/0xc*(-parseInt(_0xa29ef4(0x198))/0xd);if(_0x4ea11d===_0x1e615e)break;else _0x9073f1['push'](_0x9073f1['shift']());}catch(_0x3ef74b){_0x9073f1['push'](_0x9073f1['shift']());}}}(a8_0x1195,0xaf1ea));var __importDefault=this&&this[a8_0x3a33e9(0x173)]||function(_0x5d0342){const _0x29520c=a8_0x3a33e9;return _0x5d0342&&_0x5d0342[_0x29520c(0x17e)]?_0x5d0342:{'default':_0x5d0342};};Object['defineProperty'](exports,a8_0x3a33e9(0x17e),{'value':!![]}),exports['InstaXChangeController']=void 0x0;const database_1=__importDefault(require(a8_0x3a33e9(0x162))),webhookService_1=require(a8_0x3a33e9(0x189)),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0xba9989=a8_0x3a33e9;this[_0xba9989(0x19f)]=async(_0x4f4daa,_0x34899d)=>{const _0x1f8f64=_0xba9989;try{const {paymentId:_0x711a5e,status:_0x4c5ff4,sessionId:_0x146671,webhookData:_0x5794de}=_0x4f4daa[_0x1f8f64(0x1a3)];console[_0x1f8f64(0x1a6)](_0x1f8f64(0x164)),console[_0x1f8f64(0x1a6)]('\x20\x20\x20Payment\x20ID:\x20'+_0x711a5e),console['log'](_0x1f8f64(0x196)+_0x4c5ff4),console[_0x1f8f64(0x1a6)](_0x1f8f64(0x171)+_0x146671);if(!_0x711a5e||!_0x4c5ff4)return console[_0x1f8f64(0x19d)](_0x1f8f64(0x1ab)),_0x34899d[_0x1f8f64(0x17a)](0x190)[_0x1f8f64(0x1a1)]({'success':![],'message':_0x1f8f64(0x167)});const _0x5d4a2f=await database_1[_0x1f8f64(0x163)]['payment'][_0x1f8f64(0x194)]({'where':{'id':_0x711a5e},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x5d4a2f)return console[_0x1f8f64(0x19d)](_0x1f8f64(0x1a5)+_0x711a5e),_0x34899d[_0x1f8f64(0x17a)](0x194)[_0x1f8f64(0x1a1)]({'success':![],'message':_0x1f8f64(0x16d)});console[_0x1f8f64(0x1a6)](_0x1f8f64(0x1a7)+_0x5d4a2f[_0x1f8f64(0x17a)]);let _0x322ef9,_0x46f772=![];switch(_0x4c5ff4[_0x1f8f64(0x168)]()){case _0x1f8f64(0x186):_0x322ef9='PAID',_0x46f772=_0x5d4a2f[_0x1f8f64(0x17a)]!==_0x1f8f64(0x182);break;case _0x1f8f64(0x18d):_0x322ef9=_0x1f8f64(0x19a);break;default:console[_0x1f8f64(0x1a6)]('‚ö†Ô∏è\x20Unknown\x20status:\x20'+_0x4c5ff4+',\x20ignoring\x20webhook');return _0x34899d[_0x1f8f64(0x17a)](0xc8)[_0x1f8f64(0x1a1)]({'success':!![],'message':_0x1f8f64(0x1a4)});}console[_0x1f8f64(0x1a6)](_0x1f8f64(0x181)+_0x5d4a2f[_0x1f8f64(0x17a)]+_0x1f8f64(0x166)+_0x322ef9);const _0x3007f4={'status':_0x322ef9,'updatedAt':new Date()};if(_0x322ef9===_0x1f8f64(0x182)){_0x3007f4['paidAt']=new Date();if(!_0x5d4a2f[_0x1f8f64(0x170)]){const _0xc80912=await currencyService_1[_0x1f8f64(0x175)][_0x1f8f64(0x19c)](_0x5d4a2f['amount'],_0x5d4a2f[_0x1f8f64(0x16b)]);_0x3007f4[_0x1f8f64(0x170)]=_0xc80912;let _0xb05253=0xa;if(_0x5d4a2f['shop'][_0x1f8f64(0x19b)])try{const _0x2bc6a8=JSON[_0x1f8f64(0x16f)](_0x5d4a2f['shop'][_0x1f8f64(0x19b)]);for(const [_0x25367d,_0x4de4de]of Object['entries'](_0x2bc6a8)){if(_0x25367d[_0x1f8f64(0x168)]()==='instaxchange'){_0xb05253=_0x4de4de[_0x1f8f64(0x17d)]||0xa;break;}}}catch(_0x315826){console['error'](_0x1f8f64(0x187),_0x315826);}const _0x243588=_0xc80912*(0x1-_0xb05253/0x64);_0x3007f4[_0x1f8f64(0x16c)]=_0x243588,_0x3007f4[_0x1f8f64(0x176)]=_0xb05253,console[_0x1f8f64(0x1a6)](_0x1f8f64(0x192)),console['log']('\x20\x20\x20Amount\x20USDT:\x20'+_0xc80912[_0x1f8f64(0x17f)](0x6)),console['log'](_0x1f8f64(0x174)+_0xb05253+'%'),console['log'](_0x1f8f64(0x195)+_0x243588[_0x1f8f64(0x17f)](0x6));}}else{if(_0x322ef9===_0x1f8f64(0x19a)){const _0x4098e8=_0x5794de?.[_0x1f8f64(0x180)]?.[_0x1f8f64(0x179)]||_0x1f8f64(0x190);_0x3007f4['failureMessage']=_0x4098e8,console['log'](_0x1f8f64(0x17c)+_0x4098e8);}}_0x5794de&&(_0x3007f4[_0x1f8f64(0x178)]=JSON[_0x1f8f64(0x16a)](_0x5794de));await database_1[_0x1f8f64(0x163)][_0x1f8f64(0x185)][_0x1f8f64(0x197)]({'where':{'id':_0x711a5e},'data':_0x3007f4}),console[_0x1f8f64(0x1a6)]('‚úÖ\x20Payment\x20updated\x20successfully');if(_0x46f772&&_0x322ef9===_0x1f8f64(0x182)){const _0x27ee9c=_0x3007f4[_0x1f8f64(0x16c)];_0x27ee9c&&(await database_1[_0x1f8f64(0x163)][_0x1f8f64(0x172)][_0x1f8f64(0x197)]({'where':{'id':_0x5d4a2f[_0x1f8f64(0x165)]},'data':{'balance':{'increment':_0x27ee9c}}}),console['log'](_0x1f8f64(0x18e)+_0x27ee9c[_0x1f8f64(0x17f)](0x6)+_0x1f8f64(0x161)));}try{await this['webhookService'][_0x1f8f64(0x193)](_0x711a5e,_0x322ef9,{'failureMessage':_0x322ef9===_0x1f8f64(0x19a)?_0x5794de?.[_0x1f8f64(0x180)]?.['statusReason']||_0x1f8f64(0x190):undefined}),console[_0x1f8f64(0x1a6)]('üì§\x20Webhook\x20notification\x20processed');}catch(_0x1a66d1){console[_0x1f8f64(0x19d)](_0x1f8f64(0x1aa),_0x1a66d1);}return _0x34899d[_0x1f8f64(0x17a)](0xc8)[_0x1f8f64(0x1a1)]({'success':!![],'message':_0x1f8f64(0x1a2)});}catch(_0x5dadbf){return console[_0x1f8f64(0x19d)](_0x1f8f64(0x1ac),_0x5dadbf),_0x34899d[_0x1f8f64(0x17a)](0x1f4)[_0x1f8f64(0x1a1)]({'success':![],'message':_0x1f8f64(0x18c),'error':_0x5dadbf instanceof Error?_0x5dadbf[_0x1f8f64(0x18f)]:'Unknown\x20error'});}},this[_0xba9989(0x19e)]=new webhookService_1[(_0xba9989(0x169))]();}}exports[a8_0x3a33e9(0x191)]=InstaXChangeController;