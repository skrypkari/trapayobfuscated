'use strict';function a7_0x2bef(){const _0x4e5bce=['‚ùå\x20Missing\x20required\x20webhook\x20parameters',',\x20ignoring\x20webhook','324808uLzutr','__importDefault','9296119gXAsaj','gatewaySettings','54gTppfl','FAILED','defineProperty','üì§\x20Webhook\x20notification\x20processed','Payment\x20failed','amountUSDT','\x20‚Üí\x20','__esModule','entries','üí∞\x20Calculated\x20amounts:','completed','amountAfterGatewayCommissionUSDT','../config/database','Error\x20parsing\x20gateway\x20settings:','default','2794736aAwvRu','Payment\x20not\x20found','318625vqGTih','commission','üê≥\x20InstaXChange\x20webhook\x20received:','currency','472769lALaeS','130cUYEvb','json','Webhook\x20processed\x20successfully','\x20\x20\x20Payment\x20ID:\x20','payment','stringify','\x20\x20\x20Merchant\x20Amount:\x20','shopId','failureMessage','toFixed','Unknown\x20error','\x20\x20\x20Amount\x20USDT:\x20','gatewayResponse','38536780ZkJnjA','currencyService','handleWebhook','60xbaBfC','data','error','failed','11NBVKyT','12117AQwTAt','parse','log','shop','Status\x20not\x20actionable','paidAt','üìä\x20Current\x20payment\x20status:\x20','InstaXChangeController','amount','PAID','update','../services/currencyService','toLowerCase','‚úÖ\x20Payment\x20updated\x20successfully','Missing\x20required\x20parameters','‚ö†Ô∏è\x20Unknown\x20status:\x20','body','Internal\x20server\x20error','status','convertToUSDT','findUnique','‚ùå\x20Failure\x20reason:\x20','\x20USDT','statusReason','updatePaymentStatus'];a7_0x2bef=function(){return _0x4e5bce;};return a7_0x2bef();}const a7_0x184a3f=a7_0x3a52;(function(_0x2d095a,_0x408a1b){const _0x5838b2=a7_0x3a52,_0x4740ca=_0x2d095a();while(!![]){try{const _0x378633=-parseInt(_0x5838b2(0xc1))/0x1+parseInt(_0x5838b2(0xc2))/0x2*(-parseInt(_0x5838b2(0xd7))/0x3)+-parseInt(_0x5838b2(0xbb))/0x4+parseInt(_0x5838b2(0xbd))/0x5*(-parseInt(_0x5838b2(0xd2))/0x6)+-parseInt(_0x5838b2(0xf4))/0x7+-parseInt(_0x5838b2(0xf2))/0x8*(-parseInt(_0x5838b2(0xac))/0x9)+-parseInt(_0x5838b2(0xcf))/0xa*(-parseInt(_0x5838b2(0xd6))/0xb);if(_0x378633===_0x408a1b)break;else _0x4740ca['push'](_0x4740ca['shift']());}catch(_0x294bf1){_0x4740ca['push'](_0x4740ca['shift']());}}}(a7_0x2bef,0xaa6ad));function a7_0x3a52(_0x2c34fa,_0x298d13){_0x2c34fa=_0x2c34fa-0xac;const _0x2bef69=a7_0x2bef();let _0x3a521c=_0x2bef69[_0x2c34fa];return _0x3a521c;}var __importDefault=this&&this[a7_0x184a3f(0xf3)]||function(_0x184a28){const _0x1776ba=a7_0x184a3f;return _0x184a28&&_0x184a28[_0x1776ba(0xb3)]?_0x184a28:{'default':_0x184a28};};Object[a7_0x184a3f(0xae)](exports,a7_0x184a3f(0xb3),{'value':!![]}),exports['InstaXChangeController']=void 0x0;const database_1=__importDefault(require(a7_0x184a3f(0xb8))),webhookService_1=require('../services/webhookService'),currencyService_1=require(a7_0x184a3f(0xe2));class InstaXChangeController{constructor(){const _0x1aa371=a7_0x184a3f;this[_0x1aa371(0xd1)]=async(_0x49a2b8,_0x3882a2)=>{const _0x3f4dfb=_0x1aa371;try{const {paymentId:_0x31c983,status:_0x3c8d6b,sessionId:_0x2b1d53,webhookData:_0x223884}=_0x49a2b8[_0x3f4dfb(0xe7)];console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xbf)),console['log'](_0x3f4dfb(0xc5)+_0x31c983),console[_0x3f4dfb(0xd9)]('\x20\x20\x20Status:\x20'+_0x3c8d6b),console[_0x3f4dfb(0xd9)]('\x20\x20\x20Session\x20ID:\x20'+_0x2b1d53);if(!_0x31c983||!_0x3c8d6b)return console['error'](_0x3f4dfb(0xf0)),_0x3882a2[_0x3f4dfb(0xe9)](0x190)[_0x3f4dfb(0xc3)]({'success':![],'message':_0x3f4dfb(0xe5)});const _0x486d13=await database_1[_0x3f4dfb(0xba)][_0x3f4dfb(0xc6)][_0x3f4dfb(0xeb)]({'where':{'id':_0x31c983},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x486d13)return console[_0x3f4dfb(0xd4)]('‚ùå\x20Payment\x20not\x20found:\x20'+_0x31c983),_0x3882a2[_0x3f4dfb(0xe9)](0x194)[_0x3f4dfb(0xc3)]({'success':![],'message':_0x3f4dfb(0xbc)});console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xdd)+_0x486d13[_0x3f4dfb(0xe9)]);let _0x179261,_0x111295=![];switch(_0x3c8d6b[_0x3f4dfb(0xe3)]()){case _0x3f4dfb(0xb6):_0x179261=_0x3f4dfb(0xe0),_0x111295=_0x486d13[_0x3f4dfb(0xe9)]!==_0x3f4dfb(0xe0);break;case _0x3f4dfb(0xd5):_0x179261=_0x3f4dfb(0xad);break;default:console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xe6)+_0x3c8d6b+_0x3f4dfb(0xf1));return _0x3882a2[_0x3f4dfb(0xe9)](0xc8)[_0x3f4dfb(0xc3)]({'success':!![],'message':_0x3f4dfb(0xdb)});}console['log']('üîÑ\x20Updating\x20payment\x20status:\x20'+_0x486d13['status']+_0x3f4dfb(0xb2)+_0x179261);const _0x5dbbc4={'status':_0x179261,'updatedAt':new Date()};if(_0x179261==='PAID'){_0x5dbbc4[_0x3f4dfb(0xdc)]=new Date();if(!_0x486d13[_0x3f4dfb(0xb1)]){const _0x33e9a0=await currencyService_1[_0x3f4dfb(0xd0)][_0x3f4dfb(0xea)](_0x486d13[_0x3f4dfb(0xdf)],_0x486d13[_0x3f4dfb(0xc0)]);_0x5dbbc4[_0x3f4dfb(0xb1)]=_0x33e9a0;let _0x3cc9c2=0xa;if(_0x486d13[_0x3f4dfb(0xda)][_0x3f4dfb(0xf5)])try{const _0x444661=JSON[_0x3f4dfb(0xd8)](_0x486d13[_0x3f4dfb(0xda)][_0x3f4dfb(0xf5)]);for(const [_0x19c3c1,_0x284db0]of Object[_0x3f4dfb(0xb4)](_0x444661)){if(_0x19c3c1['toLowerCase']()==='instaxchange'){_0x3cc9c2=_0x284db0[_0x3f4dfb(0xbe)]||0xa;break;}}}catch(_0x2b79ee){console[_0x3f4dfb(0xd4)](_0x3f4dfb(0xb9),_0x2b79ee);}const _0x261b43=_0x33e9a0*(0x1-_0x3cc9c2/0x64);_0x5dbbc4[_0x3f4dfb(0xb7)]=_0x261b43,_0x5dbbc4['gatewayCommissionRate']=_0x3cc9c2,console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xb5)),console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xcd)+_0x33e9a0[_0x3f4dfb(0xcb)](0x6)),console[_0x3f4dfb(0xd9)]('\x20\x20\x20Commission:\x20'+_0x3cc9c2+'%'),console['log'](_0x3f4dfb(0xc8)+_0x261b43[_0x3f4dfb(0xcb)](0x6));}}else{if(_0x179261===_0x3f4dfb(0xad)){const _0x30d770=_0x223884?.[_0x3f4dfb(0xd3)]?.[_0x3f4dfb(0xee)]||'Payment\x20failed';_0x5dbbc4[_0x3f4dfb(0xca)]=_0x30d770,console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xec)+_0x30d770);}}_0x223884&&(_0x5dbbc4[_0x3f4dfb(0xce)]=JSON[_0x3f4dfb(0xc7)](_0x223884));await database_1[_0x3f4dfb(0xba)][_0x3f4dfb(0xc6)][_0x3f4dfb(0xe1)]({'where':{'id':_0x31c983},'data':_0x5dbbc4}),console['log'](_0x3f4dfb(0xe4));if(_0x111295&&_0x179261==='PAID'){const _0xfc8526=_0x5dbbc4[_0x3f4dfb(0xb7)];_0xfc8526&&(await database_1[_0x3f4dfb(0xba)]['shop'][_0x3f4dfb(0xe1)]({'where':{'id':_0x486d13[_0x3f4dfb(0xc9)]},'data':{'balance':{'increment':_0xfc8526}}}),console[_0x3f4dfb(0xd9)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0xfc8526[_0x3f4dfb(0xcb)](0x6)+_0x3f4dfb(0xed)));}try{await this['webhookService'][_0x3f4dfb(0xef)](_0x31c983,_0x179261,{'failureMessage':_0x179261===_0x3f4dfb(0xad)?_0x223884?.[_0x3f4dfb(0xd3)]?.[_0x3f4dfb(0xee)]||_0x3f4dfb(0xb0):undefined}),console[_0x3f4dfb(0xd9)](_0x3f4dfb(0xaf));}catch(_0x266023){console[_0x3f4dfb(0xd4)]('‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:',_0x266023);}return _0x3882a2[_0x3f4dfb(0xe9)](0xc8)['json']({'success':!![],'message':_0x3f4dfb(0xc4)});}catch(_0x1921e7){return console[_0x3f4dfb(0xd4)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0x1921e7),_0x3882a2['status'](0x1f4)[_0x3f4dfb(0xc3)]({'success':![],'message':_0x3f4dfb(0xe8),'error':_0x1921e7 instanceof Error?_0x1921e7['message']:_0x3f4dfb(0xcc)});}},this['webhookService']=new webhookService_1['WebhookService']();}}exports[a7_0x184a3f(0xde)]=InstaXChangeController;