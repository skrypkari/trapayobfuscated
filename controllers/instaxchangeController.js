'use strict';const a7_0x5ee969=a7_0xaf57;function a7_0x5459(){const _0x38bd50=['800376qQjnmo','\x20\x20\x20Amount\x20USDT:\x20','update','1298591wGDnzk','handleWebhook','Error\x20parsing\x20gateway\x20settings:','2675934kOmcFq','\x20\x20\x20Session\x20ID:\x20','InstaXChangeController','35955oafbwO','shopId','FAILED','552qXQDtU','âŒ\x20Failure\x20reason:\x20','amountUSDT','Missing\x20required\x20parameters','completed','amountAfterGatewayCommissionUSDT','error','toLowerCase','json','log','paidAt','16yfFUTV','47898KAhUXz','\x20\x20\x20Merchant\x20Amount:\x20','22IivZKv','Payment\x20failed','status','âŒ\x20InstaXChange\x20webhook\x20processing\x20error:','ðŸ³\x20InstaXChange\x20webhook\x20received:','findUnique','data','statusReason','parse','\x20\x20\x20Commission:\x20','284Zloitr','toFixed','gatewayResponse','\x20USDT','126285XDxoKN','âŒ\x20Payment\x20not\x20found:\x20','Internal\x20server\x20error','body','460HRRgul','entries','gatewayCommissionRate','__esModule','âŒ\x20Missing\x20required\x20webhook\x20parameters','defineProperty','shop','âš ï¸\x20Failed\x20to\x20process\x20webhook\x20notification:','currencyService','526DphmvK','\x20â†’\x20','default','payment','\x20\x20\x20Status:\x20','PAID','instaxchange','commission','__importDefault','\x20\x20\x20Payment\x20ID:\x20','failureMessage','convertToUSDT','Unknown\x20error','message','ðŸ”„\x20Updating\x20payment\x20status:\x20','gatewaySettings','âš ï¸\x20Unknown\x20status:\x20','Webhook\x20processed\x20successfully','failed','âœ…\x20Payment\x20updated\x20successfully','stringify','Payment\x20not\x20found','webhookService','updatePaymentStatus','ðŸ’°\x20Calculated\x20amounts:'];a7_0x5459=function(){return _0x38bd50;};return a7_0x5459();}(function(_0x590bd9,_0x29263c){const _0x2cb1f9=a7_0xaf57,_0x14bc75=_0x590bd9();while(!![]){try{const _0x472419=parseInt(_0x2cb1f9(0x123))/0x1+-parseInt(_0x2cb1f9(0x130))/0x2*(parseInt(_0x2cb1f9(0x107))/0x3)+-parseInt(_0x2cb1f9(0x11f))/0x4*(-parseInt(_0x2cb1f9(0x104))/0x5)+parseInt(_0x2cb1f9(0x101))/0x6+parseInt(_0x2cb1f9(0xfe))/0x7*(-parseInt(_0x2cb1f9(0x112))/0x8)+-parseInt(_0x2cb1f9(0x113))/0x9*(parseInt(_0x2cb1f9(0x127))/0xa)+-parseInt(_0x2cb1f9(0x115))/0xb*(parseInt(_0x2cb1f9(0xfb))/0xc);if(_0x472419===_0x29263c)break;else _0x14bc75['push'](_0x14bc75['shift']());}catch(_0x4350ac){_0x14bc75['push'](_0x14bc75['shift']());}}}(a7_0x5459,0x45a19));var __importDefault=this&&this[a7_0x5ee969(0x138)]||function(_0xbc255b){const _0x5475b1=a7_0x5ee969;return _0xbc255b&&_0xbc255b[_0x5475b1(0x12a)]?_0xbc255b:{'default':_0xbc255b};};Object[a7_0x5ee969(0x12c)](exports,a7_0x5ee969(0x12a),{'value':!![]}),exports[a7_0x5ee969(0x103)]=void 0x0;function a7_0xaf57(_0xd15932,_0x204ed6){_0xd15932=_0xd15932-0xef;const _0x5459f9=a7_0x5459();let _0xaf5783=_0x5459f9[_0xd15932];return _0xaf5783;}const database_1=__importDefault(require('../config/database')),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0x2aa8d0=a7_0x5ee969;this[_0x2aa8d0(0xff)]=async(_0x4452fb,_0x324bc1)=>{const _0x1a8627=_0x2aa8d0;try{const {paymentId:_0x3607a2,status:_0x32865e,sessionId:_0x4d74c9,webhookData:_0x1d1775}=_0x4452fb[_0x1a8627(0x126)];console['log'](_0x1a8627(0x119)),console[_0x1a8627(0x110)](_0x1a8627(0x139)+_0x3607a2),console['log'](_0x1a8627(0x134)+_0x32865e),console[_0x1a8627(0x110)](_0x1a8627(0x102)+_0x4d74c9);if(!_0x3607a2||!_0x32865e)return console[_0x1a8627(0x10d)](_0x1a8627(0x12b)),_0x324bc1[_0x1a8627(0x117)](0x190)['json']({'success':![],'message':_0x1a8627(0x10a)});const _0x260fff=await database_1[_0x1a8627(0x132)]['payment'][_0x1a8627(0x11a)]({'where':{'id':_0x3607a2},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x260fff)return console[_0x1a8627(0x10d)](_0x1a8627(0x124)+_0x3607a2),_0x324bc1['status'](0x194)[_0x1a8627(0x10f)]({'success':![],'message':_0x1a8627(0xf7)});console[_0x1a8627(0x110)]('ðŸ“Š\x20Current\x20payment\x20status:\x20'+_0x260fff[_0x1a8627(0x117)]);let _0x5cda80,_0x9d7db9=![];switch(_0x32865e[_0x1a8627(0x10e)]()){case _0x1a8627(0x10b):_0x5cda80=_0x1a8627(0x135),_0x9d7db9=_0x260fff[_0x1a8627(0x117)]!==_0x1a8627(0x135);break;case _0x1a8627(0xf4):_0x5cda80=_0x1a8627(0x106);break;default:console['log'](_0x1a8627(0xf2)+_0x32865e+',\x20ignoring\x20webhook');return _0x324bc1[_0x1a8627(0x117)](0xc8)[_0x1a8627(0x10f)]({'success':!![],'message':'Status\x20not\x20actionable'});}console['log'](_0x1a8627(0xf0)+_0x260fff['status']+_0x1a8627(0x131)+_0x5cda80);const _0x2e93c8={'status':_0x5cda80,'updatedAt':new Date()};if(_0x5cda80===_0x1a8627(0x135)){_0x2e93c8[_0x1a8627(0x111)]=new Date();if(!_0x260fff[_0x1a8627(0x109)]){const _0x59cff7=await currencyService_1[_0x1a8627(0x12f)][_0x1a8627(0x13b)](_0x260fff['amount'],_0x260fff['currency']);_0x2e93c8['amountUSDT']=_0x59cff7;let _0xb0a9c=0xa;if(_0x260fff[_0x1a8627(0x12d)][_0x1a8627(0xf1)])try{const _0x3a9986=JSON[_0x1a8627(0x11d)](_0x260fff['shop'][_0x1a8627(0xf1)]);for(const [_0x3667a5,_0x157fbf]of Object[_0x1a8627(0x128)](_0x3a9986)){if(_0x3667a5[_0x1a8627(0x10e)]()===_0x1a8627(0x136)){_0xb0a9c=_0x157fbf[_0x1a8627(0x137)]||0xa;break;}}}catch(_0x3cad63){console[_0x1a8627(0x10d)](_0x1a8627(0x100),_0x3cad63);}const _0x3c7837=_0x59cff7*(0x1-_0xb0a9c/0x64);_0x2e93c8[_0x1a8627(0x10c)]=_0x3c7837,_0x2e93c8[_0x1a8627(0x129)]=_0xb0a9c,console[_0x1a8627(0x110)](_0x1a8627(0xfa)),console[_0x1a8627(0x110)](_0x1a8627(0xfc)+_0x59cff7[_0x1a8627(0x120)](0x6)),console[_0x1a8627(0x110)](_0x1a8627(0x11e)+_0xb0a9c+'%'),console['log'](_0x1a8627(0x114)+_0x3c7837[_0x1a8627(0x120)](0x6));}}else{if(_0x5cda80===_0x1a8627(0x106)){const _0x554d8d=_0x1d1775?.['data']?.[_0x1a8627(0x11c)]||'Payment\x20failed';_0x2e93c8[_0x1a8627(0x13a)]=_0x554d8d,console[_0x1a8627(0x110)](_0x1a8627(0x108)+_0x554d8d);}}_0x1d1775&&(_0x2e93c8[_0x1a8627(0x121)]=JSON[_0x1a8627(0xf6)](_0x1d1775));await database_1['default'][_0x1a8627(0x133)][_0x1a8627(0xfd)]({'where':{'id':_0x3607a2},'data':_0x2e93c8}),console[_0x1a8627(0x110)](_0x1a8627(0xf5));if(_0x9d7db9&&_0x5cda80===_0x1a8627(0x135)){const _0x488e6d=_0x2e93c8[_0x1a8627(0x10c)];_0x488e6d&&(await database_1[_0x1a8627(0x132)]['shop'][_0x1a8627(0xfd)]({'where':{'id':_0x260fff[_0x1a8627(0x105)]},'data':{'balance':{'increment':_0x488e6d}}}),console['log']('ðŸ’°\x20Shop\x20balance\x20updated:\x20+'+_0x488e6d[_0x1a8627(0x120)](0x6)+_0x1a8627(0x122)));}try{await this['webhookService'][_0x1a8627(0xf9)](_0x3607a2,_0x5cda80,{'failureMessage':_0x5cda80===_0x1a8627(0x106)?_0x1d1775?.[_0x1a8627(0x11b)]?.['statusReason']||_0x1a8627(0x116):undefined}),console[_0x1a8627(0x110)]('ðŸ“¤\x20Webhook\x20notification\x20processed');}catch(_0x225e4a){console['error'](_0x1a8627(0x12e),_0x225e4a);}return _0x324bc1[_0x1a8627(0x117)](0xc8)['json']({'success':!![],'message':_0x1a8627(0xf3)});}catch(_0x3927b0){return console[_0x1a8627(0x10d)](_0x1a8627(0x118),_0x3927b0),_0x324bc1[_0x1a8627(0x117)](0x1f4)[_0x1a8627(0x10f)]({'success':![],'message':_0x1a8627(0x125),'error':_0x3927b0 instanceof Error?_0x3927b0[_0x1a8627(0xef)]:_0x1a8627(0x13c)});}},this[_0x2aa8d0(0xf8)]=new webhookService_1['WebhookService']();}}exports[a7_0x5ee969(0x103)]=InstaXChangeController;