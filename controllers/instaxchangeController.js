'use strict';const a7_0xa6205a=a7_0x1f8e;function a7_0x1f8e(_0x3aa0f2,_0x47430a){_0x3aa0f2=_0x3aa0f2-0x158;const _0x402b72=a7_0x402b();let _0x1f8e8f=_0x402b72[_0x3aa0f2];return _0x1f8e8f;}(function(_0x2d0cb9,_0x2b47b0){const _0x2de6f7=a7_0x1f8e,_0x1b4aba=_0x2d0cb9();while(!![]){try{const _0x92c81c=parseInt(_0x2de6f7(0x192))/0x1*(parseInt(_0x2de6f7(0x16c))/0x2)+parseInt(_0x2de6f7(0x18a))/0x3+-parseInt(_0x2de6f7(0x158))/0x4+-parseInt(_0x2de6f7(0x171))/0x5*(-parseInt(_0x2de6f7(0x185))/0x6)+-parseInt(_0x2de6f7(0x17b))/0x7*(parseInt(_0x2de6f7(0x165))/0x8)+parseInt(_0x2de6f7(0x18f))/0x9+-parseInt(_0x2de6f7(0x166))/0xa;if(_0x92c81c===_0x2b47b0)break;else _0x1b4aba['push'](_0x1b4aba['shift']());}catch(_0x4eae6a){_0x1b4aba['push'](_0x1b4aba['shift']());}}}(a7_0x402b,0x58cae));function a7_0x402b(){const _0x11c29b=['error','PAID','webhookService','payment','484942kcXJVf','log','‚ùå\x20Missing\x20required\x20webhook\x20parameters','shop','data','9350kGhGef','Payment\x20failed','stringify','convertToUSDT','status','FAILED','\x20\x20\x20Session\x20ID:\x20','Internal\x20server\x20error','\x20\x20\x20Merchant\x20Amount:\x20','currencyService','973bOGCSe','Payment\x20not\x20found','Missing\x20required\x20parameters','gatewayResponse','message','‚ö†Ô∏è\x20Unknown\x20status:\x20',',\x20ignoring\x20webhook','WebhookService','failureMessage','‚ùå\x20Payment\x20not\x20found:\x20','2166CYrjYz','\x20\x20\x20Amount\x20USDT:\x20','update','amountUSDT','commission','1296213xlCMtH','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','completed','InstaXChangeController','4628502SgVNAG','\x20\x20\x20Status:\x20','\x20\x20\x20Commission:\x20','2xNjzSU','toLowerCase','findUnique','gatewaySettings','üì§\x20Webhook\x20notification\x20processed','Webhook\x20processed\x20successfully','\x20‚Üí\x20','instaxchange','__esModule','updatePaymentStatus','defineProperty','üìä\x20Current\x20payment\x20status:\x20','486944VaQCLS','statusReason','default','\x20\x20\x20Payment\x20ID:\x20','gatewayCommissionRate','json','../services/webhookService','üîÑ\x20Updating\x20payment\x20status:\x20','entries','body','‚úÖ\x20Payment\x20updated\x20successfully','parse','../services/currencyService','1000RtTJwG','16035560YMeoJT','toFixed'];a7_0x402b=function(){return _0x11c29b;};return a7_0x402b();}var __importDefault=this&&this['__importDefault']||function(_0x42820f){const _0x37f0b0=a7_0x1f8e;return _0x42820f&&_0x42820f[_0x37f0b0(0x19a)]?_0x42820f:{'default':_0x42820f};};Object[a7_0xa6205a(0x19c)](exports,a7_0xa6205a(0x19a),{'value':!![]}),exports[a7_0xa6205a(0x18e)]=void 0x0;const database_1=__importDefault(require('../config/database')),webhookService_1=require(a7_0xa6205a(0x15e)),currencyService_1=require(a7_0xa6205a(0x164));class InstaXChangeController{constructor(){const _0x4ff206=a7_0xa6205a;this['handleWebhook']=async(_0x219001,_0x2dc47c)=>{const _0x466b2a=a7_0x1f8e;try{const {paymentId:_0x91c844,status:_0x1d7e14,sessionId:_0xfd58f1,webhookData:_0x46c4ff}=_0x219001[_0x466b2a(0x161)];console['log']('üê≥\x20InstaXChange\x20webhook\x20received:'),console[_0x466b2a(0x16d)](_0x466b2a(0x15b)+_0x91c844),console[_0x466b2a(0x16d)](_0x466b2a(0x190)+_0x1d7e14),console['log'](_0x466b2a(0x177)+_0xfd58f1);if(!_0x91c844||!_0x1d7e14)return console[_0x466b2a(0x168)](_0x466b2a(0x16e)),_0x2dc47c[_0x466b2a(0x175)](0x190)['json']({'success':![],'message':_0x466b2a(0x17d)});const _0x282bb8=await database_1[_0x466b2a(0x15a)][_0x466b2a(0x16b)][_0x466b2a(0x194)]({'where':{'id':_0x91c844},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x282bb8)return console[_0x466b2a(0x168)](_0x466b2a(0x184)+_0x91c844),_0x2dc47c[_0x466b2a(0x175)](0x194)[_0x466b2a(0x15d)]({'success':![],'message':_0x466b2a(0x17c)});console[_0x466b2a(0x16d)](_0x466b2a(0x19d)+_0x282bb8[_0x466b2a(0x175)]);let _0x17eac6,_0x10815f=![];switch(_0x1d7e14[_0x466b2a(0x193)]()){case _0x466b2a(0x18d):_0x17eac6=_0x466b2a(0x169),_0x10815f=_0x282bb8[_0x466b2a(0x175)]!==_0x466b2a(0x169);break;case'failed':_0x17eac6=_0x466b2a(0x176);break;default:console[_0x466b2a(0x16d)](_0x466b2a(0x180)+_0x1d7e14+_0x466b2a(0x181));return _0x2dc47c[_0x466b2a(0x175)](0xc8)[_0x466b2a(0x15d)]({'success':!![],'message':'Status\x20not\x20actionable'});}console[_0x466b2a(0x16d)](_0x466b2a(0x15f)+_0x282bb8[_0x466b2a(0x175)]+_0x466b2a(0x198)+_0x17eac6);const _0x56a01d={'status':_0x17eac6,'updatedAt':new Date()};if(_0x17eac6===_0x466b2a(0x169)){_0x56a01d['paidAt']=new Date();if(!_0x282bb8[_0x466b2a(0x188)]){const _0x4a79ca=await currencyService_1[_0x466b2a(0x17a)][_0x466b2a(0x174)](_0x282bb8['amount'],_0x282bb8['currency']);_0x56a01d[_0x466b2a(0x188)]=_0x4a79ca;let _0x14e424=0xa;if(_0x282bb8['shop'][_0x466b2a(0x195)])try{const _0x41687f=JSON[_0x466b2a(0x163)](_0x282bb8[_0x466b2a(0x16f)][_0x466b2a(0x195)]);for(const [_0x2a5a28,_0xb8e93c]of Object[_0x466b2a(0x160)](_0x41687f)){if(_0x2a5a28[_0x466b2a(0x193)]()===_0x466b2a(0x199)){_0x14e424=_0xb8e93c[_0x466b2a(0x189)]||0xa;break;}}}catch(_0x527e46){console['error']('Error\x20parsing\x20gateway\x20settings:',_0x527e46);}const _0x46d682=_0x4a79ca*(0x1-_0x14e424/0x64);_0x56a01d['amountAfterGatewayCommissionUSDT']=_0x46d682,_0x56a01d[_0x466b2a(0x15c)]=_0x14e424,console['log']('üí∞\x20Calculated\x20amounts:'),console[_0x466b2a(0x16d)](_0x466b2a(0x186)+_0x4a79ca[_0x466b2a(0x167)](0x6)),console[_0x466b2a(0x16d)](_0x466b2a(0x191)+_0x14e424+'%'),console[_0x466b2a(0x16d)](_0x466b2a(0x179)+_0x46d682[_0x466b2a(0x167)](0x6));}}else{if(_0x17eac6===_0x466b2a(0x176)){const _0x56d408=_0x46c4ff?.[_0x466b2a(0x170)]?.[_0x466b2a(0x159)]||_0x466b2a(0x172);_0x56a01d[_0x466b2a(0x183)]=_0x56d408,console[_0x466b2a(0x16d)]('‚ùå\x20Failure\x20reason:\x20'+_0x56d408);}}_0x46c4ff&&(_0x56a01d[_0x466b2a(0x17e)]=JSON[_0x466b2a(0x173)](_0x46c4ff));await database_1[_0x466b2a(0x15a)][_0x466b2a(0x16b)][_0x466b2a(0x187)]({'where':{'id':_0x91c844},'data':_0x56a01d}),console['log'](_0x466b2a(0x162));if(_0x10815f&&_0x17eac6==='PAID'){const _0xaddee9=_0x56a01d['amountAfterGatewayCommissionUSDT'];_0xaddee9&&(await database_1[_0x466b2a(0x15a)]['shop'][_0x466b2a(0x187)]({'where':{'id':_0x282bb8['shopId']},'data':{'balance':{'increment':_0xaddee9}}}),console[_0x466b2a(0x16d)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0xaddee9[_0x466b2a(0x167)](0x6)+'\x20USDT'));}try{await this[_0x466b2a(0x16a)][_0x466b2a(0x19b)](_0x91c844,_0x17eac6,{'failureMessage':_0x17eac6===_0x466b2a(0x176)?_0x46c4ff?.[_0x466b2a(0x170)]?.[_0x466b2a(0x159)]||_0x466b2a(0x172):undefined}),console['log'](_0x466b2a(0x196));}catch(_0x34b7a9){console[_0x466b2a(0x168)](_0x466b2a(0x18b),_0x34b7a9);}return _0x2dc47c[_0x466b2a(0x175)](0xc8)[_0x466b2a(0x15d)]({'success':!![],'message':_0x466b2a(0x197)});}catch(_0x5d50d8){return console[_0x466b2a(0x168)](_0x466b2a(0x18c),_0x5d50d8),_0x2dc47c[_0x466b2a(0x175)](0x1f4)['json']({'success':![],'message':_0x466b2a(0x178),'error':_0x5d50d8 instanceof Error?_0x5d50d8[_0x466b2a(0x17f)]:'Unknown\x20error'});}},this[_0x4ff206(0x16a)]=new webhookService_1[(_0x4ff206(0x182))]();}}exports[a7_0xa6205a(0x18e)]=InstaXChangeController;