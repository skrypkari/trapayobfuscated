'use strict';const a8_0x3c710e=a8_0x5f02;(function(_0x19cd70,_0x11cf42){const _0x48b237=a8_0x5f02,_0xc9dca1=_0x19cd70();while(!![]){try{const _0x1c9c6e=-parseInt(_0x48b237(0xad))/0x1+-parseInt(_0x48b237(0xa8))/0x2+parseInt(_0x48b237(0x9c))/0x3+parseInt(_0x48b237(0x9f))/0x4*(-parseInt(_0x48b237(0x9b))/0x5)+parseInt(_0x48b237(0xa9))/0x6*(-parseInt(_0x48b237(0x89))/0x7)+parseInt(_0x48b237(0xc5))/0x8+-parseInt(_0x48b237(0xbe))/0x9*(-parseInt(_0x48b237(0xb2))/0xa);if(_0x1c9c6e===_0x11cf42)break;else _0xc9dca1['push'](_0xc9dca1['shift']());}catch(_0x153739){_0xc9dca1['push'](_0xc9dca1['shift']());}}}(a8_0x3ec2,0xe6213));function a8_0x5f02(_0x5bcf86,_0x4cc3d1){_0x5bcf86=_0x5bcf86-0x84;const _0x3ec269=a8_0x3ec2();let _0x5f02d4=_0x3ec269[_0x5bcf86];return _0x5f02d4;}function a8_0x3ec2(){const _0x572901=['error','2239304hBfCvg','amountAfterGatewayCommissionUSDT','currencyService','toLowerCase','Unknown\x20error','parse','shopId','defineProperty','convertToUSDT','2737080XmGLUJ','22374HZOfkj','Status\x20not\x20actionable','WebhookService','toFixed','1816450VaNEMx','data','payment','__importDefault','\x20\x20\x20Commission:\x20','2290qBZgYI','\x20USDT','status','body','amount','entries','failed','Webhook\x20processed\x20successfully','shop','currency','üìä\x20Current\x20payment\x20status:\x20','statusReason','134037FOoEwi','commission','default','InstaXChangeController','findUnique','gatewayResponse','üí∞\x20Shop\x20balance\x20updated:\x20+','12825680BOTKmZ','failureMessage',',\x20ignoring\x20webhook','üì§\x20Webhook\x20notification\x20processed','\x20\x20\x20Merchant\x20Amount:\x20','amountUSDT','../config/database','gatewaySettings','\x20\x20\x20Session\x20ID:\x20','‚ùå\x20Payment\x20not\x20found:\x20','log','2723ZEXXpC','üê≥\x20InstaXChange\x20webhook\x20received:','instaxchange','message','completed','webhookService','‚úÖ\x20Payment\x20updated\x20successfully','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','__esModule','\x20\x20\x20Amount\x20USDT:\x20','json','stringify','‚ùå\x20Failure\x20reason:\x20','update','gatewayCommissionRate','Payment\x20failed','PAID','Payment\x20not\x20found','10WAGfJL','5052381PuvkTe','FAILED'];a8_0x3ec2=function(){return _0x572901;};return a8_0x3ec2();}var __importDefault=this&&this[a8_0x3c710e(0xb0)]||function(_0x173325){return _0x173325&&_0x173325['__esModule']?_0x173325:{'default':_0x173325};};Object[a8_0x3c710e(0xa6)](exports,a8_0x3c710e(0x91),{'value':!![]}),exports[a8_0x3c710e(0xc1)]=void 0x0;const database_1=__importDefault(require(a8_0x3c710e(0x84))),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0x222827=a8_0x3c710e;this['handleWebhook']=async(_0x338558,_0x1d7649)=>{const _0x4c6ec8=a8_0x5f02;try{const {paymentId:_0x56be09,status:_0xac14e1,sessionId:_0x410152,webhookData:_0x5c8ed8}=_0x338558[_0x4c6ec8(0xb5)];console[_0x4c6ec8(0x88)](_0x4c6ec8(0x8a)),console[_0x4c6ec8(0x88)]('\x20\x20\x20Payment\x20ID:\x20'+_0x56be09),console[_0x4c6ec8(0x88)]('\x20\x20\x20Status:\x20'+_0xac14e1),console['log'](_0x4c6ec8(0x86)+_0x410152);if(!_0x56be09||!_0xac14e1)return console['error']('‚ùå\x20Missing\x20required\x20webhook\x20parameters'),_0x1d7649[_0x4c6ec8(0xb4)](0x190)['json']({'success':![],'message':'Missing\x20required\x20parameters'});const _0x363561=await database_1[_0x4c6ec8(0xc0)][_0x4c6ec8(0xaf)][_0x4c6ec8(0xc2)]({'where':{'id':_0x56be09},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x363561)return console[_0x4c6ec8(0x9e)](_0x4c6ec8(0x87)+_0x56be09),_0x1d7649[_0x4c6ec8(0xb4)](0x194)[_0x4c6ec8(0x93)]({'success':![],'message':_0x4c6ec8(0x9a)});console[_0x4c6ec8(0x88)](_0x4c6ec8(0xbc)+_0x363561[_0x4c6ec8(0xb4)]);let _0x5894bd,_0x4f71c8=![];switch(_0xac14e1[_0x4c6ec8(0xa2)]()){case _0x4c6ec8(0x8d):_0x5894bd=_0x4c6ec8(0x99),_0x4f71c8=_0x363561[_0x4c6ec8(0xb4)]!==_0x4c6ec8(0x99);break;case _0x4c6ec8(0xb8):_0x5894bd=_0x4c6ec8(0x9d);break;default:console['log']('‚ö†Ô∏è\x20Unknown\x20status:\x20'+_0xac14e1+_0x4c6ec8(0xc7));return _0x1d7649['status'](0xc8)['json']({'success':!![],'message':_0x4c6ec8(0xaa)});}console[_0x4c6ec8(0x88)]('üîÑ\x20Updating\x20payment\x20status:\x20'+_0x363561[_0x4c6ec8(0xb4)]+'\x20‚Üí\x20'+_0x5894bd);const _0x40021c={'status':_0x5894bd,'updatedAt':new Date()};if(_0x5894bd===_0x4c6ec8(0x99)){_0x40021c['paidAt']=new Date();if(!_0x363561[_0x4c6ec8(0xca)]){const _0x2f608a=await currencyService_1[_0x4c6ec8(0xa1)][_0x4c6ec8(0xa7)](_0x363561[_0x4c6ec8(0xb6)],_0x363561[_0x4c6ec8(0xbb)]);_0x40021c[_0x4c6ec8(0xca)]=_0x2f608a;let _0x1a1084=0xa;if(_0x363561[_0x4c6ec8(0xba)]['gatewaySettings'])try{const _0x41472d=JSON[_0x4c6ec8(0xa4)](_0x363561[_0x4c6ec8(0xba)][_0x4c6ec8(0x85)]);for(const [_0xed3177,_0x1b93a7]of Object[_0x4c6ec8(0xb7)](_0x41472d)){if(_0xed3177[_0x4c6ec8(0xa2)]()===_0x4c6ec8(0x8b)){_0x1a1084=_0x1b93a7[_0x4c6ec8(0xbf)]||0xa;break;}}}catch(_0x5c3cc9){console[_0x4c6ec8(0x9e)]('Error\x20parsing\x20gateway\x20settings:',_0x5c3cc9);}const _0x2e9c53=_0x2f608a*(0x1-_0x1a1084/0x64);_0x40021c[_0x4c6ec8(0xa0)]=_0x2e9c53,_0x40021c[_0x4c6ec8(0x97)]=_0x1a1084,console['log']('üí∞\x20Calculated\x20amounts:'),console[_0x4c6ec8(0x88)](_0x4c6ec8(0x92)+_0x2f608a[_0x4c6ec8(0xac)](0x6)),console[_0x4c6ec8(0x88)](_0x4c6ec8(0xb1)+_0x1a1084+'%'),console[_0x4c6ec8(0x88)](_0x4c6ec8(0xc9)+_0x2e9c53[_0x4c6ec8(0xac)](0x6));}}else{if(_0x5894bd===_0x4c6ec8(0x9d)){const _0x3155e0=_0x5c8ed8?.[_0x4c6ec8(0xae)]?.[_0x4c6ec8(0xbd)]||'Payment\x20failed';_0x40021c[_0x4c6ec8(0xc6)]=_0x3155e0,console[_0x4c6ec8(0x88)](_0x4c6ec8(0x95)+_0x3155e0);}}_0x5c8ed8&&(_0x40021c[_0x4c6ec8(0xc3)]=JSON[_0x4c6ec8(0x94)](_0x5c8ed8));await database_1[_0x4c6ec8(0xc0)][_0x4c6ec8(0xaf)][_0x4c6ec8(0x96)]({'where':{'id':_0x56be09},'data':_0x40021c}),console[_0x4c6ec8(0x88)](_0x4c6ec8(0x8f));if(_0x4f71c8&&_0x5894bd===_0x4c6ec8(0x99)){const _0x517bdb=_0x40021c[_0x4c6ec8(0xa0)];_0x517bdb&&(await database_1[_0x4c6ec8(0xc0)]['shop']['update']({'where':{'id':_0x363561[_0x4c6ec8(0xa5)]},'data':{'balance':{'increment':_0x517bdb}}}),console[_0x4c6ec8(0x88)](_0x4c6ec8(0xc4)+_0x517bdb['toFixed'](0x6)+_0x4c6ec8(0xb3)));}try{await this[_0x4c6ec8(0x8e)]['updatePaymentStatus'](_0x56be09,_0x5894bd,{'failureMessage':_0x5894bd==='FAILED'?_0x5c8ed8?.[_0x4c6ec8(0xae)]?.[_0x4c6ec8(0xbd)]||_0x4c6ec8(0x98):undefined}),console[_0x4c6ec8(0x88)](_0x4c6ec8(0xc8));}catch(_0x55e2bd){console[_0x4c6ec8(0x9e)](_0x4c6ec8(0x90),_0x55e2bd);}return _0x1d7649[_0x4c6ec8(0xb4)](0xc8)['json']({'success':!![],'message':_0x4c6ec8(0xb9)});}catch(_0x4ad786){return console[_0x4c6ec8(0x9e)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0x4ad786),_0x1d7649[_0x4c6ec8(0xb4)](0x1f4)['json']({'success':![],'message':'Internal\x20server\x20error','error':_0x4ad786 instanceof Error?_0x4ad786[_0x4c6ec8(0x8c)]:_0x4c6ec8(0xa3)});}},this[_0x222827(0x8e)]=new webhookService_1[(_0x222827(0xab))]();}}exports[a8_0x3c710e(0xc1)]=InstaXChangeController;