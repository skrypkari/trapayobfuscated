'use strict';function a7_0x2ccb(_0x495648,_0x250c65){_0x495648=_0x495648-0x11c;const _0x1701fd=a7_0x1701();let _0x2ccba5=_0x1701fd[_0x495648];return _0x2ccba5;}const a7_0x892b06=a7_0x2ccb;(function(_0x21c3a8,_0xdc11eb){const _0x1a3ec9=a7_0x2ccb,_0x400fd1=_0x21c3a8();while(!![]){try{const _0x310f02=parseInt(_0x1a3ec9(0x14c))/0x1*(parseInt(_0x1a3ec9(0x158))/0x2)+parseInt(_0x1a3ec9(0x151))/0x3+-parseInt(_0x1a3ec9(0x122))/0x4+-parseInt(_0x1a3ec9(0x133))/0x5+parseInt(_0x1a3ec9(0x15c))/0x6*(-parseInt(_0x1a3ec9(0x154))/0x7)+-parseInt(_0x1a3ec9(0x13e))/0x8*(parseInt(_0x1a3ec9(0x145))/0x9)+-parseInt(_0x1a3ec9(0x14b))/0xa*(-parseInt(_0x1a3ec9(0x130))/0xb);if(_0x310f02===_0xdc11eb)break;else _0x400fd1['push'](_0x400fd1['shift']());}catch(_0x48f439){_0x400fd1['push'](_0x400fd1['shift']());}}}(a7_0x1701,0xc3061));var __importDefault=this&&this[a7_0x892b06(0x11d)]||function(_0x356543){return _0x356543&&_0x356543['__esModule']?_0x356543:{'default':_0x356543};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a7_0x892b06(0x13b)]=void 0x0;const database_1=__importDefault(require('../config/database')),webhookService_1=require(a7_0x892b06(0x13a)),currencyService_1=require('../services/currencyService');function a7_0x1701(){const _0x58bc1f=['message','Payment\x20failed','4914564ZrelLB','status','webhookService','statusReason','json','toLowerCase','amountAfterGatewayCommissionUSDT','currency','default','shop','instaxchange','gatewaySettings','stringify','\x20‚Üí\x20','6908572GXBeSz','commission','‚ùå\x20Payment\x20not\x20found:\x20','1776025lHsDxh','updatePaymentStatus','üìä\x20Current\x20payment\x20status:\x20','‚ö†Ô∏è\x20Unknown\x20status:\x20','Internal\x20server\x20error','findUnique','PAID','../services/webhookService','InstaXChangeController','entries','Webhook\x20processed\x20successfully','5152hUBirD','\x20USDT','convertToUSDT','paidAt','amount','Status\x20not\x20actionable','completed','2223RgaZxE','\x20\x20\x20Commission:\x20','body','toFixed','data','Missing\x20required\x20parameters','20eCdGCP','733XoReFI','failureMessage','\x20\x20\x20Status:\x20','failed','error','1960272ELYbkR','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','üê≥\x20InstaXChange\x20webhook\x20received:','2429edYqyk',',\x20ignoring\x20webhook','‚ùå\x20Missing\x20required\x20webhook\x20parameters','üí∞\x20Shop\x20balance\x20updated:\x20+','2810kkEdDb','amountUSDT','üîÑ\x20Updating\x20payment\x20status:\x20','FAILED','6876kVvmdp','gatewayCommissionRate','\x20\x20\x20Amount\x20USDT:\x20','update','‚úÖ\x20Payment\x20updated\x20successfully','payment','log','\x20\x20\x20Merchant\x20Amount:\x20','__importDefault','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','gatewayResponse'];a7_0x1701=function(){return _0x58bc1f;};return a7_0x1701();}class InstaXChangeController{constructor(){this['handleWebhook']=async(_0x24a673,_0x3c6e83)=>{const _0x2900c6=a7_0x2ccb;try{const {paymentId:_0x414792,status:_0x1dbee5,sessionId:_0x4bc375,webhookData:_0xfef671}=_0x24a673[_0x2900c6(0x147)];console[_0x2900c6(0x162)](_0x2900c6(0x153)),console[_0x2900c6(0x162)]('\x20\x20\x20Payment\x20ID:\x20'+_0x414792),console[_0x2900c6(0x162)](_0x2900c6(0x14e)+_0x1dbee5),console['log']('\x20\x20\x20Session\x20ID:\x20'+_0x4bc375);if(!_0x414792||!_0x1dbee5)return console[_0x2900c6(0x150)](_0x2900c6(0x156)),_0x3c6e83[_0x2900c6(0x123)](0x190)[_0x2900c6(0x126)]({'success':![],'message':_0x2900c6(0x14a)});const _0x4506a4=await database_1['default'][_0x2900c6(0x161)][_0x2900c6(0x138)]({'where':{'id':_0x414792},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x4506a4)return console[_0x2900c6(0x150)](_0x2900c6(0x132)+_0x414792),_0x3c6e83['status'](0x194)[_0x2900c6(0x126)]({'success':![],'message':'Payment\x20not\x20found'});console[_0x2900c6(0x162)](_0x2900c6(0x135)+_0x4506a4[_0x2900c6(0x123)]);let _0x1cf311,_0x393b94=![];switch(_0x1dbee5[_0x2900c6(0x127)]()){case _0x2900c6(0x144):_0x1cf311=_0x2900c6(0x139),_0x393b94=_0x4506a4[_0x2900c6(0x123)]!==_0x2900c6(0x139);break;case _0x2900c6(0x14f):_0x1cf311=_0x2900c6(0x15b);break;default:console['log'](_0x2900c6(0x136)+_0x1dbee5+_0x2900c6(0x155));return _0x3c6e83[_0x2900c6(0x123)](0xc8)['json']({'success':!![],'message':_0x2900c6(0x143)});}console[_0x2900c6(0x162)](_0x2900c6(0x15a)+_0x4506a4[_0x2900c6(0x123)]+_0x2900c6(0x12f)+_0x1cf311);const _0x298cbb={'status':_0x1cf311,'updatedAt':new Date()};if(_0x1cf311==='PAID'){_0x298cbb[_0x2900c6(0x141)]=new Date();if(!_0x4506a4[_0x2900c6(0x159)]){const _0x21c6d1=await currencyService_1['currencyService'][_0x2900c6(0x140)](_0x4506a4[_0x2900c6(0x142)],_0x4506a4[_0x2900c6(0x129)]);_0x298cbb[_0x2900c6(0x159)]=_0x21c6d1;let _0x558dfd=0xa;if(_0x4506a4[_0x2900c6(0x12b)][_0x2900c6(0x12d)])try{const _0x2450bf=JSON['parse'](_0x4506a4[_0x2900c6(0x12b)]['gatewaySettings']);for(const [_0x233e7f,_0x14ec40]of Object[_0x2900c6(0x13c)](_0x2450bf)){if(_0x233e7f['toLowerCase']()===_0x2900c6(0x12c)){_0x558dfd=_0x14ec40[_0x2900c6(0x131)]||0xa;break;}}}catch(_0x87c77b){console[_0x2900c6(0x150)]('Error\x20parsing\x20gateway\x20settings:',_0x87c77b);}const _0x5b5a69=_0x21c6d1*(0x1-_0x558dfd/0x64);_0x298cbb['amountAfterGatewayCommissionUSDT']=_0x5b5a69,_0x298cbb[_0x2900c6(0x15d)]=_0x558dfd,console[_0x2900c6(0x162)]('üí∞\x20Calculated\x20amounts:'),console[_0x2900c6(0x162)](_0x2900c6(0x15e)+_0x21c6d1['toFixed'](0x6)),console[_0x2900c6(0x162)](_0x2900c6(0x146)+_0x558dfd+'%'),console[_0x2900c6(0x162)](_0x2900c6(0x11c)+_0x5b5a69['toFixed'](0x6));}}else{if(_0x1cf311===_0x2900c6(0x15b)){const _0x4516ed=_0xfef671?.[_0x2900c6(0x149)]?.[_0x2900c6(0x125)]||_0x2900c6(0x121);_0x298cbb[_0x2900c6(0x14d)]=_0x4516ed,console[_0x2900c6(0x162)]('‚ùå\x20Failure\x20reason:\x20'+_0x4516ed);}}_0xfef671&&(_0x298cbb[_0x2900c6(0x11f)]=JSON[_0x2900c6(0x12e)](_0xfef671));await database_1[_0x2900c6(0x12a)][_0x2900c6(0x161)][_0x2900c6(0x15f)]({'where':{'id':_0x414792},'data':_0x298cbb}),console[_0x2900c6(0x162)](_0x2900c6(0x160));if(_0x393b94&&_0x1cf311===_0x2900c6(0x139)){const _0x28d6ab=_0x298cbb[_0x2900c6(0x128)];_0x28d6ab&&(await database_1[_0x2900c6(0x12a)][_0x2900c6(0x12b)][_0x2900c6(0x15f)]({'where':{'id':_0x4506a4['shopId']},'data':{'balance':{'increment':_0x28d6ab}}}),console[_0x2900c6(0x162)](_0x2900c6(0x157)+_0x28d6ab[_0x2900c6(0x148)](0x6)+_0x2900c6(0x13f)));}try{await this[_0x2900c6(0x124)][_0x2900c6(0x134)](_0x414792,_0x1cf311,{'failureMessage':_0x1cf311===_0x2900c6(0x15b)?_0xfef671?.['data']?.[_0x2900c6(0x125)]||_0x2900c6(0x121):undefined}),console['log']('üì§\x20Webhook\x20notification\x20processed');}catch(_0x550e17){console[_0x2900c6(0x150)](_0x2900c6(0x152),_0x550e17);}return _0x3c6e83[_0x2900c6(0x123)](0xc8)['json']({'success':!![],'message':_0x2900c6(0x13d)});}catch(_0x20115b){return console[_0x2900c6(0x150)](_0x2900c6(0x11e),_0x20115b),_0x3c6e83[_0x2900c6(0x123)](0x1f4)['json']({'success':![],'message':_0x2900c6(0x137),'error':_0x20115b instanceof Error?_0x20115b[_0x2900c6(0x120)]:'Unknown\x20error'});}},this['webhookService']=new webhookService_1['WebhookService']();}}exports[a7_0x892b06(0x13b)]=InstaXChangeController;