'use strict';const a8_0x240862=a8_0x2767;function a8_0x2767(_0x5b8be8,_0x49d00f){_0x5b8be8=_0x5b8be8-0xbf;const _0x36022c=a8_0x3602();let _0x2767f7=_0x36022c[_0x5b8be8];return _0x2767f7;}function a8_0x3602(){const _0x1a5331=['\x20\x20\x20Amount\x20USDT:\x20','Status\x20not\x20actionable','\x20\x20\x20Status:\x20','toLowerCase','statusReason','body','PAID','InstaXChangeController','WebhookService','paidAt','error','666430VGmvtH','273352guGJAo','../config/database','459wbtjOC','__importDefault','updatePaymentStatus','üê≥\x20InstaXChange\x20webhook\x20received:','entries','gatewayCommissionRate','amountUSDT','2QsFdiu','update','webhookService','üí∞\x20Shop\x20balance\x20updated:\x20+','../services/currencyService','message','amountAfterGatewayCommissionUSDT','66RxImJl','gatewaySettings','üí∞\x20Calculated\x20amounts:','366093YIMWyB','6019160NATULm','Webhook\x20processed\x20successfully','toFixed','400813QXHAJf','‚úÖ\x20Payment\x20updated\x20successfully',',\x20ignoring\x20webhook','status','payment','defineProperty','findUnique','‚ùå\x20Payment\x20not\x20found:\x20','\x20\x20\x20Session\x20ID:\x20','Unknown\x20error','gatewayResponse','../services/webhookService','shop','\x20\x20\x20Payment\x20ID:\x20','__esModule','stringify','data','FAILED','shopId','4380042dTNuDo','\x20\x20\x20Commission:\x20','‚ùå\x20Failure\x20reason:\x20','log','currency','json','Payment\x20failed','Payment\x20not\x20found','1007260wDmwgT','Missing\x20required\x20parameters','default','üìä\x20Current\x20payment\x20status:\x20','Error\x20parsing\x20gateway\x20settings:'];a8_0x3602=function(){return _0x1a5331;};return a8_0x3602();}(function(_0x571553,_0x3c61d3){const _0x5cc919=a8_0x2767,_0xfcffe9=_0x571553();while(!![]){try{const _0x51af79=parseInt(_0x5cc919(0xe9))/0x1+parseInt(_0x5cc919(0xdf))/0x2*(-parseInt(_0x5cc919(0x100))/0x3)+parseInt(_0x5cc919(0xd6))/0x4+-parseInt(_0x5cc919(0xc5))/0x5+-parseInt(_0x5cc919(0xe6))/0x6*(parseInt(_0x5cc919(0xed))/0x7)+-parseInt(_0x5cc919(0xea))/0x8+parseInt(_0x5cc919(0xd8))/0x9*(parseInt(_0x5cc919(0xd5))/0xa);if(_0x51af79===_0x3c61d3)break;else _0xfcffe9['push'](_0xfcffe9['shift']());}catch(_0x59e80d){_0xfcffe9['push'](_0xfcffe9['shift']());}}}(a8_0x3602,0xc0c0a));var __importDefault=this&&this[a8_0x240862(0xd9)]||function(_0xb0fe00){const _0x12447a=a8_0x240862;return _0xb0fe00&&_0xb0fe00[_0x12447a(0xfb)]?_0xb0fe00:{'default':_0xb0fe00};};Object[a8_0x240862(0xf2)](exports,a8_0x240862(0xfb),{'value':!![]}),exports['InstaXChangeController']=void 0x0;const database_1=__importDefault(require(a8_0x240862(0xd7))),webhookService_1=require(a8_0x240862(0xf8)),currencyService_1=require(a8_0x240862(0xe3));class InstaXChangeController{constructor(){const _0x4a364d=a8_0x240862;this['handleWebhook']=async(_0x2dd0fa,_0x223dac)=>{const _0x2f79dc=a8_0x2767;try{const {paymentId:_0x2e786f,status:_0x55745a,sessionId:_0x52c57e,webhookData:_0x3da365}=_0x2dd0fa[_0x2f79dc(0xcf)];console['log'](_0x2f79dc(0xdb)),console[_0x2f79dc(0xc0)](_0x2f79dc(0xfa)+_0x2e786f),console[_0x2f79dc(0xc0)](_0x2f79dc(0xcc)+_0x55745a),console[_0x2f79dc(0xc0)](_0x2f79dc(0xf5)+_0x52c57e);if(!_0x2e786f||!_0x55745a)return console[_0x2f79dc(0xd4)]('‚ùå\x20Missing\x20required\x20webhook\x20parameters'),_0x223dac[_0x2f79dc(0xf0)](0x190)[_0x2f79dc(0xc2)]({'success':![],'message':_0x2f79dc(0xc6)});const _0x294858=await database_1[_0x2f79dc(0xc7)][_0x2f79dc(0xf1)][_0x2f79dc(0xf3)]({'where':{'id':_0x2e786f},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x294858)return console[_0x2f79dc(0xd4)](_0x2f79dc(0xf4)+_0x2e786f),_0x223dac[_0x2f79dc(0xf0)](0x194)['json']({'success':![],'message':_0x2f79dc(0xc4)});console['log'](_0x2f79dc(0xc8)+_0x294858['status']);let _0x88f3f8,_0x3c97b9=![];switch(_0x55745a['toLowerCase']()){case'completed':_0x88f3f8=_0x2f79dc(0xd0),_0x3c97b9=_0x294858[_0x2f79dc(0xf0)]!==_0x2f79dc(0xd0);break;case'failed':_0x88f3f8=_0x2f79dc(0xfe);break;default:console[_0x2f79dc(0xc0)]('‚ö†Ô∏è\x20Unknown\x20status:\x20'+_0x55745a+_0x2f79dc(0xef));return _0x223dac[_0x2f79dc(0xf0)](0xc8)[_0x2f79dc(0xc2)]({'success':!![],'message':_0x2f79dc(0xcb)});}console['log']('üîÑ\x20Updating\x20payment\x20status:\x20'+_0x294858[_0x2f79dc(0xf0)]+'\x20‚Üí\x20'+_0x88f3f8);const _0x1049b3={'status':_0x88f3f8,'updatedAt':new Date()};if(_0x88f3f8==='PAID'){_0x1049b3[_0x2f79dc(0xd3)]=new Date();if(!_0x294858[_0x2f79dc(0xde)]){const _0x1d9446=await currencyService_1['currencyService']['convertToUSDT'](_0x294858['amount'],_0x294858[_0x2f79dc(0xc1)]);_0x1049b3[_0x2f79dc(0xde)]=_0x1d9446;let _0x2465b9=0xa;if(_0x294858[_0x2f79dc(0xf9)][_0x2f79dc(0xe7)])try{const _0x23fa15=JSON['parse'](_0x294858[_0x2f79dc(0xf9)][_0x2f79dc(0xe7)]);for(const [_0x33030b,_0x10f299]of Object[_0x2f79dc(0xdc)](_0x23fa15)){if(_0x33030b[_0x2f79dc(0xcd)]()==='instaxchange'){_0x2465b9=_0x10f299['commission']||0xa;break;}}}catch(_0x11699f){console['error'](_0x2f79dc(0xc9),_0x11699f);}const _0x556d6b=_0x1d9446*(0x1-_0x2465b9/0x64);_0x1049b3[_0x2f79dc(0xe5)]=_0x556d6b,_0x1049b3[_0x2f79dc(0xdd)]=_0x2465b9,console[_0x2f79dc(0xc0)](_0x2f79dc(0xe8)),console[_0x2f79dc(0xc0)](_0x2f79dc(0xca)+_0x1d9446['toFixed'](0x6)),console[_0x2f79dc(0xc0)](_0x2f79dc(0x101)+_0x2465b9+'%'),console[_0x2f79dc(0xc0)]('\x20\x20\x20Merchant\x20Amount:\x20'+_0x556d6b[_0x2f79dc(0xec)](0x6));}}else{if(_0x88f3f8==='FAILED'){const _0xbb709f=_0x3da365?.[_0x2f79dc(0xfd)]?.[_0x2f79dc(0xce)]||_0x2f79dc(0xc3);_0x1049b3['failureMessage']=_0xbb709f,console[_0x2f79dc(0xc0)](_0x2f79dc(0xbf)+_0xbb709f);}}_0x3da365&&(_0x1049b3[_0x2f79dc(0xf7)]=JSON[_0x2f79dc(0xfc)](_0x3da365));await database_1['default'][_0x2f79dc(0xf1)][_0x2f79dc(0xe0)]({'where':{'id':_0x2e786f},'data':_0x1049b3}),console[_0x2f79dc(0xc0)](_0x2f79dc(0xee));if(_0x3c97b9&&_0x88f3f8===_0x2f79dc(0xd0)){const _0xfa2f85=_0x1049b3[_0x2f79dc(0xe5)];_0xfa2f85&&(await database_1[_0x2f79dc(0xc7)]['shop'][_0x2f79dc(0xe0)]({'where':{'id':_0x294858[_0x2f79dc(0xff)]},'data':{'balance':{'increment':_0xfa2f85}}}),console['log'](_0x2f79dc(0xe2)+_0xfa2f85['toFixed'](0x6)+'\x20USDT'));}try{await this[_0x2f79dc(0xe1)][_0x2f79dc(0xda)](_0x2e786f,_0x88f3f8,{'failureMessage':_0x88f3f8===_0x2f79dc(0xfe)?_0x3da365?.[_0x2f79dc(0xfd)]?.[_0x2f79dc(0xce)]||_0x2f79dc(0xc3):undefined}),console[_0x2f79dc(0xc0)]('üì§\x20Webhook\x20notification\x20processed');}catch(_0x28fbd1){console['error']('‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:',_0x28fbd1);}return _0x223dac[_0x2f79dc(0xf0)](0xc8)[_0x2f79dc(0xc2)]({'success':!![],'message':_0x2f79dc(0xeb)});}catch(_0x4cad02){return console[_0x2f79dc(0xd4)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0x4cad02),_0x223dac[_0x2f79dc(0xf0)](0x1f4)[_0x2f79dc(0xc2)]({'success':![],'message':'Internal\x20server\x20error','error':_0x4cad02 instanceof Error?_0x4cad02[_0x2f79dc(0xe4)]:_0x2f79dc(0xf6)});}},this['webhookService']=new webhookService_1[(_0x4a364d(0xd2))]();}}exports[a8_0x240862(0xd1)]=InstaXChangeController;