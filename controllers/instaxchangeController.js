'use strict';const a7_0x57f916=a7_0x3016;function a7_0x16bc(){const _0x231e15=['Status\x20not\x20actionable','error','Payment\x20failed','findUnique','\x20\x20\x20Amount\x20USDT:\x20','shop','toFixed','statusReason','PAID','\x20‚Üí\x20','gatewaySettings','11394PWgfLM','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','parse','InstaXChangeController','currencyService','amountAfterGatewayCommissionUSDT','üìä\x20Current\x20payment\x20status:\x20','‚ùå\x20Payment\x20not\x20found:\x20','‚ùå\x20Missing\x20required\x20webhook\x20parameters','FAILED','1742587fQmwbb','instaxchange','‚úÖ\x20Payment\x20updated\x20successfully','default','Internal\x20server\x20error','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','currency','webhookService','message','Webhook\x20processed\x20successfully','451390DmgKFg','gatewayCommissionRate','toLowerCase','8oiNMDq','Payment\x20not\x20found','convertToUSDT','\x20\x20\x20Merchant\x20Amount:\x20','json','failureMessage','shopId','45QTJUGS','1608859DcJLez','üí∞\x20Shop\x20balance\x20updated:\x20+','üí∞\x20Calculated\x20amounts:','log','Missing\x20required\x20parameters','update','stringify','‚ö†Ô∏è\x20Unknown\x20status:\x20','commission','__importDefault','../config/database','66882plZWsI','9eXaBwO','üì§\x20Webhook\x20notification\x20processed','üê≥\x20InstaXChange\x20webhook\x20received:','1140HtywGK','status','\x20\x20\x20Status:\x20','completed','1364015ZgayaK','Unknown\x20error','data','handleWebhook','body','üîÑ\x20Updating\x20payment\x20status:\x20','amountUSDT','663SkvnjQ','payment','__esModule','gatewayResponse'];a7_0x16bc=function(){return _0x231e15;};return a7_0x16bc();}(function(_0x3db332,_0x4c6fe2){const _0xdd32a0=a7_0x3016,_0x250a11=_0x3db332();while(!![]){try{const _0x12e961=parseInt(_0xdd32a0(0x160))/0x1*(-parseInt(_0xdd32a0(0x17d))/0x2)+parseInt(_0xdd32a0(0x16e))/0x3*(parseInt(_0xdd32a0(0x163))/0x4)+parseInt(_0xdd32a0(0x167))/0x5+parseInt(_0xdd32a0(0x15f))/0x6+-parseInt(_0xdd32a0(0x154))/0x7*(-parseInt(_0xdd32a0(0x14c))/0x8)+parseInt(_0xdd32a0(0x153))/0x9*(-parseInt(_0xdd32a0(0x191))/0xa)+-parseInt(_0xdd32a0(0x187))/0xb;if(_0x12e961===_0x4c6fe2)break;else _0x250a11['push'](_0x250a11['shift']());}catch(_0x32dd73){_0x250a11['push'](_0x250a11['shift']());}}}(a7_0x16bc,0x2284b));function a7_0x3016(_0x4599b8,_0x29ba94){_0x4599b8=_0x4599b8-0x14c;const _0x16bcd9=a7_0x16bc();let _0x3016e6=_0x16bcd9[_0x4599b8];return _0x3016e6;}var __importDefault=this&&this[a7_0x57f916(0x15d)]||function(_0x1cb44d){const _0x3f917b=a7_0x57f916;return _0x1cb44d&&_0x1cb44d[_0x3f917b(0x170)]?_0x1cb44d:{'default':_0x1cb44d};};Object['defineProperty'](exports,a7_0x57f916(0x170),{'value':!![]}),exports[a7_0x57f916(0x180)]=void 0x0;const database_1=__importDefault(require(a7_0x57f916(0x15e))),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0x46cc81=a7_0x57f916;this[_0x46cc81(0x16a)]=async(_0x43a38a,_0xc90a7d)=>{const _0x285610=_0x46cc81;try{const {paymentId:_0x333395,status:_0x3c8bd7,sessionId:_0x1569ce,webhookData:_0xd61511}=_0x43a38a[_0x285610(0x16b)];console[_0x285610(0x157)](_0x285610(0x162)),console[_0x285610(0x157)]('\x20\x20\x20Payment\x20ID:\x20'+_0x333395),console['log'](_0x285610(0x165)+_0x3c8bd7),console['log']('\x20\x20\x20Session\x20ID:\x20'+_0x1569ce);if(!_0x333395||!_0x3c8bd7)return console[_0x285610(0x173)](_0x285610(0x185)),_0xc90a7d[_0x285610(0x164)](0x190)['json']({'success':![],'message':_0x285610(0x158)});const _0x4ac770=await database_1['default']['payment'][_0x285610(0x175)]({'where':{'id':_0x333395},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x4ac770)return console[_0x285610(0x173)](_0x285610(0x184)+_0x333395),_0xc90a7d[_0x285610(0x164)](0x194)['json']({'success':![],'message':_0x285610(0x14d)});console[_0x285610(0x157)](_0x285610(0x183)+_0x4ac770[_0x285610(0x164)]);let _0xa00fcf,_0x26481a=![];switch(_0x3c8bd7[_0x285610(0x193)]()){case _0x285610(0x166):_0xa00fcf=_0x285610(0x17a),_0x26481a=_0x4ac770[_0x285610(0x164)]!=='PAID';break;case'failed':_0xa00fcf=_0x285610(0x186);break;default:console['log'](_0x285610(0x15b)+_0x3c8bd7+',\x20ignoring\x20webhook');return _0xc90a7d['status'](0xc8)[_0x285610(0x150)]({'success':!![],'message':_0x285610(0x172)});}console[_0x285610(0x157)](_0x285610(0x16c)+_0x4ac770[_0x285610(0x164)]+_0x285610(0x17b)+_0xa00fcf);const _0x1b39d2={'status':_0xa00fcf,'updatedAt':new Date()};if(_0xa00fcf===_0x285610(0x17a)){_0x1b39d2['paidAt']=new Date();if(!_0x4ac770[_0x285610(0x16d)]){const _0xdb7d72=await currencyService_1[_0x285610(0x181)][_0x285610(0x14e)](_0x4ac770['amount'],_0x4ac770[_0x285610(0x18d)]);_0x1b39d2[_0x285610(0x16d)]=_0xdb7d72;let _0x1bf9dc=0xa;if(_0x4ac770['shop'][_0x285610(0x17c)])try{const _0x449108=JSON[_0x285610(0x17f)](_0x4ac770['shop'][_0x285610(0x17c)]);for(const [_0x2c30ea,_0x27d166]of Object['entries'](_0x449108)){if(_0x2c30ea[_0x285610(0x193)]()===_0x285610(0x188)){_0x1bf9dc=_0x27d166[_0x285610(0x15c)]||0xa;break;}}}catch(_0x1439f5){console[_0x285610(0x173)]('Error\x20parsing\x20gateway\x20settings:',_0x1439f5);}const _0x185335=_0xdb7d72*(0x1-_0x1bf9dc/0x64);_0x1b39d2[_0x285610(0x182)]=_0x185335,_0x1b39d2[_0x285610(0x192)]=_0x1bf9dc,console['log'](_0x285610(0x156)),console[_0x285610(0x157)](_0x285610(0x176)+_0xdb7d72[_0x285610(0x178)](0x6)),console[_0x285610(0x157)]('\x20\x20\x20Commission:\x20'+_0x1bf9dc+'%'),console[_0x285610(0x157)](_0x285610(0x14f)+_0x185335[_0x285610(0x178)](0x6));}}else{if(_0xa00fcf==='FAILED'){const _0x19387e=_0xd61511?.[_0x285610(0x169)]?.[_0x285610(0x179)]||'Payment\x20failed';_0x1b39d2[_0x285610(0x151)]=_0x19387e,console['log']('‚ùå\x20Failure\x20reason:\x20'+_0x19387e);}}_0xd61511&&(_0x1b39d2[_0x285610(0x171)]=JSON[_0x285610(0x15a)](_0xd61511));await database_1['default'][_0x285610(0x16f)][_0x285610(0x159)]({'where':{'id':_0x333395},'data':_0x1b39d2}),console[_0x285610(0x157)](_0x285610(0x189));if(_0x26481a&&_0xa00fcf===_0x285610(0x17a)){const _0x3548f7=_0x1b39d2[_0x285610(0x182)];_0x3548f7&&(await database_1[_0x285610(0x18a)][_0x285610(0x177)][_0x285610(0x159)]({'where':{'id':_0x4ac770[_0x285610(0x152)]},'data':{'balance':{'increment':_0x3548f7}}}),console[_0x285610(0x157)](_0x285610(0x155)+_0x3548f7[_0x285610(0x178)](0x6)+'\x20USDT'));}try{await this[_0x285610(0x18e)]['updatePaymentStatus'](_0x333395,_0xa00fcf,{'failureMessage':_0xa00fcf==='FAILED'?_0xd61511?.[_0x285610(0x169)]?.['statusReason']||_0x285610(0x174):undefined}),console['log'](_0x285610(0x161));}catch(_0x1349b7){console['error'](_0x285610(0x18c),_0x1349b7);}return _0xc90a7d[_0x285610(0x164)](0xc8)[_0x285610(0x150)]({'success':!![],'message':_0x285610(0x190)});}catch(_0x13d19d){return console[_0x285610(0x173)](_0x285610(0x17e),_0x13d19d),_0xc90a7d[_0x285610(0x164)](0x1f4)[_0x285610(0x150)]({'success':![],'message':_0x285610(0x18b),'error':_0x13d19d instanceof Error?_0x13d19d[_0x285610(0x18f)]:_0x285610(0x168)});}},this[_0x46cc81(0x18e)]=new webhookService_1['WebhookService']();}}exports[a7_0x57f916(0x180)]=InstaXChangeController;