'use strict';const a8_0x5c37ea=a8_0x33b3;(function(_0x5a45ec,_0x678411){const _0x4093b2=a8_0x33b3,_0x3a3f8e=_0x5a45ec();while(!![]){try{const _0x1eded9=parseInt(_0x4093b2(0x22a))/0x1+parseInt(_0x4093b2(0x209))/0x2*(-parseInt(_0x4093b2(0x224))/0x3)+parseInt(_0x4093b2(0x202))/0x4+parseInt(_0x4093b2(0x23c))/0x5+-parseInt(_0x4093b2(0x210))/0x6*(-parseInt(_0x4093b2(0x20e))/0x7)+-parseInt(_0x4093b2(0x200))/0x8+parseInt(_0x4093b2(0x1fb))/0x9;if(_0x1eded9===_0x678411)break;else _0x3a3f8e['push'](_0x3a3f8e['shift']());}catch(_0x52d2d6){_0x3a3f8e['push'](_0x3a3f8e['shift']());}}}(a8_0x3d33,0x668ab));var __importDefault=this&&this['__importDefault']||function(_0x4f4021){const _0xbb8235=a8_0x33b3;return _0x4f4021&&_0x4f4021[_0xbb8235(0x213)]?_0x4f4021:{'default':_0x4f4021};};function a8_0x33b3(_0x4dfc15,_0x493088){_0x4dfc15=_0x4dfc15-0x1f4;const _0x3d335d=a8_0x3d33();let _0x33b32a=_0x3d335d[_0x4dfc15];return _0x33b32a;}Object[a8_0x5c37ea(0x203)](exports,a8_0x5c37ea(0x213),{'value':!![]}),exports[a8_0x5c37ea(0x239)]=void 0x0;const database_1=__importDefault(require(a8_0x5c37ea(0x233))),webhookService_1=require(a8_0x5c37ea(0x21a)),currencyService_1=require(a8_0x5c37ea(0x232));function a8_0x3d33(){const _0x33077b=['toLowerCase','entries','\x20\x20\x20Status:\x20','../services/currencyService','../config/database','‚ö†Ô∏è\x20Unknown\x20status:\x20','üîÑ\x20Updating\x20payment\x20status:\x20','üì§\x20Webhook\x20notification\x20processed','updatePaymentStatus','Payment\x20not\x20found','InstaXChangeController','PAID','\x20\x20\x20Payment\x20ID:\x20','689670bmMgda','default','webhookService','paidAt','gatewayResponse','\x20\x20\x20Session\x20ID:\x20','error','\x20USDT','2681370xRKbSv','log','Webhook\x20processed\x20successfully','instaxchange','FAILED','3808008JPlDom','amountAfterGatewayCommissionUSDT','179336RGJHAa','defineProperty','üí∞\x20Calculated\x20amounts:','completed','failureMessage','\x20‚Üí\x20','üìä\x20Current\x20payment\x20status:\x20','128578HMFhNM','amount','convertToUSDT','amountUSDT','gatewaySettings','7rKcfbR','WebhookService','741534GdTIjd','shopId','Payment\x20failed','__esModule','statusReason','‚ùå\x20Failure\x20reason:\x20','data','‚úÖ\x20Payment\x20updated\x20successfully','\x20\x20\x20Commission:\x20','commission','../services/webhookService','‚ùå\x20Missing\x20required\x20webhook\x20parameters','gatewayCommissionRate','Internal\x20server\x20error','Status\x20not\x20actionable','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','json','parse','shop','\x20\x20\x20Amount\x20USDT:\x20','6YApjdP','stringify','toFixed','update',',\x20ignoring\x20webhook','Missing\x20required\x20parameters','420303eaHxUB','failed','currencyService','Unknown\x20error','status'];a8_0x3d33=function(){return _0x33077b;};return a8_0x3d33();}class InstaXChangeController{constructor(){const _0x863d73=a8_0x5c37ea;this['handleWebhook']=async(_0x1fc90a,_0x37ded7)=>{const _0xeb9626=a8_0x33b3;try{const {paymentId:_0x2375f6,status:_0x282c27,sessionId:_0x2ae10e,webhookData:_0x3632a0}=_0x1fc90a['body'];console[_0xeb9626(0x1fc)]('üê≥\x20InstaXChange\x20webhook\x20received:'),console['log'](_0xeb9626(0x23b)+_0x2375f6),console[_0xeb9626(0x1fc)](_0xeb9626(0x231)+_0x282c27),console['log'](_0xeb9626(0x1f8)+_0x2ae10e);if(!_0x2375f6||!_0x282c27)return console[_0xeb9626(0x1f9)](_0xeb9626(0x21b)),_0x37ded7[_0xeb9626(0x22e)](0x190)[_0xeb9626(0x220)]({'success':![],'message':_0xeb9626(0x229)});const _0x1f4d98=await database_1['default']['payment']['findUnique']({'where':{'id':_0x2375f6},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x1f4d98)return console[_0xeb9626(0x1f9)]('‚ùå\x20Payment\x20not\x20found:\x20'+_0x2375f6),_0x37ded7[_0xeb9626(0x22e)](0x194)['json']({'success':![],'message':_0xeb9626(0x238)});console[_0xeb9626(0x1fc)](_0xeb9626(0x208)+_0x1f4d98['status']);let _0x35ef9,_0x3206a2=![];switch(_0x282c27['toLowerCase']()){case _0xeb9626(0x205):_0x35ef9='PAID',_0x3206a2=_0x1f4d98[_0xeb9626(0x22e)]!==_0xeb9626(0x23a);break;case _0xeb9626(0x22b):_0x35ef9='FAILED';break;default:console[_0xeb9626(0x1fc)](_0xeb9626(0x234)+_0x282c27+_0xeb9626(0x228));return _0x37ded7['status'](0xc8)['json']({'success':!![],'message':_0xeb9626(0x21e)});}console[_0xeb9626(0x1fc)](_0xeb9626(0x235)+_0x1f4d98[_0xeb9626(0x22e)]+_0xeb9626(0x207)+_0x35ef9);const _0x4e7a4d={'status':_0x35ef9,'updatedAt':new Date()};if(_0x35ef9===_0xeb9626(0x23a)){_0x4e7a4d[_0xeb9626(0x1f6)]=new Date();if(!_0x1f4d98[_0xeb9626(0x20c)]){const _0x1683ed=await currencyService_1[_0xeb9626(0x22c)][_0xeb9626(0x20b)](_0x1f4d98[_0xeb9626(0x20a)],_0x1f4d98['currency']);_0x4e7a4d[_0xeb9626(0x20c)]=_0x1683ed;let _0xfc72dd=0xa;if(_0x1f4d98[_0xeb9626(0x222)][_0xeb9626(0x20d)])try{const _0x5cf974=JSON[_0xeb9626(0x221)](_0x1f4d98[_0xeb9626(0x222)][_0xeb9626(0x20d)]);for(const [_0x466f2d,_0x7d7621]of Object[_0xeb9626(0x230)](_0x5cf974)){if(_0x466f2d[_0xeb9626(0x22f)]()===_0xeb9626(0x1fe)){_0xfc72dd=_0x7d7621[_0xeb9626(0x219)]||0xa;break;}}}catch(_0x1aace8){console[_0xeb9626(0x1f9)]('Error\x20parsing\x20gateway\x20settings:',_0x1aace8);}const _0xc16ff6=_0x1683ed*(0x1-_0xfc72dd/0x64);_0x4e7a4d[_0xeb9626(0x201)]=_0xc16ff6,_0x4e7a4d[_0xeb9626(0x21c)]=_0xfc72dd,console['log'](_0xeb9626(0x204)),console['log'](_0xeb9626(0x223)+_0x1683ed[_0xeb9626(0x226)](0x6)),console[_0xeb9626(0x1fc)](_0xeb9626(0x218)+_0xfc72dd+'%'),console['log']('\x20\x20\x20Merchant\x20Amount:\x20'+_0xc16ff6['toFixed'](0x6));}}else{if(_0x35ef9===_0xeb9626(0x1ff)){const _0x42ea47=_0x3632a0?.['data']?.[_0xeb9626(0x214)]||_0xeb9626(0x212);_0x4e7a4d[_0xeb9626(0x206)]=_0x42ea47,console[_0xeb9626(0x1fc)](_0xeb9626(0x215)+_0x42ea47);}}_0x3632a0&&(_0x4e7a4d[_0xeb9626(0x1f7)]=JSON[_0xeb9626(0x225)](_0x3632a0));await database_1['default']['payment'][_0xeb9626(0x227)]({'where':{'id':_0x2375f6},'data':_0x4e7a4d}),console['log'](_0xeb9626(0x217));if(_0x3206a2&&_0x35ef9==='PAID'){const _0x39f2=_0x4e7a4d[_0xeb9626(0x201)];_0x39f2&&(await database_1[_0xeb9626(0x1f4)]['shop'][_0xeb9626(0x227)]({'where':{'id':_0x1f4d98[_0xeb9626(0x211)]},'data':{'balance':{'increment':_0x39f2}}}),console[_0xeb9626(0x1fc)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0x39f2['toFixed'](0x6)+_0xeb9626(0x1fa)));}try{await this[_0xeb9626(0x1f5)][_0xeb9626(0x237)](_0x2375f6,_0x35ef9,{'failureMessage':_0x35ef9===_0xeb9626(0x1ff)?_0x3632a0?.[_0xeb9626(0x216)]?.[_0xeb9626(0x214)]||_0xeb9626(0x212):undefined}),console[_0xeb9626(0x1fc)](_0xeb9626(0x236));}catch(_0x453570){console[_0xeb9626(0x1f9)]('‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:',_0x453570);}return _0x37ded7[_0xeb9626(0x22e)](0xc8)['json']({'success':!![],'message':_0xeb9626(0x1fd)});}catch(_0x2a2c46){return console[_0xeb9626(0x1f9)](_0xeb9626(0x21f),_0x2a2c46),_0x37ded7[_0xeb9626(0x22e)](0x1f4)['json']({'success':![],'message':_0xeb9626(0x21d),'error':_0x2a2c46 instanceof Error?_0x2a2c46['message']:_0xeb9626(0x22d)});}},this[_0x863d73(0x1f5)]=new webhookService_1[(_0x863d73(0x20f))]();}}exports[a8_0x5c37ea(0x239)]=InstaXChangeController;