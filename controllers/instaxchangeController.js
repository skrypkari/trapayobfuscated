'use strict';const a8_0x2c2a6c=a8_0xe27a;(function(_0x337a35,_0x111013){const _0x446300=a8_0xe27a,_0x1f55d9=_0x337a35();while(!![]){try{const _0x4c0de4=parseInt(_0x446300(0x1a5))/0x1+parseInt(_0x446300(0x1a7))/0x2*(parseInt(_0x446300(0x194))/0x3)+-parseInt(_0x446300(0x19b))/0x4*(-parseInt(_0x446300(0x1af))/0x5)+parseInt(_0x446300(0x18c))/0x6*(parseInt(_0x446300(0x172))/0x7)+-parseInt(_0x446300(0x1b8))/0x8*(parseInt(_0x446300(0x1ad))/0x9)+parseInt(_0x446300(0x175))/0xa*(-parseInt(_0x446300(0x1b2))/0xb)+-parseInt(_0x446300(0x193))/0xc*(-parseInt(_0x446300(0x18d))/0xd);if(_0x4c0de4===_0x111013)break;else _0x1f55d9['push'](_0x1f55d9['shift']());}catch(_0x4c3b78){_0x1f55d9['push'](_0x1f55d9['shift']());}}}(a8_0x3bb2,0xa02a9));var __importDefault=this&&this[a8_0x2c2a6c(0x17f)]||function(_0x5e0cad){return _0x5e0cad&&_0x5e0cad['__esModule']?_0x5e0cad:{'default':_0x5e0cad};};Object[a8_0x2c2a6c(0x183)](exports,a8_0x2c2a6c(0x1a6),{'value':!![]}),exports[a8_0x2c2a6c(0x1a9)]=void 0x0;function a8_0x3bb2(){const _0x78e497=['43929VXposO','currency','43895pRrdhJ','amount','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','4444YsJZMW','gatewayResponse',',\x20ignoring\x20webhook','../services/webhookService','Payment\x20failed','Status\x20not\x20actionable','1536lNsAYL','üì§\x20Webhook\x20notification\x20processed','PAID','parse','105uwHKci','shop','\x20\x20\x20Commission:\x20','29190CgzQbW','update','\x20USDT','toLowerCase','body','WebhookService','üìä\x20Current\x20payment\x20status:\x20','instaxchange','‚ö†Ô∏è\x20Unknown\x20status:\x20','‚úÖ\x20Payment\x20updated\x20successfully','__importDefault','Missing\x20required\x20parameters','amountUSDT','Error\x20parsing\x20gateway\x20settings:','defineProperty','statusReason','‚ùå\x20Payment\x20not\x20found:\x20','status','completed','json','log','toFixed','amountAfterGatewayCommissionUSDT','146598OtlsLP','246389GXLAMN','webhookService','convertToUSDT','entries','Payment\x20not\x20found','‚ùå\x20Missing\x20required\x20webhook\x20parameters','396iWIaqq','93tPDTLI','\x20\x20\x20Session\x20ID:\x20','gatewaySettings','updatePaymentStatus','failed','default','üí∞\x20Calculated\x20amounts:','68YmQRFV','error','\x20\x20\x20Merchant\x20Amount:\x20','FAILED','data','\x20\x20\x20Payment\x20ID:\x20','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','stringify','gatewayCommissionRate','\x20\x20\x20Status:\x20','667895irHRpF','__esModule','62154nEYCfS','Internal\x20server\x20error','InstaXChangeController','\x20\x20\x20Amount\x20USDT:\x20','‚ùå\x20Failure\x20reason:\x20','payment'];a8_0x3bb2=function(){return _0x78e497;};return a8_0x3bb2();}const database_1=__importDefault(require('../config/database')),webhookService_1=require(a8_0x2c2a6c(0x1b5)),currencyService_1=require('../services/currencyService');function a8_0xe27a(_0x14e838,_0x1cc266){_0x14e838=_0x14e838-0x16f;const _0x3bb2ff=a8_0x3bb2();let _0xe27ac6=_0x3bb2ff[_0x14e838];return _0xe27ac6;}class InstaXChangeController{constructor(){const _0x2de7ca=a8_0x2c2a6c;this['handleWebhook']=async(_0x37185b,_0x4f3d81)=>{const _0x32be30=a8_0xe27a;try{const {paymentId:_0x4ff0a6,status:_0x300b63,sessionId:_0x4814e6,webhookData:_0x47176c}=_0x37185b[_0x32be30(0x179)];console[_0x32be30(0x189)]('üê≥\x20InstaXChange\x20webhook\x20received:'),console[_0x32be30(0x189)](_0x32be30(0x1a0)+_0x4ff0a6),console['log'](_0x32be30(0x1a4)+_0x300b63),console['log'](_0x32be30(0x195)+_0x4814e6);if(!_0x4ff0a6||!_0x300b63)return console[_0x32be30(0x19c)](_0x32be30(0x192)),_0x4f3d81[_0x32be30(0x186)](0x190)[_0x32be30(0x188)]({'success':![],'message':_0x32be30(0x180)});const _0x20e3ed=await database_1['default']['payment']['findUnique']({'where':{'id':_0x4ff0a6},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x20e3ed)return console[_0x32be30(0x19c)](_0x32be30(0x185)+_0x4ff0a6),_0x4f3d81[_0x32be30(0x186)](0x194)[_0x32be30(0x188)]({'success':![],'message':_0x32be30(0x191)});console[_0x32be30(0x189)](_0x32be30(0x17b)+_0x20e3ed[_0x32be30(0x186)]);let _0x3d41ee,_0x569a55=![];switch(_0x300b63[_0x32be30(0x178)]()){case _0x32be30(0x187):_0x3d41ee=_0x32be30(0x170),_0x569a55=_0x20e3ed[_0x32be30(0x186)]!=='PAID';break;case _0x32be30(0x198):_0x3d41ee='FAILED';break;default:console[_0x32be30(0x189)](_0x32be30(0x17d)+_0x300b63+_0x32be30(0x1b4));return _0x4f3d81[_0x32be30(0x186)](0xc8)[_0x32be30(0x188)]({'success':!![],'message':_0x32be30(0x1b7)});}console[_0x32be30(0x189)]('üîÑ\x20Updating\x20payment\x20status:\x20'+_0x20e3ed[_0x32be30(0x186)]+'\x20‚Üí\x20'+_0x3d41ee);const _0x154d75={'status':_0x3d41ee,'updatedAt':new Date()};if(_0x3d41ee===_0x32be30(0x170)){_0x154d75['paidAt']=new Date();if(!_0x20e3ed['amountUSDT']){const _0x5be7a7=await currencyService_1['currencyService'][_0x32be30(0x18f)](_0x20e3ed[_0x32be30(0x1b0)],_0x20e3ed[_0x32be30(0x1ae)]);_0x154d75[_0x32be30(0x181)]=_0x5be7a7;let _0x431868=0xa;if(_0x20e3ed['shop'][_0x32be30(0x196)])try{const _0x68213a=JSON[_0x32be30(0x171)](_0x20e3ed[_0x32be30(0x173)][_0x32be30(0x196)]);for(const [_0x4e1cd0,_0x35b0a9]of Object[_0x32be30(0x190)](_0x68213a)){if(_0x4e1cd0['toLowerCase']()===_0x32be30(0x17c)){_0x431868=_0x35b0a9['commission']||0xa;break;}}}catch(_0xb00e37){console['error'](_0x32be30(0x182),_0xb00e37);}const _0x5a8d3e=_0x5be7a7*(0x1-_0x431868/0x64);_0x154d75[_0x32be30(0x18b)]=_0x5a8d3e,_0x154d75[_0x32be30(0x1a3)]=_0x431868,console[_0x32be30(0x189)](_0x32be30(0x19a)),console[_0x32be30(0x189)](_0x32be30(0x1aa)+_0x5be7a7[_0x32be30(0x18a)](0x6)),console[_0x32be30(0x189)](_0x32be30(0x174)+_0x431868+'%'),console[_0x32be30(0x189)](_0x32be30(0x19d)+_0x5a8d3e[_0x32be30(0x18a)](0x6));}}else{if(_0x3d41ee===_0x32be30(0x19e)){const _0x4a146e=_0x47176c?.['data']?.[_0x32be30(0x184)]||_0x32be30(0x1b6);_0x154d75['failureMessage']=_0x4a146e,console['log'](_0x32be30(0x1ab)+_0x4a146e);}}_0x47176c&&(_0x154d75[_0x32be30(0x1b3)]=JSON[_0x32be30(0x1a2)](_0x47176c));await database_1['default'][_0x32be30(0x1ac)][_0x32be30(0x176)]({'where':{'id':_0x4ff0a6},'data':_0x154d75}),console[_0x32be30(0x189)](_0x32be30(0x17e));if(_0x569a55&&_0x3d41ee==='PAID'){const _0x47d5c3=_0x154d75['amountAfterGatewayCommissionUSDT'];_0x47d5c3&&(await database_1[_0x32be30(0x199)][_0x32be30(0x173)]['update']({'where':{'id':_0x20e3ed['shopId']},'data':{'balance':{'increment':_0x47d5c3}}}),console[_0x32be30(0x189)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0x47d5c3[_0x32be30(0x18a)](0x6)+_0x32be30(0x177)));}try{await this['webhookService'][_0x32be30(0x197)](_0x4ff0a6,_0x3d41ee,{'failureMessage':_0x3d41ee===_0x32be30(0x19e)?_0x47176c?.[_0x32be30(0x19f)]?.['statusReason']||_0x32be30(0x1b6):undefined}),console[_0x32be30(0x189)](_0x32be30(0x16f));}catch(_0x4e1dc8){console[_0x32be30(0x19c)](_0x32be30(0x1a1),_0x4e1dc8);}return _0x4f3d81[_0x32be30(0x186)](0xc8)[_0x32be30(0x188)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x269f5f){return console[_0x32be30(0x19c)](_0x32be30(0x1b1),_0x269f5f),_0x4f3d81[_0x32be30(0x186)](0x1f4)[_0x32be30(0x188)]({'success':![],'message':_0x32be30(0x1a8),'error':_0x269f5f instanceof Error?_0x269f5f['message']:'Unknown\x20error'});}},this[_0x2de7ca(0x18e)]=new webhookService_1[(_0x2de7ca(0x17a))]();}}exports[a8_0x2c2a6c(0x1a9)]=InstaXChangeController;