'use strict';function a8_0x2ffc(_0x3d64e8,_0x503c86){_0x3d64e8=_0x3d64e8-0xec;const _0x41cdda=a8_0x41cd();let _0x2ffcee=_0x41cdda[_0x3d64e8];return _0x2ffcee;}const a8_0x3d93be=a8_0x2ffc;(function(_0x54f3f6,_0x16a787){const _0x45aaa7=a8_0x2ffc,_0x32ce9b=_0x54f3f6();while(!![]){try{const _0x45ea06=-parseInt(_0x45aaa7(0x110))/0x1*(parseInt(_0x45aaa7(0x119))/0x2)+-parseInt(_0x45aaa7(0x11f))/0x3+-parseInt(_0x45aaa7(0x116))/0x4+-parseInt(_0x45aaa7(0x105))/0x5+-parseInt(_0x45aaa7(0x106))/0x6*(-parseInt(_0x45aaa7(0xf3))/0x7)+parseInt(_0x45aaa7(0x10c))/0x8+parseInt(_0x45aaa7(0x10d))/0x9;if(_0x45ea06===_0x16a787)break;else _0x32ce9b['push'](_0x32ce9b['shift']());}catch(_0x56f653){_0x32ce9b['push'](_0x32ce9b['shift']());}}}(a8_0x41cd,0x34ca0));var __importDefault=this&&this['__importDefault']||function(_0x19821c){const _0x224962=a8_0x2ffc;return _0x19821c&&_0x19821c[_0x224962(0x10e)]?_0x19821c:{'default':_0x19821c};};Object['defineProperty'](exports,a8_0x3d93be(0x10e),{'value':!![]}),exports[a8_0x3d93be(0x103)]=void 0x0;const database_1=__importDefault(require('../config/database')),webhookService_1=require(a8_0x3d93be(0x124)),currencyService_1=require(a8_0x3d93be(0xee));class InstaXChangeController{constructor(){const _0x3e22c5=a8_0x3d93be;this['handleWebhook']=async(_0x5489ad,_0x5c1042)=>{const _0x455bb2=a8_0x2ffc;try{const {paymentId:_0x152b05,status:_0x2f91ce,sessionId:_0x3d208a,webhookData:_0x3f36c0}=_0x5489ad[_0x455bb2(0x121)];console[_0x455bb2(0xff)]('üê≥\x20InstaXChange\x20webhook\x20received:'),console[_0x455bb2(0xff)](_0x455bb2(0x113)+_0x152b05),console[_0x455bb2(0xff)](_0x455bb2(0xfb)+_0x2f91ce),console[_0x455bb2(0xff)](_0x455bb2(0x115)+_0x3d208a);if(!_0x152b05||!_0x2f91ce)return console[_0x455bb2(0x108)](_0x455bb2(0x12e)),_0x5c1042[_0x455bb2(0x101)](0x190)[_0x455bb2(0xf4)]({'success':![],'message':'Missing\x20required\x20parameters'});const _0x543594=await database_1[_0x455bb2(0x11c)][_0x455bb2(0xf7)][_0x455bb2(0x11e)]({'where':{'id':_0x152b05},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x543594)return console[_0x455bb2(0x108)](_0x455bb2(0xf6)+_0x152b05),_0x5c1042[_0x455bb2(0x101)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console['log'](_0x455bb2(0xfe)+_0x543594['status']);let _0x51da7f,_0x399ddf=![];switch(_0x2f91ce[_0x455bb2(0x117)]()){case _0x455bb2(0x125):_0x51da7f='PAID',_0x399ddf=_0x543594[_0x455bb2(0x101)]!==_0x455bb2(0x100);break;case _0x455bb2(0x11a):_0x51da7f=_0x455bb2(0x11b);break;default:console['log'](_0x455bb2(0xf2)+_0x2f91ce+_0x455bb2(0x129));return _0x5c1042[_0x455bb2(0x101)](0xc8)['json']({'success':!![],'message':_0x455bb2(0xf0)});}console[_0x455bb2(0xff)](_0x455bb2(0xf8)+_0x543594[_0x455bb2(0x101)]+_0x455bb2(0x114)+_0x51da7f);const _0x73a883={'status':_0x51da7f,'updatedAt':new Date()};if(_0x51da7f===_0x455bb2(0x100)){_0x73a883[_0x455bb2(0x112)]=new Date();if(!_0x543594[_0x455bb2(0x126)]){const _0x1cee7e=await currencyService_1[_0x455bb2(0xfc)]['convertToUSDT'](_0x543594['amount'],_0x543594['currency']);_0x73a883[_0x455bb2(0x126)]=_0x1cee7e;let _0x4d0724=0xa;if(_0x543594[_0x455bb2(0x107)]['gatewaySettings'])try{const _0x3d91e1=JSON['parse'](_0x543594[_0x455bb2(0x107)][_0x455bb2(0xf5)]);for(const [_0x4b5770,_0x932eef]of Object['entries'](_0x3d91e1)){if(_0x4b5770['toLowerCase']()===_0x455bb2(0x109)){_0x4d0724=_0x932eef[_0x455bb2(0x10f)]||0xa;break;}}}catch(_0x544d27){console[_0x455bb2(0x108)]('Error\x20parsing\x20gateway\x20settings:',_0x544d27);}const _0x1cea84=_0x1cee7e*(0x1-_0x4d0724/0x64);_0x73a883['amountAfterGatewayCommissionUSDT']=_0x1cea84,_0x73a883['gatewayCommissionRate']=_0x4d0724,console[_0x455bb2(0xff)]('üí∞\x20Calculated\x20amounts:'),console[_0x455bb2(0xff)](_0x455bb2(0xec)+_0x1cee7e[_0x455bb2(0x127)](0x6)),console[_0x455bb2(0xff)](_0x455bb2(0x12b)+_0x4d0724+'%'),console[_0x455bb2(0xff)](_0x455bb2(0x122)+_0x1cea84['toFixed'](0x6));}}else{if(_0x51da7f===_0x455bb2(0x11b)){const _0x2387d4=_0x3f36c0?.[_0x455bb2(0x12a)]?.[_0x455bb2(0x10a)]||_0x455bb2(0xf1);_0x73a883['failureMessage']=_0x2387d4,console[_0x455bb2(0xff)](_0x455bb2(0x118)+_0x2387d4);}}_0x3f36c0&&(_0x73a883['gatewayResponse']=JSON[_0x455bb2(0xef)](_0x3f36c0));await database_1['default'][_0x455bb2(0xf7)][_0x455bb2(0x104)]({'where':{'id':_0x152b05},'data':_0x73a883}),console[_0x455bb2(0xff)](_0x455bb2(0x102));if(_0x399ddf&&_0x51da7f==='PAID'){const _0x2301cc=_0x73a883[_0x455bb2(0x120)];_0x2301cc&&(await database_1[_0x455bb2(0x11c)]['shop'][_0x455bb2(0x104)]({'where':{'id':_0x543594[_0x455bb2(0x12d)]},'data':{'balance':{'increment':_0x2301cc}}}),console[_0x455bb2(0xff)](_0x455bb2(0x123)+_0x2301cc[_0x455bb2(0x127)](0x6)+'\x20USDT'));}try{await this['webhookService'][_0x455bb2(0xfd)](_0x152b05,_0x51da7f,{'failureMessage':_0x51da7f===_0x455bb2(0x11b)?_0x3f36c0?.[_0x455bb2(0x12a)]?.['statusReason']||'Payment\x20failed':undefined}),console['log'](_0x455bb2(0xf9));}catch(_0x28ca1b){console[_0x455bb2(0x108)](_0x455bb2(0x111),_0x28ca1b);}return _0x5c1042[_0x455bb2(0x101)](0xc8)[_0x455bb2(0xf4)]({'success':!![],'message':_0x455bb2(0x11d)});}catch(_0x57477e){return console[_0x455bb2(0x108)](_0x455bb2(0x10b),_0x57477e),_0x5c1042[_0x455bb2(0x101)](0x1f4)['json']({'success':![],'message':_0x455bb2(0x12c),'error':_0x57477e instanceof Error?_0x57477e['message']:_0x455bb2(0x128)});}},this[_0x3e22c5(0xed)]=new webhookService_1[(_0x3e22c5(0xfa))]();}}exports['InstaXChangeController']=InstaXChangeController;function a8_0x41cd(){const _0x1a86e3=['2768238lYALzK','__esModule','commission','409401fqWZPl','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','paidAt','\x20\x20\x20Payment\x20ID:\x20','\x20‚Üí\x20','\x20\x20\x20Session\x20ID:\x20','853252GxYqdo','toLowerCase','‚ùå\x20Failure\x20reason:\x20','2dRCUJA','failed','FAILED','default','Webhook\x20processed\x20successfully','findUnique','222675GVJzEX','amountAfterGatewayCommissionUSDT','body','\x20\x20\x20Merchant\x20Amount:\x20','üí∞\x20Shop\x20balance\x20updated:\x20+','../services/webhookService','completed','amountUSDT','toFixed','Unknown\x20error',',\x20ignoring\x20webhook','data','\x20\x20\x20Commission:\x20','Internal\x20server\x20error','shopId','‚ùå\x20Missing\x20required\x20webhook\x20parameters','\x20\x20\x20Amount\x20USDT:\x20','webhookService','../services/currencyService','stringify','Status\x20not\x20actionable','Payment\x20failed','‚ö†Ô∏è\x20Unknown\x20status:\x20','5761ZpMyxI','json','gatewaySettings','‚ùå\x20Payment\x20not\x20found:\x20','payment','üîÑ\x20Updating\x20payment\x20status:\x20','üì§\x20Webhook\x20notification\x20processed','WebhookService','\x20\x20\x20Status:\x20','currencyService','updatePaymentStatus','üìä\x20Current\x20payment\x20status:\x20','log','PAID','status','‚úÖ\x20Payment\x20updated\x20successfully','InstaXChangeController','update','127375fayyMh','2742MhPqxP','shop','error','instaxchange','statusReason','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','2039560SRZoAR'];a8_0x41cd=function(){return _0x1a86e3;};return a8_0x41cd();}