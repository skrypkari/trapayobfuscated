'use strict';function a8_0x3763(){const _0x50603d=['513PjKSMb','7290602ZAhhLh','amountUSDT','4812jXdzoZ','1985LXnuah','üê≥\x20InstaXChange\x20webhook\x20received:','instaxchange','\x20\x20\x20Payment\x20ID:\x20','95390cfbUEC','json','‚úÖ\x20Payment\x20updated\x20successfully','toFixed','\x20\x20\x20Amount\x20USDT:\x20','Unknown\x20error','shopId','__esModule','__importDefault','amount','7Nwdtcd','../config/database','gatewaySettings','log','payment','defineProperty','entries','üì§\x20Webhook\x20notification\x20processed','gatewayCommissionRate','‚ùå\x20Failure\x20reason:\x20','7916hFpNaA','amountAfterGatewayCommissionUSDT','currencyService','üí∞\x20Shop\x20balance\x20updated:\x20+','webhookService','1011AACfkZ','body','default','toLowerCase','findUnique','Status\x20not\x20actionable','üìä\x20Current\x20payment\x20status:\x20','4717896pDOYik','üí∞\x20Calculated\x20amounts:','‚ùå\x20Missing\x20required\x20webhook\x20parameters','gatewayResponse','Missing\x20required\x20parameters','paidAt','InstaXChangeController','convertToUSDT','üîÑ\x20Updating\x20payment\x20status:\x20','Error\x20parsing\x20gateway\x20settings:','FAILED','‚ö†Ô∏è\x20Unknown\x20status:\x20','529327NZHqWV',',\x20ignoring\x20webhook','error','update','currency','handleWebhook','data','shop','status','‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:','2342802DoUkwa','\x20\x20\x20Merchant\x20Amount:\x20','statusReason','commission','parse','PAID','‚ùå\x20Payment\x20not\x20found:\x20'];a8_0x3763=function(){return _0x50603d;};return a8_0x3763();}const a8_0x5f4350=a8_0x220c;(function(_0x1d2f2f,_0x4c6e51){const _0x4d338e=a8_0x220c,_0x18334c=_0x1d2f2f();while(!![]){try{const _0x2262a9=parseInt(_0x4d338e(0x8e))/0x1+parseInt(_0x4d338e(0x76))/0x2*(-parseInt(_0x4d338e(0x7b))/0x3)+-parseInt(_0x4d338e(0xa2))/0x4*(-parseInt(_0x4d338e(0xa3))/0x5)+parseInt(_0x4d338e(0x98))/0x6*(parseInt(_0x4d338e(0x6c))/0x7)+-parseInt(_0x4d338e(0x82))/0x8+-parseInt(_0x4d338e(0x9f))/0x9*(-parseInt(_0x4d338e(0xa7))/0xa)+parseInt(_0x4d338e(0xa0))/0xb;if(_0x2262a9===_0x4c6e51)break;else _0x18334c['push'](_0x18334c['shift']());}catch(_0x44755f){_0x18334c['push'](_0x18334c['shift']());}}}(a8_0x3763,0xa6173));var __importDefault=this&&this[a8_0x5f4350(0x6a)]||function(_0x1ef7b4){const _0x1ac525=a8_0x5f4350;return _0x1ef7b4&&_0x1ef7b4[_0x1ac525(0xae)]?_0x1ef7b4:{'default':_0x1ef7b4};};Object[a8_0x5f4350(0x71)](exports,a8_0x5f4350(0xae),{'value':!![]}),exports[a8_0x5f4350(0x88)]=void 0x0;function a8_0x220c(_0x23b153,_0x337ada){_0x23b153=_0x23b153-0x6a;const _0x376396=a8_0x3763();let _0x220cb0=_0x376396[_0x23b153];return _0x220cb0;}const database_1=__importDefault(require(a8_0x5f4350(0x6d))),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0xe3dd61=a8_0x5f4350;this[_0xe3dd61(0x93)]=async(_0x556738,_0x27bfea)=>{const _0x1c8a41=_0xe3dd61;try{const {paymentId:_0x3e240e,status:_0x1f4ed4,sessionId:_0x48eb74,webhookData:_0x5e62cc}=_0x556738[_0x1c8a41(0x7c)];console[_0x1c8a41(0x6f)](_0x1c8a41(0xa4)),console[_0x1c8a41(0x6f)](_0x1c8a41(0xa6)+_0x3e240e),console['log']('\x20\x20\x20Status:\x20'+_0x1f4ed4),console['log']('\x20\x20\x20Session\x20ID:\x20'+_0x48eb74);if(!_0x3e240e||!_0x1f4ed4)return console['error'](_0x1c8a41(0x84)),_0x27bfea['status'](0x190)['json']({'success':![],'message':_0x1c8a41(0x86)});const _0x208e48=await database_1[_0x1c8a41(0x7d)][_0x1c8a41(0x70)][_0x1c8a41(0x7f)]({'where':{'id':_0x3e240e},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x208e48)return console['error'](_0x1c8a41(0x9e)+_0x3e240e),_0x27bfea[_0x1c8a41(0x96)](0x194)['json']({'success':![],'message':'Payment\x20not\x20found'});console[_0x1c8a41(0x6f)](_0x1c8a41(0x81)+_0x208e48[_0x1c8a41(0x96)]);let _0xab0a8f,_0x3cbae6=![];switch(_0x1f4ed4[_0x1c8a41(0x7e)]()){case'completed':_0xab0a8f='PAID',_0x3cbae6=_0x208e48['status']!==_0x1c8a41(0x9d);break;case'failed':_0xab0a8f='FAILED';break;default:console[_0x1c8a41(0x6f)](_0x1c8a41(0x8d)+_0x1f4ed4+_0x1c8a41(0x8f));return _0x27bfea[_0x1c8a41(0x96)](0xc8)[_0x1c8a41(0xa8)]({'success':!![],'message':_0x1c8a41(0x80)});}console[_0x1c8a41(0x6f)](_0x1c8a41(0x8a)+_0x208e48[_0x1c8a41(0x96)]+'\x20‚Üí\x20'+_0xab0a8f);const _0x4a2d56={'status':_0xab0a8f,'updatedAt':new Date()};if(_0xab0a8f===_0x1c8a41(0x9d)){_0x4a2d56[_0x1c8a41(0x87)]=new Date();if(!_0x208e48[_0x1c8a41(0xa1)]){const _0x1d96bf=await currencyService_1[_0x1c8a41(0x78)][_0x1c8a41(0x89)](_0x208e48[_0x1c8a41(0x6b)],_0x208e48[_0x1c8a41(0x92)]);_0x4a2d56[_0x1c8a41(0xa1)]=_0x1d96bf;let _0x6430f=0xa;if(_0x208e48[_0x1c8a41(0x95)][_0x1c8a41(0x6e)])try{const _0x1c9cda=JSON[_0x1c8a41(0x9c)](_0x208e48[_0x1c8a41(0x95)]['gatewaySettings']);for(const [_0x2a1c9a,_0x17a533]of Object[_0x1c8a41(0x72)](_0x1c9cda)){if(_0x2a1c9a[_0x1c8a41(0x7e)]()===_0x1c8a41(0xa5)){_0x6430f=_0x17a533[_0x1c8a41(0x9b)]||0xa;break;}}}catch(_0x5dc4db){console['error'](_0x1c8a41(0x8b),_0x5dc4db);}const _0x55b71b=_0x1d96bf*(0x1-_0x6430f/0x64);_0x4a2d56[_0x1c8a41(0x77)]=_0x55b71b,_0x4a2d56[_0x1c8a41(0x74)]=_0x6430f,console[_0x1c8a41(0x6f)](_0x1c8a41(0x83)),console[_0x1c8a41(0x6f)](_0x1c8a41(0xab)+_0x1d96bf[_0x1c8a41(0xaa)](0x6)),console[_0x1c8a41(0x6f)]('\x20\x20\x20Commission:\x20'+_0x6430f+'%'),console['log'](_0x1c8a41(0x99)+_0x55b71b[_0x1c8a41(0xaa)](0x6));}}else{if(_0xab0a8f===_0x1c8a41(0x8c)){const _0x2b171c=_0x5e62cc?.[_0x1c8a41(0x94)]?.[_0x1c8a41(0x9a)]||'Payment\x20failed';_0x4a2d56['failureMessage']=_0x2b171c,console[_0x1c8a41(0x6f)](_0x1c8a41(0x75)+_0x2b171c);}}_0x5e62cc&&(_0x4a2d56[_0x1c8a41(0x85)]=JSON['stringify'](_0x5e62cc));await database_1[_0x1c8a41(0x7d)]['payment'][_0x1c8a41(0x91)]({'where':{'id':_0x3e240e},'data':_0x4a2d56}),console[_0x1c8a41(0x6f)](_0x1c8a41(0xa9));if(_0x3cbae6&&_0xab0a8f==='PAID'){const _0x52b6b8=_0x4a2d56[_0x1c8a41(0x77)];_0x52b6b8&&(await database_1[_0x1c8a41(0x7d)][_0x1c8a41(0x95)]['update']({'where':{'id':_0x208e48[_0x1c8a41(0xad)]},'data':{'balance':{'increment':_0x52b6b8}}}),console[_0x1c8a41(0x6f)](_0x1c8a41(0x79)+_0x52b6b8[_0x1c8a41(0xaa)](0x6)+'\x20USDT'));}try{await this[_0x1c8a41(0x7a)]['updatePaymentStatus'](_0x3e240e,_0xab0a8f,{'failureMessage':_0xab0a8f===_0x1c8a41(0x8c)?_0x5e62cc?.[_0x1c8a41(0x94)]?.[_0x1c8a41(0x9a)]||'Payment\x20failed':undefined}),console['log'](_0x1c8a41(0x73));}catch(_0xb1357c){console[_0x1c8a41(0x90)]('‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:',_0xb1357c);}return _0x27bfea['status'](0xc8)[_0x1c8a41(0xa8)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x3b8329){return console[_0x1c8a41(0x90)](_0x1c8a41(0x97),_0x3b8329),_0x27bfea['status'](0x1f4)[_0x1c8a41(0xa8)]({'success':![],'message':'Internal\x20server\x20error','error':_0x3b8329 instanceof Error?_0x3b8329['message']:_0x1c8a41(0xac)});}},this[_0xe3dd61(0x7a)]=new webhookService_1['WebhookService']();}}exports['InstaXChangeController']=InstaXChangeController;