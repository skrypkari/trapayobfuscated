'use strict';const a8_0xeac693=a8_0xe324;(function(_0x3fb294,_0x3b1007){const _0x3ee676=a8_0xe324,_0x35ef3f=_0x3fb294();while(!![]){try{const _0x3b4269=-parseInt(_0x3ee676(0x194))/0x1+parseInt(_0x3ee676(0x181))/0x2*(parseInt(_0x3ee676(0x173))/0x3)+parseInt(_0x3ee676(0x1a9))/0x4+-parseInt(_0x3ee676(0x165))/0x5+-parseInt(_0x3ee676(0x191))/0x6*(parseInt(_0x3ee676(0x180))/0x7)+-parseInt(_0x3ee676(0x16d))/0x8+parseInt(_0x3ee676(0x18c))/0x9*(parseInt(_0x3ee676(0x198))/0xa);if(_0x3b4269===_0x3b1007)break;else _0x35ef3f['push'](_0x35ef3f['shift']());}catch(_0x4ba790){_0x35ef3f['push'](_0x35ef3f['shift']());}}}(a8_0x1d68,0x97bed));function a8_0x1d68(){const _0x4b0c41=['‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','data','statusReason','gatewaySettings','5810147QMSMIg','373594aQtsfY','body','üîÑ\x20Updating\x20payment\x20status:\x20','Internal\x20server\x20error','__importDefault','convertToUSDT','log','handleWebhook','‚úÖ\x20Payment\x20updated\x20successfully','üê≥\x20InstaXChange\x20webhook\x20received:','error','9ypjrWQ',',\x20ignoring\x20webhook','amountUSDT','\x20USDT','currency','6jwHQJB','message','Unknown\x20error','1138504lHXRoI','updatePaymentStatus','amountAfterGatewayCommissionUSDT','Payment\x20failed','38885390CONegZ','__esModule','shop','\x20\x20\x20Amount\x20USDT:\x20','default','json','\x20\x20\x20Payment\x20ID:\x20','shopId','‚ö†Ô∏è\x20Unknown\x20status:\x20','gatewayResponse','Status\x20not\x20actionable','instaxchange','gatewayCommissionRate','parse','Webhook\x20processed\x20successfully','webhookService','update','2802056UvGGyl','failed','amount','findUnique','5814755BzQAJq','\x20‚Üí\x20','payment','toLowerCase','PAID','status','\x20\x20\x20Status:\x20','FAILED','8182600LpYMfm','\x20\x20\x20Commission:\x20','Payment\x20not\x20found','‚ùå\x20Failure\x20reason:\x20','../services/webhookService','üì§\x20Webhook\x20notification\x20processed','3ybvOMu','üìä\x20Current\x20payment\x20status:\x20','WebhookService','entries','paidAt','commission','currencyService','toFixed','../config/database'];a8_0x1d68=function(){return _0x4b0c41;};return a8_0x1d68();}var __importDefault=this&&this[a8_0xeac693(0x185)]||function(_0x4cad0d){const _0x46344d=a8_0xeac693;return _0x4cad0d&&_0x4cad0d[_0x46344d(0x199)]?_0x4cad0d:{'default':_0x4cad0d};};function a8_0xe324(_0x23e05d,_0x321dc7){_0x23e05d=_0x23e05d-0x165;const _0x1d6896=a8_0x1d68();let _0xe324c3=_0x1d6896[_0x23e05d];return _0xe324c3;}Object['defineProperty'](exports,a8_0xeac693(0x199),{'value':!![]}),exports['InstaXChangeController']=void 0x0;const database_1=__importDefault(require(a8_0xeac693(0x17b))),webhookService_1=require(a8_0xeac693(0x171)),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0xe5400d=a8_0xeac693;this[_0xe5400d(0x188)]=async(_0xfdf2d3,_0x17264a)=>{const _0x164d11=_0xe5400d;try{const {paymentId:_0x47ae31,status:_0x2ec9b6,sessionId:_0xf9c89c,webhookData:_0xe1e64e}=_0xfdf2d3[_0x164d11(0x182)];console['log'](_0x164d11(0x18a)),console[_0x164d11(0x187)](_0x164d11(0x19e)+_0x47ae31),console[_0x164d11(0x187)](_0x164d11(0x16b)+_0x2ec9b6),console['log']('\x20\x20\x20Session\x20ID:\x20'+_0xf9c89c);if(!_0x47ae31||!_0x2ec9b6)return console[_0x164d11(0x18b)]('‚ùå\x20Missing\x20required\x20webhook\x20parameters'),_0x17264a[_0x164d11(0x16a)](0x190)[_0x164d11(0x19d)]({'success':![],'message':'Missing\x20required\x20parameters'});const _0x424071=await database_1[_0x164d11(0x19c)][_0x164d11(0x167)][_0x164d11(0x1ac)]({'where':{'id':_0x47ae31},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x424071)return console[_0x164d11(0x18b)]('‚ùå\x20Payment\x20not\x20found:\x20'+_0x47ae31),_0x17264a['status'](0x194)[_0x164d11(0x19d)]({'success':![],'message':_0x164d11(0x16f)});console[_0x164d11(0x187)](_0x164d11(0x174)+_0x424071['status']);let _0x4b62b4,_0x3b2cbd=![];switch(_0x2ec9b6[_0x164d11(0x168)]()){case'completed':_0x4b62b4='PAID',_0x3b2cbd=_0x424071['status']!==_0x164d11(0x169);break;case _0x164d11(0x1aa):_0x4b62b4=_0x164d11(0x16c);break;default:console[_0x164d11(0x187)](_0x164d11(0x1a0)+_0x2ec9b6+_0x164d11(0x18d));return _0x17264a['status'](0xc8)[_0x164d11(0x19d)]({'success':!![],'message':_0x164d11(0x1a2)});}console['log'](_0x164d11(0x183)+_0x424071[_0x164d11(0x16a)]+_0x164d11(0x166)+_0x4b62b4);const _0x1057c1={'status':_0x4b62b4,'updatedAt':new Date()};if(_0x4b62b4===_0x164d11(0x169)){_0x1057c1[_0x164d11(0x177)]=new Date();if(!_0x424071[_0x164d11(0x18e)]){const _0x40372c=await currencyService_1[_0x164d11(0x179)][_0x164d11(0x186)](_0x424071[_0x164d11(0x1ab)],_0x424071[_0x164d11(0x190)]);_0x1057c1[_0x164d11(0x18e)]=_0x40372c;let _0x2ee9d8=0xa;if(_0x424071[_0x164d11(0x19a)][_0x164d11(0x17f)])try{const _0x3f5d86=JSON[_0x164d11(0x1a5)](_0x424071[_0x164d11(0x19a)]['gatewaySettings']);for(const [_0x1a0526,_0x32d189]of Object[_0x164d11(0x176)](_0x3f5d86)){if(_0x1a0526[_0x164d11(0x168)]()===_0x164d11(0x1a3)){_0x2ee9d8=_0x32d189[_0x164d11(0x178)]||0xa;break;}}}catch(_0x1cbd28){console[_0x164d11(0x18b)]('Error\x20parsing\x20gateway\x20settings:',_0x1cbd28);}const _0x121d9c=_0x40372c*(0x1-_0x2ee9d8/0x64);_0x1057c1[_0x164d11(0x196)]=_0x121d9c,_0x1057c1[_0x164d11(0x1a4)]=_0x2ee9d8,console[_0x164d11(0x187)]('üí∞\x20Calculated\x20amounts:'),console['log'](_0x164d11(0x19b)+_0x40372c[_0x164d11(0x17a)](0x6)),console[_0x164d11(0x187)](_0x164d11(0x16e)+_0x2ee9d8+'%'),console[_0x164d11(0x187)]('\x20\x20\x20Merchant\x20Amount:\x20'+_0x121d9c[_0x164d11(0x17a)](0x6));}}else{if(_0x4b62b4===_0x164d11(0x16c)){const _0x52f329=_0xe1e64e?.['data']?.[_0x164d11(0x17e)]||_0x164d11(0x197);_0x1057c1['failureMessage']=_0x52f329,console[_0x164d11(0x187)](_0x164d11(0x170)+_0x52f329);}}_0xe1e64e&&(_0x1057c1[_0x164d11(0x1a1)]=JSON['stringify'](_0xe1e64e));await database_1['default'][_0x164d11(0x167)]['update']({'where':{'id':_0x47ae31},'data':_0x1057c1}),console[_0x164d11(0x187)](_0x164d11(0x189));if(_0x3b2cbd&&_0x4b62b4===_0x164d11(0x169)){const _0xa8526a=_0x1057c1['amountAfterGatewayCommissionUSDT'];_0xa8526a&&(await database_1['default']['shop'][_0x164d11(0x1a8)]({'where':{'id':_0x424071[_0x164d11(0x19f)]},'data':{'balance':{'increment':_0xa8526a}}}),console[_0x164d11(0x187)]('üí∞\x20Shop\x20balance\x20updated:\x20+'+_0xa8526a[_0x164d11(0x17a)](0x6)+_0x164d11(0x18f)));}try{await this[_0x164d11(0x1a7)][_0x164d11(0x195)](_0x47ae31,_0x4b62b4,{'failureMessage':_0x4b62b4===_0x164d11(0x16c)?_0xe1e64e?.[_0x164d11(0x17d)]?.[_0x164d11(0x17e)]||_0x164d11(0x197):undefined}),console[_0x164d11(0x187)](_0x164d11(0x172));}catch(_0x366c74){console[_0x164d11(0x18b)](_0x164d11(0x17c),_0x366c74);}return _0x17264a[_0x164d11(0x16a)](0xc8)[_0x164d11(0x19d)]({'success':!![],'message':_0x164d11(0x1a6)});}catch(_0x1015ad){return console[_0x164d11(0x18b)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0x1015ad),_0x17264a['status'](0x1f4)[_0x164d11(0x19d)]({'success':![],'message':_0x164d11(0x184),'error':_0x1015ad instanceof Error?_0x1015ad[_0x164d11(0x192)]:_0x164d11(0x193)});}},this['webhookService']=new webhookService_1[(_0xe5400d(0x175))]();}}exports['InstaXChangeController']=InstaXChangeController;