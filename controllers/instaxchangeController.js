'use strict';const a8_0x20f7b3=a8_0x4329;(function(_0xde20b2,_0x11a1f9){const _0x2b7960=a8_0x4329,_0x5e5d51=_0xde20b2();while(!![]){try{const _0x1e9c28=-parseInt(_0x2b7960(0xe3))/0x1*(parseInt(_0x2b7960(0xe2))/0x2)+parseInt(_0x2b7960(0xca))/0x3*(-parseInt(_0x2b7960(0xb4))/0x4)+-parseInt(_0x2b7960(0xed))/0x5*(-parseInt(_0x2b7960(0xb7))/0x6)+parseInt(_0x2b7960(0xd8))/0x7*(-parseInt(_0x2b7960(0xc8))/0x8)+-parseInt(_0x2b7960(0xa9))/0x9*(parseInt(_0x2b7960(0xb6))/0xa)+parseInt(_0x2b7960(0xcf))/0xb*(-parseInt(_0x2b7960(0xac))/0xc)+parseInt(_0x2b7960(0xdf))/0xd;if(_0x1e9c28===_0x11a1f9)break;else _0x5e5d51['push'](_0x5e5d51['shift']());}catch(_0x23c11d){_0x5e5d51['push'](_0x5e5d51['shift']());}}}(a8_0x5eb4,0xdf13b));function a8_0x4329(_0x5de33a,_0x50d1e0){_0x5de33a=_0x5de33a-0xa9;const _0x5eb4e9=a8_0x5eb4();let _0x432982=_0x5eb4e9[_0x5de33a];return _0x432982;}var __importDefault=this&&this[a8_0x20f7b3(0xaa)]||function(_0xd59a93){const _0x5c96ba=a8_0x20f7b3;return _0xd59a93&&_0xd59a93[_0x5c96ba(0xaf)]?_0xd59a93:{'default':_0xd59a93};};Object[a8_0x20f7b3(0xdd)](exports,a8_0x20f7b3(0xaf),{'value':!![]}),exports[a8_0x20f7b3(0xd6)]=void 0x0;const database_1=__importDefault(require(a8_0x20f7b3(0xc5))),webhookService_1=require('../services/webhookService'),currencyService_1=require(a8_0x20f7b3(0xc2));class InstaXChangeController{constructor(){const _0x1b82fb=a8_0x20f7b3;this[_0x1b82fb(0xbd)]=async(_0x105e73,_0x5272c8)=>{const _0x292d09=_0x1b82fb;try{const {paymentId:_0x406409,status:_0x5e73ec,sessionId:_0x5b00a7,webhookData:_0x423af5}=_0x105e73['body'];console['log'](_0x292d09(0xe4)),console[_0x292d09(0xad)]('\x20\x20\x20Payment\x20ID:\x20'+_0x406409),console[_0x292d09(0xad)](_0x292d09(0xcc)+_0x5e73ec),console[_0x292d09(0xad)](_0x292d09(0xc1)+_0x5b00a7);if(!_0x406409||!_0x5e73ec)return console['error'](_0x292d09(0xbc)),_0x5272c8[_0x292d09(0xd2)](0x190)['json']({'success':![],'message':'Missing\x20required\x20parameters'});const _0x5d2dd9=await database_1[_0x292d09(0xe9)][_0x292d09(0xb2)][_0x292d09(0xe1)]({'where':{'id':_0x406409},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x5d2dd9)return console[_0x292d09(0xdb)](_0x292d09(0xce)+_0x406409),_0x5272c8['status'](0x194)[_0x292d09(0xd4)]({'success':![],'message':_0x292d09(0xee)});console[_0x292d09(0xad)](_0x292d09(0xd7)+_0x5d2dd9[_0x292d09(0xd2)]);let _0x22c5f9,_0xc7ec5a=![];switch(_0x5e73ec[_0x292d09(0xc7)]()){case _0x292d09(0xd0):_0x22c5f9=_0x292d09(0xf0),_0xc7ec5a=_0x5d2dd9[_0x292d09(0xd2)]!=='PAID';break;case _0x292d09(0xf1):_0x22c5f9=_0x292d09(0xbe);break;default:console[_0x292d09(0xad)](_0x292d09(0xd9)+_0x5e73ec+_0x292d09(0xec));return _0x5272c8[_0x292d09(0xd2)](0xc8)[_0x292d09(0xd4)]({'success':!![],'message':_0x292d09(0xc4)});}console[_0x292d09(0xad)](_0x292d09(0xe6)+_0x5d2dd9[_0x292d09(0xd2)]+_0x292d09(0xb3)+_0x22c5f9);const _0x49bc67={'status':_0x22c5f9,'updatedAt':new Date()};if(_0x22c5f9===_0x292d09(0xf0)){_0x49bc67[_0x292d09(0xab)]=new Date();if(!_0x5d2dd9[_0x292d09(0xef)]){const _0x2d12df=await currencyService_1[_0x292d09(0xb9)]['convertToUSDT'](_0x5d2dd9[_0x292d09(0xb8)],_0x5d2dd9[_0x292d09(0xc9)]);_0x49bc67[_0x292d09(0xef)]=_0x2d12df;let _0xa03ab=0xa;if(_0x5d2dd9['shop'][_0x292d09(0xb0)])try{const _0x4ca820=JSON[_0x292d09(0xcd)](_0x5d2dd9[_0x292d09(0xe7)]['gatewaySettings']);for(const [_0x98c9e1,_0x5b4d33]of Object[_0x292d09(0xba)](_0x4ca820)){if(_0x98c9e1['toLowerCase']()==='instaxchange'){_0xa03ab=_0x5b4d33['commission']||0xa;break;}}}catch(_0x3826ec){console[_0x292d09(0xdb)](_0x292d09(0xeb),_0x3826ec);}const _0x3d710b=_0x2d12df*(0x1-_0xa03ab/0x64);_0x49bc67[_0x292d09(0xe8)]=_0x3d710b,_0x49bc67['gatewayCommissionRate']=_0xa03ab,console[_0x292d09(0xad)](_0x292d09(0xbb)),console['log'](_0x292d09(0xe0)+_0x2d12df[_0x292d09(0xc0)](0x6)),console[_0x292d09(0xad)]('\x20\x20\x20Commission:\x20'+_0xa03ab+'%'),console[_0x292d09(0xad)](_0x292d09(0xb5)+_0x3d710b[_0x292d09(0xc0)](0x6));}}else{if(_0x22c5f9===_0x292d09(0xbe)){const _0x2e9789=_0x423af5?.['data']?.[_0x292d09(0xea)]||_0x292d09(0xe5);_0x49bc67['failureMessage']=_0x2e9789,console[_0x292d09(0xad)](_0x292d09(0xda)+_0x2e9789);}}_0x423af5&&(_0x49bc67[_0x292d09(0xc6)]=JSON['stringify'](_0x423af5));await database_1[_0x292d09(0xe9)][_0x292d09(0xb2)]['update']({'where':{'id':_0x406409},'data':_0x49bc67}),console[_0x292d09(0xad)]('‚úÖ\x20Payment\x20updated\x20successfully');if(_0xc7ec5a&&_0x22c5f9==='PAID'){const _0x40248c=_0x49bc67[_0x292d09(0xe8)];_0x40248c&&(await database_1[_0x292d09(0xe9)]['shop'][_0x292d09(0xb1)]({'where':{'id':_0x5d2dd9[_0x292d09(0xcb)]},'data':{'balance':{'increment':_0x40248c}}}),console[_0x292d09(0xad)](_0x292d09(0xd3)+_0x40248c['toFixed'](0x6)+'\x20USDT'));}try{await this[_0x292d09(0xc3)][_0x292d09(0xf2)](_0x406409,_0x22c5f9,{'failureMessage':_0x22c5f9===_0x292d09(0xbe)?_0x423af5?.['data']?.[_0x292d09(0xea)]||_0x292d09(0xe5):undefined}),console['log'](_0x292d09(0xbf));}catch(_0x138da6){console['error'](_0x292d09(0xdc),_0x138da6);}return _0x5272c8[_0x292d09(0xd2)](0xc8)[_0x292d09(0xd4)]({'success':!![],'message':'Webhook\x20processed\x20successfully'});}catch(_0x2ec73a){return console[_0x292d09(0xdb)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0x2ec73a),_0x5272c8[_0x292d09(0xd2)](0x1f4)['json']({'success':![],'message':_0x292d09(0xd5),'error':_0x2ec73a instanceof Error?_0x2ec73a[_0x292d09(0xde)]:_0x292d09(0xae)});}},this[_0x1b82fb(0xc3)]=new webhookService_1[(_0x1b82fb(0xd1))]();}}exports[a8_0x20f7b3(0xd6)]=InstaXChangeController;function a8_0x5eb4(){const _0x34d303=['handleWebhook','FAILED','üì§\x20Webhook\x20notification\x20processed','toFixed','\x20\x20\x20Session\x20ID:\x20','../services/currencyService','webhookService','Status\x20not\x20actionable','../config/database','gatewayResponse','toLowerCase','960152qHXKlw','currency','19893sVAwAF','shopId','\x20\x20\x20Status:\x20','parse','‚ùå\x20Payment\x20not\x20found:\x20','154ttTDyL','completed','WebhookService','status','üí∞\x20Shop\x20balance\x20updated:\x20+','json','Internal\x20server\x20error','InstaXChangeController','üìä\x20Current\x20payment\x20status:\x20','105pxcTka','‚ö†Ô∏è\x20Unknown\x20status:\x20','‚ùå\x20Failure\x20reason:\x20','error','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','defineProperty','message','68116386lUZwbU','\x20\x20\x20Amount\x20USDT:\x20','findUnique','4ZyMuKR','237315lHZhhw','üê≥\x20InstaXChange\x20webhook\x20received:','Payment\x20failed','üîÑ\x20Updating\x20payment\x20status:\x20','shop','amountAfterGatewayCommissionUSDT','default','statusReason','Error\x20parsing\x20gateway\x20settings:',',\x20ignoring\x20webhook','115BADTbh','Payment\x20not\x20found','amountUSDT','PAID','failed','updatePaymentStatus','5580EnPMxC','__importDefault','paidAt','781920Jbkodu','log','Unknown\x20error','__esModule','gatewaySettings','update','payment','\x20‚Üí\x20','556bsQWST','\x20\x20\x20Merchant\x20Amount:\x20','5370CFPQiO','30210oXzCvG','amount','currencyService','entries','üí∞\x20Calculated\x20amounts:','‚ùå\x20Missing\x20required\x20webhook\x20parameters'];a8_0x5eb4=function(){return _0x34d303;};return a8_0x5eb4();}