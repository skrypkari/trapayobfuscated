'use strict';const a7_0xda2b06=a7_0xfd6d;(function(_0x292fc4,_0x3fc677){const _0x519358=a7_0xfd6d,_0x2ecd55=_0x292fc4();while(!![]){try{const _0x509bba=-parseInt(_0x519358(0x12a))/0x1*(parseInt(_0x519358(0x119))/0x2)+parseInt(_0x519358(0xfe))/0x3+-parseInt(_0x519358(0xf3))/0x4*(-parseInt(_0x519358(0xf1))/0x5)+-parseInt(_0x519358(0x10e))/0x6*(parseInt(_0x519358(0xfa))/0x7)+parseInt(_0x519358(0x104))/0x8*(parseInt(_0x519358(0x106))/0x9)+-parseInt(_0x519358(0x10d))/0xa+parseInt(_0x519358(0x12e))/0xb;if(_0x509bba===_0x3fc677)break;else _0x2ecd55['push'](_0x2ecd55['shift']());}catch(_0x438267){_0x2ecd55['push'](_0x2ecd55['shift']());}}}(a7_0xb7a1,0xf018b));function a7_0xfd6d(_0x1aeb71,_0x1cb212){_0x1aeb71=_0x1aeb71-0xeb;const _0xb7a1ec=a7_0xb7a1();let _0xfd6db4=_0xb7a1ec[_0x1aeb71];return _0xfd6db4;}function a7_0xb7a1(){const _0x25857d=['shop','4RlRtmI','‚úÖ\x20Payment\x20updated\x20successfully','amountUSDT','json','Unknown\x20error','default','\x20‚Üí\x20','2561818VhdTwa','InstaXChangeController','body','log','5003193jKjQcM','\x20\x20\x20Commission:\x20','üí∞\x20Shop\x20balance\x20updated:\x20+','Status\x20not\x20actionable','PAID','paidAt','424624WkdBGW','currencyService','63bHeJVS','convertToUSDT',',\x20ignoring\x20webhook','toFixed','‚ö†Ô∏è\x20Unknown\x20status:\x20','üì§\x20Webhook\x20notification\x20processed','failed','17215920QUpqIO','24cFPTfF','message','data','Webhook\x20processed\x20successfully','error','gatewayResponse','update','WebhookService','statusReason','updatePaymentStatus','instaxchange','48muOmVW','status','failureMessage','entries','‚ö†Ô∏è\x20Failed\x20to\x20process\x20webhook\x20notification:','__esModule','üìä\x20Current\x20payment\x20status:\x20','\x20\x20\x20Payment\x20ID:\x20','\x20\x20\x20Session\x20ID:\x20','\x20\x20\x20Status:\x20','Internal\x20server\x20error','payment','amountAfterGatewayCommissionUSDT','currency','üê≥\x20InstaXChange\x20webhook\x20received:','gatewaySettings','Payment\x20not\x20found','39635rqovXc','Error\x20parsing\x20gateway\x20settings:','FAILED','Payment\x20failed','19993039sHyGpz','completed','‚ùå\x20Missing\x20required\x20webhook\x20parameters','gatewayCommissionRate','\x20USDT','__importDefault','üí∞\x20Calculated\x20amounts:','6316685axitKj'];a7_0xb7a1=function(){return _0x25857d;};return a7_0xb7a1();}var __importDefault=this&&this[a7_0xda2b06(0xef)]||function(_0x4ca1c0){return _0x4ca1c0&&_0x4ca1c0['__esModule']?_0x4ca1c0:{'default':_0x4ca1c0};};Object['defineProperty'](exports,a7_0xda2b06(0x11e),{'value':!![]}),exports[a7_0xda2b06(0xfb)]=void 0x0;const database_1=__importDefault(require('../config/database')),webhookService_1=require('../services/webhookService'),currencyService_1=require('../services/currencyService');class InstaXChangeController{constructor(){const _0x21a210=a7_0xda2b06;this['handleWebhook']=async(_0x5bae6c,_0x1d3745)=>{const _0x1103fa=a7_0xfd6d;try{const {paymentId:_0xfec33e,status:_0x8542b6,sessionId:_0xb9cace,webhookData:_0x446c54}=_0x5bae6c[_0x1103fa(0xfc)];console[_0x1103fa(0xfd)](_0x1103fa(0x127)),console['log'](_0x1103fa(0x120)+_0xfec33e),console[_0x1103fa(0xfd)](_0x1103fa(0x122)+_0x8542b6),console['log'](_0x1103fa(0x121)+_0xb9cace);if(!_0xfec33e||!_0x8542b6)return console[_0x1103fa(0x112)](_0x1103fa(0xec)),_0x1d3745[_0x1103fa(0x11a)](0x190)['json']({'success':![],'message':'Missing\x20required\x20parameters'});const _0x413f74=await database_1[_0x1103fa(0xf8)][_0x1103fa(0x124)]['findUnique']({'where':{'id':_0xfec33e},'include':{'shop':{'select':{'id':!![],'name':!![],'gatewaySettings':!![]}}}});if(!_0x413f74)return console[_0x1103fa(0x112)]('‚ùå\x20Payment\x20not\x20found:\x20'+_0xfec33e),_0x1d3745[_0x1103fa(0x11a)](0x194)[_0x1103fa(0xf6)]({'success':![],'message':_0x1103fa(0x129)});console[_0x1103fa(0xfd)](_0x1103fa(0x11f)+_0x413f74[_0x1103fa(0x11a)]);let _0x3de763,_0xce9010=![];switch(_0x8542b6['toLowerCase']()){case _0x1103fa(0xeb):_0x3de763=_0x1103fa(0x102),_0xce9010=_0x413f74[_0x1103fa(0x11a)]!==_0x1103fa(0x102);break;case _0x1103fa(0x10c):_0x3de763=_0x1103fa(0x12c);break;default:console[_0x1103fa(0xfd)](_0x1103fa(0x10a)+_0x8542b6+_0x1103fa(0x108));return _0x1d3745[_0x1103fa(0x11a)](0xc8)[_0x1103fa(0xf6)]({'success':!![],'message':_0x1103fa(0x101)});}console[_0x1103fa(0xfd)]('üîÑ\x20Updating\x20payment\x20status:\x20'+_0x413f74[_0x1103fa(0x11a)]+_0x1103fa(0xf9)+_0x3de763);const _0x33f89d={'status':_0x3de763,'updatedAt':new Date()};if(_0x3de763===_0x1103fa(0x102)){_0x33f89d[_0x1103fa(0x103)]=new Date();if(!_0x413f74[_0x1103fa(0xf5)]){const _0x2f6b4b=await currencyService_1[_0x1103fa(0x105)][_0x1103fa(0x107)](_0x413f74['amount'],_0x413f74[_0x1103fa(0x126)]);_0x33f89d[_0x1103fa(0xf5)]=_0x2f6b4b;let _0x3b78b3=0xa;if(_0x413f74[_0x1103fa(0xf2)][_0x1103fa(0x128)])try{const _0x3576ba=JSON['parse'](_0x413f74[_0x1103fa(0xf2)]['gatewaySettings']);for(const [_0x38498a,_0x54ac26]of Object[_0x1103fa(0x11c)](_0x3576ba)){if(_0x38498a['toLowerCase']()===_0x1103fa(0x118)){_0x3b78b3=_0x54ac26['commission']||0xa;break;}}}catch(_0x2e5c58){console[_0x1103fa(0x112)](_0x1103fa(0x12b),_0x2e5c58);}const _0x38ac90=_0x2f6b4b*(0x1-_0x3b78b3/0x64);_0x33f89d[_0x1103fa(0x125)]=_0x38ac90,_0x33f89d[_0x1103fa(0xed)]=_0x3b78b3,console[_0x1103fa(0xfd)](_0x1103fa(0xf0)),console[_0x1103fa(0xfd)]('\x20\x20\x20Amount\x20USDT:\x20'+_0x2f6b4b[_0x1103fa(0x109)](0x6)),console[_0x1103fa(0xfd)](_0x1103fa(0xff)+_0x3b78b3+'%'),console[_0x1103fa(0xfd)]('\x20\x20\x20Merchant\x20Amount:\x20'+_0x38ac90['toFixed'](0x6));}}else{if(_0x3de763===_0x1103fa(0x12c)){const _0x4556c8=_0x446c54?.[_0x1103fa(0x110)]?.[_0x1103fa(0x116)]||_0x1103fa(0x12d);_0x33f89d[_0x1103fa(0x11b)]=_0x4556c8,console[_0x1103fa(0xfd)]('‚ùå\x20Failure\x20reason:\x20'+_0x4556c8);}}_0x446c54&&(_0x33f89d[_0x1103fa(0x113)]=JSON['stringify'](_0x446c54));await database_1[_0x1103fa(0xf8)]['payment']['update']({'where':{'id':_0xfec33e},'data':_0x33f89d}),console['log'](_0x1103fa(0xf4));if(_0xce9010&&_0x3de763===_0x1103fa(0x102)){const _0x43994c=_0x33f89d[_0x1103fa(0x125)];_0x43994c&&(await database_1['default'][_0x1103fa(0xf2)][_0x1103fa(0x114)]({'where':{'id':_0x413f74['shopId']},'data':{'balance':{'increment':_0x43994c}}}),console[_0x1103fa(0xfd)](_0x1103fa(0x100)+_0x43994c[_0x1103fa(0x109)](0x6)+_0x1103fa(0xee)));}try{await this['webhookService'][_0x1103fa(0x117)](_0xfec33e,_0x3de763,{'failureMessage':_0x3de763===_0x1103fa(0x12c)?_0x446c54?.[_0x1103fa(0x110)]?.[_0x1103fa(0x116)]||'Payment\x20failed':undefined}),console[_0x1103fa(0xfd)](_0x1103fa(0x10b));}catch(_0x889eb5){console[_0x1103fa(0x112)](_0x1103fa(0x11d),_0x889eb5);}return _0x1d3745[_0x1103fa(0x11a)](0xc8)[_0x1103fa(0xf6)]({'success':!![],'message':_0x1103fa(0x111)});}catch(_0xf7b65d){return console[_0x1103fa(0x112)]('‚ùå\x20InstaXChange\x20webhook\x20processing\x20error:',_0xf7b65d),_0x1d3745[_0x1103fa(0x11a)](0x1f4)[_0x1103fa(0xf6)]({'success':![],'message':_0x1103fa(0x123),'error':_0xf7b65d instanceof Error?_0xf7b65d[_0x1103fa(0x10f)]:_0x1103fa(0xf7)});}},this['webhookService']=new webhookService_1[(_0x21a210(0x115))]();}}exports[a7_0xda2b06(0xfb)]=InstaXChangeController;